{
    "url": "http://localhost:9999/marneborn/angular-coverup/examples/dwhalin-overlay/scripts/angular.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>window.name = window.name.replace(NG_DEFER_BOOTSTRAP, '');</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/marneborn/angular-coverup/examples/dwhalin-overlay/scripts/angular.js",
                "path": "/marneborn/angular-coverup/examples/dwhalin-overlay/scripts/angular.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9tYXJuZWJvcm4vYW5ndWxhci1jb3ZlcnVwL2V4YW1wbGVzL2R3aGFsaW4tb3ZlcmxheS9zY3JpcHRzL2FuZ3VsYXIuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNzY4MTI1DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDA3OjI0OjU0IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAwNzoyNDo1NCBHTVQNCg0KLyoqCiAqIEBsaWNlbnNlIEFuZ3VsYXJKUyB2MS4yLjAtcmMuMgogKiAoYykgMjAxMC0yMDEyIEdvb2dsZSwgSW5jLiBodHRwOi8vYW5ndWxhcmpzLm9yZwogKiBMaWNlbnNlOiBNSVQKICovCihmdW5jdGlvbiAod2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgLyoqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBUaGlzIG9iamVjdCBwcm92aWRlcyBhIHV0aWxpdHkgZm9yIHByb2R1Y2luZyByaWNoIEVycm9yIG1lc3NhZ2VzIHdpdGhpbgogICAgICogQW5ndWxhci4gSXQgY2FuIGJlIGNhbGxlZCBhcyBmb2xsb3dzOgogICAgICoKICAgICAqIHZhciBleGFtcGxlTWluRXJyID0gbWluRXJyKCdleGFtcGxlJyk7CiAgICAgKiB0aHJvdyBleGFtcGxlTWluRXJyKCdvbmUnLCAnVGhpcyB7MH0gaXMgezF9JywgZm9vLCBiYXIpOwogICAgICoKICAgICAqIFRoZSBhYm92ZSBjcmVhdGVzIGFuIGluc3RhbmNlIG9mIG1pbkVyciBpbiB0aGUgZXhhbXBsZSBuYW1lc3BhY2UuIFRoZQogICAgICogcmVzdWx0aW5nIGVycm9yIHdpbGwgaGF2ZSBhIG5hbWVzcGFjZWQgZXJyb3IgY29kZSBvZiBleGFtcGxlLm9uZS4gIFRoZQogICAgICogcmVzdWx0aW5nIGVycm9yIHdpbGwgcmVwbGFjZSB7MH0gd2l0aCB0aGUgdmFsdWUgb2YgZm9vLCBhbmQgezF9IHdpdGggdGhlCiAgICAgKiB2YWx1ZSBvZiBiYXIuIFRoZSBvYmplY3QgaXMgbm90IHJlc3RyaWN0ZWQgaW4gdGhlIG51bWJlciBvZiBhcmd1bWVudHMgaXQgY2FuCiAgICAgKiB0YWtlLgogICAgICoKICAgICAqIElmIGZld2VyIGFyZ3VtZW50cyBhcmUgc3BlY2lmaWVkIHRoYW4gbmVjZXNzYXJ5IGZvciBpbnRlcnBvbGF0aW9uLCB0aGUgZXh0cmEKICAgICAqIGludGVycG9sYXRpb24gbWFya2VycyB3aWxsIGJlIHByZXNlcnZlZCBpbiB0aGUgZmluYWwgc3RyaW5nLgogICAgICoKICAgICAqIFNpbmNlIGRhdGEgd2lsbCBiZSBwYXJzZWQgc3RhdGljYWxseSBkdXJpbmcgYSBidWlsZCBzdGVwLCBzb21lIHJlc3RyaWN0aW9ucwogICAgICogYXJlIGFwcGxpZWQgd2l0aCByZXNwZWN0IHRvIGhvdyBtaW5FcnIgaW5zdGFuY2VzIGFyZSBjcmVhdGVkIGFuZCBjYWxsZWQuCiAgICAgKiBJbnN0YW5jZXMgc2hvdWxkIGhhdmUgbmFtZXMgb2YgdGhlIGZvcm0gbmFtZXNwYWNlTWluRXJyIGZvciBhIG1pbkVyciBjcmVhdGVkCiAgICAgKiB1c2luZyBtaW5FcnIoJ25hbWVzcGFjZScpIC4gRXJyb3IgY29kZXMsIG5hbWVzcGFjZXMgYW5kIHRlbXBsYXRlIHN0cmluZ3MKICAgICAqIHNob3VsZCBhbGwgYmUgc3RhdGljIHN0cmluZ3MsIG5vdCB2YXJpYWJsZXMgb3IgZ2VuZXJhbCBleHByZXNzaW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlIFRoZSBuYW1lc3BhY2UgdG8gdXNlIGZvciB0aGUgbmV3IG1pbkVyciBpbnN0YW5jZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihzdHJpbmcsIHN0cmluZywgLi4uKTogRXJyb3J9IGluc3RhbmNlCiAgICAgKi8KCiAgICBmdW5jdGlvbiBtaW5FcnIobW9kdWxlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGNvZGUgPSBhcmd1bWVudHNbMF0sCiAgICAgICAgICAgICAgcHJlZml4ID0gJ1snICsgKG1vZHVsZSA/IG1vZHVsZSArICc6JyA6ICcnKSArIGNvZGUgKyAnXSAnLAogICAgICAgICAgICAgIHRlbXBsYXRlID0gYXJndW1lbnRzWzFdLAogICAgICAgICAgICAgIHRlbXBsYXRlQXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgICAgICBzdHJpbmdpZnkgPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKG9iaikpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmoudG9TdHJpbmcoKS5yZXBsYWNlKC8gXHtbXHNcU10qJC8sICcnKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1VuZGVmaW5lZChvYmopKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3VuZGVmaW5lZCc7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzU3RyaW5nKG9iaikpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmopOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBvYmo7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBtZXNzYWdlLCBpOwoKICAgICAgICAgICAgbWVzc2FnZSA9IHByZWZpeCArIHRlbXBsYXRlLnJlcGxhY2UoL1x7XGQrXH0vZywgZnVuY3Rpb24gKG1hdGNoKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSArbWF0Y2guc2xpY2UoMSwgLTEpLCBhcmc7CgogICAgICAgICAgICAgICAgaWYgKGluZGV4ICsgMiA8IHRlbXBsYXRlQXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBhcmcgPSB0ZW1wbGF0ZUFyZ3NbaW5kZXggKyAyXTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmcudG9TdHJpbmcoKS5yZXBsYWNlKC8gP1x7W1xzXFNdKiQvLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1VuZGVmaW5lZChhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAndW5kZWZpbmVkJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc1N0cmluZyhhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0b0pzb24oYXJnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZSArICdcbmh0dHA6Ly9lcnJvcnMuYW5ndWxhcmpzLm9yZy8nICsgdmVyc2lvbi5mdWxsICsgJy8nICsKICAgICAgICAgICAgICAobW9kdWxlID8gbW9kdWxlICsgJy8nIDogJycpICsgY29kZTsKICAgICAgICAgICAgZm9yIChpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UgKyAoaSA9PSAyID8gJz8nIDogJyYnKSArICdwJyArIChpIC0gMikgKyAnPScgKwogICAgICAgICAgICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5KGFyZ3VtZW50c1tpXSkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICAgIH07CiAgICB9CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBoYXNPd25Qcm9wZXJ0eSBtYXkgYmUgb3ZlcndyaXR0ZW4gYnkgYSBwcm9wZXJ0eSBvZiB0aGUgc2FtZSBuYW1lLCBvciBlbnRpcmVseQogICAgICogYWJzZW50IGZyb20gYW4gb2JqZWN0IHRoYXQgZG9lcyBub3QgaW5oZXJpdCBPYmplY3QucHJvdG90eXBlOyB0aGlzIGNvcHkgaXMKICAgICAqIHVzZWQgaW5zdGVhZAogICAgICovCiAgICB2YXIgaGFzT3duUHJvcGVydHlGbiA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgaGFzT3duUHJvcGVydHlMb2NhbCA9IGZ1bmN0aW9uIChvYmosIGtleSkgewogICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eUZuLmNhbGwob2JqLCBrZXkpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5sb3dlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbiBDb252ZXJ0cyB0aGUgc3BlY2lmaWVkIHN0cmluZyB0byBsb3dlcmNhc2UuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSBjb252ZXJ0ZWQgdG8gbG93ZXJjYXNlLgogICAgICogQHJldHVybnMge3N0cmluZ30gTG93ZXJjYXNlZCBzdHJpbmcuCiAgICAgKi8KICAgIHZhciBsb3dlcmNhc2UgPSBmdW5jdGlvbiAoc3RyaW5nKSB7IHJldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvTG93ZXJDYXNlKCkgOiBzdHJpbmc7IH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnVwcGVyY2FzZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uIENvbnZlcnRzIHRoZSBzcGVjaWZpZWQgc3RyaW5nIHRvIHVwcGVyY2FzZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgU3RyaW5nIHRvIGJlIGNvbnZlcnRlZCB0byB1cHBlcmNhc2UuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBVcHBlcmNhc2VkIHN0cmluZy4KICAgICAqLwogICAgdmFyIHVwcGVyY2FzZSA9IGZ1bmN0aW9uIChzdHJpbmcpIHsgcmV0dXJuIGlzU3RyaW5nKHN0cmluZykgPyBzdHJpbmcudG9VcHBlckNhc2UoKSA6IHN0cmluZzsgfTsKCgogICAgdmFyIG1hbnVhbExvd2VyY2FzZSA9IGZ1bmN0aW9uIChzKSB7CiAgICAgICAgcmV0dXJuIGlzU3RyaW5nKHMpCiAgICAgICAgICAgID8gcy5yZXBsYWNlKC9bQS1aXS9nLCBmdW5jdGlvbiAoY2gpIHsgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSB8IDMyKTsgfSkKICAgICAgICAgICAgOiBzOwogICAgfTsKICAgIHZhciBtYW51YWxVcHBlcmNhc2UgPSBmdW5jdGlvbiAocykgewogICAgICAgIHJldHVybiBpc1N0cmluZyhzKQogICAgICAgICAgICA/IHMucmVwbGFjZSgvW2Etel0vZywgZnVuY3Rpb24gKGNoKSB7IHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgJiB+MzIpOyB9KQogICAgICAgICAgICA6IHM7CiAgICB9OwoKCiAgICAvLyBTdHJpbmcjdG9Mb3dlckNhc2UgYW5kIFN0cmluZyN0b1VwcGVyQ2FzZSBkb24ndCBwcm9kdWNlIGNvcnJlY3QgcmVzdWx0cyBpbiBicm93c2VycyB3aXRoIFR1cmtpc2gKICAgIC8vIGxvY2FsZSwgZm9yIHRoaXMgcmVhc29uIHdlIG5lZWQgdG8gZGV0ZWN0IHRoaXMgY2FzZSBhbmQgcmVkZWZpbmUgbG93ZXJjYXNlL3VwcGVyY2FzZSBtZXRob2RzCiAgICAvLyB3aXRoIGNvcnJlY3QgYnV0IHNsb3dlciBhbHRlcm5hdGl2ZXMuCiAgICBpZiAoJ2knICE9PSAnSScudG9Mb3dlckNhc2UoKSkgewogICAgICAgIGxvd2VyY2FzZSA9IG1hbnVhbExvd2VyY2FzZTsKICAgICAgICB1cHBlcmNhc2UgPSBtYW51YWxVcHBlcmNhc2U7CiAgICB9CgoKICAgIHZhciAvKiogaG9sZHMgbWFqb3IgdmVyc2lvbiBudW1iZXIgZm9yIElFIG9yIE5hTiBmb3IgcmVhbCBicm93c2VycyAqLwogICAgICAgIG1zaWUsCiAgICAgICAganFMaXRlLCAgICAgICAgICAgLy8gZGVsYXkgYmluZGluZyBzaW5jZSBqUXVlcnkgY291bGQgYmUgbG9hZGVkIGFmdGVyIHVzLgogICAgICAgIGpRdWVyeSwgICAgICAgICAgIC8vIGRlbGF5IGJpbmRpbmcKICAgICAgICBzbGljZSA9IFtdLnNsaWNlLAogICAgICAgIHB1c2ggPSBbXS5wdXNoLAogICAgICAgIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZywKICAgICAgICBuZ01pbkVyciA9IG1pbkVycignbmcnKSwKCgogICAgICAgIF9hbmd1bGFyID0gd2luZG93LmFuZ3VsYXIsCiAgICAgICAgLyoqIEBuYW1lIGFuZ3VsYXIgKi8KICAgICAgICBhbmd1bGFyID0gd2luZG93LmFuZ3VsYXIgfHwgKHdpbmRvdy5hbmd1bGFyID0ge30pLAogICAgICAgIGFuZ3VsYXJNb2R1bGUsCiAgICAgICAgbm9kZU5hbWVfLAogICAgICAgIHVpZCA9IFsnMCcsICcwJywgJzAnXTsKCiAgICAvKioKICAgICAqIElFIDExIGNoYW5nZWQgdGhlIGZvcm1hdCBvZiB0aGUgVXNlckFnZW50IHN0cmluZy4KICAgICAqIFNlZSBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1Mzc1MDMuYXNweAogICAgICovCiAgICBtc2llID0gaW50KCgvbXNpZSAoXGQrKS8uZXhlYyhsb3dlcmNhc2UobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSk7CiAgICBpZiAoaXNOYU4obXNpZSkpIHsKICAgICAgICBtc2llID0gaW50KCgvdHJpZGVudFwvLio7IHJ2OihcZCspLy5leGVjKGxvd2VyY2FzZShuYXZpZ2F0b3IudXNlckFnZW50KSkgfHwgW10pWzFdKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSBvYmoKICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBgb2JqYCBpcyBhbiBhcnJheSBvciBhcnJheS1saWtlIG9iamVjdCAoTm9kZUxpc3QsIEFyZ3VtZW50cywgLi4uKQogICAgICovCiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZShvYmopIHsKICAgICAgICBpZiAob2JqID09IG51bGwgfHwgaXNXaW5kb3cob2JqKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB2YXIgbGVuZ3RoID0gb2JqLmxlbmd0aDsKCiAgICAgICAgaWYgKG9iai5ub2RlVHlwZSA9PT0gMSAmJiBsZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXNBcnJheShvYmopIHx8ICFpc0Z1bmN0aW9uKG9iaikgJiYgKAogICAgICAgICAgbGVuZ3RoID09PSAwIHx8IHR5cGVvZiBsZW5ndGggPT09ICJudW1iZXIiICYmIGxlbmd0aCA+IDAgJiYgKGxlbmd0aCAtIDEpIGluIG9iagogICAgICAgICk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZm9yRWFjaAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBJbnZva2VzIHRoZSBgaXRlcmF0b3JgIGZ1bmN0aW9uIG9uY2UgZm9yIGVhY2ggaXRlbSBpbiBgb2JqYCBjb2xsZWN0aW9uLCB3aGljaCBjYW4gYmUgZWl0aGVyIGFuCiAgICAgKiBvYmplY3Qgb3IgYW4gYXJyYXkuIFRoZSBgaXRlcmF0b3JgIGZ1bmN0aW9uIGlzIGludm9rZWQgd2l0aCBgaXRlcmF0b3IodmFsdWUsIGtleSlgLCB3aGVyZSBgdmFsdWVgCiAgICAgKiBpcyB0aGUgdmFsdWUgb2YgYW4gb2JqZWN0IHByb3BlcnR5IG9yIGFuIGFycmF5IGVsZW1lbnQgYW5kIGBrZXlgIGlzIHRoZSBvYmplY3QgcHJvcGVydHkga2V5IG9yCiAgICAgKiBhcnJheSBlbGVtZW50IGluZGV4LiBTcGVjaWZ5aW5nIGEgYGNvbnRleHRgIGZvciB0aGUgZnVuY3Rpb24gaXMgb3B0aW9uYWwuCiAgICAgKgogICAgICogTm90ZTogdGhpcyBmdW5jdGlvbiB3YXMgcHJldmlvdXNseSBrbm93biBhcyBgYW5ndWxhci5mb3JlYWNoYC4KICAgICAqCiAgICAgICA8cHJlPgogICAgICAgICB2YXIgdmFsdWVzID0ge25hbWU6ICdtaXNrbycsIGdlbmRlcjogJ21hbGUnfTsKICAgICAgICAgdmFyIGxvZyA9IFtdOwogICAgICAgICBhbmd1bGFyLmZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKICAgICAgICAgICB0aGlzLnB1c2goa2V5ICsgJzogJyArIHZhbHVlKTsKICAgICAgICAgfSwgbG9nKTsKICAgICAgICAgZXhwZWN0KGxvZykudG9FcXVhbChbJ25hbWU6IG1pc2tvJywgJ2dlbmRlcjptYWxlJ10pOwogICAgICAgPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R8QXJyYXl9IG9iaiBPYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gaXRlcmF0b3IgSXRlcmF0b3IgZnVuY3Rpb24uCiAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbnRleHQgT2JqZWN0IHRvIGJlY29tZSBjb250ZXh0IChgdGhpc2ApIGZvciB0aGUgaXRlcmF0b3IgZnVuY3Rpb24uCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fEFycmF5fSBSZWZlcmVuY2UgdG8gYG9iamAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvckVhY2gob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgICAgIHZhciBrZXk7CiAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihvYmopKSB7CiAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ICE9ICdwcm90b3R5cGUnICYmIGtleSAhPSAnbGVuZ3RoJyAmJiBrZXkgIT0gJ25hbWUnICYmIG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9iai5mb3JFYWNoICYmIG9iai5mb3JFYWNoICE9PSBmb3JFYWNoKSB7CiAgICAgICAgICAgICAgICBvYmouZm9yRWFjaChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheUxpa2Uob2JqKSkgewogICAgICAgICAgICAgICAgZm9yIChrZXkgPSAwOyBrZXkgPCBvYmoubGVuZ3RoOyBrZXkrKykKICAgICAgICAgICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmo7CiAgICB9CgogICAgZnVuY3Rpb24gc29ydGVkS2V5cyhvYmopIHsKICAgICAgICB2YXIga2V5cyA9IFtdOwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4ga2V5cy5zb3J0KCk7CiAgICB9CgogICAgZnVuY3Rpb24gZm9yRWFjaFNvcnRlZChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIGtleXMgPSBzb3J0ZWRLZXlzKG9iaik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleXNbaV1dLCBrZXlzW2ldKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGtleXM7CiAgICB9CgoKICAgIC8qKgogICAgICogd2hlbiB1c2luZyBmb3JFYWNoIHRoZSBwYXJhbXMgYXJlIHZhbHVlLCBrZXksIGJ1dCBpdCBpcyBvZnRlbiB1c2VmdWwgdG8gaGF2ZSBrZXksIHZhbHVlLgogICAgICogQHBhcmFtIHtmdW5jdGlvbihzdHJpbmcsICopfSBpdGVyYXRvckZuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKiwgc3RyaW5nKX0KICAgICAqLwogICAgZnVuY3Rpb24gcmV2ZXJzZVBhcmFtcyhpdGVyYXRvckZuKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7IGl0ZXJhdG9yRm4oa2V5LCB2YWx1ZSkgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEEgY29uc2lzdGVudCB3YXkgb2YgY3JlYXRpbmcgdW5pcXVlIElEcyBpbiBhbmd1bGFyLiBUaGUgSUQgaXMgYSBzZXF1ZW5jZSBvZiBhbHBoYSBudW1lcmljCiAgICAgKiBjaGFyYWN0ZXJzIHN1Y2ggYXMgJzAxMkFCQycuIFRoZSByZWFzb24gd2h5IHdlIGFyZSBub3QgdXNpbmcgc2ltcGx5IGEgbnVtYmVyIGNvdW50ZXIgaXMgdGhhdAogICAgICogdGhlIG51bWJlciBzdHJpbmcgZ2V0cyBsb25nZXIgb3ZlciB0aW1lLCBhbmQgaXQgY2FuIGFsc28gb3ZlcmZsb3csIHdoZXJlIGFzIHRoZSBuZXh0SWQKICAgICAqIHdpbGwgZ3JvdyBtdWNoIHNsb3dlciwgaXQgaXMgYSBzdHJpbmcsIGFuZCBpdCB3aWxsIG5ldmVyIG92ZXJmbG93LgogICAgICoKICAgICAqIEByZXR1cm5zIGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogICAgICovCiAgICBmdW5jdGlvbiBuZXh0VWlkKCkgewogICAgICAgIHZhciBpbmRleCA9IHVpZC5sZW5ndGg7CiAgICAgICAgdmFyIGRpZ2l0OwoKICAgICAgICB3aGlsZSAoaW5kZXgpIHsKICAgICAgICAgICAgaW5kZXgtLTsKICAgICAgICAgICAgZGlnaXQgPSB1aWRbaW5kZXhdLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgICAgIGlmIChkaWdpdCA9PSA1NyAvKic5JyovKSB7CiAgICAgICAgICAgICAgICB1aWRbaW5kZXhdID0gJ0EnOwogICAgICAgICAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlnaXQgPT0gOTAgIC8qJ1onKi8pIHsKICAgICAgICAgICAgICAgIHVpZFtpbmRleF0gPSAnMCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1aWRbaW5kZXhdID0gU3RyaW5nLmZyb21DaGFyQ29kZShkaWdpdCArIDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB1aWQudW5zaGlmdCgnMCcpOwogICAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICB9CgoKICAgIC8qKgogICAgICogU2V0IG9yIGNsZWFyIHRoZSBoYXNoa2V5IGZvciBhbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gb2JqIG9iamVjdAogICAgICogQHBhcmFtIGggdGhlIGhhc2hrZXkgKCF0cnV0aHkgdG8gZGVsZXRlIHRoZSBoYXNoa2V5KQogICAgICovCiAgICBmdW5jdGlvbiBzZXRIYXNoS2V5KG9iaiwgaCkgewogICAgICAgIGlmIChoKSB7CiAgICAgICAgICAgIG9iai4kJGhhc2hLZXkgPSBoOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZGVsZXRlIG9iai4kJGhhc2hLZXk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmV4dGVuZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFeHRlbmRzIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QgYGRzdGAgYnkgY29weWluZyBhbGwgb2YgdGhlIHByb3BlcnRpZXMgZnJvbSB0aGUgYHNyY2Agb2JqZWN0KHMpCiAgICAgKiB0byBgZHN0YC4gWW91IGNhbiBzcGVjaWZ5IG11bHRpcGxlIGBzcmNgIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IGRzdCBEZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gey4uLk9iamVjdH0gc3JjIFNvdXJjZSBvYmplY3QocykuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZWZlcmVuY2UgdG8gYGRzdGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGV4dGVuZChkc3QpIHsKICAgICAgICB2YXIgaCA9IGRzdC4kJGhhc2hLZXk7CiAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgaWYgKG9iaiAhPT0gZHN0KSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgc2V0SGFzaEtleShkc3QsIGgpOwogICAgICAgIHJldHVybiBkc3Q7CiAgICB9CgogICAgZnVuY3Rpb24gaW50KHN0cikgewogICAgICAgIHJldHVybiBwYXJzZUludChzdHIsIDEwKTsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5oZXJpdChwYXJlbnQsIGV4dHJhKSB7CiAgICAgICAgcmV0dXJuIGV4dGVuZChuZXcgKGV4dGVuZChmdW5jdGlvbiAoKSB7IH0sIHsgcHJvdG90eXBlOiBwYXJlbnQgfSkpKCksIGV4dHJhKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5ub29wCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgZnVuY3Rpb24gdGhhdCBwZXJmb3JtcyBubyBvcGVyYXRpb25zLiBUaGlzIGZ1bmN0aW9uIGNhbiBiZSB1c2VmdWwgd2hlbiB3cml0aW5nIGNvZGUgaW4gdGhlCiAgICAgKiBmdW5jdGlvbmFsIHN0eWxlLgogICAgICAgPHByZT4KICAgICAgICAgZnVuY3Rpb24gZm9vKGNhbGxiYWNrKSB7CiAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGN1bGF0ZVJlc3VsdCgpOwogICAgICAgICAgIChjYWxsYmFjayB8fCBhbmd1bGFyLm5vb3ApKHJlc3VsdCk7CiAgICAgICAgIH0KICAgICAgIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiBub29wKCkgeyB9CiAgICBub29wLiRpbmplY3QgPSBbXTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaWRlbnRpdHkKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQSBmdW5jdGlvbiB0aGF0IHJldHVybnMgaXRzIGZpcnN0IGFyZ3VtZW50LiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWZ1bCB3aGVuIHdyaXRpbmcgY29kZSBpbiB0aGUKICAgICAqIGZ1bmN0aW9uYWwgc3R5bGUuCiAgICAgKgogICAgICAgPHByZT4KICAgICAgICAgZnVuY3Rpb24gdHJhbnNmb3JtZXIodHJhbnNmb3JtYXRpb25GbiwgdmFsdWUpIHsKICAgICAgICAgICByZXR1cm4gKHRyYW5zZm9ybWF0aW9uRm4gfHwgYW5ndWxhci5pZGVudGl0eSkodmFsdWUpOwogICAgICAgICB9OwogICAgICAgPC9wcmU+CiAgICAgKi8KICAgIGZ1bmN0aW9uIGlkZW50aXR5KCQpIHsgcmV0dXJuICQ7IH0KICAgIGlkZW50aXR5LiRpbmplY3QgPSBbXTsKCgogICAgZnVuY3Rpb24gdmFsdWVGbih2YWx1ZSkgeyByZXR1cm4gZnVuY3Rpb24gKCkgeyByZXR1cm4gdmFsdWU7IH07IH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc1VuZGVmaW5lZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIHVuZGVmaW5lZC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgdW5kZWZpbmVkLgogICAgICovCiAgICBmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSkgeyByZXR1cm4gdHlwZW9mIHZhbHVlID09ICd1bmRlZmluZWQnOyB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRGVmaW5lZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGRlZmluZWQuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGRlZmluZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRGVmaW5lZCh2YWx1ZSkgeyByZXR1cm4gdHlwZW9mIHZhbHVlICE9ICd1bmRlZmluZWQnOyB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzT2JqZWN0CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYE9iamVjdGAuIFVubGlrZSBgdHlwZW9mYCBpbiBKYXZhU2NyaXB0LCBgbnVsbGBzIGFyZSBub3QKICAgICAqIGNvbnNpZGVyZWQgdG8gYmUgb2JqZWN0cy4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYW4gYE9iamVjdGAgYnV0IG5vdCBgbnVsbGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JzsgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc1N0cmluZwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYFN0cmluZ2AuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYFN0cmluZ2AuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKSB7IHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZyc7IH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNOdW1iZXIKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBOdW1iZXJgLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBOdW1iZXJgLgogICAgICovCiAgICBmdW5jdGlvbiBpc051bWJlcih2YWx1ZSkgeyByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInOyB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRGF0ZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgdmFsdWUgaXMgYSBkYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBEYXRlYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNEYXRlKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRvU3RyaW5nLmFwcGx5KHZhbHVlKSA9PSAnW29iamVjdCBEYXRlXSc7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzQXJyYXkKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhbiBgQXJyYXlgLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhbiBgQXJyYXlgLgogICAgICovCiAgICBmdW5jdGlvbiBpc0FycmF5KHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRvU3RyaW5nLmFwcGx5KHZhbHVlKSA9PSAnW29iamVjdCBBcnJheV0nOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0Z1bmN0aW9uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBgRnVuY3Rpb25gLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBGdW5jdGlvbmAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnZnVuY3Rpb24nOyB9CgoKICAgIC8qKgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHZhbHVlIGlzIGEgcmVndWxhciBleHByZXNzaW9uIG9iamVjdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYFJlZ0V4cGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzUmVnRXhwKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRvU3RyaW5nLmFwcGx5KHZhbHVlKSA9PSAnW29iamVjdCBSZWdFeHBdJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYG9iamAgaXMgYSB3aW5kb3cgb2JqZWN0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IG9iaiBPYmplY3QgdG8gY2hlY2sKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGBvYmpgIGlzIGEgd2luZG93IG9iai4KICAgICAqLwogICAgZnVuY3Rpb24gaXNXaW5kb3cob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouZG9jdW1lbnQgJiYgb2JqLmxvY2F0aW9uICYmIG9iai5hbGVydCAmJiBvYmouc2V0SW50ZXJ2YWw7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGlzU2NvcGUob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouJGV2YWxBc3luYyAmJiBvYmouJHdhdGNoOwogICAgfQoKCiAgICBmdW5jdGlvbiBpc0ZpbGUob2JqKSB7CiAgICAgICAgcmV0dXJuIHRvU3RyaW5nLmFwcGx5KG9iaikgPT09ICdbb2JqZWN0IEZpbGVdJzsKICAgIH0KCgogICAgZnVuY3Rpb24gaXNCb29sZWFuKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnYm9vbGVhbic7CiAgICB9CgoKICAgIHZhciB0cmltID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBuYXRpdmUgdHJpbSBpcyB3YXkgZmFzdGVyOiBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyLXRyaW0tdGVzdAogICAgICAgIC8vIGJ1dCBJRSBkb2Vzbid0IGhhdmUgaXQuLi4gOi0oCiAgICAgICAgLy8gVE9ETzogd2Ugc2hvdWxkIG1vdmUgdGhpcyBpbnRvIElFL0VTNSBwb2x5ZmlsbAogICAgICAgIGlmICghU3RyaW5nLnByb3RvdHlwZS50cmltKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS5yZXBsYWNlKC9eXHMqLywgJycpLnJlcGxhY2UoL1xzKiQvLCAnJykgOiB2YWx1ZTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gaXNTdHJpbmcodmFsdWUpID8gdmFsdWUudHJpbSgpIDogdmFsdWU7CiAgICAgICAgfTsKICAgIH0pKCk7CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRWxlbWVudAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgRE9NIGVsZW1lbnQgKG9yIHdyYXBwZWQgalF1ZXJ5IGVsZW1lbnQpLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIERPTSBlbGVtZW50IChvciB3cmFwcGVkIGpRdWVyeSBlbGVtZW50KS4KICAgICAqLwogICAgZnVuY3Rpb24gaXNFbGVtZW50KG5vZGUpIHsKICAgICAgICByZXR1cm4gbm9kZSAmJgogICAgICAgICAgKG5vZGUubm9kZU5hbWUgIC8vIHdlIGFyZSBhIGRpcmVjdCBlbGVtZW50CiAgICAgICAgICB8fCAobm9kZS5vbiAmJiBub2RlLmZpbmQpKTsgIC8vIHdlIGhhdmUgYW4gb24gYW5kIGZpbmQgbWV0aG9kIHBhcnQgb2YgalF1ZXJ5IEFQSQogICAgfQoKICAgIC8qKgogICAgICogQHBhcmFtIHN0ciAna2V5MSxrZXkyLC4uLicKICAgICAqIEByZXR1cm5zIHtvYmplY3R9IGluIHRoZSBmb3JtIG9mIHtrZXkxOnRydWUsIGtleTI6dHJ1ZSwgLi4ufQogICAgICovCiAgICBmdW5jdGlvbiBtYWtlTWFwKHN0cikgewogICAgICAgIHZhciBvYmogPSB7fSwgaXRlbXMgPSBzdHIuc3BsaXQoIiwiKSwgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIG9ialtpdGVtc1tpXV0gPSB0cnVlOwogICAgICAgIHJldHVybiBvYmo7CiAgICB9CgoKICAgIGlmIChtc2llIDwgOSkgewogICAgICAgIG5vZGVOYW1lXyA9IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50Lm5vZGVOYW1lID8gZWxlbWVudCA6IGVsZW1lbnRbMF07CiAgICAgICAgICAgIHJldHVybiAoZWxlbWVudC5zY29wZU5hbWUgJiYgZWxlbWVudC5zY29wZU5hbWUgIT0gJ0hUTUwnKQogICAgICAgICAgICAgID8gdXBwZXJjYXNlKGVsZW1lbnQuc2NvcGVOYW1lICsgJzonICsgZWxlbWVudC5ub2RlTmFtZSkgOiBlbGVtZW50Lm5vZGVOYW1lOwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIG5vZGVOYW1lXyA9IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5vZGVOYW1lID8gZWxlbWVudC5ub2RlTmFtZSA6IGVsZW1lbnRbMF0ubm9kZU5hbWU7CiAgICAgICAgfTsKICAgIH0KCgogICAgZnVuY3Rpb24gbWFwKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgICAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgICAgIGZvckVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgICAgICAgIHJlc3VsdHMucHVzaChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgfQoKCiAgICAvKioKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIGFycmF5LCB0aGUgbnVtYmVyIG9mIHByb3BlcnRpZXMgYW4gb2JqZWN0IGhhcywgb3IKICAgICAqIHRoZSBsZW5ndGggb2YgYSBzdHJpbmcuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIE9iamVjdCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIGFuZ3VsYXIuT2JqZWN0fSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdHxBcnJheXxzdHJpbmd9IG9iaiBPYmplY3QsIGFycmF5LCBvciBzdHJpbmcgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW293blByb3BzT25seT1mYWxzZV0gQ291bnQgb25seSAib3duIiBwcm9wZXJ0aWVzIGluIGFuIG9iamVjdAogICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHNpemUgb2YgYG9iamAgb3IgYDBgIGlmIGBvYmpgIGlzIG5laXRoZXIgYW4gb2JqZWN0IG5vciBhbiBhcnJheS4KICAgICAqLwogICAgZnVuY3Rpb24gc2l6ZShvYmosIG93blByb3BzT25seSkgewogICAgICAgIHZhciBzaXplID0gMCwga2V5OwoKICAgICAgICBpZiAoaXNBcnJheShvYmopIHx8IGlzU3RyaW5nKG9iaikpIHsKICAgICAgICAgICAgcmV0dXJuIG9iai5sZW5ndGg7CiAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIG9iaikKICAgICAgICAgICAgICAgIGlmICghb3duUHJvcHNPbmx5IHx8IG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKQogICAgICAgICAgICAgICAgICAgIHNpemUrKzsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzaXplOwogICAgfQoKCiAgICBmdW5jdGlvbiBpbmNsdWRlcyhhcnJheSwgb2JqKSB7CiAgICAgICAgcmV0dXJuIGluZGV4T2YoYXJyYXksIG9iaikgIT0gLTE7CiAgICB9CgogICAgZnVuY3Rpb24gaW5kZXhPZihhcnJheSwgb2JqKSB7CiAgICAgICAgaWYgKGFycmF5LmluZGV4T2YpIHJldHVybiBhcnJheS5pbmRleE9mKG9iaik7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKG9iaiA9PT0gYXJyYXlbaV0pIHJldHVybiBpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgZnVuY3Rpb24gYXJyYXlSZW1vdmUoYXJyYXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGluZGV4ID0gaW5kZXhPZihhcnJheSwgdmFsdWUpOwogICAgICAgIGlmIChpbmRleCA+PSAwKQogICAgICAgICAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0xlYWZOb2RlKG5vZGUpIHsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgIGNhc2UgIk9QVElPTiI6CiAgICAgICAgICAgICAgICBjYXNlICJQUkUiOgogICAgICAgICAgICAgICAgY2FzZSAiVElUTEUiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5jb3B5CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBkZWVwIGNvcHkgb2YgYHNvdXJjZWAsIHdoaWNoIHNob3VsZCBiZSBhbiBvYmplY3Qgb3IgYW4gYXJyYXkuCiAgICAgKgogICAgICogKiBJZiBubyBkZXN0aW5hdGlvbiBpcyBzdXBwbGllZCwgYSBjb3B5IG9mIHRoZSBvYmplY3Qgb3IgYXJyYXkgaXMgY3JlYXRlZC4KICAgICAqICogSWYgYSBkZXN0aW5hdGlvbiBpcyBwcm92aWRlZCwgYWxsIG9mIGl0cyBlbGVtZW50cyAoZm9yIGFycmF5KSBvciBwcm9wZXJ0aWVzIChmb3Igb2JqZWN0cykKICAgICAqICAgYXJlIGRlbGV0ZWQgYW5kIHRoZW4gYWxsIGVsZW1lbnRzL3Byb3BlcnRpZXMgZnJvbSB0aGUgc291cmNlIGFyZSBjb3BpZWQgdG8gaXQuCiAgICAgKiAqIElmICBgc291cmNlYCBpcyBub3QgYW4gb2JqZWN0IG9yIGFycmF5LCBgc291cmNlYCBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgT2JqZWN0IHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICAgKiB7QGxpbmsgbmcuJGZpbHRlcn0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBzb3VyY2UgVGhlIHNvdXJjZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBtYWtlIGEgY29weS4KICAgICAqICAgICAgICAgICAgICAgICAgIENhbiBiZSBhbnkgdHlwZSwgaW5jbHVkaW5nIHByaW1pdGl2ZXMsIGBudWxsYCwgYW5kIGB1bmRlZmluZWRgLgogICAgICogQHBhcmFtIHsoT2JqZWN0fEFycmF5KT19IGRlc3RpbmF0aW9uIERlc3RpbmF0aW9uIGludG8gd2hpY2ggdGhlIHNvdXJjZSBpcyBjb3BpZWQuIElmCiAgICAgKiAgICAgcHJvdmlkZWQsIG11c3QgYmUgb2YgdGhlIHNhbWUgdHlwZSBhcyBgc291cmNlYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgY29weSBvciB1cGRhdGVkIGBkZXN0aW5hdGlvbmAsIGlmIGBkZXN0aW5hdGlvbmAgd2FzIHNwZWNpZmllZC4KICAgICAqLwogICAgZnVuY3Rpb24gY29weShzb3VyY2UsIGRlc3RpbmF0aW9uKSB7CiAgICAgICAgaWYgKGlzV2luZG93KHNvdXJjZSkgfHwgaXNTY29wZShzb3VyY2UpKSB7CiAgICAgICAgICAgIHRocm93IG5nTWluRXJyKCdjcHdzJywgIkNhbid0IGNvcHkhIE1ha2luZyBjb3BpZXMgb2YgV2luZG93IG9yIFNjb3BlIGluc3RhbmNlcyBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFkZXN0aW5hdGlvbikgewogICAgICAgICAgICBkZXN0aW5hdGlvbiA9IHNvdXJjZTsKICAgICAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uID0gY29weShzb3VyY2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKHNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbiA9IG5ldyBEYXRlKHNvdXJjZS5nZXRUaW1lKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1JlZ0V4cChzb3VyY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBuZXcgUmVnRXhwKHNvdXJjZS5zb3VyY2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdChzb3VyY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBjb3B5KHNvdXJjZSwge30pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSA9PT0gZGVzdGluYXRpb24pIHRocm93IG5nTWluRXJyKCdjcGknLCAiQ2FuJ3QgY29weSEgU291cmNlIGFuZCBkZXN0aW5hdGlvbiBhcmUgaWRlbnRpY2FsLiIpOwogICAgICAgICAgICBpZiAoaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbi5sZW5ndGggPSAwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3VyY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbi5wdXNoKGNvcHkoc291cmNlW2ldKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaCA9IGRlc3RpbmF0aW9uLiQkaGFzaEtleTsKICAgICAgICAgICAgICAgIGZvckVhY2goZGVzdGluYXRpb24sIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRlc3RpbmF0aW9uW2tleV07CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbltrZXldID0gY29weShzb3VyY2Vba2V5XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRIYXNoS2V5KGRlc3RpbmF0aW9uLCBoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVzdGluYXRpb247CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBzaGFsbG93IGNvcHkgb2YgYW4gb2JqZWN0CiAgICAgKi8KICAgIGZ1bmN0aW9uIHNoYWxsb3dDb3B5KHNyYywgZHN0KSB7CiAgICAgICAgZHN0ID0gZHN0IHx8IHt9OwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gc3JjKSB7CiAgICAgICAgICAgIGlmIChzcmMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiBrZXkuc3Vic3RyKDAsIDIpICE9PSAnJCQnKSB7CiAgICAgICAgICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZHN0OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5lcXVhbHMKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiB0d28gb2JqZWN0cyBvciB0d28gdmFsdWVzIGFyZSBlcXVpdmFsZW50LiBTdXBwb3J0cyB2YWx1ZSB0eXBlcywgcmVndWxhciBleHByZXNzaW9ucywgYXJyYXlzIGFuZAogICAgICogb2JqZWN0cy4KICAgICAqCiAgICAgKiBUd28gb2JqZWN0cyBvciB2YWx1ZXMgYXJlIGNvbnNpZGVyZWQgZXF1aXZhbGVudCBpZiBhdCBsZWFzdCBvbmUgb2YgdGhlIGZvbGxvd2luZyBpcyB0cnVlOgogICAgICoKICAgICAqICogQm90aCBvYmplY3RzIG9yIHZhbHVlcyBwYXNzIGA9PT1gIGNvbXBhcmlzb24uCiAgICAgKiAqIEJvdGggb2JqZWN0cyBvciB2YWx1ZXMgYXJlIG9mIHRoZSBzYW1lIHR5cGUgYW5kIGFsbCBvZiB0aGVpciBwcm9wZXJ0aWVzIHBhc3MgYD09PWAgY29tcGFyaXNvbi4KICAgICAqICogQm90aCB2YWx1ZXMgYXJlIE5hTi4gKEluIEphdmFzU2NyaXB0LCBOYU4gPT0gTmFOID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIE5hTiBhcyBlcXVhbCkKICAgICAqICogQm90aCB2YWx1ZXMgcmVwcmVzZW50IHRoZSBzYW1lIHJlZ3VsYXIgZXhwcmVzc2lvbiAoSW4gSmF2YXNTY3JpcHQsCiAgICAgKiAgIC9hYmMvID09IC9hYmMvID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIHJlZ3VsYXIgZXhwcmVzc2lvbnMgYXMgZXF1YWwgd2hlbiB0aGVpciB0ZXh0dWFsCiAgICAgKiAgIHJlcHJlc2VudGF0aW9uIG1hdGNoZXMpLgogICAgICoKICAgICAqIER1cmluZyBhIHByb3BlcnR5IGNvbXBhcmlzb24sIHByb3BlcnRpZXMgb2YgYGZ1bmN0aW9uYCB0eXBlIGFuZCBwcm9wZXJ0aWVzIHdpdGggbmFtZXMKICAgICAqIHRoYXQgYmVnaW4gd2l0aCBgJGAgYXJlIGlnbm9yZWQuCiAgICAgKgogICAgICogU2NvcGUgYW5kIERPTVdpbmRvdyBvYmplY3RzIGFyZSBiZWluZyBjb21wYXJlZCBvbmx5IGJ5IGlkZW50aWZ5IChgPT09YCkuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBvMSBPYmplY3Qgb3IgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7Kn0gbzIgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBhcmd1bWVudHMgYXJlIGVxdWFsLgogICAgICovCiAgICBmdW5jdGlvbiBlcXVhbHMobzEsIG8yKSB7CiAgICAgICAgaWYgKG8xID09PSBvMikgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKG8xID09PSBudWxsIHx8IG8yID09PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKG8xICE9PSBvMSAmJiBvMiAhPT0gbzIpIHJldHVybiB0cnVlOyAvLyBOYU4gPT09IE5hTgogICAgICAgIHZhciB0MSA9IHR5cGVvZiBvMSwgdDIgPSB0eXBlb2YgbzIsIGxlbmd0aCwga2V5LCBrZXlTZXQ7CiAgICAgICAgaWYgKHQxID09IHQyKSB7CiAgICAgICAgICAgIGlmICh0MSA9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobzEpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KG8yKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmICgobGVuZ3RoID0gbzEubGVuZ3RoKSA9PSBvMi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgPSAwOyBrZXkgPCBsZW5ndGg7IGtleSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVxdWFscyhvMVtrZXldLCBvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKG8xKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc0RhdGUobzIpICYmIG8xLmdldFRpbWUoKSA9PSBvMi5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzUmVnRXhwKG8xKSAmJiBpc1JlZ0V4cChvMikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbzEudG9TdHJpbmcoKSA9PSBvMi50b1N0cmluZygpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNTY29wZShvMSkgfHwgaXNTY29wZShvMikgfHwgaXNXaW5kb3cobzEpIHx8IGlzV2luZG93KG8yKSB8fCBpc0FycmF5KG8yKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGtleVNldCA9IHt9OwogICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG8xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkuY2hhckF0KDApID09PSAnJCcgfHwgaXNGdW5jdGlvbihvMVtrZXldKSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleVNldFtrZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gbzIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFrZXlTZXQuaGFzT3duUHJvcGVydHkoa2V5KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvMltrZXldICE9PSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICFpc0Z1bmN0aW9uKG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCgogICAgZnVuY3Rpb24gY29uY2F0KGFycmF5MSwgYXJyYXkyLCBpbmRleCkgewogICAgICAgIHJldHVybiBhcnJheTEuY29uY2F0KHNsaWNlLmNhbGwoYXJyYXkyLCBpbmRleCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNsaWNlQXJncyhhcmdzLCBzdGFydEluZGV4KSB7CiAgICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJncywgc3RhcnRJbmRleCB8fCAwKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYmluZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gd2hpY2ggY2FsbHMgZnVuY3Rpb24gYGZuYCBib3VuZCB0byBgc2VsZmAgKGBzZWxmYCBiZWNvbWVzIHRoZSBgdGhpc2AgZm9yCiAgICAgKiBgZm5gKS4gWW91IGNhbiBzdXBwbHkgb3B0aW9uYWwgYGFyZ3NgIHRoYXQgYXJlIHByZWJvdW5kIHRvIHRoZSBmdW5jdGlvbi4gVGhpcyBmZWF0dXJlIGlzIGFsc28KICAgICAqIGtub3duIGFzIFtmdW5jdGlvbiBjdXJyeWluZ10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9DdXJyeWluZykuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IHNlbGYgQ29udGV4dCB3aGljaCBgZm5gIHNob3VsZCBiZSBldmFsdWF0ZWQgaW4uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEZ1bmN0aW9uIHRvIGJlIGJvdW5kLgogICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwcmVib3VuZCB0byB0aGUgYGZuYCBmdW5jdGlvbiBjYWxsLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEZ1bmN0aW9uIHRoYXQgd3JhcHMgdGhlIGBmbmAgd2l0aCBhbGwgdGhlIHNwZWNpZmllZCBiaW5kaW5ncy4KICAgICAqLwogICAgZnVuY3Rpb24gYmluZChzZWxmLCBmbikgewogICAgICAgIHZhciBjdXJyeUFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoID4gMiA/IHNsaWNlQXJncyhhcmd1bWVudHMsIDIpIDogW107CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm4pICYmICEoZm4gaW5zdGFuY2VvZiBSZWdFeHApKSB7CiAgICAgICAgICAgIHJldHVybiBjdXJyeUFyZ3MubGVuZ3RoCiAgICAgICAgICAgICAgPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgPyBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSkpCiAgICAgICAgICAgICAgICAgICAgOiBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGgKICAgICAgICAgICAgICAgICAgICA/IGZuLmFwcGx5KHNlbGYsIGFyZ3VtZW50cykKICAgICAgICAgICAgICAgICAgICA6IGZuLmNhbGwoc2VsZik7CiAgICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBpbiBJRSwgbmF0aXZlIG1ldGhvZHMgYXJlIG5vdCBmdW5jdGlvbnMgc28gdGhleSBjYW5ub3QgYmUgYm91bmQgKG5vdGU6IHRoZXkgZG9uJ3QgbmVlZCB0byBiZSkKICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gdG9Kc29uUmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciB2YWwgPSB2YWx1ZTsKCiAgICAgICAgaWYgKC9eXCQrLy50ZXN0KGtleSkpIHsKICAgICAgICAgICAgdmFsID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSBpZiAoaXNXaW5kb3codmFsdWUpKSB7CiAgICAgICAgICAgIHZhbCA9ICckV0lORE9XJzsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlICYmIGRvY3VtZW50ID09PSB2YWx1ZSkgewogICAgICAgICAgICB2YWwgPSAnJERPQ1VNRU5UJzsKICAgICAgICB9IGVsc2UgaWYgKGlzU2NvcGUodmFsdWUpKSB7CiAgICAgICAgICAgIHZhbCA9ICckU0NPUEUnOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIudG9Kc29uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNlcmlhbGl6ZXMgaW5wdXQgaW50byBhIEpTT04tZm9ybWF0dGVkIHN0cmluZy4gUHJvcGVydGllcyB3aXRoIGxlYWRpbmcgJCBjaGFyYWN0ZXJzIHdpbGwgYmUKICAgICAqIHN0cmlwcGVkIHNpbmNlIGFuZ3VsYXIgdXNlcyB0aGlzIG5vdGF0aW9uIGludGVybmFsbHkuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R8QXJyYXl8RGF0ZXxzdHJpbmd8bnVtYmVyfSBvYmogSW5wdXQgdG8gYmUgc2VyaWFsaXplZCBpbnRvIEpTT04uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBwcmV0dHkgSWYgc2V0IHRvIHRydWUsIHRoZSBKU09OIG91dHB1dCB3aWxsIGNvbnRhaW4gbmV3bGluZXMgYW5kIHdoaXRlc3BhY2UuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gSlNPTi1pZmllZCBzdHJpbmcgcmVwcmVzZW50aW5nIGBvYmpgLgogICAgICovCiAgICBmdW5jdGlvbiB0b0pzb24ob2JqLCBwcmV0dHkpIHsKICAgICAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaiwgdG9Kc29uUmVwbGFjZXIsIHByZXR0eSA/ICcgICcgOiBudWxsKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZnJvbUpzb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGVzZXJpYWxpemVzIGEgSlNPTiBzdHJpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGpzb24gSlNPTiBzdHJpbmcgdG8gZGVzZXJpYWxpemUuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fEFycmF5fERhdGV8c3RyaW5nfG51bWJlcn0gRGVzZXJpYWxpemVkIHRoaW5neS4KICAgICAqLwogICAgZnVuY3Rpb24gZnJvbUpzb24oanNvbikgewogICAgICAgIHJldHVybiBpc1N0cmluZyhqc29uKQogICAgICAgICAgICA/IEpTT04ucGFyc2UoanNvbikKICAgICAgICAgICAgOiBqc29uOwogICAgfQoKCiAgICBmdW5jdGlvbiB0b0Jvb2xlYW4odmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHZhciB2ID0gbG93ZXJjYXNlKCIiICsgdmFsdWUpOwogICAgICAgICAgICB2YWx1ZSA9ICEodiA9PSAnZicgfHwgdiA9PSAnMCcgfHwgdiA9PSAnZmFsc2UnIHx8IHYgPT0gJ25vJyB8fCB2ID09ICduJyB8fCB2ID09ICdbXScpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgZWxlbWVudC4KICAgICAqLwogICAgZnVuY3Rpb24gc3RhcnRpbmdUYWcoZWxlbWVudCkgewogICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCkuY2xvbmUoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyB0dXJucyBvdXQgSUUgZG9lcyBub3QgbGV0IHlvdSBzZXQgLmh0bWwoKSBvbiBlbGVtZW50cyB3aGljaAogICAgICAgICAgICAvLyBhcmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBjaGlsZHJlbi4gU28gd2UganVzdCBpZ25vcmUgaXQuCiAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgfSBjYXRjaCAoZSkgeyB9CiAgICAgICAgLy8gQXMgUGVyIERPTSBTdGFuZGFyZHMKICAgICAgICB2YXIgVEVYVF9OT0RFID0gMzsKICAgICAgICB2YXIgZWxlbUh0bWwgPSBqcUxpdGUoJzxkaXY+JykuYXBwZW5kKGVsZW1lbnQpLmh0bWwoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudFswXS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gbG93ZXJjYXNlKGVsZW1IdG1sKSA6CiAgICAgICAgICAgICAgICBlbGVtSHRtbC4KICAgICAgICAgICAgICAgICAgbWF0Y2goL14oPFtePl0rPikvKVsxXS4KICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvXjwoW1x3XC1dKykvLCBmdW5jdGlvbiAobWF0Y2gsIG5vZGVOYW1lKSB7IHJldHVybiAnPCcgKyBsb3dlcmNhc2Uobm9kZU5hbWUpOyB9KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBsb3dlcmNhc2UoZWxlbUh0bWwpOwogICAgICAgIH0KCiAgICB9CgoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvKioKICAgICAqIFRyaWVzIHRvIGRlY29kZSB0aGUgVVJJIGNvbXBvbmVudCB3aXRob3V0IHRocm93aW5nIGFuIGV4Y2VwdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHN0ciB2YWx1ZSBwb3RlbnRpYWwgVVJJIGNvbXBvbmVudCB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgY2FuIGJlIGRlY29kZWQKICAgICAqIHdpdGggdGhlIGRlY29kZVVSSUNvbXBvbmVudCBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyBJZ25vcmUgYW55IGludmFsaWQgdXJpIGNvbXBvbmVudAogICAgICAgIH0KICAgIH0KCgogICAgLyoqCiAgICAgKiBQYXJzZXMgYW4gZXNjYXBlZCB1cmwgcXVlcnkgc3RyaW5nIGludG8ga2V5LXZhbHVlIHBhaXJzLgogICAgICogQHJldHVybnMgT2JqZWN0Ljwoc3RyaW5nfGJvb2xlYW4pPgogICAgICovCiAgICBmdW5jdGlvbiBwYXJzZUtleVZhbHVlKC8qKnN0cmluZyova2V5VmFsdWUpIHsKICAgICAgICB2YXIgb2JqID0ge30sIGtleV92YWx1ZSwga2V5OwogICAgICAgIGZvckVhY2goKGtleVZhbHVlIHx8ICIiKS5zcGxpdCgnJicpLCBmdW5jdGlvbiAoa2V5VmFsdWUpIHsKICAgICAgICAgICAgaWYgKGtleVZhbHVlKSB7CiAgICAgICAgICAgICAgICBrZXlfdmFsdWUgPSBrZXlWYWx1ZS5zcGxpdCgnPScpOwogICAgICAgICAgICAgICAga2V5ID0gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KGtleV92YWx1ZVswXSk7CiAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGtleSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsID0gaXNEZWZpbmVkKGtleV92YWx1ZVsxXSkgPyB0cnlEZWNvZGVVUklDb21wb25lbnQoa2V5X3ZhbHVlWzFdKSA6IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFvYmpba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqW2tleV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9ialtrZXldLnB1c2godmFsKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IFtvYmpba2V5XSwgdmFsXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIGZ1bmN0aW9uIHRvS2V5VmFsdWUob2JqKSB7CiAgICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgICAgZm9yRWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgZm9yRWFjaCh2YWx1ZSwgZnVuY3Rpb24gKGFycmF5VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGVuY29kZVVyaVF1ZXJ5KGtleSwgdHJ1ZSkgKyAoYXJyYXlWYWx1ZSA9PT0gdHJ1ZSA/ICcnIDogJz0nICsgZW5jb2RlVXJpUXVlcnkoYXJyYXlWYWx1ZSwgdHJ1ZSkpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcGFydHMucHVzaChlbmNvZGVVcmlRdWVyeShrZXksIHRydWUpICsgKHZhbHVlID09PSB0cnVlID8gJycgOiAnPScgKyBlbmNvZGVVcmlRdWVyeSh2YWx1ZSwgdHJ1ZSkpKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBwYXJ0cy5sZW5ndGggPyBwYXJ0cy5qb2luKCcmJykgOiAnJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBXZSBuZWVkIG91ciBjdXN0b20gbWV0aG9kIGJlY2F1c2UgZW5jb2RlVVJJQ29tcG9uZW50IGlzIHRvbyBhZ2dyZXNzaXZlIGFuZCBkb2Vzbid0IGZvbGxvdwogICAgICogaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMzk4Ni50eHQgd2l0aCByZWdhcmRzIHRvIHRoZSBjaGFyYWN0ZXIgc2V0IChwY2hhcikgYWxsb3dlZCBpbiBwYXRoCiAgICAgKiBzZWdtZW50czoKICAgICAqICAgIHNlZ21lbnQgICAgICAgPSAqcGNoYXIKICAgICAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAgICAgKiAgICBwY3QtZW5jb2RlZCAgID0gIiUiIEhFWERJRyBIRVhESUcKICAgICAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAgICAgKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZVVyaVNlZ21lbnQodmFsKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZVVyaVF1ZXJ5KHZhbCwgdHJ1ZSkuCiAgICAgICAgICAgICAgICAgICByZXBsYWNlKC8lMjYvZ2ksICcmJykuCiAgICAgICAgICAgICAgICAgICByZXBsYWNlKC8lM0QvZ2ksICc9JykuCiAgICAgICAgICAgICAgICAgICByZXBsYWNlKC8lMkIvZ2ksICcrJyk7CiAgICB9CgoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgaW50ZW5kZWQgZm9yIGVuY29kaW5nICprZXkqIG9yICp2YWx1ZSogcGFydHMgb2YgcXVlcnkgY29tcG9uZW50LiBXZSBuZWVkIGEgY3VzdG9tCiAgICAgKiBtZXRob2QgYmVjYXVzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFnZ3Jlc3NpdmUgYW5kIGVuY29kZXMgc3R1ZmYgdGhhdCBkb2Vzbid0IGhhdmUgdG8gYmUKICAgICAqIGVuY29kZWQgcGVyIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzM5ODY6CiAgICAgKiAgICBxdWVyeSAgICAgICA9ICooIHBjaGFyIC8gIi8iIC8gIj8iICkKICAgICAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAgICAgKiAgICB1bnJlc2VydmVkICAgID0gQUxQSEEgLyBESUdJVCAvICItIiAvICIuIiAvICJfIiAvICJ+IgogICAgICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAgICAgKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZVVyaVF1ZXJ5KHZhbCwgcGN0RW5jb2RlU3BhY2VzKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpLgogICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvJTQwL2dpLCAnQCcpLgogICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvJTNBL2dpLCAnOicpLgogICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvJTI0L2csICckJykuCiAgICAgICAgICAgICAgICAgICByZXBsYWNlKC8lMkMvZ2ksICcsJykuCiAgICAgICAgICAgICAgICAgICByZXBsYWNlKC8lMjAvZywgKHBjdEVuY29kZVNwYWNlcyA/ICclMjAnIDogJysnKSk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQXBwCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2FuZ3VsYXIuTW9kdWxlfSBuZ0FwcCBhbiBvcHRpb25hbCBhcHBsaWNhdGlvbgogICAgICogICB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlfSBuYW1lIHRvIGxvYWQuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVXNlIHRoaXMgZGlyZWN0aXZlIHRvIGF1dG8tYm9vdHN0cmFwIGFuIGFwcGxpY2F0aW9uLiBPbmx5CiAgICAgKiBvbmUgbmdBcHAgZGlyZWN0aXZlIGNhbiBiZSB1c2VkIHBlciBIVE1MIGRvY3VtZW50LiBUaGUgZGlyZWN0aXZlCiAgICAgKiBkZXNpZ25hdGVzIHRoZSByb290IG9mIHRoZSBhcHBsaWNhdGlvbiBhbmQgaXMgdHlwaWNhbGx5IHBsYWNlZAogICAgICogYXQgdGhlIHJvb3Qgb2YgdGhlIHBhZ2UuCiAgICAgKgogICAgICogVGhlIGZpcnN0IG5nQXBwIGZvdW5kIGluIHRoZSBkb2N1bWVudCB3aWxsIGJlIGF1dG8tYm9vdHN0cmFwcGVkLiBUbyB1c2UgbXVsdGlwbGUgYXBwbGljYXRpb25zIGluIGFuCiAgICAgKiBIVE1MIGRvY3VtZW50IHlvdSBtdXN0IG1hbnVhbGx5IGJvb3RzdHJhcCB0aGVtIHVzaW5nIHtAbGluayBhbmd1bGFyLmJvb3RzdHJhcH0uCiAgICAgKiBBcHBsaWNhdGlvbnMgY2Fubm90IGJlIG5lc3RlZC4KICAgICAqCiAgICAgKiBJbiB0aGUgZXhhbXBsZSBiZWxvdyBpZiB0aGUgYG5nQXBwYCBkaXJlY3RpdmUgd291bGQgbm90IGJlIHBsYWNlZAogICAgICogb24gdGhlIGBodG1sYCBlbGVtZW50IHRoZW4gdGhlIGRvY3VtZW50IHdvdWxkIG5vdCBiZSBjb21waWxlZAogICAgICogYW5kIHRoZSBge3sgMSsyIH19YCB3b3VsZCBub3QgYmUgcmVzb2x2ZWQgdG8gYDNgLgogICAgICoKICAgICAqIGBuZ0FwcGAgaXMgdGhlIGVhc2llc3Qgd2F5IHRvIGJvb3RzdHJhcCBhbiBhcHBsaWNhdGlvbi4KICAgICAqCiAgICAgPGRvYzpleGFtcGxlPgogICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgSSBjYW4gYWRkOiAxICsgMiA9ICB7eyAxKzIgfX0KICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gYW5ndWxhckluaXQoZWxlbWVudCwgYm9vdHN0cmFwKSB7CiAgICAgICAgdmFyIGVsZW1lbnRzID0gW2VsZW1lbnRdLAogICAgICAgICAgICBhcHBFbGVtZW50LAogICAgICAgICAgICBtb2R1bGUsCiAgICAgICAgICAgIG5hbWVzID0gWyduZzphcHAnLCAnbmctYXBwJywgJ3gtbmctYXBwJywgJ2RhdGEtbmctYXBwJ10sCiAgICAgICAgICAgIE5HX0FQUF9DTEFTU19SRUdFWFAgPSAvXHNuZ1s6XC1dYXBwKDpccyooW1x3XGRfXSspOz8pP1xzLzsKCiAgICAgICAgZnVuY3Rpb24gYXBwZW5kKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudCAmJiBlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgZm9yRWFjaChuYW1lcywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgbmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBhcHBlbmQoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobmFtZSkpOwogICAgICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKCc6JywgJ1xcOicpOwogICAgICAgICAgICBpZiAoZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLicgKyBuYW1lKSwgYXBwZW5kKTsKICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIG5hbWUgKyAnXFw6JyksIGFwcGVuZCk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnWycgKyBuYW1lICsgJ10nKSwgYXBwZW5kKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBmb3JFYWNoKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICBpZiAoIWFwcEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjbGFzc05hbWUgPSAnICcgKyBlbGVtZW50LmNsYXNzTmFtZSArICcgJzsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IE5HX0FQUF9DTEFTU19SRUdFWFAuZXhlYyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgYXBwRWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgbW9kdWxlID0gKG1hdGNoWzJdIHx8ICcnKS5yZXBsYWNlKC9ccysvZywgJywnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LmF0dHJpYnV0ZXMsIGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXBwRWxlbWVudCAmJiBuYW1lc1thdHRyLm5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZSA9IGF0dHIudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmIChhcHBFbGVtZW50KSB7CiAgICAgICAgICAgIGJvb3RzdHJhcChhcHBFbGVtZW50LCBtb2R1bGUgPyBbbW9kdWxlXSA6IFtdKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYm9vdHN0cmFwCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzZSB0aGlzIGZ1bmN0aW9uIHRvIG1hbnVhbGx5IHN0YXJ0IHVwIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogU2VlOiB7QGxpbmsgZ3VpZGUvYm9vdHN0cmFwIEJvb3RzdHJhcH0KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgbmdTY2VuYXJpby1iYXNlZCBlbmQtdG8tZW5kIHRlc3RzIGNhbm5vdCB1c2UgdGhpcyBmdW5jdGlvbiB0byBib290c3RyYXAgbWFudWFsbHkuCiAgICAgKiBUaGV5IG11c3QgdXNlIHtAbGluayBhcGkvbmcuZGlyZWN0aXZlOm5nQXBwIG5nQXBwfS4KICAgICAqCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgRE9NIGVsZW1lbnQgd2hpY2ggaXMgdGhlIHJvb3Qgb2YgYW5ndWxhciBhcHBsaWNhdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nfEZ1bmN0aW9uPj19IG1vZHVsZXMgYW4gYXJyYXkgb2YgbW9kdWxlIGRlY2xhcmF0aW9ucy4gU2VlOiB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30KICAgICAqIEByZXR1cm5zIHtBVVRPLiRpbmplY3Rvcn0gUmV0dXJucyB0aGUgbmV3bHkgY3JlYXRlZCBpbmplY3RvciBmb3IgdGhpcyBhcHAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJvb3RzdHJhcChlbGVtZW50LCBtb2R1bGVzKSB7CiAgICAgICAgdmFyIGRvQm9vdHN0cmFwID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwoKICAgICAgICAgICAgaWYgKGVsZW1lbnQuaW5qZWN0b3IoKSkgewogICAgICAgICAgICAgICAgdmFyIHRhZyA9IChlbGVtZW50WzBdID09PSBkb2N1bWVudCkgPyAnZG9jdW1lbnQnIDogc3RhcnRpbmdUYWcoZWxlbWVudCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZ01pbkVycignYnRzdHJwZCcsICJBcHAgQWxyZWFkeSBCb290c3RyYXBwZWQgd2l0aCB0aGlzIEVsZW1lbnQgJ3swfSciLCB0YWcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtb2R1bGVzID0gbW9kdWxlcyB8fCBbXTsKICAgICAgICAgICAgbW9kdWxlcy51bnNoaWZ0KFsnJHByb3ZpZGUnLCBmdW5jdGlvbiAoJHByb3ZpZGUpIHsKICAgICAgICAgICAgICAgICRwcm92aWRlLnZhbHVlKCckcm9vdEVsZW1lbnQnLCBlbGVtZW50KTsKICAgICAgICAgICAgfV0pOwogICAgICAgICAgICBtb2R1bGVzLnVuc2hpZnQoJ25nJyk7CiAgICAgICAgICAgIHZhciBpbmplY3RvciA9IGNyZWF0ZUluamVjdG9yKG1vZHVsZXMpOwogICAgICAgICAgICBpbmplY3Rvci5pbnZva2UoWyckcm9vdFNjb3BlJywgJyRyb290RWxlbWVudCcsICckY29tcGlsZScsICckaW5qZWN0b3InLCAnJGFuaW1hdGUnLAogICAgICAgICAgICAgICBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGNvbXBpbGUsIGluamVjdG9yLCBhbmltYXRlKSB7CiAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YSgnJGluamVjdG9yJywgaW5qZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGUoZWxlbWVudCkoc2NvcGUpOwogICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICBhbmltYXRlLmVuYWJsZWQodHJ1ZSk7CiAgICAgICAgICAgICAgIH1dCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybiBpbmplY3RvcjsKICAgICAgICB9OwoKICAgICAgICB2YXIgTkdfREVGRVJfQk9PVFNUUkFQID0gL15OR19ERUZFUl9CT09UU1RSQVAhLzsKCiAgICAgICAgaWYgKHdpbmRvdyAmJiAhTkdfREVGRVJfQk9PVFNUUkFQLnRlc3Qod2luZG93Lm5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBkb0Jvb3RzdHJhcCgpOwogICAgICAgIH0KCiAgICAgICAgd2luZG93Lm5hbWUgPSB3aW5kb3cubmFtZS5yZXBsYWNlKE5HX0RFRkVSX0JPT1RTVFJBUCwgJycpOwogICAgICAgIGFuZ3VsYXIucmVzdW1lQm9vdHN0cmFwID0gZnVuY3Rpb24gKGV4dHJhTW9kdWxlcykgewogICAgICAgICAgICBmb3JFYWNoKGV4dHJhTW9kdWxlcywgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgICAgICAgICAgICAgbW9kdWxlcy5wdXNoKG1vZHVsZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkb0Jvb3RzdHJhcCgpOwogICAgICAgIH07CiAgICB9CgogICAgdmFyIFNOQUtFX0NBU0VfUkVHRVhQID0gL1tBLVpdL2c7CiAgICBmdW5jdGlvbiBzbmFrZV9jYXNlKG5hbWUsIHNlcGFyYXRvcikgewogICAgICAgIHNlcGFyYXRvciA9IHNlcGFyYXRvciB8fCAnXyc7CiAgICAgICAgcmV0dXJuIG5hbWUucmVwbGFjZShTTkFLRV9DQVNFX1JFR0VYUCwgZnVuY3Rpb24gKGxldHRlciwgcG9zKSB7CiAgICAgICAgICAgIHJldHVybiAocG9zID8gc2VwYXJhdG9yIDogJycpICsgbGV0dGVyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gYmluZEpRdWVyeSgpIHsKICAgICAgICAvLyBiaW5kIHRvIGpRdWVyeSBpZiBwcmVzZW50OwogICAgICAgIGpRdWVyeSA9IHdpbmRvdy5qUXVlcnk7CiAgICAgICAgLy8gcmVzZXQgdG8galF1ZXJ5IG9yIGRlZmF1bHQgdG8gdXMuCiAgICAgICAgaWYgKGpRdWVyeSkgewogICAgICAgICAgICBqcUxpdGUgPSBqUXVlcnk7CiAgICAgICAgICAgIGV4dGVuZChqUXVlcnkuZm4sIHsKICAgICAgICAgICAgICAgIHNjb3BlOiBKUUxpdGVQcm90b3R5cGUuc2NvcGUsCiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiBKUUxpdGVQcm90b3R5cGUuY29udHJvbGxlciwKICAgICAgICAgICAgICAgIGluamVjdG9yOiBKUUxpdGVQcm90b3R5cGUuaW5qZWN0b3IsCiAgICAgICAgICAgICAgICBpbmhlcml0ZWREYXRhOiBKUUxpdGVQcm90b3R5cGUuaW5oZXJpdGVkRGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gTWV0aG9kIHNpZ25hdHVyZTogSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUobmFtZSwgZGlzcGF0Y2hUaGlzLCBmaWx0ZXJFbGVtcywgZ2V0dGVySWZOb0FyZ3VtZW50cykKICAgICAgICAgICAgSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUoJ3JlbW92ZScsIHRydWUsIHRydWUsIGZhbHNlKTsKICAgICAgICAgICAgSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUoJ2VtcHR5JywgZmFsc2UsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdodG1sJywgZmFsc2UsIGZhbHNlLCB0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBqcUxpdGUgPSBKUUxpdGU7CiAgICAgICAgfQogICAgICAgIGFuZ3VsYXIuZWxlbWVudCA9IGpxTGl0ZTsKICAgIH0KCiAgICAvKioKICAgICAqIHRocm93IGVycm9yIGlmIHRoZSBhcmd1bWVudCBpcyBmYWxzeS4KICAgICAqLwogICAgZnVuY3Rpb24gYXNzZXJ0QXJnKGFyZywgbmFtZSwgcmVhc29uKSB7CiAgICAgICAgaWYgKCFhcmcpIHsKICAgICAgICAgICAgdGhyb3cgbmdNaW5FcnIoJ2FyZXEnLCAiQXJndW1lbnQgJ3swfScgaXMgezF9IiwgKG5hbWUgfHwgJz8nKSwgKHJlYXNvbiB8fCAicmVxdWlyZWQiKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcmc7CiAgICB9CgogICAgZnVuY3Rpb24gYXNzZXJ0QXJnRm4oYXJnLCBuYW1lLCBhY2NlcHRBcnJheUFubm90YXRpb24pIHsKICAgICAgICBpZiAoYWNjZXB0QXJyYXlBbm5vdGF0aW9uICYmIGlzQXJyYXkoYXJnKSkgewogICAgICAgICAgICBhcmcgPSBhcmdbYXJnLmxlbmd0aCAtIDFdOwogICAgICAgIH0KCiAgICAgICAgYXNzZXJ0QXJnKGlzRnVuY3Rpb24oYXJnKSwgbmFtZSwgJ25vdCBhIGZ1bmN0aW9uLCBnb3QgJyArCiAgICAgICAgICAgIChhcmcgJiYgdHlwZW9mIGFyZyA9PSAnb2JqZWN0JyA/IGFyZy5jb25zdHJ1Y3Rvci5uYW1lIHx8ICdPYmplY3QnIDogdHlwZW9mIGFyZykpOwogICAgICAgIHJldHVybiBhcmc7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIHZhbHVlIGFjY2Vzc2libGUgZnJvbSB0aGUgb2JqZWN0IGJ5IHBhdGguIEFueSB1bmRlZmluZWQgdHJhdmVyc2FscyBhcmUgaWdub3JlZAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iaiBzdGFydGluZyBvYmplY3QKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIHBhdGggdG8gdHJhdmVyc2UKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj10cnVlfSBiaW5kRm5Ub1Njb3BlCiAgICAgKiBAcmV0dXJucyB2YWx1ZSBhcyBhY2Nlc3NpYmxlIGJ5IHBhdGgKICAgICAqLwogICAgLy9UT0RPKG1pc2tvKTogdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSByZW1vdmVkCiAgICBmdW5jdGlvbiBnZXR0ZXIob2JqLCBwYXRoLCBiaW5kRm5Ub1Njb3BlKSB7CiAgICAgICAgaWYgKCFwYXRoKSByZXR1cm4gb2JqOwogICAgICAgIHZhciBrZXlzID0gcGF0aC5zcGxpdCgnLicpOwogICAgICAgIHZhciBrZXk7CiAgICAgICAgdmFyIGxhc3RJbnN0YW5jZSA9IG9iajsKICAgICAgICB2YXIgbGVuID0ga2V5cy5sZW5ndGg7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgICAgICAgb2JqID0gKGxhc3RJbnN0YW5jZSA9IG9iailba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWJpbmRGblRvU2NvcGUgJiYgaXNGdW5jdGlvbihvYmopKSB7CiAgICAgICAgICAgIHJldHVybiBiaW5kKGxhc3RJbnN0YW5jZSwgb2JqKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBpbnRlcmZhY2UKICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBJbnRlcmZhY2UgZm9yIGNvbmZpZ3VyaW5nIGFuZ3VsYXIge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZXN9LgogICAgICovCgogICAgZnVuY3Rpb24gc2V0dXBNb2R1bGVMb2FkZXIod2luZG93KSB7CgogICAgICAgIGZ1bmN0aW9uIGVuc3VyZShvYmosIG5hbWUsIGZhY3RvcnkpIHsKICAgICAgICAgICAgcmV0dXJuIG9ialtuYW1lXSB8fCAob2JqW25hbWVdID0gZmFjdG9yeSgpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbnN1cmUoZW5zdXJlKHdpbmRvdywgJ2FuZ3VsYXInLCBPYmplY3QpLCAnbW9kdWxlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvKiogQHR5cGUge09iamVjdC48c3RyaW5nLCBhbmd1bGFyLk1vZHVsZT59ICovCiAgICAgICAgICAgIHZhciBtb2R1bGVzID0ge307CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIubW9kdWxlCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGUgYGFuZ3VsYXIubW9kdWxlYCBpcyBhIGdsb2JhbCBwbGFjZSBmb3IgY3JlYXRpbmcsIHJlZ2lzdGVyaW5nIGFuZCByZXRyaWV2aW5nIEFuZ3VsYXIgbW9kdWxlcy4KICAgICAgICAgICAgICogQWxsIG1vZHVsZXMgKGFuZ3VsYXIgY29yZSBvciAzcmQgcGFydHkpIHRoYXQgc2hvdWxkIGJlIGF2YWlsYWJsZSB0byBhbiBhcHBsaWNhdGlvbiBtdXN0IGJlCiAgICAgICAgICAgICAqIHJlZ2lzdGVyZWQgdXNpbmcgdGhpcyBtZWNoYW5pc20uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFdoZW4gcGFzc2VkIHR3byBvciBtb3JlIGFyZ3VtZW50cywgYSBuZXcgbW9kdWxlIGlzIGNyZWF0ZWQuICBJZiBwYXNzZWQgb25seSBvbmUgYXJndW1lbnQsIGFuCiAgICAgICAgICAgICAqIGV4aXN0aW5nIG1vZHVsZSAodGhlIG5hbWUgcGFzc2VkIGFzIHRoZSBmaXJzdCBhcmd1bWVudCB0byBgbW9kdWxlYCkgaXMgcmV0cmlldmVkLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAjIE1vZHVsZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBBIG1vZHVsZSBpcyBhIGNvbGxlY3Rpb24gb2Ygc2VydmljZXMsIGRpcmVjdGl2ZXMsIGZpbHRlcnMsIGFuZCBjb25maWd1cmF0aW9uIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgKiBgYW5ndWxhci5tb2R1bGVgIGlzIHVzZWQgdG8gY29uZmlndXJlIHRoZSB7QGxpbmsgQVVUTy4kaW5qZWN0b3IgJGluamVjdG9yfS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICogLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZQogICAgICAgICAgICAgKiB2YXIgbXlNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnbXlNb2R1bGUnLCBbXSk7CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIC8vIHJlZ2lzdGVyIGEgbmV3IHNlcnZpY2UKICAgICAgICAgICAgICogbXlNb2R1bGUudmFsdWUoJ2FwcE5hbWUnLCAnTXlDb29sQXBwJyk7CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIC8vIGNvbmZpZ3VyZSBleGlzdGluZyBzZXJ2aWNlcyBpbnNpZGUgaW5pdGlhbGl6YXRpb24gYmxvY2tzLgogICAgICAgICAgICAgKiBteU1vZHVsZS5jb25maWcoZnVuY3Rpb24oJGxvY2F0aW9uUHJvdmlkZXIpIHsKICAgICAgICAgICAgICogICAvLyBDb25maWd1cmUgZXhpc3RpbmcgcHJvdmlkZXJzCiAgICAgICAgICAgICAqICAgJGxvY2F0aW9uUHJvdmlkZXIuaGFzaFByZWZpeCgnIScpOwogICAgICAgICAgICAgKiB9KTsKICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRoZW4geW91IGNhbiBjcmVhdGUgYW4gaW5qZWN0b3IgYW5kIGxvYWQgeW91ciBtb2R1bGVzIGxpa2UgdGhpczoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICogdmFyIGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcihbJ25nJywgJ015TW9kdWxlJ10pCiAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBIb3dldmVyIGl0J3MgbW9yZSBsaWtlbHkgdGhhdCB5b3UnbGwganVzdCB1c2UKICAgICAgICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0FwcCBuZ0FwcH0gb3IKICAgICAgICAgICAgICoge0BsaW5rIGFuZ3VsYXIuYm9vdHN0cmFwfSB0byBzaW1wbGlmeSB0aGlzIHByb2Nlc3MgZm9yIHlvdS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHshc3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBtb2R1bGUgdG8gY3JlYXRlIG9yIHJldHJpZXZlLgogICAgICAgICAgICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmc+PX0gcmVxdWlyZXMgSWYgc3BlY2lmaWVkIHRoZW4gbmV3IG1vZHVsZSBpcyBiZWluZyBjcmVhdGVkLiBJZiB1bnNwZWNpZmllZCB0aGVuIHRoZQogICAgICAgICAgICAgKiAgICAgICAgdGhlIG1vZHVsZSBpcyBiZWluZyByZXRyaWV2ZWQgZm9yIGZ1cnRoZXIgY29uZmlndXJhdGlvbi4KICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uZmlnRm4gT3B0aW9uYWwgY29uZmlndXJhdGlvbiBmdW5jdGlvbiBmb3IgdGhlIG1vZHVsZS4gU2FtZSBhcwogICAgICAgICAgICAgKiAgICAgICAge0BsaW5rIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZyBNb2R1bGUjY29uZmlnKCl9LgogICAgICAgICAgICAgKiBAcmV0dXJucyB7bW9kdWxlfSBuZXcgbW9kdWxlIHdpdGggdGhlIHtAbGluayBhbmd1bGFyLk1vZHVsZX0gYXBpLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIG1vZHVsZShuYW1lLCByZXF1aXJlcywgY29uZmlnRm4pIHsKICAgICAgICAgICAgICAgIGlmIChyZXF1aXJlcyAmJiBtb2R1bGVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgbW9kdWxlc1tuYW1lXSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZW5zdXJlKG1vZHVsZXMsIG5hbWUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXJlcXVpcmVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG1pbkVycignJGluamVjdG9yJykoJ25vbW9kJywgIk1vZHVsZSAnezB9JyBpcyBub3QgYXZhaWxhYmxlISBZb3UgZWl0aGVyIG1pc3NwZWxsZWQgdGhlIG1vZHVsZSBuYW1lICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm9yIGZvcmdvdCB0byBsb2FkIGl0LiBJZiByZWdpc3RlcmluZyBhIG1vZHVsZSBlbnN1cmUgdGhhdCB5b3Ugc3BlY2lmeSB0aGUgZGVwZW5kZW5jaWVzIGFzIHRoZSBzZWNvbmQgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYXJndW1lbnQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvKiogQHR5cGUgeyFBcnJheS48QXJyYXkuPCo+Pn0gKi8KICAgICAgICAgICAgICAgICAgICB2YXIgaW52b2tlUXVldWUgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgLyoqIEB0eXBlIHshQXJyYXkuPEZ1bmN0aW9uPn0gKi8KICAgICAgICAgICAgICAgICAgICB2YXIgcnVuQmxvY2tzID0gW107CgogICAgICAgICAgICAgICAgICAgIHZhciBjb25maWcgPSBpbnZva2VMYXRlcignJGluamVjdG9yJywgJ2ludm9rZScpOwoKICAgICAgICAgICAgICAgICAgICAvKiogQHR5cGUge2FuZ3VsYXIuTW9kdWxlfSAqLwogICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHJpdmF0ZSBzdGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfaW52b2tlUXVldWU6IGludm9rZVF1ZXVlLAogICAgICAgICAgICAgICAgICAgICAgICBfcnVuQmxvY2tzOiBydW5CbG9ja3MsCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3JlcXVpcmVzCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn0gTGlzdCBvZiBtb2R1bGUgbmFtZXMgd2hpY2ggbXVzdCBiZSBsb2FkZWQgYmVmb3JlIHRoaXMgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogSG9sZHMgdGhlIGxpc3Qgb2YgbW9kdWxlcyB3aGljaCB0aGUgaW5qZWN0b3Igd2lsbCBsb2FkIGJlZm9yZSB0aGUgY3VycmVudCBtb2R1bGUgaXMgbG9hZGVkLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZXM6IHJlcXVpcmVzLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE5hbWUgb2YgdGhlIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAoKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3Byb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJvdmlkZXJUeXBlIENvbnN0cnVjdGlvbiBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIHRoZSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI3Byb3ZpZGVyICRwcm92aWRlLnByb3ZpZGVyKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXI6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdwcm92aWRlcicpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmFjdG9yeQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByb3ZpZGVyRnVuY3Rpb24gRnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNmYWN0b3J5ICRwcm92aWRlLmZhY3RvcnkoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBmYWN0b3J5OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnZmFjdG9yeScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjc2VydmljZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY29uc3RydWN0b3IgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGluc3RhbnRpYXRlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNzZXJ2aWNlICRwcm92aWRlLnNlcnZpY2UoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnc2VydmljZScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyp9IG9iamVjdCBTZXJ2aWNlIGluc3RhbmNlIG9iamVjdC4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSN2YWx1ZSAkcHJvdmlkZS52YWx1ZSgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAndmFsdWUnKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnN0YW50CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBjb25zdGFudCBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IENvbnN0YW50IHZhbHVlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogQmVjYXVzZSB0aGUgY29uc3RhbnQgYXJlIGZpeGVkLCB0aGV5IGdldCBhcHBsaWVkIGJlZm9yZSBvdGhlciBwcm92aWRlIG1ldGhvZHMuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNjb25zdGFudCAkcHJvdmlkZS5jb25zdGFudCgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0YW50OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnY29uc3RhbnQnLCAndW5zaGlmdCcpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjYW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBhbmltYXRpb24gbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBhbmltYXRpb25GYWN0b3J5IEZhY3RvcnkgZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiBhbiBhbmltYXRpb24uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAgICAgKiAqKk5PVEUqKjogYW5pbWF0aW9ucyBhcmUgdGFrZSBlZmZlY3Qgb25seSBpZiB0aGUgKipuZ0FuaW1hdGUqKiBtb2R1bGUgaXMgbG9hZGVkLgogICAgICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBEZWZpbmVzIGFuIGFuaW1hdGlvbiBob29rIHRoYXQgY2FuIGJlIGxhdGVyIHVzZWQgd2l0aCB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlICRhbmltYXRlfSBzZXJ2aWNlIGFuZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBkaXJlY3RpdmVzIHRoYXQgdXNlIHRoaXMgc2VydmljZS4KICAgICAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgICAgICogbW9kdWxlLmFuaW1hdGlvbignLmFuaW1hdGlvbi1uYW1lJywgZnVuY3Rpb24oJGluamVjdDEsICRpbmplY3QyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAqICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICogICAgIGV2ZW50TmFtZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICogICAgICAgLy9jb2RlIHRvIHJ1biB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqICAgICAgIC8vb25jZSBjb21wbGV0ZSwgdGhlbiBydW4gZG9uZSgpCiAgICAgICAgICAgICAgICAgICAgICAgICAqICAgICAgIHJldHVybiBmdW5jdGlvbiBjYW5jZWxsYXRpb25GdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgLy9jb2RlIHRvIGNhbmNlbCB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICogICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICogICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAqIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nQW5pbWF0ZS4kYW5pbWF0ZVByb3ZpZGVyI3JlZ2lzdGVyICRhbmltYXRlUHJvdmlkZXIucmVnaXN0ZXIoKX0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZ0FuaW1hdGUgbmdBbmltYXRlIG1vZHVsZX0gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IGludm9rZUxhdGVyKCckYW5pbWF0ZVByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNmaWx0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEZpbHRlciBuYW1lLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmaWx0ZXJGYWN0b3J5IEZhY3RvcnkgZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiBmaWx0ZXIuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRmaWx0ZXJQcm92aWRlciNyZWdpc3RlciAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6IGludm9rZUxhdGVyKCckZmlsdGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnRyb2xsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIENvbnRyb2xsZXIgbmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQ29udHJvbGxlciBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGNvbnRyb2xsZXJQcm92aWRlciNyZWdpc3RlciAkY29udHJvbGxlclByb3ZpZGVyLnJlZ2lzdGVyKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjogaW52b2tlTGF0ZXIoJyRjb250cm9sbGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2RpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgZGlyZWN0aXZlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZGlyZWN0aXZlRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YKICAgICAgICAgICAgICAgICAgICAgICAgICogZGlyZWN0aXZlcy4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgJGNvbXBpbGVQcm92aWRlci5kaXJlY3RpdmUoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmU6IGludm9rZUxhdGVyKCckY29tcGlsZVByb3ZpZGVyJywgJ2RpcmVjdGl2ZScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29uZmlnCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25maWdGbiBFeGVjdXRlIHRoaXMgZnVuY3Rpb24gb24gbW9kdWxlIGxvYWQuIFVzZWZ1bCBmb3Igc2VydmljZQogICAgICAgICAgICAgICAgICAgICAgICAgKiAgICBjb25maWd1cmF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogVXNlIHRoaXMgbWV0aG9kIHRvIHJlZ2lzdGVyIHdvcmsgd2hpY2ggbmVlZHMgdG8gYmUgcGVyZm9ybWVkIG9uIG1vZHVsZSBsb2FkaW5nLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnOiBjb25maWcsCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNydW4KICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGluaXRpYWxpemF0aW9uRm4gRXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIGFmdGVyIGluamVjdG9yIGNyZWF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiAgICBVc2VmdWwgZm9yIGFwcGxpY2F0aW9uIGluaXRpYWxpemF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogVXNlIHRoaXMgbWV0aG9kIHRvIHJlZ2lzdGVyIHdvcmsgd2hpY2ggc2hvdWxkIGJlIHBlcmZvcm1lZCB3aGVuIHRoZSBpbmplY3RvciBpcyBkb25lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIGxvYWRpbmcgYWxsIG1vZHVsZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBydW46IGZ1bmN0aW9uIChibG9jaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2goYmxvY2spOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnKGNvbmZpZ0ZuKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBtb2R1bGVJbnN0YW5jZTsKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nPX0gaW5zZXJ0TWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2FuZ3VsYXIuTW9kdWxlfQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGludm9rZUxhdGVyKHByb3ZpZGVyLCBtZXRob2QsIGluc2VydE1ldGhvZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW52b2tlUXVldWVbaW5zZXJ0TWV0aG9kIHx8ICdwdXNoJ10oW3Byb3ZpZGVyLCBtZXRob2QsIGFyZ3VtZW50c10pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZUluc3RhbmNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSk7CgogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgKiBAbmFtZSBhbmd1bGFyLnZlcnNpb24KICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQW4gb2JqZWN0IHRoYXQgY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGN1cnJlbnQgQW5ndWxhckpTIHZlcnNpb24uIFRoaXMgb2JqZWN0IGhhcyB0aGUKICAgICAqIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICoKICAgICAqIC0gYGZ1bGxgIOKAkyBge3N0cmluZ31gIOKAkyBGdWxsIHZlcnNpb24gc3RyaW5nLCBzdWNoIGFzICIwLjkuMTgiLgogICAgICogLSBgbWFqb3JgIOKAkyBge251bWJlcn1gIOKAkyBNYWpvciB2ZXJzaW9uIG51bWJlciwgc3VjaCBhcyAiMCIuCiAgICAgKiAtIGBtaW5vcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1pbm9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICI5Ii4KICAgICAqIC0gYGRvdGAg4oCTIGB7bnVtYmVyfWAg4oCTIERvdCB2ZXJzaW9uIG51bWJlciwgc3VjaCBhcyAiMTgiLgogICAgICogLSBgY29kZU5hbWVgIOKAkyBge3N0cmluZ31gIOKAkyBDb2RlIG5hbWUgb2YgdGhlIHJlbGVhc2UsIHN1Y2ggYXMgImppZ2dsaW5nLWFybWZhdCIuCiAgICAgKi8KICAgIHZhciB2ZXJzaW9uID0gewogICAgICAgIGZ1bGw6ICcxLjIuMC1yYy4yJywgICAgLy8gYWxsIG9mIHRoZXNlIHBsYWNlaG9sZGVyIHN0cmluZ3Mgd2lsbCBiZSByZXBsYWNlZCBieSBncnVudCdzCiAgICAgICAgbWFqb3I6IDEsICAgIC8vIHBhY2thZ2UgdGFzawogICAgICAgIG1pbm9yOiAyLAogICAgICAgIGRvdDogMCwKICAgICAgICBjb2RlTmFtZTogJ2JhcmVoYW5kLWF0b21zcGxpdHRpbmcnCiAgICB9OwoKCiAgICBmdW5jdGlvbiBwdWJsaXNoRXh0ZXJuYWxBUEkoYW5ndWxhcikgewogICAgICAgIGV4dGVuZChhbmd1bGFyLCB7CiAgICAgICAgICAgICdib290c3RyYXAnOiBib290c3RyYXAsCiAgICAgICAgICAgICdjb3B5JzogY29weSwKICAgICAgICAgICAgJ2V4dGVuZCc6IGV4dGVuZCwKICAgICAgICAgICAgJ2VxdWFscyc6IGVxdWFscywKICAgICAgICAgICAgJ2VsZW1lbnQnOiBqcUxpdGUsCiAgICAgICAgICAgICdmb3JFYWNoJzogZm9yRWFjaCwKICAgICAgICAgICAgJ2luamVjdG9yJzogY3JlYXRlSW5qZWN0b3IsCiAgICAgICAgICAgICdub29wJzogbm9vcCwKICAgICAgICAgICAgJ2JpbmQnOiBiaW5kLAogICAgICAgICAgICAndG9Kc29uJzogdG9Kc29uLAogICAgICAgICAgICAnZnJvbUpzb24nOiBmcm9tSnNvbiwKICAgICAgICAgICAgJ2lkZW50aXR5JzogaWRlbnRpdHksCiAgICAgICAgICAgICdpc1VuZGVmaW5lZCc6IGlzVW5kZWZpbmVkLAogICAgICAgICAgICAnaXNEZWZpbmVkJzogaXNEZWZpbmVkLAogICAgICAgICAgICAnaXNTdHJpbmcnOiBpc1N0cmluZywKICAgICAgICAgICAgJ2lzRnVuY3Rpb24nOiBpc0Z1bmN0aW9uLAogICAgICAgICAgICAnaXNPYmplY3QnOiBpc09iamVjdCwKICAgICAgICAgICAgJ2lzTnVtYmVyJzogaXNOdW1iZXIsCiAgICAgICAgICAgICdpc0VsZW1lbnQnOiBpc0VsZW1lbnQsCiAgICAgICAgICAgICdpc0FycmF5JzogaXNBcnJheSwKICAgICAgICAgICAgJyQkbWluRXJyJzogbWluRXJyLAogICAgICAgICAgICAndmVyc2lvbic6IHZlcnNpb24sCiAgICAgICAgICAgICdpc0RhdGUnOiBpc0RhdGUsCiAgICAgICAgICAgICdsb3dlcmNhc2UnOiBsb3dlcmNhc2UsCiAgICAgICAgICAgICd1cHBlcmNhc2UnOiB1cHBlcmNhc2UsCiAgICAgICAgICAgICdjYWxsYmFja3MnOiB7IGNvdW50ZXI6IDAgfQogICAgICAgIH0pOwoKICAgICAgICBhbmd1bGFyTW9kdWxlID0gc2V0dXBNb2R1bGVMb2FkZXIod2luZG93KTsKICAgICAgICB0cnkgewogICAgICAgICAgICBhbmd1bGFyTW9kdWxlKCduZ0xvY2FsZScpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgYW5ndWxhck1vZHVsZSgnbmdMb2NhbGUnLCBbXSkucHJvdmlkZXIoJyRsb2NhbGUnLCAkTG9jYWxlUHJvdmlkZXIpOwogICAgICAgIH0KCiAgICAgICAgYW5ndWxhck1vZHVsZSgnbmcnLCBbJ25nTG9jYWxlJ10sIFsnJHByb3ZpZGUnLAogICAgICAgICAgZnVuY3Rpb24gbmdNb2R1bGUoJHByb3ZpZGUpIHsKICAgICAgICAgICAgICAkcHJvdmlkZS5wcm92aWRlcignJGNvbXBpbGUnLCAkQ29tcGlsZVByb3ZpZGVyKS4KICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSh7CiAgICAgICAgICAgICAgICAgICAgYTogaHRtbEFuY2hvckRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBpbnB1dDogaW5wdXREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgdGV4dGFyZWE6IGlucHV0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIGZvcm06IGZvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgc2NyaXB0OiBzY3JpcHREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0OiBzZWxlY3REaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbjogb3B0aW9uRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nQmluZDogbmdCaW5kRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nQmluZEh0bWw6IG5nQmluZEh0bWxEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdCaW5kVGVtcGxhdGU6IG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nQ2xhc3M6IG5nQ2xhc3NEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdDbGFzc0V2ZW46IG5nQ2xhc3NFdmVuRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nQ2xhc3NPZGQ6IG5nQ2xhc3NPZGREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdDc3A6IG5nQ3NwRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nQ2xvYWs6IG5nQ2xvYWtEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdDb250cm9sbGVyOiBuZ0NvbnRyb2xsZXJEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdGb3JtOiBuZ0Zvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdIaWRlOiBuZ0hpZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdJZjogbmdJZkRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ0luY2x1ZGU6IG5nSW5jbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ0luaXQ6IG5nSW5pdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ05vbkJpbmRhYmxlOiBuZ05vbkJpbmRhYmxlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nUGx1cmFsaXplOiBuZ1BsdXJhbGl6ZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ1JlcGVhdDogbmdSZXBlYXREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdTaG93OiBuZ1Nob3dEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdTdHlsZTogbmdTdHlsZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaDogbmdTd2l0Y2hEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdTd2l0Y2hXaGVuOiBuZ1N3aXRjaFdoZW5EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdTd2l0Y2hEZWZhdWx0OiBuZ1N3aXRjaERlZmF1bHREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdPcHRpb25zOiBuZ09wdGlvbnNEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdUcmFuc2NsdWRlOiBuZ1RyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbDogbmdNb2RlbERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ0xpc3Q6IG5nTGlzdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ0NoYW5nZTogbmdDaGFuZ2VEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nUmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nVmFsdWU6IG5nVmFsdWVEaXJlY3RpdmUKICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgZGlyZWN0aXZlKG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzKS4KICAgICAgICAgICAgICAgIGRpcmVjdGl2ZShuZ0V2ZW50RGlyZWN0aXZlcyk7CiAgICAgICAgICAgICAgJHByb3ZpZGUucHJvdmlkZXIoewogICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsOiAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICRhbmltYXRlOiAkQW5pbWF0ZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAkYnJvd3NlcjogJEJyb3dzZXJQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJGNhY2hlRmFjdG9yeTogJENhY2hlRmFjdG9yeVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAkY29udHJvbGxlcjogJENvbnRyb2xsZXJQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJGRvY3VtZW50OiAkRG9jdW1lbnRQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXI6ICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICRmaWx0ZXI6ICRGaWx0ZXJQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJGludGVycG9sYXRlOiAkSW50ZXJwb2xhdGVQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJGh0dHA6ICRIdHRwUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICRodHRwQmFja2VuZDogJEh0dHBCYWNrZW5kUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICRsb2NhdGlvbjogJExvY2F0aW9uUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICRsb2c6ICRMb2dQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJHBhcnNlOiAkUGFyc2VQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZTogJFJvb3RTY29wZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAkcTogJFFQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJHNjZTogJFNjZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAkc2NlRGVsZWdhdGU6ICRTY2VEZWxlZ2F0ZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAkc25pZmZlcjogJFNuaWZmZXJQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlQ2FjaGU6ICRUZW1wbGF0ZUNhY2hlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICR0aW1lb3V0OiAkVGltZW91dFByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAkd2luZG93OiAkV2luZG93UHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICQkdXJsVXRpbHM6ICQkVXJsVXRpbHNQcm92aWRlcgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIF0pOwogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vSlFMaXRlCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZWxlbWVudAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBXcmFwcyBhIHJhdyBET00gZWxlbWVudCBvciBIVE1MIHN0cmluZyBhcyBhIFtqUXVlcnldKGh0dHA6Ly9qcXVlcnkuY29tKSBlbGVtZW50LgogICAgICogYGFuZ3VsYXIuZWxlbWVudGAgY2FuIGJlIGVpdGhlciBhbiBhbGlhcyBmb3IgW2pRdWVyeV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS8pIGZ1bmN0aW9uLCBpZgogICAgICogalF1ZXJ5IGlzIGF2YWlsYWJsZSwgb3IgYSBmdW5jdGlvbiB0aGF0IHdyYXBzIHRoZSBlbGVtZW50IG9yIHN0cmluZyBpbiBBbmd1bGFyJ3MgalF1ZXJ5IGxpdGUKICAgICAqIGltcGxlbWVudGF0aW9uIChjb21tb25seSByZWZlcnJlZCB0byBhcyBqcUxpdGUpLgogICAgICoKICAgICAqIFJlYWwgalF1ZXJ5IGFsd2F5cyB0YWtlcyBwcmVjZWRlbmNlIG92ZXIganFMaXRlLCBwcm92aWRlZCBpdCB3YXMgbG9hZGVkIGJlZm9yZSBgRE9NQ29udGVudExvYWRlZGAKICAgICAqIGV2ZW50IGZpcmVkLgogICAgICoKICAgICAqIGpxTGl0ZSBpcyBhIHRpbnksIEFQSS1jb21wYXRpYmxlIHN1YnNldCBvZiBqUXVlcnkgdGhhdCBhbGxvd3MKICAgICAqIEFuZ3VsYXIgdG8gbWFuaXB1bGF0ZSB0aGUgRE9NLiBqcUxpdGUgaW1wbGVtZW50cyBvbmx5IHRoZSBtb3N0IGNvbW1vbmx5IG5lZWRlZCBmdW5jdGlvbmFsaXR5CiAgICAgKiB3aXRoaW4gYSB2ZXJ5IHNtYWxsIGZvb3RwcmludCwgc28gb25seSBhIHN1YnNldCBvZiB0aGUgalF1ZXJ5IEFQSSAtIG1ldGhvZHMsIGFyZ3VtZW50cyBhbmQKICAgICAqIGludm9jYXRpb24gc3R5bGVzIC0gYXJlIHN1cHBvcnRlZC4KICAgICAqCiAgICAgKiBOb3RlOiBBbGwgZWxlbWVudCByZWZlcmVuY2VzIGluIEFuZ3VsYXIgYXJlIGFsd2F5cyB3cmFwcGVkIHdpdGggalF1ZXJ5IG9yIGpxTGl0ZTsgdGhleSBhcmUgbmV2ZXIKICAgICAqIHJhdyBET00gcmVmZXJlbmNlcy4KICAgICAqCiAgICAgKiAjIyBBbmd1bGFyJ3MganFMaXRlCiAgICAgKiBBbmd1bGFyJ3MgbGl0ZSB2ZXJzaW9uIG9mIGpRdWVyeSBwcm92aWRlcyBvbmx5IHRoZSBmb2xsb3dpbmcgalF1ZXJ5IG1ldGhvZHM6CiAgICAgKgogICAgICogLSBbYWRkQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FkZENsYXNzLykKICAgICAqIC0gW2FmdGVyKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hZnRlci8pCiAgICAgKiAtIFthcHBlbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FwcGVuZC8pCiAgICAgKiAtIFthdHRyKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hdHRyLykKICAgICAqIC0gW2JpbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29uLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMsIHNlbGVjdG9ycyBvciBldmVudERhdGEKICAgICAqIC0gW2NoaWxkcmVuKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jaGlsZHJlbi8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICAgICAqIC0gW2Nsb25lKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jbG9uZS8pCiAgICAgKiAtIFtjb250ZW50cygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY29udGVudHMvKQogICAgICogLSBbY3NzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jc3MvKQogICAgICogLSBbZGF0YSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZGF0YS8pCiAgICAgKiAtIFtlcSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZXEvKQogICAgICogLSBbZmluZCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZmluZC8pIC0gTGltaXRlZCB0byBsb29rdXBzIGJ5IHRhZyBuYW1lCiAgICAgKiAtIFtoYXNDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaGFzQ2xhc3MvKQogICAgICogLSBbaHRtbCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaHRtbC8pCiAgICAgKiAtIFtuZXh0KCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9uZXh0LykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogICAgICogLSBbb24oKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29uLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMsIHNlbGVjdG9ycyBvciBldmVudERhdGEKICAgICAqIC0gW29mZigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vb2ZmLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMgb3Igc2VsZWN0b3JzCiAgICAgKiAtIFtwYXJlbnQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3BhcmVudC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICAgICAqIC0gW3ByZXBlbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ByZXBlbmQvKQogICAgICogLSBbcHJvcCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcHJvcC8pCiAgICAgKiAtIFtyZWFkeSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVhZHkvKQogICAgICogLSBbcmVtb3ZlKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmUvKQogICAgICogLSBbcmVtb3ZlQXR0cigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQXR0ci8pCiAgICAgKiAtIFtyZW1vdmVDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQ2xhc3MvKQogICAgICogLSBbcmVtb3ZlRGF0YSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlRGF0YS8pCiAgICAgKiAtIFtyZXBsYWNlV2l0aCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVwbGFjZVdpdGgvKQogICAgICogLSBbdGV4dCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdGV4dC8pCiAgICAgKiAtIFt0b2dnbGVDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdG9nZ2xlQ2xhc3MvKQogICAgICogLSBbdHJpZ2dlckhhbmRsZXIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RyaWdnZXJIYW5kbGVyLykgLSBQYXNzZXMgYSBkdW1teSBldmVudCBvYmplY3QgdG8gaGFuZGxlcnMuCiAgICAgKiAtIFt1bmJpbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29mZi8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzCiAgICAgKiAtIFt2YWwoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ZhbC8pCiAgICAgKiAtIFt3cmFwKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS93cmFwLykKICAgICAqCiAgICAgKiAjIyBqUXVlcnkvanFMaXRlIEV4dHJhcwogICAgICogQW5ndWxhciBhbHNvIHByb3ZpZGVzIHRoZSBmb2xsb3dpbmcgYWRkaXRpb25hbCBtZXRob2RzIGFuZCBldmVudHMgdG8gYm90aCBqUXVlcnkgYW5kIGpxTGl0ZToKICAgICAqCiAgICAgKiAjIyMgRXZlbnRzCiAgICAgKiAtIGAkZGVzdHJveWAgLSBBbmd1bGFySlMgaW50ZXJjZXB0cyBhbGwganFMaXRlL2pRdWVyeSdzIERPTSBkZXN0cnVjdGlvbiBhcGlzIGFuZCBmaXJlcyB0aGlzIGV2ZW50CiAgICAgKiAgICBvbiBhbGwgRE9NIG5vZGVzIGJlaW5nIHJlbW92ZWQuICBUaGlzIGNhbiBiZSB1c2VkIHRvIGNsZWFuIHVwIGFuZCAzcmQgcGFydHkgYmluZGluZ3MgdG8gdGhlIERPTQogICAgICogICAgZWxlbWVudCBiZWZvcmUgaXQgaXMgcmVtb3ZlZC4KICAgICAqICMjIyBNZXRob2RzCiAgICAgKiAtIGBjb250cm9sbGVyKG5hbWUpYCAtIHJldHJpZXZlcyB0aGUgY29udHJvbGxlciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuIEJ5IGRlZmF1bHQKICAgICAqICAgcmV0cmlldmVzIGNvbnRyb2xsZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUuIElmIGBuYW1lYCBpcyBwcm92aWRlZCBhcwogICAgICogICBjYW1lbENhc2UgZGlyZWN0aXZlIG5hbWUsIHRoZW4gdGhlIGNvbnRyb2xsZXIgZm9yIHRoaXMgZGlyZWN0aXZlIHdpbGwgYmUgcmV0cmlldmVkIChlLmcuCiAgICAgKiAgIGAnbmdNb2RlbCdgKS4KICAgICAqIC0gYGluamVjdG9yKClgIC0gcmV0cmlldmVzIHRoZSBpbmplY3RvciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBzY29wZSgpYCAtIHJldHJpZXZlcyB0aGUge0BsaW5rIGFwaS9uZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBvZiB0aGUgY3VycmVudAogICAgICogICBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBpbmhlcml0ZWREYXRhKClgIC0gc2FtZSBhcyBgZGF0YSgpYCwgYnV0IHdhbGtzIHVwIHRoZSBET00gdW50aWwgYSB2YWx1ZSBpcyBmb3VuZCBvciB0aGUgdG9wCiAgICAgKiAgIHBhcmVudCBlbGVtZW50IGlzIHJlYWNoZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBIVE1MIHN0cmluZyBvciBET01FbGVtZW50IHRvIGJlIHdyYXBwZWQgaW50byBqUXVlcnkuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBqUXVlcnkgb2JqZWN0LgogICAgICovCgogICAgdmFyIGpxQ2FjaGUgPSBKUUxpdGUuY2FjaGUgPSB7fSwKICAgICAgICBqcU5hbWUgPSBKUUxpdGUuZXhwYW5kbyA9ICduZy0nICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAganFJZCA9IDEsCiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyCiAgICAgICAgICA/IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgeyBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsgfQogICAgICAgICAgOiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4pIHsgZWxlbWVudC5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOyB9KSwKICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4gPSAod2luZG93LmRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIKICAgICAgICAgID8gZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7IGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOyB9CiAgICAgICAgICA6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgeyBlbGVtZW50LmRldGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7IH0pOwoKICAgIGZ1bmN0aW9uIGpxTmV4dElkKCkgeyByZXR1cm4gKytqcUlkOyB9CgoKICAgIHZhciBTUEVDSUFMX0NIQVJTX1JFR0VYUCA9IC8oW1w6XC1cX10rKC4pKS9nOwogICAgdmFyIE1PWl9IQUNLX1JFR0VYUCA9IC9ebW96KFtBLVpdKS87CiAgICB2YXIganFMaXRlTWluRXJyID0gbWluRXJyKCdqcUxpdGUnKTsKCiAgICAvKioKICAgICAqIENvbnZlcnRzIHNuYWtlX2Nhc2UgdG8gY2FtZWxDYXNlLgogICAgICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICAgICAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNhbWVsQ2FzZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIG5hbWUuCiAgICAgICAgICByZXBsYWNlKFNQRUNJQUxfQ0hBUlNfUkVHRVhQLCBmdW5jdGlvbiAoXywgc2VwYXJhdG9yLCBsZXR0ZXIsIG9mZnNldCkgewogICAgICAgICAgICAgIHJldHVybiBvZmZzZXQgPyBsZXR0ZXIudG9VcHBlckNhc2UoKSA6IGxldHRlcjsKICAgICAgICAgIH0pLgogICAgICAgICAgcmVwbGFjZShNT1pfSEFDS19SRUdFWFAsICdNb3okMScpOwogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8galF1ZXJ5IG11dGF0aW9uIHBhdGNoCiAgICAvLwogICAgLy8gSW4gY29uanVuY3Rpb24gd2l0aCBiaW5kSlF1ZXJ5IGludGVyY2VwdHMgYWxsIGpRdWVyeSdzIERPTSBkZXN0cnVjdGlvbiBhcGlzIGFuZCBmaXJlcyBhCiAgICAvLyAkZGVzdHJveSBldmVudCBvbiBhbGwgRE9NIG5vZGVzIGJlaW5nIHJlbW92ZWQuCiAgICAvLwogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUobmFtZSwgZGlzcGF0Y2hUaGlzLCBmaWx0ZXJFbGVtcywgZ2V0dGVySWZOb0FyZ3VtZW50cykgewogICAgICAgIHZhciBvcmlnaW5hbEpxRm4gPSBqUXVlcnkuZm5bbmFtZV07CiAgICAgICAgb3JpZ2luYWxKcUZuID0gb3JpZ2luYWxKcUZuLiRvcmlnaW5hbCB8fCBvcmlnaW5hbEpxRm47CiAgICAgICAgcmVtb3ZlUGF0Y2guJG9yaWdpbmFsID0gb3JpZ2luYWxKcUZuOwogICAgICAgIGpRdWVyeS5mbltuYW1lXSA9IHJlbW92ZVBhdGNoOwoKICAgICAgICBmdW5jdGlvbiByZW1vdmVQYXRjaChwYXJhbSkgewogICAgICAgICAgICB2YXIgbGlzdCA9IGZpbHRlckVsZW1zICYmIHBhcmFtID8gW3RoaXMuZmlsdGVyKHBhcmFtKV0gOiBbdGhpc10sCiAgICAgICAgICAgICAgICBmaXJlRXZlbnQgPSBkaXNwYXRjaFRoaXMsCiAgICAgICAgICAgICAgICBzZXQsIHNldEluZGV4LCBzZXRMZW5ndGgsCiAgICAgICAgICAgICAgICBlbGVtZW50LCBjaGlsZEluZGV4LCBjaGlsZExlbmd0aCwgY2hpbGRyZW47CgogICAgICAgICAgICBpZiAoIWdldHRlcklmTm9Bcmd1bWVudHMgfHwgcGFyYW0gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgd2hpbGUgKGxpc3QubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0ID0gbGlzdC5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIGZvciAoc2V0SW5kZXggPSAwLCBzZXRMZW5ndGggPSBzZXQubGVuZ3RoOyBzZXRJbmRleCA8IHNldExlbmd0aDsgc2V0SW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKHNldFtzZXRJbmRleF0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlyZUV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnRyaWdnZXJIYW5kbGVyKCckZGVzdHJveScpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyZUV2ZW50ID0gIWZpcmVFdmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNoaWxkSW5kZXggPSAwLCBjaGlsZExlbmd0aCA9IChjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGRyZW4oKSkubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRJbmRleCA8IGNoaWxkTGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0LnB1c2goalF1ZXJ5KGNoaWxkcmVuW2NoaWxkSW5kZXhdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsSnFGbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIGZ1bmN0aW9uIEpRTGl0ZShlbGVtZW50KSB7CiAgICAgICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBKUUxpdGUpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBKUUxpdGUpKSB7CiAgICAgICAgICAgIGlmIChpc1N0cmluZyhlbGVtZW50KSAmJiBlbGVtZW50LmNoYXJBdCgwKSAhPSAnPCcpIHsKICAgICAgICAgICAgICAgIHRocm93IGpxTGl0ZU1pbkVycignbm9zZWwnLCAnTG9va2luZyB1cCBlbGVtZW50cyB2aWEgc2VsZWN0b3JzIGlzIG5vdCBzdXBwb3J0ZWQgYnkganFMaXRlISBTZWU6IGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL2FuZ3VsYXIuZWxlbWVudCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgSlFMaXRlKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpKSB7CiAgICAgICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgLy8gUmVhZCBhYm91dCB0aGUgTm9TY29wZSBlbGVtZW50cyBoZXJlOgogICAgICAgICAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzM4OTcoVlMuODUpLmFzcHgKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8ZGl2PiYjMTYwOzwvZGl2PicgKyBlbGVtZW50OyAvLyBJRSBpbnNhbml0eSB0byBtYWtlIE5vU2NvcGUgZWxlbWVudHMgd29yayEKICAgICAgICAgICAgZGl2LnJlbW92ZUNoaWxkKGRpdi5maXJzdENoaWxkKTsgLy8gcmVtb3ZlIHRoZSBzdXBlcmZsdW91cyBkaXYKICAgICAgICAgICAgSlFMaXRlQWRkTm9kZXModGhpcywgZGl2LmNoaWxkTm9kZXMpOwogICAgICAgICAgICB2YXIgZnJhZ21lbnQgPSBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpKTsKICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kKHRoaXMpOyAvLyBkZXRhY2ggdGhlIGVsZW1lbnRzIGZyb20gdGhlIHRlbXBvcmFyeSBET00gZGl2LgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIEpRTGl0ZUFkZE5vZGVzKHRoaXMsIGVsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVDbG9uZShlbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnQuY2xvbmVOb2RlKHRydWUpOwogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZURlYWxvYyhlbGVtZW50KSB7CiAgICAgICAgSlFMaXRlUmVtb3ZlRGF0YShlbGVtZW50KTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkTm9kZXMgfHwgW107IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBKUUxpdGVEZWFsb2MoY2hpbGRyZW5baV0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVPZmYoZWxlbWVudCwgdHlwZSwgZm4sIHVuc3VwcG9ydGVkKSB7CiAgICAgICAgaWYgKGlzRGVmaW5lZCh1bnN1cHBvcnRlZCkpIHRocm93IGpxTGl0ZU1pbkVycignb2ZmYXJncycsICdqcUxpdGUjb2ZmKCkgZG9lcyBub3Qgc3VwcG9ydCB0aGUgYHNlbGVjdG9yYCBhcmd1bWVudCcpOwoKICAgICAgICB2YXIgZXZlbnRzID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSwKICAgICAgICAgICAgaGFuZGxlID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgICAgICAgaWYgKCFoYW5kbGUpIHJldHVybjsgLy9ubyBsaXN0ZW5lcnMgcmVnaXN0ZXJlZAoKICAgICAgICBpZiAoaXNVbmRlZmluZWQodHlwZSkpIHsKICAgICAgICAgICAgZm9yRWFjaChldmVudHMsIGZ1bmN0aW9uIChldmVudEhhbmRsZXIsIHR5cGUpIHsKICAgICAgICAgICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBldmVudEhhbmRsZXIpOwogICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50c1t0eXBlXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yRWFjaCh0eXBlLnNwbGl0KCcgJyksIGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoZm4pKSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGV2ZW50c1t0eXBlXSk7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50c1t0eXBlXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUoZXZlbnRzW3R5cGVdIHx8IFtdLCBmbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQsIG5hbWUpIHsKICAgICAgICB2YXIgZXhwYW5kb0lkID0gZWxlbWVudFtqcU5hbWVdLAogICAgICAgICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF07CgogICAgICAgIGlmIChleHBhbmRvU3RvcmUpIHsKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBqcUNhY2hlW2V4cGFuZG9JZF0uZGF0YVtuYW1lXTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGV4cGFuZG9TdG9yZS5oYW5kbGUpIHsKICAgICAgICAgICAgICAgIGV4cGFuZG9TdG9yZS5ldmVudHMuJGRlc3Ryb3kgJiYgZXhwYW5kb1N0b3JlLmhhbmRsZSh7fSwgJyRkZXN0cm95Jyk7CiAgICAgICAgICAgICAgICBKUUxpdGVPZmYoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIGpxQ2FjaGVbZXhwYW5kb0lkXTsKICAgICAgICAgICAgZWxlbWVudFtqcU5hbWVdID0gdW5kZWZpbmVkOyAvLyBpZSBkb2VzIG5vdCBhbGxvdyBkZWxldGlvbiBvZiBhdHRyaWJ1dGVzIG9uIGVsZW1lbnRzLgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBleHBhbmRvSWQgPSBlbGVtZW50W2pxTmFtZV0sCiAgICAgICAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkIHx8IC0xXTsKCiAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgaWYgKCFleHBhbmRvU3RvcmUpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRbanFOYW1lXSA9IGV4cGFuZG9JZCA9IGpxTmV4dElkKCk7CiAgICAgICAgICAgICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF0gPSB7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHBhbmRvU3RvcmVba2V5XSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBleHBhbmRvU3RvcmUgJiYgZXhwYW5kb1N0b3JlW2tleV07CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZURhdGEoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBkYXRhID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdkYXRhJyksCiAgICAgICAgICAgIGlzU2V0dGVyID0gaXNEZWZpbmVkKHZhbHVlKSwKICAgICAgICAgICAga2V5RGVmaW5lZCA9ICFpc1NldHRlciAmJiBpc0RlZmluZWQoa2V5KSwKICAgICAgICAgICAgaXNTaW1wbGVHZXR0ZXIgPSBrZXlEZWZpbmVkICYmICFpc09iamVjdChrZXkpOwoKICAgICAgICBpZiAoIWRhdGEgJiYgIWlzU2ltcGxlR2V0dGVyKSB7CiAgICAgICAgICAgIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZGF0YScsIGRhdGEgPSB7fSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNTZXR0ZXIpIHsKICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGtleURlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmIChpc1NpbXBsZUdldHRlcikgewogICAgICAgICAgICAgICAgICAgIC8vIGRvbid0IGNyZWF0ZSBkYXRhIGluIHRoaXMgY2FzZS4KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YSAmJiBkYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGV4dGVuZChkYXRhLCBrZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgICByZXR1cm4gKCgiICIgKyBlbGVtZW50LmNsYXNzTmFtZSArICIgIikucmVwbGFjZSgvW1xuXHRdL2csICIgIikuCiAgICAgICAgICAgIGluZGV4T2YoIiAiICsgc2VsZWN0b3IgKyAiICIpID4gLTEpOwogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZVJlbW92ZUNsYXNzKGVsZW1lbnQsIGNzc0NsYXNzZXMpIHsKICAgICAgICBpZiAoY3NzQ2xhc3NlcykgewogICAgICAgICAgICBmb3JFYWNoKGNzc0NsYXNzZXMuc3BsaXQoJyAnKSwgZnVuY3Rpb24gKGNzc0NsYXNzKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IHRyaW0oCiAgICAgICAgICAgICAgICAgICAgKCIgIiArIGVsZW1lbnQuY2xhc3NOYW1lICsgIiAiKQogICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKQogICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKCIgIiArIHRyaW0oY3NzQ2xhc3MpICsgIiAiLCAiICIpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlQWRkQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3NlcykgewogICAgICAgIGlmIChjc3NDbGFzc2VzKSB7CiAgICAgICAgICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbiAoY3NzQ2xhc3MpIHsKICAgICAgICAgICAgICAgIGlmICghSlFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3MpKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSB0cmltKGVsZW1lbnQuY2xhc3NOYW1lICsgJyAnICsgdHJpbShjc3NDbGFzcykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlQWRkTm9kZXMocm9vdCwgZWxlbWVudHMpIHsKICAgICAgICBpZiAoZWxlbWVudHMpIHsKICAgICAgICAgICAgZWxlbWVudHMgPSAoIWVsZW1lbnRzLm5vZGVOYW1lICYmIGlzRGVmaW5lZChlbGVtZW50cy5sZW5ndGgpICYmICFpc1dpbmRvdyhlbGVtZW50cykpCiAgICAgICAgICAgICAgPyBlbGVtZW50cwogICAgICAgICAgICAgIDogW2VsZW1lbnRzXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgcm9vdC5wdXNoKGVsZW1lbnRzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVDb250cm9sbGVyKGVsZW1lbnQsIG5hbWUpIHsKICAgICAgICByZXR1cm4gSlFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCAnJCcgKyAobmFtZSB8fCAnbmdDb250cm9sbGVyJykgKyAnQ29udHJvbGxlcicpOwogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwoKICAgICAgICAvLyBpZiBlbGVtZW50IGlzIHRoZSBkb2N1bWVudCBvYmplY3Qgd29yayB3aXRoIHRoZSBodG1sIGVsZW1lbnQgaW5zdGVhZAogICAgICAgIC8vIHRoaXMgbWFrZXMgJChkb2N1bWVudCkuc2NvcGUoKSBwb3NzaWJsZQogICAgICAgIGlmIChlbGVtZW50WzBdLm5vZGVUeXBlID09IDkpIHsKICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQuZmluZCgnaHRtbCcpOwogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKGVsZW1lbnQubGVuZ3RoKSB7CiAgICAgICAgICAgIGlmICgodmFsdWUgPSBlbGVtZW50LmRhdGEobmFtZSkpICE9PSB1bmRlZmluZWQpIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50KCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8gRnVuY3Rpb25zIHdoaWNoIGFyZSBkZWNsYXJlZCBkaXJlY3RseS4KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgdmFyIEpRTGl0ZVByb3RvdHlwZSA9IEpRTGl0ZS5wcm90b3R5cGUgPSB7CiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICB2YXIgZmlyZWQgPSBmYWxzZTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIHRyaWdnZXIoKSB7CiAgICAgICAgICAgICAgICBpZiAoZmlyZWQpIHJldHVybjsKICAgICAgICAgICAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNoZWNrIGlmIGRvY3VtZW50IGFscmVhZHkgaXMgbG9hZGVkCiAgICAgICAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHRyaWdnZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5vbignRE9NQ29udGVudExvYWRlZCcsIHRyaWdnZXIpOyAvLyB3b3JrcyBmb3IgbW9kZXJuIGJyb3dzZXJzIGFuZCBJRTkKICAgICAgICAgICAgICAgIC8vIHdlIGNhbiBub3QgdXNlIGpxTGl0ZSBzaW5jZSB3ZSBhcmUgbm90IGRvbmUgbG9hZGluZyBhbmQgalF1ZXJ5IGNvdWxkIGJlIGxvYWRlZCBsYXRlci4KICAgICAgICAgICAgICAgIEpRTGl0ZSh3aW5kb3cpLm9uKCdsb2FkJywgdHJpZ2dlcik7IC8vIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQgZm9yIG90aGVycwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBbXTsKICAgICAgICAgICAgZm9yRWFjaCh0aGlzLCBmdW5jdGlvbiAoZSkgeyB2YWx1ZS5wdXNoKCcnICsgZSk7IH0pOwogICAgICAgICAgICByZXR1cm4gJ1snICsgdmFsdWUuam9pbignLCAnKSArICddJzsKICAgICAgICB9LAoKICAgICAgICBlcTogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgICAgIHJldHVybiAoaW5kZXggPj0gMCkgPyBqcUxpdGUodGhpc1tpbmRleF0pIDoganFMaXRlKHRoaXNbdGhpcy5sZW5ndGggKyBpbmRleF0pOwogICAgICAgIH0sCgogICAgICAgIGxlbmd0aDogMCwKICAgICAgICBwdXNoOiBwdXNoLAogICAgICAgIHNvcnQ6IFtdLnNvcnQsCiAgICAgICAgc3BsaWNlOiBbXS5zcGxpY2UKICAgIH07CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBGdW5jdGlvbnMgaXRlcmF0aW5nIGdldHRlci9zZXR0ZXJzLgogICAgLy8gdGhlc2UgZnVuY3Rpb25zIHJldHVybiBzZWxmIG9uIHNldHRlciBhbmQKICAgIC8vIHZhbHVlIG9uIGdldC4KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgdmFyIEJPT0xFQU5fQVRUUiA9IHt9OwogICAgZm9yRWFjaCgnbXVsdGlwbGUsc2VsZWN0ZWQsY2hlY2tlZCxkaXNhYmxlZCxyZWFkT25seSxyZXF1aXJlZCxvcGVuJy5zcGxpdCgnLCcpLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBCT09MRUFOX0FUVFJbbG93ZXJjYXNlKHZhbHVlKV0gPSB2YWx1ZTsKICAgIH0pOwogICAgdmFyIEJPT0xFQU5fRUxFTUVOVFMgPSB7fTsKICAgIGZvckVhY2goJ2lucHV0LHNlbGVjdCxvcHRpb24sdGV4dGFyZWEsYnV0dG9uLGZvcm0sZGV0YWlscycuc3BsaXQoJywnKSwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgQk9PTEVBTl9FTEVNRU5UU1t1cHBlcmNhc2UodmFsdWUpXSA9IHRydWU7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBnZXRCb29sZWFuQXR0ck5hbWUoZWxlbWVudCwgbmFtZSkgewogICAgICAgIC8vIGNoZWNrIGRvbSBsYXN0IHNpbmNlIHdlIHdpbGwgbW9zdCBsaWtlbHkgZmFpbCBvbiBuYW1lCiAgICAgICAgdmFyIGJvb2xlYW5BdHRyID0gQk9PTEVBTl9BVFRSW25hbWUudG9Mb3dlckNhc2UoKV07CgogICAgICAgIC8vIGJvb2xlYW5BdHRyIGlzIGhlcmUgdHdpY2UgdG8gbWluaW1pemUgRE9NIGFjY2VzcwogICAgICAgIHJldHVybiBib29sZWFuQXR0ciAmJiBCT09MRUFOX0VMRU1FTlRTW2VsZW1lbnQubm9kZU5hbWVdICYmIGJvb2xlYW5BdHRyOwogICAgfQoKICAgIGZvckVhY2goewogICAgICAgIGRhdGE6IEpRTGl0ZURhdGEsCiAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlSW5oZXJpdGVkRGF0YSwKCiAgICAgICAgc2NvcGU6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBKUUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckc2NvcGUnKTsKICAgICAgICB9LAoKICAgICAgICBjb250cm9sbGVyOiBKUUxpdGVDb250cm9sbGVyLAoKICAgICAgICBpbmplY3RvcjogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgJyRpbmplY3RvcicpOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uIChlbGVtZW50LCBuYW1lKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgICAgIH0sCgogICAgICAgIGhhc0NsYXNzOiBKUUxpdGVIYXNDbGFzcywKCiAgICAgICAgY3NzOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgbmFtZSA9IGNhbWVsQ2FzZShuYW1lKTsKCiAgICAgICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsOwoKICAgICAgICAgICAgICAgIGlmIChtc2llIDw9IDgpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIHNvbWUgSUUgc3BlY2lmaWMgd2VpcmRuZXNzIHRoYXQgalF1ZXJ5IDEuNi40IGRvZXMgbm90IHN1cmUgd2h5CiAgICAgICAgICAgICAgICAgICAgdmFsID0gZWxlbWVudC5jdXJyZW50U3R5bGUgJiYgZWxlbWVudC5jdXJyZW50U3R5bGVbbmFtZV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gJycpIHZhbCA9ICdhdXRvJzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YWwgPSB2YWwgfHwgZWxlbWVudC5zdHlsZVtuYW1lXTsKCiAgICAgICAgICAgICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgICAgICAgICAgICAgLy8ganF1ZXJ5IHdlaXJkbmVzcyA6LS8KICAgICAgICAgICAgICAgICAgICB2YWwgPSAodmFsID09PSAnJykgPyB1bmRlZmluZWQgOiB2YWw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGF0dHI6IGZ1bmN0aW9uIChlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgbG93ZXJjYXNlZE5hbWUgPSBsb3dlcmNhc2UobmFtZSk7CiAgICAgICAgICAgIGlmIChCT09MRUFOX0FUVFJbbG93ZXJjYXNlZE5hbWVdKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIGlmICghIXZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCBsb3dlcmNhc2VkTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFtuYW1lXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShsb3dlcmNhc2VkTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGVsZW1lbnRbbmFtZV0gfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZWxlbWVudC5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbShuYW1lKSB8fCBub29wKS5zcGVjaWZpZWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgID8gbG93ZXJjYXNlZE5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKSB7CiAgICAgICAgICAgICAgICAvLyB0aGUgZXh0cmEgYXJndW1lbnQgIjIiIGlzIHRvIGdldCB0aGUgcmlnaHQgdGhpbmcgZm9yIGEuaHJlZiBpbiBJRSwgc2VlIGpRdWVyeSBjb2RlCiAgICAgICAgICAgICAgICAvLyBzb21lIGVsZW1lbnRzIChlLmcuIERvY3VtZW50KSBkb24ndCBoYXZlIGdldCBhdHRyaWJ1dGUsIHNvIHJldHVybiB1bmRlZmluZWQKICAgICAgICAgICAgICAgIHZhciByZXQgPSBlbGVtZW50LmdldEF0dHJpYnV0ZShuYW1lLCAyKTsKICAgICAgICAgICAgICAgIC8vIG5vcm1hbGl6ZSBub24tZXhpc3RpbmcgYXR0cmlidXRlcyB0byB1bmRlZmluZWQgKGFzIGpRdWVyeSkKICAgICAgICAgICAgICAgIHJldHVybiByZXQgPT09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBwcm9wOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50W25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgdGV4dDogKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIE5PREVfVFlQRV9URVhUX1BST1BFUlRZID0gW107CiAgICAgICAgICAgIGlmIChtc2llIDwgOSkgewogICAgICAgICAgICAgICAgTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFlbMV0gPSAnaW5uZXJUZXh0JzsgICAgLyoqIEVsZW1lbnQgKiovCiAgICAgICAgICAgICAgICBOT0RFX1RZUEVfVEVYVF9QUk9QRVJUWVszXSA9ICdub2RlVmFsdWUnOyAgICAvKiogVGV4dCAqKi8KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIE5PREVfVFlQRV9URVhUX1BST1BFUlRZWzFdID0gICAgICAgICAgICAgICAgIC8qKiBFbGVtZW50ICoqLwogICAgICAgICAgICAgICAgTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFlbM10gPSAndGV4dENvbnRlbnQnOyAgLyoqIFRleHQgKiovCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ2V0VGV4dC4kZHYgPSAnJzsKICAgICAgICAgICAgcmV0dXJuIGdldFRleHQ7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRUZXh0KGVsZW1lbnQsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGV4dFByb3AgPSBOT0RFX1RZUEVfVEVYVF9QUk9QRVJUWVtlbGVtZW50Lm5vZGVUeXBlXQogICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZXh0UHJvcCA/IGVsZW1lbnRbdGV4dFByb3BdIDogJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbGVtZW50W3RleHRQcm9wXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfSkoKSwKCiAgICAgICAgdmFsOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKG5vZGVOYW1lXyhlbGVtZW50KSA9PT0gJ1NFTEVDVCcgJiYgZWxlbWVudC5tdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQub3B0aW9ucywgZnVuY3Rpb24gKG9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChvcHRpb24udmFsdWUgfHwgb3B0aW9uLnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5sZW5ndGggPT09IDAgPyBudWxsIDogcmVzdWx0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwogICAgICAgIH0sCgogICAgICAgIGh0bWw6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC5pbm5lckhUTUw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkTm9kZXMgPSBlbGVtZW50LmNoaWxkTm9kZXM7IGkgPCBjaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBKUUxpdGVEZWFsb2MoY2hpbGROb2Rlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSB2YWx1ZTsKICAgICAgICB9CiAgICB9LCBmdW5jdGlvbiAoZm4sIG5hbWUpIHsKICAgICAgICAvKioKICAgICAgICAgKiBQcm9wZXJ0aWVzOiB3cml0ZXMgcmV0dXJuIHNlbGVjdGlvbiwgcmVhZHMgcmV0dXJuIGZpcnN0IHZhbHVlCiAgICAgICAgICovCiAgICAgICAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uIChhcmcxLCBhcmcyKSB7CiAgICAgICAgICAgIHZhciBpLCBrZXk7CgogICAgICAgICAgICAvLyBKUUxpdGVIYXNDbGFzcyBoYXMgb25seSB0d28gYXJndW1lbnRzLCBidXQgaXMgYSBnZXR0ZXItb25seSBmbiwgc28gd2UgbmVlZCB0byBzcGVjaWFsLWNhc2UgaXQKICAgICAgICAgICAgLy8gaW4gYSB3YXkgdGhhdCBzdXJ2aXZlcyBtaW5pZmljYXRpb24uCiAgICAgICAgICAgIGlmICgoKGZuLmxlbmd0aCA9PSAyICYmIChmbiAhPT0gSlFMaXRlSGFzQ2xhc3MgJiYgZm4gIT09IEpRTGl0ZUNvbnRyb2xsZXIpKSA/IGFyZzEgOiBhcmcyKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QoYXJnMSkpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIGEgd3JpdGUsIGJ1dCB0aGUgb2JqZWN0IHByb3BlcnRpZXMgYXJlIHRoZSBrZXkvdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuID09PSBKUUxpdGVEYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkYXRhKCkgdGFrZXMgdGhlIHdob2xlIG9iamVjdCBpbiBqUXVlcnkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHRoaXNbaV0sIGFyZzEpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gYXJnMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHRoaXNbaV0sIGtleSwgYXJnMVtrZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm4gc2VsZiBmb3IgY2hhaW5pbmcKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIGEgcmVhZCwgc28gcmVhZCB0aGUgZmlyc3QgY2hpbGQuCiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZm4uJGR2OwogICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgaWYgd2UgaGF2ZSAkZHYgZG8gd2UgaXRlcmF0ZSBvdmVyIGFsbCwgb3RoZXJ3aXNlIGl0IGlzIGp1c3QgdGhlIGZpcnN0IGVsZW1lbnQuCiAgICAgICAgICAgICAgICAgICAgdmFyIGpqID0gdmFsdWUgPT0gdW5kZWZpbmVkID8gTWF0aC5taW4odGhpcy5sZW5ndGgsIDEpIDogdGhpcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBqajsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlVmFsdWUgPSBmbih0aGlzW2pdLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZSA/IHZhbHVlICsgbm9kZVZhbHVlIDogbm9kZVZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgc28gYXBwbHkgdG8gYWxsIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGZuKHRoaXNbaV0sIGFyZzEsIGFyZzIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9KTsKCiAgICBmdW5jdGlvbiBjcmVhdGVFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnRzKSB7CiAgICAgICAgdmFyIGV2ZW50SGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCwgdHlwZSkgewogICAgICAgICAgICBpZiAoIWV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOyAvL2llCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7IC8vaWUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghZXZlbnQudGFyZ2V0KSB7CiAgICAgICAgICAgICAgICBldmVudC50YXJnZXQgPSBldmVudC5zcmNFbGVtZW50IHx8IGRvY3VtZW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2ZW50ID0gZXZlbnQucHJldmVudERlZmF1bHQ7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBwcmV2ZW50LmNhbGwoZXZlbnQpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgfHwgZXZlbnQucmV0dXJuVmFsdWUgPT0gZmFsc2U7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb3JFYWNoKGV2ZW50c1t0eXBlIHx8IGV2ZW50LnR5cGVdLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIGZuLmNhbGwoZWxlbWVudCwgZXZlbnQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFJlbW92ZSBtb25rZXktcGF0Y2hlZCBtZXRob2RzIChJRSksCiAgICAgICAgICAgIC8vIGFzIHRoZXkgd291bGQgY2F1c2UgbWVtb3J5IGxlYWtzIGluIElFOC4KICAgICAgICAgICAgaWYgKG1zaWUgPD0gOCkgewogICAgICAgICAgICAgICAgLy8gSUU3LzggZG9lcyBub3QgYWxsb3cgdG8gZGVsZXRlIHByb3BlcnR5IG9uIG5hdGl2ZSBvYmplY3QKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gbnVsbDsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgICBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSXQgc2hvdWxkbid0IGFmZmVjdCBub3JtYWwgYnJvd3NlcnMgKG5hdGl2ZSBtZXRob2RzIGFyZSBkZWZpbmVkIG9uIHByb3RvdHlwZSkuCiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnQucHJldmVudERlZmF1bHQ7CiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnQuc3RvcFByb3BhZ2F0aW9uOwogICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZXZlbnRIYW5kbGVyLmVsZW0gPSBlbGVtZW50OwogICAgICAgIHJldHVybiBldmVudEhhbmRsZXI7CiAgICB9CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBGdW5jdGlvbnMgaXRlcmF0aW5nIHRyYXZlcnNhbC4KICAgIC8vIFRoZXNlIGZ1bmN0aW9ucyBjaGFpbiByZXN1bHRzIGludG8gYSBzaW5nbGUKICAgIC8vIHNlbGVjdG9yLgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICBmb3JFYWNoKHsKICAgICAgICByZW1vdmVEYXRhOiBKUUxpdGVSZW1vdmVEYXRhLAoKICAgICAgICBkZWFsb2M6IEpRTGl0ZURlYWxvYywKCiAgICAgICAgb246IGZ1bmN0aW9uIG9uRm4oZWxlbWVudCwgdHlwZSwgZm4sIHVuc3VwcG9ydGVkKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQodW5zdXBwb3J0ZWQpKSB0aHJvdyBqcUxpdGVNaW5FcnIoJ29uYXJncycsICdqcUxpdGUjb24oKSBkb2VzIG5vdCBzdXBwb3J0IHRoZSBgc2VsZWN0b3JgIG9yIGBldmVudERhdGFgIHBhcmFtZXRlcnMnKTsKCiAgICAgICAgICAgIHZhciBldmVudHMgPSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycpLAogICAgICAgICAgICAgICAgaGFuZGxlID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgICAgICAgICAgIGlmICghZXZlbnRzKSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycsIGV2ZW50cyA9IHt9KTsKICAgICAgICAgICAgaWYgKCFoYW5kbGUpIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnaGFuZGxlJywgaGFuZGxlID0gY3JlYXRlRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50cykpOwoKICAgICAgICAgICAgZm9yRWFjaCh0eXBlLnNwbGl0KCcgJyksIGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRGbnMgPSBldmVudHNbdHlwZV07CgogICAgICAgICAgICAgICAgaWYgKCFldmVudEZucykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09ICdtb3VzZWVudGVyJyB8fCB0eXBlID09ICdtb3VzZWxlYXZlJykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGFpbnMgPSBkb2N1bWVudC5ib2R5LmNvbnRhaW5zIHx8IGRvY3VtZW50LmJvZHkuY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1cCA9IGIgJiYgYi5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGJ1cCB8fCAhIShidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRvd24uY29udGFpbnMgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZG93bi5jb250YWlucyhidXApIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGJ1cCkgJiAxNgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgoYiA9IGIucGFyZW50Tm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYiA9PT0gYSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBldmVudHNbdHlwZV0gPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlZmVyIHRvIGpRdWVyeSdzIGltcGxlbWVudGF0aW9uIG9mIG1vdXNlZW50ZXIgJiBtb3VzZWxlYXZlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlYWQgYWJvdXQgbW91c2VlbnRlciBhbmQgbW91c2VsZWF2ZToKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaHR0cDovL3d3dy5xdWlya3Ntb2RlLm9yZy9qcy9ldmVudHNfbW91c2UuaHRtbCNsaW5rOAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRtYXAgPSB7IG1vdXNlbGVhdmU6ICJtb3VzZW91dCIsIG1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiIH07CgogICAgICAgICAgICAgICAgICAgICAgICBvbkZuKGVsZW1lbnQsIGV2ZW50bWFwW3R5cGVdLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLCByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbGF0ZWQgfHwgKHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhY29udGFpbnModGFyZ2V0LCByZWxhdGVkKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGUoZXZlbnQsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGhhbmRsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBldmVudEZucyA9IGV2ZW50c1t0eXBlXQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXZlbnRGbnMucHVzaChmbik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIG9mZjogSlFMaXRlT2ZmLAoKICAgICAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24gKGVsZW1lbnQsIHJlcGxhY2VOb2RlKSB7CiAgICAgICAgICAgIHZhciBpbmRleCwgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBKUUxpdGVEZWFsb2MoZWxlbWVudCk7CiAgICAgICAgICAgIGZvckVhY2gobmV3IEpRTGl0ZShyZXBsYWNlTm9kZSksIGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIGluZGV4Lm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZChub2RlLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4ID0gbm9kZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgY2hpbGRyZW46IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQuY2hpbGROb2RlcywgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKQogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfSwKCiAgICAgICAgY29udGVudHM6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmNoaWxkTm9kZXMgfHwgW107CiAgICAgICAgfSwKCiAgICAgICAgYXBwZW5kOiBmdW5jdGlvbiAoZWxlbWVudCwgbm9kZSkgewogICAgICAgICAgICBmb3JFYWNoKG5ldyBKUUxpdGUobm9kZSksIGZ1bmN0aW9uIChjaGlsZCkgewogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDEgfHwgZWxlbWVudC5ub2RlVHlwZSA9PT0gMTEpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgcHJlcGVuZDogZnVuY3Rpb24gKGVsZW1lbnQsIG5vZGUpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IGVsZW1lbnQuZmlyc3RDaGlsZDsKICAgICAgICAgICAgICAgIGZvckVhY2gobmV3IEpRTGl0ZShub2RlKSwgZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoY2hpbGQsIGluZGV4KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgd3JhcDogZnVuY3Rpb24gKGVsZW1lbnQsIHdyYXBOb2RlKSB7CiAgICAgICAgICAgIHdyYXBOb2RlID0ganFMaXRlKHdyYXBOb2RlKVswXTsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudCkgewogICAgICAgICAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZCh3cmFwTm9kZSwgZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd3JhcE5vZGUuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICBKUUxpdGVEZWFsb2MoZWxlbWVudCk7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIGlmIChwYXJlbnQpIHBhcmVudC5yZW1vdmVDaGlsZChlbGVtZW50KTsKICAgICAgICB9LAoKICAgICAgICBhZnRlcjogZnVuY3Rpb24gKGVsZW1lbnQsIG5ld0VsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0gZWxlbWVudCwgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBmb3JFYWNoKG5ldyBKUUxpdGUobmV3RWxlbWVudCksIGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIGluZGV4Lm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgIGluZGV4ID0gbm9kZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgYWRkQ2xhc3M6IEpRTGl0ZUFkZENsYXNzLAogICAgICAgIHJlbW92ZUNsYXNzOiBKUUxpdGVSZW1vdmVDbGFzcywKCiAgICAgICAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvciwgY29uZGl0aW9uKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChjb25kaXRpb24pKSB7CiAgICAgICAgICAgICAgICBjb25kaXRpb24gPSAhSlFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIChjb25kaXRpb24gPyBKUUxpdGVBZGRDbGFzcyA6IEpRTGl0ZVJlbW92ZUNsYXNzKShlbGVtZW50LCBzZWxlY3Rvcik7CiAgICAgICAgfSwKCiAgICAgICAgcGFyZW50OiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICByZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIG5leHQ6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIGlmIChlbGVtZW50Lm5leHRFbGVtZW50U2libGluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJRTggZG9lc24ndCBoYXZlIG5leHRFbGVtZW50U2libGluZwogICAgICAgICAgICB2YXIgZWxtID0gZWxlbWVudC5uZXh0U2libGluZzsKICAgICAgICAgICAgd2hpbGUgKGVsbSAhPSBudWxsICYmIGVsbS5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgICAgICAgZWxtID0gZWxtLm5leHRTaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlbG07CiAgICAgICAgfSwKCiAgICAgICAgZmluZDogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKTsKICAgICAgICB9LAoKICAgICAgICBjbG9uZTogSlFMaXRlQ2xvbmUsCgogICAgICAgIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnROYW1lLCBldmVudERhdGEpIHsKICAgICAgICAgICAgdmFyIGV2ZW50Rm5zID0gKEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJykgfHwge30pW2V2ZW50TmFtZV07CiAgICAgICAgICAgIGV2ZW50RGF0YSA9IGV2ZW50RGF0YSB8fCB7CiAgICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogbm9vcCwKICAgICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogbm9vcAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9yRWFjaChldmVudEZucywgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICBmbi5jYWxsKGVsZW1lbnQsIGV2ZW50RGF0YSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0sIGZ1bmN0aW9uIChmbiwgbmFtZSkgewogICAgICAgIC8qKgogICAgICAgICAqIGNoYWluaW5nIGZ1bmN0aW9ucwogICAgICAgICAqLwogICAgICAgIEpRTGl0ZS5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbiAoYXJnMSwgYXJnMiwgYXJnMykgewogICAgICAgICAgICB2YXIgdmFsdWU7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZm4odGhpc1tpXSwgYXJnMSwgYXJnMiwgYXJnMyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW55IGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYSB2YWx1ZSBuZWVkcyB0byBiZSB3cmFwcGVkCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0ganFMaXRlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIEpRTGl0ZUFkZE5vZGVzKHZhbHVlLCBmbih0aGlzW2ldLCBhcmcxLCBhcmcyLCBhcmczKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09IHVuZGVmaW5lZCA/IHRoaXMgOiB2YWx1ZTsKICAgICAgICB9OwoKICAgICAgICAvLyBiaW5kIGxlZ2FjeSBiaW5kL3VuYmluZCB0byBvbi9vZmYKICAgICAgICBKUUxpdGUucHJvdG90eXBlLmJpbmQgPSBKUUxpdGUucHJvdG90eXBlLm9uOwogICAgICAgIEpRTGl0ZS5wcm90b3R5cGUudW5iaW5kID0gSlFMaXRlLnByb3RvdHlwZS5vZmY7CiAgICB9KTsKCiAgICAvKioKICAgICAqIENvbXB1dGVzIGEgaGFzaCBvZiBhbiAnb2JqJy4KICAgICAqIEhhc2ggb2YgYToKICAgICAqICBzdHJpbmcgaXMgc3RyaW5nCiAgICAgKiAgbnVtYmVyIGlzIG51bWJlciBhcyBzdHJpbmcKICAgICAqICBvYmplY3QgaXMgZWl0aGVyIHJlc3VsdCBvZiBjYWxsaW5nICQkaGFzaEtleSBmdW5jdGlvbiBvbiB0aGUgb2JqZWN0IG9yIHVuaXF1ZWx5IGdlbmVyYXRlZCBpZCwKICAgICAqICAgICAgICAgdGhhdCBpcyBhbHNvIGFzc2lnbmVkIHRvIHRoZSAkJGhhc2hLZXkgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gb2JqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBoYXNoIHN0cmluZyBzdWNoIHRoYXQgdGhlIHNhbWUgaW5wdXQgd2lsbCBoYXZlIHRoZSBzYW1lIGhhc2ggc3RyaW5nLgogICAgICogICAgICAgICBUaGUgcmVzdWx0aW5nIHN0cmluZyBrZXkgaXMgaW4gJ3R5cGU6aGFzaEtleScgZm9ybWF0LgogICAgICovCiAgICBmdW5jdGlvbiBoYXNoS2V5KG9iaikgewogICAgICAgIHZhciBvYmpUeXBlID0gdHlwZW9mIG9iaiwKICAgICAgICAgICAga2V5OwoKICAgICAgICBpZiAob2JqVHlwZSA9PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiAoa2V5ID0gb2JqLiQkaGFzaEtleSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgLy8gbXVzdCBpbnZva2Ugb24gb2JqZWN0IHRvIGtlZXAgdGhlIHJpZ2h0IHRoaXMKICAgICAgICAgICAgICAgIGtleSA9IG9iai4kJGhhc2hLZXkoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAga2V5ID0gb2JqLiQkaGFzaEtleSA9IG5leHRVaWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleSA9IG9iajsKICAgICAgICB9CgogICAgICAgIHJldHVybiBvYmpUeXBlICsgJzonICsga2V5OwogICAgfQoKICAgIC8qKgogICAgICogSGFzaE1hcCB3aGljaCBjYW4gdXNlIG9iamVjdHMgYXMga2V5cwogICAgICovCiAgICBmdW5jdGlvbiBIYXNoTWFwKGFycmF5KSB7CiAgICAgICAgZm9yRWFjaChhcnJheSwgdGhpcy5wdXQsIHRoaXMpOwogICAgfQogICAgSGFzaE1hcC5wcm90b3R5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogU3RvcmUga2V5IHZhbHVlIHBhaXIKICAgICAgICAgKiBAcGFyYW0ga2V5IGtleSB0byBzdG9yZSBjYW4gYmUgYW55IHR5cGUKICAgICAgICAgKiBAcGFyYW0gdmFsdWUgdmFsdWUgdG8gc3RvcmUgY2FuIGJlIGFueSB0eXBlCiAgICAgICAgICovCiAgICAgICAgcHV0OiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICB0aGlzW2hhc2hLZXkoa2V5KV0gPSB2YWx1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0ga2V5CiAgICAgICAgICogQHJldHVybnMgdGhlIHZhbHVlIGZvciB0aGUga2V5CiAgICAgICAgICovCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW2hhc2hLZXkoa2V5KV07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVtb3ZlIHRoZSBrZXkvdmFsdWUgcGFpcgogICAgICAgICAqIEBwYXJhbSBrZXkKICAgICAgICAgKi8KICAgICAgICByZW1vdmU6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpc1trZXkgPSBoYXNoS2V5KGtleSldOwogICAgICAgICAgICBkZWxldGUgdGhpc1trZXldOwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pbmplY3RvcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGFuIGluamVjdG9yIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIHVzZWQgZm9yIHJldHJpZXZpbmcgc2VydmljZXMgYXMgd2VsbCBhcyBmb3IKICAgICAqIGRlcGVuZGVuY3kgaW5qZWN0aW9uIChzZWUge0BsaW5rIGd1aWRlL2RpIGRlcGVuZGVuY3kgaW5qZWN0aW9ufSkuCiAgICAgKgogICAgCiAgICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmd8RnVuY3Rpb24+fSBtb2R1bGVzIEEgbGlzdCBvZiBtb2R1bGUgZnVuY3Rpb25zIG9yIHRoZWlyIGFsaWFzZXMuIFNlZQogICAgICogICAgICAgIHtAbGluayBhbmd1bGFyLm1vZHVsZX0uIFRoZSBgbmdgIG1vZHVsZSBtdXN0IGJlIGV4cGxpY2l0bHkgYWRkZWQuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gSW5qZWN0b3IgZnVuY3Rpb24uIFNlZSB7QGxpbmsgQVVUTy4kaW5qZWN0b3IgJGluamVjdG9yfS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogVHlwaWNhbCB1c2FnZQogICAgICogPHByZT4KICAgICAqICAgLy8gY3JlYXRlIGFuIGluamVjdG9yCiAgICAgKiAgIHZhciAkaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKFsnbmcnXSk7CiAgICAgKgogICAgICogICAvLyB1c2UgdGhlIGluamVjdG9yIHRvIGtpY2sgb2ZmIHlvdXIgYXBwbGljYXRpb24KICAgICAqICAgLy8gdXNlIHRoZSB0eXBlIGluZmVyZW5jZSB0byBhdXRvIGluamVjdCBhcmd1bWVudHMsIG9yIHVzZSBpbXBsaWNpdCBpbmplY3Rpb24KICAgICAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkcm9vdFNjb3BlLCAkY29tcGlsZSwgJGRvY3VtZW50KXsKICAgICAqICAgICAkY29tcGlsZSgkZG9jdW1lbnQpKCRyb290U2NvcGUpOwogICAgICogICAgICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICogICB9KTsKICAgICAqIDwvcHJlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG92ZXJ2aWV3CiAgICAgKiBAbmFtZSBBVVRPCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBJbXBsaWNpdCBtb2R1bGUgd2hpY2ggZ2V0cyBhdXRvbWF0aWNhbGx5IGFkZGVkIHRvIGVhY2gge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgKi8KCiAgICB2YXIgRk5fQVJHUyA9IC9eZnVuY3Rpb25ccypbXlwoXSpcKFxzKihbXlwpXSopXCkvbTsKICAgIHZhciBGTl9BUkdfU1BMSVQgPSAvLC87CiAgICB2YXIgRk5fQVJHID0gL15ccyooXz8pKFxTKz8pXDFccyokLzsKICAgIHZhciBTVFJJUF9DT01NRU5UUyA9IC8oKFwvXC8uKiQpfChcL1wqW1xzXFNdKj9cKlwvKSkvbWc7CiAgICB2YXIgJGluamVjdG9yTWluRXJyID0gbWluRXJyKCckaW5qZWN0b3InKTsKICAgIGZ1bmN0aW9uIGFubm90YXRlKGZuKSB7CiAgICAgICAgdmFyICRpbmplY3QsCiAgICAgICAgICAgIGZuVGV4dCwKICAgICAgICAgICAgYXJnRGVjbCwKICAgICAgICAgICAgbGFzdDsKCiAgICAgICAgaWYgKHR5cGVvZiBmbiA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGlmICghKCRpbmplY3QgPSBmbi4kaW5qZWN0KSkgewogICAgICAgICAgICAgICAgJGluamVjdCA9IFtdOwogICAgICAgICAgICAgICAgaWYgKGZuLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGZuVGV4dCA9IGZuLnRvU3RyaW5nKCkucmVwbGFjZShTVFJJUF9DT01NRU5UUywgJycpOwogICAgICAgICAgICAgICAgICAgIGFyZ0RlY2wgPSBmblRleHQubWF0Y2goRk5fQVJHUyk7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChhcmdEZWNsWzFdLnNwbGl0KEZOX0FSR19TUExJVCksIGZ1bmN0aW9uIChhcmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJnLnJlcGxhY2UoRk5fQVJHLCBmdW5jdGlvbiAoYWxsLCB1bmRlcnNjb3JlLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkaW5qZWN0LnB1c2gobmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm4uJGluamVjdCA9ICRpbmplY3Q7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkoZm4pKSB7CiAgICAgICAgICAgIGxhc3QgPSBmbi5sZW5ndGggLSAxOwogICAgICAgICAgICBhc3NlcnRBcmdGbihmbltsYXN0XSwgJ2ZuJyk7CiAgICAgICAgICAgICRpbmplY3QgPSBmbi5zbGljZSgwLCBsYXN0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhc3NlcnRBcmdGbihmbiwgJ2ZuJywgdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkaW5qZWN0OwogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIGAkaW5qZWN0b3JgIGlzIHVzZWQgdG8gcmV0cmlldmUgb2JqZWN0IGluc3RhbmNlcyBhcyBkZWZpbmVkIGJ5CiAgICAgKiB7QGxpbmsgQVVUTy4kcHJvdmlkZSBwcm92aWRlcn0sIGluc3RhbnRpYXRlIHR5cGVzLCBpbnZva2UgbWV0aG9kcywKICAgICAqIGFuZCBsb2FkIG1vZHVsZXMuCiAgICAgKgogICAgICogVGhlIGZvbGxvd2luZyBhbHdheXMgaG9sZHMgdHJ1ZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICB2YXIgJGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcigpOwogICAgICogICBleHBlY3QoJGluamVjdG9yLmdldCgnJGluamVjdG9yJykpLnRvQmUoJGluamVjdG9yKTsKICAgICAqICAgZXhwZWN0KCRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJGluamVjdG9yKXsKICAgICAqICAgICByZXR1cm4gJGluamVjdG9yOwogICAgICogICB9KS50b0JlKCRpbmplY3Rvcik7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiAjIEluamVjdGlvbiBGdW5jdGlvbiBBbm5vdGF0aW9uCiAgICAgKgogICAgICogSmF2YVNjcmlwdCBkb2VzIG5vdCBoYXZlIGFubm90YXRpb25zLCBhbmQgYW5ub3RhdGlvbnMgYXJlIG5lZWRlZCBmb3IgZGVwZW5kZW5jeSBpbmplY3Rpb24uIFRoZQogICAgICogZm9sbG93aW5nIGFyZSBhbGwgdmFsaWQgd2F5cyBvZiBhbm5vdGF0aW5nIGZ1bmN0aW9uIHdpdGggaW5qZWN0aW9uIGFyZ3VtZW50cyBhbmQgYXJlIGVxdWl2YWxlbnQuCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gaW5mZXJyZWQgKG9ubHkgd29ya3MgaWYgY29kZSBub3QgbWluaWZpZWQvb2JmdXNjYXRlZCkKICAgICAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbihzZXJ2aWNlQSl7fSk7CiAgICAgKgogICAgICogICAvLyBhbm5vdGF0ZWQKICAgICAqICAgZnVuY3Rpb24gZXhwbGljaXQoc2VydmljZUEpIHt9OwogICAgICogICBleHBsaWNpdC4kaW5qZWN0ID0gWydzZXJ2aWNlQSddOwogICAgICogICAkaW5qZWN0b3IuaW52b2tlKGV4cGxpY2l0KTsKICAgICAqCiAgICAgKiAgIC8vIGlubGluZQogICAgICogICAkaW5qZWN0b3IuaW52b2tlKFsnc2VydmljZUEnLCBmdW5jdGlvbihzZXJ2aWNlQSl7fV0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogIyMgSW5mZXJlbmNlCiAgICAgKgogICAgICogSW4gSmF2YVNjcmlwdCBjYWxsaW5nIGB0b1N0cmluZygpYCBvbiBhIGZ1bmN0aW9uIHJldHVybnMgdGhlIGZ1bmN0aW9uIGRlZmluaXRpb24uIFRoZSBkZWZpbml0aW9uIGNhbiB0aGVuIGJlCiAgICAgKiBwYXJzZWQgYW5kIHRoZSBmdW5jdGlvbiBhcmd1bWVudHMgY2FuIGJlIGV4dHJhY3RlZC4gKk5PVEU6KiBUaGlzIGRvZXMgbm90IHdvcmsgd2l0aCBtaW5pZmljYXRpb24sIGFuZCBvYmZ1c2NhdGlvbgogICAgICogdG9vbHMgc2luY2UgdGhlc2UgdG9vbHMgY2hhbmdlIHRoZSBhcmd1bWVudCBuYW1lcy4KICAgICAqCiAgICAgKiAjIyBgJGluamVjdGAgQW5ub3RhdGlvbgogICAgICogQnkgYWRkaW5nIGEgYCRpbmplY3RgIHByb3BlcnR5IG9udG8gYSBmdW5jdGlvbiB0aGUgaW5qZWN0aW9uIHBhcmFtZXRlcnMgY2FuIGJlIHNwZWNpZmllZC4KICAgICAqCiAgICAgKiAjIyBJbmxpbmUKICAgICAqIEFzIGFuIGFycmF5IG9mIGluamVjdGlvbiBuYW1lcywgd2hlcmUgdGhlIGxhc3QgaXRlbSBpbiB0aGUgYXJyYXkgaXMgdGhlIGZ1bmN0aW9uIHRvIGNhbGwuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yI2dldAogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm4gYW4gaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRvIHJldHJpZXZlLgogICAgICogQHJldHVybiB7Kn0gVGhlIGluc3RhbmNlLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNpbnZva2UKICAgICAqIEBtZXRob2RPZiBBVVRPLiRpbmplY3RvcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSW52b2tlIHRoZSBtZXRob2QgYW5kIHN1cHBseSB0aGUgbWV0aG9kIGFyZ3VtZW50cyBmcm9tIHRoZSBgJGluamVjdG9yYC4KICAgICAqCiAgICAgKiBAcGFyYW0geyFmdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIGludm9rZS4gVGhlIGZ1bmN0aW9uIGFyZ3VtZW50cyBjb21lIGZvcm0gdGhlIGZ1bmN0aW9uIGFubm90YXRpb24uCiAgICAgKiBAcGFyYW0ge09iamVjdD19IHNlbGYgVGhlIGB0aGlzYCBmb3IgdGhlIGludm9rZWQgbWV0aG9kLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzIG9iamVjdCBmaXJzdCwgYmVmb3JlCiAgICAgKiAgIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAgICAgKiBAcmV0dXJucyB7Kn0gdGhlIHZhbHVlIHJldHVybmVkIGJ5IHRoZSBpbnZva2VkIGBmbmAgZnVuY3Rpb24uCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yI2hhcwogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBbGxvd3MgdGhlIHVzZXIgdG8gcXVlcnkgaWYgdGhlIHBhcnRpY3VsYXIgc2VydmljZSBleGlzdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gTmFtZSBvZiB0aGUgc2VydmljZSB0byBxdWVyeS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSByZXR1cm5zIHRydWUgaWYgaW5qZWN0b3IgaGFzIGdpdmVuIHNlcnZpY2UuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yI2luc3RhbnRpYXRlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kaW5qZWN0b3IKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIEpTIHR5cGUuIFRoZSBtZXRob2QgdGFrZXMgYSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBpbnZva2VzIHRoZSBuZXcgb3BlcmF0b3IgYW5kIHN1cHBsaWVzCiAgICAgKiBhbGwgb2YgdGhlIGFyZ3VtZW50cyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24gYXMgc3BlY2lmaWVkIGJ5IHRoZSBjb25zdHJ1Y3RvciBhbm5vdGF0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFR5cGUgQW5ub3RhdGVkIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzIG9iamVjdCBmaXJzdCwgYmVmb3JlCiAgICAgKiAgIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBuZXcgaW5zdGFuY2Ugb2YgYFR5cGVgLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNhbm5vdGF0ZQogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGFuIGFycmF5IG9mIHNlcnZpY2UgbmFtZXMgd2hpY2ggdGhlIGZ1bmN0aW9uIGlzIHJlcXVlc3RpbmcgZm9yIGluamVjdGlvbi4gVGhpcyBBUEkgaXMgdXNlZCBieSB0aGUgaW5qZWN0b3IKICAgICAqIHRvIGRldGVybWluZSB3aGljaCBzZXJ2aWNlcyBuZWVkIHRvIGJlIGluamVjdGVkIGludG8gdGhlIGZ1bmN0aW9uIHdoZW4gdGhlIGZ1bmN0aW9uIGlzIGludm9rZWQuIFRoZXJlIGFyZSB0aHJlZQogICAgICogd2F5cyBpbiB3aGljaCB0aGUgZnVuY3Rpb24gY2FuIGJlIGFubm90YXRlZCB3aXRoIHRoZSBuZWVkZWQgZGVwZW5kZW5jaWVzLgogICAgICoKICAgICAqICMgQXJndW1lbnQgbmFtZXMKICAgICAqCiAgICAgKiBUaGUgc2ltcGxlc3QgZm9ybSBpcyB0byBleHRyYWN0IHRoZSBkZXBlbmRlbmNpZXMgZnJvbSB0aGUgYXJndW1lbnRzIG9mIHRoZSBmdW5jdGlvbi4gVGhpcyBpcyBkb25lIGJ5IGNvbnZlcnRpbmcKICAgICAqIHRoZSBmdW5jdGlvbiBpbnRvIGEgc3RyaW5nIHVzaW5nIGB0b1N0cmluZygpYCBtZXRob2QgYW5kIGV4dHJhY3RpbmcgdGhlIGFyZ3VtZW50IG5hbWVzLgogICAgICogPHByZT4KICAgICAqICAgLy8gR2l2ZW4KICAgICAqICAgZnVuY3Rpb24gTXlDb250cm9sbGVyKCRzY29wZSwgJHJvdXRlKSB7CiAgICAgKiAgICAgLy8gLi4uCiAgICAgKiAgIH0KICAgICAqCiAgICAgKiAgIC8vIFRoZW4KICAgICAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKE15Q29udHJvbGxlcikpLnRvRXF1YWwoWyckc2NvcGUnLCAnJHJvdXRlJ10pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhpcyBtZXRob2QgZG9lcyBub3Qgd29yayB3aXRoIGNvZGUgbWluaWZpY2F0aW9uIC8gb2JmdXNjYXRpb24uIEZvciB0aGlzIHJlYXNvbiB0aGUgZm9sbG93aW5nIGFubm90YXRpb24gc3RyYXRlZ2llcwogICAgICogYXJlIHN1cHBvcnRlZC4KICAgICAqCiAgICAgKiAjIFRoZSBgJGluamVjdGAgcHJvcGVydHkKICAgICAqCiAgICAgKiBJZiBhIGZ1bmN0aW9uIGhhcyBhbiBgJGluamVjdGAgcHJvcGVydHkgYW5kIGl0cyB2YWx1ZSBpcyBhbiBhcnJheSBvZiBzdHJpbmdzLCB0aGVuIHRoZSBzdHJpbmdzIHJlcHJlc2VudCBuYW1lcyBvZgogICAgICogc2VydmljZXMgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgZnVuY3Rpb24uCiAgICAgKiA8cHJlPgogICAgICogICAvLyBHaXZlbgogICAgICogICB2YXIgTXlDb250cm9sbGVyID0gZnVuY3Rpb24ob2JmdXNjYXRlZFNjb3BlLCBvYmZ1c2NhdGVkUm91dGUpIHsKICAgICAqICAgICAvLyAuLi4KICAgICAqICAgfQogICAgICogICAvLyBEZWZpbmUgZnVuY3Rpb24gZGVwZW5kZW5jaWVzCiAgICAgKiAgIE15Q29udHJvbGxlci4kaW5qZWN0ID0gWyckc2NvcGUnLCAnJHJvdXRlJ107CiAgICAgKgogICAgICogICAvLyBUaGVuCiAgICAgKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZShNeUNvbnRyb2xsZXIpKS50b0VxdWFsKFsnJHNjb3BlJywgJyRyb3V0ZSddKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqICMgVGhlIGFycmF5IG5vdGF0aW9uCiAgICAgKgogICAgICogSXQgaXMgb2Z0ZW4gZGVzaXJhYmxlIHRvIGlubGluZSBJbmplY3RlZCBmdW5jdGlvbnMgYW5kIHRoYXQncyB3aGVuIHNldHRpbmcgdGhlIGAkaW5qZWN0YCBwcm9wZXJ0eSBpcyB2ZXJ5CiAgICAgKiBpbmNvbnZlbmllbnQuIEluIHRoZXNlIHNpdHVhdGlvbnMgdXNpbmcgdGhlIGFycmF5IG5vdGF0aW9uIHRvIHNwZWNpZnkgdGhlIGRlcGVuZGVuY2llcyBpbiBhIHdheSB0aGF0IHN1cnZpdmVzCiAgICAgKiBtaW5pZmljYXRpb24gaXMgYSBiZXR0ZXIgY2hvaWNlOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIFdlIHdpc2ggdG8gd3JpdGUgdGhpcyAobm90IG1pbmlmaWNhdGlvbiAvIG9iZnVzY2F0aW9uIHNhZmUpCiAgICAgKiAgIGluamVjdG9yLmludm9rZShmdW5jdGlvbigkY29tcGlsZSwgJHJvb3RTY29wZSkgewogICAgICogICAgIC8vIC4uLgogICAgICogICB9KTsKICAgICAqCiAgICAgKiAgIC8vIFdlIGFyZSBmb3JjZWQgdG8gd3JpdGUgYnJlYWsgaW5saW5pbmcKICAgICAqICAgdmFyIHRtcEZuID0gZnVuY3Rpb24ob2JmdXNjYXRlZENvbXBpbGUsIG9iZnVzY2F0ZWRSb290U2NvcGUpIHsKICAgICAqICAgICAvLyAuLi4KICAgICAqICAgfTsKICAgICAqICAgdG1wRm4uJGluamVjdCA9IFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZSddOwogICAgICogICBpbmplY3Rvci5pbnZva2UodG1wRm4pOwogICAgICoKICAgICAqICAgLy8gVG8gYmV0dGVyIHN1cHBvcnQgaW5saW5lIGZ1bmN0aW9uIHRoZSBpbmxpbmUgYW5ub3RhdGlvbiBpcyBzdXBwb3J0ZWQKICAgICAqICAgaW5qZWN0b3IuaW52b2tlKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKG9iZkNvbXBpbGUsIG9iZlJvb3RTY29wZSkgewogICAgICogICAgIC8vIC4uLgogICAgICogICB9XSk7CiAgICAgKgogICAgICogICAvLyBUaGVyZWZvcmUKICAgICAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKAogICAgICogICAgICBbJyRjb21waWxlJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbihvYmZ1c18kY29tcGlsZSwgb2JmdXNfJHJvb3RTY29wZSkge31dKQogICAgICogICAgKS50b0VxdWFsKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZSddKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb258QXJyYXkuPHN0cmluZ3xGdW5jdGlvbj59IGZuIEZ1bmN0aW9uIGZvciB3aGljaCBkZXBlbmRlbnQgc2VydmljZSBuYW1lcyBuZWVkIHRvIGJlIHJldHJpZXZlZCBhcyBkZXNjcmliZWQKICAgICAqICAgYWJvdmUuCiAgICAgKgogICAgICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fSBUaGUgbmFtZXMgb2YgdGhlIHNlcnZpY2VzIHdoaWNoIHRoZSBmdW5jdGlvbiByZXF1aXJlcy4KICAgICAqLwoKCgoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFVzZSBgJHByb3ZpZGVgIHRvIHJlZ2lzdGVyIG5ldyBwcm92aWRlcnMgd2l0aCB0aGUgYCRpbmplY3RvcmAuIFRoZSBwcm92aWRlcnMgYXJlIHRoZSBmYWN0b3JpZXMgZm9yIHRoZSBpbnN0YW5jZS4KICAgICAqIFRoZSBwcm92aWRlcnMgc2hhcmUgdGhlIHNhbWUgbmFtZSBhcyB0aGUgaW5zdGFuY2UgdGhleSBjcmVhdGUgd2l0aCBgUHJvdmlkZXJgIHN1ZmZpeGVkIHRvIHRoZW0uCiAgICAgKgogICAgICogQSBwcm92aWRlciBpcyBhbiBvYmplY3Qgd2l0aCBhIGAkZ2V0KClgIG1ldGhvZC4gVGhlIGluamVjdG9yIGNhbGxzIHRoZSBgJGdldGAgbWV0aG9kIHRvIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZgogICAgICogYSBzZXJ2aWNlLiBUaGUgUHJvdmlkZXIgY2FuIGhhdmUgYWRkaXRpb25hbCBtZXRob2RzIHdoaWNoIHdvdWxkIGFsbG93IGZvciBjb25maWd1cmF0aW9uIG9mIHRoZSBwcm92aWRlci4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICBmdW5jdGlvbiBHcmVldFByb3ZpZGVyKCkgewogICAgICogICAgIHZhciBzYWx1dGF0aW9uID0gJ0hlbGxvJzsKICAgICAqCiAgICAgKiAgICAgdGhpcy5zYWx1dGF0aW9uID0gZnVuY3Rpb24odGV4dCkgewogICAgICogICAgICAgc2FsdXRhdGlvbiA9IHRleHQ7CiAgICAgKiAgICAgfTsKICAgICAqCiAgICAgKiAgICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAqICAgICAgICAgcmV0dXJuIHNhbHV0YXRpb24gKyAnICcgKyBuYW1lICsgJyEnOwogICAgICogICAgICAgfTsKICAgICAqICAgICB9OwogICAgICogICB9CiAgICAgKgogICAgICogICBkZXNjcmliZSgnR3JlZXRlcicsIGZ1bmN0aW9uKCl7CiAgICAgKgogICAgICogICAgIGJlZm9yZUVhY2gobW9kdWxlKGZ1bmN0aW9uKCRwcm92aWRlKSB7CiAgICAgKiAgICAgICAkcHJvdmlkZS5wcm92aWRlcignZ3JlZXQnLCBHcmVldFByb3ZpZGVyKTsKICAgICAqICAgICB9KSk7CiAgICAgKgogICAgICogICAgIGl0KCdzaG91bGQgZ3JlZXQnLCBpbmplY3QoZnVuY3Rpb24oZ3JlZXQpIHsKICAgICAqICAgICAgIGV4cGVjdChncmVldCgnYW5ndWxhcicpKS50b0VxdWFsKCdIZWxsbyBhbmd1bGFyIScpOwogICAgICogICAgIH0pKTsKICAgICAqCiAgICAgKiAgICAgaXQoJ3Nob3VsZCBhbGxvdyBjb25maWd1cmF0aW9uIG9mIHNhbHV0YXRpb24nLCBmdW5jdGlvbigpIHsKICAgICAqICAgICAgIG1vZHVsZShmdW5jdGlvbihncmVldFByb3ZpZGVyKSB7CiAgICAgKiAgICAgICAgIGdyZWV0UHJvdmlkZXIuc2FsdXRhdGlvbignQWhvaicpOwogICAgICogICAgICAgfSk7CiAgICAgKiAgICAgICBpbmplY3QoZnVuY3Rpb24oZ3JlZXQpIHsKICAgICAqICAgICAgICAgZXhwZWN0KGdyZWV0KCdhbmd1bGFyJykpLnRvRXF1YWwoJ0Fob2ogYW5ndWxhciEnKTsKICAgICAqICAgICAgIH0pOwogICAgICogICAgIH0pOwogICAgICogPC9wcmU+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjcHJvdmlkZXIKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBSZWdpc3RlciBhIHByb3ZpZGVyIGZvciBhIHNlcnZpY2UuIFRoZSBwcm92aWRlcnMgY2FuIGJlIHJldHJpZXZlZCBhbmQgY2FuIGhhdmUgYWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG1ldGhvZHMuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLiBOT1RFOiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBhdmFpbGFibGUgdW5kZXIgYG5hbWUgKyAnUHJvdmlkZXInYCBrZXkuCiAgICAgKiBAcGFyYW0geyhPYmplY3R8ZnVuY3Rpb24oKSl9IHByb3ZpZGVyIElmIHRoZSBwcm92aWRlciBpczoKICAgICAqCiAgICAgKiAgIC0gYE9iamVjdGA6IHRoZW4gaXQgc2hvdWxkIGhhdmUgYSBgJGdldGAgbWV0aG9kLiBUaGUgYCRnZXRgIG1ldGhvZCB3aWxsIGJlIGludm9rZWQgdXNpbmcKICAgICAqICAgICAgICAgICAgICAge0BsaW5rIEFVVE8uJGluamVjdG9yI2ludm9rZSAkaW5qZWN0b3IuaW52b2tlKCl9IHdoZW4gYW4gaW5zdGFuY2UgbmVlZHMgdG8gYmUgY3JlYXRlZC4KICAgICAqICAgLSBgQ29uc3RydWN0b3JgOiBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBjcmVhdGVkIHVzaW5nCiAgICAgKiAgICAgICAgICAgICAgIHtAbGluayBBVVRPLiRpbmplY3RvciNpbnN0YW50aWF0ZSAkaW5qZWN0b3IuaW5zdGFudGlhdGUoKX0sIHRoZW4gdHJlYXRlZCBhcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjZmFjdG9yeQogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgc2hvcnQgaGFuZCBmb3IgY29uZmlndXJpbmcgc2VydmljZXMgaWYgb25seSBgJGdldGAgbWV0aG9kIGlzIHJlcXVpcmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gJGdldEZuIFRoZSAkZ2V0Rm4gZm9yIHRoZSBpbnN0YW5jZSBjcmVhdGlvbi4gSW50ZXJuYWxseSB0aGlzIGlzIGEgc2hvcnQgaGFuZCBmb3IKICAgICAqIGAkcHJvdmlkZS5wcm92aWRlcihuYW1lLCB7JGdldDogJGdldEZufSlgLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNzZXJ2aWNlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQSBzaG9ydCBoYW5kIGZvciByZWdpc3RlcmluZyBzZXJ2aWNlIG9mIGdpdmVuIGNsYXNzLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY2xhc3MgKGNvbnN0cnVjdG9yIGZ1bmN0aW9uKSB0aGF0IHdpbGwgYmUgaW5zdGFudGlhdGVkLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSN2YWx1ZQogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgc2hvcnQgaGFuZCBmb3IgY29uZmlndXJpbmcgc2VydmljZXMgaWYgdGhlIGAkZ2V0YCBtZXRob2QgaXMgYSBjb25zdGFudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjY29uc3RhbnQKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIGNvbnN0YW50IHZhbHVlLCBidXQgdW5saWtlIHtAbGluayBBVVRPLiRwcm92aWRlI3ZhbHVlIHZhbHVlfSBpdCBjYW4gYmUgaW5qZWN0ZWQKICAgICAqIGludG8gY29uZmlndXJhdGlvbiBmdW5jdGlvbiAob3RoZXIgbW9kdWxlcykgYW5kIGl0IGlzIG5vdCBpbnRlcmNlcHRhYmxlIGJ5CiAgICAgKiB7QGxpbmsgQVVUTy4kcHJvdmlkZSNkZWNvcmF0b3IgZGVjb3JhdG9yfS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgY29uc3RhbnQuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSBjb25zdGFudCB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgaW5zdGFuY2UKICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjZGVjb3JhdG9yCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRGVjb3JhdGlvbiBvZiBzZXJ2aWNlLCBhbGxvd3MgdGhlIGRlY29yYXRvciB0byBpbnRlcmNlcHQgdGhlIHNlcnZpY2UgaW5zdGFuY2UgY3JlYXRpb24uIFRoZQogICAgICogcmV0dXJuZWQgaW5zdGFuY2UgbWF5IGJlIHRoZSBvcmlnaW5hbCBpbnN0YW5jZSwgb3IgYSBuZXcgaW5zdGFuY2Ugd2hpY2ggZGVsZWdhdGVzIHRvIHRoZQogICAgICogb3JpZ2luYWwgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHNlcnZpY2UgdG8gZGVjb3JhdGUuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGRlY29yYXRvciBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgaW52b2tlZCB3aGVuIHRoZSBzZXJ2aWNlIG5lZWRzIHRvIGJlCiAgICAgKiAgICBpbnN0YW50aWF0ZWQuIFRoZSBmdW5jdGlvbiBpcyBjYWxsZWQgdXNpbmcgdGhlIHtAbGluayBBVVRPLiRpbmplY3RvciNpbnZva2UKICAgICAqICAgIGluamVjdG9yLmludm9rZX0gbWV0aG9kIGFuZCBpcyB0aGVyZWZvcmUgZnVsbHkgaW5qZWN0YWJsZS4gTG9jYWwgaW5qZWN0aW9uIGFyZ3VtZW50czoKICAgICAqCiAgICAgKiAgICAqIGAkZGVsZWdhdGVgIC0gVGhlIG9yaWdpbmFsIHNlcnZpY2UgaW5zdGFuY2UsIHdoaWNoIGNhbiBiZSBtb25rZXkgcGF0Y2hlZCwgY29uZmlndXJlZCwKICAgICAqICAgICAgZGVjb3JhdGVkIG9yIGRlbGVnYXRlZCB0by4KICAgICAqLwoKCiAgICBmdW5jdGlvbiBjcmVhdGVJbmplY3Rvcihtb2R1bGVzVG9Mb2FkKSB7CiAgICAgICAgdmFyIElOU1RBTlRJQVRJTkcgPSB7fSwKICAgICAgICAgICAgcHJvdmlkZXJTdWZmaXggPSAnUHJvdmlkZXInLAogICAgICAgICAgICBwYXRoID0gW10sCiAgICAgICAgICAgIGxvYWRlZE1vZHVsZXMgPSBuZXcgSGFzaE1hcCgpLAogICAgICAgICAgICBwcm92aWRlckNhY2hlID0gewogICAgICAgICAgICAgICAgJHByb3ZpZGU6IHsKICAgICAgICAgICAgICAgICAgICBwcm92aWRlcjogc3VwcG9ydE9iamVjdChwcm92aWRlciksCiAgICAgICAgICAgICAgICAgICAgZmFjdG9yeTogc3VwcG9ydE9iamVjdChmYWN0b3J5KSwKICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiBzdXBwb3J0T2JqZWN0KHNlcnZpY2UpLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBzdXBwb3J0T2JqZWN0KHZhbHVlKSwKICAgICAgICAgICAgICAgICAgICBjb25zdGFudDogc3VwcG9ydE9iamVjdChjb25zdGFudCksCiAgICAgICAgICAgICAgICAgICAgZGVjb3JhdG9yOiBkZWNvcmF0b3IKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgcHJvdmlkZXJJbmplY3RvciA9IChwcm92aWRlckNhY2hlLiRpbmplY3RvciA9CiAgICAgICAgICAgICAgICBjcmVhdGVJbnRlcm5hbEluamVjdG9yKHByb3ZpZGVyQ2FjaGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ3VucHInLCAiVW5rbm93biBwcm92aWRlcjogezB9IiwgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgICAgICAgfSkpLAogICAgICAgICAgICBpbnN0YW5jZUNhY2hlID0ge30sCiAgICAgICAgICAgIGluc3RhbmNlSW5qZWN0b3IgPSAoaW5zdGFuY2VDYWNoZS4kaW5qZWN0b3IgPQogICAgICAgICAgICAgICAgY3JlYXRlSW50ZXJuYWxJbmplY3RvcihpbnN0YW5jZUNhY2hlLCBmdW5jdGlvbiAoc2VydmljZW5hbWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChzZXJ2aWNlbmFtZSArIHByb3ZpZGVyU3VmZml4KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2VJbmplY3Rvci5pbnZva2UocHJvdmlkZXIuJGdldCwgcHJvdmlkZXIpOwogICAgICAgICAgICAgICAgfSkpOwoKCiAgICAgICAgZm9yRWFjaChsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKSwgZnVuY3Rpb24gKGZuKSB7IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGZuIHx8IG5vb3ApOyB9KTsKCiAgICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3I7CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vICRwcm92aWRlcgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICBmdW5jdGlvbiBzdXBwb3J0T2JqZWN0KGRlbGVnYXRlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGtleSwgcmV2ZXJzZVBhcmFtcyhkZWxlZ2F0ZSkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVsZWdhdGUoa2V5LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHByb3ZpZGVyKG5hbWUsIHByb3ZpZGVyXykgewogICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihwcm92aWRlcl8pIHx8IGlzQXJyYXkocHJvdmlkZXJfKSkgewogICAgICAgICAgICAgICAgcHJvdmlkZXJfID0gcHJvdmlkZXJJbmplY3Rvci5pbnN0YW50aWF0ZShwcm92aWRlcl8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghcHJvdmlkZXJfLiRnZXQpIHsKICAgICAgICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycigncGdldCcsICJQcm92aWRlciAnezB9JyBtdXN0IGRlZmluZSAkZ2V0IGZhY3RvcnkgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcm92aWRlckNhY2hlW25hbWUgKyBwcm92aWRlclN1ZmZpeF0gPSBwcm92aWRlcl87CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmYWN0b3J5KG5hbWUsIGZhY3RvcnlGbikgeyByZXR1cm4gcHJvdmlkZXIobmFtZSwgeyAkZ2V0OiBmYWN0b3J5Rm4gfSk7IH0KCiAgICAgICAgZnVuY3Rpb24gc2VydmljZShuYW1lLCBjb25zdHJ1Y3RvcikgewogICAgICAgICAgICByZXR1cm4gZmFjdG9yeShuYW1lLCBbJyRpbmplY3RvcicsIGZ1bmN0aW9uICgkaW5qZWN0b3IpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkaW5qZWN0b3IuaW5zdGFudGlhdGUoY29uc3RydWN0b3IpOwogICAgICAgICAgICB9XSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB2YWx1ZShuYW1lLCB2YWx1ZSkgeyByZXR1cm4gZmFjdG9yeShuYW1lLCB2YWx1ZUZuKHZhbHVlKSk7IH0KCiAgICAgICAgZnVuY3Rpb24gY29uc3RhbnQobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgcHJvdmlkZXJDYWNoZVtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICBpbnN0YW5jZUNhY2hlW25hbWVdID0gdmFsdWU7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkZWNvcmF0b3Ioc2VydmljZU5hbWUsIGRlY29yRm4pIHsKICAgICAgICAgICAgdmFyIG9yaWdQcm92aWRlciA9IHByb3ZpZGVySW5qZWN0b3IuZ2V0KHNlcnZpY2VOYW1lICsgcHJvdmlkZXJTdWZmaXgpLAogICAgICAgICAgICAgICAgb3JpZyRnZXQgPSBvcmlnUHJvdmlkZXIuJGdldDsKCiAgICAgICAgICAgIG9yaWdQcm92aWRlci4kZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIG9yaWdJbnN0YW5jZSA9IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKG9yaWckZ2V0LCBvcmlnUHJvdmlkZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGRlY29yRm4sIG51bGwsIHsgJGRlbGVnYXRlOiBvcmlnSW5zdGFuY2UgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBNb2R1bGUgTG9hZGluZwogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIGZ1bmN0aW9uIGxvYWRNb2R1bGVzKG1vZHVsZXNUb0xvYWQpIHsKICAgICAgICAgICAgdmFyIHJ1bkJsb2NrcyA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKG1vZHVsZXNUb0xvYWQsIGZ1bmN0aW9uIChtb2R1bGUpIHsKICAgICAgICAgICAgICAgIGlmIChsb2FkZWRNb2R1bGVzLmdldChtb2R1bGUpKSByZXR1cm47CiAgICAgICAgICAgICAgICBsb2FkZWRNb2R1bGVzLnB1dChtb2R1bGUsIHRydWUpOwoKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKG1vZHVsZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUZuID0gYW5ndWxhck1vZHVsZShtb2R1bGUpOwogICAgICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MgPSBydW5CbG9ja3MuY29uY2F0KGxvYWRNb2R1bGVzKG1vZHVsZUZuLnJlcXVpcmVzKSkuY29uY2F0KG1vZHVsZUZuLl9ydW5CbG9ja3MpOwoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaW52b2tlUXVldWUgPSBtb2R1bGVGbi5faW52b2tlUXVldWUsIGkgPSAwLCBpaSA9IGludm9rZVF1ZXVlLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbnZva2VBcmdzID0gaW52b2tlUXVldWVbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChpbnZva2VBcmdzWzBdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcltpbnZva2VBcmdzWzFdXS5hcHBseShwcm92aWRlciwgaW52b2tlQXJnc1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24obW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MucHVzaChwcm92aWRlckluamVjdG9yLmludm9rZShtb2R1bGUpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkobW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MucHVzaChwcm92aWRlckluamVjdG9yLmludm9rZShtb2R1bGUpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnRBcmdGbihtb2R1bGUsICdtb2R1bGUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGUgPSBtb2R1bGVbbW9kdWxlLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZS5tZXNzYWdlICYmIGUuc3RhY2sgJiYgZS5zdGFjay5pbmRleE9mKGUubWVzc2FnZSkgPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2FmYXJpICYgRkYncyBzdGFjayB0cmFjZXMgZG9uJ3QgY29udGFpbiBlcnJvci5tZXNzYWdlIGNvbnRlbnQgdW5saWtlIHRob3NlIG9mIENocm9tZSBhbmQgSUUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU28gaWYgc3RhY2sgZG9lc24ndCBjb250YWluIG1lc3NhZ2UsIHdlIGNyZWF0ZSBhIG5ldyBzdHJpbmcgdGhhdCBjb250YWlucyBib3RoLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTaW5jZSBlcnJvci5zdGFjayBpcyByZWFkLW9ubHkgaW4gU2FmYXJpLCBJJ20gb3ZlcnJpZGluZyBlIGFuZCBub3QgZS5zdGFjayBoZXJlLgogICAgICAgICAgICAgICAgICAgICAgICBlID0gZS5tZXNzYWdlICsgJ1xuJyArIGUuc3RhY2s7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignbW9kdWxlcnInLCAiRmFpbGVkIHRvIGluc3RhbnRpYXRlIG1vZHVsZSB7MH0gZHVlIHRvOlxuezF9IiwgbW9kdWxlLCBlLnN0YWNrIHx8IGUubWVzc2FnZSB8fCBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBydW5CbG9ja3M7CiAgICAgICAgfQoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBpbnRlcm5hbCBJbmplY3RvcgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGNhY2hlLCBmYWN0b3J5KSB7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRTZXJ2aWNlKHNlcnZpY2VOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAoY2FjaGUuaGFzT3duUHJvcGVydHkoc2VydmljZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlW3NlcnZpY2VOYW1lXSA9PT0gSU5TVEFOVElBVElORykgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ2NkZXAnLCAnQ2lyY3VsYXIgZGVwZW5kZW5jeSBmb3VuZDogezB9JywgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoLnVuc2hpZnQoc2VydmljZU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZVtzZXJ2aWNlTmFtZV0gPSBJTlNUQU5USUFUSU5HOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdID0gZmFjdG9yeShzZXJ2aWNlTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aC5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaW52b2tlKGZuLCBzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW10sCiAgICAgICAgICAgICAgICAgICAgJGluamVjdCA9IGFubm90YXRlKGZuKSwKICAgICAgICAgICAgICAgICAgICBsZW5ndGgsIGksCiAgICAgICAgICAgICAgICAgICAga2V5OwoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9ICRpbmplY3QubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSAkaW5qZWN0W2ldOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ2l0a24nLCAnSW5jb3JyZWN0IGluamVjdGlvbiB0b2tlbiEgRXhwZWN0ZWQgc2VydmljZSBuYW1lIGFzIHN0cmluZywgZ290IHswfScsIGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCgKICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5KQogICAgICAgICAgICAgICAgICAgICAgPyBsb2NhbHNba2V5XQogICAgICAgICAgICAgICAgICAgICAgOiBnZXRTZXJ2aWNlKGtleSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFmbi4kaW5qZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBtZWFucyB0aGF0IHdlIG11c3QgYmUgYW4gYXJyYXkuCiAgICAgICAgICAgICAgICAgICAgZm4gPSBmbltsZW5ndGhdOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvLyBQZXJmb3JtYW5jZSBvcHRpbWl6YXRpb246IGh0dHA6Ly9qc3BlcmYuY29tL2FwcGx5LXZzLWNhbGwtdnMtaW52b2tlCiAgICAgICAgICAgICAgICBzd2l0Y2ggKHNlbGYgPyAtMSA6IGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAwOiByZXR1cm4gZm4oKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBmbihhcmdzWzBdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDI6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDM6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDU6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDY6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDc6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdLCBhcmdzWzZdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDg6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdLCBhcmdzWzZdLCBhcmdzWzddKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDk6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdLCBhcmdzWzZdLCBhcmdzWzddLCBhcmdzWzhdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDEwOiByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSwgYXJnc1s2XSwgYXJnc1s3XSwgYXJnc1s4XSwgYXJnc1s5XSk7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBpbnN0YW50aWF0ZShUeXBlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBDb25zdHJ1Y3RvciA9IGZ1bmN0aW9uICgpIHsgfSwKICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZSwgcmV0dXJuZWRWYWx1ZTsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBUeXBlIGlzIGFubm90YXRlZCBhbmQgdXNlIGp1c3QgdGhlIGdpdmVuIGZ1bmN0aW9uIGF0IG4tMSBhcyBwYXJhbWV0ZXIKICAgICAgICAgICAgICAgIC8vIGUuZy4gc29tZU1vZHVsZS5mYWN0b3J5KCdncmVldGVyJywgWyckd2luZG93JywgZnVuY3Rpb24ocmVuYW1lZCR3aW5kb3cpIHt9XSk7CiAgICAgICAgICAgICAgICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAoaXNBcnJheShUeXBlKSA/IFR5cGVbVHlwZS5sZW5ndGggLSAxXSA6IFR5cGUpLnByb3RvdHlwZTsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gbmV3IENvbnN0cnVjdG9yKCk7CiAgICAgICAgICAgICAgICByZXR1cm5lZFZhbHVlID0gaW52b2tlKFR5cGUsIGluc3RhbmNlLCBsb2NhbHMpOwoKICAgICAgICAgICAgICAgIHJldHVybiBpc09iamVjdChyZXR1cm5lZFZhbHVlKSA/IHJldHVybmVkVmFsdWUgOiBpbnN0YW5jZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGludm9rZTogaW52b2tlLAogICAgICAgICAgICAgICAgaW5zdGFudGlhdGU6IGluc3RhbnRpYXRlLAogICAgICAgICAgICAgICAgZ2V0OiBnZXRTZXJ2aWNlLAogICAgICAgICAgICAgICAgYW5ub3RhdGU6IGFubm90YXRlLAogICAgICAgICAgICAgICAgaGFzOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm92aWRlckNhY2hlLmhhc093blByb3BlcnR5KG5hbWUgKyBwcm92aWRlclN1ZmZpeCkgfHwgY2FjaGUuaGFzT3duUHJvcGVydHkobmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy4kYW5jaG9yU2Nyb2xsCiAgICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAgICogQHJlcXVpcmVzICRsb2NhdGlvbgogICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFdoZW4gY2FsbGVkLCBpdCBjaGVja3MgY3VycmVudCB2YWx1ZSBvZiBgJGxvY2F0aW9uLmhhc2goKWAgYW5kIHNjcm9sbCB0byByZWxhdGVkIGVsZW1lbnQsCiAgICAgKiBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAgICAgKiB7QGxpbmsgaHR0cDovL2Rldi53My5vcmcvaHRtbDUvc3BlYy9PdmVydmlldy5odG1sI3RoZS1pbmRpY2F0ZWQtcGFydC1vZi10aGUtZG9jdW1lbnQgSHRtbDUgc3BlY30uCiAgICAgKgogICAgICogSXQgYWxzbyB3YXRjaGVzIHRoZSBgJGxvY2F0aW9uLmhhc2goKWAgYW5kIHNjcm9sbCB3aGVuZXZlciBpdCBjaGFuZ2VzIHRvIG1hdGNoIGFueSBhbmNob3IuCiAgICAgKiBUaGlzIGNhbiBiZSBkaXNhYmxlZCBieSBjYWxsaW5nIGAkYW5jaG9yU2Nyb2xsUHJvdmlkZXIuZGlzYWJsZUF1dG9TY3JvbGxpbmcoKWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRBbmNob3JTY3JvbGxQcm92aWRlcigpIHsKCiAgICAgICAgdmFyIGF1dG9TY3JvbGxpbmdFbmFibGVkID0gdHJ1ZTsKCiAgICAgICAgdGhpcy5kaXNhYmxlQXV0b1Njcm9sbGluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgYXV0b1Njcm9sbGluZ0VuYWJsZWQgPSBmYWxzZTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGxvY2F0aW9uJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbiAoJHdpbmRvdywgJGxvY2F0aW9uLCAkcm9vdFNjb3BlKSB7CiAgICAgICAgICAgIHZhciBkb2N1bWVudCA9ICR3aW5kb3cuZG9jdW1lbnQ7CgogICAgICAgICAgICAvLyBoZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGZpcnN0IGFuY2hvciBmcm9tIGEgTm9kZUxpc3QKICAgICAgICAgICAgLy8gY2FuJ3QgdXNlIGZpbHRlci5maWx0ZXIsIGFzIGl0IGFjY2VwdHMgb25seSBpbnN0YW5jZXMgb2YgQXJyYXkKICAgICAgICAgICAgLy8gYW5kIElFIGNhbid0IGNvbnZlcnQgTm9kZUxpc3QgdG8gYW4gYXJyYXkgdXNpbmcgW10uc2xpY2UKICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHVzZSBmaWx0ZXIgaWYgd2UgY2hhbmdlIGl0IHRvIGFjY2VwdCBsaXN0cyBhcyB3ZWxsCiAgICAgICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0QW5jaG9yKGxpc3QpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgZm9yRWFjaChsaXN0LCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgIGlmICghcmVzdWx0ICYmIGxvd2VyY2FzZShlbGVtZW50Lm5vZGVOYW1lKSA9PT0gJ2EnKSByZXN1bHQgPSBlbGVtZW50OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBzY3JvbGwoKSB7CiAgICAgICAgICAgICAgICB2YXIgaGFzaCA9ICRsb2NhdGlvbi5oYXNoKCksIGVsbTsKCiAgICAgICAgICAgICAgICAvLyBlbXB0eSBoYXNoLCBzY3JvbGwgdG8gdGhlIHRvcCBvZiB0aGUgcGFnZQogICAgICAgICAgICAgICAgaWYgKCFoYXNoKSAkd2luZG93LnNjcm9sbFRvKDAsIDApOwoKICAgICAgICAgICAgICAgICAgICAvLyBlbGVtZW50IHdpdGggZ2l2ZW4gaWQKICAgICAgICAgICAgICAgIGVsc2UgaWYgKChlbG0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChoYXNoKSkpIGVsbS5zY3JvbGxJbnRvVmlldygpOwoKICAgICAgICAgICAgICAgICAgICAvLyBmaXJzdCBhbmNob3Igd2l0aCBnaXZlbiBuYW1lIDotRAogICAgICAgICAgICAgICAgZWxzZSBpZiAoKGVsbSA9IGdldEZpcnN0QW5jaG9yKGRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lKGhhc2gpKSkpIGVsbS5zY3JvbGxJbnRvVmlldygpOwoKICAgICAgICAgICAgICAgICAgICAvLyBubyBlbGVtZW50IGFuZCBoYXNoID09ICd0b3AnLCBzY3JvbGwgdG8gdGhlIHRvcCBvZiB0aGUgcGFnZQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaGFzaCA9PT0gJ3RvcCcpICR3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGRvZXMgbm90IHNjcm9sbCB3aGVuIHVzZXIgY2xpY2tzIG9uIGFuY2hvciBsaW5rIHRoYXQgaXMgY3VycmVudGx5IG9uCiAgICAgICAgICAgIC8vIChubyB1cmwgY2hhbmdlLCBubyAkbG9jYXRpb24uaGFzaCgpIGNoYW5nZSksIGJyb3dzZXIgbmF0aXZlIGRvZXMgc2Nyb2xsCiAgICAgICAgICAgIGlmIChhdXRvU2Nyb2xsaW5nRW5hYmxlZCkgewogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kd2F0Y2goZnVuY3Rpb24gYXV0b1Njcm9sbFdhdGNoKCkgeyByZXR1cm4gJGxvY2F0aW9uLmhhc2goKTsgfSwKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gYXV0b1Njcm9sbFdhdGNoQWN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKHNjcm9sbCk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gc2Nyb2xsOwogICAgICAgIH1dOwogICAgfQoKICAgIHZhciAkYW5pbWF0ZU1pbkVyciA9IG1pbkVycignJGFuaW1hdGUnKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRhbmltYXRlUHJvdmlkZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgJGFuaW1hdGUgdGhhdCBkb2Vzbid0IHBlcmZvcm0gYW55IGFuaW1hdGlvbnMsIGluc3RlYWQganVzdCBzeW5jaHJvbm91c2x5IHBlcmZvcm1zIERPTQogICAgICogdXBkYXRlcyBhbmQgY2FsbHMgZG9uZSgpIGNhbGxiYWNrcy4KICAgICAqCiAgICAgKiBJbiBvcmRlciB0byBlbmFibGUgYW5pbWF0aW9ucyB0aGUgbmdBbmltYXRlIG1vZHVsZSBoYXMgdG8gYmUgbG9hZGVkLgogICAgICoKICAgICAqIFRvIHNlZSB0aGUgZnVuY3Rpb25hbCBpbXBsZW1lbnRhdGlvbiBjaGVjayBvdXQgc3JjL25nQW5pbWF0ZS9hbmltYXRlLmpzCiAgICAgKi8KICAgIHZhciAkQW5pbWF0ZVByb3ZpZGVyID0gWyckcHJvdmlkZScsIGZ1bmN0aW9uICgkcHJvdmlkZSkgewoKICAgICAgICB0aGlzLiQkc2VsZWN0b3JzID0ge307CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kYW5pbWF0ZVByb3ZpZGVyI3JlZ2lzdGVyCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRhbmltYXRlUHJvdmlkZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlZ2lzdGVycyBhIG5ldyBpbmplY3RhYmxlIGFuaW1hdGlvbiBmYWN0b3J5IGZ1bmN0aW9uLiBUaGUgZmFjdG9yeSBmdW5jdGlvbiBwcm9kdWNlcyB0aGUgYW5pbWF0aW9uIG9iamVjdCB3aGljaAogICAgICAgICAqIGNvbnRhaW5zIGNhbGxiYWNrIGZ1bmN0aW9ucyBmb3IgZWFjaCBldmVudCB0aGF0IGlzIGV4cGVjdGVkIHRvIGJlIGFuaW1hdGVkLgogICAgICAgICAqCiAgICAgICAgICogICAqIGBldmVudEZuYDogYGZ1bmN0aW9uKEVsZW1lbnQsIGRvbmVGdW5jdGlvbilgIFRoZSBlbGVtZW50IHRvIGFuaW1hdGUsIHRoZSBgZG9uZUZ1bmN0aW9uYCBtdXN0IGJlIGNhbGxlZCBvbmNlIHRoZQogICAgICAgICAqICAgZWxlbWVudCBhbmltYXRpb24gaXMgY29tcGxldGUuIElmIGEgZnVuY3Rpb24gaXMgcmV0dXJuZWQgdGhlbiB0aGUgYW5pbWF0aW9uIHNlcnZpY2Ugd2lsbCB1c2UgdGhpcyBmdW5jdGlvbiB0bwogICAgICAgICAqICAgY2FuY2VsIHRoZSBhbmltYXRpb24gd2hlbmV2ZXIgYSBjYW5jZWwgZXZlbnQgaXMgdHJpZ2dlcmVkLgogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKjxwcmU+CiAgICAgICAgICogICByZXR1cm4gewogICAgICAgICAgICogICAgIGV2ZW50Rm4gOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7CiAgICAgICAgICAgKiAgICAgICAvL2NvZGUgdG8gcnVuIHRoZSBhbmltYXRpb24KICAgICAgICAgICAqICAgICAgIC8vb25jZSBjb21wbGV0ZSwgdGhlbiBydW4gZG9uZSgpCiAgICAgICAgICAgKiAgICAgICByZXR1cm4gZnVuY3Rpb24gY2FuY2VsbGF0aW9uRnVuY3Rpb24oKSB7CiAgICAgICAgICAgKiAgICAgICAgIC8vY29kZSB0byBjYW5jZWwgdGhlIGFuaW1hdGlvbgogICAgICAgICAgICogICAgICAgfQogICAgICAgICAgICogICAgIH0KICAgICAgICAgICAqICAgfQogICAgICAgICAqPC9wcmU+CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgYW5pbWF0aW9uLgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGZhY3RvcnkgVGhlIGZhY3RvcnkgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIHRvIHJldHVybiB0aGUgYW5pbWF0aW9uIG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnJlZ2lzdGVyID0gZnVuY3Rpb24gKG5hbWUsIGZhY3RvcnkpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG5hbWUgKyAnLWFuaW1hdGlvbic7CiAgICAgICAgICAgIGlmIChuYW1lICYmIG5hbWUuY2hhckF0KDApICE9ICcuJykgdGhyb3cgJGFuaW1hdGVNaW5FcnIoJ25vdGNzZWwnLAogICAgICAgICAgICAgICAgIkV4cGVjdGluZyBjbGFzcyBzZWxlY3RvciBzdGFydGluZyB3aXRoICcuJyBnb3QgJ3swfScuIiwgbmFtZSk7CiAgICAgICAgICAgIHRoaXMuJCRzZWxlY3RvcnNbbmFtZS5zdWJzdHIoMSldID0ga2V5OwogICAgICAgICAgICAkcHJvdmlkZS5mYWN0b3J5KGtleSwgZmFjdG9yeSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckdGltZW91dCcsIGZ1bmN0aW9uICgkdGltZW91dCkgewoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAgICAgICAgICogQG5hbWUgbmcuJGFuaW1hdGUKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFRoZSAkYW5pbWF0ZSBzZXJ2aWNlIHByb3ZpZGVzIHJ1ZGltZW50YXJ5IERPTSBtYW5pcHVsYXRpb24gZnVuY3Rpb25zIHRvIGluc2VydCwgcmVtb3ZlLCBtb3ZlIGVsZW1lbnRzIHdpdGhpbgogICAgICAgICAgICAgKiB0aGUgRE9NIGFzIHdlbGwgYXMgYWRkaW5nIGFuZCByZW1vdmluZyBjbGFzc2VzLiBUaGlzIHNlcnZpY2UgaXMgdGhlIGNvcmUgc2VydmljZSB1c2VkIGJ5IHRoZSBuZ0FuaW1hdGUgJGFuaW1hdG9yCiAgICAgICAgICAgICAqIHNlcnZpY2Ugd2hpY2ggcHJvdmlkZXMgaGlnaC1sZXZlbCBhbmltYXRpb24gaG9va3MgZm9yIENTUyBhbmQgSmF2YVNjcmlwdC4gCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICRhbmltYXRlIGlzIGF2YWlsYWJsZSBpbiB0aGUgQW5ndWxhckpTIGNvcmUsIGhvd2V2ZXIsIHRoZSBuZ0FuaW1hdGUgbW9kdWxlIG11c3QgYmUgaW5jbHVkZWQgdG8gZW5hYmxlIGZ1bGwgb3V0CiAgICAgICAgICAgICAqIGFuaW1hdGlvbiBzdXBwb3J0LiBPdGhlcndpc2UsICRhbmltYXRlIHdpbGwgb25seSBwZXJmb3JtIHNpbXBsZSBET00gbWFuaXB1bGF0aW9uIG9wZXJhdGlvbnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRvIGxlYXJuIG1vcmUgYWJvdXQgZW5hYmxpbmcgYW5pbWF0aW9uIHN1cHBvcnQsIGNsaWNrIGhlcmUgdG8gdmlzaXQgdGhlIHtAbGluayBuZ0FuaW1hdGUgbmdBbmltYXRlIG1vZHVsZSBwYWdlfQogICAgICAgICAgICAgKiBhcyB3ZWxsIGFzIHRoZSB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlIG5nQW5pbWF0ZSAkYW5pbWF0ZSBzZXJ2aWNlIHBhZ2V9LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcmV0dXJuIHsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGFuaW1hdGUjZW50ZXIKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kYW5pbWF0ZQogICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBJbnNlcnRzIHRoZSBlbGVtZW50IGludG8gdGhlIERPTSBlaXRoZXIgYWZ0ZXIgdGhlIGBhZnRlcmAgZWxlbWVudCBvciB3aXRoaW4gdGhlIGBwYXJlbnRgIGVsZW1lbnQuIE9uY2UgY29tcGxldGUsCiAgICAgICAgICAgICAgICAgKiB0aGUgZG9uZSgpIGNhbGxiYWNrIHdpbGwgYmUgZmlyZWQgKGlmIHByb3ZpZGVkKS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2pRdWVyeS9qcUxpdGUgZWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGJlIGluc2VydGVkIGludG8gdGhlIERPTQogICAgICAgICAgICAgICAgICogQHBhcmFtIHtqUXVlcnkvanFMaXRlIGVsZW1lbnR9IHBhcmVudCB0aGUgcGFyZW50IGVsZW1lbnQgd2hpY2ggd2lsbCBhcHBlbmQgdGhlIGVsZW1lbnQgYXMgYSBjaGlsZCAoaWYgdGhlIGFmdGVyIGVsZW1lbnQgaXMgbm90IHByZXNlbnQpCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2pRdWVyeS9qcUxpdGUgZWxlbWVudH0gYWZ0ZXIgdGhlIHNpYmxpbmcgZWxlbWVudCB3aGljaCB3aWxsIGFwcGVuZCB0aGUgZWxlbWVudCBhZnRlciBpdHNlbGYKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb249fSBkb25lIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgdGhlIGVsZW1lbnQgaGFzIGJlZW4gaW5zZXJ0ZWQgaW50byB0aGUgRE9NCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbiAoZWxlbWVudCwgcGFyZW50LCBhZnRlciwgZG9uZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBhZnRlck5vZGUgPSBhZnRlciAmJiBhZnRlclthZnRlci5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHBhcmVudCAmJiBwYXJlbnRbMF0gfHwgYWZ0ZXJOb2RlICYmIGFmdGVyTm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIC8vIElFIGRvZXMgbm90IGxpa2UgdW5kZWZpbmVkIHNvIHdlIGhhdmUgdG8gcGFzcyBudWxsLgogICAgICAgICAgICAgICAgICAgIHZhciBhZnRlck5leHRTaWJsaW5nID0gKGFmdGVyTm9kZSAmJiBhZnRlck5vZGUubmV4dFNpYmxpbmcpIHx8IG51bGw7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnROb2RlLmluc2VydEJlZm9yZShub2RlLCBhZnRlck5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBkb25lICYmICR0aW1lb3V0KGRvbmUsIDAsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRhbmltYXRlI2xlYXZlCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGFuaW1hdGUKICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogUmVtb3ZlcyB0aGUgZWxlbWVudCBmcm9tIHRoZSBET00uIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7alF1ZXJ5L2pxTGl0ZSBlbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBET00KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb249fSBkb25lIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgdGhlIGVsZW1lbnQgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tIHRoZSBET00KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uIChlbGVtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICBkb25lICYmICR0aW1lb3V0KGRvbmUsIDAsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRhbmltYXRlI21vdmUKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kYW5pbWF0ZQogICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBNb3ZlcyB0aGUgcG9zaXRpb24gb2YgdGhlIHByb3ZpZGVkIGVsZW1lbnQgd2l0aGluIHRoZSBET00gdG8gYmUgcGxhY2VkIGVpdGhlciBhZnRlciB0aGUgYGFmdGVyYCBlbGVtZW50IG9yIGluc2lkZSBvZiB0aGUgYHBhcmVudGAgZWxlbWVudC4KICAgICAgICAgICAgICAgICAqIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7alF1ZXJ5L2pxTGl0ZSBlbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgYmUgbW92ZWQgYXJvdW5kIHdpdGhpbiB0aGUgRE9NCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2pRdWVyeS9qcUxpdGUgZWxlbWVudH0gcGFyZW50IHRoZSBwYXJlbnQgZWxlbWVudCB3aGVyZSB0aGUgZWxlbWVudCB3aWxsIGJlIGluc2VydGVkIGludG8gKGlmIHRoZSBhZnRlciBlbGVtZW50IGlzIG5vdCBwcmVzZW50KQogICAgICAgICAgICAgICAgICogQHBhcmFtIHtqUXVlcnkvanFMaXRlIGVsZW1lbnR9IGFmdGVyIHRoZSBzaWJsaW5nIGVsZW1lbnQgd2hlcmUgdGhlIGVsZW1lbnQgd2lsbCBiZSBwb3NpdGlvbmVkIG5leHQgdG8KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb249fSBkb25lIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAoaWYgcHJvdmlkZWQpIHRoYXQgd2lsbCBiZSBmaXJlZCBhZnRlciB0aGUgZWxlbWVudCBoYXMgYmVlbiBtb3ZlZCB0byBpdCdzIG5ldyBwb3NpdGlvbgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBtb3ZlOiBmdW5jdGlvbiAoZWxlbWVudCwgcGFyZW50LCBhZnRlciwgZG9uZSkgewogICAgICAgICAgICAgICAgICAgIC8vIERvIG5vdCByZW1vdmUgZWxlbWVudCBiZWZvcmUgaW5zZXJ0LiBSZW1vdmluZyB3aWxsIGNhdXNlIGRhdGEgYXNzb2NpYXRlZCB3aXRoIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGVsZW1lbnQgdG8gYmUgZHJvcHBlZC4gSW5zZXJ0IHdpbGwgaW1wbGljaXRseSBkbyB0aGUgcmVtb3ZlLgogICAgICAgICAgICAgICAgICAgIHRoaXMuZW50ZXIoZWxlbWVudCwgcGFyZW50LCBhZnRlciwgZG9uZSk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kYW5pbWF0ZSNhZGRDbGFzcwogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRhbmltYXRlCiAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIEFkZHMgdGhlIHByb3ZpZGVkIGNsYXNzTmFtZSBDU1MgY2xhc3MgdmFsdWUgdG8gdGhlIHByb3ZpZGVkIGVsZW1lbnQuIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7alF1ZXJ5L2pxTGl0ZSBlbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgaGF2ZSB0aGUgY2xhc3NOYW1lIHZhbHVlIGFkZGVkIHRvIGl0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbj19IGRvbmUgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBwcm92aWRlZCkgdGhhdCB3aWxsIGJlIGZpcmVkIGFmdGVyIHRoZSBjbGFzc05hbWUgdmFsdWUgaGFzIGJlZW4gYWRkZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgYWRkQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBjbGFzc05hbWUsIGRvbmUpIHsKICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSBpc1N0cmluZyhjbGFzc05hbWUpID8KICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzQXJyYXkoY2xhc3NOYW1lKSA/IGNsYXNzTmFtZS5qb2luKCcgJykgOiAnJzsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgZG9uZSAmJiAkdGltZW91dChkb25lLCAwLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kYW5pbWF0ZSNyZW1vdmVDbGFzcwogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRhbmltYXRlCiAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFJlbW92ZXMgdGhlIHByb3ZpZGVkIGNsYXNzTmFtZSBDU1MgY2xhc3MgdmFsdWUgZnJvbSB0aGUgcHJvdmlkZWQgZWxlbWVudC4gT25jZSBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtqUXVlcnkvanFMaXRlIGVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBoYXZlIHRoZSBjbGFzc05hbWUgdmFsdWUgcmVtb3ZlZCBmcm9tIGl0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb249fSBkb25lIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAoaWYgcHJvdmlkZWQpIHRoYXQgd2lsbCBiZSBmaXJlZCBhZnRlciB0aGUgY2xhc3NOYW1lIHZhbHVlIGhhcyBiZWVuIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICByZW1vdmVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgewogICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9IGlzU3RyaW5nKGNsYXNzTmFtZSkgPwogICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWUgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNBcnJheShjbGFzc05hbWUpID8gY2xhc3NOYW1lLmpvaW4oJyAnKSA6ICcnOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgICBkb25lICYmICR0aW1lb3V0KGRvbmUsIDAsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZW5hYmxlZDogbm9vcAogICAgICAgICAgICB9OwogICAgICAgIH1dOwogICAgfV07CgogICAgLyoqCiAgICAgKiAhIFRoaXMgaXMgYSBwcml2YXRlIHVuZG9jdW1lbnRlZCBzZXJ2aWNlICEKICAgICAqCiAgICAgKiBAbmFtZSBuZy4kYnJvd3NlcgogICAgICogQHJlcXVpcmVzICRsb2cKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhpcyBvYmplY3QgaGFzIHR3byBnb2FsczoKICAgICAqCiAgICAgKiAtIGhpZGUgYWxsIHRoZSBnbG9iYWwgc3RhdGUgaW4gdGhlIGJyb3dzZXIgY2F1c2VkIGJ5IHRoZSB3aW5kb3cgb2JqZWN0CiAgICAgKiAtIGFic3RyYWN0IGF3YXkgYWxsIHRoZSBicm93c2VyIHNwZWNpZmljIGZlYXR1cmVzIGFuZCBpbmNvbnNpc3RlbmNpZXMKICAgICAqCiAgICAgKiBGb3IgdGVzdHMgd2UgcHJvdmlkZSB7QGxpbmsgbmdNb2NrLiRicm93c2VyIG1vY2sgaW1wbGVtZW50YXRpb259IG9mIHRoZSBgJGJyb3dzZXJgCiAgICAgKiBzZXJ2aWNlLCB3aGljaCBjYW4gYmUgdXNlZCBmb3IgY29udmVuaWVudCB0ZXN0aW5nIG9mIHRoZSBhcHBsaWNhdGlvbiB3aXRob3V0IHRoZSBpbnRlcmFjdGlvbiB3aXRoCiAgICAgKiB0aGUgcmVhbCBicm93c2VyIGFwaXMuCiAgICAgKi8KICAgIC8qKgogICAgICogQHBhcmFtIHtvYmplY3R9IHdpbmRvdyBUaGUgZ2xvYmFsIHdpbmRvdyBvYmplY3QuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZG9jdW1lbnQgalF1ZXJ5IHdyYXBwZWQgZG9jdW1lbnQuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IFhIUiBYTUxIdHRwUmVxdWVzdCBjb25zdHJ1Y3Rvci4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSAkbG9nIGNvbnNvbGUubG9nIG9yIGFuIG9iamVjdCB3aXRoIHRoZSBzYW1lIGludGVyZmFjZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSAkc25pZmZlciAkc25pZmZlciBzZXJ2aWNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIEJyb3dzZXIod2luZG93LCBkb2N1bWVudCwgJGxvZywgJHNuaWZmZXIpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgICAgIHJhd0RvY3VtZW50ID0gZG9jdW1lbnRbMF0sCiAgICAgICAgICAgIGxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uLAogICAgICAgICAgICBoaXN0b3J5ID0gd2luZG93Lmhpc3RvcnksCiAgICAgICAgICAgIHNldFRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCwKICAgICAgICAgICAgY2xlYXJUaW1lb3V0ID0gd2luZG93LmNsZWFyVGltZW91dCwKICAgICAgICAgICAgcGVuZGluZ0RlZmVySWRzID0ge307CgogICAgICAgIHNlbGYuaXNNb2NrID0gZmFsc2U7CgogICAgICAgIHZhciBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9IDA7CiAgICAgICAgdmFyIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcyA9IFtdOwoKICAgICAgICAvLyBUT0RPKHZvanRhKTogcmVtb3ZlIHRoaXMgdGVtcG9yYXJ5IGFwaQogICAgICAgIHNlbGYuJCRjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdCA9IGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0OwogICAgICAgIHNlbGYuJCRpbmNPdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9IGZ1bmN0aW9uICgpIHsgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogRXhlY3V0ZXMgdGhlIGBmbmAgZnVuY3Rpb24oc3VwcG9ydHMgY3VycnlpbmcpIGFuZCBkZWNyZW1lbnRzIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYAogICAgICAgICAqIGNvdW50ZXIuIElmIHRoZSBjb3VudGVyIHJlYWNoZXMgMCwgYWxsIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYCBhcmUgZXhlY3V0ZWQuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZuLmFwcGx5KG51bGwsIHNsaWNlQXJncyhhcmd1bWVudHMsIDEpKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50LS07CiAgICAgICAgICAgICAgICBpZiAob3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAob3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzLnBvcCgpKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2cuZXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogTm90ZTogdGhpcyBtZXRob2QgaXMgdXNlZCBvbmx5IGJ5IHNjZW5hcmlvIHJ1bm5lcgogICAgICAgICAqIFRPRE8odm9qdGEpOiBwcmVmaXggdGhpcyBtZXRob2Qgd2l0aCAkJCA/CiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBjYWxsYmFjayBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gbm8gb3V0c3RhbmRpbmcgcmVxdWVzdAogICAgICAgICAqLwogICAgICAgIHNlbGYubm90aWZ5V2hlbk5vT3V0c3RhbmRpbmdSZXF1ZXN0cyA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAvLyBmb3JjZSBicm93c2VyIHRvIGV4ZWN1dGUgYWxsIHBvbGxGbnMgLSB0aGlzIGlzIG5lZWRlZCBzbyB0aGF0IGNvb2tpZXMgYW5kIG90aGVyIHBvbGxlcnMgZmlyZQogICAgICAgICAgICAvLyBhdCBzb21lIGRldGVybWluaXN0aWMgdGltZSBpbiByZXNwZWN0IHRvIHRoZSB0ZXN0IHJ1bm5lcidzIGFjdGlvbnMuIExlYXZpbmcgdGhpbmdzIHVwIHRvIHRoZQogICAgICAgICAgICAvLyByZWd1bGFyIHBvbGxlciB3b3VsZCByZXN1bHQgaW4gZmxha3kgdGVzdHMuCiAgICAgICAgICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24gKHBvbGxGbikgeyBwb2xsRm4oKTsgfSk7CgogICAgICAgICAgICBpZiAob3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vIFBvbGwgV2F0Y2hlciBBUEkKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIHZhciBwb2xsRm5zID0gW10sCiAgICAgICAgICAgIHBvbGxUaW1lb3V0OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNhZGRQb2xsRm4KICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gUG9sbCBmdW5jdGlvbiB0byBhZGQKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEFkZHMgYSBmdW5jdGlvbiB0byB0aGUgbGlzdCBvZiBmdW5jdGlvbnMgdGhhdCBwb2xsZXIgcGVyaW9kaWNhbGx5IGV4ZWN1dGVzLAogICAgICAgICAqIGFuZCBzdGFydHMgcG9sbGluZyBpZiBub3Qgc3RhcnRlZCB5ZXQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gdGhlIGFkZGVkIGZ1bmN0aW9uCiAgICAgICAgICovCiAgICAgICAgc2VsZi5hZGRQb2xsRm4gPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHBvbGxUaW1lb3V0KSkgc3RhcnRQb2xsZXIoMTAwLCBzZXRUaW1lb3V0KTsKICAgICAgICAgICAgcG9sbEZucy5wdXNoKGZuKTsKICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbnRlcnZhbCBIb3cgb2Z0ZW4gc2hvdWxkIGJyb3dzZXIgY2FsbCBwb2xsIGZ1bmN0aW9ucyAobXMpCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBzZXRUaW1lb3V0IFJlZmVyZW5jZSB0byBhIHJlYWwgb3IgZmFrZSBgc2V0VGltZW91dGAgZnVuY3Rpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDb25maWd1cmVzIHRoZSBwb2xsZXIgdG8gcnVuIGluIHRoZSBzcGVjaWZpZWQgaW50ZXJ2YWxzLCB1c2luZyB0aGUgc3BlY2lmaWVkCiAgICAgICAgICogc2V0VGltZW91dCBmbiBhbmQga2lja3MgaXQgb2ZmLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UG9sbGVyKGludGVydmFsLCBzZXRUaW1lb3V0KSB7CiAgICAgICAgICAgIChmdW5jdGlvbiBjaGVjaygpIHsKICAgICAgICAgICAgICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24gKHBvbGxGbikgeyBwb2xsRm4oKTsgfSk7CiAgICAgICAgICAgICAgICBwb2xsVGltZW91dCA9IHNldFRpbWVvdXQoY2hlY2ssIGludGVydmFsKTsKICAgICAgICAgICAgfSkoKTsKICAgICAgICB9CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gVVJMIEFQSQogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIHZhciBsYXN0QnJvd3NlclVybCA9IGxvY2F0aW9uLmhyZWYsCiAgICAgICAgICAgIGJhc2VFbGVtZW50ID0gZG9jdW1lbnQuZmluZCgnYmFzZScpLAogICAgICAgICAgICByZXBsYWNlZFVybCA9IG51bGw7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI3VybAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogR0VUVEVSOgogICAgICAgICAqIFdpdGhvdXQgYW55IGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBqdXN0IHJldHVybnMgY3VycmVudCB2YWx1ZSBvZiBsb2NhdGlvbi5ocmVmLgogICAgICAgICAqCiAgICAgICAgICogU0VUVEVSOgogICAgICAgICAqIFdpdGggYXQgbGVhc3Qgb25lIGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBzZXRzIHVybCB0byBuZXcgdmFsdWUuCiAgICAgICAgICogSWYgaHRtbDUgaGlzdG9yeSBhcGkgc3VwcG9ydGVkLCBwdXNoU3RhdGUvcmVwbGFjZVN0YXRlIGlzIHVzZWQsIG90aGVyd2lzZQogICAgICAgICAqIGxvY2F0aW9uLmhyZWYvbG9jYXRpb24ucmVwbGFjZSBpcyB1c2VkLgogICAgICAgICAqIFJldHVybnMgaXRzIG93biBpbnN0YW5jZSB0byBhbGxvdyBjaGFpbmluZwogICAgICAgICAqCiAgICAgICAgICogTk9URTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBjaGFuZ2UgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBOZXcgdXJsICh3aGVuIHVzZWQgYXMgc2V0dGVyKQogICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHJlcGxhY2UgU2hvdWxkIG5ldyB1cmwgcmVwbGFjZSBjdXJyZW50IGhpc3RvcnkgcmVjb3JkID8KICAgICAgICAgKi8KICAgICAgICBzZWxmLnVybCA9IGZ1bmN0aW9uICh1cmwsIHJlcGxhY2UpIHsKICAgICAgICAgICAgLy8gc2V0dGVyCiAgICAgICAgICAgIGlmICh1cmwpIHsKICAgICAgICAgICAgICAgIGlmIChsYXN0QnJvd3NlclVybCA9PSB1cmwpIHJldHVybjsKICAgICAgICAgICAgICAgIGxhc3RCcm93c2VyVXJsID0gdXJsOwogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhpc3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZSkgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgJycsIHVybCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhpc3RvcnkucHVzaFN0YXRlKG51bGwsICcnLCB1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBDcmF6eSBPcGVyYSBCdWc6IGh0dHA6Ly9teS5vcGVyYS5jb20vY29tbXVuaXR5L2ZvcnVtcy90b3BpYy5kbWw/aWQ9MTE4NTQ2MgogICAgICAgICAgICAgICAgICAgICAgICBiYXNlRWxlbWVudC5hdHRyKCdocmVmJywgYmFzZUVsZW1lbnQuYXR0cignaHJlZicpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLnJlcGxhY2UodXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZWRVcmwgPSB1cmw7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb24uaHJlZiA9IHVybDsKICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZWRVcmwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgICAgICAgICAgLy8gZ2V0dGVyCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAtIHRoZSByZXBsYWNlZFVybCBpcyBhIHdvcmthcm91bmQgZm9yIGFuIElFOC05IGlzc3VlIHdpdGggbG9jYXRpb24ucmVwbGFjZSBtZXRob2QgdGhhdCBkb2Vzbid0IHVwZGF0ZQogICAgICAgICAgICAgICAgLy8gICBsb2NhdGlvbi5ocmVmIHN5bmNocm9ub3VzbHkKICAgICAgICAgICAgICAgIC8vIC0gdGhlIHJlcGxhY2VtZW50IGlzIGEgd29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NDA3MTcyCiAgICAgICAgICAgICAgICByZXR1cm4gcmVwbGFjZWRVcmwgfHwgbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8lMjcvZywgIiciKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciB1cmxDaGFuZ2VMaXN0ZW5lcnMgPSBbXSwKICAgICAgICAgICAgdXJsQ2hhbmdlSW5pdCA9IGZhbHNlOwoKICAgICAgICBmdW5jdGlvbiBmaXJlVXJsQ2hhbmdlKCkgewogICAgICAgICAgICBpZiAobGFzdEJyb3dzZXJVcmwgPT0gc2VsZi51cmwoKSkgcmV0dXJuOwoKICAgICAgICAgICAgbGFzdEJyb3dzZXJVcmwgPSBzZWxmLnVybCgpOwogICAgICAgICAgICBmb3JFYWNoKHVybENoYW5nZUxpc3RlbmVycywgZnVuY3Rpb24gKGxpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5lcihzZWxmLnVybCgpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNvblVybENoYW5nZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqIEBUT0RPKHZvanRhKTogcmVmYWN0b3IgdG8gdXNlIG5vZGUncyBzeW50YXggZm9yIGV2ZW50cwogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogUmVnaXN0ZXIgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCwgd2hlbiB1cmwgY2hhbmdlcy4KICAgICAgICAgKgogICAgICAgICAqIEl0J3Mgb25seSBjYWxsZWQgd2hlbiB0aGUgdXJsIGlzIGNoYW5nZWQgYnkgb3V0c2lkZSBvZiBhbmd1bGFyOgogICAgICAgICAqIC0gdXNlciB0eXBlcyBkaWZmZXJlbnQgdXJsIGludG8gYWRkcmVzcyBiYXIKICAgICAgICAgKiAtIHVzZXIgY2xpY2tzIG9uIGhpc3RvcnkgKGZvcndhcmQvYmFjaykgYnV0dG9uCiAgICAgICAgICogLSB1c2VyIGNsaWNrcyBvbiBhIGxpbmsKICAgICAgICAgKgogICAgICAgICAqIEl0J3Mgbm90IGNhbGxlZCB3aGVuIHVybCBpcyBjaGFuZ2VkIGJ5ICRicm93c2VyLnVybCgpIG1ldGhvZAogICAgICAgICAqCiAgICAgICAgICogVGhlIGxpc3RlbmVyIGdldHMgY2FsbGVkIHdpdGggbmV3IHVybCBhcyBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBOT1RFOiB0aGlzIGFwaSBpcyBpbnRlbmRlZCBmb3IgdXNlIG9ubHkgYnkgdGhlICRsb2NhdGlvbiBzZXJ2aWNlLiBQbGVhc2UgdXNlIHRoZQogICAgICAgICAqIHtAbGluayBuZy4kbG9jYXRpb24gJGxvY2F0aW9uIHNlcnZpY2V9IHRvIG1vbml0b3IgdXJsIGNoYW5nZXMgaW4gYW5ndWxhciBhcHBzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihzdHJpbmcpfSBsaXN0ZW5lciBMaXN0ZW5lciBmdW5jdGlvbiB0byBiZSBjYWxsZWQgd2hlbiB1cmwgY2hhbmdlcy4KICAgICAgICAgKiBAcmV0dXJuIHtmdW5jdGlvbihzdHJpbmcpfSBSZXR1cm5zIHRoZSByZWdpc3RlcmVkIGxpc3RlbmVyIGZuIC0gaGFuZHkgaWYgdGhlIGZuIGlzIGFub255bW91cy4KICAgICAgICAgKi8KICAgICAgICBzZWxmLm9uVXJsQ2hhbmdlID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmICghdXJsQ2hhbmdlSW5pdCkgewogICAgICAgICAgICAgICAgLy8gV2UgbGlzdGVuIG9uIGJvdGggKGhhc2hjaGFuZ2UvcG9wc3RhdGUpIHdoZW4gYXZhaWxhYmxlLCBhcyBzb21lIGJyb3dzZXJzIChlLmcuIE9wZXJhKQogICAgICAgICAgICAgICAgLy8gZG9uJ3QgZmlyZSBwb3BzdGF0ZSB3aGVuIHVzZXIgY2hhbmdlIHRoZSBhZGRyZXNzIGJhciBhbmQgZG9uJ3QgZmlyZSBoYXNoY2hhbmdlIHdoZW4gdXJsCiAgICAgICAgICAgICAgICAvLyBjaGFuZ2VkIGJ5IHB1c2gvcmVwbGFjZVN0YXRlCgogICAgICAgICAgICAgICAgLy8gaHRtbDUgaGlzdG9yeSBhcGkgLSBwb3BzdGF0ZSBldmVudAogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhpc3RvcnkpIGpxTGl0ZSh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIGZpcmVVcmxDaGFuZ2UpOwogICAgICAgICAgICAgICAgLy8gaGFzaGNoYW5nZSBldmVudAogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhhc2hjaGFuZ2UpIGpxTGl0ZSh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgZmlyZVVybENoYW5nZSk7CiAgICAgICAgICAgICAgICAgICAgLy8gcG9sbGluZwogICAgICAgICAgICAgICAgZWxzZSBzZWxmLmFkZFBvbGxGbihmaXJlVXJsQ2hhbmdlKTsKCiAgICAgICAgICAgICAgICB1cmxDaGFuZ2VJbml0ID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdXJsQ2hhbmdlTGlzdGVuZXJzLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICAgICAgfTsKCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBNaXNjIEFQSQogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgY3VycmVudCA8YmFzZSBocmVmPgogICAgICAgICAqIChhbHdheXMgcmVsYXRpdmUgLSB3aXRob3V0IGRvbWFpbikKICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmc9fQogICAgICAgICAqLwogICAgICAgIHNlbGYuYmFzZUhyZWYgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBocmVmID0gYmFzZUVsZW1lbnQuYXR0cignaHJlZicpOwogICAgICAgICAgICByZXR1cm4gaHJlZiA/IGhyZWYucmVwbGFjZSgvXmh0dHBzP1w6XC9cL1teXC9dKi8sICcnKSA6ICcnOwogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gQ29va2llcyBBUEkKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIHZhciBsYXN0Q29va2llcyA9IHt9OwogICAgICAgIHZhciBsYXN0Q29va2llU3RyaW5nID0gJyc7CiAgICAgICAgdmFyIGNvb2tpZVBhdGggPSBzZWxmLmJhc2VIcmVmKCk7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI2Nvb2tpZXMKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBDb29raWUgbmFtZQogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgQ29va2llIHZhbHVlCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGUgY29va2llcyBtZXRob2QgcHJvdmlkZXMgYSAncHJpdmF0ZScgbG93IGxldmVsIGFjY2VzcyB0byBicm93c2VyIGNvb2tpZXMuCiAgICAgICAgICogSXQgaXMgbm90IG1lYW50IHRvIGJlIHVzZWQgZGlyZWN0bHksIHVzZSB0aGUgJGNvb2tpZSBzZXJ2aWNlIGluc3RlYWQuCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlcyB2YXJ5IGRlcGVuZGluZyBvbiB0aGUgYXJndW1lbnRzIHRoYXQgdGhlIG1ldGhvZCB3YXMgY2FsbGVkIHdpdGggYXMgZm9sbG93czoKICAgICAgICAgKiA8dWw+CiAgICAgICAgICogICA8bGk+Y29va2llcygpIC0+IGhhc2ggb2YgYWxsIGNvb2tpZXMsIHRoaXMgaXMgTk9UIGEgY29weSBvZiB0aGUgaW50ZXJuYWwgc3RhdGUsIHNvIGRvIG5vdCBtb2RpZnkgaXQ8L2xpPgogICAgICAgICAqICAgPGxpPmNvb2tpZXMobmFtZSwgdmFsdWUpIC0+IHNldCBuYW1lIHRvIHZhbHVlLCBpZiB2YWx1ZSBpcyB1bmRlZmluZWQgZGVsZXRlIHRoZSBjb29raWU8L2xpPgogICAgICAgICAqICAgPGxpPmNvb2tpZXMobmFtZSkgLT4gdGhlIHNhbWUgYXMgKG5hbWUsIHVuZGVmaW5lZCkgPT0gREVMRVRFUyAobm8gb25lIGNhbGxzIGl0IHJpZ2h0IG5vdyB0aGF0IHdheSk8L2xpPgogICAgICAgICAqIDwvdWw+CiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBIYXNoIG9mIGFsbCBjb29raWVzIChpZiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyKQogICAgICAgICAqLwogICAgICAgIHNlbGYuY29va2llcyA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgY29va2llTGVuZ3RoLCBjb29raWVBcnJheSwgY29va2llLCBpLCBpbmRleDsKCiAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHJhd0RvY3VtZW50LmNvb2tpZSA9IGVzY2FwZShuYW1lKSArICI9O3BhdGg9IiArIGNvb2tpZVBhdGggKyAiO2V4cGlyZXM9VGh1LCAwMSBKYW4gMTk3MCAwMDowMDowMCBHTVQiOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvb2tpZUxlbmd0aCA9IChyYXdEb2N1bWVudC5jb29raWUgPSBlc2NhcGUobmFtZSkgKyAnPScgKyBlc2NhcGUodmFsdWUpICsgJztwYXRoPScgKyBjb29raWVQYXRoKS5sZW5ndGggKyAxOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGVyIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzIxMDkudHh0IGJyb3dzZXIgbXVzdCBhbGxvdyBhdCBtaW5pbXVtOgogICAgICAgICAgICAgICAgICAgICAgICAvLyAtIDMwMCBjb29raWVzCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gMjAgY29va2llcyBwZXIgdW5pcXVlIGRvbWFpbgogICAgICAgICAgICAgICAgICAgICAgICAvLyAtIDQwOTYgYnl0ZXMgcGVyIGNvb2tpZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29va2llTGVuZ3RoID4gNDA5NikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvZy53YXJuKCJDb29raWUgJyIgKyBuYW1lICsgIicgcG9zc2libHkgbm90IHNldCBvciBvdmVyZmxvd2VkIGJlY2F1c2UgaXQgd2FzIHRvbyBsYXJnZSAoIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb2tpZUxlbmd0aCArICIgPiA0MDk2IGJ5dGVzKSEiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChyYXdEb2N1bWVudC5jb29raWUgIT09IGxhc3RDb29raWVTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llU3RyaW5nID0gcmF3RG9jdW1lbnQuY29va2llOwogICAgICAgICAgICAgICAgICAgIGNvb2tpZUFycmF5ID0gbGFzdENvb2tpZVN0cmluZy5zcGxpdCgiOyAiKTsKICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llcyA9IHt9OwoKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29va2llQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29va2llID0gY29va2llQXJyYXlbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gY29va2llLmluZGV4T2YoJz0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gMCkgeyAvL2lnbm9yZSBuYW1lbGVzcyBjb29raWVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IHVuZXNjYXBlKGNvb2tpZS5zdWJzdHJpbmcoMCwgaW5kZXgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBmaXJzdCB2YWx1ZSB0aGF0IGlzIHNlZW4gZm9yIGEgY29va2llIGlzIHRoZSBtb3N0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzcGVjaWZpYyBvbmUuICB2YWx1ZXMgZm9yIHRoZSBzYW1lIGNvb2tpZSBuYW1lIHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvbGxvdyBhcmUgZm9yIGxlc3Mgc3BlY2lmaWMgcGF0aHMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdENvb2tpZXNbbmFtZV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RDb29raWVzW25hbWVdID0gdW5lc2NhcGUoY29va2llLnN1YnN0cmluZyhpbmRleCArIDEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBsYXN0Q29va2llczsKICAgICAgICAgICAgfQogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNkZWZlcgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvJ3MgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWZlcnJlZC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IFtkZWxheT0wXSBvZiBtaWxsaXNlY29uZHMgdG8gZGVmZXIgdGhlIGZ1bmN0aW9uIGV4ZWN1dGlvbi4KICAgICAgICAgKiBAcmV0dXJucyB7Kn0gRGVmZXJJZCB0aGF0IGNhbiBiZSB1c2VkIHRvIGNhbmNlbCB0aGUgdGFzayB2aWEgYCRicm93c2VyLmRlZmVyLmNhbmNlbCgpYC4KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEV4ZWN1dGVzIGEgZm4gYXN5bmNocm9ub3VzbHkgdmlhIGBzZXRUaW1lb3V0KGZuLCBkZWxheSlgLgogICAgICAgICAqCiAgICAgICAgICogVW5saWtlIHdoZW4gY2FsbGluZyBgc2V0VGltZW91dGAgZGlyZWN0bHksIGluIHRlc3QgdGhpcyBmdW5jdGlvbiBpcyBtb2NrZWQgYW5kIGluc3RlYWQgb2YgdXNpbmcKICAgICAgICAgKiBgc2V0VGltZW91dGAgaW4gdGVzdHMsIHRoZSBmbnMgYXJlIHF1ZXVlZCBpbiBhbiBhcnJheSwgd2hpY2ggY2FuIGJlIHByb2dyYW1tYXRpY2FsbHkgZmx1c2hlZAogICAgICAgICAqIHZpYSBgJGJyb3dzZXIuZGVmZXIuZmx1c2goKWAuCiAgICAgICAgICoKICAgICAgICAgKi8KICAgICAgICBzZWxmLmRlZmVyID0gZnVuY3Rpb24gKGZuLCBkZWxheSkgewogICAgICAgICAgICB2YXIgdGltZW91dElkOwogICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOwogICAgICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXTsKICAgICAgICAgICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKTsKICAgICAgICAgICAgfSwgZGVsYXkgfHwgMCk7CiAgICAgICAgICAgIHBlbmRpbmdEZWZlcklkc1t0aW1lb3V0SWRdID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRpbWVvdXRJZDsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjZGVmZXIuY2FuY2VsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyLmRlZmVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDYW5jZWxzIGEgZGVmZXJyZWQgdGFzayBpZGVudGlmaWVkIHdpdGggYGRlZmVySWRgLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHsqfSBkZWZlcklkIFRva2VuIHJldHVybmVkIGJ5IHRoZSBgJGJyb3dzZXIuZGVmZXJgIGZ1bmN0aW9uLgogICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bGx5IGNhbmNlbGVkLgogICAgICAgICAqLwogICAgICAgIHNlbGYuZGVmZXIuY2FuY2VsID0gZnVuY3Rpb24gKGRlZmVySWQpIHsKICAgICAgICAgICAgaWYgKHBlbmRpbmdEZWZlcklkc1tkZWZlcklkXSkgewogICAgICAgICAgICAgICAgZGVsZXRlIHBlbmRpbmdEZWZlcklkc1tkZWZlcklkXTsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChkZWZlcklkKTsKICAgICAgICAgICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KG5vb3ApOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CgogICAgfQoKICAgIGZ1bmN0aW9uICRCcm93c2VyUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgJyRsb2cnLCAnJHNuaWZmZXInLCAnJGRvY3VtZW50JywKICAgICAgICAgICAgZnVuY3Rpb24gKCR3aW5kb3csICRsb2csICRzbmlmZmVyLCAkZG9jdW1lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQnJvd3Nlcigkd2luZG93LCAkZG9jdW1lbnQsICRsb2csICRzbmlmZmVyKTsKICAgICAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kY2FjaGVGYWN0b3J5CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGYWN0b3J5IHRoYXQgY29uc3RydWN0cyBjYWNoZSBvYmplY3RzIGFuZCBnaXZlcyBhY2Nlc3MgdG8gdGhlbS4KICAgICAqIAogICAgICogPHByZT4KICAgICAqIAogICAgICogIHZhciBjYWNoZSA9ICRjYWNoZUZhY3RvcnkoJ2NhY2hlSWQnKTsKICAgICAqICBleHBlY3QoJGNhY2hlRmFjdG9yeS5nZXQoJ2NhY2hlSWQnKSkudG9CZShjYWNoZSk7CiAgICAgKiAgZXhwZWN0KCRjYWNoZUZhY3RvcnkuZ2V0KCdub1N1Y2hDYWNoZUlkJykpLm5vdC50b0JlRGVmaW5lZCgpOwogICAgICoKICAgICAqICBjYWNoZS5wdXQoImtleSIsICJ2YWx1ZSIpOwogICAgICogIGNhY2hlLnB1dCgiYW5vdGhlciBrZXkiLCAiYW5vdGhlciB2YWx1ZSIpOwogICAgICogCiAgICAgKiAgZXhwZWN0KGNhY2hlLmluZm8oKSkudG9FcXVhbCh7aWQ6ICdjYWNoZUlkJywgc2l6ZTogMn0pOyAvLyBTaW5jZSB3ZSd2ZSBzcGVjaWZpZWQgbm8gb3B0aW9ucyBvbiBjcmVhdGlvbgogICAgICogCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlSWQgTmFtZSBvciBpZCBvZiB0aGUgbmV3bHkgY3JlYXRlZCBjYWNoZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBPcHRpb25zIG9iamVjdCB0aGF0IHNwZWNpZmllcyB0aGUgY2FjaGUgYmVoYXZpb3IuIFByb3BlcnRpZXM6CiAgICAgKgogICAgICogICAtIGB7bnVtYmVyPX1gIGBjYXBhY2l0eWAg4oCUIHR1cm5zIHRoZSBjYWNoZSBpbnRvIExSVSBjYWNoZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBOZXdseSBjcmVhdGVkIGNhY2hlIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgc2V0IG9mIG1ldGhvZHM6CiAgICAgKgogICAgICogLSBge29iamVjdH1gIGBpbmZvKClgIOKAlCBSZXR1cm5zIGlkLCBzaXplLCBhbmQgb3B0aW9ucyBvZiBjYWNoZS4KICAgICAqIC0gYHt7Kn19YCBgcHV0KHtzdHJpbmd9IGtleSwgeyp9IHZhbHVlKWAg4oCUIFB1dHMgYSBuZXcga2V5LXZhbHVlIHBhaXIgaW50byB0aGUgY2FjaGUgYW5kIHJldHVybnMgaXQuCiAgICAgKiAtIGB7eyp9fWAgYGdldCh7c3RyaW5nfSBrZXkpYCDigJQgUmV0dXJucyBjYWNoZWQgdmFsdWUgZm9yIGBrZXlgIG9yIHVuZGVmaW5lZCBmb3IgY2FjaGUgbWlzcy4KICAgICAqIC0gYHt2b2lkfWAgYHJlbW92ZSh7c3RyaW5nfSBrZXkpYCDigJQgUmVtb3ZlcyBhIGtleS12YWx1ZSBwYWlyIGZyb20gdGhlIGNhY2hlLgogICAgICogLSBge3ZvaWR9YCBgcmVtb3ZlQWxsKClgIOKAlCBSZW1vdmVzIGFsbCBjYWNoZWQgdmFsdWVzLgogICAgICogLSBge3ZvaWR9YCBgZGVzdHJveSgpYCDigJQgUmVtb3ZlcyByZWZlcmVuY2VzIHRvIHRoaXMgY2FjaGUgZnJvbSAkY2FjaGVGYWN0b3J5LgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJENhY2hlRmFjdG9yeVByb3ZpZGVyKCkgewoKICAgICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBjYWNoZXMgPSB7fTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNhY2hlRmFjdG9yeShjYWNoZUlkLCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBpZiAoY2FjaGVJZCBpbiBjYWNoZXMpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBtaW5FcnIoJyRjYWNoZUZhY3RvcnknKSgnaWlkJywgIkNhY2hlSWQgJ3swfScgaXMgYWxyZWFkeSB0YWtlbiEiLCBjYWNoZUlkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgc2l6ZSA9IDAsCiAgICAgICAgICAgICAgICAgICAgc3RhdHMgPSBleHRlbmQoe30sIG9wdGlvbnMsIHsgaWQ6IGNhY2hlSWQgfSksCiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHt9LAogICAgICAgICAgICAgICAgICAgIGNhcGFjaXR5ID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5jYXBhY2l0eSkgfHwgTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0ge30sCiAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIHN0YWxlRW5kID0gbnVsbDsKCiAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdID0gewoKICAgICAgICAgICAgICAgICAgICBwdXQ6IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBscnVFbnRyeSA9IGxydUhhc2hba2V5XSB8fCAobHJ1SGFzaFtrZXldID0geyBrZXk6IGtleSB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShrZXkgaW4gZGF0YSkpIHNpemUrKzsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2l6ZSA+IGNhcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShzdGFsZUVuZC5rZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICByZWZyZXNoKGxydUVudHJ5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhW2tleV07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobHJ1RW50cnkgPT0gZnJlc2hFbmQpIGZyZXNoRW5kID0gbHJ1RW50cnkucDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxydUVudHJ5ID09IHN0YWxlRW5kKSBzdGFsZUVuZCA9IGxydUVudHJ5Lm47CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsobHJ1RW50cnkubiwgbHJ1RW50cnkucCk7CgogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgbHJ1SGFzaFtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBzaXplLS07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIHJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIHNpemUgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGZyZXNoRW5kID0gc3RhbGVFbmQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBzdGF0cyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGxydUhhc2ggPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FjaGVzW2NhY2hlSWRdOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICBpbmZvOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleHRlbmQoe30sIHN0YXRzLCB7IHNpemU6IHNpemUgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBtYWtlcyB0aGUgYGVudHJ5YCB0aGUgZnJlc2hFbmQgb2YgdGhlIExSVSBsaW5rZWQgbGlzdAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZWZyZXNoKGVudHJ5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVudHJ5ICE9IGZyZXNoRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhbGVFbmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWxlRW5kID0gZW50cnk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhbGVFbmQgPT0gZW50cnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWxlRW5kID0gZW50cnkubjsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgbGluayhlbnRyeS5uLCBlbnRyeS5wKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGluayhlbnRyeSwgZnJlc2hFbmQpOwogICAgICAgICAgICAgICAgICAgICAgICBmcmVzaEVuZCA9IGVudHJ5OwogICAgICAgICAgICAgICAgICAgICAgICBmcmVzaEVuZC5uID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogYmlkaXJlY3Rpb25hbGx5IGxpbmtzIHR3byBlbnRyaWVzIG9mIHRoZSBMUlUgbGlua2VkIGxpc3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gbGluayhuZXh0RW50cnksIHByZXZFbnRyeSkgewogICAgICAgICAgICAgICAgICAgIGlmIChuZXh0RW50cnkgIT0gcHJldkVudHJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0RW50cnkpIG5leHRFbnRyeS5wID0gcHJldkVudHJ5OyAvL3Agc3RhbmRzIGZvciBwcmV2aW91cywgJ3ByZXYnIGRpZG4ndCBtaW5pZnkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZFbnRyeSkgcHJldkVudHJ5Lm4gPSBuZXh0RW50cnk7IC8vbiBzdGFuZHMgZm9yIG5leHQsICduZXh0JyBkaWRuJ3QgbWluaWZ5CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJGNhY2hlRmFjdG9yeSNpbmZvCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kY2FjaGVGYWN0b3J5CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBHZXQgaW5mb3JtYXRpb24gYWJvdXQgYWxsIHRoZSBvZiB0aGUgY2FjaGVzIHRoYXQgaGF2ZSBiZWVuIGNyZWF0ZWQKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge09iamVjdH0gLSBrZXktdmFsdWUgbWFwIG9mIGBjYWNoZUlkYCB0byB0aGUgcmVzdWx0IG9mIGNhbGxpbmcgYGNhY2hlI2luZm9gCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjYWNoZUZhY3RvcnkuaW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBpbmZvID0ge307CiAgICAgICAgICAgICAgICBmb3JFYWNoKGNhY2hlcywgZnVuY3Rpb24gKGNhY2hlLCBjYWNoZUlkKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mb1tjYWNoZUlkXSA9IGNhY2hlLmluZm8oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJGNhY2hlRmFjdG9yeSNnZXQKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjYWNoZUZhY3RvcnkKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIEdldCBhY2Nlc3MgdG8gYSBjYWNoZSBvYmplY3QgYnkgdGhlIGBjYWNoZUlkYCB1c2VkIHdoZW4gaXQgd2FzIGNyZWF0ZWQuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZUlkIE5hbWUgb3IgaWQgb2YgYSBjYWNoZSB0byBhY2Nlc3MuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtvYmplY3R9IENhY2hlIG9iamVjdCBpZGVudGlmaWVkIGJ5IHRoZSBjYWNoZUlkIG9yIHVuZGVmaW5lZCBpZiBubyBzdWNoIGNhY2hlLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY2FjaGVGYWN0b3J5LmdldCA9IGZ1bmN0aW9uIChjYWNoZUlkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdOwogICAgICAgICAgICB9OwoKCiAgICAgICAgICAgIHJldHVybiBjYWNoZUZhY3Rvcnk7CiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiR0ZW1wbGF0ZUNhY2hlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgZmlyc3QgdGltZSBhIHRlbXBsYXRlIGlzIHVzZWQsIGl0IGlzIGxvYWRlZCBpbiB0aGUgdGVtcGxhdGUgY2FjaGUgZm9yIHF1aWNrIHJldHJpZXZhbC4gWW91IGNhbgogICAgICogbG9hZCB0ZW1wbGF0ZXMgZGlyZWN0bHkgaW50byB0aGUgY2FjaGUgaW4gYSBgc2NyaXB0YCB0YWcsIG9yIGJ5IGNvbnN1bWluZyB0aGUgYCR0ZW1wbGF0ZUNhY2hlYAogICAgICogc2VydmljZSBkaXJlY3RseS4KICAgICAqIAogICAgICogQWRkaW5nIHZpYSB0aGUgYHNjcmlwdGAgdGFnOgogICAgICogPHByZT4KICAgICAqIDxodG1sIG5nLWFwcD4KICAgICAqIDxoZWFkPgogICAgICogPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGVJZC5odG1sIj4KICAgICAqICAgVGhpcyBpcyB0aGUgY29udGVudCBvZiB0aGUgdGVtcGxhdGUKICAgICAqIDwvc2NyaXB0PgogICAgICogPC9oZWFkPgogICAgICogICAuLi4KICAgICAqIDwvaHRtbD4KICAgICAqIDwvcHJlPgogICAgICogCiAgICAgKiAqKk5vdGU6KiogdGhlIGBzY3JpcHRgIHRhZyBjb250YWluaW5nIHRoZSB0ZW1wbGF0ZSBkb2VzIG5vdCBuZWVkIHRvIGJlIGluY2x1ZGVkIGluIHRoZSBgaGVhZGAgb2YgdGhlIGRvY3VtZW50LCBidXQgCiAgICAgKiBpdCBtdXN0IGJlIGJlbG93IHRoZSBgbmctYXBwYCBkZWZpbml0aW9uLgogICAgICogCiAgICAgKiBBZGRpbmcgdmlhIHRoZSAkdGVtcGxhdGVDYWNoZSBzZXJ2aWNlOgogICAgICogCiAgICAgKiA8cHJlPgogICAgICogdmFyIG15QXBwID0gYW5ndWxhci5tb2R1bGUoJ215QXBwJywgW10pOwogICAgICogbXlBcHAucnVuKGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAgKiAgICR0ZW1wbGF0ZUNhY2hlLnB1dCgndGVtcGxhdGVJZC5odG1sJywgJ1RoaXMgaXMgdGhlIGNvbnRlbnQgb2YgdGhlIHRlbXBsYXRlJyk7CiAgICAgKiB9KTsKICAgICAqIDwvcHJlPgogICAgICogCiAgICAgKiBUbyByZXRyaWV2ZSB0aGUgdGVtcGxhdGUgbGF0ZXIsIHNpbXBseSB1c2UgaXQgaW4geW91ciBIVE1MOgogICAgICogPHByZT4KICAgICAqIDxkaXYgbmctaW5jbHVkZT0iICd0ZW1wbGF0ZUlkLmh0bWwnICI+PC9kaXY+CiAgICAgKiA8L3ByZT4KICAgICAqIAogICAgICogb3IgZ2V0IGl0IHZpYSBKYXZhc2NyaXB0OgogICAgICogPHByZT4KICAgICAqICR0ZW1wbGF0ZUNhY2hlLmdldCgndGVtcGxhdGVJZC5odG1sJykKICAgICAqIDwvcHJlPgogICAgICogCiAgICAgKiBTZWUge0BsaW5rIG5nLiRjYWNoZUZhY3RvcnkgJGNhY2hlRmFjdG9yeX0uCiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiAkVGVtcGxhdGVDYWNoZVByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJGNhY2hlRmFjdG9yeScsIGZ1bmN0aW9uICgkY2FjaGVGYWN0b3J5KSB7CiAgICAgICAgICAgIHJldHVybiAkY2FjaGVGYWN0b3J5KCd0ZW1wbGF0ZXMnKTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKiAhIFZBUklBQkxFL0ZVTkNUSU9OIE5BTUlORyBDT05WRU5USU9OUyBUSEFUIEFQUExZIFRPIFRISVMgRklMRSEKICAgICAqCiAgICAgKiBET00tcmVsYXRlZCB2YXJpYWJsZXM6CiAgICAgKgogICAgICogLSAibm9kZSIgLSBET00gTm9kZQogICAgICogLSAiZWxlbWVudCIgLSBET00gRWxlbWVudCBvciBOb2RlCiAgICAgKiAtICIkbm9kZSIgb3IgIiRlbGVtZW50IiAtIGpxTGl0ZS13cmFwcGVkIG5vZGUgb3IgZWxlbWVudAogICAgICoKICAgICAqCiAgICAgKiBDb21waWxlciByZWxhdGVkIHN0dWZmOgogICAgICoKICAgICAqIC0gImxpbmtGbiIgLSBsaW5raW5nIGZuIG9mIGEgc2luZ2xlIGRpcmVjdGl2ZQogICAgICogLSAibm9kZUxpbmtGbiIgLSBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBhIHBhcnRpY3VsYXIgbm9kZQogICAgICogLSAiY2hpbGRMaW5rRm4iIC0gIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGNoaWxkIG5vZGVzIG9mIGEgcGFydGljdWxhciBub2RlCiAgICAgKiAtICJjb21wb3NpdGVMaW5rRm4iIC0gZnVuY3Rpb24gdGhhdCBhZ2dyZWdhdGVzIGFsbCBsaW5raW5nIGZucyBmb3IgYSBjb21waWxhdGlvbiByb290IChub2RlTGlzdCkKICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJGNvbXBpbGUKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ29tcGlsZXMgYSBwaWVjZSBvZiBIVE1MIHN0cmluZyBvciBET00gaW50byBhIHRlbXBsYXRlIGFuZCBwcm9kdWNlcyBhIHRlbXBsYXRlIGZ1bmN0aW9uLCB3aGljaAogICAgICogY2FuIHRoZW4gYmUgdXNlZCB0byBsaW5rIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBhbmQgdGhlIHRlbXBsYXRlIHRvZ2V0aGVyLgogICAgICoKICAgICAqIFRoZSBjb21waWxhdGlvbiBpcyBhIHByb2Nlc3Mgb2Ygd2Fsa2luZyB0aGUgRE9NIHRyZWUgYW5kIHRyeWluZyB0byBtYXRjaCBET00gZWxlbWVudHMgdG8KICAgICAqIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4gRm9yIGVhY2ggbWF0Y2ggaXQKICAgICAqIGV4ZWN1dGVzIGNvcnJlc3BvbmRpbmcgdGVtcGxhdGUgZnVuY3Rpb24gYW5kIGNvbGxlY3RzIHRoZQogICAgICogaW5zdGFuY2UgZnVuY3Rpb25zIGludG8gYSBzaW5nbGUgdGVtcGxhdGUgZnVuY3Rpb24gd2hpY2ggaXMgdGhlbiByZXR1cm5lZC4KICAgICAqCiAgICAgKiBUaGUgdGVtcGxhdGUgZnVuY3Rpb24gY2FuIHRoZW4gYmUgdXNlZCBvbmNlIHRvIHByb2R1Y2UgdGhlIHZpZXcgb3IgYXMgaXQgaXMgdGhlIGNhc2Ugd2l0aAogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCByZXBlYXRlcn0gbWFueS10aW1lcywgaW4gd2hpY2gKICAgICAqIGNhc2UgZWFjaCBjYWxsIHJlc3VsdHMgaW4gYSB2aWV3IHRoYXQgaXMgYSBET00gY2xvbmUgb2YgdGhlIG9yaWdpbmFsIHRlbXBsYXRlLgogICAgICoKICAgICA8ZG9jOmV4YW1wbGUgbW9kdWxlPSJjb21waWxlIj4KICAgICAgIDxkb2M6c291cmNlPgogICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAvLyBkZWNsYXJlIGEgbmV3IG1vZHVsZSwgYW5kIGluamVjdCB0aGUgJGNvbXBpbGVQcm92aWRlcgogICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2NvbXBpbGUnLCBbXSwgZnVuY3Rpb24oJGNvbXBpbGVQcm92aWRlcikgewogICAgICAgICAgICAvLyBjb25maWd1cmUgbmV3ICdjb21waWxlJyBkaXJlY3RpdmUgYnkgcGFzc2luZyBhIGRpcmVjdGl2ZQogICAgICAgICAgICAvLyBmYWN0b3J5IGZ1bmN0aW9uLiBUaGUgZmFjdG9yeSBmdW5jdGlvbiBpbmplY3RzIHRoZSAnJGNvbXBpbGUnCiAgICAgICAgICAgICRjb21waWxlUHJvdmlkZXIuZGlyZWN0aXZlKCdjb21waWxlJywgZnVuY3Rpb24oJGNvbXBpbGUpIHsKICAgICAgICAgICAgICAvLyBkaXJlY3RpdmUgZmFjdG9yeSBjcmVhdGVzIGEgbGluayBmdW5jdGlvbgogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgLy8gd2F0Y2ggdGhlICdjb21waWxlJyBleHByZXNzaW9uIGZvciBjaGFuZ2VzCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRldmFsKGF0dHJzLmNvbXBpbGUpOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhlICdjb21waWxlJyBleHByZXNzaW9uIGNoYW5nZXMKICAgICAgICAgICAgICAgICAgICAvLyBhc3NpZ24gaXQgaW50byB0aGUgY3VycmVudCBET00KICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwodmFsdWUpOwogICAgCiAgICAgICAgICAgICAgICAgICAgLy8gY29tcGlsZSB0aGUgbmV3IERPTSBhbmQgbGluayBpdCB0byB0aGUgY3VycmVudAogICAgICAgICAgICAgICAgICAgIC8vIHNjb3BlLgogICAgICAgICAgICAgICAgICAgIC8vIE5PVEU6IHdlIG9ubHkgY29tcGlsZSAuY2hpbGROb2RlcyBzbyB0aGF0CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgZG9uJ3QgZ2V0IGludG8gaW5maW5pdGUgbG9vcCBjb21waWxpbmcgb3Vyc2VsdmVzCiAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGUoZWxlbWVudC5jb250ZW50cygpKShzY29wZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSkKICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAkc2NvcGUubmFtZSA9ICdBbmd1bGFyJzsKICAgICAgICAgICAgJHNjb3BlLmh0bWwgPSAnSGVsbG8ge3tuYW1lfX0nOwogICAgICAgICAgfQogICAgICAgIDwvc2NyaXB0PgogICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICA8aW5wdXQgbmctbW9kZWw9Im5hbWUiPiA8YnI+CiAgICAgICAgICA8dGV4dGFyZWEgbmctbW9kZWw9Imh0bWwiPjwvdGV4dGFyZWE+IDxicj4KICAgICAgICAgIDxkaXYgY29tcGlsZT0iaHRtbCI+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGF1dG8gY29tcGlsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCdkaXZbY29tcGlsZV0nKS50ZXh0KCkpLnRvQmUoJ0hlbGxvIEFuZ3VsYXInKTsKICAgICAgICAgICBpbnB1dCgnaHRtbCcpLmVudGVyKCd7e25hbWV9fSEnKTsKICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnZGl2W2NvbXBpbGVdJykudGV4dCgpKS50b0JlKCdBbmd1bGFyIScpOwogICAgICAgICB9KTsKICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAKICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBFbGVtZW50IG9yIEhUTUwgc3RyaW5nIHRvIGNvbXBpbGUgaW50byBhIHRlbXBsYXRlIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlWywgY2xvbmVBdHRhY2hGbl19IHRyYW5zY2x1ZGUgZnVuY3Rpb24gYXZhaWxhYmxlIHRvIGRpcmVjdGl2ZXMuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWF4UHJpb3JpdHkgb25seSBhcHBseSBkaXJlY3RpdmVzIGxvd2VyIHRoZW4gZ2l2ZW4gcHJpb3JpdHkgKE9ubHkgZWZmZWN0cyB0aGUKICAgICAqICAgICAgICAgICAgICAgICByb290IGVsZW1lbnQocyksIG5vdCB0aGVpciBjaGlsZHJlbikKICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihzY29wZVssIGNsb25lQXR0YWNoRm5dKX0gYSBsaW5rIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gYmluZCB0ZW1wbGF0ZQogICAgICogKGEgRE9NIGVsZW1lbnQvdHJlZSkgdG8gYSBzY29wZS4gV2hlcmU6CiAgICAgKgogICAgICogICogYHNjb3BlYCAtIEEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgU2NvcGV9IHRvIGJpbmQgdG8uCiAgICAgKiAgKiBgY2xvbmVBdHRhY2hGbmAgLSBJZiBgY2xvbmVBdHRhY2hGbmAgaXMgcHJvdmlkZWQsIHRoZW4gdGhlIGxpbmsgZnVuY3Rpb24gd2lsbCBjbG9uZSB0aGUKICAgICAqICAgICAgICAgICAgICAgYHRlbXBsYXRlYCBhbmQgY2FsbCB0aGUgYGNsb25lQXR0YWNoRm5gIGZ1bmN0aW9uIGFsbG93aW5nIHRoZSBjYWxsZXIgdG8gYXR0YWNoIHRoZQogICAgICogICAgICAgICAgICAgICBjbG9uZWQgZWxlbWVudHMgdG8gdGhlIERPTSBkb2N1bWVudCBhdCB0aGUgYXBwcm9wcmlhdGUgcGxhY2UuIFRoZSBgY2xvbmVBdHRhY2hGbmAgaXMKICAgICAqICAgICAgICAgICAgICAgY2FsbGVkIGFzOiA8YnI+IGBjbG9uZUF0dGFjaEZuKGNsb25lZEVsZW1lbnQsIHNjb3BlKWAgd2hlcmU6CiAgICAgKgogICAgICogICAgICAqIGBjbG9uZWRFbGVtZW50YCAtIGlzIGEgY2xvbmUgb2YgdGhlIG9yaWdpbmFsIGBlbGVtZW50YCBwYXNzZWQgaW50byB0aGUgY29tcGlsZXIuCiAgICAgKiAgICAgICogYHNjb3BlYCAtIGlzIHRoZSBjdXJyZW50IHNjb3BlIHdpdGggd2hpY2ggdGhlIGxpbmtpbmcgZnVuY3Rpb24gaXMgd29ya2luZyB3aXRoLgogICAgICoKICAgICAqIENhbGxpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gcmV0dXJucyB0aGUgZWxlbWVudCBvZiB0aGUgdGVtcGxhdGUuIEl0IGlzIGVpdGhlciB0aGUgb3JpZ2luYWwgZWxlbWVudAogICAgICogcGFzc2VkIGluLCBvciB0aGUgY2xvbmUgb2YgdGhlIGVsZW1lbnQgaWYgdGhlIGBjbG9uZUF0dGFjaEZuYCBpcyBwcm92aWRlZC4KICAgICAqCiAgICAgKiBBZnRlciBsaW5raW5nIHRoZSB2aWV3IGlzIG5vdCB1cGRhdGVkIHVudGlsIGFmdGVyIGEgY2FsbCB0byAkZGlnZXN0IHdoaWNoIHR5cGljYWxseSBpcyBkb25lIGJ5CiAgICAgKiBBbmd1bGFyIGF1dG9tYXRpY2FsbHkuCiAgICAgKgogICAgICogSWYgeW91IG5lZWQgYWNjZXNzIHRvIHRoZSBib3VuZCB2aWV3LCB0aGVyZSBhcmUgdHdvIHdheXMgdG8gZG8gaXQ6CiAgICAgKgogICAgICogLSBJZiB5b3UgYXJlIG5vdCBhc2tpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gdG8gY2xvbmUgdGhlIHRlbXBsYXRlLCBjcmVhdGUgdGhlIERPTSBlbGVtZW50KHMpCiAgICAgKiAgIGJlZm9yZSB5b3Ugc2VuZCB0aGVtIHRvIHRoZSBjb21waWxlciBhbmQga2VlcCB0aGlzIHJlZmVyZW5jZSBhcm91bmQuCiAgICAgKiAgIDxwcmU+CiAgICAgKiAgICAgdmFyIGVsZW1lbnQgPSAkY29tcGlsZSgnPHA+e3t0b3RhbH19PC9wPicpKHNjb3BlKTsKICAgICAqICAgPC9wcmU+CiAgICAgKgogICAgICogLSBpZiBvbiB0aGUgb3RoZXIgaGFuZCwgeW91IG5lZWQgdGhlIGVsZW1lbnQgdG8gYmUgY2xvbmVkLCB0aGUgdmlldyByZWZlcmVuY2UgZnJvbSB0aGUgb3JpZ2luYWwKICAgICAqICAgZXhhbXBsZSB3b3VsZCBub3QgcG9pbnQgdG8gdGhlIGNsb25lLCBidXQgcmF0aGVyIHRvIHRoZSBvcmlnaW5hbCB0ZW1wbGF0ZSB0aGF0IHdhcyBjbG9uZWQuIEluCiAgICAgKiAgIHRoaXMgY2FzZSwgeW91IGNhbiBhY2Nlc3MgdGhlIGNsb25lIHZpYSB0aGUgY2xvbmVBdHRhY2hGbjoKICAgICAqICAgPHByZT4KICAgICAqICAgICB2YXIgdGVtcGxhdGVIVE1MID0gYW5ndWxhci5lbGVtZW50KCc8cD57e3RvdGFsfX08L3A+JyksCiAgICAgKiAgICAgICAgIHNjb3BlID0gLi4uLjsKICAgICAqCiAgICAgKiAgICAgdmFyIGNsb25lZEVsZW1lbnQgPSAkY29tcGlsZSh0ZW1wbGF0ZUhUTUwpKHNjb3BlLCBmdW5jdGlvbihjbG9uZWRFbGVtZW50LCBzY29wZSkgewogICAgICogICAgICAgLy9hdHRhY2ggdGhlIGNsb25lIHRvIERPTSBkb2N1bWVudCBhdCB0aGUgcmlnaHQgcGxhY2UKICAgICAqICAgICB9KTsKICAgICAqCiAgICAgKiAgICAgLy9ub3cgd2UgaGF2ZSByZWZlcmVuY2UgdG8gdGhlIGNsb25lZCBET00gdmlhIGBjbG9uZWAKICAgICAqICAgPC9wcmU+CiAgICAgKgogICAgICoKICAgICAqIEZvciBpbmZvcm1hdGlvbiBvbiBob3cgdGhlIGNvbXBpbGVyIHdvcmtzLCBzZWUgdGhlCiAgICAgKiB7QGxpbmsgZ3VpZGUvY29tcGlsZXIgQW5ndWxhciBIVE1MIENvbXBpbGVyfSBzZWN0aW9uIG9mIHRoZSBEZXZlbG9wZXIgR3VpZGUuCiAgICAgKi8KCiAgICB2YXIgJGNvbXBpbGVNaW5FcnIgPSBtaW5FcnIoJyRjb21waWxlJyk7CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgbmcuJGNvbXBpbGVQcm92aWRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKi8KICAgICRDb21waWxlUHJvdmlkZXIuJGluamVjdCA9IFsnJHByb3ZpZGUnXTsKICAgIGZ1bmN0aW9uICRDb21waWxlUHJvdmlkZXIoJHByb3ZpZGUpIHsKICAgICAgICB2YXIgaGFzRGlyZWN0aXZlcyA9IHt9LAogICAgICAgICAgICBTdWZmaXggPSAnRGlyZWN0aXZlJywKICAgICAgICAgICAgQ09NTUVOVF9ESVJFQ1RJVkVfUkVHRVhQID0gL15ccypkaXJlY3RpdmVcOlxzKihbXGRcd1wtX10rKVxzKyguKikkLywKICAgICAgICAgICAgQ0xBU1NfRElSRUNUSVZFX1JFR0VYUCA9IC8oKFtcZFx3XC1fXSspKD86XDooW147XSspKT87PykvLAogICAgICAgICAgICBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCA9IC9eXHMqKGh0dHBzP3xmdHB8bWFpbHRvfGZpbGUpOi8sCiAgICAgICAgICAgIGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA9IC9eXHMqKGh0dHBzP3xmdHB8ZmlsZSk6fGRhdGE6aW1hZ2VcLy87CgogICAgICAgIC8vIFJlZjogaHR0cDovL2RldmVsb3BlcnMud2hhdHdnLm9yZy93ZWJhcHBhcGlzLmh0bWwjZXZlbnQtaGFuZGxlci1pZGwtYXR0cmlidXRlcwogICAgICAgIC8vIFRoZSBhc3N1bXB0aW9uIGlzIHRoYXQgZnV0dXJlIERPTSBldmVudCBhdHRyaWJ1dGUgbmFtZXMgd2lsbCBiZWdpbiB3aXRoCiAgICAgICAgLy8gJ29uJyBhbmQgYmUgY29tcG9zZWQgb2Ygb25seSBFbmdsaXNoIGxldHRlcnMuCiAgICAgICAgdmFyIEVWRU5UX0hBTkRMRVJfQVRUUl9SRUdFWFAgPSAvXihvblthLXpdKnxmb3JtYWN0aW9uKSQvOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZVByb3ZpZGVyCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZWdpc3RlciBhIG5ldyBkaXJlY3RpdmUgd2l0aCB0aGUgY29tcGlsZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBkaXJlY3RpdmUgaW4gY2FtZWwtY2FzZS4gKGllIDxjb2RlPm5nQmluZDwvY29kZT4gd2hpY2ggd2lsbCBtYXRjaCBhcwogICAgICAgICAqICAgICAgICAgICAgICAgIDxjb2RlPm5nLWJpbmQ8L2NvZGU+KS4KICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufEFycmF5fSBkaXJlY3RpdmVGYWN0b3J5IEFuIGluamVjdGFibGUgZGlyZWN0aXZlIGZhY3RvcnkgZnVuY3Rpb24uIFNlZSB7QGxpbmsgZ3VpZGUvZGlyZWN0aXZlfSBmb3IgbW9yZQogICAgICAgICAqICAgICAgICAgICAgICAgIGluZm8uCiAgICAgICAgICogQHJldHVybnMge25nLiRjb21waWxlUHJvdmlkZXJ9IFNlbGYgZm9yIGNoYWluaW5nLgogICAgICAgICAqLwogICAgICAgIHRoaXMuZGlyZWN0aXZlID0gZnVuY3Rpb24gcmVnaXN0ZXJEaXJlY3RpdmUobmFtZSwgZGlyZWN0aXZlRmFjdG9yeSkgewogICAgICAgICAgICBpZiAoaXNTdHJpbmcobmFtZSkpIHsKICAgICAgICAgICAgICAgIGFzc2VydEFyZyhkaXJlY3RpdmVGYWN0b3J5LCAnZGlyZWN0aXZlRmFjdG9yeScpOwogICAgICAgICAgICAgICAgaWYgKCFoYXNEaXJlY3RpdmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzRGlyZWN0aXZlc1tuYW1lXSA9IFtdOwogICAgICAgICAgICAgICAgICAgICRwcm92aWRlLmZhY3RvcnkobmFtZSArIFN1ZmZpeCwgWyckaW5qZWN0b3InLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCRpbmplY3RvciwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlyZWN0aXZlcyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goaGFzRGlyZWN0aXZlc1tuYW1lXSwgZnVuY3Rpb24gKGRpcmVjdGl2ZUZhY3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXJlY3RpdmUgPSAkaW5qZWN0b3IuaW52b2tlKGRpcmVjdGl2ZUZhY3RvcnkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oZGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IHsgY29tcGlsZTogdmFsdWVGbihkaXJlY3RpdmUpIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFkaXJlY3RpdmUuY29tcGlsZSAmJiBkaXJlY3RpdmUubGluaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5jb21waWxlID0gdmFsdWVGbihkaXJlY3RpdmUubGluayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucHJpb3JpdHkgPSBkaXJlY3RpdmUucHJpb3JpdHkgfHwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5uYW1lID0gZGlyZWN0aXZlLm5hbWUgfHwgbmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmUgfHwgKGRpcmVjdGl2ZS5jb250cm9sbGVyICYmIGRpcmVjdGl2ZS5uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGlyZWN0aXZlczsKICAgICAgICAgICAgICAgICAgICAgIH1dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhhc0RpcmVjdGl2ZXNbbmFtZV0ucHVzaChkaXJlY3RpdmVGYWN0b3J5KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvckVhY2gobmFtZSwgcmV2ZXJzZVBhcmFtcyhyZWdpc3RlckRpcmVjdGl2ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyI2FIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjb21waWxlUHJvdmlkZXIKICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgICAgICAgKiB1cmxzIGR1cmluZyBhW2hyZWZdIHNhbml0aXphdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIFRoZSBzYW5pdGl6YXRpb24gaXMgYSBzZWN1cml0eSBtZWFzdXJlIGFpbWVkIGF0IHByZXZlbnQgWFNTIGF0dGFja3MgdmlhIGh0bWwgbGlua3MuCiAgICAgICAgICoKICAgICAgICAgKiBBbnkgdXJsIGFib3V0IHRvIGJlIGFzc2lnbmVkIHRvIGFbaHJlZl0gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50bwogICAgICAgICAqIGFuIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcywgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdGAKICAgICAgICAgKiByZWd1bGFyIGV4cHJlc3Npb24uIElmIGEgbWF0Y2ggaXMgZm91bmQsIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSwKICAgICAgICAgKiB0aGUgYWJzb2x1dGUgdXJsIGlzIHByZWZpeGVkIHdpdGggYCd1bnNhZmU6J2Agc3RyaW5nIGFuZCBvbmx5IHRoZW4gaXMgaXQgd3JpdHRlbiBpbnRvIHRoZSBET00uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1JlZ0V4cD19IHJlZ2V4cCBOZXcgcmVnZXhwIHRvIHdoaXRlbGlzdCB1cmxzIHdpdGguCiAgICAgICAgICogQHJldHVybnMge1JlZ0V4cHxuZy4kY29tcGlsZVByb3ZpZGVyfSBDdXJyZW50IFJlZ0V4cCBpZiBjYWxsZWQgd2l0aG91dCB2YWx1ZSBvciBzZWxmIGZvcgogICAgICAgICAqICAgIGNoYWluaW5nIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLmFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gZnVuY3Rpb24gKHJlZ2V4cCkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgICAgICAgICAgIGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gcmVnZXhwOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0OwogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyI2ltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZVByb3ZpZGVyCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICAgICAgICogdXJscyBkdXJpbmcgaW1nW3NyY10gc2FuaXRpemF0aW9uLgogICAgICAgICAqCiAgICAgICAgICogVGhlIHNhbml0aXphdGlvbiBpcyBhIHNlY3VyaXR5IG1lYXN1cmUgYWltZWQgYXQgcHJldmVudCBYU1MgYXR0YWNrcyB2aWEgaHRtbCBsaW5rcy4KICAgICAgICAgKgogICAgICAgICAqIEFueSB1cmwgYWJvdXQgdG8gYmUgYXNzaWduZWQgdG8gaW1nW3NyY10gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50byBhbgogICAgICAgICAqIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcywgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3RgIHJlZ3VsYXIKICAgICAgICAgKiBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kLCB0aGUgb3JpZ2luYWwgdXJsIGlzIHdyaXR0ZW4gaW50byB0aGUgZG9tLiBPdGhlcndpc2UsIHRoZQogICAgICAgICAqIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGlzIGl0IHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAgICAgICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgICAgICAgKiAgICBjaGFpbmluZyBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5pbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbiAocmVnZXhwKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQocmVnZXhwKSkgewogICAgICAgICAgICAgICAgaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gcmVnZXhwOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdDsKICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWwogICAgICAgICAgICAgICAgICAnJGluamVjdG9yJywgJyRpbnRlcnBvbGF0ZScsICckZXhjZXB0aW9uSGFuZGxlcicsICckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckcGFyc2UnLAogICAgICAgICAgICAgICAgICAnJGNvbnRyb2xsZXInLCAnJHJvb3RTY29wZScsICckZG9jdW1lbnQnLCAnJHNjZScsICckJHVybFV0aWxzJywgJyRhbmltYXRlJywKICAgICAgICAgIGZ1bmN0aW9uICgkaW5qZWN0b3IsICRpbnRlcnBvbGF0ZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRodHRwLCAkdGVtcGxhdGVDYWNoZSwgJHBhcnNlLAogICAgICAgICAgICAgICAgICAgJGNvbnRyb2xsZXIsICRyb290U2NvcGUsICRkb2N1bWVudCwgJHNjZSwgJCR1cmxVdGlscywgJGFuaW1hdGUpIHsKCiAgICAgICAgICAgICAgdmFyIEF0dHJpYnV0ZXMgPSBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICB0aGlzLiQkZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHIgPSBhdHRyIHx8IHt9OwogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIEF0dHJpYnV0ZXMucHJvdG90eXBlID0gewogICAgICAgICAgICAgICAgICAkbm9ybWFsaXplOiBkaXJlY3RpdmVOb3JtYWxpemUsCgoKICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkYWRkQ2xhc3MKICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICogQWRkcyB0aGUgQ1NTIGNsYXNzIHZhbHVlIHNwZWNpZmllZCBieSB0aGUgY2xhc3NWYWwgcGFyYW1ldGVyIHRvIHRoZSBlbGVtZW50LiBJZiBhbmltYXRpb25zCiAgICAgICAgICAgICAgICAgICAqIGFyZSBlbmFibGVkIHRoZW4gYW4gYW5pbWF0aW9uIHdpbGwgYmUgdHJpZ2dlcmVkIGZvciB0aGUgY2xhc3MgYWRkaXRpb24uCiAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc1ZhbCBUaGUgY2xhc3NOYW1lIHZhbHVlIHRoYXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgJGFkZENsYXNzOiBmdW5jdGlvbiAoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjbGFzc1ZhbCAmJiBjbGFzc1ZhbC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3ModGhpcy4kJGVsZW1lbnQsIGNsYXNzVmFsKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJHJlbW92ZUNsYXNzCiAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcwogICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAqIFJlbW92ZXMgdGhlIENTUyBjbGFzcyB2YWx1ZSBzcGVjaWZpZWQgYnkgdGhlIGNsYXNzVmFsIHBhcmFtZXRlciBmcm9tIHRoZSBlbGVtZW50LiBJZiBhbmltYXRpb25zCiAgICAgICAgICAgICAgICAgICAqIGFyZSBlbmFibGVkIHRoZW4gYW4gYW5pbWF0aW9uIHdpbGwgYmUgdHJpZ2dlcmVkIGZvciB0aGUgY2xhc3MgcmVtb3ZhbC4KICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzVmFsIFRoZSBjbGFzc05hbWUgdmFsdWUgdGhhdCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgJHJlbW92ZUNsYXNzOiBmdW5jdGlvbiAoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjbGFzc1ZhbCAmJiBjbGFzc1ZhbC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3ModGhpcy4kJGVsZW1lbnQsIGNsYXNzVmFsKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgKiBTZXQgYSBub3JtYWxpemVkIGF0dHJpYnV0ZSBvbiB0aGUgZWxlbWVudCBpbiBhIHdheSBzdWNoIHRoYXQgYWxsIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgICAgICogY2FuIHNoYXJlIHRoZSBhdHRyaWJ1dGUuIFRoaXMgZnVuY3Rpb24gcHJvcGVybHkgaGFuZGxlcyBib29sZWFuIGF0dHJpYnV0ZXMuCiAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgTm9ybWFsaXplZCBrZXkuIChpZSBuZ0F0dHJpYnV0ZSkKICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8Ym9vbGVhbn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldC4gSWYgYG51bGxgIGF0dHJpYnV0ZSB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHdyaXRlQXR0ciBJZiBmYWxzZSwgZG9lcyBub3Qgd3JpdGUgdGhlIHZhbHVlIHRvIERPTSBlbGVtZW50IGF0dHJpYnV0ZS4KICAgICAgICAgICAgICAgICAgICogICAgIERlZmF1bHRzIHRvIHRydWUuCiAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gYXR0ck5hbWUgT3B0aW9uYWwgbm9uZSBub3JtYWxpemVkIG5hbWUuIERlZmF1bHRzIHRvIGtleS4KICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICRzZXQ6IGZ1bmN0aW9uIChrZXksIHZhbHVlLCB3cml0ZUF0dHIsIGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAvL3NwZWNpYWwgY2FzZSBmb3IgY2xhc3MgYXR0cmlidXRlIGFkZGl0aW9uICsgcmVtb3ZhbAogICAgICAgICAgICAgICAgICAgICAgLy9zbyB0aGF0IGNsYXNzIGNoYW5nZXMgY2FuIHRhcCBpbnRvIHRoZSBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICAgIC8vaG9va3MgcHJvdmlkZWQgYnkgdGhlICRhbmltYXRlIHNlcnZpY2UKICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkgPT0gJ2NsYXNzJykgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUgfHwgJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLiQkZWxlbWVudC5hdHRyKCdjbGFzcycpIHx8ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHJlbW92ZUNsYXNzKHRva2VuRGlmZmVyZW5jZShjdXJyZW50LCB2YWx1ZSkuam9pbignICcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRhZGRDbGFzcyh0b2tlbkRpZmZlcmVuY2UodmFsdWUsIGN1cnJlbnQpLmpvaW4oJyAnKSk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBib29sZWFuS2V5ID0gZ2V0Qm9vbGVhbkF0dHJOYW1lKHRoaXMuJCRlbGVtZW50WzBdLCBrZXkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVkVmFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTmFtZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJvb2xlYW5LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQucHJvcChrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ck5hbWUgPSBib29sZWFuS2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRyYW5zbGF0ZSBub3JtYWxpemVkIGtleSB0byBhY3R1YWwga2V5CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHJba2V5XSA9IGF0dHJOYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gdGhpcy4kYXR0cltrZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRhdHRyW2tleV0gPSBhdHRyTmFtZSA9IHNuYWtlX2Nhc2Uoa2V5LCAnLScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTmFtZSA9IG5vZGVOYW1lXyh0aGlzLiQkZWxlbWVudCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNhbml0aXplIGFbaHJlZl0gYW5kIGltZ1tzcmNdIHZhbHVlcwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgobm9kZU5hbWUgPT09ICdBJyAmJiBrZXkgPT09ICdocmVmJykgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5vZGVOYW1lID09PSAnSU1HJyAmJiBrZXkgPT09ICdzcmMnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOT1RFOiAkJHVybFV0aWxzLnJlc29sdmUoKSBkb2Vzbid0IHN1cHBvcnQgSUUgPCA4IHNvIHdlIGRvbid0IHNhbml0aXplIGZvciB0aGF0IGNhc2UuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbXNpZSB8fCBtc2llID49IDgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWwgPSAkJHVybFV0aWxzLnJlc29sdmUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRWYWwgIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChrZXkgPT09ICdocmVmJyAmJiAhbm9ybWFsaXplZFZhbC5tYXRjaChhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCkpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChrZXkgPT09ICdzcmMnICYmICFub3JtYWxpemVkVmFsLm1hdGNoKGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlID0gJ3Vuc2FmZTonICsgbm9ybWFsaXplZFZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3cml0ZUF0dHIgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5yZW1vdmVBdHRyKGF0dHJOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LmF0dHIoYXR0ck5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAvLyBmaXJlIG9ic2VydmVycwogICAgICAgICAgICAgICAgICAgICAgdmFyICQkb2JzZXJ2ZXJzID0gdGhpcy4kJG9ic2VydmVyczsKICAgICAgICAgICAgICAgICAgICAgICQkb2JzZXJ2ZXJzICYmIGZvckVhY2goJCRvYnNlcnZlcnNba2V5XSwgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gdG9rZW5EaWZmZXJlbmNlKHN0cjEsIHN0cjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWVzID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuczEgPSBzdHIxLnNwbGl0KC9ccysvKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zMiA9IHN0cjIuc3BsaXQoL1xzKy8pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRlcjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b2tlbnMxLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlbnMxW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0b2tlbnMyLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuID09IHRva2VuczJbal0pIGNvbnRpbnVlIG91dGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2godG9rZW4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAqIE9ic2VydmUgYW4gaW50ZXJwb2xhdGVkIGF0dHJpYnV0ZS4KICAgICAgICAgICAgICAgICAgICogVGhlIG9ic2VydmVyIHdpbGwgbmV2ZXIgYmUgY2FsbGVkLCBpZiBnaXZlbiBhdHRyaWJ1dGUgaXMgbm90IGludGVycG9sYXRlZC4KICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKSAuCiAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKil9IGZuIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbmV2ZXIgdGhlIGF0dHJpYnV0ZSB2YWx1ZSBjaGFuZ2VzLgogICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKil9IHRoZSBgZm5gIEZ1bmN0aW9uIHBhc3NlZCBpbi4KICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICRvYnNlcnZlOiBmdW5jdGlvbiAoa2V5LCBmbikgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJzID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAkJG9ic2VydmVycyA9IChhdHRycy4kJG9ic2VydmVycyB8fCAoYXR0cnMuJCRvYnNlcnZlcnMgPSB7fSkpLAogICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycyA9ICgkJG9ic2VydmVyc1trZXldIHx8ICgkJG9ic2VydmVyc1trZXldID0gW10pKTsKCiAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChmbik7CiAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGlzdGVuZXJzLiQkaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm8gb25lIHJlZ2lzdGVyZWQgYXR0cmlidXRlIGludGVycG9sYXRpb24gZnVuY3Rpb24sIHNvIGxldHMgY2FsbCBpdCBtYW51YWxseQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihhdHRyc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIHZhciB1cmxTYW5pdGl6YXRpb25Ob2RlID0gJGRvY3VtZW50WzBdLmNyZWF0ZUVsZW1lbnQoJ2EnKSwKICAgICAgICAgICAgICAgICAgc3RhcnRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2woKSwKICAgICAgICAgICAgICAgICAgZW5kU3ltYm9sID0gJGludGVycG9sYXRlLmVuZFN5bWJvbCgpLAogICAgICAgICAgICAgICAgICBkZW5vcm1hbGl6ZVRlbXBsYXRlID0gKHN0YXJ0U3ltYm9sID09ICd7eycgfHwgZW5kU3ltYm9sID09ICd9fScpCiAgICAgICAgICAgICAgICAgICAgICA/IGlkZW50aXR5CiAgICAgICAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uIGRlbm9ybWFsaXplVGVtcGxhdGUodGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGUucmVwbGFjZSgvXHtcey9nLCBzdGFydFN5bWJvbCkucmVwbGFjZSgvfX0vZywgZW5kU3ltYm9sKTsKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIE5HX0FUVFJfQklORElORyA9IC9ebmdBdHRyW0EtWl0vOwoKCiAgICAgICAgICAgICAgcmV0dXJuIGNvbXBpbGU7CgogICAgICAgICAgICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZSgkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgaWYgKCEoJGNvbXBpbGVOb2RlcyBpbnN0YW5jZW9mIGpxTGl0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGpxdWVyeSBhbHdheXMgcmV3cmFwcywgd2hlcmVhcyB3ZSBuZWVkIHRvIHByZXNlcnZlIHRoZSBvcmlnaW5hbCBzZWxlY3RvciBzbyB0aGF0IHdlIGNhbiBtb2RpZnkgaXQuCiAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGVzID0ganFMaXRlKCRjb21waWxlTm9kZXMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIFdlIGNhbiBub3QgY29tcGlsZSB0b3AgbGV2ZWwgdGV4dCBlbGVtZW50cyBzaW5jZSB0ZXh0IG5vZGVzIGNhbiBiZSBtZXJnZWQgYW5kIHdlIHdpbGwKICAgICAgICAgICAgICAgICAgLy8gbm90IGJlIGFibGUgdG8gYXR0YWNoIHNjb3BlIGRhdGEgdG8gdGhlbSwgc28gd2Ugd2lsbCB3cmFwIHRoZW0gaW4gPHNwYW4+CiAgICAgICAgICAgICAgICAgIGZvckVhY2goJGNvbXBpbGVOb2RlcywgZnVuY3Rpb24gKG5vZGUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAzIC8qIHRleHQgbm9kZSAqLyAmJiBub2RlLm5vZGVWYWx1ZS5tYXRjaCgvXFMrLykgLyogbm9uLWVtcHR5ICovKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2Rlc1tpbmRleF0gPSBub2RlID0ganFMaXRlKG5vZGUpLndyYXAoJzxzcGFuPjwvc3Bhbj4nKS5wYXJlbnQoKVswXTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBjb21wb3NpdGVMaW5rRm4gPSBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlcywgdHJhbnNjbHVkZUZuLCAkY29tcGlsZU5vZGVzLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHB1YmxpY0xpbmtGbihzY29wZSwgY2xvbmVDb25uZWN0Rm4pIHsKICAgICAgICAgICAgICAgICAgICAgIGFzc2VydEFyZyhzY29wZSwgJ3Njb3BlJyk7CiAgICAgICAgICAgICAgICAgICAgICAvLyBpbXBvcnRhbnQhITogd2UgbXVzdCBjYWxsIG91ciBqcUxpdGUuY2xvbmUoKSBzaW5jZSB0aGUgalF1ZXJ5IG9uZSBpcyB0cnlpbmcgdG8gYmUgc21hcnQKICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBzb21ldGltZXMgY2hhbmdlcyB0aGUgc3RydWN0dXJlIG9mIHRoZSBET00uCiAgICAgICAgICAgICAgICAgICAgICB2YXIgJGxpbmtOb2RlID0gY2xvbmVDb25uZWN0Rm4KICAgICAgICAgICAgICAgICAgICAgICAgPyBKUUxpdGVQcm90b3R5cGUuY2xvbmUuY2FsbCgkY29tcGlsZU5vZGVzKSAvLyBJTVBPUlRBTlQhISEKICAgICAgICAgICAgICAgICAgICAgICAgOiAkY29tcGlsZU5vZGVzOwoKICAgICAgICAgICAgICAgICAgICAgIC8vIEF0dGFjaCBzY29wZSBvbmx5IHRvIG5vbi10ZXh0IG5vZGVzLgogICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gJGxpbmtOb2RlLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZSA9ICRsaW5rTm9kZVtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAxIC8qIGVsZW1lbnQgKi8gfHwgbm9kZS5ub2RlVHlwZSA9PSA5IC8qIGRvY3VtZW50ICovKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsaW5rTm9kZS5lcShpKS5kYXRhKCckc2NvcGUnLCBzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKCRsaW5rTm9kZSwgJ25nLXNjb3BlJyk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoY2xvbmVDb25uZWN0Rm4pIGNsb25lQ29ubmVjdEZuKCRsaW5rTm9kZSwgc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBvc2l0ZUxpbmtGbikgY29tcG9zaXRlTGlua0ZuKHNjb3BlLCAkbGlua05vZGUsICRsaW5rTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGxpbmtOb2RlOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZnVuY3Rpb24gc2FmZUFkZENsYXNzKCRlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGlnbm9yZSwgc2luY2UgaXQgbWVhbnMgdGhhdCB3ZSBhcmUgdHJ5aW5nIHRvIHNldCBjbGFzcyBvbgogICAgICAgICAgICAgICAgICAgICAgLy8gU1ZHIGVsZW1lbnQsIHdoZXJlIGNsYXNzIG5hbWUgaXMgcmVhZC1vbmx5LgogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgKiBDb21waWxlIGZ1bmN0aW9uIG1hdGNoZXMgZWFjaCBub2RlIGluIG5vZGVMaXN0IGFnYWluc3QgdGhlIGRpcmVjdGl2ZXMuIE9uY2UgYWxsIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgKiBmb3IgYSBwYXJ0aWN1bGFyIG5vZGUgYXJlIGNvbGxlY3RlZCB0aGVpciBjb21waWxlIGZ1bmN0aW9ucyBhcmUgZXhlY3V0ZWQuIFRoZSBjb21waWxlCiAgICAgICAgICAgICAgICogZnVuY3Rpb25zIHJldHVybiB2YWx1ZXMgLSB0aGUgbGlua2luZyBmdW5jdGlvbnMgLSBhcmUgY29tYmluZWQgaW50byBhIGNvbXBvc2l0ZSBsaW5raW5nCiAgICAgICAgICAgICAgICogZnVuY3Rpb24sIHdoaWNoIGlzIHRoZSBhIGxpbmtpbmcgZnVuY3Rpb24gZm9yIHRoZSBub2RlLgogICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICogQHBhcmFtIHtOb2RlTGlzdH0gbm9kZUxpc3QgYW4gYXJyYXkgb2Ygbm9kZXMgb3IgTm9kZUxpc3QgdG8gY29tcGlsZQogICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZVssIGNsb25lQXR0YWNoRm5dfSB0cmFuc2NsdWRlRm4gQSBsaW5raW5nIGZ1bmN0aW9uLCB3aGVyZSB0aGUKICAgICAgICAgICAgICAgKiAgICAgICAgc2NvcGUgYXJndW1lbnQgaXMgYXV0by1nZW5lcmF0ZWQgdG8gdGhlIG5ldyBjaGlsZCBvZiB0aGUgdHJhbnNjbHVkZWQgcGFyZW50IHNjb3BlLgogICAgICAgICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudD19ICRyb290RWxlbWVudCBJZiB0aGUgbm9kZUxpc3QgaXMgdGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGF0aW9uIHRyZWUgdGhlbiB0aGUKICAgICAgICAgICAgICAgKiAgICAgICAgcm9vdEVsZW1lbnQgbXVzdCBiZSBzZXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIG9mIHRoZSBjb21waWxlIHJvb3QuIFRoaXMgaXMKICAgICAgICAgICAgICAgKiAgICAgICAgbmVlZGVkIHNvIHRoYXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIGl0ZW1zIGNhbiBiZSByZXBsYWNlZCB3aXRoIHdpZGdldHMuCiAgICAgICAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBtYXggZGlyZWN0aXZlIHByaW9yaXR5CiAgICAgICAgICAgICAgICogQHJldHVybnMgez9mdW5jdGlvbn0gQSBjb21wb3NpdGUgbGlua2luZyBmdW5jdGlvbiBvZiBhbGwgb2YgdGhlIG1hdGNoZWQgZGlyZWN0aXZlcyBvciBudWxsLgogICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVOb2Rlcyhub2RlTGlzdCwgdHJhbnNjbHVkZUZuLCAkcm9vdEVsZW1lbnQsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGxpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBkaXJlY3RpdmVzLCBhdHRycywgbGlua0ZuRm91bmQ7CgogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGVMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IG5ldyBBdHRyaWJ1dGVzKCk7CgogICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbXVzdCBhbHdheXMgcmVmZXIgdG8gbm9kZUxpc3RbaV0gc2luY2UgdGhlIG5vZGVzIGNhbiBiZSByZXBsYWNlZCB1bmRlcm5lYXRoIHVzLgogICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcyA9IGNvbGxlY3REaXJlY3RpdmVzKG5vZGVMaXN0W2ldLCBbXSwgYXR0cnMsIGkgPT0gMCA/IG1heFByaW9yaXR5IDogdW5kZWZpbmVkLCBpZ25vcmVEaXJlY3RpdmUpOwoKICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4gPSAoZGlyZWN0aXZlcy5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyBhcHBseURpcmVjdGl2ZXNUb05vZGUoZGlyZWN0aXZlcywgbm9kZUxpc3RbaV0sIGF0dHJzLCB0cmFuc2NsdWRlRm4sICRyb290RWxlbWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgY2hpbGRMaW5rRm4gPSAobm9kZUxpbmtGbiAmJiBub2RlTGlua0ZuLnRlcm1pbmFsIHx8ICFub2RlTGlzdFtpXS5jaGlsZE5vZGVzIHx8ICFub2RlTGlzdFtpXS5jaGlsZE5vZGVzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICA/IG51bGwKICAgICAgICAgICAgICAgICAgICAgICAgICA6IGNvbXBpbGVOb2Rlcyhub2RlTGlzdFtpXS5jaGlsZE5vZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA/IG5vZGVMaW5rRm4udHJhbnNjbHVkZSA6IHRyYW5zY2x1ZGVGbik7CgogICAgICAgICAgICAgICAgICAgICAgbGlua0Zucy5wdXNoKG5vZGVMaW5rRm4pOwogICAgICAgICAgICAgICAgICAgICAgbGlua0Zucy5wdXNoKGNoaWxkTGlua0ZuKTsKICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbkZvdW5kID0gKGxpbmtGbkZvdW5kIHx8IG5vZGVMaW5rRm4gfHwgY2hpbGRMaW5rRm4pOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyByZXR1cm4gYSBsaW5raW5nIGZ1bmN0aW9uIGlmIHdlIGhhdmUgZm91bmQgYW55dGhpbmcsIG51bGwgb3RoZXJ3aXNlCiAgICAgICAgICAgICAgICAgIHJldHVybiBsaW5rRm5Gb3VuZCA/IGNvbXBvc2l0ZUxpbmtGbiA6IG51bGw7CgogICAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb21wb3NpdGVMaW5rRm4oc2NvcGUsIG5vZGVMaXN0LCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZUxpbmtGbiwgY2hpbGRMaW5rRm4sIG5vZGUsIGNoaWxkU2NvcGUsIGNoaWxkVHJhbnNjbHVkZUZuLCBpLCBpaSwgbjsKCiAgICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IG5vZGVMaXN0IHNvIHRoYXQgbGlua2luZyBkb2Vzbid0IGJyZWFrIGR1ZSB0byBsaXZlIGxpc3QgdXBkYXRlcy4KICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFibGVOb2RlTGlzdCA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWkgPSBub2RlTGlzdC5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhYmxlTm9kZUxpc3QucHVzaChub2RlTGlzdFtpXSk7CiAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbiA9IDAsIGlpID0gbGlua0Zucy5sZW5ndGg7IGkgPCBpaTsgbisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHN0YWJsZU5vZGVMaXN0W25dOwogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4gPSBsaW5rRm5zW2krK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRMaW5rRm4gPSBsaW5rRm5zW2krK107CgogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTGlua0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTGlua0ZuLnNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGUuJG5ldyhpc09iamVjdChub2RlTGlua0ZuLnNjb3BlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqcUxpdGUobm9kZSkuZGF0YSgnJHNjb3BlJywgY2hpbGRTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBub2RlTGlua0ZuLnRyYW5zY2x1ZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFRyYW5zY2x1ZGVGbiB8fCAoIWJvdW5kVHJhbnNjbHVkZUZuICYmIHRyYW5zY2x1ZGVGbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIGNoaWxkU2NvcGUsIG5vZGUsICRyb290RWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKHRyYW5zY2x1ZGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGNsb25lRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2NsdWRlU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2NsdWRlU2NvcGUuJCR0cmFuc2NsdWRlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRyYW5zY2x1ZGVGbih0cmFuc2NsdWRlU2NvcGUsIGNsb25lRm4pLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uKCckZGVzdHJveScsIGJpbmQodHJhbnNjbHVkZVNjb3BlLCB0cmFuc2NsdWRlU2NvcGUuJGRlc3Ryb3kpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KShjaGlsZFRyYW5zY2x1ZGVGbiB8fCB0cmFuc2NsdWRlRm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgY2hpbGRTY29wZSwgbm9kZSwgdW5kZWZpbmVkLCBib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkTGlua0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuKHNjb3BlLCBub2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAqIExvb2tzIGZvciBkaXJlY3RpdmVzIG9uIHRoZSBnaXZlbiBub2RlIGFuZCBhZGRzIHRoZW0gdG8gdGhlIGRpcmVjdGl2ZSBjb2xsZWN0aW9uIHdoaWNoIGlzCiAgICAgICAgICAgICAgICogc29ydGVkLgogICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBzZWFyY2guCiAgICAgICAgICAgICAgICogQHBhcmFtIGRpcmVjdGl2ZXMgQW4gYXJyYXkgdG8gd2hpY2ggdGhlIGRpcmVjdGl2ZXMgYXJlIGFkZGVkIHRvLiBUaGlzIGFycmF5IGlzIHNvcnRlZCBiZWZvcmUKICAgICAgICAgICAgICAgKiAgICAgICAgdGhlIGZ1bmN0aW9uIHJldHVybnMuCiAgICAgICAgICAgICAgICogQHBhcmFtIGF0dHJzIFRoZSBzaGFyZWQgYXR0cnMgb2JqZWN0IHdoaWNoIGlzIHVzZWQgdG8gcG9wdWxhdGUgdGhlIG5vcm1hbGl6ZWQgYXR0cmlidXRlcy4KICAgICAgICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG1heFByaW9yaXR5IE1heCBkaXJlY3RpdmUgcHJpb3JpdHkuCiAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgZnVuY3Rpb24gY29sbGVjdERpcmVjdGl2ZXMobm9kZSwgZGlyZWN0aXZlcywgYXR0cnMsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZSwKICAgICAgICAgICAgICAgICAgICAgIGF0dHJzTWFwID0gYXR0cnMuJGF0dHIsCiAgICAgICAgICAgICAgICAgICAgICBtYXRjaCwKICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTsKCiAgICAgICAgICAgICAgICAgIHN3aXRjaCAobm9kZVR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTogLyogRWxlbWVudCAqLwogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVzZSB0aGUgbm9kZSBuYW1lOiA8ZGlyZWN0aXZlPgogICAgICAgICAgICAgICAgICAgICAgICAgIGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVOb3JtYWxpemUobm9kZU5hbWVfKG5vZGUpLnRvTG93ZXJDYXNlKCkpLCAnRScsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgdGhlIGF0dHJpYnV0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBhdHRyLCBuYW1lLCBuTmFtZSwgbmdBdHRyTmFtZSwgdmFsdWUsIG5BdHRycyA9IG5vZGUuYXR0cmlidXRlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqID0gMCwgamogPSBuQXR0cnMgJiYgbkF0dHJzLmxlbmd0aDsgaiA8IGpqOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJTdGFydE5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRyRW5kTmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ciA9IG5BdHRyc1tqXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtc2llIHx8IG1zaWUgPj0gOCB8fCBhdHRyLnNwZWNpZmllZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IGF0dHIubmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN1cHBvcnQgbmdBdHRyIGF0dHJpYnV0ZSBiaW5kaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZ0F0dHJOYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE5HX0FUVFJfQklORElORy50ZXN0KG5nQXR0ck5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IG5nQXR0ck5hbWUuc3Vic3RyKDYpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGluZGV4ID0gbmdBdHRyTmFtZS5sYXN0SW5kZXhPZignU3RhcnQnKSkgIT0gLTEgJiYgaW5kZXggPT0gbmdBdHRyTmFtZS5sZW5ndGggLSA1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0clN0YXJ0TmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ckVuZE5hbWUgPSBuYW1lLnN1YnN0cigwLCBuYW1lLmxlbmd0aCAtIDUpICsgJ2VuZCc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyKDAsIG5hbWUubGVuZ3RoIC0gNik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNNYXBbbk5hbWVdID0gbmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHZhbHVlID0gdHJpbSgobXNpZSAmJiBuYW1lID09ICdocmVmJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBkZWNvZGVVUklDb21wb25lbnQobm9kZS5nZXRBdHRyaWJ1dGUobmFtZSwgMikpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogYXR0ci52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ2V0Qm9vbGVhbkF0dHJOYW1lKG5vZGUsIG5OYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRydWU7IC8vIHByZXNlbmNlIG1lYW5zIHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEF0dHJJbnRlcnBvbGF0ZURpcmVjdGl2ZShub2RlLCBkaXJlY3RpdmVzLCB2YWx1ZSwgbk5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQScsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsIGF0dHJTdGFydE5hbWUsIGF0dHJFbmROYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXNlIGNsYXNzIGFzIGRpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9IG5vZGUuY2xhc3NOYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyhjbGFzc05hbWUpICYmIGNsYXNzTmFtZSAhPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG1hdGNoID0gQ0xBU1NfRElSRUNUSVZFX1JFR0VYUC5leGVjKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG1hdGNoWzJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhZGREaXJlY3RpdmUoZGlyZWN0aXZlcywgbk5hbWUsICdDJywgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB0cmltKG1hdGNoWzNdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZS5zdWJzdHIobWF0Y2guaW5kZXggKyBtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSAzOiAvKiBUZXh0IE5vZGUgKi8KICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRUZXh0SW50ZXJwb2xhdGVEaXJlY3RpdmUoZGlyZWN0aXZlcywgbm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSA4OiAvKiBDb21tZW50ICovCiAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBDT01NRU5UX0RJUkVDVElWRV9SRUdFWFAuZXhlYyhub2RlLm5vZGVWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ00nLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRyaW0obWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0dXJucyBvdXQgdGhhdCB1bmRlciBzb21lIGNpcmN1bXN0YW5jZXMgSUU5IHRocm93cyBlcnJvcnMgd2hlbiBvbmUgYXR0ZW1wdHMgdG8gcmVhZCBjb21tZW50J3Mgbm9kZSB2YWx1ZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVzdCBpZ25vcmUgaXQgYW5kIGNvbnRpbnVlLiAoQ2FuJ3Qgc2VlbSB0byByZXByb2R1Y2UgaW4gdGVzdCBjYXNlLikKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMuc29ydChieVByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpcmVjdGl2ZXM7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgKiBHaXZlbiBhIG5vZGUgd2l0aCBhbiBkaXJlY3RpdmUtc3RhcnQgaXQgY29sbGVjdHMgYWxsIG9mIHRoZSBzaWJsaW5ncyB1bnRpbCBpdCBmaW5kIGRpcmVjdGl2ZS1lbmQuCiAgICAgICAgICAgICAgICogQHBhcmFtIG5vZGUKICAgICAgICAgICAgICAgKiBAcGFyYW0gYXR0clN0YXJ0CiAgICAgICAgICAgICAgICogQHBhcmFtIGF0dHJFbmQKICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0KICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICBmdW5jdGlvbiBncm91cFNjYW4obm9kZSwgYXR0clN0YXJ0LCBhdHRyRW5kKSB7CiAgICAgICAgICAgICAgICAgIHZhciBub2RlcyA9IFtdOwogICAgICAgICAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgICAgICAgICBpZiAoYXR0clN0YXJ0ICYmIG5vZGUuaGFzQXR0cmlidXRlICYmIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJTdGFydCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFydE5vZGUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndXRlcmRpcicsICJVbnRlcm1pbmF0ZWQgYXR0cmlidXRlLCBmb3VuZCAnezB9JyBidXQgbm8gbWF0Y2hpbmcgJ3sxfScgZm91bmQuIiwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSAvKiogRWxlbWVudCAqKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJTdGFydCkpIGRlcHRoKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZShhdHRyRW5kKSkgZGVwdGgtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXMucHVzaChub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRlcHRoID4gMCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBub2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBqcUxpdGUobm9kZXMpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICogV3JhcHBlciBmb3IgbGlua2luZyBmdW5jdGlvbiB3aGljaCBjb252ZXJ0cyBub3JtYWwgbGlua2luZyBmdW5jdGlvbiBpbnRvIGEgZ3JvdXBlZAogICAgICAgICAgICAgICAqIGxpbmtpbmcgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICogQHBhcmFtIGxpbmtGbgogICAgICAgICAgICAgICAqIEBwYXJhbSBhdHRyU3RhcnQKICAgICAgICAgICAgICAgKiBAcGFyYW0gYXR0ckVuZAogICAgICAgICAgICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0KICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICBmdW5jdGlvbiBncm91cEVsZW1lbnRzTGlua0ZuV3JhcHBlcihsaW5rRm4sIGF0dHJTdGFydCwgYXR0ckVuZCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBncm91cFNjYW4oZWxlbWVudFswXSwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsaW5rRm4oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjb250cm9sbGVycyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAqIE9uY2UgdGhlIGRpcmVjdGl2ZXMgaGF2ZSBiZWVuIGNvbGxlY3RlZCwgdGhlaXIgY29tcGlsZSBmdW5jdGlvbnMgYXJlIGV4ZWN1dGVkLiBUaGlzIG1ldGhvZAogICAgICAgICAgICAgICAqIGlzIHJlc3BvbnNpYmxlIGZvciBpbmxpbmluZyBkaXJlY3RpdmUgdGVtcGxhdGVzIGFzIHdlbGwgYXMgdGVybWluYXRpbmcgdGhlIGFwcGxpY2F0aW9uCiAgICAgICAgICAgICAgICogb2YgdGhlIGRpcmVjdGl2ZXMgaWYgdGhlIHRlcm1pbmFsIGRpcmVjdGl2ZSBoYXMgYmVlbiByZWFjaGVkLgogICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheX0gZGlyZWN0aXZlcyBBcnJheSBvZiBjb2xsZWN0ZWQgZGlyZWN0aXZlcyB0byBleGVjdXRlIHRoZWlyIGNvbXBpbGUgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICogICAgICAgIHRoaXMgbmVlZHMgdG8gYmUgcHJlLXNvcnRlZCBieSBwcmlvcml0eSBvcmRlci4KICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGV9IGNvbXBpbGVOb2RlIFRoZSByYXcgRE9NIG5vZGUgdG8gYXBwbHkgdGhlIGNvbXBpbGUgZnVuY3Rpb25zIHRvCiAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRlbXBsYXRlQXR0cnMgVGhlIHNoYXJlZCBhdHRyaWJ1dGUgZnVuY3Rpb24KICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGFuZ3VsYXIuU2NvcGVbLCBjbG9uZUF0dGFjaEZuXX0gdHJhbnNjbHVkZUZuIEEgbGlua2luZyBmdW5jdGlvbiwgd2hlcmUgdGhlCiAgICAgICAgICAgICAgICogICAgICAgIHNjb3BlIGFyZ3VtZW50IGlzIGF1dG8tZ2VuZXJhdGVkIHRvIHRoZSBuZXcgY2hpbGQgb2YgdGhlIHRyYW5zY2x1ZGVkIHBhcmVudCBzY29wZS4KICAgICAgICAgICAgICAgKiBAcGFyYW0ge0pRTGl0ZX0ganFDb2xsZWN0aW9uIElmIHdlIGFyZSB3b3JraW5nIG9uIHRoZSByb290IG9mIHRoZSBjb21waWxlIHRyZWUgdGhlbiB0aGlzCiAgICAgICAgICAgICAgICogICAgICAgIGFyZ3VtZW50IGhhcyB0aGUgcm9vdCBqcUxpdGUgYXJyYXkgc28gdGhhdCB3ZSBjYW4gcmVwbGFjZSBub2RlcyBvbiBpdC4KICAgICAgICAgICAgICAgKiBAcmV0dXJucyBsaW5rRm4KICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICBmdW5jdGlvbiBhcHBseURpcmVjdGl2ZXNUb05vZGUoZGlyZWN0aXZlcywgY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIHRyYW5zY2x1ZGVGbiwganFDb2xsZWN0aW9uLCBvcmlnaW5hbFJlcGxhY2VEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgdmFyIHRlcm1pbmFsUHJpb3JpdHkgPSAtTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICAgICAgICAgICAgICAgIHByZUxpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgIHBvc3RMaW5rRm5zID0gW10sCiAgICAgICAgICAgICAgICAgICAgICBuZXdTY29wZURpcmVjdGl2ZSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlID0gdGVtcGxhdGVBdHRycy4kJGVsZW1lbnQgPSBqcUxpdGUoY29tcGlsZU5vZGUpLAogICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSwKICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlRGlyZWN0aXZlID0gb3JpZ2luYWxSZXBsYWNlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSB0cmFuc2NsdWRlRm4sCiAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcywKICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbiwKICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlOwoKICAgICAgICAgICAgICAgICAgLy8gZXhlY3V0ZXMgYWxsIGRpcmVjdGl2ZXMgb24gdGhlIGN1cnJlbnQgZWxlbWVudAogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0clN0YXJ0ID0gZGlyZWN0aXZlLiQkc3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0ckVuZCA9IGRpcmVjdGl2ZS4kJGVuZDsKCiAgICAgICAgICAgICAgICAgICAgICAvLyBjb2xsZWN0IG11bHRpYmxvY2sgc2VjdGlvbnMKICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHRyU3RhcnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUgPSBncm91cFNjYW4oY29tcGlsZU5vZGUsIGF0dHJTdGFydCwgYXR0ckVuZCkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICAgICAgICBpZiAodGVybWluYWxQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOyAvLyBwcmV2ZW50IGZ1cnRoZXIgcHJvY2Vzc2luZyBvZiBkaXJlY3RpdmVzCiAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ2lzb2xhdGVkIHNjb3BlJywgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGRpcmVjdGl2ZVZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGNvbXBpbGVOb2RlLCAnbmctaXNvbGF0ZS1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkY29tcGlsZU5vZGUsICduZy1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1Njb3BlRGlyZWN0aXZlID0gbmV3U2NvcGVEaXJlY3RpdmUgfHwgZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmUubmFtZTsKCiAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUuY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzID0gY29udHJvbGxlckRpcmVjdGl2ZXMgfHwge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoIiciICsgZGlyZWN0aXZlTmFtZSArICInIGNvbnRyb2xsZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS50cmFuc2NsdWRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RyYW5zY2x1c2lvbicsIHRyYW5zY2x1ZGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2NsdWRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRlcm1pbmFsUHJpb3JpdHkgPSBkaXJlY3RpdmUucHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID09ICdlbGVtZW50JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBncm91cFNjYW4oY29tcGlsZU5vZGUsIGF0dHJTdGFydCwgYXR0ckVuZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlID0gdGVtcGxhdGVBdHRycy4kJGVsZW1lbnQgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganFMaXRlKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyAnICsgZGlyZWN0aXZlTmFtZSArICc6ICcgKyB0ZW1wbGF0ZUF0dHJzW2RpcmVjdGl2ZU5hbWVdICsgJyAnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlV2l0aChqcUNvbGxlY3Rpb24sIGpxTGl0ZShzbGljZUFyZ3MoJHRlbXBsYXRlKSksIGNvbXBpbGVOb2RlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gY29tcGlsZSgkdGVtcGxhdGUsIHRyYW5zY2x1ZGVGbiwgdGVybWluYWxQcmlvcml0eSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VEaXJlY3RpdmUgJiYgcmVwbGFjZURpcmVjdGl2ZS5uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoSlFMaXRlQ2xvbmUoY29tcGlsZU5vZGUpKS5jb250ZW50cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbCgnJyk7IC8vIGNsZWFyIGNvbnRlbnRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gY29tcGlsZSgkdGVtcGxhdGUsIHRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgndGVtcGxhdGUnLCB0ZW1wbGF0ZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZSA9IChpc0Z1bmN0aW9uKGRpcmVjdGl2ZS50ZW1wbGF0ZSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZGlyZWN0aXZlLnRlbXBsYXRlKCRjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBkaXJlY3RpdmUudGVtcGxhdGU7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlID0gZGVub3JtYWxpemVUZW1wbGF0ZShkaXJlY3RpdmVWYWx1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUucmVwbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoJzxkaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyaW0oZGlyZWN0aXZlVmFsdWUpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nKS5jb250ZW50cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSA9ICR0ZW1wbGF0ZVswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdGVtcGxhdGUubGVuZ3RoICE9IDEgfHwgY29tcGlsZU5vZGUubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCd0cGxydCcsICJUZW1wbGF0ZSBmb3IgZGlyZWN0aXZlICd7MH0nIG11c3QgaGF2ZSBleGFjdGx5IG9uZSByb290IGVsZW1lbnQuIHsxfSIsIGRpcmVjdGl2ZU5hbWUsICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgoanFDb2xsZWN0aW9uLCAkY29tcGlsZU5vZGUsIGNvbXBpbGVOb2RlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdUZW1wbGF0ZUF0dHJzID0geyAkYXR0cjoge30gfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbWJpbmUgZGlyZWN0aXZlcyBmcm9tIHRoZSBvcmlnaW5hbCBub2RlIGFuZCBmcm9tIHRoZSB0ZW1wbGF0ZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSB0YWtlIHRoZSBhcnJheSBvZiBkaXJlY3RpdmVzIGZvciB0aGlzIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBzcGxpdCBpdCBpbnRvIHR3byBwYXJ0cywgdGhvc2UgdGhhdCB3ZXJlIGFscmVhZHkgYXBwbGllZCBhbmQgdGhvc2UgdGhhdCB3ZXJlbid0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gY29sbGVjdCBkaXJlY3RpdmVzIGZyb20gdGhlIHRlbXBsYXRlLCBhZGQgdGhlbSB0byB0aGUgc2Vjb25kIGdyb3VwIGFuZCBzb3J0IHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBhcHBlbmQgdGhlIHNlY29uZCBncm91cCB3aXRoIG5ldyBkaXJlY3RpdmVzIHRvIHRoZSBmaXJzdCBncm91cAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzID0gZGlyZWN0aXZlcy5jb25jYXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0RGlyZWN0aXZlcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnNwbGljZShpICsgMSwgZGlyZWN0aXZlcy5sZW5ndGggLSAoaSArIDEpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUZW1wbGF0ZUF0dHJzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKHRlbXBsYXRlQXR0cnMsIG5ld1RlbXBsYXRlQXR0cnMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbChkaXJlY3RpdmVWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVtcGxhdGVVcmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgndGVtcGxhdGUnLCB0ZW1wbGF0ZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlLnJlcGxhY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLnNwbGljZShpLCBkaXJlY3RpdmVzLmxlbmd0aCAtIGkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLCAkY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIGpxQ29sbGVjdGlvbiwgY2hpbGRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRpcmVjdGl2ZS5jb21waWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuID0gZGlyZWN0aXZlLmNvbXBpbGUoJGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCBjaGlsZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGxpbmtGbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZExpbmtGbnMobnVsbCwgbGlua0ZuLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGxpbmtGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTGlua0ZucyhsaW5rRm4ucHJlLCBsaW5rRm4ucG9zdCwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGNvbXBpbGVOb2RlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVybWluYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLnRlcm1pbmFsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXJtaW5hbFByaW9yaXR5ID0gTWF0aC5tYXgodGVybWluYWxQcmlvcml0eSwgZGlyZWN0aXZlLnByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4uc2NvcGUgPSBuZXdTY29wZURpcmVjdGl2ZSAmJiBuZXdTY29wZURpcmVjdGl2ZS5zY29wZTsKICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbi50cmFuc2NsdWRlID0gdHJhbnNjbHVkZURpcmVjdGl2ZSAmJiBjaGlsZFRyYW5zY2x1ZGVGbjsKCiAgICAgICAgICAgICAgICAgIC8vIG1pZ2h0IGJlIG5vcm1hbCBvciBkZWxheWVkIG5vZGVMaW5rRm4gZGVwZW5kaW5nIG9uIGlmIHRlbXBsYXRlVXJsIGlzIHByZXNlbnQKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGVMaW5rRm47CgogICAgICAgICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gYWRkTGlua0ZucyhwcmUsIHBvc3QsIGF0dHJTdGFydCwgYXR0ckVuZCkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKHByZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHRyU3RhcnQpIHByZSA9IGdyb3VwRWxlbWVudHNMaW5rRm5XcmFwcGVyKHByZSwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHByZUxpbmtGbnMucHVzaChwcmUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0clN0YXJ0KSBwb3N0ID0gZ3JvdXBFbGVtZW50c0xpbmtGbldyYXBwZXIocG9zdCwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0LnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0TGlua0Zucy5wdXNoKHBvc3QpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q29udHJvbGxlcnMocmVxdWlyZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSwgcmV0cmlldmFsTWV0aG9kID0gJ2RhdGEnLCBvcHRpb25hbCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHJlcXVpcmUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCh2YWx1ZSA9IHJlcXVpcmUuY2hhckF0KDApKSA9PSAnXicgfHwgdmFsdWUgPT0gJz8nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmUgPSByZXF1aXJlLnN1YnN0cigxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09ICdeJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0cmlldmFsTWV0aG9kID0gJ2luaGVyaXRlZERhdGEnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbmFsID0gb3B0aW9uYWwgfHwgdmFsdWUgPT0gJz8nOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICRlbGVtZW50W3JldHJpZXZhbE1ldGhvZF0oJyQnICsgcmVxdWlyZSArICdDb250cm9sbGVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZSAmJiAhb3B0aW9uYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ2N0cmVxJywgIkNvbnRyb2xsZXIgJ3swfScsIHJlcXVpcmVkIGJ5IGRpcmVjdGl2ZSAnezF9JywgY2FuJ3QgYmUgZm91bmQhIiwgcmVxdWlyZSwgZGlyZWN0aXZlTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShyZXF1aXJlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChyZXF1aXJlLCBmdW5jdGlvbiAocmVxdWlyZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKGdldENvbnRyb2xsZXJzKHJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICBmdW5jdGlvbiBub2RlTGlua0ZuKGNoaWxkTGlua0ZuLCBzY29wZSwgbGlua05vZGUsICRyb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRycywgJGVsZW1lbnQsIGksIGlpLCBsaW5rRm4sIGNvbnRyb2xsZXI7CgogICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBpbGVOb2RlID09PSBsaW5rTm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzID0gdGVtcGxhdGVBdHRyczsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSBzaGFsbG93Q29weSh0ZW1wbGF0ZUF0dHJzLCBuZXcgQXR0cmlidXRlcyhqcUxpdGUobGlua05vZGUpLCB0ZW1wbGF0ZUF0dHJzLiRhdHRyKSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudCA9IGF0dHJzLiQkZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIExPQ0FMX1JFR0VYUCA9IC9eXHMqKFtAPSZdKShcPz8pXHMqKFx3KilccyokLzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFNjb3BlID0gc2NvcGUuJHBhcmVudCB8fCBzY29wZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUuc2NvcGUsIGZ1bmN0aW9uIChkZWZpbml0aW9uLCBzY29wZU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZGVmaW5pdGlvbi5tYXRjaChMT0NBTF9SRUdFWFApIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ck5hbWUgPSBtYXRjaFszXSB8fCBzY29wZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25hbCA9IChtYXRjaFsyXSA9PSAnPycpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZSA9IG1hdGNoWzFdLCAvLyBALCA9LCBvciAmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRHZXQsIHBhcmVudFNldDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiQkaXNvbGF0ZUJpbmRpbmdzW3Njb3BlTmFtZV0gPSBtb2RlICsgYXR0ck5hbWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdAJzogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKGF0dHJOYW1lLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVbc2NvcGVOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzLiQkb2JzZXJ2ZXJzW2F0dHJOYW1lXS4kJHNjb3BlID0gcGFyZW50U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJzW2F0dHJOYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgYXR0cmlidXRlIGhhcyBiZWVuIHByb3ZpZGVkIHRoZW4gd2UgdHJpZ2dlciBhbiBpbnRlcnBvbGF0aW9uIHRvIGVuc3VyZSB0aGUgdmFsdWUgaXMgdGhlcmUgZm9yIHVzZSBpbiB0aGUgbGluayBmbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gJGludGVycG9sYXRlKGF0dHJzW2F0dHJOYW1lXSkocGFyZW50U2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICc9JzogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25hbCAmJiAhYXR0cnNbYXR0ck5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50R2V0ID0gJHBhcnNlKGF0dHJzW2F0dHJOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U2V0ID0gcGFyZW50R2V0LmFzc2lnbiB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlc2V0IHRoZSBjaGFuZ2UsIG9yIHdlIHdpbGwgdGhyb3cgdGhpcyBleGNlcHRpb24gb24gZXZlcnkgJGRpZ2VzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdID0gcGFyZW50R2V0KHBhcmVudFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ25vbmFzc2lnbicsICJFeHByZXNzaW9uICd7MH0nIHVzZWQgd2l0aCBkaXJlY3RpdmUgJ3sxfScgaXMgbm9uLWFzc2lnbmFibGUhIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW2F0dHJOYW1lXSwgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gc2NvcGVbc2NvcGVOYW1lXSA9IHBhcmVudEdldChwYXJlbnRTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIHBhcmVudFZhbHVlV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRWYWx1ZSA9IHBhcmVudEdldChwYXJlbnRTY29wZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VmFsdWUgIT09IHNjb3BlW3Njb3BlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBvdXQgb2Ygc3luYyBhbmQgbmVlZCB0byBjb3B5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VmFsdWUgIT09IGxhc3RWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBhcmVudCBjaGFuZ2VkIGFuZCBpdCBoYXMgcHJlY2VkZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IHNjb3BlW3Njb3BlTmFtZV0gPSBwYXJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHBhcmVudCBjYW4gYmUgYXNzaWduZWQgdGhlbiBkbyBzbwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFNldChwYXJlbnRTY29wZSwgcGFyZW50VmFsdWUgPSBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnJic6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRHZXQgPSAkcGFyc2UoYXR0cnNbYXR0ck5hbWVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gZnVuY3Rpb24gKGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50R2V0KHBhcmVudFNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCdpc2NwJywgIkludmFsaWQgaXNvbGF0ZSBzY29wZSBkZWZpbml0aW9uIGZvciBkaXJlY3RpdmUgJ3swfScuIERlZmluaXRpb246IHsuLi4gezF9OiAnezJ9JyAuLi59IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUsIHNjb3BlTmFtZSwgZGVmaW5pdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udHJvbGxlckRpcmVjdGl2ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGNvbnRyb2xsZXJEaXJlY3RpdmVzLCBmdW5jdGlvbiAoZGlyZWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGU6IHNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQ6ICRlbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF0dHJzOiBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0cmFuc2NsdWRlOiBib3VuZFRyYW5zY2x1ZGVGbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBjb250cm9sbGVySW5zdGFuY2U7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyID0gZGlyZWN0aXZlLmNvbnRyb2xsZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVyID09ICdAJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlciA9IGF0dHJzW2RpcmVjdGl2ZS5uYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlckluc3RhbmNlID0gJGNvbnRyb2xsZXIoY29udHJvbGxlciwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuZGF0YSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICckJyArIGRpcmVjdGl2ZS5uYW1lICsgJ0NvbnRyb2xsZXInLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlckluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZS5jb250cm9sbGVyQXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2Fscy4kc2NvcGVbZGlyZWN0aXZlLmNvbnRyb2xsZXJBc10gPSBjb250cm9sbGVySW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAvLyBQUkVMSU5LSU5HCiAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpaSA9IHByZUxpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbiA9IHByZUxpbmtGbnNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbihzY29wZSwgJGVsZW1lbnQsIGF0dHJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLnJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAvLyBSRUNVUlNJT04KICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuICYmIGNoaWxkTGlua0ZuKHNjb3BlLCBsaW5rTm9kZS5jaGlsZE5vZGVzLCB1bmRlZmluZWQsIGJvdW5kVHJhbnNjbHVkZUZuKTsKCiAgICAgICAgICAgICAgICAgICAgICAvLyBQT1NUTElOS0lORwogICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWkgPSBwb3N0TGlua0Zucy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuID0gcG9zdExpbmtGbnNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbihzY29wZSwgJGVsZW1lbnQsIGF0dHJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLnJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAqIGxvb2tzIHVwIHRoZSBkaXJlY3RpdmUgYW5kIGRlY29yYXRlcyBpdCB3aXRoIGV4Y2VwdGlvbiBoYW5kbGluZyBhbmQgcHJvcGVyIHBhcmFtZXRlcnMuIFdlCiAgICAgICAgICAgICAgICogY2FsbCB0aGlzIHRoZSBib3VuZERpcmVjdGl2ZS4KICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIG5hbWUgb2YgdGhlIGRpcmVjdGl2ZSB0byBsb29rIHVwLgogICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhdGlvbiBUaGUgZGlyZWN0aXZlIG11c3QgYmUgZm91bmQgaW4gc3BlY2lmaWMgZm9ybWF0LgogICAgICAgICAgICAgICAqICAgU3RyaW5nIGNvbnRhaW5pbmcgYW55IG9mIHRoZXNlcyBjaGFyYWN0ZXJzOgogICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICogICAqIGBFYDogZWxlbWVudCBuYW1lCiAgICAgICAgICAgICAgICogICAqIGBBJzogYXR0cmlidXRlCiAgICAgICAgICAgICAgICogICAqIGBDYDogY2xhc3MKICAgICAgICAgICAgICAgKiAgICogYE1gOiBjb21tZW50CiAgICAgICAgICAgICAgICogQHJldHVybnMgdHJ1ZSBpZiBkaXJlY3RpdmUgd2FzIGFkZGVkLgogICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZERpcmVjdGl2ZSh0RGlyZWN0aXZlcywgbmFtZSwgbG9jYXRpb24sIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsIHN0YXJ0QXR0ck5hbWUsIGVuZEF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuYW1lID09PSBpZ25vcmVEaXJlY3RpdmUpIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoaGFzRGlyZWN0aXZlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgZGlyZWN0aXZlLCBkaXJlY3RpdmVzID0gJGluamVjdG9yLmdldChuYW1lICsgU3VmZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICBpID0gMCwgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUgPSBkaXJlY3RpdmVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKG1heFByaW9yaXR5ID09PSB1bmRlZmluZWQgfHwgbWF4UHJpb3JpdHkgPiBkaXJlY3RpdmUucHJpb3JpdHkpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0LmluZGV4T2YobG9jYXRpb24pICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnRBdHRyTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGluaGVyaXQoZGlyZWN0aXZlLCB7ICQkc3RhcnQ6IHN0YXJ0QXR0ck5hbWUsICQkZW5kOiBlbmRBdHRyTmFtZSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHREaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyAkZXhjZXB0aW9uSGFuZGxlcihlKTsgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgKiBXaGVuIHRoZSBlbGVtZW50IGlzIHJlcGxhY2VkIHdpdGggSFRNTCB0ZW1wbGF0ZSB0aGVuIHRoZSBuZXcgYXR0cmlidXRlcwogICAgICAgICAgICAgICAqIG9uIHRoZSB0ZW1wbGF0ZSBuZWVkIHRvIGJlIG1lcmdlZCB3aXRoIHRoZSBleGlzdGluZyBhdHRyaWJ1dGVzIGluIHRoZSBET00uCiAgICAgICAgICAgICAgICogVGhlIGRlc2lyZWQgZWZmZWN0IGlzIHRvIGhhdmUgYm90aCBvZiB0aGUgYXR0cmlidXRlcyBwcmVzZW50LgogICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGRzdCBkZXN0aW5hdGlvbiBhdHRyaWJ1dGVzIChvcmlnaW5hbCBET00pCiAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IHNyYyBzb3VyY2UgYXR0cmlidXRlcyAoZnJvbSB0aGUgZGlyZWN0aXZlIHRlbXBsYXRlKQogICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgIGZ1bmN0aW9uIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKGRzdCwgc3JjKSB7CiAgICAgICAgICAgICAgICAgIHZhciBzcmNBdHRyID0gc3JjLiRhdHRyLAogICAgICAgICAgICAgICAgICAgICAgZHN0QXR0ciA9IGRzdC4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50ID0gZHN0LiQkZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgIC8vIHJlYXBwbHkgdGhlIG9sZCBhdHRyaWJ1dGVzIHRvIHRoZSBuZXcgZWxlbWVudAogICAgICAgICAgICAgICAgICBmb3JFYWNoKGRzdCwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkuY2hhckF0KDApICE9ICckJykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcmNba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSArPSAoa2V5ID09PSAnc3R5bGUnID8gJzsnIDogJyAnKSArIHNyY1trZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBkc3QuJHNldChrZXksIHZhbHVlLCB0cnVlLCBzcmNBdHRyW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgIC8vIGNvcHkgdGhlIG5ldyBhdHRyaWJ1dGVzIG9uIHRoZSBvbGQgYXR0cnMgb2JqZWN0CiAgICAgICAgICAgICAgICAgIGZvckVhY2goc3JjLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnY2xhc3MnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKCRlbGVtZW50LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0WydjbGFzcyddID0gKGRzdFsnY2xhc3MnXSA/IGRzdFsnY2xhc3MnXSArICcgJyA6ICcnKSArIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT0gJ3N0eWxlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LmF0dHIoJ3N0eWxlJywgJGVsZW1lbnQuYXR0cignc3R5bGUnKSArICc7JyArIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5LmNoYXJBdCgwKSAhPSAnJCcgJiYgIWRzdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBkc3RBdHRyW2tleV0gPSBzcmNBdHRyW2tleV07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLCBiZWZvcmVUZW1wbGF0ZU5vZGVMaW5rRm4sICRjb21waWxlTm9kZSwgdEF0dHJzLAogICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnQsIGNoaWxkVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgIHZhciBsaW5rUXVldWUgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVDb21waWxlTm9kZSA9ICRjb21waWxlTm9kZVswXSwKICAgICAgICAgICAgICAgICAgICAgIG9yaWdBc3luY0RpcmVjdGl2ZSA9IGRpcmVjdGl2ZXMuc2hpZnQoKSwKICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSBmYWN0IHRoYXQgd2UgaGF2ZSB0byBjb3B5IGFuZCBwYXRjaCB0aGUgZGlyZWN0aXZlIHNlZW1zIHdyb25nIQogICAgICAgICAgICAgICAgICAgICAgZGVyaXZlZFN5bmNEaXJlY3RpdmUgPSBleHRlbmQoe30sIG9yaWdBc3luY0RpcmVjdGl2ZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IG51bGwsIHRlbXBsYXRlVXJsOiBudWxsLCB0cmFuc2NsdWRlOiBudWxsLCBzY29wZTogbnVsbCwgcmVwbGFjZTogbnVsbAogICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybCA9IChpc0Z1bmN0aW9uKG9yaWdBc3luY0RpcmVjdGl2ZS50ZW1wbGF0ZVVybCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyBvcmlnQXN5bmNEaXJlY3RpdmUudGVtcGxhdGVVcmwoJGNvbXBpbGVOb2RlLCB0QXR0cnMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgOiBvcmlnQXN5bmNEaXJlY3RpdmUudGVtcGxhdGVVcmw7CgogICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbCgnJyk7CgogICAgICAgICAgICAgICAgICAkaHR0cC5nZXQoJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmwodGVtcGxhdGVVcmwpLCB7IGNhY2hlOiAkdGVtcGxhdGVDYWNoZSB9KS4KICAgICAgICAgICAgICAgICAgICBzdWNjZXNzKGZ1bmN0aW9uIChjb250ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21waWxlTm9kZSwgdGVtcFRlbXBsYXRlQXR0cnMsICR0ZW1wbGF0ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBkZW5vcm1hbGl6ZVRlbXBsYXRlKGNvbnRlbnQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9yaWdBc3luY0RpcmVjdGl2ZS5yZXBsYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoJzxkaXY+JyArIHRyaW0oY29udGVudCkgKyAnPC9kaXY+JykuY29udGVudHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJHRlbXBsYXRlWzBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdGVtcGxhdGUubGVuZ3RoICE9IDEgfHwgY29tcGlsZU5vZGUubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndHBscnQnLCAiVGVtcGxhdGUgZm9yIGRpcmVjdGl2ZSAnezB9JyBtdXN0IGhhdmUgZXhhY3RseSBvbmUgcm9vdCBlbGVtZW50LiB7MX0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnQXN5bmNEaXJlY3RpdmUubmFtZSwgdGVtcGxhdGVVcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBUZW1wbGF0ZUF0dHJzID0geyAkYXR0cjoge30gfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKCRyb290RWxlbWVudCwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0RGlyZWN0aXZlcyhjb21waWxlTm9kZSwgZGlyZWN0aXZlcywgdGVtcFRlbXBsYXRlQXR0cnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXModEF0dHJzLCB0ZW1wVGVtcGxhdGVBdHRycyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSA9IGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbChjb250ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy51bnNoaWZ0KGRlcml2ZWRTeW5jRGlyZWN0aXZlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuID0gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIGNvbXBpbGVOb2RlLCB0QXR0cnMsIGNoaWxkVHJhbnNjbHVkZUZuLCAkY29tcGlsZU5vZGUsIG9yaWdBc3luY0RpcmVjdGl2ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goJHJvb3RFbGVtZW50LCBmdW5jdGlvbiAobm9kZSwgaSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUgPT0gY29tcGlsZU5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbaV0gPSAkY29tcGlsZU5vZGVbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4gPSBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlWzBdLmNoaWxkTm9kZXMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKCgogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobGlua1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gbGlua1F1ZXVlLnNoaWZ0KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSA9IGxpbmtRdWV1ZS5zaGlmdCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtSb290RWxlbWVudCA9IGxpbmtRdWV1ZS5zaGlmdCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rTm9kZSA9ICRjb21waWxlTm9kZVswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSAhPT0gYmVmb3JlVGVtcGxhdGVDb21waWxlTm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGl0IHdhcyBjbG9uZWQgdGhlcmVmb3JlIHdlIGhhdmUgdG8gY2xvbmUgYXMgd2VsbC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rTm9kZSA9IEpRTGl0ZUNsb25lKGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlV2l0aChsaW5rUm9vdEVsZW1lbnQsIGpxTGl0ZShiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlKSwgbGlua05vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZU5vZGVMaW5rRm4oYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLCBzY29wZSwgbGlua05vZGUsICRyb290RWxlbWVudCwgY29udHJvbGxlciksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LCBjb250cm9sbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSkuCiAgICAgICAgICAgICAgICAgICAgZXJyb3IoZnVuY3Rpb24gKHJlc3BvbnNlLCBjb2RlLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ3RwbG9hZCcsICdGYWlsZWQgdG8gbG9hZCB0ZW1wbGF0ZTogezB9JywgY29uZmlnLnVybCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gZGVsYXllZE5vZGVMaW5rRm4oaWdub3JlQ2hpbGRMaW5rRm4sIHNjb3BlLCBub2RlLCByb290RWxlbWVudCwgY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGxpbmtRdWV1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChyb290RWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1F1ZXVlLnB1c2goY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVOb2RlTGlua0ZuKGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBzY29wZSwgbm9kZSwgcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAqIFNvcnRpbmcgZnVuY3Rpb24gZm9yIGJvdW5kIGRpcmVjdGl2ZXMuCiAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgZnVuY3Rpb24gYnlQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBiLnByaW9yaXR5IC0gYS5wcmlvcml0eTsKICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICBmdW5jdGlvbiBhc3NlcnROb0R1cGxpY2F0ZSh3aGF0LCBwcmV2aW91c0RpcmVjdGl2ZSwgZGlyZWN0aXZlLCBlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0RpcmVjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ211bHRpZGlyJywgJ011bHRpcGxlIGRpcmVjdGl2ZXMgW3swfSwgezF9XSBhc2tpbmcgZm9yIHsyfSBvbjogezN9JywKICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0RpcmVjdGl2ZS5uYW1lLCBkaXJlY3RpdmUubmFtZSwgd2hhdCwgc3RhcnRpbmdUYWcoZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgZnVuY3Rpb24gYWRkVGV4dEludGVycG9sYXRlRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIHRleHQpIHsKICAgICAgICAgICAgICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUodGV4dCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgIHByaW9yaXR5OiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGU6IHZhbHVlRm4oZnVuY3Rpb24gdGV4dEludGVycG9sYXRlTGlua0ZuKHNjb3BlLCBub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBub2RlLnBhcmVudCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MgPSBwYXJlbnQuZGF0YSgnJGJpbmRpbmcnKSB8fCBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MucHVzaChpbnRlcnBvbGF0ZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKHBhcmVudC5kYXRhKCckYmluZGluZycsIGJpbmRpbmdzKSwgJ25nLWJpbmRpbmcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGludGVycG9sYXRlRm4sIGZ1bmN0aW9uIGludGVycG9sYXRlRm5XYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVswXS5ub2RlVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0VHJ1c3RlZENvbnRleHQobm9kZSwgYXR0ck5vcm1hbGl6ZWROYW1lKSB7CiAgICAgICAgICAgICAgICAgIC8vIG1hY3Rpb25beGxpbms6aHJlZl0gY2FuIHNvdXJjZSBTVkcuICBJdCdzIG5vdCBsaW1pdGVkIHRvIDxtYWN0aW9uPi4KICAgICAgICAgICAgICAgICAgaWYgKGF0dHJOb3JtYWxpemVkTmFtZSA9PSAieGxpbmtIcmVmIiB8fAogICAgICAgICAgICAgICAgICAgICAgKG5vZGVOYW1lXyhub2RlKSAhPSAiSU1HIiAmJiAoYXR0ck5vcm1hbGl6ZWROYW1lID09ICJzcmMiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyTm9ybWFsaXplZE5hbWUgPT0gIm5nU3JjIikpKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHNjZS5SRVNPVVJDRV9VUkw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICBmdW5jdGlvbiBhZGRBdHRySW50ZXJwb2xhdGVEaXJlY3RpdmUobm9kZSwgZGlyZWN0aXZlcywgdmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUodmFsdWUsIHRydWUpOwoKICAgICAgICAgICAgICAgICAgLy8gbm8gaW50ZXJwb2xhdGlvbiBmb3VuZCAtPiBpZ25vcmUKICAgICAgICAgICAgICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSByZXR1cm47CgoKICAgICAgICAgICAgICAgICAgaWYgKG5hbWUgPT09ICJtdWx0aXBsZSIgJiYgbm9kZU5hbWVfKG5vZGUpID09PSAiU0VMRUNUIikgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoInNlbG11bHRpIiwgIkJpbmRpbmcgdG8gdGhlICdtdWx0aXBsZScgYXR0cmlidXRlIGlzIG5vdCBzdXBwb3J0ZWQuIEVsZW1lbnQ6IHswfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRpbmdUYWcobm9kZSkpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGU6IHZhbHVlRm4oZnVuY3Rpb24gYXR0ckludGVycG9sYXRlTGlua0ZuKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyICQkb2JzZXJ2ZXJzID0gKGF0dHIuJCRvYnNlcnZlcnMgfHwgKGF0dHIuJCRvYnNlcnZlcnMgPSB7fSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoRVZFTlRfSEFORExFUl9BVFRSX1JFR0VYUC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCdub2RvbWV2ZW50cycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiSW50ZXJwb2xhdGlvbnMgZm9yIEhUTUwgRE9NIGV2ZW50IGF0dHJpYnV0ZXMgYXJlIGRpc2FsbG93ZWQuICBQbGVhc2UgdXNlIHRoZSBuZy0gIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmVyc2lvbnMgKHN1Y2ggYXMgbmctY2xpY2sgaW5zdGVhZCBvZiBvbmNsaWNrKSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBpbnRlcnBvbGF0ZSBhZ2FpbiwgaW4gY2FzZSB0aGUgYXR0cmlidXRlIHZhbHVlIGhhcyBiZWVuIHVwZGF0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAoZS5nLiBieSBhbm90aGVyIGRpcmVjdGl2ZSdzIGNvbXBpbGUgZnVuY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShhdHRyW25hbWVdLCB0cnVlLCBnZXRUcnVzdGVkQ29udGV4dChub2RlLCBuYW1lKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGF0dHJpYnV0ZSB3YXMgdXBkYXRlZCBzbyB0aGF0IHRoZXJlIGlzIG5vIGludGVycG9sYXRpb24gZ29pbmcgb24gd2UgZG9uJ3Qgd2FudCB0bwogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlZ2lzdGVyIGFueSBvYnNlcnZlcnMKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWludGVycG9sYXRlRm4pIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cltuYW1lXSA9IGludGVycG9sYXRlRm4oc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICgkJG9ic2VydmVyc1tuYW1lXSB8fCAoJCRvYnNlcnZlcnNbbmFtZV0gPSBbXSkpLiQkaW50ZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgIChhdHRyLiQkb2JzZXJ2ZXJzICYmIGF0dHIuJCRvYnNlcnZlcnNbbmFtZV0uJCRzY29wZSB8fCBzY29wZSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVGbldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICogVGhpcyBpcyBhIHNwZWNpYWwganFMaXRlLnJlcGxhY2VXaXRoLCB3aGljaCBjYW4gcmVwbGFjZSBpdGVtcyB3aGljaAogICAgICAgICAgICAgICAqIGhhdmUgbm8gcGFyZW50cywgcHJvdmlkZWQgdGhhdCB0aGUgY29udGFpbmluZyBqcUxpdGUgY29sbGVjdGlvbiBpcyBwcm92aWRlZC4KICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAqIEBwYXJhbSB7SnFMaXRlPX0gJHJvb3RFbGVtZW50IFRoZSByb290IG9mIHRoZSBjb21waWxlIHRyZWUuIFVzZWQgc28gdGhhdCB3ZSBjYW4gcmVwbGFjZSBub2RlcwogICAgICAgICAgICAgICAqICAgIGluIHRoZSByb290IG9mIHRoZSB0cmVlLgogICAgICAgICAgICAgICAqIEBwYXJhbSB7SnFMaXRlfSBlbGVtZW50c1RvUmVtb3ZlIFRoZSBqcUxpdGUgZWxlbWVudCB3aGljaCB3ZSBhcmUgZ29pbmcgdG8gcmVwbGFjZS4gV2Uga2VlcCB0aGUgc2hlbGwsCiAgICAgICAgICAgICAgICogICAgYnV0IHJlcGxhY2UgaXRzIERPTSBub2RlIHJlZmVyZW5jZS4KICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGV9IG5ld05vZGUgVGhlIG5ldyBET00gbm9kZS4KICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICBmdW5jdGlvbiByZXBsYWNlV2l0aCgkcm9vdEVsZW1lbnQsIGVsZW1lbnRzVG9SZW1vdmUsIG5ld05vZGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0RWxlbWVudFRvUmVtb3ZlID0gZWxlbWVudHNUb1JlbW92ZVswXSwKICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUNvdW50ID0gZWxlbWVudHNUb1JlbW92ZS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBmaXJzdEVsZW1lbnRUb1JlbW92ZS5wYXJlbnROb2RlLAogICAgICAgICAgICAgICAgICAgICAgaSwgaWk7CgogICAgICAgICAgICAgICAgICBpZiAoJHJvb3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpaSA9ICRyb290RWxlbWVudC5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290RWxlbWVudFtpXSA9PSBmaXJzdEVsZW1lbnRUb1JlbW92ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbaSsrXSA9IG5ld05vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSBpLCBqMiA9IGogKyByZW1vdmVDb3VudCAtIDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpqID0gJHJvb3RFbGVtZW50Lmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqIDwgamo7IGorKywgajIrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGoyIDwgamopIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbal0gPSAkcm9vdEVsZW1lbnRbajJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgJHJvb3RFbGVtZW50W2pdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290RWxlbWVudC5sZW5ndGggLT0gcmVtb3ZlQ291bnQgLSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgZmlyc3RFbGVtZW50VG9SZW1vdmUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZmlyc3RFbGVtZW50VG9SZW1vdmUpOwogICAgICAgICAgICAgICAgICBuZXdOb2RlW2pxTGl0ZS5leHBhbmRvXSA9IGZpcnN0RWxlbWVudFRvUmVtb3ZlW2pxTGl0ZS5leHBhbmRvXTsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDEsIGtrID0gZWxlbWVudHNUb1JlbW92ZS5sZW5ndGg7IGsgPCBrazsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGVsZW1lbnRzVG9SZW1vdmVba107CiAgICAgICAgICAgICAgICAgICAgICBqcUxpdGUoZWxlbWVudCkucmVtb3ZlKCk7IC8vIG11c3QgZG8gdGhpcyB3YXkgdG8gY2xlYW4gdXAgZXhwYW5kbwogICAgICAgICAgICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZWxlbWVudHNUb1JlbW92ZVtrXTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgZWxlbWVudHNUb1JlbW92ZVswXSA9IG5ld05vZGU7CiAgICAgICAgICAgICAgICAgIGVsZW1lbnRzVG9SZW1vdmUubGVuZ3RoID0gMQogICAgICAgICAgICAgIH0KICAgICAgICAgIH1dOwogICAgfQoKICAgIHZhciBQUkVGSVhfUkVHRVhQID0gL14oeFtcOlwtX118ZGF0YVtcOlwtX10pL2k7CiAgICAvKioKICAgICAqIENvbnZlcnRzIGFsbCBhY2NlcHRlZCBkaXJlY3RpdmVzIGZvcm1hdCBpbnRvIHByb3BlciBkaXJlY3RpdmUgbmFtZS4KICAgICAqIEFsbCBvZiB0aGVzZSB3aWxsIGJlY29tZSAnbXlEaXJlY3RpdmUnOgogICAgICogICBteTpEaXJlY3RpdmUKICAgICAqICAgbXktZGlyZWN0aXZlCiAgICAgKiAgIHgtbXktZGlyZWN0aXZlCiAgICAgKiAgIGRhdGEtbXk6ZGlyZWN0aXZlCiAgICAgKgogICAgICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICAgICAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIGNhbWVsQ2FzZShuYW1lLnJlcGxhY2UoUFJFRklYX1JFR0VYUCwgJycpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIHNoYXJlZCBvYmplY3QgYmV0d2VlbiBkaXJlY3RpdmUgY29tcGlsZSAvIGxpbmtpbmcgZnVuY3Rpb25zIHdoaWNoIGNvbnRhaW5zIG5vcm1hbGl6ZWQgRE9NIGVsZW1lbnQKICAgICAqIGF0dHJpYnV0ZXMuIFRoZSB0aGUgdmFsdWVzIHJlZmxlY3QgY3VycmVudCBiaW5kaW5nIHN0YXRlIGB7eyB9fWAuIFRoZSBub3JtYWxpemF0aW9uIGlzIG5lZWRlZAogICAgICogc2luY2UgYWxsIG9mIHRoZXNlIGFyZSB0cmVhdGVkIGFzIGVxdWl2YWxlbnQgaW4gQW5ndWxhcjoKICAgICAqCiAgICAgKiAgICAgICAgICA8c3BhbiBuZzpiaW5kPSJhIiBuZy1iaW5kPSJhIiBkYXRhLW5nLWJpbmQ9ImEiIHgtbmctYmluZD0iYSI+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIKICAgICAqIEBwcm9wZXJ0eU9mIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIG1hcCBvZiBET00gZWxlbWVudCBhdHRyaWJ1dGUgbmFtZXMgdG8gdGhlIG5vcm1hbGl6ZWQgbmFtZS4gVGhpcyBpcwogICAgICogICAgICAgICAgbmVlZGVkIHRvIGRvIHJldmVyc2UgbG9va3VwIGZyb20gbm9ybWFsaXplZCBuYW1lIGJhY2sgdG8gYWN0dWFsIG5hbWUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRzZXQKICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXQgRE9NIGVsZW1lbnQgYXR0cmlidXRlIHZhbHVlLgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOb3JtYWxpemVkIGVsZW1lbnQgYXR0cmlidXRlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIG1vZGlmeS4gVGhlIG5hbWUgaXMKICAgICAqICAgICAgICAgIHJldmVycyB0cmFuc2xhdGVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIgJGF0dHJ9CiAgICAgKiAgICAgICAgICBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgbmFtZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSB0byBzZXQgdGhlIGF0dHJpYnV0ZSB0by4gVGhlIHZhbHVlIGNhbiBiZSBhbiBpbnRlcnBvbGF0ZWQgc3RyaW5nLgogICAgICovCgoKCiAgICAvKioKICAgICAqIENsb3N1cmUgY29tcGlsZXIgdHlwZSBpbmZvcm1hdGlvbgogICAgICovCgogICAgZnVuY3Rpb24gbm9kZXNldExpbmtpbmdGbigKICAgICAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAgICAgLyogTm9kZUxpc3QgKi8gbm9kZUxpc3QsCiAgICAgIC8qIEVsZW1lbnQgKi8gcm9vdEVsZW1lbnQsCiAgICAgIC8qIGZ1bmN0aW9uKEZ1bmN0aW9uKSAqLyBib3VuZFRyYW5zY2x1ZGVGbgogICAgKSB7IH0KCiAgICBmdW5jdGlvbiBkaXJlY3RpdmVMaW5raW5nRm4oCiAgICAgIC8qIG5vZGVzZXRMaW5raW5nRm4gKi8gbm9kZXNldExpbmtpbmdGbiwKICAgICAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAgICAgLyogTm9kZSAqLyBub2RlLAogICAgICAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LAogICAgICAvKiBmdW5jdGlvbihGdW5jdGlvbikgKi8gYm91bmRUcmFuc2NsdWRlRm4KICAgICkgeyB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kY29udHJvbGxlclByb3ZpZGVyCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSB7QGxpbmsgbmcuJGNvbnRyb2xsZXIgJGNvbnRyb2xsZXIgc2VydmljZX0gaXMgdXNlZCBieSBBbmd1bGFyIHRvIGNyZWF0ZSBuZXcKICAgICAqIGNvbnRyb2xsZXJzLgogICAgICoKICAgICAqIFRoaXMgcHJvdmlkZXIgYWxsb3dzIGNvbnRyb2xsZXIgcmVnaXN0cmF0aW9uIHZpYSB0aGUKICAgICAqIHtAbGluayBuZy4kY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyIHJlZ2lzdGVyfSBtZXRob2QuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRDb250cm9sbGVyUHJvdmlkZXIoKSB7CiAgICAgICAgdmFyIGNvbnRyb2xsZXJzID0ge30sCiAgICAgICAgICAgIENOVFJMX1JFRyA9IC9eKFxTKykoXHMrYXNccysoXHcrKSk/JC87CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjb250cm9sbGVyUHJvdmlkZXIKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBDb250cm9sbGVyIG5hbWUKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufEFycmF5fSBjb25zdHJ1Y3RvciBDb250cm9sbGVyIGNvbnN0cnVjdG9yIGZuIChvcHRpb25hbGx5IGRlY29yYXRlZCB3aXRoIERJCiAgICAgICAgICogICAgYW5ub3RhdGlvbnMgaW4gdGhlIGFycmF5IG5vdGF0aW9uKS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnJlZ2lzdGVyID0gZnVuY3Rpb24gKG5hbWUsIGNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgIGlmIChpc09iamVjdChuYW1lKSkgewogICAgICAgICAgICAgICAgZXh0ZW5kKGNvbnRyb2xsZXJzLCBuYW1lKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udHJvbGxlcnNbbmFtZV0gPSBjb25zdHJ1Y3RvcjsKICAgICAgICAgICAgfQogICAgICAgIH07CgoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsICckd2luZG93JywgZnVuY3Rpb24gKCRpbmplY3RvciwgJHdpbmRvdykgewoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSBuZy4kY29udHJvbGxlcgogICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb258c3RyaW5nfSBjb25zdHJ1Y3RvciBJZiBjYWxsZWQgd2l0aCBhIGZ1bmN0aW9uIHRoZW4gaXQncyBjb25zaWRlcmVkIHRvIGJlIHRoZQogICAgICAgICAgICAgKiAgICBjb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBPdGhlcndpc2UgaXQncyBjb25zaWRlcmVkIHRvIGJlIGEgc3RyaW5nIHdoaWNoIGlzIHVzZWQKICAgICAgICAgICAgICogICAgdG8gcmV0cmlldmUgdGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgdXNpbmcgdGhlIGZvbGxvd2luZyBzdGVwczoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgKiBjaGVjayBpZiBhIGNvbnRyb2xsZXIgd2l0aCBnaXZlbiBuYW1lIGlzIHJlZ2lzdGVyZWQgdmlhIGAkY29udHJvbGxlclByb3ZpZGVyYAogICAgICAgICAgICAgKiAgICAqIGNoZWNrIGlmIGV2YWx1YXRpbmcgdGhlIHN0cmluZyBvbiB0aGUgY3VycmVudCBzY29wZSByZXR1cm5zIGEgY29uc3RydWN0b3IKICAgICAgICAgICAgICogICAgKiBjaGVjayBgd2luZG93W2NvbnN0cnVjdG9yXWAgb24gdGhlIGdsb2JhbCBgd2luZG93YCBvYmplY3QKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGxvY2FscyBJbmplY3Rpb24gbG9jYWxzIGZvciBDb250cm9sbGVyLgogICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEluc3RhbmNlIG9mIGdpdmVuIGNvbnRyb2xsZXIuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBgJGNvbnRyb2xsZXJgIHNlcnZpY2UgaXMgcmVzcG9uc2libGUgZm9yIGluc3RhbnRpYXRpbmcgY29udHJvbGxlcnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEl0J3MganVzdCBhIHNpbXBsZSBjYWxsIHRvIHtAbGluayBBVVRPLiRpbmplY3RvciAkaW5qZWN0b3J9LCBidXQgZXh0cmFjdGVkIGludG8KICAgICAgICAgICAgICogYSBzZXJ2aWNlLCBzbyB0aGF0IG9uZSBjYW4gb3ZlcnJpZGUgdGhpcyBzZXJ2aWNlIHdpdGgge0BsaW5rIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzE2NDk3ODgKICAgICAgICAgICAgICogQkMgdmVyc2lvbn0uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGV4cHJlc3Npb24sIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlLCBtYXRjaCwgY29uc3RydWN0b3IsIGlkZW50aWZpZXI7CgogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGV4cHJlc3Npb24pKSB7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBleHByZXNzaW9uLm1hdGNoKENOVFJMX1JFRyksCiAgICAgICAgICAgICAgICAgICAgY29uc3RydWN0b3IgPSBtYXRjaFsxXSwKICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gbWF0Y2hbM107CiAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IGNvbnRyb2xsZXJzLmhhc093blByb3BlcnR5KGNvbnN0cnVjdG9yKQogICAgICAgICAgICAgICAgICAgICAgICA/IGNvbnRyb2xsZXJzW2NvbnN0cnVjdG9yXQogICAgICAgICAgICAgICAgICAgICAgICA6IGdldHRlcihsb2NhbHMuJHNjb3BlLCBjb25zdHJ1Y3RvciwgdHJ1ZSkgfHwgZ2V0dGVyKCR3aW5kb3csIGNvbnN0cnVjdG9yLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZXhwcmVzc2lvbiwgY29uc3RydWN0b3IsIHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gJGluamVjdG9yLmluc3RhbnRpYXRlKGV4cHJlc3Npb24sIGxvY2Fscyk7CgogICAgICAgICAgICAgICAgaWYgKGlkZW50aWZpZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIShsb2NhbHMgJiYgdHlwZW9mIGxvY2Fscy4kc2NvcGUgPT0gJ29iamVjdCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG1pbkVycignJGNvbnRyb2xsZXInKSgnbm9zY3AnLCAiQ2Fubm90IGV4cG9ydCBjb250cm9sbGVyICd7MH0nIGFzICd7MX0nISBObyAkc2NvcGUgb2JqZWN0IHByb3ZpZGVkIHZpYSBgbG9jYWxzYC4iLCBjb25zdHJ1Y3RvciB8fCBleHByZXNzaW9uLm5hbWUsIGlkZW50aWZpZXIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbG9jYWxzLiRzY29wZVtpZGVudGlmaWVyXSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRkb2N1bWVudAogICAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEge0BsaW5rIGFuZ3VsYXIuZWxlbWVudCBqUXVlcnkgKGxpdGUpfS13cmFwcGVkIHJlZmVyZW5jZSB0byB0aGUgYnJvd3NlcidzIGB3aW5kb3cuZG9jdW1lbnRgCiAgICAgKiBlbGVtZW50LgogICAgICovCiAgICBmdW5jdGlvbiAkRG9jdW1lbnRQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCBmdW5jdGlvbiAod2luZG93KSB7CiAgICAgICAgICAgIHJldHVybiBqcUxpdGUod2luZG93LmRvY3VtZW50KTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJGV4Y2VwdGlvbkhhbmRsZXIKICAgICAqIEByZXF1aXJlcyAkbG9nCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBbnkgdW5jYXVnaHQgZXhjZXB0aW9uIGluIGFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGVsZWdhdGVkIHRvIHRoaXMgc2VydmljZS4KICAgICAqIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIHNpbXBseSBkZWxlZ2F0ZXMgdG8gYCRsb2cuZXJyb3JgIHdoaWNoIGxvZ3MgaXQgaW50bwogICAgICogdGhlIGJyb3dzZXIgY29uc29sZS4KICAgICAqCiAgICAgKiBJbiB1bml0IHRlc3RzLCBpZiBgYW5ndWxhci1tb2Nrcy5qc2AgaXMgbG9hZGVkLCB0aGlzIHNlcnZpY2UgaXMgb3ZlcnJpZGRlbiBieQogICAgICoge0BsaW5rIG5nTW9jay4kZXhjZXB0aW9uSGFuZGxlciBtb2NrICRleGNlcHRpb25IYW5kbGVyfSB3aGljaCBhaWRzIGluIHRlc3RpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtFcnJvcn0gZXhjZXB0aW9uIEV4Y2VwdGlvbiBhc3NvY2lhdGVkIHdpdGggdGhlIGVycm9yLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBjYXVzZSBvcHRpb25hbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY29udGV4dCBpbiB3aGljaAogICAgICogICAgICAgdGhlIGVycm9yIHdhcyB0aHJvd24uCiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiAkRXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJGxvZycsIGZ1bmN0aW9uICgkbG9nKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXhjZXB0aW9uLCBjYXVzZSkgewogICAgICAgICAgICAgICAgJGxvZy5lcnJvci5hcHBseSgkbG9nLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9OwogICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogUGFyc2UgaGVhZGVycyBpbnRvIGtleSB2YWx1ZSBvYmplY3QKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGVhZGVycyBSYXcgaGVhZGVycyBhcyBhIHN0cmluZwogICAgICogQHJldHVybnMge09iamVjdH0gUGFyc2VkIGhlYWRlcnMgYXMga2V5IHZhbHVlIG9iamVjdAogICAgICovCiAgICBmdW5jdGlvbiBwYXJzZUhlYWRlcnMoaGVhZGVycykgewogICAgICAgIHZhciBwYXJzZWQgPSB7fSwga2V5LCB2YWwsIGk7CgogICAgICAgIGlmICghaGVhZGVycykgcmV0dXJuIHBhcnNlZDsKCiAgICAgICAgZm9yRWFjaChoZWFkZXJzLnNwbGl0KCdcbicpLCBmdW5jdGlvbiAobGluZSkgewogICAgICAgICAgICBpID0gbGluZS5pbmRleE9mKCc6Jyk7CiAgICAgICAgICAgIGtleSA9IGxvd2VyY2FzZSh0cmltKGxpbmUuc3Vic3RyKDAsIGkpKSk7CiAgICAgICAgICAgIHZhbCA9IHRyaW0obGluZS5zdWJzdHIoaSArIDEpKTsKCiAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGlmIChwYXJzZWRba2V5XSkgewogICAgICAgICAgICAgICAgICAgIHBhcnNlZFtrZXldICs9ICcsICcgKyB2YWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcnNlZFtrZXldID0gdmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBwYXJzZWQ7CiAgICB9CgoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgcHJvdmlkZXMgYWNjZXNzIHRvIHBhcnNlZCBoZWFkZXJzLgogICAgICoKICAgICAqIEhlYWRlcnMgYXJlIGxhenkgcGFyc2VkIHdoZW4gZmlyc3QgcmVxdWVzdGVkLgogICAgICogQHNlZSBwYXJzZUhlYWRlcnMKICAgICAqCiAgICAgKiBAcGFyYW0geyhzdHJpbmd8T2JqZWN0KX0gaGVhZGVycyBIZWFkZXJzIHRvIHByb3ZpZGUgYWNjZXNzIHRvLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKHN0cmluZz0pfSBSZXR1cm5zIGEgZ2V0dGVyIGZ1bmN0aW9uIHdoaWNoIGlmIGNhbGxlZCB3aXRoOgogICAgICoKICAgICAqICAgLSBpZiBjYWxsZWQgd2l0aCBzaW5nbGUgYW4gYXJndW1lbnQgcmV0dXJucyBhIHNpbmdsZSBoZWFkZXIgdmFsdWUgb3IgbnVsbAogICAgICogICAtIGlmIGNhbGxlZCB3aXRoIG5vIGFyZ3VtZW50cyByZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCBoZWFkZXJzLgogICAgICovCiAgICBmdW5jdGlvbiBoZWFkZXJzR2V0dGVyKGhlYWRlcnMpIHsKICAgICAgICB2YXIgaGVhZGVyc09iaiA9IGlzT2JqZWN0KGhlYWRlcnMpID8gaGVhZGVycyA6IHVuZGVmaW5lZDsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIGlmICghaGVhZGVyc09iaikgaGVhZGVyc09iaiA9IHBhcnNlSGVhZGVycyhoZWFkZXJzKTsKCiAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaGVhZGVyc09ialtsb3dlcmNhc2UobmFtZSldIHx8IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBoZWFkZXJzT2JqOwogICAgICAgIH07CiAgICB9CgoKICAgIC8qKgogICAgICogQ2hhaW4gYWxsIGdpdmVuIGZ1bmN0aW9ucwogICAgICoKICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgYm90aCByZXF1ZXN0IGFuZCByZXNwb25zZSB0cmFuc2Zvcm1pbmcKICAgICAqCiAgICAgKiBAcGFyYW0geyp9IGRhdGEgRGF0YSB0byB0cmFuc2Zvcm0uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZz0pfSBoZWFkZXJzIEh0dHAgaGVhZGVycyBnZXR0ZXIgZm4uCiAgICAgKiBAcGFyYW0geyhmdW5jdGlvbnxBcnJheS48ZnVuY3Rpb24+KX0gZm5zIEZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIGZ1bmN0aW9ucy4KICAgICAqIEByZXR1cm5zIHsqfSBUcmFuc2Zvcm1lZCBkYXRhLgogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc2Zvcm1EYXRhKGRhdGEsIGhlYWRlcnMsIGZucykgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKGZucykpCiAgICAgICAgICAgIHJldHVybiBmbnMoZGF0YSwgaGVhZGVycyk7CgogICAgICAgIGZvckVhY2goZm5zLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgZGF0YSA9IGZuKGRhdGEsIGhlYWRlcnMpOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gZGF0YTsKICAgIH0KCgogICAgZnVuY3Rpb24gaXNTdWNjZXNzKHN0YXR1cykgewogICAgICAgIHJldHVybiAyMDAgPD0gc3RhdHVzICYmIHN0YXR1cyA8IDMwMDsKICAgIH0KCgogICAgZnVuY3Rpb24gJEh0dHBQcm92aWRlcigpIHsKICAgICAgICB2YXIgSlNPTl9TVEFSVCA9IC9eXHMqKFxbfFx7W15ce10pLywKICAgICAgICAgICAgSlNPTl9FTkQgPSAvW1x9XF1dXHMqJC8sCiAgICAgICAgICAgIFBST1RFQ1RJT05fUFJFRklYID0gL15cKVxdXH0nLD9cbi8sCiAgICAgICAgICAgIENPTlRFTlRfVFlQRV9BUFBMSUNBVElPTl9KU09OID0geyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOCcgfTsKCiAgICAgICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgICAgICAgLy8gdHJhbnNmb3JtIGluY29taW5nIHJlc3BvbnNlIGRhdGEKICAgICAgICAgICAgdHJhbnNmb3JtUmVzcG9uc2U6IFtmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gc3RyaXAganNvbiB2dWxuZXJhYmlsaXR5IHByb3RlY3Rpb24gcHJlZml4CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEucmVwbGFjZShQUk9URUNUSU9OX1BSRUZJWCwgJycpOwogICAgICAgICAgICAgICAgICAgIGlmIChKU09OX1NUQVJULnRlc3QoZGF0YSkgJiYgSlNPTl9FTkQudGVzdChkYXRhKSkKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGZyb21Kc29uKGRhdGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH1dLAoKICAgICAgICAgICAgLy8gdHJhbnNmb3JtIG91dGdvaW5nIHJlcXVlc3QgZGF0YQogICAgICAgICAgICB0cmFuc2Zvcm1SZXF1ZXN0OiBbZnVuY3Rpb24gKGQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc09iamVjdChkKSAmJiAhaXNGaWxlKGQpID8gdG9Kc29uKGQpIDogZDsKICAgICAgICAgICAgfV0sCgogICAgICAgICAgICAvLyBkZWZhdWx0IGhlYWRlcnMKICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAgY29tbW9uOiB7CiAgICAgICAgICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L3BsYWluLCAqLyonCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcG9zdDogQ09OVEVOVF9UWVBFX0FQUExJQ0FUSU9OX0pTT04sCiAgICAgICAgICAgICAgICBwdXQ6IENPTlRFTlRfVFlQRV9BUFBMSUNBVElPTl9KU09OLAogICAgICAgICAgICAgICAgcGF0Y2g6IENPTlRFTlRfVFlQRV9BUFBMSUNBVElPTl9KU09OCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB4c3JmQ29va2llTmFtZTogJ1hTUkYtVE9LRU4nLAogICAgICAgICAgICB4c3JmSGVhZGVyTmFtZTogJ1gtWFNSRi1UT0tFTicKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBBcmUgb3JkZXIgYnkgcmVxdWVzdC4gSS5FLiB0aGV5IGFyZSBhcHBsaWVkIGluIHRoZSBzYW1lIG9yZGVyIGFzCiAgICAgICAgICogYXJyYXkgb24gcmVxdWVzdCwgYnV0IHJldmVycyBvcmRlciBvbiByZXNwb25zZS4KICAgICAgICAgKi8KICAgICAgICB2YXIgaW50ZXJjZXB0b3JGYWN0b3JpZXMgPSB0aGlzLmludGVyY2VwdG9ycyA9IFtdOwogICAgICAgIC8qKgogICAgICAgICAqIEZvciBoaXN0b3JpY2FsIHJlYXNvbnMsIHJlc3BvbnNlIGludGVyY2VwdG9ycyBvcmRlcmVkIGJ5IHRoZSBvcmRlciBpbiB3aGljaAogICAgICAgICAqIHRoZXkgYXJlIGFwcGxpZWQgdG8gcmVzcG9uc2UuIChUaGlzIGlzIGluIHJldmVycyB0byBpbnRlcmNlcHRvckZhY3RvcmllcykKICAgICAgICAgKi8KICAgICAgICB2YXIgcmVzcG9uc2VJbnRlcmNlcHRvckZhY3RvcmllcyA9IHRoaXMucmVzcG9uc2VJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckaHR0cEJhY2tlbmQnLCAnJGJyb3dzZXInLCAnJGNhY2hlRmFjdG9yeScsICckcm9vdFNjb3BlJywgJyRxJywgJyRpbmplY3RvcicsICckJHVybFV0aWxzJywKICAgICAgICAgICAgZnVuY3Rpb24gKCRodHRwQmFja2VuZCwgJGJyb3dzZXIsICRjYWNoZUZhY3RvcnksICRyb290U2NvcGUsICRxLCAkaW5qZWN0b3IsICQkdXJsVXRpbHMpIHsKCiAgICAgICAgICAgICAgICB2YXIgZGVmYXVsdENhY2hlID0gJGNhY2hlRmFjdG9yeSgnJGh0dHAnKTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEludGVyY2VwdG9ycyBzdG9yZWQgaW4gcmV2ZXJzZSBvcmRlci4gSW5uZXIgaW50ZXJjZXB0b3JzIGJlZm9yZSBvdXRlciBpbnRlcmNlcHRvcnMuCiAgICAgICAgICAgICAgICAgKiBUaGUgcmV2ZXJzYWwgaXMgbmVlZGVkIHNvIHRoYXQgd2UgY2FuIGJ1aWxkIHVwIHRoZSBpbnRlcmNlcHRpb24gY2hhaW4gYXJvdW5kIHRoZQogICAgICAgICAgICAgICAgICogc2VydmVyIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHZhciByZXZlcnNlZEludGVyY2VwdG9ycyA9IFtdOwoKICAgICAgICAgICAgICAgIGZvckVhY2goaW50ZXJjZXB0b3JGYWN0b3JpZXMsIGZ1bmN0aW9uIChpbnRlcmNlcHRvckZhY3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXZlcnNlZEludGVyY2VwdG9ycy51bnNoaWZ0KGlzU3RyaW5nKGludGVyY2VwdG9yRmFjdG9yeSkKICAgICAgICAgICAgICAgICAgICAgICAgPyAkaW5qZWN0b3IuZ2V0KGludGVyY2VwdG9yRmFjdG9yeSkgOiAkaW5qZWN0b3IuaW52b2tlKGludGVyY2VwdG9yRmFjdG9yeSkpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgZm9yRWFjaChyZXNwb25zZUludGVyY2VwdG9yRmFjdG9yaWVzLCBmdW5jdGlvbiAoaW50ZXJjZXB0b3JGYWN0b3J5LCBpbmRleCkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXNwb25zZUZuID0gaXNTdHJpbmcoaW50ZXJjZXB0b3JGYWN0b3J5KQogICAgICAgICAgICAgICAgICAgICAgICA/ICRpbmplY3Rvci5nZXQoaW50ZXJjZXB0b3JGYWN0b3J5KQogICAgICAgICAgICAgICAgICAgICAgICA6ICRpbmplY3Rvci5pbnZva2UoaW50ZXJjZXB0b3JGYWN0b3J5KTsKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogUmVzcG9uc2UgaW50ZXJjZXB0b3JzIGdvIGJlZm9yZSAiYXJvdW5kIiBpbnRlcmNlcHRvcnMgKG5vIHJlYWwgcmVhc29uLCBqdXN0CiAgICAgICAgICAgICAgICAgICAgICogaGFkIHRvIHBpY2sgb25lLikgQnV0IHRoZXkgYXJlIGFscmVhZHkgcmV2ZXJzZWQsIHNvIHdlIGNhbid0IHVzZSB1bnNoaWZ0LCBoZW5jZQogICAgICAgICAgICAgICAgICAgICAqIHRoZSBzcGxpY2UuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgcmV2ZXJzZWRJbnRlcmNlcHRvcnMuc3BsaWNlKGluZGV4LCAwLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZUZuKCRxLndoZW4ocmVzcG9uc2UpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VFcnJvcjogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VGbigkcS5yZWplY3QocmVzcG9uc2UpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cAogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRodHRwQmFja2VuZAogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRicm93c2VyCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGNhY2hlRmFjdG9yeQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkcQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogVGhlIGAkaHR0cGAgc2VydmljZSBpcyBhIGNvcmUgQW5ndWxhciBzZXJ2aWNlIHRoYXQgZmFjaWxpdGF0ZXMgY29tbXVuaWNhdGlvbiB3aXRoIHRoZSByZW1vdGUKICAgICAgICAgICAgICAgICAqIEhUVFAgc2VydmVycyB2aWEgdGhlIGJyb3dzZXIncyB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4veG1saHR0cHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIFhNTEh0dHBSZXF1ZXN0fSBvYmplY3Qgb3IgdmlhIHtAbGluayBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0pTT05QIEpTT05QfS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBGb3IgdW5pdCB0ZXN0aW5nIGFwcGxpY2F0aW9ucyB0aGF0IHVzZSBgJGh0dHBgIHNlcnZpY2UsIHNlZQogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nTW9jay4kaHR0cEJhY2tlbmQgJGh0dHBCYWNrZW5kIG1vY2t9LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciBhIGhpZ2hlciBsZXZlbCBvZiBhYnN0cmFjdGlvbiwgcGxlYXNlIGNoZWNrIG91dCB0aGUge0BsaW5rIG5nUmVzb3VyY2UuJHJlc291cmNlCiAgICAgICAgICAgICAgICAgKiAkcmVzb3VyY2V9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlICRodHRwIEFQSSBpcyBiYXNlZCBvbiB0aGUge0BsaW5rIG5nLiRxIGRlZmVycmVkL3Byb21pc2UgQVBJc30gZXhwb3NlZCBieQogICAgICAgICAgICAgICAgICogdGhlICRxIHNlcnZpY2UuIFdoaWxlIGZvciBzaW1wbGUgdXNhZ2UgcGF0dGVybnMgdGhpcyBkb2Vzbid0IG1hdHRlciBtdWNoLCBmb3IgYWR2YW5jZWQgdXNhZ2UKICAgICAgICAgICAgICAgICAqIGl0IGlzIGltcG9ydGFudCB0byBmYW1pbGlhcml6ZSB5b3Vyc2VsZiB3aXRoIHRoZXNlIEFQSXMgYW5kIHRoZSBndWFyYW50ZWVzIHRoZXkgcHJvdmlkZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBHZW5lcmFsIHVzYWdlCiAgICAgICAgICAgICAgICAgKiBUaGUgYCRodHRwYCBzZXJ2aWNlIGlzIGEgZnVuY3Rpb24gd2hpY2ggdGFrZXMgYSBzaW5nbGUgYXJndW1lbnQg4oCUIGEgY29uZmlndXJhdGlvbiBvYmplY3Qg4oCUCiAgICAgICAgICAgICAgICAgKiB0aGF0IGlzIHVzZWQgdG8gZ2VuZXJhdGUgYW4gSFRUUCByZXF1ZXN0IGFuZCByZXR1cm5zICBhIHtAbGluayBuZy4kcSBwcm9taXNlfQogICAgICAgICAgICAgICAgICogd2l0aCB0d28gJGh0dHAgc3BlY2lmaWMgbWV0aG9kczogYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiAgICRodHRwKHttZXRob2Q6ICdHRVQnLCB1cmw6ICcvc29tZVVybCd9KS4KICAgICAgICAgICAgICAgICAqICAgICBzdWNjZXNzKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAvLyB0aGlzIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGFzeW5jaHJvbm91c2x5CiAgICAgICAgICAgICAgICAgKiAgICAgICAvLyB3aGVuIHRoZSByZXNwb25zZSBpcyBhdmFpbGFibGUKICAgICAgICAgICAgICAgICAqICAgICB9KS4KICAgICAgICAgICAgICAgICAqICAgICBlcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICAgICAgICAgICAgICogICAgICAgLy8gY2FsbGVkIGFzeW5jaHJvbm91c2x5IGlmIGFuIGVycm9yIG9jY3VycwogICAgICAgICAgICAgICAgICogICAgICAgLy8gb3Igc2VydmVyIHJldHVybnMgcmVzcG9uc2Ugd2l0aCBhbiBlcnJvciBzdGF0dXMuCiAgICAgICAgICAgICAgICAgKiAgICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTaW5jZSB0aGUgcmV0dXJuZWQgdmFsdWUgb2YgY2FsbGluZyB0aGUgJGh0dHAgZnVuY3Rpb24gaXMgYSBgcHJvbWlzZWAsIHlvdSBjYW4gYWxzbyB1c2UKICAgICAgICAgICAgICAgICAqIHRoZSBgdGhlbmAgbWV0aG9kIHRvIHJlZ2lzdGVyIGNhbGxiYWNrcywgYW5kIHRoZXNlIGNhbGxiYWNrcyB3aWxsIHJlY2VpdmUgYSBzaW5nbGUgYXJndW1lbnQg4oCTCiAgICAgICAgICAgICAgICAgKiBhbiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZXNwb25zZS4gU2VlIHRoZSBBUEkgc2lnbmF0dXJlIGFuZCB0eXBlIGluZm8gYmVsb3cgZm9yIG1vcmUKICAgICAgICAgICAgICAgICAqIGRldGFpbHMuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQSByZXNwb25zZSBzdGF0dXMgY29kZSBiZXR3ZWVuIDIwMCBhbmQgMjk5IGlzIGNvbnNpZGVyZWQgYSBzdWNjZXNzIHN0YXR1cyBhbmQKICAgICAgICAgICAgICAgICAqIHdpbGwgcmVzdWx0IGluIHRoZSBzdWNjZXNzIGNhbGxiYWNrIGJlaW5nIGNhbGxlZC4gTm90ZSB0aGF0IGlmIHRoZSByZXNwb25zZSBpcyBhIHJlZGlyZWN0LAogICAgICAgICAgICAgICAgICogWE1MSHR0cFJlcXVlc3Qgd2lsbCB0cmFuc3BhcmVudGx5IGZvbGxvdyBpdCwgbWVhbmluZyB0aGF0IHRoZSBlcnJvciBjYWxsYmFjayB3aWxsIG5vdCBiZQogICAgICAgICAgICAgICAgICogY2FsbGVkIGZvciBzdWNoIHJlc3BvbnNlcy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFNob3J0Y3V0IG1ldGhvZHMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTaW5jZSBhbGwgaW52b2NhdGlvbnMgb2YgdGhlICRodHRwIHNlcnZpY2UgcmVxdWlyZSBwYXNzaW5nIGluIGFuIEhUVFAgbWV0aG9kIGFuZCBVUkwsIGFuZAogICAgICAgICAgICAgICAgICogUE9TVC9QVVQgcmVxdWVzdHMgcmVxdWlyZSByZXF1ZXN0IGRhdGEgdG8gYmUgcHJvdmlkZWQgYXMgd2VsbCwgc2hvcnRjdXQgbWV0aG9kcwogICAgICAgICAgICAgICAgICogd2VyZSBjcmVhdGVkOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiAgICRodHRwLmdldCgnL3NvbWVVcmwnKS5zdWNjZXNzKHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgKiAgICRodHRwLnBvc3QoJy9zb21lVXJsJywgZGF0YSkuc3VjY2VzcyhzdWNjZXNzQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQ29tcGxldGUgbGlzdCBvZiBzaG9ydGN1dCBtZXRob2RzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2dldCAkaHR0cC5nZXR9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNoZWFkICRodHRwLmhlYWR9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwb3N0ICRodHRwLnBvc3R9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwdXQgJGh0dHAucHV0fQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjZGVsZXRlICRodHRwLmRlbGV0ZX0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2pzb25wICRodHRwLmpzb25wfQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFNldHRpbmcgSFRUUCBIZWFkZXJzCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlICRodHRwIHNlcnZpY2Ugd2lsbCBhdXRvbWF0aWNhbGx5IGFkZCBjZXJ0YWluIEhUVFAgaGVhZGVycyB0byBhbGwgcmVxdWVzdHMuIFRoZXNlIGRlZmF1bHRzCiAgICAgICAgICAgICAgICAgKiBjYW4gYmUgZnVsbHkgY29uZmlndXJlZCBieSBhY2Nlc3NpbmcgdGhlIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnNgIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAqIG9iamVjdCwgd2hpY2ggY3VycmVudGx5IGNvbnRhaW5zIHRoaXMgZGVmYXVsdCBjb25maWd1cmF0aW9uOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5jb21tb25gIChoZWFkZXJzIHRoYXQgYXJlIGNvbW1vbiBmb3IgYWxsIHJlcXVlc3RzKToKICAgICAgICAgICAgICAgICAqICAgLSBgQWNjZXB0OiBhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L3BsYWluLCAqIC8gKmAKICAgICAgICAgICAgICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5wb3N0YDogKGhlYWRlciBkZWZhdWx0cyBmb3IgUE9TVCByZXF1ZXN0cykKICAgICAgICAgICAgICAgICAqICAgLSBgQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uYAogICAgICAgICAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnB1dGAgKGhlYWRlciBkZWZhdWx0cyBmb3IgUFVUIHJlcXVlc3RzKQogICAgICAgICAgICAgICAgICogICAtIGBDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb25gCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVG8gYWRkIG9yIG92ZXJ3cml0ZSB0aGVzZSBkZWZhdWx0cywgc2ltcGx5IGFkZCBvciByZW1vdmUgYSBwcm9wZXJ0eSBmcm9tIHRoZXNlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAqIG9iamVjdHMuIFRvIGFkZCBoZWFkZXJzIGZvciBhbiBIVFRQIG1ldGhvZCBvdGhlciB0aGFuIFBPU1Qgb3IgUFVULCBzaW1wbHkgYWRkIGEgbmV3IG9iamVjdAogICAgICAgICAgICAgICAgICogd2l0aCB0aGUgbG93ZXJjYXNlZCBIVFRQIG1ldGhvZCBuYW1lIGFzIHRoZSBrZXksIGUuZy4KICAgICAgICAgICAgICAgICAqIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMuZ2V0WydNeS1IZWFkZXInXT0ndmFsdWUnYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBZGRpdGlvbmFsbHksIHRoZSBkZWZhdWx0cyBjYW4gYmUgc2V0IGF0IHJ1bnRpbWUgdmlhIHRoZSBgJGh0dHAuZGVmYXVsdHNgIG9iamVjdCBpbiB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogZmFzaGlvbi4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJvdGggcmVxdWVzdHMgYW5kIHJlc3BvbnNlcyBjYW4gYmUgdHJhbnNmb3JtZWQgdXNpbmcgdHJhbnNmb3JtIGZ1bmN0aW9ucy4gQnkgZGVmYXVsdCwgQW5ndWxhcgogICAgICAgICAgICAgICAgICogYXBwbGllcyB0aGVzZSB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogUmVxdWVzdCB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSBJZiB0aGUgYGRhdGFgIHByb3BlcnR5IG9mIHRoZSByZXF1ZXN0IGNvbmZpZ3VyYXRpb24gb2JqZWN0IGNvbnRhaW5zIGFuIG9iamVjdCwgc2VyaWFsaXplIGl0IGludG8KICAgICAgICAgICAgICAgICAqICAgSlNPTiBmb3JtYXQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogUmVzcG9uc2UgdHJhbnNmb3JtYXRpb25zOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAtIElmIFhTUkYgcHJlZml4IGlzIGRldGVjdGVkLCBzdHJpcCBpdCAoc2VlIFNlY3VyaXR5IENvbnNpZGVyYXRpb25zIHNlY3Rpb24gYmVsb3cpLgogICAgICAgICAgICAgICAgICogIC0gSWYgSlNPTiByZXNwb25zZSBpcyBkZXRlY3RlZCwgZGVzZXJpYWxpemUgaXQgdXNpbmcgYSBKU09OIHBhcnNlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBnbG9iYWxseSBhdWdtZW50IG9yIG92ZXJyaWRlIHRoZSBkZWZhdWx0IHRyYW5zZm9ybXMsIG1vZGlmeSB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMudHJhbnNmb3JtUmVxdWVzdGAgYW5kCiAgICAgICAgICAgICAgICAgKiBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy50cmFuc2Zvcm1SZXNwb25zZWAgcHJvcGVydGllcy4gVGhlc2UgcHJvcGVydGllcyBhcmUgYnkgZGVmYXVsdCBhbgogICAgICAgICAgICAgICAgICogYXJyYXkgb2YgdHJhbnNmb3JtIGZ1bmN0aW9ucywgd2hpY2ggYWxsb3dzIHlvdSB0byBgcHVzaGAgb3IgYHVuc2hpZnRgIGEgbmV3IHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9uIGludG8gdGhlCiAgICAgICAgICAgICAgICAgKiB0cmFuc2Zvcm1hdGlvbiBjaGFpbi4gWW91IGNhbiBhbHNvIGRlY2lkZSB0byBjb21wbGV0ZWx5IG92ZXJyaWRlIGFueSBkZWZhdWx0IHRyYW5zZm9ybWF0aW9ucyBieSBhc3NpZ25pbmcgeW91cgogICAgICAgICAgICAgICAgICogdHJhbnNmb3JtYXRpb24gZnVuY3Rpb25zIHRvIHRoZXNlIHByb3BlcnRpZXMgZGlyZWN0bHkgd2l0aG91dCB0aGUgYXJyYXkgd3JhcHBlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTaW1pbGFybHksIHRvIGxvY2FsbHkgb3ZlcnJpZGUgdGhlIHJlcXVlc3QvcmVzcG9uc2UgdHJhbnNmb3JtcywgYXVnbWVudCB0aGUgYHRyYW5zZm9ybVJlcXVlc3RgIGFuZC9vcgogICAgICAgICAgICAgICAgICogYHRyYW5zZm9ybVJlc3BvbnNlYCBwcm9wZXJ0aWVzIG9mIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCBwYXNzZWQgaW50byBgJGh0dHBgLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIENhY2hpbmcKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBlbmFibGUgY2FjaGluZywgc2V0IHRoZSBjb25maWd1cmF0aW9uIHByb3BlcnR5IGBjYWNoZWAgdG8gYHRydWVgLiBXaGVuIHRoZSBjYWNoZSBpcwogICAgICAgICAgICAgICAgICogZW5hYmxlZCwgYCRodHRwYCBzdG9yZXMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciBpbiBsb2NhbCBjYWNoZS4gTmV4dCB0aW1lIHRoZQogICAgICAgICAgICAgICAgICogcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gdGhlIGNhY2hlIHdpdGhvdXQgc2VuZGluZyBhIHJlcXVlc3QgdG8gdGhlIHNlcnZlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBOb3RlIHRoYXQgZXZlbiBpZiB0aGUgcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gY2FjaGUsIGRlbGl2ZXJ5IG9mIHRoZSBkYXRhIGlzIGFzeW5jaHJvbm91cyBpbgogICAgICAgICAgICAgICAgICogdGhlIHNhbWUgd2F5IHRoYXQgcmVhbCByZXF1ZXN0cyBhcmUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogSWYgdGhlcmUgYXJlIG11bHRpcGxlIEdFVCByZXF1ZXN0cyBmb3IgdGhlIHNhbWUgVVJMIHRoYXQgc2hvdWxkIGJlIGNhY2hlZCB1c2luZyB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogY2FjaGUsIGJ1dCB0aGUgY2FjaGUgaXMgbm90IHBvcHVsYXRlZCB5ZXQsIG9ubHkgb25lIHJlcXVlc3QgdG8gdGhlIHNlcnZlciB3aWxsIGJlIG1hZGUgYW5kCiAgICAgICAgICAgICAgICAgKiB0aGUgcmVtYWluaW5nIHJlcXVlc3RzIHdpbGwgYmUgZnVsZmlsbGVkIHVzaW5nIHRoZSByZXNwb25zZSBmcm9tIHRoZSBmaXJzdCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEEgY3VzdG9tIGRlZmF1bHQgY2FjaGUgYnVpbHQgd2l0aCAkY2FjaGVGYWN0b3J5IGNhbiBiZSBwcm92aWRlZCBpbiAkaHR0cC5kZWZhdWx0cy5jYWNoZS4KICAgICAgICAgICAgICAgICAqIFRvIHNraXAgaXQsIHNldCBjb25maWd1cmF0aW9uIHByb3BlcnR5IGBjYWNoZWAgdG8gYGZhbHNlYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBJbnRlcmNlcHRvcnMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBCZWZvcmUgeW91IHN0YXJ0IGNyZWF0aW5nIGludGVyY2VwdG9ycywgYmUgc3VyZSB0byB1bmRlcnN0YW5kIHRoZQogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRxICRxIGFuZCBkZWZlcnJlZC9wcm9taXNlIEFQSXN9LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciBwdXJwb3NlcyBvZiBnbG9iYWwgZXJyb3IgaGFuZGxpbmcsIGF1dGhlbnRpY2F0aW9uLCBvciBhbnkga2luZCBvZiBzeW5jaHJvbm91cyBvcgogICAgICAgICAgICAgICAgICogYXN5bmNocm9ub3VzIHByZS1wcm9jZXNzaW5nIG9mIHJlcXVlc3Qgb3IgcG9zdHByb2Nlc3Npbmcgb2YgcmVzcG9uc2VzLCBpdCBpcyBkZXNpcmFibGUgdG8gYmUKICAgICAgICAgICAgICAgICAqIGFibGUgdG8gaW50ZXJjZXB0IHJlcXVlc3RzIGJlZm9yZSB0aGV5IGFyZSBoYW5kZWQgdG8gdGhlIHNlcnZlciBhbmQKICAgICAgICAgICAgICAgICAqIHJlc3BvbnNlcyBiZWZvcmUgdGhleSBhcmUgaGFuZGVkIG92ZXIgdG8gdGhlIGFwcGxpY2F0aW9uIGNvZGUgdGhhdAogICAgICAgICAgICAgICAgICogaW5pdGlhdGVkIHRoZXNlIHJlcXVlc3RzLiBUaGUgaW50ZXJjZXB0b3JzIGxldmVyYWdlIHRoZSB7QGxpbmsgbmcuJHEKICAgICAgICAgICAgICAgICAqIHByb21pc2UgQVBJc30gdG8gZnVsZmlsbCB0aGlzIG5lZWQgZm9yIGJvdGggc3luY2hyb25vdXMgYW5kIGFzeW5jaHJvbm91cyBwcmUtcHJvY2Vzc2luZy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgaW50ZXJjZXB0b3JzIGFyZSBzZXJ2aWNlIGZhY3RvcmllcyB0aGF0IGFyZSByZWdpc3RlcmVkIHdpdGggdGhlIGAkaHR0cFByb3ZpZGVyYCBieQogICAgICAgICAgICAgICAgICogYWRkaW5nIHRoZW0gdG8gdGhlIGAkaHR0cFByb3ZpZGVyLmludGVyY2VwdG9yc2AgYXJyYXkuIFRoZSBmYWN0b3J5IGlzIGNhbGxlZCBhbmQKICAgICAgICAgICAgICAgICAqIGluamVjdGVkIHdpdGggZGVwZW5kZW5jaWVzIChpZiBzcGVjaWZpZWQpIGFuZCByZXR1cm5zIHRoZSBpbnRlcmNlcHRvci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGVyZSBhcmUgdHdvIGtpbmRzIG9mIGludGVyY2VwdG9ycyAoYW5kIHR3byBraW5kcyBvZiByZWplY3Rpb24gaW50ZXJjZXB0b3JzKToKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICogYHJlcXVlc3RgOiBpbnRlcmNlcHRvcnMgZ2V0IGNhbGxlZCB3aXRoIGh0dHAgYGNvbmZpZ2Agb2JqZWN0LiBUaGUgZnVuY3Rpb24gaXMgZnJlZSB0byBtb2RpZnkKICAgICAgICAgICAgICAgICAqICAgICB0aGUgYGNvbmZpZ2Agb3IgY3JlYXRlIGEgbmV3IG9uZS4gVGhlIGZ1bmN0aW9uIG5lZWRzIHRvIHJldHVybiB0aGUgYGNvbmZpZ2AgZGlyZWN0bHkgb3IgYXMgYQogICAgICAgICAgICAgICAgICogICAgIHByb21pc2UuCiAgICAgICAgICAgICAgICAgKiAgICogYHJlcXVlc3RFcnJvcmA6IGludGVyY2VwdG9yIGdldHMgY2FsbGVkIHdoZW4gYSBwcmV2aW91cyBpbnRlcmNlcHRvciB0aHJldyBhbiBlcnJvciBvciByZXNvbHZlZAogICAgICAgICAgICAgICAgICogICAgICB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAgICAgICAgICAgICogICAqIGByZXNwb25zZWA6IGludGVyY2VwdG9ycyBnZXQgY2FsbGVkIHdpdGggaHR0cCBgcmVzcG9uc2VgIG9iamVjdC4gVGhlIGZ1bmN0aW9uIGlzIGZyZWUgdG8gbW9kaWZ5CiAgICAgICAgICAgICAgICAgKiAgICAgdGhlIGByZXNwb25zZWAgb3IgY3JlYXRlIGEgbmV3IG9uZS4gVGhlIGZ1bmN0aW9uIG5lZWRzIHRvIHJldHVybiB0aGUgYHJlc3BvbnNlYCBkaXJlY3RseSBvciBhcyBhCiAgICAgICAgICAgICAgICAgKiAgICAgcHJvbWlzZS4KICAgICAgICAgICAgICAgICAqICAgKiBgcmVzcG9uc2VFcnJvcmA6IGludGVyY2VwdG9yIGdldHMgY2FsbGVkIHdoZW4gYSBwcmV2aW91cyBpbnRlcmNlcHRvciB0aHJldyBhbiBlcnJvciBvciByZXNvbHZlZAogICAgICAgICAgICAgICAgICogICAgICB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgYXMgYSBzZXJ2aWNlCiAgICAgICAgICAgICAgICAgKiAgICRwcm92aWRlLmZhY3RvcnkoJ215SHR0cEludGVyY2VwdG9yJywgZnVuY3Rpb24oJHEsIGRlcGVuZGVuY3kxLCBkZXBlbmRlbmN5MikgewogICAgICAgICAgICAgICAgICogICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAgICAgICAgICAgICAqICAgICAgICdyZXF1ZXN0JzogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBzdWNjZXNzCiAgICAgICAgICAgICAgICAgKiAgICAgICAgIHJldHVybiBjb25maWcgfHwgJHEud2hlbihjb25maWcpOwogICAgICAgICAgICAgICAgICogICAgICAgfSwKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAgICAgICAgICAgICAqICAgICAgJ3JlcXVlc3RFcnJvcic6IGZ1bmN0aW9uKHJlamVjdGlvbikgewogICAgICAgICAgICAgICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAgICAgICAgICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVqZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICogICAgICAgICAgIHJldHVybiByZXNwb25zZU9yTmV3UHJvbWlzZQogICAgICAgICAgICAgICAgICogICAgICAgICB9CiAgICAgICAgICAgICAgICAgKiAgICAgICAgIHJldHVybiAkcS5yZWplY3QocmVqZWN0aW9uKTsKICAgICAgICAgICAgICAgICAqICAgICAgIH0sCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAgICAgICAgICAgICAqICAgICAgICdyZXNwb25zZSc6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBzdWNjZXNzCiAgICAgICAgICAgICAgICAgKiAgICAgICAgIHJldHVybiByZXNwb25zZSB8fCAkcS53aGVuKHJlc3BvbnNlKTsKICAgICAgICAgICAgICAgICAqICAgICAgIH0sCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAgICAgLy8gb3B0aW9uYWwgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiAgICAgICdyZXNwb25zZUVycm9yJzogZnVuY3Rpb24ocmVqZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBlcnJvcgogICAgICAgICAgICAgICAgICogICAgICAgICBpZiAoY2FuUmVjb3ZlcihyZWplY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgICAgICAgICAgICAgKiAgICAgICAgIH0KICAgICAgICAgICAgICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZWplY3Rpb24pOwogICAgICAgICAgICAgICAgICogICAgICAgfTsKICAgICAgICAgICAgICAgICAqICAgICB9CiAgICAgICAgICAgICAgICAgKiAgIH0pOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgJGh0dHBQcm92aWRlci5pbnRlcmNlcHRvcnMucHVzaCgnbXlIdHRwSW50ZXJjZXB0b3InKTsKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgdmlhIGFuIGFub255bW91cyBmYWN0b3J5CiAgICAgICAgICAgICAgICAgKiAgICRodHRwUHJvdmlkZXIuaW50ZXJjZXB0b3JzLnB1c2goZnVuY3Rpb24oJHEsIGRlcGVuZGVuY3kxLCBkZXBlbmRlbmN5MikgewogICAgICAgICAgICAgICAgICogICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgKiAgICAgICdyZXF1ZXN0JzogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlCiAgICAgICAgICAgICAgICAgKiAgICAgICB9LAogICAgICAgICAgICAgICAgICogICAgICAgJ3Jlc3BvbnNlJzogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAqICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUKICAgICAgICAgICAgICAgICAqICAgICAgIH0KICAgICAgICAgICAgICAgICAqICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFJlc3BvbnNlIGludGVyY2VwdG9ycyAoREVQUkVDQVRFRCkKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBCZWZvcmUgeW91IHN0YXJ0IGNyZWF0aW5nIGludGVyY2VwdG9ycywgYmUgc3VyZSB0byB1bmRlcnN0YW5kIHRoZQogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRxICRxIGFuZCBkZWZlcnJlZC9wcm9taXNlIEFQSXN9LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciBwdXJwb3NlcyBvZiBnbG9iYWwgZXJyb3IgaGFuZGxpbmcsIGF1dGhlbnRpY2F0aW9uIG9yIGFueSBraW5kIG9mIHN5bmNocm9ub3VzIG9yCiAgICAgICAgICAgICAgICAgKiBhc3luY2hyb25vdXMgcHJlcHJvY2Vzc2luZyBvZiByZWNlaXZlZCByZXNwb25zZXMsIGl0IGlzIGRlc2lyYWJsZSB0byBiZSBhYmxlIHRvIGludGVyY2VwdAogICAgICAgICAgICAgICAgICogcmVzcG9uc2VzIGZvciBodHRwIHJlcXVlc3RzIGJlZm9yZSB0aGV5IGFyZSBoYW5kZWQgb3ZlciB0byB0aGUgYXBwbGljYXRpb24gY29kZSB0aGF0CiAgICAgICAgICAgICAgICAgKiBpbml0aWF0ZWQgdGhlc2UgcmVxdWVzdHMuIFRoZSByZXNwb25zZSBpbnRlcmNlcHRvcnMgbGV2ZXJhZ2UgdGhlIHtAbGluayBuZy4kcQogICAgICAgICAgICAgICAgICogcHJvbWlzZSBhcGlzfSB0byBmdWxmaWwgdGhpcyBuZWVkIGZvciBib3RoIHN5bmNocm9ub3VzIGFuZCBhc3luY2hyb25vdXMgcHJlcHJvY2Vzc2luZy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgaW50ZXJjZXB0b3JzIGFyZSBzZXJ2aWNlIGZhY3RvcmllcyB0aGF0IGFyZSByZWdpc3RlcmVkIHdpdGggdGhlICRodHRwUHJvdmlkZXIgYnkKICAgICAgICAgICAgICAgICAqIGFkZGluZyB0aGVtIHRvIHRoZSBgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9yc2AgYXJyYXkuIFRoZSBmYWN0b3J5IGlzIGNhbGxlZCBhbmQKICAgICAgICAgICAgICAgICAqIGluamVjdGVkIHdpdGggZGVwZW5kZW5jaWVzIChpZiBzcGVjaWZpZWQpIGFuZCByZXR1cm5zIHRoZSBpbnRlcmNlcHRvciAg4oCUIGEgZnVuY3Rpb24gdGhhdAogICAgICAgICAgICAgICAgICogdGFrZXMgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0gYW5kIHJldHVybnMgdGhlIG9yaWdpbmFsIG9yIGEgbmV3IHByb21pc2UuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICAgLy8gcmVnaXN0ZXIgdGhlIGludGVyY2VwdG9yIGFzIGEgc2VydmljZQogICAgICAgICAgICAgICAgICogICAkcHJvdmlkZS5mYWN0b3J5KCdteUh0dHBJbnRlcmNlcHRvcicsIGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAgICAgICAgICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICAgICAgICAgICAgICogICAgICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gc3VjY2VzcwogICAgICAgICAgICAgICAgICogICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgICAgICAgICAgICAgKiAgICAgICB9LCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAgICAgICAgICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVzcG9uc2UpKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgICAgICAgICAgICAgKiAgICAgICAgIH0KICAgICAgICAgICAgICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZXNwb25zZSk7CiAgICAgICAgICAgICAgICAgKiAgICAgICB9KTsKICAgICAgICAgICAgICAgICAqICAgICB9CiAgICAgICAgICAgICAgICAgKiAgIH0pOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKCdteUh0dHBJbnRlcmNlcHRvcicpOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgIC8vIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciB2aWEgYW4gYW5vbnltb3VzIGZhY3RvcnkKICAgICAgICAgICAgICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAgICAgICAgICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICAgICAgICAgICAgICogICAgICAgLy8gc2FtZSBhcyBhYm92ZQogICAgICAgICAgICAgICAgICogICAgIH0KICAgICAgICAgICAgICAgICAqICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBTZWN1cml0eSBDb25zaWRlcmF0aW9ucwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFdoZW4gZGVzaWduaW5nIHdlYiBhcHBsaWNhdGlvbnMsIGNvbnNpZGVyIHNlY3VyaXR5IHRocmVhdHMgZnJvbToKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBodHRwOi8vaGFhY2tlZC5jb20vYXJjaGl2ZS8yMDA4LzExLzIwL2FuYXRvbXktb2YtYS1zdWJ0bGUtanNvbi12dWxuZXJhYmlsaXR5LmFzcHgKICAgICAgICAgICAgICAgICAqICAgSlNPTiB2dWxuZXJhYmlsaXR5fQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1zaXRlX3JlcXVlc3RfZm9yZ2VyeSBYU1JGfQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJvdGggc2VydmVyIGFuZCB0aGUgY2xpZW50IG11c3QgY29vcGVyYXRlIGluIG9yZGVyIHRvIGVsaW1pbmF0ZSB0aGVzZSB0aHJlYXRzLiBBbmd1bGFyIGNvbWVzCiAgICAgICAgICAgICAgICAgKiBwcmUtY29uZmlndXJlZCB3aXRoIHN0cmF0ZWdpZXMgdGhhdCBhZGRyZXNzIHRoZXNlIGlzc3VlcywgYnV0IGZvciB0aGlzIHRvIHdvcmsgYmFja2VuZCBzZXJ2ZXIKICAgICAgICAgICAgICAgICAqIGNvb3BlcmF0aW9uIGlzIHJlcXVpcmVkLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMjIEpTT04gVnVsbmVyYWJpbGl0eSBQcm90ZWN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQSB7QGxpbmsgaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4CiAgICAgICAgICAgICAgICAgKiBKU09OIHZ1bG5lcmFiaWxpdHl9IGFsbG93cyB0aGlyZCBwYXJ0eSB3ZWJzaXRlIHRvIHR1cm4geW91ciBKU09OIHJlc291cmNlIFVSTCBpbnRvCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9KU09OUCBKU09OUH0gcmVxdWVzdCB1bmRlciBzb21lIGNvbmRpdGlvbnMuIFRvCiAgICAgICAgICAgICAgICAgKiBjb3VudGVyIHRoaXMgeW91ciBzZXJ2ZXIgY2FuIHByZWZpeCBhbGwgSlNPTiByZXF1ZXN0cyB3aXRoIGZvbGxvd2luZyBzdHJpbmcgYCIpXX0nLFxuImAuCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyIHdpbGwgYXV0b21hdGljYWxseSBzdHJpcCB0aGUgcHJlZml4IGJlZm9yZSBwcm9jZXNzaW5nIGl0IGFzIEpTT04uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIGV4YW1wbGUgaWYgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gcmV0dXJuOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqIFsnb25lJywndHdvJ10KICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIHdoaWNoIGlzIHZ1bG5lcmFibGUgdG8gYXR0YWNrLCB5b3VyIHNlcnZlciBjYW4gcmV0dXJuOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICldfScsCiAgICAgICAgICAgICAgICAgKiBbJ29uZScsJ3R3byddCiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyIHdpbGwgc3RyaXAgdGhlIHByZWZpeCwgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIEpTT04uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMjIENyb3NzIFNpdGUgUmVxdWVzdCBGb3JnZXJ5IChYU1JGKSBQcm90ZWN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkgWFNSRn0gaXMgYSB0ZWNobmlxdWUgYnkgd2hpY2gKICAgICAgICAgICAgICAgICAqIGFuIHVuYXV0aG9yaXplZCBzaXRlIGNhbiBnYWluIHlvdXIgdXNlcidzIHByaXZhdGUgZGF0YS4gQW5ndWxhciBwcm92aWRlcyBhIG1lY2hhbmlzbQogICAgICAgICAgICAgICAgICogdG8gY291bnRlciBYU1JGLiBXaGVuIHBlcmZvcm1pbmcgWEhSIHJlcXVlc3RzLCB0aGUgJGh0dHAgc2VydmljZSByZWFkcyBhIHRva2VuIGZyb20gYSBjb29raWUKICAgICAgICAgICAgICAgICAqIChieSBkZWZhdWx0LCBgWFNSRi1UT0tFTmApIGFuZCBzZXRzIGl0IGFzIGFuIEhUVFAgaGVhZGVyIChgWC1YU1JGLVRPS0VOYCkuIFNpbmNlIG9ubHkKICAgICAgICAgICAgICAgICAqIEphdmFTY3JpcHQgdGhhdCBydW5zIG9uIHlvdXIgZG9tYWluIGNvdWxkIHJlYWQgdGhlIGNvb2tpZSwgeW91ciBzZXJ2ZXIgY2FuIGJlIGFzc3VyZWQgdGhhdAogICAgICAgICAgICAgICAgICogdGhlIFhIUiBjYW1lIGZyb20gSmF2YVNjcmlwdCBydW5uaW5nIG9uIHlvdXIgZG9tYWluLiBUaGUgaGVhZGVyIHdpbGwgbm90IGJlIHNldCBmb3IKICAgICAgICAgICAgICAgICAqIGNyb3NzLWRvbWFpbiByZXF1ZXN0cy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyB0YWtlIGFkdmFudGFnZSBvZiB0aGlzLCB5b3VyIHNlcnZlciBuZWVkcyB0byBzZXQgYSB0b2tlbiBpbiBhIEphdmFTY3JpcHQgcmVhZGFibGUgc2Vzc2lvbgogICAgICAgICAgICAgICAgICogY29va2llIGNhbGxlZCBgWFNSRi1UT0tFTmAgb24gdGhlIGZpcnN0IEhUVFAgR0VUIHJlcXVlc3QuIE9uIHN1YnNlcXVlbnQgWEhSIHJlcXVlc3RzIHRoZQogICAgICAgICAgICAgICAgICogc2VydmVyIGNhbiB2ZXJpZnkgdGhhdCB0aGUgY29va2llIG1hdGNoZXMgYFgtWFNSRi1UT0tFTmAgSFRUUCBoZWFkZXIsIGFuZCB0aGVyZWZvcmUgYmUgc3VyZQogICAgICAgICAgICAgICAgICogdGhhdCBvbmx5IEphdmFTY3JpcHQgcnVubmluZyBvbiB5b3VyIGRvbWFpbiBjb3VsZCBoYXZlIHNlbnQgdGhlIHJlcXVlc3QuIFRoZSB0b2tlbiBtdXN0IGJlCiAgICAgICAgICAgICAgICAgKiB1bmlxdWUgZm9yIGVhY2ggdXNlciBhbmQgbXVzdCBiZSB2ZXJpZmlhYmxlIGJ5IHRoZSBzZXJ2ZXIgKHRvIHByZXZlbnQgdGhlIEphdmFTY3JpcHQgZnJvbSBtYWtpbmcKICAgICAgICAgICAgICAgICAqIHVwIGl0cyBvd24gdG9rZW5zKS4gV2UgcmVjb21tZW5kIHRoYXQgdGhlIHRva2VuIGlzIGEgZGlnZXN0IG9mIHlvdXIgc2l0ZSdzIGF1dGhlbnRpY2F0aW9uCiAgICAgICAgICAgICAgICAgKiBjb29raWUgd2l0aCBhIHtAbGluayBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TYWx0XyhjcnlwdG9ncmFwaHkpIHNhbHR9IGZvciBhZGRlZCBzZWN1cml0eS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgbmFtZSBvZiB0aGUgaGVhZGVycyBjYW4gYmUgc3BlY2lmaWVkIHVzaW5nIHRoZSB4c3JmSGVhZGVyTmFtZSBhbmQgeHNyZkNvb2tpZU5hbWUKICAgICAgICAgICAgICAgICAqIHByb3BlcnRpZXMgb2YgZWl0aGVyICRodHRwUHJvdmlkZXIuZGVmYXVsdHMsIG9yIHRoZSBwZXItcmVxdWVzdCBjb25maWcgb2JqZWN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gY29uZmlnIE9iamVjdCBkZXNjcmliaW5nIHRoZSByZXF1ZXN0IHRvIGJlIG1hZGUgYW5kIGhvdyBpdCBzaG91bGQgYmUKICAgICAgICAgICAgICAgICAqICAgIHByb2Nlc3NlZC4gVGhlIG9iamVjdCBoYXMgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAgLSAqKm1ldGhvZCoqIOKAkyBge3N0cmluZ31gIOKAkyBIVFRQIG1ldGhvZCAoZS5nLiAnR0VUJywgJ1BPU1QnLCBldGMpCiAgICAgICAgICAgICAgICAgKiAgICAtICoqdXJsKiog4oCTIGB7c3RyaW5nfWAg4oCTIEFic29sdXRlIG9yIHJlbGF0aXZlIFVSTCBvZiB0aGUgcmVzb3VyY2UgdGhhdCBpcyBiZWluZyByZXF1ZXN0ZWQuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqcGFyYW1zKiog4oCTIGB7T2JqZWN0LjxzdHJpbmd8T2JqZWN0Pn1gIOKAkyBNYXAgb2Ygc3RyaW5ncyBvciBvYmplY3RzIHdoaWNoIHdpbGwgYmUgdHVybmVkIHRvCiAgICAgICAgICAgICAgICAgKiAgICAgIGA/a2V5MT12YWx1ZTEma2V5Mj12YWx1ZTJgIGFmdGVyIHRoZSB1cmwuIElmIHRoZSB2YWx1ZSBpcyBub3QgYSBzdHJpbmcsIGl0IHdpbGwgYmUgSlNPTmlmaWVkLgogICAgICAgICAgICAgICAgICogICAgLSAqKmRhdGEqKiDigJMgYHtzdHJpbmd8T2JqZWN0fWAg4oCTIERhdGEgdG8gYmUgc2VudCBhcyB0aGUgcmVxdWVzdCBtZXNzYWdlIGRhdGEuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqaGVhZGVycyoqIOKAkyBge09iamVjdH1gIOKAkyBNYXAgb2Ygc3RyaW5ncyBvciBmdW5jdGlvbnMgd2hpY2ggcmV0dXJuIHN0cmluZ3MgcmVwcmVzZW50aW5nCiAgICAgICAgICAgICAgICAgKiAgICAgIEhUVFAgaGVhZGVycyB0byBzZW5kIHRvIHRoZSBzZXJ2ZXIuIElmIHRoZSByZXR1cm4gdmFsdWUgb2YgYSBmdW5jdGlvbiBpcyBudWxsLCB0aGUgaGVhZGVyIHdpbGwKICAgICAgICAgICAgICAgICAqICAgICAgbm90IGJlIHNlbnQuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqeHNyZkhlYWRlck5hbWUqKiDigJMgYHtzdHJpbmd9YCDigJMgTmFtZSBvZiBIVFRQIGhlYWRlciB0byBwb3B1bGF0ZSB3aXRoIHRoZSBYU1JGIHRva2VuLgogICAgICAgICAgICAgICAgICogICAgLSAqKnhzcmZDb29raWVOYW1lKiog4oCTIGB7c3RyaW5nfWAg4oCTIE5hbWUgb2YgY29va2llIGNvbnRhaW5pbmcgdGhlIFhTUkYgdG9rZW4uCiAgICAgICAgICAgICAgICAgKiAgICAtICoqdHJhbnNmb3JtUmVxdWVzdCoqIOKAkyBge2Z1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpfEFycmF5LjxmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKT59YCDigJMKICAgICAgICAgICAgICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgICAgICAgICAgICAgKiAgICAgIHJlcXVlc3QgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICAgICAgICAgICAgICogICAgLSAqKnRyYW5zZm9ybVJlc3BvbnNlKiog4oCTIGB7ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcil8QXJyYXkuPGZ1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpPn1gIOKAkwogICAgICAgICAgICAgICAgICogICAgICB0cmFuc2Zvcm0gZnVuY3Rpb24gb3IgYW4gYXJyYXkgb2Ygc3VjaCBmdW5jdGlvbnMuIFRoZSB0cmFuc2Zvcm0gZnVuY3Rpb24gdGFrZXMgdGhlIGh0dHAKICAgICAgICAgICAgICAgICAqICAgICAgcmVzcG9uc2UgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBkZXNlcmlhbGl6ZWQpIHZlcnNpb24uCiAgICAgICAgICAgICAgICAgKiAgICAtICoqY2FjaGUqKiDigJMgYHtib29sZWFufENhY2hlfWAg4oCTIElmIHRydWUsIGEgZGVmYXVsdCAkaHR0cCBjYWNoZSB3aWxsIGJlIHVzZWQgdG8gY2FjaGUgdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgIEdFVCByZXF1ZXN0LCBvdGhlcndpc2UgaWYgYSBjYWNoZSBpbnN0YW5jZSBidWlsdCB3aXRoCiAgICAgICAgICAgICAgICAgKiAgICAgIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LCB0aGlzIGNhY2hlIHdpbGwgYmUgdXNlZCBmb3IKICAgICAgICAgICAgICAgICAqICAgICAgY2FjaGluZy4KICAgICAgICAgICAgICAgICAqICAgIC0gKip0aW1lb3V0Kiog4oCTIGB7bnVtYmVyfFByb21pc2V9YCDigJMgdGltZW91dCBpbiBtaWxsaXNlY29uZHMsIG9yIHtAbGluayBuZy4kcSBwcm9taXNlfQogICAgICAgICAgICAgICAgICogICAgICB0aGF0IHNob3VsZCBhYm9ydCB0aGUgcmVxdWVzdCB3aGVuIHJlc29sdmVkLgogICAgICAgICAgICAgICAgICogICAgLSAqKndpdGhDcmVkZW50aWFscyoqIC0gYHtib29sZWFufWAgLSB3aGV0aGVyIHRvIHRvIHNldCB0aGUgYHdpdGhDcmVkZW50aWFsc2AgZmxhZyBvbiB0aGUKICAgICAgICAgICAgICAgICAqICAgICAgWEhSIG9iamVjdC4gU2VlIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9odHRwX2FjY2Vzc19jb250cm9sI3NlY3Rpb25fNQogICAgICAgICAgICAgICAgICogICAgICByZXF1ZXN0cyB3aXRoIGNyZWRlbnRpYWxzfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAgICAgICAgICAgICAqICAgIC0gKipyZXNwb25zZVR5cGUqKiAtIGB7c3RyaW5nfWAgLSBzZWUge0BsaW5rCiAgICAgICAgICAgICAgICAgKiAgICAgIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL1hNTEh0dHBSZXF1ZXN0I3Jlc3BvbnNlVHlwZSByZXF1ZXN0VHlwZX0uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBSZXR1cm5zIGEge0BsaW5rIG5nLiRxIHByb21pc2V9IG9iamVjdCB3aXRoIHRoZQogICAgICAgICAgICAgICAgICogICBzdGFuZGFyZCBgdGhlbmAgbWV0aG9kIGFuZCB0d28gaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuIFRoZSBgdGhlbmAKICAgICAgICAgICAgICAgICAqICAgbWV0aG9kIHRha2VzIHR3byBhcmd1bWVudHMgYSBzdWNjZXNzIGFuZCBhbiBlcnJvciBjYWxsYmFjayB3aGljaCB3aWxsIGJlIGNhbGxlZCB3aXRoIGEKICAgICAgICAgICAgICAgICAqICAgcmVzcG9uc2Ugb2JqZWN0LiBUaGUgYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgIG1ldGhvZHMgdGFrZSBhIHNpbmdsZSBhcmd1bWVudCAtIGEgZnVuY3Rpb24gdGhhdAogICAgICAgICAgICAgICAgICogICB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IHN1Y2NlZWRzIG9yIGZhaWxzIHJlc3BlY3RpdmVseS4gVGhlIGFyZ3VtZW50cyBwYXNzZWQgaW50bwogICAgICAgICAgICAgICAgICogICB0aGVzZSBmdW5jdGlvbnMgYXJlIGRlc3RydWN0dXJlZCByZXByZXNlbnRhdGlvbiBvZiB0aGUgcmVzcG9uc2Ugb2JqZWN0IHBhc3NlZCBpbnRvIHRoZQogICAgICAgICAgICAgICAgICogICBgdGhlbmAgbWV0aG9kLiBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0aGVzZSBwcm9wZXJ0aWVzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgLSAqKmRhdGEqKiDigJMgYHtzdHJpbmd8T2JqZWN0fWAg4oCTIFRoZSByZXNwb25zZSBib2R5IHRyYW5zZm9ybWVkIHdpdGggdGhlIHRyYW5zZm9ybSBmdW5jdGlvbnMuCiAgICAgICAgICAgICAgICAgKiAgIC0gKipzdGF0dXMqKiDigJMgYHtudW1iZXJ9YCDigJMgSFRUUCBzdGF0dXMgY29kZSBvZiB0aGUgcmVzcG9uc2UuCiAgICAgICAgICAgICAgICAgKiAgIC0gKipoZWFkZXJzKiog4oCTIGB7ZnVuY3Rpb24oW2hlYWRlck5hbWVdKX1gIOKAkyBIZWFkZXIgZ2V0dGVyIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICogICAtICoqY29uZmlnKiog4oCTIGB7T2JqZWN0fWAg4oCTIFRoZSBjb25maWd1cmF0aW9uIG9iamVjdCB0aGF0IHdhcyB1c2VkIHRvIGdlbmVyYXRlIHRoZSByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPE9iamVjdD59IHBlbmRpbmdSZXF1ZXN0cyBBcnJheSBvZiBjb25maWcgb2JqZWN0cyBmb3IgY3VycmVudGx5IHBlbmRpbmcKICAgICAgICAgICAgICAgICAqICAgcmVxdWVzdHMuIFRoaXMgaXMgcHJpbWFyaWx5IG1lYW50IHRvIGJlIHVzZWQgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgICAgICAgPGV4YW1wbGU+CiAgICAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICAgICAgICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkZldGNoQ3RybCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9Im1ldGhvZCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgPG9wdGlvbj5HRVQ8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICA8b3B0aW9uPkpTT05QPC9vcHRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InVybCIgc2l6ZT0iODAiLz4KICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iZmV0Y2goKSI+ZmV0Y2g8L2J1dHRvbj48YnI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9InVwZGF0ZU1vZGVsKCdHRVQnLCAnaHR0cC1oZWxsby5odG1sJykiPlNhbXBsZSBHRVQ8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywgJ2h0dHA6Ly9hbmd1bGFyanMub3JnL2dyZWV0LnBocD9jYWxsYmFjaz1KU09OX0NBTExCQUNLJm5hbWU9U3VwZXIlMjBIZXJvJykiPlNhbXBsZSBKU09OUDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnSlNPTlAnLCAnaHR0cDovL2FuZ3VsYXJqcy5vcmcvZG9lc250ZXhpc3QmY2FsbGJhY2s9SlNPTl9DQUxMQkFDSycpIj5JbnZhbGlkIEpTT05QPC9idXR0b24+CiAgICAgICAgICAgICAgICAgICAgICAgIDxwcmU+aHR0cCBzdGF0dXMgY29kZToge3tzdGF0dXN9fTwvcHJlPgogICAgICAgICAgICAgICAgICAgICAgICA8cHJlPmh0dHAgcmVzcG9uc2UgZGF0YToge3tkYXRhfX08L3ByZT4KICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gRmV0Y2hDdHJsKCRzY29wZSwgJGh0dHAsICR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5tZXRob2QgPSAnR0VUJzsKICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnVybCA9ICdodHRwLWhlbGxvLmh0bWwnOwogICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmZldGNoID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmNvZGUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5yZXNwb25zZSA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICRodHRwKHttZXRob2Q6ICRzY29wZS5tZXRob2QsIHVybDogJHNjb3BlLnVybCwgY2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuc3RhdHVzID0gc3RhdHVzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZGF0YSA9IGRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZGF0YSA9IGRhdGEgfHwgIlJlcXVlc3QgZmFpbGVkIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS51cGRhdGVNb2RlbCA9IGZ1bmN0aW9uKG1ldGhvZCwgdXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLm1ldGhvZCA9IG1ldGhvZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUudXJsID0gdXJsOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJodHRwLWhlbGxvLmh0bWwiPgogICAgICAgICAgICAgICAgICAgICAgSGVsbG8sICRodHRwIQogICAgICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgYW4geGhyIEdFVCByZXF1ZXN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoIlNhbXBsZSBHRVQiKScpLmNsaWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoImZldGNoIiknKS5jbGljaygpOwogICAgICAgICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnc3RhdHVzJykpLnRvQmUoJzIwMCcpOwogICAgICAgICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b01hdGNoKC9IZWxsbywgXCRodHRwIS8pOwogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBtYWtlIGEgSlNPTlAgcmVxdWVzdCB0byBhbmd1bGFyanMub3JnJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoIlNhbXBsZSBKU09OUCIpJykuY2xpY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiZmV0Y2giKScpLmNsaWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdzdGF0dXMnKSkudG9CZSgnMjAwJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdkYXRhJykpLnRvTWF0Y2goL1N1cGVyIEhlcm8hLyk7CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgSlNPTlAgcmVxdWVzdCB0byBpbnZhbGlkIFVSTCBhbmQgaW52b2tlIHRoZSBlcnJvciBoYW5kbGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiSW52YWxpZCBKU09OUCIpJykuY2xpY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiZmV0Y2giKScpLmNsaWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdzdGF0dXMnKSkudG9CZSgnMCcpOwogICAgICAgICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b0JlKCdSZXF1ZXN0IGZhaWxlZCcpOwogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgICA8L2V4YW1wbGU+CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uICRodHRwKHJlcXVlc3RDb25maWcpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY29uZmlnID0gewogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1SZXF1ZXN0OiBkZWZhdWx0cy50cmFuc2Zvcm1SZXF1ZXN0LAogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1SZXNwb25zZTogZGVmYXVsdHMudHJhbnNmb3JtUmVzcG9uc2UKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHZhciBoZWFkZXJzID0gbWVyZ2VIZWFkZXJzKHJlcXVlc3RDb25maWcpOwoKICAgICAgICAgICAgICAgICAgICBleHRlbmQoY29uZmlnLCByZXF1ZXN0Q29uZmlnKTsKICAgICAgICAgICAgICAgICAgICBjb25maWcuaGVhZGVycyA9IGhlYWRlcnM7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLm1ldGhvZCA9IHVwcGVyY2FzZShjb25maWcubWV0aG9kKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHhzcmZWYWx1ZSA9ICQkdXJsVXRpbHMuaXNTYW1lT3JpZ2luKGNvbmZpZy51cmwpCiAgICAgICAgICAgICAgICAgICAgICAgID8gJGJyb3dzZXIuY29va2llcygpW2NvbmZpZy54c3JmQ29va2llTmFtZSB8fCBkZWZhdWx0cy54c3JmQ29va2llTmFtZV0KICAgICAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHhzcmZWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzWyhjb25maWcueHNyZkhlYWRlck5hbWUgfHwgZGVmYXVsdHMueHNyZkhlYWRlck5hbWUpXSA9IHhzcmZWYWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICB2YXIgc2VydmVyUmVxdWVzdCA9IGZ1bmN0aW9uIChjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycyA9IGNvbmZpZy5oZWFkZXJzOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVxRGF0YSA9IHRyYW5zZm9ybURhdGEoY29uZmlnLmRhdGEsIGhlYWRlcnNHZXR0ZXIoaGVhZGVycyksIGNvbmZpZy50cmFuc2Zvcm1SZXF1ZXN0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0cmlwIGNvbnRlbnQtdHlwZSBpZiBkYXRhIGlzIHVuZGVmaW5lZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLmRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGhlYWRlcnMsIGZ1bmN0aW9uICh2YWx1ZSwgaGVhZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShoZWFkZXIpID09PSAnY29udGVudC10eXBlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLndpdGhDcmVkZW50aWFscykgJiYgIWlzVW5kZWZpbmVkKGRlZmF1bHRzLndpdGhDcmVkZW50aWFscykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy53aXRoQ3JlZGVudGlhbHMgPSBkZWZhdWx0cy53aXRoQ3JlZGVudGlhbHM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNlbmQgcmVxdWVzdAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIGhlYWRlcnMpLnRoZW4odHJhbnNmb3JtUmVzcG9uc2UsIHRyYW5zZm9ybVJlc3BvbnNlKTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICB2YXIgY2hhaW4gPSBbc2VydmVyUmVxdWVzdCwgdW5kZWZpbmVkXTsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9ICRxLndoZW4oY29uZmlnKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gYXBwbHkgaW50ZXJjZXB0b3JzCiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChyZXZlcnNlZEludGVyY2VwdG9ycywgZnVuY3Rpb24gKGludGVyY2VwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcmNlcHRvci5yZXF1ZXN0IHx8IGludGVyY2VwdG9yLnJlcXVlc3RFcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhaW4udW5zaGlmdChpbnRlcmNlcHRvci5yZXF1ZXN0LCBpbnRlcmNlcHRvci5yZXF1ZXN0RXJyb3IpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcmNlcHRvci5yZXNwb25zZSB8fCBpbnRlcmNlcHRvci5yZXNwb25zZUVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFpbi5wdXNoKGludGVyY2VwdG9yLnJlc3BvbnNlLCBpbnRlcmNlcHRvci5yZXNwb25zZUVycm9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY2hhaW4ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aGVuRm4gPSBjaGFpbi5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVqZWN0Rm4gPSBjaGFpbi5zaGlmdCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHByb21pc2UudGhlbih0aGVuRm4sIHJlamVjdEZuKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHByb21pc2Uuc3VjY2VzcyA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihyZXNwb25zZS5kYXRhLCByZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmhlYWRlcnMsIGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLmVycm9yID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihudWxsLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1SZXNwb25zZShyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBtYWtlIGEgY29weSBzaW5jZSB0aGUgcmVzcG9uc2UgbXVzdCBiZSBjYWNoZWFibGUKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3AgPSBleHRlbmQoe30sIHJlc3BvbnNlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB0cmFuc2Zvcm1EYXRhKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLmhlYWRlcnMsIGNvbmZpZy50cmFuc2Zvcm1SZXNwb25zZSkKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoaXNTdWNjZXNzKHJlc3BvbnNlLnN0YXR1cykpCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyByZXNwCiAgICAgICAgICAgICAgICAgICAgICAgICAgOiAkcS5yZWplY3QocmVzcCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBtZXJnZUhlYWRlcnMoY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZWZIZWFkZXJzID0gZGVmYXVsdHMuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcUhlYWRlcnMgPSBleHRlbmQoe30sIGNvbmZpZy5oZWFkZXJzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZkhlYWRlck5hbWUsIGxvd2VyY2FzZURlZkhlYWRlck5hbWUsIHJlcUhlYWRlck5hbWU7CgogICAgICAgICAgICAgICAgICAgICAgICBkZWZIZWFkZXJzID0gZXh0ZW5kKHt9LCBkZWZIZWFkZXJzLmNvbW1vbiwgZGVmSGVhZGVyc1tsb3dlcmNhc2UoY29uZmlnLm1ldGhvZCldKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGV4ZWN1dGUgaWYgaGVhZGVyIHZhbHVlIGlzIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWNIZWFkZXJzKGRlZkhlYWRlcnMpOwogICAgICAgICAgICAgICAgICAgICAgICBleGVjSGVhZGVycyhyZXFIZWFkZXJzKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVzaW5nIGZvci1pbiBpbnN0ZWFkIG9mIGZvckVhY2ggdG8gYXZvaWQgdW5lY2Vzc2FyeSBpdGVyYXRpb24gYWZ0ZXIgaGVhZGVyIGhhcyBiZWVuIGZvdW5kCiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRIZWFkZXJzSXRlcmF0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChkZWZIZWFkZXJOYW1lIGluIGRlZkhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb3dlcmNhc2VEZWZIZWFkZXJOYW1lID0gbG93ZXJjYXNlKGRlZkhlYWRlck5hbWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHJlcUhlYWRlck5hbWUgaW4gcmVxSGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobG93ZXJjYXNlKHJlcUhlYWRlck5hbWUpID09PSBsb3dlcmNhc2VEZWZIZWFkZXJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBkZWZhdWx0SGVhZGVyc0l0ZXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxSGVhZGVyc1tkZWZIZWFkZXJOYW1lXSA9IGRlZkhlYWRlcnNbZGVmSGVhZGVyTmFtZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVxSGVhZGVyczsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGV4ZWNIZWFkZXJzKGhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoZWFkZXJDb250ZW50OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24gKGhlYWRlckZuLCBoZWFkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihoZWFkZXJGbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyQ29udGVudCA9IGhlYWRlckZuKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoZWFkZXJDb250ZW50ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnNbaGVhZGVyXSA9IGhlYWRlckNvbnRlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJGh0dHAucGVuZGluZ1JlcXVlc3RzID0gW107CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNnZXQKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEdFVGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNkZWxldGUKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYERFTEVURWAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNoZWFkCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBIRUFEYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2pzb25wCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBKU09OUGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgU2hvdWxkIGNvbnRhaW4gYEpTT05fQ0FMTEJBQ0tgIHN0cmluZy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY3JlYXRlU2hvcnRNZXRob2RzKCdnZXQnLCAnZGVsZXRlJywgJ2hlYWQnLCAnanNvbnAnKTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI3Bvc3QKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYFBPU1RgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjcHV0CiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBQVVRgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY3JlYXRlU2hvcnRNZXRob2RzV2l0aERhdGEoJ3Bvc3QnLCAncHV0Jyk7CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2RlZmF1bHRzCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHlPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogUnVudGltZSBlcXVpdmFsZW50IG9mIHRoZSBgJGh0dHBQcm92aWRlci5kZWZhdWx0c2AgcHJvcGVydHkuIEFsbG93cyBjb25maWd1cmF0aW9uIG9mCiAgICAgICAgICAgICAgICAgKiBkZWZhdWx0IGhlYWRlcnMsIHdpdGhDcmVkZW50aWFscyBhcyB3ZWxsIGFzIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWF0aW9ucy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTZWUgIlNldHRpbmcgSFRUUCBIZWFkZXJzIiBhbmQgIlRyYW5zZm9ybWluZyBSZXF1ZXN0cyBhbmQgUmVzcG9uc2VzIiBzZWN0aW9ucyBhYm92ZS4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgJGh0dHAuZGVmYXVsdHMgPSBkZWZhdWx0czsKCgogICAgICAgICAgICAgICAgcmV0dXJuICRodHRwOwoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVTaG9ydE1ldGhvZHMobmFtZXMpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbiAodXJsLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kc1dpdGhEYXRhKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbiAodXJsLCBkYXRhLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBNYWtlcyB0aGUgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAhISEgQUNDRVNTRVMgQ0xPU1VSRSBWQVJTOgogICAgICAgICAgICAgICAgICogJGh0dHBCYWNrZW5kLCBkZWZhdWx0cywgJGxvZywgJHJvb3RTY29wZSwgZGVmYXVsdENhY2hlLCAkaHR0cC5wZW5kaW5nUmVxdWVzdHMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIHJlcUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSwKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlZFJlc3AsCiAgICAgICAgICAgICAgICAgICAgICAgIHVybCA9IGJ1aWxkVXJsKGNvbmZpZy51cmwsIGNvbmZpZy5wYXJhbXMpOwoKICAgICAgICAgICAgICAgICAgICAkaHR0cC5wZW5kaW5nUmVxdWVzdHMucHVzaChjb25maWcpOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKCgogICAgICAgICAgICAgICAgICAgIGlmICgoY29uZmlnLmNhY2hlIHx8IGRlZmF1bHRzLmNhY2hlKSAmJiBjb25maWcuY2FjaGUgIT09IGZhbHNlICYmIGNvbmZpZy5tZXRob2QgPT0gJ0dFVCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUgPSBpc09iamVjdChjb25maWcuY2FjaGUpID8gY29uZmlnLmNhY2hlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogaXNPYmplY3QoZGVmYXVsdHMuY2FjaGUpID8gZGVmYXVsdHMuY2FjaGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBkZWZhdWx0Q2FjaGU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcCA9IGNhY2hlLmdldCh1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGNhY2hlZFJlc3ApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVkUmVzcC50aGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FjaGVkIHJlcXVlc3QgaGFzIGFscmVhZHkgYmVlbiBzZW50LCBidXQgdGhlcmUgaXMgbm8gcmVzcG9uc2UgeWV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcC50aGVuKHJlbW92ZVBlbmRpbmdSZXEsIHJlbW92ZVBlbmRpbmdSZXEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWRSZXNwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXJ2aW5nIGZyb20gY2FjaGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjYWNoZWRSZXNwKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShjYWNoZWRSZXNwWzFdLCBjYWNoZWRSZXNwWzBdLCBjb3B5KGNhY2hlZFJlc3BbMl0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShjYWNoZWRSZXNwLCAyMDAsIHt9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwdXQgdGhlIHByb21pc2UgZm9yIHRoZSBub24tdHJhbnNmb3JtZWQgcmVzcG9uc2UgaW50byBjYWNoZSBhcyBhIHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZS5wdXQodXJsLCBwcm9taXNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgd2Ugd29uJ3QgaGF2ZSB0aGUgcmVzcG9uc2UgaW4gY2FjaGUsIHNlbmQgdGhlIHJlcXVlc3QgdG8gdGhlIGJhY2tlbmQKICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBCYWNrZW5kKGNvbmZpZy5tZXRob2QsIHVybCwgcmVxRGF0YSwgZG9uZSwgcmVxSGVhZGVycywgY29uZmlnLnRpbWVvdXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcud2l0aENyZWRlbnRpYWxzLCBjb25maWcucmVzcG9uc2VUeXBlKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQ2FsbGJhY2sgcmVnaXN0ZXJlZCB0byAkaHR0cEJhY2tlbmQoKToKICAgICAgICAgICAgICAgICAgICAgKiAgLSBjYWNoZXMgdGhlIHJlc3BvbnNlIGlmIGRlc2lyZWQKICAgICAgICAgICAgICAgICAgICAgKiAgLSByZXNvbHZlcyB0aGUgcmF3ICRodHRwIHByb21pc2UKICAgICAgICAgICAgICAgICAgICAgKiAgLSBjYWxscyAkYXBwbHkKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBkb25lKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdWNjZXNzKHN0YXR1cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZS5wdXQodXJsLCBbc3RhdHVzLCByZXNwb25zZSwgcGFyc2VIZWFkZXJzKGhlYWRlcnNTdHJpbmcpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBwcm9taXNlIGZyb20gdGhlIGNhY2hlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUucmVtb3ZlKHVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVQcm9taXNlKHJlc3BvbnNlLCBzdGF0dXMsIGhlYWRlcnNTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISRyb290U2NvcGUuJCRwaGFzZSkgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBSZXNvbHZlcyB0aGUgcmF3ICRodHRwIHByb21pc2UuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZVByb21pc2UocmVzcG9uc2UsIHN0YXR1cywgaGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBub3JtYWxpemUgaW50ZXJuYWwgc3RhdHVzZXMgdG8gMAogICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSBNYXRoLm1heChzdGF0dXMsIDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgKGlzU3VjY2VzcyhzdGF0dXMpID8gZGVmZXJyZWQucmVzb2x2ZSA6IGRlZmVycmVkLnJlamVjdCkoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogcmVzcG9uc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHN0YXR1cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnNHZXR0ZXIoaGVhZGVycyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWc6IGNvbmZpZwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiByZW1vdmVQZW5kaW5nUmVxKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWR4ID0gaW5kZXhPZigkaHR0cC5wZW5kaW5nUmVxdWVzdHMsIGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpZHggIT09IC0xKSAkaHR0cC5wZW5kaW5nUmVxdWVzdHMuc3BsaWNlKGlkeCwgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBidWlsZFVybCh1cmwsIHBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIGlmICghcGFyYW1zKSByZXR1cm4gdXJsOwogICAgICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2hTb3J0ZWQocGFyYW1zLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCB8fCB2YWx1ZSA9PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlKSkgdmFsdWUgPSBbdmFsdWVdOwoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCh2YWx1ZSwgZnVuY3Rpb24gKHYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc09iamVjdCh2KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB0b0pzb24odik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGVuY29kZVVyaVF1ZXJ5KGtleSkgKyAnPScgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGVVcmlRdWVyeSh2KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cmwgKyAoKHVybC5pbmRleE9mKCc/JykgPT0gLTEpID8gJz8nIDogJyYnKSArIHBhcnRzLmpvaW4oJyYnKTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICB9XTsKICAgIH0KCiAgICB2YXIgWEhSID0gd2luZG93LlhNTEh0dHBSZXF1ZXN0IHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICB0cnkgeyByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1zeG1sMi5YTUxIVFRQLjYuMCIpOyB9IGNhdGNoIChlMSkgeyB9CiAgICAgICAgdHJ5IHsgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCJNc3htbDIuWE1MSFRUUC4zLjAiKTsgfSBjYXRjaCAoZTIpIHsgfQogICAgICAgIHRyeSB7IHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTXN4bWwyLlhNTEhUVFAiKTsgfSBjYXRjaCAoZTMpIHsgfQogICAgICAgIHRocm93IG1pbkVycignJGh0dHBCYWNrZW5kJykoJ25veGhyJywgIlRoaXMgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IFhNTEh0dHBSZXF1ZXN0LiIpOwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kaHR0cEJhY2tlbmQKICAgICAqIEByZXF1aXJlcyAkYnJvd3NlcgogICAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgICAqIEByZXF1aXJlcyAkZG9jdW1lbnQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEhUVFAgYmFja2VuZCB1c2VkIGJ5IHRoZSB7QGxpbmsgbmcuJGh0dHAgc2VydmljZX0gdGhhdCBkZWxlZ2F0ZXMgdG8KICAgICAqIFhNTEh0dHBSZXF1ZXN0IG9iamVjdCBvciBKU09OUCBhbmQgZGVhbHMgd2l0aCBicm93c2VyIGluY29tcGF0aWJpbGl0aWVzLgogICAgICoKICAgICAqIFlvdSBzaG91bGQgbmV2ZXIgbmVlZCB0byB1c2UgdGhpcyBzZXJ2aWNlIGRpcmVjdGx5LCBpbnN0ZWFkIHVzZSB0aGUgaGlnaGVyLWxldmVsIGFic3RyYWN0aW9uczoKICAgICAqIHtAbGluayBuZy4kaHR0cCAkaHR0cH0gb3Ige0BsaW5rIG5nUmVzb3VyY2UuJHJlc291cmNlICRyZXNvdXJjZX0uCiAgICAgKgogICAgICogRHVyaW5nIHRlc3RpbmcgdGhpcyBpbXBsZW1lbnRhdGlvbiBpcyBzd2FwcGVkIHdpdGgge0BsaW5rIG5nTW9jay4kaHR0cEJhY2tlbmQgbW9jawogICAgICogJGh0dHBCYWNrZW5kfSB3aGljaCBjYW4gYmUgdHJhaW5lZCB3aXRoIHJlc3BvbnNlcy4KICAgICAqLwogICAgZnVuY3Rpb24gJEh0dHBCYWNrZW5kUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckYnJvd3NlcicsICckd2luZG93JywgJyRkb2N1bWVudCcsIGZ1bmN0aW9uICgkYnJvd3NlciwgJHdpbmRvdywgJGRvY3VtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVIdHRwQmFja2VuZCgkYnJvd3NlciwgWEhSLCAkYnJvd3Nlci5kZWZlciwgJHdpbmRvdy5hbmd1bGFyLmNhbGxiYWNrcywKICAgICAgICAgICAgICAgICRkb2N1bWVudFswXSwgJHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbC5yZXBsYWNlKCc6JywgJycpKTsKICAgICAgICB9XTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVIdHRwQmFja2VuZCgkYnJvd3NlciwgWEhSLCAkYnJvd3NlckRlZmVyLCBjYWxsYmFja3MsIHJhd0RvY3VtZW50LCBsb2NhdGlvblByb3RvY29sKSB7CiAgICAgICAgLy8gVE9ETyh2b2p0YSk6IGZpeCB0aGUgc2lnbmF0dXJlCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChtZXRob2QsIHVybCwgcG9zdCwgY2FsbGJhY2ssIGhlYWRlcnMsIHRpbWVvdXQsIHdpdGhDcmVkZW50aWFscywgcmVzcG9uc2VUeXBlKSB7CiAgICAgICAgICAgIHZhciBzdGF0dXM7CiAgICAgICAgICAgICRicm93c2VyLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQoKTsKICAgICAgICAgICAgdXJsID0gdXJsIHx8ICRicm93c2VyLnVybCgpOwoKICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShtZXRob2QpID09ICdqc29ucCcpIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja0lkID0gJ18nICsgKGNhbGxiYWNrcy5jb3VudGVyKyspLnRvU3RyaW5nKDM2KTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEgPSBkYXRhOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB2YXIganNvbnBEb25lID0ganNvbnBSZXEodXJsLnJlcGxhY2UoJ0pTT05fQ0FMTEJBQ0snLCAnYW5ndWxhci5jYWxsYmFja3MuJyArIGNhbGxiYWNrSWQpLAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc1tjYWxsYmFja0lkXS5kYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIDIwMCwgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLCBzdGF0dXMgfHwgLTIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsYmFja3NbY2FsbGJhY2tJZF07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgeGhyID0gbmV3IFhIUigpOwogICAgICAgICAgICAgICAgeGhyLm9wZW4obWV0aG9kLCB1cmwsIHRydWUpOwogICAgICAgICAgICAgICAgZm9yRWFjaChoZWFkZXJzLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgeGhyLnNldFJlcXVlc3RIZWFkZXIoa2V5LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyBJbiBJRTYgYW5kIDcsIHRoaXMgbWlnaHQgYmUgY2FsbGVkIHN5bmNocm9ub3VzbHkgd2hlbiB4aHIuc2VuZCBiZWxvdyBpcyBjYWxsZWQgYW5kIHRoZQogICAgICAgICAgICAgICAgLy8gcmVzcG9uc2UgaXMgaW4gdGhlIGNhY2hlLiB0aGUgcHJvbWlzZSBhcGkgd2lsbCBlbnN1cmUgdGhhdCB0byB0aGUgYXBwIGNvZGUgdGhlIGFwaSBpcwogICAgICAgICAgICAgICAgLy8gYWx3YXlzIGFzeW5jCiAgICAgICAgICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNwb25zZUhlYWRlcnMgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogcmVtb3ZlIG9uY2UgRmlyZWZveCAyMSBnZXRzIHJlbGVhc2VkLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBiZWdpbjogd29ya2Fyb3VuZCB0byBvdmVyY29tZSBGaXJlZm94IENPUlMgaHR0cCByZXNwb25zZSBoZWFkZXJzIGJ1ZwogICAgICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02MDg3MzUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmlyZWZveCBhbHJlYWR5IHBhdGNoZWQgaW4gbmlnaHRseS4gU2hvdWxkIGxhbmQgaW4gRmlyZWZveCAyMS4KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENPUlMgInNpbXBsZSByZXNwb25zZSBoZWFkZXJzIiBodHRwOi8vd3d3LnczLm9yZy9UUi9jb3JzLwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaW1wbGVIZWFkZXJzID0gWyJDYWNoZS1Db250cm9sIiwgIkNvbnRlbnQtTGFuZ3VhZ2UiLCAiQ29udGVudC1UeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkV4cGlyZXMiLCAiTGFzdC1Nb2RpZmllZCIsICJQcmFnbWEiXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChzaW1wbGVIZWFkZXJzLCBmdW5jdGlvbiAoaGVhZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0geGhyLmdldFJlc3BvbnNlSGVhZGVyKGhlYWRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyArPSBoZWFkZXIgKyAiOiAiICsgdmFsdWUgKyAiXG4iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVuZCBvZiB0aGUgd29ya2Fyb3VuZC4KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlc3BvbnNlVGV4dCBpcyB0aGUgb2xkLXNjaG9vbCB3YXkgb2YgcmV0cmlldmluZyByZXNwb25zZSAoc3VwcG9ydGVkIGJ5IElFOCAmIDkpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlc3BvbnNlIGFuZCByZXNwb25zZVR5cGUgcHJvcGVydGllcyB3ZXJlIGludHJvZHVjZWQgaW4gWEhSIExldmVsMiBzcGVjIChzdXBwb3J0ZWQgYnkgSUUxMCkKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzIHx8IHhoci5zdGF0dXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoeGhyLnJlc3BvbnNlVHlwZSA/IHhoci5yZXNwb25zZSA6IHhoci5yZXNwb25zZVRleHQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGlmICh3aXRoQ3JlZGVudGlhbHMpIHsKICAgICAgICAgICAgICAgICAgICB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2VUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9IHJlc3BvbnNlVHlwZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB4aHIuc2VuZChwb3N0IHx8ICcnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRpbWVvdXQgPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZW91dElkID0gJGJyb3dzZXJEZWZlcih0aW1lb3V0UmVxdWVzdCwgdGltZW91dCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGltZW91dCAmJiB0aW1lb3V0LnRoZW4pIHsKICAgICAgICAgICAgICAgIHRpbWVvdXQudGhlbih0aW1lb3V0UmVxdWVzdCk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBmdW5jdGlvbiB0aW1lb3V0UmVxdWVzdCgpIHsKICAgICAgICAgICAgICAgIHN0YXR1cyA9IC0xOwogICAgICAgICAgICAgICAganNvbnBEb25lICYmIGpzb25wRG9uZSgpOwogICAgICAgICAgICAgICAgeGhyICYmIHhoci5hYm9ydCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFVSTF9NQVRDSCBpcyBkZWZpbmVkIGluIHNyYy9zZXJ2aWNlL2xvY2F0aW9uLmpzCiAgICAgICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSAodXJsLm1hdGNoKFNFUlZFUl9NQVRDSCkgfHwgWycnLCBsb2NhdGlvblByb3RvY29sXSlbMV07CgogICAgICAgICAgICAgICAgLy8gY2FuY2VsIHRpbWVvdXQgYW5kIHN1YnNlcXVlbnQgdGltZW91dCBwcm9taXNlIHJlc29sdXRpb24KICAgICAgICAgICAgICAgIHRpbWVvdXRJZCAmJiAkYnJvd3NlckRlZmVyLmNhbmNlbCh0aW1lb3V0SWQpOwogICAgICAgICAgICAgICAganNvbnBEb25lID0geGhyID0gbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBmaXggc3RhdHVzIGNvZGUgZm9yIGZpbGUgcHJvdG9jb2wgKGl0J3MgYWx3YXlzIDApCiAgICAgICAgICAgICAgICBzdGF0dXMgPSAocHJvdG9jb2wgPT0gJ2ZpbGUnKSA/IChyZXNwb25zZSA/IDIwMCA6IDQwNCkgOiBzdGF0dXM7CgogICAgICAgICAgICAgICAgLy8gbm9ybWFsaXplIElFIGJ1ZyAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTQ1MCkKICAgICAgICAgICAgICAgIHN0YXR1cyA9IHN0YXR1cyA9PSAxMjIzID8gMjA0IDogc3RhdHVzOwoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpOwogICAgICAgICAgICAgICAgJGJyb3dzZXIuJCRjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGpzb25wUmVxKHVybCwgZG9uZSkgewogICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UgalF1ZXJ5L2pxTGl0ZSBoZXJlIGJlY2F1c2UgalF1ZXJ5IGRvZXMgY3Jhenkgc2hpdCB3aXRoIHNjcmlwdCBlbGVtZW50cywgZS5nLjoKICAgICAgICAgICAgLy8gLSBmZXRjaGVzIGxvY2FsIHNjcmlwdHMgdmlhIFhIUiBhbmQgZXZhbHMgdGhlbQogICAgICAgICAgICAvLyAtIGFkZHMgYW5kIGltbWVkaWF0ZWx5IHJlbW92ZXMgc2NyaXB0IGVsZW1lbnRzIGZyb20gdGhlIGRvY3VtZW50CiAgICAgICAgICAgIHZhciBzY3JpcHQgPSByYXdEb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgIGRvbmVXcmFwcGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJhd0RvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9uZSkgZG9uZSgpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7CiAgICAgICAgICAgIHNjcmlwdC5zcmMgPSB1cmw7CgogICAgICAgICAgICBpZiAobXNpZSkgewogICAgICAgICAgICAgICAgc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoL2xvYWRlZHxjb21wbGV0ZS8udGVzdChzY3JpcHQucmVhZHlTdGF0ZSkpIGRvbmVXcmFwcGVyKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbmVycm9yID0gZG9uZVdyYXBwZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJhd0RvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgICAgICAgICAgcmV0dXJuIGRvbmVXcmFwcGVyOwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgJGludGVycG9sYXRlTWluRXJyID0gbWluRXJyKCckaW50ZXJwb2xhdGUnKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBVc2VkIGZvciBjb25maWd1cmluZyB0aGUgaW50ZXJwb2xhdGlvbiBtYXJrdXAuIERlZmF1bHRzIHRvIGB7e2AgYW5kIGB9fWAuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZSBtb2R1bGU9ImN1c3RvbUludGVycG9sYXRpb25BcHAiPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgIHZhciBjdXN0b21JbnRlcnBvbGF0aW9uQXBwID0gYW5ndWxhci5tb2R1bGUoJ2N1c3RvbUludGVycG9sYXRpb25BcHAnLCBbXSk7CiAgICAKICAgICAgICAgICAgY3VzdG9tSW50ZXJwb2xhdGlvbkFwcC5jb25maWcoZnVuY3Rpb24oJGludGVycG9sYXRlUHJvdmlkZXIpIHsKICAgICAgICAgICAgICAkaW50ZXJwb2xhdGVQcm92aWRlci5zdGFydFN5bWJvbCgnLy8nKTsKICAgICAgICAgICAgICAkaW50ZXJwb2xhdGVQcm92aWRlci5lbmRTeW1ib2woJy8vJyk7CiAgICAgICAgICAgIH0pOwogICAgCiAgICAKICAgICAgICAgICAgY3VzdG9tSW50ZXJwb2xhdGlvbkFwcC5jb250cm9sbGVyKCdEZW1vQ29udHJvbGxlcicsIGZ1bmN0aW9uIERlbW9Db250cm9sbGVyKCkgewogICAgICAgICAgICAgICAgdGhpcy5sYWJlbCA9ICJUaGlzIGJpbmRpbmdzIGlzIGJyb3VnaHQgeW91IHlvdSBieSAvLyBpbnRlcnBvbGF0aW9uIHN5bWJvbHMuIjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgIDxkaXYgbmctYXBwPSJBcHAiIG5nLWNvbnRyb2xsZXI9IkRlbW9Db250cm9sbGVyIGFzIGRlbW8iPgogICAgICAgICAgICAgIC8vZGVtby5sYWJlbC8vCiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgIGl0KCdzaG91bGQgaW50ZXJwb2xhdGUgYmluZGluZyB3aXRoIGN1c3RvbSBzeW1ib2xzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGVtby5sYWJlbCcpKS50b0JlKCdUaGlzIGJpbmRpbmdzIGlzIGJyb3VnaHQgeW91IHlvdSBieSAvLyBpbnRlcnBvbGF0aW9uIHN5bWJvbHMuJyk7CiAgICAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiAkSW50ZXJwb2xhdGVQcm92aWRlcigpIHsKICAgICAgICB2YXIgc3RhcnRTeW1ib2wgPSAne3snOwogICAgICAgIHZhciBlbmRTeW1ib2wgPSAnfX0nOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGludGVycG9sYXRlUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIG5ldyB2YWx1ZSB0byBzZXQgdGhlIHN0YXJ0aW5nIHN5bWJvbCB0by4KICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAgICAgICAqLwogICAgICAgIHRoaXMuc3RhcnRTeW1ib2wgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBzdGFydFN5bWJvbCA9IHZhbHVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RhcnRTeW1ib2w7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjZW5kU3ltYm9sCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgZW5kIG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB9fWAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIG5ldyB2YWx1ZSB0byBzZXQgdGhlIGVuZGluZyBzeW1ib2wgdG8uCiAgICAgICAgICogQHJldHVybnMge3N0cmluZ3xzZWxmfSBSZXR1cm5zIHRoZSBzeW1ib2wgd2hlbiB1c2VkIGFzIGdldHRlciBhbmQgc2VsZiBpZiB1c2VkIGFzIHNldHRlci4KICAgICAgICAgKi8KICAgICAgICB0aGlzLmVuZFN5bWJvbCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGVuZFN5bWJvbCA9IHZhbHVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZW5kU3ltYm9sOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCgogICAgICAgIHRoaXMuJGdldCA9IFsnJHBhcnNlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRzY2UnLCBmdW5jdGlvbiAoJHBhcnNlLCAkZXhjZXB0aW9uSGFuZGxlciwgJHNjZSkgewogICAgICAgICAgICB2YXIgc3RhcnRTeW1ib2xMZW5ndGggPSBzdGFydFN5bWJvbC5sZW5ndGgsCiAgICAgICAgICAgICAgICBlbmRTeW1ib2xMZW5ndGggPSBlbmRTeW1ib2wubGVuZ3RoOwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGUKICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXF1aXJlcyAkcGFyc2UKICAgICAgICAgICAgICogQHJlcXVpcmVzICRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIENvbXBpbGVzIGEgc3RyaW5nIHdpdGggbWFya3VwIGludG8gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4gVGhpcyBzZXJ2aWNlIGlzIHVzZWQgYnkgdGhlCiAgICAgICAgICAgICAqIEhUTUwge0BsaW5rIG5nLiRjb21waWxlICRjb21waWxlfSBzZXJ2aWNlIGZvciBkYXRhIGJpbmRpbmcuIFNlZQogICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGludGVycG9sYXRlUHJvdmlkZXIgJGludGVycG9sYXRlUHJvdmlkZXJ9IGZvciBjb25maWd1cmluZyB0aGUKICAgICAgICAgICAgICogaW50ZXJwb2xhdGlvbiBtYXJrdXAuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgIDxwcmU+CiAgICAgICAgICAgICAgICAgdmFyICRpbnRlcnBvbGF0ZSA9IC4uLjsgLy8gaW5qZWN0ZWQKICAgICAgICAgICAgICAgICB2YXIgZXhwID0gJGludGVycG9sYXRlKCdIZWxsbyB7e25hbWV9fSEnKTsKICAgICAgICAgICAgICAgICBleHBlY3QoZXhwKHtuYW1lOidBbmd1bGFyJ30pLnRvRXF1YWwoJ0hlbGxvIEFuZ3VsYXIhJyk7CiAgICAgICAgICAgICAgIDwvcHJlPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBUaGUgdGV4dCB3aXRoIG1hcmt1cCB0byBpbnRlcnBvbGF0ZS4KICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gbXVzdEhhdmVFeHByZXNzaW9uIGlmIHNldCB0byB0cnVlIHRoZW4gdGhlIGludGVycG9sYXRpb24gc3RyaW5nIG11c3QgaGF2ZQogICAgICAgICAgICAgKiAgICBlbWJlZGRlZCBleHByZXNzaW9uIGluIG9yZGVyIHRvIHJldHVybiBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLiBTdHJpbmdzIHdpdGggbm8KICAgICAgICAgICAgICogICAgZW1iZWRkZWQgZXhwcmVzc2lvbiB3aWxsIHJldHVybiBudWxsIGZvciB0aGUgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4KICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSB0cnVzdGVkQ29udGV4dCB3aGVuIHByb3ZpZGVkLCB0aGUgcmV0dXJuZWQgZnVuY3Rpb24gcGFzc2VzIHRoZSBpbnRlcnBvbGF0ZWQKICAgICAgICAgICAgICogICAgcmVzdWx0IHRocm91Z2gge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWQoaW50ZXJwb2xhdGVkUmVzdWx0LAogICAgICAgICAgICAgKiAgICB0cnVzdGVkQ29udGV4dCl9IGJlZm9yZSByZXR1cm5pbmcgaXQuICBSZWZlciB0byB0aGUge0BsaW5rIG5nLiRzY2UgJHNjZX0gc2VydmljZSB0aGF0CiAgICAgICAgICAgICAqICAgIHByb3ZpZGVzIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIGZvciBkZXRhaWxzLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCl9IGFuIGludGVycG9sYXRpb24gZnVuY3Rpb24gd2hpY2ggaXMgdXNlZCB0byBjb21wdXRlIHRoZSBpbnRlcnBvbGF0ZWQKICAgICAgICAgICAgICogICAgc3RyaW5nLiBUaGUgZnVuY3Rpb24gaGFzIHRoZXNlIHBhcmFtZXRlcnM6CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAgICogYGNvbnRleHRgOiBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MgYXJlIGV2YWx1YXRlZAogICAgICAgICAgICAgKiAgICAgIGFnYWluc3QuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiAkaW50ZXJwb2xhdGUodGV4dCwgbXVzdEhhdmVFeHByZXNzaW9uLCB0cnVzdGVkQ29udGV4dCkgewogICAgICAgICAgICAgICAgdmFyIHN0YXJ0SW5kZXgsCiAgICAgICAgICAgICAgICAgICAgZW5kSW5kZXgsCiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSAwLAogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gW10sCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gdGV4dC5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGZuLAogICAgICAgICAgICAgICAgICAgIGV4cCwKICAgICAgICAgICAgICAgICAgICBjb25jYXQgPSBbXTsKCiAgICAgICAgICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKChzdGFydEluZGV4ID0gdGV4dC5pbmRleE9mKHN0YXJ0U3ltYm9sLCBpbmRleCkpICE9IC0xKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgKChlbmRJbmRleCA9IHRleHQuaW5kZXhPZihlbmRTeW1ib2wsIHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCkpICE9IC0xKSkgewogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gc3RhcnRJbmRleCkgJiYgcGFydHMucHVzaCh0ZXh0LnN1YnN0cmluZyhpbmRleCwgc3RhcnRJbmRleCkpOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGZuID0gJHBhcnNlKGV4cCA9IHRleHQuc3Vic3RyaW5nKHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCwgZW5kSW5kZXgpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuLmV4cCA9IGV4cDsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBlbmRJbmRleCArIGVuZFN5bWJvbExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgZGlkIG5vdCBmaW5kIGFueXRoaW5nLCBzbyB3ZSBoYXZlIHRvIGFkZCB0aGUgcmVtYWluZGVyIHRvIHRoZSBwYXJ0cyBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gbGVuZ3RoKSAmJiBwYXJ0cy5wdXNoKHRleHQuc3Vic3RyaW5nKGluZGV4KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIShsZW5ndGggPSBwYXJ0cy5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYWRkZWQsIG5vdGhpbmcsIG11c3QgaGF2ZSBiZWVuIGFuIGVtcHR5IHN0cmluZy4KICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKCcnKTsKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSAxOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvbmNhdGVuYXRpbmcgZXhwcmVzc2lvbnMgbWFrZXMgaXQgaGFyZCB0byByZWFzb24gYWJvdXQgd2hldGhlciBzb21lIGNvbWJpbmF0aW9uIG9mIGNvbmNhdGVuYXRlZAogICAgICAgICAgICAgICAgLy8gdmFsdWVzIGFyZSB1bnNhZmUgdG8gdXNlIGFuZCBjb3VsZCBlYXNpbHkgbGVhZCB0byBYU1MuICBCeSByZXF1aXJpbmcgdGhhdCBhIHNpbmdsZQogICAgICAgICAgICAgICAgLy8gZXhwcmVzc2lvbiBiZSB1c2VkIGZvciBpZnJhbWVbc3JjXSwgb2JqZWN0W3NyY10sIGV0Yy4sIHdlIGVuc3VyZSB0aGF0IHRoZSB2YWx1ZSB0aGF0J3MgdXNlZAogICAgICAgICAgICAgICAgLy8gaXMgYXNzaWduZWQgb3IgY29uc3RydWN0ZWQgYnkgc29tZSBKUyBjb2RlIHNvbWV3aGVyZSB0aGF0IGlzIG1vcmUgdGVzdGFibGUgb3IgbWFrZSBpdAogICAgICAgICAgICAgICAgLy8gb2J2aW91cyB0aGF0IHlvdSBib3VuZCB0aGUgdmFsdWUgdG8gc29tZSB1c2VyIGNvbnRyb2xsZWQgdmFsdWUuICBUaGlzIGhlbHBzIHJlZHVjZSB0aGUgbG9hZAogICAgICAgICAgICAgICAgLy8gd2hlbiBhdWRpdGluZyBmb3IgWFNTIGlzc3Vlcy4KICAgICAgICAgICAgICAgIGlmICh0cnVzdGVkQ29udGV4dCAmJiBwYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGludGVycG9sYXRlTWluRXJyKCdub2NvbmNhdCcsCiAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBpbnRlcnBvbGF0aW5nOiB7MH1cblN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIGRpc2FsbG93cyAiICsKICAgICAgICAgICAgICAgICAgICAgICAgImludGVycG9sYXRpb25zIHRoYXQgY29uY2F0ZW5hdGUgbXVsdGlwbGUgZXhwcmVzc2lvbnMgd2hlbiBhIHRydXN0ZWQgdmFsdWUgaXMgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZC4gIFNlZSBodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy4kc2NlIiwgdGV4dCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFtdXN0SGF2ZUV4cHJlc3Npb24gfHwgaGFzSW50ZXJwb2xhdGlvbikgewogICAgICAgICAgICAgICAgICAgIGNvbmNhdC5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm4gPSBmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gbGVuZ3RoLCBwYXJ0OyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgKHBhcnQgPSBwYXJ0c1tpXSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gcGFydChjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRydXN0ZWRDb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gJHNjZS5nZXRUcnVzdGVkKHRydXN0ZWRDb250ZXh0LCBwYXJ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSAkc2NlLnZhbHVlT2YocGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnQgPT0gbnVsbCB8fCBwYXJ0ID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwYXJ0ICE9ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gdG9Kc29uKHBhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmNhdFtpXSA9IHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29uY2F0LmpvaW4oJycpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdFcnIgPSAkaW50ZXJwb2xhdGVNaW5FcnIoJ2ludGVycicsICJDYW4ndCBpbnRlcnBvbGF0ZTogezB9XG57MX0iLCB0ZXh0LCBlcnIudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihuZXdFcnIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBmbi5leHAgPSB0ZXh0OwogICAgICAgICAgICAgICAgICAgIGZuLnBhcnRzID0gcGFydHM7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlI3N0YXJ0U3ltYm9sCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaW50ZXJwb2xhdGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFVzZSB7QGxpbmsgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2wgJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2x9IHRvIGNoYW5nZQogICAgICAgICAgICAgKiB0aGUgc3ltYm9sLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBzdGFydCBzeW1ib2wuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2wgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RhcnRTeW1ib2w7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGUjZW5kU3ltYm9sCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaW50ZXJwb2xhdGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIGVuZCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBgfX1gLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI2VuZFN5bWJvbCAkaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2x9IHRvIGNoYW5nZQogICAgICAgICAgICAgKiB0aGUgc3ltYm9sLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBzdGFydCBzeW1ib2wuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVuZFN5bWJvbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuICRpbnRlcnBvbGF0ZTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2NhbGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqICRsb2NhbGUgc2VydmljZSBwcm92aWRlcyBsb2NhbGl6YXRpb24gcnVsZXMgZm9yIHZhcmlvdXMgQW5ndWxhciBjb21wb25lbnRzLiBBcyBvZiByaWdodCBub3cgdGhlCiAgICAgKiBvbmx5IHB1YmxpYyBhcGkgaXM6CiAgICAgKgogICAgICogKiBgaWRgIOKAkyBge3N0cmluZ31gIOKAkyBsb2NhbGUgaWQgZm9ybWF0dGVkIGFzIGBsYW5ndWFnZUlkLWNvdW50cnlJZGAgKGUuZy4gYGVuLXVzYCkKICAgICAqLwogICAgZnVuY3Rpb24gJExvY2FsZVByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGlkOiAnZW4tdXMnLAoKICAgICAgICAgICAgICAgIE5VTUJFUl9GT1JNQVRTOiB7CiAgICAgICAgICAgICAgICAgICAgREVDSU1BTF9TRVA6ICcuJywKICAgICAgICAgICAgICAgICAgICBHUk9VUF9TRVA6ICcsJywKICAgICAgICAgICAgICAgICAgICBQQVRURVJOUzogWwogICAgICAgICAgICAgICAgICAgICAgeyAvLyBEZWNpbWFsIFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5JbnQ6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbWluRnJhYzogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhGcmFjOiAzLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBvc1ByZTogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdQcmU6ICctJywKICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdTdWY6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgIGdTaXplOiAzLAogICAgICAgICAgICAgICAgICAgICAgICAgIGxnU2l6ZTogMwogICAgICAgICAgICAgICAgICAgICAgfSwgeyAvL0N1cnJlbmN5IFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5JbnQ6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbWluRnJhYzogMiwKICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhGcmFjOiAyLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBvc1ByZTogJ1x1MDBBNCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdQcmU6ICcoXHUwMEE0JywKICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdTdWY6ICcpJywKICAgICAgICAgICAgICAgICAgICAgICAgICBnU2l6ZTogMywKICAgICAgICAgICAgICAgICAgICAgICAgICBsZ1NpemU6IDMKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgIENVUlJFTkNZX1NZTTogJyQnCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIERBVEVUSU1FX0ZPUk1BVFM6IHsKICAgICAgICAgICAgICAgICAgICBNT05USDogJ0phbnVhcnksRmVicnVhcnksTWFyY2gsQXByaWwsTWF5LEp1bmUsSnVseSxBdWd1c3QsU2VwdGVtYmVyLE9jdG9iZXIsTm92ZW1iZXIsRGVjZW1iZXInCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc3BsaXQoJywnKSwKICAgICAgICAgICAgICAgICAgICBTSE9SVE1PTlRIOiAnSmFuLEZlYixNYXIsQXByLE1heSxKdW4sSnVsLEF1ZyxTZXAsT2N0LE5vdixEZWMnLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgREFZOiAnU3VuZGF5LE1vbmRheSxUdWVzZGF5LFdlZG5lc2RheSxUaHVyc2RheSxGcmlkYXksU2F0dXJkYXknLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgU0hPUlREQVk6ICdTdW4sTW9uLFR1ZSxXZWQsVGh1LEZyaSxTYXQnLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgQU1QTVM6IFsnQU0nLCAnUE0nXSwKICAgICAgICAgICAgICAgICAgICBtZWRpdW06ICdNTU0gZCwgeSBoOm1tOnNzIGEnLAogICAgICAgICAgICAgICAgICAgIHNob3J0OiAnTS9kL3l5IGg6bW0gYScsCiAgICAgICAgICAgICAgICAgICAgZnVsbERhdGU6ICdFRUVFLCBNTU1NIGQsIHknLAogICAgICAgICAgICAgICAgICAgIGxvbmdEYXRlOiAnTU1NTSBkLCB5JywKICAgICAgICAgICAgICAgICAgICBtZWRpdW1EYXRlOiAnTU1NIGQsIHknLAogICAgICAgICAgICAgICAgICAgIHNob3J0RGF0ZTogJ00vZC95eScsCiAgICAgICAgICAgICAgICAgICAgbWVkaXVtVGltZTogJ2g6bW06c3MgYScsCiAgICAgICAgICAgICAgICAgICAgc2hvcnRUaW1lOiAnaDptbSBhJwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBwbHVyYWxDYXQ6IGZ1bmN0aW9uIChudW0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAobnVtID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnb25lJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0KCiAgICB2YXIgU0VSVkVSX01BVENIID0gL14oW146XSspOlwvXC8oXHcrOnswLDF9XHcqQCk/KFx7P1tcd1wuLV0qXH0/KSg6KFswLTldKykpPyhcL1teXD8jXSopPyhcPyhbXiNdKikpPygjKC4qKSk/JC8sCiAgICAgICAgUEFUSF9NQVRDSCA9IC9eKFteXD8jXSopKFw/KFteI10qKSk/KCMoLiopKT8kLywKICAgICAgICBERUZBVUxUX1BPUlRTID0geyAnaHR0cCc6IDgwLCAnaHR0cHMnOiA0NDMsICdmdHAnOiAyMSB9OwogICAgdmFyICRsb2NhdGlvbk1pbkVyciA9IG1pbkVycignJGxvY2F0aW9uJyk7CgoKICAgIC8qKgogICAgICogRW5jb2RlIHBhdGggdXNpbmcgZW5jb2RlVXJpU2VnbWVudCwgaWdub3JpbmcgZm9yd2FyZCBzbGFzaGVzCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggUGF0aCB0byBlbmNvZGUKICAgICAqIEByZXR1cm5zIHtzdHJpbmd9CiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZVBhdGgocGF0aCkgewogICAgICAgIHZhciBzZWdtZW50cyA9IHBhdGguc3BsaXQoJy8nKSwKICAgICAgICAgICAgaSA9IHNlZ21lbnRzLmxlbmd0aDsKCiAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICBzZWdtZW50c1tpXSA9IGVuY29kZVVyaVNlZ21lbnQoc2VnbWVudHNbaV0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNlZ21lbnRzLmpvaW4oJy8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYXRjaFVybCh1cmwsIG9iaikgewogICAgICAgIHZhciBtYXRjaCA9IFNFUlZFUl9NQVRDSC5leGVjKHVybCk7CgogICAgICAgIG9iai4kJHByb3RvY29sID0gbWF0Y2hbMV07CiAgICAgICAgb2JqLiQkaG9zdCA9IG1hdGNoWzNdOwogICAgICAgIG9iai4kJHBvcnQgPSBpbnQobWF0Y2hbNV0pIHx8IERFRkFVTFRfUE9SVFNbbWF0Y2hbMV1dIHx8IG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gbWF0Y2hBcHBVcmwodXJsLCBvYmopIHsKICAgICAgICB2YXIgbWF0Y2ggPSBQQVRIX01BVENILmV4ZWModXJsKTsKCiAgICAgICAgb2JqLiQkcGF0aCA9IGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsxXSk7CiAgICAgICAgb2JqLiQkc2VhcmNoID0gcGFyc2VLZXlWYWx1ZShtYXRjaFszXSk7CiAgICAgICAgb2JqLiQkaGFzaCA9IGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFs1XSB8fCAnJyk7CgogICAgICAgIC8vIG1ha2Ugc3VyZSBwYXRoIHN0YXJ0cyB3aXRoICcvJzsKICAgICAgICBpZiAob2JqLiQkcGF0aCAmJiBvYmouJCRwYXRoLmNoYXJBdCgwKSAhPSAnLycpIG9iai4kJHBhdGggPSAnLycgKyBvYmouJCRwYXRoOwogICAgfQoKCiAgICBmdW5jdGlvbiBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChwcm90b2NvbCwgaG9zdCwgcG9ydCkgewogICAgICAgIHJldHVybiBwcm90b2NvbCArICc6Ly8nICsgaG9zdCArIChwb3J0ID09IERFRkFVTFRfUE9SVFNbcHJvdG9jb2xdID8gJycgOiAnOicgKyBwb3J0KTsKICAgIH0KCiAgICAvKioKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYmVnaW4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB3aG9sZQogICAgICogQHBhcmFtIHtzdHJpbmd9IG90aGVyd2lzZQogICAgICogQHJldHVybnMge3N0cmluZ30gcmV0dXJucyB0ZXh0IGZyb20gd2hvbGUgYWZ0ZXIgYmVnaW4gb3Igb3RoZXJ3aXNlIGlmIGl0IGRvZXMgbm90IGJlZ2luIHdpdGggZXhwZWN0ZWQgc3RyaW5nLgogICAgICovCiAgICBmdW5jdGlvbiBiZWdpbnNXaXRoKGJlZ2luLCB3aG9sZSwgb3RoZXJ3aXNlKSB7CiAgICAgICAgcmV0dXJuIHdob2xlLmluZGV4T2YoYmVnaW4pID09IDAgPyB3aG9sZS5zdWJzdHIoYmVnaW4ubGVuZ3RoKSA6IG90aGVyd2lzZTsKICAgIH0KCgogICAgZnVuY3Rpb24gc3RyaXBIYXNoKHVybCkgewogICAgICAgIHZhciBpbmRleCA9IHVybC5pbmRleE9mKCcjJyk7CiAgICAgICAgcmV0dXJuIGluZGV4ID09IC0xID8gdXJsIDogdXJsLnN1YnN0cigwLCBpbmRleCk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHN0cmlwRmlsZSh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnN1YnN0cigwLCBzdHJpcEhhc2godXJsKS5sYXN0SW5kZXhPZignLycpICsgMSk7CiAgICB9CgogICAgLyogcmV0dXJuIHRoZSBzZXJ2ZXIgb25seSAoc2NoZW1lOi8vaG9zdDpwb3J0KSAqLwogICAgZnVuY3Rpb24gc2VydmVyQmFzZSh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnN1YnN0cmluZygwLCB1cmwuaW5kZXhPZignLycsIHVybC5pbmRleE9mKCcvLycpICsgMikpOwogICAgfQoKCiAgICAvKioKICAgICAqIExvY2F0aW9uSHRtbDVVcmwgcmVwcmVzZW50cyBhbiB1cmwKICAgICAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBIVE1MNSBtb2RlIGlzIGVuYWJsZWQgYW5kIHN1cHBvcnRlZAogICAgICoKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEJhc2UgYXBwbGljYXRpb24gYmFzZSBVUkwKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUHJlZml4IHVybCBwYXRoIHByZWZpeAogICAgICovCiAgICBmdW5jdGlvbiBMb2NhdGlvbkh0bWw1VXJsKGFwcEJhc2UsIGJhc2VQcmVmaXgpIHsKICAgICAgICB0aGlzLiQkaHRtbDUgPSB0cnVlOwogICAgICAgIGJhc2VQcmVmaXggPSBiYXNlUHJlZml4IHx8ICcnOwogICAgICAgIHZhciBhcHBCYXNlTm9GaWxlID0gc3RyaXBGaWxlKGFwcEJhc2UpOwogICAgICAgIC8qKgogICAgICAgICAqIFBhcnNlIGdpdmVuIGh0bWw1IChyZWd1bGFyKSB1cmwgc3RyaW5nIGludG8gcHJvcGVydGllcwogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZXdBYnNvbHV0ZVVybCBIVE1MNSB1cmwKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRoaXMuJCRwYXJzZSA9IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgdmFyIHBhcnNlZCA9IHt9CiAgICAgICAgICAgIG1hdGNoVXJsKHVybCwgcGFyc2VkKTsKICAgICAgICAgICAgdmFyIHBhdGhVcmwgPSBiZWdpbnNXaXRoKGFwcEJhc2VOb0ZpbGUsIHVybCk7CiAgICAgICAgICAgIGlmICghaXNTdHJpbmcocGF0aFVybCkpIHsKICAgICAgICAgICAgICAgIHRocm93ICRsb2NhdGlvbk1pbkVycignaXB0aHByZngnLCAnSW52YWxpZCB1cmwgInswfSIsIG1pc3NpbmcgcGF0aCBwcmVmaXggInsxfSIuJywgdXJsLCBhcHBCYXNlTm9GaWxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXRjaEFwcFVybChwYXRoVXJsLCBwYXJzZWQpOwogICAgICAgICAgICBleHRlbmQodGhpcywgcGFyc2VkKTsKICAgICAgICAgICAgaWYgKCF0aGlzLiQkcGF0aCkgewogICAgICAgICAgICAgICAgdGhpcy4kJHBhdGggPSAnLyc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRjb21wb3NlKCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcG9zZSB1cmwgYW5kIHVwZGF0ZSBgYWJzVXJsYCBwcm9wZXJ0eQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGhpcy4kJGNvbXBvc2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgICAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICAgICAgICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgICAgICAgICB0aGlzLiQkYWJzVXJsID0gYXBwQmFzZU5vRmlsZSArIHRoaXMuJCR1cmwuc3Vic3RyKDEpOyAvLyBmaXJzdCBjaGFyIGlzIGFsd2F5cyAnLycKICAgICAgICB9OwoKICAgICAgICB0aGlzLiQkcmV3cml0ZSA9IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgdmFyIGFwcFVybCwgcHJldkFwcFVybDsKCiAgICAgICAgICAgIGlmICgoYXBwVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlLCB1cmwpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBwcmV2QXBwVXJsID0gYXBwVXJsOwogICAgICAgICAgICAgICAgaWYgKChhcHBVcmwgPSBiZWdpbnNXaXRoKGJhc2VQcmVmaXgsIGFwcFVybCkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXBwQmFzZU5vRmlsZSArIChiZWdpbnNXaXRoKCcvJywgYXBwVXJsKSB8fCBhcHBVcmwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXBwQmFzZSArIHByZXZBcHBVcmw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFwcFVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFwcEJhc2VOb0ZpbGUgKyBhcHBVcmw7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXBwQmFzZU5vRmlsZSA9PSB1cmwgKyAnLycpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcHBCYXNlTm9GaWxlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIExvY2F0aW9uSGFzaGJhbmdVcmwgcmVwcmVzZW50cyB1cmwKICAgICAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBkZXZlbG9wZXIgZG9lc24ndCBvcHQgaW50byBodG1sNSBtb2RlLgogICAgICogSXQgYWxzbyBzZXJ2ZXMgYXMgdGhlIGJhc2UgY2xhc3MgZm9yIGh0bWw1IG1vZGUgZmFsbGJhY2sgb24gbGVnYWN5IGJyb3dzZXJzLgogICAgICoKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEJhc2UgYXBwbGljYXRpb24gYmFzZSBVUkwKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoUHJlZml4IGhhc2hiYW5nIHByZWZpeAogICAgICovCiAgICBmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nVXJsKGFwcEJhc2UsIGhhc2hQcmVmaXgpIHsKICAgICAgICB2YXIgYXBwQmFzZU5vRmlsZSA9IHN0cmlwRmlsZShhcHBCYXNlKTsKCiAgICAgICAgbWF0Y2hVcmwoYXBwQmFzZSwgdGhpcyk7CgoKICAgICAgICAvKioKICAgICAgICAgKiBQYXJzZSBnaXZlbiBoYXNoYmFuZyB1cmwgaW50byBwcm9wZXJ0aWVzCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBIYXNoYmFuZyB1cmwKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRoaXMuJCRwYXJzZSA9IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgdmFyIHdpdGhvdXRCYXNlVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlLCB1cmwpIHx8IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKTsKICAgICAgICAgICAgdmFyIHdpdGhvdXRIYXNoVXJsID0gd2l0aG91dEJhc2VVcmwuY2hhckF0KDApID09ICcjJwogICAgICAgICAgICAgICAgPyBiZWdpbnNXaXRoKGhhc2hQcmVmaXgsIHdpdGhvdXRCYXNlVXJsKQogICAgICAgICAgICAgICAgOiAodGhpcy4kJGh0bWw1KQogICAgICAgICAgICAgICAgICA/IHdpdGhvdXRCYXNlVXJsCiAgICAgICAgICAgICAgICAgIDogJyc7CgogICAgICAgICAgICBpZiAoIWlzU3RyaW5nKHdpdGhvdXRIYXNoVXJsKSkgewogICAgICAgICAgICAgICAgdGhyb3cgJGxvY2F0aW9uTWluRXJyKCdpaHNocHJmeCcsICdJbnZhbGlkIHVybCAiezB9IiwgbWlzc2luZyBoYXNoIHByZWZpeCAiezF9Ii4nLCB1cmwsIGhhc2hQcmVmaXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hdGNoQXBwVXJsKHdpdGhvdXRIYXNoVXJsLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy4kJGNvbXBvc2UoKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBDb21wb3NlIGhhc2hiYW5nIHVybCBhbmQgdXBkYXRlIGBhYnNVcmxgIHByb3BlcnR5CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkY29tcG9zZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHNlYXJjaCA9IHRvS2V5VmFsdWUodGhpcy4kJHNlYXJjaCksCiAgICAgICAgICAgICAgICBoYXNoID0gdGhpcy4kJGhhc2ggPyAnIycgKyBlbmNvZGVVcmlTZWdtZW50KHRoaXMuJCRoYXNoKSA6ICcnOwoKICAgICAgICAgICAgdGhpcy4kJHVybCA9IGVuY29kZVBhdGgodGhpcy4kJHBhdGgpICsgKHNlYXJjaCA/ICc/JyArIHNlYXJjaCA6ICcnKSArIGhhc2g7CiAgICAgICAgICAgIHRoaXMuJCRhYnNVcmwgPSBhcHBCYXNlICsgKHRoaXMuJCR1cmwgPyBoYXNoUHJlZml4ICsgdGhpcy4kJHVybCA6ICcnKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiQkcmV3cml0ZSA9IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgaWYgKHN0cmlwSGFzaChhcHBCYXNlKSA9PSBzdHJpcEhhc2godXJsKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVybDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCgogICAgLyoqCiAgICAgKiBMb2NhdGlvbkhhc2hiYW5nVXJsIHJlcHJlc2VudHMgdXJsCiAgICAgKiBUaGlzIG9iamVjdCBpcyBleHBvc2VkIGFzICRsb2NhdGlvbiBzZXJ2aWNlIHdoZW4gaHRtbDUgaGlzdG9yeSBhcGkgaXMgZW5hYmxlZCBidXQgdGhlIGJyb3dzZXIKICAgICAqIGRvZXMgbm90IHN1cHBvcnQgaXQuCiAgICAgKgogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYXBwQmFzZSBhcHBsaWNhdGlvbiBiYXNlIFVSTAogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhc2hQcmVmaXggaGFzaGJhbmcgcHJlZml4CiAgICAgKi8KICAgIGZ1bmN0aW9uIExvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsKGFwcEJhc2UsIGhhc2hQcmVmaXgpIHsKICAgICAgICB0aGlzLiQkaHRtbDUgPSB0cnVlOwogICAgICAgIExvY2F0aW9uSGFzaGJhbmdVcmwuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgdmFyIGFwcEJhc2VOb0ZpbGUgPSBzdHJpcEZpbGUoYXBwQmFzZSk7CgogICAgICAgIHRoaXMuJCRyZXdyaXRlID0gZnVuY3Rpb24gKHVybCkgewogICAgICAgICAgICB2YXIgYXBwVXJsOwoKICAgICAgICAgICAgaWYgKGFwcEJhc2UgPT0gc3RyaXBIYXNoKHVybCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFwcFVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcHBCYXNlICsgaGFzaFByZWZpeCArIGFwcFVybDsKICAgICAgICAgICAgfSBlbHNlIGlmIChhcHBCYXNlTm9GaWxlID09PSB1cmwgKyAnLycpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcHBCYXNlTm9GaWxlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKCiAgICBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybC5wcm90b3R5cGUgPQogICAgICBMb2NhdGlvbkhhc2hiYW5nVXJsLnByb3RvdHlwZSA9CiAgICAgIExvY2F0aW9uSHRtbDVVcmwucHJvdG90eXBlID0gewoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQXJlIHdlIGluIGh0bWw1IG1vZGU/CiAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICovCiAgICAgICAgICAkJGh0bWw1OiBmYWxzZSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEhhcyBhbnkgY2hhbmdlIGJlZW4gcmVwbGFjaW5nID8KICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgKi8KICAgICAgICAgICQkcmVwbGFjZTogZmFsc2UsCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jYWJzVXJsCiAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBSZXR1cm4gZnVsbCB1cmwgcmVwcmVzZW50YXRpb24gd2l0aCBhbGwgc2VnbWVudHMgZW5jb2RlZCBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAgICAgICAgICAgKiB7QGxpbmsgaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMzk4Ni50eHQgUkZDIDM5ODZ9LgogICAgICAgICAgICoKICAgICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gZnVsbCB1cmwKICAgICAgICAgICAqLwogICAgICAgICAgYWJzVXJsOiBsb2NhdGlvbkdldHRlcignJCRhYnNVcmwnKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiN1cmwKICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBSZXR1cm4gdXJsIChlLmcuIGAvcGF0aD9hPWIjaGFzaGApIHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBDaGFuZ2UgcGF0aCwgc2VhcmNoIGFuZCBoYXNoLCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdXJsIE5ldyB1cmwgd2l0aG91dCBiYXNlIHByZWZpeCAoZS5nLiBgL3BhdGg/YT1iI2hhc2hgKQogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXBsYWNlIFRoZSBwYXRoIHRoYXQgd2lsbCBiZSBjaGFuZ2VkCiAgICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHVybAogICAgICAgICAgICovCiAgICAgICAgICB1cmw6IGZ1bmN0aW9uICh1cmwsIHJlcGxhY2UpIHsKICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodXJsKSkKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJCR1cmw7CgogICAgICAgICAgICAgIHZhciBtYXRjaCA9IFBBVEhfTUFUQ0guZXhlYyh1cmwpOwogICAgICAgICAgICAgIGlmIChtYXRjaFsxXSkgdGhpcy5wYXRoKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsxXSkpOwogICAgICAgICAgICAgIGlmIChtYXRjaFsyXSB8fCBtYXRjaFsxXSkgdGhpcy5zZWFyY2gobWF0Y2hbM10gfHwgJycpOwogICAgICAgICAgICAgIHRoaXMuaGFzaChtYXRjaFs1XSB8fCAnJywgcmVwbGFjZSk7CgogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwcm90b2NvbAogICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICAgKgogICAgICAgICAgICogUmV0dXJuIHByb3RvY29sIG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAgICoKICAgICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gcHJvdG9jb2wgb2YgY3VycmVudCB1cmwKICAgICAgICAgICAqLwogICAgICAgICAgcHJvdG9jb2w6IGxvY2F0aW9uR2V0dGVyKCckJHByb3RvY29sJyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jaG9zdAogICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICAgKgogICAgICAgICAgICogUmV0dXJuIGhvc3Qgb2YgY3VycmVudCB1cmwuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBob3N0IG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAgICovCiAgICAgICAgICBob3N0OiBsb2NhdGlvbkdldHRlcignJCRob3N0JyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcG9ydAogICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICAgKgogICAgICAgICAgICogUmV0dXJuIHBvcnQgb2YgY3VycmVudCB1cmwuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybiB7TnVtYmVyfSBwb3J0CiAgICAgICAgICAgKi8KICAgICAgICAgIHBvcnQ6IGxvY2F0aW9uR2V0dGVyKCckJHBvcnQnKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwYXRoCiAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICAgICAgICAgKgogICAgICAgICAgICogUmV0dXJuIHBhdGggb2YgY3VycmVudCB1cmwgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAgICoKICAgICAgICAgICAqIENoYW5nZSBwYXRoIHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICAgKgogICAgICAgICAgICogTm90ZTogUGF0aCBzaG91bGQgYWx3YXlzIGJlZ2luIHdpdGggZm9yd2FyZCBzbGFzaCAoLyksIHRoaXMgbWV0aG9kIHdpbGwgYWRkIHRoZSBmb3J3YXJkIHNsYXNoCiAgICAgICAgICAgKiBpZiBpdCBpcyBtaXNzaW5nLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcGF0aCBOZXcgcGF0aAogICAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBwYXRoCiAgICAgICAgICAgKi8KICAgICAgICAgIHBhdGg6IGxvY2F0aW9uR2V0dGVyU2V0dGVyKCckJHBhdGgnLCBmdW5jdGlvbiAocGF0aCkgewogICAgICAgICAgICAgIHJldHVybiBwYXRoLmNoYXJBdCgwKSA9PSAnLycgPyBwYXRoIDogJy8nICsgcGF0aDsKICAgICAgICAgIH0pLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3NlYXJjaAogICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAgICoKICAgICAgICAgICAqIFJldHVybiBzZWFyY2ggcGFydCAoYXMgb2JqZWN0KSBvZiBjdXJyZW50IHVybCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICAgKgogICAgICAgICAgICogQ2hhbmdlIHNlYXJjaCBwYXJ0IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0LjxzdHJpbmc+fE9iamVjdC48QXJyYXkuPHN0cmluZz4+fSBzZWFyY2ggTmV3IHNlYXJjaCBwYXJhbXMgLSBzdHJpbmcgb3IgaGFzaCBvYmplY3QuIEhhc2ggb2JqZWN0CiAgICAgICAgICAgKiAgICBtYXkgY29udGFpbiBhbiBhcnJheSBvZiB2YWx1ZXMsIHdoaWNoIHdpbGwgYmUgZGVjb2RlZCBhcyBkdXBsaWNhdGVzIGluIHRoZSB1cmwuCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHBhcmFtVmFsdWUgSWYgYHNlYXJjaGAgaXMgYSBzdHJpbmcsIHRoZW4gYHBhcmFtVmFsdWVgIHdpbGwgb3ZlcnJpZGUgb25seSBhCiAgICAgICAgICAgKiAgICBzaW5nbGUgc2VhcmNoIHBhcmFtZXRlci4gSWYgdGhlIHZhbHVlIGlzIGBudWxsYCwgdGhlIHBhcmFtZXRlciB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBzZWFyY2gKICAgICAgICAgICAqLwogICAgICAgICAgc2VhcmNoOiBmdW5jdGlvbiAoc2VhcmNoLCBwYXJhbVZhbHVlKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiQkc2VhcmNoOwogICAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoc2VhcmNoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBwYXJzZUtleVZhbHVlKHNlYXJjaCk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHNlYXJjaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkc2VhcmNoID0gc2VhcmNoOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkbG9jYXRpb25NaW5FcnIoJ2lzcmNoYXJnJywgJ1RoZSBmaXJzdCBhcmd1bWVudCBvZiB0aGUgYCRsb2NhdGlvbiNzZWFyY2goKWAgY2FsbCBtdXN0IGJlIGEgc3RyaW5nIG9yIGFuIG9iamVjdC4nKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtVmFsdWUgPT0gdW5kZWZpbmVkIHx8IHBhcmFtVmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLiQkc2VhcmNoW3NlYXJjaF07CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRzZWFyY2hbc2VhcmNoXSA9IHBhcmFtVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNoYXNoCiAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICAgICAgICAgKgogICAgICAgICAgICogUmV0dXJuIGhhc2ggZnJhZ21lbnQgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAgICoKICAgICAgICAgICAqIENoYW5nZSBoYXNoIGZyYWdtZW50IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBoYXNoIE5ldyBoYXNoIGZyYWdtZW50CiAgICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IGhhc2gKICAgICAgICAgICAqLwogICAgICAgICAgaGFzaDogbG9jYXRpb25HZXR0ZXJTZXR0ZXIoJyQkaGFzaCcsIGlkZW50aXR5KSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNyZXBsYWNlCiAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBJZiBjYWxsZWQsIGFsbCBjaGFuZ2VzIHRvICRsb2NhdGlvbiBkdXJpbmcgY3VycmVudCBgJGRpZ2VzdGAgd2lsbCBiZSByZXBsYWNpbmcgY3VycmVudCBoaXN0b3J5CiAgICAgICAgICAgKiByZWNvcmQsIGluc3RlYWQgb2YgYWRkaW5nIG5ldyBvbmUuCiAgICAgICAgICAgKi8KICAgICAgICAgIHJlcGxhY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB0aGlzLiQkcmVwbGFjZSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgIH07CgogICAgZnVuY3Rpb24gbG9jYXRpb25HZXR0ZXIocHJvcGVydHkpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpc1twcm9wZXJ0eV07CiAgICAgICAgfTsKICAgIH0KCgogICAgZnVuY3Rpb24gbG9jYXRpb25HZXR0ZXJTZXR0ZXIocHJvcGVydHksIHByZXByb2Nlc3MpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1twcm9wZXJ0eV07CgogICAgICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IHByZXByb2Nlc3ModmFsdWUpOwogICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24KICAgICAqCiAgICAgKiBAcmVxdWlyZXMgJGJyb3dzZXIKICAgICAqIEByZXF1aXJlcyAkc25pZmZlcgogICAgICogQHJlcXVpcmVzICRyb290RWxlbWVudAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlICRsb2NhdGlvbiBzZXJ2aWNlIHBhcnNlcyB0aGUgVVJMIGluIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyIChiYXNlZCBvbiB0aGUKICAgICAqIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi93aW5kb3cubG9jYXRpb24gd2luZG93LmxvY2F0aW9ufSkgYW5kIG1ha2VzIHRoZSBVUkwKICAgICAqIGF2YWlsYWJsZSB0byB5b3VyIGFwcGxpY2F0aW9uLiBDaGFuZ2VzIHRvIHRoZSBVUkwgaW4gdGhlIGFkZHJlc3MgYmFyIGFyZSByZWZsZWN0ZWQgaW50bwogICAgICogJGxvY2F0aW9uIHNlcnZpY2UgYW5kIGNoYW5nZXMgdG8gJGxvY2F0aW9uIGFyZSByZWZsZWN0ZWQgaW50byB0aGUgYnJvd3NlciBhZGRyZXNzIGJhci4KICAgICAqCiAgICAgKiAqKlRoZSAkbG9jYXRpb24gc2VydmljZToqKgogICAgICoKICAgICAqIC0gRXhwb3NlcyB0aGUgY3VycmVudCBVUkwgaW4gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIsIHNvIHlvdSBjYW4KICAgICAqICAgLSBXYXRjaCBhbmQgb2JzZXJ2ZSB0aGUgVVJMLgogICAgICogICAtIENoYW5nZSB0aGUgVVJMLgogICAgICogLSBTeW5jaHJvbml6ZXMgdGhlIFVSTCB3aXRoIHRoZSBicm93c2VyIHdoZW4gdGhlIHVzZXIKICAgICAqICAgLSBDaGFuZ2VzIHRoZSBhZGRyZXNzIGJhci4KICAgICAqICAgLSBDbGlja3MgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gKG9yIGNsaWNrcyBhIEhpc3RvcnkgbGluaykuCiAgICAgKiAgIC0gQ2xpY2tzIG9uIGEgbGluay4KICAgICAqIC0gUmVwcmVzZW50cyB0aGUgVVJMIG9iamVjdCBhcyBhIHNldCBvZiBtZXRob2RzIChwcm90b2NvbCwgaG9zdCwgcG9ydCwgcGF0aCwgc2VhcmNoLCBoYXNoKS4KICAgICAqCiAgICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBzZWUge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5zZXJ2aWNlcy4kbG9jYXRpb24gRGV2ZWxvcGVyIEd1aWRlOiBBbmd1bGFyCiAgICAgKiBTZXJ2aWNlczogVXNpbmcgJGxvY2F0aW9ufQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb25Qcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2UgdGhlIGAkbG9jYXRpb25Qcm92aWRlcmAgdG8gY29uZmlndXJlIGhvdyB0aGUgYXBwbGljYXRpb24gZGVlcCBsaW5raW5nIHBhdGhzIGFyZSBzdG9yZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRMb2NhdGlvblByb3ZpZGVyKCkgewogICAgICAgIHZhciBoYXNoUHJlZml4ID0gJycsCiAgICAgICAgICAgIGh0bWw1TW9kZSA9IGZhbHNlOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb25Qcm92aWRlciNoYXNoUHJlZml4CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvblByb3ZpZGVyCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBwcmVmaXggUHJlZml4IGZvciBoYXNoIHBhcnQgKGNvbnRhaW5pbmcgcGF0aCBhbmQgc2VhcmNoKQogICAgICAgICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5oYXNoUHJlZml4ID0gZnVuY3Rpb24gKHByZWZpeCkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHByZWZpeCkpIHsKICAgICAgICAgICAgICAgIGhhc2hQcmVmaXggPSBwcmVmaXg7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBoYXNoUHJlZml4OwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uUHJvdmlkZXIjaHRtbDVNb2RlCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvblByb3ZpZGVyCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBtb2RlIFVzZSBIVE1MNSBzdHJhdGVneSBpZiBhdmFpbGFibGUuCiAgICAgICAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLmh0bWw1TW9kZSA9IGZ1bmN0aW9uIChtb2RlKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQobW9kZSkpIHsKICAgICAgICAgICAgICAgIGh0bWw1TW9kZSA9IG1vZGU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBodG1sNU1vZGU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHNuaWZmZXInLCAnJHJvb3RFbGVtZW50JywKICAgICAgICAgICAgZnVuY3Rpb24gKCRyb290U2NvcGUsICRicm93c2VyLCAkc25pZmZlciwgJHJvb3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgJGxvY2F0aW9uLAogICAgICAgICAgICAgICAgICAgIExvY2F0aW9uTW9kZSwKICAgICAgICAgICAgICAgICAgICBiYXNlSHJlZiA9ICRicm93c2VyLmJhc2VIcmVmKCksIC8vIGlmIGJhc2VbaHJlZl0gaXMgdW5kZWZpbmVkLCBpdCBkZWZhdWx0cyB0byAnJwogICAgICAgICAgICAgICAgICAgIGluaXRpYWxVcmwgPSAkYnJvd3Nlci51cmwoKSwKICAgICAgICAgICAgICAgICAgICBhcHBCYXNlOwoKICAgICAgICAgICAgICAgIGlmIChodG1sNU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBhcHBCYXNlID0gc2VydmVyQmFzZShpbml0aWFsVXJsKSArIChiYXNlSHJlZiB8fCAnLycpOwogICAgICAgICAgICAgICAgICAgIExvY2F0aW9uTW9kZSA9ICRzbmlmZmVyLmhpc3RvcnkgPyBMb2NhdGlvbkh0bWw1VXJsIDogTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFwcEJhc2UgPSBzdHJpcEhhc2goaW5pdGlhbFVybCk7CiAgICAgICAgICAgICAgICAgICAgTG9jYXRpb25Nb2RlID0gTG9jYXRpb25IYXNoYmFuZ1VybDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRsb2NhdGlvbiA9IG5ldyBMb2NhdGlvbk1vZGUoYXBwQmFzZSwgJyMnICsgaGFzaFByZWZpeCk7CiAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZSgkbG9jYXRpb24uJCRyZXdyaXRlKGluaXRpYWxVcmwpKTsKCiAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHJld3JpdGUgbGluayB3aGVuIG9wZW5pbmcgaW4gbmV3IHRhYi93aW5kb3cgKGluIGxlZ2FjeSBicm93c2VyKQogICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnRseSB3ZSBvcGVuIG5pY2UgdXJsIGxpbmsgYW5kIHJlZGlyZWN0IHRoZW4KCiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSB8fCBldmVudC53aGljaCA9PSAyKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIHZhciBlbG0gPSBqcUxpdGUoZXZlbnQudGFyZ2V0KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gdHJhdmVyc2UgdGhlIERPTSB1cCB0byBmaW5kIGZpcnN0IEEgdGFnCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxvd2VyY2FzZShlbG1bMF0ubm9kZU5hbWUpICE9PSAnYScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWdub3JlIHJld3JpdGluZyBpZiBubyBBIHRhZyAocmVhY2hlZCByb290IGVsZW1lbnQsIG9yIG5vIHBhcmVudCAtIHJlbW92ZWQgZnJvbSBkb2N1bWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsbVswXSA9PT0gJHJvb3RFbGVtZW50WzBdIHx8ICEoZWxtID0gZWxtLnBhcmVudCgpKVswXSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIGFic0hyZWYgPSBlbG0ucHJvcCgnaHJlZicpOwogICAgICAgICAgICAgICAgICAgIHZhciByZXdyaXR0ZW5VcmwgPSAkbG9jYXRpb24uJCRyZXdyaXRlKGFic0hyZWYpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYWJzSHJlZiAmJiAhZWxtLmF0dHIoJ3RhcmdldCcpICYmIHJld3JpdHRlblVybCAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJld3JpdHRlblVybCAhPSAkYnJvd3Nlci51cmwoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXBkYXRlIGxvY2F0aW9uIG1hbnVhbGx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShyZXdyaXR0ZW5VcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhhY2sgdG8gd29yayBhcm91bmQgRkY2IGJ1ZyA2ODQyMDggd2hlbiBzY2VuYXJpbyBydW5uZXIgY2xpY2tzIG9uIGxpbmtzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYW5ndWxhclsnZmYtNjg0MjA4LXByZXZlbnREZWZhdWx0J10gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgoKICAgICAgICAgICAgICAgIC8vIHJld3JpdGUgaGFzaGJhbmcgdXJsIDw+IGh0bWw1IHVybAogICAgICAgICAgICAgICAgaWYgKCRsb2NhdGlvbi5hYnNVcmwoKSAhPSBpbml0aWFsVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gdXBkYXRlICRsb2NhdGlvbiB3aGVuICRicm93c2VyIHVybCBjaGFuZ2VzCiAgICAgICAgICAgICAgICAkYnJvd3Nlci5vblVybENoYW5nZShmdW5jdGlvbiAobmV3VXJsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRsb2NhdGlvbi5hYnNVcmwoKSAhPSBuZXdVcmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3RhcnQnLCBuZXdVcmwsICRsb2NhdGlvbi5hYnNVcmwoKSkuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvbGRVcmwgPSAkbG9jYXRpb24uYWJzVXJsKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2UobmV3VXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghJHJvb3RTY29wZS4kJHBoYXNlKSAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyB1cGRhdGUgYnJvd3NlcgogICAgICAgICAgICAgICAgdmFyIGNoYW5nZUNvdW50ZXIgPSAwOwogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kd2F0Y2goZnVuY3Rpb24gJGxvY2F0aW9uV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9sZFVybCA9ICRicm93c2VyLnVybCgpOwogICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50UmVwbGFjZSA9ICRsb2NhdGlvbi4kJHJlcGxhY2U7CgogICAgICAgICAgICAgICAgICAgIGlmICghY2hhbmdlQ291bnRlciB8fCBvbGRVcmwgIT0gJGxvY2F0aW9uLmFic1VybCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZUNvdW50ZXIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRsb2NhdGlvbkNoYW5nZVN0YXJ0JywgJGxvY2F0aW9uLmFic1VybCgpLCBvbGRVcmwpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShvbGRVcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnJvd3Nlci51cmwoJGxvY2F0aW9uLmFic1VybCgpLCBjdXJyZW50UmVwbGFjZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJMb2NhdGlvbkNoYW5nZShvbGRVcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLiQkcmVwbGFjZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hhbmdlQ291bnRlcjsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHJldHVybiAkbG9jYXRpb247CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gYWZ0ZXJMb2NhdGlvbkNoYW5nZShvbGRVcmwpIHsKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3MnLCAkbG9jYXRpb24uYWJzVXJsKCksIG9sZFVybCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGxvZwogICAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNpbXBsZSBzZXJ2aWNlIGZvciBsb2dnaW5nLiBEZWZhdWx0IGltcGxlbWVudGF0aW9uIHdyaXRlcyB0aGUgbWVzc2FnZQogICAgICogaW50byB0aGUgYnJvd3NlcidzIGNvbnNvbGUgKGlmIHByZXNlbnQpLgogICAgICoKICAgICAqIFRoZSBtYWluIHB1cnBvc2Ugb2YgdGhpcyBzZXJ2aWNlIGlzIHRvIHNpbXBsaWZ5IGRlYnVnZ2luZyBhbmQgdHJvdWJsZXNob290aW5nLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICA8ZXhhbXBsZT4KICAgICAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgICAgICBmdW5jdGlvbiBMb2dDdHJsKCRzY29wZSwgJGxvZykgewogICAgICAgICAgICAgJHNjb3BlLiRsb2cgPSAkbG9nOwogICAgICAgICAgICAgJHNjb3BlLm1lc3NhZ2UgPSAnSGVsbG8gV29ybGQhJzsKICAgICAgICAgICB9CiAgICAgICAgIDwvZmlsZT4KICAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJMb2dDdHJsIj4KICAgICAgICAgICAgIDxwPlJlbG9hZCB0aGlzIHBhZ2Ugd2l0aCBvcGVuIGNvbnNvbGUsIGVudGVyIHRleHQgYW5kIGhpdCB0aGUgbG9nIGJ1dHRvbi4uLjwvcD4KICAgICAgICAgICAgIE1lc3NhZ2U6CiAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im1lc3NhZ2UiLz4KICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cubG9nKG1lc3NhZ2UpIj5sb2c8L2J1dHRvbj4KICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cud2FybihtZXNzYWdlKSI+d2FybjwvYnV0dG9uPgogICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJGxvZy5pbmZvKG1lc3NhZ2UpIj5pbmZvPC9idXR0b24+CiAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmVycm9yKG1lc3NhZ2UpIj5lcnJvcjwvYnV0dG9uPgogICAgICAgICAgIDwvZGl2PgogICAgICAgICA8L2ZpbGU+CiAgICAgICA8L2V4YW1wbGU+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2dQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2UgdGhlIGAkbG9nUHJvdmlkZXJgIHRvIGNvbmZpZ3VyZSBob3cgdGhlIGFwcGxpY2F0aW9uIGxvZ3MgbWVzc2FnZXMKICAgICAqLwogICAgZnVuY3Rpb24gJExvZ1Byb3ZpZGVyKCkgewogICAgICAgIHZhciBkZWJ1ZyA9IHRydWUsCiAgICAgICAgICAgIHNlbGYgPSB0aGlzOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgKiBAbmFtZSBuZy4kbG9nUHJvdmlkZXIjZGVidWdFbmFibGVkCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2dQcm92aWRlcgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gZmxhZyBlbmFibGUgb3IgZGlzYWJsZSBkZWJ1ZyBsZXZlbCBtZXNzYWdlcwogICAgICAgICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5kZWJ1Z0VuYWJsZWQgPSBmdW5jdGlvbiAoZmxhZykgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGZsYWcpKSB7CiAgICAgICAgICAgICAgICBkZWJ1ZyA9IGZsYWc7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWJ1ZzsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsIGZ1bmN0aW9uICgkd2luZG93KSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2cjbG9nCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvZwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogV3JpdGUgYSBsb2cgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBsb2c6IGNvbnNvbGVMb2coJ2xvZycpLAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGxvZyNpbmZvCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvZwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogV3JpdGUgYW4gaW5mb3JtYXRpb24gbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBpbmZvOiBjb25zb2xlTG9nKCdpbmZvJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI3dhcm4KICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhIHdhcm5pbmcgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB3YXJuOiBjb25zb2xlTG9nKCd3YXJuJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI2Vycm9yCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvZwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogV3JpdGUgYW4gZXJyb3IgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBlcnJvcjogY29uc29sZUxvZygnZXJyb3InKSwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2cjZGVidWcKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKiAKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogV3JpdGUgYSBkZWJ1ZyBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGRlYnVnOiAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBmbiA9IGNvbnNvbGVMb2coJ2RlYnVnJyk7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uYXBwbHkoc2VsZiwgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0oKSkKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGZvcm1hdEVycm9yKGFyZykgewogICAgICAgICAgICAgICAgaWYgKGFyZyBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZy5zdGFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBhcmcgPSAoYXJnLm1lc3NhZ2UgJiYgYXJnLnN0YWNrLmluZGV4T2YoYXJnLm1lc3NhZ2UpID09PSAtMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ0Vycm9yOiAnICsgYXJnLm1lc3NhZ2UgKyAnXG4nICsgYXJnLnN0YWNrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGFyZy5zdGFjazsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFyZy5zb3VyY2VVUkwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJnID0gYXJnLm1lc3NhZ2UgKyAnXG4nICsgYXJnLnNvdXJjZVVSTCArICc6JyArIGFyZy5saW5lOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbnNvbGVMb2codHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGNvbnNvbGUgPSAkd2luZG93LmNvbnNvbGUgfHwge30sCiAgICAgICAgICAgICAgICAgICAgbG9nRm4gPSBjb25zb2xlW3R5cGVdIHx8IGNvbnNvbGUubG9nIHx8IG5vb3A7CgogICAgICAgICAgICAgICAgaWYgKGxvZ0ZuLmFwcGx5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChhcmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChmb3JtYXRFcnJvcihhcmcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2dGbi5hcHBseShjb25zb2xlLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBJRSB3aGljaCBlaXRoZXIgZG9lc24ndCBoYXZlIHdpbmRvdy5jb25zb2xlID0+IHRoaXMgaXMgbm9vcCBhbmQgd2UgZG8gbm90aGluZywKICAgICAgICAgICAgICAgIC8vIG9yIHdlIGFyZSBJRSB3aGVyZSBjb25zb2xlLmxvZyBkb2Vzbid0IGhhdmUgYXBwbHkgc28gd2UgbG9nIGF0IGxlYXN0IGZpcnN0IDIgYXJncwogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhcmcxLCBhcmcyKSB7CiAgICAgICAgICAgICAgICAgICAgbG9nRm4oYXJnMSwgYXJnMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9XTsKICAgIH0KCiAgICB2YXIgJHBhcnNlTWluRXJyID0gbWluRXJyKCckcGFyc2UnKTsKCiAgICAvLyBTYW5kYm94aW5nIEFuZ3VsYXIgRXhwcmVzc2lvbnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gQW5ndWxhciBleHByZXNzaW9ucyBhcmUgZ2VuZXJhbGx5IGNvbnNpZGVyZWQgc2FmZSBiZWNhdXNlIHRoZXNlIGV4cHJlc3Npb25zIG9ubHkgaGF2ZSBkaXJlY3QgYWNjZXNzIHRvICRzY29wZSBhbmQKICAgIC8vIGxvY2Fscy4gSG93ZXZlciwgb25lIGNhbiBvYnRhaW4gdGhlIGFiaWxpdHkgdG8gZXhlY3V0ZSBhcmJpdHJhcnkgSlMgY29kZSBieSBvYnRhaW5pbmcgYSByZWZlcmVuY2UgdG8gbmF0aXZlIEpTCiAgICAvLyBmdW5jdGlvbnMgc3VjaCBhcyB0aGUgRnVuY3Rpb24gY29uc3RydWN0b3IuCiAgICAvLwogICAgLy8gQXMgYW4gZXhhbXBsZSwgY29uc2lkZXIgdGhlIGZvbGxvd2luZyBBbmd1bGFyIGV4cHJlc3Npb246CiAgICAvLwogICAgLy8gICB7fS50b1N0cmluZy5jb25zdHJ1Y3RvcihhbGVydCgiZXZpbCBKUyBjb2RlIikpCiAgICAvLwogICAgLy8gV2Ugd2FudCB0byBwcmV2ZW50IHRoaXMgdHlwZSBvZiBhY2Nlc3MuIEZvciB0aGUgc2FrZSBvZiBwZXJmb3JtYW5jZSwgZHVyaW5nIHRoZSBsZXhpbmcgcGhhc2Ugd2UgZGlzYWxsb3cgYW55ICJkb3R0ZWQiCiAgICAvLyBhY2Nlc3MgdG8gYW55IG1lbWJlciBuYW1lZCAiY29uc3RydWN0b3IiLgogICAgLy8KICAgIC8vIEZvciByZWZsZWN0aXZlIGNhbGxzIChhW2JdKSB3ZSBjaGVjayB0aGF0IHRoZSB2YWx1ZSBvZiB0aGUgbG9va3VwIGlzIG5vdCB0aGUgRnVuY3Rpb24gY29uc3RydWN0b3Igd2hpbGUgZXZhbHVhdGluZwogICAgLy8gdGhlIGV4cHJlc3Npb24sIHdoaWNoIGlzIGEgc3Ryb25nZXIgYnV0IG1vcmUgZXhwZW5zaXZlIHRlc3QuIFNpbmNlIHJlZmxlY3RpdmUgY2FsbHMgYXJlIGV4cGVuc2l2ZSBhbnl3YXksIHRoaXMgaXMgbm90CiAgICAvLyBzdWNoIGEgYmlnIGRlYWwgY29tcGFyZWQgdG8gc3RhdGljIGRlcmVmZXJlbmNpbmcuCiAgICAvLwogICAgLy8gVGhpcyBzYW5kYm94aW5nIHRlY2huaXF1ZSBpcyBub3QgcGVyZmVjdCBhbmQgZG9lc24ndCBhaW0gdG8gYmUuIFRoZSBnb2FsIGlzIHRvIHByZXZlbnQgZXhwbG9pdHMgYWdhaW5zdCB0aGUKICAgIC8vIGV4cHJlc3Npb24gbGFuZ3VhZ2UsIGJ1dCBub3QgdG8gcHJldmVudCBleHBsb2l0cyB0aGF0IHdlcmUgZW5hYmxlZCBieSBleHBvc2luZyBzZW5zaXRpdmUgSmF2YVNjcmlwdCBvciBicm93c2VyIGFwaXMKICAgIC8vIG9uIFNjb3BlLiBFeHBvc2luZyBzdWNoIG9iamVjdHMgb24gYSBTY29wZSBpcyBuZXZlciBhIGdvb2QgcHJhY3RpY2UgYW5kIHRoZXJlZm9yZSB3ZSBhcmUgbm90IGV2ZW4gdHJ5aW5nIHRvIHByb3RlY3QKICAgIC8vIGFnYWluc3QgaW50ZXJhY3Rpb24gd2l0aCBhbiBvYmplY3QgZXhwbGljaXRseSBleHBvc2VkIGluIHRoaXMgd2F5LgogICAgLy8KICAgIC8vIEEgZGV2ZWxvcGVyIGNvdWxkIGZvaWwgdGhlIG5hbWUgY2hlY2sgYnkgYWxpYXNpbmcgdGhlIEZ1bmN0aW9uIGNvbnN0cnVjdG9yIHVuZGVyIGEgZGlmZmVyZW50IG5hbWUgb24gdGhlIHNjb3BlLgogICAgLy8KICAgIC8vIEluIGdlbmVyYWwsIGl0IGlzIG5vdCBwb3NzaWJsZSB0byBhY2Nlc3MgYSBXaW5kb3cgb2JqZWN0IGZyb20gYW4gYW5ndWxhciBleHByZXNzaW9uIHVubGVzcyBhIHdpbmRvdyBvciBzb21lIERPTQogICAgLy8gb2JqZWN0IHRoYXQgaGFzIGEgcmVmZXJlbmNlIHRvIHdpbmRvdyBpcyBwdWJsaXNoZWQgb250byBhIFNjb3BlLgoKICAgIGZ1bmN0aW9uIGVuc3VyZVNhZmVNZW1iZXJOYW1lKG5hbWUsIGZ1bGxFeHByZXNzaW9uKSB7CiAgICAgICAgaWYgKG5hbWUgPT09ICJjb25zdHJ1Y3RvciIpIHsKICAgICAgICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2VjZmxkJywKICAgICAgICAgICAgICAgICdSZWZlcmVuY2luZyAiY29uc3RydWN0b3IiIGZpZWxkIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGlzYWxsb3dlZCEgRXhwcmVzc2lvbjogezB9JywgZnVsbEV4cHJlc3Npb24pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmFtZTsKICAgIH07CgogICAgZnVuY3Rpb24gZW5zdXJlU2FmZU9iamVjdChvYmosIGZ1bGxFeHByZXNzaW9uKSB7CiAgICAgICAgLy8gbmlmdHkgY2hlY2sgaWYgb2JqIGlzIEZ1bmN0aW9uIHRoYXQgaXMgZmFzdCBhbmQgd29ya3MgYWNyb3NzIGlmcmFtZXMgYW5kIG90aGVyIGNvbnRleHRzCiAgICAgICAgaWYgKG9iaiAmJiBvYmouY29uc3RydWN0b3IgPT09IG9iaikgewogICAgICAgICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2lzZWNmbicsCiAgICAgICAgICAgICAgICAnUmVmZXJlbmNpbmcgRnVuY3Rpb24gaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLCBmdWxsRXhwcmVzc2lvbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG9iajsKICAgICAgICB9CiAgICB9CgoKICAgIHZhciBPUEVSQVRPUlMgPSB7CiAgICAgICAgJ251bGwnOiBmdW5jdGlvbiAoKSB7IHJldHVybiBudWxsOyB9LAogICAgICAgICd0cnVlJzogZnVuY3Rpb24gKCkgeyByZXR1cm4gdHJ1ZTsgfSwKICAgICAgICAnZmFsc2UnOiBmdW5jdGlvbiAoKSB7IHJldHVybiBmYWxzZTsgfSwKICAgICAgICB1bmRlZmluZWQ6IG5vb3AsCiAgICAgICAgJysnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIGEgPSBhKHNlbGYsIGxvY2Fscyk7IGIgPSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQoYSkpIHsKICAgICAgICAgICAgICAgIGlmIChpc0RlZmluZWQoYikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYSArIGI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaXNEZWZpbmVkKGIpID8gYiA6IHVuZGVmaW5lZDsKICAgICAgICB9LAogICAgICAgICctJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgeyBhID0gYShzZWxmLCBsb2NhbHMpOyBiID0gYihzZWxmLCBsb2NhbHMpOyByZXR1cm4gKGlzRGVmaW5lZChhKSA/IGEgOiAwKSAtIChpc0RlZmluZWQoYikgPyBiIDogMCk7IH0sCiAgICAgICAgJyonOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgKiBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJy8nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgLyBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJyUnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgJSBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJ14nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgXiBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJz0nOiBub29wLAogICAgICAgICc9PT0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgPT09IGIoc2VsZiwgbG9jYWxzKTsgfSwKICAgICAgICAnIT09JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgeyByZXR1cm4gYShzZWxmLCBsb2NhbHMpICE9PSBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJz09JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgeyByZXR1cm4gYShzZWxmLCBsb2NhbHMpID09IGIoc2VsZiwgbG9jYWxzKTsgfSwKICAgICAgICAnIT0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgIT0gYihzZWxmLCBsb2NhbHMpOyB9LAogICAgICAgICc8JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgeyByZXR1cm4gYShzZWxmLCBsb2NhbHMpIDwgYihzZWxmLCBsb2NhbHMpOyB9LAogICAgICAgICc+JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgeyByZXR1cm4gYShzZWxmLCBsb2NhbHMpID4gYihzZWxmLCBsb2NhbHMpOyB9LAogICAgICAgICc8PSc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSA8PSBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJz49JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgeyByZXR1cm4gYShzZWxmLCBsb2NhbHMpID49IGIoc2VsZiwgbG9jYWxzKTsgfSwKICAgICAgICAnJiYnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgJiYgYihzZWxmLCBsb2NhbHMpOyB9LAogICAgICAgICd8fCc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSB8fCBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJyYnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgJiBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgLy8gICAgJ3wnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYXxiO30sCiAgICAgICAgJ3wnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBiKHNlbGYsIGxvY2Fscykoc2VsZiwgbG9jYWxzLCBhKHNlbGYsIGxvY2FscykpOyB9LAogICAgICAgICchJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSkgeyByZXR1cm4gIWEoc2VsZiwgbG9jYWxzKTsgfQogICAgfTsKICAgIHZhciBFU0NBUEUgPSB7ICJuIjogIlxuIiwgImYiOiAiXGYiLCAiciI6ICJcciIsICJ0IjogIlx0IiwgInYiOiAiXHYiLCAiJyI6ICInIiwgJyInOiAnIicgfTsKCiAgICBmdW5jdGlvbiBsZXgodGV4dCwgY3NwKSB7CiAgICAgICAgdmFyIHRva2VucyA9IFtdLAogICAgICAgICAgICB0b2tlbiwKICAgICAgICAgICAgaW5kZXggPSAwLAogICAgICAgICAgICBqc29uID0gW10sCiAgICAgICAgICAgIGNoLAogICAgICAgICAgICBsYXN0Q2ggPSAnOic7IC8vIGNhbiBzdGFydCByZWdleHAKCiAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgY2ggPSB0ZXh0LmNoYXJBdChpbmRleCk7CiAgICAgICAgICAgIGlmIChpcygnIlwnJykpIHsKICAgICAgICAgICAgICAgIHJlYWRTdHJpbmcoY2gpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzTnVtYmVyKGNoKSB8fCBpcygnLicpICYmIGlzTnVtYmVyKHBlZWsoKSkpIHsKICAgICAgICAgICAgICAgIHJlYWROdW1iZXIoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc0lkZW50KGNoKSkgewogICAgICAgICAgICAgICAgcmVhZElkZW50KCk7CiAgICAgICAgICAgICAgICAvLyBpZGVudGlmaWVycyBjYW4gb25seSBiZSBpZiB0aGUgcHJlY2VkaW5nIGNoYXIgd2FzIGEgeyBvciAsCiAgICAgICAgICAgICAgICBpZiAod2FzKCd7LCcpICYmIGpzb25bMF0gPT0gJ3snICYmCiAgICAgICAgICAgICAgICAgICAodG9rZW4gPSB0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdKSkgewogICAgICAgICAgICAgICAgICAgIHRva2VuLmpzb24gPSB0b2tlbi50ZXh0LmluZGV4T2YoJy4nKSA9PSAtMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChpcygnKCl7fVtdLiw7Oj8nKSkgewogICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGluZGV4OiBpbmRleCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBjaCwKICAgICAgICAgICAgICAgICAgICBqc29uOiAod2FzKCc6WywnKSAmJiBpcygne1snKSkgfHwgaXMoJ31dOiwnKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBpZiAoaXMoJ3tbJykpIGpzb24udW5zaGlmdChjaCk7CiAgICAgICAgICAgICAgICBpZiAoaXMoJ31dJykpIGpzb24uc2hpZnQoKTsKICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNXaGl0ZXNwYWNlKGNoKSkgewogICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGNoMiA9IGNoICsgcGVlaygpLAogICAgICAgICAgICAgICAgICAgIGNoMyA9IGNoMiArIHBlZWsoMiksCiAgICAgICAgICAgICAgICAgICAgZm4gPSBPUEVSQVRPUlNbY2hdLAogICAgICAgICAgICAgICAgICAgIGZuMiA9IE9QRVJBVE9SU1tjaDJdLAogICAgICAgICAgICAgICAgICAgIGZuMyA9IE9QRVJBVE9SU1tjaDNdOwogICAgICAgICAgICAgICAgaWYgKGZuMykgewogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsgaW5kZXg6IGluZGV4LCB0ZXh0OiBjaDMsIGZuOiBmbjMgfSk7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZm4yKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goeyBpbmRleDogaW5kZXgsIHRleHQ6IGNoMiwgZm46IGZuMiB9KTsKICAgICAgICAgICAgICAgICAgICBpbmRleCArPSAyOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmbikgewogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsgaW5kZXg6IGluZGV4LCB0ZXh0OiBjaCwgZm46IGZuLCBqc29uOiB3YXMoJ1ssOicpICYmIGlzKCcrLScpIH0pOwogICAgICAgICAgICAgICAgICAgIGluZGV4ICs9IDE7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIlVuZXhwZWN0ZWQgbmV4dCBjaGFyYWN0ZXIgIiwgaW5kZXgsIGluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdENoID0gY2g7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbnM7CgogICAgICAgIGZ1bmN0aW9uIGlzKGNoYXJzKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFycy5pbmRleE9mKGNoKSAhPSAtMTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHdhcyhjaGFycykgewogICAgICAgICAgICByZXR1cm4gY2hhcnMuaW5kZXhPZihsYXN0Q2gpICE9IC0xOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGVlayhpKSB7CiAgICAgICAgICAgIHZhciBudW0gPSBpIHx8IDE7CiAgICAgICAgICAgIHJldHVybiBpbmRleCArIG51bSA8IHRleHQubGVuZ3RoID8gdGV4dC5jaGFyQXQoaW5kZXggKyBudW0pIDogZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzTnVtYmVyKGNoKSB7CiAgICAgICAgICAgIHJldHVybiAnMCcgPD0gY2ggJiYgY2ggPD0gJzknOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1doaXRlc3BhY2UoY2gpIHsKICAgICAgICAgICAgcmV0dXJuIGNoID09ICcgJyB8fCBjaCA9PSAnXHInIHx8IGNoID09ICdcdCcgfHwKICAgICAgICAgICAgICAgICAgIGNoID09ICdcbicgfHwgY2ggPT0gJ1x2JyB8fCBjaCA9PSAnXHUwMEEwJzsgLy8gSUUgdHJlYXRzIG5vbi1icmVha2luZyBzcGFjZSBhcyBcdTAwQTAKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNJZGVudChjaCkgewogICAgICAgICAgICByZXR1cm4gJ2EnIDw9IGNoICYmIGNoIDw9ICd6JyB8fAogICAgICAgICAgICAgICAgICAgJ0EnIDw9IGNoICYmIGNoIDw9ICdaJyB8fAogICAgICAgICAgICAgICAgICAgJ18nID09IGNoIHx8IGNoID09ICckJzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNFeHBPcGVyYXRvcihjaCkgewogICAgICAgICAgICByZXR1cm4gY2ggPT0gJy0nIHx8IGNoID09ICcrJyB8fCBpc051bWJlcihjaCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB0aHJvd0Vycm9yKGVycm9yLCBzdGFydCwgZW5kKSB7CiAgICAgICAgICAgIGVuZCA9IGVuZCB8fCBpbmRleDsKICAgICAgICAgICAgdmFyIGNvbFN0ciA9IChpc0RlZmluZWQoc3RhcnQpID8KICAgICAgICAgICAgICAgICJzICIgKyBzdGFydCArICItIiArIGluZGV4ICsgIiBbIiArIHRleHQuc3Vic3RyaW5nKHN0YXJ0LCBlbmQpICsgIl0iCiAgICAgICAgICAgICAgICA6ICIgIiArIGVuZCk7CiAgICAgICAgICAgIHRocm93ICRwYXJzZU1pbkVycignbGV4ZXJyJywgIkxleGVyIEVycm9yOiB7MH0gYXQgY29sdW1uezF9IGluIGV4cHJlc3Npb24gW3syfV0uIiwKICAgICAgICAgICAgICAgIGVycm9yLCBjb2xTdHIsIHRleHQpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVhZE51bWJlcigpIHsKICAgICAgICAgICAgdmFyIG51bWJlciA9ICIiOwogICAgICAgICAgICB2YXIgc3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBjaCA9IGxvd2VyY2FzZSh0ZXh0LmNoYXJBdChpbmRleCkpOwogICAgICAgICAgICAgICAgaWYgKGNoID09ICcuJyB8fCBpc051bWJlcihjaCkpIHsKICAgICAgICAgICAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBwZWVrQ2ggPSBwZWVrKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICdlJyAmJiBpc0V4cE9wZXJhdG9yKHBlZWtDaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgcGVla0NoICYmIGlzTnVtYmVyKHBlZWtDaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyLmNoYXJBdChudW1iZXIubGVuZ3RoIC0gMSkgPT0gJ2UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlciArPSBjaDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRXhwT3BlcmF0b3IoY2gpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICghcGVla0NoIHx8ICFpc051bWJlcihwZWVrQ2gpKSAmJgogICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcignSW52YWxpZCBleHBvbmVudCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbnVtYmVyID0gMSAqIG51bWJlcjsKICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgaW5kZXg6IHN0YXJ0LCB0ZXh0OiBudW1iZXIsIGpzb246IHRydWUsCiAgICAgICAgICAgICAgICBmbjogZnVuY3Rpb24gKCkgeyByZXR1cm4gbnVtYmVyOyB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFkSWRlbnQoKSB7CiAgICAgICAgICAgIHZhciBpZGVudCA9ICIiLAogICAgICAgICAgICAgICAgc3RhcnQgPSBpbmRleCwKICAgICAgICAgICAgICAgIGxhc3REb3QsIHBlZWtJbmRleCwgbWV0aG9kTmFtZSwgY2g7CgogICAgICAgICAgICB3aGlsZSAoaW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgY2ggPSB0ZXh0LmNoYXJBdChpbmRleCk7CiAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJy4nIHx8IGlzSWRlbnQoY2gpIHx8IGlzTnVtYmVyKGNoKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjaCA9PSAnLicpIGxhc3REb3QgPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICBpZGVudCArPSBjaDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL2NoZWNrIGlmIHRoaXMgaXMgbm90IGEgbWV0aG9kIGludm9jYXRpb24gYW5kIGlmIGl0IGlzIGJhY2sgb3V0IHRvIGxhc3QgZG90CiAgICAgICAgICAgIGlmIChsYXN0RG90KSB7CiAgICAgICAgICAgICAgICBwZWVrSW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgIHdoaWxlIChwZWVrSW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGNoID0gdGV4dC5jaGFyQXQocGVla0luZGV4KTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJygnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZE5hbWUgPSBpZGVudC5zdWJzdHIobGFzdERvdCAtIHN0YXJ0ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkZW50ID0gaWRlbnQuc3Vic3RyKDAsIGxhc3REb3QgLSBzdGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gcGVla0luZGV4OwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGVla0luZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgdmFyIHRva2VuID0gewogICAgICAgICAgICAgICAgaW5kZXg6IHN0YXJ0LAogICAgICAgICAgICAgICAgdGV4dDogaWRlbnQKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChPUEVSQVRPUlMuaGFzT3duUHJvcGVydHkoaWRlbnQpKSB7CiAgICAgICAgICAgICAgICB0b2tlbi5mbiA9IHRva2VuLmpzb24gPSBPUEVSQVRPUlNbaWRlbnRdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGdldHRlciA9IGdldHRlckZuKGlkZW50LCBjc3AsIHRleHQpOwogICAgICAgICAgICAgICAgdG9rZW4uZm4gPSBleHRlbmQoZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoZ2V0dGVyKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbjogZnVuY3Rpb24gKHNlbGYsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXR0ZXIoc2VsZiwgaWRlbnQsIHZhbHVlLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwoKICAgICAgICAgICAgaWYgKG1ldGhvZE5hbWUpIHsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDogbGFzdERvdCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiAnLicsCiAgICAgICAgICAgICAgICAgICAganNvbjogZmFsc2UKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGluZGV4OiBsYXN0RG90ICsgMSwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBtZXRob2ROYW1lLAogICAgICAgICAgICAgICAgICAgIGpzb246IGZhbHNlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVhZFN0cmluZyhxdW90ZSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiOwogICAgICAgICAgICB2YXIgcmF3U3RyaW5nID0gcXVvdGU7CiAgICAgICAgICAgIHZhciBlc2NhcGUgPSBmYWxzZTsKICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBjaCA9IHRleHQuY2hhckF0KGluZGV4KTsKICAgICAgICAgICAgICAgIHJhd1N0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgIGlmIChlc2NhcGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJ3UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoZXggPSB0ZXh0LnN1YnN0cmluZyhpbmRleCArIDEsIGluZGV4ICsgNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaGV4Lm1hdGNoKC9bXGRhLWZdezR9L2kpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiSW52YWxpZCB1bmljb2RlIGVzY2FwZSBbXFx1IiArIGhleCArICJdIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KGhleCwgMTYpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVwID0gRVNDQVBFW2NoXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nICs9IHJlcDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlc2NhcGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2ggPT0gJ1xcJykgewogICAgICAgICAgICAgICAgICAgIGVzY2FwZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNoID09IHF1b3RlKSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBzdGFydCwKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogcmF3U3RyaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmc6IHN0cmluZywKICAgICAgICAgICAgICAgICAgICAgICAganNvbjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHN0cmluZzsgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc3RyaW5nICs9IGNoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvd0Vycm9yKCJVbnRlcm1pbmF0ZWQgcXVvdGUiLCBzdGFydCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gcGFyc2VyKHRleHQsIGpzb24sICRmaWx0ZXIsIGNzcCkgewogICAgICAgIHZhciBaRVJPID0gdmFsdWVGbigwKSwKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHRva2VucyA9IGxleCh0ZXh0LCBjc3ApLAogICAgICAgICAgICBhc3NpZ25tZW50ID0gX2Fzc2lnbm1lbnQsCiAgICAgICAgICAgIGZ1bmN0aW9uQ2FsbCA9IF9mdW5jdGlvbkNhbGwsCiAgICAgICAgICAgIGZpZWxkQWNjZXNzID0gX2ZpZWxkQWNjZXNzLAogICAgICAgICAgICBvYmplY3RJbmRleCA9IF9vYmplY3RJbmRleCwKICAgICAgICAgICAgZmlsdGVyQ2hhaW4gPSBfZmlsdGVyQ2hhaW47CgogICAgICAgIGlmIChqc29uKSB7CiAgICAgICAgICAgIC8vIFRoZSBleHRyYSBsZXZlbCBvZiBhbGlhc2luZyBpcyBoZXJlLCBqdXN0IGluIGNhc2UgdGhlIGxleGVyIG1pc3NlcyBzb21ldGhpbmcsIHNvIHRoYXQKICAgICAgICAgICAgLy8gd2UgcHJldmVudCBhbnkgYWNjaWRlbnRhbCBleGVjdXRpb24gaW4gSlNPTi4KICAgICAgICAgICAgYXNzaWdubWVudCA9IGxvZ2ljYWxPUjsKICAgICAgICAgICAgZnVuY3Rpb25DYWxsID0KICAgICAgICAgICAgICBmaWVsZEFjY2VzcyA9CiAgICAgICAgICAgICAgb2JqZWN0SW5kZXggPQogICAgICAgICAgICAgIGZpbHRlckNoYWluID0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsgdGhyb3dFcnJvcigiaXMgbm90IHZhbGlkIGpzb24iLCB7IHRleHQ6IHRleHQsIGluZGV4OiAwIH0pOyB9OwogICAgICAgICAgICB2YWx1ZSA9IHByaW1hcnkoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9IHN0YXRlbWVudHMoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgdGhyb3dFcnJvcigiaXMgYW4gdW5leHBlY3RlZCB0b2tlbiIsIHRva2Vuc1swXSk7CiAgICAgICAgfQogICAgICAgIHZhbHVlLmxpdGVyYWwgPSAhIXZhbHVlLmxpdGVyYWw7CiAgICAgICAgdmFsdWUuY29uc3RhbnQgPSAhIXZhbHVlLmNvbnN0YW50OwogICAgICAgIHJldHVybiB2YWx1ZTsKCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICBmdW5jdGlvbiB0aHJvd0Vycm9yKG1zZywgdG9rZW4pIHsKICAgICAgICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdzeW50YXgnLAogICAgICAgICAgICAgICAgIlN5bnRheCBFcnJvcjogVG9rZW4gJ3swfScgezF9IGF0IGNvbHVtbiB7Mn0gb2YgdGhlIGV4cHJlc3Npb24gW3szfV0gc3RhcnRpbmcgYXQgW3s0fV0uIiwKICAgICAgICAgICAgICAgIHRva2VuLnRleHQsIG1zZywgKHRva2VuLmluZGV4ICsgMSksIHRleHQsIHRleHQuc3Vic3RyaW5nKHRva2VuLmluZGV4KSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwZWVrVG9rZW4oKSB7CiAgICAgICAgICAgIGlmICh0b2tlbnMubGVuZ3RoID09PSAwKQogICAgICAgICAgICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCd1ZW9lJywgIlVuZXhwZWN0ZWQgZW5kIG9mIGV4cHJlc3Npb246IHswfSIsIHRleHQpOwogICAgICAgICAgICByZXR1cm4gdG9rZW5zWzBdOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGVlayhlMSwgZTIsIGUzLCBlNCkgewogICAgICAgICAgICBpZiAodG9rZW5zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRva2Vuc1swXTsKICAgICAgICAgICAgICAgIHZhciB0ID0gdG9rZW4udGV4dDsKICAgICAgICAgICAgICAgIGlmICh0ID09IGUxIHx8IHQgPT0gZTIgfHwgdCA9PSBlMyB8fCB0ID09IGU0IHx8CiAgICAgICAgICAgICAgICAgICAgKCFlMSAmJiAhZTIgJiYgIWUzICYmICFlNCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXhwZWN0KGUxLCBlMiwgZTMsIGU0KSB7CiAgICAgICAgICAgIHZhciB0b2tlbiA9IHBlZWsoZTEsIGUyLCBlMywgZTQpOwogICAgICAgICAgICBpZiAodG9rZW4pIHsKICAgICAgICAgICAgICAgIGlmIChqc29uICYmICF0b2tlbi5qc29uKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiaXMgbm90IHZhbGlkIGpzb24iLCB0b2tlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0b2tlbnMuc2hpZnQoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0b2tlbjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjb25zdW1lKGUxKSB7CiAgICAgICAgICAgIGlmICghZXhwZWN0KGUxKSkgewogICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiaXMgdW5leHBlY3RlZCwgZXhwZWN0aW5nIFsiICsgZTEgKyAiXSIsIHBlZWsoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVuYXJ5Rm4oZm4sIHJpZ2h0KSB7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZuKHNlbGYsIGxvY2FscywgcmlnaHQpOwogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBjb25zdGFudDogcmlnaHQuY29uc3RhbnQKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB0ZXJuYXJ5Rm4obGVmdCwgbWlkZGxlLCByaWdodCkgewogICAgICAgICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0KHNlbGYsIGxvY2FscykgPyBtaWRkbGUoc2VsZiwgbG9jYWxzKSA6IHJpZ2h0KHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGNvbnN0YW50OiBsZWZ0LmNvbnN0YW50ICYmIG1pZGRsZS5jb25zdGFudCAmJiByaWdodC5jb25zdGFudAogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGJpbmFyeUZuKGxlZnQsIGZuLCByaWdodCkgewogICAgICAgICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmbihzZWxmLCBsb2NhbHMsIGxlZnQsIHJpZ2h0KTsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgY29uc3RhbnQ6IGxlZnQuY29uc3RhbnQgJiYgcmlnaHQuY29uc3RhbnQKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzdGF0ZW1lbnRzKCkgewogICAgICAgICAgICB2YXIgc3RhdGVtZW50cyA9IFtdOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAwICYmICFwZWVrKCd9JywgJyknLCAnOycsICddJykpCiAgICAgICAgICAgICAgICAgICAgc3RhdGVtZW50cy5wdXNoKGZpbHRlckNoYWluKCkpOwogICAgICAgICAgICAgICAgaWYgKCFleHBlY3QoJzsnKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG9wdGltaXplIGZvciB0aGUgY29tbW9uIGNhc2Ugd2hlcmUgdGhlcmUgaXMgb25seSBvbmUgc3RhdGVtZW50LgogICAgICAgICAgICAgICAgICAgIC8vIFRPRE8oc2l6ZSk6IG1heWJlIHdlIHNob3VsZCBub3Qgc3VwcG9ydCBtdWx0aXBsZSBzdGF0ZW1lbnRzPwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZW1lbnRzLmxlbmd0aCA9PSAxCiAgICAgICAgICAgICAgICAgICAgICA/IHN0YXRlbWVudHNbMF0KICAgICAgICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0YXRlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0YXRlbWVudChzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfZmlsdGVyQ2hhaW4oKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCd8JykpKSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBmaWx0ZXIoKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaWx0ZXIoKSB7CiAgICAgICAgICAgIHZhciB0b2tlbiA9IGV4cGVjdCgpOwogICAgICAgICAgICB2YXIgZm4gPSAkZmlsdGVyKHRva2VuLnRleHQpOwogICAgICAgICAgICB2YXIgYXJnc0ZuID0gW107CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCc6JykpKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuSW52b2tlID0gZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgaW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbaW5wdXRdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGFyZ3NGbltpXShzZWxmLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm5JbnZva2U7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXhwcmVzc2lvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGFzc2lnbm1lbnQoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9hc3NpZ25tZW50KCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IHRlcm5hcnkoKTsKICAgICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJz0nKSkpIHsKICAgICAgICAgICAgICAgIGlmICghbGVmdC5hc3NpZ24pIHsKICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJpbXBsaWVzIGFzc2lnbm1lbnQgYnV0IFsiICsKICAgICAgICAgICAgICAgICAgICAgIHRleHQuc3Vic3RyaW5nKDAsIHRva2VuLmluZGV4KSArICJdIGNhbiBub3QgYmUgYXNzaWduZWQgdG8iLCB0b2tlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByaWdodCA9IHRlcm5hcnkoKTsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0LmFzc2lnbihzY29wZSwgcmlnaHQoc2NvcGUsIGxvY2FscyksIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHRlcm5hcnkoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gbG9naWNhbE9SKCk7CiAgICAgICAgICAgIHZhciBtaWRkbGU7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPycpKSkgewogICAgICAgICAgICAgICAgbWlkZGxlID0gdGVybmFyeSgpOwogICAgICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnOicpKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZXJuYXJ5Rm4obGVmdCwgbWlkZGxlLCB0ZXJuYXJ5KCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcignZXhwZWN0ZWQgOicsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBsb2dpY2FsT1IoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gbG9naWNhbEFORCgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCd8fCcpKSkgewogICAgICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgbG9naWNhbEFORCgpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGxvZ2ljYWxBTkQoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gZXF1YWxpdHkoKTsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCcmJicpKSkgewogICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBsb2dpY2FsQU5EKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXF1YWxpdHkoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gcmVsYXRpb25hbCgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJz09JywgJyE9JywgJz09PScsICchPT0nKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgZXF1YWxpdHkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWxhdGlvbmFsKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGFkZGl0aXZlKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPCcsICc+JywgJzw9JywgJz49JykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHJlbGF0aW9uYWwoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRpdGl2ZSgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBtdWx0aXBsaWNhdGl2ZSgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICgodG9rZW4gPSBleHBlY3QoJysnLCAnLScpKSkgewogICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBtdWx0aXBsaWNhdGl2ZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG11bHRpcGxpY2F0aXZlKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IHVuYXJ5KCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUgKCh0b2tlbiA9IGV4cGVjdCgnKicsICcvJywgJyUnKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdW5hcnkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1bmFyeSgpIHsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICBpZiAoZXhwZWN0KCcrJykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmltYXJ5KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRva2VuID0gZXhwZWN0KCctJykpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluYXJ5Rm4oWkVSTywgdG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IGV4cGVjdCgnIScpKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVuYXJ5Rm4odG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnkoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIHByaW1hcnkoKSB7CiAgICAgICAgICAgIHZhciBwcmltYXJ5OwogICAgICAgICAgICBpZiAoZXhwZWN0KCcoJykpIHsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmaWx0ZXJDaGFpbigpOwogICAgICAgICAgICAgICAgY29uc3VtZSgnKScpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgnWycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gYXJyYXlEZWNsYXJhdGlvbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgneycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gb2JqZWN0KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKTsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSB0b2tlbi5mbjsKICAgICAgICAgICAgICAgIGlmICghcHJpbWFyeSkgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIm5vdCBhIHByaW1hcnkgZXhwcmVzc2lvbiIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0b2tlbi5qc29uKSB7CiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeS5jb25zdGFudCA9IHByaW1hcnkubGl0ZXJhbCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBuZXh0LCBjb250ZXh0OwogICAgICAgICAgICB3aGlsZSAoKG5leHQgPSBleHBlY3QoJygnLCAnWycsICcuJykpKSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dC50ZXh0ID09PSAnKCcpIHsKICAgICAgICAgICAgICAgICAgICBwcmltYXJ5ID0gZnVuY3Rpb25DYWxsKHByaW1hcnksIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0LnRleHQgPT09ICdbJykgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBwcmltYXJ5OwogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBvYmplY3RJbmRleChwcmltYXJ5KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dC50ZXh0ID09PSAnLicpIHsKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gcHJpbWFyeTsKICAgICAgICAgICAgICAgICAgICBwcmltYXJ5ID0gZmllbGRBY2Nlc3MocHJpbWFyeSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIklNUE9TU0lCTEUiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJpbWFyeTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9maWVsZEFjY2VzcyhvYmplY3QpIHsKICAgICAgICAgICAgdmFyIGZpZWxkID0gZXhwZWN0KCkudGV4dDsKICAgICAgICAgICAgdmFyIGdldHRlciA9IGdldHRlckZuKGZpZWxkLCBjc3AsIHRleHQpOwogICAgICAgICAgICByZXR1cm4gZXh0ZW5kKAogICAgICAgICAgICAgICAgZnVuY3Rpb24gKHNjb3BlLCBsb2NhbHMsIHNlbGYpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0dGVyKHNlbGYgfHwgb2JqZWN0KHNjb3BlLCBsb2NhbHMpLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ246IGZ1bmN0aW9uIChzY29wZSwgdmFsdWUsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2V0dGVyKG9iamVjdChzY29wZSwgbG9jYWxzKSwgZmllbGQsIHZhbHVlLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfb2JqZWN0SW5kZXgob2JqKSB7CiAgICAgICAgICAgIHZhciBpbmRleEZuID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICBjb25zdW1lKCddJyk7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoCiAgICAgICAgICAgICAgZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICB2YXIgbyA9IG9iaihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgICAgICAgICAgICAgaSA9IGluZGV4Rm4oc2VsZiwgbG9jYWxzKSwKICAgICAgICAgICAgICAgICAgICAgIHYsIHA7CgogICAgICAgICAgICAgICAgICBpZiAoIW8pIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgIHYgPSBlbnN1cmVTYWZlT2JqZWN0KG9baV0sIHRleHQpOwogICAgICAgICAgICAgICAgICBpZiAodiAmJiB2LnRoZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIHAgPSB2OwogICAgICAgICAgICAgICAgICAgICAgaWYgKCEoJyQkdicgaW4gdikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBwLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICBwLnRoZW4oZnVuY3Rpb24gKHZhbCkgeyBwLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB2ID0gdi4kJHY7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBhc3NpZ246IGZ1bmN0aW9uIChzZWxmLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gaW5kZXhGbihzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgLy8gcHJldmVudCBvdmVyd3JpdGluZyBvZiBGdW5jdGlvbi5jb25zdHJ1Y3RvciB3aGljaCB3b3VsZCBicmVhayBlbnN1cmVTYWZlT2JqZWN0IGNoZWNrCiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW5zdXJlU2FmZU9iamVjdChvYmooc2VsZiwgbG9jYWxzKSwgdGV4dClba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfZnVuY3Rpb25DYWxsKGZuLCBjb250ZXh0R2V0dGVyKSB7CiAgICAgICAgICAgIHZhciBhcmdzRm4gPSBbXTsKICAgICAgICAgICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJyknKSB7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGV4cGVjdCgnLCcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdW1lKCcpJyk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dEdldHRlciA/IGNvbnRleHRHZXR0ZXIoc2NvcGUsIGxvY2FscykgOiBzY29wZTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChhcmdzRm5baV0oc2NvcGUsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGZuUHRyID0gZm4oc2NvcGUsIGxvY2FscywgY29udGV4dCkgfHwgbm9vcDsKICAgICAgICAgICAgICAgIC8vIElFIHN0dXBpZGl0eSEKICAgICAgICAgICAgICAgIHZhciB2ID0gZm5QdHIuYXBwbHkKICAgICAgICAgICAgICAgICAgICA/IGZuUHRyLmFwcGx5KGNvbnRleHQsIGFyZ3MpCiAgICAgICAgICAgICAgICAgICAgOiBmblB0cihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdKTsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBmb3IgcHJvbWlzZQogICAgICAgICAgICAgICAgaWYgKHYgJiYgdi50aGVuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHAgPSB2OwogICAgICAgICAgICAgICAgICAgIGlmICghKCckJHYnIGluIHYpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICBwLnRoZW4oZnVuY3Rpb24gKHZhbCkgeyBwLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHYgPSB2LiQkdjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIC8vIFRoaXMgaXMgdXNlZCB3aXRoIGpzb24gYXJyYXkgZGVjbGFyYXRpb24KICAgICAgICBmdW5jdGlvbiBhcnJheURlY2xhcmF0aW9uKCkgewogICAgICAgICAgICB2YXIgZWxlbWVudEZucyA9IFtdOwogICAgICAgICAgICB2YXIgYWxsQ29uc3RhbnQgPSB0cnVlOwogICAgICAgICAgICBpZiAocGVla1Rva2VuKCkudGV4dCAhPSAnXScpIHsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbWVudEZuID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRGbnMucHVzaChlbGVtZW50Rm4pOwogICAgICAgICAgICAgICAgICAgIGlmICghZWxlbWVudEZuLmNvbnN0YW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFsbENvbnN0YW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN1bWUoJ10nKTsKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAoc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudEZucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFycmF5LnB1c2goZWxlbWVudEZuc1tpXShzZWxmLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgbGl0ZXJhbDogdHJ1ZSwKICAgICAgICAgICAgICAgIGNvbnN0YW50OiBhbGxDb25zdGFudAogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG9iamVjdCgpIHsKICAgICAgICAgICAgdmFyIGtleVZhbHVlcyA9IFtdOwogICAgICAgICAgICB2YXIgYWxsQ29uc3RhbnQgPSB0cnVlOwogICAgICAgICAgICBpZiAocGVla1Rva2VuKCkudGV4dCAhPSAnfScpIHsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKSwKICAgICAgICAgICAgICAgICAgICBrZXkgPSB0b2tlbi5zdHJpbmcgfHwgdG9rZW4udGV4dDsKICAgICAgICAgICAgICAgICAgICBjb25zdW1lKCI6Iik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICAgIGtleVZhbHVlcy5wdXNoKHsga2V5OiBrZXksIHZhbHVlOiB2YWx1ZSB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlLmNvbnN0YW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFsbENvbnN0YW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN1bWUoJ30nKTsKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAoc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0ID0ge307CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleVZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBrZXlWYWx1ZSA9IGtleVZhbHVlc1tpXTsKICAgICAgICAgICAgICAgICAgICBvYmplY3Rba2V5VmFsdWUua2V5XSA9IGtleVZhbHVlLnZhbHVlKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBsaXRlcmFsOiB0cnVlLAogICAgICAgICAgICAgICAgY29uc3RhbnQ6IGFsbENvbnN0YW50CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8gUGFyc2VyIGhlbHBlciBmdW5jdGlvbnMKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gc2V0dGVyKG9iaiwgcGF0aCwgc2V0VmFsdWUsIGZ1bGxFeHApIHsKICAgICAgICB2YXIgZWxlbWVudCA9IHBhdGguc3BsaXQoJy4nKSwga2V5OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBlbGVtZW50Lmxlbmd0aCA+IDE7IGkrKykgewogICAgICAgICAgICBrZXkgPSBlbnN1cmVTYWZlTWVtYmVyTmFtZShlbGVtZW50LnNoaWZ0KCksIGZ1bGxFeHApOwogICAgICAgICAgICB2YXIgcHJvcGVydHlPYmogPSBvYmpba2V5XTsKICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eU9iaikgewogICAgICAgICAgICAgICAgcHJvcGVydHlPYmogPSB7fTsKICAgICAgICAgICAgICAgIG9ialtrZXldID0gcHJvcGVydHlPYmo7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb2JqID0gcHJvcGVydHlPYmo7CiAgICAgICAgICAgIGlmIChvYmoudGhlbikgewogICAgICAgICAgICAgICAgaWYgKCEoIiQkdiIgaW4gb2JqKSkgewogICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAocHJvbWlzZSkgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICkob2JqKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvYmouJCR2ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBvYmouJCR2ID0ge307CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvYmogPSBvYmouJCR2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGtleSA9IGVuc3VyZVNhZmVNZW1iZXJOYW1lKGVsZW1lbnQuc2hpZnQoKSwgZnVsbEV4cCk7CiAgICAgICAgb2JqW2tleV0gPSBzZXRWYWx1ZTsKICAgICAgICByZXR1cm4gc2V0VmFsdWU7CiAgICB9CgogICAgdmFyIGdldHRlckZuQ2FjaGUgPSB7fTsKCiAgICAvKioKICAgICAqIEltcGxlbWVudGF0aW9uIG9mIHRoZSAiQmxhY2sgSG9sZSIgdmFyaWFudCBmcm9tOgogICAgICogLSBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyanMtcGFyc2UtZ2V0dGVyLzQKICAgICAqIC0gaHR0cDovL2pzcGVyZi5jb20vcGF0aC1ldmFsdWF0aW9uLXNpbXBsaWZpZWQvNwogICAgICovCiAgICBmdW5jdGlvbiBjc3BTYWZlR2V0dGVyRm4oa2V5MCwga2V5MSwga2V5Miwga2V5Mywga2V5NCwgZnVsbEV4cCkgewogICAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTAsIGZ1bGxFeHApOwogICAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTEsIGZ1bGxFeHApOwogICAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTIsIGZ1bGxFeHApOwogICAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTMsIGZ1bGxFeHApOwogICAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTQsIGZ1bGxFeHApOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICB2YXIgcGF0aFZhbCA9IChsb2NhbHMgJiYgbG9jYWxzLmhhc093blByb3BlcnR5KGtleTApKSA/IGxvY2FscyA6IHNjb3BlLAogICAgICAgICAgICAgICAgcHJvbWlzZTsKCiAgICAgICAgICAgIGlmIChwYXRoVmFsID09PSBudWxsIHx8IHBhdGhWYWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHBhdGhWYWw7CgogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkwXTsKICAgICAgICAgICAgaWYgKHBhdGhWYWwgJiYgcGF0aFZhbC50aGVuKSB7CiAgICAgICAgICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwYXRoVmFsOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAodmFsKSB7IHByb21pc2UuJCR2ID0gdmFsOyB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsLiQkdjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWtleTEgfHwgcGF0aFZhbCA9PT0gbnVsbCB8fCBwYXRoVmFsID09PSB1bmRlZmluZWQpIHJldHVybiBwYXRoVmFsOwoKICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5MV07CiAgICAgICAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgICAgICAgICAgaWYgKCEoIiQkdiIgaW4gcGF0aFZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkyIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTJdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsgcHJvbWlzZS4kJHYgPSB2YWw7IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWwuJCR2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgha2V5MyB8fCBwYXRoVmFsID09PSBudWxsIHx8IHBhdGhWYWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHBhdGhWYWw7CgogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkzXTsKICAgICAgICAgICAgaWYgKHBhdGhWYWwgJiYgcGF0aFZhbC50aGVuKSB7CiAgICAgICAgICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwYXRoVmFsOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAodmFsKSB7IHByb21pc2UuJCR2ID0gdmFsOyB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsLiQkdjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWtleTQgfHwgcGF0aFZhbCA9PT0gbnVsbCB8fCBwYXRoVmFsID09PSB1bmRlZmluZWQpIHJldHVybiBwYXRoVmFsOwoKICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5NF07CiAgICAgICAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgICAgICAgICAgaWYgKCEoIiQkdiIgaW4gcGF0aFZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXR0ZXJGbihwYXRoLCBjc3AsIGZ1bGxFeHApIHsKICAgICAgICBpZiAoZ2V0dGVyRm5DYWNoZS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0dGVyRm5DYWNoZVtwYXRoXTsKICAgICAgICB9CgogICAgICAgIHZhciBwYXRoS2V5cyA9IHBhdGguc3BsaXQoJy4nKSwKICAgICAgICAgICAgcGF0aEtleXNMZW5ndGggPSBwYXRoS2V5cy5sZW5ndGgsCiAgICAgICAgICAgIGZuOwoKICAgICAgICBpZiAoY3NwKSB7CiAgICAgICAgICAgIGZuID0gKHBhdGhLZXlzTGVuZ3RoIDwgNikKICAgICAgICAgICAgICAgID8gY3NwU2FmZUdldHRlckZuKHBhdGhLZXlzWzBdLCBwYXRoS2V5c1sxXSwgcGF0aEtleXNbMl0sIHBhdGhLZXlzWzNdLCBwYXRoS2V5c1s0XSwgZnVsbEV4cCkKICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IDAsIHZhbDsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IGNzcFNhZmVHZXR0ZXJGbigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBmdWxsRXhwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkoc2NvcGUsIGxvY2Fscyk7CgogICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHMgPSB1bmRlZmluZWQ7IC8vIGNsZWFyIGFmdGVyIGZpcnN0IGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChpIDwgcGF0aEtleXNMZW5ndGgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGNvZGUgPSAndmFyIGwsIGZuLCBwO1xuJzsKICAgICAgICAgICAgZm9yRWFjaChwYXRoS2V5cywgZnVuY3Rpb24gKGtleSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleSwgZnVsbEV4cCk7CiAgICAgICAgICAgICAgICBjb2RlICs9ICdpZihzID09PSBudWxsIHx8IHMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHM7XG4nICsKICAgICAgICAgICAgICAgICAgICAgICAgJ2w9cztcbicgKwogICAgICAgICAgICAgICAgICAgICAgICAncz0nICsgKGluZGV4CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2Ugc2ltcGx5IGRlcmVmZXJlbmNlICdzJyBvbiBhbnkgLmRvdCBub3RhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ3MnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnV0IGlmIHdlIGFyZSBmaXJzdCB0aGVuIHdlIGNoZWNrIGxvY2FscyBmaXJzdCwgYW5kIGlmIHNvIHJlYWQgaXQgZmlyc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICcoKGsmJmsuaGFzT3duUHJvcGVydHkoIicgKyBrZXkgKyAnIikpP2s6cyknKSArICdbIicgKyBrZXkgKyAnIl0nICsgJztcbicgKwogICAgICAgICAgICAgICAgICAgICAgICAnaWYgKHMgJiYgcy50aGVuKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAnIGlmICghKCIkJHYiIGluIHMpKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgcD1zO1xuJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnIHAuJCR2ID0gdW5kZWZpbmVkO1xuJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnIHAudGhlbihmdW5jdGlvbih2KSB7cC4kJHY9djt9KTtcbicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ31cbicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICcgcz1zLiQkdlxuJyArCiAgICAgICAgICAgICAgICAgICAgICAgICd9XG4nOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29kZSArPSAncmV0dXJuIHM7JzsKICAgICAgICAgICAgZm4gPSBGdW5jdGlvbigncycsICdrJywgY29kZSk7IC8vIHM9c2NvcGUsIGs9bG9jYWxzCiAgICAgICAgICAgIGZuLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gY29kZTsgfTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBnZXR0ZXJGbkNhY2hlW3BhdGhdID0gZm47CiAgICB9CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJHBhcnNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBDb252ZXJ0cyBBbmd1bGFyIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGludG8gYSBmdW5jdGlvbi4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICB2YXIgZ2V0dGVyID0gJHBhcnNlKCd1c2VyLm5hbWUnKTsKICAgICAqICAgdmFyIHNldHRlciA9IGdldHRlci5hc3NpZ247CiAgICAgKiAgIHZhciBjb250ZXh0ID0ge3VzZXI6e25hbWU6J2FuZ3VsYXInfX07CiAgICAgKiAgIHZhciBsb2NhbHMgPSB7dXNlcjp7bmFtZTonbG9jYWwnfX07CiAgICAgKgogICAgICogICBleHBlY3QoZ2V0dGVyKGNvbnRleHQpKS50b0VxdWFsKCdhbmd1bGFyJyk7CiAgICAgKiAgIHNldHRlcihjb250ZXh0LCAnbmV3VmFsdWUnKTsKICAgICAqICAgZXhwZWN0KGNvbnRleHQudXNlci5uYW1lKS50b0VxdWFsKCduZXdWYWx1ZScpOwogICAgICogICBleHBlY3QoZ2V0dGVyKGNvbnRleHQsIGxvY2FscykpLnRvRXF1YWwoJ2xvY2FsJyk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqCiAgICAgKiAgICBUaGUgcmV0dXJuZWQgZnVuY3Rpb24gYWxzbyBoYXMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICogICAgICAqIGBsaXRlcmFsYCDigJMgYHtib29sZWFufWAg4oCTIHdoZXRoZXIgdGhlIGV4cHJlc3Npb24ncyB0b3AtbGV2ZWwgbm9kZSBpcyBhIEphdmFTY3JpcHQKICAgICAqICAgICAgICBsaXRlcmFsLgogICAgICogICAgICAqIGBjb25zdGFudGAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB3aGV0aGVyIHRoZSBleHByZXNzaW9uIGlzIG1hZGUgZW50aXJlbHkgb2YgSmF2YVNjcmlwdAogICAgICogICAgICAgIGNvbnN0YW50IGxpdGVyYWxzLgogICAgICogICAgICAqIGBhc3NpZ25gIOKAkyBgez9mdW5jdGlvbihjb250ZXh0LCB2YWx1ZSl9YCDigJMgaWYgdGhlIGV4cHJlc3Npb24gaXMgYXNzaWduYWJsZSwgdGhpcyB3aWxsIGJlCiAgICAgKiAgICAgICAgc2V0IHRvIGEgZnVuY3Rpb24gdG8gY2hhbmdlIGl0cyB2YWx1ZSBvbiB0aGUgZ2l2ZW4gY29udGV4dC4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uICRQYXJzZVByb3ZpZGVyKCkgewogICAgICAgIHZhciBjYWNoZSA9IHt9OwogICAgICAgIHRoaXMuJGdldCA9IFsnJGZpbHRlcicsICckc25pZmZlcicsIGZ1bmN0aW9uICgkZmlsdGVyLCAkc25pZmZlcikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGV4cCkgewogICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgZXhwKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlLmhhc093blByb3BlcnR5KGV4cCkKICAgICAgICAgICAgICAgICAgICAgICAgICA/IGNhY2hlW2V4cF0KICAgICAgICAgICAgICAgICAgICAgICAgICA6IGNhY2hlW2V4cF0gPSBwYXJzZXIoZXhwLCBmYWxzZSwgJGZpbHRlciwgJHNuaWZmZXIuY3NwKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleHA7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgbmcuJHEKICAgICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHByb21pc2UvZGVmZXJyZWQgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0tyaXMgS293YWwncyBRXShodHRwczovL2dpdGh1Yi5jb20va3Jpc2tvd2FsL3EpLgogICAgICoKICAgICAqIFtUaGUgQ29tbW9uSlMgUHJvbWlzZSBwcm9wb3NhbF0oaHR0cDovL3dpa2kuY29tbW9uanMub3JnL3dpa2kvUHJvbWlzZXMpIGRlc2NyaWJlcyBhIHByb21pc2UgYXMgYW4KICAgICAqIGludGVyZmFjZSBmb3IgaW50ZXJhY3Rpbmcgd2l0aCBhbiBvYmplY3QgdGhhdCByZXByZXNlbnRzIHRoZSByZXN1bHQgb2YgYW4gYWN0aW9uIHRoYXQgaXMKICAgICAqIHBlcmZvcm1lZCBhc3luY2hyb25vdXNseSwgYW5kIG1heSBvciBtYXkgbm90IGJlIGZpbmlzaGVkIGF0IGFueSBnaXZlbiBwb2ludCBpbiB0aW1lLgogICAgICoKICAgICAqIEZyb20gdGhlIHBlcnNwZWN0aXZlIG9mIGRlYWxpbmcgd2l0aCBlcnJvciBoYW5kbGluZywgZGVmZXJyZWQgYW5kIHByb21pc2UgQVBJcyBhcmUgdG8KICAgICAqIGFzeW5jaHJvbm91cyBwcm9ncmFtbWluZyB3aGF0IGB0cnlgLCBgY2F0Y2hgIGFuZCBgdGhyb3dgIGtleXdvcmRzIGFyZSB0byBzeW5jaHJvbm91cyBwcm9ncmFtbWluZy4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICAvLyBmb3IgdGhlIHB1cnBvc2Ugb2YgdGhpcyBleGFtcGxlIGxldCdzIGFzc3VtZSB0aGF0IHZhcmlhYmxlcyBgJHFgIGFuZCBgc2NvcGVgIGFyZQogICAgICogICAvLyBhdmFpbGFibGUgaW4gdGhlIGN1cnJlbnQgbGV4aWNhbCBzY29wZSAodGhleSBjb3VsZCBoYXZlIGJlZW4gaW5qZWN0ZWQgb3IgcGFzc2VkIGluKS4KICAgICAqCiAgICAgKiAgIGZ1bmN0aW9uIGFzeW5jR3JlZXQobmFtZSkgewogICAgICogICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7CiAgICAgKgogICAgICogICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgICAvLyBzaW5jZSB0aGlzIGZuIGV4ZWN1dGVzIGFzeW5jIGluIGEgZnV0dXJlIHR1cm4gb2YgdGhlIGV2ZW50IGxvb3AsIHdlIG5lZWQgdG8gd3JhcAogICAgICogICAgICAgLy8gb3VyIGNvZGUgaW50byBhbiAkYXBwbHkgY2FsbCBzbyB0aGF0IHRoZSBtb2RlbCBjaGFuZ2VzIGFyZSBwcm9wZXJseSBvYnNlcnZlZC4KICAgICAqICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAqICAgICAgICAgZGVmZXJyZWQubm90aWZ5KCdBYm91dCB0byBncmVldCAnICsgbmFtZSArICcuJyk7CiAgICAgKgogICAgICogICAgICAgICBpZiAob2tUb0dyZWV0KG5hbWUpKSB7CiAgICAgKiAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgnSGVsbG8sICcgKyBuYW1lICsgJyEnKTsKICAgICAqICAgICAgICAgfSBlbHNlIHsKICAgICAqICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoJ0dyZWV0aW5nICcgKyBuYW1lICsgJyBpcyBub3QgYWxsb3dlZC4nKTsKICAgICAqICAgICAgICAgfQogICAgICogICAgICAgfSk7CiAgICAgKiAgICAgfSwgMTAwMCk7CiAgICAgKgogICAgICogICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogICAgICogICB9CiAgICAgKgogICAgICogICB2YXIgcHJvbWlzZSA9IGFzeW5jR3JlZXQoJ1JvYmluIEhvb2QnKTsKICAgICAqICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICAgKiAgICAgYWxlcnQoJ1N1Y2Nlc3M6ICcgKyBncmVldGluZyk7CiAgICAgKiAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICogICAgIGFsZXJ0KCdGYWlsZWQ6ICcgKyByZWFzb24pOwogICAgICogICB9LCBmdW5jdGlvbih1cGRhdGUpIHsKICAgICAqICAgICBhbGVydCgnR290IG5vdGlmaWNhdGlvbjogJyArIHVwZGF0ZSk7CiAgICAgKiAgIH0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQXQgZmlyc3QgaXQgbWlnaHQgbm90IGJlIG9idmlvdXMgd2h5IHRoaXMgZXh0cmEgY29tcGxleGl0eSBpcyB3b3J0aCB0aGUgdHJvdWJsZS4gVGhlIHBheW9mZgogICAgICogY29tZXMgaW4gdGhlIHdheSBvZgogICAgICogW2d1YXJhbnRlZXMgdGhhdCBwcm9taXNlIGFuZCBkZWZlcnJlZCBBUElzIG1ha2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvdW5jb21tb25qcy9ibG9iL21hc3Rlci9wcm9taXNlcy9zcGVjaWZpY2F0aW9uLm1kKS4KICAgICAqCiAgICAgKiBBZGRpdGlvbmFsbHkgdGhlIHByb21pc2UgYXBpIGFsbG93cyBmb3IgY29tcG9zaXRpb24gdGhhdCBpcyB2ZXJ5IGhhcmQgdG8gZG8gd2l0aCB0aGUKICAgICAqIHRyYWRpdGlvbmFsIGNhbGxiYWNrIChbQ1BTXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0NvbnRpbnVhdGlvbi1wYXNzaW5nX3N0eWxlKSkgYXBwcm9hY2guCiAgICAgKiBGb3IgbW9yZSBvbiB0aGlzIHBsZWFzZSBzZWUgdGhlIFtRIGRvY3VtZW50YXRpb25dKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcSkgZXNwZWNpYWxseSB0aGUKICAgICAqIHNlY3Rpb24gb24gc2VyaWFsIG9yIHBhcmFsbGVsIGpvaW5pbmcgb2YgcHJvbWlzZXMuCiAgICAgKgogICAgICoKICAgICAqICMgVGhlIERlZmVycmVkIEFQSQogICAgICoKICAgICAqIEEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkIGlzIGNvbnN0cnVjdGVkIGJ5IGNhbGxpbmcgYCRxLmRlZmVyKClgLgogICAgICoKICAgICAqIFRoZSBwdXJwb3NlIG9mIHRoZSBkZWZlcnJlZCBvYmplY3QgaXMgdG8gZXhwb3NlIHRoZSBhc3NvY2lhdGVkIFByb21pc2UgaW5zdGFuY2UgYXMgd2VsbCBhcyBBUElzCiAgICAgKiB0aGF0IGNhbiBiZSB1c2VkIGZvciBzaWduYWxpbmcgdGhlIHN1Y2Nlc3NmdWwgb3IgdW5zdWNjZXNzZnVsIGNvbXBsZXRpb24sIGFzIHdlbGwgYXMgdGhlIHN0YXR1cwogICAgICogb2YgdGhlIHRhc2suCiAgICAgKgogICAgICogKipNZXRob2RzKioKICAgICAqCiAgICAgKiAtIGByZXNvbHZlKHZhbHVlKWAg4oCTIHJlc29sdmVzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHZhbHVlYC4gSWYgdGhlIHZhbHVlIGlzIGEgcmVqZWN0aW9uCiAgICAgKiAgIGNvbnN0cnVjdGVkIHZpYSBgJHEucmVqZWN0YCwgdGhlIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCBpbnN0ZWFkLgogICAgICogLSBgcmVqZWN0KHJlYXNvbilgIOKAkyByZWplY3RzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHJlYXNvbmAuIFRoaXMgaXMgZXF1aXZhbGVudCB0bwogICAgICogICByZXNvbHZpbmcgaXQgd2l0aCBhIHJlamVjdGlvbiBjb25zdHJ1Y3RlZCB2aWEgYCRxLnJlamVjdGAuCiAgICAgKiAtIGBub3RpZnkodmFsdWUpYCAtIHByb3ZpZGVzIHVwZGF0ZXMgb24gdGhlIHN0YXR1cyBvZiB0aGUgcHJvbWlzZXMgZXhlY3V0aW9uLiBUaGlzIG1heSBiZSBjYWxsZWQKICAgICAqICAgbXVsdGlwbGUgdGltZXMgYmVmb3JlIHRoZSBwcm9taXNlIGlzIGVpdGhlciByZXNvbHZlZCBvciByZWplY3RlZC4KICAgICAqCiAgICAgKiAqKlByb3BlcnRpZXMqKgogICAgICoKICAgICAqIC0gcHJvbWlzZSDigJMgYHtQcm9taXNlfWAg4oCTIHByb21pc2Ugb2JqZWN0IGFzc29jaWF0ZWQgd2l0aCB0aGlzIGRlZmVycmVkLgogICAgICoKICAgICAqCiAgICAgKiAjIFRoZSBQcm9taXNlIEFQSQogICAgICoKICAgICAqIEEgbmV3IHByb21pc2UgaW5zdGFuY2UgaXMgY3JlYXRlZCB3aGVuIGEgZGVmZXJyZWQgaW5zdGFuY2UgaXMgY3JlYXRlZCBhbmQgY2FuIGJlIHJldHJpZXZlZCBieQogICAgICogY2FsbGluZyBgZGVmZXJyZWQucHJvbWlzZWAuCiAgICAgKgogICAgICogVGhlIHB1cnBvc2Ugb2YgdGhlIHByb21pc2Ugb2JqZWN0IGlzIHRvIGFsbG93IGZvciBpbnRlcmVzdGVkIHBhcnRpZXMgdG8gZ2V0IGFjY2VzcyB0byB0aGUgcmVzdWx0CiAgICAgKiBvZiB0aGUgZGVmZXJyZWQgdGFzayB3aGVuIGl0IGNvbXBsZXRlcy4KICAgICAqCiAgICAgKiAqKk1ldGhvZHMqKgogICAgICoKICAgICAqIC0gYHRoZW4oc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrLCBub3RpZnlDYWxsYmFjaylgIOKAkyByZWdhcmRsZXNzIG9mIHdoZW4gdGhlIHByb21pc2Ugd2FzIG9yCiAgICAgKiAgIHdpbGwgYmUgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQsIGB0aGVuYCBjYWxscyBvbmUgb2YgdGhlIHN1Y2Nlc3Mgb3IgZXJyb3IgY2FsbGJhY2tzIGFzeW5jaHJvbm91c2x5CiAgICAgKiAgIGFzIHNvb24gYXMgdGhlIHJlc3VsdCBpcyBhdmFpbGFibGUuIFRoZSBjYWxsYmFja3MgYXJlIGNhbGxlZCB3aXRoIGEgc2luZ2xlIGFyZ3VtZW50OiB0aGUgcmVzdWx0CiAgICAgKiAgIG9yIHJlamVjdGlvbiByZWFzb24uIEFkZGl0aW9uYWxseSwgdGhlIG5vdGlmeSBjYWxsYmFjayBtYXkgYmUgY2FsbGVkIHplcm8gb3IgbW9yZSB0aW1lcyB0bwogICAgICogICBwcm92aWRlIGEgcHJvZ3Jlc3MgaW5kaWNhdGlvbiwgYmVmb3JlIHRoZSBwcm9taXNlIGlzIHJlc29sdmVkIG9yIHJlamVjdGVkLgogICAgICoKICAgICAqICAgVGhpcyBtZXRob2QgKnJldHVybnMgYSBuZXcgcHJvbWlzZSogd2hpY2ggaXMgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQgdmlhIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlCiAgICAgKiAgIGBzdWNjZXNzQ2FsbGJhY2tgLCBgZXJyb3JDYWxsYmFja2AuIEl0IGFsc28gbm90aWZpZXMgdmlhIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGBub3RpZnlDYWxsYmFja2AKICAgICAqICAgbWV0aG9kLiBUaGUgcHJvbWlzZSBjYW4gbm90IGJlIHJlc29sdmVkIG9yIHJlamVjdGVkIGZyb20gdGhlIG5vdGlmeUNhbGxiYWNrIG1ldGhvZC4KICAgICAqCiAgICAgKiAtIGBjYXRjaChlcnJvckNhbGxiYWNrKWAg4oCTIHNob3J0aGFuZCBmb3IgYHByb21pc2UudGhlbihudWxsLCBlcnJvckNhbGxiYWNrKWAKICAgICAqCiAgICAgKiAtIGBmaW5hbGx5KGNhbGxiYWNrKWAg4oCTIGFsbG93cyB5b3UgdG8gb2JzZXJ2ZSBlaXRoZXIgdGhlIGZ1bGZpbGxtZW50IG9yIHJlamVjdGlvbiBvZiBhIHByb21pc2UsCiAgICAgKiAgIGJ1dCB0byBkbyBzbyB3aXRob3V0IG1vZGlmeWluZyB0aGUgZmluYWwgdmFsdWUuIFRoaXMgaXMgdXNlZnVsIHRvIHJlbGVhc2UgcmVzb3VyY2VzIG9yIGRvIHNvbWUKICAgICAqICAgY2xlYW4tdXAgdGhhdCBuZWVkcyB0byBiZSBkb25lIHdoZXRoZXIgdGhlIHByb21pc2Ugd2FzIHJlamVjdGVkIG9yIHJlc29sdmVkLiBTZWUgdGhlIFtmdWxsCiAgICAgKiAgIHNwZWNpZmljYXRpb25dKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcS93aWtpL0FQSS1SZWZlcmVuY2UjcHJvbWlzZWZpbmFsbHljYWxsYmFjaykgZm9yCiAgICAgKiAgIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgKgogICAgICogICBCZWNhdXNlIGBmaW5hbGx5YCBpcyBhIHJlc2VydmVkIHdvcmQgaW4gSmF2YVNjcmlwdCBhbmQgcmVzZXJ2ZWQga2V5d29yZHMgYXJlIG5vdCBzdXBwb3J0ZWQgYXMKICAgICAqICAgcHJvcGVydHkgbmFtZXMgYnkgRVMzLCB5b3UnbGwgbmVlZCB0byBpbnZva2UgdGhlIG1ldGhvZCBsaWtlIGBwcm9taXNlWydmaW5hbGx5J10oY2FsbGJhY2spYCB0bwogICAgICogICBtYWtlIHlvdXIgY29kZSBJRTggY29tcGF0aWJsZS4KICAgICAqCiAgICAgKiAjIENoYWluaW5nIHByb21pc2VzCiAgICAgKgogICAgICogQmVjYXVzZSBjYWxsaW5nIHRoZSBgdGhlbmAgbWV0aG9kIG9mIGEgcHJvbWlzZSByZXR1cm5zIGEgbmV3IGRlcml2ZWQgcHJvbWlzZSwgaXQgaXMgZWFzaWx5IHBvc3NpYmxlCiAgICAgKiB0byBjcmVhdGUgYSBjaGFpbiBvZiBwcm9taXNlczoKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICBwcm9taXNlQiA9IHByb21pc2VBLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgKiAgICAgcmV0dXJuIHJlc3VsdCArIDE7CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gcHJvbWlzZUIgd2lsbCBiZSByZXNvbHZlZCBpbW1lZGlhdGVseSBhZnRlciBwcm9taXNlQSBpcyByZXNvbHZlZCBhbmQgaXRzIHZhbHVlCiAgICAgKiAgIC8vIHdpbGwgYmUgdGhlIHJlc3VsdCBvZiBwcm9taXNlQSBpbmNyZW1lbnRlZCBieSAxCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBJdCBpcyBwb3NzaWJsZSB0byBjcmVhdGUgY2hhaW5zIG9mIGFueSBsZW5ndGggYW5kIHNpbmNlIGEgcHJvbWlzZSBjYW4gYmUgcmVzb2x2ZWQgd2l0aCBhbm90aGVyCiAgICAgKiBwcm9taXNlICh3aGljaCB3aWxsIGRlZmVyIGl0cyByZXNvbHV0aW9uIGZ1cnRoZXIpLCBpdCBpcyBwb3NzaWJsZSB0byBwYXVzZS9kZWZlciByZXNvbHV0aW9uIG9mCiAgICAgKiB0aGUgcHJvbWlzZXMgYXQgYW55IHBvaW50IGluIHRoZSBjaGFpbi4gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSB0byBpbXBsZW1lbnQgcG93ZXJmdWwgQVBJcyBsaWtlCiAgICAgKiAkaHR0cCdzIHJlc3BvbnNlIGludGVyY2VwdG9ycy4KICAgICAqCiAgICAgKgogICAgICogIyBEaWZmZXJlbmNlcyBiZXR3ZWVuIEtyaXMgS293YWwncyBRIGFuZCAkcQogICAgICoKICAgICAqICBUaGVyZSBhcmUgdGhyZWUgbWFpbiBkaWZmZXJlbmNlczoKICAgICAqCiAgICAgKiAtICRxIGlzIGludGVncmF0ZWQgd2l0aCB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGV9IFNjb3BlIG1vZGVsIG9ic2VydmF0aW9uCiAgICAgKiAgIG1lY2hhbmlzbSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyBmYXN0ZXIgcHJvcGFnYXRpb24gb2YgcmVzb2x1dGlvbiBvciByZWplY3Rpb24gaW50byB5b3VyCiAgICAgKiAgIG1vZGVscyBhbmQgYXZvaWRpbmcgdW5uZWNlc3NhcnkgYnJvd3NlciByZXBhaW50cywgd2hpY2ggd291bGQgcmVzdWx0IGluIGZsaWNrZXJpbmcgVUkuCiAgICAgKiAtICRxIHByb21pc2VzIGFyZSByZWNvZ25pemVkIGJ5IHRoZSB0ZW1wbGF0aW5nIGVuZ2luZSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyB0aGF0IGluIHRlbXBsYXRlcwogICAgICogICB5b3UgY2FuIHRyZWF0IHByb21pc2VzIGF0dGFjaGVkIHRvIGEgc2NvcGUgYXMgaWYgdGhleSB3ZXJlIHRoZSByZXN1bHRpbmcgdmFsdWVzLgogICAgICogLSBRIGhhcyBtYW55IG1vcmUgZmVhdHVyZXMgdGhhbiAkcSwgYnV0IHRoYXQgY29tZXMgYXQgYSBjb3N0IG9mIGJ5dGVzLiAkcSBpcyB0aW55LCBidXQgY29udGFpbnMKICAgICAqICAgYWxsIHRoZSBpbXBvcnRhbnQgZnVuY3Rpb25hbGl0eSBuZWVkZWQgZm9yIGNvbW1vbiBhc3luYyB0YXNrcy4KICAgICAqCiAgICAgKiAgIyBUZXN0aW5nCiAgICAgKgogICAgICogIDxwcmU+CiAgICAgKiAgICBpdCgnc2hvdWxkIHNpbXVsYXRlIHByb21pc2UnLCBpbmplY3QoZnVuY3Rpb24oJHEsICRyb290U2NvcGUpIHsKICAgICAqICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTsKICAgICAqICAgICAgdmFyIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlOwogICAgICogICAgICB2YXIgcmVzb2x2ZWRWYWx1ZTsKICAgICAqCiAgICAgKiAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSkgeyByZXNvbHZlZFZhbHVlID0gdmFsdWU7IH0pOwogICAgICogICAgICBleHBlY3QocmVzb2x2ZWRWYWx1ZSkudG9CZVVuZGVmaW5lZCgpOwogICAgICoKICAgICAqICAgICAgLy8gU2ltdWxhdGUgcmVzb2x2aW5nIG9mIHByb21pc2UKICAgICAqICAgICAgZGVmZXJyZWQucmVzb2x2ZSgxMjMpOwogICAgICogICAgICAvLyBOb3RlIHRoYXQgdGhlICd0aGVuJyBmdW5jdGlvbiBkb2VzIG5vdCBnZXQgY2FsbGVkIHN5bmNocm9ub3VzbHkuCiAgICAgKiAgICAgIC8vIFRoaXMgaXMgYmVjYXVzZSB3ZSB3YW50IHRoZSBwcm9taXNlIEFQSSB0byBhbHdheXMgYmUgYXN5bmMsIHdoZXRoZXIgb3Igbm90CiAgICAgKiAgICAgIC8vIGl0IGdvdCBjYWxsZWQgc3luY2hyb25vdXNseSBvciBhc3luY2hyb25vdXNseS4KICAgICAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvQmVVbmRlZmluZWQoKTsKICAgICAqCiAgICAgKiAgICAgIC8vIFByb3BhZ2F0ZSBwcm9taXNlIHJlc29sdXRpb24gdG8gJ3RoZW4nIGZ1bmN0aW9ucyB1c2luZyAkYXBwbHkoKS4KICAgICAqICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvRXF1YWwoMTIzKTsKICAgICAqICAgIH0pOwogICAgICogIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiAkUVByb3ZpZGVyKCkgewoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCBmdW5jdGlvbiAoJHJvb3RTY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHFGYWN0b3J5KGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGNhbGxiYWNrKTsKICAgICAgICAgICAgfSwgJGV4Y2VwdGlvbkhhbmRsZXIpOwogICAgICAgIH1dOwogICAgfQoKCiAgICAvKioKICAgICAqIENvbnN0cnVjdHMgYSBwcm9taXNlIG1hbmFnZXIuCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbihmdW5jdGlvbil9IG5leHRUaWNrIEZ1bmN0aW9uIGZvciBleGVjdXRpbmcgZnVuY3Rpb25zIGluIHRoZSBuZXh0IHR1cm4uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKC4uLiopfSBleGNlcHRpb25IYW5kbGVyIEZ1bmN0aW9uIGludG8gd2hpY2ggdW5leHBlY3RlZCBleGNlcHRpb25zIGFyZSBwYXNzZWQgZm9yCiAgICAgKiAgICAgZGVidWdnaW5nIHB1cnBvc2VzLgogICAgICogQHJldHVybnMge29iamVjdH0gUHJvbWlzZSBtYW5hZ2VyLgogICAgICovCiAgICBmdW5jdGlvbiBxRmFjdG9yeShuZXh0VGljaywgZXhjZXB0aW9uSGFuZGxlcikgewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MKICAgICAgICAgKiBAbmFtZSBuZy4kcSNkZWZlcgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENyZWF0ZXMgYSBgRGVmZXJyZWRgIG9iamVjdCB3aGljaCByZXByZXNlbnRzIGEgdGFzayB3aGljaCB3aWxsIGZpbmlzaCBpbiB0aGUgZnV0dXJlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0RlZmVycmVkfSBSZXR1cm5zIGEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkLgogICAgICAgICAqLwogICAgICAgIHZhciBkZWZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBbXSwKICAgICAgICAgICAgICAgIHZhbHVlLCBkZWZlcnJlZDsKCiAgICAgICAgICAgIGRlZmVycmVkID0gewoKICAgICAgICAgICAgICAgIHJlc29sdmU6IGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGVuZGluZykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gcGVuZGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgcGVuZGluZyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSByZWYodmFsKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGNhbGxiYWNrcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2tzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS50aGVuKGNhbGxiYWNrWzBdLCBjYWxsYmFja1sxXSwgY2FsbGJhY2tbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgcmVqZWN0OiBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZWplY3QocmVhc29uKSk7CiAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICBub3RpZnk6IGZ1bmN0aW9uIChwcm9ncmVzcykgewogICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBwZW5kaW5nOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmcubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGNhbGxiYWNrcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2tzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja1syXShwcm9ncmVzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICBwcm9taXNlOiB7CiAgICAgICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9ncmVzc2JhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKChpc0Z1bmN0aW9uKGNhbGxiYWNrKSA/IGNhbGxiYWNrIDogZGVmYXVsdENhbGxiYWNrKSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZWplY3QoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3cmFwcGVkRXJyYmFjayA9IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGlzRnVuY3Rpb24oZXJyYmFjaykgPyBlcnJiYWNrIDogZGVmYXVsdEVycmJhY2spKHJlYXNvbikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZWplY3QoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3cmFwcGVkUHJvZ3Jlc3NiYWNrID0gZnVuY3Rpb24gKHByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5ub3RpZnkoKGlzRnVuY3Rpb24ocHJvZ3Jlc3NiYWNrKSA/IHByb2dyZXNzYmFjayA6IGRlZmF1bHRDYWxsYmFjaykocHJvZ3Jlc3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmcucHVzaChbd3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFjaywgd3JhcHBlZFByb2dyZXNzYmFja10pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUudGhlbih3cmFwcGVkQ2FsbGJhY2ssIHdyYXBwZWRFcnJiYWNrLCB3cmFwcGVkUHJvZ3Jlc3NiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgICJjYXRjaCI6IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50aGVuKG51bGwsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAiZmluYWxseSI6IGZ1bmN0aW9uIChjYWxsYmFjaykgewoKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gbWFrZVByb21pc2UodmFsdWUsIHJlc29sdmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNvbHZlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlamVjdCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNhbGxiYWNrKHZhbHVlLCBpc1Jlc29sdmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tPdXRwdXQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja091dHB1dCA9IChjYWxsYmFjayB8fCBkZWZhdWx0Q2FsbGJhY2spKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VQcm9taXNlKGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja091dHB1dCAmJiBpc0Z1bmN0aW9uKGNhbGxiYWNrT3V0cHV0LnRoZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrT3V0cHV0LnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWFrZVByb21pc2UodmFsdWUsIGlzUmVzb2x2ZWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWFrZVByb21pc2UoZXJyb3IsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VQcm9taXNlKHZhbHVlLCBpc1Jlc29sdmVkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGVDYWxsYmFjayh2YWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUNhbGxiYWNrKGVycm9yLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZDsKICAgICAgICB9OwoKCiAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUgJiYgaXNGdW5jdGlvbih2YWx1ZS50aGVuKSkgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZShjYWxsYmFjayh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjcmVqZWN0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRxCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ3JlYXRlcyBhIHByb21pc2UgdGhhdCBpcyByZXNvbHZlZCBhcyByZWplY3RlZCB3aXRoIHRoZSBzcGVjaWZpZWQgYHJlYXNvbmAuIFRoaXMgYXBpIHNob3VsZCBiZQogICAgICAgICAqIHVzZWQgdG8gZm9yd2FyZCByZWplY3Rpb24gaW4gYSBjaGFpbiBvZiBwcm9taXNlcy4gSWYgeW91IGFyZSBkZWFsaW5nIHdpdGggdGhlIGxhc3QgcHJvbWlzZSBpbgogICAgICAgICAqIGEgcHJvbWlzZSBjaGFpbiwgeW91IGRvbid0IG5lZWQgdG8gd29ycnkgYWJvdXQgaXQuCiAgICAgICAgICoKICAgICAgICAgKiBXaGVuIGNvbXBhcmluZyBkZWZlcnJlZHMvcHJvbWlzZXMgdG8gdGhlIGZhbWlsaWFyIGJlaGF2aW9yIG9mIHRyeS9jYXRjaC90aHJvdywgdGhpbmsgb2YKICAgICAgICAgKiBgcmVqZWN0YCBhcyB0aGUgYHRocm93YCBrZXl3b3JkIGluIEphdmFTY3JpcHQuIFRoaXMgYWxzbyBtZWFucyB0aGF0IGlmIHlvdSAiY2F0Y2giIGFuIGVycm9yIHZpYQogICAgICAgICAqIGEgcHJvbWlzZSBlcnJvciBjYWxsYmFjayBhbmQgeW91IHdhbnQgdG8gZm9yd2FyZCB0aGUgZXJyb3IgdG8gdGhlIHByb21pc2UgZGVyaXZlZCBmcm9tIHRoZQogICAgICAgICAqIGN1cnJlbnQgcHJvbWlzZSwgeW91IGhhdmUgdG8gInJldGhyb3ciIHRoZSBlcnJvciBieSByZXR1cm5pbmcgYSByZWplY3Rpb24gY29uc3RydWN0ZWQgdmlhCiAgICAgICAgICogYHJlamVjdGAuCiAgICAgICAgICoKICAgICAgICAgKiA8cHJlPgogICAgICAgICAqICAgcHJvbWlzZUIgPSBwcm9taXNlQS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAqICAgICAvLyBzdWNjZXNzOiBkbyBzb21ldGhpbmcgYW5kIHJlc29sdmUgcHJvbWlzZUIKICAgICAgICAgKiAgICAgLy8gICAgICAgICAgd2l0aCB0aGUgb2xkIG9yIGEgbmV3IHJlc3VsdAogICAgICAgICAqICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAqICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICogICAgIC8vIGVycm9yOiBoYW5kbGUgdGhlIGVycm9yIGlmIHBvc3NpYmxlIGFuZAogICAgICAgICAqICAgICAvLyAgICAgICAgcmVzb2x2ZSBwcm9taXNlQiB3aXRoIG5ld1Byb21pc2VPclZhbHVlLAogICAgICAgICAqICAgICAvLyAgICAgICAgb3RoZXJ3aXNlIGZvcndhcmQgdGhlIHJlamVjdGlvbiB0byBwcm9taXNlQgogICAgICAgICAqICAgICBpZiAoY2FuSGFuZGxlKHJlYXNvbikpIHsKICAgICAgICAgKiAgICAgIC8vIGhhbmRsZSB0aGUgZXJyb3IgYW5kIHJlY292ZXIKICAgICAgICAgKiAgICAgIHJldHVybiBuZXdQcm9taXNlT3JWYWx1ZTsKICAgICAgICAgKiAgICAgfQogICAgICAgICAqICAgICByZXR1cm4gJHEucmVqZWN0KHJlYXNvbik7CiAgICAgICAgICogICB9KTsKICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7Kn0gcmVhc29uIENvbnN0YW50LCBtZXNzYWdlLCBleGNlcHRpb24gb3IgYW4gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcmVqZWN0aW9uIHJlYXNvbi4KICAgICAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHByb21pc2UgdGhhdCB3YXMgYWxyZWFkeSByZXNvbHZlZCBhcyByZWplY3RlZCB3aXRoIHRoZSBgcmVhc29uYC4KICAgICAgICAgKi8KICAgICAgICB2YXIgcmVqZWN0ID0gZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrLCBlcnJiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGlzRnVuY3Rpb24oZXJyYmFjaykgPyBlcnJiYWNrIDogZGVmYXVsdEVycmJhY2spKHJlYXNvbikpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjd2hlbgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFdyYXBzIGFuIG9iamVjdCB0aGF0IG1pZ2h0IGJlIGEgdmFsdWUgb3IgYSAoM3JkIHBhcnR5KSB0aGVuLWFibGUgcHJvbWlzZSBpbnRvIGEgJHEgcHJvbWlzZS4KICAgICAgICAgKiBUaGlzIGlzIHVzZWZ1bCB3aGVuIHlvdSBhcmUgZGVhbGluZyB3aXRoIGFuIG9iamVjdCB0aGF0IG1pZ2h0IG9yIG1pZ2h0IG5vdCBiZSBhIHByb21pc2UsIG9yIGlmCiAgICAgICAgICogdGhlIHByb21pc2UgY29tZXMgZnJvbSBhIHNvdXJjZSB0aGF0IGNhbid0IGJlIHRydXN0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFZhbHVlIG9yIGEgcHJvbWlzZQogICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgcHJvbWlzZSBvZiB0aGUgcGFzc2VkIHZhbHVlIG9yIHByb21pc2UKICAgICAgICAgKi8KICAgICAgICB2YXIgd2hlbiA9IGZ1bmN0aW9uICh2YWx1ZSwgY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzYmFjaykgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKSwKICAgICAgICAgICAgICAgIGRvbmU7CgogICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoaXNGdW5jdGlvbihjYWxsYmFjaykgPyBjYWxsYmFjayA6IGRlZmF1bHRDYWxsYmFjaykodmFsdWUpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciB3cmFwcGVkRXJyYmFjayA9IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChpc0Z1bmN0aW9uKGVycmJhY2spID8gZXJyYmFjayA6IGRlZmF1bHRFcnJiYWNrKShyZWFzb24pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciB3cmFwcGVkUHJvZ3Jlc3NiYWNrID0gZnVuY3Rpb24gKHByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoaXNGdW5jdGlvbihwcm9ncmVzc2JhY2spID8gcHJvZ3Jlc3NiYWNrIDogZGVmYXVsdENhbGxiYWNrKShwcm9ncmVzcyk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJlZih2YWx1ZSkudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKHJlZih2YWx1ZSkudGhlbih3cmFwcGVkQ2FsbGJhY2ssIHdyYXBwZWRFcnJiYWNrLCB3cmFwcGVkUHJvZ3Jlc3NiYWNrKSk7CiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbmUpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSh3cmFwcGVkRXJyYmFjayhyZWFzb24pKTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChwcm9ncmVzcykgewogICAgICAgICAgICAgICAgICAgIGlmIChkb25lKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lm5vdGlmeSh3cmFwcGVkUHJvZ3Jlc3NiYWNrKHByb2dyZXNzKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgfTsKCgogICAgICAgIGZ1bmN0aW9uIGRlZmF1bHRDYWxsYmFjayh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQoKCiAgICAgICAgZnVuY3Rpb24gZGVmYXVsdEVycmJhY2socmVhc29uKSB7CiAgICAgICAgICAgIHJldHVybiByZWplY3QocmVhc29uKTsKICAgICAgICB9CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MKICAgICAgICAgKiBAbmFtZSBuZy4kcSNhbGwKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHEKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDb21iaW5lcyBtdWx0aXBsZSBwcm9taXNlcyBpbnRvIGEgc2luZ2xlIHByb21pc2UgdGhhdCBpcyByZXNvbHZlZCB3aGVuIGFsbCBvZiB0aGUgaW5wdXQKICAgICAgICAgKiBwcm9taXNlcyBhcmUgcmVzb2x2ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0FycmF5LjxQcm9taXNlPnxPYmplY3QuPFByb21pc2U+fSBwcm9taXNlcyBBbiBhcnJheSBvciBoYXNoIG9mIHByb21pc2VzLgogICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgc2luZ2xlIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdpdGggYW4gYXJyYXkvaGFzaCBvZiB2YWx1ZXMsCiAgICAgICAgICogICBlYWNoIHZhbHVlIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHByb21pc2UgYXQgdGhlIHNhbWUgaW5kZXgva2V5IGluIHRoZSBgcHJvbWlzZXNgIGFycmF5L2hhc2guIElmIGFueSBvZgogICAgICAgICAqICAgdGhlIHByb21pc2VzIGlzIHJlc29sdmVkIHdpdGggYSByZWplY3Rpb24sIHRoaXMgcmVzdWx0aW5nIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aXRoIHRoZQogICAgICAgICAqICAgc2FtZSByZWplY3Rpb24uCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gYWxsKHByb21pc2VzKSB7CiAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9IGRlZmVyKCksCiAgICAgICAgICAgICAgICBjb3VudGVyID0gMCwKICAgICAgICAgICAgICAgIHJlc3VsdHMgPSBpc0FycmF5KHByb21pc2VzKSA/IFtdIDoge307CgogICAgICAgICAgICBmb3JFYWNoKHByb21pc2VzLCBmdW5jdGlvbiAocHJvbWlzZSwga2V5KSB7CiAgICAgICAgICAgICAgICBjb3VudGVyKys7CiAgICAgICAgICAgICAgICByZWYocHJvbWlzZSkudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1trZXldID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEoLS1jb3VudGVyKSkgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KHJlYXNvbik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoY291bnRlciA9PT0gMCkgewogICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBkZWZlcjogZGVmZXIsCiAgICAgICAgICAgIHJlamVjdDogcmVqZWN0LAogICAgICAgICAgICB3aGVuOiB3aGVuLAogICAgICAgICAgICBhbGw6IGFsbAogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBERVNJR04gTk9URVMKICAgICAqCiAgICAgKiBUaGUgZGVzaWduIGRlY2lzaW9ucyBiZWhpbmQgdGhlIHNjb3BlIGFyZSBoZWF2aWx5IGZhdm9yZWQgZm9yIHNwZWVkIGFuZCBtZW1vcnkgY29uc3VtcHRpb24uCiAgICAgKgogICAgICogVGhlIHR5cGljYWwgdXNlIG9mIHNjb3BlIGlzIHRvIHdhdGNoIHRoZSBleHByZXNzaW9ucywgd2hpY2ggbW9zdCBvZiB0aGUgdGltZSByZXR1cm4gdGhlIHNhbWUKICAgICAqIHZhbHVlIGFzIGxhc3QgdGltZSBzbyB3ZSBvcHRpbWl6ZSB0aGUgb3BlcmF0aW9uLgogICAgICoKICAgICAqIENsb3N1cmVzIGNvbnN0cnVjdGlvbiBpcyBleHBlbnNpdmUgaW4gdGVybXMgb2Ygc3BlZWQgYXMgd2VsbCBhcyBtZW1vcnk6CiAgICAgKiAgIC0gTm8gY2xvc3VyZXMsIGluc3RlYWQgdXNlIHByb3RvdHlwaWNhbCBpbmhlcml0YW5jZSBmb3IgQVBJCiAgICAgKiAgIC0gSW50ZXJuYWwgc3RhdGUgbmVlZHMgdG8gYmUgc3RvcmVkIG9uIHNjb3BlIGRpcmVjdGx5LCB3aGljaCBtZWFucyB0aGF0IHByaXZhdGUgc3RhdGUgaXMKICAgICAqICAgICBleHBvc2VkIGFzICQkX19fXyBwcm9wZXJ0aWVzCiAgICAgKgogICAgICogTG9vcCBvcGVyYXRpb25zIGFyZSBvcHRpbWl6ZWQgYnkgdXNpbmcgd2hpbGUoY291bnQtLSkgeyAuLi4gfQogICAgICogICAtIHRoaXMgbWVhbnMgdGhhdCBpbiBvcmRlciB0byBrZWVwIHRoZSBzYW1lIG9yZGVyIG9mIGV4ZWN1dGlvbiBhcyBhZGRpdGlvbiB3ZSBoYXZlIHRvIGFkZAogICAgICogICAgIGl0ZW1zIHRvIHRoZSBhcnJheSBhdCB0aGUgYmVnaW5uaW5nIChzaGlmdCkgaW5zdGVhZCBvZiBhdCB0aGUgZW5kIChwdXNoKQogICAgICoKICAgICAqIENoaWxkIHNjb3BlcyBhcmUgY3JlYXRlZCBhbmQgcmVtb3ZlZCBvZnRlbgogICAgICogICAtIFVzaW5nIGFuIGFycmF5IHdvdWxkIGJlIHNsb3cgc2luY2UgaW5zZXJ0cyBpbiBtaWRkbGUgYXJlIGV4cGVuc2l2ZSBzbyB3ZSB1c2UgbGlua2VkIGxpc3QKICAgICAqCiAgICAgKiBUaGVyZSBhcmUgZmV3IHdhdGNoZXMgdGhlbiBhIGxvdCBvZiBvYnNlcnZlcnMuIFRoaXMgaXMgd2h5IHlvdSBkb24ndCB3YW50IHRoZSBvYnNlcnZlciB0byBiZQogICAgICogaW1wbGVtZW50ZWQgaW4gdGhlIHNhbWUgd2F5IGFzIHdhdGNoLiBXYXRjaCByZXF1aXJlcyByZXR1cm4gb2YgaW5pdGlhbGl6YXRpb24gZnVuY3Rpb24gd2hpY2gKICAgICAqIGFyZSBleHBlbnNpdmUgdG8gY29uc3RydWN0LgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJHJvb3RTY29wZVByb3ZpZGVyCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBQcm92aWRlciBmb3IgdGhlICRyb290U2NvcGUgc2VydmljZS4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlUHJvdmlkZXIjZGlnZXN0VHRsCiAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZVByb3ZpZGVyCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBTZXRzIHRoZSBudW1iZXIgb2YgZGlnZXN0IGl0ZXJhdGlvbnMgdGhlIHNjb3BlIHNob3VsZCBhdHRlbXB0IHRvIGV4ZWN1dGUgYmVmb3JlIGdpdmluZyB1cCBhbmQKICAgICAqIGFzc3VtaW5nIHRoYXQgdGhlIG1vZGVsIGlzIHVuc3RhYmxlLgogICAgICoKICAgICAqIFRoZSBjdXJyZW50IGRlZmF1bHQgaXMgMTAgaXRlcmF0aW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbGltaXQgVGhlIG51bWJlciBvZiBkaWdlc3QgaXRlcmF0aW9ucy4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEV2ZXJ5IGFwcGxpY2F0aW9uIGhhcyBhIHNpbmdsZSByb290IHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfS4KICAgICAqIEFsbCBvdGhlciBzY29wZXMgYXJlIGNoaWxkIHNjb3BlcyBvZiB0aGUgcm9vdCBzY29wZS4gU2NvcGVzIHByb3ZpZGUgbWVjaGFuaXNtIGZvciB3YXRjaGluZyB0aGUgbW9kZWwgYW5kIHByb3ZpZGUKICAgICAqIGV2ZW50IHByb2Nlc3NpbmcgbGlmZS1jeWNsZS4gU2VlIHtAbGluayBndWlkZS9zY29wZSBkZXZlbG9wZXIgZ3VpZGUgb24gc2NvcGVzfS4KICAgICAqLwogICAgZnVuY3Rpb24gJFJvb3RTY29wZVByb3ZpZGVyKCkgewogICAgICAgIHZhciBUVEwgPSAxMDsKICAgICAgICB2YXIgJHJvb3RTY29wZU1pbkVyciA9IG1pbkVycignJHJvb3RTY29wZScpOwoKICAgICAgICB0aGlzLmRpZ2VzdFR0bCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgVFRMID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFRUTDsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsICckZXhjZXB0aW9uSGFuZGxlcicsICckcGFyc2UnLCAnJGJyb3dzZXInLAogICAgICAgICAgICBmdW5jdGlvbiAoJGluamVjdG9yLCAkZXhjZXB0aW9uSGFuZGxlciwgJHBhcnNlLCAkYnJvd3NlcikgewoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBBIHJvb3Qgc2NvcGUgY2FuIGJlIHJldHJpZXZlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUgJHJvb3RTY29wZX0ga2V5IGZyb20gdGhlCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgQVVUTy4kaW5qZWN0b3IgJGluamVjdG9yfS4gQ2hpbGQgc2NvcGVzIGFyZSBjcmVhdGVkIHVzaW5nIHRoZQogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG5ldyAkbmV3KCl9IG1ldGhvZC4gKE1vc3Qgc2NvcGVzIGFyZSBjcmVhdGVkIGF1dG9tYXRpY2FsbHkgd2hlbgogICAgICAgICAgICAgICAgICogY29tcGlsZWQgSFRNTCB0ZW1wbGF0ZSBpcyBleGVjdXRlZC4pCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogSGVyZSBpcyBhIHNpbXBsZSBzY29wZSBzbmlwcGV0IHRvIHNob3cgaG93IHlvdSBjYW4gaW50ZXJhY3Qgd2l0aCB0aGUgc2NvcGUuCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogPGZpbGUgc3JjPSIuL3Rlc3Qvbmcvcm9vdFNjb3BlU3BlYy5qcyIgdGFnPSJkb2NzMSIgLz4KICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgSW5oZXJpdGFuY2UKICAgICAgICAgICAgICAgICAqIEEgc2NvcGUgY2FuIGluaGVyaXQgZnJvbSBhIHBhcmVudCBzY29wZSwgYXMgaW4gdGhpcyBleGFtcGxlOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9ICRyb290U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudC4kbmV3KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICBwYXJlbnQuc2FsdXRhdGlvbiA9ICJIZWxsbyI7CiAgICAgICAgICAgICAgICAgICAgIGNoaWxkLm5hbWUgPSAiV29ybGQiOwogICAgICAgICAgICAgICAgICAgICBleHBlY3QoY2hpbGQuc2FsdXRhdGlvbikudG9FcXVhbCgnSGVsbG8nKTsKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIGNoaWxkLnNhbHV0YXRpb24gPSAiV2VsY29tZSI7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChjaGlsZC5zYWx1dGF0aW9uKS50b0VxdWFsKCdXZWxjb21lJyk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChwYXJlbnQuc2FsdXRhdGlvbikudG9FcXVhbCgnSGVsbG8nKTsKICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCBmdW5jdGlvbigpPj19IHByb3ZpZGVycyBNYXAgb2Ygc2VydmljZSBmYWN0b3J5IHdoaWNoIG5lZWQgdG8gYmUgcHJvdmlkZWQKICAgICAgICAgICAgICAgICAqICAgICBmb3IgdGhlIGN1cnJlbnQgc2NvcGUuIERlZmF1bHRzIHRvIHtAbGluayBuZ30uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCAqPj19IGluc3RhbmNlQ2FjaGUgUHJvdmlkZXMgcHJlLWluc3RhbnRpYXRlZCBzZXJ2aWNlcyB3aGljaCBzaG91bGQKICAgICAgICAgICAgICAgICAqICAgICBhcHBlbmQvb3ZlcnJpZGUgc2VydmljZXMgcHJvdmlkZWQgYnkgYHByb3ZpZGVyc2AuIFRoaXMgaXMgaGFuZHkgd2hlbiB1bml0LXRlc3RpbmcgYW5kIGhhdmluZwogICAgICAgICAgICAgICAgICogICAgIHRoZSBuZWVkIHRvIG92ZXJyaWRlIGEgZGVmYXVsdCBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICogQHJldHVybnMge09iamVjdH0gTmV3bHkgY3JlYXRlZCBzY29wZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIFNjb3BlKCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGlkID0gbmV4dFVpZCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRwaGFzZSA9IHRoaXMuJHBhcmVudCA9IHRoaXMuJCR3YXRjaGVycyA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRIZWFkID0gdGhpcy4kJGNoaWxkVGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgdGhpc1sndGhpcyddID0gdGhpcy4kcm9vdCA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGRlc3Ryb3llZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRhc3luY1F1ZXVlID0gW107CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJHBvc3REaWdlc3RRdWV1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRsaXN0ZW5lcnMgPSB7fTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkaXNvbGF0ZUJpbmRpbmdzID0ge307CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGlkCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHlPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBVbmlxdWUgc2NvcGUgSUQgKG1vbm90b25pY2FsbHkgaW5jcmVhc2luZyBhbHBoYW51bWVyaWMgc2VxdWVuY2UpIHVzZWZ1bCBmb3IKICAgICAgICAgICAgICAgICAqICAgZGVidWdnaW5nLgogICAgICAgICAgICAgICAgICovCgoKICAgICAgICAgICAgICAgIFNjb3BlLnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgICAgICAgICBjb25zdHJ1Y3RvcjogU2NvcGUsCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkbmV3CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgY2hpbGQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIHBhcmVudCBzY29wZSB3aWxsIHByb3BhZ2F0ZSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZAogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBldmVudHMuIFRoZSBzY29wZSBjYW4gYmUgcmVtb3ZlZCBmcm9tIHRoZSBzY29wZQogICAgICAgICAgICAgICAgICAgICAqIGhpZXJhcmNoeSB1c2luZyB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveSAkZGVzdHJveSgpfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9IG11c3QgYmUgY2FsbGVkIG9uIGEgc2NvcGUgd2hlbiBpdCBpcyBkZXNpcmVkIGZvcgogICAgICAgICAgICAgICAgICAgICAqIHRoZSBzY29wZSBhbmQgaXRzIGNoaWxkIHNjb3BlcyB0byBiZSBwZXJtYW5lbnRseSBkZXRhY2hlZCBmcm9tIHRoZSBwYXJlbnQgYW5kIHRodXMgc3RvcAogICAgICAgICAgICAgICAgICAgICAqIHBhcnRpY2lwYXRpbmcgaW4gbW9kZWwgY2hhbmdlIGRldGVjdGlvbiBhbmQgbGlzdGVuZXIgbm90aWZpY2F0aW9uIGJ5IGludm9raW5nLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFufSBpc29sYXRlIGlmIHRydWUgdGhlbiB0aGUgc2NvcGUgZG9lcyBub3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdCBmcm9tIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgcGFyZW50IHNjb3BlLiBUaGUgc2NvcGUgaXMgaXNvbGF0ZWQsIGFzIGl0IGNhbiBub3Qgc2VlIHBhcmVudCBzY29wZSBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgV2hlbiBjcmVhdGluZyB3aWRnZXRzIGl0IGlzIHVzZWZ1bCBmb3IgdGhlIHdpZGdldCB0byBub3QgYWNjaWRlbnRhbGx5IHJlYWQgcGFyZW50CiAgICAgICAgICAgICAgICAgICAgICogICAgICAgICBzdGF0ZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXdseSBjcmVhdGVkIGNoaWxkIHNjb3BlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG5ldzogZnVuY3Rpb24gKGlzb2xhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIENoaWxkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNvbGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBuZXcgU2NvcGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiRyb290ID0gdGhpcy4kcm9vdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVuc3VyZSB0aGF0IHRoZXJlIGlzIGp1c3Qgb25lIGFzeW5jIHF1ZXVlIHBlciAkcm9vdFNjb3BlIGFuZCBpdCdzIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kJGFzeW5jUXVldWUgPSB0aGlzLiQkYXN5bmNRdWV1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiQkcG9zdERpZ2VzdFF1ZXVlID0gdGhpcy4kJHBvc3REaWdlc3RRdWV1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIENoaWxkID0gZnVuY3Rpb24gKCkgeyB9OyAvLyBzaG91bGQgYmUgYW5vbnltb3VzOyBUaGlzIGlzIHNvIHRoYXQgd2hlbiB0aGUgbWluaWZpZXIgbXVuZ2VzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgbmFtZSBpdCBkb2VzIG5vdCBiZWNvbWUgcmFuZG9tIHNldCBvZiBjaGFycy4gVGhlc2Ugd2lsbCB0aGVuIHNob3cgdXAgYXMgY2xhc3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5hbWUgaW4gdGhlIGRlYnVnZ2VyLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2hpbGQucHJvdG90eXBlID0gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkID0gbmV3IENoaWxkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kaWQgPSBuZXh0VWlkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRbJ3RoaXMnXSA9IGNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kJGxpc3RlbmVycyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kcGFyZW50ID0gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCR3YXRjaGVycyA9IGNoaWxkLiQkbmV4dFNpYmxpbmcgPSBjaGlsZC4kJGNoaWxkSGVhZCA9IGNoaWxkLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCRwcmV2U2libGluZyA9IHRoaXMuJCRjaGlsZFRhaWw7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiQkY2hpbGRIZWFkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRUYWlsLiQkbmV4dFNpYmxpbmcgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFJlZ2lzdGVycyBhIGBsaXN0ZW5lcmAgY2FsbGJhY2sgdG8gYmUgZXhlY3V0ZWQgd2hlbmV2ZXIgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGNoYW5nZXMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSBgd2F0Y2hFeHByZXNzaW9uYCBpcyBjYWxsZWQgb24gZXZlcnkgY2FsbCB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gYW5kCiAgICAgICAgICAgICAgICAgICAgICogICBzaG91bGQgcmV0dXJuIHRoZSB2YWx1ZSB3aGljaCB3aWxsIGJlIHdhdGNoZWQuIChTaW5jZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0KICAgICAgICAgICAgICAgICAgICAgKiAgIHJlcnVucyB3aGVuIGl0IGRldGVjdHMgY2hhbmdlcyB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2FuIGV4ZWN1dGUgbXVsdGlwbGUgdGltZXMgcGVyCiAgICAgICAgICAgICAgICAgICAgICogICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gYW5kIHNob3VsZCBiZSBpZGVtcG90ZW50LikKICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCBvbmx5IHdoZW4gdGhlIHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgYHdhdGNoRXhwcmVzc2lvbmAgYW5kIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgcHJldmlvdXMgY2FsbCB0byBgd2F0Y2hFeHByZXNzaW9uYCBhcmUgbm90IGVxdWFsICh3aXRoIHRoZSBleGNlcHRpb24gb2YgdGhlIGluaXRpYWwgcnVuLAogICAgICAgICAgICAgICAgICAgICAqICAgc2VlIGJlbG93KS4gVGhlIGluZXF1YWxpdHkgaXMgZGV0ZXJtaW5lZCBhY2NvcmRpbmcgdG8KICAgICAgICAgICAgICAgICAgICAgKiAgIHtAbGluayBhbmd1bGFyLmVxdWFsc30gZnVuY3Rpb24uIFRvIHNhdmUgdGhlIHZhbHVlIG9mIHRoZSBvYmplY3QgZm9yIGxhdGVyIGNvbXBhcmlzb24sIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAge0BsaW5rIGFuZ3VsYXIuY29weX0gZnVuY3Rpb24gaXMgdXNlZC4gSXQgYWxzbyBtZWFucyB0aGF0IHdhdGNoaW5nIGNvbXBsZXggb3B0aW9ucyB3aWxsCiAgICAgICAgICAgICAgICAgICAgICogICBoYXZlIGFkdmVyc2UgbWVtb3J5IGFuZCBwZXJmb3JtYW5jZSBpbXBsaWNhdGlvbnMuCiAgICAgICAgICAgICAgICAgICAgICogLSBUaGUgd2F0Y2ggYGxpc3RlbmVyYCBtYXkgY2hhbmdlIHRoZSBtb2RlbCwgd2hpY2ggbWF5IHRyaWdnZXIgb3RoZXIgYGxpc3RlbmVyYHMgdG8gZmlyZS4gVGhpcwogICAgICAgICAgICAgICAgICAgICAqICAgaXMgYWNoaWV2ZWQgYnkgcmVydW5uaW5nIHRoZSB3YXRjaGVycyB1bnRpbCBubyBjaGFuZ2VzIGFyZSBkZXRlY3RlZC4gVGhlIHJlcnVuIGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAqICAgbGltaXQgaXMgMTAgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wIGRlYWRsb2NrLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBJZiB5b3Ugd2FudCB0byBiZSBub3RpZmllZCB3aGVuZXZlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGlzIGNhbGxlZCwKICAgICAgICAgICAgICAgICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gd2l0aCBubyBgbGlzdGVuZXJgLiAoU2luY2UgYHdhdGNoRXhwcmVzc2lvbmAKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gZXhlY3V0ZSBtdWx0aXBsZSB0aW1lcyBwZXIge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBjeWNsZSB3aGVuIGEgY2hhbmdlIGlzCiAgICAgICAgICAgICAgICAgICAgICogZGV0ZWN0ZWQsIGJlIHByZXBhcmVkIGZvciBtdWx0aXBsZSBjYWxscyB0byB5b3VyIGxpc3RlbmVyLikKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEFmdGVyIGEgd2F0Y2hlciBpcyByZWdpc3RlcmVkIHdpdGggdGhlIHNjb3BlLCB0aGUgYGxpc3RlbmVyYCBmbiBpcyBjYWxsZWQgYXN5bmNocm9ub3VzbHkKICAgICAgICAgICAgICAgICAgICAgKiAodmlhIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMgJGV2YWxBc3luY30pIHRvIGluaXRpYWxpemUgdGhlCiAgICAgICAgICAgICAgICAgICAgICogd2F0Y2hlci4gSW4gcmFyZSBjYXNlcywgdGhpcyBpcyB1bmRlc2lyYWJsZSBiZWNhdXNlIHRoZSBsaXN0ZW5lciBpcyBjYWxsZWQgd2hlbiB0aGUgcmVzdWx0CiAgICAgICAgICAgICAgICAgICAgICogb2YgYHdhdGNoRXhwcmVzc2lvbmAgZGlkbid0IGNoYW5nZS4gVG8gZGV0ZWN0IHRoaXMgc2NlbmFyaW8gd2l0aGluIHRoZSBgbGlzdGVuZXJgIGZuLCB5b3UKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gY29tcGFyZSB0aGUgYG5ld1ZhbGAgYW5kIGBvbGRWYWxgLiBJZiB0aGVzZSB0d28gdmFsdWVzIGFyZSBpZGVudGljYWwgKGA9PT1gKSB0aGVuIHRoZQogICAgICAgICAgICAgICAgICAgICAqIGxpc3RlbmVyIHdhcyBjYWxsZWQgZHVlIHRvIGluaXRpYWxpemF0aW9uLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAjIEV4YW1wbGUKICAgICAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGV0J3MgYXNzdW1lIHRoYXQgc2NvcGUgd2FzIGRlcGVuZGVuY3kgaW5qZWN0ZWQgYXMgdGhlICRyb290U2NvcGUKICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY29wZSA9ICRyb290U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSAwOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goJ25hbWUnLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsgc2NvcGUuY291bnRlciA9IHNjb3BlLmNvdW50ZXIgKyAxOyB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm8gdmFyaWFibGUgY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLm5hbWUgPSAnYWRhbSc7CiAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKICAgICAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfHN0cmluZyl9IHdhdGNoRXhwcmVzc2lvbiBFeHByZXNzaW9uIHRoYXQgaXMgZXZhbHVhdGVkIG9uIGVhY2gKICAgICAgICAgICAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlLiBBIGNoYW5nZSBpbiB0aGUgcmV0dXJuIHZhbHVlIHRyaWdnZXJzIGEKICAgICAgICAgICAgICAgICAgICAgKiAgICBjYWxsIHRvIHRoZSBgbGlzdGVuZXJgLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgc3RyaW5nYDogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259CiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogY2FsbGVkIHdpdGggY3VycmVudCBgc2NvcGVgIGFzIGEgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9uKCl8c3RyaW5nKT19IGxpc3RlbmVyIENhbGxiYWNrIGNhbGxlZCB3aGVuZXZlciB0aGUgcmV0dXJuIHZhbHVlIG9mCiAgICAgICAgICAgICAgICAgICAgICogICB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2hhbmdlcy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IEV2YWx1YXRlZCBhcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufQogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSwgc2NvcGUpYDogY2FsbGVkIHdpdGggY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWVzIGFzIHBhcmFtZXRlcnMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvYmplY3RFcXVhbGl0eSBDb21wYXJlIG9iamVjdCBmb3IgZXF1YWxpdHkgcmF0aGVyIHRoYW4gZm9yIHJlZmVyZW5jZS4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGZvciB0aGlzIGxpc3RlbmVyLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICR3YXRjaDogZnVuY3Rpb24gKHdhdGNoRXhwLCBsaXN0ZW5lciwgb2JqZWN0RXF1YWxpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldCA9IGNvbXBpbGVUb0ZuKHdhdGNoRXhwLCAnd2F0Y2gnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoZXIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm46IGxpc3RlbmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3Q6IGluaXRXYXRjaFZhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXQ6IGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHA6IHdhdGNoRXhwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVxOiAhIW9iamVjdEVxdWFsaXR5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW4gdGhlIGNhc2UgdXNlciBwYXNzIHN0cmluZywgd2UgbmVlZCB0byBjb21waWxlIGl0LCBkbyB3ZSByZWFsbHkgbmVlZCB0aGlzID8KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxpc3RlbkZuID0gY29tcGlsZVRvRm4obGlzdGVuZXIgfHwgbm9vcCwgJ2xpc3RlbmVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaGVyLmZuID0gZnVuY3Rpb24gKG5ld1ZhbCwgb2xkVmFsLCBzY29wZSkgeyBsaXN0ZW5GbihzY29wZSk7IH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygd2F0Y2hFeHAgPT0gJ3N0cmluZycgJiYgZ2V0LmNvbnN0YW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxGbiA9IHdhdGNoZXIuZm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaGVyLmZuID0gZnVuY3Rpb24gKG5ld1ZhbCwgb2xkVmFsLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsRm4uY2FsbCh0aGlzLCBuZXdWYWwsIG9sZFZhbCwgc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKGFycmF5LCB3YXRjaGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIHVzZSB1bnNoaWZ0IHNpbmNlIHdlIHVzZSBhIHdoaWxlIGxvb3AgaW4gJGRpZ2VzdCBmb3Igc3BlZWQuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSB3aGlsZSBsb29wIHJlYWRzIGluIHJldmVyc2Ugb3JkZXIuCiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LnVuc2hpZnQod2F0Y2hlcik7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUoYXJyYXksIHdhdGNoZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaENvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogU2hhbGxvdyB3YXRjaGVzIHRoZSBwcm9wZXJ0aWVzIG9mIGFuIG9iamVjdCBhbmQgZmlyZXMgd2hlbmV2ZXIgYW55IG9mIHRoZSBwcm9wZXJ0aWVzIGNoYW5nZQogICAgICAgICAgICAgICAgICAgICAqIChmb3IgYXJyYXlzIHRoaXMgaW1wbGllcyB3YXRjaGluZyB0aGUgYXJyYXkgaXRlbXMsIGZvciBvYmplY3QgbWFwcyB0aGlzIGltcGxpZXMgd2F0Y2hpbmcgdGhlIHByb3BlcnRpZXMpLgogICAgICAgICAgICAgICAgICAgICAqIElmIGEgY2hhbmdlIGlzIGRldGVjdGVkIHRoZSBgbGlzdGVuZXJgIGNhbGxiYWNrIGlzIGZpcmVkLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogLSBUaGUgYG9iamAgY29sbGVjdGlvbiBpcyBvYnNlcnZlZCB2aWEgc3RhbmRhcmQgJHdhdGNoIG9wZXJhdGlvbiBhbmQgaXMgZXhhbWluZWQgb24gZXZlcnkgY2FsbCB0byAkZGlnZXN0KCkgdG8KICAgICAgICAgICAgICAgICAgICAgKiAgIHNlZSBpZiBhbnkgaXRlbXMgaGF2ZSBiZWVuIGFkZGVkLCByZW1vdmVkLCBvciBtb3ZlZC4KICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCB3aGVuZXZlciBhbnl0aGluZyB3aXRoaW4gdGhlIGBvYmpgIGhhcyBjaGFuZ2VkLiBFeGFtcGxlcyBpbmNsdWRlIGFkZGluZyBuZXcgaXRlbXMKICAgICAgICAgICAgICAgICAgICAgKiAgIGludG8gdGhlIG9iamVjdCBvciBhcnJheSwgcmVtb3ZpbmcgYW5kIG1vdmluZyBpdGVtcyBhcm91bmQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgRXhhbXBsZQogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5uYW1lcyA9IFsnaWdvcicsICdtYXRpYXMnLCAnbWlza28nLCAnamFtZXMnXTsKICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmRhdGFDb3VudCA9IDQ7CiAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS4kd2F0Y2hDb2xsZWN0aW9uKCduYW1lcycsIGZ1bmN0aW9uKG5ld05hbWVzLCBvbGROYW1lcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5kYXRhQ291bnQgPSBuZXdOYW1lcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBleHBlY3QoJHNjb3BlLmRhdGFDb3VudCkudG9FcXVhbCg0KTsKICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy9zdGlsbCBhdCA0IC4uLiBubyBjaGFuZ2VzCiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdCgkc2NvcGUuZGF0YUNvdW50KS50b0VxdWFsKDQpOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUubmFtZXMucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vbm93IHRoZXJlJ3MgYmVlbiBhIGNoYW5nZQogICAgICAgICAgICAgICAgICAgICAgICBleHBlY3QoJHNjb3BlLmRhdGFDb3VudCkudG9FcXVhbCgzKTsKICAgICAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8RnVuY3Rpb24oc2NvcGUpfSBvYmogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LiBUaGUgZXhwcmVzc2lvbiB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAqICAgIHNob3VsZCBldmFsdWF0ZSB0byBhbiBvYmplY3Qgb3IgYW4gYXJyYXkgd2hpY2ggaXMgb2JzZXJ2ZWQgb24gZWFjaAogICAgICAgICAgICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUuIEFueSBzaGFsbG93IGNoYW5nZSB3aXRoaW4gdGhlIGNvbGxlY3Rpb24gd2lsbCB0cmlnZ2VyCiAgICAgICAgICAgICAgICAgICAgICogICAgYSBjYWxsIHRvIHRoZSBgbGlzdGVuZXJgLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihuZXdDb2xsZWN0aW9uLCBvbGRDb2xsZWN0aW9uLCBzY29wZSl9IGxpc3RlbmVyIGEgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBpcyBmaXJlZCB3aXRoIGJvdGgKICAgICAgICAgICAgICAgICAgICAgKiAgICB0aGUgYG5ld0NvbGxlY3Rpb25gIGFuZCBgb2xkQ29sbGVjdGlvbmAgYXMgcGFyYW1ldGVycy4KICAgICAgICAgICAgICAgICAgICAgKiAgICBUaGUgYG5ld0NvbGxlY3Rpb25gIG9iamVjdCBpcyB0aGUgbmV3bHkgbW9kaWZpZWQgZGF0YSBvYnRhaW5lZCBmcm9tIHRoZSBgb2JqYCBleHByZXNzaW9uIGFuZCB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgICBgb2xkQ29sbGVjdGlvbmAgb2JqZWN0IGlzIGEgY29weSBvZiB0aGUgZm9ybWVyIGNvbGxlY3Rpb24gZGF0YS4KICAgICAgICAgICAgICAgICAgICAgKiAgICBUaGUgYHNjb3BlYCByZWZlcnMgdG8gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlLXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4gV2hlbiB0aGUgZGUtcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkCiAgICAgICAgICAgICAgICAgICAgICogdGhlbiB0aGUgaW50ZXJuYWwgd2F0Y2ggb3BlcmF0aW9uIGlzIHRlcm1pbmF0ZWQuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJHdhdGNoQ29sbGVjdGlvbjogZnVuY3Rpb24gKG9iaiwgbGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2xkVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoYW5nZURldGVjdGVkID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9iakdldHRlciA9ICRwYXJzZShvYmopOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJuYWxBcnJheSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJuYWxPYmplY3QgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZExlbmd0aCA9IDA7CgogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAkd2F0Y2hDb2xsZWN0aW9uV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdWYWx1ZSA9IG9iakdldHRlcihzZWxmKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdMZW5ndGgsIGtleTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzT2JqZWN0KG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXlMaWtlKG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gaW50ZXJuYWxBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgdHJhbnNpdGlvbmluZyBmcm9tIHNvbWV0aGluZyB3aGljaCB3YXMgbm90IGFuIGFycmF5IGludG8gYXJyYXkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZFZhbHVlID0gaW50ZXJuYWxBcnJheTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkTGVuZ3RoID0gb2xkVmFsdWUubGVuZ3RoID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0xlbmd0aCA9IG5ld1ZhbHVlLmxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZExlbmd0aCAhPT0gbmV3TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGxlbmd0aHMgZG8gbm90IG1hdGNoIHdlIG5lZWQgdG8gdHJpZ2dlciBjaGFuZ2Ugbm90aWZpY2F0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZFZhbHVlLmxlbmd0aCA9IG9sZExlbmd0aCA9IG5ld0xlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29weSB0aGUgaXRlbXMgdG8gb2xkVmFsdWUgYW5kIGxvb2sgZm9yIGNoYW5nZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdMZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob2xkVmFsdWVbaV0gIT09IG5ld1ZhbHVlW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWVbaV0gPSBuZXdWYWx1ZVtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBpbnRlcm5hbE9iamVjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgdHJhbnNpdGlvbmluZyBmcm9tIHNvbWV0aGluZyB3aGljaCB3YXMgbm90IGFuIG9iamVjdCBpbnRvIG9iamVjdC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWUgPSBpbnRlcm5hbE9iamVjdCA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRMZW5ndGggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IHRoZSBpdGVtcyB0byBvbGRWYWx1ZSBhbmQgbG9vayBmb3IgY2hhbmdlcy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdMZW5ndGggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdMZW5ndGgrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlW2tleV0gIT09IG5ld1ZhbHVlW2tleV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWVba2V5XSA9IG5ld1ZhbHVlW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRMZW5ndGgrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRWYWx1ZVtrZXldID0gbmV3VmFsdWVba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRMZW5ndGggPiBuZXdMZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgdXNlZCB0byBoYXZlIG1vcmUga2V5cywgbmVlZCB0byBmaW5kIHRoZW0gYW5kIGRlc3Ryb3kgdGhlbS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gb2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmICFuZXdWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkTGVuZ3RoLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG9sZFZhbHVlW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hhbmdlRGV0ZWN0ZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICR3YXRjaENvbGxlY3Rpb25BY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcihuZXdWYWx1ZSwgb2xkVmFsdWUsIHNlbGYpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kd2F0Y2goJHdhdGNoQ29sbGVjdGlvbldhdGNoLCAkd2F0Y2hDb2xsZWN0aW9uQWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogUHJvY2Vzc2VzIGFsbCBvZiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJzfSBvZiB0aGUgY3VycmVudCBzY29wZSBhbmQgaXRzIGNoaWxkcmVuLgogICAgICAgICAgICAgICAgICAgICAqIEJlY2F1c2UgYSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlcn0ncyBsaXN0ZW5lciBjYW4gY2hhbmdlIHRoZSBtb2RlbCwgdGhlCiAgICAgICAgICAgICAgICAgICAgICogYCRkaWdlc3QoKWAga2VlcHMgY2FsbGluZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJzfSB1bnRpbCBubyBtb3JlIGxpc3RlbmVycyBhcmUKICAgICAgICAgICAgICAgICAgICAgKiBmaXJpbmcuIFRoaXMgbWVhbnMgdGhhdCBpdCBpcyBwb3NzaWJsZSB0byBnZXQgaW50byBhbiBpbmZpbml0ZSBsb29wLiBUaGlzIGZ1bmN0aW9uIHdpbGwgdGhyb3cKICAgICAgICAgICAgICAgICAgICAgKiBgJ01heGltdW0gaXRlcmF0aW9uIGxpbWl0IGV4Y2VlZGVkLidgIGlmIHRoZSBudW1iZXIgb2YgaXRlcmF0aW9ucyBleGNlZWRzIDEwLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVXN1YWxseSB5b3UgZG9uJ3QgY2FsbCBgJGRpZ2VzdCgpYCBkaXJlY3RseSBpbgogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDb250cm9sbGVyIGNvbnRyb2xsZXJzfSBvciBpbgogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4KICAgICAgICAgICAgICAgICAgICAgKiBJbnN0ZWFkIGEgY2FsbCB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkYXBwbHkgJGFwcGx5KCl9ICh0eXBpY2FsbHkgZnJvbSB3aXRoaW4gYQogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSBkaXJlY3RpdmVzfSkgd2lsbCBmb3JjZSBhIGAkZGlnZXN0KClgLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogSWYgeW91IHdhbnQgdG8gYmUgbm90aWZpZWQgd2hlbmV2ZXIgYCRkaWdlc3QoKWAgaXMgY2FsbGVkLAogICAgICAgICAgICAgICAgICAgICAqIHlvdSBjYW4gcmVnaXN0ZXIgYSBgd2F0Y2hFeHByZXNzaW9uYCBmdW5jdGlvbiAgd2l0aCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggJHdhdGNoKCl9CiAgICAgICAgICAgICAgICAgICAgICogd2l0aCBubyBgbGlzdGVuZXJgLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogWW91IG1heSBoYXZlIGEgbmVlZCB0byBjYWxsIGAkZGlnZXN0KClgIGZyb20gd2l0aGluIHVuaXQtdGVzdHMsIHRvIHNpbXVsYXRlIHRoZSBzY29wZQogICAgICAgICAgICAgICAgICAgICAqIGxpZmUtY3ljbGUuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAjIEV4YW1wbGUKICAgICAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gLi4uOwogICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUubmFtZSA9ICdtaXNrbyc7CiAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gMDsKICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSBzY29wZS5jb3VudGVyICsgMTsKICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBubyB2YXJpYWJsZSBjaGFuZ2UKICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUubmFtZSA9ICdhZGFtJzsKICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGRpZ2VzdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgd2F0Y2gsIHZhbHVlLCBsYXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3luY1F1ZXVlID0gdGhpcy4kJGFzeW5jUXVldWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0RGlnZXN0UXVldWUgPSB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHksIHR0bCA9IFRUTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQsIGN1cnJlbnQsIHRhcmdldCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaExvZyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nSWR4LCBsb2dNc2c7CgogICAgICAgICAgICAgICAgICAgICAgICBiZWdpblBoYXNlKCckZGlnZXN0Jyk7CgogICAgICAgICAgICAgICAgICAgICAgICBkbyB7IC8vICJ3aGlsZSBkaXJ0eSIgbG9vcAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0YXJnZXQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGFzeW5jUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudC4kZXZhbChhc3luY1F1ZXVlLnNoaWZ0KCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsgLy8gInRyYXZlcnNlIHRoZSBzY29wZXMiIGxvb3AKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHdhdGNoZXJzID0gY3VycmVudC4kJHdhdGNoZXJzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwcm9jZXNzIG91ciB3YXRjaGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHdhdGNoZXJzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoID0gd2F0Y2hlcnNbbGVuZ3RoXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNb3N0IGNvbW1vbiB3YXRjaGVzIGFyZSBvbiBwcmltaXRpdmVzLCBpbiB3aGljaCBjYXNlIHdlIGNhbiBzaG9ydAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNpcmN1aXQgaXQgd2l0aCA9PT0gb3BlcmF0b3IsIG9ubHkgd2hlbiA9PT0gZmFpbHMgZG8gd2UgdXNlIC5lcXVhbHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2F0Y2ggJiYgKHZhbHVlID0gd2F0Y2guZ2V0KGN1cnJlbnQpKSAhPT0gKGxhc3QgPSB3YXRjaC5sYXN0KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAhKHdhdGNoLmVxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGVxdWFscyh2YWx1ZSwgbGFzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyAmJiB0eXBlb2YgbGFzdCA9PSAnbnVtYmVyJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgaXNOYU4odmFsdWUpICYmIGlzTmFOKGxhc3QpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5sYXN0ID0gd2F0Y2guZXEgPyBjb3B5KHZhbHVlKSA6IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5mbih2YWx1ZSwgKChsYXN0ID09PSBpbml0V2F0Y2hWYWwpID8gdmFsdWUgOiBsYXN0KSwgY3VycmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0dGwgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dJZHggPSA0IC0gdHRsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF3YXRjaExvZ1tsb2dJZHhdKSB3YXRjaExvZ1tsb2dJZHhdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgPSAoaXNGdW5jdGlvbih3YXRjaC5leHApKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ2ZuOiAnICsgKHdhdGNoLmV4cC5uYW1lIHx8IHdhdGNoLmV4cC50b1N0cmluZygpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogd2F0Y2guZXhwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nTXNnICs9ICc7IG5ld1ZhbDogJyArIHRvSnNvbih2YWx1ZSkgKyAnOyBvbGRWYWw6ICcgKyB0b0pzb24obGFzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaExvZ1tsb2dJZHhdLnB1c2gobG9nTXNnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5zYW5pdHkgV2FybmluZzogc2NvcGUgZGVwdGgtZmlyc3QgdHJhdmVyc2FsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8geWVzLCB0aGlzIGNvZGUgaXMgYSBiaXQgY3JhenksIGJ1dCBpdCB3b3JrcyBhbmQgd2UgaGF2ZSB0ZXN0cyB0byBwcm92ZSBpdCEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHBpZWNlIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgdHJhdmVyc2FsIGluICRicm9hZGNhc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShuZXh0ID0gKGN1cnJlbnQuJCRjaGlsZEhlYWQgfHwgKGN1cnJlbnQgIT09IHRhcmdldCAmJiBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgIT09IHRhcmdldCAmJiAhKG5leHQgPSBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC4kcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBuZXh0KSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcnR5ICYmICEodHRsLS0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93ICRyb290U2NvcGVNaW5FcnIoJ2luZmRpZycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7MH0gJGRpZ2VzdCgpIGl0ZXJhdGlvbnMgcmVhY2hlZC4gQWJvcnRpbmchXG5XYXRjaGVycyBmaXJlZCBpbiB0aGUgbGFzdCA1IGl0ZXJhdGlvbnM6IHsxfScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRUTCwgdG9Kc29uKHdhdGNoTG9nKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRpcnR5IHx8IGFzeW5jUXVldWUubGVuZ3RoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChwb3N0RGlnZXN0UXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3REaWdlc3RRdWV1ZS5zaGlmdCgpKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveQogICAgICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiBzY29wZSBiZWluZyBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEJyb2FkY2FzdGVkIHdoZW4gYSBzY29wZSBhbmQgaXRzIGNoaWxkcmVuIGFyZSBiZWluZyBkZXN0cm95ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBOb3RlIHRoYXQsIGluIEFuZ3VsYXJKUywgdGhlcmUgaXMgYWxzbyBhIGAkZGVzdHJveWAgalF1ZXJ5IGV2ZW50LCB3aGljaCBjYW4gYmUgdXNlZCB0bwogICAgICAgICAgICAgICAgICAgICAqIGNsZWFuIHVwIERPTSBiaW5kaW5ncyBiZWZvcmUgYW4gZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTS4KICAgICAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveQogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBSZW1vdmVzIHRoZSBjdXJyZW50IHNjb3BlIChhbmQgYWxsIG9mIGl0cyBjaGlsZHJlbikgZnJvbSB0aGUgcGFyZW50IHNjb3BlLiBSZW1vdmFsIGltcGxpZXMKICAgICAgICAgICAgICAgICAgICAgKiB0aGF0IGNhbGxzIHRvIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSB3aWxsIG5vIGxvbmdlcgogICAgICAgICAgICAgICAgICAgICAqIHByb3BhZ2F0ZSB0byB0aGUgY3VycmVudCBzY29wZSBhbmQgaXRzIGNoaWxkcmVuLiBSZW1vdmFsIGFsc28gaW1wbGllcyB0aGF0IHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAgICAgICogc2NvcGUgaXMgZWxpZ2libGUgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbi4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBgJGRlc3Ryb3koKWAgaXMgdXN1YWxseSB1c2VkIGJ5IGRpcmVjdGl2ZXMgc3VjaCBhcwogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9IGZvciBtYW5hZ2luZyB0aGUKICAgICAgICAgICAgICAgICAgICAgKiB1bnJvbGxpbmcgb2YgdGhlIGxvb3AuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBKdXN0IGJlZm9yZSBhIHNjb3BlIGlzIGRlc3Ryb3llZCBhIGAkZGVzdHJveWAgZXZlbnQgaXMgYnJvYWRjYXN0ZWQgb24gdGhpcyBzY29wZS4KICAgICAgICAgICAgICAgICAgICAgKiBBcHBsaWNhdGlvbiBjb2RlIGNhbiByZWdpc3RlciBhIGAkZGVzdHJveWAgZXZlbnQgaGFuZGxlciB0aGF0IHdpbGwgZ2l2ZSBpdCBjaGFuY2UgdG8KICAgICAgICAgICAgICAgICAgICAgKiBwZXJmb3JtIGFueSBuZWNlc3NhcnkgY2xlYW51cC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIE5vdGUgdGhhdCwgaW4gQW5ndWxhckpTLCB0aGVyZSBpcyBhbHNvIGEgYCRkZXN0cm95YCBqUXVlcnkgZXZlbnQsIHdoaWNoIGNhbiBiZSB1c2VkIHRvCiAgICAgICAgICAgICAgICAgICAgICogY2xlYW4gdXAgRE9NIGJpbmRpbmdzIGJlZm9yZSBhbiBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGNhbid0IGRlc3Ryb3kgdGhlIHJvb3Qgc2NvcGUgb3IgYSBzY29wZSB0aGF0IGhhcyBiZWVuIGFscmVhZHkgZGVzdHJveWVkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlID09IHRoaXMgfHwgdGhpcy4kJGRlc3Ryb3llZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy4kcGFyZW50OwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kYnJvYWRjYXN0KCckZGVzdHJveScpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZGVzdHJveWVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQuJCRjaGlsZEhlYWQgPT0gdGhpcykgcGFyZW50LiQkY2hpbGRIZWFkID0gdGhpcy4kJG5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LiQkY2hpbGRUYWlsID09IHRoaXMpIHBhcmVudC4kJGNoaWxkVGFpbCA9IHRoaXMuJCRwcmV2U2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJCRwcmV2U2libGluZykgdGhpcy4kJHByZXZTaWJsaW5nLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkbmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiQkbmV4dFNpYmxpbmcpIHRoaXMuJCRuZXh0U2libGluZy4kJHByZXZTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBib2d1cyBjb2RlIHRoYXQgd29ya3MgYXJvdW5kIENocm9tZSdzIEdDIGxlYWsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2VlOiBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy8xMzEzI2lzc3VlY29tbWVudC0xMDM3ODQ1MQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRwYXJlbnQgPSB0aGlzLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmcgPSB0aGlzLiQkY2hpbGRIZWFkID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGV2YWwKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogRXhlY3V0ZXMgdGhlIGBleHByZXNzaW9uYCBvbiB0aGUgY3VycmVudCBzY29wZSByZXR1cm5pbmcgdGhlIHJlc3VsdC4gQW55IGV4Y2VwdGlvbnMgaW4gdGhlCiAgICAgICAgICAgICAgICAgICAgICogZXhwcmVzc2lvbiBhcmUgcHJvcGFnYXRlZCAodW5jYXVnaHQpLiBUaGlzIGlzIHVzZWZ1bCB3aGVuIGV2YWx1YXRpbmcgQW5ndWxhciBleHByZXNzaW9ucy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgRXhhbXBsZQogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSBuZy4kcm9vdFNjb3BlLlNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5hID0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmIgPSAyOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKCdhK2InKSkudG9FcXVhbCgzKTsKICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbChmdW5jdGlvbihzY29wZSl7IHJldHVybiBzY29wZS5hICsgc2NvcGUuYjsgfSkpLnRvRXF1YWwoMyk7CiAgICAgICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4gIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBleHByZXNzaW9uLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRldmFsOiBmdW5jdGlvbiAoZXhwciwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcGFyc2UoZXhwcikodGhpcywgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogRXhlY3V0ZXMgdGhlIGV4cHJlc3Npb24gb24gdGhlIGN1cnJlbnQgc2NvcGUgYXQgYSBsYXRlciBwb2ludCBpbiB0aW1lLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIGAkZXZhbEFzeW5jYCBtYWtlcyBubyBndWFyYW50ZWVzIGFzIHRvIHdoZW4gdGhlIGBleHByZXNzaW9uYCB3aWxsIGJlIGV4ZWN1dGVkLCBvbmx5IHRoYXQ6CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgIC0gaXQgd2lsbCBleGVjdXRlIGFmdGVyIHRoZSBmdW5jdGlvbiB0aGF0IHNjaGVkdWxlIHRoZSBldmFsdWF0aW9uIGlzIGRvbmUgcnVubmluZyAocHJlZmVyYWJseSBiZWZvcmUgRE9NIHJlbmRlcmluZykuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGF0IGxlYXN0IG9uZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QgY3ljbGV9IHdpbGwgYmUgcGVyZm9ybWVkIGFmdGVyIGBleHByZXNzaW9uYCBleGVjdXRpb24uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9ucyBmcm9tIHRoZSBleGVjdXRpb24gb2YgdGhlIGV4cHJlc3Npb24gYXJlIGZvcndhcmRlZCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBfX05vdGU6X18gaWYgdGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgb3V0c2lkZSBvZiBgJGRpZ2VzdGAgY3ljbGUsIGEgbmV3ICRkaWdlc3QgY3ljbGUgd2lsbCBiZSBzY2hlZHVsZWQuCiAgICAgICAgICAgICAgICAgICAgICogSXQgaXMgaG93ZXZlciBlbmNvdXJhZ2VkIHRvIGFsd2F5cyBjYWxsIGNvZGUgdGhhdCBjaGFuZ2VzIHRoZSBtb2RlbCBmcm9tIHdpdGhpbmcgYW4gYCRhcHBseWAgY2FsbC4KICAgICAgICAgICAgICAgICAgICAgKiBUaGF0IGluY2x1ZGVzIGNvZGUgZXZhbHVhdGVkIHZpYSBgJGV2YWxBc3luY2AuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4gIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkZXZhbEFzeW5jOiBmdW5jdGlvbiAoZXhwcikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB3ZSBhcmUgb3V0c2lkZSBvZiBhbiAkZGlnZXN0IGxvb3AgYW5kIHRoaXMgaXMgdGhlIGZpcnN0IHRpbWUgd2UgYXJlIHNjaGVkdWxpbmcgYXN5bmMgdGFzayBhbHNvIHNjaGVkdWxlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFzeW5jIGF1dG8tZmx1c2gKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UgJiYgISRyb290U2NvcGUuJCRhc3luY1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiQkYXN5bmNRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRhc3luY1F1ZXVlLnB1c2goZXhwcik7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgJCRwb3N0RGlnZXN0OiBmdW5jdGlvbiAoZXhwcikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlLnB1c2goZXhwcik7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkYXBwbHkKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogYCRhcHBseSgpYCBpcyB1c2VkIHRvIGV4ZWN1dGUgYW4gZXhwcmVzc2lvbiBpbiBhbmd1bGFyIGZyb20gb3V0c2lkZSBvZiB0aGUgYW5ndWxhciBmcmFtZXdvcmsuCiAgICAgICAgICAgICAgICAgICAgICogKEZvciBleGFtcGxlIGZyb20gYnJvd3NlciBET00gZXZlbnRzLCBzZXRUaW1lb3V0LCBYSFIgb3IgdGhpcmQgcGFydHkgbGlicmFyaWVzKS4KICAgICAgICAgICAgICAgICAgICAgKiBCZWNhdXNlIHdlIGFyZSBjYWxsaW5nIGludG8gdGhlIGFuZ3VsYXIgZnJhbWV3b3JrIHdlIG5lZWQgdG8gcGVyZm9ybSBwcm9wZXIgc2NvcGUgbGlmZS1jeWNsZQogICAgICAgICAgICAgICAgICAgICAqIG9mIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciBleGNlcHRpb24gaGFuZGxpbmd9LAogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgZXhlY3V0aW5nIHdhdGNoZXN9LgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyMgTGlmZSBjeWNsZQogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyBQc2V1ZG8tQ29kZSBvZiBgJGFwcGx5KClgCiAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICRhcHBseShleHByKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRldmFsKGV4cHIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3QuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFNjb3BlJ3MgYCRhcHBseSgpYCBtZXRob2QgdHJhbnNpdGlvbnMgdGhyb3VnaCB0aGUgZm9sbG93aW5nIHN0YWdlczoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIDEuIFRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyBleGVjdXRlZCB1c2luZyB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbCAkZXZhbCgpfSBtZXRob2QuCiAgICAgICAgICAgICAgICAgICAgICogMi4gQW55IGV4Y2VwdGlvbnMgZnJvbSB0aGUgZXhlY3V0aW9uIG9mIHRoZSBleHByZXNzaW9uIGFyZSBmb3J3YXJkZWQgdG8gdGhlCiAgICAgICAgICAgICAgICAgICAgICogICAge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqIDMuIFRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2h9IGxpc3RlbmVycyBhcmUgZmlyZWQgaW1tZWRpYXRlbHkgYWZ0ZXIgdGhlIGV4cHJlc3Npb24KICAgICAgICAgICAgICAgICAgICAgKiAgICB3YXMgZXhlY3V0ZWQgdXNpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBtZXRob2QuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cCBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmVzdWx0IG9mIGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24uCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGFwcGx5OiBmdW5jdGlvbiAoZXhwcikgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW5QaGFzZSgnJGFwcGx5Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kZXZhbChleHByKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbgogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBMaXN0ZW5zIG9uIGV2ZW50cyBvZiBhIGdpdmVuIHR5cGUuIFNlZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZW1pdCAkZW1pdH0gZm9yIGRpc2N1c3Npb24gb2YKICAgICAgICAgICAgICAgICAgICAgKiBldmVudCBsaWZlIGN5Y2xlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIGV2ZW50IGxpc3RlbmVyIGZ1bmN0aW9uIGZvcm1hdCBpczogYGZ1bmN0aW9uKGV2ZW50LCBhcmdzLi4uKWAuIFRoZSBgZXZlbnRgIG9iamVjdAogICAgICAgICAgICAgICAgICAgICAqIHBhc3NlZCBpbnRvIHRoZSBsaXN0ZW5lciBoYXMgdGhlIGZvbGxvd2luZyBhdHRyaWJ1dGVzOgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAtIGB0YXJnZXRTY29wZWAgLSBge1Njb3BlfWA6IHRoZSBzY29wZSBvbiB3aGljaCB0aGUgZXZlbnQgd2FzIGAkZW1pdGAtZWQgb3IgYCRicm9hZGNhc3RgLWVkLgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgY3VycmVudFNjb3BlYCAtIGB7U2NvcGV9YDogdGhlIGN1cnJlbnQgc2NvcGUgd2hpY2ggaXMgaGFuZGxpbmcgdGhlIGV2ZW50LgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgbmFtZWAgLSBge3N0cmluZ31gOiBOYW1lIG9mIHRoZSBldmVudC4KICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYHN0b3BQcm9wYWdhdGlvbmAgLSBge2Z1bmN0aW9uPX1gOiBjYWxsaW5nIGBzdG9wUHJvcGFnYXRpb25gIGZ1bmN0aW9uIHdpbGwgY2FuY2VsIGZ1cnRoZXIgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgKiAgICAgcHJvcGFnYXRpb24gKGF2YWlsYWJsZSBvbmx5IGZvciBldmVudHMgdGhhdCB3ZXJlIGAkZW1pdGAtZWQpLgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgcHJldmVudERlZmF1bHRgIC0gYHtmdW5jdGlvbn1gOiBjYWxsaW5nIGBwcmV2ZW50RGVmYXVsdGAgc2V0cyBgZGVmYXVsdFByZXZlbnRlZGAgZmxhZyB0byB0cnVlLgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgZGVmYXVsdFByZXZlbnRlZGAgLSBge2Jvb2xlYW59YDogdHJ1ZSBpZiBgcHJldmVudERlZmF1bHRgIHdhcyBjYWxsZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGxpc3RlbiBvbi4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50LCBhcmdzLi4uKX0gbGlzdGVuZXIgRnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBldmVudCBpcyBlbWl0dGVkLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBSZXR1cm5zIGEgZGVyZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgbGlzdGVuZXIuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG9uOiBmdW5jdGlvbiAobmFtZSwgbGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWVkTGlzdGVuZXJzID0gdGhpcy4kJGxpc3RlbmVyc1tuYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFuYW1lZExpc3RlbmVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGxpc3RlbmVyc1tuYW1lXSA9IG5hbWVkTGlzdGVuZXJzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnNbaW5kZXhPZihuYW1lZExpc3RlbmVycywgbGlzdGVuZXIpXSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGVtaXQKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogRGlzcGF0Y2hlcyBhbiBldmVudCBgbmFtZWAgdXB3YXJkcyB0aHJvdWdoIHRoZSBzY29wZSBoaWVyYXJjaHkgbm90aWZ5aW5nIHRoZQogICAgICAgICAgICAgICAgICAgICAqIHJlZ2lzdGVyZWQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufSBsaXN0ZW5lcnMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgZXZlbnQgbGlmZSBjeWNsZSBzdGFydHMgYXQgdGhlIHNjb3BlIG9uIHdoaWNoIGAkZW1pdGAgd2FzIGNhbGxlZC4gQWxsCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gbGlzdGVuaW5nIGZvciBgbmFtZWAgZXZlbnQgb24gdGhpcyBzY29wZSBnZXQgbm90aWZpZWQuCiAgICAgICAgICAgICAgICAgICAgICogQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHRyYXZlcnNlcyB1cHdhcmRzIHRvd2FyZCB0aGUgcm9vdCBzY29wZSBhbmQgY2FsbHMgYWxsIHJlZ2lzdGVyZWQKICAgICAgICAgICAgICAgICAgICAgKiBsaXN0ZW5lcnMgYWxvbmcgdGhlIHdheS4gVGhlIGV2ZW50IHdpbGwgc3RvcCBwcm9wYWdhdGluZyBpZiBvbmUgb2YgdGhlIGxpc3RlbmVycyBjYW5jZWxzIGl0LgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQW55IGV4Y2VwdGlvbiBlbWl0dGVkIGZyb20gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IHdpbGwgYmUgcGFzc2VkCiAgICAgICAgICAgICAgICAgICAgICogb250byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBlbWl0LgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBzZXQgb2YgYXJndW1lbnRzIHdoaWNoIHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEV2ZW50IG9iamVjdCwgc2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkZW1pdDogZnVuY3Rpb24gKG5hbWUsIGFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVtcHR5ID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbiA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRTY29wZTogc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoKSB7IHN0b3BQcm9wYWdhdGlvbiA9IHRydWU7IH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyQXJncyA9IGNvbmNhdChbZXZlbnRdLCBhcmd1bWVudHMsIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSwgbGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMgPSBzY29wZS4kJGxpc3RlbmVyc1tuYW1lXSB8fCBlbXB0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IHNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gbmFtZWRMaXN0ZW5lcnMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgbGlzdGVuZXJzIHdlcmUgZGVyZWdpc3RlcmVkLCBkZWZyYWdtZW50IHRoZSBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbmFtZWRMaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3BQcm9wYWdhdGlvbikgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy90cmF2ZXJzZSB1cHdhcmRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IHNjb3BlLiRwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudDsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkYnJvYWRjYXN0CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIERpc3BhdGNoZXMgYW4gZXZlbnQgYG5hbWVgIGRvd253YXJkcyB0byBhbGwgY2hpbGQgc2NvcGVzIChhbmQgdGhlaXIgY2hpbGRyZW4pIG5vdGlmeWluZyB0aGUKICAgICAgICAgICAgICAgICAgICAgKiByZWdpc3RlcmVkIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0gbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIGV2ZW50IGxpZmUgY3ljbGUgc3RhcnRzIGF0IHRoZSBzY29wZSBvbiB3aGljaCBgJGJyb2FkY2FzdGAgd2FzIGNhbGxlZC4gQWxsCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gbGlzdGVuaW5nIGZvciBgbmFtZWAgZXZlbnQgb24gdGhpcyBzY29wZSBnZXQgbm90aWZpZWQuCiAgICAgICAgICAgICAgICAgICAgICogQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHByb3BhZ2F0ZXMgdG8gYWxsIGRpcmVjdCBhbmQgaW5kaXJlY3Qgc2NvcGVzIG9mIHRoZSBjdXJyZW50IHNjb3BlIGFuZAogICAgICAgICAgICAgICAgICAgICAqIGNhbGxzIGFsbCByZWdpc3RlcmVkIGxpc3RlbmVycyBhbG9uZyB0aGUgd2F5LiBUaGUgZXZlbnQgY2Fubm90IGJlIGNhbmNlbGVkLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQW55IGV4Y2VwdGlvbiBlbWl0dGVkIGZyb20gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IHdpbGwgYmUgcGFzc2VkCiAgICAgICAgICAgICAgICAgICAgICogb250byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBicm9hZGNhc3QuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIHNldCBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gRXZlbnQgb2JqZWN0LCBzZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRicm9hZGNhc3Q6IGZ1bmN0aW9uIChuYW1lLCBhcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRhcmdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSB0YXJnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFNjb3BlOiB0YXJnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyQXJncyA9IGNvbmNhdChbZXZlbnRdLCBhcmd1bWVudHMsIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLCBpLCBsZW5ndGg7CgogICAgICAgICAgICAgICAgICAgICAgICAvL2Rvd24gd2hpbGUgeW91IGNhbiwgdGhlbiB1cCBhbmQgbmV4dCBzaWJsaW5nIG9yIHVwIGFuZCBuZXh0IHNpYmxpbmcgdW50aWwgYmFjayBhdCByb290CiAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBuZXh0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuY3VycmVudFNjb3BlID0gY3VycmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycyA9IGN1cnJlbnQuJCRsaXN0ZW5lcnNbbmFtZV0gfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBsaXN0ZW5lcnMgd2VyZSBkZXJlZ2lzdGVyZWQsIGRlZnJhZ21lbnQgdGhlIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbnNhbml0eSBXYXJuaW5nOiBzY29wZSBkZXB0aC1maXJzdCB0cmF2ZXJzYWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHllcywgdGhpcyBjb2RlIGlzIGEgYml0IGNyYXp5LCBidXQgaXQgd29ya3MgYW5kIHdlIGhhdmUgdGVzdHMgdG8gcHJvdmUgaXQhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHBpZWNlIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgdHJhdmVyc2FsIGluICRkaWdlc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG5leHQgPSAoY3VycmVudC4kJGNoaWxkSGVhZCB8fCAoY3VycmVudCAhPT0gdGFyZ2V0ICYmIGN1cnJlbnQuJCRuZXh0U2libGluZykpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChjdXJyZW50ICE9PSB0YXJnZXQgJiYgIShuZXh0ID0gY3VycmVudC4kJG5leHRTaWJsaW5nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC4kcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBuZXh0KSk7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB2YXIgJHJvb3RTY29wZSA9IG5ldyBTY29wZSgpOwoKICAgICAgICAgICAgICAgIHJldHVybiAkcm9vdFNjb3BlOwoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBiZWdpblBoYXNlKHBoYXNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290U2NvcGUuJCRwaGFzZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkcm9vdFNjb3BlTWluRXJyKCdpbnByb2cnLCAnezB9IGFscmVhZHkgaW4gcHJvZ3Jlc3MnLCAkcm9vdFNjb3BlLiQkcGhhc2UpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kJHBoYXNlID0gcGhhc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY2xlYXJQaGFzZSgpIHsKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiQkcGhhc2UgPSBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVUb0ZuKGV4cCwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBmbiA9ICRwYXJzZShleHApOwogICAgICAgICAgICAgICAgICAgIGFzc2VydEFyZ0ZuKGZuLCBuYW1lKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBmdW5jdGlvbiB1c2VkIGFzIGFuIGluaXRpYWwgdmFsdWUgZm9yIHdhdGNoZXJzLgogICAgICAgICAgICAgICAgICogYmVjYXVzZSBpdCdzIHVuaXF1ZSB3ZSBjYW4gZWFzaWx5IHRlbGwgaXQgYXBhcnQgZnJvbSBvdGhlciB2YWx1ZXMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gaW5pdFdhdGNoVmFsKCkgeyB9CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIHZhciAkc2NlTWluRXJyID0gbWluRXJyKCckc2NlJyk7CgogICAgdmFyIFNDRV9DT05URVhUUyA9IHsKICAgICAgICBIVE1MOiAnaHRtbCcsCiAgICAgICAgQ1NTOiAnY3NzJywKICAgICAgICBVUkw6ICd1cmwnLAogICAgICAgIC8vIFJFU09VUkNFX1VSTCBpcyBhIHN1YnR5cGUgb2YgVVJMIHVzZWQgaW4gY29udGV4dHMgd2hlcmUgYSBwcml2aWxlZ2VkIHJlc291cmNlIGlzIHNvdXJjZWQgZnJvbSBhCiAgICAgICAgLy8gdXJsLiAgKGUuZy4gbmctaW5jbHVkZSwgc2NyaXB0IHNyYywgdGVtcGxhdGVVcmwpCiAgICAgICAgUkVTT1VSQ0VfVVJMOiAncmVzb3VyY2VVcmwnLAogICAgICAgIEpTOiAnanMnCiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgKiBAbmFtZSBuZy4kc2NlRGVsZWdhdGUKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIGAkc2NlRGVsZWdhdGVgIGlzIGEgc2VydmljZSB0aGF0IGlzIHVzZWQgYnkgdGhlIGAkc2NlYCBzZXJ2aWNlIHRvIHByb3ZpZGUge0BsaW5rIG5nLiRzY2UgU3RyaWN0CiAgICAgKiBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpfSBzZXJ2aWNlcyB0byBBbmd1bGFySlMuCiAgICAgKgogICAgICogVHlwaWNhbGx5LCB5b3Ugd291bGQgY29uZmlndXJlIG9yIG92ZXJyaWRlIHRoZSB7QGxpbmsgbmcuJHNjZURlbGVnYXRlICRzY2VEZWxlZ2F0ZX0gaW5zdGVhZCBvZgogICAgICogdGhlIGAkc2NlYCBzZXJ2aWNlIHRvIGN1c3RvbWl6ZSB0aGUgd2F5IFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIHdvcmtzIGluIEFuZ3VsYXJKUy4gIFRoaXMgaXMKICAgICAqIGJlY2F1c2UsIHdoaWxlIHRoZSBgJHNjZWAgcHJvdmlkZXMgbnVtZXJvdXMgc2hvcnRoYW5kIG1ldGhvZHMsIGV0Yy4sIHlvdSByZWFsbHkgb25seSBuZWVkIHRvCiAgICAgKiBvdmVycmlkZSAzIGNvcmUgZnVuY3Rpb25zIChgdHJ1c3RBc2AsIGBnZXRUcnVzdGVkYCBhbmQgYHZhbHVlT2ZgKSB0byByZXBsYWNlIHRoZSB3YXkgdGhpbmdzCiAgICAgKiB3b3JrIGJlY2F1c2UgYCRzY2VgIGRlbGVnYXRlcyB0byBgJHNjZURlbGVnYXRlYCBmb3IgdGhlc2Ugb3BlcmF0aW9ucy4KICAgICAqCiAgICAgKiBSZWZlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIgJHNjZURlbGVnYXRlUHJvdmlkZXJ9IHRvIGNvbmZpZ3VyZSB0aGlzIHNlcnZpY2UuCiAgICAgKgogICAgICogVGhlIGRlZmF1bHQgaW5zdGFuY2Ugb2YgYCRzY2VEZWxlZ2F0ZWAgc2hvdWxkIHdvcmsgb3V0IG9mIHRoZSBib3ggd2l0aCBsaXR0bGUgcGFpbi4gIFdoaWxlIHlvdQogICAgICogY2FuIG92ZXJyaWRlIGl0IGNvbXBsZXRlbHkgdG8gY2hhbmdlIHRoZSBiZWhhdmlvciBvZiBgJHNjZWAsIHRoZSBjb21tb24gY2FzZSB3b3VsZAogICAgICogaW52b2x2ZSBjb25maWd1cmluZyB0aGUge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyICRzY2VEZWxlZ2F0ZVByb3ZpZGVyfSBpbnN0ZWFkIGJ5IHNldHRpbmcKICAgICAqIHlvdXIgb3duIHdoaXRlbGlzdHMgYW5kIGJsYWNrbGlzdHMgZm9yIHRydXN0aW5nIFVSTHMgdXNlZCBmb3IgbG9hZGluZyBBbmd1bGFySlMgcmVzb3VyY2VzIHN1Y2ggYXMKICAgICAqIHRlbXBsYXRlcy4gIFJlZmVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdAogICAgICogJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxXaGl0ZWxpc3R9IGFuZCB7QGxpbmsKICAgICAqIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0ICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsQmxhY2tsaXN0fQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kc2NlRGVsZWdhdGVQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVGhlICRzY2VEZWxlZ2F0ZVByb3ZpZGVyIHByb3ZpZGVyIGFsbG93cyBkZXZlbG9wZXJzIHRvIGNvbmZpZ3VyZSB0aGUge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZQogICAgICogJHNjZURlbGVnYXRlfSBzZXJ2aWNlLiAgVGhpcyBhbGxvd3Mgb25lIHRvIGdldC9zZXQgdGhlIHdoaXRlbGlzdHMgYW5kIGJsYWNrbGlzdHMgdXNlZCB0byBlbnN1cmUKICAgICAqIHRoYXQgVVJMcyB1c2VkIGZvciBzb3VyY2luZyBBbmd1bGFyIHRlbXBsYXRlcyBhcmUgc2FmZS4gIFJlZmVyIHtAbGluawogICAgICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3QgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxXaGl0ZWxpc3R9IGFuZAogICAgICoge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0ICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsQmxhY2tsaXN0fQogICAgICoKICAgICAqIFJlYWQgbW9yZSBhYm91dCB7QGxpbmsgbmcuJHNjZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0uCiAgICAgKi8KCiAgICBmdW5jdGlvbiAkU2NlRGVsZWdhdGVQcm92aWRlcigpIHsKICAgICAgICB0aGlzLlNDRV9DT05URVhUUyA9IFNDRV9DT05URVhUUzsKCiAgICAgICAgLy8gUmVzb3VyY2UgVVJMcyBjYW4gYWxzbyBiZSB0cnVzdGVkIGJ5IHBvbGljeS4KICAgICAgICB2YXIgcmVzb3VyY2VVcmxXaGl0ZWxpc3QgPSBbJ3NlbGYnXSwKICAgICAgICAgICAgcmVzb3VyY2VVcmxCbGFja2xpc3QgPSBbXTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kc2NlRGVsZWdhdGVQcm92aWRlcgogICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBcnJheT19IHdoaXRlbGlzdCBXaGVuIHByb3ZpZGVkLCByZXBsYWNlcyB0aGUgcmVzb3VyY2VVcmxXaGl0ZWxpc3Qgd2l0aCB0aGUgdmFsdWUKICAgICAgICAgKiAgICAgcHJvdmlkZWQuICBUaGlzIG11c3QgYmUgYW4gYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiAgICAgRWFjaCBlbGVtZW50IG9mIHRoaXMgYXJyYXkgbXVzdCBlaXRoZXIgYmUgYSByZWdleCBvciB0aGUgc3BlY2lhbCBzdHJpbmcgYCdzZWxmJ2AuCiAgICAgICAgICoKICAgICAgICAgKiAgICAgV2hlbiBhIHJlZ2V4IGlzIHVzZWQsIGl0IGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgbm9ybWFsaXplZCAvIGFic29sdXRlIFVSTCBvZiB0aGUgcmVzb3VyY2UKICAgICAgICAgKiAgICAgYmVpbmcgdGVzdGVkLgogICAgICAgICAqCiAgICAgICAgICogICAgIFRoZSAqKnNwZWNpYWwgc3RyaW5nKiogYCdzZWxmJ2AgY2FuIGJlIHVzZWQgdG8gbWF0Y2ggYWdhaW5zdCBhbGwgVVJMcyBvZiB0aGUgc2FtZSBkb21haW4gYXMgdGhlCiAgICAgICAgICogICAgIGFwcGxpY2F0aW9uIGRvY3VtZW50IHdpdGggdGhlIHNhbWUgcHJvdG9jb2wgKGFsbG93cyBzb3VyY2luZyBodHRwcyByZXNvdXJjZXMgZnJvbSBodHRwIGRvY3VtZW50cy4pCiAgICAgICAgICoKICAgICAgICAgKiAgICAgUGxlYXNlIG5vdGUgdGhhdCAqKmFuIGVtcHR5IHdoaXRlbGlzdCBhcnJheSB3aWxsIGJsb2NrIGFsbCBVUkxzKiohCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtBcnJheX0gdGhlIGN1cnJlbnRseSBzZXQgd2hpdGVsaXN0IGFycmF5LgogICAgICAgICAqCiAgICAgICAgICogVGhlICoqZGVmYXVsdCB2YWx1ZSoqIHdoZW4gbm8gd2hpdGVsaXN0IGhhcyBiZWVuIGV4cGxpY2l0bHkgc2V0IGlzIGBbJ3NlbGYnXWAuCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTZXRzL0dldHMgdGhlIHdoaXRlbGlzdCBvZiB0cnVzdGVkIHJlc291cmNlIFVSTHMuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5yZXNvdXJjZVVybFdoaXRlbGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmVzb3VyY2VVcmxXaGl0ZWxpc3QgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzb3VyY2VVcmxXaGl0ZWxpc3Q7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybEJsYWNrbGlzdAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kc2NlRGVsZWdhdGVQcm92aWRlcgogICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBcnJheT19IGJsYWNrbGlzdCBXaGVuIHByb3ZpZGVkLCByZXBsYWNlcyB0aGUgcmVzb3VyY2VVcmxCbGFja2xpc3Qgd2l0aCB0aGUgdmFsdWUKICAgICAgICAgKiAgICAgcHJvdmlkZWQuICBUaGlzIG11c3QgYmUgYW4gYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiAgICAgRWFjaCBlbGVtZW50IG9mIHRoaXMgYXJyYXkgbXVzdCBlaXRoZXIgYmUgYSByZWdleCBvciB0aGUgc3BlY2lhbCBzdHJpbmcgYCdzZWxmJ2AgKHNlZQogICAgICAgICAqICAgICBgcmVzb3VyY2VVcmxXaGl0ZWxpc3RgIGZvciBtZWFuaW5nIC0gaXQncyBvbmx5IHJlYWxseSB1c2VmdWwgdGhlcmUuKQogICAgICAgICAqCiAgICAgICAgICogICAgIFdoZW4gYSByZWdleCBpcyB1c2VkLCBpdCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIG5vcm1hbGl6ZWQgLyBhYnNvbHV0ZSBVUkwgb2YgdGhlIHJlc291cmNlCiAgICAgICAgICogICAgIGJlaW5nIHRlc3RlZC4KICAgICAgICAgKgogICAgICAgICAqICAgICBUaGUgdHlwaWNhbCB1c2FnZSBmb3IgdGhlIGJsYWNrbGlzdCBpcyB0byAqKmJsb2NrIFtvcGVuIHJlZGlyZWN0c10oaHR0cDovL2N3ZS5taXRyZS5vcmcvZGF0YS9kZWZpbml0aW9ucy82MDEuaHRtbCkqKgogICAgICAgICAqICAgICBzZXJ2ZWQgYnkgeW91ciBkb21haW4gYXMgdGhlc2Ugd291bGQgb3RoZXJ3aXNlIGJlIHRydXN0ZWQgYnV0IGFjdHVhbGx5IHJldHVybiBjb250ZW50IGZyb20gdGhlIHJlZGlyZWN0ZWQKICAgICAgICAgKiAgICAgZG9tYWluLgogICAgICAgICAqCiAgICAgICAgICogICAgIEZpbmFsbHksICoqdGhlIGJsYWNrbGlzdCBvdmVycmlkZXMgdGhlIHdoaXRlbGlzdCoqIGFuZCBoYXMgdGhlIGZpbmFsIHNheS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge0FycmF5fSB0aGUgY3VycmVudGx5IHNldCBibGFja2xpc3QgYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgKipkZWZhdWx0IHZhbHVlKiogd2hlbiBubyB3aGl0ZWxpc3QgaGFzIGJlZW4gZXhwbGljaXRseSBzZXQgaXMgdGhlIGVtcHR5IGFycmF5IChpLmUuIHRoZXJlIGlzCiAgICAgICAgICogbm8gYmxhY2tsaXN0LikKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFNldHMvR2V0cyB0aGUgYmxhY2tsaXN0IG9mIHRydXN0ZWQgcmVzb3VyY2UgVVJMcy4KICAgICAgICAgKi8KCiAgICAgICAgdGhpcy5yZXNvdXJjZVVybEJsYWNrbGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmVzb3VyY2VVcmxCbGFja2xpc3QgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzb3VyY2VVcmxCbGFja2xpc3Q7CiAgICAgICAgfTsKCiAgICAgICAgLy8gSGVscGVyIGZ1bmN0aW9ucyBmb3IgbWF0Y2hpbmcgcmVzb3VyY2UgdXJscyBieSBwb2xpY3kuCiAgICAgICAgZnVuY3Rpb24gaXNDb21wYXRpYmxlUHJvdG9jb2woZG9jdW1lbnRQcm90b2NvbCwgcmVzb3VyY2VQcm90b2NvbCkgewogICAgICAgICAgICByZXR1cm4gKChkb2N1bWVudFByb3RvY29sID09PSByZXNvdXJjZVByb3RvY29sKSB8fAogICAgICAgICAgICAgICAgICAgIChkb2N1bWVudFByb3RvY29sID09PSAiaHR0cDoiICYmIHJlc291cmNlUHJvdG9jb2wgPT09ICJodHRwczoiKSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRsb2cnLCAnJGRvY3VtZW50JywgJyRpbmplY3RvcicsICckJHVybFV0aWxzJywgZnVuY3Rpb24gKAogICAgICAgICAgICAgICAgICAgICAgJGxvZywgJGRvY3VtZW50LCAkaW5qZWN0b3IsICQkdXJsVXRpbHMpIHsKCiAgICAgICAgICAgIHZhciBodG1sU2FuaXRpemVyID0gZnVuY3Rpb24gaHRtbFNhbml0aXplcihodG1sKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAkc2NlTWluRXJyKCd1bnNhZmUnLCAnQXR0ZW1wdGluZyB0byB1c2UgYW4gdW5zYWZlIHZhbHVlIGluIGEgc2FmZSBjb250ZXh0LicpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKCRpbmplY3Rvci5oYXMoJyRzYW5pdGl6ZScpKSB7CiAgICAgICAgICAgICAgICBodG1sU2FuaXRpemVyID0gJGluamVjdG9yLmdldCgnJHNhbml0aXplJyk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBmdW5jdGlvbiBtYXRjaFVybChtYXRjaGVyLCBwYXJzZWRVcmwpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRjaGVyID09PSAnc2VsZicpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJCR1cmxVdGlscy5pc1NhbWVPcmlnaW4ocGFyc2VkVXJsKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEhcGFyc2VkVXJsLmhyZWYubWF0Y2gobWF0Y2hlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGlzUmVzb3VyY2VVcmxBbGxvd2VkQnlQb2xpY3kodXJsKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkVXJsID0gJCR1cmxVdGlscy5yZXNvbHZlKHVybC50b1N0cmluZygpLCB0cnVlKTsKICAgICAgICAgICAgICAgIHZhciBpLCBuLCBhbGxvd2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhhdCBhdCBsZWFzdCBvbmUgaXRlbSBmcm9tIHRoZSB3aGl0ZWxpc3QgYWxsb3dzIHRoaXMgdXJsLgogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbiA9IHJlc291cmNlVXJsV2hpdGVsaXN0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaFVybChyZXNvdXJjZVVybFdoaXRlbGlzdFtpXSwgcGFyc2VkVXJsKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhbGxvd2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGFsbG93ZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhhdCBubyBpdGVtIGZyb20gdGhlIGJsYWNrbGlzdCBibG9ja2VkIHRoaXMgdXJsLgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIG4gPSByZXNvdXJjZVVybEJsYWNrbGlzdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoVXJsKHJlc291cmNlVXJsQmxhY2tsaXN0W2ldLCBwYXJzZWRVcmwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvd2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhbGxvd2VkOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBnZW5lcmF0ZUhvbGRlclR5cGUoYmFzZSkgewogICAgICAgICAgICAgICAgdmFyIGhvbGRlclR5cGUgPSBmdW5jdGlvbiBUcnVzdGVkVmFsdWVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJCR1bndyYXBUcnVzdGVkVmFsdWUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVzdGVkVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoYmFzZSkgewogICAgICAgICAgICAgICAgICAgIGhvbGRlclR5cGUucHJvdG90eXBlID0gbmV3IGJhc2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGRlclR5cGUucHJvdG90eXBlLnZhbHVlT2YgPSBmdW5jdGlvbiBzY2VWYWx1ZU9mKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiQkdW53cmFwVHJ1c3RlZFZhbHVlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBob2xkZXJUeXBlLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uIHNjZVRvU3RyaW5nKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiQkdW53cmFwVHJ1c3RlZFZhbHVlKCkudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBob2xkZXJUeXBlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSA9IGdlbmVyYXRlSG9sZGVyVHlwZSgpLAogICAgICAgICAgICAgICAgYnlUeXBlID0ge307CgogICAgICAgICAgICBieVR5cGVbU0NFX0NPTlRFWFRTLkhUTUxdID0gZ2VuZXJhdGVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpOwogICAgICAgICAgICBieVR5cGVbU0NFX0NPTlRFWFRTLkNTU10gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICAgICAgICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuVVJMXSA9IGdlbmVyYXRlSG9sZGVyVHlwZSh0cnVzdGVkVmFsdWVIb2xkZXJCYXNlKTsKICAgICAgICAgICAgYnlUeXBlW1NDRV9DT05URVhUUy5KU10gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICAgICAgICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuUkVTT1VSQ0VfVVJMXSA9IGdlbmVyYXRlSG9sZGVyVHlwZShieVR5cGVbU0NFX0NPTlRFWFRTLlVSTF0pOwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2VEZWxlZ2F0ZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogUmV0dXJucyBhbiBvYmplY3QgdGhhdCBpcyB0cnVzdGVkIGJ5IGFuZ3VsYXIgZm9yIHVzZSBpbiBzcGVjaWZpZWQgc3RyaWN0CiAgICAgICAgICAgICAqIGNvbnRleHR1YWwgZXNjYXBpbmcgY29udGV4dHMgKHN1Y2ggYXMgbmctaHRtbC1iaW5kLXVuc2FmZSwgbmctaW5jbHVkZSwgYW55IHNyYwogICAgICAgICAgICAgKiBhdHRyaWJ1dGUgaW50ZXJwb2xhdGlvbiwgYW55IGRvbSBldmVudCBiaW5kaW5nIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uCiAgICAgICAgICAgICAqIHN1Y2ggYXMgZm9yIG9uY2xpY2ssICBldGMuKSB0aGF0IHVzZXMgdGhlIHByb3ZpZGVkIHZhbHVlLgogICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRzY2UgJHNjZX0gZm9yIGVuYWJsaW5nIHN0cmljdCBjb250ZXh0dWFsIGVzY2FwaW5nLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgc2FmZSBmb3IgdXNlLiAgZS5nLiB1cmwsCiAgICAgICAgICAgICAqICAgcmVzb3VyY2VVcmwsIGh0bWwsIGpzIGFuZCBjc3MuCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRoYXQgdGhhdCBzaG91bGQgYmUgY29uc2lkZXJlZCB0cnVzdGVkL3NhZmUuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHsqfSBBIHZhbHVlIHRoYXQgY2FuIGJlIHVzZWQgdG8gc3RhbmQgaW4gZm9yIHRoZSBwcm92aWRlZCBgdmFsdWVgIGluIHBsYWNlcwogICAgICAgICAgICAgKiB3aGVyZSBBbmd1bGFyIGV4cGVjdHMgYSAkc2NlLnRydXN0QXMoKSByZXR1cm4gdmFsdWUuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiB0cnVzdEFzKHR5cGUsIHRydXN0ZWRWYWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gKGJ5VHlwZS5oYXNPd25Qcm9wZXJ0eSh0eXBlKSA/IGJ5VHlwZVt0eXBlXSA6IG51bGwpOwogICAgICAgICAgICAgICAgaWYgKCFjb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2ljb250ZXh0JywgJ0F0dGVtcHRlZCB0byB0cnVzdCBhIHZhbHVlIGluIGludmFsaWQgY29udGV4dC4gQ29udGV4dDogezB9OyBWYWx1ZTogezF9JywKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSwgdHJ1c3RlZFZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0cnVzdGVkVmFsdWUgPT09IG51bGwgfHwgdHJ1c3RlZFZhbHVlID09PSB1bmRlZmluZWQgfHwgdHJ1c3RlZFZhbHVlID09PSAnJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVzdGVkVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBBbGwgdGhlIGN1cnJlbnQgY29udGV4dHMgaW4gU0NFX0NPTlRFWFRTIGhhcHBlbiB0byBiZSBzdHJpbmdzLiAgSW4gb3JkZXIgdG8gYXZvaWQgdHJ1c3RpbmcKICAgICAgICAgICAgICAgIC8vIG11dGFibGUgb2JqZWN0cywgd2UgZW5zdXJlIGhlcmUgdGhhdCB0aGUgdmFsdWUgcGFzc2VkIGluIGlzIGFjdHVhbGx5IGEgc3RyaW5nLgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0cnVzdGVkVmFsdWUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgJHNjZU1pbkVycignaXR5cGUnLAogICAgICAgICAgICAgICAgICAgICAgICAnQXR0ZW1wdGVkIHRvIHRydXN0IGEgbm9uLXN0cmluZyB2YWx1ZSBpbiBhIGNvbnRlbnQgcmVxdWlyaW5nIGEgc3RyaW5nOiBDb250ZXh0OiB7MH0nLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBuZXcgY29uc3RydWN0b3IodHJ1c3RlZFZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZURlbGVnYXRlI3ZhbHVlT2YKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2VEZWxlZ2F0ZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogSWYgdGhlIHBhc3NlZCBwYXJhbWV0ZXIgaGFkIGJlZW4gcmV0dXJuZWQgYnkgYSBwcmlvciBjYWxsIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcwogICAgICAgICAgICAgKiBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSwgcmV0dXJucyB0aGUgdmFsdWUgdGhhdCBoYWQgYmVlbiBwYXNzZWQgdG8ge0BsaW5rCiAgICAgICAgICAgICAqIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBJZiB0aGUgcGFzc2VkIHBhcmFtZXRlciBpcyBub3QgYSB2YWx1ZSB0aGF0IGhhZCBiZWVuIHJldHVybmVkIGJ5IHtAbGluawogICAgICAgICAgICAgKiBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSwgcmV0dXJucyBpdCBhcy1pcy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgcmVzdWx0IG9mIGEgcHJpb3Ige0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9CiAgICAgICAgICAgICAqICAgICAgY2FsbCBvciBhbnl0aGluZyBlbHNlLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHZhbHVlIHRoZSB3YXMgb3JpZ2luYWxseSBwcm92aWRlZCB0byB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAgICAgICAgICogICAgIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9IGlmIGB2YWx1ZWAgaXMgdGhlIHJlc3VsdCBvZiBzdWNoIGEgY2FsbC4gIE90aGVyd2lzZSwgcmV0dXJucyBgdmFsdWVgCiAgICAgICAgICAgICAqICAgICB1bmNoYW5nZWQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiB2YWx1ZU9mKG1heWJlVHJ1c3RlZCkgewogICAgICAgICAgICAgICAgaWYgKG1heWJlVHJ1c3RlZCBpbnN0YW5jZW9mIHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWF5YmVUcnVzdGVkLiQkdW53cmFwVHJ1c3RlZFZhbHVlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kc2NlRGVsZWdhdGUKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFRha2VzIHRoZSByZXN1bHQgb2YgYSB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gY2FsbCBhbmQgcmV0dXJucyB0aGUKICAgICAgICAgICAgICogb3JpZ2luYWxseSBzdXBwbGllZCB2YWx1ZSBpZiB0aGUgcXVlcmllZCBjb250ZXh0IHR5cGUgaXMgYSBzdXBlcnR5cGUgb2YgdGhlIGNyZWF0ZWQgdHlwZS4gIElmCiAgICAgICAgICAgICAqIHRoaXMgY29uZGl0aW9uIGlzbid0IHNhdGlzZmllZCwgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgY29udGV4dCBpbiB3aGljaCB0aGlzIHZhbHVlIGlzIHRvIGJlIHVzZWQuCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gbWF5YmVUcnVzdGVkIFRoZSByZXN1bHQgb2YgYSBwcmlvciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAgICAgICAgICogYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gY2FsbC4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSB2YWx1ZSB0aGUgd2FzIG9yaWdpbmFsbHkgcHJvdmlkZWQgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgICAgICAgICAqICAgICBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSBpZiB2YWxpZCBpbiB0aGlzIGNvbnRleHQuICBPdGhlcndpc2UsIHRocm93cyBhbiBleGNlcHRpb24uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiBnZXRUcnVzdGVkKHR5cGUsIG1heWJlVHJ1c3RlZCkgewogICAgICAgICAgICAgICAgaWYgKG1heWJlVHJ1c3RlZCA9PT0gbnVsbCB8fCBtYXliZVRydXN0ZWQgPT09IHVuZGVmaW5lZCB8fCBtYXliZVRydXN0ZWQgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjb25zdHJ1Y3RvciA9IChieVR5cGUuaGFzT3duUHJvcGVydHkodHlwZSkgPyBieVR5cGVbdHlwZV0gOiBudWxsKTsKICAgICAgICAgICAgICAgIGlmIChjb25zdHJ1Y3RvciAmJiBtYXliZVRydXN0ZWQgaW5zdGFuY2VvZiBjb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQuJCR1bndyYXBUcnVzdGVkVmFsdWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElmIHdlIGdldCBoZXJlLCB0aGVuIHdlIG1heSBvbmx5IHRha2Ugb25lIG9mIHR3byBhY3Rpb25zLgogICAgICAgICAgICAgICAgLy8gMS4gc2FuaXRpemUgdGhlIHZhbHVlIGZvciB0aGUgcmVxdWVzdGVkIHR5cGUsIG9yCiAgICAgICAgICAgICAgICAvLyAyLiB0aHJvdyBhbiBleGNlcHRpb24uCiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gU0NFX0NPTlRFWFRTLlJFU09VUkNFX1VSTCkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1Jlc291cmNlVXJsQWxsb3dlZEJ5UG9saWN5KG1heWJlVHJ1c3RlZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkc2NlTWluRXJyKCdpbnNlY3VybCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQmxvY2tlZCBsb2FkaW5nIHJlc291cmNlIGZyb20gdXJsIG5vdCBhbGxvd2VkIGJ5ICRzY2VEZWxlZ2F0ZSBwb2xpY3kuICBVUkw6IHswfScsIG1heWJlVHJ1c3RlZC50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09IFNDRV9DT05URVhUUy5IVE1MKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGh0bWxTYW5pdGl6ZXIobWF5YmVUcnVzdGVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ3Vuc2FmZScsICdBdHRlbXB0aW5nIHRvIHVzZSBhbiB1bnNhZmUgdmFsdWUgaW4gYSBzYWZlIGNvbnRleHQuJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB0cnVzdEFzOiB0cnVzdEFzLAogICAgICAgICAgICAgICAgZ2V0VHJ1c3RlZDogZ2V0VHJ1c3RlZCwKICAgICAgICAgICAgICAgIHZhbHVlT2Y6IHZhbHVlT2YKICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kc2NlUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFRoZSAkc2NlUHJvdmlkZXIgcHJvdmlkZXIgYWxsb3dzIGRldmVsb3BlcnMgdG8gY29uZmlndXJlIHRoZSB7QGxpbmsgbmcuJHNjZSAkc2NlfSBzZXJ2aWNlLgogICAgICogLSAgIGVuYWJsZS9kaXNhYmxlIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpIGluIGEgbW9kdWxlCiAgICAgKiAtICAgb3ZlcnJpZGUgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gd2l0aCBhIGN1c3RvbSBkZWxlZ2F0ZQogICAgICoKICAgICAqIFJlYWQgbW9yZSBhYm91dCB7QGxpbmsgbmcuJHNjZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0uCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgKiBAbmFtZSBuZy4kc2NlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBgJHNjZWAgaXMgYSBzZXJ2aWNlIHRoYXQgcHJvdmlkZXMgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgc2VydmljZXMgdG8gQW5ndWxhckpTLgogICAgICoKICAgICAqICMgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcKICAgICAqCiAgICAgKiBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKSBpcyBhIG1vZGUgaW4gd2hpY2ggQW5ndWxhckpTIHJlcXVpcmVzIGJpbmRpbmdzIGluIGNlcnRhaW4KICAgICAqIGNvbnRleHRzIHRvIHJlc3VsdCBpbiBhIHZhbHVlIHRoYXQgaXMgbWFya2VkIGFzIHNhZmUgdG8gdXNlIGZvciB0aGF0IGNvbnRleHQgT25lIGV4YW1wbGUgb2Ygc3VjaAogICAgICogYSBjb250ZXh0IGlzIGJpbmRpbmcgYXJiaXRyYXJ5IGh0bWwgY29udHJvbGxlZCBieSB0aGUgdXNlciB2aWEgYG5nLWJpbmQtaHRtbGAuICBXZSByZWZlciB0byB0aGVzZQogICAgICogY29udGV4dHMgYXMgcHJpdmlsZWdlZCBvciBTQ0UgY29udGV4dHMuCiAgICAgKgogICAgICogQXMgb2YgdmVyc2lvbiAxLjIsIEFuZ3VsYXIgc2hpcHMgd2l0aCBTQ0UgZW5hYmxlZCBieSBkZWZhdWx0LgogICAgICoKICAgICAqIE5vdGU6ICBXaGVuIGVuYWJsZWQgKHRoZSBkZWZhdWx0KSwgSUU4IGluIHF1aXJrcyBtb2RlIGlzIG5vdCBzdXBwb3J0ZWQuICBJbiB0aGlzIG1vZGUsIElFOCBhbGxvd3MKICAgICAqIG9uZSB0byBleGVjdXRlIGFyYml0cmFyeSBqYXZhc2NyaXB0IGJ5IHRoZSB1c2Ugb2YgdGhlIGV4cHJlc3Npb24oKSBzeW50YXguICBSZWZlcgogICAgICogPGh0dHA6Ly9ibG9ncy5tc2RuLmNvbS9iL2llL2FyY2hpdmUvMjAwOC8xMC8xNi9lbmRpbmctZXhwcmVzc2lvbnMuYXNweD4gdG8gbGVhcm4gbW9yZSBhYm91dCB0aGVtLgogICAgICogWW91IGNhbiBlbnN1cmUgeW91ciBkb2N1bWVudCBpcyBpbiBzdGFuZGFyZHMgbW9kZSBhbmQgbm90IHF1aXJrcyBtb2RlIGJ5IGFkZGluZyBgPCFkb2N0eXBlIGh0bWw+YAogICAgICogdG8gdGhlIHRvcCBvZiB5b3VyIEhUTUwgZG9jdW1lbnQuCiAgICAgKgogICAgICogU0NFIGFzc2lzdHMgaW4gd3JpdGluZyBjb2RlIGluIHdheSB0aGF0IChhKSBpcyBzZWN1cmUgYnkgZGVmYXVsdCBhbmQgKGIpIG1ha2VzIGF1ZGl0aW5nIGZvcgogICAgICogc2VjdXJpdHkgdnVsbmVyYWJpbGl0aWVzIHN1Y2ggYXMgWFNTLCBjbGlja2phY2tpbmcsIGV0Yy4gYSBsb3QgZWFzaWVyLgogICAgICoKICAgICAqIEhlcmUncyBhbiBleGFtcGxlIG9mIGEgYmluZGluZyBpbiBhIHByaXZpbGVnZWQgY29udGV4dDoKICAgICAqCiAgICAgKiA8cHJlIGNsYXNzPSJwcmV0dHlwcmludCI+CiAgICAgKiAgICAgPGlucHV0IG5nLW1vZGVsPSJ1c2VySHRtbCI+CiAgICAgKiAgICAgPGRpdiBuZy1iaW5kLWh0bWw9Int7dXNlckh0bWx9fSI+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBOb3RpY2UgdGhhdCBgbmctYmluZC1odG1sYCBpcyBib3VuZCB0byBge3t1c2VySHRtbH19YCBjb250cm9sbGVkIGJ5IHRoZSB1c2VyLiAgV2l0aCBTQ0UKICAgICAqIGRpc2FibGVkLCB0aGlzIGFwcGxpY2F0aW9uIGFsbG93cyB0aGUgdXNlciB0byByZW5kZXIgYXJiaXRyYXJ5IEhUTUwgaW50byB0aGUgRElWLgogICAgICogSW4gYSBtb3JlIHJlYWxpc3RpYyBleGFtcGxlLCBvbmUgbWF5IGJlIHJlbmRlcmluZyB1c2VyIGNvbW1lbnRzLCBibG9nIGFydGljbGVzLCBldGMuIHZpYQogICAgICogYmluZGluZ3MuICAoSFRNTCBpcyBqdXN0IG9uZSBleGFtcGxlIG9mIGEgY29udGV4dCB3aGVyZSByZW5kZXJpbmcgdXNlciBjb250cm9sbGVkIGlucHV0IGNyZWF0ZXMKICAgICAqIHNlY3VyaXR5IHZ1bG5lcmFiaWxpdGllcy4pCiAgICAgKgogICAgICogRm9yIHRoZSBjYXNlIG9mIEhUTUwsIHlvdSBtaWdodCB1c2UgYSBsaWJyYXJ5LCBlaXRoZXIgb24gdGhlIGNsaWVudCBzaWRlLCBvciBvbiB0aGUgc2VydmVyIHNpZGUsCiAgICAgKiB0byBzYW5pdGl6ZSB1bnNhZmUgSFRNTCBiZWZvcmUgYmluZGluZyB0byB0aGUgdmFsdWUgYW5kIHJlbmRlcmluZyBpdCBpbiB0aGUgZG9jdW1lbnQuCiAgICAgKgogICAgICogSG93IHdvdWxkIHlvdSBlbnN1cmUgdGhhdCBldmVyeSBwbGFjZSB0aGF0IHVzZWQgdGhlc2UgdHlwZXMgb2YgYmluZGluZ3Mgd2FzIGJvdW5kIHRvIGEgdmFsdWUgdGhhdAogICAgICogd2FzIHNhbml0aXplZCBieSB5b3VyIGxpYnJhcnkgKG9yIHJldHVybmVkIGFzIHNhZmUgZm9yIHJlbmRlcmluZyBieSB5b3VyIHNlcnZlcj8pICBIb3cgY2FuIHlvdQogICAgICogZW5zdXJlIHRoYXQgeW91IGRpZG4ndCBhY2NpZGVudGFsbHkgZGVsZXRlIHRoZSBsaW5lIHRoYXQgc2FuaXRpemVkIHRoZSB2YWx1ZSwgb3IgcmVuYW1lZCBzb21lCiAgICAgKiBwcm9wZXJ0aWVzL2ZpZWxkcyBhbmQgZm9yZ290IHRvIHVwZGF0ZSB0aGUgYmluZGluZyB0byB0aGUgc2FuaXRpemVkIHZhbHVlPwogICAgICoKICAgICAqIFRvIGJlIHNlY3VyZSBieSBkZWZhdWx0LCB5b3Ugd2FudCB0byBlbnN1cmUgdGhhdCBhbnkgc3VjaCBiaW5kaW5ncyBhcmUgZGlzYWxsb3dlZCB1bmxlc3MgeW91IGNhbgogICAgICogZGV0ZXJtaW5lIHRoYXQgc29tZXRoaW5nIGV4cGxpY2l0bHkgc2F5cyBpdCdzIHNhZmUgdG8gdXNlIGEgdmFsdWUgZm9yIGJpbmRpbmcgaW4gdGhhdAogICAgICogY29udGV4dC4gIFlvdSBjYW4gdGhlbiBhdWRpdCB5b3VyIGNvZGUgKGEgc2ltcGxlIGdyZXAgd291bGQgZG8pIHRvIGVuc3VyZSB0aGF0IHRoaXMgaXMgb25seSBkb25lCiAgICAgKiBmb3IgdGhvc2UgdmFsdWVzIHRoYXQgeW91IGNhbiBlYXNpbHkgdGVsbCBhcmUgc2FmZSAtIGJlY2F1c2UgdGhleSB3ZXJlIHJlY2VpdmVkIGZyb20geW91ciBzZXJ2ZXIsCiAgICAgKiBzYW5pdGl6ZWQgYnkgeW91ciBsaWJyYXJ5LCBldGMuICBZb3UgY2FuIG9yZ2FuaXplIHlvdXIgY29kZWJhc2UgdG8gaGVscCB3aXRoIHRoaXMgLSBwZXJoYXBzCiAgICAgKiBhbGxvd2luZyBvbmx5IHRoZSBmaWxlcyBpbiBhIHNwZWNpZmljIGRpcmVjdG9yeSB0byBkbyB0aGlzLiAgRW5zdXJpbmcgdGhhdCB0aGUgaW50ZXJuYWwgQVBJCiAgICAgKiBleHBvc2VkIGJ5IHRoYXQgY29kZSBkb2Vzbid0IG1hcmt1cCBhcmJpdHJhcnkgdmFsdWVzIGFzIHNhZmUgdGhlbiBiZWNvbWVzIGEgbW9yZSBtYW5hZ2VhYmxlIHRhc2suCiAgICAgKgogICAgICogSW4gdGhlIGNhc2Ugb2YgQW5ndWxhckpTJyBTQ0Ugc2VydmljZSwgb25lIHVzZXMge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9IChhbmQgc2hvcnRoYW5kCiAgICAgKiBtZXRob2RzIHN1Y2ggYXMge0BsaW5rIG5nLiRzY2UjdHJ1c3RBc0h0bWwgJHNjZS50cnVzdEFzSHRtbH0sIGV0Yy4pIHRvIG9idGFpbiB2YWx1ZXMgdGhhdCB3aWxsIGJlCiAgICAgKiBhY2NlcHRlZCBieSBTQ0UgLyBwcml2aWxlZ2VkIGNvbnRleHRzLgogICAgICoKICAgICAqCiAgICAgKiAjIyBIb3cgZG9lcyBpdCB3b3JrPwogICAgICoKICAgICAqIEluIHByaXZpbGVnZWQgY29udGV4dHMsIGRpcmVjdGl2ZXMgYW5kIGNvZGUgd2lsbCBiaW5kIHRvIHRoZSByZXN1bHQgb2Yge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZAogICAgICogJHNjZS5nZXRUcnVzdGVkKGNvbnRleHQsIHZhbHVlKX0gcmF0aGVyIHRoYW4gdG8gdGhlIHZhbHVlIGRpcmVjdGx5LiAgRGlyZWN0aXZlcyB1c2Uge0BsaW5rCiAgICAgKiBuZy4kc2NlI3BhcnNlICRzY2UucGFyc2VBc30gcmF0aGVyIHRoYW4gYCRwYXJzZWAgdG8gd2F0Y2ggYXR0cmlidXRlIGJpbmRpbmdzLCB3aGljaCBwZXJmb3JtcyB0aGUKICAgICAqIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWQgJHNjZS5nZXRUcnVzdGVkfSBiZWhpbmQgdGhlIHNjZW5lcyBvbiBub24tY29uc3RhbnQgbGl0ZXJhbHMuCiAgICAgKgogICAgICogQXMgYW4gZXhhbXBsZSwge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0JpbmRIdG1sIG5nQmluZEh0bWx9IHVzZXMge0BsaW5rCiAgICAgKiBuZy4kc2NlI3BhcnNlQXNIdG1sICRzY2UucGFyc2VBc0h0bWwoYmluZGluZyBleHByZXNzaW9uKX0uICBIZXJlJ3MgdGhlIGFjdHVhbCBjb2RlIChzbGlnaHRseQogICAgICogc2ltcGxpZmllZCk6CiAgICAgKgogICAgICogPHByZSBjbGFzcz0icHJldHR5cHJpbnQiPgogICAgICogICB2YXIgbmdCaW5kSHRtbERpcmVjdGl2ZSA9IFsnJHNjZScsIGZ1bmN0aW9uKCRzY2UpIHsKICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAqICAgICAgIHNjb3BlLiR3YXRjaCgkc2NlLnBhcnNlQXNIdG1sKGF0dHIubmdCaW5kSHRtbCksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgKiAgICAgICAgIGVsZW1lbnQuaHRtbCh2YWx1ZSB8fCAnJyk7CiAgICAgKiAgICAgICB9KTsKICAgICAqICAgICB9OwogICAgICogICB9XTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqICMjIEltcGFjdCBvbiBsb2FkaW5nIHRlbXBsYXRlcwogICAgICoKICAgICAqIFRoaXMgYXBwbGllcyBib3RoIHRvIHRoZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSBgbmctaW5jbHVkZWB9IGRpcmVjdGl2ZSBhcyB3ZWxsIGFzCiAgICAgKiBgdGVtcGxhdGVVcmxgJ3Mgc3BlY2lmaWVkIGJ5IHtAbGluayBndWlkZS9kaXJlY3RpdmUgZGlyZWN0aXZlc30uCiAgICAgKgogICAgICogQnkgZGVmYXVsdCwgQW5ndWxhciBvbmx5IGxvYWRzIHRlbXBsYXRlcyBmcm9tIHRoZSBzYW1lIGRvbWFpbiBhbmQgcHJvdG9jb2wgYXMgdGhlIGFwcGxpY2F0aW9uCiAgICAgKiBkb2N1bWVudC4gIFRoaXMgaXMgZG9uZSBieSBjYWxsaW5nIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRSZXNvdXJjZVVybAogICAgICogJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmx9IG9uIHRoZSB0ZW1wbGF0ZSBVUkwuICBUbyBsb2FkIHRlbXBsYXRlcyBmcm9tIG90aGVyIGRvbWFpbnMgYW5kL29yCiAgICAgKiBwcm90b2NvbHMsIHlvdSBtYXkgZWl0aGVyIGVpdGhlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3Qgd2hpdGVsaXN0CiAgICAgKiB0aGVtfSBvciB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzUmVzb3VyY2VVcmwgd3JhcCBpdH0gaW50byBhIHRydXN0ZWQgdmFsdWUuCiAgICAgKgogICAgICogKlBsZWFzZSBub3RlKjoKICAgICAqIFRoZSBicm93c2VyJ3MKICAgICAqIHtAbGluayBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Jyb3dzZXJzZWMvd2lraS9QYXJ0MiNTYW1lLW9yaWdpbl9wb2xpY3lfZm9yX1hNTEh0dHBSZXF1ZXN0CiAgICAgKiBTYW1lIE9yaWdpbiBQb2xpY3l9IGFuZCB7QGxpbmsgaHR0cDovL3d3dy53My5vcmcvVFIvY29ycy8gQ3Jvc3MtT3JpZ2luIFJlc291cmNlIFNoYXJpbmcgKENPUlMpfQogICAgICogcG9saWN5IGFwcGx5IGluIGFkZGl0aW9uIHRvIHRoaXMgYW5kIG1heSBmdXJ0aGVyIHJlc3RyaWN0IHdoZXRoZXIgdGhlIHRlbXBsYXRlIGlzIHN1Y2Nlc3NmdWxseQogICAgICogbG9hZGVkLiAgVGhpcyBtZWFucyB0aGF0IHdpdGhvdXQgdGhlIHJpZ2h0IENPUlMgcG9saWN5LCBsb2FkaW5nIHRlbXBsYXRlcyBmcm9tIGEgZGlmZmVyZW50IGRvbWFpbgogICAgICogd29uJ3Qgd29yayBvbiBhbGwgYnJvd3NlcnMuICBBbHNvLCBsb2FkaW5nIHRlbXBsYXRlcyBmcm9tIGBmaWxlOi8vYCBVUkwgZG9lcyBub3Qgd29yayBvbiBzb21lCiAgICAgKiBicm93c2Vycy4KICAgICAqCiAgICAgKiAjIyBUaGlzIGZlZWxzIGxpa2UgdG9vIG11Y2ggb3ZlcmhlYWQgZm9yIHRoZSBkZXZlbG9wZXI/CiAgICAgKgogICAgICogSXQncyBpbXBvcnRhbnQgdG8gcmVtZW1iZXIgdGhhdCBTQ0Ugb25seSBhcHBsaWVzIHRvIGludGVycG9sYXRpb24gZXhwcmVzc2lvbnMuCiAgICAgKgogICAgICogSWYgeW91ciBleHByZXNzaW9ucyBhcmUgY29uc3RhbnQgbGl0ZXJhbHMsIHRoZXkncmUgYXV0b21hdGljYWxseSB0cnVzdGVkIGFuZCB5b3UgZG9uJ3QgbmVlZCB0bwogICAgICogY2FsbCBgJHNjZS50cnVzdEFzYCBvbiB0aGVtLiAgKGUuZy4KICAgICAqIGA8ZGl2IG5nLWh0bWwtYmluZC11bnNhZmU9Iic8Yj5pbXBsaWNpdGx5IHRydXN0ZWQ8L2I+JyI+PC9kaXY+YCkganVzdCB3b3Jrcy4KICAgICAqCiAgICAgKiBBZGRpdGlvbmFsbHksIGBhW2hyZWZdYCBhbmQgYGltZ1tzcmNdYCBhdXRvbWF0aWNhbGx5IHNhbml0aXplIHRoZWlyIFVSTHMgYW5kIGRvIG5vdCBwYXNzIHRoZW0KICAgICAqIHRocm91Z2gge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWR9LiAgU0NFIGRvZXNuJ3QgcGxheSBhIHJvbGUgaGVyZS4KICAgICAqCiAgICAgKiBUaGUgaW5jbHVkZWQge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSAkc2NlRGVsZWdhdGV9IGNvbWVzIHdpdGggc2FuZSBkZWZhdWx0cyB0byBhbGxvdyB5b3UgdG8gbG9hZAogICAgICogdGVtcGxhdGVzIGluIGBuZy1pbmNsdWRlYCBmcm9tIHlvdXIgYXBwbGljYXRpb24ncyBkb21haW4gd2l0aG91dCBoYXZpbmcgdG8gZXZlbiBrbm93IGFib3V0IFNDRS4KICAgICAqIEl0IGJsb2NrcyBsb2FkaW5nIHRlbXBsYXRlcyBmcm9tIG90aGVyIGRvbWFpbnMgb3IgbG9hZGluZyB0ZW1wbGF0ZXMgb3ZlciBodHRwIGZyb20gYW4gaHR0cHMKICAgICAqIHNlcnZlZCBkb2N1bWVudC4gIFlvdSBjYW4gY2hhbmdlIHRoZXNlIGJ5IHNldHRpbmcgeW91ciBvd24gY3VzdG9tIHtAbGluawogICAgICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3Qgd2hpdGVsaXN0c30gYW5kIHtAbGluawogICAgICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgYmxhY2tsaXN0c30gZm9yIG1hdGNoaW5nIHN1Y2ggVVJMcy4KICAgICAqCiAgICAgKiBUaGlzIHNpZ25pZmljYW50bHkgcmVkdWNlcyB0aGUgb3ZlcmhlYWQuICBJdCBpcyBmYXIgZWFzaWVyIHRvIHBheSB0aGUgc21hbGwgb3ZlcmhlYWQgYW5kIGhhdmUgYW4KICAgICAqIGFwcGxpY2F0aW9uIHRoYXQncyBzZWN1cmUgYW5kIGNhbiBiZSBhdWRpdGVkIHRvIHZlcmlmeSB0aGF0IHdpdGggbXVjaCBtb3JlIGVhc2UgdGhhbiBib2x0aW5nCiAgICAgKiBzZWN1cml0eSBvbnRvIGFuIGFwcGxpY2F0aW9uIGxhdGVyLgogICAgICoKICAgICAqICMjIFdoYXQgdHJ1c3RlZCBjb250ZXh0IHR5cGVzIGFyZSBzdXBwb3J0ZWQ/PGEgbmFtZT0iY29udGV4dHMiPjwvYT4KICAgICAqCiAgICAgKiB8IENvbnRleHQgICAgICAgICAgICAgfCBOb3RlcyAgICAgICAgICB8CiAgICAgKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS18CiAgICAgKiB8IGAkc2NlLkhUTUxgICAgICAgICAgfCBGb3IgSFRNTCB0aGF0J3Mgc2FmZSB0byBzb3VyY2UgaW50byB0aGUgYXBwbGljYXRpb24uICBUaGUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0JpbmRIdG1sIG5nQmluZEh0bWx9IGRpcmVjdGl2ZSB1c2VzIHRoaXMgY29udGV4dCBmb3IgYmluZGluZ3MuIHwKICAgICAqIHwgYCRzY2UuQ1NTYCAgICAgICAgICB8IEZvciBDU1MgdGhhdCdzIHNhZmUgdG8gc291cmNlIGludG8gdGhlIGFwcGxpY2F0aW9uLiAgQ3VycmVudGx5IHVudXNlZC4gIEZlZWwgZnJlZSB0byB1c2UgaXQgaW4geW91ciBvd24gZGlyZWN0aXZlcy4gfAogICAgICogfCBgJHNjZS5VUkxgICAgICAgICAgIHwgRm9yIFVSTHMgdGhhdCBhcmUgc2FmZSB0byBmb2xsb3cgYXMgbGlua3MuICBDdXJyZW50bHkgdW51c2VkIChgPGEgaHJlZj1gIGFuZCBgPGltZyBzcmM9YCBzYW5pdGl6ZSB0aGVpciB1cmxzIGFuZCBkb24ndCBjb25zaXRpdHV0ZSBhbiBTQ0UgY29udGV4dC4gfAogICAgICogfCBgJHNjZS5SRVNPVVJDRV9VUkxgIHwgRm9yIFVSTHMgdGhhdCBhcmUgbm90IG9ubHkgc2FmZSB0byBmb2xsb3cgYXMgbGlua3MsIGJ1dCB3aG9zZSBjb250ZW5zIGFyZSBhbHNvIHNhZmUgdG8gaW5jbHVkZSBpbiB5b3VyIGFwcGxpY2F0aW9uLiAgRXhhbXBsZXMgaW5jbHVkZSBgbmctaW5jbHVkZWAsIGBzcmNgIC8gYG5nU3JjYCBiaW5kaW5ncyBmb3IgdGFncyBvdGhlciB0aGFuIGBJTUdgIChlLmcuIGBJRlJBTUVgLCBgT0JKRUNUYCwgZXRjLikgIDxicj48YnI+Tm90ZSB0aGF0IGAkc2NlLlJFU09VUkNFX1VSTGAgbWFrZXMgYSBzdHJvbmdlciBzdGF0ZW1lbnQgYWJvdXQgdGhlIFVSTCB0aGFuIGAkc2NlLlVSTGAgZG9lcyBhbmQgdGhlcmVmb3JlIGNvbnRleHRzIHJlcXVpcmluZyB2YWx1ZXMgdHJ1c3RlZCBmb3IgYCRzY2UuUkVTT1VSQ0VfVVJMYCBjYW4gYmUgdXNlZCBhbnl3aGVyZSB0aGF0IHZhbHVlcyB0cnVzdGVkIGZvciBgJHNjZS5VUkxgIGFyZSByZXF1aXJlZC4gfAogICAgICogfCBgJHNjZS5KU2AgICAgICAgICAgIHwgRm9yIEphdmFTY3JpcHQgdGhhdCBpcyBzYWZlIHRvIGV4ZWN1dGUgaW4geW91ciBhcHBsaWNhdGlvbidzIGNvbnRleHQuICBDdXJyZW50bHkgdW51c2VkLiAgRmVlbCBmcmVlIHRvIHVzZSBpdCBpbiB5b3VyIG93biBkaXJlY3RpdmVzLiB8CiAgICAgKgogICAgICogIyMgU2hvdyBtZSBhbiBleGFtcGxlLgogICAgICoKICAgICAqCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZSBtb2R1bGU9Im15U2NlQXBwIj4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJteUFwcENvbnRyb2xsZXIgYXMgbXlDdHJsIj4KICAgICAgICAgIDxpIG5nLWJpbmQtaHRtbD0ibXlDdHJsLmV4cGxpY2l0bHlUcnVzdGVkSHRtbCIgaWQ9ImV4cGxpY2l0bHlUcnVzdGVkSHRtbCI+PC9pPjxicj48YnI+CiAgICAgICAgICA8Yj5Vc2VyIGNvbW1lbnRzPC9iPjxicj4KICAgICAgICAgIEJ5IGRlZmF1bHQsIEhUTUwgdGhhdCBpc24ndCBleHBsaWNpdGx5IHRydXN0ZWQgKGUuZy4gQWxpY2UncyBjb21tZW50KSBpcyBzYW5pdGl6ZWQgd2hlbiAkc2FuaXRpemUgaXMgYXZhaWxhYmxlLiAgSWYgJHNhbml0aXplIGlzbid0IGF2YWlsYWJsZSwgdGhpcyByZXN1bHRzIGluIGFuIGVycm9yIGluc3RlYWQgb2YgYW4gZXhwbG9pdC4KICAgICAgICAgIDxkaXYgY2xhc3M9IndlbGwiPgogICAgICAgICAgICA8ZGl2IG5nLXJlcGVhdD0idXNlckNvbW1lbnQgaW4gbXlDdHJsLnVzZXJDb21tZW50cyI+CiAgICAgICAgICAgICAgPGI+e3t1c2VyQ29tbWVudC5uYW1lfX08L2I+OgogICAgICAgICAgICAgIDxzcGFuIG5nLWJpbmQtaHRtbD0idXNlckNvbW1lbnQuaHRtbENvbW1lbnQiIGNsYXNzPSJodG1sQ29tbWVudCI+PC9zcGFuPgogICAgICAgICAgICAgIDxicj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9maWxlPgogICAgCiAgICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICAgdmFyIG15U2NlQXBwID0gYW5ndWxhci5tb2R1bGUoJ215U2NlQXBwJywgWyduZ1Nhbml0aXplJ10pOwogICAgCiAgICAgICAgbXlTY2VBcHAuY29udHJvbGxlcigibXlBcHBDb250cm9sbGVyIiwgZnVuY3Rpb24gbXlBcHBDb250cm9sbGVyKCRodHRwLCAkdGVtcGxhdGVDYWNoZSwgJHNjZSkgewogICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgJGh0dHAuZ2V0KCJ0ZXN0X2RhdGEuanNvbiIsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS5zdWNjZXNzKGZ1bmN0aW9uKHVzZXJDb21tZW50cykgewogICAgICAgICAgICBzZWxmLnVzZXJDb21tZW50cyA9IHVzZXJDb21tZW50czsKICAgICAgICAgIH0pOwogICAgICAgICAgc2VsZi5leHBsaWNpdGx5VHJ1c3RlZEh0bWwgPSAkc2NlLnRydXN0QXNIdG1sKAogICAgICAgICAgICAgICc8c3BhbiBvbm1vdXNlb3Zlcj0idGhpcy50ZXh0Q29udGVudD0mcXVvdDtFeHBsaWNpdGx5IHRydXN0ZWQgSFRNTCBieXBhc3NlcyAnICsKICAgICAgICAgICAgICAnc2FuaXRpemF0aW9uLiZxdW90OyI+SG92ZXIgb3ZlciB0aGlzIHRleHQuPC9zcGFuPicpOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICAKICAgICAgPGZpbGUgbmFtZT0idGVzdF9kYXRhLmpzb24iPgogICAgICAgIFsKICAgICAgICAgIHsgIm5hbWUiOiAiQWxpY2UiLAogICAgICAgICAgICAiaHRtbENvbW1lbnQiOiAiPHNwYW4gb25tb3VzZW92ZXI9J3RoaXMudGV4dENvbnRlbnQ9XCJQV04zRCFcIic+SXMgPGk+YW55b25lPC9pPiByZWFkaW5nIHRoaXM/PC9zcGFuPiIKICAgICAgICAgIH0sCiAgICAgICAgICB7ICJuYW1lIjogIkJvYiIsCiAgICAgICAgICAgICJodG1sQ29tbWVudCI6ICI8aT5ZZXMhPC9pPiAgQW0gSSB0aGUgb25seSBvdGhlciBvbmU/IgogICAgICAgICAgfQogICAgICAgIF0KICAgICAgPC9maWxlPgogICAgCiAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICBkZXNjcmliZSgnU0NFIGRvYyBkZW1vJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpdCgnc2hvdWxkIHNhbml0aXplIHVudHJ1c3RlZCB2YWx1ZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5odG1sQ29tbWVudCcpLmh0bWwoKSkudG9CZSgnPHNwYW4+SXMgPGk+YW55b25lPC9pPiByZWFkaW5nIHRoaXM/PC9zcGFuPicpOwogICAgICAgICAgfSk7CiAgICAgICAgICBpdCgnc2hvdWxkIE5PVCBzYW5pdGl6ZSBleHBsaWNpdGx5IHRydXN0ZWQgdmFsdWVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjZXhwbGljaXRseVRydXN0ZWRIdG1sJykuaHRtbCgpKS50b0JlKAogICAgICAgICAgICAgICAgJzxzcGFuIG9ubW91c2VvdmVyPSJ0aGlzLnRleHRDb250ZW50PSZxdW90O0V4cGxpY2l0bHkgdHJ1c3RlZCBIVE1MIGJ5cGFzc2VzICcgKwogICAgICAgICAgICAgICAgJ3Nhbml0aXphdGlvbi4mcXVvdDsiPkhvdmVyIG92ZXIgdGhpcyB0ZXh0Ljwvc3Bhbj4nKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICoKICAgICAqCiAgICAgKgogICAgICogIyMgQ2FuIEkgZGlzYWJsZSBTQ0UgY29tcGxldGVseT8KICAgICAqCiAgICAgKiBZZXMsIHlvdSBjYW4uICBIb3dldmVyLCB0aGlzIGlzIHN0cm9uZ2x5IGRpc2NvdXJhZ2VkLiAgU0NFIGdpdmVzIHlvdSBhIGxvdCBvZiBzZWN1cml0eSBiZW5lZml0cwogICAgICogZm9yIGxpdHRsZSBjb2Rpbmcgb3ZlcmhlYWQuICBJdCB3aWxsIGJlIG11Y2ggaGFyZGVyIHRvIHRha2UgYW4gU0NFIGRpc2FibGVkIGFwcGxpY2F0aW9uIGFuZAogICAgICogZWl0aGVyIHNlY3VyZSBpdCBvbiB5b3VyIG93biBvciBlbmFibGUgU0NFIGF0IGEgbGF0ZXIgc3RhZ2UuICBJdCBtaWdodCBtYWtlIHNlbnNlIHRvIGRpc2FibGUgU0NFCiAgICAgKiBmb3IgY2FzZXMgd2hlcmUgeW91IGhhdmUgYSBsb3Qgb2YgZXhpc3RpbmcgY29kZSB0aGF0IHdhcyB3cml0dGVuIGJlZm9yZSBTQ0Ugd2FzIGludHJvZHVjZWQgYW5kCiAgICAgKiB5b3UncmUgbWlncmF0aW5nIHRoZW0gYSBtb2R1bGUgYXQgYSB0aW1lLgogICAgICoKICAgICAqIFRoYXQgc2FpZCwgaGVyZSdzIGhvdyB5b3UgY2FuIGNvbXBsZXRlbHkgZGlzYWJsZSBTQ0U6CiAgICAgKgogICAgICogPHByZSBjbGFzcz0icHJldHR5cHJpbnQiPgogICAgICogICBhbmd1bGFyLm1vZHVsZSgnbXlBcHBXaXRoU2NlRGlzYWJsZWRteUFwcCcsIFtdKS5jb25maWcoZnVuY3Rpb24oJHNjZVByb3ZpZGVyKSB7CiAgICAgKiAgICAgLy8gQ29tcGxldGVseSBkaXNhYmxlIFNDRS4gIEZvciBkZW1vbnN0cmF0aW9uIHB1cnBvc2VzIG9ubHkhCiAgICAgKiAgICAgLy8gRG8gbm90IHVzZSBpbiBuZXcgcHJvamVjdHMuCiAgICAgKiAgICAgJHNjZVByb3ZpZGVyLmVuYWJsZWQoZmFsc2UpOwogICAgICogICB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqLwoKICAgIGZ1bmN0aW9uICRTY2VQcm92aWRlcigpIHsKICAgICAgICB2YXIgZW5hYmxlZCA9IHRydWU7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLnNjZVByb3ZpZGVyI2VuYWJsZWQKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZVByb3ZpZGVyCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSB2YWx1ZSBJZiBwcm92aWRlZCwgdGhlbiBlbmFibGVzL2Rpc2FibGVzIFNDRS4KICAgICAgICAgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIFNDRSBpcyBlbmFibGVkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBFbmFibGVzL2Rpc2FibGVzIFNDRSBhbmQgcmV0dXJucyB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLmVuYWJsZWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGVuYWJsZWQgPSAhIXZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlbmFibGVkOwogICAgICAgIH07CgoKICAgICAgICAvKiBEZXNpZ24gbm90ZXMgb24gdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gZm9yIFNDRS4KICAgICAgICAgKgogICAgICAgICAqIFRoZSBBUEkgY29udHJhY3QgZm9yIHRoZSBTQ0UgZGVsZWdhdGUKICAgICAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgICogVGhlIFNDRSBkZWxlZ2F0ZSBvYmplY3QgbXVzdCBwcm92aWRlIHRoZSBmb2xsb3dpbmcgMyBtZXRob2RzOgogICAgICAgICAqCiAgICAgICAgICogLSB0cnVzdEFzKGNvbnRleHRFbnVtLCB2YWx1ZSkKICAgICAgICAgKiAgICAgVGhpcyBtZXRob2QgaXMgdXNlZCB0byB0ZWxsIHRoZSBTQ0Ugc2VydmljZSB0aGF0IHRoZSBwcm92aWRlZCB2YWx1ZSBpcyBPSyB0byB1c2UgaW4gdGhlCiAgICAgICAgICogICAgIGNvbnRleHRzIHNwZWNpZmllZCBieSBjb250ZXh0RW51bS4gIEl0IG11c3QgcmV0dXJuIGFuIG9iamVjdCB0aGF0IHdpbGwgYmUgYWNjZXB0ZWQgYnkKICAgICAgICAgKiAgICAgZ2V0VHJ1c3RlZCgpIGZvciBhIGNvbXBhdGlibGUgY29udGV4dEVudW0gYW5kIHJldHVybiB0aGlzIHZhbHVlLgogICAgICAgICAqCiAgICAgICAgICogLSB2YWx1ZU9mKHZhbHVlKQogICAgICAgICAqICAgICBGb3IgdmFsdWVzIHRoYXQgd2VyZSBub3QgcHJvZHVjZWQgYnkgdHJ1c3RBcygpLCByZXR1cm4gdGhlbSBhcyBpcy4gIEZvciB2YWx1ZXMgdGhhdCB3ZXJlCiAgICAgICAgICogICAgIHByb2R1Y2VkIGJ5IHRydXN0QXMoKSwgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIGlucHV0IHZhbHVlIHRvIHRydXN0QXMuICBCYXNpY2FsbHksIGlmCiAgICAgICAgICogICAgIHRydXN0QXMgaXMgd3JhcHBpbmcgdGhlIGdpdmVuIHZhbHVlcyBpbnRvIHNvbWUgdHlwZSwgdGhpcyBvcGVyYXRpb24gdW53cmFwcyBpdCB3aGVuIGdpdmVuCiAgICAgICAgICogICAgIHN1Y2ggYSB2YWx1ZS4KICAgICAgICAgKgogICAgICAgICAqIC0gZ2V0VHJ1c3RlZChjb250ZXh0RW51bSwgdmFsdWUpCiAgICAgICAgICogICAgIFRoaXMgZnVuY3Rpb24gc2hvdWxkIHJldHVybiB0aGUgYSB2YWx1ZSB0aGF0IGlzIHNhZmUgdG8gdXNlIGluIHRoZSBjb250ZXh0IHNwZWNpZmllZCBieQogICAgICAgICAqICAgICBjb250ZXh0RW51bSBvciB0aHJvdyBhbmQgZXhjZXB0aW9uIG90aGVyd2lzZS4KICAgICAgICAgKgogICAgICAgICAqIE5PVEU6IFRoaXMgY29udHJhY3QgZGVsaWJlcmF0ZWx5IGRvZXMgTk9UIHN0YXRlIHRoYXQgdmFsdWVzIHJldHVybmVkIGJ5IHRydXN0QXMoKSBtdXN0IGJlIG9wYXF1ZQogICAgICAgICAqIG9yIHdyYXBwZWQgaW4gc29tZSBob2xkZXIgb2JqZWN0LiAgVGhhdCBoYXBwZW5zIHRvIGJlIGFuIGltcGxlbWVudGF0aW9uIGRldGFpbC4gIEZvciBpbnN0YW5jZSwKICAgICAgICAgKiBhbiBpbXBsZW1lbnRhdGlvbiBjb3VsZCBtYWludGFpbiBhIHJlZ2lzdHJ5IG9mIGFsbCB0cnVzdGVkIG9iamVjdHMgYnkgY29udGV4dC4gIEluIHN1Y2ggYSBjYXNlLAogICAgICAgICAqIHRydXN0QXMoKSB3b3VsZCByZXR1cm4gdGhlIHNhbWUgb2JqZWN0IHRoYXQgd2FzIHBhc3NlZCBpbi4gIGdldFRydXN0ZWQoKSB3b3VsZCByZXR1cm4gdGhlIHNhbWUKICAgICAgICAgKiBvYmplY3QgcGFzc2VkIGluIGlmIGl0IHdhcyBmb3VuZCBpbiB0aGUgcmVnaXN0cnkgdW5kZXIgYSBjb21wYXRpYmxlIGNvbnRleHQgb3IgdGhyb3cgYW4KICAgICAgICAgKiBleGNlcHRpb24gb3RoZXJ3aXNlLiAgQW4gaW1wbGVtZW50YXRpb24gbWlnaHQgb25seSB3cmFwIHZhbHVlcyBzb21lIG9mIHRoZSB0aW1lIGJhc2VkIG9uCiAgICAgICAgICogc29tZSBjcml0ZXJpYS4gIGdldFRydXN0ZWQoKSBtaWdodCByZXR1cm4gYSB2YWx1ZSBhbmQgbm90IHRocm93IGFuIGV4Y2VwdGlvbiBmb3Igc3BlY2lhbAogICAgICAgICAqIGNvbnN0YW50cyBvciBvYmplY3RzIGV2ZW4gaWYgbm90IHdyYXBwZWQuICBBbGwgc3VjaCBpbXBsZW1lbnRhdGlvbnMgZnVsZmlsbCB0aGlzIGNvbnRyYWN0LgogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiBBIG5vdGUgb24gdGhlIGluaGVyaXRhbmNlIG1vZGVsIGZvciBTQ0UgY29udGV4dHMKICAgICAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAgKiBJJ3ZlIHVzZWQgaW5oZXJpdGFuY2UgYW5kIG1hZGUgUkVTT1VSQ0VfVVJMIHdyYXBwZWQgdHlwZXMgYSBzdWJ0eXBlIG9mIFVSTCB3cmFwcGVkIHR5cGVzLiAgVGhpcwogICAgICAgICAqIGlzIHB1cmVseSBhbiBpbXBsZW1lbnRhdGlvbiBkZXRhaWxzLgogICAgICAgICAqCiAgICAgICAgICogVGhlIGNvbnRyYWN0IGlzIHNpbXBseSB0aGlzOgogICAgICAgICAqCiAgICAgICAgICogICAgIGdldFRydXN0ZWQoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKSBzdWNjZWVkaW5nIGltcGxpZXMgdGhhdCBnZXRUcnVzdGVkKCRzY2UuVVJMLCB2YWx1ZSkKICAgICAgICAgKiAgICAgd2lsbCBhbHNvIHN1Y2NlZWQuCiAgICAgICAgICoKICAgICAgICAgKiBJbmhlcml0YW5jZSBoYXBwZW5zIHRvIGNhcHR1cmUgdGhpcyBpbiBhIG5hdHVyYWwgd2F5LiAgSW4gc29tZSBmdXR1cmUsIHdlCiAgICAgICAgICogbWF5IG5vdCB1c2UgaW5oZXJpdGFuY2UgYW55bW9yZS4gIFRoYXQgaXMgT0sgYmVjYXVzZSBubyBjb2RlIG91dHNpZGUgb2YKICAgICAgICAgKiBzY2UuanMgYW5kIHNjZVNwZWNzLmpzIHdvdWxkIG5lZWQgdG8gYmUgYXdhcmUgb2YgdGhpcyBkZXRhaWwuCiAgICAgICAgICovCgogICAgICAgIHRoaXMuJGdldCA9IFsnJHBhcnNlJywgJyRkb2N1bWVudCcsICckc2NlRGVsZWdhdGUnLCBmdW5jdGlvbiAoCiAgICAgICAgICAgICAgICAgICAgICAkcGFyc2UsICRkb2N1bWVudCwgJHNjZURlbGVnYXRlKSB7CiAgICAgICAgICAgIC8vIFByZXJlcTogRW5zdXJlIHRoYXQgd2UncmUgbm90IHJ1bm5pbmcgaW4gSUU4IHF1aXJrcyBtb2RlLiAgSW4gdGhhdCBtb2RlLCBJRSBhbGxvd3MKICAgICAgICAgICAgLy8gdGhlICJleHByZXNzaW9uKGphdmFzY3JpcHQgZXhwcmVzc2lvbikiIHN5bnRheCB3aGljaCBpcyBpbnNlY3VyZS4KICAgICAgICAgICAgaWYgKGVuYWJsZWQgJiYgbXNpZSkgewogICAgICAgICAgICAgICAgdmFyIGRvY3VtZW50TW9kZSA9ICRkb2N1bWVudFswXS5kb2N1bWVudE1vZGU7CiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnRNb2RlICE9PSB1bmRlZmluZWQgJiYgZG9jdW1lbnRNb2RlIDwgOCkgewogICAgICAgICAgICAgICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2llcXVpcmtzJywKICAgICAgICAgICAgICAgICAgICAgICdTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyBkb2VzIG5vdCBzdXBwb3J0IEludGVybmV0IEV4cGxvcmVyIHZlcnNpb24gPCA5IGluIHF1aXJrcyAnICsKICAgICAgICAgICAgICAgICAgICAgICdtb2RlLiAgWW91IGNhbiBmaXggdGhpcyBieSBhZGRpbmcgdGhlIHRleHQgPCFkb2N0eXBlIGh0bWw+IHRvIHRoZSB0b3Agb2YgeW91ciBIVE1MICcgKwogICAgICAgICAgICAgICAgICAgICAgJ2RvY3VtZW50LiAgU2VlIGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nLiRzY2UgZm9yIG1vcmUgaW5mb3JtYXRpb24uJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzY2UgPSBjb3B5KFNDRV9DT05URVhUUyk7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLnNjZSNpc0VuYWJsZWQKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IHRydWUgaWYgU0NFIGlzIGVuYWJsZWQsIGZhbHNlIG90aGVyd2lzZS4gIElmIHlvdSB3YW50IHRvIHNldCB0aGUgdmFsdWUsIHlvdQogICAgICAgICAgICAgKiBoYXZlIHRvIGRvIGl0IGF0IG1vZHVsZSBjb25maWcgdGltZSBvbiB7QGxpbmsgbmcuJHNjZVByb3ZpZGVyICRzY2VQcm92aWRlcn0uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBSZXR1cm5zIGEgYm9vbGVhbiBpbmRpY2F0aW5nIGlmIFNDRSBpcyBlbmFibGVkLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2NlLmlzRW5hYmxlZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbmFibGVkOwogICAgICAgICAgICB9OwogICAgICAgICAgICBzY2UudHJ1c3RBcyA9ICRzY2VEZWxlZ2F0ZS50cnVzdEFzOwogICAgICAgICAgICBzY2UuZ2V0VHJ1c3RlZCA9ICRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkOwogICAgICAgICAgICBzY2UudmFsdWVPZiA9ICRzY2VEZWxlZ2F0ZS52YWx1ZU9mOwoKICAgICAgICAgICAgaWYgKCFlbmFibGVkKSB7CiAgICAgICAgICAgICAgICBzY2UudHJ1c3RBcyA9IHNjZS5nZXRUcnVzdGVkID0gZnVuY3Rpb24gKHR5cGUsIHZhbHVlKSB7IHJldHVybiB2YWx1ZTsgfSwKICAgICAgICAgICAgICAgIHNjZS52YWx1ZU9mID0gaWRlbnRpdHkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZSNwYXJzZQogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogQ29udmVydHMgQW5ndWxhciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpbnRvIGEgZnVuY3Rpb24uICBUaGlzIGlzIGxpa2Uge0BsaW5rCiAgICAgICAgICAgICAqIG5nLiRwYXJzZSAkcGFyc2V9IGFuZCBpcyBpZGVudGljYWwgd2hlbiB0aGUgZXhwcmVzc2lvbiBpcyBhIGxpdGVyYWwgY29uc3RhbnQuICBPdGhlcndpc2UsIGl0CiAgICAgICAgICAgICAqIHdyYXBzIHRoZSBleHByZXNzaW9uIGluIGEgY2FsbCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkICRzY2UuZ2V0VHJ1c3RlZCgqdHlwZSosCiAgICAgICAgICAgICAqICpyZXN1bHQqKX0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgU0NFIGNvbnRleHQgaW4gd2hpY2ggdGhpcyByZXN1bHQgd2lsbCBiZSB1c2VkLgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgICAgICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICAgICAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgICAgICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2NlLnBhcnNlQXMgPSBmdW5jdGlvbiBzY2VQYXJzZUFzKHR5cGUsIGV4cHIpIHsKICAgICAgICAgICAgICAgIHZhciBwYXJzZWQgPSAkcGFyc2UoZXhwcik7CiAgICAgICAgICAgICAgICBpZiAocGFyc2VkLmxpdGVyYWwgJiYgcGFyc2VkLmNvbnN0YW50KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHNjZVBhcnNlQXNUcnVzdGVkKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NlLmdldFRydXN0ZWQodHlwZSwgcGFyc2VkKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2UjdHJ1c3RBcwogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogRGVsZWdhdGVzIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfS4gIEFzIHN1Y2gsIHJldHVybnMgYW4gb2JqZWN0CiAgICAgICAgICAgICAqIHRoYXQgaXMgdHJ1c3RlZCBieSBhbmd1bGFyIGZvciB1c2UgaW4gc3BlY2lmaWVkIHN0cmljdCBjb250ZXh0dWFsIGVzY2FwaW5nIGNvbnRleHRzIChzdWNoIGFzCiAgICAgICAgICAgICAqIG5nLWh0bWwtYmluZC11bnNhZmUsIG5nLWluY2x1ZGUsIGFueSBzcmMgYXR0cmlidXRlIGludGVycG9sYXRpb24sIGFueSBkb20gZXZlbnQgYmluZGluZwogICAgICAgICAgICAgKiBhdHRyaWJ1dGUgaW50ZXJwb2xhdGlvbiBzdWNoIGFzIGZvciBvbmNsaWNrLCAgZXRjLikgdGhhdCB1c2VzIHRoZSBwcm92aWRlZCB2YWx1ZS4gIFNlZSAqCiAgICAgICAgICAgICAqIHtAbGluayBuZy4kc2NlICRzY2V9IGZvciBlbmFibGluZyBzdHJpY3QgY29udGV4dHVhbCBlc2NhcGluZy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgY29udGV4dCBpbiB3aGljaCB0aGlzIHZhbHVlIGlzIHNhZmUgZm9yIHVzZS4gIGUuZy4gdXJsLAogICAgICAgICAgICAgKiAgIHJlc291cmNlX3VybCwgaHRtbCwganMgYW5kIGNzcy4KICAgICAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdGhhdCB0aGF0IHNob3VsZCBiZSBjb25zaWRlcmVkIHRydXN0ZWQvc2FmZS4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IEEgdmFsdWUgdGhhdCBjYW4gYmUgdXNlZCB0byBzdGFuZCBpbiBmb3IgdGhlIHByb3ZpZGVkIGB2YWx1ZWAgaW4gcGxhY2VzCiAgICAgICAgICAgICAqIHdoZXJlIEFuZ3VsYXIgZXhwZWN0cyBhICRzY2UudHJ1c3RBcygpIHJldHVybiB2YWx1ZS4KICAgICAgICAgICAgICovCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kc2NlI3RydXN0QXNIdG1sCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kc2NlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UudHJ1c3RBc0h0bWwodmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLkhUTUwsIHZhbHVlKWB9CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRIdG1sCiAgICAgICAgICAgICAqICAgICAkc2NlLmdldFRydXN0ZWRIdG1sKHZhbHVlKX0gdG8gb2J0YWluIHRoZSBvcmlnaW5hbCB2YWx1ZS4gIChwcml2aWxlZ2VkIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlCiAgICAgICAgICAgICAqICAgICByZXR1cm4gdmFsdWUgb2Yge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9LikKICAgICAgICAgICAgICovCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kc2NlI3RydXN0QXNVcmwKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS50cnVzdEFzVXJsKHZhbHVlKWAg4oaSIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRVcmwKICAgICAgICAgICAgICogICAgICRzY2UuZ2V0VHJ1c3RlZFVybCh2YWx1ZSl9IHRvIG9idGFpbiB0aGUgb3JpZ2luYWwgdmFsdWUuICAocHJpdmlsZWdlZCBkaXJlY3RpdmVzCiAgICAgICAgICAgICAqICAgICBvbmx5IGFjY2VwdCBleHByZXNzaW9ucyB0aGF0IGFyZSBlaXRoZXIgbGl0ZXJhbCBjb25zdGFudHMgb3IgYXJlIHRoZQogICAgICAgICAgICAgKiAgICAgcmV0dXJuIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZSN0cnVzdEFzUmVzb3VyY2VVcmwKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS50cnVzdEFzUmVzb3VyY2VVcmwodmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYH0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdHJ1c3RBcy4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IEFuIG9iamVjdCB0aGF0IGNhbiBiZSBwYXNzZWQgdG8ge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAgICAgICAgICAgICAqICAgICAkc2NlLmdldFRydXN0ZWRSZXNvdXJjZVVybCh2YWx1ZSl9IHRvIG9idGFpbiB0aGUgb3JpZ2luYWwgdmFsdWUuICAocHJpdmlsZWdlZCBkaXJlY3RpdmVzCiAgICAgICAgICAgICAqICAgICBvbmx5IGFjY2VwdCBleHByZXNzaW9ucyB0aGF0IGFyZSBlaXRoZXIgbGl0ZXJhbCBjb25zdGFudHMgb3IgYXJlIHRoZSByZXR1cm4KICAgICAgICAgICAgICogICAgIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZSN0cnVzdEFzSnMKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS50cnVzdEFzSnModmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLkpTLCB2YWx1ZSlgfQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB0cnVzdEFzLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHBhc3NlZCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkSnMKICAgICAgICAgICAgICogICAgICRzY2UuZ2V0VHJ1c3RlZEpzKHZhbHVlKX0gdG8gb2J0YWluIHRoZSBvcmlnaW5hbCB2YWx1ZS4gIChwcml2aWxlZ2VkIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlCiAgICAgICAgICAgICAqICAgICByZXR1cm4gdmFsdWUgb2Yge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9LikKICAgICAgICAgICAgICovCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kc2NlI2dldFRydXN0ZWQKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIERlbGVnYXRlcyB0byB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkYH0uICBBcyBzdWNoLCB0YWtlcwogICAgICAgICAgICAgKiB0aGUgcmVzdWx0IG9mIGEge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyBgJHNjZS50cnVzdEFzYH0oKSBjYWxsIGFuZCByZXR1cm5zIHRoZSBvcmlnaW5hbGx5IHN1cHBsaWVkCiAgICAgICAgICAgICAqIHZhbHVlIGlmIHRoZSBxdWVyaWVkIGNvbnRleHQgdHlwZSBpcyBhIHN1cGVydHlwZSBvZiB0aGUgY3JlYXRlZCB0eXBlLiAgSWYgdGhpcyBjb25kaXRpb24KICAgICAgICAgICAgICogaXNuJ3Qgc2F0aXNmaWVkLCB0aHJvd3MgYW4gZXhjZXB0aW9uLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgdG8gYmUgdXNlZC4KICAgICAgICAgICAgICogQHBhcmFtIHsqfSBtYXliZVRydXN0ZWQgVGhlIHJlc3VsdCBvZiBhIHByaW9yIHtAbGluayBuZy4kc2NlI3RydXN0QXMgYCRzY2UudHJ1c3RBc2B9IGNhbGwuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgdmFsdWUgdGhlIHdhcyBvcmlnaW5hbGx5IHByb3ZpZGVkIHRvIHtAbGluayBuZy4kc2NlI3RydXN0QXMgYCRzY2UudHJ1c3RBc2B9IGlmCiAgICAgICAgICAgICAqICAgICB2YWxpZCBpbiB0aGlzIGNvbnRleHQuICBPdGhlcndpc2UsIHRocm93cyBhbiBleGNlcHRpb24uCiAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZSNnZXRUcnVzdGVkSHRtbAogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRIdG1sKHZhbHVlKWAg4oaSIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWQoJHNjZS5IVE1MLCB2YWx1ZSlgfQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBwYXNzIHRvIGAkc2NlLmdldFRydXN0ZWRgLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuSFRNTCwgdmFsdWUpYAogICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2UjZ2V0VHJ1c3RlZENzcwogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRDc3ModmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLkNTUywgdmFsdWUpYH0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLkNTUywgdmFsdWUpYAogICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2UjZ2V0VHJ1c3RlZFVybAogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRVcmwodmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLlVSTCwgdmFsdWUpYH0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLlVSTCwgdmFsdWUpYAogICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kc2NlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsKHZhbHVlKWAg4oaSIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWQoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKWB9CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkYC4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYAogICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2UjZ2V0VHJ1c3RlZEpzCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kc2NlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZEpzKHZhbHVlKWAg4oaSIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWQoJHNjZS5KUywgdmFsdWUpYH0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLkpTLCB2YWx1ZSlgCiAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZSNwYXJzZUFzSHRtbAogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNIdG1sKGV4cHJlc3Npb24gc3RyaW5nKWAg4oaSIHtAbGluayBuZy4kc2NlI3BhcnNlIGAkc2NlLnBhcnNlQXMoJHNjZS5IVE1MLCB2YWx1ZSlgfQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgICAgICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICAgICAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgICAgICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2UjcGFyc2VBc0NzcwogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNDc3ModmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2UjcGFyc2UgYCRzY2UucGFyc2VBcygkc2NlLkNTUywgdmFsdWUpYH0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICAgICAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAgICAgICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICAgICAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAgICAgICAgICovCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kc2NlI3BhcnNlQXNVcmwKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzVXJsKHZhbHVlKWAg4oaSIHtAbGluayBuZy4kc2NlI3BhcnNlIGAkc2NlLnBhcnNlQXMoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAgICAgICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgICAgICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAgICAgICAgICogICAgICBgY29udGV4dGAuCiAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZSNwYXJzZUFzUmVzb3VyY2VVcmwKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzUmVzb3VyY2VVcmwodmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2UjcGFyc2UgYCRzY2UucGFyc2VBcygkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYH0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICAgICAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAgICAgICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICAgICAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAgICAgICAgICovCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kc2NlI3BhcnNlQXNKcwogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNKcyh2YWx1ZSlgIOKGkiB7QGxpbmsgbmcuJHNjZSNwYXJzZSBgJHNjZS5wYXJzZUFzKCRzY2UuSlMsIHZhbHVlKWB9CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAgICAgICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgICAgICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAgICAgICAgICogICAgICBgY29udGV4dGAuCiAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgLy8gU2hvcnRoYW5kIGRlbGVnYXRpb25zLgogICAgICAgICAgICB2YXIgcGFyc2UgPSBzY2UucGFyc2VBcywKICAgICAgICAgICAgICAgIGdldFRydXN0ZWQgPSBzY2UuZ2V0VHJ1c3RlZCwKICAgICAgICAgICAgICAgIHRydXN0QXMgPSBzY2UudHJ1c3RBczsKCiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChTQ0VfQ09OVEVYVFMsIGZ1bmN0aW9uIChlbnVtVmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgICAgIHZhciBsTmFtZSA9IGxvd2VyY2FzZShuYW1lKTsKICAgICAgICAgICAgICAgIHNjZVtjYW1lbENhc2UoInBhcnNlX2FzXyIgKyBsTmFtZSldID0gZnVuY3Rpb24gKGV4cHIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2UoZW51bVZhbHVlLCBleHByKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNjZVtjYW1lbENhc2UoImdldF90cnVzdGVkXyIgKyBsTmFtZSldID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldFRydXN0ZWQoZW51bVZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzY2VbY2FtZWxDYXNlKCJ0cnVzdF9hc18iICsgbE5hbWUpXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVzdEFzKGVudW1WYWx1ZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiBzY2U7CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiAhISEgVGhpcyBpcyBhbiB1bmRvY3VtZW50ZWQgInByaXZhdGUiIHNlcnZpY2UgISEhCiAgICAgKgogICAgICogQG5hbWUgbmcuJHNuaWZmZXIKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKiBAcmVxdWlyZXMgJGRvY3VtZW50CiAgICAgKgogICAgICogQHByb3BlcnR5IHtib29sZWFufSBoaXN0b3J5IERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCBodG1sNSBoaXN0b3J5IGFwaSA/CiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc2hjaGFuZ2UgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IGhhc2hjaGFuZ2UgZXZlbnQgPwogICAgICogQHByb3BlcnR5IHtib29sZWFufSB0cmFuc2l0aW9ucyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgQ1NTIHRyYW5zaXRpb24gZXZlbnRzID8KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYW5pbWF0aW9ucyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgQ1NTIGFuaW1hdGlvbiBldmVudHMgPwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhpcyBpcyB2ZXJ5IHNpbXBsZSBpbXBsZW1lbnRhdGlvbiBvZiB0ZXN0aW5nIGJyb3dzZXIncyBmZWF0dXJlcy4KICAgICAqLwogICAgZnVuY3Rpb24gJFNuaWZmZXJQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCkgewogICAgICAgICAgICB2YXIgZXZlbnRTdXBwb3J0ID0ge30sCiAgICAgICAgICAgICAgICBhbmRyb2lkID0gaW50KCgvYW5kcm9pZCAoXGQrKS8uZXhlYyhsb3dlcmNhc2UoKCR3aW5kb3cubmF2aWdhdG9yIHx8IHt9KS51c2VyQWdlbnQpKSB8fCBbXSlbMV0pLAogICAgICAgICAgICAgICAgYm94ZWUgPSAvQm94ZWUvaS50ZXN0KCgkd2luZG93Lm5hdmlnYXRvciB8fCB7fSkudXNlckFnZW50KSwKICAgICAgICAgICAgICAgIGRvY3VtZW50ID0gJGRvY3VtZW50WzBdIHx8IHt9LAogICAgICAgICAgICAgICAgdmVuZG9yUHJlZml4LAogICAgICAgICAgICAgICAgdmVuZG9yUmVnZXggPSAvXihNb3p8d2Via2l0fE98bXMpKD89W0EtWl0pLywKICAgICAgICAgICAgICAgIGJvZHlTdHlsZSA9IGRvY3VtZW50LmJvZHkgJiYgZG9jdW1lbnQuYm9keS5zdHlsZSwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zID0gZmFsc2UsCiAgICAgICAgICAgICAgICBhbmltYXRpb25zID0gZmFsc2UsCiAgICAgICAgICAgICAgICBtYXRjaDsKCiAgICAgICAgICAgIGlmIChib2R5U3R5bGUpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gYm9keVN0eWxlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoID0gdmVuZG9yUmVnZXguZXhlYyhwcm9wKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2ZW5kb3JQcmVmaXggPSBtYXRjaFswXTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVuZG9yUHJlZml4ID0gdmVuZG9yUHJlZml4LnN1YnN0cigwLCAxKS50b1VwcGVyQ2FzZSgpICsgdmVuZG9yUHJlZml4LnN1YnN0cigxKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdmVuZG9yUHJlZml4KSB7CiAgICAgICAgICAgICAgICAgICAgdmVuZG9yUHJlZml4ID0gKCdXZWJraXRPcGFjaXR5JyBpbiBib2R5U3R5bGUpICYmICd3ZWJraXQnOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zID0gISEoKCd0cmFuc2l0aW9uJyBpbiBib2R5U3R5bGUpIHx8ICh2ZW5kb3JQcmVmaXggKyAnVHJhbnNpdGlvbicgaW4gYm9keVN0eWxlKSk7CiAgICAgICAgICAgICAgICBhbmltYXRpb25zID0gISEoKCdhbmltYXRpb24nIGluIGJvZHlTdHlsZSkgfHwgKHZlbmRvclByZWZpeCArICdBbmltYXRpb24nIGluIGJvZHlTdHlsZSkpOwoKICAgICAgICAgICAgICAgIGlmIChhbmRyb2lkICYmICghdHJhbnNpdGlvbnMgfHwgIWFuaW1hdGlvbnMpKSB7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbnMgPSBpc1N0cmluZyhkb2N1bWVudC5ib2R5LnN0eWxlLndlYmtpdFRyYW5zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMgPSBpc1N0cmluZyhkb2N1bWVudC5ib2R5LnN0eWxlLndlYmtpdEFuaW1hdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgLy8gQW5kcm9pZCBoYXMgaGlzdG9yeS5wdXNoU3RhdGUsIGJ1dCBpdCBkb2VzIG5vdCB1cGRhdGUgbG9jYXRpb24gY29ycmVjdGx5CiAgICAgICAgICAgICAgICAvLyBzbyBsZXQncyBub3QgdXNlIHRoZSBoaXN0b3J5IEFQSSBhdCBhbGwuCiAgICAgICAgICAgICAgICAvLyBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvYW5kcm9pZC9pc3N1ZXMvZGV0YWlsP2lkPTE3NDcxCiAgICAgICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy85MDQKCiAgICAgICAgICAgICAgICAvLyBvbGRlciB3ZWJpdCBicm93c2VyICg1MzMuOSkgb24gQm94ZWUgYm94IGhhcyBleGFjdGx5IHRoZSBzYW1lIHByb2JsZW0gYXMgQW5kcm9pZCBoYXMKICAgICAgICAgICAgICAgIC8vIHNvIGxldCdzIG5vdCB1c2UgdGhlIGhpc3RvcnkgQVBJIGFsc28KICAgICAgICAgICAgICAgIGhpc3Rvcnk6ICEhKCR3aW5kb3cuaGlzdG9yeSAmJiAkd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlICYmICEoYW5kcm9pZCA8IDQpICYmICFib3hlZSksCiAgICAgICAgICAgICAgICBoYXNoY2hhbmdlOiAnb25oYXNoY2hhbmdlJyBpbiAkd2luZG93ICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJRTggY29tcGF0aWJsZSBtb2RlIGxpZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICghZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHx8IGRvY3VtZW50LmRvY3VtZW50TW9kZSA+IDcpLAogICAgICAgICAgICAgICAgaGFzRXZlbnQ6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIC8vIElFOSBpbXBsZW1lbnRzICdpbnB1dCcgZXZlbnQgaXQncyBzbyBmdWJhcmVkIHRoYXQgd2UgcmF0aGVyIHByZXRlbmQgdGhhdCBpdCBkb2Vzbid0IGhhdmUKICAgICAgICAgICAgICAgICAgICAvLyBpdC4gSW4gcGFydGljdWxhciB0aGUgZXZlbnQgaXMgbm90IGZpcmVkIHdoZW4gYmFja3NwYWNlIG9yIGRlbGV0ZSBrZXkgYXJlIHByZXNzZWQgb3IKICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIGN1dCBvcGVyYXRpb24gaXMgcGVyZm9ybWVkLgogICAgICAgICAgICAgICAgICAgIGlmIChldmVudCA9PSAnaW5wdXQnICYmIG1zaWUgPT0gOSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoZXZlbnRTdXBwb3J0W2V2ZW50XSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpdkVsbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudFN1cHBvcnRbZXZlbnRdID0gJ29uJyArIGV2ZW50IGluIGRpdkVsbTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudFN1cHBvcnRbZXZlbnRdOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNzcDogZG9jdW1lbnQuc2VjdXJpdHlQb2xpY3kgPyBkb2N1bWVudC5zZWN1cml0eVBvbGljeS5pc0FjdGl2ZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgdmVuZG9yUHJlZml4OiB2ZW5kb3JQcmVmaXgsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogdHJhbnNpdGlvbnMsCiAgICAgICAgICAgICAgICBhbmltYXRpb25zOiBhbmltYXRpb25zCiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgZnVuY3Rpb24gJFRpbWVvdXRQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHEnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICAgICAgICAgZnVuY3Rpb24gKCRyb290U2NvcGUsICRicm93c2VyLCAkcSwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgICAgICB2YXIgZGVmZXJyZWRzID0ge307CgoKICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kdGltZW91dAogICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkYnJvd3NlcgogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICogQW5ndWxhcidzIHdyYXBwZXIgZm9yIGB3aW5kb3cuc2V0VGltZW91dGAuIFRoZSBgZm5gIGZ1bmN0aW9uIGlzIHdyYXBwZWQgaW50byBhIHRyeS9jYXRjaAogICAgICAgICAgICAgICAgICAqIGJsb2NrIGFuZCBkZWxlZ2F0ZXMgYW55IGV4Y2VwdGlvbnMgdG8KICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIG9mIHJlZ2lzdGVyaW5nIGEgdGltZW91dCBmdW5jdGlvbiBpcyBhIHByb21pc2UsIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgd2hlbgogICAgICAgICAgICAgICAgICAqIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQgYW5kIHRoZSB0aW1lb3V0IGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICogVG8gY2FuY2VsIGEgdGltZW91dCByZXF1ZXN0LCBjYWxsIGAkdGltZW91dC5jYW5jZWwocHJvbWlzZSlgLgogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICogSW4gdGVzdHMgeW91IGNhbiB1c2Uge0BsaW5rIG5nTW9jay4kdGltZW91dCBgJHRpbWVvdXQuZmx1c2goKWB9IHRvCiAgICAgICAgICAgICAgICAgICogc3luY2hyb25vdXNseSBmbHVzaCB0aGUgcXVldWUgb2YgZGVmZXJyZWQgZnVuY3Rpb25zLgogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBBIGZ1bmN0aW9uLCB3aG9zZSBleGVjdXRpb24gc2hvdWxkIGJlIGRlbGF5ZWQuCiAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBbZGVsYXk9MF0gRGVsYXkgaW4gbWlsbGlzZWNvbmRzLgogICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbnZva2VBcHBseT10cnVlXSBJZiBzZXQgdG8gYGZhbHNlYCBza2lwcyBtb2RlbCBkaXJ0eSBjaGVja2luZywgb3RoZXJ3aXNlCiAgICAgICAgICAgICAgICAgICogICB3aWxsIGludm9rZSBgZm5gIHdpdGhpbiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseX0gYmxvY2suCiAgICAgICAgICAgICAgICAgICogQHJldHVybnMge1Byb21pc2V9IFByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdoZW4gdGhlIHRpbWVvdXQgaXMgcmVhY2hlZC4gVGhlIHZhbHVlIHRoaXMKICAgICAgICAgICAgICAgICAgKiAgIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aXRoIGlzIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGBmbmAgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgZnVuY3Rpb24gdGltZW91dChmbiwgZGVsYXksIGludm9rZUFwcGx5KSB7CiAgICAgICAgICAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSwKICAgICAgICAgICAgICAgICAgICAgICAgIHNraXBBcHBseSA9IChpc0RlZmluZWQoaW52b2tlQXBwbHkpICYmICFpbnZva2VBcHBseSksCiAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0SWQ7CgogICAgICAgICAgICAgICAgICAgICB0aW1lb3V0SWQgPSAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZm4oKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRlZmVycmVkc1twcm9taXNlLiQkdGltZW91dElkXTsKICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNraXBBcHBseSkgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICAgfSwgZGVsYXkpOwoKICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHRpbWVvdXRJZCA9IHRpbWVvdXRJZDsKICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWRzW3RpbWVvdXRJZF0gPSBkZWZlcnJlZDsKCiAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiR0aW1lb3V0I2NhbmNlbAogICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kdGltZW91dAogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICogQ2FuY2VscyBhIHRhc2sgYXNzb2NpYXRlZCB3aXRoIHRoZSBgcHJvbWlzZWAuIEFzIGEgcmVzdWx0IG9mIHRoaXMsIHRoZSBwcm9taXNlIHdpbGwgYmUKICAgICAgICAgICAgICAgICAgKiByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtQcm9taXNlPX0gcHJvbWlzZSBQcm9taXNlIHJldHVybmVkIGJ5IHRoZSBgJHRpbWVvdXRgIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICAgICAgICAgICogICBjYW5jZWxlZC4KICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICB0aW1lb3V0LmNhbmNlbCA9IGZ1bmN0aW9uIChwcm9taXNlKSB7CiAgICAgICAgICAgICAgICAgICAgIGlmIChwcm9taXNlICYmIHByb21pc2UuJCR0aW1lb3V0SWQgaW4gZGVmZXJyZWRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRlZmVycmVkc1twcm9taXNlLiQkdGltZW91dElkXTsKICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkYnJvd3Nlci5kZWZlci5jYW5jZWwocHJvbWlzZS4kJHRpbWVvdXRJZCk7CiAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgIHJldHVybiB0aW1lb3V0OwogICAgICAgICAgICAgfV07CiAgICB9CgogICAgZnVuY3Rpb24gJCRVcmxVdGlsc1Byb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFtmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB1cmxQYXJzaW5nTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKSwKICAgICAgICAgICAgICAgIC8vIE5PVEU6ICBUaGUgdXNhZ2Ugb2Ygd2luZG93IGFuZCBkb2N1bWVudCBpbnN0ZWFkIG9mICR3aW5kb3cgYW5kICRkb2N1bWVudCBoZXJlIGlzCiAgICAgICAgICAgICAgICAvLyBkZWxpYmVyYXRlLiAgVGhpcyBzZXJ2aWNlIGRlcGVuZHMgb24gdGhlIHNwZWNpZmljIGJlaGF2aW9yIG9mIGFuY2hvciBub2RlcyBjcmVhdGVkIGJ5IHRoZQogICAgICAgICAgICAgICAgLy8gYnJvd3NlciAocmVzb2x2aW5nIGFuZCBwYXJzaW5nIFVSTHMpIHRoYXQgaXMgdW5saWtlbHkgdG8gYmUgcHJvdmlkZWQgYnkgbW9jayBvYmplY3RzIGFuZAogICAgICAgICAgICAgICAgLy8gY2F1c2UgdXMgdG8gYnJlYWsgdGVzdHMuICBJbiBhZGRpdGlvbiwgd2hlbiB0aGUgYnJvd3NlciByZXNvbHZlcyBhIFVSTCBmb3IgWEhSLCBpdAogICAgICAgICAgICAgICAgLy8gZG9lc24ndCBrbm93IGFib3V0IG1vY2tlZCBsb2NhdGlvbnMgYW5kIHJlc29sdmVzIFVSTHMgdG8gdGhlIHJlYWwgZG9jdW1lbnQgLSB3aGljaCBpcwogICAgICAgICAgICAgICAgLy8gZXhhY3RseSB0aGUgYmVoYXZpb3IgbmVlZGVkIGhlcmUuICBUaGVyZSBpcyBsaXR0bGUgdmFsdWUgaXMgbW9ja2luZyB0aGVzZSBvdXIgZm9yIHRoaXMKICAgICAgICAgICAgICAgIC8vIHNlcnZpY2UuCiAgICAgICAgICAgICAgICBvcmlnaW5VcmwgPSByZXNvbHZlKHdpbmRvdy5sb2NhdGlvbi5ocmVmLCB0cnVlKTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogTm9ybWFsaXplcyBhbmQgb3B0aW9uYWxseSBwYXJzZXMgYSBVUkwuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIE5PVEU6ICBUaGlzIGlzIGEgcHJpdmF0ZSBzZXJ2aWNlLiAgVGhlIEFQSSBpcyBzdWJqZWN0IHRvIGNoYW5nZSB1bnByZWRpY3RhYmx5IGluIGFueSBjb21taXQuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEltcGxlbWVudGF0aW9uIE5vdGVzIGZvciBub24tSUUgYnJvd3NlcnMKICAgICAgICAgICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgICAgICAgKiBBc3NpZ25pbmcgYSBVUkwgdG8gdGhlIGhyZWYgcHJvcGVydHkgb2YgYW4gYW5jaG9yIERPTSBub2RlLCBldmVuIG9uZSBhdHRhY2hlZCB0byB0aGUgRE9NLAogICAgICAgICAgICAgKiByZXN1bHRzIGJvdGggaW4gdGhlIG5vcm1hbGl6aW5nIGFuZCBwYXJzaW5nIG9mIHRoZSBVUkwuICBOb3JtYWxpemluZyBtZWFucyB0aGF0IGEgcmVsYXRpdmUKICAgICAgICAgICAgICogVVJMIHdpbGwgYmUgcmVzb2x2ZWQgaW50byBhbiBhYnNvbHV0ZSBVUkwgaW4gdGhlIGNvbnRleHQgb2YgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50LgogICAgICAgICAgICAgKiBQYXJzaW5nIG1lYW5zIHRoYXQgdGhlIGFuY2hvciBub2RlJ3MgaG9zdCwgaG9zdG5hbWUsIHByb3RvY29sLCBwb3J0LCBwYXRobmFtZSBhbmQgcmVsYXRlZAogICAgICAgICAgICAgKiBwcm9wZXJ0aWVzIGFyZSBhbGwgcG9wdWxhdGVkIHRvIHJlZmxlY3QgdGhlIG5vcm1hbGl6ZWQgVVJMLiAgVGhpcyBhcHByb2FjaCBoYXMgd2lkZQogICAgICAgICAgICAgKiBjb21wYXRpYmlsaXR5IC0gU2FmYXJpIDErLCBNb3ppbGxhIDErLCBPcGVyYSA3KyxlIGV0Yy4gIFNlZQogICAgICAgICAgICAgKiBodHRwOi8vd3d3LmFwdGFuYS5jb20vcmVmZXJlbmNlL2h0bWwvYXBpL0hUTUxBbmNob3JFbGVtZW50Lmh0bWwKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSW1wbGVtZW50YXRpb24gTm90ZXMgZm9yIElFCiAgICAgICAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgICAgICAgKiBJRSA+PSA4IGFuZCA8PSAxMCBub3JtYWxpemVzIHRoZSBVUkwgd2hlbiBhc3NpZ25lZCB0byB0aGUgYW5jaG9yIG5vZGUgc2ltaWxhciB0byB0aGUgb3RoZXIKICAgICAgICAgICAgICogYnJvd3NlcnMuICBIb3dldmVyLCB0aGUgcGFyc2VkIGNvbXBvbmVudHMgd2lsbCBub3QgYmUgc2V0IGlmIHRoZSBVUkwgYXNzaWduZWQgZGlkIG5vdCBzcGVjaWZ5CiAgICAgICAgICAgICAqIHRoZW0uICAoZS5nLiBpZiB5b3UgYXNzaWduIGEuaHJlZiA9ICJmb28iLCB0aGVuIGEucHJvdG9jb2wsIGEuaG9zdCwgZXRjLiB3aWxsIGJlIGVtcHR5LikgIFdlCiAgICAgICAgICAgICAqIHdvcmsgYXJvdW5kIHRoYXQgYnkgcGVyZm9ybWluZyB0aGUgcGFyc2luZyBpbiBhIDJuZCBzdGVwIGJ5IHRha2luZyBhIHByZXZpb3VzbHkgbm9ybWFsaXplZAogICAgICAgICAgICAgKiBVUkwgKGUuZy4gYnkgYXNzaW5pbmcgdG8gYS5ocmVmKSBhbmQgYXNzaWduaW5nIGl0IGEuaHJlZiBhZ2Fpbi4gIFRoaXMgY29ycmVjdGx5IHBvcHVsYXRlcyB0aGUKICAgICAgICAgICAgICogcHJvcGVydGllcyBzdWNoIGFzIHByb3RvY29sLCBob3N0bmFtZSwgcG9ydCwgZXRjLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBJRTcgZG9lcyBub3Qgbm9ybWFsaXplIHRoZSBVUkwgd2hlbiBhc3NpZ25lZCB0byBhbiBhbmNob3Igbm9kZS4gIChBcHBhcmVudGx5LCBpdCBkb2VzLCBpZiBvbmUKICAgICAgICAgICAgICogdXNlcyB0aGUgaW5uZXIgSFRNTCBhcHByb2FjaCB0byBhc3NpZ24gdGhlIFVSTCBhcyBwYXJ0IG9mIGFuIEhUTUwgc25pcHBldCAtCiAgICAgICAgICAgICAqIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzQ3MjcyOSkgIEhvd2V2ZXIsIHNldHRpbmcgaW1nW3NyY10gZG9lcyBub3JtYWxpemUgdGhlIFVSTC4KICAgICAgICAgICAgICogVW5mb3J0dW5hdGVseSwgc2V0dGluZyBpbWdbc3JjXSB0byBzb21ldGhpbmcgbGlrZSAiamF2YXNjcmlwdDpmb28iIG9uIElFIHRocm93cyBhbiBleGNlcHRpb24uCiAgICAgICAgICAgICAqIFNpbmNlIHRoZSBwcmltYXJ5IHVzYWdlIGZvciBub3JtYWxpemluZyBVUkxzIGlzIHRvIHNhbml0aXplIHN1Y2ggVVJMcywgd2UgY2FuJ3QgdXNlIHRoYXQKICAgICAgICAgICAgICogbWV0aG9kIGFuZCBJRSA8IDggaXMgdW5zdXBwb3J0ZWQuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFJlZmVyZW5jZXM6CiAgICAgICAgICAgICAqICAgaHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvSFRNTEFuY2hvckVsZW1lbnQKICAgICAgICAgICAgICogICBodHRwOi8vd3d3LmFwdGFuYS5jb20vcmVmZXJlbmNlL2h0bWwvYXBpL0hUTUxBbmNob3JFbGVtZW50Lmh0bWwKICAgICAgICAgICAgICogICBodHRwOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jdXJsdXRpbHMKICAgICAgICAgICAgICogICBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL3B1bGwvMjkwMgogICAgICAgICAgICAgKiAgIGh0dHA6Ly9qYW1lcy5wYWRvbHNleS5jb20vamF2YXNjcmlwdC9wYXJzaW5nLXVybHMtd2l0aC10aGUtZG9tLwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSBVUkwgdG8gYmUgcGFyc2VkLgogICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBwYXJzZSBXaGVuIHRydWUsIHJldHVybnMgYW4gb2JqZWN0IGZvciB0aGUgcGFyc2VkIFVSTC4gIE90aGVyd2lzZSwgcmV0dXJucwogICAgICAgICAgICAgKiAgIGEgc2luZ2xlIHN0cmluZyB0aGF0IGlzIHRoZSBub3JtYWxpemVkIFVSTC4KICAgICAgICAgICAgICogQHJldHVybnMge29iamVjdHxzdHJpbmd9IFdoZW4gcGFyc2UgaXMgdHJ1ZSwgcmV0dXJucyB0aGUgbm9ybWFsaXplZCBVUkwgYXMgYSBzdHJpbmcuCiAgICAgICAgICAgICAqIE90aGVyd2lzZSwgcmV0dXJucyBhbiBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIG1lbWJlcnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAgfCBtZW1iZXIgbmFtZSAgIHwgRGVzY3JpcHRpb24gICAgfAogICAgICAgICAgICAgKiAgIHwtLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICAgICAgICogICB8IGhyZWYgICAgICAgICAgfCBBIG5vcm1hbGl6ZWQgdmVyc2lvbiBvZiB0aGUgcHJvdmlkZWQgVVJMIGlmIGl0IHdhcyBub3QgYW4gYWJzb2x1dGUgVVJMIHwKICAgICAgICAgICAgICogICB8IHByb3RvY29sICAgICAgfCBUaGUgcHJvdG9jb2wgaW5jbHVkaW5nIHRoZSB0cmFpbGluZyBjb2xvbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogICB8IGhvc3QgICAgICAgICAgfCBUaGUgaG9zdCBhbmQgcG9ydCAoaWYgdGhlIHBvcnQgaXMgbm9uLWRlZmF1bHQpIG9mIHRoZSBub3JtYWxpemVkVXJsICAgIHwKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogVGhlc2UgZmllbGRzIGZyb20gdGhlIFVybFV0aWxzIGludGVyZmFjZSBhcmUgY3VycmVudGx5IG5vdCBuZWVkZWQgYW5kIGhlbmNlIG5vdCByZXR1cm5lZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICB8IG1lbWJlciBuYW1lICAgfCBEZXNjcmlwdGlvbiAgICB8CiAgICAgICAgICAgICAqICAgfC0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAgICAgKiAgIHwgaG9zdG5hbWUgICAgICB8IFRoZSBob3N0IHdpdGhvdXQgdGhlIHBvcnQgb2YgdGhlIG5vcm1hbGl6ZWRVcmwgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiAgIHwgcGF0aG5hbWUgICAgICB8IFRoZSBwYXRoIGZvbGxvd2luZyB0aGUgaG9zdCBpbiB0aGUgbm9ybWFsaXplZFVybCAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiAgIHwgaGFzaCAgICAgICAgICB8IFRoZSBVUkwgaGFzaCBpZiBwcmVzZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiAgIHwgc2VhcmNoICAgICAgICB8IFRoZSBxdWVyeSBzdHJpbmcgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZSh1cmwsIHBhcnNlKSB7CiAgICAgICAgICAgICAgICB2YXIgaHJlZiA9IHVybDsKICAgICAgICAgICAgICAgIGlmIChtc2llIDw9IDExKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTm9ybWFsaXplIGJlZm9yZSBwYXJzZS4gIFJlZmVyIEltcGxlbWVudGF0aW9uIE5vdGVzIG9uIHdoeSB0aGlzIGlzCiAgICAgICAgICAgICAgICAgICAgLy8gZG9uZSBpbiB0d28gc3RlcHMgb24gSUUuCiAgICAgICAgICAgICAgICAgICAgdXJsUGFyc2luZ05vZGUuc2V0QXR0cmlidXRlKCJocmVmIiwgaHJlZik7CiAgICAgICAgICAgICAgICAgICAgaHJlZiA9IHVybFBhcnNpbmdOb2RlLmhyZWY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1cmxQYXJzaW5nTm9kZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBocmVmKTsKCiAgICAgICAgICAgICAgICBpZiAoIXBhcnNlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVybFBhcnNpbmdOb2RlLmhyZWY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyB1cmxQYXJzaW5nTm9kZSBwcm92aWRlcyB0aGUgVXJsVXRpbHMgaW50ZXJmYWNlIC0gaHR0cDovL3VybC5zcGVjLndoYXR3Zy5vcmcvI3VybHV0aWxzCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIGhyZWY6IHVybFBhcnNpbmdOb2RlLmhyZWYsCiAgICAgICAgICAgICAgICAgICAgcHJvdG9jb2w6IHVybFBhcnNpbmdOb2RlLnByb3RvY29sLAogICAgICAgICAgICAgICAgICAgIGhvc3Q6IHVybFBhcnNpbmdOb2RlLmhvc3QKICAgICAgICAgICAgICAgICAgICAvLyBDdXJyZW50bHkgdW51c2VkIGFuZCBoZW5jZSBjb21tZW50ZWQgb3V0LgogICAgICAgICAgICAgICAgICAgIC8vIGhvc3RuYW1lOiB1cmxQYXJzaW5nTm9kZS5ob3N0bmFtZSwKICAgICAgICAgICAgICAgICAgICAvLyBwb3J0OiB1cmxQYXJzaW5nTm9kZS5wb3J0LAogICAgICAgICAgICAgICAgICAgIC8vIHBhdGhuYW1lOiB1cmxQYXJzaW5nTm9kZS5wYXRobmFtZSwKICAgICAgICAgICAgICAgICAgICAvLyBoYXNoOiB1cmxQYXJzaW5nTm9kZS5oYXNoLAogICAgICAgICAgICAgICAgICAgIC8vIHNlYXJjaDogdXJsUGFyc2luZ05vZGUuc2VhcmNoCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcmVzb2x2ZTogcmVzb2x2ZSwKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogUGFyc2UgYSByZXF1ZXN0IFVSTCBhbmQgZGV0ZXJtaW5lIHdoZXRoZXIgdGhpcyBpcyBhIHNhbWUtb3JpZ2luIHJlcXVlc3QgYXMgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gcmVxdWVzdFVybCBUaGUgdXJsIG9mIHRoZSByZXF1ZXN0IGFzIGEgc3RyaW5nIHRoYXQgd2lsbCBiZSByZXNvbHZlZAogICAgICAgICAgICAgICAgICogb3IgYSBwYXJzZWQgVVJMIG9iamVjdC4KICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSByZXF1ZXN0IGlzIGZvciB0aGUgc2FtZSBvcmlnaW4gYXMgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50LgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBpc1NhbWVPcmlnaW46IGZ1bmN0aW9uIGlzU2FtZU9yaWdpbihyZXF1ZXN0VXJsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcnNlZCA9ICh0eXBlb2YgcmVxdWVzdFVybCA9PT0gJ3N0cmluZycpID8gcmVzb2x2ZShyZXF1ZXN0VXJsLCB0cnVlKSA6IHJlcXVlc3RVcmw7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChwYXJzZWQucHJvdG9jb2wgPT09IG9yaWdpblVybC5wcm90b2NvbCAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VkLmhvc3QgPT09IG9yaWdpblVybC5ob3N0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiR3aW5kb3cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgcmVmZXJlbmNlIHRvIHRoZSBicm93c2VyJ3MgYHdpbmRvd2Agb2JqZWN0LiBXaGlsZSBgd2luZG93YAogICAgICogaXMgZ2xvYmFsbHkgYXZhaWxhYmxlIGluIEphdmFTY3JpcHQsIGl0IGNhdXNlcyB0ZXN0YWJpbGl0eSBwcm9ibGVtcywgYmVjYXVzZQogICAgICogaXQgaXMgYSBnbG9iYWwgdmFyaWFibGUuIEluIGFuZ3VsYXIgd2UgYWx3YXlzIHJlZmVyIHRvIGl0IHRocm91Z2ggdGhlCiAgICAgKiBgJHdpbmRvd2Agc2VydmljZSwgc28gaXQgbWF5IGJlIG92ZXJyaWRkZW4sIHJlbW92ZWQgb3IgbW9ja2VkIGZvciB0ZXN0aW5nLgogICAgICoKICAgICAqIEV4cHJlc3Npb25zLCBsaWtlIHRoZSBvbmUgZGVmaW5lZCBmb3IgdGhlIGBuZ0NsaWNrYCBkaXJlY3RpdmUgaW4gdGhlIGV4YW1wbGUKICAgICAqIGJlbG93LCBhcmUgZXZhbHVhdGVkIHdpdGggcmVzcGVjdCB0byB0aGUgY3VycmVudCBzY29wZS4gIFRoZXJlZm9yZSwgdGhlcmUgaXMKICAgICAqIG5vIHJpc2sgb2YgaW5hZHZlcnRlbnRseSBjb2RpbmcgaW4gYSBkZXBlbmRlbmN5IG9uIGEgZ2xvYmFsIHZhbHVlIGluIHN1Y2ggYW4KICAgICAqIGV4cHJlc3Npb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlLCAkd2luZG93KSB7CiAgICAgICAgICAgICAgICRzY29wZS4kd2luZG93ID0gJHdpbmRvdzsKICAgICAgICAgICAgICAgJHNjb3BlLmdyZWV0aW5nID0gJ0hlbGxvLCBXb3JsZCEnOwogICAgICAgICAgICAgfQogICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9ImdyZWV0aW5nIiAvPgogICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJHdpbmRvdy5hbGVydChncmVldGluZykiPkFMRVJUPC9idXR0b24+CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgIGl0KCdzaG91bGQgZGlzcGxheSB0aGUgZ3JlZXRpbmcgaW4gdGhlIGlucHV0IGJveCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCdncmVldGluZycpLmVudGVyKCdIZWxsbywgRTJFIFRlc3RzJyk7CiAgICAgICAgICAgLy8gSWYgd2UgY2xpY2sgdGhlIGJ1dHRvbiBpdCB3aWxsIGJsb2NrIHRoZSB0ZXN0IHJ1bm5lcgogICAgICAgICAgIC8vIGVsZW1lbnQoJzpidXR0b24nKS5jbGljaygpOwogICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgZnVuY3Rpb24gJFdpbmRvd1Byb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IHZhbHVlRm4od2luZG93KTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRmaWx0ZXJQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRmlsdGVycyBhcmUganVzdCBmdW5jdGlvbnMgd2hpY2ggdHJhbnNmb3JtIGlucHV0IHRvIGFuIG91dHB1dC4gSG93ZXZlciBmaWx0ZXJzIG5lZWQgdG8gYmUgRGVwZW5kZW5jeSBJbmplY3RlZC4gVG8KICAgICAqIGFjaGlldmUgdGhpcyBhIGZpbHRlciBkZWZpbml0aW9uIGNvbnNpc3RzIG9mIGEgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcyBhbm5vdGF0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgYW5kIGlzCiAgICAgKiByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgYSBmaWx0ZXIgZnVuY3Rpb24uCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gRmlsdGVyIHJlZ2lzdHJhdGlvbgogICAgICogICBmdW5jdGlvbiBNeU1vZHVsZSgkcHJvdmlkZSwgJGZpbHRlclByb3ZpZGVyKSB7CiAgICAgKiAgICAgLy8gY3JlYXRlIGEgc2VydmljZSB0byBkZW1vbnN0cmF0ZSBpbmplY3Rpb24gKG5vdCBhbHdheXMgbmVlZGVkKQogICAgICogICAgICRwcm92aWRlLnZhbHVlKCdncmVldCcsIGZ1bmN0aW9uKG5hbWUpewogICAgICogICAgICAgcmV0dXJuICdIZWxsbyAnICsgbmFtZSArICchJzsKICAgICAqICAgICB9KTsKICAgICAqCiAgICAgKiAgICAgLy8gcmVnaXN0ZXIgYSBmaWx0ZXIgZmFjdG9yeSB3aGljaCB1c2VzIHRoZQogICAgICogICAgIC8vIGdyZWV0IHNlcnZpY2UgdG8gZGVtb25zdHJhdGUgREkuCiAgICAgKiAgICAgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCdncmVldCcsIGZ1bmN0aW9uKGdyZWV0KXsKICAgICAqICAgICAgIC8vIHJldHVybiB0aGUgZmlsdGVyIGZ1bmN0aW9uIHdoaWNoIHVzZXMgdGhlIGdyZWV0IHNlcnZpY2UKICAgICAqICAgICAgIC8vIHRvIGdlbmVyYXRlIHNhbHV0YXRpb24KICAgICAqICAgICAgIHJldHVybiBmdW5jdGlvbih0ZXh0KSB7CiAgICAgKiAgICAgICAgIC8vIGZpbHRlcnMgbmVlZCB0byBiZSBmb3JnaXZpbmcgc28gY2hlY2sgaW5wdXQgdmFsaWRpdHkKICAgICAqICAgICAgICAgcmV0dXJuIHRleHQgJiYgZ3JlZXQodGV4dCkgfHwgdGV4dDsKICAgICAqICAgICAgIH07CiAgICAgKiAgICAgfSk7CiAgICAgKiAgIH0KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoZSBmaWx0ZXIgZnVuY3Rpb24gaXMgcmVnaXN0ZXJlZCB3aXRoIHRoZSBgJGluamVjdG9yYCB1bmRlciB0aGUgZmlsdGVyIG5hbWUgc3VmZml4IHdpdGggYEZpbHRlcmAuCiAgICAgKiA8cHJlPgogICAgICogICBpdCgnc2hvdWxkIGJlIHRoZSBzYW1lIGluc3RhbmNlJywgaW5qZWN0KAogICAgICogICAgIGZ1bmN0aW9uKCRmaWx0ZXJQcm92aWRlcikgewogICAgICogICAgICAgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCdyZXZlcnNlJywgZnVuY3Rpb24oKXsKICAgICAqICAgICAgICAgcmV0dXJuIC4uLjsKICAgICAqICAgICAgIH0pOwogICAgICogICAgIH0sCiAgICAgKiAgICAgZnVuY3Rpb24oJGZpbHRlciwgcmV2ZXJzZUZpbHRlcikgewogICAgICogICAgICAgZXhwZWN0KCRmaWx0ZXIoJ3JldmVyc2UnKSkudG9CZShyZXZlcnNlRmlsdGVyKTsKICAgICAqICAgICB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqCiAgICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBob3cgYW5ndWxhciBmaWx0ZXJzIHdvcmssIGFuZCBob3cgdG8gY3JlYXRlIHlvdXIgb3duIGZpbHRlcnMsIHNlZQogICAgICoge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS50ZW1wbGF0ZXMuZmlsdGVycyBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgRmlsdGVyc30gaW4gdGhlIGFuZ3VsYXIgRGV2ZWxvcGVyCiAgICAgKiBHdWlkZS4KICAgICAqLwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAqIEBtZXRob2RPZiBuZy4kZmlsdGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXIgZmlsdGVyIGZhY3RvcnkgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyLgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZm4gVGhlIGZpbHRlciBmYWN0b3J5IGZ1bmN0aW9uIHdoaWNoIGlzIGluamVjdGFibGUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRmaWx0ZXIKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGaWx0ZXJzIGFyZSB1c2VkIGZvciBmb3JtYXR0aW5nIGRhdGEgZGlzcGxheWVkIHRvIHRoZSB1c2VyLgogICAgICoKICAgICAqIFRoZSBnZW5lcmFsIHN5bnRheCBpbiB0ZW1wbGF0ZXMgaXMgYXMgZm9sbG93czoKICAgICAqCiAgICAgKiAgICAgICAgIHt7IGV4cHJlc3Npb24gW3wgZmlsdGVyX25hbWVbOnBhcmFtZXRlcl92YWx1ZV0gLi4uIF0gfX0KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIgZnVuY3Rpb24gdG8gcmV0cmlldmUKICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgKi8KICAgICRGaWx0ZXJQcm92aWRlci4kaW5qZWN0ID0gWyckcHJvdmlkZSddOwogICAgZnVuY3Rpb24gJEZpbHRlclByb3ZpZGVyKCRwcm92aWRlKSB7CiAgICAgICAgdmFyIHN1ZmZpeCA9ICdGaWx0ZXInOwoKICAgICAgICBmdW5jdGlvbiByZWdpc3RlcihuYW1lLCBmYWN0b3J5KSB7CiAgICAgICAgICAgIHJldHVybiAkcHJvdmlkZS5mYWN0b3J5KG5hbWUgKyBzdWZmaXgsIGZhY3RvcnkpOwogICAgICAgIH0KICAgICAgICB0aGlzLnJlZ2lzdGVyID0gcmVnaXN0ZXI7CgogICAgICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgZnVuY3Rpb24gKCRpbmplY3RvcikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkaW5qZWN0b3IuZ2V0KG5hbWUgKyBzdWZmaXgpOwogICAgICAgICAgICB9CiAgICAgICAgfV07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgcmVnaXN0ZXIoJ2N1cnJlbmN5JywgY3VycmVuY3lGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdkYXRlJywgZGF0ZUZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ2ZpbHRlcicsIGZpbHRlckZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ2pzb24nLCBqc29uRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignbGltaXRUbycsIGxpbWl0VG9GaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdsb3dlcmNhc2UnLCBsb3dlcmNhc2VGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdudW1iZXInLCBudW1iZXJGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdvcmRlckJ5Jywgb3JkZXJCeUZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ3VwcGVyY2FzZScsIHVwcGVyY2FzZUZpbHRlcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6ZmlsdGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNlbGVjdHMgYSBzdWJzZXQgb2YgaXRlbXMgZnJvbSBgYXJyYXlgIGFuZCByZXR1cm5zIGl0IGFzIGEgbmV3IGFycmF5LgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICAgKiB7QGxpbmsgbmcuJGZpbHRlcn0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIHNvdXJjZSBhcnJheS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdHxmdW5jdGlvbigpfSBleHByZXNzaW9uIFRoZSBwcmVkaWNhdGUgdG8gYmUgdXNlZCBmb3Igc2VsZWN0aW5nIGl0ZW1zIGZyb20KICAgICAqICAgYGFycmF5YC4KICAgICAqCiAgICAgKiAgIENhbiBiZSBvbmUgb2Y6CiAgICAgKgogICAgICogICAtIGBzdHJpbmdgOiBQcmVkaWNhdGUgdGhhdCByZXN1bHRzIGluIGEgc3Vic3RyaW5nIG1hdGNoIHVzaW5nIHRoZSB2YWx1ZSBvZiBgZXhwcmVzc2lvbmAKICAgICAqICAgICBzdHJpbmcuIEFsbCBzdHJpbmdzIG9yIG9iamVjdHMgd2l0aCBzdHJpbmcgcHJvcGVydGllcyBpbiBgYXJyYXlgIHRoYXQgY29udGFpbiB0aGlzIHN0cmluZwogICAgICogICAgIHdpbGwgYmUgcmV0dXJuZWQuIFRoZSBwcmVkaWNhdGUgY2FuIGJlIG5lZ2F0ZWQgYnkgcHJlZml4aW5nIHRoZSBzdHJpbmcgd2l0aCBgIWAuCiAgICAgKgogICAgICogICAtIGBPYmplY3RgOiBBIHBhdHRlcm4gb2JqZWN0IGNhbiBiZSB1c2VkIHRvIGZpbHRlciBzcGVjaWZpYyBwcm9wZXJ0aWVzIG9uIG9iamVjdHMgY29udGFpbmVkCiAgICAgKiAgICAgYnkgYGFycmF5YC4gRm9yIGV4YW1wbGUgYHtuYW1lOiJNIiwgcGhvbmU6IjEifWAgcHJlZGljYXRlIHdpbGwgcmV0dXJuIGFuIGFycmF5IG9mIGl0ZW1zCiAgICAgKiAgICAgd2hpY2ggaGF2ZSBwcm9wZXJ0eSBgbmFtZWAgY29udGFpbmluZyAiTSIgYW5kIHByb3BlcnR5IGBwaG9uZWAgY29udGFpbmluZyAiMSIuIEEgc3BlY2lhbAogICAgICogICAgIHByb3BlcnR5IG5hbWUgYCRgIGNhbiBiZSB1c2VkIChhcyBpbiBgeyQ6InRleHQifWApIHRvIGFjY2VwdCBhIG1hdGNoIGFnYWluc3QgYW55CiAgICAgKiAgICAgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4gVGhhdCdzIGVxdWl2YWxlbnQgdG8gdGhlIHNpbXBsZSBzdWJzdHJpbmcgbWF0Y2ggd2l0aCBhIGBzdHJpbmdgCiAgICAgKiAgICAgYXMgZGVzY3JpYmVkIGFib3ZlLgogICAgICoKICAgICAqICAgLSBgZnVuY3Rpb25gOiBBIHByZWRpY2F0ZSBmdW5jdGlvbiBjYW4gYmUgdXNlZCB0byB3cml0ZSBhcmJpdHJhcnkgZmlsdGVycy4gVGhlIGZ1bmN0aW9uIGlzCiAgICAgKiAgICAgY2FsbGVkIGZvciBlYWNoIGVsZW1lbnQgb2YgYGFycmF5YC4gVGhlIGZpbmFsIHJlc3VsdCBpcyBhbiBhcnJheSBvZiB0aG9zZSBlbGVtZW50cyB0aGF0CiAgICAgKiAgICAgdGhlIHByZWRpY2F0ZSByZXR1cm5lZCB0cnVlIGZvci4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV4cGVjdGVkLCBhY3R1YWwpfHRydWV8dW5kZWZpbmVkfSBjb21wYXJhdG9yIENvbXBhcmF0b3Igd2hpY2ggaXMgdXNlZCBpbgogICAgICogICAgIGRldGVybWluaW5nIGlmIHRoZSBleHBlY3RlZCB2YWx1ZSAoZnJvbSB0aGUgZmlsdGVyIGV4cHJlc3Npb24pIGFuZCBhY3R1YWwgdmFsdWUgKGZyb20KICAgICAqICAgICB0aGUgb2JqZWN0IGluIHRoZSBhcnJheSkgc2hvdWxkIGJlIGNvbnNpZGVyZWQgYSBtYXRjaC4KICAgICAqCiAgICAgKiAgIENhbiBiZSBvbmUgb2Y6CiAgICAgKgogICAgICogICAgIC0gYGZ1bmN0aW9uKGV4cGVjdGVkLCBhY3R1YWwpYDoKICAgICAqICAgICAgIFRoZSBmdW5jdGlvbiB3aWxsIGJlIGdpdmVuIHRoZSBvYmplY3QgdmFsdWUgYW5kIHRoZSBwcmVkaWNhdGUgdmFsdWUgdG8gY29tcGFyZSBhbmQKICAgICAqICAgICAgIHNob3VsZCByZXR1cm4gdHJ1ZSBpZiB0aGUgaXRlbSBzaG91bGQgYmUgaW5jbHVkZWQgaW4gZmlsdGVyZWQgcmVzdWx0LgogICAgICoKICAgICAqICAgICAtIGB0cnVlYDogQSBzaG9ydGhhbmQgZm9yIGBmdW5jdGlvbihleHBlY3RlZCwgYWN0dWFsKSB7IHJldHVybiBhbmd1bGFyLmVxdWFscyhleHBlY3RlZCwgYWN0dWFsKX1gLgogICAgICogICAgICAgdGhpcyBpcyBlc3NlbnRpYWxseSBzdHJpY3QgY29tcGFyaXNvbiBvZiBleHBlY3RlZCBhbmQgYWN0dWFsLgogICAgICoKICAgICAqICAgICAtIGBmYWxzZXx1bmRlZmluZWRgOiBBIHNob3J0IGhhbmQgZm9yIGEgZnVuY3Rpb24gd2hpY2ggd2lsbCBsb29rIGZvciBhIHN1YnN0cmluZyBtYXRjaCBpbiBjYXNlCiAgICAgKiAgICAgICBpbnNlbnNpdGl2ZSB3YXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgPGRpdiBuZy1pbml0PSJmcmllbmRzID0gW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjc2J30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidNYXJ5JywgcGhvbmU6JzgwMC1CSUctTUFSWSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonTWlrZScsIHBob25lOic1NTUtNDMyMSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonSnVsaWUnLCBwaG9uZTonNTU1LTg3NjUnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge25hbWU6J0p1bGlldHRlJywgcGhvbmU6JzU1NS01Njc4J31dIj48L2Rpdj4KICAgIAogICAgICAgICAgIFNlYXJjaDogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2hUZXh0Ij4KICAgICAgICAgICA8dGFibGUgaWQ9InNlYXJjaFRleHRSZXN1bHRzIj4KICAgICAgICAgICAgIDx0cj48dGg+TmFtZTwvdGg+PHRoPlBob25lPC90aD48L3RyPgogICAgICAgICAgICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBmaWx0ZXI6c2VhcmNoVGV4dCI+CiAgICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgICAgICAgICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgICAgPGhyPgogICAgICAgICAgIEFueTogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2guJCI+IDxicj4KICAgICAgICAgICBOYW1lIG9ubHkgPGlucHV0IG5nLW1vZGVsPSJzZWFyY2gubmFtZSI+PGJyPgogICAgICAgICAgIFBob25lIG9ubHkgPGlucHV0IG5nLW1vZGVsPSJzZWFyY2gucGhvbmUiPjxicj4KICAgICAgICAgICBFcXVhbGl0eSA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJzdHJpY3QiPjxicj4KICAgICAgICAgICA8dGFibGUgaWQ9InNlYXJjaE9ialJlc3VsdHMiPgogICAgICAgICAgICAgPHRyPjx0aD5OYW1lPC90aD48dGg+UGhvbmU8L3RoPjwvdHI+CiAgICAgICAgICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2g6c3RyaWN0Ij4KICAgICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgPC90YWJsZT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgIGl0KCdzaG91bGQgc2VhcmNoIGFjcm9zcyBhbGwgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGlucHV0KCdzZWFyY2hUZXh0JykuZW50ZXIoJ20nKTsKICAgICAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaFRleHRSZXN1bHRzIHRyJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICAgICAgdG9FcXVhbChbJ01hcnknLCAnTWlrZScsICdBZGFtJ10pOwogICAgCiAgICAgICAgICAgICBpbnB1dCgnc2VhcmNoVGV4dCcpLmVudGVyKCc3NicpOwogICAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcjc2VhcmNoVGV4dFJlc3VsdHMgdHInLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgICAgICB0b0VxdWFsKFsnSm9obicsICdKdWxpZSddKTsKICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgIGl0KCdzaG91bGQgc2VhcmNoIGluIHNwZWNpZmljIGZpZWxkcyB3aGVuIGZpbHRlcmluZyB3aXRoIGEgcHJlZGljYXRlIG9iamVjdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgaW5wdXQoJ3NlYXJjaC4kJykuZW50ZXIoJ2knKTsKICAgICAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaE9ialJlc3VsdHMgdHInLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdNaWtlJywgJ0p1bGllJywgJ0p1bGlldHRlJ10pOwogICAgICAgICAgIH0pOwogICAgICAgICAgIGl0KCdzaG91bGQgdXNlIGEgZXF1YWwgY29tcGFyaXNvbiB3aGVuIGNvbXBhcmF0b3IgaXMgdHJ1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgaW5wdXQoJ3NlYXJjaC5uYW1lJykuZW50ZXIoJ0p1bGllJyk7CiAgICAgICAgICAgICBpbnB1dCgnc3RyaWN0JykuY2hlY2soKTsKICAgICAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaE9ialJlc3VsdHMgdHInLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgICAgICB0b0VxdWFsKFsnSnVsaWUnXSk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgZnVuY3Rpb24gZmlsdGVyRmlsdGVyKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJyYXksIGV4cHJlc3Npb24sIGNvbXBlcmF0b3IpIHsKICAgICAgICAgICAgaWYgKCFpc0FycmF5KGFycmF5KSkgcmV0dXJuIGFycmF5OwogICAgICAgICAgICB2YXIgcHJlZGljYXRlcyA9IFtdOwogICAgICAgICAgICBwcmVkaWNhdGVzLmNoZWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHByZWRpY2F0ZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXByZWRpY2F0ZXNbal0odmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgY29tcGVyYXRvcikgewogICAgICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBlcmF0b3IgPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb21wZXJhdG9yID0gZnVuY3Rpb24gKG9iaiwgdGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuZXF1YWxzKG9iaiwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBjb21wZXJhdG9yID0gZnVuY3Rpb24gKG9iaiwgdGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gKCcnICsgdGV4dCkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgnJyArIG9iaikudG9Mb3dlckNhc2UoKS5pbmRleE9mKHRleHQpID4gLTEKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzZWFyY2ggPSBmdW5jdGlvbiAob2JqLCB0ZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRleHQgPT0gJ3N0cmluZycgJiYgdGV4dC5jaGFyQXQoMCkgPT09ICchJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhc2VhcmNoKG9iaiwgdGV4dC5zdWJzdHIoMSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlb2Ygb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29tcGVyYXRvcihvYmosIHRleHQpOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBlcmF0b3Iob2JqLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgb2JqS2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqS2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmIHNlYXJjaChvYmpbb2JqS2V5XSwgdGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBjYXNlICJhcnJheSI6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VhcmNoKG9ialtpXSwgdGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBleHByZXNzaW9uKSB7CiAgICAgICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB7ICQ6IGV4cHJlc3Npb24gfTsKICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnJCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFleHByZXNzaW9uW2tleV0pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IGtleQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZXMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaCh2YWx1ZSwgZXhwcmVzc2lvbltwYXRoXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIChleHByZXNzaW9uW2tleV0pID09ICd1bmRlZmluZWQnKSB7IHJldHVybjsgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZXMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaChnZXR0ZXIodmFsdWUsIHBhdGgpLCBleHByZXNzaW9uW3BhdGhdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbHRlcmVkID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXJyYXkubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2pdOwogICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZXMuY2hlY2sodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZpbHRlcmVkOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpjdXJyZW5jeQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGb3JtYXRzIGEgbnVtYmVyIGFzIGEgY3VycmVuY3kgKGllICQxLDIzNC41NikuIFdoZW4gbm8gY3VycmVuY3kgc3ltYm9sIGlzIHByb3ZpZGVkLCBkZWZhdWx0CiAgICAgKiBzeW1ib2wgZm9yIGN1cnJlbnQgbG9jYWxlIGlzIHVzZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCBJbnB1dCB0byBmaWx0ZXIuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHN5bWJvbCBDdXJyZW5jeSBzeW1ib2wgb3IgaWRlbnRpZmllciB0byBiZSBkaXNwbGF5ZWQuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBGb3JtYXR0ZWQgbnVtYmVyLgogICAgICoKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLmFtb3VudCA9IDEyMzQuNTY7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIG5nLW1vZGVsPSJhbW91bnQiPiA8YnI+CiAgICAgICAgICAgICBkZWZhdWx0IGN1cnJlbmN5IHN5bWJvbCAoJCk6IHt7YW1vdW50IHwgY3VycmVuY3l9fTxicj4KICAgICAgICAgICAgIGN1c3RvbSBjdXJyZW5jeSBpZGVudGlmaWVyIChVU0QkKToge3thbW91bnQgfCBjdXJyZW5jeToiVVNEJCJ9fQogICAgICAgICAgIDwvZGl2PgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBpbml0IHdpdGggMTIzNC41NicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5JykpLnRvQmUoJyQxLDIzNC41NicpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIicpKS50b0JlKCdVU0QkMSwyMzQuNTYnKTsKICAgICAgICAgICB9KTsKICAgICAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgaW5wdXQoJ2Ftb3VudCcpLmVudGVyKCctMTIzNCcpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5JykpLnRvQmUoJygkMSwyMzQuMDApJyk7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLnRvQmUoJyhVU0QkMSwyMzQuMDApJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgY3VycmVuY3lGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogICAgZnVuY3Rpb24gY3VycmVuY3lGaWx0ZXIoJGxvY2FsZSkgewogICAgICAgIHZhciBmb3JtYXRzID0gJGxvY2FsZS5OVU1CRVJfRk9STUFUUzsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGFtb3VudCwgY3VycmVuY3lTeW1ib2wpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGN1cnJlbmN5U3ltYm9sKSkgY3VycmVuY3lTeW1ib2wgPSBmb3JtYXRzLkNVUlJFTkNZX1NZTTsKICAgICAgICAgICAgcmV0dXJuIGZvcm1hdE51bWJlcihhbW91bnQsIGZvcm1hdHMuUEFUVEVSTlNbMV0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLCAyKS4KICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvXHUwMEE0L2csIGN1cnJlbmN5U3ltYm9sKTsKICAgICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOm51bWJlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGb3JtYXRzIGEgbnVtYmVyIGFzIHRleHQuCiAgICAgKgogICAgICogSWYgdGhlIGlucHV0IGlzIG5vdCBhIG51bWJlciBhbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBudW1iZXIgTnVtYmVyIHRvIGZvcm1hdC4KICAgICAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmcpPX0gZnJhY3Rpb25TaXplIE51bWJlciBvZiBkZWNpbWFsIHBsYWNlcyB0byByb3VuZCB0aGUgbnVtYmVyIHRvLgogICAgICogSWYgdGhpcyBpcyBub3QgcHJvdmlkZWQgdGhlbiB0aGUgZnJhY3Rpb24gc2l6ZSBpcyBjb21wdXRlZCBmcm9tIHRoZSBjdXJyZW50IGxvY2FsZSdzIG51bWJlcgogICAgICogZm9ybWF0dGluZyBwYXR0ZXJuLiBJbiB0aGUgY2FzZSBvZiB0aGUgZGVmYXVsdCBsb2NhbGUsIGl0IHdpbGwgYmUgMy4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE51bWJlciByb3VuZGVkIHRvIGRlY2ltYWxQbGFjZXMgYW5kIHBsYWNlcyBhIOKAnCzigJ0gYWZ0ZXIgZWFjaCB0aGlyZCBkaWdpdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLnZhbCA9IDEyMzQuNTY3ODk7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIEVudGVyIG51bWJlcjogPGlucHV0IG5nLW1vZGVsPSd2YWwnPjxicj4KICAgICAgICAgICAgIERlZmF1bHQgZm9ybWF0dGluZzoge3t2YWwgfCBudW1iZXJ9fTxicj4KICAgICAgICAgICAgIE5vIGZyYWN0aW9uczoge3t2YWwgfCBudW1iZXI6MH19PGJyPgogICAgICAgICAgICAgTmVnYXRpdmUgbnVtYmVyOiB7ey12YWwgfCBudW1iZXI6NH19CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCBudW1iZXJzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyJykpLnRvQmUoJzEsMjM0LjU2OCcpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcjowJykpLnRvQmUoJzEsMjM1Jyk7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnLXZhbCB8IG51bWJlcjo0JykpLnRvQmUoJy0xLDIzNC41Njc5Jyk7CiAgICAgICAgICAgfSk7CiAgICAKICAgICAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgaW5wdXQoJ3ZhbCcpLmVudGVyKCczMzc0LjMzMycpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcicpKS50b0JlKCczLDM3NC4zMzMnKTsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWwgfCBudW1iZXI6MCcpKS50b0JlKCczLDM3NCcpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS50b0JlKCctMywzNzQuMzMzMCcpOwogICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCgogICAgbnVtYmVyRmlsdGVyLiRpbmplY3QgPSBbJyRsb2NhbGUnXTsKICAgIGZ1bmN0aW9uIG51bWJlckZpbHRlcigkbG9jYWxlKSB7CiAgICAgICAgdmFyIGZvcm1hdHMgPSAkbG9jYWxlLk5VTUJFUl9GT1JNQVRTOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAobnVtYmVyLCBmcmFjdGlvblNpemUpIHsKICAgICAgICAgICAgcmV0dXJuIGZvcm1hdE51bWJlcihudW1iZXIsIGZvcm1hdHMuUEFUVEVSTlNbMF0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLAogICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgfTsKICAgIH0KCiAgICB2YXIgREVDSU1BTF9TRVAgPSAnLic7CiAgICBmdW5jdGlvbiBmb3JtYXROdW1iZXIobnVtYmVyLCBwYXR0ZXJuLCBncm91cFNlcCwgZGVjaW1hbFNlcCwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgaWYgKGlzTmFOKG51bWJlcikgfHwgIWlzRmluaXRlKG51bWJlcikpIHJldHVybiAnJzsKCiAgICAgICAgdmFyIGlzTmVnYXRpdmUgPSBudW1iZXIgPCAwOwogICAgICAgIG51bWJlciA9IE1hdGguYWJzKG51bWJlcik7CiAgICAgICAgdmFyIG51bVN0ciA9IG51bWJlciArICcnLAogICAgICAgICAgICBmb3JtYXRlZFRleHQgPSAnJywKICAgICAgICAgICAgcGFydHMgPSBbXTsKCiAgICAgICAgdmFyIGhhc0V4cG9uZW50ID0gZmFsc2U7CiAgICAgICAgaWYgKG51bVN0ci5pbmRleE9mKCdlJykgIT09IC0xKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IG51bVN0ci5tYXRjaCgvKFtcZFwuXSspZSgtPykoXGQrKS8pOwogICAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMl0gPT0gJy0nICYmIG1hdGNoWzNdID4gZnJhY3Rpb25TaXplICsgMSkgewogICAgICAgICAgICAgICAgbnVtU3RyID0gJzAnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ID0gbnVtU3RyOwogICAgICAgICAgICAgICAgaGFzRXhwb25lbnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhhc0V4cG9uZW50KSB7CiAgICAgICAgICAgIHZhciBmcmFjdGlvbkxlbiA9IChudW1TdHIuc3BsaXQoREVDSU1BTF9TRVApWzFdIHx8ICcnKS5sZW5ndGg7CgogICAgICAgICAgICAvLyBkZXRlcm1pbmUgZnJhY3Rpb25TaXplIGlmIGl0IGlzIG5vdCBzcGVjaWZpZWQKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGZyYWN0aW9uU2l6ZSkpIHsKICAgICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSA9IE1hdGgubWluKE1hdGgubWF4KHBhdHRlcm4ubWluRnJhYywgZnJhY3Rpb25MZW4pLCBwYXR0ZXJuLm1heEZyYWMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcG93ID0gTWF0aC5wb3coMTAsIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgICAgIG51bWJlciA9IE1hdGgucm91bmQobnVtYmVyICogcG93KSAvIHBvdzsKICAgICAgICAgICAgdmFyIGZyYWN0aW9uID0gKCcnICsgbnVtYmVyKS5zcGxpdChERUNJTUFMX1NFUCk7CiAgICAgICAgICAgIHZhciB3aG9sZSA9IGZyYWN0aW9uWzBdOwogICAgICAgICAgICBmcmFjdGlvbiA9IGZyYWN0aW9uWzFdIHx8ICcnOwoKICAgICAgICAgICAgdmFyIHBvcyA9IDAsCiAgICAgICAgICAgICAgICBsZ3JvdXAgPSBwYXR0ZXJuLmxnU2l6ZSwKICAgICAgICAgICAgICAgIGdyb3VwID0gcGF0dGVybi5nU2l6ZTsKCiAgICAgICAgICAgIGlmICh3aG9sZS5sZW5ndGggPj0gKGxncm91cCArIGdyb3VwKSkgewogICAgICAgICAgICAgICAgcG9zID0gd2hvbGUubGVuZ3RoIC0gbGdyb3VwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwb3M7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICgocG9zIC0gaSkgJSBncm91cCA9PT0gMCAmJiBpICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IHdob2xlLmNoYXJBdChpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gcG9zOyBpIDwgd2hvbGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICgod2hvbGUubGVuZ3RoIC0gaSkgJSBsZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZvcm1hdCBmcmFjdGlvbiBwYXJ0LgogICAgICAgICAgICB3aGlsZSAoZnJhY3Rpb24ubGVuZ3RoIDwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgICAgICAgICBmcmFjdGlvbiArPSAnMCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmcmFjdGlvblNpemUgJiYgZnJhY3Rpb25TaXplICE9PSAiMCIpIGZvcm1hdGVkVGV4dCArPSBkZWNpbWFsU2VwICsgZnJhY3Rpb24uc3Vic3RyKDAsIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIGlmIChmcmFjdGlvblNpemUgPiAwICYmIG51bWJlciA+IC0xICYmIG51bWJlciA8IDEpIHsKICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCA9IG51bWJlci50b0ZpeGVkKGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBhcnRzLnB1c2goaXNOZWdhdGl2ZSA/IHBhdHRlcm4ubmVnUHJlIDogcGF0dGVybi5wb3NQcmUpOwogICAgICAgIHBhcnRzLnB1c2goZm9ybWF0ZWRUZXh0KTsKICAgICAgICBwYXJ0cy5wdXNoKGlzTmVnYXRpdmUgPyBwYXR0ZXJuLm5lZ1N1ZiA6IHBhdHRlcm4ucG9zU3VmKTsKICAgICAgICByZXR1cm4gcGFydHMuam9pbignJyk7CiAgICB9CgogICAgZnVuY3Rpb24gcGFkTnVtYmVyKG51bSwgZGlnaXRzLCB0cmltKSB7CiAgICAgICAgdmFyIG5lZyA9ICcnOwogICAgICAgIGlmIChudW0gPCAwKSB7CiAgICAgICAgICAgIG5lZyA9ICctJzsKICAgICAgICAgICAgbnVtID0gLW51bTsKICAgICAgICB9CiAgICAgICAgbnVtID0gJycgKyBudW07CiAgICAgICAgd2hpbGUgKG51bS5sZW5ndGggPCBkaWdpdHMpIG51bSA9ICcwJyArIG51bTsKICAgICAgICBpZiAodHJpbSkKICAgICAgICAgICAgbnVtID0gbnVtLnN1YnN0cihudW0ubGVuZ3RoIC0gZGlnaXRzKTsKICAgICAgICByZXR1cm4gbmVnICsgbnVtOwogICAgfQoKCiAgICBmdW5jdGlvbiBkYXRlR2V0dGVyKG5hbWUsIHNpemUsIG9mZnNldCwgdHJpbSkgewogICAgICAgIG9mZnNldCA9IG9mZnNldCB8fCAwOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZGF0ZSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKICAgICAgICAgICAgaWYgKG9mZnNldCA+IDAgfHwgdmFsdWUgPiAtb2Zmc2V0KQogICAgICAgICAgICAgICAgdmFsdWUgKz0gb2Zmc2V0OwogICAgICAgICAgICBpZiAodmFsdWUgPT09IDAgJiYgb2Zmc2V0ID09IC0xMikgdmFsdWUgPSAxMjsKICAgICAgICAgICAgcmV0dXJuIHBhZE51bWJlcih2YWx1ZSwgc2l6ZSwgdHJpbSk7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBkYXRlU3RyR2V0dGVyKG5hbWUsIHNob3J0Rm9ybSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZGF0ZSwgZm9ybWF0cykgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKICAgICAgICAgICAgdmFyIGdldCA9IHVwcGVyY2FzZShzaG9ydEZvcm0gPyAoJ1NIT1JUJyArIG5hbWUpIDogbmFtZSk7CgogICAgICAgICAgICByZXR1cm4gZm9ybWF0c1tnZXRdW3ZhbHVlXTsKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHRpbWVab25lR2V0dGVyKGRhdGUpIHsKICAgICAgICB2YXIgem9uZSA9IC0xICogZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgICAgIHZhciBwYWRkZWRab25lID0gKHpvbmUgPj0gMCkgPyAiKyIgOiAiIjsKCiAgICAgICAgcGFkZGVkWm9uZSArPSBwYWROdW1iZXIoTWF0aFt6b25lID4gMCA/ICdmbG9vcicgOiAnY2VpbCddKHpvbmUgLyA2MCksIDIpICsKICAgICAgICAgICAgICAgICAgICAgIHBhZE51bWJlcihNYXRoLmFicyh6b25lICUgNjApLCAyKTsKCiAgICAgICAgcmV0dXJuIHBhZGRlZFpvbmU7CiAgICB9CgogICAgZnVuY3Rpb24gYW1wbUdldHRlcihkYXRlLCBmb3JtYXRzKSB7CiAgICAgICAgcmV0dXJuIGRhdGUuZ2V0SG91cnMoKSA8IDEyID8gZm9ybWF0cy5BTVBNU1swXSA6IGZvcm1hdHMuQU1QTVNbMV07CiAgICB9CgogICAgdmFyIERBVEVfRk9STUFUUyA9IHsKICAgICAgICB5eXl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDQpLAogICAgICAgIHl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDIsIDAsIHRydWUpLAogICAgICAgIHk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMSksCiAgICAgICAgTU1NTTogZGF0ZVN0ckdldHRlcignTW9udGgnKSwKICAgICAgICBNTU06IGRhdGVTdHJHZXR0ZXIoJ01vbnRoJywgdHJ1ZSksCiAgICAgICAgTU06IGRhdGVHZXR0ZXIoJ01vbnRoJywgMiwgMSksCiAgICAgICAgTTogZGF0ZUdldHRlcignTW9udGgnLCAxLCAxKSwKICAgICAgICBkZDogZGF0ZUdldHRlcignRGF0ZScsIDIpLAogICAgICAgIGQ6IGRhdGVHZXR0ZXIoJ0RhdGUnLCAxKSwKICAgICAgICBISDogZGF0ZUdldHRlcignSG91cnMnLCAyKSwKICAgICAgICBIOiBkYXRlR2V0dGVyKCdIb3VycycsIDEpLAogICAgICAgIGhoOiBkYXRlR2V0dGVyKCdIb3VycycsIDIsIC0xMiksCiAgICAgICAgaDogZGF0ZUdldHRlcignSG91cnMnLCAxLCAtMTIpLAogICAgICAgIG1tOiBkYXRlR2V0dGVyKCdNaW51dGVzJywgMiksCiAgICAgICAgbTogZGF0ZUdldHRlcignTWludXRlcycsIDEpLAogICAgICAgIHNzOiBkYXRlR2V0dGVyKCdTZWNvbmRzJywgMiksCiAgICAgICAgczogZGF0ZUdldHRlcignU2Vjb25kcycsIDEpLAogICAgICAgIC8vIHdoaWxlIElTTyA4NjAxIHJlcXVpcmVzIGZyYWN0aW9ucyB0byBiZSBwcmVmaXhlZCB3aXRoIGAuYCBvciBgLGAKICAgICAgICAvLyB3ZSBjYW4gYmUganVzdCBzYWZlbHkgcmVseSBvbiB1c2luZyBgc3NzYCBzaW5jZSB3ZSBjdXJyZW50bHkgZG9uJ3Qgc3VwcG9ydCBzaW5nbGUgb3IgdHdvIGRpZ2l0IGZyYWN0aW9ucwogICAgICAgIHNzczogZGF0ZUdldHRlcignTWlsbGlzZWNvbmRzJywgMyksCiAgICAgICAgRUVFRTogZGF0ZVN0ckdldHRlcignRGF5JyksCiAgICAgICAgRUVFOiBkYXRlU3RyR2V0dGVyKCdEYXknLCB0cnVlKSwKICAgICAgICBhOiBhbXBtR2V0dGVyLAogICAgICAgIFo6IHRpbWVab25lR2V0dGVyCiAgICB9OwoKICAgIHZhciBEQVRFX0ZPUk1BVFNfU1BMSVQgPSAvKCg/OlteeU1kSGhtc2FaRSddKyl8KD86Jyg/OlteJ118JycpKicpfCg/OkUrfHkrfE0rfGQrfEgrfGgrfG0rfHMrfGF8WikpKC4qKS8sCiAgICAgICAgTlVNQkVSX1NUUklORyA9IC9eXGQrJC87CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6ZGF0ZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAgIEZvcm1hdHMgYGRhdGVgIHRvIGEgc3RyaW5nIGJhc2VkIG9uIHRoZSByZXF1ZXN0ZWQgYGZvcm1hdGAuCiAgICAgKgogICAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGJlIGNvbXBvc2VkIG9mIHRoZSBmb2xsb3dpbmcgZWxlbWVudHM6CiAgICAgKgogICAgICogICAqIGAneXl5eSdgOiA0IGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIgKGUuZy4gQUQgMSA9PiAwMDAxLCBBRCAyMDEwID0+IDIwMTApCiAgICAgKiAgICogYCd5eSdgOiAyIGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIsIHBhZGRlZCAoMDAtOTkpLiAoZS5nLiBBRCAyMDAxID0+IDAxLCBBRCAyMDEwID0+IDEwKQogICAgICogICAqIGAneSdgOiAxIGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIsIGUuZy4gKEFEIDEgPT4gMSwgQUQgMTk5ID0+IDE5OSkKICAgICAqICAgKiBgJ01NTU0nYDogTW9udGggaW4geWVhciAoSmFudWFyeS1EZWNlbWJlcikKICAgICAqICAgKiBgJ01NTSdgOiBNb250aCBpbiB5ZWFyIChKYW4tRGVjKQogICAgICogICAqIGAnTU0nYDogTW9udGggaW4geWVhciwgcGFkZGVkICgwMS0xMikKICAgICAqICAgKiBgJ00nYDogTW9udGggaW4geWVhciAoMS0xMikKICAgICAqICAgKiBgJ2RkJ2A6IERheSBpbiBtb250aCwgcGFkZGVkICgwMS0zMSkKICAgICAqICAgKiBgJ2QnYDogRGF5IGluIG1vbnRoICgxLTMxKQogICAgICogICAqIGAnRUVFRSdgOiBEYXkgaW4gV2VlaywoU3VuZGF5LVNhdHVyZGF5KQogICAgICogICAqIGAnRUVFJ2A6IERheSBpbiBXZWVrLCAoU3VuLVNhdCkKICAgICAqICAgKiBgJ0hIJ2A6IEhvdXIgaW4gZGF5LCBwYWRkZWQgKDAwLTIzKQogICAgICogICAqIGAnSCdgOiBIb3VyIGluIGRheSAoMC0yMykKICAgICAqICAgKiBgJ2hoJ2A6IEhvdXIgaW4gYW0vcG0sIHBhZGRlZCAoMDEtMTIpCiAgICAgKiAgICogYCdoJ2A6IEhvdXIgaW4gYW0vcG0sICgxLTEyKQogICAgICogICAqIGAnbW0nYDogTWludXRlIGluIGhvdXIsIHBhZGRlZCAoMDAtNTkpCiAgICAgKiAgICogYCdtJ2A6IE1pbnV0ZSBpbiBob3VyICgwLTU5KQogICAgICogICAqIGAnc3MnYDogU2Vjb25kIGluIG1pbnV0ZSwgcGFkZGVkICgwMC01OSkKICAgICAqICAgKiBgJ3MnYDogU2Vjb25kIGluIG1pbnV0ZSAoMC01OSkKICAgICAqICAgKiBgJy5zc3MnIG9yICcsc3NzJ2A6IE1pbGxpc2Vjb25kIGluIHNlY29uZCwgcGFkZGVkICgwMDAtOTk5KQogICAgICogICAqIGAnYSdgOiBhbS9wbSBtYXJrZXIKICAgICAqICAgKiBgJ1onYDogNCBkaWdpdCAoK3NpZ24pIHJlcHJlc2VudGF0aW9uIG9mIHRoZSB0aW1lem9uZSBvZmZzZXQgKC0xMjAwLSsxMjAwKQogICAgICoKICAgICAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBhbHNvIGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nIHByZWRlZmluZWQKICAgICAqICAge0BsaW5rIGd1aWRlL2kxOG4gbG9jYWxpemFibGUgZm9ybWF0c306CiAgICAgKgogICAgICogICAqIGAnbWVkaXVtJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSBoOm1tOnNzIGEnYCBmb3IgZW5fVVMgbG9jYWxlCiAgICAgKiAgICAgKGUuZy4gU2VwIDMsIDIwMTAgMTI6MDU6MDggcG0pCiAgICAgKiAgICogYCdzaG9ydCdgOiBlcXVpdmFsZW50IHRvIGAnTS9kL3l5IGg6bW0gYSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIDkvMy8xMCAxMjowNSBwbSkKICAgICAqICAgKiBgJ2Z1bGxEYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdFRUVFLCBNTU1NIGQseSdgIGZvciBlbl9VUyAgbG9jYWxlCiAgICAgKiAgICAgKGUuZy4gRnJpZGF5LCBTZXB0ZW1iZXIgMywgMjAxMCkKICAgICAqICAgKiBgJ2xvbmdEYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU1NIGQsIHknYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiBTZXB0ZW1iZXIgMywgMjAxMCkKICAgICAqICAgKiBgJ21lZGl1bURhdGUnYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5J2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gU2VwIDMsIDIwMTApCiAgICAgKiAgICogYCdzaG9ydERhdGUnYDogZXF1aXZhbGVudCB0byBgJ00vZC95eSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gOS8zLzEwKQogICAgICogICAqIGAnbWVkaXVtVGltZSdgOiBlcXVpdmFsZW50IHRvIGAnaDptbTpzcyBhJ2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiAxMjowNTowOCBwbSkKICAgICAqICAgKiBgJ3Nob3J0VGltZSdgOiBlcXVpdmFsZW50IHRvIGAnaDptbSBhJ2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiAxMjowNSBwbSkKICAgICAqCiAgICAgKiAgIGBmb3JtYXRgIHN0cmluZyBjYW4gY29udGFpbiBsaXRlcmFsIHZhbHVlcy4gVGhlc2UgbmVlZCB0byBiZSBxdW90ZWQgd2l0aCBzaW5nbGUgcXVvdGVzIChlLmcuCiAgICAgKiAgIGAiaCAnaW4gdGhlIG1vcm5pbmcnImApLiBJbiBvcmRlciB0byBvdXRwdXQgc2luZ2xlIHF1b3RlLCB1c2UgdHdvIHNpbmdsZSBxdW90ZXMgaW4gYSBzZXF1ZW5jZQogICAgICogICAoZS5nLiBgImggJ28nJ2Nsb2NrJyJgKS4KICAgICAqCiAgICAgKiBAcGFyYW0geyhEYXRlfG51bWJlcnxzdHJpbmcpfSBkYXRlIERhdGUgdG8gZm9ybWF0IGVpdGhlciBhcyBEYXRlIG9iamVjdCwgbWlsbGlzZWNvbmRzIChzdHJpbmcgb3IKICAgICAqICAgIG51bWJlcikgb3IgdmFyaW91cyBJU08gODYwMSBkYXRldGltZSBzdHJpbmcgZm9ybWF0cyAoZS5nLiB5eXl5LU1NLWRkVEhIOm1tOnNzLlNTU1ogYW5kIGl0cwogICAgICogICAgc2hvcnRlciB2ZXJzaW9ucyBsaWtlIHl5eXktTU0tZGRUSEg6bW1aLCB5eXl5LU1NLWRkIG9yIHl5eXlNTWRkVEhIbW1zc1opLiBJZiBubyB0aW1lem9uZSBpcwogICAgICogICAgc3BlY2lmaWVkIGluIHRoZSBzdHJpbmcgaW5wdXQsIHRoZSB0aW1lIGlzIGNvbnNpZGVyZWQgdG8gYmUgaW4gdGhlIGxvY2FsIHRpbWV6b25lLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBmb3JtYXQgRm9ybWF0dGluZyBydWxlcyAoc2VlIERlc2NyaXB0aW9uKS4gSWYgbm90IHNwZWNpZmllZCwKICAgICAqICAgIGBtZWRpdW1EYXRlYCBpcyB1c2VkLgogICAgICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIHN0cmluZyBvciB0aGUgaW5wdXQgaWYgaW5wdXQgaXMgbm90IHJlY29nbml6ZWQgYXMgZGF0ZS9taWxsaXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSd9fTwvc3Bhbj46CiAgICAgICAgICAgICAgIHt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSd9fTxicj4KICAgICAgICAgICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJ319PC9zcGFuPjoKICAgICAgICAgICAgICB7ezEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonfX08YnI+CiAgICAgICAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSd9fTwvc3Bhbj46CiAgICAgICAgICAgICAge3snMTI4ODMyMzYyMzAwNicgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnfX08YnI+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSciKSkuCiAgICAgICAgICAgICAgICB0b01hdGNoKC9PY3QgMlxkLCAyMDEwIFxkezEsMn06XGR7Mn06XGR7Mn0gKEFNfFBNKS8pOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoIjEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonIikpLgogICAgICAgICAgICAgICAgdG9NYXRjaCgvMjAxMFwtMTBcLTJcZCBcZHsyfTpcZHsyfTpcZHsyfSAoXC18XCspP1xkezR9Lyk7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygiJzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJyIpKS4KICAgICAgICAgICAgICAgIHRvTWF0Y2goLzEwXC8yXGRcLzIwMTAgQCBcZHsxLDJ9OlxkezJ9KEFNfFBNKS8pOwogICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIGRhdGVGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogICAgZnVuY3Rpb24gZGF0ZUZpbHRlcigkbG9jYWxlKSB7CgoKICAgICAgICB2YXIgUl9JU084NjAxX1NUUiA9IC9eKFxkezR9KS0/KFxkXGQpLT8oXGRcZCkoPzpUKFxkXGQpKD86Oj8oXGRcZCkoPzo6PyhcZFxkKSg/OlwuKFxkKykpPyk/KT8oWnwoWystXSkoXGRcZCk6PyhcZFxkKSk/KT8kLzsKICAgICAgICAvLyAxICAgICAgICAyICAgICAgIDMgICAgICAgICA0ICAgICAgICAgIDUgICAgICAgICAgNiAgICAgICAgICA3ICAgICAgICAgIDggIDkgICAgIDEwICAgICAgMTEKICAgICAgICBmdW5jdGlvbiBqc29uU3RyaW5nVG9EYXRlKHN0cmluZykgewogICAgICAgICAgICB2YXIgbWF0Y2g7CiAgICAgICAgICAgIGlmIChtYXRjaCA9IHN0cmluZy5tYXRjaChSX0lTTzg2MDFfU1RSKSkgewogICAgICAgICAgICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgwKSwKICAgICAgICAgICAgICAgICAgICB0ekhvdXIgPSAwLAogICAgICAgICAgICAgICAgICAgIHR6TWluID0gMCwKICAgICAgICAgICAgICAgICAgICBkYXRlU2V0dGVyID0gbWF0Y2hbOF0gPyBkYXRlLnNldFVUQ0Z1bGxZZWFyIDogZGF0ZS5zZXRGdWxsWWVhciwKICAgICAgICAgICAgICAgICAgICB0aW1lU2V0dGVyID0gbWF0Y2hbOF0gPyBkYXRlLnNldFVUQ0hvdXJzIDogZGF0ZS5zZXRIb3VyczsKCiAgICAgICAgICAgICAgICBpZiAobWF0Y2hbOV0pIHsKICAgICAgICAgICAgICAgICAgICB0ekhvdXIgPSBpbnQobWF0Y2hbOV0gKyBtYXRjaFsxMF0pOwogICAgICAgICAgICAgICAgICAgIHR6TWluID0gaW50KG1hdGNoWzldICsgbWF0Y2hbMTFdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRhdGVTZXR0ZXIuY2FsbChkYXRlLCBpbnQobWF0Y2hbMV0pLCBpbnQobWF0Y2hbMl0pIC0gMSwgaW50KG1hdGNoWzNdKSk7CiAgICAgICAgICAgICAgICB2YXIgaCA9IGludChtYXRjaFs0XSB8fCAwKSAtIHR6SG91cjsKICAgICAgICAgICAgICAgIHZhciBtID0gaW50KG1hdGNoWzVdIHx8IDApIC0gdHpNaW4KICAgICAgICAgICAgICAgIHZhciBzID0gaW50KG1hdGNoWzZdIHx8IDApOwogICAgICAgICAgICAgICAgdmFyIG1zID0gTWF0aC5yb3VuZChwYXJzZUZsb2F0KCcwLicgKyAobWF0Y2hbN10gfHwgMCkpICogMTAwMCk7CiAgICAgICAgICAgICAgICB0aW1lU2V0dGVyLmNhbGwoZGF0ZSwgaCwgbSwgcywgbXMpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9CgoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGUsIGZvcm1hdCkgewogICAgICAgICAgICB2YXIgdGV4dCA9ICcnLAogICAgICAgICAgICAgICAgcGFydHMgPSBbXSwKICAgICAgICAgICAgICAgIGZuLCBtYXRjaDsKCiAgICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdCB8fCAnbWVkaXVtRGF0ZSc7CiAgICAgICAgICAgIGZvcm1hdCA9ICRsb2NhbGUuREFURVRJTUVfRk9STUFUU1tmb3JtYXRdIHx8IGZvcm1hdDsKICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGRhdGUpKSB7CiAgICAgICAgICAgICAgICBpZiAoTlVNQkVSX1NUUklORy50ZXN0KGRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IGludChkYXRlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IGpzb25TdHJpbmdUb0RhdGUoZGF0ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc051bWJlcihkYXRlKSkgewogICAgICAgICAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKGRhdGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWlzRGF0ZShkYXRlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaWxlIChmb3JtYXQpIHsKICAgICAgICAgICAgICAgIG1hdGNoID0gREFURV9GT1JNQVRTX1NQTElULmV4ZWMoZm9ybWF0KTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gY29uY2F0KHBhcnRzLCBtYXRjaCwgMSk7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gcGFydHMucG9wKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcnRzLnB1c2goZm9ybWF0KTsKICAgICAgICAgICAgICAgICAgICBmb3JtYXQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3JFYWNoKHBhcnRzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGZuID0gREFURV9GT1JNQVRTW3ZhbHVlXTsKICAgICAgICAgICAgICAgIHRleHQgKz0gZm4gPyBmbihkYXRlLCAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdmFsdWUucmVwbGFjZSgvKF4nfCckKS9nLCAnJykucmVwbGFjZSgvJycvZywgIiciKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpqc29uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqICAgQWxsb3dzIHlvdSB0byBjb252ZXJ0IGEgSmF2YVNjcmlwdCBvYmplY3QgaW50byBKU09OIHN0cmluZy4KICAgICAqCiAgICAgKiAgIFRoaXMgZmlsdGVyIGlzIG1vc3RseSB1c2VmdWwgZm9yIGRlYnVnZ2luZy4gV2hlbiB1c2luZyB0aGUgZG91YmxlIGN1cmx5IHt7dmFsdWV9fSBub3RhdGlvbgogICAgICogICB0aGUgYmluZGluZyBpcyBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBKU09OLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IEFueSBKYXZhU2NyaXB0IG9iamVjdCAoaW5jbHVkaW5nIGFycmF5cyBhbmQgcHJpbWl0aXZlIHR5cGVzKSB0byBmaWx0ZXIuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBKU09OIHN0cmluZy4KICAgICAqCiAgICAgKgogICAgICogQGV4YW1wbGU6CiAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgIDxwcmU+e3sgeyduYW1lJzondmFsdWUnfSB8IGpzb24gfX08L3ByZT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgIGl0KCdzaG91bGQganNvbmlmeSBmaWx0ZXJlZCBvYmplY3RzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygieyduYW1lJzondmFsdWUnfSIpKS50b01hdGNoKC9ce1xuICAibmFtZSI6ID8idmFsdWUiXG59Lyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uIGpzb25GaWx0ZXIoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRvSnNvbihvYmplY3QsIHRydWUpOwogICAgICAgIH07CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmxvd2VyY2FzZQogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENvbnZlcnRzIHN0cmluZyB0byBsb3dlcmNhc2UuCiAgICAgKiBAc2VlIGFuZ3VsYXIubG93ZXJjYXNlCiAgICAgKi8KICAgIHZhciBsb3dlcmNhc2VGaWx0ZXIgPSB2YWx1ZUZuKGxvd2VyY2FzZSk7CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOnVwcGVyY2FzZQogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENvbnZlcnRzIHN0cmluZyB0byB1cHBlcmNhc2UuCiAgICAgKiBAc2VlIGFuZ3VsYXIudXBwZXJjYXNlCiAgICAgKi8KICAgIHZhciB1cHBlcmNhc2VGaWx0ZXIgPSB2YWx1ZUZuKHVwcGVyY2FzZSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLmZpbHRlcjpsaW1pdFRvCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBuZXcgYXJyYXkgb3Igc3RyaW5nIGNvbnRhaW5pbmcgb25seSBhIHNwZWNpZmllZCBudW1iZXIgb2YgZWxlbWVudHMuIFRoZSBlbGVtZW50cwogICAgICogYXJlIHRha2VuIGZyb20gZWl0aGVyIHRoZSBiZWdpbm5pbmcgb3IgdGhlIGVuZCBvZiB0aGUgc291cmNlIGFycmF5IG9yIHN0cmluZywgYXMgc3BlY2lmaWVkIGJ5CiAgICAgKiB0aGUgdmFsdWUgYW5kIHNpZ24gKHBvc2l0aXZlIG9yIG5lZ2F0aXZlKSBvZiBgbGltaXRgLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICAgKiB7QGxpbmsgbmcuJGZpbHRlcn0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheXxzdHJpbmd9IGlucHV0IFNvdXJjZSBhcnJheSBvciBzdHJpbmcgdG8gYmUgbGltaXRlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gbGltaXQgVGhlIGxlbmd0aCBvZiB0aGUgcmV0dXJuZWQgYXJyYXkgb3Igc3RyaW5nLiBJZiB0aGUgYGxpbWl0YCBudW1iZXIgCiAgICAgKiAgICAgaXMgcG9zaXRpdmUsIGBsaW1pdGAgbnVtYmVyIG9mIGl0ZW1zIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgc291cmNlIGFycmF5L3N0cmluZyBhcmUgY29waWVkLgogICAgICogICAgIElmIHRoZSBudW1iZXIgaXMgbmVnYXRpdmUsIGBsaW1pdGAgbnVtYmVyICBvZiBpdGVtcyBmcm9tIHRoZSBlbmQgb2YgdGhlIHNvdXJjZSBhcnJheS9zdHJpbmcgCiAgICAgKiAgICAgYXJlIGNvcGllZC4gVGhlIGBsaW1pdGAgd2lsbCBiZSB0cmltbWVkIGlmIGl0IGV4Y2VlZHMgYGFycmF5Lmxlbmd0aGAKICAgICAqIEByZXR1cm5zIHtBcnJheXxzdHJpbmd9IEEgbmV3IHN1Yi1hcnJheSBvciBzdWJzdHJpbmcgb2YgbGVuZ3RoIGBsaW1pdGAgb3IgbGVzcyBpZiBpbnB1dCBhcnJheQogICAgICogICAgIGhhZCBsZXNzIHRoYW4gYGxpbWl0YCBlbGVtZW50cy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLm51bWJlcnMgPSBbMSwyLDMsNCw1LDYsNyw4LDldOwogICAgICAgICAgICAgICAkc2NvcGUubGV0dGVycyA9ICJhYmNkZWZnaGkiOwogICAgICAgICAgICAgICAkc2NvcGUubnVtTGltaXQgPSAzOwogICAgICAgICAgICAgICAkc2NvcGUubGV0dGVyTGltaXQgPSAzOwogICAgICAgICAgICAgfQogICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgICBMaW1pdCB7e251bWJlcnN9fSB0bzogPGlucHV0IHR5cGU9ImludGVnZXIiIG5nLW1vZGVsPSJudW1MaW1pdCI+CiAgICAgICAgICAgICA8cD5PdXRwdXQgbnVtYmVyczoge3sgbnVtYmVycyB8IGxpbWl0VG86bnVtTGltaXQgfX08L3A+CiAgICAgICAgICAgICBMaW1pdCB7e2xldHRlcnN9fSB0bzogPGlucHV0IHR5cGU9ImludGVnZXIiIG5nLW1vZGVsPSJsZXR0ZXJMaW1pdCI+CiAgICAgICAgICAgICA8cD5PdXRwdXQgbGV0dGVyczoge3sgbGV0dGVycyB8IGxpbWl0VG86bGV0dGVyTGltaXQgfX08L3A+CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIGxpbWl0IHRoZSBudW1iZXIgYXJyYXkgdG8gZmlyc3QgdGhyZWUgaXRlbXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBpbnB1dFtuZy1tb2RlbD1udW1MaW1pdF0nKS52YWwoKSkudG9CZSgnMycpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGlucHV0W25nLW1vZGVsPWxldHRlckxpbWl0XScpLnZhbCgpKS50b0JlKCczJyk7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bnVtTGltaXQnKSkudG9FcXVhbCgnWzEsMiwzXScpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xldHRlcnMgfCBsaW1pdFRvOmxldHRlckxpbWl0JykpLnRvRXF1YWwoJ2FiYycpOwogICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgdGhlIG91dHB1dCB3aGVuIC0zIGlzIGVudGVyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGlucHV0KCdudW1MaW1pdCcpLmVudGVyKC0zKTsKICAgICAgICAgICAgIGlucHV0KCdsZXR0ZXJMaW1pdCcpLmVudGVyKC0zKTsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpudW1MaW1pdCcpKS50b0VxdWFsKCdbNyw4LDldJyk7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbGV0dGVycyB8IGxpbWl0VG86bGV0dGVyTGltaXQnKSkudG9FcXVhbCgnZ2hpJyk7CiAgICAgICAgICAgfSk7CiAgICAKICAgICAgICAgICBpdCgnc2hvdWxkIG5vdCBleGNlZWQgdGhlIG1heGltdW0gc2l6ZSBvZiBpbnB1dCBhcnJheScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgaW5wdXQoJ251bUxpbWl0JykuZW50ZXIoMTAwKTsKICAgICAgICAgICAgIGlucHV0KCdsZXR0ZXJMaW1pdCcpLmVudGVyKDEwMCk7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bnVtTGltaXQnKSkudG9FcXVhbCgnWzEsMiwzLDQsNSw2LDcsOCw5XScpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xldHRlcnMgfCBsaW1pdFRvOmxldHRlckxpbWl0JykpLnRvRXF1YWwoJ2FiY2RlZmdoaScpOwogICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIGZ1bmN0aW9uIGxpbWl0VG9GaWx0ZXIoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChpbnB1dCwgbGltaXQpIHsKICAgICAgICAgICAgaWYgKCFpc0FycmF5KGlucHV0KSAmJiAhaXNTdHJpbmcoaW5wdXQpKSByZXR1cm4gaW5wdXQ7CgogICAgICAgICAgICBsaW1pdCA9IGludChsaW1pdCk7CgogICAgICAgICAgICBpZiAoaXNTdHJpbmcoaW5wdXQpKSB7CiAgICAgICAgICAgICAgICAvL05hTiBjaGVjayBvbiBsaW1pdAogICAgICAgICAgICAgICAgaWYgKGxpbWl0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxpbWl0ID49IDAgPyBpbnB1dC5zbGljZSgwLCBsaW1pdCkgOiBpbnB1dC5zbGljZShsaW1pdCwgaW5wdXQubGVuZ3RoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgb3V0ID0gW10sCiAgICAgICAgICAgICAgaSwgbjsKCiAgICAgICAgICAgIC8vIGlmIGFicyhsaW1pdCkgZXhjZWVkcyBtYXhpbXVtIGxlbmd0aCwgdHJpbSBpdAogICAgICAgICAgICBpZiAobGltaXQgPiBpbnB1dC5sZW5ndGgpCiAgICAgICAgICAgICAgICBsaW1pdCA9IGlucHV0Lmxlbmd0aDsKICAgICAgICAgICAgZWxzZSBpZiAobGltaXQgPCAtaW5wdXQubGVuZ3RoKQogICAgICAgICAgICAgICAgbGltaXQgPSAtaW5wdXQubGVuZ3RoOwoKICAgICAgICAgICAgaWYgKGxpbWl0ID4gMCkgewogICAgICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgICAgICAgICBuID0gbGltaXQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpID0gaW5wdXQubGVuZ3RoICsgbGltaXQ7CiAgICAgICAgICAgICAgICBuID0gaW5wdXQubGVuZ3RoOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKDsgaSA8IG47IGkrKykgewogICAgICAgICAgICAgICAgb3V0LnB1c2goaW5wdXRbaV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gb3V0OwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuZmlsdGVyOm9yZGVyQnkKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogT3JkZXJzIGEgc3BlY2lmaWVkIGBhcnJheWAgYnkgdGhlIGBleHByZXNzaW9uYCBwcmVkaWNhdGUuCiAgICAgKgogICAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBuZy4kZmlsdGVyfSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc29ydC4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKil8c3RyaW5nfEFycmF5LjwoZnVuY3Rpb24oKil8c3RyaW5nKT59IGV4cHJlc3Npb24gQSBwcmVkaWNhdGUgdG8gYmUKICAgICAqICAgIHVzZWQgYnkgdGhlIGNvbXBhcmF0b3IgdG8gZGV0ZXJtaW5lIHRoZSBvcmRlciBvZiBlbGVtZW50cy4KICAgICAqCiAgICAgKiAgICBDYW4gYmUgb25lIG9mOgogICAgICoKICAgICAqICAgIC0gYGZ1bmN0aW9uYDogR2V0dGVyIGZ1bmN0aW9uLiBUaGUgcmVzdWx0IG9mIHRoaXMgZnVuY3Rpb24gd2lsbCBiZSBzb3J0ZWQgdXNpbmcgdGhlCiAgICAgKiAgICAgIGA8YCwgYD1gLCBgPmAgb3BlcmF0b3IuCiAgICAgKiAgICAtIGBzdHJpbmdgOiBBbiBBbmd1bGFyIGV4cHJlc3Npb24gd2hpY2ggZXZhbHVhdGVzIHRvIGFuIG9iamVjdCB0byBvcmRlciBieSwgc3VjaCBhcyAnbmFtZScKICAgICAqICAgICAgdG8gc29ydCBieSBhIHByb3BlcnR5IGNhbGxlZCAnbmFtZScuIE9wdGlvbmFsbHkgcHJlZml4ZWQgd2l0aCBgK2Agb3IgYC1gIHRvIGNvbnRyb2wKICAgICAqICAgICAgYXNjZW5kaW5nIG9yIGRlc2NlbmRpbmcgc29ydCBvcmRlciAoZm9yIGV4YW1wbGUsICtuYW1lIG9yIC1uYW1lKS4KICAgICAqICAgIC0gYEFycmF5YDogQW4gYXJyYXkgb2YgZnVuY3Rpb24gb3Igc3RyaW5nIHByZWRpY2F0ZXMuIFRoZSBmaXJzdCBwcmVkaWNhdGUgaW4gdGhlIGFycmF5CiAgICAgKiAgICAgIGlzIHVzZWQgZm9yIHNvcnRpbmcsIGJ1dCB3aGVuIHR3byBpdGVtcyBhcmUgZXF1aXZhbGVudCwgdGhlIG5leHQgcHJlZGljYXRlIGlzIHVzZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtib29sZWFuPX0gcmV2ZXJzZSBSZXZlcnNlIHRoZSBvcmRlciB0aGUgYXJyYXkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFNvcnRlZCBjb3B5IG9mIHRoZSBzb3VyY2UgYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAgICRzY29wZS5mcmllbmRzID0KICAgICAgICAgICAgICAgICAgIFt7bmFtZTonSm9obicsIHBob25lOic1NTUtMTIxMicsIGFnZToxMH0sCiAgICAgICAgICAgICAgICAgICAge25hbWU6J01hcnknLCBwaG9uZTonNTU1LTk4NzYnLCBhZ2U6MTl9LAogICAgICAgICAgICAgICAgICAgIHtuYW1lOidNaWtlJywgcGhvbmU6JzU1NS00MzIxJywgYWdlOjIxfSwKICAgICAgICAgICAgICAgICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCcsIGFnZTozNX0sCiAgICAgICAgICAgICAgICAgICAge25hbWU6J0p1bGllJywgcGhvbmU6JzU1NS04NzY1JywgYWdlOjI5fV0KICAgICAgICAgICAgICAgJHNjb3BlLnByZWRpY2F0ZSA9ICctYWdlJzsKICAgICAgICAgICAgIH0KICAgICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgICAgPHByZT5Tb3J0aW5nIHByZWRpY2F0ZSA9IHt7cHJlZGljYXRlfX07IHJldmVyc2UgPSB7e3JldmVyc2V9fTwvcHJlPgogICAgICAgICAgICAgPGhyLz4KICAgICAgICAgICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlPScnIj51bnNvcnRlZDwvYT4gXQogICAgICAgICAgICAgPHRhYmxlIGNsYXNzPSJmcmllbmQiPgogICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICduYW1lJzsgcmV2ZXJzZT1mYWxzZSI+TmFtZTwvYT4KICAgICAgICAgICAgICAgICAgICAgKDxhIGhyZWYgbmctY2xpY2s9InByZWRpY2F0ZSA9ICctbmFtZSc7IHJldmVyc2U9ZmFsc2UiPl48L2E+KTwvdGg+CiAgICAgICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICdwaG9uZSc7IHJldmVyc2U9IXJldmVyc2UiPlBob25lIE51bWJlcjwvYT48L3RoPgogICAgICAgICAgICAgICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnYWdlJzsgcmV2ZXJzZT0hcmV2ZXJzZSI+QWdlPC9hPjwvdGg+CiAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgIDx0ciBuZy1yZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIHwgb3JkZXJCeTpwcmVkaWNhdGU6cmV2ZXJzZSI+CiAgICAgICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLnBob25lfX08L3RkPgogICAgICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5hZ2V9fTwvdGQ+CiAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgIDwvZGl2PgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBiZSByZXZlcnNlIG9yZGVyZWQgYnkgYWdlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ByZWRpY2F0ZScpKS50b0JlKCctYWdlJyk7CiAgICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLmFnZScpKS4KICAgICAgICAgICAgICAgdG9FcXVhbChbJzM1JywgJzI5JywgJzIxJywgJzE5JywgJzEwJ10pOwogICAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgICAgICB0b0VxdWFsKFsnQWRhbScsICdKdWxpZScsICdNaWtlJywgJ01hcnknLCAnSm9obiddKTsKICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgIGl0KCdzaG91bGQgcmVvcmRlciB0aGUgdGFibGUgd2hlbiB1c2VyIHNlbGVjdHMgZGlmZmVyZW50IHByZWRpY2F0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgYTpjb250YWlucygiTmFtZSIpJykuY2xpY2soKTsKICAgICAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICAgICAgdG9FcXVhbChbJ0FkYW0nLCAnSm9obicsICdKdWxpZScsICdNYXJ5JywgJ01pa2UnXSk7CiAgICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLmFnZScpKS4KICAgICAgICAgICAgICAgdG9FcXVhbChbJzM1JywgJzEwJywgJzI5JywgJzE5JywgJzIxJ10pOwogICAgCiAgICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJQaG9uZSIpJykuY2xpY2soKTsKICAgICAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQucGhvbmUnKSkuCiAgICAgICAgICAgICAgIHRvRXF1YWwoWyc1NTUtOTg3NicsICc1NTUtODc2NScsICc1NTUtNTY3OCcsICc1NTUtNDMyMScsICc1NTUtMTIxMiddKTsKICAgICAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICAgICAgdG9FcXVhbChbJ01hcnknLCAnSnVsaWUnLCAnQWRhbScsICdNaWtlJywgJ0pvaG4nXSk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgb3JkZXJCeUZpbHRlci4kaW5qZWN0ID0gWyckcGFyc2UnXTsKICAgIGZ1bmN0aW9uIG9yZGVyQnlGaWx0ZXIoJHBhcnNlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhcnJheSwgc29ydFByZWRpY2F0ZSwgcmV2ZXJzZU9yZGVyKSB7CiAgICAgICAgICAgIGlmICghaXNBcnJheShhcnJheSkpIHJldHVybiBhcnJheTsKICAgICAgICAgICAgaWYgKCFzb3J0UHJlZGljYXRlKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIHNvcnRQcmVkaWNhdGUgPSBpc0FycmF5KHNvcnRQcmVkaWNhdGUpID8gc29ydFByZWRpY2F0ZSA6IFtzb3J0UHJlZGljYXRlXTsKICAgICAgICAgICAgc29ydFByZWRpY2F0ZSA9IG1hcChzb3J0UHJlZGljYXRlLCBmdW5jdGlvbiAocHJlZGljYXRlKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVzY2VuZGluZyA9IGZhbHNlLCBnZXQgPSBwcmVkaWNhdGUgfHwgaWRlbnRpdHk7CiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcocHJlZGljYXRlKSkgewogICAgICAgICAgICAgICAgICAgIGlmICgocHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnKycgfHwgcHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnLScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NlbmRpbmcgPSBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJzsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlID0gcHJlZGljYXRlLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZ2V0ID0gJHBhcnNlKHByZWRpY2F0ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmV2ZXJzZUNvbXBhcmF0b3IoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29tcGFyZShnZXQoYSksIGdldChiKSk7CiAgICAgICAgICAgICAgICB9LCBkZXNjZW5kaW5nKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBhcnJheUNvcHkgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgeyBhcnJheUNvcHkucHVzaChhcnJheVtpXSk7IH0KICAgICAgICAgICAgcmV0dXJuIGFycmF5Q29weS5zb3J0KHJldmVyc2VDb21wYXJhdG9yKGNvbXBhcmF0b3IsIHJldmVyc2VPcmRlcikpOwoKICAgICAgICAgICAgZnVuY3Rpb24gY29tcGFyYXRvcihvMSwgbzIpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydFByZWRpY2F0ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBjb21wID0gc29ydFByZWRpY2F0ZVtpXShvMSwgbzIpOwogICAgICAgICAgICAgICAgICAgIGlmIChjb21wICE9PSAwKSByZXR1cm4gY29tcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVyc2VDb21wYXJhdG9yKGNvbXAsIGRlc2NlbmRpbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0b0Jvb2xlYW4oZGVzY2VuZGluZykKICAgICAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uIChhLCBiKSB7IHJldHVybiBjb21wKGIsIGEpOyB9CiAgICAgICAgICAgICAgICAgICAgOiBjb21wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBhcmUodjEsIHYyKSB7CiAgICAgICAgICAgICAgICB2YXIgdDEgPSB0eXBlb2YgdjE7CiAgICAgICAgICAgICAgICB2YXIgdDIgPSB0eXBlb2YgdjI7CiAgICAgICAgICAgICAgICBpZiAodDEgPT0gdDIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodDEgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdjEgPSB2MS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB2MiA9IHYyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh2MSA9PT0gdjIpIHJldHVybiAwOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2MSA8IHYyID8gLTEgOiAxOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdDEgPCB0MiA/IC0xIDogMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBuZ0RpcmVjdGl2ZShkaXJlY3RpdmUpIHsKICAgICAgICBpZiAoaXNGdW5jdGlvbihkaXJlY3RpdmUpKSB7CiAgICAgICAgICAgIGRpcmVjdGl2ZSA9IHsKICAgICAgICAgICAgICAgIGxpbms6IGRpcmVjdGl2ZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQUMnOwogICAgICAgIHJldHVybiB2YWx1ZUZuKGRpcmVjdGl2ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6YQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIE1vZGlmaWVzIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIGh0bWwgQSB0YWcsIHNvIHRoYXQgdGhlIGRlZmF1bHQgYWN0aW9uIGlzIHByZXZlbnRlZCB3aGVuIGhyZWYKICAgICAqIGF0dHJpYnV0ZSBpcyBlbXB0eS4KICAgICAqCiAgICAgKiBUaGUgcmVhc29uaW5nIGZvciB0aGlzIGNoYW5nZSBpcyB0byBhbGxvdyBlYXN5IGNyZWF0aW9uIG9mIGFjdGlvbiBsaW5rcyB3aXRoIGBuZ0NsaWNrYCBkaXJlY3RpdmUKICAgICAqIHdpdGhvdXQgY2hhbmdpbmcgdGhlIGxvY2F0aW9uIG9yIGNhdXNpbmcgcGFnZSByZWxvYWRzLCBlLmcuOgogICAgICogYDxhIGhyZWY9IiIgbmctY2xpY2s9Im1vZGVsLiRzYXZlKCkiPlNhdmU8L2E+YAogICAgICovCiAgICB2YXIgaHRtbEFuY2hvckRpcmVjdGl2ZSA9IHZhbHVlRm4oewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIpIHsKCiAgICAgICAgICAgIGlmIChtc2llIDw9IDgpIHsKCiAgICAgICAgICAgICAgICAvLyB0dXJuIDxhIGhyZWYgbmctY2xpY2s9Ii4uIj5saW5rPC9hPiBpbnRvIGEgc3R5bGFibGUgbGluayBpbiBJRQogICAgICAgICAgICAgICAgLy8gYnV0IG9ubHkgaWYgaXQgZG9lc24ndCBoYXZlIG5hbWUgYXR0cmlidXRlLCBpbiB3aGljaCBjYXNlIGl0J3MgYW4gYW5jaG9yCiAgICAgICAgICAgICAgICBpZiAoIWF0dHIuaHJlZiAmJiAhYXR0ci5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCdocmVmJywgJycpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGFkZCBhIGNvbW1lbnQgbm9kZSB0byBhbmNob3JzIHRvIHdvcmthcm91bmQgSUUgYnVnIHRoYXQgY2F1c2VzIGVsZW1lbnQgY29udGVudCB0byBiZSByZXNldAogICAgICAgICAgICAgICAgLy8gdG8gbmV3IGF0dHJpYnV0ZSBjb250ZW50IGlmIGF0dHJpYnV0ZSBpcyB1cGRhdGVkIHdpdGggdmFsdWUgY29udGFpbmluZyBAIGFuZCBlbGVtZW50IGFsc28KICAgICAgICAgICAgICAgIC8vIGNvbnRhaW5zIHZhbHVlIHdpdGggQAogICAgICAgICAgICAgICAgLy8gc2VlIGlzc3VlICMxOTQ5CiAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZChkb2N1bWVudC5jcmVhdGVDb21tZW50KCdJRSBmaXgnKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgd2UgaGF2ZSBubyBocmVmIHVybCwgdGhlbiBkb24ndCBuYXZpZ2F0ZSBhbnl3aGVyZS4KICAgICAgICAgICAgICAgICAgICBpZiAoIWVsZW1lbnQuYXR0cignaHJlZicpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0hyZWYKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2luZyBBbmd1bGFyIG1hcmt1cCBsaWtlIHt7aGFzaH19IGluIGFuIGhyZWYgYXR0cmlidXRlIG1ha2VzCiAgICAgKiB0aGUgcGFnZSBvcGVuIHRvIGEgd3JvbmcgVVJMLCBpZiB0aGUgdXNlciBjbGlja3MgdGhhdCBsaW5rIGJlZm9yZQogICAgICogYW5ndWxhciBoYXMgYSBjaGFuY2UgdG8gcmVwbGFjZSB0aGUge3toYXNofX0gd2l0aCBhY3R1YWwgVVJMLCB0aGUKICAgICAqIGxpbmsgd2lsbCBiZSBicm9rZW4gYW5kIHdpbGwgbW9zdCBsaWtlbHkgcmV0dXJuIGEgNDA0IGVycm9yLgogICAgICogVGhlIGBuZ0hyZWZgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogICAgICoKICAgICAqIFRoZSBidWdneSB3YXkgdG8gd3JpdGUgaXQ6CiAgICAgKiA8cHJlPgogICAgICogPGEgaHJlZj0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBUaGUgY29ycmVjdCB3YXkgdG8gd3JpdGUgaXQ6CiAgICAgKiA8cHJlPgogICAgICogPGEgbmctaHJlZj0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBCiAgICAgKiBAcGFyYW0ge3RlbXBsYXRlfSBuZ0hyZWYgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBUaGlzIGV4YW1wbGUgdXNlcyBgbGlua2AgdmFyaWFibGUgaW5zaWRlIGBocmVmYCBhdHRyaWJ1dGU6CiAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgIDxpbnB1dCBuZy1tb2RlbD0idmFsdWUiIC8+PGJyIC8+CiAgICAgICAgICAgIDxhIGlkPSJsaW5rLTEiIGhyZWYgbmctY2xpY2s9InZhbHVlID0gMSI+bGluayAxPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgICAgICAgICA8YSBpZD0ibGluay0yIiBocmVmPSIiIG5nLWNsaWNrPSJ2YWx1ZSA9IDIiPmxpbmsgMjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICAgICAgPGEgaWQ9ImxpbmstMyIgbmctaHJlZj0iL3t7JzEyMyd9fSI+bGluayAzPC9hPiAobGluaywgcmVsb2FkISk8YnIgLz4KICAgICAgICAgICAgPGEgaWQ9ImxpbmstNCIgaHJlZj0iIiBuYW1lPSJ4eCIgbmctY2xpY2s9InZhbHVlID0gNCI+YW5jaG9yPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgICAgICAgICA8YSBpZD0ibGluay01IiBuYW1lPSJ4eHgiIG5nLWNsaWNrPSJ2YWx1ZSA9IDUiPmFuY2hvcjwvYT4gKG5vIGxpbmspPGJyIC8+CiAgICAgICAgICAgIDxhIGlkPSJsaW5rLTYiIG5nLWhyZWY9Int7dmFsdWV9fSI+bGluazwvYT4gKGxpbmssIGNoYW5nZSBsb2NhdGlvbikKICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIGhyZWYgd2l0aG91dCB2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTEnKS5jbGljaygpOwogICAgICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnMScpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0xJykuYXR0cignaHJlZicpKS50b0JlKCIiKTsKICAgICAgICAgICAgfSk7CiAgICAKICAgICAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiBlbXB0eSBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBlbGVtZW50KCcjbGluay0yJykuY2xpY2soKTsKICAgICAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzInKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstMicpLmF0dHIoJ2hyZWYnKSkudG9CZSgiIik7CiAgICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBhbmQgY2hhbmdlIHVybCB3aGVuIG5nLWhyZWYgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTMnKS5hdHRyKCdocmVmJykpLnRvQmUoIi8xMjMiKTsKICAgIAogICAgICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTMnKS5jbGljaygpOwogICAgICAgICAgICAgIGV4cGVjdChicm93c2VyKCkud2luZG93KCkucGF0aCgpKS50b0VxdWFsKCcvMTIzJyk7CiAgICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIGhyZWYgZW1wdHkgc3RyaW5nIGFuZCBuYW1lIHNwZWNpZmllZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTQnKS5jbGljaygpOwogICAgICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnNCcpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay00JykuYXR0cignaHJlZicpKS50b0JlKCcnKTsKICAgICAgICAgICAgfSk7CiAgICAKICAgICAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gbm8gaHJlZiBidXQgbmFtZSBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBlbGVtZW50KCcjbGluay01JykuY2xpY2soKTsKICAgICAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzUnKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNScpLmF0dHIoJ2hyZWYnKSkudG9CZSh1bmRlZmluZWQpOwogICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgICBpdCgnc2hvdWxkIG9ubHkgY2hhbmdlIHVybCB3aGVuIG9ubHkgbmctaHJlZicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCc2Jyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTYnKS5hdHRyKCdocmVmJykpLnRvQmUoJzYnKTsKICAgIAogICAgICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTYnKS5jbGljaygpOwogICAgICAgICAgICAgIGV4cGVjdChicm93c2VyKCkubG9jYXRpb24oKS51cmwoKSkudG9FcXVhbCgnLzYnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTcmMKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2luZyBBbmd1bGFyIG1hcmt1cCBsaWtlIGB7e2hhc2h9fWAgaW4gYSBgc3JjYCBhdHRyaWJ1dGUgZG9lc24ndAogICAgICogd29yayByaWdodDogVGhlIGJyb3dzZXIgd2lsbCBmZXRjaCBmcm9tIHRoZSBVUkwgd2l0aCB0aGUgbGl0ZXJhbAogICAgICogdGV4dCBge3toYXNofX1gIHVudGlsIEFuZ3VsYXIgcmVwbGFjZXMgdGhlIGV4cHJlc3Npb24gaW5zaWRlCiAgICAgKiBge3toYXNofX1gLiBUaGUgYG5nU3JjYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbS4KICAgICAqCiAgICAgKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxpbWcgc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoZSBjb3JyZWN0IHdheSB0byB3cml0ZSBpdDoKICAgICAqIDxwcmU+CiAgICAgKiA8aW1nIG5nLXNyYz0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTUcKICAgICAqIEBwYXJhbSB7dGVtcGxhdGV9IG5nU3JjIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nU3Jjc2V0CiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSBge3toYXNofX1gIGluIGEgYHNyY3NldGAgYXR0cmlidXRlIGRvZXNuJ3QKICAgICAqIHdvcmsgcmlnaHQ6IFRoZSBicm93c2VyIHdpbGwgZmV0Y2ggZnJvbSB0aGUgVVJMIHdpdGggdGhlIGxpdGVyYWwKICAgICAqIHRleHQgYHt7aGFzaH19YCB1bnRpbCBBbmd1bGFyIHJlcGxhY2VzIHRoZSBleHByZXNzaW9uIGluc2lkZQogICAgICogYHt7aGFzaH19YC4gVGhlIGBuZ1NyY3NldGAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0uCiAgICAgKgogICAgICogVGhlIGJ1Z2d5IHdheSB0byB3cml0ZSBpdDoKICAgICAqIDxwcmU+CiAgICAgKiA8aW1nIHNyY3NldD0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19IDJ4Ii8+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBUaGUgY29ycmVjdCB3YXkgdG8gd3JpdGUgaXQ6CiAgICAgKiA8cHJlPgogICAgICogPGltZyBuZy1zcmNzZXQ9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSAyeCIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQGVsZW1lbnQgSU1HCiAgICAgKiBAcGFyYW0ge3RlbXBsYXRlfSBuZ1NyY3NldCBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluIGB7e319YCBtYXJrdXAuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0Rpc2FibGVkCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFRoZSBmb2xsb3dpbmcgbWFya3VwIHdpbGwgbWFrZSB0aGUgYnV0dG9uIGVuYWJsZWQgb24gQ2hyb21lL0ZpcmVmb3ggYnV0IG5vdCBvbiBJRTggYW5kIG9sZGVyIElFczoKICAgICAqIDxwcmU+CiAgICAgKiA8ZGl2IG5nLWluaXQ9InNjb3BlID0geyBpc0Rpc2FibGVkOiBmYWxzZSB9Ij4KICAgICAqICA8YnV0dG9uIGRpc2FibGVkPSJ7e3Njb3BlLmlzRGlzYWJsZWR9fSI+RGlzYWJsZWQ8L2J1dHRvbj4KICAgICAqIDwvZGl2PgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIGRpc2FibGVkLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIHRoZSBgbmdEaXNhYmxlZGAgZGlyZWN0aXZlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgIENsaWNrIG1lIHRvIHRvZ2dsZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICAgICAgICAgPGJ1dHRvbiBuZy1tb2RlbD0iYnV0dG9uIiBuZy1kaXNhYmxlZD0iY2hlY2tlZCI+QnV0dG9uPC9idXR0b24+CiAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICBpdCgnc2hvdWxkIHRvZ2dsZSBidXR0b24nLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLnByb3AoJ2Rpc2FibGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLnByb3AoJ2Rpc2FibGVkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IElOUFVUCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nRGlzYWJsZWQgQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDaGVja2VkCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIGNoZWNrZWQuCiAgICAgKiAoVGhlIHByZXNlbmNlIG9mIHRoZW0gbWVhbnMgdHJ1ZSBhbmQgYWJzZW5jZSBtZWFucyBmYWxzZSkKICAgICAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogICAgICogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2UgdGhlIGBuZ0NoZWNrZWRgIGRpcmVjdGl2ZS4KICAgICAqIEBleGFtcGxlCiAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgIENoZWNrIG1lIHRvIGNoZWNrIGJvdGg6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9Im1hc3RlciI+PGJyLz4KICAgICAgICAgICAgPGlucHV0IGlkPSJjaGVja1NsYXZlIiB0eXBlPSJjaGVja2JveCIgbmctY2hlY2tlZD0ibWFzdGVyIj4KICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgIGl0KCdzaG91bGQgY2hlY2sgYm90aCBjaGVja0JveGVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNjaGVja1NsYXZlJykucHJvcCgnY2hlY2tlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgICAgICBpbnB1dCgnbWFzdGVyJykuY2hlY2soKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2NoZWNrU2xhdmUnKS5wcm9wKCdjaGVja2VkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IElOUFVUCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2hlY2tlZCBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1JlYWRvbmx5CiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIHJlYWRvbmx5LgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIHRoZSBgbmdSZWFkb25seWAgZGlyZWN0aXZlLgogICAgICogQGV4YW1wbGUKICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICAgQ2hlY2sgbWUgdG8gbWFrZSB0ZXh0IHJlYWRvbmx5OiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctcmVhZG9ubHk9ImNoZWNrZWQiIHZhbHVlPSJJJ20gQW5ndWxhciIvPgogICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgcmVhZG9ubHkgYXR0cicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6dGV4dCcpLnByb3AoJ3JlYWRvbmx5JykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOnRleHQnKS5wcm9wKCdyZWFkb25seScpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTZWxlY3RlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBzZWxlY3RlZC4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZWQgdGhlIGBuZ1NlbGVjdGVkYCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICBDaGVjayBtZSB0byBzZWxlY3Q6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InNlbGVjdGVkIj48YnIvPgogICAgICAgICAgICA8c2VsZWN0PgogICAgICAgICAgICAgIDxvcHRpb24+SGVsbG8hPC9vcHRpb24+CiAgICAgICAgICAgICAgPG9wdGlvbiBpZD0iZ3JlZXQiIG5nLXNlbGVjdGVkPSJzZWxlY3RlZCI+R3JlZXRpbmdzITwvb3B0aW9uPgogICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgIGl0KCdzaG91bGQgc2VsZWN0IEdyZWV0aW5ncyEnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2dyZWV0JykucHJvcCgnc2VsZWN0ZWQnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICAgICAgaW5wdXQoJ3NlbGVjdGVkJykuY2hlY2soKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2dyZWV0JykucHJvcCgnc2VsZWN0ZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKgogICAgICogQGVsZW1lbnQgT1BUSU9OCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nT3BlbgogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBvcGVuLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIHRoZSBgbmdPcGVuYCBkaXJlY3RpdmUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICAgQ2hlY2sgbWUgY2hlY2sgbXVsdGlwbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9Im9wZW4iPjxici8+CiAgICAgICAgICAgICA8ZGV0YWlscyBpZD0iZGV0YWlscyIgbmctb3Blbj0ib3BlbiI+CiAgICAgICAgICAgICAgICA8c3VtbWFyeT5TaG93L0hpZGUgbWU8L3N1bW1hcnk+CiAgICAgICAgICAgICA8L2RldGFpbHM+CiAgICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgICBpdCgnc2hvdWxkIHRvZ2dsZSBvcGVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjZGV0YWlscycpLnByb3AoJ29wZW4nKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICAgICAgIGlucHV0KCdvcGVuJykuY2hlY2soKTsKICAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNkZXRhaWxzJykucHJvcCgnb3BlbicpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgICAgICB9KTsKICAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBERVRBSUxTCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKICAgIHZhciBuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcyA9IHt9OwoKCiAgICAvLyBib29sZWFuIGF0dHJzIGFyZSBldmFsdWF0ZWQKICAgIGZvckVhY2goQk9PTEVBTl9BVFRSLCBmdW5jdGlvbiAocHJvcE5hbWUsIGF0dHJOYW1lKSB7CiAgICAgICAgLy8gYmluZGluZyB0byBtdWx0aXBsZSBpcyBub3Qgc3VwcG9ydGVkCiAgICAgICAgaWYgKHByb3BOYW1lID09ICJtdWx0aXBsZSIpIHJldHVybjsKCiAgICAgICAgdmFyIG5vcm1hbGl6ZWQgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBhdHRyTmFtZSk7CiAgICAgICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJbbm9ybWFsaXplZF0sIGZ1bmN0aW9uIG5nQm9vbGVhbkF0dHJXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KGF0dHJOYW1lLCAhIXZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgfSk7CgoKICAgIC8vIG5nLXNyYywgbmctc3Jjc2V0LCBuZy1ocmVmIGFyZSBpbnRlcnBvbGF0ZWQKICAgIGZvckVhY2goWydzcmMnLCAnc3Jjc2V0JywgJ2hyZWYnXSwgZnVuY3Rpb24gKGF0dHJOYW1lKSB7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWQgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBhdHRyTmFtZSk7CiAgICAgICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBwcmlvcml0eTogOTksIC8vIGl0IG5lZWRzIHRvIHJ1biBhZnRlciB0aGUgYXR0cmlidXRlcyBhcmUgaW50ZXJwb2xhdGVkCiAgICAgICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyLiRvYnNlcnZlKG5vcm1hbGl6ZWQsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KGF0dHJOYW1lLCB2YWx1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBvbiBJRSwgaWYgIm5nOnNyYyIgZGlyZWN0aXZlIGRlY2xhcmF0aW9uIGlzIHVzZWQgYW5kICJzcmMiIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZW4gY2FsbGluZyBlbGVtZW50LnNldEF0dHJpYnV0ZSgnc3JjJywgJ2ZvbycpIGRvZXNuJ3QgZG8gYW55dGhpbmcsIHNvIHdlIG5lZWQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG8gc2V0IHRoZSBwcm9wZXJ0eSBhcyB3ZWxsIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgZWZmZWN0LgogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSB1c2UgYXR0clthdHRyTmFtZV0gdmFsdWUgc2luY2UgJHNldCBjYW4gc2FuaXRpemUgdGhlIHVybC4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1zaWUpIGVsZW1lbnQucHJvcChhdHRyTmFtZSwgYXR0clthdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9KTsKCiAgICB2YXIgbnVsbEZvcm1DdHJsID0gewogICAgICAgICRhZGRDb250cm9sOiBub29wLAogICAgICAgICRyZW1vdmVDb250cm9sOiBub29wLAogICAgICAgICRzZXRWYWxpZGl0eTogbm9vcCwKICAgICAgICAkc2V0RGlydHk6IG5vb3AsCiAgICAgICAgJHNldFByaXN0aW5lOiBub29wCiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRwcmlzdGluZSBUcnVlIGlmIHVzZXIgaGFzIG5vdCBpbnRlcmFjdGVkIHdpdGggdGhlIGZvcm0geWV0LgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkZGlydHkgVHJ1ZSBpZiB1c2VyIGhhcyBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aCB0aGUgZm9ybS4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHZhbGlkIFRydWUgaWYgYWxsIG9mIHRoZSBjb250YWluaW5nIGZvcm1zIGFuZCBjb250cm9scyBhcmUgdmFsaWQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRpbnZhbGlkIFRydWUgaWYgYXQgbGVhc3Qgb25lIGNvbnRhaW5pbmcgY29udHJvbCBvciBmb3JtIGlzIGludmFsaWQuCiAgICAgKgogICAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBJcyBhbiBvYmplY3QgaGFzaCwgY29udGFpbmluZyByZWZlcmVuY2VzIHRvIGFsbCBpbnZhbGlkIGNvbnRyb2xzIG9yCiAgICAgKiAgZm9ybXMsIHdoZXJlOgogICAgICoKICAgICAqICAtIGtleXMgYXJlIHZhbGlkYXRpb24gdG9rZW5zIChlcnJvciBuYW1lcykg4oCUIHN1Y2ggYXMgYHJlcXVpcmVkYCwgYHVybGAgb3IgYGVtYWlsYCksCiAgICAgKiAgLSB2YWx1ZXMgYXJlIGFycmF5cyBvZiBjb250cm9scyBvciBmb3JtcyB0aGF0IGFyZSBpbnZhbGlkIHdpdGggZ2l2ZW4gZXJyb3IuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBgRm9ybUNvbnRyb2xsZXJgIGtlZXBzIHRyYWNrIG9mIGFsbCBpdHMgY29udHJvbHMgYW5kIG5lc3RlZCBmb3JtcyBhcyB3ZWxsIGFzIHN0YXRlIG9mIHRoZW0sCiAgICAgKiBzdWNoIGFzIGJlaW5nIHZhbGlkL2ludmFsaWQgb3IgZGlydHkvcHJpc3RpbmUuCiAgICAgKgogICAgICogRWFjaCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0gZGlyZWN0aXZlIGNyZWF0ZXMgYW4gaW5zdGFuY2UKICAgICAqIG9mIGBGb3JtQ29udHJvbGxlcmAuCiAgICAgKgogICAgICovCiAgICAvL2Fza3MgZm9yICRzY29wZSB0byBmb29sIHRoZSBCQyBjb250cm9sbGVyIG1vZHVsZQogICAgRm9ybUNvbnRyb2xsZXIuJGluamVjdCA9IFsnJGVsZW1lbnQnLCAnJGF0dHJzJywgJyRzY29wZSddOwogICAgZnVuY3Rpb24gRm9ybUNvbnRyb2xsZXIoZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICB2YXIgZm9ybSA9IHRoaXMsCiAgICAgICAgICAgIHBhcmVudEZvcm0gPSBlbGVtZW50LnBhcmVudCgpLmNvbnRyb2xsZXIoJ2Zvcm0nKSB8fCBudWxsRm9ybUN0cmwsCiAgICAgICAgICAgIGludmFsaWRDb3VudCA9IDAsIC8vIHVzZWQgdG8gZWFzaWx5IGRldGVybWluZSBpZiB3ZSBhcmUgdmFsaWQKICAgICAgICAgICAgZXJyb3JzID0gZm9ybS4kZXJyb3IgPSB7fSwKICAgICAgICAgICAgY29udHJvbHMgPSBbXTsKCiAgICAgICAgLy8gaW5pdCBzdGF0ZQogICAgICAgIGZvcm0uJG5hbWUgPSBhdHRycy5uYW1lIHx8IGF0dHJzLm5nRm9ybTsKICAgICAgICBmb3JtLiRkaXJ0eSA9IGZhbHNlOwogICAgICAgIGZvcm0uJHByaXN0aW5lID0gdHJ1ZTsKICAgICAgICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgICAgICAgZm9ybS4kaW52YWxpZCA9IGZhbHNlOwoKICAgICAgICBwYXJlbnRGb3JtLiRhZGRDb250cm9sKGZvcm0pOwoKICAgICAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhQUklTVElORV9DTEFTUyk7CiAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CgogICAgICAgIC8vIGNvbnZlbmllbmNlIG1ldGhvZCBmb3IgZWFzeSB0b2dnbGluZyBvZiBjbGFzc2VzCiAgICAgICAgZnVuY3Rpb24gdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KSB7CiAgICAgICAgICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAgICAgICAgIGVsZW1lbnQuCiAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MoKGlzVmFsaWQgPyBJTlZBTElEX0NMQVNTIDogVkFMSURfQ0xBU1MpICsgdmFsaWRhdGlvbkVycm9yS2V5KS4KICAgICAgICAgICAgICBhZGRDbGFzcygoaXNWYWxpZCA/IFZBTElEX0NMQVNTIDogSU5WQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIjJGFkZENvbnRyb2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlZ2lzdGVyIGEgY29udHJvbCB3aXRoIHRoZSBmb3JtLgogICAgICAgICAqCiAgICAgICAgICogSW5wdXQgZWxlbWVudHMgdXNpbmcgbmdNb2RlbENvbnRyb2xsZXIgZG8gdGhpcyBhdXRvbWF0aWNhbGx5IHdoZW4gdGhleSBhcmUgbGlua2VkLgogICAgICAgICAqLwogICAgICAgIGZvcm0uJGFkZENvbnRyb2wgPSBmdW5jdGlvbiAoY29udHJvbCkgewogICAgICAgICAgICBjb250cm9scy5wdXNoKGNvbnRyb2wpOwoKICAgICAgICAgICAgaWYgKGNvbnRyb2wuJG5hbWUgJiYgIWZvcm0uaGFzT3duUHJvcGVydHkoY29udHJvbC4kbmFtZSkpIHsKICAgICAgICAgICAgICAgIGZvcm1bY29udHJvbC4kbmFtZV0gPSBjb250cm9sOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIjJHJlbW92ZUNvbnRyb2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIERlcmVnaXN0ZXIgYSBjb250cm9sIGZyb20gdGhlIGZvcm0uCiAgICAgICAgICoKICAgICAgICAgKiBJbnB1dCBlbGVtZW50cyB1c2luZyBuZ01vZGVsQ29udHJvbGxlciBkbyB0aGlzIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGV5IGFyZSBkZXN0cm95ZWQuCiAgICAgICAgICovCiAgICAgICAgZm9ybS4kcmVtb3ZlQ29udHJvbCA9IGZ1bmN0aW9uIChjb250cm9sKSB7CiAgICAgICAgICAgIGlmIChjb250cm9sLiRuYW1lICYmIGZvcm1bY29udHJvbC4kbmFtZV0gPT09IGNvbnRyb2wpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBmb3JtW2NvbnRyb2wuJG5hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvckVhY2goZXJyb3JzLCBmdW5jdGlvbiAocXVldWUsIHZhbGlkYXRpb25Ub2tlbikgewogICAgICAgICAgICAgICAgZm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCB0cnVlLCBjb250cm9sKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBhcnJheVJlbW92ZShjb250cm9scywgY29udHJvbCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICAgICAgICogQG1ldGhvZE9mIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTZXRzIHRoZSB2YWxpZGl0eSBvZiBhIGZvcm0gY29udHJvbC4KICAgICAgICAgKgogICAgICAgICAqIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gcGFyZW50IGZvcm1zLgogICAgICAgICAqLwogICAgICAgIGZvcm0uJHNldFZhbGlkaXR5ID0gZnVuY3Rpb24gKHZhbGlkYXRpb25Ub2tlbiwgaXNWYWxpZCwgY29udHJvbCkgewogICAgICAgICAgICB2YXIgcXVldWUgPSBlcnJvcnNbdmFsaWRhdGlvblRva2VuXTsKCiAgICAgICAgICAgIGlmIChpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICBpZiAocXVldWUpIHsKICAgICAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShxdWV1ZSwgY29udHJvbCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFxdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW52YWxpZENvdW50LS07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaW52YWxpZENvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0uJHZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0uJGludmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnNbdmFsaWRhdGlvblRva2VuXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyh0cnVlLCB2YWxpZGF0aW9uVG9rZW4pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIHRydWUsIGZvcm0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWludmFsaWRDb3VudCkgewogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHF1ZXVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzKHF1ZXVlLCBjb250cm9sKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcnNbdmFsaWRhdGlvblRva2VuXSA9IHF1ZXVlID0gW107CiAgICAgICAgICAgICAgICAgICAgaW52YWxpZENvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoZmFsc2UsIHZhbGlkYXRpb25Ub2tlbik7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCBmYWxzZSwgZm9ybSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBxdWV1ZS5wdXNoKGNvbnRyb2wpOwoKICAgICAgICAgICAgICAgIGZvcm0uJHZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICBmb3JtLiRpbnZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyIyRzZXREaXJ0eQogICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6Zm9ybS5Gb3JtQ29udHJvbGxlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2V0cyB0aGUgZm9ybSB0byBhIGRpcnR5IHN0YXRlLgogICAgICAgICAqCiAgICAgICAgICogVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB0byBhZGQgdGhlICduZy1kaXJ0eScgY2xhc3MgYW5kIHNldCB0aGUgZm9ybSB0byBhIGRpcnR5CiAgICAgICAgICogc3RhdGUgKG5nLWRpcnR5IGNsYXNzKS4gVGhpcyBtZXRob2Qgd2lsbCBhbHNvIHByb3BhZ2F0ZSB0byBwYXJlbnQgZm9ybXMuCiAgICAgICAgICovCiAgICAgICAgZm9ybS4kc2V0RGlydHkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpLmFkZENsYXNzKERJUlRZX0NMQVNTKTsKICAgICAgICAgICAgZm9ybS4kZGlydHkgPSB0cnVlOwogICAgICAgICAgICBmb3JtLiRwcmlzdGluZSA9IGZhbHNlOwogICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyIyRzZXRQcmlzdGluZQogICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6Zm9ybS5Gb3JtQ29udHJvbGxlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2V0cyB0aGUgZm9ybSB0byBpdHMgcHJpc3RpbmUgc3RhdGUuCiAgICAgICAgICoKICAgICAgICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIHJlbW92ZSB0aGUgJ25nLWRpcnR5JyBjbGFzcyBhbmQgc2V0IHRoZSBmb3JtIHRvIGl0cyBwcmlzdGluZQogICAgICAgICAqIHN0YXRlIChuZy1wcmlzdGluZSBjbGFzcykuIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gYWxsIHRoZSBjb250cm9scyBjb250YWluZWQKICAgICAgICAgKiBpbiB0aGlzIGZvcm0uCiAgICAgICAgICoKICAgICAgICAgKiBTZXR0aW5nIGEgZm9ybSBiYWNrIHRvIGEgcHJpc3RpbmUgc3RhdGUgaXMgb2Z0ZW4gdXNlZnVsIHdoZW4gd2Ugd2FudCB0byAncmV1c2UnIGEgZm9ybSBhZnRlcgogICAgICAgICAqIHNhdmluZyBvciByZXNldHRpbmcgaXQuCiAgICAgICAgICovCiAgICAgICAgZm9ybS4kc2V0UHJpc3RpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoRElSVFlfQ0xBU1MpLmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgICAgICAgICAgZm9ybS4kZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgZm9ybS4kcHJpc3RpbmUgPSB0cnVlOwogICAgICAgICAgICBmb3JFYWNoKGNvbnRyb2xzLCBmdW5jdGlvbiAoY29udHJvbCkgewogICAgICAgICAgICAgICAgY29udHJvbC4kc2V0UHJpc3RpbmUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdGb3JtCiAgICAgKiBAcmVzdHJpY3QgRUFDCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBOZXN0YWJsZSBhbGlhcyBvZiB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gYGZvcm1gfSBkaXJlY3RpdmUuIEhUTUwKICAgICAqIGRvZXMgbm90IGFsbG93IG5lc3Rpbmcgb2YgZm9ybSBlbGVtZW50cy4gSXQgaXMgdXNlZnVsIHRvIG5lc3QgZm9ybXMsIGZvciBleGFtcGxlIGlmIHRoZSB2YWxpZGl0eSBvZiBhCiAgICAgKiBzdWItZ3JvdXAgb2YgY29udHJvbHMgbmVlZHMgdG8gYmUgZGV0ZXJtaW5lZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWV8bmdGb3JtIE5hbWUgb2YgdGhlIGZvcm0uIElmIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciB3aWxsIGJlIHB1Ymxpc2hlZCBpbnRvCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRlZCBzY29wZSwgdW5kZXIgdGhpcyBuYW1lLgogICAgICoKICAgICAqLwoKICAgIC8qKgogICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpmb3JtCiAgICAqIEByZXN0cmljdCBFCiAgICAqCiAgICAqIEBkZXNjcmlwdGlvbgogICAgKiBEaXJlY3RpdmUgdGhhdCBpbnN0YW50aWF0ZXMKICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyIEZvcm1Db250cm9sbGVyfS4KICAgICoKICAgICogSWYgYG5hbWVgIGF0dHJpYnV0ZSBpcyBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgaXMgcHVibGlzaGVkIG9udG8gdGhlIGN1cnJlbnQgc2NvcGUgdW5kZXIKICAgICogdGhpcyBuYW1lLgogICAgKgogICAgKiAjIEFsaWFzOiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nRm9ybSBgbmdGb3JtYH0KICAgICoKICAgICogSW4gYW5ndWxhciBmb3JtcyBjYW4gYmUgbmVzdGVkLiBUaGlzIG1lYW5zIHRoYXQgdGhlIG91dGVyIGZvcm0gaXMgdmFsaWQgd2hlbiBhbGwgb2YgdGhlIGNoaWxkCiAgICAqIGZvcm1zIGFyZSB2YWxpZCBhcyB3ZWxsLiBIb3dldmVyIGJyb3dzZXJzIGRvIG5vdCBhbGxvdyBuZXN0aW5nIG9mIGA8Zm9ybT5gIGVsZW1lbnRzLCBmb3IgdGhpcwogICAgKiByZWFzb24gYW5ndWxhciBwcm92aWRlcyB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nRm9ybSBgbmdGb3JtYH0gYWxpYXMKICAgICogd2hpY2ggYmVoYXZlcyBpZGVudGljYWwgdG8gYDxmb3JtPmAgYnV0IGFsbG93cyBmb3JtIG5lc3RpbmcuCiAgICAqCiAgICAqCiAgICAqICMgQ1NTIGNsYXNzZXMKICAgICogIC0gYG5nLXZhbGlkYCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgdmFsaWQuCiAgICAqICAtIGBuZy1pbnZhbGlkYCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgaW52YWxpZC4KICAgICogIC0gYG5nLXByaXN0aW5lYCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgcHJpc3RpbmUuCiAgICAqICAtIGBuZy1kaXJ0eWAgSXMgc2V0IGlmIHRoZSBmb3JtIGlzIGRpcnR5LgogICAgKgogICAgKgogICAgKiAjIFN1Ym1pdHRpbmcgYSBmb3JtIGFuZCBwcmV2ZW50aW5nIGRlZmF1bHQgYWN0aW9uCiAgICAqCiAgICAqIFNpbmNlIHRoZSByb2xlIG9mIGZvcm1zIGluIGNsaWVudC1zaWRlIEFuZ3VsYXIgYXBwbGljYXRpb25zIGlzIGRpZmZlcmVudCB0aGFuIGluIGNsYXNzaWNhbAogICAgKiByb3VuZHRyaXAgYXBwcywgaXQgaXMgZGVzaXJhYmxlIGZvciB0aGUgYnJvd3NlciBub3QgdG8gdHJhbnNsYXRlIHRoZSBmb3JtIHN1Ym1pc3Npb24gaW50byBhIGZ1bGwKICAgICogcGFnZSByZWxvYWQgdGhhdCBzZW5kcyB0aGUgZGF0YSB0byB0aGUgc2VydmVyLiBJbnN0ZWFkIHNvbWUgamF2YXNjcmlwdCBsb2dpYyBzaG91bGQgYmUgdHJpZ2dlcmVkCiAgICAqIHRvIGhhbmRsZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGluIGFwcGxpY2F0aW9uIHNwZWNpZmljIHdheS4KICAgICoKICAgICogRm9yIHRoaXMgcmVhc29uLCBBbmd1bGFyIHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAoZm9ybSBzdWJtaXNzaW9uIHRvIHRoZSBzZXJ2ZXIpIHVubGVzcyB0aGUKICAgICogYDxmb3JtPmAgZWxlbWVudCBoYXMgYW4gYGFjdGlvbmAgYXR0cmlidXRlIHNwZWNpZmllZC4KICAgICoKICAgICogWW91IGNhbiB1c2Ugb25lIG9mIHRoZSBmb2xsb3dpbmcgdHdvIHdheXMgdG8gc3BlY2lmeSB3aGF0IGphdmFzY3JpcHQgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgd2hlbgogICAgKiBhIGZvcm0gaXMgc3VibWl0dGVkOgogICAgKgogICAgKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdTdWJtaXQgbmdTdWJtaXR9IGRpcmVjdGl2ZSBvbiB0aGUgZm9ybSBlbGVtZW50CiAgICAqIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9IGRpcmVjdGl2ZSBvbiB0aGUgZmlyc3QKICAgICAqICBidXR0b24gb3IgaW5wdXQgZmllbGQgb2YgdHlwZSBzdWJtaXQgKGlucHV0W3R5cGU9c3VibWl0XSkKICAgICoKICAgICogVG8gcHJldmVudCBkb3VibGUgZXhlY3V0aW9uIG9mIHRoZSBoYW5kbGVyLCB1c2Ugb25seSBvbmUgb2YgbmdTdWJtaXQgb3IgbmdDbGljayBkaXJlY3RpdmVzLiBUaGlzCiAgICAqIGlzIGJlY2F1c2Ugb2YgdGhlIGZvbGxvd2luZyBmb3JtIHN1Ym1pc3Npb24gcnVsZXMgY29taW5nIGZyb20gdGhlIGh0bWwgc3BlYzoKICAgICoKICAgICogLSBJZiBhIGZvcm0gaGFzIG9ubHkgb25lIGlucHV0IGZpZWxkIHRoZW4gaGl0dGluZyBlbnRlciBpbiB0aGlzIGZpZWxkIHRyaWdnZXJzIGZvcm0gc3VibWl0CiAgICAqIChgbmdTdWJtaXRgKQogICAgKiAtIGlmIGEgZm9ybSBoYXMgaGFzIDIrIGlucHV0IGZpZWxkcyBhbmQgbm8gYnV0dG9ucyBvciBpbnB1dFt0eXBlPXN1Ym1pdF0gdGhlbiBoaXR0aW5nIGVudGVyCiAgICAqIGRvZXNuJ3QgdHJpZ2dlciBzdWJtaXQKICAgICogLSBpZiBhIGZvcm0gaGFzIG9uZSBvciBtb3JlIGlucHV0IGZpZWxkcyBhbmQgb25lIG9yIG1vcmUgYnV0dG9ucyBvciBpbnB1dFt0eXBlPXN1Ym1pdF0gdGhlbgogICAgKiBoaXR0aW5nIGVudGVyIGluIGFueSBvZiB0aGUgaW5wdXQgZmllbGRzIHdpbGwgdHJpZ2dlciB0aGUgY2xpY2sgaGFuZGxlciBvbiB0aGUgKmZpcnN0KiBidXR0b24gb3IKICAgICogaW5wdXRbdHlwZT1zdWJtaXRdIChgbmdDbGlja2ApICphbmQqIGEgc3VibWl0IGhhbmRsZXIgb24gdGhlIGVuY2xvc2luZyBmb3JtIChgbmdTdWJtaXRgKQogICAgKgogICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgTmFtZSBvZiB0aGUgZm9ybS4gSWYgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIHdpbGwgYmUgcHVibGlzaGVkIGludG8KICAgICogICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgc2NvcGUsIHVuZGVyIHRoaXMgbmFtZS4KICAgICoKICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgICRzY29wZS51c2VyVHlwZSA9ICdndWVzdCc7CiAgICAgICAgICAgIH0KICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgdXNlclR5cGU6IDxpbnB1dCBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InVzZXJUeXBlIiByZXF1aXJlZD4KICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj5SZXF1aXJlZCE8L3NwYW4+PGJyPgogICAgICAgICAgICA8dHQ+dXNlclR5cGUgPSB7e3VzZXJUeXBlfX08L3R0Pjxicj4KICAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyPgogICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnI+CiAgICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyVHlwZScpKS50b0VxdWFsKCdndWVzdCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICAgfSk7CiAgIAogICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndXNlclR5cGUnKS5lbnRlcignJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyVHlwZScpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICA8L2RvYzpleGFtcGxlPgogICAgKi8KICAgIHZhciBmb3JtRGlyZWN0aXZlRmFjdG9yeSA9IGZ1bmN0aW9uIChpc05nRm9ybSkgewogICAgICAgIHJldHVybiBbJyR0aW1lb3V0JywgZnVuY3Rpb24gKCR0aW1lb3V0KSB7CiAgICAgICAgICAgIHZhciBmb3JtRGlyZWN0aXZlID0gewogICAgICAgICAgICAgICAgbmFtZTogJ2Zvcm0nLAogICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IEZvcm1Db250cm9sbGVyLAogICAgICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZTogZnVuY3Rpb24gKHNjb3BlLCBmb3JtRWxlbWVudCwgYXR0ciwgY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhdHRyLmFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGNhbid0IHVzZSBqcSBldmVudHMgYmVjYXVzZSBpZiBhIGZvcm0gaXMgZGVzdHJveWVkIGR1cmluZyBzdWJtaXNzaW9uIHRoZSBkZWZhdWx0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWN0aW9uIGlzIG5vdCBwcmV2ZW50ZWQuIHNlZSAjMTIzOAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSUUgOSBpcyBub3QgYWZmZWN0ZWQgYmVjYXVzZSBpdCBkb2Vzbid0IGZpcmUgYSBzdWJtaXQgZXZlbnQgYW5kIHRyeSB0byBkbyBhIGZ1bGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwYWdlIHJlbG9hZCBpZiB0aGUgZm9ybSB3YXMgZGVzdHJveWVkIGJ5IHN1Ym1pc3Npb24gb2YgdGhlIGZvcm0gdmlhIGEgY2xpY2sgaGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9uIGEgYnV0dG9uIGluIHRoZSBmb3JtLiBMb29rcyBsaWtlIGFuIElFOSBzcGVjaWZpYyBidWcuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZlbnREZWZhdWx0TGlzdGVuZXIgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGV2ZW50LnByZXZlbnREZWZhdWx0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7IC8vIElFCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKGZvcm1FbGVtZW50WzBdLCAnc3VibWl0JywgcHJldmVudERlZmF1bHRMaXN0ZW5lcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVucmVnaXN0ZXIgdGhlIHByZXZlbnREZWZhdWx0IGxpc3RlbmVyIHNvIHRoYXQgd2UgZG9uJ3Qgbm90IGxlYWsgbWVtb3J5IGJ1dCBpbiBhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2F5IHRoYXQgd2lsbCBhY2hpZXZlIHRoZSBwcmV2ZW50aW9uIG9mIHRoZSBkZWZhdWx0IGFjdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtRWxlbWVudC5vbignJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihmb3JtRWxlbWVudFswXSwgJ3N1Ym1pdCcsIHByZXZlbnREZWZhdWx0TGlzdGVuZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAwLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEZvcm1DdHJsID0gZm9ybUVsZW1lbnQucGFyZW50KCkuY29udHJvbGxlcignZm9ybScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsaWFzID0gYXR0ci5uYW1lIHx8IGF0dHIubmdGb3JtOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhbGlhcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldHRlcihzY29wZSwgYWxpYXMsIGNvbnRyb2xsZXIsIGFsaWFzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRGb3JtQ3RybCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1FbGVtZW50Lm9uKCckZGVzdHJveScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybUN0cmwuJHJlbW92ZUNvbnRyb2woY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhbGlhcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGVyKHNjb3BlLCBhbGlhcywgdW5kZWZpbmVkLCBhbGlhcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0ZW5kKGNvbnRyb2xsZXIsIG51bGxGb3JtQ3RybCk7IC8vc3RvcCBwcm9wYWdhdGluZyBjaGlsZCBkZXN0cnVjdGlvbiBoYW5kbGVycyB1cHdhcmRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGlzTmdGb3JtID8gZXh0ZW5kKGNvcHkoZm9ybURpcmVjdGl2ZSksIHsgcmVzdHJpY3Q6ICdFQUMnIH0pIDogZm9ybURpcmVjdGl2ZTsKICAgICAgICB9XTsKICAgIH07CgogICAgdmFyIGZvcm1EaXJlY3RpdmUgPSBmb3JtRGlyZWN0aXZlRmFjdG9yeSgpOwogICAgdmFyIG5nRm9ybURpcmVjdGl2ZSA9IGZvcm1EaXJlY3RpdmVGYWN0b3J5KHRydWUpOwoKICAgIHZhciBVUkxfUkVHRVhQID0gL14oZnRwfGh0dHB8aHR0cHMpOlwvXC8oXHcrOnswLDF9XHcqQCk/KFxTKykoOlswLTldKyk/KFwvfFwvKFtcdyMhOi4/Kz0mJUAhXC1cL10pKT8kLzsKICAgIHZhciBFTUFJTF9SRUdFWFAgPSAvXltBLVphLXowLTkuXyUrLV0rQFtBLVphLXowLTkuLV0rXC5bQS1aYS16XXsyLDZ9JC87CiAgICB2YXIgTlVNQkVSX1JFR0VYUCA9IC9eXHMqKFwtfFwrKT8oXGQrfChcZCooXC5cZCopKSlccyokLzsKCiAgICB2YXIgaW5wdXRUeXBlID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LnRleHQKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFN0YW5kYXJkIEhUTUwgdGV4dCBpbnB1dCB3aXRoIGFuZ3VsYXIgZGF0YSBiaW5kaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtuZ1RyaW09dHJ1ZV0gSWYgc2V0IHRvIGZhbHNlIEFuZ3VsYXIgd2lsbCBub3QgYXV0b21hdGljYWxseSB0cmltbWluZyB0aGUKICAgICAgICAgKiAgICBpbnB1dC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnZ3Vlc3QnOwogICAgICAgICAgICAgICAgICAgJHNjb3BlLndvcmQgPSAvXlxzKlx3KlxzKiQvOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgICAgICAgU2luZ2xlIHdvcmQ6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZy1wYXR0ZXJuPSJ3b3JkIiByZXF1aXJlZCBuZy10cmltPSJmYWxzZSI+CiAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucGF0dGVybiI+CiAgICAgICAgICAgICAgICAgICBTaW5nbGUgd29yZCBvbmx5ITwvc3Bhbj4KICAgICAgCiAgICAgICAgICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnZ3Vlc3QnKTsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgIAogICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJycpOwogICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAKICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBtdWx0aSB3b3JkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ2hlbGxvIHdvcmxkJyk7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgCiAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG5vdCBiZSB0cmltbWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ3VudHJpbW1lZCAnKTsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgndW50cmltbWVkICcpOwogICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAndGV4dCc6IHRleHRJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0Lm51bWJlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGV4dCBpbnB1dCB3aXRoIG51bWJlciB2YWxpZGF0aW9uIGFuZCB0cmFuc2Zvcm1hdGlvbi4gU2V0cyB0aGUgYG51bWJlcmAgdmFsaWRhdGlvbgogICAgICAgICAqIGVycm9yIGlmIG5vdCBhIHZhbGlkIG51bWJlci4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBtaW4gU2V0cyB0aGUgYG1pbmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGVudGVyZWQgaXMgbGVzcyB0aGFuIGBtaW5gLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWF4IFNldHMgdGhlIGBtYXhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGdyZWF0ZXIgdGhhbiBgbWF4YC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAkc2NvcGUudmFsdWUgPSAxMjsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgICAgICAgIE51bWJlcjogPGlucHV0IHR5cGU9Im51bWJlciIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ2YWx1ZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW49IjAiIG1heD0iOTkiIHJlcXVpcmVkPgogICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLm51bWJlciI+CiAgICAgICAgICAgICAgICAgICBOb3QgdmFsaWQgbnVtYmVyITwvc3Bhbj4KICAgICAgICAgICAgICAgICA8dHQ+dmFsdWUgPSB7e3ZhbHVlfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICAgICAgICAgPC9mb3JtPgogICAgICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJzEyJyk7CiAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgIAogICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgaW5wdXQoJ3ZhbHVlJykuZW50ZXIoJycpOwogICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgIAogICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG92ZXIgbWF4JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgaW5wdXQoJ3ZhbHVlJykuZW50ZXIoJzEyMycpOwogICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ251bWJlcic6IG51bWJlcklucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQudXJsCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUZXh0IGlucHV0IHdpdGggVVJMIHZhbGlkYXRpb24uIFNldHMgdGhlIGB1cmxgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSBjb250ZW50IGlzIG5vdCBhCiAgICAgICAgICogdmFsaWQgVVJMLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdodHRwOi8vZ29vZ2xlLmNvbSc7CiAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgICAgICBVUkw6IDxpbnB1dCB0eXBlPSJ1cmwiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idGV4dCIgcmVxdWlyZWQ+CiAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IudXJsIj4KICAgICAgICAgICAgICAgICAgIE5vdCB2YWxpZCB1cmwhPC9zcGFuPgogICAgICAgICAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnVybCA9IHt7ISFteUZvcm0uJGVycm9yLnVybH19PC90dD48YnIvPgogICAgICAgICAgICAgICAgPC9mb3JtPgogICAgICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0JykpLnRvRXF1YWwoJ2h0dHA6Ly9nb29nbGUuY29tJyk7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAKICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgCiAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbm90IHVybCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCd4eHgnKTsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICAgICAqLwogICAgICAgICd1cmwnOiB1cmxJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LmVtYWlsCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUZXh0IGlucHV0IHdpdGggZW1haWwgdmFsaWRhdGlvbi4gU2V0cyB0aGUgYGVtYWlsYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiBub3QgYSB2YWxpZCBlbWFpbAogICAgICAgICAqIGFkZHJlc3MuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgICAgICogICAgbWlubGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ21lQGV4YW1wbGUuY29tJzsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgICAgICAgICBFbWFpbDogPGlucHV0IHR5cGU9ImVtYWlsIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiIHJlcXVpcmVkPgogICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLmVtYWlsIj4KICAgICAgICAgICAgICAgICAgICAgTm90IHZhbGlkIGVtYWlsITwvc3Bhbj4KICAgICAgICAgICAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5lbWFpbCA9IHt7ISFteUZvcm0uJGVycm9yLmVtYWlsfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgPC9mb3JtPgogICAgICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0JykpLnRvRXF1YWwoJ21lQGV4YW1wbGUuY29tJyk7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAKICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgCiAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbm90IGVtYWlsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ3h4eCcpOwogICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ2VtYWlsJzogZW1haWxJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LnJhZGlvCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBIVE1MIHJhZGlvIGJ1dHRvbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgICAgICAgJHNjb3BlLmNvbG9yID0gJ2JsdWUnOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJyZWQiPiAgUmVkIDxici8+CiAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJncmVlbiI+IEdyZWVuIDxici8+CiAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJibHVlIj4gQmx1ZSA8YnIvPgogICAgICAgICAgICAgICAgIDx0dD5jb2xvciA9IHt7Y29sb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgIDwvZm9ybT4KICAgICAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHN0YXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2xvcicpKS50b0VxdWFsKCdibHVlJyk7CiAgICAgIAogICAgICAgICAgICAgICAgICBpbnB1dCgnY29sb3InKS5zZWxlY3QoJ3JlZCcpOwogICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnY29sb3InKSkudG9FcXVhbCgncmVkJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAncmFkaW8nOiByYWRpb0lucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQuY2hlY2tib3gKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEhUTUwgY2hlY2tib3guCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdUcnVlVmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nRmFsc2VWYWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIG5vdCBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAkc2NvcGUudmFsdWUxID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICRzY29wZS52YWx1ZTIgPSAnWUVTJwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgICAgICAgVmFsdWUxOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJ2YWx1ZTEiPiA8YnIvPgogICAgICAgICAgICAgICAgIFZhbHVlMjogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0idmFsdWUyIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5nLXRydWUtdmFsdWU9IllFUyIgbmctZmFsc2UtdmFsdWU9Ik5PIj4gPGJyLz4KICAgICAgICAgICAgICAgICA8dHQ+dmFsdWUxID0ge3t2YWx1ZTF9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgICA8dHQ+dmFsdWUyID0ge3t2YWx1ZTJ9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgIDwvZm9ybT4KICAgICAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHN0YXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZTEnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUyJykpLnRvRXF1YWwoJ1lFUycpOwogICAgICAKICAgICAgICAgICAgICAgICAgaW5wdXQoJ3ZhbHVlMScpLmNoZWNrKCk7CiAgICAgICAgICAgICAgICAgIGlucHV0KCd2YWx1ZTInKS5jaGVjaygpOwogICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUxJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZTInKSkudG9FcXVhbCgnTk8nKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICAgICAqLwogICAgICAgICdjaGVja2JveCc6IGNoZWNrYm94SW5wdXRUeXBlLAoKICAgICAgICAnaGlkZGVuJzogbm9vcCwKICAgICAgICAnYnV0dG9uJzogbm9vcCwKICAgICAgICAnc3VibWl0Jzogbm9vcCwKICAgICAgICAncmVzZXQnOiBub29wCiAgICB9OwoKCiAgICBmdW5jdGlvbiBpc0VtcHR5KHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGlzVW5kZWZpbmVkKHZhbHVlKSB8fCB2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgIT09IHZhbHVlOwogICAgfQoKCiAgICBmdW5jdGlvbiB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKCiAgICAgICAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBlbGVtZW50LnZhbCgpOwoKICAgICAgICAgICAgLy8gQnkgZGVmYXVsdCB3ZSB3aWxsIHRyaW0gdGhlIHZhbHVlCiAgICAgICAgICAgIC8vIElmIHRoZSBhdHRyaWJ1dGUgbmctdHJpbSBleGlzdHMgd2Ugd2lsbCBhdm9pZCB0cmltbWluZwogICAgICAgICAgICAvLyBlLmcuIDxpbnB1dCBuZy1tb2RlbD0iZm9vIiBuZy10cmltPSJmYWxzZSI+CiAgICAgICAgICAgIGlmICh0b0Jvb2xlYW4oYXR0ci5uZ1RyaW0gfHwgJ1QnKSkgewogICAgICAgICAgICAgICAgdmFsdWUgPSB0cmltKHZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGN0cmwuJHZpZXdWYWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gaWYgdGhlIGJyb3dzZXIgZG9lcyBzdXBwb3J0ICJpbnB1dCIgZXZlbnQsIHdlIGFyZSBmaW5lIC0gZXhjZXB0IG9uIElFOSB3aGljaCBkb2Vzbid0IGZpcmUgdGhlCiAgICAgICAgLy8gaW5wdXQgZXZlbnQgb24gYmFja3NwYWNlLCBkZWxldGUgb3IgY3V0CiAgICAgICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdpbnB1dCcpKSB7CiAgICAgICAgICAgIGVsZW1lbnQub24oJ2lucHV0JywgbGlzdGVuZXIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB0aW1lb3V0OwoKICAgICAgICAgICAgdmFyIGRlZmVyTGlzdGVuZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcigpOwogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGVsZW1lbnQub24oJ2tleWRvd24nLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBldmVudC5rZXlDb2RlOwoKICAgICAgICAgICAgICAgIC8vIGlnbm9yZQogICAgICAgICAgICAgICAgLy8gICAgY29tbWFuZCAgICAgICAgICAgIG1vZGlmaWVycyAgICAgICAgICAgICAgICAgICBhcnJvd3MKICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IDkxIHx8ICgxNSA8IGtleSAmJiBrZXkgPCAxOSkgfHwgKDM3IDw9IGtleSAmJiBrZXkgPD0gNDApKSByZXR1cm47CgogICAgICAgICAgICAgICAgZGVmZXJMaXN0ZW5lcigpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIGlmIHVzZXIgcGFzdGUgaW50byBpbnB1dCB1c2luZyBtb3VzZSwgd2UgbmVlZCAiY2hhbmdlIiBldmVudCB0byBjYXRjaCBpdAogICAgICAgICAgICBlbGVtZW50Lm9uKCdjaGFuZ2UnLCBsaXN0ZW5lcik7CgogICAgICAgICAgICAvLyBpZiB1c2VyIG1vZGlmaWVzIGlucHV0IHZhbHVlIHVzaW5nIGNvbnRleHQgbWVudSBpbiBJRSwgd2UgbmVlZCAicGFzdGUiIGFuZCAiY3V0IiBldmVudHMgdG8gY2F0Y2ggaXQKICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdwYXN0ZScpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50Lm9uKCdwYXN0ZSBjdXQnLCBkZWZlckxpc3RlbmVyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZWxlbWVudC52YWwoaXNFbXB0eShjdHJsLiR2aWV3VmFsdWUpID8gJycgOiBjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgIH07CgogICAgICAgIC8vIHBhdHRlcm4gdmFsaWRhdG9yCiAgICAgICAgdmFyIHBhdHRlcm4gPSBhdHRyLm5nUGF0dGVybiwKICAgICAgICAgICAgcGF0dGVyblZhbGlkYXRvciwKICAgICAgICAgICAgbWF0Y2g7CgogICAgICAgIHZhciB2YWxpZGF0ZSA9IGZ1bmN0aW9uIChyZWdleHAsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSB8fCByZWdleHAudGVzdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdwYXR0ZXJuJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgncGF0dGVybicsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBpZiAocGF0dGVybikgewogICAgICAgICAgICBtYXRjaCA9IHBhdHRlcm4ubWF0Y2goL15cLyguKilcLyhbZ2ltXSopJC8pOwogICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgIHBhdHRlcm4gPSBuZXcgUmVnRXhwKG1hdGNoWzFdLCBtYXRjaFsyXSk7CiAgICAgICAgICAgICAgICBwYXR0ZXJuVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRlKHBhdHRlcm4sIHZhbHVlKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcGF0dGVybk9iaiA9IHNjb3BlLiRldmFsKHBhdHRlcm4pOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXBhdHRlcm5PYmogfHwgIXBhdHRlcm5PYmoudGVzdCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBtaW5FcnIoJ25nUGF0dGVybicpKCdub3JlZ2V4cCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgJ0V4cGVjdGVkIHswfSB0byBiZSBhIFJlZ0V4cCBidXQgd2FzIHsxfS4gRWxlbWVudDogezJ9JywgcGF0dGVybiwKICAgICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuT2JqLCBzdGFydGluZ1RhZyhlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWxpZGF0ZShwYXR0ZXJuT2JqLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gocGF0dGVyblZhbGlkYXRvcik7CiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChwYXR0ZXJuVmFsaWRhdG9yKTsKICAgICAgICB9CgogICAgICAgIC8vIG1pbiBsZW5ndGggdmFsaWRhdG9yCiAgICAgICAgaWYgKGF0dHIubmdNaW5sZW5ndGgpIHsKICAgICAgICAgICAgdmFyIG1pbmxlbmd0aCA9IGludChhdHRyLm5nTWlubGVuZ3RoKTsKICAgICAgICAgICAgdmFyIG1pbkxlbmd0aFZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPCBtaW5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWlubGVuZ3RoJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtaW5sZW5ndGgnLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWluTGVuZ3RoVmFsaWRhdG9yKTsKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1pbkxlbmd0aFZhbGlkYXRvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBtYXggbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIGlmIChhdHRyLm5nTWF4bGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBtYXhsZW5ndGggPSBpbnQoYXR0ci5uZ01heGxlbmd0aCk7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGhWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICghaXNFbXB0eSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoID4gbWF4bGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21heGxlbmd0aCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWF4bGVuZ3RoJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKG1heExlbmd0aFZhbGlkYXRvcik7CiAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtYXhMZW5ndGhWYWxpZGF0b3IpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBudW1iZXJJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogICAgICAgIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgdmFyIGVtcHR5ID0gaXNFbXB0eSh2YWx1ZSk7CiAgICAgICAgICAgIGlmIChlbXB0eSB8fCBOVU1CRVJfUkVHRVhQLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbnVtYmVyJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09ICcnID8gbnVsbCA6IChlbXB0eSA/IHZhbHVlIDogcGFyc2VGbG9hdCh2YWx1ZSkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gaXNFbXB0eSh2YWx1ZSkgPyAnJyA6ICcnICsgdmFsdWU7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChhdHRyLm1pbikgewogICAgICAgICAgICB2YXIgbWluID0gcGFyc2VGbG9hdChhdHRyLm1pbik7CiAgICAgICAgICAgIHZhciBtaW5WYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICghaXNFbXB0eSh2YWx1ZSkgJiYgdmFsdWUgPCBtaW4pIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWluJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtaW4nLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWluVmFsaWRhdG9yKTsKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1pblZhbGlkYXRvcik7CiAgICAgICAgfQoKICAgICAgICBpZiAoYXR0ci5tYXgpIHsKICAgICAgICAgICAgdmFyIG1heCA9IHBhcnNlRmxvYXQoYXR0ci5tYXgpOwogICAgICAgICAgICB2YXIgbWF4VmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRW1wdHkodmFsdWUpICYmIHZhbHVlID4gbWF4KSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21heCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWF4JywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKG1heFZhbGlkYXRvcik7CiAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtYXhWYWxpZGF0b3IpOwogICAgICAgIH0KCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IGlzTnVtYmVyKHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cmxJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogICAgICAgIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogICAgICAgIHZhciB1cmxWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IFVSTF9SRUdFWFAudGVzdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCd1cmwnLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCd1cmwnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKHVybFZhbGlkYXRvcik7CiAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKHVybFZhbGlkYXRvcik7CiAgICB9CgogICAgZnVuY3Rpb24gZW1haWxJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogICAgICAgIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogICAgICAgIHZhciBlbWFpbFZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNFbXB0eSh2YWx1ZSkgfHwgRU1BSUxfUkVHRVhQLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnZW1haWwnLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdlbWFpbCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZW1haWxWYWxpZGF0b3IpOwogICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChlbWFpbFZhbGlkYXRvcik7CiAgICB9CgogICAgZnVuY3Rpb24gcmFkaW9JbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAvLyBtYWtlIHRoZSBuYW1lIHVuaXF1ZSwgaWYgbm90IGRlZmluZWQKICAgICAgICBpZiAoaXNVbmRlZmluZWQoYXR0ci5uYW1lKSkgewogICAgICAgICAgICBlbGVtZW50LmF0dHIoJ25hbWUnLCBuZXh0VWlkKCkpOwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChlbGVtZW50WzBdLmNoZWNrZWQpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBhdHRyLnZhbHVlOwogICAgICAgICAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSAodmFsdWUgPT0gY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBhdHRyLiRvYnNlcnZlKCd2YWx1ZScsIGN0cmwuJHJlbmRlcik7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tib3hJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICB2YXIgdHJ1ZVZhbHVlID0gYXR0ci5uZ1RydWVWYWx1ZSwKICAgICAgICAgICAgZmFsc2VWYWx1ZSA9IGF0dHIubmdGYWxzZVZhbHVlOwoKICAgICAgICBpZiAoIWlzU3RyaW5nKHRydWVWYWx1ZSkpIHRydWVWYWx1ZSA9IHRydWU7CiAgICAgICAgaWYgKCFpc1N0cmluZyhmYWxzZVZhbHVlKSkgZmFsc2VWYWx1ZSA9IGZhbHNlOwoKICAgICAgICBlbGVtZW50Lm9uKCdjbGljaycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShlbGVtZW50WzBdLmNoZWNrZWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSBjdHJsLiR2aWV3VmFsdWU7CiAgICAgICAgfTsKCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IHRydWVWYWx1ZTsKICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgPyB0cnVlVmFsdWUgOiBmYWxzZVZhbHVlOwogICAgICAgIH0pOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTp0ZXh0YXJlYQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEhUTUwgdGV4dGFyZWEgZWxlbWVudCBjb250cm9sIHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuIFRoZSBkYXRhLWJpbmRpbmcgYW5kIHZhbGlkYXRpb24KICAgICAqIHByb3BlcnRpZXMgb2YgdGhpcyBlbGVtZW50IGFyZSBleGFjdGx5IHRoZSBzYW1lIGFzIHRob3NlIG9mIHRoZQogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dCBlbGVtZW50fS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0CiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCBpbnB1dCBlbGVtZW50IGNvbnRyb2wgd2l0aCBhbmd1bGFyIGRhdGEtYmluZGluZy4gSW5wdXQgY29udHJvbCBmb2xsb3dzIEhUTUw1IGlucHV0IHR5cGVzCiAgICAgKiBhbmQgcG9seWZpbGxzIHRoZSBIVE1MNSB2YWxpZGF0aW9uIGJlaGF2aW9yIGZvciBvbGRlciBicm93c2Vycy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBuZ1JlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgaWYgc2V0IHRvIHRydWUKICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAgICRzY29wZS51c2VyID0ge25hbWU6ICdndWVzdCcsIGxhc3Q6ICd2aXNpdG9yJ307CiAgICAgICAgICAgICB9CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSI+CiAgICAgICAgICAgICAgIFVzZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InVzZXJOYW1lIiBuZy1tb2RlbD0idXNlci5uYW1lIiByZXF1aXJlZD4KICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0udXNlck5hbWUuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+PGJyPgogICAgICAgICAgICAgICBMYXN0IG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJsYXN0TmFtZSIgbmctbW9kZWw9InVzZXIubGFzdCIKICAgICAgICAgICAgICAgICBuZy1taW5sZW5ndGg9IjMiIG5nLW1heGxlbmd0aD0iMTAiPgogICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5sYXN0TmFtZS4kZXJyb3IubWlubGVuZ3RoIj4KICAgICAgICAgICAgICAgICBUb28gc2hvcnQhPC9zcGFuPgogICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5sYXN0TmFtZS4kZXJyb3IubWF4bGVuZ3RoIj4KICAgICAgICAgICAgICAgICBUb28gbG9uZyE8L3NwYW4+PGJyPgogICAgICAgICAgICAgPC9mb3JtPgogICAgICAgICAgICAgPGhyPgogICAgICAgICAgICAgPHR0PnVzZXIgPSB7e3VzZXJ9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgIDx0dD5teUZvcm0udXNlck5hbWUuJHZhbGlkID0ge3tteUZvcm0udXNlck5hbWUuJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgICAgIDx0dD5teUZvcm0udXNlck5hbWUuJGVycm9yID0ge3tteUZvcm0udXNlck5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICAgICAgICAgIDx0dD5teUZvcm0ubGFzdE5hbWUuJHZhbGlkID0ge3tteUZvcm0ubGFzdE5hbWUuJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgICAgIDx0dD5teUZvcm0ubGFzdE5hbWUuJGVycm9yID0ge3tteUZvcm0ubGFzdE5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyPgogICAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IubWlubGVuZ3RoID0ge3shIW15Rm9ybS4kZXJyb3IubWlubGVuZ3RofX08L3R0Pjxicj4KICAgICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLm1heGxlbmd0aCA9IHt7ISFteUZvcm0uJGVycm9yLm1heGxlbmd0aH19PC90dD48YnI+CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCIsImxhc3QiOiJ2aXNpdG9yIn0nKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLnVzZXJOYW1lLiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHkgd2hlbiByZXF1aXJlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlucHV0KCd1c2VyLm5hbWUnKS5lbnRlcignJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkudG9FcXVhbCgneyJsYXN0IjoidmlzaXRvciJ9Jyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS51c2VyTmFtZS4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgICBpdCgnc2hvdWxkIGJlIHZhbGlkIGlmIGVtcHR5IHdoZW4gbWluIGxlbmd0aCBpcyBzZXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpbnB1dCgndXNlci5sYXN0JykuZW50ZXIoJycpOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyJykpLnRvRXF1YWwoJ3sibmFtZSI6Imd1ZXN0IiwibGFzdCI6IiJ9Jyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgICAgfSk7CiAgICAKICAgICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGxlc3MgdGhhbiByZXF1aXJlZCBtaW4gbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaW5wdXQoJ3VzZXIubGFzdCcpLmVudGVyKCd4eCcpOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyJykpLnRvRXF1YWwoJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJGVycm9yJykpLnRvTWF0Y2goL21pbmxlbmd0aC8pOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBsb25nZXIgdGhhbiBtYXggbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaW5wdXQoJ3VzZXIubGFzdCcpLmVudGVyKCdzb21lIHJpZGljdWxvdXNseSBsb25nIG5hbWUnKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKQogICAgICAgICAgICAgICAgLnRvRXF1YWwoJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJGVycm9yJykpLnRvTWF0Y2goL21heGxlbmd0aC8pOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIGlucHV0RGlyZWN0aXZlID0gWyckYnJvd3NlcicsICckc25pZmZlcicsIGZ1bmN0aW9uICgkYnJvd3NlciwgJHNuaWZmZXIpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIGlmIChjdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgKGlucHV0VHlwZVtsb3dlcmNhc2UoYXR0ci50eXBlKV0gfHwgaW5wdXRUeXBlLnRleHQpKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH1dOwoKICAgIHZhciBWQUxJRF9DTEFTUyA9ICduZy12YWxpZCcsCiAgICAgICAgSU5WQUxJRF9DTEFTUyA9ICduZy1pbnZhbGlkJywKICAgICAgICBQUklTVElORV9DTEFTUyA9ICduZy1wcmlzdGluZScsCiAgICAgICAgRElSVFlfQ0xBU1MgPSAnbmctZGlydHknOwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gJHZpZXdWYWx1ZSBBY3R1YWwgc3RyaW5nIHZhbHVlIGluIHRoZSB2aWV3LgogICAgICogQHByb3BlcnR5IHsqfSAkbW9kZWxWYWx1ZSBUaGUgdmFsdWUgaW4gdGhlIG1vZGVsLCB0aGF0IHRoZSBjb250cm9sIGlzIGJvdW5kIHRvLgogICAgICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkcGFyc2VycyBBcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZSwgYXMgYSBwaXBlbGluZSwgd2hlbmV2ZXIKICAgICAgICAgICB0aGUgY29udHJvbCByZWFkcyB2YWx1ZSBmcm9tIHRoZSBET00uICBFYWNoIGZ1bmN0aW9uIGlzIGNhbGxlZCwgaW4gdHVybiwgcGFzc2luZyB0aGUgdmFsdWUKICAgICAgICAgICB0aHJvdWdoIHRvIHRoZSBuZXh0LiBVc2VkIHRvIHNhbml0aXplIC8gY29udmVydCB0aGUgdmFsdWUgYXMgd2VsbCBhcyB2YWxpZGF0aW9uLgogICAgICAgICAgIEZvciB2YWxpZGF0aW9uLCB0aGUgcGFyc2VycyBzaG91bGQgdXBkYXRlIHRoZSB2YWxpZGl0eSBzdGF0ZSB1c2luZwogICAgICAgICAgIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0VmFsaWRpdHkgJHNldFZhbGlkaXR5KCl9LAogICAgICAgICAgIGFuZCByZXR1cm4gYHVuZGVmaW5lZGAgZm9yIGludmFsaWQgdmFsdWVzLgogICAgCiAgICAgKgogICAgICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkZm9ybWF0dGVycyBBcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZSwgYXMgYSBwaXBlbGluZSwgd2hlbmV2ZXIKICAgICAgICAgICB0aGUgbW9kZWwgdmFsdWUgY2hhbmdlcy4gRWFjaCBmdW5jdGlvbiBpcyBjYWxsZWQsIGluIHR1cm4sIHBhc3NpbmcgdGhlIHZhbHVlIHRocm91Z2ggdG8gdGhlCiAgICAgICAgICAgbmV4dC4gVXNlZCB0byBmb3JtYXQgLyBjb252ZXJ0IHZhbHVlcyBmb3IgZGlzcGxheSBpbiB0aGUgY29udHJvbCBhbmQgdmFsaWRhdGlvbi4KICAgICAqICAgICAgPHByZT4KICAgICAqICAgICAgZnVuY3Rpb24gZm9ybWF0dGVyKHZhbHVlKSB7CiAgICAgKiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgKiAgICAgICAgICByZXR1cm4gdmFsdWUudG9VcHBlckNhc2UoKTsKICAgICAqICAgICAgICB9CiAgICAgKiAgICAgIH0KICAgICAqICAgICAgbmdNb2RlbC4kZm9ybWF0dGVycy5wdXNoKGZvcm1hdHRlcik7CiAgICAgKiAgICAgIDwvcHJlPgogICAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBBbiBvYmplY3QgaGFzaCB3aXRoIGFsbCBlcnJvcnMgYXMga2V5cy4KICAgICAqCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRwcmlzdGluZSBUcnVlIGlmIHVzZXIgaGFzIG5vdCBpbnRlcmFjdGVkIHdpdGggdGhlIGNvbnRyb2wgeWV0LgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkZGlydHkgVHJ1ZSBpZiB1c2VyIGhhcyBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aCB0aGUgY29udHJvbC4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHZhbGlkIFRydWUgaWYgdGhlcmUgaXMgbm8gZXJyb3IuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRpbnZhbGlkIFRydWUgaWYgYXQgbGVhc3Qgb25lIGVycm9yIG9uIHRoZSBjb250cm9sLgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIGBOZ01vZGVsQ29udHJvbGxlcmAgcHJvdmlkZXMgQVBJIGZvciB0aGUgYG5nLW1vZGVsYCBkaXJlY3RpdmUuIFRoZSBjb250cm9sbGVyIGNvbnRhaW5zCiAgICAgKiBzZXJ2aWNlcyBmb3IgZGF0YS1iaW5kaW5nLCB2YWxpZGF0aW9uLCBDU1MgdXBkYXRlLCB2YWx1ZSBmb3JtYXR0aW5nIGFuZCBwYXJzaW5nLiBJdAogICAgICogc3BlY2lmaWNhbGx5IGRvZXMgbm90IGNvbnRhaW4gYW55IGxvZ2ljIHdoaWNoIGRlYWxzIHdpdGggRE9NIHJlbmRlcmluZyBvciBsaXN0ZW5pbmcgdG8KICAgICAqIERPTSBldmVudHMuIFRoZSBgTmdNb2RlbENvbnRyb2xsZXJgIGlzIG1lYW50IHRvIGJlIGV4dGVuZGVkIGJ5IG90aGVyIGRpcmVjdGl2ZXMgd2hlcmUsIHRoZQogICAgICogZGlyZWN0aXZlIHByb3ZpZGVzIERPTSBtYW5pcHVsYXRpb24gYW5kIHRoZSBgTmdNb2RlbENvbnRyb2xsZXJgIHByb3ZpZGVzIHRoZSBkYXRhLWJpbmRpbmcuCiAgICAgKiBOb3RlIHRoYXQgeW91IGNhbm5vdCB1c2UgYE5nTW9kZWxDb250cm9sbGVyYCBpbiBhIGRpcmVjdGl2ZSB3aXRoIGFuIGlzb2xhdGVkIHNjb3BlLAogICAgICogYXMsIGluIHRoYXQgY2FzZSwgdGhlIGBuZy1tb2RlbGAgdmFsdWUgZ2V0cyBwdXQgaW50byB0aGUgaXNvbGF0ZWQgc2NvcGUgYW5kIGRvZXMgbm90IGdldAogICAgICogcHJvcG9nYXRlZCB0byB0aGUgcGFyZW50IHNjb3BlLgogICAgICoKICAgICAqCiAgICAgKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRvIHVzZSBgTmdNb2RlbENvbnRyb2xsZXJgIHdpdGggYSBjdXN0b20gY29udHJvbCB0byBhY2hpZXZlCiAgICAgKiBkYXRhLWJpbmRpbmcuIE5vdGljZSBob3cgZGlmZmVyZW50IGRpcmVjdGl2ZXMgKGBjb250ZW50ZWRpdGFibGVgLCBgbmctbW9kZWxgLCBhbmQgYHJlcXVpcmVkYCkKICAgICAqIGNvbGxhYm9yYXRlIHRvZ2V0aGVyIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgcmVzdWx0LgogICAgICoKICAgICAqIDxleGFtcGxlIG1vZHVsZT0iY3VzdG9tQ29udHJvbCI+CiAgICAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgICAgIFtjb250ZW50ZWRpdGFibGVdIHsKICAgICAgICAgICAgYm9yZGVyOiAxcHggc29saWQgYmxhY2s7CiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgICAgICAgICBtaW4taGVpZ2h0OiAyMHB4OwogICAgICAgICAgfQogICAgCiAgICAgICAgICAubmctaW52YWxpZCB7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHJlZDsKICAgICAgICAgIH0KICAgIAogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2N1c3RvbUNvbnRyb2wnLCBbXSkuCiAgICAgICAgICAgIGRpcmVjdGl2ZSgnY29udGVudGVkaXRhYmxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnQScsIC8vIG9ubHkgYWN0aXZhdGUgb24gZWxlbWVudCBhdHRyaWJ1dGUKICAgICAgICAgICAgICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsIC8vIGdldCBhIGhvbGQgb2YgTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycywgbmdNb2RlbCkgewogICAgICAgICAgICAgICAgICBpZighbmdNb2RlbCkgcmV0dXJuOyAvLyBkbyBub3RoaW5nIGlmIG5vIG5nLW1vZGVsCiAgICAKICAgICAgICAgICAgICAgICAgLy8gU3BlY2lmeSBob3cgVUkgc2hvdWxkIGJlIHVwZGF0ZWQKICAgICAgICAgICAgICAgICAgbmdNb2RlbC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKG5nTW9kZWwuJHZpZXdWYWx1ZSB8fCAnJyk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAKICAgICAgICAgICAgICAgICAgLy8gTGlzdGVuIGZvciBjaGFuZ2UgZXZlbnRzIHRvIGVuYWJsZSBiaW5kaW5nCiAgICAgICAgICAgICAgICAgIGVsZW1lbnQub24oJ2JsdXIga2V5dXAgY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KHJlYWQpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgcmVhZCgpOyAvLyBpbml0aWFsaXplCiAgICAKICAgICAgICAgICAgICAgICAgLy8gV3JpdGUgZGF0YSB0byB0aGUgbW9kZWwKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVhZCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaHRtbCA9IGVsZW1lbnQuaHRtbCgpOwogICAgICAgICAgICAgICAgICAgIC8vIFdoZW4gd2UgY2xlYXIgdGhlIGNvbnRlbnQgZWRpdGFibGUgdGhlIGJyb3dzZXIgbGVhdmVzIGEgPGJyPiBiZWhpbmQKICAgICAgICAgICAgICAgICAgICAvLyBJZiBzdHJpcC1iciBhdHRyaWJ1dGUgaXMgcHJvdmlkZWQgdGhlbiB3ZSBzdHJpcCB0aGlzIG91dAogICAgICAgICAgICAgICAgICAgIGlmKCBhdHRycy5zdHJpcEJyICYmIGh0bWwgPT0gJzxicj4nICkgewogICAgICAgICAgICAgICAgICAgICAgaHRtbCA9ICcnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBuZ01vZGVsLiRzZXRWaWV3VmFsdWUoaHRtbCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iPgogICAgICAgICAgIDxkaXYgY29udGVudGVkaXRhYmxlCiAgICAgICAgICAgICAgICBuYW1lPSJteVdpZGdldCIgbmctbW9kZWw9InVzZXJDb250ZW50IgogICAgICAgICAgICAgICAgc3RyaXAtYnI9InRydWUiCiAgICAgICAgICAgICAgICByZXF1aXJlZD5DaGFuZ2UgbWUhPC9kaXY+CiAgICAgICAgICAgIDxzcGFuIG5nLXNob3c9Im15Rm9ybS5teVdpZGdldC4kZXJyb3IucmVxdWlyZWQiPlJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICA8aHI+CiAgICAgICAgICAgPHRleHRhcmVhIG5nLW1vZGVsPSJ1c2VyQ29udGVudCI+PC90ZXh0YXJlYT4KICAgICAgICAgIDwvZm9ybT4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgICAgICAgaXQoJ3Nob3VsZCBkYXRhLWJpbmQgYW5kIGJlY29tZSBpbnZhbGlkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjb250ZW50RWRpdGFibGUgPSBlbGVtZW50KCdbY29udGVudGVkaXRhYmxlXScpOwogICAgCiAgICAgICAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUudGV4dCgpKS50b0VxdWFsKCdDaGFuZ2UgbWUhJyk7CiAgICAgICAgICAgIGlucHV0KCd1c2VyQ29udGVudCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS50ZXh0KCkpLnRvRXF1YWwoJycpOwogICAgICAgICAgICBleHBlY3QoY29udGVudEVkaXRhYmxlLnByb3AoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9uZy1pbnZhbGlkLXJlcXVpcmVkLyk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgKiA8L2V4YW1wbGU+CiAgICAgKgogICAgICovCiAgICB2YXIgTmdNb2RlbENvbnRyb2xsZXIgPSBbJyRzY29wZScsICckZXhjZXB0aW9uSGFuZGxlcicsICckYXR0cnMnLCAnJGVsZW1lbnQnLCAnJHBhcnNlJywKICAgICAgICBmdW5jdGlvbiAoJHNjb3BlLCAkZXhjZXB0aW9uSGFuZGxlciwgJGF0dHIsICRlbGVtZW50LCAkcGFyc2UpIHsKICAgICAgICAgICAgdGhpcy4kdmlld1ZhbHVlID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy4kbW9kZWxWYWx1ZSA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuJHBhcnNlcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy4kZm9ybWF0dGVycyA9IFtdOwogICAgICAgICAgICB0aGlzLiR2aWV3Q2hhbmdlTGlzdGVuZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuJHByaXN0aW5lID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy4kZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy4kdmFsaWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLiRpbnZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuJG5hbWUgPSAkYXR0ci5uYW1lOwoKICAgICAgICAgICAgdmFyIG5nTW9kZWxHZXQgPSAkcGFyc2UoJGF0dHIubmdNb2RlbCksCiAgICAgICAgICAgICAgICBuZ01vZGVsU2V0ID0gbmdNb2RlbEdldC5hc3NpZ247CgogICAgICAgICAgICBpZiAoIW5nTW9kZWxTZXQpIHsKICAgICAgICAgICAgICAgIHRocm93IG1pbkVycignbmdNb2RlbCcpKCdub25hc3NpZ24nLCAiRXhwcmVzc2lvbiAnezB9JyBpcyBub24tYXNzaWduYWJsZS4gRWxlbWVudDogezF9IiwKICAgICAgICAgICAgICAgICAgICAkYXR0ci5uZ01vZGVsLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRyZW5kZXIKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBDYWxsZWQgd2hlbiB0aGUgdmlldyBuZWVkcyB0byBiZSB1cGRhdGVkLiBJdCBpcyBleHBlY3RlZCB0aGF0IHRoZSB1c2VyIG9mIHRoZSBuZy1tb2RlbAogICAgICAgICAgICAgKiBkaXJlY3RpdmUgd2lsbCBpbXBsZW1lbnQgdGhpcyBtZXRob2QuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB0aGlzLiRyZW5kZXIgPSBub29wOwoKICAgICAgICAgICAgdmFyIHBhcmVudEZvcm0gPSAkZWxlbWVudC5pbmhlcml0ZWREYXRhKCckZm9ybUNvbnRyb2xsZXInKSB8fCBudWxsRm9ybUN0cmwsCiAgICAgICAgICAgICAgICBpbnZhbGlkQ291bnQgPSAwLCAvLyB1c2VkIHRvIGVhc2lseSBkZXRlcm1pbmUgaWYgd2UgYXJlIHZhbGlkCiAgICAgICAgICAgICAgICAkZXJyb3IgPSB0aGlzLiRlcnJvciA9IHt9OyAvLyBrZWVwIGludmFsaWQga2V5cyBoZXJlCgoKICAgICAgICAgICAgLy8gU2V0dXAgaW5pdGlhbCBzdGF0ZSBvZiB0aGUgY29udHJvbAogICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhQUklTVElORV9DTEFTUyk7CiAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwoKICAgICAgICAgICAgLy8gY29udmVuaWVuY2UgbWV0aG9kIGZvciBlYXN5IHRvZ2dsaW5nIG9mIGNsYXNzZXMKICAgICAgICAgICAgZnVuY3Rpb24gdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KSB7CiAgICAgICAgICAgICAgICB2YWxpZGF0aW9uRXJyb3JLZXkgPSB2YWxpZGF0aW9uRXJyb3JLZXkgPyAnLScgKyBzbmFrZV9jYXNlKHZhbGlkYXRpb25FcnJvcktleSwgJy0nKSA6ICcnOwogICAgICAgICAgICAgICAgJGVsZW1lbnQuCiAgICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKChpc1ZhbGlkID8gSU5WQUxJRF9DTEFTUyA6IFZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSkuCiAgICAgICAgICAgICAgICAgIGFkZENsYXNzKChpc1ZhbGlkID8gVkFMSURfQ0xBU1MgOiBJTlZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogQ2hhbmdlIHRoZSB2YWxpZGl0eSBzdGF0ZSwgYW5kIG5vdGlmaWVzIHRoZSBmb3JtIHdoZW4gdGhlIGNvbnRyb2wgY2hhbmdlcyB2YWxpZGl0eS4gKGkuZS4gaXQKICAgICAgICAgICAgICogZG9lcyBub3Qgbm90aWZ5IGZvcm0gaWYgZ2l2ZW4gdmFsaWRhdG9yIGlzIGFscmVhZHkgbWFya2VkIGFzIGludmFsaWQpLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGJ5IHZhbGlkYXRvcnMgLSBpLmUuIHRoZSBwYXJzZXIgb3IgZm9ybWF0dGVyIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbGlkYXRpb25FcnJvcktleSBOYW1lIG9mIHRoZSB2YWxpZGF0b3IuIHRoZSBgdmFsaWRhdGlvbkVycm9yS2V5YCB3aWxsIGFzc2lnbgogICAgICAgICAgICAgKiAgICAgICAgdG8gYCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldPWlzVmFsaWRgIHNvIHRoYXQgaXQgaXMgYXZhaWxhYmxlIGZvciBkYXRhLWJpbmRpbmcuCiAgICAgICAgICAgICAqICAgICAgICBUaGUgYHZhbGlkYXRpb25FcnJvcktleWAgc2hvdWxkIGJlIGluIGNhbWVsQ2FzZSBhbmQgd2lsbCBnZXQgY29udmVydGVkIGludG8gZGFzaC1jYXNlCiAgICAgICAgICAgICAqICAgICAgICBmb3IgY2xhc3MgbmFtZS4gRXhhbXBsZTogYG15RXJyb3JgIHdpbGwgcmVzdWx0IGluIGBuZy12YWxpZC1teS1lcnJvcmAgYW5kIGBuZy1pbnZhbGlkLW15LWVycm9yYAogICAgICAgICAgICAgKiAgICAgICAgY2xhc3MgYW5kIGNhbiBiZSBib3VuZCB0byBhcyAgYHt7c29tZUZvcm0uc29tZUNvbnRyb2wuJGVycm9yLm15RXJyb3J9fWAgLgogICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzVmFsaWQgV2hldGhlciB0aGUgY3VycmVudCBzdGF0ZSBpcyB2YWxpZCAodHJ1ZSkgb3IgaW52YWxpZCAoZmFsc2UpLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbiAodmFsaWRhdGlvbkVycm9yS2V5LCBpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0gPT09ICFpc1ZhbGlkKSByZXR1cm47CgogICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0pIGludmFsaWRDb3VudC0tOwogICAgICAgICAgICAgICAgICAgIGlmICghaW52YWxpZENvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiR2YWxpZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGludmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRpbnZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiR2YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCsrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldID0gIWlzVmFsaWQ7CiAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpOwoKICAgICAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25FcnJvcktleSwgaXNWYWxpZCwgdGhpcyk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRQcmlzdGluZQogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNldHMgdGhlIGNvbnRyb2wgdG8gaXRzIHByaXN0aW5lIHN0YXRlLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIHJlbW92ZSB0aGUgJ25nLWRpcnR5JyBjbGFzcyBhbmQgc2V0IHRoZSBjb250cm9sIHRvIGl0cyBwcmlzdGluZQogICAgICAgICAgICAgKiBzdGF0ZSAobmctcHJpc3RpbmUgY2xhc3MpLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0UHJpc3RpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRkaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy4kcHJpc3RpbmUgPSB0cnVlOwogICAgICAgICAgICAgICAgJGVsZW1lbnQucmVtb3ZlQ2xhc3MoRElSVFlfQ0xBU1MpLmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZpZXdWYWx1ZQogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFJlYWQgYSB2YWx1ZSBmcm9tIHZpZXcuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRoaXMgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgZnJvbSB3aXRoaW4gYSBET00gZXZlbnQgaGFuZGxlci4KICAgICAgICAgICAgICogRm9yIGV4YW1wbGUge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dH0gb3IKICAgICAgICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpzZWxlY3Qgc2VsZWN0fSBkaXJlY3RpdmVzIGNhbGwgaXQuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEl0IGludGVybmFsbHkgY2FsbHMgYWxsIGAkcGFyc2Vyc2AgKGluY2x1ZGluZyB2YWxpZGF0b3JzKSBhbmQgdXBkYXRlcyB0aGUgYCRtb2RlbFZhbHVlYCBhbmQgdGhlIGFjdHVhbCBtb2RlbCBwYXRoLgogICAgICAgICAgICAgKiBMYXN0bHkgaXQgY2FsbHMgYWxsIHJlZ2lzdGVyZWQgY2hhbmdlIGxpc3RlbmVycy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIFZhbHVlIGZyb20gdGhlIHZpZXcuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB0aGlzLiRzZXRWaWV3VmFsdWUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHZpZXdWYWx1ZSA9IHZhbHVlOwoKICAgICAgICAgICAgICAgIC8vIGNoYW5nZSB0byBkaXJ0eQogICAgICAgICAgICAgICAgaWYgKHRoaXMuJHByaXN0aW5lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJHByaXN0aW5lID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQucmVtb3ZlQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpLmFkZENsYXNzKERJUlRZX0NMQVNTKTsKICAgICAgICAgICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvckVhY2godGhpcy4kcGFyc2VycywgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmbih2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy4kbW9kZWxWYWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRtb2RlbFZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbFNldCgkc2NvcGUsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHRoaXMuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMsIGZ1bmN0aW9uIChsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gbW9kZWwgLT4gdmFsdWUKICAgICAgICAgICAgdmFyIGN0cmwgPSB0aGlzOwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbiBuZ01vZGVsV2F0Y2goKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBuZ01vZGVsR2V0KCRzY29wZSk7CgogICAgICAgICAgICAgICAgLy8gaWYgc2NvcGUgbW9kZWwgdmFsdWUgYW5kIG5nTW9kZWwgdmFsdWUgYXJlIG91dCBvZiBzeW5jCiAgICAgICAgICAgICAgICBpZiAoY3RybC4kbW9kZWxWYWx1ZSAhPT0gdmFsdWUpIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGZvcm1hdHRlcnMgPSBjdHJsLiRmb3JtYXR0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICBpZHggPSBmb3JtYXR0ZXJzLmxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgY3RybC4kbW9kZWxWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIHdoaWxlIChpZHgtLSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGZvcm1hdHRlcnNbaWR4XSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoY3RybC4kdmlld1ZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiR2aWV3VmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kcmVuZGVyKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9XTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb2RlbAogICAgICoKICAgICAqIEBlbGVtZW50IGlucHV0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBJcyBhIGRpcmVjdGl2ZSB0aGF0IHRlbGxzIEFuZ3VsYXIgdG8gZG8gdHdvLXdheSBkYXRhIGJpbmRpbmcuIEl0IHdvcmtzIHRvZ2V0aGVyIHdpdGggYGlucHV0YCwKICAgICAqIGBzZWxlY3RgLCBgdGV4dGFyZWFgIGFuZCBldmVuIGN1c3RvbSBmb3JtIGNvbnRyb2xzIHRoYXQgdXNlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICogTmdNb2RlbENvbnRyb2xsZXJ9IGV4cG9zZWQgYnkgdGhpcyBkaXJlY3RpdmUuCiAgICAgKgogICAgICogYG5nTW9kZWxgIGlzIHJlc3BvbnNpYmxlIGZvcjoKICAgICAqCiAgICAgKiAtIGJpbmRpbmcgdGhlIHZpZXcgaW50byB0aGUgbW9kZWwsIHdoaWNoIG90aGVyIGRpcmVjdGl2ZXMgc3VjaCBhcyBgaW5wdXRgLCBgdGV4dGFyZWFgIG9yIGBzZWxlY3RgCiAgICAgKiAgIHJlcXVpcmUsCiAgICAgKiAtIHByb3ZpZGluZyB2YWxpZGF0aW9uIGJlaGF2aW9yIChpLmUuIHJlcXVpcmVkLCBudW1iZXIsIGVtYWlsLCB1cmwpLAogICAgICogLSBrZWVwaW5nIHN0YXRlIG9mIHRoZSBjb250cm9sICh2YWxpZC9pbnZhbGlkLCBkaXJ0eS9wcmlzdGluZSwgdmFsaWRhdGlvbiBlcnJvcnMpLAogICAgICogLSBzZXR0aW5nIHJlbGF0ZWQgY3NzIGNsYXNzIG9udG8gdGhlIGVsZW1lbnQgKGBuZy12YWxpZGAsIGBuZy1pbnZhbGlkYCwgYG5nLWRpcnR5YCwgYG5nLXByaXN0aW5lYCksCiAgICAgKiAtIHJlZ2lzdGVyIHRoZSBjb250cm9sIHdpdGggcGFyZW50IHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBmb3JtfS4KICAgICAqCiAgICAgKiBOb3RlOiBgbmdNb2RlbGAgd2lsbCB0cnkgdG8gYmluZCB0byB0aGUgcHJvcGVydHkgZ2l2ZW4gYnkgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbiBvbiB0aGUKICAgICAqIGN1cnJlbnQgc2NvcGUuIElmIHRoZSBwcm9wZXJ0eSBkb2Vzbid0IGFscmVhZHkgZXhpc3Qgb24gdGhpcyBzY29wZSwgaXQgd2lsbCBiZSBjcmVhdGVkCiAgICAgKiBpbXBsaWNpdGx5IGFuZCBhZGRlZCB0byB0aGUgc2NvcGUuCiAgICAgKgogICAgICogRm9yIGJhc2ljIGV4YW1wbGVzLCBob3cgdG8gdXNlIGBuZ01vZGVsYCwgc2VlOgogICAgICoKICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXR9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQudGV4dCB0ZXh0fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LmNoZWNrYm94IGNoZWNrYm94fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LnJhZGlvIHJhZGlvfQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0Lm51bWJlciBudW1iZXJ9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQuZW1haWwgZW1haWx9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQudXJsIHVybH0KICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0KICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6dGV4dGFyZWEgdGV4dGFyZWF9CiAgICAgKgogICAgICovCiAgICB2YXIgbmdNb2RlbERpcmVjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXF1aXJlOiBbJ25nTW9kZWwnLCAnXj9mb3JtJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IE5nTW9kZWxDb250cm9sbGVyLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmxzKSB7CiAgICAgICAgICAgICAgICAvLyBub3RpZnkgb3RoZXJzLCBlc3BlY2lhbGx5IHBhcmVudCBmb3JtcwoKICAgICAgICAgICAgICAgIHZhciBtb2RlbEN0cmwgPSBjdHJsc1swXSwKICAgICAgICAgICAgICAgICAgICBmb3JtQ3RybCA9IGN0cmxzWzFdIHx8IG51bGxGb3JtQ3RybDsKCiAgICAgICAgICAgICAgICBmb3JtQ3RybC4kYWRkQ29udHJvbChtb2RlbEN0cmwpOwoKICAgICAgICAgICAgICAgIGVsZW1lbnQub24oJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGZvcm1DdHJsLiRyZW1vdmVDb250cm9sKG1vZGVsQ3RybCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NoYW5nZQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEV2YWx1YXRlIGdpdmVuIGV4cHJlc3Npb24gd2hlbiB1c2VyIGNoYW5nZXMgdGhlIGlucHV0LgogICAgICogVGhlIGV4cHJlc3Npb24gaXMgbm90IGV2YWx1YXRlZCB3aGVuIHRoZSB2YWx1ZSBjaGFuZ2UgaXMgY29taW5nIGZyb20gdGhlIG1vZGVsLgogICAgICoKICAgICAqIE5vdGUsIHRoaXMgZGlyZWN0aXZlIHJlcXVpcmVzIGBuZ01vZGVsYCB0byBiZSBwcmVzZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IGlucHV0CiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxkb2M6ZXhhbXBsZT4KICAgICAqICAgPGRvYzpzb3VyY2U+CiAgICAgKiAgICAgPHNjcmlwdD4KICAgICAqICAgICAgIGZ1bmN0aW9uIENvbnRyb2xsZXIoJHNjb3BlKSB7CiAgICAgKiAgICAgICAgICRzY29wZS5jb3VudGVyID0gMDsKICAgICAqICAgICAgICAgJHNjb3BlLmNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICogICAgICAgICAgICRzY29wZS5jb3VudGVyKys7CiAgICAgKiAgICAgICAgIH07CiAgICAgKiAgICAgICB9CiAgICAgKiAgICAgPC9zY3JpcHQ+CiAgICAgKiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDb250cm9sbGVyIj4KICAgICAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgbmctY2hhbmdlPSJjaGFuZ2UoKSIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMSIgLz4KICAgICAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMiIgLz4KICAgICAqICAgICAgIDxsYWJlbCBmb3I9Im5nLWNoYW5nZS1leGFtcGxlMiI+Q29uZmlybWVkPC9sYWJlbD48YnIgLz4KICAgICAqICAgICAgIGRlYnVnID0ge3tjb25maXJtZWR9fTxiciAvPgogICAgICogICAgICAgY291bnRlciA9IHt7Y291bnRlcn19CiAgICAgKiAgICAgPC9kaXY+CiAgICAgKiAgIDwvZG9jOnNvdXJjZT4KICAgICAqICAgPGRvYzpzY2VuYXJpbz4KICAgICAqICAgICBpdCgnc2hvdWxkIGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gdmlldycsIGZ1bmN0aW9uKCkgewogICAgICogICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50ZXInKSkudG9FcXVhbCgnMCcpOwogICAgICogICAgICAgZWxlbWVudCgnI25nLWNoYW5nZS1leGFtcGxlMScpLmNsaWNrKCk7CiAgICAgKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcxJyk7CiAgICAgKiAgICAgICBleHBlY3QoYmluZGluZygnY29uZmlybWVkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAqICAgICB9KTsKICAgICAqCiAgICAgKiAgICAgaXQoJ3Nob3VsZCBub3QgZXZhbHVhdGUgdGhlIGV4cHJlc3Npb24gaWYgY2hhbmdpbmcgZnJvbSBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICogICAgICAgZWxlbWVudCgnI25nLWNoYW5nZS1leGFtcGxlMicpLmNsaWNrKCk7CiAgICAgKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcwJyk7CiAgICAgKiAgICAgICBleHBlY3QoYmluZGluZygnY29uZmlybWVkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAqICAgICB9KTsKICAgICAqICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgKiA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDaGFuZ2VEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICAgICAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgIGN0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kZXZhbChhdHRyLm5nQ2hhbmdlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CgoKICAgIHZhciByZXF1aXJlZERpcmVjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsbSwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgaWYgKCFjdHJsKSByZXR1cm47CiAgICAgICAgICAgICAgICBhdHRyLnJlcXVpcmVkID0gdHJ1ZTsgLy8gZm9yY2UgdHJ1dGh5IGluIGNhc2Ugd2UgYXJlIG9uIG5vbiBpbnB1dCBlbGVtZW50CgogICAgICAgICAgICAgICAgdmFyIHZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChhdHRyLnJlcXVpcmVkICYmIChpc0VtcHR5KHZhbHVlKSB8fCB2YWx1ZSA9PT0gZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2godmFsaWRhdG9yKTsKICAgICAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMudW5zaGlmdCh2YWxpZGF0b3IpOwoKICAgICAgICAgICAgICAgIGF0dHIuJG9ic2VydmUoJ3JlcXVpcmVkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRvcihjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdMaXN0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUZXh0IGlucHV0IHRoYXQgY29udmVydHMgYmV0d2VlbiBjb21tYS1zZXBhcmF0ZWQgc3RyaW5nIGludG8gYW4gYXJyYXkgb2Ygc3RyaW5ncy4KICAgICAqCiAgICAgKiBAZWxlbWVudCBpbnB1dAogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0xpc3Qgb3B0aW9uYWwgZGVsaW1pdGVyIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gc3BsaXQgdGhlIHZhbHVlLiBJZgogICAgICogICBzcGVjaWZpZWQgaW4gZm9ybSBgL3NvbWV0aGluZy9gIHRoZW4gdGhlIHZhbHVlIHdpbGwgYmUgY29udmVydGVkIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLm5hbWVzID0gWydpZ29yJywgJ21pc2tvJywgJ3ZvanRhJ107CiAgICAgICAgICAgICB9CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIExpc3Q6IDxpbnB1dCBuYW1lPSJuYW1lc0lucHV0IiBuZy1tb2RlbD0ibmFtZXMiIG5nLWxpc3QgcmVxdWlyZWQ+CiAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5uYW1lc0lucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICAgIDxicj4KICAgICAgICAgICAgIDx0dD5uYW1lcyA9IHt7bmFtZXN9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgICAgPHR0Pm15Rm9ybS5uYW1lc0lucHV0LiRlcnJvciA9IHt7bXlGb3JtLm5hbWVzSW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbmFtZXMnKSkudG9FcXVhbCgnWyJpZ29yIiwibWlza28iLCJ2b2p0YSJdJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJ3NwYW4uZXJyb3InKS5jc3MoJ2Rpc3BsYXknKSkudG9CZSgnbm9uZScpOwogICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpbnB1dCgnbmFtZXMnKS5lbnRlcignJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ25hbWVzJykpLnRvRXF1YWwoJ1tdJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCdzcGFuLmVycm9yJykuY3NzKCdkaXNwbGF5JykpLm5vdCgpLnRvQmUoJ25vbmUnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdMaXN0RGlyZWN0aXZlID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlcXVpcmU6ICduZ01vZGVsJywKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSAvXC8oLiopXC8vLmV4ZWMoYXR0ci5uZ0xpc3QpLAogICAgICAgICAgICAgICAgICAgIHNlcGFyYXRvciA9IG1hdGNoICYmIG5ldyBSZWdFeHAobWF0Y2hbMV0pIHx8IGF0dHIubmdMaXN0IHx8ICcsJzsKCiAgICAgICAgICAgICAgICB2YXIgcGFyc2UgPSBmdW5jdGlvbiAodmlld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpc3QgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHZpZXdWYWx1ZS5zcGxpdChzZXBhcmF0b3IpLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgbGlzdC5wdXNoKHRyaW0odmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKHBhcnNlKTsKICAgICAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLmpvaW4oJywgJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKCgogICAgdmFyIENPTlNUQU5UX1ZBTFVFX1JFR0VYUCA9IC9eKHRydWV8ZmFsc2V8XGQrKSQvOwoKICAgIHZhciBuZ1ZhbHVlRGlyZWN0aXZlID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICh0cGwsIHRwbEF0dHIpIHsKICAgICAgICAgICAgICAgIGlmIChDT05TVEFOVF9WQUxVRV9SRUdFWFAudGVzdCh0cGxBdHRyLm5nVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxtLCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBzY29wZS4kZXZhbChhdHRyLm5nVmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbG0sIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdWYWx1ZSwgZnVuY3Rpb24gdmFsdWVXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0JpbmRgIGF0dHJpYnV0ZSB0ZWxscyBBbmd1bGFyIHRvIHJlcGxhY2UgdGhlIHRleHQgY29udGVudCBvZiB0aGUgc3BlY2lmaWVkIEhUTUwgZWxlbWVudAogICAgICogd2l0aCB0aGUgdmFsdWUgb2YgYSBnaXZlbiBleHByZXNzaW9uLCBhbmQgdG8gdXBkYXRlIHRoZSB0ZXh0IGNvbnRlbnQgd2hlbiB0aGUgdmFsdWUgb2YgdGhhdAogICAgICogZXhwcmVzc2lvbiBjaGFuZ2VzLgogICAgICoKICAgICAqIFR5cGljYWxseSwgeW91IGRvbid0IHVzZSBgbmdCaW5kYCBkaXJlY3RseSwgYnV0IGluc3RlYWQgeW91IHVzZSB0aGUgZG91YmxlIGN1cmx5IG1hcmt1cCBsaWtlCiAgICAgKiBge3sgZXhwcmVzc2lvbiB9fWAgd2hpY2ggaXMgc2ltaWxhciBidXQgbGVzcyB2ZXJib3NlLgogICAgICoKICAgICAqIEl0IGlzIHByZWZlcnJhYmxlIHRvIHVzZSBgbmdCaW5kYCBpbnN0ZWFkIG9mIGB7eyBleHByZXNzaW9uIH19YCB3aGVuIGEgdGVtcGxhdGUgaXMgbW9tZW50YXJpbHkgCiAgICAgKiBkaXNwbGF5ZWQgYnkgdGhlIGJyb3dzZXIgaW4gaXRzIHJhdyBzdGF0ZSBiZWZvcmUgQW5ndWxhciBjb21waWxlcyBpdC4gU2luY2UgYG5nQmluZGAgaXMgYW4gCiAgICAgKiBlbGVtZW50IGF0dHJpYnV0ZSwgaXQgbWFrZXMgdGhlIGJpbmRpbmdzIGludmlzaWJsZSB0byB0aGUgdXNlciB3aGlsZSB0aGUgcGFnZSBpcyBsb2FkaW5nLgogICAgICoKICAgICAqIEFuIGFsdGVybmF0aXZlIHNvbHV0aW9uIHRvIHRoaXMgcHJvYmxlbSB3b3VsZCBiZSB1c2luZyB0aGUKICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbG9hayBuZ0Nsb2FrfSBkaXJlY3RpdmUuCiAgICAgKgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0JpbmQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEVudGVyIGEgbmFtZSBpbiB0aGUgTGl2ZSBQcmV2aWV3IHRleHQgYm94OyB0aGUgZ3JlZXRpbmcgYmVsb3cgdGhlIHRleHQgYm94IGNoYW5nZXMgaW5zdGFudGx5LgogICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAnV2hpcmxlZCc7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIEVudGVyIG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSI+PGJyPgogICAgICAgICAgICAgSGVsbG8gPHNwYW4gbmctYmluZD0ibmFtZSI+PC9zcGFuPiEKICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkudG9CZSgnV2hpcmxlZCcpOwogICAgICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ25hbWUnKS5lbnRlcignd29ybGQnKTsKICAgICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCduYW1lJykpLnRvQmUoJ3dvcmxkJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQmluZERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kKTsKICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ0JpbmQsIGZ1bmN0aW9uIG5nQmluZFdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGVsZW1lbnQudGV4dCh2YWx1ZSA9PSB1bmRlZmluZWQgPyAnJyA6IHZhbHVlKTsKICAgICAgICB9KTsKICAgIH0pOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0JpbmRUZW1wbGF0ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0JpbmRUZW1wbGF0ZWAgZGlyZWN0aXZlIHNwZWNpZmllcyB0aGF0IHRoZSBlbGVtZW50CiAgICAgKiB0ZXh0IGNvbnRlbnQgc2hvdWxkIGJlIHJlcGxhY2VkIHdpdGggdGhlIGludGVycG9sYXRpb24gb2YgdGhlIHRlbXBsYXRlCiAgICAgKiBpbiB0aGUgYG5nQmluZFRlbXBsYXRlYCBhdHRyaWJ1dGUuCiAgICAgKiBVbmxpa2UgYG5nQmluZGAsIHRoZSBgbmdCaW5kVGVtcGxhdGVgIGNhbiBjb250YWluIG11bHRpcGxlIGB7e2AgYH19YAogICAgICogZXhwcmVzc2lvbnMuIFRoaXMgZGlyZWN0aXZlIGlzIG5lZWRlZCBzaW5jZSBzb21lIEhUTUwgZWxlbWVudHMKICAgICAqIChzdWNoIGFzIFRJVExFIGFuZCBPUFRJT04pIGNhbm5vdCBjb250YWluIFNQQU4gZWxlbWVudHMuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdCaW5kVGVtcGxhdGUgdGVtcGxhdGUgb2YgZm9ybQogICAgICogICA8dHQ+e3s8L3R0PiA8dHQ+ZXhwcmVzc2lvbjwvdHQ+IDx0dD59fTwvdHQ+IHRvIGV2YWwuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRyeSBpdCBoZXJlOiBlbnRlciB0ZXh0IGluIHRleHQgYm94IGFuZCB3YXRjaCB0aGUgZ3JlZXRpbmcgY2hhbmdlLgogICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLnNhbHV0YXRpb24gPSAnSGVsbG8nOwogICAgICAgICAgICAgICAkc2NvcGUubmFtZSA9ICdXb3JsZCc7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgU2FsdXRhdGlvbjogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzYWx1dGF0aW9uIj48YnI+CiAgICAgICAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSI+PGJyPgogICAgICAgICAgICA8cHJlIG5nLWJpbmQtdGVtcGxhdGU9Int7c2FsdXRhdGlvbn19IHt7bmFtZX19ISI+PC9wcmU+CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCdzYWx1dGF0aW9uJykpLgogICAgICAgICAgICAgICB0b0JlKCdIZWxsbycpOwogICAgICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkuCiAgICAgICAgICAgICAgIHRvQmUoJ1dvcmxkJyk7CiAgICAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnc2FsdXRhdGlvbicpLmVudGVyKCdHcmVldGluZ3MnKTsKICAgICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCduYW1lJykuZW50ZXIoJ3VzZXInKTsKICAgICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCdzYWx1dGF0aW9uJykpLgogICAgICAgICAgICAgICB0b0JlKCdHcmVldGluZ3MnKTsKICAgICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCduYW1lJykpLgogICAgICAgICAgICAgICB0b0JlKCd1c2VyJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlID0gWyckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbiAoJGludGVycG9sYXRlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gc2NlbmFyaW8gcnVubmVyCiAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLm5nQmluZFRlbXBsYXRlKSk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGludGVycG9sYXRlRm4pOwogICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCduZ0JpbmRUZW1wbGF0ZScsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfV07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZEh0bWwKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBiaW5kaW5nIHRoYXQgd2lsbCBpbm5lckhUTUwgdGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBgZXhwcmVzc2lvbmAgaW50byB0aGUgY3VycmVudAogICAgICogZWxlbWVudCBpbiBhIHNlY3VyZSB3YXkuICBCeSBkZWZhdWx0LCB0aGUgaW5uZXJIVE1MLWVkIGNvbnRlbnQgd2lsbCBiZSBzYW5pdGl6ZWQgdXNpbmcgdGhlIHtAbGluawogICAgICogbmdTYW5pdGl6ZS4kc2FuaXRpemUgJHNhbml0aXplfSBzZXJ2aWNlLiAgVG8gdXRpbGl6ZSB0aGlzIGZ1bmN0aW9uYWxpdHksIGVuc3VyZSB0aGF0IGAkc2FuaXRpemVgCiAgICAgKiBpcyBhdmFpbGFibGUsIGZvciBleGFtcGxlLCBieSBpbmNsdWRpbmcge0BsaW5rIG5nU2FuaXRpemV9IGluIHlvdXIgbW9kdWxlJ3MgZGVwZW5kZW5jaWVzIChub3QgaW4KICAgICAqIGNvcmUgQW5ndWxhci4pICBZb3UgbWF5IGFsc28gYnlwYXNzIHNhbml0aXphdGlvbiBmb3IgdmFsdWVzIHlvdSBrbm93IGFyZSBzYWZlLiBUbyBkbyBzbywgYmluZCB0bwogICAgICogYW4gZXhwbGljaXRseSB0cnVzdGVkIHZhbHVlIHZpYSB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzSHRtbCAkc2NlLnRydXN0QXNIdG1sfS4gIFNlZSB0aGUgZXhhbXBsZQogICAgICogdW5kZXIge0BsaW5rIG5nLiRzY2UjRXhhbXBsZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0uCiAgICAgKgogICAgICogTm90ZTogSWYgYSBgJHNhbml0aXplYCBzZXJ2aWNlIGlzIHVuYXZhaWxhYmxlIGFuZCB0aGUgYm91bmQgdmFsdWUgaXNuJ3QgZXhwbGljaXRseSB0cnVzdGVkLCB5b3UKICAgICAqIHdpbGwgaGF2ZSBhbiBleGNlcHRpb24gKGluc3RlYWQgb2YgYW4gZXhwbG9pdC4pCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZEh0bWwge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUuCiAgICAgKi8KICAgIHZhciBuZ0JpbmRIdG1sRGlyZWN0aXZlID0gWyckc2NlJywgZnVuY3Rpb24gKCRzY2UpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kSHRtbCk7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZEh0bWwsIGZ1bmN0aW9uIG5nQmluZEh0bWxXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKCRzY2UuZ2V0VHJ1c3RlZEh0bWwodmFsdWUpIHx8ICcnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH1dOwoKICAgIGZ1bmN0aW9uIGNsYXNzRGlyZWN0aXZlKG5hbWUsIHNlbGVjdG9yKSB7CiAgICAgICAgbmFtZSA9ICduZ0NsYXNzJyArIG5hbWU7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnQUMnLAogICAgICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9sZFZhbCA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJbbmFtZV0sIG5nQ2xhc3NXYXRjaEFjdGlvbiwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgIGF0dHIuJG9ic2VydmUoJ2NsYXNzJywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2xhc3NXYXRjaEFjdGlvbihzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgoKICAgICAgICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gJ25nQ2xhc3MnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgnJGluZGV4JywgZnVuY3Rpb24gKCRpbmRleCwgb2xkJGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kID0gJGluZGV4ICYgMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2QgIT09IG9sZCRpbmRleCAmIDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kID09PSBzZWxlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3Moc2NvcGUuJGV2YWwoYXR0cltuYW1lXSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gbmdDbGFzc1dhdGNoQWN0aW9uKG5ld1ZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0b3IgPT09IHRydWUgfHwgc2NvcGUuJGluZGV4ICUgMiA9PT0gc2VsZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWwgJiYgIWVxdWFscyhuZXdWYWwsIG9sZFZhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhvbGRWYWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkQ2xhc3MobmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBvbGRWYWwgPSBjb3B5KG5ld1ZhbCk7CiAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlQ2xhc3MoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kcmVtb3ZlQ2xhc3MoZmxhdHRlbkNsYXNzZXMoY2xhc3NWYWwpKTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGRDbGFzcyhjbGFzc1ZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRhZGRDbGFzcyhmbGF0dGVuQ2xhc3NlcyhjbGFzc1ZhbCkpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZmxhdHRlbkNsYXNzZXMoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoY2xhc3NWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2xhc3NWYWwuam9pbignICcpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KGNsYXNzVmFsKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNsYXNzZXMgPSBbXSwgaSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGNsYXNzVmFsLCBmdW5jdGlvbiAodiwgaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzZXMucHVzaChrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjbGFzc2VzLmpvaW4oJyAnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsYXNzVmFsOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xhc3NgIGFsbG93cyB5b3UgdG8gc2V0IENTUyBjbGFzc2VzIG9uIEhUTUwgYW4gZWxlbWVudCwgZHluYW1pY2FsbHksIGJ5IGRhdGFiaW5kaW5nCiAgICAgKiBhbiBleHByZXNzaW9uIHRoYXQgcmVwcmVzZW50cyBhbGwgY2xhc3NlcyB0byBiZSBhZGRlZC4KICAgICAqCiAgICAgKiBUaGUgZGlyZWN0aXZlIHdvbid0IGFkZCBkdXBsaWNhdGUgY2xhc3NlcyBpZiBhIHBhcnRpY3VsYXIgY2xhc3Mgd2FzIGFscmVhZHkgc2V0LgogICAgICoKICAgICAqIFdoZW4gdGhlIGV4cHJlc3Npb24gY2hhbmdlcywgdGhlIHByZXZpb3VzbHkgYWRkZWQgY2xhc3NlcyBhcmUgcmVtb3ZlZCBhbmQgb25seSB0aGVuIHRoZQogICAgICogbmV3IGNsYXNzZXMgYXJlIGFkZGVkLgogICAgICoKICAgICAqIEBhbmltYXRpb25zCiAgICAgKiBhZGQgLSBoYXBwZW5zIGp1c3QgYmVmb3JlIHRoZSBjbGFzcyBpcyBhcHBsaWVkIHRvIHRoZSBlbGVtZW50CiAgICAgKiByZW1vdmUgLSBoYXBwZW5zIGp1c3QgYmVmb3JlIHRoZSBjbGFzcyBpcyByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUgcmVzdWx0CiAgICAgKiAgIG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzCiAgICAgKiAgIG5hbWVzLCBhbiBhcnJheSwgb3IgYSBtYXAgb2YgY2xhc3MgbmFtZXMgdG8gYm9vbGVhbiB2YWx1ZXMuIEluIHRoZSBjYXNlIG9mIGEgbWFwLCB0aGUKICAgICAqICAgbmFtZXMgb2YgdGhlIHByb3BlcnRpZXMgd2hvc2UgdmFsdWVzIGFyZSB0cnV0aHkgd2lsbCBiZSBhZGRlZCBhcyBjc3MgY2xhc3NlcyB0byB0aGUKICAgICAqICAgZWxlbWVudC4KICAgICAqCiAgICAgKiBAZXhhbXBsZSBFeGFtcGxlIHRoYXQgZGVtb3N0cmF0ZXMgYmFzaWMgYmluZGluZ3MgdmlhIG5nQ2xhc3MgZGlyZWN0aXZlLgogICAgICAgPGV4YW1wbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICAgIDxwIG5nLWNsYXNzPSJ7c3RyaWtlOiBzdHJpa2UsIGJvbGQ6IGJvbGQsIHJlZDogcmVkfSI+TWFwIFN5bnRheCBFeGFtcGxlPC9wPgogICAgICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImJvbGQiPiBib2xkCiAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ic3RyaWtlIj4gc3RyaWtlCiAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0icmVkIj4gcmVkCiAgICAgICAgICAgPGhyPgogICAgICAgICAgIDxwIG5nLWNsYXNzPSJzdHlsZSI+VXNpbmcgU3RyaW5nIFN5bnRheDwvcD4KICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InN0eWxlIiBwbGFjZWhvbGRlcj0iVHlwZTogYm9sZCBzdHJpa2UgcmVkIj4KICAgICAgICAgICA8aHI+CiAgICAgICAgICAgPHAgbmctY2xhc3M9IltzdHlsZTEsIHN0eWxlMiwgc3R5bGUzXSI+VXNpbmcgQXJyYXkgU3ludGF4PC9wPgogICAgICAgICAgIDxpbnB1dCBuZy1tb2RlbD0ic3R5bGUxIiBwbGFjZWhvbGRlcj0iVHlwZTogYm9sZCI+PGJyPgogICAgICAgICAgIDxpbnB1dCBuZy1tb2RlbD0ic3R5bGUyIiBwbGFjZWhvbGRlcj0iVHlwZTogc3RyaWtlIj48YnI+CiAgICAgICAgICAgPGlucHV0IG5nLW1vZGVsPSJzdHlsZTMiIHBsYWNlaG9sZGVyPSJUeXBlOiByZWQiPjxicj4KICAgICAgICAgPC9maWxlPgogICAgICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgICAgIC5zdHJpa2UgewogICAgICAgICAgICAgdGV4dC1kZWNvcmF0aW9uOiBsaW5lLXRocm91Z2g7CiAgICAgICAgICAgfQogICAgICAgICAgIC5ib2xkIHsKICAgICAgICAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgICAgICAgfQogICAgICAgICAgIC5yZWQgewogICAgICAgICAgICAgICBjb2xvcjogcmVkOwogICAgICAgICAgIH0KICAgICAgICAgPC9maWxlPgogICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBsZXQgeW91IHRvZ2dsZSB0aGUgY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgIAogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHA6Zmlyc3QnKS5wcm9wKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvYm9sZC8pOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHA6Zmlyc3QnKS5wcm9wKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvcmVkLyk7CiAgICAKICAgICAgICAgICAgIGlucHV0KCdib2xkJykuY2hlY2soKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBwOmZpcnN0JykucHJvcCgnY2xhc3NOYW1lJykpLnRvTWF0Y2goL2JvbGQvKTsKICAgIAogICAgICAgICAgICAgaW5wdXQoJ3JlZCcpLmNoZWNrKCk7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgcDpmaXJzdCcpLnByb3AoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9yZWQvKTsKICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgIGl0KCdzaG91bGQgbGV0IHlvdSB0b2dnbGUgc3RyaW5nIGV4YW1wbGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBwOm50aC1vZi10eXBlKDIpJykucHJvcCgnY2xhc3NOYW1lJykpLnRvQmUoJycpOwogICAgICAgICAgICAgaW5wdXQoJ3N0eWxlJykuZW50ZXIoJ3JlZCcpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHA6bnRoLW9mLXR5cGUoMiknKS5wcm9wKCdjbGFzc05hbWUnKSkudG9CZSgncmVkJyk7CiAgICAgICAgICAgfSk7CiAgICAKICAgICAgICAgICBpdCgnYXJyYXkgZXhhbXBsZSBzaG91bGQgaGF2ZSAzIGNsYXNzZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBwOmxhc3QnKS5wcm9wKCdjbGFzc05hbWUnKSkudG9CZSgnJyk7CiAgICAgICAgICAgICBpbnB1dCgnc3R5bGUxJykuZW50ZXIoJ2JvbGQnKTsKICAgICAgICAgICAgIGlucHV0KCdzdHlsZTInKS5lbnRlcignc3RyaWtlJyk7CiAgICAgICAgICAgICBpbnB1dCgnc3R5bGUzJykuZW50ZXIoJ3JlZCcpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHA6bGFzdCcpLnByb3AoJ2NsYXNzTmFtZScpKS50b0JlKCdib2xkIHN0cmlrZSByZWQnKTsKICAgICAgICAgICB9KTsKICAgICAgICAgPC9maWxlPgogICAgICAgPC9leGFtcGxlPgogICAgCiAgICAgICAjIyBBbmltYXRpb25zCiAgICAKICAgICAgIFRoZSBleGFtcGxlIGJlbG93IGRlbW9uc3RyYXRlcyBob3cgdG8gcGVyZm9ybSBhbmltYXRpb25zIHVzaW5nIG5nQ2xhc3MuCiAgICAKICAgICAgIDxleGFtcGxlIGFuaW1hdGlvbnM9InRydWUiPgogICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nLWNsaWNrPSJteVZhcj0nbXktY2xhc3MnIj4KICAgICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmctY2xpY2s9Im15VmFyPScnIj4KICAgICAgICAgIDxicj4KICAgICAgICAgIDxzcGFuIG5nLWNsYXNzPSJteVZhciI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgICAgICAgIDwvZmlsZT4KICAgICAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgICAgICAubXktY2xhc3MtYWRkLCAubXktY2xhc3MtcmVtb3ZlIHsKICAgICAgICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgICAgICAgLW1vei10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgICAtby10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgICB0cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgLm15LWNsYXNzLAogICAgICAgICAgIC5teS1jbGFzcy1hZGQubXktY2xhc3MtYWRkLWFjdGl2ZSB7CiAgICAgICAgICAgICBjb2xvcjogcmVkOwogICAgICAgICAgICAgZm9udC1zaXplOjNlbTsKICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAubXktY2xhc3MtcmVtb3ZlLm15LWNsYXNzLXJlbW92ZS1hY3RpdmUgewogICAgICAgICAgICAgZm9udC1zaXplOjEuMGVtOwogICAgICAgICAgICAgY29sb3I6YmxhY2s7CiAgICAgICAgICAgfQogICAgICAgICA8L2ZpbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsYXNzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS5ub3QoKS4KICAgICAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKICAgIAogICAgICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuZWxlbWVudCgnOmJ1dHRvbjpmaXJzdCcpLmNsaWNrKCk7CiAgICAKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwogICAgCiAgICAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCc6YnV0dG9uOmxhc3QnKS5jbGljaygpOwogICAgCiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS5ub3QoKS4KICAgICAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKICAgICAgICAgICB9KTsKICAgICAgICAgPC9maWxlPgogICAgICAgPC9leGFtcGxlPgogICAgCiAgICAKICAgICAgICMjIG5nQ2xhc3MgYW5kIHByZS1leGlzdGluZyBDU1MzIFRyYW5zaXRpb25zL0FuaW1hdGlvbnMKICAgICAgIFRoZSBuZ0NsYXNzIGRpcmVjdGl2ZSBzdGlsbCBzdXBwb3J0cyBDU1MzIFRyYW5zaXRpb25zL0FuaW1hdGlvbnMgZXZlbiBpZiB0aGV5IGRvIG5vdCBmb2xsb3cgdGhlIG5nQW5pbWF0ZSBDU1MgbmFtaW5nIHN0cnVjdHVyZS4KICAgICAgIFRoZXJlZm9yZSwgaWYgYW55IENTUzMgVHJhbnNpdGlvbi9BbmltYXRpb24gc3R5bGVzIChvdXRzaWRlIG9mIG5nQW5pbWF0ZSkgYXJlIHNldCBvbiB0aGUgZWxlbWVudCwgdGhlbiwgaWYgYSBuZ0NsYXNzIGFuaW1hdGlvbgogICAgICAgaXMgdHJpZ2dlcmVkLCB0aGUgbmdDbGFzcyBhbmltYXRpb24gd2lsbCBiZSBza2lwcGVkIHNvIHRoYXQgbmdBbmltYXRlIGNhbiBhbGxvdyBmb3IgdGhlIHByZS1leGlzdGluZyB0cmFuc2l0aW9uIG9yIGFuaW1hdGlvbiB0bwogICAgICAgdGFrZSBvdmVyLiBUaGlzIHJlc3RyaWN0aW9uIGFsbG93cyBmb3IgbmdDbGFzcyB0byBzdGlsbCB3b3JrIHdpdGggc3RhbmRhcmQgQ1NTMyBUcmFuc2l0aW9ucy9BbmltYXRpb25zIHRoYXQgYXJlIGRlZmluZWQKICAgICAgIG91dHNpZGUgb2YgbmdBbmltYXRlLgogICAgICovCiAgICB2YXIgbmdDbGFzc0RpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCcnLCB0cnVlKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzT2RkCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xhc3NPZGRgIGFuZCBgbmdDbGFzc0V2ZW5gIGRpcmVjdGl2ZXMgd29yayBleGFjdGx5IGFzCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xhc3MgbmdDbGFzc30sIGV4Y2VwdCBpdCB3b3JrcyBpbgogICAgICogY29uanVuY3Rpb24gd2l0aCBgbmdSZXBlYXRgIGFuZCB0YWtlcyBhZmZlY3Qgb25seSBvbiBvZGQgKGV2ZW4pIHJvd3MuCiAgICAgKgogICAgICogVGhpcyBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgb25seSB3aXRoaW4gYSBzY29wZSBvZiBhbgogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0uCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xhc3NPZGQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gVGhlIHJlc3VsdAogICAgICogICBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcyBuYW1lcyBvciBhbiBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICAgPGV4YW1wbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICAgICA8b2wgbmctaW5pdD0ibmFtZXM9WydKb2huJywgJ01hcnknLCAnQ2F0ZScsICdTdXonXSI+CiAgICAgICAgICAgICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgICAgICAgICAgIDxzcGFuIG5nLWNsYXNzLW9kZD0iJ29kZCciIG5nLWNsYXNzLWV2ZW49IidldmVuJyI+CiAgICAgICAgICAgICAgICAge3tuYW1lfX0KICAgICAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgICAgIDwvbGk+CiAgICAgICAgICAgIDwvb2w+CiAgICAgICAgIDwvZmlsZT4KICAgICAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgICAgICAub2RkIHsKICAgICAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICAgICAgfQogICAgICAgICAgIC5ldmVuIHsKICAgICAgICAgICAgIGNvbG9yOiBibHVlOwogICAgICAgICAgIH0KICAgICAgICAgPC9maWxlPgogICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGFzcy1vZGQgYW5kIG5nLWNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgICAgICB0b01hdGNoKC9vZGQvKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpsYXN0IHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgICAgIHRvTWF0Y2goL2V2ZW4vKTsKICAgICAgICAgICB9KTsKICAgICAgICAgPC9maWxlPgogICAgICAgPC9leGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDbGFzc09kZERpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCdPZGQnLCAwKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzRXZlbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0NsYXNzT2RkYCBhbmQgYG5nQ2xhc3NFdmVuYCBkaXJlY3RpdmVzIHdvcmsgZXhhY3RseSBhcwogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzIG5nQ2xhc3N9LCBleGNlcHQgaXQgd29ya3MgaW4KICAgICAqIGNvbmp1bmN0aW9uIHdpdGggYG5nUmVwZWF0YCBhbmQgdGFrZXMgYWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogICAgICoKICAgICAqIFRoaXMgZGlyZWN0aXZlIGNhbiBiZSBhcHBsaWVkIG9ubHkgd2l0aGluIGEgc2NvcGUgb2YgYW4KICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzRXZlbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUKICAgICAqICAgcmVzdWx0IG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzIG5hbWVzIG9yIGFuIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICA8ZXhhbXBsZT4KICAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICAgIDxvbCBuZy1pbml0PSJuYW1lcz1bJ0pvaG4nLCAnTWFyeScsICdDYXRlJywgJ1N1eiddIj4KICAgICAgICAgICAgICA8bGkgbmctcmVwZWF0PSJuYW1lIGluIG5hbWVzIj4KICAgICAgICAgICAgICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAgICAgICAgICAgICAgICB7e25hbWV9fSAmbmJzcDsgJm5ic3A7ICZuYnNwOwogICAgICAgICAgICAgICA8L3NwYW4+CiAgICAgICAgICAgICAgPC9saT4KICAgICAgICAgICAgPC9vbD4KICAgICAgICAgPC9maWxlPgogICAgICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgICAgIC5vZGQgewogICAgICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgICAgICB9CiAgICAgICAgICAgLmV2ZW4gewogICAgICAgICAgICAgY29sb3I6IGJsdWU7CiAgICAgICAgICAgfQogICAgICAgICA8L2ZpbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsYXNzLW9kZCBhbmQgbmctY2xhc3MtZXZlbicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0IHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3Qgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICAgICAgdG9NYXRjaCgvZXZlbi8pOwogICAgICAgICAgIH0pOwogICAgICAgICA8L2ZpbGU+CiAgICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCdFdmVuJywgMSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbG9hawogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgaXMgdXNlZCB0byBwcmV2ZW50IHRoZSBBbmd1bGFyIGh0bWwgdGVtcGxhdGUgZnJvbSBiZWluZyBicmllZmx5CiAgICAgKiBkaXNwbGF5ZWQgYnkgdGhlIGJyb3dzZXIgaW4gaXRzIHJhdyAodW5jb21waWxlZCkgZm9ybSB3aGlsZSB5b3VyIGFwcGxpY2F0aW9uIGlzIGxvYWRpbmcuIFVzZSB0aGlzCiAgICAgKiBkaXJlY3RpdmUgdG8gYXZvaWQgdGhlIHVuZGVzaXJhYmxlIGZsaWNrZXIgZWZmZWN0IGNhdXNlZCBieSB0aGUgaHRtbCB0ZW1wbGF0ZSBkaXNwbGF5LgogICAgICoKICAgICAqIFRoZSBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgdG8gdGhlIGA8Ym9keT5gIGVsZW1lbnQsIGJ1dCB0eXBpY2FsbHkgYSBmaW5lLWdyYWluZWQgYXBwbGljYXRpb24gaXMKICAgICAqIHByZWZlcnJlZCBpbiBvcmRlciB0byBiZW5lZml0IGZyb20gcHJvZ3Jlc3NpdmUgcmVuZGVyaW5nIG9mIHRoZSBicm93c2VyIHZpZXcuCiAgICAgKgogICAgICogYG5nQ2xvYWtgIHdvcmtzIGluIGNvb3BlcmF0aW9uIHdpdGggYSBjc3MgcnVsZSB0aGF0IGlzIGVtYmVkZGVkIHdpdGhpbiBgYW5ndWxhci5qc2AgYW5kCiAgICAgKiAgYGFuZ3VsYXIubWluLmpzYCBmaWxlcy4gRm9sbG93aW5nIGlzIHRoZSBjc3MgcnVsZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogW25nXDpjbG9ha10sIFtuZy1jbG9ha10sIFtkYXRhLW5nLWNsb2FrXSwgW3gtbmctY2xvYWtdLCAubmctY2xvYWssIC54LW5nLWNsb2FrIHsKICAgICAqICAgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OwogICAgICogfQogICAgICogPC9wcmU+CiAgICAgKgogICAgICogV2hlbiB0aGlzIGNzcyBydWxlIGlzIGxvYWRlZCBieSB0aGUgYnJvd3NlciwgYWxsIGh0bWwgZWxlbWVudHMgKGluY2x1ZGluZyB0aGVpciBjaGlsZHJlbikgdGhhdAogICAgICogYXJlIHRhZ2dlZCB3aXRoIHRoZSBgbmctY2xvYWtgIGRpcmVjdGl2ZSBhcmUgaGlkZGVuLiBXaGVuIEFuZ3VsYXIgY29tZXMgYWNyb3NzIHRoaXMgZGlyZWN0aXZlCiAgICAgKiBkdXJpbmcgdGhlIGNvbXBpbGF0aW9uIG9mIHRoZSB0ZW1wbGF0ZSBpdCBkZWxldGVzIHRoZSBgbmdDbG9ha2AgZWxlbWVudCBhdHRyaWJ1dGUsIHdoaWNoCiAgICAgKiBtYWtlcyB0aGUgY29tcGlsZWQgZWxlbWVudCB2aXNpYmxlLgogICAgICoKICAgICAqIEZvciB0aGUgYmVzdCByZXN1bHQsIGBhbmd1bGFyLmpzYCBzY3JpcHQgbXVzdCBiZSBsb2FkZWQgaW4gdGhlIGhlYWQgc2VjdGlvbiBvZiB0aGUgaHRtbCBmaWxlOwogICAgICogYWx0ZXJuYXRpdmVseSwgdGhlIGNzcyBydWxlIChhYm92ZSkgbXVzdCBiZSBpbmNsdWRlZCBpbiB0aGUgZXh0ZXJuYWwgc3R5bGVzaGVldCBvZiB0aGUKICAgICAqIGFwcGxpY2F0aW9uLgogICAgICoKICAgICAqIExlZ2FjeSBicm93c2VycywgbGlrZSBJRTcsIGRvIG5vdCBwcm92aWRlIGF0dHJpYnV0ZSBzZWxlY3RvciBzdXBwb3J0IChhZGRlZCBpbiBDU1MgMi4xKSBzbyB0aGV5CiAgICAgKiBjYW5ub3QgbWF0Y2ggdGhlIGBbbmdcOmNsb2FrXWAgc2VsZWN0b3IuIFRvIHdvcmsgYXJvdW5kIHRoaXMgbGltaXRhdGlvbiwgeW91IG11c3QgYWRkIHRoZSBjc3MKICAgICAqIGNsYXNzIGBuZ0Nsb2FrYCBpbiBhZGRpdGlvbiB0byBgbmdDbG9ha2AgZGlyZWN0aXZlIGFzIHNob3duIGluIHRoZSBleGFtcGxlIGJlbG93LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICA8ZGl2IGlkPSJ0ZW1wbGF0ZTEiIG5nLWNsb2FrPnt7ICdoZWxsbycgfX08L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0idGVtcGxhdGUyIiBuZy1jbG9hayBjbGFzcz0ibmctY2xvYWsiPnt7ICdoZWxsbyBJRTcnIH19PC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIHJlbW92ZSB0aGUgdGVtcGxhdGUgZGlyZWN0aXZlIGFuZCBjc3MgY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjdGVtcGxhdGUxJykuYXR0cignbmctY2xvYWsnKSkuCiAgICAgICAgICAgICAgIG5vdCgpLnRvQmVEZWZpbmVkKCk7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3RlbXBsYXRlMicpLmF0dHIoJ25nLWNsb2FrJykpLgogICAgICAgICAgICAgICBub3QoKS50b0JlRGVmaW5lZCgpOwogICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKgogICAgICovCiAgICB2YXIgbmdDbG9ha0RpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICBhdHRyLiRzZXQoJ25nQ2xvYWsnLCB1bmRlZmluZWQpOwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKCduZy1jbG9haycpOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ29udHJvbGxlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0NvbnRyb2xsZXJgIGRpcmVjdGl2ZSBhc3NpZ25zIGJlaGF2aW9yIHRvIGEgc2NvcGUuIFRoaXMgaXMgYSBrZXkgYXNwZWN0IG9mIGhvdyBhbmd1bGFyCiAgICAgKiBzdXBwb3J0cyB0aGUgcHJpbmNpcGxlcyBiZWhpbmQgdGhlIE1vZGVsLVZpZXctQ29udHJvbGxlciBkZXNpZ24gcGF0dGVybi4KICAgICAqCiAgICAgKiBNVkMgY29tcG9uZW50cyBpbiBhbmd1bGFyOgogICAgICoKICAgICAqICogTW9kZWwg4oCUIFRoZSBNb2RlbCBpcyBkYXRhIGluIHNjb3BlIHByb3BlcnRpZXM7IHNjb3BlcyBhcmUgYXR0YWNoZWQgdG8gdGhlIERPTS4KICAgICAqICogVmlldyDigJQgVGhlIHRlbXBsYXRlIChIVE1MIHdpdGggZGF0YSBiaW5kaW5ncykgaXMgcmVuZGVyZWQgaW50byB0aGUgVmlldy4KICAgICAqICogQ29udHJvbGxlciDigJQgVGhlIGBuZ0NvbnRyb2xsZXJgIGRpcmVjdGl2ZSBzcGVjaWZpZXMgYSBDb250cm9sbGVyIGNsYXNzOyB0aGUgY2xhc3MgaGFzCiAgICAgKiAgIG1ldGhvZHMgdGhhdCB0eXBpY2FsbHkgZXhwcmVzcyB0aGUgYnVzaW5lc3MgbG9naWMgYmVoaW5kIHRoZSBhcHBsaWNhdGlvbi4KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgYW4gYWx0ZXJuYXRpdmUgd2F5IHRvIGRlZmluZSBjb250cm9sbGVycyBpcyB2aWEgdGhlIHtAbGluayBuZ1JvdXRlLiRyb3V0ZSAkcm91dGV9IHNlcnZpY2UuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAc2NvcGUKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDb250cm9sbGVyIE5hbWUgb2YgYSBnbG9iYWxseSBhY2Nlc3NpYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIG9yIGFuCiAgICAgKiAgICAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gdGhhdCBvbiB0aGUgY3VycmVudCBzY29wZSBldmFsdWF0ZXMgdG8gYQogICAgICogICAgIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBUaGUgY29udHJvbGxlciBpbnN0YW5jZSBjYW4gZnVydGhlciBiZSBwdWJsaXNoZWQgaW50byB0aGUgc2NvcGUKICAgICAqICAgICBieSBhZGRpbmcgYGFzIGxvY2FsTmFtZWAgdGhlIGNvbnRyb2xsZXIgbmFtZSBhdHRyaWJ1dGUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEhlcmUgaXMgYSBzaW1wbGUgZm9ybSBmb3IgZWRpdGluZyB1c2VyIGNvbnRhY3QgaW5mb3JtYXRpb24uIEFkZGluZywgcmVtb3ZpbmcsIGNsZWFyaW5nLCBhbmQKICAgICAqIGdyZWV0aW5nIGFyZSBtZXRob2RzIGRlY2xhcmVkIG9uIHRoZSBjb250cm9sbGVyIChzZWUgc291cmNlIHRhYikuIFRoZXNlIG1ldGhvZHMgY2FuCiAgICAgKiBlYXNpbHkgYmUgY2FsbGVkIGZyb20gdGhlIGFuZ3VsYXIgbWFya3VwLiBOb3RpY2UgdGhhdCB0aGUgc2NvcGUgYmVjb21lcyB0aGUgYHRoaXNgIGZvciB0aGUKICAgICAqIGNvbnRyb2xsZXIncyBpbnN0YW5jZS4gVGhpcyBhbGxvd3MgZm9yIGVhc3kgYWNjZXNzIHRvIHRoZSB2aWV3IGRhdGEgZnJvbSB0aGUgY29udHJvbGxlci4gQWxzbwogICAgICogbm90aWNlIHRoYXQgYW55IGNoYW5nZXMgdG8gdGhlIGRhdGEgYXJlIGF1dG9tYXRpY2FsbHkgcmVmbGVjdGVkIGluIHRoZSBWaWV3IHdpdGhvdXQgdGhlIG5lZWQKICAgICAqIGZvciBhIG1hbnVhbCB1cGRhdGUuIFRoZSBleGFtcGxlIGlzIGluY2x1ZGVkIGluIHR3byBkaWZmZXJlbnQgZGVjbGFyYXRpb24gc3R5bGVzIGJhc2VkIG9uCiAgICAgKiB5b3VyIHN0eWxlIHByZWZlcmVuY2VzLgogICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgIGZ1bmN0aW9uIFNldHRpbmdzQ29udHJvbGxlcjEoKSB7CiAgICAgICAgICAgICAgdGhpcy5uYW1lID0gIkpvaG4gU21pdGgiOwogICAgICAgICAgICAgIHRoaXMuY29udGFjdHMgPSBbCiAgICAgICAgICAgICAgICB7dHlwZTogJ3Bob25lJywgdmFsdWU6ICc0MDggNTU1IDEyMTInfSwKICAgICAgICAgICAgICAgIHt0eXBlOiAnZW1haWwnLCB2YWx1ZTogJ2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnfSBdOwogICAgICAgICAgICAgIH07CiAgICAKICAgICAgICAgICAgU2V0dGluZ3NDb250cm9sbGVyMS5wcm90b3R5cGUuZ3JlZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBhbGVydCh0aGlzLm5hbWUpOwogICAgICAgICAgICB9OwogICAgCiAgICAgICAgICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aGlzLmNvbnRhY3RzLnB1c2goe3R5cGU6ICdlbWFpbCcsIHZhbHVlOiAneW91cm5hbWVAZXhhbXBsZS5vcmcnfSk7CiAgICAgICAgICAgIH07CiAgICAKICAgICAgICAgICAgU2V0dGluZ3NDb250cm9sbGVyMS5wcm90b3R5cGUucmVtb3ZlQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3RUb1JlbW92ZSkgewogICAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb250YWN0cy5pbmRleE9mKGNvbnRhY3RUb1JlbW92ZSk7CiAgICAgICAgICAgICAgdGhpcy5jb250YWN0cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICB9OwogICAgCiAgICAgICAgICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICAgICAgICAgICAgICBjb250YWN0LnR5cGUgPSAncGhvbmUnOwogICAgICAgICAgICAgIGNvbnRhY3QudmFsdWUgPSAnJzsKICAgICAgICAgICAgfTsKICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgPGRpdiBpZD0iY3RybC1hcy1leG1wbCIgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyMSBhcyBzZXR0aW5ncyI+CiAgICAgICAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ic2V0dGluZ3MubmFtZSIvPgogICAgICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLmdyZWV0KCkiPmdyZWV0PC9hPiBdPGJyLz4KICAgICAgICAgICAgQ29udGFjdDoKICAgICAgICAgICAgPHVsPgogICAgICAgICAgICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gc2V0dGluZ3MuY29udGFjdHMiPgogICAgICAgICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29udGFjdC50eXBlIj4KICAgICAgICAgICAgICAgICAgIDxvcHRpb24+cGhvbmU8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgIDxvcHRpb24+ZW1haWw8L29wdGlvbj4KICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJjb250YWN0LnZhbHVlIi8+CiAgICAgICAgICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLmNsZWFyQ29udGFjdChjb250YWN0KSI+Y2xlYXI8L2E+CiAgICAgICAgICAgICAgICB8IDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLnJlbW92ZUNvbnRhY3QoY29udGFjdCkiPlg8L2E+IF0KICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgIDxsaT5bIDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLmFkZENvbnRhY3QoKSI+YWRkPC9hPiBdPC9saT4KICAgICAgICAgICA8L3VsPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIGNvbnRyb2xsZXIgYXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjY3RybC1hcy1leG1wbD46aW5wdXQnKS52YWwoKSkudG9CZSgnSm9obiBTbWl0aCcpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNjdHJsLWFzLWV4bXBsIGxpOm50aC1jaGlsZCgxKSBpbnB1dCcpLnZhbCgpKQogICAgICAgICAgICAgICAudG9CZSgnNDA4IDU1NSAxMjEyJyk7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2N0cmwtYXMtZXhtcGwgbGk6bnRoLWNoaWxkKDIpIGlucHV0JykudmFsKCkpCiAgICAgICAgICAgICAgIC50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CiAgICAKICAgICAgICAgICAgIGVsZW1lbnQoJyNjdHJsLWFzLWV4bXBsIGxpOmZpcnN0IGE6Y29udGFpbnMoImNsZWFyIiknKS5jbGljaygpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNjdHJsLWFzLWV4bXBsIGxpOmZpcnN0IGlucHV0JykudmFsKCkpLnRvQmUoJycpOwogICAgCiAgICAgICAgICAgICBlbGVtZW50KCcjY3RybC1hcy1leG1wbCBsaTpsYXN0IGE6Y29udGFpbnMoImFkZCIpJykuY2xpY2soKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjY3RybC1hcy1leG1wbCBsaTpudGgtY2hpbGQoMykgaW5wdXQnKS52YWwoKSkKICAgICAgICAgICAgICAgLnRvQmUoJ3lvdXJuYW1lQGV4YW1wbGUub3JnJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgZnVuY3Rpb24gU2V0dGluZ3NDb250cm9sbGVyMigkc2NvcGUpIHsKICAgICAgICAgICAgICAkc2NvcGUubmFtZSA9ICJKb2huIFNtaXRoIjsKICAgICAgICAgICAgICAkc2NvcGUuY29udGFjdHMgPSBbCiAgICAgICAgICAgICAgICB7dHlwZToncGhvbmUnLCB2YWx1ZTonNDA4IDU1NSAxMjEyJ30sCiAgICAgICAgICAgICAgICB7dHlwZTonZW1haWwnLCB2YWx1ZTonam9obi5zbWl0aEBleGFtcGxlLm9yZyd9IF07CiAgICAKICAgICAgICAgICAgICAkc2NvcGUuZ3JlZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgYWxlcnQodGhpcy5uYW1lKTsKICAgICAgICAgICAgICB9OwogICAgCiAgICAgICAgICAgICAgJHNjb3BlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgdGhpcy5jb250YWN0cy5wdXNoKHt0eXBlOidlbWFpbCcsIHZhbHVlOid5b3VybmFtZUBleGFtcGxlLm9yZyd9KTsKICAgICAgICAgICAgICB9OwogICAgCiAgICAgICAgICAgICAgJHNjb3BlLnJlbW92ZUNvbnRhY3QgPSBmdW5jdGlvbihjb250YWN0VG9SZW1vdmUpIHsKICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb250YWN0cy5pbmRleE9mKGNvbnRhY3RUb1JlbW92ZSk7CiAgICAgICAgICAgICAgIHRoaXMuY29udGFjdHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgICB9OwogICAgCiAgICAgICAgICAgICAgJHNjb3BlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgY29udGFjdC50eXBlID0gJ3Bob25lJzsKICAgICAgICAgICAgICAgY29udGFjdC52YWx1ZSA9ICcnOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgPGRpdiBpZD0iY3RybC1leG1wbCIgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyMiI+CiAgICAgICAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSIvPgogICAgICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9ImdyZWV0KCkiPmdyZWV0PC9hPiBdPGJyLz4KICAgICAgICAgICAgQ29udGFjdDoKICAgICAgICAgICAgPHVsPgogICAgICAgICAgICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gY29udGFjdHMiPgogICAgICAgICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29udGFjdC50eXBlIj4KICAgICAgICAgICAgICAgICAgIDxvcHRpb24+cGhvbmU8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgIDxvcHRpb24+ZW1haWw8L29wdGlvbj4KICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJjb250YWN0LnZhbHVlIi8+CiAgICAgICAgICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9ImNsZWFyQ29udGFjdChjb250YWN0KSI+Y2xlYXI8L2E+CiAgICAgICAgICAgICAgICB8IDxhIGhyZWY9IiIgbmctY2xpY2s9InJlbW92ZUNvbnRhY3QoY29udGFjdCkiPlg8L2E+IF0KICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgIDxsaT5bIDxhIGhyZWY9IiIgbmctY2xpY2s9ImFkZENvbnRhY3QoKSI+YWRkPC9hPiBdPC9saT4KICAgICAgICAgICA8L3VsPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIGNvbnRyb2xsZXInLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjY3RybC1leG1wbD46aW5wdXQnKS52YWwoKSkudG9CZSgnSm9obiBTbWl0aCcpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNjdHJsLWV4bXBsIGxpOm50aC1jaGlsZCgxKSBpbnB1dCcpLnZhbCgpKQogICAgICAgICAgICAgICAudG9CZSgnNDA4IDU1NSAxMjEyJyk7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2N0cmwtZXhtcGwgbGk6bnRoLWNoaWxkKDIpIGlucHV0JykudmFsKCkpCiAgICAgICAgICAgICAgIC50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CiAgICAKICAgICAgICAgICAgIGVsZW1lbnQoJyNjdHJsLWV4bXBsIGxpOmZpcnN0IGE6Y29udGFpbnMoImNsZWFyIiknKS5jbGljaygpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNjdHJsLWV4bXBsIGxpOmZpcnN0IGlucHV0JykudmFsKCkpLnRvQmUoJycpOwogICAgCiAgICAgICAgICAgICBlbGVtZW50KCcjY3RybC1leG1wbCBsaTpsYXN0IGE6Y29udGFpbnMoImFkZCIpJykuY2xpY2soKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjY3RybC1leG1wbCBsaTpudGgtY2hpbGQoMykgaW5wdXQnKS52YWwoKSkKICAgICAgICAgICAgICAgLnRvQmUoJ3lvdXJuYW1lQGV4YW1wbGUub3JnJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgIAogICAgICovCiAgICB2YXIgbmdDb250cm9sbGVyRGlyZWN0aXZlID0gW2Z1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzY29wZTogdHJ1ZSwKICAgICAgICAgICAgY29udHJvbGxlcjogJ0AnCiAgICAgICAgfTsKICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ3NwCiAgICAgKiBAcHJpb3JpdHkgMTAwMAogICAgICoKICAgICAqIEBlbGVtZW50IGh0bWwKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRW5hYmxlcyBbQ1NQIChDb250ZW50IFNlY3VyaXR5IFBvbGljeSldKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL1NlY3VyaXR5L0NTUCkgc3VwcG9ydC4KICAgICAqIAogICAgICogVGhpcyBpcyBuZWNlc3Nhcnkgd2hlbiBkZXZlbG9waW5nIHRoaW5ncyBsaWtlIEdvb2dsZSBDaHJvbWUgRXh0ZW5zaW9ucy4KICAgICAqIAogICAgICogQ1NQIGZvcmJpZHMgYXBwcyB0byB1c2UgYGV2YWxgIG9yIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIChhbW9uZyBvdGhlciB0aGluZ3MpLgogICAgICogRm9yIHVzIHRvIGJlIGNvbXBhdGlibGUsIHdlIGp1c3QgbmVlZCB0byBpbXBsZW1lbnQgdGhlICJnZXR0ZXJGbiIgaW4gJHBhcnNlIHdpdGhvdXQgdmlvbGF0aW5nCiAgICAgKiBhbnkgb2YgdGhlc2UgcmVzdHJpY3Rpb25zLgogICAgICogCiAgICAgKiBBbmd1bGFySlMgdXNlcyBgRnVuY3Rpb24oc3RyaW5nKWAgZ2VuZXJhdGVkIGZ1bmN0aW9ucyBhcyBhIHNwZWVkIG9wdGltaXphdGlvbi4gQnkgYXBwbHlpbmcgYG5nQ3NwYAogICAgICogaXQgaXMgYmUgcG9zc2libGUgdG8gb3B0IGludG8gdGhlIENTUCBjb21wYXRpYmxlIG1vZGUuIFdoZW4gdGhpcyBtb2RlIGlzIG9uIEFuZ3VsYXJKUyB3aWxsCiAgICAgKiBldmFsdWF0ZSBhbGwgZXhwcmVzc2lvbnMgdXAgdG8gMzAlIHNsb3dlciB0aGFuIGluIG5vbi1DU1AgbW9kZSwgYnV0IG5vIHNlY3VyaXR5IHZpb2xhdGlvbnMgd2lsbAogICAgICogYmUgcmFpc2VkLgogICAgICogCiAgICAgKiBJbiBvcmRlciB0byB1c2UgdGhpcyBmZWF0dXJlIHB1dCBgbmdDc3BgIGRpcmVjdGl2ZSBvbiB0aGUgcm9vdCBlbGVtZW50IG9mIHRoZSBhcHBsaWNhdGlvbi4KICAgICAqIAogICAgICogQGV4YW1wbGUKICAgICAqIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgdG8gYXBwbHkgdGhlIGBuZ0NzcGAgZGlyZWN0aXZlIHRvIHRoZSBgaHRtbGAgdGFnLgogICAgICAgPHByZT4KICAgICAgICAgPCFkb2N0eXBlIGh0bWw+CiAgICAgICAgIDxodG1sIG5nLWFwcCBuZy1jc3A+CiAgICAgICAgIC4uLgogICAgICAgICAuLi4KICAgICAgICAgPC9odG1sPgogICAgICAgPC9wcmU+CiAgICAgKi8KCiAgICB2YXIgbmdDc3BEaXJlY3RpdmUgPSBbJyRzbmlmZmVyJywgZnVuY3Rpb24gKCRzbmlmZmVyKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcHJpb3JpdHk6IDEwMDAsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICRzbmlmZmVyLmNzcCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGljawogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIG5nQ2xpY2sgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuCiAgICAgKiBlbGVtZW50IGlzIGNsaWNrZWQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogY2xpY2suIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgICAgICBJbmNyZW1lbnQKICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgY291bnQ6IHt7Y291bnR9fQogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50JykpLnRvQmUoJzAnKTsKICAgICAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b24nKS5jbGljaygpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50JykpLnRvQmUoJzEnKTsKICAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICAvKgogICAgICogQSBkaXJlY3RpdmUgdGhhdCBhbGxvd3MgY3JlYXRpb24gb2YgY3VzdG9tIG9uY2xpY2sgaGFuZGxlcnMgdGhhdCBhcmUgZGVmaW5lZCBhcyBhbmd1bGFyCiAgICAgKiBleHByZXNzaW9ucyBhbmQgYXJlIGNvbXBpbGVkIGFuZCBleGVjdXRlZCB3aXRoaW4gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICAgKgogICAgICogRXZlbnRzIHRoYXQgYXJlIGhhbmRsZWQgdmlhIHRoZXNlIGhhbmRsZXIgYXJlIGFsd2F5cyBjb25maWd1cmVkIG5vdCB0byBwcm9wYWdhdGUgZnVydGhlci4KICAgICAqLwogICAgdmFyIG5nRXZlbnREaXJlY3RpdmVzID0ge307CiAgICBmb3JFYWNoKAogICAgICAnY2xpY2sgZGJsY2xpY2sgbW91c2Vkb3duIG1vdXNldXAgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlbW92ZSBtb3VzZWVudGVyIG1vdXNlbGVhdmUga2V5ZG93biBrZXl1cCBrZXlwcmVzcyBzdWJtaXQgZm9jdXMgYmx1cicuc3BsaXQoJyAnKSwKICAgICAgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgIHZhciBkaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgbmFtZSk7CiAgICAgICAgICBuZ0V2ZW50RGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSA9IFsnJHBhcnNlJywgZnVuY3Rpb24gKCRwYXJzZSkgewogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGF0dHJbZGlyZWN0aXZlTmFtZV0pOwogICAgICAgICAgICAgICAgICBlbGVtZW50Lm9uKGxvd2VyY2FzZShuYW1lKSwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHNjb3BlLCB7ICRldmVudDogZXZlbnQgfSk7CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgIH1dOwogICAgICB9CiAgICApOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nRGJsY2xpY2sKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdEYmxjbGlja2AgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gZGJsY2xpY2sgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nRGJsY2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogZGJsY2xpY2suIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZWRvd24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBuZ01vdXNlZG93biBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWRvd24gZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2Vkb3duIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlZG93bi4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNldXAKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNldXAgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2V1cCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZXVwLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZW92ZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlb3ZlciBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZW92ZXIge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2VvdmVyLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2VlbnRlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VlbnRlciBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWVudGVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlZW50ZXIuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZWxlYXZlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWxlYXZlIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbGVhdmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2VsZWF2ZS4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNlbW92ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2Vtb3ZlIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbW92ZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZW1vdmUuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdLZXlkb3duCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBrZXlkb3duIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleWRvd24ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICoga2V5ZG93bi4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGAgYW5kIGNhbiBiZSBpbnRlcnJvZ2F0ZWQgZm9yIGtleUNvZGUsIGFsdEtleSwgZXRjLikKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nS2V5dXAKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGtleXVwIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleXVwIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIGtleXVwLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCBhbmQgY2FuIGJlIGludGVycm9nYXRlZCBmb3Iga2V5Q29kZSwgYWx0S2V5LCBldGMuKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdLZXlwcmVzcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24ga2V5cHJlc3MgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nS2V5cHJlc3Mge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICoga2V5cHJlc3MuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgIGFuZCBjYW4gYmUgaW50ZXJyb2dhdGVkIGZvciBrZXlDb2RlLCBhbHRLZXksIGV0Yy4pCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1N1Ym1pdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRW5hYmxlcyBiaW5kaW5nIGFuZ3VsYXIgZXhwcmVzc2lvbnMgdG8gb25zdWJtaXQgZXZlbnRzLgogICAgICoKICAgICAqIEFkZGl0aW9uYWxseSBpdCBwcmV2ZW50cyB0aGUgZGVmYXVsdCBhY3Rpb24gKHdoaWNoIGZvciBmb3JtIG1lYW5zIHNlbmRpbmcgdGhlIHJlcXVlc3QgdG8gdGhlCiAgICAgKiBzZXJ2ZXIgYW5kIHJlbG9hZGluZyB0aGUgY3VycmVudCBwYWdlKSAqKmJ1dCBvbmx5IGlmIHRoZSBmb3JtIGRvZXMgbm90IGNvbnRhaW4gYW4gYGFjdGlvbmAKICAgICAqIGF0dHJpYnV0ZSoqLgogICAgICoKICAgICAqIEBlbGVtZW50IGZvcm0KICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTdWJtaXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgICRzY29wZS5saXN0ID0gW107CiAgICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnaGVsbG8nOwogICAgICAgICAgICAgICRzY29wZS5zdWJtaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRleHQpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5saXN0LnB1c2godGhpcy50ZXh0KTsKICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0ID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICA8Zm9ybSBuZy1zdWJtaXQ9InN1Ym1pdCgpIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgRW50ZXIgdGV4dCBhbmQgaGl0IGVudGVyOgogICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InRleHQiIG5hbWU9InRleHQiIC8+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJzdWJtaXQiIGlkPSJzdWJtaXQiIHZhbHVlPSJTdWJtaXQiIC8+CiAgICAgICAgICAgIDxwcmU+bGlzdD17e2xpc3R9fTwvcHJlPgogICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zdWJtaXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdsaXN0JykpLnRvQmUoJ1tdJyk7CiAgICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc3VibWl0JykuY2xpY2soKTsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdsaXN0JykpLnRvQmUoJ1siaGVsbG8iXScpOwogICAgICAgICAgICAgZXhwZWN0KGlucHV0KCd0ZXh0JykudmFsKCkpLnRvQmUoJycpOwogICAgICAgICAgIH0pOwogICAgICAgICAgIGl0KCdzaG91bGQgaWdub3JlIGVtcHR5IHN0cmluZ3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdsaXN0JykpLnRvQmUoJ1tdJyk7CiAgICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc3VibWl0JykuY2xpY2soKTsKICAgICAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNzdWJtaXQnKS5jbGljaygpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnWyJoZWxsbyJdJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nRm9jdXMKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGZvY3VzIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IHdpbmRvdywgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIGEKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdGb2N1cyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBmb2N1cy4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmx1cgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gYmx1ciBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCB3aW5kb3csIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmx1ciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBibHVyLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdJZgogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdJZmAgZGlyZWN0aXZlIHJlbW92ZXMgYW5kIHJlY3JlYXRlcyBhIHBvcnRpb24gb2YgdGhlIERPTSB0cmVlIChIVE1MKQogICAgICogY29uZGl0aW9uYWxseSBiYXNlZCBvbiAqKiJmYWxzeSIqKiBhbmQgKioidHJ1dGh5IioqIHZhbHVlcywgcmVzcGVjdGl2ZWx5LCBldmFsdWF0ZWQgd2l0aGluCiAgICAgKiBhbiB7ZXhwcmVzc2lvbn0uIEluIG90aGVyIHdvcmRzLCBpZiB0aGUgZXhwcmVzc2lvbiBhc3NpZ25lZCB0byAqKm5nSWYgZXZhbHVhdGVzIHRvIGEgZmFsc2UKICAgICAqIHZhbHVlKiogdGhlbiAqKnRoZSBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NKiogYW5kICoqaWYgdHJ1ZSoqIHRoZW4gKiphIGNsb25lIG9mIHRoZQogICAgICogZWxlbWVudCBpcyByZWluc2VydGVkIGludG8gdGhlIERPTSoqLgogICAgICoKICAgICAqIGBuZ0lmYCBkaWZmZXJzIGZyb20gYG5nU2hvd2AgYW5kIGBuZ0hpZGVgIGluIHRoYXQgYG5nSWZgIGNvbXBsZXRlbHkgcmVtb3ZlcyBhbmQgcmVjcmVhdGVzIHRoZQogICAgICogZWxlbWVudCBpbiB0aGUgRE9NIHJhdGhlciB0aGFuIGNoYW5naW5nIGl0cyB2aXNpYmlsaXR5IHZpYSB0aGUgYGRpc3BsYXlgIGNzcyBwcm9wZXJ0eS4gIEEgY29tbW9uCiAgICAgKiBjYXNlIHdoZW4gdGhpcyBkaWZmZXJlbmNlIGlzIHNpZ25pZmljYW50IGlzIHdoZW4gdXNpbmcgY3NzIHNlbGVjdG9ycyB0aGF0IHJlbHkgb24gYW4gZWxlbWVudCdzCiAgICAgKiBwb3NpdGlvbiB3aXRoaW4gdGhlIERPTSAoSFRNTCksIHN1Y2ggYXMgdGhlIGA6Zmlyc3QtY2hpbGRgIG9yIGA6bGFzdC1jaGlsZGAgcHNldWRvLWNsYXNzZXMuCiAgICAgKgogICAgICogTm90ZSB0aGF0ICoqd2hlbiBhbiBlbGVtZW50IGlzIHJlbW92ZWQgdXNpbmcgbmdJZiBpdHMgc2NvcGUgaXMgZGVzdHJveWVkKiogYW5kICoqYSBuZXcgc2NvcGUKICAgICAqIGlzIGNyZWF0ZWQgd2hlbiB0aGUgZWxlbWVudCBpcyByZXN0b3JlZCoqLiAgVGhlIHNjb3BlIGNyZWF0ZWQgd2l0aGluIGBuZ0lmYCBpbmhlcml0cyBmcm9tIAogICAgICogaXRzIHBhcmVudCBzY29wZSB1c2luZwogICAgICoge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvd2lraS9UaGUtTnVhbmNlcy1vZi1TY29wZS1Qcm90b3R5cGFsLUluaGVyaXRhbmNlIHByb3RvdHlwYWwgaW5oZXJpdGFuY2V9LgogICAgICogQW4gaW1wb3J0YW50IGltcGxpY2F0aW9uIG9mIHRoaXMgaXMgaWYgYG5nTW9kZWxgIGlzIHVzZWQgd2l0aGluIGBuZ0lmYCB0byBiaW5kIHRvCiAgICAgKiBhIGphdmFzY3JpcHQgcHJpbWl0aXZlIGRlZmluZWQgaW4gdGhlIHBhcmVudCBzY29wZS4gSW4gdGhpcyBjYXNlIGFueSBtb2RpZmljYXRpb25zIG1hZGUgdG8gdGhlCiAgICAgKiB2YXJpYWJsZSB3aXRoaW4gdGhlIGNoaWxkIHNjb3BlIHdpbGwgb3ZlcnJpZGUgKGhpZGUpIHRoZSB2YWx1ZSBpbiB0aGUgcGFyZW50IHNjb3BlLgogICAgICoKICAgICAqIEFsc28sIGBuZ0lmYCByZWNyZWF0ZXMgZWxlbWVudHMgdXNpbmcgdGhlaXIgY29tcGlsZWQgc3RhdGUuIEFuIGV4YW1wbGUgc2NlbmFyaW8gb2YgdGhpcyBiZWhhdmlvcgogICAgICogaXMgaWYgYW4gZWxlbWVudCdzIGNsYXNzIGF0dHJpYnV0ZSBpcyBkaXJlY3RseSBtb2RpZmllZCBhZnRlciBpdCdzIGNvbXBpbGVkLCB1c2luZyBzb21ldGhpbmcgbGlrZSAKICAgICAqIGpRdWVyeSdzIGAuYWRkQ2xhc3MoKWAgbWV0aG9kLCBhbmQgdGhlIGVsZW1lbnQgaXMgbGF0ZXIgcmVtb3ZlZC4gV2hlbiBgbmdJZmAgcmVjcmVhdGVzIHRoZSBlbGVtZW50CiAgICAgKiB0aGUgYWRkZWQgY2xhc3Mgd2lsbCBiZSBsb3N0IGJlY2F1c2UgdGhlIG9yaWdpbmFsIGNvbXBpbGVkIHN0YXRlIGlzIHVzZWQgdG8gcmVnZW5lcmF0ZSB0aGUgZWxlbWVudC4KICAgICAqCiAgICAgKiBBZGRpdGlvbmFsbHksIHlvdSBjYW4gcHJvdmlkZSBhbmltYXRpb25zIHZpYSB0aGUgbmdBbmltYXRlIG1vZHVsZSB0byBhbmltYXRlIHRoZSAqKmVudGVyKioKICAgICAqIGFuZCAqKmxlYXZlKiogZWZmZWN0cy4KICAgICAqCiAgICAgKiBAYW5pbWF0aW9ucwogICAgICogZW50ZXIgLSBoYXBwZW5zIGp1c3QgYWZ0ZXIgdGhlIG5nSWYgY29udGVudHMgY2hhbmdlIGFuZCBhIG5ldyBET00gZWxlbWVudCBpcyBjcmVhdGVkIGFuZCBpbmplY3RlZCBpbnRvIHRoZSBuZ0lmIGNvbnRhaW5lcgogICAgICogbGVhdmUgLSBoYXBwZW5zIGp1c3QgYmVmb3JlIHRoZSBuZ0lmIGNvbnRlbnRzIGFyZSByZW1vdmVkIGZyb20gdGhlIERPTQogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHNjb3BlCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nSWYgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIGZhbHN5IHRoZW4KICAgICAqICAgICB0aGUgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTSB0cmVlIChIVE1MKS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBhbmltYXRpb25zPSJ0cnVlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIiBuZy1pbml0PSJjaGVja2VkPXRydWUiIC8+PGJyLz4KICAgICAgICAgIFNob3cgd2hlbiBjaGVja2VkOgogICAgICAgICAgPHNwYW4gbmctaWY9ImNoZWNrZWQiIGNsYXNzPSJhbmltYXRlLWlmIj4KICAgICAgICAgICAgSSdtIHJlbW92ZWQgd2hlbiB0aGUgY2hlY2tib3ggaXMgdW5jaGVja2VkLgogICAgICAgICAgPC9zcGFuPgogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgICAgICAuYW5pbWF0ZS1pZiB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmFuaW1hdGUtaWYubmctZW50ZXIsIC5hbmltYXRlLWlmLm5nLWxlYXZlIHsKICAgICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgIC1tb3otdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgICAgICAtby10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmFuaW1hdGUtaWYubmctZW50ZXIsCiAgICAgICAgICAuYW5pbWF0ZS1pZi5uZy1sZWF2ZS5uZy1sZWF2ZS1hY3RpdmUgewogICAgICAgICAgICBvcGFjaXR5OjA7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5hbmltYXRlLWlmLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSwKICAgICAgICAgIC5hbmltYXRlLWlmLm5nLWxlYXZlIHsKICAgICAgICAgICAgb3BhY2l0eToxOwogICAgICAgICAgfQogICAgICAgIDwvZmlsZT4KICAgICAgPC9leGFtcGxlPgogICAgICovCiAgICB2YXIgbmdJZkRpcmVjdGl2ZSA9IFsnJGFuaW1hdGUnLCBmdW5jdGlvbiAoJGFuaW1hdGUpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgICAgIHByaW9yaXR5OiAxMDAwLAogICAgICAgICAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICAgICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIsIHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRFbGVtZW50LCBjaGlsZFNjb3BlOwogICAgICAgICAgICAgICAgICAgICRzY29wZS4kd2F0Y2goJGF0dHIubmdJZiwgZnVuY3Rpb24gbmdJZldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKGNoaWxkRWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkU2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvQm9vbGVhbih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSAkc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNjbHVkZShjaGlsZFNjb3BlLCBmdW5jdGlvbiAoY2xvbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjbG9uZSwgJGVsZW1lbnQucGFyZW50KCksICRlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUKICAgICAqIEByZXN0cmljdCBFQ0EKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEZldGNoZXMsIGNvbXBpbGVzIGFuZCBpbmNsdWRlcyBhbiBleHRlcm5hbCBIVE1MIGZyYWdtZW50LgogICAgICoKICAgICAqIEtlZXAgaW4gbWluZCB0aGF0OgogICAgICoKICAgICAqIC0gICAgYnkgZGVmYXVsdCwgdGhlIHRlbXBsYXRlIFVSTCBpcyByZXN0cmljdGVkIHRvIHRoZSBzYW1lIGRvbWFpbiBhbmQgcHJvdG9jb2wgYXMgdGhlCiAgICAgKiAgICAgIGFwcGxpY2F0aW9uIGRvY3VtZW50LiAgVGhpcyBpcyBkb25lIGJ5IGNhbGxpbmcge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAgICAgKiAgICAgICRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsfSBvbiBpdC4gIFRvIGxvYWQgdGVtcGxhdGVzIGZyb20gb3RoZXIgZG9tYWlucyBhbmQvb3IgcHJvdG9jb2xzLAogICAgICogICAgICB5b3UgbWF5IGVpdGhlciBlaXRoZXIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0IHdoaXRlbGlzdCB0aGVtfSBvcgogICAgICogICAgICB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzUmVzb3VyY2VVcmwgd3JhcCBpdH0gaW50byBhIHRydXN0ZWQgdmFsdWUuICBSZWZlciBBbmd1bGFyJ3Mge0BsaW5rCiAgICAgKiAgICAgIG5nLiRzY2UgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmd9LgogICAgICogLSAgICBpbiBhZGRpdGlvbiwgdGhlIGJyb3dzZXIncwogICAgICogICAgICB7QGxpbmsgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9icm93c2Vyc2VjL3dpa2kvUGFydDIjU2FtZS1vcmlnaW5fcG9saWN5X2Zvcl9YTUxIdHRwUmVxdWVzdAogICAgICogICAgICBTYW1lIE9yaWdpbiBQb2xpY3l9IGFuZCB7QGxpbmsgaHR0cDovL3d3dy53My5vcmcvVFIvY29ycy8gQ3Jvc3MtT3JpZ2luIFJlc291cmNlIFNoYXJpbmcKICAgICAqICAgICAgKENPUlMpfSBwb2xpY3kgYXBwbHkgdGhhdCBtYXkgZnVydGhlciByZXN0cmljdCB3aGV0aGVyIHRoZSB0ZW1wbGF0ZSBpcyBzdWNjZXNzZnVsbHkgbG9hZGVkLgogICAgICogICAgICAoZS5nLiAgbmdJbmNsdWRlIHdvbid0IHdvcmsgZm9yIGNyb3NzLWRvbWFpbiByZXF1ZXN0cyBvbiBhbGwgYnJvd3NlcnMgYW5kIGZvciBgZmlsZTovL2AKICAgICAqICAgICAgYWNjZXNzIG9uIHNvbWUgYnJvd3NlcnMpCiAgICAgKgogICAgICogQGFuaW1hdGlvbnMKICAgICAqIGVudGVyIC0gYW5pbWF0aW9uIGlzIHVzZWQgdG8gYnJpbmcgbmV3IGNvbnRlbnQgaW50byB0aGUgYnJvd3Nlci4KICAgICAqIGxlYXZlIC0gYW5pbWF0aW9uIGlzIHVzZWQgdG8gYW5pbWF0ZSBleGlzdGluZyBjb250ZW50IGF3YXkuCiAgICAgKgogICAgICogVGhlIGVudGVyIGFuZCBsZWF2ZSBhbmltYXRpb24gb2NjdXIgY29uY3VycmVudGx5LgogICAgICoKICAgICAqIEBzY29wZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ0luY2x1ZGV8c3JjIGFuZ3VsYXIgZXhwcmVzc2lvbiBldmFsdWF0aW5nIHRvIFVSTC4gSWYgdGhlIHNvdXJjZSBpcyBhIHN0cmluZyBjb25zdGFudCwKICAgICAqICAgICAgICAgICAgICAgICBtYWtlIHN1cmUgeW91IHdyYXAgaXQgaW4gcXVvdGVzLCBlLmcuIGBzcmM9IidteVBhcnRpYWxUZW1wbGF0ZS5odG1sJyJgLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBvbmxvYWQgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB3aGVuIGEgbmV3IHBhcnRpYWwgaXMgbG9hZGVkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gYXV0b3Njcm9sbCBXaGV0aGVyIGBuZ0luY2x1ZGVgIHNob3VsZCBjYWxsIHtAbGluayBuZy4kYW5jaG9yU2Nyb2xsCiAgICAgKiAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGx9IHRvIHNjcm9sbCB0aGUgdmlld3BvcnQgYWZ0ZXIgdGhlIGNvbnRlbnQgaXMgbG9hZGVkLgogICAgICoKICAgICAqICAgICAgICAgICAgICAgICAgLSBJZiB0aGUgYXR0cmlidXRlIGlzIG5vdCBzZXQsIGRpc2FibGUgc2Nyb2xsaW5nLgogICAgICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgc2V0IHdpdGhvdXQgdmFsdWUsIGVuYWJsZSBzY3JvbGxpbmcuCiAgICAgKiAgICAgICAgICAgICAgICAgIC0gT3RoZXJ3aXNlIGVuYWJsZSBzY3JvbGxpbmcgb25seSBpZiB0aGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1dGh5IHZhbHVlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgIDxleGFtcGxlIGFuaW1hdGlvbnM9InRydWUiPgogICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9InRlbXBsYXRlIiBuZy1vcHRpb25zPSJ0Lm5hbWUgZm9yIHQgaW4gdGVtcGxhdGVzIj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj4oYmxhbmspPC9vcHRpb24+CiAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgdXJsIG9mIHRoZSB0ZW1wbGF0ZTogPHR0Pnt7dGVtcGxhdGUudXJsfX08L3R0PgogICAgICAgICAgIDxoci8+CiAgICAgICAgICAgPGRpdiBjbGFzcz0iZXhhbXBsZS1hbmltYXRlLWNvbnRhaW5lciI+CiAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmNsdWRlLWV4YW1wbGUiIG5nLWluY2x1ZGU9InRlbXBsYXRlLnVybCI+PC9kaXY+CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLnRlbXBsYXRlcyA9CiAgICAgICAgICAgICAgWyB7IG5hbWU6ICd0ZW1wbGF0ZTEuaHRtbCcsIHVybDogJ3RlbXBsYXRlMS5odG1sJ30KICAgICAgICAgICAgICAsIHsgbmFtZTogJ3RlbXBsYXRlMi5odG1sJywgdXJsOiAndGVtcGxhdGUyLmh0bWwnfSBdOwogICAgICAgICAgICAkc2NvcGUudGVtcGxhdGUgPSAkc2NvcGUudGVtcGxhdGVzWzBdOwogICAgICAgICAgfQogICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0idGVtcGxhdGUxLmh0bWwiPgogICAgICAgICAgQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbAogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJ0ZW1wbGF0ZTIuaHRtbCI+CiAgICAgICAgICBDb250ZW50IG9mIHRlbXBsYXRlMi5odG1sCiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9ImFuaW1hdGlvbnMuY3NzIj4KICAgICAgICAgIC5leGFtcGxlLWFuaW1hdGUtY29udGFpbmVyIHsKICAgICAgICAgICAgcG9zaXRpb246cmVsYXRpdmU7CiAgICAgICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgICAgIGhlaWdodDo0MHB4OwogICAgICAgICAgICBvdmVyZmxvdzpoaWRkZW47CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5leGFtcGxlLWFuaW1hdGUtY29udGFpbmVyID4gZGl2IHsKICAgICAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICAgICAgfQogICAgCiAgICAgICAgICAuaW5jbHVkZS1leGFtcGxlLm5nLWVudGVyLCAuaW5jbHVkZS1leGFtcGxlLm5nLWxlYXZlIHsKICAgICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgIC1tb3otdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgICAgICAtby10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgIAogICAgICAgICAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgICAgICAgICAgdG9wOjA7CiAgICAgICAgICAgIGxlZnQ6MDsKICAgICAgICAgICAgcmlnaHQ6MDsKICAgICAgICAgICAgYm90dG9tOjA7CiAgICAgICAgICAgIGRpc3BsYXk6YmxvY2s7CiAgICAgICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmluY2x1ZGUtZXhhbXBsZS5uZy1lbnRlciB7CiAgICAgICAgICAgIHRvcDotNTBweDsKICAgICAgICAgIH0KICAgICAgICAgIC5pbmNsdWRlLWV4YW1wbGUubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICAgICAgICAgICAgdG9wOjA7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5pbmNsdWRlLWV4YW1wbGUubmctbGVhdmUgewogICAgICAgICAgICB0b3A6MDsKICAgICAgICAgIH0KICAgICAgICAgIC5pbmNsdWRlLWV4YW1wbGUubmctbGVhdmUubmctbGVhdmUtYWN0aXZlIHsKICAgICAgICAgICAgdG9wOjUwcHg7CiAgICAgICAgICB9CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTEuaHRtbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctaW5jbHVkZV0nKS50ZXh0KCkpLgogICAgICAgICAgICAgdG9NYXRjaCgvQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbC8pOwogICAgICAgICAgfSk7CiAgICAgICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUyLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBzZWxlY3QoJ3RlbXBsYXRlJykub3B0aW9uKCcxJyk7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1pbmNsdWRlXScpLnRleHQoKSkuCiAgICAgICAgICAgICB0b01hdGNoKC9Db250ZW50IG9mIHRlbXBsYXRlMi5odG1sLyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGJsYW5rJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgc2VsZWN0KCd0ZW1wbGF0ZScpLm9wdGlvbignJyk7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1pbmNsdWRlXScpKS50b0JlKHVuZGVmaW5lZCk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgIDwvZXhhbXBsZT4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBldmVudAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSMkaW5jbHVkZUNvbnRlbnRSZXF1ZXN0ZWQKICAgICAqIEBldmVudE9mIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUKICAgICAqIEBldmVudFR5cGUgZW1pdCBvbiB0aGUgc2NvcGUgbmdJbmNsdWRlIHdhcyBkZWNsYXJlZCBpbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbWl0dGVkIGV2ZXJ5IHRpbWUgdGhlIG5nSW5jbHVkZSBjb250ZW50IGlzIHJlcXVlc3RlZC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBldmVudAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSMkaW5jbHVkZUNvbnRlbnRMb2FkZWQKICAgICAqIEBldmVudE9mIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUKICAgICAqIEBldmVudFR5cGUgZW1pdCBvbiB0aGUgY3VycmVudCBuZ0luY2x1ZGUgc2NvcGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRW1pdHRlZCBldmVyeSB0aW1lIHRoZSBuZ0luY2x1ZGUgY29udGVudCBpcyByZWxvYWRlZC4KICAgICAqLwogICAgdmFyIG5nSW5jbHVkZURpcmVjdGl2ZSA9IFsnJGh0dHAnLCAnJHRlbXBsYXRlQ2FjaGUnLCAnJGFuY2hvclNjcm9sbCcsICckY29tcGlsZScsICckYW5pbWF0ZScsICckc2NlJywKICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgkaHR0cCwgJHRlbXBsYXRlQ2FjaGUsICRhbmNob3JTY3JvbGwsICRjb21waWxlLCAkYW5pbWF0ZSwgJHNjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnRUNBJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIsIHRyYW5zY2x1c2lvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNyY0V4cCA9IGF0dHIubmdJbmNsdWRlIHx8IGF0dHIuc3JjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ubG9hZEV4cCA9IGF0dHIub25sb2FkIHx8ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9TY3JvbGxFeHAgPSBhdHRyLmF1dG9zY3JvbGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hhbmdlQ291bnRlciA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEVsZW1lbnQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjbGVhbnVwTGFzdEluY2x1ZGVDb250ZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYW5pbWF0ZS5sZWF2ZShjdXJyZW50RWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50RWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goJHNjZS5wYXJzZUFzUmVzb3VyY2VVcmwoc3JjRXhwKSwgZnVuY3Rpb24gbmdJbmNsdWRlV2F0Y2hBY3Rpb24oc3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aGlzQ2hhbmdlSWQgPSArK2NoYW5nZUNvdW50ZXI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkaHR0cC5nZXQoc3JjLCB7IGNhY2hlOiAkdGVtcGxhdGVDYWNoZSB9KS5zdWNjZXNzKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzQ2hhbmdlSWQgIT09IGNoYW5nZUNvdW50ZXIpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3U2NvcGUgPSBzY29wZS4kbmV3KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1c2lvbihuZXdTY29wZSwgZnVuY3Rpb24gKGNsb25lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTY29wZSA9IG5ld1Njb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50RWxlbWVudCA9IGNsb25lOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEVsZW1lbnQuaHRtbChyZXNwb25zZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGN1cnJlbnRFbGVtZW50LCBudWxsLCAkZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlKGN1cnJlbnRFbGVtZW50LmNvbnRlbnRzKCkpKGN1cnJlbnRTY29wZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGF1dG9TY3JvbGxFeHApICYmICghYXV0b1Njcm9sbEV4cCB8fCBzY29wZS4kZXZhbChhdXRvU2Nyb2xsRXhwKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFNjb3BlLiRlbWl0KCckaW5jbHVkZUNvbnRlbnRMb2FkZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwob25sb2FkRXhwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc0NoYW5nZUlkID09PSBjaGFuZ2VDb3VudGVyKSBjbGVhbnVwTGFzdEluY2x1ZGVDb250ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRlbWl0KCckaW5jbHVkZUNvbnRlbnRSZXF1ZXN0ZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0luaXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdJbml0YCBkaXJlY3RpdmUgc3BlY2lmaWVzIGluaXRpYWxpemF0aW9uIHRhc2tzIHRvIGJlIGV4ZWN1dGVkCiAgICAgKiAgYmVmb3JlIHRoZSB0ZW1wbGF0ZSBlbnRlcnMgZXhlY3V0aW9uIG1vZGUgZHVyaW5nIGJvb3RzdHJhcC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdJbml0IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgPGRpdiBuZy1pbml0PSJncmVldGluZz0nSGVsbG8nOyBwZXJzb249J1dvcmxkJyI+CiAgICAgICAgICB7e2dyZWV0aW5nfX0ge3twZXJzb259fSEKICAgICAgICA8L2Rpdj4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgIGl0KCdzaG91bGQgY2hlY2sgZ3JlZXRpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdncmVldGluZycpKS50b0JlKCdIZWxsbycpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3BlcnNvbicpKS50b0JlKCdXb3JsZCcpOwogICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0luaXREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcHJlOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwoYXR0cnMubmdJbml0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTm9uQmluZGFibGUKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTb21ldGltZXMgaXQgaXMgbmVjZXNzYXJ5IHRvIHdyaXRlIGNvZGUgd2hpY2ggbG9va3MgbGlrZSBiaW5kaW5ncyBidXQgd2hpY2ggc2hvdWxkIGJlIGxlZnQgYWxvbmUKICAgICAqIGJ5IGFuZ3VsYXIuIFVzZSBgbmdOb25CaW5kYWJsZWAgdG8gbWFrZSBhbmd1bGFyIGlnbm9yZSBhIGNodW5rIG9mIEhUTUwuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEluIHRoaXMgZXhhbXBsZSB0aGVyZSBhcmUgdHdvIGxvY2F0aW9uIHdoZXJlIGEgc2ltcGxlIGJpbmRpbmcgKGB7e319YCkgaXMgcHJlc2VudCwgYnV0IHRoZSBvbmUKICAgICAqIHdyYXBwZWQgaW4gYG5nTm9uQmluZGFibGVgIGlzIGxlZnQgYWxvbmUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICAgPGRpdj5Ob3JtYWw6IHt7MSArIDJ9fTwvZGl2PgogICAgICAgICAgICA8ZGl2IG5nLW5vbi1iaW5kYWJsZT5JZ25vcmVkOiB7ezEgKyAyfX08L2Rpdj4KICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1ub24tYmluZGFibGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCcxICsgMicpKS50b0JlKCczJyk7CiAgICAgICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuZWxlbWVudCgnZGl2Omxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICB0b01hdGNoKC8xIFwrIDIvKTsKICAgICAgICAgICB9KTsKICAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ05vbkJpbmRhYmxlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoeyB0ZXJtaW5hbDogdHJ1ZSwgcHJpb3JpdHk6IDEwMDAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdQbHVyYWxpemUKICAgICAqIEByZXN0cmljdCBFQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogIyBPdmVydmlldwogICAgICogYG5nUGx1cmFsaXplYCBpcyBhIGRpcmVjdGl2ZSB0aGF0IGRpc3BsYXlzIG1lc3NhZ2VzIGFjY29yZGluZyB0byBlbi1VUyBsb2NhbGl6YXRpb24gcnVsZXMuCiAgICAgKiBUaGVzZSBydWxlcyBhcmUgYnVuZGxlZCB3aXRoIGFuZ3VsYXIuanMsIGJ1dCBjYW4gYmUgb3ZlcnJpZGRlbgogICAgICogKHNlZSB7QGxpbmsgZ3VpZGUvaTE4biBBbmd1bGFyIGkxOG59IGRldiBndWlkZSkuIFlvdSBjb25maWd1cmUgbmdQbHVyYWxpemUgZGlyZWN0aXZlCiAgICAgKiBieSBzcGVjaWZ5aW5nIHRoZSBtYXBwaW5ncyBiZXR3ZWVuCiAgICAgKiB7QGxpbmsgaHR0cDovL3VuaWNvZGUub3JnL3JlcG9zL2NsZHItdG1wL3RydW5rL2RpZmYvc3VwcGxlbWVudGFsL2xhbmd1YWdlX3BsdXJhbF9ydWxlcy5odG1sCiAgICAgKiBwbHVyYWwgY2F0ZWdvcmllc30gYW5kIHRoZSBzdHJpbmdzIHRvIGJlIGRpc3BsYXllZC4KICAgICAqCiAgICAgKiAjIFBsdXJhbCBjYXRlZ29yaWVzIGFuZCBleHBsaWNpdCBudW1iZXIgcnVsZXMKICAgICAqIFRoZXJlIGFyZSB0d28KICAgICAqIHtAbGluayBodHRwOi8vdW5pY29kZS5vcmcvcmVwb3MvY2xkci10bXAvdHJ1bmsvZGlmZi9zdXBwbGVtZW50YWwvbGFuZ3VhZ2VfcGx1cmFsX3J1bGVzLmh0bWwKICAgICAqIHBsdXJhbCBjYXRlZ29yaWVzfSBpbiBBbmd1bGFyJ3MgZGVmYXVsdCBlbi1VUyBsb2NhbGU6ICJvbmUiIGFuZCAib3RoZXIiLgogICAgICoKICAgICAqIFdoaWxlIGEgcGx1cmFsIGNhdGVnb3J5IG1heSBtYXRjaCBtYW55IG51bWJlcnMgKGZvciBleGFtcGxlLCBpbiBlbi1VUyBsb2NhbGUsICJvdGhlciIgY2FuIG1hdGNoCiAgICAgKiBhbnkgbnVtYmVyIHRoYXQgaXMgbm90IDEpLCBhbiBleHBsaWNpdCBudW1iZXIgcnVsZSBjYW4gb25seSBtYXRjaCBvbmUgbnVtYmVyLiBGb3IgZXhhbXBsZSwgdGhlCiAgICAgKiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IgIjMiIG1hdGNoZXMgdGhlIG51bWJlciAzLiBUaGVyZSBhcmUgZXhhbXBsZXMgb2YgcGx1cmFsIGNhdGVnb3JpZXMKICAgICAqIGFuZCBleHBsaWNpdCBudW1iZXIgcnVsZXMgdGhyb3VnaG91dCB0aGUgcmVzdCBvZiB0aGlzIGRvY3VtZW50YXRpb24uCiAgICAgKgogICAgICogIyBDb25maWd1cmluZyBuZ1BsdXJhbGl6ZQogICAgICogWW91IGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZSBieSBwcm92aWRpbmcgMiBhdHRyaWJ1dGVzOiBgY291bnRgIGFuZCBgd2hlbmAuCiAgICAgKiBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCBhdHRyaWJ1dGUsIGBvZmZzZXRgLgogICAgICoKICAgICAqIFRoZSB2YWx1ZSBvZiB0aGUgYGNvdW50YCBhdHRyaWJ1dGUgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvciBhbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbgogICAgICogQW5ndWxhciBleHByZXNzaW9ufTsgdGhlc2UgYXJlIGV2YWx1YXRlZCBvbiB0aGUgY3VycmVudCBzY29wZSBmb3IgaXRzIGJvdW5kIHZhbHVlLgogICAgICoKICAgICAqIFRoZSBgd2hlbmAgYXR0cmlidXRlIHNwZWNpZmllcyB0aGUgbWFwcGluZ3MgYmV0d2VlbiBwbHVyYWwgY2F0ZWdvcmllcyBhbmQgdGhlIGFjdHVhbAogICAgICogc3RyaW5nIHRvIGJlIGRpc3BsYXllZC4gVGhlIHZhbHVlIG9mIHRoZSBhdHRyaWJ1dGUgc2hvdWxkIGJlIGEgSlNPTiBvYmplY3QuCiAgICAgKgogICAgICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNob3dzIGhvdyB0byBjb25maWd1cmUgbmdQbHVyYWxpemU6CiAgICAgKgogICAgICogPHByZT4KICAgICAqIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IgogICAgICAgICAgICAgICAgICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICAgICAqICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAnMSBwZXJzb24gaXMgdmlld2luZy4nLAogICAgICogICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t9IHBlb3BsZSBhcmUgdmlld2luZy4nfSI+CiAgICAgKiA8L25nLXBsdXJhbGl6ZT4KICAgICAqPC9wcmU+CiAgICAgKgogICAgICogSW4gdGhlIGV4YW1wbGUsIGAiMDogTm9ib2R5IGlzIHZpZXdpbmcuImAgaXMgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUuIElmIHlvdSBkaWQgbm90CiAgICAgKiBzcGVjaWZ5IHRoaXMgcnVsZSwgMCB3b3VsZCBiZSBtYXRjaGVkIHRvIHRoZSAib3RoZXIiIGNhdGVnb3J5IGFuZCAiMCBwZW9wbGUgYXJlIHZpZXdpbmciCiAgICAgKiB3b3VsZCBiZSBzaG93biBpbnN0ZWFkIG9mICJOb2JvZHkgaXMgdmlld2luZyIuIFlvdSBjYW4gc3BlY2lmeSBhbiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IKICAgICAqIG90aGVyIG51bWJlcnMsIGZvciBleGFtcGxlIDEyLCBzbyB0aGF0IGluc3RlYWQgb2Ygc2hvd2luZyAiMTIgcGVvcGxlIGFyZSB2aWV3aW5nIiwgeW91IGNhbgogICAgICogc2hvdyAiYSBkb3plbiBwZW9wbGUgYXJlIHZpZXdpbmciLgogICAgICoKICAgICAqIFlvdSBjYW4gdXNlIGEgc2V0IG9mIGNsb3NlZCBicmFjZXMoYHt9YCkgYXMgYSBwbGFjZWhvbGRlciBmb3IgdGhlIG51bWJlciB0aGF0IHlvdSB3YW50IHN1YnN0aXR1dGVkCiAgICAgKiBpbnRvIHBsdXJhbGl6ZWQgc3RyaW5ncy4gSW4gdGhlIHByZXZpb3VzIGV4YW1wbGUsIEFuZ3VsYXIgd2lsbCByZXBsYWNlIGB7fWAgd2l0aAogICAgICogPHNwYW4gbmctbm9uLWJpbmRhYmxlPmB7e3BlcnNvbkNvdW50fX1gPC9zcGFuPi4gVGhlIGNsb3NlZCBicmFjZXMgYHt9YCBpcyBhIHBsYWNlaG9sZGVyCiAgICAgKiBmb3IgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7bnVtYmVyRXhwcmVzc2lvbn19PC9zcGFuPi4KICAgICAqCiAgICAgKiAjIENvbmZpZ3VyaW5nIG5nUGx1cmFsaXplIHdpdGggb2Zmc2V0CiAgICAgKiBUaGUgYG9mZnNldGAgYXR0cmlidXRlIGFsbG93cyBmdXJ0aGVyIGN1c3RvbWl6YXRpb24gb2YgcGx1cmFsaXplZCB0ZXh0LCB3aGljaCBjYW4gcmVzdWx0IGluCiAgICAgKiBhIGJldHRlciB1c2VyIGV4cGVyaWVuY2UuIEZvciBleGFtcGxlLCBpbnN0ZWFkIG9mIHRoZSBtZXNzYWdlICI0IHBlb3BsZSBhcmUgdmlld2luZyB0aGlzIGRvY3VtZW50IiwKICAgICAqIHlvdSBtaWdodCBkaXNwbGF5ICJKb2huLCBLYXRlIGFuZCAyIG90aGVycyBhcmUgdmlld2luZyB0aGlzIGRvY3VtZW50Ii4KICAgICAqIFRoZSBvZmZzZXQgYXR0cmlidXRlIGFsbG93cyB5b3UgdG8gb2Zmc2V0IGEgbnVtYmVyIGJ5IGFueSBkZXNpcmVkIHZhbHVlLgogICAgICogTGV0J3MgdGFrZSBhIGxvb2sgYXQgYW4gZXhhbXBsZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiIG9mZnNldD0yCiAgICAgKiAgICAgICAgICAgICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICogICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogICAgICogICAgICAgICAgICAgICAgICAgICAgJzInOiAne3twZXJzb24xfX0gYW5kIHt7cGVyc29uMn19IGFyZSB2aWV3aW5nLicsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZy4nLAogICAgICogICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICAqIDwvbmctcGx1cmFsaXplPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogTm90aWNlIHRoYXQgd2UgYXJlIHN0aWxsIHVzaW5nIHR3byBwbHVyYWwgY2F0ZWdvcmllcyhvbmUsIG90aGVyKSwgYnV0IHdlIGFkZGVkCiAgICAgKiB0aHJlZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgMCwgMSBhbmQgMi4KICAgICAqIFdoZW4gb25lIHBlcnNvbiwgcGVyaGFwcyBKb2huLCB2aWV3cyB0aGUgZG9jdW1lbnQsICJKb2huIGlzIHZpZXdpbmciIHdpbGwgYmUgc2hvd24uCiAgICAgKiBXaGVuIHRocmVlIHBlb3BsZSB2aWV3IHRoZSBkb2N1bWVudCwgbm8gZXhwbGljaXQgbnVtYmVyIHJ1bGUgaXMgZm91bmQsIHNvCiAgICAgKiBhbiBvZmZzZXQgb2YgMiBpcyB0YWtlbiBvZmYgMywgYW5kIEFuZ3VsYXIgdXNlcyAxIHRvIGRlY2lkZSB0aGUgcGx1cmFsIGNhdGVnb3J5LgogICAgICogSW4gdGhpcyBjYXNlLCBwbHVyYWwgY2F0ZWdvcnkgJ29uZScgaXMgbWF0Y2hlZCBhbmQgIkpvaG4sIE1hcnJ5IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nIgogICAgICogaXMgc2hvd24uCiAgICAgKgogICAgICogTm90ZSB0aGF0IHdoZW4geW91IHNwZWNpZnkgb2Zmc2V0cywgeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yCiAgICAgKiBudW1iZXJzIGZyb20gMCB1cCB0byBhbmQgaW5jbHVkaW5nIHRoZSBvZmZzZXQuIElmIHlvdSB1c2UgYW4gb2Zmc2V0IG9mIDMsIGZvciBleGFtcGxlLAogICAgICogeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yIDAsIDEsIDIgYW5kIDMuIFlvdSBtdXN0IGFsc28gcHJvdmlkZSBwbHVyYWwgc3RyaW5ncyBmb3IKICAgICAqIHBsdXJhbCBjYXRlZ29yaWVzICJvbmUiIGFuZCAib3RoZXIiLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfGV4cHJlc3Npb259IGNvdW50IFRoZSB2YXJpYWJsZSB0byBiZSBib3VuZGVkIHRvLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHdoZW4gVGhlIG1hcHBpbmcgYmV0d2VlbiBwbHVyYWwgY2F0ZWdvcnkgdG8gaXRzIGNvcnJlc3BvbmRpbmcgc3RyaW5ncy4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gb2Zmc2V0IE9mZnNldCB0byBkZWR1Y3QgZnJvbSB0aGUgdG90YWwgbnVtYmVyLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgICRzY29wZS5wZXJzb24xID0gJ0lnb3InOwogICAgICAgICAgICAgICAgJHNjb3BlLnBlcnNvbjIgPSAnTWlza28nOwogICAgICAgICAgICAgICAgJHNjb3BlLnBlcnNvbkNvdW50ID0gMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgICAgIFBlcnNvbiAxOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMSIgdmFsdWU9Iklnb3IiIC8+PGJyLz4KICAgICAgICAgICAgICBQZXJzb24gMjo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbjIiIHZhbHVlPSJNaXNrbyIgLz48YnIvPgogICAgICAgICAgICAgIE51bWJlciBvZiBQZW9wbGU6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb25Db3VudCIgdmFsdWU9IjEiIC8+PGJyLz4KICAgIAogICAgICAgICAgICAgIDwhLS0tIEV4YW1wbGUgd2l0aCBzaW1wbGUgcGx1cmFsaXphdGlvbiBydWxlcyBmb3IgZW4gbG9jYWxlIC0tLT4KICAgICAgICAgICAgICBXaXRob3V0IE9mZnNldDoKICAgICAgICAgICAgICA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAnMSBwZXJzb24gaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgICAgICAgICAgIDwvbmctcGx1cmFsaXplPjxicj4KICAgIAogICAgICAgICAgICAgIDwhLS0tIEV4YW1wbGUgd2l0aCBvZmZzZXQgLS0tPgogICAgICAgICAgICAgIFdpdGggT2Zmc2V0KDIpOgogICAgICAgICAgICAgIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IiBvZmZzZXQ9MgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcyJzogJ3t7cGVyc29uMX19IGFuZCB7e3BlcnNvbjJ9fSBhcmUgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICAgICAgICAgICA8L25nLXBsdXJhbGl6ZT4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICBpdCgnc2hvdWxkIHNob3cgY29ycmVjdCBwbHVyYWxpemVkIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnMSBwZXJzb24gaXMgdmlld2luZy4nKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciBpcyB2aWV3aW5nLicpOwogICAgCiAgICAgICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzAnKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnTm9ib2R5IGlzIHZpZXdpbmcuJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCdOb2JvZHkgaXMgdmlld2luZy4nKTsKICAgIAogICAgICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCcyJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpmaXJzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCdJZ29yIGFuZCBNaXNrbyBhcmUgdmlld2luZy4nKTsKICAgIAogICAgICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCczJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpmaXJzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzMgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCdJZ29yLCBNaXNrbyBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZy4nKTsKICAgIAogICAgICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCc0Jyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpmaXJzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzQgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCdJZ29yLCBNaXNrbyBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICAgIGl0KCdzaG91bGQgc2hvdyBkYXRhLWJpbmRlZCBuYW1lcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCc0Jyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciwgTWlza28gYW5kIDIgb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgCiAgICAgICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbjEnKS5lbnRlcignRGknKTsKICAgICAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgncGVyc29uMicpLmVudGVyKCdWb2p0YScpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgIHRvQmUoJ0RpLCBWb2p0YSBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nUGx1cmFsaXplRGlyZWN0aXZlID0gWyckbG9jYWxlJywgJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uICgkbG9jYWxlLCAkaW50ZXJwb2xhdGUpIHsKICAgICAgICB2YXIgQlJBQ0UgPSAve30vZzsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0VBJywKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyRXhwID0gYXR0ci5jb3VudCwKICAgICAgICAgICAgICAgICAgICB3aGVuRXhwID0gYXR0ci4kYXR0ci53aGVuICYmIGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLndoZW4pLCAvLyB3ZSBoYXZlIHt7fX0gaW4gYXR0cnMKICAgICAgICAgICAgICAgICAgICBvZmZzZXQgPSBhdHRyLm9mZnNldCB8fCAwLAogICAgICAgICAgICAgICAgICAgIHdoZW5zID0gc2NvcGUuJGV2YWwod2hlbkV4cCkgfHwge30sCiAgICAgICAgICAgICAgICAgICAgd2hlbnNFeHBGbnMgPSB7fSwKICAgICAgICAgICAgICAgICAgICBzdGFydFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCgpLAogICAgICAgICAgICAgICAgICAgIGVuZFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2woKSwKICAgICAgICAgICAgICAgICAgICBpc1doZW4gPSAvXndoZW4oTWludXMpPyguKykkLzsKCiAgICAgICAgICAgICAgICBmb3JFYWNoKGF0dHIsIGZ1bmN0aW9uIChleHByZXNzaW9uLCBhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzV2hlbi50ZXN0KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoZW5zW2xvd2VyY2FzZShhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoJ3doZW4nLCAnJykucmVwbGFjZSgnTWludXMnLCAnLScpKV0gPQogICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyW2F0dHJpYnV0ZU5hbWVdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZvckVhY2god2hlbnMsIGZ1bmN0aW9uIChleHByZXNzaW9uLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICB3aGVuc0V4cEZuc1trZXldID0KICAgICAgICAgICAgICAgICAgICAgICRpbnRlcnBvbGF0ZShleHByZXNzaW9uLnJlcGxhY2UoQlJBQ0UsIHN0YXJ0U3ltYm9sICsgbnVtYmVyRXhwICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ICsgZW5kU3ltYm9sKSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdQbHVyYWxpemVXYXRjaCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZUZsb2F0KHNjb3BlLiRldmFsKG51bWJlckV4cCkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvL2lmIGV4cGxpY2l0IG51bWJlciBydWxlIHN1Y2ggYXMgMSwgMiwgMy4uLiBpcyBkZWZpbmVkLCBqdXN0IHVzZSBpdC4gT3RoZXJ3aXNlLAogICAgICAgICAgICAgICAgICAgICAgICAvL2NoZWNrIGl0IGFnYWluc3QgcGx1cmFsaXphdGlvbiBydWxlcyBpbiAkbG9jYWxlIHNlcnZpY2UKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEodmFsdWUgaW4gd2hlbnMpKSB2YWx1ZSA9ICRsb2NhbGUucGx1cmFsQ2F0KHZhbHVlIC0gb2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW5zRXhwRm5zW3ZhbHVlXShzY29wZSwgZWxlbWVudCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2hBY3Rpb24obmV3VmFsKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KG5ld1ZhbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ1JlcGVhdGAgZGlyZWN0aXZlIGluc3RhbnRpYXRlcyBhIHRlbXBsYXRlIG9uY2UgcGVyIGl0ZW0gZnJvbSBhIGNvbGxlY3Rpb24uIEVhY2ggdGVtcGxhdGUKICAgICAqIGluc3RhbmNlIGdldHMgaXRzIG93biBzY29wZSwgd2hlcmUgdGhlIGdpdmVuIGxvb3AgdmFyaWFibGUgaXMgc2V0IHRvIHRoZSBjdXJyZW50IGNvbGxlY3Rpb24gaXRlbSwKICAgICAqIGFuZCBgJGluZGV4YCBpcyBzZXQgdG8gdGhlIGl0ZW0gaW5kZXggb3Iga2V5LgogICAgICoKICAgICAqIFNwZWNpYWwgcHJvcGVydGllcyBhcmUgZXhwb3NlZCBvbiB0aGUgbG9jYWwgc2NvcGUgb2YgZWFjaCB0ZW1wbGF0ZSBpbnN0YW5jZSwgaW5jbHVkaW5nOgogICAgICoKICAgICAqIHwgVmFyaWFibGUgIHwgVHlwZSAgICAgICAgICAgIHwgRGV0YWlscyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAqIHwtLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAqIHwgYCRpbmRleGAgIHwge0B0eXBlIG51bWJlcn0gIHwgaXRlcmF0b3Igb2Zmc2V0IG9mIHRoZSByZXBlYXRlZCBlbGVtZW50ICgwLi5sZW5ndGgtMSkgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAqIHwgYCRmaXJzdGAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBmaXJzdCBpbiB0aGUgaXRlcmF0b3IuICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAqIHwgYCRtaWRkbGVgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBiZXR3ZWVuIHRoZSBmaXJzdCBhbmQgbGFzdCBpbiB0aGUgaXRlcmF0b3IuIHwKICAgICAqIHwgYCRsYXN0YCAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBsYXN0IGluIHRoZSBpdGVyYXRvci4gICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAqIHwgYCRldmVuYCAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgaXRlcmF0b3IgcG9zaXRpb24gYCRpbmRleGAgaXMgZXZlbiAob3RoZXJ3aXNlIGZhbHNlKS4gICAgICAgICAgIHwKICAgICAqIHwgYCRvZGRgICAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgaXRlcmF0b3IgcG9zaXRpb24gYCRpbmRleGAgaXMgb2RkIChvdGhlcndpc2UgZmFsc2UpLiAgICAgICAgICAgIHwKICAgICAqCiAgICAgKgogICAgICogIyBTcGVjaWFsIHJlcGVhdCBzdGFydCBhbmQgZW5kIHBvaW50cwogICAgICogVG8gcmVwZWF0IGEgc2VyaWVzIG9mIGVsZW1lbnRzIGluc3RlYWQgb2YganVzdCBvbmUgcGFyZW50IGVsZW1lbnQsIG5nUmVwZWF0IChhcyB3ZWxsIGFzIG90aGVyIG5nIGRpcmVjdGl2ZXMpIHN1cHBvcnRzIGV4dGVuZGluZwogICAgICogdGhlIHJhbmdlIG9mIHRoZSByZXBlYXRlciBieSBkZWZpbmluZyBleHBsaWNpdCBzdGFydCBhbmQgZW5kIHBvaW50cyBieSB1c2luZyAqKm5nLXJlcGVhdC1zdGFydCoqIGFuZCAqKm5nLXJlcGVhdC1lbmQqKiByZXNwZWN0aXZlbHkuCiAgICAgKiBUaGUgKipuZy1yZXBlYXQtc3RhcnQqKiBkaXJlY3RpdmUgd29ya3MgdGhlIHNhbWUgYXMgKipuZy1yZXBlYXQqKiwgYnV0IHdpbGwgcmVwZWF0IGFsbCB0aGUgSFRNTCBjb2RlIChpbmNsdWRpbmcgdGhlIHRhZyBpdCdzIGRlZmluZWQgb24pCiAgICAgKiB1cCB0byBhbmQgaW5jbHVkaW5nIHRoZSBlbmRpbmcgSFRNTCB0YWcgd2hlcmUgKipuZy1yZXBlYXQtZW5kKiogaXMgcGxhY2VkLgogICAgICoKICAgICAqIFRoZSBleGFtcGxlIGJlbG93IG1ha2VzIHVzZSBvZiB0aGlzIGZlYXR1cmU6CiAgICAgKiA8cHJlPgogICAgICogICA8aGVhZGVyIG5nLXJlcGVhdC1zdGFydD0iaXRlbSBpbiBpdGVtcyI+CiAgICAgKiAgICAgSGVhZGVyIHt7IGl0ZW0gfX0KICAgICAqICAgPC9oZWFkZXI+CiAgICAgKiAgIDxkaXYgY2xhc3M9ImJvZHkiPgogICAgICogICAgIEJvZHkge3sgaXRlbSB9fQogICAgICogICA8L2Rpdj4KICAgICAqICAgPGZvb3RlciBuZy1yZXBlYXQtZW5kPgogICAgICogICAgIEZvb3RlciB7eyBpdGVtIH19CiAgICAgKiAgIDwvZm9vdGVyPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQW5kIHdpdGggYW4gaW5wdXQgb2Yge0B0eXBlIFsnQScsJ0InXX0gZm9yIHRoZSBpdGVtcyB2YXJpYWJsZSBpbiB0aGUgZXhhbXBsZSBhYm92ZSwgdGhlIG91dHB1dCB3aWxsIGV2YWx1YXRlIHRvOgogICAgICogPHByZT4KICAgICAqICAgPGhlYWRlcj4KICAgICAqICAgICBIZWFkZXIgQQogICAgICogICA8L2hlYWRlcj4KICAgICAqICAgPGRpdiBjbGFzcz0iYm9keSI+CiAgICAgKiAgICAgQm9keSBBCiAgICAgKiAgIDwvZGl2PgogICAgICogICA8Zm9vdGVyPgogICAgICogICAgIEZvb3RlciBBCiAgICAgKiAgIDwvZm9vdGVyPgogICAgICogICA8aGVhZGVyPgogICAgICogICAgIEhlYWRlciBCCiAgICAgKiAgIDwvaGVhZGVyPgogICAgICogICA8ZGl2IGNsYXNzPSJib2R5Ij4KICAgICAqICAgICBCb2R5IEIKICAgICAqICAgPC9kaXY+CiAgICAgKiAgIDxmb290ZXI+CiAgICAgKiAgICAgRm9vdGVyIEIKICAgICAqICAgPC9mb290ZXI+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBUaGUgY3VzdG9tIHN0YXJ0IGFuZCBlbmQgcG9pbnRzIGZvciBuZ1JlcGVhdCBhbHNvIHN1cHBvcnQgYWxsIG90aGVyIEhUTUwgZGlyZWN0aXZlIHN5bnRheCBmbGF2b3JzIHByb3ZpZGVkIGluIEFuZ3VsYXJKUyAoc3VjaAogICAgICogYXMgKipkYXRhLW5nLXJlcGVhdC1zdGFydCoqLCAqKngtbmctcmVwZWF0LXN0YXJ0KiogYW5kICoqbmc6cmVwZWF0LXN0YXJ0KiopLgogICAgICoKICAgICAqIEBhbmltYXRpb25zCiAgICAgKiBlbnRlciAtIHdoZW4gYSBuZXcgaXRlbSBpcyBhZGRlZCB0byB0aGUgbGlzdCBvciB3aGVuIGFuIGl0ZW0gaXMgcmV2ZWFsZWQgYWZ0ZXIgYSBmaWx0ZXIKICAgICAqIGxlYXZlIC0gd2hlbiBhbiBpdGVtIGlzIHJlbW92ZWQgZnJvbSB0aGUgbGlzdCBvciB3aGVuIGFuIGl0ZW0gaXMgZmlsdGVyZWQgb3V0CiAgICAgKiBtb3ZlIC0gd2hlbiBhbiBhZGphY2VudCBpdGVtIGlzIGZpbHRlcmVkIG91dCBjYXVzaW5nIGEgcmVvcmRlciBvciB3aGVuIHRoZSBpdGVtIGNvbnRlbnRzIGFyZSByZW9yZGVyZWQKICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBzY29wZQogICAgICogQHByaW9yaXR5IDEwMDAKICAgICAqIEBwYXJhbSB7cmVwZWF0X2V4cHJlc3Npb259IG5nUmVwZWF0IFRoZSBleHByZXNzaW9uIGluZGljYXRpbmcgaG93IHRvIGVudW1lcmF0ZSBhIGNvbGxlY3Rpb24uIFRoZXNlCiAgICAgKiAgIGZvcm1hdHMgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQ6CiAgICAgKgogICAgICogICAqIGB2YXJpYWJsZSBpbiBleHByZXNzaW9uYCDigJMgd2hlcmUgdmFyaWFibGUgaXMgdGhlIHVzZXIgZGVmaW5lZCBsb29wIHZhcmlhYmxlIGFuZCBgZXhwcmVzc2lvbmAKICAgICAqICAgICBpcyBhIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICAgICAqCiAgICAgKiAgICAgRm9yIGV4YW1wbGU6IGBhbGJ1bSBpbiBhcnRpc3QuYWxidW1zYC4KICAgICAqCiAgICAgKiAgICogYChrZXksIHZhbHVlKSBpbiBleHByZXNzaW9uYCDigJMgd2hlcmUgYGtleWAgYW5kIGB2YWx1ZWAgY2FuIGJlIGFueSB1c2VyIGRlZmluZWQgaWRlbnRpZmllcnMsCiAgICAgKiAgICAgYW5kIGBleHByZXNzaW9uYCBpcyB0aGUgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogICAgICoKICAgICAqICAgICBGb3IgZXhhbXBsZTogYChuYW1lLCBhZ2UpIGluIHsnYWRhbSc6MTAsICdhbWFsaWUnOjEyfWAuCiAgICAgKgogICAgICogICAqIGB2YXJpYWJsZSBpbiBleHByZXNzaW9uIHRyYWNrIGJ5IHRyYWNraW5nX2V4cHJlc3Npb25gIOKAkyBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCB0cmFja2luZyBmdW5jdGlvbgogICAgICogICAgIHdoaWNoIGNhbiBiZSB1c2VkIHRvIGFzc29jaWF0ZSB0aGUgb2JqZWN0cyBpbiB0aGUgY29sbGVjdGlvbiB3aXRoIHRoZSBET00gZWxlbWVudHMuIElmIG5vIHRyYWNraW5nIGZ1bmN0aW9uCiAgICAgKiAgICAgaXMgc3BlY2lmaWVkIHRoZSBuZy1yZXBlYXQgYXNzb2NpYXRlcyBlbGVtZW50cyBieSBpZGVudGl0eSBpbiB0aGUgY29sbGVjdGlvbi4gSXQgaXMgYW4gZXJyb3IgdG8gaGF2ZQogICAgICogICAgIG1vcmUgdGhhbiBvbmUgdHJhY2tpbmcgZnVuY3Rpb24gdG8gcmVzb2x2ZSB0byB0aGUgc2FtZSBrZXkuIChUaGlzIHdvdWxkIG1lYW4gdGhhdCB0d28gZGlzdGluY3Qgb2JqZWN0cyBhcmUKICAgICAqICAgICBtYXBwZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQsIHdoaWNoIGlzIG5vdCBwb3NzaWJsZS4pICBGaWx0ZXJzIHNob3VsZCBiZSBhcHBsaWVkIHRvIHRoZSBleHByZXNzaW9uLAogICAgICogICAgIGJlZm9yZSBzcGVjaWZ5aW5nIGEgdHJhY2tpbmcgZXhwcmVzc2lvbi4KICAgICAqCiAgICAgKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zYCBpcyBlcXVpdmFsZW50IHRvIGBpdGVtIGluIGl0ZW1zIHRyYWNrIGJ5ICRpZChpdGVtKScuIFRoaXMgaW1wbGllcyB0aGF0IHRoZSBET00gZWxlbWVudHMKICAgICAqICAgICB3aWxsIGJlIGFzc29jaWF0ZWQgYnkgaXRlbSBpZGVudGl0eSBpbiB0aGUgYXJyYXkuCiAgICAgKgogICAgICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSAkaWQoaXRlbSlgLiBBIGJ1aWx0IGluIGAkaWQoKWAgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gYXNzaWduIGEgdW5pcXVlCiAgICAgKiAgICAgYCQkaGFzaEtleWAgcHJvcGVydHkgdG8gZWFjaCBpdGVtIGluIHRoZSBhcnJheS4gVGhpcyBwcm9wZXJ0eSBpcyB0aGVuIHVzZWQgYXMgYSBrZXkgdG8gYXNzb2NpYXRlZCBET00gZWxlbWVudHMKICAgICAqICAgICB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIGl0ZW0gaW4gdGhlIGFycmF5IGJ5IGlkZW50aXR5LiBNb3ZpbmcgdGhlIHNhbWUgb2JqZWN0IGluIGFycmF5IHdvdWxkIG1vdmUgdGhlIERPTQogICAgICogICAgIGVsZW1lbnQgaW4gdGhlIHNhbWUgd2F5IGlhbiB0aGUgRE9NLgogICAgICoKICAgICAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXMgdHJhY2sgYnkgaXRlbS5pZGAgaXMgYSB0eXBpY2FsIHBhdHRlcm4gd2hlbiB0aGUgaXRlbXMgY29tZSBmcm9tIHRoZSBkYXRhYmFzZS4gSW4gdGhpcwogICAgICogICAgIGNhc2UgdGhlIG9iamVjdCBpZGVudGl0eSBkb2VzIG5vdCBtYXR0ZXIuIFR3byBvYmplY3RzIGFyZSBjb25zaWRlcmVkIGVxdWl2YWxlbnQgYXMgbG9uZyBhcyB0aGVpciBgaWRgCiAgICAgKiAgICAgcHJvcGVydHkgaXMgc2FtZS4KICAgICAqCiAgICAgKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHwgZmlsdGVyOnNlYXJjaFRleHQgdHJhY2sgYnkgaXRlbS5pZGAgaXMgYSBwYXR0ZXJuIHRoYXQgbWlnaHQgYmUgdXNlZCB0byBhcHBseSBhIGZpbHRlcgogICAgICogICAgIHRvIGl0ZW1zIGluIGNvbmp1bmN0aW9uIHdpdGggYSB0cmFja2luZyBleHByZXNzaW9uLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBUaGlzIGV4YW1wbGUgaW5pdGlhbGl6ZXMgdGhlIHNjb3BlIHRvIGEgbGlzdCBvZiBuYW1lcyBhbmQKICAgICAqIHRoZW4gdXNlcyBgbmdSZXBlYXRgIHRvIGRpc3BsYXkgZXZlcnkgcGVyc29uOgogICAgICA8ZXhhbXBsZSBhbmltYXRpb25zPSJ0cnVlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgIDxkaXYgbmctaW5pdD0iZnJpZW5kcyA9IFsKICAgICAgICAgICAge25hbWU6J0pvaG4nLCBhZ2U6MjUsIGdlbmRlcjonYm95J30sCiAgICAgICAgICAgIHtuYW1lOidKZXNzaWUnLCBhZ2U6MzAsIGdlbmRlcjonZ2lybCd9LAogICAgICAgICAgICB7bmFtZTonSm9oYW5uYScsIGFnZToyOCwgZ2VuZGVyOidnaXJsJ30sCiAgICAgICAgICAgIHtuYW1lOidKb3knLCBhZ2U6MTUsIGdlbmRlcjonZ2lybCd9LAogICAgICAgICAgICB7bmFtZTonTWFyeScsIGFnZToyOCwgZ2VuZGVyOidnaXJsJ30sCiAgICAgICAgICAgIHtuYW1lOidQZXRlcicsIGFnZTo5NSwgZ2VuZGVyOidib3knfSwKICAgICAgICAgICAge25hbWU6J1NlYmFzdGlhbicsIGFnZTo1MCwgZ2VuZGVyOidib3knfSwKICAgICAgICAgICAge25hbWU6J0VyaWthJywgYWdlOjI3LCBnZW5kZXI6J2dpcmwnfSwKICAgICAgICAgICAge25hbWU6J1BhdHJpY2snLCBhZ2U6NDAsIGdlbmRlcjonYm95J30sCiAgICAgICAgICAgIHtuYW1lOidTYW1hbnRoYScsIGFnZTo2MCwgZ2VuZGVyOidnaXJsJ30KICAgICAgICAgIF0iPgogICAgICAgICAgICBJIGhhdmUge3tmcmllbmRzLmxlbmd0aH19IGZyaWVuZHMuIFRoZXkgYXJlOgogICAgICAgICAgICA8aW5wdXQgdHlwZT0ic2VhcmNoIiBuZy1tb2RlbD0icSIgcGxhY2Vob2xkZXI9ImZpbHRlciBmcmllbmRzLi4uIiAvPgogICAgICAgICAgICA8dWwgY2xhc3M9ImV4YW1wbGUtYW5pbWF0ZS1jb250YWluZXIiPgogICAgICAgICAgICAgIDxsaSBjbGFzcz0iYW5pbWF0ZS1yZXBlYXQiIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBmaWx0ZXI6cSI+CiAgICAgICAgICAgICAgICBbe3skaW5kZXggKyAxfX1dIHt7ZnJpZW5kLm5hbWV9fSB3aG8gaXMge3tmcmllbmQuYWdlfX0geWVhcnMgb2xkLgogICAgICAgICAgICAgIDwvbGk+CiAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAgICAgLmV4YW1wbGUtYW5pbWF0ZS1jb250YWluZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgICAgICBsaXN0LXN0eWxlOm5vbmU7CiAgICAgICAgICAgIG1hcmdpbjowOwogICAgICAgICAgICBwYWRkaW5nOjA7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5leGFtcGxlLWFuaW1hdGUtY29udGFpbmVyID4gbGkgewogICAgICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgICAgIGxpc3Qtc3R5bGU6bm9uZTsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWVudGVyLAogICAgICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlLAogICAgICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLW1vdmUgewogICAgICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgICAtbW96LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgICAtby10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgICAgdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1lbnRlciB7CiAgICAgICAgICAgIGxpbmUtaGVpZ2h0OjA7CiAgICAgICAgICAgIG9wYWNpdHk6MDsKICAgICAgICAgICAgcGFkZGluZy10b3A6MDsKICAgICAgICAgICAgcGFkZGluZy1ib3R0b206MDsKICAgICAgICAgIH0KICAgICAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogICAgICAgICAgICBsaW5lLWhlaWdodDoyMHB4OwogICAgICAgICAgICBvcGFjaXR5OjE7CiAgICAgICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlIHsKICAgICAgICAgICAgb3BhY2l0eToxOwogICAgICAgICAgICBsaW5lLWhlaWdodDoyMHB4OwogICAgICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgICB9CiAgICAgICAgICAuYW5pbWF0ZS1yZXBlYXQubmctbGVhdmUubmctbGVhdmUtYWN0aXZlIHsKICAgICAgICAgICAgb3BhY2l0eTowOwogICAgICAgICAgICBsaW5lLWhlaWdodDowOwogICAgICAgICAgICBwYWRkaW5nLXRvcDowOwogICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTowOwogICAgICAgICAgfQogICAgCiAgICAgICAgICAuYW5pbWF0ZS1yZXBlYXQubmctbW92ZSB7IH0KICAgICAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1tb3ZlLm5nLW1vdmUtYWN0aXZlIHsgfQogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgaXQoJ3Nob3VsZCByZW5kZXIgaW5pdGlhbCBkYXRhIHNldCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgdmFyIHIgPSB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5yZXBlYXRlcigndWwgbGknKTsKICAgICAgICAgICAgIGV4cGVjdChyLmNvdW50KCkpLnRvQmUoMTApOwogICAgICAgICAgICAgZXhwZWN0KHIucm93KDApKS50b0VxdWFsKFsiMSIsIkpvaG4iLCIyNSJdKTsKICAgICAgICAgICAgIGV4cGVjdChyLnJvdygxKSkudG9FcXVhbChbIjIiLCJKZXNzaWUiLCIzMCJdKTsKICAgICAgICAgICAgIGV4cGVjdChyLnJvdyg5KSkudG9FcXVhbChbIjEwIiwiU2FtYW50aGEiLCI2MCJdKTsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdmcmllbmRzLmxlbmd0aCcpKS50b0JlKCIxMCIpOwogICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgcmVwZWF0ZXIgd2hlbiBmaWx0ZXIgcHJlZGljYXRlIGNoYW5nZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIHZhciByID0gdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykucmVwZWF0ZXIoJ3VsIGxpJyk7CiAgICAgICAgICAgICBleHBlY3Qoci5jb3VudCgpKS50b0JlKDEwKTsKICAgIAogICAgICAgICAgICAgaW5wdXQoJ3EnKS5lbnRlcignbWEnKTsKICAgIAogICAgICAgICAgICAgZXhwZWN0KHIuY291bnQoKSkudG9CZSgyKTsKICAgICAgICAgICAgIGV4cGVjdChyLnJvdygwKSkudG9FcXVhbChbIjEiLCJNYXJ5IiwiMjgiXSk7CiAgICAgICAgICAgICBleHBlY3Qoci5yb3coMSkpLnRvRXF1YWwoWyIyIiwiU2FtYW50aGEiLCI2MCJdKTsKICAgICAgICAgICB9KTsKICAgICAgICAgIDwvZmlsZT4KICAgICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ1JlcGVhdERpcmVjdGl2ZSA9IFsnJHBhcnNlJywgJyRhbmltYXRlJywgZnVuY3Rpb24gKCRwYXJzZSwgJGFuaW1hdGUpIHsKICAgICAgICB2YXIgTkdfUkVNT1ZFRCA9ICckJE5HX1JFTU9WRUQnOwogICAgICAgIHZhciBuZ1JlcGVhdE1pbkVyciA9IG1pbkVycignbmdSZXBlYXQnKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgICAgIHByaW9yaXR5OiAxMDAwLAogICAgICAgICAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIsIGxpbmtlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgkc2NvcGUsICRlbGVtZW50LCAkYXR0cikgewogICAgICAgICAgICAgICAgICAgIHZhciBleHByZXNzaW9uID0gJGF0dHIubmdSZXBlYXQ7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZXhwcmVzc2lvbi5tYXRjaCgvXlxzKiguKylccytpblxzKyguKj8pXHMqKFxzK3RyYWNrXHMrYnlccysoLispXHMqKT8kLyksCiAgICAgICAgICAgICAgICAgICAgICB0cmFja0J5RXhwLCB0cmFja0J5RXhwR2V0dGVyLCB0cmFja0J5SWRGbiwgdHJhY2tCeUlkQXJyYXlGbiwgdHJhY2tCeUlkT2JqRm4sIGxocywgcmhzLCB2YWx1ZUlkZW50aWZpZXIsIGtleUlkZW50aWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICBoYXNoRm5Mb2NhbHMgPSB7ICRpZDogaGFzaEtleSB9OwoKICAgICAgICAgICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5nUmVwZWF0TWluRXJyKCdpZXhwJywgIkV4cGVjdGVkIGV4cHJlc3Npb24gaW4gZm9ybSBvZiAnX2l0ZW1fIGluIF9jb2xsZWN0aW9uX1sgdHJhY2sgYnkgX2lkX10nIGJ1dCBnb3QgJ3swfScuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBleHByZXNzaW9uKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxocyA9IG1hdGNoWzFdOwogICAgICAgICAgICAgICAgICAgIHJocyA9IG1hdGNoWzJdOwogICAgICAgICAgICAgICAgICAgIHRyYWNrQnlFeHAgPSBtYXRjaFs0XTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrQnlFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tCeUV4cEdldHRlciA9ICRwYXJzZSh0cmFja0J5RXhwKTsKICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tCeUlkRm4gPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFzc2lnbiBrZXksIHZhbHVlLCBhbmQgJGluZGV4IHRvIHRoZSBsb2NhbHMgc28gdGhhdCB0aGV5IGNhbiBiZSB1c2VkIGluIGhhc2ggZnVuY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5SWRlbnRpZmllcikgaGFzaEZuTG9jYWxzW2tleUlkZW50aWZpZXJdID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzaEZuTG9jYWxzW3ZhbHVlSWRlbnRpZmllcl0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hGbkxvY2Fscy4kaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cmFja0J5RXhwR2V0dGVyKCRzY29wZSwgaGFzaEZuTG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0cmFja0J5SWRBcnJheUZuID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBoYXNoS2V5KHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0cmFja0J5SWRPYmpGbiA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIG1hdGNoID0gbGhzLm1hdGNoKC9eKD86KFtcJFx3XSspfFwoKFtcJFx3XSspXHMqLFxzKihbXCRcd10rKVwpKSQvKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5nUmVwZWF0TWluRXJyKCdpaWRleHAnLCAiJ19pdGVtXycgaW4gJ19pdGVtXyBpbiBfY29sbGVjdGlvbl8nIHNob3VsZCBiZSBhbiBpZGVudGlmaWVyIG9yICcoX2tleV8sIF92YWx1ZV8pJyBleHByZXNzaW9uLCBidXQgZ290ICd7MH0nLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YWx1ZUlkZW50aWZpZXIgPSBtYXRjaFszXSB8fCBtYXRjaFsxXTsKICAgICAgICAgICAgICAgICAgICBrZXlJZGVudGlmaWVyID0gbWF0Y2hbMl07CgogICAgICAgICAgICAgICAgICAgIC8vIFN0b3JlIGEgbGlzdCBvZiBlbGVtZW50cyBmcm9tIHByZXZpb3VzIHJ1bi4gVGhpcyBpcyBhIGhhc2ggd2hlcmUga2V5IGlzIHRoZSBpdGVtIGZyb20gdGhlCiAgICAgICAgICAgICAgICAgICAgLy8gaXRlcmF0b3IsIGFuZCB0aGUgdmFsdWUgaXMgb2JqZWN0cyB3aXRoIGZvbGxvd2luZyBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgICAgIC8vICAgLSBzY29wZTogYm91bmQgc2NvcGUKICAgICAgICAgICAgICAgICAgICAvLyAgIC0gZWxlbWVudDogcHJldmlvdXMgZWxlbWVudC4KICAgICAgICAgICAgICAgICAgICAvLyAgIC0gaW5kZXg6IHBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RCbG9ja01hcCA9IHt9OwoKICAgICAgICAgICAgICAgICAgICAvL3dhdGNoIHByb3BzCiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaENvbGxlY3Rpb24ocmhzLCBmdW5jdGlvbiBuZ1JlcGVhdEFjdGlvbihjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbmRleCwgbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNOb2RlID0gJGVsZW1lbnRbMF0sICAgICAvLyBjdXJyZW50IHBvc2l0aW9uIG9mIHRoZSBub2RlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm9kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNhbWUgYXMgbGFzdEJsb2NrTWFwIGJ1dCBpdCBoYXMgdGhlIGN1cnJlbnQgc3RhdGUuIEl0IHdpbGwgYmVjb21lIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGFzdEJsb2NrTWFwIG9uIHRoZSBuZXh0IGl0ZXJhdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRCbG9ja01hcCA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlMZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5LCB2YWx1ZSwgLy8ga2V5L3ZhbHVlIG9mIGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tCeUlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbktleXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9jaywgICAgICAgLy8gbGFzdCBvYmplY3QgaW5mb3JtYXRpb24ge3Njb3BlLCBlbGVtZW50LCBpZH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRCbG9ja09yZGVyID0gW107CgoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXlMaWtlKGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uS2V5cyA9IGNvbGxlY3Rpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFja0J5SWRGbiA9IHRyYWNrQnlJZEZuIHx8IHRyYWNrQnlJZEFycmF5Rm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFja0J5SWRGbiA9IHRyYWNrQnlJZEZuIHx8IHRyYWNrQnlJZE9iakZuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgb2JqZWN0LCBleHRyYWN0IGtleXMsIHNvcnQgdGhlbSBhbmQgdXNlIHRvIGRldGVybWluZSBvcmRlciBvZiBpdGVyYXRpb24gb3ZlciBvYmogcHJvcHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3Rpb25LZXlzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbGxlY3Rpb24uaGFzT3duUHJvcGVydHkoa2V5KSAmJiBrZXkuY2hhckF0KDApICE9ICckJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uS2V5cy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbktleXMuc29ydCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBhcnJheUxlbmd0aCA9IGNvbGxlY3Rpb25LZXlzLmxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxvY2F0ZSBleGlzdGluZyBpdGVtcwogICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSBuZXh0QmxvY2tPcmRlci5sZW5ndGggPSBjb2xsZWN0aW9uS2V5cy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gKGNvbGxlY3Rpb24gPT09IGNvbGxlY3Rpb25LZXlzKSA/IGluZGV4IDogY29sbGVjdGlvbktleXNbaW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFja0J5SWQgPSB0cmFja0J5SWRGbihrZXksIHZhbHVlLCBpbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEJsb2NrTWFwLmhhc093blByb3BlcnR5KHRyYWNrQnlJZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9jayA9IGxhc3RCbG9ja01hcFt0cmFja0J5SWRdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGxhc3RCbG9ja01hcFt0cmFja0J5SWRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRCbG9ja01hcFt0cmFja0J5SWRdID0gYmxvY2s7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dEJsb2NrT3JkZXJbaW5kZXhdID0gYmxvY2s7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRCbG9ja01hcC5oYXNPd25Qcm9wZXJ0eSh0cmFja0J5SWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVzdG9yZSBsYXN0QmxvY2tNYXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKG5leHRCbG9ja09yZGVyLCBmdW5jdGlvbiAoYmxvY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrICYmIGJsb2NrLnN0YXJ0Tm9kZSkgbGFzdEJsb2NrTWFwW2Jsb2NrLmlkXSA9IGJsb2NrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBkdXBsaWNhdGUgYW5kIHdlIG5lZWQgdG8gdGhyb3cgYW4gZXJyb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZ1JlcGVhdE1pbkVycignZHVwZXMnLCAiRHVwbGljYXRlcyBpbiBhIHJlcGVhdGVyIGFyZSBub3QgYWxsb3dlZC4gVXNlICd0cmFjayBieScgZXhwcmVzc2lvbiB0byBzcGVjaWZ5IHVuaXF1ZSBrZXlzLiBSZXBlYXRlcjogezB9LCBEdXBsaWNhdGUga2V5OiB7MX0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24sIHRyYWNrQnlJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5ldyBuZXZlciBiZWZvcmUgc2VlbiBibG9jawogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRCbG9ja09yZGVyW2luZGV4XSA9IHsgaWQ6IHRyYWNrQnlJZCB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRCbG9ja01hcFt0cmFja0J5SWRdID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBleGlzdGluZyBpdGVtcwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBsYXN0QmxvY2tNYXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0QmxvY2tNYXAuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrID0gbGFzdEJsb2NrTWFwW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoYmxvY2suZWxlbWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goYmxvY2suZWxlbWVudHMsIGZ1bmN0aW9uIChlbGVtZW50KSB7IGVsZW1lbnRbTkdfUkVNT1ZFRF0gPSB0cnVlIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrLnNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBub3QgdXNpbmcgZm9yRWFjaCBmb3IgcGVyZiByZWFzb25zICh0cnlpbmcgdG8gYXZvaWQgI2NhbGwpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAwLCBsZW5ndGggPSBjb2xsZWN0aW9uS2V5cy5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSAoY29sbGVjdGlvbiA9PT0gY29sbGVjdGlvbktleXMpID8gaW5kZXggOiBjb2xsZWN0aW9uS2V5c1tpbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrID0gbmV4dEJsb2NrT3JkZXJbaW5kZXhdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChibG9jay5zdGFydE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB3ZSBoYXZlIGFscmVhZHkgc2VlbiB0aGlzIG9iamVjdCwgdGhlbiB3ZSBuZWVkIHRvIHJldXNlIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFzc29jaWF0ZWQgc2NvcGUvZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBibG9jay5zY29wZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBwcmV2aW91c05vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG5leHROb2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKG5leHROb2RlICYmIG5leHROb2RlW05HX1JFTU9WRURdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrLnN0YXJ0Tm9kZSA9PSBuZXh0Tm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkbyBub3RoaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXhpc3RpbmcgaXRlbSB3aGljaCBnb3QgbW92ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUubW92ZShibG9jay5lbGVtZW50cywgbnVsbCwganFMaXRlKHByZXZpb3VzTm9kZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05vZGUgPSBibG9jay5lbmROb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBuZXcgaXRlbSB3aGljaCB3ZSBkb24ndCBrbm93IGFib3V0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9ICRzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZVt2YWx1ZUlkZW50aWZpZXJdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5SWRlbnRpZmllcikgY2hpbGRTY29wZVtrZXlJZGVudGlmaWVyXSA9IGtleTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRmaXJzdCA9IChpbmRleCA9PT0gMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRsYXN0ID0gKGluZGV4ID09PSAoYXJyYXlMZW5ndGggLSAxKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRtaWRkbGUgPSAhKGNoaWxkU2NvcGUuJGZpcnN0IHx8IGNoaWxkU2NvcGUuJGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kb2RkID0gIShjaGlsZFNjb3BlLiRldmVuID0gaW5kZXggJSAyID09IDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYmxvY2suc3RhcnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua2VyKGNoaWxkU2NvcGUsIGZ1bmN0aW9uIChjbG9uZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjbG9uZSwgbnVsbCwganFMaXRlKHByZXZpb3VzTm9kZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05vZGUgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2suc2NvcGUgPSBjaGlsZFNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9jay5zdGFydE5vZGUgPSBjbG9uZVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2suZWxlbWVudHMgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2suZW5kTm9kZSA9IGNsb25lW2Nsb25lLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0QmxvY2tNYXBbYmxvY2suaWRdID0gYmxvY2s7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEJsb2NrTWFwID0gbmV4dEJsb2NrTWFwOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1Nob3cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdTaG93YCBkaXJlY3RpdmUgc2hvd3MgYW5kIGhpZGVzIHRoZSBnaXZlbiBIVE1MIGVsZW1lbnQgY29uZGl0aW9uYWxseSBiYXNlZCBvbiB0aGUgZXhwcmVzc2lvbgogICAgICogcHJvdmlkZWQgdG8gdGhlIG5nU2hvdyBhdHRyaWJ1dGUuIFRoZSBzaG93IGFuZCBoaWRlIG1lY2hhbmlzbSBpcyBhIGFjaGlldmVkIGJ5IHJlbW92aW5nIGFuZCBhZGRpbmcKICAgICAqIHRoZSBgbmctaGlkZWAgQ1NTIGNsYXNzIG9udG8gdGhlIGVsZW1lbnQuIFRoZSBgLm5nLWhpZGVgIENTUyBjbGFzcyBpcyBhIHByZWRlZmluZWQgQ1NTIGNsYXNzIHByZXNlbnQKICAgICAqIGluIEFuZ3VsYXJKUyB3aGljaCBzZXRzIHRoZSBkaXNwbGF5IHN0eWxlIHRvIG5vbmUgKHVzaW5nIGFuICFpbXBvcnRhbnQgZmxhZykuCiAgICAgKgogICAgICogPHByZT4KICAgICAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyB0cnV0aHkgKGVsZW1lbnQgaXMgdmlzaWJsZSkgLS0+CiAgICAgKiA8ZGl2IG5nLXNob3c9Im15VmFsdWUiPjwvZGl2PgogICAgICoKICAgICAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyBmYWxzeSAoZWxlbWVudCBpcyBoaWRkZW4pIC0tPgogICAgICogPGRpdiBuZy1zaG93PSJteVZhbHVlIiBjbGFzcz0ibmctaGlkZSI+PC9kaXY+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBXaGVuIHRoZSBuZ1Nob3cgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gZmFsc2UgdGhlbiB0aGUgbmctaGlkZSBDU1MgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGNsYXNzIGF0dHJpYnV0ZQogICAgICogb24gdGhlIGVsZW1lbnQgY2F1c2luZyBpdCB0byBiZWNvbWUgaGlkZGVuLiBXaGVuIHRydWUsIHRoZSBuZy1oaWRlIENTUyBjbGFzcyBpcyByZW1vdmVkCiAgICAgKiBmcm9tIHRoZSBlbGVtZW50IGNhdXNpbmcgdGhlIGVsZW1lbnQgbm90IHRvIGFwcGVhciBoaWRkZW4uCiAgICAgKgogICAgICogIyMgV2h5IGlzICFpbXBvcnRhbnQgdXNlZD8KICAgICAqCiAgICAgKiBZb3UgbWF5IGJlIHdvbmRlcmluZyB3aHkgIWltcG9ydGFudCBpcyB1c2VkIGZvciB0aGUgLm5nLWhpZGUgQ1NTIGNsYXNzLiBUaGlzIGlzIGJlY2F1c2UgdGhlIGAubmctaGlkZWAgc2VsZWN0b3IKICAgICAqIGNhbiBiZSBlYXNpbHkgb3ZlcnJpZGRlbiBieSBoZWF2aWVyIHNlbGVjdG9ycy4gRm9yIGV4YW1wbGUsIHNvbWV0aGluZyBhcyBzaW1wbGUKICAgICAqIGFzIGNoYW5naW5nIHRoZSBkaXNwbGF5IHN0eWxlIG9uIGEgSFRNTCBsaXN0IGl0ZW0gd291bGQgbWFrZSBoaWRkZW4gZWxlbWVudHMgYXBwZWFyIHZpc2libGUuCiAgICAgKiBUaGlzIGFsc28gYmVjb21lcyBhIGJpZ2dlciBpc3N1ZSB3aGVuIGRlYWxpbmcgd2l0aCBDU1MgZnJhbWV3b3Jrcy4KICAgICAqCiAgICAgKiBCeSB1c2luZyAhaW1wb3J0YW50LCB0aGUgc2hvdyBhbmQgaGlkZSBiZWhhdmlvciB3aWxsIHdvcmsgYXMgZXhwZWN0ZWQgZGVzcGl0ZSBhbnkgY2xhc2ggYmV0d2VlbiBDU1Mgc2VsZWN0b3IKICAgICAqIHNwZWNpZmljaXR5ICh3aGVuICFpbXBvcnRhbnQgaXNuJ3QgdXNlZCB3aXRoIGFueSBjb25mbGljdGluZyBzdHlsZXMpLiBJZiBhIGRldmVsb3BlciBjaG9vc2VzIHRvIG92ZXJyaWRlIHRoZQogICAgICogc3R5bGluZyB0byBjaGFuZ2UgaG93IHRvIGhpZGUgYW4gZWxlbWVudCB0aGVuIGl0IGlzIGp1c3QgYSBtYXR0ZXIgb2YgdXNpbmcgIWltcG9ydGFudCBpbiB0aGVpciBvd24gQ1NTIGNvZGUuCiAgICAgKgogICAgICogIyMjIE92ZXJyaWRpbmcgLm5nLWhpZGUKICAgICAqCiAgICAgKiBJZiB5b3Ugd2lzaCB0byBjaGFuZ2UgdGhlIGhpZGUgYmVoYXZpb3Igd2l0aCBuZ1Nob3cvbmdIaWRlIHRoZW4gdGhpcyBjYW4gYmUgYWNoaWV2ZWQgYnkKICAgICAqIHJlc3RhdGluZyB0aGUgc3R5bGVzIGZvciB0aGUgLm5nLWhpZGUgY2xhc3MgaW4gQ1NTOgogICAgICogPHByZT4KICAgICAqIC5uZy1oaWRlIHsKICAgICAqICAgLy8hYW5ub3RhdGUgQ1NTIFNwZWNpZmljaXR5fE5vdCB0byB3b3JyeSwgdGhpcyB3aWxsIG92ZXJyaWRlIHRoZSBBbmd1bGFySlMgZGVmYXVsdC4uLgogICAgICogICBkaXNwbGF5OmJsb2NrIWltcG9ydGFudDsKICAgICAqCiAgICAgKiAgIC8vdGhpcyBpcyBqdXN0IGFub3RoZXIgZm9ybSBvZiBoaWRpbmcgYW4gZWxlbWVudAogICAgICogICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgICAqICAgdG9wOi05OTk5cHg7CiAgICAgKiAgIGxlZnQ6LTk5OTlweDsKICAgICAqIH0KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEp1c3QgcmVtZW1iZXIgdG8gaW5jbHVkZSB0aGUgaW1wb3J0YW50IGZsYWcgc28gdGhlIENTUyBvdmVycmlkZSB3aWxsIGZ1bmN0aW9uLgogICAgICoKICAgICAqICMjIEEgbm90ZSBhYm91dCBhbmltYXRpb25zIHdpdGggbmdTaG93CiAgICAgKgogICAgICogQW5pbWF0aW9ucyBpbiBuZ1Nob3cvbmdIaWRlIHdvcmsgd2l0aCB0aGUgc2hvdyBhbmQgaGlkZSBldmVudHMgdGhhdCBhcmUgdHJpZ2dlcmVkIHdoZW4gdGhlIGRpcmVjdGl2ZSBleHByZXNzaW9uCiAgICAgKiBpcyB0cnVlIGFuZCBmYWxzZS4gVGhpcyBzeXN0ZW0gd29ya3Mgc2ltaWxhciB0byB0aGUgYW5pbWF0aW9uIHN5c3RlbSBwcmVzZW50IHdpdGggbmdDbGFzcywgaG93ZXZlciwgdGhlCiAgICAgKiBvbmx5IGRpZmZlcmVuY2UgaXMgdGhhdCB5b3UgbXVzdCBhbHNvIGluY2x1ZGUgdGhlICFpbXBvcnRhbnQgZmxhZyB0byBvdmVycmlkZSB0aGUgZGlzcGxheSBwcm9wZXJ0eSBzbwogICAgICogdGhhdCB5b3UgY2FuIHBlcmZvcm0gYW4gYW5pbWF0aW9uIHdoZW4gdGhlIGVsZW1lbnQgaXMgaGlkZGVuIGR1cmluZyB0aGUgdGltZSBvZiB0aGUgYW5pbWF0aW9uLgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAvLwogICAgICogLy9hIHdvcmtpbmcgZXhhbXBsZSBjYW4gYmUgZm91bmQgYXQgdGhlIGJvdHRvbSBvZiB0aGlzIHBhZ2UKICAgICAqIC8vCiAgICAgKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCwgLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgewogICAgICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICAgICAqICAgZGlzcGxheTpibG9jayFpbXBvcnRhbnQ7CiAgICAgKiB9CiAgICAgKgogICAgICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQgeyAuLi4gfQogICAgICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQubmctaGlkZS1hZGQtYWN0aXZlIHsgLi4uIH0KICAgICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsgLi4uIH0KICAgICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlLm5nLWhpZGUtcmVtb3ZlLWFjdGl2ZSB7IC4uLiB9CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAYW5pbWF0aW9ucwogICAgICogYWRkQ2xhc3M6IC5uZy1oaWRlIC0gaGFwcGVucyBhZnRlciB0aGUgbmdTaG93IGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgdHJ1dGh5IHZhbHVlIGFuZCB0aGUganVzdCBiZWZvcmUgY29udGVudHMgYXJlIHNldCB0byB2aXNpYmxlCiAgICAgKiByZW1vdmVDbGFzczogLm5nLWhpZGUgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ1Nob3cgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSBub24gdHJ1dGh5IHZhbHVlIGFuZCBqdXN0IGJlZm9yZSB0aGUgY29udGVudHMgYXJlIHNldCB0byBoaWRkZW4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTaG93IElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHkKICAgICAqICAgICB0aGVuIHRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiByZXNwZWN0aXZlbHkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgPGV4YW1wbGUgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgIFNob3c6CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNoZWNrLWVsZW1lbnQgYW5pbWF0ZS1zaG93IiBuZy1zaG93PSJjaGVja2VkIj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaWNvbi10aHVtYnMtdXAiPjwvc3Bhbj4gSSBzaG93IHVwIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdj4KICAgICAgICAgICAgSGlkZToKICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hlY2stZWxlbWVudCBhbmltYXRlLXNob3ciIG5nLWhpZGU9ImNoZWNrZWQiPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uLXRodW1icy1kb3duIj48L3NwYW4+IEkgaGlkZSB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAgICAgLmFuaW1hdGUtc2hvdy5uZy1oaWRlLWFkZCwgCiAgICAgICAgICAuYW5pbWF0ZS1zaG93Lm5nLWhpZGUtcmVtb3ZlIHsKICAgICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgICAgLW1vei10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgICAgLW8tdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgICBkaXNwbGF5OmJsb2NrIWltcG9ydGFudDsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmFuaW1hdGUtc2hvdy5uZy1oaWRlLWFkZC5uZy1oaWRlLWFkZC1hY3RpdmUsCiAgICAgICAgICAuYW5pbWF0ZS1zaG93Lm5nLWhpZGUtcmVtb3ZlIHsKICAgICAgICAgICAgbGluZS1oZWlnaHQ6MDsKICAgICAgICAgICAgb3BhY2l0eTowOwogICAgICAgICAgICBwYWRkaW5nOjAgMTBweDsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmFuaW1hdGUtc2hvdy5uZy1oaWRlLWFkZCwKICAgICAgICAgIC5hbmltYXRlLXNob3cubmctaGlkZS1yZW1vdmUubmctaGlkZS1yZW1vdmUtYWN0aXZlIHsKICAgICAgICAgICAgbGluZS1oZWlnaHQ6MjBweDsKICAgICAgICAgICAgb3BhY2l0eToxOwogICAgICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5jaGVjay1lbGVtZW50IHsKICAgICAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgICAgfQogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zaG93IC8gbmctaGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmxhc3Q6dmlzaWJsZScpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAKICAgICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgIAogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6dmlzaWJsZScpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ1Nob3dEaXJlY3RpdmUgPSBbJyRhbmltYXRlJywgZnVuY3Rpb24gKCRhbmltYXRlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1Nob3csIGZ1bmN0aW9uIG5nU2hvd1dhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAkYW5pbWF0ZVt0b0Jvb2xlYW4odmFsdWUpID8gJ3JlbW92ZUNsYXNzJyA6ICdhZGRDbGFzcyddKGVsZW1lbnQsICduZy1oaWRlJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICB9XTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdIaWRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nSGlkZWAgZGlyZWN0aXZlIHNob3dzIGFuZCBoaWRlcyB0aGUgZ2l2ZW4gSFRNTCBlbGVtZW50IGNvbmRpdGlvbmFsbHkgYmFzZWQgb24gdGhlIGV4cHJlc3Npb24KICAgICAqIHByb3ZpZGVkIHRvIHRoZSBuZ0hpZGUgYXR0cmlidXRlLiBUaGUgc2hvdyBhbmQgaGlkZSBtZWNoYW5pc20gaXMgYSBhY2hpZXZlZCBieSByZW1vdmluZyBhbmQgYWRkaW5nCiAgICAgKiB0aGUgYG5nLWhpZGVgIENTUyBjbGFzcyBvbnRvIHRoZSBlbGVtZW50LiBUaGUgYC5uZy1oaWRlYCBDU1MgY2xhc3MgaXMgYSBwcmVkZWZpbmVkIENTUyBjbGFzcyBwcmVzZW50CiAgICAgKiBpbiBBbmd1bGFySlMgd2hpY2ggc2V0cyB0aGUgZGlzcGxheSBzdHlsZSB0byBub25lICh1c2luZyBhbiAhaW1wb3J0YW50IGZsYWcpLgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiA8IS0tIHdoZW4gJHNjb3BlLm15VmFsdWUgaXMgdHJ1dGh5IChlbGVtZW50IGlzIGhpZGRlbikgLS0+CiAgICAgKiA8ZGl2IG5nLWhpZGU9Im15VmFsdWUiPjwvZGl2PgogICAgICoKICAgICAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyBmYWxzeSAoZWxlbWVudCBpcyB2aXNpYmxlKSAtLT4KICAgICAqIDxkaXYgbmctaGlkZT0ibXlWYWx1ZSIgY2xhc3M9Im5nLWhpZGUiPjwvZGl2PgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogV2hlbiB0aGUgbmdIaWRlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUgdGhlbiB0aGUgLm5nLWhpZGUgQ1NTIGNsYXNzIGlzIGFkZGVkIHRvIHRoZSBjbGFzcyBhdHRyaWJ1dGUKICAgICAqIG9uIHRoZSBlbGVtZW50IGNhdXNpbmcgaXQgdG8gYmVjb21lIGhpZGRlbi4gV2hlbiBmYWxzZSwgdGhlIG5nLWhpZGUgQ1NTIGNsYXNzIGlzIHJlbW92ZWQKICAgICAqIGZyb20gdGhlIGVsZW1lbnQgY2F1c2luZyB0aGUgZWxlbWVudCBub3QgdG8gYXBwZWFyIGhpZGRlbi4KICAgICAqCiAgICAgKiAjIyBXaHkgaXMgIWltcG9ydGFudCB1c2VkPwogICAgICoKICAgICAqIFlvdSBtYXkgYmUgd29uZGVyaW5nIHdoeSAhaW1wb3J0YW50IGlzIHVzZWQgZm9yIHRoZSAubmctaGlkZSBDU1MgY2xhc3MuIFRoaXMgaXMgYmVjYXVzZSB0aGUgYC5uZy1oaWRlYCBzZWxlY3RvcgogICAgICogY2FuIGJlIGVhc2lseSBvdmVycmlkZGVuIGJ5IGhlYXZpZXIgc2VsZWN0b3JzLiBGb3IgZXhhbXBsZSwgc29tZXRoaW5nIGFzIHNpbXBsZQogICAgICogYXMgY2hhbmdpbmcgdGhlIGRpc3BsYXkgc3R5bGUgb24gYSBIVE1MIGxpc3QgaXRlbSB3b3VsZCBtYWtlIGhpZGRlbiBlbGVtZW50cyBhcHBlYXIgdmlzaWJsZS4KICAgICAqIFRoaXMgYWxzbyBiZWNvbWVzIGEgYmlnZ2VyIGlzc3VlIHdoZW4gZGVhbGluZyB3aXRoIENTUyBmcmFtZXdvcmtzLgogICAgICoKICAgICAqIEJ5IHVzaW5nICFpbXBvcnRhbnQsIHRoZSBzaG93IGFuZCBoaWRlIGJlaGF2aW9yIHdpbGwgd29yayBhcyBleHBlY3RlZCBkZXNwaXRlIGFueSBjbGFzaCBiZXR3ZWVuIENTUyBzZWxlY3RvcgogICAgICogc3BlY2lmaWNpdHkgKHdoZW4gIWltcG9ydGFudCBpc24ndCB1c2VkIHdpdGggYW55IGNvbmZsaWN0aW5nIHN0eWxlcykuIElmIGEgZGV2ZWxvcGVyIGNob29zZXMgdG8gb3ZlcnJpZGUgdGhlCiAgICAgKiBzdHlsaW5nIHRvIGNoYW5nZSBob3cgdG8gaGlkZSBhbiBlbGVtZW50IHRoZW4gaXQgaXMganVzdCBhIG1hdHRlciBvZiB1c2luZyAhaW1wb3J0YW50IGluIHRoZWlyIG93biBDU1MgY29kZS4KICAgICAqCiAgICAgKiAjIyMgT3ZlcnJpZGluZyAubmctaGlkZQogICAgICoKICAgICAqIElmIHlvdSB3aXNoIHRvIGNoYW5nZSB0aGUgaGlkZSBiZWhhdmlvciB3aXRoIG5nU2hvdy9uZ0hpZGUgdGhlbiB0aGlzIGNhbiBiZSBhY2hpZXZlZCBieQogICAgICogcmVzdGF0aW5nIHRoZSBzdHlsZXMgZm9yIHRoZSAubmctaGlkZSBjbGFzcyBpbiBDU1M6CiAgICAgKiA8cHJlPgogICAgICogLm5nLWhpZGUgewogICAgICogICAvLyFhbm5vdGF0ZSBDU1MgU3BlY2lmaWNpdHl8Tm90IHRvIHdvcnJ5LCB0aGlzIHdpbGwgb3ZlcnJpZGUgdGhlIEFuZ3VsYXJKUyBkZWZhdWx0Li4uCiAgICAgKiAgIGRpc3BsYXk6YmxvY2shaW1wb3J0YW50OwogICAgICoKICAgICAqICAgLy90aGlzIGlzIGp1c3QgYW5vdGhlciBmb3JtIG9mIGhpZGluZyBhbiBlbGVtZW50CiAgICAgKiAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgICogICB0b3A6LTk5OTlweDsKICAgICAqICAgbGVmdDotOTk5OXB4OwogICAgICogfQogICAgICogPC9wcmU+CiAgICAgKgogICAgICogSnVzdCByZW1lbWJlciB0byBpbmNsdWRlIHRoZSBpbXBvcnRhbnQgZmxhZyBzbyB0aGUgQ1NTIG92ZXJyaWRlIHdpbGwgZnVuY3Rpb24uCiAgICAgKgogICAgICogIyMgQSBub3RlIGFib3V0IGFuaW1hdGlvbnMgd2l0aCBuZ0hpZGUKICAgICAqCiAgICAgKiBBbmltYXRpb25zIGluIG5nU2hvdy9uZ0hpZGUgd29yayB3aXRoIHRoZSBzaG93IGFuZCBoaWRlIGV2ZW50cyB0aGF0IGFyZSB0cmlnZ2VyZWQgd2hlbiB0aGUgZGlyZWN0aXZlIGV4cHJlc3Npb24KICAgICAqIGlzIHRydWUgYW5kIGZhbHNlLiBUaGlzIHN5c3RlbSB3b3JrcyBzaW1pbGFyIHRvIHRoZSBhbmltYXRpb24gc3lzdGVtIHByZXNlbnQgd2l0aCBuZ0NsYXNzLCBob3dldmVyLCB0aGUKICAgICAqIG9ubHkgZGlmZmVyZW5jZSBpcyB0aGF0IHlvdSBtdXN0IGFsc28gaW5jbHVkZSB0aGUgIWltcG9ydGFudCBmbGFnIHRvIG92ZXJyaWRlIHRoZSBkaXNwbGF5IHByb3BlcnR5IHNvCiAgICAgKiB0aGF0IHlvdSBjYW4gcGVyZm9ybSBhbiBhbmltYXRpb24gd2hlbiB0aGUgZWxlbWVudCBpcyBoaWRkZW4gZHVyaW5nIHRoZSB0aW1lIG9mIHRoZSBhbmltYXRpb24uCiAgICAgKgogICAgICogPHByZT4KICAgICAqIC8vCiAgICAgKiAvL2Egd29ya2luZyBleGFtcGxlIGNhbiBiZSBmb3VuZCBhdCB0aGUgYm90dG9tIG9mIHRoaXMgcGFnZQogICAgICogLy8KICAgICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkLCAubXktZWxlbWVudC5uZy1oaWRlLXJlbW92ZSB7CiAgICAgKiAgIHRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogICAgICogICBkaXNwbGF5OmJsb2NrIWltcG9ydGFudDsKICAgICAqIH0KICAgICAqCiAgICAgKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCB7IC4uLiB9CiAgICAgKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZC5uZy1oaWRlLWFkZC1hY3RpdmUgeyAuLi4gfQogICAgICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgeyAuLi4gfQogICAgICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUubmctaGlkZS1yZW1vdmUtYWN0aXZlIHsgLi4uIH0KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBhbmltYXRpb25zCiAgICAgKiByZW1vdmVDbGFzczogLm5nLWhpZGUgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ0hpZGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSB0cnV0aHkgdmFsdWUgYW5kIGp1c3QgYmVmb3JlIHRoZSBjb250ZW50cyBhcmUgc2V0IHRvIGhpZGRlbgogICAgICogYWRkQ2xhc3M6IC5uZy1oaWRlIC0gaGFwcGVucyBhZnRlciB0aGUgbmdIaWRlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgbm9uIHRydXRoeSB2YWx1ZSBhbmQganVzdCBiZWZvcmUgdGhlIGNvbnRlbnRzIGFyZSBzZXQgdG8gdmlzaWJsZQogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0hpZGUgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSB0aGVuCiAgICAgKiAgICAgdGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIHJlc3BlY3RpdmVseS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBhbmltYXRpb25zPSJ0cnVlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgICAgICAgPGRpdj4KICAgICAgICAgICAgU2hvdzoKICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hlY2stZWxlbWVudCBhbmltYXRlLWhpZGUiIG5nLXNob3c9ImNoZWNrZWQiPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uLXRodW1icy11cCI+PC9zcGFuPiBJIHNob3cgdXAgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2PgogICAgICAgICAgICBIaWRlOgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGVjay1lbGVtZW50IGFuaW1hdGUtaGlkZSIgbmctaGlkZT0iY2hlY2tlZCI+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9Imljb24tdGh1bWJzLWRvd24iPjwvc3Bhbj4gSSBoaWRlIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgICAgICAuYW5pbWF0ZS1oaWRlLm5nLWhpZGUtYWRkLCAKICAgICAgICAgIC5hbmltYXRlLWhpZGUubmctaGlkZS1yZW1vdmUgewogICAgICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgICAtbW96LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgICAtby10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgICAgdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICAgIGRpc3BsYXk6YmxvY2shaW1wb3J0YW50OwogICAgICAgICAgfQogICAgCiAgICAgICAgICAuYW5pbWF0ZS1oaWRlLm5nLWhpZGUtYWRkLm5nLWhpZGUtYWRkLWFjdGl2ZSwKICAgICAgICAgIC5hbmltYXRlLWhpZGUubmctaGlkZS1yZW1vdmUgewogICAgICAgICAgICBsaW5lLWhlaWdodDowOwogICAgICAgICAgICBvcGFjaXR5OjA7CiAgICAgICAgICAgIHBhZGRpbmc6MCAxMHB4OwogICAgICAgICAgfQogICAgCiAgICAgICAgICAuYW5pbWF0ZS1oaWRlLm5nLWhpZGUtYWRkLAogICAgICAgICAgLmFuaW1hdGUtaGlkZS5uZy1oaWRlLXJlbW92ZS5uZy1oaWRlLXJlbW92ZS1hY3RpdmUgewogICAgICAgICAgICBsaW5lLWhlaWdodDoyMHB4OwogICAgICAgICAgICBvcGFjaXR5OjE7CiAgICAgICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICAgICAgYm9yZGVyOjFweCBzb2xpZCBibGFjazsKICAgICAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmNoZWNrLWVsZW1lbnQgewogICAgICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgICB9CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXNob3cgLyBuZy1oaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgLmNoZWNrLWVsZW1lbnQ6Zmlyc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAuY2hlY2stZWxlbWVudDpsYXN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgCiAgICAgICAgICAgICBpbnB1dCgnY2hlY2tlZCcpLmNoZWNrKCk7CiAgICAKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAuY2hlY2stZWxlbWVudDpmaXJzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAuY2hlY2stZWxlbWVudDpsYXN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0hpZGVEaXJlY3RpdmUgPSBbJyRhbmltYXRlJywgZnVuY3Rpb24gKCRhbmltYXRlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ0hpZGUsIGZ1bmN0aW9uIG5nSGlkZVdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAkYW5pbWF0ZVt0b0Jvb2xlYW4odmFsdWUpID8gJ2FkZENsYXNzJyA6ICdyZW1vdmVDbGFzcyddKGVsZW1lbnQsICduZy1oaWRlJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1N0eWxlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nU3R5bGVgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNldCBDU1Mgc3R5bGUgb24gYW4gSFRNTCBlbGVtZW50IGNvbmRpdGlvbmFsbHkuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU3R5bGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gd2hpY2ggZXZhbHMgdG8gYW4KICAgICAqICAgICAgb2JqZWN0IHdob3NlIGtleXMgYXJlIENTUyBzdHlsZSBuYW1lcyBhbmQgdmFsdWVzIGFyZSBjb3JyZXNwb25kaW5nIHZhbHVlcyBmb3IgdGhvc2UgQ1NTCiAgICAgKiAgICAgIGtleXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxleGFtcGxlPgogICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCIgbmctY2xpY2s9Im15U3R5bGU9e2NvbG9yOidyZWQnfSI+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmctY2xpY2s9Im15U3R5bGU9e30iPgogICAgICAgICAgICA8YnIvPgogICAgICAgICAgICA8c3BhbiBuZy1zdHlsZT0ibXlTdHlsZSI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgICAgICAgICAgIDxwcmU+bXlTdHlsZT17e215U3R5bGV9fTwvcHJlPgogICAgICAgICA8L2ZpbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgICAgICAgc3BhbiB7CiAgICAgICAgICAgICBjb2xvcjogYmxhY2s7CiAgICAgICAgICAgfQogICAgICAgICA8L2ZpbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXN0eWxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnY29sb3InKSkudG9CZSgncmdiKDAsIDAsIDApJyk7CiAgICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uW3ZhbHVlPXNldF0nKS5jbGljaygpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5jc3MoJ2NvbG9yJykpLnRvQmUoJ3JnYigyNTUsIDAsIDApJyk7CiAgICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uW3ZhbHVlPWNsZWFyXScpLmNsaWNrKCk7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnY29sb3InKSkudG9CZSgncmdiKDAsIDAsIDApJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZmlsZT4KICAgICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nU3R5bGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZShmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1N0eWxlLCBmdW5jdGlvbiBuZ1N0eWxlV2F0Y2hBY3Rpb24obmV3U3R5bGVzLCBvbGRTdHlsZXMpIHsKICAgICAgICAgICAgaWYgKG9sZFN0eWxlcyAmJiAobmV3U3R5bGVzICE9PSBvbGRTdHlsZXMpKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG9sZFN0eWxlcywgZnVuY3Rpb24gKHZhbCwgc3R5bGUpIHsgZWxlbWVudC5jc3Moc3R5bGUsICcnKTsgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld1N0eWxlcykgZWxlbWVudC5jc3MobmV3U3R5bGVzKTsKICAgICAgICB9LCB0cnVlKTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nU3dpdGNoCiAgICAgKiBAcmVzdHJpY3QgRUEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBuZ1N3aXRjaCBkaXJlY3RpdmUgaXMgdXNlZCB0byBjb25kaXRpb25hbGx5IHN3YXAgRE9NIHN0cnVjdHVyZSBvbiB5b3VyIHRlbXBsYXRlIGJhc2VkIG9uIGEgc2NvcGUgZXhwcmVzc2lvbi4KICAgICAqIEVsZW1lbnRzIHdpdGhpbiBuZ1N3aXRjaCBidXQgd2l0aG91dCBuZ1N3aXRjaFdoZW4gb3IgbmdTd2l0Y2hEZWZhdWx0IGRpcmVjdGl2ZXMgd2lsbCBiZSBwcmVzZXJ2ZWQgYXQgdGhlIGxvY2F0aW9uCiAgICAgKiBhcyBzcGVjaWZpZWQgaW4gdGhlIHRlbXBsYXRlLgogICAgICoKICAgICAqIFRoZSBkaXJlY3RpdmUgaXRzZWxmIHdvcmtzIHNpbWlsYXIgdG8gbmdJbmNsdWRlLCBob3dldmVyLCBpbnN0ZWFkIG9mIGRvd25sb2FkaW5nIHRlbXBsYXRlIGNvZGUgKG9yIGxvYWRpbmcgaXQKICAgICAqIGZyb20gdGhlIHRlbXBsYXRlIGNhY2hlKSwgbmdTd2l0Y2ggc2ltcGx5IGNob3NlcyBvbmUgb2YgdGhlIG5lc3RlZCBlbGVtZW50cyBhbmQgbWFrZXMgaXQgdmlzaWJsZSBiYXNlZCBvbiB3aGljaCBlbGVtZW50CiAgICAgKiBtYXRjaGVzIHRoZSB2YWx1ZSBvYnRhaW5lZCBmcm9tIHRoZSBldmFsdWF0ZWQgZXhwcmVzc2lvbi4gSW4gb3RoZXIgd29yZHMsIHlvdSBkZWZpbmUgYSBjb250YWluZXIgZWxlbWVudAogICAgICogKHdoZXJlIHlvdSBwbGFjZSB0aGUgZGlyZWN0aXZlKSwgcGxhY2UgYW4gZXhwcmVzc2lvbiBvbiB0aGUgKipvbj0iLi4uIiBhdHRyaWJ1dGUqKgogICAgICogKG9yIHRoZSAqKm5nLXN3aXRjaD0iLi4uIiBhdHRyaWJ1dGUqKiksIGRlZmluZSBhbnkgaW5uZXIgZWxlbWVudHMgaW5zaWRlIG9mIHRoZSBkaXJlY3RpdmUgYW5kIHBsYWNlCiAgICAgKiBhIHdoZW4gYXR0cmlidXRlIHBlciBlbGVtZW50LiBUaGUgd2hlbiBhdHRyaWJ1dGUgaXMgdXNlZCB0byBpbmZvcm0gbmdTd2l0Y2ggd2hpY2ggZWxlbWVudCB0byBkaXNwbGF5IHdoZW4gdGhlIG9uCiAgICAgKiBleHByZXNzaW9uIGlzIGV2YWx1YXRlZC4gSWYgYSBtYXRjaGluZyBleHByZXNzaW9uIGlzIG5vdCBmb3VuZCB2aWEgYSB3aGVuIGF0dHJpYnV0ZSB0aGVuIGFuIGVsZW1lbnQgd2l0aCB0aGUgZGVmYXVsdAogICAgICogYXR0cmlidXRlIGlzIGRpc3BsYXllZC4KICAgICAqCiAgICAgKiBAYW5pbWF0aW9ucwogICAgICogZW50ZXIgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ1N3dGljaCBjb250ZW50cyBjaGFuZ2UgYW5kIHRoZSBtYXRjaGVkIGNoaWxkIGVsZW1lbnQgaXMgcGxhY2VkIGluc2lkZSB0aGUgY29udGFpbmVyCiAgICAgKiBsZWF2ZSAtIGhhcHBlbnMganVzdCBhZnRlciB0aGUgbmdTd2l0Y2ggY29udGVudHMgY2hhbmdlIGFuZCBqdXN0IGJlZm9yZSB0aGUgZm9ybWVyIGNvbnRlbnRzIGFyZSByZW1vdmVkIGZyb20gdGhlIERPTQogICAgICoKICAgICAqIEB1c2FnZQogICAgICogPEFOWSBuZy1zd2l0Y2g9ImV4cHJlc3Npb24iPgogICAgICogICA8QU5ZIG5nLXN3aXRjaC13aGVuPSJtYXRjaFZhbHVlMSI+Li4uPC9BTlk+CiAgICAgKiAgIDxBTlkgbmctc3dpdGNoLXdoZW49Im1hdGNoVmFsdWUyIj4uLi48L0FOWT4KICAgICAqICAgPEFOWSBuZy1zd2l0Y2gtZGVmYXVsdD4uLi48L0FOWT4KICAgICAqIDwvQU5ZPgogICAgICoKICAgICAqIEBzY29wZQogICAgICogQHBhcmFtIHsqfSBuZ1N3aXRjaHxvbiBleHByZXNzaW9uIHRvIG1hdGNoIGFnYWluc3QgPHR0Pm5nLXN3aXRjaC13aGVuPC90dD4uCiAgICAgKiBAcGFyYW1EZXNjcmlwdGlvbgogICAgICogT24gY2hpbGQgZWxlbWVudHMgYWRkOgogICAgICoKICAgICAqICogYG5nU3dpdGNoV2hlbmA6IHRoZSBjYXNlIHN0YXRlbWVudCB0byBtYXRjaCBhZ2FpbnN0LiBJZiBtYXRjaCB0aGVuIHRoaXMKICAgICAqICAgY2FzZSB3aWxsIGJlIGRpc3BsYXllZC4gSWYgdGhlIHNhbWUgbWF0Y2ggYXBwZWFycyBtdWx0aXBsZSB0aW1lcywgYWxsIHRoZQogICAgICogICBlbGVtZW50cyB3aWxsIGJlIGRpc3BsYXllZC4KICAgICAqICogYG5nU3dpdGNoRGVmYXVsdGA6IHRoZSBkZWZhdWx0IGNhc2Ugd2hlbiBubyBvdGhlciBjYXNlIG1hdGNoLiBJZiB0aGVyZQogICAgICogICBhcmUgbXVsdGlwbGUgZGVmYXVsdCBjYXNlcywgYWxsIG9mIHRoZW0gd2lsbCBiZSBkaXNwbGF5ZWQgd2hlbiBubyBvdGhlcgogICAgICogICBjYXNlIG1hdGNoLgogICAgICoKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBhbmltYXRpb25zPSJ0cnVlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9InNlbGVjdGlvbiIgbmctb3B0aW9ucz0iaXRlbSBmb3IgaXRlbSBpbiBpdGVtcyI+CiAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICA8dHQ+c2VsZWN0aW9uPXt7c2VsZWN0aW9ufX08L3R0PgogICAgICAgICAgICA8aHIvPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhbmltYXRlLXN3aXRjaC1jb250YWluZXIiCiAgICAgICAgICAgICAgbmctc3dpdGNoIG9uPSJzZWxlY3Rpb24iPgogICAgICAgICAgICAgICAgPGRpdiBuZy1zd2l0Y2gtd2hlbj0ic2V0dGluZ3MiPlNldHRpbmdzIERpdjwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBuZy1zd2l0Y2gtd2hlbj0iaG9tZSI+SG9tZSBTcGFuPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IG5nLXN3aXRjaC1kZWZhdWx0PmRlZmF1bHQ8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS5pdGVtcyA9IFsnc2V0dGluZ3MnLCAnaG9tZScsICdvdGhlciddOwogICAgICAgICAgICAkc2NvcGUuc2VsZWN0aW9uID0gJHNjb3BlLml0ZW1zWzBdOwogICAgICAgICAgfQogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgICAgICAuYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyIHsKICAgICAgICAgICAgcG9zaXRpb246cmVsYXRpdmU7CiAgICAgICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgICAgIGhlaWdodDo0MHB4OwogICAgICAgICAgICBvdmVyZmxvdzpoaWRkZW47CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5hbmltYXRlLXN3aXRjaC1jb250YWluZXIgPiBkaXYgewogICAgICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5hbmltYXRlLXN3aXRjaC1jb250YWluZXIgPiAubmctZW50ZXIsCiAgICAgICAgICAuYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyID4gLm5nLWxlYXZlIHsKICAgICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgIC1tb3otdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgICAgICAtby10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgIAogICAgICAgICAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgICAgICAgICAgdG9wOjA7CiAgICAgICAgICAgIGxlZnQ6MDsKICAgICAgICAgICAgcmlnaHQ6MDsKICAgICAgICAgICAgYm90dG9tOjA7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5hbmltYXRlLXN3aXRjaC1jb250YWluZXIgPiAubmctZW50ZXIgewogICAgICAgICAgICB0b3A6LTUwcHg7CiAgICAgICAgICB9CiAgICAgICAgICAuYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyID4gLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAgICAgICAgICAgIHRvcDowOwogICAgICAgICAgfQogICAgCiAgICAgICAgICAuYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyID4gLm5nLWxlYXZlIHsKICAgICAgICAgICAgdG9wOjA7CiAgICAgICAgICB9CiAgICAgICAgICAuYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyID4gLm5nLWxlYXZlLm5nLWxlYXZlLWFjdGl2ZSB7CiAgICAgICAgICAgIHRvcDo1MHB4OwogICAgICAgICAgfQogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICBpdCgnc2hvdWxkIHN0YXJ0IGluIHNldHRpbmdzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctc3dpdGNoXScpLnRleHQoKSkudG9NYXRjaCgvU2V0dGluZ3MgRGl2Lyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGhvbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZWN0KCdzZWxlY3Rpb24nKS5vcHRpb24oJ2hvbWUnKTsKICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1zd2l0Y2hdJykudGV4dCgpKS50b01hdGNoKC9Ib21lIFNwYW4vKTsKICAgICAgICAgIH0pOwogICAgICAgICAgaXQoJ3Nob3VsZCBzZWxlY3QgZGVmYXVsdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzZWxlY3QoJ3NlbGVjdGlvbicpLm9wdGlvbignb3RoZXInKTsKICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1zd2l0Y2hdJykudGV4dCgpKS50b01hdGNoKC9kZWZhdWx0Lyk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nU3dpdGNoRGlyZWN0aXZlID0gWyckYW5pbWF0ZScsIGZ1bmN0aW9uICgkYW5pbWF0ZSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICAgICAgICByZXF1aXJlOiAnbmdTd2l0Y2gnLAoKICAgICAgICAgICAgLy8gYXNrcyBmb3IgJHNjb3BlIHRvIGZvb2wgdGhlIEJDIGNvbnRyb2xsZXIgbW9kdWxlCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgZnVuY3Rpb24gbmdTd2l0Y2hDb250cm9sbGVyKCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXNlcyA9IHt9OwogICAgICAgICAgICB9XSwKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBuZ1N3aXRjaENvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgIHZhciB3YXRjaEV4cHIgPSBhdHRyLm5nU3dpdGNoIHx8IGF0dHIub24sCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRUcmFuc2NsdWRlcywKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnRzLAogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2NvcGVzID0gW107CgogICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKHdhdGNoRXhwciwgZnVuY3Rpb24gbmdTd2l0Y2hXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IHNlbGVjdGVkU2NvcGVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZXNbaV0uJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoc2VsZWN0ZWRFbGVtZW50c1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnRzID0gW107CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZXMgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKChzZWxlY3RlZFRyYW5zY2x1ZGVzID0gbmdTd2l0Y2hDb250cm9sbGVyLmNhc2VzWychJyArIHZhbHVlXSB8fCBuZ1N3aXRjaENvbnRyb2xsZXIuY2FzZXNbJz8nXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwoYXR0ci5jaGFuZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdGVkVHJhbnNjbHVkZXMsIGZ1bmN0aW9uIChzZWxlY3RlZFRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzZWxlY3RlZFNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZXMucHVzaChzZWxlY3RlZFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkVHJhbnNjbHVkZS50cmFuc2NsdWRlKHNlbGVjdGVkU2NvcGUsIGZ1bmN0aW9uIChjYXNlRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhbmNob3IgPSBzZWxlY3RlZFRyYW5zY2x1ZGUuZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRFbGVtZW50cy5wdXNoKGNhc2VFbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjYXNlRWxlbWVudCwgYW5jaG9yLnBhcmVudCgpLCBhbmNob3IpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfV07CgogICAgdmFyIG5nU3dpdGNoV2hlbkRpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgcHJpb3JpdHk6IDUwMCwKICAgICAgICByZXF1aXJlOiAnXm5nU3dpdGNoJywKICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cnMsIHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgY3RybC5jYXNlc1snIScgKyBhdHRycy5uZ1N3aXRjaFdoZW5dID0gKGN0cmwuY2FzZXNbJyEnICsgYXR0cnMubmdTd2l0Y2hXaGVuXSB8fCBbXSk7CiAgICAgICAgICAgICAgICBjdHJsLmNhc2VzWychJyArIGF0dHJzLm5nU3dpdGNoV2hlbl0ucHVzaCh7IHRyYW5zY2x1ZGU6IHRyYW5zY2x1ZGUsIGVsZW1lbnQ6IGVsZW1lbnQgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSk7CgogICAgdmFyIG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgcHJpb3JpdHk6IDUwMCwKICAgICAgICByZXF1aXJlOiAnXm5nU3dpdGNoJywKICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cnMsIHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgY3RybC5jYXNlc1snPyddID0gKGN0cmwuY2FzZXNbJz8nXSB8fCBbXSk7CiAgICAgICAgICAgICAgICBjdHJsLmNhc2VzWyc/J10ucHVzaCh7IHRyYW5zY2x1ZGU6IHRyYW5zY2x1ZGUsIGVsZW1lbnQ6IGVsZW1lbnQgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdUcmFuc2NsdWRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEaXJlY3RpdmUgdGhhdCBtYXJrcyB0aGUgaW5zZXJ0aW9uIHBvaW50IGZvciB0aGUgdHJhbnNjbHVkZWQgRE9NIG9mIHRoZSBuZWFyZXN0IHBhcmVudCBkaXJlY3RpdmUgdGhhdCB1c2VzIHRyYW5zY2x1c2lvbi4KICAgICAqCiAgICAgKiBBbnkgZXhpc3RpbmcgY29udGVudCBvZiB0aGUgZWxlbWVudCB0aGF0IHRoaXMgZGlyZWN0aXZlIGlzIHBsYWNlZCBvbiB3aWxsIGJlIHJlbW92ZWQgYmVmb3JlIHRoZSB0cmFuc2NsdWRlZCBjb250ZW50IGlzIGluc2VydGVkLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICA8ZG9jOmV4YW1wbGUgbW9kdWxlPSJ0cmFuc2NsdWRlIj4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAgICRzY29wZS50aXRsZSA9ICdMb3JlbSBJcHN1bSc7CiAgICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ05lcXVlIHBvcnJvIHF1aXNxdWFtIGVzdCBxdWkgZG9sb3JlbSBpcHN1bSBxdWlhIGRvbG9yLi4uJzsKICAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ3RyYW5zY2x1ZGUnLCBbXSkKICAgICAgICAgICAgICAuZGlyZWN0aXZlKCdwYW5lJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICBzY29wZTogeyB0aXRsZTonQCcgfSwKICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiAnPGRpdiBzdHlsZT0iYm9yZGVyOiAxcHggc29saWQgYmxhY2s7Ij4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiBncmF5Ij57e3RpdGxlfX08L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IG5nLXRyYW5zY2x1ZGU+PC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicKICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgfSk7CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIDxpbnB1dCBuZy1tb2RlbD0idGl0bGUiPjxicj4KICAgICAgICAgICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0idGV4dCI+PC90ZXh0YXJlYT4gPGJyLz4KICAgICAgICAgICAgIDxwYW5lIHRpdGxlPSJ7e3RpdGxlfX0iPnt7dGV4dH19PC9wYW5lPgogICAgICAgICAgIDwvZGl2PgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgIGl0KCdzaG91bGQgaGF2ZSB0cmFuc2NsdWRlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlucHV0KCd0aXRsZScpLmVudGVyKCdUSVRMRScpOwogICAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ1RFWFQnKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndGl0bGUnKSkudG9FcXVhbCgnVElUTEUnKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdURVhUJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKgogICAgICovCiAgICB2YXIgbmdUcmFuc2NsdWRlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIGNvbnRyb2xsZXI6IFsnJHRyYW5zY2x1ZGUnLCBmdW5jdGlvbiAoJHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgLy8gcmVtZW1iZXIgdGhlIHRyYW5zY2x1c2lvbiBmbiBidXQgY2FsbCBpdCBkdXJpbmcgbGlua2luZyBzbyB0aGF0IHdlIGRvbid0IHByb2Nlc3MgdHJhbnNjbHVzaW9uIGJlZm9yZSBkaXJlY3RpdmVzIG9uCiAgICAgICAgICAgIC8vIHRoZSBwYXJlbnQgZWxlbWVudCBldmVuIHdoZW4gdGhlIHRyYW5zY2x1c2lvbiByZXBsYWNlcyB0aGUgY3VycmVudCBlbGVtZW50LiAod2UgY2FuJ3QgdXNlIHByaW9yaXR5IGhlcmUgYmVjYXVzZQogICAgICAgICAgICAvLyB0aGF0IGFwcGxpZXMgb25seSB0byBjb21waWxlIGZucyBhbmQgbm90IGNvbnRyb2xsZXJzCiAgICAgICAgICAgIHRoaXMuJHRyYW5zY2x1ZGUgPSAkdHJhbnNjbHVkZTsKICAgICAgICB9XSwKCiAgICAgICAgbGluazogZnVuY3Rpb24gKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgY29udHJvbGxlcikgewogICAgICAgICAgICBjb250cm9sbGVyLiR0cmFuc2NsdWRlKGZ1bmN0aW9uIChjbG9uZSkgewogICAgICAgICAgICAgICAgJGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpzY3JpcHQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIExvYWQgY29udGVudCBvZiBhIHNjcmlwdCB0YWcsIHdpdGggdHlwZSBgdGV4dC9uZy10ZW1wbGF0ZWAsIGludG8gYCR0ZW1wbGF0ZUNhY2hlYCwgc28gdGhhdCB0aGUKICAgICAqIHRlbXBsYXRlIGNhbiBiZSB1c2VkIGJ5IGBuZ0luY2x1ZGVgLCBgbmdWaWV3YCBvciBkaXJlY3RpdmUgdGVtcGxhdGVzLgogICAgICoKICAgICAqIEByZXN0cmljdCBFCiAgICAgKiBAcGFyYW0geyd0ZXh0L25nLXRlbXBsYXRlJ30gdHlwZSBtdXN0IGJlIHNldCB0byBgJ3RleHQvbmctdGVtcGxhdGUnYAogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9Ii90cGwuaHRtbCI+CiAgICAgICAgICAgIENvbnRlbnQgb2YgdGhlIHRlbXBsYXRlLgogICAgICAgICAgPC9zY3JpcHQ+CiAgICAKICAgICAgICAgIDxhIG5nLWNsaWNrPSJjdXJyZW50VHBsPScvdHBsLmh0bWwnIiBpZD0idHBsLWxpbmsiPkxvYWQgaW5saW5lZCB0ZW1wbGF0ZTwvYT4KICAgICAgICAgIDxkaXYgaWQ9InRwbC1jb250ZW50IiBuZy1pbmNsdWRlIHNyYz0iY3VycmVudFRwbCI+PC9kaXY+CiAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUgZGVmaW5lZCBpbnNpZGUgc2NyaXB0IHRhZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCcjdHBsLWxpbmsnKS5jbGljaygpOwogICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI3RwbC1jb250ZW50JykudGV4dCgpKS50b01hdGNoKC9Db250ZW50IG9mIHRoZSB0ZW1wbGF0ZS8pOwogICAgICAgICAgfSk7CiAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBzY3JpcHREaXJlY3RpdmUgPSBbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24gKCR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICBpZiAoYXR0ci50eXBlID09ICd0ZXh0L25nLXRlbXBsYXRlJykgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZVVybCA9IGF0dHIuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElFIGlzIG5vdCBjb25zaXN0ZW50LCBpbiBzY3JpcHRzIHdlIGhhdmUgdG8gcmVhZCAudGV4dCBidXQgaW4gb3RoZXIgbm9kZXMgd2UgaGF2ZSB0byByZWFkIC50ZXh0Q29udGVudAogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gZWxlbWVudFswXS50ZXh0OwoKICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGVDYWNoZS5wdXQodGVtcGxhdGVVcmwsIHRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOnNlbGVjdAogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEhUTUwgYFNFTEVDVGAgZWxlbWVudCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLgogICAgICoKICAgICAqICMgYG5nT3B0aW9uc2AKICAgICAqCiAgICAgKiBPcHRpb25hbGx5IGBuZ09wdGlvbnNgIGF0dHJpYnV0ZSBjYW4gYmUgdXNlZCB0byBkeW5hbWljYWxseSBnZW5lcmF0ZSBhIGxpc3Qgb2YgYDxvcHRpb24+YAogICAgICogZWxlbWVudHMgZm9yIGEgYDxzZWxlY3Q+YCBlbGVtZW50IHVzaW5nIGFuIGFycmF5IG9yIGFuIG9iamVjdCBvYnRhaW5lZCBieSBldmFsdWF0aW5nIHRoZQogICAgICogYG5nT3B0aW9uc2AgZXhwcmVzc2lvbi4KICAgICAqCiAgICAgKiBXaGVuIGFuIGl0ZW0gaW4gdGhlIGA8c2VsZWN0PmAgbWVudSBpcyBzZWxlY3RlZCwgdGhlIHZhbHVlIG9mIGFycmF5IGVsZW1lbnQgb3Igb2JqZWN0IHByb3BlcnR5CiAgICAgKiByZXByZXNlbnRlZCBieSB0aGUgc2VsZWN0ZWQgb3B0aW9uIHdpbGwgYmUgYm91bmQgdG8gdGhlIG1vZGVsIGlkZW50aWZpZWQgYnkgdGhlIGBuZ01vZGVsYAogICAgICogZGlyZWN0aXZlIG9mIHRoZSBwYXJlbnQgc2VsZWN0IGVsZW1lbnQuCiAgICAgKgogICAgICogT3B0aW9uYWxseSwgYSBzaW5nbGUgaGFyZC1jb2RlZCBgPG9wdGlvbj5gIGVsZW1lbnQsIHdpdGggdGhlIHZhbHVlIHNldCB0byBhbiBlbXB0eSBzdHJpbmcsIGNhbgogICAgICogYmUgbmVzdGVkIGludG8gdGhlIGA8c2VsZWN0PmAgZWxlbWVudC4gVGhpcyBlbGVtZW50IHdpbGwgdGhlbiByZXByZXNlbnQgYG51bGxgIG9yICJub3Qgc2VsZWN0ZWQiCiAgICAgKiBvcHRpb24uIFNlZSBleGFtcGxlIGJlbG93IGZvciBkZW1vbnN0cmF0aW9uLgogICAgICoKICAgICAqIE5vdGU6IGBuZ09wdGlvbnNgIHByb3ZpZGVzIGl0ZXJhdG9yIGZhY2lsaXR5IGZvciBgPG9wdGlvbj5gIGVsZW1lbnQgd2hpY2ggc2hvdWxkIGJlIHVzZWQgaW5zdGVhZAogICAgICogb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gd2hlbiB5b3Ugd2FudCB0aGUKICAgICAqIGBzZWxlY3RgIG1vZGVsIHRvIGJlIGJvdW5kIHRvIGEgbm9uLXN0cmluZyB2YWx1ZS4gVGhpcyBpcyBiZWNhdXNlIGFuIG9wdGlvbiBlbGVtZW50IGNhbiBjdXJyZW50bHkKICAgICAqIGJlIGJvdW5kIHRvIHN0cmluZyB2YWx1ZXMgb25seS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFRoZSBjb250cm9sIGlzIGNvbnNpZGVyZWQgdmFsaWQgb25seSBpZiB2YWx1ZSBpcyBlbnRlcmVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgKiBAcGFyYW0ge2NvbXByZWhlbnNpb25fZXhwcmVzc2lvbj19IG5nT3B0aW9ucyBpbiBvbmUgb2YgdGhlIGZvbGxvd2luZyBmb3JtczoKICAgICAqCiAgICAgKiAgICogZm9yIGFycmF5IGRhdGEgc291cmNlczoKICAgICAqICAgICAqIGBsYWJlbGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICAgKiAgICAgKiBgbGFiZWxgICAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgICAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgICoqYHRyYWNrIGJ5YCoqIGB0cmFja2V4cHJgCiAgICAgKiAgICogZm9yIG9iamVjdCBkYXRhIHNvdXJjZXM6CiAgICAgKiAgICAgKiBgbGFiZWxgICoqYGZvciAoYCoqYGtleWAgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgICAqICAgICAqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3IgKGAqKmBrZXlgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgCiAgICAgKiAgICAgICAgICoqYGZvcmAgYChgKipga2V5YCoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgICAqCiAgICAgKiBXaGVyZToKICAgICAqCiAgICAgKiAgICogYGFycmF5YCAvIGBvYmplY3RgOiBhbiBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbiBhcnJheSAvIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiAgICogYHZhbHVlYDogbG9jYWwgdmFyaWFibGUgd2hpY2ggd2lsbCByZWZlciB0byBlYWNoIGl0ZW0gaW4gdGhlIGBhcnJheWAgb3IgZWFjaCBwcm9wZXJ0eSB2YWx1ZQogICAgICogICAgICBvZiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogICAgICogICAqIGBrZXlgOiBsb2NhbCB2YXJpYWJsZSB3aGljaCB3aWxsIHJlZmVyIHRvIGEgcHJvcGVydHkgbmFtZSBpbiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogICAgICogICAqIGBsYWJlbGA6IFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUgdGhlIGxhYmVsIGZvciBgPG9wdGlvbj5gIGVsZW1lbnQuIFRoZQogICAgICogICAgIGBleHByZXNzaW9uYCB3aWxsIG1vc3QgbGlrZWx5IHJlZmVyIHRvIHRoZSBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICAgICAqICAgKiBgc2VsZWN0YDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSBib3VuZCB0byB0aGUgbW9kZWwgb2YgdGhlIHBhcmVudCBgPHNlbGVjdD5gCiAgICAgKiAgICAgIGVsZW1lbnQuIElmIG5vdCBzcGVjaWZpZWQsIGBzZWxlY3RgIGV4cHJlc3Npb24gd2lsbCBkZWZhdWx0IHRvIGB2YWx1ZWAuCiAgICAgKiAgICogYGdyb3VwYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB1c2VkIHRvIGdyb3VwIG9wdGlvbnMgdXNpbmcgdGhlIGA8b3B0Z3JvdXA+YAogICAgICogICAgICBET00gZWxlbWVudC4KICAgICAqICAgKiBgdHJhY2tleHByYDogVXNlZCB3aGVuIHdvcmtpbmcgd2l0aCBhbiBhcnJheSBvZiBvYmplY3RzLiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlCiAgICAgKiAgICAgIHVzZWQgdG8gaWRlbnRpZnkgdGhlIG9iamVjdHMgaW4gdGhlIGFycmF5LiBUaGUgYHRyYWNrZXhwcmAgd2lsbCBtb3N0IGxpa2VseSByZWZlciB0byB0aGUKICAgICAqICAgICBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICBmdW5jdGlvbiBNeUNudHJsKCRzY29wZSkgewogICAgICAgICAgICAgICRzY29wZS5jb2xvcnMgPSBbCiAgICAgICAgICAgICAgICB7bmFtZTonYmxhY2snLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICAgICAge25hbWU6J3doaXRlJywgc2hhZGU6J2xpZ2h0J30sCiAgICAgICAgICAgICAgICB7bmFtZToncmVkJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAgICAgIHtuYW1lOidibHVlJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAgICAgIHtuYW1lOid5ZWxsb3cnLCBzaGFkZTonbGlnaHQnfQogICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgJHNjb3BlLmNvbG9yID0gJHNjb3BlLmNvbG9yc1syXTsgLy8gcmVkCiAgICAgICAgICAgIH0KICAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iTXlDbnRybCI+CiAgICAgICAgICAgICAgPHVsPgogICAgICAgICAgICAgICAgPGxpIG5nLXJlcGVhdD0iY29sb3IgaW4gY29sb3JzIj4KICAgICAgICAgICAgICAgICAgTmFtZTogPGlucHV0IG5nLW1vZGVsPSJjb2xvci5uYW1lIj4KICAgICAgICAgICAgICAgICAgWzxhIGhyZWYgbmctY2xpY2s9ImNvbG9ycy5zcGxpY2UoJGluZGV4LCAxKSI+WDwvYT5dCiAgICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgICAgPGxpPgogICAgICAgICAgICAgICAgICBbPGEgaHJlZiBuZy1jbGljaz0iY29sb3JzLnB1c2goe30pIj5hZGQ8L2E+XQogICAgICAgICAgICAgICAgPC9saT4KICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICAgIDxoci8+CiAgICAgICAgICAgICAgQ29sb3IgKG51bGwgbm90IGFsbG93ZWQpOgogICAgICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZm9yIGMgaW4gY29sb3JzIj48L3NlbGVjdD48YnI+CiAgICAKICAgICAgICAgICAgICBDb2xvciAobnVsbCBhbGxvd2VkKToKICAgICAgICAgICAgICA8c3BhbiAgY2xhc3M9Im51bGxhYmxlIj4KICAgICAgICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZm9yIGMgaW4gY29sb3JzIj4KICAgICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj4tLSBjaG9zZSBjb2xvciAtLTwvb3B0aW9uPgogICAgICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgICAgPC9zcGFuPjxici8+CiAgICAKICAgICAgICAgICAgICBDb2xvciBncm91cGVkIGJ5IHNoYWRlOgogICAgICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZ3JvdXAgYnkgYy5zaGFkZSBmb3IgYyBpbiBjb2xvcnMiPgogICAgICAgICAgICAgIDwvc2VsZWN0Pjxici8+CiAgICAKICAgIAogICAgICAgICAgICAgIFNlbGVjdCA8YSBocmVmIG5nLWNsaWNrPSJjb2xvcj17bmFtZTonbm90IGluIGxpc3QnfSI+Ym9ndXM8L2E+Ljxicj4KICAgICAgICAgICAgICA8aHIvPgogICAgICAgICAgICAgIEN1cnJlbnRseSBzZWxlY3RlZDoge3sge3NlbGVjdGVkX2NvbG9yOmNvbG9yfSAgfX0KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJib3JkZXI6c29saWQgMXB4IGJsYWNrOyBoZWlnaHQ6MjBweCIKICAgICAgICAgICAgICAgICAgIG5nLXN0eWxlPSJ7J2JhY2tncm91bmQtY29sb3InOmNvbG9yLm5hbWV9Ij4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1vcHRpb25zJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6Y29sb3J9JykpLnRvTWF0Y2goJ3JlZCcpOwogICAgICAgICAgICAgICBzZWxlY3QoJ2NvbG9yJykub3B0aW9uKCcwJyk7CiAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6Y29sb3J9JykpLnRvTWF0Y2goJ2JsYWNrJyk7CiAgICAgICAgICAgICAgIHVzaW5nKCcubnVsbGFibGUnKS5zZWxlY3QoJ2NvbG9yJykub3B0aW9uKCcnKTsKICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpjb2xvcn0nKSkudG9NYXRjaCgnbnVsbCcpOwogICAgICAgICAgICAgfSk7CiAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCgogICAgdmFyIG5nT3B0aW9uc0RpcmVjdGl2ZSA9IHZhbHVlRm4oeyB0ZXJtaW5hbDogdHJ1ZSB9KTsKICAgIHZhciBzZWxlY3REaXJlY3RpdmUgPSBbJyRjb21waWxlJywgJyRwYXJzZScsIGZ1bmN0aW9uICgkY29tcGlsZSwgJHBhcnNlKSB7CiAgICAgICAgLy8wMDAwMTExMTEwMDAwMDAwMDAwMDIyMjIwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMzMzMzAwMDAwMDAwMDAwMDAwNDQ0NDQ0NDQ0NDQ0NDQ0NDQwMDAwMDAwMDA1NTU1NTU1NTU1NTU1NTU1NTAwMDAwMDA2NjY2NjY2NjY2NjY2NjY2NjAwMDAwMDAwMDAwMDAwMDA3Nzc3MDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4CiAgICAgICAgdmFyIE5HX09QVElPTlNfUkVHRVhQID0gL15ccyooLio/KSg/OlxzK2FzXHMrKC4qPykpPyg/OlxzK2dyb3VwXHMrYnlccysoLiopKT9ccytmb3JccysoPzooW1wkXHddW1wkXHdcZF0qKXwoPzpcKFxzKihbXCRcd11bXCRcd1xkXSopXHMqLFxzKihbXCRcd11bXCRcd1xkXSopXHMqXCkpKVxzK2luXHMrKC4qPykoPzpccyt0cmFja1xzK2J5XHMrKC4qPykpPyQvLAogICAgICAgICAgICBudWxsTW9kZWxDdHJsID0geyAkc2V0Vmlld1ZhbHVlOiBub29wIH07CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHJlcXVpcmU6IFsnc2VsZWN0JywgJz9uZ01vZGVsJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IFsnJGVsZW1lbnQnLCAnJHNjb3BlJywgJyRhdHRycycsIGZ1bmN0aW9uICgkZWxlbWVudCwgJHNjb3BlLCAkYXR0cnMpIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBvcHRpb25zTWFwID0ge30sCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBudWxsTW9kZWxDdHJsLAogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24sCiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbjsKCgogICAgICAgICAgICAgICAgc2VsZi5kYXRhYm91bmQgPSAkYXR0cnMubmdNb2RlbDsKCgogICAgICAgICAgICAgICAgc2VsZi5pbml0ID0gZnVuY3Rpb24gKG5nTW9kZWxDdHJsXywgbnVsbE9wdGlvbl8sIHVua25vd25PcHRpb25fKSB7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBuZ01vZGVsQ3RybF87CiAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbiA9IG51bGxPcHRpb25fOwogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24gPSB1bmtub3duT3B0aW9uXzsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgc2VsZi5hZGRPcHRpb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zTWFwW3ZhbHVlXSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnZhbCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIHNlbGYucmVtb3ZlT3B0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzT3B0aW9uKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9uc01hcFt2YWx1ZV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclVua25vd25PcHRpb24odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAgICAgc2VsZi5yZW5kZXJVbmtub3duT3B0aW9uID0gZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgICAgIHZhciB1bmtub3duVmFsID0gJz8gJyArIGhhc2hLZXkodmFsKSArICcgPyc7CiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbi52YWwodW5rbm93blZhbCk7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQucHJlcGVuZCh1bmtub3duT3B0aW9uKTsKICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC52YWwodW5rbm93blZhbCk7CiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbi5wcm9wKCdzZWxlY3RlZCcsIHRydWUpOyAvLyBuZWVkZWQgZm9yIElFCiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIHNlbGYuaGFzT3B0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnNNYXAuaGFzT3duUHJvcGVydHkodmFsdWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIC8vIGRpc2FibGUgdW5rbm93biBvcHRpb24gc28gdGhhdCB3ZSBkb24ndCBkbyB3b3JrIHdoZW4gdGhlIHdob2xlIHNlbGVjdCBpcyBiZWluZyBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbmRlclVua25vd25PcHRpb24gPSBub29wOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH1dLAoKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJscykgewogICAgICAgICAgICAgICAgLy8gaWYgbmdNb2RlbCBpcyBub3QgZGVmaW5lZCwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZwogICAgICAgICAgICAgICAgaWYgKCFjdHJsc1sxXSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIHZhciBzZWxlY3RDdHJsID0gY3RybHNbMF0sCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBjdHJsc1sxXSwKICAgICAgICAgICAgICAgICAgICBtdWx0aXBsZSA9IGF0dHIubXVsdGlwbGUsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc0V4cCA9IGF0dHIubmdPcHRpb25zLAogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24gPSBmYWxzZSwgLy8gaWYgZmFsc2UsIHVzZXIgd2lsbCBub3QgYmUgYWJsZSB0byBzZWxlY3QgaXQgKHVzZWQgYnkgbmdPcHRpb25zKQogICAgICAgICAgICAgICAgICAgIGVtcHR5T3B0aW9uLAogICAgICAgICAgICAgICAgICAgIC8vIHdlIGNhbid0IGp1c3QganFMaXRlKCc8b3B0aW9uPicpIHNpbmNlIGpxTGl0ZSBpcyBub3Qgc21hcnQgZW5vdWdoCiAgICAgICAgICAgICAgICAgICAgLy8gdG8gY3JlYXRlIGl0IGluIDxzZWxlY3Q+IGFuZCBJRSBiYXJmcyBvdGhlcndpc2UuCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uVGVtcGxhdGUgPSBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJykpLAogICAgICAgICAgICAgICAgICAgIG9wdEdyb3VwVGVtcGxhdGUgPSBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0Z3JvdXAnKSksCiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbiA9IG9wdGlvblRlbXBsYXRlLmNsb25lKCk7CgogICAgICAgICAgICAgICAgLy8gZmluZCAibnVsbCIgb3B0aW9uCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkcmVuKCksIGlpID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbltpXS52YWx1ZSA9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICBlbXB0eU9wdGlvbiA9IG51bGxPcHRpb24gPSBjaGlsZHJlbi5lcShpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuaW5pdChuZ01vZGVsQ3RybCwgbnVsbE9wdGlvbiwgdW5rbm93bk9wdGlvbik7CgogICAgICAgICAgICAgICAgLy8gcmVxdWlyZWQgdmFsaWRhdG9yCiAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUgJiYgKGF0dHIucmVxdWlyZWQgfHwgYXR0ci5uZ1JlcXVpcmVkKSkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXF1aXJlZFZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBuZ01vZGVsQ3RybC4kc2V0VmFsaWRpdHkoJ3JlcXVpcmVkJywgIWF0dHIucmVxdWlyZWQgfHwgKHZhbHVlICYmIHZhbHVlLmxlbmd0aCkpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHBhcnNlcnMucHVzaChyZXF1aXJlZFZhbGlkYXRvcik7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJGZvcm1hdHRlcnMudW5zaGlmdChyZXF1aXJlZFZhbGlkYXRvcik7CgogICAgICAgICAgICAgICAgICAgIGF0dHIuJG9ic2VydmUoJ3JlcXVpcmVkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlZFZhbGlkYXRvcihuZ01vZGVsQ3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAob3B0aW9uc0V4cCkgT3B0aW9ucyhzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwpOwogICAgICAgICAgICAgICAgZWxzZSBpZiAobXVsdGlwbGUpIE11bHRpcGxlKHNjb3BlLCBlbGVtZW50LCBuZ01vZGVsQ3RybCk7CiAgICAgICAgICAgICAgICBlbHNlIFNpbmdsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwsIHNlbGVjdEN0cmwpOwoKCiAgICAgICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBTaW5nbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZpZXdWYWx1ZSA9IG5nTW9kZWxDdHJsLiR2aWV3VmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0Q3RybC5oYXNPcHRpb24odmlld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnZhbCh2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSA9PT0gJycpIGVtcHR5T3B0aW9uLnByb3AoJ3NlbGVjdGVkJywgdHJ1ZSk7IC8vIHRvIG1ha2UgSUU5IGhhcHB5CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmlld1ZhbHVlKSAmJiBlbXB0eU9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKCcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW5kZXJVbmtub3duT3B0aW9uKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50Lm9uKCdjaGFuZ2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodW5rbm93bk9wdGlvbi5wYXJlbnQoKSkgdW5rbm93bk9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRzZXRWaWV3VmFsdWUoc2VsZWN0RWxlbWVudC52YWwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE11bHRpcGxlKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBjdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RWaWV3OwogICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1zID0gbmV3IEhhc2hNYXAoY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChzZWxlY3RFbGVtZW50LmZpbmQoJ29wdGlvbicpLCBmdW5jdGlvbiAob3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBpc0RlZmluZWQoaXRlbXMuZ2V0KG9wdGlvbi52YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBoYXZlIHRvIGRvIGl0IG9uIGVhY2ggd2F0Y2ggc2luY2UgbmdNb2RlbCB3YXRjaGVzIHJlZmVyZW5jZSwgYnV0CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byB3b3JrIG9mIGFuIGFycmF5LCBzbyB3ZSBuZWVkIHRvIHNlZSBpZiBhbnl0aGluZyB3YXMgaW5zZXJ0ZWQvcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBzZWxlY3RNdWx0aXBsZVdhdGNoKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVxdWFscyhsYXN0VmlldywgY3RybC4kdmlld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFZpZXcgPSBjb3B5KGN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiRyZW5kZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50Lm9uKCdjaGFuZ2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goc2VsZWN0RWxlbWVudC5maW5kKCdvcHRpb24nKSwgZnVuY3Rpb24gKG9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChvcHRpb24udmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGFycmF5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gT3B0aW9ucyhzY29wZSwgc2VsZWN0RWxlbWVudCwgY3RybCkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCEobWF0Y2ggPSBvcHRpb25zRXhwLm1hdGNoKE5HX09QVElPTlNfUkVHRVhQKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbWluRXJyKCduZ09wdGlvbnMnKSgnaWV4cCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIkV4cGVjdGVkIGV4cHJlc3Npb24gaW4gZm9ybSBvZiAnX3NlbGVjdF8gKGFzIF9sYWJlbF8pPyBmb3IgKF9rZXlfLCk/X3ZhbHVlXyBpbiBfY29sbGVjdGlvbl8nIGJ1dCBnb3QgJ3swfScuIEVsZW1lbnQ6IHsxfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uc0V4cCwgc3RhcnRpbmdUYWcoc2VsZWN0RWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIGRpc3BsYXlGbiA9ICRwYXJzZShtYXRjaFsyXSB8fCBtYXRjaFsxXSksCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlTmFtZSA9IG1hdGNoWzRdIHx8IG1hdGNoWzZdLAogICAgICAgICAgICAgICAgICAgICAgICBrZXlOYW1lID0gbWF0Y2hbNV0sCiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwQnlGbiA9ICRwYXJzZShtYXRjaFszXSB8fCAnJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlRm4gPSAkcGFyc2UobWF0Y2hbMl0gPyBtYXRjaFsxXSA6IHZhbHVlTmFtZSksCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlc0ZuID0gJHBhcnNlKG1hdGNoWzddKSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2sgPSBtYXRjaFs4XSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tGbiA9IHRyYWNrID8gJHBhcnNlKG1hdGNoWzhdKSA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgb2YgYXJyYXkgb2YgZXhpc3Rpbmcgb3B0aW9uIGdyb3VwcyBpbiBET00uIFdlIHRyeSB0byByZXVzZSB0aGVzZSBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgICAgICAgICAvLyBvcHRpb25Hcm91cHNDYWNoZVswXSBpcyB0aGUgb3B0aW9ucyB3aXRoIG5vIG9wdGlvbiBncm91cAogICAgICAgICAgICAgICAgICAgICAgICAvLyBvcHRpb25Hcm91cHNDYWNoZVs/XVswXSBpcyB0aGUgcGFyZW50OiBlaXRoZXIgdGhlIFNFTEVDVCBvciBPUFRHUk9VUCBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlID0gW1t7IGVsZW1lbnQ6IHNlbGVjdEVsZW1lbnQsIGxhYmVsOiAnJyB9XV07CgogICAgICAgICAgICAgICAgICAgIGlmIChudWxsT3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbXBpbGUgdGhlIGVsZW1lbnQgc2luY2UgdGhlcmUgbWlnaHQgYmUgYmluZGluZ3MgaW4gaXQKICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGUobnVsbE9wdGlvbikoc2NvcGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBjbGFzcywgd2hpY2ggaXMgYWRkZWQgYXV0b21hdGljYWxseSBiZWNhdXNlIHdlIHJlY29tcGlsZSB0aGUgZWxlbWVudCBhbmQgaXQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmVjb21lcyB0aGUgY29tcGlsYXRpb24gcm9vdAogICAgICAgICAgICAgICAgICAgICAgICBudWxsT3B0aW9uLnJlbW92ZUNsYXNzKCduZy1zY29wZScpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byByZW1vdmUgaXQgYmVmb3JlIGNhbGxpbmcgc2VsZWN0RWxlbWVudC5odG1sKCcnKSBiZWNhdXNlIG90aGVyd2lzZSBJRSB3aWxsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgbGFiZWwgZnJvbSB0aGUgZWxlbWVudC4gd3RmPwogICAgICAgICAgICAgICAgICAgICAgICBudWxsT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gY2xlYXIgY29udGVudHMsIHdlJ2xsIGFkZCB3aGF0J3MgbmVlZGVkIGJhc2VkIG9uIHRoZSBtb2RlbAogICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuaHRtbCgnJyk7CgogICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQub24oJ2NoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleSwgdmFsdWUsIG9wdGlvbkVsZW1lbnQsIGluZGV4LCBncm91cEluZGV4LCBsZW5ndGgsIGdyb3VwTGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChncm91cEluZGV4ID0gMCwgZ3JvdXBMZW5ndGggPSBvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNDYWNoZVtncm91cEluZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAxLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9wdGlvbkVsZW1lbnQgPSBvcHRpb25Hcm91cFtpbmRleF0uZWxlbWVudClbMF0uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBvcHRpb25FbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lKSBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgdHJhY2tJbmRleCA9IDA7IHRyYWNrSW5kZXggPCBjb2xsZWN0aW9uLmxlbmd0aDsgdHJhY2tJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25bdHJhY2tJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHJhY2tGbihzY29wZSwgbG9jYWxzKSA9PSBrZXkpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnB1c2godmFsdWVGbihzY29wZSwgbG9jYWxzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IHNlbGVjdEVsZW1lbnQudmFsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnPycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFja0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciB0cmFja0luZGV4ID0gMDsgdHJhY2tJbmRleCA8IGNvbGxlY3Rpb24ubGVuZ3RoOyB0cmFja0luZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25bdHJhY2tJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4oc2NvcGUsIGxvY2FscykgPT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5TmFtZSkgbG9jYWxzW2tleU5hbWVdID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlciA9IHJlbmRlcjsKCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IGNhbid0IHdlIG9wdGltaXplIHRoaXMgPwogICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChyZW5kZXIpOwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25Hcm91cHMgPSB7ICcnOiBbXSB9LCAvLyBUZW1wb3JhcnkgbG9jYXRpb24gZm9yIHRoZSBvcHRpb24gZ3JvdXBzIGJlZm9yZSB3ZSByZW5kZXIgdGhlbQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcyA9IFsnJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LCBleGlzdGluZ09wdGlvbnMsIGV4aXN0aW5nT3B0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWxWYWx1ZSA9IGN0cmwuJG1vZGVsVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSB2YWx1ZXNGbihzY29wZSkgfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlzID0ga2V5TmFtZSA/IHNvcnRlZEtleXModmFsdWVzKSA6IHZhbHVlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwTGVuZ3RoLCBsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4LCBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IGZhbHNlLCAvLyBub3RoaW5nIGlzIHNlbGVjdGVkIHlldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFja0ZuICYmIGlzQXJyYXkobW9kZWxWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IG5ldyBIYXNoTWFwKFtdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciB0cmFja0luZGV4ID0gMDsgdHJhY2tJbmRleCA8IG1vZGVsVmFsdWUubGVuZ3RoOyB0cmFja0luZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBtb2RlbFZhbHVlW3RyYWNrSW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldC5wdXQodHJhY2tGbihzY29wZSwgbG9jYWxzKSwgbW9kZWxWYWx1ZVt0cmFja0luZGV4XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IG5ldyBIYXNoTWFwKG1vZGVsVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBub3cgYnVpbGQgdXAgdGhlIGxpc3Qgb2Ygb3B0aW9ucyB3ZSBuZWVkICh3ZSBtZXJnZSBsYXRlcikKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpbmRleCA9IDA7IGxlbmd0aCA9IGtleXMubGVuZ3RoLCBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSB2YWx1ZXNba2V5TmFtZSA/IGxvY2Fsc1trZXlOYW1lXSA9IGtleXNbaW5kZXhdIDogaW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lID0gZ3JvdXBCeUZuKHNjb3BlLCBsb2NhbHMpIHx8ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEob3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcy5wdXNoKG9wdGlvbkdyb3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZCA9IHNlbGVjdGVkU2V0LnJlbW92ZSh0cmFja0ZuID8gdHJhY2tGbihzY29wZSwgbG9jYWxzKSA6IHZhbHVlRm4oc2NvcGUsIGxvY2FscykpICE9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZGVsQ2FzdCA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbENhc3RbdmFsdWVOYW1lXSA9IG1vZGVsVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gdHJhY2tGbihzY29wZSwgbW9kZWxDYXN0KSA9PT0gdHJhY2tGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZCA9IG1vZGVsVmFsdWUgPT09IHZhbHVlRm4oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gc2VsZWN0ZWRTZXQgfHwgc2VsZWN0ZWQ7IC8vIHNlZSBpZiBhdCBsZWFzdCBvbmUgaXRlbSBpcyBzZWxlY3RlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBkaXNwbGF5Rm4oc2NvcGUsIGxvY2Fscyk7IC8vIHdoYXQgd2lsbCBiZSBzZWVuIGJ5IHRoZSB1c2VyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IGxhYmVsID09PSB1bmRlZmluZWQgPyAnJyA6IGxhYmVsOyAvLyBkb2luZyBkaXNwbGF5Rm4oc2NvcGUsIGxvY2FscykgfHwgJycgb3ZlcndyaXRlcyB6ZXJvIHZhbHVlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHRyYWNrRm4gPyB0cmFja0ZuKHNjb3BlLCBsb2NhbHMpIDogKGtleU5hbWUgPyBrZXlzW2luZGV4XSA6IGluZGV4KSwgICAvLyBlaXRoZXIgdGhlIGluZGV4IGludG8gYXJyYXkgb3Iga2V5IGZyb20gb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGxhYmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBzZWxlY3RlZCAgICAgICAgICAgICAgICAgICAvLyBkZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGJlIHNlbGVjdGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobnVsbE9wdGlvbiB8fCBtb2RlbFZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW5zZXJ0IG51bGwgb3B0aW9uIGlmIHdlIGhhdmUgYSBwbGFjZWhvbGRlciwgb3IgdGhlIG1vZGVsIGlzIG51bGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNbJyddLnVuc2hpZnQoeyBpZDogJycsIGxhYmVsOiAnJywgc2VsZWN0ZWQ6ICFzZWxlY3RlZFNldCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNlbGVjdGVkU2V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uIGNvdWxkIG5vdCBiZSBmb3VuZCwgd2UgaGF2ZSB0byBpbnNlcnQgdGhlIHVuZGVmaW5lZCBpdGVtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzWycnXS51bnNoaWZ0KHsgaWQ6ICc/JywgbGFiZWw6ICcnLCBzZWxlY3RlZDogdHJ1ZSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm93IHdlIG5lZWQgdG8gdXBkYXRlIHRoZSBsaXN0IG9mIERPTSBub2RlcyB0byBtYXRjaCB0aGUgb3B0aW9uR3JvdXBzIHdlIGNvbXB1dGVkIGFib3ZlCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoZ3JvdXBJbmRleCA9IDAsIGdyb3VwTGVuZ3RoID0gb3B0aW9uR3JvdXBOYW1lcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCA8IGdyb3VwTGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY3VycmVudCBvcHRpb24gZ3JvdXAgbmFtZSBvciAnJyBpZiBubyBncm91cAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lID0gb3B0aW9uR3JvdXBOYW1lc1tncm91cEluZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsaXN0IG9mIG9wdGlvbnMgZm9yIHRoYXQgZ3JvdXAuIChmaXJzdCBpdGVtIGhhcyB0aGUgcGFyZW50KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uR3JvdXBzQ2FjaGUubGVuZ3RoIDw9IGdyb3VwSW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGdyb3cgdGhlIG9wdGlvbkdyb3VwcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50OiBvcHRHcm91cFRlbXBsYXRlLmNsb25lKCkuYXR0cignbGFiZWwnLCBvcHRpb25Hcm91cE5hbWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uR3JvdXAubGFiZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucyA9IFtleGlzdGluZ1BhcmVudF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUucHVzaChleGlzdGluZ09wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuYXBwZW5kKGV4aXN0aW5nUGFyZW50LmVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBvcHRpb25Hcm91cHNDYWNoZVtncm91cEluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCA9IGV4aXN0aW5nT3B0aW9uc1swXTsgIC8vIGVpdGhlciBTRUxFQ1QgKG5vIGdyb3VwKSBvciBPUFRHUk9VUCBlbGVtZW50CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSB0aGUgT1BUR1JPVVAgbGFiZWwgaWYgbm90IHRoZSBzYW1lLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1BhcmVudC5sYWJlbCAhPSBvcHRpb25Hcm91cE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQuZWxlbWVudC5hdHRyKCdsYWJlbCcsIGV4aXN0aW5nUGFyZW50LmxhYmVsID0gb3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBudWxsOyAgLy8gc3RhcnQgYXQgdGhlIGJlZ2lubmluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpbmRleCA9IDAsIGxlbmd0aCA9IG9wdGlvbkdyb3VwLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24gPSBvcHRpb25Hcm91cFtpbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChleGlzdGluZ09wdGlvbiA9IGV4aXN0aW5nT3B0aW9uc1tpbmRleCArIDFdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZXVzZSBlbGVtZW50cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGV4aXN0aW5nT3B0aW9uLmVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ09wdGlvbi5sYWJlbCAhPT0gb3B0aW9uLmxhYmVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC50ZXh0KGV4aXN0aW5nT3B0aW9uLmxhYmVsID0gb3B0aW9uLmxhYmVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24uaWQgIT09IG9wdGlvbi5pZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQudmFsKGV4aXN0aW5nT3B0aW9uLmlkID0gb3B0aW9uLmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsYXN0RWxlbWVudC5wcm9wKCdzZWxlY3RlZCcpIHByb3ZpZGVkIGJ5IGpRdWVyeSBoYXMgc2lkZS1lZmZlY3RzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0RWxlbWVudFswXS5zZWxlY3RlZCAhPT0gb3B0aW9uLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC5wcm9wKCdzZWxlY3RlZCcsIChleGlzdGluZ09wdGlvbi5zZWxlY3RlZCA9IG9wdGlvbi5zZWxlY3RlZCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZ3JvdyBlbGVtZW50cwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgaXQncyBhIG51bGwgb3B0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24uaWQgPT09ICcnICYmIG51bGxPcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHB1dCBiYWNrIHRoZSBwcmUtY29tcGlsZWQgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCA9IG51bGxPcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBqUXVlcnkodjEuNC4yKSBCdWc6IFdlIHNob3VsZCBiZSBhYmxlIHRvIGNoYWluIHRoZSBtZXRob2QgY2FsbHMsIGJ1dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW4gdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSBvbiBzb21lIGJyb3dzZXIgdGhlIC50ZXh0KCkgcmV0dXJucyBhIHN0cmluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmF0aGVyIHRoZW4gdGhlIGVsZW1lbnQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZWxlbWVudCA9IG9wdGlvblRlbXBsYXRlLmNsb25lKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnZhbChvcHRpb24uaWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmF0dHIoJ3NlbGVjdGVkJywgb3B0aW9uLnNlbGVjdGVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50ZXh0KG9wdGlvbi5sYWJlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucy5wdXNoKGV4aXN0aW5nT3B0aW9uID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogZWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb24ubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogb3B0aW9uLmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IG9wdGlvbi5zZWxlY3RlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC5hZnRlcihlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXBwZW5kKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRJT05zIGluIGEgZ3JvdXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4Kys7IC8vIGluY3JlbWVudCBzaW5jZSB0aGUgZXhpc3RpbmdPcHRpb25zWzBdIGlzIHBhcmVudCBlbGVtZW50IG5vdCBPUFRJT04KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChleGlzdGluZ09wdGlvbnMubGVuZ3RoID4gaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucG9wKCkuZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRHUk9VUHMgZnJvbSBzZWxlY3QKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA+IGdyb3VwSW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnBvcCgpWzBdLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9XTsKCiAgICB2YXIgb3B0aW9uRGlyZWN0aXZlID0gWyckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbiAoJGludGVycG9sYXRlKSB7CiAgICAgICAgdmFyIG51bGxTZWxlY3RDdHJsID0gewogICAgICAgICAgICBhZGRPcHRpb246IG5vb3AsCiAgICAgICAgICAgIHJlbW92ZU9wdGlvbjogbm9vcAogICAgICAgIH07CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoYXR0ci52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShlbGVtZW50LnRleHQoKSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBlbGVtZW50LnRleHQoKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0Q3RybE5hbWUgPSAnJHNlbGVjdENvbnRyb2xsZXInLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudCgpLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RDdHJsID0gcGFyZW50LmRhdGEoc2VsZWN0Q3RybE5hbWUpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50LnBhcmVudCgpLmRhdGEoc2VsZWN0Q3RybE5hbWUpOyAvLyBpbiBjYXNlIHdlIGFyZSBpbiBvcHRncm91cAoKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0Q3RybCAmJiBzZWxlY3RDdHJsLmRhdGFib3VuZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3Igc29tZSByZWFzb24gT3BlcmEgZGVmYXVsdHMgdG8gdHJ1ZSBhbmQgaWYgbm90IG92ZXJyaWRkZW4gdGhpcyBtZXNzZXMgdXAgdGhlIHJlcGVhdGVyLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBkb24ndCB3YW50IHRoZSB2aWV3IHRvIGRyaXZlIHRoZSBpbml0aWFsaXphdGlvbiBvZiB0aGUgbW9kZWwgYW55d2F5LgogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnByb3AoJ3NlbGVjdGVkJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwgPSBudWxsU2VsZWN0Q3RybDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZVdhdGNoQWN0aW9uKG5ld1ZhbCwgb2xkVmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgbmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdWYWwgIT09IG9sZFZhbCkgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24ob2xkVmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKG5ld1ZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5vbignJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwucmVtb3ZlT3B0aW9uKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH1dOwoKICAgIHZhciBzdHlsZURpcmVjdGl2ZSA9IHZhbHVlRm4oewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgdGVybWluYWw6IHRydWUKICAgIH0pOwoKICAgIC8vdHJ5IHRvIGJpbmQgdG8ganF1ZXJ5IG5vdyBzbyB0aGF0IG9uZSBjYW4gd3JpdGUgYW5ndWxhci5lbGVtZW50KCkucmVhZCgpCiAgICAvL2J1dCB3ZSB3aWxsIHJlYmluZCBvbiBib290c3RyYXAgYWdhaW4uCiAgICBiaW5kSlF1ZXJ5KCk7CgogICAgcHVibGlzaEV4dGVybmFsQVBJKGFuZ3VsYXIpOwoKICAgIGpxTGl0ZShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24gKCkgewogICAgICAgIGFuZ3VsYXJJbml0KGRvY3VtZW50LCBib290c3RyYXApOwogICAgfSk7Cgp9KSh3aW5kb3csIGRvY3VtZW50KTsKYW5ndWxhci5lbGVtZW50KGRvY3VtZW50KS5maW5kKCdoZWFkJykucHJlcGVuZCgnPHN0eWxlIHR5cGU9InRleHQvY3NzIj5AY2hhcnNldCAiVVRGLTgiO1tuZ1xcOmNsb2FrXSxbbmctY2xvYWtdLFtkYXRhLW5nLWNsb2FrXSxbeC1uZy1jbG9ha10sLm5nLWNsb2FrLC54LW5nLWNsb2FrLC5uZy1oaWRle2Rpc3BsYXk6bm9uZSAhaW1wb3J0YW50O31uZ1xcOmZvcm17ZGlzcGxheTpibG9jazt9PC9zdHlsZT4nKTs=",
                "body": "LyoqCiAqIEBsaWNlbnNlIEFuZ3VsYXJKUyB2MS4yLjAtcmMuMgogKiAoYykgMjAxMC0yMDEyIEdvb2dsZSwgSW5jLiBodHRwOi8vYW5ndWxhcmpzLm9yZwogKiBMaWNlbnNlOiBNSVQKICovCihmdW5jdGlvbiAod2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgLyoqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBUaGlzIG9iamVjdCBwcm92aWRlcyBhIHV0aWxpdHkgZm9yIHByb2R1Y2luZyByaWNoIEVycm9yIG1lc3NhZ2VzIHdpdGhpbgogICAgICogQW5ndWxhci4gSXQgY2FuIGJlIGNhbGxlZCBhcyBmb2xsb3dzOgogICAgICoKICAgICAqIHZhciBleGFtcGxlTWluRXJyID0gbWluRXJyKCdleGFtcGxlJyk7CiAgICAgKiB0aHJvdyBleGFtcGxlTWluRXJyKCdvbmUnLCAnVGhpcyB7MH0gaXMgezF9JywgZm9vLCBiYXIpOwogICAgICoKICAgICAqIFRoZSBhYm92ZSBjcmVhdGVzIGFuIGluc3RhbmNlIG9mIG1pbkVyciBpbiB0aGUgZXhhbXBsZSBuYW1lc3BhY2UuIFRoZQogICAgICogcmVzdWx0aW5nIGVycm9yIHdpbGwgaGF2ZSBhIG5hbWVzcGFjZWQgZXJyb3IgY29kZSBvZiBleGFtcGxlLm9uZS4gIFRoZQogICAgICogcmVzdWx0aW5nIGVycm9yIHdpbGwgcmVwbGFjZSB7MH0gd2l0aCB0aGUgdmFsdWUgb2YgZm9vLCBhbmQgezF9IHdpdGggdGhlCiAgICAgKiB2YWx1ZSBvZiBiYXIuIFRoZSBvYmplY3QgaXMgbm90IHJlc3RyaWN0ZWQgaW4gdGhlIG51bWJlciBvZiBhcmd1bWVudHMgaXQgY2FuCiAgICAgKiB0YWtlLgogICAgICoKICAgICAqIElmIGZld2VyIGFyZ3VtZW50cyBhcmUgc3BlY2lmaWVkIHRoYW4gbmVjZXNzYXJ5IGZvciBpbnRlcnBvbGF0aW9uLCB0aGUgZXh0cmEKICAgICAqIGludGVycG9sYXRpb24gbWFya2VycyB3aWxsIGJlIHByZXNlcnZlZCBpbiB0aGUgZmluYWwgc3RyaW5nLgogICAgICoKICAgICAqIFNpbmNlIGRhdGEgd2lsbCBiZSBwYXJzZWQgc3RhdGljYWxseSBkdXJpbmcgYSBidWlsZCBzdGVwLCBzb21lIHJlc3RyaWN0aW9ucwogICAgICogYXJlIGFwcGxpZWQgd2l0aCByZXNwZWN0IHRvIGhvdyBtaW5FcnIgaW5zdGFuY2VzIGFyZSBjcmVhdGVkIGFuZCBjYWxsZWQuCiAgICAgKiBJbnN0YW5jZXMgc2hvdWxkIGhhdmUgbmFtZXMgb2YgdGhlIGZvcm0gbmFtZXNwYWNlTWluRXJyIGZvciBhIG1pbkVyciBjcmVhdGVkCiAgICAgKiB1c2luZyBtaW5FcnIoJ25hbWVzcGFjZScpIC4gRXJyb3IgY29kZXMsIG5hbWVzcGFjZXMgYW5kIHRlbXBsYXRlIHN0cmluZ3MKICAgICAqIHNob3VsZCBhbGwgYmUgc3RhdGljIHN0cmluZ3MsIG5vdCB2YXJpYWJsZXMgb3IgZ2VuZXJhbCBleHByZXNzaW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlIFRoZSBuYW1lc3BhY2UgdG8gdXNlIGZvciB0aGUgbmV3IG1pbkVyciBpbnN0YW5jZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihzdHJpbmcsIHN0cmluZywgLi4uKTogRXJyb3J9IGluc3RhbmNlCiAgICAgKi8KCiAgICBmdW5jdGlvbiBtaW5FcnIobW9kdWxlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGNvZGUgPSBhcmd1bWVudHNbMF0sCiAgICAgICAgICAgICAgcHJlZml4ID0gJ1snICsgKG1vZHVsZSA/IG1vZHVsZSArICc6JyA6ICcnKSArIGNvZGUgKyAnXSAnLAogICAgICAgICAgICAgIHRlbXBsYXRlID0gYXJndW1lbnRzWzFdLAogICAgICAgICAgICAgIHRlbXBsYXRlQXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgICAgICBzdHJpbmdpZnkgPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKG9iaikpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmoudG9TdHJpbmcoKS5yZXBsYWNlKC8gXHtbXHNcU10qJC8sICcnKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1VuZGVmaW5lZChvYmopKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3VuZGVmaW5lZCc7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzU3RyaW5nKG9iaikpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmopOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBvYmo7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBtZXNzYWdlLCBpOwoKICAgICAgICAgICAgbWVzc2FnZSA9IHByZWZpeCArIHRlbXBsYXRlLnJlcGxhY2UoL1x7XGQrXH0vZywgZnVuY3Rpb24gKG1hdGNoKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSArbWF0Y2guc2xpY2UoMSwgLTEpLCBhcmc7CgogICAgICAgICAgICAgICAgaWYgKGluZGV4ICsgMiA8IHRlbXBsYXRlQXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBhcmcgPSB0ZW1wbGF0ZUFyZ3NbaW5kZXggKyAyXTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmcudG9TdHJpbmcoKS5yZXBsYWNlKC8gP1x7W1xzXFNdKiQvLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1VuZGVmaW5lZChhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAndW5kZWZpbmVkJzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc1N0cmluZyhhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0b0pzb24oYXJnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZSArICdcbmh0dHA6Ly9lcnJvcnMuYW5ndWxhcmpzLm9yZy8nICsgdmVyc2lvbi5mdWxsICsgJy8nICsKICAgICAgICAgICAgICAobW9kdWxlID8gbW9kdWxlICsgJy8nIDogJycpICsgY29kZTsKICAgICAgICAgICAgZm9yIChpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UgKyAoaSA9PSAyID8gJz8nIDogJyYnKSArICdwJyArIChpIC0gMikgKyAnPScgKwogICAgICAgICAgICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5KGFyZ3VtZW50c1tpXSkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICAgIH07CiAgICB9CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBoYXNPd25Qcm9wZXJ0eSBtYXkgYmUgb3ZlcndyaXR0ZW4gYnkgYSBwcm9wZXJ0eSBvZiB0aGUgc2FtZSBuYW1lLCBvciBlbnRpcmVseQogICAgICogYWJzZW50IGZyb20gYW4gb2JqZWN0IHRoYXQgZG9lcyBub3QgaW5oZXJpdCBPYmplY3QucHJvdG90eXBlOyB0aGlzIGNvcHkgaXMKICAgICAqIHVzZWQgaW5zdGVhZAogICAgICovCiAgICB2YXIgaGFzT3duUHJvcGVydHlGbiA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgaGFzT3duUHJvcGVydHlMb2NhbCA9IGZ1bmN0aW9uIChvYmosIGtleSkgewogICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eUZuLmNhbGwob2JqLCBrZXkpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5sb3dlcmNhc2UKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbiBDb252ZXJ0cyB0aGUgc3BlY2lmaWVkIHN0cmluZyB0byBsb3dlcmNhc2UuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFN0cmluZyB0byBiZSBjb252ZXJ0ZWQgdG8gbG93ZXJjYXNlLgogICAgICogQHJldHVybnMge3N0cmluZ30gTG93ZXJjYXNlZCBzdHJpbmcuCiAgICAgKi8KICAgIHZhciBsb3dlcmNhc2UgPSBmdW5jdGlvbiAoc3RyaW5nKSB7IHJldHVybiBpc1N0cmluZyhzdHJpbmcpID8gc3RyaW5nLnRvTG93ZXJDYXNlKCkgOiBzdHJpbmc7IH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLnVwcGVyY2FzZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uIENvbnZlcnRzIHRoZSBzcGVjaWZpZWQgc3RyaW5nIHRvIHVwcGVyY2FzZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgU3RyaW5nIHRvIGJlIGNvbnZlcnRlZCB0byB1cHBlcmNhc2UuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBVcHBlcmNhc2VkIHN0cmluZy4KICAgICAqLwogICAgdmFyIHVwcGVyY2FzZSA9IGZ1bmN0aW9uIChzdHJpbmcpIHsgcmV0dXJuIGlzU3RyaW5nKHN0cmluZykgPyBzdHJpbmcudG9VcHBlckNhc2UoKSA6IHN0cmluZzsgfTsKCgogICAgdmFyIG1hbnVhbExvd2VyY2FzZSA9IGZ1bmN0aW9uIChzKSB7CiAgICAgICAgcmV0dXJuIGlzU3RyaW5nKHMpCiAgICAgICAgICAgID8gcy5yZXBsYWNlKC9bQS1aXS9nLCBmdW5jdGlvbiAoY2gpIHsgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSB8IDMyKTsgfSkKICAgICAgICAgICAgOiBzOwogICAgfTsKICAgIHZhciBtYW51YWxVcHBlcmNhc2UgPSBmdW5jdGlvbiAocykgewogICAgICAgIHJldHVybiBpc1N0cmluZyhzKQogICAgICAgICAgICA/IHMucmVwbGFjZSgvW2Etel0vZywgZnVuY3Rpb24gKGNoKSB7IHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgJiB+MzIpOyB9KQogICAgICAgICAgICA6IHM7CiAgICB9OwoKCiAgICAvLyBTdHJpbmcjdG9Mb3dlckNhc2UgYW5kIFN0cmluZyN0b1VwcGVyQ2FzZSBkb24ndCBwcm9kdWNlIGNvcnJlY3QgcmVzdWx0cyBpbiBicm93c2VycyB3aXRoIFR1cmtpc2gKICAgIC8vIGxvY2FsZSwgZm9yIHRoaXMgcmVhc29uIHdlIG5lZWQgdG8gZGV0ZWN0IHRoaXMgY2FzZSBhbmQgcmVkZWZpbmUgbG93ZXJjYXNlL3VwcGVyY2FzZSBtZXRob2RzCiAgICAvLyB3aXRoIGNvcnJlY3QgYnV0IHNsb3dlciBhbHRlcm5hdGl2ZXMuCiAgICBpZiAoJ2knICE9PSAnSScudG9Mb3dlckNhc2UoKSkgewogICAgICAgIGxvd2VyY2FzZSA9IG1hbnVhbExvd2VyY2FzZTsKICAgICAgICB1cHBlcmNhc2UgPSBtYW51YWxVcHBlcmNhc2U7CiAgICB9CgoKICAgIHZhciAvKiogaG9sZHMgbWFqb3IgdmVyc2lvbiBudW1iZXIgZm9yIElFIG9yIE5hTiBmb3IgcmVhbCBicm93c2VycyAqLwogICAgICAgIG1zaWUsCiAgICAgICAganFMaXRlLCAgICAgICAgICAgLy8gZGVsYXkgYmluZGluZyBzaW5jZSBqUXVlcnkgY291bGQgYmUgbG9hZGVkIGFmdGVyIHVzLgogICAgICAgIGpRdWVyeSwgICAgICAgICAgIC8vIGRlbGF5IGJpbmRpbmcKICAgICAgICBzbGljZSA9IFtdLnNsaWNlLAogICAgICAgIHB1c2ggPSBbXS5wdXNoLAogICAgICAgIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZywKICAgICAgICBuZ01pbkVyciA9IG1pbkVycignbmcnKSwKCgogICAgICAgIF9hbmd1bGFyID0gd2luZG93LmFuZ3VsYXIsCiAgICAgICAgLyoqIEBuYW1lIGFuZ3VsYXIgKi8KICAgICAgICBhbmd1bGFyID0gd2luZG93LmFuZ3VsYXIgfHwgKHdpbmRvdy5hbmd1bGFyID0ge30pLAogICAgICAgIGFuZ3VsYXJNb2R1bGUsCiAgICAgICAgbm9kZU5hbWVfLAogICAgICAgIHVpZCA9IFsnMCcsICcwJywgJzAnXTsKCiAgICAvKioKICAgICAqIElFIDExIGNoYW5nZWQgdGhlIGZvcm1hdCBvZiB0aGUgVXNlckFnZW50IHN0cmluZy4KICAgICAqIFNlZSBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1Mzc1MDMuYXNweAogICAgICovCiAgICBtc2llID0gaW50KCgvbXNpZSAoXGQrKS8uZXhlYyhsb3dlcmNhc2UobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSk7CiAgICBpZiAoaXNOYU4obXNpZSkpIHsKICAgICAgICBtc2llID0gaW50KCgvdHJpZGVudFwvLio7IHJ2OihcZCspLy5leGVjKGxvd2VyY2FzZShuYXZpZ2F0b3IudXNlckFnZW50KSkgfHwgW10pWzFdKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSBvYmoKICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBgb2JqYCBpcyBhbiBhcnJheSBvciBhcnJheS1saWtlIG9iamVjdCAoTm9kZUxpc3QsIEFyZ3VtZW50cywgLi4uKQogICAgICovCiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZShvYmopIHsKICAgICAgICBpZiAob2JqID09IG51bGwgfHwgaXNXaW5kb3cob2JqKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB2YXIgbGVuZ3RoID0gb2JqLmxlbmd0aDsKCiAgICAgICAgaWYgKG9iai5ub2RlVHlwZSA9PT0gMSAmJiBsZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXNBcnJheShvYmopIHx8ICFpc0Z1bmN0aW9uKG9iaikgJiYgKAogICAgICAgICAgbGVuZ3RoID09PSAwIHx8IHR5cGVvZiBsZW5ndGggPT09ICJudW1iZXIiICYmIGxlbmd0aCA+IDAgJiYgKGxlbmd0aCAtIDEpIGluIG9iagogICAgICAgICk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZm9yRWFjaAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBJbnZva2VzIHRoZSBgaXRlcmF0b3JgIGZ1bmN0aW9uIG9uY2UgZm9yIGVhY2ggaXRlbSBpbiBgb2JqYCBjb2xsZWN0aW9uLCB3aGljaCBjYW4gYmUgZWl0aGVyIGFuCiAgICAgKiBvYmplY3Qgb3IgYW4gYXJyYXkuIFRoZSBgaXRlcmF0b3JgIGZ1bmN0aW9uIGlzIGludm9rZWQgd2l0aCBgaXRlcmF0b3IodmFsdWUsIGtleSlgLCB3aGVyZSBgdmFsdWVgCiAgICAgKiBpcyB0aGUgdmFsdWUgb2YgYW4gb2JqZWN0IHByb3BlcnR5IG9yIGFuIGFycmF5IGVsZW1lbnQgYW5kIGBrZXlgIGlzIHRoZSBvYmplY3QgcHJvcGVydHkga2V5IG9yCiAgICAgKiBhcnJheSBlbGVtZW50IGluZGV4LiBTcGVjaWZ5aW5nIGEgYGNvbnRleHRgIGZvciB0aGUgZnVuY3Rpb24gaXMgb3B0aW9uYWwuCiAgICAgKgogICAgICogTm90ZTogdGhpcyBmdW5jdGlvbiB3YXMgcHJldmlvdXNseSBrbm93biBhcyBgYW5ndWxhci5mb3JlYWNoYC4KICAgICAqCiAgICAgICA8cHJlPgogICAgICAgICB2YXIgdmFsdWVzID0ge25hbWU6ICdtaXNrbycsIGdlbmRlcjogJ21hbGUnfTsKICAgICAgICAgdmFyIGxvZyA9IFtdOwogICAgICAgICBhbmd1bGFyLmZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKICAgICAgICAgICB0aGlzLnB1c2goa2V5ICsgJzogJyArIHZhbHVlKTsKICAgICAgICAgfSwgbG9nKTsKICAgICAgICAgZXhwZWN0KGxvZykudG9FcXVhbChbJ25hbWU6IG1pc2tvJywgJ2dlbmRlcjptYWxlJ10pOwogICAgICAgPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R8QXJyYXl9IG9iaiBPYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gaXRlcmF0b3IgSXRlcmF0b3IgZnVuY3Rpb24uCiAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbnRleHQgT2JqZWN0IHRvIGJlY29tZSBjb250ZXh0IChgdGhpc2ApIGZvciB0aGUgaXRlcmF0b3IgZnVuY3Rpb24uCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fEFycmF5fSBSZWZlcmVuY2UgdG8gYG9iamAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvckVhY2gob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgICAgIHZhciBrZXk7CiAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihvYmopKSB7CiAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ICE9ICdwcm90b3R5cGUnICYmIGtleSAhPSAnbGVuZ3RoJyAmJiBrZXkgIT0gJ25hbWUnICYmIG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG9iai5mb3JFYWNoICYmIG9iai5mb3JFYWNoICE9PSBmb3JFYWNoKSB7CiAgICAgICAgICAgICAgICBvYmouZm9yRWFjaChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheUxpa2Uob2JqKSkgewogICAgICAgICAgICAgICAgZm9yIChrZXkgPSAwOyBrZXkgPCBvYmoubGVuZ3RoOyBrZXkrKykKICAgICAgICAgICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmo7CiAgICB9CgogICAgZnVuY3Rpb24gc29ydGVkS2V5cyhvYmopIHsKICAgICAgICB2YXIga2V5cyA9IFtdOwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4ga2V5cy5zb3J0KCk7CiAgICB9CgogICAgZnVuY3Rpb24gZm9yRWFjaFNvcnRlZChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIGtleXMgPSBzb3J0ZWRLZXlzKG9iaik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleXNbaV1dLCBrZXlzW2ldKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGtleXM7CiAgICB9CgoKICAgIC8qKgogICAgICogd2hlbiB1c2luZyBmb3JFYWNoIHRoZSBwYXJhbXMgYXJlIHZhbHVlLCBrZXksIGJ1dCBpdCBpcyBvZnRlbiB1c2VmdWwgdG8gaGF2ZSBrZXksIHZhbHVlLgogICAgICogQHBhcmFtIHtmdW5jdGlvbihzdHJpbmcsICopfSBpdGVyYXRvckZuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKiwgc3RyaW5nKX0KICAgICAqLwogICAgZnVuY3Rpb24gcmV2ZXJzZVBhcmFtcyhpdGVyYXRvckZuKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7IGl0ZXJhdG9yRm4oa2V5LCB2YWx1ZSkgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEEgY29uc2lzdGVudCB3YXkgb2YgY3JlYXRpbmcgdW5pcXVlIElEcyBpbiBhbmd1bGFyLiBUaGUgSUQgaXMgYSBzZXF1ZW5jZSBvZiBhbHBoYSBudW1lcmljCiAgICAgKiBjaGFyYWN0ZXJzIHN1Y2ggYXMgJzAxMkFCQycuIFRoZSByZWFzb24gd2h5IHdlIGFyZSBub3QgdXNpbmcgc2ltcGx5IGEgbnVtYmVyIGNvdW50ZXIgaXMgdGhhdAogICAgICogdGhlIG51bWJlciBzdHJpbmcgZ2V0cyBsb25nZXIgb3ZlciB0aW1lLCBhbmQgaXQgY2FuIGFsc28gb3ZlcmZsb3csIHdoZXJlIGFzIHRoZSBuZXh0SWQKICAgICAqIHdpbGwgZ3JvdyBtdWNoIHNsb3dlciwgaXQgaXMgYSBzdHJpbmcsIGFuZCBpdCB3aWxsIG5ldmVyIG92ZXJmbG93LgogICAgICoKICAgICAqIEByZXR1cm5zIGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogICAgICovCiAgICBmdW5jdGlvbiBuZXh0VWlkKCkgewogICAgICAgIHZhciBpbmRleCA9IHVpZC5sZW5ndGg7CiAgICAgICAgdmFyIGRpZ2l0OwoKICAgICAgICB3aGlsZSAoaW5kZXgpIHsKICAgICAgICAgICAgaW5kZXgtLTsKICAgICAgICAgICAgZGlnaXQgPSB1aWRbaW5kZXhdLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgICAgIGlmIChkaWdpdCA9PSA1NyAvKic5JyovKSB7CiAgICAgICAgICAgICAgICB1aWRbaW5kZXhdID0gJ0EnOwogICAgICAgICAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlnaXQgPT0gOTAgIC8qJ1onKi8pIHsKICAgICAgICAgICAgICAgIHVpZFtpbmRleF0gPSAnMCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1aWRbaW5kZXhdID0gU3RyaW5nLmZyb21DaGFyQ29kZShkaWdpdCArIDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB1aWQudW5zaGlmdCgnMCcpOwogICAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICB9CgoKICAgIC8qKgogICAgICogU2V0IG9yIGNsZWFyIHRoZSBoYXNoa2V5IGZvciBhbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gb2JqIG9iamVjdAogICAgICogQHBhcmFtIGggdGhlIGhhc2hrZXkgKCF0cnV0aHkgdG8gZGVsZXRlIHRoZSBoYXNoa2V5KQogICAgICovCiAgICBmdW5jdGlvbiBzZXRIYXNoS2V5KG9iaiwgaCkgewogICAgICAgIGlmIChoKSB7CiAgICAgICAgICAgIG9iai4kJGhhc2hLZXkgPSBoOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZGVsZXRlIG9iai4kJGhhc2hLZXk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmV4dGVuZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFeHRlbmRzIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QgYGRzdGAgYnkgY29weWluZyBhbGwgb2YgdGhlIHByb3BlcnRpZXMgZnJvbSB0aGUgYHNyY2Agb2JqZWN0KHMpCiAgICAgKiB0byBgZHN0YC4gWW91IGNhbiBzcGVjaWZ5IG11bHRpcGxlIGBzcmNgIG9iamVjdHMuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IGRzdCBEZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gey4uLk9iamVjdH0gc3JjIFNvdXJjZSBvYmplY3QocykuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZWZlcmVuY2UgdG8gYGRzdGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGV4dGVuZChkc3QpIHsKICAgICAgICB2YXIgaCA9IGRzdC4kJGhhc2hLZXk7CiAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgaWYgKG9iaiAhPT0gZHN0KSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgc2V0SGFzaEtleShkc3QsIGgpOwogICAgICAgIHJldHVybiBkc3Q7CiAgICB9CgogICAgZnVuY3Rpb24gaW50KHN0cikgewogICAgICAgIHJldHVybiBwYXJzZUludChzdHIsIDEwKTsKICAgIH0KCgogICAgZnVuY3Rpb24gaW5oZXJpdChwYXJlbnQsIGV4dHJhKSB7CiAgICAgICAgcmV0dXJuIGV4dGVuZChuZXcgKGV4dGVuZChmdW5jdGlvbiAoKSB7IH0sIHsgcHJvdG90eXBlOiBwYXJlbnQgfSkpKCksIGV4dHJhKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5ub29wCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgZnVuY3Rpb24gdGhhdCBwZXJmb3JtcyBubyBvcGVyYXRpb25zLiBUaGlzIGZ1bmN0aW9uIGNhbiBiZSB1c2VmdWwgd2hlbiB3cml0aW5nIGNvZGUgaW4gdGhlCiAgICAgKiBmdW5jdGlvbmFsIHN0eWxlLgogICAgICAgPHByZT4KICAgICAgICAgZnVuY3Rpb24gZm9vKGNhbGxiYWNrKSB7CiAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGN1bGF0ZVJlc3VsdCgpOwogICAgICAgICAgIChjYWxsYmFjayB8fCBhbmd1bGFyLm5vb3ApKHJlc3VsdCk7CiAgICAgICAgIH0KICAgICAgIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiBub29wKCkgeyB9CiAgICBub29wLiRpbmplY3QgPSBbXTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaWRlbnRpdHkKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQSBmdW5jdGlvbiB0aGF0IHJldHVybnMgaXRzIGZpcnN0IGFyZ3VtZW50LiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWZ1bCB3aGVuIHdyaXRpbmcgY29kZSBpbiB0aGUKICAgICAqIGZ1bmN0aW9uYWwgc3R5bGUuCiAgICAgKgogICAgICAgPHByZT4KICAgICAgICAgZnVuY3Rpb24gdHJhbnNmb3JtZXIodHJhbnNmb3JtYXRpb25GbiwgdmFsdWUpIHsKICAgICAgICAgICByZXR1cm4gKHRyYW5zZm9ybWF0aW9uRm4gfHwgYW5ndWxhci5pZGVudGl0eSkodmFsdWUpOwogICAgICAgICB9OwogICAgICAgPC9wcmU+CiAgICAgKi8KICAgIGZ1bmN0aW9uIGlkZW50aXR5KCQpIHsgcmV0dXJuICQ7IH0KICAgIGlkZW50aXR5LiRpbmplY3QgPSBbXTsKCgogICAgZnVuY3Rpb24gdmFsdWVGbih2YWx1ZSkgeyByZXR1cm4gZnVuY3Rpb24gKCkgeyByZXR1cm4gdmFsdWU7IH07IH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc1VuZGVmaW5lZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIHVuZGVmaW5lZC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgdW5kZWZpbmVkLgogICAgICovCiAgICBmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSkgeyByZXR1cm4gdHlwZW9mIHZhbHVlID09ICd1bmRlZmluZWQnOyB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRGVmaW5lZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGRlZmluZWQuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGRlZmluZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRGVmaW5lZCh2YWx1ZSkgeyByZXR1cm4gdHlwZW9mIHZhbHVlICE9ICd1bmRlZmluZWQnOyB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzT2JqZWN0CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYE9iamVjdGAuIFVubGlrZSBgdHlwZW9mYCBpbiBKYXZhU2NyaXB0LCBgbnVsbGBzIGFyZSBub3QKICAgICAqIGNvbnNpZGVyZWQgdG8gYmUgb2JqZWN0cy4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYW4gYE9iamVjdGAgYnV0IG5vdCBgbnVsbGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JzsgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc1N0cmluZwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYFN0cmluZ2AuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYFN0cmluZ2AuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKSB7IHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZyc7IH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuaXNOdW1iZXIKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBOdW1iZXJgLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBOdW1iZXJgLgogICAgICovCiAgICBmdW5jdGlvbiBpc051bWJlcih2YWx1ZSkgeyByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInOyB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRGF0ZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgdmFsdWUgaXMgYSBkYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBEYXRlYC4KICAgICAqLwogICAgZnVuY3Rpb24gaXNEYXRlKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRvU3RyaW5nLmFwcGx5KHZhbHVlKSA9PSAnW29iamVjdCBEYXRlXSc7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzQXJyYXkKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhbiBgQXJyYXlgLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhbiBgQXJyYXlgLgogICAgICovCiAgICBmdW5jdGlvbiBpc0FycmF5KHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRvU3RyaW5nLmFwcGx5KHZhbHVlKSA9PSAnW29iamVjdCBBcnJheV0nOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pc0Z1bmN0aW9uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBgRnVuY3Rpb25gLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBGdW5jdGlvbmAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnZnVuY3Rpb24nOyB9CgoKICAgIC8qKgogICAgICogRGV0ZXJtaW5lcyBpZiBhIHZhbHVlIGlzIGEgcmVndWxhciBleHByZXNzaW9uIG9iamVjdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYFJlZ0V4cGAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzUmVnRXhwKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRvU3RyaW5nLmFwcGx5KHZhbHVlKSA9PSAnW29iamVjdCBSZWdFeHBdJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYG9iamAgaXMgYSB3aW5kb3cgb2JqZWN0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IG9iaiBPYmplY3QgdG8gY2hlY2sKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGBvYmpgIGlzIGEgd2luZG93IG9iai4KICAgICAqLwogICAgZnVuY3Rpb24gaXNXaW5kb3cob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouZG9jdW1lbnQgJiYgb2JqLmxvY2F0aW9uICYmIG9iai5hbGVydCAmJiBvYmouc2V0SW50ZXJ2YWw7CiAgICB9CgoKICAgIGZ1bmN0aW9uIGlzU2NvcGUob2JqKSB7CiAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouJGV2YWxBc3luYyAmJiBvYmouJHdhdGNoOwogICAgfQoKCiAgICBmdW5jdGlvbiBpc0ZpbGUob2JqKSB7CiAgICAgICAgcmV0dXJuIHRvU3RyaW5nLmFwcGx5KG9iaikgPT09ICdbb2JqZWN0IEZpbGVdJzsKICAgIH0KCgogICAgZnVuY3Rpb24gaXNCb29sZWFuKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnYm9vbGVhbic7CiAgICB9CgoKICAgIHZhciB0cmltID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBuYXRpdmUgdHJpbSBpcyB3YXkgZmFzdGVyOiBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyLXRyaW0tdGVzdAogICAgICAgIC8vIGJ1dCBJRSBkb2Vzbid0IGhhdmUgaXQuLi4gOi0oCiAgICAgICAgLy8gVE9ETzogd2Ugc2hvdWxkIG1vdmUgdGhpcyBpbnRvIElFL0VTNSBwb2x5ZmlsbAogICAgICAgIGlmICghU3RyaW5nLnByb3RvdHlwZS50cmltKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS5yZXBsYWNlKC9eXHMqLywgJycpLnJlcGxhY2UoL1xzKiQvLCAnJykgOiB2YWx1ZTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gaXNTdHJpbmcodmFsdWUpID8gdmFsdWUudHJpbSgpIDogdmFsdWU7CiAgICAgICAgfTsKICAgIH0pKCk7CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBhbmd1bGFyLmlzRWxlbWVudAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgRE9NIGVsZW1lbnQgKG9yIHdyYXBwZWQgalF1ZXJ5IGVsZW1lbnQpLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIERPTSBlbGVtZW50IChvciB3cmFwcGVkIGpRdWVyeSBlbGVtZW50KS4KICAgICAqLwogICAgZnVuY3Rpb24gaXNFbGVtZW50KG5vZGUpIHsKICAgICAgICByZXR1cm4gbm9kZSAmJgogICAgICAgICAgKG5vZGUubm9kZU5hbWUgIC8vIHdlIGFyZSBhIGRpcmVjdCBlbGVtZW50CiAgICAgICAgICB8fCAobm9kZS5vbiAmJiBub2RlLmZpbmQpKTsgIC8vIHdlIGhhdmUgYW4gb24gYW5kIGZpbmQgbWV0aG9kIHBhcnQgb2YgalF1ZXJ5IEFQSQogICAgfQoKICAgIC8qKgogICAgICogQHBhcmFtIHN0ciAna2V5MSxrZXkyLC4uLicKICAgICAqIEByZXR1cm5zIHtvYmplY3R9IGluIHRoZSBmb3JtIG9mIHtrZXkxOnRydWUsIGtleTI6dHJ1ZSwgLi4ufQogICAgICovCiAgICBmdW5jdGlvbiBtYWtlTWFwKHN0cikgewogICAgICAgIHZhciBvYmogPSB7fSwgaXRlbXMgPSBzdHIuc3BsaXQoIiwiKSwgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIG9ialtpdGVtc1tpXV0gPSB0cnVlOwogICAgICAgIHJldHVybiBvYmo7CiAgICB9CgoKICAgIGlmIChtc2llIDwgOSkgewogICAgICAgIG5vZGVOYW1lXyA9IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50Lm5vZGVOYW1lID8gZWxlbWVudCA6IGVsZW1lbnRbMF07CiAgICAgICAgICAgIHJldHVybiAoZWxlbWVudC5zY29wZU5hbWUgJiYgZWxlbWVudC5zY29wZU5hbWUgIT0gJ0hUTUwnKQogICAgICAgICAgICAgID8gdXBwZXJjYXNlKGVsZW1lbnQuc2NvcGVOYW1lICsgJzonICsgZWxlbWVudC5ub2RlTmFtZSkgOiBlbGVtZW50Lm5vZGVOYW1lOwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIG5vZGVOYW1lXyA9IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5vZGVOYW1lID8gZWxlbWVudC5ub2RlTmFtZSA6IGVsZW1lbnRbMF0ubm9kZU5hbWU7CiAgICAgICAgfTsKICAgIH0KCgogICAgZnVuY3Rpb24gbWFwKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgICAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgICAgIGZvckVhY2gob2JqLCBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgICAgICAgIHJlc3VsdHMucHVzaChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgfQoKCiAgICAvKioKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIGFycmF5LCB0aGUgbnVtYmVyIG9mIHByb3BlcnRpZXMgYW4gb2JqZWN0IGhhcywgb3IKICAgICAqIHRoZSBsZW5ndGggb2YgYSBzdHJpbmcuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIE9iamVjdCB0eXBlIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMuIFNlZQogICAgICoge0BsaW5rIGFuZ3VsYXIuT2JqZWN0fSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdHxBcnJheXxzdHJpbmd9IG9iaiBPYmplY3QsIGFycmF5LCBvciBzdHJpbmcgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW293blByb3BzT25seT1mYWxzZV0gQ291bnQgb25seSAib3duIiBwcm9wZXJ0aWVzIGluIGFuIG9iamVjdAogICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHNpemUgb2YgYG9iamAgb3IgYDBgIGlmIGBvYmpgIGlzIG5laXRoZXIgYW4gb2JqZWN0IG5vciBhbiBhcnJheS4KICAgICAqLwogICAgZnVuY3Rpb24gc2l6ZShvYmosIG93blByb3BzT25seSkgewogICAgICAgIHZhciBzaXplID0gMCwga2V5OwoKICAgICAgICBpZiAoaXNBcnJheShvYmopIHx8IGlzU3RyaW5nKG9iaikpIHsKICAgICAgICAgICAgcmV0dXJuIG9iai5sZW5ndGg7CiAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIG9iaikKICAgICAgICAgICAgICAgIGlmICghb3duUHJvcHNPbmx5IHx8IG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKQogICAgICAgICAgICAgICAgICAgIHNpemUrKzsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzaXplOwogICAgfQoKCiAgICBmdW5jdGlvbiBpbmNsdWRlcyhhcnJheSwgb2JqKSB7CiAgICAgICAgcmV0dXJuIGluZGV4T2YoYXJyYXksIG9iaikgIT0gLTE7CiAgICB9CgogICAgZnVuY3Rpb24gaW5kZXhPZihhcnJheSwgb2JqKSB7CiAgICAgICAgaWYgKGFycmF5LmluZGV4T2YpIHJldHVybiBhcnJheS5pbmRleE9mKG9iaik7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKG9iaiA9PT0gYXJyYXlbaV0pIHJldHVybiBpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgZnVuY3Rpb24gYXJyYXlSZW1vdmUoYXJyYXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGluZGV4ID0gaW5kZXhPZihhcnJheSwgdmFsdWUpOwogICAgICAgIGlmIChpbmRleCA+PSAwKQogICAgICAgICAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0xlYWZOb2RlKG5vZGUpIHsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBzd2l0Y2ggKG5vZGUubm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgIGNhc2UgIk9QVElPTiI6CiAgICAgICAgICAgICAgICBjYXNlICJQUkUiOgogICAgICAgICAgICAgICAgY2FzZSAiVElUTEUiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5jb3B5CiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBkZWVwIGNvcHkgb2YgYHNvdXJjZWAsIHdoaWNoIHNob3VsZCBiZSBhbiBvYmplY3Qgb3IgYW4gYXJyYXkuCiAgICAgKgogICAgICogKiBJZiBubyBkZXN0aW5hdGlvbiBpcyBzdXBwbGllZCwgYSBjb3B5IG9mIHRoZSBvYmplY3Qgb3IgYXJyYXkgaXMgY3JlYXRlZC4KICAgICAqICogSWYgYSBkZXN0aW5hdGlvbiBpcyBwcm92aWRlZCwgYWxsIG9mIGl0cyBlbGVtZW50cyAoZm9yIGFycmF5KSBvciBwcm9wZXJ0aWVzIChmb3Igb2JqZWN0cykKICAgICAqICAgYXJlIGRlbGV0ZWQgYW5kIHRoZW4gYWxsIGVsZW1lbnRzL3Byb3BlcnRpZXMgZnJvbSB0aGUgc291cmNlIGFyZSBjb3BpZWQgdG8gaXQuCiAgICAgKiAqIElmICBgc291cmNlYCBpcyBub3QgYW4gb2JqZWN0IG9yIGFycmF5LCBgc291cmNlYCBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiBOb3RlOiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgT2JqZWN0IHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICAgKiB7QGxpbmsgbmcuJGZpbHRlcn0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBzb3VyY2UgVGhlIHNvdXJjZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBtYWtlIGEgY29weS4KICAgICAqICAgICAgICAgICAgICAgICAgIENhbiBiZSBhbnkgdHlwZSwgaW5jbHVkaW5nIHByaW1pdGl2ZXMsIGBudWxsYCwgYW5kIGB1bmRlZmluZWRgLgogICAgICogQHBhcmFtIHsoT2JqZWN0fEFycmF5KT19IGRlc3RpbmF0aW9uIERlc3RpbmF0aW9uIGludG8gd2hpY2ggdGhlIHNvdXJjZSBpcyBjb3BpZWQuIElmCiAgICAgKiAgICAgcHJvdmlkZWQsIG11c3QgYmUgb2YgdGhlIHNhbWUgdHlwZSBhcyBgc291cmNlYC4KICAgICAqIEByZXR1cm5zIHsqfSBUaGUgY29weSBvciB1cGRhdGVkIGBkZXN0aW5hdGlvbmAsIGlmIGBkZXN0aW5hdGlvbmAgd2FzIHNwZWNpZmllZC4KICAgICAqLwogICAgZnVuY3Rpb24gY29weShzb3VyY2UsIGRlc3RpbmF0aW9uKSB7CiAgICAgICAgaWYgKGlzV2luZG93KHNvdXJjZSkgfHwgaXNTY29wZShzb3VyY2UpKSB7CiAgICAgICAgICAgIHRocm93IG5nTWluRXJyKCdjcHdzJywgIkNhbid0IGNvcHkhIE1ha2luZyBjb3BpZXMgb2YgV2luZG93IG9yIFNjb3BlIGluc3RhbmNlcyBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFkZXN0aW5hdGlvbikgewogICAgICAgICAgICBkZXN0aW5hdGlvbiA9IHNvdXJjZTsKICAgICAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoc291cmNlKSkgewogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uID0gY29weShzb3VyY2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKHNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbiA9IG5ldyBEYXRlKHNvdXJjZS5nZXRUaW1lKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1JlZ0V4cChzb3VyY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBuZXcgUmVnRXhwKHNvdXJjZS5zb3VyY2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdChzb3VyY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb24gPSBjb3B5KHNvdXJjZSwge30pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSA9PT0gZGVzdGluYXRpb24pIHRocm93IG5nTWluRXJyKCdjcGknLCAiQ2FuJ3QgY29weSEgU291cmNlIGFuZCBkZXN0aW5hdGlvbiBhcmUgaWRlbnRpY2FsLiIpOwogICAgICAgICAgICBpZiAoaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbi5sZW5ndGggPSAwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3VyY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbi5wdXNoKGNvcHkoc291cmNlW2ldKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaCA9IGRlc3RpbmF0aW9uLiQkaGFzaEtleTsKICAgICAgICAgICAgICAgIGZvckVhY2goZGVzdGluYXRpb24sIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRlc3RpbmF0aW9uW2tleV07CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbltrZXldID0gY29weShzb3VyY2Vba2V5XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRIYXNoS2V5KGRlc3RpbmF0aW9uLCBoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVzdGluYXRpb247CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBzaGFsbG93IGNvcHkgb2YgYW4gb2JqZWN0CiAgICAgKi8KICAgIGZ1bmN0aW9uIHNoYWxsb3dDb3B5KHNyYywgZHN0KSB7CiAgICAgICAgZHN0ID0gZHN0IHx8IHt9OwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gc3JjKSB7CiAgICAgICAgICAgIGlmIChzcmMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiBrZXkuc3Vic3RyKDAsIDIpICE9PSAnJCQnKSB7CiAgICAgICAgICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZHN0OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5lcXVhbHMKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGV0ZXJtaW5lcyBpZiB0d28gb2JqZWN0cyBvciB0d28gdmFsdWVzIGFyZSBlcXVpdmFsZW50LiBTdXBwb3J0cyB2YWx1ZSB0eXBlcywgcmVndWxhciBleHByZXNzaW9ucywgYXJyYXlzIGFuZAogICAgICogb2JqZWN0cy4KICAgICAqCiAgICAgKiBUd28gb2JqZWN0cyBvciB2YWx1ZXMgYXJlIGNvbnNpZGVyZWQgZXF1aXZhbGVudCBpZiBhdCBsZWFzdCBvbmUgb2YgdGhlIGZvbGxvd2luZyBpcyB0cnVlOgogICAgICoKICAgICAqICogQm90aCBvYmplY3RzIG9yIHZhbHVlcyBwYXNzIGA9PT1gIGNvbXBhcmlzb24uCiAgICAgKiAqIEJvdGggb2JqZWN0cyBvciB2YWx1ZXMgYXJlIG9mIHRoZSBzYW1lIHR5cGUgYW5kIGFsbCBvZiB0aGVpciBwcm9wZXJ0aWVzIHBhc3MgYD09PWAgY29tcGFyaXNvbi4KICAgICAqICogQm90aCB2YWx1ZXMgYXJlIE5hTi4gKEluIEphdmFzU2NyaXB0LCBOYU4gPT0gTmFOID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIE5hTiBhcyBlcXVhbCkKICAgICAqICogQm90aCB2YWx1ZXMgcmVwcmVzZW50IHRoZSBzYW1lIHJlZ3VsYXIgZXhwcmVzc2lvbiAoSW4gSmF2YXNTY3JpcHQsCiAgICAgKiAgIC9hYmMvID09IC9hYmMvID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIHJlZ3VsYXIgZXhwcmVzc2lvbnMgYXMgZXF1YWwgd2hlbiB0aGVpciB0ZXh0dWFsCiAgICAgKiAgIHJlcHJlc2VudGF0aW9uIG1hdGNoZXMpLgogICAgICoKICAgICAqIER1cmluZyBhIHByb3BlcnR5IGNvbXBhcmlzb24sIHByb3BlcnRpZXMgb2YgYGZ1bmN0aW9uYCB0eXBlIGFuZCBwcm9wZXJ0aWVzIHdpdGggbmFtZXMKICAgICAqIHRoYXQgYmVnaW4gd2l0aCBgJGAgYXJlIGlnbm9yZWQuCiAgICAgKgogICAgICogU2NvcGUgYW5kIERPTVdpbmRvdyBvYmplY3RzIGFyZSBiZWluZyBjb21wYXJlZCBvbmx5IGJ5IGlkZW50aWZ5IChgPT09YCkuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBvMSBPYmplY3Qgb3IgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7Kn0gbzIgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBhcmd1bWVudHMgYXJlIGVxdWFsLgogICAgICovCiAgICBmdW5jdGlvbiBlcXVhbHMobzEsIG8yKSB7CiAgICAgICAgaWYgKG8xID09PSBvMikgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKG8xID09PSBudWxsIHx8IG8yID09PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKG8xICE9PSBvMSAmJiBvMiAhPT0gbzIpIHJldHVybiB0cnVlOyAvLyBOYU4gPT09IE5hTgogICAgICAgIHZhciB0MSA9IHR5cGVvZiBvMSwgdDIgPSB0eXBlb2YgbzIsIGxlbmd0aCwga2V5LCBrZXlTZXQ7CiAgICAgICAgaWYgKHQxID09IHQyKSB7CiAgICAgICAgICAgIGlmICh0MSA9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobzEpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KG8yKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmICgobGVuZ3RoID0gbzEubGVuZ3RoKSA9PSBvMi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgPSAwOyBrZXkgPCBsZW5ndGg7IGtleSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVxdWFscyhvMVtrZXldLCBvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKG8xKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc0RhdGUobzIpICYmIG8xLmdldFRpbWUoKSA9PSBvMi5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzUmVnRXhwKG8xKSAmJiBpc1JlZ0V4cChvMikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbzEudG9TdHJpbmcoKSA9PSBvMi50b1N0cmluZygpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNTY29wZShvMSkgfHwgaXNTY29wZShvMikgfHwgaXNXaW5kb3cobzEpIHx8IGlzV2luZG93KG8yKSB8fCBpc0FycmF5KG8yKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGtleVNldCA9IHt9OwogICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG8xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkuY2hhckF0KDApID09PSAnJCcgfHwgaXNGdW5jdGlvbihvMVtrZXldKSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleVNldFtrZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gbzIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFrZXlTZXQuaGFzT3duUHJvcGVydHkoa2V5KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvMltrZXldICE9PSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICFpc0Z1bmN0aW9uKG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCgogICAgZnVuY3Rpb24gY29uY2F0KGFycmF5MSwgYXJyYXkyLCBpbmRleCkgewogICAgICAgIHJldHVybiBhcnJheTEuY29uY2F0KHNsaWNlLmNhbGwoYXJyYXkyLCBpbmRleCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNsaWNlQXJncyhhcmdzLCBzdGFydEluZGV4KSB7CiAgICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJncywgc3RhcnRJbmRleCB8fCAwKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYmluZAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gd2hpY2ggY2FsbHMgZnVuY3Rpb24gYGZuYCBib3VuZCB0byBgc2VsZmAgKGBzZWxmYCBiZWNvbWVzIHRoZSBgdGhpc2AgZm9yCiAgICAgKiBgZm5gKS4gWW91IGNhbiBzdXBwbHkgb3B0aW9uYWwgYGFyZ3NgIHRoYXQgYXJlIHByZWJvdW5kIHRvIHRoZSBmdW5jdGlvbi4gVGhpcyBmZWF0dXJlIGlzIGFsc28KICAgICAqIGtub3duIGFzIFtmdW5jdGlvbiBjdXJyeWluZ10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9DdXJyeWluZykuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IHNlbGYgQ29udGV4dCB3aGljaCBgZm5gIHNob3VsZCBiZSBldmFsdWF0ZWQgaW4uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEZ1bmN0aW9uIHRvIGJlIGJvdW5kLgogICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwcmVib3VuZCB0byB0aGUgYGZuYCBmdW5jdGlvbiBjYWxsLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEZ1bmN0aW9uIHRoYXQgd3JhcHMgdGhlIGBmbmAgd2l0aCBhbGwgdGhlIHNwZWNpZmllZCBiaW5kaW5ncy4KICAgICAqLwogICAgZnVuY3Rpb24gYmluZChzZWxmLCBmbikgewogICAgICAgIHZhciBjdXJyeUFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoID4gMiA/IHNsaWNlQXJncyhhcmd1bWVudHMsIDIpIDogW107CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZm4pICYmICEoZm4gaW5zdGFuY2VvZiBSZWdFeHApKSB7CiAgICAgICAgICAgIHJldHVybiBjdXJyeUFyZ3MubGVuZ3RoCiAgICAgICAgICAgICAgPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgPyBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSkpCiAgICAgICAgICAgICAgICAgICAgOiBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGgKICAgICAgICAgICAgICAgICAgICA/IGZuLmFwcGx5KHNlbGYsIGFyZ3VtZW50cykKICAgICAgICAgICAgICAgICAgICA6IGZuLmNhbGwoc2VsZik7CiAgICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBpbiBJRSwgbmF0aXZlIG1ldGhvZHMgYXJlIG5vdCBmdW5jdGlvbnMgc28gdGhleSBjYW5ub3QgYmUgYm91bmQgKG5vdGU6IHRoZXkgZG9uJ3QgbmVlZCB0byBiZSkKICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gdG9Kc29uUmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciB2YWwgPSB2YWx1ZTsKCiAgICAgICAgaWYgKC9eXCQrLy50ZXN0KGtleSkpIHsKICAgICAgICAgICAgdmFsID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSBpZiAoaXNXaW5kb3codmFsdWUpKSB7CiAgICAgICAgICAgIHZhbCA9ICckV0lORE9XJzsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlICYmIGRvY3VtZW50ID09PSB2YWx1ZSkgewogICAgICAgICAgICB2YWwgPSAnJERPQ1VNRU5UJzsKICAgICAgICB9IGVsc2UgaWYgKGlzU2NvcGUodmFsdWUpKSB7CiAgICAgICAgICAgIHZhbCA9ICckU0NPUEUnOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIudG9Kc29uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNlcmlhbGl6ZXMgaW5wdXQgaW50byBhIEpTT04tZm9ybWF0dGVkIHN0cmluZy4gUHJvcGVydGllcyB3aXRoIGxlYWRpbmcgJCBjaGFyYWN0ZXJzIHdpbGwgYmUKICAgICAqIHN0cmlwcGVkIHNpbmNlIGFuZ3VsYXIgdXNlcyB0aGlzIG5vdGF0aW9uIGludGVybmFsbHkuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R8QXJyYXl8RGF0ZXxzdHJpbmd8bnVtYmVyfSBvYmogSW5wdXQgdG8gYmUgc2VyaWFsaXplZCBpbnRvIEpTT04uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBwcmV0dHkgSWYgc2V0IHRvIHRydWUsIHRoZSBKU09OIG91dHB1dCB3aWxsIGNvbnRhaW4gbmV3bGluZXMgYW5kIHdoaXRlc3BhY2UuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gSlNPTi1pZmllZCBzdHJpbmcgcmVwcmVzZW50aW5nIGBvYmpgLgogICAgICovCiAgICBmdW5jdGlvbiB0b0pzb24ob2JqLCBwcmV0dHkpIHsKICAgICAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaiwgdG9Kc29uUmVwbGFjZXIsIHByZXR0eSA/ICcgICcgOiBudWxsKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZnJvbUpzb24KICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGVzZXJpYWxpemVzIGEgSlNPTiBzdHJpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGpzb24gSlNPTiBzdHJpbmcgdG8gZGVzZXJpYWxpemUuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fEFycmF5fERhdGV8c3RyaW5nfG51bWJlcn0gRGVzZXJpYWxpemVkIHRoaW5neS4KICAgICAqLwogICAgZnVuY3Rpb24gZnJvbUpzb24oanNvbikgewogICAgICAgIHJldHVybiBpc1N0cmluZyhqc29uKQogICAgICAgICAgICA/IEpTT04ucGFyc2UoanNvbikKICAgICAgICAgICAgOiBqc29uOwogICAgfQoKCiAgICBmdW5jdGlvbiB0b0Jvb2xlYW4odmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHZhciB2ID0gbG93ZXJjYXNlKCIiICsgdmFsdWUpOwogICAgICAgICAgICB2YWx1ZSA9ICEodiA9PSAnZicgfHwgdiA9PSAnMCcgfHwgdiA9PSAnZmFsc2UnIHx8IHYgPT0gJ25vJyB8fCB2ID09ICduJyB8fCB2ID09ICdbXScpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgZWxlbWVudC4KICAgICAqLwogICAgZnVuY3Rpb24gc3RhcnRpbmdUYWcoZWxlbWVudCkgewogICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCkuY2xvbmUoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyB0dXJucyBvdXQgSUUgZG9lcyBub3QgbGV0IHlvdSBzZXQgLmh0bWwoKSBvbiBlbGVtZW50cyB3aGljaAogICAgICAgICAgICAvLyBhcmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBjaGlsZHJlbi4gU28gd2UganVzdCBpZ25vcmUgaXQuCiAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgfSBjYXRjaCAoZSkgeyB9CiAgICAgICAgLy8gQXMgUGVyIERPTSBTdGFuZGFyZHMKICAgICAgICB2YXIgVEVYVF9OT0RFID0gMzsKICAgICAgICB2YXIgZWxlbUh0bWwgPSBqcUxpdGUoJzxkaXY+JykuYXBwZW5kKGVsZW1lbnQpLmh0bWwoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudFswXS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gbG93ZXJjYXNlKGVsZW1IdG1sKSA6CiAgICAgICAgICAgICAgICBlbGVtSHRtbC4KICAgICAgICAgICAgICAgICAgbWF0Y2goL14oPFtePl0rPikvKVsxXS4KICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvXjwoW1x3XC1dKykvLCBmdW5jdGlvbiAobWF0Y2gsIG5vZGVOYW1lKSB7IHJldHVybiAnPCcgKyBsb3dlcmNhc2Uobm9kZU5hbWUpOyB9KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBsb3dlcmNhc2UoZWxlbUh0bWwpOwogICAgICAgIH0KCiAgICB9CgoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvKioKICAgICAqIFRyaWVzIHRvIGRlY29kZSB0aGUgVVJJIGNvbXBvbmVudCB3aXRob3V0IHRocm93aW5nIGFuIGV4Y2VwdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHN0ciB2YWx1ZSBwb3RlbnRpYWwgVVJJIGNvbXBvbmVudCB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgY2FuIGJlIGRlY29kZWQKICAgICAqIHdpdGggdGhlIGRlY29kZVVSSUNvbXBvbmVudCBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyBJZ25vcmUgYW55IGludmFsaWQgdXJpIGNvbXBvbmVudAogICAgICAgIH0KICAgIH0KCgogICAgLyoqCiAgICAgKiBQYXJzZXMgYW4gZXNjYXBlZCB1cmwgcXVlcnkgc3RyaW5nIGludG8ga2V5LXZhbHVlIHBhaXJzLgogICAgICogQHJldHVybnMgT2JqZWN0Ljwoc3RyaW5nfGJvb2xlYW4pPgogICAgICovCiAgICBmdW5jdGlvbiBwYXJzZUtleVZhbHVlKC8qKnN0cmluZyova2V5VmFsdWUpIHsKICAgICAgICB2YXIgb2JqID0ge30sIGtleV92YWx1ZSwga2V5OwogICAgICAgIGZvckVhY2goKGtleVZhbHVlIHx8ICIiKS5zcGxpdCgnJicpLCBmdW5jdGlvbiAoa2V5VmFsdWUpIHsKICAgICAgICAgICAgaWYgKGtleVZhbHVlKSB7CiAgICAgICAgICAgICAgICBrZXlfdmFsdWUgPSBrZXlWYWx1ZS5zcGxpdCgnPScpOwogICAgICAgICAgICAgICAga2V5ID0gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KGtleV92YWx1ZVswXSk7CiAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGtleSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsID0gaXNEZWZpbmVkKGtleV92YWx1ZVsxXSkgPyB0cnlEZWNvZGVVUklDb21wb25lbnQoa2V5X3ZhbHVlWzFdKSA6IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFvYmpba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqW2tleV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9ialtrZXldLnB1c2godmFsKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IFtvYmpba2V5XSwgdmFsXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIGZ1bmN0aW9uIHRvS2V5VmFsdWUob2JqKSB7CiAgICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgICAgZm9yRWFjaChvYmosIGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgZm9yRWFjaCh2YWx1ZSwgZnVuY3Rpb24gKGFycmF5VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGVuY29kZVVyaVF1ZXJ5KGtleSwgdHJ1ZSkgKyAoYXJyYXlWYWx1ZSA9PT0gdHJ1ZSA/ICcnIDogJz0nICsgZW5jb2RlVXJpUXVlcnkoYXJyYXlWYWx1ZSwgdHJ1ZSkpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcGFydHMucHVzaChlbmNvZGVVcmlRdWVyeShrZXksIHRydWUpICsgKHZhbHVlID09PSB0cnVlID8gJycgOiAnPScgKyBlbmNvZGVVcmlRdWVyeSh2YWx1ZSwgdHJ1ZSkpKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBwYXJ0cy5sZW5ndGggPyBwYXJ0cy5qb2luKCcmJykgOiAnJzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBXZSBuZWVkIG91ciBjdXN0b20gbWV0aG9kIGJlY2F1c2UgZW5jb2RlVVJJQ29tcG9uZW50IGlzIHRvbyBhZ2dyZXNzaXZlIGFuZCBkb2Vzbid0IGZvbGxvdwogICAgICogaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMzk4Ni50eHQgd2l0aCByZWdhcmRzIHRvIHRoZSBjaGFyYWN0ZXIgc2V0IChwY2hhcikgYWxsb3dlZCBpbiBwYXRoCiAgICAgKiBzZWdtZW50czoKICAgICAqICAgIHNlZ21lbnQgICAgICAgPSAqcGNoYXIKICAgICAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAgICAgKiAgICBwY3QtZW5jb2RlZCAgID0gIiUiIEhFWERJRyBIRVhESUcKICAgICAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAgICAgKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZVVyaVNlZ21lbnQodmFsKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZVVyaVF1ZXJ5KHZhbCwgdHJ1ZSkuCiAgICAgICAgICAgICAgICAgICByZXBsYWNlKC8lMjYvZ2ksICcmJykuCiAgICAgICAgICAgICAgICAgICByZXBsYWNlKC8lM0QvZ2ksICc9JykuCiAgICAgICAgICAgICAgICAgICByZXBsYWNlKC8lMkIvZ2ksICcrJyk7CiAgICB9CgoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgaW50ZW5kZWQgZm9yIGVuY29kaW5nICprZXkqIG9yICp2YWx1ZSogcGFydHMgb2YgcXVlcnkgY29tcG9uZW50LiBXZSBuZWVkIGEgY3VzdG9tCiAgICAgKiBtZXRob2QgYmVjYXVzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFnZ3Jlc3NpdmUgYW5kIGVuY29kZXMgc3R1ZmYgdGhhdCBkb2Vzbid0IGhhdmUgdG8gYmUKICAgICAqIGVuY29kZWQgcGVyIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzM5ODY6CiAgICAgKiAgICBxdWVyeSAgICAgICA9ICooIHBjaGFyIC8gIi8iIC8gIj8iICkKICAgICAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAgICAgKiAgICB1bnJlc2VydmVkICAgID0gQUxQSEEgLyBESUdJVCAvICItIiAvICIuIiAvICJfIiAvICJ+IgogICAgICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAgICAgKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAgICAgKiAgICAgICAgICAgICAgICAgICAgIC8gIioiIC8gIisiIC8gIiwiIC8gIjsiIC8gIj0iCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZVVyaVF1ZXJ5KHZhbCwgcGN0RW5jb2RlU3BhY2VzKSB7CiAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpLgogICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvJTQwL2dpLCAnQCcpLgogICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvJTNBL2dpLCAnOicpLgogICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvJTI0L2csICckJykuCiAgICAgICAgICAgICAgICAgICByZXBsYWNlKC8lMkMvZ2ksICcsJykuCiAgICAgICAgICAgICAgICAgICByZXBsYWNlKC8lMjAvZywgKHBjdEVuY29kZVNwYWNlcyA/ICclMjAnIDogJysnKSk7CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQXBwCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2FuZ3VsYXIuTW9kdWxlfSBuZ0FwcCBhbiBvcHRpb25hbCBhcHBsaWNhdGlvbgogICAgICogICB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlfSBuYW1lIHRvIGxvYWQuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVXNlIHRoaXMgZGlyZWN0aXZlIHRvIGF1dG8tYm9vdHN0cmFwIGFuIGFwcGxpY2F0aW9uLiBPbmx5CiAgICAgKiBvbmUgbmdBcHAgZGlyZWN0aXZlIGNhbiBiZSB1c2VkIHBlciBIVE1MIGRvY3VtZW50LiBUaGUgZGlyZWN0aXZlCiAgICAgKiBkZXNpZ25hdGVzIHRoZSByb290IG9mIHRoZSBhcHBsaWNhdGlvbiBhbmQgaXMgdHlwaWNhbGx5IHBsYWNlZAogICAgICogYXQgdGhlIHJvb3Qgb2YgdGhlIHBhZ2UuCiAgICAgKgogICAgICogVGhlIGZpcnN0IG5nQXBwIGZvdW5kIGluIHRoZSBkb2N1bWVudCB3aWxsIGJlIGF1dG8tYm9vdHN0cmFwcGVkLiBUbyB1c2UgbXVsdGlwbGUgYXBwbGljYXRpb25zIGluIGFuCiAgICAgKiBIVE1MIGRvY3VtZW50IHlvdSBtdXN0IG1hbnVhbGx5IGJvb3RzdHJhcCB0aGVtIHVzaW5nIHtAbGluayBhbmd1bGFyLmJvb3RzdHJhcH0uCiAgICAgKiBBcHBsaWNhdGlvbnMgY2Fubm90IGJlIG5lc3RlZC4KICAgICAqCiAgICAgKiBJbiB0aGUgZXhhbXBsZSBiZWxvdyBpZiB0aGUgYG5nQXBwYCBkaXJlY3RpdmUgd291bGQgbm90IGJlIHBsYWNlZAogICAgICogb24gdGhlIGBodG1sYCBlbGVtZW50IHRoZW4gdGhlIGRvY3VtZW50IHdvdWxkIG5vdCBiZSBjb21waWxlZAogICAgICogYW5kIHRoZSBge3sgMSsyIH19YCB3b3VsZCBub3QgYmUgcmVzb2x2ZWQgdG8gYDNgLgogICAgICoKICAgICAqIGBuZ0FwcGAgaXMgdGhlIGVhc2llc3Qgd2F5IHRvIGJvb3RzdHJhcCBhbiBhcHBsaWNhdGlvbi4KICAgICAqCiAgICAgPGRvYzpleGFtcGxlPgogICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgSSBjYW4gYWRkOiAxICsgMiA9ICB7eyAxKzIgfX0KICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gYW5ndWxhckluaXQoZWxlbWVudCwgYm9vdHN0cmFwKSB7CiAgICAgICAgdmFyIGVsZW1lbnRzID0gW2VsZW1lbnRdLAogICAgICAgICAgICBhcHBFbGVtZW50LAogICAgICAgICAgICBtb2R1bGUsCiAgICAgICAgICAgIG5hbWVzID0gWyduZzphcHAnLCAnbmctYXBwJywgJ3gtbmctYXBwJywgJ2RhdGEtbmctYXBwJ10sCiAgICAgICAgICAgIE5HX0FQUF9DTEFTU19SRUdFWFAgPSAvXHNuZ1s6XC1dYXBwKDpccyooW1x3XGRfXSspOz8pP1xzLzsKCiAgICAgICAgZnVuY3Rpb24gYXBwZW5kKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudCAmJiBlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgZm9yRWFjaChuYW1lcywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgbmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBhcHBlbmQoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobmFtZSkpOwogICAgICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKCc6JywgJ1xcOicpOwogICAgICAgICAgICBpZiAoZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLicgKyBuYW1lKSwgYXBwZW5kKTsKICAgICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIG5hbWUgKyAnXFw6JyksIGFwcGVuZCk7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnWycgKyBuYW1lICsgJ10nKSwgYXBwZW5kKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBmb3JFYWNoKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICBpZiAoIWFwcEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjbGFzc05hbWUgPSAnICcgKyBlbGVtZW50LmNsYXNzTmFtZSArICcgJzsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IE5HX0FQUF9DTEFTU19SRUdFWFAuZXhlYyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgYXBwRWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgbW9kdWxlID0gKG1hdGNoWzJdIHx8ICcnKS5yZXBsYWNlKC9ccysvZywgJywnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LmF0dHJpYnV0ZXMsIGZ1bmN0aW9uIChhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXBwRWxlbWVudCAmJiBuYW1lc1thdHRyLm5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZSA9IGF0dHIudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmIChhcHBFbGVtZW50KSB7CiAgICAgICAgICAgIGJvb3RzdHJhcChhcHBFbGVtZW50LCBtb2R1bGUgPyBbbW9kdWxlXSA6IFtdKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuYm9vdHN0cmFwCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFVzZSB0aGlzIGZ1bmN0aW9uIHRvIG1hbnVhbGx5IHN0YXJ0IHVwIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAgICAgKgogICAgICogU2VlOiB7QGxpbmsgZ3VpZGUvYm9vdHN0cmFwIEJvb3RzdHJhcH0KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgbmdTY2VuYXJpby1iYXNlZCBlbmQtdG8tZW5kIHRlc3RzIGNhbm5vdCB1c2UgdGhpcyBmdW5jdGlvbiB0byBib290c3RyYXAgbWFudWFsbHkuCiAgICAgKiBUaGV5IG11c3QgdXNlIHtAbGluayBhcGkvbmcuZGlyZWN0aXZlOm5nQXBwIG5nQXBwfS4KICAgICAqCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgRE9NIGVsZW1lbnQgd2hpY2ggaXMgdGhlIHJvb3Qgb2YgYW5ndWxhciBhcHBsaWNhdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nfEZ1bmN0aW9uPj19IG1vZHVsZXMgYW4gYXJyYXkgb2YgbW9kdWxlIGRlY2xhcmF0aW9ucy4gU2VlOiB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30KICAgICAqIEByZXR1cm5zIHtBVVRPLiRpbmplY3Rvcn0gUmV0dXJucyB0aGUgbmV3bHkgY3JlYXRlZCBpbmplY3RvciBmb3IgdGhpcyBhcHAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJvb3RzdHJhcChlbGVtZW50LCBtb2R1bGVzKSB7CiAgICAgICAgdmFyIGRvQm9vdHN0cmFwID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwoKICAgICAgICAgICAgaWYgKGVsZW1lbnQuaW5qZWN0b3IoKSkgewogICAgICAgICAgICAgICAgdmFyIHRhZyA9IChlbGVtZW50WzBdID09PSBkb2N1bWVudCkgPyAnZG9jdW1lbnQnIDogc3RhcnRpbmdUYWcoZWxlbWVudCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZ01pbkVycignYnRzdHJwZCcsICJBcHAgQWxyZWFkeSBCb290c3RyYXBwZWQgd2l0aCB0aGlzIEVsZW1lbnQgJ3swfSciLCB0YWcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtb2R1bGVzID0gbW9kdWxlcyB8fCBbXTsKICAgICAgICAgICAgbW9kdWxlcy51bnNoaWZ0KFsnJHByb3ZpZGUnLCBmdW5jdGlvbiAoJHByb3ZpZGUpIHsKICAgICAgICAgICAgICAgICRwcm92aWRlLnZhbHVlKCckcm9vdEVsZW1lbnQnLCBlbGVtZW50KTsKICAgICAgICAgICAgfV0pOwogICAgICAgICAgICBtb2R1bGVzLnVuc2hpZnQoJ25nJyk7CiAgICAgICAgICAgIHZhciBpbmplY3RvciA9IGNyZWF0ZUluamVjdG9yKG1vZHVsZXMpOwogICAgICAgICAgICBpbmplY3Rvci5pbnZva2UoWyckcm9vdFNjb3BlJywgJyRyb290RWxlbWVudCcsICckY29tcGlsZScsICckaW5qZWN0b3InLCAnJGFuaW1hdGUnLAogICAgICAgICAgICAgICBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGNvbXBpbGUsIGluamVjdG9yLCBhbmltYXRlKSB7CiAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YSgnJGluamVjdG9yJywgaW5qZWN0b3IpOwogICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGUoZWxlbWVudCkoc2NvcGUpOwogICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICBhbmltYXRlLmVuYWJsZWQodHJ1ZSk7CiAgICAgICAgICAgICAgIH1dCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybiBpbmplY3RvcjsKICAgICAgICB9OwoKICAgICAgICB2YXIgTkdfREVGRVJfQk9PVFNUUkFQID0gL15OR19ERUZFUl9CT09UU1RSQVAhLzsKCiAgICAgICAgaWYgKHdpbmRvdyAmJiAhTkdfREVGRVJfQk9PVFNUUkFQLnRlc3Qod2luZG93Lm5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBkb0Jvb3RzdHJhcCgpOwogICAgICAgIH0KCiAgICAgICAgd2luZG93Lm5hbWUgPSB3aW5kb3cubmFtZS5yZXBsYWNlKE5HX0RFRkVSX0JPT1RTVFJBUCwgJycpOwogICAgICAgIGFuZ3VsYXIucmVzdW1lQm9vdHN0cmFwID0gZnVuY3Rpb24gKGV4dHJhTW9kdWxlcykgewogICAgICAgICAgICBmb3JFYWNoKGV4dHJhTW9kdWxlcywgZnVuY3Rpb24gKG1vZHVsZSkgewogICAgICAgICAgICAgICAgbW9kdWxlcy5wdXNoKG1vZHVsZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkb0Jvb3RzdHJhcCgpOwogICAgICAgIH07CiAgICB9CgogICAgdmFyIFNOQUtFX0NBU0VfUkVHRVhQID0gL1tBLVpdL2c7CiAgICBmdW5jdGlvbiBzbmFrZV9jYXNlKG5hbWUsIHNlcGFyYXRvcikgewogICAgICAgIHNlcGFyYXRvciA9IHNlcGFyYXRvciB8fCAnXyc7CiAgICAgICAgcmV0dXJuIG5hbWUucmVwbGFjZShTTkFLRV9DQVNFX1JFR0VYUCwgZnVuY3Rpb24gKGxldHRlciwgcG9zKSB7CiAgICAgICAgICAgIHJldHVybiAocG9zID8gc2VwYXJhdG9yIDogJycpICsgbGV0dGVyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gYmluZEpRdWVyeSgpIHsKICAgICAgICAvLyBiaW5kIHRvIGpRdWVyeSBpZiBwcmVzZW50OwogICAgICAgIGpRdWVyeSA9IHdpbmRvdy5qUXVlcnk7CiAgICAgICAgLy8gcmVzZXQgdG8galF1ZXJ5IG9yIGRlZmF1bHQgdG8gdXMuCiAgICAgICAgaWYgKGpRdWVyeSkgewogICAgICAgICAgICBqcUxpdGUgPSBqUXVlcnk7CiAgICAgICAgICAgIGV4dGVuZChqUXVlcnkuZm4sIHsKICAgICAgICAgICAgICAgIHNjb3BlOiBKUUxpdGVQcm90b3R5cGUuc2NvcGUsCiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiBKUUxpdGVQcm90b3R5cGUuY29udHJvbGxlciwKICAgICAgICAgICAgICAgIGluamVjdG9yOiBKUUxpdGVQcm90b3R5cGUuaW5qZWN0b3IsCiAgICAgICAgICAgICAgICBpbmhlcml0ZWREYXRhOiBKUUxpdGVQcm90b3R5cGUuaW5oZXJpdGVkRGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gTWV0aG9kIHNpZ25hdHVyZTogSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUobmFtZSwgZGlzcGF0Y2hUaGlzLCBmaWx0ZXJFbGVtcywgZ2V0dGVySWZOb0FyZ3VtZW50cykKICAgICAgICAgICAgSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUoJ3JlbW92ZScsIHRydWUsIHRydWUsIGZhbHNlKTsKICAgICAgICAgICAgSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUoJ2VtcHR5JywgZmFsc2UsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgIEpRTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdodG1sJywgZmFsc2UsIGZhbHNlLCB0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBqcUxpdGUgPSBKUUxpdGU7CiAgICAgICAgfQogICAgICAgIGFuZ3VsYXIuZWxlbWVudCA9IGpxTGl0ZTsKICAgIH0KCiAgICAvKioKICAgICAqIHRocm93IGVycm9yIGlmIHRoZSBhcmd1bWVudCBpcyBmYWxzeS4KICAgICAqLwogICAgZnVuY3Rpb24gYXNzZXJ0QXJnKGFyZywgbmFtZSwgcmVhc29uKSB7CiAgICAgICAgaWYgKCFhcmcpIHsKICAgICAgICAgICAgdGhyb3cgbmdNaW5FcnIoJ2FyZXEnLCAiQXJndW1lbnQgJ3swfScgaXMgezF9IiwgKG5hbWUgfHwgJz8nKSwgKHJlYXNvbiB8fCAicmVxdWlyZWQiKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcmc7CiAgICB9CgogICAgZnVuY3Rpb24gYXNzZXJ0QXJnRm4oYXJnLCBuYW1lLCBhY2NlcHRBcnJheUFubm90YXRpb24pIHsKICAgICAgICBpZiAoYWNjZXB0QXJyYXlBbm5vdGF0aW9uICYmIGlzQXJyYXkoYXJnKSkgewogICAgICAgICAgICBhcmcgPSBhcmdbYXJnLmxlbmd0aCAtIDFdOwogICAgICAgIH0KCiAgICAgICAgYXNzZXJ0QXJnKGlzRnVuY3Rpb24oYXJnKSwgbmFtZSwgJ25vdCBhIGZ1bmN0aW9uLCBnb3QgJyArCiAgICAgICAgICAgIChhcmcgJiYgdHlwZW9mIGFyZyA9PSAnb2JqZWN0JyA/IGFyZy5jb25zdHJ1Y3Rvci5uYW1lIHx8ICdPYmplY3QnIDogdHlwZW9mIGFyZykpOwogICAgICAgIHJldHVybiBhcmc7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIHZhbHVlIGFjY2Vzc2libGUgZnJvbSB0aGUgb2JqZWN0IGJ5IHBhdGguIEFueSB1bmRlZmluZWQgdHJhdmVyc2FscyBhcmUgaWdub3JlZAogICAgICogQHBhcmFtIHtPYmplY3R9IG9iaiBzdGFydGluZyBvYmplY3QKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIHBhdGggdG8gdHJhdmVyc2UKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj10cnVlfSBiaW5kRm5Ub1Njb3BlCiAgICAgKiBAcmV0dXJucyB2YWx1ZSBhcyBhY2Nlc3NpYmxlIGJ5IHBhdGgKICAgICAqLwogICAgLy9UT0RPKG1pc2tvKTogdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSByZW1vdmVkCiAgICBmdW5jdGlvbiBnZXR0ZXIob2JqLCBwYXRoLCBiaW5kRm5Ub1Njb3BlKSB7CiAgICAgICAgaWYgKCFwYXRoKSByZXR1cm4gb2JqOwogICAgICAgIHZhciBrZXlzID0gcGF0aC5zcGxpdCgnLicpOwogICAgICAgIHZhciBrZXk7CiAgICAgICAgdmFyIGxhc3RJbnN0YW5jZSA9IG9iajsKICAgICAgICB2YXIgbGVuID0ga2V5cy5sZW5ndGg7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgICAgICAgb2JqID0gKGxhc3RJbnN0YW5jZSA9IG9iailba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWJpbmRGblRvU2NvcGUgJiYgaXNGdW5jdGlvbihvYmopKSB7CiAgICAgICAgICAgIHJldHVybiBiaW5kKGxhc3RJbnN0YW5jZSwgb2JqKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBpbnRlcmZhY2UKICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBJbnRlcmZhY2UgZm9yIGNvbmZpZ3VyaW5nIGFuZ3VsYXIge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZXN9LgogICAgICovCgogICAgZnVuY3Rpb24gc2V0dXBNb2R1bGVMb2FkZXIod2luZG93KSB7CgogICAgICAgIGZ1bmN0aW9uIGVuc3VyZShvYmosIG5hbWUsIGZhY3RvcnkpIHsKICAgICAgICAgICAgcmV0dXJuIG9ialtuYW1lXSB8fCAob2JqW25hbWVdID0gZmFjdG9yeSgpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbnN1cmUoZW5zdXJlKHdpbmRvdywgJ2FuZ3VsYXInLCBPYmplY3QpLCAnbW9kdWxlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvKiogQHR5cGUge09iamVjdC48c3RyaW5nLCBhbmd1bGFyLk1vZHVsZT59ICovCiAgICAgICAgICAgIHZhciBtb2R1bGVzID0ge307CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIubW9kdWxlCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGUgYGFuZ3VsYXIubW9kdWxlYCBpcyBhIGdsb2JhbCBwbGFjZSBmb3IgY3JlYXRpbmcsIHJlZ2lzdGVyaW5nIGFuZCByZXRyaWV2aW5nIEFuZ3VsYXIgbW9kdWxlcy4KICAgICAgICAgICAgICogQWxsIG1vZHVsZXMgKGFuZ3VsYXIgY29yZSBvciAzcmQgcGFydHkpIHRoYXQgc2hvdWxkIGJlIGF2YWlsYWJsZSB0byBhbiBhcHBsaWNhdGlvbiBtdXN0IGJlCiAgICAgICAgICAgICAqIHJlZ2lzdGVyZWQgdXNpbmcgdGhpcyBtZWNoYW5pc20uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFdoZW4gcGFzc2VkIHR3byBvciBtb3JlIGFyZ3VtZW50cywgYSBuZXcgbW9kdWxlIGlzIGNyZWF0ZWQuICBJZiBwYXNzZWQgb25seSBvbmUgYXJndW1lbnQsIGFuCiAgICAgICAgICAgICAqIGV4aXN0aW5nIG1vZHVsZSAodGhlIG5hbWUgcGFzc2VkIGFzIHRoZSBmaXJzdCBhcmd1bWVudCB0byBgbW9kdWxlYCkgaXMgcmV0cmlldmVkLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAjIE1vZHVsZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBBIG1vZHVsZSBpcyBhIGNvbGxlY3Rpb24gb2Ygc2VydmljZXMsIGRpcmVjdGl2ZXMsIGZpbHRlcnMsIGFuZCBjb25maWd1cmF0aW9uIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgKiBgYW5ndWxhci5tb2R1bGVgIGlzIHVzZWQgdG8gY29uZmlndXJlIHRoZSB7QGxpbmsgQVVUTy4kaW5qZWN0b3IgJGluamVjdG9yfS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICogLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZQogICAgICAgICAgICAgKiB2YXIgbXlNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnbXlNb2R1bGUnLCBbXSk7CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIC8vIHJlZ2lzdGVyIGEgbmV3IHNlcnZpY2UKICAgICAgICAgICAgICogbXlNb2R1bGUudmFsdWUoJ2FwcE5hbWUnLCAnTXlDb29sQXBwJyk7CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIC8vIGNvbmZpZ3VyZSBleGlzdGluZyBzZXJ2aWNlcyBpbnNpZGUgaW5pdGlhbGl6YXRpb24gYmxvY2tzLgogICAgICAgICAgICAgKiBteU1vZHVsZS5jb25maWcoZnVuY3Rpb24oJGxvY2F0aW9uUHJvdmlkZXIpIHsKICAgICAgICAgICAgICogICAvLyBDb25maWd1cmUgZXhpc3RpbmcgcHJvdmlkZXJzCiAgICAgICAgICAgICAqICAgJGxvY2F0aW9uUHJvdmlkZXIuaGFzaFByZWZpeCgnIScpOwogICAgICAgICAgICAgKiB9KTsKICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRoZW4geW91IGNhbiBjcmVhdGUgYW4gaW5qZWN0b3IgYW5kIGxvYWQgeW91ciBtb2R1bGVzIGxpa2UgdGhpczoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICogdmFyIGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcihbJ25nJywgJ015TW9kdWxlJ10pCiAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBIb3dldmVyIGl0J3MgbW9yZSBsaWtlbHkgdGhhdCB5b3UnbGwganVzdCB1c2UKICAgICAgICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0FwcCBuZ0FwcH0gb3IKICAgICAgICAgICAgICoge0BsaW5rIGFuZ3VsYXIuYm9vdHN0cmFwfSB0byBzaW1wbGlmeSB0aGlzIHByb2Nlc3MgZm9yIHlvdS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHshc3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBtb2R1bGUgdG8gY3JlYXRlIG9yIHJldHJpZXZlLgogICAgICAgICAgICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmc+PX0gcmVxdWlyZXMgSWYgc3BlY2lmaWVkIHRoZW4gbmV3IG1vZHVsZSBpcyBiZWluZyBjcmVhdGVkLiBJZiB1bnNwZWNpZmllZCB0aGVuIHRoZQogICAgICAgICAgICAgKiAgICAgICAgdGhlIG1vZHVsZSBpcyBiZWluZyByZXRyaWV2ZWQgZm9yIGZ1cnRoZXIgY29uZmlndXJhdGlvbi4KICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uZmlnRm4gT3B0aW9uYWwgY29uZmlndXJhdGlvbiBmdW5jdGlvbiBmb3IgdGhlIG1vZHVsZS4gU2FtZSBhcwogICAgICAgICAgICAgKiAgICAgICAge0BsaW5rIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZyBNb2R1bGUjY29uZmlnKCl9LgogICAgICAgICAgICAgKiBAcmV0dXJucyB7bW9kdWxlfSBuZXcgbW9kdWxlIHdpdGggdGhlIHtAbGluayBhbmd1bGFyLk1vZHVsZX0gYXBpLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIG1vZHVsZShuYW1lLCByZXF1aXJlcywgY29uZmlnRm4pIHsKICAgICAgICAgICAgICAgIGlmIChyZXF1aXJlcyAmJiBtb2R1bGVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgbW9kdWxlc1tuYW1lXSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZW5zdXJlKG1vZHVsZXMsIG5hbWUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXJlcXVpcmVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG1pbkVycignJGluamVjdG9yJykoJ25vbW9kJywgIk1vZHVsZSAnezB9JyBpcyBub3QgYXZhaWxhYmxlISBZb3UgZWl0aGVyIG1pc3NwZWxsZWQgdGhlIG1vZHVsZSBuYW1lICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm9yIGZvcmdvdCB0byBsb2FkIGl0LiBJZiByZWdpc3RlcmluZyBhIG1vZHVsZSBlbnN1cmUgdGhhdCB5b3Ugc3BlY2lmeSB0aGUgZGVwZW5kZW5jaWVzIGFzIHRoZSBzZWNvbmQgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYXJndW1lbnQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvKiogQHR5cGUgeyFBcnJheS48QXJyYXkuPCo+Pn0gKi8KICAgICAgICAgICAgICAgICAgICB2YXIgaW52b2tlUXVldWUgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgLyoqIEB0eXBlIHshQXJyYXkuPEZ1bmN0aW9uPn0gKi8KICAgICAgICAgICAgICAgICAgICB2YXIgcnVuQmxvY2tzID0gW107CgogICAgICAgICAgICAgICAgICAgIHZhciBjb25maWcgPSBpbnZva2VMYXRlcignJGluamVjdG9yJywgJ2ludm9rZScpOwoKICAgICAgICAgICAgICAgICAgICAvKiogQHR5cGUge2FuZ3VsYXIuTW9kdWxlfSAqLwogICAgICAgICAgICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHJpdmF0ZSBzdGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBfaW52b2tlUXVldWU6IGludm9rZVF1ZXVlLAogICAgICAgICAgICAgICAgICAgICAgICBfcnVuQmxvY2tzOiBydW5CbG9ja3MsCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3JlcXVpcmVzCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn0gTGlzdCBvZiBtb2R1bGUgbmFtZXMgd2hpY2ggbXVzdCBiZSBsb2FkZWQgYmVmb3JlIHRoaXMgbW9kdWxlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogSG9sZHMgdGhlIGxpc3Qgb2YgbW9kdWxlcyB3aGljaCB0aGUgaW5qZWN0b3Igd2lsbCBsb2FkIGJlZm9yZSB0aGUgY3VycmVudCBtb2R1bGUgaXMgbG9hZGVkLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZXM6IHJlcXVpcmVzLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eU9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE5hbWUgb2YgdGhlIG1vZHVsZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAoKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3Byb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJvdmlkZXJUeXBlIENvbnN0cnVjdGlvbiBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIHRoZSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogU2VlIHtAbGluayBBVVRPLiRwcm92aWRlI3Byb3ZpZGVyICRwcm92aWRlLnByb3ZpZGVyKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXI6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdwcm92aWRlcicpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmFjdG9yeQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByb3ZpZGVyRnVuY3Rpb24gRnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNmYWN0b3J5ICRwcm92aWRlLmZhY3RvcnkoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBmYWN0b3J5OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnZmFjdG9yeScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjc2VydmljZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY29uc3RydWN0b3IgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGluc3RhbnRpYXRlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNzZXJ2aWNlICRwcm92aWRlLnNlcnZpY2UoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnc2VydmljZScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyp9IG9iamVjdCBTZXJ2aWNlIGluc3RhbmNlIG9iamVjdC4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSN2YWx1ZSAkcHJvdmlkZS52YWx1ZSgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAndmFsdWUnKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnN0YW50CiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBjb25zdGFudCBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IENvbnN0YW50IHZhbHVlLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogQmVjYXVzZSB0aGUgY29uc3RhbnQgYXJlIGZpeGVkLCB0aGV5IGdldCBhcHBsaWVkIGJlZm9yZSBvdGhlciBwcm92aWRlIG1ldGhvZHMuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgQVVUTy4kcHJvdmlkZSNjb25zdGFudCAkcHJvdmlkZS5jb25zdGFudCgpfS4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0YW50OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnY29uc3RhbnQnLCAndW5zaGlmdCcpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjYW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBhbmltYXRpb24gbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBhbmltYXRpb25GYWN0b3J5IEZhY3RvcnkgZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiBhbiBhbmltYXRpb24uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAgICAgKiAqKk5PVEUqKjogYW5pbWF0aW9ucyBhcmUgdGFrZSBlZmZlY3Qgb25seSBpZiB0aGUgKipuZ0FuaW1hdGUqKiBtb2R1bGUgaXMgbG9hZGVkLgogICAgICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBEZWZpbmVzIGFuIGFuaW1hdGlvbiBob29rIHRoYXQgY2FuIGJlIGxhdGVyIHVzZWQgd2l0aCB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlICRhbmltYXRlfSBzZXJ2aWNlIGFuZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBkaXJlY3RpdmVzIHRoYXQgdXNlIHRoaXMgc2VydmljZS4KICAgICAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgICAgICogbW9kdWxlLmFuaW1hdGlvbignLmFuaW1hdGlvbi1uYW1lJywgZnVuY3Rpb24oJGluamVjdDEsICRpbmplY3QyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAqICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICogICAgIGV2ZW50TmFtZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICogICAgICAgLy9jb2RlIHRvIHJ1biB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqICAgICAgIC8vb25jZSBjb21wbGV0ZSwgdGhlbiBydW4gZG9uZSgpCiAgICAgICAgICAgICAgICAgICAgICAgICAqICAgICAgIHJldHVybiBmdW5jdGlvbiBjYW5jZWxsYXRpb25GdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgLy9jb2RlIHRvIGNhbmNlbCB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICogICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICogICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAqIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nQW5pbWF0ZS4kYW5pbWF0ZVByb3ZpZGVyI3JlZ2lzdGVyICRhbmltYXRlUHJvdmlkZXIucmVnaXN0ZXIoKX0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZ0FuaW1hdGUgbmdBbmltYXRlIG1vZHVsZX0gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246IGludm9rZUxhdGVyKCckYW5pbWF0ZVByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNmaWx0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEZpbHRlciBuYW1lLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmaWx0ZXJGYWN0b3J5IEZhY3RvcnkgZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiBmaWx0ZXIuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRmaWx0ZXJQcm92aWRlciNyZWdpc3RlciAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXI6IGludm9rZUxhdGVyKCckZmlsdGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnRyb2xsZXIKICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIENvbnRyb2xsZXIgbmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQ29udHJvbGxlciBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGNvbnRyb2xsZXJQcm92aWRlciNyZWdpc3RlciAkY29udHJvbGxlclByb3ZpZGVyLnJlZ2lzdGVyKCl9LgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjogaW52b2tlTGF0ZXIoJyRjb250cm9sbGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2RpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgYW5ndWxhci5Nb2R1bGUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgZGlyZWN0aXZlIG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZGlyZWN0aXZlRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YKICAgICAgICAgICAgICAgICAgICAgICAgICogZGlyZWN0aXZlcy4KICAgICAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgJGNvbXBpbGVQcm92aWRlci5kaXJlY3RpdmUoKX0uCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmU6IGludm9rZUxhdGVyKCckY29tcGlsZVByb3ZpZGVyJywgJ2RpcmVjdGl2ZScpLAoKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29uZmlnCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBhbmd1bGFyLk1vZHVsZQogICAgICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25maWdGbiBFeGVjdXRlIHRoaXMgZnVuY3Rpb24gb24gbW9kdWxlIGxvYWQuIFVzZWZ1bCBmb3Igc2VydmljZQogICAgICAgICAgICAgICAgICAgICAgICAgKiAgICBjb25maWd1cmF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogVXNlIHRoaXMgbWV0aG9kIHRvIHJlZ2lzdGVyIHdvcmsgd2hpY2ggbmVlZHMgdG8gYmUgcGVyZm9ybWVkIG9uIG1vZHVsZSBsb2FkaW5nLgogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnOiBjb25maWcsCgogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNydW4KICAgICAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIGFuZ3VsYXIuTW9kdWxlCiAgICAgICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGluaXRpYWxpemF0aW9uRm4gRXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIGFmdGVyIGluamVjdG9yIGNyZWF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiAgICBVc2VmdWwgZm9yIGFwcGxpY2F0aW9uIGluaXRpYWxpemF0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICogVXNlIHRoaXMgbWV0aG9kIHRvIHJlZ2lzdGVyIHdvcmsgd2hpY2ggc2hvdWxkIGJlIHBlcmZvcm1lZCB3aGVuIHRoZSBpbmplY3RvciBpcyBkb25lCiAgICAgICAgICAgICAgICAgICAgICAgICAqIGxvYWRpbmcgYWxsIG1vZHVsZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBydW46IGZ1bmN0aW9uIChibG9jaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2goYmxvY2spOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnKGNvbmZpZ0ZuKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBtb2R1bGVJbnN0YW5jZTsKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3ZpZGVyCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nPX0gaW5zZXJ0TWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICogQHJldHVybnMge2FuZ3VsYXIuTW9kdWxlfQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGludm9rZUxhdGVyKHByb3ZpZGVyLCBtZXRob2QsIGluc2VydE1ldGhvZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW52b2tlUXVldWVbaW5zZXJ0TWV0aG9kIHx8ICdwdXNoJ10oW3Byb3ZpZGVyLCBtZXRob2QsIGFyZ3VtZW50c10pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZUluc3RhbmNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSk7CgogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgKiBAbmFtZSBhbmd1bGFyLnZlcnNpb24KICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQW4gb2JqZWN0IHRoYXQgY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGN1cnJlbnQgQW5ndWxhckpTIHZlcnNpb24uIFRoaXMgb2JqZWN0IGhhcyB0aGUKICAgICAqIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICoKICAgICAqIC0gYGZ1bGxgIOKAkyBge3N0cmluZ31gIOKAkyBGdWxsIHZlcnNpb24gc3RyaW5nLCBzdWNoIGFzICIwLjkuMTgiLgogICAgICogLSBgbWFqb3JgIOKAkyBge251bWJlcn1gIOKAkyBNYWpvciB2ZXJzaW9uIG51bWJlciwgc3VjaCBhcyAiMCIuCiAgICAgKiAtIGBtaW5vcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1pbm9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICI5Ii4KICAgICAqIC0gYGRvdGAg4oCTIGB7bnVtYmVyfWAg4oCTIERvdCB2ZXJzaW9uIG51bWJlciwgc3VjaCBhcyAiMTgiLgogICAgICogLSBgY29kZU5hbWVgIOKAkyBge3N0cmluZ31gIOKAkyBDb2RlIG5hbWUgb2YgdGhlIHJlbGVhc2UsIHN1Y2ggYXMgImppZ2dsaW5nLWFybWZhdCIuCiAgICAgKi8KICAgIHZhciB2ZXJzaW9uID0gewogICAgICAgIGZ1bGw6ICcxLjIuMC1yYy4yJywgICAgLy8gYWxsIG9mIHRoZXNlIHBsYWNlaG9sZGVyIHN0cmluZ3Mgd2lsbCBiZSByZXBsYWNlZCBieSBncnVudCdzCiAgICAgICAgbWFqb3I6IDEsICAgIC8vIHBhY2thZ2UgdGFzawogICAgICAgIG1pbm9yOiAyLAogICAgICAgIGRvdDogMCwKICAgICAgICBjb2RlTmFtZTogJ2JhcmVoYW5kLWF0b21zcGxpdHRpbmcnCiAgICB9OwoKCiAgICBmdW5jdGlvbiBwdWJsaXNoRXh0ZXJuYWxBUEkoYW5ndWxhcikgewogICAgICAgIGV4dGVuZChhbmd1bGFyLCB7CiAgICAgICAgICAgICdib290c3RyYXAnOiBib290c3RyYXAsCiAgICAgICAgICAgICdjb3B5JzogY29weSwKICAgICAgICAgICAgJ2V4dGVuZCc6IGV4dGVuZCwKICAgICAgICAgICAgJ2VxdWFscyc6IGVxdWFscywKICAgICAgICAgICAgJ2VsZW1lbnQnOiBqcUxpdGUsCiAgICAgICAgICAgICdmb3JFYWNoJzogZm9yRWFjaCwKICAgICAgICAgICAgJ2luamVjdG9yJzogY3JlYXRlSW5qZWN0b3IsCiAgICAgICAgICAgICdub29wJzogbm9vcCwKICAgICAgICAgICAgJ2JpbmQnOiBiaW5kLAogICAgICAgICAgICAndG9Kc29uJzogdG9Kc29uLAogICAgICAgICAgICAnZnJvbUpzb24nOiBmcm9tSnNvbiwKICAgICAgICAgICAgJ2lkZW50aXR5JzogaWRlbnRpdHksCiAgICAgICAgICAgICdpc1VuZGVmaW5lZCc6IGlzVW5kZWZpbmVkLAogICAgICAgICAgICAnaXNEZWZpbmVkJzogaXNEZWZpbmVkLAogICAgICAgICAgICAnaXNTdHJpbmcnOiBpc1N0cmluZywKICAgICAgICAgICAgJ2lzRnVuY3Rpb24nOiBpc0Z1bmN0aW9uLAogICAgICAgICAgICAnaXNPYmplY3QnOiBpc09iamVjdCwKICAgICAgICAgICAgJ2lzTnVtYmVyJzogaXNOdW1iZXIsCiAgICAgICAgICAgICdpc0VsZW1lbnQnOiBpc0VsZW1lbnQsCiAgICAgICAgICAgICdpc0FycmF5JzogaXNBcnJheSwKICAgICAgICAgICAgJyQkbWluRXJyJzogbWluRXJyLAogICAgICAgICAgICAndmVyc2lvbic6IHZlcnNpb24sCiAgICAgICAgICAgICdpc0RhdGUnOiBpc0RhdGUsCiAgICAgICAgICAgICdsb3dlcmNhc2UnOiBsb3dlcmNhc2UsCiAgICAgICAgICAgICd1cHBlcmNhc2UnOiB1cHBlcmNhc2UsCiAgICAgICAgICAgICdjYWxsYmFja3MnOiB7IGNvdW50ZXI6IDAgfQogICAgICAgIH0pOwoKICAgICAgICBhbmd1bGFyTW9kdWxlID0gc2V0dXBNb2R1bGVMb2FkZXIod2luZG93KTsKICAgICAgICB0cnkgewogICAgICAgICAgICBhbmd1bGFyTW9kdWxlKCduZ0xvY2FsZScpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgYW5ndWxhck1vZHVsZSgnbmdMb2NhbGUnLCBbXSkucHJvdmlkZXIoJyRsb2NhbGUnLCAkTG9jYWxlUHJvdmlkZXIpOwogICAgICAgIH0KCiAgICAgICAgYW5ndWxhck1vZHVsZSgnbmcnLCBbJ25nTG9jYWxlJ10sIFsnJHByb3ZpZGUnLAogICAgICAgICAgZnVuY3Rpb24gbmdNb2R1bGUoJHByb3ZpZGUpIHsKICAgICAgICAgICAgICAkcHJvdmlkZS5wcm92aWRlcignJGNvbXBpbGUnLCAkQ29tcGlsZVByb3ZpZGVyKS4KICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSh7CiAgICAgICAgICAgICAgICAgICAgYTogaHRtbEFuY2hvckRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBpbnB1dDogaW5wdXREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgdGV4dGFyZWE6IGlucHV0RGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIGZvcm06IGZvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgc2NyaXB0OiBzY3JpcHREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0OiBzZWxlY3REaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHN0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbjogb3B0aW9uRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nQmluZDogbmdCaW5kRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nQmluZEh0bWw6IG5nQmluZEh0bWxEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdCaW5kVGVtcGxhdGU6IG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nQ2xhc3M6IG5nQ2xhc3NEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdDbGFzc0V2ZW46IG5nQ2xhc3NFdmVuRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nQ2xhc3NPZGQ6IG5nQ2xhc3NPZGREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdDc3A6IG5nQ3NwRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nQ2xvYWs6IG5nQ2xvYWtEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdDb250cm9sbGVyOiBuZ0NvbnRyb2xsZXJEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdGb3JtOiBuZ0Zvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdIaWRlOiBuZ0hpZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdJZjogbmdJZkRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ0luY2x1ZGU6IG5nSW5jbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ0luaXQ6IG5nSW5pdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ05vbkJpbmRhYmxlOiBuZ05vbkJpbmRhYmxlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nUGx1cmFsaXplOiBuZ1BsdXJhbGl6ZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ1JlcGVhdDogbmdSZXBlYXREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdTaG93OiBuZ1Nob3dEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdTdHlsZTogbmdTdHlsZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ1N3aXRjaDogbmdTd2l0Y2hEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdTd2l0Y2hXaGVuOiBuZ1N3aXRjaFdoZW5EaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdTd2l0Y2hEZWZhdWx0OiBuZ1N3aXRjaERlZmF1bHREaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdPcHRpb25zOiBuZ09wdGlvbnNEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdUcmFuc2NsdWRlOiBuZ1RyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbDogbmdNb2RlbERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ0xpc3Q6IG5nTGlzdERpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICBuZ0NoYW5nZTogbmdDaGFuZ2VEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nUmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgIG5nVmFsdWU6IG5nVmFsdWVEaXJlY3RpdmUKICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgZGlyZWN0aXZlKG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzKS4KICAgICAgICAgICAgICAgIGRpcmVjdGl2ZShuZ0V2ZW50RGlyZWN0aXZlcyk7CiAgICAgICAgICAgICAgJHByb3ZpZGUucHJvdmlkZXIoewogICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsOiAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICRhbmltYXRlOiAkQW5pbWF0ZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAkYnJvd3NlcjogJEJyb3dzZXJQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJGNhY2hlRmFjdG9yeTogJENhY2hlRmFjdG9yeVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAkY29udHJvbGxlcjogJENvbnRyb2xsZXJQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJGRvY3VtZW50OiAkRG9jdW1lbnRQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXI6ICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICRmaWx0ZXI6ICRGaWx0ZXJQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJGludGVycG9sYXRlOiAkSW50ZXJwb2xhdGVQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJGh0dHA6ICRIdHRwUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICRodHRwQmFja2VuZDogJEh0dHBCYWNrZW5kUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICRsb2NhdGlvbjogJExvY2F0aW9uUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICRsb2c6ICRMb2dQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJHBhcnNlOiAkUGFyc2VQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZTogJFJvb3RTY29wZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAkcTogJFFQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJHNjZTogJFNjZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAkc2NlRGVsZWdhdGU6ICRTY2VEZWxlZ2F0ZVByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAkc25pZmZlcjogJFNuaWZmZXJQcm92aWRlciwKICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlQ2FjaGU6ICRUZW1wbGF0ZUNhY2hlUHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICR0aW1lb3V0OiAkVGltZW91dFByb3ZpZGVyLAogICAgICAgICAgICAgICAgICAkd2luZG93OiAkV2luZG93UHJvdmlkZXIsCiAgICAgICAgICAgICAgICAgICQkdXJsVXRpbHM6ICQkVXJsVXRpbHNQcm92aWRlcgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIF0pOwogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vSlFMaXRlCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIGFuZ3VsYXIuZWxlbWVudAogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBXcmFwcyBhIHJhdyBET00gZWxlbWVudCBvciBIVE1MIHN0cmluZyBhcyBhIFtqUXVlcnldKGh0dHA6Ly9qcXVlcnkuY29tKSBlbGVtZW50LgogICAgICogYGFuZ3VsYXIuZWxlbWVudGAgY2FuIGJlIGVpdGhlciBhbiBhbGlhcyBmb3IgW2pRdWVyeV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS8pIGZ1bmN0aW9uLCBpZgogICAgICogalF1ZXJ5IGlzIGF2YWlsYWJsZSwgb3IgYSBmdW5jdGlvbiB0aGF0IHdyYXBzIHRoZSBlbGVtZW50IG9yIHN0cmluZyBpbiBBbmd1bGFyJ3MgalF1ZXJ5IGxpdGUKICAgICAqIGltcGxlbWVudGF0aW9uIChjb21tb25seSByZWZlcnJlZCB0byBhcyBqcUxpdGUpLgogICAgICoKICAgICAqIFJlYWwgalF1ZXJ5IGFsd2F5cyB0YWtlcyBwcmVjZWRlbmNlIG92ZXIganFMaXRlLCBwcm92aWRlZCBpdCB3YXMgbG9hZGVkIGJlZm9yZSBgRE9NQ29udGVudExvYWRlZGAKICAgICAqIGV2ZW50IGZpcmVkLgogICAgICoKICAgICAqIGpxTGl0ZSBpcyBhIHRpbnksIEFQSS1jb21wYXRpYmxlIHN1YnNldCBvZiBqUXVlcnkgdGhhdCBhbGxvd3MKICAgICAqIEFuZ3VsYXIgdG8gbWFuaXB1bGF0ZSB0aGUgRE9NLiBqcUxpdGUgaW1wbGVtZW50cyBvbmx5IHRoZSBtb3N0IGNvbW1vbmx5IG5lZWRlZCBmdW5jdGlvbmFsaXR5CiAgICAgKiB3aXRoaW4gYSB2ZXJ5IHNtYWxsIGZvb3RwcmludCwgc28gb25seSBhIHN1YnNldCBvZiB0aGUgalF1ZXJ5IEFQSSAtIG1ldGhvZHMsIGFyZ3VtZW50cyBhbmQKICAgICAqIGludm9jYXRpb24gc3R5bGVzIC0gYXJlIHN1cHBvcnRlZC4KICAgICAqCiAgICAgKiBOb3RlOiBBbGwgZWxlbWVudCByZWZlcmVuY2VzIGluIEFuZ3VsYXIgYXJlIGFsd2F5cyB3cmFwcGVkIHdpdGggalF1ZXJ5IG9yIGpxTGl0ZTsgdGhleSBhcmUgbmV2ZXIKICAgICAqIHJhdyBET00gcmVmZXJlbmNlcy4KICAgICAqCiAgICAgKiAjIyBBbmd1bGFyJ3MganFMaXRlCiAgICAgKiBBbmd1bGFyJ3MgbGl0ZSB2ZXJzaW9uIG9mIGpRdWVyeSBwcm92aWRlcyBvbmx5IHRoZSBmb2xsb3dpbmcgalF1ZXJ5IG1ldGhvZHM6CiAgICAgKgogICAgICogLSBbYWRkQ2xhc3MoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FkZENsYXNzLykKICAgICAqIC0gW2FmdGVyKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hZnRlci8pCiAgICAgKiAtIFthcHBlbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FwcGVuZC8pCiAgICAgKiAtIFthdHRyKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hdHRyLykKICAgICAqIC0gW2JpbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29uLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMsIHNlbGVjdG9ycyBvciBldmVudERhdGEKICAgICAqIC0gW2NoaWxkcmVuKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jaGlsZHJlbi8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICAgICAqIC0gW2Nsb25lKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jbG9uZS8pCiAgICAgKiAtIFtjb250ZW50cygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY29udGVudHMvKQogICAgICogLSBbY3NzKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jc3MvKQogICAgICogLSBbZGF0YSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZGF0YS8pCiAgICAgKiAtIFtlcSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZXEvKQogICAgICogLSBbZmluZCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZmluZC8pIC0gTGltaXRlZCB0byBsb29rdXBzIGJ5IHRhZyBuYW1lCiAgICAgKiAtIFtoYXNDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaGFzQ2xhc3MvKQogICAgICogLSBbaHRtbCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaHRtbC8pCiAgICAgKiAtIFtuZXh0KCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9uZXh0LykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogICAgICogLSBbb24oKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29uLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMsIHNlbGVjdG9ycyBvciBldmVudERhdGEKICAgICAqIC0gW29mZigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vb2ZmLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMgb3Igc2VsZWN0b3JzCiAgICAgKiAtIFtwYXJlbnQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3BhcmVudC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICAgICAqIC0gW3ByZXBlbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ByZXBlbmQvKQogICAgICogLSBbcHJvcCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcHJvcC8pCiAgICAgKiAtIFtyZWFkeSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVhZHkvKQogICAgICogLSBbcmVtb3ZlKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmUvKQogICAgICogLSBbcmVtb3ZlQXR0cigpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQXR0ci8pCiAgICAgKiAtIFtyZW1vdmVDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQ2xhc3MvKQogICAgICogLSBbcmVtb3ZlRGF0YSgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlRGF0YS8pCiAgICAgKiAtIFtyZXBsYWNlV2l0aCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVwbGFjZVdpdGgvKQogICAgICogLSBbdGV4dCgpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdGV4dC8pCiAgICAgKiAtIFt0b2dnbGVDbGFzcygpXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdG9nZ2xlQ2xhc3MvKQogICAgICogLSBbdHJpZ2dlckhhbmRsZXIoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RyaWdnZXJIYW5kbGVyLykgLSBQYXNzZXMgYSBkdW1teSBldmVudCBvYmplY3QgdG8gaGFuZGxlcnMuCiAgICAgKiAtIFt1bmJpbmQoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29mZi8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzCiAgICAgKiAtIFt2YWwoKV0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ZhbC8pCiAgICAgKiAtIFt3cmFwKCldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS93cmFwLykKICAgICAqCiAgICAgKiAjIyBqUXVlcnkvanFMaXRlIEV4dHJhcwogICAgICogQW5ndWxhciBhbHNvIHByb3ZpZGVzIHRoZSBmb2xsb3dpbmcgYWRkaXRpb25hbCBtZXRob2RzIGFuZCBldmVudHMgdG8gYm90aCBqUXVlcnkgYW5kIGpxTGl0ZToKICAgICAqCiAgICAgKiAjIyMgRXZlbnRzCiAgICAgKiAtIGAkZGVzdHJveWAgLSBBbmd1bGFySlMgaW50ZXJjZXB0cyBhbGwganFMaXRlL2pRdWVyeSdzIERPTSBkZXN0cnVjdGlvbiBhcGlzIGFuZCBmaXJlcyB0aGlzIGV2ZW50CiAgICAgKiAgICBvbiBhbGwgRE9NIG5vZGVzIGJlaW5nIHJlbW92ZWQuICBUaGlzIGNhbiBiZSB1c2VkIHRvIGNsZWFuIHVwIGFuZCAzcmQgcGFydHkgYmluZGluZ3MgdG8gdGhlIERPTQogICAgICogICAgZWxlbWVudCBiZWZvcmUgaXQgaXMgcmVtb3ZlZC4KICAgICAqICMjIyBNZXRob2RzCiAgICAgKiAtIGBjb250cm9sbGVyKG5hbWUpYCAtIHJldHJpZXZlcyB0aGUgY29udHJvbGxlciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuIEJ5IGRlZmF1bHQKICAgICAqICAgcmV0cmlldmVzIGNvbnRyb2xsZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUuIElmIGBuYW1lYCBpcyBwcm92aWRlZCBhcwogICAgICogICBjYW1lbENhc2UgZGlyZWN0aXZlIG5hbWUsIHRoZW4gdGhlIGNvbnRyb2xsZXIgZm9yIHRoaXMgZGlyZWN0aXZlIHdpbGwgYmUgcmV0cmlldmVkIChlLmcuCiAgICAgKiAgIGAnbmdNb2RlbCdgKS4KICAgICAqIC0gYGluamVjdG9yKClgIC0gcmV0cmlldmVzIHRoZSBpbmplY3RvciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBzY29wZSgpYCAtIHJldHJpZXZlcyB0aGUge0BsaW5rIGFwaS9uZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBvZiB0aGUgY3VycmVudAogICAgICogICBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICAgKiAtIGBpbmhlcml0ZWREYXRhKClgIC0gc2FtZSBhcyBgZGF0YSgpYCwgYnV0IHdhbGtzIHVwIHRoZSBET00gdW50aWwgYSB2YWx1ZSBpcyBmb3VuZCBvciB0aGUgdG9wCiAgICAgKiAgIHBhcmVudCBlbGVtZW50IGlzIHJlYWNoZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBIVE1MIHN0cmluZyBvciBET01FbGVtZW50IHRvIGJlIHdyYXBwZWQgaW50byBqUXVlcnkuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBqUXVlcnkgb2JqZWN0LgogICAgICovCgogICAgdmFyIGpxQ2FjaGUgPSBKUUxpdGUuY2FjaGUgPSB7fSwKICAgICAgICBqcU5hbWUgPSBKUUxpdGUuZXhwYW5kbyA9ICduZy0nICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAganFJZCA9IDEsCiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyCiAgICAgICAgICA/IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgeyBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsgfQogICAgICAgICAgOiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4pIHsgZWxlbWVudC5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOyB9KSwKICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4gPSAod2luZG93LmRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIKICAgICAgICAgID8gZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7IGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOyB9CiAgICAgICAgICA6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgeyBlbGVtZW50LmRldGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7IH0pOwoKICAgIGZ1bmN0aW9uIGpxTmV4dElkKCkgeyByZXR1cm4gKytqcUlkOyB9CgoKICAgIHZhciBTUEVDSUFMX0NIQVJTX1JFR0VYUCA9IC8oW1w6XC1cX10rKC4pKS9nOwogICAgdmFyIE1PWl9IQUNLX1JFR0VYUCA9IC9ebW96KFtBLVpdKS87CiAgICB2YXIganFMaXRlTWluRXJyID0gbWluRXJyKCdqcUxpdGUnKTsKCiAgICAvKioKICAgICAqIENvbnZlcnRzIHNuYWtlX2Nhc2UgdG8gY2FtZWxDYXNlLgogICAgICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICAgICAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNhbWVsQ2FzZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIG5hbWUuCiAgICAgICAgICByZXBsYWNlKFNQRUNJQUxfQ0hBUlNfUkVHRVhQLCBmdW5jdGlvbiAoXywgc2VwYXJhdG9yLCBsZXR0ZXIsIG9mZnNldCkgewogICAgICAgICAgICAgIHJldHVybiBvZmZzZXQgPyBsZXR0ZXIudG9VcHBlckNhc2UoKSA6IGxldHRlcjsKICAgICAgICAgIH0pLgogICAgICAgICAgcmVwbGFjZShNT1pfSEFDS19SRUdFWFAsICdNb3okMScpOwogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8galF1ZXJ5IG11dGF0aW9uIHBhdGNoCiAgICAvLwogICAgLy8gSW4gY29uanVuY3Rpb24gd2l0aCBiaW5kSlF1ZXJ5IGludGVyY2VwdHMgYWxsIGpRdWVyeSdzIERPTSBkZXN0cnVjdGlvbiBhcGlzIGFuZCBmaXJlcyBhCiAgICAvLyAkZGVzdHJveSBldmVudCBvbiBhbGwgRE9NIG5vZGVzIGJlaW5nIHJlbW92ZWQuCiAgICAvLwogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gSlFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUobmFtZSwgZGlzcGF0Y2hUaGlzLCBmaWx0ZXJFbGVtcywgZ2V0dGVySWZOb0FyZ3VtZW50cykgewogICAgICAgIHZhciBvcmlnaW5hbEpxRm4gPSBqUXVlcnkuZm5bbmFtZV07CiAgICAgICAgb3JpZ2luYWxKcUZuID0gb3JpZ2luYWxKcUZuLiRvcmlnaW5hbCB8fCBvcmlnaW5hbEpxRm47CiAgICAgICAgcmVtb3ZlUGF0Y2guJG9yaWdpbmFsID0gb3JpZ2luYWxKcUZuOwogICAgICAgIGpRdWVyeS5mbltuYW1lXSA9IHJlbW92ZVBhdGNoOwoKICAgICAgICBmdW5jdGlvbiByZW1vdmVQYXRjaChwYXJhbSkgewogICAgICAgICAgICB2YXIgbGlzdCA9IGZpbHRlckVsZW1zICYmIHBhcmFtID8gW3RoaXMuZmlsdGVyKHBhcmFtKV0gOiBbdGhpc10sCiAgICAgICAgICAgICAgICBmaXJlRXZlbnQgPSBkaXNwYXRjaFRoaXMsCiAgICAgICAgICAgICAgICBzZXQsIHNldEluZGV4LCBzZXRMZW5ndGgsCiAgICAgICAgICAgICAgICBlbGVtZW50LCBjaGlsZEluZGV4LCBjaGlsZExlbmd0aCwgY2hpbGRyZW47CgogICAgICAgICAgICBpZiAoIWdldHRlcklmTm9Bcmd1bWVudHMgfHwgcGFyYW0gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgd2hpbGUgKGxpc3QubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0ID0gbGlzdC5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIGZvciAoc2V0SW5kZXggPSAwLCBzZXRMZW5ndGggPSBzZXQubGVuZ3RoOyBzZXRJbmRleCA8IHNldExlbmd0aDsgc2V0SW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0ganFMaXRlKHNldFtzZXRJbmRleF0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlyZUV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnRyaWdnZXJIYW5kbGVyKCckZGVzdHJveScpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyZUV2ZW50ID0gIWZpcmVFdmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNoaWxkSW5kZXggPSAwLCBjaGlsZExlbmd0aCA9IChjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGRyZW4oKSkubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRJbmRleCA8IGNoaWxkTGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0LnB1c2goalF1ZXJ5KGNoaWxkcmVuW2NoaWxkSW5kZXhdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsSnFGbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIGZ1bmN0aW9uIEpRTGl0ZShlbGVtZW50KSB7CiAgICAgICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBKUUxpdGUpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBKUUxpdGUpKSB7CiAgICAgICAgICAgIGlmIChpc1N0cmluZyhlbGVtZW50KSAmJiBlbGVtZW50LmNoYXJBdCgwKSAhPSAnPCcpIHsKICAgICAgICAgICAgICAgIHRocm93IGpxTGl0ZU1pbkVycignbm9zZWwnLCAnTG9va2luZyB1cCBlbGVtZW50cyB2aWEgc2VsZWN0b3JzIGlzIG5vdCBzdXBwb3J0ZWQgYnkganFMaXRlISBTZWU6IGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL2FuZ3VsYXIuZWxlbWVudCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgSlFMaXRlKGVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpKSB7CiAgICAgICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgLy8gUmVhZCBhYm91dCB0aGUgTm9TY29wZSBlbGVtZW50cyBoZXJlOgogICAgICAgICAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzM4OTcoVlMuODUpLmFzcHgKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICc8ZGl2PiYjMTYwOzwvZGl2PicgKyBlbGVtZW50OyAvLyBJRSBpbnNhbml0eSB0byBtYWtlIE5vU2NvcGUgZWxlbWVudHMgd29yayEKICAgICAgICAgICAgZGl2LnJlbW92ZUNoaWxkKGRpdi5maXJzdENoaWxkKTsgLy8gcmVtb3ZlIHRoZSBzdXBlcmZsdW91cyBkaXYKICAgICAgICAgICAgSlFMaXRlQWRkTm9kZXModGhpcywgZGl2LmNoaWxkTm9kZXMpOwogICAgICAgICAgICB2YXIgZnJhZ21lbnQgPSBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpKTsKICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kKHRoaXMpOyAvLyBkZXRhY2ggdGhlIGVsZW1lbnRzIGZyb20gdGhlIHRlbXBvcmFyeSBET00gZGl2LgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIEpRTGl0ZUFkZE5vZGVzKHRoaXMsIGVsZW1lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVDbG9uZShlbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnQuY2xvbmVOb2RlKHRydWUpOwogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZURlYWxvYyhlbGVtZW50KSB7CiAgICAgICAgSlFMaXRlUmVtb3ZlRGF0YShlbGVtZW50KTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkTm9kZXMgfHwgW107IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBKUUxpdGVEZWFsb2MoY2hpbGRyZW5baV0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVPZmYoZWxlbWVudCwgdHlwZSwgZm4sIHVuc3VwcG9ydGVkKSB7CiAgICAgICAgaWYgKGlzRGVmaW5lZCh1bnN1cHBvcnRlZCkpIHRocm93IGpxTGl0ZU1pbkVycignb2ZmYXJncycsICdqcUxpdGUjb2ZmKCkgZG9lcyBub3Qgc3VwcG9ydCB0aGUgYHNlbGVjdG9yYCBhcmd1bWVudCcpOwoKICAgICAgICB2YXIgZXZlbnRzID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSwKICAgICAgICAgICAgaGFuZGxlID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgICAgICAgaWYgKCFoYW5kbGUpIHJldHVybjsgLy9ubyBsaXN0ZW5lcnMgcmVnaXN0ZXJlZAoKICAgICAgICBpZiAoaXNVbmRlZmluZWQodHlwZSkpIHsKICAgICAgICAgICAgZm9yRWFjaChldmVudHMsIGZ1bmN0aW9uIChldmVudEhhbmRsZXIsIHR5cGUpIHsKICAgICAgICAgICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBldmVudEhhbmRsZXIpOwogICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50c1t0eXBlXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yRWFjaCh0eXBlLnNwbGl0KCcgJyksIGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoZm4pKSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGV2ZW50c1t0eXBlXSk7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50c1t0eXBlXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUoZXZlbnRzW3R5cGVdIHx8IFtdLCBmbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQsIG5hbWUpIHsKICAgICAgICB2YXIgZXhwYW5kb0lkID0gZWxlbWVudFtqcU5hbWVdLAogICAgICAgICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF07CgogICAgICAgIGlmIChleHBhbmRvU3RvcmUpIHsKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBqcUNhY2hlW2V4cGFuZG9JZF0uZGF0YVtuYW1lXTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGV4cGFuZG9TdG9yZS5oYW5kbGUpIHsKICAgICAgICAgICAgICAgIGV4cGFuZG9TdG9yZS5ldmVudHMuJGRlc3Ryb3kgJiYgZXhwYW5kb1N0b3JlLmhhbmRsZSh7fSwgJyRkZXN0cm95Jyk7CiAgICAgICAgICAgICAgICBKUUxpdGVPZmYoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIGpxQ2FjaGVbZXhwYW5kb0lkXTsKICAgICAgICAgICAgZWxlbWVudFtqcU5hbWVdID0gdW5kZWZpbmVkOyAvLyBpZSBkb2VzIG5vdCBhbGxvdyBkZWxldGlvbiBvZiBhdHRyaWJ1dGVzIG9uIGVsZW1lbnRzLgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBleHBhbmRvSWQgPSBlbGVtZW50W2pxTmFtZV0sCiAgICAgICAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkIHx8IC0xXTsKCiAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgaWYgKCFleHBhbmRvU3RvcmUpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRbanFOYW1lXSA9IGV4cGFuZG9JZCA9IGpxTmV4dElkKCk7CiAgICAgICAgICAgICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF0gPSB7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHBhbmRvU3RvcmVba2V5XSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBleHBhbmRvU3RvcmUgJiYgZXhwYW5kb1N0b3JlW2tleV07CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZURhdGEoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBkYXRhID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdkYXRhJyksCiAgICAgICAgICAgIGlzU2V0dGVyID0gaXNEZWZpbmVkKHZhbHVlKSwKICAgICAgICAgICAga2V5RGVmaW5lZCA9ICFpc1NldHRlciAmJiBpc0RlZmluZWQoa2V5KSwKICAgICAgICAgICAgaXNTaW1wbGVHZXR0ZXIgPSBrZXlEZWZpbmVkICYmICFpc09iamVjdChrZXkpOwoKICAgICAgICBpZiAoIWRhdGEgJiYgIWlzU2ltcGxlR2V0dGVyKSB7CiAgICAgICAgICAgIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZGF0YScsIGRhdGEgPSB7fSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNTZXR0ZXIpIHsKICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGtleURlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmIChpc1NpbXBsZUdldHRlcikgewogICAgICAgICAgICAgICAgICAgIC8vIGRvbid0IGNyZWF0ZSBkYXRhIGluIHRoaXMgY2FzZS4KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YSAmJiBkYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGV4dGVuZChkYXRhLCBrZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgICByZXR1cm4gKCgiICIgKyBlbGVtZW50LmNsYXNzTmFtZSArICIgIikucmVwbGFjZSgvW1xuXHRdL2csICIgIikuCiAgICAgICAgICAgIGluZGV4T2YoIiAiICsgc2VsZWN0b3IgKyAiICIpID4gLTEpOwogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZVJlbW92ZUNsYXNzKGVsZW1lbnQsIGNzc0NsYXNzZXMpIHsKICAgICAgICBpZiAoY3NzQ2xhc3NlcykgewogICAgICAgICAgICBmb3JFYWNoKGNzc0NsYXNzZXMuc3BsaXQoJyAnKSwgZnVuY3Rpb24gKGNzc0NsYXNzKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IHRyaW0oCiAgICAgICAgICAgICAgICAgICAgKCIgIiArIGVsZW1lbnQuY2xhc3NOYW1lICsgIiAiKQogICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKQogICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKCIgIiArIHRyaW0oY3NzQ2xhc3MpICsgIiAiLCAiICIpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlQWRkQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3NlcykgewogICAgICAgIGlmIChjc3NDbGFzc2VzKSB7CiAgICAgICAgICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbiAoY3NzQ2xhc3MpIHsKICAgICAgICAgICAgICAgIGlmICghSlFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3MpKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSB0cmltKGVsZW1lbnQuY2xhc3NOYW1lICsgJyAnICsgdHJpbShjc3NDbGFzcykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gSlFMaXRlQWRkTm9kZXMocm9vdCwgZWxlbWVudHMpIHsKICAgICAgICBpZiAoZWxlbWVudHMpIHsKICAgICAgICAgICAgZWxlbWVudHMgPSAoIWVsZW1lbnRzLm5vZGVOYW1lICYmIGlzRGVmaW5lZChlbGVtZW50cy5sZW5ndGgpICYmICFpc1dpbmRvdyhlbGVtZW50cykpCiAgICAgICAgICAgICAgPyBlbGVtZW50cwogICAgICAgICAgICAgIDogW2VsZW1lbnRzXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgcm9vdC5wdXNoKGVsZW1lbnRzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBKUUxpdGVDb250cm9sbGVyKGVsZW1lbnQsIG5hbWUpIHsKICAgICAgICByZXR1cm4gSlFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCAnJCcgKyAobmFtZSB8fCAnbmdDb250cm9sbGVyJykgKyAnQ29udHJvbGxlcicpOwogICAgfQoKICAgIGZ1bmN0aW9uIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwoKICAgICAgICAvLyBpZiBlbGVtZW50IGlzIHRoZSBkb2N1bWVudCBvYmplY3Qgd29yayB3aXRoIHRoZSBodG1sIGVsZW1lbnQgaW5zdGVhZAogICAgICAgIC8vIHRoaXMgbWFrZXMgJChkb2N1bWVudCkuc2NvcGUoKSBwb3NzaWJsZQogICAgICAgIGlmIChlbGVtZW50WzBdLm5vZGVUeXBlID09IDkpIHsKICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQuZmluZCgnaHRtbCcpOwogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKGVsZW1lbnQubGVuZ3RoKSB7CiAgICAgICAgICAgIGlmICgodmFsdWUgPSBlbGVtZW50LmRhdGEobmFtZSkpICE9PSB1bmRlZmluZWQpIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50KCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8gRnVuY3Rpb25zIHdoaWNoIGFyZSBkZWNsYXJlZCBkaXJlY3RseS4KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgdmFyIEpRTGl0ZVByb3RvdHlwZSA9IEpRTGl0ZS5wcm90b3R5cGUgPSB7CiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICB2YXIgZmlyZWQgPSBmYWxzZTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIHRyaWdnZXIoKSB7CiAgICAgICAgICAgICAgICBpZiAoZmlyZWQpIHJldHVybjsKICAgICAgICAgICAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNoZWNrIGlmIGRvY3VtZW50IGFscmVhZHkgaXMgbG9hZGVkCiAgICAgICAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHRyaWdnZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5vbignRE9NQ29udGVudExvYWRlZCcsIHRyaWdnZXIpOyAvLyB3b3JrcyBmb3IgbW9kZXJuIGJyb3dzZXJzIGFuZCBJRTkKICAgICAgICAgICAgICAgIC8vIHdlIGNhbiBub3QgdXNlIGpxTGl0ZSBzaW5jZSB3ZSBhcmUgbm90IGRvbmUgbG9hZGluZyBhbmQgalF1ZXJ5IGNvdWxkIGJlIGxvYWRlZCBsYXRlci4KICAgICAgICAgICAgICAgIEpRTGl0ZSh3aW5kb3cpLm9uKCdsb2FkJywgdHJpZ2dlcik7IC8vIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQgZm9yIG90aGVycwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBbXTsKICAgICAgICAgICAgZm9yRWFjaCh0aGlzLCBmdW5jdGlvbiAoZSkgeyB2YWx1ZS5wdXNoKCcnICsgZSk7IH0pOwogICAgICAgICAgICByZXR1cm4gJ1snICsgdmFsdWUuam9pbignLCAnKSArICddJzsKICAgICAgICB9LAoKICAgICAgICBlcTogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgICAgIHJldHVybiAoaW5kZXggPj0gMCkgPyBqcUxpdGUodGhpc1tpbmRleF0pIDoganFMaXRlKHRoaXNbdGhpcy5sZW5ndGggKyBpbmRleF0pOwogICAgICAgIH0sCgogICAgICAgIGxlbmd0aDogMCwKICAgICAgICBwdXNoOiBwdXNoLAogICAgICAgIHNvcnQ6IFtdLnNvcnQsCiAgICAgICAgc3BsaWNlOiBbXS5zcGxpY2UKICAgIH07CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBGdW5jdGlvbnMgaXRlcmF0aW5nIGdldHRlci9zZXR0ZXJzLgogICAgLy8gdGhlc2UgZnVuY3Rpb25zIHJldHVybiBzZWxmIG9uIHNldHRlciBhbmQKICAgIC8vIHZhbHVlIG9uIGdldC4KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgdmFyIEJPT0xFQU5fQVRUUiA9IHt9OwogICAgZm9yRWFjaCgnbXVsdGlwbGUsc2VsZWN0ZWQsY2hlY2tlZCxkaXNhYmxlZCxyZWFkT25seSxyZXF1aXJlZCxvcGVuJy5zcGxpdCgnLCcpLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBCT09MRUFOX0FUVFJbbG93ZXJjYXNlKHZhbHVlKV0gPSB2YWx1ZTsKICAgIH0pOwogICAgdmFyIEJPT0xFQU5fRUxFTUVOVFMgPSB7fTsKICAgIGZvckVhY2goJ2lucHV0LHNlbGVjdCxvcHRpb24sdGV4dGFyZWEsYnV0dG9uLGZvcm0sZGV0YWlscycuc3BsaXQoJywnKSwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgQk9PTEVBTl9FTEVNRU5UU1t1cHBlcmNhc2UodmFsdWUpXSA9IHRydWU7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBnZXRCb29sZWFuQXR0ck5hbWUoZWxlbWVudCwgbmFtZSkgewogICAgICAgIC8vIGNoZWNrIGRvbSBsYXN0IHNpbmNlIHdlIHdpbGwgbW9zdCBsaWtlbHkgZmFpbCBvbiBuYW1lCiAgICAgICAgdmFyIGJvb2xlYW5BdHRyID0gQk9PTEVBTl9BVFRSW25hbWUudG9Mb3dlckNhc2UoKV07CgogICAgICAgIC8vIGJvb2xlYW5BdHRyIGlzIGhlcmUgdHdpY2UgdG8gbWluaW1pemUgRE9NIGFjY2VzcwogICAgICAgIHJldHVybiBib29sZWFuQXR0ciAmJiBCT09MRUFOX0VMRU1FTlRTW2VsZW1lbnQubm9kZU5hbWVdICYmIGJvb2xlYW5BdHRyOwogICAgfQoKICAgIGZvckVhY2goewogICAgICAgIGRhdGE6IEpRTGl0ZURhdGEsCiAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlSW5oZXJpdGVkRGF0YSwKCiAgICAgICAgc2NvcGU6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBKUUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckc2NvcGUnKTsKICAgICAgICB9LAoKICAgICAgICBjb250cm9sbGVyOiBKUUxpdGVDb250cm9sbGVyLAoKICAgICAgICBpbmplY3RvcjogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIEpRTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgJyRpbmplY3RvcicpOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uIChlbGVtZW50LCBuYW1lKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgICAgIH0sCgogICAgICAgIGhhc0NsYXNzOiBKUUxpdGVIYXNDbGFzcywKCiAgICAgICAgY3NzOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgbmFtZSA9IGNhbWVsQ2FzZShuYW1lKTsKCiAgICAgICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsOwoKICAgICAgICAgICAgICAgIGlmIChtc2llIDw9IDgpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIHNvbWUgSUUgc3BlY2lmaWMgd2VpcmRuZXNzIHRoYXQgalF1ZXJ5IDEuNi40IGRvZXMgbm90IHN1cmUgd2h5CiAgICAgICAgICAgICAgICAgICAgdmFsID0gZWxlbWVudC5jdXJyZW50U3R5bGUgJiYgZWxlbWVudC5jdXJyZW50U3R5bGVbbmFtZV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gJycpIHZhbCA9ICdhdXRvJzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YWwgPSB2YWwgfHwgZWxlbWVudC5zdHlsZVtuYW1lXTsKCiAgICAgICAgICAgICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgICAgICAgICAgICAgLy8ganF1ZXJ5IHdlaXJkbmVzcyA6LS8KICAgICAgICAgICAgICAgICAgICB2YWwgPSAodmFsID09PSAnJykgPyB1bmRlZmluZWQgOiB2YWw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGF0dHI6IGZ1bmN0aW9uIChlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgbG93ZXJjYXNlZE5hbWUgPSBsb3dlcmNhc2UobmFtZSk7CiAgICAgICAgICAgIGlmIChCT09MRUFOX0FUVFJbbG93ZXJjYXNlZE5hbWVdKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIGlmICghIXZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCBsb3dlcmNhc2VkTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFtuYW1lXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShsb3dlcmNhc2VkTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGVsZW1lbnRbbmFtZV0gfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZWxlbWVudC5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbShuYW1lKSB8fCBub29wKS5zcGVjaWZpZWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgID8gbG93ZXJjYXNlZE5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKSB7CiAgICAgICAgICAgICAgICAvLyB0aGUgZXh0cmEgYXJndW1lbnQgIjIiIGlzIHRvIGdldCB0aGUgcmlnaHQgdGhpbmcgZm9yIGEuaHJlZiBpbiBJRSwgc2VlIGpRdWVyeSBjb2RlCiAgICAgICAgICAgICAgICAvLyBzb21lIGVsZW1lbnRzIChlLmcuIERvY3VtZW50KSBkb24ndCBoYXZlIGdldCBhdHRyaWJ1dGUsIHNvIHJldHVybiB1bmRlZmluZWQKICAgICAgICAgICAgICAgIHZhciByZXQgPSBlbGVtZW50LmdldEF0dHJpYnV0ZShuYW1lLCAyKTsKICAgICAgICAgICAgICAgIC8vIG5vcm1hbGl6ZSBub24tZXhpc3RpbmcgYXR0cmlidXRlcyB0byB1bmRlZmluZWQgKGFzIGpRdWVyeSkKICAgICAgICAgICAgICAgIHJldHVybiByZXQgPT09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBwcm9wOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50W25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgdGV4dDogKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIE5PREVfVFlQRV9URVhUX1BST1BFUlRZID0gW107CiAgICAgICAgICAgIGlmIChtc2llIDwgOSkgewogICAgICAgICAgICAgICAgTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFlbMV0gPSAnaW5uZXJUZXh0JzsgICAgLyoqIEVsZW1lbnQgKiovCiAgICAgICAgICAgICAgICBOT0RFX1RZUEVfVEVYVF9QUk9QRVJUWVszXSA9ICdub2RlVmFsdWUnOyAgICAvKiogVGV4dCAqKi8KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIE5PREVfVFlQRV9URVhUX1BST1BFUlRZWzFdID0gICAgICAgICAgICAgICAgIC8qKiBFbGVtZW50ICoqLwogICAgICAgICAgICAgICAgTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFlbM10gPSAndGV4dENvbnRlbnQnOyAgLyoqIFRleHQgKiovCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ2V0VGV4dC4kZHYgPSAnJzsKICAgICAgICAgICAgcmV0dXJuIGdldFRleHQ7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRUZXh0KGVsZW1lbnQsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGV4dFByb3AgPSBOT0RFX1RZUEVfVEVYVF9QUk9QRVJUWVtlbGVtZW50Lm5vZGVUeXBlXQogICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZXh0UHJvcCA/IGVsZW1lbnRbdGV4dFByb3BdIDogJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbGVtZW50W3RleHRQcm9wXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfSkoKSwKCiAgICAgICAgdmFsOiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKG5vZGVOYW1lXyhlbGVtZW50KSA9PT0gJ1NFTEVDVCcgJiYgZWxlbWVudC5tdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQub3B0aW9ucywgZnVuY3Rpb24gKG9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChvcHRpb24udmFsdWUgfHwgb3B0aW9uLnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5sZW5ndGggPT09IDAgPyBudWxsIDogcmVzdWx0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwogICAgICAgIH0sCgogICAgICAgIGh0bWw6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC5pbm5lckhUTUw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkTm9kZXMgPSBlbGVtZW50LmNoaWxkTm9kZXM7IGkgPCBjaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBKUUxpdGVEZWFsb2MoY2hpbGROb2Rlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSB2YWx1ZTsKICAgICAgICB9CiAgICB9LCBmdW5jdGlvbiAoZm4sIG5hbWUpIHsKICAgICAgICAvKioKICAgICAgICAgKiBQcm9wZXJ0aWVzOiB3cml0ZXMgcmV0dXJuIHNlbGVjdGlvbiwgcmVhZHMgcmV0dXJuIGZpcnN0IHZhbHVlCiAgICAgICAgICovCiAgICAgICAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uIChhcmcxLCBhcmcyKSB7CiAgICAgICAgICAgIHZhciBpLCBrZXk7CgogICAgICAgICAgICAvLyBKUUxpdGVIYXNDbGFzcyBoYXMgb25seSB0d28gYXJndW1lbnRzLCBidXQgaXMgYSBnZXR0ZXItb25seSBmbiwgc28gd2UgbmVlZCB0byBzcGVjaWFsLWNhc2UgaXQKICAgICAgICAgICAgLy8gaW4gYSB3YXkgdGhhdCBzdXJ2aXZlcyBtaW5pZmljYXRpb24uCiAgICAgICAgICAgIGlmICgoKGZuLmxlbmd0aCA9PSAyICYmIChmbiAhPT0gSlFMaXRlSGFzQ2xhc3MgJiYgZm4gIT09IEpRTGl0ZUNvbnRyb2xsZXIpKSA/IGFyZzEgOiBhcmcyKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QoYXJnMSkpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIGEgd3JpdGUsIGJ1dCB0aGUgb2JqZWN0IHByb3BlcnRpZXMgYXJlIHRoZSBrZXkvdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuID09PSBKUUxpdGVEYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkYXRhKCkgdGFrZXMgdGhlIHdob2xlIG9iamVjdCBpbiBqUXVlcnkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHRoaXNbaV0sIGFyZzEpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gYXJnMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHRoaXNbaV0sIGtleSwgYXJnMVtrZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm4gc2VsZiBmb3IgY2hhaW5pbmcKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIGEgcmVhZCwgc28gcmVhZCB0aGUgZmlyc3QgY2hpbGQuCiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZm4uJGR2OwogICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgaWYgd2UgaGF2ZSAkZHYgZG8gd2UgaXRlcmF0ZSBvdmVyIGFsbCwgb3RoZXJ3aXNlIGl0IGlzIGp1c3QgdGhlIGZpcnN0IGVsZW1lbnQuCiAgICAgICAgICAgICAgICAgICAgdmFyIGpqID0gdmFsdWUgPT0gdW5kZWZpbmVkID8gTWF0aC5taW4odGhpcy5sZW5ndGgsIDEpIDogdGhpcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBqajsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlVmFsdWUgPSBmbih0aGlzW2pdLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZSA/IHZhbHVlICsgbm9kZVZhbHVlIDogbm9kZVZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgc28gYXBwbHkgdG8gYWxsIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGZuKHRoaXNbaV0sIGFyZzEsIGFyZzIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9KTsKCiAgICBmdW5jdGlvbiBjcmVhdGVFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnRzKSB7CiAgICAgICAgdmFyIGV2ZW50SGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCwgdHlwZSkgewogICAgICAgICAgICBpZiAoIWV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOyAvL2llCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7IC8vaWUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghZXZlbnQudGFyZ2V0KSB7CiAgICAgICAgICAgICAgICBldmVudC50YXJnZXQgPSBldmVudC5zcmNFbGVtZW50IHx8IGRvY3VtZW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2ZW50ID0gZXZlbnQucHJldmVudERlZmF1bHQ7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBwcmV2ZW50LmNhbGwoZXZlbnQpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgfHwgZXZlbnQucmV0dXJuVmFsdWUgPT0gZmFsc2U7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb3JFYWNoKGV2ZW50c1t0eXBlIHx8IGV2ZW50LnR5cGVdLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIGZuLmNhbGwoZWxlbWVudCwgZXZlbnQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFJlbW92ZSBtb25rZXktcGF0Y2hlZCBtZXRob2RzIChJRSksCiAgICAgICAgICAgIC8vIGFzIHRoZXkgd291bGQgY2F1c2UgbWVtb3J5IGxlYWtzIGluIElFOC4KICAgICAgICAgICAgaWYgKG1zaWUgPD0gOCkgewogICAgICAgICAgICAgICAgLy8gSUU3LzggZG9lcyBub3QgYWxsb3cgdG8gZGVsZXRlIHByb3BlcnR5IG9uIG5hdGl2ZSBvYmplY3QKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gbnVsbDsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgICBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSXQgc2hvdWxkbid0IGFmZmVjdCBub3JtYWwgYnJvd3NlcnMgKG5hdGl2ZSBtZXRob2RzIGFyZSBkZWZpbmVkIG9uIHByb3RvdHlwZSkuCiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnQucHJldmVudERlZmF1bHQ7CiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnQuc3RvcFByb3BhZ2F0aW9uOwogICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZXZlbnRIYW5kbGVyLmVsZW0gPSBlbGVtZW50OwogICAgICAgIHJldHVybiBldmVudEhhbmRsZXI7CiAgICB9CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBGdW5jdGlvbnMgaXRlcmF0aW5nIHRyYXZlcnNhbC4KICAgIC8vIFRoZXNlIGZ1bmN0aW9ucyBjaGFpbiByZXN1bHRzIGludG8gYSBzaW5nbGUKICAgIC8vIHNlbGVjdG9yLgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICBmb3JFYWNoKHsKICAgICAgICByZW1vdmVEYXRhOiBKUUxpdGVSZW1vdmVEYXRhLAoKICAgICAgICBkZWFsb2M6IEpRTGl0ZURlYWxvYywKCiAgICAgICAgb246IGZ1bmN0aW9uIG9uRm4oZWxlbWVudCwgdHlwZSwgZm4sIHVuc3VwcG9ydGVkKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQodW5zdXBwb3J0ZWQpKSB0aHJvdyBqcUxpdGVNaW5FcnIoJ29uYXJncycsICdqcUxpdGUjb24oKSBkb2VzIG5vdCBzdXBwb3J0IHRoZSBgc2VsZWN0b3JgIG9yIGBldmVudERhdGFgIHBhcmFtZXRlcnMnKTsKCiAgICAgICAgICAgIHZhciBldmVudHMgPSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycpLAogICAgICAgICAgICAgICAgaGFuZGxlID0gSlFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgICAgICAgICAgIGlmICghZXZlbnRzKSBKUUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycsIGV2ZW50cyA9IHt9KTsKICAgICAgICAgICAgaWYgKCFoYW5kbGUpIEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnaGFuZGxlJywgaGFuZGxlID0gY3JlYXRlRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50cykpOwoKICAgICAgICAgICAgZm9yRWFjaCh0eXBlLnNwbGl0KCcgJyksIGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRGbnMgPSBldmVudHNbdHlwZV07CgogICAgICAgICAgICAgICAgaWYgKCFldmVudEZucykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09ICdtb3VzZWVudGVyJyB8fCB0eXBlID09ICdtb3VzZWxlYXZlJykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGFpbnMgPSBkb2N1bWVudC5ib2R5LmNvbnRhaW5zIHx8IGRvY3VtZW50LmJvZHkuY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1cCA9IGIgJiYgYi5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGJ1cCB8fCAhIShidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRvd24uY29udGFpbnMgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZG93bi5jb250YWlucyhidXApIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGJ1cCkgJiAxNgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgoYiA9IGIucGFyZW50Tm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYiA9PT0gYSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBldmVudHNbdHlwZV0gPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlZmVyIHRvIGpRdWVyeSdzIGltcGxlbWVudGF0aW9uIG9mIG1vdXNlZW50ZXIgJiBtb3VzZWxlYXZlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlYWQgYWJvdXQgbW91c2VlbnRlciBhbmQgbW91c2VsZWF2ZToKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaHR0cDovL3d3dy5xdWlya3Ntb2RlLm9yZy9qcy9ldmVudHNfbW91c2UuaHRtbCNsaW5rOAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRtYXAgPSB7IG1vdXNlbGVhdmU6ICJtb3VzZW91dCIsIG1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiIH07CgogICAgICAgICAgICAgICAgICAgICAgICBvbkZuKGVsZW1lbnQsIGV2ZW50bWFwW3R5cGVdLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLCByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbGF0ZWQgfHwgKHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhY29udGFpbnModGFyZ2V0LCByZWxhdGVkKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGUoZXZlbnQsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGhhbmRsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBldmVudEZucyA9IGV2ZW50c1t0eXBlXQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXZlbnRGbnMucHVzaChmbik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIG9mZjogSlFMaXRlT2ZmLAoKICAgICAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24gKGVsZW1lbnQsIHJlcGxhY2VOb2RlKSB7CiAgICAgICAgICAgIHZhciBpbmRleCwgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBKUUxpdGVEZWFsb2MoZWxlbWVudCk7CiAgICAgICAgICAgIGZvckVhY2gobmV3IEpRTGl0ZShyZXBsYWNlTm9kZSksIGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIGluZGV4Lm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZChub2RlLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4ID0gbm9kZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgY2hpbGRyZW46IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQuY2hpbGROb2RlcywgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKQogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfSwKCiAgICAgICAgY29udGVudHM6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmNoaWxkTm9kZXMgfHwgW107CiAgICAgICAgfSwKCiAgICAgICAgYXBwZW5kOiBmdW5jdGlvbiAoZWxlbWVudCwgbm9kZSkgewogICAgICAgICAgICBmb3JFYWNoKG5ldyBKUUxpdGUobm9kZSksIGZ1bmN0aW9uIChjaGlsZCkgewogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDEgfHwgZWxlbWVudC5ub2RlVHlwZSA9PT0gMTEpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgcHJlcGVuZDogZnVuY3Rpb24gKGVsZW1lbnQsIG5vZGUpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IGVsZW1lbnQuZmlyc3RDaGlsZDsKICAgICAgICAgICAgICAgIGZvckVhY2gobmV3IEpRTGl0ZShub2RlKSwgZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoY2hpbGQsIGluZGV4KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgd3JhcDogZnVuY3Rpb24gKGVsZW1lbnQsIHdyYXBOb2RlKSB7CiAgICAgICAgICAgIHdyYXBOb2RlID0ganFMaXRlKHdyYXBOb2RlKVswXTsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudCkgewogICAgICAgICAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZCh3cmFwTm9kZSwgZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd3JhcE5vZGUuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICBKUUxpdGVEZWFsb2MoZWxlbWVudCk7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIGlmIChwYXJlbnQpIHBhcmVudC5yZW1vdmVDaGlsZChlbGVtZW50KTsKICAgICAgICB9LAoKICAgICAgICBhZnRlcjogZnVuY3Rpb24gKGVsZW1lbnQsIG5ld0VsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0gZWxlbWVudCwgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICBmb3JFYWNoKG5ldyBKUUxpdGUobmV3RWxlbWVudCksIGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIGluZGV4Lm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgIGluZGV4ID0gbm9kZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgYWRkQ2xhc3M6IEpRTGl0ZUFkZENsYXNzLAogICAgICAgIHJlbW92ZUNsYXNzOiBKUUxpdGVSZW1vdmVDbGFzcywKCiAgICAgICAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvciwgY29uZGl0aW9uKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChjb25kaXRpb24pKSB7CiAgICAgICAgICAgICAgICBjb25kaXRpb24gPSAhSlFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIChjb25kaXRpb24gPyBKUUxpdGVBZGRDbGFzcyA6IEpRTGl0ZVJlbW92ZUNsYXNzKShlbGVtZW50LCBzZWxlY3Rvcik7CiAgICAgICAgfSwKCiAgICAgICAgcGFyZW50OiBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICByZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIG5leHQ6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIGlmIChlbGVtZW50Lm5leHRFbGVtZW50U2libGluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJRTggZG9lc24ndCBoYXZlIG5leHRFbGVtZW50U2libGluZwogICAgICAgICAgICB2YXIgZWxtID0gZWxlbWVudC5uZXh0U2libGluZzsKICAgICAgICAgICAgd2hpbGUgKGVsbSAhPSBudWxsICYmIGVsbS5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgICAgICAgZWxtID0gZWxtLm5leHRTaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlbG07CiAgICAgICAgfSwKCiAgICAgICAgZmluZDogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKTsKICAgICAgICB9LAoKICAgICAgICBjbG9uZTogSlFMaXRlQ2xvbmUsCgogICAgICAgIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnROYW1lLCBldmVudERhdGEpIHsKICAgICAgICAgICAgdmFyIGV2ZW50Rm5zID0gKEpRTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJykgfHwge30pW2V2ZW50TmFtZV07CiAgICAgICAgICAgIGV2ZW50RGF0YSA9IGV2ZW50RGF0YSB8fCB7CiAgICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogbm9vcCwKICAgICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogbm9vcAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9yRWFjaChldmVudEZucywgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICBmbi5jYWxsKGVsZW1lbnQsIGV2ZW50RGF0YSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0sIGZ1bmN0aW9uIChmbiwgbmFtZSkgewogICAgICAgIC8qKgogICAgICAgICAqIGNoYWluaW5nIGZ1bmN0aW9ucwogICAgICAgICAqLwogICAgICAgIEpRTGl0ZS5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbiAoYXJnMSwgYXJnMiwgYXJnMykgewogICAgICAgICAgICB2YXIgdmFsdWU7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZm4odGhpc1tpXSwgYXJnMSwgYXJnMiwgYXJnMyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW55IGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYSB2YWx1ZSBuZWVkcyB0byBiZSB3cmFwcGVkCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0ganFMaXRlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIEpRTGl0ZUFkZE5vZGVzKHZhbHVlLCBmbih0aGlzW2ldLCBhcmcxLCBhcmcyLCBhcmczKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09IHVuZGVmaW5lZCA/IHRoaXMgOiB2YWx1ZTsKICAgICAgICB9OwoKICAgICAgICAvLyBiaW5kIGxlZ2FjeSBiaW5kL3VuYmluZCB0byBvbi9vZmYKICAgICAgICBKUUxpdGUucHJvdG90eXBlLmJpbmQgPSBKUUxpdGUucHJvdG90eXBlLm9uOwogICAgICAgIEpRTGl0ZS5wcm90b3R5cGUudW5iaW5kID0gSlFMaXRlLnByb3RvdHlwZS5vZmY7CiAgICB9KTsKCiAgICAvKioKICAgICAqIENvbXB1dGVzIGEgaGFzaCBvZiBhbiAnb2JqJy4KICAgICAqIEhhc2ggb2YgYToKICAgICAqICBzdHJpbmcgaXMgc3RyaW5nCiAgICAgKiAgbnVtYmVyIGlzIG51bWJlciBhcyBzdHJpbmcKICAgICAqICBvYmplY3QgaXMgZWl0aGVyIHJlc3VsdCBvZiBjYWxsaW5nICQkaGFzaEtleSBmdW5jdGlvbiBvbiB0aGUgb2JqZWN0IG9yIHVuaXF1ZWx5IGdlbmVyYXRlZCBpZCwKICAgICAqICAgICAgICAgdGhhdCBpcyBhbHNvIGFzc2lnbmVkIHRvIHRoZSAkJGhhc2hLZXkgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gb2JqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBoYXNoIHN0cmluZyBzdWNoIHRoYXQgdGhlIHNhbWUgaW5wdXQgd2lsbCBoYXZlIHRoZSBzYW1lIGhhc2ggc3RyaW5nLgogICAgICogICAgICAgICBUaGUgcmVzdWx0aW5nIHN0cmluZyBrZXkgaXMgaW4gJ3R5cGU6aGFzaEtleScgZm9ybWF0LgogICAgICovCiAgICBmdW5jdGlvbiBoYXNoS2V5KG9iaikgewogICAgICAgIHZhciBvYmpUeXBlID0gdHlwZW9mIG9iaiwKICAgICAgICAgICAga2V5OwoKICAgICAgICBpZiAob2JqVHlwZSA9PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiAoa2V5ID0gb2JqLiQkaGFzaEtleSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgLy8gbXVzdCBpbnZva2Ugb24gb2JqZWN0IHRvIGtlZXAgdGhlIHJpZ2h0IHRoaXMKICAgICAgICAgICAgICAgIGtleSA9IG9iai4kJGhhc2hLZXkoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAga2V5ID0gb2JqLiQkaGFzaEtleSA9IG5leHRVaWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleSA9IG9iajsKICAgICAgICB9CgogICAgICAgIHJldHVybiBvYmpUeXBlICsgJzonICsga2V5OwogICAgfQoKICAgIC8qKgogICAgICogSGFzaE1hcCB3aGljaCBjYW4gdXNlIG9iamVjdHMgYXMga2V5cwogICAgICovCiAgICBmdW5jdGlvbiBIYXNoTWFwKGFycmF5KSB7CiAgICAgICAgZm9yRWFjaChhcnJheSwgdGhpcy5wdXQsIHRoaXMpOwogICAgfQogICAgSGFzaE1hcC5wcm90b3R5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogU3RvcmUga2V5IHZhbHVlIHBhaXIKICAgICAgICAgKiBAcGFyYW0ga2V5IGtleSB0byBzdG9yZSBjYW4gYmUgYW55IHR5cGUKICAgICAgICAgKiBAcGFyYW0gdmFsdWUgdmFsdWUgdG8gc3RvcmUgY2FuIGJlIGFueSB0eXBlCiAgICAgICAgICovCiAgICAgICAgcHV0OiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICB0aGlzW2hhc2hLZXkoa2V5KV0gPSB2YWx1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcGFyYW0ga2V5CiAgICAgICAgICogQHJldHVybnMgdGhlIHZhbHVlIGZvciB0aGUga2V5CiAgICAgICAgICovCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW2hhc2hLZXkoa2V5KV07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVtb3ZlIHRoZSBrZXkvdmFsdWUgcGFpcgogICAgICAgICAqIEBwYXJhbSBrZXkKICAgICAgICAgKi8KICAgICAgICByZW1vdmU6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpc1trZXkgPSBoYXNoS2V5KGtleSldOwogICAgICAgICAgICBkZWxldGUgdGhpc1trZXldOwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgYW5ndWxhci5pbmplY3RvcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGFuIGluamVjdG9yIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIHVzZWQgZm9yIHJldHJpZXZpbmcgc2VydmljZXMgYXMgd2VsbCBhcyBmb3IKICAgICAqIGRlcGVuZGVuY3kgaW5qZWN0aW9uIChzZWUge0BsaW5rIGd1aWRlL2RpIGRlcGVuZGVuY3kgaW5qZWN0aW9ufSkuCiAgICAgKgogICAgCiAgICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmd8RnVuY3Rpb24+fSBtb2R1bGVzIEEgbGlzdCBvZiBtb2R1bGUgZnVuY3Rpb25zIG9yIHRoZWlyIGFsaWFzZXMuIFNlZQogICAgICogICAgICAgIHtAbGluayBhbmd1bGFyLm1vZHVsZX0uIFRoZSBgbmdgIG1vZHVsZSBtdXN0IGJlIGV4cGxpY2l0bHkgYWRkZWQuCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gSW5qZWN0b3IgZnVuY3Rpb24uIFNlZSB7QGxpbmsgQVVUTy4kaW5qZWN0b3IgJGluamVjdG9yfS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogVHlwaWNhbCB1c2FnZQogICAgICogPHByZT4KICAgICAqICAgLy8gY3JlYXRlIGFuIGluamVjdG9yCiAgICAgKiAgIHZhciAkaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKFsnbmcnXSk7CiAgICAgKgogICAgICogICAvLyB1c2UgdGhlIGluamVjdG9yIHRvIGtpY2sgb2ZmIHlvdXIgYXBwbGljYXRpb24KICAgICAqICAgLy8gdXNlIHRoZSB0eXBlIGluZmVyZW5jZSB0byBhdXRvIGluamVjdCBhcmd1bWVudHMsIG9yIHVzZSBpbXBsaWNpdCBpbmplY3Rpb24KICAgICAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkcm9vdFNjb3BlLCAkY29tcGlsZSwgJGRvY3VtZW50KXsKICAgICAqICAgICAkY29tcGlsZSgkZG9jdW1lbnQpKCRyb290U2NvcGUpOwogICAgICogICAgICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICogICB9KTsKICAgICAqIDwvcHJlPgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG92ZXJ2aWV3CiAgICAgKiBAbmFtZSBBVVRPCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBJbXBsaWNpdCBtb2R1bGUgd2hpY2ggZ2V0cyBhdXRvbWF0aWNhbGx5IGFkZGVkIHRvIGVhY2gge0BsaW5rIEFVVE8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgKi8KCiAgICB2YXIgRk5fQVJHUyA9IC9eZnVuY3Rpb25ccypbXlwoXSpcKFxzKihbXlwpXSopXCkvbTsKICAgIHZhciBGTl9BUkdfU1BMSVQgPSAvLC87CiAgICB2YXIgRk5fQVJHID0gL15ccyooXz8pKFxTKz8pXDFccyokLzsKICAgIHZhciBTVFJJUF9DT01NRU5UUyA9IC8oKFwvXC8uKiQpfChcL1wqW1xzXFNdKj9cKlwvKSkvbWc7CiAgICB2YXIgJGluamVjdG9yTWluRXJyID0gbWluRXJyKCckaW5qZWN0b3InKTsKICAgIGZ1bmN0aW9uIGFubm90YXRlKGZuKSB7CiAgICAgICAgdmFyICRpbmplY3QsCiAgICAgICAgICAgIGZuVGV4dCwKICAgICAgICAgICAgYXJnRGVjbCwKICAgICAgICAgICAgbGFzdDsKCiAgICAgICAgaWYgKHR5cGVvZiBmbiA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGlmICghKCRpbmplY3QgPSBmbi4kaW5qZWN0KSkgewogICAgICAgICAgICAgICAgJGluamVjdCA9IFtdOwogICAgICAgICAgICAgICAgaWYgKGZuLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGZuVGV4dCA9IGZuLnRvU3RyaW5nKCkucmVwbGFjZShTVFJJUF9DT01NRU5UUywgJycpOwogICAgICAgICAgICAgICAgICAgIGFyZ0RlY2wgPSBmblRleHQubWF0Y2goRk5fQVJHUyk7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChhcmdEZWNsWzFdLnNwbGl0KEZOX0FSR19TUExJVCksIGZ1bmN0aW9uIChhcmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJnLnJlcGxhY2UoRk5fQVJHLCBmdW5jdGlvbiAoYWxsLCB1bmRlcnNjb3JlLCBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkaW5qZWN0LnB1c2gobmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm4uJGluamVjdCA9ICRpbmplY3Q7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkoZm4pKSB7CiAgICAgICAgICAgIGxhc3QgPSBmbi5sZW5ndGggLSAxOwogICAgICAgICAgICBhc3NlcnRBcmdGbihmbltsYXN0XSwgJ2ZuJyk7CiAgICAgICAgICAgICRpbmplY3QgPSBmbi5zbGljZSgwLCBsYXN0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhc3NlcnRBcmdGbihmbiwgJ2ZuJywgdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkaW5qZWN0OwogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgQVVUTy4kaW5qZWN0b3IKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIGAkaW5qZWN0b3JgIGlzIHVzZWQgdG8gcmV0cmlldmUgb2JqZWN0IGluc3RhbmNlcyBhcyBkZWZpbmVkIGJ5CiAgICAgKiB7QGxpbmsgQVVUTy4kcHJvdmlkZSBwcm92aWRlcn0sIGluc3RhbnRpYXRlIHR5cGVzLCBpbnZva2UgbWV0aG9kcywKICAgICAqIGFuZCBsb2FkIG1vZHVsZXMuCiAgICAgKgogICAgICogVGhlIGZvbGxvd2luZyBhbHdheXMgaG9sZHMgdHJ1ZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICB2YXIgJGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcigpOwogICAgICogICBleHBlY3QoJGluamVjdG9yLmdldCgnJGluamVjdG9yJykpLnRvQmUoJGluamVjdG9yKTsKICAgICAqICAgZXhwZWN0KCRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJGluamVjdG9yKXsKICAgICAqICAgICByZXR1cm4gJGluamVjdG9yOwogICAgICogICB9KS50b0JlKCRpbmplY3Rvcik7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiAjIEluamVjdGlvbiBGdW5jdGlvbiBBbm5vdGF0aW9uCiAgICAgKgogICAgICogSmF2YVNjcmlwdCBkb2VzIG5vdCBoYXZlIGFubm90YXRpb25zLCBhbmQgYW5ub3RhdGlvbnMgYXJlIG5lZWRlZCBmb3IgZGVwZW5kZW5jeSBpbmplY3Rpb24uIFRoZQogICAgICogZm9sbG93aW5nIGFyZSBhbGwgdmFsaWQgd2F5cyBvZiBhbm5vdGF0aW5nIGZ1bmN0aW9uIHdpdGggaW5qZWN0aW9uIGFyZ3VtZW50cyBhbmQgYXJlIGVxdWl2YWxlbnQuCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gaW5mZXJyZWQgKG9ubHkgd29ya3MgaWYgY29kZSBub3QgbWluaWZpZWQvb2JmdXNjYXRlZCkKICAgICAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbihzZXJ2aWNlQSl7fSk7CiAgICAgKgogICAgICogICAvLyBhbm5vdGF0ZWQKICAgICAqICAgZnVuY3Rpb24gZXhwbGljaXQoc2VydmljZUEpIHt9OwogICAgICogICBleHBsaWNpdC4kaW5qZWN0ID0gWydzZXJ2aWNlQSddOwogICAgICogICAkaW5qZWN0b3IuaW52b2tlKGV4cGxpY2l0KTsKICAgICAqCiAgICAgKiAgIC8vIGlubGluZQogICAgICogICAkaW5qZWN0b3IuaW52b2tlKFsnc2VydmljZUEnLCBmdW5jdGlvbihzZXJ2aWNlQSl7fV0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogIyMgSW5mZXJlbmNlCiAgICAgKgogICAgICogSW4gSmF2YVNjcmlwdCBjYWxsaW5nIGB0b1N0cmluZygpYCBvbiBhIGZ1bmN0aW9uIHJldHVybnMgdGhlIGZ1bmN0aW9uIGRlZmluaXRpb24uIFRoZSBkZWZpbml0aW9uIGNhbiB0aGVuIGJlCiAgICAgKiBwYXJzZWQgYW5kIHRoZSBmdW5jdGlvbiBhcmd1bWVudHMgY2FuIGJlIGV4dHJhY3RlZC4gKk5PVEU6KiBUaGlzIGRvZXMgbm90IHdvcmsgd2l0aCBtaW5pZmljYXRpb24sIGFuZCBvYmZ1c2NhdGlvbgogICAgICogdG9vbHMgc2luY2UgdGhlc2UgdG9vbHMgY2hhbmdlIHRoZSBhcmd1bWVudCBuYW1lcy4KICAgICAqCiAgICAgKiAjIyBgJGluamVjdGAgQW5ub3RhdGlvbgogICAgICogQnkgYWRkaW5nIGEgYCRpbmplY3RgIHByb3BlcnR5IG9udG8gYSBmdW5jdGlvbiB0aGUgaW5qZWN0aW9uIHBhcmFtZXRlcnMgY2FuIGJlIHNwZWNpZmllZC4KICAgICAqCiAgICAgKiAjIyBJbmxpbmUKICAgICAqIEFzIGFuIGFycmF5IG9mIGluamVjdGlvbiBuYW1lcywgd2hlcmUgdGhlIGxhc3QgaXRlbSBpbiB0aGUgYXJyYXkgaXMgdGhlIGZ1bmN0aW9uIHRvIGNhbGwuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yI2dldAogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm4gYW4gaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlIHRvIHJldHJpZXZlLgogICAgICogQHJldHVybiB7Kn0gVGhlIGluc3RhbmNlLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNpbnZva2UKICAgICAqIEBtZXRob2RPZiBBVVRPLiRpbmplY3RvcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSW52b2tlIHRoZSBtZXRob2QgYW5kIHN1cHBseSB0aGUgbWV0aG9kIGFyZ3VtZW50cyBmcm9tIHRoZSBgJGluamVjdG9yYC4KICAgICAqCiAgICAgKiBAcGFyYW0geyFmdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIGludm9rZS4gVGhlIGZ1bmN0aW9uIGFyZ3VtZW50cyBjb21lIGZvcm0gdGhlIGZ1bmN0aW9uIGFubm90YXRpb24uCiAgICAgKiBAcGFyYW0ge09iamVjdD19IHNlbGYgVGhlIGB0aGlzYCBmb3IgdGhlIGludm9rZWQgbWV0aG9kLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzIG9iamVjdCBmaXJzdCwgYmVmb3JlCiAgICAgKiAgIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAgICAgKiBAcmV0dXJucyB7Kn0gdGhlIHZhbHVlIHJldHVybmVkIGJ5IHRoZSBpbnZva2VkIGBmbmAgZnVuY3Rpb24uCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yI2hhcwogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBbGxvd3MgdGhlIHVzZXIgdG8gcXVlcnkgaWYgdGhlIHBhcnRpY3VsYXIgc2VydmljZSBleGlzdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gTmFtZSBvZiB0aGUgc2VydmljZSB0byBxdWVyeS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSByZXR1cm5zIHRydWUgaWYgaW5qZWN0b3IgaGFzIGdpdmVuIHNlcnZpY2UuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJGluamVjdG9yI2luc3RhbnRpYXRlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kaW5qZWN0b3IKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIEpTIHR5cGUuIFRoZSBtZXRob2QgdGFrZXMgYSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBpbnZva2VzIHRoZSBuZXcgb3BlcmF0b3IgYW5kIHN1cHBsaWVzCiAgICAgKiBhbGwgb2YgdGhlIGFyZ3VtZW50cyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24gYXMgc3BlY2lmaWVkIGJ5IHRoZSBjb25zdHJ1Y3RvciBhbm5vdGF0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFR5cGUgQW5ub3RhdGVkIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzIG9iamVjdCBmaXJzdCwgYmVmb3JlCiAgICAgKiAgIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBuZXcgaW5zdGFuY2Ugb2YgYFR5cGVgLgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBBVVRPLiRpbmplY3RvciNhbm5vdGF0ZQogICAgICogQG1ldGhvZE9mIEFVVE8uJGluamVjdG9yCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGFuIGFycmF5IG9mIHNlcnZpY2UgbmFtZXMgd2hpY2ggdGhlIGZ1bmN0aW9uIGlzIHJlcXVlc3RpbmcgZm9yIGluamVjdGlvbi4gVGhpcyBBUEkgaXMgdXNlZCBieSB0aGUgaW5qZWN0b3IKICAgICAqIHRvIGRldGVybWluZSB3aGljaCBzZXJ2aWNlcyBuZWVkIHRvIGJlIGluamVjdGVkIGludG8gdGhlIGZ1bmN0aW9uIHdoZW4gdGhlIGZ1bmN0aW9uIGlzIGludm9rZWQuIFRoZXJlIGFyZSB0aHJlZQogICAgICogd2F5cyBpbiB3aGljaCB0aGUgZnVuY3Rpb24gY2FuIGJlIGFubm90YXRlZCB3aXRoIHRoZSBuZWVkZWQgZGVwZW5kZW5jaWVzLgogICAgICoKICAgICAqICMgQXJndW1lbnQgbmFtZXMKICAgICAqCiAgICAgKiBUaGUgc2ltcGxlc3QgZm9ybSBpcyB0byBleHRyYWN0IHRoZSBkZXBlbmRlbmNpZXMgZnJvbSB0aGUgYXJndW1lbnRzIG9mIHRoZSBmdW5jdGlvbi4gVGhpcyBpcyBkb25lIGJ5IGNvbnZlcnRpbmcKICAgICAqIHRoZSBmdW5jdGlvbiBpbnRvIGEgc3RyaW5nIHVzaW5nIGB0b1N0cmluZygpYCBtZXRob2QgYW5kIGV4dHJhY3RpbmcgdGhlIGFyZ3VtZW50IG5hbWVzLgogICAgICogPHByZT4KICAgICAqICAgLy8gR2l2ZW4KICAgICAqICAgZnVuY3Rpb24gTXlDb250cm9sbGVyKCRzY29wZSwgJHJvdXRlKSB7CiAgICAgKiAgICAgLy8gLi4uCiAgICAgKiAgIH0KICAgICAqCiAgICAgKiAgIC8vIFRoZW4KICAgICAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKE15Q29udHJvbGxlcikpLnRvRXF1YWwoWyckc2NvcGUnLCAnJHJvdXRlJ10pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhpcyBtZXRob2QgZG9lcyBub3Qgd29yayB3aXRoIGNvZGUgbWluaWZpY2F0aW9uIC8gb2JmdXNjYXRpb24uIEZvciB0aGlzIHJlYXNvbiB0aGUgZm9sbG93aW5nIGFubm90YXRpb24gc3RyYXRlZ2llcwogICAgICogYXJlIHN1cHBvcnRlZC4KICAgICAqCiAgICAgKiAjIFRoZSBgJGluamVjdGAgcHJvcGVydHkKICAgICAqCiAgICAgKiBJZiBhIGZ1bmN0aW9uIGhhcyBhbiBgJGluamVjdGAgcHJvcGVydHkgYW5kIGl0cyB2YWx1ZSBpcyBhbiBhcnJheSBvZiBzdHJpbmdzLCB0aGVuIHRoZSBzdHJpbmdzIHJlcHJlc2VudCBuYW1lcyBvZgogICAgICogc2VydmljZXMgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgZnVuY3Rpb24uCiAgICAgKiA8cHJlPgogICAgICogICAvLyBHaXZlbgogICAgICogICB2YXIgTXlDb250cm9sbGVyID0gZnVuY3Rpb24ob2JmdXNjYXRlZFNjb3BlLCBvYmZ1c2NhdGVkUm91dGUpIHsKICAgICAqICAgICAvLyAuLi4KICAgICAqICAgfQogICAgICogICAvLyBEZWZpbmUgZnVuY3Rpb24gZGVwZW5kZW5jaWVzCiAgICAgKiAgIE15Q29udHJvbGxlci4kaW5qZWN0ID0gWyckc2NvcGUnLCAnJHJvdXRlJ107CiAgICAgKgogICAgICogICAvLyBUaGVuCiAgICAgKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZShNeUNvbnRyb2xsZXIpKS50b0VxdWFsKFsnJHNjb3BlJywgJyRyb3V0ZSddKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqICMgVGhlIGFycmF5IG5vdGF0aW9uCiAgICAgKgogICAgICogSXQgaXMgb2Z0ZW4gZGVzaXJhYmxlIHRvIGlubGluZSBJbmplY3RlZCBmdW5jdGlvbnMgYW5kIHRoYXQncyB3aGVuIHNldHRpbmcgdGhlIGAkaW5qZWN0YCBwcm9wZXJ0eSBpcyB2ZXJ5CiAgICAgKiBpbmNvbnZlbmllbnQuIEluIHRoZXNlIHNpdHVhdGlvbnMgdXNpbmcgdGhlIGFycmF5IG5vdGF0aW9uIHRvIHNwZWNpZnkgdGhlIGRlcGVuZGVuY2llcyBpbiBhIHdheSB0aGF0IHN1cnZpdmVzCiAgICAgKiBtaW5pZmljYXRpb24gaXMgYSBiZXR0ZXIgY2hvaWNlOgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAgIC8vIFdlIHdpc2ggdG8gd3JpdGUgdGhpcyAobm90IG1pbmlmaWNhdGlvbiAvIG9iZnVzY2F0aW9uIHNhZmUpCiAgICAgKiAgIGluamVjdG9yLmludm9rZShmdW5jdGlvbigkY29tcGlsZSwgJHJvb3RTY29wZSkgewogICAgICogICAgIC8vIC4uLgogICAgICogICB9KTsKICAgICAqCiAgICAgKiAgIC8vIFdlIGFyZSBmb3JjZWQgdG8gd3JpdGUgYnJlYWsgaW5saW5pbmcKICAgICAqICAgdmFyIHRtcEZuID0gZnVuY3Rpb24ob2JmdXNjYXRlZENvbXBpbGUsIG9iZnVzY2F0ZWRSb290U2NvcGUpIHsKICAgICAqICAgICAvLyAuLi4KICAgICAqICAgfTsKICAgICAqICAgdG1wRm4uJGluamVjdCA9IFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZSddOwogICAgICogICBpbmplY3Rvci5pbnZva2UodG1wRm4pOwogICAgICoKICAgICAqICAgLy8gVG8gYmV0dGVyIHN1cHBvcnQgaW5saW5lIGZ1bmN0aW9uIHRoZSBpbmxpbmUgYW5ub3RhdGlvbiBpcyBzdXBwb3J0ZWQKICAgICAqICAgaW5qZWN0b3IuaW52b2tlKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKG9iZkNvbXBpbGUsIG9iZlJvb3RTY29wZSkgewogICAgICogICAgIC8vIC4uLgogICAgICogICB9XSk7CiAgICAgKgogICAgICogICAvLyBUaGVyZWZvcmUKICAgICAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKAogICAgICogICAgICBbJyRjb21waWxlJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbihvYmZ1c18kY29tcGlsZSwgb2JmdXNfJHJvb3RTY29wZSkge31dKQogICAgICogICAgKS50b0VxdWFsKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZSddKTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb258QXJyYXkuPHN0cmluZ3xGdW5jdGlvbj59IGZuIEZ1bmN0aW9uIGZvciB3aGljaCBkZXBlbmRlbnQgc2VydmljZSBuYW1lcyBuZWVkIHRvIGJlIHJldHJpZXZlZCBhcyBkZXNjcmliZWQKICAgICAqICAgYWJvdmUuCiAgICAgKgogICAgICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fSBUaGUgbmFtZXMgb2YgdGhlIHNlcnZpY2VzIHdoaWNoIHRoZSBmdW5jdGlvbiByZXF1aXJlcy4KICAgICAqLwoKCgoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFVzZSBgJHByb3ZpZGVgIHRvIHJlZ2lzdGVyIG5ldyBwcm92aWRlcnMgd2l0aCB0aGUgYCRpbmplY3RvcmAuIFRoZSBwcm92aWRlcnMgYXJlIHRoZSBmYWN0b3JpZXMgZm9yIHRoZSBpbnN0YW5jZS4KICAgICAqIFRoZSBwcm92aWRlcnMgc2hhcmUgdGhlIHNhbWUgbmFtZSBhcyB0aGUgaW5zdGFuY2UgdGhleSBjcmVhdGUgd2l0aCBgUHJvdmlkZXJgIHN1ZmZpeGVkIHRvIHRoZW0uCiAgICAgKgogICAgICogQSBwcm92aWRlciBpcyBhbiBvYmplY3Qgd2l0aCBhIGAkZ2V0KClgIG1ldGhvZC4gVGhlIGluamVjdG9yIGNhbGxzIHRoZSBgJGdldGAgbWV0aG9kIHRvIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZgogICAgICogYSBzZXJ2aWNlLiBUaGUgUHJvdmlkZXIgY2FuIGhhdmUgYWRkaXRpb25hbCBtZXRob2RzIHdoaWNoIHdvdWxkIGFsbG93IGZvciBjb25maWd1cmF0aW9uIG9mIHRoZSBwcm92aWRlci4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICBmdW5jdGlvbiBHcmVldFByb3ZpZGVyKCkgewogICAgICogICAgIHZhciBzYWx1dGF0aW9uID0gJ0hlbGxvJzsKICAgICAqCiAgICAgKiAgICAgdGhpcy5zYWx1dGF0aW9uID0gZnVuY3Rpb24odGV4dCkgewogICAgICogICAgICAgc2FsdXRhdGlvbiA9IHRleHQ7CiAgICAgKiAgICAgfTsKICAgICAqCiAgICAgKiAgICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAqICAgICAgICAgcmV0dXJuIHNhbHV0YXRpb24gKyAnICcgKyBuYW1lICsgJyEnOwogICAgICogICAgICAgfTsKICAgICAqICAgICB9OwogICAgICogICB9CiAgICAgKgogICAgICogICBkZXNjcmliZSgnR3JlZXRlcicsIGZ1bmN0aW9uKCl7CiAgICAgKgogICAgICogICAgIGJlZm9yZUVhY2gobW9kdWxlKGZ1bmN0aW9uKCRwcm92aWRlKSB7CiAgICAgKiAgICAgICAkcHJvdmlkZS5wcm92aWRlcignZ3JlZXQnLCBHcmVldFByb3ZpZGVyKTsKICAgICAqICAgICB9KSk7CiAgICAgKgogICAgICogICAgIGl0KCdzaG91bGQgZ3JlZXQnLCBpbmplY3QoZnVuY3Rpb24oZ3JlZXQpIHsKICAgICAqICAgICAgIGV4cGVjdChncmVldCgnYW5ndWxhcicpKS50b0VxdWFsKCdIZWxsbyBhbmd1bGFyIScpOwogICAgICogICAgIH0pKTsKICAgICAqCiAgICAgKiAgICAgaXQoJ3Nob3VsZCBhbGxvdyBjb25maWd1cmF0aW9uIG9mIHNhbHV0YXRpb24nLCBmdW5jdGlvbigpIHsKICAgICAqICAgICAgIG1vZHVsZShmdW5jdGlvbihncmVldFByb3ZpZGVyKSB7CiAgICAgKiAgICAgICAgIGdyZWV0UHJvdmlkZXIuc2FsdXRhdGlvbignQWhvaicpOwogICAgICogICAgICAgfSk7CiAgICAgKiAgICAgICBpbmplY3QoZnVuY3Rpb24oZ3JlZXQpIHsKICAgICAqICAgICAgICAgZXhwZWN0KGdyZWV0KCdhbmd1bGFyJykpLnRvRXF1YWwoJ0Fob2ogYW5ndWxhciEnKTsKICAgICAqICAgICAgIH0pOwogICAgICogICAgIH0pOwogICAgICogPC9wcmU+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjcHJvdmlkZXIKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBSZWdpc3RlciBhIHByb3ZpZGVyIGZvciBhIHNlcnZpY2UuIFRoZSBwcm92aWRlcnMgY2FuIGJlIHJldHJpZXZlZCBhbmQgY2FuIGhhdmUgYWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG1ldGhvZHMuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLiBOT1RFOiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBhdmFpbGFibGUgdW5kZXIgYG5hbWUgKyAnUHJvdmlkZXInYCBrZXkuCiAgICAgKiBAcGFyYW0geyhPYmplY3R8ZnVuY3Rpb24oKSl9IHByb3ZpZGVyIElmIHRoZSBwcm92aWRlciBpczoKICAgICAqCiAgICAgKiAgIC0gYE9iamVjdGA6IHRoZW4gaXQgc2hvdWxkIGhhdmUgYSBgJGdldGAgbWV0aG9kLiBUaGUgYCRnZXRgIG1ldGhvZCB3aWxsIGJlIGludm9rZWQgdXNpbmcKICAgICAqICAgICAgICAgICAgICAge0BsaW5rIEFVVE8uJGluamVjdG9yI2ludm9rZSAkaW5qZWN0b3IuaW52b2tlKCl9IHdoZW4gYW4gaW5zdGFuY2UgbmVlZHMgdG8gYmUgY3JlYXRlZC4KICAgICAqICAgLSBgQ29uc3RydWN0b3JgOiBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBjcmVhdGVkIHVzaW5nCiAgICAgKiAgICAgICAgICAgICAgIHtAbGluayBBVVRPLiRpbmplY3RvciNpbnN0YW50aWF0ZSAkaW5qZWN0b3IuaW5zdGFudGlhdGUoKX0sIHRoZW4gdHJlYXRlZCBhcyBgb2JqZWN0YC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjZmFjdG9yeQogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgc2hvcnQgaGFuZCBmb3IgY29uZmlndXJpbmcgc2VydmljZXMgaWYgb25seSBgJGdldGAgbWV0aG9kIGlzIHJlcXVpcmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gJGdldEZuIFRoZSAkZ2V0Rm4gZm9yIHRoZSBpbnN0YW5jZSBjcmVhdGlvbi4gSW50ZXJuYWxseSB0aGlzIGlzIGEgc2hvcnQgaGFuZCBmb3IKICAgICAqIGAkcHJvdmlkZS5wcm92aWRlcihuYW1lLCB7JGdldDogJGdldEZufSlgLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSNzZXJ2aWNlCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQSBzaG9ydCBoYW5kIGZvciByZWdpc3RlcmluZyBzZXJ2aWNlIG9mIGdpdmVuIGNsYXNzLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY2xhc3MgKGNvbnN0cnVjdG9yIGZ1bmN0aW9uKSB0aGF0IHdpbGwgYmUgaW5zdGFudGlhdGVkLgogICAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgQVVUTy4kcHJvdmlkZSN2YWx1ZQogICAgICogQG1ldGhvZE9mIEFVVE8uJHByb3ZpZGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEEgc2hvcnQgaGFuZCBmb3IgY29uZmlndXJpbmcgc2VydmljZXMgaWYgdGhlIGAkZ2V0YCBtZXRob2QgaXMgYSBjb25zdGFudC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjY29uc3RhbnQKICAgICAqIEBtZXRob2RPZiBBVVRPLiRwcm92aWRlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIGNvbnN0YW50IHZhbHVlLCBidXQgdW5saWtlIHtAbGluayBBVVRPLiRwcm92aWRlI3ZhbHVlIHZhbHVlfSBpdCBjYW4gYmUgaW5qZWN0ZWQKICAgICAqIGludG8gY29uZmlndXJhdGlvbiBmdW5jdGlvbiAob3RoZXIgbW9kdWxlcykgYW5kIGl0IGlzIG5vdCBpbnRlcmNlcHRhYmxlIGJ5CiAgICAgKiB7QGxpbmsgQVVUTy4kcHJvdmlkZSNkZWNvcmF0b3IgZGVjb3JhdG9yfS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgY29uc3RhbnQuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSBjb25zdGFudCB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgaW5zdGFuY2UKICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIEFVVE8uJHByb3ZpZGUjZGVjb3JhdG9yCiAgICAgKiBAbWV0aG9kT2YgQVVUTy4kcHJvdmlkZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRGVjb3JhdGlvbiBvZiBzZXJ2aWNlLCBhbGxvd3MgdGhlIGRlY29yYXRvciB0byBpbnRlcmNlcHQgdGhlIHNlcnZpY2UgaW5zdGFuY2UgY3JlYXRpb24uIFRoZQogICAgICogcmV0dXJuZWQgaW5zdGFuY2UgbWF5IGJlIHRoZSBvcmlnaW5hbCBpbnN0YW5jZSwgb3IgYSBuZXcgaW5zdGFuY2Ugd2hpY2ggZGVsZWdhdGVzIHRvIHRoZQogICAgICogb3JpZ2luYWwgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHNlcnZpY2UgdG8gZGVjb3JhdGUuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGRlY29yYXRvciBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgaW52b2tlZCB3aGVuIHRoZSBzZXJ2aWNlIG5lZWRzIHRvIGJlCiAgICAgKiAgICBpbnN0YW50aWF0ZWQuIFRoZSBmdW5jdGlvbiBpcyBjYWxsZWQgdXNpbmcgdGhlIHtAbGluayBBVVRPLiRpbmplY3RvciNpbnZva2UKICAgICAqICAgIGluamVjdG9yLmludm9rZX0gbWV0aG9kIGFuZCBpcyB0aGVyZWZvcmUgZnVsbHkgaW5qZWN0YWJsZS4gTG9jYWwgaW5qZWN0aW9uIGFyZ3VtZW50czoKICAgICAqCiAgICAgKiAgICAqIGAkZGVsZWdhdGVgIC0gVGhlIG9yaWdpbmFsIHNlcnZpY2UgaW5zdGFuY2UsIHdoaWNoIGNhbiBiZSBtb25rZXkgcGF0Y2hlZCwgY29uZmlndXJlZCwKICAgICAqICAgICAgZGVjb3JhdGVkIG9yIGRlbGVnYXRlZCB0by4KICAgICAqLwoKCiAgICBmdW5jdGlvbiBjcmVhdGVJbmplY3Rvcihtb2R1bGVzVG9Mb2FkKSB7CiAgICAgICAgdmFyIElOU1RBTlRJQVRJTkcgPSB7fSwKICAgICAgICAgICAgcHJvdmlkZXJTdWZmaXggPSAnUHJvdmlkZXInLAogICAgICAgICAgICBwYXRoID0gW10sCiAgICAgICAgICAgIGxvYWRlZE1vZHVsZXMgPSBuZXcgSGFzaE1hcCgpLAogICAgICAgICAgICBwcm92aWRlckNhY2hlID0gewogICAgICAgICAgICAgICAgJHByb3ZpZGU6IHsKICAgICAgICAgICAgICAgICAgICBwcm92aWRlcjogc3VwcG9ydE9iamVjdChwcm92aWRlciksCiAgICAgICAgICAgICAgICAgICAgZmFjdG9yeTogc3VwcG9ydE9iamVjdChmYWN0b3J5KSwKICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiBzdXBwb3J0T2JqZWN0KHNlcnZpY2UpLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBzdXBwb3J0T2JqZWN0KHZhbHVlKSwKICAgICAgICAgICAgICAgICAgICBjb25zdGFudDogc3VwcG9ydE9iamVjdChjb25zdGFudCksCiAgICAgICAgICAgICAgICAgICAgZGVjb3JhdG9yOiBkZWNvcmF0b3IKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgcHJvdmlkZXJJbmplY3RvciA9IChwcm92aWRlckNhY2hlLiRpbmplY3RvciA9CiAgICAgICAgICAgICAgICBjcmVhdGVJbnRlcm5hbEluamVjdG9yKHByb3ZpZGVyQ2FjaGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ3VucHInLCAiVW5rbm93biBwcm92aWRlcjogezB9IiwgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgICAgICAgfSkpLAogICAgICAgICAgICBpbnN0YW5jZUNhY2hlID0ge30sCiAgICAgICAgICAgIGluc3RhbmNlSW5qZWN0b3IgPSAoaW5zdGFuY2VDYWNoZS4kaW5qZWN0b3IgPQogICAgICAgICAgICAgICAgY3JlYXRlSW50ZXJuYWxJbmplY3RvcihpbnN0YW5jZUNhY2hlLCBmdW5jdGlvbiAoc2VydmljZW5hbWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChzZXJ2aWNlbmFtZSArIHByb3ZpZGVyU3VmZml4KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2VJbmplY3Rvci5pbnZva2UocHJvdmlkZXIuJGdldCwgcHJvdmlkZXIpOwogICAgICAgICAgICAgICAgfSkpOwoKCiAgICAgICAgZm9yRWFjaChsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKSwgZnVuY3Rpb24gKGZuKSB7IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGZuIHx8IG5vb3ApOyB9KTsKCiAgICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3I7CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vICRwcm92aWRlcgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICBmdW5jdGlvbiBzdXBwb3J0T2JqZWN0KGRlbGVnYXRlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGtleSwgcmV2ZXJzZVBhcmFtcyhkZWxlZ2F0ZSkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVsZWdhdGUoa2V5LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHByb3ZpZGVyKG5hbWUsIHByb3ZpZGVyXykgewogICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihwcm92aWRlcl8pIHx8IGlzQXJyYXkocHJvdmlkZXJfKSkgewogICAgICAgICAgICAgICAgcHJvdmlkZXJfID0gcHJvdmlkZXJJbmplY3Rvci5pbnN0YW50aWF0ZShwcm92aWRlcl8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghcHJvdmlkZXJfLiRnZXQpIHsKICAgICAgICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycigncGdldCcsICJQcm92aWRlciAnezB9JyBtdXN0IGRlZmluZSAkZ2V0IGZhY3RvcnkgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcm92aWRlckNhY2hlW25hbWUgKyBwcm92aWRlclN1ZmZpeF0gPSBwcm92aWRlcl87CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmYWN0b3J5KG5hbWUsIGZhY3RvcnlGbikgeyByZXR1cm4gcHJvdmlkZXIobmFtZSwgeyAkZ2V0OiBmYWN0b3J5Rm4gfSk7IH0KCiAgICAgICAgZnVuY3Rpb24gc2VydmljZShuYW1lLCBjb25zdHJ1Y3RvcikgewogICAgICAgICAgICByZXR1cm4gZmFjdG9yeShuYW1lLCBbJyRpbmplY3RvcicsIGZ1bmN0aW9uICgkaW5qZWN0b3IpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkaW5qZWN0b3IuaW5zdGFudGlhdGUoY29uc3RydWN0b3IpOwogICAgICAgICAgICB9XSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB2YWx1ZShuYW1lLCB2YWx1ZSkgeyByZXR1cm4gZmFjdG9yeShuYW1lLCB2YWx1ZUZuKHZhbHVlKSk7IH0KCiAgICAgICAgZnVuY3Rpb24gY29uc3RhbnQobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgcHJvdmlkZXJDYWNoZVtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICBpbnN0YW5jZUNhY2hlW25hbWVdID0gdmFsdWU7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkZWNvcmF0b3Ioc2VydmljZU5hbWUsIGRlY29yRm4pIHsKICAgICAgICAgICAgdmFyIG9yaWdQcm92aWRlciA9IHByb3ZpZGVySW5qZWN0b3IuZ2V0KHNlcnZpY2VOYW1lICsgcHJvdmlkZXJTdWZmaXgpLAogICAgICAgICAgICAgICAgb3JpZyRnZXQgPSBvcmlnUHJvdmlkZXIuJGdldDsKCiAgICAgICAgICAgIG9yaWdQcm92aWRlci4kZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIG9yaWdJbnN0YW5jZSA9IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKG9yaWckZ2V0LCBvcmlnUHJvdmlkZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGRlY29yRm4sIG51bGwsIHsgJGRlbGVnYXRlOiBvcmlnSW5zdGFuY2UgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBNb2R1bGUgTG9hZGluZwogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIGZ1bmN0aW9uIGxvYWRNb2R1bGVzKG1vZHVsZXNUb0xvYWQpIHsKICAgICAgICAgICAgdmFyIHJ1bkJsb2NrcyA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKG1vZHVsZXNUb0xvYWQsIGZ1bmN0aW9uIChtb2R1bGUpIHsKICAgICAgICAgICAgICAgIGlmIChsb2FkZWRNb2R1bGVzLmdldChtb2R1bGUpKSByZXR1cm47CiAgICAgICAgICAgICAgICBsb2FkZWRNb2R1bGVzLnB1dChtb2R1bGUsIHRydWUpOwoKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKG1vZHVsZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZHVsZUZuID0gYW5ndWxhck1vZHVsZShtb2R1bGUpOwogICAgICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MgPSBydW5CbG9ja3MuY29uY2F0KGxvYWRNb2R1bGVzKG1vZHVsZUZuLnJlcXVpcmVzKSkuY29uY2F0KG1vZHVsZUZuLl9ydW5CbG9ja3MpOwoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaW52b2tlUXVldWUgPSBtb2R1bGVGbi5faW52b2tlUXVldWUsIGkgPSAwLCBpaSA9IGludm9rZVF1ZXVlLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbnZva2VBcmdzID0gaW52b2tlUXVldWVbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChpbnZva2VBcmdzWzBdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcltpbnZva2VBcmdzWzFdXS5hcHBseShwcm92aWRlciwgaW52b2tlQXJnc1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24obW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MucHVzaChwcm92aWRlckluamVjdG9yLmludm9rZShtb2R1bGUpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkobW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBydW5CbG9ja3MucHVzaChwcm92aWRlckluamVjdG9yLmludm9rZShtb2R1bGUpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnRBcmdGbihtb2R1bGUsICdtb2R1bGUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkobW9kdWxlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGUgPSBtb2R1bGVbbW9kdWxlLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZS5tZXNzYWdlICYmIGUuc3RhY2sgJiYgZS5zdGFjay5pbmRleE9mKGUubWVzc2FnZSkgPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2FmYXJpICYgRkYncyBzdGFjayB0cmFjZXMgZG9uJ3QgY29udGFpbiBlcnJvci5tZXNzYWdlIGNvbnRlbnQgdW5saWtlIHRob3NlIG9mIENocm9tZSBhbmQgSUUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU28gaWYgc3RhY2sgZG9lc24ndCBjb250YWluIG1lc3NhZ2UsIHdlIGNyZWF0ZSBhIG5ldyBzdHJpbmcgdGhhdCBjb250YWlucyBib3RoLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTaW5jZSBlcnJvci5zdGFjayBpcyByZWFkLW9ubHkgaW4gU2FmYXJpLCBJJ20gb3ZlcnJpZGluZyBlIGFuZCBub3QgZS5zdGFjayBoZXJlLgogICAgICAgICAgICAgICAgICAgICAgICBlID0gZS5tZXNzYWdlICsgJ1xuJyArIGUuc3RhY2s7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignbW9kdWxlcnInLCAiRmFpbGVkIHRvIGluc3RhbnRpYXRlIG1vZHVsZSB7MH0gZHVlIHRvOlxuezF9IiwgbW9kdWxlLCBlLnN0YWNrIHx8IGUubWVzc2FnZSB8fCBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBydW5CbG9ja3M7CiAgICAgICAgfQoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBpbnRlcm5hbCBJbmplY3RvcgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGNhY2hlLCBmYWN0b3J5KSB7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRTZXJ2aWNlKHNlcnZpY2VOYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAoY2FjaGUuaGFzT3duUHJvcGVydHkoc2VydmljZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlW3NlcnZpY2VOYW1lXSA9PT0gSU5TVEFOVElBVElORykgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ2NkZXAnLCAnQ2lyY3VsYXIgZGVwZW5kZW5jeSBmb3VuZDogezB9JywgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXRoLnVuc2hpZnQoc2VydmljZU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjYWNoZVtzZXJ2aWNlTmFtZV0gPSBJTlNUQU5USUFUSU5HOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdID0gZmFjdG9yeShzZXJ2aWNlTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aC5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaW52b2tlKGZuLCBzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW10sCiAgICAgICAgICAgICAgICAgICAgJGluamVjdCA9IGFubm90YXRlKGZuKSwKICAgICAgICAgICAgICAgICAgICBsZW5ndGgsIGksCiAgICAgICAgICAgICAgICAgICAga2V5OwoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9ICRpbmplY3QubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSAkaW5qZWN0W2ldOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ2l0a24nLCAnSW5jb3JyZWN0IGluamVjdGlvbiB0b2tlbiEgRXhwZWN0ZWQgc2VydmljZSBuYW1lIGFzIHN0cmluZywgZ290IHswfScsIGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCgKICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5KQogICAgICAgICAgICAgICAgICAgICAgPyBsb2NhbHNba2V5XQogICAgICAgICAgICAgICAgICAgICAgOiBnZXRTZXJ2aWNlKGtleSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFmbi4kaW5qZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBtZWFucyB0aGF0IHdlIG11c3QgYmUgYW4gYXJyYXkuCiAgICAgICAgICAgICAgICAgICAgZm4gPSBmbltsZW5ndGhdOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvLyBQZXJmb3JtYW5jZSBvcHRpbWl6YXRpb246IGh0dHA6Ly9qc3BlcmYuY29tL2FwcGx5LXZzLWNhbGwtdnMtaW52b2tlCiAgICAgICAgICAgICAgICBzd2l0Y2ggKHNlbGYgPyAtMSA6IGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAwOiByZXR1cm4gZm4oKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiBmbihhcmdzWzBdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDI6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDM6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDU6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDY6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDc6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdLCBhcmdzWzZdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDg6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdLCBhcmdzWzZdLCBhcmdzWzddKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDk6IHJldHVybiBmbihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdLCBhcmdzWzVdLCBhcmdzWzZdLCBhcmdzWzddLCBhcmdzWzhdKTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDEwOiByZXR1cm4gZm4oYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSwgYXJnc1s1XSwgYXJnc1s2XSwgYXJnc1s3XSwgYXJnc1s4XSwgYXJnc1s5XSk7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZuLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBpbnN0YW50aWF0ZShUeXBlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHZhciBDb25zdHJ1Y3RvciA9IGZ1bmN0aW9uICgpIHsgfSwKICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZSwgcmV0dXJuZWRWYWx1ZTsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBUeXBlIGlzIGFubm90YXRlZCBhbmQgdXNlIGp1c3QgdGhlIGdpdmVuIGZ1bmN0aW9uIGF0IG4tMSBhcyBwYXJhbWV0ZXIKICAgICAgICAgICAgICAgIC8vIGUuZy4gc29tZU1vZHVsZS5mYWN0b3J5KCdncmVldGVyJywgWyckd2luZG93JywgZnVuY3Rpb24ocmVuYW1lZCR3aW5kb3cpIHt9XSk7CiAgICAgICAgICAgICAgICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAoaXNBcnJheShUeXBlKSA/IFR5cGVbVHlwZS5sZW5ndGggLSAxXSA6IFR5cGUpLnByb3RvdHlwZTsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gbmV3IENvbnN0cnVjdG9yKCk7CiAgICAgICAgICAgICAgICByZXR1cm5lZFZhbHVlID0gaW52b2tlKFR5cGUsIGluc3RhbmNlLCBsb2NhbHMpOwoKICAgICAgICAgICAgICAgIHJldHVybiBpc09iamVjdChyZXR1cm5lZFZhbHVlKSA/IHJldHVybmVkVmFsdWUgOiBpbnN0YW5jZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGludm9rZTogaW52b2tlLAogICAgICAgICAgICAgICAgaW5zdGFudGlhdGU6IGluc3RhbnRpYXRlLAogICAgICAgICAgICAgICAgZ2V0OiBnZXRTZXJ2aWNlLAogICAgICAgICAgICAgICAgYW5ub3RhdGU6IGFubm90YXRlLAogICAgICAgICAgICAgICAgaGFzOiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm92aWRlckNhY2hlLmhhc093blByb3BlcnR5KG5hbWUgKyBwcm92aWRlclN1ZmZpeCkgfHwgY2FjaGUuaGFzT3duUHJvcGVydHkobmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy4kYW5jaG9yU2Nyb2xsCiAgICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAgICogQHJlcXVpcmVzICRsb2NhdGlvbgogICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFdoZW4gY2FsbGVkLCBpdCBjaGVja3MgY3VycmVudCB2YWx1ZSBvZiBgJGxvY2F0aW9uLmhhc2goKWAgYW5kIHNjcm9sbCB0byByZWxhdGVkIGVsZW1lbnQsCiAgICAgKiBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAgICAgKiB7QGxpbmsgaHR0cDovL2Rldi53My5vcmcvaHRtbDUvc3BlYy9PdmVydmlldy5odG1sI3RoZS1pbmRpY2F0ZWQtcGFydC1vZi10aGUtZG9jdW1lbnQgSHRtbDUgc3BlY30uCiAgICAgKgogICAgICogSXQgYWxzbyB3YXRjaGVzIHRoZSBgJGxvY2F0aW9uLmhhc2goKWAgYW5kIHNjcm9sbCB3aGVuZXZlciBpdCBjaGFuZ2VzIHRvIG1hdGNoIGFueSBhbmNob3IuCiAgICAgKiBUaGlzIGNhbiBiZSBkaXNhYmxlZCBieSBjYWxsaW5nIGAkYW5jaG9yU2Nyb2xsUHJvdmlkZXIuZGlzYWJsZUF1dG9TY3JvbGxpbmcoKWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRBbmNob3JTY3JvbGxQcm92aWRlcigpIHsKCiAgICAgICAgdmFyIGF1dG9TY3JvbGxpbmdFbmFibGVkID0gdHJ1ZTsKCiAgICAgICAgdGhpcy5kaXNhYmxlQXV0b1Njcm9sbGluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgYXV0b1Njcm9sbGluZ0VuYWJsZWQgPSBmYWxzZTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGxvY2F0aW9uJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbiAoJHdpbmRvdywgJGxvY2F0aW9uLCAkcm9vdFNjb3BlKSB7CiAgICAgICAgICAgIHZhciBkb2N1bWVudCA9ICR3aW5kb3cuZG9jdW1lbnQ7CgogICAgICAgICAgICAvLyBoZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGZpcnN0IGFuY2hvciBmcm9tIGEgTm9kZUxpc3QKICAgICAgICAgICAgLy8gY2FuJ3QgdXNlIGZpbHRlci5maWx0ZXIsIGFzIGl0IGFjY2VwdHMgb25seSBpbnN0YW5jZXMgb2YgQXJyYXkKICAgICAgICAgICAgLy8gYW5kIElFIGNhbid0IGNvbnZlcnQgTm9kZUxpc3QgdG8gYW4gYXJyYXkgdXNpbmcgW10uc2xpY2UKICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHVzZSBmaWx0ZXIgaWYgd2UgY2hhbmdlIGl0IHRvIGFjY2VwdCBsaXN0cyBhcyB3ZWxsCiAgICAgICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0QW5jaG9yKGxpc3QpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgZm9yRWFjaChsaXN0LCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgIGlmICghcmVzdWx0ICYmIGxvd2VyY2FzZShlbGVtZW50Lm5vZGVOYW1lKSA9PT0gJ2EnKSByZXN1bHQgPSBlbGVtZW50OwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBzY3JvbGwoKSB7CiAgICAgICAgICAgICAgICB2YXIgaGFzaCA9ICRsb2NhdGlvbi5oYXNoKCksIGVsbTsKCiAgICAgICAgICAgICAgICAvLyBlbXB0eSBoYXNoLCBzY3JvbGwgdG8gdGhlIHRvcCBvZiB0aGUgcGFnZQogICAgICAgICAgICAgICAgaWYgKCFoYXNoKSAkd2luZG93LnNjcm9sbFRvKDAsIDApOwoKICAgICAgICAgICAgICAgICAgICAvLyBlbGVtZW50IHdpdGggZ2l2ZW4gaWQKICAgICAgICAgICAgICAgIGVsc2UgaWYgKChlbG0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChoYXNoKSkpIGVsbS5zY3JvbGxJbnRvVmlldygpOwoKICAgICAgICAgICAgICAgICAgICAvLyBmaXJzdCBhbmNob3Igd2l0aCBnaXZlbiBuYW1lIDotRAogICAgICAgICAgICAgICAgZWxzZSBpZiAoKGVsbSA9IGdldEZpcnN0QW5jaG9yKGRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lKGhhc2gpKSkpIGVsbS5zY3JvbGxJbnRvVmlldygpOwoKICAgICAgICAgICAgICAgICAgICAvLyBubyBlbGVtZW50IGFuZCBoYXNoID09ICd0b3AnLCBzY3JvbGwgdG8gdGhlIHRvcCBvZiB0aGUgcGFnZQogICAgICAgICAgICAgICAgZWxzZSBpZiAoaGFzaCA9PT0gJ3RvcCcpICR3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGRvZXMgbm90IHNjcm9sbCB3aGVuIHVzZXIgY2xpY2tzIG9uIGFuY2hvciBsaW5rIHRoYXQgaXMgY3VycmVudGx5IG9uCiAgICAgICAgICAgIC8vIChubyB1cmwgY2hhbmdlLCBubyAkbG9jYXRpb24uaGFzaCgpIGNoYW5nZSksIGJyb3dzZXIgbmF0aXZlIGRvZXMgc2Nyb2xsCiAgICAgICAgICAgIGlmIChhdXRvU2Nyb2xsaW5nRW5hYmxlZCkgewogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kd2F0Y2goZnVuY3Rpb24gYXV0b1Njcm9sbFdhdGNoKCkgeyByZXR1cm4gJGxvY2F0aW9uLmhhc2goKTsgfSwKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gYXV0b1Njcm9sbFdhdGNoQWN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKHNjcm9sbCk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gc2Nyb2xsOwogICAgICAgIH1dOwogICAgfQoKICAgIHZhciAkYW5pbWF0ZU1pbkVyciA9IG1pbkVycignJGFuaW1hdGUnKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRhbmltYXRlUHJvdmlkZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgJGFuaW1hdGUgdGhhdCBkb2Vzbid0IHBlcmZvcm0gYW55IGFuaW1hdGlvbnMsIGluc3RlYWQganVzdCBzeW5jaHJvbm91c2x5IHBlcmZvcm1zIERPTQogICAgICogdXBkYXRlcyBhbmQgY2FsbHMgZG9uZSgpIGNhbGxiYWNrcy4KICAgICAqCiAgICAgKiBJbiBvcmRlciB0byBlbmFibGUgYW5pbWF0aW9ucyB0aGUgbmdBbmltYXRlIG1vZHVsZSBoYXMgdG8gYmUgbG9hZGVkLgogICAgICoKICAgICAqIFRvIHNlZSB0aGUgZnVuY3Rpb25hbCBpbXBsZW1lbnRhdGlvbiBjaGVjayBvdXQgc3JjL25nQW5pbWF0ZS9hbmltYXRlLmpzCiAgICAgKi8KICAgIHZhciAkQW5pbWF0ZVByb3ZpZGVyID0gWyckcHJvdmlkZScsIGZ1bmN0aW9uICgkcHJvdmlkZSkgewoKICAgICAgICB0aGlzLiQkc2VsZWN0b3JzID0ge307CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kYW5pbWF0ZVByb3ZpZGVyI3JlZ2lzdGVyCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRhbmltYXRlUHJvdmlkZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlZ2lzdGVycyBhIG5ldyBpbmplY3RhYmxlIGFuaW1hdGlvbiBmYWN0b3J5IGZ1bmN0aW9uLiBUaGUgZmFjdG9yeSBmdW5jdGlvbiBwcm9kdWNlcyB0aGUgYW5pbWF0aW9uIG9iamVjdCB3aGljaAogICAgICAgICAqIGNvbnRhaW5zIGNhbGxiYWNrIGZ1bmN0aW9ucyBmb3IgZWFjaCBldmVudCB0aGF0IGlzIGV4cGVjdGVkIHRvIGJlIGFuaW1hdGVkLgogICAgICAgICAqCiAgICAgICAgICogICAqIGBldmVudEZuYDogYGZ1bmN0aW9uKEVsZW1lbnQsIGRvbmVGdW5jdGlvbilgIFRoZSBlbGVtZW50IHRvIGFuaW1hdGUsIHRoZSBgZG9uZUZ1bmN0aW9uYCBtdXN0IGJlIGNhbGxlZCBvbmNlIHRoZQogICAgICAgICAqICAgZWxlbWVudCBhbmltYXRpb24gaXMgY29tcGxldGUuIElmIGEgZnVuY3Rpb24gaXMgcmV0dXJuZWQgdGhlbiB0aGUgYW5pbWF0aW9uIHNlcnZpY2Ugd2lsbCB1c2UgdGhpcyBmdW5jdGlvbiB0bwogICAgICAgICAqICAgY2FuY2VsIHRoZSBhbmltYXRpb24gd2hlbmV2ZXIgYSBjYW5jZWwgZXZlbnQgaXMgdHJpZ2dlcmVkLgogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKjxwcmU+CiAgICAgICAgICogICByZXR1cm4gewogICAgICAgICAgICogICAgIGV2ZW50Rm4gOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7CiAgICAgICAgICAgKiAgICAgICAvL2NvZGUgdG8gcnVuIHRoZSBhbmltYXRpb24KICAgICAgICAgICAqICAgICAgIC8vb25jZSBjb21wbGV0ZSwgdGhlbiBydW4gZG9uZSgpCiAgICAgICAgICAgKiAgICAgICByZXR1cm4gZnVuY3Rpb24gY2FuY2VsbGF0aW9uRnVuY3Rpb24oKSB7CiAgICAgICAgICAgKiAgICAgICAgIC8vY29kZSB0byBjYW5jZWwgdGhlIGFuaW1hdGlvbgogICAgICAgICAgICogICAgICAgfQogICAgICAgICAgICogICAgIH0KICAgICAgICAgICAqICAgfQogICAgICAgICAqPC9wcmU+CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgYW5pbWF0aW9uLgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGZhY3RvcnkgVGhlIGZhY3RvcnkgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIHRvIHJldHVybiB0aGUgYW5pbWF0aW9uIG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnJlZ2lzdGVyID0gZnVuY3Rpb24gKG5hbWUsIGZhY3RvcnkpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG5hbWUgKyAnLWFuaW1hdGlvbic7CiAgICAgICAgICAgIGlmIChuYW1lICYmIG5hbWUuY2hhckF0KDApICE9ICcuJykgdGhyb3cgJGFuaW1hdGVNaW5FcnIoJ25vdGNzZWwnLAogICAgICAgICAgICAgICAgIkV4cGVjdGluZyBjbGFzcyBzZWxlY3RvciBzdGFydGluZyB3aXRoICcuJyBnb3QgJ3swfScuIiwgbmFtZSk7CiAgICAgICAgICAgIHRoaXMuJCRzZWxlY3RvcnNbbmFtZS5zdWJzdHIoMSldID0ga2V5OwogICAgICAgICAgICAkcHJvdmlkZS5mYWN0b3J5KGtleSwgZmFjdG9yeSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckdGltZW91dCcsIGZ1bmN0aW9uICgkdGltZW91dCkgewoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAgICAgICAgICogQG5hbWUgbmcuJGFuaW1hdGUKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFRoZSAkYW5pbWF0ZSBzZXJ2aWNlIHByb3ZpZGVzIHJ1ZGltZW50YXJ5IERPTSBtYW5pcHVsYXRpb24gZnVuY3Rpb25zIHRvIGluc2VydCwgcmVtb3ZlLCBtb3ZlIGVsZW1lbnRzIHdpdGhpbgogICAgICAgICAgICAgKiB0aGUgRE9NIGFzIHdlbGwgYXMgYWRkaW5nIGFuZCByZW1vdmluZyBjbGFzc2VzLiBUaGlzIHNlcnZpY2UgaXMgdGhlIGNvcmUgc2VydmljZSB1c2VkIGJ5IHRoZSBuZ0FuaW1hdGUgJGFuaW1hdG9yCiAgICAgICAgICAgICAqIHNlcnZpY2Ugd2hpY2ggcHJvdmlkZXMgaGlnaC1sZXZlbCBhbmltYXRpb24gaG9va3MgZm9yIENTUyBhbmQgSmF2YVNjcmlwdC4gCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICRhbmltYXRlIGlzIGF2YWlsYWJsZSBpbiB0aGUgQW5ndWxhckpTIGNvcmUsIGhvd2V2ZXIsIHRoZSBuZ0FuaW1hdGUgbW9kdWxlIG11c3QgYmUgaW5jbHVkZWQgdG8gZW5hYmxlIGZ1bGwgb3V0CiAgICAgICAgICAgICAqIGFuaW1hdGlvbiBzdXBwb3J0LiBPdGhlcndpc2UsICRhbmltYXRlIHdpbGwgb25seSBwZXJmb3JtIHNpbXBsZSBET00gbWFuaXB1bGF0aW9uIG9wZXJhdGlvbnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRvIGxlYXJuIG1vcmUgYWJvdXQgZW5hYmxpbmcgYW5pbWF0aW9uIHN1cHBvcnQsIGNsaWNrIGhlcmUgdG8gdmlzaXQgdGhlIHtAbGluayBuZ0FuaW1hdGUgbmdBbmltYXRlIG1vZHVsZSBwYWdlfQogICAgICAgICAgICAgKiBhcyB3ZWxsIGFzIHRoZSB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlIG5nQW5pbWF0ZSAkYW5pbWF0ZSBzZXJ2aWNlIHBhZ2V9LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcmV0dXJuIHsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGFuaW1hdGUjZW50ZXIKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kYW5pbWF0ZQogICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBJbnNlcnRzIHRoZSBlbGVtZW50IGludG8gdGhlIERPTSBlaXRoZXIgYWZ0ZXIgdGhlIGBhZnRlcmAgZWxlbWVudCBvciB3aXRoaW4gdGhlIGBwYXJlbnRgIGVsZW1lbnQuIE9uY2UgY29tcGxldGUsCiAgICAgICAgICAgICAgICAgKiB0aGUgZG9uZSgpIGNhbGxiYWNrIHdpbGwgYmUgZmlyZWQgKGlmIHByb3ZpZGVkKS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2pRdWVyeS9qcUxpdGUgZWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGJlIGluc2VydGVkIGludG8gdGhlIERPTQogICAgICAgICAgICAgICAgICogQHBhcmFtIHtqUXVlcnkvanFMaXRlIGVsZW1lbnR9IHBhcmVudCB0aGUgcGFyZW50IGVsZW1lbnQgd2hpY2ggd2lsbCBhcHBlbmQgdGhlIGVsZW1lbnQgYXMgYSBjaGlsZCAoaWYgdGhlIGFmdGVyIGVsZW1lbnQgaXMgbm90IHByZXNlbnQpCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2pRdWVyeS9qcUxpdGUgZWxlbWVudH0gYWZ0ZXIgdGhlIHNpYmxpbmcgZWxlbWVudCB3aGljaCB3aWxsIGFwcGVuZCB0aGUgZWxlbWVudCBhZnRlciBpdHNlbGYKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb249fSBkb25lIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgdGhlIGVsZW1lbnQgaGFzIGJlZW4gaW5zZXJ0ZWQgaW50byB0aGUgRE9NCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbiAoZWxlbWVudCwgcGFyZW50LCBhZnRlciwgZG9uZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBhZnRlck5vZGUgPSBhZnRlciAmJiBhZnRlclthZnRlci5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHBhcmVudCAmJiBwYXJlbnRbMF0gfHwgYWZ0ZXJOb2RlICYmIGFmdGVyTm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIC8vIElFIGRvZXMgbm90IGxpa2UgdW5kZWZpbmVkIHNvIHdlIGhhdmUgdG8gcGFzcyBudWxsLgogICAgICAgICAgICAgICAgICAgIHZhciBhZnRlck5leHRTaWJsaW5nID0gKGFmdGVyTm9kZSAmJiBhZnRlck5vZGUubmV4dFNpYmxpbmcpIHx8IG51bGw7CiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LCBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnROb2RlLmluc2VydEJlZm9yZShub2RlLCBhZnRlck5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBkb25lICYmICR0aW1lb3V0KGRvbmUsIDAsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRhbmltYXRlI2xlYXZlCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGFuaW1hdGUKICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogUmVtb3ZlcyB0aGUgZWxlbWVudCBmcm9tIHRoZSBET00uIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7alF1ZXJ5L2pxTGl0ZSBlbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBET00KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb249fSBkb25lIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgdGhlIGVsZW1lbnQgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tIHRoZSBET00KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uIChlbGVtZW50LCBkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICBkb25lICYmICR0aW1lb3V0KGRvbmUsIDAsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRhbmltYXRlI21vdmUKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kYW5pbWF0ZQogICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBNb3ZlcyB0aGUgcG9zaXRpb24gb2YgdGhlIHByb3ZpZGVkIGVsZW1lbnQgd2l0aGluIHRoZSBET00gdG8gYmUgcGxhY2VkIGVpdGhlciBhZnRlciB0aGUgYGFmdGVyYCBlbGVtZW50IG9yIGluc2lkZSBvZiB0aGUgYHBhcmVudGAgZWxlbWVudC4KICAgICAgICAgICAgICAgICAqIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7alF1ZXJ5L2pxTGl0ZSBlbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgYmUgbW92ZWQgYXJvdW5kIHdpdGhpbiB0aGUgRE9NCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2pRdWVyeS9qcUxpdGUgZWxlbWVudH0gcGFyZW50IHRoZSBwYXJlbnQgZWxlbWVudCB3aGVyZSB0aGUgZWxlbWVudCB3aWxsIGJlIGluc2VydGVkIGludG8gKGlmIHRoZSBhZnRlciBlbGVtZW50IGlzIG5vdCBwcmVzZW50KQogICAgICAgICAgICAgICAgICogQHBhcmFtIHtqUXVlcnkvanFMaXRlIGVsZW1lbnR9IGFmdGVyIHRoZSBzaWJsaW5nIGVsZW1lbnQgd2hlcmUgdGhlIGVsZW1lbnQgd2lsbCBiZSBwb3NpdGlvbmVkIG5leHQgdG8KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb249fSBkb25lIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAoaWYgcHJvdmlkZWQpIHRoYXQgd2lsbCBiZSBmaXJlZCBhZnRlciB0aGUgZWxlbWVudCBoYXMgYmVlbiBtb3ZlZCB0byBpdCdzIG5ldyBwb3NpdGlvbgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBtb3ZlOiBmdW5jdGlvbiAoZWxlbWVudCwgcGFyZW50LCBhZnRlciwgZG9uZSkgewogICAgICAgICAgICAgICAgICAgIC8vIERvIG5vdCByZW1vdmUgZWxlbWVudCBiZWZvcmUgaW5zZXJ0LiBSZW1vdmluZyB3aWxsIGNhdXNlIGRhdGEgYXNzb2NpYXRlZCB3aXRoIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGVsZW1lbnQgdG8gYmUgZHJvcHBlZC4gSW5zZXJ0IHdpbGwgaW1wbGljaXRseSBkbyB0aGUgcmVtb3ZlLgogICAgICAgICAgICAgICAgICAgIHRoaXMuZW50ZXIoZWxlbWVudCwgcGFyZW50LCBhZnRlciwgZG9uZSk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kYW5pbWF0ZSNhZGRDbGFzcwogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRhbmltYXRlCiAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIEFkZHMgdGhlIHByb3ZpZGVkIGNsYXNzTmFtZSBDU1MgY2xhc3MgdmFsdWUgdG8gdGhlIHByb3ZpZGVkIGVsZW1lbnQuIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7alF1ZXJ5L2pxTGl0ZSBlbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgaGF2ZSB0aGUgY2xhc3NOYW1lIHZhbHVlIGFkZGVkIHRvIGl0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbj19IGRvbmUgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBwcm92aWRlZCkgdGhhdCB3aWxsIGJlIGZpcmVkIGFmdGVyIHRoZSBjbGFzc05hbWUgdmFsdWUgaGFzIGJlZW4gYWRkZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgYWRkQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBjbGFzc05hbWUsIGRvbmUpIHsKICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSBpc1N0cmluZyhjbGFzc05hbWUpID8KICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzQXJyYXkoY2xhc3NOYW1lKSA/IGNsYXNzTmFtZS5qb2luKCcgJykgOiAnJzsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgZG9uZSAmJiAkdGltZW91dChkb25lLCAwLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kYW5pbWF0ZSNyZW1vdmVDbGFzcwogICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRhbmltYXRlCiAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFJlbW92ZXMgdGhlIHByb3ZpZGVkIGNsYXNzTmFtZSBDU1MgY2xhc3MgdmFsdWUgZnJvbSB0aGUgcHJvdmlkZWQgZWxlbWVudC4gT25jZSBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtqUXVlcnkvanFMaXRlIGVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBoYXZlIHRoZSBjbGFzc05hbWUgdmFsdWUgcmVtb3ZlZCBmcm9tIGl0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb249fSBkb25lIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAoaWYgcHJvdmlkZWQpIHRoYXQgd2lsbCBiZSBmaXJlZCBhZnRlciB0aGUgY2xhc3NOYW1lIHZhbHVlIGhhcyBiZWVuIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICByZW1vdmVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgewogICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9IGlzU3RyaW5nKGNsYXNzTmFtZSkgPwogICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWUgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNBcnJheShjbGFzc05hbWUpID8gY2xhc3NOYW1lLmpvaW4oJyAnKSA6ICcnOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgICBkb25lICYmICR0aW1lb3V0KGRvbmUsIDAsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgZW5hYmxlZDogbm9vcAogICAgICAgICAgICB9OwogICAgICAgIH1dOwogICAgfV07CgogICAgLyoqCiAgICAgKiAhIFRoaXMgaXMgYSBwcml2YXRlIHVuZG9jdW1lbnRlZCBzZXJ2aWNlICEKICAgICAqCiAgICAgKiBAbmFtZSBuZy4kYnJvd3NlcgogICAgICogQHJlcXVpcmVzICRsb2cKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhpcyBvYmplY3QgaGFzIHR3byBnb2FsczoKICAgICAqCiAgICAgKiAtIGhpZGUgYWxsIHRoZSBnbG9iYWwgc3RhdGUgaW4gdGhlIGJyb3dzZXIgY2F1c2VkIGJ5IHRoZSB3aW5kb3cgb2JqZWN0CiAgICAgKiAtIGFic3RyYWN0IGF3YXkgYWxsIHRoZSBicm93c2VyIHNwZWNpZmljIGZlYXR1cmVzIGFuZCBpbmNvbnNpc3RlbmNpZXMKICAgICAqCiAgICAgKiBGb3IgdGVzdHMgd2UgcHJvdmlkZSB7QGxpbmsgbmdNb2NrLiRicm93c2VyIG1vY2sgaW1wbGVtZW50YXRpb259IG9mIHRoZSBgJGJyb3dzZXJgCiAgICAgKiBzZXJ2aWNlLCB3aGljaCBjYW4gYmUgdXNlZCBmb3IgY29udmVuaWVudCB0ZXN0aW5nIG9mIHRoZSBhcHBsaWNhdGlvbiB3aXRob3V0IHRoZSBpbnRlcmFjdGlvbiB3aXRoCiAgICAgKiB0aGUgcmVhbCBicm93c2VyIGFwaXMuCiAgICAgKi8KICAgIC8qKgogICAgICogQHBhcmFtIHtvYmplY3R9IHdpbmRvdyBUaGUgZ2xvYmFsIHdpbmRvdyBvYmplY3QuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZG9jdW1lbnQgalF1ZXJ5IHdyYXBwZWQgZG9jdW1lbnQuCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IFhIUiBYTUxIdHRwUmVxdWVzdCBjb25zdHJ1Y3Rvci4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSAkbG9nIGNvbnNvbGUubG9nIG9yIGFuIG9iamVjdCB3aXRoIHRoZSBzYW1lIGludGVyZmFjZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSAkc25pZmZlciAkc25pZmZlciBzZXJ2aWNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIEJyb3dzZXIod2luZG93LCBkb2N1bWVudCwgJGxvZywgJHNuaWZmZXIpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgICAgIHJhd0RvY3VtZW50ID0gZG9jdW1lbnRbMF0sCiAgICAgICAgICAgIGxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uLAogICAgICAgICAgICBoaXN0b3J5ID0gd2luZG93Lmhpc3RvcnksCiAgICAgICAgICAgIHNldFRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCwKICAgICAgICAgICAgY2xlYXJUaW1lb3V0ID0gd2luZG93LmNsZWFyVGltZW91dCwKICAgICAgICAgICAgcGVuZGluZ0RlZmVySWRzID0ge307CgogICAgICAgIHNlbGYuaXNNb2NrID0gZmFsc2U7CgogICAgICAgIHZhciBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9IDA7CiAgICAgICAgdmFyIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcyA9IFtdOwoKICAgICAgICAvLyBUT0RPKHZvanRhKTogcmVtb3ZlIHRoaXMgdGVtcG9yYXJ5IGFwaQogICAgICAgIHNlbGYuJCRjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdCA9IGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0OwogICAgICAgIHNlbGYuJCRpbmNPdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9IGZ1bmN0aW9uICgpIHsgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogRXhlY3V0ZXMgdGhlIGBmbmAgZnVuY3Rpb24oc3VwcG9ydHMgY3VycnlpbmcpIGFuZCBkZWNyZW1lbnRzIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYAogICAgICAgICAqIGNvdW50ZXIuIElmIHRoZSBjb3VudGVyIHJlYWNoZXMgMCwgYWxsIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYCBhcmUgZXhlY3V0ZWQuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZuLmFwcGx5KG51bGwsIHNsaWNlQXJncyhhcmd1bWVudHMsIDEpKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50LS07CiAgICAgICAgICAgICAgICBpZiAob3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAob3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzLnBvcCgpKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsb2cuZXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogTm90ZTogdGhpcyBtZXRob2QgaXMgdXNlZCBvbmx5IGJ5IHNjZW5hcmlvIHJ1bm5lcgogICAgICAgICAqIFRPRE8odm9qdGEpOiBwcmVmaXggdGhpcyBtZXRob2Qgd2l0aCAkJCA/CiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBjYWxsYmFjayBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gbm8gb3V0c3RhbmRpbmcgcmVxdWVzdAogICAgICAgICAqLwogICAgICAgIHNlbGYubm90aWZ5V2hlbk5vT3V0c3RhbmRpbmdSZXF1ZXN0cyA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAvLyBmb3JjZSBicm93c2VyIHRvIGV4ZWN1dGUgYWxsIHBvbGxGbnMgLSB0aGlzIGlzIG5lZWRlZCBzbyB0aGF0IGNvb2tpZXMgYW5kIG90aGVyIHBvbGxlcnMgZmlyZQogICAgICAgICAgICAvLyBhdCBzb21lIGRldGVybWluaXN0aWMgdGltZSBpbiByZXNwZWN0IHRvIHRoZSB0ZXN0IHJ1bm5lcidzIGFjdGlvbnMuIExlYXZpbmcgdGhpbmdzIHVwIHRvIHRoZQogICAgICAgICAgICAvLyByZWd1bGFyIHBvbGxlciB3b3VsZCByZXN1bHQgaW4gZmxha3kgdGVzdHMuCiAgICAgICAgICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24gKHBvbGxGbikgeyBwb2xsRm4oKTsgfSk7CgogICAgICAgICAgICBpZiAob3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIC8vIFBvbGwgV2F0Y2hlciBBUEkKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIHZhciBwb2xsRm5zID0gW10sCiAgICAgICAgICAgIHBvbGxUaW1lb3V0OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNhZGRQb2xsRm4KICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gUG9sbCBmdW5jdGlvbiB0byBhZGQKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEFkZHMgYSBmdW5jdGlvbiB0byB0aGUgbGlzdCBvZiBmdW5jdGlvbnMgdGhhdCBwb2xsZXIgcGVyaW9kaWNhbGx5IGV4ZWN1dGVzLAogICAgICAgICAqIGFuZCBzdGFydHMgcG9sbGluZyBpZiBub3Qgc3RhcnRlZCB5ZXQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gdGhlIGFkZGVkIGZ1bmN0aW9uCiAgICAgICAgICovCiAgICAgICAgc2VsZi5hZGRQb2xsRm4gPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHBvbGxUaW1lb3V0KSkgc3RhcnRQb2xsZXIoMTAwLCBzZXRUaW1lb3V0KTsKICAgICAgICAgICAgcG9sbEZucy5wdXNoKGZuKTsKICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbnRlcnZhbCBIb3cgb2Z0ZW4gc2hvdWxkIGJyb3dzZXIgY2FsbCBwb2xsIGZ1bmN0aW9ucyAobXMpCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBzZXRUaW1lb3V0IFJlZmVyZW5jZSB0byBhIHJlYWwgb3IgZmFrZSBgc2V0VGltZW91dGAgZnVuY3Rpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDb25maWd1cmVzIHRoZSBwb2xsZXIgdG8gcnVuIGluIHRoZSBzcGVjaWZpZWQgaW50ZXJ2YWxzLCB1c2luZyB0aGUgc3BlY2lmaWVkCiAgICAgICAgICogc2V0VGltZW91dCBmbiBhbmQga2lja3MgaXQgb2ZmLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UG9sbGVyKGludGVydmFsLCBzZXRUaW1lb3V0KSB7CiAgICAgICAgICAgIChmdW5jdGlvbiBjaGVjaygpIHsKICAgICAgICAgICAgICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24gKHBvbGxGbikgeyBwb2xsRm4oKTsgfSk7CiAgICAgICAgICAgICAgICBwb2xsVGltZW91dCA9IHNldFRpbWVvdXQoY2hlY2ssIGludGVydmFsKTsKICAgICAgICAgICAgfSkoKTsKICAgICAgICB9CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gVVJMIEFQSQogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIHZhciBsYXN0QnJvd3NlclVybCA9IGxvY2F0aW9uLmhyZWYsCiAgICAgICAgICAgIGJhc2VFbGVtZW50ID0gZG9jdW1lbnQuZmluZCgnYmFzZScpLAogICAgICAgICAgICByZXBsYWNlZFVybCA9IG51bGw7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI3VybAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogR0VUVEVSOgogICAgICAgICAqIFdpdGhvdXQgYW55IGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBqdXN0IHJldHVybnMgY3VycmVudCB2YWx1ZSBvZiBsb2NhdGlvbi5ocmVmLgogICAgICAgICAqCiAgICAgICAgICogU0VUVEVSOgogICAgICAgICAqIFdpdGggYXQgbGVhc3Qgb25lIGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBzZXRzIHVybCB0byBuZXcgdmFsdWUuCiAgICAgICAgICogSWYgaHRtbDUgaGlzdG9yeSBhcGkgc3VwcG9ydGVkLCBwdXNoU3RhdGUvcmVwbGFjZVN0YXRlIGlzIHVzZWQsIG90aGVyd2lzZQogICAgICAgICAqIGxvY2F0aW9uLmhyZWYvbG9jYXRpb24ucmVwbGFjZSBpcyB1c2VkLgogICAgICAgICAqIFJldHVybnMgaXRzIG93biBpbnN0YW5jZSB0byBhbGxvdyBjaGFpbmluZwogICAgICAgICAqCiAgICAgICAgICogTk9URTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgICAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBjaGFuZ2UgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBOZXcgdXJsICh3aGVuIHVzZWQgYXMgc2V0dGVyKQogICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHJlcGxhY2UgU2hvdWxkIG5ldyB1cmwgcmVwbGFjZSBjdXJyZW50IGhpc3RvcnkgcmVjb3JkID8KICAgICAgICAgKi8KICAgICAgICBzZWxmLnVybCA9IGZ1bmN0aW9uICh1cmwsIHJlcGxhY2UpIHsKICAgICAgICAgICAgLy8gc2V0dGVyCiAgICAgICAgICAgIGlmICh1cmwpIHsKICAgICAgICAgICAgICAgIGlmIChsYXN0QnJvd3NlclVybCA9PSB1cmwpIHJldHVybjsKICAgICAgICAgICAgICAgIGxhc3RCcm93c2VyVXJsID0gdXJsOwogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhpc3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVwbGFjZSkgaGlzdG9yeS5yZXBsYWNlU3RhdGUobnVsbCwgJycsIHVybCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhpc3RvcnkucHVzaFN0YXRlKG51bGwsICcnLCB1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBDcmF6eSBPcGVyYSBCdWc6IGh0dHA6Ly9teS5vcGVyYS5jb20vY29tbXVuaXR5L2ZvcnVtcy90b3BpYy5kbWw/aWQ9MTE4NTQ2MgogICAgICAgICAgICAgICAgICAgICAgICBiYXNlRWxlbWVudC5hdHRyKCdocmVmJywgYmFzZUVsZW1lbnQuYXR0cignaHJlZicpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLnJlcGxhY2UodXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZWRVcmwgPSB1cmw7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb24uaHJlZiA9IHVybDsKICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZWRVcmwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgICAgICAgICAgLy8gZ2V0dGVyCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAtIHRoZSByZXBsYWNlZFVybCBpcyBhIHdvcmthcm91bmQgZm9yIGFuIElFOC05IGlzc3VlIHdpdGggbG9jYXRpb24ucmVwbGFjZSBtZXRob2QgdGhhdCBkb2Vzbid0IHVwZGF0ZQogICAgICAgICAgICAgICAgLy8gICBsb2NhdGlvbi5ocmVmIHN5bmNocm9ub3VzbHkKICAgICAgICAgICAgICAgIC8vIC0gdGhlIHJlcGxhY2VtZW50IGlzIGEgd29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NDA3MTcyCiAgICAgICAgICAgICAgICByZXR1cm4gcmVwbGFjZWRVcmwgfHwgbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8lMjcvZywgIiciKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciB1cmxDaGFuZ2VMaXN0ZW5lcnMgPSBbXSwKICAgICAgICAgICAgdXJsQ2hhbmdlSW5pdCA9IGZhbHNlOwoKICAgICAgICBmdW5jdGlvbiBmaXJlVXJsQ2hhbmdlKCkgewogICAgICAgICAgICBpZiAobGFzdEJyb3dzZXJVcmwgPT0gc2VsZi51cmwoKSkgcmV0dXJuOwoKICAgICAgICAgICAgbGFzdEJyb3dzZXJVcmwgPSBzZWxmLnVybCgpOwogICAgICAgICAgICBmb3JFYWNoKHVybENoYW5nZUxpc3RlbmVycywgZnVuY3Rpb24gKGxpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5lcihzZWxmLnVybCgpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNvblVybENoYW5nZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqIEBUT0RPKHZvanRhKTogcmVmYWN0b3IgdG8gdXNlIG5vZGUncyBzeW50YXggZm9yIGV2ZW50cwogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogUmVnaXN0ZXIgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCwgd2hlbiB1cmwgY2hhbmdlcy4KICAgICAgICAgKgogICAgICAgICAqIEl0J3Mgb25seSBjYWxsZWQgd2hlbiB0aGUgdXJsIGlzIGNoYW5nZWQgYnkgb3V0c2lkZSBvZiBhbmd1bGFyOgogICAgICAgICAqIC0gdXNlciB0eXBlcyBkaWZmZXJlbnQgdXJsIGludG8gYWRkcmVzcyBiYXIKICAgICAgICAgKiAtIHVzZXIgY2xpY2tzIG9uIGhpc3RvcnkgKGZvcndhcmQvYmFjaykgYnV0dG9uCiAgICAgICAgICogLSB1c2VyIGNsaWNrcyBvbiBhIGxpbmsKICAgICAgICAgKgogICAgICAgICAqIEl0J3Mgbm90IGNhbGxlZCB3aGVuIHVybCBpcyBjaGFuZ2VkIGJ5ICRicm93c2VyLnVybCgpIG1ldGhvZAogICAgICAgICAqCiAgICAgICAgICogVGhlIGxpc3RlbmVyIGdldHMgY2FsbGVkIHdpdGggbmV3IHVybCBhcyBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBOT1RFOiB0aGlzIGFwaSBpcyBpbnRlbmRlZCBmb3IgdXNlIG9ubHkgYnkgdGhlICRsb2NhdGlvbiBzZXJ2aWNlLiBQbGVhc2UgdXNlIHRoZQogICAgICAgICAqIHtAbGluayBuZy4kbG9jYXRpb24gJGxvY2F0aW9uIHNlcnZpY2V9IHRvIG1vbml0b3IgdXJsIGNoYW5nZXMgaW4gYW5ndWxhciBhcHBzLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihzdHJpbmcpfSBsaXN0ZW5lciBMaXN0ZW5lciBmdW5jdGlvbiB0byBiZSBjYWxsZWQgd2hlbiB1cmwgY2hhbmdlcy4KICAgICAgICAgKiBAcmV0dXJuIHtmdW5jdGlvbihzdHJpbmcpfSBSZXR1cm5zIHRoZSByZWdpc3RlcmVkIGxpc3RlbmVyIGZuIC0gaGFuZHkgaWYgdGhlIGZuIGlzIGFub255bW91cy4KICAgICAgICAgKi8KICAgICAgICBzZWxmLm9uVXJsQ2hhbmdlID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmICghdXJsQ2hhbmdlSW5pdCkgewogICAgICAgICAgICAgICAgLy8gV2UgbGlzdGVuIG9uIGJvdGggKGhhc2hjaGFuZ2UvcG9wc3RhdGUpIHdoZW4gYXZhaWxhYmxlLCBhcyBzb21lIGJyb3dzZXJzIChlLmcuIE9wZXJhKQogICAgICAgICAgICAgICAgLy8gZG9uJ3QgZmlyZSBwb3BzdGF0ZSB3aGVuIHVzZXIgY2hhbmdlIHRoZSBhZGRyZXNzIGJhciBhbmQgZG9uJ3QgZmlyZSBoYXNoY2hhbmdlIHdoZW4gdXJsCiAgICAgICAgICAgICAgICAvLyBjaGFuZ2VkIGJ5IHB1c2gvcmVwbGFjZVN0YXRlCgogICAgICAgICAgICAgICAgLy8gaHRtbDUgaGlzdG9yeSBhcGkgLSBwb3BzdGF0ZSBldmVudAogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhpc3RvcnkpIGpxTGl0ZSh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIGZpcmVVcmxDaGFuZ2UpOwogICAgICAgICAgICAgICAgLy8gaGFzaGNoYW5nZSBldmVudAogICAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhhc2hjaGFuZ2UpIGpxTGl0ZSh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgZmlyZVVybENoYW5nZSk7CiAgICAgICAgICAgICAgICAgICAgLy8gcG9sbGluZwogICAgICAgICAgICAgICAgZWxzZSBzZWxmLmFkZFBvbGxGbihmaXJlVXJsQ2hhbmdlKTsKCiAgICAgICAgICAgICAgICB1cmxDaGFuZ2VJbml0ID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdXJsQ2hhbmdlTGlzdGVuZXJzLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICAgICAgfTsKCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICAvLyBNaXNjIEFQSQogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgY3VycmVudCA8YmFzZSBocmVmPgogICAgICAgICAqIChhbHdheXMgcmVsYXRpdmUgLSB3aXRob3V0IGRvbWFpbikKICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmc9fQogICAgICAgICAqLwogICAgICAgIHNlbGYuYmFzZUhyZWYgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBocmVmID0gYmFzZUVsZW1lbnQuYXR0cignaHJlZicpOwogICAgICAgICAgICByZXR1cm4gaHJlZiA/IGhyZWYucmVwbGFjZSgvXmh0dHBzP1w6XC9cL1teXC9dKi8sICcnKSA6ICcnOwogICAgICAgIH07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAgICAgLy8gQ29va2llcyBBUEkKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgICAgIHZhciBsYXN0Q29va2llcyA9IHt9OwogICAgICAgIHZhciBsYXN0Q29va2llU3RyaW5nID0gJyc7CiAgICAgICAgdmFyIGNvb2tpZVBhdGggPSBzZWxmLmJhc2VIcmVmKCk7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuYW1lIG5nLiRicm93c2VyI2Nvb2tpZXMKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGJyb3dzZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBDb29raWUgbmFtZQogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgQ29va2llIHZhbHVlCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGUgY29va2llcyBtZXRob2QgcHJvdmlkZXMgYSAncHJpdmF0ZScgbG93IGxldmVsIGFjY2VzcyB0byBicm93c2VyIGNvb2tpZXMuCiAgICAgICAgICogSXQgaXMgbm90IG1lYW50IHRvIGJlIHVzZWQgZGlyZWN0bHksIHVzZSB0aGUgJGNvb2tpZSBzZXJ2aWNlIGluc3RlYWQuCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlcyB2YXJ5IGRlcGVuZGluZyBvbiB0aGUgYXJndW1lbnRzIHRoYXQgdGhlIG1ldGhvZCB3YXMgY2FsbGVkIHdpdGggYXMgZm9sbG93czoKICAgICAgICAgKiA8dWw+CiAgICAgICAgICogICA8bGk+Y29va2llcygpIC0+IGhhc2ggb2YgYWxsIGNvb2tpZXMsIHRoaXMgaXMgTk9UIGEgY29weSBvZiB0aGUgaW50ZXJuYWwgc3RhdGUsIHNvIGRvIG5vdCBtb2RpZnkgaXQ8L2xpPgogICAgICAgICAqICAgPGxpPmNvb2tpZXMobmFtZSwgdmFsdWUpIC0+IHNldCBuYW1lIHRvIHZhbHVlLCBpZiB2YWx1ZSBpcyB1bmRlZmluZWQgZGVsZXRlIHRoZSBjb29raWU8L2xpPgogICAgICAgICAqICAgPGxpPmNvb2tpZXMobmFtZSkgLT4gdGhlIHNhbWUgYXMgKG5hbWUsIHVuZGVmaW5lZCkgPT0gREVMRVRFUyAobm8gb25lIGNhbGxzIGl0IHJpZ2h0IG5vdyB0aGF0IHdheSk8L2xpPgogICAgICAgICAqIDwvdWw+CiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBIYXNoIG9mIGFsbCBjb29raWVzIChpZiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyKQogICAgICAgICAqLwogICAgICAgIHNlbGYuY29va2llcyA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgY29va2llTGVuZ3RoLCBjb29raWVBcnJheSwgY29va2llLCBpLCBpbmRleDsKCiAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHJhd0RvY3VtZW50LmNvb2tpZSA9IGVzY2FwZShuYW1lKSArICI9O3BhdGg9IiArIGNvb2tpZVBhdGggKyAiO2V4cGlyZXM9VGh1LCAwMSBKYW4gMTk3MCAwMDowMDowMCBHTVQiOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvb2tpZUxlbmd0aCA9IChyYXdEb2N1bWVudC5jb29raWUgPSBlc2NhcGUobmFtZSkgKyAnPScgKyBlc2NhcGUodmFsdWUpICsgJztwYXRoPScgKyBjb29raWVQYXRoKS5sZW5ndGggKyAxOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGVyIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzIxMDkudHh0IGJyb3dzZXIgbXVzdCBhbGxvdyBhdCBtaW5pbXVtOgogICAgICAgICAgICAgICAgICAgICAgICAvLyAtIDMwMCBjb29raWVzCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gMjAgY29va2llcyBwZXIgdW5pcXVlIGRvbWFpbgogICAgICAgICAgICAgICAgICAgICAgICAvLyAtIDQwOTYgYnl0ZXMgcGVyIGNvb2tpZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29va2llTGVuZ3RoID4gNDA5NikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvZy53YXJuKCJDb29raWUgJyIgKyBuYW1lICsgIicgcG9zc2libHkgbm90IHNldCBvciBvdmVyZmxvd2VkIGJlY2F1c2UgaXQgd2FzIHRvbyBsYXJnZSAoIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb2tpZUxlbmd0aCArICIgPiA0MDk2IGJ5dGVzKSEiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChyYXdEb2N1bWVudC5jb29raWUgIT09IGxhc3RDb29raWVTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llU3RyaW5nID0gcmF3RG9jdW1lbnQuY29va2llOwogICAgICAgICAgICAgICAgICAgIGNvb2tpZUFycmF5ID0gbGFzdENvb2tpZVN0cmluZy5zcGxpdCgiOyAiKTsKICAgICAgICAgICAgICAgICAgICBsYXN0Q29va2llcyA9IHt9OwoKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29va2llQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29va2llID0gY29va2llQXJyYXlbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gY29va2llLmluZGV4T2YoJz0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gMCkgeyAvL2lnbm9yZSBuYW1lbGVzcyBjb29raWVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IHVuZXNjYXBlKGNvb2tpZS5zdWJzdHJpbmcoMCwgaW5kZXgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBmaXJzdCB2YWx1ZSB0aGF0IGlzIHNlZW4gZm9yIGEgY29va2llIGlzIHRoZSBtb3N0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzcGVjaWZpYyBvbmUuICB2YWx1ZXMgZm9yIHRoZSBzYW1lIGNvb2tpZSBuYW1lIHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvbGxvdyBhcmUgZm9yIGxlc3Mgc3BlY2lmaWMgcGF0aHMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdENvb2tpZXNbbmFtZV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RDb29raWVzW25hbWVdID0gdW5lc2NhcGUoY29va2llLnN1YnN0cmluZyhpbmRleCArIDEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBsYXN0Q29va2llczsKICAgICAgICAgICAgfQogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZSBuZy4kYnJvd3NlciNkZWZlcgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kYnJvd3NlcgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvJ3MgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWZlcnJlZC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IFtkZWxheT0wXSBvZiBtaWxsaXNlY29uZHMgdG8gZGVmZXIgdGhlIGZ1bmN0aW9uIGV4ZWN1dGlvbi4KICAgICAgICAgKiBAcmV0dXJucyB7Kn0gRGVmZXJJZCB0aGF0IGNhbiBiZSB1c2VkIHRvIGNhbmNlbCB0aGUgdGFzayB2aWEgYCRicm93c2VyLmRlZmVyLmNhbmNlbCgpYC4KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEV4ZWN1dGVzIGEgZm4gYXN5bmNocm9ub3VzbHkgdmlhIGBzZXRUaW1lb3V0KGZuLCBkZWxheSlgLgogICAgICAgICAqCiAgICAgICAgICogVW5saWtlIHdoZW4gY2FsbGluZyBgc2V0VGltZW91dGAgZGlyZWN0bHksIGluIHRlc3QgdGhpcyBmdW5jdGlvbiBpcyBtb2NrZWQgYW5kIGluc3RlYWQgb2YgdXNpbmcKICAgICAgICAgKiBgc2V0VGltZW91dGAgaW4gdGVzdHMsIHRoZSBmbnMgYXJlIHF1ZXVlZCBpbiBhbiBhcnJheSwgd2hpY2ggY2FuIGJlIHByb2dyYW1tYXRpY2FsbHkgZmx1c2hlZAogICAgICAgICAqIHZpYSBgJGJyb3dzZXIuZGVmZXIuZmx1c2goKWAuCiAgICAgICAgICoKICAgICAgICAgKi8KICAgICAgICBzZWxmLmRlZmVyID0gZnVuY3Rpb24gKGZuLCBkZWxheSkgewogICAgICAgICAgICB2YXIgdGltZW91dElkOwogICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOwogICAgICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXTsKICAgICAgICAgICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKTsKICAgICAgICAgICAgfSwgZGVsYXkgfHwgMCk7CiAgICAgICAgICAgIHBlbmRpbmdEZWZlcklkc1t0aW1lb3V0SWRdID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRpbWVvdXRJZDsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgbmcuJGJyb3dzZXIjZGVmZXIuY2FuY2VsCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRicm93c2VyLmRlZmVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDYW5jZWxzIGEgZGVmZXJyZWQgdGFzayBpZGVudGlmaWVkIHdpdGggYGRlZmVySWRgLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHsqfSBkZWZlcklkIFRva2VuIHJldHVybmVkIGJ5IHRoZSBgJGJyb3dzZXIuZGVmZXJgIGZ1bmN0aW9uLgogICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bGx5IGNhbmNlbGVkLgogICAgICAgICAqLwogICAgICAgIHNlbGYuZGVmZXIuY2FuY2VsID0gZnVuY3Rpb24gKGRlZmVySWQpIHsKICAgICAgICAgICAgaWYgKHBlbmRpbmdEZWZlcklkc1tkZWZlcklkXSkgewogICAgICAgICAgICAgICAgZGVsZXRlIHBlbmRpbmdEZWZlcklkc1tkZWZlcklkXTsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChkZWZlcklkKTsKICAgICAgICAgICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KG5vb3ApOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CgogICAgfQoKICAgIGZ1bmN0aW9uICRCcm93c2VyUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgJyRsb2cnLCAnJHNuaWZmZXInLCAnJGRvY3VtZW50JywKICAgICAgICAgICAgZnVuY3Rpb24gKCR3aW5kb3csICRsb2csICRzbmlmZmVyLCAkZG9jdW1lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQnJvd3Nlcigkd2luZG93LCAkZG9jdW1lbnQsICRsb2csICRzbmlmZmVyKTsKICAgICAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kY2FjaGVGYWN0b3J5CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGYWN0b3J5IHRoYXQgY29uc3RydWN0cyBjYWNoZSBvYmplY3RzIGFuZCBnaXZlcyBhY2Nlc3MgdG8gdGhlbS4KICAgICAqIAogICAgICogPHByZT4KICAgICAqIAogICAgICogIHZhciBjYWNoZSA9ICRjYWNoZUZhY3RvcnkoJ2NhY2hlSWQnKTsKICAgICAqICBleHBlY3QoJGNhY2hlRmFjdG9yeS5nZXQoJ2NhY2hlSWQnKSkudG9CZShjYWNoZSk7CiAgICAgKiAgZXhwZWN0KCRjYWNoZUZhY3RvcnkuZ2V0KCdub1N1Y2hDYWNoZUlkJykpLm5vdC50b0JlRGVmaW5lZCgpOwogICAgICoKICAgICAqICBjYWNoZS5wdXQoImtleSIsICJ2YWx1ZSIpOwogICAgICogIGNhY2hlLnB1dCgiYW5vdGhlciBrZXkiLCAiYW5vdGhlciB2YWx1ZSIpOwogICAgICogCiAgICAgKiAgZXhwZWN0KGNhY2hlLmluZm8oKSkudG9FcXVhbCh7aWQ6ICdjYWNoZUlkJywgc2l6ZTogMn0pOyAvLyBTaW5jZSB3ZSd2ZSBzcGVjaWZpZWQgbm8gb3B0aW9ucyBvbiBjcmVhdGlvbgogICAgICogCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlSWQgTmFtZSBvciBpZCBvZiB0aGUgbmV3bHkgY3JlYXRlZCBjYWNoZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBPcHRpb25zIG9iamVjdCB0aGF0IHNwZWNpZmllcyB0aGUgY2FjaGUgYmVoYXZpb3IuIFByb3BlcnRpZXM6CiAgICAgKgogICAgICogICAtIGB7bnVtYmVyPX1gIGBjYXBhY2l0eWAg4oCUIHR1cm5zIHRoZSBjYWNoZSBpbnRvIExSVSBjYWNoZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBOZXdseSBjcmVhdGVkIGNhY2hlIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgc2V0IG9mIG1ldGhvZHM6CiAgICAgKgogICAgICogLSBge29iamVjdH1gIGBpbmZvKClgIOKAlCBSZXR1cm5zIGlkLCBzaXplLCBhbmQgb3B0aW9ucyBvZiBjYWNoZS4KICAgICAqIC0gYHt7Kn19YCBgcHV0KHtzdHJpbmd9IGtleSwgeyp9IHZhbHVlKWAg4oCUIFB1dHMgYSBuZXcga2V5LXZhbHVlIHBhaXIgaW50byB0aGUgY2FjaGUgYW5kIHJldHVybnMgaXQuCiAgICAgKiAtIGB7eyp9fWAgYGdldCh7c3RyaW5nfSBrZXkpYCDigJQgUmV0dXJucyBjYWNoZWQgdmFsdWUgZm9yIGBrZXlgIG9yIHVuZGVmaW5lZCBmb3IgY2FjaGUgbWlzcy4KICAgICAqIC0gYHt2b2lkfWAgYHJlbW92ZSh7c3RyaW5nfSBrZXkpYCDigJQgUmVtb3ZlcyBhIGtleS12YWx1ZSBwYWlyIGZyb20gdGhlIGNhY2hlLgogICAgICogLSBge3ZvaWR9YCBgcmVtb3ZlQWxsKClgIOKAlCBSZW1vdmVzIGFsbCBjYWNoZWQgdmFsdWVzLgogICAgICogLSBge3ZvaWR9YCBgZGVzdHJveSgpYCDigJQgUmVtb3ZlcyByZWZlcmVuY2VzIHRvIHRoaXMgY2FjaGUgZnJvbSAkY2FjaGVGYWN0b3J5LgogICAgICoKICAgICAqLwogICAgZnVuY3Rpb24gJENhY2hlRmFjdG9yeVByb3ZpZGVyKCkgewoKICAgICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBjYWNoZXMgPSB7fTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNhY2hlRmFjdG9yeShjYWNoZUlkLCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBpZiAoY2FjaGVJZCBpbiBjYWNoZXMpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBtaW5FcnIoJyRjYWNoZUZhY3RvcnknKSgnaWlkJywgIkNhY2hlSWQgJ3swfScgaXMgYWxyZWFkeSB0YWtlbiEiLCBjYWNoZUlkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgc2l6ZSA9IDAsCiAgICAgICAgICAgICAgICAgICAgc3RhdHMgPSBleHRlbmQoe30sIG9wdGlvbnMsIHsgaWQ6IGNhY2hlSWQgfSksCiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHt9LAogICAgICAgICAgICAgICAgICAgIGNhcGFjaXR5ID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5jYXBhY2l0eSkgfHwgTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0ge30sCiAgICAgICAgICAgICAgICAgICAgZnJlc2hFbmQgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIHN0YWxlRW5kID0gbnVsbDsKCiAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdID0gewoKICAgICAgICAgICAgICAgICAgICBwdXQ6IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBscnVFbnRyeSA9IGxydUhhc2hba2V5XSB8fCAobHJ1SGFzaFtrZXldID0geyBrZXk6IGtleSB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShrZXkgaW4gZGF0YSkpIHNpemUrKzsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2l6ZSA+IGNhcGFjaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShzdGFsZUVuZC5rZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICByZWZyZXNoKGxydUVudHJ5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhW2tleV07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobHJ1RW50cnkgPT0gZnJlc2hFbmQpIGZyZXNoRW5kID0gbHJ1RW50cnkucDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxydUVudHJ5ID09IHN0YWxlRW5kKSBzdGFsZUVuZCA9IGxydUVudHJ5Lm47CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmsobHJ1RW50cnkubiwgbHJ1RW50cnkucCk7CgogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgbHJ1SGFzaFtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBzaXplLS07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIHJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIHNpemUgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBscnVIYXNoID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGZyZXNoRW5kID0gc3RhbGVFbmQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBzdGF0cyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGxydUhhc2ggPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2FjaGVzW2NhY2hlSWRdOwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICBpbmZvOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleHRlbmQoe30sIHN0YXRzLCB7IHNpemU6IHNpemUgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBtYWtlcyB0aGUgYGVudHJ5YCB0aGUgZnJlc2hFbmQgb2YgdGhlIExSVSBsaW5rZWQgbGlzdAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZWZyZXNoKGVudHJ5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVudHJ5ICE9IGZyZXNoRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhbGVFbmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWxlRW5kID0gZW50cnk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhbGVFbmQgPT0gZW50cnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWxlRW5kID0gZW50cnkubjsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgbGluayhlbnRyeS5uLCBlbnRyeS5wKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGluayhlbnRyeSwgZnJlc2hFbmQpOwogICAgICAgICAgICAgICAgICAgICAgICBmcmVzaEVuZCA9IGVudHJ5OwogICAgICAgICAgICAgICAgICAgICAgICBmcmVzaEVuZC5uID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogYmlkaXJlY3Rpb25hbGx5IGxpbmtzIHR3byBlbnRyaWVzIG9mIHRoZSBMUlUgbGlua2VkIGxpc3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gbGluayhuZXh0RW50cnksIHByZXZFbnRyeSkgewogICAgICAgICAgICAgICAgICAgIGlmIChuZXh0RW50cnkgIT0gcHJldkVudHJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0RW50cnkpIG5leHRFbnRyeS5wID0gcHJldkVudHJ5OyAvL3Agc3RhbmRzIGZvciBwcmV2aW91cywgJ3ByZXYnIGRpZG4ndCBtaW5pZnkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZFbnRyeSkgcHJldkVudHJ5Lm4gPSBuZXh0RW50cnk7IC8vbiBzdGFuZHMgZm9yIG5leHQsICduZXh0JyBkaWRuJ3QgbWluaWZ5CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJGNhY2hlRmFjdG9yeSNpbmZvCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kY2FjaGVGYWN0b3J5CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBHZXQgaW5mb3JtYXRpb24gYWJvdXQgYWxsIHRoZSBvZiB0aGUgY2FjaGVzIHRoYXQgaGF2ZSBiZWVuIGNyZWF0ZWQKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybnMge09iamVjdH0gLSBrZXktdmFsdWUgbWFwIG9mIGBjYWNoZUlkYCB0byB0aGUgcmVzdWx0IG9mIGNhbGxpbmcgYGNhY2hlI2luZm9gCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjYWNoZUZhY3RvcnkuaW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBpbmZvID0ge307CiAgICAgICAgICAgICAgICBmb3JFYWNoKGNhY2hlcywgZnVuY3Rpb24gKGNhY2hlLCBjYWNoZUlkKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mb1tjYWNoZUlkXSA9IGNhY2hlLmluZm8oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJGNhY2hlRmFjdG9yeSNnZXQKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjYWNoZUZhY3RvcnkKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIEdldCBhY2Nlc3MgdG8gYSBjYWNoZSBvYmplY3QgYnkgdGhlIGBjYWNoZUlkYCB1c2VkIHdoZW4gaXQgd2FzIGNyZWF0ZWQuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZUlkIE5hbWUgb3IgaWQgb2YgYSBjYWNoZSB0byBhY2Nlc3MuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtvYmplY3R9IENhY2hlIG9iamVjdCBpZGVudGlmaWVkIGJ5IHRoZSBjYWNoZUlkIG9yIHVuZGVmaW5lZCBpZiBubyBzdWNoIGNhY2hlLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY2FjaGVGYWN0b3J5LmdldCA9IGZ1bmN0aW9uIChjYWNoZUlkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdOwogICAgICAgICAgICB9OwoKCiAgICAgICAgICAgIHJldHVybiBjYWNoZUZhY3Rvcnk7CiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiR0ZW1wbGF0ZUNhY2hlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgZmlyc3QgdGltZSBhIHRlbXBsYXRlIGlzIHVzZWQsIGl0IGlzIGxvYWRlZCBpbiB0aGUgdGVtcGxhdGUgY2FjaGUgZm9yIHF1aWNrIHJldHJpZXZhbC4gWW91IGNhbgogICAgICogbG9hZCB0ZW1wbGF0ZXMgZGlyZWN0bHkgaW50byB0aGUgY2FjaGUgaW4gYSBgc2NyaXB0YCB0YWcsIG9yIGJ5IGNvbnN1bWluZyB0aGUgYCR0ZW1wbGF0ZUNhY2hlYAogICAgICogc2VydmljZSBkaXJlY3RseS4KICAgICAqIAogICAgICogQWRkaW5nIHZpYSB0aGUgYHNjcmlwdGAgdGFnOgogICAgICogPHByZT4KICAgICAqIDxodG1sIG5nLWFwcD4KICAgICAqIDxoZWFkPgogICAgICogPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGVJZC5odG1sIj4KICAgICAqICAgVGhpcyBpcyB0aGUgY29udGVudCBvZiB0aGUgdGVtcGxhdGUKICAgICAqIDwvc2NyaXB0PgogICAgICogPC9oZWFkPgogICAgICogICAuLi4KICAgICAqIDwvaHRtbD4KICAgICAqIDwvcHJlPgogICAgICogCiAgICAgKiAqKk5vdGU6KiogdGhlIGBzY3JpcHRgIHRhZyBjb250YWluaW5nIHRoZSB0ZW1wbGF0ZSBkb2VzIG5vdCBuZWVkIHRvIGJlIGluY2x1ZGVkIGluIHRoZSBgaGVhZGAgb2YgdGhlIGRvY3VtZW50LCBidXQgCiAgICAgKiBpdCBtdXN0IGJlIGJlbG93IHRoZSBgbmctYXBwYCBkZWZpbml0aW9uLgogICAgICogCiAgICAgKiBBZGRpbmcgdmlhIHRoZSAkdGVtcGxhdGVDYWNoZSBzZXJ2aWNlOgogICAgICogCiAgICAgKiA8cHJlPgogICAgICogdmFyIG15QXBwID0gYW5ndWxhci5tb2R1bGUoJ215QXBwJywgW10pOwogICAgICogbXlBcHAucnVuKGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAgKiAgICR0ZW1wbGF0ZUNhY2hlLnB1dCgndGVtcGxhdGVJZC5odG1sJywgJ1RoaXMgaXMgdGhlIGNvbnRlbnQgb2YgdGhlIHRlbXBsYXRlJyk7CiAgICAgKiB9KTsKICAgICAqIDwvcHJlPgogICAgICogCiAgICAgKiBUbyByZXRyaWV2ZSB0aGUgdGVtcGxhdGUgbGF0ZXIsIHNpbXBseSB1c2UgaXQgaW4geW91ciBIVE1MOgogICAgICogPHByZT4KICAgICAqIDxkaXYgbmctaW5jbHVkZT0iICd0ZW1wbGF0ZUlkLmh0bWwnICI+PC9kaXY+CiAgICAgKiA8L3ByZT4KICAgICAqIAogICAgICogb3IgZ2V0IGl0IHZpYSBKYXZhc2NyaXB0OgogICAgICogPHByZT4KICAgICAqICR0ZW1wbGF0ZUNhY2hlLmdldCgndGVtcGxhdGVJZC5odG1sJykKICAgICAqIDwvcHJlPgogICAgICogCiAgICAgKiBTZWUge0BsaW5rIG5nLiRjYWNoZUZhY3RvcnkgJGNhY2hlRmFjdG9yeX0uCiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiAkVGVtcGxhdGVDYWNoZVByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJGNhY2hlRmFjdG9yeScsIGZ1bmN0aW9uICgkY2FjaGVGYWN0b3J5KSB7CiAgICAgICAgICAgIHJldHVybiAkY2FjaGVGYWN0b3J5KCd0ZW1wbGF0ZXMnKTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKiAhIFZBUklBQkxFL0ZVTkNUSU9OIE5BTUlORyBDT05WRU5USU9OUyBUSEFUIEFQUExZIFRPIFRISVMgRklMRSEKICAgICAqCiAgICAgKiBET00tcmVsYXRlZCB2YXJpYWJsZXM6CiAgICAgKgogICAgICogLSAibm9kZSIgLSBET00gTm9kZQogICAgICogLSAiZWxlbWVudCIgLSBET00gRWxlbWVudCBvciBOb2RlCiAgICAgKiAtICIkbm9kZSIgb3IgIiRlbGVtZW50IiAtIGpxTGl0ZS13cmFwcGVkIG5vZGUgb3IgZWxlbWVudAogICAgICoKICAgICAqCiAgICAgKiBDb21waWxlciByZWxhdGVkIHN0dWZmOgogICAgICoKICAgICAqIC0gImxpbmtGbiIgLSBsaW5raW5nIGZuIG9mIGEgc2luZ2xlIGRpcmVjdGl2ZQogICAgICogLSAibm9kZUxpbmtGbiIgLSBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBhIHBhcnRpY3VsYXIgbm9kZQogICAgICogLSAiY2hpbGRMaW5rRm4iIC0gIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGNoaWxkIG5vZGVzIG9mIGEgcGFydGljdWxhciBub2RlCiAgICAgKiAtICJjb21wb3NpdGVMaW5rRm4iIC0gZnVuY3Rpb24gdGhhdCBhZ2dyZWdhdGVzIGFsbCBsaW5raW5nIGZucyBmb3IgYSBjb21waWxhdGlvbiByb290IChub2RlTGlzdCkKICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJGNvbXBpbGUKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ29tcGlsZXMgYSBwaWVjZSBvZiBIVE1MIHN0cmluZyBvciBET00gaW50byBhIHRlbXBsYXRlIGFuZCBwcm9kdWNlcyBhIHRlbXBsYXRlIGZ1bmN0aW9uLCB3aGljaAogICAgICogY2FuIHRoZW4gYmUgdXNlZCB0byBsaW5rIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfSBhbmQgdGhlIHRlbXBsYXRlIHRvZ2V0aGVyLgogICAgICoKICAgICAqIFRoZSBjb21waWxhdGlvbiBpcyBhIHByb2Nlc3Mgb2Ygd2Fsa2luZyB0aGUgRE9NIHRyZWUgYW5kIHRyeWluZyB0byBtYXRjaCBET00gZWxlbWVudHMgdG8KICAgICAqIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4gRm9yIGVhY2ggbWF0Y2ggaXQKICAgICAqIGV4ZWN1dGVzIGNvcnJlc3BvbmRpbmcgdGVtcGxhdGUgZnVuY3Rpb24gYW5kIGNvbGxlY3RzIHRoZQogICAgICogaW5zdGFuY2UgZnVuY3Rpb25zIGludG8gYSBzaW5nbGUgdGVtcGxhdGUgZnVuY3Rpb24gd2hpY2ggaXMgdGhlbiByZXR1cm5lZC4KICAgICAqCiAgICAgKiBUaGUgdGVtcGxhdGUgZnVuY3Rpb24gY2FuIHRoZW4gYmUgdXNlZCBvbmNlIHRvIHByb2R1Y2UgdGhlIHZpZXcgb3IgYXMgaXQgaXMgdGhlIGNhc2Ugd2l0aAogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCByZXBlYXRlcn0gbWFueS10aW1lcywgaW4gd2hpY2gKICAgICAqIGNhc2UgZWFjaCBjYWxsIHJlc3VsdHMgaW4gYSB2aWV3IHRoYXQgaXMgYSBET00gY2xvbmUgb2YgdGhlIG9yaWdpbmFsIHRlbXBsYXRlLgogICAgICoKICAgICA8ZG9jOmV4YW1wbGUgbW9kdWxlPSJjb21waWxlIj4KICAgICAgIDxkb2M6c291cmNlPgogICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAvLyBkZWNsYXJlIGEgbmV3IG1vZHVsZSwgYW5kIGluamVjdCB0aGUgJGNvbXBpbGVQcm92aWRlcgogICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2NvbXBpbGUnLCBbXSwgZnVuY3Rpb24oJGNvbXBpbGVQcm92aWRlcikgewogICAgICAgICAgICAvLyBjb25maWd1cmUgbmV3ICdjb21waWxlJyBkaXJlY3RpdmUgYnkgcGFzc2luZyBhIGRpcmVjdGl2ZQogICAgICAgICAgICAvLyBmYWN0b3J5IGZ1bmN0aW9uLiBUaGUgZmFjdG9yeSBmdW5jdGlvbiBpbmplY3RzIHRoZSAnJGNvbXBpbGUnCiAgICAgICAgICAgICRjb21waWxlUHJvdmlkZXIuZGlyZWN0aXZlKCdjb21waWxlJywgZnVuY3Rpb24oJGNvbXBpbGUpIHsKICAgICAgICAgICAgICAvLyBkaXJlY3RpdmUgZmFjdG9yeSBjcmVhdGVzIGEgbGluayBmdW5jdGlvbgogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgLy8gd2F0Y2ggdGhlICdjb21waWxlJyBleHByZXNzaW9uIGZvciBjaGFuZ2VzCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRldmFsKGF0dHJzLmNvbXBpbGUpOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhlICdjb21waWxlJyBleHByZXNzaW9uIGNoYW5nZXMKICAgICAgICAgICAgICAgICAgICAvLyBhc3NpZ24gaXQgaW50byB0aGUgY3VycmVudCBET00KICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwodmFsdWUpOwogICAgCiAgICAgICAgICAgICAgICAgICAgLy8gY29tcGlsZSB0aGUgbmV3IERPTSBhbmQgbGluayBpdCB0byB0aGUgY3VycmVudAogICAgICAgICAgICAgICAgICAgIC8vIHNjb3BlLgogICAgICAgICAgICAgICAgICAgIC8vIE5PVEU6IHdlIG9ubHkgY29tcGlsZSAuY2hpbGROb2RlcyBzbyB0aGF0CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgZG9uJ3QgZ2V0IGludG8gaW5maW5pdGUgbG9vcCBjb21waWxpbmcgb3Vyc2VsdmVzCiAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGUoZWxlbWVudC5jb250ZW50cygpKShzY29wZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSkKICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAkc2NvcGUubmFtZSA9ICdBbmd1bGFyJzsKICAgICAgICAgICAgJHNjb3BlLmh0bWwgPSAnSGVsbG8ge3tuYW1lfX0nOwogICAgICAgICAgfQogICAgICAgIDwvc2NyaXB0PgogICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICA8aW5wdXQgbmctbW9kZWw9Im5hbWUiPiA8YnI+CiAgICAgICAgICA8dGV4dGFyZWEgbmctbW9kZWw9Imh0bWwiPjwvdGV4dGFyZWE+IDxicj4KICAgICAgICAgIDxkaXYgY29tcGlsZT0iaHRtbCI+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICBpdCgnc2hvdWxkIGF1dG8gY29tcGlsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCdkaXZbY29tcGlsZV0nKS50ZXh0KCkpLnRvQmUoJ0hlbGxvIEFuZ3VsYXInKTsKICAgICAgICAgICBpbnB1dCgnaHRtbCcpLmVudGVyKCd7e25hbWV9fSEnKTsKICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnZGl2W2NvbXBpbGVdJykudGV4dCgpKS50b0JlKCdBbmd1bGFyIScpOwogICAgICAgICB9KTsKICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgIDwvZG9jOmV4YW1wbGU+CiAgICAKICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBFbGVtZW50IG9yIEhUTUwgc3RyaW5nIHRvIGNvbXBpbGUgaW50byBhIHRlbXBsYXRlIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlWywgY2xvbmVBdHRhY2hGbl19IHRyYW5zY2x1ZGUgZnVuY3Rpb24gYXZhaWxhYmxlIHRvIGRpcmVjdGl2ZXMuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWF4UHJpb3JpdHkgb25seSBhcHBseSBkaXJlY3RpdmVzIGxvd2VyIHRoZW4gZ2l2ZW4gcHJpb3JpdHkgKE9ubHkgZWZmZWN0cyB0aGUKICAgICAqICAgICAgICAgICAgICAgICByb290IGVsZW1lbnQocyksIG5vdCB0aGVpciBjaGlsZHJlbikKICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihzY29wZVssIGNsb25lQXR0YWNoRm5dKX0gYSBsaW5rIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gYmluZCB0ZW1wbGF0ZQogICAgICogKGEgRE9NIGVsZW1lbnQvdHJlZSkgdG8gYSBzY29wZS4gV2hlcmU6CiAgICAgKgogICAgICogICogYHNjb3BlYCAtIEEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgU2NvcGV9IHRvIGJpbmQgdG8uCiAgICAgKiAgKiBgY2xvbmVBdHRhY2hGbmAgLSBJZiBgY2xvbmVBdHRhY2hGbmAgaXMgcHJvdmlkZWQsIHRoZW4gdGhlIGxpbmsgZnVuY3Rpb24gd2lsbCBjbG9uZSB0aGUKICAgICAqICAgICAgICAgICAgICAgYHRlbXBsYXRlYCBhbmQgY2FsbCB0aGUgYGNsb25lQXR0YWNoRm5gIGZ1bmN0aW9uIGFsbG93aW5nIHRoZSBjYWxsZXIgdG8gYXR0YWNoIHRoZQogICAgICogICAgICAgICAgICAgICBjbG9uZWQgZWxlbWVudHMgdG8gdGhlIERPTSBkb2N1bWVudCBhdCB0aGUgYXBwcm9wcmlhdGUgcGxhY2UuIFRoZSBgY2xvbmVBdHRhY2hGbmAgaXMKICAgICAqICAgICAgICAgICAgICAgY2FsbGVkIGFzOiA8YnI+IGBjbG9uZUF0dGFjaEZuKGNsb25lZEVsZW1lbnQsIHNjb3BlKWAgd2hlcmU6CiAgICAgKgogICAgICogICAgICAqIGBjbG9uZWRFbGVtZW50YCAtIGlzIGEgY2xvbmUgb2YgdGhlIG9yaWdpbmFsIGBlbGVtZW50YCBwYXNzZWQgaW50byB0aGUgY29tcGlsZXIuCiAgICAgKiAgICAgICogYHNjb3BlYCAtIGlzIHRoZSBjdXJyZW50IHNjb3BlIHdpdGggd2hpY2ggdGhlIGxpbmtpbmcgZnVuY3Rpb24gaXMgd29ya2luZyB3aXRoLgogICAgICoKICAgICAqIENhbGxpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gcmV0dXJucyB0aGUgZWxlbWVudCBvZiB0aGUgdGVtcGxhdGUuIEl0IGlzIGVpdGhlciB0aGUgb3JpZ2luYWwgZWxlbWVudAogICAgICogcGFzc2VkIGluLCBvciB0aGUgY2xvbmUgb2YgdGhlIGVsZW1lbnQgaWYgdGhlIGBjbG9uZUF0dGFjaEZuYCBpcyBwcm92aWRlZC4KICAgICAqCiAgICAgKiBBZnRlciBsaW5raW5nIHRoZSB2aWV3IGlzIG5vdCB1cGRhdGVkIHVudGlsIGFmdGVyIGEgY2FsbCB0byAkZGlnZXN0IHdoaWNoIHR5cGljYWxseSBpcyBkb25lIGJ5CiAgICAgKiBBbmd1bGFyIGF1dG9tYXRpY2FsbHkuCiAgICAgKgogICAgICogSWYgeW91IG5lZWQgYWNjZXNzIHRvIHRoZSBib3VuZCB2aWV3LCB0aGVyZSBhcmUgdHdvIHdheXMgdG8gZG8gaXQ6CiAgICAgKgogICAgICogLSBJZiB5b3UgYXJlIG5vdCBhc2tpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gdG8gY2xvbmUgdGhlIHRlbXBsYXRlLCBjcmVhdGUgdGhlIERPTSBlbGVtZW50KHMpCiAgICAgKiAgIGJlZm9yZSB5b3Ugc2VuZCB0aGVtIHRvIHRoZSBjb21waWxlciBhbmQga2VlcCB0aGlzIHJlZmVyZW5jZSBhcm91bmQuCiAgICAgKiAgIDxwcmU+CiAgICAgKiAgICAgdmFyIGVsZW1lbnQgPSAkY29tcGlsZSgnPHA+e3t0b3RhbH19PC9wPicpKHNjb3BlKTsKICAgICAqICAgPC9wcmU+CiAgICAgKgogICAgICogLSBpZiBvbiB0aGUgb3RoZXIgaGFuZCwgeW91IG5lZWQgdGhlIGVsZW1lbnQgdG8gYmUgY2xvbmVkLCB0aGUgdmlldyByZWZlcmVuY2UgZnJvbSB0aGUgb3JpZ2luYWwKICAgICAqICAgZXhhbXBsZSB3b3VsZCBub3QgcG9pbnQgdG8gdGhlIGNsb25lLCBidXQgcmF0aGVyIHRvIHRoZSBvcmlnaW5hbCB0ZW1wbGF0ZSB0aGF0IHdhcyBjbG9uZWQuIEluCiAgICAgKiAgIHRoaXMgY2FzZSwgeW91IGNhbiBhY2Nlc3MgdGhlIGNsb25lIHZpYSB0aGUgY2xvbmVBdHRhY2hGbjoKICAgICAqICAgPHByZT4KICAgICAqICAgICB2YXIgdGVtcGxhdGVIVE1MID0gYW5ndWxhci5lbGVtZW50KCc8cD57e3RvdGFsfX08L3A+JyksCiAgICAgKiAgICAgICAgIHNjb3BlID0gLi4uLjsKICAgICAqCiAgICAgKiAgICAgdmFyIGNsb25lZEVsZW1lbnQgPSAkY29tcGlsZSh0ZW1wbGF0ZUhUTUwpKHNjb3BlLCBmdW5jdGlvbihjbG9uZWRFbGVtZW50LCBzY29wZSkgewogICAgICogICAgICAgLy9hdHRhY2ggdGhlIGNsb25lIHRvIERPTSBkb2N1bWVudCBhdCB0aGUgcmlnaHQgcGxhY2UKICAgICAqICAgICB9KTsKICAgICAqCiAgICAgKiAgICAgLy9ub3cgd2UgaGF2ZSByZWZlcmVuY2UgdG8gdGhlIGNsb25lZCBET00gdmlhIGBjbG9uZWAKICAgICAqICAgPC9wcmU+CiAgICAgKgogICAgICoKICAgICAqIEZvciBpbmZvcm1hdGlvbiBvbiBob3cgdGhlIGNvbXBpbGVyIHdvcmtzLCBzZWUgdGhlCiAgICAgKiB7QGxpbmsgZ3VpZGUvY29tcGlsZXIgQW5ndWxhciBIVE1MIENvbXBpbGVyfSBzZWN0aW9uIG9mIHRoZSBEZXZlbG9wZXIgR3VpZGUuCiAgICAgKi8KCiAgICB2YXIgJGNvbXBpbGVNaW5FcnIgPSBtaW5FcnIoJyRjb21waWxlJyk7CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgbmcuJGNvbXBpbGVQcm92aWRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKi8KICAgICRDb21waWxlUHJvdmlkZXIuJGluamVjdCA9IFsnJHByb3ZpZGUnXTsKICAgIGZ1bmN0aW9uICRDb21waWxlUHJvdmlkZXIoJHByb3ZpZGUpIHsKICAgICAgICB2YXIgaGFzRGlyZWN0aXZlcyA9IHt9LAogICAgICAgICAgICBTdWZmaXggPSAnRGlyZWN0aXZlJywKICAgICAgICAgICAgQ09NTUVOVF9ESVJFQ1RJVkVfUkVHRVhQID0gL15ccypkaXJlY3RpdmVcOlxzKihbXGRcd1wtX10rKVxzKyguKikkLywKICAgICAgICAgICAgQ0xBU1NfRElSRUNUSVZFX1JFR0VYUCA9IC8oKFtcZFx3XC1fXSspKD86XDooW147XSspKT87PykvLAogICAgICAgICAgICBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCA9IC9eXHMqKGh0dHBzP3xmdHB8bWFpbHRvfGZpbGUpOi8sCiAgICAgICAgICAgIGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA9IC9eXHMqKGh0dHBzP3xmdHB8ZmlsZSk6fGRhdGE6aW1hZ2VcLy87CgogICAgICAgIC8vIFJlZjogaHR0cDovL2RldmVsb3BlcnMud2hhdHdnLm9yZy93ZWJhcHBhcGlzLmh0bWwjZXZlbnQtaGFuZGxlci1pZGwtYXR0cmlidXRlcwogICAgICAgIC8vIFRoZSBhc3N1bXB0aW9uIGlzIHRoYXQgZnV0dXJlIERPTSBldmVudCBhdHRyaWJ1dGUgbmFtZXMgd2lsbCBiZWdpbiB3aXRoCiAgICAgICAgLy8gJ29uJyBhbmQgYmUgY29tcG9zZWQgb2Ygb25seSBFbmdsaXNoIGxldHRlcnMuCiAgICAgICAgdmFyIEVWRU5UX0hBTkRMRVJfQVRUUl9SRUdFWFAgPSAvXihvblthLXpdKnxmb3JtYWN0aW9uKSQvOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZQogICAgICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZVByb3ZpZGVyCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZWdpc3RlciBhIG5ldyBkaXJlY3RpdmUgd2l0aCB0aGUgY29tcGlsZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBkaXJlY3RpdmUgaW4gY2FtZWwtY2FzZS4gKGllIDxjb2RlPm5nQmluZDwvY29kZT4gd2hpY2ggd2lsbCBtYXRjaCBhcwogICAgICAgICAqICAgICAgICAgICAgICAgIDxjb2RlPm5nLWJpbmQ8L2NvZGU+KS4KICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufEFycmF5fSBkaXJlY3RpdmVGYWN0b3J5IEFuIGluamVjdGFibGUgZGlyZWN0aXZlIGZhY3RvcnkgZnVuY3Rpb24uIFNlZSB7QGxpbmsgZ3VpZGUvZGlyZWN0aXZlfSBmb3IgbW9yZQogICAgICAgICAqICAgICAgICAgICAgICAgIGluZm8uCiAgICAgICAgICogQHJldHVybnMge25nLiRjb21waWxlUHJvdmlkZXJ9IFNlbGYgZm9yIGNoYWluaW5nLgogICAgICAgICAqLwogICAgICAgIHRoaXMuZGlyZWN0aXZlID0gZnVuY3Rpb24gcmVnaXN0ZXJEaXJlY3RpdmUobmFtZSwgZGlyZWN0aXZlRmFjdG9yeSkgewogICAgICAgICAgICBpZiAoaXNTdHJpbmcobmFtZSkpIHsKICAgICAgICAgICAgICAgIGFzc2VydEFyZyhkaXJlY3RpdmVGYWN0b3J5LCAnZGlyZWN0aXZlRmFjdG9yeScpOwogICAgICAgICAgICAgICAgaWYgKCFoYXNEaXJlY3RpdmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzRGlyZWN0aXZlc1tuYW1lXSA9IFtdOwogICAgICAgICAgICAgICAgICAgICRwcm92aWRlLmZhY3RvcnkobmFtZSArIFN1ZmZpeCwgWyckaW5qZWN0b3InLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCRpbmplY3RvciwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlyZWN0aXZlcyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goaGFzRGlyZWN0aXZlc1tuYW1lXSwgZnVuY3Rpb24gKGRpcmVjdGl2ZUZhY3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXJlY3RpdmUgPSAkaW5qZWN0b3IuaW52b2tlKGRpcmVjdGl2ZUZhY3RvcnkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oZGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IHsgY29tcGlsZTogdmFsdWVGbihkaXJlY3RpdmUpIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFkaXJlY3RpdmUuY29tcGlsZSAmJiBkaXJlY3RpdmUubGluaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5jb21waWxlID0gdmFsdWVGbihkaXJlY3RpdmUubGluayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucHJpb3JpdHkgPSBkaXJlY3RpdmUucHJpb3JpdHkgfHwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5uYW1lID0gZGlyZWN0aXZlLm5hbWUgfHwgbmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmUgfHwgKGRpcmVjdGl2ZS5jb250cm9sbGVyICYmIGRpcmVjdGl2ZS5uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGlyZWN0aXZlczsKICAgICAgICAgICAgICAgICAgICAgIH1dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhhc0RpcmVjdGl2ZXNbbmFtZV0ucHVzaChkaXJlY3RpdmVGYWN0b3J5KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvckVhY2gobmFtZSwgcmV2ZXJzZVBhcmFtcyhyZWdpc3RlckRpcmVjdGl2ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyI2FIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjb21waWxlUHJvdmlkZXIKICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgICAgICAgKiB1cmxzIGR1cmluZyBhW2hyZWZdIHNhbml0aXphdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIFRoZSBzYW5pdGl6YXRpb24gaXMgYSBzZWN1cml0eSBtZWFzdXJlIGFpbWVkIGF0IHByZXZlbnQgWFNTIGF0dGFja3MgdmlhIGh0bWwgbGlua3MuCiAgICAgICAgICoKICAgICAgICAgKiBBbnkgdXJsIGFib3V0IHRvIGJlIGFzc2lnbmVkIHRvIGFbaHJlZl0gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50bwogICAgICAgICAqIGFuIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcywgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdGAKICAgICAgICAgKiByZWd1bGFyIGV4cHJlc3Npb24uIElmIGEgbWF0Y2ggaXMgZm91bmQsIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSwKICAgICAgICAgKiB0aGUgYWJzb2x1dGUgdXJsIGlzIHByZWZpeGVkIHdpdGggYCd1bnNhZmU6J2Agc3RyaW5nIGFuZCBvbmx5IHRoZW4gaXMgaXQgd3JpdHRlbiBpbnRvIHRoZSBET00uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1JlZ0V4cD19IHJlZ2V4cCBOZXcgcmVnZXhwIHRvIHdoaXRlbGlzdCB1cmxzIHdpdGguCiAgICAgICAgICogQHJldHVybnMge1JlZ0V4cHxuZy4kY29tcGlsZVByb3ZpZGVyfSBDdXJyZW50IFJlZ0V4cCBpZiBjYWxsZWQgd2l0aG91dCB2YWx1ZSBvciBzZWxmIGZvcgogICAgICAgICAqICAgIGNoYWluaW5nIG90aGVyd2lzZS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLmFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gZnVuY3Rpb24gKHJlZ2V4cCkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgICAgICAgICAgIGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gcmVnZXhwOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0OwogICAgICAgIH07CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZVByb3ZpZGVyI2ltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZVByb3ZpZGVyCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICAgICAgICogdXJscyBkdXJpbmcgaW1nW3NyY10gc2FuaXRpemF0aW9uLgogICAgICAgICAqCiAgICAgICAgICogVGhlIHNhbml0aXphdGlvbiBpcyBhIHNlY3VyaXR5IG1lYXN1cmUgYWltZWQgYXQgcHJldmVudCBYU1MgYXR0YWNrcyB2aWEgaHRtbCBsaW5rcy4KICAgICAgICAgKgogICAgICAgICAqIEFueSB1cmwgYWJvdXQgdG8gYmUgYXNzaWduZWQgdG8gaW1nW3NyY10gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50byBhbgogICAgICAgICAqIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcywgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3RgIHJlZ3VsYXIKICAgICAgICAgKiBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kLCB0aGUgb3JpZ2luYWwgdXJsIGlzIHdyaXR0ZW4gaW50byB0aGUgZG9tLiBPdGhlcndpc2UsIHRoZQogICAgICAgICAqIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGlzIGl0IHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAgICAgICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgICAgICAgKiAgICBjaGFpbmluZyBvdGhlcndpc2UuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5pbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbiAocmVnZXhwKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQocmVnZXhwKSkgewogICAgICAgICAgICAgICAgaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gcmVnZXhwOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdDsKICAgICAgICB9OwoKCiAgICAgICAgdGhpcy4kZ2V0ID0gWwogICAgICAgICAgICAgICAgICAnJGluamVjdG9yJywgJyRpbnRlcnBvbGF0ZScsICckZXhjZXB0aW9uSGFuZGxlcicsICckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckcGFyc2UnLAogICAgICAgICAgICAgICAgICAnJGNvbnRyb2xsZXInLCAnJHJvb3RTY29wZScsICckZG9jdW1lbnQnLCAnJHNjZScsICckJHVybFV0aWxzJywgJyRhbmltYXRlJywKICAgICAgICAgIGZ1bmN0aW9uICgkaW5qZWN0b3IsICRpbnRlcnBvbGF0ZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRodHRwLCAkdGVtcGxhdGVDYWNoZSwgJHBhcnNlLAogICAgICAgICAgICAgICAgICAgJGNvbnRyb2xsZXIsICRyb290U2NvcGUsICRkb2N1bWVudCwgJHNjZSwgJCR1cmxVdGlscywgJGFuaW1hdGUpIHsKCiAgICAgICAgICAgICAgdmFyIEF0dHJpYnV0ZXMgPSBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICB0aGlzLiQkZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHIgPSBhdHRyIHx8IHt9OwogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIEF0dHJpYnV0ZXMucHJvdG90eXBlID0gewogICAgICAgICAgICAgICAgICAkbm9ybWFsaXplOiBkaXJlY3RpdmVOb3JtYWxpemUsCgoKICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkYWRkQ2xhc3MKICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICogQWRkcyB0aGUgQ1NTIGNsYXNzIHZhbHVlIHNwZWNpZmllZCBieSB0aGUgY2xhc3NWYWwgcGFyYW1ldGVyIHRvIHRoZSBlbGVtZW50LiBJZiBhbmltYXRpb25zCiAgICAgICAgICAgICAgICAgICAqIGFyZSBlbmFibGVkIHRoZW4gYW4gYW5pbWF0aW9uIHdpbGwgYmUgdHJpZ2dlcmVkIGZvciB0aGUgY2xhc3MgYWRkaXRpb24uCiAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc1ZhbCBUaGUgY2xhc3NOYW1lIHZhbHVlIHRoYXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgJGFkZENsYXNzOiBmdW5jdGlvbiAoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjbGFzc1ZhbCAmJiBjbGFzc1ZhbC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3ModGhpcy4kJGVsZW1lbnQsIGNsYXNzVmFsKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJHJlbW92ZUNsYXNzCiAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcwogICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAqIFJlbW92ZXMgdGhlIENTUyBjbGFzcyB2YWx1ZSBzcGVjaWZpZWQgYnkgdGhlIGNsYXNzVmFsIHBhcmFtZXRlciBmcm9tIHRoZSBlbGVtZW50LiBJZiBhbmltYXRpb25zCiAgICAgICAgICAgICAgICAgICAqIGFyZSBlbmFibGVkIHRoZW4gYW4gYW5pbWF0aW9uIHdpbGwgYmUgdHJpZ2dlcmVkIGZvciB0aGUgY2xhc3MgcmVtb3ZhbC4KICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzVmFsIFRoZSBjbGFzc05hbWUgdmFsdWUgdGhhdCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgJHJlbW92ZUNsYXNzOiBmdW5jdGlvbiAoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjbGFzc1ZhbCAmJiBjbGFzc1ZhbC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3ModGhpcy4kJGVsZW1lbnQsIGNsYXNzVmFsKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgKiBTZXQgYSBub3JtYWxpemVkIGF0dHJpYnV0ZSBvbiB0aGUgZWxlbWVudCBpbiBhIHdheSBzdWNoIHRoYXQgYWxsIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgICAgICogY2FuIHNoYXJlIHRoZSBhdHRyaWJ1dGUuIFRoaXMgZnVuY3Rpb24gcHJvcGVybHkgaGFuZGxlcyBib29sZWFuIGF0dHJpYnV0ZXMuCiAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgTm9ybWFsaXplZCBrZXkuIChpZSBuZ0F0dHJpYnV0ZSkKICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8Ym9vbGVhbn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldC4gSWYgYG51bGxgIGF0dHJpYnV0ZSB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHdyaXRlQXR0ciBJZiBmYWxzZSwgZG9lcyBub3Qgd3JpdGUgdGhlIHZhbHVlIHRvIERPTSBlbGVtZW50IGF0dHJpYnV0ZS4KICAgICAgICAgICAgICAgICAgICogICAgIERlZmF1bHRzIHRvIHRydWUuCiAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gYXR0ck5hbWUgT3B0aW9uYWwgbm9uZSBub3JtYWxpemVkIG5hbWUuIERlZmF1bHRzIHRvIGtleS4KICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICRzZXQ6IGZ1bmN0aW9uIChrZXksIHZhbHVlLCB3cml0ZUF0dHIsIGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAvL3NwZWNpYWwgY2FzZSBmb3IgY2xhc3MgYXR0cmlidXRlIGFkZGl0aW9uICsgcmVtb3ZhbAogICAgICAgICAgICAgICAgICAgICAgLy9zbyB0aGF0IGNsYXNzIGNoYW5nZXMgY2FuIHRhcCBpbnRvIHRoZSBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICAgIC8vaG9va3MgcHJvdmlkZWQgYnkgdGhlICRhbmltYXRlIHNlcnZpY2UKICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkgPT0gJ2NsYXNzJykgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUgfHwgJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLiQkZWxlbWVudC5hdHRyKCdjbGFzcycpIHx8ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJHJlbW92ZUNsYXNzKHRva2VuRGlmZmVyZW5jZShjdXJyZW50LCB2YWx1ZSkuam9pbignICcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRhZGRDbGFzcyh0b2tlbkRpZmZlcmVuY2UodmFsdWUsIGN1cnJlbnQpLmpvaW4oJyAnKSk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBib29sZWFuS2V5ID0gZ2V0Qm9vbGVhbkF0dHJOYW1lKHRoaXMuJCRlbGVtZW50WzBdLCBrZXkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVkVmFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTmFtZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJvb2xlYW5LZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQucHJvcChrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ck5hbWUgPSBib29sZWFuS2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRyYW5zbGF0ZSBub3JtYWxpemVkIGtleSB0byBhY3R1YWwga2V5CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGF0dHJba2V5XSA9IGF0dHJOYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gdGhpcy4kYXR0cltrZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRhdHRyW2tleV0gPSBhdHRyTmFtZSA9IHNuYWtlX2Nhc2Uoa2V5LCAnLScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTmFtZSA9IG5vZGVOYW1lXyh0aGlzLiQkZWxlbWVudCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNhbml0aXplIGFbaHJlZl0gYW5kIGltZ1tzcmNdIHZhbHVlcwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgobm9kZU5hbWUgPT09ICdBJyAmJiBrZXkgPT09ICdocmVmJykgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5vZGVOYW1lID09PSAnSU1HJyAmJiBrZXkgPT09ICdzcmMnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOT1RFOiAkJHVybFV0aWxzLnJlc29sdmUoKSBkb2Vzbid0IHN1cHBvcnQgSUUgPCA4IHNvIHdlIGRvbid0IHNhbml0aXplIGZvciB0aGF0IGNhc2UuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbXNpZSB8fCBtc2llID49IDgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRWYWwgPSAkJHVybFV0aWxzLnJlc29sdmUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRWYWwgIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChrZXkgPT09ICdocmVmJyAmJiAhbm9ybWFsaXplZFZhbC5tYXRjaChhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCkpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChrZXkgPT09ICdzcmMnICYmICFub3JtYWxpemVkVmFsLm1hdGNoKGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlID0gJ3Vuc2FmZTonICsgbm9ybWFsaXplZFZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3cml0ZUF0dHIgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5yZW1vdmVBdHRyKGF0dHJOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LmF0dHIoYXR0ck5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAvLyBmaXJlIG9ic2VydmVycwogICAgICAgICAgICAgICAgICAgICAgdmFyICQkb2JzZXJ2ZXJzID0gdGhpcy4kJG9ic2VydmVyczsKICAgICAgICAgICAgICAgICAgICAgICQkb2JzZXJ2ZXJzICYmIGZvckVhY2goJCRvYnNlcnZlcnNba2V5XSwgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gdG9rZW5EaWZmZXJlbmNlKHN0cjEsIHN0cjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWVzID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuczEgPSBzdHIxLnNwbGl0KC9ccysvKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zMiA9IHN0cjIuc3BsaXQoL1xzKy8pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRlcjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b2tlbnMxLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlbnMxW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0b2tlbnMyLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRva2VuID09IHRva2VuczJbal0pIGNvbnRpbnVlIG91dGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2godG9rZW4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAqIE9ic2VydmUgYW4gaW50ZXJwb2xhdGVkIGF0dHJpYnV0ZS4KICAgICAgICAgICAgICAgICAgICogVGhlIG9ic2VydmVyIHdpbGwgbmV2ZXIgYmUgY2FsbGVkLCBpZiBnaXZlbiBhdHRyaWJ1dGUgaXMgbm90IGludGVycG9sYXRlZC4KICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKSAuCiAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKil9IGZuIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbmV2ZXIgdGhlIGF0dHJpYnV0ZSB2YWx1ZSBjaGFuZ2VzLgogICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKil9IHRoZSBgZm5gIEZ1bmN0aW9uIHBhc3NlZCBpbi4KICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICRvYnNlcnZlOiBmdW5jdGlvbiAoa2V5LCBmbikgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJzID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAkJG9ic2VydmVycyA9IChhdHRycy4kJG9ic2VydmVycyB8fCAoYXR0cnMuJCRvYnNlcnZlcnMgPSB7fSkpLAogICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycyA9ICgkJG9ic2VydmVyc1trZXldIHx8ICgkJG9ic2VydmVyc1trZXldID0gW10pKTsKCiAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChmbik7CiAgICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGlzdGVuZXJzLiQkaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm8gb25lIHJlZ2lzdGVyZWQgYXR0cmlidXRlIGludGVycG9sYXRpb24gZnVuY3Rpb24sIHNvIGxldHMgY2FsbCBpdCBtYW51YWxseQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihhdHRyc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIHZhciB1cmxTYW5pdGl6YXRpb25Ob2RlID0gJGRvY3VtZW50WzBdLmNyZWF0ZUVsZW1lbnQoJ2EnKSwKICAgICAgICAgICAgICAgICAgc3RhcnRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2woKSwKICAgICAgICAgICAgICAgICAgZW5kU3ltYm9sID0gJGludGVycG9sYXRlLmVuZFN5bWJvbCgpLAogICAgICAgICAgICAgICAgICBkZW5vcm1hbGl6ZVRlbXBsYXRlID0gKHN0YXJ0U3ltYm9sID09ICd7eycgfHwgZW5kU3ltYm9sID09ICd9fScpCiAgICAgICAgICAgICAgICAgICAgICA/IGlkZW50aXR5CiAgICAgICAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uIGRlbm9ybWFsaXplVGVtcGxhdGUodGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGUucmVwbGFjZSgvXHtcey9nLCBzdGFydFN5bWJvbCkucmVwbGFjZSgvfX0vZywgZW5kU3ltYm9sKTsKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIE5HX0FUVFJfQklORElORyA9IC9ebmdBdHRyW0EtWl0vOwoKCiAgICAgICAgICAgICAgcmV0dXJuIGNvbXBpbGU7CgogICAgICAgICAgICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGlsZSgkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgaWYgKCEoJGNvbXBpbGVOb2RlcyBpbnN0YW5jZW9mIGpxTGl0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGpxdWVyeSBhbHdheXMgcmV3cmFwcywgd2hlcmVhcyB3ZSBuZWVkIHRvIHByZXNlcnZlIHRoZSBvcmlnaW5hbCBzZWxlY3RvciBzbyB0aGF0IHdlIGNhbiBtb2RpZnkgaXQuCiAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGVzID0ganFMaXRlKCRjb21waWxlTm9kZXMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIFdlIGNhbiBub3QgY29tcGlsZSB0b3AgbGV2ZWwgdGV4dCBlbGVtZW50cyBzaW5jZSB0ZXh0IG5vZGVzIGNhbiBiZSBtZXJnZWQgYW5kIHdlIHdpbGwKICAgICAgICAgICAgICAgICAgLy8gbm90IGJlIGFibGUgdG8gYXR0YWNoIHNjb3BlIGRhdGEgdG8gdGhlbSwgc28gd2Ugd2lsbCB3cmFwIHRoZW0gaW4gPHNwYW4+CiAgICAgICAgICAgICAgICAgIGZvckVhY2goJGNvbXBpbGVOb2RlcywgZnVuY3Rpb24gKG5vZGUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAzIC8qIHRleHQgbm9kZSAqLyAmJiBub2RlLm5vZGVWYWx1ZS5tYXRjaCgvXFMrLykgLyogbm9uLWVtcHR5ICovKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2Rlc1tpbmRleF0gPSBub2RlID0ganFMaXRlKG5vZGUpLndyYXAoJzxzcGFuPjwvc3Bhbj4nKS5wYXJlbnQoKVswXTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBjb21wb3NpdGVMaW5rRm4gPSBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlcywgdHJhbnNjbHVkZUZuLCAkY29tcGlsZU5vZGVzLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHB1YmxpY0xpbmtGbihzY29wZSwgY2xvbmVDb25uZWN0Rm4pIHsKICAgICAgICAgICAgICAgICAgICAgIGFzc2VydEFyZyhzY29wZSwgJ3Njb3BlJyk7CiAgICAgICAgICAgICAgICAgICAgICAvLyBpbXBvcnRhbnQhITogd2UgbXVzdCBjYWxsIG91ciBqcUxpdGUuY2xvbmUoKSBzaW5jZSB0aGUgalF1ZXJ5IG9uZSBpcyB0cnlpbmcgdG8gYmUgc21hcnQKICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBzb21ldGltZXMgY2hhbmdlcyB0aGUgc3RydWN0dXJlIG9mIHRoZSBET00uCiAgICAgICAgICAgICAgICAgICAgICB2YXIgJGxpbmtOb2RlID0gY2xvbmVDb25uZWN0Rm4KICAgICAgICAgICAgICAgICAgICAgICAgPyBKUUxpdGVQcm90b3R5cGUuY2xvbmUuY2FsbCgkY29tcGlsZU5vZGVzKSAvLyBJTVBPUlRBTlQhISEKICAgICAgICAgICAgICAgICAgICAgICAgOiAkY29tcGlsZU5vZGVzOwoKICAgICAgICAgICAgICAgICAgICAgIC8vIEF0dGFjaCBzY29wZSBvbmx5IHRvIG5vbi10ZXh0IG5vZGVzLgogICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gJGxpbmtOb2RlLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZSA9ICRsaW5rTm9kZVtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAxIC8qIGVsZW1lbnQgKi8gfHwgbm9kZS5ub2RlVHlwZSA9PSA5IC8qIGRvY3VtZW50ICovKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRsaW5rTm9kZS5lcShpKS5kYXRhKCckc2NvcGUnLCBzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKCRsaW5rTm9kZSwgJ25nLXNjb3BlJyk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoY2xvbmVDb25uZWN0Rm4pIGNsb25lQ29ubmVjdEZuKCRsaW5rTm9kZSwgc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBvc2l0ZUxpbmtGbikgY29tcG9zaXRlTGlua0ZuKHNjb3BlLCAkbGlua05vZGUsICRsaW5rTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGxpbmtOb2RlOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZnVuY3Rpb24gc2FmZUFkZENsYXNzKCRlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIGlnbm9yZSwgc2luY2UgaXQgbWVhbnMgdGhhdCB3ZSBhcmUgdHJ5aW5nIHRvIHNldCBjbGFzcyBvbgogICAgICAgICAgICAgICAgICAgICAgLy8gU1ZHIGVsZW1lbnQsIHdoZXJlIGNsYXNzIG5hbWUgaXMgcmVhZC1vbmx5LgogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgKiBDb21waWxlIGZ1bmN0aW9uIG1hdGNoZXMgZWFjaCBub2RlIGluIG5vZGVMaXN0IGFnYWluc3QgdGhlIGRpcmVjdGl2ZXMuIE9uY2UgYWxsIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICAgKiBmb3IgYSBwYXJ0aWN1bGFyIG5vZGUgYXJlIGNvbGxlY3RlZCB0aGVpciBjb21waWxlIGZ1bmN0aW9ucyBhcmUgZXhlY3V0ZWQuIFRoZSBjb21waWxlCiAgICAgICAgICAgICAgICogZnVuY3Rpb25zIHJldHVybiB2YWx1ZXMgLSB0aGUgbGlua2luZyBmdW5jdGlvbnMgLSBhcmUgY29tYmluZWQgaW50byBhIGNvbXBvc2l0ZSBsaW5raW5nCiAgICAgICAgICAgICAgICogZnVuY3Rpb24sIHdoaWNoIGlzIHRoZSBhIGxpbmtpbmcgZnVuY3Rpb24gZm9yIHRoZSBub2RlLgogICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICogQHBhcmFtIHtOb2RlTGlzdH0gbm9kZUxpc3QgYW4gYXJyYXkgb2Ygbm9kZXMgb3IgTm9kZUxpc3QgdG8gY29tcGlsZQogICAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZVssIGNsb25lQXR0YWNoRm5dfSB0cmFuc2NsdWRlRm4gQSBsaW5raW5nIGZ1bmN0aW9uLCB3aGVyZSB0aGUKICAgICAgICAgICAgICAgKiAgICAgICAgc2NvcGUgYXJndW1lbnQgaXMgYXV0by1nZW5lcmF0ZWQgdG8gdGhlIG5ldyBjaGlsZCBvZiB0aGUgdHJhbnNjbHVkZWQgcGFyZW50IHNjb3BlLgogICAgICAgICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudD19ICRyb290RWxlbWVudCBJZiB0aGUgbm9kZUxpc3QgaXMgdGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGF0aW9uIHRyZWUgdGhlbiB0aGUKICAgICAgICAgICAgICAgKiAgICAgICAgcm9vdEVsZW1lbnQgbXVzdCBiZSBzZXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIG9mIHRoZSBjb21waWxlIHJvb3QuIFRoaXMgaXMKICAgICAgICAgICAgICAgKiAgICAgICAgbmVlZGVkIHNvIHRoYXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIGl0ZW1zIGNhbiBiZSByZXBsYWNlZCB3aXRoIHdpZGdldHMuCiAgICAgICAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBtYXggZGlyZWN0aXZlIHByaW9yaXR5CiAgICAgICAgICAgICAgICogQHJldHVybnMgez9mdW5jdGlvbn0gQSBjb21wb3NpdGUgbGlua2luZyBmdW5jdGlvbiBvZiBhbGwgb2YgdGhlIG1hdGNoZWQgZGlyZWN0aXZlcyBvciBudWxsLgogICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVOb2Rlcyhub2RlTGlzdCwgdHJhbnNjbHVkZUZuLCAkcm9vdEVsZW1lbnQsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGxpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBkaXJlY3RpdmVzLCBhdHRycywgbGlua0ZuRm91bmQ7CgogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGVMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICBhdHRycyA9IG5ldyBBdHRyaWJ1dGVzKCk7CgogICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbXVzdCBhbHdheXMgcmVmZXIgdG8gbm9kZUxpc3RbaV0gc2luY2UgdGhlIG5vZGVzIGNhbiBiZSByZXBsYWNlZCB1bmRlcm5lYXRoIHVzLgogICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcyA9IGNvbGxlY3REaXJlY3RpdmVzKG5vZGVMaXN0W2ldLCBbXSwgYXR0cnMsIGkgPT0gMCA/IG1heFByaW9yaXR5IDogdW5kZWZpbmVkLCBpZ25vcmVEaXJlY3RpdmUpOwoKICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4gPSAoZGlyZWN0aXZlcy5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyBhcHBseURpcmVjdGl2ZXNUb05vZGUoZGlyZWN0aXZlcywgbm9kZUxpc3RbaV0sIGF0dHJzLCB0cmFuc2NsdWRlRm4sICRyb290RWxlbWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgY2hpbGRMaW5rRm4gPSAobm9kZUxpbmtGbiAmJiBub2RlTGlua0ZuLnRlcm1pbmFsIHx8ICFub2RlTGlzdFtpXS5jaGlsZE5vZGVzIHx8ICFub2RlTGlzdFtpXS5jaGlsZE5vZGVzLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICA/IG51bGwKICAgICAgICAgICAgICAgICAgICAgICAgICA6IGNvbXBpbGVOb2Rlcyhub2RlTGlzdFtpXS5jaGlsZE5vZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA/IG5vZGVMaW5rRm4udHJhbnNjbHVkZSA6IHRyYW5zY2x1ZGVGbik7CgogICAgICAgICAgICAgICAgICAgICAgbGlua0Zucy5wdXNoKG5vZGVMaW5rRm4pOwogICAgICAgICAgICAgICAgICAgICAgbGlua0Zucy5wdXNoKGNoaWxkTGlua0ZuKTsKICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbkZvdW5kID0gKGxpbmtGbkZvdW5kIHx8IG5vZGVMaW5rRm4gfHwgY2hpbGRMaW5rRm4pOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyByZXR1cm4gYSBsaW5raW5nIGZ1bmN0aW9uIGlmIHdlIGhhdmUgZm91bmQgYW55dGhpbmcsIG51bGwgb3RoZXJ3aXNlCiAgICAgICAgICAgICAgICAgIHJldHVybiBsaW5rRm5Gb3VuZCA/IGNvbXBvc2l0ZUxpbmtGbiA6IG51bGw7CgogICAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb21wb3NpdGVMaW5rRm4oc2NvcGUsIG5vZGVMaXN0LCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZUxpbmtGbiwgY2hpbGRMaW5rRm4sIG5vZGUsIGNoaWxkU2NvcGUsIGNoaWxkVHJhbnNjbHVkZUZuLCBpLCBpaSwgbjsKCiAgICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IG5vZGVMaXN0IHNvIHRoYXQgbGlua2luZyBkb2Vzbid0IGJyZWFrIGR1ZSB0byBsaXZlIGxpc3QgdXBkYXRlcy4KICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFibGVOb2RlTGlzdCA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWkgPSBub2RlTGlzdC5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhYmxlTm9kZUxpc3QucHVzaChub2RlTGlzdFtpXSk7CiAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbiA9IDAsIGlpID0gbGlua0Zucy5sZW5ndGg7IGkgPCBpaTsgbisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHN0YWJsZU5vZGVMaXN0W25dOwogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4gPSBsaW5rRm5zW2krK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRMaW5rRm4gPSBsaW5rRm5zW2krK107CgogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTGlua0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlTGlua0ZuLnNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGUuJG5ldyhpc09iamVjdChub2RlTGlua0ZuLnNjb3BlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqcUxpdGUobm9kZSkuZGF0YSgnJHNjb3BlJywgY2hpbGRTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBub2RlTGlua0ZuLnRyYW5zY2x1ZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFRyYW5zY2x1ZGVGbiB8fCAoIWJvdW5kVHJhbnNjbHVkZUZuICYmIHRyYW5zY2x1ZGVGbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIGNoaWxkU2NvcGUsIG5vZGUsICRyb290RWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKHRyYW5zY2x1ZGVGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGNsb25lRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2NsdWRlU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2NsdWRlU2NvcGUuJCR0cmFuc2NsdWRlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRyYW5zY2x1ZGVGbih0cmFuc2NsdWRlU2NvcGUsIGNsb25lRm4pLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uKCckZGVzdHJveScsIGJpbmQodHJhbnNjbHVkZVNjb3BlLCB0cmFuc2NsdWRlU2NvcGUuJGRlc3Ryb3kpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KShjaGlsZFRyYW5zY2x1ZGVGbiB8fCB0cmFuc2NsdWRlRm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgY2hpbGRTY29wZSwgbm9kZSwgdW5kZWZpbmVkLCBib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkTGlua0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuKHNjb3BlLCBub2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAqIExvb2tzIGZvciBkaXJlY3RpdmVzIG9uIHRoZSBnaXZlbiBub2RlIGFuZCBhZGRzIHRoZW0gdG8gdGhlIGRpcmVjdGl2ZSBjb2xsZWN0aW9uIHdoaWNoIGlzCiAgICAgICAgICAgICAgICogc29ydGVkLgogICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBzZWFyY2guCiAgICAgICAgICAgICAgICogQHBhcmFtIGRpcmVjdGl2ZXMgQW4gYXJyYXkgdG8gd2hpY2ggdGhlIGRpcmVjdGl2ZXMgYXJlIGFkZGVkIHRvLiBUaGlzIGFycmF5IGlzIHNvcnRlZCBiZWZvcmUKICAgICAgICAgICAgICAgKiAgICAgICAgdGhlIGZ1bmN0aW9uIHJldHVybnMuCiAgICAgICAgICAgICAgICogQHBhcmFtIGF0dHJzIFRoZSBzaGFyZWQgYXR0cnMgb2JqZWN0IHdoaWNoIGlzIHVzZWQgdG8gcG9wdWxhdGUgdGhlIG5vcm1hbGl6ZWQgYXR0cmlidXRlcy4KICAgICAgICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG1heFByaW9yaXR5IE1heCBkaXJlY3RpdmUgcHJpb3JpdHkuCiAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgZnVuY3Rpb24gY29sbGVjdERpcmVjdGl2ZXMobm9kZSwgZGlyZWN0aXZlcywgYXR0cnMsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZSwKICAgICAgICAgICAgICAgICAgICAgIGF0dHJzTWFwID0gYXR0cnMuJGF0dHIsCiAgICAgICAgICAgICAgICAgICAgICBtYXRjaCwKICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTsKCiAgICAgICAgICAgICAgICAgIHN3aXRjaCAobm9kZVR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTogLyogRWxlbWVudCAqLwogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVzZSB0aGUgbm9kZSBuYW1lOiA8ZGlyZWN0aXZlPgogICAgICAgICAgICAgICAgICAgICAgICAgIGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVOb3JtYWxpemUobm9kZU5hbWVfKG5vZGUpLnRvTG93ZXJDYXNlKCkpLCAnRScsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgdGhlIGF0dHJpYnV0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBhdHRyLCBuYW1lLCBuTmFtZSwgbmdBdHRyTmFtZSwgdmFsdWUsIG5BdHRycyA9IG5vZGUuYXR0cmlidXRlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqID0gMCwgamogPSBuQXR0cnMgJiYgbkF0dHJzLmxlbmd0aDsgaiA8IGpqOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJTdGFydE5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRyRW5kTmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ciA9IG5BdHRyc1tqXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtc2llIHx8IG1zaWUgPj0gOCB8fCBhdHRyLnNwZWNpZmllZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IGF0dHIubmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN1cHBvcnQgbmdBdHRyIGF0dHJpYnV0ZSBiaW5kaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZ0F0dHJOYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE5HX0FUVFJfQklORElORy50ZXN0KG5nQXR0ck5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IG5nQXR0ck5hbWUuc3Vic3RyKDYpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGluZGV4ID0gbmdBdHRyTmFtZS5sYXN0SW5kZXhPZignU3RhcnQnKSkgIT0gLTEgJiYgaW5kZXggPT0gbmdBdHRyTmFtZS5sZW5ndGggLSA1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0clN0YXJ0TmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ckVuZE5hbWUgPSBuYW1lLnN1YnN0cigwLCBuYW1lLmxlbmd0aCAtIDUpICsgJ2VuZCc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyKDAsIG5hbWUubGVuZ3RoIC0gNik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNNYXBbbk5hbWVdID0gbmFtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHZhbHVlID0gdHJpbSgobXNpZSAmJiBuYW1lID09ICdocmVmJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBkZWNvZGVVUklDb21wb25lbnQobm9kZS5nZXRBdHRyaWJ1dGUobmFtZSwgMikpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogYXR0ci52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ2V0Qm9vbGVhbkF0dHJOYW1lKG5vZGUsIG5OYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRydWU7IC8vIHByZXNlbmNlIG1lYW5zIHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEF0dHJJbnRlcnBvbGF0ZURpcmVjdGl2ZShub2RlLCBkaXJlY3RpdmVzLCB2YWx1ZSwgbk5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQScsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsIGF0dHJTdGFydE5hbWUsIGF0dHJFbmROYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXNlIGNsYXNzIGFzIGRpcmVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9IG5vZGUuY2xhc3NOYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyhjbGFzc05hbWUpICYmIGNsYXNzTmFtZSAhPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG1hdGNoID0gQ0xBU1NfRElSRUNUSVZFX1JFR0VYUC5leGVjKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG1hdGNoWzJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhZGREaXJlY3RpdmUoZGlyZWN0aXZlcywgbk5hbWUsICdDJywgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB0cmltKG1hdGNoWzNdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZS5zdWJzdHIobWF0Y2guaW5kZXggKyBtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSAzOiAvKiBUZXh0IE5vZGUgKi8KICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRUZXh0SW50ZXJwb2xhdGVEaXJlY3RpdmUoZGlyZWN0aXZlcywgbm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSA4OiAvKiBDb21tZW50ICovCiAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBDT01NRU5UX0RJUkVDVElWRV9SRUdFWFAuZXhlYyhub2RlLm5vZGVWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ00nLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRyaW0obWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0dXJucyBvdXQgdGhhdCB1bmRlciBzb21lIGNpcmN1bXN0YW5jZXMgSUU5IHRocm93cyBlcnJvcnMgd2hlbiBvbmUgYXR0ZW1wdHMgdG8gcmVhZCBjb21tZW50J3Mgbm9kZSB2YWx1ZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSnVzdCBpZ25vcmUgaXQgYW5kIGNvbnRpbnVlLiAoQ2FuJ3Qgc2VlbSB0byByZXByb2R1Y2UgaW4gdGVzdCBjYXNlLikKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMuc29ydChieVByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpcmVjdGl2ZXM7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgKiBHaXZlbiBhIG5vZGUgd2l0aCBhbiBkaXJlY3RpdmUtc3RhcnQgaXQgY29sbGVjdHMgYWxsIG9mIHRoZSBzaWJsaW5ncyB1bnRpbCBpdCBmaW5kIGRpcmVjdGl2ZS1lbmQuCiAgICAgICAgICAgICAgICogQHBhcmFtIG5vZGUKICAgICAgICAgICAgICAgKiBAcGFyYW0gYXR0clN0YXJ0CiAgICAgICAgICAgICAgICogQHBhcmFtIGF0dHJFbmQKICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0KICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICBmdW5jdGlvbiBncm91cFNjYW4obm9kZSwgYXR0clN0YXJ0LCBhdHRyRW5kKSB7CiAgICAgICAgICAgICAgICAgIHZhciBub2RlcyA9IFtdOwogICAgICAgICAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgICAgICAgICBpZiAoYXR0clN0YXJ0ICYmIG5vZGUuaGFzQXR0cmlidXRlICYmIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJTdGFydCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFydE5vZGUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndXRlcmRpcicsICJVbnRlcm1pbmF0ZWQgYXR0cmlidXRlLCBmb3VuZCAnezB9JyBidXQgbm8gbWF0Y2hpbmcgJ3sxfScgZm91bmQuIiwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSAvKiogRWxlbWVudCAqKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJTdGFydCkpIGRlcHRoKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZShhdHRyRW5kKSkgZGVwdGgtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXMucHVzaChub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRlcHRoID4gMCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBub2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBqcUxpdGUobm9kZXMpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICogV3JhcHBlciBmb3IgbGlua2luZyBmdW5jdGlvbiB3aGljaCBjb252ZXJ0cyBub3JtYWwgbGlua2luZyBmdW5jdGlvbiBpbnRvIGEgZ3JvdXBlZAogICAgICAgICAgICAgICAqIGxpbmtpbmcgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICogQHBhcmFtIGxpbmtGbgogICAgICAgICAgICAgICAqIEBwYXJhbSBhdHRyU3RhcnQKICAgICAgICAgICAgICAgKiBAcGFyYW0gYXR0ckVuZAogICAgICAgICAgICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0KICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICBmdW5jdGlvbiBncm91cEVsZW1lbnRzTGlua0ZuV3JhcHBlcihsaW5rRm4sIGF0dHJTdGFydCwgYXR0ckVuZCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBncm91cFNjYW4oZWxlbWVudFswXSwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsaW5rRm4oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjb250cm9sbGVycyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAqIE9uY2UgdGhlIGRpcmVjdGl2ZXMgaGF2ZSBiZWVuIGNvbGxlY3RlZCwgdGhlaXIgY29tcGlsZSBmdW5jdGlvbnMgYXJlIGV4ZWN1dGVkLiBUaGlzIG1ldGhvZAogICAgICAgICAgICAgICAqIGlzIHJlc3BvbnNpYmxlIGZvciBpbmxpbmluZyBkaXJlY3RpdmUgdGVtcGxhdGVzIGFzIHdlbGwgYXMgdGVybWluYXRpbmcgdGhlIGFwcGxpY2F0aW9uCiAgICAgICAgICAgICAgICogb2YgdGhlIGRpcmVjdGl2ZXMgaWYgdGhlIHRlcm1pbmFsIGRpcmVjdGl2ZSBoYXMgYmVlbiByZWFjaGVkLgogICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheX0gZGlyZWN0aXZlcyBBcnJheSBvZiBjb2xsZWN0ZWQgZGlyZWN0aXZlcyB0byBleGVjdXRlIHRoZWlyIGNvbXBpbGUgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICogICAgICAgIHRoaXMgbmVlZHMgdG8gYmUgcHJlLXNvcnRlZCBieSBwcmlvcml0eSBvcmRlci4KICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGV9IGNvbXBpbGVOb2RlIFRoZSByYXcgRE9NIG5vZGUgdG8gYXBwbHkgdGhlIGNvbXBpbGUgZnVuY3Rpb25zIHRvCiAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRlbXBsYXRlQXR0cnMgVGhlIHNoYXJlZCBhdHRyaWJ1dGUgZnVuY3Rpb24KICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGFuZ3VsYXIuU2NvcGVbLCBjbG9uZUF0dGFjaEZuXX0gdHJhbnNjbHVkZUZuIEEgbGlua2luZyBmdW5jdGlvbiwgd2hlcmUgdGhlCiAgICAgICAgICAgICAgICogICAgICAgIHNjb3BlIGFyZ3VtZW50IGlzIGF1dG8tZ2VuZXJhdGVkIHRvIHRoZSBuZXcgY2hpbGQgb2YgdGhlIHRyYW5zY2x1ZGVkIHBhcmVudCBzY29wZS4KICAgICAgICAgICAgICAgKiBAcGFyYW0ge0pRTGl0ZX0ganFDb2xsZWN0aW9uIElmIHdlIGFyZSB3b3JraW5nIG9uIHRoZSByb290IG9mIHRoZSBjb21waWxlIHRyZWUgdGhlbiB0aGlzCiAgICAgICAgICAgICAgICogICAgICAgIGFyZ3VtZW50IGhhcyB0aGUgcm9vdCBqcUxpdGUgYXJyYXkgc28gdGhhdCB3ZSBjYW4gcmVwbGFjZSBub2RlcyBvbiBpdC4KICAgICAgICAgICAgICAgKiBAcmV0dXJucyBsaW5rRm4KICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICBmdW5jdGlvbiBhcHBseURpcmVjdGl2ZXNUb05vZGUoZGlyZWN0aXZlcywgY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIHRyYW5zY2x1ZGVGbiwganFDb2xsZWN0aW9uLCBvcmlnaW5hbFJlcGxhY2VEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgdmFyIHRlcm1pbmFsUHJpb3JpdHkgPSAtTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICAgICAgICAgICAgICAgIHByZUxpbmtGbnMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgIHBvc3RMaW5rRm5zID0gW10sCiAgICAgICAgICAgICAgICAgICAgICBuZXdTY29wZURpcmVjdGl2ZSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlID0gdGVtcGxhdGVBdHRycy4kJGVsZW1lbnQgPSBqcUxpdGUoY29tcGlsZU5vZGUpLAogICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSwKICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlRGlyZWN0aXZlID0gb3JpZ2luYWxSZXBsYWNlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSB0cmFuc2NsdWRlRm4sCiAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcywKICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbiwKICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlOwoKICAgICAgICAgICAgICAgICAgLy8gZXhlY3V0ZXMgYWxsIGRpcmVjdGl2ZXMgb24gdGhlIGN1cnJlbnQgZWxlbWVudAogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0clN0YXJ0ID0gZGlyZWN0aXZlLiQkc3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0ckVuZCA9IGRpcmVjdGl2ZS4kJGVuZDsKCiAgICAgICAgICAgICAgICAgICAgICAvLyBjb2xsZWN0IG11bHRpYmxvY2sgc2VjdGlvbnMKICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHRyU3RhcnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUgPSBncm91cFNjYW4oY29tcGlsZU5vZGUsIGF0dHJTdGFydCwgYXR0ckVuZCkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICAgICAgICBpZiAodGVybWluYWxQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOyAvLyBwcmV2ZW50IGZ1cnRoZXIgcHJvY2Vzc2luZyBvZiBkaXJlY3RpdmVzCiAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ2lzb2xhdGVkIHNjb3BlJywgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KGRpcmVjdGl2ZVZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGNvbXBpbGVOb2RlLCAnbmctaXNvbGF0ZS1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkY29tcGlsZU5vZGUsICduZy1zY29wZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1Njb3BlRGlyZWN0aXZlID0gbmV3U2NvcGVEaXJlY3RpdmUgfHwgZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmUubmFtZTsKCiAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUuY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzID0gY29udHJvbGxlckRpcmVjdGl2ZXMgfHwge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoIiciICsgZGlyZWN0aXZlTmFtZSArICInIGNvbnRyb2xsZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS50cmFuc2NsdWRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RyYW5zY2x1c2lvbicsIHRyYW5zY2x1ZGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2NsdWRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRlcm1pbmFsUHJpb3JpdHkgPSBkaXJlY3RpdmUucHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID09ICdlbGVtZW50JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBncm91cFNjYW4oY29tcGlsZU5vZGUsIGF0dHJTdGFydCwgYXR0ckVuZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlID0gdGVtcGxhdGVBdHRycy4kJGVsZW1lbnQgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganFMaXRlKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyAnICsgZGlyZWN0aXZlTmFtZSArICc6ICcgKyB0ZW1wbGF0ZUF0dHJzW2RpcmVjdGl2ZU5hbWVdICsgJyAnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlV2l0aChqcUNvbGxlY3Rpb24sIGpxTGl0ZShzbGljZUFyZ3MoJHRlbXBsYXRlKSksIGNvbXBpbGVOb2RlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gY29tcGlsZSgkdGVtcGxhdGUsIHRyYW5zY2x1ZGVGbiwgdGVybWluYWxQcmlvcml0eSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VEaXJlY3RpdmUgJiYgcmVwbGFjZURpcmVjdGl2ZS5uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoSlFMaXRlQ2xvbmUoY29tcGlsZU5vZGUpKS5jb250ZW50cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbCgnJyk7IC8vIGNsZWFyIGNvbnRlbnRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gY29tcGlsZSgkdGVtcGxhdGUsIHRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgndGVtcGxhdGUnLCB0ZW1wbGF0ZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZSA9IChpc0Z1bmN0aW9uKGRpcmVjdGl2ZS50ZW1wbGF0ZSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZGlyZWN0aXZlLnRlbXBsYXRlKCRjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBkaXJlY3RpdmUudGVtcGxhdGU7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlID0gZGVub3JtYWxpemVUZW1wbGF0ZShkaXJlY3RpdmVWYWx1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUucmVwbGFjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoJzxkaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyaW0oZGlyZWN0aXZlVmFsdWUpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nKS5jb250ZW50cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSA9ICR0ZW1wbGF0ZVswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdGVtcGxhdGUubGVuZ3RoICE9IDEgfHwgY29tcGlsZU5vZGUubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCd0cGxydCcsICJUZW1wbGF0ZSBmb3IgZGlyZWN0aXZlICd7MH0nIG11c3QgaGF2ZSBleGFjdGx5IG9uZSByb290IGVsZW1lbnQuIHsxfSIsIGRpcmVjdGl2ZU5hbWUsICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgoanFDb2xsZWN0aW9uLCAkY29tcGlsZU5vZGUsIGNvbXBpbGVOb2RlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdUZW1wbGF0ZUF0dHJzID0geyAkYXR0cjoge30gfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbWJpbmUgZGlyZWN0aXZlcyBmcm9tIHRoZSBvcmlnaW5hbCBub2RlIGFuZCBmcm9tIHRoZSB0ZW1wbGF0ZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSB0YWtlIHRoZSBhcnJheSBvZiBkaXJlY3RpdmVzIGZvciB0aGlzIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBzcGxpdCBpdCBpbnRvIHR3byBwYXJ0cywgdGhvc2UgdGhhdCB3ZXJlIGFscmVhZHkgYXBwbGllZCBhbmQgdGhvc2UgdGhhdCB3ZXJlbid0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0gY29sbGVjdCBkaXJlY3RpdmVzIGZyb20gdGhlIHRlbXBsYXRlLCBhZGQgdGhlbSB0byB0aGUgc2Vjb25kIGdyb3VwIGFuZCBzb3J0IHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBhcHBlbmQgdGhlIHNlY29uZCBncm91cCB3aXRoIG5ldyBkaXJlY3RpdmVzIHRvIHRoZSBmaXJzdCBncm91cAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzID0gZGlyZWN0aXZlcy5jb25jYXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0RGlyZWN0aXZlcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnNwbGljZShpICsgMSwgZGlyZWN0aXZlcy5sZW5ndGggLSAoaSArIDEpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUZW1wbGF0ZUF0dHJzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKHRlbXBsYXRlQXR0cnMsIG5ld1RlbXBsYXRlQXR0cnMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbChkaXJlY3RpdmVWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVtcGxhdGVVcmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgndGVtcGxhdGUnLCB0ZW1wbGF0ZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlLnJlcGxhY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLnNwbGljZShpLCBkaXJlY3RpdmVzLmxlbmd0aCAtIGkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLCAkY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMsIGpxQ29sbGVjdGlvbiwgY2hpbGRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRpcmVjdGl2ZS5jb21waWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuID0gZGlyZWN0aXZlLmNvbXBpbGUoJGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCBjaGlsZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGxpbmtGbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZExpbmtGbnMobnVsbCwgbGlua0ZuLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGxpbmtGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTGlua0ZucyhsaW5rRm4ucHJlLCBsaW5rRm4ucG9zdCwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGNvbXBpbGVOb2RlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVybWluYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlTGlua0ZuLnRlcm1pbmFsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXJtaW5hbFByaW9yaXR5ID0gTWF0aC5tYXgodGVybWluYWxQcmlvcml0eSwgZGlyZWN0aXZlLnByaW9yaXR5KTsKICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4uc2NvcGUgPSBuZXdTY29wZURpcmVjdGl2ZSAmJiBuZXdTY29wZURpcmVjdGl2ZS5zY29wZTsKICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbi50cmFuc2NsdWRlID0gdHJhbnNjbHVkZURpcmVjdGl2ZSAmJiBjaGlsZFRyYW5zY2x1ZGVGbjsKCiAgICAgICAgICAgICAgICAgIC8vIG1pZ2h0IGJlIG5vcm1hbCBvciBkZWxheWVkIG5vZGVMaW5rRm4gZGVwZW5kaW5nIG9uIGlmIHRlbXBsYXRlVXJsIGlzIHByZXNlbnQKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGVMaW5rRm47CgogICAgICAgICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gYWRkTGlua0ZucyhwcmUsIHBvc3QsIGF0dHJTdGFydCwgYXR0ckVuZCkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKHByZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHRyU3RhcnQpIHByZSA9IGdyb3VwRWxlbWVudHNMaW5rRm5XcmFwcGVyKHByZSwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHByZUxpbmtGbnMucHVzaChwcmUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0clN0YXJ0KSBwb3N0ID0gZ3JvdXBFbGVtZW50c0xpbmtGbldyYXBwZXIocG9zdCwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0LnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0TGlua0Zucy5wdXNoKHBvc3QpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q29udHJvbGxlcnMocmVxdWlyZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSwgcmV0cmlldmFsTWV0aG9kID0gJ2RhdGEnLCBvcHRpb25hbCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHJlcXVpcmUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCh2YWx1ZSA9IHJlcXVpcmUuY2hhckF0KDApKSA9PSAnXicgfHwgdmFsdWUgPT0gJz8nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmUgPSByZXF1aXJlLnN1YnN0cigxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09ICdeJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0cmlldmFsTWV0aG9kID0gJ2luaGVyaXRlZERhdGEnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbmFsID0gb3B0aW9uYWwgfHwgdmFsdWUgPT0gJz8nOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICRlbGVtZW50W3JldHJpZXZhbE1ldGhvZF0oJyQnICsgcmVxdWlyZSArICdDb250cm9sbGVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZSAmJiAhb3B0aW9uYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ2N0cmVxJywgIkNvbnRyb2xsZXIgJ3swfScsIHJlcXVpcmVkIGJ5IGRpcmVjdGl2ZSAnezF9JywgY2FuJ3QgYmUgZm91bmQhIiwgcmVxdWlyZSwgZGlyZWN0aXZlTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShyZXF1aXJlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChyZXF1aXJlLCBmdW5jdGlvbiAocmVxdWlyZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKGdldENvbnRyb2xsZXJzKHJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICBmdW5jdGlvbiBub2RlTGlua0ZuKGNoaWxkTGlua0ZuLCBzY29wZSwgbGlua05vZGUsICRyb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRycywgJGVsZW1lbnQsIGksIGlpLCBsaW5rRm4sIGNvbnRyb2xsZXI7CgogICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBpbGVOb2RlID09PSBsaW5rTm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzID0gdGVtcGxhdGVBdHRyczsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSBzaGFsbG93Q29weSh0ZW1wbGF0ZUF0dHJzLCBuZXcgQXR0cmlidXRlcyhqcUxpdGUobGlua05vZGUpLCB0ZW1wbGF0ZUF0dHJzLiRhdHRyKSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAkZWxlbWVudCA9IGF0dHJzLiQkZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIExPQ0FMX1JFR0VYUCA9IC9eXHMqKFtAPSZdKShcPz8pXHMqKFx3KilccyokLzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFNjb3BlID0gc2NvcGUuJHBhcmVudCB8fCBzY29wZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUuc2NvcGUsIGZ1bmN0aW9uIChkZWZpbml0aW9uLCBzY29wZU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZGVmaW5pdGlvbi5tYXRjaChMT0NBTF9SRUdFWFApIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ck5hbWUgPSBtYXRjaFszXSB8fCBzY29wZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25hbCA9IChtYXRjaFsyXSA9PSAnPycpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZSA9IG1hdGNoWzFdLCAvLyBALCA9LCBvciAmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRHZXQsIHBhcmVudFNldDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiQkaXNvbGF0ZUJpbmRpbmdzW3Njb3BlTmFtZV0gPSBtb2RlICsgYXR0ck5hbWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdAJzogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKGF0dHJOYW1lLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVbc2NvcGVOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzLiQkb2JzZXJ2ZXJzW2F0dHJOYW1lXS4kJHNjb3BlID0gcGFyZW50U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJzW2F0dHJOYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgYXR0cmlidXRlIGhhcyBiZWVuIHByb3ZpZGVkIHRoZW4gd2UgdHJpZ2dlciBhbiBpbnRlcnBvbGF0aW9uIHRvIGVuc3VyZSB0aGUgdmFsdWUgaXMgdGhlcmUgZm9yIHVzZSBpbiB0aGUgbGluayBmbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gJGludGVycG9sYXRlKGF0dHJzW2F0dHJOYW1lXSkocGFyZW50U2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICc9JzogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25hbCAmJiAhYXR0cnNbYXR0ck5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50R2V0ID0gJHBhcnNlKGF0dHJzW2F0dHJOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U2V0ID0gcGFyZW50R2V0LmFzc2lnbiB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlc2V0IHRoZSBjaGFuZ2UsIG9yIHdlIHdpbGwgdGhyb3cgdGhpcyBleGNlcHRpb24gb24gZXZlcnkgJGRpZ2VzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdID0gcGFyZW50R2V0KHBhcmVudFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ25vbmFzc2lnbicsICJFeHByZXNzaW9uICd7MH0nIHVzZWQgd2l0aCBkaXJlY3RpdmUgJ3sxfScgaXMgbm9uLWFzc2lnbmFibGUhIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzW2F0dHJOYW1lXSwgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gc2NvcGVbc2NvcGVOYW1lXSA9IHBhcmVudEdldChwYXJlbnRTY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIHBhcmVudFZhbHVlV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRWYWx1ZSA9IHBhcmVudEdldChwYXJlbnRTY29wZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VmFsdWUgIT09IHNjb3BlW3Njb3BlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBvdXQgb2Ygc3luYyBhbmQgbmVlZCB0byBjb3B5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VmFsdWUgIT09IGxhc3RWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBhcmVudCBjaGFuZ2VkIGFuZCBpdCBoYXMgcHJlY2VkZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IHNjb3BlW3Njb3BlTmFtZV0gPSBwYXJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHBhcmVudCBjYW4gYmUgYXNzaWduZWQgdGhlbiBkbyBzbwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFNldChwYXJlbnRTY29wZSwgcGFyZW50VmFsdWUgPSBsYXN0VmFsdWUgPSBzY29wZVtzY29wZU5hbWVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnJic6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRHZXQgPSAkcGFyc2UoYXR0cnNbYXR0ck5hbWVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gZnVuY3Rpb24gKGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50R2V0KHBhcmVudFNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCdpc2NwJywgIkludmFsaWQgaXNvbGF0ZSBzY29wZSBkZWZpbml0aW9uIGZvciBkaXJlY3RpdmUgJ3swfScuIERlZmluaXRpb246IHsuLi4gezF9OiAnezJ9JyAuLi59IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUsIHNjb3BlTmFtZSwgZGVmaW5pdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udHJvbGxlckRpcmVjdGl2ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGNvbnRyb2xsZXJEaXJlY3RpdmVzLCBmdW5jdGlvbiAoZGlyZWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGU6IHNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQ6ICRlbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF0dHJzOiBhdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0cmFuc2NsdWRlOiBib3VuZFRyYW5zY2x1ZGVGbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBjb250cm9sbGVySW5zdGFuY2U7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyID0gZGlyZWN0aXZlLmNvbnRyb2xsZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVyID09ICdAJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlciA9IGF0dHJzW2RpcmVjdGl2ZS5uYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlckluc3RhbmNlID0gJGNvbnRyb2xsZXIoY29udHJvbGxlciwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuZGF0YSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICckJyArIGRpcmVjdGl2ZS5uYW1lICsgJ0NvbnRyb2xsZXInLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlckluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZS5jb250cm9sbGVyQXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2Fscy4kc2NvcGVbZGlyZWN0aXZlLmNvbnRyb2xsZXJBc10gPSBjb250cm9sbGVySW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAvLyBQUkVMSU5LSU5HCiAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpaSA9IHByZUxpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbiA9IHByZUxpbmtGbnNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbihzY29wZSwgJGVsZW1lbnQsIGF0dHJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLnJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAvLyBSRUNVUlNJT04KICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuICYmIGNoaWxkTGlua0ZuKHNjb3BlLCBsaW5rTm9kZS5jaGlsZE5vZGVzLCB1bmRlZmluZWQsIGJvdW5kVHJhbnNjbHVkZUZuKTsKCiAgICAgICAgICAgICAgICAgICAgICAvLyBQT1NUTElOS0lORwogICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWkgPSBwb3N0TGlua0Zucy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuID0gcG9zdExpbmtGbnNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtGbihzY29wZSwgJGVsZW1lbnQsIGF0dHJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLnJlcXVpcmUsICRlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAqIGxvb2tzIHVwIHRoZSBkaXJlY3RpdmUgYW5kIGRlY29yYXRlcyBpdCB3aXRoIGV4Y2VwdGlvbiBoYW5kbGluZyBhbmQgcHJvcGVyIHBhcmFtZXRlcnMuIFdlCiAgICAgICAgICAgICAgICogY2FsbCB0aGlzIHRoZSBib3VuZERpcmVjdGl2ZS4KICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIG5hbWUgb2YgdGhlIGRpcmVjdGl2ZSB0byBsb29rIHVwLgogICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhdGlvbiBUaGUgZGlyZWN0aXZlIG11c3QgYmUgZm91bmQgaW4gc3BlY2lmaWMgZm9ybWF0LgogICAgICAgICAgICAgICAqICAgU3RyaW5nIGNvbnRhaW5pbmcgYW55IG9mIHRoZXNlcyBjaGFyYWN0ZXJzOgogICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICogICAqIGBFYDogZWxlbWVudCBuYW1lCiAgICAgICAgICAgICAgICogICAqIGBBJzogYXR0cmlidXRlCiAgICAgICAgICAgICAgICogICAqIGBDYDogY2xhc3MKICAgICAgICAgICAgICAgKiAgICogYE1gOiBjb21tZW50CiAgICAgICAgICAgICAgICogQHJldHVybnMgdHJ1ZSBpZiBkaXJlY3RpdmUgd2FzIGFkZGVkLgogICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZERpcmVjdGl2ZSh0RGlyZWN0aXZlcywgbmFtZSwgbG9jYXRpb24sIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsIHN0YXJ0QXR0ck5hbWUsIGVuZEF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuYW1lID09PSBpZ25vcmVEaXJlY3RpdmUpIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoaGFzRGlyZWN0aXZlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgZGlyZWN0aXZlLCBkaXJlY3RpdmVzID0gJGluamVjdG9yLmdldChuYW1lICsgU3VmZml4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICBpID0gMCwgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUgPSBkaXJlY3RpdmVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKG1heFByaW9yaXR5ID09PSB1bmRlZmluZWQgfHwgbWF4UHJpb3JpdHkgPiBkaXJlY3RpdmUucHJpb3JpdHkpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0LmluZGV4T2YobG9jYXRpb24pICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnRBdHRyTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGluaGVyaXQoZGlyZWN0aXZlLCB7ICQkc3RhcnQ6IHN0YXJ0QXR0ck5hbWUsICQkZW5kOiBlbmRBdHRyTmFtZSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHREaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyAkZXhjZXB0aW9uSGFuZGxlcihlKTsgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgKiBXaGVuIHRoZSBlbGVtZW50IGlzIHJlcGxhY2VkIHdpdGggSFRNTCB0ZW1wbGF0ZSB0aGVuIHRoZSBuZXcgYXR0cmlidXRlcwogICAgICAgICAgICAgICAqIG9uIHRoZSB0ZW1wbGF0ZSBuZWVkIHRvIGJlIG1lcmdlZCB3aXRoIHRoZSBleGlzdGluZyBhdHRyaWJ1dGVzIGluIHRoZSBET00uCiAgICAgICAgICAgICAgICogVGhlIGRlc2lyZWQgZWZmZWN0IGlzIHRvIGhhdmUgYm90aCBvZiB0aGUgYXR0cmlidXRlcyBwcmVzZW50LgogICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGRzdCBkZXN0aW5hdGlvbiBhdHRyaWJ1dGVzIChvcmlnaW5hbCBET00pCiAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IHNyYyBzb3VyY2UgYXR0cmlidXRlcyAoZnJvbSB0aGUgZGlyZWN0aXZlIHRlbXBsYXRlKQogICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgIGZ1bmN0aW9uIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKGRzdCwgc3JjKSB7CiAgICAgICAgICAgICAgICAgIHZhciBzcmNBdHRyID0gc3JjLiRhdHRyLAogICAgICAgICAgICAgICAgICAgICAgZHN0QXR0ciA9IGRzdC4kYXR0ciwKICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50ID0gZHN0LiQkZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgIC8vIHJlYXBwbHkgdGhlIG9sZCBhdHRyaWJ1dGVzIHRvIHRoZSBuZXcgZWxlbWVudAogICAgICAgICAgICAgICAgICBmb3JFYWNoKGRzdCwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkuY2hhckF0KDApICE9ICckJykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcmNba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSArPSAoa2V5ID09PSAnc3R5bGUnID8gJzsnIDogJyAnKSArIHNyY1trZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBkc3QuJHNldChrZXksIHZhbHVlLCB0cnVlLCBzcmNBdHRyW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgIC8vIGNvcHkgdGhlIG5ldyBhdHRyaWJ1dGVzIG9uIHRoZSBvbGQgYXR0cnMgb2JqZWN0CiAgICAgICAgICAgICAgICAgIGZvckVhY2goc3JjLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnY2xhc3MnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKCRlbGVtZW50LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0WydjbGFzcyddID0gKGRzdFsnY2xhc3MnXSA/IGRzdFsnY2xhc3MnXSArICcgJyA6ICcnKSArIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT0gJ3N0eWxlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LmF0dHIoJ3N0eWxlJywgJGVsZW1lbnQuYXR0cignc3R5bGUnKSArICc7JyArIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5LmNoYXJBdCgwKSAhPSAnJCcgJiYgIWRzdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBkc3RBdHRyW2tleV0gPSBzcmNBdHRyW2tleV07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLCBiZWZvcmVUZW1wbGF0ZU5vZGVMaW5rRm4sICRjb21waWxlTm9kZSwgdEF0dHJzLAogICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnQsIGNoaWxkVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgICAgICAgIHZhciBsaW5rUXVldWUgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLAogICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVDb21waWxlTm9kZSA9ICRjb21waWxlTm9kZVswXSwKICAgICAgICAgICAgICAgICAgICAgIG9yaWdBc3luY0RpcmVjdGl2ZSA9IGRpcmVjdGl2ZXMuc2hpZnQoKSwKICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSBmYWN0IHRoYXQgd2UgaGF2ZSB0byBjb3B5IGFuZCBwYXRjaCB0aGUgZGlyZWN0aXZlIHNlZW1zIHdyb25nIQogICAgICAgICAgICAgICAgICAgICAgZGVyaXZlZFN5bmNEaXJlY3RpdmUgPSBleHRlbmQoe30sIG9yaWdBc3luY0RpcmVjdGl2ZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IG51bGwsIHRlbXBsYXRlVXJsOiBudWxsLCB0cmFuc2NsdWRlOiBudWxsLCBzY29wZTogbnVsbCwgcmVwbGFjZTogbnVsbAogICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybCA9IChpc0Z1bmN0aW9uKG9yaWdBc3luY0RpcmVjdGl2ZS50ZW1wbGF0ZVVybCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyBvcmlnQXN5bmNEaXJlY3RpdmUudGVtcGxhdGVVcmwoJGNvbXBpbGVOb2RlLCB0QXR0cnMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgOiBvcmlnQXN5bmNEaXJlY3RpdmUudGVtcGxhdGVVcmw7CgogICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbCgnJyk7CgogICAgICAgICAgICAgICAgICAkaHR0cC5nZXQoJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmwodGVtcGxhdGVVcmwpLCB7IGNhY2hlOiAkdGVtcGxhdGVDYWNoZSB9KS4KICAgICAgICAgICAgICAgICAgICBzdWNjZXNzKGZ1bmN0aW9uIChjb250ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21waWxlTm9kZSwgdGVtcFRlbXBsYXRlQXR0cnMsICR0ZW1wbGF0ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBkZW5vcm1hbGl6ZVRlbXBsYXRlKGNvbnRlbnQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9yaWdBc3luY0RpcmVjdGl2ZS5yZXBsYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoJzxkaXY+JyArIHRyaW0oY29udGVudCkgKyAnPC9kaXY+JykuY29udGVudHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJHRlbXBsYXRlWzBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdGVtcGxhdGUubGVuZ3RoICE9IDEgfHwgY29tcGlsZU5vZGUubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndHBscnQnLCAiVGVtcGxhdGUgZm9yIGRpcmVjdGl2ZSAnezB9JyBtdXN0IGhhdmUgZXhhY3RseSBvbmUgcm9vdCBlbGVtZW50LiB7MX0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnQXN5bmNEaXJlY3RpdmUubmFtZSwgdGVtcGxhdGVVcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBUZW1wbGF0ZUF0dHJzID0geyAkYXR0cjoge30gfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKCRyb290RWxlbWVudCwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0RGlyZWN0aXZlcyhjb21waWxlTm9kZSwgZGlyZWN0aXZlcywgdGVtcFRlbXBsYXRlQXR0cnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXModEF0dHJzLCB0ZW1wVGVtcGxhdGVBdHRycyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlTm9kZSA9IGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbChjb250ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlcy51bnNoaWZ0KGRlcml2ZWRTeW5jRGlyZWN0aXZlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuID0gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIGNvbXBpbGVOb2RlLCB0QXR0cnMsIGNoaWxkVHJhbnNjbHVkZUZuLCAkY29tcGlsZU5vZGUsIG9yaWdBc3luY0RpcmVjdGl2ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goJHJvb3RFbGVtZW50LCBmdW5jdGlvbiAobm9kZSwgaSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUgPT0gY29tcGlsZU5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbaV0gPSAkY29tcGlsZU5vZGVbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4gPSBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlWzBdLmNoaWxkTm9kZXMsIGNoaWxkVHJhbnNjbHVkZUZuKTsKCgogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobGlua1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gbGlua1F1ZXVlLnNoaWZ0KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSA9IGxpbmtRdWV1ZS5zaGlmdCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtSb290RWxlbWVudCA9IGxpbmtRdWV1ZS5zaGlmdCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rTm9kZSA9ICRjb21waWxlTm9kZVswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSAhPT0gYmVmb3JlVGVtcGxhdGVDb21waWxlTm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGl0IHdhcyBjbG9uZWQgdGhlcmVmb3JlIHdlIGhhdmUgdG8gY2xvbmUgYXMgd2VsbC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rTm9kZSA9IEpRTGl0ZUNsb25lKGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlV2l0aChsaW5rUm9vdEVsZW1lbnQsIGpxTGl0ZShiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlKSwgbGlua05vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmVUZW1wbGF0ZU5vZGVMaW5rRm4oYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLCBzY29wZSwgbGlua05vZGUsICRyb290RWxlbWVudCwgY29udHJvbGxlciksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLCBsaW5rTm9kZSwgJHJvb3RFbGVtZW50LCBjb250cm9sbGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSkuCiAgICAgICAgICAgICAgICAgICAgZXJyb3IoZnVuY3Rpb24gKHJlc3BvbnNlLCBjb2RlLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ3RwbG9hZCcsICdGYWlsZWQgdG8gbG9hZCB0ZW1wbGF0ZTogezB9JywgY29uZmlnLnVybCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gZGVsYXllZE5vZGVMaW5rRm4oaWdub3JlQ2hpbGRMaW5rRm4sIHNjb3BlLCBub2RlLCByb290RWxlbWVudCwgY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGxpbmtRdWV1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChyb290RWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua1F1ZXVlLnB1c2goY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVOb2RlTGlua0ZuKGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBzY29wZSwgbm9kZSwgcm9vdEVsZW1lbnQsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAqIFNvcnRpbmcgZnVuY3Rpb24gZm9yIGJvdW5kIGRpcmVjdGl2ZXMuCiAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgZnVuY3Rpb24gYnlQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBiLnByaW9yaXR5IC0gYS5wcmlvcml0eTsKICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICBmdW5jdGlvbiBhc3NlcnROb0R1cGxpY2F0ZSh3aGF0LCBwcmV2aW91c0RpcmVjdGl2ZSwgZGlyZWN0aXZlLCBlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0RpcmVjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ211bHRpZGlyJywgJ011bHRpcGxlIGRpcmVjdGl2ZXMgW3swfSwgezF9XSBhc2tpbmcgZm9yIHsyfSBvbjogezN9JywKICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0RpcmVjdGl2ZS5uYW1lLCBkaXJlY3RpdmUubmFtZSwgd2hhdCwgc3RhcnRpbmdUYWcoZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgZnVuY3Rpb24gYWRkVGV4dEludGVycG9sYXRlRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIHRleHQpIHsKICAgICAgICAgICAgICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUodGV4dCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgIHByaW9yaXR5OiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGU6IHZhbHVlRm4oZnVuY3Rpb24gdGV4dEludGVycG9sYXRlTGlua0ZuKHNjb3BlLCBub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBub2RlLnBhcmVudCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MgPSBwYXJlbnQuZGF0YSgnJGJpbmRpbmcnKSB8fCBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MucHVzaChpbnRlcnBvbGF0ZUZuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKHBhcmVudC5kYXRhKCckYmluZGluZycsIGJpbmRpbmdzKSwgJ25nLWJpbmRpbmcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGludGVycG9sYXRlRm4sIGZ1bmN0aW9uIGludGVycG9sYXRlRm5XYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVswXS5ub2RlVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0VHJ1c3RlZENvbnRleHQobm9kZSwgYXR0ck5vcm1hbGl6ZWROYW1lKSB7CiAgICAgICAgICAgICAgICAgIC8vIG1hY3Rpb25beGxpbms6aHJlZl0gY2FuIHNvdXJjZSBTVkcuICBJdCdzIG5vdCBsaW1pdGVkIHRvIDxtYWN0aW9uPi4KICAgICAgICAgICAgICAgICAgaWYgKGF0dHJOb3JtYWxpemVkTmFtZSA9PSAieGxpbmtIcmVmIiB8fAogICAgICAgICAgICAgICAgICAgICAgKG5vZGVOYW1lXyhub2RlKSAhPSAiSU1HIiAmJiAoYXR0ck5vcm1hbGl6ZWROYW1lID09ICJzcmMiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyTm9ybWFsaXplZE5hbWUgPT0gIm5nU3JjIikpKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHNjZS5SRVNPVVJDRV9VUkw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICBmdW5jdGlvbiBhZGRBdHRySW50ZXJwb2xhdGVEaXJlY3RpdmUobm9kZSwgZGlyZWN0aXZlcywgdmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUodmFsdWUsIHRydWUpOwoKICAgICAgICAgICAgICAgICAgLy8gbm8gaW50ZXJwb2xhdGlvbiBmb3VuZCAtPiBpZ25vcmUKICAgICAgICAgICAgICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSByZXR1cm47CgoKICAgICAgICAgICAgICAgICAgaWYgKG5hbWUgPT09ICJtdWx0aXBsZSIgJiYgbm9kZU5hbWVfKG5vZGUpID09PSAiU0VMRUNUIikgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoInNlbG11bHRpIiwgIkJpbmRpbmcgdG8gdGhlICdtdWx0aXBsZScgYXR0cmlidXRlIGlzIG5vdCBzdXBwb3J0ZWQuIEVsZW1lbnQ6IHswfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRpbmdUYWcobm9kZSkpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGU6IHZhbHVlRm4oZnVuY3Rpb24gYXR0ckludGVycG9sYXRlTGlua0ZuKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyICQkb2JzZXJ2ZXJzID0gKGF0dHIuJCRvYnNlcnZlcnMgfHwgKGF0dHIuJCRvYnNlcnZlcnMgPSB7fSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoRVZFTlRfSEFORExFUl9BVFRSX1JFR0VYUC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCdub2RvbWV2ZW50cycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiSW50ZXJwb2xhdGlvbnMgZm9yIEhUTUwgRE9NIGV2ZW50IGF0dHJpYnV0ZXMgYXJlIGRpc2FsbG93ZWQuICBQbGVhc2UgdXNlIHRoZSBuZy0gIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmVyc2lvbnMgKHN1Y2ggYXMgbmctY2xpY2sgaW5zdGVhZCBvZiBvbmNsaWNrKSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBpbnRlcnBvbGF0ZSBhZ2FpbiwgaW4gY2FzZSB0aGUgYXR0cmlidXRlIHZhbHVlIGhhcyBiZWVuIHVwZGF0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAoZS5nLiBieSBhbm90aGVyIGRpcmVjdGl2ZSdzIGNvbXBpbGUgZnVuY3Rpb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShhdHRyW25hbWVdLCB0cnVlLCBnZXRUcnVzdGVkQ29udGV4dChub2RlLCBuYW1lKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGF0dHJpYnV0ZSB3YXMgdXBkYXRlZCBzbyB0aGF0IHRoZXJlIGlzIG5vIGludGVycG9sYXRpb24gZ29pbmcgb24gd2UgZG9uJ3Qgd2FudCB0bwogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlZ2lzdGVyIGFueSBvYnNlcnZlcnMKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWludGVycG9sYXRlRm4pIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cltuYW1lXSA9IGludGVycG9sYXRlRm4oc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICgkJG9ic2VydmVyc1tuYW1lXSB8fCAoJCRvYnNlcnZlcnNbbmFtZV0gPSBbXSkpLiQkaW50ZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgIChhdHRyLiQkb2JzZXJ2ZXJzICYmIGF0dHIuJCRvYnNlcnZlcnNbbmFtZV0uJCRzY29wZSB8fCBzY29wZSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVGbldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICogVGhpcyBpcyBhIHNwZWNpYWwganFMaXRlLnJlcGxhY2VXaXRoLCB3aGljaCBjYW4gcmVwbGFjZSBpdGVtcyB3aGljaAogICAgICAgICAgICAgICAqIGhhdmUgbm8gcGFyZW50cywgcHJvdmlkZWQgdGhhdCB0aGUgY29udGFpbmluZyBqcUxpdGUgY29sbGVjdGlvbiBpcyBwcm92aWRlZC4KICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAqIEBwYXJhbSB7SnFMaXRlPX0gJHJvb3RFbGVtZW50IFRoZSByb290IG9mIHRoZSBjb21waWxlIHRyZWUuIFVzZWQgc28gdGhhdCB3ZSBjYW4gcmVwbGFjZSBub2RlcwogICAgICAgICAgICAgICAqICAgIGluIHRoZSByb290IG9mIHRoZSB0cmVlLgogICAgICAgICAgICAgICAqIEBwYXJhbSB7SnFMaXRlfSBlbGVtZW50c1RvUmVtb3ZlIFRoZSBqcUxpdGUgZWxlbWVudCB3aGljaCB3ZSBhcmUgZ29pbmcgdG8gcmVwbGFjZS4gV2Uga2VlcCB0aGUgc2hlbGwsCiAgICAgICAgICAgICAgICogICAgYnV0IHJlcGxhY2UgaXRzIERPTSBub2RlIHJlZmVyZW5jZS4KICAgICAgICAgICAgICAgKiBAcGFyYW0ge05vZGV9IG5ld05vZGUgVGhlIG5ldyBET00gbm9kZS4KICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICBmdW5jdGlvbiByZXBsYWNlV2l0aCgkcm9vdEVsZW1lbnQsIGVsZW1lbnRzVG9SZW1vdmUsIG5ld05vZGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0RWxlbWVudFRvUmVtb3ZlID0gZWxlbWVudHNUb1JlbW92ZVswXSwKICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUNvdW50ID0gZWxlbWVudHNUb1JlbW92ZS5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBmaXJzdEVsZW1lbnRUb1JlbW92ZS5wYXJlbnROb2RlLAogICAgICAgICAgICAgICAgICAgICAgaSwgaWk7CgogICAgICAgICAgICAgICAgICBpZiAoJHJvb3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpaSA9ICRyb290RWxlbWVudC5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290RWxlbWVudFtpXSA9PSBmaXJzdEVsZW1lbnRUb1JlbW92ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbaSsrXSA9IG5ld05vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSBpLCBqMiA9IGogKyByZW1vdmVDb3VudCAtIDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpqID0gJHJvb3RFbGVtZW50Lmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqIDwgamo7IGorKywgajIrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGoyIDwgamopIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbal0gPSAkcm9vdEVsZW1lbnRbajJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgJHJvb3RFbGVtZW50W2pdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290RWxlbWVudC5sZW5ndGggLT0gcmVtb3ZlQ291bnQgLSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgZmlyc3RFbGVtZW50VG9SZW1vdmUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZmlyc3RFbGVtZW50VG9SZW1vdmUpOwogICAgICAgICAgICAgICAgICBuZXdOb2RlW2pxTGl0ZS5leHBhbmRvXSA9IGZpcnN0RWxlbWVudFRvUmVtb3ZlW2pxTGl0ZS5leHBhbmRvXTsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDEsIGtrID0gZWxlbWVudHNUb1JlbW92ZS5sZW5ndGg7IGsgPCBrazsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGVsZW1lbnRzVG9SZW1vdmVba107CiAgICAgICAgICAgICAgICAgICAgICBqcUxpdGUoZWxlbWVudCkucmVtb3ZlKCk7IC8vIG11c3QgZG8gdGhpcyB3YXkgdG8gY2xlYW4gdXAgZXhwYW5kbwogICAgICAgICAgICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZWxlbWVudHNUb1JlbW92ZVtrXTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgZWxlbWVudHNUb1JlbW92ZVswXSA9IG5ld05vZGU7CiAgICAgICAgICAgICAgICAgIGVsZW1lbnRzVG9SZW1vdmUubGVuZ3RoID0gMQogICAgICAgICAgICAgIH0KICAgICAgICAgIH1dOwogICAgfQoKICAgIHZhciBQUkVGSVhfUkVHRVhQID0gL14oeFtcOlwtX118ZGF0YVtcOlwtX10pL2k7CiAgICAvKioKICAgICAqIENvbnZlcnRzIGFsbCBhY2NlcHRlZCBkaXJlY3RpdmVzIGZvcm1hdCBpbnRvIHByb3BlciBkaXJlY3RpdmUgbmFtZS4KICAgICAqIEFsbCBvZiB0aGVzZSB3aWxsIGJlY29tZSAnbXlEaXJlY3RpdmUnOgogICAgICogICBteTpEaXJlY3RpdmUKICAgICAqICAgbXktZGlyZWN0aXZlCiAgICAgKiAgIHgtbXktZGlyZWN0aXZlCiAgICAgKiAgIGRhdGEtbXk6ZGlyZWN0aXZlCiAgICAgKgogICAgICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICAgICAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIGNhbWVsQ2FzZShuYW1lLnJlcGxhY2UoUFJFRklYX1JFR0VYUCwgJycpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBBIHNoYXJlZCBvYmplY3QgYmV0d2VlbiBkaXJlY3RpdmUgY29tcGlsZSAvIGxpbmtpbmcgZnVuY3Rpb25zIHdoaWNoIGNvbnRhaW5zIG5vcm1hbGl6ZWQgRE9NIGVsZW1lbnQKICAgICAqIGF0dHJpYnV0ZXMuIFRoZSB0aGUgdmFsdWVzIHJlZmxlY3QgY3VycmVudCBiaW5kaW5nIHN0YXRlIGB7eyB9fWAuIFRoZSBub3JtYWxpemF0aW9uIGlzIG5lZWRlZAogICAgICogc2luY2UgYWxsIG9mIHRoZXNlIGFyZSB0cmVhdGVkIGFzIGVxdWl2YWxlbnQgaW4gQW5ndWxhcjoKICAgICAqCiAgICAgKiAgICAgICAgICA8c3BhbiBuZzpiaW5kPSJhIiBuZy1iaW5kPSJhIiBkYXRhLW5nLWJpbmQ9ImEiIHgtbmctYmluZD0iYSI+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIKICAgICAqIEBwcm9wZXJ0eU9mIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIG1hcCBvZiBET00gZWxlbWVudCBhdHRyaWJ1dGUgbmFtZXMgdG8gdGhlIG5vcm1hbGl6ZWQgbmFtZS4gVGhpcyBpcwogICAgICogICAgICAgICAgbmVlZGVkIHRvIGRvIHJldmVyc2UgbG9va3VwIGZyb20gbm9ybWFsaXplZCBuYW1lIGJhY2sgdG8gYWN0dWFsIG5hbWUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRzZXQKICAgICAqIEBtZXRob2RPZiBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcwogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXQgRE9NIGVsZW1lbnQgYXR0cmlidXRlIHZhbHVlLgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBOb3JtYWxpemVkIGVsZW1lbnQgYXR0cmlidXRlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIG1vZGlmeS4gVGhlIG5hbWUgaXMKICAgICAqICAgICAgICAgIHJldmVycyB0cmFuc2xhdGVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIgJGF0dHJ9CiAgICAgKiAgICAgICAgICBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgbmFtZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSB0byBzZXQgdGhlIGF0dHJpYnV0ZSB0by4gVGhlIHZhbHVlIGNhbiBiZSBhbiBpbnRlcnBvbGF0ZWQgc3RyaW5nLgogICAgICovCgoKCiAgICAvKioKICAgICAqIENsb3N1cmUgY29tcGlsZXIgdHlwZSBpbmZvcm1hdGlvbgogICAgICovCgogICAgZnVuY3Rpb24gbm9kZXNldExpbmtpbmdGbigKICAgICAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAgICAgLyogTm9kZUxpc3QgKi8gbm9kZUxpc3QsCiAgICAgIC8qIEVsZW1lbnQgKi8gcm9vdEVsZW1lbnQsCiAgICAgIC8qIGZ1bmN0aW9uKEZ1bmN0aW9uKSAqLyBib3VuZFRyYW5zY2x1ZGVGbgogICAgKSB7IH0KCiAgICBmdW5jdGlvbiBkaXJlY3RpdmVMaW5raW5nRm4oCiAgICAgIC8qIG5vZGVzZXRMaW5raW5nRm4gKi8gbm9kZXNldExpbmtpbmdGbiwKICAgICAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAgICAgLyogTm9kZSAqLyBub2RlLAogICAgICAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LAogICAgICAvKiBmdW5jdGlvbihGdW5jdGlvbikgKi8gYm91bmRUcmFuc2NsdWRlRm4KICAgICkgeyB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kY29udHJvbGxlclByb3ZpZGVyCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSB7QGxpbmsgbmcuJGNvbnRyb2xsZXIgJGNvbnRyb2xsZXIgc2VydmljZX0gaXMgdXNlZCBieSBBbmd1bGFyIHRvIGNyZWF0ZSBuZXcKICAgICAqIGNvbnRyb2xsZXJzLgogICAgICoKICAgICAqIFRoaXMgcHJvdmlkZXIgYWxsb3dzIGNvbnRyb2xsZXIgcmVnaXN0cmF0aW9uIHZpYSB0aGUKICAgICAqIHtAbGluayBuZy4kY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyIHJlZ2lzdGVyfSBtZXRob2QuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRDb250cm9sbGVyUHJvdmlkZXIoKSB7CiAgICAgICAgdmFyIGNvbnRyb2xsZXJzID0ge30sCiAgICAgICAgICAgIENOVFJMX1JFRyA9IC9eKFxTKykoXHMrYXNccysoXHcrKSk/JC87CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSBuZy4kY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRjb250cm9sbGVyUHJvdmlkZXIKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBDb250cm9sbGVyIG5hbWUKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufEFycmF5fSBjb25zdHJ1Y3RvciBDb250cm9sbGVyIGNvbnN0cnVjdG9yIGZuIChvcHRpb25hbGx5IGRlY29yYXRlZCB3aXRoIERJCiAgICAgICAgICogICAgYW5ub3RhdGlvbnMgaW4gdGhlIGFycmF5IG5vdGF0aW9uKS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLnJlZ2lzdGVyID0gZnVuY3Rpb24gKG5hbWUsIGNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgIGlmIChpc09iamVjdChuYW1lKSkgewogICAgICAgICAgICAgICAgZXh0ZW5kKGNvbnRyb2xsZXJzLCBuYW1lKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udHJvbGxlcnNbbmFtZV0gPSBjb25zdHJ1Y3RvcjsKICAgICAgICAgICAgfQogICAgICAgIH07CgoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsICckd2luZG93JywgZnVuY3Rpb24gKCRpbmplY3RvciwgJHdpbmRvdykgewoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSBuZy4kY29udHJvbGxlcgogICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb258c3RyaW5nfSBjb25zdHJ1Y3RvciBJZiBjYWxsZWQgd2l0aCBhIGZ1bmN0aW9uIHRoZW4gaXQncyBjb25zaWRlcmVkIHRvIGJlIHRoZQogICAgICAgICAgICAgKiAgICBjb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBPdGhlcndpc2UgaXQncyBjb25zaWRlcmVkIHRvIGJlIGEgc3RyaW5nIHdoaWNoIGlzIHVzZWQKICAgICAgICAgICAgICogICAgdG8gcmV0cmlldmUgdGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgdXNpbmcgdGhlIGZvbGxvd2luZyBzdGVwczoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgKiBjaGVjayBpZiBhIGNvbnRyb2xsZXIgd2l0aCBnaXZlbiBuYW1lIGlzIHJlZ2lzdGVyZWQgdmlhIGAkY29udHJvbGxlclByb3ZpZGVyYAogICAgICAgICAgICAgKiAgICAqIGNoZWNrIGlmIGV2YWx1YXRpbmcgdGhlIHN0cmluZyBvbiB0aGUgY3VycmVudCBzY29wZSByZXR1cm5zIGEgY29uc3RydWN0b3IKICAgICAgICAgICAgICogICAgKiBjaGVjayBgd2luZG93W2NvbnN0cnVjdG9yXWAgb24gdGhlIGdsb2JhbCBgd2luZG93YCBvYmplY3QKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGxvY2FscyBJbmplY3Rpb24gbG9jYWxzIGZvciBDb250cm9sbGVyLgogICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEluc3RhbmNlIG9mIGdpdmVuIGNvbnRyb2xsZXIuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBgJGNvbnRyb2xsZXJgIHNlcnZpY2UgaXMgcmVzcG9uc2libGUgZm9yIGluc3RhbnRpYXRpbmcgY29udHJvbGxlcnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEl0J3MganVzdCBhIHNpbXBsZSBjYWxsIHRvIHtAbGluayBBVVRPLiRpbmplY3RvciAkaW5qZWN0b3J9LCBidXQgZXh0cmFjdGVkIGludG8KICAgICAgICAgICAgICogYSBzZXJ2aWNlLCBzbyB0aGF0IG9uZSBjYW4gb3ZlcnJpZGUgdGhpcyBzZXJ2aWNlIHdpdGgge0BsaW5rIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzE2NDk3ODgKICAgICAgICAgICAgICogQkMgdmVyc2lvbn0uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGV4cHJlc3Npb24sIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlLCBtYXRjaCwgY29uc3RydWN0b3IsIGlkZW50aWZpZXI7CgogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGV4cHJlc3Npb24pKSB7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBleHByZXNzaW9uLm1hdGNoKENOVFJMX1JFRyksCiAgICAgICAgICAgICAgICAgICAgY29uc3RydWN0b3IgPSBtYXRjaFsxXSwKICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gbWF0Y2hbM107CiAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IGNvbnRyb2xsZXJzLmhhc093blByb3BlcnR5KGNvbnN0cnVjdG9yKQogICAgICAgICAgICAgICAgICAgICAgICA/IGNvbnRyb2xsZXJzW2NvbnN0cnVjdG9yXQogICAgICAgICAgICAgICAgICAgICAgICA6IGdldHRlcihsb2NhbHMuJHNjb3BlLCBjb25zdHJ1Y3RvciwgdHJ1ZSkgfHwgZ2V0dGVyKCR3aW5kb3csIGNvbnN0cnVjdG9yLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0QXJnRm4oZXhwcmVzc2lvbiwgY29uc3RydWN0b3IsIHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gJGluamVjdG9yLmluc3RhbnRpYXRlKGV4cHJlc3Npb24sIGxvY2Fscyk7CgogICAgICAgICAgICAgICAgaWYgKGlkZW50aWZpZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIShsb2NhbHMgJiYgdHlwZW9mIGxvY2Fscy4kc2NvcGUgPT0gJ29iamVjdCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG1pbkVycignJGNvbnRyb2xsZXInKSgnbm9zY3AnLCAiQ2Fubm90IGV4cG9ydCBjb250cm9sbGVyICd7MH0nIGFzICd7MX0nISBObyAkc2NvcGUgb2JqZWN0IHByb3ZpZGVkIHZpYSBgbG9jYWxzYC4iLCBjb25zdHJ1Y3RvciB8fCBleHByZXNzaW9uLm5hbWUsIGlkZW50aWZpZXIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbG9jYWxzLiRzY29wZVtpZGVudGlmaWVyXSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRkb2N1bWVudAogICAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEge0BsaW5rIGFuZ3VsYXIuZWxlbWVudCBqUXVlcnkgKGxpdGUpfS13cmFwcGVkIHJlZmVyZW5jZSB0byB0aGUgYnJvd3NlcidzIGB3aW5kb3cuZG9jdW1lbnRgCiAgICAgKiBlbGVtZW50LgogICAgICovCiAgICBmdW5jdGlvbiAkRG9jdW1lbnRQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCBmdW5jdGlvbiAod2luZG93KSB7CiAgICAgICAgICAgIHJldHVybiBqcUxpdGUod2luZG93LmRvY3VtZW50KTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJGV4Y2VwdGlvbkhhbmRsZXIKICAgICAqIEByZXF1aXJlcyAkbG9nCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBbnkgdW5jYXVnaHQgZXhjZXB0aW9uIGluIGFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGVsZWdhdGVkIHRvIHRoaXMgc2VydmljZS4KICAgICAqIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIHNpbXBseSBkZWxlZ2F0ZXMgdG8gYCRsb2cuZXJyb3JgIHdoaWNoIGxvZ3MgaXQgaW50bwogICAgICogdGhlIGJyb3dzZXIgY29uc29sZS4KICAgICAqCiAgICAgKiBJbiB1bml0IHRlc3RzLCBpZiBgYW5ndWxhci1tb2Nrcy5qc2AgaXMgbG9hZGVkLCB0aGlzIHNlcnZpY2UgaXMgb3ZlcnJpZGRlbiBieQogICAgICoge0BsaW5rIG5nTW9jay4kZXhjZXB0aW9uSGFuZGxlciBtb2NrICRleGNlcHRpb25IYW5kbGVyfSB3aGljaCBhaWRzIGluIHRlc3RpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtFcnJvcn0gZXhjZXB0aW9uIEV4Y2VwdGlvbiBhc3NvY2lhdGVkIHdpdGggdGhlIGVycm9yLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBjYXVzZSBvcHRpb25hbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY29udGV4dCBpbiB3aGljaAogICAgICogICAgICAgdGhlIGVycm9yIHdhcyB0aHJvd24uCiAgICAgKgogICAgICovCiAgICBmdW5jdGlvbiAkRXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFsnJGxvZycsIGZ1bmN0aW9uICgkbG9nKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXhjZXB0aW9uLCBjYXVzZSkgewogICAgICAgICAgICAgICAgJGxvZy5lcnJvci5hcHBseSgkbG9nLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9OwogICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogUGFyc2UgaGVhZGVycyBpbnRvIGtleSB2YWx1ZSBvYmplY3QKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGVhZGVycyBSYXcgaGVhZGVycyBhcyBhIHN0cmluZwogICAgICogQHJldHVybnMge09iamVjdH0gUGFyc2VkIGhlYWRlcnMgYXMga2V5IHZhbHVlIG9iamVjdAogICAgICovCiAgICBmdW5jdGlvbiBwYXJzZUhlYWRlcnMoaGVhZGVycykgewogICAgICAgIHZhciBwYXJzZWQgPSB7fSwga2V5LCB2YWwsIGk7CgogICAgICAgIGlmICghaGVhZGVycykgcmV0dXJuIHBhcnNlZDsKCiAgICAgICAgZm9yRWFjaChoZWFkZXJzLnNwbGl0KCdcbicpLCBmdW5jdGlvbiAobGluZSkgewogICAgICAgICAgICBpID0gbGluZS5pbmRleE9mKCc6Jyk7CiAgICAgICAgICAgIGtleSA9IGxvd2VyY2FzZSh0cmltKGxpbmUuc3Vic3RyKDAsIGkpKSk7CiAgICAgICAgICAgIHZhbCA9IHRyaW0obGluZS5zdWJzdHIoaSArIDEpKTsKCiAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGlmIChwYXJzZWRba2V5XSkgewogICAgICAgICAgICAgICAgICAgIHBhcnNlZFtrZXldICs9ICcsICcgKyB2YWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcnNlZFtrZXldID0gdmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBwYXJzZWQ7CiAgICB9CgoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgcHJvdmlkZXMgYWNjZXNzIHRvIHBhcnNlZCBoZWFkZXJzLgogICAgICoKICAgICAqIEhlYWRlcnMgYXJlIGxhenkgcGFyc2VkIHdoZW4gZmlyc3QgcmVxdWVzdGVkLgogICAgICogQHNlZSBwYXJzZUhlYWRlcnMKICAgICAqCiAgICAgKiBAcGFyYW0geyhzdHJpbmd8T2JqZWN0KX0gaGVhZGVycyBIZWFkZXJzIHRvIHByb3ZpZGUgYWNjZXNzIHRvLgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKHN0cmluZz0pfSBSZXR1cm5zIGEgZ2V0dGVyIGZ1bmN0aW9uIHdoaWNoIGlmIGNhbGxlZCB3aXRoOgogICAgICoKICAgICAqICAgLSBpZiBjYWxsZWQgd2l0aCBzaW5nbGUgYW4gYXJndW1lbnQgcmV0dXJucyBhIHNpbmdsZSBoZWFkZXIgdmFsdWUgb3IgbnVsbAogICAgICogICAtIGlmIGNhbGxlZCB3aXRoIG5vIGFyZ3VtZW50cyByZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCBoZWFkZXJzLgogICAgICovCiAgICBmdW5jdGlvbiBoZWFkZXJzR2V0dGVyKGhlYWRlcnMpIHsKICAgICAgICB2YXIgaGVhZGVyc09iaiA9IGlzT2JqZWN0KGhlYWRlcnMpID8gaGVhZGVycyA6IHVuZGVmaW5lZDsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgIGlmICghaGVhZGVyc09iaikgaGVhZGVyc09iaiA9IHBhcnNlSGVhZGVycyhoZWFkZXJzKTsKCiAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaGVhZGVyc09ialtsb3dlcmNhc2UobmFtZSldIHx8IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBoZWFkZXJzT2JqOwogICAgICAgIH07CiAgICB9CgoKICAgIC8qKgogICAgICogQ2hhaW4gYWxsIGdpdmVuIGZ1bmN0aW9ucwogICAgICoKICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgYm90aCByZXF1ZXN0IGFuZCByZXNwb25zZSB0cmFuc2Zvcm1pbmcKICAgICAqCiAgICAgKiBAcGFyYW0geyp9IGRhdGEgRGF0YSB0byB0cmFuc2Zvcm0uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZz0pfSBoZWFkZXJzIEh0dHAgaGVhZGVycyBnZXR0ZXIgZm4uCiAgICAgKiBAcGFyYW0geyhmdW5jdGlvbnxBcnJheS48ZnVuY3Rpb24+KX0gZm5zIEZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIGZ1bmN0aW9ucy4KICAgICAqIEByZXR1cm5zIHsqfSBUcmFuc2Zvcm1lZCBkYXRhLgogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc2Zvcm1EYXRhKGRhdGEsIGhlYWRlcnMsIGZucykgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKGZucykpCiAgICAgICAgICAgIHJldHVybiBmbnMoZGF0YSwgaGVhZGVycyk7CgogICAgICAgIGZvckVhY2goZm5zLCBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgZGF0YSA9IGZuKGRhdGEsIGhlYWRlcnMpOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gZGF0YTsKICAgIH0KCgogICAgZnVuY3Rpb24gaXNTdWNjZXNzKHN0YXR1cykgewogICAgICAgIHJldHVybiAyMDAgPD0gc3RhdHVzICYmIHN0YXR1cyA8IDMwMDsKICAgIH0KCgogICAgZnVuY3Rpb24gJEh0dHBQcm92aWRlcigpIHsKICAgICAgICB2YXIgSlNPTl9TVEFSVCA9IC9eXHMqKFxbfFx7W15ce10pLywKICAgICAgICAgICAgSlNPTl9FTkQgPSAvW1x9XF1dXHMqJC8sCiAgICAgICAgICAgIFBST1RFQ1RJT05fUFJFRklYID0gL15cKVxdXH0nLD9cbi8sCiAgICAgICAgICAgIENPTlRFTlRfVFlQRV9BUFBMSUNBVElPTl9KU09OID0geyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOCcgfTsKCiAgICAgICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgICAgICAgLy8gdHJhbnNmb3JtIGluY29taW5nIHJlc3BvbnNlIGRhdGEKICAgICAgICAgICAgdHJhbnNmb3JtUmVzcG9uc2U6IFtmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gc3RyaXAganNvbiB2dWxuZXJhYmlsaXR5IHByb3RlY3Rpb24gcHJlZml4CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEucmVwbGFjZShQUk9URUNUSU9OX1BSRUZJWCwgJycpOwogICAgICAgICAgICAgICAgICAgIGlmIChKU09OX1NUQVJULnRlc3QoZGF0YSkgJiYgSlNPTl9FTkQudGVzdChkYXRhKSkKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGZyb21Kc29uKGRhdGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH1dLAoKICAgICAgICAgICAgLy8gdHJhbnNmb3JtIG91dGdvaW5nIHJlcXVlc3QgZGF0YQogICAgICAgICAgICB0cmFuc2Zvcm1SZXF1ZXN0OiBbZnVuY3Rpb24gKGQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc09iamVjdChkKSAmJiAhaXNGaWxlKGQpID8gdG9Kc29uKGQpIDogZDsKICAgICAgICAgICAgfV0sCgogICAgICAgICAgICAvLyBkZWZhdWx0IGhlYWRlcnMKICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAgY29tbW9uOiB7CiAgICAgICAgICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L3BsYWluLCAqLyonCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcG9zdDogQ09OVEVOVF9UWVBFX0FQUExJQ0FUSU9OX0pTT04sCiAgICAgICAgICAgICAgICBwdXQ6IENPTlRFTlRfVFlQRV9BUFBMSUNBVElPTl9KU09OLAogICAgICAgICAgICAgICAgcGF0Y2g6IENPTlRFTlRfVFlQRV9BUFBMSUNBVElPTl9KU09OCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICB4c3JmQ29va2llTmFtZTogJ1hTUkYtVE9LRU4nLAogICAgICAgICAgICB4c3JmSGVhZGVyTmFtZTogJ1gtWFNSRi1UT0tFTicKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBBcmUgb3JkZXIgYnkgcmVxdWVzdC4gSS5FLiB0aGV5IGFyZSBhcHBsaWVkIGluIHRoZSBzYW1lIG9yZGVyIGFzCiAgICAgICAgICogYXJyYXkgb24gcmVxdWVzdCwgYnV0IHJldmVycyBvcmRlciBvbiByZXNwb25zZS4KICAgICAgICAgKi8KICAgICAgICB2YXIgaW50ZXJjZXB0b3JGYWN0b3JpZXMgPSB0aGlzLmludGVyY2VwdG9ycyA9IFtdOwogICAgICAgIC8qKgogICAgICAgICAqIEZvciBoaXN0b3JpY2FsIHJlYXNvbnMsIHJlc3BvbnNlIGludGVyY2VwdG9ycyBvcmRlcmVkIGJ5IHRoZSBvcmRlciBpbiB3aGljaAogICAgICAgICAqIHRoZXkgYXJlIGFwcGxpZWQgdG8gcmVzcG9uc2UuIChUaGlzIGlzIGluIHJldmVycyB0byBpbnRlcmNlcHRvckZhY3RvcmllcykKICAgICAgICAgKi8KICAgICAgICB2YXIgcmVzcG9uc2VJbnRlcmNlcHRvckZhY3RvcmllcyA9IHRoaXMucmVzcG9uc2VJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICAgICAgdGhpcy4kZ2V0ID0gWyckaHR0cEJhY2tlbmQnLCAnJGJyb3dzZXInLCAnJGNhY2hlRmFjdG9yeScsICckcm9vdFNjb3BlJywgJyRxJywgJyRpbmplY3RvcicsICckJHVybFV0aWxzJywKICAgICAgICAgICAgZnVuY3Rpb24gKCRodHRwQmFja2VuZCwgJGJyb3dzZXIsICRjYWNoZUZhY3RvcnksICRyb290U2NvcGUsICRxLCAkaW5qZWN0b3IsICQkdXJsVXRpbHMpIHsKCiAgICAgICAgICAgICAgICB2YXIgZGVmYXVsdENhY2hlID0gJGNhY2hlRmFjdG9yeSgnJGh0dHAnKTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEludGVyY2VwdG9ycyBzdG9yZWQgaW4gcmV2ZXJzZSBvcmRlci4gSW5uZXIgaW50ZXJjZXB0b3JzIGJlZm9yZSBvdXRlciBpbnRlcmNlcHRvcnMuCiAgICAgICAgICAgICAgICAgKiBUaGUgcmV2ZXJzYWwgaXMgbmVlZGVkIHNvIHRoYXQgd2UgY2FuIGJ1aWxkIHVwIHRoZSBpbnRlcmNlcHRpb24gY2hhaW4gYXJvdW5kIHRoZQogICAgICAgICAgICAgICAgICogc2VydmVyIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHZhciByZXZlcnNlZEludGVyY2VwdG9ycyA9IFtdOwoKICAgICAgICAgICAgICAgIGZvckVhY2goaW50ZXJjZXB0b3JGYWN0b3JpZXMsIGZ1bmN0aW9uIChpbnRlcmNlcHRvckZhY3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXZlcnNlZEludGVyY2VwdG9ycy51bnNoaWZ0KGlzU3RyaW5nKGludGVyY2VwdG9yRmFjdG9yeSkKICAgICAgICAgICAgICAgICAgICAgICAgPyAkaW5qZWN0b3IuZ2V0KGludGVyY2VwdG9yRmFjdG9yeSkgOiAkaW5qZWN0b3IuaW52b2tlKGludGVyY2VwdG9yRmFjdG9yeSkpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgZm9yRWFjaChyZXNwb25zZUludGVyY2VwdG9yRmFjdG9yaWVzLCBmdW5jdGlvbiAoaW50ZXJjZXB0b3JGYWN0b3J5LCBpbmRleCkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXNwb25zZUZuID0gaXNTdHJpbmcoaW50ZXJjZXB0b3JGYWN0b3J5KQogICAgICAgICAgICAgICAgICAgICAgICA/ICRpbmplY3Rvci5nZXQoaW50ZXJjZXB0b3JGYWN0b3J5KQogICAgICAgICAgICAgICAgICAgICAgICA6ICRpbmplY3Rvci5pbnZva2UoaW50ZXJjZXB0b3JGYWN0b3J5KTsKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogUmVzcG9uc2UgaW50ZXJjZXB0b3JzIGdvIGJlZm9yZSAiYXJvdW5kIiBpbnRlcmNlcHRvcnMgKG5vIHJlYWwgcmVhc29uLCBqdXN0CiAgICAgICAgICAgICAgICAgICAgICogaGFkIHRvIHBpY2sgb25lLikgQnV0IHRoZXkgYXJlIGFscmVhZHkgcmV2ZXJzZWQsIHNvIHdlIGNhbid0IHVzZSB1bnNoaWZ0LCBoZW5jZQogICAgICAgICAgICAgICAgICAgICAqIHRoZSBzcGxpY2UuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgcmV2ZXJzZWRJbnRlcmNlcHRvcnMuc3BsaWNlKGluZGV4LCAwLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZUZuKCRxLndoZW4ocmVzcG9uc2UpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VFcnJvcjogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VGbigkcS5yZWplY3QocmVzcG9uc2UpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CgoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cAogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRodHRwQmFja2VuZAogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRicm93c2VyCiAgICAgICAgICAgICAgICAgKiBAcmVxdWlyZXMgJGNhY2hlRmFjdG9yeQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkcQogICAgICAgICAgICAgICAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogVGhlIGAkaHR0cGAgc2VydmljZSBpcyBhIGNvcmUgQW5ndWxhciBzZXJ2aWNlIHRoYXQgZmFjaWxpdGF0ZXMgY29tbXVuaWNhdGlvbiB3aXRoIHRoZSByZW1vdGUKICAgICAgICAgICAgICAgICAqIEhUVFAgc2VydmVycyB2aWEgdGhlIGJyb3dzZXIncyB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4veG1saHR0cHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIFhNTEh0dHBSZXF1ZXN0fSBvYmplY3Qgb3IgdmlhIHtAbGluayBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0pTT05QIEpTT05QfS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBGb3IgdW5pdCB0ZXN0aW5nIGFwcGxpY2F0aW9ucyB0aGF0IHVzZSBgJGh0dHBgIHNlcnZpY2UsIHNlZQogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nTW9jay4kaHR0cEJhY2tlbmQgJGh0dHBCYWNrZW5kIG1vY2t9LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciBhIGhpZ2hlciBsZXZlbCBvZiBhYnN0cmFjdGlvbiwgcGxlYXNlIGNoZWNrIG91dCB0aGUge0BsaW5rIG5nUmVzb3VyY2UuJHJlc291cmNlCiAgICAgICAgICAgICAgICAgKiAkcmVzb3VyY2V9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlICRodHRwIEFQSSBpcyBiYXNlZCBvbiB0aGUge0BsaW5rIG5nLiRxIGRlZmVycmVkL3Byb21pc2UgQVBJc30gZXhwb3NlZCBieQogICAgICAgICAgICAgICAgICogdGhlICRxIHNlcnZpY2UuIFdoaWxlIGZvciBzaW1wbGUgdXNhZ2UgcGF0dGVybnMgdGhpcyBkb2Vzbid0IG1hdHRlciBtdWNoLCBmb3IgYWR2YW5jZWQgdXNhZ2UKICAgICAgICAgICAgICAgICAqIGl0IGlzIGltcG9ydGFudCB0byBmYW1pbGlhcml6ZSB5b3Vyc2VsZiB3aXRoIHRoZXNlIEFQSXMgYW5kIHRoZSBndWFyYW50ZWVzIHRoZXkgcHJvdmlkZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBHZW5lcmFsIHVzYWdlCiAgICAgICAgICAgICAgICAgKiBUaGUgYCRodHRwYCBzZXJ2aWNlIGlzIGEgZnVuY3Rpb24gd2hpY2ggdGFrZXMgYSBzaW5nbGUgYXJndW1lbnQg4oCUIGEgY29uZmlndXJhdGlvbiBvYmplY3Qg4oCUCiAgICAgICAgICAgICAgICAgKiB0aGF0IGlzIHVzZWQgdG8gZ2VuZXJhdGUgYW4gSFRUUCByZXF1ZXN0IGFuZCByZXR1cm5zICBhIHtAbGluayBuZy4kcSBwcm9taXNlfQogICAgICAgICAgICAgICAgICogd2l0aCB0d28gJGh0dHAgc3BlY2lmaWMgbWV0aG9kczogYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiAgICRodHRwKHttZXRob2Q6ICdHRVQnLCB1cmw6ICcvc29tZVVybCd9KS4KICAgICAgICAgICAgICAgICAqICAgICBzdWNjZXNzKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAvLyB0aGlzIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGFzeW5jaHJvbm91c2x5CiAgICAgICAgICAgICAgICAgKiAgICAgICAvLyB3aGVuIHRoZSByZXNwb25zZSBpcyBhdmFpbGFibGUKICAgICAgICAgICAgICAgICAqICAgICB9KS4KICAgICAgICAgICAgICAgICAqICAgICBlcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICAgICAgICAgICAgICogICAgICAgLy8gY2FsbGVkIGFzeW5jaHJvbm91c2x5IGlmIGFuIGVycm9yIG9jY3VycwogICAgICAgICAgICAgICAgICogICAgICAgLy8gb3Igc2VydmVyIHJldHVybnMgcmVzcG9uc2Ugd2l0aCBhbiBlcnJvciBzdGF0dXMuCiAgICAgICAgICAgICAgICAgKiAgICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTaW5jZSB0aGUgcmV0dXJuZWQgdmFsdWUgb2YgY2FsbGluZyB0aGUgJGh0dHAgZnVuY3Rpb24gaXMgYSBgcHJvbWlzZWAsIHlvdSBjYW4gYWxzbyB1c2UKICAgICAgICAgICAgICAgICAqIHRoZSBgdGhlbmAgbWV0aG9kIHRvIHJlZ2lzdGVyIGNhbGxiYWNrcywgYW5kIHRoZXNlIGNhbGxiYWNrcyB3aWxsIHJlY2VpdmUgYSBzaW5nbGUgYXJndW1lbnQg4oCTCiAgICAgICAgICAgICAgICAgKiBhbiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZXNwb25zZS4gU2VlIHRoZSBBUEkgc2lnbmF0dXJlIGFuZCB0eXBlIGluZm8gYmVsb3cgZm9yIG1vcmUKICAgICAgICAgICAgICAgICAqIGRldGFpbHMuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQSByZXNwb25zZSBzdGF0dXMgY29kZSBiZXR3ZWVuIDIwMCBhbmQgMjk5IGlzIGNvbnNpZGVyZWQgYSBzdWNjZXNzIHN0YXR1cyBhbmQKICAgICAgICAgICAgICAgICAqIHdpbGwgcmVzdWx0IGluIHRoZSBzdWNjZXNzIGNhbGxiYWNrIGJlaW5nIGNhbGxlZC4gTm90ZSB0aGF0IGlmIHRoZSByZXNwb25zZSBpcyBhIHJlZGlyZWN0LAogICAgICAgICAgICAgICAgICogWE1MSHR0cFJlcXVlc3Qgd2lsbCB0cmFuc3BhcmVudGx5IGZvbGxvdyBpdCwgbWVhbmluZyB0aGF0IHRoZSBlcnJvciBjYWxsYmFjayB3aWxsIG5vdCBiZQogICAgICAgICAgICAgICAgICogY2FsbGVkIGZvciBzdWNoIHJlc3BvbnNlcy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFNob3J0Y3V0IG1ldGhvZHMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTaW5jZSBhbGwgaW52b2NhdGlvbnMgb2YgdGhlICRodHRwIHNlcnZpY2UgcmVxdWlyZSBwYXNzaW5nIGluIGFuIEhUVFAgbWV0aG9kIGFuZCBVUkwsIGFuZAogICAgICAgICAgICAgICAgICogUE9TVC9QVVQgcmVxdWVzdHMgcmVxdWlyZSByZXF1ZXN0IGRhdGEgdG8gYmUgcHJvdmlkZWQgYXMgd2VsbCwgc2hvcnRjdXQgbWV0aG9kcwogICAgICAgICAgICAgICAgICogd2VyZSBjcmVhdGVkOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgKiAgICRodHRwLmdldCgnL3NvbWVVcmwnKS5zdWNjZXNzKHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgKiAgICRodHRwLnBvc3QoJy9zb21lVXJsJywgZGF0YSkuc3VjY2VzcyhzdWNjZXNzQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQ29tcGxldGUgbGlzdCBvZiBzaG9ydGN1dCBtZXRob2RzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2dldCAkaHR0cC5nZXR9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNoZWFkICRodHRwLmhlYWR9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwb3N0ICRodHRwLnBvc3R9CiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwdXQgJGh0dHAucHV0fQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjZGVsZXRlICRodHRwLmRlbGV0ZX0KICAgICAgICAgICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2pzb25wICRodHRwLmpzb25wfQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFNldHRpbmcgSFRUUCBIZWFkZXJzCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVGhlICRodHRwIHNlcnZpY2Ugd2lsbCBhdXRvbWF0aWNhbGx5IGFkZCBjZXJ0YWluIEhUVFAgaGVhZGVycyB0byBhbGwgcmVxdWVzdHMuIFRoZXNlIGRlZmF1bHRzCiAgICAgICAgICAgICAgICAgKiBjYW4gYmUgZnVsbHkgY29uZmlndXJlZCBieSBhY2Nlc3NpbmcgdGhlIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnNgIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAqIG9iamVjdCwgd2hpY2ggY3VycmVudGx5IGNvbnRhaW5zIHRoaXMgZGVmYXVsdCBjb25maWd1cmF0aW9uOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5jb21tb25gIChoZWFkZXJzIHRoYXQgYXJlIGNvbW1vbiBmb3IgYWxsIHJlcXVlc3RzKToKICAgICAgICAgICAgICAgICAqICAgLSBgQWNjZXB0OiBhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L3BsYWluLCAqIC8gKmAKICAgICAgICAgICAgICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5wb3N0YDogKGhlYWRlciBkZWZhdWx0cyBmb3IgUE9TVCByZXF1ZXN0cykKICAgICAgICAgICAgICAgICAqICAgLSBgQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uYAogICAgICAgICAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnB1dGAgKGhlYWRlciBkZWZhdWx0cyBmb3IgUFVUIHJlcXVlc3RzKQogICAgICAgICAgICAgICAgICogICAtIGBDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb25gCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogVG8gYWRkIG9yIG92ZXJ3cml0ZSB0aGVzZSBkZWZhdWx0cywgc2ltcGx5IGFkZCBvciByZW1vdmUgYSBwcm9wZXJ0eSBmcm9tIHRoZXNlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgICAqIG9iamVjdHMuIFRvIGFkZCBoZWFkZXJzIGZvciBhbiBIVFRQIG1ldGhvZCBvdGhlciB0aGFuIFBPU1Qgb3IgUFVULCBzaW1wbHkgYWRkIGEgbmV3IG9iamVjdAogICAgICAgICAgICAgICAgICogd2l0aCB0aGUgbG93ZXJjYXNlZCBIVFRQIG1ldGhvZCBuYW1lIGFzIHRoZSBrZXksIGUuZy4KICAgICAgICAgICAgICAgICAqIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMuZ2V0WydNeS1IZWFkZXInXT0ndmFsdWUnYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBZGRpdGlvbmFsbHksIHRoZSBkZWZhdWx0cyBjYW4gYmUgc2V0IGF0IHJ1bnRpbWUgdmlhIHRoZSBgJGh0dHAuZGVmYXVsdHNgIG9iamVjdCBpbiB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogZmFzaGlvbi4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJvdGggcmVxdWVzdHMgYW5kIHJlc3BvbnNlcyBjYW4gYmUgdHJhbnNmb3JtZWQgdXNpbmcgdHJhbnNmb3JtIGZ1bmN0aW9ucy4gQnkgZGVmYXVsdCwgQW5ndWxhcgogICAgICAgICAgICAgICAgICogYXBwbGllcyB0aGVzZSB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogUmVxdWVzdCB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogLSBJZiB0aGUgYGRhdGFgIHByb3BlcnR5IG9mIHRoZSByZXF1ZXN0IGNvbmZpZ3VyYXRpb24gb2JqZWN0IGNvbnRhaW5zIGFuIG9iamVjdCwgc2VyaWFsaXplIGl0IGludG8KICAgICAgICAgICAgICAgICAqICAgSlNPTiBmb3JtYXQuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogUmVzcG9uc2UgdHJhbnNmb3JtYXRpb25zOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAtIElmIFhTUkYgcHJlZml4IGlzIGRldGVjdGVkLCBzdHJpcCBpdCAoc2VlIFNlY3VyaXR5IENvbnNpZGVyYXRpb25zIHNlY3Rpb24gYmVsb3cpLgogICAgICAgICAgICAgICAgICogIC0gSWYgSlNPTiByZXNwb25zZSBpcyBkZXRlY3RlZCwgZGVzZXJpYWxpemUgaXQgdXNpbmcgYSBKU09OIHBhcnNlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBnbG9iYWxseSBhdWdtZW50IG9yIG92ZXJyaWRlIHRoZSBkZWZhdWx0IHRyYW5zZm9ybXMsIG1vZGlmeSB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMudHJhbnNmb3JtUmVxdWVzdGAgYW5kCiAgICAgICAgICAgICAgICAgKiBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy50cmFuc2Zvcm1SZXNwb25zZWAgcHJvcGVydGllcy4gVGhlc2UgcHJvcGVydGllcyBhcmUgYnkgZGVmYXVsdCBhbgogICAgICAgICAgICAgICAgICogYXJyYXkgb2YgdHJhbnNmb3JtIGZ1bmN0aW9ucywgd2hpY2ggYWxsb3dzIHlvdSB0byBgcHVzaGAgb3IgYHVuc2hpZnRgIGEgbmV3IHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9uIGludG8gdGhlCiAgICAgICAgICAgICAgICAgKiB0cmFuc2Zvcm1hdGlvbiBjaGFpbi4gWW91IGNhbiBhbHNvIGRlY2lkZSB0byBjb21wbGV0ZWx5IG92ZXJyaWRlIGFueSBkZWZhdWx0IHRyYW5zZm9ybWF0aW9ucyBieSBhc3NpZ25pbmcgeW91cgogICAgICAgICAgICAgICAgICogdHJhbnNmb3JtYXRpb24gZnVuY3Rpb25zIHRvIHRoZXNlIHByb3BlcnRpZXMgZGlyZWN0bHkgd2l0aG91dCB0aGUgYXJyYXkgd3JhcHBlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTaW1pbGFybHksIHRvIGxvY2FsbHkgb3ZlcnJpZGUgdGhlIHJlcXVlc3QvcmVzcG9uc2UgdHJhbnNmb3JtcywgYXVnbWVudCB0aGUgYHRyYW5zZm9ybVJlcXVlc3RgIGFuZC9vcgogICAgICAgICAgICAgICAgICogYHRyYW5zZm9ybVJlc3BvbnNlYCBwcm9wZXJ0aWVzIG9mIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCBwYXNzZWQgaW50byBgJGh0dHBgLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIENhY2hpbmcKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyBlbmFibGUgY2FjaGluZywgc2V0IHRoZSBjb25maWd1cmF0aW9uIHByb3BlcnR5IGBjYWNoZWAgdG8gYHRydWVgLiBXaGVuIHRoZSBjYWNoZSBpcwogICAgICAgICAgICAgICAgICogZW5hYmxlZCwgYCRodHRwYCBzdG9yZXMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciBpbiBsb2NhbCBjYWNoZS4gTmV4dCB0aW1lIHRoZQogICAgICAgICAgICAgICAgICogcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gdGhlIGNhY2hlIHdpdGhvdXQgc2VuZGluZyBhIHJlcXVlc3QgdG8gdGhlIHNlcnZlci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBOb3RlIHRoYXQgZXZlbiBpZiB0aGUgcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gY2FjaGUsIGRlbGl2ZXJ5IG9mIHRoZSBkYXRhIGlzIGFzeW5jaHJvbm91cyBpbgogICAgICAgICAgICAgICAgICogdGhlIHNhbWUgd2F5IHRoYXQgcmVhbCByZXF1ZXN0cyBhcmUuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogSWYgdGhlcmUgYXJlIG11bHRpcGxlIEdFVCByZXF1ZXN0cyBmb3IgdGhlIHNhbWUgVVJMIHRoYXQgc2hvdWxkIGJlIGNhY2hlZCB1c2luZyB0aGUgc2FtZQogICAgICAgICAgICAgICAgICogY2FjaGUsIGJ1dCB0aGUgY2FjaGUgaXMgbm90IHBvcHVsYXRlZCB5ZXQsIG9ubHkgb25lIHJlcXVlc3QgdG8gdGhlIHNlcnZlciB3aWxsIGJlIG1hZGUgYW5kCiAgICAgICAgICAgICAgICAgKiB0aGUgcmVtYWluaW5nIHJlcXVlc3RzIHdpbGwgYmUgZnVsZmlsbGVkIHVzaW5nIHRoZSByZXNwb25zZSBmcm9tIHRoZSBmaXJzdCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEEgY3VzdG9tIGRlZmF1bHQgY2FjaGUgYnVpbHQgd2l0aCAkY2FjaGVGYWN0b3J5IGNhbiBiZSBwcm92aWRlZCBpbiAkaHR0cC5kZWZhdWx0cy5jYWNoZS4KICAgICAgICAgICAgICAgICAqIFRvIHNraXAgaXQsIHNldCBjb25maWd1cmF0aW9uIHByb3BlcnR5IGBjYWNoZWAgdG8gYGZhbHNlYC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBJbnRlcmNlcHRvcnMKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBCZWZvcmUgeW91IHN0YXJ0IGNyZWF0aW5nIGludGVyY2VwdG9ycywgYmUgc3VyZSB0byB1bmRlcnN0YW5kIHRoZQogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRxICRxIGFuZCBkZWZlcnJlZC9wcm9taXNlIEFQSXN9LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciBwdXJwb3NlcyBvZiBnbG9iYWwgZXJyb3IgaGFuZGxpbmcsIGF1dGhlbnRpY2F0aW9uLCBvciBhbnkga2luZCBvZiBzeW5jaHJvbm91cyBvcgogICAgICAgICAgICAgICAgICogYXN5bmNocm9ub3VzIHByZS1wcm9jZXNzaW5nIG9mIHJlcXVlc3Qgb3IgcG9zdHByb2Nlc3Npbmcgb2YgcmVzcG9uc2VzLCBpdCBpcyBkZXNpcmFibGUgdG8gYmUKICAgICAgICAgICAgICAgICAqIGFibGUgdG8gaW50ZXJjZXB0IHJlcXVlc3RzIGJlZm9yZSB0aGV5IGFyZSBoYW5kZWQgdG8gdGhlIHNlcnZlciBhbmQKICAgICAgICAgICAgICAgICAqIHJlc3BvbnNlcyBiZWZvcmUgdGhleSBhcmUgaGFuZGVkIG92ZXIgdG8gdGhlIGFwcGxpY2F0aW9uIGNvZGUgdGhhdAogICAgICAgICAgICAgICAgICogaW5pdGlhdGVkIHRoZXNlIHJlcXVlc3RzLiBUaGUgaW50ZXJjZXB0b3JzIGxldmVyYWdlIHRoZSB7QGxpbmsgbmcuJHEKICAgICAgICAgICAgICAgICAqIHByb21pc2UgQVBJc30gdG8gZnVsZmlsbCB0aGlzIG5lZWQgZm9yIGJvdGggc3luY2hyb25vdXMgYW5kIGFzeW5jaHJvbm91cyBwcmUtcHJvY2Vzc2luZy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgaW50ZXJjZXB0b3JzIGFyZSBzZXJ2aWNlIGZhY3RvcmllcyB0aGF0IGFyZSByZWdpc3RlcmVkIHdpdGggdGhlIGAkaHR0cFByb3ZpZGVyYCBieQogICAgICAgICAgICAgICAgICogYWRkaW5nIHRoZW0gdG8gdGhlIGAkaHR0cFByb3ZpZGVyLmludGVyY2VwdG9yc2AgYXJyYXkuIFRoZSBmYWN0b3J5IGlzIGNhbGxlZCBhbmQKICAgICAgICAgICAgICAgICAqIGluamVjdGVkIHdpdGggZGVwZW5kZW5jaWVzIChpZiBzcGVjaWZpZWQpIGFuZCByZXR1cm5zIHRoZSBpbnRlcmNlcHRvci4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGVyZSBhcmUgdHdvIGtpbmRzIG9mIGludGVyY2VwdG9ycyAoYW5kIHR3byBraW5kcyBvZiByZWplY3Rpb24gaW50ZXJjZXB0b3JzKToKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICogYHJlcXVlc3RgOiBpbnRlcmNlcHRvcnMgZ2V0IGNhbGxlZCB3aXRoIGh0dHAgYGNvbmZpZ2Agb2JqZWN0LiBUaGUgZnVuY3Rpb24gaXMgZnJlZSB0byBtb2RpZnkKICAgICAgICAgICAgICAgICAqICAgICB0aGUgYGNvbmZpZ2Agb3IgY3JlYXRlIGEgbmV3IG9uZS4gVGhlIGZ1bmN0aW9uIG5lZWRzIHRvIHJldHVybiB0aGUgYGNvbmZpZ2AgZGlyZWN0bHkgb3IgYXMgYQogICAgICAgICAgICAgICAgICogICAgIHByb21pc2UuCiAgICAgICAgICAgICAgICAgKiAgICogYHJlcXVlc3RFcnJvcmA6IGludGVyY2VwdG9yIGdldHMgY2FsbGVkIHdoZW4gYSBwcmV2aW91cyBpbnRlcmNlcHRvciB0aHJldyBhbiBlcnJvciBvciByZXNvbHZlZAogICAgICAgICAgICAgICAgICogICAgICB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAgICAgICAgICAgICogICAqIGByZXNwb25zZWA6IGludGVyY2VwdG9ycyBnZXQgY2FsbGVkIHdpdGggaHR0cCBgcmVzcG9uc2VgIG9iamVjdC4gVGhlIGZ1bmN0aW9uIGlzIGZyZWUgdG8gbW9kaWZ5CiAgICAgICAgICAgICAgICAgKiAgICAgdGhlIGByZXNwb25zZWAgb3IgY3JlYXRlIGEgbmV3IG9uZS4gVGhlIGZ1bmN0aW9uIG5lZWRzIHRvIHJldHVybiB0aGUgYHJlc3BvbnNlYCBkaXJlY3RseSBvciBhcyBhCiAgICAgICAgICAgICAgICAgKiAgICAgcHJvbWlzZS4KICAgICAgICAgICAgICAgICAqICAgKiBgcmVzcG9uc2VFcnJvcmA6IGludGVyY2VwdG9yIGdldHMgY2FsbGVkIHdoZW4gYSBwcmV2aW91cyBpbnRlcmNlcHRvciB0aHJldyBhbiBlcnJvciBvciByZXNvbHZlZAogICAgICAgICAgICAgICAgICogICAgICB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgYXMgYSBzZXJ2aWNlCiAgICAgICAgICAgICAgICAgKiAgICRwcm92aWRlLmZhY3RvcnkoJ215SHR0cEludGVyY2VwdG9yJywgZnVuY3Rpb24oJHEsIGRlcGVuZGVuY3kxLCBkZXBlbmRlbmN5MikgewogICAgICAgICAgICAgICAgICogICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAgICAgICAgICAgICAqICAgICAgICdyZXF1ZXN0JzogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBzdWNjZXNzCiAgICAgICAgICAgICAgICAgKiAgICAgICAgIHJldHVybiBjb25maWcgfHwgJHEud2hlbihjb25maWcpOwogICAgICAgICAgICAgICAgICogICAgICAgfSwKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAgICAgICAgICAgICAqICAgICAgJ3JlcXVlc3RFcnJvcic6IGZ1bmN0aW9uKHJlamVjdGlvbikgewogICAgICAgICAgICAgICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAgICAgICAgICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVqZWN0aW9uKSkgewogICAgICAgICAgICAgICAgICogICAgICAgICAgIHJldHVybiByZXNwb25zZU9yTmV3UHJvbWlzZQogICAgICAgICAgICAgICAgICogICAgICAgICB9CiAgICAgICAgICAgICAgICAgKiAgICAgICAgIHJldHVybiAkcS5yZWplY3QocmVqZWN0aW9uKTsKICAgICAgICAgICAgICAgICAqICAgICAgIH0sCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAgICAgICAgICAgICAqICAgICAgICdyZXNwb25zZSc6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBzdWNjZXNzCiAgICAgICAgICAgICAgICAgKiAgICAgICAgIHJldHVybiByZXNwb25zZSB8fCAkcS53aGVuKHJlc3BvbnNlKTsKICAgICAgICAgICAgICAgICAqICAgICAgIH0sCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAgICAgLy8gb3B0aW9uYWwgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiAgICAgICdyZXNwb25zZUVycm9yJzogZnVuY3Rpb24ocmVqZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBlcnJvcgogICAgICAgICAgICAgICAgICogICAgICAgICBpZiAoY2FuUmVjb3ZlcihyZWplY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgICAgICAgICAgICAgKiAgICAgICAgIH0KICAgICAgICAgICAgICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZWplY3Rpb24pOwogICAgICAgICAgICAgICAgICogICAgICAgfTsKICAgICAgICAgICAgICAgICAqICAgICB9CiAgICAgICAgICAgICAgICAgKiAgIH0pOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgJGh0dHBQcm92aWRlci5pbnRlcmNlcHRvcnMucHVzaCgnbXlIdHRwSW50ZXJjZXB0b3InKTsKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgdmlhIGFuIGFub255bW91cyBmYWN0b3J5CiAgICAgICAgICAgICAgICAgKiAgICRodHRwUHJvdmlkZXIuaW50ZXJjZXB0b3JzLnB1c2goZnVuY3Rpb24oJHEsIGRlcGVuZGVuY3kxLCBkZXBlbmRlbmN5MikgewogICAgICAgICAgICAgICAgICogICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgKiAgICAgICdyZXF1ZXN0JzogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlCiAgICAgICAgICAgICAgICAgKiAgICAgICB9LAogICAgICAgICAgICAgICAgICogICAgICAgJ3Jlc3BvbnNlJzogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAqICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUKICAgICAgICAgICAgICAgICAqICAgICAgIH0KICAgICAgICAgICAgICAgICAqICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAjIFJlc3BvbnNlIGludGVyY2VwdG9ycyAoREVQUkVDQVRFRCkKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBCZWZvcmUgeW91IHN0YXJ0IGNyZWF0aW5nIGludGVyY2VwdG9ycywgYmUgc3VyZSB0byB1bmRlcnN0YW5kIHRoZQogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRxICRxIGFuZCBkZWZlcnJlZC9wcm9taXNlIEFQSXN9LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEZvciBwdXJwb3NlcyBvZiBnbG9iYWwgZXJyb3IgaGFuZGxpbmcsIGF1dGhlbnRpY2F0aW9uIG9yIGFueSBraW5kIG9mIHN5bmNocm9ub3VzIG9yCiAgICAgICAgICAgICAgICAgKiBhc3luY2hyb25vdXMgcHJlcHJvY2Vzc2luZyBvZiByZWNlaXZlZCByZXNwb25zZXMsIGl0IGlzIGRlc2lyYWJsZSB0byBiZSBhYmxlIHRvIGludGVyY2VwdAogICAgICAgICAgICAgICAgICogcmVzcG9uc2VzIGZvciBodHRwIHJlcXVlc3RzIGJlZm9yZSB0aGV5IGFyZSBoYW5kZWQgb3ZlciB0byB0aGUgYXBwbGljYXRpb24gY29kZSB0aGF0CiAgICAgICAgICAgICAgICAgKiBpbml0aWF0ZWQgdGhlc2UgcmVxdWVzdHMuIFRoZSByZXNwb25zZSBpbnRlcmNlcHRvcnMgbGV2ZXJhZ2UgdGhlIHtAbGluayBuZy4kcQogICAgICAgICAgICAgICAgICogcHJvbWlzZSBhcGlzfSB0byBmdWxmaWwgdGhpcyBuZWVkIGZvciBib3RoIHN5bmNocm9ub3VzIGFuZCBhc3luY2hyb25vdXMgcHJlcHJvY2Vzc2luZy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgaW50ZXJjZXB0b3JzIGFyZSBzZXJ2aWNlIGZhY3RvcmllcyB0aGF0IGFyZSByZWdpc3RlcmVkIHdpdGggdGhlICRodHRwUHJvdmlkZXIgYnkKICAgICAgICAgICAgICAgICAqIGFkZGluZyB0aGVtIHRvIHRoZSBgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9yc2AgYXJyYXkuIFRoZSBmYWN0b3J5IGlzIGNhbGxlZCBhbmQKICAgICAgICAgICAgICAgICAqIGluamVjdGVkIHdpdGggZGVwZW5kZW5jaWVzIChpZiBzcGVjaWZpZWQpIGFuZCByZXR1cm5zIHRoZSBpbnRlcmNlcHRvciAg4oCUIGEgZnVuY3Rpb24gdGhhdAogICAgICAgICAgICAgICAgICogdGFrZXMgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0gYW5kIHJldHVybnMgdGhlIG9yaWdpbmFsIG9yIGEgbmV3IHByb21pc2UuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICAgLy8gcmVnaXN0ZXIgdGhlIGludGVyY2VwdG9yIGFzIGEgc2VydmljZQogICAgICAgICAgICAgICAgICogICAkcHJvdmlkZS5mYWN0b3J5KCdteUh0dHBJbnRlcmNlcHRvcicsIGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAgICAgICAgICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICAgICAgICAgICAgICogICAgICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gc3VjY2VzcwogICAgICAgICAgICAgICAgICogICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgICAgICAgICAgICAgKiAgICAgICB9LCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAgICAgICAgICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVzcG9uc2UpKSB7CiAgICAgICAgICAgICAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgICAgICAgICAgICAgKiAgICAgICAgIH0KICAgICAgICAgICAgICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZXNwb25zZSk7CiAgICAgICAgICAgICAgICAgKiAgICAgICB9KTsKICAgICAgICAgICAgICAgICAqICAgICB9CiAgICAgICAgICAgICAgICAgKiAgIH0pOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKCdteUh0dHBJbnRlcmNlcHRvcicpOwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAgIC8vIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciB2aWEgYW4gYW5vbnltb3VzIGZhY3RvcnkKICAgICAgICAgICAgICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAgICAgICAgICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICAgICAgICAgICAgICogICAgICAgLy8gc2FtZSBhcyBhYm92ZQogICAgICAgICAgICAgICAgICogICAgIH0KICAgICAgICAgICAgICAgICAqICAgfSk7CiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogIyBTZWN1cml0eSBDb25zaWRlcmF0aW9ucwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFdoZW4gZGVzaWduaW5nIHdlYiBhcHBsaWNhdGlvbnMsIGNvbnNpZGVyIHNlY3VyaXR5IHRocmVhdHMgZnJvbToKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAtIHtAbGluayBodHRwOi8vaGFhY2tlZC5jb20vYXJjaGl2ZS8yMDA4LzExLzIwL2FuYXRvbXktb2YtYS1zdWJ0bGUtanNvbi12dWxuZXJhYmlsaXR5LmFzcHgKICAgICAgICAgICAgICAgICAqICAgSlNPTiB2dWxuZXJhYmlsaXR5fQogICAgICAgICAgICAgICAgICogLSB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1zaXRlX3JlcXVlc3RfZm9yZ2VyeSBYU1JGfQogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEJvdGggc2VydmVyIGFuZCB0aGUgY2xpZW50IG11c3QgY29vcGVyYXRlIGluIG9yZGVyIHRvIGVsaW1pbmF0ZSB0aGVzZSB0aHJlYXRzLiBBbmd1bGFyIGNvbWVzCiAgICAgICAgICAgICAgICAgKiBwcmUtY29uZmlndXJlZCB3aXRoIHN0cmF0ZWdpZXMgdGhhdCBhZGRyZXNzIHRoZXNlIGlzc3VlcywgYnV0IGZvciB0aGlzIHRvIHdvcmsgYmFja2VuZCBzZXJ2ZXIKICAgICAgICAgICAgICAgICAqIGNvb3BlcmF0aW9uIGlzIHJlcXVpcmVkLgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMjIEpTT04gVnVsbmVyYWJpbGl0eSBQcm90ZWN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQSB7QGxpbmsgaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4CiAgICAgICAgICAgICAgICAgKiBKU09OIHZ1bG5lcmFiaWxpdHl9IGFsbG93cyB0aGlyZCBwYXJ0eSB3ZWJzaXRlIHRvIHR1cm4geW91ciBKU09OIHJlc291cmNlIFVSTCBpbnRvCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9KU09OUCBKU09OUH0gcmVxdWVzdCB1bmRlciBzb21lIGNvbmRpdGlvbnMuIFRvCiAgICAgICAgICAgICAgICAgKiBjb3VudGVyIHRoaXMgeW91ciBzZXJ2ZXIgY2FuIHByZWZpeCBhbGwgSlNPTiByZXF1ZXN0cyB3aXRoIGZvbGxvd2luZyBzdHJpbmcgYCIpXX0nLFxuImAuCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyIHdpbGwgYXV0b21hdGljYWxseSBzdHJpcCB0aGUgcHJlZml4IGJlZm9yZSBwcm9jZXNzaW5nIGl0IGFzIEpTT04uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogRm9yIGV4YW1wbGUgaWYgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gcmV0dXJuOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqIFsnb25lJywndHdvJ10KICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIHdoaWNoIGlzIHZ1bG5lcmFibGUgdG8gYXR0YWNrLCB5b3VyIHNlcnZlciBjYW4gcmV0dXJuOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAqICldfScsCiAgICAgICAgICAgICAgICAgKiBbJ29uZScsJ3R3byddCiAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBBbmd1bGFyIHdpbGwgc3RyaXAgdGhlIHByZWZpeCwgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIEpTT04uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMjIENyb3NzIFNpdGUgUmVxdWVzdCBGb3JnZXJ5IChYU1JGKSBQcm90ZWN0aW9uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICoge0BsaW5rIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkgWFNSRn0gaXMgYSB0ZWNobmlxdWUgYnkgd2hpY2gKICAgICAgICAgICAgICAgICAqIGFuIHVuYXV0aG9yaXplZCBzaXRlIGNhbiBnYWluIHlvdXIgdXNlcidzIHByaXZhdGUgZGF0YS4gQW5ndWxhciBwcm92aWRlcyBhIG1lY2hhbmlzbQogICAgICAgICAgICAgICAgICogdG8gY291bnRlciBYU1JGLiBXaGVuIHBlcmZvcm1pbmcgWEhSIHJlcXVlc3RzLCB0aGUgJGh0dHAgc2VydmljZSByZWFkcyBhIHRva2VuIGZyb20gYSBjb29raWUKICAgICAgICAgICAgICAgICAqIChieSBkZWZhdWx0LCBgWFNSRi1UT0tFTmApIGFuZCBzZXRzIGl0IGFzIGFuIEhUVFAgaGVhZGVyIChgWC1YU1JGLVRPS0VOYCkuIFNpbmNlIG9ubHkKICAgICAgICAgICAgICAgICAqIEphdmFTY3JpcHQgdGhhdCBydW5zIG9uIHlvdXIgZG9tYWluIGNvdWxkIHJlYWQgdGhlIGNvb2tpZSwgeW91ciBzZXJ2ZXIgY2FuIGJlIGFzc3VyZWQgdGhhdAogICAgICAgICAgICAgICAgICogdGhlIFhIUiBjYW1lIGZyb20gSmF2YVNjcmlwdCBydW5uaW5nIG9uIHlvdXIgZG9tYWluLiBUaGUgaGVhZGVyIHdpbGwgbm90IGJlIHNldCBmb3IKICAgICAgICAgICAgICAgICAqIGNyb3NzLWRvbWFpbiByZXF1ZXN0cy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUbyB0YWtlIGFkdmFudGFnZSBvZiB0aGlzLCB5b3VyIHNlcnZlciBuZWVkcyB0byBzZXQgYSB0b2tlbiBpbiBhIEphdmFTY3JpcHQgcmVhZGFibGUgc2Vzc2lvbgogICAgICAgICAgICAgICAgICogY29va2llIGNhbGxlZCBgWFNSRi1UT0tFTmAgb24gdGhlIGZpcnN0IEhUVFAgR0VUIHJlcXVlc3QuIE9uIHN1YnNlcXVlbnQgWEhSIHJlcXVlc3RzIHRoZQogICAgICAgICAgICAgICAgICogc2VydmVyIGNhbiB2ZXJpZnkgdGhhdCB0aGUgY29va2llIG1hdGNoZXMgYFgtWFNSRi1UT0tFTmAgSFRUUCBoZWFkZXIsIGFuZCB0aGVyZWZvcmUgYmUgc3VyZQogICAgICAgICAgICAgICAgICogdGhhdCBvbmx5IEphdmFTY3JpcHQgcnVubmluZyBvbiB5b3VyIGRvbWFpbiBjb3VsZCBoYXZlIHNlbnQgdGhlIHJlcXVlc3QuIFRoZSB0b2tlbiBtdXN0IGJlCiAgICAgICAgICAgICAgICAgKiB1bmlxdWUgZm9yIGVhY2ggdXNlciBhbmQgbXVzdCBiZSB2ZXJpZmlhYmxlIGJ5IHRoZSBzZXJ2ZXIgKHRvIHByZXZlbnQgdGhlIEphdmFTY3JpcHQgZnJvbSBtYWtpbmcKICAgICAgICAgICAgICAgICAqIHVwIGl0cyBvd24gdG9rZW5zKS4gV2UgcmVjb21tZW5kIHRoYXQgdGhlIHRva2VuIGlzIGEgZGlnZXN0IG9mIHlvdXIgc2l0ZSdzIGF1dGhlbnRpY2F0aW9uCiAgICAgICAgICAgICAgICAgKiBjb29raWUgd2l0aCBhIHtAbGluayBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TYWx0XyhjcnlwdG9ncmFwaHkpIHNhbHR9IGZvciBhZGRlZCBzZWN1cml0eS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBUaGUgbmFtZSBvZiB0aGUgaGVhZGVycyBjYW4gYmUgc3BlY2lmaWVkIHVzaW5nIHRoZSB4c3JmSGVhZGVyTmFtZSBhbmQgeHNyZkNvb2tpZU5hbWUKICAgICAgICAgICAgICAgICAqIHByb3BlcnRpZXMgb2YgZWl0aGVyICRodHRwUHJvdmlkZXIuZGVmYXVsdHMsIG9yIHRoZSBwZXItcmVxdWVzdCBjb25maWcgb2JqZWN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gY29uZmlnIE9iamVjdCBkZXNjcmliaW5nIHRoZSByZXF1ZXN0IHRvIGJlIG1hZGUgYW5kIGhvdyBpdCBzaG91bGQgYmUKICAgICAgICAgICAgICAgICAqICAgIHByb2Nlc3NlZC4gVGhlIG9iamVjdCBoYXMgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogICAgLSAqKm1ldGhvZCoqIOKAkyBge3N0cmluZ31gIOKAkyBIVFRQIG1ldGhvZCAoZS5nLiAnR0VUJywgJ1BPU1QnLCBldGMpCiAgICAgICAgICAgICAgICAgKiAgICAtICoqdXJsKiog4oCTIGB7c3RyaW5nfWAg4oCTIEFic29sdXRlIG9yIHJlbGF0aXZlIFVSTCBvZiB0aGUgcmVzb3VyY2UgdGhhdCBpcyBiZWluZyByZXF1ZXN0ZWQuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqcGFyYW1zKiog4oCTIGB7T2JqZWN0LjxzdHJpbmd8T2JqZWN0Pn1gIOKAkyBNYXAgb2Ygc3RyaW5ncyBvciBvYmplY3RzIHdoaWNoIHdpbGwgYmUgdHVybmVkIHRvCiAgICAgICAgICAgICAgICAgKiAgICAgIGA/a2V5MT12YWx1ZTEma2V5Mj12YWx1ZTJgIGFmdGVyIHRoZSB1cmwuIElmIHRoZSB2YWx1ZSBpcyBub3QgYSBzdHJpbmcsIGl0IHdpbGwgYmUgSlNPTmlmaWVkLgogICAgICAgICAgICAgICAgICogICAgLSAqKmRhdGEqKiDigJMgYHtzdHJpbmd8T2JqZWN0fWAg4oCTIERhdGEgdG8gYmUgc2VudCBhcyB0aGUgcmVxdWVzdCBtZXNzYWdlIGRhdGEuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqaGVhZGVycyoqIOKAkyBge09iamVjdH1gIOKAkyBNYXAgb2Ygc3RyaW5ncyBvciBmdW5jdGlvbnMgd2hpY2ggcmV0dXJuIHN0cmluZ3MgcmVwcmVzZW50aW5nCiAgICAgICAgICAgICAgICAgKiAgICAgIEhUVFAgaGVhZGVycyB0byBzZW5kIHRvIHRoZSBzZXJ2ZXIuIElmIHRoZSByZXR1cm4gdmFsdWUgb2YgYSBmdW5jdGlvbiBpcyBudWxsLCB0aGUgaGVhZGVyIHdpbGwKICAgICAgICAgICAgICAgICAqICAgICAgbm90IGJlIHNlbnQuCiAgICAgICAgICAgICAgICAgKiAgICAtICoqeHNyZkhlYWRlck5hbWUqKiDigJMgYHtzdHJpbmd9YCDigJMgTmFtZSBvZiBIVFRQIGhlYWRlciB0byBwb3B1bGF0ZSB3aXRoIHRoZSBYU1JGIHRva2VuLgogICAgICAgICAgICAgICAgICogICAgLSAqKnhzcmZDb29raWVOYW1lKiog4oCTIGB7c3RyaW5nfWAg4oCTIE5hbWUgb2YgY29va2llIGNvbnRhaW5pbmcgdGhlIFhTUkYgdG9rZW4uCiAgICAgICAgICAgICAgICAgKiAgICAtICoqdHJhbnNmb3JtUmVxdWVzdCoqIOKAkyBge2Z1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpfEFycmF5LjxmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKT59YCDigJMKICAgICAgICAgICAgICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgICAgICAgICAgICAgKiAgICAgIHJlcXVlc3QgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICAgICAgICAgICAgICogICAgLSAqKnRyYW5zZm9ybVJlc3BvbnNlKiog4oCTIGB7ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcil8QXJyYXkuPGZ1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpPn1gIOKAkwogICAgICAgICAgICAgICAgICogICAgICB0cmFuc2Zvcm0gZnVuY3Rpb24gb3IgYW4gYXJyYXkgb2Ygc3VjaCBmdW5jdGlvbnMuIFRoZSB0cmFuc2Zvcm0gZnVuY3Rpb24gdGFrZXMgdGhlIGh0dHAKICAgICAgICAgICAgICAgICAqICAgICAgcmVzcG9uc2UgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBkZXNlcmlhbGl6ZWQpIHZlcnNpb24uCiAgICAgICAgICAgICAgICAgKiAgICAtICoqY2FjaGUqKiDigJMgYHtib29sZWFufENhY2hlfWAg4oCTIElmIHRydWUsIGEgZGVmYXVsdCAkaHR0cCBjYWNoZSB3aWxsIGJlIHVzZWQgdG8gY2FjaGUgdGhlCiAgICAgICAgICAgICAgICAgKiAgICAgIEdFVCByZXF1ZXN0LCBvdGhlcndpc2UgaWYgYSBjYWNoZSBpbnN0YW5jZSBidWlsdCB3aXRoCiAgICAgICAgICAgICAgICAgKiAgICAgIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LCB0aGlzIGNhY2hlIHdpbGwgYmUgdXNlZCBmb3IKICAgICAgICAgICAgICAgICAqICAgICAgY2FjaGluZy4KICAgICAgICAgICAgICAgICAqICAgIC0gKip0aW1lb3V0Kiog4oCTIGB7bnVtYmVyfFByb21pc2V9YCDigJMgdGltZW91dCBpbiBtaWxsaXNlY29uZHMsIG9yIHtAbGluayBuZy4kcSBwcm9taXNlfQogICAgICAgICAgICAgICAgICogICAgICB0aGF0IHNob3VsZCBhYm9ydCB0aGUgcmVxdWVzdCB3aGVuIHJlc29sdmVkLgogICAgICAgICAgICAgICAgICogICAgLSAqKndpdGhDcmVkZW50aWFscyoqIC0gYHtib29sZWFufWAgLSB3aGV0aGVyIHRvIHRvIHNldCB0aGUgYHdpdGhDcmVkZW50aWFsc2AgZmxhZyBvbiB0aGUKICAgICAgICAgICAgICAgICAqICAgICAgWEhSIG9iamVjdC4gU2VlIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9odHRwX2FjY2Vzc19jb250cm9sI3NlY3Rpb25fNQogICAgICAgICAgICAgICAgICogICAgICByZXF1ZXN0cyB3aXRoIGNyZWRlbnRpYWxzfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAgICAgICAgICAgICAqICAgIC0gKipyZXNwb25zZVR5cGUqKiAtIGB7c3RyaW5nfWAgLSBzZWUge0BsaW5rCiAgICAgICAgICAgICAgICAgKiAgICAgIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL1hNTEh0dHBSZXF1ZXN0I3Jlc3BvbnNlVHlwZSByZXF1ZXN0VHlwZX0uCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBSZXR1cm5zIGEge0BsaW5rIG5nLiRxIHByb21pc2V9IG9iamVjdCB3aXRoIHRoZQogICAgICAgICAgICAgICAgICogICBzdGFuZGFyZCBgdGhlbmAgbWV0aG9kIGFuZCB0d28gaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuIFRoZSBgdGhlbmAKICAgICAgICAgICAgICAgICAqICAgbWV0aG9kIHRha2VzIHR3byBhcmd1bWVudHMgYSBzdWNjZXNzIGFuZCBhbiBlcnJvciBjYWxsYmFjayB3aGljaCB3aWxsIGJlIGNhbGxlZCB3aXRoIGEKICAgICAgICAgICAgICAgICAqICAgcmVzcG9uc2Ugb2JqZWN0LiBUaGUgYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgIG1ldGhvZHMgdGFrZSBhIHNpbmdsZSBhcmd1bWVudCAtIGEgZnVuY3Rpb24gdGhhdAogICAgICAgICAgICAgICAgICogICB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IHN1Y2NlZWRzIG9yIGZhaWxzIHJlc3BlY3RpdmVseS4gVGhlIGFyZ3VtZW50cyBwYXNzZWQgaW50bwogICAgICAgICAgICAgICAgICogICB0aGVzZSBmdW5jdGlvbnMgYXJlIGRlc3RydWN0dXJlZCByZXByZXNlbnRhdGlvbiBvZiB0aGUgcmVzcG9uc2Ugb2JqZWN0IHBhc3NlZCBpbnRvIHRoZQogICAgICAgICAgICAgICAgICogICBgdGhlbmAgbWV0aG9kLiBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0aGVzZSBwcm9wZXJ0aWVzOgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICAgLSAqKmRhdGEqKiDigJMgYHtzdHJpbmd8T2JqZWN0fWAg4oCTIFRoZSByZXNwb25zZSBib2R5IHRyYW5zZm9ybWVkIHdpdGggdGhlIHRyYW5zZm9ybSBmdW5jdGlvbnMuCiAgICAgICAgICAgICAgICAgKiAgIC0gKipzdGF0dXMqKiDigJMgYHtudW1iZXJ9YCDigJMgSFRUUCBzdGF0dXMgY29kZSBvZiB0aGUgcmVzcG9uc2UuCiAgICAgICAgICAgICAgICAgKiAgIC0gKipoZWFkZXJzKiog4oCTIGB7ZnVuY3Rpb24oW2hlYWRlck5hbWVdKX1gIOKAkyBIZWFkZXIgZ2V0dGVyIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICogICAtICoqY29uZmlnKiog4oCTIGB7T2JqZWN0fWAg4oCTIFRoZSBjb25maWd1cmF0aW9uIG9iamVjdCB0aGF0IHdhcyB1c2VkIHRvIGdlbmVyYXRlIHRoZSByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPE9iamVjdD59IHBlbmRpbmdSZXF1ZXN0cyBBcnJheSBvZiBjb25maWcgb2JqZWN0cyBmb3IgY3VycmVudGx5IHBlbmRpbmcKICAgICAgICAgICAgICAgICAqICAgcmVxdWVzdHMuIFRoaXMgaXMgcHJpbWFyaWx5IG1lYW50IHRvIGJlIHVzZWQgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgICAgICAgPGV4YW1wbGU+CiAgICAgICAgICAgICAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICAgICAgICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkZldGNoQ3RybCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9Im1ldGhvZCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgPG9wdGlvbj5HRVQ8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICA8b3B0aW9uPkpTT05QPC9vcHRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InVybCIgc2l6ZT0iODAiLz4KICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iZmV0Y2goKSI+ZmV0Y2g8L2J1dHRvbj48YnI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9InVwZGF0ZU1vZGVsKCdHRVQnLCAnaHR0cC1oZWxsby5odG1sJykiPlNhbXBsZSBHRVQ8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywgJ2h0dHA6Ly9hbmd1bGFyanMub3JnL2dyZWV0LnBocD9jYWxsYmFjaz1KU09OX0NBTExCQUNLJm5hbWU9U3VwZXIlMjBIZXJvJykiPlNhbXBsZSBKU09OUDwvYnV0dG9uPgogICAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnSlNPTlAnLCAnaHR0cDovL2FuZ3VsYXJqcy5vcmcvZG9lc250ZXhpc3QmY2FsbGJhY2s9SlNPTl9DQUxMQkFDSycpIj5JbnZhbGlkIEpTT05QPC9idXR0b24+CiAgICAgICAgICAgICAgICAgICAgICAgIDxwcmU+aHR0cCBzdGF0dXMgY29kZToge3tzdGF0dXN9fTwvcHJlPgogICAgICAgICAgICAgICAgICAgICAgICA8cHJlPmh0dHAgcmVzcG9uc2UgZGF0YToge3tkYXRhfX08L3ByZT4KICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gRmV0Y2hDdHJsKCRzY29wZSwgJGh0dHAsICR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5tZXRob2QgPSAnR0VUJzsKICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnVybCA9ICdodHRwLWhlbGxvLmh0bWwnOwogICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmZldGNoID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmNvZGUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5yZXNwb25zZSA9IG51bGw7CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICRodHRwKHttZXRob2Q6ICRzY29wZS5tZXRob2QsIHVybDogJHNjb3BlLnVybCwgY2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuc3RhdHVzID0gc3RhdHVzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZGF0YSA9IGRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZGF0YSA9IGRhdGEgfHwgIlJlcXVlc3QgZmFpbGVkIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnN0YXR1cyA9IHN0YXR1czsKICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS51cGRhdGVNb2RlbCA9IGZ1bmN0aW9uKG1ldGhvZCwgdXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLm1ldGhvZCA9IG1ldGhvZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUudXJsID0gdXJsOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJodHRwLWhlbGxvLmh0bWwiPgogICAgICAgICAgICAgICAgICAgICAgSGVsbG8sICRodHRwIQogICAgICAgICAgICAgICAgICAgIDwvZmlsZT4KICAgICAgICAgICAgICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgYW4geGhyIEdFVCByZXF1ZXN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoIlNhbXBsZSBHRVQiKScpLmNsaWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoImZldGNoIiknKS5jbGljaygpOwogICAgICAgICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnc3RhdHVzJykpLnRvQmUoJzIwMCcpOwogICAgICAgICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b01hdGNoKC9IZWxsbywgXCRodHRwIS8pOwogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBtYWtlIGEgSlNPTlAgcmVxdWVzdCB0byBhbmd1bGFyanMub3JnJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQoJzpidXR0b246Y29udGFpbnMoIlNhbXBsZSBKU09OUCIpJykuY2xpY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiZmV0Y2giKScpLmNsaWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdzdGF0dXMnKSkudG9CZSgnMjAwJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdkYXRhJykpLnRvTWF0Y2goL1N1cGVyIEhlcm8hLyk7CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG1ha2UgSlNPTlAgcmVxdWVzdCB0byBpbnZhbGlkIFVSTCBhbmQgaW52b2tlIHRoZSBlcnJvciBoYW5kbGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiSW52YWxpZCBKU09OUCIpJykuY2xpY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCgnOmJ1dHRvbjpjb250YWlucygiZmV0Y2giKScpLmNsaWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdzdGF0dXMnKSkudG9CZSgnMCcpOwogICAgICAgICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGF0YScpKS50b0JlKCdSZXF1ZXN0IGZhaWxlZCcpOwogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgPC9maWxlPgogICAgICAgICAgICAgICAgICA8L2V4YW1wbGU+CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uICRodHRwKHJlcXVlc3RDb25maWcpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY29uZmlnID0gewogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1SZXF1ZXN0OiBkZWZhdWx0cy50cmFuc2Zvcm1SZXF1ZXN0LAogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1SZXNwb25zZTogZGVmYXVsdHMudHJhbnNmb3JtUmVzcG9uc2UKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHZhciBoZWFkZXJzID0gbWVyZ2VIZWFkZXJzKHJlcXVlc3RDb25maWcpOwoKICAgICAgICAgICAgICAgICAgICBleHRlbmQoY29uZmlnLCByZXF1ZXN0Q29uZmlnKTsKICAgICAgICAgICAgICAgICAgICBjb25maWcuaGVhZGVycyA9IGhlYWRlcnM7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLm1ldGhvZCA9IHVwcGVyY2FzZShjb25maWcubWV0aG9kKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHhzcmZWYWx1ZSA9ICQkdXJsVXRpbHMuaXNTYW1lT3JpZ2luKGNvbmZpZy51cmwpCiAgICAgICAgICAgICAgICAgICAgICAgID8gJGJyb3dzZXIuY29va2llcygpW2NvbmZpZy54c3JmQ29va2llTmFtZSB8fCBkZWZhdWx0cy54c3JmQ29va2llTmFtZV0KICAgICAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHhzcmZWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzWyhjb25maWcueHNyZkhlYWRlck5hbWUgfHwgZGVmYXVsdHMueHNyZkhlYWRlck5hbWUpXSA9IHhzcmZWYWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICB2YXIgc2VydmVyUmVxdWVzdCA9IGZ1bmN0aW9uIChjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycyA9IGNvbmZpZy5oZWFkZXJzOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVxRGF0YSA9IHRyYW5zZm9ybURhdGEoY29uZmlnLmRhdGEsIGhlYWRlcnNHZXR0ZXIoaGVhZGVycyksIGNvbmZpZy50cmFuc2Zvcm1SZXF1ZXN0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0cmlwIGNvbnRlbnQtdHlwZSBpZiBkYXRhIGlzIHVuZGVmaW5lZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLmRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGhlYWRlcnMsIGZ1bmN0aW9uICh2YWx1ZSwgaGVhZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShoZWFkZXIpID09PSAnY29udGVudC10eXBlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLndpdGhDcmVkZW50aWFscykgJiYgIWlzVW5kZWZpbmVkKGRlZmF1bHRzLndpdGhDcmVkZW50aWFscykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy53aXRoQ3JlZGVudGlhbHMgPSBkZWZhdWx0cy53aXRoQ3JlZGVudGlhbHM7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNlbmQgcmVxdWVzdAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIGhlYWRlcnMpLnRoZW4odHJhbnNmb3JtUmVzcG9uc2UsIHRyYW5zZm9ybVJlc3BvbnNlKTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICB2YXIgY2hhaW4gPSBbc2VydmVyUmVxdWVzdCwgdW5kZWZpbmVkXTsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9ICRxLndoZW4oY29uZmlnKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gYXBwbHkgaW50ZXJjZXB0b3JzCiAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChyZXZlcnNlZEludGVyY2VwdG9ycywgZnVuY3Rpb24gKGludGVyY2VwdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcmNlcHRvci5yZXF1ZXN0IHx8IGludGVyY2VwdG9yLnJlcXVlc3RFcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhaW4udW5zaGlmdChpbnRlcmNlcHRvci5yZXF1ZXN0LCBpbnRlcmNlcHRvci5yZXF1ZXN0RXJyb3IpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcmNlcHRvci5yZXNwb25zZSB8fCBpbnRlcmNlcHRvci5yZXNwb25zZUVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFpbi5wdXNoKGludGVyY2VwdG9yLnJlc3BvbnNlLCBpbnRlcmNlcHRvci5yZXNwb25zZUVycm9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY2hhaW4ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aGVuRm4gPSBjaGFpbi5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVqZWN0Rm4gPSBjaGFpbi5zaGlmdCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHByb21pc2UudGhlbih0aGVuRm4sIHJlamVjdEZuKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHByb21pc2Uuc3VjY2VzcyA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihyZXNwb25zZS5kYXRhLCByZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmhlYWRlcnMsIGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLmVycm9yID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihudWxsLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1SZXNwb25zZShyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBtYWtlIGEgY29weSBzaW5jZSB0aGUgcmVzcG9uc2UgbXVzdCBiZSBjYWNoZWFibGUKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3AgPSBleHRlbmQoe30sIHJlc3BvbnNlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB0cmFuc2Zvcm1EYXRhKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLmhlYWRlcnMsIGNvbmZpZy50cmFuc2Zvcm1SZXNwb25zZSkKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoaXNTdWNjZXNzKHJlc3BvbnNlLnN0YXR1cykpCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyByZXNwCiAgICAgICAgICAgICAgICAgICAgICAgICAgOiAkcS5yZWplY3QocmVzcCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBtZXJnZUhlYWRlcnMoY29uZmlnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZWZIZWFkZXJzID0gZGVmYXVsdHMuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcUhlYWRlcnMgPSBleHRlbmQoe30sIGNvbmZpZy5oZWFkZXJzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZkhlYWRlck5hbWUsIGxvd2VyY2FzZURlZkhlYWRlck5hbWUsIHJlcUhlYWRlck5hbWU7CgogICAgICAgICAgICAgICAgICAgICAgICBkZWZIZWFkZXJzID0gZXh0ZW5kKHt9LCBkZWZIZWFkZXJzLmNvbW1vbiwgZGVmSGVhZGVyc1tsb3dlcmNhc2UoY29uZmlnLm1ldGhvZCldKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGV4ZWN1dGUgaWYgaGVhZGVyIHZhbHVlIGlzIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWNIZWFkZXJzKGRlZkhlYWRlcnMpOwogICAgICAgICAgICAgICAgICAgICAgICBleGVjSGVhZGVycyhyZXFIZWFkZXJzKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVzaW5nIGZvci1pbiBpbnN0ZWFkIG9mIGZvckVhY2ggdG8gYXZvaWQgdW5lY2Vzc2FyeSBpdGVyYXRpb24gYWZ0ZXIgaGVhZGVyIGhhcyBiZWVuIGZvdW5kCiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRIZWFkZXJzSXRlcmF0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChkZWZIZWFkZXJOYW1lIGluIGRlZkhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb3dlcmNhc2VEZWZIZWFkZXJOYW1lID0gbG93ZXJjYXNlKGRlZkhlYWRlck5hbWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHJlcUhlYWRlck5hbWUgaW4gcmVxSGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobG93ZXJjYXNlKHJlcUhlYWRlck5hbWUpID09PSBsb3dlcmNhc2VEZWZIZWFkZXJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBkZWZhdWx0SGVhZGVyc0l0ZXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxSGVhZGVyc1tkZWZIZWFkZXJOYW1lXSA9IGRlZkhlYWRlcnNbZGVmSGVhZGVyTmFtZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVxSGVhZGVyczsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGV4ZWNIZWFkZXJzKGhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoZWFkZXJDb250ZW50OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24gKGhlYWRlckZuLCBoZWFkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihoZWFkZXJGbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyQ29udGVudCA9IGhlYWRlckZuKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoZWFkZXJDb250ZW50ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnNbaGVhZGVyXSA9IGhlYWRlckNvbnRlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJGh0dHAucGVuZGluZ1JlcXVlc3RzID0gW107CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNnZXQKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEdFVGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNkZWxldGUKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYERFTEVURWAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kaHR0cCNoZWFkCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBIRUFEYCByZXF1ZXN0LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2pzb25wCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBKU09OUGAgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgU2hvdWxkIGNvbnRhaW4gYEpTT05fQ0FMTEJBQ0tgIHN0cmluZy4KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY3JlYXRlU2hvcnRNZXRob2RzKCdnZXQnLCAnZGVsZXRlJywgJ2hlYWQnLCAnanNvbnAnKTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI3Bvc3QKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYFBPU1RgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGh0dHAjcHV0CiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGh0dHAKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBQVVRgIHJlcXVlc3QuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY3JlYXRlU2hvcnRNZXRob2RzV2l0aERhdGEoJ3Bvc3QnLCAncHV0Jyk7CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRodHRwI2RlZmF1bHRzCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHlPZiBuZy4kaHR0cAogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogUnVudGltZSBlcXVpdmFsZW50IG9mIHRoZSBgJGh0dHBQcm92aWRlci5kZWZhdWx0c2AgcHJvcGVydHkuIEFsbG93cyBjb25maWd1cmF0aW9uIG9mCiAgICAgICAgICAgICAgICAgKiBkZWZhdWx0IGhlYWRlcnMsIHdpdGhDcmVkZW50aWFscyBhcyB3ZWxsIGFzIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWF0aW9ucy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBTZWUgIlNldHRpbmcgSFRUUCBIZWFkZXJzIiBhbmQgIlRyYW5zZm9ybWluZyBSZXF1ZXN0cyBhbmQgUmVzcG9uc2VzIiBzZWN0aW9ucyBhYm92ZS4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgJGh0dHAuZGVmYXVsdHMgPSBkZWZhdWx0czsKCgogICAgICAgICAgICAgICAgcmV0dXJuICRodHRwOwoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVTaG9ydE1ldGhvZHMobmFtZXMpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbiAodXJsLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kc1dpdGhEYXRhKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbiAodXJsLCBkYXRhLCBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBNYWtlcyB0aGUgcmVxdWVzdC4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiAhISEgQUNDRVNTRVMgQ0xPU1VSRSBWQVJTOgogICAgICAgICAgICAgICAgICogJGh0dHBCYWNrZW5kLCBkZWZhdWx0cywgJGxvZywgJHJvb3RTY29wZSwgZGVmYXVsdENhY2hlLCAkaHR0cC5wZW5kaW5nUmVxdWVzdHMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIHJlcUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSwKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlZFJlc3AsCiAgICAgICAgICAgICAgICAgICAgICAgIHVybCA9IGJ1aWxkVXJsKGNvbmZpZy51cmwsIGNvbmZpZy5wYXJhbXMpOwoKICAgICAgICAgICAgICAgICAgICAkaHR0cC5wZW5kaW5nUmVxdWVzdHMucHVzaChjb25maWcpOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKCgogICAgICAgICAgICAgICAgICAgIGlmICgoY29uZmlnLmNhY2hlIHx8IGRlZmF1bHRzLmNhY2hlKSAmJiBjb25maWcuY2FjaGUgIT09IGZhbHNlICYmIGNvbmZpZy5tZXRob2QgPT0gJ0dFVCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUgPSBpc09iamVjdChjb25maWcuY2FjaGUpID8gY29uZmlnLmNhY2hlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogaXNPYmplY3QoZGVmYXVsdHMuY2FjaGUpID8gZGVmYXVsdHMuY2FjaGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBkZWZhdWx0Q2FjaGU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcCA9IGNhY2hlLmdldCh1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGNhY2hlZFJlc3ApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVkUmVzcC50aGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FjaGVkIHJlcXVlc3QgaGFzIGFscmVhZHkgYmVlbiBzZW50LCBidXQgdGhlcmUgaXMgbm8gcmVzcG9uc2UgeWV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVkUmVzcC50aGVuKHJlbW92ZVBlbmRpbmdSZXEsIHJlbW92ZVBlbmRpbmdSZXEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWRSZXNwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXJ2aW5nIGZyb20gY2FjaGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjYWNoZWRSZXNwKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShjYWNoZWRSZXNwWzFdLCBjYWNoZWRSZXNwWzBdLCBjb3B5KGNhY2hlZFJlc3BbMl0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlUHJvbWlzZShjYWNoZWRSZXNwLCAyMDAsIHt9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwdXQgdGhlIHByb21pc2UgZm9yIHRoZSBub24tdHJhbnNmb3JtZWQgcmVzcG9uc2UgaW50byBjYWNoZSBhcyBhIHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZS5wdXQodXJsLCBwcm9taXNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgd2Ugd29uJ3QgaGF2ZSB0aGUgcmVzcG9uc2UgaW4gY2FjaGUsIHNlbmQgdGhlIHJlcXVlc3QgdG8gdGhlIGJhY2tlbmQKICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHBCYWNrZW5kKGNvbmZpZy5tZXRob2QsIHVybCwgcmVxRGF0YSwgZG9uZSwgcmVxSGVhZGVycywgY29uZmlnLnRpbWVvdXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcud2l0aENyZWRlbnRpYWxzLCBjb25maWcucmVzcG9uc2VUeXBlKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQ2FsbGJhY2sgcmVnaXN0ZXJlZCB0byAkaHR0cEJhY2tlbmQoKToKICAgICAgICAgICAgICAgICAgICAgKiAgLSBjYWNoZXMgdGhlIHJlc3BvbnNlIGlmIGRlc2lyZWQKICAgICAgICAgICAgICAgICAgICAgKiAgLSByZXNvbHZlcyB0aGUgcmF3ICRodHRwIHByb21pc2UKICAgICAgICAgICAgICAgICAgICAgKiAgLSBjYWxscyAkYXBwbHkKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBkb25lKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdWNjZXNzKHN0YXR1cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZS5wdXQodXJsLCBbc3RhdHVzLCByZXNwb25zZSwgcGFyc2VIZWFkZXJzKGhlYWRlcnNTdHJpbmcpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBwcm9taXNlIGZyb20gdGhlIGNhY2hlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUucmVtb3ZlKHVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVQcm9taXNlKHJlc3BvbnNlLCBzdGF0dXMsIGhlYWRlcnNTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISRyb290U2NvcGUuJCRwaGFzZSkgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBSZXNvbHZlcyB0aGUgcmF3ICRodHRwIHByb21pc2UuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZVByb21pc2UocmVzcG9uc2UsIHN0YXR1cywgaGVhZGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBub3JtYWxpemUgaW50ZXJuYWwgc3RhdHVzZXMgdG8gMAogICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSBNYXRoLm1heChzdGF0dXMsIDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgKGlzU3VjY2VzcyhzdGF0dXMpID8gZGVmZXJyZWQucmVzb2x2ZSA6IGRlZmVycmVkLnJlamVjdCkoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogcmVzcG9uc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHN0YXR1cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnNHZXR0ZXIoaGVhZGVycyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWc6IGNvbmZpZwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiByZW1vdmVQZW5kaW5nUmVxKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWR4ID0gaW5kZXhPZigkaHR0cC5wZW5kaW5nUmVxdWVzdHMsIGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpZHggIT09IC0xKSAkaHR0cC5wZW5kaW5nUmVxdWVzdHMuc3BsaWNlKGlkeCwgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBidWlsZFVybCh1cmwsIHBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIGlmICghcGFyYW1zKSByZXR1cm4gdXJsOwogICAgICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvckVhY2hTb3J0ZWQocGFyYW1zLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCB8fCB2YWx1ZSA9PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlKSkgdmFsdWUgPSBbdmFsdWVdOwoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaCh2YWx1ZSwgZnVuY3Rpb24gKHYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc09iamVjdCh2KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB0b0pzb24odik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGVuY29kZVVyaVF1ZXJ5KGtleSkgKyAnPScgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGVVcmlRdWVyeSh2KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cmwgKyAoKHVybC5pbmRleE9mKCc/JykgPT0gLTEpID8gJz8nIDogJyYnKSArIHBhcnRzLmpvaW4oJyYnKTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICB9XTsKICAgIH0KCiAgICB2YXIgWEhSID0gd2luZG93LlhNTEh0dHBSZXF1ZXN0IHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICB0cnkgeyByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1zeG1sMi5YTUxIVFRQLjYuMCIpOyB9IGNhdGNoIChlMSkgeyB9CiAgICAgICAgdHJ5IHsgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCJNc3htbDIuWE1MSFRUUC4zLjAiKTsgfSBjYXRjaCAoZTIpIHsgfQogICAgICAgIHRyeSB7IHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTXN4bWwyLlhNTEhUVFAiKTsgfSBjYXRjaCAoZTMpIHsgfQogICAgICAgIHRocm93IG1pbkVycignJGh0dHBCYWNrZW5kJykoJ25veGhyJywgIlRoaXMgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IFhNTEh0dHBSZXF1ZXN0LiIpOwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kaHR0cEJhY2tlbmQKICAgICAqIEByZXF1aXJlcyAkYnJvd3NlcgogICAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgICAqIEByZXF1aXJlcyAkZG9jdW1lbnQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEhUVFAgYmFja2VuZCB1c2VkIGJ5IHRoZSB7QGxpbmsgbmcuJGh0dHAgc2VydmljZX0gdGhhdCBkZWxlZ2F0ZXMgdG8KICAgICAqIFhNTEh0dHBSZXF1ZXN0IG9iamVjdCBvciBKU09OUCBhbmQgZGVhbHMgd2l0aCBicm93c2VyIGluY29tcGF0aWJpbGl0aWVzLgogICAgICoKICAgICAqIFlvdSBzaG91bGQgbmV2ZXIgbmVlZCB0byB1c2UgdGhpcyBzZXJ2aWNlIGRpcmVjdGx5LCBpbnN0ZWFkIHVzZSB0aGUgaGlnaGVyLWxldmVsIGFic3RyYWN0aW9uczoKICAgICAqIHtAbGluayBuZy4kaHR0cCAkaHR0cH0gb3Ige0BsaW5rIG5nUmVzb3VyY2UuJHJlc291cmNlICRyZXNvdXJjZX0uCiAgICAgKgogICAgICogRHVyaW5nIHRlc3RpbmcgdGhpcyBpbXBsZW1lbnRhdGlvbiBpcyBzd2FwcGVkIHdpdGgge0BsaW5rIG5nTW9jay4kaHR0cEJhY2tlbmQgbW9jawogICAgICogJGh0dHBCYWNrZW5kfSB3aGljaCBjYW4gYmUgdHJhaW5lZCB3aXRoIHJlc3BvbnNlcy4KICAgICAqLwogICAgZnVuY3Rpb24gJEh0dHBCYWNrZW5kUHJvdmlkZXIoKSB7CiAgICAgICAgdGhpcy4kZ2V0ID0gWyckYnJvd3NlcicsICckd2luZG93JywgJyRkb2N1bWVudCcsIGZ1bmN0aW9uICgkYnJvd3NlciwgJHdpbmRvdywgJGRvY3VtZW50KSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVIdHRwQmFja2VuZCgkYnJvd3NlciwgWEhSLCAkYnJvd3Nlci5kZWZlciwgJHdpbmRvdy5hbmd1bGFyLmNhbGxiYWNrcywKICAgICAgICAgICAgICAgICRkb2N1bWVudFswXSwgJHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbC5yZXBsYWNlKCc6JywgJycpKTsKICAgICAgICB9XTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVIdHRwQmFja2VuZCgkYnJvd3NlciwgWEhSLCAkYnJvd3NlckRlZmVyLCBjYWxsYmFja3MsIHJhd0RvY3VtZW50LCBsb2NhdGlvblByb3RvY29sKSB7CiAgICAgICAgLy8gVE9ETyh2b2p0YSk6IGZpeCB0aGUgc2lnbmF0dXJlCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChtZXRob2QsIHVybCwgcG9zdCwgY2FsbGJhY2ssIGhlYWRlcnMsIHRpbWVvdXQsIHdpdGhDcmVkZW50aWFscywgcmVzcG9uc2VUeXBlKSB7CiAgICAgICAgICAgIHZhciBzdGF0dXM7CiAgICAgICAgICAgICRicm93c2VyLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQoKTsKICAgICAgICAgICAgdXJsID0gdXJsIHx8ICRicm93c2VyLnVybCgpOwoKICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShtZXRob2QpID09ICdqc29ucCcpIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja0lkID0gJ18nICsgKGNhbGxiYWNrcy5jb3VudGVyKyspLnRvU3RyaW5nKDM2KTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEgPSBkYXRhOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB2YXIganNvbnBEb25lID0ganNvbnBSZXEodXJsLnJlcGxhY2UoJ0pTT05fQ0FMTEJBQ0snLCAnYW5ndWxhci5jYWxsYmFja3MuJyArIGNhbGxiYWNrSWQpLAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc1tjYWxsYmFja0lkXS5kYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIDIwMCwgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLCBzdGF0dXMgfHwgLTIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYWxsYmFja3NbY2FsbGJhY2tJZF07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgeGhyID0gbmV3IFhIUigpOwogICAgICAgICAgICAgICAgeGhyLm9wZW4obWV0aG9kLCB1cmwsIHRydWUpOwogICAgICAgICAgICAgICAgZm9yRWFjaChoZWFkZXJzLCBmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgeGhyLnNldFJlcXVlc3RIZWFkZXIoa2V5LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyBJbiBJRTYgYW5kIDcsIHRoaXMgbWlnaHQgYmUgY2FsbGVkIHN5bmNocm9ub3VzbHkgd2hlbiB4aHIuc2VuZCBiZWxvdyBpcyBjYWxsZWQgYW5kIHRoZQogICAgICAgICAgICAgICAgLy8gcmVzcG9uc2UgaXMgaW4gdGhlIGNhY2hlLiB0aGUgcHJvbWlzZSBhcGkgd2lsbCBlbnN1cmUgdGhhdCB0byB0aGUgYXBwIGNvZGUgdGhlIGFwaSBpcwogICAgICAgICAgICAgICAgLy8gYWx3YXlzIGFzeW5jCiAgICAgICAgICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNwb25zZUhlYWRlcnMgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHZvanRhKTogcmVtb3ZlIG9uY2UgRmlyZWZveCAyMSBnZXRzIHJlbGVhc2VkLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBiZWdpbjogd29ya2Fyb3VuZCB0byBvdmVyY29tZSBGaXJlZm94IENPUlMgaHR0cCByZXNwb25zZSBoZWFkZXJzIGJ1ZwogICAgICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02MDg3MzUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmlyZWZveCBhbHJlYWR5IHBhdGNoZWQgaW4gbmlnaHRseS4gU2hvdWxkIGxhbmQgaW4gRmlyZWZveCAyMS4KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENPUlMgInNpbXBsZSByZXNwb25zZSBoZWFkZXJzIiBodHRwOi8vd3d3LnczLm9yZy9UUi9jb3JzLwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaW1wbGVIZWFkZXJzID0gWyJDYWNoZS1Db250cm9sIiwgIkNvbnRlbnQtTGFuZ3VhZ2UiLCAiQ29udGVudC1UeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkV4cGlyZXMiLCAiTGFzdC1Nb2RpZmllZCIsICJQcmFnbWEiXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChzaW1wbGVIZWFkZXJzLCBmdW5jdGlvbiAoaGVhZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0geGhyLmdldFJlc3BvbnNlSGVhZGVyKGhlYWRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyArPSBoZWFkZXIgKyAiOiAiICsgdmFsdWUgKyAiXG4iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVuZCBvZiB0aGUgd29ya2Fyb3VuZC4KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlc3BvbnNlVGV4dCBpcyB0aGUgb2xkLXNjaG9vbCB3YXkgb2YgcmV0cmlldmluZyByZXNwb25zZSAoc3VwcG9ydGVkIGJ5IElFOCAmIDkpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlc3BvbnNlIGFuZCByZXNwb25zZVR5cGUgcHJvcGVydGllcyB3ZXJlIGludHJvZHVjZWQgaW4gWEhSIExldmVsMiBzcGVjIChzdXBwb3J0ZWQgYnkgSUUxMCkKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzIHx8IHhoci5zdGF0dXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoeGhyLnJlc3BvbnNlVHlwZSA/IHhoci5yZXNwb25zZSA6IHhoci5yZXNwb25zZVRleHQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGlmICh3aXRoQ3JlZGVudGlhbHMpIHsKICAgICAgICAgICAgICAgICAgICB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2VUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9IHJlc3BvbnNlVHlwZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB4aHIuc2VuZChwb3N0IHx8ICcnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRpbWVvdXQgPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZW91dElkID0gJGJyb3dzZXJEZWZlcih0aW1lb3V0UmVxdWVzdCwgdGltZW91dCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGltZW91dCAmJiB0aW1lb3V0LnRoZW4pIHsKICAgICAgICAgICAgICAgIHRpbWVvdXQudGhlbih0aW1lb3V0UmVxdWVzdCk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBmdW5jdGlvbiB0aW1lb3V0UmVxdWVzdCgpIHsKICAgICAgICAgICAgICAgIHN0YXR1cyA9IC0xOwogICAgICAgICAgICAgICAganNvbnBEb25lICYmIGpzb25wRG9uZSgpOwogICAgICAgICAgICAgICAgeGhyICYmIHhoci5hYm9ydCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpIHsKICAgICAgICAgICAgICAgIC8vIFVSTF9NQVRDSCBpcyBkZWZpbmVkIGluIHNyYy9zZXJ2aWNlL2xvY2F0aW9uLmpzCiAgICAgICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSAodXJsLm1hdGNoKFNFUlZFUl9NQVRDSCkgfHwgWycnLCBsb2NhdGlvblByb3RvY29sXSlbMV07CgogICAgICAgICAgICAgICAgLy8gY2FuY2VsIHRpbWVvdXQgYW5kIHN1YnNlcXVlbnQgdGltZW91dCBwcm9taXNlIHJlc29sdXRpb24KICAgICAgICAgICAgICAgIHRpbWVvdXRJZCAmJiAkYnJvd3NlckRlZmVyLmNhbmNlbCh0aW1lb3V0SWQpOwogICAgICAgICAgICAgICAganNvbnBEb25lID0geGhyID0gbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBmaXggc3RhdHVzIGNvZGUgZm9yIGZpbGUgcHJvdG9jb2wgKGl0J3MgYWx3YXlzIDApCiAgICAgICAgICAgICAgICBzdGF0dXMgPSAocHJvdG9jb2wgPT0gJ2ZpbGUnKSA/IChyZXNwb25zZSA/IDIwMCA6IDQwNCkgOiBzdGF0dXM7CgogICAgICAgICAgICAgICAgLy8gbm9ybWFsaXplIElFIGJ1ZyAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTQ1MCkKICAgICAgICAgICAgICAgIHN0YXR1cyA9IHN0YXR1cyA9PSAxMjIzID8gMjA0IDogc3RhdHVzOwoKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcpOwogICAgICAgICAgICAgICAgJGJyb3dzZXIuJCRjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGpzb25wUmVxKHVybCwgZG9uZSkgewogICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UgalF1ZXJ5L2pxTGl0ZSBoZXJlIGJlY2F1c2UgalF1ZXJ5IGRvZXMgY3Jhenkgc2hpdCB3aXRoIHNjcmlwdCBlbGVtZW50cywgZS5nLjoKICAgICAgICAgICAgLy8gLSBmZXRjaGVzIGxvY2FsIHNjcmlwdHMgdmlhIFhIUiBhbmQgZXZhbHMgdGhlbQogICAgICAgICAgICAvLyAtIGFkZHMgYW5kIGltbWVkaWF0ZWx5IHJlbW92ZXMgc2NyaXB0IGVsZW1lbnRzIGZyb20gdGhlIGRvY3VtZW50CiAgICAgICAgICAgIHZhciBzY3JpcHQgPSByYXdEb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgIGRvbmVXcmFwcGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJhd0RvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9uZSkgZG9uZSgpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7CiAgICAgICAgICAgIHNjcmlwdC5zcmMgPSB1cmw7CgogICAgICAgICAgICBpZiAobXNpZSkgewogICAgICAgICAgICAgICAgc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoL2xvYWRlZHxjb21wbGV0ZS8udGVzdChzY3JpcHQucmVhZHlTdGF0ZSkpIGRvbmVXcmFwcGVyKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbmVycm9yID0gZG9uZVdyYXBwZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJhd0RvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgICAgICAgICAgcmV0dXJuIGRvbmVXcmFwcGVyOwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgJGludGVycG9sYXRlTWluRXJyID0gbWluRXJyKCckaW50ZXJwb2xhdGUnKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBVc2VkIGZvciBjb25maWd1cmluZyB0aGUgaW50ZXJwb2xhdGlvbiBtYXJrdXAuIERlZmF1bHRzIHRvIGB7e2AgYW5kIGB9fWAuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZSBtb2R1bGU9ImN1c3RvbUludGVycG9sYXRpb25BcHAiPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgIHZhciBjdXN0b21JbnRlcnBvbGF0aW9uQXBwID0gYW5ndWxhci5tb2R1bGUoJ2N1c3RvbUludGVycG9sYXRpb25BcHAnLCBbXSk7CiAgICAKICAgICAgICAgICAgY3VzdG9tSW50ZXJwb2xhdGlvbkFwcC5jb25maWcoZnVuY3Rpb24oJGludGVycG9sYXRlUHJvdmlkZXIpIHsKICAgICAgICAgICAgICAkaW50ZXJwb2xhdGVQcm92aWRlci5zdGFydFN5bWJvbCgnLy8nKTsKICAgICAgICAgICAgICAkaW50ZXJwb2xhdGVQcm92aWRlci5lbmRTeW1ib2woJy8vJyk7CiAgICAgICAgICAgIH0pOwogICAgCiAgICAKICAgICAgICAgICAgY3VzdG9tSW50ZXJwb2xhdGlvbkFwcC5jb250cm9sbGVyKCdEZW1vQ29udHJvbGxlcicsIGZ1bmN0aW9uIERlbW9Db250cm9sbGVyKCkgewogICAgICAgICAgICAgICAgdGhpcy5sYWJlbCA9ICJUaGlzIGJpbmRpbmdzIGlzIGJyb3VnaHQgeW91IHlvdSBieSAvLyBpbnRlcnBvbGF0aW9uIHN5bWJvbHMuIjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgIDxkaXYgbmctYXBwPSJBcHAiIG5nLWNvbnRyb2xsZXI9IkRlbW9Db250cm9sbGVyIGFzIGRlbW8iPgogICAgICAgICAgICAgIC8vZGVtby5sYWJlbC8vCiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgIGl0KCdzaG91bGQgaW50ZXJwb2xhdGUgYmluZGluZyB3aXRoIGN1c3RvbSBzeW1ib2xzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnZGVtby5sYWJlbCcpKS50b0JlKCdUaGlzIGJpbmRpbmdzIGlzIGJyb3VnaHQgeW91IHlvdSBieSAvLyBpbnRlcnBvbGF0aW9uIHN5bWJvbHMuJyk7CiAgICAgICAgICAgfSk7CiAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICBmdW5jdGlvbiAkSW50ZXJwb2xhdGVQcm92aWRlcigpIHsKICAgICAgICB2YXIgc3RhcnRTeW1ib2wgPSAne3snOwogICAgICAgIHZhciBlbmRTeW1ib2wgPSAnfX0nOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGludGVycG9sYXRlUHJvdmlkZXIKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIG5ldyB2YWx1ZSB0byBzZXQgdGhlIHN0YXJ0aW5nIHN5bWJvbCB0by4KICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAgICAgICAqLwogICAgICAgIHRoaXMuc3RhcnRTeW1ib2wgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBzdGFydFN5bWJvbCA9IHZhbHVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RhcnRTeW1ib2w7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjZW5kU3ltYm9sCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgZW5kIG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB9fWAuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIG5ldyB2YWx1ZSB0byBzZXQgdGhlIGVuZGluZyBzeW1ib2wgdG8uCiAgICAgICAgICogQHJldHVybnMge3N0cmluZ3xzZWxmfSBSZXR1cm5zIHRoZSBzeW1ib2wgd2hlbiB1c2VkIGFzIGdldHRlciBhbmQgc2VsZiBpZiB1c2VkIGFzIHNldHRlci4KICAgICAgICAgKi8KICAgICAgICB0aGlzLmVuZFN5bWJvbCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGVuZFN5bWJvbCA9IHZhbHVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZW5kU3ltYm9sOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCgogICAgICAgIHRoaXMuJGdldCA9IFsnJHBhcnNlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRzY2UnLCBmdW5jdGlvbiAoJHBhcnNlLCAkZXhjZXB0aW9uSGFuZGxlciwgJHNjZSkgewogICAgICAgICAgICB2YXIgc3RhcnRTeW1ib2xMZW5ndGggPSBzdGFydFN5bWJvbC5sZW5ndGgsCiAgICAgICAgICAgICAgICBlbmRTeW1ib2xMZW5ndGggPSBlbmRTeW1ib2wubGVuZ3RoOwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGUKICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXF1aXJlcyAkcGFyc2UKICAgICAgICAgICAgICogQHJlcXVpcmVzICRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIENvbXBpbGVzIGEgc3RyaW5nIHdpdGggbWFya3VwIGludG8gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4gVGhpcyBzZXJ2aWNlIGlzIHVzZWQgYnkgdGhlCiAgICAgICAgICAgICAqIEhUTUwge0BsaW5rIG5nLiRjb21waWxlICRjb21waWxlfSBzZXJ2aWNlIGZvciBkYXRhIGJpbmRpbmcuIFNlZQogICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGludGVycG9sYXRlUHJvdmlkZXIgJGludGVycG9sYXRlUHJvdmlkZXJ9IGZvciBjb25maWd1cmluZyB0aGUKICAgICAgICAgICAgICogaW50ZXJwb2xhdGlvbiBtYXJrdXAuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgIDxwcmU+CiAgICAgICAgICAgICAgICAgdmFyICRpbnRlcnBvbGF0ZSA9IC4uLjsgLy8gaW5qZWN0ZWQKICAgICAgICAgICAgICAgICB2YXIgZXhwID0gJGludGVycG9sYXRlKCdIZWxsbyB7e25hbWV9fSEnKTsKICAgICAgICAgICAgICAgICBleHBlY3QoZXhwKHtuYW1lOidBbmd1bGFyJ30pLnRvRXF1YWwoJ0hlbGxvIEFuZ3VsYXIhJyk7CiAgICAgICAgICAgICAgIDwvcHJlPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBUaGUgdGV4dCB3aXRoIG1hcmt1cCB0byBpbnRlcnBvbGF0ZS4KICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gbXVzdEhhdmVFeHByZXNzaW9uIGlmIHNldCB0byB0cnVlIHRoZW4gdGhlIGludGVycG9sYXRpb24gc3RyaW5nIG11c3QgaGF2ZQogICAgICAgICAgICAgKiAgICBlbWJlZGRlZCBleHByZXNzaW9uIGluIG9yZGVyIHRvIHJldHVybiBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLiBTdHJpbmdzIHdpdGggbm8KICAgICAgICAgICAgICogICAgZW1iZWRkZWQgZXhwcmVzc2lvbiB3aWxsIHJldHVybiBudWxsIGZvciB0aGUgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4KICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSB0cnVzdGVkQ29udGV4dCB3aGVuIHByb3ZpZGVkLCB0aGUgcmV0dXJuZWQgZnVuY3Rpb24gcGFzc2VzIHRoZSBpbnRlcnBvbGF0ZWQKICAgICAgICAgICAgICogICAgcmVzdWx0IHRocm91Z2gge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWQoaW50ZXJwb2xhdGVkUmVzdWx0LAogICAgICAgICAgICAgKiAgICB0cnVzdGVkQ29udGV4dCl9IGJlZm9yZSByZXR1cm5pbmcgaXQuICBSZWZlciB0byB0aGUge0BsaW5rIG5nLiRzY2UgJHNjZX0gc2VydmljZSB0aGF0CiAgICAgICAgICAgICAqICAgIHByb3ZpZGVzIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIGZvciBkZXRhaWxzLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCl9IGFuIGludGVycG9sYXRpb24gZnVuY3Rpb24gd2hpY2ggaXMgdXNlZCB0byBjb21wdXRlIHRoZSBpbnRlcnBvbGF0ZWQKICAgICAgICAgICAgICogICAgc3RyaW5nLiBUaGUgZnVuY3Rpb24gaGFzIHRoZXNlIHBhcmFtZXRlcnM6CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAgICogYGNvbnRleHRgOiBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MgYXJlIGV2YWx1YXRlZAogICAgICAgICAgICAgKiAgICAgIGFnYWluc3QuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiAkaW50ZXJwb2xhdGUodGV4dCwgbXVzdEhhdmVFeHByZXNzaW9uLCB0cnVzdGVkQ29udGV4dCkgewogICAgICAgICAgICAgICAgdmFyIHN0YXJ0SW5kZXgsCiAgICAgICAgICAgICAgICAgICAgZW5kSW5kZXgsCiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSAwLAogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gW10sCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gdGV4dC5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGZuLAogICAgICAgICAgICAgICAgICAgIGV4cCwKICAgICAgICAgICAgICAgICAgICBjb25jYXQgPSBbXTsKCiAgICAgICAgICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKChzdGFydEluZGV4ID0gdGV4dC5pbmRleE9mKHN0YXJ0U3ltYm9sLCBpbmRleCkpICE9IC0xKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgKChlbmRJbmRleCA9IHRleHQuaW5kZXhPZihlbmRTeW1ib2wsIHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCkpICE9IC0xKSkgewogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gc3RhcnRJbmRleCkgJiYgcGFydHMucHVzaCh0ZXh0LnN1YnN0cmluZyhpbmRleCwgc3RhcnRJbmRleCkpOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGZuID0gJHBhcnNlKGV4cCA9IHRleHQuc3Vic3RyaW5nKHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCwgZW5kSW5kZXgpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuLmV4cCA9IGV4cDsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBlbmRJbmRleCArIGVuZFN5bWJvbExlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgZGlkIG5vdCBmaW5kIGFueXRoaW5nLCBzbyB3ZSBoYXZlIHRvIGFkZCB0aGUgcmVtYWluZGVyIHRvIHRoZSBwYXJ0cyBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggIT0gbGVuZ3RoKSAmJiBwYXJ0cy5wdXNoKHRleHQuc3Vic3RyaW5nKGluZGV4KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIShsZW5ndGggPSBwYXJ0cy5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgYWRkZWQsIG5vdGhpbmcsIG11c3QgaGF2ZSBiZWVuIGFuIGVtcHR5IHN0cmluZy4KICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKCcnKTsKICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSAxOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvbmNhdGVuYXRpbmcgZXhwcmVzc2lvbnMgbWFrZXMgaXQgaGFyZCB0byByZWFzb24gYWJvdXQgd2hldGhlciBzb21lIGNvbWJpbmF0aW9uIG9mIGNvbmNhdGVuYXRlZAogICAgICAgICAgICAgICAgLy8gdmFsdWVzIGFyZSB1bnNhZmUgdG8gdXNlIGFuZCBjb3VsZCBlYXNpbHkgbGVhZCB0byBYU1MuICBCeSByZXF1aXJpbmcgdGhhdCBhIHNpbmdsZQogICAgICAgICAgICAgICAgLy8gZXhwcmVzc2lvbiBiZSB1c2VkIGZvciBpZnJhbWVbc3JjXSwgb2JqZWN0W3NyY10sIGV0Yy4sIHdlIGVuc3VyZSB0aGF0IHRoZSB2YWx1ZSB0aGF0J3MgdXNlZAogICAgICAgICAgICAgICAgLy8gaXMgYXNzaWduZWQgb3IgY29uc3RydWN0ZWQgYnkgc29tZSBKUyBjb2RlIHNvbWV3aGVyZSB0aGF0IGlzIG1vcmUgdGVzdGFibGUgb3IgbWFrZSBpdAogICAgICAgICAgICAgICAgLy8gb2J2aW91cyB0aGF0IHlvdSBib3VuZCB0aGUgdmFsdWUgdG8gc29tZSB1c2VyIGNvbnRyb2xsZWQgdmFsdWUuICBUaGlzIGhlbHBzIHJlZHVjZSB0aGUgbG9hZAogICAgICAgICAgICAgICAgLy8gd2hlbiBhdWRpdGluZyBmb3IgWFNTIGlzc3Vlcy4KICAgICAgICAgICAgICAgIGlmICh0cnVzdGVkQ29udGV4dCAmJiBwYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGludGVycG9sYXRlTWluRXJyKCdub2NvbmNhdCcsCiAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciB3aGlsZSBpbnRlcnBvbGF0aW5nOiB7MH1cblN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIGRpc2FsbG93cyAiICsKICAgICAgICAgICAgICAgICAgICAgICAgImludGVycG9sYXRpb25zIHRoYXQgY29uY2F0ZW5hdGUgbXVsdGlwbGUgZXhwcmVzc2lvbnMgd2hlbiBhIHRydXN0ZWQgdmFsdWUgaXMgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZC4gIFNlZSBodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy4kc2NlIiwgdGV4dCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFtdXN0SGF2ZUV4cHJlc3Npb24gfHwgaGFzSW50ZXJwb2xhdGlvbikgewogICAgICAgICAgICAgICAgICAgIGNvbmNhdC5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm4gPSBmdW5jdGlvbiAoY29udGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gbGVuZ3RoLCBwYXJ0OyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgKHBhcnQgPSBwYXJ0c1tpXSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gcGFydChjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRydXN0ZWRDb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gJHNjZS5nZXRUcnVzdGVkKHRydXN0ZWRDb250ZXh0LCBwYXJ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSAkc2NlLnZhbHVlT2YocGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnQgPT0gbnVsbCB8fCBwYXJ0ID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwYXJ0ICE9ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gdG9Kc29uKHBhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmNhdFtpXSA9IHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29uY2F0LmpvaW4oJycpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdFcnIgPSAkaW50ZXJwb2xhdGVNaW5FcnIoJ2ludGVycicsICJDYW4ndCBpbnRlcnBvbGF0ZTogezB9XG57MX0iLCB0ZXh0LCBlcnIudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihuZXdFcnIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBmbi5leHAgPSB0ZXh0OwogICAgICAgICAgICAgICAgICAgIGZuLnBhcnRzID0gcGFydHM7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJGludGVycG9sYXRlI3N0YXJ0U3ltYm9sCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaW50ZXJwb2xhdGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFVzZSB7QGxpbmsgbmcuJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2wgJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2x9IHRvIGNoYW5nZQogICAgICAgICAgICAgKiB0aGUgc3ltYm9sLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBzdGFydCBzeW1ib2wuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2wgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RhcnRTeW1ib2w7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kaW50ZXJwb2xhdGUjZW5kU3ltYm9sCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kaW50ZXJwb2xhdGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIGVuZCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBgfX1gLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI2VuZFN5bWJvbCAkaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2x9IHRvIGNoYW5nZQogICAgICAgICAgICAgKiB0aGUgc3ltYm9sLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBzdGFydCBzeW1ib2wuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICAkaW50ZXJwb2xhdGUuZW5kU3ltYm9sID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVuZFN5bWJvbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuICRpbnRlcnBvbGF0ZTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2NhbGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqICRsb2NhbGUgc2VydmljZSBwcm92aWRlcyBsb2NhbGl6YXRpb24gcnVsZXMgZm9yIHZhcmlvdXMgQW5ndWxhciBjb21wb25lbnRzLiBBcyBvZiByaWdodCBub3cgdGhlCiAgICAgKiBvbmx5IHB1YmxpYyBhcGkgaXM6CiAgICAgKgogICAgICogKiBgaWRgIOKAkyBge3N0cmluZ31gIOKAkyBsb2NhbGUgaWQgZm9ybWF0dGVkIGFzIGBsYW5ndWFnZUlkLWNvdW50cnlJZGAgKGUuZy4gYGVuLXVzYCkKICAgICAqLwogICAgZnVuY3Rpb24gJExvY2FsZVByb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGlkOiAnZW4tdXMnLAoKICAgICAgICAgICAgICAgIE5VTUJFUl9GT1JNQVRTOiB7CiAgICAgICAgICAgICAgICAgICAgREVDSU1BTF9TRVA6ICcuJywKICAgICAgICAgICAgICAgICAgICBHUk9VUF9TRVA6ICcsJywKICAgICAgICAgICAgICAgICAgICBQQVRURVJOUzogWwogICAgICAgICAgICAgICAgICAgICAgeyAvLyBEZWNpbWFsIFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5JbnQ6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbWluRnJhYzogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhGcmFjOiAzLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBvc1ByZTogJycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdQcmU6ICctJywKICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdTdWY6ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgIGdTaXplOiAzLAogICAgICAgICAgICAgICAgICAgICAgICAgIGxnU2l6ZTogMwogICAgICAgICAgICAgICAgICAgICAgfSwgeyAvL0N1cnJlbmN5IFBhdHRlcm4KICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5JbnQ6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbWluRnJhYzogMiwKICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhGcmFjOiAyLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBvc1ByZTogJ1x1MDBBNCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdQcmU6ICcoXHUwMEE0JywKICAgICAgICAgICAgICAgICAgICAgICAgICBuZWdTdWY6ICcpJywKICAgICAgICAgICAgICAgICAgICAgICAgICBnU2l6ZTogMywKICAgICAgICAgICAgICAgICAgICAgICAgICBsZ1NpemU6IDMKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgIENVUlJFTkNZX1NZTTogJyQnCiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIERBVEVUSU1FX0ZPUk1BVFM6IHsKICAgICAgICAgICAgICAgICAgICBNT05USDogJ0phbnVhcnksRmVicnVhcnksTWFyY2gsQXByaWwsTWF5LEp1bmUsSnVseSxBdWd1c3QsU2VwdGVtYmVyLE9jdG9iZXIsTm92ZW1iZXIsRGVjZW1iZXInCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc3BsaXQoJywnKSwKICAgICAgICAgICAgICAgICAgICBTSE9SVE1PTlRIOiAnSmFuLEZlYixNYXIsQXByLE1heSxKdW4sSnVsLEF1ZyxTZXAsT2N0LE5vdixEZWMnLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgREFZOiAnU3VuZGF5LE1vbmRheSxUdWVzZGF5LFdlZG5lc2RheSxUaHVyc2RheSxGcmlkYXksU2F0dXJkYXknLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgU0hPUlREQVk6ICdTdW4sTW9uLFR1ZSxXZWQsVGh1LEZyaSxTYXQnLnNwbGl0KCcsJyksCiAgICAgICAgICAgICAgICAgICAgQU1QTVM6IFsnQU0nLCAnUE0nXSwKICAgICAgICAgICAgICAgICAgICBtZWRpdW06ICdNTU0gZCwgeSBoOm1tOnNzIGEnLAogICAgICAgICAgICAgICAgICAgIHNob3J0OiAnTS9kL3l5IGg6bW0gYScsCiAgICAgICAgICAgICAgICAgICAgZnVsbERhdGU6ICdFRUVFLCBNTU1NIGQsIHknLAogICAgICAgICAgICAgICAgICAgIGxvbmdEYXRlOiAnTU1NTSBkLCB5JywKICAgICAgICAgICAgICAgICAgICBtZWRpdW1EYXRlOiAnTU1NIGQsIHknLAogICAgICAgICAgICAgICAgICAgIHNob3J0RGF0ZTogJ00vZC95eScsCiAgICAgICAgICAgICAgICAgICAgbWVkaXVtVGltZTogJ2g6bW06c3MgYScsCiAgICAgICAgICAgICAgICAgICAgc2hvcnRUaW1lOiAnaDptbSBhJwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBwbHVyYWxDYXQ6IGZ1bmN0aW9uIChudW0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAobnVtID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnb25lJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0KCiAgICB2YXIgU0VSVkVSX01BVENIID0gL14oW146XSspOlwvXC8oXHcrOnswLDF9XHcqQCk/KFx7P1tcd1wuLV0qXH0/KSg6KFswLTldKykpPyhcL1teXD8jXSopPyhcPyhbXiNdKikpPygjKC4qKSk/JC8sCiAgICAgICAgUEFUSF9NQVRDSCA9IC9eKFteXD8jXSopKFw/KFteI10qKSk/KCMoLiopKT8kLywKICAgICAgICBERUZBVUxUX1BPUlRTID0geyAnaHR0cCc6IDgwLCAnaHR0cHMnOiA0NDMsICdmdHAnOiAyMSB9OwogICAgdmFyICRsb2NhdGlvbk1pbkVyciA9IG1pbkVycignJGxvY2F0aW9uJyk7CgoKICAgIC8qKgogICAgICogRW5jb2RlIHBhdGggdXNpbmcgZW5jb2RlVXJpU2VnbWVudCwgaWdub3JpbmcgZm9yd2FyZCBzbGFzaGVzCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggUGF0aCB0byBlbmNvZGUKICAgICAqIEByZXR1cm5zIHtzdHJpbmd9CiAgICAgKi8KICAgIGZ1bmN0aW9uIGVuY29kZVBhdGgocGF0aCkgewogICAgICAgIHZhciBzZWdtZW50cyA9IHBhdGguc3BsaXQoJy8nKSwKICAgICAgICAgICAgaSA9IHNlZ21lbnRzLmxlbmd0aDsKCiAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICBzZWdtZW50c1tpXSA9IGVuY29kZVVyaVNlZ21lbnQoc2VnbWVudHNbaV0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNlZ21lbnRzLmpvaW4oJy8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYXRjaFVybCh1cmwsIG9iaikgewogICAgICAgIHZhciBtYXRjaCA9IFNFUlZFUl9NQVRDSC5leGVjKHVybCk7CgogICAgICAgIG9iai4kJHByb3RvY29sID0gbWF0Y2hbMV07CiAgICAgICAgb2JqLiQkaG9zdCA9IG1hdGNoWzNdOwogICAgICAgIG9iai4kJHBvcnQgPSBpbnQobWF0Y2hbNV0pIHx8IERFRkFVTFRfUE9SVFNbbWF0Y2hbMV1dIHx8IG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gbWF0Y2hBcHBVcmwodXJsLCBvYmopIHsKICAgICAgICB2YXIgbWF0Y2ggPSBQQVRIX01BVENILmV4ZWModXJsKTsKCiAgICAgICAgb2JqLiQkcGF0aCA9IGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsxXSk7CiAgICAgICAgb2JqLiQkc2VhcmNoID0gcGFyc2VLZXlWYWx1ZShtYXRjaFszXSk7CiAgICAgICAgb2JqLiQkaGFzaCA9IGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFs1XSB8fCAnJyk7CgogICAgICAgIC8vIG1ha2Ugc3VyZSBwYXRoIHN0YXJ0cyB3aXRoICcvJzsKICAgICAgICBpZiAob2JqLiQkcGF0aCAmJiBvYmouJCRwYXRoLmNoYXJBdCgwKSAhPSAnLycpIG9iai4kJHBhdGggPSAnLycgKyBvYmouJCRwYXRoOwogICAgfQoKCiAgICBmdW5jdGlvbiBjb21wb3NlUHJvdG9jb2xIb3N0UG9ydChwcm90b2NvbCwgaG9zdCwgcG9ydCkgewogICAgICAgIHJldHVybiBwcm90b2NvbCArICc6Ly8nICsgaG9zdCArIChwb3J0ID09IERFRkFVTFRfUE9SVFNbcHJvdG9jb2xdID8gJycgOiAnOicgKyBwb3J0KTsKICAgIH0KCiAgICAvKioKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYmVnaW4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB3aG9sZQogICAgICogQHBhcmFtIHtzdHJpbmd9IG90aGVyd2lzZQogICAgICogQHJldHVybnMge3N0cmluZ30gcmV0dXJucyB0ZXh0IGZyb20gd2hvbGUgYWZ0ZXIgYmVnaW4gb3Igb3RoZXJ3aXNlIGlmIGl0IGRvZXMgbm90IGJlZ2luIHdpdGggZXhwZWN0ZWQgc3RyaW5nLgogICAgICovCiAgICBmdW5jdGlvbiBiZWdpbnNXaXRoKGJlZ2luLCB3aG9sZSwgb3RoZXJ3aXNlKSB7CiAgICAgICAgcmV0dXJuIHdob2xlLmluZGV4T2YoYmVnaW4pID09IDAgPyB3aG9sZS5zdWJzdHIoYmVnaW4ubGVuZ3RoKSA6IG90aGVyd2lzZTsKICAgIH0KCgogICAgZnVuY3Rpb24gc3RyaXBIYXNoKHVybCkgewogICAgICAgIHZhciBpbmRleCA9IHVybC5pbmRleE9mKCcjJyk7CiAgICAgICAgcmV0dXJuIGluZGV4ID09IC0xID8gdXJsIDogdXJsLnN1YnN0cigwLCBpbmRleCk7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHN0cmlwRmlsZSh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnN1YnN0cigwLCBzdHJpcEhhc2godXJsKS5sYXN0SW5kZXhPZignLycpICsgMSk7CiAgICB9CgogICAgLyogcmV0dXJuIHRoZSBzZXJ2ZXIgb25seSAoc2NoZW1lOi8vaG9zdDpwb3J0KSAqLwogICAgZnVuY3Rpb24gc2VydmVyQmFzZSh1cmwpIHsKICAgICAgICByZXR1cm4gdXJsLnN1YnN0cmluZygwLCB1cmwuaW5kZXhPZignLycsIHVybC5pbmRleE9mKCcvLycpICsgMikpOwogICAgfQoKCiAgICAvKioKICAgICAqIExvY2F0aW9uSHRtbDVVcmwgcmVwcmVzZW50cyBhbiB1cmwKICAgICAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBIVE1MNSBtb2RlIGlzIGVuYWJsZWQgYW5kIHN1cHBvcnRlZAogICAgICoKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEJhc2UgYXBwbGljYXRpb24gYmFzZSBVUkwKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUHJlZml4IHVybCBwYXRoIHByZWZpeAogICAgICovCiAgICBmdW5jdGlvbiBMb2NhdGlvbkh0bWw1VXJsKGFwcEJhc2UsIGJhc2VQcmVmaXgpIHsKICAgICAgICB0aGlzLiQkaHRtbDUgPSB0cnVlOwogICAgICAgIGJhc2VQcmVmaXggPSBiYXNlUHJlZml4IHx8ICcnOwogICAgICAgIHZhciBhcHBCYXNlTm9GaWxlID0gc3RyaXBGaWxlKGFwcEJhc2UpOwogICAgICAgIC8qKgogICAgICAgICAqIFBhcnNlIGdpdmVuIGh0bWw1IChyZWd1bGFyKSB1cmwgc3RyaW5nIGludG8gcHJvcGVydGllcwogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZXdBYnNvbHV0ZVVybCBIVE1MNSB1cmwKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRoaXMuJCRwYXJzZSA9IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgdmFyIHBhcnNlZCA9IHt9CiAgICAgICAgICAgIG1hdGNoVXJsKHVybCwgcGFyc2VkKTsKICAgICAgICAgICAgdmFyIHBhdGhVcmwgPSBiZWdpbnNXaXRoKGFwcEJhc2VOb0ZpbGUsIHVybCk7CiAgICAgICAgICAgIGlmICghaXNTdHJpbmcocGF0aFVybCkpIHsKICAgICAgICAgICAgICAgIHRocm93ICRsb2NhdGlvbk1pbkVycignaXB0aHByZngnLCAnSW52YWxpZCB1cmwgInswfSIsIG1pc3NpbmcgcGF0aCBwcmVmaXggInsxfSIuJywgdXJsLCBhcHBCYXNlTm9GaWxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXRjaEFwcFVybChwYXRoVXJsLCBwYXJzZWQpOwogICAgICAgICAgICBleHRlbmQodGhpcywgcGFyc2VkKTsKICAgICAgICAgICAgaWYgKCF0aGlzLiQkcGF0aCkgewogICAgICAgICAgICAgICAgdGhpcy4kJHBhdGggPSAnLyc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRjb21wb3NlKCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcG9zZSB1cmwgYW5kIHVwZGF0ZSBgYWJzVXJsYCBwcm9wZXJ0eQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGhpcy4kJGNvbXBvc2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgICAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICAgICAgICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgICAgICAgICB0aGlzLiQkYWJzVXJsID0gYXBwQmFzZU5vRmlsZSArIHRoaXMuJCR1cmwuc3Vic3RyKDEpOyAvLyBmaXJzdCBjaGFyIGlzIGFsd2F5cyAnLycKICAgICAgICB9OwoKICAgICAgICB0aGlzLiQkcmV3cml0ZSA9IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgdmFyIGFwcFVybCwgcHJldkFwcFVybDsKCiAgICAgICAgICAgIGlmICgoYXBwVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlLCB1cmwpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBwcmV2QXBwVXJsID0gYXBwVXJsOwogICAgICAgICAgICAgICAgaWYgKChhcHBVcmwgPSBiZWdpbnNXaXRoKGJhc2VQcmVmaXgsIGFwcFVybCkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXBwQmFzZU5vRmlsZSArIChiZWdpbnNXaXRoKCcvJywgYXBwVXJsKSB8fCBhcHBVcmwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXBwQmFzZSArIHByZXZBcHBVcmw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFwcFVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFwcEJhc2VOb0ZpbGUgKyBhcHBVcmw7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXBwQmFzZU5vRmlsZSA9PSB1cmwgKyAnLycpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcHBCYXNlTm9GaWxlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIExvY2F0aW9uSGFzaGJhbmdVcmwgcmVwcmVzZW50cyB1cmwKICAgICAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBkZXZlbG9wZXIgZG9lc24ndCBvcHQgaW50byBodG1sNSBtb2RlLgogICAgICogSXQgYWxzbyBzZXJ2ZXMgYXMgdGhlIGJhc2UgY2xhc3MgZm9yIGh0bWw1IG1vZGUgZmFsbGJhY2sgb24gbGVnYWN5IGJyb3dzZXJzLgogICAgICoKICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEJhc2UgYXBwbGljYXRpb24gYmFzZSBVUkwKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoUHJlZml4IGhhc2hiYW5nIHByZWZpeAogICAgICovCiAgICBmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nVXJsKGFwcEJhc2UsIGhhc2hQcmVmaXgpIHsKICAgICAgICB2YXIgYXBwQmFzZU5vRmlsZSA9IHN0cmlwRmlsZShhcHBCYXNlKTsKCiAgICAgICAgbWF0Y2hVcmwoYXBwQmFzZSwgdGhpcyk7CgoKICAgICAgICAvKioKICAgICAgICAgKiBQYXJzZSBnaXZlbiBoYXNoYmFuZyB1cmwgaW50byBwcm9wZXJ0aWVzCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBIYXNoYmFuZyB1cmwKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRoaXMuJCRwYXJzZSA9IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgdmFyIHdpdGhvdXRCYXNlVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlLCB1cmwpIHx8IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKTsKICAgICAgICAgICAgdmFyIHdpdGhvdXRIYXNoVXJsID0gd2l0aG91dEJhc2VVcmwuY2hhckF0KDApID09ICcjJwogICAgICAgICAgICAgICAgPyBiZWdpbnNXaXRoKGhhc2hQcmVmaXgsIHdpdGhvdXRCYXNlVXJsKQogICAgICAgICAgICAgICAgOiAodGhpcy4kJGh0bWw1KQogICAgICAgICAgICAgICAgICA/IHdpdGhvdXRCYXNlVXJsCiAgICAgICAgICAgICAgICAgIDogJyc7CgogICAgICAgICAgICBpZiAoIWlzU3RyaW5nKHdpdGhvdXRIYXNoVXJsKSkgewogICAgICAgICAgICAgICAgdGhyb3cgJGxvY2F0aW9uTWluRXJyKCdpaHNocHJmeCcsICdJbnZhbGlkIHVybCAiezB9IiwgbWlzc2luZyBoYXNoIHByZWZpeCAiezF9Ii4nLCB1cmwsIGhhc2hQcmVmaXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hdGNoQXBwVXJsKHdpdGhvdXRIYXNoVXJsLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy4kJGNvbXBvc2UoKTsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBDb21wb3NlIGhhc2hiYW5nIHVybCBhbmQgdXBkYXRlIGBhYnNVcmxgIHByb3BlcnR5CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0aGlzLiQkY29tcG9zZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHNlYXJjaCA9IHRvS2V5VmFsdWUodGhpcy4kJHNlYXJjaCksCiAgICAgICAgICAgICAgICBoYXNoID0gdGhpcy4kJGhhc2ggPyAnIycgKyBlbmNvZGVVcmlTZWdtZW50KHRoaXMuJCRoYXNoKSA6ICcnOwoKICAgICAgICAgICAgdGhpcy4kJHVybCA9IGVuY29kZVBhdGgodGhpcy4kJHBhdGgpICsgKHNlYXJjaCA/ICc/JyArIHNlYXJjaCA6ICcnKSArIGhhc2g7CiAgICAgICAgICAgIHRoaXMuJCRhYnNVcmwgPSBhcHBCYXNlICsgKHRoaXMuJCR1cmwgPyBoYXNoUHJlZml4ICsgdGhpcy4kJHVybCA6ICcnKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiQkcmV3cml0ZSA9IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgaWYgKHN0cmlwSGFzaChhcHBCYXNlKSA9PSBzdHJpcEhhc2godXJsKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVybDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCgogICAgLyoqCiAgICAgKiBMb2NhdGlvbkhhc2hiYW5nVXJsIHJlcHJlc2VudHMgdXJsCiAgICAgKiBUaGlzIG9iamVjdCBpcyBleHBvc2VkIGFzICRsb2NhdGlvbiBzZXJ2aWNlIHdoZW4gaHRtbDUgaGlzdG9yeSBhcGkgaXMgZW5hYmxlZCBidXQgdGhlIGJyb3dzZXIKICAgICAqIGRvZXMgbm90IHN1cHBvcnQgaXQuCiAgICAgKgogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYXBwQmFzZSBhcHBsaWNhdGlvbiBiYXNlIFVSTAogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhc2hQcmVmaXggaGFzaGJhbmcgcHJlZml4CiAgICAgKi8KICAgIGZ1bmN0aW9uIExvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsKGFwcEJhc2UsIGhhc2hQcmVmaXgpIHsKICAgICAgICB0aGlzLiQkaHRtbDUgPSB0cnVlOwogICAgICAgIExvY2F0aW9uSGFzaGJhbmdVcmwuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgdmFyIGFwcEJhc2VOb0ZpbGUgPSBzdHJpcEZpbGUoYXBwQmFzZSk7CgogICAgICAgIHRoaXMuJCRyZXdyaXRlID0gZnVuY3Rpb24gKHVybCkgewogICAgICAgICAgICB2YXIgYXBwVXJsOwoKICAgICAgICAgICAgaWYgKGFwcEJhc2UgPT0gc3RyaXBIYXNoKHVybCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFwcFVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcHBCYXNlICsgaGFzaFByZWZpeCArIGFwcFVybDsKICAgICAgICAgICAgfSBlbHNlIGlmIChhcHBCYXNlTm9GaWxlID09PSB1cmwgKyAnLycpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhcHBCYXNlTm9GaWxlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKCiAgICBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybC5wcm90b3R5cGUgPQogICAgICBMb2NhdGlvbkhhc2hiYW5nVXJsLnByb3RvdHlwZSA9CiAgICAgIExvY2F0aW9uSHRtbDVVcmwucHJvdG90eXBlID0gewoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQXJlIHdlIGluIGh0bWw1IG1vZGU/CiAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICovCiAgICAgICAgICAkJGh0bWw1OiBmYWxzZSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEhhcyBhbnkgY2hhbmdlIGJlZW4gcmVwbGFjaW5nID8KICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgKi8KICAgICAgICAgICQkcmVwbGFjZTogZmFsc2UsCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jYWJzVXJsCiAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBSZXR1cm4gZnVsbCB1cmwgcmVwcmVzZW50YXRpb24gd2l0aCBhbGwgc2VnbWVudHMgZW5jb2RlZCBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAgICAgICAgICAgKiB7QGxpbmsgaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMzk4Ni50eHQgUkZDIDM5ODZ9LgogICAgICAgICAgICoKICAgICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gZnVsbCB1cmwKICAgICAgICAgICAqLwogICAgICAgICAgYWJzVXJsOiBsb2NhdGlvbkdldHRlcignJCRhYnNVcmwnKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiN1cmwKICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9jYXRpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBSZXR1cm4gdXJsIChlLmcuIGAvcGF0aD9hPWIjaGFzaGApIHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBDaGFuZ2UgcGF0aCwgc2VhcmNoIGFuZCBoYXNoLCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdXJsIE5ldyB1cmwgd2l0aG91dCBiYXNlIHByZWZpeCAoZS5nLiBgL3BhdGg/YT1iI2hhc2hgKQogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXBsYWNlIFRoZSBwYXRoIHRoYXQgd2lsbCBiZSBjaGFuZ2VkCiAgICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHVybAogICAgICAgICAgICovCiAgICAgICAgICB1cmw6IGZ1bmN0aW9uICh1cmwsIHJlcGxhY2UpIHsKICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodXJsKSkKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJCR1cmw7CgogICAgICAgICAgICAgIHZhciBtYXRjaCA9IFBBVEhfTUFUQ0guZXhlYyh1cmwpOwogICAgICAgICAgICAgIGlmIChtYXRjaFsxXSkgdGhpcy5wYXRoKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsxXSkpOwogICAgICAgICAgICAgIGlmIChtYXRjaFsyXSB8fCBtYXRjaFsxXSkgdGhpcy5zZWFyY2gobWF0Y2hbM10gfHwgJycpOwogICAgICAgICAgICAgIHRoaXMuaGFzaChtYXRjaFs1XSB8fCAnJywgcmVwbGFjZSk7CgogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwcm90b2NvbAogICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICAgKgogICAgICAgICAgICogUmV0dXJuIHByb3RvY29sIG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAgICoKICAgICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gcHJvdG9jb2wgb2YgY3VycmVudCB1cmwKICAgICAgICAgICAqLwogICAgICAgICAgcHJvdG9jb2w6IGxvY2F0aW9uR2V0dGVyKCckJHByb3RvY29sJyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jaG9zdAogICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICAgKgogICAgICAgICAgICogUmV0dXJuIGhvc3Qgb2YgY3VycmVudCB1cmwuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBob3N0IG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAgICovCiAgICAgICAgICBob3N0OiBsb2NhdGlvbkdldHRlcignJCRob3N0JyksCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24jcG9ydAogICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICAgKgogICAgICAgICAgICogUmV0dXJuIHBvcnQgb2YgY3VycmVudCB1cmwuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybiB7TnVtYmVyfSBwb3J0CiAgICAgICAgICAgKi8KICAgICAgICAgIHBvcnQ6IGxvY2F0aW9uR2V0dGVyKCckJHBvcnQnKSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNwYXRoCiAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICAgICAgICAgKgogICAgICAgICAgICogUmV0dXJuIHBhdGggb2YgY3VycmVudCB1cmwgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAgICoKICAgICAgICAgICAqIENoYW5nZSBwYXRoIHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICAgKgogICAgICAgICAgICogTm90ZTogUGF0aCBzaG91bGQgYWx3YXlzIGJlZ2luIHdpdGggZm9yd2FyZCBzbGFzaCAoLyksIHRoaXMgbWV0aG9kIHdpbGwgYWRkIHRoZSBmb3J3YXJkIHNsYXNoCiAgICAgICAgICAgKiBpZiBpdCBpcyBtaXNzaW5nLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcGF0aCBOZXcgcGF0aAogICAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBwYXRoCiAgICAgICAgICAgKi8KICAgICAgICAgIHBhdGg6IGxvY2F0aW9uR2V0dGVyU2V0dGVyKCckJHBhdGgnLCBmdW5jdGlvbiAocGF0aCkgewogICAgICAgICAgICAgIHJldHVybiBwYXRoLmNoYXJBdCgwKSA9PSAnLycgPyBwYXRoIDogJy8nICsgcGF0aDsKICAgICAgICAgIH0pLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uI3NlYXJjaAogICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAgICoKICAgICAgICAgICAqIFJldHVybiBzZWFyY2ggcGFydCAoYXMgb2JqZWN0KSBvZiBjdXJyZW50IHVybCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICAgKgogICAgICAgICAgICogQ2hhbmdlIHNlYXJjaCBwYXJ0IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0LjxzdHJpbmc+fE9iamVjdC48QXJyYXkuPHN0cmluZz4+fSBzZWFyY2ggTmV3IHNlYXJjaCBwYXJhbXMgLSBzdHJpbmcgb3IgaGFzaCBvYmplY3QuIEhhc2ggb2JqZWN0CiAgICAgICAgICAgKiAgICBtYXkgY29udGFpbiBhbiBhcnJheSBvZiB2YWx1ZXMsIHdoaWNoIHdpbGwgYmUgZGVjb2RlZCBhcyBkdXBsaWNhdGVzIGluIHRoZSB1cmwuCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHBhcmFtVmFsdWUgSWYgYHNlYXJjaGAgaXMgYSBzdHJpbmcsIHRoZW4gYHBhcmFtVmFsdWVgIHdpbGwgb3ZlcnJpZGUgb25seSBhCiAgICAgICAgICAgKiAgICBzaW5nbGUgc2VhcmNoIHBhcmFtZXRlci4gSWYgdGhlIHZhbHVlIGlzIGBudWxsYCwgdGhlIHBhcmFtZXRlciB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBzZWFyY2gKICAgICAgICAgICAqLwogICAgICAgICAgc2VhcmNoOiBmdW5jdGlvbiAoc2VhcmNoLCBwYXJhbVZhbHVlKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiQkc2VhcmNoOwogICAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoc2VhcmNoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBwYXJzZUtleVZhbHVlKHNlYXJjaCk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHNlYXJjaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkc2VhcmNoID0gc2VhcmNoOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkbG9jYXRpb25NaW5FcnIoJ2lzcmNoYXJnJywgJ1RoZSBmaXJzdCBhcmd1bWVudCBvZiB0aGUgYCRsb2NhdGlvbiNzZWFyY2goKWAgY2FsbCBtdXN0IGJlIGEgc3RyaW5nIG9yIGFuIG9iamVjdC4nKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtVmFsdWUgPT0gdW5kZWZpbmVkIHx8IHBhcmFtVmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLiQkc2VhcmNoW3NlYXJjaF07CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRzZWFyY2hbc2VhcmNoXSA9IHBhcmFtVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNoYXNoCiAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICAgICAgICAgKgogICAgICAgICAgICogUmV0dXJuIGhhc2ggZnJhZ21lbnQgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAgICoKICAgICAgICAgICAqIENoYW5nZSBoYXNoIGZyYWdtZW50IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBoYXNoIE5ldyBoYXNoIGZyYWdtZW50CiAgICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IGhhc2gKICAgICAgICAgICAqLwogICAgICAgICAgaGFzaDogbG9jYXRpb25HZXR0ZXJTZXR0ZXIoJyQkaGFzaCcsIGlkZW50aXR5KSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2NhdGlvbiNyZXBsYWNlCiAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvY2F0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBJZiBjYWxsZWQsIGFsbCBjaGFuZ2VzIHRvICRsb2NhdGlvbiBkdXJpbmcgY3VycmVudCBgJGRpZ2VzdGAgd2lsbCBiZSByZXBsYWNpbmcgY3VycmVudCBoaXN0b3J5CiAgICAgICAgICAgKiByZWNvcmQsIGluc3RlYWQgb2YgYWRkaW5nIG5ldyBvbmUuCiAgICAgICAgICAgKi8KICAgICAgICAgIHJlcGxhY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB0aGlzLiQkcmVwbGFjZSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgIH07CgogICAgZnVuY3Rpb24gbG9jYXRpb25HZXR0ZXIocHJvcGVydHkpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpc1twcm9wZXJ0eV07CiAgICAgICAgfTsKICAgIH0KCgogICAgZnVuY3Rpb24gbG9jYXRpb25HZXR0ZXJTZXR0ZXIocHJvcGVydHksIHByZXByb2Nlc3MpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1twcm9wZXJ0eV07CgogICAgICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IHByZXByb2Nlc3ModmFsdWUpOwogICAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb24KICAgICAqCiAgICAgKiBAcmVxdWlyZXMgJGJyb3dzZXIKICAgICAqIEByZXF1aXJlcyAkc25pZmZlcgogICAgICogQHJlcXVpcmVzICRyb290RWxlbWVudAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlICRsb2NhdGlvbiBzZXJ2aWNlIHBhcnNlcyB0aGUgVVJMIGluIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyIChiYXNlZCBvbiB0aGUKICAgICAqIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi93aW5kb3cubG9jYXRpb24gd2luZG93LmxvY2F0aW9ufSkgYW5kIG1ha2VzIHRoZSBVUkwKICAgICAqIGF2YWlsYWJsZSB0byB5b3VyIGFwcGxpY2F0aW9uLiBDaGFuZ2VzIHRvIHRoZSBVUkwgaW4gdGhlIGFkZHJlc3MgYmFyIGFyZSByZWZsZWN0ZWQgaW50bwogICAgICogJGxvY2F0aW9uIHNlcnZpY2UgYW5kIGNoYW5nZXMgdG8gJGxvY2F0aW9uIGFyZSByZWZsZWN0ZWQgaW50byB0aGUgYnJvd3NlciBhZGRyZXNzIGJhci4KICAgICAqCiAgICAgKiAqKlRoZSAkbG9jYXRpb24gc2VydmljZToqKgogICAgICoKICAgICAqIC0gRXhwb3NlcyB0aGUgY3VycmVudCBVUkwgaW4gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIsIHNvIHlvdSBjYW4KICAgICAqICAgLSBXYXRjaCBhbmQgb2JzZXJ2ZSB0aGUgVVJMLgogICAgICogICAtIENoYW5nZSB0aGUgVVJMLgogICAgICogLSBTeW5jaHJvbml6ZXMgdGhlIFVSTCB3aXRoIHRoZSBicm93c2VyIHdoZW4gdGhlIHVzZXIKICAgICAqICAgLSBDaGFuZ2VzIHRoZSBhZGRyZXNzIGJhci4KICAgICAqICAgLSBDbGlja3MgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gKG9yIGNsaWNrcyBhIEhpc3RvcnkgbGluaykuCiAgICAgKiAgIC0gQ2xpY2tzIG9uIGEgbGluay4KICAgICAqIC0gUmVwcmVzZW50cyB0aGUgVVJMIG9iamVjdCBhcyBhIHNldCBvZiBtZXRob2RzIChwcm90b2NvbCwgaG9zdCwgcG9ydCwgcGF0aCwgc2VhcmNoLCBoYXNoKS4KICAgICAqCiAgICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBzZWUge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS5zZXJ2aWNlcy4kbG9jYXRpb24gRGV2ZWxvcGVyIEd1aWRlOiBBbmd1bGFyCiAgICAgKiBTZXJ2aWNlczogVXNpbmcgJGxvY2F0aW9ufQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb25Qcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2UgdGhlIGAkbG9jYXRpb25Qcm92aWRlcmAgdG8gY29uZmlndXJlIGhvdyB0aGUgYXBwbGljYXRpb24gZGVlcCBsaW5raW5nIHBhdGhzIGFyZSBzdG9yZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uICRMb2NhdGlvblByb3ZpZGVyKCkgewogICAgICAgIHZhciBoYXNoUHJlZml4ID0gJycsCiAgICAgICAgICAgIGh0bWw1TW9kZSA9IGZhbHNlOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgKiBAbmFtZSBuZy4kbG9jYXRpb25Qcm92aWRlciNoYXNoUHJlZml4CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvblByb3ZpZGVyCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBwcmVmaXggUHJlZml4IGZvciBoYXNoIHBhcnQgKGNvbnRhaW5pbmcgcGF0aCBhbmQgc2VhcmNoKQogICAgICAgICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5oYXNoUHJlZml4ID0gZnVuY3Rpb24gKHByZWZpeCkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHByZWZpeCkpIHsKICAgICAgICAgICAgICAgIGhhc2hQcmVmaXggPSBwcmVmaXg7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBoYXNoUHJlZml4OwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICogQG5hbWUgbmcuJGxvY2F0aW9uUHJvdmlkZXIjaHRtbDVNb2RlCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2NhdGlvblByb3ZpZGVyCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBtb2RlIFVzZSBIVE1MNSBzdHJhdGVneSBpZiBhdmFpbGFibGUuCiAgICAgICAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgICAgICAgKi8KICAgICAgICB0aGlzLmh0bWw1TW9kZSA9IGZ1bmN0aW9uIChtb2RlKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQobW9kZSkpIHsKICAgICAgICAgICAgICAgIGh0bWw1TW9kZSA9IG1vZGU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBodG1sNU1vZGU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHNuaWZmZXInLCAnJHJvb3RFbGVtZW50JywKICAgICAgICAgICAgZnVuY3Rpb24gKCRyb290U2NvcGUsICRicm93c2VyLCAkc25pZmZlciwgJHJvb3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgJGxvY2F0aW9uLAogICAgICAgICAgICAgICAgICAgIExvY2F0aW9uTW9kZSwKICAgICAgICAgICAgICAgICAgICBiYXNlSHJlZiA9ICRicm93c2VyLmJhc2VIcmVmKCksIC8vIGlmIGJhc2VbaHJlZl0gaXMgdW5kZWZpbmVkLCBpdCBkZWZhdWx0cyB0byAnJwogICAgICAgICAgICAgICAgICAgIGluaXRpYWxVcmwgPSAkYnJvd3Nlci51cmwoKSwKICAgICAgICAgICAgICAgICAgICBhcHBCYXNlOwoKICAgICAgICAgICAgICAgIGlmIChodG1sNU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBhcHBCYXNlID0gc2VydmVyQmFzZShpbml0aWFsVXJsKSArIChiYXNlSHJlZiB8fCAnLycpOwogICAgICAgICAgICAgICAgICAgIExvY2F0aW9uTW9kZSA9ICRzbmlmZmVyLmhpc3RvcnkgPyBMb2NhdGlvbkh0bWw1VXJsIDogTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFwcEJhc2UgPSBzdHJpcEhhc2goaW5pdGlhbFVybCk7CiAgICAgICAgICAgICAgICAgICAgTG9jYXRpb25Nb2RlID0gTG9jYXRpb25IYXNoYmFuZ1VybDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRsb2NhdGlvbiA9IG5ldyBMb2NhdGlvbk1vZGUoYXBwQmFzZSwgJyMnICsgaGFzaFByZWZpeCk7CiAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZSgkbG9jYXRpb24uJCRyZXdyaXRlKGluaXRpYWxVcmwpKTsKCiAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHJld3JpdGUgbGluayB3aGVuIG9wZW5pbmcgaW4gbmV3IHRhYi93aW5kb3cgKGluIGxlZ2FjeSBicm93c2VyKQogICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnRseSB3ZSBvcGVuIG5pY2UgdXJsIGxpbmsgYW5kIHJlZGlyZWN0IHRoZW4KCiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSB8fCBldmVudC53aGljaCA9PSAyKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIHZhciBlbG0gPSBqcUxpdGUoZXZlbnQudGFyZ2V0KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gdHJhdmVyc2UgdGhlIERPTSB1cCB0byBmaW5kIGZpcnN0IEEgdGFnCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxvd2VyY2FzZShlbG1bMF0ubm9kZU5hbWUpICE9PSAnYScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWdub3JlIHJld3JpdGluZyBpZiBubyBBIHRhZyAocmVhY2hlZCByb290IGVsZW1lbnQsIG9yIG5vIHBhcmVudCAtIHJlbW92ZWQgZnJvbSBkb2N1bWVudCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsbVswXSA9PT0gJHJvb3RFbGVtZW50WzBdIHx8ICEoZWxtID0gZWxtLnBhcmVudCgpKVswXSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIGFic0hyZWYgPSBlbG0ucHJvcCgnaHJlZicpOwogICAgICAgICAgICAgICAgICAgIHZhciByZXdyaXR0ZW5VcmwgPSAkbG9jYXRpb24uJCRyZXdyaXRlKGFic0hyZWYpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYWJzSHJlZiAmJiAhZWxtLmF0dHIoJ3RhcmdldCcpICYmIHJld3JpdHRlblVybCAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJld3JpdHRlblVybCAhPSAkYnJvd3Nlci51cmwoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXBkYXRlIGxvY2F0aW9uIG1hbnVhbGx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShyZXdyaXR0ZW5VcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhhY2sgdG8gd29yayBhcm91bmQgRkY2IGJ1ZyA2ODQyMDggd2hlbiBzY2VuYXJpbyBydW5uZXIgY2xpY2tzIG9uIGxpbmtzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYW5ndWxhclsnZmYtNjg0MjA4LXByZXZlbnREZWZhdWx0J10gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgoKICAgICAgICAgICAgICAgIC8vIHJld3JpdGUgaGFzaGJhbmcgdXJsIDw+IGh0bWw1IHVybAogICAgICAgICAgICAgICAgaWYgKCRsb2NhdGlvbi5hYnNVcmwoKSAhPSBpbml0aWFsVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gdXBkYXRlICRsb2NhdGlvbiB3aGVuICRicm93c2VyIHVybCBjaGFuZ2VzCiAgICAgICAgICAgICAgICAkYnJvd3Nlci5vblVybENoYW5nZShmdW5jdGlvbiAobmV3VXJsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRsb2NhdGlvbi5hYnNVcmwoKSAhPSBuZXdVcmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3RhcnQnLCBuZXdVcmwsICRsb2NhdGlvbi5hYnNVcmwoKSkuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvbGRVcmwgPSAkbG9jYXRpb24uYWJzVXJsKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2UobmV3VXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghJHJvb3RTY29wZS4kJHBoYXNlKSAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyB1cGRhdGUgYnJvd3NlcgogICAgICAgICAgICAgICAgdmFyIGNoYW5nZUNvdW50ZXIgPSAwOwogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kd2F0Y2goZnVuY3Rpb24gJGxvY2F0aW9uV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9sZFVybCA9ICRicm93c2VyLnVybCgpOwogICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50UmVwbGFjZSA9ICRsb2NhdGlvbi4kJHJlcGxhY2U7CgogICAgICAgICAgICAgICAgICAgIGlmICghY2hhbmdlQ291bnRlciB8fCBvbGRVcmwgIT0gJGxvY2F0aW9uLmFic1VybCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZUNvdW50ZXIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRsb2NhdGlvbkNoYW5nZVN0YXJ0JywgJGxvY2F0aW9uLmFic1VybCgpLCBvbGRVcmwpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShvbGRVcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnJvd3Nlci51cmwoJGxvY2F0aW9uLmFic1VybCgpLCBjdXJyZW50UmVwbGFjZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJMb2NhdGlvbkNoYW5nZShvbGRVcmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJGxvY2F0aW9uLiQkcmVwbGFjZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hhbmdlQ291bnRlcjsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHJldHVybiAkbG9jYXRpb247CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gYWZ0ZXJMb2NhdGlvbkNoYW5nZShvbGRVcmwpIHsKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3MnLCAkbG9jYXRpb24uYWJzVXJsKCksIG9sZFVybCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJGxvZwogICAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNpbXBsZSBzZXJ2aWNlIGZvciBsb2dnaW5nLiBEZWZhdWx0IGltcGxlbWVudGF0aW9uIHdyaXRlcyB0aGUgbWVzc2FnZQogICAgICogaW50byB0aGUgYnJvd3NlcidzIGNvbnNvbGUgKGlmIHByZXNlbnQpLgogICAgICoKICAgICAqIFRoZSBtYWluIHB1cnBvc2Ugb2YgdGhpcyBzZXJ2aWNlIGlzIHRvIHNpbXBsaWZ5IGRlYnVnZ2luZyBhbmQgdHJvdWJsZXNob290aW5nLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICA8ZXhhbXBsZT4KICAgICAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgICAgICBmdW5jdGlvbiBMb2dDdHJsKCRzY29wZSwgJGxvZykgewogICAgICAgICAgICAgJHNjb3BlLiRsb2cgPSAkbG9nOwogICAgICAgICAgICAgJHNjb3BlLm1lc3NhZ2UgPSAnSGVsbG8gV29ybGQhJzsKICAgICAgICAgICB9CiAgICAgICAgIDwvZmlsZT4KICAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJMb2dDdHJsIj4KICAgICAgICAgICAgIDxwPlJlbG9hZCB0aGlzIHBhZ2Ugd2l0aCBvcGVuIGNvbnNvbGUsIGVudGVyIHRleHQgYW5kIGhpdCB0aGUgbG9nIGJ1dHRvbi4uLjwvcD4KICAgICAgICAgICAgIE1lc3NhZ2U6CiAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im1lc3NhZ2UiLz4KICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cubG9nKG1lc3NhZ2UpIj5sb2c8L2J1dHRvbj4KICAgICAgICAgICAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cud2FybihtZXNzYWdlKSI+d2FybjwvYnV0dG9uPgogICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJGxvZy5pbmZvKG1lc3NhZ2UpIj5pbmZvPC9idXR0b24+CiAgICAgICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmVycm9yKG1lc3NhZ2UpIj5lcnJvcjwvYnV0dG9uPgogICAgICAgICAgIDwvZGl2PgogICAgICAgICA8L2ZpbGU+CiAgICAgICA8L2V4YW1wbGU+CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRsb2dQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2UgdGhlIGAkbG9nUHJvdmlkZXJgIHRvIGNvbmZpZ3VyZSBob3cgdGhlIGFwcGxpY2F0aW9uIGxvZ3MgbWVzc2FnZXMKICAgICAqLwogICAgZnVuY3Rpb24gJExvZ1Byb3ZpZGVyKCkgewogICAgICAgIHZhciBkZWJ1ZyA9IHRydWUsCiAgICAgICAgICAgIHNlbGYgPSB0aGlzOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgKiBAbmFtZSBuZy4kbG9nUHJvdmlkZXIjZGVidWdFbmFibGVkCiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRsb2dQcm92aWRlcgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gZmxhZyBlbmFibGUgb3IgZGlzYWJsZSBkZWJ1ZyBsZXZlbCBtZXNzYWdlcwogICAgICAgICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICAgICAgICovCiAgICAgICAgdGhpcy5kZWJ1Z0VuYWJsZWQgPSBmdW5jdGlvbiAoZmxhZykgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGZsYWcpKSB7CiAgICAgICAgICAgICAgICBkZWJ1ZyA9IGZsYWc7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWJ1ZzsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsIGZ1bmN0aW9uICgkd2luZG93KSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2cjbG9nCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvZwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogV3JpdGUgYSBsb2cgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBsb2c6IGNvbnNvbGVMb2coJ2xvZycpLAoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJGxvZyNpbmZvCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvZwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogV3JpdGUgYW4gaW5mb3JtYXRpb24gbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBpbmZvOiBjb25zb2xlTG9nKCdpbmZvJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI3dhcm4KICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBXcml0ZSBhIHdhcm5pbmcgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB3YXJuOiBjb25zb2xlTG9nKCd3YXJuJyksCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kbG9nI2Vycm9yCiAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJGxvZwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogV3JpdGUgYW4gZXJyb3IgbWVzc2FnZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBlcnJvcjogY29uc29sZUxvZygnZXJyb3InKSwKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRsb2cjZGVidWcKICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kbG9nCiAgICAgICAgICAgICAgICAgKiAKICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICogV3JpdGUgYSBkZWJ1ZyBtZXNzYWdlCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGRlYnVnOiAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBmbiA9IGNvbnNvbGVMb2coJ2RlYnVnJyk7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uYXBwbHkoc2VsZiwgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0oKSkKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGZvcm1hdEVycm9yKGFyZykgewogICAgICAgICAgICAgICAgaWYgKGFyZyBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZy5zdGFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBhcmcgPSAoYXJnLm1lc3NhZ2UgJiYgYXJnLnN0YWNrLmluZGV4T2YoYXJnLm1lc3NhZ2UpID09PSAtMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ0Vycm9yOiAnICsgYXJnLm1lc3NhZ2UgKyAnXG4nICsgYXJnLnN0YWNrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGFyZy5zdGFjazsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFyZy5zb3VyY2VVUkwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJnID0gYXJnLm1lc3NhZ2UgKyAnXG4nICsgYXJnLnNvdXJjZVVSTCArICc6JyArIGFyZy5saW5lOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbnNvbGVMb2codHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGNvbnNvbGUgPSAkd2luZG93LmNvbnNvbGUgfHwge30sCiAgICAgICAgICAgICAgICAgICAgbG9nRm4gPSBjb25zb2xlW3R5cGVdIHx8IGNvbnNvbGUubG9nIHx8IG5vb3A7CgogICAgICAgICAgICAgICAgaWYgKGxvZ0ZuLmFwcGx5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChhcmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChmb3JtYXRFcnJvcihhcmcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2dGbi5hcHBseShjb25zb2xlLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBJRSB3aGljaCBlaXRoZXIgZG9lc24ndCBoYXZlIHdpbmRvdy5jb25zb2xlID0+IHRoaXMgaXMgbm9vcCBhbmQgd2UgZG8gbm90aGluZywKICAgICAgICAgICAgICAgIC8vIG9yIHdlIGFyZSBJRSB3aGVyZSBjb25zb2xlLmxvZyBkb2Vzbid0IGhhdmUgYXBwbHkgc28gd2UgbG9nIGF0IGxlYXN0IGZpcnN0IDIgYXJncwogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhcmcxLCBhcmcyKSB7CiAgICAgICAgICAgICAgICAgICAgbG9nRm4oYXJnMSwgYXJnMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9XTsKICAgIH0KCiAgICB2YXIgJHBhcnNlTWluRXJyID0gbWluRXJyKCckcGFyc2UnKTsKCiAgICAvLyBTYW5kYm94aW5nIEFuZ3VsYXIgRXhwcmVzc2lvbnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gQW5ndWxhciBleHByZXNzaW9ucyBhcmUgZ2VuZXJhbGx5IGNvbnNpZGVyZWQgc2FmZSBiZWNhdXNlIHRoZXNlIGV4cHJlc3Npb25zIG9ubHkgaGF2ZSBkaXJlY3QgYWNjZXNzIHRvICRzY29wZSBhbmQKICAgIC8vIGxvY2Fscy4gSG93ZXZlciwgb25lIGNhbiBvYnRhaW4gdGhlIGFiaWxpdHkgdG8gZXhlY3V0ZSBhcmJpdHJhcnkgSlMgY29kZSBieSBvYnRhaW5pbmcgYSByZWZlcmVuY2UgdG8gbmF0aXZlIEpTCiAgICAvLyBmdW5jdGlvbnMgc3VjaCBhcyB0aGUgRnVuY3Rpb24gY29uc3RydWN0b3IuCiAgICAvLwogICAgLy8gQXMgYW4gZXhhbXBsZSwgY29uc2lkZXIgdGhlIGZvbGxvd2luZyBBbmd1bGFyIGV4cHJlc3Npb246CiAgICAvLwogICAgLy8gICB7fS50b1N0cmluZy5jb25zdHJ1Y3RvcihhbGVydCgiZXZpbCBKUyBjb2RlIikpCiAgICAvLwogICAgLy8gV2Ugd2FudCB0byBwcmV2ZW50IHRoaXMgdHlwZSBvZiBhY2Nlc3MuIEZvciB0aGUgc2FrZSBvZiBwZXJmb3JtYW5jZSwgZHVyaW5nIHRoZSBsZXhpbmcgcGhhc2Ugd2UgZGlzYWxsb3cgYW55ICJkb3R0ZWQiCiAgICAvLyBhY2Nlc3MgdG8gYW55IG1lbWJlciBuYW1lZCAiY29uc3RydWN0b3IiLgogICAgLy8KICAgIC8vIEZvciByZWZsZWN0aXZlIGNhbGxzIChhW2JdKSB3ZSBjaGVjayB0aGF0IHRoZSB2YWx1ZSBvZiB0aGUgbG9va3VwIGlzIG5vdCB0aGUgRnVuY3Rpb24gY29uc3RydWN0b3Igd2hpbGUgZXZhbHVhdGluZwogICAgLy8gdGhlIGV4cHJlc3Npb24sIHdoaWNoIGlzIGEgc3Ryb25nZXIgYnV0IG1vcmUgZXhwZW5zaXZlIHRlc3QuIFNpbmNlIHJlZmxlY3RpdmUgY2FsbHMgYXJlIGV4cGVuc2l2ZSBhbnl3YXksIHRoaXMgaXMgbm90CiAgICAvLyBzdWNoIGEgYmlnIGRlYWwgY29tcGFyZWQgdG8gc3RhdGljIGRlcmVmZXJlbmNpbmcuCiAgICAvLwogICAgLy8gVGhpcyBzYW5kYm94aW5nIHRlY2huaXF1ZSBpcyBub3QgcGVyZmVjdCBhbmQgZG9lc24ndCBhaW0gdG8gYmUuIFRoZSBnb2FsIGlzIHRvIHByZXZlbnQgZXhwbG9pdHMgYWdhaW5zdCB0aGUKICAgIC8vIGV4cHJlc3Npb24gbGFuZ3VhZ2UsIGJ1dCBub3QgdG8gcHJldmVudCBleHBsb2l0cyB0aGF0IHdlcmUgZW5hYmxlZCBieSBleHBvc2luZyBzZW5zaXRpdmUgSmF2YVNjcmlwdCBvciBicm93c2VyIGFwaXMKICAgIC8vIG9uIFNjb3BlLiBFeHBvc2luZyBzdWNoIG9iamVjdHMgb24gYSBTY29wZSBpcyBuZXZlciBhIGdvb2QgcHJhY3RpY2UgYW5kIHRoZXJlZm9yZSB3ZSBhcmUgbm90IGV2ZW4gdHJ5aW5nIHRvIHByb3RlY3QKICAgIC8vIGFnYWluc3QgaW50ZXJhY3Rpb24gd2l0aCBhbiBvYmplY3QgZXhwbGljaXRseSBleHBvc2VkIGluIHRoaXMgd2F5LgogICAgLy8KICAgIC8vIEEgZGV2ZWxvcGVyIGNvdWxkIGZvaWwgdGhlIG5hbWUgY2hlY2sgYnkgYWxpYXNpbmcgdGhlIEZ1bmN0aW9uIGNvbnN0cnVjdG9yIHVuZGVyIGEgZGlmZmVyZW50IG5hbWUgb24gdGhlIHNjb3BlLgogICAgLy8KICAgIC8vIEluIGdlbmVyYWwsIGl0IGlzIG5vdCBwb3NzaWJsZSB0byBhY2Nlc3MgYSBXaW5kb3cgb2JqZWN0IGZyb20gYW4gYW5ndWxhciBleHByZXNzaW9uIHVubGVzcyBhIHdpbmRvdyBvciBzb21lIERPTQogICAgLy8gb2JqZWN0IHRoYXQgaGFzIGEgcmVmZXJlbmNlIHRvIHdpbmRvdyBpcyBwdWJsaXNoZWQgb250byBhIFNjb3BlLgoKICAgIGZ1bmN0aW9uIGVuc3VyZVNhZmVNZW1iZXJOYW1lKG5hbWUsIGZ1bGxFeHByZXNzaW9uKSB7CiAgICAgICAgaWYgKG5hbWUgPT09ICJjb25zdHJ1Y3RvciIpIHsKICAgICAgICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2VjZmxkJywKICAgICAgICAgICAgICAgICdSZWZlcmVuY2luZyAiY29uc3RydWN0b3IiIGZpZWxkIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGlzYWxsb3dlZCEgRXhwcmVzc2lvbjogezB9JywgZnVsbEV4cHJlc3Npb24pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmFtZTsKICAgIH07CgogICAgZnVuY3Rpb24gZW5zdXJlU2FmZU9iamVjdChvYmosIGZ1bGxFeHByZXNzaW9uKSB7CiAgICAgICAgLy8gbmlmdHkgY2hlY2sgaWYgb2JqIGlzIEZ1bmN0aW9uIHRoYXQgaXMgZmFzdCBhbmQgd29ya3MgYWNyb3NzIGlmcmFtZXMgYW5kIG90aGVyIGNvbnRleHRzCiAgICAgICAgaWYgKG9iaiAmJiBvYmouY29uc3RydWN0b3IgPT09IG9iaikgewogICAgICAgICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2lzZWNmbicsCiAgICAgICAgICAgICAgICAnUmVmZXJlbmNpbmcgRnVuY3Rpb24gaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLCBmdWxsRXhwcmVzc2lvbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG9iajsKICAgICAgICB9CiAgICB9CgoKICAgIHZhciBPUEVSQVRPUlMgPSB7CiAgICAgICAgJ251bGwnOiBmdW5jdGlvbiAoKSB7IHJldHVybiBudWxsOyB9LAogICAgICAgICd0cnVlJzogZnVuY3Rpb24gKCkgeyByZXR1cm4gdHJ1ZTsgfSwKICAgICAgICAnZmFsc2UnOiBmdW5jdGlvbiAoKSB7IHJldHVybiBmYWxzZTsgfSwKICAgICAgICB1bmRlZmluZWQ6IG5vb3AsCiAgICAgICAgJysnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7CiAgICAgICAgICAgIGEgPSBhKHNlbGYsIGxvY2Fscyk7IGIgPSBiKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQoYSkpIHsKICAgICAgICAgICAgICAgIGlmIChpc0RlZmluZWQoYikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYSArIGI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaXNEZWZpbmVkKGIpID8gYiA6IHVuZGVmaW5lZDsKICAgICAgICB9LAogICAgICAgICctJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgeyBhID0gYShzZWxmLCBsb2NhbHMpOyBiID0gYihzZWxmLCBsb2NhbHMpOyByZXR1cm4gKGlzRGVmaW5lZChhKSA/IGEgOiAwKSAtIChpc0RlZmluZWQoYikgPyBiIDogMCk7IH0sCiAgICAgICAgJyonOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgKiBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJy8nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgLyBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJyUnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgJSBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJ14nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgXiBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJz0nOiBub29wLAogICAgICAgICc9PT0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgPT09IGIoc2VsZiwgbG9jYWxzKTsgfSwKICAgICAgICAnIT09JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgeyByZXR1cm4gYShzZWxmLCBsb2NhbHMpICE9PSBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJz09JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgeyByZXR1cm4gYShzZWxmLCBsb2NhbHMpID09IGIoc2VsZiwgbG9jYWxzKTsgfSwKICAgICAgICAnIT0nOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgIT0gYihzZWxmLCBsb2NhbHMpOyB9LAogICAgICAgICc8JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgeyByZXR1cm4gYShzZWxmLCBsb2NhbHMpIDwgYihzZWxmLCBsb2NhbHMpOyB9LAogICAgICAgICc+JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgeyByZXR1cm4gYShzZWxmLCBsb2NhbHMpID4gYihzZWxmLCBsb2NhbHMpOyB9LAogICAgICAgICc8PSc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSA8PSBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJz49JzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSwgYikgeyByZXR1cm4gYShzZWxmLCBsb2NhbHMpID49IGIoc2VsZiwgbG9jYWxzKTsgfSwKICAgICAgICAnJiYnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgJiYgYihzZWxmLCBsb2NhbHMpOyB9LAogICAgICAgICd8fCc6IGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMsIGEsIGIpIHsgcmV0dXJuIGEoc2VsZiwgbG9jYWxzKSB8fCBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgJyYnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBhKHNlbGYsIGxvY2FscykgJiBiKHNlbGYsIGxvY2Fscyk7IH0sCiAgICAgICAgLy8gICAgJ3wnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYXxiO30sCiAgICAgICAgJ3wnOiBmdW5jdGlvbiAoc2VsZiwgbG9jYWxzLCBhLCBiKSB7IHJldHVybiBiKHNlbGYsIGxvY2Fscykoc2VsZiwgbG9jYWxzLCBhKHNlbGYsIGxvY2FscykpOyB9LAogICAgICAgICchJzogZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgYSkgeyByZXR1cm4gIWEoc2VsZiwgbG9jYWxzKTsgfQogICAgfTsKICAgIHZhciBFU0NBUEUgPSB7ICJuIjogIlxuIiwgImYiOiAiXGYiLCAiciI6ICJcciIsICJ0IjogIlx0IiwgInYiOiAiXHYiLCAiJyI6ICInIiwgJyInOiAnIicgfTsKCiAgICBmdW5jdGlvbiBsZXgodGV4dCwgY3NwKSB7CiAgICAgICAgdmFyIHRva2VucyA9IFtdLAogICAgICAgICAgICB0b2tlbiwKICAgICAgICAgICAgaW5kZXggPSAwLAogICAgICAgICAgICBqc29uID0gW10sCiAgICAgICAgICAgIGNoLAogICAgICAgICAgICBsYXN0Q2ggPSAnOic7IC8vIGNhbiBzdGFydCByZWdleHAKCiAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgY2ggPSB0ZXh0LmNoYXJBdChpbmRleCk7CiAgICAgICAgICAgIGlmIChpcygnIlwnJykpIHsKICAgICAgICAgICAgICAgIHJlYWRTdHJpbmcoY2gpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzTnVtYmVyKGNoKSB8fCBpcygnLicpICYmIGlzTnVtYmVyKHBlZWsoKSkpIHsKICAgICAgICAgICAgICAgIHJlYWROdW1iZXIoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc0lkZW50KGNoKSkgewogICAgICAgICAgICAgICAgcmVhZElkZW50KCk7CiAgICAgICAgICAgICAgICAvLyBpZGVudGlmaWVycyBjYW4gb25seSBiZSBpZiB0aGUgcHJlY2VkaW5nIGNoYXIgd2FzIGEgeyBvciAsCiAgICAgICAgICAgICAgICBpZiAod2FzKCd7LCcpICYmIGpzb25bMF0gPT0gJ3snICYmCiAgICAgICAgICAgICAgICAgICAodG9rZW4gPSB0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdKSkgewogICAgICAgICAgICAgICAgICAgIHRva2VuLmpzb24gPSB0b2tlbi50ZXh0LmluZGV4T2YoJy4nKSA9PSAtMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChpcygnKCl7fVtdLiw7Oj8nKSkgewogICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGluZGV4OiBpbmRleCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBjaCwKICAgICAgICAgICAgICAgICAgICBqc29uOiAod2FzKCc6WywnKSAmJiBpcygne1snKSkgfHwgaXMoJ31dOiwnKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBpZiAoaXMoJ3tbJykpIGpzb24udW5zaGlmdChjaCk7CiAgICAgICAgICAgICAgICBpZiAoaXMoJ31dJykpIGpzb24uc2hpZnQoKTsKICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNXaGl0ZXNwYWNlKGNoKSkgewogICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGNoMiA9IGNoICsgcGVlaygpLAogICAgICAgICAgICAgICAgICAgIGNoMyA9IGNoMiArIHBlZWsoMiksCiAgICAgICAgICAgICAgICAgICAgZm4gPSBPUEVSQVRPUlNbY2hdLAogICAgICAgICAgICAgICAgICAgIGZuMiA9IE9QRVJBVE9SU1tjaDJdLAogICAgICAgICAgICAgICAgICAgIGZuMyA9IE9QRVJBVE9SU1tjaDNdOwogICAgICAgICAgICAgICAgaWYgKGZuMykgewogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsgaW5kZXg6IGluZGV4LCB0ZXh0OiBjaDMsIGZuOiBmbjMgfSk7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZm4yKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goeyBpbmRleDogaW5kZXgsIHRleHQ6IGNoMiwgZm46IGZuMiB9KTsKICAgICAgICAgICAgICAgICAgICBpbmRleCArPSAyOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmbikgewogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsgaW5kZXg6IGluZGV4LCB0ZXh0OiBjaCwgZm46IGZuLCBqc29uOiB3YXMoJ1ssOicpICYmIGlzKCcrLScpIH0pOwogICAgICAgICAgICAgICAgICAgIGluZGV4ICs9IDE7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIlVuZXhwZWN0ZWQgbmV4dCBjaGFyYWN0ZXIgIiwgaW5kZXgsIGluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdENoID0gY2g7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0b2tlbnM7CgogICAgICAgIGZ1bmN0aW9uIGlzKGNoYXJzKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFycy5pbmRleE9mKGNoKSAhPSAtMTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHdhcyhjaGFycykgewogICAgICAgICAgICByZXR1cm4gY2hhcnMuaW5kZXhPZihsYXN0Q2gpICE9IC0xOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGVlayhpKSB7CiAgICAgICAgICAgIHZhciBudW0gPSBpIHx8IDE7CiAgICAgICAgICAgIHJldHVybiBpbmRleCArIG51bSA8IHRleHQubGVuZ3RoID8gdGV4dC5jaGFyQXQoaW5kZXggKyBudW0pIDogZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzTnVtYmVyKGNoKSB7CiAgICAgICAgICAgIHJldHVybiAnMCcgPD0gY2ggJiYgY2ggPD0gJzknOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1doaXRlc3BhY2UoY2gpIHsKICAgICAgICAgICAgcmV0dXJuIGNoID09ICcgJyB8fCBjaCA9PSAnXHInIHx8IGNoID09ICdcdCcgfHwKICAgICAgICAgICAgICAgICAgIGNoID09ICdcbicgfHwgY2ggPT0gJ1x2JyB8fCBjaCA9PSAnXHUwMEEwJzsgLy8gSUUgdHJlYXRzIG5vbi1icmVha2luZyBzcGFjZSBhcyBcdTAwQTAKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNJZGVudChjaCkgewogICAgICAgICAgICByZXR1cm4gJ2EnIDw9IGNoICYmIGNoIDw9ICd6JyB8fAogICAgICAgICAgICAgICAgICAgJ0EnIDw9IGNoICYmIGNoIDw9ICdaJyB8fAogICAgICAgICAgICAgICAgICAgJ18nID09IGNoIHx8IGNoID09ICckJzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNFeHBPcGVyYXRvcihjaCkgewogICAgICAgICAgICByZXR1cm4gY2ggPT0gJy0nIHx8IGNoID09ICcrJyB8fCBpc051bWJlcihjaCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB0aHJvd0Vycm9yKGVycm9yLCBzdGFydCwgZW5kKSB7CiAgICAgICAgICAgIGVuZCA9IGVuZCB8fCBpbmRleDsKICAgICAgICAgICAgdmFyIGNvbFN0ciA9IChpc0RlZmluZWQoc3RhcnQpID8KICAgICAgICAgICAgICAgICJzICIgKyBzdGFydCArICItIiArIGluZGV4ICsgIiBbIiArIHRleHQuc3Vic3RyaW5nKHN0YXJ0LCBlbmQpICsgIl0iCiAgICAgICAgICAgICAgICA6ICIgIiArIGVuZCk7CiAgICAgICAgICAgIHRocm93ICRwYXJzZU1pbkVycignbGV4ZXJyJywgIkxleGVyIEVycm9yOiB7MH0gYXQgY29sdW1uezF9IGluIGV4cHJlc3Npb24gW3syfV0uIiwKICAgICAgICAgICAgICAgIGVycm9yLCBjb2xTdHIsIHRleHQpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVhZE51bWJlcigpIHsKICAgICAgICAgICAgdmFyIG51bWJlciA9ICIiOwogICAgICAgICAgICB2YXIgc3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBjaCA9IGxvd2VyY2FzZSh0ZXh0LmNoYXJBdChpbmRleCkpOwogICAgICAgICAgICAgICAgaWYgKGNoID09ICcuJyB8fCBpc051bWJlcihjaCkpIHsKICAgICAgICAgICAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBwZWVrQ2ggPSBwZWVrKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09ICdlJyAmJiBpc0V4cE9wZXJhdG9yKHBlZWtDaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgcGVla0NoICYmIGlzTnVtYmVyKHBlZWtDaCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyLmNoYXJBdChudW1iZXIubGVuZ3RoIC0gMSkgPT0gJ2UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlciArPSBjaDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRXhwT3BlcmF0b3IoY2gpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICghcGVla0NoIHx8ICFpc051bWJlcihwZWVrQ2gpKSAmJgogICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcignSW52YWxpZCBleHBvbmVudCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbnVtYmVyID0gMSAqIG51bWJlcjsKICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgaW5kZXg6IHN0YXJ0LCB0ZXh0OiBudW1iZXIsIGpzb246IHRydWUsCiAgICAgICAgICAgICAgICBmbjogZnVuY3Rpb24gKCkgeyByZXR1cm4gbnVtYmVyOyB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFkSWRlbnQoKSB7CiAgICAgICAgICAgIHZhciBpZGVudCA9ICIiLAogICAgICAgICAgICAgICAgc3RhcnQgPSBpbmRleCwKICAgICAgICAgICAgICAgIGxhc3REb3QsIHBlZWtJbmRleCwgbWV0aG9kTmFtZSwgY2g7CgogICAgICAgICAgICB3aGlsZSAoaW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgY2ggPSB0ZXh0LmNoYXJBdChpbmRleCk7CiAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJy4nIHx8IGlzSWRlbnQoY2gpIHx8IGlzTnVtYmVyKGNoKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjaCA9PSAnLicpIGxhc3REb3QgPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICBpZGVudCArPSBjaDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL2NoZWNrIGlmIHRoaXMgaXMgbm90IGEgbWV0aG9kIGludm9jYXRpb24gYW5kIGlmIGl0IGlzIGJhY2sgb3V0IHRvIGxhc3QgZG90CiAgICAgICAgICAgIGlmIChsYXN0RG90KSB7CiAgICAgICAgICAgICAgICBwZWVrSW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgIHdoaWxlIChwZWVrSW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGNoID0gdGV4dC5jaGFyQXQocGVla0luZGV4KTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJygnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZE5hbWUgPSBpZGVudC5zdWJzdHIobGFzdERvdCAtIHN0YXJ0ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkZW50ID0gaWRlbnQuc3Vic3RyKDAsIGxhc3REb3QgLSBzdGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gcGVla0luZGV4OwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGVla0luZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgdmFyIHRva2VuID0gewogICAgICAgICAgICAgICAgaW5kZXg6IHN0YXJ0LAogICAgICAgICAgICAgICAgdGV4dDogaWRlbnQKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChPUEVSQVRPUlMuaGFzT3duUHJvcGVydHkoaWRlbnQpKSB7CiAgICAgICAgICAgICAgICB0b2tlbi5mbiA9IHRva2VuLmpzb24gPSBPUEVSQVRPUlNbaWRlbnRdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGdldHRlciA9IGdldHRlckZuKGlkZW50LCBjc3AsIHRleHQpOwogICAgICAgICAgICAgICAgdG9rZW4uZm4gPSBleHRlbmQoZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoZ2V0dGVyKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbjogZnVuY3Rpb24gKHNlbGYsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXR0ZXIoc2VsZiwgaWRlbnQsIHZhbHVlLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwoKICAgICAgICAgICAgaWYgKG1ldGhvZE5hbWUpIHsKICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpbmRleDogbGFzdERvdCwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiAnLicsCiAgICAgICAgICAgICAgICAgICAganNvbjogZmFsc2UKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgICAgICAgIGluZGV4OiBsYXN0RG90ICsgMSwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBtZXRob2ROYW1lLAogICAgICAgICAgICAgICAgICAgIGpzb246IGZhbHNlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVhZFN0cmluZyhxdW90ZSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSBpbmRleDsKICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiOwogICAgICAgICAgICB2YXIgcmF3U3RyaW5nID0gcXVvdGU7CiAgICAgICAgICAgIHZhciBlc2NhcGUgPSBmYWxzZTsKICAgICAgICAgICAgd2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBjaCA9IHRleHQuY2hhckF0KGluZGV4KTsKICAgICAgICAgICAgICAgIHJhd1N0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgIGlmIChlc2NhcGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gJ3UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoZXggPSB0ZXh0LnN1YnN0cmluZyhpbmRleCArIDEsIGluZGV4ICsgNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaGV4Lm1hdGNoKC9bXGRhLWZdezR9L2kpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiSW52YWxpZCB1bmljb2RlIGVzY2FwZSBbXFx1IiArIGhleCArICJdIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KGhleCwgMTYpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVwID0gRVNDQVBFW2NoXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nICs9IHJlcDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlc2NhcGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2ggPT0gJ1xcJykgewogICAgICAgICAgICAgICAgICAgIGVzY2FwZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNoID09IHF1b3RlKSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBzdGFydCwKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogcmF3U3RyaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmc6IHN0cmluZywKICAgICAgICAgICAgICAgICAgICAgICAganNvbjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHN0cmluZzsgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc3RyaW5nICs9IGNoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvd0Vycm9yKCJVbnRlcm1pbmF0ZWQgcXVvdGUiLCBzdGFydCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gcGFyc2VyKHRleHQsIGpzb24sICRmaWx0ZXIsIGNzcCkgewogICAgICAgIHZhciBaRVJPID0gdmFsdWVGbigwKSwKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHRva2VucyA9IGxleCh0ZXh0LCBjc3ApLAogICAgICAgICAgICBhc3NpZ25tZW50ID0gX2Fzc2lnbm1lbnQsCiAgICAgICAgICAgIGZ1bmN0aW9uQ2FsbCA9IF9mdW5jdGlvbkNhbGwsCiAgICAgICAgICAgIGZpZWxkQWNjZXNzID0gX2ZpZWxkQWNjZXNzLAogICAgICAgICAgICBvYmplY3RJbmRleCA9IF9vYmplY3RJbmRleCwKICAgICAgICAgICAgZmlsdGVyQ2hhaW4gPSBfZmlsdGVyQ2hhaW47CgogICAgICAgIGlmIChqc29uKSB7CiAgICAgICAgICAgIC8vIFRoZSBleHRyYSBsZXZlbCBvZiBhbGlhc2luZyBpcyBoZXJlLCBqdXN0IGluIGNhc2UgdGhlIGxleGVyIG1pc3NlcyBzb21ldGhpbmcsIHNvIHRoYXQKICAgICAgICAgICAgLy8gd2UgcHJldmVudCBhbnkgYWNjaWRlbnRhbCBleGVjdXRpb24gaW4gSlNPTi4KICAgICAgICAgICAgYXNzaWdubWVudCA9IGxvZ2ljYWxPUjsKICAgICAgICAgICAgZnVuY3Rpb25DYWxsID0KICAgICAgICAgICAgICBmaWVsZEFjY2VzcyA9CiAgICAgICAgICAgICAgb2JqZWN0SW5kZXggPQogICAgICAgICAgICAgIGZpbHRlckNoYWluID0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsgdGhyb3dFcnJvcigiaXMgbm90IHZhbGlkIGpzb24iLCB7IHRleHQ6IHRleHQsIGluZGV4OiAwIH0pOyB9OwogICAgICAgICAgICB2YWx1ZSA9IHByaW1hcnkoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9IHN0YXRlbWVudHMoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgdGhyb3dFcnJvcigiaXMgYW4gdW5leHBlY3RlZCB0b2tlbiIsIHRva2Vuc1swXSk7CiAgICAgICAgfQogICAgICAgIHZhbHVlLmxpdGVyYWwgPSAhIXZhbHVlLmxpdGVyYWw7CiAgICAgICAgdmFsdWUuY29uc3RhbnQgPSAhIXZhbHVlLmNvbnN0YW50OwogICAgICAgIHJldHVybiB2YWx1ZTsKCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgICAgICBmdW5jdGlvbiB0aHJvd0Vycm9yKG1zZywgdG9rZW4pIHsKICAgICAgICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdzeW50YXgnLAogICAgICAgICAgICAgICAgIlN5bnRheCBFcnJvcjogVG9rZW4gJ3swfScgezF9IGF0IGNvbHVtbiB7Mn0gb2YgdGhlIGV4cHJlc3Npb24gW3szfV0gc3RhcnRpbmcgYXQgW3s0fV0uIiwKICAgICAgICAgICAgICAgIHRva2VuLnRleHQsIG1zZywgKHRva2VuLmluZGV4ICsgMSksIHRleHQsIHRleHQuc3Vic3RyaW5nKHRva2VuLmluZGV4KSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwZWVrVG9rZW4oKSB7CiAgICAgICAgICAgIGlmICh0b2tlbnMubGVuZ3RoID09PSAwKQogICAgICAgICAgICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCd1ZW9lJywgIlVuZXhwZWN0ZWQgZW5kIG9mIGV4cHJlc3Npb246IHswfSIsIHRleHQpOwogICAgICAgICAgICByZXR1cm4gdG9rZW5zWzBdOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGVlayhlMSwgZTIsIGUzLCBlNCkgewogICAgICAgICAgICBpZiAodG9rZW5zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRva2Vuc1swXTsKICAgICAgICAgICAgICAgIHZhciB0ID0gdG9rZW4udGV4dDsKICAgICAgICAgICAgICAgIGlmICh0ID09IGUxIHx8IHQgPT0gZTIgfHwgdCA9PSBlMyB8fCB0ID09IGU0IHx8CiAgICAgICAgICAgICAgICAgICAgKCFlMSAmJiAhZTIgJiYgIWUzICYmICFlNCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXhwZWN0KGUxLCBlMiwgZTMsIGU0KSB7CiAgICAgICAgICAgIHZhciB0b2tlbiA9IHBlZWsoZTEsIGUyLCBlMywgZTQpOwogICAgICAgICAgICBpZiAodG9rZW4pIHsKICAgICAgICAgICAgICAgIGlmIChqc29uICYmICF0b2tlbi5qc29uKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiaXMgbm90IHZhbGlkIGpzb24iLCB0b2tlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0b2tlbnMuc2hpZnQoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0b2tlbjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjb25zdW1lKGUxKSB7CiAgICAgICAgICAgIGlmICghZXhwZWN0KGUxKSkgewogICAgICAgICAgICAgICAgdGhyb3dFcnJvcigiaXMgdW5leHBlY3RlZCwgZXhwZWN0aW5nIFsiICsgZTEgKyAiXSIsIHBlZWsoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVuYXJ5Rm4oZm4sIHJpZ2h0KSB7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZuKHNlbGYsIGxvY2FscywgcmlnaHQpOwogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBjb25zdGFudDogcmlnaHQuY29uc3RhbnQKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB0ZXJuYXJ5Rm4obGVmdCwgbWlkZGxlLCByaWdodCkgewogICAgICAgICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0KHNlbGYsIGxvY2FscykgPyBtaWRkbGUoc2VsZiwgbG9jYWxzKSA6IHJpZ2h0KHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGNvbnN0YW50OiBsZWZ0LmNvbnN0YW50ICYmIG1pZGRsZS5jb25zdGFudCAmJiByaWdodC5jb25zdGFudAogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGJpbmFyeUZuKGxlZnQsIGZuLCByaWdodCkgewogICAgICAgICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uIChzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmbihzZWxmLCBsb2NhbHMsIGxlZnQsIHJpZ2h0KTsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgY29uc3RhbnQ6IGxlZnQuY29uc3RhbnQgJiYgcmlnaHQuY29uc3RhbnQKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzdGF0ZW1lbnRzKCkgewogICAgICAgICAgICB2YXIgc3RhdGVtZW50cyA9IFtdOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAwICYmICFwZWVrKCd9JywgJyknLCAnOycsICddJykpCiAgICAgICAgICAgICAgICAgICAgc3RhdGVtZW50cy5wdXNoKGZpbHRlckNoYWluKCkpOwogICAgICAgICAgICAgICAgaWYgKCFleHBlY3QoJzsnKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG9wdGltaXplIGZvciB0aGUgY29tbW9uIGNhc2Ugd2hlcmUgdGhlcmUgaXMgb25seSBvbmUgc3RhdGVtZW50LgogICAgICAgICAgICAgICAgICAgIC8vIFRPRE8oc2l6ZSk6IG1heWJlIHdlIHNob3VsZCBub3Qgc3VwcG9ydCBtdWx0aXBsZSBzdGF0ZW1lbnRzPwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZW1lbnRzLmxlbmd0aCA9PSAxCiAgICAgICAgICAgICAgICAgICAgICA/IHN0YXRlbWVudHNbMF0KICAgICAgICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0YXRlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0YXRlbWVudChzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfZmlsdGVyQ2hhaW4oKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCd8JykpKSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBmaWx0ZXIoKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaWx0ZXIoKSB7CiAgICAgICAgICAgIHZhciB0b2tlbiA9IGV4cGVjdCgpOwogICAgICAgICAgICB2YXIgZm4gPSAkZmlsdGVyKHRva2VuLnRleHQpOwogICAgICAgICAgICB2YXIgYXJnc0ZuID0gW107CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCc6JykpKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZuSW52b2tlID0gZnVuY3Rpb24gKHNlbGYsIGxvY2FscywgaW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbaW5wdXRdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGFyZ3NGbltpXShzZWxmLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm5JbnZva2U7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXhwcmVzc2lvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGFzc2lnbm1lbnQoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9hc3NpZ25tZW50KCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IHRlcm5hcnkoKTsKICAgICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJz0nKSkpIHsKICAgICAgICAgICAgICAgIGlmICghbGVmdC5hc3NpZ24pIHsKICAgICAgICAgICAgICAgICAgICB0aHJvd0Vycm9yKCJpbXBsaWVzIGFzc2lnbm1lbnQgYnV0IFsiICsKICAgICAgICAgICAgICAgICAgICAgIHRleHQuc3Vic3RyaW5nKDAsIHRva2VuLmluZGV4KSArICJdIGNhbiBub3QgYmUgYXNzaWduZWQgdG8iLCB0b2tlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByaWdodCA9IHRlcm5hcnkoKTsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0LmFzc2lnbihzY29wZSwgcmlnaHQoc2NvcGUsIGxvY2FscyksIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHRlcm5hcnkoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gbG9naWNhbE9SKCk7CiAgICAgICAgICAgIHZhciBtaWRkbGU7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPycpKSkgewogICAgICAgICAgICAgICAgbWlkZGxlID0gdGVybmFyeSgpOwogICAgICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnOicpKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZXJuYXJ5Rm4obGVmdCwgbWlkZGxlLCB0ZXJuYXJ5KCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dFcnJvcignZXhwZWN0ZWQgOicsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBsb2dpY2FsT1IoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gbG9naWNhbEFORCgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCd8fCcpKSkgewogICAgICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgbG9naWNhbEFORCgpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGxvZ2ljYWxBTkQoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gZXF1YWxpdHkoKTsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICBpZiAoKHRva2VuID0gZXhwZWN0KCcmJicpKSkgewogICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBsb2dpY2FsQU5EKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXF1YWxpdHkoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gcmVsYXRpb25hbCgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIGlmICgodG9rZW4gPSBleHBlY3QoJz09JywgJyE9JywgJz09PScsICchPT0nKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgZXF1YWxpdHkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWxhdGlvbmFsKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IGFkZGl0aXZlKCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgaWYgKCh0b2tlbiA9IGV4cGVjdCgnPCcsICc+JywgJzw9JywgJz49JykpKSB7CiAgICAgICAgICAgICAgICBsZWZ0ID0gYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHJlbGF0aW9uYWwoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRpdGl2ZSgpIHsKICAgICAgICAgICAgdmFyIGxlZnQgPSBtdWx0aXBsaWNhdGl2ZSgpOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICgodG9rZW4gPSBleHBlY3QoJysnLCAnLScpKSkgewogICAgICAgICAgICAgICAgbGVmdCA9IGJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCBtdWx0aXBsaWNhdGl2ZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG11bHRpcGxpY2F0aXZlKCkgewogICAgICAgICAgICB2YXIgbGVmdCA9IHVuYXJ5KCk7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUgKCh0b2tlbiA9IGV4cGVjdCgnKicsICcvJywgJyUnKSkpIHsKICAgICAgICAgICAgICAgIGxlZnQgPSBiaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdW5hcnkoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB1bmFyeSgpIHsKICAgICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgICBpZiAoZXhwZWN0KCcrJykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmltYXJ5KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRva2VuID0gZXhwZWN0KCctJykpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluYXJ5Rm4oWkVSTywgdG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IGV4cGVjdCgnIScpKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVuYXJ5Rm4odG9rZW4uZm4sIHVuYXJ5KCkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnkoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIHByaW1hcnkoKSB7CiAgICAgICAgICAgIHZhciBwcmltYXJ5OwogICAgICAgICAgICBpZiAoZXhwZWN0KCcoJykpIHsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSBmaWx0ZXJDaGFpbigpOwogICAgICAgICAgICAgICAgY29uc3VtZSgnKScpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgnWycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gYXJyYXlEZWNsYXJhdGlvbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdCgneycpKSB7CiAgICAgICAgICAgICAgICBwcmltYXJ5ID0gb2JqZWN0KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKTsKICAgICAgICAgICAgICAgIHByaW1hcnkgPSB0b2tlbi5mbjsKICAgICAgICAgICAgICAgIGlmICghcHJpbWFyeSkgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIm5vdCBhIHByaW1hcnkgZXhwcmVzc2lvbiIsIHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0b2tlbi5qc29uKSB7CiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeS5jb25zdGFudCA9IHByaW1hcnkubGl0ZXJhbCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBuZXh0LCBjb250ZXh0OwogICAgICAgICAgICB3aGlsZSAoKG5leHQgPSBleHBlY3QoJygnLCAnWycsICcuJykpKSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dC50ZXh0ID09PSAnKCcpIHsKICAgICAgICAgICAgICAgICAgICBwcmltYXJ5ID0gZnVuY3Rpb25DYWxsKHByaW1hcnksIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0LnRleHQgPT09ICdbJykgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBwcmltYXJ5OwogICAgICAgICAgICAgICAgICAgIHByaW1hcnkgPSBvYmplY3RJbmRleChwcmltYXJ5KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dC50ZXh0ID09PSAnLicpIHsKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gcHJpbWFyeTsKICAgICAgICAgICAgICAgICAgICBwcmltYXJ5ID0gZmllbGRBY2Nlc3MocHJpbWFyeSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93RXJyb3IoIklNUE9TU0lCTEUiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJpbWFyeTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9maWVsZEFjY2VzcyhvYmplY3QpIHsKICAgICAgICAgICAgdmFyIGZpZWxkID0gZXhwZWN0KCkudGV4dDsKICAgICAgICAgICAgdmFyIGdldHRlciA9IGdldHRlckZuKGZpZWxkLCBjc3AsIHRleHQpOwogICAgICAgICAgICByZXR1cm4gZXh0ZW5kKAogICAgICAgICAgICAgICAgZnVuY3Rpb24gKHNjb3BlLCBsb2NhbHMsIHNlbGYpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0dGVyKHNlbGYgfHwgb2JqZWN0KHNjb3BlLCBsb2NhbHMpLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ246IGZ1bmN0aW9uIChzY29wZSwgdmFsdWUsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2V0dGVyKG9iamVjdChzY29wZSwgbG9jYWxzKSwgZmllbGQsIHZhbHVlLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfb2JqZWN0SW5kZXgob2JqKSB7CiAgICAgICAgICAgIHZhciBpbmRleEZuID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICBjb25zdW1lKCddJyk7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoCiAgICAgICAgICAgICAgZnVuY3Rpb24gKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICB2YXIgbyA9IG9iaihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgICAgICAgICAgICAgaSA9IGluZGV4Rm4oc2VsZiwgbG9jYWxzKSwKICAgICAgICAgICAgICAgICAgICAgIHYsIHA7CgogICAgICAgICAgICAgICAgICBpZiAoIW8pIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgIHYgPSBlbnN1cmVTYWZlT2JqZWN0KG9baV0sIHRleHQpOwogICAgICAgICAgICAgICAgICBpZiAodiAmJiB2LnRoZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIHAgPSB2OwogICAgICAgICAgICAgICAgICAgICAgaWYgKCEoJyQkdicgaW4gdikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBwLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICBwLnRoZW4oZnVuY3Rpb24gKHZhbCkgeyBwLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB2ID0gdi4kJHY7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBhc3NpZ246IGZ1bmN0aW9uIChzZWxmLCB2YWx1ZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gaW5kZXhGbihzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgLy8gcHJldmVudCBvdmVyd3JpdGluZyBvZiBGdW5jdGlvbi5jb25zdHJ1Y3RvciB3aGljaCB3b3VsZCBicmVhayBlbnN1cmVTYWZlT2JqZWN0IGNoZWNrCiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW5zdXJlU2FmZU9iamVjdChvYmooc2VsZiwgbG9jYWxzKSwgdGV4dClba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfZnVuY3Rpb25DYWxsKGZuLCBjb250ZXh0R2V0dGVyKSB7CiAgICAgICAgICAgIHZhciBhcmdzRm4gPSBbXTsKICAgICAgICAgICAgaWYgKHBlZWtUb2tlbigpLnRleHQgIT0gJyknKSB7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgYXJnc0ZuLnB1c2goZXhwcmVzc2lvbigpKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGV4cGVjdCgnLCcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdW1lKCcpJyk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dEdldHRlciA/IGNvbnRleHRHZXR0ZXIoc2NvcGUsIGxvY2FscykgOiBzY29wZTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3NGbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChhcmdzRm5baV0oc2NvcGUsIGxvY2FscykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGZuUHRyID0gZm4oc2NvcGUsIGxvY2FscywgY29udGV4dCkgfHwgbm9vcDsKICAgICAgICAgICAgICAgIC8vIElFIHN0dXBpZGl0eSEKICAgICAgICAgICAgICAgIHZhciB2ID0gZm5QdHIuYXBwbHkKICAgICAgICAgICAgICAgICAgICA/IGZuUHRyLmFwcGx5KGNvbnRleHQsIGFyZ3MpCiAgICAgICAgICAgICAgICAgICAgOiBmblB0cihhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdLCBhcmdzWzNdLCBhcmdzWzRdKTsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBmb3IgcHJvbWlzZQogICAgICAgICAgICAgICAgaWYgKHYgJiYgdi50aGVuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHAgPSB2OwogICAgICAgICAgICAgICAgICAgIGlmICghKCckJHYnIGluIHYpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHAuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICBwLnRoZW4oZnVuY3Rpb24gKHZhbCkgeyBwLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHYgPSB2LiQkdjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIC8vIFRoaXMgaXMgdXNlZCB3aXRoIGpzb24gYXJyYXkgZGVjbGFyYXRpb24KICAgICAgICBmdW5jdGlvbiBhcnJheURlY2xhcmF0aW9uKCkgewogICAgICAgICAgICB2YXIgZWxlbWVudEZucyA9IFtdOwogICAgICAgICAgICB2YXIgYWxsQ29uc3RhbnQgPSB0cnVlOwogICAgICAgICAgICBpZiAocGVla1Rva2VuKCkudGV4dCAhPSAnXScpIHsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbWVudEZuID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRGbnMucHVzaChlbGVtZW50Rm4pOwogICAgICAgICAgICAgICAgICAgIGlmICghZWxlbWVudEZuLmNvbnN0YW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFsbENvbnN0YW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN1bWUoJ10nKTsKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAoc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudEZucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFycmF5LnB1c2goZWxlbWVudEZuc1tpXShzZWxmLCBsb2NhbHMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgbGl0ZXJhbDogdHJ1ZSwKICAgICAgICAgICAgICAgIGNvbnN0YW50OiBhbGxDb25zdGFudAogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG9iamVjdCgpIHsKICAgICAgICAgICAgdmFyIGtleVZhbHVlcyA9IFtdOwogICAgICAgICAgICB2YXIgYWxsQ29uc3RhbnQgPSB0cnVlOwogICAgICAgICAgICBpZiAocGVla1Rva2VuKCkudGV4dCAhPSAnfScpIHsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSBleHBlY3QoKSwKICAgICAgICAgICAgICAgICAgICBrZXkgPSB0b2tlbi5zdHJpbmcgfHwgdG9rZW4udGV4dDsKICAgICAgICAgICAgICAgICAgICBjb25zdW1lKCI6Iik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICAgIGtleVZhbHVlcy5wdXNoKHsga2V5OiBrZXksIHZhbHVlOiB2YWx1ZSB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlLmNvbnN0YW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFsbENvbnN0YW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSB3aGlsZSAoZXhwZWN0KCcsJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN1bWUoJ30nKTsKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAoc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0ID0ge307CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleVZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBrZXlWYWx1ZSA9IGtleVZhbHVlc1tpXTsKICAgICAgICAgICAgICAgICAgICBvYmplY3Rba2V5VmFsdWUua2V5XSA9IGtleVZhbHVlLnZhbHVlKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBsaXRlcmFsOiB0cnVlLAogICAgICAgICAgICAgICAgY29uc3RhbnQ6IGFsbENvbnN0YW50CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8gUGFyc2VyIGhlbHBlciBmdW5jdGlvbnMKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gc2V0dGVyKG9iaiwgcGF0aCwgc2V0VmFsdWUsIGZ1bGxFeHApIHsKICAgICAgICB2YXIgZWxlbWVudCA9IHBhdGguc3BsaXQoJy4nKSwga2V5OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBlbGVtZW50Lmxlbmd0aCA+IDE7IGkrKykgewogICAgICAgICAgICBrZXkgPSBlbnN1cmVTYWZlTWVtYmVyTmFtZShlbGVtZW50LnNoaWZ0KCksIGZ1bGxFeHApOwogICAgICAgICAgICB2YXIgcHJvcGVydHlPYmogPSBvYmpba2V5XTsKICAgICAgICAgICAgaWYgKCFwcm9wZXJ0eU9iaikgewogICAgICAgICAgICAgICAgcHJvcGVydHlPYmogPSB7fTsKICAgICAgICAgICAgICAgIG9ialtrZXldID0gcHJvcGVydHlPYmo7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb2JqID0gcHJvcGVydHlPYmo7CiAgICAgICAgICAgIGlmIChvYmoudGhlbikgewogICAgICAgICAgICAgICAgaWYgKCEoIiQkdiIgaW4gb2JqKSkgewogICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAocHJvbWlzZSkgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICkob2JqKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvYmouJCR2ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBvYmouJCR2ID0ge307CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvYmogPSBvYmouJCR2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGtleSA9IGVuc3VyZVNhZmVNZW1iZXJOYW1lKGVsZW1lbnQuc2hpZnQoKSwgZnVsbEV4cCk7CiAgICAgICAgb2JqW2tleV0gPSBzZXRWYWx1ZTsKICAgICAgICByZXR1cm4gc2V0VmFsdWU7CiAgICB9CgogICAgdmFyIGdldHRlckZuQ2FjaGUgPSB7fTsKCiAgICAvKioKICAgICAqIEltcGxlbWVudGF0aW9uIG9mIHRoZSAiQmxhY2sgSG9sZSIgdmFyaWFudCBmcm9tOgogICAgICogLSBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyanMtcGFyc2UtZ2V0dGVyLzQKICAgICAqIC0gaHR0cDovL2pzcGVyZi5jb20vcGF0aC1ldmFsdWF0aW9uLXNpbXBsaWZpZWQvNwogICAgICovCiAgICBmdW5jdGlvbiBjc3BTYWZlR2V0dGVyRm4oa2V5MCwga2V5MSwga2V5Miwga2V5Mywga2V5NCwgZnVsbEV4cCkgewogICAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTAsIGZ1bGxFeHApOwogICAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTEsIGZ1bGxFeHApOwogICAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTIsIGZ1bGxFeHApOwogICAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTMsIGZ1bGxFeHApOwogICAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTQsIGZ1bGxFeHApOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICB2YXIgcGF0aFZhbCA9IChsb2NhbHMgJiYgbG9jYWxzLmhhc093blByb3BlcnR5KGtleTApKSA/IGxvY2FscyA6IHNjb3BlLAogICAgICAgICAgICAgICAgcHJvbWlzZTsKCiAgICAgICAgICAgIGlmIChwYXRoVmFsID09PSBudWxsIHx8IHBhdGhWYWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHBhdGhWYWw7CgogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkwXTsKICAgICAgICAgICAgaWYgKHBhdGhWYWwgJiYgcGF0aFZhbC50aGVuKSB7CiAgICAgICAgICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwYXRoVmFsOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAodmFsKSB7IHByb21pc2UuJCR2ID0gdmFsOyB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsLiQkdjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWtleTEgfHwgcGF0aFZhbCA9PT0gbnVsbCB8fCBwYXRoVmFsID09PSB1bmRlZmluZWQpIHJldHVybiBwYXRoVmFsOwoKICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5MV07CiAgICAgICAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgICAgICAgICAgaWYgKCEoIiQkdiIgaW4gcGF0aFZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXkyIHx8IHBhdGhWYWwgPT09IG51bGwgfHwgcGF0aFZhbCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTJdOwogICAgICAgICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICAgICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWwpIHsgcHJvbWlzZS4kJHYgPSB2YWw7IH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWwuJCR2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgha2V5MyB8fCBwYXRoVmFsID09PSBudWxsIHx8IHBhdGhWYWwgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHBhdGhWYWw7CgogICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkzXTsKICAgICAgICAgICAgaWYgKHBhdGhWYWwgJiYgcGF0aFZhbC50aGVuKSB7CiAgICAgICAgICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwYXRoVmFsOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAodmFsKSB7IHByb21pc2UuJCR2ID0gdmFsOyB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsLiQkdjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWtleTQgfHwgcGF0aFZhbCA9PT0gbnVsbCB8fCBwYXRoVmFsID09PSB1bmRlZmluZWQpIHJldHVybiBwYXRoVmFsOwoKICAgICAgICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5NF07CiAgICAgICAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgICAgICAgICAgaWYgKCEoIiQkdiIgaW4gcGF0aFZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhdGhWYWw7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXR0ZXJGbihwYXRoLCBjc3AsIGZ1bGxFeHApIHsKICAgICAgICBpZiAoZ2V0dGVyRm5DYWNoZS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0dGVyRm5DYWNoZVtwYXRoXTsKICAgICAgICB9CgogICAgICAgIHZhciBwYXRoS2V5cyA9IHBhdGguc3BsaXQoJy4nKSwKICAgICAgICAgICAgcGF0aEtleXNMZW5ndGggPSBwYXRoS2V5cy5sZW5ndGgsCiAgICAgICAgICAgIGZuOwoKICAgICAgICBpZiAoY3NwKSB7CiAgICAgICAgICAgIGZuID0gKHBhdGhLZXlzTGVuZ3RoIDwgNikKICAgICAgICAgICAgICAgID8gY3NwU2FmZUdldHRlckZuKHBhdGhLZXlzWzBdLCBwYXRoS2V5c1sxXSwgcGF0aEtleXNbMl0sIHBhdGhLZXlzWzNdLCBwYXRoS2V5c1s0XSwgZnVsbEV4cCkKICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IDAsIHZhbDsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IGNzcFNhZmVHZXR0ZXJGbigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBmdWxsRXhwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkoc2NvcGUsIGxvY2Fscyk7CgogICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHMgPSB1bmRlZmluZWQ7IC8vIGNsZWFyIGFmdGVyIGZpcnN0IGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChpIDwgcGF0aEtleXNMZW5ndGgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGNvZGUgPSAndmFyIGwsIGZuLCBwO1xuJzsKICAgICAgICAgICAgZm9yRWFjaChwYXRoS2V5cywgZnVuY3Rpb24gKGtleSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleSwgZnVsbEV4cCk7CiAgICAgICAgICAgICAgICBjb2RlICs9ICdpZihzID09PSBudWxsIHx8IHMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHM7XG4nICsKICAgICAgICAgICAgICAgICAgICAgICAgJ2w9cztcbicgKwogICAgICAgICAgICAgICAgICAgICAgICAncz0nICsgKGluZGV4CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2Ugc2ltcGx5IGRlcmVmZXJlbmNlICdzJyBvbiBhbnkgLmRvdCBub3RhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ3MnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnV0IGlmIHdlIGFyZSBmaXJzdCB0aGVuIHdlIGNoZWNrIGxvY2FscyBmaXJzdCwgYW5kIGlmIHNvIHJlYWQgaXQgZmlyc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICcoKGsmJmsuaGFzT3duUHJvcGVydHkoIicgKyBrZXkgKyAnIikpP2s6cyknKSArICdbIicgKyBrZXkgKyAnIl0nICsgJztcbicgKwogICAgICAgICAgICAgICAgICAgICAgICAnaWYgKHMgJiYgcy50aGVuKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAnIGlmICghKCIkJHYiIGluIHMpKSB7XG4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgcD1zO1xuJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnIHAuJCR2ID0gdW5kZWZpbmVkO1xuJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnIHAudGhlbihmdW5jdGlvbih2KSB7cC4kJHY9djt9KTtcbicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ31cbicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICcgcz1zLiQkdlxuJyArCiAgICAgICAgICAgICAgICAgICAgICAgICd9XG4nOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29kZSArPSAncmV0dXJuIHM7JzsKICAgICAgICAgICAgZm4gPSBGdW5jdGlvbigncycsICdrJywgY29kZSk7IC8vIHM9c2NvcGUsIGs9bG9jYWxzCiAgICAgICAgICAgIGZuLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gY29kZTsgfTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBnZXR0ZXJGbkNhY2hlW3BhdGhdID0gZm47CiAgICB9CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuJHBhcnNlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBDb252ZXJ0cyBBbmd1bGFyIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGludG8gYSBmdW5jdGlvbi4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICB2YXIgZ2V0dGVyID0gJHBhcnNlKCd1c2VyLm5hbWUnKTsKICAgICAqICAgdmFyIHNldHRlciA9IGdldHRlci5hc3NpZ247CiAgICAgKiAgIHZhciBjb250ZXh0ID0ge3VzZXI6e25hbWU6J2FuZ3VsYXInfX07CiAgICAgKiAgIHZhciBsb2NhbHMgPSB7dXNlcjp7bmFtZTonbG9jYWwnfX07CiAgICAgKgogICAgICogICBleHBlY3QoZ2V0dGVyKGNvbnRleHQpKS50b0VxdWFsKCdhbmd1bGFyJyk7CiAgICAgKiAgIHNldHRlcihjb250ZXh0LCAnbmV3VmFsdWUnKTsKICAgICAqICAgZXhwZWN0KGNvbnRleHQudXNlci5uYW1lKS50b0VxdWFsKCduZXdWYWx1ZScpOwogICAgICogICBleHBlY3QoZ2V0dGVyKGNvbnRleHQsIGxvY2FscykpLnRvRXF1YWwoJ2xvY2FsJyk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgKgogICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAqCiAgICAgKiAgICBUaGUgcmV0dXJuZWQgZnVuY3Rpb24gYWxzbyBoYXMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICogICAgICAqIGBsaXRlcmFsYCDigJMgYHtib29sZWFufWAg4oCTIHdoZXRoZXIgdGhlIGV4cHJlc3Npb24ncyB0b3AtbGV2ZWwgbm9kZSBpcyBhIEphdmFTY3JpcHQKICAgICAqICAgICAgICBsaXRlcmFsLgogICAgICogICAgICAqIGBjb25zdGFudGAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB3aGV0aGVyIHRoZSBleHByZXNzaW9uIGlzIG1hZGUgZW50aXJlbHkgb2YgSmF2YVNjcmlwdAogICAgICogICAgICAgIGNvbnN0YW50IGxpdGVyYWxzLgogICAgICogICAgICAqIGBhc3NpZ25gIOKAkyBgez9mdW5jdGlvbihjb250ZXh0LCB2YWx1ZSl9YCDigJMgaWYgdGhlIGV4cHJlc3Npb24gaXMgYXNzaWduYWJsZSwgdGhpcyB3aWxsIGJlCiAgICAgKiAgICAgICAgc2V0IHRvIGEgZnVuY3Rpb24gdG8gY2hhbmdlIGl0cyB2YWx1ZSBvbiB0aGUgZ2l2ZW4gY29udGV4dC4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uICRQYXJzZVByb3ZpZGVyKCkgewogICAgICAgIHZhciBjYWNoZSA9IHt9OwogICAgICAgIHRoaXMuJGdldCA9IFsnJGZpbHRlcicsICckc25pZmZlcicsIGZ1bmN0aW9uICgkZmlsdGVyLCAkc25pZmZlcikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGV4cCkgewogICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgZXhwKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlLmhhc093blByb3BlcnR5KGV4cCkKICAgICAgICAgICAgICAgICAgICAgICAgICA/IGNhY2hlW2V4cF0KICAgICAgICAgICAgICAgICAgICAgICAgICA6IGNhY2hlW2V4cF0gPSBwYXJzZXIoZXhwLCBmYWxzZSwgJGZpbHRlciwgJHNuaWZmZXIuY3NwKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBleHA7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICogQG5hbWUgbmcuJHEKICAgICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBIHByb21pc2UvZGVmZXJyZWQgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0tyaXMgS293YWwncyBRXShodHRwczovL2dpdGh1Yi5jb20va3Jpc2tvd2FsL3EpLgogICAgICoKICAgICAqIFtUaGUgQ29tbW9uSlMgUHJvbWlzZSBwcm9wb3NhbF0oaHR0cDovL3dpa2kuY29tbW9uanMub3JnL3dpa2kvUHJvbWlzZXMpIGRlc2NyaWJlcyBhIHByb21pc2UgYXMgYW4KICAgICAqIGludGVyZmFjZSBmb3IgaW50ZXJhY3Rpbmcgd2l0aCBhbiBvYmplY3QgdGhhdCByZXByZXNlbnRzIHRoZSByZXN1bHQgb2YgYW4gYWN0aW9uIHRoYXQgaXMKICAgICAqIHBlcmZvcm1lZCBhc3luY2hyb25vdXNseSwgYW5kIG1heSBvciBtYXkgbm90IGJlIGZpbmlzaGVkIGF0IGFueSBnaXZlbiBwb2ludCBpbiB0aW1lLgogICAgICoKICAgICAqIEZyb20gdGhlIHBlcnNwZWN0aXZlIG9mIGRlYWxpbmcgd2l0aCBlcnJvciBoYW5kbGluZywgZGVmZXJyZWQgYW5kIHByb21pc2UgQVBJcyBhcmUgdG8KICAgICAqIGFzeW5jaHJvbm91cyBwcm9ncmFtbWluZyB3aGF0IGB0cnlgLCBgY2F0Y2hgIGFuZCBgdGhyb3dgIGtleXdvcmRzIGFyZSB0byBzeW5jaHJvbm91cyBwcm9ncmFtbWluZy4KICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICAvLyBmb3IgdGhlIHB1cnBvc2Ugb2YgdGhpcyBleGFtcGxlIGxldCdzIGFzc3VtZSB0aGF0IHZhcmlhYmxlcyBgJHFgIGFuZCBgc2NvcGVgIGFyZQogICAgICogICAvLyBhdmFpbGFibGUgaW4gdGhlIGN1cnJlbnQgbGV4aWNhbCBzY29wZSAodGhleSBjb3VsZCBoYXZlIGJlZW4gaW5qZWN0ZWQgb3IgcGFzc2VkIGluKS4KICAgICAqCiAgICAgKiAgIGZ1bmN0aW9uIGFzeW5jR3JlZXQobmFtZSkgewogICAgICogICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7CiAgICAgKgogICAgICogICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgICAvLyBzaW5jZSB0aGlzIGZuIGV4ZWN1dGVzIGFzeW5jIGluIGEgZnV0dXJlIHR1cm4gb2YgdGhlIGV2ZW50IGxvb3AsIHdlIG5lZWQgdG8gd3JhcAogICAgICogICAgICAgLy8gb3VyIGNvZGUgaW50byBhbiAkYXBwbHkgY2FsbCBzbyB0aGF0IHRoZSBtb2RlbCBjaGFuZ2VzIGFyZSBwcm9wZXJseSBvYnNlcnZlZC4KICAgICAqICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAqICAgICAgICAgZGVmZXJyZWQubm90aWZ5KCdBYm91dCB0byBncmVldCAnICsgbmFtZSArICcuJyk7CiAgICAgKgogICAgICogICAgICAgICBpZiAob2tUb0dyZWV0KG5hbWUpKSB7CiAgICAgKiAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgnSGVsbG8sICcgKyBuYW1lICsgJyEnKTsKICAgICAqICAgICAgICAgfSBlbHNlIHsKICAgICAqICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoJ0dyZWV0aW5nICcgKyBuYW1lICsgJyBpcyBub3QgYWxsb3dlZC4nKTsKICAgICAqICAgICAgICAgfQogICAgICogICAgICAgfSk7CiAgICAgKiAgICAgfSwgMTAwMCk7CiAgICAgKgogICAgICogICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogICAgICogICB9CiAgICAgKgogICAgICogICB2YXIgcHJvbWlzZSA9IGFzeW5jR3JlZXQoJ1JvYmluIEhvb2QnKTsKICAgICAqICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICAgKiAgICAgYWxlcnQoJ1N1Y2Nlc3M6ICcgKyBncmVldGluZyk7CiAgICAgKiAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICogICAgIGFsZXJ0KCdGYWlsZWQ6ICcgKyByZWFzb24pOwogICAgICogICB9LCBmdW5jdGlvbih1cGRhdGUpIHsKICAgICAqICAgICBhbGVydCgnR290IG5vdGlmaWNhdGlvbjogJyArIHVwZGF0ZSk7CiAgICAgKiAgIH0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQXQgZmlyc3QgaXQgbWlnaHQgbm90IGJlIG9idmlvdXMgd2h5IHRoaXMgZXh0cmEgY29tcGxleGl0eSBpcyB3b3J0aCB0aGUgdHJvdWJsZS4gVGhlIHBheW9mZgogICAgICogY29tZXMgaW4gdGhlIHdheSBvZgogICAgICogW2d1YXJhbnRlZXMgdGhhdCBwcm9taXNlIGFuZCBkZWZlcnJlZCBBUElzIG1ha2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvdW5jb21tb25qcy9ibG9iL21hc3Rlci9wcm9taXNlcy9zcGVjaWZpY2F0aW9uLm1kKS4KICAgICAqCiAgICAgKiBBZGRpdGlvbmFsbHkgdGhlIHByb21pc2UgYXBpIGFsbG93cyBmb3IgY29tcG9zaXRpb24gdGhhdCBpcyB2ZXJ5IGhhcmQgdG8gZG8gd2l0aCB0aGUKICAgICAqIHRyYWRpdGlvbmFsIGNhbGxiYWNrIChbQ1BTXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0NvbnRpbnVhdGlvbi1wYXNzaW5nX3N0eWxlKSkgYXBwcm9hY2guCiAgICAgKiBGb3IgbW9yZSBvbiB0aGlzIHBsZWFzZSBzZWUgdGhlIFtRIGRvY3VtZW50YXRpb25dKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcSkgZXNwZWNpYWxseSB0aGUKICAgICAqIHNlY3Rpb24gb24gc2VyaWFsIG9yIHBhcmFsbGVsIGpvaW5pbmcgb2YgcHJvbWlzZXMuCiAgICAgKgogICAgICoKICAgICAqICMgVGhlIERlZmVycmVkIEFQSQogICAgICoKICAgICAqIEEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkIGlzIGNvbnN0cnVjdGVkIGJ5IGNhbGxpbmcgYCRxLmRlZmVyKClgLgogICAgICoKICAgICAqIFRoZSBwdXJwb3NlIG9mIHRoZSBkZWZlcnJlZCBvYmplY3QgaXMgdG8gZXhwb3NlIHRoZSBhc3NvY2lhdGVkIFByb21pc2UgaW5zdGFuY2UgYXMgd2VsbCBhcyBBUElzCiAgICAgKiB0aGF0IGNhbiBiZSB1c2VkIGZvciBzaWduYWxpbmcgdGhlIHN1Y2Nlc3NmdWwgb3IgdW5zdWNjZXNzZnVsIGNvbXBsZXRpb24sIGFzIHdlbGwgYXMgdGhlIHN0YXR1cwogICAgICogb2YgdGhlIHRhc2suCiAgICAgKgogICAgICogKipNZXRob2RzKioKICAgICAqCiAgICAgKiAtIGByZXNvbHZlKHZhbHVlKWAg4oCTIHJlc29sdmVzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHZhbHVlYC4gSWYgdGhlIHZhbHVlIGlzIGEgcmVqZWN0aW9uCiAgICAgKiAgIGNvbnN0cnVjdGVkIHZpYSBgJHEucmVqZWN0YCwgdGhlIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCBpbnN0ZWFkLgogICAgICogLSBgcmVqZWN0KHJlYXNvbilgIOKAkyByZWplY3RzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHJlYXNvbmAuIFRoaXMgaXMgZXF1aXZhbGVudCB0bwogICAgICogICByZXNvbHZpbmcgaXQgd2l0aCBhIHJlamVjdGlvbiBjb25zdHJ1Y3RlZCB2aWEgYCRxLnJlamVjdGAuCiAgICAgKiAtIGBub3RpZnkodmFsdWUpYCAtIHByb3ZpZGVzIHVwZGF0ZXMgb24gdGhlIHN0YXR1cyBvZiB0aGUgcHJvbWlzZXMgZXhlY3V0aW9uLiBUaGlzIG1heSBiZSBjYWxsZWQKICAgICAqICAgbXVsdGlwbGUgdGltZXMgYmVmb3JlIHRoZSBwcm9taXNlIGlzIGVpdGhlciByZXNvbHZlZCBvciByZWplY3RlZC4KICAgICAqCiAgICAgKiAqKlByb3BlcnRpZXMqKgogICAgICoKICAgICAqIC0gcHJvbWlzZSDigJMgYHtQcm9taXNlfWAg4oCTIHByb21pc2Ugb2JqZWN0IGFzc29jaWF0ZWQgd2l0aCB0aGlzIGRlZmVycmVkLgogICAgICoKICAgICAqCiAgICAgKiAjIFRoZSBQcm9taXNlIEFQSQogICAgICoKICAgICAqIEEgbmV3IHByb21pc2UgaW5zdGFuY2UgaXMgY3JlYXRlZCB3aGVuIGEgZGVmZXJyZWQgaW5zdGFuY2UgaXMgY3JlYXRlZCBhbmQgY2FuIGJlIHJldHJpZXZlZCBieQogICAgICogY2FsbGluZyBgZGVmZXJyZWQucHJvbWlzZWAuCiAgICAgKgogICAgICogVGhlIHB1cnBvc2Ugb2YgdGhlIHByb21pc2Ugb2JqZWN0IGlzIHRvIGFsbG93IGZvciBpbnRlcmVzdGVkIHBhcnRpZXMgdG8gZ2V0IGFjY2VzcyB0byB0aGUgcmVzdWx0CiAgICAgKiBvZiB0aGUgZGVmZXJyZWQgdGFzayB3aGVuIGl0IGNvbXBsZXRlcy4KICAgICAqCiAgICAgKiAqKk1ldGhvZHMqKgogICAgICoKICAgICAqIC0gYHRoZW4oc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrLCBub3RpZnlDYWxsYmFjaylgIOKAkyByZWdhcmRsZXNzIG9mIHdoZW4gdGhlIHByb21pc2Ugd2FzIG9yCiAgICAgKiAgIHdpbGwgYmUgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQsIGB0aGVuYCBjYWxscyBvbmUgb2YgdGhlIHN1Y2Nlc3Mgb3IgZXJyb3IgY2FsbGJhY2tzIGFzeW5jaHJvbm91c2x5CiAgICAgKiAgIGFzIHNvb24gYXMgdGhlIHJlc3VsdCBpcyBhdmFpbGFibGUuIFRoZSBjYWxsYmFja3MgYXJlIGNhbGxlZCB3aXRoIGEgc2luZ2xlIGFyZ3VtZW50OiB0aGUgcmVzdWx0CiAgICAgKiAgIG9yIHJlamVjdGlvbiByZWFzb24uIEFkZGl0aW9uYWxseSwgdGhlIG5vdGlmeSBjYWxsYmFjayBtYXkgYmUgY2FsbGVkIHplcm8gb3IgbW9yZSB0aW1lcyB0bwogICAgICogICBwcm92aWRlIGEgcHJvZ3Jlc3MgaW5kaWNhdGlvbiwgYmVmb3JlIHRoZSBwcm9taXNlIGlzIHJlc29sdmVkIG9yIHJlamVjdGVkLgogICAgICoKICAgICAqICAgVGhpcyBtZXRob2QgKnJldHVybnMgYSBuZXcgcHJvbWlzZSogd2hpY2ggaXMgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQgdmlhIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlCiAgICAgKiAgIGBzdWNjZXNzQ2FsbGJhY2tgLCBgZXJyb3JDYWxsYmFja2AuIEl0IGFsc28gbm90aWZpZXMgdmlhIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGBub3RpZnlDYWxsYmFja2AKICAgICAqICAgbWV0aG9kLiBUaGUgcHJvbWlzZSBjYW4gbm90IGJlIHJlc29sdmVkIG9yIHJlamVjdGVkIGZyb20gdGhlIG5vdGlmeUNhbGxiYWNrIG1ldGhvZC4KICAgICAqCiAgICAgKiAtIGBjYXRjaChlcnJvckNhbGxiYWNrKWAg4oCTIHNob3J0aGFuZCBmb3IgYHByb21pc2UudGhlbihudWxsLCBlcnJvckNhbGxiYWNrKWAKICAgICAqCiAgICAgKiAtIGBmaW5hbGx5KGNhbGxiYWNrKWAg4oCTIGFsbG93cyB5b3UgdG8gb2JzZXJ2ZSBlaXRoZXIgdGhlIGZ1bGZpbGxtZW50IG9yIHJlamVjdGlvbiBvZiBhIHByb21pc2UsCiAgICAgKiAgIGJ1dCB0byBkbyBzbyB3aXRob3V0IG1vZGlmeWluZyB0aGUgZmluYWwgdmFsdWUuIFRoaXMgaXMgdXNlZnVsIHRvIHJlbGVhc2UgcmVzb3VyY2VzIG9yIGRvIHNvbWUKICAgICAqICAgY2xlYW4tdXAgdGhhdCBuZWVkcyB0byBiZSBkb25lIHdoZXRoZXIgdGhlIHByb21pc2Ugd2FzIHJlamVjdGVkIG9yIHJlc29sdmVkLiBTZWUgdGhlIFtmdWxsCiAgICAgKiAgIHNwZWNpZmljYXRpb25dKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcS93aWtpL0FQSS1SZWZlcmVuY2UjcHJvbWlzZWZpbmFsbHljYWxsYmFjaykgZm9yCiAgICAgKiAgIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgKgogICAgICogICBCZWNhdXNlIGBmaW5hbGx5YCBpcyBhIHJlc2VydmVkIHdvcmQgaW4gSmF2YVNjcmlwdCBhbmQgcmVzZXJ2ZWQga2V5d29yZHMgYXJlIG5vdCBzdXBwb3J0ZWQgYXMKICAgICAqICAgcHJvcGVydHkgbmFtZXMgYnkgRVMzLCB5b3UnbGwgbmVlZCB0byBpbnZva2UgdGhlIG1ldGhvZCBsaWtlIGBwcm9taXNlWydmaW5hbGx5J10oY2FsbGJhY2spYCB0bwogICAgICogICBtYWtlIHlvdXIgY29kZSBJRTggY29tcGF0aWJsZS4KICAgICAqCiAgICAgKiAjIENoYWluaW5nIHByb21pc2VzCiAgICAgKgogICAgICogQmVjYXVzZSBjYWxsaW5nIHRoZSBgdGhlbmAgbWV0aG9kIG9mIGEgcHJvbWlzZSByZXR1cm5zIGEgbmV3IGRlcml2ZWQgcHJvbWlzZSwgaXQgaXMgZWFzaWx5IHBvc3NpYmxlCiAgICAgKiB0byBjcmVhdGUgYSBjaGFpbiBvZiBwcm9taXNlczoKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogICBwcm9taXNlQiA9IHByb21pc2VBLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgKiAgICAgcmV0dXJuIHJlc3VsdCArIDE7CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gcHJvbWlzZUIgd2lsbCBiZSByZXNvbHZlZCBpbW1lZGlhdGVseSBhZnRlciBwcm9taXNlQSBpcyByZXNvbHZlZCBhbmQgaXRzIHZhbHVlCiAgICAgKiAgIC8vIHdpbGwgYmUgdGhlIHJlc3VsdCBvZiBwcm9taXNlQSBpbmNyZW1lbnRlZCBieSAxCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBJdCBpcyBwb3NzaWJsZSB0byBjcmVhdGUgY2hhaW5zIG9mIGFueSBsZW5ndGggYW5kIHNpbmNlIGEgcHJvbWlzZSBjYW4gYmUgcmVzb2x2ZWQgd2l0aCBhbm90aGVyCiAgICAgKiBwcm9taXNlICh3aGljaCB3aWxsIGRlZmVyIGl0cyByZXNvbHV0aW9uIGZ1cnRoZXIpLCBpdCBpcyBwb3NzaWJsZSB0byBwYXVzZS9kZWZlciByZXNvbHV0aW9uIG9mCiAgICAgKiB0aGUgcHJvbWlzZXMgYXQgYW55IHBvaW50IGluIHRoZSBjaGFpbi4gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSB0byBpbXBsZW1lbnQgcG93ZXJmdWwgQVBJcyBsaWtlCiAgICAgKiAkaHR0cCdzIHJlc3BvbnNlIGludGVyY2VwdG9ycy4KICAgICAqCiAgICAgKgogICAgICogIyBEaWZmZXJlbmNlcyBiZXR3ZWVuIEtyaXMgS293YWwncyBRIGFuZCAkcQogICAgICoKICAgICAqICBUaGVyZSBhcmUgdGhyZWUgbWFpbiBkaWZmZXJlbmNlczoKICAgICAqCiAgICAgKiAtICRxIGlzIGludGVncmF0ZWQgd2l0aCB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGV9IFNjb3BlIG1vZGVsIG9ic2VydmF0aW9uCiAgICAgKiAgIG1lY2hhbmlzbSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyBmYXN0ZXIgcHJvcGFnYXRpb24gb2YgcmVzb2x1dGlvbiBvciByZWplY3Rpb24gaW50byB5b3VyCiAgICAgKiAgIG1vZGVscyBhbmQgYXZvaWRpbmcgdW5uZWNlc3NhcnkgYnJvd3NlciByZXBhaW50cywgd2hpY2ggd291bGQgcmVzdWx0IGluIGZsaWNrZXJpbmcgVUkuCiAgICAgKiAtICRxIHByb21pc2VzIGFyZSByZWNvZ25pemVkIGJ5IHRoZSB0ZW1wbGF0aW5nIGVuZ2luZSBpbiBhbmd1bGFyLCB3aGljaCBtZWFucyB0aGF0IGluIHRlbXBsYXRlcwogICAgICogICB5b3UgY2FuIHRyZWF0IHByb21pc2VzIGF0dGFjaGVkIHRvIGEgc2NvcGUgYXMgaWYgdGhleSB3ZXJlIHRoZSByZXN1bHRpbmcgdmFsdWVzLgogICAgICogLSBRIGhhcyBtYW55IG1vcmUgZmVhdHVyZXMgdGhhbiAkcSwgYnV0IHRoYXQgY29tZXMgYXQgYSBjb3N0IG9mIGJ5dGVzLiAkcSBpcyB0aW55LCBidXQgY29udGFpbnMKICAgICAqICAgYWxsIHRoZSBpbXBvcnRhbnQgZnVuY3Rpb25hbGl0eSBuZWVkZWQgZm9yIGNvbW1vbiBhc3luYyB0YXNrcy4KICAgICAqCiAgICAgKiAgIyBUZXN0aW5nCiAgICAgKgogICAgICogIDxwcmU+CiAgICAgKiAgICBpdCgnc2hvdWxkIHNpbXVsYXRlIHByb21pc2UnLCBpbmplY3QoZnVuY3Rpb24oJHEsICRyb290U2NvcGUpIHsKICAgICAqICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTsKICAgICAqICAgICAgdmFyIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlOwogICAgICogICAgICB2YXIgcmVzb2x2ZWRWYWx1ZTsKICAgICAqCiAgICAgKiAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSkgeyByZXNvbHZlZFZhbHVlID0gdmFsdWU7IH0pOwogICAgICogICAgICBleHBlY3QocmVzb2x2ZWRWYWx1ZSkudG9CZVVuZGVmaW5lZCgpOwogICAgICoKICAgICAqICAgICAgLy8gU2ltdWxhdGUgcmVzb2x2aW5nIG9mIHByb21pc2UKICAgICAqICAgICAgZGVmZXJyZWQucmVzb2x2ZSgxMjMpOwogICAgICogICAgICAvLyBOb3RlIHRoYXQgdGhlICd0aGVuJyBmdW5jdGlvbiBkb2VzIG5vdCBnZXQgY2FsbGVkIHN5bmNocm9ub3VzbHkuCiAgICAgKiAgICAgIC8vIFRoaXMgaXMgYmVjYXVzZSB3ZSB3YW50IHRoZSBwcm9taXNlIEFQSSB0byBhbHdheXMgYmUgYXN5bmMsIHdoZXRoZXIgb3Igbm90CiAgICAgKiAgICAgIC8vIGl0IGdvdCBjYWxsZWQgc3luY2hyb25vdXNseSBvciBhc3luY2hyb25vdXNseS4KICAgICAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvQmVVbmRlZmluZWQoKTsKICAgICAqCiAgICAgKiAgICAgIC8vIFByb3BhZ2F0ZSBwcm9taXNlIHJlc29sdXRpb24gdG8gJ3RoZW4nIGZ1bmN0aW9ucyB1c2luZyAkYXBwbHkoKS4KICAgICAqICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvRXF1YWwoMTIzKTsKICAgICAqICAgIH0pOwogICAgICogIDwvcHJlPgogICAgICovCiAgICBmdW5jdGlvbiAkUVByb3ZpZGVyKCkgewoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCBmdW5jdGlvbiAoJHJvb3RTY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHFGYWN0b3J5KGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGNhbGxiYWNrKTsKICAgICAgICAgICAgfSwgJGV4Y2VwdGlvbkhhbmRsZXIpOwogICAgICAgIH1dOwogICAgfQoKCiAgICAvKioKICAgICAqIENvbnN0cnVjdHMgYSBwcm9taXNlIG1hbmFnZXIuCiAgICAgKgogICAgICogQHBhcmFtIHtmdW5jdGlvbihmdW5jdGlvbil9IG5leHRUaWNrIEZ1bmN0aW9uIGZvciBleGVjdXRpbmcgZnVuY3Rpb25zIGluIHRoZSBuZXh0IHR1cm4uCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKC4uLiopfSBleGNlcHRpb25IYW5kbGVyIEZ1bmN0aW9uIGludG8gd2hpY2ggdW5leHBlY3RlZCBleGNlcHRpb25zIGFyZSBwYXNzZWQgZm9yCiAgICAgKiAgICAgZGVidWdnaW5nIHB1cnBvc2VzLgogICAgICogQHJldHVybnMge29iamVjdH0gUHJvbWlzZSBtYW5hZ2VyLgogICAgICovCiAgICBmdW5jdGlvbiBxRmFjdG9yeShuZXh0VGljaywgZXhjZXB0aW9uSGFuZGxlcikgewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MKICAgICAgICAgKiBAbmFtZSBuZy4kcSNkZWZlcgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENyZWF0ZXMgYSBgRGVmZXJyZWRgIG9iamVjdCB3aGljaCByZXByZXNlbnRzIGEgdGFzayB3aGljaCB3aWxsIGZpbmlzaCBpbiB0aGUgZnV0dXJlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0RlZmVycmVkfSBSZXR1cm5zIGEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkLgogICAgICAgICAqLwogICAgICAgIHZhciBkZWZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBbXSwKICAgICAgICAgICAgICAgIHZhbHVlLCBkZWZlcnJlZDsKCiAgICAgICAgICAgIGRlZmVycmVkID0gewoKICAgICAgICAgICAgICAgIHJlc29sdmU6IGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGVuZGluZykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gcGVuZGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgcGVuZGluZyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSByZWYodmFsKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGNhbGxiYWNrcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2tzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS50aGVuKGNhbGxiYWNrWzBdLCBjYWxsYmFja1sxXSwgY2FsbGJhY2tbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgcmVqZWN0OiBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZWplY3QocmVhc29uKSk7CiAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICBub3RpZnk6IGZ1bmN0aW9uIChwcm9ncmVzcykgewogICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBwZW5kaW5nOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmcubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGNhbGxiYWNrcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2tzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja1syXShwcm9ncmVzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICBwcm9taXNlOiB7CiAgICAgICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9ncmVzc2JhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKChpc0Z1bmN0aW9uKGNhbGxiYWNrKSA/IGNhbGxiYWNrIDogZGVmYXVsdENhbGxiYWNrKSh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZWplY3QoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3cmFwcGVkRXJyYmFjayA9IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGlzRnVuY3Rpb24oZXJyYmFjaykgPyBlcnJiYWNrIDogZGVmYXVsdEVycmJhY2spKHJlYXNvbikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZWplY3QoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3cmFwcGVkUHJvZ3Jlc3NiYWNrID0gZnVuY3Rpb24gKHByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5ub3RpZnkoKGlzRnVuY3Rpb24ocHJvZ3Jlc3NiYWNrKSA/IHByb2dyZXNzYmFjayA6IGRlZmF1bHRDYWxsYmFjaykocHJvZ3Jlc3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmcucHVzaChbd3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFjaywgd3JhcHBlZFByb2dyZXNzYmFja10pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUudGhlbih3cmFwcGVkQ2FsbGJhY2ssIHdyYXBwZWRFcnJiYWNrLCB3cmFwcGVkUHJvZ3Jlc3NiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgICJjYXRjaCI6IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50aGVuKG51bGwsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAiZmluYWxseSI6IGZ1bmN0aW9uIChjYWxsYmFjaykgewoKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gbWFrZVByb21pc2UodmFsdWUsIHJlc29sdmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNvbHZlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlamVjdCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNhbGxiYWNrKHZhbHVlLCBpc1Jlc29sdmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tPdXRwdXQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja091dHB1dCA9IChjYWxsYmFjayB8fCBkZWZhdWx0Q2FsbGJhY2spKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VQcm9taXNlKGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja091dHB1dCAmJiBpc0Z1bmN0aW9uKGNhbGxiYWNrT3V0cHV0LnRoZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrT3V0cHV0LnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWFrZVByb21pc2UodmFsdWUsIGlzUmVzb2x2ZWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWFrZVByb21pc2UoZXJyb3IsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VQcm9taXNlKHZhbHVlLCBpc1Jlc29sdmVkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGVDYWxsYmFjayh2YWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUNhbGxiYWNrKGVycm9yLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZDsKICAgICAgICB9OwoKCiAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUgJiYgaXNGdW5jdGlvbih2YWx1ZS50aGVuKSkgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZShjYWxsYmFjayh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjcmVqZWN0CiAgICAgICAgICogQG1ldGhvZE9mIG5nLiRxCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ3JlYXRlcyBhIHByb21pc2UgdGhhdCBpcyByZXNvbHZlZCBhcyByZWplY3RlZCB3aXRoIHRoZSBzcGVjaWZpZWQgYHJlYXNvbmAuIFRoaXMgYXBpIHNob3VsZCBiZQogICAgICAgICAqIHVzZWQgdG8gZm9yd2FyZCByZWplY3Rpb24gaW4gYSBjaGFpbiBvZiBwcm9taXNlcy4gSWYgeW91IGFyZSBkZWFsaW5nIHdpdGggdGhlIGxhc3QgcHJvbWlzZSBpbgogICAgICAgICAqIGEgcHJvbWlzZSBjaGFpbiwgeW91IGRvbid0IG5lZWQgdG8gd29ycnkgYWJvdXQgaXQuCiAgICAgICAgICoKICAgICAgICAgKiBXaGVuIGNvbXBhcmluZyBkZWZlcnJlZHMvcHJvbWlzZXMgdG8gdGhlIGZhbWlsaWFyIGJlaGF2aW9yIG9mIHRyeS9jYXRjaC90aHJvdywgdGhpbmsgb2YKICAgICAgICAgKiBgcmVqZWN0YCBhcyB0aGUgYHRocm93YCBrZXl3b3JkIGluIEphdmFTY3JpcHQuIFRoaXMgYWxzbyBtZWFucyB0aGF0IGlmIHlvdSAiY2F0Y2giIGFuIGVycm9yIHZpYQogICAgICAgICAqIGEgcHJvbWlzZSBlcnJvciBjYWxsYmFjayBhbmQgeW91IHdhbnQgdG8gZm9yd2FyZCB0aGUgZXJyb3IgdG8gdGhlIHByb21pc2UgZGVyaXZlZCBmcm9tIHRoZQogICAgICAgICAqIGN1cnJlbnQgcHJvbWlzZSwgeW91IGhhdmUgdG8gInJldGhyb3ciIHRoZSBlcnJvciBieSByZXR1cm5pbmcgYSByZWplY3Rpb24gY29uc3RydWN0ZWQgdmlhCiAgICAgICAgICogYHJlamVjdGAuCiAgICAgICAgICoKICAgICAgICAgKiA8cHJlPgogICAgICAgICAqICAgcHJvbWlzZUIgPSBwcm9taXNlQS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAqICAgICAvLyBzdWNjZXNzOiBkbyBzb21ldGhpbmcgYW5kIHJlc29sdmUgcHJvbWlzZUIKICAgICAgICAgKiAgICAgLy8gICAgICAgICAgd2l0aCB0aGUgb2xkIG9yIGEgbmV3IHJlc3VsdAogICAgICAgICAqICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAqICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICogICAgIC8vIGVycm9yOiBoYW5kbGUgdGhlIGVycm9yIGlmIHBvc3NpYmxlIGFuZAogICAgICAgICAqICAgICAvLyAgICAgICAgcmVzb2x2ZSBwcm9taXNlQiB3aXRoIG5ld1Byb21pc2VPclZhbHVlLAogICAgICAgICAqICAgICAvLyAgICAgICAgb3RoZXJ3aXNlIGZvcndhcmQgdGhlIHJlamVjdGlvbiB0byBwcm9taXNlQgogICAgICAgICAqICAgICBpZiAoY2FuSGFuZGxlKHJlYXNvbikpIHsKICAgICAgICAgKiAgICAgIC8vIGhhbmRsZSB0aGUgZXJyb3IgYW5kIHJlY292ZXIKICAgICAgICAgKiAgICAgIHJldHVybiBuZXdQcm9taXNlT3JWYWx1ZTsKICAgICAgICAgKiAgICAgfQogICAgICAgICAqICAgICByZXR1cm4gJHEucmVqZWN0KHJlYXNvbik7CiAgICAgICAgICogICB9KTsKICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7Kn0gcmVhc29uIENvbnN0YW50LCBtZXNzYWdlLCBleGNlcHRpb24gb3IgYW4gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcmVqZWN0aW9uIHJlYXNvbi4KICAgICAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHByb21pc2UgdGhhdCB3YXMgYWxyZWFkeSByZXNvbHZlZCBhcyByZWplY3RlZCB3aXRoIHRoZSBgcmVhc29uYC4KICAgICAgICAgKi8KICAgICAgICB2YXIgcmVqZWN0ID0gZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24gKGNhbGxiYWNrLCBlcnJiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGlzRnVuY3Rpb24oZXJyYmFjaykgPyBlcnJiYWNrIDogZGVmYXVsdEVycmJhY2spKHJlYXNvbikpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jCiAgICAgICAgICogQG5hbWUgbmcuJHEjd2hlbgogICAgICAgICAqIEBtZXRob2RPZiBuZy4kcQogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFdyYXBzIGFuIG9iamVjdCB0aGF0IG1pZ2h0IGJlIGEgdmFsdWUgb3IgYSAoM3JkIHBhcnR5KSB0aGVuLWFibGUgcHJvbWlzZSBpbnRvIGEgJHEgcHJvbWlzZS4KICAgICAgICAgKiBUaGlzIGlzIHVzZWZ1bCB3aGVuIHlvdSBhcmUgZGVhbGluZyB3aXRoIGFuIG9iamVjdCB0aGF0IG1pZ2h0IG9yIG1pZ2h0IG5vdCBiZSBhIHByb21pc2UsIG9yIGlmCiAgICAgICAgICogdGhlIHByb21pc2UgY29tZXMgZnJvbSBhIHNvdXJjZSB0aGF0IGNhbid0IGJlIHRydXN0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFZhbHVlIG9yIGEgcHJvbWlzZQogICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgcHJvbWlzZSBvZiB0aGUgcGFzc2VkIHZhbHVlIG9yIHByb21pc2UKICAgICAgICAgKi8KICAgICAgICB2YXIgd2hlbiA9IGZ1bmN0aW9uICh2YWx1ZSwgY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzYmFjaykgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKSwKICAgICAgICAgICAgICAgIGRvbmU7CgogICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoaXNGdW5jdGlvbihjYWxsYmFjaykgPyBjYWxsYmFjayA6IGRlZmF1bHRDYWxsYmFjaykodmFsdWUpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciB3cmFwcGVkRXJyYmFjayA9IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChpc0Z1bmN0aW9uKGVycmJhY2spID8gZXJyYmFjayA6IGRlZmF1bHRFcnJiYWNrKShyZWFzb24pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciB3cmFwcGVkUHJvZ3Jlc3NiYWNrID0gZnVuY3Rpb24gKHByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoaXNGdW5jdGlvbihwcm9ncmVzc2JhY2spID8gcHJvZ3Jlc3NiYWNrIDogZGVmYXVsdENhbGxiYWNrKShwcm9ncmVzcyk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJlZih2YWx1ZSkudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKHJlZih2YWx1ZSkudGhlbih3cmFwcGVkQ2FsbGJhY2ssIHdyYXBwZWRFcnJiYWNrLCB3cmFwcGVkUHJvZ3Jlc3NiYWNrKSk7CiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbmUpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSh3cmFwcGVkRXJyYmFjayhyZWFzb24pKTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChwcm9ncmVzcykgewogICAgICAgICAgICAgICAgICAgIGlmIChkb25lKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lm5vdGlmeSh3cmFwcGVkUHJvZ3Jlc3NiYWNrKHByb2dyZXNzKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgfTsKCgogICAgICAgIGZ1bmN0aW9uIGRlZmF1bHRDYWxsYmFjayh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQoKCiAgICAgICAgZnVuY3Rpb24gZGVmYXVsdEVycmJhY2socmVhc29uKSB7CiAgICAgICAgICAgIHJldHVybiByZWplY3QocmVhc29uKTsKICAgICAgICB9CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MKICAgICAgICAgKiBAbmFtZSBuZy4kcSNhbGwKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHEKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDb21iaW5lcyBtdWx0aXBsZSBwcm9taXNlcyBpbnRvIGEgc2luZ2xlIHByb21pc2UgdGhhdCBpcyByZXNvbHZlZCB3aGVuIGFsbCBvZiB0aGUgaW5wdXQKICAgICAgICAgKiBwcm9taXNlcyBhcmUgcmVzb2x2ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0FycmF5LjxQcm9taXNlPnxPYmplY3QuPFByb21pc2U+fSBwcm9taXNlcyBBbiBhcnJheSBvciBoYXNoIG9mIHByb21pc2VzLgogICAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgc2luZ2xlIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdpdGggYW4gYXJyYXkvaGFzaCBvZiB2YWx1ZXMsCiAgICAgICAgICogICBlYWNoIHZhbHVlIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHByb21pc2UgYXQgdGhlIHNhbWUgaW5kZXgva2V5IGluIHRoZSBgcHJvbWlzZXNgIGFycmF5L2hhc2guIElmIGFueSBvZgogICAgICAgICAqICAgdGhlIHByb21pc2VzIGlzIHJlc29sdmVkIHdpdGggYSByZWplY3Rpb24sIHRoaXMgcmVzdWx0aW5nIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aXRoIHRoZQogICAgICAgICAqICAgc2FtZSByZWplY3Rpb24uCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gYWxsKHByb21pc2VzKSB7CiAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9IGRlZmVyKCksCiAgICAgICAgICAgICAgICBjb3VudGVyID0gMCwKICAgICAgICAgICAgICAgIHJlc3VsdHMgPSBpc0FycmF5KHByb21pc2VzKSA/IFtdIDoge307CgogICAgICAgICAgICBmb3JFYWNoKHByb21pc2VzLCBmdW5jdGlvbiAocHJvbWlzZSwga2V5KSB7CiAgICAgICAgICAgICAgICBjb3VudGVyKys7CiAgICAgICAgICAgICAgICByZWYocHJvbWlzZSkudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1trZXldID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEoLS1jb3VudGVyKSkgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KHJlYXNvbik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoY291bnRlciA9PT0gMCkgewogICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXN1bHRzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBkZWZlcjogZGVmZXIsCiAgICAgICAgICAgIHJlamVjdDogcmVqZWN0LAogICAgICAgICAgICB3aGVuOiB3aGVuLAogICAgICAgICAgICBhbGw6IGFsbAogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBERVNJR04gTk9URVMKICAgICAqCiAgICAgKiBUaGUgZGVzaWduIGRlY2lzaW9ucyBiZWhpbmQgdGhlIHNjb3BlIGFyZSBoZWF2aWx5IGZhdm9yZWQgZm9yIHNwZWVkIGFuZCBtZW1vcnkgY29uc3VtcHRpb24uCiAgICAgKgogICAgICogVGhlIHR5cGljYWwgdXNlIG9mIHNjb3BlIGlzIHRvIHdhdGNoIHRoZSBleHByZXNzaW9ucywgd2hpY2ggbW9zdCBvZiB0aGUgdGltZSByZXR1cm4gdGhlIHNhbWUKICAgICAqIHZhbHVlIGFzIGxhc3QgdGltZSBzbyB3ZSBvcHRpbWl6ZSB0aGUgb3BlcmF0aW9uLgogICAgICoKICAgICAqIENsb3N1cmVzIGNvbnN0cnVjdGlvbiBpcyBleHBlbnNpdmUgaW4gdGVybXMgb2Ygc3BlZWQgYXMgd2VsbCBhcyBtZW1vcnk6CiAgICAgKiAgIC0gTm8gY2xvc3VyZXMsIGluc3RlYWQgdXNlIHByb3RvdHlwaWNhbCBpbmhlcml0YW5jZSBmb3IgQVBJCiAgICAgKiAgIC0gSW50ZXJuYWwgc3RhdGUgbmVlZHMgdG8gYmUgc3RvcmVkIG9uIHNjb3BlIGRpcmVjdGx5LCB3aGljaCBtZWFucyB0aGF0IHByaXZhdGUgc3RhdGUgaXMKICAgICAqICAgICBleHBvc2VkIGFzICQkX19fXyBwcm9wZXJ0aWVzCiAgICAgKgogICAgICogTG9vcCBvcGVyYXRpb25zIGFyZSBvcHRpbWl6ZWQgYnkgdXNpbmcgd2hpbGUoY291bnQtLSkgeyAuLi4gfQogICAgICogICAtIHRoaXMgbWVhbnMgdGhhdCBpbiBvcmRlciB0byBrZWVwIHRoZSBzYW1lIG9yZGVyIG9mIGV4ZWN1dGlvbiBhcyBhZGRpdGlvbiB3ZSBoYXZlIHRvIGFkZAogICAgICogICAgIGl0ZW1zIHRvIHRoZSBhcnJheSBhdCB0aGUgYmVnaW5uaW5nIChzaGlmdCkgaW5zdGVhZCBvZiBhdCB0aGUgZW5kIChwdXNoKQogICAgICoKICAgICAqIENoaWxkIHNjb3BlcyBhcmUgY3JlYXRlZCBhbmQgcmVtb3ZlZCBvZnRlbgogICAgICogICAtIFVzaW5nIGFuIGFycmF5IHdvdWxkIGJlIHNsb3cgc2luY2UgaW5zZXJ0cyBpbiBtaWRkbGUgYXJlIGV4cGVuc2l2ZSBzbyB3ZSB1c2UgbGlua2VkIGxpc3QKICAgICAqCiAgICAgKiBUaGVyZSBhcmUgZmV3IHdhdGNoZXMgdGhlbiBhIGxvdCBvZiBvYnNlcnZlcnMuIFRoaXMgaXMgd2h5IHlvdSBkb24ndCB3YW50IHRoZSBvYnNlcnZlciB0byBiZQogICAgICogaW1wbGVtZW50ZWQgaW4gdGhlIHNhbWUgd2F5IGFzIHdhdGNoLiBXYXRjaCByZXF1aXJlcyByZXR1cm4gb2YgaW5pdGlhbGl6YXRpb24gZnVuY3Rpb24gd2hpY2gKICAgICAqIGFyZSBleHBlbnNpdmUgdG8gY29uc3RydWN0LgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuJHJvb3RTY29wZVByb3ZpZGVyCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBQcm92aWRlciBmb3IgdGhlICRyb290U2NvcGUgc2VydmljZS4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlUHJvdmlkZXIjZGlnZXN0VHRsCiAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZVByb3ZpZGVyCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBTZXRzIHRoZSBudW1iZXIgb2YgZGlnZXN0IGl0ZXJhdGlvbnMgdGhlIHNjb3BlIHNob3VsZCBhdHRlbXB0IHRvIGV4ZWN1dGUgYmVmb3JlIGdpdmluZyB1cCBhbmQKICAgICAqIGFzc3VtaW5nIHRoYXQgdGhlIG1vZGVsIGlzIHVuc3RhYmxlLgogICAgICoKICAgICAqIFRoZSBjdXJyZW50IGRlZmF1bHQgaXMgMTAgaXRlcmF0aW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbGltaXQgVGhlIG51bWJlciBvZiBkaWdlc3QgaXRlcmF0aW9ucy4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIEV2ZXJ5IGFwcGxpY2F0aW9uIGhhcyBhIHNpbmdsZSByb290IHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfS4KICAgICAqIEFsbCBvdGhlciBzY29wZXMgYXJlIGNoaWxkIHNjb3BlcyBvZiB0aGUgcm9vdCBzY29wZS4gU2NvcGVzIHByb3ZpZGUgbWVjaGFuaXNtIGZvciB3YXRjaGluZyB0aGUgbW9kZWwgYW5kIHByb3ZpZGUKICAgICAqIGV2ZW50IHByb2Nlc3NpbmcgbGlmZS1jeWNsZS4gU2VlIHtAbGluayBndWlkZS9zY29wZSBkZXZlbG9wZXIgZ3VpZGUgb24gc2NvcGVzfS4KICAgICAqLwogICAgZnVuY3Rpb24gJFJvb3RTY29wZVByb3ZpZGVyKCkgewogICAgICAgIHZhciBUVEwgPSAxMDsKICAgICAgICB2YXIgJHJvb3RTY29wZU1pbkVyciA9IG1pbkVycignJHJvb3RTY29wZScpOwoKICAgICAgICB0aGlzLmRpZ2VzdFR0bCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgVFRMID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFRUTDsKICAgICAgICB9OwoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsICckZXhjZXB0aW9uSGFuZGxlcicsICckcGFyc2UnLCAnJGJyb3dzZXInLAogICAgICAgICAgICBmdW5jdGlvbiAoJGluamVjdG9yLCAkZXhjZXB0aW9uSGFuZGxlciwgJHBhcnNlLCAkYnJvd3NlcikgewoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgKiBBIHJvb3Qgc2NvcGUgY2FuIGJlIHJldHJpZXZlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUgJHJvb3RTY29wZX0ga2V5IGZyb20gdGhlCiAgICAgICAgICAgICAgICAgKiB7QGxpbmsgQVVUTy4kaW5qZWN0b3IgJGluamVjdG9yfS4gQ2hpbGQgc2NvcGVzIGFyZSBjcmVhdGVkIHVzaW5nIHRoZQogICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG5ldyAkbmV3KCl9IG1ldGhvZC4gKE1vc3Qgc2NvcGVzIGFyZSBjcmVhdGVkIGF1dG9tYXRpY2FsbHkgd2hlbgogICAgICAgICAgICAgICAgICogY29tcGlsZWQgSFRNTCB0ZW1wbGF0ZSBpcyBleGVjdXRlZC4pCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogSGVyZSBpcyBhIHNpbXBsZSBzY29wZSBzbmlwcGV0IHRvIHNob3cgaG93IHlvdSBjYW4gaW50ZXJhY3Qgd2l0aCB0aGUgc2NvcGUuCiAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICogPGZpbGUgc3JjPSIuL3Rlc3Qvbmcvcm9vdFNjb3BlU3BlYy5qcyIgdGFnPSJkb2NzMSIgLz4KICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqICMgSW5oZXJpdGFuY2UKICAgICAgICAgICAgICAgICAqIEEgc2NvcGUgY2FuIGluaGVyaXQgZnJvbSBhIHBhcmVudCBzY29wZSwgYXMgaW4gdGhpcyBleGFtcGxlOgogICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9ICRyb290U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudC4kbmV3KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICBwYXJlbnQuc2FsdXRhdGlvbiA9ICJIZWxsbyI7CiAgICAgICAgICAgICAgICAgICAgIGNoaWxkLm5hbWUgPSAiV29ybGQiOwogICAgICAgICAgICAgICAgICAgICBleHBlY3QoY2hpbGQuc2FsdXRhdGlvbikudG9FcXVhbCgnSGVsbG8nKTsKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIGNoaWxkLnNhbHV0YXRpb24gPSAiV2VsY29tZSI7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChjaGlsZC5zYWx1dGF0aW9uKS50b0VxdWFsKCdXZWxjb21lJyk7CiAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChwYXJlbnQuc2FsdXRhdGlvbikudG9FcXVhbCgnSGVsbG8nKTsKICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCBmdW5jdGlvbigpPj19IHByb3ZpZGVycyBNYXAgb2Ygc2VydmljZSBmYWN0b3J5IHdoaWNoIG5lZWQgdG8gYmUgcHJvdmlkZWQKICAgICAgICAgICAgICAgICAqICAgICBmb3IgdGhlIGN1cnJlbnQgc2NvcGUuIERlZmF1bHRzIHRvIHtAbGluayBuZ30uCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCAqPj19IGluc3RhbmNlQ2FjaGUgUHJvdmlkZXMgcHJlLWluc3RhbnRpYXRlZCBzZXJ2aWNlcyB3aGljaCBzaG91bGQKICAgICAgICAgICAgICAgICAqICAgICBhcHBlbmQvb3ZlcnJpZGUgc2VydmljZXMgcHJvdmlkZWQgYnkgYHByb3ZpZGVyc2AuIFRoaXMgaXMgaGFuZHkgd2hlbiB1bml0LXRlc3RpbmcgYW5kIGhhdmluZwogICAgICAgICAgICAgICAgICogICAgIHRoZSBuZWVkIHRvIG92ZXJyaWRlIGEgZGVmYXVsdCBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICogQHJldHVybnMge09iamVjdH0gTmV3bHkgY3JlYXRlZCBzY29wZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIFNjb3BlKCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGlkID0gbmV4dFVpZCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRwaGFzZSA9IHRoaXMuJHBhcmVudCA9IHRoaXMuJCR3YXRjaGVycyA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRIZWFkID0gdGhpcy4kJGNoaWxkVGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgdGhpc1sndGhpcyddID0gdGhpcy4kcm9vdCA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGRlc3Ryb3llZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRhc3luY1F1ZXVlID0gW107CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kJHBvc3REaWdlc3RRdWV1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRsaXN0ZW5lcnMgPSB7fTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiQkaXNvbGF0ZUJpbmRpbmdzID0ge307CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGlkCiAgICAgICAgICAgICAgICAgKiBAcHJvcGVydHlPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBVbmlxdWUgc2NvcGUgSUQgKG1vbm90b25pY2FsbHkgaW5jcmVhc2luZyBhbHBoYW51bWVyaWMgc2VxdWVuY2UpIHVzZWZ1bCBmb3IKICAgICAgICAgICAgICAgICAqICAgZGVidWdnaW5nLgogICAgICAgICAgICAgICAgICovCgoKICAgICAgICAgICAgICAgIFNjb3BlLnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgICAgICAgICBjb25zdHJ1Y3RvcjogU2NvcGUsCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkbmV3CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgY2hpbGQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIHBhcmVudCBzY29wZSB3aWxsIHByb3BhZ2F0ZSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZAogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBldmVudHMuIFRoZSBzY29wZSBjYW4gYmUgcmVtb3ZlZCBmcm9tIHRoZSBzY29wZQogICAgICAgICAgICAgICAgICAgICAqIGhpZXJhcmNoeSB1c2luZyB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveSAkZGVzdHJveSgpfS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9IG11c3QgYmUgY2FsbGVkIG9uIGEgc2NvcGUgd2hlbiBpdCBpcyBkZXNpcmVkIGZvcgogICAgICAgICAgICAgICAgICAgICAqIHRoZSBzY29wZSBhbmQgaXRzIGNoaWxkIHNjb3BlcyB0byBiZSBwZXJtYW5lbnRseSBkZXRhY2hlZCBmcm9tIHRoZSBwYXJlbnQgYW5kIHRodXMgc3RvcAogICAgICAgICAgICAgICAgICAgICAqIHBhcnRpY2lwYXRpbmcgaW4gbW9kZWwgY2hhbmdlIGRldGVjdGlvbiBhbmQgbGlzdGVuZXIgbm90aWZpY2F0aW9uIGJ5IGludm9raW5nLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFufSBpc29sYXRlIGlmIHRydWUgdGhlbiB0aGUgc2NvcGUgZG9lcyBub3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdCBmcm9tIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgcGFyZW50IHNjb3BlLiBUaGUgc2NvcGUgaXMgaXNvbGF0ZWQsIGFzIGl0IGNhbiBub3Qgc2VlIHBhcmVudCBzY29wZSBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgICAgICAqICAgICAgICAgV2hlbiBjcmVhdGluZyB3aWRnZXRzIGl0IGlzIHVzZWZ1bCBmb3IgdGhlIHdpZGdldCB0byBub3QgYWNjaWRlbnRhbGx5IHJlYWQgcGFyZW50CiAgICAgICAgICAgICAgICAgICAgICogICAgICAgICBzdGF0ZS4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBuZXdseSBjcmVhdGVkIGNoaWxkIHNjb3BlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG5ldzogZnVuY3Rpb24gKGlzb2xhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIENoaWxkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNvbGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBuZXcgU2NvcGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiRyb290ID0gdGhpcy4kcm9vdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVuc3VyZSB0aGF0IHRoZXJlIGlzIGp1c3Qgb25lIGFzeW5jIHF1ZXVlIHBlciAkcm9vdFNjb3BlIGFuZCBpdCdzIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kJGFzeW5jUXVldWUgPSB0aGlzLiQkYXN5bmNRdWV1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLiQkcG9zdERpZ2VzdFF1ZXVlID0gdGhpcy4kJHBvc3REaWdlc3RRdWV1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIENoaWxkID0gZnVuY3Rpb24gKCkgeyB9OyAvLyBzaG91bGQgYmUgYW5vbnltb3VzOyBUaGlzIGlzIHNvIHRoYXQgd2hlbiB0aGUgbWluaWZpZXIgbXVuZ2VzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgbmFtZSBpdCBkb2VzIG5vdCBiZWNvbWUgcmFuZG9tIHNldCBvZiBjaGFycy4gVGhlc2Ugd2lsbCB0aGVuIHNob3cgdXAgYXMgY2xhc3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5hbWUgaW4gdGhlIGRlYnVnZ2VyLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2hpbGQucHJvdG90eXBlID0gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkID0gbmV3IENoaWxkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kaWQgPSBuZXh0VWlkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRbJ3RoaXMnXSA9IGNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kJGxpc3RlbmVycyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC4kcGFyZW50ID0gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCR3YXRjaGVycyA9IGNoaWxkLiQkbmV4dFNpYmxpbmcgPSBjaGlsZC4kJGNoaWxkSGVhZCA9IGNoaWxkLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuJCRwcmV2U2libGluZyA9IHRoaXMuJCRjaGlsZFRhaWw7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiQkY2hpbGRIZWFkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRUYWlsLiQkbmV4dFNpYmxpbmcgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoCiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIFJlZ2lzdGVycyBhIGBsaXN0ZW5lcmAgY2FsbGJhY2sgdG8gYmUgZXhlY3V0ZWQgd2hlbmV2ZXIgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGNoYW5nZXMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSBgd2F0Y2hFeHByZXNzaW9uYCBpcyBjYWxsZWQgb24gZXZlcnkgY2FsbCB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gYW5kCiAgICAgICAgICAgICAgICAgICAgICogICBzaG91bGQgcmV0dXJuIHRoZSB2YWx1ZSB3aGljaCB3aWxsIGJlIHdhdGNoZWQuIChTaW5jZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0KICAgICAgICAgICAgICAgICAgICAgKiAgIHJlcnVucyB3aGVuIGl0IGRldGVjdHMgY2hhbmdlcyB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2FuIGV4ZWN1dGUgbXVsdGlwbGUgdGltZXMgcGVyCiAgICAgICAgICAgICAgICAgICAgICogICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gYW5kIHNob3VsZCBiZSBpZGVtcG90ZW50LikKICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCBvbmx5IHdoZW4gdGhlIHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgYHdhdGNoRXhwcmVzc2lvbmAgYW5kIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAgcHJldmlvdXMgY2FsbCB0byBgd2F0Y2hFeHByZXNzaW9uYCBhcmUgbm90IGVxdWFsICh3aXRoIHRoZSBleGNlcHRpb24gb2YgdGhlIGluaXRpYWwgcnVuLAogICAgICAgICAgICAgICAgICAgICAqICAgc2VlIGJlbG93KS4gVGhlIGluZXF1YWxpdHkgaXMgZGV0ZXJtaW5lZCBhY2NvcmRpbmcgdG8KICAgICAgICAgICAgICAgICAgICAgKiAgIHtAbGluayBhbmd1bGFyLmVxdWFsc30gZnVuY3Rpb24uIFRvIHNhdmUgdGhlIHZhbHVlIG9mIHRoZSBvYmplY3QgZm9yIGxhdGVyIGNvbXBhcmlzb24sIHRoZQogICAgICAgICAgICAgICAgICAgICAqICAge0BsaW5rIGFuZ3VsYXIuY29weX0gZnVuY3Rpb24gaXMgdXNlZC4gSXQgYWxzbyBtZWFucyB0aGF0IHdhdGNoaW5nIGNvbXBsZXggb3B0aW9ucyB3aWxsCiAgICAgICAgICAgICAgICAgICAgICogICBoYXZlIGFkdmVyc2UgbWVtb3J5IGFuZCBwZXJmb3JtYW5jZSBpbXBsaWNhdGlvbnMuCiAgICAgICAgICAgICAgICAgICAgICogLSBUaGUgd2F0Y2ggYGxpc3RlbmVyYCBtYXkgY2hhbmdlIHRoZSBtb2RlbCwgd2hpY2ggbWF5IHRyaWdnZXIgb3RoZXIgYGxpc3RlbmVyYHMgdG8gZmlyZS4gVGhpcwogICAgICAgICAgICAgICAgICAgICAqICAgaXMgYWNoaWV2ZWQgYnkgcmVydW5uaW5nIHRoZSB3YXRjaGVycyB1bnRpbCBubyBjaGFuZ2VzIGFyZSBkZXRlY3RlZC4gVGhlIHJlcnVuIGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAqICAgbGltaXQgaXMgMTAgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wIGRlYWRsb2NrLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBJZiB5b3Ugd2FudCB0byBiZSBub3RpZmllZCB3aGVuZXZlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGlzIGNhbGxlZCwKICAgICAgICAgICAgICAgICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gd2l0aCBubyBgbGlzdGVuZXJgLiAoU2luY2UgYHdhdGNoRXhwcmVzc2lvbmAKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gZXhlY3V0ZSBtdWx0aXBsZSB0aW1lcyBwZXIge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBjeWNsZSB3aGVuIGEgY2hhbmdlIGlzCiAgICAgICAgICAgICAgICAgICAgICogZGV0ZWN0ZWQsIGJlIHByZXBhcmVkIGZvciBtdWx0aXBsZSBjYWxscyB0byB5b3VyIGxpc3RlbmVyLikKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEFmdGVyIGEgd2F0Y2hlciBpcyByZWdpc3RlcmVkIHdpdGggdGhlIHNjb3BlLCB0aGUgYGxpc3RlbmVyYCBmbiBpcyBjYWxsZWQgYXN5bmNocm9ub3VzbHkKICAgICAgICAgICAgICAgICAgICAgKiAodmlhIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMgJGV2YWxBc3luY30pIHRvIGluaXRpYWxpemUgdGhlCiAgICAgICAgICAgICAgICAgICAgICogd2F0Y2hlci4gSW4gcmFyZSBjYXNlcywgdGhpcyBpcyB1bmRlc2lyYWJsZSBiZWNhdXNlIHRoZSBsaXN0ZW5lciBpcyBjYWxsZWQgd2hlbiB0aGUgcmVzdWx0CiAgICAgICAgICAgICAgICAgICAgICogb2YgYHdhdGNoRXhwcmVzc2lvbmAgZGlkbid0IGNoYW5nZS4gVG8gZGV0ZWN0IHRoaXMgc2NlbmFyaW8gd2l0aGluIHRoZSBgbGlzdGVuZXJgIGZuLCB5b3UKICAgICAgICAgICAgICAgICAgICAgKiBjYW4gY29tcGFyZSB0aGUgYG5ld1ZhbGAgYW5kIGBvbGRWYWxgLiBJZiB0aGVzZSB0d28gdmFsdWVzIGFyZSBpZGVudGljYWwgKGA9PT1gKSB0aGVuIHRoZQogICAgICAgICAgICAgICAgICAgICAqIGxpc3RlbmVyIHdhcyBjYWxsZWQgZHVlIHRvIGluaXRpYWxpemF0aW9uLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAjIEV4YW1wbGUKICAgICAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGV0J3MgYXNzdW1lIHRoYXQgc2NvcGUgd2FzIGRlcGVuZGVuY3kgaW5qZWN0ZWQgYXMgdGhlICRyb290U2NvcGUKICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY29wZSA9ICRyb290U2NvcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSAwOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goJ25hbWUnLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsgc2NvcGUuY291bnRlciA9IHNjb3BlLmNvdW50ZXIgKyAxOyB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm8gdmFyaWFibGUgY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLm5hbWUgPSAnYWRhbSc7CiAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKICAgICAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfHN0cmluZyl9IHdhdGNoRXhwcmVzc2lvbiBFeHByZXNzaW9uIHRoYXQgaXMgZXZhbHVhdGVkIG9uIGVhY2gKICAgICAgICAgICAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlLiBBIGNoYW5nZSBpbiB0aGUgcmV0dXJuIHZhbHVlIHRyaWdnZXJzIGEKICAgICAgICAgICAgICAgICAgICAgKiAgICBjYWxsIHRvIHRoZSBgbGlzdGVuZXJgLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgc3RyaW5nYDogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259CiAgICAgICAgICAgICAgICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogY2FsbGVkIHdpdGggY3VycmVudCBgc2NvcGVgIGFzIGEgcGFyYW1ldGVyLgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9uKCl8c3RyaW5nKT19IGxpc3RlbmVyIENhbGxiYWNrIGNhbGxlZCB3aGVuZXZlciB0aGUgcmV0dXJuIHZhbHVlIG9mCiAgICAgICAgICAgICAgICAgICAgICogICB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2hhbmdlcy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IEV2YWx1YXRlZCBhcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufQogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSwgc2NvcGUpYDogY2FsbGVkIHdpdGggY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWVzIGFzIHBhcmFtZXRlcnMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvYmplY3RFcXVhbGl0eSBDb21wYXJlIG9iamVjdCBmb3IgZXF1YWxpdHkgcmF0aGVyIHRoYW4gZm9yIHJlZmVyZW5jZS4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGZvciB0aGlzIGxpc3RlbmVyLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICR3YXRjaDogZnVuY3Rpb24gKHdhdGNoRXhwLCBsaXN0ZW5lciwgb2JqZWN0RXF1YWxpdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldCA9IGNvbXBpbGVUb0ZuKHdhdGNoRXhwLCAnd2F0Y2gnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoZXIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm46IGxpc3RlbmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3Q6IGluaXRXYXRjaFZhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXQ6IGdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHA6IHdhdGNoRXhwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVxOiAhIW9iamVjdEVxdWFsaXR5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW4gdGhlIGNhc2UgdXNlciBwYXNzIHN0cmluZywgd2UgbmVlZCB0byBjb21waWxlIGl0LCBkbyB3ZSByZWFsbHkgbmVlZCB0aGlzID8KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxpc3RlbkZuID0gY29tcGlsZVRvRm4obGlzdGVuZXIgfHwgbm9vcCwgJ2xpc3RlbmVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaGVyLmZuID0gZnVuY3Rpb24gKG5ld1ZhbCwgb2xkVmFsLCBzY29wZSkgeyBsaXN0ZW5GbihzY29wZSk7IH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygd2F0Y2hFeHAgPT0gJ3N0cmluZycgJiYgZ2V0LmNvbnN0YW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxGbiA9IHdhdGNoZXIuZm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaGVyLmZuID0gZnVuY3Rpb24gKG5ld1ZhbCwgb2xkVmFsLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsRm4uY2FsbCh0aGlzLCBuZXdWYWwsIG9sZFZhbCwgc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKGFycmF5LCB3YXRjaGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIHVzZSB1bnNoaWZ0IHNpbmNlIHdlIHVzZSBhIHdoaWxlIGxvb3AgaW4gJGRpZ2VzdCBmb3Igc3BlZWQuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSB3aGlsZSBsb29wIHJlYWRzIGluIHJldmVyc2Ugb3JkZXIuCiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5LnVuc2hpZnQod2F0Y2hlcik7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUoYXJyYXksIHdhdGNoZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0sCgoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaENvbGxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogU2hhbGxvdyB3YXRjaGVzIHRoZSBwcm9wZXJ0aWVzIG9mIGFuIG9iamVjdCBhbmQgZmlyZXMgd2hlbmV2ZXIgYW55IG9mIHRoZSBwcm9wZXJ0aWVzIGNoYW5nZQogICAgICAgICAgICAgICAgICAgICAqIChmb3IgYXJyYXlzIHRoaXMgaW1wbGllcyB3YXRjaGluZyB0aGUgYXJyYXkgaXRlbXMsIGZvciBvYmplY3QgbWFwcyB0aGlzIGltcGxpZXMgd2F0Y2hpbmcgdGhlIHByb3BlcnRpZXMpLgogICAgICAgICAgICAgICAgICAgICAqIElmIGEgY2hhbmdlIGlzIGRldGVjdGVkIHRoZSBgbGlzdGVuZXJgIGNhbGxiYWNrIGlzIGZpcmVkLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogLSBUaGUgYG9iamAgY29sbGVjdGlvbiBpcyBvYnNlcnZlZCB2aWEgc3RhbmRhcmQgJHdhdGNoIG9wZXJhdGlvbiBhbmQgaXMgZXhhbWluZWQgb24gZXZlcnkgY2FsbCB0byAkZGlnZXN0KCkgdG8KICAgICAgICAgICAgICAgICAgICAgKiAgIHNlZSBpZiBhbnkgaXRlbXMgaGF2ZSBiZWVuIGFkZGVkLCByZW1vdmVkLCBvciBtb3ZlZC4KICAgICAgICAgICAgICAgICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCB3aGVuZXZlciBhbnl0aGluZyB3aXRoaW4gdGhlIGBvYmpgIGhhcyBjaGFuZ2VkLiBFeGFtcGxlcyBpbmNsdWRlIGFkZGluZyBuZXcgaXRlbXMKICAgICAgICAgICAgICAgICAgICAgKiAgIGludG8gdGhlIG9iamVjdCBvciBhcnJheSwgcmVtb3ZpbmcgYW5kIG1vdmluZyBpdGVtcyBhcm91bmQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgRXhhbXBsZQogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5uYW1lcyA9IFsnaWdvcicsICdtYXRpYXMnLCAnbWlza28nLCAnamFtZXMnXTsKICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmRhdGFDb3VudCA9IDQ7CiAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS4kd2F0Y2hDb2xsZWN0aW9uKCduYW1lcycsIGZ1bmN0aW9uKG5ld05hbWVzLCBvbGROYW1lcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5kYXRhQ291bnQgPSBuZXdOYW1lcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBleHBlY3QoJHNjb3BlLmRhdGFDb3VudCkudG9FcXVhbCg0KTsKICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgLy9zdGlsbCBhdCA0IC4uLiBubyBjaGFuZ2VzCiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdCgkc2NvcGUuZGF0YUNvdW50KS50b0VxdWFsKDQpOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUubmFtZXMucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vbm93IHRoZXJlJ3MgYmVlbiBhIGNoYW5nZQogICAgICAgICAgICAgICAgICAgICAgICBleHBlY3QoJHNjb3BlLmRhdGFDb3VudCkudG9FcXVhbCgzKTsKICAgICAgICAgICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8RnVuY3Rpb24oc2NvcGUpfSBvYmogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LiBUaGUgZXhwcmVzc2lvbiB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAqICAgIHNob3VsZCBldmFsdWF0ZSB0byBhbiBvYmplY3Qgb3IgYW4gYXJyYXkgd2hpY2ggaXMgb2JzZXJ2ZWQgb24gZWFjaAogICAgICAgICAgICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUuIEFueSBzaGFsbG93IGNoYW5nZSB3aXRoaW4gdGhlIGNvbGxlY3Rpb24gd2lsbCB0cmlnZ2VyCiAgICAgICAgICAgICAgICAgICAgICogICAgYSBjYWxsIHRvIHRoZSBgbGlzdGVuZXJgLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihuZXdDb2xsZWN0aW9uLCBvbGRDb2xsZWN0aW9uLCBzY29wZSl9IGxpc3RlbmVyIGEgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBpcyBmaXJlZCB3aXRoIGJvdGgKICAgICAgICAgICAgICAgICAgICAgKiAgICB0aGUgYG5ld0NvbGxlY3Rpb25gIGFuZCBgb2xkQ29sbGVjdGlvbmAgYXMgcGFyYW1ldGVycy4KICAgICAgICAgICAgICAgICAgICAgKiAgICBUaGUgYG5ld0NvbGxlY3Rpb25gIG9iamVjdCBpcyB0aGUgbmV3bHkgbW9kaWZpZWQgZGF0YSBvYnRhaW5lZCBmcm9tIHRoZSBgb2JqYCBleHByZXNzaW9uIGFuZCB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgICBgb2xkQ29sbGVjdGlvbmAgb2JqZWN0IGlzIGEgY29weSBvZiB0aGUgZm9ybWVyIGNvbGxlY3Rpb24gZGF0YS4KICAgICAgICAgICAgICAgICAgICAgKiAgICBUaGUgYHNjb3BlYCByZWZlcnMgdG8gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlLXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4gV2hlbiB0aGUgZGUtcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkCiAgICAgICAgICAgICAgICAgICAgICogdGhlbiB0aGUgaW50ZXJuYWwgd2F0Y2ggb3BlcmF0aW9uIGlzIHRlcm1pbmF0ZWQuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJHdhdGNoQ29sbGVjdGlvbjogZnVuY3Rpb24gKG9iaiwgbGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2xkVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoYW5nZURldGVjdGVkID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9iakdldHRlciA9ICRwYXJzZShvYmopOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJuYWxBcnJheSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJuYWxPYmplY3QgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZExlbmd0aCA9IDA7CgogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAkd2F0Y2hDb2xsZWN0aW9uV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdWYWx1ZSA9IG9iakdldHRlcihzZWxmKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdMZW5ndGgsIGtleTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzT2JqZWN0KG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXlMaWtlKG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gaW50ZXJuYWxBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgdHJhbnNpdGlvbmluZyBmcm9tIHNvbWV0aGluZyB3aGljaCB3YXMgbm90IGFuIGFycmF5IGludG8gYXJyYXkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZFZhbHVlID0gaW50ZXJuYWxBcnJheTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkTGVuZ3RoID0gb2xkVmFsdWUubGVuZ3RoID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0xlbmd0aCA9IG5ld1ZhbHVlLmxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZExlbmd0aCAhPT0gbmV3TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGxlbmd0aHMgZG8gbm90IG1hdGNoIHdlIG5lZWQgdG8gdHJpZ2dlciBjaGFuZ2Ugbm90aWZpY2F0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZFZhbHVlLmxlbmd0aCA9IG9sZExlbmd0aCA9IG5ld0xlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29weSB0aGUgaXRlbXMgdG8gb2xkVmFsdWUgYW5kIGxvb2sgZm9yIGNoYW5nZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdMZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob2xkVmFsdWVbaV0gIT09IG5ld1ZhbHVlW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWVbaV0gPSBuZXdWYWx1ZVtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBpbnRlcm5hbE9iamVjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgdHJhbnNpdGlvbmluZyBmcm9tIHNvbWV0aGluZyB3aGljaCB3YXMgbm90IGFuIG9iamVjdCBpbnRvIG9iamVjdC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWUgPSBpbnRlcm5hbE9iamVjdCA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRMZW5ndGggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IHRoZSBpdGVtcyB0byBvbGRWYWx1ZSBhbmQgbG9vayBmb3IgY2hhbmdlcy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdMZW5ndGggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdMZW5ndGgrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlW2tleV0gIT09IG5ld1ZhbHVlW2tleV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWVba2V5XSA9IG5ld1ZhbHVlW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRMZW5ndGgrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRWYWx1ZVtrZXldID0gbmV3VmFsdWVba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRMZW5ndGggPiBuZXdMZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgdXNlZCB0byBoYXZlIG1vcmUga2V5cywgbmVlZCB0byBmaW5kIHRoZW0gYW5kIGRlc3Ryb3kgdGhlbS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gb2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmICFuZXdWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkTGVuZ3RoLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG9sZFZhbHVlW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hhbmdlRGV0ZWN0ZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICR3YXRjaENvbGxlY3Rpb25BY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcihuZXdWYWx1ZSwgb2xkVmFsdWUsIHNlbGYpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kd2F0Y2goJHdhdGNoQ29sbGVjdGlvbldhdGNoLCAkd2F0Y2hDb2xsZWN0aW9uQWN0aW9uKTsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogUHJvY2Vzc2VzIGFsbCBvZiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJzfSBvZiB0aGUgY3VycmVudCBzY29wZSBhbmQgaXRzIGNoaWxkcmVuLgogICAgICAgICAgICAgICAgICAgICAqIEJlY2F1c2UgYSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlcn0ncyBsaXN0ZW5lciBjYW4gY2hhbmdlIHRoZSBtb2RlbCwgdGhlCiAgICAgICAgICAgICAgICAgICAgICogYCRkaWdlc3QoKWAga2VlcHMgY2FsbGluZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJzfSB1bnRpbCBubyBtb3JlIGxpc3RlbmVycyBhcmUKICAgICAgICAgICAgICAgICAgICAgKiBmaXJpbmcuIFRoaXMgbWVhbnMgdGhhdCBpdCBpcyBwb3NzaWJsZSB0byBnZXQgaW50byBhbiBpbmZpbml0ZSBsb29wLiBUaGlzIGZ1bmN0aW9uIHdpbGwgdGhyb3cKICAgICAgICAgICAgICAgICAgICAgKiBgJ01heGltdW0gaXRlcmF0aW9uIGxpbWl0IGV4Y2VlZGVkLidgIGlmIHRoZSBudW1iZXIgb2YgaXRlcmF0aW9ucyBleGNlZWRzIDEwLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVXN1YWxseSB5b3UgZG9uJ3QgY2FsbCBgJGRpZ2VzdCgpYCBkaXJlY3RseSBpbgogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDb250cm9sbGVyIGNvbnRyb2xsZXJzfSBvciBpbgogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4KICAgICAgICAgICAgICAgICAgICAgKiBJbnN0ZWFkIGEgY2FsbCB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkYXBwbHkgJGFwcGx5KCl9ICh0eXBpY2FsbHkgZnJvbSB3aXRoaW4gYQogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSBkaXJlY3RpdmVzfSkgd2lsbCBmb3JjZSBhIGAkZGlnZXN0KClgLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogSWYgeW91IHdhbnQgdG8gYmUgbm90aWZpZWQgd2hlbmV2ZXIgYCRkaWdlc3QoKWAgaXMgY2FsbGVkLAogICAgICAgICAgICAgICAgICAgICAqIHlvdSBjYW4gcmVnaXN0ZXIgYSBgd2F0Y2hFeHByZXNzaW9uYCBmdW5jdGlvbiAgd2l0aCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggJHdhdGNoKCl9CiAgICAgICAgICAgICAgICAgICAgICogd2l0aCBubyBgbGlzdGVuZXJgLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogWW91IG1heSBoYXZlIGEgbmVlZCB0byBjYWxsIGAkZGlnZXN0KClgIGZyb20gd2l0aGluIHVuaXQtdGVzdHMsIHRvIHNpbXVsYXRlIHRoZSBzY29wZQogICAgICAgICAgICAgICAgICAgICAqIGxpZmUtY3ljbGUuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAjIEV4YW1wbGUKICAgICAgICAgICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gLi4uOwogICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUubmFtZSA9ICdtaXNrbyc7CiAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gMDsKICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSBzY29wZS5jb3VudGVyICsgMTsKICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBubyB2YXJpYWJsZSBjaGFuZ2UKICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUubmFtZSA9ICdhZGFtJzsKICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwogICAgICAgICAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGRpZ2VzdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgd2F0Y2gsIHZhbHVlLCBsYXN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3luY1F1ZXVlID0gdGhpcy4kJGFzeW5jUXVldWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0RGlnZXN0UXVldWUgPSB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHksIHR0bCA9IFRUTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQsIGN1cnJlbnQsIHRhcmdldCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaExvZyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nSWR4LCBsb2dNc2c7CgogICAgICAgICAgICAgICAgICAgICAgICBiZWdpblBoYXNlKCckZGlnZXN0Jyk7CgogICAgICAgICAgICAgICAgICAgICAgICBkbyB7IC8vICJ3aGlsZSBkaXJ0eSIgbG9vcAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0YXJnZXQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGFzeW5jUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudC4kZXZhbChhc3luY1F1ZXVlLnNoaWZ0KCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsgLy8gInRyYXZlcnNlIHRoZSBzY29wZXMiIGxvb3AKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHdhdGNoZXJzID0gY3VycmVudC4kJHdhdGNoZXJzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwcm9jZXNzIG91ciB3YXRjaGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHdhdGNoZXJzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoID0gd2F0Y2hlcnNbbGVuZ3RoXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNb3N0IGNvbW1vbiB3YXRjaGVzIGFyZSBvbiBwcmltaXRpdmVzLCBpbiB3aGljaCBjYXNlIHdlIGNhbiBzaG9ydAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNpcmN1aXQgaXQgd2l0aCA9PT0gb3BlcmF0b3IsIG9ubHkgd2hlbiA9PT0gZmFpbHMgZG8gd2UgdXNlIC5lcXVhbHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2F0Y2ggJiYgKHZhbHVlID0gd2F0Y2guZ2V0KGN1cnJlbnQpKSAhPT0gKGxhc3QgPSB3YXRjaC5sYXN0KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAhKHdhdGNoLmVxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGVxdWFscyh2YWx1ZSwgbGFzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyAmJiB0eXBlb2YgbGFzdCA9PSAnbnVtYmVyJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgaXNOYU4odmFsdWUpICYmIGlzTmFOKGxhc3QpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5sYXN0ID0gd2F0Y2guZXEgPyBjb3B5KHZhbHVlKSA6IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5mbih2YWx1ZSwgKChsYXN0ID09PSBpbml0V2F0Y2hWYWwpID8gdmFsdWUgOiBsYXN0KSwgY3VycmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0dGwgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dJZHggPSA0IC0gdHRsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF3YXRjaExvZ1tsb2dJZHhdKSB3YXRjaExvZ1tsb2dJZHhdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgPSAoaXNGdW5jdGlvbih3YXRjaC5leHApKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ2ZuOiAnICsgKHdhdGNoLmV4cC5uYW1lIHx8IHdhdGNoLmV4cC50b1N0cmluZygpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogd2F0Y2guZXhwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nTXNnICs9ICc7IG5ld1ZhbDogJyArIHRvSnNvbih2YWx1ZSkgKyAnOyBvbGRWYWw6ICcgKyB0b0pzb24obGFzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaExvZ1tsb2dJZHhdLnB1c2gobG9nTXNnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5zYW5pdHkgV2FybmluZzogc2NvcGUgZGVwdGgtZmlyc3QgdHJhdmVyc2FsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8geWVzLCB0aGlzIGNvZGUgaXMgYSBiaXQgY3JhenksIGJ1dCBpdCB3b3JrcyBhbmQgd2UgaGF2ZSB0ZXN0cyB0byBwcm92ZSBpdCEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHBpZWNlIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgdHJhdmVyc2FsIGluICRicm9hZGNhc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShuZXh0ID0gKGN1cnJlbnQuJCRjaGlsZEhlYWQgfHwgKGN1cnJlbnQgIT09IHRhcmdldCAmJiBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgIT09IHRhcmdldCAmJiAhKG5leHQgPSBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC4kcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBuZXh0KSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcnR5ICYmICEodHRsLS0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93ICRyb290U2NvcGVNaW5FcnIoJ2luZmRpZycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7MH0gJGRpZ2VzdCgpIGl0ZXJhdGlvbnMgcmVhY2hlZC4gQWJvcnRpbmchXG5XYXRjaGVycyBmaXJlZCBpbiB0aGUgbGFzdCA1IGl0ZXJhdGlvbnM6IHsxfScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRUTCwgdG9Kc29uKHdhdGNoTG9nKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRpcnR5IHx8IGFzeW5jUXVldWUubGVuZ3RoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChwb3N0RGlnZXN0UXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3REaWdlc3RRdWV1ZS5zaGlmdCgpKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveQogICAgICAgICAgICAgICAgICAgICAqIEBldmVudE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiBzY29wZSBiZWluZyBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEJyb2FkY2FzdGVkIHdoZW4gYSBzY29wZSBhbmQgaXRzIGNoaWxkcmVuIGFyZSBiZWluZyBkZXN0cm95ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBOb3RlIHRoYXQsIGluIEFuZ3VsYXJKUywgdGhlcmUgaXMgYWxzbyBhIGAkZGVzdHJveWAgalF1ZXJ5IGV2ZW50LCB3aGljaCBjYW4gYmUgdXNlZCB0bwogICAgICAgICAgICAgICAgICAgICAqIGNsZWFuIHVwIERPTSBiaW5kaW5ncyBiZWZvcmUgYW4gZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTS4KICAgICAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveQogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBSZW1vdmVzIHRoZSBjdXJyZW50IHNjb3BlIChhbmQgYWxsIG9mIGl0cyBjaGlsZHJlbikgZnJvbSB0aGUgcGFyZW50IHNjb3BlLiBSZW1vdmFsIGltcGxpZXMKICAgICAgICAgICAgICAgICAgICAgKiB0aGF0IGNhbGxzIHRvIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSB3aWxsIG5vIGxvbmdlcgogICAgICAgICAgICAgICAgICAgICAqIHByb3BhZ2F0ZSB0byB0aGUgY3VycmVudCBzY29wZSBhbmQgaXRzIGNoaWxkcmVuLiBSZW1vdmFsIGFsc28gaW1wbGllcyB0aGF0IHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAgICAgICogc2NvcGUgaXMgZWxpZ2libGUgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbi4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoZSBgJGRlc3Ryb3koKWAgaXMgdXN1YWxseSB1c2VkIGJ5IGRpcmVjdGl2ZXMgc3VjaCBhcwogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9IGZvciBtYW5hZ2luZyB0aGUKICAgICAgICAgICAgICAgICAgICAgKiB1bnJvbGxpbmcgb2YgdGhlIGxvb3AuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBKdXN0IGJlZm9yZSBhIHNjb3BlIGlzIGRlc3Ryb3llZCBhIGAkZGVzdHJveWAgZXZlbnQgaXMgYnJvYWRjYXN0ZWQgb24gdGhpcyBzY29wZS4KICAgICAgICAgICAgICAgICAgICAgKiBBcHBsaWNhdGlvbiBjb2RlIGNhbiByZWdpc3RlciBhIGAkZGVzdHJveWAgZXZlbnQgaGFuZGxlciB0aGF0IHdpbGwgZ2l2ZSBpdCBjaGFuY2UgdG8KICAgICAgICAgICAgICAgICAgICAgKiBwZXJmb3JtIGFueSBuZWNlc3NhcnkgY2xlYW51cC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIE5vdGUgdGhhdCwgaW4gQW5ndWxhckpTLCB0aGVyZSBpcyBhbHNvIGEgYCRkZXN0cm95YCBqUXVlcnkgZXZlbnQsIHdoaWNoIGNhbiBiZSB1c2VkIHRvCiAgICAgICAgICAgICAgICAgICAgICogY2xlYW4gdXAgRE9NIGJpbmRpbmdzIGJlZm9yZSBhbiBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGNhbid0IGRlc3Ryb3kgdGhlIHJvb3Qgc2NvcGUgb3IgYSBzY29wZSB0aGF0IGhhcyBiZWVuIGFscmVhZHkgZGVzdHJveWVkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlID09IHRoaXMgfHwgdGhpcy4kJGRlc3Ryb3llZCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy4kcGFyZW50OwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kYnJvYWRjYXN0KCckZGVzdHJveScpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkZGVzdHJveWVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQuJCRjaGlsZEhlYWQgPT0gdGhpcykgcGFyZW50LiQkY2hpbGRIZWFkID0gdGhpcy4kJG5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LiQkY2hpbGRUYWlsID09IHRoaXMpIHBhcmVudC4kJGNoaWxkVGFpbCA9IHRoaXMuJCRwcmV2U2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuJCRwcmV2U2libGluZykgdGhpcy4kJHByZXZTaWJsaW5nLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkbmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLiQkbmV4dFNpYmxpbmcpIHRoaXMuJCRuZXh0U2libGluZy4kJHByZXZTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBib2d1cyBjb2RlIHRoYXQgd29ya3MgYXJvdW5kIENocm9tZSdzIEdDIGxlYWsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2VlOiBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy8xMzEzI2lzc3VlY29tbWVudC0xMDM3ODQ1MQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRwYXJlbnQgPSB0aGlzLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmcgPSB0aGlzLiQkY2hpbGRIZWFkID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGV2YWwKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogRXhlY3V0ZXMgdGhlIGBleHByZXNzaW9uYCBvbiB0aGUgY3VycmVudCBzY29wZSByZXR1cm5pbmcgdGhlIHJlc3VsdC4gQW55IGV4Y2VwdGlvbnMgaW4gdGhlCiAgICAgICAgICAgICAgICAgICAgICogZXhwcmVzc2lvbiBhcmUgcHJvcGFnYXRlZCAodW5jYXVnaHQpLiBUaGlzIGlzIHVzZWZ1bCB3aGVuIGV2YWx1YXRpbmcgQW5ndWxhciBleHByZXNzaW9ucy4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICMgRXhhbXBsZQogICAgICAgICAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSBuZy4kcm9vdFNjb3BlLlNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5hID0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLmIgPSAyOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKCdhK2InKSkudG9FcXVhbCgzKTsKICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbChmdW5jdGlvbihzY29wZSl7IHJldHVybiBzY29wZS5hICsgc2NvcGUuYjsgfSkpLnRvRXF1YWwoMyk7CiAgICAgICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4gIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBleHByZXNzaW9uLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRldmFsOiBmdW5jdGlvbiAoZXhwciwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcGFyc2UoZXhwcikodGhpcywgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogRXhlY3V0ZXMgdGhlIGV4cHJlc3Npb24gb24gdGhlIGN1cnJlbnQgc2NvcGUgYXQgYSBsYXRlciBwb2ludCBpbiB0aW1lLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIGAkZXZhbEFzeW5jYCBtYWtlcyBubyBndWFyYW50ZWVzIGFzIHRvIHdoZW4gdGhlIGBleHByZXNzaW9uYCB3aWxsIGJlIGV4ZWN1dGVkLCBvbmx5IHRoYXQ6CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgIC0gaXQgd2lsbCBleGVjdXRlIGFmdGVyIHRoZSBmdW5jdGlvbiB0aGF0IHNjaGVkdWxlIHRoZSBldmFsdWF0aW9uIGlzIGRvbmUgcnVubmluZyAocHJlZmVyYWJseSBiZWZvcmUgRE9NIHJlbmRlcmluZykuCiAgICAgICAgICAgICAgICAgICAgICogICAtIGF0IGxlYXN0IG9uZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QgY3ljbGV9IHdpbGwgYmUgcGVyZm9ybWVkIGFmdGVyIGBleHByZXNzaW9uYCBleGVjdXRpb24uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9ucyBmcm9tIHRoZSBleGVjdXRpb24gb2YgdGhlIGV4cHJlc3Npb24gYXJlIGZvcndhcmRlZCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBfX05vdGU6X18gaWYgdGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgb3V0c2lkZSBvZiBgJGRpZ2VzdGAgY3ljbGUsIGEgbmV3ICRkaWdlc3QgY3ljbGUgd2lsbCBiZSBzY2hlZHVsZWQuCiAgICAgICAgICAgICAgICAgICAgICogSXQgaXMgaG93ZXZlciBlbmNvdXJhZ2VkIHRvIGFsd2F5cyBjYWxsIGNvZGUgdGhhdCBjaGFuZ2VzIHRoZSBtb2RlbCBmcm9tIHdpdGhpbmcgYW4gYCRhcHBseWAgY2FsbC4KICAgICAgICAgICAgICAgICAgICAgKiBUaGF0IGluY2x1ZGVzIGNvZGUgZXZhbHVhdGVkIHZpYSBgJGV2YWxBc3luY2AuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4gIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkZXZhbEFzeW5jOiBmdW5jdGlvbiAoZXhwcikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB3ZSBhcmUgb3V0c2lkZSBvZiBhbiAkZGlnZXN0IGxvb3AgYW5kIHRoaXMgaXMgdGhlIGZpcnN0IHRpbWUgd2UgYXJlIHNjaGVkdWxpbmcgYXN5bmMgdGFzayBhbHNvIHNjaGVkdWxlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFzeW5jIGF1dG8tZmx1c2gKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UgJiYgISRyb290U2NvcGUuJCRhc3luY1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiQkYXN5bmNRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJCRhc3luY1F1ZXVlLnB1c2goZXhwcik7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgJCRwb3N0RGlnZXN0OiBmdW5jdGlvbiAoZXhwcikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlLnB1c2goZXhwcik7CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkYXBwbHkKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogYCRhcHBseSgpYCBpcyB1c2VkIHRvIGV4ZWN1dGUgYW4gZXhwcmVzc2lvbiBpbiBhbmd1bGFyIGZyb20gb3V0c2lkZSBvZiB0aGUgYW5ndWxhciBmcmFtZXdvcmsuCiAgICAgICAgICAgICAgICAgICAgICogKEZvciBleGFtcGxlIGZyb20gYnJvd3NlciBET00gZXZlbnRzLCBzZXRUaW1lb3V0LCBYSFIgb3IgdGhpcmQgcGFydHkgbGlicmFyaWVzKS4KICAgICAgICAgICAgICAgICAgICAgKiBCZWNhdXNlIHdlIGFyZSBjYWxsaW5nIGludG8gdGhlIGFuZ3VsYXIgZnJhbWV3b3JrIHdlIG5lZWQgdG8gcGVyZm9ybSBwcm9wZXIgc2NvcGUgbGlmZS1jeWNsZQogICAgICAgICAgICAgICAgICAgICAqIG9mIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciBleGNlcHRpb24gaGFuZGxpbmd9LAogICAgICAgICAgICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgZXhlY3V0aW5nIHdhdGNoZXN9LgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyMgTGlmZSBjeWNsZQogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogIyBQc2V1ZG8tQ29kZSBvZiBgJGFwcGx5KClgCiAgICAgICAgICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICRhcHBseShleHByKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRldmFsKGV4cHIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3QuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFNjb3BlJ3MgYCRhcHBseSgpYCBtZXRob2QgdHJhbnNpdGlvbnMgdGhyb3VnaCB0aGUgZm9sbG93aW5nIHN0YWdlczoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIDEuIFRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyBleGVjdXRlZCB1c2luZyB0aGUKICAgICAgICAgICAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbCAkZXZhbCgpfSBtZXRob2QuCiAgICAgICAgICAgICAgICAgICAgICogMi4gQW55IGV4Y2VwdGlvbnMgZnJvbSB0aGUgZXhlY3V0aW9uIG9mIHRoZSBleHByZXNzaW9uIGFyZSBmb3J3YXJkZWQgdG8gdGhlCiAgICAgICAgICAgICAgICAgICAgICogICAge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqIDMuIFRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2h9IGxpc3RlbmVycyBhcmUgZmlyZWQgaW1tZWRpYXRlbHkgYWZ0ZXIgdGhlIGV4cHJlc3Npb24KICAgICAgICAgICAgICAgICAgICAgKiAgICB3YXMgZXhlY3V0ZWQgdXNpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBtZXRob2QuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cCBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmVzdWx0IG9mIGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24uCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJGFwcGx5OiBmdW5jdGlvbiAoZXhwcikgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW5QaGFzZSgnJGFwcGx5Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kZXZhbChleHByKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbgogICAgICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICAgICAgICAgKiBMaXN0ZW5zIG9uIGV2ZW50cyBvZiBhIGdpdmVuIHR5cGUuIFNlZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZW1pdCAkZW1pdH0gZm9yIGRpc2N1c3Npb24gb2YKICAgICAgICAgICAgICAgICAgICAgKiBldmVudCBsaWZlIGN5Y2xlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIGV2ZW50IGxpc3RlbmVyIGZ1bmN0aW9uIGZvcm1hdCBpczogYGZ1bmN0aW9uKGV2ZW50LCBhcmdzLi4uKWAuIFRoZSBgZXZlbnRgIG9iamVjdAogICAgICAgICAgICAgICAgICAgICAqIHBhc3NlZCBpbnRvIHRoZSBsaXN0ZW5lciBoYXMgdGhlIGZvbGxvd2luZyBhdHRyaWJ1dGVzOgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogICAtIGB0YXJnZXRTY29wZWAgLSBge1Njb3BlfWA6IHRoZSBzY29wZSBvbiB3aGljaCB0aGUgZXZlbnQgd2FzIGAkZW1pdGAtZWQgb3IgYCRicm9hZGNhc3RgLWVkLgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgY3VycmVudFNjb3BlYCAtIGB7U2NvcGV9YDogdGhlIGN1cnJlbnQgc2NvcGUgd2hpY2ggaXMgaGFuZGxpbmcgdGhlIGV2ZW50LgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgbmFtZWAgLSBge3N0cmluZ31gOiBOYW1lIG9mIHRoZSBldmVudC4KICAgICAgICAgICAgICAgICAgICAgKiAgIC0gYHN0b3BQcm9wYWdhdGlvbmAgLSBge2Z1bmN0aW9uPX1gOiBjYWxsaW5nIGBzdG9wUHJvcGFnYXRpb25gIGZ1bmN0aW9uIHdpbGwgY2FuY2VsIGZ1cnRoZXIgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgKiAgICAgcHJvcGFnYXRpb24gKGF2YWlsYWJsZSBvbmx5IGZvciBldmVudHMgdGhhdCB3ZXJlIGAkZW1pdGAtZWQpLgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgcHJldmVudERlZmF1bHRgIC0gYHtmdW5jdGlvbn1gOiBjYWxsaW5nIGBwcmV2ZW50RGVmYXVsdGAgc2V0cyBgZGVmYXVsdFByZXZlbnRlZGAgZmxhZyB0byB0cnVlLgogICAgICAgICAgICAgICAgICAgICAqICAgLSBgZGVmYXVsdFByZXZlbnRlZGAgLSBge2Jvb2xlYW59YDogdHJ1ZSBpZiBgcHJldmVudERlZmF1bHRgIHdhcyBjYWxsZWQuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGxpc3RlbiBvbi4KICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50LCBhcmdzLi4uKX0gbGlzdGVuZXIgRnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBldmVudCBpcyBlbWl0dGVkLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBSZXR1cm5zIGEgZGVyZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgbGlzdGVuZXIuCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgJG9uOiBmdW5jdGlvbiAobmFtZSwgbGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWVkTGlzdGVuZXJzID0gdGhpcy4kJGxpc3RlbmVyc1tuYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFuYW1lZExpc3RlbmVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kJGxpc3RlbmVyc1tuYW1lXSA9IG5hbWVkTGlzdGVuZXJzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnNbaW5kZXhPZihuYW1lZExpc3RlbmVycywgbGlzdGVuZXIpXSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiRyb290U2NvcGUuU2NvcGUjJGVtaXQKICAgICAgICAgICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHJvb3RTY29wZS5TY29wZQogICAgICAgICAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICAgICogRGlzcGF0Y2hlcyBhbiBldmVudCBgbmFtZWAgdXB3YXJkcyB0aHJvdWdoIHRoZSBzY29wZSBoaWVyYXJjaHkgbm90aWZ5aW5nIHRoZQogICAgICAgICAgICAgICAgICAgICAqIHJlZ2lzdGVyZWQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufSBsaXN0ZW5lcnMuCiAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgKiBUaGUgZXZlbnQgbGlmZSBjeWNsZSBzdGFydHMgYXQgdGhlIHNjb3BlIG9uIHdoaWNoIGAkZW1pdGAgd2FzIGNhbGxlZC4gQWxsCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gbGlzdGVuaW5nIGZvciBgbmFtZWAgZXZlbnQgb24gdGhpcyBzY29wZSBnZXQgbm90aWZpZWQuCiAgICAgICAgICAgICAgICAgICAgICogQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHRyYXZlcnNlcyB1cHdhcmRzIHRvd2FyZCB0aGUgcm9vdCBzY29wZSBhbmQgY2FsbHMgYWxsIHJlZ2lzdGVyZWQKICAgICAgICAgICAgICAgICAgICAgKiBsaXN0ZW5lcnMgYWxvbmcgdGhlIHdheS4gVGhlIGV2ZW50IHdpbGwgc3RvcCBwcm9wYWdhdGluZyBpZiBvbmUgb2YgdGhlIGxpc3RlbmVycyBjYW5jZWxzIGl0LgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQW55IGV4Y2VwdGlvbiBlbWl0dGVkIGZyb20gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IHdpbGwgYmUgcGFzc2VkCiAgICAgICAgICAgICAgICAgICAgICogb250byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBlbWl0LgogICAgICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBzZXQgb2YgYXJndW1lbnRzIHdoaWNoIHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICAgICAgICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEV2ZW50IG9iamVjdCwgc2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAkZW1pdDogZnVuY3Rpb24gKG5hbWUsIGFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVtcHR5ID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbiA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRTY29wZTogc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoKSB7IHN0b3BQcm9wYWdhdGlvbiA9IHRydWU7IH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyQXJncyA9IGNvbmNhdChbZXZlbnRdLCBhcmd1bWVudHMsIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSwgbGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMgPSBzY29wZS4kJGxpc3RlbmVyc1tuYW1lXSB8fCBlbXB0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IHNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gbmFtZWRMaXN0ZW5lcnMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgbGlzdGVuZXJzIHdlcmUgZGVyZWdpc3RlcmVkLCBkZWZyYWdtZW50IHRoZSBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbmFtZWRMaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3BQcm9wYWdhdGlvbikgcmV0dXJuIGV2ZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy90cmF2ZXJzZSB1cHdhcmRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IHNjb3BlLiRwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHNjb3BlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudDsKICAgICAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICogQG5hbWUgbmcuJHJvb3RTY29wZS5TY29wZSMkYnJvYWRjYXN0CiAgICAgICAgICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRyb290U2NvcGUuU2NvcGUKICAgICAgICAgICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgICAgICAgICAqIERpc3BhdGNoZXMgYW4gZXZlbnQgYG5hbWVgIGRvd253YXJkcyB0byBhbGwgY2hpbGQgc2NvcGVzIChhbmQgdGhlaXIgY2hpbGRyZW4pIG5vdGlmeWluZyB0aGUKICAgICAgICAgICAgICAgICAgICAgKiByZWdpc3RlcmVkIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0gbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlIGV2ZW50IGxpZmUgY3ljbGUgc3RhcnRzIGF0IHRoZSBzY29wZSBvbiB3aGljaCBgJGJyb2FkY2FzdGAgd2FzIGNhbGxlZC4gQWxsCiAgICAgICAgICAgICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gbGlzdGVuaW5nIGZvciBgbmFtZWAgZXZlbnQgb24gdGhpcyBzY29wZSBnZXQgbm90aWZpZWQuCiAgICAgICAgICAgICAgICAgICAgICogQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHByb3BhZ2F0ZXMgdG8gYWxsIGRpcmVjdCBhbmQgaW5kaXJlY3Qgc2NvcGVzIG9mIHRoZSBjdXJyZW50IHNjb3BlIGFuZAogICAgICAgICAgICAgICAgICAgICAqIGNhbGxzIGFsbCByZWdpc3RlcmVkIGxpc3RlbmVycyBhbG9uZyB0aGUgd2F5LiBUaGUgZXZlbnQgY2Fubm90IGJlIGNhbmNlbGVkLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQW55IGV4Y2VwdGlvbiBlbWl0dGVkIGZyb20gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IHdpbGwgYmUgcGFzc2VkCiAgICAgICAgICAgICAgICAgICAgICogb250byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBicm9hZGNhc3QuCiAgICAgICAgICAgICAgICAgICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIHNldCBvZiBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gRXZlbnQgb2JqZWN0LCBzZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICRicm9hZGNhc3Q6IGZ1bmN0aW9uIChuYW1lLCBhcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRhcmdldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSB0YXJnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFNjb3BlOiB0YXJnZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyQXJncyA9IGNvbmNhdChbZXZlbnRdLCBhcmd1bWVudHMsIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLCBpLCBsZW5ndGg7CgogICAgICAgICAgICAgICAgICAgICAgICAvL2Rvd24gd2hpbGUgeW91IGNhbiwgdGhlbiB1cCBhbmQgbmV4dCBzaWJsaW5nIG9yIHVwIGFuZCBuZXh0IHNpYmxpbmcgdW50aWwgYmFjayBhdCByb290CiAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBuZXh0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuY3VycmVudFNjb3BlID0gY3VycmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycyA9IGN1cnJlbnQuJCRsaXN0ZW5lcnNbbmFtZV0gfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBsaXN0ZW5lcnMgd2VyZSBkZXJlZ2lzdGVyZWQsIGRlZnJhZ21lbnQgdGhlIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbnNhbml0eSBXYXJuaW5nOiBzY29wZSBkZXB0aC1maXJzdCB0cmF2ZXJzYWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHllcywgdGhpcyBjb2RlIGlzIGEgYml0IGNyYXp5LCBidXQgaXQgd29ya3MgYW5kIHdlIGhhdmUgdGVzdHMgdG8gcHJvdmUgaXQhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHBpZWNlIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgdHJhdmVyc2FsIGluICRkaWdlc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG5leHQgPSAoY3VycmVudC4kJGNoaWxkSGVhZCB8fCAoY3VycmVudCAhPT0gdGFyZ2V0ICYmIGN1cnJlbnQuJCRuZXh0U2libGluZykpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChjdXJyZW50ICE9PSB0YXJnZXQgJiYgIShuZXh0ID0gY3VycmVudC4kJG5leHRTaWJsaW5nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC4kcGFyZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBuZXh0KSk7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB2YXIgJHJvb3RTY29wZSA9IG5ldyBTY29wZSgpOwoKICAgICAgICAgICAgICAgIHJldHVybiAkcm9vdFNjb3BlOwoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBiZWdpblBoYXNlKHBoYXNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRyb290U2NvcGUuJCRwaGFzZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkcm9vdFNjb3BlTWluRXJyKCdpbnByb2cnLCAnezB9IGFscmVhZHkgaW4gcHJvZ3Jlc3MnLCAkcm9vdFNjb3BlLiQkcGhhc2UpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kJHBoYXNlID0gcGhhc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY2xlYXJQaGFzZSgpIHsKICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiQkcGhhc2UgPSBudWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVUb0ZuKGV4cCwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBmbiA9ICRwYXJzZShleHApOwogICAgICAgICAgICAgICAgICAgIGFzc2VydEFyZ0ZuKGZuLCBuYW1lKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBmdW5jdGlvbiB1c2VkIGFzIGFuIGluaXRpYWwgdmFsdWUgZm9yIHdhdGNoZXJzLgogICAgICAgICAgICAgICAgICogYmVjYXVzZSBpdCdzIHVuaXF1ZSB3ZSBjYW4gZWFzaWx5IHRlbGwgaXQgYXBhcnQgZnJvbSBvdGhlciB2YWx1ZXMKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZnVuY3Rpb24gaW5pdFdhdGNoVmFsKCkgeyB9CiAgICAgICAgICAgIH1dOwogICAgfQoKICAgIHZhciAkc2NlTWluRXJyID0gbWluRXJyKCckc2NlJyk7CgogICAgdmFyIFNDRV9DT05URVhUUyA9IHsKICAgICAgICBIVE1MOiAnaHRtbCcsCiAgICAgICAgQ1NTOiAnY3NzJywKICAgICAgICBVUkw6ICd1cmwnLAogICAgICAgIC8vIFJFU09VUkNFX1VSTCBpcyBhIHN1YnR5cGUgb2YgVVJMIHVzZWQgaW4gY29udGV4dHMgd2hlcmUgYSBwcml2aWxlZ2VkIHJlc291cmNlIGlzIHNvdXJjZWQgZnJvbSBhCiAgICAgICAgLy8gdXJsLiAgKGUuZy4gbmctaW5jbHVkZSwgc2NyaXB0IHNyYywgdGVtcGxhdGVVcmwpCiAgICAgICAgUkVTT1VSQ0VfVVJMOiAncmVzb3VyY2VVcmwnLAogICAgICAgIEpTOiAnanMnCiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgKiBAbmFtZSBuZy4kc2NlRGVsZWdhdGUKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIGAkc2NlRGVsZWdhdGVgIGlzIGEgc2VydmljZSB0aGF0IGlzIHVzZWQgYnkgdGhlIGAkc2NlYCBzZXJ2aWNlIHRvIHByb3ZpZGUge0BsaW5rIG5nLiRzY2UgU3RyaWN0CiAgICAgKiBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpfSBzZXJ2aWNlcyB0byBBbmd1bGFySlMuCiAgICAgKgogICAgICogVHlwaWNhbGx5LCB5b3Ugd291bGQgY29uZmlndXJlIG9yIG92ZXJyaWRlIHRoZSB7QGxpbmsgbmcuJHNjZURlbGVnYXRlICRzY2VEZWxlZ2F0ZX0gaW5zdGVhZCBvZgogICAgICogdGhlIGAkc2NlYCBzZXJ2aWNlIHRvIGN1c3RvbWl6ZSB0aGUgd2F5IFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIHdvcmtzIGluIEFuZ3VsYXJKUy4gIFRoaXMgaXMKICAgICAqIGJlY2F1c2UsIHdoaWxlIHRoZSBgJHNjZWAgcHJvdmlkZXMgbnVtZXJvdXMgc2hvcnRoYW5kIG1ldGhvZHMsIGV0Yy4sIHlvdSByZWFsbHkgb25seSBuZWVkIHRvCiAgICAgKiBvdmVycmlkZSAzIGNvcmUgZnVuY3Rpb25zIChgdHJ1c3RBc2AsIGBnZXRUcnVzdGVkYCBhbmQgYHZhbHVlT2ZgKSB0byByZXBsYWNlIHRoZSB3YXkgdGhpbmdzCiAgICAgKiB3b3JrIGJlY2F1c2UgYCRzY2VgIGRlbGVnYXRlcyB0byBgJHNjZURlbGVnYXRlYCBmb3IgdGhlc2Ugb3BlcmF0aW9ucy4KICAgICAqCiAgICAgKiBSZWZlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIgJHNjZURlbGVnYXRlUHJvdmlkZXJ9IHRvIGNvbmZpZ3VyZSB0aGlzIHNlcnZpY2UuCiAgICAgKgogICAgICogVGhlIGRlZmF1bHQgaW5zdGFuY2Ugb2YgYCRzY2VEZWxlZ2F0ZWAgc2hvdWxkIHdvcmsgb3V0IG9mIHRoZSBib3ggd2l0aCBsaXR0bGUgcGFpbi4gIFdoaWxlIHlvdQogICAgICogY2FuIG92ZXJyaWRlIGl0IGNvbXBsZXRlbHkgdG8gY2hhbmdlIHRoZSBiZWhhdmlvciBvZiBgJHNjZWAsIHRoZSBjb21tb24gY2FzZSB3b3VsZAogICAgICogaW52b2x2ZSBjb25maWd1cmluZyB0aGUge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyICRzY2VEZWxlZ2F0ZVByb3ZpZGVyfSBpbnN0ZWFkIGJ5IHNldHRpbmcKICAgICAqIHlvdXIgb3duIHdoaXRlbGlzdHMgYW5kIGJsYWNrbGlzdHMgZm9yIHRydXN0aW5nIFVSTHMgdXNlZCBmb3IgbG9hZGluZyBBbmd1bGFySlMgcmVzb3VyY2VzIHN1Y2ggYXMKICAgICAqIHRlbXBsYXRlcy4gIFJlZmVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdAogICAgICogJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxXaGl0ZWxpc3R9IGFuZCB7QGxpbmsKICAgICAqIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0ICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsQmxhY2tsaXN0fQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kc2NlRGVsZWdhdGVQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogVGhlICRzY2VEZWxlZ2F0ZVByb3ZpZGVyIHByb3ZpZGVyIGFsbG93cyBkZXZlbG9wZXJzIHRvIGNvbmZpZ3VyZSB0aGUge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZQogICAgICogJHNjZURlbGVnYXRlfSBzZXJ2aWNlLiAgVGhpcyBhbGxvd3Mgb25lIHRvIGdldC9zZXQgdGhlIHdoaXRlbGlzdHMgYW5kIGJsYWNrbGlzdHMgdXNlZCB0byBlbnN1cmUKICAgICAqIHRoYXQgVVJMcyB1c2VkIGZvciBzb3VyY2luZyBBbmd1bGFyIHRlbXBsYXRlcyBhcmUgc2FmZS4gIFJlZmVyIHtAbGluawogICAgICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3QgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxXaGl0ZWxpc3R9IGFuZAogICAgICoge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0ICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsQmxhY2tsaXN0fQogICAgICoKICAgICAqIFJlYWQgbW9yZSBhYm91dCB7QGxpbmsgbmcuJHNjZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0uCiAgICAgKi8KCiAgICBmdW5jdGlvbiAkU2NlRGVsZWdhdGVQcm92aWRlcigpIHsKICAgICAgICB0aGlzLlNDRV9DT05URVhUUyA9IFNDRV9DT05URVhUUzsKCiAgICAgICAgLy8gUmVzb3VyY2UgVVJMcyBjYW4gYWxzbyBiZSB0cnVzdGVkIGJ5IHBvbGljeS4KICAgICAgICB2YXIgcmVzb3VyY2VVcmxXaGl0ZWxpc3QgPSBbJ3NlbGYnXSwKICAgICAgICAgICAgcmVzb3VyY2VVcmxCbGFja2xpc3QgPSBbXTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kc2NlRGVsZWdhdGVQcm92aWRlcgogICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBcnJheT19IHdoaXRlbGlzdCBXaGVuIHByb3ZpZGVkLCByZXBsYWNlcyB0aGUgcmVzb3VyY2VVcmxXaGl0ZWxpc3Qgd2l0aCB0aGUgdmFsdWUKICAgICAgICAgKiAgICAgcHJvdmlkZWQuICBUaGlzIG11c3QgYmUgYW4gYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiAgICAgRWFjaCBlbGVtZW50IG9mIHRoaXMgYXJyYXkgbXVzdCBlaXRoZXIgYmUgYSByZWdleCBvciB0aGUgc3BlY2lhbCBzdHJpbmcgYCdzZWxmJ2AuCiAgICAgICAgICoKICAgICAgICAgKiAgICAgV2hlbiBhIHJlZ2V4IGlzIHVzZWQsIGl0IGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgbm9ybWFsaXplZCAvIGFic29sdXRlIFVSTCBvZiB0aGUgcmVzb3VyY2UKICAgICAgICAgKiAgICAgYmVpbmcgdGVzdGVkLgogICAgICAgICAqCiAgICAgICAgICogICAgIFRoZSAqKnNwZWNpYWwgc3RyaW5nKiogYCdzZWxmJ2AgY2FuIGJlIHVzZWQgdG8gbWF0Y2ggYWdhaW5zdCBhbGwgVVJMcyBvZiB0aGUgc2FtZSBkb21haW4gYXMgdGhlCiAgICAgICAgICogICAgIGFwcGxpY2F0aW9uIGRvY3VtZW50IHdpdGggdGhlIHNhbWUgcHJvdG9jb2wgKGFsbG93cyBzb3VyY2luZyBodHRwcyByZXNvdXJjZXMgZnJvbSBodHRwIGRvY3VtZW50cy4pCiAgICAgICAgICoKICAgICAgICAgKiAgICAgUGxlYXNlIG5vdGUgdGhhdCAqKmFuIGVtcHR5IHdoaXRlbGlzdCBhcnJheSB3aWxsIGJsb2NrIGFsbCBVUkxzKiohCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtBcnJheX0gdGhlIGN1cnJlbnRseSBzZXQgd2hpdGVsaXN0IGFycmF5LgogICAgICAgICAqCiAgICAgICAgICogVGhlICoqZGVmYXVsdCB2YWx1ZSoqIHdoZW4gbm8gd2hpdGVsaXN0IGhhcyBiZWVuIGV4cGxpY2l0bHkgc2V0IGlzIGBbJ3NlbGYnXWAuCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTZXRzL0dldHMgdGhlIHdoaXRlbGlzdCBvZiB0cnVzdGVkIHJlc291cmNlIFVSTHMuCiAgICAgICAgICovCiAgICAgICAgdGhpcy5yZXNvdXJjZVVybFdoaXRlbGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmVzb3VyY2VVcmxXaGl0ZWxpc3QgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzb3VyY2VVcmxXaGl0ZWxpc3Q7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybEJsYWNrbGlzdAogICAgICAgICAqIEBtZXRob2RPZiBuZy4kc2NlRGVsZWdhdGVQcm92aWRlcgogICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtBcnJheT19IGJsYWNrbGlzdCBXaGVuIHByb3ZpZGVkLCByZXBsYWNlcyB0aGUgcmVzb3VyY2VVcmxCbGFja2xpc3Qgd2l0aCB0aGUgdmFsdWUKICAgICAgICAgKiAgICAgcHJvdmlkZWQuICBUaGlzIG11c3QgYmUgYW4gYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiAgICAgRWFjaCBlbGVtZW50IG9mIHRoaXMgYXJyYXkgbXVzdCBlaXRoZXIgYmUgYSByZWdleCBvciB0aGUgc3BlY2lhbCBzdHJpbmcgYCdzZWxmJ2AgKHNlZQogICAgICAgICAqICAgICBgcmVzb3VyY2VVcmxXaGl0ZWxpc3RgIGZvciBtZWFuaW5nIC0gaXQncyBvbmx5IHJlYWxseSB1c2VmdWwgdGhlcmUuKQogICAgICAgICAqCiAgICAgICAgICogICAgIFdoZW4gYSByZWdleCBpcyB1c2VkLCBpdCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIG5vcm1hbGl6ZWQgLyBhYnNvbHV0ZSBVUkwgb2YgdGhlIHJlc291cmNlCiAgICAgICAgICogICAgIGJlaW5nIHRlc3RlZC4KICAgICAgICAgKgogICAgICAgICAqICAgICBUaGUgdHlwaWNhbCB1c2FnZSBmb3IgdGhlIGJsYWNrbGlzdCBpcyB0byAqKmJsb2NrIFtvcGVuIHJlZGlyZWN0c10oaHR0cDovL2N3ZS5taXRyZS5vcmcvZGF0YS9kZWZpbml0aW9ucy82MDEuaHRtbCkqKgogICAgICAgICAqICAgICBzZXJ2ZWQgYnkgeW91ciBkb21haW4gYXMgdGhlc2Ugd291bGQgb3RoZXJ3aXNlIGJlIHRydXN0ZWQgYnV0IGFjdHVhbGx5IHJldHVybiBjb250ZW50IGZyb20gdGhlIHJlZGlyZWN0ZWQKICAgICAgICAgKiAgICAgZG9tYWluLgogICAgICAgICAqCiAgICAgICAgICogICAgIEZpbmFsbHksICoqdGhlIGJsYWNrbGlzdCBvdmVycmlkZXMgdGhlIHdoaXRlbGlzdCoqIGFuZCBoYXMgdGhlIGZpbmFsIHNheS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge0FycmF5fSB0aGUgY3VycmVudGx5IHNldCBibGFja2xpc3QgYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgKipkZWZhdWx0IHZhbHVlKiogd2hlbiBubyB3aGl0ZWxpc3QgaGFzIGJlZW4gZXhwbGljaXRseSBzZXQgaXMgdGhlIGVtcHR5IGFycmF5IChpLmUuIHRoZXJlIGlzCiAgICAgICAgICogbm8gYmxhY2tsaXN0LikKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFNldHMvR2V0cyB0aGUgYmxhY2tsaXN0IG9mIHRydXN0ZWQgcmVzb3VyY2UgVVJMcy4KICAgICAgICAgKi8KCiAgICAgICAgdGhpcy5yZXNvdXJjZVVybEJsYWNrbGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmVzb3VyY2VVcmxCbGFja2xpc3QgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzb3VyY2VVcmxCbGFja2xpc3Q7CiAgICAgICAgfTsKCiAgICAgICAgLy8gSGVscGVyIGZ1bmN0aW9ucyBmb3IgbWF0Y2hpbmcgcmVzb3VyY2UgdXJscyBieSBwb2xpY3kuCiAgICAgICAgZnVuY3Rpb24gaXNDb21wYXRpYmxlUHJvdG9jb2woZG9jdW1lbnRQcm90b2NvbCwgcmVzb3VyY2VQcm90b2NvbCkgewogICAgICAgICAgICByZXR1cm4gKChkb2N1bWVudFByb3RvY29sID09PSByZXNvdXJjZVByb3RvY29sKSB8fAogICAgICAgICAgICAgICAgICAgIChkb2N1bWVudFByb3RvY29sID09PSAiaHR0cDoiICYmIHJlc291cmNlUHJvdG9jb2wgPT09ICJodHRwczoiKSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLiRnZXQgPSBbJyRsb2cnLCAnJGRvY3VtZW50JywgJyRpbmplY3RvcicsICckJHVybFV0aWxzJywgZnVuY3Rpb24gKAogICAgICAgICAgICAgICAgICAgICAgJGxvZywgJGRvY3VtZW50LCAkaW5qZWN0b3IsICQkdXJsVXRpbHMpIHsKCiAgICAgICAgICAgIHZhciBodG1sU2FuaXRpemVyID0gZnVuY3Rpb24gaHRtbFNhbml0aXplcihodG1sKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAkc2NlTWluRXJyKCd1bnNhZmUnLCAnQXR0ZW1wdGluZyB0byB1c2UgYW4gdW5zYWZlIHZhbHVlIGluIGEgc2FmZSBjb250ZXh0LicpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKCRpbmplY3Rvci5oYXMoJyRzYW5pdGl6ZScpKSB7CiAgICAgICAgICAgICAgICBodG1sU2FuaXRpemVyID0gJGluamVjdG9yLmdldCgnJHNhbml0aXplJyk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBmdW5jdGlvbiBtYXRjaFVybChtYXRjaGVyLCBwYXJzZWRVcmwpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRjaGVyID09PSAnc2VsZicpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJCR1cmxVdGlscy5pc1NhbWVPcmlnaW4ocGFyc2VkVXJsKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEhcGFyc2VkVXJsLmhyZWYubWF0Y2gobWF0Y2hlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGlzUmVzb3VyY2VVcmxBbGxvd2VkQnlQb2xpY3kodXJsKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkVXJsID0gJCR1cmxVdGlscy5yZXNvbHZlKHVybC50b1N0cmluZygpLCB0cnVlKTsKICAgICAgICAgICAgICAgIHZhciBpLCBuLCBhbGxvd2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhhdCBhdCBsZWFzdCBvbmUgaXRlbSBmcm9tIHRoZSB3aGl0ZWxpc3QgYWxsb3dzIHRoaXMgdXJsLgogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbiA9IHJlc291cmNlVXJsV2hpdGVsaXN0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaFVybChyZXNvdXJjZVVybFdoaXRlbGlzdFtpXSwgcGFyc2VkVXJsKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhbGxvd2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGFsbG93ZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhhdCBubyBpdGVtIGZyb20gdGhlIGJsYWNrbGlzdCBibG9ja2VkIHRoaXMgdXJsLgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIG4gPSByZXNvdXJjZVVybEJsYWNrbGlzdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoVXJsKHJlc291cmNlVXJsQmxhY2tsaXN0W2ldLCBwYXJzZWRVcmwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvd2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhbGxvd2VkOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBnZW5lcmF0ZUhvbGRlclR5cGUoYmFzZSkgewogICAgICAgICAgICAgICAgdmFyIGhvbGRlclR5cGUgPSBmdW5jdGlvbiBUcnVzdGVkVmFsdWVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJCR1bndyYXBUcnVzdGVkVmFsdWUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVzdGVkVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoYmFzZSkgewogICAgICAgICAgICAgICAgICAgIGhvbGRlclR5cGUucHJvdG90eXBlID0gbmV3IGJhc2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGRlclR5cGUucHJvdG90eXBlLnZhbHVlT2YgPSBmdW5jdGlvbiBzY2VWYWx1ZU9mKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiQkdW53cmFwVHJ1c3RlZFZhbHVlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBob2xkZXJUeXBlLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uIHNjZVRvU3RyaW5nKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiQkdW53cmFwVHJ1c3RlZFZhbHVlKCkudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBob2xkZXJUeXBlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSA9IGdlbmVyYXRlSG9sZGVyVHlwZSgpLAogICAgICAgICAgICAgICAgYnlUeXBlID0ge307CgogICAgICAgICAgICBieVR5cGVbU0NFX0NPTlRFWFRTLkhUTUxdID0gZ2VuZXJhdGVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpOwogICAgICAgICAgICBieVR5cGVbU0NFX0NPTlRFWFRTLkNTU10gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICAgICAgICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuVVJMXSA9IGdlbmVyYXRlSG9sZGVyVHlwZSh0cnVzdGVkVmFsdWVIb2xkZXJCYXNlKTsKICAgICAgICAgICAgYnlUeXBlW1NDRV9DT05URVhUUy5KU10gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICAgICAgICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuUkVTT1VSQ0VfVVJMXSA9IGdlbmVyYXRlSG9sZGVyVHlwZShieVR5cGVbU0NFX0NPTlRFWFRTLlVSTF0pOwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2VEZWxlZ2F0ZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogUmV0dXJucyBhbiBvYmplY3QgdGhhdCBpcyB0cnVzdGVkIGJ5IGFuZ3VsYXIgZm9yIHVzZSBpbiBzcGVjaWZpZWQgc3RyaWN0CiAgICAgICAgICAgICAqIGNvbnRleHR1YWwgZXNjYXBpbmcgY29udGV4dHMgKHN1Y2ggYXMgbmctaHRtbC1iaW5kLXVuc2FmZSwgbmctaW5jbHVkZSwgYW55IHNyYwogICAgICAgICAgICAgKiBhdHRyaWJ1dGUgaW50ZXJwb2xhdGlvbiwgYW55IGRvbSBldmVudCBiaW5kaW5nIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uCiAgICAgICAgICAgICAqIHN1Y2ggYXMgZm9yIG9uY2xpY2ssICBldGMuKSB0aGF0IHVzZXMgdGhlIHByb3ZpZGVkIHZhbHVlLgogICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRzY2UgJHNjZX0gZm9yIGVuYWJsaW5nIHN0cmljdCBjb250ZXh0dWFsIGVzY2FwaW5nLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgc2FmZSBmb3IgdXNlLiAgZS5nLiB1cmwsCiAgICAgICAgICAgICAqICAgcmVzb3VyY2VVcmwsIGh0bWwsIGpzIGFuZCBjc3MuCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRoYXQgdGhhdCBzaG91bGQgYmUgY29uc2lkZXJlZCB0cnVzdGVkL3NhZmUuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHsqfSBBIHZhbHVlIHRoYXQgY2FuIGJlIHVzZWQgdG8gc3RhbmQgaW4gZm9yIHRoZSBwcm92aWRlZCBgdmFsdWVgIGluIHBsYWNlcwogICAgICAgICAgICAgKiB3aGVyZSBBbmd1bGFyIGV4cGVjdHMgYSAkc2NlLnRydXN0QXMoKSByZXR1cm4gdmFsdWUuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiB0cnVzdEFzKHR5cGUsIHRydXN0ZWRWYWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gKGJ5VHlwZS5oYXNPd25Qcm9wZXJ0eSh0eXBlKSA/IGJ5VHlwZVt0eXBlXSA6IG51bGwpOwogICAgICAgICAgICAgICAgaWYgKCFjb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2ljb250ZXh0JywgJ0F0dGVtcHRlZCB0byB0cnVzdCBhIHZhbHVlIGluIGludmFsaWQgY29udGV4dC4gQ29udGV4dDogezB9OyBWYWx1ZTogezF9JywKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSwgdHJ1c3RlZFZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0cnVzdGVkVmFsdWUgPT09IG51bGwgfHwgdHJ1c3RlZFZhbHVlID09PSB1bmRlZmluZWQgfHwgdHJ1c3RlZFZhbHVlID09PSAnJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVzdGVkVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBBbGwgdGhlIGN1cnJlbnQgY29udGV4dHMgaW4gU0NFX0NPTlRFWFRTIGhhcHBlbiB0byBiZSBzdHJpbmdzLiAgSW4gb3JkZXIgdG8gYXZvaWQgdHJ1c3RpbmcKICAgICAgICAgICAgICAgIC8vIG11dGFibGUgb2JqZWN0cywgd2UgZW5zdXJlIGhlcmUgdGhhdCB0aGUgdmFsdWUgcGFzc2VkIGluIGlzIGFjdHVhbGx5IGEgc3RyaW5nLgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0cnVzdGVkVmFsdWUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgJHNjZU1pbkVycignaXR5cGUnLAogICAgICAgICAgICAgICAgICAgICAgICAnQXR0ZW1wdGVkIHRvIHRydXN0IGEgbm9uLXN0cmluZyB2YWx1ZSBpbiBhIGNvbnRlbnQgcmVxdWlyaW5nIGEgc3RyaW5nOiBDb250ZXh0OiB7MH0nLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBuZXcgY29uc3RydWN0b3IodHJ1c3RlZFZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZURlbGVnYXRlI3ZhbHVlT2YKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2VEZWxlZ2F0ZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogSWYgdGhlIHBhc3NlZCBwYXJhbWV0ZXIgaGFkIGJlZW4gcmV0dXJuZWQgYnkgYSBwcmlvciBjYWxsIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcwogICAgICAgICAgICAgKiBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSwgcmV0dXJucyB0aGUgdmFsdWUgdGhhdCBoYWQgYmVlbiBwYXNzZWQgdG8ge0BsaW5rCiAgICAgICAgICAgICAqIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBJZiB0aGUgcGFzc2VkIHBhcmFtZXRlciBpcyBub3QgYSB2YWx1ZSB0aGF0IGhhZCBiZWVuIHJldHVybmVkIGJ5IHtAbGluawogICAgICAgICAgICAgKiBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSwgcmV0dXJucyBpdCBhcy1pcy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgcmVzdWx0IG9mIGEgcHJpb3Ige0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9CiAgICAgICAgICAgICAqICAgICAgY2FsbCBvciBhbnl0aGluZyBlbHNlLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHZhbHVlIHRoZSB3YXMgb3JpZ2luYWxseSBwcm92aWRlZCB0byB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAgICAgICAgICogICAgIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9IGlmIGB2YWx1ZWAgaXMgdGhlIHJlc3VsdCBvZiBzdWNoIGEgY2FsbC4gIE90aGVyd2lzZSwgcmV0dXJucyBgdmFsdWVgCiAgICAgICAgICAgICAqICAgICB1bmNoYW5nZWQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiB2YWx1ZU9mKG1heWJlVHJ1c3RlZCkgewogICAgICAgICAgICAgICAgaWYgKG1heWJlVHJ1c3RlZCBpbnN0YW5jZW9mIHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWF5YmVUcnVzdGVkLiQkdW53cmFwVHJ1c3RlZFZhbHVlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kc2NlRGVsZWdhdGUKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFRha2VzIHRoZSByZXN1bHQgb2YgYSB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gY2FsbCBhbmQgcmV0dXJucyB0aGUKICAgICAgICAgICAgICogb3JpZ2luYWxseSBzdXBwbGllZCB2YWx1ZSBpZiB0aGUgcXVlcmllZCBjb250ZXh0IHR5cGUgaXMgYSBzdXBlcnR5cGUgb2YgdGhlIGNyZWF0ZWQgdHlwZS4gIElmCiAgICAgICAgICAgICAqIHRoaXMgY29uZGl0aW9uIGlzbid0IHNhdGlzZmllZCwgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgY29udGV4dCBpbiB3aGljaCB0aGlzIHZhbHVlIGlzIHRvIGJlIHVzZWQuCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gbWF5YmVUcnVzdGVkIFRoZSByZXN1bHQgb2YgYSBwcmlvciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAgICAgICAgICogYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gY2FsbC4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSB2YWx1ZSB0aGUgd2FzIG9yaWdpbmFsbHkgcHJvdmlkZWQgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgICAgICAgICAqICAgICBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSBpZiB2YWxpZCBpbiB0aGlzIGNvbnRleHQuICBPdGhlcndpc2UsIHRocm93cyBhbiBleGNlcHRpb24uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiBnZXRUcnVzdGVkKHR5cGUsIG1heWJlVHJ1c3RlZCkgewogICAgICAgICAgICAgICAgaWYgKG1heWJlVHJ1c3RlZCA9PT0gbnVsbCB8fCBtYXliZVRydXN0ZWQgPT09IHVuZGVmaW5lZCB8fCBtYXliZVRydXN0ZWQgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjb25zdHJ1Y3RvciA9IChieVR5cGUuaGFzT3duUHJvcGVydHkodHlwZSkgPyBieVR5cGVbdHlwZV0gOiBudWxsKTsKICAgICAgICAgICAgICAgIGlmIChjb25zdHJ1Y3RvciAmJiBtYXliZVRydXN0ZWQgaW5zdGFuY2VvZiBjb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQuJCR1bndyYXBUcnVzdGVkVmFsdWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElmIHdlIGdldCBoZXJlLCB0aGVuIHdlIG1heSBvbmx5IHRha2Ugb25lIG9mIHR3byBhY3Rpb25zLgogICAgICAgICAgICAgICAgLy8gMS4gc2FuaXRpemUgdGhlIHZhbHVlIGZvciB0aGUgcmVxdWVzdGVkIHR5cGUsIG9yCiAgICAgICAgICAgICAgICAvLyAyLiB0aHJvdyBhbiBleGNlcHRpb24uCiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gU0NFX0NPTlRFWFRTLlJFU09VUkNFX1VSTCkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1Jlc291cmNlVXJsQWxsb3dlZEJ5UG9saWN5KG1heWJlVHJ1c3RlZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkc2NlTWluRXJyKCdpbnNlY3VybCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQmxvY2tlZCBsb2FkaW5nIHJlc291cmNlIGZyb20gdXJsIG5vdCBhbGxvd2VkIGJ5ICRzY2VEZWxlZ2F0ZSBwb2xpY3kuICBVUkw6IHswfScsIG1heWJlVHJ1c3RlZC50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09IFNDRV9DT05URVhUUy5IVE1MKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGh0bWxTYW5pdGl6ZXIobWF5YmVUcnVzdGVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ3Vuc2FmZScsICdBdHRlbXB0aW5nIHRvIHVzZSBhbiB1bnNhZmUgdmFsdWUgaW4gYSBzYWZlIGNvbnRleHQuJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB0cnVzdEFzOiB0cnVzdEFzLAogICAgICAgICAgICAgICAgZ2V0VHJ1c3RlZDogZ2V0VHJ1c3RlZCwKICAgICAgICAgICAgICAgIHZhbHVlT2Y6IHZhbHVlT2YKICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSBuZy4kc2NlUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFRoZSAkc2NlUHJvdmlkZXIgcHJvdmlkZXIgYWxsb3dzIGRldmVsb3BlcnMgdG8gY29uZmlndXJlIHRoZSB7QGxpbmsgbmcuJHNjZSAkc2NlfSBzZXJ2aWNlLgogICAgICogLSAgIGVuYWJsZS9kaXNhYmxlIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpIGluIGEgbW9kdWxlCiAgICAgKiAtICAgb3ZlcnJpZGUgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gd2l0aCBhIGN1c3RvbSBkZWxlZ2F0ZQogICAgICoKICAgICAqIFJlYWQgbW9yZSBhYm91dCB7QGxpbmsgbmcuJHNjZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0uCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgKiBAbmFtZSBuZy4kc2NlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBgJHNjZWAgaXMgYSBzZXJ2aWNlIHRoYXQgcHJvdmlkZXMgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgc2VydmljZXMgdG8gQW5ndWxhckpTLgogICAgICoKICAgICAqICMgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcKICAgICAqCiAgICAgKiBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKSBpcyBhIG1vZGUgaW4gd2hpY2ggQW5ndWxhckpTIHJlcXVpcmVzIGJpbmRpbmdzIGluIGNlcnRhaW4KICAgICAqIGNvbnRleHRzIHRvIHJlc3VsdCBpbiBhIHZhbHVlIHRoYXQgaXMgbWFya2VkIGFzIHNhZmUgdG8gdXNlIGZvciB0aGF0IGNvbnRleHQgT25lIGV4YW1wbGUgb2Ygc3VjaAogICAgICogYSBjb250ZXh0IGlzIGJpbmRpbmcgYXJiaXRyYXJ5IGh0bWwgY29udHJvbGxlZCBieSB0aGUgdXNlciB2aWEgYG5nLWJpbmQtaHRtbGAuICBXZSByZWZlciB0byB0aGVzZQogICAgICogY29udGV4dHMgYXMgcHJpdmlsZWdlZCBvciBTQ0UgY29udGV4dHMuCiAgICAgKgogICAgICogQXMgb2YgdmVyc2lvbiAxLjIsIEFuZ3VsYXIgc2hpcHMgd2l0aCBTQ0UgZW5hYmxlZCBieSBkZWZhdWx0LgogICAgICoKICAgICAqIE5vdGU6ICBXaGVuIGVuYWJsZWQgKHRoZSBkZWZhdWx0KSwgSUU4IGluIHF1aXJrcyBtb2RlIGlzIG5vdCBzdXBwb3J0ZWQuICBJbiB0aGlzIG1vZGUsIElFOCBhbGxvd3MKICAgICAqIG9uZSB0byBleGVjdXRlIGFyYml0cmFyeSBqYXZhc2NyaXB0IGJ5IHRoZSB1c2Ugb2YgdGhlIGV4cHJlc3Npb24oKSBzeW50YXguICBSZWZlcgogICAgICogPGh0dHA6Ly9ibG9ncy5tc2RuLmNvbS9iL2llL2FyY2hpdmUvMjAwOC8xMC8xNi9lbmRpbmctZXhwcmVzc2lvbnMuYXNweD4gdG8gbGVhcm4gbW9yZSBhYm91dCB0aGVtLgogICAgICogWW91IGNhbiBlbnN1cmUgeW91ciBkb2N1bWVudCBpcyBpbiBzdGFuZGFyZHMgbW9kZSBhbmQgbm90IHF1aXJrcyBtb2RlIGJ5IGFkZGluZyBgPCFkb2N0eXBlIGh0bWw+YAogICAgICogdG8gdGhlIHRvcCBvZiB5b3VyIEhUTUwgZG9jdW1lbnQuCiAgICAgKgogICAgICogU0NFIGFzc2lzdHMgaW4gd3JpdGluZyBjb2RlIGluIHdheSB0aGF0IChhKSBpcyBzZWN1cmUgYnkgZGVmYXVsdCBhbmQgKGIpIG1ha2VzIGF1ZGl0aW5nIGZvcgogICAgICogc2VjdXJpdHkgdnVsbmVyYWJpbGl0aWVzIHN1Y2ggYXMgWFNTLCBjbGlja2phY2tpbmcsIGV0Yy4gYSBsb3QgZWFzaWVyLgogICAgICoKICAgICAqIEhlcmUncyBhbiBleGFtcGxlIG9mIGEgYmluZGluZyBpbiBhIHByaXZpbGVnZWQgY29udGV4dDoKICAgICAqCiAgICAgKiA8cHJlIGNsYXNzPSJwcmV0dHlwcmludCI+CiAgICAgKiAgICAgPGlucHV0IG5nLW1vZGVsPSJ1c2VySHRtbCI+CiAgICAgKiAgICAgPGRpdiBuZy1iaW5kLWh0bWw9Int7dXNlckh0bWx9fSI+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBOb3RpY2UgdGhhdCBgbmctYmluZC1odG1sYCBpcyBib3VuZCB0byBge3t1c2VySHRtbH19YCBjb250cm9sbGVkIGJ5IHRoZSB1c2VyLiAgV2l0aCBTQ0UKICAgICAqIGRpc2FibGVkLCB0aGlzIGFwcGxpY2F0aW9uIGFsbG93cyB0aGUgdXNlciB0byByZW5kZXIgYXJiaXRyYXJ5IEhUTUwgaW50byB0aGUgRElWLgogICAgICogSW4gYSBtb3JlIHJlYWxpc3RpYyBleGFtcGxlLCBvbmUgbWF5IGJlIHJlbmRlcmluZyB1c2VyIGNvbW1lbnRzLCBibG9nIGFydGljbGVzLCBldGMuIHZpYQogICAgICogYmluZGluZ3MuICAoSFRNTCBpcyBqdXN0IG9uZSBleGFtcGxlIG9mIGEgY29udGV4dCB3aGVyZSByZW5kZXJpbmcgdXNlciBjb250cm9sbGVkIGlucHV0IGNyZWF0ZXMKICAgICAqIHNlY3VyaXR5IHZ1bG5lcmFiaWxpdGllcy4pCiAgICAgKgogICAgICogRm9yIHRoZSBjYXNlIG9mIEhUTUwsIHlvdSBtaWdodCB1c2UgYSBsaWJyYXJ5LCBlaXRoZXIgb24gdGhlIGNsaWVudCBzaWRlLCBvciBvbiB0aGUgc2VydmVyIHNpZGUsCiAgICAgKiB0byBzYW5pdGl6ZSB1bnNhZmUgSFRNTCBiZWZvcmUgYmluZGluZyB0byB0aGUgdmFsdWUgYW5kIHJlbmRlcmluZyBpdCBpbiB0aGUgZG9jdW1lbnQuCiAgICAgKgogICAgICogSG93IHdvdWxkIHlvdSBlbnN1cmUgdGhhdCBldmVyeSBwbGFjZSB0aGF0IHVzZWQgdGhlc2UgdHlwZXMgb2YgYmluZGluZ3Mgd2FzIGJvdW5kIHRvIGEgdmFsdWUgdGhhdAogICAgICogd2FzIHNhbml0aXplZCBieSB5b3VyIGxpYnJhcnkgKG9yIHJldHVybmVkIGFzIHNhZmUgZm9yIHJlbmRlcmluZyBieSB5b3VyIHNlcnZlcj8pICBIb3cgY2FuIHlvdQogICAgICogZW5zdXJlIHRoYXQgeW91IGRpZG4ndCBhY2NpZGVudGFsbHkgZGVsZXRlIHRoZSBsaW5lIHRoYXQgc2FuaXRpemVkIHRoZSB2YWx1ZSwgb3IgcmVuYW1lZCBzb21lCiAgICAgKiBwcm9wZXJ0aWVzL2ZpZWxkcyBhbmQgZm9yZ290IHRvIHVwZGF0ZSB0aGUgYmluZGluZyB0byB0aGUgc2FuaXRpemVkIHZhbHVlPwogICAgICoKICAgICAqIFRvIGJlIHNlY3VyZSBieSBkZWZhdWx0LCB5b3Ugd2FudCB0byBlbnN1cmUgdGhhdCBhbnkgc3VjaCBiaW5kaW5ncyBhcmUgZGlzYWxsb3dlZCB1bmxlc3MgeW91IGNhbgogICAgICogZGV0ZXJtaW5lIHRoYXQgc29tZXRoaW5nIGV4cGxpY2l0bHkgc2F5cyBpdCdzIHNhZmUgdG8gdXNlIGEgdmFsdWUgZm9yIGJpbmRpbmcgaW4gdGhhdAogICAgICogY29udGV4dC4gIFlvdSBjYW4gdGhlbiBhdWRpdCB5b3VyIGNvZGUgKGEgc2ltcGxlIGdyZXAgd291bGQgZG8pIHRvIGVuc3VyZSB0aGF0IHRoaXMgaXMgb25seSBkb25lCiAgICAgKiBmb3IgdGhvc2UgdmFsdWVzIHRoYXQgeW91IGNhbiBlYXNpbHkgdGVsbCBhcmUgc2FmZSAtIGJlY2F1c2UgdGhleSB3ZXJlIHJlY2VpdmVkIGZyb20geW91ciBzZXJ2ZXIsCiAgICAgKiBzYW5pdGl6ZWQgYnkgeW91ciBsaWJyYXJ5LCBldGMuICBZb3UgY2FuIG9yZ2FuaXplIHlvdXIgY29kZWJhc2UgdG8gaGVscCB3aXRoIHRoaXMgLSBwZXJoYXBzCiAgICAgKiBhbGxvd2luZyBvbmx5IHRoZSBmaWxlcyBpbiBhIHNwZWNpZmljIGRpcmVjdG9yeSB0byBkbyB0aGlzLiAgRW5zdXJpbmcgdGhhdCB0aGUgaW50ZXJuYWwgQVBJCiAgICAgKiBleHBvc2VkIGJ5IHRoYXQgY29kZSBkb2Vzbid0IG1hcmt1cCBhcmJpdHJhcnkgdmFsdWVzIGFzIHNhZmUgdGhlbiBiZWNvbWVzIGEgbW9yZSBtYW5hZ2VhYmxlIHRhc2suCiAgICAgKgogICAgICogSW4gdGhlIGNhc2Ugb2YgQW5ndWxhckpTJyBTQ0Ugc2VydmljZSwgb25lIHVzZXMge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9IChhbmQgc2hvcnRoYW5kCiAgICAgKiBtZXRob2RzIHN1Y2ggYXMge0BsaW5rIG5nLiRzY2UjdHJ1c3RBc0h0bWwgJHNjZS50cnVzdEFzSHRtbH0sIGV0Yy4pIHRvIG9idGFpbiB2YWx1ZXMgdGhhdCB3aWxsIGJlCiAgICAgKiBhY2NlcHRlZCBieSBTQ0UgLyBwcml2aWxlZ2VkIGNvbnRleHRzLgogICAgICoKICAgICAqCiAgICAgKiAjIyBIb3cgZG9lcyBpdCB3b3JrPwogICAgICoKICAgICAqIEluIHByaXZpbGVnZWQgY29udGV4dHMsIGRpcmVjdGl2ZXMgYW5kIGNvZGUgd2lsbCBiaW5kIHRvIHRoZSByZXN1bHQgb2Yge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZAogICAgICogJHNjZS5nZXRUcnVzdGVkKGNvbnRleHQsIHZhbHVlKX0gcmF0aGVyIHRoYW4gdG8gdGhlIHZhbHVlIGRpcmVjdGx5LiAgRGlyZWN0aXZlcyB1c2Uge0BsaW5rCiAgICAgKiBuZy4kc2NlI3BhcnNlICRzY2UucGFyc2VBc30gcmF0aGVyIHRoYW4gYCRwYXJzZWAgdG8gd2F0Y2ggYXR0cmlidXRlIGJpbmRpbmdzLCB3aGljaCBwZXJmb3JtcyB0aGUKICAgICAqIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWQgJHNjZS5nZXRUcnVzdGVkfSBiZWhpbmQgdGhlIHNjZW5lcyBvbiBub24tY29uc3RhbnQgbGl0ZXJhbHMuCiAgICAgKgogICAgICogQXMgYW4gZXhhbXBsZSwge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0JpbmRIdG1sIG5nQmluZEh0bWx9IHVzZXMge0BsaW5rCiAgICAgKiBuZy4kc2NlI3BhcnNlQXNIdG1sICRzY2UucGFyc2VBc0h0bWwoYmluZGluZyBleHByZXNzaW9uKX0uICBIZXJlJ3MgdGhlIGFjdHVhbCBjb2RlIChzbGlnaHRseQogICAgICogc2ltcGxpZmllZCk6CiAgICAgKgogICAgICogPHByZSBjbGFzcz0icHJldHR5cHJpbnQiPgogICAgICogICB2YXIgbmdCaW5kSHRtbERpcmVjdGl2ZSA9IFsnJHNjZScsIGZ1bmN0aW9uKCRzY2UpIHsKICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAqICAgICAgIHNjb3BlLiR3YXRjaCgkc2NlLnBhcnNlQXNIdG1sKGF0dHIubmdCaW5kSHRtbCksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgKiAgICAgICAgIGVsZW1lbnQuaHRtbCh2YWx1ZSB8fCAnJyk7CiAgICAgKiAgICAgICB9KTsKICAgICAqICAgICB9OwogICAgICogICB9XTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqICMjIEltcGFjdCBvbiBsb2FkaW5nIHRlbXBsYXRlcwogICAgICoKICAgICAqIFRoaXMgYXBwbGllcyBib3RoIHRvIHRoZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSBgbmctaW5jbHVkZWB9IGRpcmVjdGl2ZSBhcyB3ZWxsIGFzCiAgICAgKiBgdGVtcGxhdGVVcmxgJ3Mgc3BlY2lmaWVkIGJ5IHtAbGluayBndWlkZS9kaXJlY3RpdmUgZGlyZWN0aXZlc30uCiAgICAgKgogICAgICogQnkgZGVmYXVsdCwgQW5ndWxhciBvbmx5IGxvYWRzIHRlbXBsYXRlcyBmcm9tIHRoZSBzYW1lIGRvbWFpbiBhbmQgcHJvdG9jb2wgYXMgdGhlIGFwcGxpY2F0aW9uCiAgICAgKiBkb2N1bWVudC4gIFRoaXMgaXMgZG9uZSBieSBjYWxsaW5nIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRSZXNvdXJjZVVybAogICAgICogJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmx9IG9uIHRoZSB0ZW1wbGF0ZSBVUkwuICBUbyBsb2FkIHRlbXBsYXRlcyBmcm9tIG90aGVyIGRvbWFpbnMgYW5kL29yCiAgICAgKiBwcm90b2NvbHMsIHlvdSBtYXkgZWl0aGVyIGVpdGhlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3Qgd2hpdGVsaXN0CiAgICAgKiB0aGVtfSBvciB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzUmVzb3VyY2VVcmwgd3JhcCBpdH0gaW50byBhIHRydXN0ZWQgdmFsdWUuCiAgICAgKgogICAgICogKlBsZWFzZSBub3RlKjoKICAgICAqIFRoZSBicm93c2VyJ3MKICAgICAqIHtAbGluayBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Jyb3dzZXJzZWMvd2lraS9QYXJ0MiNTYW1lLW9yaWdpbl9wb2xpY3lfZm9yX1hNTEh0dHBSZXF1ZXN0CiAgICAgKiBTYW1lIE9yaWdpbiBQb2xpY3l9IGFuZCB7QGxpbmsgaHR0cDovL3d3dy53My5vcmcvVFIvY29ycy8gQ3Jvc3MtT3JpZ2luIFJlc291cmNlIFNoYXJpbmcgKENPUlMpfQogICAgICogcG9saWN5IGFwcGx5IGluIGFkZGl0aW9uIHRvIHRoaXMgYW5kIG1heSBmdXJ0aGVyIHJlc3RyaWN0IHdoZXRoZXIgdGhlIHRlbXBsYXRlIGlzIHN1Y2Nlc3NmdWxseQogICAgICogbG9hZGVkLiAgVGhpcyBtZWFucyB0aGF0IHdpdGhvdXQgdGhlIHJpZ2h0IENPUlMgcG9saWN5LCBsb2FkaW5nIHRlbXBsYXRlcyBmcm9tIGEgZGlmZmVyZW50IGRvbWFpbgogICAgICogd29uJ3Qgd29yayBvbiBhbGwgYnJvd3NlcnMuICBBbHNvLCBsb2FkaW5nIHRlbXBsYXRlcyBmcm9tIGBmaWxlOi8vYCBVUkwgZG9lcyBub3Qgd29yayBvbiBzb21lCiAgICAgKiBicm93c2Vycy4KICAgICAqCiAgICAgKiAjIyBUaGlzIGZlZWxzIGxpa2UgdG9vIG11Y2ggb3ZlcmhlYWQgZm9yIHRoZSBkZXZlbG9wZXI/CiAgICAgKgogICAgICogSXQncyBpbXBvcnRhbnQgdG8gcmVtZW1iZXIgdGhhdCBTQ0Ugb25seSBhcHBsaWVzIHRvIGludGVycG9sYXRpb24gZXhwcmVzc2lvbnMuCiAgICAgKgogICAgICogSWYgeW91ciBleHByZXNzaW9ucyBhcmUgY29uc3RhbnQgbGl0ZXJhbHMsIHRoZXkncmUgYXV0b21hdGljYWxseSB0cnVzdGVkIGFuZCB5b3UgZG9uJ3QgbmVlZCB0bwogICAgICogY2FsbCBgJHNjZS50cnVzdEFzYCBvbiB0aGVtLiAgKGUuZy4KICAgICAqIGA8ZGl2IG5nLWh0bWwtYmluZC11bnNhZmU9Iic8Yj5pbXBsaWNpdGx5IHRydXN0ZWQ8L2I+JyI+PC9kaXY+YCkganVzdCB3b3Jrcy4KICAgICAqCiAgICAgKiBBZGRpdGlvbmFsbHksIGBhW2hyZWZdYCBhbmQgYGltZ1tzcmNdYCBhdXRvbWF0aWNhbGx5IHNhbml0aXplIHRoZWlyIFVSTHMgYW5kIGRvIG5vdCBwYXNzIHRoZW0KICAgICAqIHRocm91Z2gge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWR9LiAgU0NFIGRvZXNuJ3QgcGxheSBhIHJvbGUgaGVyZS4KICAgICAqCiAgICAgKiBUaGUgaW5jbHVkZWQge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSAkc2NlRGVsZWdhdGV9IGNvbWVzIHdpdGggc2FuZSBkZWZhdWx0cyB0byBhbGxvdyB5b3UgdG8gbG9hZAogICAgICogdGVtcGxhdGVzIGluIGBuZy1pbmNsdWRlYCBmcm9tIHlvdXIgYXBwbGljYXRpb24ncyBkb21haW4gd2l0aG91dCBoYXZpbmcgdG8gZXZlbiBrbm93IGFib3V0IFNDRS4KICAgICAqIEl0IGJsb2NrcyBsb2FkaW5nIHRlbXBsYXRlcyBmcm9tIG90aGVyIGRvbWFpbnMgb3IgbG9hZGluZyB0ZW1wbGF0ZXMgb3ZlciBodHRwIGZyb20gYW4gaHR0cHMKICAgICAqIHNlcnZlZCBkb2N1bWVudC4gIFlvdSBjYW4gY2hhbmdlIHRoZXNlIGJ5IHNldHRpbmcgeW91ciBvd24gY3VzdG9tIHtAbGluawogICAgICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3Qgd2hpdGVsaXN0c30gYW5kIHtAbGluawogICAgICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgYmxhY2tsaXN0c30gZm9yIG1hdGNoaW5nIHN1Y2ggVVJMcy4KICAgICAqCiAgICAgKiBUaGlzIHNpZ25pZmljYW50bHkgcmVkdWNlcyB0aGUgb3ZlcmhlYWQuICBJdCBpcyBmYXIgZWFzaWVyIHRvIHBheSB0aGUgc21hbGwgb3ZlcmhlYWQgYW5kIGhhdmUgYW4KICAgICAqIGFwcGxpY2F0aW9uIHRoYXQncyBzZWN1cmUgYW5kIGNhbiBiZSBhdWRpdGVkIHRvIHZlcmlmeSB0aGF0IHdpdGggbXVjaCBtb3JlIGVhc2UgdGhhbiBib2x0aW5nCiAgICAgKiBzZWN1cml0eSBvbnRvIGFuIGFwcGxpY2F0aW9uIGxhdGVyLgogICAgICoKICAgICAqICMjIFdoYXQgdHJ1c3RlZCBjb250ZXh0IHR5cGVzIGFyZSBzdXBwb3J0ZWQ/PGEgbmFtZT0iY29udGV4dHMiPjwvYT4KICAgICAqCiAgICAgKiB8IENvbnRleHQgICAgICAgICAgICAgfCBOb3RlcyAgICAgICAgICB8CiAgICAgKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS18CiAgICAgKiB8IGAkc2NlLkhUTUxgICAgICAgICAgfCBGb3IgSFRNTCB0aGF0J3Mgc2FmZSB0byBzb3VyY2UgaW50byB0aGUgYXBwbGljYXRpb24uICBUaGUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0JpbmRIdG1sIG5nQmluZEh0bWx9IGRpcmVjdGl2ZSB1c2VzIHRoaXMgY29udGV4dCBmb3IgYmluZGluZ3MuIHwKICAgICAqIHwgYCRzY2UuQ1NTYCAgICAgICAgICB8IEZvciBDU1MgdGhhdCdzIHNhZmUgdG8gc291cmNlIGludG8gdGhlIGFwcGxpY2F0aW9uLiAgQ3VycmVudGx5IHVudXNlZC4gIEZlZWwgZnJlZSB0byB1c2UgaXQgaW4geW91ciBvd24gZGlyZWN0aXZlcy4gfAogICAgICogfCBgJHNjZS5VUkxgICAgICAgICAgIHwgRm9yIFVSTHMgdGhhdCBhcmUgc2FmZSB0byBmb2xsb3cgYXMgbGlua3MuICBDdXJyZW50bHkgdW51c2VkIChgPGEgaHJlZj1gIGFuZCBgPGltZyBzcmM9YCBzYW5pdGl6ZSB0aGVpciB1cmxzIGFuZCBkb24ndCBjb25zaXRpdHV0ZSBhbiBTQ0UgY29udGV4dC4gfAogICAgICogfCBgJHNjZS5SRVNPVVJDRV9VUkxgIHwgRm9yIFVSTHMgdGhhdCBhcmUgbm90IG9ubHkgc2FmZSB0byBmb2xsb3cgYXMgbGlua3MsIGJ1dCB3aG9zZSBjb250ZW5zIGFyZSBhbHNvIHNhZmUgdG8gaW5jbHVkZSBpbiB5b3VyIGFwcGxpY2F0aW9uLiAgRXhhbXBsZXMgaW5jbHVkZSBgbmctaW5jbHVkZWAsIGBzcmNgIC8gYG5nU3JjYCBiaW5kaW5ncyBmb3IgdGFncyBvdGhlciB0aGFuIGBJTUdgIChlLmcuIGBJRlJBTUVgLCBgT0JKRUNUYCwgZXRjLikgIDxicj48YnI+Tm90ZSB0aGF0IGAkc2NlLlJFU09VUkNFX1VSTGAgbWFrZXMgYSBzdHJvbmdlciBzdGF0ZW1lbnQgYWJvdXQgdGhlIFVSTCB0aGFuIGAkc2NlLlVSTGAgZG9lcyBhbmQgdGhlcmVmb3JlIGNvbnRleHRzIHJlcXVpcmluZyB2YWx1ZXMgdHJ1c3RlZCBmb3IgYCRzY2UuUkVTT1VSQ0VfVVJMYCBjYW4gYmUgdXNlZCBhbnl3aGVyZSB0aGF0IHZhbHVlcyB0cnVzdGVkIGZvciBgJHNjZS5VUkxgIGFyZSByZXF1aXJlZC4gfAogICAgICogfCBgJHNjZS5KU2AgICAgICAgICAgIHwgRm9yIEphdmFTY3JpcHQgdGhhdCBpcyBzYWZlIHRvIGV4ZWN1dGUgaW4geW91ciBhcHBsaWNhdGlvbidzIGNvbnRleHQuICBDdXJyZW50bHkgdW51c2VkLiAgRmVlbCBmcmVlIHRvIHVzZSBpdCBpbiB5b3VyIG93biBkaXJlY3RpdmVzLiB8CiAgICAgKgogICAgICogIyMgU2hvdyBtZSBhbiBleGFtcGxlLgogICAgICoKICAgICAqCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZSBtb2R1bGU9Im15U2NlQXBwIj4KICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJteUFwcENvbnRyb2xsZXIgYXMgbXlDdHJsIj4KICAgICAgICAgIDxpIG5nLWJpbmQtaHRtbD0ibXlDdHJsLmV4cGxpY2l0bHlUcnVzdGVkSHRtbCIgaWQ9ImV4cGxpY2l0bHlUcnVzdGVkSHRtbCI+PC9pPjxicj48YnI+CiAgICAgICAgICA8Yj5Vc2VyIGNvbW1lbnRzPC9iPjxicj4KICAgICAgICAgIEJ5IGRlZmF1bHQsIEhUTUwgdGhhdCBpc24ndCBleHBsaWNpdGx5IHRydXN0ZWQgKGUuZy4gQWxpY2UncyBjb21tZW50KSBpcyBzYW5pdGl6ZWQgd2hlbiAkc2FuaXRpemUgaXMgYXZhaWxhYmxlLiAgSWYgJHNhbml0aXplIGlzbid0IGF2YWlsYWJsZSwgdGhpcyByZXN1bHRzIGluIGFuIGVycm9yIGluc3RlYWQgb2YgYW4gZXhwbG9pdC4KICAgICAgICAgIDxkaXYgY2xhc3M9IndlbGwiPgogICAgICAgICAgICA8ZGl2IG5nLXJlcGVhdD0idXNlckNvbW1lbnQgaW4gbXlDdHJsLnVzZXJDb21tZW50cyI+CiAgICAgICAgICAgICAgPGI+e3t1c2VyQ29tbWVudC5uYW1lfX08L2I+OgogICAgICAgICAgICAgIDxzcGFuIG5nLWJpbmQtaHRtbD0idXNlckNvbW1lbnQuaHRtbENvbW1lbnQiIGNsYXNzPSJodG1sQ29tbWVudCI+PC9zcGFuPgogICAgICAgICAgICAgIDxicj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9maWxlPgogICAgCiAgICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICAgdmFyIG15U2NlQXBwID0gYW5ndWxhci5tb2R1bGUoJ215U2NlQXBwJywgWyduZ1Nhbml0aXplJ10pOwogICAgCiAgICAgICAgbXlTY2VBcHAuY29udHJvbGxlcigibXlBcHBDb250cm9sbGVyIiwgZnVuY3Rpb24gbXlBcHBDb250cm9sbGVyKCRodHRwLCAkdGVtcGxhdGVDYWNoZSwgJHNjZSkgewogICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgJGh0dHAuZ2V0KCJ0ZXN0X2RhdGEuanNvbiIsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS5zdWNjZXNzKGZ1bmN0aW9uKHVzZXJDb21tZW50cykgewogICAgICAgICAgICBzZWxmLnVzZXJDb21tZW50cyA9IHVzZXJDb21tZW50czsKICAgICAgICAgIH0pOwogICAgICAgICAgc2VsZi5leHBsaWNpdGx5VHJ1c3RlZEh0bWwgPSAkc2NlLnRydXN0QXNIdG1sKAogICAgICAgICAgICAgICc8c3BhbiBvbm1vdXNlb3Zlcj0idGhpcy50ZXh0Q29udGVudD0mcXVvdDtFeHBsaWNpdGx5IHRydXN0ZWQgSFRNTCBieXBhc3NlcyAnICsKICAgICAgICAgICAgICAnc2FuaXRpemF0aW9uLiZxdW90OyI+SG92ZXIgb3ZlciB0aGlzIHRleHQuPC9zcGFuPicpOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICAKICAgICAgPGZpbGUgbmFtZT0idGVzdF9kYXRhLmpzb24iPgogICAgICAgIFsKICAgICAgICAgIHsgIm5hbWUiOiAiQWxpY2UiLAogICAgICAgICAgICAiaHRtbENvbW1lbnQiOiAiPHNwYW4gb25tb3VzZW92ZXI9J3RoaXMudGV4dENvbnRlbnQ9XCJQV04zRCFcIic+SXMgPGk+YW55b25lPC9pPiByZWFkaW5nIHRoaXM/PC9zcGFuPiIKICAgICAgICAgIH0sCiAgICAgICAgICB7ICJuYW1lIjogIkJvYiIsCiAgICAgICAgICAgICJodG1sQ29tbWVudCI6ICI8aT5ZZXMhPC9pPiAgQW0gSSB0aGUgb25seSBvdGhlciBvbmU/IgogICAgICAgICAgfQogICAgICAgIF0KICAgICAgPC9maWxlPgogICAgCiAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICBkZXNjcmliZSgnU0NFIGRvYyBkZW1vJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpdCgnc2hvdWxkIHNhbml0aXplIHVudHJ1c3RlZCB2YWx1ZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5odG1sQ29tbWVudCcpLmh0bWwoKSkudG9CZSgnPHNwYW4+SXMgPGk+YW55b25lPC9pPiByZWFkaW5nIHRoaXM/PC9zcGFuPicpOwogICAgICAgICAgfSk7CiAgICAgICAgICBpdCgnc2hvdWxkIE5PVCBzYW5pdGl6ZSBleHBsaWNpdGx5IHRydXN0ZWQgdmFsdWVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjZXhwbGljaXRseVRydXN0ZWRIdG1sJykuaHRtbCgpKS50b0JlKAogICAgICAgICAgICAgICAgJzxzcGFuIG9ubW91c2VvdmVyPSJ0aGlzLnRleHRDb250ZW50PSZxdW90O0V4cGxpY2l0bHkgdHJ1c3RlZCBIVE1MIGJ5cGFzc2VzICcgKwogICAgICAgICAgICAgICAgJ3Nhbml0aXphdGlvbi4mcXVvdDsiPkhvdmVyIG92ZXIgdGhpcyB0ZXh0Ljwvc3Bhbj4nKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICoKICAgICAqCiAgICAgKgogICAgICogIyMgQ2FuIEkgZGlzYWJsZSBTQ0UgY29tcGxldGVseT8KICAgICAqCiAgICAgKiBZZXMsIHlvdSBjYW4uICBIb3dldmVyLCB0aGlzIGlzIHN0cm9uZ2x5IGRpc2NvdXJhZ2VkLiAgU0NFIGdpdmVzIHlvdSBhIGxvdCBvZiBzZWN1cml0eSBiZW5lZml0cwogICAgICogZm9yIGxpdHRsZSBjb2Rpbmcgb3ZlcmhlYWQuICBJdCB3aWxsIGJlIG11Y2ggaGFyZGVyIHRvIHRha2UgYW4gU0NFIGRpc2FibGVkIGFwcGxpY2F0aW9uIGFuZAogICAgICogZWl0aGVyIHNlY3VyZSBpdCBvbiB5b3VyIG93biBvciBlbmFibGUgU0NFIGF0IGEgbGF0ZXIgc3RhZ2UuICBJdCBtaWdodCBtYWtlIHNlbnNlIHRvIGRpc2FibGUgU0NFCiAgICAgKiBmb3IgY2FzZXMgd2hlcmUgeW91IGhhdmUgYSBsb3Qgb2YgZXhpc3RpbmcgY29kZSB0aGF0IHdhcyB3cml0dGVuIGJlZm9yZSBTQ0Ugd2FzIGludHJvZHVjZWQgYW5kCiAgICAgKiB5b3UncmUgbWlncmF0aW5nIHRoZW0gYSBtb2R1bGUgYXQgYSB0aW1lLgogICAgICoKICAgICAqIFRoYXQgc2FpZCwgaGVyZSdzIGhvdyB5b3UgY2FuIGNvbXBsZXRlbHkgZGlzYWJsZSBTQ0U6CiAgICAgKgogICAgICogPHByZSBjbGFzcz0icHJldHR5cHJpbnQiPgogICAgICogICBhbmd1bGFyLm1vZHVsZSgnbXlBcHBXaXRoU2NlRGlzYWJsZWRteUFwcCcsIFtdKS5jb25maWcoZnVuY3Rpb24oJHNjZVByb3ZpZGVyKSB7CiAgICAgKiAgICAgLy8gQ29tcGxldGVseSBkaXNhYmxlIFNDRS4gIEZvciBkZW1vbnN0cmF0aW9uIHB1cnBvc2VzIG9ubHkhCiAgICAgKiAgICAgLy8gRG8gbm90IHVzZSBpbiBuZXcgcHJvamVjdHMuCiAgICAgKiAgICAgJHNjZVByb3ZpZGVyLmVuYWJsZWQoZmFsc2UpOwogICAgICogICB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqLwoKICAgIGZ1bmN0aW9uICRTY2VQcm92aWRlcigpIHsKICAgICAgICB2YXIgZW5hYmxlZCA9IHRydWU7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLnNjZVByb3ZpZGVyI2VuYWJsZWQKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZVByb3ZpZGVyCiAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSB2YWx1ZSBJZiBwcm92aWRlZCwgdGhlbiBlbmFibGVzL2Rpc2FibGVzIFNDRS4KICAgICAgICAgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIFNDRSBpcyBlbmFibGVkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBFbmFibGVzL2Rpc2FibGVzIFNDRSBhbmQgcmV0dXJucyB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAgICAgKi8KICAgICAgICB0aGlzLmVuYWJsZWQgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGVuYWJsZWQgPSAhIXZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlbmFibGVkOwogICAgICAgIH07CgoKICAgICAgICAvKiBEZXNpZ24gbm90ZXMgb24gdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gZm9yIFNDRS4KICAgICAgICAgKgogICAgICAgICAqIFRoZSBBUEkgY29udHJhY3QgZm9yIHRoZSBTQ0UgZGVsZWdhdGUKICAgICAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgICogVGhlIFNDRSBkZWxlZ2F0ZSBvYmplY3QgbXVzdCBwcm92aWRlIHRoZSBmb2xsb3dpbmcgMyBtZXRob2RzOgogICAgICAgICAqCiAgICAgICAgICogLSB0cnVzdEFzKGNvbnRleHRFbnVtLCB2YWx1ZSkKICAgICAgICAgKiAgICAgVGhpcyBtZXRob2QgaXMgdXNlZCB0byB0ZWxsIHRoZSBTQ0Ugc2VydmljZSB0aGF0IHRoZSBwcm92aWRlZCB2YWx1ZSBpcyBPSyB0byB1c2UgaW4gdGhlCiAgICAgICAgICogICAgIGNvbnRleHRzIHNwZWNpZmllZCBieSBjb250ZXh0RW51bS4gIEl0IG11c3QgcmV0dXJuIGFuIG9iamVjdCB0aGF0IHdpbGwgYmUgYWNjZXB0ZWQgYnkKICAgICAgICAgKiAgICAgZ2V0VHJ1c3RlZCgpIGZvciBhIGNvbXBhdGlibGUgY29udGV4dEVudW0gYW5kIHJldHVybiB0aGlzIHZhbHVlLgogICAgICAgICAqCiAgICAgICAgICogLSB2YWx1ZU9mKHZhbHVlKQogICAgICAgICAqICAgICBGb3IgdmFsdWVzIHRoYXQgd2VyZSBub3QgcHJvZHVjZWQgYnkgdHJ1c3RBcygpLCByZXR1cm4gdGhlbSBhcyBpcy4gIEZvciB2YWx1ZXMgdGhhdCB3ZXJlCiAgICAgICAgICogICAgIHByb2R1Y2VkIGJ5IHRydXN0QXMoKSwgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIGlucHV0IHZhbHVlIHRvIHRydXN0QXMuICBCYXNpY2FsbHksIGlmCiAgICAgICAgICogICAgIHRydXN0QXMgaXMgd3JhcHBpbmcgdGhlIGdpdmVuIHZhbHVlcyBpbnRvIHNvbWUgdHlwZSwgdGhpcyBvcGVyYXRpb24gdW53cmFwcyBpdCB3aGVuIGdpdmVuCiAgICAgICAgICogICAgIHN1Y2ggYSB2YWx1ZS4KICAgICAgICAgKgogICAgICAgICAqIC0gZ2V0VHJ1c3RlZChjb250ZXh0RW51bSwgdmFsdWUpCiAgICAgICAgICogICAgIFRoaXMgZnVuY3Rpb24gc2hvdWxkIHJldHVybiB0aGUgYSB2YWx1ZSB0aGF0IGlzIHNhZmUgdG8gdXNlIGluIHRoZSBjb250ZXh0IHNwZWNpZmllZCBieQogICAgICAgICAqICAgICBjb250ZXh0RW51bSBvciB0aHJvdyBhbmQgZXhjZXB0aW9uIG90aGVyd2lzZS4KICAgICAgICAgKgogICAgICAgICAqIE5PVEU6IFRoaXMgY29udHJhY3QgZGVsaWJlcmF0ZWx5IGRvZXMgTk9UIHN0YXRlIHRoYXQgdmFsdWVzIHJldHVybmVkIGJ5IHRydXN0QXMoKSBtdXN0IGJlIG9wYXF1ZQogICAgICAgICAqIG9yIHdyYXBwZWQgaW4gc29tZSBob2xkZXIgb2JqZWN0LiAgVGhhdCBoYXBwZW5zIHRvIGJlIGFuIGltcGxlbWVudGF0aW9uIGRldGFpbC4gIEZvciBpbnN0YW5jZSwKICAgICAgICAgKiBhbiBpbXBsZW1lbnRhdGlvbiBjb3VsZCBtYWludGFpbiBhIHJlZ2lzdHJ5IG9mIGFsbCB0cnVzdGVkIG9iamVjdHMgYnkgY29udGV4dC4gIEluIHN1Y2ggYSBjYXNlLAogICAgICAgICAqIHRydXN0QXMoKSB3b3VsZCByZXR1cm4gdGhlIHNhbWUgb2JqZWN0IHRoYXQgd2FzIHBhc3NlZCBpbi4gIGdldFRydXN0ZWQoKSB3b3VsZCByZXR1cm4gdGhlIHNhbWUKICAgICAgICAgKiBvYmplY3QgcGFzc2VkIGluIGlmIGl0IHdhcyBmb3VuZCBpbiB0aGUgcmVnaXN0cnkgdW5kZXIgYSBjb21wYXRpYmxlIGNvbnRleHQgb3IgdGhyb3cgYW4KICAgICAgICAgKiBleGNlcHRpb24gb3RoZXJ3aXNlLiAgQW4gaW1wbGVtZW50YXRpb24gbWlnaHQgb25seSB3cmFwIHZhbHVlcyBzb21lIG9mIHRoZSB0aW1lIGJhc2VkIG9uCiAgICAgICAgICogc29tZSBjcml0ZXJpYS4gIGdldFRydXN0ZWQoKSBtaWdodCByZXR1cm4gYSB2YWx1ZSBhbmQgbm90IHRocm93IGFuIGV4Y2VwdGlvbiBmb3Igc3BlY2lhbAogICAgICAgICAqIGNvbnN0YW50cyBvciBvYmplY3RzIGV2ZW4gaWYgbm90IHdyYXBwZWQuICBBbGwgc3VjaCBpbXBsZW1lbnRhdGlvbnMgZnVsZmlsbCB0aGlzIGNvbnRyYWN0LgogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiBBIG5vdGUgb24gdGhlIGluaGVyaXRhbmNlIG1vZGVsIGZvciBTQ0UgY29udGV4dHMKICAgICAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAgKiBJJ3ZlIHVzZWQgaW5oZXJpdGFuY2UgYW5kIG1hZGUgUkVTT1VSQ0VfVVJMIHdyYXBwZWQgdHlwZXMgYSBzdWJ0eXBlIG9mIFVSTCB3cmFwcGVkIHR5cGVzLiAgVGhpcwogICAgICAgICAqIGlzIHB1cmVseSBhbiBpbXBsZW1lbnRhdGlvbiBkZXRhaWxzLgogICAgICAgICAqCiAgICAgICAgICogVGhlIGNvbnRyYWN0IGlzIHNpbXBseSB0aGlzOgogICAgICAgICAqCiAgICAgICAgICogICAgIGdldFRydXN0ZWQoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKSBzdWNjZWVkaW5nIGltcGxpZXMgdGhhdCBnZXRUcnVzdGVkKCRzY2UuVVJMLCB2YWx1ZSkKICAgICAgICAgKiAgICAgd2lsbCBhbHNvIHN1Y2NlZWQuCiAgICAgICAgICoKICAgICAgICAgKiBJbmhlcml0YW5jZSBoYXBwZW5zIHRvIGNhcHR1cmUgdGhpcyBpbiBhIG5hdHVyYWwgd2F5LiAgSW4gc29tZSBmdXR1cmUsIHdlCiAgICAgICAgICogbWF5IG5vdCB1c2UgaW5oZXJpdGFuY2UgYW55bW9yZS4gIFRoYXQgaXMgT0sgYmVjYXVzZSBubyBjb2RlIG91dHNpZGUgb2YKICAgICAgICAgKiBzY2UuanMgYW5kIHNjZVNwZWNzLmpzIHdvdWxkIG5lZWQgdG8gYmUgYXdhcmUgb2YgdGhpcyBkZXRhaWwuCiAgICAgICAgICovCgogICAgICAgIHRoaXMuJGdldCA9IFsnJHBhcnNlJywgJyRkb2N1bWVudCcsICckc2NlRGVsZWdhdGUnLCBmdW5jdGlvbiAoCiAgICAgICAgICAgICAgICAgICAgICAkcGFyc2UsICRkb2N1bWVudCwgJHNjZURlbGVnYXRlKSB7CiAgICAgICAgICAgIC8vIFByZXJlcTogRW5zdXJlIHRoYXQgd2UncmUgbm90IHJ1bm5pbmcgaW4gSUU4IHF1aXJrcyBtb2RlLiAgSW4gdGhhdCBtb2RlLCBJRSBhbGxvd3MKICAgICAgICAgICAgLy8gdGhlICJleHByZXNzaW9uKGphdmFzY3JpcHQgZXhwcmVzc2lvbikiIHN5bnRheCB3aGljaCBpcyBpbnNlY3VyZS4KICAgICAgICAgICAgaWYgKGVuYWJsZWQgJiYgbXNpZSkgewogICAgICAgICAgICAgICAgdmFyIGRvY3VtZW50TW9kZSA9ICRkb2N1bWVudFswXS5kb2N1bWVudE1vZGU7CiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnRNb2RlICE9PSB1bmRlZmluZWQgJiYgZG9jdW1lbnRNb2RlIDwgOCkgewogICAgICAgICAgICAgICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2llcXVpcmtzJywKICAgICAgICAgICAgICAgICAgICAgICdTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyBkb2VzIG5vdCBzdXBwb3J0IEludGVybmV0IEV4cGxvcmVyIHZlcnNpb24gPCA5IGluIHF1aXJrcyAnICsKICAgICAgICAgICAgICAgICAgICAgICdtb2RlLiAgWW91IGNhbiBmaXggdGhpcyBieSBhZGRpbmcgdGhlIHRleHQgPCFkb2N0eXBlIGh0bWw+IHRvIHRoZSB0b3Agb2YgeW91ciBIVE1MICcgKwogICAgICAgICAgICAgICAgICAgICAgJ2RvY3VtZW50LiAgU2VlIGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nLiRzY2UgZm9yIG1vcmUgaW5mb3JtYXRpb24uJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzY2UgPSBjb3B5KFNDRV9DT05URVhUUyk7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLnNjZSNpc0VuYWJsZWQKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICogQGZ1bmN0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IHRydWUgaWYgU0NFIGlzIGVuYWJsZWQsIGZhbHNlIG90aGVyd2lzZS4gIElmIHlvdSB3YW50IHRvIHNldCB0aGUgdmFsdWUsIHlvdQogICAgICAgICAgICAgKiBoYXZlIHRvIGRvIGl0IGF0IG1vZHVsZSBjb25maWcgdGltZSBvbiB7QGxpbmsgbmcuJHNjZVByb3ZpZGVyICRzY2VQcm92aWRlcn0uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBSZXR1cm5zIGEgYm9vbGVhbiBpbmRpY2F0aW5nIGlmIFNDRSBpcyBlbmFibGVkLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2NlLmlzRW5hYmxlZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbmFibGVkOwogICAgICAgICAgICB9OwogICAgICAgICAgICBzY2UudHJ1c3RBcyA9ICRzY2VEZWxlZ2F0ZS50cnVzdEFzOwogICAgICAgICAgICBzY2UuZ2V0VHJ1c3RlZCA9ICRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkOwogICAgICAgICAgICBzY2UudmFsdWVPZiA9ICRzY2VEZWxlZ2F0ZS52YWx1ZU9mOwoKICAgICAgICAgICAgaWYgKCFlbmFibGVkKSB7CiAgICAgICAgICAgICAgICBzY2UudHJ1c3RBcyA9IHNjZS5nZXRUcnVzdGVkID0gZnVuY3Rpb24gKHR5cGUsIHZhbHVlKSB7IHJldHVybiB2YWx1ZTsgfSwKICAgICAgICAgICAgICAgIHNjZS52YWx1ZU9mID0gaWRlbnRpdHkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZSNwYXJzZQogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogQ29udmVydHMgQW5ndWxhciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpbnRvIGEgZnVuY3Rpb24uICBUaGlzIGlzIGxpa2Uge0BsaW5rCiAgICAgICAgICAgICAqIG5nLiRwYXJzZSAkcGFyc2V9IGFuZCBpcyBpZGVudGljYWwgd2hlbiB0aGUgZXhwcmVzc2lvbiBpcyBhIGxpdGVyYWwgY29uc3RhbnQuICBPdGhlcndpc2UsIGl0CiAgICAgICAgICAgICAqIHdyYXBzIHRoZSBleHByZXNzaW9uIGluIGEgY2FsbCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkICRzY2UuZ2V0VHJ1c3RlZCgqdHlwZSosCiAgICAgICAgICAgICAqICpyZXN1bHQqKX0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgU0NFIGNvbnRleHQgaW4gd2hpY2ggdGhpcyByZXN1bHQgd2lsbCBiZSB1c2VkLgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgICAgICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICAgICAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgICAgICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2NlLnBhcnNlQXMgPSBmdW5jdGlvbiBzY2VQYXJzZUFzKHR5cGUsIGV4cHIpIHsKICAgICAgICAgICAgICAgIHZhciBwYXJzZWQgPSAkcGFyc2UoZXhwcik7CiAgICAgICAgICAgICAgICBpZiAocGFyc2VkLmxpdGVyYWwgJiYgcGFyc2VkLmNvbnN0YW50KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHNjZVBhcnNlQXNUcnVzdGVkKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NlLmdldFRydXN0ZWQodHlwZSwgcGFyc2VkKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2UjdHJ1c3RBcwogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogRGVsZWdhdGVzIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfS4gIEFzIHN1Y2gsIHJldHVybnMgYW4gb2JqZWN0CiAgICAgICAgICAgICAqIHRoYXQgaXMgdHJ1c3RlZCBieSBhbmd1bGFyIGZvciB1c2UgaW4gc3BlY2lmaWVkIHN0cmljdCBjb250ZXh0dWFsIGVzY2FwaW5nIGNvbnRleHRzIChzdWNoIGFzCiAgICAgICAgICAgICAqIG5nLWh0bWwtYmluZC11bnNhZmUsIG5nLWluY2x1ZGUsIGFueSBzcmMgYXR0cmlidXRlIGludGVycG9sYXRpb24sIGFueSBkb20gZXZlbnQgYmluZGluZwogICAgICAgICAgICAgKiBhdHRyaWJ1dGUgaW50ZXJwb2xhdGlvbiBzdWNoIGFzIGZvciBvbmNsaWNrLCAgZXRjLikgdGhhdCB1c2VzIHRoZSBwcm92aWRlZCB2YWx1ZS4gIFNlZSAqCiAgICAgICAgICAgICAqIHtAbGluayBuZy4kc2NlICRzY2V9IGZvciBlbmFibGluZyBzdHJpY3QgY29udGV4dHVhbCBlc2NhcGluZy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgY29udGV4dCBpbiB3aGljaCB0aGlzIHZhbHVlIGlzIHNhZmUgZm9yIHVzZS4gIGUuZy4gdXJsLAogICAgICAgICAgICAgKiAgIHJlc291cmNlX3VybCwgaHRtbCwganMgYW5kIGNzcy4KICAgICAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdGhhdCB0aGF0IHNob3VsZCBiZSBjb25zaWRlcmVkIHRydXN0ZWQvc2FmZS4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IEEgdmFsdWUgdGhhdCBjYW4gYmUgdXNlZCB0byBzdGFuZCBpbiBmb3IgdGhlIHByb3ZpZGVkIGB2YWx1ZWAgaW4gcGxhY2VzCiAgICAgICAgICAgICAqIHdoZXJlIEFuZ3VsYXIgZXhwZWN0cyBhICRzY2UudHJ1c3RBcygpIHJldHVybiB2YWx1ZS4KICAgICAgICAgICAgICovCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kc2NlI3RydXN0QXNIdG1sCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kc2NlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UudHJ1c3RBc0h0bWwodmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLkhUTUwsIHZhbHVlKWB9CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRIdG1sCiAgICAgICAgICAgICAqICAgICAkc2NlLmdldFRydXN0ZWRIdG1sKHZhbHVlKX0gdG8gb2J0YWluIHRoZSBvcmlnaW5hbCB2YWx1ZS4gIChwcml2aWxlZ2VkIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlCiAgICAgICAgICAgICAqICAgICByZXR1cm4gdmFsdWUgb2Yge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9LikKICAgICAgICAgICAgICovCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kc2NlI3RydXN0QXNVcmwKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS50cnVzdEFzVXJsKHZhbHVlKWAg4oaSIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRVcmwKICAgICAgICAgICAgICogICAgICRzY2UuZ2V0VHJ1c3RlZFVybCh2YWx1ZSl9IHRvIG9idGFpbiB0aGUgb3JpZ2luYWwgdmFsdWUuICAocHJpdmlsZWdlZCBkaXJlY3RpdmVzCiAgICAgICAgICAgICAqICAgICBvbmx5IGFjY2VwdCBleHByZXNzaW9ucyB0aGF0IGFyZSBlaXRoZXIgbGl0ZXJhbCBjb25zdGFudHMgb3IgYXJlIHRoZQogICAgICAgICAgICAgKiAgICAgcmV0dXJuIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZSN0cnVzdEFzUmVzb3VyY2VVcmwKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS50cnVzdEFzUmVzb3VyY2VVcmwodmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYH0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdHJ1c3RBcy4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IEFuIG9iamVjdCB0aGF0IGNhbiBiZSBwYXNzZWQgdG8ge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAgICAgICAgICAgICAqICAgICAkc2NlLmdldFRydXN0ZWRSZXNvdXJjZVVybCh2YWx1ZSl9IHRvIG9idGFpbiB0aGUgb3JpZ2luYWwgdmFsdWUuICAocHJpdmlsZWdlZCBkaXJlY3RpdmVzCiAgICAgICAgICAgICAqICAgICBvbmx5IGFjY2VwdCBleHByZXNzaW9ucyB0aGF0IGFyZSBlaXRoZXIgbGl0ZXJhbCBjb25zdGFudHMgb3IgYXJlIHRoZSByZXR1cm4KICAgICAgICAgICAgICogICAgIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZSN0cnVzdEFzSnMKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS50cnVzdEFzSnModmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLkpTLCB2YWx1ZSlgfQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB0cnVzdEFzLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHBhc3NlZCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkSnMKICAgICAgICAgICAgICogICAgICRzY2UuZ2V0VHJ1c3RlZEpzKHZhbHVlKX0gdG8gb2J0YWluIHRoZSBvcmlnaW5hbCB2YWx1ZS4gIChwcml2aWxlZ2VkIGRpcmVjdGl2ZXMKICAgICAgICAgICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlCiAgICAgICAgICAgICAqICAgICByZXR1cm4gdmFsdWUgb2Yge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9LikKICAgICAgICAgICAgICovCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kc2NlI2dldFRydXN0ZWQKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIERlbGVnYXRlcyB0byB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkYH0uICBBcyBzdWNoLCB0YWtlcwogICAgICAgICAgICAgKiB0aGUgcmVzdWx0IG9mIGEge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyBgJHNjZS50cnVzdEFzYH0oKSBjYWxsIGFuZCByZXR1cm5zIHRoZSBvcmlnaW5hbGx5IHN1cHBsaWVkCiAgICAgICAgICAgICAqIHZhbHVlIGlmIHRoZSBxdWVyaWVkIGNvbnRleHQgdHlwZSBpcyBhIHN1cGVydHlwZSBvZiB0aGUgY3JlYXRlZCB0eXBlLiAgSWYgdGhpcyBjb25kaXRpb24KICAgICAgICAgICAgICogaXNuJ3Qgc2F0aXNmaWVkLCB0aHJvd3MgYW4gZXhjZXB0aW9uLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgdG8gYmUgdXNlZC4KICAgICAgICAgICAgICogQHBhcmFtIHsqfSBtYXliZVRydXN0ZWQgVGhlIHJlc3VsdCBvZiBhIHByaW9yIHtAbGluayBuZy4kc2NlI3RydXN0QXMgYCRzY2UudHJ1c3RBc2B9IGNhbGwuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgdmFsdWUgdGhlIHdhcyBvcmlnaW5hbGx5IHByb3ZpZGVkIHRvIHtAbGluayBuZy4kc2NlI3RydXN0QXMgYCRzY2UudHJ1c3RBc2B9IGlmCiAgICAgICAgICAgICAqICAgICB2YWxpZCBpbiB0aGlzIGNvbnRleHQuICBPdGhlcndpc2UsIHRocm93cyBhbiBleGNlcHRpb24uCiAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZSNnZXRUcnVzdGVkSHRtbAogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRIdG1sKHZhbHVlKWAg4oaSIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWQoJHNjZS5IVE1MLCB2YWx1ZSlgfQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBwYXNzIHRvIGAkc2NlLmdldFRydXN0ZWRgLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuSFRNTCwgdmFsdWUpYAogICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2UjZ2V0VHJ1c3RlZENzcwogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRDc3ModmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLkNTUywgdmFsdWUpYH0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLkNTUywgdmFsdWUpYAogICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2UjZ2V0VHJ1c3RlZFVybAogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRVcmwodmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLlVSTCwgdmFsdWUpYH0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLlVSTCwgdmFsdWUpYAogICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kc2NlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsKHZhbHVlKWAg4oaSIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWQoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKWB9CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkYC4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYAogICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2UjZ2V0VHJ1c3RlZEpzCiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kc2NlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZEpzKHZhbHVlKWAg4oaSIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWQoJHNjZS5KUywgdmFsdWUpYH0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLkpTLCB2YWx1ZSlgCiAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZSNwYXJzZUFzSHRtbAogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNIdG1sKGV4cHJlc3Npb24gc3RyaW5nKWAg4oaSIHtAbGluayBuZy4kc2NlI3BhcnNlIGAkc2NlLnBhcnNlQXMoJHNjZS5IVE1MLCB2YWx1ZSlgfQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgICAgICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICAgICAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgICAgICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIG5nLiRzY2UjcGFyc2VBc0NzcwogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNDc3ModmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2UjcGFyc2UgYCRzY2UucGFyc2VBcygkc2NlLkNTUywgdmFsdWUpYH0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICAgICAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAgICAgICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICAgICAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAgICAgICAgICovCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kc2NlI3BhcnNlQXNVcmwKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzVXJsKHZhbHVlKWAg4oaSIHtAbGluayBuZy4kc2NlI3BhcnNlIGAkc2NlLnBhcnNlQXMoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAgICAgICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgICAgICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAgICAgICAgICogICAgICBgY29udGV4dGAuCiAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgbmcuJHNjZSNwYXJzZUFzUmVzb3VyY2VVcmwKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLiRzY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzUmVzb3VyY2VVcmwodmFsdWUpYCDihpIge0BsaW5rIG5nLiRzY2UjcGFyc2UgYCRzY2UucGFyc2VBcygkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYH0KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICAgICAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAgICAgICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICAgICAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAgICAgICAgICovCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBuZy4kc2NlI3BhcnNlQXNKcwogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuJHNjZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNKcyh2YWx1ZSlgIOKGkiB7QGxpbmsgbmcuJHNjZSNwYXJzZSBgJHNjZS5wYXJzZUFzKCRzY2UuSlMsIHZhbHVlKWB9CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAgICAgICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgICAgICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAgICAgICAgICogICAgICBgY29udGV4dGAuCiAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgLy8gU2hvcnRoYW5kIGRlbGVnYXRpb25zLgogICAgICAgICAgICB2YXIgcGFyc2UgPSBzY2UucGFyc2VBcywKICAgICAgICAgICAgICAgIGdldFRydXN0ZWQgPSBzY2UuZ2V0VHJ1c3RlZCwKICAgICAgICAgICAgICAgIHRydXN0QXMgPSBzY2UudHJ1c3RBczsKCiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChTQ0VfQ09OVEVYVFMsIGZ1bmN0aW9uIChlbnVtVmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgICAgIHZhciBsTmFtZSA9IGxvd2VyY2FzZShuYW1lKTsKICAgICAgICAgICAgICAgIHNjZVtjYW1lbENhc2UoInBhcnNlX2FzXyIgKyBsTmFtZSldID0gZnVuY3Rpb24gKGV4cHIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2UoZW51bVZhbHVlLCBleHByKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNjZVtjYW1lbENhc2UoImdldF90cnVzdGVkXyIgKyBsTmFtZSldID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldFRydXN0ZWQoZW51bVZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzY2VbY2FtZWxDYXNlKCJ0cnVzdF9hc18iICsgbE5hbWUpXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVzdEFzKGVudW1WYWx1ZSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiBzY2U7CiAgICAgICAgfV07CiAgICB9CgogICAgLyoqCiAgICAgKiAhISEgVGhpcyBpcyBhbiB1bmRvY3VtZW50ZWQgInByaXZhdGUiIHNlcnZpY2UgISEhCiAgICAgKgogICAgICogQG5hbWUgbmcuJHNuaWZmZXIKICAgICAqIEByZXF1aXJlcyAkd2luZG93CiAgICAgKiBAcmVxdWlyZXMgJGRvY3VtZW50CiAgICAgKgogICAgICogQHByb3BlcnR5IHtib29sZWFufSBoaXN0b3J5IERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCBodG1sNSBoaXN0b3J5IGFwaSA/CiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc2hjaGFuZ2UgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IGhhc2hjaGFuZ2UgZXZlbnQgPwogICAgICogQHByb3BlcnR5IHtib29sZWFufSB0cmFuc2l0aW9ucyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgQ1NTIHRyYW5zaXRpb24gZXZlbnRzID8KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYW5pbWF0aW9ucyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgQ1NTIGFuaW1hdGlvbiBldmVudHMgPwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhpcyBpcyB2ZXJ5IHNpbXBsZSBpbXBsZW1lbnRhdGlvbiBvZiB0ZXN0aW5nIGJyb3dzZXIncyBmZWF0dXJlcy4KICAgICAqLwogICAgZnVuY3Rpb24gJFNuaWZmZXJQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24gKCR3aW5kb3csICRkb2N1bWVudCkgewogICAgICAgICAgICB2YXIgZXZlbnRTdXBwb3J0ID0ge30sCiAgICAgICAgICAgICAgICBhbmRyb2lkID0gaW50KCgvYW5kcm9pZCAoXGQrKS8uZXhlYyhsb3dlcmNhc2UoKCR3aW5kb3cubmF2aWdhdG9yIHx8IHt9KS51c2VyQWdlbnQpKSB8fCBbXSlbMV0pLAogICAgICAgICAgICAgICAgYm94ZWUgPSAvQm94ZWUvaS50ZXN0KCgkd2luZG93Lm5hdmlnYXRvciB8fCB7fSkudXNlckFnZW50KSwKICAgICAgICAgICAgICAgIGRvY3VtZW50ID0gJGRvY3VtZW50WzBdIHx8IHt9LAogICAgICAgICAgICAgICAgdmVuZG9yUHJlZml4LAogICAgICAgICAgICAgICAgdmVuZG9yUmVnZXggPSAvXihNb3p8d2Via2l0fE98bXMpKD89W0EtWl0pLywKICAgICAgICAgICAgICAgIGJvZHlTdHlsZSA9IGRvY3VtZW50LmJvZHkgJiYgZG9jdW1lbnQuYm9keS5zdHlsZSwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zID0gZmFsc2UsCiAgICAgICAgICAgICAgICBhbmltYXRpb25zID0gZmFsc2UsCiAgICAgICAgICAgICAgICBtYXRjaDsKCiAgICAgICAgICAgIGlmIChib2R5U3R5bGUpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gYm9keVN0eWxlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoID0gdmVuZG9yUmVnZXguZXhlYyhwcm9wKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2ZW5kb3JQcmVmaXggPSBtYXRjaFswXTsKICAgICAgICAgICAgICAgICAgICAgICAgdmVuZG9yUHJlZml4ID0gdmVuZG9yUHJlZml4LnN1YnN0cigwLCAxKS50b1VwcGVyQ2FzZSgpICsgdmVuZG9yUHJlZml4LnN1YnN0cigxKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghdmVuZG9yUHJlZml4KSB7CiAgICAgICAgICAgICAgICAgICAgdmVuZG9yUHJlZml4ID0gKCdXZWJraXRPcGFjaXR5JyBpbiBib2R5U3R5bGUpICYmICd3ZWJraXQnOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zID0gISEoKCd0cmFuc2l0aW9uJyBpbiBib2R5U3R5bGUpIHx8ICh2ZW5kb3JQcmVmaXggKyAnVHJhbnNpdGlvbicgaW4gYm9keVN0eWxlKSk7CiAgICAgICAgICAgICAgICBhbmltYXRpb25zID0gISEoKCdhbmltYXRpb24nIGluIGJvZHlTdHlsZSkgfHwgKHZlbmRvclByZWZpeCArICdBbmltYXRpb24nIGluIGJvZHlTdHlsZSkpOwoKICAgICAgICAgICAgICAgIGlmIChhbmRyb2lkICYmICghdHJhbnNpdGlvbnMgfHwgIWFuaW1hdGlvbnMpKSB7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbnMgPSBpc1N0cmluZyhkb2N1bWVudC5ib2R5LnN0eWxlLndlYmtpdFRyYW5zaXRpb24pOwogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbnMgPSBpc1N0cmluZyhkb2N1bWVudC5ib2R5LnN0eWxlLndlYmtpdEFuaW1hdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgLy8gQW5kcm9pZCBoYXMgaGlzdG9yeS5wdXNoU3RhdGUsIGJ1dCBpdCBkb2VzIG5vdCB1cGRhdGUgbG9jYXRpb24gY29ycmVjdGx5CiAgICAgICAgICAgICAgICAvLyBzbyBsZXQncyBub3QgdXNlIHRoZSBoaXN0b3J5IEFQSSBhdCBhbGwuCiAgICAgICAgICAgICAgICAvLyBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvYW5kcm9pZC9pc3N1ZXMvZGV0YWlsP2lkPTE3NDcxCiAgICAgICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy85MDQKCiAgICAgICAgICAgICAgICAvLyBvbGRlciB3ZWJpdCBicm93c2VyICg1MzMuOSkgb24gQm94ZWUgYm94IGhhcyBleGFjdGx5IHRoZSBzYW1lIHByb2JsZW0gYXMgQW5kcm9pZCBoYXMKICAgICAgICAgICAgICAgIC8vIHNvIGxldCdzIG5vdCB1c2UgdGhlIGhpc3RvcnkgQVBJIGFsc28KICAgICAgICAgICAgICAgIGhpc3Rvcnk6ICEhKCR3aW5kb3cuaGlzdG9yeSAmJiAkd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlICYmICEoYW5kcm9pZCA8IDQpICYmICFib3hlZSksCiAgICAgICAgICAgICAgICBoYXNoY2hhbmdlOiAnb25oYXNoY2hhbmdlJyBpbiAkd2luZG93ICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJRTggY29tcGF0aWJsZSBtb2RlIGxpZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICghZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHx8IGRvY3VtZW50LmRvY3VtZW50TW9kZSA+IDcpLAogICAgICAgICAgICAgICAgaGFzRXZlbnQ6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIC8vIElFOSBpbXBsZW1lbnRzICdpbnB1dCcgZXZlbnQgaXQncyBzbyBmdWJhcmVkIHRoYXQgd2UgcmF0aGVyIHByZXRlbmQgdGhhdCBpdCBkb2Vzbid0IGhhdmUKICAgICAgICAgICAgICAgICAgICAvLyBpdC4gSW4gcGFydGljdWxhciB0aGUgZXZlbnQgaXMgbm90IGZpcmVkIHdoZW4gYmFja3NwYWNlIG9yIGRlbGV0ZSBrZXkgYXJlIHByZXNzZWQgb3IKICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIGN1dCBvcGVyYXRpb24gaXMgcGVyZm9ybWVkLgogICAgICAgICAgICAgICAgICAgIGlmIChldmVudCA9PSAnaW5wdXQnICYmIG1zaWUgPT0gOSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoZXZlbnRTdXBwb3J0W2V2ZW50XSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpdkVsbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudFN1cHBvcnRbZXZlbnRdID0gJ29uJyArIGV2ZW50IGluIGRpdkVsbTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudFN1cHBvcnRbZXZlbnRdOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNzcDogZG9jdW1lbnQuc2VjdXJpdHlQb2xpY3kgPyBkb2N1bWVudC5zZWN1cml0eVBvbGljeS5pc0FjdGl2ZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgdmVuZG9yUHJlZml4OiB2ZW5kb3JQcmVmaXgsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogdHJhbnNpdGlvbnMsCiAgICAgICAgICAgICAgICBhbmltYXRpb25zOiBhbmltYXRpb25zCiAgICAgICAgICAgIH07CiAgICAgICAgfV07CiAgICB9CgogICAgZnVuY3Rpb24gJFRpbWVvdXRQcm92aWRlcigpIHsKICAgICAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHEnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICAgICAgICAgZnVuY3Rpb24gKCRyb290U2NvcGUsICRicm93c2VyLCAkcSwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgICAgICB2YXIgZGVmZXJyZWRzID0ge307CgoKICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgKiBAbmFtZSBuZy4kdGltZW91dAogICAgICAgICAgICAgICAgICAqIEByZXF1aXJlcyAkYnJvd3NlcgogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICogQW5ndWxhcidzIHdyYXBwZXIgZm9yIGB3aW5kb3cuc2V0VGltZW91dGAuIFRoZSBgZm5gIGZ1bmN0aW9uIGlzIHdyYXBwZWQgaW50byBhIHRyeS9jYXRjaAogICAgICAgICAgICAgICAgICAqIGJsb2NrIGFuZCBkZWxlZ2F0ZXMgYW55IGV4Y2VwdGlvbnMgdG8KICAgICAgICAgICAgICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIG9mIHJlZ2lzdGVyaW5nIGEgdGltZW91dCBmdW5jdGlvbiBpcyBhIHByb21pc2UsIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgd2hlbgogICAgICAgICAgICAgICAgICAqIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQgYW5kIHRoZSB0aW1lb3V0IGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICogVG8gY2FuY2VsIGEgdGltZW91dCByZXF1ZXN0LCBjYWxsIGAkdGltZW91dC5jYW5jZWwocHJvbWlzZSlgLgogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICogSW4gdGVzdHMgeW91IGNhbiB1c2Uge0BsaW5rIG5nTW9jay4kdGltZW91dCBgJHRpbWVvdXQuZmx1c2goKWB9IHRvCiAgICAgICAgICAgICAgICAgICogc3luY2hyb25vdXNseSBmbHVzaCB0aGUgcXVldWUgb2YgZGVmZXJyZWQgZnVuY3Rpb25zLgogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBBIGZ1bmN0aW9uLCB3aG9zZSBleGVjdXRpb24gc2hvdWxkIGJlIGRlbGF5ZWQuCiAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBbZGVsYXk9MF0gRGVsYXkgaW4gbWlsbGlzZWNvbmRzLgogICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbnZva2VBcHBseT10cnVlXSBJZiBzZXQgdG8gYGZhbHNlYCBza2lwcyBtb2RlbCBkaXJ0eSBjaGVja2luZywgb3RoZXJ3aXNlCiAgICAgICAgICAgICAgICAgICogICB3aWxsIGludm9rZSBgZm5gIHdpdGhpbiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseX0gYmxvY2suCiAgICAgICAgICAgICAgICAgICogQHJldHVybnMge1Byb21pc2V9IFByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdoZW4gdGhlIHRpbWVvdXQgaXMgcmVhY2hlZC4gVGhlIHZhbHVlIHRoaXMKICAgICAgICAgICAgICAgICAgKiAgIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aXRoIGlzIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGBmbmAgZnVuY3Rpb24uCiAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgZnVuY3Rpb24gdGltZW91dChmbiwgZGVsYXksIGludm9rZUFwcGx5KSB7CiAgICAgICAgICAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSwKICAgICAgICAgICAgICAgICAgICAgICAgIHNraXBBcHBseSA9IChpc0RlZmluZWQoaW52b2tlQXBwbHkpICYmICFpbnZva2VBcHBseSksCiAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0SWQ7CgogICAgICAgICAgICAgICAgICAgICB0aW1lb3V0SWQgPSAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZm4oKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRlZmVycmVkc1twcm9taXNlLiQkdGltZW91dElkXTsKICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNraXBBcHBseSkgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgICAgICAgfSwgZGVsYXkpOwoKICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS4kJHRpbWVvdXRJZCA9IHRpbWVvdXRJZDsKICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWRzW3RpbWVvdXRJZF0gPSBkZWZlcnJlZDsKCiAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAqIEBuYW1lIG5nLiR0aW1lb3V0I2NhbmNlbAogICAgICAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy4kdGltZW91dAogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAgICAgICogQ2FuY2VscyBhIHRhc2sgYXNzb2NpYXRlZCB3aXRoIHRoZSBgcHJvbWlzZWAuIEFzIGEgcmVzdWx0IG9mIHRoaXMsIHRoZSBwcm9taXNlIHdpbGwgYmUKICAgICAgICAgICAgICAgICAgKiByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICogQHBhcmFtIHtQcm9taXNlPX0gcHJvbWlzZSBQcm9taXNlIHJldHVybmVkIGJ5IHRoZSBgJHRpbWVvdXRgIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICAgICAgICAgICogICBjYW5jZWxlZC4KICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICB0aW1lb3V0LmNhbmNlbCA9IGZ1bmN0aW9uIChwcm9taXNlKSB7CiAgICAgICAgICAgICAgICAgICAgIGlmIChwcm9taXNlICYmIHByb21pc2UuJCR0aW1lb3V0SWQgaW4gZGVmZXJyZWRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGRlZmVycmVkc1twcm9taXNlLiQkdGltZW91dElkXTsKICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkYnJvd3Nlci5kZWZlci5jYW5jZWwocHJvbWlzZS4kJHRpbWVvdXRJZCk7CiAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgIHJldHVybiB0aW1lb3V0OwogICAgICAgICAgICAgfV07CiAgICB9CgogICAgZnVuY3Rpb24gJCRVcmxVdGlsc1Byb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IFtmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB1cmxQYXJzaW5nTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKSwKICAgICAgICAgICAgICAgIC8vIE5PVEU6ICBUaGUgdXNhZ2Ugb2Ygd2luZG93IGFuZCBkb2N1bWVudCBpbnN0ZWFkIG9mICR3aW5kb3cgYW5kICRkb2N1bWVudCBoZXJlIGlzCiAgICAgICAgICAgICAgICAvLyBkZWxpYmVyYXRlLiAgVGhpcyBzZXJ2aWNlIGRlcGVuZHMgb24gdGhlIHNwZWNpZmljIGJlaGF2aW9yIG9mIGFuY2hvciBub2RlcyBjcmVhdGVkIGJ5IHRoZQogICAgICAgICAgICAgICAgLy8gYnJvd3NlciAocmVzb2x2aW5nIGFuZCBwYXJzaW5nIFVSTHMpIHRoYXQgaXMgdW5saWtlbHkgdG8gYmUgcHJvdmlkZWQgYnkgbW9jayBvYmplY3RzIGFuZAogICAgICAgICAgICAgICAgLy8gY2F1c2UgdXMgdG8gYnJlYWsgdGVzdHMuICBJbiBhZGRpdGlvbiwgd2hlbiB0aGUgYnJvd3NlciByZXNvbHZlcyBhIFVSTCBmb3IgWEhSLCBpdAogICAgICAgICAgICAgICAgLy8gZG9lc24ndCBrbm93IGFib3V0IG1vY2tlZCBsb2NhdGlvbnMgYW5kIHJlc29sdmVzIFVSTHMgdG8gdGhlIHJlYWwgZG9jdW1lbnQgLSB3aGljaCBpcwogICAgICAgICAgICAgICAgLy8gZXhhY3RseSB0aGUgYmVoYXZpb3IgbmVlZGVkIGhlcmUuICBUaGVyZSBpcyBsaXR0bGUgdmFsdWUgaXMgbW9ja2luZyB0aGVzZSBvdXIgZm9yIHRoaXMKICAgICAgICAgICAgICAgIC8vIHNlcnZpY2UuCiAgICAgICAgICAgICAgICBvcmlnaW5VcmwgPSByZXNvbHZlKHdpbmRvdy5sb2NhdGlvbi5ocmVmLCB0cnVlKTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogTm9ybWFsaXplcyBhbmQgb3B0aW9uYWxseSBwYXJzZXMgYSBVUkwuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIE5PVEU6ICBUaGlzIGlzIGEgcHJpdmF0ZSBzZXJ2aWNlLiAgVGhlIEFQSSBpcyBzdWJqZWN0IHRvIGNoYW5nZSB1bnByZWRpY3RhYmx5IGluIGFueSBjb21taXQuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEltcGxlbWVudGF0aW9uIE5vdGVzIGZvciBub24tSUUgYnJvd3NlcnMKICAgICAgICAgICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgICAgICAgKiBBc3NpZ25pbmcgYSBVUkwgdG8gdGhlIGhyZWYgcHJvcGVydHkgb2YgYW4gYW5jaG9yIERPTSBub2RlLCBldmVuIG9uZSBhdHRhY2hlZCB0byB0aGUgRE9NLAogICAgICAgICAgICAgKiByZXN1bHRzIGJvdGggaW4gdGhlIG5vcm1hbGl6aW5nIGFuZCBwYXJzaW5nIG9mIHRoZSBVUkwuICBOb3JtYWxpemluZyBtZWFucyB0aGF0IGEgcmVsYXRpdmUKICAgICAgICAgICAgICogVVJMIHdpbGwgYmUgcmVzb2x2ZWQgaW50byBhbiBhYnNvbHV0ZSBVUkwgaW4gdGhlIGNvbnRleHQgb2YgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50LgogICAgICAgICAgICAgKiBQYXJzaW5nIG1lYW5zIHRoYXQgdGhlIGFuY2hvciBub2RlJ3MgaG9zdCwgaG9zdG5hbWUsIHByb3RvY29sLCBwb3J0LCBwYXRobmFtZSBhbmQgcmVsYXRlZAogICAgICAgICAgICAgKiBwcm9wZXJ0aWVzIGFyZSBhbGwgcG9wdWxhdGVkIHRvIHJlZmxlY3QgdGhlIG5vcm1hbGl6ZWQgVVJMLiAgVGhpcyBhcHByb2FjaCBoYXMgd2lkZQogICAgICAgICAgICAgKiBjb21wYXRpYmlsaXR5IC0gU2FmYXJpIDErLCBNb3ppbGxhIDErLCBPcGVyYSA3KyxlIGV0Yy4gIFNlZQogICAgICAgICAgICAgKiBodHRwOi8vd3d3LmFwdGFuYS5jb20vcmVmZXJlbmNlL2h0bWwvYXBpL0hUTUxBbmNob3JFbGVtZW50Lmh0bWwKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogSW1wbGVtZW50YXRpb24gTm90ZXMgZm9yIElFCiAgICAgICAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgICAgICAgKiBJRSA+PSA4IGFuZCA8PSAxMCBub3JtYWxpemVzIHRoZSBVUkwgd2hlbiBhc3NpZ25lZCB0byB0aGUgYW5jaG9yIG5vZGUgc2ltaWxhciB0byB0aGUgb3RoZXIKICAgICAgICAgICAgICogYnJvd3NlcnMuICBIb3dldmVyLCB0aGUgcGFyc2VkIGNvbXBvbmVudHMgd2lsbCBub3QgYmUgc2V0IGlmIHRoZSBVUkwgYXNzaWduZWQgZGlkIG5vdCBzcGVjaWZ5CiAgICAgICAgICAgICAqIHRoZW0uICAoZS5nLiBpZiB5b3UgYXNzaWduIGEuaHJlZiA9ICJmb28iLCB0aGVuIGEucHJvdG9jb2wsIGEuaG9zdCwgZXRjLiB3aWxsIGJlIGVtcHR5LikgIFdlCiAgICAgICAgICAgICAqIHdvcmsgYXJvdW5kIHRoYXQgYnkgcGVyZm9ybWluZyB0aGUgcGFyc2luZyBpbiBhIDJuZCBzdGVwIGJ5IHRha2luZyBhIHByZXZpb3VzbHkgbm9ybWFsaXplZAogICAgICAgICAgICAgKiBVUkwgKGUuZy4gYnkgYXNzaW5pbmcgdG8gYS5ocmVmKSBhbmQgYXNzaWduaW5nIGl0IGEuaHJlZiBhZ2Fpbi4gIFRoaXMgY29ycmVjdGx5IHBvcHVsYXRlcyB0aGUKICAgICAgICAgICAgICogcHJvcGVydGllcyBzdWNoIGFzIHByb3RvY29sLCBob3N0bmFtZSwgcG9ydCwgZXRjLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBJRTcgZG9lcyBub3Qgbm9ybWFsaXplIHRoZSBVUkwgd2hlbiBhc3NpZ25lZCB0byBhbiBhbmNob3Igbm9kZS4gIChBcHBhcmVudGx5LCBpdCBkb2VzLCBpZiBvbmUKICAgICAgICAgICAgICogdXNlcyB0aGUgaW5uZXIgSFRNTCBhcHByb2FjaCB0byBhc3NpZ24gdGhlIFVSTCBhcyBwYXJ0IG9mIGFuIEhUTUwgc25pcHBldCAtCiAgICAgICAgICAgICAqIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzQ3MjcyOSkgIEhvd2V2ZXIsIHNldHRpbmcgaW1nW3NyY10gZG9lcyBub3JtYWxpemUgdGhlIFVSTC4KICAgICAgICAgICAgICogVW5mb3J0dW5hdGVseSwgc2V0dGluZyBpbWdbc3JjXSB0byBzb21ldGhpbmcgbGlrZSAiamF2YXNjcmlwdDpmb28iIG9uIElFIHRocm93cyBhbiBleGNlcHRpb24uCiAgICAgICAgICAgICAqIFNpbmNlIHRoZSBwcmltYXJ5IHVzYWdlIGZvciBub3JtYWxpemluZyBVUkxzIGlzIHRvIHNhbml0aXplIHN1Y2ggVVJMcywgd2UgY2FuJ3QgdXNlIHRoYXQKICAgICAgICAgICAgICogbWV0aG9kIGFuZCBJRSA8IDggaXMgdW5zdXBwb3J0ZWQuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFJlZmVyZW5jZXM6CiAgICAgICAgICAgICAqICAgaHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvSFRNTEFuY2hvckVsZW1lbnQKICAgICAgICAgICAgICogICBodHRwOi8vd3d3LmFwdGFuYS5jb20vcmVmZXJlbmNlL2h0bWwvYXBpL0hUTUxBbmNob3JFbGVtZW50Lmh0bWwKICAgICAgICAgICAgICogICBodHRwOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jdXJsdXRpbHMKICAgICAgICAgICAgICogICBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL3B1bGwvMjkwMgogICAgICAgICAgICAgKiAgIGh0dHA6Ly9qYW1lcy5wYWRvbHNleS5jb20vamF2YXNjcmlwdC9wYXJzaW5nLXVybHMtd2l0aC10aGUtZG9tLwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSBVUkwgdG8gYmUgcGFyc2VkLgogICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBwYXJzZSBXaGVuIHRydWUsIHJldHVybnMgYW4gb2JqZWN0IGZvciB0aGUgcGFyc2VkIFVSTC4gIE90aGVyd2lzZSwgcmV0dXJucwogICAgICAgICAgICAgKiAgIGEgc2luZ2xlIHN0cmluZyB0aGF0IGlzIHRoZSBub3JtYWxpemVkIFVSTC4KICAgICAgICAgICAgICogQHJldHVybnMge29iamVjdHxzdHJpbmd9IFdoZW4gcGFyc2UgaXMgdHJ1ZSwgcmV0dXJucyB0aGUgbm9ybWFsaXplZCBVUkwgYXMgYSBzdHJpbmcuCiAgICAgICAgICAgICAqIE90aGVyd2lzZSwgcmV0dXJucyBhbiBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIG1lbWJlcnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqICAgfCBtZW1iZXIgbmFtZSAgIHwgRGVzY3JpcHRpb24gICAgfAogICAgICAgICAgICAgKiAgIHwtLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICAgICAgICogICB8IGhyZWYgICAgICAgICAgfCBBIG5vcm1hbGl6ZWQgdmVyc2lvbiBvZiB0aGUgcHJvdmlkZWQgVVJMIGlmIGl0IHdhcyBub3QgYW4gYWJzb2x1dGUgVVJMIHwKICAgICAgICAgICAgICogICB8IHByb3RvY29sICAgICAgfCBUaGUgcHJvdG9jb2wgaW5jbHVkaW5nIHRoZSB0cmFpbGluZyBjb2xvbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogICB8IGhvc3QgICAgICAgICAgfCBUaGUgaG9zdCBhbmQgcG9ydCAoaWYgdGhlIHBvcnQgaXMgbm9uLWRlZmF1bHQpIG9mIHRoZSBub3JtYWxpemVkVXJsICAgIHwKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogVGhlc2UgZmllbGRzIGZyb20gdGhlIFVybFV0aWxzIGludGVyZmFjZSBhcmUgY3VycmVudGx5IG5vdCBuZWVkZWQgYW5kIGhlbmNlIG5vdCByZXR1cm5lZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogICB8IG1lbWJlciBuYW1lICAgfCBEZXNjcmlwdGlvbiAgICB8CiAgICAgICAgICAgICAqICAgfC0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAgICAgKiAgIHwgaG9zdG5hbWUgICAgICB8IFRoZSBob3N0IHdpdGhvdXQgdGhlIHBvcnQgb2YgdGhlIG5vcm1hbGl6ZWRVcmwgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiAgIHwgcGF0aG5hbWUgICAgICB8IFRoZSBwYXRoIGZvbGxvd2luZyB0aGUgaG9zdCBpbiB0aGUgbm9ybWFsaXplZFVybCAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiAgIHwgaGFzaCAgICAgICAgICB8IFRoZSBVUkwgaGFzaCBpZiBwcmVzZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiAgIHwgc2VhcmNoICAgICAgICB8IFRoZSBxdWVyeSBzdHJpbmcgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZSh1cmwsIHBhcnNlKSB7CiAgICAgICAgICAgICAgICB2YXIgaHJlZiA9IHVybDsKICAgICAgICAgICAgICAgIGlmIChtc2llIDw9IDExKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTm9ybWFsaXplIGJlZm9yZSBwYXJzZS4gIFJlZmVyIEltcGxlbWVudGF0aW9uIE5vdGVzIG9uIHdoeSB0aGlzIGlzCiAgICAgICAgICAgICAgICAgICAgLy8gZG9uZSBpbiB0d28gc3RlcHMgb24gSUUuCiAgICAgICAgICAgICAgICAgICAgdXJsUGFyc2luZ05vZGUuc2V0QXR0cmlidXRlKCJocmVmIiwgaHJlZik7CiAgICAgICAgICAgICAgICAgICAgaHJlZiA9IHVybFBhcnNpbmdOb2RlLmhyZWY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1cmxQYXJzaW5nTm9kZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBocmVmKTsKCiAgICAgICAgICAgICAgICBpZiAoIXBhcnNlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVybFBhcnNpbmdOb2RlLmhyZWY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyB1cmxQYXJzaW5nTm9kZSBwcm92aWRlcyB0aGUgVXJsVXRpbHMgaW50ZXJmYWNlIC0gaHR0cDovL3VybC5zcGVjLndoYXR3Zy5vcmcvI3VybHV0aWxzCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIGhyZWY6IHVybFBhcnNpbmdOb2RlLmhyZWYsCiAgICAgICAgICAgICAgICAgICAgcHJvdG9jb2w6IHVybFBhcnNpbmdOb2RlLnByb3RvY29sLAogICAgICAgICAgICAgICAgICAgIGhvc3Q6IHVybFBhcnNpbmdOb2RlLmhvc3QKICAgICAgICAgICAgICAgICAgICAvLyBDdXJyZW50bHkgdW51c2VkIGFuZCBoZW5jZSBjb21tZW50ZWQgb3V0LgogICAgICAgICAgICAgICAgICAgIC8vIGhvc3RuYW1lOiB1cmxQYXJzaW5nTm9kZS5ob3N0bmFtZSwKICAgICAgICAgICAgICAgICAgICAvLyBwb3J0OiB1cmxQYXJzaW5nTm9kZS5wb3J0LAogICAgICAgICAgICAgICAgICAgIC8vIHBhdGhuYW1lOiB1cmxQYXJzaW5nTm9kZS5wYXRobmFtZSwKICAgICAgICAgICAgICAgICAgICAvLyBoYXNoOiB1cmxQYXJzaW5nTm9kZS5oYXNoLAogICAgICAgICAgICAgICAgICAgIC8vIHNlYXJjaDogdXJsUGFyc2luZ05vZGUuc2VhcmNoCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcmVzb2x2ZTogcmVzb2x2ZSwKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogUGFyc2UgYSByZXF1ZXN0IFVSTCBhbmQgZGV0ZXJtaW5lIHdoZXRoZXIgdGhpcyBpcyBhIHNhbWUtb3JpZ2luIHJlcXVlc3QgYXMgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50LgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gcmVxdWVzdFVybCBUaGUgdXJsIG9mIHRoZSByZXF1ZXN0IGFzIGEgc3RyaW5nIHRoYXQgd2lsbCBiZSByZXNvbHZlZAogICAgICAgICAgICAgICAgICogb3IgYSBwYXJzZWQgVVJMIG9iamVjdC4KICAgICAgICAgICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSByZXF1ZXN0IGlzIGZvciB0aGUgc2FtZSBvcmlnaW4gYXMgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50LgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBpc1NhbWVPcmlnaW46IGZ1bmN0aW9uIGlzU2FtZU9yaWdpbihyZXF1ZXN0VXJsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcnNlZCA9ICh0eXBlb2YgcmVxdWVzdFVybCA9PT0gJ3N0cmluZycpID8gcmVzb2x2ZShyZXF1ZXN0VXJsLCB0cnVlKSA6IHJlcXVlc3RVcmw7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChwYXJzZWQucHJvdG9jb2wgPT09IG9yaWdpblVybC5wcm90b2NvbCAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VkLmhvc3QgPT09IG9yaWdpblVybC5ob3N0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9XTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiR3aW5kb3cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEEgcmVmZXJlbmNlIHRvIHRoZSBicm93c2VyJ3MgYHdpbmRvd2Agb2JqZWN0LiBXaGlsZSBgd2luZG93YAogICAgICogaXMgZ2xvYmFsbHkgYXZhaWxhYmxlIGluIEphdmFTY3JpcHQsIGl0IGNhdXNlcyB0ZXN0YWJpbGl0eSBwcm9ibGVtcywgYmVjYXVzZQogICAgICogaXQgaXMgYSBnbG9iYWwgdmFyaWFibGUuIEluIGFuZ3VsYXIgd2UgYWx3YXlzIHJlZmVyIHRvIGl0IHRocm91Z2ggdGhlCiAgICAgKiBgJHdpbmRvd2Agc2VydmljZSwgc28gaXQgbWF5IGJlIG92ZXJyaWRkZW4sIHJlbW92ZWQgb3IgbW9ja2VkIGZvciB0ZXN0aW5nLgogICAgICoKICAgICAqIEV4cHJlc3Npb25zLCBsaWtlIHRoZSBvbmUgZGVmaW5lZCBmb3IgdGhlIGBuZ0NsaWNrYCBkaXJlY3RpdmUgaW4gdGhlIGV4YW1wbGUKICAgICAqIGJlbG93LCBhcmUgZXZhbHVhdGVkIHdpdGggcmVzcGVjdCB0byB0aGUgY3VycmVudCBzY29wZS4gIFRoZXJlZm9yZSwgdGhlcmUgaXMKICAgICAqIG5vIHJpc2sgb2YgaW5hZHZlcnRlbnRseSBjb2RpbmcgaW4gYSBkZXBlbmRlbmN5IG9uIGEgZ2xvYmFsIHZhbHVlIGluIHN1Y2ggYW4KICAgICAqIGV4cHJlc3Npb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlLCAkd2luZG93KSB7CiAgICAgICAgICAgICAgICRzY29wZS4kd2luZG93ID0gJHdpbmRvdzsKICAgICAgICAgICAgICAgJHNjb3BlLmdyZWV0aW5nID0gJ0hlbGxvLCBXb3JsZCEnOwogICAgICAgICAgICAgfQogICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9ImdyZWV0aW5nIiAvPgogICAgICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iJHdpbmRvdy5hbGVydChncmVldGluZykiPkFMRVJUPC9idXR0b24+CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgIGl0KCdzaG91bGQgZGlzcGxheSB0aGUgZ3JlZXRpbmcgaW4gdGhlIGlucHV0IGJveCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGlucHV0KCdncmVldGluZycpLmVudGVyKCdIZWxsbywgRTJFIFRlc3RzJyk7CiAgICAgICAgICAgLy8gSWYgd2UgY2xpY2sgdGhlIGJ1dHRvbiBpdCB3aWxsIGJsb2NrIHRoZSB0ZXN0IHJ1bm5lcgogICAgICAgICAgIC8vIGVsZW1lbnQoJzpidXR0b24nKS5jbGljaygpOwogICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgZnVuY3Rpb24gJFdpbmRvd1Byb3ZpZGVyKCkgewogICAgICAgIHRoaXMuJGdldCA9IHZhbHVlRm4od2luZG93KTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIG5nLiRmaWx0ZXJQcm92aWRlcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogRmlsdGVycyBhcmUganVzdCBmdW5jdGlvbnMgd2hpY2ggdHJhbnNmb3JtIGlucHV0IHRvIGFuIG91dHB1dC4gSG93ZXZlciBmaWx0ZXJzIG5lZWQgdG8gYmUgRGVwZW5kZW5jeSBJbmplY3RlZC4gVG8KICAgICAqIGFjaGlldmUgdGhpcyBhIGZpbHRlciBkZWZpbml0aW9uIGNvbnNpc3RzIG9mIGEgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcyBhbm5vdGF0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgYW5kIGlzCiAgICAgKiByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgYSBmaWx0ZXIgZnVuY3Rpb24uCiAgICAgKgogICAgICogPHByZT4KICAgICAqICAgLy8gRmlsdGVyIHJlZ2lzdHJhdGlvbgogICAgICogICBmdW5jdGlvbiBNeU1vZHVsZSgkcHJvdmlkZSwgJGZpbHRlclByb3ZpZGVyKSB7CiAgICAgKiAgICAgLy8gY3JlYXRlIGEgc2VydmljZSB0byBkZW1vbnN0cmF0ZSBpbmplY3Rpb24gKG5vdCBhbHdheXMgbmVlZGVkKQogICAgICogICAgICRwcm92aWRlLnZhbHVlKCdncmVldCcsIGZ1bmN0aW9uKG5hbWUpewogICAgICogICAgICAgcmV0dXJuICdIZWxsbyAnICsgbmFtZSArICchJzsKICAgICAqICAgICB9KTsKICAgICAqCiAgICAgKiAgICAgLy8gcmVnaXN0ZXIgYSBmaWx0ZXIgZmFjdG9yeSB3aGljaCB1c2VzIHRoZQogICAgICogICAgIC8vIGdyZWV0IHNlcnZpY2UgdG8gZGVtb25zdHJhdGUgREkuCiAgICAgKiAgICAgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCdncmVldCcsIGZ1bmN0aW9uKGdyZWV0KXsKICAgICAqICAgICAgIC8vIHJldHVybiB0aGUgZmlsdGVyIGZ1bmN0aW9uIHdoaWNoIHVzZXMgdGhlIGdyZWV0IHNlcnZpY2UKICAgICAqICAgICAgIC8vIHRvIGdlbmVyYXRlIHNhbHV0YXRpb24KICAgICAqICAgICAgIHJldHVybiBmdW5jdGlvbih0ZXh0KSB7CiAgICAgKiAgICAgICAgIC8vIGZpbHRlcnMgbmVlZCB0byBiZSBmb3JnaXZpbmcgc28gY2hlY2sgaW5wdXQgdmFsaWRpdHkKICAgICAqICAgICAgICAgcmV0dXJuIHRleHQgJiYgZ3JlZXQodGV4dCkgfHwgdGV4dDsKICAgICAqICAgICAgIH07CiAgICAgKiAgICAgfSk7CiAgICAgKiAgIH0KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoZSBmaWx0ZXIgZnVuY3Rpb24gaXMgcmVnaXN0ZXJlZCB3aXRoIHRoZSBgJGluamVjdG9yYCB1bmRlciB0aGUgZmlsdGVyIG5hbWUgc3VmZml4IHdpdGggYEZpbHRlcmAuCiAgICAgKiA8cHJlPgogICAgICogICBpdCgnc2hvdWxkIGJlIHRoZSBzYW1lIGluc3RhbmNlJywgaW5qZWN0KAogICAgICogICAgIGZ1bmN0aW9uKCRmaWx0ZXJQcm92aWRlcikgewogICAgICogICAgICAgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCdyZXZlcnNlJywgZnVuY3Rpb24oKXsKICAgICAqICAgICAgICAgcmV0dXJuIC4uLjsKICAgICAqICAgICAgIH0pOwogICAgICogICAgIH0sCiAgICAgKiAgICAgZnVuY3Rpb24oJGZpbHRlciwgcmV2ZXJzZUZpbHRlcikgewogICAgICogICAgICAgZXhwZWN0KCRmaWx0ZXIoJ3JldmVyc2UnKSkudG9CZShyZXZlcnNlRmlsdGVyKTsKICAgICAqICAgICB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqCiAgICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBob3cgYW5ndWxhciBmaWx0ZXJzIHdvcmssIGFuZCBob3cgdG8gY3JlYXRlIHlvdXIgb3duIGZpbHRlcnMsIHNlZQogICAgICoge0BsaW5rIGd1aWRlL2Rldl9ndWlkZS50ZW1wbGF0ZXMuZmlsdGVycyBVbmRlcnN0YW5kaW5nIEFuZ3VsYXIgRmlsdGVyc30gaW4gdGhlIGFuZ3VsYXIgRGV2ZWxvcGVyCiAgICAgKiBHdWlkZS4KICAgICAqLwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAqIEBtZXRob2RPZiBuZy4kZmlsdGVyUHJvdmlkZXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXIgZmlsdGVyIGZhY3RvcnkgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyLgogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZm4gVGhlIGZpbHRlciBmYWN0b3J5IGZ1bmN0aW9uIHdoaWNoIGlzIGluamVjdGFibGUuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLiRmaWx0ZXIKICAgICAqIEBmdW5jdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGaWx0ZXJzIGFyZSB1c2VkIGZvciBmb3JtYXR0aW5nIGRhdGEgZGlzcGxheWVkIHRvIHRoZSB1c2VyLgogICAgICoKICAgICAqIFRoZSBnZW5lcmFsIHN5bnRheCBpbiB0ZW1wbGF0ZXMgaXMgYXMgZm9sbG93czoKICAgICAqCiAgICAgKiAgICAgICAgIHt7IGV4cHJlc3Npb24gW3wgZmlsdGVyX25hbWVbOnBhcmFtZXRlcl92YWx1ZV0gLi4uIF0gfX0KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIgZnVuY3Rpb24gdG8gcmV0cmlldmUKICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgKi8KICAgICRGaWx0ZXJQcm92aWRlci4kaW5qZWN0ID0gWyckcHJvdmlkZSddOwogICAgZnVuY3Rpb24gJEZpbHRlclByb3ZpZGVyKCRwcm92aWRlKSB7CiAgICAgICAgdmFyIHN1ZmZpeCA9ICdGaWx0ZXInOwoKICAgICAgICBmdW5jdGlvbiByZWdpc3RlcihuYW1lLCBmYWN0b3J5KSB7CiAgICAgICAgICAgIHJldHVybiAkcHJvdmlkZS5mYWN0b3J5KG5hbWUgKyBzdWZmaXgsIGZhY3RvcnkpOwogICAgICAgIH0KICAgICAgICB0aGlzLnJlZ2lzdGVyID0gcmVnaXN0ZXI7CgogICAgICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgZnVuY3Rpb24gKCRpbmplY3RvcikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkaW5qZWN0b3IuZ2V0KG5hbWUgKyBzdWZmaXgpOwogICAgICAgICAgICB9CiAgICAgICAgfV07CgogICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAgICAgcmVnaXN0ZXIoJ2N1cnJlbmN5JywgY3VycmVuY3lGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdkYXRlJywgZGF0ZUZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ2ZpbHRlcicsIGZpbHRlckZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ2pzb24nLCBqc29uRmlsdGVyKTsKICAgICAgICByZWdpc3RlcignbGltaXRUbycsIGxpbWl0VG9GaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdsb3dlcmNhc2UnLCBsb3dlcmNhc2VGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdudW1iZXInLCBudW1iZXJGaWx0ZXIpOwogICAgICAgIHJlZ2lzdGVyKCdvcmRlckJ5Jywgb3JkZXJCeUZpbHRlcik7CiAgICAgICAgcmVnaXN0ZXIoJ3VwcGVyY2FzZScsIHVwcGVyY2FzZUZpbHRlcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6ZmlsdGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNlbGVjdHMgYSBzdWJzZXQgb2YgaXRlbXMgZnJvbSBgYXJyYXlgIGFuZCByZXR1cm5zIGl0IGFzIGEgbmV3IGFycmF5LgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICAgKiB7QGxpbmsgbmcuJGZpbHRlcn0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIHNvdXJjZSBhcnJheS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdHxmdW5jdGlvbigpfSBleHByZXNzaW9uIFRoZSBwcmVkaWNhdGUgdG8gYmUgdXNlZCBmb3Igc2VsZWN0aW5nIGl0ZW1zIGZyb20KICAgICAqICAgYGFycmF5YC4KICAgICAqCiAgICAgKiAgIENhbiBiZSBvbmUgb2Y6CiAgICAgKgogICAgICogICAtIGBzdHJpbmdgOiBQcmVkaWNhdGUgdGhhdCByZXN1bHRzIGluIGEgc3Vic3RyaW5nIG1hdGNoIHVzaW5nIHRoZSB2YWx1ZSBvZiBgZXhwcmVzc2lvbmAKICAgICAqICAgICBzdHJpbmcuIEFsbCBzdHJpbmdzIG9yIG9iamVjdHMgd2l0aCBzdHJpbmcgcHJvcGVydGllcyBpbiBgYXJyYXlgIHRoYXQgY29udGFpbiB0aGlzIHN0cmluZwogICAgICogICAgIHdpbGwgYmUgcmV0dXJuZWQuIFRoZSBwcmVkaWNhdGUgY2FuIGJlIG5lZ2F0ZWQgYnkgcHJlZml4aW5nIHRoZSBzdHJpbmcgd2l0aCBgIWAuCiAgICAgKgogICAgICogICAtIGBPYmplY3RgOiBBIHBhdHRlcm4gb2JqZWN0IGNhbiBiZSB1c2VkIHRvIGZpbHRlciBzcGVjaWZpYyBwcm9wZXJ0aWVzIG9uIG9iamVjdHMgY29udGFpbmVkCiAgICAgKiAgICAgYnkgYGFycmF5YC4gRm9yIGV4YW1wbGUgYHtuYW1lOiJNIiwgcGhvbmU6IjEifWAgcHJlZGljYXRlIHdpbGwgcmV0dXJuIGFuIGFycmF5IG9mIGl0ZW1zCiAgICAgKiAgICAgd2hpY2ggaGF2ZSBwcm9wZXJ0eSBgbmFtZWAgY29udGFpbmluZyAiTSIgYW5kIHByb3BlcnR5IGBwaG9uZWAgY29udGFpbmluZyAiMSIuIEEgc3BlY2lhbAogICAgICogICAgIHByb3BlcnR5IG5hbWUgYCRgIGNhbiBiZSB1c2VkIChhcyBpbiBgeyQ6InRleHQifWApIHRvIGFjY2VwdCBhIG1hdGNoIGFnYWluc3QgYW55CiAgICAgKiAgICAgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4gVGhhdCdzIGVxdWl2YWxlbnQgdG8gdGhlIHNpbXBsZSBzdWJzdHJpbmcgbWF0Y2ggd2l0aCBhIGBzdHJpbmdgCiAgICAgKiAgICAgYXMgZGVzY3JpYmVkIGFib3ZlLgogICAgICoKICAgICAqICAgLSBgZnVuY3Rpb25gOiBBIHByZWRpY2F0ZSBmdW5jdGlvbiBjYW4gYmUgdXNlZCB0byB3cml0ZSBhcmJpdHJhcnkgZmlsdGVycy4gVGhlIGZ1bmN0aW9uIGlzCiAgICAgKiAgICAgY2FsbGVkIGZvciBlYWNoIGVsZW1lbnQgb2YgYGFycmF5YC4gVGhlIGZpbmFsIHJlc3VsdCBpcyBhbiBhcnJheSBvZiB0aG9zZSBlbGVtZW50cyB0aGF0CiAgICAgKiAgICAgdGhlIHByZWRpY2F0ZSByZXR1cm5lZCB0cnVlIGZvci4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV4cGVjdGVkLCBhY3R1YWwpfHRydWV8dW5kZWZpbmVkfSBjb21wYXJhdG9yIENvbXBhcmF0b3Igd2hpY2ggaXMgdXNlZCBpbgogICAgICogICAgIGRldGVybWluaW5nIGlmIHRoZSBleHBlY3RlZCB2YWx1ZSAoZnJvbSB0aGUgZmlsdGVyIGV4cHJlc3Npb24pIGFuZCBhY3R1YWwgdmFsdWUgKGZyb20KICAgICAqICAgICB0aGUgb2JqZWN0IGluIHRoZSBhcnJheSkgc2hvdWxkIGJlIGNvbnNpZGVyZWQgYSBtYXRjaC4KICAgICAqCiAgICAgKiAgIENhbiBiZSBvbmUgb2Y6CiAgICAgKgogICAgICogICAgIC0gYGZ1bmN0aW9uKGV4cGVjdGVkLCBhY3R1YWwpYDoKICAgICAqICAgICAgIFRoZSBmdW5jdGlvbiB3aWxsIGJlIGdpdmVuIHRoZSBvYmplY3QgdmFsdWUgYW5kIHRoZSBwcmVkaWNhdGUgdmFsdWUgdG8gY29tcGFyZSBhbmQKICAgICAqICAgICAgIHNob3VsZCByZXR1cm4gdHJ1ZSBpZiB0aGUgaXRlbSBzaG91bGQgYmUgaW5jbHVkZWQgaW4gZmlsdGVyZWQgcmVzdWx0LgogICAgICoKICAgICAqICAgICAtIGB0cnVlYDogQSBzaG9ydGhhbmQgZm9yIGBmdW5jdGlvbihleHBlY3RlZCwgYWN0dWFsKSB7IHJldHVybiBhbmd1bGFyLmVxdWFscyhleHBlY3RlZCwgYWN0dWFsKX1gLgogICAgICogICAgICAgdGhpcyBpcyBlc3NlbnRpYWxseSBzdHJpY3QgY29tcGFyaXNvbiBvZiBleHBlY3RlZCBhbmQgYWN0dWFsLgogICAgICoKICAgICAqICAgICAtIGBmYWxzZXx1bmRlZmluZWRgOiBBIHNob3J0IGhhbmQgZm9yIGEgZnVuY3Rpb24gd2hpY2ggd2lsbCBsb29rIGZvciBhIHN1YnN0cmluZyBtYXRjaCBpbiBjYXNlCiAgICAgKiAgICAgICBpbnNlbnNpdGl2ZSB3YXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgPGRpdiBuZy1pbml0PSJmcmllbmRzID0gW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjc2J30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtuYW1lOidNYXJ5JywgcGhvbmU6JzgwMC1CSUctTUFSWSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonTWlrZScsIHBob25lOic1NTUtNDMyMSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7bmFtZTonSnVsaWUnLCBwaG9uZTonNTU1LTg3NjUnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge25hbWU6J0p1bGlldHRlJywgcGhvbmU6JzU1NS01Njc4J31dIj48L2Rpdj4KICAgIAogICAgICAgICAgIFNlYXJjaDogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2hUZXh0Ij4KICAgICAgICAgICA8dGFibGUgaWQ9InNlYXJjaFRleHRSZXN1bHRzIj4KICAgICAgICAgICAgIDx0cj48dGg+TmFtZTwvdGg+PHRoPlBob25lPC90aD48L3RyPgogICAgICAgICAgICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBmaWx0ZXI6c2VhcmNoVGV4dCI+CiAgICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICAgICAgICAgICAgICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgICAgPGhyPgogICAgICAgICAgIEFueTogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2guJCI+IDxicj4KICAgICAgICAgICBOYW1lIG9ubHkgPGlucHV0IG5nLW1vZGVsPSJzZWFyY2gubmFtZSI+PGJyPgogICAgICAgICAgIFBob25lIG9ubHkgPGlucHV0IG5nLW1vZGVsPSJzZWFyY2gucGhvbmUiPjxicj4KICAgICAgICAgICBFcXVhbGl0eSA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJzdHJpY3QiPjxicj4KICAgICAgICAgICA8dGFibGUgaWQ9InNlYXJjaE9ialJlc3VsdHMiPgogICAgICAgICAgICAgPHRyPjx0aD5OYW1lPC90aD48dGg+UGhvbmU8L3RoPjwvdHI+CiAgICAgICAgICAgICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2g6c3RyaWN0Ij4KICAgICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgPC90YWJsZT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgIGl0KCdzaG91bGQgc2VhcmNoIGFjcm9zcyBhbGwgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGlucHV0KCdzZWFyY2hUZXh0JykuZW50ZXIoJ20nKTsKICAgICAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaFRleHRSZXN1bHRzIHRyJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICAgICAgdG9FcXVhbChbJ01hcnknLCAnTWlrZScsICdBZGFtJ10pOwogICAgCiAgICAgICAgICAgICBpbnB1dCgnc2VhcmNoVGV4dCcpLmVudGVyKCc3NicpOwogICAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCcjc2VhcmNoVGV4dFJlc3VsdHMgdHInLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgICAgICB0b0VxdWFsKFsnSm9obicsICdKdWxpZSddKTsKICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgIGl0KCdzaG91bGQgc2VhcmNoIGluIHNwZWNpZmljIGZpZWxkcyB3aGVuIGZpbHRlcmluZyB3aXRoIGEgcHJlZGljYXRlIG9iamVjdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgaW5wdXQoJ3NlYXJjaC4kJykuZW50ZXIoJ2knKTsKICAgICAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaE9ialJlc3VsdHMgdHInLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgICAgICB0b0VxdWFsKFsnTWFyeScsICdNaWtlJywgJ0p1bGllJywgJ0p1bGlldHRlJ10pOwogICAgICAgICAgIH0pOwogICAgICAgICAgIGl0KCdzaG91bGQgdXNlIGEgZXF1YWwgY29tcGFyaXNvbiB3aGVuIGNvbXBhcmF0b3IgaXMgdHJ1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgaW5wdXQoJ3NlYXJjaC5uYW1lJykuZW50ZXIoJ0p1bGllJyk7CiAgICAgICAgICAgICBpbnB1dCgnc3RyaWN0JykuY2hlY2soKTsKICAgICAgICAgICAgIGV4cGVjdChyZXBlYXRlcignI3NlYXJjaE9ialJlc3VsdHMgdHInLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgICAgICB0b0VxdWFsKFsnSnVsaWUnXSk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgZnVuY3Rpb24gZmlsdGVyRmlsdGVyKCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJyYXksIGV4cHJlc3Npb24sIGNvbXBlcmF0b3IpIHsKICAgICAgICAgICAgaWYgKCFpc0FycmF5KGFycmF5KSkgcmV0dXJuIGFycmF5OwogICAgICAgICAgICB2YXIgcHJlZGljYXRlcyA9IFtdOwogICAgICAgICAgICBwcmVkaWNhdGVzLmNoZWNrID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHByZWRpY2F0ZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXByZWRpY2F0ZXNbal0odmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgY29tcGVyYXRvcikgewogICAgICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBlcmF0b3IgPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb21wZXJhdG9yID0gZnVuY3Rpb24gKG9iaiwgdGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuZXF1YWxzKG9iaiwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBjb21wZXJhdG9yID0gZnVuY3Rpb24gKG9iaiwgdGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gKCcnICsgdGV4dCkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgnJyArIG9iaikudG9Mb3dlckNhc2UoKS5pbmRleE9mKHRleHQpID4gLTEKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzZWFyY2ggPSBmdW5jdGlvbiAob2JqLCB0ZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRleHQgPT0gJ3N0cmluZycgJiYgdGV4dC5jaGFyQXQoMCkgPT09ICchJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhc2VhcmNoKG9iaiwgdGV4dC5zdWJzdHIoMSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlb2Ygb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29tcGVyYXRvcihvYmosIHRleHQpOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBlcmF0b3Iob2JqLCB0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgb2JqS2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqS2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmIHNlYXJjaChvYmpbb2JqS2V5XSwgdGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBjYXNlICJhcnJheSI6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VhcmNoKG9ialtpXSwgdGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBleHByZXNzaW9uKSB7CiAgICAgICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB7ICQ6IGV4cHJlc3Npb24gfTsKICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnJCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFleHByZXNzaW9uW2tleV0pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IGtleQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZXMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaCh2YWx1ZSwgZXhwcmVzc2lvbltwYXRoXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIChleHByZXNzaW9uW2tleV0pID09ICd1bmRlZmluZWQnKSB7IHJldHVybjsgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZXMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlYXJjaChnZXR0ZXIodmFsdWUsIHBhdGgpLCBleHByZXNzaW9uW3BhdGhdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbHRlcmVkID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXJyYXkubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2pdOwogICAgICAgICAgICAgICAgaWYgKHByZWRpY2F0ZXMuY2hlY2sodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZpbHRlcmVkOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpjdXJyZW5jeQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGb3JtYXRzIGEgbnVtYmVyIGFzIGEgY3VycmVuY3kgKGllICQxLDIzNC41NikuIFdoZW4gbm8gY3VycmVuY3kgc3ltYm9sIGlzIHByb3ZpZGVkLCBkZWZhdWx0CiAgICAgKiBzeW1ib2wgZm9yIGN1cnJlbnQgbG9jYWxlIGlzIHVzZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCBJbnB1dCB0byBmaWx0ZXIuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHN5bWJvbCBDdXJyZW5jeSBzeW1ib2wgb3IgaWRlbnRpZmllciB0byBiZSBkaXNwbGF5ZWQuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBGb3JtYXR0ZWQgbnVtYmVyLgogICAgICoKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLmFtb3VudCA9IDEyMzQuNTY7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIG5nLW1vZGVsPSJhbW91bnQiPiA8YnI+CiAgICAgICAgICAgICBkZWZhdWx0IGN1cnJlbmN5IHN5bWJvbCAoJCk6IHt7YW1vdW50IHwgY3VycmVuY3l9fTxicj4KICAgICAgICAgICAgIGN1c3RvbSBjdXJyZW5jeSBpZGVudGlmaWVyIChVU0QkKToge3thbW91bnQgfCBjdXJyZW5jeToiVVNEJCJ9fQogICAgICAgICAgIDwvZGl2PgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBpbml0IHdpdGggMTIzNC41NicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5JykpLnRvQmUoJyQxLDIzNC41NicpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIicpKS50b0JlKCdVU0QkMSwyMzQuNTYnKTsKICAgICAgICAgICB9KTsKICAgICAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgaW5wdXQoJ2Ftb3VudCcpLmVudGVyKCctMTIzNCcpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5JykpLnRvQmUoJygkMSwyMzQuMDApJyk7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLnRvQmUoJyhVU0QkMSwyMzQuMDApJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgY3VycmVuY3lGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogICAgZnVuY3Rpb24gY3VycmVuY3lGaWx0ZXIoJGxvY2FsZSkgewogICAgICAgIHZhciBmb3JtYXRzID0gJGxvY2FsZS5OVU1CRVJfRk9STUFUUzsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGFtb3VudCwgY3VycmVuY3lTeW1ib2wpIHsKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGN1cnJlbmN5U3ltYm9sKSkgY3VycmVuY3lTeW1ib2wgPSBmb3JtYXRzLkNVUlJFTkNZX1NZTTsKICAgICAgICAgICAgcmV0dXJuIGZvcm1hdE51bWJlcihhbW91bnQsIGZvcm1hdHMuUEFUVEVSTlNbMV0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLCAyKS4KICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZSgvXHUwMEE0L2csIGN1cnJlbmN5U3ltYm9sKTsKICAgICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOm51bWJlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBGb3JtYXRzIGEgbnVtYmVyIGFzIHRleHQuCiAgICAgKgogICAgICogSWYgdGhlIGlucHV0IGlzIG5vdCBhIG51bWJlciBhbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBudW1iZXIgTnVtYmVyIHRvIGZvcm1hdC4KICAgICAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmcpPX0gZnJhY3Rpb25TaXplIE51bWJlciBvZiBkZWNpbWFsIHBsYWNlcyB0byByb3VuZCB0aGUgbnVtYmVyIHRvLgogICAgICogSWYgdGhpcyBpcyBub3QgcHJvdmlkZWQgdGhlbiB0aGUgZnJhY3Rpb24gc2l6ZSBpcyBjb21wdXRlZCBmcm9tIHRoZSBjdXJyZW50IGxvY2FsZSdzIG51bWJlcgogICAgICogZm9ybWF0dGluZyBwYXR0ZXJuLiBJbiB0aGUgY2FzZSBvZiB0aGUgZGVmYXVsdCBsb2NhbGUsIGl0IHdpbGwgYmUgMy4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE51bWJlciByb3VuZGVkIHRvIGRlY2ltYWxQbGFjZXMgYW5kIHBsYWNlcyBhIOKAnCzigJ0gYWZ0ZXIgZWFjaCB0aGlyZCBkaWdpdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLnZhbCA9IDEyMzQuNTY3ODk7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIEVudGVyIG51bWJlcjogPGlucHV0IG5nLW1vZGVsPSd2YWwnPjxicj4KICAgICAgICAgICAgIERlZmF1bHQgZm9ybWF0dGluZzoge3t2YWwgfCBudW1iZXJ9fTxicj4KICAgICAgICAgICAgIE5vIGZyYWN0aW9uczoge3t2YWwgfCBudW1iZXI6MH19PGJyPgogICAgICAgICAgICAgTmVnYXRpdmUgbnVtYmVyOiB7ey12YWwgfCBudW1iZXI6NH19CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCBudW1iZXJzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsIHwgbnVtYmVyJykpLnRvQmUoJzEsMjM0LjU2OCcpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcjowJykpLnRvQmUoJzEsMjM1Jyk7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnLXZhbCB8IG51bWJlcjo0JykpLnRvQmUoJy0xLDIzNC41Njc5Jyk7CiAgICAgICAgICAgfSk7CiAgICAKICAgICAgICAgICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgaW5wdXQoJ3ZhbCcpLmVudGVyKCczMzc0LjMzMycpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbCB8IG51bWJlcicpKS50b0JlKCczLDM3NC4zMzMnKTsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWwgfCBudW1iZXI6MCcpKS50b0JlKCczLDM3NCcpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS50b0JlKCctMywzNzQuMzMzMCcpOwogICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KCgogICAgbnVtYmVyRmlsdGVyLiRpbmplY3QgPSBbJyRsb2NhbGUnXTsKICAgIGZ1bmN0aW9uIG51bWJlckZpbHRlcigkbG9jYWxlKSB7CiAgICAgICAgdmFyIGZvcm1hdHMgPSAkbG9jYWxlLk5VTUJFUl9GT1JNQVRTOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAobnVtYmVyLCBmcmFjdGlvblNpemUpIHsKICAgICAgICAgICAgcmV0dXJuIGZvcm1hdE51bWJlcihudW1iZXIsIGZvcm1hdHMuUEFUVEVSTlNbMF0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLAogICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgfTsKICAgIH0KCiAgICB2YXIgREVDSU1BTF9TRVAgPSAnLic7CiAgICBmdW5jdGlvbiBmb3JtYXROdW1iZXIobnVtYmVyLCBwYXR0ZXJuLCBncm91cFNlcCwgZGVjaW1hbFNlcCwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgaWYgKGlzTmFOKG51bWJlcikgfHwgIWlzRmluaXRlKG51bWJlcikpIHJldHVybiAnJzsKCiAgICAgICAgdmFyIGlzTmVnYXRpdmUgPSBudW1iZXIgPCAwOwogICAgICAgIG51bWJlciA9IE1hdGguYWJzKG51bWJlcik7CiAgICAgICAgdmFyIG51bVN0ciA9IG51bWJlciArICcnLAogICAgICAgICAgICBmb3JtYXRlZFRleHQgPSAnJywKICAgICAgICAgICAgcGFydHMgPSBbXTsKCiAgICAgICAgdmFyIGhhc0V4cG9uZW50ID0gZmFsc2U7CiAgICAgICAgaWYgKG51bVN0ci5pbmRleE9mKCdlJykgIT09IC0xKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IG51bVN0ci5tYXRjaCgvKFtcZFwuXSspZSgtPykoXGQrKS8pOwogICAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMl0gPT0gJy0nICYmIG1hdGNoWzNdID4gZnJhY3Rpb25TaXplICsgMSkgewogICAgICAgICAgICAgICAgbnVtU3RyID0gJzAnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ID0gbnVtU3RyOwogICAgICAgICAgICAgICAgaGFzRXhwb25lbnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhhc0V4cG9uZW50KSB7CiAgICAgICAgICAgIHZhciBmcmFjdGlvbkxlbiA9IChudW1TdHIuc3BsaXQoREVDSU1BTF9TRVApWzFdIHx8ICcnKS5sZW5ndGg7CgogICAgICAgICAgICAvLyBkZXRlcm1pbmUgZnJhY3Rpb25TaXplIGlmIGl0IGlzIG5vdCBzcGVjaWZpZWQKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGZyYWN0aW9uU2l6ZSkpIHsKICAgICAgICAgICAgICAgIGZyYWN0aW9uU2l6ZSA9IE1hdGgubWluKE1hdGgubWF4KHBhdHRlcm4ubWluRnJhYywgZnJhY3Rpb25MZW4pLCBwYXR0ZXJuLm1heEZyYWMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcG93ID0gTWF0aC5wb3coMTAsIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgICAgIG51bWJlciA9IE1hdGgucm91bmQobnVtYmVyICogcG93KSAvIHBvdzsKICAgICAgICAgICAgdmFyIGZyYWN0aW9uID0gKCcnICsgbnVtYmVyKS5zcGxpdChERUNJTUFMX1NFUCk7CiAgICAgICAgICAgIHZhciB3aG9sZSA9IGZyYWN0aW9uWzBdOwogICAgICAgICAgICBmcmFjdGlvbiA9IGZyYWN0aW9uWzFdIHx8ICcnOwoKICAgICAgICAgICAgdmFyIHBvcyA9IDAsCiAgICAgICAgICAgICAgICBsZ3JvdXAgPSBwYXR0ZXJuLmxnU2l6ZSwKICAgICAgICAgICAgICAgIGdyb3VwID0gcGF0dGVybi5nU2l6ZTsKCiAgICAgICAgICAgIGlmICh3aG9sZS5sZW5ndGggPj0gKGxncm91cCArIGdyb3VwKSkgewogICAgICAgICAgICAgICAgcG9zID0gd2hvbGUubGVuZ3RoIC0gbGdyb3VwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwb3M7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICgocG9zIC0gaSkgJSBncm91cCA9PT0gMCAmJiBpICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IHdob2xlLmNoYXJBdChpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChpID0gcG9zOyBpIDwgd2hvbGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICgod2hvbGUubGVuZ3RoIC0gaSkgJSBsZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZvcm1hdCBmcmFjdGlvbiBwYXJ0LgogICAgICAgICAgICB3aGlsZSAoZnJhY3Rpb24ubGVuZ3RoIDwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgICAgICAgICBmcmFjdGlvbiArPSAnMCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmcmFjdGlvblNpemUgJiYgZnJhY3Rpb25TaXplICE9PSAiMCIpIGZvcm1hdGVkVGV4dCArPSBkZWNpbWFsU2VwICsgZnJhY3Rpb24uc3Vic3RyKDAsIGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIGlmIChmcmFjdGlvblNpemUgPiAwICYmIG51bWJlciA+IC0xICYmIG51bWJlciA8IDEpIHsKICAgICAgICAgICAgICAgIGZvcm1hdGVkVGV4dCA9IG51bWJlci50b0ZpeGVkKGZyYWN0aW9uU2l6ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBhcnRzLnB1c2goaXNOZWdhdGl2ZSA/IHBhdHRlcm4ubmVnUHJlIDogcGF0dGVybi5wb3NQcmUpOwogICAgICAgIHBhcnRzLnB1c2goZm9ybWF0ZWRUZXh0KTsKICAgICAgICBwYXJ0cy5wdXNoKGlzTmVnYXRpdmUgPyBwYXR0ZXJuLm5lZ1N1ZiA6IHBhdHRlcm4ucG9zU3VmKTsKICAgICAgICByZXR1cm4gcGFydHMuam9pbignJyk7CiAgICB9CgogICAgZnVuY3Rpb24gcGFkTnVtYmVyKG51bSwgZGlnaXRzLCB0cmltKSB7CiAgICAgICAgdmFyIG5lZyA9ICcnOwogICAgICAgIGlmIChudW0gPCAwKSB7CiAgICAgICAgICAgIG5lZyA9ICctJzsKICAgICAgICAgICAgbnVtID0gLW51bTsKICAgICAgICB9CiAgICAgICAgbnVtID0gJycgKyBudW07CiAgICAgICAgd2hpbGUgKG51bS5sZW5ndGggPCBkaWdpdHMpIG51bSA9ICcwJyArIG51bTsKICAgICAgICBpZiAodHJpbSkKICAgICAgICAgICAgbnVtID0gbnVtLnN1YnN0cihudW0ubGVuZ3RoIC0gZGlnaXRzKTsKICAgICAgICByZXR1cm4gbmVnICsgbnVtOwogICAgfQoKCiAgICBmdW5jdGlvbiBkYXRlR2V0dGVyKG5hbWUsIHNpemUsIG9mZnNldCwgdHJpbSkgewogICAgICAgIG9mZnNldCA9IG9mZnNldCB8fCAwOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZGF0ZSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKICAgICAgICAgICAgaWYgKG9mZnNldCA+IDAgfHwgdmFsdWUgPiAtb2Zmc2V0KQogICAgICAgICAgICAgICAgdmFsdWUgKz0gb2Zmc2V0OwogICAgICAgICAgICBpZiAodmFsdWUgPT09IDAgJiYgb2Zmc2V0ID09IC0xMikgdmFsdWUgPSAxMjsKICAgICAgICAgICAgcmV0dXJuIHBhZE51bWJlcih2YWx1ZSwgc2l6ZSwgdHJpbSk7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBkYXRlU3RyR2V0dGVyKG5hbWUsIHNob3J0Rm9ybSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoZGF0ZSwgZm9ybWF0cykgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKICAgICAgICAgICAgdmFyIGdldCA9IHVwcGVyY2FzZShzaG9ydEZvcm0gPyAoJ1NIT1JUJyArIG5hbWUpIDogbmFtZSk7CgogICAgICAgICAgICByZXR1cm4gZm9ybWF0c1tnZXRdW3ZhbHVlXTsKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHRpbWVab25lR2V0dGVyKGRhdGUpIHsKICAgICAgICB2YXIgem9uZSA9IC0xICogZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgICAgIHZhciBwYWRkZWRab25lID0gKHpvbmUgPj0gMCkgPyAiKyIgOiAiIjsKCiAgICAgICAgcGFkZGVkWm9uZSArPSBwYWROdW1iZXIoTWF0aFt6b25lID4gMCA/ICdmbG9vcicgOiAnY2VpbCddKHpvbmUgLyA2MCksIDIpICsKICAgICAgICAgICAgICAgICAgICAgIHBhZE51bWJlcihNYXRoLmFicyh6b25lICUgNjApLCAyKTsKCiAgICAgICAgcmV0dXJuIHBhZGRlZFpvbmU7CiAgICB9CgogICAgZnVuY3Rpb24gYW1wbUdldHRlcihkYXRlLCBmb3JtYXRzKSB7CiAgICAgICAgcmV0dXJuIGRhdGUuZ2V0SG91cnMoKSA8IDEyID8gZm9ybWF0cy5BTVBNU1swXSA6IGZvcm1hdHMuQU1QTVNbMV07CiAgICB9CgogICAgdmFyIERBVEVfRk9STUFUUyA9IHsKICAgICAgICB5eXl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDQpLAogICAgICAgIHl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDIsIDAsIHRydWUpLAogICAgICAgIHk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMSksCiAgICAgICAgTU1NTTogZGF0ZVN0ckdldHRlcignTW9udGgnKSwKICAgICAgICBNTU06IGRhdGVTdHJHZXR0ZXIoJ01vbnRoJywgdHJ1ZSksCiAgICAgICAgTU06IGRhdGVHZXR0ZXIoJ01vbnRoJywgMiwgMSksCiAgICAgICAgTTogZGF0ZUdldHRlcignTW9udGgnLCAxLCAxKSwKICAgICAgICBkZDogZGF0ZUdldHRlcignRGF0ZScsIDIpLAogICAgICAgIGQ6IGRhdGVHZXR0ZXIoJ0RhdGUnLCAxKSwKICAgICAgICBISDogZGF0ZUdldHRlcignSG91cnMnLCAyKSwKICAgICAgICBIOiBkYXRlR2V0dGVyKCdIb3VycycsIDEpLAogICAgICAgIGhoOiBkYXRlR2V0dGVyKCdIb3VycycsIDIsIC0xMiksCiAgICAgICAgaDogZGF0ZUdldHRlcignSG91cnMnLCAxLCAtMTIpLAogICAgICAgIG1tOiBkYXRlR2V0dGVyKCdNaW51dGVzJywgMiksCiAgICAgICAgbTogZGF0ZUdldHRlcignTWludXRlcycsIDEpLAogICAgICAgIHNzOiBkYXRlR2V0dGVyKCdTZWNvbmRzJywgMiksCiAgICAgICAgczogZGF0ZUdldHRlcignU2Vjb25kcycsIDEpLAogICAgICAgIC8vIHdoaWxlIElTTyA4NjAxIHJlcXVpcmVzIGZyYWN0aW9ucyB0byBiZSBwcmVmaXhlZCB3aXRoIGAuYCBvciBgLGAKICAgICAgICAvLyB3ZSBjYW4gYmUganVzdCBzYWZlbHkgcmVseSBvbiB1c2luZyBgc3NzYCBzaW5jZSB3ZSBjdXJyZW50bHkgZG9uJ3Qgc3VwcG9ydCBzaW5nbGUgb3IgdHdvIGRpZ2l0IGZyYWN0aW9ucwogICAgICAgIHNzczogZGF0ZUdldHRlcignTWlsbGlzZWNvbmRzJywgMyksCiAgICAgICAgRUVFRTogZGF0ZVN0ckdldHRlcignRGF5JyksCiAgICAgICAgRUVFOiBkYXRlU3RyR2V0dGVyKCdEYXknLCB0cnVlKSwKICAgICAgICBhOiBhbXBtR2V0dGVyLAogICAgICAgIFo6IHRpbWVab25lR2V0dGVyCiAgICB9OwoKICAgIHZhciBEQVRFX0ZPUk1BVFNfU1BMSVQgPSAvKCg/OlteeU1kSGhtc2FaRSddKyl8KD86Jyg/OlteJ118JycpKicpfCg/OkUrfHkrfE0rfGQrfEgrfGgrfG0rfHMrfGF8WikpKC4qKS8sCiAgICAgICAgTlVNQkVSX1NUUklORyA9IC9eXGQrJC87CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZmlsdGVyCiAgICAgKiBAbmFtZSBuZy5maWx0ZXI6ZGF0ZQogICAgICogQGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiAgIEZvcm1hdHMgYGRhdGVgIHRvIGEgc3RyaW5nIGJhc2VkIG9uIHRoZSByZXF1ZXN0ZWQgYGZvcm1hdGAuCiAgICAgKgogICAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGJlIGNvbXBvc2VkIG9mIHRoZSBmb2xsb3dpbmcgZWxlbWVudHM6CiAgICAgKgogICAgICogICAqIGAneXl5eSdgOiA0IGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIgKGUuZy4gQUQgMSA9PiAwMDAxLCBBRCAyMDEwID0+IDIwMTApCiAgICAgKiAgICogYCd5eSdgOiAyIGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIsIHBhZGRlZCAoMDAtOTkpLiAoZS5nLiBBRCAyMDAxID0+IDAxLCBBRCAyMDEwID0+IDEwKQogICAgICogICAqIGAneSdgOiAxIGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIsIGUuZy4gKEFEIDEgPT4gMSwgQUQgMTk5ID0+IDE5OSkKICAgICAqICAgKiBgJ01NTU0nYDogTW9udGggaW4geWVhciAoSmFudWFyeS1EZWNlbWJlcikKICAgICAqICAgKiBgJ01NTSdgOiBNb250aCBpbiB5ZWFyIChKYW4tRGVjKQogICAgICogICAqIGAnTU0nYDogTW9udGggaW4geWVhciwgcGFkZGVkICgwMS0xMikKICAgICAqICAgKiBgJ00nYDogTW9udGggaW4geWVhciAoMS0xMikKICAgICAqICAgKiBgJ2RkJ2A6IERheSBpbiBtb250aCwgcGFkZGVkICgwMS0zMSkKICAgICAqICAgKiBgJ2QnYDogRGF5IGluIG1vbnRoICgxLTMxKQogICAgICogICAqIGAnRUVFRSdgOiBEYXkgaW4gV2VlaywoU3VuZGF5LVNhdHVyZGF5KQogICAgICogICAqIGAnRUVFJ2A6IERheSBpbiBXZWVrLCAoU3VuLVNhdCkKICAgICAqICAgKiBgJ0hIJ2A6IEhvdXIgaW4gZGF5LCBwYWRkZWQgKDAwLTIzKQogICAgICogICAqIGAnSCdgOiBIb3VyIGluIGRheSAoMC0yMykKICAgICAqICAgKiBgJ2hoJ2A6IEhvdXIgaW4gYW0vcG0sIHBhZGRlZCAoMDEtMTIpCiAgICAgKiAgICogYCdoJ2A6IEhvdXIgaW4gYW0vcG0sICgxLTEyKQogICAgICogICAqIGAnbW0nYDogTWludXRlIGluIGhvdXIsIHBhZGRlZCAoMDAtNTkpCiAgICAgKiAgICogYCdtJ2A6IE1pbnV0ZSBpbiBob3VyICgwLTU5KQogICAgICogICAqIGAnc3MnYDogU2Vjb25kIGluIG1pbnV0ZSwgcGFkZGVkICgwMC01OSkKICAgICAqICAgKiBgJ3MnYDogU2Vjb25kIGluIG1pbnV0ZSAoMC01OSkKICAgICAqICAgKiBgJy5zc3MnIG9yICcsc3NzJ2A6IE1pbGxpc2Vjb25kIGluIHNlY29uZCwgcGFkZGVkICgwMDAtOTk5KQogICAgICogICAqIGAnYSdgOiBhbS9wbSBtYXJrZXIKICAgICAqICAgKiBgJ1onYDogNCBkaWdpdCAoK3NpZ24pIHJlcHJlc2VudGF0aW9uIG9mIHRoZSB0aW1lem9uZSBvZmZzZXQgKC0xMjAwLSsxMjAwKQogICAgICoKICAgICAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBhbHNvIGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nIHByZWRlZmluZWQKICAgICAqICAge0BsaW5rIGd1aWRlL2kxOG4gbG9jYWxpemFibGUgZm9ybWF0c306CiAgICAgKgogICAgICogICAqIGAnbWVkaXVtJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSBoOm1tOnNzIGEnYCBmb3IgZW5fVVMgbG9jYWxlCiAgICAgKiAgICAgKGUuZy4gU2VwIDMsIDIwMTAgMTI6MDU6MDggcG0pCiAgICAgKiAgICogYCdzaG9ydCdgOiBlcXVpdmFsZW50IHRvIGAnTS9kL3l5IGg6bW0gYSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIDkvMy8xMCAxMjowNSBwbSkKICAgICAqICAgKiBgJ2Z1bGxEYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdFRUVFLCBNTU1NIGQseSdgIGZvciBlbl9VUyAgbG9jYWxlCiAgICAgKiAgICAgKGUuZy4gRnJpZGF5LCBTZXB0ZW1iZXIgMywgMjAxMCkKICAgICAqICAgKiBgJ2xvbmdEYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU1NIGQsIHknYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiBTZXB0ZW1iZXIgMywgMjAxMCkKICAgICAqICAgKiBgJ21lZGl1bURhdGUnYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5J2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gU2VwIDMsIDIwMTApCiAgICAgKiAgICogYCdzaG9ydERhdGUnYDogZXF1aXZhbGVudCB0byBgJ00vZC95eSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gOS8zLzEwKQogICAgICogICAqIGAnbWVkaXVtVGltZSdgOiBlcXVpdmFsZW50IHRvIGAnaDptbTpzcyBhJ2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiAxMjowNTowOCBwbSkKICAgICAqICAgKiBgJ3Nob3J0VGltZSdgOiBlcXVpdmFsZW50IHRvIGAnaDptbSBhJ2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiAxMjowNSBwbSkKICAgICAqCiAgICAgKiAgIGBmb3JtYXRgIHN0cmluZyBjYW4gY29udGFpbiBsaXRlcmFsIHZhbHVlcy4gVGhlc2UgbmVlZCB0byBiZSBxdW90ZWQgd2l0aCBzaW5nbGUgcXVvdGVzIChlLmcuCiAgICAgKiAgIGAiaCAnaW4gdGhlIG1vcm5pbmcnImApLiBJbiBvcmRlciB0byBvdXRwdXQgc2luZ2xlIHF1b3RlLCB1c2UgdHdvIHNpbmdsZSBxdW90ZXMgaW4gYSBzZXF1ZW5jZQogICAgICogICAoZS5nLiBgImggJ28nJ2Nsb2NrJyJgKS4KICAgICAqCiAgICAgKiBAcGFyYW0geyhEYXRlfG51bWJlcnxzdHJpbmcpfSBkYXRlIERhdGUgdG8gZm9ybWF0IGVpdGhlciBhcyBEYXRlIG9iamVjdCwgbWlsbGlzZWNvbmRzIChzdHJpbmcgb3IKICAgICAqICAgIG51bWJlcikgb3IgdmFyaW91cyBJU08gODYwMSBkYXRldGltZSBzdHJpbmcgZm9ybWF0cyAoZS5nLiB5eXl5LU1NLWRkVEhIOm1tOnNzLlNTU1ogYW5kIGl0cwogICAgICogICAgc2hvcnRlciB2ZXJzaW9ucyBsaWtlIHl5eXktTU0tZGRUSEg6bW1aLCB5eXl5LU1NLWRkIG9yIHl5eXlNTWRkVEhIbW1zc1opLiBJZiBubyB0aW1lem9uZSBpcwogICAgICogICAgc3BlY2lmaWVkIGluIHRoZSBzdHJpbmcgaW5wdXQsIHRoZSB0aW1lIGlzIGNvbnNpZGVyZWQgdG8gYmUgaW4gdGhlIGxvY2FsIHRpbWV6b25lLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBmb3JtYXQgRm9ybWF0dGluZyBydWxlcyAoc2VlIERlc2NyaXB0aW9uKS4gSWYgbm90IHNwZWNpZmllZCwKICAgICAqICAgIGBtZWRpdW1EYXRlYCBpcyB1c2VkLgogICAgICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIHN0cmluZyBvciB0aGUgaW5wdXQgaWYgaW5wdXQgaXMgbm90IHJlY29nbml6ZWQgYXMgZGF0ZS9taWxsaXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSd9fTwvc3Bhbj46CiAgICAgICAgICAgICAgIHt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSd9fTxicj4KICAgICAgICAgICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJ319PC9zcGFuPjoKICAgICAgICAgICAgICB7ezEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonfX08YnI+CiAgICAgICAgICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSd9fTwvc3Bhbj46CiAgICAgICAgICAgICAge3snMTI4ODMyMzYyMzAwNicgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnfX08YnI+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIGZvcm1hdCBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygiMTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSciKSkuCiAgICAgICAgICAgICAgICB0b01hdGNoKC9PY3QgMlxkLCAyMDEwIFxkezEsMn06XGR7Mn06XGR7Mn0gKEFNfFBNKS8pOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoIjEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonIikpLgogICAgICAgICAgICAgICAgdG9NYXRjaCgvMjAxMFwtMTBcLTJcZCBcZHsyfTpcZHsyfTpcZHsyfSAoXC18XCspP1xkezR9Lyk7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygiJzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJyIpKS4KICAgICAgICAgICAgICAgIHRvTWF0Y2goLzEwXC8yXGRcLzIwMTAgQCBcZHsxLDJ9OlxkezJ9KEFNfFBNKS8pOwogICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIGRhdGVGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogICAgZnVuY3Rpb24gZGF0ZUZpbHRlcigkbG9jYWxlKSB7CgoKICAgICAgICB2YXIgUl9JU084NjAxX1NUUiA9IC9eKFxkezR9KS0/KFxkXGQpLT8oXGRcZCkoPzpUKFxkXGQpKD86Oj8oXGRcZCkoPzo6PyhcZFxkKSg/OlwuKFxkKykpPyk/KT8oWnwoWystXSkoXGRcZCk6PyhcZFxkKSk/KT8kLzsKICAgICAgICAvLyAxICAgICAgICAyICAgICAgIDMgICAgICAgICA0ICAgICAgICAgIDUgICAgICAgICAgNiAgICAgICAgICA3ICAgICAgICAgIDggIDkgICAgIDEwICAgICAgMTEKICAgICAgICBmdW5jdGlvbiBqc29uU3RyaW5nVG9EYXRlKHN0cmluZykgewogICAgICAgICAgICB2YXIgbWF0Y2g7CiAgICAgICAgICAgIGlmIChtYXRjaCA9IHN0cmluZy5tYXRjaChSX0lTTzg2MDFfU1RSKSkgewogICAgICAgICAgICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgwKSwKICAgICAgICAgICAgICAgICAgICB0ekhvdXIgPSAwLAogICAgICAgICAgICAgICAgICAgIHR6TWluID0gMCwKICAgICAgICAgICAgICAgICAgICBkYXRlU2V0dGVyID0gbWF0Y2hbOF0gPyBkYXRlLnNldFVUQ0Z1bGxZZWFyIDogZGF0ZS5zZXRGdWxsWWVhciwKICAgICAgICAgICAgICAgICAgICB0aW1lU2V0dGVyID0gbWF0Y2hbOF0gPyBkYXRlLnNldFVUQ0hvdXJzIDogZGF0ZS5zZXRIb3VyczsKCiAgICAgICAgICAgICAgICBpZiAobWF0Y2hbOV0pIHsKICAgICAgICAgICAgICAgICAgICB0ekhvdXIgPSBpbnQobWF0Y2hbOV0gKyBtYXRjaFsxMF0pOwogICAgICAgICAgICAgICAgICAgIHR6TWluID0gaW50KG1hdGNoWzldICsgbWF0Y2hbMTFdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRhdGVTZXR0ZXIuY2FsbChkYXRlLCBpbnQobWF0Y2hbMV0pLCBpbnQobWF0Y2hbMl0pIC0gMSwgaW50KG1hdGNoWzNdKSk7CiAgICAgICAgICAgICAgICB2YXIgaCA9IGludChtYXRjaFs0XSB8fCAwKSAtIHR6SG91cjsKICAgICAgICAgICAgICAgIHZhciBtID0gaW50KG1hdGNoWzVdIHx8IDApIC0gdHpNaW4KICAgICAgICAgICAgICAgIHZhciBzID0gaW50KG1hdGNoWzZdIHx8IDApOwogICAgICAgICAgICAgICAgdmFyIG1zID0gTWF0aC5yb3VuZChwYXJzZUZsb2F0KCcwLicgKyAobWF0Y2hbN10gfHwgMCkpICogMTAwMCk7CiAgICAgICAgICAgICAgICB0aW1lU2V0dGVyLmNhbGwoZGF0ZSwgaCwgbSwgcywgbXMpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9CgoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGUsIGZvcm1hdCkgewogICAgICAgICAgICB2YXIgdGV4dCA9ICcnLAogICAgICAgICAgICAgICAgcGFydHMgPSBbXSwKICAgICAgICAgICAgICAgIGZuLCBtYXRjaDsKCiAgICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdCB8fCAnbWVkaXVtRGF0ZSc7CiAgICAgICAgICAgIGZvcm1hdCA9ICRsb2NhbGUuREFURVRJTUVfRk9STUFUU1tmb3JtYXRdIHx8IGZvcm1hdDsKICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGRhdGUpKSB7CiAgICAgICAgICAgICAgICBpZiAoTlVNQkVSX1NUUklORy50ZXN0KGRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IGludChkYXRlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IGpzb25TdHJpbmdUb0RhdGUoZGF0ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpc051bWJlcihkYXRlKSkgewogICAgICAgICAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKGRhdGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWlzRGF0ZShkYXRlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaWxlIChmb3JtYXQpIHsKICAgICAgICAgICAgICAgIG1hdGNoID0gREFURV9GT1JNQVRTX1NQTElULmV4ZWMoZm9ybWF0KTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gY29uY2F0KHBhcnRzLCBtYXRjaCwgMSk7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gcGFydHMucG9wKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcnRzLnB1c2goZm9ybWF0KTsKICAgICAgICAgICAgICAgICAgICBmb3JtYXQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3JFYWNoKHBhcnRzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGZuID0gREFURV9GT1JNQVRTW3ZhbHVlXTsKICAgICAgICAgICAgICAgIHRleHQgKz0gZm4gPyBmbihkYXRlLCAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdmFsdWUucmVwbGFjZSgvKF4nfCckKS9nLCAnJykucmVwbGFjZSgvJycvZywgIiciKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgICB9OwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmaWx0ZXIKICAgICAqIEBuYW1lIG5nLmZpbHRlcjpqc29uCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqICAgQWxsb3dzIHlvdSB0byBjb252ZXJ0IGEgSmF2YVNjcmlwdCBvYmplY3QgaW50byBKU09OIHN0cmluZy4KICAgICAqCiAgICAgKiAgIFRoaXMgZmlsdGVyIGlzIG1vc3RseSB1c2VmdWwgZm9yIGRlYnVnZ2luZy4gV2hlbiB1c2luZyB0aGUgZG91YmxlIGN1cmx5IHt7dmFsdWV9fSBub3RhdGlvbgogICAgICogICB0aGUgYmluZGluZyBpcyBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBKU09OLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IEFueSBKYXZhU2NyaXB0IG9iamVjdCAoaW5jbHVkaW5nIGFycmF5cyBhbmQgcHJpbWl0aXZlIHR5cGVzKSB0byBmaWx0ZXIuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBKU09OIHN0cmluZy4KICAgICAqCiAgICAgKgogICAgICogQGV4YW1wbGU6CiAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgIDxwcmU+e3sgeyduYW1lJzondmFsdWUnfSB8IGpzb24gfX08L3ByZT4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgIGl0KCdzaG91bGQganNvbmlmeSBmaWx0ZXJlZCBvYmplY3RzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygieyduYW1lJzondmFsdWUnfSIpKS50b01hdGNoKC9ce1xuICAibmFtZSI6ID8idmFsdWUiXG59Lyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKi8KICAgIGZ1bmN0aW9uIGpzb25GaWx0ZXIoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRvSnNvbihvYmplY3QsIHRydWUpOwogICAgICAgIH07CiAgICB9CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOmxvd2VyY2FzZQogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENvbnZlcnRzIHN0cmluZyB0byBsb3dlcmNhc2UuCiAgICAgKiBAc2VlIGFuZ3VsYXIubG93ZXJjYXNlCiAgICAgKi8KICAgIHZhciBsb3dlcmNhc2VGaWx0ZXIgPSB2YWx1ZUZuKGxvd2VyY2FzZSk7CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZpbHRlcgogICAgICogQG5hbWUgbmcuZmlsdGVyOnVwcGVyY2FzZQogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENvbnZlcnRzIHN0cmluZyB0byB1cHBlcmNhc2UuCiAgICAgKiBAc2VlIGFuZ3VsYXIudXBwZXJjYXNlCiAgICAgKi8KICAgIHZhciB1cHBlcmNhc2VGaWx0ZXIgPSB2YWx1ZUZuKHVwcGVyY2FzZSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIG5nLmZpbHRlcjpsaW1pdFRvCiAgICAgKiBAZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBuZXcgYXJyYXkgb3Igc3RyaW5nIGNvbnRhaW5pbmcgb25seSBhIHNwZWNpZmllZCBudW1iZXIgb2YgZWxlbWVudHMuIFRoZSBlbGVtZW50cwogICAgICogYXJlIHRha2VuIGZyb20gZWl0aGVyIHRoZSBiZWdpbm5pbmcgb3IgdGhlIGVuZCBvZiB0aGUgc291cmNlIGFycmF5IG9yIHN0cmluZywgYXMgc3BlY2lmaWVkIGJ5CiAgICAgKiB0aGUgdmFsdWUgYW5kIHNpZ24gKHBvc2l0aXZlIG9yIG5lZ2F0aXZlKSBvZiBgbGltaXRgLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBgQXJyYXlgIHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICAgKiB7QGxpbmsgbmcuJGZpbHRlcn0gZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgQW5ndWxhciBhcnJheXMuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheXxzdHJpbmd9IGlucHV0IFNvdXJjZSBhcnJheSBvciBzdHJpbmcgdG8gYmUgbGltaXRlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gbGltaXQgVGhlIGxlbmd0aCBvZiB0aGUgcmV0dXJuZWQgYXJyYXkgb3Igc3RyaW5nLiBJZiB0aGUgYGxpbWl0YCBudW1iZXIgCiAgICAgKiAgICAgaXMgcG9zaXRpdmUsIGBsaW1pdGAgbnVtYmVyIG9mIGl0ZW1zIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgc291cmNlIGFycmF5L3N0cmluZyBhcmUgY29waWVkLgogICAgICogICAgIElmIHRoZSBudW1iZXIgaXMgbmVnYXRpdmUsIGBsaW1pdGAgbnVtYmVyICBvZiBpdGVtcyBmcm9tIHRoZSBlbmQgb2YgdGhlIHNvdXJjZSBhcnJheS9zdHJpbmcgCiAgICAgKiAgICAgYXJlIGNvcGllZC4gVGhlIGBsaW1pdGAgd2lsbCBiZSB0cmltbWVkIGlmIGl0IGV4Y2VlZHMgYGFycmF5Lmxlbmd0aGAKICAgICAqIEByZXR1cm5zIHtBcnJheXxzdHJpbmd9IEEgbmV3IHN1Yi1hcnJheSBvciBzdWJzdHJpbmcgb2YgbGVuZ3RoIGBsaW1pdGAgb3IgbGVzcyBpZiBpbnB1dCBhcnJheQogICAgICogICAgIGhhZCBsZXNzIHRoYW4gYGxpbWl0YCBlbGVtZW50cy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLm51bWJlcnMgPSBbMSwyLDMsNCw1LDYsNyw4LDldOwogICAgICAgICAgICAgICAkc2NvcGUubGV0dGVycyA9ICJhYmNkZWZnaGkiOwogICAgICAgICAgICAgICAkc2NvcGUubnVtTGltaXQgPSAzOwogICAgICAgICAgICAgICAkc2NvcGUubGV0dGVyTGltaXQgPSAzOwogICAgICAgICAgICAgfQogICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgICBMaW1pdCB7e251bWJlcnN9fSB0bzogPGlucHV0IHR5cGU9ImludGVnZXIiIG5nLW1vZGVsPSJudW1MaW1pdCI+CiAgICAgICAgICAgICA8cD5PdXRwdXQgbnVtYmVyczoge3sgbnVtYmVycyB8IGxpbWl0VG86bnVtTGltaXQgfX08L3A+CiAgICAgICAgICAgICBMaW1pdCB7e2xldHRlcnN9fSB0bzogPGlucHV0IHR5cGU9ImludGVnZXIiIG5nLW1vZGVsPSJsZXR0ZXJMaW1pdCI+CiAgICAgICAgICAgICA8cD5PdXRwdXQgbGV0dGVyczoge3sgbGV0dGVycyB8IGxpbWl0VG86bGV0dGVyTGltaXQgfX08L3A+CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIGxpbWl0IHRoZSBudW1iZXIgYXJyYXkgdG8gZmlyc3QgdGhyZWUgaXRlbXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBpbnB1dFtuZy1tb2RlbD1udW1MaW1pdF0nKS52YWwoKSkudG9CZSgnMycpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGlucHV0W25nLW1vZGVsPWxldHRlckxpbWl0XScpLnZhbCgpKS50b0JlKCczJyk7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bnVtTGltaXQnKSkudG9FcXVhbCgnWzEsMiwzXScpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xldHRlcnMgfCBsaW1pdFRvOmxldHRlckxpbWl0JykpLnRvRXF1YWwoJ2FiYycpOwogICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgdGhlIG91dHB1dCB3aGVuIC0zIGlzIGVudGVyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGlucHV0KCdudW1MaW1pdCcpLmVudGVyKC0zKTsKICAgICAgICAgICAgIGlucHV0KCdsZXR0ZXJMaW1pdCcpLmVudGVyKC0zKTsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdudW1iZXJzIHwgbGltaXRUbzpudW1MaW1pdCcpKS50b0VxdWFsKCdbNyw4LDldJyk7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbGV0dGVycyB8IGxpbWl0VG86bGV0dGVyTGltaXQnKSkudG9FcXVhbCgnZ2hpJyk7CiAgICAgICAgICAgfSk7CiAgICAKICAgICAgICAgICBpdCgnc2hvdWxkIG5vdCBleGNlZWQgdGhlIG1heGltdW0gc2l6ZSBvZiBpbnB1dCBhcnJheScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgaW5wdXQoJ251bUxpbWl0JykuZW50ZXIoMTAwKTsKICAgICAgICAgICAgIGlucHV0KCdsZXR0ZXJMaW1pdCcpLmVudGVyKDEwMCk7CiAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bnVtTGltaXQnKSkudG9FcXVhbCgnWzEsMiwzLDQsNSw2LDcsOCw5XScpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xldHRlcnMgfCBsaW1pdFRvOmxldHRlckxpbWl0JykpLnRvRXF1YWwoJ2FiY2RlZmdoaScpOwogICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIGZ1bmN0aW9uIGxpbWl0VG9GaWx0ZXIoKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChpbnB1dCwgbGltaXQpIHsKICAgICAgICAgICAgaWYgKCFpc0FycmF5KGlucHV0KSAmJiAhaXNTdHJpbmcoaW5wdXQpKSByZXR1cm4gaW5wdXQ7CgogICAgICAgICAgICBsaW1pdCA9IGludChsaW1pdCk7CgogICAgICAgICAgICBpZiAoaXNTdHJpbmcoaW5wdXQpKSB7CiAgICAgICAgICAgICAgICAvL05hTiBjaGVjayBvbiBsaW1pdAogICAgICAgICAgICAgICAgaWYgKGxpbWl0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxpbWl0ID49IDAgPyBpbnB1dC5zbGljZSgwLCBsaW1pdCkgOiBpbnB1dC5zbGljZShsaW1pdCwgaW5wdXQubGVuZ3RoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgb3V0ID0gW10sCiAgICAgICAgICAgICAgaSwgbjsKCiAgICAgICAgICAgIC8vIGlmIGFicyhsaW1pdCkgZXhjZWVkcyBtYXhpbXVtIGxlbmd0aCwgdHJpbSBpdAogICAgICAgICAgICBpZiAobGltaXQgPiBpbnB1dC5sZW5ndGgpCiAgICAgICAgICAgICAgICBsaW1pdCA9IGlucHV0Lmxlbmd0aDsKICAgICAgICAgICAgZWxzZSBpZiAobGltaXQgPCAtaW5wdXQubGVuZ3RoKQogICAgICAgICAgICAgICAgbGltaXQgPSAtaW5wdXQubGVuZ3RoOwoKICAgICAgICAgICAgaWYgKGxpbWl0ID4gMCkgewogICAgICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgICAgICAgICBuID0gbGltaXQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpID0gaW5wdXQubGVuZ3RoICsgbGltaXQ7CiAgICAgICAgICAgICAgICBuID0gaW5wdXQubGVuZ3RoOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKDsgaSA8IG47IGkrKykgewogICAgICAgICAgICAgICAgb3V0LnB1c2goaW5wdXRbaV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gb3V0OwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgbmcuZmlsdGVyOm9yZGVyQnkKICAgICAqIEBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogT3JkZXJzIGEgc3BlY2lmaWVkIGBhcnJheWAgYnkgdGhlIGBleHByZXNzaW9uYCBwcmVkaWNhdGUuCiAgICAgKgogICAgICogTm90ZTogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGF1Z21lbnQgdGhlIGBBcnJheWAgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgICAqIHtAbGluayBuZy4kZmlsdGVyfSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc29ydC4KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKil8c3RyaW5nfEFycmF5LjwoZnVuY3Rpb24oKil8c3RyaW5nKT59IGV4cHJlc3Npb24gQSBwcmVkaWNhdGUgdG8gYmUKICAgICAqICAgIHVzZWQgYnkgdGhlIGNvbXBhcmF0b3IgdG8gZGV0ZXJtaW5lIHRoZSBvcmRlciBvZiBlbGVtZW50cy4KICAgICAqCiAgICAgKiAgICBDYW4gYmUgb25lIG9mOgogICAgICoKICAgICAqICAgIC0gYGZ1bmN0aW9uYDogR2V0dGVyIGZ1bmN0aW9uLiBUaGUgcmVzdWx0IG9mIHRoaXMgZnVuY3Rpb24gd2lsbCBiZSBzb3J0ZWQgdXNpbmcgdGhlCiAgICAgKiAgICAgIGA8YCwgYD1gLCBgPmAgb3BlcmF0b3IuCiAgICAgKiAgICAtIGBzdHJpbmdgOiBBbiBBbmd1bGFyIGV4cHJlc3Npb24gd2hpY2ggZXZhbHVhdGVzIHRvIGFuIG9iamVjdCB0byBvcmRlciBieSwgc3VjaCBhcyAnbmFtZScKICAgICAqICAgICAgdG8gc29ydCBieSBhIHByb3BlcnR5IGNhbGxlZCAnbmFtZScuIE9wdGlvbmFsbHkgcHJlZml4ZWQgd2l0aCBgK2Agb3IgYC1gIHRvIGNvbnRyb2wKICAgICAqICAgICAgYXNjZW5kaW5nIG9yIGRlc2NlbmRpbmcgc29ydCBvcmRlciAoZm9yIGV4YW1wbGUsICtuYW1lIG9yIC1uYW1lKS4KICAgICAqICAgIC0gYEFycmF5YDogQW4gYXJyYXkgb2YgZnVuY3Rpb24gb3Igc3RyaW5nIHByZWRpY2F0ZXMuIFRoZSBmaXJzdCBwcmVkaWNhdGUgaW4gdGhlIGFycmF5CiAgICAgKiAgICAgIGlzIHVzZWQgZm9yIHNvcnRpbmcsIGJ1dCB3aGVuIHR3byBpdGVtcyBhcmUgZXF1aXZhbGVudCwgdGhlIG5leHQgcHJlZGljYXRlIGlzIHVzZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtib29sZWFuPX0gcmV2ZXJzZSBSZXZlcnNlIHRoZSBvcmRlciB0aGUgYXJyYXkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFNvcnRlZCBjb3B5IG9mIHRoZSBzb3VyY2UgYXJyYXkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAgICRzY29wZS5mcmllbmRzID0KICAgICAgICAgICAgICAgICAgIFt7bmFtZTonSm9obicsIHBob25lOic1NTUtMTIxMicsIGFnZToxMH0sCiAgICAgICAgICAgICAgICAgICAge25hbWU6J01hcnknLCBwaG9uZTonNTU1LTk4NzYnLCBhZ2U6MTl9LAogICAgICAgICAgICAgICAgICAgIHtuYW1lOidNaWtlJywgcGhvbmU6JzU1NS00MzIxJywgYWdlOjIxfSwKICAgICAgICAgICAgICAgICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCcsIGFnZTozNX0sCiAgICAgICAgICAgICAgICAgICAge25hbWU6J0p1bGllJywgcGhvbmU6JzU1NS04NzY1JywgYWdlOjI5fV0KICAgICAgICAgICAgICAgJHNjb3BlLnByZWRpY2F0ZSA9ICctYWdlJzsKICAgICAgICAgICAgIH0KICAgICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgICAgPHByZT5Tb3J0aW5nIHByZWRpY2F0ZSA9IHt7cHJlZGljYXRlfX07IHJldmVyc2UgPSB7e3JldmVyc2V9fTwvcHJlPgogICAgICAgICAgICAgPGhyLz4KICAgICAgICAgICAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlPScnIj51bnNvcnRlZDwvYT4gXQogICAgICAgICAgICAgPHRhYmxlIGNsYXNzPSJmcmllbmQiPgogICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICduYW1lJzsgcmV2ZXJzZT1mYWxzZSI+TmFtZTwvYT4KICAgICAgICAgICAgICAgICAgICAgKDxhIGhyZWYgbmctY2xpY2s9InByZWRpY2F0ZSA9ICctbmFtZSc7IHJldmVyc2U9ZmFsc2UiPl48L2E+KTwvdGg+CiAgICAgICAgICAgICAgICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICdwaG9uZSc7IHJldmVyc2U9IXJldmVyc2UiPlBob25lIE51bWJlcjwvYT48L3RoPgogICAgICAgICAgICAgICAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAnYWdlJzsgcmV2ZXJzZT0hcmV2ZXJzZSI+QWdlPC9hPjwvdGg+CiAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgIDx0ciBuZy1yZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIHwgb3JkZXJCeTpwcmVkaWNhdGU6cmV2ZXJzZSI+CiAgICAgICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgICAgICAgICAgICAgICAgPHRkPnt7ZnJpZW5kLnBob25lfX08L3RkPgogICAgICAgICAgICAgICAgIDx0ZD57e2ZyaWVuZC5hZ2V9fTwvdGQ+CiAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgIDwvZGl2PgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBiZSByZXZlcnNlIG9yZGVyZWQgYnkgYWdlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ByZWRpY2F0ZScpKS50b0JlKCctYWdlJyk7CiAgICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLmFnZScpKS4KICAgICAgICAgICAgICAgdG9FcXVhbChbJzM1JywgJzI5JywgJzIxJywgJzE5JywgJzEwJ10pOwogICAgICAgICAgICAgZXhwZWN0KHJlcGVhdGVyKCd0YWJsZS5mcmllbmQnLCAnZnJpZW5kIGluIGZyaWVuZHMnKS5jb2x1bW4oJ2ZyaWVuZC5uYW1lJykpLgogICAgICAgICAgICAgICB0b0VxdWFsKFsnQWRhbScsICdKdWxpZScsICdNaWtlJywgJ01hcnknLCAnSm9obiddKTsKICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgIGl0KCdzaG91bGQgcmVvcmRlciB0aGUgdGFibGUgd2hlbiB1c2VyIHNlbGVjdHMgZGlmZmVyZW50IHByZWRpY2F0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgYTpjb250YWlucygiTmFtZSIpJykuY2xpY2soKTsKICAgICAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICAgICAgdG9FcXVhbChbJ0FkYW0nLCAnSm9obicsICdKdWxpZScsICdNYXJ5JywgJ01pa2UnXSk7CiAgICAgICAgICAgICBleHBlY3QocmVwZWF0ZXIoJ3RhYmxlLmZyaWVuZCcsICdmcmllbmQgaW4gZnJpZW5kcycpLmNvbHVtbignZnJpZW5kLmFnZScpKS4KICAgICAgICAgICAgICAgdG9FcXVhbChbJzM1JywgJzEwJywgJzI5JywgJzE5JywgJzIxJ10pOwogICAgCiAgICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBhOmNvbnRhaW5zKCJQaG9uZSIpJykuY2xpY2soKTsKICAgICAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQucGhvbmUnKSkuCiAgICAgICAgICAgICAgIHRvRXF1YWwoWyc1NTUtOTg3NicsICc1NTUtODc2NScsICc1NTUtNTY3OCcsICc1NTUtNDMyMScsICc1NTUtMTIxMiddKTsKICAgICAgICAgICAgIGV4cGVjdChyZXBlYXRlcigndGFibGUuZnJpZW5kJywgJ2ZyaWVuZCBpbiBmcmllbmRzJykuY29sdW1uKCdmcmllbmQubmFtZScpKS4KICAgICAgICAgICAgICAgdG9FcXVhbChbJ01hcnknLCAnSnVsaWUnLCAnQWRhbScsICdNaWtlJywgJ0pvaG4nXSk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgb3JkZXJCeUZpbHRlci4kaW5qZWN0ID0gWyckcGFyc2UnXTsKICAgIGZ1bmN0aW9uIG9yZGVyQnlGaWx0ZXIoJHBhcnNlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhcnJheSwgc29ydFByZWRpY2F0ZSwgcmV2ZXJzZU9yZGVyKSB7CiAgICAgICAgICAgIGlmICghaXNBcnJheShhcnJheSkpIHJldHVybiBhcnJheTsKICAgICAgICAgICAgaWYgKCFzb3J0UHJlZGljYXRlKSByZXR1cm4gYXJyYXk7CiAgICAgICAgICAgIHNvcnRQcmVkaWNhdGUgPSBpc0FycmF5KHNvcnRQcmVkaWNhdGUpID8gc29ydFByZWRpY2F0ZSA6IFtzb3J0UHJlZGljYXRlXTsKICAgICAgICAgICAgc29ydFByZWRpY2F0ZSA9IG1hcChzb3J0UHJlZGljYXRlLCBmdW5jdGlvbiAocHJlZGljYXRlKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVzY2VuZGluZyA9IGZhbHNlLCBnZXQgPSBwcmVkaWNhdGUgfHwgaWRlbnRpdHk7CiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcocHJlZGljYXRlKSkgewogICAgICAgICAgICAgICAgICAgIGlmICgocHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnKycgfHwgcHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnLScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NlbmRpbmcgPSBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJzsKICAgICAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlID0gcHJlZGljYXRlLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZ2V0ID0gJHBhcnNlKHByZWRpY2F0ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmV2ZXJzZUNvbXBhcmF0b3IoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29tcGFyZShnZXQoYSksIGdldChiKSk7CiAgICAgICAgICAgICAgICB9LCBkZXNjZW5kaW5nKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBhcnJheUNvcHkgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgeyBhcnJheUNvcHkucHVzaChhcnJheVtpXSk7IH0KICAgICAgICAgICAgcmV0dXJuIGFycmF5Q29weS5zb3J0KHJldmVyc2VDb21wYXJhdG9yKGNvbXBhcmF0b3IsIHJldmVyc2VPcmRlcikpOwoKICAgICAgICAgICAgZnVuY3Rpb24gY29tcGFyYXRvcihvMSwgbzIpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydFByZWRpY2F0ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBjb21wID0gc29ydFByZWRpY2F0ZVtpXShvMSwgbzIpOwogICAgICAgICAgICAgICAgICAgIGlmIChjb21wICE9PSAwKSByZXR1cm4gY29tcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVyc2VDb21wYXJhdG9yKGNvbXAsIGRlc2NlbmRpbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0b0Jvb2xlYW4oZGVzY2VuZGluZykKICAgICAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uIChhLCBiKSB7IHJldHVybiBjb21wKGIsIGEpOyB9CiAgICAgICAgICAgICAgICAgICAgOiBjb21wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBhcmUodjEsIHYyKSB7CiAgICAgICAgICAgICAgICB2YXIgdDEgPSB0eXBlb2YgdjE7CiAgICAgICAgICAgICAgICB2YXIgdDIgPSB0eXBlb2YgdjI7CiAgICAgICAgICAgICAgICBpZiAodDEgPT0gdDIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodDEgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdjEgPSB2MS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB2MiA9IHYyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh2MSA9PT0gdjIpIHJldHVybiAwOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2MSA8IHYyID8gLTEgOiAxOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdDEgPCB0MiA/IC0xIDogMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBuZ0RpcmVjdGl2ZShkaXJlY3RpdmUpIHsKICAgICAgICBpZiAoaXNGdW5jdGlvbihkaXJlY3RpdmUpKSB7CiAgICAgICAgICAgIGRpcmVjdGl2ZSA9IHsKICAgICAgICAgICAgICAgIGxpbms6IGRpcmVjdGl2ZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQUMnOwogICAgICAgIHJldHVybiB2YWx1ZUZuKGRpcmVjdGl2ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6YQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIE1vZGlmaWVzIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIGh0bWwgQSB0YWcsIHNvIHRoYXQgdGhlIGRlZmF1bHQgYWN0aW9uIGlzIHByZXZlbnRlZCB3aGVuIGhyZWYKICAgICAqIGF0dHJpYnV0ZSBpcyBlbXB0eS4KICAgICAqCiAgICAgKiBUaGUgcmVhc29uaW5nIGZvciB0aGlzIGNoYW5nZSBpcyB0byBhbGxvdyBlYXN5IGNyZWF0aW9uIG9mIGFjdGlvbiBsaW5rcyB3aXRoIGBuZ0NsaWNrYCBkaXJlY3RpdmUKICAgICAqIHdpdGhvdXQgY2hhbmdpbmcgdGhlIGxvY2F0aW9uIG9yIGNhdXNpbmcgcGFnZSByZWxvYWRzLCBlLmcuOgogICAgICogYDxhIGhyZWY9IiIgbmctY2xpY2s9Im1vZGVsLiRzYXZlKCkiPlNhdmU8L2E+YAogICAgICovCiAgICB2YXIgaHRtbEFuY2hvckRpcmVjdGl2ZSA9IHZhbHVlRm4oewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIpIHsKCiAgICAgICAgICAgIGlmIChtc2llIDw9IDgpIHsKCiAgICAgICAgICAgICAgICAvLyB0dXJuIDxhIGhyZWYgbmctY2xpY2s9Ii4uIj5saW5rPC9hPiBpbnRvIGEgc3R5bGFibGUgbGluayBpbiBJRQogICAgICAgICAgICAgICAgLy8gYnV0IG9ubHkgaWYgaXQgZG9lc24ndCBoYXZlIG5hbWUgYXR0cmlidXRlLCBpbiB3aGljaCBjYXNlIGl0J3MgYW4gYW5jaG9yCiAgICAgICAgICAgICAgICBpZiAoIWF0dHIuaHJlZiAmJiAhYXR0ci5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCdocmVmJywgJycpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGFkZCBhIGNvbW1lbnQgbm9kZSB0byBhbmNob3JzIHRvIHdvcmthcm91bmQgSUUgYnVnIHRoYXQgY2F1c2VzIGVsZW1lbnQgY29udGVudCB0byBiZSByZXNldAogICAgICAgICAgICAgICAgLy8gdG8gbmV3IGF0dHJpYnV0ZSBjb250ZW50IGlmIGF0dHJpYnV0ZSBpcyB1cGRhdGVkIHdpdGggdmFsdWUgY29udGFpbmluZyBAIGFuZCBlbGVtZW50IGFsc28KICAgICAgICAgICAgICAgIC8vIGNvbnRhaW5zIHZhbHVlIHdpdGggQAogICAgICAgICAgICAgICAgLy8gc2VlIGlzc3VlICMxOTQ5CiAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZChkb2N1bWVudC5jcmVhdGVDb21tZW50KCdJRSBmaXgnKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgd2UgaGF2ZSBubyBocmVmIHVybCwgdGhlbiBkb24ndCBuYXZpZ2F0ZSBhbnl3aGVyZS4KICAgICAgICAgICAgICAgICAgICBpZiAoIWVsZW1lbnQuYXR0cignaHJlZicpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0hyZWYKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2luZyBBbmd1bGFyIG1hcmt1cCBsaWtlIHt7aGFzaH19IGluIGFuIGhyZWYgYXR0cmlidXRlIG1ha2VzCiAgICAgKiB0aGUgcGFnZSBvcGVuIHRvIGEgd3JvbmcgVVJMLCBpZiB0aGUgdXNlciBjbGlja3MgdGhhdCBsaW5rIGJlZm9yZQogICAgICogYW5ndWxhciBoYXMgYSBjaGFuY2UgdG8gcmVwbGFjZSB0aGUge3toYXNofX0gd2l0aCBhY3R1YWwgVVJMLCB0aGUKICAgICAqIGxpbmsgd2lsbCBiZSBicm9rZW4gYW5kIHdpbGwgbW9zdCBsaWtlbHkgcmV0dXJuIGEgNDA0IGVycm9yLgogICAgICogVGhlIGBuZ0hyZWZgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogICAgICoKICAgICAqIFRoZSBidWdneSB3YXkgdG8gd3JpdGUgaXQ6CiAgICAgKiA8cHJlPgogICAgICogPGEgaHJlZj0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBUaGUgY29ycmVjdCB3YXkgdG8gd3JpdGUgaXQ6CiAgICAgKiA8cHJlPgogICAgICogPGEgbmctaHJlZj0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBCiAgICAgKiBAcGFyYW0ge3RlbXBsYXRlfSBuZ0hyZWYgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBUaGlzIGV4YW1wbGUgdXNlcyBgbGlua2AgdmFyaWFibGUgaW5zaWRlIGBocmVmYCBhdHRyaWJ1dGU6CiAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgIDxpbnB1dCBuZy1tb2RlbD0idmFsdWUiIC8+PGJyIC8+CiAgICAgICAgICAgIDxhIGlkPSJsaW5rLTEiIGhyZWYgbmctY2xpY2s9InZhbHVlID0gMSI+bGluayAxPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgICAgICAgICA8YSBpZD0ibGluay0yIiBocmVmPSIiIG5nLWNsaWNrPSJ2YWx1ZSA9IDIiPmxpbmsgMjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgICAgICAgICAgPGEgaWQ9ImxpbmstMyIgbmctaHJlZj0iL3t7JzEyMyd9fSI+bGluayAzPC9hPiAobGluaywgcmVsb2FkISk8YnIgLz4KICAgICAgICAgICAgPGEgaWQ9ImxpbmstNCIgaHJlZj0iIiBuYW1lPSJ4eCIgbmctY2xpY2s9InZhbHVlID0gNCI+YW5jaG9yPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICAgICAgICAgICA8YSBpZD0ibGluay01IiBuYW1lPSJ4eHgiIG5nLWNsaWNrPSJ2YWx1ZSA9IDUiPmFuY2hvcjwvYT4gKG5vIGxpbmspPGJyIC8+CiAgICAgICAgICAgIDxhIGlkPSJsaW5rLTYiIG5nLWhyZWY9Int7dmFsdWV9fSI+bGluazwvYT4gKGxpbmssIGNoYW5nZSBsb2NhdGlvbikKICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIGhyZWYgd2l0aG91dCB2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTEnKS5jbGljaygpOwogICAgICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnMScpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay0xJykuYXR0cignaHJlZicpKS50b0JlKCIiKTsKICAgICAgICAgICAgfSk7CiAgICAKICAgICAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiBlbXB0eSBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBlbGVtZW50KCcjbGluay0yJykuY2xpY2soKTsKICAgICAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzInKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstMicpLmF0dHIoJ2hyZWYnKSkudG9CZSgiIik7CiAgICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBhbmQgY2hhbmdlIHVybCB3aGVuIG5nLWhyZWYgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTMnKS5hdHRyKCdocmVmJykpLnRvQmUoIi8xMjMiKTsKICAgIAogICAgICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTMnKS5jbGljaygpOwogICAgICAgICAgICAgIGV4cGVjdChicm93c2VyKCkud2luZG93KCkucGF0aCgpKS50b0VxdWFsKCcvMTIzJyk7CiAgICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIGhyZWYgZW1wdHkgc3RyaW5nIGFuZCBuYW1lIHNwZWNpZmllZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTQnKS5jbGljaygpOwogICAgICAgICAgICAgIGV4cGVjdChpbnB1dCgndmFsdWUnKS52YWwoKSkudG9FcXVhbCgnNCcpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjbGluay00JykuYXR0cignaHJlZicpKS50b0JlKCcnKTsKICAgICAgICAgICAgfSk7CiAgICAKICAgICAgICAgICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gbm8gaHJlZiBidXQgbmFtZSBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBlbGVtZW50KCcjbGluay01JykuY2xpY2soKTsKICAgICAgICAgICAgICBleHBlY3QoaW5wdXQoJ3ZhbHVlJykudmFsKCkpLnRvRXF1YWwoJzUnKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2xpbmstNScpLmF0dHIoJ2hyZWYnKSkudG9CZSh1bmRlZmluZWQpOwogICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgICBpdCgnc2hvdWxkIG9ubHkgY2hhbmdlIHVybCB3aGVuIG9ubHkgbmctaHJlZicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlucHV0KCd2YWx1ZScpLmVudGVyKCc2Jyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNsaW5rLTYnKS5hdHRyKCdocmVmJykpLnRvQmUoJzYnKTsKICAgIAogICAgICAgICAgICAgIGVsZW1lbnQoJyNsaW5rLTYnKS5jbGljaygpOwogICAgICAgICAgICAgIGV4cGVjdChicm93c2VyKCkubG9jYXRpb24oKS51cmwoKSkudG9FcXVhbCgnLzYnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTcmMKICAgICAqIEByZXN0cmljdCBBCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVc2luZyBBbmd1bGFyIG1hcmt1cCBsaWtlIGB7e2hhc2h9fWAgaW4gYSBgc3JjYCBhdHRyaWJ1dGUgZG9lc24ndAogICAgICogd29yayByaWdodDogVGhlIGJyb3dzZXIgd2lsbCBmZXRjaCBmcm9tIHRoZSBVUkwgd2l0aCB0aGUgbGl0ZXJhbAogICAgICogdGV4dCBge3toYXNofX1gIHVudGlsIEFuZ3VsYXIgcmVwbGFjZXMgdGhlIGV4cHJlc3Npb24gaW5zaWRlCiAgICAgKiBge3toYXNofX1gLiBUaGUgYG5nU3JjYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbS4KICAgICAqCiAgICAgKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogICAgICogPHByZT4KICAgICAqIDxpbWcgc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIFRoZSBjb3JyZWN0IHdheSB0byB3cml0ZSBpdDoKICAgICAqIDxwcmU+CiAgICAgKiA8aW1nIG5nLXNyYz0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTUcKICAgICAqIEBwYXJhbSB7dGVtcGxhdGV9IG5nU3JjIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nU3Jjc2V0CiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSBge3toYXNofX1gIGluIGEgYHNyY3NldGAgYXR0cmlidXRlIGRvZXNuJ3QKICAgICAqIHdvcmsgcmlnaHQ6IFRoZSBicm93c2VyIHdpbGwgZmV0Y2ggZnJvbSB0aGUgVVJMIHdpdGggdGhlIGxpdGVyYWwKICAgICAqIHRleHQgYHt7aGFzaH19YCB1bnRpbCBBbmd1bGFyIHJlcGxhY2VzIHRoZSBleHByZXNzaW9uIGluc2lkZQogICAgICogYHt7aGFzaH19YC4gVGhlIGBuZ1NyY3NldGAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0uCiAgICAgKgogICAgICogVGhlIGJ1Z2d5IHdheSB0byB3cml0ZSBpdDoKICAgICAqIDxwcmU+CiAgICAgKiA8aW1nIHNyY3NldD0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19IDJ4Ii8+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBUaGUgY29ycmVjdCB3YXkgdG8gd3JpdGUgaXQ6CiAgICAgKiA8cHJlPgogICAgICogPGltZyBuZy1zcmNzZXQ9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSAyeCIvPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQGVsZW1lbnQgSU1HCiAgICAgKiBAcGFyYW0ge3RlbXBsYXRlfSBuZ1NyY3NldCBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluIGB7e319YCBtYXJrdXAuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0Rpc2FibGVkCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIFRoZSBmb2xsb3dpbmcgbWFya3VwIHdpbGwgbWFrZSB0aGUgYnV0dG9uIGVuYWJsZWQgb24gQ2hyb21lL0ZpcmVmb3ggYnV0IG5vdCBvbiBJRTggYW5kIG9sZGVyIElFczoKICAgICAqIDxwcmU+CiAgICAgKiA8ZGl2IG5nLWluaXQ9InNjb3BlID0geyBpc0Rpc2FibGVkOiBmYWxzZSB9Ij4KICAgICAqICA8YnV0dG9uIGRpc2FibGVkPSJ7e3Njb3BlLmlzRGlzYWJsZWR9fSI+RGlzYWJsZWQ8L2J1dHRvbj4KICAgICAqIDwvZGl2PgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIGRpc2FibGVkLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIHRoZSBgbmdEaXNhYmxlZGAgZGlyZWN0aXZlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgIENsaWNrIG1lIHRvIHRvZ2dsZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICAgICAgICAgPGJ1dHRvbiBuZy1tb2RlbD0iYnV0dG9uIiBuZy1kaXNhYmxlZD0iY2hlY2tlZCI+QnV0dG9uPC9idXR0b24+CiAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICBpdCgnc2hvdWxkIHRvZ2dsZSBidXR0b24nLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLnByb3AoJ2Rpc2FibGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOmJ1dHRvbicpLnByb3AoJ2Rpc2FibGVkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IElOUFVUCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nRGlzYWJsZWQgQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDaGVja2VkCiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIGNoZWNrZWQuCiAgICAgKiAoVGhlIHByZXNlbmNlIG9mIHRoZW0gbWVhbnMgdHJ1ZSBhbmQgYWJzZW5jZSBtZWFucyBmYWxzZSkKICAgICAqIFRoaXMgcHJldmVudHMgdGhlIGFuZ3VsYXIgY29tcGlsZXIgZnJvbSBjb3JyZWN0bHkgcmV0cmlldmluZyB0aGUgYmluZGluZyBleHByZXNzaW9uLgogICAgICogVG8gc29sdmUgdGhpcyBwcm9ibGVtLCB3ZSBpbnRyb2R1Y2UgdGhlIGBuZ0NoZWNrZWRgIGRpcmVjdGl2ZS4KICAgICAqIEBleGFtcGxlCiAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgIENoZWNrIG1lIHRvIGNoZWNrIGJvdGg6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9Im1hc3RlciI+PGJyLz4KICAgICAgICAgICAgPGlucHV0IGlkPSJjaGVja1NsYXZlIiB0eXBlPSJjaGVja2JveCIgbmctY2hlY2tlZD0ibWFzdGVyIj4KICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgIGl0KCdzaG91bGQgY2hlY2sgYm90aCBjaGVja0JveGVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNjaGVja1NsYXZlJykucHJvcCgnY2hlY2tlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgICAgICBpbnB1dCgnbWFzdGVyJykuY2hlY2soKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2NoZWNrU2xhdmUnKS5wcm9wKCdjaGVja2VkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICoKICAgICAqIEBlbGVtZW50IElOUFVUCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2hlY2tlZCBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1JlYWRvbmx5CiAgICAgKiBAcmVzdHJpY3QgQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIEhUTUwgc3BlY3MgZG8gbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHNwZWNpYWwgYXR0cmlidXRlcyBzdWNoIGFzIHJlYWRvbmx5LgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIHRoZSBgbmdSZWFkb25seWAgZGlyZWN0aXZlLgogICAgICogQGV4YW1wbGUKICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICAgQ2hlY2sgbWUgdG8gbWFrZSB0ZXh0IHJlYWRvbmx5OiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctcmVhZG9ubHk9ImNoZWNrZWQiIHZhbHVlPSJJJ20gQW5ndWxhciIvPgogICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICAgaXQoJ3Nob3VsZCB0b2dnbGUgcmVhZG9ubHkgYXR0cicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6dGV4dCcpLnByb3AoJ3JlYWRvbmx5JykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgOnRleHQnKS5wcm9wKCdyZWFkb25seScpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBJTlBVVAogICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gQW5ndWxhciBleHByZXNzaW9uIHRoYXQgd2lsbCBiZSBldmFsdWF0ZWQuCiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdTZWxlY3RlZAogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBzZWxlY3RlZC4KICAgICAqIChUaGUgcHJlc2VuY2Ugb2YgdGhlbSBtZWFucyB0cnVlIGFuZCBhYnNlbmNlIG1lYW5zIGZhbHNlKQogICAgICogVGhpcyBwcmV2ZW50cyB0aGUgYW5ndWxhciBjb21waWxlciBmcm9tIGNvcnJlY3RseSByZXRyaWV2aW5nIHRoZSBiaW5kaW5nIGV4cHJlc3Npb24uCiAgICAgKiBUbyBzb2x2ZSB0aGlzIHByb2JsZW0sIHdlIGludHJvZHVjZWQgdGhlIGBuZ1NlbGVjdGVkYCBkaXJlY3RpdmUuCiAgICAgKiBAZXhhbXBsZQogICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICBDaGVjayBtZSB0byBzZWxlY3Q6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InNlbGVjdGVkIj48YnIvPgogICAgICAgICAgICA8c2VsZWN0PgogICAgICAgICAgICAgIDxvcHRpb24+SGVsbG8hPC9vcHRpb24+CiAgICAgICAgICAgICAgPG9wdGlvbiBpZD0iZ3JlZXQiIG5nLXNlbGVjdGVkPSJzZWxlY3RlZCI+R3JlZXRpbmdzITwvb3B0aW9uPgogICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgIGl0KCdzaG91bGQgc2VsZWN0IEdyZWV0aW5ncyEnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2dyZWV0JykucHJvcCgnc2VsZWN0ZWQnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICAgICAgaW5wdXQoJ3NlbGVjdGVkJykuY2hlY2soKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI2dyZWV0JykucHJvcCgnc2VsZWN0ZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKgogICAgICogQGVsZW1lbnQgT1BUSU9OCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nT3BlbgogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBIVE1MIHNwZWNzIGRvIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSBzcGVjaWFsIGF0dHJpYnV0ZXMgc3VjaCBhcyBvcGVuLgogICAgICogKFRoZSBwcmVzZW5jZSBvZiB0aGVtIG1lYW5zIHRydWUgYW5kIGFic2VuY2UgbWVhbnMgZmFsc2UpCiAgICAgKiBUaGlzIHByZXZlbnRzIHRoZSBhbmd1bGFyIGNvbXBpbGVyIGZyb20gY29ycmVjdGx5IHJldHJpZXZpbmcgdGhlIGJpbmRpbmcgZXhwcmVzc2lvbi4KICAgICAqIFRvIHNvbHZlIHRoaXMgcHJvYmxlbSwgd2UgaW50cm9kdWNlIHRoZSBgbmdPcGVuYCBkaXJlY3RpdmUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICAgQ2hlY2sgbWUgY2hlY2sgbXVsdGlwbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9Im9wZW4iPjxici8+CiAgICAgICAgICAgICA8ZGV0YWlscyBpZD0iZGV0YWlscyIgbmctb3Blbj0ib3BlbiI+CiAgICAgICAgICAgICAgICA8c3VtbWFyeT5TaG93L0hpZGUgbWU8L3N1bW1hcnk+CiAgICAgICAgICAgICA8L2RldGFpbHM+CiAgICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgICBpdCgnc2hvdWxkIHRvZ2dsZSBvcGVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjZGV0YWlscycpLnByb3AoJ29wZW4nKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICAgICAgIGlucHV0KCdvcGVuJykuY2hlY2soKTsKICAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNkZXRhaWxzJykucHJvcCgnb3BlbicpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgICAgICB9KTsKICAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqCiAgICAgKiBAZWxlbWVudCBERVRBSUxTCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBBbmd1bGFyIGV4cHJlc3Npb24gdGhhdCB3aWxsIGJlIGV2YWx1YXRlZC4KICAgICAqLwoKICAgIHZhciBuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcyA9IHt9OwoKCiAgICAvLyBib29sZWFuIGF0dHJzIGFyZSBldmFsdWF0ZWQKICAgIGZvckVhY2goQk9PTEVBTl9BVFRSLCBmdW5jdGlvbiAocHJvcE5hbWUsIGF0dHJOYW1lKSB7CiAgICAgICAgLy8gYmluZGluZyB0byBtdWx0aXBsZSBpcyBub3Qgc3VwcG9ydGVkCiAgICAgICAgaWYgKHByb3BOYW1lID09ICJtdWx0aXBsZSIpIHJldHVybjsKCiAgICAgICAgdmFyIG5vcm1hbGl6ZWQgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBhdHRyTmFtZSk7CiAgICAgICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJbbm9ybWFsaXplZF0sIGZ1bmN0aW9uIG5nQm9vbGVhbkF0dHJXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KGF0dHJOYW1lLCAhIXZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9OwogICAgfSk7CgoKICAgIC8vIG5nLXNyYywgbmctc3Jjc2V0LCBuZy1ocmVmIGFyZSBpbnRlcnBvbGF0ZWQKICAgIGZvckVhY2goWydzcmMnLCAnc3Jjc2V0JywgJ2hyZWYnXSwgZnVuY3Rpb24gKGF0dHJOYW1lKSB7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWQgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBhdHRyTmFtZSk7CiAgICAgICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBwcmlvcml0eTogOTksIC8vIGl0IG5lZWRzIHRvIHJ1biBhZnRlciB0aGUgYXR0cmlidXRlcyBhcmUgaW50ZXJwb2xhdGVkCiAgICAgICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyLiRvYnNlcnZlKG5vcm1hbGl6ZWQsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KGF0dHJOYW1lLCB2YWx1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBvbiBJRSwgaWYgIm5nOnNyYyIgZGlyZWN0aXZlIGRlY2xhcmF0aW9uIGlzIHVzZWQgYW5kICJzcmMiIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZW4gY2FsbGluZyBlbGVtZW50LnNldEF0dHJpYnV0ZSgnc3JjJywgJ2ZvbycpIGRvZXNuJ3QgZG8gYW55dGhpbmcsIHNvIHdlIG5lZWQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG8gc2V0IHRoZSBwcm9wZXJ0eSBhcyB3ZWxsIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgZWZmZWN0LgogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSB1c2UgYXR0clthdHRyTmFtZV0gdmFsdWUgc2luY2UgJHNldCBjYW4gc2FuaXRpemUgdGhlIHVybC4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1zaWUpIGVsZW1lbnQucHJvcChhdHRyTmFtZSwgYXR0clthdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9KTsKCiAgICB2YXIgbnVsbEZvcm1DdHJsID0gewogICAgICAgICRhZGRDb250cm9sOiBub29wLAogICAgICAgICRyZW1vdmVDb250cm9sOiBub29wLAogICAgICAgICRzZXRWYWxpZGl0eTogbm9vcCwKICAgICAgICAkc2V0RGlydHk6IG5vb3AsCiAgICAgICAgJHNldFByaXN0aW5lOiBub29wCiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRwcmlzdGluZSBUcnVlIGlmIHVzZXIgaGFzIG5vdCBpbnRlcmFjdGVkIHdpdGggdGhlIGZvcm0geWV0LgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkZGlydHkgVHJ1ZSBpZiB1c2VyIGhhcyBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aCB0aGUgZm9ybS4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHZhbGlkIFRydWUgaWYgYWxsIG9mIHRoZSBjb250YWluaW5nIGZvcm1zIGFuZCBjb250cm9scyBhcmUgdmFsaWQuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRpbnZhbGlkIFRydWUgaWYgYXQgbGVhc3Qgb25lIGNvbnRhaW5pbmcgY29udHJvbCBvciBmb3JtIGlzIGludmFsaWQuCiAgICAgKgogICAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBJcyBhbiBvYmplY3QgaGFzaCwgY29udGFpbmluZyByZWZlcmVuY2VzIHRvIGFsbCBpbnZhbGlkIGNvbnRyb2xzIG9yCiAgICAgKiAgZm9ybXMsIHdoZXJlOgogICAgICoKICAgICAqICAtIGtleXMgYXJlIHZhbGlkYXRpb24gdG9rZW5zIChlcnJvciBuYW1lcykg4oCUIHN1Y2ggYXMgYHJlcXVpcmVkYCwgYHVybGAgb3IgYGVtYWlsYCksCiAgICAgKiAgLSB2YWx1ZXMgYXJlIGFycmF5cyBvZiBjb250cm9scyBvciBmb3JtcyB0aGF0IGFyZSBpbnZhbGlkIHdpdGggZ2l2ZW4gZXJyb3IuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBgRm9ybUNvbnRyb2xsZXJgIGtlZXBzIHRyYWNrIG9mIGFsbCBpdHMgY29udHJvbHMgYW5kIG5lc3RlZCBmb3JtcyBhcyB3ZWxsIGFzIHN0YXRlIG9mIHRoZW0sCiAgICAgKiBzdWNoIGFzIGJlaW5nIHZhbGlkL2ludmFsaWQgb3IgZGlydHkvcHJpc3RpbmUuCiAgICAgKgogICAgICogRWFjaCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0gZGlyZWN0aXZlIGNyZWF0ZXMgYW4gaW5zdGFuY2UKICAgICAqIG9mIGBGb3JtQ29udHJvbGxlcmAuCiAgICAgKgogICAgICovCiAgICAvL2Fza3MgZm9yICRzY29wZSB0byBmb29sIHRoZSBCQyBjb250cm9sbGVyIG1vZHVsZQogICAgRm9ybUNvbnRyb2xsZXIuJGluamVjdCA9IFsnJGVsZW1lbnQnLCAnJGF0dHJzJywgJyRzY29wZSddOwogICAgZnVuY3Rpb24gRm9ybUNvbnRyb2xsZXIoZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICB2YXIgZm9ybSA9IHRoaXMsCiAgICAgICAgICAgIHBhcmVudEZvcm0gPSBlbGVtZW50LnBhcmVudCgpLmNvbnRyb2xsZXIoJ2Zvcm0nKSB8fCBudWxsRm9ybUN0cmwsCiAgICAgICAgICAgIGludmFsaWRDb3VudCA9IDAsIC8vIHVzZWQgdG8gZWFzaWx5IGRldGVybWluZSBpZiB3ZSBhcmUgdmFsaWQKICAgICAgICAgICAgZXJyb3JzID0gZm9ybS4kZXJyb3IgPSB7fSwKICAgICAgICAgICAgY29udHJvbHMgPSBbXTsKCiAgICAgICAgLy8gaW5pdCBzdGF0ZQogICAgICAgIGZvcm0uJG5hbWUgPSBhdHRycy5uYW1lIHx8IGF0dHJzLm5nRm9ybTsKICAgICAgICBmb3JtLiRkaXJ0eSA9IGZhbHNlOwogICAgICAgIGZvcm0uJHByaXN0aW5lID0gdHJ1ZTsKICAgICAgICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgICAgICAgZm9ybS4kaW52YWxpZCA9IGZhbHNlOwoKICAgICAgICBwYXJlbnRGb3JtLiRhZGRDb250cm9sKGZvcm0pOwoKICAgICAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhQUklTVElORV9DTEFTUyk7CiAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CgogICAgICAgIC8vIGNvbnZlbmllbmNlIG1ldGhvZCBmb3IgZWFzeSB0b2dnbGluZyBvZiBjbGFzc2VzCiAgICAgICAgZnVuY3Rpb24gdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KSB7CiAgICAgICAgICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAgICAgICAgIGVsZW1lbnQuCiAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MoKGlzVmFsaWQgPyBJTlZBTElEX0NMQVNTIDogVkFMSURfQ0xBU1MpICsgdmFsaWRhdGlvbkVycm9yS2V5KS4KICAgICAgICAgICAgICBhZGRDbGFzcygoaXNWYWxpZCA/IFZBTElEX0NMQVNTIDogSU5WQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIjJGFkZENvbnRyb2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJlZ2lzdGVyIGEgY29udHJvbCB3aXRoIHRoZSBmb3JtLgogICAgICAgICAqCiAgICAgICAgICogSW5wdXQgZWxlbWVudHMgdXNpbmcgbmdNb2RlbENvbnRyb2xsZXIgZG8gdGhpcyBhdXRvbWF0aWNhbGx5IHdoZW4gdGhleSBhcmUgbGlua2VkLgogICAgICAgICAqLwogICAgICAgIGZvcm0uJGFkZENvbnRyb2wgPSBmdW5jdGlvbiAoY29udHJvbCkgewogICAgICAgICAgICBjb250cm9scy5wdXNoKGNvbnRyb2wpOwoKICAgICAgICAgICAgaWYgKGNvbnRyb2wuJG5hbWUgJiYgIWZvcm0uaGFzT3duUHJvcGVydHkoY29udHJvbC4kbmFtZSkpIHsKICAgICAgICAgICAgICAgIGZvcm1bY29udHJvbC4kbmFtZV0gPSBjb250cm9sOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIjJHJlbW92ZUNvbnRyb2wKICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIERlcmVnaXN0ZXIgYSBjb250cm9sIGZyb20gdGhlIGZvcm0uCiAgICAgICAgICoKICAgICAgICAgKiBJbnB1dCBlbGVtZW50cyB1c2luZyBuZ01vZGVsQ29udHJvbGxlciBkbyB0aGlzIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGV5IGFyZSBkZXN0cm95ZWQuCiAgICAgICAgICovCiAgICAgICAgZm9ybS4kcmVtb3ZlQ29udHJvbCA9IGZ1bmN0aW9uIChjb250cm9sKSB7CiAgICAgICAgICAgIGlmIChjb250cm9sLiRuYW1lICYmIGZvcm1bY29udHJvbC4kbmFtZV0gPT09IGNvbnRyb2wpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBmb3JtW2NvbnRyb2wuJG5hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvckVhY2goZXJyb3JzLCBmdW5jdGlvbiAocXVldWUsIHZhbGlkYXRpb25Ub2tlbikgewogICAgICAgICAgICAgICAgZm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCB0cnVlLCBjb250cm9sKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBhcnJheVJlbW92ZShjb250cm9scywgY29udHJvbCk7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmZvcm0uRm9ybUNvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICAgICAgICogQG1ldGhvZE9mIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTZXRzIHRoZSB2YWxpZGl0eSBvZiBhIGZvcm0gY29udHJvbC4KICAgICAgICAgKgogICAgICAgICAqIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gcGFyZW50IGZvcm1zLgogICAgICAgICAqLwogICAgICAgIGZvcm0uJHNldFZhbGlkaXR5ID0gZnVuY3Rpb24gKHZhbGlkYXRpb25Ub2tlbiwgaXNWYWxpZCwgY29udHJvbCkgewogICAgICAgICAgICB2YXIgcXVldWUgPSBlcnJvcnNbdmFsaWRhdGlvblRva2VuXTsKCiAgICAgICAgICAgIGlmIChpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICBpZiAocXVldWUpIHsKICAgICAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShxdWV1ZSwgY29udHJvbCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFxdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW52YWxpZENvdW50LS07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaW52YWxpZENvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0uJHZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0uJGludmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnNbdmFsaWRhdGlvblRva2VuXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyh0cnVlLCB2YWxpZGF0aW9uVG9rZW4pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIHRydWUsIGZvcm0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWludmFsaWRDb3VudCkgewogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHF1ZXVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzKHF1ZXVlLCBjb250cm9sKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcnNbdmFsaWRhdGlvblRva2VuXSA9IHF1ZXVlID0gW107CiAgICAgICAgICAgICAgICAgICAgaW52YWxpZENvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoZmFsc2UsIHZhbGlkYXRpb25Ub2tlbik7CiAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCBmYWxzZSwgZm9ybSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBxdWV1ZS5wdXNoKGNvbnRyb2wpOwoKICAgICAgICAgICAgICAgIGZvcm0uJHZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgICAgICBmb3JtLiRpbnZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyIyRzZXREaXJ0eQogICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6Zm9ybS5Gb3JtQ29udHJvbGxlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2V0cyB0aGUgZm9ybSB0byBhIGRpcnR5IHN0YXRlLgogICAgICAgICAqCiAgICAgICAgICogVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB0byBhZGQgdGhlICduZy1kaXJ0eScgY2xhc3MgYW5kIHNldCB0aGUgZm9ybSB0byBhIGRpcnR5CiAgICAgICAgICogc3RhdGUgKG5nLWRpcnR5IGNsYXNzKS4gVGhpcyBtZXRob2Qgd2lsbCBhbHNvIHByb3BhZ2F0ZSB0byBwYXJlbnQgZm9ybXMuCiAgICAgICAgICovCiAgICAgICAgZm9ybS4kc2V0RGlydHkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpLmFkZENsYXNzKERJUlRZX0NMQVNTKTsKICAgICAgICAgICAgZm9ybS4kZGlydHkgPSB0cnVlOwogICAgICAgICAgICBmb3JtLiRwcmlzdGluZSA9IGZhbHNlOwogICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyIyRzZXRQcmlzdGluZQogICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6Zm9ybS5Gb3JtQ29udHJvbGxlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2V0cyB0aGUgZm9ybSB0byBpdHMgcHJpc3RpbmUgc3RhdGUuCiAgICAgICAgICoKICAgICAgICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIHJlbW92ZSB0aGUgJ25nLWRpcnR5JyBjbGFzcyBhbmQgc2V0IHRoZSBmb3JtIHRvIGl0cyBwcmlzdGluZQogICAgICAgICAqIHN0YXRlIChuZy1wcmlzdGluZSBjbGFzcykuIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gYWxsIHRoZSBjb250cm9scyBjb250YWluZWQKICAgICAgICAgKiBpbiB0aGlzIGZvcm0uCiAgICAgICAgICoKICAgICAgICAgKiBTZXR0aW5nIGEgZm9ybSBiYWNrIHRvIGEgcHJpc3RpbmUgc3RhdGUgaXMgb2Z0ZW4gdXNlZnVsIHdoZW4gd2Ugd2FudCB0byAncmV1c2UnIGEgZm9ybSBhZnRlcgogICAgICAgICAqIHNhdmluZyBvciByZXNldHRpbmcgaXQuCiAgICAgICAgICovCiAgICAgICAgZm9ybS4kc2V0UHJpc3RpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoRElSVFlfQ0xBU1MpLmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgICAgICAgICAgZm9ybS4kZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgZm9ybS4kcHJpc3RpbmUgPSB0cnVlOwogICAgICAgICAgICBmb3JFYWNoKGNvbnRyb2xzLCBmdW5jdGlvbiAoY29udHJvbCkgewogICAgICAgICAgICAgICAgY29udHJvbC4kc2V0UHJpc3RpbmUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdGb3JtCiAgICAgKiBAcmVzdHJpY3QgRUFDCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBOZXN0YWJsZSBhbGlhcyBvZiB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gYGZvcm1gfSBkaXJlY3RpdmUuIEhUTUwKICAgICAqIGRvZXMgbm90IGFsbG93IG5lc3Rpbmcgb2YgZm9ybSBlbGVtZW50cy4gSXQgaXMgdXNlZnVsIHRvIG5lc3QgZm9ybXMsIGZvciBleGFtcGxlIGlmIHRoZSB2YWxpZGl0eSBvZiBhCiAgICAgKiBzdWItZ3JvdXAgb2YgY29udHJvbHMgbmVlZHMgdG8gYmUgZGV0ZXJtaW5lZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWV8bmdGb3JtIE5hbWUgb2YgdGhlIGZvcm0uIElmIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciB3aWxsIGJlIHB1Ymxpc2hlZCBpbnRvCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRlZCBzY29wZSwgdW5kZXIgdGhpcyBuYW1lLgogICAgICoKICAgICAqLwoKICAgIC8qKgogICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpmb3JtCiAgICAqIEByZXN0cmljdCBFCiAgICAqCiAgICAqIEBkZXNjcmlwdGlvbgogICAgKiBEaXJlY3RpdmUgdGhhdCBpbnN0YW50aWF0ZXMKICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtLkZvcm1Db250cm9sbGVyIEZvcm1Db250cm9sbGVyfS4KICAgICoKICAgICogSWYgYG5hbWVgIGF0dHJpYnV0ZSBpcyBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgaXMgcHVibGlzaGVkIG9udG8gdGhlIGN1cnJlbnQgc2NvcGUgdW5kZXIKICAgICogdGhpcyBuYW1lLgogICAgKgogICAgKiAjIEFsaWFzOiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nRm9ybSBgbmdGb3JtYH0KICAgICoKICAgICogSW4gYW5ndWxhciBmb3JtcyBjYW4gYmUgbmVzdGVkLiBUaGlzIG1lYW5zIHRoYXQgdGhlIG91dGVyIGZvcm0gaXMgdmFsaWQgd2hlbiBhbGwgb2YgdGhlIGNoaWxkCiAgICAqIGZvcm1zIGFyZSB2YWxpZCBhcyB3ZWxsLiBIb3dldmVyIGJyb3dzZXJzIGRvIG5vdCBhbGxvdyBuZXN0aW5nIG9mIGA8Zm9ybT5gIGVsZW1lbnRzLCBmb3IgdGhpcwogICAgKiByZWFzb24gYW5ndWxhciBwcm92aWRlcyB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nRm9ybSBgbmdGb3JtYH0gYWxpYXMKICAgICogd2hpY2ggYmVoYXZlcyBpZGVudGljYWwgdG8gYDxmb3JtPmAgYnV0IGFsbG93cyBmb3JtIG5lc3RpbmcuCiAgICAqCiAgICAqCiAgICAqICMgQ1NTIGNsYXNzZXMKICAgICogIC0gYG5nLXZhbGlkYCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgdmFsaWQuCiAgICAqICAtIGBuZy1pbnZhbGlkYCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgaW52YWxpZC4KICAgICogIC0gYG5nLXByaXN0aW5lYCBJcyBzZXQgaWYgdGhlIGZvcm0gaXMgcHJpc3RpbmUuCiAgICAqICAtIGBuZy1kaXJ0eWAgSXMgc2V0IGlmIHRoZSBmb3JtIGlzIGRpcnR5LgogICAgKgogICAgKgogICAgKiAjIFN1Ym1pdHRpbmcgYSBmb3JtIGFuZCBwcmV2ZW50aW5nIGRlZmF1bHQgYWN0aW9uCiAgICAqCiAgICAqIFNpbmNlIHRoZSByb2xlIG9mIGZvcm1zIGluIGNsaWVudC1zaWRlIEFuZ3VsYXIgYXBwbGljYXRpb25zIGlzIGRpZmZlcmVudCB0aGFuIGluIGNsYXNzaWNhbAogICAgKiByb3VuZHRyaXAgYXBwcywgaXQgaXMgZGVzaXJhYmxlIGZvciB0aGUgYnJvd3NlciBub3QgdG8gdHJhbnNsYXRlIHRoZSBmb3JtIHN1Ym1pc3Npb24gaW50byBhIGZ1bGwKICAgICogcGFnZSByZWxvYWQgdGhhdCBzZW5kcyB0aGUgZGF0YSB0byB0aGUgc2VydmVyLiBJbnN0ZWFkIHNvbWUgamF2YXNjcmlwdCBsb2dpYyBzaG91bGQgYmUgdHJpZ2dlcmVkCiAgICAqIHRvIGhhbmRsZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGluIGFwcGxpY2F0aW9uIHNwZWNpZmljIHdheS4KICAgICoKICAgICogRm9yIHRoaXMgcmVhc29uLCBBbmd1bGFyIHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAoZm9ybSBzdWJtaXNzaW9uIHRvIHRoZSBzZXJ2ZXIpIHVubGVzcyB0aGUKICAgICogYDxmb3JtPmAgZWxlbWVudCBoYXMgYW4gYGFjdGlvbmAgYXR0cmlidXRlIHNwZWNpZmllZC4KICAgICoKICAgICogWW91IGNhbiB1c2Ugb25lIG9mIHRoZSBmb2xsb3dpbmcgdHdvIHdheXMgdG8gc3BlY2lmeSB3aGF0IGphdmFzY3JpcHQgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgd2hlbgogICAgKiBhIGZvcm0gaXMgc3VibWl0dGVkOgogICAgKgogICAgKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdTdWJtaXQgbmdTdWJtaXR9IGRpcmVjdGl2ZSBvbiB0aGUgZm9ybSBlbGVtZW50CiAgICAqIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9IGRpcmVjdGl2ZSBvbiB0aGUgZmlyc3QKICAgICAqICBidXR0b24gb3IgaW5wdXQgZmllbGQgb2YgdHlwZSBzdWJtaXQgKGlucHV0W3R5cGU9c3VibWl0XSkKICAgICoKICAgICogVG8gcHJldmVudCBkb3VibGUgZXhlY3V0aW9uIG9mIHRoZSBoYW5kbGVyLCB1c2Ugb25seSBvbmUgb2YgbmdTdWJtaXQgb3IgbmdDbGljayBkaXJlY3RpdmVzLiBUaGlzCiAgICAqIGlzIGJlY2F1c2Ugb2YgdGhlIGZvbGxvd2luZyBmb3JtIHN1Ym1pc3Npb24gcnVsZXMgY29taW5nIGZyb20gdGhlIGh0bWwgc3BlYzoKICAgICoKICAgICogLSBJZiBhIGZvcm0gaGFzIG9ubHkgb25lIGlucHV0IGZpZWxkIHRoZW4gaGl0dGluZyBlbnRlciBpbiB0aGlzIGZpZWxkIHRyaWdnZXJzIGZvcm0gc3VibWl0CiAgICAqIChgbmdTdWJtaXRgKQogICAgKiAtIGlmIGEgZm9ybSBoYXMgaGFzIDIrIGlucHV0IGZpZWxkcyBhbmQgbm8gYnV0dG9ucyBvciBpbnB1dFt0eXBlPXN1Ym1pdF0gdGhlbiBoaXR0aW5nIGVudGVyCiAgICAqIGRvZXNuJ3QgdHJpZ2dlciBzdWJtaXQKICAgICogLSBpZiBhIGZvcm0gaGFzIG9uZSBvciBtb3JlIGlucHV0IGZpZWxkcyBhbmQgb25lIG9yIG1vcmUgYnV0dG9ucyBvciBpbnB1dFt0eXBlPXN1Ym1pdF0gdGhlbgogICAgKiBoaXR0aW5nIGVudGVyIGluIGFueSBvZiB0aGUgaW5wdXQgZmllbGRzIHdpbGwgdHJpZ2dlciB0aGUgY2xpY2sgaGFuZGxlciBvbiB0aGUgKmZpcnN0KiBidXR0b24gb3IKICAgICogaW5wdXRbdHlwZT1zdWJtaXRdIChgbmdDbGlja2ApICphbmQqIGEgc3VibWl0IGhhbmRsZXIgb24gdGhlIGVuY2xvc2luZyBmb3JtIChgbmdTdWJtaXRgKQogICAgKgogICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgTmFtZSBvZiB0aGUgZm9ybS4gSWYgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIHdpbGwgYmUgcHVibGlzaGVkIGludG8KICAgICogICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgc2NvcGUsIHVuZGVyIHRoaXMgbmFtZS4KICAgICoKICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgICRzY29wZS51c2VyVHlwZSA9ICdndWVzdCc7CiAgICAgICAgICAgIH0KICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgdXNlclR5cGU6IDxpbnB1dCBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InVzZXJUeXBlIiByZXF1aXJlZD4KICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj5SZXF1aXJlZCE8L3NwYW4+PGJyPgogICAgICAgICAgICA8dHQ+dXNlclR5cGUgPSB7e3VzZXJUeXBlfX08L3R0Pjxicj4KICAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyPgogICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnI+CiAgICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyVHlwZScpKS50b0VxdWFsKCdndWVzdCcpOwogICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICAgfSk7CiAgIAogICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dCgndXNlclR5cGUnKS5lbnRlcignJyk7CiAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyVHlwZScpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICA8L2RvYzpleGFtcGxlPgogICAgKi8KICAgIHZhciBmb3JtRGlyZWN0aXZlRmFjdG9yeSA9IGZ1bmN0aW9uIChpc05nRm9ybSkgewogICAgICAgIHJldHVybiBbJyR0aW1lb3V0JywgZnVuY3Rpb24gKCR0aW1lb3V0KSB7CiAgICAgICAgICAgIHZhciBmb3JtRGlyZWN0aXZlID0gewogICAgICAgICAgICAgICAgbmFtZTogJ2Zvcm0nLAogICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6IEZvcm1Db250cm9sbGVyLAogICAgICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZTogZnVuY3Rpb24gKHNjb3BlLCBmb3JtRWxlbWVudCwgYXR0ciwgY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhdHRyLmFjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGNhbid0IHVzZSBqcSBldmVudHMgYmVjYXVzZSBpZiBhIGZvcm0gaXMgZGVzdHJveWVkIGR1cmluZyBzdWJtaXNzaW9uIHRoZSBkZWZhdWx0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWN0aW9uIGlzIG5vdCBwcmV2ZW50ZWQuIHNlZSAjMTIzOAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSUUgOSBpcyBub3QgYWZmZWN0ZWQgYmVjYXVzZSBpdCBkb2Vzbid0IGZpcmUgYSBzdWJtaXQgZXZlbnQgYW5kIHRyeSB0byBkbyBhIGZ1bGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwYWdlIHJlbG9hZCBpZiB0aGUgZm9ybSB3YXMgZGVzdHJveWVkIGJ5IHN1Ym1pc3Npb24gb2YgdGhlIGZvcm0gdmlhIGEgY2xpY2sgaGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9uIGEgYnV0dG9uIGluIHRoZSBmb3JtLiBMb29rcyBsaWtlIGFuIElFOSBzcGVjaWZpYyBidWcuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZlbnREZWZhdWx0TGlzdGVuZXIgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGV2ZW50LnByZXZlbnREZWZhdWx0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7IC8vIElFCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKGZvcm1FbGVtZW50WzBdLCAnc3VibWl0JywgcHJldmVudERlZmF1bHRMaXN0ZW5lcik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVucmVnaXN0ZXIgdGhlIHByZXZlbnREZWZhdWx0IGxpc3RlbmVyIHNvIHRoYXQgd2UgZG9uJ3Qgbm90IGxlYWsgbWVtb3J5IGJ1dCBpbiBhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2F5IHRoYXQgd2lsbCBhY2hpZXZlIHRoZSBwcmV2ZW50aW9uIG9mIHRoZSBkZWZhdWx0IGFjdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtRWxlbWVudC5vbignJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihmb3JtRWxlbWVudFswXSwgJ3N1Ym1pdCcsIHByZXZlbnREZWZhdWx0TGlzdGVuZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAwLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEZvcm1DdHJsID0gZm9ybUVsZW1lbnQucGFyZW50KCkuY29udHJvbGxlcignZm9ybScpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsaWFzID0gYXR0ci5uYW1lIHx8IGF0dHIubmdGb3JtOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhbGlhcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldHRlcihzY29wZSwgYWxpYXMsIGNvbnRyb2xsZXIsIGFsaWFzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRGb3JtQ3RybCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1FbGVtZW50Lm9uKCckZGVzdHJveScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybUN0cmwuJHJlbW92ZUNvbnRyb2woY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhbGlhcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGVyKHNjb3BlLCBhbGlhcywgdW5kZWZpbmVkLCBhbGlhcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0ZW5kKGNvbnRyb2xsZXIsIG51bGxGb3JtQ3RybCk7IC8vc3RvcCBwcm9wYWdhdGluZyBjaGlsZCBkZXN0cnVjdGlvbiBoYW5kbGVycyB1cHdhcmRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIGlzTmdGb3JtID8gZXh0ZW5kKGNvcHkoZm9ybURpcmVjdGl2ZSksIHsgcmVzdHJpY3Q6ICdFQUMnIH0pIDogZm9ybURpcmVjdGl2ZTsKICAgICAgICB9XTsKICAgIH07CgogICAgdmFyIGZvcm1EaXJlY3RpdmUgPSBmb3JtRGlyZWN0aXZlRmFjdG9yeSgpOwogICAgdmFyIG5nRm9ybURpcmVjdGl2ZSA9IGZvcm1EaXJlY3RpdmVGYWN0b3J5KHRydWUpOwoKICAgIHZhciBVUkxfUkVHRVhQID0gL14oZnRwfGh0dHB8aHR0cHMpOlwvXC8oXHcrOnswLDF9XHcqQCk/KFxTKykoOlswLTldKyk/KFwvfFwvKFtcdyMhOi4/Kz0mJUAhXC1cL10pKT8kLzsKICAgIHZhciBFTUFJTF9SRUdFWFAgPSAvXltBLVphLXowLTkuXyUrLV0rQFtBLVphLXowLTkuLV0rXC5bQS1aYS16XXsyLDZ9JC87CiAgICB2YXIgTlVNQkVSX1JFR0VYUCA9IC9eXHMqKFwtfFwrKT8oXGQrfChcZCooXC5cZCopKSlccyokLzsKCiAgICB2YXIgaW5wdXRUeXBlID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LnRleHQKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFN0YW5kYXJkIEhUTUwgdGV4dCBpbnB1dCB3aXRoIGFuZ3VsYXIgZGF0YSBiaW5kaW5nLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtuZ1RyaW09dHJ1ZV0gSWYgc2V0IHRvIGZhbHNlIEFuZ3VsYXIgd2lsbCBub3QgYXV0b21hdGljYWxseSB0cmltbWluZyB0aGUKICAgICAgICAgKiAgICBpbnB1dC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnZ3Vlc3QnOwogICAgICAgICAgICAgICAgICAgJHNjb3BlLndvcmQgPSAvXlxzKlx3KlxzKiQvOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgICAgICAgU2luZ2xlIHdvcmQ6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZy1wYXR0ZXJuPSJ3b3JkIiByZXF1aXJlZCBuZy10cmltPSJmYWxzZSI+CiAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucGF0dGVybiI+CiAgICAgICAgICAgICAgICAgICBTaW5nbGUgd29yZCBvbmx5ITwvc3Bhbj4KICAgICAgCiAgICAgICAgICAgICAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgICAgICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnZ3Vlc3QnKTsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgIAogICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJycpOwogICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAKICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBtdWx0aSB3b3JkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ2hlbGxvIHdvcmxkJyk7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgCiAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIG5vdCBiZSB0cmltbWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ3VudHJpbW1lZCAnKTsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgndW50cmltbWVkICcpOwogICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAndGV4dCc6IHRleHRJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0Lm51bWJlcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGV4dCBpbnB1dCB3aXRoIG51bWJlciB2YWxpZGF0aW9uIGFuZCB0cmFuc2Zvcm1hdGlvbi4gU2V0cyB0aGUgYG51bWJlcmAgdmFsaWRhdGlvbgogICAgICAgICAqIGVycm9yIGlmIG5vdCBhIHZhbGlkIG51bWJlci4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBtaW4gU2V0cyB0aGUgYG1pbmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGVudGVyZWQgaXMgbGVzcyB0aGFuIGBtaW5gLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWF4IFNldHMgdGhlIGBtYXhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGdyZWF0ZXIgdGhhbiBgbWF4YC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAkc2NvcGUudmFsdWUgPSAxMjsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgICAgICAgIE51bWJlcjogPGlucHV0IHR5cGU9Im51bWJlciIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ2YWx1ZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW49IjAiIG1heD0iOTkiIHJlcXVpcmVkPgogICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLm51bWJlciI+CiAgICAgICAgICAgICAgICAgICBOb3QgdmFsaWQgbnVtYmVyITwvc3Bhbj4KICAgICAgICAgICAgICAgICA8dHQ+dmFsdWUgPSB7e3ZhbHVlfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICAgICAgICAgPC9mb3JtPgogICAgICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3ZhbHVlJykpLnRvRXF1YWwoJzEyJyk7CiAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgIAogICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgaW5wdXQoJ3ZhbHVlJykuZW50ZXIoJycpOwogICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgIAogICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG92ZXIgbWF4JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgaW5wdXQoJ3ZhbHVlJykuZW50ZXIoJzEyMycpOwogICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZScpKS50b0VxdWFsKCcnKTsKICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ251bWJlcic6IG51bWJlcklucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQudXJsCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUZXh0IGlucHV0IHdpdGggVVJMIHZhbGlkYXRpb24uIFNldHMgdGhlIGB1cmxgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSBjb250ZW50IGlzIG5vdCBhCiAgICAgICAgICogdmFsaWQgVVJMLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgICAgICogICAgbWF4bGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdodHRwOi8vZ29vZ2xlLmNvbSc7CiAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgICAgICBVUkw6IDxpbnB1dCB0eXBlPSJ1cmwiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idGV4dCIgcmVxdWlyZWQ+CiAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IudXJsIj4KICAgICAgICAgICAgICAgICAgIE5vdCB2YWxpZCB1cmwhPC9zcGFuPgogICAgICAgICAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgICAgICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnVybCA9IHt7ISFteUZvcm0uJGVycm9yLnVybH19PC90dD48YnIvPgogICAgICAgICAgICAgICAgPC9mb3JtPgogICAgICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0JykpLnRvRXF1YWwoJ2h0dHA6Ly9nb29nbGUuY29tJyk7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAKICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgCiAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbm90IHVybCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCd4eHgnKTsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICAgICAqLwogICAgICAgICd1cmwnOiB1cmxJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LmVtYWlsCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUZXh0IGlucHV0IHdpdGggZW1haWwgdmFsaWRhdGlvbi4gU2V0cyB0aGUgYGVtYWlsYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiBub3QgYSB2YWxpZCBlbWFpbAogICAgICAgICAqIGFkZHJlc3MuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgICAgICogICAgbWlubGVuZ3RoLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ21lQGV4YW1wbGUuY29tJzsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgICAgICAgICBFbWFpbDogPGlucHV0IHR5cGU9ImVtYWlsIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiIHJlcXVpcmVkPgogICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgICAgICAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLmVtYWlsIj4KICAgICAgICAgICAgICAgICAgICAgTm90IHZhbGlkIGVtYWlsITwvc3Bhbj4KICAgICAgICAgICAgICAgICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgICAgICAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgICA8dHQ+bXlGb3JtLiRlcnJvci5lbWFpbCA9IHt7ISFteUZvcm0uJGVycm9yLmVtYWlsfX08L3R0Pjxici8+CiAgICAgICAgICAgICAgICAgPC9mb3JtPgogICAgICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd0ZXh0JykpLnRvRXF1YWwoJ21lQGV4YW1wbGUuY29tJyk7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAKICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpbnB1dCgndGV4dCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3RleHQnKSkudG9FcXVhbCgnJyk7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgCiAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbm90IGVtYWlsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ3h4eCcpOwogICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgJ2VtYWlsJzogZW1haWxJbnB1dFR5cGUsCgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgaW5wdXRUeXBlCiAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0LnJhZGlvCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBIVE1MIHJhZGlvIGJ1dHRvbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgICAgICAgJHNjb3BlLmNvbG9yID0gJ2JsdWUnOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJyZWQiPiAgUmVkIDxici8+CiAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJncmVlbiI+IEdyZWVuIDxici8+CiAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJibHVlIj4gQmx1ZSA8YnIvPgogICAgICAgICAgICAgICAgIDx0dD5jb2xvciA9IHt7Y29sb3J9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgIDwvZm9ybT4KICAgICAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHN0YXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdjb2xvcicpKS50b0VxdWFsKCdibHVlJyk7CiAgICAgIAogICAgICAgICAgICAgICAgICBpbnB1dCgnY29sb3InKS5zZWxlY3QoJ3JlZCcpOwogICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnY29sb3InKSkudG9FcXVhbCgncmVkJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICAgKi8KICAgICAgICAncmFkaW8nOiByYWRpb0lucHV0VHlwZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBpbnB1dFR5cGUKICAgICAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6aW5wdXQuY2hlY2tib3gKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEhUTUwgY2hlY2tib3guCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdUcnVlVmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nRmFsc2VWYWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIG5vdCBzZWxlY3RlZC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAkc2NvcGUudmFsdWUxID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICRzY29wZS52YWx1ZTIgPSAnWUVTJwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgICAgICAgVmFsdWUxOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJ2YWx1ZTEiPiA8YnIvPgogICAgICAgICAgICAgICAgIFZhbHVlMjogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0idmFsdWUyIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5nLXRydWUtdmFsdWU9IllFUyIgbmctZmFsc2UtdmFsdWU9Ik5PIj4gPGJyLz4KICAgICAgICAgICAgICAgICA8dHQ+dmFsdWUxID0ge3t2YWx1ZTF9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgICA8dHQ+dmFsdWUyID0ge3t2YWx1ZTJ9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgICAgIDwvZm9ybT4KICAgICAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHN0YXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZTEnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUyJykpLnRvRXF1YWwoJ1lFUycpOwogICAgICAKICAgICAgICAgICAgICAgICAgaW5wdXQoJ3ZhbHVlMScpLmNoZWNrKCk7CiAgICAgICAgICAgICAgICAgIGlucHV0KCd2YWx1ZTInKS5jaGVjaygpOwogICAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndmFsdWUxJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd2YWx1ZTInKSkudG9FcXVhbCgnTk8nKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICAgICAqLwogICAgICAgICdjaGVja2JveCc6IGNoZWNrYm94SW5wdXRUeXBlLAoKICAgICAgICAnaGlkZGVuJzogbm9vcCwKICAgICAgICAnYnV0dG9uJzogbm9vcCwKICAgICAgICAnc3VibWl0Jzogbm9vcCwKICAgICAgICAncmVzZXQnOiBub29wCiAgICB9OwoKCiAgICBmdW5jdGlvbiBpc0VtcHR5KHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGlzVW5kZWZpbmVkKHZhbHVlKSB8fCB2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgIT09IHZhbHVlOwogICAgfQoKCiAgICBmdW5jdGlvbiB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKCiAgICAgICAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBlbGVtZW50LnZhbCgpOwoKICAgICAgICAgICAgLy8gQnkgZGVmYXVsdCB3ZSB3aWxsIHRyaW0gdGhlIHZhbHVlCiAgICAgICAgICAgIC8vIElmIHRoZSBhdHRyaWJ1dGUgbmctdHJpbSBleGlzdHMgd2Ugd2lsbCBhdm9pZCB0cmltbWluZwogICAgICAgICAgICAvLyBlLmcuIDxpbnB1dCBuZy1tb2RlbD0iZm9vIiBuZy10cmltPSJmYWxzZSI+CiAgICAgICAgICAgIGlmICh0b0Jvb2xlYW4oYXR0ci5uZ1RyaW0gfHwgJ1QnKSkgewogICAgICAgICAgICAgICAgdmFsdWUgPSB0cmltKHZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGN0cmwuJHZpZXdWYWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gaWYgdGhlIGJyb3dzZXIgZG9lcyBzdXBwb3J0ICJpbnB1dCIgZXZlbnQsIHdlIGFyZSBmaW5lIC0gZXhjZXB0IG9uIElFOSB3aGljaCBkb2Vzbid0IGZpcmUgdGhlCiAgICAgICAgLy8gaW5wdXQgZXZlbnQgb24gYmFja3NwYWNlLCBkZWxldGUgb3IgY3V0CiAgICAgICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdpbnB1dCcpKSB7CiAgICAgICAgICAgIGVsZW1lbnQub24oJ2lucHV0JywgbGlzdGVuZXIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB0aW1lb3V0OwoKICAgICAgICAgICAgdmFyIGRlZmVyTGlzdGVuZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcigpOwogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGVsZW1lbnQub24oJ2tleWRvd24nLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBldmVudC5rZXlDb2RlOwoKICAgICAgICAgICAgICAgIC8vIGlnbm9yZQogICAgICAgICAgICAgICAgLy8gICAgY29tbWFuZCAgICAgICAgICAgIG1vZGlmaWVycyAgICAgICAgICAgICAgICAgICBhcnJvd3MKICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IDkxIHx8ICgxNSA8IGtleSAmJiBrZXkgPCAxOSkgfHwgKDM3IDw9IGtleSAmJiBrZXkgPD0gNDApKSByZXR1cm47CgogICAgICAgICAgICAgICAgZGVmZXJMaXN0ZW5lcigpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIGlmIHVzZXIgcGFzdGUgaW50byBpbnB1dCB1c2luZyBtb3VzZSwgd2UgbmVlZCAiY2hhbmdlIiBldmVudCB0byBjYXRjaCBpdAogICAgICAgICAgICBlbGVtZW50Lm9uKCdjaGFuZ2UnLCBsaXN0ZW5lcik7CgogICAgICAgICAgICAvLyBpZiB1c2VyIG1vZGlmaWVzIGlucHV0IHZhbHVlIHVzaW5nIGNvbnRleHQgbWVudSBpbiBJRSwgd2UgbmVlZCAicGFzdGUiIGFuZCAiY3V0IiBldmVudHMgdG8gY2F0Y2ggaXQKICAgICAgICAgICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdwYXN0ZScpKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50Lm9uKCdwYXN0ZSBjdXQnLCBkZWZlckxpc3RlbmVyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZWxlbWVudC52YWwoaXNFbXB0eShjdHJsLiR2aWV3VmFsdWUpID8gJycgOiBjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgIH07CgogICAgICAgIC8vIHBhdHRlcm4gdmFsaWRhdG9yCiAgICAgICAgdmFyIHBhdHRlcm4gPSBhdHRyLm5nUGF0dGVybiwKICAgICAgICAgICAgcGF0dGVyblZhbGlkYXRvciwKICAgICAgICAgICAgbWF0Y2g7CgogICAgICAgIHZhciB2YWxpZGF0ZSA9IGZ1bmN0aW9uIChyZWdleHAsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSB8fCByZWdleHAudGVzdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdwYXR0ZXJuJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgncGF0dGVybicsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBpZiAocGF0dGVybikgewogICAgICAgICAgICBtYXRjaCA9IHBhdHRlcm4ubWF0Y2goL15cLyguKilcLyhbZ2ltXSopJC8pOwogICAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgICAgIHBhdHRlcm4gPSBuZXcgUmVnRXhwKG1hdGNoWzFdLCBtYXRjaFsyXSk7CiAgICAgICAgICAgICAgICBwYXR0ZXJuVmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRlKHBhdHRlcm4sIHZhbHVlKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhdHRlcm5WYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcGF0dGVybk9iaiA9IHNjb3BlLiRldmFsKHBhdHRlcm4pOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXBhdHRlcm5PYmogfHwgIXBhdHRlcm5PYmoudGVzdCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBtaW5FcnIoJ25nUGF0dGVybicpKCdub3JlZ2V4cCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgJ0V4cGVjdGVkIHswfSB0byBiZSBhIFJlZ0V4cCBidXQgd2FzIHsxfS4gRWxlbWVudDogezJ9JywgcGF0dGVybiwKICAgICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuT2JqLCBzdGFydGluZ1RhZyhlbGVtZW50KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWxpZGF0ZShwYXR0ZXJuT2JqLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gocGF0dGVyblZhbGlkYXRvcik7CiAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChwYXR0ZXJuVmFsaWRhdG9yKTsKICAgICAgICB9CgogICAgICAgIC8vIG1pbiBsZW5ndGggdmFsaWRhdG9yCiAgICAgICAgaWYgKGF0dHIubmdNaW5sZW5ndGgpIHsKICAgICAgICAgICAgdmFyIG1pbmxlbmd0aCA9IGludChhdHRyLm5nTWlubGVuZ3RoKTsKICAgICAgICAgICAgdmFyIG1pbkxlbmd0aFZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc0VtcHR5KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPCBtaW5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWlubGVuZ3RoJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtaW5sZW5ndGgnLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWluTGVuZ3RoVmFsaWRhdG9yKTsKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1pbkxlbmd0aFZhbGlkYXRvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBtYXggbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIGlmIChhdHRyLm5nTWF4bGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBtYXhsZW5ndGggPSBpbnQoYXR0ci5uZ01heGxlbmd0aCk7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGhWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICghaXNFbXB0eSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoID4gbWF4bGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21heGxlbmd0aCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWF4bGVuZ3RoJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKG1heExlbmd0aFZhbGlkYXRvcik7CiAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtYXhMZW5ndGhWYWxpZGF0b3IpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBudW1iZXJJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogICAgICAgIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgdmFyIGVtcHR5ID0gaXNFbXB0eSh2YWx1ZSk7CiAgICAgICAgICAgIGlmIChlbXB0eSB8fCBOVU1CRVJfUkVHRVhQLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbnVtYmVyJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09ICcnID8gbnVsbCA6IChlbXB0eSA/IHZhbHVlIDogcGFyc2VGbG9hdCh2YWx1ZSkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gaXNFbXB0eSh2YWx1ZSkgPyAnJyA6ICcnICsgdmFsdWU7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChhdHRyLm1pbikgewogICAgICAgICAgICB2YXIgbWluID0gcGFyc2VGbG9hdChhdHRyLm1pbik7CiAgICAgICAgICAgIHZhciBtaW5WYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICghaXNFbXB0eSh2YWx1ZSkgJiYgdmFsdWUgPCBtaW4pIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWluJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdtaW4nLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWluVmFsaWRhdG9yKTsKICAgICAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1pblZhbGlkYXRvcik7CiAgICAgICAgfQoKICAgICAgICBpZiAoYXR0ci5tYXgpIHsKICAgICAgICAgICAgdmFyIG1heCA9IHBhcnNlRmxvYXQoYXR0ci5tYXgpOwogICAgICAgICAgICB2YXIgbWF4VmFsaWRhdG9yID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRW1wdHkodmFsdWUpICYmIHZhbHVlID4gbWF4KSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ21heCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbWF4JywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKG1heFZhbGlkYXRvcik7CiAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtYXhWYWxpZGF0b3IpOwogICAgICAgIH0KCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IGlzTnVtYmVyKHZhbHVlKSkgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cmxJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogICAgICAgIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogICAgICAgIHZhciB1cmxWYWxpZGF0b3IgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpIHx8IFVSTF9SRUdFWFAudGVzdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCd1cmwnLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCd1cmwnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKHVybFZhbGlkYXRvcik7CiAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKHVybFZhbGlkYXRvcik7CiAgICB9CgogICAgZnVuY3Rpb24gZW1haWxJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogICAgICAgIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogICAgICAgIHZhciBlbWFpbFZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoaXNFbXB0eSh2YWx1ZSkgfHwgRU1BSUxfUkVHRVhQLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnZW1haWwnLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdlbWFpbCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZW1haWxWYWxpZGF0b3IpOwogICAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChlbWFpbFZhbGlkYXRvcik7CiAgICB9CgogICAgZnVuY3Rpb24gcmFkaW9JbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAvLyBtYWtlIHRoZSBuYW1lIHVuaXF1ZSwgaWYgbm90IGRlZmluZWQKICAgICAgICBpZiAoaXNVbmRlZmluZWQoYXR0ci5uYW1lKSkgewogICAgICAgICAgICBlbGVtZW50LmF0dHIoJ25hbWUnLCBuZXh0VWlkKCkpOwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChlbGVtZW50WzBdLmNoZWNrZWQpIHsKICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBhdHRyLnZhbHVlOwogICAgICAgICAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSAodmFsdWUgPT0gY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBhdHRyLiRvYnNlcnZlKCd2YWx1ZScsIGN0cmwuJHJlbmRlcik7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tib3hJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICB2YXIgdHJ1ZVZhbHVlID0gYXR0ci5uZ1RydWVWYWx1ZSwKICAgICAgICAgICAgZmFsc2VWYWx1ZSA9IGF0dHIubmdGYWxzZVZhbHVlOwoKICAgICAgICBpZiAoIWlzU3RyaW5nKHRydWVWYWx1ZSkpIHRydWVWYWx1ZSA9IHRydWU7CiAgICAgICAgaWYgKCFpc1N0cmluZyhmYWxzZVZhbHVlKSkgZmFsc2VWYWx1ZSA9IGZhbHNlOwoKICAgICAgICBlbGVtZW50Lm9uKCdjbGljaycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShlbGVtZW50WzBdLmNoZWNrZWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSBjdHJsLiR2aWV3VmFsdWU7CiAgICAgICAgfTsKCiAgICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IHRydWVWYWx1ZTsKICAgICAgICB9KTsKCiAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgPyB0cnVlVmFsdWUgOiBmYWxzZVZhbHVlOwogICAgICAgIH0pOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTp0ZXh0YXJlYQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEhUTUwgdGV4dGFyZWEgZWxlbWVudCBjb250cm9sIHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuIFRoZSBkYXRhLWJpbmRpbmcgYW5kIHZhbGlkYXRpb24KICAgICAqIHByb3BlcnRpZXMgb2YgdGhpcyBlbGVtZW50IGFyZSBleGFjdGx5IHRoZSBzYW1lIGFzIHRob3NlIG9mIHRoZQogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dCBlbGVtZW50fS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOmlucHV0CiAgICAgKiBAcmVzdHJpY3QgRQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCBpbnB1dCBlbGVtZW50IGNvbnRyb2wgd2l0aCBhbmd1bGFyIGRhdGEtYmluZGluZy4gSW5wdXQgY29udHJvbCBmb2xsb3dzIEhUTUw1IGlucHV0IHR5cGVzCiAgICAgKiBhbmQgcG9seWZpbGxzIHRoZSBIVE1MNSB2YWxpZGF0aW9uIGJlaGF2aW9yIGZvciBvbGRlciBicm93c2Vycy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBuZ1JlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgaWYgc2V0IHRvIHRydWUKICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAgICRzY29wZS51c2VyID0ge25hbWU6ICdndWVzdCcsIGxhc3Q6ICd2aXNpdG9yJ307CiAgICAgICAgICAgICB9CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIDxmb3JtIG5hbWU9Im15Rm9ybSI+CiAgICAgICAgICAgICAgIFVzZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InVzZXJOYW1lIiBuZy1tb2RlbD0idXNlci5uYW1lIiByZXF1aXJlZD4KICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0udXNlck5hbWUuJGVycm9yLnJlcXVpcmVkIj4KICAgICAgICAgICAgICAgICBSZXF1aXJlZCE8L3NwYW4+PGJyPgogICAgICAgICAgICAgICBMYXN0IG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJsYXN0TmFtZSIgbmctbW9kZWw9InVzZXIubGFzdCIKICAgICAgICAgICAgICAgICBuZy1taW5sZW5ndGg9IjMiIG5nLW1heGxlbmd0aD0iMTAiPgogICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5sYXN0TmFtZS4kZXJyb3IubWlubGVuZ3RoIj4KICAgICAgICAgICAgICAgICBUb28gc2hvcnQhPC9zcGFuPgogICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5sYXN0TmFtZS4kZXJyb3IubWF4bGVuZ3RoIj4KICAgICAgICAgICAgICAgICBUb28gbG9uZyE8L3NwYW4+PGJyPgogICAgICAgICAgICAgPC9mb3JtPgogICAgICAgICAgICAgPGhyPgogICAgICAgICAgICAgPHR0PnVzZXIgPSB7e3VzZXJ9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgIDx0dD5teUZvcm0udXNlck5hbWUuJHZhbGlkID0ge3tteUZvcm0udXNlck5hbWUuJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgICAgIDx0dD5teUZvcm0udXNlck5hbWUuJGVycm9yID0ge3tteUZvcm0udXNlck5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICAgICAgICAgIDx0dD5teUZvcm0ubGFzdE5hbWUuJHZhbGlkID0ge3tteUZvcm0ubGFzdE5hbWUuJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgICAgIDx0dD5teUZvcm0ubGFzdE5hbWUuJGVycm9yID0ge3tteUZvcm0ubGFzdE5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgICAgICAgICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyPgogICAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IubWlubGVuZ3RoID0ge3shIW15Rm9ybS4kZXJyb3IubWlubGVuZ3RofX08L3R0Pjxicj4KICAgICAgICAgICAgIDx0dD5teUZvcm0uJGVycm9yLm1heGxlbmd0aCA9IHt7ISFteUZvcm0uJGVycm9yLm1heGxlbmd0aH19PC90dD48YnI+CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKS50b0VxdWFsKCd7Im5hbWUiOiJndWVzdCIsImxhc3QiOiJ2aXNpdG9yIn0nKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLnVzZXJOYW1lLiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHkgd2hlbiByZXF1aXJlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlucHV0KCd1c2VyLm5hbWUnKS5lbnRlcignJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3VzZXInKSkudG9FcXVhbCgneyJsYXN0IjoidmlzaXRvciJ9Jyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS51c2VyTmFtZS4kdmFsaWQnKSkudG9FcXVhbCgnZmFsc2UnKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgICBpdCgnc2hvdWxkIGJlIHZhbGlkIGlmIGVtcHR5IHdoZW4gbWluIGxlbmd0aCBpcyBzZXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpbnB1dCgndXNlci5sYXN0JykuZW50ZXIoJycpOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyJykpLnRvRXF1YWwoJ3sibmFtZSI6Imd1ZXN0IiwibGFzdCI6IiJ9Jyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kdmFsaWQnKSkudG9FcXVhbCgndHJ1ZScpOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAgICAgICAgfSk7CiAgICAKICAgICAgICAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGxlc3MgdGhhbiByZXF1aXJlZCBtaW4gbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaW5wdXQoJ3VzZXIubGFzdCcpLmVudGVyKCd4eCcpOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd1c2VyJykpLnRvRXF1YWwoJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJGVycm9yJykpLnRvTWF0Y2goL21pbmxlbmd0aC8pOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBsb25nZXIgdGhhbiBtYXggbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaW5wdXQoJ3VzZXIubGFzdCcpLmVudGVyKCdzb21lIHJpZGljdWxvdXNseSBsb25nIG5hbWUnKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndXNlcicpKQogICAgICAgICAgICAgICAgLnRvRXF1YWwoJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJGVycm9yJykpLnRvTWF0Y2goL21heGxlbmd0aC8pOwogICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdteUZvcm0uJHZhbGlkJykpLnRvRXF1YWwoJ2ZhbHNlJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIGlucHV0RGlyZWN0aXZlID0gWyckYnJvd3NlcicsICckc25pZmZlcicsIGZ1bmN0aW9uICgkYnJvd3NlciwgJHNuaWZmZXIpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICAgICAgICAgIGlmIChjdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgKGlucHV0VHlwZVtsb3dlcmNhc2UoYXR0ci50eXBlKV0gfHwgaW5wdXRUeXBlLnRleHQpKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGJyb3dzZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH1dOwoKICAgIHZhciBWQUxJRF9DTEFTUyA9ICduZy12YWxpZCcsCiAgICAgICAgSU5WQUxJRF9DTEFTUyA9ICduZy1pbnZhbGlkJywKICAgICAgICBQUklTVElORV9DTEFTUyA9ICduZy1wcmlzdGluZScsCiAgICAgICAgRElSVFlfQ0xBU1MgPSAnbmctZGlydHknOwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAqCiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gJHZpZXdWYWx1ZSBBY3R1YWwgc3RyaW5nIHZhbHVlIGluIHRoZSB2aWV3LgogICAgICogQHByb3BlcnR5IHsqfSAkbW9kZWxWYWx1ZSBUaGUgdmFsdWUgaW4gdGhlIG1vZGVsLCB0aGF0IHRoZSBjb250cm9sIGlzIGJvdW5kIHRvLgogICAgICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkcGFyc2VycyBBcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZSwgYXMgYSBwaXBlbGluZSwgd2hlbmV2ZXIKICAgICAgICAgICB0aGUgY29udHJvbCByZWFkcyB2YWx1ZSBmcm9tIHRoZSBET00uICBFYWNoIGZ1bmN0aW9uIGlzIGNhbGxlZCwgaW4gdHVybiwgcGFzc2luZyB0aGUgdmFsdWUKICAgICAgICAgICB0aHJvdWdoIHRvIHRoZSBuZXh0LiBVc2VkIHRvIHNhbml0aXplIC8gY29udmVydCB0aGUgdmFsdWUgYXMgd2VsbCBhcyB2YWxpZGF0aW9uLgogICAgICAgICAgIEZvciB2YWxpZGF0aW9uLCB0aGUgcGFyc2VycyBzaG91bGQgdXBkYXRlIHRoZSB2YWxpZGl0eSBzdGF0ZSB1c2luZwogICAgICAgICAgIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0VmFsaWRpdHkgJHNldFZhbGlkaXR5KCl9LAogICAgICAgICAgIGFuZCByZXR1cm4gYHVuZGVmaW5lZGAgZm9yIGludmFsaWQgdmFsdWVzLgogICAgCiAgICAgKgogICAgICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkZm9ybWF0dGVycyBBcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZSwgYXMgYSBwaXBlbGluZSwgd2hlbmV2ZXIKICAgICAgICAgICB0aGUgbW9kZWwgdmFsdWUgY2hhbmdlcy4gRWFjaCBmdW5jdGlvbiBpcyBjYWxsZWQsIGluIHR1cm4sIHBhc3NpbmcgdGhlIHZhbHVlIHRocm91Z2ggdG8gdGhlCiAgICAgICAgICAgbmV4dC4gVXNlZCB0byBmb3JtYXQgLyBjb252ZXJ0IHZhbHVlcyBmb3IgZGlzcGxheSBpbiB0aGUgY29udHJvbCBhbmQgdmFsaWRhdGlvbi4KICAgICAqICAgICAgPHByZT4KICAgICAqICAgICAgZnVuY3Rpb24gZm9ybWF0dGVyKHZhbHVlKSB7CiAgICAgKiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgKiAgICAgICAgICByZXR1cm4gdmFsdWUudG9VcHBlckNhc2UoKTsKICAgICAqICAgICAgICB9CiAgICAgKiAgICAgIH0KICAgICAqICAgICAgbmdNb2RlbC4kZm9ybWF0dGVycy5wdXNoKGZvcm1hdHRlcik7CiAgICAgKiAgICAgIDwvcHJlPgogICAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBBbiBvYmplY3QgaGFzaCB3aXRoIGFsbCBlcnJvcnMgYXMga2V5cy4KICAgICAqCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRwcmlzdGluZSBUcnVlIGlmIHVzZXIgaGFzIG5vdCBpbnRlcmFjdGVkIHdpdGggdGhlIGNvbnRyb2wgeWV0LgogICAgICogQHByb3BlcnR5IHtib29sZWFufSAkZGlydHkgVHJ1ZSBpZiB1c2VyIGhhcyBhbHJlYWR5IGludGVyYWN0ZWQgd2l0aCB0aGUgY29udHJvbC4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHZhbGlkIFRydWUgaWYgdGhlcmUgaXMgbm8gZXJyb3IuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRpbnZhbGlkIFRydWUgaWYgYXQgbGVhc3Qgb25lIGVycm9yIG9uIHRoZSBjb250cm9sLgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqIGBOZ01vZGVsQ29udHJvbGxlcmAgcHJvdmlkZXMgQVBJIGZvciB0aGUgYG5nLW1vZGVsYCBkaXJlY3RpdmUuIFRoZSBjb250cm9sbGVyIGNvbnRhaW5zCiAgICAgKiBzZXJ2aWNlcyBmb3IgZGF0YS1iaW5kaW5nLCB2YWxpZGF0aW9uLCBDU1MgdXBkYXRlLCB2YWx1ZSBmb3JtYXR0aW5nIGFuZCBwYXJzaW5nLiBJdAogICAgICogc3BlY2lmaWNhbGx5IGRvZXMgbm90IGNvbnRhaW4gYW55IGxvZ2ljIHdoaWNoIGRlYWxzIHdpdGggRE9NIHJlbmRlcmluZyBvciBsaXN0ZW5pbmcgdG8KICAgICAqIERPTSBldmVudHMuIFRoZSBgTmdNb2RlbENvbnRyb2xsZXJgIGlzIG1lYW50IHRvIGJlIGV4dGVuZGVkIGJ5IG90aGVyIGRpcmVjdGl2ZXMgd2hlcmUsIHRoZQogICAgICogZGlyZWN0aXZlIHByb3ZpZGVzIERPTSBtYW5pcHVsYXRpb24gYW5kIHRoZSBgTmdNb2RlbENvbnRyb2xsZXJgIHByb3ZpZGVzIHRoZSBkYXRhLWJpbmRpbmcuCiAgICAgKiBOb3RlIHRoYXQgeW91IGNhbm5vdCB1c2UgYE5nTW9kZWxDb250cm9sbGVyYCBpbiBhIGRpcmVjdGl2ZSB3aXRoIGFuIGlzb2xhdGVkIHNjb3BlLAogICAgICogYXMsIGluIHRoYXQgY2FzZSwgdGhlIGBuZy1tb2RlbGAgdmFsdWUgZ2V0cyBwdXQgaW50byB0aGUgaXNvbGF0ZWQgc2NvcGUgYW5kIGRvZXMgbm90IGdldAogICAgICogcHJvcG9nYXRlZCB0byB0aGUgcGFyZW50IHNjb3BlLgogICAgICoKICAgICAqCiAgICAgKiBUaGlzIGV4YW1wbGUgc2hvd3MgaG93IHRvIHVzZSBgTmdNb2RlbENvbnRyb2xsZXJgIHdpdGggYSBjdXN0b20gY29udHJvbCB0byBhY2hpZXZlCiAgICAgKiBkYXRhLWJpbmRpbmcuIE5vdGljZSBob3cgZGlmZmVyZW50IGRpcmVjdGl2ZXMgKGBjb250ZW50ZWRpdGFibGVgLCBgbmctbW9kZWxgLCBhbmQgYHJlcXVpcmVkYCkKICAgICAqIGNvbGxhYm9yYXRlIHRvZ2V0aGVyIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgcmVzdWx0LgogICAgICoKICAgICAqIDxleGFtcGxlIG1vZHVsZT0iY3VzdG9tQ29udHJvbCI+CiAgICAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgICAgIFtjb250ZW50ZWRpdGFibGVdIHsKICAgICAgICAgICAgYm9yZGVyOiAxcHggc29saWQgYmxhY2s7CiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgICAgICAgICBtaW4taGVpZ2h0OiAyMHB4OwogICAgICAgICAgfQogICAgCiAgICAgICAgICAubmctaW52YWxpZCB7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHJlZDsKICAgICAgICAgIH0KICAgIAogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2N1c3RvbUNvbnRyb2wnLCBbXSkuCiAgICAgICAgICAgIGRpcmVjdGl2ZSgnY29udGVudGVkaXRhYmxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnQScsIC8vIG9ubHkgYWN0aXZhdGUgb24gZWxlbWVudCBhdHRyaWJ1dGUKICAgICAgICAgICAgICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsIC8vIGdldCBhIGhvbGQgb2YgTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycywgbmdNb2RlbCkgewogICAgICAgICAgICAgICAgICBpZighbmdNb2RlbCkgcmV0dXJuOyAvLyBkbyBub3RoaW5nIGlmIG5vIG5nLW1vZGVsCiAgICAKICAgICAgICAgICAgICAgICAgLy8gU3BlY2lmeSBob3cgVUkgc2hvdWxkIGJlIHVwZGF0ZWQKICAgICAgICAgICAgICAgICAgbmdNb2RlbC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKG5nTW9kZWwuJHZpZXdWYWx1ZSB8fCAnJyk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAKICAgICAgICAgICAgICAgICAgLy8gTGlzdGVuIGZvciBjaGFuZ2UgZXZlbnRzIHRvIGVuYWJsZSBiaW5kaW5nCiAgICAgICAgICAgICAgICAgIGVsZW1lbnQub24oJ2JsdXIga2V5dXAgY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KHJlYWQpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgcmVhZCgpOyAvLyBpbml0aWFsaXplCiAgICAKICAgICAgICAgICAgICAgICAgLy8gV3JpdGUgZGF0YSB0byB0aGUgbW9kZWwKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVhZCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaHRtbCA9IGVsZW1lbnQuaHRtbCgpOwogICAgICAgICAgICAgICAgICAgIC8vIFdoZW4gd2UgY2xlYXIgdGhlIGNvbnRlbnQgZWRpdGFibGUgdGhlIGJyb3dzZXIgbGVhdmVzIGEgPGJyPiBiZWhpbmQKICAgICAgICAgICAgICAgICAgICAvLyBJZiBzdHJpcC1iciBhdHRyaWJ1dGUgaXMgcHJvdmlkZWQgdGhlbiB3ZSBzdHJpcCB0aGlzIG91dAogICAgICAgICAgICAgICAgICAgIGlmKCBhdHRycy5zdHJpcEJyICYmIGh0bWwgPT0gJzxicj4nICkgewogICAgICAgICAgICAgICAgICAgICAgaHRtbCA9ICcnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBuZ01vZGVsLiRzZXRWaWV3VmFsdWUoaHRtbCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iPgogICAgICAgICAgIDxkaXYgY29udGVudGVkaXRhYmxlCiAgICAgICAgICAgICAgICBuYW1lPSJteVdpZGdldCIgbmctbW9kZWw9InVzZXJDb250ZW50IgogICAgICAgICAgICAgICAgc3RyaXAtYnI9InRydWUiCiAgICAgICAgICAgICAgICByZXF1aXJlZD5DaGFuZ2UgbWUhPC9kaXY+CiAgICAgICAgICAgIDxzcGFuIG5nLXNob3c9Im15Rm9ybS5teVdpZGdldC4kZXJyb3IucmVxdWlyZWQiPlJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICA8aHI+CiAgICAgICAgICAgPHRleHRhcmVhIG5nLW1vZGVsPSJ1c2VyQ29udGVudCI+PC90ZXh0YXJlYT4KICAgICAgICAgIDwvZm9ybT4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0ic2NlbmFyaW8uanMiPgogICAgICAgICAgaXQoJ3Nob3VsZCBkYXRhLWJpbmQgYW5kIGJlY29tZSBpbnZhbGlkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjb250ZW50RWRpdGFibGUgPSBlbGVtZW50KCdbY29udGVudGVkaXRhYmxlXScpOwogICAgCiAgICAgICAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUudGV4dCgpKS50b0VxdWFsKCdDaGFuZ2UgbWUhJyk7CiAgICAgICAgICAgIGlucHV0KCd1c2VyQ29udGVudCcpLmVudGVyKCcnKTsKICAgICAgICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS50ZXh0KCkpLnRvRXF1YWwoJycpOwogICAgICAgICAgICBleHBlY3QoY29udGVudEVkaXRhYmxlLnByb3AoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9uZy1pbnZhbGlkLXJlcXVpcmVkLyk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgKiA8L2V4YW1wbGU+CiAgICAgKgogICAgICovCiAgICB2YXIgTmdNb2RlbENvbnRyb2xsZXIgPSBbJyRzY29wZScsICckZXhjZXB0aW9uSGFuZGxlcicsICckYXR0cnMnLCAnJGVsZW1lbnQnLCAnJHBhcnNlJywKICAgICAgICBmdW5jdGlvbiAoJHNjb3BlLCAkZXhjZXB0aW9uSGFuZGxlciwgJGF0dHIsICRlbGVtZW50LCAkcGFyc2UpIHsKICAgICAgICAgICAgdGhpcy4kdmlld1ZhbHVlID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy4kbW9kZWxWYWx1ZSA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuJHBhcnNlcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy4kZm9ybWF0dGVycyA9IFtdOwogICAgICAgICAgICB0aGlzLiR2aWV3Q2hhbmdlTGlzdGVuZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuJHByaXN0aW5lID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy4kZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy4kdmFsaWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLiRpbnZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuJG5hbWUgPSAkYXR0ci5uYW1lOwoKICAgICAgICAgICAgdmFyIG5nTW9kZWxHZXQgPSAkcGFyc2UoJGF0dHIubmdNb2RlbCksCiAgICAgICAgICAgICAgICBuZ01vZGVsU2V0ID0gbmdNb2RlbEdldC5hc3NpZ247CgogICAgICAgICAgICBpZiAoIW5nTW9kZWxTZXQpIHsKICAgICAgICAgICAgICAgIHRocm93IG1pbkVycignbmdNb2RlbCcpKCdub25hc3NpZ24nLCAiRXhwcmVzc2lvbiAnezB9JyBpcyBub24tYXNzaWduYWJsZS4gRWxlbWVudDogezF9IiwKICAgICAgICAgICAgICAgICAgICAkYXR0ci5uZ01vZGVsLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRyZW5kZXIKICAgICAgICAgICAgICogQG1ldGhvZE9mIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBDYWxsZWQgd2hlbiB0aGUgdmlldyBuZWVkcyB0byBiZSB1cGRhdGVkLiBJdCBpcyBleHBlY3RlZCB0aGF0IHRoZSB1c2VyIG9mIHRoZSBuZy1tb2RlbAogICAgICAgICAgICAgKiBkaXJlY3RpdmUgd2lsbCBpbXBsZW1lbnQgdGhpcyBtZXRob2QuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB0aGlzLiRyZW5kZXIgPSBub29wOwoKICAgICAgICAgICAgdmFyIHBhcmVudEZvcm0gPSAkZWxlbWVudC5pbmhlcml0ZWREYXRhKCckZm9ybUNvbnRyb2xsZXInKSB8fCBudWxsRm9ybUN0cmwsCiAgICAgICAgICAgICAgICBpbnZhbGlkQ291bnQgPSAwLCAvLyB1c2VkIHRvIGVhc2lseSBkZXRlcm1pbmUgaWYgd2UgYXJlIHZhbGlkCiAgICAgICAgICAgICAgICAkZXJyb3IgPSB0aGlzLiRlcnJvciA9IHt9OyAvLyBrZWVwIGludmFsaWQga2V5cyBoZXJlCgoKICAgICAgICAgICAgLy8gU2V0dXAgaW5pdGlhbCBzdGF0ZSBvZiB0aGUgY29udHJvbAogICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhQUklTVElORV9DTEFTUyk7CiAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwoKICAgICAgICAgICAgLy8gY29udmVuaWVuY2UgbWV0aG9kIGZvciBlYXN5IHRvZ2dsaW5nIG9mIGNsYXNzZXMKICAgICAgICAgICAgZnVuY3Rpb24gdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KSB7CiAgICAgICAgICAgICAgICB2YWxpZGF0aW9uRXJyb3JLZXkgPSB2YWxpZGF0aW9uRXJyb3JLZXkgPyAnLScgKyBzbmFrZV9jYXNlKHZhbGlkYXRpb25FcnJvcktleSwgJy0nKSA6ICcnOwogICAgICAgICAgICAgICAgJGVsZW1lbnQuCiAgICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKChpc1ZhbGlkID8gSU5WQUxJRF9DTEFTUyA6IFZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSkuCiAgICAgICAgICAgICAgICAgIGFkZENsYXNzKChpc1ZhbGlkID8gVkFMSURfQ0xBU1MgOiBJTlZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICAgICAgICAgICAqIEBtZXRob2RPZiBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogQ2hhbmdlIHRoZSB2YWxpZGl0eSBzdGF0ZSwgYW5kIG5vdGlmaWVzIHRoZSBmb3JtIHdoZW4gdGhlIGNvbnRyb2wgY2hhbmdlcyB2YWxpZGl0eS4gKGkuZS4gaXQKICAgICAgICAgICAgICogZG9lcyBub3Qgbm90aWZ5IGZvcm0gaWYgZ2l2ZW4gdmFsaWRhdG9yIGlzIGFscmVhZHkgbWFya2VkIGFzIGludmFsaWQpLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGJ5IHZhbGlkYXRvcnMgLSBpLmUuIHRoZSBwYXJzZXIgb3IgZm9ybWF0dGVyIGZ1bmN0aW9ucy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbGlkYXRpb25FcnJvcktleSBOYW1lIG9mIHRoZSB2YWxpZGF0b3IuIHRoZSBgdmFsaWRhdGlvbkVycm9yS2V5YCB3aWxsIGFzc2lnbgogICAgICAgICAgICAgKiAgICAgICAgdG8gYCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldPWlzVmFsaWRgIHNvIHRoYXQgaXQgaXMgYXZhaWxhYmxlIGZvciBkYXRhLWJpbmRpbmcuCiAgICAgICAgICAgICAqICAgICAgICBUaGUgYHZhbGlkYXRpb25FcnJvcktleWAgc2hvdWxkIGJlIGluIGNhbWVsQ2FzZSBhbmQgd2lsbCBnZXQgY29udmVydGVkIGludG8gZGFzaC1jYXNlCiAgICAgICAgICAgICAqICAgICAgICBmb3IgY2xhc3MgbmFtZS4gRXhhbXBsZTogYG15RXJyb3JgIHdpbGwgcmVzdWx0IGluIGBuZy12YWxpZC1teS1lcnJvcmAgYW5kIGBuZy1pbnZhbGlkLW15LWVycm9yYAogICAgICAgICAgICAgKiAgICAgICAgY2xhc3MgYW5kIGNhbiBiZSBib3VuZCB0byBhcyAgYHt7c29tZUZvcm0uc29tZUNvbnRyb2wuJGVycm9yLm15RXJyb3J9fWAgLgogICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzVmFsaWQgV2hldGhlciB0aGUgY3VycmVudCBzdGF0ZSBpcyB2YWxpZCAodHJ1ZSkgb3IgaW52YWxpZCAoZmFsc2UpLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbiAodmFsaWRhdGlvbkVycm9yS2V5LCBpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0gPT09ICFpc1ZhbGlkKSByZXR1cm47CgogICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0pIGludmFsaWRDb3VudC0tOwogICAgICAgICAgICAgICAgICAgIGlmICghaW52YWxpZENvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiR2YWxpZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGludmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRpbnZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLiR2YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGludmFsaWRDb3VudCsrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldID0gIWlzVmFsaWQ7CiAgICAgICAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpOwoKICAgICAgICAgICAgICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25FcnJvcktleSwgaXNWYWxpZCwgdGhpcyk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRQcmlzdGluZQogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNldHMgdGhlIGNvbnRyb2wgdG8gaXRzIHByaXN0aW5lIHN0YXRlLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIHJlbW92ZSB0aGUgJ25nLWRpcnR5JyBjbGFzcyBhbmQgc2V0IHRoZSBjb250cm9sIHRvIGl0cyBwcmlzdGluZQogICAgICAgICAgICAgKiBzdGF0ZSAobmctcHJpc3RpbmUgY2xhc3MpLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy4kc2V0UHJpc3RpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRkaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy4kcHJpc3RpbmUgPSB0cnVlOwogICAgICAgICAgICAgICAgJGVsZW1lbnQucmVtb3ZlQ2xhc3MoRElSVFlfQ0xBU1MpLmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZpZXdWYWx1ZQogICAgICAgICAgICAgKiBAbWV0aG9kT2YgbmcuZGlyZWN0aXZlOm5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFJlYWQgYSB2YWx1ZSBmcm9tIHZpZXcuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIFRoaXMgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgZnJvbSB3aXRoaW4gYSBET00gZXZlbnQgaGFuZGxlci4KICAgICAgICAgICAgICogRm9yIGV4YW1wbGUge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dH0gb3IKICAgICAgICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpzZWxlY3Qgc2VsZWN0fSBkaXJlY3RpdmVzIGNhbGwgaXQuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEl0IGludGVybmFsbHkgY2FsbHMgYWxsIGAkcGFyc2Vyc2AgKGluY2x1ZGluZyB2YWxpZGF0b3JzKSBhbmQgdXBkYXRlcyB0aGUgYCRtb2RlbFZhbHVlYCBhbmQgdGhlIGFjdHVhbCBtb2RlbCBwYXRoLgogICAgICAgICAgICAgKiBMYXN0bHkgaXQgY2FsbHMgYWxsIHJlZ2lzdGVyZWQgY2hhbmdlIGxpc3RlbmVycy4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIFZhbHVlIGZyb20gdGhlIHZpZXcuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB0aGlzLiRzZXRWaWV3VmFsdWUgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuJHZpZXdWYWx1ZSA9IHZhbHVlOwoKICAgICAgICAgICAgICAgIC8vIGNoYW5nZSB0byBkaXJ0eQogICAgICAgICAgICAgICAgaWYgKHRoaXMuJHByaXN0aW5lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJHByaXN0aW5lID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQucmVtb3ZlQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpLmFkZENsYXNzKERJUlRZX0NMQVNTKTsKICAgICAgICAgICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvckVhY2godGhpcy4kcGFyc2VycywgZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmbih2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy4kbW9kZWxWYWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiRtb2RlbFZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbFNldCgkc2NvcGUsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHRoaXMuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMsIGZ1bmN0aW9uIChsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gbW9kZWwgLT4gdmFsdWUKICAgICAgICAgICAgdmFyIGN0cmwgPSB0aGlzOwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbiBuZ01vZGVsV2F0Y2goKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBuZ01vZGVsR2V0KCRzY29wZSk7CgogICAgICAgICAgICAgICAgLy8gaWYgc2NvcGUgbW9kZWwgdmFsdWUgYW5kIG5nTW9kZWwgdmFsdWUgYXJlIG91dCBvZiBzeW5jCiAgICAgICAgICAgICAgICBpZiAoY3RybC4kbW9kZWxWYWx1ZSAhPT0gdmFsdWUpIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGZvcm1hdHRlcnMgPSBjdHJsLiRmb3JtYXR0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICBpZHggPSBmb3JtYXR0ZXJzLmxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgY3RybC4kbW9kZWxWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIHdoaWxlIChpZHgtLSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGZvcm1hdHRlcnNbaWR4XSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoY3RybC4kdmlld1ZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiR2aWV3VmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kcmVuZGVyKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9XTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb2RlbAogICAgICoKICAgICAqIEBlbGVtZW50IGlucHV0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBJcyBhIGRpcmVjdGl2ZSB0aGF0IHRlbGxzIEFuZ3VsYXIgdG8gZG8gdHdvLXdheSBkYXRhIGJpbmRpbmcuIEl0IHdvcmtzIHRvZ2V0aGVyIHdpdGggYGlucHV0YCwKICAgICAqIGBzZWxlY3RgLCBgdGV4dGFyZWFgIGFuZCBldmVuIGN1c3RvbSBmb3JtIGNvbnRyb2xzIHRoYXQgdXNlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAgICogTmdNb2RlbENvbnRyb2xsZXJ9IGV4cG9zZWQgYnkgdGhpcyBkaXJlY3RpdmUuCiAgICAgKgogICAgICogYG5nTW9kZWxgIGlzIHJlc3BvbnNpYmxlIGZvcjoKICAgICAqCiAgICAgKiAtIGJpbmRpbmcgdGhlIHZpZXcgaW50byB0aGUgbW9kZWwsIHdoaWNoIG90aGVyIGRpcmVjdGl2ZXMgc3VjaCBhcyBgaW5wdXRgLCBgdGV4dGFyZWFgIG9yIGBzZWxlY3RgCiAgICAgKiAgIHJlcXVpcmUsCiAgICAgKiAtIHByb3ZpZGluZyB2YWxpZGF0aW9uIGJlaGF2aW9yIChpLmUuIHJlcXVpcmVkLCBudW1iZXIsIGVtYWlsLCB1cmwpLAogICAgICogLSBrZWVwaW5nIHN0YXRlIG9mIHRoZSBjb250cm9sICh2YWxpZC9pbnZhbGlkLCBkaXJ0eS9wcmlzdGluZSwgdmFsaWRhdGlvbiBlcnJvcnMpLAogICAgICogLSBzZXR0aW5nIHJlbGF0ZWQgY3NzIGNsYXNzIG9udG8gdGhlIGVsZW1lbnQgKGBuZy12YWxpZGAsIGBuZy1pbnZhbGlkYCwgYG5nLWRpcnR5YCwgYG5nLXByaXN0aW5lYCksCiAgICAgKiAtIHJlZ2lzdGVyIHRoZSBjb250cm9sIHdpdGggcGFyZW50IHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBmb3JtfS4KICAgICAqCiAgICAgKiBOb3RlOiBgbmdNb2RlbGAgd2lsbCB0cnkgdG8gYmluZCB0byB0aGUgcHJvcGVydHkgZ2l2ZW4gYnkgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbiBvbiB0aGUKICAgICAqIGN1cnJlbnQgc2NvcGUuIElmIHRoZSBwcm9wZXJ0eSBkb2Vzbid0IGFscmVhZHkgZXhpc3Qgb24gdGhpcyBzY29wZSwgaXQgd2lsbCBiZSBjcmVhdGVkCiAgICAgKiBpbXBsaWNpdGx5IGFuZCBhZGRlZCB0byB0aGUgc2NvcGUuCiAgICAgKgogICAgICogRm9yIGJhc2ljIGV4YW1wbGVzLCBob3cgdG8gdXNlIGBuZ01vZGVsYCwgc2VlOgogICAgICoKICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXR9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQudGV4dCB0ZXh0fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LmNoZWNrYm94IGNoZWNrYm94fQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0LnJhZGlvIHJhZGlvfQogICAgICogICAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0Lm51bWJlciBudW1iZXJ9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQuZW1haWwgZW1haWx9CiAgICAgKiAgICAtIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQudXJsIHVybH0KICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0KICAgICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6dGV4dGFyZWEgdGV4dGFyZWF9CiAgICAgKgogICAgICovCiAgICB2YXIgbmdNb2RlbERpcmVjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXF1aXJlOiBbJ25nTW9kZWwnLCAnXj9mb3JtJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IE5nTW9kZWxDb250cm9sbGVyLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmxzKSB7CiAgICAgICAgICAgICAgICAvLyBub3RpZnkgb3RoZXJzLCBlc3BlY2lhbGx5IHBhcmVudCBmb3JtcwoKICAgICAgICAgICAgICAgIHZhciBtb2RlbEN0cmwgPSBjdHJsc1swXSwKICAgICAgICAgICAgICAgICAgICBmb3JtQ3RybCA9IGN0cmxzWzFdIHx8IG51bGxGb3JtQ3RybDsKCiAgICAgICAgICAgICAgICBmb3JtQ3RybC4kYWRkQ29udHJvbChtb2RlbEN0cmwpOwoKICAgICAgICAgICAgICAgIGVsZW1lbnQub24oJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGZvcm1DdHJsLiRyZW1vdmVDb250cm9sKG1vZGVsQ3RybCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NoYW5nZQogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEV2YWx1YXRlIGdpdmVuIGV4cHJlc3Npb24gd2hlbiB1c2VyIGNoYW5nZXMgdGhlIGlucHV0LgogICAgICogVGhlIGV4cHJlc3Npb24gaXMgbm90IGV2YWx1YXRlZCB3aGVuIHRoZSB2YWx1ZSBjaGFuZ2UgaXMgY29taW5nIGZyb20gdGhlIG1vZGVsLgogICAgICoKICAgICAqIE5vdGUsIHRoaXMgZGlyZWN0aXZlIHJlcXVpcmVzIGBuZ01vZGVsYCB0byBiZSBwcmVzZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IGlucHV0CiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxkb2M6ZXhhbXBsZT4KICAgICAqICAgPGRvYzpzb3VyY2U+CiAgICAgKiAgICAgPHNjcmlwdD4KICAgICAqICAgICAgIGZ1bmN0aW9uIENvbnRyb2xsZXIoJHNjb3BlKSB7CiAgICAgKiAgICAgICAgICRzY29wZS5jb3VudGVyID0gMDsKICAgICAqICAgICAgICAgJHNjb3BlLmNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICogICAgICAgICAgICRzY29wZS5jb3VudGVyKys7CiAgICAgKiAgICAgICAgIH07CiAgICAgKiAgICAgICB9CiAgICAgKiAgICAgPC9zY3JpcHQ+CiAgICAgKiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDb250cm9sbGVyIj4KICAgICAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgbmctY2hhbmdlPSJjaGFuZ2UoKSIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMSIgLz4KICAgICAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMiIgLz4KICAgICAqICAgICAgIDxsYWJlbCBmb3I9Im5nLWNoYW5nZS1leGFtcGxlMiI+Q29uZmlybWVkPC9sYWJlbD48YnIgLz4KICAgICAqICAgICAgIGRlYnVnID0ge3tjb25maXJtZWR9fTxiciAvPgogICAgICogICAgICAgY291bnRlciA9IHt7Y291bnRlcn19CiAgICAgKiAgICAgPC9kaXY+CiAgICAgKiAgIDwvZG9jOnNvdXJjZT4KICAgICAqICAgPGRvYzpzY2VuYXJpbz4KICAgICAqICAgICBpdCgnc2hvdWxkIGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gdmlldycsIGZ1bmN0aW9uKCkgewogICAgICogICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50ZXInKSkudG9FcXVhbCgnMCcpOwogICAgICogICAgICAgZWxlbWVudCgnI25nLWNoYW5nZS1leGFtcGxlMScpLmNsaWNrKCk7CiAgICAgKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcxJyk7CiAgICAgKiAgICAgICBleHBlY3QoYmluZGluZygnY29uZmlybWVkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAqICAgICB9KTsKICAgICAqCiAgICAgKiAgICAgaXQoJ3Nob3VsZCBub3QgZXZhbHVhdGUgdGhlIGV4cHJlc3Npb24gaWYgY2hhbmdpbmcgZnJvbSBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICogICAgICAgZWxlbWVudCgnI25nLWNoYW5nZS1leGFtcGxlMicpLmNsaWNrKCk7CiAgICAgKiAgICAgICBleHBlY3QoYmluZGluZygnY291bnRlcicpKS50b0VxdWFsKCcwJyk7CiAgICAgKiAgICAgICBleHBlY3QoYmluZGluZygnY29uZmlybWVkJykpLnRvRXF1YWwoJ3RydWUnKTsKICAgICAqICAgICB9KTsKICAgICAqICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgKiA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDaGFuZ2VEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICAgICAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgIGN0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kZXZhbChhdHRyLm5nQ2hhbmdlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CgoKICAgIHZhciByZXF1aXJlZERpcmVjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsbSwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgaWYgKCFjdHJsKSByZXR1cm47CiAgICAgICAgICAgICAgICBhdHRyLnJlcXVpcmVkID0gdHJ1ZTsgLy8gZm9yY2UgdHJ1dGh5IGluIGNhc2Ugd2UgYXJlIG9uIG5vbiBpbnB1dCBlbGVtZW50CgogICAgICAgICAgICAgICAgdmFyIHZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChhdHRyLnJlcXVpcmVkICYmIChpc0VtcHR5KHZhbHVlKSB8fCB2YWx1ZSA9PT0gZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2godmFsaWRhdG9yKTsKICAgICAgICAgICAgICAgIGN0cmwuJHBhcnNlcnMudW5zaGlmdCh2YWxpZGF0b3IpOwoKICAgICAgICAgICAgICAgIGF0dHIuJG9ic2VydmUoJ3JlcXVpcmVkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRvcihjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdMaXN0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUZXh0IGlucHV0IHRoYXQgY29udmVydHMgYmV0d2VlbiBjb21tYS1zZXBhcmF0ZWQgc3RyaW5nIGludG8gYW4gYXJyYXkgb2Ygc3RyaW5ncy4KICAgICAqCiAgICAgKiBAZWxlbWVudCBpbnB1dAogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0xpc3Qgb3B0aW9uYWwgZGVsaW1pdGVyIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gc3BsaXQgdGhlIHZhbHVlLiBJZgogICAgICogICBzcGVjaWZpZWQgaW4gZm9ybSBgL3NvbWV0aGluZy9gIHRoZW4gdGhlIHZhbHVlIHdpbGwgYmUgY29udmVydGVkIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24uCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLm5hbWVzID0gWydpZ29yJywgJ21pc2tvJywgJ3ZvanRhJ107CiAgICAgICAgICAgICB9CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIExpc3Q6IDxpbnB1dCBuYW1lPSJuYW1lc0lucHV0IiBuZy1tb2RlbD0ibmFtZXMiIG5nLWxpc3QgcmVxdWlyZWQ+CiAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5uYW1lc0lucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgICAgICAgICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICAgICAgICAgIDxicj4KICAgICAgICAgICAgIDx0dD5uYW1lcyA9IHt7bmFtZXN9fTwvdHQ+PGJyLz4KICAgICAgICAgICAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgICAgPHR0Pm15Rm9ybS5uYW1lc0lucHV0LiRlcnJvciA9IHt7bXlGb3JtLm5hbWVzSW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgICAgICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgICAgICAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygnbmFtZXMnKSkudG9FcXVhbCgnWyJpZ29yIiwibWlza28iLCJ2b2p0YSJdJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCcpKS50b0VxdWFsKCd0cnVlJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJ3NwYW4uZXJyb3InKS5jc3MoJ2Rpc3BsYXknKSkudG9CZSgnbm9uZScpOwogICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpbnB1dCgnbmFtZXMnKS5lbnRlcignJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ25hbWVzJykpLnRvRXF1YWwoJ1tdJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCcpKS50b0VxdWFsKCdmYWxzZScpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCdzcGFuLmVycm9yJykuY3NzKCdkaXNwbGF5JykpLm5vdCgpLnRvQmUoJ25vbmUnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICB2YXIgbmdMaXN0RGlyZWN0aXZlID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlcXVpcmU6ICduZ01vZGVsJywKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSAvXC8oLiopXC8vLmV4ZWMoYXR0ci5uZ0xpc3QpLAogICAgICAgICAgICAgICAgICAgIHNlcGFyYXRvciA9IG1hdGNoICYmIG5ldyBSZWdFeHAobWF0Y2hbMV0pIHx8IGF0dHIubmdMaXN0IHx8ICcsJzsKCiAgICAgICAgICAgICAgICB2YXIgcGFyc2UgPSBmdW5jdGlvbiAodmlld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpc3QgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHZpZXdWYWx1ZS5zcGxpdChzZXBhcmF0b3IpLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgbGlzdC5wdXNoKHRyaW0odmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKHBhcnNlKTsKICAgICAgICAgICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLmpvaW4oJywgJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfTsKCgogICAgdmFyIENPTlNUQU5UX1ZBTFVFX1JFR0VYUCA9IC9eKHRydWV8ZmFsc2V8XGQrKSQvOwoKICAgIHZhciBuZ1ZhbHVlRGlyZWN0aXZlID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICh0cGwsIHRwbEF0dHIpIHsKICAgICAgICAgICAgICAgIGlmIChDT05TVEFOVF9WQUxVRV9SRUdFWFAudGVzdCh0cGxBdHRyLm5nVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxtLCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBzY29wZS4kZXZhbChhdHRyLm5nVmFsdWUpKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbG0sIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdWYWx1ZSwgZnVuY3Rpb24gdmFsdWVXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0JpbmRgIGF0dHJpYnV0ZSB0ZWxscyBBbmd1bGFyIHRvIHJlcGxhY2UgdGhlIHRleHQgY29udGVudCBvZiB0aGUgc3BlY2lmaWVkIEhUTUwgZWxlbWVudAogICAgICogd2l0aCB0aGUgdmFsdWUgb2YgYSBnaXZlbiBleHByZXNzaW9uLCBhbmQgdG8gdXBkYXRlIHRoZSB0ZXh0IGNvbnRlbnQgd2hlbiB0aGUgdmFsdWUgb2YgdGhhdAogICAgICogZXhwcmVzc2lvbiBjaGFuZ2VzLgogICAgICoKICAgICAqIFR5cGljYWxseSwgeW91IGRvbid0IHVzZSBgbmdCaW5kYCBkaXJlY3RseSwgYnV0IGluc3RlYWQgeW91IHVzZSB0aGUgZG91YmxlIGN1cmx5IG1hcmt1cCBsaWtlCiAgICAgKiBge3sgZXhwcmVzc2lvbiB9fWAgd2hpY2ggaXMgc2ltaWxhciBidXQgbGVzcyB2ZXJib3NlLgogICAgICoKICAgICAqIEl0IGlzIHByZWZlcnJhYmxlIHRvIHVzZSBgbmdCaW5kYCBpbnN0ZWFkIG9mIGB7eyBleHByZXNzaW9uIH19YCB3aGVuIGEgdGVtcGxhdGUgaXMgbW9tZW50YXJpbHkgCiAgICAgKiBkaXNwbGF5ZWQgYnkgdGhlIGJyb3dzZXIgaW4gaXRzIHJhdyBzdGF0ZSBiZWZvcmUgQW5ndWxhciBjb21waWxlcyBpdC4gU2luY2UgYG5nQmluZGAgaXMgYW4gCiAgICAgKiBlbGVtZW50IGF0dHJpYnV0ZSwgaXQgbWFrZXMgdGhlIGJpbmRpbmdzIGludmlzaWJsZSB0byB0aGUgdXNlciB3aGlsZSB0aGUgcGFnZSBpcyBsb2FkaW5nLgogICAgICoKICAgICAqIEFuIGFsdGVybmF0aXZlIHNvbHV0aW9uIHRvIHRoaXMgcHJvYmxlbSB3b3VsZCBiZSB1c2luZyB0aGUKICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbG9hayBuZ0Nsb2FrfSBkaXJlY3RpdmUuCiAgICAgKgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0JpbmQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEVudGVyIGEgbmFtZSBpbiB0aGUgTGl2ZSBQcmV2aWV3IHRleHQgYm94OyB0aGUgZ3JlZXRpbmcgYmVsb3cgdGhlIHRleHQgYm94IGNoYW5nZXMgaW5zdGFudGx5LgogICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAnV2hpcmxlZCc7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIEVudGVyIG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSI+PGJyPgogICAgICAgICAgICAgSGVsbG8gPHNwYW4gbmctYmluZD0ibmFtZSI+PC9zcGFuPiEKICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkudG9CZSgnV2hpcmxlZCcpOwogICAgICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ25hbWUnKS5lbnRlcignd29ybGQnKTsKICAgICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCduYW1lJykpLnRvQmUoJ3dvcmxkJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQmluZERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kKTsKICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ0JpbmQsIGZ1bmN0aW9uIG5nQmluZFdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGVsZW1lbnQudGV4dCh2YWx1ZSA9PSB1bmRlZmluZWQgPyAnJyA6IHZhbHVlKTsKICAgICAgICB9KTsKICAgIH0pOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0JpbmRUZW1wbGF0ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0JpbmRUZW1wbGF0ZWAgZGlyZWN0aXZlIHNwZWNpZmllcyB0aGF0IHRoZSBlbGVtZW50CiAgICAgKiB0ZXh0IGNvbnRlbnQgc2hvdWxkIGJlIHJlcGxhY2VkIHdpdGggdGhlIGludGVycG9sYXRpb24gb2YgdGhlIHRlbXBsYXRlCiAgICAgKiBpbiB0aGUgYG5nQmluZFRlbXBsYXRlYCBhdHRyaWJ1dGUuCiAgICAgKiBVbmxpa2UgYG5nQmluZGAsIHRoZSBgbmdCaW5kVGVtcGxhdGVgIGNhbiBjb250YWluIG11bHRpcGxlIGB7e2AgYH19YAogICAgICogZXhwcmVzc2lvbnMuIFRoaXMgZGlyZWN0aXZlIGlzIG5lZWRlZCBzaW5jZSBzb21lIEhUTUwgZWxlbWVudHMKICAgICAqIChzdWNoIGFzIFRJVExFIGFuZCBPUFRJT04pIGNhbm5vdCBjb250YWluIFNQQU4gZWxlbWVudHMuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdCaW5kVGVtcGxhdGUgdGVtcGxhdGUgb2YgZm9ybQogICAgICogICA8dHQ+e3s8L3R0PiA8dHQ+ZXhwcmVzc2lvbjwvdHQ+IDx0dD59fTwvdHQ+IHRvIGV2YWwuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFRyeSBpdCBoZXJlOiBlbnRlciB0ZXh0IGluIHRleHQgYm94IGFuZCB3YXRjaCB0aGUgZ3JlZXRpbmcgY2hhbmdlLgogICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgJHNjb3BlLnNhbHV0YXRpb24gPSAnSGVsbG8nOwogICAgICAgICAgICAgICAkc2NvcGUubmFtZSA9ICdXb3JsZCc7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgU2FsdXRhdGlvbjogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzYWx1dGF0aW9uIj48YnI+CiAgICAgICAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSI+PGJyPgogICAgICAgICAgICA8cHJlIG5nLWJpbmQtdGVtcGxhdGU9Int7c2FsdXRhdGlvbn19IHt7bmFtZX19ISI+PC9wcmU+CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCdzYWx1dGF0aW9uJykpLgogICAgICAgICAgICAgICB0b0JlKCdIZWxsbycpOwogICAgICAgICAgICAgZXhwZWN0KHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmJpbmRpbmcoJ25hbWUnKSkuCiAgICAgICAgICAgICAgIHRvQmUoJ1dvcmxkJyk7CiAgICAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgnc2FsdXRhdGlvbicpLmVudGVyKCdHcmVldGluZ3MnKTsKICAgICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCduYW1lJykuZW50ZXIoJ3VzZXInKTsKICAgICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCdzYWx1dGF0aW9uJykpLgogICAgICAgICAgICAgICB0b0JlKCdHcmVldGluZ3MnKTsKICAgICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCduYW1lJykpLgogICAgICAgICAgICAgICB0b0JlKCd1c2VyJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlID0gWyckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbiAoJGludGVycG9sYXRlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gc2NlbmFyaW8gcnVubmVyCiAgICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLm5nQmluZFRlbXBsYXRlKSk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGludGVycG9sYXRlRm4pOwogICAgICAgICAgICBhdHRyLiRvYnNlcnZlKCduZ0JpbmRUZW1wbGF0ZScsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfV07CgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmluZEh0bWwKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBiaW5kaW5nIHRoYXQgd2lsbCBpbm5lckhUTUwgdGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBgZXhwcmVzc2lvbmAgaW50byB0aGUgY3VycmVudAogICAgICogZWxlbWVudCBpbiBhIHNlY3VyZSB3YXkuICBCeSBkZWZhdWx0LCB0aGUgaW5uZXJIVE1MLWVkIGNvbnRlbnQgd2lsbCBiZSBzYW5pdGl6ZWQgdXNpbmcgdGhlIHtAbGluawogICAgICogbmdTYW5pdGl6ZS4kc2FuaXRpemUgJHNhbml0aXplfSBzZXJ2aWNlLiAgVG8gdXRpbGl6ZSB0aGlzIGZ1bmN0aW9uYWxpdHksIGVuc3VyZSB0aGF0IGAkc2FuaXRpemVgCiAgICAgKiBpcyBhdmFpbGFibGUsIGZvciBleGFtcGxlLCBieSBpbmNsdWRpbmcge0BsaW5rIG5nU2FuaXRpemV9IGluIHlvdXIgbW9kdWxlJ3MgZGVwZW5kZW5jaWVzIChub3QgaW4KICAgICAqIGNvcmUgQW5ndWxhci4pICBZb3UgbWF5IGFsc28gYnlwYXNzIHNhbml0aXphdGlvbiBmb3IgdmFsdWVzIHlvdSBrbm93IGFyZSBzYWZlLiBUbyBkbyBzbywgYmluZCB0bwogICAgICogYW4gZXhwbGljaXRseSB0cnVzdGVkIHZhbHVlIHZpYSB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzSHRtbCAkc2NlLnRydXN0QXNIdG1sfS4gIFNlZSB0aGUgZXhhbXBsZQogICAgICogdW5kZXIge0BsaW5rIG5nLiRzY2UjRXhhbXBsZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0uCiAgICAgKgogICAgICogTm90ZTogSWYgYSBgJHNhbml0aXplYCBzZXJ2aWNlIGlzIHVuYXZhaWxhYmxlIGFuZCB0aGUgYm91bmQgdmFsdWUgaXNuJ3QgZXhwbGljaXRseSB0cnVzdGVkLCB5b3UKICAgICAqIHdpbGwgaGF2ZSBhbiBleGNlcHRpb24gKGluc3RlYWQgb2YgYW4gZXhwbG9pdC4pCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZEh0bWwge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUuCiAgICAgKi8KICAgIHZhciBuZ0JpbmRIdG1sRGlyZWN0aXZlID0gWyckc2NlJywgZnVuY3Rpb24gKCRzY2UpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kSHRtbCk7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZEh0bWwsIGZ1bmN0aW9uIG5nQmluZEh0bWxXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKCRzY2UuZ2V0VHJ1c3RlZEh0bWwodmFsdWUpIHx8ICcnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH1dOwoKICAgIGZ1bmN0aW9uIGNsYXNzRGlyZWN0aXZlKG5hbWUsIHNlbGVjdG9yKSB7CiAgICAgICAgbmFtZSA9ICduZ0NsYXNzJyArIG5hbWU7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnQUMnLAogICAgICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9sZFZhbCA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJbbmFtZV0sIG5nQ2xhc3NXYXRjaEFjdGlvbiwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgIGF0dHIuJG9ic2VydmUoJ2NsYXNzJywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5nQ2xhc3NXYXRjaEFjdGlvbihzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgoKICAgICAgICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gJ25nQ2xhc3MnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgnJGluZGV4JywgZnVuY3Rpb24gKCRpbmRleCwgb2xkJGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kID0gJGluZGV4ICYgMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2QgIT09IG9sZCRpbmRleCAmIDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kID09PSBzZWxlY3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3Moc2NvcGUuJGV2YWwoYXR0cltuYW1lXSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gbmdDbGFzc1dhdGNoQWN0aW9uKG5ld1ZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0b3IgPT09IHRydWUgfHwgc2NvcGUuJGluZGV4ICUgMiA9PT0gc2VsZWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWwgJiYgIWVxdWFscyhuZXdWYWwsIG9sZFZhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhvbGRWYWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkQ2xhc3MobmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBvbGRWYWwgPSBjb3B5KG5ld1ZhbCk7CiAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlQ2xhc3MoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kcmVtb3ZlQ2xhc3MoZmxhdHRlbkNsYXNzZXMoY2xhc3NWYWwpKTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBhZGRDbGFzcyhjbGFzc1ZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRhZGRDbGFzcyhmbGF0dGVuQ2xhc3NlcyhjbGFzc1ZhbCkpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZmxhdHRlbkNsYXNzZXMoY2xhc3NWYWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoY2xhc3NWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2xhc3NWYWwuam9pbignICcpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KGNsYXNzVmFsKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNsYXNzZXMgPSBbXSwgaSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKGNsYXNzVmFsLCBmdW5jdGlvbiAodiwgaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzZXMucHVzaChrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjbGFzc2VzLmpvaW4oJyAnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsYXNzVmFsOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xhc3NgIGFsbG93cyB5b3UgdG8gc2V0IENTUyBjbGFzc2VzIG9uIEhUTUwgYW4gZWxlbWVudCwgZHluYW1pY2FsbHksIGJ5IGRhdGFiaW5kaW5nCiAgICAgKiBhbiBleHByZXNzaW9uIHRoYXQgcmVwcmVzZW50cyBhbGwgY2xhc3NlcyB0byBiZSBhZGRlZC4KICAgICAqCiAgICAgKiBUaGUgZGlyZWN0aXZlIHdvbid0IGFkZCBkdXBsaWNhdGUgY2xhc3NlcyBpZiBhIHBhcnRpY3VsYXIgY2xhc3Mgd2FzIGFscmVhZHkgc2V0LgogICAgICoKICAgICAqIFdoZW4gdGhlIGV4cHJlc3Npb24gY2hhbmdlcywgdGhlIHByZXZpb3VzbHkgYWRkZWQgY2xhc3NlcyBhcmUgcmVtb3ZlZCBhbmQgb25seSB0aGVuIHRoZQogICAgICogbmV3IGNsYXNzZXMgYXJlIGFkZGVkLgogICAgICoKICAgICAqIEBhbmltYXRpb25zCiAgICAgKiBhZGQgLSBoYXBwZW5zIGp1c3QgYmVmb3JlIHRoZSBjbGFzcyBpcyBhcHBsaWVkIHRvIHRoZSBlbGVtZW50CiAgICAgKiByZW1vdmUgLSBoYXBwZW5zIGp1c3QgYmVmb3JlIHRoZSBjbGFzcyBpcyByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUgcmVzdWx0CiAgICAgKiAgIG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzCiAgICAgKiAgIG5hbWVzLCBhbiBhcnJheSwgb3IgYSBtYXAgb2YgY2xhc3MgbmFtZXMgdG8gYm9vbGVhbiB2YWx1ZXMuIEluIHRoZSBjYXNlIG9mIGEgbWFwLCB0aGUKICAgICAqICAgbmFtZXMgb2YgdGhlIHByb3BlcnRpZXMgd2hvc2UgdmFsdWVzIGFyZSB0cnV0aHkgd2lsbCBiZSBhZGRlZCBhcyBjc3MgY2xhc3NlcyB0byB0aGUKICAgICAqICAgZWxlbWVudC4KICAgICAqCiAgICAgKiBAZXhhbXBsZSBFeGFtcGxlIHRoYXQgZGVtb3N0cmF0ZXMgYmFzaWMgYmluZGluZ3MgdmlhIG5nQ2xhc3MgZGlyZWN0aXZlLgogICAgICAgPGV4YW1wbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICAgIDxwIG5nLWNsYXNzPSJ7c3RyaWtlOiBzdHJpa2UsIGJvbGQ6IGJvbGQsIHJlZDogcmVkfSI+TWFwIFN5bnRheCBFeGFtcGxlPC9wPgogICAgICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImJvbGQiPiBib2xkCiAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ic3RyaWtlIj4gc3RyaWtlCiAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0icmVkIj4gcmVkCiAgICAgICAgICAgPGhyPgogICAgICAgICAgIDxwIG5nLWNsYXNzPSJzdHlsZSI+VXNpbmcgU3RyaW5nIFN5bnRheDwvcD4KICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InN0eWxlIiBwbGFjZWhvbGRlcj0iVHlwZTogYm9sZCBzdHJpa2UgcmVkIj4KICAgICAgICAgICA8aHI+CiAgICAgICAgICAgPHAgbmctY2xhc3M9IltzdHlsZTEsIHN0eWxlMiwgc3R5bGUzXSI+VXNpbmcgQXJyYXkgU3ludGF4PC9wPgogICAgICAgICAgIDxpbnB1dCBuZy1tb2RlbD0ic3R5bGUxIiBwbGFjZWhvbGRlcj0iVHlwZTogYm9sZCI+PGJyPgogICAgICAgICAgIDxpbnB1dCBuZy1tb2RlbD0ic3R5bGUyIiBwbGFjZWhvbGRlcj0iVHlwZTogc3RyaWtlIj48YnI+CiAgICAgICAgICAgPGlucHV0IG5nLW1vZGVsPSJzdHlsZTMiIHBsYWNlaG9sZGVyPSJUeXBlOiByZWQiPjxicj4KICAgICAgICAgPC9maWxlPgogICAgICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgICAgIC5zdHJpa2UgewogICAgICAgICAgICAgdGV4dC1kZWNvcmF0aW9uOiBsaW5lLXRocm91Z2g7CiAgICAgICAgICAgfQogICAgICAgICAgIC5ib2xkIHsKICAgICAgICAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgICAgICAgfQogICAgICAgICAgIC5yZWQgewogICAgICAgICAgICAgICBjb2xvcjogcmVkOwogICAgICAgICAgIH0KICAgICAgICAgPC9maWxlPgogICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBsZXQgeW91IHRvZ2dsZSB0aGUgY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgIAogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHA6Zmlyc3QnKS5wcm9wKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvYm9sZC8pOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHA6Zmlyc3QnKS5wcm9wKCdjbGFzc05hbWUnKSkubm90KCkudG9NYXRjaCgvcmVkLyk7CiAgICAKICAgICAgICAgICAgIGlucHV0KCdib2xkJykuY2hlY2soKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBwOmZpcnN0JykucHJvcCgnY2xhc3NOYW1lJykpLnRvTWF0Y2goL2JvbGQvKTsKICAgIAogICAgICAgICAgICAgaW5wdXQoJ3JlZCcpLmNoZWNrKCk7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgcDpmaXJzdCcpLnByb3AoJ2NsYXNzTmFtZScpKS50b01hdGNoKC9yZWQvKTsKICAgICAgICAgICB9KTsKICAgIAogICAgICAgICAgIGl0KCdzaG91bGQgbGV0IHlvdSB0b2dnbGUgc3RyaW5nIGV4YW1wbGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBwOm50aC1vZi10eXBlKDIpJykucHJvcCgnY2xhc3NOYW1lJykpLnRvQmUoJycpOwogICAgICAgICAgICAgaW5wdXQoJ3N0eWxlJykuZW50ZXIoJ3JlZCcpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHA6bnRoLW9mLXR5cGUoMiknKS5wcm9wKCdjbGFzc05hbWUnKSkudG9CZSgncmVkJyk7CiAgICAgICAgICAgfSk7CiAgICAKICAgICAgICAgICBpdCgnYXJyYXkgZXhhbXBsZSBzaG91bGQgaGF2ZSAzIGNsYXNzZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBwOmxhc3QnKS5wcm9wKCdjbGFzc05hbWUnKSkudG9CZSgnJyk7CiAgICAgICAgICAgICBpbnB1dCgnc3R5bGUxJykuZW50ZXIoJ2JvbGQnKTsKICAgICAgICAgICAgIGlucHV0KCdzdHlsZTInKS5lbnRlcignc3RyaWtlJyk7CiAgICAgICAgICAgICBpbnB1dCgnc3R5bGUzJykuZW50ZXIoJ3JlZCcpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHA6bGFzdCcpLnByb3AoJ2NsYXNzTmFtZScpKS50b0JlKCdib2xkIHN0cmlrZSByZWQnKTsKICAgICAgICAgICB9KTsKICAgICAgICAgPC9maWxlPgogICAgICAgPC9leGFtcGxlPgogICAgCiAgICAgICAjIyBBbmltYXRpb25zCiAgICAKICAgICAgIFRoZSBleGFtcGxlIGJlbG93IGRlbW9uc3RyYXRlcyBob3cgdG8gcGVyZm9ybSBhbmltYXRpb25zIHVzaW5nIG5nQ2xhc3MuCiAgICAKICAgICAgIDxleGFtcGxlIGFuaW1hdGlvbnM9InRydWUiPgogICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nLWNsaWNrPSJteVZhcj0nbXktY2xhc3MnIj4KICAgICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmctY2xpY2s9Im15VmFyPScnIj4KICAgICAgICAgIDxicj4KICAgICAgICAgIDxzcGFuIG5nLWNsYXNzPSJteVZhciI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgICAgICAgIDwvZmlsZT4KICAgICAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgICAgICAubXktY2xhc3MtYWRkLCAubXktY2xhc3MtcmVtb3ZlIHsKICAgICAgICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgICAgICAgLW1vei10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgICAtby10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgICB0cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgfQogICAgCiAgICAgICAgICAgLm15LWNsYXNzLAogICAgICAgICAgIC5teS1jbGFzcy1hZGQubXktY2xhc3MtYWRkLWFjdGl2ZSB7CiAgICAgICAgICAgICBjb2xvcjogcmVkOwogICAgICAgICAgICAgZm9udC1zaXplOjNlbTsKICAgICAgICAgICB9CiAgICAKICAgICAgICAgICAubXktY2xhc3MtcmVtb3ZlLm15LWNsYXNzLXJlbW92ZS1hY3RpdmUgewogICAgICAgICAgICAgZm9udC1zaXplOjEuMGVtOwogICAgICAgICAgICAgY29sb3I6YmxhY2s7CiAgICAgICAgICAgfQogICAgICAgICA8L2ZpbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsYXNzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS5ub3QoKS4KICAgICAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKICAgIAogICAgICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuZWxlbWVudCgnOmJ1dHRvbjpmaXJzdCcpLmNsaWNrKCk7CiAgICAKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwogICAgCiAgICAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5lbGVtZW50KCc6YnV0dG9uOmxhc3QnKS5jbGljaygpOwogICAgCiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS5ub3QoKS4KICAgICAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKICAgICAgICAgICB9KTsKICAgICAgICAgPC9maWxlPgogICAgICAgPC9leGFtcGxlPgogICAgCiAgICAKICAgICAgICMjIG5nQ2xhc3MgYW5kIHByZS1leGlzdGluZyBDU1MzIFRyYW5zaXRpb25zL0FuaW1hdGlvbnMKICAgICAgIFRoZSBuZ0NsYXNzIGRpcmVjdGl2ZSBzdGlsbCBzdXBwb3J0cyBDU1MzIFRyYW5zaXRpb25zL0FuaW1hdGlvbnMgZXZlbiBpZiB0aGV5IGRvIG5vdCBmb2xsb3cgdGhlIG5nQW5pbWF0ZSBDU1MgbmFtaW5nIHN0cnVjdHVyZS4KICAgICAgIFRoZXJlZm9yZSwgaWYgYW55IENTUzMgVHJhbnNpdGlvbi9BbmltYXRpb24gc3R5bGVzIChvdXRzaWRlIG9mIG5nQW5pbWF0ZSkgYXJlIHNldCBvbiB0aGUgZWxlbWVudCwgdGhlbiwgaWYgYSBuZ0NsYXNzIGFuaW1hdGlvbgogICAgICAgaXMgdHJpZ2dlcmVkLCB0aGUgbmdDbGFzcyBhbmltYXRpb24gd2lsbCBiZSBza2lwcGVkIHNvIHRoYXQgbmdBbmltYXRlIGNhbiBhbGxvdyBmb3IgdGhlIHByZS1leGlzdGluZyB0cmFuc2l0aW9uIG9yIGFuaW1hdGlvbiB0bwogICAgICAgdGFrZSBvdmVyLiBUaGlzIHJlc3RyaWN0aW9uIGFsbG93cyBmb3IgbmdDbGFzcyB0byBzdGlsbCB3b3JrIHdpdGggc3RhbmRhcmQgQ1NTMyBUcmFuc2l0aW9ucy9BbmltYXRpb25zIHRoYXQgYXJlIGRlZmluZWQKICAgICAgIG91dHNpZGUgb2YgbmdBbmltYXRlLgogICAgICovCiAgICB2YXIgbmdDbGFzc0RpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCcnLCB0cnVlKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzT2RkCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nQ2xhc3NPZGRgIGFuZCBgbmdDbGFzc0V2ZW5gIGRpcmVjdGl2ZXMgd29yayBleGFjdGx5IGFzCiAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xhc3MgbmdDbGFzc30sIGV4Y2VwdCBpdCB3b3JrcyBpbgogICAgICogY29uanVuY3Rpb24gd2l0aCBgbmdSZXBlYXRgIGFuZCB0YWtlcyBhZmZlY3Qgb25seSBvbiBvZGQgKGV2ZW4pIHJvd3MuCiAgICAgKgogICAgICogVGhpcyBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgb25seSB3aXRoaW4gYSBzY29wZSBvZiBhbgogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0uCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xhc3NPZGQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gVGhlIHJlc3VsdAogICAgICogICBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcyBuYW1lcyBvciBhbiBhcnJheS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICAgPGV4YW1wbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICAgICA8b2wgbmctaW5pdD0ibmFtZXM9WydKb2huJywgJ01hcnknLCAnQ2F0ZScsICdTdXonXSI+CiAgICAgICAgICAgICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgICAgICAgICAgICAgIDxzcGFuIG5nLWNsYXNzLW9kZD0iJ29kZCciIG5nLWNsYXNzLWV2ZW49IidldmVuJyI+CiAgICAgICAgICAgICAgICAge3tuYW1lfX0KICAgICAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgICAgIDwvbGk+CiAgICAgICAgICAgIDwvb2w+CiAgICAgICAgIDwvZmlsZT4KICAgICAgICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgICAgICAgICAub2RkIHsKICAgICAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICAgICAgfQogICAgICAgICAgIC5ldmVuIHsKICAgICAgICAgICAgIGNvbG9yOiBibHVlOwogICAgICAgICAgIH0KICAgICAgICAgPC9maWxlPgogICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGFzcy1vZGQgYW5kIG5nLWNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpmaXJzdCBzcGFuJykucHJvcCgnY2xhc3NOYW1lJykpLgogICAgICAgICAgICAgICB0b01hdGNoKC9vZGQvKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBsaTpsYXN0IHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgICAgIHRvTWF0Y2goL2V2ZW4vKTsKICAgICAgICAgICB9KTsKICAgICAgICAgPC9maWxlPgogICAgICAgPC9leGFtcGxlPgogICAgICovCiAgICB2YXIgbmdDbGFzc09kZERpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCdPZGQnLCAwKTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzRXZlbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0NsYXNzT2RkYCBhbmQgYG5nQ2xhc3NFdmVuYCBkaXJlY3RpdmVzIHdvcmsgZXhhY3RseSBhcwogICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzIG5nQ2xhc3N9LCBleGNlcHQgaXQgd29ya3MgaW4KICAgICAqIGNvbmp1bmN0aW9uIHdpdGggYG5nUmVwZWF0YCBhbmQgdGFrZXMgYWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogICAgICoKICAgICAqIFRoaXMgZGlyZWN0aXZlIGNhbiBiZSBhcHBsaWVkIG9ubHkgd2l0aGluIGEgc2NvcGUgb2YgYW4KICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzRXZlbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUKICAgICAqICAgcmVzdWx0IG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzIG5hbWVzIG9yIGFuIGFycmF5LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICA8ZXhhbXBsZT4KICAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICAgIDxvbCBuZy1pbml0PSJuYW1lcz1bJ0pvaG4nLCAnTWFyeScsICdDYXRlJywgJ1N1eiddIj4KICAgICAgICAgICAgICA8bGkgbmctcmVwZWF0PSJuYW1lIGluIG5hbWVzIj4KICAgICAgICAgICAgICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAgICAgICAgICAgICAgICB7e25hbWV9fSAmbmJzcDsgJm5ic3A7ICZuYnNwOwogICAgICAgICAgICAgICA8L3NwYW4+CiAgICAgICAgICAgICAgPC9saT4KICAgICAgICAgICAgPC9vbD4KICAgICAgICAgPC9maWxlPgogICAgICAgICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAgICAgICAgIC5vZGQgewogICAgICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgICAgICB9CiAgICAgICAgICAgLmV2ZW4gewogICAgICAgICAgICAgY29sb3I6IGJsdWU7CiAgICAgICAgICAgfQogICAgICAgICA8L2ZpbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsYXNzLW9kZCBhbmQgbmctY2xhc3MtZXZlbicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmZpcnN0IHNwYW4nKS5wcm9wKCdjbGFzc05hbWUnKSkuCiAgICAgICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIGxpOmxhc3Qgc3BhbicpLnByb3AoJ2NsYXNzTmFtZScpKS4KICAgICAgICAgICAgICAgdG9NYXRjaCgvZXZlbi8pOwogICAgICAgICAgIH0pOwogICAgICAgICA8L2ZpbGU+CiAgICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSA9IGNsYXNzRGlyZWN0aXZlKCdFdmVuJywgMSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbG9hawogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgaXMgdXNlZCB0byBwcmV2ZW50IHRoZSBBbmd1bGFyIGh0bWwgdGVtcGxhdGUgZnJvbSBiZWluZyBicmllZmx5CiAgICAgKiBkaXNwbGF5ZWQgYnkgdGhlIGJyb3dzZXIgaW4gaXRzIHJhdyAodW5jb21waWxlZCkgZm9ybSB3aGlsZSB5b3VyIGFwcGxpY2F0aW9uIGlzIGxvYWRpbmcuIFVzZSB0aGlzCiAgICAgKiBkaXJlY3RpdmUgdG8gYXZvaWQgdGhlIHVuZGVzaXJhYmxlIGZsaWNrZXIgZWZmZWN0IGNhdXNlZCBieSB0aGUgaHRtbCB0ZW1wbGF0ZSBkaXNwbGF5LgogICAgICoKICAgICAqIFRoZSBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgdG8gdGhlIGA8Ym9keT5gIGVsZW1lbnQsIGJ1dCB0eXBpY2FsbHkgYSBmaW5lLWdyYWluZWQgYXBwbGljYXRpb24gaXMKICAgICAqIHByZWZlcnJlZCBpbiBvcmRlciB0byBiZW5lZml0IGZyb20gcHJvZ3Jlc3NpdmUgcmVuZGVyaW5nIG9mIHRoZSBicm93c2VyIHZpZXcuCiAgICAgKgogICAgICogYG5nQ2xvYWtgIHdvcmtzIGluIGNvb3BlcmF0aW9uIHdpdGggYSBjc3MgcnVsZSB0aGF0IGlzIGVtYmVkZGVkIHdpdGhpbiBgYW5ndWxhci5qc2AgYW5kCiAgICAgKiAgYGFuZ3VsYXIubWluLmpzYCBmaWxlcy4gRm9sbG93aW5nIGlzIHRoZSBjc3MgcnVsZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogW25nXDpjbG9ha10sIFtuZy1jbG9ha10sIFtkYXRhLW5nLWNsb2FrXSwgW3gtbmctY2xvYWtdLCAubmctY2xvYWssIC54LW5nLWNsb2FrIHsKICAgICAqICAgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OwogICAgICogfQogICAgICogPC9wcmU+CiAgICAgKgogICAgICogV2hlbiB0aGlzIGNzcyBydWxlIGlzIGxvYWRlZCBieSB0aGUgYnJvd3NlciwgYWxsIGh0bWwgZWxlbWVudHMgKGluY2x1ZGluZyB0aGVpciBjaGlsZHJlbikgdGhhdAogICAgICogYXJlIHRhZ2dlZCB3aXRoIHRoZSBgbmctY2xvYWtgIGRpcmVjdGl2ZSBhcmUgaGlkZGVuLiBXaGVuIEFuZ3VsYXIgY29tZXMgYWNyb3NzIHRoaXMgZGlyZWN0aXZlCiAgICAgKiBkdXJpbmcgdGhlIGNvbXBpbGF0aW9uIG9mIHRoZSB0ZW1wbGF0ZSBpdCBkZWxldGVzIHRoZSBgbmdDbG9ha2AgZWxlbWVudCBhdHRyaWJ1dGUsIHdoaWNoCiAgICAgKiBtYWtlcyB0aGUgY29tcGlsZWQgZWxlbWVudCB2aXNpYmxlLgogICAgICoKICAgICAqIEZvciB0aGUgYmVzdCByZXN1bHQsIGBhbmd1bGFyLmpzYCBzY3JpcHQgbXVzdCBiZSBsb2FkZWQgaW4gdGhlIGhlYWQgc2VjdGlvbiBvZiB0aGUgaHRtbCBmaWxlOwogICAgICogYWx0ZXJuYXRpdmVseSwgdGhlIGNzcyBydWxlIChhYm92ZSkgbXVzdCBiZSBpbmNsdWRlZCBpbiB0aGUgZXh0ZXJuYWwgc3R5bGVzaGVldCBvZiB0aGUKICAgICAqIGFwcGxpY2F0aW9uLgogICAgICoKICAgICAqIExlZ2FjeSBicm93c2VycywgbGlrZSBJRTcsIGRvIG5vdCBwcm92aWRlIGF0dHJpYnV0ZSBzZWxlY3RvciBzdXBwb3J0IChhZGRlZCBpbiBDU1MgMi4xKSBzbyB0aGV5CiAgICAgKiBjYW5ub3QgbWF0Y2ggdGhlIGBbbmdcOmNsb2FrXWAgc2VsZWN0b3IuIFRvIHdvcmsgYXJvdW5kIHRoaXMgbGltaXRhdGlvbiwgeW91IG11c3QgYWRkIHRoZSBjc3MKICAgICAqIGNsYXNzIGBuZ0Nsb2FrYCBpbiBhZGRpdGlvbiB0byBgbmdDbG9ha2AgZGlyZWN0aXZlIGFzIHNob3duIGluIHRoZSBleGFtcGxlIGJlbG93LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICA8ZGl2IGlkPSJ0ZW1wbGF0ZTEiIG5nLWNsb2FrPnt7ICdoZWxsbycgfX08L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0idGVtcGxhdGUyIiBuZy1jbG9hayBjbGFzcz0ibmctY2xvYWsiPnt7ICdoZWxsbyBJRTcnIH19PC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIHJlbW92ZSB0aGUgdGVtcGxhdGUgZGlyZWN0aXZlIGFuZCBjc3MgY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjdGVtcGxhdGUxJykuYXR0cignbmctY2xvYWsnKSkuCiAgICAgICAgICAgICAgIG5vdCgpLnRvQmVEZWZpbmVkKCk7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgI3RlbXBsYXRlMicpLmF0dHIoJ25nLWNsb2FrJykpLgogICAgICAgICAgICAgICBub3QoKS50b0JlRGVmaW5lZCgpOwogICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKgogICAgICovCiAgICB2YXIgbmdDbG9ha0RpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICBhdHRyLiRzZXQoJ25nQ2xvYWsnLCB1bmRlZmluZWQpOwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKCduZy1jbG9haycpOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ29udHJvbGxlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ0NvbnRyb2xsZXJgIGRpcmVjdGl2ZSBhc3NpZ25zIGJlaGF2aW9yIHRvIGEgc2NvcGUuIFRoaXMgaXMgYSBrZXkgYXNwZWN0IG9mIGhvdyBhbmd1bGFyCiAgICAgKiBzdXBwb3J0cyB0aGUgcHJpbmNpcGxlcyBiZWhpbmQgdGhlIE1vZGVsLVZpZXctQ29udHJvbGxlciBkZXNpZ24gcGF0dGVybi4KICAgICAqCiAgICAgKiBNVkMgY29tcG9uZW50cyBpbiBhbmd1bGFyOgogICAgICoKICAgICAqICogTW9kZWwg4oCUIFRoZSBNb2RlbCBpcyBkYXRhIGluIHNjb3BlIHByb3BlcnRpZXM7IHNjb3BlcyBhcmUgYXR0YWNoZWQgdG8gdGhlIERPTS4KICAgICAqICogVmlldyDigJQgVGhlIHRlbXBsYXRlIChIVE1MIHdpdGggZGF0YSBiaW5kaW5ncykgaXMgcmVuZGVyZWQgaW50byB0aGUgVmlldy4KICAgICAqICogQ29udHJvbGxlciDigJQgVGhlIGBuZ0NvbnRyb2xsZXJgIGRpcmVjdGl2ZSBzcGVjaWZpZXMgYSBDb250cm9sbGVyIGNsYXNzOyB0aGUgY2xhc3MgaGFzCiAgICAgKiAgIG1ldGhvZHMgdGhhdCB0eXBpY2FsbHkgZXhwcmVzcyB0aGUgYnVzaW5lc3MgbG9naWMgYmVoaW5kIHRoZSBhcHBsaWNhdGlvbi4KICAgICAqCiAgICAgKiBOb3RlIHRoYXQgYW4gYWx0ZXJuYXRpdmUgd2F5IHRvIGRlZmluZSBjb250cm9sbGVycyBpcyB2aWEgdGhlIHtAbGluayBuZ1JvdXRlLiRyb3V0ZSAkcm91dGV9IHNlcnZpY2UuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAc2NvcGUKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDb250cm9sbGVyIE5hbWUgb2YgYSBnbG9iYWxseSBhY2Nlc3NpYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIG9yIGFuCiAgICAgKiAgICAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gdGhhdCBvbiB0aGUgY3VycmVudCBzY29wZSBldmFsdWF0ZXMgdG8gYQogICAgICogICAgIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBUaGUgY29udHJvbGxlciBpbnN0YW5jZSBjYW4gZnVydGhlciBiZSBwdWJsaXNoZWQgaW50byB0aGUgc2NvcGUKICAgICAqICAgICBieSBhZGRpbmcgYGFzIGxvY2FsTmFtZWAgdGhlIGNvbnRyb2xsZXIgbmFtZSBhdHRyaWJ1dGUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEhlcmUgaXMgYSBzaW1wbGUgZm9ybSBmb3IgZWRpdGluZyB1c2VyIGNvbnRhY3QgaW5mb3JtYXRpb24uIEFkZGluZywgcmVtb3ZpbmcsIGNsZWFyaW5nLCBhbmQKICAgICAqIGdyZWV0aW5nIGFyZSBtZXRob2RzIGRlY2xhcmVkIG9uIHRoZSBjb250cm9sbGVyIChzZWUgc291cmNlIHRhYikuIFRoZXNlIG1ldGhvZHMgY2FuCiAgICAgKiBlYXNpbHkgYmUgY2FsbGVkIGZyb20gdGhlIGFuZ3VsYXIgbWFya3VwLiBOb3RpY2UgdGhhdCB0aGUgc2NvcGUgYmVjb21lcyB0aGUgYHRoaXNgIGZvciB0aGUKICAgICAqIGNvbnRyb2xsZXIncyBpbnN0YW5jZS4gVGhpcyBhbGxvd3MgZm9yIGVhc3kgYWNjZXNzIHRvIHRoZSB2aWV3IGRhdGEgZnJvbSB0aGUgY29udHJvbGxlci4gQWxzbwogICAgICogbm90aWNlIHRoYXQgYW55IGNoYW5nZXMgdG8gdGhlIGRhdGEgYXJlIGF1dG9tYXRpY2FsbHkgcmVmbGVjdGVkIGluIHRoZSBWaWV3IHdpdGhvdXQgdGhlIG5lZWQKICAgICAqIGZvciBhIG1hbnVhbCB1cGRhdGUuIFRoZSBleGFtcGxlIGlzIGluY2x1ZGVkIGluIHR3byBkaWZmZXJlbnQgZGVjbGFyYXRpb24gc3R5bGVzIGJhc2VkIG9uCiAgICAgKiB5b3VyIHN0eWxlIHByZWZlcmVuY2VzLgogICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgIGZ1bmN0aW9uIFNldHRpbmdzQ29udHJvbGxlcjEoKSB7CiAgICAgICAgICAgICAgdGhpcy5uYW1lID0gIkpvaG4gU21pdGgiOwogICAgICAgICAgICAgIHRoaXMuY29udGFjdHMgPSBbCiAgICAgICAgICAgICAgICB7dHlwZTogJ3Bob25lJywgdmFsdWU6ICc0MDggNTU1IDEyMTInfSwKICAgICAgICAgICAgICAgIHt0eXBlOiAnZW1haWwnLCB2YWx1ZTogJ2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnfSBdOwogICAgICAgICAgICAgIH07CiAgICAKICAgICAgICAgICAgU2V0dGluZ3NDb250cm9sbGVyMS5wcm90b3R5cGUuZ3JlZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBhbGVydCh0aGlzLm5hbWUpOwogICAgICAgICAgICB9OwogICAgCiAgICAgICAgICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aGlzLmNvbnRhY3RzLnB1c2goe3R5cGU6ICdlbWFpbCcsIHZhbHVlOiAneW91cm5hbWVAZXhhbXBsZS5vcmcnfSk7CiAgICAgICAgICAgIH07CiAgICAKICAgICAgICAgICAgU2V0dGluZ3NDb250cm9sbGVyMS5wcm90b3R5cGUucmVtb3ZlQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3RUb1JlbW92ZSkgewogICAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb250YWN0cy5pbmRleE9mKGNvbnRhY3RUb1JlbW92ZSk7CiAgICAgICAgICAgICAgdGhpcy5jb250YWN0cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICB9OwogICAgCiAgICAgICAgICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICAgICAgICAgICAgICBjb250YWN0LnR5cGUgPSAncGhvbmUnOwogICAgICAgICAgICAgIGNvbnRhY3QudmFsdWUgPSAnJzsKICAgICAgICAgICAgfTsKICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgPGRpdiBpZD0iY3RybC1hcy1leG1wbCIgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyMSBhcyBzZXR0aW5ncyI+CiAgICAgICAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ic2V0dGluZ3MubmFtZSIvPgogICAgICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLmdyZWV0KCkiPmdyZWV0PC9hPiBdPGJyLz4KICAgICAgICAgICAgQ29udGFjdDoKICAgICAgICAgICAgPHVsPgogICAgICAgICAgICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gc2V0dGluZ3MuY29udGFjdHMiPgogICAgICAgICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29udGFjdC50eXBlIj4KICAgICAgICAgICAgICAgICAgIDxvcHRpb24+cGhvbmU8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgIDxvcHRpb24+ZW1haWw8L29wdGlvbj4KICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJjb250YWN0LnZhbHVlIi8+CiAgICAgICAgICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLmNsZWFyQ29udGFjdChjb250YWN0KSI+Y2xlYXI8L2E+CiAgICAgICAgICAgICAgICB8IDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLnJlbW92ZUNvbnRhY3QoY29udGFjdCkiPlg8L2E+IF0KICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgIDxsaT5bIDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLmFkZENvbnRhY3QoKSI+YWRkPC9hPiBdPC9saT4KICAgICAgICAgICA8L3VsPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIGNvbnRyb2xsZXIgYXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjY3RybC1hcy1leG1wbD46aW5wdXQnKS52YWwoKSkudG9CZSgnSm9obiBTbWl0aCcpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNjdHJsLWFzLWV4bXBsIGxpOm50aC1jaGlsZCgxKSBpbnB1dCcpLnZhbCgpKQogICAgICAgICAgICAgICAudG9CZSgnNDA4IDU1NSAxMjEyJyk7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2N0cmwtYXMtZXhtcGwgbGk6bnRoLWNoaWxkKDIpIGlucHV0JykudmFsKCkpCiAgICAgICAgICAgICAgIC50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CiAgICAKICAgICAgICAgICAgIGVsZW1lbnQoJyNjdHJsLWFzLWV4bXBsIGxpOmZpcnN0IGE6Y29udGFpbnMoImNsZWFyIiknKS5jbGljaygpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNjdHJsLWFzLWV4bXBsIGxpOmZpcnN0IGlucHV0JykudmFsKCkpLnRvQmUoJycpOwogICAgCiAgICAgICAgICAgICBlbGVtZW50KCcjY3RybC1hcy1leG1wbCBsaTpsYXN0IGE6Y29udGFpbnMoImFkZCIpJykuY2xpY2soKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjY3RybC1hcy1leG1wbCBsaTpudGgtY2hpbGQoMykgaW5wdXQnKS52YWwoKSkKICAgICAgICAgICAgICAgLnRvQmUoJ3lvdXJuYW1lQGV4YW1wbGUub3JnJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgZnVuY3Rpb24gU2V0dGluZ3NDb250cm9sbGVyMigkc2NvcGUpIHsKICAgICAgICAgICAgICAkc2NvcGUubmFtZSA9ICJKb2huIFNtaXRoIjsKICAgICAgICAgICAgICAkc2NvcGUuY29udGFjdHMgPSBbCiAgICAgICAgICAgICAgICB7dHlwZToncGhvbmUnLCB2YWx1ZTonNDA4IDU1NSAxMjEyJ30sCiAgICAgICAgICAgICAgICB7dHlwZTonZW1haWwnLCB2YWx1ZTonam9obi5zbWl0aEBleGFtcGxlLm9yZyd9IF07CiAgICAKICAgICAgICAgICAgICAkc2NvcGUuZ3JlZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgYWxlcnQodGhpcy5uYW1lKTsKICAgICAgICAgICAgICB9OwogICAgCiAgICAgICAgICAgICAgJHNjb3BlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgdGhpcy5jb250YWN0cy5wdXNoKHt0eXBlOidlbWFpbCcsIHZhbHVlOid5b3VybmFtZUBleGFtcGxlLm9yZyd9KTsKICAgICAgICAgICAgICB9OwogICAgCiAgICAgICAgICAgICAgJHNjb3BlLnJlbW92ZUNvbnRhY3QgPSBmdW5jdGlvbihjb250YWN0VG9SZW1vdmUpIHsKICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb250YWN0cy5pbmRleE9mKGNvbnRhY3RUb1JlbW92ZSk7CiAgICAgICAgICAgICAgIHRoaXMuY29udGFjdHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgICB9OwogICAgCiAgICAgICAgICAgICAgJHNjb3BlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICAgICAgICAgICAgICAgY29udGFjdC50eXBlID0gJ3Bob25lJzsKICAgICAgICAgICAgICAgY29udGFjdC52YWx1ZSA9ICcnOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgPGRpdiBpZD0iY3RybC1leG1wbCIgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyMiI+CiAgICAgICAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSIvPgogICAgICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9ImdyZWV0KCkiPmdyZWV0PC9hPiBdPGJyLz4KICAgICAgICAgICAgQ29udGFjdDoKICAgICAgICAgICAgPHVsPgogICAgICAgICAgICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gY29udGFjdHMiPgogICAgICAgICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29udGFjdC50eXBlIj4KICAgICAgICAgICAgICAgICAgIDxvcHRpb24+cGhvbmU8L29wdGlvbj4KICAgICAgICAgICAgICAgICAgIDxvcHRpb24+ZW1haWw8L29wdGlvbj4KICAgICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJjb250YWN0LnZhbHVlIi8+CiAgICAgICAgICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9ImNsZWFyQ29udGFjdChjb250YWN0KSI+Y2xlYXI8L2E+CiAgICAgICAgICAgICAgICB8IDxhIGhyZWY9IiIgbmctY2xpY2s9InJlbW92ZUNvbnRhY3QoY29udGFjdCkiPlg8L2E+IF0KICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgIDxsaT5bIDxhIGhyZWY9IiIgbmctY2xpY2s9ImFkZENvbnRhY3QoKSI+YWRkPC9hPiBdPC9saT4KICAgICAgICAgICA8L3VsPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgPGRvYzpzY2VuYXJpbz4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIGNvbnRyb2xsZXInLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjY3RybC1leG1wbD46aW5wdXQnKS52YWwoKSkudG9CZSgnSm9obiBTbWl0aCcpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNjdHJsLWV4bXBsIGxpOm50aC1jaGlsZCgxKSBpbnB1dCcpLnZhbCgpKQogICAgICAgICAgICAgICAudG9CZSgnNDA4IDU1NSAxMjEyJyk7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI2N0cmwtZXhtcGwgbGk6bnRoLWNoaWxkKDIpIGlucHV0JykudmFsKCkpCiAgICAgICAgICAgICAgIC50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CiAgICAKICAgICAgICAgICAgIGVsZW1lbnQoJyNjdHJsLWV4bXBsIGxpOmZpcnN0IGE6Y29udGFpbnMoImNsZWFyIiknKS5jbGljaygpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJyNjdHJsLWV4bXBsIGxpOmZpcnN0IGlucHV0JykudmFsKCkpLnRvQmUoJycpOwogICAgCiAgICAgICAgICAgICBlbGVtZW50KCcjY3RybC1leG1wbCBsaTpsYXN0IGE6Y29udGFpbnMoImFkZCIpJykuY2xpY2soKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcjY3RybC1leG1wbCBsaTpudGgtY2hpbGQoMykgaW5wdXQnKS52YWwoKSkKICAgICAgICAgICAgICAgLnRvQmUoJ3lvdXJuYW1lQGV4YW1wbGUub3JnJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgIAogICAgICovCiAgICB2YXIgbmdDb250cm9sbGVyRGlyZWN0aXZlID0gW2Z1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzY29wZTogdHJ1ZSwKICAgICAgICAgICAgY29udHJvbGxlcjogJ0AnCiAgICAgICAgfTsKICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQ3NwCiAgICAgKiBAcHJpb3JpdHkgMTAwMAogICAgICoKICAgICAqIEBlbGVtZW50IGh0bWwKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRW5hYmxlcyBbQ1NQIChDb250ZW50IFNlY3VyaXR5IFBvbGljeSldKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL1NlY3VyaXR5L0NTUCkgc3VwcG9ydC4KICAgICAqIAogICAgICogVGhpcyBpcyBuZWNlc3Nhcnkgd2hlbiBkZXZlbG9waW5nIHRoaW5ncyBsaWtlIEdvb2dsZSBDaHJvbWUgRXh0ZW5zaW9ucy4KICAgICAqIAogICAgICogQ1NQIGZvcmJpZHMgYXBwcyB0byB1c2UgYGV2YWxgIG9yIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIChhbW9uZyBvdGhlciB0aGluZ3MpLgogICAgICogRm9yIHVzIHRvIGJlIGNvbXBhdGlibGUsIHdlIGp1c3QgbmVlZCB0byBpbXBsZW1lbnQgdGhlICJnZXR0ZXJGbiIgaW4gJHBhcnNlIHdpdGhvdXQgdmlvbGF0aW5nCiAgICAgKiBhbnkgb2YgdGhlc2UgcmVzdHJpY3Rpb25zLgogICAgICogCiAgICAgKiBBbmd1bGFySlMgdXNlcyBgRnVuY3Rpb24oc3RyaW5nKWAgZ2VuZXJhdGVkIGZ1bmN0aW9ucyBhcyBhIHNwZWVkIG9wdGltaXphdGlvbi4gQnkgYXBwbHlpbmcgYG5nQ3NwYAogICAgICogaXQgaXMgYmUgcG9zc2libGUgdG8gb3B0IGludG8gdGhlIENTUCBjb21wYXRpYmxlIG1vZGUuIFdoZW4gdGhpcyBtb2RlIGlzIG9uIEFuZ3VsYXJKUyB3aWxsCiAgICAgKiBldmFsdWF0ZSBhbGwgZXhwcmVzc2lvbnMgdXAgdG8gMzAlIHNsb3dlciB0aGFuIGluIG5vbi1DU1AgbW9kZSwgYnV0IG5vIHNlY3VyaXR5IHZpb2xhdGlvbnMgd2lsbAogICAgICogYmUgcmFpc2VkLgogICAgICogCiAgICAgKiBJbiBvcmRlciB0byB1c2UgdGhpcyBmZWF0dXJlIHB1dCBgbmdDc3BgIGRpcmVjdGl2ZSBvbiB0aGUgcm9vdCBlbGVtZW50IG9mIHRoZSBhcHBsaWNhdGlvbi4KICAgICAqIAogICAgICogQGV4YW1wbGUKICAgICAqIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgdG8gYXBwbHkgdGhlIGBuZ0NzcGAgZGlyZWN0aXZlIHRvIHRoZSBgaHRtbGAgdGFnLgogICAgICAgPHByZT4KICAgICAgICAgPCFkb2N0eXBlIGh0bWw+CiAgICAgICAgIDxodG1sIG5nLWFwcCBuZy1jc3A+CiAgICAgICAgIC4uLgogICAgICAgICAuLi4KICAgICAgICAgPC9odG1sPgogICAgICAgPC9wcmU+CiAgICAgKi8KCiAgICB2YXIgbmdDc3BEaXJlY3RpdmUgPSBbJyRzbmlmZmVyJywgZnVuY3Rpb24gKCRzbmlmZmVyKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcHJpb3JpdHk6IDEwMDAsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICRzbmlmZmVyLmNzcCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfV07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdDbGljawogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIG5nQ2xpY2sgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuCiAgICAgKiBlbGVtZW50IGlzIGNsaWNrZWQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogY2xpY2suIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgPGJ1dHRvbiBuZy1jbGljaz0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICAgICAgICAgICBJbmNyZW1lbnQKICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgY291bnQ6IHt7Y291bnR9fQogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50JykpLnRvQmUoJzAnKTsKICAgICAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIDpidXR0b24nKS5jbGljaygpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2NvdW50JykpLnRvQmUoJzEnKTsKICAgICAgICAgICB9KTsKICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCiAgICAvKgogICAgICogQSBkaXJlY3RpdmUgdGhhdCBhbGxvd3MgY3JlYXRpb24gb2YgY3VzdG9tIG9uY2xpY2sgaGFuZGxlcnMgdGhhdCBhcmUgZGVmaW5lZCBhcyBhbmd1bGFyCiAgICAgKiBleHByZXNzaW9ucyBhbmQgYXJlIGNvbXBpbGVkIGFuZCBleGVjdXRlZCB3aXRoaW4gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICAgKgogICAgICogRXZlbnRzIHRoYXQgYXJlIGhhbmRsZWQgdmlhIHRoZXNlIGhhbmRsZXIgYXJlIGFsd2F5cyBjb25maWd1cmVkIG5vdCB0byBwcm9wYWdhdGUgZnVydGhlci4KICAgICAqLwogICAgdmFyIG5nRXZlbnREaXJlY3RpdmVzID0ge307CiAgICBmb3JFYWNoKAogICAgICAnY2xpY2sgZGJsY2xpY2sgbW91c2Vkb3duIG1vdXNldXAgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlbW92ZSBtb3VzZWVudGVyIG1vdXNlbGVhdmUga2V5ZG93biBrZXl1cCBrZXlwcmVzcyBzdWJtaXQgZm9jdXMgYmx1cicuc3BsaXQoJyAnKSwKICAgICAgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgIHZhciBkaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgbmFtZSk7CiAgICAgICAgICBuZ0V2ZW50RGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSA9IFsnJHBhcnNlJywgZnVuY3Rpb24gKCRwYXJzZSkgewogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGF0dHJbZGlyZWN0aXZlTmFtZV0pOwogICAgICAgICAgICAgICAgICBlbGVtZW50Lm9uKGxvd2VyY2FzZShuYW1lKSwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHNjb3BlLCB7ICRldmVudDogZXZlbnQgfSk7CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgIH1dOwogICAgICB9CiAgICApOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nRGJsY2xpY2sKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdEYmxjbGlja2AgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gZGJsY2xpY2sgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nRGJsY2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogZGJsY2xpY2suIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZWRvd24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBuZ01vdXNlZG93biBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWRvd24gZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2Vkb3duIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlZG93bi4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNldXAKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNldXAgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2V1cCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZXVwLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZW92ZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlb3ZlciBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZW92ZXIge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2VvdmVyLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTW91c2VlbnRlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VlbnRlciBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWVudGVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIG1vdXNlZW50ZXIuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdNb3VzZWxlYXZlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWxlYXZlIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbGVhdmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICogbW91c2VsZWF2ZS4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ01vdXNlbW92ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2Vtb3ZlIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbW92ZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBtb3VzZW1vdmUuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdLZXlkb3duCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBrZXlkb3duIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleWRvd24ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICoga2V5ZG93bi4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGAgYW5kIGNhbiBiZSBpbnRlcnJvZ2F0ZWQgZm9yIGtleUNvZGUsIGFsdEtleSwgZXRjLikKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nS2V5dXAKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGtleXVwIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleXVwIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgICAqIGtleXVwLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCBhbmQgY2FuIGJlIGludGVycm9nYXRlZCBmb3Iga2V5Q29kZSwgYWx0S2V5LCBldGMuKQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICAgKi8KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdLZXlwcmVzcwogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24ga2V5cHJlc3MgZXZlbnQuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nS2V5cHJlc3Mge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAgICoga2V5cHJlc3MuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgIGFuZCBjYW4gYmUgaW50ZXJyb2dhdGVkIGZvciBrZXlDb2RlLCBhbHRLZXksIGV0Yy4pCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1N1Ym1pdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRW5hYmxlcyBiaW5kaW5nIGFuZ3VsYXIgZXhwcmVzc2lvbnMgdG8gb25zdWJtaXQgZXZlbnRzLgogICAgICoKICAgICAqIEFkZGl0aW9uYWxseSBpdCBwcmV2ZW50cyB0aGUgZGVmYXVsdCBhY3Rpb24gKHdoaWNoIGZvciBmb3JtIG1lYW5zIHNlbmRpbmcgdGhlIHJlcXVlc3QgdG8gdGhlCiAgICAgKiBzZXJ2ZXIgYW5kIHJlbG9hZGluZyB0aGUgY3VycmVudCBwYWdlKSAqKmJ1dCBvbmx5IGlmIHRoZSBmb3JtIGRvZXMgbm90IGNvbnRhaW4gYW4gYGFjdGlvbmAKICAgICAqIGF0dHJpYnV0ZSoqLgogICAgICoKICAgICAqIEBlbGVtZW50IGZvcm0KICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTdWJtaXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgICRzY29wZS5saXN0ID0gW107CiAgICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnaGVsbG8nOwogICAgICAgICAgICAgICRzY29wZS5zdWJtaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRleHQpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5saXN0LnB1c2godGhpcy50ZXh0KTsKICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0ID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICA8Zm9ybSBuZy1zdWJtaXQ9InN1Ym1pdCgpIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgRW50ZXIgdGV4dCBhbmQgaGl0IGVudGVyOgogICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InRleHQiIG5hbWU9InRleHQiIC8+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJzdWJtaXQiIGlkPSJzdWJtaXQiIHZhbHVlPSJTdWJtaXQiIC8+CiAgICAgICAgICAgIDxwcmU+bGlzdD17e2xpc3R9fTwvcHJlPgogICAgICAgICAgPC9mb3JtPgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zdWJtaXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdsaXN0JykpLnRvQmUoJ1tdJyk7CiAgICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc3VibWl0JykuY2xpY2soKTsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdsaXN0JykpLnRvQmUoJ1siaGVsbG8iXScpOwogICAgICAgICAgICAgZXhwZWN0KGlucHV0KCd0ZXh0JykudmFsKCkpLnRvQmUoJycpOwogICAgICAgICAgIH0pOwogICAgICAgICAgIGl0KCdzaG91bGQgaWdub3JlIGVtcHR5IHN0cmluZ3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdsaXN0JykpLnRvQmUoJ1tdJyk7CiAgICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAjc3VibWl0JykuY2xpY2soKTsKICAgICAgICAgICAgIGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlICNzdWJtaXQnKS5jbGljaygpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ2xpc3QnKSkudG9CZSgnWyJoZWxsbyJdJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nRm9jdXMKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGZvY3VzIGV2ZW50LgogICAgICoKICAgICAqIEBlbGVtZW50IHdpbmRvdywgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIGEKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdGb2N1cyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBmb2N1cy4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nQmx1cgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gYmx1ciBldmVudC4KICAgICAqCiAgICAgKiBAZWxlbWVudCB3aW5kb3csIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmx1ciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICAgKiBibHVyLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAgICovCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdJZgogICAgICogQHJlc3RyaWN0IEEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdJZmAgZGlyZWN0aXZlIHJlbW92ZXMgYW5kIHJlY3JlYXRlcyBhIHBvcnRpb24gb2YgdGhlIERPTSB0cmVlIChIVE1MKQogICAgICogY29uZGl0aW9uYWxseSBiYXNlZCBvbiAqKiJmYWxzeSIqKiBhbmQgKioidHJ1dGh5IioqIHZhbHVlcywgcmVzcGVjdGl2ZWx5LCBldmFsdWF0ZWQgd2l0aGluCiAgICAgKiBhbiB7ZXhwcmVzc2lvbn0uIEluIG90aGVyIHdvcmRzLCBpZiB0aGUgZXhwcmVzc2lvbiBhc3NpZ25lZCB0byAqKm5nSWYgZXZhbHVhdGVzIHRvIGEgZmFsc2UKICAgICAqIHZhbHVlKiogdGhlbiAqKnRoZSBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NKiogYW5kICoqaWYgdHJ1ZSoqIHRoZW4gKiphIGNsb25lIG9mIHRoZQogICAgICogZWxlbWVudCBpcyByZWluc2VydGVkIGludG8gdGhlIERPTSoqLgogICAgICoKICAgICAqIGBuZ0lmYCBkaWZmZXJzIGZyb20gYG5nU2hvd2AgYW5kIGBuZ0hpZGVgIGluIHRoYXQgYG5nSWZgIGNvbXBsZXRlbHkgcmVtb3ZlcyBhbmQgcmVjcmVhdGVzIHRoZQogICAgICogZWxlbWVudCBpbiB0aGUgRE9NIHJhdGhlciB0aGFuIGNoYW5naW5nIGl0cyB2aXNpYmlsaXR5IHZpYSB0aGUgYGRpc3BsYXlgIGNzcyBwcm9wZXJ0eS4gIEEgY29tbW9uCiAgICAgKiBjYXNlIHdoZW4gdGhpcyBkaWZmZXJlbmNlIGlzIHNpZ25pZmljYW50IGlzIHdoZW4gdXNpbmcgY3NzIHNlbGVjdG9ycyB0aGF0IHJlbHkgb24gYW4gZWxlbWVudCdzCiAgICAgKiBwb3NpdGlvbiB3aXRoaW4gdGhlIERPTSAoSFRNTCksIHN1Y2ggYXMgdGhlIGA6Zmlyc3QtY2hpbGRgIG9yIGA6bGFzdC1jaGlsZGAgcHNldWRvLWNsYXNzZXMuCiAgICAgKgogICAgICogTm90ZSB0aGF0ICoqd2hlbiBhbiBlbGVtZW50IGlzIHJlbW92ZWQgdXNpbmcgbmdJZiBpdHMgc2NvcGUgaXMgZGVzdHJveWVkKiogYW5kICoqYSBuZXcgc2NvcGUKICAgICAqIGlzIGNyZWF0ZWQgd2hlbiB0aGUgZWxlbWVudCBpcyByZXN0b3JlZCoqLiAgVGhlIHNjb3BlIGNyZWF0ZWQgd2l0aGluIGBuZ0lmYCBpbmhlcml0cyBmcm9tIAogICAgICogaXRzIHBhcmVudCBzY29wZSB1c2luZwogICAgICoge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvd2lraS9UaGUtTnVhbmNlcy1vZi1TY29wZS1Qcm90b3R5cGFsLUluaGVyaXRhbmNlIHByb3RvdHlwYWwgaW5oZXJpdGFuY2V9LgogICAgICogQW4gaW1wb3J0YW50IGltcGxpY2F0aW9uIG9mIHRoaXMgaXMgaWYgYG5nTW9kZWxgIGlzIHVzZWQgd2l0aGluIGBuZ0lmYCB0byBiaW5kIHRvCiAgICAgKiBhIGphdmFzY3JpcHQgcHJpbWl0aXZlIGRlZmluZWQgaW4gdGhlIHBhcmVudCBzY29wZS4gSW4gdGhpcyBjYXNlIGFueSBtb2RpZmljYXRpb25zIG1hZGUgdG8gdGhlCiAgICAgKiB2YXJpYWJsZSB3aXRoaW4gdGhlIGNoaWxkIHNjb3BlIHdpbGwgb3ZlcnJpZGUgKGhpZGUpIHRoZSB2YWx1ZSBpbiB0aGUgcGFyZW50IHNjb3BlLgogICAgICoKICAgICAqIEFsc28sIGBuZ0lmYCByZWNyZWF0ZXMgZWxlbWVudHMgdXNpbmcgdGhlaXIgY29tcGlsZWQgc3RhdGUuIEFuIGV4YW1wbGUgc2NlbmFyaW8gb2YgdGhpcyBiZWhhdmlvcgogICAgICogaXMgaWYgYW4gZWxlbWVudCdzIGNsYXNzIGF0dHJpYnV0ZSBpcyBkaXJlY3RseSBtb2RpZmllZCBhZnRlciBpdCdzIGNvbXBpbGVkLCB1c2luZyBzb21ldGhpbmcgbGlrZSAKICAgICAqIGpRdWVyeSdzIGAuYWRkQ2xhc3MoKWAgbWV0aG9kLCBhbmQgdGhlIGVsZW1lbnQgaXMgbGF0ZXIgcmVtb3ZlZC4gV2hlbiBgbmdJZmAgcmVjcmVhdGVzIHRoZSBlbGVtZW50CiAgICAgKiB0aGUgYWRkZWQgY2xhc3Mgd2lsbCBiZSBsb3N0IGJlY2F1c2UgdGhlIG9yaWdpbmFsIGNvbXBpbGVkIHN0YXRlIGlzIHVzZWQgdG8gcmVnZW5lcmF0ZSB0aGUgZWxlbWVudC4KICAgICAqCiAgICAgKiBBZGRpdGlvbmFsbHksIHlvdSBjYW4gcHJvdmlkZSBhbmltYXRpb25zIHZpYSB0aGUgbmdBbmltYXRlIG1vZHVsZSB0byBhbmltYXRlIHRoZSAqKmVudGVyKioKICAgICAqIGFuZCAqKmxlYXZlKiogZWZmZWN0cy4KICAgICAqCiAgICAgKiBAYW5pbWF0aW9ucwogICAgICogZW50ZXIgLSBoYXBwZW5zIGp1c3QgYWZ0ZXIgdGhlIG5nSWYgY29udGVudHMgY2hhbmdlIGFuZCBhIG5ldyBET00gZWxlbWVudCBpcyBjcmVhdGVkIGFuZCBpbmplY3RlZCBpbnRvIHRoZSBuZ0lmIGNvbnRhaW5lcgogICAgICogbGVhdmUgLSBoYXBwZW5zIGp1c3QgYmVmb3JlIHRoZSBuZ0lmIGNvbnRlbnRzIGFyZSByZW1vdmVkIGZyb20gdGhlIERPTQogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHNjb3BlCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nSWYgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIGZhbHN5IHRoZW4KICAgICAqICAgICB0aGUgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTSB0cmVlIChIVE1MKS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBhbmltYXRpb25zPSJ0cnVlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIiBuZy1pbml0PSJjaGVja2VkPXRydWUiIC8+PGJyLz4KICAgICAgICAgIFNob3cgd2hlbiBjaGVja2VkOgogICAgICAgICAgPHNwYW4gbmctaWY9ImNoZWNrZWQiIGNsYXNzPSJhbmltYXRlLWlmIj4KICAgICAgICAgICAgSSdtIHJlbW92ZWQgd2hlbiB0aGUgY2hlY2tib3ggaXMgdW5jaGVja2VkLgogICAgICAgICAgPC9zcGFuPgogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgICAgICAuYW5pbWF0ZS1pZiB7CiAgICAgICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmFuaW1hdGUtaWYubmctZW50ZXIsIC5hbmltYXRlLWlmLm5nLWxlYXZlIHsKICAgICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgIC1tb3otdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgICAgICAtby10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmFuaW1hdGUtaWYubmctZW50ZXIsCiAgICAgICAgICAuYW5pbWF0ZS1pZi5uZy1sZWF2ZS5uZy1sZWF2ZS1hY3RpdmUgewogICAgICAgICAgICBvcGFjaXR5OjA7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5hbmltYXRlLWlmLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSwKICAgICAgICAgIC5hbmltYXRlLWlmLm5nLWxlYXZlIHsKICAgICAgICAgICAgb3BhY2l0eToxOwogICAgICAgICAgfQogICAgICAgIDwvZmlsZT4KICAgICAgPC9leGFtcGxlPgogICAgICovCiAgICB2YXIgbmdJZkRpcmVjdGl2ZSA9IFsnJGFuaW1hdGUnLCBmdW5jdGlvbiAoJGFuaW1hdGUpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgICAgIHByaW9yaXR5OiAxMDAwLAogICAgICAgICAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICAgICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIsIHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRFbGVtZW50LCBjaGlsZFNjb3BlOwogICAgICAgICAgICAgICAgICAgICRzY29wZS4kd2F0Y2goJGF0dHIubmdJZiwgZnVuY3Rpb24gbmdJZldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKGNoaWxkRWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkU2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvQm9vbGVhbih2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSAkc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNjbHVkZShjaGlsZFNjb3BlLCBmdW5jdGlvbiAoY2xvbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjbG9uZSwgJGVsZW1lbnQucGFyZW50KCksICRlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUKICAgICAqIEByZXN0cmljdCBFQ0EKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEZldGNoZXMsIGNvbXBpbGVzIGFuZCBpbmNsdWRlcyBhbiBleHRlcm5hbCBIVE1MIGZyYWdtZW50LgogICAgICoKICAgICAqIEtlZXAgaW4gbWluZCB0aGF0OgogICAgICoKICAgICAqIC0gICAgYnkgZGVmYXVsdCwgdGhlIHRlbXBsYXRlIFVSTCBpcyByZXN0cmljdGVkIHRvIHRoZSBzYW1lIGRvbWFpbiBhbmQgcHJvdG9jb2wgYXMgdGhlCiAgICAgKiAgICAgIGFwcGxpY2F0aW9uIGRvY3VtZW50LiAgVGhpcyBpcyBkb25lIGJ5IGNhbGxpbmcge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAgICAgKiAgICAgICRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsfSBvbiBpdC4gIFRvIGxvYWQgdGVtcGxhdGVzIGZyb20gb3RoZXIgZG9tYWlucyBhbmQvb3IgcHJvdG9jb2xzLAogICAgICogICAgICB5b3UgbWF5IGVpdGhlciBlaXRoZXIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0IHdoaXRlbGlzdCB0aGVtfSBvcgogICAgICogICAgICB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzUmVzb3VyY2VVcmwgd3JhcCBpdH0gaW50byBhIHRydXN0ZWQgdmFsdWUuICBSZWZlciBBbmd1bGFyJ3Mge0BsaW5rCiAgICAgKiAgICAgIG5nLiRzY2UgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmd9LgogICAgICogLSAgICBpbiBhZGRpdGlvbiwgdGhlIGJyb3dzZXIncwogICAgICogICAgICB7QGxpbmsgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9icm93c2Vyc2VjL3dpa2kvUGFydDIjU2FtZS1vcmlnaW5fcG9saWN5X2Zvcl9YTUxIdHRwUmVxdWVzdAogICAgICogICAgICBTYW1lIE9yaWdpbiBQb2xpY3l9IGFuZCB7QGxpbmsgaHR0cDovL3d3dy53My5vcmcvVFIvY29ycy8gQ3Jvc3MtT3JpZ2luIFJlc291cmNlIFNoYXJpbmcKICAgICAqICAgICAgKENPUlMpfSBwb2xpY3kgYXBwbHkgdGhhdCBtYXkgZnVydGhlciByZXN0cmljdCB3aGV0aGVyIHRoZSB0ZW1wbGF0ZSBpcyBzdWNjZXNzZnVsbHkgbG9hZGVkLgogICAgICogICAgICAoZS5nLiAgbmdJbmNsdWRlIHdvbid0IHdvcmsgZm9yIGNyb3NzLWRvbWFpbiByZXF1ZXN0cyBvbiBhbGwgYnJvd3NlcnMgYW5kIGZvciBgZmlsZTovL2AKICAgICAqICAgICAgYWNjZXNzIG9uIHNvbWUgYnJvd3NlcnMpCiAgICAgKgogICAgICogQGFuaW1hdGlvbnMKICAgICAqIGVudGVyIC0gYW5pbWF0aW9uIGlzIHVzZWQgdG8gYnJpbmcgbmV3IGNvbnRlbnQgaW50byB0aGUgYnJvd3Nlci4KICAgICAqIGxlYXZlIC0gYW5pbWF0aW9uIGlzIHVzZWQgdG8gYW5pbWF0ZSBleGlzdGluZyBjb250ZW50IGF3YXkuCiAgICAgKgogICAgICogVGhlIGVudGVyIGFuZCBsZWF2ZSBhbmltYXRpb24gb2NjdXIgY29uY3VycmVudGx5LgogICAgICoKICAgICAqIEBzY29wZQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ0luY2x1ZGV8c3JjIGFuZ3VsYXIgZXhwcmVzc2lvbiBldmFsdWF0aW5nIHRvIFVSTC4gSWYgdGhlIHNvdXJjZSBpcyBhIHN0cmluZyBjb25zdGFudCwKICAgICAqICAgICAgICAgICAgICAgICBtYWtlIHN1cmUgeW91IHdyYXAgaXQgaW4gcXVvdGVzLCBlLmcuIGBzcmM9IidteVBhcnRpYWxUZW1wbGF0ZS5odG1sJyJgLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBvbmxvYWQgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB3aGVuIGEgbmV3IHBhcnRpYWwgaXMgbG9hZGVkLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gYXV0b3Njcm9sbCBXaGV0aGVyIGBuZ0luY2x1ZGVgIHNob3VsZCBjYWxsIHtAbGluayBuZy4kYW5jaG9yU2Nyb2xsCiAgICAgKiAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGx9IHRvIHNjcm9sbCB0aGUgdmlld3BvcnQgYWZ0ZXIgdGhlIGNvbnRlbnQgaXMgbG9hZGVkLgogICAgICoKICAgICAqICAgICAgICAgICAgICAgICAgLSBJZiB0aGUgYXR0cmlidXRlIGlzIG5vdCBzZXQsIGRpc2FibGUgc2Nyb2xsaW5nLgogICAgICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgc2V0IHdpdGhvdXQgdmFsdWUsIGVuYWJsZSBzY3JvbGxpbmcuCiAgICAgKiAgICAgICAgICAgICAgICAgIC0gT3RoZXJ3aXNlIGVuYWJsZSBzY3JvbGxpbmcgb25seSBpZiB0aGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1dGh5IHZhbHVlLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgIDxleGFtcGxlIGFuaW1hdGlvbnM9InRydWUiPgogICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9InRlbXBsYXRlIiBuZy1vcHRpb25zPSJ0Lm5hbWUgZm9yIHQgaW4gdGVtcGxhdGVzIj4KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj4oYmxhbmspPC9vcHRpb24+CiAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgdXJsIG9mIHRoZSB0ZW1wbGF0ZTogPHR0Pnt7dGVtcGxhdGUudXJsfX08L3R0PgogICAgICAgICAgIDxoci8+CiAgICAgICAgICAgPGRpdiBjbGFzcz0iZXhhbXBsZS1hbmltYXRlLWNvbnRhaW5lciI+CiAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJpbmNsdWRlLWV4YW1wbGUiIG5nLWluY2x1ZGU9InRlbXBsYXRlLnVybCI+PC9kaXY+CiAgICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLnRlbXBsYXRlcyA9CiAgICAgICAgICAgICAgWyB7IG5hbWU6ICd0ZW1wbGF0ZTEuaHRtbCcsIHVybDogJ3RlbXBsYXRlMS5odG1sJ30KICAgICAgICAgICAgICAsIHsgbmFtZTogJ3RlbXBsYXRlMi5odG1sJywgdXJsOiAndGVtcGxhdGUyLmh0bWwnfSBdOwogICAgICAgICAgICAkc2NvcGUudGVtcGxhdGUgPSAkc2NvcGUudGVtcGxhdGVzWzBdOwogICAgICAgICAgfQogICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0idGVtcGxhdGUxLmh0bWwiPgogICAgICAgICAgQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbAogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJ0ZW1wbGF0ZTIuaHRtbCI+CiAgICAgICAgICBDb250ZW50IG9mIHRlbXBsYXRlMi5odG1sCiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9ImFuaW1hdGlvbnMuY3NzIj4KICAgICAgICAgIC5leGFtcGxlLWFuaW1hdGUtY29udGFpbmVyIHsKICAgICAgICAgICAgcG9zaXRpb246cmVsYXRpdmU7CiAgICAgICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgICAgIGhlaWdodDo0MHB4OwogICAgICAgICAgICBvdmVyZmxvdzpoaWRkZW47CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5leGFtcGxlLWFuaW1hdGUtY29udGFpbmVyID4gZGl2IHsKICAgICAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICAgICAgfQogICAgCiAgICAgICAgICAuaW5jbHVkZS1leGFtcGxlLm5nLWVudGVyLCAuaW5jbHVkZS1leGFtcGxlLm5nLWxlYXZlIHsKICAgICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgIC1tb3otdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgICAgICAtby10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgIAogICAgICAgICAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgICAgICAgICAgdG9wOjA7CiAgICAgICAgICAgIGxlZnQ6MDsKICAgICAgICAgICAgcmlnaHQ6MDsKICAgICAgICAgICAgYm90dG9tOjA7CiAgICAgICAgICAgIGRpc3BsYXk6YmxvY2s7CiAgICAgICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmluY2x1ZGUtZXhhbXBsZS5uZy1lbnRlciB7CiAgICAgICAgICAgIHRvcDotNTBweDsKICAgICAgICAgIH0KICAgICAgICAgIC5pbmNsdWRlLWV4YW1wbGUubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICAgICAgICAgICAgdG9wOjA7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5pbmNsdWRlLWV4YW1wbGUubmctbGVhdmUgewogICAgICAgICAgICB0b3A6MDsKICAgICAgICAgIH0KICAgICAgICAgIC5pbmNsdWRlLWV4YW1wbGUubmctbGVhdmUubmctbGVhdmUtYWN0aXZlIHsKICAgICAgICAgICAgdG9wOjUwcHg7CiAgICAgICAgICB9CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTEuaHRtbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctaW5jbHVkZV0nKS50ZXh0KCkpLgogICAgICAgICAgICAgdG9NYXRjaCgvQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbC8pOwogICAgICAgICAgfSk7CiAgICAgICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUyLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBzZWxlY3QoJ3RlbXBsYXRlJykub3B0aW9uKCcxJyk7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1pbmNsdWRlXScpLnRleHQoKSkuCiAgICAgICAgICAgICB0b01hdGNoKC9Db250ZW50IG9mIHRlbXBsYXRlMi5odG1sLyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGJsYW5rJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgc2VsZWN0KCd0ZW1wbGF0ZScpLm9wdGlvbignJyk7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1pbmNsdWRlXScpKS50b0JlKHVuZGVmaW5lZCk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgIDwvZXhhbXBsZT4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBldmVudAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSMkaW5jbHVkZUNvbnRlbnRSZXF1ZXN0ZWQKICAgICAqIEBldmVudE9mIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUKICAgICAqIEBldmVudFR5cGUgZW1pdCBvbiB0aGUgc2NvcGUgbmdJbmNsdWRlIHdhcyBkZWNsYXJlZCBpbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbWl0dGVkIGV2ZXJ5IHRpbWUgdGhlIG5nSW5jbHVkZSBjb250ZW50IGlzIHJlcXVlc3RlZC4KICAgICAqLwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBldmVudAogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSMkaW5jbHVkZUNvbnRlbnRMb2FkZWQKICAgICAqIEBldmVudE9mIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUKICAgICAqIEBldmVudFR5cGUgZW1pdCBvbiB0aGUgY3VycmVudCBuZ0luY2x1ZGUgc2NvcGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRW1pdHRlZCBldmVyeSB0aW1lIHRoZSBuZ0luY2x1ZGUgY29udGVudCBpcyByZWxvYWRlZC4KICAgICAqLwogICAgdmFyIG5nSW5jbHVkZURpcmVjdGl2ZSA9IFsnJGh0dHAnLCAnJHRlbXBsYXRlQ2FjaGUnLCAnJGFuY2hvclNjcm9sbCcsICckY29tcGlsZScsICckYW5pbWF0ZScsICckc2NlJywKICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgkaHR0cCwgJHRlbXBsYXRlQ2FjaGUsICRhbmNob3JTY3JvbGwsICRjb21waWxlLCAkYW5pbWF0ZSwgJHNjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnRUNBJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIsIHRyYW5zY2x1c2lvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNyY0V4cCA9IGF0dHIubmdJbmNsdWRlIHx8IGF0dHIuc3JjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ubG9hZEV4cCA9IGF0dHIub25sb2FkIHx8ICcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9TY3JvbGxFeHAgPSBhdHRyLmF1dG9zY3JvbGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgJGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hhbmdlQ291bnRlciA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEVsZW1lbnQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjbGVhbnVwTGFzdEluY2x1ZGVDb250ZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYW5pbWF0ZS5sZWF2ZShjdXJyZW50RWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50RWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goJHNjZS5wYXJzZUFzUmVzb3VyY2VVcmwoc3JjRXhwKSwgZnVuY3Rpb24gbmdJbmNsdWRlV2F0Y2hBY3Rpb24oc3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aGlzQ2hhbmdlSWQgPSArK2NoYW5nZUNvdW50ZXI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkaHR0cC5nZXQoc3JjLCB7IGNhY2hlOiAkdGVtcGxhdGVDYWNoZSB9KS5zdWNjZXNzKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzQ2hhbmdlSWQgIT09IGNoYW5nZUNvdW50ZXIpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3U2NvcGUgPSBzY29wZS4kbmV3KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1c2lvbihuZXdTY29wZSwgZnVuY3Rpb24gKGNsb25lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTY29wZSA9IG5ld1Njb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50RWxlbWVudCA9IGNsb25lOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEVsZW1lbnQuaHRtbChyZXNwb25zZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGN1cnJlbnRFbGVtZW50LCBudWxsLCAkZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlKGN1cnJlbnRFbGVtZW50LmNvbnRlbnRzKCkpKGN1cnJlbnRTY29wZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGF1dG9TY3JvbGxFeHApICYmICghYXV0b1Njcm9sbEV4cCB8fCBzY29wZS4kZXZhbChhdXRvU2Nyb2xsRXhwKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFNjb3BlLiRlbWl0KCckaW5jbHVkZUNvbnRlbnRMb2FkZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwob25sb2FkRXhwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc0NoYW5nZUlkID09PSBjaGFuZ2VDb3VudGVyKSBjbGVhbnVwTGFzdEluY2x1ZGVDb250ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRlbWl0KCckaW5jbHVkZUNvbnRlbnRSZXF1ZXN0ZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ0luaXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdJbml0YCBkaXJlY3RpdmUgc3BlY2lmaWVzIGluaXRpYWxpemF0aW9uIHRhc2tzIHRvIGJlIGV4ZWN1dGVkCiAgICAgKiAgYmVmb3JlIHRoZSB0ZW1wbGF0ZSBlbnRlcnMgZXhlY3V0aW9uIG1vZGUgZHVyaW5nIGJvb3RzdHJhcC4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdJbml0IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgPGRpdiBuZy1pbml0PSJncmVldGluZz0nSGVsbG8nOyBwZXJzb249J1dvcmxkJyI+CiAgICAgICAgICB7e2dyZWV0aW5nfX0ge3twZXJzb259fSEKICAgICAgICA8L2Rpdj4KICAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgIGl0KCdzaG91bGQgY2hlY2sgZ3JlZXRpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdncmVldGluZycpKS50b0JlKCdIZWxsbycpOwogICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3BlcnNvbicpKS50b0JlKCdXb3JsZCcpOwogICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0luaXREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcHJlOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwoYXR0cnMubmdJbml0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nTm9uQmluZGFibGUKICAgICAqIEBwcmlvcml0eSAxMDAwCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTb21ldGltZXMgaXQgaXMgbmVjZXNzYXJ5IHRvIHdyaXRlIGNvZGUgd2hpY2ggbG9va3MgbGlrZSBiaW5kaW5ncyBidXQgd2hpY2ggc2hvdWxkIGJlIGxlZnQgYWxvbmUKICAgICAqIGJ5IGFuZ3VsYXIuIFVzZSBgbmdOb25CaW5kYWJsZWAgdG8gbWFrZSBhbmd1bGFyIGlnbm9yZSBhIGNodW5rIG9mIEhUTUwuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIEluIHRoaXMgZXhhbXBsZSB0aGVyZSBhcmUgdHdvIGxvY2F0aW9uIHdoZXJlIGEgc2ltcGxlIGJpbmRpbmcgKGB7e319YCkgaXMgcHJlc2VudCwgYnV0IHRoZSBvbmUKICAgICAqIHdyYXBwZWQgaW4gYG5nTm9uQmluZGFibGVgIGlzIGxlZnQgYWxvbmUuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgICA8ZG9jOmV4YW1wbGU+CiAgICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgICAgPGRpdj5Ob3JtYWw6IHt7MSArIDJ9fTwvZGl2PgogICAgICAgICAgICA8ZGl2IG5nLW5vbi1iaW5kYWJsZT5JZ25vcmVkOiB7ezEgKyAyfX08L2Rpdj4KICAgICAgICAgIDwvZG9jOnNvdXJjZT4KICAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1ub24tYmluZGFibGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIGV4cGVjdCh1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5iaW5kaW5nKCcxICsgMicpKS50b0JlKCczJyk7CiAgICAgICAgICAgICBleHBlY3QodXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuZWxlbWVudCgnZGl2Omxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICB0b01hdGNoKC8xIFwrIDIvKTsKICAgICAgICAgICB9KTsKICAgICAgICAgIDwvZG9jOnNjZW5hcmlvPgogICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ05vbkJpbmRhYmxlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoeyB0ZXJtaW5hbDogdHJ1ZSwgcHJpb3JpdHk6IDEwMDAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdQbHVyYWxpemUKICAgICAqIEByZXN0cmljdCBFQQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogIyBPdmVydmlldwogICAgICogYG5nUGx1cmFsaXplYCBpcyBhIGRpcmVjdGl2ZSB0aGF0IGRpc3BsYXlzIG1lc3NhZ2VzIGFjY29yZGluZyB0byBlbi1VUyBsb2NhbGl6YXRpb24gcnVsZXMuCiAgICAgKiBUaGVzZSBydWxlcyBhcmUgYnVuZGxlZCB3aXRoIGFuZ3VsYXIuanMsIGJ1dCBjYW4gYmUgb3ZlcnJpZGRlbgogICAgICogKHNlZSB7QGxpbmsgZ3VpZGUvaTE4biBBbmd1bGFyIGkxOG59IGRldiBndWlkZSkuIFlvdSBjb25maWd1cmUgbmdQbHVyYWxpemUgZGlyZWN0aXZlCiAgICAgKiBieSBzcGVjaWZ5aW5nIHRoZSBtYXBwaW5ncyBiZXR3ZWVuCiAgICAgKiB7QGxpbmsgaHR0cDovL3VuaWNvZGUub3JnL3JlcG9zL2NsZHItdG1wL3RydW5rL2RpZmYvc3VwcGxlbWVudGFsL2xhbmd1YWdlX3BsdXJhbF9ydWxlcy5odG1sCiAgICAgKiBwbHVyYWwgY2F0ZWdvcmllc30gYW5kIHRoZSBzdHJpbmdzIHRvIGJlIGRpc3BsYXllZC4KICAgICAqCiAgICAgKiAjIFBsdXJhbCBjYXRlZ29yaWVzIGFuZCBleHBsaWNpdCBudW1iZXIgcnVsZXMKICAgICAqIFRoZXJlIGFyZSB0d28KICAgICAqIHtAbGluayBodHRwOi8vdW5pY29kZS5vcmcvcmVwb3MvY2xkci10bXAvdHJ1bmsvZGlmZi9zdXBwbGVtZW50YWwvbGFuZ3VhZ2VfcGx1cmFsX3J1bGVzLmh0bWwKICAgICAqIHBsdXJhbCBjYXRlZ29yaWVzfSBpbiBBbmd1bGFyJ3MgZGVmYXVsdCBlbi1VUyBsb2NhbGU6ICJvbmUiIGFuZCAib3RoZXIiLgogICAgICoKICAgICAqIFdoaWxlIGEgcGx1cmFsIGNhdGVnb3J5IG1heSBtYXRjaCBtYW55IG51bWJlcnMgKGZvciBleGFtcGxlLCBpbiBlbi1VUyBsb2NhbGUsICJvdGhlciIgY2FuIG1hdGNoCiAgICAgKiBhbnkgbnVtYmVyIHRoYXQgaXMgbm90IDEpLCBhbiBleHBsaWNpdCBudW1iZXIgcnVsZSBjYW4gb25seSBtYXRjaCBvbmUgbnVtYmVyLiBGb3IgZXhhbXBsZSwgdGhlCiAgICAgKiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IgIjMiIG1hdGNoZXMgdGhlIG51bWJlciAzLiBUaGVyZSBhcmUgZXhhbXBsZXMgb2YgcGx1cmFsIGNhdGVnb3JpZXMKICAgICAqIGFuZCBleHBsaWNpdCBudW1iZXIgcnVsZXMgdGhyb3VnaG91dCB0aGUgcmVzdCBvZiB0aGlzIGRvY3VtZW50YXRpb24uCiAgICAgKgogICAgICogIyBDb25maWd1cmluZyBuZ1BsdXJhbGl6ZQogICAgICogWW91IGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZSBieSBwcm92aWRpbmcgMiBhdHRyaWJ1dGVzOiBgY291bnRgIGFuZCBgd2hlbmAuCiAgICAgKiBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCBhdHRyaWJ1dGUsIGBvZmZzZXRgLgogICAgICoKICAgICAqIFRoZSB2YWx1ZSBvZiB0aGUgYGNvdW50YCBhdHRyaWJ1dGUgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvciBhbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbgogICAgICogQW5ndWxhciBleHByZXNzaW9ufTsgdGhlc2UgYXJlIGV2YWx1YXRlZCBvbiB0aGUgY3VycmVudCBzY29wZSBmb3IgaXRzIGJvdW5kIHZhbHVlLgogICAgICoKICAgICAqIFRoZSBgd2hlbmAgYXR0cmlidXRlIHNwZWNpZmllcyB0aGUgbWFwcGluZ3MgYmV0d2VlbiBwbHVyYWwgY2F0ZWdvcmllcyBhbmQgdGhlIGFjdHVhbAogICAgICogc3RyaW5nIHRvIGJlIGRpc3BsYXllZC4gVGhlIHZhbHVlIG9mIHRoZSBhdHRyaWJ1dGUgc2hvdWxkIGJlIGEgSlNPTiBvYmplY3QuCiAgICAgKgogICAgICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNob3dzIGhvdyB0byBjb25maWd1cmUgbmdQbHVyYWxpemU6CiAgICAgKgogICAgICogPHByZT4KICAgICAqIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IgogICAgICAgICAgICAgICAgICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICAgICAqICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAnMSBwZXJzb24gaXMgdmlld2luZy4nLAogICAgICogICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t9IHBlb3BsZSBhcmUgdmlld2luZy4nfSI+CiAgICAgKiA8L25nLXBsdXJhbGl6ZT4KICAgICAqPC9wcmU+CiAgICAgKgogICAgICogSW4gdGhlIGV4YW1wbGUsIGAiMDogTm9ib2R5IGlzIHZpZXdpbmcuImAgaXMgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUuIElmIHlvdSBkaWQgbm90CiAgICAgKiBzcGVjaWZ5IHRoaXMgcnVsZSwgMCB3b3VsZCBiZSBtYXRjaGVkIHRvIHRoZSAib3RoZXIiIGNhdGVnb3J5IGFuZCAiMCBwZW9wbGUgYXJlIHZpZXdpbmciCiAgICAgKiB3b3VsZCBiZSBzaG93biBpbnN0ZWFkIG9mICJOb2JvZHkgaXMgdmlld2luZyIuIFlvdSBjYW4gc3BlY2lmeSBhbiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IKICAgICAqIG90aGVyIG51bWJlcnMsIGZvciBleGFtcGxlIDEyLCBzbyB0aGF0IGluc3RlYWQgb2Ygc2hvd2luZyAiMTIgcGVvcGxlIGFyZSB2aWV3aW5nIiwgeW91IGNhbgogICAgICogc2hvdyAiYSBkb3plbiBwZW9wbGUgYXJlIHZpZXdpbmciLgogICAgICoKICAgICAqIFlvdSBjYW4gdXNlIGEgc2V0IG9mIGNsb3NlZCBicmFjZXMoYHt9YCkgYXMgYSBwbGFjZWhvbGRlciBmb3IgdGhlIG51bWJlciB0aGF0IHlvdSB3YW50IHN1YnN0aXR1dGVkCiAgICAgKiBpbnRvIHBsdXJhbGl6ZWQgc3RyaW5ncy4gSW4gdGhlIHByZXZpb3VzIGV4YW1wbGUsIEFuZ3VsYXIgd2lsbCByZXBsYWNlIGB7fWAgd2l0aAogICAgICogPHNwYW4gbmctbm9uLWJpbmRhYmxlPmB7e3BlcnNvbkNvdW50fX1gPC9zcGFuPi4gVGhlIGNsb3NlZCBicmFjZXMgYHt9YCBpcyBhIHBsYWNlaG9sZGVyCiAgICAgKiBmb3IgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7bnVtYmVyRXhwcmVzc2lvbn19PC9zcGFuPi4KICAgICAqCiAgICAgKiAjIENvbmZpZ3VyaW5nIG5nUGx1cmFsaXplIHdpdGggb2Zmc2V0CiAgICAgKiBUaGUgYG9mZnNldGAgYXR0cmlidXRlIGFsbG93cyBmdXJ0aGVyIGN1c3RvbWl6YXRpb24gb2YgcGx1cmFsaXplZCB0ZXh0LCB3aGljaCBjYW4gcmVzdWx0IGluCiAgICAgKiBhIGJldHRlciB1c2VyIGV4cGVyaWVuY2UuIEZvciBleGFtcGxlLCBpbnN0ZWFkIG9mIHRoZSBtZXNzYWdlICI0IHBlb3BsZSBhcmUgdmlld2luZyB0aGlzIGRvY3VtZW50IiwKICAgICAqIHlvdSBtaWdodCBkaXNwbGF5ICJKb2huLCBLYXRlIGFuZCAyIG90aGVycyBhcmUgdmlld2luZyB0aGlzIGRvY3VtZW50Ii4KICAgICAqIFRoZSBvZmZzZXQgYXR0cmlidXRlIGFsbG93cyB5b3UgdG8gb2Zmc2V0IGEgbnVtYmVyIGJ5IGFueSBkZXNpcmVkIHZhbHVlLgogICAgICogTGV0J3MgdGFrZSBhIGxvb2sgYXQgYW4gZXhhbXBsZToKICAgICAqCiAgICAgKiA8cHJlPgogICAgICogPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiIG9mZnNldD0yCiAgICAgKiAgICAgICAgICAgICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICogICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogICAgICogICAgICAgICAgICAgICAgICAgICAgJzInOiAne3twZXJzb24xfX0gYW5kIHt7cGVyc29uMn19IGFyZSB2aWV3aW5nLicsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZy4nLAogICAgICogICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICAqIDwvbmctcGx1cmFsaXplPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogTm90aWNlIHRoYXQgd2UgYXJlIHN0aWxsIHVzaW5nIHR3byBwbHVyYWwgY2F0ZWdvcmllcyhvbmUsIG90aGVyKSwgYnV0IHdlIGFkZGVkCiAgICAgKiB0aHJlZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgMCwgMSBhbmQgMi4KICAgICAqIFdoZW4gb25lIHBlcnNvbiwgcGVyaGFwcyBKb2huLCB2aWV3cyB0aGUgZG9jdW1lbnQsICJKb2huIGlzIHZpZXdpbmciIHdpbGwgYmUgc2hvd24uCiAgICAgKiBXaGVuIHRocmVlIHBlb3BsZSB2aWV3IHRoZSBkb2N1bWVudCwgbm8gZXhwbGljaXQgbnVtYmVyIHJ1bGUgaXMgZm91bmQsIHNvCiAgICAgKiBhbiBvZmZzZXQgb2YgMiBpcyB0YWtlbiBvZmYgMywgYW5kIEFuZ3VsYXIgdXNlcyAxIHRvIGRlY2lkZSB0aGUgcGx1cmFsIGNhdGVnb3J5LgogICAgICogSW4gdGhpcyBjYXNlLCBwbHVyYWwgY2F0ZWdvcnkgJ29uZScgaXMgbWF0Y2hlZCBhbmQgIkpvaG4sIE1hcnJ5IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nIgogICAgICogaXMgc2hvd24uCiAgICAgKgogICAgICogTm90ZSB0aGF0IHdoZW4geW91IHNwZWNpZnkgb2Zmc2V0cywgeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yCiAgICAgKiBudW1iZXJzIGZyb20gMCB1cCB0byBhbmQgaW5jbHVkaW5nIHRoZSBvZmZzZXQuIElmIHlvdSB1c2UgYW4gb2Zmc2V0IG9mIDMsIGZvciBleGFtcGxlLAogICAgICogeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yIDAsIDEsIDIgYW5kIDMuIFlvdSBtdXN0IGFsc28gcHJvdmlkZSBwbHVyYWwgc3RyaW5ncyBmb3IKICAgICAqIHBsdXJhbCBjYXRlZ29yaWVzICJvbmUiIGFuZCAib3RoZXIiLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfGV4cHJlc3Npb259IGNvdW50IFRoZSB2YXJpYWJsZSB0byBiZSBib3VuZGVkIHRvLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHdoZW4gVGhlIG1hcHBpbmcgYmV0d2VlbiBwbHVyYWwgY2F0ZWdvcnkgdG8gaXRzIGNvcnJlc3BvbmRpbmcgc3RyaW5ncy4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gb2Zmc2V0IE9mZnNldCB0byBkZWR1Y3QgZnJvbSB0aGUgdG90YWwgbnVtYmVyLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICAgPGRvYzpleGFtcGxlPgogICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICAgICRzY29wZS5wZXJzb24xID0gJ0lnb3InOwogICAgICAgICAgICAgICAgJHNjb3BlLnBlcnNvbjIgPSAnTWlza28nOwogICAgICAgICAgICAgICAgJHNjb3BlLnBlcnNvbkNvdW50ID0gMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgICAgICAgICAgIFBlcnNvbiAxOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMSIgdmFsdWU9Iklnb3IiIC8+PGJyLz4KICAgICAgICAgICAgICBQZXJzb24gMjo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbjIiIHZhbHVlPSJNaXNrbyIgLz48YnIvPgogICAgICAgICAgICAgIE51bWJlciBvZiBQZW9wbGU6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb25Db3VudCIgdmFsdWU9IjEiIC8+PGJyLz4KICAgIAogICAgICAgICAgICAgIDwhLS0tIEV4YW1wbGUgd2l0aCBzaW1wbGUgcGx1cmFsaXphdGlvbiBydWxlcyBmb3IgZW4gbG9jYWxlIC0tLT4KICAgICAgICAgICAgICBXaXRob3V0IE9mZnNldDoKICAgICAgICAgICAgICA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAnMSBwZXJzb24gaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAgICAgICAgICAgIDwvbmctcGx1cmFsaXplPjxicj4KICAgIAogICAgICAgICAgICAgIDwhLS0tIEV4YW1wbGUgd2l0aCBvZmZzZXQgLS0tPgogICAgICAgICAgICAgIFdpdGggT2Zmc2V0KDIpOgogICAgICAgICAgICAgIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IiBvZmZzZXQ9MgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcyJzogJ3t7cGVyc29uMX19IGFuZCB7e3BlcnNvbjJ9fSBhcmUgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgICAgICAgICAgICA8L25nLXBsdXJhbGl6ZT4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICBpdCgnc2hvdWxkIHNob3cgY29ycmVjdCBwbHVyYWxpemVkIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6Zmlyc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnMSBwZXJzb24gaXMgdmlld2luZy4nKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmxhc3QnKS50ZXh0KCkpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciBpcyB2aWV3aW5nLicpOwogICAgCiAgICAgICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbkNvdW50JykuZW50ZXIoJzAnKTsKICAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgbmctcGx1cmFsaXplOmZpcnN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9CZSgnTm9ib2R5IGlzIHZpZXdpbmcuJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCdOb2JvZHkgaXMgdmlld2luZy4nKTsKICAgIAogICAgICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCcyJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpmaXJzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCdJZ29yIGFuZCBNaXNrbyBhcmUgdmlld2luZy4nKTsKICAgIAogICAgICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCczJyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpmaXJzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzMgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCdJZ29yLCBNaXNrbyBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZy4nKTsKICAgIAogICAgICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCc0Jyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpmaXJzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvQmUoJzQgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0JlKCdJZ29yLCBNaXNrbyBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICAgIGl0KCdzaG91bGQgc2hvdyBkYXRhLWJpbmRlZCBuYW1lcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVzaW5nKCcuZG9jLWV4YW1wbGUtbGl2ZScpLmlucHV0KCdwZXJzb25Db3VudCcpLmVudGVyKCc0Jyk7CiAgICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIG5nLXBsdXJhbGl6ZTpsYXN0JykudGV4dCgpKS4KICAgICAgICAgICAgICAgICAgdG9CZSgnSWdvciwgTWlza28gYW5kIDIgb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgCiAgICAgICAgICAgICAgdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykuaW5wdXQoJ3BlcnNvbjEnKS5lbnRlcignRGknKTsKICAgICAgICAgICAgICB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5pbnB1dCgncGVyc29uMicpLmVudGVyKCdWb2p0YScpOwogICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBuZy1wbHVyYWxpemU6bGFzdCcpLnRleHQoKSkuCiAgICAgICAgICAgICAgICAgIHRvQmUoJ0RpLCBWb2p0YSBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgICAgPC9kb2M6ZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nUGx1cmFsaXplRGlyZWN0aXZlID0gWyckbG9jYWxlJywgJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uICgkbG9jYWxlLCAkaW50ZXJwb2xhdGUpIHsKICAgICAgICB2YXIgQlJBQ0UgPSAve30vZzsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZXN0cmljdDogJ0VBJywKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyRXhwID0gYXR0ci5jb3VudCwKICAgICAgICAgICAgICAgICAgICB3aGVuRXhwID0gYXR0ci4kYXR0ci53aGVuICYmIGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLndoZW4pLCAvLyB3ZSBoYXZlIHt7fX0gaW4gYXR0cnMKICAgICAgICAgICAgICAgICAgICBvZmZzZXQgPSBhdHRyLm9mZnNldCB8fCAwLAogICAgICAgICAgICAgICAgICAgIHdoZW5zID0gc2NvcGUuJGV2YWwod2hlbkV4cCkgfHwge30sCiAgICAgICAgICAgICAgICAgICAgd2hlbnNFeHBGbnMgPSB7fSwKICAgICAgICAgICAgICAgICAgICBzdGFydFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCgpLAogICAgICAgICAgICAgICAgICAgIGVuZFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2woKSwKICAgICAgICAgICAgICAgICAgICBpc1doZW4gPSAvXndoZW4oTWludXMpPyguKykkLzsKCiAgICAgICAgICAgICAgICBmb3JFYWNoKGF0dHIsIGZ1bmN0aW9uIChleHByZXNzaW9uLCBhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzV2hlbi50ZXN0KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoZW5zW2xvd2VyY2FzZShhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoJ3doZW4nLCAnJykucmVwbGFjZSgnTWludXMnLCAnLScpKV0gPQogICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyW2F0dHJpYnV0ZU5hbWVdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZvckVhY2god2hlbnMsIGZ1bmN0aW9uIChleHByZXNzaW9uLCBrZXkpIHsKICAgICAgICAgICAgICAgICAgICB3aGVuc0V4cEZuc1trZXldID0KICAgICAgICAgICAgICAgICAgICAgICRpbnRlcnBvbGF0ZShleHByZXNzaW9uLnJlcGxhY2UoQlJBQ0UsIHN0YXJ0U3ltYm9sICsgbnVtYmVyRXhwICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ICsgZW5kU3ltYm9sKSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdQbHVyYWxpemVXYXRjaCgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZUZsb2F0KHNjb3BlLiRldmFsKG51bWJlckV4cCkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvL2lmIGV4cGxpY2l0IG51bWJlciBydWxlIHN1Y2ggYXMgMSwgMiwgMy4uLiBpcyBkZWZpbmVkLCBqdXN0IHVzZSBpdC4gT3RoZXJ3aXNlLAogICAgICAgICAgICAgICAgICAgICAgICAvL2NoZWNrIGl0IGFnYWluc3QgcGx1cmFsaXphdGlvbiBydWxlcyBpbiAkbG9jYWxlIHNlcnZpY2UKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEodmFsdWUgaW4gd2hlbnMpKSB2YWx1ZSA9ICRsb2NhbGUucGx1cmFsQ2F0KHZhbHVlIC0gb2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdoZW5zRXhwRm5zW3ZhbHVlXShzY29wZSwgZWxlbWVudCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2hBY3Rpb24obmV3VmFsKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KG5ld1ZhbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGBuZ1JlcGVhdGAgZGlyZWN0aXZlIGluc3RhbnRpYXRlcyBhIHRlbXBsYXRlIG9uY2UgcGVyIGl0ZW0gZnJvbSBhIGNvbGxlY3Rpb24uIEVhY2ggdGVtcGxhdGUKICAgICAqIGluc3RhbmNlIGdldHMgaXRzIG93biBzY29wZSwgd2hlcmUgdGhlIGdpdmVuIGxvb3AgdmFyaWFibGUgaXMgc2V0IHRvIHRoZSBjdXJyZW50IGNvbGxlY3Rpb24gaXRlbSwKICAgICAqIGFuZCBgJGluZGV4YCBpcyBzZXQgdG8gdGhlIGl0ZW0gaW5kZXggb3Iga2V5LgogICAgICoKICAgICAqIFNwZWNpYWwgcHJvcGVydGllcyBhcmUgZXhwb3NlZCBvbiB0aGUgbG9jYWwgc2NvcGUgb2YgZWFjaCB0ZW1wbGF0ZSBpbnN0YW5jZSwgaW5jbHVkaW5nOgogICAgICoKICAgICAqIHwgVmFyaWFibGUgIHwgVHlwZSAgICAgICAgICAgIHwgRGV0YWlscyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAqIHwtLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAqIHwgYCRpbmRleGAgIHwge0B0eXBlIG51bWJlcn0gIHwgaXRlcmF0b3Igb2Zmc2V0IG9mIHRoZSByZXBlYXRlZCBlbGVtZW50ICgwLi5sZW5ndGgtMSkgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAqIHwgYCRmaXJzdGAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBmaXJzdCBpbiB0aGUgaXRlcmF0b3IuICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAqIHwgYCRtaWRkbGVgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBiZXR3ZWVuIHRoZSBmaXJzdCBhbmQgbGFzdCBpbiB0aGUgaXRlcmF0b3IuIHwKICAgICAqIHwgYCRsYXN0YCAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBsYXN0IGluIHRoZSBpdGVyYXRvci4gICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAqIHwgYCRldmVuYCAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgaXRlcmF0b3IgcG9zaXRpb24gYCRpbmRleGAgaXMgZXZlbiAob3RoZXJ3aXNlIGZhbHNlKS4gICAgICAgICAgIHwKICAgICAqIHwgYCRvZGRgICAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgaXRlcmF0b3IgcG9zaXRpb24gYCRpbmRleGAgaXMgb2RkIChvdGhlcndpc2UgZmFsc2UpLiAgICAgICAgICAgIHwKICAgICAqCiAgICAgKgogICAgICogIyBTcGVjaWFsIHJlcGVhdCBzdGFydCBhbmQgZW5kIHBvaW50cwogICAgICogVG8gcmVwZWF0IGEgc2VyaWVzIG9mIGVsZW1lbnRzIGluc3RlYWQgb2YganVzdCBvbmUgcGFyZW50IGVsZW1lbnQsIG5nUmVwZWF0IChhcyB3ZWxsIGFzIG90aGVyIG5nIGRpcmVjdGl2ZXMpIHN1cHBvcnRzIGV4dGVuZGluZwogICAgICogdGhlIHJhbmdlIG9mIHRoZSByZXBlYXRlciBieSBkZWZpbmluZyBleHBsaWNpdCBzdGFydCBhbmQgZW5kIHBvaW50cyBieSB1c2luZyAqKm5nLXJlcGVhdC1zdGFydCoqIGFuZCAqKm5nLXJlcGVhdC1lbmQqKiByZXNwZWN0aXZlbHkuCiAgICAgKiBUaGUgKipuZy1yZXBlYXQtc3RhcnQqKiBkaXJlY3RpdmUgd29ya3MgdGhlIHNhbWUgYXMgKipuZy1yZXBlYXQqKiwgYnV0IHdpbGwgcmVwZWF0IGFsbCB0aGUgSFRNTCBjb2RlIChpbmNsdWRpbmcgdGhlIHRhZyBpdCdzIGRlZmluZWQgb24pCiAgICAgKiB1cCB0byBhbmQgaW5jbHVkaW5nIHRoZSBlbmRpbmcgSFRNTCB0YWcgd2hlcmUgKipuZy1yZXBlYXQtZW5kKiogaXMgcGxhY2VkLgogICAgICoKICAgICAqIFRoZSBleGFtcGxlIGJlbG93IG1ha2VzIHVzZSBvZiB0aGlzIGZlYXR1cmU6CiAgICAgKiA8cHJlPgogICAgICogICA8aGVhZGVyIG5nLXJlcGVhdC1zdGFydD0iaXRlbSBpbiBpdGVtcyI+CiAgICAgKiAgICAgSGVhZGVyIHt7IGl0ZW0gfX0KICAgICAqICAgPC9oZWFkZXI+CiAgICAgKiAgIDxkaXYgY2xhc3M9ImJvZHkiPgogICAgICogICAgIEJvZHkge3sgaXRlbSB9fQogICAgICogICA8L2Rpdj4KICAgICAqICAgPGZvb3RlciBuZy1yZXBlYXQtZW5kPgogICAgICogICAgIEZvb3RlciB7eyBpdGVtIH19CiAgICAgKiAgIDwvZm9vdGVyPgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQW5kIHdpdGggYW4gaW5wdXQgb2Yge0B0eXBlIFsnQScsJ0InXX0gZm9yIHRoZSBpdGVtcyB2YXJpYWJsZSBpbiB0aGUgZXhhbXBsZSBhYm92ZSwgdGhlIG91dHB1dCB3aWxsIGV2YWx1YXRlIHRvOgogICAgICogPHByZT4KICAgICAqICAgPGhlYWRlcj4KICAgICAqICAgICBIZWFkZXIgQQogICAgICogICA8L2hlYWRlcj4KICAgICAqICAgPGRpdiBjbGFzcz0iYm9keSI+CiAgICAgKiAgICAgQm9keSBBCiAgICAgKiAgIDwvZGl2PgogICAgICogICA8Zm9vdGVyPgogICAgICogICAgIEZvb3RlciBBCiAgICAgKiAgIDwvZm9vdGVyPgogICAgICogICA8aGVhZGVyPgogICAgICogICAgIEhlYWRlciBCCiAgICAgKiAgIDwvaGVhZGVyPgogICAgICogICA8ZGl2IGNsYXNzPSJib2R5Ij4KICAgICAqICAgICBCb2R5IEIKICAgICAqICAgPC9kaXY+CiAgICAgKiAgIDxmb290ZXI+CiAgICAgKiAgICAgRm9vdGVyIEIKICAgICAqICAgPC9mb290ZXI+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBUaGUgY3VzdG9tIHN0YXJ0IGFuZCBlbmQgcG9pbnRzIGZvciBuZ1JlcGVhdCBhbHNvIHN1cHBvcnQgYWxsIG90aGVyIEhUTUwgZGlyZWN0aXZlIHN5bnRheCBmbGF2b3JzIHByb3ZpZGVkIGluIEFuZ3VsYXJKUyAoc3VjaAogICAgICogYXMgKipkYXRhLW5nLXJlcGVhdC1zdGFydCoqLCAqKngtbmctcmVwZWF0LXN0YXJ0KiogYW5kICoqbmc6cmVwZWF0LXN0YXJ0KiopLgogICAgICoKICAgICAqIEBhbmltYXRpb25zCiAgICAgKiBlbnRlciAtIHdoZW4gYSBuZXcgaXRlbSBpcyBhZGRlZCB0byB0aGUgbGlzdCBvciB3aGVuIGFuIGl0ZW0gaXMgcmV2ZWFsZWQgYWZ0ZXIgYSBmaWx0ZXIKICAgICAqIGxlYXZlIC0gd2hlbiBhbiBpdGVtIGlzIHJlbW92ZWQgZnJvbSB0aGUgbGlzdCBvciB3aGVuIGFuIGl0ZW0gaXMgZmlsdGVyZWQgb3V0CiAgICAgKiBtb3ZlIC0gd2hlbiBhbiBhZGphY2VudCBpdGVtIGlzIGZpbHRlcmVkIG91dCBjYXVzaW5nIGEgcmVvcmRlciBvciB3aGVuIHRoZSBpdGVtIGNvbnRlbnRzIGFyZSByZW9yZGVyZWQKICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBzY29wZQogICAgICogQHByaW9yaXR5IDEwMDAKICAgICAqIEBwYXJhbSB7cmVwZWF0X2V4cHJlc3Npb259IG5nUmVwZWF0IFRoZSBleHByZXNzaW9uIGluZGljYXRpbmcgaG93IHRvIGVudW1lcmF0ZSBhIGNvbGxlY3Rpb24uIFRoZXNlCiAgICAgKiAgIGZvcm1hdHMgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQ6CiAgICAgKgogICAgICogICAqIGB2YXJpYWJsZSBpbiBleHByZXNzaW9uYCDigJMgd2hlcmUgdmFyaWFibGUgaXMgdGhlIHVzZXIgZGVmaW5lZCBsb29wIHZhcmlhYmxlIGFuZCBgZXhwcmVzc2lvbmAKICAgICAqICAgICBpcyBhIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICAgICAqCiAgICAgKiAgICAgRm9yIGV4YW1wbGU6IGBhbGJ1bSBpbiBhcnRpc3QuYWxidW1zYC4KICAgICAqCiAgICAgKiAgICogYChrZXksIHZhbHVlKSBpbiBleHByZXNzaW9uYCDigJMgd2hlcmUgYGtleWAgYW5kIGB2YWx1ZWAgY2FuIGJlIGFueSB1c2VyIGRlZmluZWQgaWRlbnRpZmllcnMsCiAgICAgKiAgICAgYW5kIGBleHByZXNzaW9uYCBpcyB0aGUgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogICAgICoKICAgICAqICAgICBGb3IgZXhhbXBsZTogYChuYW1lLCBhZ2UpIGluIHsnYWRhbSc6MTAsICdhbWFsaWUnOjEyfWAuCiAgICAgKgogICAgICogICAqIGB2YXJpYWJsZSBpbiBleHByZXNzaW9uIHRyYWNrIGJ5IHRyYWNraW5nX2V4cHJlc3Npb25gIOKAkyBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCB0cmFja2luZyBmdW5jdGlvbgogICAgICogICAgIHdoaWNoIGNhbiBiZSB1c2VkIHRvIGFzc29jaWF0ZSB0aGUgb2JqZWN0cyBpbiB0aGUgY29sbGVjdGlvbiB3aXRoIHRoZSBET00gZWxlbWVudHMuIElmIG5vIHRyYWNraW5nIGZ1bmN0aW9uCiAgICAgKiAgICAgaXMgc3BlY2lmaWVkIHRoZSBuZy1yZXBlYXQgYXNzb2NpYXRlcyBlbGVtZW50cyBieSBpZGVudGl0eSBpbiB0aGUgY29sbGVjdGlvbi4gSXQgaXMgYW4gZXJyb3IgdG8gaGF2ZQogICAgICogICAgIG1vcmUgdGhhbiBvbmUgdHJhY2tpbmcgZnVuY3Rpb24gdG8gcmVzb2x2ZSB0byB0aGUgc2FtZSBrZXkuIChUaGlzIHdvdWxkIG1lYW4gdGhhdCB0d28gZGlzdGluY3Qgb2JqZWN0cyBhcmUKICAgICAqICAgICBtYXBwZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQsIHdoaWNoIGlzIG5vdCBwb3NzaWJsZS4pICBGaWx0ZXJzIHNob3VsZCBiZSBhcHBsaWVkIHRvIHRoZSBleHByZXNzaW9uLAogICAgICogICAgIGJlZm9yZSBzcGVjaWZ5aW5nIGEgdHJhY2tpbmcgZXhwcmVzc2lvbi4KICAgICAqCiAgICAgKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zYCBpcyBlcXVpdmFsZW50IHRvIGBpdGVtIGluIGl0ZW1zIHRyYWNrIGJ5ICRpZChpdGVtKScuIFRoaXMgaW1wbGllcyB0aGF0IHRoZSBET00gZWxlbWVudHMKICAgICAqICAgICB3aWxsIGJlIGFzc29jaWF0ZWQgYnkgaXRlbSBpZGVudGl0eSBpbiB0aGUgYXJyYXkuCiAgICAgKgogICAgICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSAkaWQoaXRlbSlgLiBBIGJ1aWx0IGluIGAkaWQoKWAgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gYXNzaWduIGEgdW5pcXVlCiAgICAgKiAgICAgYCQkaGFzaEtleWAgcHJvcGVydHkgdG8gZWFjaCBpdGVtIGluIHRoZSBhcnJheS4gVGhpcyBwcm9wZXJ0eSBpcyB0aGVuIHVzZWQgYXMgYSBrZXkgdG8gYXNzb2NpYXRlZCBET00gZWxlbWVudHMKICAgICAqICAgICB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIGl0ZW0gaW4gdGhlIGFycmF5IGJ5IGlkZW50aXR5LiBNb3ZpbmcgdGhlIHNhbWUgb2JqZWN0IGluIGFycmF5IHdvdWxkIG1vdmUgdGhlIERPTQogICAgICogICAgIGVsZW1lbnQgaW4gdGhlIHNhbWUgd2F5IGlhbiB0aGUgRE9NLgogICAgICoKICAgICAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXMgdHJhY2sgYnkgaXRlbS5pZGAgaXMgYSB0eXBpY2FsIHBhdHRlcm4gd2hlbiB0aGUgaXRlbXMgY29tZSBmcm9tIHRoZSBkYXRhYmFzZS4gSW4gdGhpcwogICAgICogICAgIGNhc2UgdGhlIG9iamVjdCBpZGVudGl0eSBkb2VzIG5vdCBtYXR0ZXIuIFR3byBvYmplY3RzIGFyZSBjb25zaWRlcmVkIGVxdWl2YWxlbnQgYXMgbG9uZyBhcyB0aGVpciBgaWRgCiAgICAgKiAgICAgcHJvcGVydHkgaXMgc2FtZS4KICAgICAqCiAgICAgKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHwgZmlsdGVyOnNlYXJjaFRleHQgdHJhY2sgYnkgaXRlbS5pZGAgaXMgYSBwYXR0ZXJuIHRoYXQgbWlnaHQgYmUgdXNlZCB0byBhcHBseSBhIGZpbHRlcgogICAgICogICAgIHRvIGl0ZW1zIGluIGNvbmp1bmN0aW9uIHdpdGggYSB0cmFja2luZyBleHByZXNzaW9uLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiBUaGlzIGV4YW1wbGUgaW5pdGlhbGl6ZXMgdGhlIHNjb3BlIHRvIGEgbGlzdCBvZiBuYW1lcyBhbmQKICAgICAqIHRoZW4gdXNlcyBgbmdSZXBlYXRgIHRvIGRpc3BsYXkgZXZlcnkgcGVyc29uOgogICAgICA8ZXhhbXBsZSBhbmltYXRpb25zPSJ0cnVlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgIDxkaXYgbmctaW5pdD0iZnJpZW5kcyA9IFsKICAgICAgICAgICAge25hbWU6J0pvaG4nLCBhZ2U6MjUsIGdlbmRlcjonYm95J30sCiAgICAgICAgICAgIHtuYW1lOidKZXNzaWUnLCBhZ2U6MzAsIGdlbmRlcjonZ2lybCd9LAogICAgICAgICAgICB7bmFtZTonSm9oYW5uYScsIGFnZToyOCwgZ2VuZGVyOidnaXJsJ30sCiAgICAgICAgICAgIHtuYW1lOidKb3knLCBhZ2U6MTUsIGdlbmRlcjonZ2lybCd9LAogICAgICAgICAgICB7bmFtZTonTWFyeScsIGFnZToyOCwgZ2VuZGVyOidnaXJsJ30sCiAgICAgICAgICAgIHtuYW1lOidQZXRlcicsIGFnZTo5NSwgZ2VuZGVyOidib3knfSwKICAgICAgICAgICAge25hbWU6J1NlYmFzdGlhbicsIGFnZTo1MCwgZ2VuZGVyOidib3knfSwKICAgICAgICAgICAge25hbWU6J0VyaWthJywgYWdlOjI3LCBnZW5kZXI6J2dpcmwnfSwKICAgICAgICAgICAge25hbWU6J1BhdHJpY2snLCBhZ2U6NDAsIGdlbmRlcjonYm95J30sCiAgICAgICAgICAgIHtuYW1lOidTYW1hbnRoYScsIGFnZTo2MCwgZ2VuZGVyOidnaXJsJ30KICAgICAgICAgIF0iPgogICAgICAgICAgICBJIGhhdmUge3tmcmllbmRzLmxlbmd0aH19IGZyaWVuZHMuIFRoZXkgYXJlOgogICAgICAgICAgICA8aW5wdXQgdHlwZT0ic2VhcmNoIiBuZy1tb2RlbD0icSIgcGxhY2Vob2xkZXI9ImZpbHRlciBmcmllbmRzLi4uIiAvPgogICAgICAgICAgICA8dWwgY2xhc3M9ImV4YW1wbGUtYW5pbWF0ZS1jb250YWluZXIiPgogICAgICAgICAgICAgIDxsaSBjbGFzcz0iYW5pbWF0ZS1yZXBlYXQiIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBmaWx0ZXI6cSI+CiAgICAgICAgICAgICAgICBbe3skaW5kZXggKyAxfX1dIHt7ZnJpZW5kLm5hbWV9fSB3aG8gaXMge3tmcmllbmQuYWdlfX0geWVhcnMgb2xkLgogICAgICAgICAgICAgIDwvbGk+CiAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAgICAgLmV4YW1wbGUtYW5pbWF0ZS1jb250YWluZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgICAgICBsaXN0LXN0eWxlOm5vbmU7CiAgICAgICAgICAgIG1hcmdpbjowOwogICAgICAgICAgICBwYWRkaW5nOjA7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5leGFtcGxlLWFuaW1hdGUtY29udGFpbmVyID4gbGkgewogICAgICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgICAgIGxpc3Qtc3R5bGU6bm9uZTsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWVudGVyLAogICAgICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlLAogICAgICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLW1vdmUgewogICAgICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgICAtbW96LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgICAtby10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgICAgdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1lbnRlciB7CiAgICAgICAgICAgIGxpbmUtaGVpZ2h0OjA7CiAgICAgICAgICAgIG9wYWNpdHk6MDsKICAgICAgICAgICAgcGFkZGluZy10b3A6MDsKICAgICAgICAgICAgcGFkZGluZy1ib3R0b206MDsKICAgICAgICAgIH0KICAgICAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogICAgICAgICAgICBsaW5lLWhlaWdodDoyMHB4OwogICAgICAgICAgICBvcGFjaXR5OjE7CiAgICAgICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlIHsKICAgICAgICAgICAgb3BhY2l0eToxOwogICAgICAgICAgICBsaW5lLWhlaWdodDoyMHB4OwogICAgICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgICB9CiAgICAgICAgICAuYW5pbWF0ZS1yZXBlYXQubmctbGVhdmUubmctbGVhdmUtYWN0aXZlIHsKICAgICAgICAgICAgb3BhY2l0eTowOwogICAgICAgICAgICBsaW5lLWhlaWdodDowOwogICAgICAgICAgICBwYWRkaW5nLXRvcDowOwogICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTowOwogICAgICAgICAgfQogICAgCiAgICAgICAgICAuYW5pbWF0ZS1yZXBlYXQubmctbW92ZSB7IH0KICAgICAgICAgIC5hbmltYXRlLXJlcGVhdC5uZy1tb3ZlLm5nLW1vdmUtYWN0aXZlIHsgfQogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgaXQoJ3Nob3VsZCByZW5kZXIgaW5pdGlhbCBkYXRhIHNldCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgdmFyIHIgPSB1c2luZygnLmRvYy1leGFtcGxlLWxpdmUnKS5yZXBlYXRlcigndWwgbGknKTsKICAgICAgICAgICAgIGV4cGVjdChyLmNvdW50KCkpLnRvQmUoMTApOwogICAgICAgICAgICAgZXhwZWN0KHIucm93KDApKS50b0VxdWFsKFsiMSIsIkpvaG4iLCIyNSJdKTsKICAgICAgICAgICAgIGV4cGVjdChyLnJvdygxKSkudG9FcXVhbChbIjIiLCJKZXNzaWUiLCIzMCJdKTsKICAgICAgICAgICAgIGV4cGVjdChyLnJvdyg5KSkudG9FcXVhbChbIjEwIiwiU2FtYW50aGEiLCI2MCJdKTsKICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCdmcmllbmRzLmxlbmd0aCcpKS50b0JlKCIxMCIpOwogICAgICAgICAgIH0pOwogICAgCiAgICAgICAgICAgaXQoJ3Nob3VsZCB1cGRhdGUgcmVwZWF0ZXIgd2hlbiBmaWx0ZXIgcHJlZGljYXRlIGNoYW5nZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgIHZhciByID0gdXNpbmcoJy5kb2MtZXhhbXBsZS1saXZlJykucmVwZWF0ZXIoJ3VsIGxpJyk7CiAgICAgICAgICAgICBleHBlY3Qoci5jb3VudCgpKS50b0JlKDEwKTsKICAgIAogICAgICAgICAgICAgaW5wdXQoJ3EnKS5lbnRlcignbWEnKTsKICAgIAogICAgICAgICAgICAgZXhwZWN0KHIuY291bnQoKSkudG9CZSgyKTsKICAgICAgICAgICAgIGV4cGVjdChyLnJvdygwKSkudG9FcXVhbChbIjEiLCJNYXJ5IiwiMjgiXSk7CiAgICAgICAgICAgICBleHBlY3Qoci5yb3coMSkpLnRvRXF1YWwoWyIyIiwiU2FtYW50aGEiLCI2MCJdKTsKICAgICAgICAgICB9KTsKICAgICAgICAgIDwvZmlsZT4KICAgICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ1JlcGVhdERpcmVjdGl2ZSA9IFsnJHBhcnNlJywgJyRhbmltYXRlJywgZnVuY3Rpb24gKCRwYXJzZSwgJGFuaW1hdGUpIHsKICAgICAgICB2YXIgTkdfUkVNT1ZFRCA9ICckJE5HX1JFTU9WRUQnOwogICAgICAgIHZhciBuZ1JlcGVhdE1pbkVyciA9IG1pbkVycignbmdSZXBlYXQnKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgICAgIHByaW9yaXR5OiAxMDAwLAogICAgICAgICAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIsIGxpbmtlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgkc2NvcGUsICRlbGVtZW50LCAkYXR0cikgewogICAgICAgICAgICAgICAgICAgIHZhciBleHByZXNzaW9uID0gJGF0dHIubmdSZXBlYXQ7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZXhwcmVzc2lvbi5tYXRjaCgvXlxzKiguKylccytpblxzKyguKj8pXHMqKFxzK3RyYWNrXHMrYnlccysoLispXHMqKT8kLyksCiAgICAgICAgICAgICAgICAgICAgICB0cmFja0J5RXhwLCB0cmFja0J5RXhwR2V0dGVyLCB0cmFja0J5SWRGbiwgdHJhY2tCeUlkQXJyYXlGbiwgdHJhY2tCeUlkT2JqRm4sIGxocywgcmhzLCB2YWx1ZUlkZW50aWZpZXIsIGtleUlkZW50aWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICBoYXNoRm5Mb2NhbHMgPSB7ICRpZDogaGFzaEtleSB9OwoKICAgICAgICAgICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5nUmVwZWF0TWluRXJyKCdpZXhwJywgIkV4cGVjdGVkIGV4cHJlc3Npb24gaW4gZm9ybSBvZiAnX2l0ZW1fIGluIF9jb2xsZWN0aW9uX1sgdHJhY2sgYnkgX2lkX10nIGJ1dCBnb3QgJ3swfScuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBleHByZXNzaW9uKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxocyA9IG1hdGNoWzFdOwogICAgICAgICAgICAgICAgICAgIHJocyA9IG1hdGNoWzJdOwogICAgICAgICAgICAgICAgICAgIHRyYWNrQnlFeHAgPSBtYXRjaFs0XTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrQnlFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tCeUV4cEdldHRlciA9ICRwYXJzZSh0cmFja0J5RXhwKTsKICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tCeUlkRm4gPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFzc2lnbiBrZXksIHZhbHVlLCBhbmQgJGluZGV4IHRvIHRoZSBsb2NhbHMgc28gdGhhdCB0aGV5IGNhbiBiZSB1c2VkIGluIGhhc2ggZnVuY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5SWRlbnRpZmllcikgaGFzaEZuTG9jYWxzW2tleUlkZW50aWZpZXJdID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzaEZuTG9jYWxzW3ZhbHVlSWRlbnRpZmllcl0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hGbkxvY2Fscy4kaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cmFja0J5RXhwR2V0dGVyKCRzY29wZSwgaGFzaEZuTG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0cmFja0J5SWRBcnJheUZuID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBoYXNoS2V5KHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0cmFja0J5SWRPYmpGbiA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIG1hdGNoID0gbGhzLm1hdGNoKC9eKD86KFtcJFx3XSspfFwoKFtcJFx3XSspXHMqLFxzKihbXCRcd10rKVwpKSQvKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5nUmVwZWF0TWluRXJyKCdpaWRleHAnLCAiJ19pdGVtXycgaW4gJ19pdGVtXyBpbiBfY29sbGVjdGlvbl8nIHNob3VsZCBiZSBhbiBpZGVudGlmaWVyIG9yICcoX2tleV8sIF92YWx1ZV8pJyBleHByZXNzaW9uLCBidXQgZ290ICd7MH0nLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YWx1ZUlkZW50aWZpZXIgPSBtYXRjaFszXSB8fCBtYXRjaFsxXTsKICAgICAgICAgICAgICAgICAgICBrZXlJZGVudGlmaWVyID0gbWF0Y2hbMl07CgogICAgICAgICAgICAgICAgICAgIC8vIFN0b3JlIGEgbGlzdCBvZiBlbGVtZW50cyBmcm9tIHByZXZpb3VzIHJ1bi4gVGhpcyBpcyBhIGhhc2ggd2hlcmUga2V5IGlzIHRoZSBpdGVtIGZyb20gdGhlCiAgICAgICAgICAgICAgICAgICAgLy8gaXRlcmF0b3IsIGFuZCB0aGUgdmFsdWUgaXMgb2JqZWN0cyB3aXRoIGZvbGxvd2luZyBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgICAgIC8vICAgLSBzY29wZTogYm91bmQgc2NvcGUKICAgICAgICAgICAgICAgICAgICAvLyAgIC0gZWxlbWVudDogcHJldmlvdXMgZWxlbWVudC4KICAgICAgICAgICAgICAgICAgICAvLyAgIC0gaW5kZXg6IHBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RCbG9ja01hcCA9IHt9OwoKICAgICAgICAgICAgICAgICAgICAvL3dhdGNoIHByb3BzCiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaENvbGxlY3Rpb24ocmhzLCBmdW5jdGlvbiBuZ1JlcGVhdEFjdGlvbihjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbmRleCwgbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNOb2RlID0gJGVsZW1lbnRbMF0sICAgICAvLyBjdXJyZW50IHBvc2l0aW9uIG9mIHRoZSBub2RlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm9kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNhbWUgYXMgbGFzdEJsb2NrTWFwIGJ1dCBpdCBoYXMgdGhlIGN1cnJlbnQgc3RhdGUuIEl0IHdpbGwgYmVjb21lIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGFzdEJsb2NrTWFwIG9uIHRoZSBuZXh0IGl0ZXJhdGlvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRCbG9ja01hcCA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlMZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5LCB2YWx1ZSwgLy8ga2V5L3ZhbHVlIG9mIGl0ZXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tCeUlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbktleXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9jaywgICAgICAgLy8gbGFzdCBvYmplY3QgaW5mb3JtYXRpb24ge3Njb3BlLCBlbGVtZW50LCBpZH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRCbG9ja09yZGVyID0gW107CgoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXlMaWtlKGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uS2V5cyA9IGNvbGxlY3Rpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFja0J5SWRGbiA9IHRyYWNrQnlJZEZuIHx8IHRyYWNrQnlJZEFycmF5Rm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFja0J5SWRGbiA9IHRyYWNrQnlJZEZuIHx8IHRyYWNrQnlJZE9iakZuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgb2JqZWN0LCBleHRyYWN0IGtleXMsIHNvcnQgdGhlbSBhbmQgdXNlIHRvIGRldGVybWluZSBvcmRlciBvZiBpdGVyYXRpb24gb3ZlciBvYmogcHJvcHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3Rpb25LZXlzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbGxlY3Rpb24uaGFzT3duUHJvcGVydHkoa2V5KSAmJiBrZXkuY2hhckF0KDApICE9ICckJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uS2V5cy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbktleXMuc29ydCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBhcnJheUxlbmd0aCA9IGNvbGxlY3Rpb25LZXlzLmxlbmd0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxvY2F0ZSBleGlzdGluZyBpdGVtcwogICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSBuZXh0QmxvY2tPcmRlci5sZW5ndGggPSBjb2xsZWN0aW9uS2V5cy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gKGNvbGxlY3Rpb24gPT09IGNvbGxlY3Rpb25LZXlzKSA/IGluZGV4IDogY29sbGVjdGlvbktleXNbaW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFja0J5SWQgPSB0cmFja0J5SWRGbihrZXksIHZhbHVlLCBpbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEJsb2NrTWFwLmhhc093blByb3BlcnR5KHRyYWNrQnlJZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9jayA9IGxhc3RCbG9ja01hcFt0cmFja0J5SWRdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGxhc3RCbG9ja01hcFt0cmFja0J5SWRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRCbG9ja01hcFt0cmFja0J5SWRdID0gYmxvY2s7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dEJsb2NrT3JkZXJbaW5kZXhdID0gYmxvY2s7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRCbG9ja01hcC5oYXNPd25Qcm9wZXJ0eSh0cmFja0J5SWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVzdG9yZSBsYXN0QmxvY2tNYXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKG5leHRCbG9ja09yZGVyLCBmdW5jdGlvbiAoYmxvY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrICYmIGJsb2NrLnN0YXJ0Tm9kZSkgbGFzdEJsb2NrTWFwW2Jsb2NrLmlkXSA9IGJsb2NrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBkdXBsaWNhdGUgYW5kIHdlIG5lZWQgdG8gdGhyb3cgYW4gZXJyb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZ1JlcGVhdE1pbkVycignZHVwZXMnLCAiRHVwbGljYXRlcyBpbiBhIHJlcGVhdGVyIGFyZSBub3QgYWxsb3dlZC4gVXNlICd0cmFjayBieScgZXhwcmVzc2lvbiB0byBzcGVjaWZ5IHVuaXF1ZSBrZXlzLiBSZXBlYXRlcjogezB9LCBEdXBsaWNhdGUga2V5OiB7MX0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24sIHRyYWNrQnlJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5ldyBuZXZlciBiZWZvcmUgc2VlbiBibG9jawogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRCbG9ja09yZGVyW2luZGV4XSA9IHsgaWQ6IHRyYWNrQnlJZCB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRCbG9ja01hcFt0cmFja0J5SWRdID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBleGlzdGluZyBpdGVtcwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBsYXN0QmxvY2tNYXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0QmxvY2tNYXAuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrID0gbGFzdEJsb2NrTWFwW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoYmxvY2suZWxlbWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goYmxvY2suZWxlbWVudHMsIGZ1bmN0aW9uIChlbGVtZW50KSB7IGVsZW1lbnRbTkdfUkVNT1ZFRF0gPSB0cnVlIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrLnNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBub3QgdXNpbmcgZm9yRWFjaCBmb3IgcGVyZiByZWFzb25zICh0cnlpbmcgdG8gYXZvaWQgI2NhbGwpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAwLCBsZW5ndGggPSBjb2xsZWN0aW9uS2V5cy5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSAoY29sbGVjdGlvbiA9PT0gY29sbGVjdGlvbktleXMpID8gaW5kZXggOiBjb2xsZWN0aW9uS2V5c1tpbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrID0gbmV4dEJsb2NrT3JkZXJbaW5kZXhdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChibG9jay5zdGFydE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB3ZSBoYXZlIGFscmVhZHkgc2VlbiB0aGlzIG9iamVjdCwgdGhlbiB3ZSBuZWVkIHRvIHJldXNlIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFzc29jaWF0ZWQgc2NvcGUvZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBibG9jay5zY29wZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBwcmV2aW91c05vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG5leHROb2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKG5leHROb2RlICYmIG5leHROb2RlW05HX1JFTU9WRURdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrLnN0YXJ0Tm9kZSA9PSBuZXh0Tm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkbyBub3RoaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXhpc3RpbmcgaXRlbSB3aGljaCBnb3QgbW92ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUubW92ZShibG9jay5lbGVtZW50cywgbnVsbCwganFMaXRlKHByZXZpb3VzTm9kZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05vZGUgPSBibG9jay5lbmROb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBuZXcgaXRlbSB3aGljaCB3ZSBkb24ndCBrbm93IGFib3V0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9ICRzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZVt2YWx1ZUlkZW50aWZpZXJdID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5SWRlbnRpZmllcikgY2hpbGRTY29wZVtrZXlJZGVudGlmaWVyXSA9IGtleTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRmaXJzdCA9IChpbmRleCA9PT0gMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRsYXN0ID0gKGluZGV4ID09PSAoYXJyYXlMZW5ndGggLSAxKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlLiRtaWRkbGUgPSAhKGNoaWxkU2NvcGUuJGZpcnN0IHx8IGNoaWxkU2NvcGUuJGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZS4kb2RkID0gIShjaGlsZFNjb3BlLiRldmVuID0gaW5kZXggJSAyID09IDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYmxvY2suc3RhcnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua2VyKGNoaWxkU2NvcGUsIGZ1bmN0aW9uIChjbG9uZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjbG9uZSwgbnVsbCwganFMaXRlKHByZXZpb3VzTm9kZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05vZGUgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2suc2NvcGUgPSBjaGlsZFNjb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9jay5zdGFydE5vZGUgPSBjbG9uZVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2suZWxlbWVudHMgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2suZW5kTm9kZSA9IGNsb25lW2Nsb25lLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0QmxvY2tNYXBbYmxvY2suaWRdID0gYmxvY2s7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEJsb2NrTWFwID0gbmV4dEJsb2NrTWFwOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1Nob3cKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgbmdTaG93YCBkaXJlY3RpdmUgc2hvd3MgYW5kIGhpZGVzIHRoZSBnaXZlbiBIVE1MIGVsZW1lbnQgY29uZGl0aW9uYWxseSBiYXNlZCBvbiB0aGUgZXhwcmVzc2lvbgogICAgICogcHJvdmlkZWQgdG8gdGhlIG5nU2hvdyBhdHRyaWJ1dGUuIFRoZSBzaG93IGFuZCBoaWRlIG1lY2hhbmlzbSBpcyBhIGFjaGlldmVkIGJ5IHJlbW92aW5nIGFuZCBhZGRpbmcKICAgICAqIHRoZSBgbmctaGlkZWAgQ1NTIGNsYXNzIG9udG8gdGhlIGVsZW1lbnQuIFRoZSBgLm5nLWhpZGVgIENTUyBjbGFzcyBpcyBhIHByZWRlZmluZWQgQ1NTIGNsYXNzIHByZXNlbnQKICAgICAqIGluIEFuZ3VsYXJKUyB3aGljaCBzZXRzIHRoZSBkaXNwbGF5IHN0eWxlIHRvIG5vbmUgKHVzaW5nIGFuICFpbXBvcnRhbnQgZmxhZykuCiAgICAgKgogICAgICogPHByZT4KICAgICAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyB0cnV0aHkgKGVsZW1lbnQgaXMgdmlzaWJsZSkgLS0+CiAgICAgKiA8ZGl2IG5nLXNob3c9Im15VmFsdWUiPjwvZGl2PgogICAgICoKICAgICAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyBmYWxzeSAoZWxlbWVudCBpcyBoaWRkZW4pIC0tPgogICAgICogPGRpdiBuZy1zaG93PSJteVZhbHVlIiBjbGFzcz0ibmctaGlkZSI+PC9kaXY+CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBXaGVuIHRoZSBuZ1Nob3cgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gZmFsc2UgdGhlbiB0aGUgbmctaGlkZSBDU1MgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGNsYXNzIGF0dHJpYnV0ZQogICAgICogb24gdGhlIGVsZW1lbnQgY2F1c2luZyBpdCB0byBiZWNvbWUgaGlkZGVuLiBXaGVuIHRydWUsIHRoZSBuZy1oaWRlIENTUyBjbGFzcyBpcyByZW1vdmVkCiAgICAgKiBmcm9tIHRoZSBlbGVtZW50IGNhdXNpbmcgdGhlIGVsZW1lbnQgbm90IHRvIGFwcGVhciBoaWRkZW4uCiAgICAgKgogICAgICogIyMgV2h5IGlzICFpbXBvcnRhbnQgdXNlZD8KICAgICAqCiAgICAgKiBZb3UgbWF5IGJlIHdvbmRlcmluZyB3aHkgIWltcG9ydGFudCBpcyB1c2VkIGZvciB0aGUgLm5nLWhpZGUgQ1NTIGNsYXNzLiBUaGlzIGlzIGJlY2F1c2UgdGhlIGAubmctaGlkZWAgc2VsZWN0b3IKICAgICAqIGNhbiBiZSBlYXNpbHkgb3ZlcnJpZGRlbiBieSBoZWF2aWVyIHNlbGVjdG9ycy4gRm9yIGV4YW1wbGUsIHNvbWV0aGluZyBhcyBzaW1wbGUKICAgICAqIGFzIGNoYW5naW5nIHRoZSBkaXNwbGF5IHN0eWxlIG9uIGEgSFRNTCBsaXN0IGl0ZW0gd291bGQgbWFrZSBoaWRkZW4gZWxlbWVudHMgYXBwZWFyIHZpc2libGUuCiAgICAgKiBUaGlzIGFsc28gYmVjb21lcyBhIGJpZ2dlciBpc3N1ZSB3aGVuIGRlYWxpbmcgd2l0aCBDU1MgZnJhbWV3b3Jrcy4KICAgICAqCiAgICAgKiBCeSB1c2luZyAhaW1wb3J0YW50LCB0aGUgc2hvdyBhbmQgaGlkZSBiZWhhdmlvciB3aWxsIHdvcmsgYXMgZXhwZWN0ZWQgZGVzcGl0ZSBhbnkgY2xhc2ggYmV0d2VlbiBDU1Mgc2VsZWN0b3IKICAgICAqIHNwZWNpZmljaXR5ICh3aGVuICFpbXBvcnRhbnQgaXNuJ3QgdXNlZCB3aXRoIGFueSBjb25mbGljdGluZyBzdHlsZXMpLiBJZiBhIGRldmVsb3BlciBjaG9vc2VzIHRvIG92ZXJyaWRlIHRoZQogICAgICogc3R5bGluZyB0byBjaGFuZ2UgaG93IHRvIGhpZGUgYW4gZWxlbWVudCB0aGVuIGl0IGlzIGp1c3QgYSBtYXR0ZXIgb2YgdXNpbmcgIWltcG9ydGFudCBpbiB0aGVpciBvd24gQ1NTIGNvZGUuCiAgICAgKgogICAgICogIyMjIE92ZXJyaWRpbmcgLm5nLWhpZGUKICAgICAqCiAgICAgKiBJZiB5b3Ugd2lzaCB0byBjaGFuZ2UgdGhlIGhpZGUgYmVoYXZpb3Igd2l0aCBuZ1Nob3cvbmdIaWRlIHRoZW4gdGhpcyBjYW4gYmUgYWNoaWV2ZWQgYnkKICAgICAqIHJlc3RhdGluZyB0aGUgc3R5bGVzIGZvciB0aGUgLm5nLWhpZGUgY2xhc3MgaW4gQ1NTOgogICAgICogPHByZT4KICAgICAqIC5uZy1oaWRlIHsKICAgICAqICAgLy8hYW5ub3RhdGUgQ1NTIFNwZWNpZmljaXR5fE5vdCB0byB3b3JyeSwgdGhpcyB3aWxsIG92ZXJyaWRlIHRoZSBBbmd1bGFySlMgZGVmYXVsdC4uLgogICAgICogICBkaXNwbGF5OmJsb2NrIWltcG9ydGFudDsKICAgICAqCiAgICAgKiAgIC8vdGhpcyBpcyBqdXN0IGFub3RoZXIgZm9ybSBvZiBoaWRpbmcgYW4gZWxlbWVudAogICAgICogICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgICAqICAgdG9wOi05OTk5cHg7CiAgICAgKiAgIGxlZnQ6LTk5OTlweDsKICAgICAqIH0KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEp1c3QgcmVtZW1iZXIgdG8gaW5jbHVkZSB0aGUgaW1wb3J0YW50IGZsYWcgc28gdGhlIENTUyBvdmVycmlkZSB3aWxsIGZ1bmN0aW9uLgogICAgICoKICAgICAqICMjIEEgbm90ZSBhYm91dCBhbmltYXRpb25zIHdpdGggbmdTaG93CiAgICAgKgogICAgICogQW5pbWF0aW9ucyBpbiBuZ1Nob3cvbmdIaWRlIHdvcmsgd2l0aCB0aGUgc2hvdyBhbmQgaGlkZSBldmVudHMgdGhhdCBhcmUgdHJpZ2dlcmVkIHdoZW4gdGhlIGRpcmVjdGl2ZSBleHByZXNzaW9uCiAgICAgKiBpcyB0cnVlIGFuZCBmYWxzZS4gVGhpcyBzeXN0ZW0gd29ya3Mgc2ltaWxhciB0byB0aGUgYW5pbWF0aW9uIHN5c3RlbSBwcmVzZW50IHdpdGggbmdDbGFzcywgaG93ZXZlciwgdGhlCiAgICAgKiBvbmx5IGRpZmZlcmVuY2UgaXMgdGhhdCB5b3UgbXVzdCBhbHNvIGluY2x1ZGUgdGhlICFpbXBvcnRhbnQgZmxhZyB0byBvdmVycmlkZSB0aGUgZGlzcGxheSBwcm9wZXJ0eSBzbwogICAgICogdGhhdCB5b3UgY2FuIHBlcmZvcm0gYW4gYW5pbWF0aW9uIHdoZW4gdGhlIGVsZW1lbnQgaXMgaGlkZGVuIGR1cmluZyB0aGUgdGltZSBvZiB0aGUgYW5pbWF0aW9uLgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiAvLwogICAgICogLy9hIHdvcmtpbmcgZXhhbXBsZSBjYW4gYmUgZm91bmQgYXQgdGhlIGJvdHRvbSBvZiB0aGlzIHBhZ2UKICAgICAqIC8vCiAgICAgKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCwgLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgewogICAgICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICAgICAqICAgZGlzcGxheTpibG9jayFpbXBvcnRhbnQ7CiAgICAgKiB9CiAgICAgKgogICAgICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQgeyAuLi4gfQogICAgICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQubmctaGlkZS1hZGQtYWN0aXZlIHsgLi4uIH0KICAgICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsgLi4uIH0KICAgICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlLm5nLWhpZGUtcmVtb3ZlLWFjdGl2ZSB7IC4uLiB9CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAYW5pbWF0aW9ucwogICAgICogYWRkQ2xhc3M6IC5uZy1oaWRlIC0gaGFwcGVucyBhZnRlciB0aGUgbmdTaG93IGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgdHJ1dGh5IHZhbHVlIGFuZCB0aGUganVzdCBiZWZvcmUgY29udGVudHMgYXJlIHNldCB0byB2aXNpYmxlCiAgICAgKiByZW1vdmVDbGFzczogLm5nLWhpZGUgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ1Nob3cgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSBub24gdHJ1dGh5IHZhbHVlIGFuZCBqdXN0IGJlZm9yZSB0aGUgY29udGVudHMgYXJlIHNldCB0byBoaWRkZW4KICAgICAqCiAgICAgKiBAZWxlbWVudCBBTlkKICAgICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTaG93IElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHkKICAgICAqICAgICB0aGVuIHRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiByZXNwZWN0aXZlbHkuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgPGV4YW1wbGUgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgICAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgIFNob3c6CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNoZWNrLWVsZW1lbnQgYW5pbWF0ZS1zaG93IiBuZy1zaG93PSJjaGVja2VkIj4KICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0iaWNvbi10aHVtYnMtdXAiPjwvc3Bhbj4gSSBzaG93IHVwIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdj4KICAgICAgICAgICAgSGlkZToKICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hlY2stZWxlbWVudCBhbmltYXRlLXNob3ciIG5nLWhpZGU9ImNoZWNrZWQiPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uLXRodW1icy1kb3duIj48L3NwYW4+IEkgaGlkZSB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAgICAgICAgLmFuaW1hdGUtc2hvdy5uZy1oaWRlLWFkZCwgCiAgICAgICAgICAuYW5pbWF0ZS1zaG93Lm5nLWhpZGUtcmVtb3ZlIHsKICAgICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgICAgLW1vei10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgICAgLW8tdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgICBkaXNwbGF5OmJsb2NrIWltcG9ydGFudDsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmFuaW1hdGUtc2hvdy5uZy1oaWRlLWFkZC5uZy1oaWRlLWFkZC1hY3RpdmUsCiAgICAgICAgICAuYW5pbWF0ZS1zaG93Lm5nLWhpZGUtcmVtb3ZlIHsKICAgICAgICAgICAgbGluZS1oZWlnaHQ6MDsKICAgICAgICAgICAgb3BhY2l0eTowOwogICAgICAgICAgICBwYWRkaW5nOjAgMTBweDsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmFuaW1hdGUtc2hvdy5uZy1oaWRlLWFkZCwKICAgICAgICAgIC5hbmltYXRlLXNob3cubmctaGlkZS1yZW1vdmUubmctaGlkZS1yZW1vdmUtYWN0aXZlIHsKICAgICAgICAgICAgbGluZS1oZWlnaHQ6MjBweDsKICAgICAgICAgICAgb3BhY2l0eToxOwogICAgICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5jaGVjay1lbGVtZW50IHsKICAgICAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgICAgfQogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zaG93IC8gbmctaGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBzcGFuOmxhc3Q6dmlzaWJsZScpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAKICAgICAgICAgICAgIGlucHV0KCdjaGVja2VkJykuY2hlY2soKTsKICAgIAogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW46Zmlyc3Q6dmlzaWJsZScpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbjpsYXN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ1Nob3dEaXJlY3RpdmUgPSBbJyRhbmltYXRlJywgZnVuY3Rpb24gKCRhbmltYXRlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1Nob3csIGZ1bmN0aW9uIG5nU2hvd1dhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAkYW5pbWF0ZVt0b0Jvb2xlYW4odmFsdWUpID8gJ3JlbW92ZUNsYXNzJyA6ICdhZGRDbGFzcyddKGVsZW1lbnQsICduZy1oaWRlJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICB9XTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdIaWRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nSGlkZWAgZGlyZWN0aXZlIHNob3dzIGFuZCBoaWRlcyB0aGUgZ2l2ZW4gSFRNTCBlbGVtZW50IGNvbmRpdGlvbmFsbHkgYmFzZWQgb24gdGhlIGV4cHJlc3Npb24KICAgICAqIHByb3ZpZGVkIHRvIHRoZSBuZ0hpZGUgYXR0cmlidXRlLiBUaGUgc2hvdyBhbmQgaGlkZSBtZWNoYW5pc20gaXMgYSBhY2hpZXZlZCBieSByZW1vdmluZyBhbmQgYWRkaW5nCiAgICAgKiB0aGUgYG5nLWhpZGVgIENTUyBjbGFzcyBvbnRvIHRoZSBlbGVtZW50LiBUaGUgYC5uZy1oaWRlYCBDU1MgY2xhc3MgaXMgYSBwcmVkZWZpbmVkIENTUyBjbGFzcyBwcmVzZW50CiAgICAgKiBpbiBBbmd1bGFySlMgd2hpY2ggc2V0cyB0aGUgZGlzcGxheSBzdHlsZSB0byBub25lICh1c2luZyBhbiAhaW1wb3J0YW50IGZsYWcpLgogICAgICoKICAgICAqIDxwcmU+CiAgICAgKiA8IS0tIHdoZW4gJHNjb3BlLm15VmFsdWUgaXMgdHJ1dGh5IChlbGVtZW50IGlzIGhpZGRlbikgLS0+CiAgICAgKiA8ZGl2IG5nLWhpZGU9Im15VmFsdWUiPjwvZGl2PgogICAgICoKICAgICAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyBmYWxzeSAoZWxlbWVudCBpcyB2aXNpYmxlKSAtLT4KICAgICAqIDxkaXYgbmctaGlkZT0ibXlWYWx1ZSIgY2xhc3M9Im5nLWhpZGUiPjwvZGl2PgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogV2hlbiB0aGUgbmdIaWRlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUgdGhlbiB0aGUgLm5nLWhpZGUgQ1NTIGNsYXNzIGlzIGFkZGVkIHRvIHRoZSBjbGFzcyBhdHRyaWJ1dGUKICAgICAqIG9uIHRoZSBlbGVtZW50IGNhdXNpbmcgaXQgdG8gYmVjb21lIGhpZGRlbi4gV2hlbiBmYWxzZSwgdGhlIG5nLWhpZGUgQ1NTIGNsYXNzIGlzIHJlbW92ZWQKICAgICAqIGZyb20gdGhlIGVsZW1lbnQgY2F1c2luZyB0aGUgZWxlbWVudCBub3QgdG8gYXBwZWFyIGhpZGRlbi4KICAgICAqCiAgICAgKiAjIyBXaHkgaXMgIWltcG9ydGFudCB1c2VkPwogICAgICoKICAgICAqIFlvdSBtYXkgYmUgd29uZGVyaW5nIHdoeSAhaW1wb3J0YW50IGlzIHVzZWQgZm9yIHRoZSAubmctaGlkZSBDU1MgY2xhc3MuIFRoaXMgaXMgYmVjYXVzZSB0aGUgYC5uZy1oaWRlYCBzZWxlY3RvcgogICAgICogY2FuIGJlIGVhc2lseSBvdmVycmlkZGVuIGJ5IGhlYXZpZXIgc2VsZWN0b3JzLiBGb3IgZXhhbXBsZSwgc29tZXRoaW5nIGFzIHNpbXBsZQogICAgICogYXMgY2hhbmdpbmcgdGhlIGRpc3BsYXkgc3R5bGUgb24gYSBIVE1MIGxpc3QgaXRlbSB3b3VsZCBtYWtlIGhpZGRlbiBlbGVtZW50cyBhcHBlYXIgdmlzaWJsZS4KICAgICAqIFRoaXMgYWxzbyBiZWNvbWVzIGEgYmlnZ2VyIGlzc3VlIHdoZW4gZGVhbGluZyB3aXRoIENTUyBmcmFtZXdvcmtzLgogICAgICoKICAgICAqIEJ5IHVzaW5nICFpbXBvcnRhbnQsIHRoZSBzaG93IGFuZCBoaWRlIGJlaGF2aW9yIHdpbGwgd29yayBhcyBleHBlY3RlZCBkZXNwaXRlIGFueSBjbGFzaCBiZXR3ZWVuIENTUyBzZWxlY3RvcgogICAgICogc3BlY2lmaWNpdHkgKHdoZW4gIWltcG9ydGFudCBpc24ndCB1c2VkIHdpdGggYW55IGNvbmZsaWN0aW5nIHN0eWxlcykuIElmIGEgZGV2ZWxvcGVyIGNob29zZXMgdG8gb3ZlcnJpZGUgdGhlCiAgICAgKiBzdHlsaW5nIHRvIGNoYW5nZSBob3cgdG8gaGlkZSBhbiBlbGVtZW50IHRoZW4gaXQgaXMganVzdCBhIG1hdHRlciBvZiB1c2luZyAhaW1wb3J0YW50IGluIHRoZWlyIG93biBDU1MgY29kZS4KICAgICAqCiAgICAgKiAjIyMgT3ZlcnJpZGluZyAubmctaGlkZQogICAgICoKICAgICAqIElmIHlvdSB3aXNoIHRvIGNoYW5nZSB0aGUgaGlkZSBiZWhhdmlvciB3aXRoIG5nU2hvdy9uZ0hpZGUgdGhlbiB0aGlzIGNhbiBiZSBhY2hpZXZlZCBieQogICAgICogcmVzdGF0aW5nIHRoZSBzdHlsZXMgZm9yIHRoZSAubmctaGlkZSBjbGFzcyBpbiBDU1M6CiAgICAgKiA8cHJlPgogICAgICogLm5nLWhpZGUgewogICAgICogICAvLyFhbm5vdGF0ZSBDU1MgU3BlY2lmaWNpdHl8Tm90IHRvIHdvcnJ5LCB0aGlzIHdpbGwgb3ZlcnJpZGUgdGhlIEFuZ3VsYXJKUyBkZWZhdWx0Li4uCiAgICAgKiAgIGRpc3BsYXk6YmxvY2shaW1wb3J0YW50OwogICAgICoKICAgICAqICAgLy90aGlzIGlzIGp1c3QgYW5vdGhlciBmb3JtIG9mIGhpZGluZyBhbiBlbGVtZW50CiAgICAgKiAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgICogICB0b3A6LTk5OTlweDsKICAgICAqICAgbGVmdDotOTk5OXB4OwogICAgICogfQogICAgICogPC9wcmU+CiAgICAgKgogICAgICogSnVzdCByZW1lbWJlciB0byBpbmNsdWRlIHRoZSBpbXBvcnRhbnQgZmxhZyBzbyB0aGUgQ1NTIG92ZXJyaWRlIHdpbGwgZnVuY3Rpb24uCiAgICAgKgogICAgICogIyMgQSBub3RlIGFib3V0IGFuaW1hdGlvbnMgd2l0aCBuZ0hpZGUKICAgICAqCiAgICAgKiBBbmltYXRpb25zIGluIG5nU2hvdy9uZ0hpZGUgd29yayB3aXRoIHRoZSBzaG93IGFuZCBoaWRlIGV2ZW50cyB0aGF0IGFyZSB0cmlnZ2VyZWQgd2hlbiB0aGUgZGlyZWN0aXZlIGV4cHJlc3Npb24KICAgICAqIGlzIHRydWUgYW5kIGZhbHNlLiBUaGlzIHN5c3RlbSB3b3JrcyBzaW1pbGFyIHRvIHRoZSBhbmltYXRpb24gc3lzdGVtIHByZXNlbnQgd2l0aCBuZ0NsYXNzLCBob3dldmVyLCB0aGUKICAgICAqIG9ubHkgZGlmZmVyZW5jZSBpcyB0aGF0IHlvdSBtdXN0IGFsc28gaW5jbHVkZSB0aGUgIWltcG9ydGFudCBmbGFnIHRvIG92ZXJyaWRlIHRoZSBkaXNwbGF5IHByb3BlcnR5IHNvCiAgICAgKiB0aGF0IHlvdSBjYW4gcGVyZm9ybSBhbiBhbmltYXRpb24gd2hlbiB0aGUgZWxlbWVudCBpcyBoaWRkZW4gZHVyaW5nIHRoZSB0aW1lIG9mIHRoZSBhbmltYXRpb24uCiAgICAgKgogICAgICogPHByZT4KICAgICAqIC8vCiAgICAgKiAvL2Egd29ya2luZyBleGFtcGxlIGNhbiBiZSBmb3VuZCBhdCB0aGUgYm90dG9tIG9mIHRoaXMgcGFnZQogICAgICogLy8KICAgICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkLCAubXktZWxlbWVudC5uZy1oaWRlLXJlbW92ZSB7CiAgICAgKiAgIHRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogICAgICogICBkaXNwbGF5OmJsb2NrIWltcG9ydGFudDsKICAgICAqIH0KICAgICAqCiAgICAgKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCB7IC4uLiB9CiAgICAgKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZC5uZy1oaWRlLWFkZC1hY3RpdmUgeyAuLi4gfQogICAgICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgeyAuLi4gfQogICAgICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUubmctaGlkZS1yZW1vdmUtYWN0aXZlIHsgLi4uIH0KICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBhbmltYXRpb25zCiAgICAgKiByZW1vdmVDbGFzczogLm5nLWhpZGUgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ0hpZGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSB0cnV0aHkgdmFsdWUgYW5kIGp1c3QgYmVmb3JlIHRoZSBjb250ZW50cyBhcmUgc2V0IHRvIGhpZGRlbgogICAgICogYWRkQ2xhc3M6IC5uZy1oaWRlIC0gaGFwcGVucyBhZnRlciB0aGUgbmdIaWRlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgbm9uIHRydXRoeSB2YWx1ZSBhbmQganVzdCBiZWZvcmUgdGhlIGNvbnRlbnRzIGFyZSBzZXQgdG8gdmlzaWJsZQogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0hpZGUgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSB0aGVuCiAgICAgKiAgICAgdGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIHJlc3BlY3RpdmVseS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBhbmltYXRpb25zPSJ0cnVlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICAgICAgICAgPGRpdj4KICAgICAgICAgICAgU2hvdzoKICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2hlY2stZWxlbWVudCBhbmltYXRlLWhpZGUiIG5nLXNob3c9ImNoZWNrZWQiPgogICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uLXRodW1icy11cCI+PC9zcGFuPiBJIHNob3cgdXAgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2PgogICAgICAgICAgICBIaWRlOgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjaGVjay1lbGVtZW50IGFuaW1hdGUtaGlkZSIgbmctaGlkZT0iY2hlY2tlZCI+CiAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9Imljb24tdGh1bWJzLWRvd24iPjwvc3Bhbj4gSSBoaWRlIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgICAgICAuYW5pbWF0ZS1oaWRlLm5nLWhpZGUtYWRkLCAKICAgICAgICAgIC5hbmltYXRlLWhpZGUubmctaGlkZS1yZW1vdmUgewogICAgICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgICAtbW96LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgICAtby10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgICAgdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICAgIGRpc3BsYXk6YmxvY2shaW1wb3J0YW50OwogICAgICAgICAgfQogICAgCiAgICAgICAgICAuYW5pbWF0ZS1oaWRlLm5nLWhpZGUtYWRkLm5nLWhpZGUtYWRkLWFjdGl2ZSwKICAgICAgICAgIC5hbmltYXRlLWhpZGUubmctaGlkZS1yZW1vdmUgewogICAgICAgICAgICBsaW5lLWhlaWdodDowOwogICAgICAgICAgICBvcGFjaXR5OjA7CiAgICAgICAgICAgIHBhZGRpbmc6MCAxMHB4OwogICAgICAgICAgfQogICAgCiAgICAgICAgICAuYW5pbWF0ZS1oaWRlLm5nLWhpZGUtYWRkLAogICAgICAgICAgLmFuaW1hdGUtaGlkZS5uZy1oaWRlLXJlbW92ZS5uZy1oaWRlLXJlbW92ZS1hY3RpdmUgewogICAgICAgICAgICBsaW5lLWhlaWdodDoyMHB4OwogICAgICAgICAgICBvcGFjaXR5OjE7CiAgICAgICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICAgICAgYm9yZGVyOjFweCBzb2xpZCBibGFjazsKICAgICAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgICAgIH0KICAgIAogICAgICAgICAgLmNoZWNrLWVsZW1lbnQgewogICAgICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgICB9CiAgICAgICAgPC9maWxlPgogICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXNob3cgLyBuZy1oaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgLmNoZWNrLWVsZW1lbnQ6Zmlyc3Q6aGlkZGVuJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAuY2hlY2stZWxlbWVudDpsYXN0OnZpc2libGUnKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgCiAgICAgICAgICAgICBpbnB1dCgnY2hlY2tlZCcpLmNoZWNrKCk7CiAgICAKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAuY2hlY2stZWxlbWVudDpmaXJzdDp2aXNpYmxlJykuY291bnQoKSkudG9FcXVhbCgxKTsKICAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSAuY2hlY2stZWxlbWVudDpsYXN0OmhpZGRlbicpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgICAgfSk7CiAgICAgICAgPC9maWxlPgogICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgIHZhciBuZ0hpZGVEaXJlY3RpdmUgPSBbJyRhbmltYXRlJywgZnVuY3Rpb24gKCRhbmltYXRlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ0hpZGUsIGZ1bmN0aW9uIG5nSGlkZVdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAkYW5pbWF0ZVt0b0Jvb2xlYW4odmFsdWUpID8gJ2FkZENsYXNzJyA6ICdyZW1vdmVDbGFzcyddKGVsZW1lbnQsICduZy1oaWRlJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICB9XTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpuZ1N0eWxlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUaGUgYG5nU3R5bGVgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNldCBDU1Mgc3R5bGUgb24gYW4gSFRNTCBlbGVtZW50IGNvbmRpdGlvbmFsbHkuCiAgICAgKgogICAgICogQGVsZW1lbnQgQU5ZCiAgICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU3R5bGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gd2hpY2ggZXZhbHMgdG8gYW4KICAgICAqICAgICAgb2JqZWN0IHdob3NlIGtleXMgYXJlIENTUyBzdHlsZSBuYW1lcyBhbmQgdmFsdWVzIGFyZSBjb3JyZXNwb25kaW5nIHZhbHVlcyBmb3IgdGhvc2UgQ1NTCiAgICAgKiAgICAgIGtleXMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAgIDxleGFtcGxlPgogICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCIgbmctY2xpY2s9Im15U3R5bGU9e2NvbG9yOidyZWQnfSI+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmctY2xpY2s9Im15U3R5bGU9e30iPgogICAgICAgICAgICA8YnIvPgogICAgICAgICAgICA8c3BhbiBuZy1zdHlsZT0ibXlTdHlsZSI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgICAgICAgICAgIDxwcmU+bXlTdHlsZT17e215U3R5bGV9fTwvcHJlPgogICAgICAgICA8L2ZpbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICAgICAgICAgc3BhbiB7CiAgICAgICAgICAgICBjb2xvcjogYmxhY2s7CiAgICAgICAgICAgfQogICAgICAgICA8L2ZpbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9InNjZW5hcmlvLmpzIj4KICAgICAgICAgICBpdCgnc2hvdWxkIGNoZWNrIG5nLXN0eWxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnY29sb3InKSkudG9CZSgncmdiKDAsIDAsIDApJyk7CiAgICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uW3ZhbHVlPXNldF0nKS5jbGljaygpOwogICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIHNwYW4nKS5jc3MoJ2NvbG9yJykpLnRvQmUoJ3JnYigyNTUsIDAsIDApJyk7CiAgICAgICAgICAgICBlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSA6YnV0dG9uW3ZhbHVlPWNsZWFyXScpLmNsaWNrKCk7CiAgICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnLmRvYy1leGFtcGxlLWxpdmUgc3BhbicpLmNzcygnY29sb3InKSkudG9CZSgncmdiKDAsIDAsIDApJyk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIDwvZmlsZT4KICAgICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nU3R5bGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZShmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1N0eWxlLCBmdW5jdGlvbiBuZ1N0eWxlV2F0Y2hBY3Rpb24obmV3U3R5bGVzLCBvbGRTdHlsZXMpIHsKICAgICAgICAgICAgaWYgKG9sZFN0eWxlcyAmJiAobmV3U3R5bGVzICE9PSBvbGRTdHlsZXMpKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKG9sZFN0eWxlcywgZnVuY3Rpb24gKHZhbCwgc3R5bGUpIHsgZWxlbWVudC5jc3Moc3R5bGUsICcnKTsgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld1N0eWxlcykgZWxlbWVudC5jc3MobmV3U3R5bGVzKTsKICAgICAgICB9LCB0cnVlKTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOm5nU3dpdGNoCiAgICAgKiBAcmVzdHJpY3QgRUEKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBuZ1N3aXRjaCBkaXJlY3RpdmUgaXMgdXNlZCB0byBjb25kaXRpb25hbGx5IHN3YXAgRE9NIHN0cnVjdHVyZSBvbiB5b3VyIHRlbXBsYXRlIGJhc2VkIG9uIGEgc2NvcGUgZXhwcmVzc2lvbi4KICAgICAqIEVsZW1lbnRzIHdpdGhpbiBuZ1N3aXRjaCBidXQgd2l0aG91dCBuZ1N3aXRjaFdoZW4gb3IgbmdTd2l0Y2hEZWZhdWx0IGRpcmVjdGl2ZXMgd2lsbCBiZSBwcmVzZXJ2ZWQgYXQgdGhlIGxvY2F0aW9uCiAgICAgKiBhcyBzcGVjaWZpZWQgaW4gdGhlIHRlbXBsYXRlLgogICAgICoKICAgICAqIFRoZSBkaXJlY3RpdmUgaXRzZWxmIHdvcmtzIHNpbWlsYXIgdG8gbmdJbmNsdWRlLCBob3dldmVyLCBpbnN0ZWFkIG9mIGRvd25sb2FkaW5nIHRlbXBsYXRlIGNvZGUgKG9yIGxvYWRpbmcgaXQKICAgICAqIGZyb20gdGhlIHRlbXBsYXRlIGNhY2hlKSwgbmdTd2l0Y2ggc2ltcGx5IGNob3NlcyBvbmUgb2YgdGhlIG5lc3RlZCBlbGVtZW50cyBhbmQgbWFrZXMgaXQgdmlzaWJsZSBiYXNlZCBvbiB3aGljaCBlbGVtZW50CiAgICAgKiBtYXRjaGVzIHRoZSB2YWx1ZSBvYnRhaW5lZCBmcm9tIHRoZSBldmFsdWF0ZWQgZXhwcmVzc2lvbi4gSW4gb3RoZXIgd29yZHMsIHlvdSBkZWZpbmUgYSBjb250YWluZXIgZWxlbWVudAogICAgICogKHdoZXJlIHlvdSBwbGFjZSB0aGUgZGlyZWN0aXZlKSwgcGxhY2UgYW4gZXhwcmVzc2lvbiBvbiB0aGUgKipvbj0iLi4uIiBhdHRyaWJ1dGUqKgogICAgICogKG9yIHRoZSAqKm5nLXN3aXRjaD0iLi4uIiBhdHRyaWJ1dGUqKiksIGRlZmluZSBhbnkgaW5uZXIgZWxlbWVudHMgaW5zaWRlIG9mIHRoZSBkaXJlY3RpdmUgYW5kIHBsYWNlCiAgICAgKiBhIHdoZW4gYXR0cmlidXRlIHBlciBlbGVtZW50LiBUaGUgd2hlbiBhdHRyaWJ1dGUgaXMgdXNlZCB0byBpbmZvcm0gbmdTd2l0Y2ggd2hpY2ggZWxlbWVudCB0byBkaXNwbGF5IHdoZW4gdGhlIG9uCiAgICAgKiBleHByZXNzaW9uIGlzIGV2YWx1YXRlZC4gSWYgYSBtYXRjaGluZyBleHByZXNzaW9uIGlzIG5vdCBmb3VuZCB2aWEgYSB3aGVuIGF0dHJpYnV0ZSB0aGVuIGFuIGVsZW1lbnQgd2l0aCB0aGUgZGVmYXVsdAogICAgICogYXR0cmlidXRlIGlzIGRpc3BsYXllZC4KICAgICAqCiAgICAgKiBAYW5pbWF0aW9ucwogICAgICogZW50ZXIgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ1N3dGljaCBjb250ZW50cyBjaGFuZ2UgYW5kIHRoZSBtYXRjaGVkIGNoaWxkIGVsZW1lbnQgaXMgcGxhY2VkIGluc2lkZSB0aGUgY29udGFpbmVyCiAgICAgKiBsZWF2ZSAtIGhhcHBlbnMganVzdCBhZnRlciB0aGUgbmdTd2l0Y2ggY29udGVudHMgY2hhbmdlIGFuZCBqdXN0IGJlZm9yZSB0aGUgZm9ybWVyIGNvbnRlbnRzIGFyZSByZW1vdmVkIGZyb20gdGhlIERPTQogICAgICoKICAgICAqIEB1c2FnZQogICAgICogPEFOWSBuZy1zd2l0Y2g9ImV4cHJlc3Npb24iPgogICAgICogICA8QU5ZIG5nLXN3aXRjaC13aGVuPSJtYXRjaFZhbHVlMSI+Li4uPC9BTlk+CiAgICAgKiAgIDxBTlkgbmctc3dpdGNoLXdoZW49Im1hdGNoVmFsdWUyIj4uLi48L0FOWT4KICAgICAqICAgPEFOWSBuZy1zd2l0Y2gtZGVmYXVsdD4uLi48L0FOWT4KICAgICAqIDwvQU5ZPgogICAgICoKICAgICAqIEBzY29wZQogICAgICogQHBhcmFtIHsqfSBuZ1N3aXRjaHxvbiBleHByZXNzaW9uIHRvIG1hdGNoIGFnYWluc3QgPHR0Pm5nLXN3aXRjaC13aGVuPC90dD4uCiAgICAgKiBAcGFyYW1EZXNjcmlwdGlvbgogICAgICogT24gY2hpbGQgZWxlbWVudHMgYWRkOgogICAgICoKICAgICAqICogYG5nU3dpdGNoV2hlbmA6IHRoZSBjYXNlIHN0YXRlbWVudCB0byBtYXRjaCBhZ2FpbnN0LiBJZiBtYXRjaCB0aGVuIHRoaXMKICAgICAqICAgY2FzZSB3aWxsIGJlIGRpc3BsYXllZC4gSWYgdGhlIHNhbWUgbWF0Y2ggYXBwZWFycyBtdWx0aXBsZSB0aW1lcywgYWxsIHRoZQogICAgICogICBlbGVtZW50cyB3aWxsIGJlIGRpc3BsYXllZC4KICAgICAqICogYG5nU3dpdGNoRGVmYXVsdGA6IHRoZSBkZWZhdWx0IGNhc2Ugd2hlbiBubyBvdGhlciBjYXNlIG1hdGNoLiBJZiB0aGVyZQogICAgICogICBhcmUgbXVsdGlwbGUgZGVmYXVsdCBjYXNlcywgYWxsIG9mIHRoZW0gd2lsbCBiZSBkaXNwbGF5ZWQgd2hlbiBubyBvdGhlcgogICAgICogICBjYXNlIG1hdGNoLgogICAgICoKICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICA8ZXhhbXBsZSBhbmltYXRpb25zPSJ0cnVlIj4KICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9InNlbGVjdGlvbiIgbmctb3B0aW9ucz0iaXRlbSBmb3IgaXRlbSBpbiBpdGVtcyI+CiAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICA8dHQ+c2VsZWN0aW9uPXt7c2VsZWN0aW9ufX08L3R0PgogICAgICAgICAgICA8aHIvPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJhbmltYXRlLXN3aXRjaC1jb250YWluZXIiCiAgICAgICAgICAgICAgbmctc3dpdGNoIG9uPSJzZWxlY3Rpb24iPgogICAgICAgICAgICAgICAgPGRpdiBuZy1zd2l0Y2gtd2hlbj0ic2V0dGluZ3MiPlNldHRpbmdzIERpdjwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBuZy1zd2l0Y2gtd2hlbj0iaG9tZSI+SG9tZSBTcGFuPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IG5nLXN3aXRjaC1kZWZhdWx0PmRlZmF1bHQ8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2ZpbGU+CiAgICAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS5pdGVtcyA9IFsnc2V0dGluZ3MnLCAnaG9tZScsICdvdGhlciddOwogICAgICAgICAgICAkc2NvcGUuc2VsZWN0aW9uID0gJHNjb3BlLml0ZW1zWzBdOwogICAgICAgICAgfQogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgICAgICAgICAuYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyIHsKICAgICAgICAgICAgcG9zaXRpb246cmVsYXRpdmU7CiAgICAgICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgICAgIGhlaWdodDo0MHB4OwogICAgICAgICAgICBvdmVyZmxvdzpoaWRkZW47CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5hbmltYXRlLXN3aXRjaC1jb250YWluZXIgPiBkaXYgewogICAgICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5hbmltYXRlLXN3aXRjaC1jb250YWluZXIgPiAubmctZW50ZXIsCiAgICAgICAgICAuYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyID4gLm5nLWxlYXZlIHsKICAgICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgIC1tb3otdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgICAgICAtby10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgIAogICAgICAgICAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgICAgICAgICAgdG9wOjA7CiAgICAgICAgICAgIGxlZnQ6MDsKICAgICAgICAgICAgcmlnaHQ6MDsKICAgICAgICAgICAgYm90dG9tOjA7CiAgICAgICAgICB9CiAgICAKICAgICAgICAgIC5hbmltYXRlLXN3aXRjaC1jb250YWluZXIgPiAubmctZW50ZXIgewogICAgICAgICAgICB0b3A6LTUwcHg7CiAgICAgICAgICB9CiAgICAgICAgICAuYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyID4gLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAgICAgICAgICAgIHRvcDowOwogICAgICAgICAgfQogICAgCiAgICAgICAgICAuYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyID4gLm5nLWxlYXZlIHsKICAgICAgICAgICAgdG9wOjA7CiAgICAgICAgICB9CiAgICAgICAgICAuYW5pbWF0ZS1zd2l0Y2gtY29udGFpbmVyID4gLm5nLWxlYXZlLm5nLWxlYXZlLWFjdGl2ZSB7CiAgICAgICAgICAgIHRvcDo1MHB4OwogICAgICAgICAgfQogICAgICAgIDwvZmlsZT4KICAgICAgICA8ZmlsZSBuYW1lPSJzY2VuYXJpby5qcyI+CiAgICAgICAgICBpdCgnc2hvdWxkIHN0YXJ0IGluIHNldHRpbmdzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdChlbGVtZW50KCcuZG9jLWV4YW1wbGUtbGl2ZSBbbmctc3dpdGNoXScpLnRleHQoKSkudG9NYXRjaCgvU2V0dGluZ3MgRGl2Lyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGhvbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZWN0KCdzZWxlY3Rpb24nKS5vcHRpb24oJ2hvbWUnKTsKICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1zd2l0Y2hdJykudGV4dCgpKS50b01hdGNoKC9Ib21lIFNwYW4vKTsKICAgICAgICAgIH0pOwogICAgICAgICAgaXQoJ3Nob3VsZCBzZWxlY3QgZGVmYXVsdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzZWxlY3QoJ3NlbGVjdGlvbicpLm9wdGlvbignb3RoZXInKTsKICAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoJy5kb2MtZXhhbXBsZS1saXZlIFtuZy1zd2l0Y2hdJykudGV4dCgpKS50b01hdGNoKC9kZWZhdWx0Lyk7CiAgICAgICAgICB9KTsKICAgICAgICA8L2ZpbGU+CiAgICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgdmFyIG5nU3dpdGNoRGlyZWN0aXZlID0gWyckYW5pbWF0ZScsIGZ1bmN0aW9uICgkYW5pbWF0ZSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICAgICAgICByZXF1aXJlOiAnbmdTd2l0Y2gnLAoKICAgICAgICAgICAgLy8gYXNrcyBmb3IgJHNjb3BlIHRvIGZvb2wgdGhlIEJDIGNvbnRyb2xsZXIgbW9kdWxlCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgZnVuY3Rpb24gbmdTd2l0Y2hDb250cm9sbGVyKCkgewogICAgICAgICAgICAgICAgdGhpcy5jYXNlcyA9IHt9OwogICAgICAgICAgICB9XSwKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBuZ1N3aXRjaENvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICAgIHZhciB3YXRjaEV4cHIgPSBhdHRyLm5nU3dpdGNoIHx8IGF0dHIub24sCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRUcmFuc2NsdWRlcywKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnRzLAogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2NvcGVzID0gW107CgogICAgICAgICAgICAgICAgc2NvcGUuJHdhdGNoKHdhdGNoRXhwciwgZnVuY3Rpb24gbmdTd2l0Y2hXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IHNlbGVjdGVkU2NvcGVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZXNbaV0uJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoc2VsZWN0ZWRFbGVtZW50c1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEVsZW1lbnRzID0gW107CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZXMgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKChzZWxlY3RlZFRyYW5zY2x1ZGVzID0gbmdTd2l0Y2hDb250cm9sbGVyLmNhc2VzWychJyArIHZhbHVlXSB8fCBuZ1N3aXRjaENvbnRyb2xsZXIuY2FzZXNbJz8nXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGV2YWwoYXR0ci5jaGFuZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdGVkVHJhbnNjbHVkZXMsIGZ1bmN0aW9uIChzZWxlY3RlZFRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzZWxlY3RlZFNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZXMucHVzaChzZWxlY3RlZFNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkVHJhbnNjbHVkZS50cmFuc2NsdWRlKHNlbGVjdGVkU2NvcGUsIGZ1bmN0aW9uIChjYXNlRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhbmNob3IgPSBzZWxlY3RlZFRyYW5zY2x1ZGUuZWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRFbGVtZW50cy5wdXNoKGNhc2VFbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjYXNlRWxlbWVudCwgYW5jaG9yLnBhcmVudCgpLCBhbmNob3IpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfV07CgogICAgdmFyIG5nU3dpdGNoV2hlbkRpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgcHJpb3JpdHk6IDUwMCwKICAgICAgICByZXF1aXJlOiAnXm5nU3dpdGNoJywKICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cnMsIHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgY3RybC5jYXNlc1snIScgKyBhdHRycy5uZ1N3aXRjaFdoZW5dID0gKGN0cmwuY2FzZXNbJyEnICsgYXR0cnMubmdTd2l0Y2hXaGVuXSB8fCBbXSk7CiAgICAgICAgICAgICAgICBjdHJsLmNhc2VzWychJyArIGF0dHJzLm5nU3dpdGNoV2hlbl0ucHVzaCh7IHRyYW5zY2x1ZGU6IHRyYW5zY2x1ZGUsIGVsZW1lbnQ6IGVsZW1lbnQgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSk7CgogICAgdmFyIG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgcHJpb3JpdHk6IDUwMCwKICAgICAgICByZXF1aXJlOiAnXm5nU3dpdGNoJywKICAgICAgICBjb21waWxlOiBmdW5jdGlvbiAoZWxlbWVudCwgYXR0cnMsIHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgICAgICAgICAgY3RybC5jYXNlc1snPyddID0gKGN0cmwuY2FzZXNbJz8nXSB8fCBbXSk7CiAgICAgICAgICAgICAgICBjdHJsLmNhc2VzWyc/J10ucHVzaCh7IHRyYW5zY2x1ZGU6IHRyYW5zY2x1ZGUsIGVsZW1lbnQ6IGVsZW1lbnQgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSk7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICAgKiBAbmFtZSBuZy5kaXJlY3RpdmU6bmdUcmFuc2NsdWRlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBEaXJlY3RpdmUgdGhhdCBtYXJrcyB0aGUgaW5zZXJ0aW9uIHBvaW50IGZvciB0aGUgdHJhbnNjbHVkZWQgRE9NIG9mIHRoZSBuZWFyZXN0IHBhcmVudCBkaXJlY3RpdmUgdGhhdCB1c2VzIHRyYW5zY2x1c2lvbi4KICAgICAqCiAgICAgKiBBbnkgZXhpc3RpbmcgY29udGVudCBvZiB0aGUgZWxlbWVudCB0aGF0IHRoaXMgZGlyZWN0aXZlIGlzIHBsYWNlZCBvbiB3aWxsIGJlIHJlbW92ZWQgYmVmb3JlIHRoZSB0cmFuc2NsdWRlZCBjb250ZW50IGlzIGluc2VydGVkLgogICAgICoKICAgICAqIEBlbGVtZW50IEFOWQogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgICA8ZG9jOmV4YW1wbGUgbW9kdWxlPSJ0cmFuc2NsdWRlIj4KICAgICAgICAgPGRvYzpzb3VyY2U+CiAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAgICRzY29wZS50aXRsZSA9ICdMb3JlbSBJcHN1bSc7CiAgICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ05lcXVlIHBvcnJvIHF1aXNxdWFtIGVzdCBxdWkgZG9sb3JlbSBpcHN1bSBxdWlhIGRvbG9yLi4uJzsKICAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ3RyYW5zY2x1ZGUnLCBbXSkKICAgICAgICAgICAgICAuZGlyZWN0aXZlKCdwYW5lJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICBzY29wZTogeyB0aXRsZTonQCcgfSwKICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiAnPGRpdiBzdHlsZT0iYm9yZGVyOiAxcHggc29saWQgYmxhY2s7Ij4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiBncmF5Ij57e3RpdGxlfX08L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IG5nLXRyYW5zY2x1ZGU+PC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicKICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgfSk7CiAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICAgICAgICAgIDxpbnB1dCBuZy1tb2RlbD0idGl0bGUiPjxicj4KICAgICAgICAgICAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0idGV4dCI+PC90ZXh0YXJlYT4gPGJyLz4KICAgICAgICAgICAgIDxwYW5lIHRpdGxlPSJ7e3RpdGxlfX0iPnt7dGV4dH19PC9wYW5lPgogICAgICAgICAgIDwvZGl2PgogICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICAgIGl0KCdzaG91bGQgaGF2ZSB0cmFuc2NsdWRlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlucHV0KCd0aXRsZScpLmVudGVyKCdUSVRMRScpOwogICAgICAgICAgICAgIGlucHV0KCd0ZXh0JykuZW50ZXIoJ1RFWFQnKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndGl0bGUnKSkudG9FcXVhbCgnVElUTEUnKTsKICAgICAgICAgICAgICBleHBlY3QoYmluZGluZygndGV4dCcpKS50b0VxdWFsKCdURVhUJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKgogICAgICovCiAgICB2YXIgbmdUcmFuc2NsdWRlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgICAgIGNvbnRyb2xsZXI6IFsnJHRyYW5zY2x1ZGUnLCBmdW5jdGlvbiAoJHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgLy8gcmVtZW1iZXIgdGhlIHRyYW5zY2x1c2lvbiBmbiBidXQgY2FsbCBpdCBkdXJpbmcgbGlua2luZyBzbyB0aGF0IHdlIGRvbid0IHByb2Nlc3MgdHJhbnNjbHVzaW9uIGJlZm9yZSBkaXJlY3RpdmVzIG9uCiAgICAgICAgICAgIC8vIHRoZSBwYXJlbnQgZWxlbWVudCBldmVuIHdoZW4gdGhlIHRyYW5zY2x1c2lvbiByZXBsYWNlcyB0aGUgY3VycmVudCBlbGVtZW50LiAod2UgY2FuJ3QgdXNlIHByaW9yaXR5IGhlcmUgYmVjYXVzZQogICAgICAgICAgICAvLyB0aGF0IGFwcGxpZXMgb25seSB0byBjb21waWxlIGZucyBhbmQgbm90IGNvbnRyb2xsZXJzCiAgICAgICAgICAgIHRoaXMuJHRyYW5zY2x1ZGUgPSAkdHJhbnNjbHVkZTsKICAgICAgICB9XSwKCiAgICAgICAgbGluazogZnVuY3Rpb24gKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgY29udHJvbGxlcikgewogICAgICAgICAgICBjb250cm9sbGVyLiR0cmFuc2NsdWRlKGZ1bmN0aW9uIChjbG9uZSkgewogICAgICAgICAgICAgICAgJGVsZW1lbnQuaHRtbCgnJyk7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgICAqIEBuYW1lIG5nLmRpcmVjdGl2ZTpzY3JpcHQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIExvYWQgY29udGVudCBvZiBhIHNjcmlwdCB0YWcsIHdpdGggdHlwZSBgdGV4dC9uZy10ZW1wbGF0ZWAsIGludG8gYCR0ZW1wbGF0ZUNhY2hlYCwgc28gdGhhdCB0aGUKICAgICAqIHRlbXBsYXRlIGNhbiBiZSB1c2VkIGJ5IGBuZ0luY2x1ZGVgLCBgbmdWaWV3YCBvciBkaXJlY3RpdmUgdGVtcGxhdGVzLgogICAgICoKICAgICAqIEByZXN0cmljdCBFCiAgICAgKiBAcGFyYW0geyd0ZXh0L25nLXRlbXBsYXRlJ30gdHlwZSBtdXN0IGJlIHNldCB0byBgJ3RleHQvbmctdGVtcGxhdGUnYAogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICA8ZG9jOnNvdXJjZT4KICAgICAgICAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9Ii90cGwuaHRtbCI+CiAgICAgICAgICAgIENvbnRlbnQgb2YgdGhlIHRlbXBsYXRlLgogICAgICAgICAgPC9zY3JpcHQ+CiAgICAKICAgICAgICAgIDxhIG5nLWNsaWNrPSJjdXJyZW50VHBsPScvdHBsLmh0bWwnIiBpZD0idHBsLWxpbmsiPkxvYWQgaW5saW5lZCB0ZW1wbGF0ZTwvYT4KICAgICAgICAgIDxkaXYgaWQ9InRwbC1jb250ZW50IiBuZy1pbmNsdWRlIHNyYz0iY3VycmVudFRwbCI+PC9kaXY+CiAgICAgICAgPC9kb2M6c291cmNlPgogICAgICAgIDxkb2M6c2NlbmFyaW8+CiAgICAgICAgICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUgZGVmaW5lZCBpbnNpZGUgc2NyaXB0IHRhZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbGVtZW50KCcjdHBsLWxpbmsnKS5jbGljaygpOwogICAgICAgICAgICBleHBlY3QoZWxlbWVudCgnI3RwbC1jb250ZW50JykudGV4dCgpKS50b01hdGNoKC9Db250ZW50IG9mIHRoZSB0ZW1wbGF0ZS8pOwogICAgICAgICAgfSk7CiAgICAgICAgPC9kb2M6c2NlbmFyaW8+CiAgICAgIDwvZG9jOmV4YW1wbGU+CiAgICAgKi8KICAgIHZhciBzY3JpcHREaXJlY3RpdmUgPSBbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24gKCR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICBpZiAoYXR0ci50eXBlID09ICd0ZXh0L25nLXRlbXBsYXRlJykgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZVVybCA9IGF0dHIuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElFIGlzIG5vdCBjb25zaXN0ZW50LCBpbiBzY3JpcHRzIHdlIGhhdmUgdG8gcmVhZCAudGV4dCBidXQgaW4gb3RoZXIgbm9kZXMgd2UgaGF2ZSB0byByZWFkIC50ZXh0Q29udGVudAogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gZWxlbWVudFswXS50ZXh0OwoKICAgICAgICAgICAgICAgICAgICAkdGVtcGxhdGVDYWNoZS5wdXQodGVtcGxhdGVVcmwsIHRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH1dOwoKICAgIC8qKgogICAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAgICogQG5hbWUgbmcuZGlyZWN0aXZlOnNlbGVjdAogICAgICogQHJlc3RyaWN0IEUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEhUTUwgYFNFTEVDVGAgZWxlbWVudCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLgogICAgICoKICAgICAqICMgYG5nT3B0aW9uc2AKICAgICAqCiAgICAgKiBPcHRpb25hbGx5IGBuZ09wdGlvbnNgIGF0dHJpYnV0ZSBjYW4gYmUgdXNlZCB0byBkeW5hbWljYWxseSBnZW5lcmF0ZSBhIGxpc3Qgb2YgYDxvcHRpb24+YAogICAgICogZWxlbWVudHMgZm9yIGEgYDxzZWxlY3Q+YCBlbGVtZW50IHVzaW5nIGFuIGFycmF5IG9yIGFuIG9iamVjdCBvYnRhaW5lZCBieSBldmFsdWF0aW5nIHRoZQogICAgICogYG5nT3B0aW9uc2AgZXhwcmVzc2lvbi4KICAgICAqCiAgICAgKiBXaGVuIGFuIGl0ZW0gaW4gdGhlIGA8c2VsZWN0PmAgbWVudSBpcyBzZWxlY3RlZCwgdGhlIHZhbHVlIG9mIGFycmF5IGVsZW1lbnQgb3Igb2JqZWN0IHByb3BlcnR5CiAgICAgKiByZXByZXNlbnRlZCBieSB0aGUgc2VsZWN0ZWQgb3B0aW9uIHdpbGwgYmUgYm91bmQgdG8gdGhlIG1vZGVsIGlkZW50aWZpZWQgYnkgdGhlIGBuZ01vZGVsYAogICAgICogZGlyZWN0aXZlIG9mIHRoZSBwYXJlbnQgc2VsZWN0IGVsZW1lbnQuCiAgICAgKgogICAgICogT3B0aW9uYWxseSwgYSBzaW5nbGUgaGFyZC1jb2RlZCBgPG9wdGlvbj5gIGVsZW1lbnQsIHdpdGggdGhlIHZhbHVlIHNldCB0byBhbiBlbXB0eSBzdHJpbmcsIGNhbgogICAgICogYmUgbmVzdGVkIGludG8gdGhlIGA8c2VsZWN0PmAgZWxlbWVudC4gVGhpcyBlbGVtZW50IHdpbGwgdGhlbiByZXByZXNlbnQgYG51bGxgIG9yICJub3Qgc2VsZWN0ZWQiCiAgICAgKiBvcHRpb24uIFNlZSBleGFtcGxlIGJlbG93IGZvciBkZW1vbnN0cmF0aW9uLgogICAgICoKICAgICAqIE5vdGU6IGBuZ09wdGlvbnNgIHByb3ZpZGVzIGl0ZXJhdG9yIGZhY2lsaXR5IGZvciBgPG9wdGlvbj5gIGVsZW1lbnQgd2hpY2ggc2hvdWxkIGJlIHVzZWQgaW5zdGVhZAogICAgICogb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gd2hlbiB5b3Ugd2FudCB0aGUKICAgICAqIGBzZWxlY3RgIG1vZGVsIHRvIGJlIGJvdW5kIHRvIGEgbm9uLXN0cmluZyB2YWx1ZS4gVGhpcyBpcyBiZWNhdXNlIGFuIG9wdGlvbiBlbGVtZW50IGNhbiBjdXJyZW50bHkKICAgICAqIGJlIGJvdW5kIHRvIHN0cmluZyB2YWx1ZXMgb25seS4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFRoZSBjb250cm9sIGlzIGNvbnNpZGVyZWQgdmFsaWQgb25seSBpZiB2YWx1ZSBpcyBlbnRlcmVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgKiBAcGFyYW0ge2NvbXByZWhlbnNpb25fZXhwcmVzc2lvbj19IG5nT3B0aW9ucyBpbiBvbmUgb2YgdGhlIGZvbGxvd2luZyBmb3JtczoKICAgICAqCiAgICAgKiAgICogZm9yIGFycmF5IGRhdGEgc291cmNlczoKICAgICAqICAgICAqIGBsYWJlbGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICAgKiAgICAgKiBgbGFiZWxgICAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgICAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgICoqYHRyYWNrIGJ5YCoqIGB0cmFja2V4cHJgCiAgICAgKiAgICogZm9yIG9iamVjdCBkYXRhIHNvdXJjZXM6CiAgICAgKiAgICAgKiBgbGFiZWxgICoqYGZvciAoYCoqYGtleWAgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgICAqICAgICAqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3IgKGAqKmBrZXlgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgCiAgICAgKiAgICAgICAgICoqYGZvcmAgYChgKipga2V5YCoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgICAqCiAgICAgKiBXaGVyZToKICAgICAqCiAgICAgKiAgICogYGFycmF5YCAvIGBvYmplY3RgOiBhbiBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbiBhcnJheSAvIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiAgICogYHZhbHVlYDogbG9jYWwgdmFyaWFibGUgd2hpY2ggd2lsbCByZWZlciB0byBlYWNoIGl0ZW0gaW4gdGhlIGBhcnJheWAgb3IgZWFjaCBwcm9wZXJ0eSB2YWx1ZQogICAgICogICAgICBvZiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogICAgICogICAqIGBrZXlgOiBsb2NhbCB2YXJpYWJsZSB3aGljaCB3aWxsIHJlZmVyIHRvIGEgcHJvcGVydHkgbmFtZSBpbiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogICAgICogICAqIGBsYWJlbGA6IFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUgdGhlIGxhYmVsIGZvciBgPG9wdGlvbj5gIGVsZW1lbnQuIFRoZQogICAgICogICAgIGBleHByZXNzaW9uYCB3aWxsIG1vc3QgbGlrZWx5IHJlZmVyIHRvIHRoZSBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICAgICAqICAgKiBgc2VsZWN0YDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSBib3VuZCB0byB0aGUgbW9kZWwgb2YgdGhlIHBhcmVudCBgPHNlbGVjdD5gCiAgICAgKiAgICAgIGVsZW1lbnQuIElmIG5vdCBzcGVjaWZpZWQsIGBzZWxlY3RgIGV4cHJlc3Npb24gd2lsbCBkZWZhdWx0IHRvIGB2YWx1ZWAuCiAgICAgKiAgICogYGdyb3VwYDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSB1c2VkIHRvIGdyb3VwIG9wdGlvbnMgdXNpbmcgdGhlIGA8b3B0Z3JvdXA+YAogICAgICogICAgICBET00gZWxlbWVudC4KICAgICAqICAgKiBgdHJhY2tleHByYDogVXNlZCB3aGVuIHdvcmtpbmcgd2l0aCBhbiBhcnJheSBvZiBvYmplY3RzLiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlCiAgICAgKiAgICAgIHVzZWQgdG8gaWRlbnRpZnkgdGhlIG9iamVjdHMgaW4gdGhlIGFycmF5LiBUaGUgYHRyYWNrZXhwcmAgd2lsbCBtb3N0IGxpa2VseSByZWZlciB0byB0aGUKICAgICAqICAgICBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICAgIDxkb2M6ZXhhbXBsZT4KICAgICAgICAgIDxkb2M6c291cmNlPgogICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICBmdW5jdGlvbiBNeUNudHJsKCRzY29wZSkgewogICAgICAgICAgICAgICRzY29wZS5jb2xvcnMgPSBbCiAgICAgICAgICAgICAgICB7bmFtZTonYmxhY2snLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICAgICAge25hbWU6J3doaXRlJywgc2hhZGU6J2xpZ2h0J30sCiAgICAgICAgICAgICAgICB7bmFtZToncmVkJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAgICAgIHtuYW1lOidibHVlJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAgICAgIHtuYW1lOid5ZWxsb3cnLCBzaGFkZTonbGlnaHQnfQogICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgJHNjb3BlLmNvbG9yID0gJHNjb3BlLmNvbG9yc1syXTsgLy8gcmVkCiAgICAgICAgICAgIH0KICAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iTXlDbnRybCI+CiAgICAgICAgICAgICAgPHVsPgogICAgICAgICAgICAgICAgPGxpIG5nLXJlcGVhdD0iY29sb3IgaW4gY29sb3JzIj4KICAgICAgICAgICAgICAgICAgTmFtZTogPGlucHV0IG5nLW1vZGVsPSJjb2xvci5uYW1lIj4KICAgICAgICAgICAgICAgICAgWzxhIGhyZWYgbmctY2xpY2s9ImNvbG9ycy5zcGxpY2UoJGluZGV4LCAxKSI+WDwvYT5dCiAgICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgICAgPGxpPgogICAgICAgICAgICAgICAgICBbPGEgaHJlZiBuZy1jbGljaz0iY29sb3JzLnB1c2goe30pIj5hZGQ8L2E+XQogICAgICAgICAgICAgICAgPC9saT4KICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICAgIDxoci8+CiAgICAgICAgICAgICAgQ29sb3IgKG51bGwgbm90IGFsbG93ZWQpOgogICAgICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZm9yIGMgaW4gY29sb3JzIj48L3NlbGVjdD48YnI+CiAgICAKICAgICAgICAgICAgICBDb2xvciAobnVsbCBhbGxvd2VkKToKICAgICAgICAgICAgICA8c3BhbiAgY2xhc3M9Im51bGxhYmxlIj4KICAgICAgICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZm9yIGMgaW4gY29sb3JzIj4KICAgICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj4tLSBjaG9zZSBjb2xvciAtLTwvb3B0aW9uPgogICAgICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgICAgPC9zcGFuPjxici8+CiAgICAKICAgICAgICAgICAgICBDb2xvciBncm91cGVkIGJ5IHNoYWRlOgogICAgICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbG9yIiBuZy1vcHRpb25zPSJjLm5hbWUgZ3JvdXAgYnkgYy5zaGFkZSBmb3IgYyBpbiBjb2xvcnMiPgogICAgICAgICAgICAgIDwvc2VsZWN0Pjxici8+CiAgICAKICAgIAogICAgICAgICAgICAgIFNlbGVjdCA8YSBocmVmIG5nLWNsaWNrPSJjb2xvcj17bmFtZTonbm90IGluIGxpc3QnfSI+Ym9ndXM8L2E+Ljxicj4KICAgICAgICAgICAgICA8aHIvPgogICAgICAgICAgICAgIEN1cnJlbnRseSBzZWxlY3RlZDoge3sge3NlbGVjdGVkX2NvbG9yOmNvbG9yfSAgfX0KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJib3JkZXI6c29saWQgMXB4IGJsYWNrOyBoZWlnaHQ6MjBweCIKICAgICAgICAgICAgICAgICAgIG5nLXN0eWxlPSJ7J2JhY2tncm91bmQtY29sb3InOmNvbG9yLm5hbWV9Ij4KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2RvYzpzb3VyY2U+CiAgICAgICAgICA8ZG9jOnNjZW5hcmlvPgogICAgICAgICAgICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1vcHRpb25zJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6Y29sb3J9JykpLnRvTWF0Y2goJ3JlZCcpOwogICAgICAgICAgICAgICBzZWxlY3QoJ2NvbG9yJykub3B0aW9uKCcwJyk7CiAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6Y29sb3J9JykpLnRvTWF0Y2goJ2JsYWNrJyk7CiAgICAgICAgICAgICAgIHVzaW5nKCcubnVsbGFibGUnKS5zZWxlY3QoJ2NvbG9yJykub3B0aW9uKCcnKTsKICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpjb2xvcn0nKSkudG9NYXRjaCgnbnVsbCcpOwogICAgICAgICAgICAgfSk7CiAgICAgICAgICA8L2RvYzpzY2VuYXJpbz4KICAgICAgICA8L2RvYzpleGFtcGxlPgogICAgICovCgogICAgdmFyIG5nT3B0aW9uc0RpcmVjdGl2ZSA9IHZhbHVlRm4oeyB0ZXJtaW5hbDogdHJ1ZSB9KTsKICAgIHZhciBzZWxlY3REaXJlY3RpdmUgPSBbJyRjb21waWxlJywgJyRwYXJzZScsIGZ1bmN0aW9uICgkY29tcGlsZSwgJHBhcnNlKSB7CiAgICAgICAgLy8wMDAwMTExMTEwMDAwMDAwMDAwMDIyMjIwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMzMzMzAwMDAwMDAwMDAwMDAwNDQ0NDQ0NDQ0NDQ0NDQ0NDQwMDAwMDAwMDA1NTU1NTU1NTU1NTU1NTU1NTAwMDAwMDA2NjY2NjY2NjY2NjY2NjY2NjAwMDAwMDAwMDAwMDAwMDA3Nzc3MDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4CiAgICAgICAgdmFyIE5HX09QVElPTlNfUkVHRVhQID0gL15ccyooLio/KSg/OlxzK2FzXHMrKC4qPykpPyg/OlxzK2dyb3VwXHMrYnlccysoLiopKT9ccytmb3JccysoPzooW1wkXHddW1wkXHdcZF0qKXwoPzpcKFxzKihbXCRcd11bXCRcd1xkXSopXHMqLFxzKihbXCRcd11bXCRcd1xkXSopXHMqXCkpKVxzK2luXHMrKC4qPykoPzpccyt0cmFja1xzK2J5XHMrKC4qPykpPyQvLAogICAgICAgICAgICBudWxsTW9kZWxDdHJsID0geyAkc2V0Vmlld1ZhbHVlOiBub29wIH07CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHJlcXVpcmU6IFsnc2VsZWN0JywgJz9uZ01vZGVsJ10sCiAgICAgICAgICAgIGNvbnRyb2xsZXI6IFsnJGVsZW1lbnQnLCAnJHNjb3BlJywgJyRhdHRycycsIGZ1bmN0aW9uICgkZWxlbWVudCwgJHNjb3BlLCAkYXR0cnMpIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBvcHRpb25zTWFwID0ge30sCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBudWxsTW9kZWxDdHJsLAogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24sCiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbjsKCgogICAgICAgICAgICAgICAgc2VsZi5kYXRhYm91bmQgPSAkYXR0cnMubmdNb2RlbDsKCgogICAgICAgICAgICAgICAgc2VsZi5pbml0ID0gZnVuY3Rpb24gKG5nTW9kZWxDdHJsXywgbnVsbE9wdGlvbl8sIHVua25vd25PcHRpb25fKSB7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBuZ01vZGVsQ3RybF87CiAgICAgICAgICAgICAgICAgICAgbnVsbE9wdGlvbiA9IG51bGxPcHRpb25fOwogICAgICAgICAgICAgICAgICAgIHVua25vd25PcHRpb24gPSB1bmtub3duT3B0aW9uXzsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgc2VsZi5hZGRPcHRpb24gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zTWFwW3ZhbHVlXSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRlbGVtZW50LnZhbCh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgICAgIHNlbGYucmVtb3ZlT3B0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzT3B0aW9uKHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9uc01hcFt2YWx1ZV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclVua25vd25PcHRpb24odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCgogICAgICAgICAgICAgICAgc2VsZi5yZW5kZXJVbmtub3duT3B0aW9uID0gZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgICAgIHZhciB1bmtub3duVmFsID0gJz8gJyArIGhhc2hLZXkodmFsKSArICcgPyc7CiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbi52YWwodW5rbm93blZhbCk7CiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQucHJlcGVuZCh1bmtub3duT3B0aW9uKTsKICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC52YWwodW5rbm93blZhbCk7CiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbi5wcm9wKCdzZWxlY3RlZCcsIHRydWUpOyAvLyBuZWVkZWQgZm9yIElFCiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIHNlbGYuaGFzT3B0aW9uID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnNNYXAuaGFzT3duUHJvcGVydHkodmFsdWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIC8vIGRpc2FibGUgdW5rbm93biBvcHRpb24gc28gdGhhdCB3ZSBkb24ndCBkbyB3b3JrIHdoZW4gdGhlIHdob2xlIHNlbGVjdCBpcyBiZWluZyBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbmRlclVua25vd25PcHRpb24gPSBub29wOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH1dLAoKICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJscykgewogICAgICAgICAgICAgICAgLy8gaWYgbmdNb2RlbCBpcyBub3QgZGVmaW5lZCwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZwogICAgICAgICAgICAgICAgaWYgKCFjdHJsc1sxXSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIHZhciBzZWxlY3RDdHJsID0gY3RybHNbMF0sCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwgPSBjdHJsc1sxXSwKICAgICAgICAgICAgICAgICAgICBtdWx0aXBsZSA9IGF0dHIubXVsdGlwbGUsCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc0V4cCA9IGF0dHIubmdPcHRpb25zLAogICAgICAgICAgICAgICAgICAgIG51bGxPcHRpb24gPSBmYWxzZSwgLy8gaWYgZmFsc2UsIHVzZXIgd2lsbCBub3QgYmUgYWJsZSB0byBzZWxlY3QgaXQgKHVzZWQgYnkgbmdPcHRpb25zKQogICAgICAgICAgICAgICAgICAgIGVtcHR5T3B0aW9uLAogICAgICAgICAgICAgICAgICAgIC8vIHdlIGNhbid0IGp1c3QganFMaXRlKCc8b3B0aW9uPicpIHNpbmNlIGpxTGl0ZSBpcyBub3Qgc21hcnQgZW5vdWdoCiAgICAgICAgICAgICAgICAgICAgLy8gdG8gY3JlYXRlIGl0IGluIDxzZWxlY3Q+IGFuZCBJRSBiYXJmcyBvdGhlcndpc2UuCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uVGVtcGxhdGUgPSBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJykpLAogICAgICAgICAgICAgICAgICAgIG9wdEdyb3VwVGVtcGxhdGUgPSBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0Z3JvdXAnKSksCiAgICAgICAgICAgICAgICAgICAgdW5rbm93bk9wdGlvbiA9IG9wdGlvblRlbXBsYXRlLmNsb25lKCk7CgogICAgICAgICAgICAgICAgLy8gZmluZCAibnVsbCIgb3B0aW9uCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkcmVuKCksIGlpID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbltpXS52YWx1ZSA9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICBlbXB0eU9wdGlvbiA9IG51bGxPcHRpb24gPSBjaGlsZHJlbi5lcShpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuaW5pdChuZ01vZGVsQ3RybCwgbnVsbE9wdGlvbiwgdW5rbm93bk9wdGlvbik7CgogICAgICAgICAgICAgICAgLy8gcmVxdWlyZWQgdmFsaWRhdG9yCiAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUgJiYgKGF0dHIucmVxdWlyZWQgfHwgYXR0ci5uZ1JlcXVpcmVkKSkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXF1aXJlZFZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBuZ01vZGVsQ3RybC4kc2V0VmFsaWRpdHkoJ3JlcXVpcmVkJywgIWF0dHIucmVxdWlyZWQgfHwgKHZhbHVlICYmIHZhbHVlLmxlbmd0aCkpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHBhcnNlcnMucHVzaChyZXF1aXJlZFZhbGlkYXRvcik7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJGZvcm1hdHRlcnMudW5zaGlmdChyZXF1aXJlZFZhbGlkYXRvcik7CgogICAgICAgICAgICAgICAgICAgIGF0dHIuJG9ic2VydmUoJ3JlcXVpcmVkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlZFZhbGlkYXRvcihuZ01vZGVsQ3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAob3B0aW9uc0V4cCkgT3B0aW9ucyhzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwpOwogICAgICAgICAgICAgICAgZWxzZSBpZiAobXVsdGlwbGUpIE11bHRpcGxlKHNjb3BlLCBlbGVtZW50LCBuZ01vZGVsQ3RybCk7CiAgICAgICAgICAgICAgICBlbHNlIFNpbmdsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwsIHNlbGVjdEN0cmwpOwoKCiAgICAgICAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgoKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBTaW5nbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZpZXdWYWx1ZSA9IG5nTW9kZWxDdHJsLiR2aWV3VmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0Q3RybC5oYXNPcHRpb24odmlld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnZhbCh2aWV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSA9PT0gJycpIGVtcHR5T3B0aW9uLnByb3AoJ3NlbGVjdGVkJywgdHJ1ZSk7IC8vIHRvIG1ha2UgSUU5IGhhcHB5CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmlld1ZhbHVlKSAmJiBlbXB0eU9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKCcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW5kZXJVbmtub3duT3B0aW9uKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50Lm9uKCdjaGFuZ2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodW5rbm93bk9wdGlvbi5wYXJlbnQoKSkgdW5rbm93bk9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRzZXRWaWV3VmFsdWUoc2VsZWN0RWxlbWVudC52YWwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIE11bHRpcGxlKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBjdHJsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RWaWV3OwogICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1zID0gbmV3IEhhc2hNYXAoY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yRWFjaChzZWxlY3RFbGVtZW50LmZpbmQoJ29wdGlvbicpLCBmdW5jdGlvbiAob3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBpc0RlZmluZWQoaXRlbXMuZ2V0KG9wdGlvbi52YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBoYXZlIHRvIGRvIGl0IG9uIGVhY2ggd2F0Y2ggc2luY2UgbmdNb2RlbCB3YXRjaGVzIHJlZmVyZW5jZSwgYnV0CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byB3b3JrIG9mIGFuIGFycmF5LCBzbyB3ZSBuZWVkIHRvIHNlZSBpZiBhbnl0aGluZyB3YXMgaW5zZXJ0ZWQvcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBzZWxlY3RNdWx0aXBsZVdhdGNoKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVxdWFscyhsYXN0VmlldywgY3RybC4kdmlld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFZpZXcgPSBjb3B5KGN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHJsLiRyZW5kZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50Lm9uKCdjaGFuZ2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvckVhY2goc2VsZWN0RWxlbWVudC5maW5kKCdvcHRpb24nKSwgZnVuY3Rpb24gKG9wdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChvcHRpb24udmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGFycmF5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gT3B0aW9ucyhzY29wZSwgc2VsZWN0RWxlbWVudCwgY3RybCkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCEobWF0Y2ggPSBvcHRpb25zRXhwLm1hdGNoKE5HX09QVElPTlNfUkVHRVhQKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbWluRXJyKCduZ09wdGlvbnMnKSgnaWV4cCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIkV4cGVjdGVkIGV4cHJlc3Npb24gaW4gZm9ybSBvZiAnX3NlbGVjdF8gKGFzIF9sYWJlbF8pPyBmb3IgKF9rZXlfLCk/X3ZhbHVlXyBpbiBfY29sbGVjdGlvbl8nIGJ1dCBnb3QgJ3swfScuIEVsZW1lbnQ6IHsxfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uc0V4cCwgc3RhcnRpbmdUYWcoc2VsZWN0RWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIGRpc3BsYXlGbiA9ICRwYXJzZShtYXRjaFsyXSB8fCBtYXRjaFsxXSksCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlTmFtZSA9IG1hdGNoWzRdIHx8IG1hdGNoWzZdLAogICAgICAgICAgICAgICAgICAgICAgICBrZXlOYW1lID0gbWF0Y2hbNV0sCiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwQnlGbiA9ICRwYXJzZShtYXRjaFszXSB8fCAnJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlRm4gPSAkcGFyc2UobWF0Y2hbMl0gPyBtYXRjaFsxXSA6IHZhbHVlTmFtZSksCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlc0ZuID0gJHBhcnNlKG1hdGNoWzddKSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2sgPSBtYXRjaFs4XSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tGbiA9IHRyYWNrID8gJHBhcnNlKG1hdGNoWzhdKSA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgb2YgYXJyYXkgb2YgZXhpc3Rpbmcgb3B0aW9uIGdyb3VwcyBpbiBET00uIFdlIHRyeSB0byByZXVzZSB0aGVzZSBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgICAgICAgICAvLyBvcHRpb25Hcm91cHNDYWNoZVswXSBpcyB0aGUgb3B0aW9ucyB3aXRoIG5vIG9wdGlvbiBncm91cAogICAgICAgICAgICAgICAgICAgICAgICAvLyBvcHRpb25Hcm91cHNDYWNoZVs/XVswXSBpcyB0aGUgcGFyZW50OiBlaXRoZXIgdGhlIFNFTEVDVCBvciBPUFRHUk9VUCBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlID0gW1t7IGVsZW1lbnQ6IHNlbGVjdEVsZW1lbnQsIGxhYmVsOiAnJyB9XV07CgogICAgICAgICAgICAgICAgICAgIGlmIChudWxsT3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbXBpbGUgdGhlIGVsZW1lbnQgc2luY2UgdGhlcmUgbWlnaHQgYmUgYmluZGluZ3MgaW4gaXQKICAgICAgICAgICAgICAgICAgICAgICAgJGNvbXBpbGUobnVsbE9wdGlvbikoc2NvcGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBjbGFzcywgd2hpY2ggaXMgYWRkZWQgYXV0b21hdGljYWxseSBiZWNhdXNlIHdlIHJlY29tcGlsZSB0aGUgZWxlbWVudCBhbmQgaXQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmVjb21lcyB0aGUgY29tcGlsYXRpb24gcm9vdAogICAgICAgICAgICAgICAgICAgICAgICBudWxsT3B0aW9uLnJlbW92ZUNsYXNzKCduZy1zY29wZScpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byByZW1vdmUgaXQgYmVmb3JlIGNhbGxpbmcgc2VsZWN0RWxlbWVudC5odG1sKCcnKSBiZWNhdXNlIG90aGVyd2lzZSBJRSB3aWxsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgbGFiZWwgZnJvbSB0aGUgZWxlbWVudC4gd3RmPwogICAgICAgICAgICAgICAgICAgICAgICBudWxsT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gY2xlYXIgY29udGVudHMsIHdlJ2xsIGFkZCB3aGF0J3MgbmVlZGVkIGJhc2VkIG9uIHRoZSBtb2RlbAogICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuaHRtbCgnJyk7CgogICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQub24oJ2NoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uID0gdmFsdWVzRm4oc2NvcGUpIHx8IFtdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleSwgdmFsdWUsIG9wdGlvbkVsZW1lbnQsIGluZGV4LCBncm91cEluZGV4LCBsZW5ndGgsIGdyb3VwTGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChncm91cEluZGV4ID0gMCwgZ3JvdXBMZW5ndGggPSBvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNDYWNoZVtncm91cEluZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW5kZXggPSAxLCBsZW5ndGggPSBvcHRpb25Hcm91cC5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9wdGlvbkVsZW1lbnQgPSBvcHRpb25Hcm91cFtpbmRleF0uZWxlbWVudClbMF0uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBvcHRpb25FbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lKSBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgdHJhY2tJbmRleCA9IDA7IHRyYWNrSW5kZXggPCBjb2xsZWN0aW9uLmxlbmd0aDsgdHJhY2tJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25bdHJhY2tJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHJhY2tGbihzY29wZSwgbG9jYWxzKSA9PSBrZXkpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnB1c2godmFsdWVGbihzY29wZSwgbG9jYWxzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IHNlbGVjdEVsZW1lbnQudmFsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnPycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFja0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciB0cmFja0luZGV4ID0gMDsgdHJhY2tJbmRleCA8IGNvbGxlY3Rpb24ubGVuZ3RoOyB0cmFja0luZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25bdHJhY2tJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4oc2NvcGUsIGxvY2FscykgPT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5TmFtZSkgbG9jYWxzW2tleU5hbWVdID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIGN0cmwuJHJlbmRlciA9IHJlbmRlcjsKCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IGNhbid0IHdlIG9wdGltaXplIHRoaXMgPwogICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChyZW5kZXIpOwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25Hcm91cHMgPSB7ICcnOiBbXSB9LCAvLyBUZW1wb3JhcnkgbG9jYXRpb24gZm9yIHRoZSBvcHRpb24gZ3JvdXBzIGJlZm9yZSB3ZSByZW5kZXIgdGhlbQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcyA9IFsnJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LCBleGlzdGluZ09wdGlvbnMsIGV4aXN0aW5nT3B0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWxWYWx1ZSA9IGN0cmwuJG1vZGVsVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSB2YWx1ZXNGbihzY29wZSkgfHwgW10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlzID0ga2V5TmFtZSA/IHNvcnRlZEtleXModmFsdWVzKSA6IHZhbHVlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwTGVuZ3RoLCBsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4LCBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FscyA9IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IGZhbHNlLCAvLyBub3RoaW5nIGlzIHNlbGVjdGVkIHlldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFja0ZuICYmIGlzQXJyYXkobW9kZWxWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IG5ldyBIYXNoTWFwKFtdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciB0cmFja0luZGV4ID0gMDsgdHJhY2tJbmRleCA8IG1vZGVsVmFsdWUubGVuZ3RoOyB0cmFja0luZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBtb2RlbFZhbHVlW3RyYWNrSW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldC5wdXQodHJhY2tGbihzY29wZSwgbG9jYWxzKSwgbW9kZWxWYWx1ZVt0cmFja0luZGV4XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IG5ldyBIYXNoTWFwKG1vZGVsVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBub3cgYnVpbGQgdXAgdGhlIGxpc3Qgb2Ygb3B0aW9ucyB3ZSBuZWVkICh3ZSBtZXJnZSBsYXRlcikKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpbmRleCA9IDA7IGxlbmd0aCA9IGtleXMubGVuZ3RoLCBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSB2YWx1ZXNba2V5TmFtZSA/IGxvY2Fsc1trZXlOYW1lXSA9IGtleXNbaW5kZXhdIDogaW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lID0gZ3JvdXBCeUZuKHNjb3BlLCBsb2NhbHMpIHx8ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEob3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcy5wdXNoKG9wdGlvbkdyb3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZCA9IHNlbGVjdGVkU2V0LnJlbW92ZSh0cmFja0ZuID8gdHJhY2tGbihzY29wZSwgbG9jYWxzKSA6IHZhbHVlRm4oc2NvcGUsIGxvY2FscykpICE9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZGVsQ2FzdCA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbENhc3RbdmFsdWVOYW1lXSA9IG1vZGVsVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gdHJhY2tGbihzY29wZSwgbW9kZWxDYXN0KSA9PT0gdHJhY2tGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZCA9IG1vZGVsVmFsdWUgPT09IHZhbHVlRm4oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gc2VsZWN0ZWRTZXQgfHwgc2VsZWN0ZWQ7IC8vIHNlZSBpZiBhdCBsZWFzdCBvbmUgaXRlbSBpcyBzZWxlY3RlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBkaXNwbGF5Rm4oc2NvcGUsIGxvY2Fscyk7IC8vIHdoYXQgd2lsbCBiZSBzZWVuIGJ5IHRoZSB1c2VyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IGxhYmVsID09PSB1bmRlZmluZWQgPyAnJyA6IGxhYmVsOyAvLyBkb2luZyBkaXNwbGF5Rm4oc2NvcGUsIGxvY2FscykgfHwgJycgb3ZlcndyaXRlcyB6ZXJvIHZhbHVlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHRyYWNrRm4gPyB0cmFja0ZuKHNjb3BlLCBsb2NhbHMpIDogKGtleU5hbWUgPyBrZXlzW2luZGV4XSA6IGluZGV4KSwgICAvLyBlaXRoZXIgdGhlIGluZGV4IGludG8gYXJyYXkgb3Iga2V5IGZyb20gb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGxhYmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBzZWxlY3RlZCAgICAgICAgICAgICAgICAgICAvLyBkZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGJlIHNlbGVjdGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobnVsbE9wdGlvbiB8fCBtb2RlbFZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW5zZXJ0IG51bGwgb3B0aW9uIGlmIHdlIGhhdmUgYSBwbGFjZWhvbGRlciwgb3IgdGhlIG1vZGVsIGlzIG51bGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNbJyddLnVuc2hpZnQoeyBpZDogJycsIGxhYmVsOiAnJywgc2VsZWN0ZWQ6ICFzZWxlY3RlZFNldCB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNlbGVjdGVkU2V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uIGNvdWxkIG5vdCBiZSBmb3VuZCwgd2UgaGF2ZSB0byBpbnNlcnQgdGhlIHVuZGVmaW5lZCBpdGVtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzWycnXS51bnNoaWZ0KHsgaWQ6ICc/JywgbGFiZWw6ICcnLCBzZWxlY3RlZDogdHJ1ZSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm93IHdlIG5lZWQgdG8gdXBkYXRlIHRoZSBsaXN0IG9mIERPTSBub2RlcyB0byBtYXRjaCB0aGUgb3B0aW9uR3JvdXBzIHdlIGNvbXB1dGVkIGFib3ZlCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoZ3JvdXBJbmRleCA9IDAsIGdyb3VwTGVuZ3RoID0gb3B0aW9uR3JvdXBOYW1lcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCA8IGdyb3VwTGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY3VycmVudCBvcHRpb24gZ3JvdXAgbmFtZSBvciAnJyBpZiBubyBncm91cAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lID0gb3B0aW9uR3JvdXBOYW1lc1tncm91cEluZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsaXN0IG9mIG9wdGlvbnMgZm9yIHRoYXQgZ3JvdXAuIChmaXJzdCBpdGVtIGhhcyB0aGUgcGFyZW50KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uR3JvdXBzQ2FjaGUubGVuZ3RoIDw9IGdyb3VwSW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGdyb3cgdGhlIG9wdGlvbkdyb3VwcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50OiBvcHRHcm91cFRlbXBsYXRlLmNsb25lKCkuYXR0cignbGFiZWwnLCBvcHRpb25Hcm91cE5hbWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uR3JvdXAubGFiZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucyA9IFtleGlzdGluZ1BhcmVudF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUucHVzaChleGlzdGluZ09wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuYXBwZW5kKGV4aXN0aW5nUGFyZW50LmVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBvcHRpb25Hcm91cHNDYWNoZVtncm91cEluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCA9IGV4aXN0aW5nT3B0aW9uc1swXTsgIC8vIGVpdGhlciBTRUxFQ1QgKG5vIGdyb3VwKSBvciBPUFRHUk9VUCBlbGVtZW50CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSB0aGUgT1BUR1JPVVAgbGFiZWwgaWYgbm90IHRoZSBzYW1lLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1BhcmVudC5sYWJlbCAhPSBvcHRpb25Hcm91cE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQuZWxlbWVudC5hdHRyKCdsYWJlbCcsIGV4aXN0aW5nUGFyZW50LmxhYmVsID0gb3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBudWxsOyAgLy8gc3RhcnQgYXQgdGhlIGJlZ2lubmluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpbmRleCA9IDAsIGxlbmd0aCA9IG9wdGlvbkdyb3VwLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24gPSBvcHRpb25Hcm91cFtpbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChleGlzdGluZ09wdGlvbiA9IGV4aXN0aW5nT3B0aW9uc1tpbmRleCArIDFdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZXVzZSBlbGVtZW50cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGV4aXN0aW5nT3B0aW9uLmVsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ09wdGlvbi5sYWJlbCAhPT0gb3B0aW9uLmxhYmVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC50ZXh0KGV4aXN0aW5nT3B0aW9uLmxhYmVsID0gb3B0aW9uLmxhYmVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24uaWQgIT09IG9wdGlvbi5pZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQudmFsKGV4aXN0aW5nT3B0aW9uLmlkID0gb3B0aW9uLmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsYXN0RWxlbWVudC5wcm9wKCdzZWxlY3RlZCcpIHByb3ZpZGVkIGJ5IGpRdWVyeSBoYXMgc2lkZS1lZmZlY3RzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYXN0RWxlbWVudFswXS5zZWxlY3RlZCAhPT0gb3B0aW9uLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC5wcm9wKCdzZWxlY3RlZCcsIChleGlzdGluZ09wdGlvbi5zZWxlY3RlZCA9IG9wdGlvbi5zZWxlY3RlZCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZ3JvdyBlbGVtZW50cwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgaXQncyBhIG51bGwgb3B0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24uaWQgPT09ICcnICYmIG51bGxPcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHB1dCBiYWNrIHRoZSBwcmUtY29tcGlsZWQgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCA9IG51bGxPcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBqUXVlcnkodjEuNC4yKSBCdWc6IFdlIHNob3VsZCBiZSBhYmxlIHRvIGNoYWluIHRoZSBtZXRob2QgY2FsbHMsIGJ1dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW4gdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSBvbiBzb21lIGJyb3dzZXIgdGhlIC50ZXh0KCkgcmV0dXJucyBhIHN0cmluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmF0aGVyIHRoZW4gdGhlIGVsZW1lbnQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZWxlbWVudCA9IG9wdGlvblRlbXBsYXRlLmNsb25lKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnZhbChvcHRpb24uaWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmF0dHIoJ3NlbGVjdGVkJywgb3B0aW9uLnNlbGVjdGVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50ZXh0KG9wdGlvbi5sYWJlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucy5wdXNoKGV4aXN0aW5nT3B0aW9uID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogZWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb24ubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogb3B0aW9uLmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IG9wdGlvbi5zZWxlY3RlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC5hZnRlcihlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXBwZW5kKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRJT05zIGluIGEgZ3JvdXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4Kys7IC8vIGluY3JlbWVudCBzaW5jZSB0aGUgZXhpc3RpbmdPcHRpb25zWzBdIGlzIHBhcmVudCBlbGVtZW50IG5vdCBPUFRJT04KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChleGlzdGluZ09wdGlvbnMubGVuZ3RoID4gaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucG9wKCkuZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRHUk9VUHMgZnJvbSBzZWxlY3QKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA+IGdyb3VwSW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnBvcCgpWzBdLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9XTsKCiAgICB2YXIgb3B0aW9uRGlyZWN0aXZlID0gWyckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbiAoJGludGVycG9sYXRlKSB7CiAgICAgICAgdmFyIG51bGxTZWxlY3RDdHJsID0gewogICAgICAgICAgICBhZGRPcHRpb246IG5vb3AsCiAgICAgICAgICAgIHJlbW92ZU9wdGlvbjogbm9vcAogICAgICAgIH07CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoYXR0ci52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShlbGVtZW50LnRleHQoKSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBlbGVtZW50LnRleHQoKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0Q3RybE5hbWUgPSAnJHNlbGVjdENvbnRyb2xsZXInLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudCgpLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RDdHJsID0gcGFyZW50LmRhdGEoc2VsZWN0Q3RybE5hbWUpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50LnBhcmVudCgpLmRhdGEoc2VsZWN0Q3RybE5hbWUpOyAvLyBpbiBjYXNlIHdlIGFyZSBpbiBvcHRncm91cAoKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0Q3RybCAmJiBzZWxlY3RDdHJsLmRhdGFib3VuZCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3Igc29tZSByZWFzb24gT3BlcmEgZGVmYXVsdHMgdG8gdHJ1ZSBhbmQgaWYgbm90IG92ZXJyaWRkZW4gdGhpcyBtZXNzZXMgdXAgdGhlIHJlcGVhdGVyLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBkb24ndCB3YW50IHRoZSB2aWV3IHRvIGRyaXZlIHRoZSBpbml0aWFsaXphdGlvbiBvZiB0aGUgbW9kZWwgYW55d2F5LgogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnByb3AoJ3NlbGVjdGVkJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwgPSBudWxsU2VsZWN0Q3RybDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZVdhdGNoQWN0aW9uKG5ld1ZhbCwgb2xkVmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgbmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdWYWwgIT09IG9sZFZhbCkgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24ob2xkVmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKG5ld1ZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5vbignJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwucmVtb3ZlT3B0aW9uKGF0dHIudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH1dOwoKICAgIHZhciBzdHlsZURpcmVjdGl2ZSA9IHZhbHVlRm4oewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgdGVybWluYWw6IHRydWUKICAgIH0pOwoKICAgIC8vdHJ5IHRvIGJpbmQgdG8ganF1ZXJ5IG5vdyBzbyB0aGF0IG9uZSBjYW4gd3JpdGUgYW5ndWxhci5lbGVtZW50KCkucmVhZCgpCiAgICAvL2J1dCB3ZSB3aWxsIHJlYmluZCBvbiBib290c3RyYXAgYWdhaW4uCiAgICBiaW5kSlF1ZXJ5KCk7CgogICAgcHVibGlzaEV4dGVybmFsQVBJKGFuZ3VsYXIpOwoKICAgIGpxTGl0ZShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24gKCkgewogICAgICAgIGFuZ3VsYXJJbml0KGRvY3VtZW50LCBib290c3RyYXApOwogICAgfSk7Cgp9KSh3aW5kb3csIGRvY3VtZW50KTsKYW5ndWxhci5lbGVtZW50KGRvY3VtZW50KS5maW5kKCdoZWFkJykucHJlcGVuZCgnPHN0eWxlIHR5cGU9InRleHQvY3NzIj5AY2hhcnNldCAiVVRGLTgiO1tuZ1xcOmNsb2FrXSxbbmctY2xvYWtdLFtkYXRhLW5nLWNsb2FrXSxbeC1uZy1jbG9ha10sLm5nLWNsb2FrLC54LW5nLWNsb2FrLC5uZy1oaWRle2Rpc3BsYXk6bm9uZSAhaW1wb3J0YW50O31uZ1xcOmZvcm17ZGlzcGxheTpibG9jazt9PC9zdHlsZT4nKTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 07:24:54 GMT",
                    "Content-Length": "768125",
                    "Date": "Thu, 06 Nov 2014 07:24:54 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}