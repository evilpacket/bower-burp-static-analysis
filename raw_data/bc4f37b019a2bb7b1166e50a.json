{
    "url": "http://localhost:9999/lhorie/mithril.js/archive/v0.1.16/mithril.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>window.location.pathname</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>element.href = window.location.pathname + modes[m.route.mode] + element.pathname</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/lhorie/mithril.js/archive/v0.1.16/mithril.js",
                "path": "/lhorie/mithril.js/archive/v0.1.16/mithril.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9saG9yaWUvbWl0aHJpbC5qcy9hcmNoaXZlL3YwLjEuMTYvbWl0aHJpbC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjI1OTINCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMTY6MTI6MTkgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDE2OjEyOjE3IEdNVA0KDQpNaXRocmlsID0gbSA9IG5ldyBmdW5jdGlvbiBhcHAod2luZG93KSB7Cgl2YXIgc2VsZWN0b3JDYWNoZSA9IHt9Cgl2YXIgdHlwZSA9IHt9LnRvU3RyaW5nCgl2YXIgcGFyc2VyID0gLyg/OihefCN8XC4pKFteI1wuXFtcXV0rKSl8KFxbLis/XF0pL2csIGF0dHJQYXJzZXIgPSAvXFsoLis/KSg/Oj0oInwnfCkoLis/KVwyKT9cXS8KCglmdW5jdGlvbiBtKCkgewoJCXZhciBhcmdzID0gYXJndW1lbnRzCgkJdmFyIGhhc0F0dHJzID0gdHlwZS5jYWxsKGFyZ3NbMV0pID09ICJbb2JqZWN0IE9iamVjdF0iICYmICEoInRhZyIgaW4gYXJnc1sxXSkgJiYgISgic3VidHJlZSIgaW4gYXJnc1sxXSkKCQl2YXIgYXR0cnMgPSBoYXNBdHRycyA/IGFyZ3NbMV0gOiB7fQoJCXZhciBjbGFzc0F0dHJOYW1lID0gImNsYXNzIiBpbiBhdHRycyA/ICJjbGFzcyIgOiAiY2xhc3NOYW1lIgoJCXZhciBjZWxsID0gc2VsZWN0b3JDYWNoZVthcmdzWzBdXQoJCWlmIChjZWxsID09PSB1bmRlZmluZWQpIHsKCQkJc2VsZWN0b3JDYWNoZVthcmdzWzBdXSA9IGNlbGwgPSB7dGFnOiAiZGl2IiwgYXR0cnM6IHt9fQoJCQl2YXIgbWF0Y2gsIGNsYXNzZXMgPSBbXQoJCQl3aGlsZSAobWF0Y2ggPSBwYXJzZXIuZXhlYyhhcmdzWzBdKSkgewoJCQkJaWYgKG1hdGNoWzFdID09ICIiKSBjZWxsLnRhZyA9IG1hdGNoWzJdCgkJCQllbHNlIGlmIChtYXRjaFsxXSA9PSAiIyIpIGNlbGwuYXR0cnMuaWQgPSBtYXRjaFsyXQoJCQkJZWxzZSBpZiAobWF0Y2hbMV0gPT0gIi4iKSBjbGFzc2VzLnB1c2gobWF0Y2hbMl0pCgkJCQllbHNlIGlmIChtYXRjaFszXVswXSA9PSAiWyIpIHsKCQkJCQl2YXIgcGFpciA9IGF0dHJQYXJzZXIuZXhlYyhtYXRjaFszXSkKCQkJCQljZWxsLmF0dHJzW3BhaXJbMV1dID0gcGFpclszXSB8fCB0cnVlCgkJCQl9CgkJCX0KCQkJaWYgKGNsYXNzZXMubGVuZ3RoID4gMCkgY2VsbC5hdHRyc1tjbGFzc0F0dHJOYW1lXSA9IGNsYXNzZXMuam9pbigiICIpCgkJfQoJCWNlbGwgPSBjbG9uZShjZWxsKQoJCWNlbGwuYXR0cnMgPSBjbG9uZShjZWxsLmF0dHJzKQoJCWNlbGwuY2hpbGRyZW4gPSBoYXNBdHRycyA/IGFyZ3NbMl0gOiBhcmdzWzFdCgkJZm9yICh2YXIgYXR0ck5hbWUgaW4gYXR0cnMpIHsKCQkJaWYgKGF0dHJOYW1lID09IGNsYXNzQXR0ck5hbWUpIGNlbGwuYXR0cnNbYXR0ck5hbWVdID0gKGNlbGwuYXR0cnNbYXR0ck5hbWVdIHx8ICIiKSArICIgIiArIGF0dHJzW2F0dHJOYW1lXQoJCQllbHNlIGNlbGwuYXR0cnNbYXR0ck5hbWVdID0gYXR0cnNbYXR0ck5hbWVdCgkJfQoJCXJldHVybiBjZWxsCgl9CglmdW5jdGlvbiBidWlsZChwYXJlbnRFbGVtZW50LCBwYXJlbnRUYWcsIHBhcmVudENhY2hlLCBwYXJlbnRJbmRleCwgZGF0YSwgY2FjaGVkLCBzaG91bGRSZWF0dGFjaCwgaW5kZXgsIGVkaXRhYmxlLCBuYW1lc3BhY2UsIGNvbmZpZ3MpIHsKCQlpZiAoZGF0YSA9PT0gbnVsbCB8fCBkYXRhID09PSB1bmRlZmluZWQpIGRhdGEgPSAiIgoJCWlmIChkYXRhLnN1YnRyZWUgPT09ICJyZXRhaW4iKSByZXR1cm4KCgkJdmFyIGNhY2hlZFR5cGUgPSB0eXBlLmNhbGwoY2FjaGVkKSwgZGF0YVR5cGUgPSB0eXBlLmNhbGwoZGF0YSkKCQlpZiAoY2FjaGVkVHlwZSAhPSBkYXRhVHlwZSkgewoJCQlpZiAoY2FjaGVkICE9PSBudWxsICYmIGNhY2hlZCAhPT0gdW5kZWZpbmVkKSB7CgkJCQlpZiAocGFyZW50Q2FjaGUgJiYgcGFyZW50Q2FjaGUubm9kZXMpIHsKCQkJCQl2YXIgb2Zmc2V0ID0gaW5kZXggLSBwYXJlbnRJbmRleAoJCQkJCWNsZWFyKHBhcmVudENhY2hlLm5vZGVzLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgKGRhdGFUeXBlID09ICJbb2JqZWN0IEFycmF5XSIgPyBkYXRhIDogY2FjaGVkLm5vZGVzKS5sZW5ndGgpKQoJCQkJfQoJCQkJZWxzZSBjbGVhcihjYWNoZWQubm9kZXMpCgkJCX0KCQkJY2FjaGVkID0gbmV3IGRhdGEuY29uc3RydWN0b3IKCQkJY2FjaGVkLm5vZGVzID0gW10KCQl9CgoJCWlmIChkYXRhVHlwZSA9PSAiW29iamVjdCBBcnJheV0iKSB7CgkJCXZhciBub2RlcyA9IFtdLCBpbnRhY3QgPSBjYWNoZWQubGVuZ3RoID09PSBkYXRhLmxlbmd0aCwgc3ViQXJyYXlDb3VudCA9IDAKCQkJCgkJCXZhciBERUxFVElPTiA9IDEsIElOU0VSVElPTiA9IDIgLCBNT1ZFID0gMwoJCQl2YXIgZXhpc3RpbmcgPSB7fSwgc2hvdWxkTWFpbnRhaW5JZGVudGl0aWVzID0gZmFsc2UKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBjYWNoZWQubGVuZ3RoOyBpKyspIHsKCQkJCWlmIChjYWNoZWRbaV0gJiYgY2FjaGVkW2ldLmF0dHJzICYmIGNhY2hlZFtpXS5hdHRycy5rZXkgIT09IHVuZGVmaW5lZCkgewoJCQkJCXNob3VsZE1haW50YWluSWRlbnRpdGllcyA9IHRydWUKCQkJCQlleGlzdGluZ1tjYWNoZWRbaV0uYXR0cnMua2V5XSA9IHthY3Rpb246IERFTEVUSU9OLCBpbmRleDogaX0KCQkJCX0KCQkJfQoJCQlpZiAoc2hvdWxkTWFpbnRhaW5JZGVudGl0aWVzKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKCQkJCQlpZiAoZGF0YVtpXSAmJiBkYXRhW2ldLmF0dHJzICYmIGRhdGFbaV0uYXR0cnMua2V5ICE9PSB1bmRlZmluZWQpIHsKCQkJCQkJdmFyIGtleSA9IGRhdGFbaV0uYXR0cnMua2V5CgkJCQkJCWlmICghZXhpc3Rpbmdba2V5XSkgZXhpc3Rpbmdba2V5XSA9IHthY3Rpb246IElOU0VSVElPTiwgaW5kZXg6IGl9CgkJCQkJCWVsc2UgZXhpc3Rpbmdba2V5XSA9IHthY3Rpb246IE1PVkUsIGluZGV4OiBpLCBmcm9tOiBleGlzdGluZ1trZXldLmluZGV4LCBlbGVtZW50OiBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbZXhpc3Rpbmdba2V5XS5pbmRleF19CgkJCQkJfQoJCQkJfQoJCQkJdmFyIGFjdGlvbnMgPSBPYmplY3Qua2V5cyhleGlzdGluZykubWFwKGZ1bmN0aW9uKGtleSkge3JldHVybiBleGlzdGluZ1trZXldfSkKCQkJCXZhciBjaGFuZ2VzID0gYWN0aW9ucy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHtyZXR1cm4gYS5hY3Rpb24gLSBiLmFjdGlvbiB8fCBiLmluZGV4IC0gYS5pbmRleH0pCgkJCQl2YXIgbmV3Q2FjaGVkID0gbmV3IEFycmF5KGNhY2hlZC5sZW5ndGgpCgkJCQkKCQkJCWZvciAodmFyIGkgPSAwLCBjaGFuZ2U7IGNoYW5nZSA9IGNoYW5nZXNbaV07IGkrKykgewoJCQkJCWlmIChjaGFuZ2UuYWN0aW9uID09IERFTEVUSU9OKSB7CgkJCQkJCWNsZWFyKGNhY2hlZFtjaGFuZ2UuaW5kZXhdLm5vZGVzKQoJCQkJCQluZXdDYWNoZWQuc3BsaWNlKGNoYW5nZS5pbmRleCwgMSkKCQkJCQl9CgkJCQkJaWYgKGNoYW5nZS5hY3Rpb24gPT0gSU5TRVJUSU9OKSB7CgkJCQkJCXZhciBkdW1teSA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCQkJCQlkdW1teS5rZXkgPSBkYXRhW2NoYW5nZS5pbmRleF0uYXR0cnMua2V5LnRvU3RyaW5nKCkKCQkJCQkJcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUoZHVtbXksIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tjaGFuZ2UuaW5kZXhdKQoJCQkJCQluZXdDYWNoZWQuc3BsaWNlKGNoYW5nZS5pbmRleCwgMCwge2F0dHJzOiB7a2V5OiBkYXRhW2NoYW5nZS5pbmRleF0uYXR0cnMua2V5fSwgbm9kZXM6IFtkdW1teV19KQoJCQkJCX0KCQkJCQkKCQkJCQlpZiAoY2hhbmdlLmFjdGlvbiA9PSBNT1ZFKSB7CgkJCQkJCWlmIChwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbY2hhbmdlLmluZGV4XSAhPT0gY2hhbmdlLmVsZW1lbnQpIHsKCQkJCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNoYW5nZS5lbGVtZW50LCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbY2hhbmdlLmluZGV4XSkKCQkJCQkJfQoJCQkJCQluZXdDYWNoZWRbY2hhbmdlLmluZGV4XSA9IGNhY2hlZFtjaGFuZ2UuZnJvbV0KCQkJCQl9CgkJCQl9CgkJCQljYWNoZWQgPSBuZXdDYWNoZWQKCQkJCWNhY2hlZC5ub2RlcyA9IFtdCgkJCQlmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2ldOyBpKyspIGNhY2hlZC5ub2Rlcy5wdXNoKGNoaWxkKQoJCQl9CgkJCQoJCQlmb3IgKHZhciBpID0gMCwgY2FjaGVDb3VudCA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCQl2YXIgaXRlbSA9IGJ1aWxkKHBhcmVudEVsZW1lbnQsIHBhcmVudFRhZywgY2FjaGVkLCBpbmRleCwgZGF0YVtpXSwgY2FjaGVkW2NhY2hlQ291bnRdLCBzaG91bGRSZWF0dGFjaCwgaW5kZXggKyBzdWJBcnJheUNvdW50IHx8IHN1YkFycmF5Q291bnQsIGVkaXRhYmxlLCBuYW1lc3BhY2UsIGNvbmZpZ3MpCgkJCQlpZiAoaXRlbSA9PT0gdW5kZWZpbmVkKSBjb250aW51ZQoJCQkJaWYgKCFpdGVtLm5vZGVzLmludGFjdCkgaW50YWN0ID0gZmFsc2UKCQkJCXN1YkFycmF5Q291bnQgKz0gaXRlbSBpbnN0YW5jZW9mIEFycmF5ID8gaXRlbS5sZW5ndGggOiAxCgkJCQljYWNoZWRbY2FjaGVDb3VudCsrXSA9IGl0ZW0KCQkJfQoJCQlpZiAoIWludGFjdCkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCQkJaWYgKGNhY2hlZFtpXSAhPT0gdW5kZWZpbmVkKSBub2RlcyA9IG5vZGVzLmNvbmNhdChjYWNoZWRbaV0ubm9kZXMpCgkJCQl9CgkJCQlmb3IgKHZhciBpID0gbm9kZXMubGVuZ3RoLCBub2RlOyBub2RlID0gY2FjaGVkLm5vZGVzW2ldOyBpKyspIHsKCQkJCQlpZiAobm9kZS5wYXJlbnROb2RlICE9PSBudWxsICYmIG5vZGUucGFyZW50Tm9kZS5jaGlsZE5vZGVzLmxlbmd0aCAhPSBub2Rlcy5sZW5ndGgpIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKQoJCQkJfQoJCQkJZm9yICh2YXIgaSA9IGNhY2hlZC5ub2Rlcy5sZW5ndGgsIG5vZGU7IG5vZGUgPSBub2Rlc1tpXTsgaSsrKSB7CgkJCQkJaWYgKG5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgcGFyZW50RWxlbWVudC5hcHBlbmRDaGlsZChub2RlKQoJCQkJfQoJCQkJaWYgKGRhdGEubGVuZ3RoIDwgY2FjaGVkLmxlbmd0aCkgY2FjaGVkLmxlbmd0aCA9IGRhdGEubGVuZ3RoCgkJCQljYWNoZWQubm9kZXMgPSBub2RlcwoJCQl9CgkJCQoJCX0KCQllbHNlIGlmIChkYXRhVHlwZSA9PSAiW29iamVjdCBPYmplY3RdIikgewoJCQlpZiAoZGF0YS50YWcgIT0gY2FjaGVkLnRhZyB8fCBPYmplY3Qua2V5cyhkYXRhLmF0dHJzKS5qb2luKCkgIT0gT2JqZWN0LmtleXMoY2FjaGVkLmF0dHJzKS5qb2luKCkgfHwgZGF0YS5hdHRycy5pZCAhPSBjYWNoZWQuYXR0cnMuaWQpIGNsZWFyKGNhY2hlZC5ub2RlcykKCQkJaWYgKHR5cGVvZiBkYXRhLnRhZyAhPSAic3RyaW5nIikgcmV0dXJuCgoJCQl2YXIgbm9kZSwgaXNOZXcgPSBjYWNoZWQubm9kZXMubGVuZ3RoID09PSAwCgkJCWlmIChkYXRhLmF0dHJzLnhtbG5zKSBuYW1lc3BhY2UgPSBkYXRhLmF0dHJzLnhtbG5zCgkJCWVsc2UgaWYgKGRhdGEudGFnID09PSAic3ZnIikgbmFtZXNwYWNlID0gImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgoJCQlpZiAoaXNOZXcpIHsKCQkJCW5vZGUgPSBuYW1lc3BhY2UgPT09IHVuZGVmaW5lZCA/IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KGRhdGEudGFnKSA6IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMobmFtZXNwYWNlLCBkYXRhLnRhZykKCQkJCWNhY2hlZCA9IHsKCQkJCQl0YWc6IGRhdGEudGFnLAoJCQkJCWF0dHJzOiBzZXRBdHRyaWJ1dGVzKG5vZGUsIGRhdGEudGFnLCBkYXRhLmF0dHJzLCB7fSwgbmFtZXNwYWNlKSwKCQkJCQljaGlsZHJlbjogZGF0YS5jaGlsZHJlbiAhPT0gdW5kZWZpbmVkID8gYnVpbGQobm9kZSwgZGF0YS50YWcsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBkYXRhLmNoaWxkcmVuLCBjYWNoZWQuY2hpbGRyZW4sIHRydWUsIDAsIGRhdGEuYXR0cnMuY29udGVudGVkaXRhYmxlID8gbm9kZSA6IGVkaXRhYmxlLCBuYW1lc3BhY2UsIGNvbmZpZ3MpIDogdW5kZWZpbmVkLAoJCQkJCW5vZGVzOiBbbm9kZV0KCQkJCX0KCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJfQoJCQllbHNlIHsKCQkJCW5vZGUgPSBjYWNoZWQubm9kZXNbMF0KCQkJCXNldEF0dHJpYnV0ZXMobm9kZSwgZGF0YS50YWcsIGRhdGEuYXR0cnMsIGNhY2hlZC5hdHRycywgbmFtZXNwYWNlKQoJCQkJY2FjaGVkLmNoaWxkcmVuID0gYnVpbGQobm9kZSwgZGF0YS50YWcsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBkYXRhLmNoaWxkcmVuLCBjYWNoZWQuY2hpbGRyZW4sIGZhbHNlLCAwLCBkYXRhLmF0dHJzLmNvbnRlbnRlZGl0YWJsZSA/IG5vZGUgOiBlZGl0YWJsZSwgbmFtZXNwYWNlLCBjb25maWdzKQoJCQkJY2FjaGVkLm5vZGVzLmludGFjdCA9IHRydWUKCQkJCWlmIChzaG91bGRSZWF0dGFjaCA9PT0gdHJ1ZSkgcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUobm9kZSwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XSB8fCBudWxsKQoJCQl9CgkJCWlmICh0eXBlLmNhbGwoZGF0YS5hdHRyc1siY29uZmlnIl0pID09ICJbb2JqZWN0IEZ1bmN0aW9uXSIpIHsKCQkJCWNvbmZpZ3MucHVzaChkYXRhLmF0dHJzWyJjb25maWciXS5iaW5kKHdpbmRvdywgbm9kZSwgIWlzTmV3LCBjYWNoZWQuY29uZmlnQ29udGV4dCA9IGNhY2hlZC5jb25maWdDb250ZXh0IHx8IHt9KSkKCQkJfQoJCX0KCQllbHNlIHsKCQkJdmFyIG5vZGVzCgkJCWlmIChjYWNoZWQubm9kZXMubGVuZ3RoID09PSAwKSB7CgkJCQlpZiAoZGF0YS4kdHJ1c3RlZCkgewoJCQkJCW5vZGVzID0gaW5qZWN0SFRNTChwYXJlbnRFbGVtZW50LCBpbmRleCwgZGF0YSkKCQkJCX0KCQkJCWVsc2UgewoJCQkJCW5vZGVzID0gW3dpbmRvdy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShkYXRhKV0KCQkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShub2Rlc1swXSwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XSB8fCBudWxsKQoJCQkJfQoJCQkJY2FjaGVkID0gInN0cmluZyBudW1iZXIgYm9vbGVhbiIuaW5kZXhPZih0eXBlb2YgZGF0YSkgPiAtMSA/IG5ldyBkYXRhLmNvbnN0cnVjdG9yKGRhdGEpIDogZGF0YQoJCQkJY2FjaGVkLm5vZGVzID0gbm9kZXMKCQkJfQoJCQllbHNlIGlmIChjYWNoZWQudmFsdWVPZigpICE9PSBkYXRhLnZhbHVlT2YoKSB8fCBzaG91bGRSZWF0dGFjaCA9PT0gdHJ1ZSkgewoJCQkJbm9kZXMgPSBjYWNoZWQubm9kZXMKCQkJCWlmICghZWRpdGFibGUgfHwgZWRpdGFibGUgIT09IHdpbmRvdy5kb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7CgkJCQkJaWYgKGRhdGEuJHRydXN0ZWQpIHsKCQkJCQkJY2xlYXIobm9kZXMpCgkJCQkJCW5vZGVzID0gaW5qZWN0SFRNTChwYXJlbnRFbGVtZW50LCBpbmRleCwgZGF0YSkKCQkJCQl9CgkJCQkJZWxzZSB7CgkJCQkJCWlmIChwYXJlbnRUYWcgPT09ICJ0ZXh0YXJlYSIpIHBhcmVudEVsZW1lbnQudmFsdWUgPSBkYXRhCgkJCQkJCWVsc2UgaWYgKGVkaXRhYmxlKSBlZGl0YWJsZS5pbm5lckhUTUwgPSBkYXRhCgkJCQkJCWVsc2UgewoJCQkJCQkJaWYgKG5vZGVzWzBdLm5vZGVUeXBlID09IDEgfHwgbm9kZXMubGVuZ3RoID4gMSkgeyAvL3dhcyBhIHRydXN0ZWQgc3RyaW5nCgkJCQkJCQkJY2xlYXIoY2FjaGVkLm5vZGVzKQoJCQkJCQkJCW5vZGVzID0gW3dpbmRvdy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShkYXRhKV0KCQkJCQkJCX0KCQkJCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGVzWzBdLCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdIHx8IG51bGwpCgkJCQkJCQlub2Rlc1swXS5ub2RlVmFsdWUgPSBkYXRhCgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQljYWNoZWQgPSBuZXcgZGF0YS5jb25zdHJ1Y3RvcihkYXRhKQoJCQkJY2FjaGVkLm5vZGVzID0gbm9kZXMKCQkJfQoJCQllbHNlIGNhY2hlZC5ub2Rlcy5pbnRhY3QgPSB0cnVlCgkJfQoKCQlyZXR1cm4gY2FjaGVkCgl9CglmdW5jdGlvbiBzZXRBdHRyaWJ1dGVzKG5vZGUsIHRhZywgZGF0YUF0dHJzLCBjYWNoZWRBdHRycywgbmFtZXNwYWNlKSB7CgkJZm9yICh2YXIgYXR0ck5hbWUgaW4gZGF0YUF0dHJzKSB7CgkJCXZhciBkYXRhQXR0ciA9IGRhdGFBdHRyc1thdHRyTmFtZV0KCQkJdmFyIGNhY2hlZEF0dHIgPSBjYWNoZWRBdHRyc1thdHRyTmFtZV0KCQkJaWYgKCEoYXR0ck5hbWUgaW4gY2FjaGVkQXR0cnMpIHx8IChjYWNoZWRBdHRyICE9PSBkYXRhQXR0cikgfHwgbm9kZSA9PT0gd2luZG93LmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpIHsKCQkJCWNhY2hlZEF0dHJzW2F0dHJOYW1lXSA9IGRhdGFBdHRyCgkJCQlpZiAoYXR0ck5hbWUgPT09ICJjb25maWciKSBjb250aW51ZQoJCQkJZWxzZSBpZiAodHlwZW9mIGRhdGFBdHRyID09ICJmdW5jdGlvbiIgJiYgYXR0ck5hbWUuaW5kZXhPZigib24iKSA9PSAwKSB7CgkJCQkJbm9kZVthdHRyTmFtZV0gPSBhdXRvcmVkcmF3KGRhdGFBdHRyLCBub2RlKQoJCQkJfQoJCQkJZWxzZSBpZiAoYXR0ck5hbWUgPT09ICJzdHlsZSIgJiYgdHlwZW9mIGRhdGFBdHRyID09ICJvYmplY3QiKSB7CgkJCQkJZm9yICh2YXIgcnVsZSBpbiBkYXRhQXR0cikgewoJCQkJCQlpZiAoY2FjaGVkQXR0ciA9PT0gdW5kZWZpbmVkIHx8IGNhY2hlZEF0dHJbcnVsZV0gIT09IGRhdGFBdHRyW3J1bGVdKSBub2RlLnN0eWxlW3J1bGVdID0gZGF0YUF0dHJbcnVsZV0KCQkJCQl9CgkJCQkJZm9yICh2YXIgcnVsZSBpbiBjYWNoZWRBdHRyKSB7CgkJCQkJCWlmICghKHJ1bGUgaW4gZGF0YUF0dHIpKSBub2RlLnN0eWxlW3J1bGVdID0gIiIKCQkJCQl9CgkJCQl9CgkJCQllbHNlIGlmIChuYW1lc3BhY2UgIT09IHVuZGVmaW5lZCkgewoJCQkJCWlmIChhdHRyTmFtZSA9PT0gImhyZWYiKSBub2RlLnNldEF0dHJpYnV0ZU5TKCJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwgImhyZWYiLCBkYXRhQXR0cikKCQkJCQllbHNlIGlmIChhdHRyTmFtZSA9PT0gImNsYXNzTmFtZSIpIG5vZGUuc2V0QXR0cmlidXRlKCJjbGFzcyIsIGRhdGFBdHRyKQoJCQkJCWVsc2Ugbm9kZS5zZXRBdHRyaWJ1dGUoYXR0ck5hbWUsIGRhdGFBdHRyKQoJCQkJfQoJCQkJZWxzZSBpZiAoYXR0ck5hbWUgPT09ICJ2YWx1ZSIgJiYgdGFnID09PSAiaW5wdXQiKSB7CgkJCQkJaWYgKG5vZGUudmFsdWUgIT09IGRhdGFBdHRyKSBub2RlLnZhbHVlID0gZGF0YUF0dHIKCQkJCX0KCQkJCWVsc2UgaWYgKGF0dHJOYW1lIGluIG5vZGUgJiYgIShhdHRyTmFtZSA9PSAibGlzdCIgfHwgYXR0ck5hbWUgPT0gInN0eWxlIikpIHsKCQkJCQlub2RlW2F0dHJOYW1lXSA9IGRhdGFBdHRyCgkJCQl9CgkJCQllbHNlIG5vZGUuc2V0QXR0cmlidXRlKGF0dHJOYW1lLCBkYXRhQXR0cikKCQkJfQoJCX0KCQlyZXR1cm4gY2FjaGVkQXR0cnMKCX0KCWZ1bmN0aW9uIGNsZWFyKG5vZGVzKSB7CgkJZm9yICh2YXIgaSA9IG5vZGVzLmxlbmd0aCAtIDE7IGkgPiAtMTsgaS0tKSBpZiAobm9kZXNbaV0gJiYgbm9kZXNbaV0ucGFyZW50Tm9kZSkgbm9kZXNbaV0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2Rlc1tpXSkKCQlub2Rlcy5sZW5ndGggPSAwCgl9CglmdW5jdGlvbiBpbmplY3RIVE1MKHBhcmVudEVsZW1lbnQsIGluZGV4LCBkYXRhKSB7CgkJdmFyIG5leHRTaWJsaW5nID0gcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XQoJCWlmIChuZXh0U2libGluZykgewoJCQl2YXIgaXNFbGVtZW50ID0gbmV4dFNpYmxpbmcubm9kZVR5cGUgIT0gMQoJCQl2YXIgcGxhY2Vob2xkZXIgPSB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpCgkJCWlmIChpc0VsZW1lbnQpIHsKCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKHBsYWNlaG9sZGVyLCBuZXh0U2libGluZykKCQkJCXBsYWNlaG9sZGVyLmluc2VydEFkamFjZW50SFRNTCgiYmVmb3JlYmVnaW4iLCBkYXRhKQoJCQkJcGFyZW50RWxlbWVudC5yZW1vdmVDaGlsZChwbGFjZWhvbGRlcikKCQkJfQoJCQllbHNlIG5leHRTaWJsaW5nLmluc2VydEFkamFjZW50SFRNTCgiYmVmb3JlYmVnaW4iLCBkYXRhKQoJCX0KCQllbHNlIHBhcmVudEVsZW1lbnQuaW5zZXJ0QWRqYWNlbnRIVE1MKCJiZWZvcmVlbmQiLCBkYXRhKQoJCXZhciBub2RlcyA9IFtdCgkJd2hpbGUgKHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gIT09IG5leHRTaWJsaW5nKSB7CgkJCW5vZGVzLnB1c2gocGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XSkKCQkJaW5kZXgrKwoJCX0KCQlyZXR1cm4gbm9kZXMKCX0KCWZ1bmN0aW9uIGNsb25lKG9iamVjdCkgewoJCXZhciByZXN1bHQgPSB7fQoJCWZvciAodmFyIHByb3AgaW4gb2JqZWN0KSByZXN1bHRbcHJvcF0gPSBvYmplY3RbcHJvcF0KCQlyZXR1cm4gcmVzdWx0Cgl9CglmdW5jdGlvbiBhdXRvcmVkcmF3KGNhbGxiYWNrLCBvYmplY3QpIHsKCQlyZXR1cm4gZnVuY3Rpb24oZSkgewoJCQllID0gZSB8fCBldmVudAoJCQltLnN0YXJ0Q29tcHV0YXRpb24oKQoJCQl0cnkge3JldHVybiBjYWxsYmFjay5jYWxsKG9iamVjdCwgZSl9CgkJCWZpbmFsbHkge20uZW5kQ29tcHV0YXRpb24oKX0KCQl9Cgl9CgoJdmFyIGh0bWwKCXZhciBkb2N1bWVudE5vZGUgPSB7CgkJaW5zZXJ0QWRqYWNlbnRIVE1MOiBmdW5jdGlvbihfLCBkYXRhKSB7CgkJCXdpbmRvdy5kb2N1bWVudC53cml0ZShkYXRhKQoJCQl3aW5kb3cuZG9jdW1lbnQuY2xvc2UoKQoJCX0sCgkJYXBwZW5kQ2hpbGQ6IGZ1bmN0aW9uKG5vZGUpIHsKCQkJaWYgKGh0bWwgPT09IHVuZGVmaW5lZCkgaHRtbCA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJodG1sIikKCQkJaWYgKG5vZGUubm9kZU5hbWUgPT0gIkhUTUwiKSBodG1sID0gbm9kZQoJCQllbHNlIGh0bWwuYXBwZW5kQ2hpbGQobm9kZSkKCQkJaWYgKHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgIT09IGh0bWwpIHsKCQkJCXdpbmRvdy5kb2N1bWVudC5yZXBsYWNlQ2hpbGQoaHRtbCwgd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkKCQkJfQoJCX0sCgkJaW5zZXJ0QmVmb3JlOiBmdW5jdGlvbihub2RlKSB7CgkJCXRoaXMuYXBwZW5kQ2hpbGQobm9kZSkKCQl9LAoJCWNoaWxkTm9kZXM6IFtdCgl9Cgl2YXIgbm9kZUNhY2hlID0gW10sIGNlbGxDYWNoZSA9IHt9CgltLnJlbmRlciA9IGZ1bmN0aW9uKHJvb3QsIGNlbGwpIHsKCQl2YXIgY29uZmlncyA9IFtdCgkJaWYgKCFyb290KSB0aHJvdyBuZXcgRXJyb3IoIlBsZWFzZSBlbnN1cmUgdGhlIERPTSBlbGVtZW50IGV4aXN0cyBiZWZvcmUgcmVuZGVyaW5nIGEgdGVtcGxhdGUgaW50byBpdC4iKQoJCXZhciBpbmRleCA9IG5vZGVDYWNoZS5pbmRleE9mKHJvb3QpCgkJdmFyIGlkID0gaW5kZXggPCAwID8gbm9kZUNhY2hlLnB1c2gocm9vdCkgLSAxIDogaW5kZXgKCQl2YXIgbm9kZSA9IHJvb3QgPT0gd2luZG93LmRvY3VtZW50IHx8IHJvb3QgPT0gd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCA/IGRvY3VtZW50Tm9kZSA6IHJvb3QKCQljZWxsQ2FjaGVbaWRdID0gYnVpbGQobm9kZSwgbnVsbCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNlbGwsIGNlbGxDYWNoZVtpZF0sIGZhbHNlLCAwLCBudWxsLCB1bmRlZmluZWQsIGNvbmZpZ3MpCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBjb25maWdzLmxlbmd0aDsgaSsrKSBjb25maWdzW2ldKCkKCX0KCgltLnRydXN0ID0gZnVuY3Rpb24odmFsdWUpIHsKCQl2YWx1ZSA9IG5ldyBTdHJpbmcodmFsdWUpCgkJdmFsdWUuJHRydXN0ZWQgPSB0cnVlCgkJcmV0dXJuIHZhbHVlCgl9CgoJdmFyIHJvb3RzID0gW10sIG1vZHVsZXMgPSBbXSwgY29udHJvbGxlcnMgPSBbXSwgbm93ID0gMCwgbGFzdFJlZHJhdyA9IDAsIGxhc3RSZWRyYXdJZCA9IDAsIGNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IG51bGwKCW0ubW9kdWxlID0gZnVuY3Rpb24ocm9vdCwgbW9kdWxlKSB7CgkJdmFyIGluZGV4ID0gcm9vdHMuaW5kZXhPZihyb290KQoJCWlmIChpbmRleCA8IDApIGluZGV4ID0gcm9vdHMubGVuZ3RoCgkJdmFyIGlzUHJldmVudGVkID0gZmFsc2UKCQlpZiAoY29udHJvbGxlcnNbaW5kZXhdICYmIHR5cGVvZiBjb250cm9sbGVyc1tpbmRleF0ub251bmxvYWQgPT0gImZ1bmN0aW9uIikgewoJCQl2YXIgZXZlbnQgPSB7CgkJCQlwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7aXNQcmV2ZW50ZWQgPSB0cnVlfQoJCQl9CgkJCWNvbnRyb2xsZXJzW2luZGV4XS5vbnVubG9hZChldmVudCkKCQl9CgkJaWYgKCFpc1ByZXZlbnRlZCkgewoJCQltLnN0YXJ0Q29tcHV0YXRpb24oKQoJCQlyb290c1tpbmRleF0gPSByb290CgkJCW1vZHVsZXNbaW5kZXhdID0gbW9kdWxlCgkJCWNvbnRyb2xsZXJzW2luZGV4XSA9IG5ldyBtb2R1bGUuY29udHJvbGxlcgoJCQltLmVuZENvbXB1dGF0aW9uKCkKCQl9Cgl9CgltLnJlZHJhdyA9IGZ1bmN0aW9uKCkgewoJCW5vdyA9IHdpbmRvdy5wZXJmb3JtYW5jZSAmJiB3aW5kb3cucGVyZm9ybWFuY2Uubm93ID8gd2luZG93LnBlcmZvcm1hbmNlLm5vdygpIDogbmV3IHdpbmRvdy5EYXRlKCkuZ2V0VGltZSgpCgkJaWYgKG5vdyAtIGxhc3RSZWRyYXcgPiAxNikgcmVkcmF3KCkKCQllbHNlIHsKCQkJdmFyIGNhbmNlbCA9IHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSB8fCB3aW5kb3cuY2xlYXJUaW1lb3V0CgkJCXZhciBkZWZlciA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgd2luZG93LnNldFRpbWVvdXQKCQkJY2FuY2VsKGxhc3RSZWRyYXdJZCkKCQkJbGFzdFJlZHJhd0lkID0gZGVmZXIocmVkcmF3LCAwKQoJCX0KCX0KCWZ1bmN0aW9uIHJlZHJhdygpIHsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHJvb3RzLmxlbmd0aDsgaSsrKSB7CgkJCWlmIChjb250cm9sbGVyc1tpXSkgbS5yZW5kZXIocm9vdHNbaV0sIG1vZHVsZXNbaV0udmlldyhjb250cm9sbGVyc1tpXSkpCgkJfQoJCWlmIChjb21wdXRlUG9zdFJlZHJhd0hvb2spIHsKCQkJY29tcHV0ZVBvc3RSZWRyYXdIb29rKCkKCQkJY29tcHV0ZVBvc3RSZWRyYXdIb29rID0gbnVsbAoJCX0KCQlsYXN0UmVkcmF3ID0gbm93Cgl9CgoJdmFyIHBlbmRpbmdSZXF1ZXN0cyA9IDAKCW0uc3RhcnRDb21wdXRhdGlvbiA9IGZ1bmN0aW9uKCkge3BlbmRpbmdSZXF1ZXN0cysrfQoJbS5lbmRDb21wdXRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXBlbmRpbmdSZXF1ZXN0cyA9IE1hdGgubWF4KHBlbmRpbmdSZXF1ZXN0cyAtIDEsIDApCgkJaWYgKHBlbmRpbmdSZXF1ZXN0cyA9PSAwKSBtLnJlZHJhdygpCgl9CgoJbS53aXRoQXR0ciA9IGZ1bmN0aW9uKHByb3AsIHdpdGhBdHRyQ2FsbGJhY2spIHsKCQlyZXR1cm4gZnVuY3Rpb24oZSkgewoJCQllID0gZSB8fCBldmVudAoJCQl3aXRoQXR0ckNhbGxiYWNrKHByb3AgaW4gZS5jdXJyZW50VGFyZ2V0ID8gZS5jdXJyZW50VGFyZ2V0W3Byb3BdIDogZS5jdXJyZW50VGFyZ2V0LmdldEF0dHJpYnV0ZShwcm9wKSkKCQl9Cgl9CgoJLy9yb3V0aW5nCgl2YXIgbW9kZXMgPSB7cGF0aG5hbWU6ICIiLCBoYXNoOiAiIyIsIHNlYXJjaDogIj8ifQoJdmFyIHJlZGlyZWN0ID0gZnVuY3Rpb24oKSB7fSwgcm91dGVQYXJhbXMgPSB7fSwgY3VycmVudFJvdXRlCgltLnJvdXRlID0gZnVuY3Rpb24oKSB7CgkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHJldHVybiBjdXJyZW50Um91dGUKCQllbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAzICYmIHR5cGVvZiBhcmd1bWVudHNbMV0gPT0gInN0cmluZyIpIHsKCQkJdmFyIHJvb3QgPSBhcmd1bWVudHNbMF0sIGRlZmF1bHRSb3V0ZSA9IGFyZ3VtZW50c1sxXSwgcm91dGVyID0gYXJndW1lbnRzWzJdCgkJCXJlZGlyZWN0ID0gZnVuY3Rpb24oc291cmNlKSB7CgkJCQl2YXIgcGF0aCA9IGN1cnJlbnRSb3V0ZSA9IG5vcm1hbGl6ZVJvdXRlKHNvdXJjZSkKCQkJCWlmICghcm91dGVCeVZhbHVlKHJvb3QsIHJvdXRlciwgcGF0aCkpIHsKCQkJCQltLnJvdXRlKGRlZmF1bHRSb3V0ZSwgdHJ1ZSkKCQkJCX0KCQkJfQoJCQl2YXIgbGlzdGVuZXIgPSBtLnJvdXRlLm1vZGUgPT0gImhhc2giID8gIm9uaGFzaGNoYW5nZSIgOiAib25wb3BzdGF0ZSIKCQkJd2luZG93W2xpc3RlbmVyXSA9IGZ1bmN0aW9uKCkgewoJCQkJaWYgKGN1cnJlbnRSb3V0ZSAhPSBub3JtYWxpemVSb3V0ZSh3aW5kb3cubG9jYXRpb25bbS5yb3V0ZS5tb2RlXSkpIHsKCQkJCQlyZWRpcmVjdCh3aW5kb3cubG9jYXRpb25bbS5yb3V0ZS5tb2RlXSkKCQkJCX0KCQkJfQoJCQljb21wdXRlUG9zdFJlZHJhd0hvb2sgPSBzZXRTY3JvbGwKCQkJd2luZG93W2xpc3RlbmVyXSgpCgkJCWN1cnJlbnRSb3V0ZSA9IG5vcm1hbGl6ZVJvdXRlKHdpbmRvdy5sb2NhdGlvblttLnJvdXRlLm1vZGVdKQoJCX0KCQllbHNlIGlmIChhcmd1bWVudHNbMF0uYWRkRXZlbnRMaXN0ZW5lcikgewoJCQl2YXIgZWxlbWVudCA9IGFyZ3VtZW50c1swXQoJCQl2YXIgaXNJbml0aWFsaXplZCA9IGFyZ3VtZW50c1sxXQoJCQlpZiAoZWxlbWVudC5ocmVmLmluZGV4T2YobW9kZXNbbS5yb3V0ZS5tb2RlXSkgPCAwKSB7CgkJCQllbGVtZW50LmhyZWYgPSB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgKyBtb2Rlc1ttLnJvdXRlLm1vZGVdICsgZWxlbWVudC5wYXRobmFtZQoJCQl9CgkJCWlmICghaXNJbml0aWFsaXplZCkgewoJCQkJZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJjbGljayIsIHJvdXRlVW5vYnRydXNpdmUpCgkJCQllbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgcm91dGVVbm9idHJ1c2l2ZSkKCQkJfQoJCX0KCQllbHNlIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09ICJzdHJpbmciKSB7CgkJCWN1cnJlbnRSb3V0ZSA9IGFyZ3VtZW50c1swXQoJCQl2YXIgcXVlcnlzdHJpbmcgPSB0eXBlb2YgYXJndW1lbnRzWzFdID09ICJvYmplY3QiID8gYnVpbGRRdWVyeVN0cmluZyhhcmd1bWVudHNbMV0pIDogbnVsbAoJCQlpZiAocXVlcnlzdHJpbmcpIGN1cnJlbnRSb3V0ZSArPSAoY3VycmVudFJvdXRlLmluZGV4T2YoIj8iKSA9PT0gLTEgPyAiPyIgOiAiJiIpICsgcXVlcnlzdHJpbmcKCgkJCXZhciBzaG91bGRSZXBsYWNlSGlzdG9yeUVudHJ5ID0gKGFyZ3VtZW50cy5sZW5ndGggPT0gMyA/IGFyZ3VtZW50c1syXSA6IGFyZ3VtZW50c1sxXSkgPT09IHRydWUKCgkJCWlmICh3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUpIHsKCQkJCWNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IGZ1bmN0aW9uKCkgewoJCQkJCXdpbmRvdy5oaXN0b3J5W3Nob3VsZFJlcGxhY2VIaXN0b3J5RW50cnkgPyAicmVwbGFjZVN0YXRlIiA6ICJwdXNoU3RhdGUiXShudWxsLCB3aW5kb3cuZG9jdW1lbnQudGl0bGUsIG1vZGVzW20ucm91dGUubW9kZV0gKyBjdXJyZW50Um91dGUpCgkJCQkJc2V0U2Nyb2xsKCkKCQkJCX0KCQkJCXJlZGlyZWN0KG1vZGVzW20ucm91dGUubW9kZV0gKyBjdXJyZW50Um91dGUpCgkJCX0KCQkJZWxzZSB3aW5kb3cubG9jYXRpb25bbS5yb3V0ZS5tb2RlXSA9IGN1cnJlbnRSb3V0ZQoJCX0KCX0KCW0ucm91dGUucGFyYW0gPSBmdW5jdGlvbihrZXkpIHtyZXR1cm4gcm91dGVQYXJhbXNba2V5XX0KCW0ucm91dGUubW9kZSA9ICJzZWFyY2giCglmdW5jdGlvbiBub3JtYWxpemVSb3V0ZShyb3V0ZSkge3JldHVybiByb3V0ZS5zbGljZShtb2Rlc1ttLnJvdXRlLm1vZGVdLmxlbmd0aCl9CglmdW5jdGlvbiByb3V0ZUJ5VmFsdWUocm9vdCwgcm91dGVyLCBwYXRoKSB7CgkJcm91dGVQYXJhbXMgPSB7fQoKCQl2YXIgcXVlcnlTdGFydCA9IHBhdGguaW5kZXhPZigiPyIpCgkJaWYgKHF1ZXJ5U3RhcnQgIT09IC0xKSB7CgkJCXJvdXRlUGFyYW1zID0gcGFyc2VRdWVyeVN0cmluZyhwYXRoLnN1YnN0cihxdWVyeVN0YXJ0ICsgMSwgcGF0aC5sZW5ndGgpKQoJCQlwYXRoID0gcGF0aC5zdWJzdHIoMCwgcXVlcnlTdGFydCkKCQl9CgoJCWZvciAodmFyIHJvdXRlIGluIHJvdXRlcikgewoJCQlpZiAocm91dGUgPT0gcGF0aCkgcmV0dXJuICF2b2lkIG0ubW9kdWxlKHJvb3QsIHJvdXRlcltyb3V0ZV0pCgoJCQl2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoIl4iICsgcm91dGUucmVwbGFjZSgvOlteXC9dKz9cLnszfS9nLCAiKC4qPykiKS5yZXBsYWNlKC86W15cL10rL2csICIoW15cXC9dKykiKSArICJcLz8kIikKCgkJCWlmIChtYXRjaGVyLnRlc3QocGF0aCkpIHsKCQkJCXJldHVybiAhdm9pZCBwYXRoLnJlcGxhY2UobWF0Y2hlciwgZnVuY3Rpb24oKSB7CgkJCQkJdmFyIGtleXMgPSByb3V0ZS5tYXRjaCgvOlteXC9dKy9nKSB8fCBbXQoJCQkJCXZhciB2YWx1ZXMgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSwgLTIpCgkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSByb3V0ZVBhcmFtc1trZXlzW2ldLnJlcGxhY2UoLzp8XC4vZywgIiIpXSA9IGRlY29kZVNwYWNlKHZhbHVlc1tpXSkKCQkJCQltLm1vZHVsZShyb290LCByb3V0ZXJbcm91dGVdKQoJCQkJfSkKCQkJfQoJCX0KCX0KCWZ1bmN0aW9uIHJvdXRlVW5vYnRydXNpdmUoZSkgewoJCWUgPSBlIHx8IGV2ZW50CgkJaWYgKGUuY3RybEtleSB8fCBlLm1ldGFLZXkgfHwgZS53aGljaCA9PSAyKSByZXR1cm4KCQllLnByZXZlbnREZWZhdWx0KCkKCQltLnJvdXRlKGUuY3VycmVudFRhcmdldFttLnJvdXRlLm1vZGVdLnNsaWNlKG1vZGVzW20ucm91dGUubW9kZV0ubGVuZ3RoKSkKCX0KCWZ1bmN0aW9uIHNldFNjcm9sbCgpIHsKCQlpZiAobS5yb3V0ZS5tb2RlICE9ICJoYXNoIiAmJiB3aW5kb3cubG9jYXRpb24uaGFzaCkgd2luZG93LmxvY2F0aW9uLmhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaAoJCWVsc2Ugd2luZG93LnNjcm9sbFRvKDAsIDApCgl9CglmdW5jdGlvbiBidWlsZFF1ZXJ5U3RyaW5nKG9iamVjdCwgcHJlZml4KSB7CgkJdmFyIHN0ciA9IFtdCgkJZm9yKHZhciBwcm9wIGluIG9iamVjdCkgewoJCQl2YXIga2V5ID0gcHJlZml4ID8gcHJlZml4ICsgIlsiICsgcHJvcCArICJdIiA6IHByb3AsIHZhbHVlID0gb2JqZWN0W3Byb3BdCgkJCXN0ci5wdXNoKHR5cGVvZiB2YWx1ZSA9PSAib2JqZWN0IiA/IGJ1aWxkUXVlcnlTdHJpbmcodmFsdWUsIGtleSkgOiBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkpCgkJfQoJCXJldHVybiBzdHIuam9pbigiJiIpCgl9CglmdW5jdGlvbiBwYXJzZVF1ZXJ5U3RyaW5nKHN0cikgewoJCXZhciBwYWlycyA9IHN0ci5zcGxpdCgiJiIpLCBwYXJhbXMgPSB7fQoJCWZvciAodmFyIGkgPSAwOyBpIDwgcGFpcnMubGVuZ3RoOyBpKyspIHsKCQkJdmFyIHBhaXIgPSBwYWlyc1tpXS5zcGxpdCgiPSIpCgkJCXBhcmFtc1tkZWNvZGVTcGFjZShwYWlyWzBdKV0gPSBwYWlyWzFdID8gZGVjb2RlU3BhY2UocGFpclsxXSkgOiAocGFpci5sZW5ndGggPT09IDEgPyB0cnVlIDogIiIpCgkJfQoJCXJldHVybiBwYXJhbXMKCX0KCWZ1bmN0aW9uIGRlY29kZVNwYWNlKHN0cmluZykgewoJCXJldHVybiBkZWNvZGVVUklDb21wb25lbnQoc3RyaW5nLnJlcGxhY2UoL1wrL2csICIgIikpCgl9CgoJLy9tb2RlbAoJbS5wcm9wID0gZnVuY3Rpb24oc3RvcmUpIHsKCQl2YXIgcHJvcCA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoYXJndW1lbnRzLmxlbmd0aCkgc3RvcmUgPSBhcmd1bWVudHNbMF0KCQkJcmV0dXJuIHN0b3JlCgkJfQoJCXByb3AudG9KU09OID0gZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzdG9yZQoJCX0KCQlyZXR1cm4gcHJvcAoJfQoKCXZhciBub25lID0ge30KCW0uZGVmZXJyZWQgPSBmdW5jdGlvbigpIHsKCQl2YXIgcmVzb2x2ZXJzID0gW10sIHJlamVjdGVycyA9IFtdLCByZXNvbHZlZCA9IG5vbmUsIHJlamVjdGVkID0gbm9uZSwgcHJvbWlzZSA9IG0ucHJvcCgpCgkJdmFyIG9iamVjdCA9IHsKCQkJcmVzb2x2ZTogZnVuY3Rpb24odmFsdWUpIHsKCQkJCWlmIChyZXNvbHZlZCA9PT0gbm9uZSkgcHJvbWlzZShyZXNvbHZlZCA9IHZhbHVlKQoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlcnMubGVuZ3RoOyBpKyspIHJlc29sdmVyc1tpXSh2YWx1ZSkKCQkJCXJlc29sdmVycy5sZW5ndGggPSByZWplY3RlcnMubGVuZ3RoID0gMAoJCQl9LAoJCQlyZWplY3Q6IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCQlpZiAocmVqZWN0ZWQgPT09IG5vbmUpIHJlamVjdGVkID0gdmFsdWUKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgcmVqZWN0ZXJzLmxlbmd0aDsgaSsrKSByZWplY3RlcnNbaV0odmFsdWUpCgkJCQlyZXNvbHZlcnMubGVuZ3RoID0gcmVqZWN0ZXJzLmxlbmd0aCA9IDAKCQkJfSwKCQkJcHJvbWlzZTogcHJvbWlzZQoJCX0KCQlvYmplY3QucHJvbWlzZS5yZXNvbHZlcnMgPSByZXNvbHZlcnMKCQlvYmplY3QucHJvbWlzZS50aGVuID0gZnVuY3Rpb24oc3VjY2VzcywgZXJyb3IpIHsKCQkJdmFyIG5leHQgPSBtLmRlZmVycmVkKCkKCQkJaWYgKCFzdWNjZXNzKSBzdWNjZXNzID0gaWRlbnRpdHkKCQkJaWYgKCFlcnJvcikgZXJyb3IgPSBpZGVudGl0eQoJCQlmdW5jdGlvbiBjYWxsYmFjayhtZXRob2QsIGNhbGxiYWNrKSB7CgkJCQlyZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKCQkJCQl0cnkgewoJCQkJCQl2YXIgcmVzdWx0ID0gY2FsbGJhY2sodmFsdWUpCgkJCQkJCWlmIChyZXN1bHQgJiYgdHlwZW9mIHJlc3VsdC50aGVuID09ICJmdW5jdGlvbiIpIHJlc3VsdC50aGVuKG5leHRbbWV0aG9kXSwgZXJyb3IpCgkJCQkJCWVsc2UgbmV4dFttZXRob2RdKHJlc3VsdCAhPT0gdW5kZWZpbmVkID8gcmVzdWx0IDogdmFsdWUpCgkJCQkJfQoJCQkJCWNhdGNoIChlKSB7CgkJCQkJCWlmIChlIGluc3RhbmNlb2YgRXJyb3IgJiYgZS5jb25zdHJ1Y3RvciAhPT0gRXJyb3IpIHRocm93IGUKCQkJCQkJZWxzZSBuZXh0LnJlamVjdChlKQoJCQkJCX0KCQkJCX0KCQkJfQoJCQlpZiAocmVzb2x2ZWQgIT09IG5vbmUpIGNhbGxiYWNrKCJyZXNvbHZlIiwgc3VjY2VzcykocmVzb2x2ZWQpCgkJCWVsc2UgaWYgKHJlamVjdGVkICE9PSBub25lKSBjYWxsYmFjaygicmVqZWN0IiwgZXJyb3IpKHJlamVjdGVkKQoJCQllbHNlIHsKCQkJCXJlc29sdmVycy5wdXNoKGNhbGxiYWNrKCJyZXNvbHZlIiwgc3VjY2VzcykpCgkJCQlyZWplY3RlcnMucHVzaChjYWxsYmFjaygicmVqZWN0IiwgZXJyb3IpKQoJCQl9CgkJCXJldHVybiBuZXh0LnByb21pc2UKCQl9CgkJcmV0dXJuIG9iamVjdAoJfQoJbS5zeW5jID0gZnVuY3Rpb24oYXJncykgewoJCXZhciBtZXRob2QgPSAicmVzb2x2ZSIKCQlmdW5jdGlvbiBzeW5jaHJvbml6ZXIocG9zLCByZXNvbHZlZCkgewoJCQlyZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKCQkJCXJlc3VsdHNbcG9zXSA9IHZhbHVlCgkJCQlpZiAoIXJlc29sdmVkKSBtZXRob2QgPSAicmVqZWN0IgoJCQkJaWYgKC0tb3V0c3RhbmRpbmcgPT0gMCkgewoJCQkJCWRlZmVycmVkLnByb21pc2UocmVzdWx0cykKCQkJCQlkZWZlcnJlZFttZXRob2RdKHJlc3VsdHMpCgkJCQl9CgkJCQlyZXR1cm4gdmFsdWUKCQkJfQoJCX0KCgkJdmFyIGRlZmVycmVkID0gbS5kZWZlcnJlZCgpCgkJdmFyIG91dHN0YW5kaW5nID0gYXJncy5sZW5ndGgKCQl2YXIgcmVzdWx0cyA9IG5ldyBBcnJheShvdXRzdGFuZGluZykKCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKCQkJYXJnc1tpXS50aGVuKHN5bmNocm9uaXplcihpLCB0cnVlKSwgc3luY2hyb25pemVyKGksIGZhbHNlKSkKCQl9CgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UKCX0KCWZ1bmN0aW9uIGlkZW50aXR5KHZhbHVlKSB7cmV0dXJuIHZhbHVlfQoKCWZ1bmN0aW9uIGFqYXgob3B0aW9ucykgewoJCXZhciB4aHIgPSBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0CgkJeGhyLm9wZW4ob3B0aW9ucy5tZXRob2QsIG9wdGlvbnMudXJsLCB0cnVlLCBvcHRpb25zLnVzZXIsIG9wdGlvbnMucGFzc3dvcmQpCgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoeGhyLnJlYWR5U3RhdGUgPT09IDQpIHsKCQkJCWlmICh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSBvcHRpb25zLm9ubG9hZCh7dHlwZTogImxvYWQiLCB0YXJnZXQ6IHhocn0pCgkJCQllbHNlIG9wdGlvbnMub25lcnJvcih7dHlwZTogImVycm9yIiwgdGFyZ2V0OiB4aHJ9KQoJCQl9CgkJfQoJCWlmICh0eXBlb2Ygb3B0aW9ucy5jb25maWcgPT0gImZ1bmN0aW9uIikgewoJCQl2YXIgbWF5YmVYaHIgPSBvcHRpb25zLmNvbmZpZyh4aHIsIG9wdGlvbnMpCgkJCWlmIChtYXliZVhociAhPT0gdW5kZWZpbmVkKSB4aHIgPSBtYXliZVhocgoJCX0KCQl4aHIuc2VuZChvcHRpb25zLmRhdGEpCgkJcmV0dXJuIHhocgoJfQoJZnVuY3Rpb24gYmluZERhdGEoeGhyT3B0aW9ucywgZGF0YSwgc2VyaWFsaXplKSB7CgkJaWYgKGRhdGEgJiYgT2JqZWN0LmtleXMoZGF0YSkubGVuZ3RoID4gMCkgewoJCQlpZiAoeGhyT3B0aW9ucy5tZXRob2QgPT0gIkdFVCIpIHsKCQkJCXhock9wdGlvbnMudXJsID0geGhyT3B0aW9ucy51cmwgKyAoeGhyT3B0aW9ucy51cmwuaW5kZXhPZigiPyIpIDwgMCA/ICI/IiA6ICImIikgKyBidWlsZFF1ZXJ5U3RyaW5nKGRhdGEpCgkJCX0KCQkJZWxzZSB4aHJPcHRpb25zLmRhdGEgPSBzZXJpYWxpemUoZGF0YSkKCQl9CgkJcmV0dXJuIHhock9wdGlvbnMKCX0KCWZ1bmN0aW9uIHBhcmFtZXRlcml6ZVVybCh1cmwsIGRhdGEpIHsKCQl2YXIgdG9rZW5zID0gdXJsLm1hdGNoKC86W2Etel1cdysvZ2kpCgkJaWYgKHRva2VucyAmJiBkYXRhKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7CgkJCQl2YXIga2V5ID0gdG9rZW5zW2ldLnNsaWNlKDEpCgkJCQl1cmwgPSB1cmwucmVwbGFjZSh0b2tlbnNbaV0sIGRhdGFba2V5XSkKCQkJCWRlbGV0ZSBkYXRhW2tleV0KCQkJfQoJCX0KCQlyZXR1cm4gdXJsCgl9CgoJbS5yZXF1ZXN0ID0gZnVuY3Rpb24oeGhyT3B0aW9ucykgewoJCWlmICh4aHJPcHRpb25zLmJhY2tncm91bmQgIT09IHRydWUpIG0uc3RhcnRDb21wdXRhdGlvbigpCgkJdmFyIGRlZmVycmVkID0gbS5kZWZlcnJlZCgpCgkJdmFyIHNlcmlhbGl6ZSA9IHhock9wdGlvbnMuc2VyaWFsaXplIHx8IEpTT04uc3RyaW5naWZ5CgkJdmFyIGRlc2VyaWFsaXplID0geGhyT3B0aW9ucy5kZXNlcmlhbGl6ZSB8fCBKU09OLnBhcnNlCgkJdmFyIGV4dHJhY3QgPSB4aHJPcHRpb25zLmV4dHJhY3QgfHwgZnVuY3Rpb24oeGhyKSB7CgkJCXJldHVybiB4aHIucmVzcG9uc2VUZXh0Lmxlbmd0aCA9PT0gMCAmJiBkZXNlcmlhbGl6ZSA9PT0gSlNPTi5wYXJzZSA/IG51bGwgOiB4aHIucmVzcG9uc2VUZXh0CgkJfQoJCXhock9wdGlvbnMudXJsID0gcGFyYW1ldGVyaXplVXJsKHhock9wdGlvbnMudXJsLCB4aHJPcHRpb25zLmRhdGEpCgkJeGhyT3B0aW9ucyA9IGJpbmREYXRhKHhock9wdGlvbnMsIHhock9wdGlvbnMuZGF0YSwgc2VyaWFsaXplKQoJCXhock9wdGlvbnMub25sb2FkID0geGhyT3B0aW9ucy5vbmVycm9yID0gZnVuY3Rpb24oZSkgewoJCQl0cnkgewoJCQkJZSA9IGUgfHwgZXZlbnQKCQkJCXZhciB1bndyYXAgPSAoZS50eXBlID09ICJsb2FkIiA/IHhock9wdGlvbnMudW53cmFwU3VjY2VzcyA6IHhock9wdGlvbnMudW53cmFwRXJyb3IpIHx8IGlkZW50aXR5CgkJCQl2YXIgcmVzcG9uc2UgPSB1bndyYXAoZGVzZXJpYWxpemUoZXh0cmFjdChlLnRhcmdldCwgeGhyT3B0aW9ucykpKQoJCQkJaWYgKGUudHlwZSA9PSAibG9hZCIpIHsKCQkJCQlpZiAocmVzcG9uc2UgaW5zdGFuY2VvZiBBcnJheSAmJiB4aHJPcHRpb25zLnR5cGUpIHsKCQkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCByZXNwb25zZS5sZW5ndGg7IGkrKykgcmVzcG9uc2VbaV0gPSBuZXcgeGhyT3B0aW9ucy50eXBlKHJlc3BvbnNlW2ldKQoJCQkJCX0KCQkJCQllbHNlIGlmICh4aHJPcHRpb25zLnR5cGUpIHJlc3BvbnNlID0gbmV3IHhock9wdGlvbnMudHlwZShyZXNwb25zZSkKCQkJCX0KCQkJCWRlZmVycmVkW2UudHlwZSA9PSAibG9hZCIgPyAicmVzb2x2ZSIgOiAicmVqZWN0Il0ocmVzcG9uc2UpCgkJCX0KCQkJY2F0Y2ggKGUpIHsKCQkJCWlmIChlIGluc3RhbmNlb2YgU3ludGF4RXJyb3IpIHRocm93IG5ldyBTeW50YXhFcnJvcigiQ291bGQgbm90IHBhcnNlIEhUVFAgcmVzcG9uc2UuIFNlZSBodHRwOi8vbGhvcmllLmdpdGh1Yi5pby9taXRocmlsL21pdGhyaWwucmVxdWVzdC5odG1sI3VzaW5nLXZhcmlhYmxlLWRhdGEtZm9ybWF0cyIpCgkJCQllbHNlIGlmIChlIGluc3RhbmNlb2YgRXJyb3IgJiYgZS5jb25zdHJ1Y3RvciAhPT0gRXJyb3IpIHRocm93IGUKCQkJCWVsc2UgZGVmZXJyZWQucmVqZWN0KGUpCgkJCX0KCQkJaWYgKHhock9wdGlvbnMuYmFja2dyb3VuZCAhPT0gdHJ1ZSkgbS5lbmRDb21wdXRhdGlvbigpCgkJfQoJCWFqYXgoeGhyT3B0aW9ucykKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZQoJfQoKCS8vdGVzdGluZyBBUEkKCW0uZGVwcyA9IGZ1bmN0aW9uKG1vY2spIHtyZXR1cm4gd2luZG93ID0gbW9ja30KCS8vZm9yIGludGVybmFsIHRlc3Rpbmcgb25seSwgZG8gbm90IHVzZSBgbS5kZXBzLmZhY3RvcnlgCgltLmRlcHMuZmFjdG9yeSA9IGFwcAoKCXJldHVybiBtCn0odHlwZW9mIHdpbmRvdyAhPSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHt9KQoKaWYgKHR5cGVvZiBtb2R1bGUgIT0gInVuZGVmaW5lZCIgJiYgbW9kdWxlICE9PSBudWxsKSBtb2R1bGUuZXhwb3J0cyA9IG0KaWYgKHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSBkZWZpbmUoZnVuY3Rpb24oKSB7cmV0dXJuIG19KQoKOzs7Cg==",
                "body": "TWl0aHJpbCA9IG0gPSBuZXcgZnVuY3Rpb24gYXBwKHdpbmRvdykgewoJdmFyIHNlbGVjdG9yQ2FjaGUgPSB7fQoJdmFyIHR5cGUgPSB7fS50b1N0cmluZwoJdmFyIHBhcnNlciA9IC8oPzooXnwjfFwuKShbXiNcLlxbXF1dKykpfChcWy4rP1xdKS9nLCBhdHRyUGFyc2VyID0gL1xbKC4rPykoPzo9KCJ8J3wpKC4rPylcMik/XF0vCgoJZnVuY3Rpb24gbSgpIHsKCQl2YXIgYXJncyA9IGFyZ3VtZW50cwoJCXZhciBoYXNBdHRycyA9IHR5cGUuY2FsbChhcmdzWzFdKSA9PSAiW29iamVjdCBPYmplY3RdIiAmJiAhKCJ0YWciIGluIGFyZ3NbMV0pICYmICEoInN1YnRyZWUiIGluIGFyZ3NbMV0pCgkJdmFyIGF0dHJzID0gaGFzQXR0cnMgPyBhcmdzWzFdIDoge30KCQl2YXIgY2xhc3NBdHRyTmFtZSA9ICJjbGFzcyIgaW4gYXR0cnMgPyAiY2xhc3MiIDogImNsYXNzTmFtZSIKCQl2YXIgY2VsbCA9IHNlbGVjdG9yQ2FjaGVbYXJnc1swXV0KCQlpZiAoY2VsbCA9PT0gdW5kZWZpbmVkKSB7CgkJCXNlbGVjdG9yQ2FjaGVbYXJnc1swXV0gPSBjZWxsID0ge3RhZzogImRpdiIsIGF0dHJzOiB7fX0KCQkJdmFyIG1hdGNoLCBjbGFzc2VzID0gW10KCQkJd2hpbGUgKG1hdGNoID0gcGFyc2VyLmV4ZWMoYXJnc1swXSkpIHsKCQkJCWlmIChtYXRjaFsxXSA9PSAiIikgY2VsbC50YWcgPSBtYXRjaFsyXQoJCQkJZWxzZSBpZiAobWF0Y2hbMV0gPT0gIiMiKSBjZWxsLmF0dHJzLmlkID0gbWF0Y2hbMl0KCQkJCWVsc2UgaWYgKG1hdGNoWzFdID09ICIuIikgY2xhc3Nlcy5wdXNoKG1hdGNoWzJdKQoJCQkJZWxzZSBpZiAobWF0Y2hbM11bMF0gPT0gIlsiKSB7CgkJCQkJdmFyIHBhaXIgPSBhdHRyUGFyc2VyLmV4ZWMobWF0Y2hbM10pCgkJCQkJY2VsbC5hdHRyc1twYWlyWzFdXSA9IHBhaXJbM10gfHwgdHJ1ZQoJCQkJfQoJCQl9CgkJCWlmIChjbGFzc2VzLmxlbmd0aCA+IDApIGNlbGwuYXR0cnNbY2xhc3NBdHRyTmFtZV0gPSBjbGFzc2VzLmpvaW4oIiAiKQoJCX0KCQljZWxsID0gY2xvbmUoY2VsbCkKCQljZWxsLmF0dHJzID0gY2xvbmUoY2VsbC5hdHRycykKCQljZWxsLmNoaWxkcmVuID0gaGFzQXR0cnMgPyBhcmdzWzJdIDogYXJnc1sxXQoJCWZvciAodmFyIGF0dHJOYW1lIGluIGF0dHJzKSB7CgkJCWlmIChhdHRyTmFtZSA9PSBjbGFzc0F0dHJOYW1lKSBjZWxsLmF0dHJzW2F0dHJOYW1lXSA9IChjZWxsLmF0dHJzW2F0dHJOYW1lXSB8fCAiIikgKyAiICIgKyBhdHRyc1thdHRyTmFtZV0KCQkJZWxzZSBjZWxsLmF0dHJzW2F0dHJOYW1lXSA9IGF0dHJzW2F0dHJOYW1lXQoJCX0KCQlyZXR1cm4gY2VsbAoJfQoJZnVuY3Rpb24gYnVpbGQocGFyZW50RWxlbWVudCwgcGFyZW50VGFnLCBwYXJlbnRDYWNoZSwgcGFyZW50SW5kZXgsIGRhdGEsIGNhY2hlZCwgc2hvdWxkUmVhdHRhY2gsIGluZGV4LCBlZGl0YWJsZSwgbmFtZXNwYWNlLCBjb25maWdzKSB7CgkJaWYgKGRhdGEgPT09IG51bGwgfHwgZGF0YSA9PT0gdW5kZWZpbmVkKSBkYXRhID0gIiIKCQlpZiAoZGF0YS5zdWJ0cmVlID09PSAicmV0YWluIikgcmV0dXJuCgoJCXZhciBjYWNoZWRUeXBlID0gdHlwZS5jYWxsKGNhY2hlZCksIGRhdGFUeXBlID0gdHlwZS5jYWxsKGRhdGEpCgkJaWYgKGNhY2hlZFR5cGUgIT0gZGF0YVR5cGUpIHsKCQkJaWYgKGNhY2hlZCAhPT0gbnVsbCAmJiBjYWNoZWQgIT09IHVuZGVmaW5lZCkgewoJCQkJaWYgKHBhcmVudENhY2hlICYmIHBhcmVudENhY2hlLm5vZGVzKSB7CgkJCQkJdmFyIG9mZnNldCA9IGluZGV4IC0gcGFyZW50SW5kZXgKCQkJCQljbGVhcihwYXJlbnRDYWNoZS5ub2Rlcy5zbGljZShvZmZzZXQsIG9mZnNldCArIChkYXRhVHlwZSA9PSAiW29iamVjdCBBcnJheV0iID8gZGF0YSA6IGNhY2hlZC5ub2RlcykubGVuZ3RoKSkKCQkJCX0KCQkJCWVsc2UgY2xlYXIoY2FjaGVkLm5vZGVzKQoJCQl9CgkJCWNhY2hlZCA9IG5ldyBkYXRhLmNvbnN0cnVjdG9yCgkJCWNhY2hlZC5ub2RlcyA9IFtdCgkJfQoKCQlpZiAoZGF0YVR5cGUgPT0gIltvYmplY3QgQXJyYXldIikgewoJCQl2YXIgbm9kZXMgPSBbXSwgaW50YWN0ID0gY2FjaGVkLmxlbmd0aCA9PT0gZGF0YS5sZW5ndGgsIHN1YkFycmF5Q291bnQgPSAwCgkJCQoJCQl2YXIgREVMRVRJT04gPSAxLCBJTlNFUlRJT04gPSAyICwgTU9WRSA9IDMKCQkJdmFyIGV4aXN0aW5nID0ge30sIHNob3VsZE1haW50YWluSWRlbnRpdGllcyA9IGZhbHNlCgkJCWZvciAodmFyIGkgPSAwOyBpIDwgY2FjaGVkLmxlbmd0aDsgaSsrKSB7CgkJCQlpZiAoY2FjaGVkW2ldICYmIGNhY2hlZFtpXS5hdHRycyAmJiBjYWNoZWRbaV0uYXR0cnMua2V5ICE9PSB1bmRlZmluZWQpIHsKCQkJCQlzaG91bGRNYWludGFpbklkZW50aXRpZXMgPSB0cnVlCgkJCQkJZXhpc3RpbmdbY2FjaGVkW2ldLmF0dHJzLmtleV0gPSB7YWN0aW9uOiBERUxFVElPTiwgaW5kZXg6IGl9CgkJCQl9CgkJCX0KCQkJaWYgKHNob3VsZE1haW50YWluSWRlbnRpdGllcykgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCQkJaWYgKGRhdGFbaV0gJiYgZGF0YVtpXS5hdHRycyAmJiBkYXRhW2ldLmF0dHJzLmtleSAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJCXZhciBrZXkgPSBkYXRhW2ldLmF0dHJzLmtleQoJCQkJCQlpZiAoIWV4aXN0aW5nW2tleV0pIGV4aXN0aW5nW2tleV0gPSB7YWN0aW9uOiBJTlNFUlRJT04sIGluZGV4OiBpfQoJCQkJCQllbHNlIGV4aXN0aW5nW2tleV0gPSB7YWN0aW9uOiBNT1ZFLCBpbmRleDogaSwgZnJvbTogZXhpc3Rpbmdba2V5XS5pbmRleCwgZWxlbWVudDogcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2V4aXN0aW5nW2tleV0uaW5kZXhdfQoJCQkJCX0KCQkJCX0KCQkJCXZhciBhY3Rpb25zID0gT2JqZWN0LmtleXMoZXhpc3RpbmcpLm1hcChmdW5jdGlvbihrZXkpIHtyZXR1cm4gZXhpc3Rpbmdba2V5XX0pCgkJCQl2YXIgY2hhbmdlcyA9IGFjdGlvbnMuc29ydChmdW5jdGlvbihhLCBiKSB7cmV0dXJuIGEuYWN0aW9uIC0gYi5hY3Rpb24gfHwgYi5pbmRleCAtIGEuaW5kZXh9KQoJCQkJdmFyIG5ld0NhY2hlZCA9IG5ldyBBcnJheShjYWNoZWQubGVuZ3RoKQoJCQkJCgkJCQlmb3IgKHZhciBpID0gMCwgY2hhbmdlOyBjaGFuZ2UgPSBjaGFuZ2VzW2ldOyBpKyspIHsKCQkJCQlpZiAoY2hhbmdlLmFjdGlvbiA9PSBERUxFVElPTikgewoJCQkJCQljbGVhcihjYWNoZWRbY2hhbmdlLmluZGV4XS5ub2RlcykKCQkJCQkJbmV3Q2FjaGVkLnNwbGljZShjaGFuZ2UuaW5kZXgsIDEpCgkJCQkJfQoJCQkJCWlmIChjaGFuZ2UuYWN0aW9uID09IElOU0VSVElPTikgewoJCQkJCQl2YXIgZHVtbXkgPSB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQkJCQkJZHVtbXkua2V5ID0gZGF0YVtjaGFuZ2UuaW5kZXhdLmF0dHJzLmtleS50b1N0cmluZygpCgkJCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKGR1bW15LCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbY2hhbmdlLmluZGV4XSkKCQkJCQkJbmV3Q2FjaGVkLnNwbGljZShjaGFuZ2UuaW5kZXgsIDAsIHthdHRyczoge2tleTogZGF0YVtjaGFuZ2UuaW5kZXhdLmF0dHJzLmtleX0sIG5vZGVzOiBbZHVtbXldfSkKCQkJCQl9CgkJCQkJCgkJCQkJaWYgKGNoYW5nZS5hY3Rpb24gPT0gTU9WRSkgewoJCQkJCQlpZiAocGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2NoYW5nZS5pbmRleF0gIT09IGNoYW5nZS5lbGVtZW50KSB7CgkJCQkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShjaGFuZ2UuZWxlbWVudCwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2NoYW5nZS5pbmRleF0pCgkJCQkJCX0KCQkJCQkJbmV3Q2FjaGVkW2NoYW5nZS5pbmRleF0gPSBjYWNoZWRbY2hhbmdlLmZyb21dCgkJCQkJfQoJCQkJfQoJCQkJY2FjaGVkID0gbmV3Q2FjaGVkCgkJCQljYWNoZWQubm9kZXMgPSBbXQoJCQkJZm9yICh2YXIgaSA9IDAsIGNoaWxkOyBjaGlsZCA9IHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpXTsgaSsrKSBjYWNoZWQubm9kZXMucHVzaChjaGlsZCkKCQkJfQoJCQkKCQkJZm9yICh2YXIgaSA9IDAsIGNhY2hlQ291bnQgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQkJdmFyIGl0ZW0gPSBidWlsZChwYXJlbnRFbGVtZW50LCBwYXJlbnRUYWcsIGNhY2hlZCwgaW5kZXgsIGRhdGFbaV0sIGNhY2hlZFtjYWNoZUNvdW50XSwgc2hvdWxkUmVhdHRhY2gsIGluZGV4ICsgc3ViQXJyYXlDb3VudCB8fCBzdWJBcnJheUNvdW50LCBlZGl0YWJsZSwgbmFtZXNwYWNlLCBjb25maWdzKQoJCQkJaWYgKGl0ZW0gPT09IHVuZGVmaW5lZCkgY29udGludWUKCQkJCWlmICghaXRlbS5ub2Rlcy5pbnRhY3QpIGludGFjdCA9IGZhbHNlCgkJCQlzdWJBcnJheUNvdW50ICs9IGl0ZW0gaW5zdGFuY2VvZiBBcnJheSA/IGl0ZW0ubGVuZ3RoIDogMQoJCQkJY2FjaGVkW2NhY2hlQ291bnQrK10gPSBpdGVtCgkJCX0KCQkJaWYgKCFpbnRhY3QpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQkJCWlmIChjYWNoZWRbaV0gIT09IHVuZGVmaW5lZCkgbm9kZXMgPSBub2Rlcy5jb25jYXQoY2FjaGVkW2ldLm5vZGVzKQoJCQkJfQoJCQkJZm9yICh2YXIgaSA9IG5vZGVzLmxlbmd0aCwgbm9kZTsgbm9kZSA9IGNhY2hlZC5ub2Rlc1tpXTsgaSsrKSB7CgkJCQkJaWYgKG5vZGUucGFyZW50Tm9kZSAhPT0gbnVsbCAmJiBub2RlLnBhcmVudE5vZGUuY2hpbGROb2Rlcy5sZW5ndGggIT0gbm9kZXMubGVuZ3RoKSBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSkKCQkJCX0KCQkJCWZvciAodmFyIGkgPSBjYWNoZWQubm9kZXMubGVuZ3RoLCBub2RlOyBub2RlID0gbm9kZXNbaV07IGkrKykgewoJCQkJCWlmIChub2RlLnBhcmVudE5vZGUgPT09IG51bGwpIHBhcmVudEVsZW1lbnQuYXBwZW5kQ2hpbGQobm9kZSkKCQkJCX0KCQkJCWlmIChkYXRhLmxlbmd0aCA8IGNhY2hlZC5sZW5ndGgpIGNhY2hlZC5sZW5ndGggPSBkYXRhLmxlbmd0aAoJCQkJY2FjaGVkLm5vZGVzID0gbm9kZXMKCQkJfQoJCQkKCQl9CgkJZWxzZSBpZiAoZGF0YVR5cGUgPT0gIltvYmplY3QgT2JqZWN0XSIpIHsKCQkJaWYgKGRhdGEudGFnICE9IGNhY2hlZC50YWcgfHwgT2JqZWN0LmtleXMoZGF0YS5hdHRycykuam9pbigpICE9IE9iamVjdC5rZXlzKGNhY2hlZC5hdHRycykuam9pbigpIHx8IGRhdGEuYXR0cnMuaWQgIT0gY2FjaGVkLmF0dHJzLmlkKSBjbGVhcihjYWNoZWQubm9kZXMpCgkJCWlmICh0eXBlb2YgZGF0YS50YWcgIT0gInN0cmluZyIpIHJldHVybgoKCQkJdmFyIG5vZGUsIGlzTmV3ID0gY2FjaGVkLm5vZGVzLmxlbmd0aCA9PT0gMAoJCQlpZiAoZGF0YS5hdHRycy54bWxucykgbmFtZXNwYWNlID0gZGF0YS5hdHRycy54bWxucwoJCQllbHNlIGlmIChkYXRhLnRhZyA9PT0gInN2ZyIpIG5hbWVzcGFjZSA9ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKCQkJaWYgKGlzTmV3KSB7CgkJCQlub2RlID0gbmFtZXNwYWNlID09PSB1bmRlZmluZWQgPyB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudChkYXRhLnRhZykgOiB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZSwgZGF0YS50YWcpCgkJCQljYWNoZWQgPSB7CgkJCQkJdGFnOiBkYXRhLnRhZywKCQkJCQlhdHRyczogc2V0QXR0cmlidXRlcyhub2RlLCBkYXRhLnRhZywgZGF0YS5hdHRycywge30sIG5hbWVzcGFjZSksCgkJCQkJY2hpbGRyZW46IGRhdGEuY2hpbGRyZW4gIT09IHVuZGVmaW5lZCA/IGJ1aWxkKG5vZGUsIGRhdGEudGFnLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgZGF0YS5jaGlsZHJlbiwgY2FjaGVkLmNoaWxkcmVuLCB0cnVlLCAwLCBkYXRhLmF0dHJzLmNvbnRlbnRlZGl0YWJsZSA/IG5vZGUgOiBlZGl0YWJsZSwgbmFtZXNwYWNlLCBjb25maWdzKSA6IHVuZGVmaW5lZCwKCQkJCQlub2RlczogW25vZGVdCgkJCQl9CgkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShub2RlLCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdIHx8IG51bGwpCgkJCX0KCQkJZWxzZSB7CgkJCQlub2RlID0gY2FjaGVkLm5vZGVzWzBdCgkJCQlzZXRBdHRyaWJ1dGVzKG5vZGUsIGRhdGEudGFnLCBkYXRhLmF0dHJzLCBjYWNoZWQuYXR0cnMsIG5hbWVzcGFjZSkKCQkJCWNhY2hlZC5jaGlsZHJlbiA9IGJ1aWxkKG5vZGUsIGRhdGEudGFnLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgZGF0YS5jaGlsZHJlbiwgY2FjaGVkLmNoaWxkcmVuLCBmYWxzZSwgMCwgZGF0YS5hdHRycy5jb250ZW50ZWRpdGFibGUgPyBub2RlIDogZWRpdGFibGUsIG5hbWVzcGFjZSwgY29uZmlncykKCQkJCWNhY2hlZC5ub2Rlcy5pbnRhY3QgPSB0cnVlCgkJCQlpZiAoc2hvdWxkUmVhdHRhY2ggPT09IHRydWUpIHBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJfQoJCQlpZiAodHlwZS5jYWxsKGRhdGEuYXR0cnNbImNvbmZpZyJdKSA9PSAiW29iamVjdCBGdW5jdGlvbl0iKSB7CgkJCQljb25maWdzLnB1c2goZGF0YS5hdHRyc1siY29uZmlnIl0uYmluZCh3aW5kb3csIG5vZGUsICFpc05ldywgY2FjaGVkLmNvbmZpZ0NvbnRleHQgPSBjYWNoZWQuY29uZmlnQ29udGV4dCB8fCB7fSkpCgkJCX0KCQl9CgkJZWxzZSB7CgkJCXZhciBub2RlcwoJCQlpZiAoY2FjaGVkLm5vZGVzLmxlbmd0aCA9PT0gMCkgewoJCQkJaWYgKGRhdGEuJHRydXN0ZWQpIHsKCQkJCQlub2RlcyA9IGluamVjdEhUTUwocGFyZW50RWxlbWVudCwgaW5kZXgsIGRhdGEpCgkJCQl9CgkJCQllbHNlIHsKCQkJCQlub2RlcyA9IFt3aW5kb3cuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoZGF0YSldCgkJCQkJcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUobm9kZXNbMF0sIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJCX0KCQkJCWNhY2hlZCA9ICJzdHJpbmcgbnVtYmVyIGJvb2xlYW4iLmluZGV4T2YodHlwZW9mIGRhdGEpID4gLTEgPyBuZXcgZGF0YS5jb25zdHJ1Y3RvcihkYXRhKSA6IGRhdGEKCQkJCWNhY2hlZC5ub2RlcyA9IG5vZGVzCgkJCX0KCQkJZWxzZSBpZiAoY2FjaGVkLnZhbHVlT2YoKSAhPT0gZGF0YS52YWx1ZU9mKCkgfHwgc2hvdWxkUmVhdHRhY2ggPT09IHRydWUpIHsKCQkJCW5vZGVzID0gY2FjaGVkLm5vZGVzCgkJCQlpZiAoIWVkaXRhYmxlIHx8IGVkaXRhYmxlICE9PSB3aW5kb3cuZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkgewoJCQkJCWlmIChkYXRhLiR0cnVzdGVkKSB7CgkJCQkJCWNsZWFyKG5vZGVzKQoJCQkJCQlub2RlcyA9IGluamVjdEhUTUwocGFyZW50RWxlbWVudCwgaW5kZXgsIGRhdGEpCgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQlpZiAocGFyZW50VGFnID09PSAidGV4dGFyZWEiKSBwYXJlbnRFbGVtZW50LnZhbHVlID0gZGF0YQoJCQkJCQllbHNlIGlmIChlZGl0YWJsZSkgZWRpdGFibGUuaW5uZXJIVE1MID0gZGF0YQoJCQkJCQllbHNlIHsKCQkJCQkJCWlmIChub2Rlc1swXS5ub2RlVHlwZSA9PSAxIHx8IG5vZGVzLmxlbmd0aCA+IDEpIHsgLy93YXMgYSB0cnVzdGVkIHN0cmluZwoJCQkJCQkJCWNsZWFyKGNhY2hlZC5ub2RlcykKCQkJCQkJCQlub2RlcyA9IFt3aW5kb3cuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoZGF0YSldCgkJCQkJCQl9CgkJCQkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShub2Rlc1swXSwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XSB8fCBudWxsKQoJCQkJCQkJbm9kZXNbMF0ubm9kZVZhbHVlID0gZGF0YQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQkJY2FjaGVkID0gbmV3IGRhdGEuY29uc3RydWN0b3IoZGF0YSkKCQkJCWNhY2hlZC5ub2RlcyA9IG5vZGVzCgkJCX0KCQkJZWxzZSBjYWNoZWQubm9kZXMuaW50YWN0ID0gdHJ1ZQoJCX0KCgkJcmV0dXJuIGNhY2hlZAoJfQoJZnVuY3Rpb24gc2V0QXR0cmlidXRlcyhub2RlLCB0YWcsIGRhdGFBdHRycywgY2FjaGVkQXR0cnMsIG5hbWVzcGFjZSkgewoJCWZvciAodmFyIGF0dHJOYW1lIGluIGRhdGFBdHRycykgewoJCQl2YXIgZGF0YUF0dHIgPSBkYXRhQXR0cnNbYXR0ck5hbWVdCgkJCXZhciBjYWNoZWRBdHRyID0gY2FjaGVkQXR0cnNbYXR0ck5hbWVdCgkJCWlmICghKGF0dHJOYW1lIGluIGNhY2hlZEF0dHJzKSB8fCAoY2FjaGVkQXR0ciAhPT0gZGF0YUF0dHIpIHx8IG5vZGUgPT09IHdpbmRvdy5kb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7CgkJCQljYWNoZWRBdHRyc1thdHRyTmFtZV0gPSBkYXRhQXR0cgoJCQkJaWYgKGF0dHJOYW1lID09PSAiY29uZmlnIikgY29udGludWUKCQkJCWVsc2UgaWYgKHR5cGVvZiBkYXRhQXR0ciA9PSAiZnVuY3Rpb24iICYmIGF0dHJOYW1lLmluZGV4T2YoIm9uIikgPT0gMCkgewoJCQkJCW5vZGVbYXR0ck5hbWVdID0gYXV0b3JlZHJhdyhkYXRhQXR0ciwgbm9kZSkKCQkJCX0KCQkJCWVsc2UgaWYgKGF0dHJOYW1lID09PSAic3R5bGUiICYmIHR5cGVvZiBkYXRhQXR0ciA9PSAib2JqZWN0IikgewoJCQkJCWZvciAodmFyIHJ1bGUgaW4gZGF0YUF0dHIpIHsKCQkJCQkJaWYgKGNhY2hlZEF0dHIgPT09IHVuZGVmaW5lZCB8fCBjYWNoZWRBdHRyW3J1bGVdICE9PSBkYXRhQXR0cltydWxlXSkgbm9kZS5zdHlsZVtydWxlXSA9IGRhdGFBdHRyW3J1bGVdCgkJCQkJfQoJCQkJCWZvciAodmFyIHJ1bGUgaW4gY2FjaGVkQXR0cikgewoJCQkJCQlpZiAoIShydWxlIGluIGRhdGFBdHRyKSkgbm9kZS5zdHlsZVtydWxlXSA9ICIiCgkJCQkJfQoJCQkJfQoJCQkJZWxzZSBpZiAobmFtZXNwYWNlICE9PSB1bmRlZmluZWQpIHsKCQkJCQlpZiAoYXR0ck5hbWUgPT09ICJocmVmIikgbm9kZS5zZXRBdHRyaWJ1dGVOUygiaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIsICJocmVmIiwgZGF0YUF0dHIpCgkJCQkJZWxzZSBpZiAoYXR0ck5hbWUgPT09ICJjbGFzc05hbWUiKSBub2RlLnNldEF0dHJpYnV0ZSgiY2xhc3MiLCBkYXRhQXR0cikKCQkJCQllbHNlIG5vZGUuc2V0QXR0cmlidXRlKGF0dHJOYW1lLCBkYXRhQXR0cikKCQkJCX0KCQkJCWVsc2UgaWYgKGF0dHJOYW1lID09PSAidmFsdWUiICYmIHRhZyA9PT0gImlucHV0IikgewoJCQkJCWlmIChub2RlLnZhbHVlICE9PSBkYXRhQXR0cikgbm9kZS52YWx1ZSA9IGRhdGFBdHRyCgkJCQl9CgkJCQllbHNlIGlmIChhdHRyTmFtZSBpbiBub2RlICYmICEoYXR0ck5hbWUgPT0gImxpc3QiIHx8IGF0dHJOYW1lID09ICJzdHlsZSIpKSB7CgkJCQkJbm9kZVthdHRyTmFtZV0gPSBkYXRhQXR0cgoJCQkJfQoJCQkJZWxzZSBub2RlLnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgZGF0YUF0dHIpCgkJCX0KCQl9CgkJcmV0dXJuIGNhY2hlZEF0dHJzCgl9CglmdW5jdGlvbiBjbGVhcihub2RlcykgewoJCWZvciAodmFyIGkgPSBub2Rlcy5sZW5ndGggLSAxOyBpID4gLTE7IGktLSkgaWYgKG5vZGVzW2ldICYmIG5vZGVzW2ldLnBhcmVudE5vZGUpIG5vZGVzW2ldLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZXNbaV0pCgkJbm9kZXMubGVuZ3RoID0gMAoJfQoJZnVuY3Rpb24gaW5qZWN0SFRNTChwYXJlbnRFbGVtZW50LCBpbmRleCwgZGF0YSkgewoJCXZhciBuZXh0U2libGluZyA9IHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0KCQlpZiAobmV4dFNpYmxpbmcpIHsKCQkJdmFyIGlzRWxlbWVudCA9IG5leHRTaWJsaW5nLm5vZGVUeXBlICE9IDEKCQkJdmFyIHBsYWNlaG9sZGVyID0gd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKQoJCQlpZiAoaXNFbGVtZW50KSB7CgkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShwbGFjZWhvbGRlciwgbmV4dFNpYmxpbmcpCgkJCQlwbGFjZWhvbGRlci5pbnNlcnRBZGphY2VudEhUTUwoImJlZm9yZWJlZ2luIiwgZGF0YSkKCQkJCXBhcmVudEVsZW1lbnQucmVtb3ZlQ2hpbGQocGxhY2Vob2xkZXIpCgkJCX0KCQkJZWxzZSBuZXh0U2libGluZy5pbnNlcnRBZGphY2VudEhUTUwoImJlZm9yZWJlZ2luIiwgZGF0YSkKCQl9CgkJZWxzZSBwYXJlbnRFbGVtZW50Lmluc2VydEFkamFjZW50SFRNTCgiYmVmb3JlZW5kIiwgZGF0YSkKCQl2YXIgbm9kZXMgPSBbXQoJCXdoaWxlIChwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdICE9PSBuZXh0U2libGluZykgewoJCQlub2Rlcy5wdXNoKHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0pCgkJCWluZGV4KysKCQl9CgkJcmV0dXJuIG5vZGVzCgl9CglmdW5jdGlvbiBjbG9uZShvYmplY3QpIHsKCQl2YXIgcmVzdWx0ID0ge30KCQlmb3IgKHZhciBwcm9wIGluIG9iamVjdCkgcmVzdWx0W3Byb3BdID0gb2JqZWN0W3Byb3BdCgkJcmV0dXJuIHJlc3VsdAoJfQoJZnVuY3Rpb24gYXV0b3JlZHJhdyhjYWxsYmFjaywgb2JqZWN0KSB7CgkJcmV0dXJuIGZ1bmN0aW9uKGUpIHsKCQkJZSA9IGUgfHwgZXZlbnQKCQkJbS5zdGFydENvbXB1dGF0aW9uKCkKCQkJdHJ5IHtyZXR1cm4gY2FsbGJhY2suY2FsbChvYmplY3QsIGUpfQoJCQlmaW5hbGx5IHttLmVuZENvbXB1dGF0aW9uKCl9CgkJfQoJfQoKCXZhciBodG1sCgl2YXIgZG9jdW1lbnROb2RlID0gewoJCWluc2VydEFkamFjZW50SFRNTDogZnVuY3Rpb24oXywgZGF0YSkgewoJCQl3aW5kb3cuZG9jdW1lbnQud3JpdGUoZGF0YSkKCQkJd2luZG93LmRvY3VtZW50LmNsb3NlKCkKCQl9LAoJCWFwcGVuZENoaWxkOiBmdW5jdGlvbihub2RlKSB7CgkJCWlmIChodG1sID09PSB1bmRlZmluZWQpIGh0bWwgPSB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaHRtbCIpCgkJCWlmIChub2RlLm5vZGVOYW1lID09ICJIVE1MIikgaHRtbCA9IG5vZGUKCQkJZWxzZSBodG1sLmFwcGVuZENoaWxkKG5vZGUpCgkJCWlmICh3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICE9PSBodG1sKSB7CgkJCQl3aW5kb3cuZG9jdW1lbnQucmVwbGFjZUNoaWxkKGh0bWwsIHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpCgkJCX0KCQl9LAoJCWluc2VydEJlZm9yZTogZnVuY3Rpb24obm9kZSkgewoJCQl0aGlzLmFwcGVuZENoaWxkKG5vZGUpCgkJfSwKCQljaGlsZE5vZGVzOiBbXQoJfQoJdmFyIG5vZGVDYWNoZSA9IFtdLCBjZWxsQ2FjaGUgPSB7fQoJbS5yZW5kZXIgPSBmdW5jdGlvbihyb290LCBjZWxsKSB7CgkJdmFyIGNvbmZpZ3MgPSBbXQoJCWlmICghcm9vdCkgdGhyb3cgbmV3IEVycm9yKCJQbGVhc2UgZW5zdXJlIHRoZSBET00gZWxlbWVudCBleGlzdHMgYmVmb3JlIHJlbmRlcmluZyBhIHRlbXBsYXRlIGludG8gaXQuIikKCQl2YXIgaW5kZXggPSBub2RlQ2FjaGUuaW5kZXhPZihyb290KQoJCXZhciBpZCA9IGluZGV4IDwgMCA/IG5vZGVDYWNoZS5wdXNoKHJvb3QpIC0gMSA6IGluZGV4CgkJdmFyIG5vZGUgPSByb290ID09IHdpbmRvdy5kb2N1bWVudCB8fCByb290ID09IHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudE5vZGUgOiByb290CgkJY2VsbENhY2hlW2lkXSA9IGJ1aWxkKG5vZGUsIG51bGwsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjZWxsLCBjZWxsQ2FjaGVbaWRdLCBmYWxzZSwgMCwgbnVsbCwgdW5kZWZpbmVkLCBjb25maWdzKQoJCWZvciAodmFyIGkgPSAwOyBpIDwgY29uZmlncy5sZW5ndGg7IGkrKykgY29uZmlnc1tpXSgpCgl9CgoJbS50cnVzdCA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJdmFsdWUgPSBuZXcgU3RyaW5nKHZhbHVlKQoJCXZhbHVlLiR0cnVzdGVkID0gdHJ1ZQoJCXJldHVybiB2YWx1ZQoJfQoKCXZhciByb290cyA9IFtdLCBtb2R1bGVzID0gW10sIGNvbnRyb2xsZXJzID0gW10sIG5vdyA9IDAsIGxhc3RSZWRyYXcgPSAwLCBsYXN0UmVkcmF3SWQgPSAwLCBjb21wdXRlUG9zdFJlZHJhd0hvb2sgPSBudWxsCgltLm1vZHVsZSA9IGZ1bmN0aW9uKHJvb3QsIG1vZHVsZSkgewoJCXZhciBpbmRleCA9IHJvb3RzLmluZGV4T2Yocm9vdCkKCQlpZiAoaW5kZXggPCAwKSBpbmRleCA9IHJvb3RzLmxlbmd0aAoJCXZhciBpc1ByZXZlbnRlZCA9IGZhbHNlCgkJaWYgKGNvbnRyb2xsZXJzW2luZGV4XSAmJiB0eXBlb2YgY29udHJvbGxlcnNbaW5kZXhdLm9udW5sb2FkID09ICJmdW5jdGlvbiIpIHsKCQkJdmFyIGV2ZW50ID0gewoJCQkJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkge2lzUHJldmVudGVkID0gdHJ1ZX0KCQkJfQoJCQljb250cm9sbGVyc1tpbmRleF0ub251bmxvYWQoZXZlbnQpCgkJfQoJCWlmICghaXNQcmV2ZW50ZWQpIHsKCQkJbS5zdGFydENvbXB1dGF0aW9uKCkKCQkJcm9vdHNbaW5kZXhdID0gcm9vdAoJCQltb2R1bGVzW2luZGV4XSA9IG1vZHVsZQoJCQljb250cm9sbGVyc1tpbmRleF0gPSBuZXcgbW9kdWxlLmNvbnRyb2xsZXIKCQkJbS5lbmRDb21wdXRhdGlvbigpCgkJfQoJfQoJbS5yZWRyYXcgPSBmdW5jdGlvbigpIHsKCQlub3cgPSB3aW5kb3cucGVyZm9ybWFuY2UgJiYgd2luZG93LnBlcmZvcm1hbmNlLm5vdyA/IHdpbmRvdy5wZXJmb3JtYW5jZS5ub3coKSA6IG5ldyB3aW5kb3cuRGF0ZSgpLmdldFRpbWUoKQoJCWlmIChub3cgLSBsYXN0UmVkcmF3ID4gMTYpIHJlZHJhdygpCgkJZWxzZSB7CgkJCXZhciBjYW5jZWwgPSB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwgd2luZG93LmNsZWFyVGltZW91dAoJCQl2YXIgZGVmZXIgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8IHdpbmRvdy5zZXRUaW1lb3V0CgkJCWNhbmNlbChsYXN0UmVkcmF3SWQpCgkJCWxhc3RSZWRyYXdJZCA9IGRlZmVyKHJlZHJhdywgMCkKCQl9Cgl9CglmdW5jdGlvbiByZWRyYXcoKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCByb290cy5sZW5ndGg7IGkrKykgewoJCQlpZiAoY29udHJvbGxlcnNbaV0pIG0ucmVuZGVyKHJvb3RzW2ldLCBtb2R1bGVzW2ldLnZpZXcoY29udHJvbGxlcnNbaV0pKQoJCX0KCQlpZiAoY29tcHV0ZVBvc3RSZWRyYXdIb29rKSB7CgkJCWNvbXB1dGVQb3N0UmVkcmF3SG9vaygpCgkJCWNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IG51bGwKCQl9CgkJbGFzdFJlZHJhdyA9IG5vdwoJfQoKCXZhciBwZW5kaW5nUmVxdWVzdHMgPSAwCgltLnN0YXJ0Q29tcHV0YXRpb24gPSBmdW5jdGlvbigpIHtwZW5kaW5nUmVxdWVzdHMrK30KCW0uZW5kQ29tcHV0YXRpb24gPSBmdW5jdGlvbigpIHsKCQlwZW5kaW5nUmVxdWVzdHMgPSBNYXRoLm1heChwZW5kaW5nUmVxdWVzdHMgLSAxLCAwKQoJCWlmIChwZW5kaW5nUmVxdWVzdHMgPT0gMCkgbS5yZWRyYXcoKQoJfQoKCW0ud2l0aEF0dHIgPSBmdW5jdGlvbihwcm9wLCB3aXRoQXR0ckNhbGxiYWNrKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKGUpIHsKCQkJZSA9IGUgfHwgZXZlbnQKCQkJd2l0aEF0dHJDYWxsYmFjayhwcm9wIGluIGUuY3VycmVudFRhcmdldCA/IGUuY3VycmVudFRhcmdldFtwcm9wXSA6IGUuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUocHJvcCkpCgkJfQoJfQoKCS8vcm91dGluZwoJdmFyIG1vZGVzID0ge3BhdGhuYW1lOiAiIiwgaGFzaDogIiMiLCBzZWFyY2g6ICI/In0KCXZhciByZWRpcmVjdCA9IGZ1bmN0aW9uKCkge30sIHJvdXRlUGFyYW1zID0ge30sIGN1cnJlbnRSb3V0ZQoJbS5yb3V0ZSA9IGZ1bmN0aW9uKCkgewoJCWlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSByZXR1cm4gY3VycmVudFJvdXRlCgkJZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMyAmJiB0eXBlb2YgYXJndW1lbnRzWzFdID09ICJzdHJpbmciKSB7CgkJCXZhciByb290ID0gYXJndW1lbnRzWzBdLCBkZWZhdWx0Um91dGUgPSBhcmd1bWVudHNbMV0sIHJvdXRlciA9IGFyZ3VtZW50c1syXQoJCQlyZWRpcmVjdCA9IGZ1bmN0aW9uKHNvdXJjZSkgewoJCQkJdmFyIHBhdGggPSBjdXJyZW50Um91dGUgPSBub3JtYWxpemVSb3V0ZShzb3VyY2UpCgkJCQlpZiAoIXJvdXRlQnlWYWx1ZShyb290LCByb3V0ZXIsIHBhdGgpKSB7CgkJCQkJbS5yb3V0ZShkZWZhdWx0Um91dGUsIHRydWUpCgkJCQl9CgkJCX0KCQkJdmFyIGxpc3RlbmVyID0gbS5yb3V0ZS5tb2RlID09ICJoYXNoIiA/ICJvbmhhc2hjaGFuZ2UiIDogIm9ucG9wc3RhdGUiCgkJCXdpbmRvd1tsaXN0ZW5lcl0gPSBmdW5jdGlvbigpIHsKCQkJCWlmIChjdXJyZW50Um91dGUgIT0gbm9ybWFsaXplUm91dGUod2luZG93LmxvY2F0aW9uW20ucm91dGUubW9kZV0pKSB7CgkJCQkJcmVkaXJlY3Qod2luZG93LmxvY2F0aW9uW20ucm91dGUubW9kZV0pCgkJCQl9CgkJCX0KCQkJY29tcHV0ZVBvc3RSZWRyYXdIb29rID0gc2V0U2Nyb2xsCgkJCXdpbmRvd1tsaXN0ZW5lcl0oKQoJCQljdXJyZW50Um91dGUgPSBub3JtYWxpemVSb3V0ZSh3aW5kb3cubG9jYXRpb25bbS5yb3V0ZS5tb2RlXSkKCQl9CgkJZWxzZSBpZiAoYXJndW1lbnRzWzBdLmFkZEV2ZW50TGlzdGVuZXIpIHsKCQkJdmFyIGVsZW1lbnQgPSBhcmd1bWVudHNbMF0KCQkJdmFyIGlzSW5pdGlhbGl6ZWQgPSBhcmd1bWVudHNbMV0KCQkJaWYgKGVsZW1lbnQuaHJlZi5pbmRleE9mKG1vZGVzW20ucm91dGUubW9kZV0pIDwgMCkgewoJCQkJZWxlbWVudC5ocmVmID0gd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lICsgbW9kZXNbbS5yb3V0ZS5tb2RlXSArIGVsZW1lbnQucGF0aG5hbWUKCQkJfQoJCQlpZiAoIWlzSW5pdGlhbGl6ZWQpIHsKCQkJCWVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiY2xpY2siLCByb3V0ZVVub2J0cnVzaXZlKQoJCQkJZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHJvdXRlVW5vYnRydXNpdmUpCgkJCX0KCQl9CgkJZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50c1swXSA9PSAic3RyaW5nIikgewoJCQljdXJyZW50Um91dGUgPSBhcmd1bWVudHNbMF0KCQkJdmFyIHF1ZXJ5c3RyaW5nID0gdHlwZW9mIGFyZ3VtZW50c1sxXSA9PSAib2JqZWN0IiA/IGJ1aWxkUXVlcnlTdHJpbmcoYXJndW1lbnRzWzFdKSA6IG51bGwKCQkJaWYgKHF1ZXJ5c3RyaW5nKSBjdXJyZW50Um91dGUgKz0gKGN1cnJlbnRSb3V0ZS5pbmRleE9mKCI/IikgPT09IC0xID8gIj8iIDogIiYiKSArIHF1ZXJ5c3RyaW5nCgoJCQl2YXIgc2hvdWxkUmVwbGFjZUhpc3RvcnlFbnRyeSA9IChhcmd1bWVudHMubGVuZ3RoID09IDMgPyBhcmd1bWVudHNbMl0gOiBhcmd1bWVudHNbMV0pID09PSB0cnVlCgoJCQlpZiAod2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKSB7CgkJCQljb21wdXRlUG9zdFJlZHJhd0hvb2sgPSBmdW5jdGlvbigpIHsKCQkJCQl3aW5kb3cuaGlzdG9yeVtzaG91bGRSZXBsYWNlSGlzdG9yeUVudHJ5ID8gInJlcGxhY2VTdGF0ZSIgOiAicHVzaFN0YXRlIl0obnVsbCwgd2luZG93LmRvY3VtZW50LnRpdGxlLCBtb2Rlc1ttLnJvdXRlLm1vZGVdICsgY3VycmVudFJvdXRlKQoJCQkJCXNldFNjcm9sbCgpCgkJCQl9CgkJCQlyZWRpcmVjdChtb2Rlc1ttLnJvdXRlLm1vZGVdICsgY3VycmVudFJvdXRlKQoJCQl9CgkJCWVsc2Ugd2luZG93LmxvY2F0aW9uW20ucm91dGUubW9kZV0gPSBjdXJyZW50Um91dGUKCQl9Cgl9CgltLnJvdXRlLnBhcmFtID0gZnVuY3Rpb24oa2V5KSB7cmV0dXJuIHJvdXRlUGFyYW1zW2tleV19CgltLnJvdXRlLm1vZGUgPSAic2VhcmNoIgoJZnVuY3Rpb24gbm9ybWFsaXplUm91dGUocm91dGUpIHtyZXR1cm4gcm91dGUuc2xpY2UobW9kZXNbbS5yb3V0ZS5tb2RlXS5sZW5ndGgpfQoJZnVuY3Rpb24gcm91dGVCeVZhbHVlKHJvb3QsIHJvdXRlciwgcGF0aCkgewoJCXJvdXRlUGFyYW1zID0ge30KCgkJdmFyIHF1ZXJ5U3RhcnQgPSBwYXRoLmluZGV4T2YoIj8iKQoJCWlmIChxdWVyeVN0YXJ0ICE9PSAtMSkgewoJCQlyb3V0ZVBhcmFtcyA9IHBhcnNlUXVlcnlTdHJpbmcocGF0aC5zdWJzdHIocXVlcnlTdGFydCArIDEsIHBhdGgubGVuZ3RoKSkKCQkJcGF0aCA9IHBhdGguc3Vic3RyKDAsIHF1ZXJ5U3RhcnQpCgkJfQoKCQlmb3IgKHZhciByb3V0ZSBpbiByb3V0ZXIpIHsKCQkJaWYgKHJvdXRlID09IHBhdGgpIHJldHVybiAhdm9pZCBtLm1vZHVsZShyb290LCByb3V0ZXJbcm91dGVdKQoKCQkJdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKCJeIiArIHJvdXRlLnJlcGxhY2UoLzpbXlwvXSs/XC57M30vZywgIiguKj8pIikucmVwbGFjZSgvOlteXC9dKy9nLCAiKFteXFwvXSspIikgKyAiXC8/JCIpCgoJCQlpZiAobWF0Y2hlci50ZXN0KHBhdGgpKSB7CgkJCQlyZXR1cm4gIXZvaWQgcGF0aC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBrZXlzID0gcm91dGUubWF0Y2goLzpbXlwvXSsvZykgfHwgW10KCQkJCQl2YXIgdmFsdWVzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEsIC0yKQoJCQkJCWZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgcm91dGVQYXJhbXNba2V5c1tpXS5yZXBsYWNlKC86fFwuL2csICIiKV0gPSBkZWNvZGVTcGFjZSh2YWx1ZXNbaV0pCgkJCQkJbS5tb2R1bGUocm9vdCwgcm91dGVyW3JvdXRlXSkKCQkJCX0pCgkJCX0KCQl9Cgl9CglmdW5jdGlvbiByb3V0ZVVub2J0cnVzaXZlKGUpIHsKCQllID0gZSB8fCBldmVudAoJCWlmIChlLmN0cmxLZXkgfHwgZS5tZXRhS2V5IHx8IGUud2hpY2ggPT0gMikgcmV0dXJuCgkJZS5wcmV2ZW50RGVmYXVsdCgpCgkJbS5yb3V0ZShlLmN1cnJlbnRUYXJnZXRbbS5yb3V0ZS5tb2RlXS5zbGljZShtb2Rlc1ttLnJvdXRlLm1vZGVdLmxlbmd0aCkpCgl9CglmdW5jdGlvbiBzZXRTY3JvbGwoKSB7CgkJaWYgKG0ucm91dGUubW9kZSAhPSAiaGFzaCIgJiYgd2luZG93LmxvY2F0aW9uLmhhc2gpIHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2gKCQllbHNlIHdpbmRvdy5zY3JvbGxUbygwLCAwKQoJfQoJZnVuY3Rpb24gYnVpbGRRdWVyeVN0cmluZyhvYmplY3QsIHByZWZpeCkgewoJCXZhciBzdHIgPSBbXQoJCWZvcih2YXIgcHJvcCBpbiBvYmplY3QpIHsKCQkJdmFyIGtleSA9IHByZWZpeCA/IHByZWZpeCArICJbIiArIHByb3AgKyAiXSIgOiBwcm9wLCB2YWx1ZSA9IG9iamVjdFtwcm9wXQoJCQlzdHIucHVzaCh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIgPyBidWlsZFF1ZXJ5U3RyaW5nKHZhbHVlLCBrZXkpIDogZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpKQoJCX0KCQlyZXR1cm4gc3RyLmpvaW4oIiYiKQoJfQoJZnVuY3Rpb24gcGFyc2VRdWVyeVN0cmluZyhzdHIpIHsKCQl2YXIgcGFpcnMgPSBzdHIuc3BsaXQoIiYiKSwgcGFyYW1zID0ge30KCQlmb3IgKHZhciBpID0gMDsgaSA8IHBhaXJzLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBwYWlyID0gcGFpcnNbaV0uc3BsaXQoIj0iKQoJCQlwYXJhbXNbZGVjb2RlU3BhY2UocGFpclswXSldID0gcGFpclsxXSA/IGRlY29kZVNwYWNlKHBhaXJbMV0pIDogKHBhaXIubGVuZ3RoID09PSAxID8gdHJ1ZSA6ICIiKQoJCX0KCQlyZXR1cm4gcGFyYW1zCgl9CglmdW5jdGlvbiBkZWNvZGVTcGFjZShzdHJpbmcpIHsKCQlyZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHN0cmluZy5yZXBsYWNlKC9cKy9nLCAiICIpKQoJfQoKCS8vbW9kZWwKCW0ucHJvcCA9IGZ1bmN0aW9uKHN0b3JlKSB7CgkJdmFyIHByb3AgPSBmdW5jdGlvbigpIHsKCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHN0b3JlID0gYXJndW1lbnRzWzBdCgkJCXJldHVybiBzdG9yZQoJCX0KCQlwcm9wLnRvSlNPTiA9IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc3RvcmUKCQl9CgkJcmV0dXJuIHByb3AKCX0KCgl2YXIgbm9uZSA9IHt9CgltLmRlZmVycmVkID0gZnVuY3Rpb24oKSB7CgkJdmFyIHJlc29sdmVycyA9IFtdLCByZWplY3RlcnMgPSBbXSwgcmVzb2x2ZWQgPSBub25lLCByZWplY3RlZCA9IG5vbmUsIHByb21pc2UgPSBtLnByb3AoKQoJCXZhciBvYmplY3QgPSB7CgkJCXJlc29sdmU6IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCQlpZiAocmVzb2x2ZWQgPT09IG5vbmUpIHByb21pc2UocmVzb2x2ZWQgPSB2YWx1ZSkKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZXJzLmxlbmd0aDsgaSsrKSByZXNvbHZlcnNbaV0odmFsdWUpCgkJCQlyZXNvbHZlcnMubGVuZ3RoID0gcmVqZWN0ZXJzLmxlbmd0aCA9IDAKCQkJfSwKCQkJcmVqZWN0OiBmdW5jdGlvbih2YWx1ZSkgewoJCQkJaWYgKHJlamVjdGVkID09PSBub25lKSByZWplY3RlZCA9IHZhbHVlCgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IHJlamVjdGVycy5sZW5ndGg7IGkrKykgcmVqZWN0ZXJzW2ldKHZhbHVlKQoJCQkJcmVzb2x2ZXJzLmxlbmd0aCA9IHJlamVjdGVycy5sZW5ndGggPSAwCgkJCX0sCgkJCXByb21pc2U6IHByb21pc2UKCQl9CgkJb2JqZWN0LnByb21pc2UucmVzb2x2ZXJzID0gcmVzb2x2ZXJzCgkJb2JqZWN0LnByb21pc2UudGhlbiA9IGZ1bmN0aW9uKHN1Y2Nlc3MsIGVycm9yKSB7CgkJCXZhciBuZXh0ID0gbS5kZWZlcnJlZCgpCgkJCWlmICghc3VjY2Vzcykgc3VjY2VzcyA9IGlkZW50aXR5CgkJCWlmICghZXJyb3IpIGVycm9yID0gaWRlbnRpdHkKCQkJZnVuY3Rpb24gY2FsbGJhY2sobWV0aG9kLCBjYWxsYmFjaykgewoJCQkJcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdmFyIHJlc3VsdCA9IGNhbGxiYWNrKHZhbHVlKQoJCQkJCQlpZiAocmVzdWx0ICYmIHR5cGVvZiByZXN1bHQudGhlbiA9PSAiZnVuY3Rpb24iKSByZXN1bHQudGhlbihuZXh0W21ldGhvZF0sIGVycm9yKQoJCQkJCQllbHNlIG5leHRbbWV0aG9kXShyZXN1bHQgIT09IHVuZGVmaW5lZCA/IHJlc3VsdCA6IHZhbHVlKQoJCQkJCX0KCQkJCQljYXRjaCAoZSkgewoJCQkJCQlpZiAoZSBpbnN0YW5jZW9mIEVycm9yICYmIGUuY29uc3RydWN0b3IgIT09IEVycm9yKSB0aHJvdyBlCgkJCQkJCWVsc2UgbmV4dC5yZWplY3QoZSkKCQkJCQl9CgkJCQl9CgkJCX0KCQkJaWYgKHJlc29sdmVkICE9PSBub25lKSBjYWxsYmFjaygicmVzb2x2ZSIsIHN1Y2Nlc3MpKHJlc29sdmVkKQoJCQllbHNlIGlmIChyZWplY3RlZCAhPT0gbm9uZSkgY2FsbGJhY2soInJlamVjdCIsIGVycm9yKShyZWplY3RlZCkKCQkJZWxzZSB7CgkJCQlyZXNvbHZlcnMucHVzaChjYWxsYmFjaygicmVzb2x2ZSIsIHN1Y2Nlc3MpKQoJCQkJcmVqZWN0ZXJzLnB1c2goY2FsbGJhY2soInJlamVjdCIsIGVycm9yKSkKCQkJfQoJCQlyZXR1cm4gbmV4dC5wcm9taXNlCgkJfQoJCXJldHVybiBvYmplY3QKCX0KCW0uc3luYyA9IGZ1bmN0aW9uKGFyZ3MpIHsKCQl2YXIgbWV0aG9kID0gInJlc29sdmUiCgkJZnVuY3Rpb24gc3luY2hyb25pemVyKHBvcywgcmVzb2x2ZWQpIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CgkJCQlyZXN1bHRzW3Bvc10gPSB2YWx1ZQoJCQkJaWYgKCFyZXNvbHZlZCkgbWV0aG9kID0gInJlamVjdCIKCQkJCWlmICgtLW91dHN0YW5kaW5nID09IDApIHsKCQkJCQlkZWZlcnJlZC5wcm9taXNlKHJlc3VsdHMpCgkJCQkJZGVmZXJyZWRbbWV0aG9kXShyZXN1bHRzKQoJCQkJfQoJCQkJcmV0dXJuIHZhbHVlCgkJCX0KCQl9CgoJCXZhciBkZWZlcnJlZCA9IG0uZGVmZXJyZWQoKQoJCXZhciBvdXRzdGFuZGluZyA9IGFyZ3MubGVuZ3RoCgkJdmFyIHJlc3VsdHMgPSBuZXcgQXJyYXkob3V0c3RhbmRpbmcpCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CgkJCWFyZ3NbaV0udGhlbihzeW5jaHJvbml6ZXIoaSwgdHJ1ZSksIHN5bmNocm9uaXplcihpLCBmYWxzZSkpCgkJfQoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlCgl9CglmdW5jdGlvbiBpZGVudGl0eSh2YWx1ZSkge3JldHVybiB2YWx1ZX0KCglmdW5jdGlvbiBhamF4KG9wdGlvbnMpIHsKCQl2YXIgeGhyID0gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdAoJCXhoci5vcGVuKG9wdGlvbnMubWV0aG9kLCBvcHRpb25zLnVybCwgdHJ1ZSwgb3B0aW9ucy51c2VyLCBvcHRpb25zLnBhc3N3b3JkKQoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKCQkJaWYgKHhoci5yZWFkeVN0YXRlID09PSA0KSB7CgkJCQlpZiAoeGhyLnN0YXR1cyA+PSAyMDAgJiYgeGhyLnN0YXR1cyA8IDMwMCkgb3B0aW9ucy5vbmxvYWQoe3R5cGU6ICJsb2FkIiwgdGFyZ2V0OiB4aHJ9KQoJCQkJZWxzZSBvcHRpb25zLm9uZXJyb3Ioe3R5cGU6ICJlcnJvciIsIHRhcmdldDogeGhyfSkKCQkJfQoJCX0KCQlpZiAodHlwZW9mIG9wdGlvbnMuY29uZmlnID09ICJmdW5jdGlvbiIpIHsKCQkJdmFyIG1heWJlWGhyID0gb3B0aW9ucy5jb25maWcoeGhyLCBvcHRpb25zKQoJCQlpZiAobWF5YmVYaHIgIT09IHVuZGVmaW5lZCkgeGhyID0gbWF5YmVYaHIKCQl9CgkJeGhyLnNlbmQob3B0aW9ucy5kYXRhKQoJCXJldHVybiB4aHIKCX0KCWZ1bmN0aW9uIGJpbmREYXRhKHhock9wdGlvbnMsIGRhdGEsIHNlcmlhbGl6ZSkgewoJCWlmIChkYXRhICYmIE9iamVjdC5rZXlzKGRhdGEpLmxlbmd0aCA+IDApIHsKCQkJaWYgKHhock9wdGlvbnMubWV0aG9kID09ICJHRVQiKSB7CgkJCQl4aHJPcHRpb25zLnVybCA9IHhock9wdGlvbnMudXJsICsgKHhock9wdGlvbnMudXJsLmluZGV4T2YoIj8iKSA8IDAgPyAiPyIgOiAiJiIpICsgYnVpbGRRdWVyeVN0cmluZyhkYXRhKQoJCQl9CgkJCWVsc2UgeGhyT3B0aW9ucy5kYXRhID0gc2VyaWFsaXplKGRhdGEpCgkJfQoJCXJldHVybiB4aHJPcHRpb25zCgl9CglmdW5jdGlvbiBwYXJhbWV0ZXJpemVVcmwodXJsLCBkYXRhKSB7CgkJdmFyIHRva2VucyA9IHVybC5tYXRjaCgvOlthLXpdXHcrL2dpKQoJCWlmICh0b2tlbnMgJiYgZGF0YSkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkrKykgewoJCQkJdmFyIGtleSA9IHRva2Vuc1tpXS5zbGljZSgxKQoJCQkJdXJsID0gdXJsLnJlcGxhY2UodG9rZW5zW2ldLCBkYXRhW2tleV0pCgkJCQlkZWxldGUgZGF0YVtrZXldCgkJCX0KCQl9CgkJcmV0dXJuIHVybAoJfQoKCW0ucmVxdWVzdCA9IGZ1bmN0aW9uKHhock9wdGlvbnMpIHsKCQlpZiAoeGhyT3B0aW9ucy5iYWNrZ3JvdW5kICE9PSB0cnVlKSBtLnN0YXJ0Q29tcHV0YXRpb24oKQoJCXZhciBkZWZlcnJlZCA9IG0uZGVmZXJyZWQoKQoJCXZhciBzZXJpYWxpemUgPSB4aHJPcHRpb25zLnNlcmlhbGl6ZSB8fCBKU09OLnN0cmluZ2lmeQoJCXZhciBkZXNlcmlhbGl6ZSA9IHhock9wdGlvbnMuZGVzZXJpYWxpemUgfHwgSlNPTi5wYXJzZQoJCXZhciBleHRyYWN0ID0geGhyT3B0aW9ucy5leHRyYWN0IHx8IGZ1bmN0aW9uKHhocikgewoJCQlyZXR1cm4geGhyLnJlc3BvbnNlVGV4dC5sZW5ndGggPT09IDAgJiYgZGVzZXJpYWxpemUgPT09IEpTT04ucGFyc2UgPyBudWxsIDogeGhyLnJlc3BvbnNlVGV4dAoJCX0KCQl4aHJPcHRpb25zLnVybCA9IHBhcmFtZXRlcml6ZVVybCh4aHJPcHRpb25zLnVybCwgeGhyT3B0aW9ucy5kYXRhKQoJCXhock9wdGlvbnMgPSBiaW5kRGF0YSh4aHJPcHRpb25zLCB4aHJPcHRpb25zLmRhdGEsIHNlcmlhbGl6ZSkKCQl4aHJPcHRpb25zLm9ubG9hZCA9IHhock9wdGlvbnMub25lcnJvciA9IGZ1bmN0aW9uKGUpIHsKCQkJdHJ5IHsKCQkJCWUgPSBlIHx8IGV2ZW50CgkJCQl2YXIgdW53cmFwID0gKGUudHlwZSA9PSAibG9hZCIgPyB4aHJPcHRpb25zLnVud3JhcFN1Y2Nlc3MgOiB4aHJPcHRpb25zLnVud3JhcEVycm9yKSB8fCBpZGVudGl0eQoJCQkJdmFyIHJlc3BvbnNlID0gdW53cmFwKGRlc2VyaWFsaXplKGV4dHJhY3QoZS50YXJnZXQsIHhock9wdGlvbnMpKSkKCQkJCWlmIChlLnR5cGUgPT0gImxvYWQiKSB7CgkJCQkJaWYgKHJlc3BvbnNlIGluc3RhbmNlb2YgQXJyYXkgJiYgeGhyT3B0aW9ucy50eXBlKSB7CgkJCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgcmVzcG9uc2UubGVuZ3RoOyBpKyspIHJlc3BvbnNlW2ldID0gbmV3IHhock9wdGlvbnMudHlwZShyZXNwb25zZVtpXSkKCQkJCQl9CgkJCQkJZWxzZSBpZiAoeGhyT3B0aW9ucy50eXBlKSByZXNwb25zZSA9IG5ldyB4aHJPcHRpb25zLnR5cGUocmVzcG9uc2UpCgkJCQl9CgkJCQlkZWZlcnJlZFtlLnR5cGUgPT0gImxvYWQiID8gInJlc29sdmUiIDogInJlamVjdCJdKHJlc3BvbnNlKQoJCQl9CgkJCWNhdGNoIChlKSB7CgkJCQlpZiAoZSBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB0aHJvdyBuZXcgU3ludGF4RXJyb3IoIkNvdWxkIG5vdCBwYXJzZSBIVFRQIHJlc3BvbnNlLiBTZWUgaHR0cDovL2xob3JpZS5naXRodWIuaW8vbWl0aHJpbC9taXRocmlsLnJlcXVlc3QuaHRtbCN1c2luZy12YXJpYWJsZS1kYXRhLWZvcm1hdHMiKQoJCQkJZWxzZSBpZiAoZSBpbnN0YW5jZW9mIEVycm9yICYmIGUuY29uc3RydWN0b3IgIT09IEVycm9yKSB0aHJvdyBlCgkJCQllbHNlIGRlZmVycmVkLnJlamVjdChlKQoJCQl9CgkJCWlmICh4aHJPcHRpb25zLmJhY2tncm91bmQgIT09IHRydWUpIG0uZW5kQ29tcHV0YXRpb24oKQoJCX0KCQlhamF4KHhock9wdGlvbnMpCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UKCX0KCgkvL3Rlc3RpbmcgQVBJCgltLmRlcHMgPSBmdW5jdGlvbihtb2NrKSB7cmV0dXJuIHdpbmRvdyA9IG1vY2t9CgkvL2ZvciBpbnRlcm5hbCB0ZXN0aW5nIG9ubHksIGRvIG5vdCB1c2UgYG0uZGVwcy5mYWN0b3J5YAoJbS5kZXBzLmZhY3RvcnkgPSBhcHAKCglyZXR1cm4gbQp9KHR5cGVvZiB3aW5kb3cgIT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKCmlmICh0eXBlb2YgbW9kdWxlICE9ICJ1bmRlZmluZWQiICYmIG1vZHVsZSAhPT0gbnVsbCkgbW9kdWxlLmV4cG9ydHMgPSBtCmlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgZGVmaW5lKGZ1bmN0aW9uKCkge3JldHVybiBtfSkKCjs7Owo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 16:12:17 GMT",
                    "Content-Length": "22592",
                    "Date": "Fri, 07 Nov 2014 16:12:19 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}