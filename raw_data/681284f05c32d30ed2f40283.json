{
    "url": "http://localhost:9999/xingyan/octopus/output/octopus.debug.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>window.location.href</b> and written to <b>the 'href' property of a DOM element</b> via the following statements:<ul><li>url = url || window.location.href;</li><li>url = fullUrl + url;</li><li>a.href = url;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/xingyan/octopus/output/octopus.debug.js",
                "path": "/xingyan/octopus/output/octopus.debug.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC94aW5neWFuL29jdG9wdXMvb3V0cHV0L29jdG9wdXMuZGVidWcuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzcxODA1DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDIxOjE3OjAyIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAyMToxNjo1NyBHTVQNCg0KLyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tu+8jOS4u+imgeeUqOS6jumAmueUqOe7hOS7tueahOexu+e7k+aehOWjsOaYjgogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24od2luZG93LCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAgKiDlkb3lkI3nqbrpl7TliY3nvIAg8J+QmQogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzCiAgICAgKiBAZGVzYyDlkb3lkI3nqbrpl7Tor7TmmI4g5omA5pyJ5bCP5YaZ5a2X5q+N5byA5aS055qE5pa55rOV6YO95Y+v5Lul55u05o6l6LCD55SoIOWmgm9jdG9wdXMuZWFzaW5nLmxpbmVhci5lYXNlSW4KICAgICAqIOebuOWPje+8jOWkp+WGmeWtl+avjeW8gOWktOeahOWRveWQjeivtOaYjuivpeWvueixoeaYr+S4gOS4quexu+WvueixoSDpnIDopoHnlKjlhbPplK7lrZduZXcg5aaCIG5ldyBvY3RvcHVzLldpZGdldCgpCiAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICovCiAgICB2YXIgb2N0b3B1cywKICAgICAgICBvID0gb2N0b3B1cyA9IHt2ZXJzaW9uOiAiMS4xIn07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZGVmaW5lCiAgICAgKiBAZGVzYyDnsbvnlJ/miJAu5bCG6L+U5Zue5LiA5Liq5b2i5aaC4oCU4oCUCiAgICAgKiBmdW5jdGlvbiBDKCkgewogICAgICogICAgICB0aGlzLmluaXRpYWxpemUoKQogICAgICogfTsKICAgICAqIEMucHJvdG90eXBlID0geyBjb25zdHJ1Y3RvcjogQywgLi4uIH3nmoTlr7nosaEKICAgICAqIOaUr+aMgeS4pOS4quWPguaVsO+8jOesrOS4gOS4quS4uueItuexu++8iOWPr+S4jeWtmOWcqO+8ie+8jOesrOS6jOS4quS4uueUn+aIkOexu+eahOWQhOWxnuaAp+aWueazleWvueixoSDnlLHkuo7mr4/kuKrnsbvnmoTnlJ/miJDpg73ln7rkuo7lrZDnsbvlr7nniLbnsbvlr7nosaHnmoTmt7Hluqbmi7fotJ3vvIzlm6DmraTvvIwKICAgICAqIOS4uumBv+WFjeWtkOexu+WxnuaAp+abtOaUueWvueeItuexu+mAoOaIkOeahOS4jeWPr+aOp+W9seWTje+8jOmZpE51bWJlcnxTdHJpbmd8Qm9vbGVhbiDlpJbnmoTlr7nosaEg5Yid5aeL5YyW6YO95bu66K6u5pS+5Zyo5p6E6YCg5Ye95pWw5b2T5Lit5Y675YGaIOWIneWni+WMluWAvOW7uuiurgogICAgICog5Li6bnVsbAogICAgICogQGV4YW1wbGUKICAgICAqIHZhciBuZXdDbGFzcyA9IG9jdG9wdXMuZGVmaW5lKHsKICAgICAqICAgICB3aWR0aDogNjQsCiAgICAgKiAgICAgbGVuZ3RoOiAiMTJweCIsCiAgICAgKiAgICAgcHJvcGVydHk6IG51bGwsCiAgICAgKiAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgICAgIHRoaXMucHJvcGVydHkgPSBPYmplY3QuY3JlYXRlKHt9KTsKICAgICAqICAgICB9CiAgICAgKiB9KTsKICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufQogICAgICovCiAgICBvLmRlZmluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICAgICAgICBzID0gYXJndW1lbnRzWzBdLAogICAgICAgICAgICBpID0gYXJndW1lbnRzW2xlbiAtIDFdOwoKICAgICAgICB2YXIgbmMgPSB0eXBlb2YgaS5pbml0aWFsaXplID09ICJmdW5jdGlvbiIgPyBpLmluaXRpYWxpemUgOgogICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICAgIGlmKGxlbiA+IDEpIHsKICAgICAgICAgICAgdmFyIG5ld0FyZ3MgPSBbbmMsIHNdLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpLnNsaWNlKDEsIGxlbiAtIDEpLCBpKTsKICAgICAgICAgICAgby5pbmhlcml0LmFwcGx5KG51bGwsIG5ld0FyZ3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5jLnByb3RvdHlwZSA9IGk7CiAgICAgICAgICAgIG5jLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IG5jOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmM7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLmluaGVyaXQKICAgICAqIEBkZXNjIOe7p+aJvwogICAgICogQHBhcmFtIGNoaWxkIHtGdW5jdGlvbn0g5a2Q57G7CiAgICAgKiBAcGFyYW0gZmF0aGVyIHtGdW5jdGlvbn0g54i257G7CiAgICAgKi8KICAgIG8uaW5oZXJpdCA9IGZ1bmN0aW9uKGNoaWxkLCBmYXRoZXIpIHsKICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uKCkge30sCiAgICAgICAgICAgIGNwLAogICAgICAgICAgICBmcCA9IGZhdGhlci5wcm90b3R5cGU7CiAgICAgICAgZi5wcm90b3R5cGUgPSBmcDsKICAgICAgICBjcCA9IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBmOwogICAgICAgIGNwLmNvbnN0cnVjdG9yID0gY2hpbGQ7CiAgICAgICAgdmFyIGksIGwsIGs7CiAgICAgICAgZm9yKGkgPSAyLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICBrID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICBpZih0eXBlb2YgayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgayA9IGsucHJvdG90eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgayk7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy5leHRlbmQKICAgICAqIEBkZXNjIOWwhuS4gOS4quWvueixoeeahOWxnuaAp+WkjeWItue7meWPpuS4gOS4quWvueixoQogICAgICogQHBhcmFtIGRlc3RpbmF0aW9uIHtvYmplY3R9CiAgICAgKiBAcGFyYW0gc291cmNlIHtvYmplY3R9CiAgICAgKiBAcmV0dXJuIGRlc3RpbmF0aW9uIHtvYmplY3R9IOWkjeWItuWQjueahOWvueixoQogICAgICovCiAgICBvLmV4dGVuZCA9IGZ1bmN0aW9uKGRlc3RpbmF0aW9uLCBzb3VyY2UpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IGRlc3RpbmF0aW9uIHx8IHt9OwogICAgICAgIGlmKHNvdXJjZSkgewogICAgICAgICAgICBmb3IodmFyIHByb3BlcnR5IGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gc291cmNlW3Byb3BlcnR5XTsKICAgICAgICAgICAgICAgIGlmKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbltwcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc291cmNlSXNFdnQgPSB0eXBlb2Ygd2luZG93LkV2ZW50ID09ICJmdW5jdGlvbiIKICAgICAgICAgICAgICAgICYmIHNvdXJjZSBpbnN0YW5jZW9mIHdpbmRvdy5FdmVudDsKCiAgICAgICAgICAgIGlmICghc291cmNlSXNFdnQgJiYgc291cmNlLmhhc093blByb3BlcnR5ICYmIHNvdXJjZS5oYXNPd25Qcm9wZXJ0eSgidG9TdHJpbmciKSkgewogICAgICAgICAgICAgICAgZGVzdGluYXRpb24udG9TdHJpbmcgPSBzb3VyY2UudG9TdHJpbmc7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlc3RpbmF0aW9uOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lc3BhY2Ugb2N0b3B1cy51dGlsCiAgICAgKiBAZGVzYyDlt6Xlhbfpm4blkIgg55u45b2T5LqOanF1ZXJ555qEZm4KICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgKi8KICAgIG8udXRpbCA9IG8udXRpbCB8fCB7fTsKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLnV0aWwubGFzdFNlcUlkCiAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICovCiAgICBvLnV0aWwubGFzdFNlcUlkID0gMDsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmNyZWF0ZVVuaXF1ZUlECiAgICAgKiBAcGFyYW0gcHJlZml4IHtTdHJpbmd9IOWJjee8gAogICAgICogQHJldHVybiB7U3RyaW5nfSDlhajlsYDllK/kuIDnmoTkuIDkuKrlrZfnrKbkuLIKICAgICAqLwogICAgby51dGlsLmNyZWF0ZVVuaXF1ZUlEID0gZnVuY3Rpb24ocHJlZml4KSB7CiAgICAgICAgcHJlZml4ID0gKHByZWZpeCA9PT0gbnVsbCB8fCBwcmVmaXggPT09IHVuZGVmaW5lZCkgPyAib2N0b3B1cyIgOiBwcmVmaXgucmVwbGFjZSgvXC4vZywgIl8iKTsKICAgICAgICBvLnV0aWwubGFzdFNlcUlkKys7CiAgICAgICAgcmV0dXJuIHByZWZpeCArIG8udXRpbC5sYXN0U2VxSWQ7CiAgICB9OwoKICAgIHdpbmRvdy5vY3RvcHVzID0gbzsKCn0pKHdpbmRvdyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tgogKiB1dGlsIC0gICDlt6Xlhbflh73mlbDpg6jliIYKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIOmBv+WFjeacquWjsOaYjiBvY3RvcHVzLnV0aWwKICAgICAqLwogICAgdmFyIHV0aWwgPSBvLnV0aWwgPSBvLnV0aWwgfHwge307CgogICAgLyoqCiAgICAgKiBAY29uc3Qgb2N0b3B1cy51dGlsLkxFRlQge1N0cmluZ30gImxlZnQiCiAgICAgKiBAY29uc3Qgb2N0b3B1cy51dGlsLlJJR0hUIHtTdHJpbmd9ICJyaWdodCIKICAgICAqIEBjb25zdCBvY3RvcHVzLnV0aWwuVVAge1N0cmluZ30gInVwIgogICAgICogQGNvbnN0IG9jdG9wdXMudXRpbC5ET1dOIHtTdHJpbmd9ICJkb3duIgogICAgICovCiAgICB1dGlsLkxFRlQgPSAibGVmdCI7CiAgICB1dGlsLlJJR0hUID0gInJpZ2h0IjsKICAgIHV0aWwuVVAgPSAidXAiOwogICAgdXRpbC5ET1dOID0gImRvd24iOwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZ2V0Q2VudGVyCiAgICAgKiBAcGFyYW0gdG91Y2hlcyB7QXJyYXl9CiAgICAgKiBAcmV0dXJuIHtvYmplY3R9CiAgICAgKiBAZGVzYyDojrflvpfmiYDmnInop6bmkbjngrnnmoTkuK3lv4MKICAgICAqLwogICAgdXRpbC5nZXRDZW50ZXIgPSBmdW5jdGlvbih0b3VjaGVzKSB7CiAgICAgICAgdmFyIHZhbHVlc1ggPSBbXSwgdmFsdWVzWSA9IFtdOwoKICAgICAgICBmb3IodmFyIHQ9IDAsbGVuPXRvdWNoZXMubGVuZ3RoOyB0PGxlbjsgdCsrKSB7CiAgICAgICAgICAgIHZhbHVlc1gucHVzaCh0b3VjaGVzW3RdLnBhZ2VYKTsKICAgICAgICAgICAgdmFsdWVzWS5wdXNoKHRvdWNoZXNbdF0ucGFnZVkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcGFnZVg6ICgoTWF0aC5taW4uYXBwbHkoTWF0aCwgdmFsdWVzWCkgKyBNYXRoLm1heC5hcHBseShNYXRoLCB2YWx1ZXNYKSkgLyAyKSwKICAgICAgICAgICAgcGFnZVk6ICgoTWF0aC5taW4uYXBwbHkoTWF0aCwgdmFsdWVzWSkgKyBNYXRoLm1heC5hcHBseShNYXRoLCB2YWx1ZXNZKSkgLyAyKQogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZ2V0VmVsb2NpdHkKICAgICAqIEBkZXNjIOiOt+W+l+S4pOeCuemXtOeerOenu+mAn+W6pgogICAgICogQHBhcmFtIGRlbHRhX3RpbWUge051bWJlcn0KICAgICAqIEBwYXJhbSBkZWx0YV94IHtOdW1iZXJ9CiAgICAgKiBAcGFyYW0gZGVsdGFfeSB7TnVtYmVyfQogICAgICogQHJldHVybiB7b2JqZWN0fSB45Li65qiq5ZCR6YCf5bqmIHnkuLrnurXlkJHpgJ/luqYKICAgICAqLwogICAgdXRpbC5nZXRWZWxvY2l0eSA9IGZ1bmN0aW9uKGRlbHRhX3RpbWUsIGRlbHRhX3gsIGRlbHRhX3kpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB4OiBNYXRoLmFicyhkZWx0YV94IC8gZGVsdGFfdGltZSkgfHwgMCwKICAgICAgICAgICAgeTogTWF0aC5hYnMoZGVsdGFfeSAvIGRlbHRhX3RpbWUpIHx8IDAKICAgICAgICB9OwoKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRBbmdsZQogICAgICogQGRlc2Mg6I635b6X5Lik54K56Ze06KeS5bqmCiAgICAgKiBAcGFyYW0gdG91Y2gxIHtPYmplY3R9CiAgICAgKiBAcGFyYW0gdG91Y2gyIHtPYmplY3R9CiAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9CiAgICAgKi8KICAgIHV0aWwuZ2V0QW5nbGUgPSBmdW5jdGlvbih0b3VjaDEsIHRvdWNoMikgewogICAgICAgIHZhciB5ID0gdG91Y2gyLnBhZ2VZIC0gdG91Y2gxLnBhZ2VZLAogICAgICAgICAgICB4ID0gdG91Y2gyLnBhZ2VYIC0gdG91Y2gxLnBhZ2VYOwogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHksIHgpICogMTgwIC8gTWF0aC5QSTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXREaXJlY3Rpb24KICAgICAqIEBkZXNjIOiOt+W+l+inpueisOa7keWKqOaWueWQkQogICAgICogQHBhcmFtIHRvdWNoMSB7T2JqZWN0fQogICAgICogQHBhcmFtIHRvdWNoMiB7T2JqZWN0fQogICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICovCiAgICB1dGlsLmdldERpcmVjdGlvbiA9IGZ1bmN0aW9uKHRvdWNoMSwgdG91Y2gyKSB7CiAgICAgICAgdmFyIHggPSBNYXRoLmFicyh0b3VjaDEucGFnZVggLSB0b3VjaDIucGFnZVgpLAogICAgICAgICAgICB5ID0gTWF0aC5hYnModG91Y2gxLnBhZ2VZIC0gdG91Y2gyLnBhZ2VZKTsKCiAgICAgICAgaWYoeCA+PSB5KSB7CiAgICAgICAgICAgIHJldHVybiB0b3VjaDEucGFnZVggLSB0b3VjaDIucGFnZVggPiAwID8gdXRpbC5MRUZUIDogdXRpbC5SSUdIVDsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0b3VjaDEucGFnZVkgLSB0b3VjaDIucGFnZVkgPiAwID8gdXRpbC5VUCA6IHV0aWwuRE9XTjsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZ2V0RGlzdGFuY2UKICAgICAqIEBkZXNjIOiOt+W+l+S4pOeCuemXtOi3neemuwogICAgICogQHBhcmFtIHRvdWNoMSB7T2JqZWN0fQogICAgICogQHBhcmFtIHRvdWNoMiB7T2JqZWN0fQogICAgICogQHJldHVybiB7TnVtYmVyfQogICAgICovCiAgICB1dGlsLmdldERpc3RhbmNlID0gZnVuY3Rpb24odG91Y2gxLCB0b3VjaDIpIHsKICAgICAgICB2YXIgeCA9IHRvdWNoMi5wYWdlWCAtIHRvdWNoMS5wYWdlWCwKICAgICAgICAgICAgeSA9IHRvdWNoMi5wYWdlWSAtIHRvdWNoMS5wYWdlWTsKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KCh4ICogeCkgKyAoeSAqIHkpKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRTY2FsZQogICAgICogQGRlc2Mg6I635b6X5Lik6Kem5pG454K55ruR5Yqo5ZCO5b6X5Yiw55qE5Lik6Kem5pG454K55LmL5LqO5LmL5YmN55qE5pS+5aSn5YCN5pWwCiAgICAgKiBAcGFyYW0gc3RhcnQge0FycmF5fQogICAgICogQHBhcmFtIGVuZCB7QXJyYXl9CiAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9CiAgICAgKi8KICAgIHV0aWwuZ2V0U2NhbGUgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgICAgaWYoc3RhcnQubGVuZ3RoID49IDIgJiYgZW5kLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERpc3RhbmNlKGVuZFswXSwgZW5kWzFdKSAvCiAgICAgICAgICAgICAgICB0aGlzLmdldERpc3RhbmNlKHN0YXJ0WzBdLCBzdGFydFsxXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAxOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmdldFJvdGF0aW9uCiAgICAgKiBAZGVzYyDojrflvpfkuKTop6bmkbjngrnmu5HliqjlkI7lvpfliLDnmoTkuKTop6bmkbjngrnkuYvkuo7kuYvliY3nmoTml4vovazluqbmlbAKICAgICAqIEBwYXJhbSBzdGFydCB7QXJyYXl9CiAgICAgKiBAcGFyYW0gZW5kIHtBcnJheX0KICAgICAqIEByZXR1cm4ge051bWJlcn0KICAgICAqLwogICAgdXRpbC5nZXRSb3RhdGlvbiA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpIHsKICAgICAgICBpZihzdGFydC5sZW5ndGggPj0gMiAmJiBlbmQubGVuZ3RoID49IDIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QW5nbGUoZW5kWzFdLCBlbmRbMF0pIC0KICAgICAgICAgICAgICAgIHRoaXMuZ2V0QW5nbGUoc3RhcnRbMV0sIHN0YXJ0WzBdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZW5jb2RlSHRtbAogICAgICogQGRlc2Mg5a+55a2X56ym5Liy5Lit55qE54m55q6K5a2X56ym6L+b6KGMaHRtbOe8lueggQogICAgICogQHBhcmFtIHN0ciB7U3RyaW5nfQogICAgICovCiAgICB1dGlsLmVuY29kZUh0bWwgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gU3RyaW5nKHN0cikKICAgICAgICAgICAgLnJlcGxhY2UoLyYvZywgIiZhbXA7IikKICAgICAgICAgICAgLnJlcGxhY2UoLzwvZywgIiZsdDsiKQogICAgICAgICAgICAucmVwbGFjZSgvPi9nLCAiJmd0OyIpCiAgICAgICAgICAgIC5yZXBsYWNlKC8iL2csICImcXVvdDsiKQogICAgICAgICAgICAucmVwbGFjZSgvJy9nLCAiJiMzOTsiKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5kZWNvZGVIdG1sCiAgICAgKiBAZGVzYyDlr7nlrZfnrKbkuLLkuK3nmoRodG1s6L+b6KGM57yW56CBCiAgICAgKiBAcGFyYW0gc3RyIHtTdHJpbmd9CiAgICAgKi8KICAgIHV0aWwuaHRtbERlY29kZURpY3QgPSB7InF1b3QiOiAnIicsICJsdCI6ICI8IiwgImd0IjogIj4iLCAiYW1wIjogIiYiLCAiIzM5IjogIicifTsKICAgIHV0aWwuZGVjb2RlSHRtbCA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKC8mKHF1b3R8bHR8Z3R8YW1wfCMzOSk7L2lnLCBmdW5jdGlvbihhbGwsIGtleSkgewogICAgICAgICAgICByZXR1cm4gdXRpbC5odG1sRGVjb2RlRGljdFtrZXldOwogICAgICAgIH0pLnJlcGxhY2UoLyYjdShbYS1mXGRdezR9KTsvaWcsIGZ1bmN0aW9uKGFsbCwgaGV4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludCgiMHgiICsgaGV4KSk7CiAgICAgICAgICAgIH0pLnJlcGxhY2UoLyYjKFxkKyk7L2lnLCBmdW5jdGlvbihhbGwsIG51bWJlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoK251bWJlcik7CiAgICAgICAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmxvYWRJbWFnZQogICAgICogQGRlc2Mg5Yqg6L295Zu+54mH5pa55rOVCiAgICAgKiBAcGFyYW0gdXJsIHtTdHJpbmd9IOWbvueJh3VybAogICAgICogQHBhcmFtIHJlYWR5IHtGdW5jdGlvbn0g5q2k5pe25Zu+54mH5rKh5pyJ5Yqg6L295a6MIOS9huaYr+WuvemrmOW3suefpQogICAgICogQHBhcmFtIGxvYWQge0Z1bmN0aW9ufSDlm77niYdvbmxvYWTnmoRjYWxsYmFjawogICAgICogQHBhcmFtIGVycm9yIHtGdW5jdGlvbn0g5Zu+54mH5Yqg6L295aSx6LSl55qEY2FsbGJhY2sKICAgICAqLwogICAgdXRpbC5sb2FkSW1hZ2UgPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGxpc3QgPSBbXSwKICAgICAgICAgICAgaW50ZXJ2YWxJZCA9IG51bGwsCiAgICAgICAgLy/nlKjmnaXmiafooYzpmJ/liJcKICAgICAgICAgICAgdGljayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdFtpXS5lbmQgPyBsaXN0LnNwbGljZShpLS0sIDEpIDogbGlzdFtpXSgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICFsaXN0Lmxlbmd0aCAmJiBzdG9wKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgLy8g5YGc5q2i5omA5pyJ5a6a5pe25Zmo6Zif5YiXCiAgICAgICAgICAgIHN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsSWQpOwogICAgICAgICAgICAgICAgaW50ZXJ2YWxJZCA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh1cmwsIHJlYWR5LCBsb2FkLCBlcnJvcikgewogICAgICAgICAgICB2YXIgb25yZWFkeSwgd2lkdGgsIGhlaWdodCwgbmV3V2lkdGgsIG5ld0hlaWdodCwKICAgICAgICAgICAgICAgIGltZyA9IG5ldyBJbWFnZSgpOwogICAgICAgICAgICBpbWcuc3JjID0gdXJsOwogICAgICAgICAgICAvLyDlpoLmnpzlm77niYfooqvnvJPlrZjvvIzliJnnm7TmjqXov5Tlm57nvJPlrZjmlbDmja4KICAgICAgICAgICAgaWYgKGltZy5jb21wbGV0ZSkgewogICAgICAgICAgICAgICAgcmVhZHkuY2FsbChpbWcpOwogICAgICAgICAgICAgICAgbG9hZCAmJiBsb2FkLmNhbGwoaW1nKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2lkdGggPSBpbWcud2lkdGg7CiAgICAgICAgICAgIGhlaWdodCA9IGltZy5oZWlnaHQ7CiAgICAgICAgICAgIC8vIOWKoOi9vemUmeivr+WQjueahOS6i+S7tgogICAgICAgICAgICBpbWcub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGVycm9yICYmIGVycm9yLmNhbGwoaW1nKTsKICAgICAgICAgICAgICAgIG9ucmVhZHkuZW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGltZyA9IGltZy5vbmxvYWQgPSBpbWcub25lcnJvciA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIOWbvueJh+WwuuWvuOWwsee7qgogICAgICAgICAgICBvbnJlYWR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgbmV3V2lkdGggPSBpbWcud2lkdGg7CiAgICAgICAgICAgICAgICBuZXdIZWlnaHQgPSBpbWcuaGVpZ2h0OwogICAgICAgICAgICAgICAgaWYgKG5ld1dpZHRoICE9PSB3aWR0aCB8fCBuZXdIZWlnaHQgIT09IGhlaWdodCB8fCBuZXdXaWR0aCAqIG5ld0hlaWdodCA+IDEwMjQpIHsKICAgICAgICAgICAgICAgICAgICByZWFkeS5jYWxsKGltZyk7CiAgICAgICAgICAgICAgICAgICAgb25yZWFkeS5lbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgb25yZWFkeSgpOwogICAgICAgICAgICAvLyDlrozlhajliqDovb3lrozmr5XnmoTkuovku7YKICAgICAgICAgICAgaW1nLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIG9ubG9hZOWcqOWumuaXtuWZqOaXtumXtOW3ruiMg+WbtOWGheWPr+iDveavlG9ucmVhZHnlv6sKICAgICAgICAgICAgICAgIC8vIOi/memHjOi/m+ihjOajgOafpeW5tuS/neivgW9ucmVhZHnkvJjlhYjmiafooYwKICAgICAgICAgICAgICAgICFvbnJlYWR5LmVuZCAmJiBvbnJlYWR5KCk7CiAgICAgICAgICAgICAgICBsb2FkICYmIGxvYWQuY2FsbChpbWcpOwogICAgICAgICAgICAgICAgLy8gSUUgZ2lm5Yqo55S75Lya5b6q546v5omn6KGMb25sb2Fk77yM572u56m6b25sb2Fk5Y2z5Y+vCiAgICAgICAgICAgICAgICBpbWcgPSBpbWcub25sb2FkID0gaW1nLm9uZXJyb3IgPSBudWxsOwogICAgICAgICAgICB9OwogICAgICAgICAgICAvLyDliqDlhaXpmJ/liJfkuK3lrprmnJ/miafooYwKICAgICAgICAgICAgaWYoIW9ucmVhZHkuZW5kKSB7CiAgICAgICAgICAgICAgICBsaXN0LnB1c2gob25yZWFkeSk7CiAgICAgICAgICAgICAgICAvLyDml6DorrrkvZXml7blj6rlhYHorrjlh7rnjrDkuIDkuKrlrprml7blmajvvIzlh4/lsJHmtY/op4jlmajmgKfog73mjZ/ogJcKICAgICAgICAgICAgICAgIGlmIChpbnRlcnZhbElkID09PSBudWxsKSBpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwodGljaywgNDApOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9KSgpOwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZW1wdHkKICAgICAqIEBkZXNjIOepuuWHveaVsAogICAgICovCiAgICB1dGlsLmVtcHR5ID0gZnVuY3Rpb24oKSB7fTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmJpbmQKICAgICAqIEBkZXNjIOaNouS9nOeUqOWfnwogICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufQogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fQogICAgICovCiAgICB1dGlsLmJpbmQgPSBmdW5jdGlvbihmdW5jLCBvYmplY3QpIHsKICAgICAgICAvLyBjcmVhdGUgYSByZWZlcmVuY2UgdG8gYWxsIGFyZ3VtZW50cyBwYXN0IHRoZSBzZWNvbmQgb25lCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzLCBbMl0pOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gUHVzaCBvbiBhbnkgYWRkaXRpb25hbCBhcmd1bWVudHMgZnJvbSB0aGUgYWN0dWFsIGZ1bmN0aW9uIGNhbGwuCiAgICAgICAgICAgIC8vIFRoZXNlIHdpbGwgY29tZSBhZnRlciB0aG9zZSBzZW50IHRvIHRoZSBiaW5kIGNhbGwuCiAgICAgICAgICAgIHZhciBuZXdBcmdzID0gYXJncy5jb25jYXQoCiAgICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzLCBbMF0pCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybiBmdW5jLmFwcGx5KG9iamVjdCwgbmV3QXJncyk7CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5iaW5kQXNFdmVudExpc3RlbmVyCiAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IOS9nOS4uuS6i+S7tuebkeWQrOeahOWHveaVsAogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fSDkvZznlKjln58KICAgICAqLwogICAgdXRpbC5iaW5kQXNFdmVudExpc3RlbmVyID0gZnVuY3Rpb24oZnVuYywgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwob2JqZWN0LCBldmVudCB8fCB3aW5kb3cuZXZlbnQpOwogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuaXNOb2RlCiAgICAgKiBAZGVzYyDliKTmlq3lr7nosaHmmK/lkKbmmK/oioLngrkKICAgICAqIEBwYXJhbSBvIHtPYmplY3R9CiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICB1dGlsLmlzTm9kZSA9IGZ1bmN0aW9uKG8pIHsKICAgICAgICByZXR1cm4gISEobyAmJiBvLm5vZGVUeXBlID09PSAxKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5pc09iamVjdAogICAgICogQGRlc2Mg5Yik5pat5a+56LGh5piv5ZCm5piv5a+56LGhCiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICB1dGlsLmlzT2JqZWN0ID0gZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICAgIHJldHVybiAnZnVuY3Rpb24nID09IHR5cGVvZiBzb3VyY2UgfHwgISEoc291cmNlICYmICdvYmplY3QnID09IHR5cGVvZiBzb3VyY2UpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmlzU3RyaW5nCiAgICAgKiBAZGVzYyDliKTmlq3lr7nosaHmmK/lkKbmmK/lrZfnrKbkuLIKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgKi8KICAgIHV0aWwuaXNTdHJpbmcgPSBmdW5jdGlvbiAoc291cmNlKSB7CiAgICAgICAgcmV0dXJuICdbb2JqZWN0IFN0cmluZ10nID09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzb3VyY2UpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmlzQXJyYXkKICAgICAqIEBkZXNjIOWIpOaWreWvueixoeaYr+WQpuaYr+aVsOe7hAogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgdXRpbC5pc0FycmF5ID0gZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgcmV0dXJuICgnW29iamVjdCBBcnJheV0nID09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzb3VyY2UpKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5pc051bWVyaWMKICAgICAqIEBkZXNjIOWIpOaWreWvueixoeaYr+WQpuaYr+aVsOWtlwogICAgICogQHJldHVybnMge0Jvb2xlYW59CiAgICAgKi8KICAgIHV0aWwuaXNOdW1lcmljID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgcmV0dXJuICFpc05hTihwYXJzZUZsb2F0KG9iaikpICYmIGlzRmluaXRlKG9iaik7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuaXNQbGFpbgogICAgICogQGRlc2Mg5Yik5pat5piv5ZCm5piv5pmu6YCa5a+56LGhIOmdnmZ1bmN0aW9uCiAgICAgKi8KICAgIHV0aWwuaXNQbGFpbiAgPSBmdW5jdGlvbihvYmopewogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgICAgIGtleTsKICAgICAgICBpZiAoICFvYmogfHwKICAgICAgICAgICAgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgIT09ICJbb2JqZWN0IE9iamVjdF0iIHx8CiAgICAgICAgICAgICEoJ2lzUHJvdG90eXBlT2YnIGluIG9iaikKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKCBvYmouY29uc3RydWN0b3IgJiYKICAgICAgICAgICAgIWhhc093blByb3BlcnR5LmNhbGwob2JqLCAiY29uc3RydWN0b3IiKSAmJgogICAgICAgICAgICAhaGFzT3duUHJvcGVydHkuY2FsbChvYmouY29uc3RydWN0b3IucHJvdG90eXBlLCAiaXNQcm90b3R5cGVPZiIpICkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZvciAoIGtleSBpbiBvYmogKSB7fQogICAgICAgIHJldHVybiBrZXkgPT09IHVuZGVmaW5lZCB8fCBoYXNPd25Qcm9wZXJ0eS5jYWxsKCBvYmosIGtleSApOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmlzRW1wdHkKICAgICAqIEBkZXNjIOWIpOaWreS8oOWFpeeahOWPguaVsOaYr+WQpuS4uuepuu+8jAogICAgICogICAgICAg5YyF5ousdW5kZWZpbmVkLCBudWxsLCBmYWxzZSwgbnVtYmVyIDAsCiAgICAgKiAgICAgICBlbXB0eSBzdHJpbmcsIHN0cmluZyAiMCIsIHt9IGFuZCBbXQogICAgICogQHJldHVybnMge0Jvb2xlYW59CiAgICAgKi8KICAgIHV0aWwuaXNFbXB0eSA9IGZ1bmN0aW9uKG1peGVkX3ZhcikgewogICAgICAgIHZhciB1bmRlZiwga2V5LCBpLCBsZW47CiAgICAgICAgdmFyIGVtcHR5VmFsdWVzID0gW3VuZGVmLCBudWxsLCBmYWxzZSwgMCwgIiIsICIwIl07CgogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGVtcHR5VmFsdWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmIChtaXhlZF92YXIgPT09IGVtcHR5VmFsdWVzW2ldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBtaXhlZF92YXIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIG1peGVkX3ZhcikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmNsb25lCiAgICAgKiBAZGVzYyDmt7Hluqbmi7fotJ3kuIDkuKrlr7nosaEKICAgICAqIEByZXR1cm4g5ou36LSd5ZCO55qE5a+56LGhCiAgICAgKi8KICAgIHV0aWwuY2xvbmUgPSBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gc291cmNlLCBpLCBsZW47CiAgICAgICAgaWYgKCFzb3VyY2UKICAgICAgICAgICAgfHwgc291cmNlIGluc3RhbmNlb2YgTnVtYmVyCiAgICAgICAgICAgIHx8IHNvdXJjZSBpbnN0YW5jZW9mIFN0cmluZwogICAgICAgICAgICB8fCBzb3VyY2UgaW5zdGFuY2VvZiBCb29sZWFuKSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSBlbHNlIGlmKHV0aWwuaXNOb2RlKHNvdXJjZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHNvdXJjZS5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh1dGlsLmlzQXJyYXkoc291cmNlKSkgewogICAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdExlbiA9IDAsCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGxlbiA9IHNvdXJjZS5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIHJlc3VsdFtyZXN1bHRMZW4rK10gPSB1dGlsLmNsb25lKHNvdXJjZVtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHV0aWwuaXNQbGFpbihzb3VyY2UpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHt9OwogICAgICAgICAgICBmb3IgKGkgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICBpZiAoc291cmNlLmhhc093blByb3BlcnR5KGkpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2ldID0gdXRpbC5jbG9uZShzb3VyY2VbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZWFjaAogICAgICogQHBhcmFtIHNvdXJjZSB7QXJyYXkgfCBPYmplY3R9CiAgICAgKiBAcGFyYW0gY2FsbGJhY2sge0Z1bmN0aW9ufQogICAgICogQHJldHVybnMgeyp9CiAgICAgKiBAZGVzYyDpgY3ljobmlbDnu4TmiJblr7nosaEKICAgICAqLwogICAgdXRpbC5lYWNoID0gZnVuY3Rpb24oc291cmNlLCBjYWxsYmFjaykgewogICAgICAgIGlmKHV0aWwuaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgICAgIHJldHVybiBBcnJheS5mb3JFYWNoID8gc291cmNlLmZvckVhY2goY2FsbGJhY2spIDogZnVuY3Rpb24oYXIsIGZ1bmMpIHsKICAgICAgICAgICAgICAgIHZhciBsZW4gPSBhci5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgICAgICAgICBmb3IoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5jYWxsKHRoaXMsIGFyW2ldLCBpKTsKICAgICAgICAgICAgICAgICAgICBpZihyZXN1bHQgPT09IHRydWUpIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KHNvdXJjZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICBpZih1dGlsLmlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgICAgICAgZm9yKHZhciBrIGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgaWYoc291cmNlLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrLmNhbGwodGhpcywgc291cmNlW2tdLCBrKTsKICAgICAgICAgICAgICAgICAgICBpZihyZXN1bHQgPT09IHRydWUpIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5mb3JtYXQKICAgICAqIEBwYXJhbSBzdHIge1N0cmluZ30g5b6F6L2s5o2i55qE5a2X56ym5LiyCiAgICAgKiBAcGFyYW0gZGF0YSB7fSDmlbDmja4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9CiAgICAgKi8KICAgIHV0aWwuZm9ybWF0ID0gZnVuY3Rpb24oc3RyLCBkYXRhKSB7CiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC8oIylceyguKj8pXH0vZywgZnVuY3Rpb24oYWxsLCBmbGFnLCBwYXJhbSkgewogICAgICAgICAgICByZXR1cm4gZGF0YSAmJiB0eXBlb2YgZGF0YVtwYXJhbV0gIT0gInVuZGVmaW5lZCIgPyBkYXRhW3BhcmFtXSA6ICIiOwogICAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmFwcGx5RGVmYXVsdHMKICAgICAqIEBkZXNjIOWwhuS4gOS4quWvueixoemHjOayoeacieeahOWPguaVsOWkjeWItue7meWPpuS4gOS4quWvueixoSDkuI5leHRlbmTnmoTljLrliKvlnKjkuo4g5aaC5p6c5LiN5Lya5aSN5Yi25bey5a2Y5Zyo5bGe5oCnCiAgICAgKiBAcGFyYW0gdG8ge09iamVjdH0KICAgICAqIEBwYXJhbSBmcm9tIHtPYmplY3R9CiAgICAgKi8KICAgIHV0aWwuYXBwbHlEZWZhdWx0cyA9IGZ1bmN0aW9uKHRvLCBmcm9tKSB7CiAgICAgICAgdG8gPSB0byB8fCB7fTsKICAgICAgICB2YXIgZnJvbUlzRXZ0ID0gdHlwZW9mIHdpbmRvdy5FdmVudCA9PSAiZnVuY3Rpb24iCiAgICAgICAgICAgICYmIGZyb20gaW5zdGFuY2VvZiB3aW5kb3cuRXZlbnQ7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGZyb20pIHsKICAgICAgICAgICAgaWYodG9ba2V5XSA9PT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICAoIWZyb21Jc0V2dCAmJiBmcm9tLmhhc093blByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgJiYgZnJvbS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmICF0by5oYXNPd25Qcm9wZXJ0eShrZXkpKSkgewogICAgICAgICAgICAgICAgdG9ba2V5XSA9IGZyb21ba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZighZnJvbUlzRXZ0ICYmIGZyb20gJiYgZnJvbS5oYXNPd25Qcm9wZXJ0eQogICAgICAgICAgICAmJiBmcm9tLmhhc093blByb3BlcnR5KCd0b1N0cmluZycpICYmICF0by5oYXNPd25Qcm9wZXJ0eSgndG9TdHJpbmcnKSkgewogICAgICAgICAgICB0by50b1N0cmluZyA9IGZyb20udG9TdHJpbmc7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0bzsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5hcHBseUFkZAogICAgICogQGRlc2Mg5bCG5LiA5Liq5a+56LGh6YeM55qE5Y+C5pWw5rex5bqm5ou36LSd57uZ5Y+m5LiA5Liq5a+56LGhIOWmguaenOWPguaVsOW3suWtmOWcqCDliJnopobnm5Yg5aaC5p6c5LiN5a2Y5ZyoIOWImei/veWKoAogICAgICogQHBhcmFtIHRvIHtPYmplY3R9CiAgICAgKiBAcGFyYW0gZnJvbSAge09iamVjdH0KICAgICAqLwogICAgdXRpbC5hcHBseUFkZCA9IGZ1bmN0aW9uKHRvLCBmcm9tKSB7CiAgICAgICAgdG8gPSB0byB8fCB7fTsKICAgICAgICB2YXIgZnJvbUlzRXZ0ID0gdHlwZW9mIHdpbmRvdy5FdmVudCA9PSAiZnVuY3Rpb24iCiAgICAgICAgICAgICYmIGZyb20gaW5zdGFuY2VvZiB3aW5kb3cuRXZlbnQ7CiAgICAgICAgZm9yKHZhciBrIGluIGZyb20pIHsKICAgICAgICAgICAgaWYodXRpbC5pc09iamVjdCh0b1trXSkgJiYgdXRpbC5pc09iamVjdChmcm9tW2tdKSkgewogICAgICAgICAgICAgICAgdG9ba10gPSB1dGlsLmFwcGx5QWRkKHRvW2tdLCBmcm9tW2tdKTsKICAgICAgICAgICAgfSBlbHNlIGlmKGZyb21ba10gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdG9ba10gPSBmcm9tW2tdCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYoIWZyb21Jc0V2dCAmJiBmcm9tICYmIGZyb20uaGFzT3duUHJvcGVydHkKICAgICAgICAgICAgJiYgZnJvbS5oYXNPd25Qcm9wZXJ0eSgndG9TdHJpbmcnKSAmJiAhdG8uaGFzT3duUHJvcGVydHkoJ3RvU3RyaW5nJykpIHsKICAgICAgICAgICAgdG8udG9TdHJpbmcgPSBmcm9tLnRvU3RyaW5nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG87CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwudXJsQXBwZW5kCiAgICAgKiBAZGVzYyDlsIbmjIflrprlrZfnrKbkuLLph4znmoTlhoXlrrnmi7zov5t1cmwKICAgICAqIEBwYXJhbSB1cmwge1N0cmluZ30KICAgICAqIEBwYXJhbSBwYXJhbVN0ciB7U3RyaW5nfQogICAgICogQGV4YW1wbGUKICAgICAqIHVybCA9ICJodHRwOi8vd3d3Lmdvb2dsZS5jb20iOwogICAgICogb2N0b3B1cy51dGlsLnVybEFwcGVuZCh1cmwsICJhPTEmYj0yIik7CiAgICAgKiByZXR1cm4gImh0dHA6Ly93d3cuZ29vZ2xlLmNvbT9hPTEmYj0yIgogICAgICovCiAgICB1dGlsLnVybEFwcGVuZCA9IGZ1bmN0aW9uKHVybCwgcGFyYW1TdHIpIHsKICAgICAgICB2YXIgbmV3VXJsID0gdXJsOwogICAgICAgIGlmKHBhcmFtU3RyKSB7CiAgICAgICAgICAgIHZhciBwYXJ0cyA9ICh1cmwgKyAiICIpLnNwbGl0KC9bPyZdLyk7CiAgICAgICAgICAgIG5ld1VybCArPSAocGFydHMucG9wKCkgPT09ICIgIiA/CiAgICAgICAgICAgICAgICBwYXJhbVN0ciA6CiAgICAgICAgICAgICAgICBwYXJ0cy5sZW5ndGggPyAiJiIgKyBwYXJhbVN0ciA6ICI/IiArIHBhcmFtU3RyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld1VybDsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRQYXJhbWV0ZXJTdHJpbmcKICAgICAqIEBkZXNjIOS7juaMh+WumuWQjeWAvOWvuemHjOaQnuWHuuadpeWtl+espuS4suW9ouW8jwogICAgICogQHBhcmFtIHBhcmFtcyB7T2JqZWN0fQogICAgICogQGV4YW1wbGUKICAgICAqIHBhcmFtID0geyBhOiAxLCBiOiAyIH0KICAgICAqIG9jdG9wdXMudXRpbC5nZXRQYXJhbWV0ZXJTdHJpbmcocGFyYW0pCiAgICAgKiByZXR1cm4gImE9MSZiPTIiCiAgICAgKi8KICAgIHV0aWwuZ2V0UGFyYW1ldGVyU3RyaW5nID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgdmFyIHBhcmFtc0FycmF5ID0gW107CiAgICAgICAgZm9yICh2YXIga2V5IGluIHBhcmFtcykgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJhbXNba2V5XTsKICAgICAgICAgICAgaWYgKCh2YWx1ZSAhPSBudWxsKSAmJiAodHlwZW9mIHZhbHVlICE9ICdmdW5jdGlvbicpKSB7CiAgICAgICAgICAgICAgICB2YXIgZW5jb2RlZFZhbHVlOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiB2YWx1ZS5jb25zdHJ1Y3RvciA9PSBBcnJheSkgewogICAgICAgICAgICAgICAgICAgIHZhciBlbmNvZGVkSXRlbUFycmF5ID0gW107CiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW07CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaXRlbUluZGV4PTAsIGxlbj12YWx1ZS5sZW5ndGg7IGl0ZW1JbmRleDxsZW47IGl0ZW1JbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0gPSB2YWx1ZVtpdGVtSW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGVkSXRlbUFycmF5LnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGl0ZW0gPT09IG51bGwgfHwgaXRlbSA9PT0gdW5kZWZpbmVkKSA/ICIiIDogaXRlbSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZW5jb2RlZFZhbHVlID0gZW5jb2RlZEl0ZW1BcnJheS5qb2luKCIsIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlbmNvZGVkVmFsdWUgPSBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFyYW1zQXJyYXkucHVzaChlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZWRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcmFtc0FycmF5LmpvaW4oIiYiKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRQYXJhbWV0ZXJzCiAgICAgKiBAZGVzYyDku451cmzkuK0/5ZCO55qE5a2X56ym5Liy5Lul5a+56LGh5b2i5byP6L+U5ZueCiAgICAgKiBAcGFyYW0gdXJsIHtTdHJpbmd9CiAgICAgKiBAZXhhbXBsZQogICAgICogdXJsID0gImh0dHA6Ly93d3cuYmFpZHUuY29tP2E9MSZiPTIiCiAgICAgKiBvY3RvcHVzLnV0aWwuZ2V0UGFyYW1ldGVycyh1cmwpOwogICAgICogcmV0dXJuIHsgYTogMSwgYjogMiB9CiAgICAgKi8KICAgIHV0aWwuZ2V0UGFyYW1ldGVycyA9IGZ1bmN0aW9uKHVybCkgewogICAgICAgIHVybCA9ICh1cmwgPT09IG51bGwgfHwgdXJsID09PSB1bmRlZmluZWQpID8gd2luZG93LmxvY2F0aW9uLmhyZWYgOiB1cmw7CiAgICAgICAgdmFyIHBhcmFtc1N0cmluZyA9ICIiOwogICAgICAgIGlmKHVybC5pbmRleE9mKCI/IikgIT0gLTEpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdXJsLmluZGV4T2YoJz8nKSArIDE7CiAgICAgICAgICAgIHZhciBlbmQgPSB1cmwuaW5kZXhPZigiIyIpICE9IC0xID8KICAgICAgICAgICAgICAgIHVybC5pbmRleE9mKCcjJykgOiB1cmwubGVuZ3RoOwogICAgICAgICAgICBwYXJhbXNTdHJpbmcgPSB1cmwuc3Vic3RyaW5nKHN0YXJ0LCBlbmQpOwogICAgICAgIH0KICAgICAgICB2YXIgcGFyYW1ldGVycyA9IHt9OwogICAgICAgIHZhciBwYWlycyA9IHBhcmFtc1N0cmluZy5zcGxpdCgvWyY7XS8pLAogICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgbGVuID0gcGFpcnMubGVuZ3RoOwogICAgICAgIGZvciggOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgdmFyIGtleVZhbHVlID0gcGFpcnNbaV0uc3BsaXQoJz0nKTsKICAgICAgICAgICAgaWYoa2V5VmFsdWVbMF0pIHsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBrZXlWYWx1ZVswXTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gZGVjb2RlVVJJQ29tcG9uZW50KGtleSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSB1bmVzY2FwZShrZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gKGtleVZhbHVlWzFdIHx8ICcnKS5yZXBsYWNlKC9cKy9nLCAiICIpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHVuZXNjYXBlKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc3BsaXQoIiwiKTsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT0gMSkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVbMF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyYW1ldGVyczsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5jcmVhdGVVcmxPYmplY3QKICAgICAqIEBkZXNjIOWIm+W7uuS4gOS4qnVybOWvueixoeeahOWQjeWAvOWvuQogICAgICog6YeM6Z2i5oyJ54WndzNjIHVybOagh+WHhuaPkOS+m+S6huavj+S4gOS4queahOWAvAogICAgICogQGV4YW1wbGUKICAgICAqIHVybCA9ICJodHRwOi8vd3d3Lmdvb2dsZS5jb20/YT0xJmI9MiNhYmM9MSI7CiAgICAgKiBvY3RvcHVzLnV0aWwuY3JlYXRlVXJsT2JqZWN0KHVybCk7CiAgICAgKiByZXR1cm4KICAgICAqIHsKICAgICAqICBhcmdzOiBPYmplY3QsCiAgICAgKiAgYTogIjEiLAogICAgICogIGI6ICIyIiwKICAgICAqICBoYXNoOiAiI2FiYz0xIiwKICAgICAqICBob3N0OiAid3d3Lmdvb2dsZS5jb20iLAogICAgICogIHBhdGhuYW1lOiAiLyIsCiAgICAgKiAgcG9ydDogIjgwIiwKICAgICAqICBwcm90b2NvbDogImh0dHA6IiwKICAgICAqIH0KICAgICAqLwogICAgdXRpbC5jcmVhdGVVcmxPYmplY3QgPSBmdW5jdGlvbih1cmwsIG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICB1cmwgPSB1cmwgfHwgd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgaWYoISgvXlx3KzpcL1wvLykudGVzdCh1cmwpKSB7CiAgICAgICAgICAgIHZhciBsb2MgPSB3aW5kb3cubG9jYXRpb247CiAgICAgICAgICAgIHZhciBwb3J0ID0gbG9jLnBvcnQgPyAiOiIgKyBsb2MucG9ydCA6ICIiOwogICAgICAgICAgICB2YXIgZnVsbFVybCA9IGxvYy5wcm90b2NvbCArICIvLyIgKyBsb2MuaG9zdC5zcGxpdCgiOiIpLnNoaWZ0KCkgKyBwb3J0OwogICAgICAgICAgICBpZih1cmwuaW5kZXhPZigiLyIpID09PSAwKSB7CiAgICAgICAgICAgICAgICB1cmwgPSBmdWxsVXJsICsgdXJsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHBhcnRzID0gbG9jLnBhdGhuYW1lLnNwbGl0KCIvIik7CiAgICAgICAgICAgICAgICBwYXJ0cy5wb3AoKTsKICAgICAgICAgICAgICAgIHVybCA9IGZ1bGxVcmwgKyBwYXJ0cy5qb2luKCIvIikgKyAiLyIgKyB1cmw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMuaWdub3JlQ2FzZSkgewogICAgICAgICAgICB1cmwgPSB1cmwudG9Mb3dlckNhc2UoKTsKICAgICAgICB9CiAgICAgICAgdmFyIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYS5ocmVmID0gdXJsOwogICAgICAgIHZhciB1cmxPYmplY3QgPSB7fTsKICAgICAgICB1cmxPYmplY3QuaG9zdCA9IGEuaG9zdC5zcGxpdCgiOiIpLnNoaWZ0KCk7CiAgICAgICAgdXJsT2JqZWN0LnByb3RvY29sID0gYS5wcm90b2NvbDsKICAgICAgICBpZihvcHRpb25zLmlnbm9yZVBvcnQ4MCkgewogICAgICAgICAgICB1cmxPYmplY3QucG9ydCA9IChhLnBvcnQgPT0gIjgwIiB8fCBhLnBvcnQgPT0gIjAiKSA/ICIiIDogYS5wb3J0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVybE9iamVjdC5wb3J0ID0gKGEucG9ydCA9PSAiIiB8fCBhLnBvcnQgPT0gIjAiKSA/ICI4MCIgOiBhLnBvcnQ7CiAgICAgICAgfQoKICAgICAgICAvL2hhc2gKICAgICAgICB1cmxPYmplY3QuaGFzaCA9IChvcHRpb25zLmlnbm9yZUhhc2ggfHwgYS5oYXNoID09PSAiIyIpID8gIiIgOiBhLmhhc2g7CiAgICAgICAgdmFyIHF1ZXJ5U3RyaW5nID0gYS5zZWFyY2g7CiAgICAgICAgaWYgKCFxdWVyeVN0cmluZykgewogICAgICAgICAgICB2YXIgcU1hcmsgPSB1cmwuaW5kZXhPZigiPyIpOwogICAgICAgICAgICBxdWVyeVN0cmluZyA9IChxTWFyayAhPSAtMSkgPyB1cmwuc3Vic3RyKHFNYXJrKSA6ICIiOwogICAgICAgIH0KICAgICAgICB1cmxPYmplY3QuYXJncyA9IHV0aWwuZ2V0UGFyYW1ldGVycyhxdWVyeVN0cmluZyk7CiAgICAgICAgdXJsT2JqZWN0LnBhdGhuYW1lID0gKGEucGF0aG5hbWUuY2hhckF0KDApID09ICIvIikgPyBhLnBhdGhuYW1lIDogIi8iICsgYS5wYXRobmFtZTsKICAgICAgICByZXR1cm4gdXJsT2JqZWN0OwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLnRyaW0KICAgICAqIEBkZXNjIOWOu+aOieWtl+espuS4suS4pOS+p+epuueZvQogICAgICogQHBhcmFtIHN0ciB7U3RyaW5nfQogICAgICovCiAgICB1dGlsLnRyaW0gPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICBzdHIgPSBTdHJpbmcoc3RyKTsKICAgICAgICByZXR1cm4gISFzdHIudHJpbSA/IHN0ci50cmltKCkgOiBzdHIucmVwbGFjZShuZXcgUmVnRXhwKCIoXltcXHNcXHRcXHhhMFxcdTMwMDBdKyl8KFtcXHUzMDAwXFx4YTBcXHNcXHRdK1x4MjQpIiwgImciKSwgJycpOwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5yZW1vdmVJdGVtCiAgICAgKiBAcGFyYW0gc291cmNlCiAgICAgKiBAcGFyYW0gaXRlbQogICAgICovCiAgICB1dGlsLnJlbW92ZUl0ZW0gPSBmdW5jdGlvbihzb3VyY2UsIGl0ZW0pIHsKICAgICAgICB2YXIgbGVuID0gc291cmNlLmxlbmd0aCwKICAgICAgICAgICAgaSA9IGxlbjsKICAgICAgICBmb3IoOyBpLS07ICkgewogICAgICAgICAgICBpZihzb3VyY2VbaV0gPT09IGl0ZW0pIHsKICAgICAgICAgICAgICAgIHNvdXJjZS5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC51cHBlckNhc2VPYmplY3QKICAgICAqIEBkZXNjIOWwhuaMh+WumuWvueixoemHjOeahGtleemmluWtl+avjeWkp+WGmQogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fQogICAgICovCiAgICB1dGlsLnVwcGVyQ2FzZU9iamVjdCA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgICB2YXIgdU9iamVjdCA9IHt9OwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgICAgdU9iamVjdFtrZXkudG9VcHBlckNhc2UoKV0gPSBvYmplY3Rba2V5XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVPYmplY3Q7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuY2FtZWxpemUKICAgICAqIEBkZXNjIOmpvOWzsOWMluWtl+espuS4sgogICAgICogQHBhcmFtIHNvdXJjZSB7U3RyaW5nfQogICAgICovCiAgICB1dGlsLmNhbWVsaXplID0gZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgdmFyIG9TdHJpbmdMaXN0ID0gc291cmNlLnNwbGl0KC9bXC18X3xcc3xcLl0vZyk7CiAgICAgICAgdmFyIGNhbWVsaXplZFN0cmluZyA9IG9TdHJpbmdMaXN0WzBdLAogICAgICAgICAgICBpID0gMSwKICAgICAgICAgICAgbGVuID0gb1N0cmluZ0xpc3QubGVuZ3RoOwogICAgICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIHZhciBzID0gb1N0cmluZ0xpc3RbaV07CiAgICAgICAgICAgIGNhbWVsaXplZFN0cmluZyArPSBzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcy5zdWJzdHJpbmcoMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjYW1lbGl6ZWRTdHJpbmc7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuc3R5bGVDc3MKICAgICAqIEBkZXNjIOWwhuWJjee8gOexu2NzcyDmoLflvI/ljJYKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgY3NzID0gIi13ZWJraXQtdHJhbnNpdGlvbiI7CiAgICAgKiBvY3RvcHVzLnV0aWwuc3R5bGVDc3MoY3NzKTsKICAgICAqIHJldHVybiAid2Via2l0VHJhbnNpdGlvbiIKICAgICAqLwogICAgdXRpbC5zdHlsZUNzcyA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHZhciBmbGFnID0gdHJ1ZTsKICAgICAgICB2YXIgc3RyID0gc3RyLnJlcGxhY2UoL1wtKFxTKS9nLCBmdW5jdGlvbigkMSwgJDIpIHsKICAgICAgICAgICAgcmV0dXJuIGZsYWcgPyAoZmxhZyA9IGZhbHNlLCAkMikgOiAkMi50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBzdHI7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuY3NzU3R5bGUKICAgICAqIEBkZXNjIOWwhuagt+W8j+WMlueahOWJjee8gCBjc3PljJYKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgc3R5bGUgPSAid2Via2l0VHJhbnNpdGlvbiIKICAgICAqIG9jdG9wdXMudXRpbC5jc3NTdHlsZShzdHlsZSk7CiAgICAgKiByZXR1cm4gLXdlYmtpdC10cmFuc2l0aW9uCiAgICAgKi8KICAgIHV0aWwuY3NzU3R5bGUgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICB2YXIgc3RyID0gc3RyLnJlcGxhY2UoLyheXFN8W0EtWl0pL2csIGZ1bmN0aW9uKCQxKSB7CiAgICAgICAgICAgIHJldHVybiAiLSIgKyAkMS50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBzdHI7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwucmVxdWVzdEFuaW1hdGlvbgogICAgICovCiAgICB1dGlsLnJlcXVlc3RBbmltYXRpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlcXVlc3QgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgIHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICB3aW5kb3cub1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICB3aW5kb3cubXNSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgZnVuY3Rpb24oY2FsbGJhY2ssIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGNhbGxiYWNrLCAxNik7CiAgICAgICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbGxiYWNrLCBlbGVtZW50KSB7CiAgICAgICAgICAgIHJlcXVlc3QuYXBwbHkod2luZG93LCBbY2FsbGJhY2ssIGVsZW1lbnRdKTsKICAgICAgICB9OwogICAgfSkoKTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tgogKiBkb20gLSAgIGRvbeaTjeS9nOmDqOWIhgogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIKICAgICAgICAvKioKICAgICAgICAgKiBAZGVzYyDlt6Xlhbflh73mlbDnmoTlkb3lkI3nqbrpl7QKICAgICAgICAgKi8KICAgICAgICB1ID0gby51dGlsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAZGVzYyDlo7DmmI5kb2N1bWVudAogICAgICAgICAqLwogICAgICAgIGRvYyA9IGRvY3VtZW50OwoKICAgIGZ1bmN0aW9uIGdldFNjcmVlbkJ5KHQpIHsKICAgICAgICB2YXIgdiA9IHdpbmRvd1siaW5uZXIiICsgdF0sCiAgICAgICAgICAgIF92ID0gKHUuaXNOdW1lcmljKHYpICYmIHYgPiAwKSA/IHYgOgogICAgICAgICAgICAgICAgKGRvYy5jb21wYXRNb2RlID09ICJDU1MxQ29tcGF0IikgPyBkb2MuZG9jdW1lbnRFbGVtZW50WyJjbGllbnQiICsgdF0gOiBvLmRvbVsiZ2V0IiArIHRdKGRvYy5ib2R5KTsKICAgICAgICByZXR1cm4gX3YgPiAwID8gX3YgOiAwOwogICAgfQoKICAgIC8qKgogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzLmRvbQogICAgICogQGRlc2Mg5LiA5Lqb5Z+656GA55qEZG9t5pON5L2cCiAgICAgKi8KICAgIG8uZG9tID0gewogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uZwogICAgICAgICAqIEBwYXJhbSBlbAogICAgICAgICAqIEBkZXNjIOmdoGlk5ou/5Liq6IqC54K5IOeUseS6juWPquaYr+eugOWNleaUr+aMgSDmsqHmnInlv4XopoHlhpnlvpfpgqPkuYjpq5jnuqcKICAgICAgICAgKi8KICAgICAgICBnOiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICB2YXIgZWwgPSAodS5pc1N0cmluZyhlbCkgPyBkb2MuZ2V0RWxlbWVudEJ5SWQoZWwpIDogKHUuaXNPYmplY3QoZWwpICYmIGVsKSk7CiAgICAgICAgICAgIHJldHVybiBlbCB8fCBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uJAogICAgICAgICAqIEBwYXJhbSBmaWx0ZXIKICAgICAgICAgKiBAcGFyYW0gZWwKICAgICAgICAgKiBAZGVzYyDkuI3mg7Pph43lpI3nmoTljrvlhpnov5nkuYjlpJog5ou/5Yiw5LiA5Liq6IqC54K56ZuG5ZCICiAgICAgICAgICovCiAgICAgICAgJDogZnVuY3Rpb24oZmlsdGVyLCBlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBlbCB8fCBkb2MsCiAgICAgICAgICAgICAgICBfZWwgPSBvLmcoZWwpOwogICAgICAgICAgICByZXR1cm4gKG8udXRpbC5pc05vZGUoX2VsKSB8fCBfZWwgPT0gZG9jKSA/IF9lbC5xdWVyeVNlbGVjdG9yQWxsKGZpbHRlcikgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20ub25lCiAgICAgICAgICogQHBhcmFtIGZpbHRlcgogICAgICAgICAqIEBwYXJhbSBlbAogICAgICAgICAqIEBkZXNjIOaLv+WIsOaMh+WumuiKgueCueS4i+eahOaWh+aho+a1gemHjOeahOesrOS4gOS4quiKgueCuQogICAgICAgICAqLwogICAgICAgIG9uZTogZnVuY3Rpb24oZmlsdGVyLCBlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBlbCB8fCBkb2MsCiAgICAgICAgICAgICAgICBfZWwgPSBvLmcoZWwpOwogICAgICAgICAgICByZXR1cm4gKG8udXRpbC5pc05vZGUoX2VsKSB8fCBfZWwgPT0gZG9jKSA/IF9lbC5xdWVyeVNlbGVjdG9yKGZpbHRlcikgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uaGFzQ2xhc3MKICAgICAgICAgKiBAZGVzYyDliKTmlq3oioLngrnmnIljbGFzcwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGhhc0NsYXNzOiBmdW5jdGlvbihlbCwgbmFtZSkgewogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIHZhciBuYW1lczsKICAgICAgICAgICAgcmV0dXJuICEhZWwuY2xhc3NMaXN0ID8gZWwuY2xhc3NMaXN0LmNvbnRhaW5zKG5hbWUpIDoKICAgICAgICAgICAgICAgIChuYW1lcyA9IGVsLmNsYXNzTmFtZSwgISFuYW1lcyAmJiBuZXcgUmVnRXhwKCIoXnxcXHMpIiArIG5hbWUgKyAiKFxcc3wkKSIpLnRlc3QobmFtZXMpKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLmFkZENsYXNzCiAgICAgICAgICogQGRlc2Mg57uZ5oyH5a6a6IqC54K55aKe5YqgY2xhc3MKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBhZGRDbGFzczogZnVuY3Rpb24oZWwsIG5hbWUpIHsKICAgICAgICAgICAgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICBuYW1lID0gbmFtZSB8fCBudWxsOwogICAgICAgICAgICBpZighbmFtZSkgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHZhciBjbGFzc0xpc3QgPSBlbC5jbGFzc0xpc3Q7CiAgICAgICAgICAgIGlmKCEhY2xhc3NMaXN0KSB7CiAgICAgICAgICAgICAgICBpZighY2xhc3NMaXN0LmNvbnRhaW5zKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LmFkZChuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmKCFvLmRvbS5oYXNDbGFzcyhlbCwgbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBlbC5jbGFzc05hbWUgKz0gKGVsLmNsYXNzTmFtZSA/ICIgIiA6ICIiKSArIG5hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20ucmVtb3ZlQ2xhc3MKICAgICAgICAgKiBAZGVzYyDliKDpmaTmjIflrproioLngrnnmoTmjIflrppjbGFzcwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbihlbCwgbmFtZSkgewogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIHZhciBuYW1lcywKICAgICAgICAgICAgICAgIGNsYXNzTGlzdCA9IGVsLmNsYXNzTGlzdDsKICAgICAgICAgICAgaWYoISFjbGFzc0xpc3QpIHsKICAgICAgICAgICAgICAgIGlmKGNsYXNzTGlzdC5jb250YWlucyhuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUobmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZihvLmRvbS5oYXNDbGFzcyhlbCwgbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBuYW1lcyA9IGVsLmNsYXNzTmFtZTsKICAgICAgICAgICAgICAgICAgICBpZihuYW1lcykgewogICAgICAgICAgICAgICAgICAgICAgICBlbC5jbGFzc05hbWUgPSB1LnRyaW0obmFtZXMpLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgUmVnRXhwKCIoXnxcXHMrKSIgKyBuYW1lICsgIihcXHMrfCQpIiksICIgIgogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS50b2dnbGVDbGFzcwogICAgICAgICAqIEBkZXNjIHRvZ2dsZeaMh+WumuiKgueCueeahOaMh+Wumuagt+W8jwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudCB8IFN0cmluZ30g5oyH5a6a6IqC54K5CiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30g5oyH5a6a5qC35byPCiAgICAgICAgICovCiAgICAgICAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKGVsLCBuYW1lKSB7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIHQgPSBvLmRvbS5oYXNDbGFzcyhlbCwgbmFtZSk7CiAgICAgICAgICAgIGlmKHQpIHsKICAgICAgICAgICAgICAgIG8uZG9tLnJlbW92ZUNsYXNzKGVsLCBuYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG8uZG9tLmFkZENsYXNzKGVsLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIXQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRXaWR0aAogICAgICAgICAqIEBkZXNjIOiOt+W+l+aMh+WumuiKgueCueeahOWuveW6pgogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBnZXRXaWR0aDogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgdmFyIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIHdpZHRoID0gISFlbC5vZmZzZXRXaWR0aCA/IGVsLm9mZnNldFdpZHRoIDogZWwuY2xpZW50V2lkdGg7CiAgICAgICAgICAgIHJldHVybiB3aWR0aCA+IDAgPyB3aWR0aCA6IDA7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRTY3JlZW5XaWR0aAogICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9CiAgICAgICAgICogQGRlc2Mg6I635b6X5bGP5bmV5a695bqmCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NyZWVuV2lkdGg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZ2V0U2NyZWVuQnkoIldpZHRoIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRTY3JlZW5IZWlnaHQKICAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfQogICAgICAgICAqIEBkZXNjIOiOt+W+l+Wxj+W5lemrmOW6pgogICAgICAgICAqLwogICAgICAgIGdldFNjcmVlbkhlaWdodDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRTY3JlZW5CeSgiSGVpZ2h0Iik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRIZWlnaHQKICAgICAgICAgKiBAZGVzYyDojrflvpfmjIflrproioLngrnpq5jluqYKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZ2V0SGVpZ2h0OiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICB2YXIgaGVpZ2h0ID0gISFlbC5vZmZzZXRIZWlnaHQgPyBlbC5vZmZzZXRIZWlnaHQgOiBlbC5jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgIHJldHVybiBoZWlnaHQgPiAwID8gaGVpZ2h0IDogMDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLmluc2VydEFmdGVyCiAgICAgICAgICogQGRlc2Mg5o+S5Yiw5oyH5a6a6IqC54K55ZCO6Z2iCiAgICAgICAgICogQHBhcmFtIG5ld2RvbSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gdGFyZG9tIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGluc2VydEFmdGVyOiBmdW5jdGlvbihuZXdkb20sIHRhcmRvbSkgewogICAgICAgICAgICBuZXdkb20gPSBvLmcobmV3ZG9tKTsKICAgICAgICAgICAgdGFyZG9tID0gby5nKHRhcmRvbSk7CiAgICAgICAgICAgIHRhcmRvbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShuZXdkb20sIHRhcmRvbS5uZXh0U2libGluZyk7CiAgICAgICAgICAgIHJldHVybiBuZXdkb207CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5pbnNlcnRGaXJzdAogICAgICAgICAqIEBwYXJhbSBlbAogICAgICAgICAqIEBwYXJhbSBjb250YWluZXIKICAgICAgICAgKi8KICAgICAgICBpbnNlcnRGaXJzdDogZnVuY3Rpb24oZWwsIGNvbnRhaW5lcikgewogICAgICAgICAgICB2YXIgZWwgPSBvLmcoZWwpLAogICAgICAgICAgICAgICAgY29udGFpbmVyID0gby5nKGNvbnRhaW5lciksCiAgICAgICAgICAgICAgICBmaXJzdENoaWxkID0gY29udGFpbmVyLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIGlmKCFmaXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmluc2VydEJlZm9yZShlbCwgZmlyc3RDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLnNldFN0eWxlcwogICAgICAgICAqIEBkZXNjIOaJuemHj+i1i+WAvAogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gb2JqIHtPYmplY3R9CiAgICAgICAgICogQHBhcmFtIGlzaW5pdCB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBzZXRTdHlsZXM6IGZ1bmN0aW9uKGVsLCBvYmosIGlzaW5pdCkgewogICAgICAgICAgICBpc2luaXQgPSBpc2luaXQgfHwgZmFsc2U7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgaWYoaXNpbml0KSB7CiAgICAgICAgICAgICAgICB2YXIgY3NzVGV4dCA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvcih2YXIgayBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGlmKCFpc2luaXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2sgPSBrOwogICAgICAgICAgICAgICAgICAgIGlmKGsubWF0Y2goL14tKHdlYmtpdHxvfG1zfG1veikvZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2sgID0gdS5zdHlsZUNzcyhrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGVbX2tdID0gb2JqW2tdOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3NzVGV4dCArPSBrICsgIjogIiArIG9ialtrXSArICI7IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighIWNzc1RleHQpIHsKICAgICAgICAgICAgICAgIGVsLnN0eWxlLmNzc1RleHQgPSBjc3NUZXh0OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRTdHlsZQogICAgICAgICAqIEBkZXNjIOiOt+WPluaMh+WumuiKgueCueeahOaMh+WumuWxnuaAp+WAvAogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gc3R5bGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBnZXRTdHlsZTogZnVuY3Rpb24oZWwsIHN0eWxlKSB7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gbnVsbDsKICAgICAgICAgICAgaWYgKGVsICYmIGVsLnN0eWxlKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGVsLnN0eWxlW3UuY2FtZWxpemUoc3R5bGUpXTsKICAgICAgICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jLmRlZmF1bHRWaWV3ICYmCiAgICAgICAgICAgICAgICAgICAgICAgIGRvYy5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjc3MgPSBkb2MuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gY3NzID8gY3NzLmdldFByb3BlcnR5VmFsdWUoc3R5bGUpIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVsLmN1cnJlbnRTdHlsZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGVsLmN1cnJlbnRTdHlsZVt1LmNhbWVsaXplKHN0eWxlKV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9ucyA9IFsnbGVmdCcsICd0b3AnLCAncmlnaHQnLCAnYm90dG9tJ107CiAgICAgICAgICAgICAgICBpZiAod2luZG93Lm9wZXJhICYmCiAgICAgICAgICAgICAgICAgICAgKHBvc2l0aW9ucy5pbmRleE9mKHN0eWxlKSAhPSAtMSkgJiYKICAgICAgICAgICAgICAgICAgICAoby5kb20uZ2V0U3R5bGUoZWwsICdwb3NpdGlvbicpID09ICdzdGF0aWMnKSkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSAnYXV0bycgPyBudWxsIDogdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRQYXJlbnROb2RlCiAgICAgICAgICogQGRlc2Mg5p+l6K+i56ym5ZCI5p2h5Lu255qE56a75oyH5a6a6IqC54K55pyA6L+R55qE54i26IqC54K5CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FTGVtZW50IHwgU3RyaW5nfSDooqvmn6Xmib7nmoTotbflp4voioLngrkKICAgICAgICAgKiBAcGFyYW0gZmlsdGVyIHtTdHJpbmd9IOetm+mAieWZqAogICAgICAgICAqIEBwYXJhbSBtYXhEZXB0aCB7TnVtYmVyfSDmn6XnnIvnmoTmnIDmt7HlsYLmlbAKICAgICAgICAgKi8KICAgICAgICBnZXRQYXJlbnROb2RlOiBmdW5jdGlvbihlbCwgZmlsdGVyLCBtYXhEZXB0aCkgewogICAgICAgICAgICB2YXIgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICBtYXhEZXB0aCA9IG1heERlcHRoIHx8IDUwOwogICAgICAgICAgICB2YXIgZGVwdGggPSAwLAogICAgICAgICAgICAgICAgX2VsID0gbnVsbDsKICAgICAgICAgICAgZWwgPSBlbC5wYXJlbnROb2RlOwogICAgICAgICAgICB3aGlsZSh1LmlzTm9kZShlbCkgJiYgKGRlcHRoIDwgbWF4RGVwdGgpKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gZWwucGFyZW50Tm9kZSwKICAgICAgICAgICAgICAgICAgICBsaXN0ID0gcGFyZW50LnF1ZXJ5U2VsZWN0b3JBbGwoZmlsdGVyKTsKICAgICAgICAgICAgICAgIGlmKGxpc3QgJiYgbGlzdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdS5lYWNoKGxpc3QsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodS5pc05vZGUoaXRlbSkgJiYgaXRlbSA9PSBlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2VsID0gaXRlbTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbCA9IGVsLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICBpZihfZWwgfHwgZWwudGFnTmFtZSA9PSAiSFRNTCIpCWJyZWFrOwogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2VsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uZ2V0UG9zaXRpb24KICAgICAgICAgKiBAZGVzYyDojrflvpflhYPntKDnm7jlr7nkuo7mtY/op4jlmajlt6bkuIrop5LnmoTlnZDmoIcKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZ2V0UG9zaXRpb246IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIGRvYyA9ICEhZWwub3duZXJEb2N1bWVudCA/IGVsLm93bmVyRG9jdW1lbnQgOiBlbCwKICAgICAgICAgICAgICAgIGdldFN0eWxlID0gby5kb20uZ2V0U3R5bGUsCiAgICAgICAgICAgICAgICBwb3MgPSB7ImxlZnQiOiAwLCAidG9wIjogMH0sCiAgICAgICAgICAgICAgICB2aWV3cG9ydCA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCiAgICAgICAgICAgICAgICBwYXJlbnQgPSBlbDsKICAgICAgICAgICAgaWYoZWwgPT0gdmlld3BvcnQpewogICAgICAgICAgICAgICAgcmV0dXJuIHBvczsKICAgICAgICAgICAgfQogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBwb3MubGVmdCArPSBwYXJlbnQub2Zmc2V0TGVmdDsKICAgICAgICAgICAgICAgIHBvcy50b3AgICs9IHBhcmVudC5vZmZzZXRUb3A7CiAgICAgICAgICAgICAgICBpZiAoZ2V0U3R5bGUocGFyZW50LCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgcG9zLmxlZnQgKz0gZG9jLmJvZHkuc2Nyb2xsTGVmdDsKICAgICAgICAgICAgICAgICAgICBwb3MudG9wICArPSBkb2MuYm9keS5zY3JvbGxUb3A7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICAgICAgICB9IHdoaWxlIChwYXJlbnQgJiYgcGFyZW50ICE9IGVsKTsKICAgICAgICAgICAgaWYoZ2V0U3R5bGUoZWwsICdwb3NpdGlvbicpID09ICdhYnNvbHV0ZScpewogICAgICAgICAgICAgICAgcG9zLnRvcCAgLT0gZG9jLmJvZHkub2Zmc2V0VG9wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudCA9IGVsLm9mZnNldFBhcmVudDsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudCAmJiBwYXJlbnQgIT0gZG9jLmJvZHkpIHsKICAgICAgICAgICAgICAgIHBvcy5sZWZ0IC09IHBhcmVudC5zY3JvbGxMZWZ0OwogICAgICAgICAgICAgICAgaWYgKHBhcmVudC50YWdOYW1lICE9ICdUUicpIHsKICAgICAgICAgICAgICAgICAgICBwb3MudG9wIC09IHBhcmVudC5zY3JvbGxUb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwb3M7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5jcmVhdGVEb20KICAgICAgICAgKiBAZGVzYyDliJvlu7pkb23oioLngrkKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSBkb23nsbvlnosKICAgICAgICAgKiBAcGFyYW0gYXR0cyB7T2JqZWN0fSBkb23lsZ7mgKflkI3lgLzlr7kKICAgICAgICAgKiBAcGFyYW0gc3R5cyB7T2JqZWN0fSBkb23moLflvI/lkI3lgLzlr7kKICAgICAgICAgKi8KICAgICAgICBjcmVhdGVEb206IGZ1bmN0aW9uKHR5cGUsIGF0dHMsIHN0eXMpIHsKICAgICAgICAgICAgdmFyIGRvbSA9IGRvYy5jcmVhdGVFbGVtZW50KHR5cGUpOwogICAgICAgICAgICBhdHRzICYmIHUuZWFjaChhdHRzLCBmdW5jdGlvbih2LCBhdHQpIHsKICAgICAgICAgICAgICAgIGlmKGF0dCA9PSAiaW5uZXJIVE1MIiB8fCBhdHQgPT0gImlubmVyVGV4dCIpIHsKICAgICAgICAgICAgICAgICAgICBkb21bYXR0XSA9IG8udXRpbC5lbmNvZGVIdG1sKHYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkb20uc2V0QXR0cmlidXRlKGF0dCwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzdHlzICYmIG8uZG9tLnNldFN0eWxlcyhkb20sIHN0eXMsIHRydWUpOwogICAgICAgICAgICByZXR1cm4gZG9tOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uY2xvbmVOb2RlCiAgICAgICAgICogQGRlc2MgY2xvbmXoioLngrkg5Y+v5Lul5bCG5LqL5Lu25LiA6LW3Y2xvbmUg6K+l5LqL5Lu25b+F6aG75piv6YCa6L+H5q2k5qGG5p625Yqg5LiK55qECiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fSDlvoVjbG9uZeeahOiKgueCuQogICAgICAgICAqIEBwYXJhbSBldiB7Qm9vbGVhbn0g5piv5ZCmY2xvbmXkuovku7bnm5HlkKwKICAgICAgICAgKiBAcGFyYW0gYyB7Qm9vbGVhbn0g5piv5ZCm5ou36LSd5a2Q6IqC54K5CiAgICAgICAgICovCiAgICAgICAgY2xvbmVOb2RlOiBmdW5jdGlvbihlbCwgZXYsIGMpIHsKICAgICAgICAgICAgZXYgPSBldiB8fCBmYWxzZTsKICAgICAgICAgICAgYyA9IGMgfHwgZmFsc2U7CiAgICAgICAgICAgIHZhciBjbG9uZUVsID0gby5nKGVsKS5jbG9uZU5vZGUoIWMpOwogICAgICAgICAgICBpZighZXYgfHwgIWVsLl9ldmVudENhY2hlSUQpIHJldHVybiBjbG9uZUVsOwogICAgICAgICAgICB2YXIgb2JzID0gby5ldmVudC5vYnNlcnZlcnNbZWwuX2V2ZW50Q2FjaGVJRF07CiAgICAgICAgICAgIHUuZWFjaChvYnMsIGZ1bmN0aW9uKGl0ZW0sIGkpIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lID0gaXRlbS5uYW1lLAogICAgICAgICAgICAgICAgICAgIG9ic2VydmVyID0gdS5jbG9uZShpdGVtLm9ic2VydmVyKSwKICAgICAgICAgICAgICAgICAgICB1c2VDYXB0dXJlID0gdS5jbG9uZShpdGVtLnVzZUNhcHR1cmUpOwogICAgICAgICAgICAgICAgby5ldmVudC5vbihjbG9uZUVsLCBuYW1lLCBvYnNlcnZlciwgdXNlQ2FwdHVyZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gY2xvbmVFbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLnNjcm9sbExpdGUKICAgICAgICAgKiBAZGVzYyDpkojlr7lpb3Porr7lpIfmu5rliqjmnaHmu5rliqjml7bkuovku7bkvKDmkq3mlrnlkJHlr7zoh7TnmoTmu5rliqjlvILluLjop6PlhrMKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9IOa7muWKqOeahOiKgueCuQogICAgICAgICAqIEBwYXJhbSBpc0hvcml6b24ge0Jvb2xlYW59IOaYr+WQpuaoquWQkQogICAgICAgICAqIEBwYXJhbSBwcmV2ZW50RnJvbSB7RE9NRWxlbWVudH0g5byV6LW3YnVn55qE5qC55rqQ5a655ZmoIOWPr+S4jeS8oAogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgc2Nyb2xsTGl0ZTogZnVuY3Rpb24oZWwsIGlzSG9yaXpvbiwgcHJldmVudEZyb20pIHsKICAgICAgICAgICAgdmFyIHBvcyA9IHsgbGVmdDogMCwgdG9wOiAwIH07CiAgICAgICAgICAgIGlmKHByZXZlbnRGcm9tKSB7CiAgICAgICAgICAgICAgICBwcmV2ZW50RnJvbSA9IG8uZyhwcmV2ZW50RnJvbSk7CiAgICAgICAgICAgICAgICBvLmV2ZW50Lm9uKHByZXZlbnRGcm9tLCAidG91Y2htb3ZlIiwgZnVuY3Rpb24oZSkgeyBvLmV2ZW50LnN0b3AoZSwgdHJ1ZSk7IH0sIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIG8uZG9tLnNldFN0eWxlcyhlbCwgewogICAgICAgICAgICAgICAgIi13ZWJraXQtb3ZlcmZsb3ctc2Nyb2xsaW5nIjogInRvdWNoIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgby5ldmVudC5vbihlbCwgInRvdWNoc3RhcnQiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgdG91Y2hlcyA9IGUudG91Y2hlczsKICAgICAgICAgICAgICAgIGlmKCF0b3VjaGVzKSAgICByZXR1cm47CiAgICAgICAgICAgICAgICBwb3MgPSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdDogdG91Y2hlc1swXS5wYWdlWCwKICAgICAgICAgICAgICAgICAgICB0b3A6IHRvdWNoZXNbMF0ucGFnZVkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIG8uZXZlbnQub24oZWwsICJ0b3VjaG1vdmUiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgdG91Y2hlcyA9IGUudG91Y2hlczsKICAgICAgICAgICAgICAgIGlmKCF0b3VjaGVzKSAgICByZXR1cm47CiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS5jdXJyZW50VGFyZ2V0LAogICAgICAgICAgICAgICAgICAgIHNjcm9sbFRvcCA9IHRhcmdldC5zY3JvbGxUb3AsCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsTGVmdCA9IHRhcmdldC5zY3JvbGxMZWZ0LAogICAgICAgICAgICAgICAgICAgIG1vdmVMZWZ0ID0gdG91Y2hlc1swXS5wYWdlWCwKICAgICAgICAgICAgICAgICAgICBtb3ZlVG9wID0gdG91Y2hlc1swXS5wYWdlWSwKICAgICAgICAgICAgICAgICAgICBzdGFydFRvcCA9IHBvcy50b3AsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRMZWZ0ID0gcG9zLmxlZnQ7CiAgICAgICAgICAgICAgICBpZihpc0hvcml6b24pIHsKICAgICAgICAgICAgICAgICAgICBpZigoc2Nyb2xsTGVmdCA8PSAwICYmIG1vdmVMZWZ0ID4gc3RhcnRMZWZ0KSB8fAogICAgICAgICAgICAgICAgICAgICAgICAoc2Nyb2xsTGVmdCA+PSB0YXJnZXQuc2Nyb2xsV2lkdGggLSB0YXJnZXQuY2xpZW50V2lkdGggLSA1ICYmIG1vdmVMZWZ0IDwgc3RhcnRMZWZ0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYoKHNjcm9sbFRvcCA8PSAwICYmIG1vdmVUb3AgPiBzdGFydFRvcCkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHNjcm9sbFRvcCA+PSB0YXJnZXQuc2Nyb2xsSGVpZ2h0IC0gdGFyZ2V0LmNsaWVudEhlaWdodCAtIDUgJiYgbW92ZVRvcCA8IHN0YXJ0VG9wKSkgewogICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLmRhdGEKICAgICAgICAgKiBAZGVzYyDor7vlj5bmiJborr7nva7mjIflrproioLngrnnmoTmlbDmja4KICAgICAgICAgKiBAcGFyYW0gZWwge1N0cmluZyB8IERPTUVMZW1lbnR9CiAgICAgICAgICogQHBhcmFtIGF0dHJzIHtTdHJpbmcgfCBBcnJheX0KICAgICAgICAgKi8KICAgICAgICBkYXRhOiBmdW5jdGlvbihlbCwgYXR0cnMpIHsKICAgICAgICAgICAgdmFyIHZzID0ge307CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgaWYodS5pc1N0cmluZyhhdHRycykpIHsKICAgICAgICAgICAgICAgIHZhciBhcnMgPSBhdHRycy5zcGxpdCgiICIpLAogICAgICAgICAgICAgICAgICAgIGxlbiA9IGFycy5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZihsZW4gPT0gMSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbC5kYXRhc2V0ICYmIGVsLmRhdGFzZXRbYXJzWzBdXSB8fCBlbC5nZXRBdHRyaWJ1dGUoImRhdGEtIiArIGFyc1swXSkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdS5lYWNoKGFycywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2l0ZW0gPSB1LmNhbWVsaXplKGl0ZW0pOwogICAgICAgICAgICAgICAgICAgICAgICB2c1tpdGVtXSA9IGVsLmRhdGFzZXQgJiYgZWwuZGF0YXNldFtfaXRlbV0gfHwgZWwuZ2V0QXR0cmlidXRlKCJkYXRhLSIgKyBpdGVtKSB8fCBudWxsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdnMgPSBhdHRyczsKICAgICAgICAgICAgICAgIGZvcih2YXIgayBpbiB2cykgewogICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgiZGF0YS0iICsgaywgdnNba10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2czsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5hdHRyCiAgICAgICAgICogQGRlc2Mg6K+75Y+W5oiW6K6+572u5oyH5a6a6IqC54K555qE5bGe5oCnCiAgICAgICAgICovCiAgICAgICAgYXR0cjogZnVuY3Rpb24oZWwsIGF0dHJzKSB7CiAgICAgICAgICAgIHZhciB2cyA9IHt9OwogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIGlmKHUuaXNTdHJpbmcoYXR0cnMpKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJzID0gYXR0cnMuc3BsaXQoIiAiKSwKICAgICAgICAgICAgICAgICAgICBsZW4gPSBhcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYobGVuID09IDEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuZ2V0QXR0cmlidXRlKGFyc1swXSkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdS5lYWNoKGFycywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICB2c1tpdGVtXSA9IGVsLmdldEF0dHJpYnV0ZShpdGVtKSB8fCBudWxsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdnMgPSBhdHRyczsKICAgICAgICAgICAgICAgIGZvcih2YXIgayBpbiB2cykgewogICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZShrLCB2c1trXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZzOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAZGVzYyDlsIbluLjnlKjnmoTpgInmi6nlmajmlrnms5XnmoTlkb3lkI3nqbrpl7Tmj5DliY0KICAgICAqLwogICAgby5nID0gby5kb20uZzsKCiAgICBvLiQgPSBvLmRvbS4kOwoKICAgIG8ub25lID0gby5kb20ub25lOwoKICAgICF3aW5kb3cuJCAmJiAod2luZG93LiQgPSBvLiQpOwoKfSkob2N0b3B1cyk7Ci8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICog5LqL5Lu26YOo5YiGIO+8jSAgIGV2ZW50CiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICog5a6a5LmJ5bqT5YaF5LqL5Lu25pSv5pKRCiAgICAgKiBAbmFtZXNwYWNlIG9jdG9wdXMuZXZlbnQKICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgKi8KICAgIG8uZXZlbnQgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvYnNlcnZlcnMKICAgICAgICAgKiBAZGVzYyDkuIDkuKrnvJPlrZjkuovku7bnm5HlkKznmoRoYXNo6KGoCiAgICAgICAgICogQHR5cGUge29iamVjdH0KICAgICAgICAgKi8KICAgICAgICBvYnNlcnZlcnM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5lbGVtZW50CiAgICAgICAgICogQGRlc2Mg6L+U5Zue5LqL5Lu255qE6IqC54K5CiAgICAgICAgICogQHBhcmFtIGV2ZW50IHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICogQHJldHVybiDop6blj5Hkuovku7bnmoToioLngrkge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZWxlbWVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc1NpbmdsZVRvdWNoCiAgICAgICAgICogQGRlc2Mg5Yik5pat5piv5ZCm5Y2V54K5CiAgICAgICAgICogQHBhcmFtIGV2ZW50IHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc1NpbmdsZVRvdWNoOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gZXZlbnQudG91Y2hlcyAmJiBldmVudC50b3VjaGVzLmxlbmd0aCA9PSAxOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc011bHRpVG91Y2gKICAgICAgICAgKiBAZGVzYyDliKTmlq3mmK/lkKblpJrngrkKICAgICAgICAgKiBAcGFyYW0gZXZlbnQge3dpbmRvdy5ldmVudH0KICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzTXVsdGlUb3VjaDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRvdWNoZXMgJiYgZXZlbnQudG91Y2hlcy5sZW5ndGggPiAxOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc0xlZnRDbGljawogICAgICAgICAqIEBkZXNjIOWIpOaWreaYr+WQpuaYr+W3pumUrueCueWHuwogICAgICAgICAqIEBwYXJhbSBldmVudCB7d2luZG93LmV2ZW50fQogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNMZWZ0Q2xpY2s6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAhISgoKGV2ZW50LndoaWNoKSAmJiAoZXZlbnQud2hpY2ggPT0gMSkpIHx8CiAgICAgICAgICAgICAgICAoKGV2ZW50LmJ1dHRvbikgJiYgKGV2ZW50LmJ1dHRvbiA9PSAxKSkpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc1JpZ2h0Q2xpY2sKICAgICAgICAgKiBAZGVzYyDliKTmlq3mmK/lkKblj7PplK7ngrnlh7sKICAgICAgICAgKiBAcGFyYW0gZXZlbnQge3dpbmRvdy5ldmVudH0KICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzUmlnaHRDbGljazogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuICEhKCgoZXZlbnQud2hpY2gpICYmIChldmVudC53aGljaCA9PSAzKSkgfHwKICAgICAgICAgICAgICAgICgoZXZlbnQuYnV0dG9uKSAmJiAoZXZlbnQuYnV0dG9uID09IDIpKSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LnN0b3AKICAgICAgICAgKiBAZGVzYyDmiorkuovku7blgZzkuoYKICAgICAgICAgKiBAcGFyYW0gZXZlbnQge3dpbmRvdy5ldmVudH0KICAgICAgICAgKiBAcGFyYW0gYWxsb3dEZWZhdWx0IHtCb29sZWFufSAtICAg5piv5ZCm5oqK6buY6K6k5ZON5bqU5YGc5LqGCiAgICAgICAgICovCiAgICAgICAgc3RvcDogZnVuY3Rpb24oZXZlbnQsIGFsbG93RGVmYXVsdCkgewogICAgICAgICAgICBpZiAoIWFsbG93RGVmYXVsdCkgewogICAgICAgICAgICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LmZpbmRFbGVtZW50CiAgICAgICAgICogQGRlc2Mg5om+5Yiw6Kem5Y+R5LqL5Lu255qE6IqC54K5CiAgICAgICAgICogQHBhcmFtIGV2ZW50IHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICogQHJldHVybiB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBmaW5kRWxlbWVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBvLmV2ZW50LmVsZW1lbnQoZXZlbnQpOwogICAgICAgICAgICB3aGlsZSAoZWxlbWVudC5wYXJlbnROb2RlICYmICghZWxlbWVudC50YWdOYW1lIHx8CiAgICAgICAgICAgICAgICAoZWxlbWVudC50YWdOYW1lLnRvVXBwZXJDYXNlKCkgIT0gdGFnTmFtZS50b1VwcGVyQ2FzZSgpKSkpewogICAgICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZXZlbnQub24KICAgICAgICAgKiBAZGVzYyDnm5HlkKzkuovku7YKICAgICAgICAgKiBAcGFyYW0gZG9tIHtTdHJpbmcgfCBET01FbGVtZW50fQogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZuIHtGdW5jdGlvbn0KICAgICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24oZG9tLCBuYW1lLCBmbiwgdXNlQ2FwdHVyZSkgewogICAgICAgICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KCIgIiksCiAgICAgICAgICAgICAgICBsZW4gPSBuYW1lcy5sZW5ndGgsCiAgICAgICAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgICBpZihsZW4gPT0gMCkgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB2YXIgZWxlbWVudCA9IG8uZyhkb20pLAogICAgICAgICAgICAgICAgdGhhdCA9IG8uZXZlbnQ7CiAgICAgICAgICAgIHVzZUNhcHR1cmUgPSB1c2VDYXB0dXJlIHx8IGZhbHNlOwogICAgICAgICAgICBpZighdGhhdC5vYnNlcnZlcnMpIHsKICAgICAgICAgICAgICAgIHRoYXQub2JzZXJ2ZXJzID0ge307CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIWVsZW1lbnQuX2V2ZW50Q2FjaGVJRCkgewogICAgICAgICAgICAgICAgdmFyIGlkUHJlZml4ID0gImV2ZW50Q2FjaGVJRF8iOwogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuaWQpIHsKICAgICAgICAgICAgICAgICAgICBpZFByZWZpeCA9IGVsZW1lbnQuaWQgKyAiXyIgKyBpZFByZWZpeDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsZW1lbnQuX2V2ZW50Q2FjaGVJRCA9IG8udXRpbC5jcmVhdGVVbmlxdWVJRChpZFByZWZpeCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yKDsgaS0tOyApIHsKICAgICAgICAgICAgICAgIHRoYXQuX29uKGVsZW1lbnQsIG5hbWVzW2ldLCBmbiwgdXNlQ2FwdHVyZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZXZlbnQuX29uCiAgICAgICAgICogQGRlc2Mg55uR5ZCs5LqL5Lu2CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZuIHtGdW5jdGlvbn0KICAgICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBfb246IGZ1bmN0aW9uKGVsLCBuYW1lLCBmbiwgdXNlQ2FwdHVyZSkgewogICAgICAgICAgICBpZihuYW1lID09ICJvcnRjaGFuZ2UiKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gIm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cgPyAib3JpZW50YXRpb25jaGFuZ2UiIDogInJlc2l6ZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobmFtZSA9PSAicmVhZHkiKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gIkRPTUNvbnRlbnRMb2FkZWQiOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY2FjaGVJRCA9IGVsLl9ldmVudENhY2hlSUQsCiAgICAgICAgICAgICAgICB0aGF0ID0gby5ldmVudDsKICAgICAgICAgICAgaWYoIXRoYXQub2JzZXJ2ZXJzW2NhY2hlSURdKSB7CiAgICAgICAgICAgICAgICB0aGF0Lm9ic2VydmVyc1tjYWNoZUlEXSA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoYXQub2JzZXJ2ZXJzW2NhY2hlSURdLnB1c2goewogICAgICAgICAgICAgICAgJ2VsZW1lbnQnOiBlbCwKICAgICAgICAgICAgICAgICduYW1lJzogbmFtZSwKICAgICAgICAgICAgICAgICdvYnNlcnZlcic6IGZuLAogICAgICAgICAgICAgICAgJ3VzZUNhcHR1cmUnOiB1c2VDYXB0dXJlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihlbC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKG5hbWUsIGZuLCB1c2VDYXB0dXJlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlbC5hdHRhY2hFdmVudCkgewogICAgICAgICAgICAgICAgZWwuYXR0YWNoRXZlbnQoJ29uJyArIG5hbWUsIGZuKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5zdG9wT2JzZXJ2aW5nRWxlbWVudAogICAgICAgICAqIEBkZXNjIOaKiuaMh+WumuiKgueCueeahOaJgOacieS6i+S7tuebkeWQrOWBnOaOiQogICAgICAgICAqIEBwYXJhbSBkb20ge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgc3RvcE9ic2VydmluZ0VsZW1lbnQ6IGZ1bmN0aW9uKGRvbSkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IG8uZyhkb20pOwogICAgICAgICAgICB2YXIgY2FjaGVJRCA9IGVsZW1lbnQuX2V2ZW50Q2FjaGVJRDsKICAgICAgICAgICAgdGhpcy5fcmVtb3ZlRWxlbWVudE9ic2VydmVycyhvLmV2ZW50Lm9ic2VydmVyc1tjYWNoZUlEXSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LnN0b3BFdmVudE9ic2VydmVyCiAgICAgICAgICogQHBhcmFtIGRvbSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gZXZlbnQge1N0cmluZ30g5oyH5a6a5YGc5o6J55qE5LqL5Lu257G75Z6LCiAgICAgICAgICogQGRlc2Mg5q2k5pa55rOV5Lya5bCG5oyH5a6a6IqC54K55LiK55qE5oyH5a6a5pa55rOV55qE5omA5pyJ5LqL5Lu255uR5ZCs5YGc5o6JIOaFjueUqAogICAgICAgICAqLwogICAgICAgIHN0b3BFdmVudE9ic2VydmVyOiBmdW5jdGlvbihkb20sIGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBjYWNoZUlEID0gby5nKGRvbSkuX2V2ZW50Q2FjaGVJRCwKICAgICAgICAgICAgICAgIHRoYXQgPSBvLmV2ZW50LAogICAgICAgICAgICAgICAgZWxlbWVudE9ic2VydmVycyA9IHRoYXQub2JzZXJ2ZXJzW2NhY2hlSURdOwogICAgICAgICAgICBpZiAoZWxlbWVudE9ic2VydmVycykgewogICAgICAgICAgICAgICAgdmFyIGkgPSBlbGVtZW50T2JzZXJ2ZXJzLmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvcig7IGktLTsgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5ID0gZWxlbWVudE9ic2VydmVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZihldmVudCA9PSBlbnRyeS5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGVudHJ5LmVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkub2JzZXJ2ZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS51c2VDYXB0dXJlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC51bi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgX3JlbW92ZUVsZW1lbnRPYnNlcnZlcnMKICAgICAgICAgKiBAZGVzY+WFt+S9k+WBmuS6i+aDheeahOaWueazlQogICAgICAgICAqIEBwYXJhbSBlbGVtZW50T2JzZXJ2ZXJzIHtBcnJheX0g5LiA5aCG5LqL5Lu257yT5a2Y5a+56LGhCiAgICAgICAgICovCiAgICAgICAgX3JlbW92ZUVsZW1lbnRPYnNlcnZlcnM6IGZ1bmN0aW9uKGVsZW1lbnRPYnNlcnZlcnMpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnRPYnNlcnZlcnMpIHsKICAgICAgICAgICAgICAgIHZhciBpID0gIGVsZW1lbnRPYnNlcnZlcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yKCA7IGktLTsgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5ID0gZWxlbWVudE9ic2VydmVyc1tpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IG5ldyBBcnJheShlbnRyeS5lbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5vYnNlcnZlciwKICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkudXNlQ2FwdHVyZSk7CiAgICAgICAgICAgICAgICAgICAgby5ldmVudC51bi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC51bgogICAgICAgICAqIEBkZXNjIOWNleWIoOS4gOS4quaMh+WumuS6i+S7tuebkeWQrAogICAgICAgICAqIEBwYXJhbSBkb20ge1N0cmluZyB8IERPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZm4ge0Z1bmN0aW9ufQogICAgICAgICAqIEBwYXJhbSB1c2VDYXB0dXJlIHtCb29sZWFufQogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IOi/lOWbnuino+mZpOebkeWQrOaYr+WQpuaIkOWKnwogICAgICAgICAqLwogICAgICAgIHVuOiBmdW5jdGlvbihkb20sIG5hbWUsIGZuLCB1c2VDYXB0dXJlKSB7CiAgICAgICAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoIiAiKSwKICAgICAgICAgICAgICAgIGxlbiA9IG5hbWVzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGkgPSBsZW47CiAgICAgICAgICAgIGlmKGxlbiA9PSAwKSAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gby5nKGRvbSksCiAgICAgICAgICAgICAgICBjYWNoZUlEID0gZWxlbWVudC5fZXZlbnRDYWNoZUlELAogICAgICAgICAgICAgICAgZm91bmRFbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB1c2VDYXB0dXJlID0gdXNlQ2FwdHVyZSB8fCBmYWxzZTsKICAgICAgICAgICAgZm9yKDsgaS0tOyApIHsKICAgICAgICAgICAgICAgIGZvdW5kRW50cnkgPSBvLmV2ZW50Ll91bihlbGVtZW50LCBuYW1lc1tpXSwgZm4sIHVzZUNhcHR1cmUsIGNhY2hlSUQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmb3VuZEVudHJ5OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LnVuCiAgICAgICAgICogQGRlc2Mg5Y2V5Yig5LiA5Liq5oyH5a6a5LqL5Lu255uR5ZCsCiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZuIHtGdW5jdGlvbn0KICAgICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufSDov5Tlm57op6PpmaTnm5HlkKzmmK/lkKbmiJDlip8KICAgICAgICAgKi8KICAgICAgICBfdW46IGZ1bmN0aW9uKGVsLCBuYW1lLCBmbiwgdXNlQ2FwdHVyZSwgaWQpIHsKICAgICAgICAgICAgaWYobmFtZSA9PSAib3J0Y2hhbmdlIikgewogICAgICAgICAgICAgICAgbmFtZSA9ICJvcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93ID8gIm9yaWVudGF0aW9uY2hhbmdlIiA6ICJyZXNpemUiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG5hbWUgPT0gInJlYWR5IikgewogICAgICAgICAgICAgICAgbmFtZSA9ICJET01Db250ZW50TG9hZGVkIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihuYW1lID09ICdrZXlwcmVzcycpIHsKICAgICAgICAgICAgICAgIGlmICggbmF2aWdhdG9yLmFwcFZlcnNpb24ubWF0Y2goL0tvbnF1ZXJvcnxTYWZhcml8S0hUTUwvKSB8fAogICAgICAgICAgICAgICAgICAgIGVsLmRldGFjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgbmFtZSA9ICdrZXlkb3duJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZm91bmRFbnRyeSA9IGZhbHNlLAogICAgICAgICAgICAgICAgZWxlbWVudE9ic2VydmVycyA9IG8uZXZlbnQub2JzZXJ2ZXJzW2lkXTsKICAgICAgICAgICAgaWYgKGVsZW1lbnRPYnNlcnZlcnMpIHsKICAgICAgICAgICAgICAgIHZhciBpPTA7CiAgICAgICAgICAgICAgICB3aGlsZSghZm91bmRFbnRyeSAmJiBpIDwgZWxlbWVudE9ic2VydmVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2FjaGVFbnRyeSA9IGVsZW1lbnRPYnNlcnZlcnNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYgKChjYWNoZUVudHJ5Lm5hbWUgPT0gbmFtZSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKGNhY2hlRW50cnkub2JzZXJ2ZXIgPT0gZm4pICYmCiAgICAgICAgICAgICAgICAgICAgICAgIChjYWNoZUVudHJ5LnVzZUNhcHR1cmUgPT0gdXNlQ2FwdHVyZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudE9ic2VydmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50T2JzZXJ2ZXJzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvLmV2ZW50Lm9ic2VydmVyc1tpZF0gPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kRW50cnkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmb3VuZEVudHJ5KSB7CiAgICAgICAgICAgICAgICBpZiAoZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAgICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIobmFtZSwgZm4sIHVzZUNhcHR1cmUpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbCAmJiBlbC5kZXRhY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgIGVsLmRldGFjaEV2ZW50KCdvbicgKyBuYW1lLCBmbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZvdW5kRW50cnk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IHVubG9hZENhY2hlCiAgICAgICAgICogQGRlc2Mg6aG16Z2i6ZSA5q+B55qE5pe25YCZ5biM5pyb5Y+v5Lul6YeK5pS+5o6J5omA5pyJ55uR5ZCsCiAgICAgICAgICovCiAgICAgICAgdW5sb2FkQ2FjaGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoby5ldmVudCAmJiBvLmV2ZW50Lm9ic2VydmVycykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgY2FjaGVJRCBpbiBvLmV2ZW50Lm9ic2VydmVycykgewogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtZW50T2JzZXJ2ZXJzID0gby5ldmVudC5vYnNlcnZlcnNbY2FjaGVJRF07CiAgICAgICAgICAgICAgICAgICAgby5ldmVudC5fcmVtb3ZlRWxlbWVudE9ic2VydmVycy5hcHBseSh0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBbZWxlbWVudE9ic2VydmVyc10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgby5ldmVudC5vYnNlcnZlcnMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgby5ldmVudC5vbih3aW5kb3csICJ1bmxvYWQiLCBvLmV2ZW50LnVubG9hZENhY2hlLCBmYWxzZSk7CgogICAgLyoqCiAgICAgKiBAY2xhc3Mgb2N0b3B1cy5FdmVudHMKICAgICAqIEBkZXNjIOiHquWumuS5ieS6i+S7tuexuwogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fSDop4Llr5/orqLpmIXkuovku7bnmoTlr7nosaEg5b+F6ZyACiAgICAgKiBAcGFyYW0gZWxlbWVudCB7RE9NRWxlbWVudH0g5LiA5Liq5ZON5bqU5rWP6KeI5Zmo5LqL5Lu255qEZG9tIOmdnuW/hemcgCDlpoLmnpzmjIflrprkuobmraTlgLwg5YiZ6KGo56S66KaB5a+56K+l6IqC54K56L+b6KGM5LiA5qyh5oOo57ud5Lq65a+w55qE5bCB6KOFCiAgICAgKiBAcGFyYW0gZmFsbFRocm91Z2gge0Jvb2xlYW59CiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICAgICovCiAgICBvLkV2ZW50cyA9IG8uZGVmaW5lKHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RhbnQgb2N0b3B1cy5FdmVudHMuQlJPV1NFUl9FVkVOVFMKICAgICAgICAgKiBAZGVzYyDluLjop4TnmoTmtY/op4jlmajkuovku7YKICAgICAgICAgKi8KICAgICAgICBCUk9XU0VSX0VWRU5UUzogWwogICAgICAgICAgICAibW91c2VvdmVyIiwgIm1vdXNlb3V0IiwgIm1vdXNlZG93biIsICJtb3VzZXVwIiwgIm1vdXNlbW92ZSIsCiAgICAgICAgICAgICJjbGljayIsICJkYmxjbGljayIsICJyaWdodGNsaWNrIiwgImRibHJpZ2h0Y2xpY2siLAogICAgICAgICAgICAicmVzaXplIiwKICAgICAgICAgICAgImZvY3VzIiwgImJsdXIiLAogICAgICAgICAgICAidG91Y2hzdGFydCIsICJ0b3VjaG1vdmUiLCAidG91Y2hlbmQiLAogICAgICAgICAgICAia2V5ZG93biIKICAgICAgICBdLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBsaXN0ZW5lcnMKICAgICAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICAgICAqIEBkZXNjIOS6i+S7tuebkeWQrOeahGhhc2jooagKICAgICAgICAgKi8KICAgICAgICBsaXN0ZW5lcnM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG9iagogICAgICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgICAgICogQGRlc2Mg5LqL5Lu25a+56LGh5omA5bGe55qE5Li75L2TCiAgICAgICAgICovCiAgICAgICAgb2JqOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIEB0eXBlIHtET01FTGVtZW50fQogICAgICAgICAqIEBkZXNjIOS6i+S7tue7keWumueahOiKgueCuQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBldmVudEhhbmRsZXIKICAgICAgICAgKiBAZGVzYyDnu5HlrprlnKjoioLngrnkuIrnmoTop6blj5Hlh73mlbAKICAgICAgICAgKiBAdHlwZSB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgZXZlbnRIYW5kbGVyOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBmYWxsVGhyb3VnaAogICAgICAgICAqIEBkZXNjIOS6i+S7tuaYr+WQpuWFgeiuuOS8oOaSrQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGZhbGxUaHJvdWdoOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXh0ZW5zaW9ucwogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICogQGRlc2Mg5omA5pyJ6KKr5rOo5YaM55qE5paw55qE6Ieq5a6a5LmJ5LqL5Lu26ZyA6KaB6L+Z5Liq5a6e5L6LCiAgICAgICAgICog6Ieq5a6a5LmJ5LqL5Lu25piv5oyH5LulT3VwZW5nLkV2ZW50cy4q5byA5aS055qE6Ieq5a6a5LmJ5LqL5Lu2CiAgICAgICAgICoga2V55Li66Ieq5a6a5LmJ5LqL5Lu25ZCN5aaCdGFwIHZhbHVl5Li66Ieq5a6a5LmJ5LqL5Lu25aaCT3VwZW5nLkV2ZW50cy5UYXAg5Y+q5piv5Li+5Liq5L6L5a2Q5LiN55So5aSq6K6k55yfCiAgICAgICAgICovCiAgICAgICAgZXh0ZW5zaW9uczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXh0ZW5zaW9uQ291bnQKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqIEBkZXNjIGtleeaYr+iHquWumuS5ieS6i+S7tueahGtleSB2YWx1ZeaYr2hhbmRsZXLnmoTkuKrmlbAKICAgICAgICAgKi8KICAgICAgICBleHRlbnNpb25Db3VudDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3M6IG9jdG9wdXMuRXZlbnRzLmluaXRpYWxpemUKICAgICAgICAgKiBAcGFyYW0gb2JqIHtPYmplY3R9IOinguWvn+iuoumYheS6i+S7tueahOWvueixoSDlv4XpnIAKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9IOS4gOS4quWTjeW6lOa1j+iniOWZqOS6i+S7tueahGRvbSDpnZ7lv4XpnIAg5aaC5p6c5oyH5a6a5LqG5q2k5YC8IOWImeihqOekuuimgeWvueivpeiKgueCuei/m+ihjOS4gOasoeaDqOe7neS6uuWvsOeahOWwgeijhQogICAgICAgICAqIEBwYXJhbSBmYWxsVGhyb3VnaCB7Qm9vbGVhbn0KICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9iaiwgZWwsIGZhbGxUaHJvdWdoLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLm9iaiA9IG9iajsKICAgICAgICAgICAgdGhpcy5mYWxsVGhyb3VnaCA9IGZhbGxUaHJvdWdoOwogICAgICAgICAgICB0aGlzLmxpc3RlbmVycyA9IHt9OwogICAgICAgICAgICB0aGlzLmV4dGVuc2lvbnMgPSB7fTsKICAgICAgICAgICAgdGhpcy5leHRlbnNpb25Db3VudCA9IHt9OwogICAgICAgICAgICBpZiAoZWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5hdHRhY2hUb0VsZW1lbnQoZWwpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy5kZXN0cm95CiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBkZXNjIOWIm+W7uueahOS6i+S7tuWvueixoeiHquaIkeino+iEsQogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZm9yICh2YXIgZSBpbiB0aGlzLmV4dGVuc2lvbnMpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5leHRlbnNpb25zW2VdICE9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV4dGVuc2lvbnNbZV0uZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXh0ZW5zaW9ucyA9IG51bGw7CiAgICAgICAgICAgIGlmICh0aGlzLmVsKSB7CiAgICAgICAgICAgICAgICBvLmV2ZW50LnN0b3BPYnNlcnZpbmdFbGVtZW50KHRoaXMuZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxpc3RlbmVycyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMub2JqID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5mYWxsVGhyb3VnaCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZXZlbnRIYW5kbGVyID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYXR0YWNoVG9FbGVtZW50CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGF0dGFjaFRvRWxlbWVudDogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZWwpIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcE9ic2VydmluZ0VsZW1lbnQodGhpcy5lbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50SGFuZGxlciA9IG8udXRpbC5iaW5kQXNFdmVudExpc3RlbmVyKAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQnJvd3NlckV2ZW50LCB0aGlzCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwgPSBlbDsKICAgICAgICAgICAgdmFyIGkgPSAwLAogICAgICAgICAgICAgICAgbGVuID0gdGhpcy5CUk9XU0VSX0VWRU5UUy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQub24oZWwsIHRoaXMuQlJPV1NFUl9FVkVOVFNbaV0sIHRoaXMuZXZlbnRIYW5kbGVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyDkuI3ljrvmjolpZeS4i+S8mjLmjokKICAgICAgICAgICAgby5ldmVudC5vbihlbCwgImRyYWdzdGFydCIsIG8uZXZlbnQuc3RvcCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGhhbmRsZUJyb3dzZXJFdmVudAogICAgICAgICAqIEBkZXNjIOWcqOaMh+WummRvbeiKgueCueeahOaDheWGteS4iyDlsIHoo4Xor6Vkb23op6blj5HnmoRldmVudOWxnuaApwogICAgICAgICAqLwogICAgICAgIGhhbmRsZUJyb3dzZXJFdmVudDogZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gZXZ0LnR5cGUsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVyc1t0eXBlXTsKICAgICAgICAgICAgaWYoIWxpc3RlbmVycyB8fCBsaXN0ZW5lcnMubGVuZ3RoID09IDApIHJldHVybjsKICAgICAgICAgICAgdmFyIHRvdWNoZXMgPSBldnQudG91Y2hlczsKICAgICAgICAgICAgaWYgKHRvdWNoZXMgJiYgdG91Y2hlc1swXSkgewogICAgICAgICAgICAgICAgdmFyIHggPSAwLAogICAgICAgICAgICAgICAgICAgIHkgPSAwLAogICAgICAgICAgICAgICAgICAgIG51bSA9IHRvdWNoZXMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIHRvdWNoLAogICAgICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBudW07ICsraSkgewogICAgICAgICAgICAgICAgICAgIHRvdWNoID0gdG91Y2hlc1tpXTsKICAgICAgICAgICAgICAgICAgICB4ICs9IHRvdWNoLmNsaWVudFg7CiAgICAgICAgICAgICAgICAgICAgeSArPSB0b3VjaC5jbGllbnRZOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXZ0LmNsaWVudFggPSB4IC8gbnVtOwogICAgICAgICAgICAgICAgZXZ0LmNsaWVudFkgPSB5IC8gbnVtOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudHJpZ2dlckV2ZW50KHR5cGUsIGV2dCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy5vbgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAZGVzYyDmt7vliqDoh6rlrprkuYnkuovku7bnm5HlkKwKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDkuovku7bnsbvlnosKICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IOWbnuiwgwogICAgICAgICAqIEBwYXJhbSBvYmoge09iamVjdH0g5LqL5Lu257uR5a6a55qE5a+56LGhIOm7mOiupOS4unRoaXMub2JqZWN0CiAgICAgICAgICogQHBhcmFtIHByaW9yaXR5IHtCb29sZWFuIHwgT2JqZWN0fSDkuLp0cnVl5pe2IOWwhuWinuWKoOeahOWbnuiwg+aJlOWcqOinpuWPkeWbnuiwg+mYn+WIl+eahOmYn+WktCDlj6/ku6XnkIbop6PkuLrkvKrlkIzmraUKICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24odHlwZSwgZnVuYywgb2JqLCBwcmlvcml0eSkgewogICAgICAgICAgICBpZiAodHlwZSBpbiBvLkV2ZW50cyAmJiAhdGhpcy5leHRlbnNpb25zW3R5cGVdKSB7CiAgICAgICAgICAgICAgICB0aGlzLmV4dGVuc2lvbnNbdHlwZV0gPSBuZXcgby5FdmVudHNbdHlwZV0odGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZ1bmMgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG9iaiA9PSBudWxsIHx8IG9iaiA9PSB1bmRlZmluZWQpICB7CiAgICAgICAgICAgICAgICAgICAgb2JqID0gdGhpcy5vYmo7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnNbdHlwZV07CiAgICAgICAgICAgICAgICBpZiAoIWxpc3RlbmVycykgewogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuZXJzW3R5cGVdID0gbGlzdGVuZXJzOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXh0ZW5zaW9uQ291bnRbdHlwZV0gPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVyID0ge29iajogb2JqLCBmdW5jOiBmdW5jfTsKICAgICAgICAgICAgICAgIGlmIChwcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UodGhpcy5leHRlbnNpb25Db3VudFt0eXBlXSwgMCwgbGlzdGVuZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJpb3JpdHkgPT09ICJvYmplY3QiICYmIHByaW9yaXR5LmV4dGVuc2lvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4dGVuc2lvbkNvdW50W3R5cGVdKys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuRXZlbnRzLnVuCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBkZXNjIOWPlua2iOiHquWumuS5ieS6i+S7tueahOebkeWQrAogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOS6i+S7tuexu+WeiwogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g6Kem5Y+R5Zue6LCDCiAgICAgICAgICogQHBhcmFtIG9iaiB7T2JqZWN0fSDpu5jorqToh6rouqsKICAgICAgICAgKi8KICAgICAgICB1bjogZnVuY3Rpb24odHlwZSwgZnVuYywgb2JqKSB7CiAgICAgICAgICAgIGlmIChvYmogPT0gbnVsbCkgIHsKICAgICAgICAgICAgICAgIG9iaiA9IHRoaXMub2JqOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVyc1t0eXBlXTsKICAgICAgICAgICAgaWYgKGxpc3RlbmVycyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsIGxlbj1saXN0ZW5lcnMubGVuZ3RoOyBpPGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3RlbmVyc1tpXS5vYmogPT0gb2JqICYmIGxpc3RlbmVyc1tpXS5mdW5jID09IGZ1bmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy50cmlnZ2VyRXZlbnQKICAgICAgICAgKiBAZGVzYyDop6blj5Hkuovku7YKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDop6blj5Hkuovku7bnsbvlnosKICAgICAgICAgKiBAcGFyYW0gZXZ0IHtldmVudH0KICAgICAgICAgKi8KICAgICAgICB0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGV2dCkgewogICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnNbdHlwZV07CiAgICAgICAgICAgIGlmKCFsaXN0ZW5lcnMgfHwgbGlzdGVuZXJzLmxlbmd0aCA9PSAwKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICBpZiAoZXZ0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV2dCA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2dC5vYmogPSB0aGlzLm9iajsKICAgICAgICAgICAgZXZ0LmVsID0gdGhpcy5lbDsKICAgICAgICAgICAgaWYoIWV2dC50eXBlKSB7CiAgICAgICAgICAgICAgICBldnQudHlwZSA9IHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9jbG9uZeS4gOS7vQogICAgICAgICAgICBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMuc2xpY2UoKTsKICAgICAgICAgICAgdmFyIGNvbnRpbnVlQ2hhaW4sCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGxlbiA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGxpc3RlbmVyc1tpXTsKICAgICAgICAgICAgICAgIC8vIGJpbmQgdGhlIGNvbnRleHQgdG8gY2FsbGJhY2sub2JqCiAgICAgICAgICAgICAgICBjb250aW51ZUNoYWluID0gY2FsbGJhY2suZnVuYy5hcHBseShjYWxsYmFjay5vYmosIFtldnRdKTsKICAgICAgICAgICAgICAgIGlmIChjb250aW51ZUNoYWluID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIC8vIOWmguaenOi/lOWbnuWAvOS4umZhbHNl6KGo56S65Zue6LCD5Yiw5q2k5Li65q2iCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0aGlzLmZhbGxUaHJvdWdoKSB7CiAgICAgICAgICAgICAgICBvLmV2ZW50LnN0b3AoZXZ0LCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGludWVDaGFpbjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuRXZlbnRzLnJlbW92ZQogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAZGVzYyDnm7TmjqXmiormjIflrprkuovku7bnsbvlnovnmoTnm5HlkKzlm57osIPnva7nqboKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHJlbW92ZTogZnVuY3Rpb24odHlwZSkgewogICAgICAgICAgICBpZiAodGhpcy5saXN0ZW5lcnNbdHlwZV0gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5lcnNbdHlwZV0gPSBbXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5FdmVudHMucmVnaXN0ZXIKICAgICAgICAgKiBAZGVzYyDmibnph4/lop7liqDkuovku7YKICAgICAgICAgKiBAcGFyYW0gZXZzIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGV2cykgewogICAgICAgICAgICBmb3IodmFyIHR5cGUgaW4gZXZzKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlICE9ICJzY29wZSIgJiYgZXZzLmhhc093blByb3BlcnR5KHR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbih0eXBlLCBldnNbdHlwZV0sIGV2cy5zY29wZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy51bnJlZ2lzdGVyCiAgICAgICAgICogQGRlc2Mg5om56YeP5Y676Zmk5LqL5Lu2CiAgICAgICAgICogQHBhcmFtIGV2cyB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIHVucmVnaXN0ZXI6IGZ1bmN0aW9uKGV2cykgewogICAgICAgICAgICBmb3IodmFyIHR5cGUgaW4gZXZzKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlICE9ICJzY29wZSIgJiYgZXZzLmhhc093blByb3BlcnR5KHR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51bih0eXBlLCBldnNbdHlwZV0sIGV2cy5zY29wZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAiT2N0b3B1cy5FdmVudHMiCiAgICB9KTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tgogKiDmqKHmnb/lvJXmk47pg6jliIYKICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKi8KOyhmdW5jdGlvbihvLCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAgKiBAbmFtZXNwYWNlIG9jdG9wdXMudGVtcGxhdGUKICAgICAqLwogICAgby50ZW1wbGF0ZSA9IG8udGVtcGxhdGUgfHwge307CgogICAgby5leHRlbmQoby50ZW1wbGF0ZSwgewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjYWNoZXMKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIGNhY2hlczoge30sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCB0ZW1wbGF0ZVRleHQKICAgICAgICAgKiBAcGFyYW0gZWxlbWVudAogICAgICAgICAqLwogICAgICAgIHRlbXBsYXRlVGV4dDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICBpZighby51dGlsLmlzTm9kZShlbGVtZW50KSkgcmV0dXJuICIiOwogICAgICAgICAgICBpZigvXihpbnB1dHx0ZXh0YXJlYSkkL2kudGVzdChlbGVtZW50LnRhZ05hbWUpKSByZXR1cm4gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIG8udXRpbC5kZWNvZGVIdG1sKGVsZW1lbnQuaW5uZXJIVE1MKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgcmVnaXN0ZXIKICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gdGFyZ2V0IHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihpZCwgdGFyZ2V0KSB7CiAgICAgICAgICAgIGlmKCFpZCkgcmV0dXJuOwogICAgICAgICAgICBpZih0aGlzLmNhY2hlc1tpZF0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNhY2hlc1tpZF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGVzW2lkXSA9IHRoaXMucGFyc2Uoby51dGlsLmlzU3RyaW5nKHRhcmdldCkgPyB0YXJnZXQgOiB0aGlzLnRlbXBsYXRlVGV4dChvLmcodGFyZ2V0KSkpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBwYXJzZQogICAgICAgICAqIEBwYXJhbSB0ZW1wbGF0ZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHBhcnNlOiBmdW5jdGlvbih0ZW1wbGF0ZSkgewogICAgICAgICAgICB2YXIgYm9keSA9IFtdOwogICAgICAgICAgICBib2R5LnB1c2goIndpdGgodGhpcyl7Iik7CiAgICAgICAgICAgIGJvZHkucHVzaCh0ZW1wbGF0ZQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcclxuXSsvZywgIlxuIikgLy8g5Y675o6J5aSa5L2Z55qE5o2i6KGM77yM5bm25LiU5Y675o6JSUXkuK3lm7DmibDkurrnmoRccgogICAgICAgICAgICAgICAgLnJlcGxhY2UoL15cbit8XHMrJC9tZywgIiIpIC8vIOWOu+aOieepuuihjO+8jOmmlumDqOepuuihjO+8jOWwvumDqOepuueZvQogICAgICAgICAgICAgICAgLnJlcGxhY2UoLygoXlxzKls8PiEjXiZcdTAwMDAtXHUwMDA4XHUwMDdGLVx1ZmZmZl0uKiR8Xi4qWzw+XVxzKiR8Xig/IVxzKihlbHNlfGRvfHRyeXxmaW5hbGx5KVxzKiQpW14nIjo7LFxbXF17fSgpXG5cL10rJHxeKFxzKigoW1x3LV0rXHMqPVxzKiJbXiJdKiIpfChbXHctXStccyo9XHMqJ1teJ10qJykpKStccyokfF5ccyooWy4jXVtcdy0uXSsoOlx3Kyk/KFxzKnwsKSkqKD8hKGVsc2V8ZG98d2hpbGV8dHJ5fHJldHVybilcYilbLiNdP1tcdy0uKl0rKDpcdyspP1xzKlx7LiokKVxzPykrL21nLCBmdW5jdGlvbihleHByZXNzaW9uKSB7IC8vIOi+k+WHuuWOn+aWhwogICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSBbJyInLCBleHByZXNzaW9uCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8mbm9uZTsvZywgIiIpIC8vIOepuuWtl+espgogICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvWyInXFxdL2csICJcXCQmIikgLy8g5aSE55CG6L2s5LmJ56ymCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cbi9nLCAiXFxuIikgLy8g5aSE55CG5Zue6L2m6L2s5LmJ56ymCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8oIT8jKVx7KC4qPylcfS9nLCBmdW5jdGlvbiAoYWxsLCBmbGFnLCB0ZW1wbGF0ZSkgeyAvLyDlj5jph4/mm7/mjaIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gdGVtcGxhdGUucmVwbGFjZSgvXFxuL2csICJcbiIpLnJlcGxhY2UoL1xcKFtcXCciXSkvZywgIiQxIik7IC8vIOi/mOWOn+i9rOS5iQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkZW50aWZpZXIgPSAvXlthLXokXVtcdyskXSskL2kudGVzdCh0ZW1wbGF0ZSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAhKC9eKHRydWV8ZmFsc2V8TmFOfG51bGx8dGhpcykkLy50ZXN0KHRlbXBsYXRlKSk7IC8vIOWNlee6r+WPmOmHj++8jOWKoOS4gOS4quacquWumuS5ieS/neaKpAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsnIiwnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPyBbJ3R5cGVvZiAnLCB0ZW1wbGF0ZSwgJz09InVuZGVmaW5lZCI/IiI6J10uam9pbigiIikgOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZmxhZyA9PSAiIyIgPyAnX2VuY29kZV8nIDogIiIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcoJywgdGVtcGxhdGUsICcpLCInXS5qb2luKCIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSksICciJ10uam9pbigiIikucmVwbGFjZSgvXiIiLHwsIiIkL2csICIiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZXhwcmVzc2lvbikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsnX291dHB1dF8ucHVzaCgnLCBleHByZXNzaW9uLCAnKTsnXS5qb2luKCIiKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiAiIjsKICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgYm9keS5wdXNoKCJ9Iik7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBuZXcgRnVuY3Rpb24oIl9vdXRwdXRfIiwgIl9lbmNvZGVfIiwgImhlbHBlciIsIGJvZHkuam9pbigiIikpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMudGVtcGxhdGUuZm9ybWF0CiAgICAgICAgICovCiAgICAgICAgZm9ybWF0OiBmdW5jdGlvbihpZCwgZGF0YSwgaGVscGVyKSB7CiAgICAgICAgICAgIGlmICghaWQpIHJldHVybiAiIjsKICAgICAgICAgICAgdmFyIHJlYWRlciwgZWxlbWVudDsKICAgICAgICAgICAgaWYgKG8udXRpbC5pc05vZGUoaWQpKSB7IC8vIOWmguaenOaYr0RvbeWvueixoQogICAgICAgICAgICAgICAgZWxlbWVudCA9IGlkOwogICAgICAgICAgICAgICAgaWQgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgiaWQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBoZWxwZXIgPSBoZWxwZXIgfHwgdGhpczsKICAgICAgICAgICAgcmVhZGVyID0gdGhpcy5jYWNoZXNbaWRdOwogICAgICAgICAgICBpZighcmVhZGVyKSB7CiAgICAgICAgICAgICAgICBpZighL1teXHctXS8udGVzdChpZCkpIHsKICAgICAgICAgICAgICAgICAgICBpZighZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0gby5nKGlkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmVhZGVyID0gdGhpcy5yZWdpc3RlcihpZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlYWRlciA9IHRoaXMucGFyc2UoaWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSBbXTsKICAgICAgICAgICAgcmVhZGVyLmNhbGwoZGF0YSB8fCAiIiwgb3V0cHV0LCBvLnV0aWwuZW5jb2RlSHRtbCwgaGVscGVyKTsKICAgICAgICAgICAgcmV0dXJuIG91dHB1dC5qb2luKCIiKTsKICAgICAgICB9CiAgICB9KTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupMKICogYWpheOaWueazlQogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQHJlcXVpcmUgbGliL2RvbS5qcwogKi8KOyhmdW5jdGlvbiAobywgdW5kZWZpbmVkKSB7CgogICAgby5hamF4ID0gby5hamF4IHx8IHt9OwoKICAgIC8qKgogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzLmFqYXgKICAgICAqIEBkZXNjIGFqYXjor7fmsYLmlrnms5UKICAgICAqLwogICAgby5leHRlbmQoby5hamF4LCB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IERFRkFVTFRfQ09ORklHCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKiBAZGVzYyDphY3nva7pobkKICAgICAgICAgKiB0eXBlIC0ge1N0cmluZ30gR0VULCBQT1NULCBQVVQsIERFTEVURSwgSEVBRCwgT1BUSU9OUy4g6buY6K6k5pivR0VULgogICAgICAgICAqIHVybCAtIHtTdHJpbmd9IOivt+axgueahOWcsOWdgAogICAgICAgICAqIGFzeW5jIC0ge0Jvb2xlYW59IOaYr+WQpuWQjOatpeivt+axgiAg6buY6K6k5pivdHJ1ZS4KICAgICAgICAgKiB1c2VyIC0ge1N0cmluZ30g55So5oi35ZCNCiAgICAgICAgICogcGFzc3dvcmQgLSB7U3RyaW5nfSDlr4bnoIEKICAgICAgICAgKiBkYXRhIC0ge1N0cmluZyB8IE9iamVjdH0gUE9TVOS4jlBVVOaPkOS6pOeahOaVsOaNrgogICAgICAgICAqIGNvbXBsZXRlIC0ge0Z1bmN0aW9ufQogICAgICAgICAqIHN1Y2Nlc3MgLSB7RnVuY3Rpb259CiAgICAgICAgICogZXJyb3IgLSB7RnVuY3Rpb259CiAgICAgICAgICogc2NvcGUgLSB7T2JqZWN0fQogICAgICAgICAqIGJlZm9yZVNlbmQgICAtICAge0Z1bmN0aW9ufSDor7fmsYLlj5Hlh7rliY3osIPnlKgKICAgICAgICAgKiB0aW1lb3V0ICAtICAge051bWJlcn0g5bu25pe2CiAgICAgICAgICovCiAgICAgICAgREVGQVVMVF9DT05GSUc6IHsKICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgIHVybDogd2luZG93LmxvY2F0aW9uLmhyZWYsCiAgICAgICAgICAgIGFzeW5jOiB0cnVlLAogICAgICAgICAgICB1c2VyOiB1bmRlZmluZWQsCiAgICAgICAgICAgIHBhc3N3b3JkOiB1bmRlZmluZWQsCiAgICAgICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgICAgIGNvbXBsZXRlOiBvLnV0aWwuZW1wdHksCiAgICAgICAgICAgIHN1Y2Nlc3M6IG51bGwsCiAgICAgICAgICAgIGVycm9yOiBudWxsLAogICAgICAgICAgICBzY29wZTogbnVsbCwKICAgICAgICAgICAgYmVmb3JlU2VuZDogbnVsbCwKICAgICAgICAgICAgdGltZW91dDogMCwKICAgICAgICAgICAgY3Jvc3NEb21haW46IGZhbHNlCiAgICAgICAgfSwKCiAgICAgICAganNvbnBJRDogMCwKCiAgICAgICAganNvblR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICBodG1sVHlwZTogJ3RleHQvaHRtbCcsCgogICAgICAgIFNDUklQVF9SRUdFWDogLzxzY3JpcHRcYltePF0qKD86KD8hPFwvc2NyaXB0Pik8W148XSopKjxcL3NjcmlwdD4vZ2ksCiAgICAgICAgU0NSSVBUX1RZUEVfUkVHRVg6IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL2phdmFzY3JpcHQvaSwKICAgICAgICBYTUxfVFlQRV9SRUdFWDogL14oPzp0ZXh0fGFwcGxpY2F0aW9uKVwveG1sL2ksCiAgICAgICAgVVJMX1NQTElUX1JFR0VYOiAvKFteOl0qOilcL1wvKFteOl0qOj9bXkBdKkApPyhbXjpcL1w/XSopOj8oW15cL1w/XSopLywKICAgICAgICBCTEFOS19SRUdFWDogL15ccyokLywKICAgICAgICBhY2NlcHRzOiB7CiAgICAgICAgICAgIHNjcmlwdDogJ3RleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCcsCiAgICAgICAgICAgIGpzb246ICAgdGhpcy5qc29uVHlwZSwKICAgICAgICAgICAgeG1sOiAgICAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgICAgICAgIGh0bWw6ICAgdGhpcy5odG1sVHlwZSwKICAgICAgICAgICAgdGV4dDogICAndGV4dC9wbGFpbicKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB4aHIKICAgICAgICAgKiBAdHlwZSB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgeGhyOiBmdW5jdGlvbigpIHsgcmV0dXJuIG5ldyB3aW5kb3cuWE1MSHR0cFJlcXVlc3QoKTsgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG1pbWVUb0RhdGFUeXBlCiAgICAgICAgICovCiAgICAgICAgbWltZVRvRGF0YVR5cGU6IGZ1bmN0aW9uKG1pbWUpIHsKICAgICAgICAgICAgcmV0dXJuIG1pbWUgJiYgKCBtaW1lID09IHRoaXMuaHRtbFR5cGUgPyAnaHRtbCcgOgogICAgICAgICAgICAgICAgbWltZSA9PSB0aGlzLmpzb25UeXBlID8gJ2pzb24nIDoKICAgICAgICAgICAgICAgICAgICB0aGlzLlNDUklQVF9UWVBFX1JFR0VYLnRlc3QobWltZSkgPyAnc2NyaXB0JyA6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuWE1MX1RZUEVfUkVHRVgudGVzdChtaW1lKSAmJiAneG1sJyApIHx8ICd0ZXh0JwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCByZXF1ZXN0CiAgICAgICAgICogQGRlc2Mg5Y+R5Ye66K+35rGCIOWQhOenjQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9IOmFjee9rumhuQogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fQogICAgICAgICAqLwogICAgICAgIHJlcXVlc3Q6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRDb25maWcgPSB0aGlzLkRFRkFVTFRfQ09ORklHLAogICAgICAgICAgICAgICAgY29uZmlnID0gby51dGlsLmFwcGx5RGVmYXVsdHMob3B0aW9ucywgZGVmYXVsdENvbmZpZyksCiAgICAgICAgICAgICAgICBkYXRhVHlwZSA9IGNvbmZpZy5kYXRhVHlwZSwKICAgICAgICAgICAgICAgIHVybCA9IGNvbmZpZy51cmwsCiAgICAgICAgICAgICAgICBkYXRhID0gY29uZmlnLmRhdGEgfHwge30sCiAgICAgICAgICAgICAgICBoZWFkZXJzID0gY29uZmlnLmhlYWRlcnMgfHwge30sCiAgICAgICAgICAgICAgICB1cmxvYmogPSBvLnV0aWwuY3JlYXRlVXJsT2JqZWN0KHVybCk7CiAgICAgICAgICAgIGlmKGNvbmZpZy50eXBlID09ICJqc29ucCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvLmFqYXguYWpheEpTT05QKG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFjb25maWcuY3Jvc3NEb21haW4pIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5jcm9zc0RvbWFpbiA9IHVybG9iai5ob3N0ICE9IHdpbmRvdy5sb2NhdGlvbi5ob3N0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjdXN0b21SZXF1ZXN0ZWRXaXRoSGVhZGVyID0gZmFsc2UsCiAgICAgICAgICAgICAgICBoZWFkZXJLZXk7CiAgICAgICAgICAgIGZvcihoZWFkZXJLZXkgaW4gaGVhZGVycykgewogICAgICAgICAgICAgICAgaWYgKGhlYWRlcktleS50b0xvd2VyQ2FzZSgpID09PSAneC1yZXF1ZXN0ZWQtd2l0aCcpIHsKICAgICAgICAgICAgICAgICAgICBjdXN0b21SZXF1ZXN0ZWRXaXRoSGVhZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZihjdXN0b21SZXF1ZXN0ZWRXaXRoSGVhZGVyID09PSBmYWxzZSB8fCAhY29uZmlnLmNyb3NzRG9tYWluKSB7CiAgICAgICAgICAgICAgICBoZWFkZXJzWydYLVJlcXVlc3RlZC1XaXRoJ10gPSAnWE1MSHR0cFJlcXVlc3QnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRhdGEgPSAgby51dGlsLmdldFBhcmFtZXRlclN0cmluZyhkYXRhIHx8IHt9KTsKICAgICAgICAgICAgaWYoY29uZmlnLnR5cGUgIT0gIlBPU1QiKSB7CiAgICAgICAgICAgICAgICBjb25maWcudXJsID0gby51dGlsLnVybEFwcGVuZCh1cmwsIGRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtaW1lID0gdGhpcy5hY2NlcHRzW2RhdGFUeXBlXSwKICAgICAgICAgICAgICAgIGJhc2VIZWFkZXJzID0ge30sCiAgICAgICAgICAgICAgICB4aHIgPSB0aGlzLnhocigpLCBhYm9ydFRpbWVvdXQ7CiAgICAgICAgICAgIGlmKG1pbWUpIHsKICAgICAgICAgICAgICAgIGJhc2VIZWFkZXJzWydBY2NlcHQnXSA9IG1pbWU7CiAgICAgICAgICAgICAgICBpZihtaW1lLmluZGV4T2YoJywnKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgbWltZSA9IG1pbWUuc3BsaXQoJywnLCAyKVswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlKG1pbWUpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGVhZGVycyA9IG8uZXh0ZW5kKGJhc2VIZWFkZXJzLCBoZWFkZXJzIHx8IHt9KTsKICAgICAgICAgICAgeGhyLm9wZW4oCiAgICAgICAgICAgICAgICBjb25maWcudHlwZSwgY29uZmlnLnVybCwgY29uZmlnLmFzeW5jLCBjb25maWcudXNlciwgY29uZmlnLnBhc3N3b3JkCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGZvcih2YXIgaGVhZGVyIGluIGhlYWRlcnMpIHsKICAgICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGhlYWRlciwgaGVhZGVyc1toZWFkZXJdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKHhoci5yZWFkeVN0YXRlID09IDQpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoYWJvcnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aGF0LnJ1bkNhbGxiYWNrcygKICAgICAgICAgICAgICAgICAgICAgICAge3JlcXVlc3Q6IHhociwgY29uZmlnOiBjb25maWcsIHJlcXVlc3RVcmw6IGNvbmZpZy51cmx9CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYoY29uZmlnLmFzeW5jID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgeGhyLnNlbmQoZGF0YSA/IGRhdGEgOiBudWxsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgaWYoeGhyLnJlYWR5U3RhdGUgIT09IDApIHsgLy8gVzNDOiAwLVVOU0VOVAogICAgICAgICAgICAgICAgICAgICAgICB4aHIuc2VuZChkYXRhID8gZGF0YSA6IG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGNvbmZpZy50aW1lb3V0ID4gMCkgewogICAgICAgICAgICAgICAgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgICAgICAgICAgeGhyLmFib3J0KCkKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3I7CiAgICAgICAgICAgICAgICAgICAgaWYoY29uZmlnLmVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgby51dGlsLmJpbmQoY29uZmlnLmVycm9yLCBjb25maWcuc2NvcGUpIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5lcnJvcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoeGhyLCAidGltZW91dCIpOwogICAgICAgICAgICAgICAgfSwgY29uZmlnLnRpbWVvdXQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHhocjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgcnVuQ2FsbGJhY2tzCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBydW5DYWxsYmFja3M6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHJlcXVlc3QgPSBvcHRpb25zLnJlcXVlc3Q7CiAgICAgICAgICAgIHZhciBjb25maWcgPSBvcHRpb25zLmNvbmZpZzsKICAgICAgICAgICAgdmFyIGNvbXBsZXRlID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgby51dGlsLmJpbmQoY29uZmlnLmNvbXBsZXRlLCBjb25maWcuc2NvcGUpIDoKICAgICAgICAgICAgICAgIGNvbmZpZy5jb21wbGV0ZTsKICAgICAgICAgICAgdmFyIHN1Y2Nlc3M7CiAgICAgICAgICAgIGlmKGNvbmZpZy5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBzdWNjZXNzID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgICAgIG8udXRpbC5iaW5kKGNvbmZpZy5zdWNjZXNzLCBjb25maWcuc2NvcGUpIDoKICAgICAgICAgICAgICAgICAgICBjb25maWcuc3VjY2VzczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFpbHVyZTsKICAgICAgICAgICAgaWYoY29uZmlnLmVycm9yKSB7CiAgICAgICAgICAgICAgICBmYWlsdXJlID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgICAgIG8udXRpbC5iaW5kKGNvbmZpZy5lcnJvciwgY29uZmlnLnNjb3BlKSA6CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLmVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBsZXRlKHJlcXVlc3QpOwogICAgICAgICAgICB2YXIgcmVzdWx0LCBlcnJvciA9IGZhbHNlLAogICAgICAgICAgICAgICAgZGF0YVR5cGUgPSBjb25maWcuZGF0YVR5cGU7CiAgICAgICAgICAgIGlmKChyZXF1ZXN0LnN0YXR1cyA+PSAyMDAgJiYgcmVxdWVzdC5zdGF0dXMgPCAzMDApIHx8IHJlcXVlc3Quc3RhdHVzID09IDMwNCB8fAogICAgICAgICAgICAgICAgKHJlcXVlc3Quc3RhdHVzID09IDAgJiYgby51dGlsLmNyZWF0ZVVybE9iamVjdChjb25maWcudXJsKS5wcm90b2NvbCA9PSAiZmlsZToiKSkgewogICAgICAgICAgICAgICAgZGF0YVR5cGUgPSBkYXRhVHlwZSB8fCB0aGlzLm1pbWVUb0RhdGFUeXBlKHJlcXVlc3QuZ2V0UmVzcG9uc2VIZWFkZXIoJ2NvbnRlbnQtdHlwZScpKTsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlcXVlc3QucmVzcG9uc2VUZXh0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBpZihkYXRhVHlwZSA9PSAnc2NyaXB0JykgICAgKDEsZXZhbCkocmVzdWx0KQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYoZGF0YVR5cGUgPT0gJ3htbCcpICByZXN1bHQgPSByZXF1ZXN0LnJlc3BvbnNlWE1MCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZihkYXRhVHlwZSA9PSAnanNvbicpIHJlc3VsdCA9IHRoaXMuQkxBTktfUkVHRVgudGVzdChyZXN1bHQpID8gbnVsbCA6IEpTT04ucGFyc2UocmVzdWx0KQogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyBlcnJvciA9IGUgfQogICAgICAgICAgICAgICAgb3B0aW9ucy5yZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgICAgICBpZihzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyhyZXF1ZXN0LCByZXN1bHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYoZmFpbHVyZSkgewogICAgICAgICAgICAgICAgICAgIGZhaWx1cmUocmVxdWVzdCwgImVycm9yIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFqYXguZ2V0CiAgICAgICAgICogQGRlc2Mg5Y+R5p2hZ2V06K+35rGCCiAgICAgICAgICogQHBhcmFtIGNvbmZpZyB7T2JqZWN0fQogICAgICAgICAqIEBwYXJhbSBjb25maWcudXJsIHtTdHJpbmd9IOivt+axguWcsOWdgAogICAgICAgICAqIEBwYXJhbSBjb25maWcuYXN5bmMge0Jvb2xlYW59IOWQjOW8guatpQogICAgICAgICAqIEBwYXJhbSBjb25maWcuY29tcGxldGUge0Z1bmN0aW9ufSDor7fmsYLnu5PmnZ/nmoRjYWxsYmFjawogICAgICAgICAqIEBwYXJhbSBjb25maWcuc3VjY2VzcyB7RnVuY3Rpb259IOivt+axguaIkOWKn+eahGNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIGNvbmZpZy5lcnJvciB7RnVuY3Rpb259IOivt+axguWksei0peeahGNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIGNvbmZpZy50aW1lb3V0IHtOdW1iZXJ9IOi2heaXtuaXtumXtAogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICAiZ2V0IjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIGNvbmZpZyA9IG8uZXh0ZW5kKGNvbmZpZywge3R5cGU6ICJHRVQifSk7CiAgICAgICAgICAgIHJldHVybiBvLmFqYXgucmVxdWVzdChjb25maWcpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYWpheC5wb3N0CiAgICAgICAgICogQGRlc2Mg5Y+R5p2hcG9zdOivt+axggogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMZ2V0CiAgICAgICAgICogQHBhcmFtIGNvbmZpZy5kYXRhIHtPYmplY3R9IOaVsOaNrgogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICBwb3N0OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAgICAgY29uZmlnID0gby5leHRlbmQoY29uZmlnLCB7dHlwZTogIlBPU1QifSk7CiAgICAgICAgICAgIC8vIHNldCBjb250ZW50IHR5cGUgdG8gYXBwbGljYXRpb24veG1sIGlmIGl0IGlzbid0IGFscmVhZHkgc2V0CiAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzID0gY29uZmlnLmhlYWRlcnMgPyBjb25maWcuaGVhZGVycyA6IHt9OwogICAgICAgICAgICBpZighKCJDT05URU5ULVRZUEUiIGluIG8udXRpbC51cHBlckNhc2VPYmplY3QoY29uZmlnLmhlYWRlcnMpKSkgewogICAgICAgICAgICAgICAgY29uZmlnLmhlYWRlcnNbIkNvbnRlbnQtVHlwZSJdID0gImFwcGxpY2F0aW9uL3htbCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG8uYWpheC5yZXF1ZXN0KGNvbmZpZyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hamF4LnB1dAogICAgICAgICAqIEBkZXNjIOWPkeadoXB1dOivt+axggogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMcG9zdAogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICBwdXQ6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcgPSBvLmV4dGVuZChjb25maWcsIHt0eXBlOiAiUFVUIn0pOwogICAgICAgICAgICAvLyBzZXQgY29udGVudCB0eXBlIHRvIGFwcGxpY2F0aW9uL3htbCBpZiBpdCBpc24ndCBhbHJlYWR5IHNldAogICAgICAgICAgICBjb25maWcuaGVhZGVycyA9IGNvbmZpZy5oZWFkZXJzID8gY29uZmlnLmhlYWRlcnMgOiB7fTsKICAgICAgICAgICAgaWYoISgiQ09OVEVOVC1UWVBFIiBpbiBvLnV0aWwudXBwZXJDYXNlT2JqZWN0KGNvbmZpZy5oZWFkZXJzKSkpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzWyJDb250ZW50LVR5cGUiXSA9ICJhcHBsaWNhdGlvbi94bWwiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvLmFqYXgucmVxdWVzdChjb25maWcpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYWpheC5kZWxldGUKICAgICAgICAgKiBAZGVzYyDlj5HmnaFkZWxldGXor7fmsYIKICAgICAgICAgKiBAcGFyYW0gY29uZmlnIHtPYmplY3R9IOWQjGdldAogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICAiZGVsZXRlIjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIGNvbmZpZyA9IG8uZXh0ZW5kKGNvbmZpZywge3R5cGU6ICJERUxFVEUifSk7CiAgICAgICAgICAgIHJldHVybiBvLmFqYXgucmVxdWVzdChjb25maWcpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYWpheC5oZWFkCiAgICAgICAgICogQGRlc2Mg5Y+R5p2haGVhZOivt+axggogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMZ2V0CiAgICAgICAgICogQHJldHVybiB7WE1MSHR0cFJlcXVlc3R9IFJlcXVlc3Qgb2JqZWN0LgogICAgICAgICAqLwogICAgICAgIGhlYWQ6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcgPSBvLmV4dGVuZChjb25maWcsIHt0eXBlOiAiSEVBRCJ9KTsKICAgICAgICAgICAgcmV0dXJuIG8uYWpheC5yZXF1ZXN0KGNvbmZpZyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hamF4Lm9wdGlvbnMKICAgICAgICAgKiBAZGVzYyDlj5HmnaFvcHRpb25z6K+35rGCLgogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMZ2V0CiAgICAgICAgICogQHJldHVybiB7WE1MSHR0cFJlcXVlc3R9IFJlcXVlc3Qgb2JqZWN0LgogICAgICAgICAqLwogICAgICAgIG9wdGlvbnM6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcgPSBvLmV4dGVuZChjb25maWcsIHt0eXBlOiAiT1BUSU9OUyJ9KTsKICAgICAgICAgICAgcmV0dXJuIG8uYWpheC5yZXF1ZXN0KGNvbmZpZyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIF9jcmVhdGVTY3JpcHRUYWcKICAgICAgICAgKi8KICAgICAgICBfY3JlYXRlU2NyaXB0VGFnOiBmdW5jdGlvbihzY3IsIHVybCwgY2hhcnNldCkgewogICAgICAgICAgICBzY3Iuc2V0QXR0cmlidXRlKCd0eXBlJywgJ3RleHQvamF2YXNjcmlwdCcpOwogICAgICAgICAgICBjaGFyc2V0ICYmIHNjci5zZXRBdHRyaWJ1dGUoJ2NoYXJzZXQnLCBjaGFyc2V0KTsKICAgICAgICAgICAgc2NyLnNldEF0dHJpYnV0ZSgnc3JjJywgdXJsKTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXS5hcHBlbmRDaGlsZChzY3IpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQE1ldGhvZCBfcmVtb3ZlU2NyaXB0VGFnCiAgICAgICAgICovCiAgICAgICAgX3JlbW92ZVNjcmlwdFRhZzogZnVuY3Rpb24oc2NyKSB7CiAgICAgICAgICAgIGlmIChzY3IuY2xlYXJBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICBzY3IuY2xlYXJBdHRyaWJ1dGVzKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBhdHRyIGluIHNjcikgewogICAgICAgICAgICAgICAgICAgIGlmIChzY3IuaGFzT3duUHJvcGVydHkoYXR0cikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHNjclthdHRyXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoc2NyICYmIHNjci5wYXJlbnROb2RlKXsKICAgICAgICAgICAgICAgIHNjci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2NyID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIHNjcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFqYXguYWpheEpTT05QCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0KICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy51cmwge1N0cmluZ30g6K+35rGC5Zyw5Z2ACiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMuY29tcGxldGUge0Z1bmN0aW9ufSDmiJDlip/lm57osIMKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5lcnJvciB7RnVuY3Rpb259IOWksei0peWbnuiwgwogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLnRpbWVvdXQge051bWJlcn0g6LaF5pe25pe26ZW/CiAgICAgICAgICovCiAgICAgICAgYWpheEpTT05QOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgIGRlZmF1bHRDb25maWcgPSB0aGlzLkRFRkFVTFRfQ09ORklHLAogICAgICAgICAgICAgICAgcHJlZml4ID0gImpzb25wIiwKICAgICAgICAgICAgICAgIGNhbGxiYWNrTmFtZSwKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBvLnV0aWwuYXBwbHlEZWZhdWx0cyhvcHRpb25zLCBkZWZhdWx0Q29uZmlnKSwKICAgICAgICAgICAgICAgIGNoYXJzZXQgPSBvcHRpb25zWydjaGFyc2V0J10sCiAgICAgICAgICAgICAgICBkYXRhID0gb3B0aW9uc1siZGF0YSJdIHx8IHt9LAogICAgICAgICAgICAgICAgdGltZU91dCA9IG9wdGlvbnNbJ3RpbWVvdXQnXSB8fCAwLAogICAgICAgICAgICAgICAgdGltZXIsCiAgICAgICAgICAgICAgICB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgIHVybCA9IG9wdGlvbnNbInVybCJdLAogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBvcHRpb25zWyJzdWNjZXNzIl0gfHwgb3B0aW9uc1siY29tcGxldGUiXSwKICAgICAgICAgICAgICAgIGpzb25wTmFtZSA9IG9wdGlvbnNbImpzb25wIl0gfHwgImNhbGxiYWNrIiwKICAgICAgICAgICAgICAgIGVycm9yID0gb3B0aW9uc1siZXJyb3IiXSB8fCBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgIGlmKG8udXRpbC5pc1N0cmluZyhjYWxsYmFjaykpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrTmFtZSA9IGNhbGxiYWNrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2FsbGJhY2tOYW1lID0gcHJlZml4ICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjE0NzQ4MzY0OCkudG9TdHJpbmcoMzYpOwogICAgICAgICAgICAgICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBnZXRDYWxsQmFjaygwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aW1lT3V0ID4gMCl7CiAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZ2V0Q2FsbEJhY2soMSksIHRpbWVPdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNjcmlwdC5vbmVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aGF0Ll9yZW1vdmVTY3JpcHRUYWcoc2NyaXB0KTsKICAgICAgICAgICAgICAgIGlmKGNhbGxiYWNrTmFtZSBpbiB3aW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dbY2FsbGJhY2tOYW1lXSA9IGZ1bmN0aW9uKCl7fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVycm9yKCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVybCA9IG8udXRpbC51cmxBcHBlbmQoby51dGlsLnVybEFwcGVuZCh1cmwsCiAgICAgICAgICAgICAgICBvLnV0aWwuZ2V0UGFyYW1ldGVyU3RyaW5nKGRhdGEgfHwge30pKSwganNvbnBOYW1lICsgIj0iICsgY2FsbGJhY2tOYW1lKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlU2NyaXB0VGFnKHNjcmlwdCwgdXJsLCBjaGFyc2V0KTsKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q2FsbEJhY2sob25UaW1lT3V0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIG9uVGltZU91dCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkod2luZG93LCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvd1tjYWxsYmFja05hbWVdID0gby51dGlsLmVtcHR5OwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4Y2VwdGlvbikge30KICAgICAgICAgICAgICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5fcmVtb3ZlU2NyaXB0VGFnKHNjcmlwdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvcHRpb25zWyJ4aHIiXTsKICAgICAgICB9CiAgICB9KTsKfSkob2N0b3B1cyk7Ci8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICog5Yqo55S76YOo5YiGCiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLlR3ZWVuCiAgICAgKiBAZGVzYyDliqjnlLvnsbvvvIzlj6/ku6XpgJrov4fmlLnlj5jlsZ7mgKfjgIHotbflp4vlgLzjgIHnu5PmnZ/lgLznrYnphY3nva7orqnmjIflrproioLngrnlrozmiJDliqjmgIHov4fmuKEKICAgICAqIOazqOaEj++8mueUseS6juaDheWGtei/h+S6juWkjeadgiDlh6HmmK/mlLnlj5jlsZ7mgKfmmK90cmFuc2Zvcm3lsZ7mgKfmiJbljIXlkKt0cmFuc2Zvcm3lsZ7mgKfnmoTliqjnlLsg5Y+q6IO95oyJ54WnY3NzM+eahOW9ouW8j+i/m+ihjCDpu5jorqTliqjnlLvnsbvlnovmmK9lYXNlLW91dAogICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fSDmjIflrprlrozmiJDliqjnlLvnmoToioLngrkKICAgICAqIEBwYXJhbSBwcm8ge1N0cmluZyB8IEFycmF5fSDlvoXmlLnlj5jnmoTlsZ7mgKcg5Y+v5Li65aSa5YC8CiAgICAgKiBAcGFyYW0gc3RhcnR2IHtTdHJpbmcgfCBOdW1iZXIgfCBBcnJheX0g6LW35aeL5YC8IOWmguS4uuaVsOe7hCDlv4XpobvkuI7mlLnlj5jlsZ7mgKfkuIDkuIDlr7nlupQg5ZCm5YiZ5Lya5oqb6ZSZCiAgICAgKiBAcGFyYW0gZW5kdiB7U3RyaW5nIHwgTnVtYmVyIHwgQXJyYXl9IOe7k+adn+WAvCDlhbfkvZPopoHmsYLlkIzotbflp4vlgLwKICAgICAqIEBwYXJhbSBkdXJhdGlvbiB7TnVtYmVyfSDliqjljJbov4fmuKHnmoTml7bpl7Qg5Y2V5L2N5Li656eSL3MKICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g5Yqo55S757uT5p2f55qE5Zue6LCD5Ye95pWwCiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fSDlhbbku5bphY3nva7pobkg5Y+v5Li656m6IOm7mOiupOS4umpz5Yqo55S7IOWKqOeUu+exu+Wei+S4uiJvY3RvcHVzLmVhc2luZy4iCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5lYXNlIHtTdHJpbmcgfCBPYmplY3R9IOWKqOeUu+exuyDlpoLmnpzkuLrlrZfnrKbkuLIg5YiZ6YeH55SoY3NzM+eahHRyYW5zaXRpb27liqjnlLsg5ZCm5YiZ6ZyA6KaB5Lyg5YWlIm9jdG9wdXMuZWFzaW5nLlhYWCLnmoTliqjnlLvlr7nosaEKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgbmV3dHdlZW4gPSBuZXcgVHdlZW4oZWwsIFsid2lkdGgiLCAid2Via2l0VHJhbnNmb3JtIl0sIFs2NCwgInRyYW5zbGF0ZTNkKDAsIDAsIDApIl0sCiAgICAgKiAgWzEyOCwgInRyYW5zbGF0ZTNkKDMwcHgsIDAsIDApIl0sIC40LCBmdW5jdGlvbigpIHsKICAgICAqICAgICBjb25zb2xlLmxvZyhBbmltYXRpb24gZmluaXNoZWQhKTsKICAgICAqIH0sIHsKICAgICAqICAgICBlYXNlOiAiZWFzZS1vdXQiIHwgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VPdXQKICAgICAqIH0pOwogICAgICogQHRocm93CiAgICAgKiBAcmV0dXJuIHtvY3RvcHVzLlR3ZWVufQogICAgICovCiAgICBvLlR3ZWVuID0gby5kZWZpbmUoewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwcm9wZXJ0eU5hbWUKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHByb3BlcnR5TmFtZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc3RhcnRWYWx1ZQogICAgICAgICAqIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgc3RhcnRWYWx1ZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZW5kVmFsdWUKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGVuZFZhbHVlOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBkdXJhdGlvbgogICAgICAgICAqIHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgZHVyYXRpb246IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGZ1bmMKICAgICAgICAgKiB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgZnVuYzogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZWFzZQogICAgICAgICAqIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgZWFzZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbmVlZFBhcmFtcwogICAgICAgICAqIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBuZWVkUGFyYW1zOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwYXJhbXNEaWNzCiAgICAgICAgICoge0FycmF5fQogICAgICAgICAqLwogICAgICAgIHBhcmFtc0RpY3M6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHJlcXVlc3RBbmltYXRpb24KICAgICAgICAgKiB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIHJlcXVlc3RBbmltYXRpb246IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNvbG9yTGlzdAogICAgICAgICAqIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBjb2xvckxpc3Q6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHN0b3BSZXF1ZXN0CiAgICAgICAgICoge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgc3RvcFJlcXVlc3Q6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHZlY3RvcgogICAgICAgICAqIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgdmVjdG9yOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwcmVmaXgKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHByZWZpeDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnRQcmVmaXgKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGV2ZW50UHJlZml4OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc09mZkNzcwogICAgICAgICAqIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzT2ZmQ3NzOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZW5kRXZlbnQKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGVuZEV2ZW50OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1RyYW5zZm9ybQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzVHJhbnNmb3JtOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnRUaW1lcgogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgZXZlbnRUaW1lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGVsYXkKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGRlbGF5OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvciBvY3RvcHVzLlR3ZWVuCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIHBybywgc3RhcnR2LCBlbmR2LCBkdXJhdGlvbiwgZnVuYywgb3B0aW9ucykgewogICAgICAgICAgICBpZighby51dGlsLmlzTm9kZShlbCkpICAgIHRocm93IG5ldyBFcnJvcigicmVxdWlyZSBhIG5vZGUhIik7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLmVsID0gZWw7CiAgICAgICAgICAgIHRoaXMucHJvcGVydHlOYW1lID0gcHJvOwogICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSBzdGFydHY7CiAgICAgICAgICAgIHRoaXMuZW5kVmFsdWUgPSBlbmR2OwogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMuZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB0aGlzLm5lZWRQYXJhbXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jb2xvckxpc3QgPSBbXTsKICAgICAgICAgICAgdGhpcy5wYXJhbXNEaWNzID0gWyJ3aWR0aCIsICJoZWlnaHQiLCAibGVmdCIsICJ0b3AiLCAicmlnaHQiLCAiYm90dG9tIiwgInBhZGRpbmciLAogICAgICAgICAgICAgICAgInBhZGRpbmctbGVmdCIsICJwYWRkaW5nLXRvcCIsICJwYWRkaW5nLWJvdHRvbSIsICJwYWRkaW5nLXJpZ2h0IiwgIm1hcmdpbiIsCiAgICAgICAgICAgICAgICAibWFyZ2luLWxlZnQiLCAibWFyZ2luLXRvcCIsICJtYXJnaW4tYm90dG9tIiwgIm1hcmdpbi1yaWdodCIsICJmb250LXNpemUiLAogICAgICAgICAgICAgICAgImJhY2tncm91bmQtcG9zaXRpb24iLCAibGluZS1oZWlnaHQiLCAiYm9yZGVyLXdpZHRoIiwgImJvcmRlci1sZWZ0LXdpZHRoIiwKICAgICAgICAgICAgICAgICJib3JkZXItdG9wLXdpZHRoIiwgImJvcmRlci1yaWdodC13aWR0aCIsICJib3JkZXItYm90dG9tLXdpZHRoIl07CiAgICAgICAgICAgIHZhciBsZWdhbGl0eSA9IHRoaXMuY2hlY2soKTsKICAgICAgICAgICAgdGhpcy5lYXNlID0gdGhpcy5lYXNlIHx8ICh0aGlzLmlzVHJhbnNmb3JtID8gImVhc2Utb3V0IiA6IG8uZWFzaW5nLmxpbmVhci5lYXNlT3V0KTsKICAgICAgICAgICAgdGhpcy5kZWxheSA9IHRoaXMuZGVsYXkgfHwgMDsKICAgICAgICAgICAgaWYoIWxlZ2FsaXR5KSB0aHJvdyBuZXcgRXJyb3IoIklsbGVnYWwgYXJndW1lbnRzISIpOwogICAgICAgICAgICBpZihvLnV0aWwuaXNPYmplY3QodGhpcy5lYXNlKSAmJiAhdGhpcy5pc1RyYW5zZm9ybSkgewogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uID0gby51dGlsLnJlcXVlc3RBbmltYXRpb247CiAgICAgICAgICAgICAgICBpZih0aGlzLmRlbGF5ID4gMCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5leGVjdXRlV2l0aEpzKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcy5kZWxheSAqIDEwMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGVXaXRoSnMoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMudmVjdG9yID0geyIiIDogIiIsIFdlYmtpdDogIndlYmtpdCIsIE1vejogIiIsIE86ICJvIiwgbXM6ICJNUyJ9OwogICAgICAgICAgICAgICAgZm9yKHZhciBrIGluIHRoaXMudmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZWwuc3R5bGVbayArICJUcmFuc2l0aW9uUHJvcGVydHkiXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJlZml4ID0gJy0nICsgay50b0xvd2VyQ2FzZSgpICsgJy0nCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRQcmVmaXggPSB0aGlzLnZlY3RvcltrXQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmlzT2ZmQ3NzID0gKHRoaXMuZXZlbnRQcmVmaXggPT0gbnVsbCAmJiB0aGlzLmVsLnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9PSB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgdGhpcy5lbmRFdmVudCA9IHRoaXMuZXZlbnRQcmVmaXggPyB0aGlzLmV2ZW50UHJlZml4ICsgIlRyYW5zaXRpb25FbmQiIDogInRyYW5zaXRpb25FbmQiOwogICAgICAgICAgICAgICAgdGhpcy5leGVjdXRlV2l0aENzcygpOwogICAgICAgICAgICB9CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjaGVjawogICAgICAgICAqIEBkZXNjIOajgOafpeWPguaVsOaYr+WQpm9rCiAgICAgICAgICovCiAgICAgICAgY2hlY2s6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcXVldWUgPSBvLnV0aWwuaXNBcnJheSh0aGlzLnByb3BlcnR5TmFtZSkgJiYKICAgICAgICAgICAgICAgICAgICBvLnV0aWwuaXNBcnJheSh0aGlzLnN0YXJ0VmFsdWUpICYmIG8udXRpbC5pc0FycmF5KHRoaXMuZW5kVmFsdWUpLAogICAgICAgICAgICAgICAgcGFzcyA9IGZhbHNlLAogICAgICAgICAgICAgICAgX3Bhc3M7CiAgICAgICAgICAgIGlmKCFxdWV1ZSl7CiAgICAgICAgICAgICAgICB0aGlzLnByb3BlcnR5TmFtZSA9IFt0aGlzLnByb3BlcnR5TmFtZV07CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSBbdGhpcy5zdGFydFZhbHVlXTsKICAgICAgICAgICAgICAgIHRoaXMuZW5kVmFsdWUgPSBbdGhpcy5lbmRWYWx1ZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmFtc01hdGNoID0gKHRoaXMucHJvcGVydHlOYW1lLmxlbmd0aCA9PSB0aGlzLnN0YXJ0VmFsdWUubGVuZ3RoKSAmJgogICAgICAgICAgICAgICAgICAgICh0aGlzLnN0YXJ0VmFsdWUubGVuZ3RoID09IHRoaXMuZW5kVmFsdWUubGVuZ3RoKTsKICAgICAgICAgICAgaWYocGFyYW1zTWF0Y2gpIHsKICAgICAgICAgICAgICAgIHZhciB1bk9rID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgbGVuID0gdGhpcy5wcm9wZXJ0eU5hbWUubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGkgPSBsZW47CiAgICAgICAgICAgICAgICBmb3IoOyBpLS07ICkgewogICAgICAgICAgICAgICAgICAgIF9wYXNzID0gdGhpcy5jaGVja1ZhbHVlKHRoaXMucHJvcGVydHlOYW1lW2ldLCB0aGlzLnN0YXJ0VmFsdWVbaV0sIHRoaXMuZW5kVmFsdWVbaV0pOwogICAgICAgICAgICAgICAgICAgIGlmKCFfcGFzcykgewogICAgICAgICAgICAgICAgICAgICAgICB1bk9rID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZWVkUGFyYW1zW2ldID0gdGhpcy5wYXJhbXNEaWNzLmluZGV4T2YodGhpcy5wcm9wZXJ0eU5hbWVbaV0pICE9IC0xOwogICAgICAgICAgICAgICAgICAgIHZhciBpc0NvbG9yID0gbmV3IFJlZ0V4cCgiL2NvbG9yfGJhY2tncm91bmQtY29sb3J8Ym9yZGVyLWNvbG9yL2kiKS50ZXN0KHRoaXMucHJvcGVydHlOYW1lW2ldKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbG9yTGlzdFtpXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgaXNDb2xvcjogaXNDb2xvciwKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRWYWx1ZTogaXNDb2xvciA/IHRoaXMuZ2V0Q29sb3IodGhpcy5zdGFydFZhbHVlW2ldKSA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgIGVuZFZhbHVlOiBpc0NvbG9yID8gdGhpcy5nZXRDb2xvcih0aGlzLmVuZFZhbHVlW2ldKSA6IG51bGwKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFzcyA9ICF1bk9rICYmICFpc05hTih0aGlzLmR1cmF0aW9uKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhc3MgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFzczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgY2hlY2tWYWx1ZQogICAgICAgICAqIEBkZXNjIOmqjOivgeWAvOaYr+WQpuWQiOazlQogICAgICAgICAqLwogICAgICAgIGNoZWNrVmFsdWU6IGZ1bmN0aW9uKHByb3BlcnR5TmFtZSwgc3RhcnRWYWx1ZSwgZW5kVmFsdWUpewogICAgICAgICAgICB2YXIgcGFzcyA9IGZhbHNlOwogICAgICAgICAgICBpZigvdHJhbnNmb3JtL2kudGVzdChwcm9wZXJ0eU5hbWUpIHx8IC8td2Via2l0LS9pLnRlc3QocHJvcGVydHlOYW1lKSkgewogICAgICAgICAgICAgICAgdGhpcy5pc1RyYW5zZm9ybSA9IHRydWU7CiAgICAgICAgICAgICAgICBwYXNzID0gISFzdGFydFZhbHVlICYmIG8udXRpbC5pc1N0cmluZyhzdGFydFZhbHVlKSAmJiAhIWVuZFZhbHVlICYmIG8udXRpbC5pc1N0cmluZyhlbmRWYWx1ZSkKICAgICAgICAgICAgfSBlbHNlIGlmKHByb3BlcnR5TmFtZS5pbmRleE9mKCdjb2xvcicpICE9IC0xKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVnID0gLyheXHMqKXwoXHMqJCkvZzsKICAgICAgICAgICAgICAgIHBhc3MgPSAhIXN0YXJ0VmFsdWUgJiYgc3RhcnRWYWx1ZS5yZXBsYWNlKHJlZywgJycpICE9ICcnICYmICEhIGVuZFZhbHVlICYmIGVuZFZhbHVlLnJlcGxhY2UocmVnLCAnJykgIT0gJycKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhc3MgPSAhaXNOYU4oc3RhcnRWYWx1ZSkgJiYgIWlzTmFOKGVuZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFzczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0Q29sb3IKICAgICAgICAgKi8KICAgICAgICBnZXRDb2xvcjogZnVuY3Rpb24oc3RyKSB7CiAgICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKC8oXlxzKil8KFxzKiQpL2csICcnKTsKICAgICAgICAgICAgdmFyIHJnYlJlZyA9IC9eXHMqcmdiXHMqXChccypcZHsxLDN9XHMqXCxccypcZHsxLDN9XHMqXCxccypcZHsxLDN9XHMqXClccyokL2k7CiAgICAgICAgICAgIHZhciBzaXhSZWdBID0gL15ccypcI1thLXpBLVowLTldezN9XHMqJC87CiAgICAgICAgICAgIHZhciBzaXhSZWdCID0gL15ccypcI1thLXpBLVowLTldezZ9XHMqJC87CiAgICAgICAgICAgIHZhciBhcnIgPSBbXTsKICAgICAgICAgICAgaWYocmdiUmVnLnRlc3Qoc3RyKSl7IC8vIOS7pVJHQuW9ouW8j+aMh+WumueahOminOiJsgogICAgICAgICAgICAgICAgdmFyIG5TdHIgPSBzdHIuc3BsaXQoJygnKVsxXS5zcGxpdCgnKScpWzBdLnNwbGl0KCcsJyk7CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwIDsgaSA8IG5TdHIubGVuZ3RoIDsgaSArKyl7CiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goblN0cltpXSAvIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGFycjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihzaXhSZWdCLnRlc3Qoc3RyKSkgeyAvLyDku6UxNui/m+WItuaMh+WumuminOiJsiAoNuS9jSkKICAgICAgICAgICAgICAgIHZhciBtID0gc3RyLnJlcGxhY2UoJyMnLCAnJykubWF0Y2goLyhcd3xcZCl7Mn0vZyk7CgogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCA7IGkgPCBtLmxlbmd0aDsgaSArKyl7CiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goTnVtYmVyKCcweCcgKyBtW2ldKS50b1N0cmluZygxMCkgLyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoc2l4UmVnQS50ZXN0KHN0cikpeyAvLyDku6UxNui/m+WItuaMh+WumuminOiJsigz5L2NKQogICAgICAgICAgICAgICAgdmFyIGNBcnIgPSBzdHIucmVwbGFjZSgnIycsICcnKS5zcGxpdCgnJyk7CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwIDsgaSA8IGNBcnIubGVuZ3RoIDsgaSArKyl7CiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goTnVtYmVyKCcweCcgKyAoY0FycltpXSArIGNBcnJbaV0pKS50b1N0cmluZygxMCkgLyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGV4ZWN1dGVXaXRoSnMKICAgICAgICAgKiDmiafooYwKICAgICAgICAgKi8KICAgICAgICBleGVjdXRlV2l0aEpzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5zdG9wUmVxdWVzdCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBjdXJUaW1lID0gMDsKICAgICAgICAgICAgdmFyIGFuaW1hdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LmVsIHx8IHRoYXQuc3RvcFJlcXVlc3QpewogICAgICAgICAgICAgICAgICAgIHRoYXQuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoYXQuZ2V0U2V0VmFsdWUoY3VyVGltZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgaWYoY3VyVGltZSA+PSB0aGF0LmR1cmF0aW9uICogMTAwMCl7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5nZXRTZXRWYWx1ZShudWxsLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgdGhhdC5mdW5jICYmIHRoYXQuZnVuYygpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuZWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1clRpbWUgKz0gMTY7CiAgICAgICAgICAgICAgICB0aGF0LnJlcXVlc3RBbmltYXRpb24oYW5pbWF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uKGFuaW1hdGUsIHRoaXMuZWwpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBleGVjdXRlV2l0aENzcwogICAgICAgICAqLwogICAgICAgIGV4ZWN1dGVXaXRoQ3NzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy5pc09mZkNzcykgdGhpcy5kdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHZhciBwcm9hcnIgPSB0aGlzLnByb3BlcnR5TmFtZSwKICAgICAgICAgICAgICAgIGxlbiA9IHByb2Fyci5sZW5ndGgsCiAgICAgICAgICAgICAgICB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25BcnIgPSBbXSwKICAgICAgICAgICAgICAgIF9wcmVmaXggPSB0aGlzLnByZWZpeCArICJ0cmFuc2l0aW9uIjsKICAgICAgICAgICAgdGhpcy5lbC5zdHlsZVtfcHJlZml4XSA9ICIiOwogICAgICAgICAgICBvLnV0aWwuZWFjaChwcm9hcnIsIGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CiAgICAgICAgICAgICAgICB0aGF0LmVsLnN0eWxlW2l0ZW1dID0gdGhhdC5nZXRWYWx1ZSh0aGF0LnN0YXJ0VmFsdWVbaW5kZXhdLCBpbmRleCk7CiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uQXJyLnB1c2goaXRlbSArICIgIiArIHRoYXQuZHVyYXRpb24gKyAicyAiICsgdGhhdC5lYXNlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIG8uZXZlbnQub24odGhpcy5lbCwgdGhpcy5lbmRFdmVudCwgby51dGlsLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcy5vbkVuZEV2ZW50Q29tcGxldGVkLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoYXQuZWwuc3R5bGVbX3ByZWZpeF0gPSB0cmFuc2l0aW9uQXJyLmpvaW4oIiwgIik7CiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGF0OwogICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHogPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcig7IHogPCBsZW47IHorKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY3VyVmFsdWUgPSBfdGhpcy5lbmRWYWx1ZVt6XTsKICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZWwuc3R5bGVbcHJvYXJyW3pdXSA9IF90aGlzLmdldFZhbHVlKGN1clZhbHVlLCB6KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2xlYXJFdmVudFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuZXZlbnRUaW1lciA9IHNldFRpbWVvdXQoby51dGlsLmJpbmQoX3RoaXMub25GaW5pc2gsIF90aGlzKSwgX3RoaXMuZHVyYXRpb24gKiAxMDAwKTsKCiAgICAgICAgICAgICAgICB9LCB0aGF0LmRlbGF5ICogMTAwMCk7CiAgICAgICAgICAgIH0sIDApOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjbGVhckV2ZW50VGltZXIKICAgICAgICAgKi8KICAgICAgICBjbGVhckV2ZW50VGltZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmV2ZW50VGltZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy5ldmVudFRpbWVyKTsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRUaW1lciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25GaW5pc2gKICAgICAgICAgKi8KICAgICAgICBvbkZpbmlzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMuZWwpIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcEV2ZW50T2JzZXJ2ZXIodGhpcy5lbCwgdGhpcy5lbmRFdmVudCk7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlW3RoaXMucHJlZml4ICsgInRyYW5zaXRpb24iXSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZnVuYyAmJiB0aGlzLmZ1bmMoKTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uRW5kRXZlbnRDb21wbGV0ZWQKICAgICAgICAgKi8KICAgICAgICBvbkVuZEV2ZW50Q29tcGxldGVkOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGlmKGUudGFyZ2V0ICE9PSBlLmN1cnJlbnRUYXJnZXQpICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jbGVhckV2ZW50VGltZXIoKTsKICAgICAgICAgICAgdGhpcy5vbkZpbmlzaCgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5Ud2Vlbi5zdG9wCiAgICAgICAgICogQGRlc2Mg5YGc5o6J5Yqo55S7IOW5tuino+iEseiHquaIkQogICAgICAgICAqLwogICAgICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmVuZEV2ZW50ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcFJlcXVlc3QgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5mdW5jICYmIHRoaXMuZnVuYygpOwogICAgICAgICAgICAgICAgaWYodGhpcy5lbCkgewogICAgICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcEV2ZW50T2JzZXJ2ZXIodGhpcy5lbCwgdGhpcy5lbmRFdmVudCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbC5zdHlsZVt0aGlzLnByZWZpeCArICJ0cmFuc2l0aW9uIl0gPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuVHdlZW4uZGVzdHJveQogICAgICAgICAqIEBkZXNjIOeci+WQjeWtl+WwseefpemBk+W5suWYm+eahAogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmVsID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0U2V0VmFsdWUKICAgICAgICAgKiBAZGVzYyDlj5blh7rlvZPliY3nmoTlsZ7mgKflgLwKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIGN1clRpbWUgIC0gICB7TnVtYmVyfQogICAgICAgICAqIGlzRW5kICAgIC0gICB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBnZXRTZXRWYWx1ZTogZnVuY3Rpb24oY3VyVGltZSwgaXNFbmQpIHsKICAgICAgICAgICAgdmFyIHZhbHVlSW5mbyA9IFtdLAogICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICBpTGVuID0gdGhpcy5wcm9wZXJ0eU5hbWUubGVuZ3RoOwogICAgICAgICAgICBmb3IoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VyVmFsdWU7CiAgICAgICAgICAgICAgICBpZih0aGlzLmNvbG9yTGlzdFtpXS5pc0NvbG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0UlIgPSB0aGlzLmNvbG9yTGlzdFtpXS5zdGFydFZhbHVlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBzdGFydEdHID0gdGhpcy5jb2xvckxpc3RbaV0uc3RhcnRWYWx1ZVsxXSwKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRCQiA9IHRoaXMuY29sb3JMaXN0W2ldLnN0YXJ0VmFsdWVbMl0sCgogICAgICAgICAgICAgICAgICAgICAgICBlbmRSUiA9IHRoaXMuY29sb3JMaXN0W2ldLmVuZFZhbHVlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBlbmRHRyA9IHRoaXMuY29sb3JMaXN0W2ldLmVuZFZhbHVlWzFdLAogICAgICAgICAgICAgICAgICAgICAgICBlbmRCQiA9IHRoaXMuY29sb3JMaXN0W2ldLmVuZFZhbHVlWzJdOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcnIsIGdnLCBiYjsKICAgICAgICAgICAgICAgICAgICBpZihpc0VuZCkgewogICAgICAgICAgICAgICAgICAgICAgICByciA9IGVuZFJSOwogICAgICAgICAgICAgICAgICAgICAgICBnZyA9IGVuZEdHOwogICAgICAgICAgICAgICAgICAgICAgICBiYiA9IGVuZEJCOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJyID0gTWF0aC5jZWlsKHRoaXMuZWFzZShjdXJUaW1lLCBzdGFydFJSLCBlbmRSUiAtIHN0YXJ0UlIsIHRoaXMuZHVyYXRpb24gKiAxMDAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdnID0gTWF0aC5jZWlsKHRoaXMuZWFzZShjdXJUaW1lLCBzdGFydEdHLCBlbmRHRyAtIHN0YXJ0R0csIHRoaXMuZHVyYXRpb24gKiAxMDAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJiID0gTWF0aC5jZWlsKHRoaXMuZWFzZShjdXJUaW1lLCBzdGFydEJCLCBlbmRCQiAtIHN0YXJ0QkIsIHRoaXMuZHVyYXRpb24gKiAxMDAwKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1clZhbHVlID0gJ3JnYignICsgcnIgKyAnLCAnICsgZ2cgKyAnLCAnICsgYmIgKyAnKSc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmKGlzRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1clZhbHVlID0gdGhpcy5lbmRWYWx1ZVtpXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJWYWx1ZSA9IHRoaXMuZWFzZShjdXJUaW1lLCB0aGlzLnN0YXJ0VmFsdWVbaV0sIHRoaXMuZW5kVmFsdWVbaV0gLSB0aGlzLnN0YXJ0VmFsdWVbaV0sIHRoaXMuZHVyYXRpb24gKiAxMDAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YWx1ZUluZm8ucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlOYW1lOiB0aGlzLnByb3BlcnR5TmFtZVtpXSwKICAgICAgICAgICAgICAgICAgICBjdXJWYWx1ZSA6IGN1clZhbHVlLAogICAgICAgICAgICAgICAgICAgIGlzQ29sb3I6IHRoaXMuY29sb3JMaXN0W2ldLmlzQ29sb3IKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodmFsdWVJbmZvKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNldFZhbHVlCiAgICAgICAgICogQGRlc2Mg5pS55Y+Y5YC8CiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlSW5mbykgewogICAgICAgICAgICB2YXIgc2V0SW5mbyA9IHt9LAogICAgICAgICAgICAgICAgbmVlZFNldCA9IGZhbHNlLAogICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICBpTGVuID0gdmFsdWVJbmZvLmxlbmd0aDsKICAgICAgICAgICAgZm9yKDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHZhbHVlSW5mb1tpXS5wcm9wZXJ0eU5hbWUsCiAgICAgICAgICAgICAgICAgICAgY3VyVmFsdWUgPSB2YWx1ZUluZm9baV0uY3VyVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgaXNDb2xvciA9IHZhbHVlSW5mb1tpXS5pc0NvbG9yOwogICAgICAgICAgICAgICAgaWYocHJvcGVydHlOYW1lID09ICdzY3JvbGxMZWZ0JyB8fCBwcm9wZXJ0eU5hbWUgPT0gJ3Njcm9sbFRvcCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsW3Byb3BlcnR5TmFtZV0gPSB0aGlzLmdldFZhbHVlKGN1clZhbHVlLCBpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SW5mb1twcm9wZXJ0eU5hbWVdID0gaXNDb2xvciA/IGN1clZhbHVlIDogdGhpcy5nZXRWYWx1ZShjdXJWYWx1ZSwgaSk7CiAgICAgICAgICAgICAgICAgICAgbmVlZFNldCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKG5lZWRTZXQpIHsKICAgICAgICAgICAgICAgIGZvcih2YXIga2V5IGluIHNldEluZm8pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlW2tleV0gPSBzZXRJbmZvW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0VmFsdWUKICAgICAgICAgKiBAcGFyYW0gdmFsdWUgICAgLSAgIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIG9yZGVyICAgIC0gICB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgb3JkZXIpewogICAgICAgICAgICByZXR1cm4gdGhpcy5uZWVkUGFyYW1zW29yZGVyXSA/IHZhbHVlICsgJ3B4JyA6IHZhbHVlOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLlR3ZWVuIgogICAgfSk7CgogICAgLyoqCiAgICAgKiBAY2xhc3Mgb2N0b3B1cy5TdGVwVHdlZW4KICAgICAqLwogICAgby5TdGVwVHdlZW4gPSBvLmRlZmluZSh7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHR5cGUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOaViOaenOS8mOWFiOaIluaAp+iDveS8mOWFiAogICAgICAgICAqLwogICAgICAgIHR5cGU6ICJub3JtYWwiLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlYXNlCiAgICAgICAgICovCiAgICAgICAgZWFzZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc3RhcnRWYWx1ZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgc3RhcnRWYWx1ZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZW5kVmFsdWUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGVuZFZhbHVlOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBkdXJhdGlvbgogICAgICAgICAqIEBkZXNjIOS4jm9jdG9wdXMudHdlZW7kuI3lkIwg6L+Z6YeM55qEZHVyYXRpb27ooajnpLrliqjnlLvmiafooYznmoTmrKHmlbAKICAgICAgICAgKi8KICAgICAgICBkdXJhdGlvbjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZnVuYwogICAgICAgICAqIEB0eXBlIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICBmdW5jOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjb3VudAogICAgICAgICAqLwogICAgICAgIGNvdW50OiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwbGF5aW5nCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOagh+W/l+aYr+WQpuWcqOWKqOeUuwogICAgICAgICAqLwogICAgICAgIHBsYXlpbmc6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBwYXJhbSBvcHRpb25zCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICBvLmV4dGVuZCh0aGlzLCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5lYXNlID0gdGhpcy5lYXNlIHx8IG8uZWFzaW5nLmV4cG8uZWFzZU91dDsKICAgICAgICAgICAgdGhpcy5zdGFydCh0aGlzLnN0YXJ0VmFsdWUsIHRoaXMuZW5kVmFsdWUsIHRoaXMuZHVyYXRpb24sIHRoaXMuZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHN0YXJ0CiAgICAgICAgICogQHBhcmFtIHN0YXJ0VmFsdWUKICAgICAgICAgKiBAcGFyYW0gZW5kVmFsdWUKICAgICAgICAgKiBAcGFyYW0gZHVyYXRpb24KICAgICAgICAgKiBAcGFyYW0gZnVuYwogICAgICAgICAqLwogICAgICAgIHN0YXJ0OiBmdW5jdGlvbihzdGFydFZhbHVlLCBlbmRWYWx1ZSwgZHVyYXRpb24sIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5wbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zdGFydFZhbHVlID0gc3RhcnRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5lbmRWYWx1ZSA9IGVuZFZhbHVlOwogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMuZnVuYyA9IGZ1bmM7CiAgICAgICAgICAgIHRoaXMuY291bnQgPSAwOwogICAgICAgICAgICBpZih0aGlzLmZ1bmMgJiYgdGhpcy5mdW5jLnN0YXJ0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bmMuc3RhcnQuY2FsbCh0aGlzLCB0aGlzLnN0YXJ0VmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoaXMucGxheSwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuU3RlcFR3ZWVuLnN0b3AKICAgICAgICAgKiBAZGVzYyDlgZzmraLliqjnlLsKICAgICAgICAgKi8KICAgICAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYoIXRoaXMucGxheWluZykgcmV0dXJuOwoKICAgICAgICAgICAgaWYodGhpcy5mdW5jICYmIHRoaXMuZnVuYy5kb25lKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bmMuZG9uZS5jYWxsKHRoaXMsIHRoaXMuZW5kVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZGVzdHJveQogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmZ1bmMgPSBudWxsOwogICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSBudWxsOwogICAgICAgICAgICB0aGlzLmVuZFZhbHVlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY291bnQgPSBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBwbGF5CiAgICAgICAgICovCiAgICAgICAgcGxheTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMucGxheWluZyA9PSBmYWxzZSkJcmV0dXJuOwogICAgICAgICAgICB2YXIgdmFsdWUgPSB7fTsKICAgICAgICAgICAgZm9yKHZhciBrIGluIHRoaXMuc3RhcnRWYWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGIgPSB0aGlzLnN0YXJ0VmFsdWVba107CiAgICAgICAgICAgICAgICB2YXIgZiA9IHRoaXMuZW5kVmFsdWVba107CiAgICAgICAgICAgICAgICBpZihiID09IG51bGwgfHwgZiA9PSBudWxsIHx8IGlzTmFOKGIpIHx8IGlzTmFOKGYpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIHZhbHVlIGZvciBUd2VlbicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGMgPSBmIC0gYjsKICAgICAgICAgICAgICAgIHZhbHVlW2tdID0gdGhpcy5lYXNlLmFwcGx5KHRoaXMsIFt0aGlzLmNvdW50LCBiLCBjLCB0aGlzLmR1cmF0aW9uXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jb3VudCsrOwogICAgICAgICAgICBpZih0aGlzLmZ1bmMgJiYgdGhpcy5mdW5jLmVhY2hTdGVwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bmMuZWFjaFN0ZXAuY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5jb3VudCA+IHRoaXMuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoaXMucGxheSwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLlN0ZXBUd2VlbiIKICAgIH0pOwoKICAgIC8qKgogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzLmVhc2luZwogICAgICogQGRlc2Mg5Yqo55S75pa55rOVIOavj+S4quaWueazlemDveWMheaLrCAiZWFzZUluIiDmuJDlv6sgImVhc2VPdXQiIOa4kOaFoiAiZWFzZUluT3V0IiDnuqDnu5PnmoTkuInkuKrlgLzlj6/pgIkKICAgICAqLwogICAgby5lYXNpbmcgPSBvLmVhc2luZyB8fCB7fTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLmxpbmVhcgogICAgICogQGRlc2Mg57q/5oCn5Yqo55S7CiAgICAgKi8KICAgIG8uZWFzaW5nLmxpbmVhciA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VJbgogICAgICAgICAqIEBkZXNjIOe6v+aAp+a4kOW/qwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW4KICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluOiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjKnQvZCArIGI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VPdXQKICAgICAgICAgKiBAZGVzYyDnur/mgKfmuJDmhaIKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZU91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjKnQvZCArIGI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6v+aAp+e6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjKnQvZCArIGI7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLmV4cG8KICAgICAqIEBkZXNjIOaMh+aVsOabsue6v+eahOe8k+WKqAogICAgICoKICAgICAqLwogICAgby5lYXNpbmcuZXhwbyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmV4cG8uZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuICh0PT0wKSA/IGIgOiBjICogTWF0aC5wb3coMiwgMTAgKiAodC9kIC0gMSkpICsgYjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuZXhwby5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gKHQ9PWQpID8gYitjIDogYyAqICgtTWF0aC5wb3coMiwgLTEwICogdC9kKSArIDEpICsgYjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuZXhwby5lYXNlSW5PdXQKICAgICAgICAgKiBAZGVzYyDnuqDnu5MKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbk91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICBpZiAodD09MCkgcmV0dXJuIGI7CiAgICAgICAgICAgIGlmICh0PT1kKSByZXR1cm4gYitjOwogICAgICAgICAgICBpZiAoKHQvPWQvMikgPCAxKSByZXR1cm4gYy8yICogTWF0aC5wb3coMiwgMTAgKiAodCAtIDEpKSArIGI7CiAgICAgICAgICAgIHJldHVybiBjLzIgKiAoLU1hdGgucG93KDIsIC0xMCAqIC0tdCkgKyAyKSArIGI7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLnF1YWQKICAgICAqIEBkZXNjIOS6jOasoeaWueeahOe8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5xdWFkID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcucXVhZC5lYXNlSW4KICAgICAgICAgKiBAZGVzYyDmuJDlv6sKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluCiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbjogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyoodC89ZCkqdCArIGI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1YWQuZWFzZU91dAogICAgICAgICAqIEBkZXNjIOa4kOaFogogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VPdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC1jICoodC89ZCkqKHQtMikgKyBiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5xdWFkLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmICgodC89ZC8yKSA8IDEpIHJldHVybiBjLzIqdCp0ICsgYjsKICAgICAgICAgICAgcmV0dXJuIC1jLzIgKiAoKC0tdCkqKHQtMikgLSAxKSArIGI7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLmJhY2sKICAgICAqIEBkZXNjIOWcqOi/h+a4oeiMg+WbtOWklueahOS4gOerr+aIluS4pOerr+aJqeWxleWKqOeUu+S4gOasoe+8jOS7peS6p+eUn+S7juWFtuiMg+WbtOWkluWbnuaLieeahOaViOaenOOAggogICAgICog6YCa5L+X6K6y5bCx5piv5YWI5ZCR5ZCOIOWGjeWQkeWPjeaWueWQkQogICAgICovCiAgICBvLmVhc2luZy5iYWNrID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuYmFjay5lYXNlSW4KICAgICAgICAgKiBAZGVzYyDmuJDlv6sKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluCiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbjogZnVuY3Rpb24odCwgYiwgYywgZCwgcykgewogICAgICAgICAgICBpZiAocyA9PSB1bmRlZmluZWQpIHMgPSAxLjcwMTU4OwogICAgICAgICAgICByZXR1cm4gYyAqICh0IC89IGQpICogdCAqICgocyArIDEpICogdCAtIHMpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5iYWNrLmVhc2VPdXQKICAgICAgICAgKiBAZGVzYyDmuJDmhaIKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZU91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkLCBzKSB7CiAgICAgICAgICAgIGlmIChzID09IHVuZGVmaW5lZCkgcyA9IDEuNzAxNTg7CiAgICAgICAgICAgIHJldHVybiBjICogKCh0ID0gdCAvIGQgLSAxKSAqIHQgKiAoKHMgKyAxKSAqIHQgKyBzKSArIDEpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5iYWNrLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkLCBzKSB7CiAgICAgICAgICAgIGlmIChzID09IHVuZGVmaW5lZCkgcyA9IDEuNzAxNTg7CiAgICAgICAgICAgIGlmICgodCAvPSBkIC8gMikgPCAxKSByZXR1cm4gYyAvIDIgKiAodCAqIHQgKiAoKChzICo9ICgxLjUyNSkpICsgMSkgKiB0IC0gcykpICsgYjsKICAgICAgICAgICAgcmV0dXJuIGMgLyAyICogKCh0IC09IDIpICogdCAqICgoKHMgKj0gKDEuNTI1KSkgKyAxKSAqIHQgKyBzKSArIDIpICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5ib3VuY2UKICAgICAqIEBkZXNjIOWcqOi/h+a4oeiMg+WbtOeahOS4gOerr+aIluS4pOerr+WGhea3u+WKoOW8uei3s+aViOaenOOAguexu+S8vOS4gOS4queQg+iQveWQkeWcsOadv+WPiOW8uei1t+WQju+8jOWHoOasoemAkOa4kOWHj+Wwj+eahOWbnuW8uei/kOWKqAogICAgICovCiAgICBvLmVhc2luZy5ib3VuY2UgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5ib3VuY2UuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgLSBvLmVhc2luZy5ib3VuY2UuZWFzZU91dChkIC0gdCwgMCwgYywgZCkgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmJvdW5jZS5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICBpZiAoKHQgLz0gZCkgPCAoMSAvIDIuNzUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiB0ICogdCkgKyBiCiAgICAgICAgICAgIH0gZWxzZSBpZiAodCA8ICgyIC8gMi43NSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjICogKDcuNTYyNSAqICh0IC09ICgxLjUgLyAyLjc1KSkgKiB0ICsgLjc1KSArIGIKICAgICAgICAgICAgfSBlbHNlIGlmICh0IDwgKDIuNSAvIDIuNzUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiAodCAtPSAoMi4yNSAvIDIuNzUpKSAqIHQgKyAuOTM3NSkgKyBiCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiAodCAtPSAoMi42MjUgLyAyLjc1KSkgKiB0ICsgLjk4NDM3NSkgKyBiCiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuYm91bmNlLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmICh0IDwgZCAvIDIpIHJldHVybiBvLmVhc2luZy5ib3VuY2UuZWFzZUluKHQgKiAyLCAwLCBjLCBkKSAqIC41ICsgYjsKICAgICAgICAgICAgZWxzZSByZXR1cm4gby5lYXNpbmcuYm91bmNlLmVhc2VPdXQodCAqIDIgLSBkLCAwLCBjLCBkKSAqIC41ICsgYyAqIC41ICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5lbGFzdGljCiAgICAgKiBAZGVzYyDmt7vliqDkuIDnq6/miJbkuKTnq6/otoXlh7rov4fmuKHojIPlm7TnmoTlvLnmgKfmlYjmnpwg5YW25Lit55qE6L+Q5Yqo55Sx5oyJ54Wn5oyH5pWw5pa55byP6KGw5YeP55qE5q2j5bym5rOi5p2l5a6a5LmJCiAgICAgKiDmjIfmlbDoobDlh4/nmoTmraPlvKbmm7Lnur/nvJPliqgKICAgICAqLwogICAgby5lYXNpbmcuZWxhc3RpYyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmVsYXN0aWMuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQsIGEsIHApIHsKICAgICAgICAgICAgaWYgKHQgPT0gMCkgcmV0dXJuIGI7CiAgICAgICAgICAgIGlmICgodCAvPSBkKSA9PSAxKSByZXR1cm4gYiArIGM7CiAgICAgICAgICAgIGlmICghcCkgcCA9IGQgKiAuMzsKICAgICAgICAgICAgaWYgKCFhIHx8IGEgPCBNYXRoLmFicyhjKSkgewogICAgICAgICAgICAgICAgYSA9IGM7CiAgICAgICAgICAgICAgICB2YXIgcyA9IHAgLyA0CiAgICAgICAgICAgIH0gZWxzZSB2YXIgcyA9IHAgLyAoMiAqIE1hdGguUEkpICogTWF0aC5hc2luKGMgLyBhKTsKICAgICAgICAgICAgcmV0dXJuIC0gKGEgKiBNYXRoLnBvdygyLCAxMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0ICogZCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApKSArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuZWxhc3RpYy5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCwgYSwgcCkgewogICAgICAgICAgICBpZiAodCA9PSAwKSByZXR1cm4gYjsKICAgICAgICAgICAgaWYgKCh0IC89IGQpID09IDEpIHJldHVybiBiICsgYzsKICAgICAgICAgICAgaWYgKCFwKSBwID0gZCAqIC4zOwogICAgICAgICAgICBpZiAoIWEgfHwgYSA8IE1hdGguYWJzKGMpKSB7CiAgICAgICAgICAgICAgICBhID0gYzsKICAgICAgICAgICAgICAgIHZhciBzID0gcCAvIDQKICAgICAgICAgICAgfSBlbHNlIHZhciBzID0gcCAvICgyICogTWF0aC5QSSkgKiBNYXRoLmFzaW4oYyAvIGEpOwogICAgICAgICAgICByZXR1cm4gKGEgKiBNYXRoLnBvdygyLCAtMTAgKiB0KSAqIE1hdGguc2luKCh0ICogZCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApICsgYyArIGIpCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmVsYXN0aWMuZWFzZUluT3V0CiAgICAgICAgICogQGRlc2Mg57qg57uTCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbk91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW5PdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQsIGEsIHApIHsKICAgICAgICAgICAgaWYgKHQgPT0gMCkgcmV0dXJuIGI7CiAgICAgICAgICAgIGlmICgodCAvPSBkIC8gMikgPT0gMikgcmV0dXJuIGIgKyBjOwogICAgICAgICAgICBpZiAoIXApIHAgPSBkICogKC4zICogMS41KTsKICAgICAgICAgICAgaWYgKCFhIHx8IGEgPCBNYXRoLmFicyhjKSkgewogICAgICAgICAgICAgICAgYSA9IGM7CiAgICAgICAgICAgICAgICB2YXIgcyA9IHAgLyA0CiAgICAgICAgICAgIH0gZWxzZSB2YXIgcyA9IHAgLyAoMiAqIE1hdGguUEkpICogTWF0aC5hc2luKGMgLyBhKTsKICAgICAgICAgICAgaWYgKHQgPCAxKSByZXR1cm4gLSAuNSAqIChhICogTWF0aC5wb3coMiwgMTAgKiAodCAtPSAxKSkgKiBNYXRoLnNpbigodCAqIGQgLSBzKSAqICgyICogTWF0aC5QSSkgLyBwKSkgKyBiOwogICAgICAgICAgICByZXR1cm4gYSAqIE1hdGgucG93KDIsIC0xMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0ICogZCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApICogLjUgKyBjICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5jaXJjCiAgICAgKiBAZGVzYyDlnIblvaLmm7Lnur/nmoTnvJPliqgKICAgICAqLwogICAgby5lYXNpbmcuY2lyYyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmNpcmMuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC0gYyAqIChNYXRoLnNxcnQoMSAtICh0IC89IGQpICogdCkgLSAxKSArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuY2lyYy5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqIE1hdGguc3FydCgxIC0gKHQgPSB0IC8gZCAtIDEpICogdCkgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmNpcmMuZWFzZUluT3V0CiAgICAgICAgICogQGRlc2Mg57qg57uTCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbk91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW5PdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgaWYgKCh0IC89IGQgLyAyKSA8IDEpIHJldHVybiAtIGMgLyAyICogKE1hdGguc3FydCgxIC0gdCAqIHQpIC0gMSkgKyBiOwogICAgICAgICAgICByZXR1cm4gYyAvIDIgKiAoTWF0aC5zcXJ0KDEgLSAodCAtPSAyKSAqIHQpICsgMSkgKyBiCiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLnNpbmUKICAgICAqIEBkZXNjIOato+W8puabsue6v+e8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5zaW5lID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuc2luZS5lYXNlSW4KICAgICAgICAgKiBAZGVzYyDmuJDlv6sKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluCiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbjogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gLSBjICogTWF0aC5jb3ModCAvIGQgKiAoTWF0aC5QSSAvIDIpKSArIGMgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnNpbmUuZWFzZU91dAogICAgICAgICAqIEBkZXNjIOa4kOaFogogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VPdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgKiBNYXRoLnNpbih0IC8gZCAqIChNYXRoLlBJIC8gMikpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5zaW5lLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiAtIGMgLyAyICogKE1hdGguY29zKE1hdGguUEkgKiB0IC8gZCkgLSAxKSArIGIKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcucXVpbnQKICAgICAqIEBkZXNjIOS6lOasoeaWueeahOe8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5xdWludCA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1aW50LmVhc2VJbgogICAgICAgICAqIEBkZXNjIOa4kOW/qwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW4KICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluOiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjICogKHQgLz0gZCkgKiB0ICogdCAqIHQgKiB0ICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5xdWludC5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqICgodCA9IHQgLyBkIC0gMSkgKiB0ICogdCAqIHQgKiB0ICsgMSkgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1aW50LmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmICgodCAvPSBkIC8gMikgPCAxKSByZXR1cm4gYyAvIDIgKiB0ICogdCAqIHQgKiB0ICogdCArIGI7CiAgICAgICAgICAgIHJldHVybiBjIC8gMiAqICgodCAtPSAyKSAqIHQgKiB0ICogdCAqIHQgKyAyKSArIGIKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcucXVhcnQKICAgICAqIEBkZXNjIOWbm+asoeaWueeahOe8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5xdWFydCA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1YXJ0LmVhc2VJbgogICAgICAgICAqIEBkZXNjIOa4kOW/qwogICAgICAgICAqCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgKiAodCAvPSBkKSAqIHQgKiB0ICogdCArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcucXVhcnQuZWFzZU91dAogICAgICAgICAqIEBkZXNjIOa4kOaFogogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VPdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC0gYyAqICgodCA9IHQgLyBkIC0gMSkgKiB0ICogdCAqIHQgLSAxKSArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcucXVhcnQuZWFzZUluT3V0CiAgICAgICAgICogQGRlc2Mg57qg57uTCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbk91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW5PdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgaWYgKCh0IC89IGQgLyAyKSA8IDEpIHJldHVybiBjIC8gMiAqIHQgKiB0ICogdCAqIHQgKyBiOwogICAgICAgICAgICByZXR1cm4gLSBjIC8gMiAqICgodCAtPSAyKSAqIHQgKiB0ICogdCAtIDIpICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5jdWJpYwogICAgICogQGRlc2Mg5LiJ5qyh5pa555qE57yT5YqoCiAgICAgKi8KICAgIG8uZWFzaW5nLmN1YmljID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuY3ViaWMuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgKiAodCAvPSBkKSAqIHQgKiB0ICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5jdWJpYy5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqICgodCA9IHQgLyBkIC0gMSkgKiB0ICogdCArIDEpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5jdWJpYy5lYXNlSW5PdXQKICAgICAgICAgKiBAZGVzYyDnuqDnu5MKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbk91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICBpZiAoKHQgLz0gZCAvIDIpIDwgMSkgcmV0dXJuIGMgLyAyICogdCAqIHQgKiB0ICsgYjsKICAgICAgICAgICAgcmV0dXJuIGMgLyAyICogKCh0IC09IDIpICogdCAqIHQgKyAyKSArIGIKICAgICAgICB9CiAgICB9OwoKfSkob2N0b3B1cyk7Ci8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICog5Yqo55S76KGM5Li66YOo5YiGCiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICogQHJlcXVpcmUgbGliL3R3ZWVuLmpzCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKi8KOyhmdW5jdGlvbihvLCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYW5pbWF0ZQogICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0KICAgICAqIEBwYXJhbSBvcHRpb25zLmVsIHtET01FbGVtZW50fSDov5vooYzliqjnlLvnmoToioLngrkKICAgICAqIEBwYXJhbSBvcHRpb25zLnR5cGUge1N0cmluZ30g6L+b6KGM5Yqo55S755qE57G75Z6LCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5jb25maWcge09iamVjdH0g6L+b6KGM5Yqo55S755qE5Y+C5pWwCiAgICAgKiBAcmV0dXJuIG9jdG9wdXMuYW5pbWF0aW9uCiAgICAgKi8KICAgIG8uYW5pbWF0ZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gISFvLmFuaW1hdGlvbltvcHRpb25zLnR5cGVdID8gKG8uYW5pbWF0aW9uW29wdGlvbnMudHlwZV0ob3B0aW9ucy5lbCwgb3B0aW9ucy5jb25maWcsIG9wdGlvbnMuZnVuYykpIDogbnVsbDsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZXNwYWNlIG9jdG9wdXMuYW5pbWF0aW9uCiAgICAgKi8KICAgIG9jdG9wdXMuYW5pbWF0aW9uID0gb2N0b3B1cy5hbmltYXRpb24gfHwgewoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYW5pbWF0aW9uLnNsaWRlCiAgICAgICAgICovCiAgICAgICAgc2xpZGU6IGZ1bmN0aW9uKGVsLCBjb25maWcsIGZ1bmMpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBvLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBkaXJlY3Rpb246ICJsZWZ0IiwKICAgICAgICAgICAgICAgIG91dDogdHJ1ZSwKICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAuNCwKICAgICAgICAgICAgICAgIGlzRmFkZTogZmFsc2UsCiAgICAgICAgICAgICAgICBlYXNlOiAiZWFzZS1vdXQiLAogICAgICAgICAgICAgICAgaXNTY2FsZTogZmFsc2UKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB2YXIgZWwgPSBlbCwKICAgICAgICAgICAgICAgIG91dCA9IG9wdGlvbnMub3V0LAogICAgICAgICAgICAgICAgY3VycmVudE9wYWNpdHksCiAgICAgICAgICAgICAgICB0b09wYWNpdHksCiAgICAgICAgICAgICAgICBkaXJlY3Rpb24gPSBvcHRpb25zLmRpcmVjdGlvbiwKICAgICAgICAgICAgICAgIHRvWCA9IDAsCiAgICAgICAgICAgICAgICB0b1kgPSAwLAogICAgICAgICAgICAgICAgZnJvbVggPSAwLAogICAgICAgICAgICAgICAgZnJvbVkgPSAwLAogICAgICAgICAgICAgICAgZWxPZmZzZXQgPSAxMDAsCiAgICAgICAgICAgICAgICBwcyA9IFtdLAogICAgICAgICAgICAgICAgZnZzID0gW10sCiAgICAgICAgICAgICAgICBldnMgPSBbXTsKICAgICAgICAgICAgaWYoZGlyZWN0aW9uID09ICJsZWZ0IiB8fCBkaXJlY3Rpb24gPT0gInJpZ2h0IikgewogICAgICAgICAgICAgICAgaWYob3V0KSB7CiAgICAgICAgICAgICAgICAgICAgdG9YID0gLWVsT2Zmc2V0OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmcm9tWCA9IGVsT2Zmc2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYoZGlyZWN0aW9uID09ICJ1cCIgfHwgZGlyZWN0aW9uID09ICJkb3duIikgewogICAgICAgICAgICAgICAgaWYob3V0KSB7CiAgICAgICAgICAgICAgICAgICAgdG9ZID0gLWVsT2Zmc2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZnJvbVkgPSBlbE9mZnNldDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlyZWN0aW9uID09ICdyaWdodCcgfHwgZGlyZWN0aW9uID09ICdkb3duJykgewogICAgICAgICAgICAgICAgdG9ZICo9IC0xOwogICAgICAgICAgICAgICAgdG9YICo9IC0xOwogICAgICAgICAgICAgICAgZnJvbVkgKj0gLTE7CiAgICAgICAgICAgICAgICBmcm9tWCAqPSAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwcy5wdXNoKCItd2Via2l0LXRyYW5zZm9ybSIpOwogICAgICAgICAgICBmdnMucHVzaCgidHJhbnNsYXRlM2QoIiArIGZyb21YICsgIiUsICIgKyBmcm9tWSArICIlLCAwKSIpOwogICAgICAgICAgICBldnMucHVzaCgidHJhbnNsYXRlM2QoIiArIHRvWCArICIlLCAiICsgdG9ZICsgIiUsIDApIik7CiAgICAgICAgICAgIGlmKG9wdGlvbnMuaXNGYWRlKSB7CiAgICAgICAgICAgICAgICB0b09wYWNpdHkgPSBvdXQgPyAwIDogMTsKICAgICAgICAgICAgICAgIGN1cnJlbnRPcGFjaXR5ID0gb3V0ID8gMSA6IDA7CiAgICAgICAgICAgICAgICBmdnMucHVzaChjdXJyZW50T3BhY2l0eSk7CiAgICAgICAgICAgICAgICBldnMucHVzaCh0b09wYWNpdHkpOwogICAgICAgICAgICAgICAgcHMucHVzaCgib3BhY2l0eSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG9wdGlvbnMuaXNTY2FsZSAmJiBvdXQpIHsKICAgICAgICAgICAgICAgIHZhciBmcm9tU2NhbGUgPSAxLAogICAgICAgICAgICAgICAgICAgIHRvU2NhbGUgPSAwLjg7CiAgICAgICAgICAgICAgICBmdnMucHVzaCgic2NhbGUoIiArIGZyb21TY2FsZSArICIpIik7CiAgICAgICAgICAgICAgICBldnMucHVzaCgic2NhbGUoIiArIHRvU2NhbGUgKyAiKSIpOwogICAgICAgICAgICAgICAgcHMucHVzaCgiLXdlYmtpdC10cmFuc2Zvcm0iKTsKICAgICAgICAgICAgICAgIHZhciBfaW5kZXggPSBwcy5pbmRleE9mKCJvcGFjaXR5Iik7CiAgICAgICAgICAgICAgICBpZihfaW5kZXggPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBwcy5wdXNoKCJvcGFjaXR5Iik7CiAgICAgICAgICAgICAgICAgICAgZXZzLnB1c2gob3V0ID8gMSA6IDApOwogICAgICAgICAgICAgICAgICAgIGZ2cy5wdXNoKG91dCA/IDAgOiAxKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXZzW19pbmRleF0gPSBvdXQgPyAxIDogMDsKICAgICAgICAgICAgICAgICAgICBmdnNbX2luZGV4XSA9IG91dCA/IDAgOiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgby5Ud2VlbihlbCwgcHMsIGZ2cywgZXZzLCBvcHRpb25zLmR1cmF0aW9uLCBmdW5jLCB7CiAgICAgICAgICAgICAgICBlYXNlOiBvcHRpb25zLmVhc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFuaW1hdGlvbi5mYWRlCiAgICAgICAgICovCiAgICAgICAgZmFkZTogZnVuY3Rpb24oZWwsIGNvbmZpZywgZnVuYykgewogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IG8uZXh0ZW5kKHsKICAgICAgICAgICAgICAgIG91dDogdHJ1ZSwKICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAuNCwKICAgICAgICAgICAgICAgIGVhc2U6ICJlYXNlLW91dCIKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB2YXIgZWwgPSBlbCwKICAgICAgICAgICAgICAgIGZyb21PcGFjaXR5ID0gMSwKICAgICAgICAgICAgICAgIHRvT3BhY2l0eSA9IDEsCiAgICAgICAgICAgICAgICBvdXQgPSBvcHRpb25zLm91dDsKICAgICAgICAgICAgaWYgKG91dCkgewogICAgICAgICAgICAgICAgdG9PcGFjaXR5ID0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZyb21PcGFjaXR5ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZnYgPSBbZnJvbU9wYWNpdHldLAogICAgICAgICAgICAgICAgZXYgPSBbdG9PcGFjaXR5XTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBvLlR3ZWVuKGVsLCBbIm9wYWNpdHkiXSwgZnYsIGV2LCBvcHRpb25zLmR1cmF0aW9uLCBmdW5jLCB7CiAgICAgICAgICAgICAgICBlYXNlOiBvcHRpb25zLmVhc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFuaW1hdGlvbi5wb3AKICAgICAgICAgKi8KICAgICAgICBwb3A6IGZ1bmN0aW9uKGVsLCBjb25maWcsIGZ1bmMpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBvLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBvdXQ6IHRydWUsCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogLjQsCiAgICAgICAgICAgICAgICBlYXNlOiAiZWFzZS1vdXQiLAogICAgICAgICAgICAgICAgc2NhbGVPbkV4aXQ6IHRydWUKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB2YXIgZWwgPSBlbCwKICAgICAgICAgICAgICAgIGZyb21TY2FsZSA9IDEsCiAgICAgICAgICAgICAgICB0b1NjYWxlID0gMSwKICAgICAgICAgICAgICAgIGZyb21PcGFjaXR5ID0gMSwKICAgICAgICAgICAgICAgIHRvT3BhY2l0eSA9IDEsCiAgICAgICAgICAgICAgICBjdXJaID0gby5kb20uZ2V0U3R5bGUoZWwsICd6LWluZGV4JykgfHwgMCwKICAgICAgICAgICAgICAgIGZyb21aID0gY3VyWiwKICAgICAgICAgICAgICAgIHRvWiA9IGN1closCiAgICAgICAgICAgICAgICBvdXQgPSBvcHRpb25zLm91dDsKCiAgICAgICAgICAgIGlmICghb3V0KSB7CiAgICAgICAgICAgICAgICBmcm9tU2NhbGUgPSAwLjAxOwogICAgICAgICAgICAgICAgZnJvbVogPSBjdXJaICsgMTsKICAgICAgICAgICAgICAgIHRvWiA9IGN1clogKyAxOwogICAgICAgICAgICAgICAgZnJvbU9wYWNpdHkgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuc2NhbGVPbkV4aXQpIHsKICAgICAgICAgICAgICAgICAgICB0b1NjYWxlID0gMC4wMTsKICAgICAgICAgICAgICAgICAgICB0b09wYWNpdHkgPSAwOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0b09wYWNpdHkgPSAwLjg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBzID0gWyItd2Via2l0LXRyYW5zZm9ybSIsICItd2Via2l0LXRyYW5zZm9ybS1vcmlnaW4iLCAib3BhY2l0eSIsICJ6LWluZGV4Il0sCiAgICAgICAgICAgICAgICBmdnMgPSBbInNjYWxlKCIgKyBmcm9tU2NhbGUgKyAiKSIsICI1MCUgNTAlIiwgZnJvbU9wYWNpdHksIGZyb21aXSwKICAgICAgICAgICAgICAgIGV2cyA9IFsic2NhbGUoIiArIHRvU2NhbGUgKyAiKSIsICI1MCUgNTAlIiwgdG9PcGFjaXR5LCB0b1pdOwogICAgICAgICAgICByZXR1cm4gbmV3IG8uVHdlZW4oZWwsIHBzLCBmdnMsIGV2cywgb3B0aW9ucy5kdXJhdGlvbiwgZnVuYywgewogICAgICAgICAgICAgICAgZWFzZTogb3B0aW9ucy5lYXNlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hbmltYXRpb24uZmxpcAogICAgICAgICAqLwogICAgICAgIGZsaXA6IGZ1bmN0aW9uKGVsLCBjb25maWcsIGZ1bmMpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBvLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBvdXQ6IHRydWUsCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogLjQsCiAgICAgICAgICAgICAgICBlYXNlOiAiZWFzZS1vdXQiLAogICAgICAgICAgICAgICAgZGlyZWN0aW9uOiAibGVmdCIKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB2YXIgZWwgPSBlbCwKICAgICAgICAgICAgICAgIGRpcmVjdGlvbiA9IG9wdGlvbnMuZGlyZWN0aW9uLAogICAgICAgICAgICAgICAgcm90YXRlUHJvcCA9ICdZJywKICAgICAgICAgICAgICAgIGZyb21TY2FsZSA9IDEsCiAgICAgICAgICAgICAgICB0b1NjYWxlID0gMSwKICAgICAgICAgICAgICAgIGZyb21Sb3RhdGUgPSAwLAogICAgICAgICAgICAgICAgb3V0ID0gb3B0aW9ucy5vdXQsCiAgICAgICAgICAgICAgICB0b1JvdGF0ZSA9IDA7CgogICAgICAgICAgICBpZiAob3V0KSB7CiAgICAgICAgICAgICAgICB0b1JvdGF0ZSA9IC0xODA7CiAgICAgICAgICAgICAgICB0b1NjYWxlID0gMC44OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZnJvbVJvdGF0ZSA9IDE4MDsKICAgICAgICAgICAgICAgIGZyb21TY2FsZSA9IDAuODsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpcmVjdGlvbiA9PSAndXAnIHx8IGRpcmVjdGlvbiA9PSAnZG93bicpIHsKICAgICAgICAgICAgICAgIHJvdGF0ZVByb3AgPSAnWCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaXJlY3Rpb24gPT0gJ3JpZ2h0JyB8fCBkaXJlY3Rpb24gPT0gJ2xlZnQnKSB7CiAgICAgICAgICAgICAgICB0b1JvdGF0ZSAqPSAtMTsKICAgICAgICAgICAgICAgIGZyb21Sb3RhdGUgKj0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWwuc3R5bGUud2Via2l0QmFja2ZhY2VWaXNpYmlsaXR5ID0gImhpZGRlbiIKICAgICAgICAgICAgcmV0dXJuIG5ldyBvLlR3ZWVuKGVsLCAiLXdlYmtpdC10cmFuc2Zvcm0iLCAncm90YXRlJyArIHJvdGF0ZVByb3AgKyAnKCcgKyBmcm9tUm90YXRlICsgJ2RlZykgc2NhbGUoJyArIGZyb21TY2FsZSArICcpJywKICAgICAgICAgICAgICAgICdyb3RhdGUnICsgcm90YXRlUHJvcCArICcoJyArIHRvUm90YXRlICsgJ2RlZykgc2NhbGUoJyArIHRvU2NhbGUgKyAnKScsIG9wdGlvbnMuZHVyYXRpb24sIGZ1bmMsIHsKICAgICAgICAgICAgICAgIGVhc2U6IG9wdGlvbnMuZWFzZQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYW5pbWF0aW9uLndpcGUKICAgICAgICAgKi8KICAgICAgICB3aXBlOiBmdW5jdGlvbihlbCwgY29uZmlnLCBmdW5jKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zID0gby5leHRlbmQoewogICAgICAgICAgICAgICAgb3V0OiB0cnVlLAogICAgICAgICAgICAgICAgZHVyYXRpb246IC40LAogICAgICAgICAgICAgICAgZWFzZTogImVhc2Utb3V0IgogICAgICAgICAgICB9LCBjb25maWcpOwogICAgICAgICAgICBmdW5jID0gZnVuYyB8fCBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgIHZhciBlbCA9IGVsLAogICAgICAgICAgICAgICAgY3VyWiA9IG8uZG9tLmdldFN0eWxlKGVsLCAiei1pbmRleCIpIHx8IDAsCiAgICAgICAgICAgICAgICB6SW5kZXgsCiAgICAgICAgICAgICAgICBvdXQgPSBvcHRpb25zLm91dCwKICAgICAgICAgICAgICAgIG1hc2sgPSAnJzsKCiAgICAgICAgICAgIGlmICghb3V0KSB7CiAgICAgICAgICAgICAgICB6SW5kZXggPSBjdXJaICsgMTsKICAgICAgICAgICAgICAgIG1hc2sgPSAnLXdlYmtpdC1ncmFkaWVudChsaW5lYXIsIGxlZnQgYm90dG9tLCByaWdodCBib3R0b20sIGZyb20odHJhbnNwYXJlbnQpLCB0bygjMDAwKSwgY29sb3Itc3RvcCg2NiUsICMwMDApLCBjb2xvci1zdG9wKDMzJSwgdHJhbnNwYXJlbnQpKSc7CiAgICAgICAgICAgICAgICB2YXIgX3dpZHRoID0gby5kb20uZ2V0V2lkdGgoZWwpOwogICAgICAgICAgICAgICAgZWwuc3R5bGUud2Via2l0TWFza0ltYWdlID0gbWFzazsKICAgICAgICAgICAgICAgIGVsLnN0eWxlLm1hc2tJbWFnZSA9IG1hc2s7CiAgICAgICAgICAgICAgICBlbC5zdHlsZS53ZWJraXRNYXNrU2l6ZSA9IF93aWR0aCAqIDMgKyAicHgiICsgby5kb20uZ2V0SGVpZ2h0KGVsKSArICJweCI7CiAgICAgICAgICAgICAgICBlbC5zdHlsZS5tYXNrU2l6ZSA9IF93aWR0aCAqIDMgKyAicHgiICsgby5kb20uZ2V0SGVpZ2h0KGVsKSArICJweCI7CiAgICAgICAgICAgICAgICBlbC5zdHlsZS56SW5kZXggPSB6SW5kZXg7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IG8uVHdlZW4oZWwsICItd2Via2l0LW1hc2stcG9zaXRpb24teCIsICIwIiwgMCAtIF93aWR0aCArICJweCIsICBvcHRpb25zLmR1cmF0aW9uLCBmdW5jLCB7CiAgICAgICAgICAgICAgICAgICAgZWFzZTogb3B0aW9ucy5lYXNlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jLCBvcHRpb25zLmR1cmF0aW9uICogMTAwMCk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hbmltYXRpb24ucm9sbAogICAgICAgICAqLwogICAgICAgIHJvbGw6IGZ1bmN0aW9uKGVsLCBjb25maWcsIGZ1bmMpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBvLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBvdXQ6IHRydWUsCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogLjQsCiAgICAgICAgICAgICAgICBlYXNlOiAiZWFzZS1vdXQiLAogICAgICAgICAgICAgICAgaXNGYWRlOiBmYWxzZQogICAgICAgICAgICB9LCBjb25maWcpOwogICAgICAgICAgICBmdW5jID0gZnVuYyB8fCBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgIHZhciBlbCA9IGVsLAogICAgICAgICAgICAgICAgb3V0ID0gb3B0aW9ucy5vdXQsCiAgICAgICAgICAgICAgICBmcm9tVHJhbnNmb3JtID0gInRyYW5zbGF0ZVgoLTEwMCUpIHJvdGF0ZSgtMTIwZGVnKSIsCiAgICAgICAgICAgICAgICB0b1RyYW5zZm9ybSA9ICJ0cmFuc2xhdGVYKDBweCkgcm90YXRlKDBkZWcpIiwKICAgICAgICAgICAgICAgIHBzID0gWyItd2Via2l0LXRyYW5zZm9ybSJdLAogICAgICAgICAgICAgICAgZnZzID0gW10sCiAgICAgICAgICAgICAgICBldnMgPSBbXTsKICAgICAgICAgICAgaWYob3V0KSB7CiAgICAgICAgICAgICAgICB2YXIgdGVtcCA9IGZyb21UcmFuc2Zvcm07CiAgICAgICAgICAgICAgICBmcm9tVHJhbnNmb3JtID0gdG9UcmFuc2Zvcm07CiAgICAgICAgICAgICAgICB0b1RyYW5zZm9ybSA9IHRlbXA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnZzLnB1c2goZnJvbVRyYW5zZm9ybSk7CiAgICAgICAgICAgIGV2cy5wdXNoKHRvVHJhbnNmb3JtKTsKICAgICAgICAgICAgaWYob3B0aW9ucy5pc0ZhZGUpIHsKICAgICAgICAgICAgICAgIHBzLnB1c2goIm9wYWNpdHkiKTsKICAgICAgICAgICAgICAgIGZ2cy5wdXNoKG9wdGlvbnMub3V0ID8gMSA6IDApOwogICAgICAgICAgICAgICAgZXZzLnB1c2gob3B0aW9ucy5vdXQgPyAwIDogMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBvLlR3ZWVuKGVsLCBwcywgZnZzLCBldnMsIG9wdGlvbnMuZHVyYXRpb24sIGZ1bmMsIHsKICAgICAgICAgICAgICAgIGVhc2U6IG9wdGlvbnMuZWFzZQogICAgICAgICAgICB9KQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hbmltYXRpb24ucm90YXRlCiAgICAgICAgICovCiAgICAgICAgcm90YXRlOiBmdW5jdGlvbihlbCwgY29uZmlnLCBmdW5jKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zID0gby5leHRlbmQoewogICAgICAgICAgICAgICAgb3V0OiB0cnVlLAogICAgICAgICAgICAgICAgZHVyYXRpb246IC40LAogICAgICAgICAgICAgICAgZWFzZTogImVhc2Utb3V0IiwKICAgICAgICAgICAgICAgIGhvcml6b246ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgZGlyZWN0aW9uOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgIGlzRmFkZTogZmFsc2UKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB2YXIgZWwgPSBlbCwKICAgICAgICAgICAgICAgIG91dCA9IG9wdGlvbnMub3V0LAogICAgICAgICAgICAgICAgcHMgPSBbIi13ZWJraXQtdHJhbnNmb3JtIl0sCiAgICAgICAgICAgICAgICBmdnMgPSBbXSwKICAgICAgICAgICAgICAgIGZyb21UcmFuc2Zvcm0gPSAicm90YXRlKDIwMGRlZykiLAogICAgICAgICAgICAgICAgdG9UcmFuc2Zvcm0gPSAicm90YXRlKDApIiwKICAgICAgICAgICAgICAgIGV2cyA9IFtdOwogICAgICAgICAgICBpZihvcHRpb25zLmRpcmVjdGlvbiA9PSAidXAiKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLmRpcmVjdGlvbiA9ICJ0b3AiOwogICAgICAgICAgICB9IGVsc2UgaWYob3B0aW9ucy5kaXJlY3Rpb24gPT0gImRvd24iKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLmRpcmVjdGlvbiA9ICJib3R0b20iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsLnN0eWxlLndlYmtpdFRyYW5zZm9ybU9yaWdpbiA9IG9wdGlvbnMuaG9yaXpvbiArICIgIiArIG9wdGlvbnMuZGlyZWN0aW9uOwogICAgICAgICAgICBpZihvcHRpb25zLmhvcml6b24gPT0gImxlZnQiKSB7CiAgICAgICAgICAgICAgICBmcm9tVHJhbnNmb3JtID0gInJvdGF0ZSg5MGRlZykiOwogICAgICAgICAgICB9IGVsc2UgaWYob3B0aW9ucy5ob3Jpem9uID09ICJyaWdodCIpIHsKICAgICAgICAgICAgICAgIGZyb21UcmFuc2Zvcm0gPSAicm90YXRlKC05MGRlZykiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG91dCkgewogICAgICAgICAgICAgICAgdmFyIHRlbXAgPSBmcm9tVHJhbnNmb3JtOwogICAgICAgICAgICAgICAgZnJvbVRyYW5zZm9ybSA9IHRvVHJhbnNmb3JtOwogICAgICAgICAgICAgICAgdG9UcmFuc2Zvcm0gPSB0ZW1wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ2cy5wdXNoKGZyb21UcmFuc2Zvcm0pOwogICAgICAgICAgICBldnMucHVzaCh0b1RyYW5zZm9ybSk7CiAgICAgICAgICAgIGlmKG9wdGlvbnMuaXNGYWRlKSB7CiAgICAgICAgICAgICAgICBwcy5wdXNoKCJvcGFjaXR5Iik7CiAgICAgICAgICAgICAgICBmdnMucHVzaChvcHRpb25zLm91dCA/IDEgOiAwKTsKICAgICAgICAgICAgICAgIGV2cy5wdXNoKG9wdGlvbnMub3V0ID8gMCA6IDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgby5Ud2VlbihlbCwgcHMsIGZ2cywgZXZzLCBvcHRpb25zLmR1cmF0aW9uLCBmdW5jLCB7CiAgICAgICAgICAgICAgICBlYXNlOiBvcHRpb25zLmVhc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFuaW1hdGlvbi5mb2xkCiAgICAgICAgICovCiAgICAgICAgZm9sZDogZnVuY3Rpb24oZWwsIGNvbmZpZywgZnVuYykgewogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IG8uZXh0ZW5kKHsKICAgICAgICAgICAgICAgIG91dDogdHJ1ZSwKICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAuNCwKICAgICAgICAgICAgICAgIGVhc2U6ICJlYXNlLW91dCIsCiAgICAgICAgICAgICAgICBkaXJlY3Rpb246ICJsZWZ0IiwKICAgICAgICAgICAgICAgIGlzRmFkZTogZmFsc2UKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB2YXIgZWwgPSBlbCwKICAgICAgICAgICAgICAgIG91dCA9IG9wdGlvbnMub3V0LAogICAgICAgICAgICAgICAgZGlyZWN0aW9uID0gb3B0aW9ucy5kaXJlY3Rpb24sCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm0gPSB7CiAgICAgICAgICAgICAgICAgICAgImxlZnQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJvcmlnaW4iOiAiMTAwJSA1MCUiLAogICAgICAgICAgICAgICAgICAgICAgICAic3RhcnRUcmFuc2Zvcm0iOiAidHJhbnNsYXRlWCgtMTAwJSkgcm90YXRlWSgtOTBkZWcpIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInJpZ2h0IjogewogICAgICAgICAgICAgICAgICAgICAgICAib3JpZ2luIjogIjAlIDUwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGFydFRyYW5zZm9ybSI6ICJ0cmFuc2xhdGVYKDEwMCUpIHJvdGF0ZVkoOTBkZWcpIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInVwIjogewogICAgICAgICAgICAgICAgICAgICAgICAib3JpZ2luIjogIjUwJSAxMDAlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXJ0VHJhbnNmb3JtIjogInRyYW5zbGF0ZVkoLTEwMCUpIHJvdGF0ZVgoOTBkZWcpIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRvd24iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJvcmlnaW4iOiAiNTAlIDAlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXJ0VHJhbnNmb3JtIjogInRyYW5zbGF0ZVkoMTAwJSkgcm90YXRlWCgtOTBkZWcpIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwcyA9IFsiLXdlYmtpdC10cmFuc2Zvcm0iXSwKICAgICAgICAgICAgICAgIGZ2cyA9IFtdLAogICAgICAgICAgICAgICAgZXZzID0gW10sCiAgICAgICAgICAgICAgICBmcm9tVHJhbnNmb3JtID0gdHJhbnNmb3JtW2RpcmVjdGlvbl1bInN0YXJ0VHJhbnNmb3JtIl0sCiAgICAgICAgICAgICAgICB0b1RyYW5zZm9ybSA9ICJ0cmFuc2xhdGUzZCgwLCAwLCAwKSByb3RhdGUoMCkiOwogICAgICAgICAgICBlbC5zdHlsZS53ZWJraXRUcmFuc2Zvcm1PcmlnaW4gPSB0cmFuc2Zvcm1bZGlyZWN0aW9uXVsib3JpZ2luIl07CiAgICAgICAgICAgIGlmKG91dCkgewogICAgICAgICAgICAgICAgdmFyIHRlbXAgPSBmcm9tVHJhbnNmb3JtOwogICAgICAgICAgICAgICAgZnJvbVRyYW5zZm9ybSA9IHRvVHJhbnNmb3JtOwogICAgICAgICAgICAgICAgdG9UcmFuc2Zvcm0gPSB0ZW1wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ2cy5wdXNoKGZyb21UcmFuc2Zvcm0pOwogICAgICAgICAgICBldnMucHVzaCh0b1RyYW5zZm9ybSk7CiAgICAgICAgICAgIGlmKG9wdGlvbnMuaXNGYWRlKSB7CiAgICAgICAgICAgICAgICBwcy5wdXNoKCJvcGFjaXR5Iik7CiAgICAgICAgICAgICAgICBmdnMucHVzaChvcHRpb25zLm91dCA/IDEgOiAwKTsKICAgICAgICAgICAgICAgIGV2cy5wdXNoKG9wdGlvbnMub3V0ID8gMCA6IDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgby5Ud2VlbihlbCwgcHMsIGZ2cywgZXZzLCBvcHRpb25zLmR1cmF0aW9uLCBmdW5jLCB7CiAgICAgICAgICAgICAgICBlYXNlOiBvcHRpb25zLmVhc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFuaW1hdGlvbi5jYXJvdXNlbAogICAgICAgICAqLwogICAgICAgIGNhcm91c2VsOiBmdW5jdGlvbihlbCwgY29uZmlnLCBmdW5jKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zID0gby5leHRlbmQoewogICAgICAgICAgICAgICAgb3V0OiB0cnVlLAogICAgICAgICAgICAgICAgZHVyYXRpb246IC40LAogICAgICAgICAgICAgICAgZWFzZTogImVhc2Utb3V0IiwKICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogImxlZnQiLAogICAgICAgICAgICAgICAgaXNGYWRlOiBmYWxzZQogICAgICAgICAgICB9LCBjb25maWcpOwogICAgICAgICAgICBmdW5jID0gZnVuYyB8fCBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgIHZhciBlbCA9IGVsLAogICAgICAgICAgICAgICAgb3V0ID0gb3B0aW9ucy5vdXQsCiAgICAgICAgICAgICAgICBkaXJlY3Rpb24gPSBvcHRpb25zLmRpcmVjdGlvbiwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybSA9IHsKICAgICAgICAgICAgICAgICAgICAibGVmdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgIm9yaWdpbk91dCI6ICIxMDAlIDUwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJvcmlnaW5JbiI6ICIwJSA1MCUiLAogICAgICAgICAgICAgICAgICAgICAgICAic3RhcnRUcmFuc2Zvcm1PdXQiOiAidHJhbnNsYXRlWCgtMjAwJSkgc2NhbGUoLjQpIHJvdGF0ZVkoLTY1ZGVnKSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGFydFRyYW5zZm9ybUluIjogInRyYW5zbGF0ZVgoMjAwJSkgc2NhbGUoLjQpIHJvdGF0ZVkoNjVkZWcpIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInJpZ2h0IjogewogICAgICAgICAgICAgICAgICAgICAgICAib3JpZ2luT3V0IjogIjAlIDUwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJvcmlnaW5JbiI6ICIxMDAlIDUwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGFydFRyYW5zZm9ybU91dCI6ICJ0cmFuc2xhdGVYKDIwMCUpIHNjYWxlKC40KSByb3RhdGVZKDY1ZGVnKSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGFydFRyYW5zZm9ybUluIjogInRyYW5zbGF0ZVgoLTIwMCUpIHNjYWxlKC40KSByb3RhdGVZKC02NWRlZykiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAidXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJvcmlnaW5PdXQiOiAiNTAlIDEwMCUiLAogICAgICAgICAgICAgICAgICAgICAgICAib3JpZ2luSW4iOiAiNTAlIDAlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXJ0VHJhbnNmb3JtT3V0IjogInRyYW5zbGF0ZVkoLTIwMCUpIHNjYWxlKC40KSByb3RhdGVYKDY1ZGVnKSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGFydFRyYW5zZm9ybUluIjogInRyYW5zbGF0ZVkoMjAwJSkgc2NhbGUoLjQpIHJvdGF0ZVgoLTY1ZGVnKSIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJkb3duIjogewogICAgICAgICAgICAgICAgICAgICAgICAib3JpZ2luT3V0IjogIjUwJSAwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJvcmlnaW5JbiI6ICI1MCUgMTAwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGFydFRyYW5zZm9ybU91dCI6ICJ0cmFuc2xhdGVZKDIwMCUpIHNjYWxlKC40KSByb3RhdGVYKC02NWRlZykiLAogICAgICAgICAgICAgICAgICAgICAgICAic3RhcnRUcmFuc2Zvcm1JbiI6ICJ0cmFuc2xhdGVZKC0yMDAlKSBzY2FsZSguNCkgcm90YXRlWCg2NWRlZykiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHBzID0gWyItd2Via2l0LXRyYW5zZm9ybSJdLAogICAgICAgICAgICAgICAgZnZzID0gW10sCiAgICAgICAgICAgICAgICBldnMgPSBbXSwKICAgICAgICAgICAgICAgIGZyb21UcmFuc2Zvcm0gPSB0cmFuc2Zvcm1bZGlyZWN0aW9uXVsic3RhcnRUcmFuc2Zvcm1PdXQiXSwKICAgICAgICAgICAgICAgIHRvVHJhbnNmb3JtID0gInRyYW5zbGF0ZTNkKDAsIDAsIDApIHJvdGF0ZSgwKSI7CiAgICAgICAgICAgIGVsLnN0eWxlLndlYmtpdFRyYW5zZm9ybU9yaWdpbiA9IG91dCA/IHRyYW5zZm9ybVtkaXJlY3Rpb25dWyJvcmlnaW5JbiJdIDogdHJhbnNmb3JtW2RpcmVjdGlvbl1bIm9yaWdpbk91dCJdOwogICAgICAgICAgICBpZihvdXQpIHsKICAgICAgICAgICAgICAgIGZyb21UcmFuc2Zvcm0gPSB0b1RyYW5zZm9ybTsKICAgICAgICAgICAgICAgIHRvVHJhbnNmb3JtID0gdHJhbnNmb3JtW2RpcmVjdGlvbl1bInN0YXJ0VHJhbnNmb3JtSW4iXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdnMucHVzaChmcm9tVHJhbnNmb3JtKTsKICAgICAgICAgICAgZXZzLnB1c2godG9UcmFuc2Zvcm0pOwogICAgICAgICAgICBpZihvcHRpb25zLmlzRmFkZSkgewogICAgICAgICAgICAgICAgcHMucHVzaCgib3BhY2l0eSIpOwogICAgICAgICAgICAgICAgZnZzLnB1c2gob3B0aW9ucy5vdXQgPyAxIDogMCk7CiAgICAgICAgICAgICAgICBldnMucHVzaChvcHRpb25zLm91dCA/IDAgOiAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IG8uVHdlZW4oZWwsIHBzLCBmdnMsIGV2cywgb3B0aW9ucy5kdXJhdGlvbiwgZnVuYywgewogICAgICAgICAgICAgICAgZWFzZTogb3B0aW9ucy5lYXNlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07Cn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICog566A5Y2V5a6e546w5oyH5a6a5a655Zmo5LiL55qEbGF6eWxvYWQKICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEByZXF1aXJlIGxpYi9ldmVudC5qcwogKiBAcmVxdWlyZSBsaWIvZG9tLmpzCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKi8KOyhmdW5jdGlvbihvLCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMubGF6eUltZwogICAgICogQHBhcmFtIG9wdHMKICAgICAqLwogICAgby5sYXp5SW1nID0gZnVuY3Rpb24ob3B0cykgewogICAgICAgIHJldHVybiBuZXcgby5JbWdMYXp5TG9hZChvcHRzIHx8IHt9KS5jaGVjaygpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLkltZ0xhenlMb2FkCiAgICAgKiBAZGVzYyDnlKjmnaXlr7nmjIflrprlm77niYfmiJbogIXlrrnlmajlhoXnmoTlm77niYfov5vooYzlu7blkI7liqDovb0KICAgICAqIEBwYXJhbSBvcHRpb25zIOWPguaVsAogICAgICogQHBhcmFtIG9wdGlvbnMuaW1ncyB7U3RyaW5nIHwgQXJyYXkgfCBET01FbGVtZW50fSDpnIDopoHlu7blkI7liqDovb3nmoTlm77niYfmlbDnu4TmiJboioLngrnmiJboioLngrlpZAogICAgICogQHBhcmFtIG9wdGlvbnMuZWwge0RPTUVsZW1lbnQgfCBTdHJpbmd9IOmcgOimgeW7tuWQjuWKoOi9veeahOiKgueCueWuueWZqOaIluiKgueCueWuueWZqGlkIOWmguaenOW3suS8oOWFpW9wdGlvbnMuaW1ncyDliJnmraTlj4LmlbDkuI3nlJ/mlYgKICAgICAqIEBwYXJhbSBvcHRpb25zLmNvbnRhaW5lciB7RE9NRWxlbWVudCB8IFN0cmluZ30g5Ye65rua5Yqo5p2h55qE5a655ZmoCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5zcmNOYW1lIHtTdHJpbmd9IOW7tui/n+WKoOi9veeahOWbvueJh+eahOecn+WunnNyY+WxnuaAp+Wtl+autem7mOiupOS4uiJzcmMiCiAgICAgKi8KICAgIG8uSW1nTGF6eUxvYWQgPSBvLmRlZmluZSh7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGVsCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnQgfCBTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5oyH5a6a5a655Zmo5oiW5Zu+54mHCiAgICAgICAgICovCiAgICAgICAgZWw6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNvbnRhaW5lcgogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50IHwgU3RyaW5nfQogICAgICAgICAqIEBkZXNjIOaMh+WumueahOa7muWKqOWuueWZqAogICAgICAgICAqLwogICAgICAgIGNvbnRhaW5lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaW1ncwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAZGVzYyDpnIDopoHlkI7liqDovb3nmoTpm4blkIgKICAgICAgICAgKi8KICAgICAgICBpbWdzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBzcmNOYW1lCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBzcmNOYW1lOiAic3JjIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgb3B0cwogICAgICAgICAqIEBkZXNjIOS8oOWFpeeahOWPguaVsAogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgb3B0czogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNTY3JvbGwKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDmoIflv5fkvY0KICAgICAgICAgKi8KICAgICAgICBpc1Njcm9sbDogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50CiAgICAgICAgICogQHR5cGUge29jdG9wdXMuRXZlbnR9CiAgICAgICAgICogQGRlc2Mg6Ieq6Lqr5LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgZXZlbnQ6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICB0aGlzLm9wdHMgPSBvLmV4dGVuZCh7fSwgb3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gby5nKG9wdGlvbnMuY29udGFpbmVyKSB8fCBkb2N1bWVudC5ib2R5OwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBwbm9kZSA9ICh0aGlzLmNvbnRhaW5lciA9PSBkb2N1bWVudC5ib2R5KSA/IHdpbmRvdyA6IHRoaXMuY29udGFpbmVyOwogICAgICAgICAgICB2YXIgaW1ncyA9IG9wdGlvbnMuaW1nczsKICAgICAgICAgICAgdGhpcy5pbWdzID0gW107CiAgICAgICAgICAgIHRoaXMuZXZlbnQgPSBuZXcgby5FdmVudHModGhpcyk7CiAgICAgICAgICAgIHRoaXMuc2V0RG9tcyhpbWdzKQogICAgICAgICAgICBvLmV2ZW50Lm9uKHBub2RlLCAic2Nyb2xsIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZighdGhhdC5pc1Njcm9sbCkgewogICAgICAgICAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoYXQuY2hlY2ssIHRoYXQpKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LmlzU2Nyb2xsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgICAgICBvLmV2ZW50Lm9uKHdpbmRvdywgIm9ydGNoYW5nZSIsIG8udXRpbC5iaW5kKHRoaXMucmVzZXQsIHRoaXMpLCBmYWxzZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5JbWdMYXp5TG9hZC5vbgogICAgICAgICAqIEBwYXJhbSBldnQge1N0cmluZ30g5LqL5Lu255uR5ZCs5ZCNCiAgICAgICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufSDlm57osIPlh73mlbAKICAgICAgICAgKiBAZGVzYyDmt7vliqDnm5HlkKzlmagKICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24oZXZ0LCBmdW5jKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnQub24oZXZ0LCBmdW5jKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkltZ0xhenlMb2FkLnVuCiAgICAgICAgICogQHBhcmFtIGV2dCB7U3RyaW5nfSDkuovku7bnm5HlkKzlkI0KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IOWbnuiwg+WHveaVsAogICAgICAgICAqIEBkZXNjIOWNuOi9veebkeWQrOWZqAogICAgICAgICAqLwogICAgICAgIHVuOiBmdW5jdGlvbihldnQsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5ldmVudC51bihldnQsIGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkltZ0xhenlMb2FkLm5vdGlmeQogICAgICAgICAqLwogICAgICAgIG5vdGlmeTogZnVuY3Rpb24oZXZ0LCBvcHRzKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnQudHJpZ2dlckV2ZW50KGV2dCwgb3B0cyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNldERvbXMKICAgICAgICAgKiBAZGVzYyDliJ3lp4vljJblm77niYfoioLngrkKICAgICAgICAgKi8KICAgICAgICBzZXREb21zOiBmdW5jdGlvbihpbWdzKSB7CiAgICAgICAgICAgIGlmKGltZ3MpIHsKICAgICAgICAgICAgICAgIGlmKG8udXRpbC5pc0FycmF5KGltZ3MpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbWdzID0gdGhpcy5pbWdzLmNvbmNhdChpbWdzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGltZyA9IG8uZyhpbWdzKTsKICAgICAgICAgICAgICAgICAgICBvLnV0aWwuaXNOb2RlKGltZykgJiYgdGhpcy5pbWdzLnB1c2goaW1nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmKHRoaXMub3B0cy5lbCkgewogICAgICAgICAgICAgICAgdGhpcy5lbCA9IHRoaXMuZWwgfHwgby5nKHRoaXMub3B0cy5lbCk7CiAgICAgICAgICAgICAgICB2YXIgX2ltZ3MgPSBvLiQoImltZyIsIHRoaXMuZWwpLAogICAgICAgICAgICAgICAgICAgIGxlbiA9IF9pbWdzLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgby51dGlsLmVhY2goX2ltZ3MsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIW8udXRpbC5pc05vZGUoaXRlbSkpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIW8uZG9tLmRhdGEoaXRlbSwgImxvYWRlZCIpICYmIG8uZG9tLmRhdGEoaXRlbSwgdGhhdC5zcmNOYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5pbWdzLnB1c2goaXRlbSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZih0aGlzLmVsLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAiaW1nIiAmJiAhby5kb20uZGF0YSh0aGlzLmVsLCAibG9hZGVkIikgJiYgby5kb20uZGF0YSh0aGlzLmVsLCB0aGlzLnNyY05hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbWdzLnB1c2godGhpcy5lbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkltZ0xhenlMb2FkLnJlc2V0CiAgICAgICAgICogQHBhcmFtIGltZ3Mge1N0cmluZyB8IEFycmF5IHwgRE9NRUxlbWVudH0g5paw55qE6ZyA6KaB5Yqg6L2955qEaW1nIOWmguaenOWIneWni+WMluaXtuS8oOWFpeeahOaYr2VsIOWImeatpOaXtuS4jemcgOimgeWPguaVsHIKICAgICAgICAgKiBAZGVzYyDph43nva7liqDovb0KICAgICAgICAgKi8KICAgICAgICByZXNldDogZnVuY3Rpb24oaW1ncykgewogICAgICAgICAgICB0aGlzLnNldERvbXMoaW1ncyk7CiAgICAgICAgICAgIHRoaXMuY2hlY2soKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkltZ0xhenlMb2FkLmNoZWNrCiAgICAgICAgICogQGRlc2Mg5p+l55yL5b2T5YmN5piv5ZCm56ym5ZCI5Yqg6L295p2h5Lu2CiAgICAgICAgICovCiAgICAgICAgY2hlY2s6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmlzU2Nyb2xsID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBsZW4gPSB0aGlzLmltZ3MubGVuZ3RoOwogICAgICAgICAgICBpZihsZW4gPT0gMCkgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIHZhciB0ID0gdGhpcy5jb250YWluZXIuc2Nyb2xsVG9wLAogICAgICAgICAgICAgICAgaCA9IG8uZG9tLmdldEhlaWdodCh0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgICAgIGlmKHRoaXMuY29udGFpbmVyID09IGRvY3VtZW50LmJvZHkpIHsKICAgICAgICAgICAgICAgIHZhciBfaCA9IG8uZG9tLmdldFNjcmVlbkhlaWdodCgpOwogICAgICAgICAgICAgICAgaCA+IF9oICYmIChoID0gX2gpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpID0gbGVuOwogICAgICAgICAgICBmb3IoOyBpLS07ICkgewogICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLmltZ3NbaV07CiAgICAgICAgICAgICAgICBpZihvLmRvbS5kYXRhKGl0ZW0sICJsb2FkZWQiKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW1ncy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrSW1nKGl0ZW0sIHQsIGgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjaGVja0ltZwogICAgICAgICAqLwogICAgICAgIGNoZWNrSW1nOiBmdW5jdGlvbihpdGVtLCB0LCBoKSB7CiAgICAgICAgICAgIHZhciB1ID0gby51dGlsOwogICAgICAgICAgICBpZighdS5pc05vZGUoaXRlbSkpIHJldHVybjsKICAgICAgICAgICAgdmFyIGQgPSBvLmRvbSwKICAgICAgICAgICAgICAgIGxvYWRlZCA9IGQuZGF0YShpdGVtLCAibG9hZGVkIiksCiAgICAgICAgICAgICAgICBzcmMgPSBkLmRhdGEoaXRlbSwgdGhpcy5zcmNOYW1lKTsKICAgICAgICAgICAgaWYobG9hZGVkKSAgcmV0dXJuOwogICAgICAgICAgICB2YXIgcG9zID0gZC5nZXRQb3NpdGlvbihpdGVtKSwKICAgICAgICAgICAgICAgIGhlaWdodCA9IGQuZ2V0SGVpZ2h0KGl0ZW0pLAogICAgICAgICAgICAgICAgdG9wID0gcG9zLnRvcDsKICAgICAgICAgICAgaWYodCA+PSB0b3AgLSBoICYmIHQgPD0gdG9wICsgaGVpZ2h0ICsgaCkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgdS5sb2FkSW1hZ2Uoc3JjLCB1LmVtcHR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0Lm5vdGlmeSgiaW1nbGF6eWxvYWQtY29yZS1sb2FkaW1nc3VjY2VzcyIsIGl0ZW0pOwogICAgICAgICAgICAgICAgICAgIGQuYXR0cihpdGVtLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogc3JjLAogICAgICAgICAgICAgICAgICAgICAgICAiZGF0YS1sb2FkZWQiOiAibG9hZGVkIgogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRoYXQubm90aWZ5KCJpbWdsYXp5bG9hZC1jb3JlLWxvYWRpbWdmYWlsZSIsIGl0ZW0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICogcHJvbWlzZemDqOWIhgogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQGF1dGhvciB3ZW5jaGVuZwogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiCgogICAgaWYgKHR5cGVvZiB3aW5kb3cuUHJvbWlzZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2Ygd2luZG93LlByb21pc2UucmVzb2x2ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBvLlByb21pc2UgPSB3aW5kb3cuUHJvbWlzZTsKICAgIH0KCiAgICB2YXIgU1RBVEVTID0gewogICAgICAgIFBFTkRJTkc6IDAsCiAgICAgICAgUkVTT0xWRUQ6IDEsCiAgICAgICAgUkVKRUNURUQ6IDIKICAgIH0KCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLlByb21pc2UKICAgICAqIEBkZXNjIOi3n2VzNueahOaWsFByb21pc2Xop4TojIPlrozlhajkuIDoh7QKICAgICAqLwogICAgdmFyIFByb21pc2UgPSBvLlByb21pc2UgPSBvLmRlZmluZSh7CgogICAgICAgIHN0YXRlOiBTVEFURVMuUEVORElORywKICAgICAgICByZXNvbHZlczogbnVsbCwKICAgICAgICByZWplY3RzOiBudWxsLAogICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgcmVhc29uOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvciBvY3RvcHVzLlByb21pc2UKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIC0g5Yid5aeL5YyW5Ye95pWw77yM5pyJcmVzb2x2ZSwgcmVqZWN05Lik5Liq5Ye95pWwCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oZnVuYykgewogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLnN0YXRlID0gU1RBVEVTLlBFTkRJTkc7CiAgICAgICAgICAgIHZhciByZXNvbHZlcyA9IHRoaXMucmVzb2x2ZXMgPSBbXTsKICAgICAgICAgICAgdmFyIHJlamVjdHMgPSB0aGlzLnJlamVjdHMgPSBbXTsKCiAgICAgICAgICAgIC8vIEF0IGZpcnN0IGNoYW5nZSBwcm9taXNlIHN0YXRlIGFmdGVyIHJlc29sdmV8cmVqZWN0CiAgICAgICAgICAgIHRoaXMuX2RvbmUoZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgdGhpcy5kYXRhID0gZGF0YTsKICAgICAgICAgICAgICAgIHByb21pc2Uuc3RhdGUgPSBTVEFURVMuUkVTT0xWRUQ7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9mYWlsKGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgICAgICAgdGhpcy5yZWFzb24gPSByZWFzb247CiAgICAgICAgICAgICAgICBwcm9taXNlLnN0YXRlID0gU1RBVEVTLlJFSkVDVEVEOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZ1bmMuY2FsbCh0aGlzLCBQcm9taXNlLm1ha2VSZXNvbHZlKHRoaXMpLCBQcm9taXNlLm1ha2VSZWplY3QodGhpcykpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiB0aGVuIOa3u+WKoOWbnuiwg+WHveaVsAogICAgICAgICAqIEBwYXJhbSAge0Z1bmN0aW9ufSBkb25lQ2FsbGJhY2sgLSDmiJDlip/lm57osIPlh73mlbAKICAgICAgICAgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZmFpbENhbGxiYWNrIC0g5aSx6LSl5Zue6LCD5Ye95pWwCiAgICAgICAgICogQHJldHVybiB7UHJvbWlzZX0g6L+U5Zue5LiA5Liq5paw55qEUHJvbWlzZeWunuS+iwogICAgICAgICAqLwogICAgICAgIHRoZW46IGZ1bmN0aW9uKGRvbmVDYWxsYmFjaywgZmFpbENhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpczsKCiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgIGlmIChkb25lQ2FsbGJhY2sgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBtb2RpZmllZERvbmVDYWxsYmFjayA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAvLyDov5Tlm57lgLxudWxs566X5LiN566XCiAgICAgICAgICAgICAgICAgICAgdmFyIHJldHVyblZhbCA9IGRvbmVDYWxsYmFjay5jYWxsKHRoaXMsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgIGlmIChQcm9taXNlLmlzUHJvbWlzZShyZXR1cm5WYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblZhbC50aGVuKHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByb21pc2UuX2RvbmUobW9kaWZpZWREb25lQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLl9kb25lKHJlc29sdmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJvbWlzZS5fZmFpbChmYWlsQ2FsbGJhY2sgPT0gbnVsbCA/IHJlamVjdCA6IGZhaWxDYWxsYmFjayk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogY2F0Y2gg5o2V5o2J6ZSZ6K+v77yM5Y+v5Lul5o2V5o2J5YmN6Z2iUHJvbWlzZemYn+WIl+acquiiq+aNleaNieeahOmUmeivrwogICAgICAgICAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmYWlsQ2FsbGJhY2sgLSDlpLHotKXlm57osIPlh73mlbAKICAgICAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSDmlrDnmoRQcm9taXNlCiAgICAgICAgICovCiAgICAgICAgY2F0Y2g6IGZ1bmN0aW9uKGZhaWxDYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4gdGhpcy50aGVuKG51bGwsIGZhaWxDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICog5YaF6YOo5re75Yqg5oiQ5Yqf5Zue6LCD77yM5aaC5p6cUHJvbWlzZeW3suaYr+aIkOWKn+eKtuaAge+8jOWImeebtOaOpeaJp+ihjOaIkOWKn+WbnuiwgwogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgX2RvbmU6IGZ1bmN0aW9uKGRvbmVDYWxsYmFjaykgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gU1RBVEVTLlJFU09MVkVEKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZUNhbGxiYWNrLmNhbGwodGhpcywgdGhpcy5kYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnJlc29sdmVzLnB1c2goZG9uZUNhbGxiYWNrKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICog5YaF6YOo5re75Yqg5aSx6LSl5Zue6LCD77yM5aaC5p6cUHJvbWlzZeW3suaYr+Wksei0peeKtuaAge+8jOWImeebtOaOpeaJp+ihjOWksei0peWbnuiwgwogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgX2ZhaWw6IGZ1bmN0aW9uKGZhaWxDYWxsYmFjaykgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gU1RBVEVTLlJFSkVDVEVEKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFpbENhbGxiYWNrLmNhbGwodGhpcywgdGhpcy5yZWFzb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVqZWN0cy5wdXNoKGZhaWxDYWxsYmFjayk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogUHJvbWlzZSDlj6/og73nmoTnirbmgIEKICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgKi8KICAgIFByb21pc2UuU1RBVEVTID0gU1RBVEVTOwoKICAgIC8qKgogICAgICog5Yik5pat5piv5ZCm5piv57G7UHJvbWlzZeWvueixoQogICAgICogQHBhcmFtICB7Kn0gIG9iagogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgUHJvbWlzZS5pc1Byb21pc2UgPSBmdW5jdGlvbihvYmopIHsKICAgICAgICByZXR1cm4gb2JqICE9IG51bGwgJiYgdHlwZW9mIG9ialsndGhlbiddID09PSAnZnVuY3Rpb24nOwogICAgfQoKICAgIC8qKgogICAgICog55Sf5oiQUHJvbWlzZeWunuS+i+WGheeahHJlc29sdmXmlrnms5UKICAgICAqIEBwYXJhbSAge1Byb21pc2V9IHByb21pc2UgLSBQcm9taXNl5a6e5L6LCiAgICAgKiBAcmV0dXJuIHtGdW5jdGlvbn0gcmVzb2x2ZeWHveaVsAogICAgICovCiAgICBQcm9taXNlLm1ha2VSZXNvbHZlID0gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgIGlmIChwcm9taXNlLnN0YXRlID4gU1RBVEVTLlBFTkRJTkcpIHJldHVybjsKCiAgICAgICAgICAgIHZhciByZXNvbHZlcyA9IHByb21pc2UucmVzb2x2ZXMsCiAgICAgICAgICAgICAgICBkb25lQ2FsbGJhY2s7CgogICAgICAgICAgICB3aGlsZSAoZG9uZUNhbGxiYWNrID0gcmVzb2x2ZXMuc2hpZnQoKSkgewogICAgICAgICAgICAgICAgZG9uZUNhbGxiYWNrLmNhbGwocHJvbWlzZSwgZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiDnlJ/miJBQcm9taXNl5a6e5L6L5YaF55qEcmVqZWN05pa55rOVCiAgICAgKiBAcGFyYW0gIHtQcm9taXNlfSBwcm9taXNlIC0gUHJvbWlzZeWunuS+iwogICAgICogQHJldHVybiB7RnVuY3Rpb259IHJlamVjdOWHveaVsAogICAgICovCiAgICBQcm9taXNlLm1ha2VSZWplY3QgPSBmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgICBpZiAocHJvbWlzZS5zdGF0ZSA+IFNUQVRFUy5QRU5ESU5HKSByZXR1cm47CgogICAgICAgICAgICB2YXIgcmVqZWN0cyA9IHByb21pc2UucmVqZWN0cywKICAgICAgICAgICAgICAgIGZhaWxDYWxsYmFjazsKCiAgICAgICAgICAgIHdoaWxlIChmYWlsQ2FsbGJhY2sgPSByZWplY3RzLnNoaWZ0KCkpIHsKICAgICAgICAgICAgICAgIGZhaWxDYWxsYmFjay5jYWxsKHByb21pc2UsIHJlYXNvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiDov5Tlm55Qcm9taXNl5a+56LGh77yM5LuldmFsdWXlgLzop6PlhrPjgILlpoLmnpzkvKDlhaXnmoR2YWx1ZeaYr+exu1Byb21pc2XnmoTlr7nosaHvvIzliJnlt7J2YWx1Zei/meS4qlByb21pc2UKICAgICAqIOeahOe7k+aenOS9nOS4ulByb21pc2XnmoTlhrPlrprlgLwKICAgICAqCiAgICAgKiBAcGFyYW0gIHsqfSB2YWx1ZQogICAgICogQHJldHVybiB7UHJvbWlzZX0g5paw55qEUHJvbWlzZeWvueixoQogICAgICovCiAgICBQcm9taXNlLnJlc29sdmUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgaWYgKFByb21pc2UuaXNQcm9taXNlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgdmFsdWUudGhlbihyZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KQogICAgfQoKICAgIC8qKgogICAgICog6L+U5Zue5LiA5Liq5aSx6LSl5Y6f5ZugcmVhc29u55qE5aSx6LSlUHJvbWlzZQogICAgICogQHBhcmFtICB7U3RyaW5nfSByZWFzb24gLSDlpLHotKXljp/lm6AKICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICAgIFByb21pc2UucmVqZWN0ID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIOeUn+aIkOaWsFByb21pc2UsIOaJgOaciXByb21pc2Vz5oiQ5Yqf5omN5oiQ5Yqf77yM5Y+q6KaB5pyJ5LiA5LiqcHJvbWlzZXPlpLHotKXlsLHlpLHotKUKICAgICAqIEBwYXJhbSAge0FycmF5fSBwcm9taXNlcwogICAgICogQHJldHVybiB7UHJvbWlzZX0g5paw55qEUHJvbWlzZQogICAgICovCiAgICBQcm9taXNlLmFsbCA9IGZ1bmN0aW9uKHByb21pc2VzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICBmdW5jdGlvbiBwZW5kaW5nKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB2YXIgY291bnRlciA9IDAsCiAgICAgICAgICAgICAgICAgICAgdmFsdWVzID0gW107CgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBjdXJJbmRleCA9IGNvdW50ZXI7CiAgICAgICAgICAgICAgICAgICAgY291bnRlcisrOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXNbY3VySW5kZXhdID0gZGF0YTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtLWNvdW50ZXIgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbCh3aW5kb3csIHZhbHVlcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkb25lID0gcGVuZGluZyhmdW5jdGlvbih2YWx1ZXMpIHsKICAgICAgICAgICAgICAgIHJlc29sdmUodmFsdWVzKQogICAgICAgICAgICB9KQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb21pc2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHByb21pc2VzW2ldOwogICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGRvbmUoKSwgcmVqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICog6L+U5Zue5LiA5Liq5pawUHJvbWlzZSwg5aaC5p6c5pyJ5LiA5LiqcHJvbWlzZeacgOWFiOWujOaIkO+8jOWImeaWsFByb21pc2XnlKjmnIDlhYjlrozmiJDnmoTmlbDmja7lrozmiJDvvIzlpoLmnpwKICAgICAqIOacieS4gOS4qnByb21pc2XmnIDmlrDlpLHotKXvvIzliJnlt7LmnIDlhYjlpLHotKXnmoRwcm9taXNl55qE5Y6f5Zug5aSx6LSlCiAgICAgKiBAcGFyYW0gIHtBcnJheX0gcHJvbWlzZXMKICAgICAqIEByZXR1cm4ge1Byb21pc2V9IOaWsFByb21pc2UKICAgICAqLwogICAgUHJvbWlzZS5yYWNlID0gZnVuY3Rpb24ocHJvbWlzZXMpIHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvbWlzZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHByb21pc2VzW2ldLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKfSkob2N0b3B1cyk7LyoqCiAqIOebtOaOpeW8leeUqGhhbW1lcgogKi8KCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgdmFyIEhhbW1lciA9IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gbmV3IEhhbW1lci5JbnN0YW5jZShlbGVtZW50LCBvcHRpb25zIHx8IHt9KTsKICAgIH07CgogICAgSGFtbWVyLmRlZmF1bHRzID0gewogICAgICAgIC8vIGFkZCBzdHlsZXMgYW5kIGF0dHJpYnV0ZXMgdG8gdGhlIGVsZW1lbnQgdG8gcHJldmVudCB0aGUgYnJvd3NlciBmcm9tIGRvaW5nCiAgICAgICAgLy8gaXRzIG5hdGl2ZSBiZWhhdmlvci4gdGhpcyBkb2VzbnQgcHJldmVudCB0aGUgc2Nyb2xsaW5nLCBidXQgY2FuY2VscwogICAgICAgIC8vIHRoZSBjb250ZXh0bWVudSwgdGFwIGhpZ2hsaWdodGluZyBldGMKICAgICAgICAvLyBzZXQgdG8gZmFsc2UgdG8gZGlzYWJsZSB0aGlzCiAgICAgICAgc3RvcF9icm93c2VyX2JlaGF2aW9yOiB7CiAgICAgICAgICAgIC8vIHRoaXMgYWxzbyB0cmlnZ2VycyBvbnNlbGVjdHN0YXJ0PWZhbHNlIGZvciBJRQogICAgICAgICAgICB1c2VyU2VsZWN0OiAnbm9uZScsCiAgICAgICAgICAgIC8vIHRoaXMgbWFrZXMgdGhlIGVsZW1lbnQgYmxvY2tpbmcgaW4gSUUxMCA+LCB5b3UgY291bGQgZXhwZXJpbWVudCB3aXRoIHRoZSB2YWx1ZQogICAgICAgICAgICAvLyBzZWUgZm9yIG1vcmUgb3B0aW9ucyB0aGlzIGlzc3VlOyBodHRwczovL2dpdGh1Yi5jb20vRWlnaHRNZWRpYS9oYW1tZXIuanMvaXNzdWVzLzI0MQogICAgICAgICAgICB0b3VjaEFjdGlvbjogJ25vbmUnLAogICAgICAgICAgICB0b3VjaENhbGxvdXQ6ICdub25lJywKICAgICAgICAgICAgY29udGVudFpvb21pbmc6ICdub25lJywKICAgICAgICAgICAgdXNlckRyYWc6ICdub25lJywKICAgICAgICAgICAgdGFwSGlnaGxpZ2h0Q29sb3I6ICdyZ2JhKDAsMCwwLDApJwogICAgICAgIH0KCiAgICAgICAgLy8gbW9yZSBzZXR0aW5ncyBhcmUgZGVmaW5lZCBwZXIgZ2VzdHVyZSBhdCBnZXN0dXJlcy5qcwogICAgfTsKCi8vIGRldGVjdCB0b3VjaGV2ZW50cwogICAgSGFtbWVyLkhBU19QT0lOVEVSRVZFTlRTID0gbmF2aWdhdG9yLnBvaW50ZXJFbmFibGVkIHx8IG5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkOwogICAgSGFtbWVyLkhBU19UT1VDSEVWRU5UUyA9ICgnb250b3VjaHN0YXJ0JyBpbiB3aW5kb3cpOwoKLy8gZG9udCB1c2UgbW91c2VldmVudHMgb24gbW9iaWxlIGRldmljZXMKICAgIEhhbW1lci5NT0JJTEVfUkVHRVggPSAvbW9iaWxlfHRhYmxldHxpcChhZHxob25lfG9kKXxhbmRyb2lkL2k7CiAgICBIYW1tZXIuTk9fTU9VU0VFVkVOVFMgPSBIYW1tZXIuSEFTX1RPVUNIRVZFTlRTICYmIG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goSGFtbWVyLk1PQklMRV9SRUdFWCk7CgovLyBldmVudHR5cGVzIHBlciB0b3VjaGV2ZW50IChzdGFydCwgbW92ZSwgZW5kKQovLyBhcmUgZmlsbGVkIGJ5IEhhbW1lci5ldmVudC5kZXRlcm1pbmVFdmVudFR5cGVzIG9uIHNldHVwCiAgICBIYW1tZXIuRVZFTlRfVFlQRVMgPSB7fTsKCi8vIGRpcmVjdGlvbiBkZWZpbmVzCiAgICBIYW1tZXIuRElSRUNUSU9OX0RPV04gPSAnZG93bic7CiAgICBIYW1tZXIuRElSRUNUSU9OX0xFRlQgPSAnbGVmdCc7CiAgICBIYW1tZXIuRElSRUNUSU9OX1VQID0gJ3VwJzsKICAgIEhhbW1lci5ESVJFQ1RJT05fUklHSFQgPSAncmlnaHQnOwoKLy8gcG9pbnRlciB0eXBlCiAgICBIYW1tZXIuUE9JTlRFUl9NT1VTRSA9ICdtb3VzZSc7CiAgICBIYW1tZXIuUE9JTlRFUl9UT1VDSCA9ICd0b3VjaCc7CiAgICBIYW1tZXIuUE9JTlRFUl9QRU4gPSAncGVuJzsKCi8vIHRvdWNoIGV2ZW50IGRlZmluZXMKICAgIEhhbW1lci5FVkVOVF9TVEFSVCA9ICdzdGFydCc7CiAgICBIYW1tZXIuRVZFTlRfTU9WRSA9ICdtb3ZlJzsKICAgIEhhbW1lci5FVkVOVF9FTkQgPSAnZW5kJzsKCi8vIGhhbW1lciBkb2N1bWVudCB3aGVyZSB0aGUgYmFzZSBldmVudHMgYXJlIGFkZGVkIGF0CiAgICBIYW1tZXIuRE9DVU1FTlQgPSBkb2N1bWVudDsKCi8vIHBsdWdpbnMgbmFtZXNwYWNlCiAgICBIYW1tZXIucGx1Z2lucyA9IHt9OwoKLy8gaWYgdGhlIHdpbmRvdyBldmVudHMgYXJlIHNldC4uLgogICAgSGFtbWVyLlJFQURZID0gZmFsc2U7CgogICAgLyoqCiAgICAgKiBzZXR1cCBldmVudHMgdG8gZGV0ZWN0IGdlc3R1cmVzIG9uIHRoZSBkb2N1bWVudAogICAgICovCiAgICBmdW5jdGlvbiBzZXR1cCgpIHsKICAgICAgICBpZihIYW1tZXIuUkVBRFkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gZmluZCB3aGF0IGV2ZW50dHlwZXMgd2UgYWRkIGxpc3RlbmVycyB0bwogICAgICAgIEhhbW1lci5ldmVudC5kZXRlcm1pbmVFdmVudFR5cGVzKCk7CgogICAgICAgIC8vIFJlZ2lzdGVyIGFsbCBnZXN0dXJlcyBpbnNpZGUgSGFtbWVyLmdlc3R1cmVzCiAgICAgICAgZm9yKHZhciBuYW1lIGluIEhhbW1lci5nZXN0dXJlcykgewogICAgICAgICAgICBpZihIYW1tZXIuZ2VzdHVyZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgIEhhbW1lci5kZXRlY3Rpb24ucmVnaXN0ZXIoSGFtbWVyLmdlc3R1cmVzW25hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQWRkIHRvdWNoIGV2ZW50cyBvbiB0aGUgZG9jdW1lbnQKICAgICAgICBIYW1tZXIuZXZlbnQub25Ub3VjaChIYW1tZXIuRE9DVU1FTlQsIEhhbW1lci5FVkVOVF9NT1ZFLCBIYW1tZXIuZGV0ZWN0aW9uLmRldGVjdCk7CiAgICAgICAgSGFtbWVyLmV2ZW50Lm9uVG91Y2goSGFtbWVyLkRPQ1VNRU5ULCBIYW1tZXIuRVZFTlRfRU5ELCBIYW1tZXIuZGV0ZWN0aW9uLmRldGVjdCk7CgogICAgICAgIC8vIEhhbW1lciBpcyByZWFkeS4uLiEKICAgICAgICBIYW1tZXIuUkVBRFkgPSB0cnVlOwogICAgfQoKICAgIEhhbW1lci5JbnN0YW5jZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIC8vIHNldHVwIEhhbW1lckpTIHdpbmRvdyBldmVudHMgYW5kIHJlZ2lzdGVyIGFsbCBnZXN0dXJlcwogICAgICAgIC8vIHRoaXMgYWxzbyBzZXRzIHVwIHRoZSBkZWZhdWx0IG9wdGlvbnMKICAgICAgICBzZXR1cCgpOwoKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwoKICAgICAgICAvLyBzdGFydC9zdG9wIGRldGVjdGlvbiBvcHRpb24KICAgICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwoKICAgICAgICAvLyBtZXJnZSBvcHRpb25zCiAgICAgICAgdGhpcy5vcHRpb25zID0gSGFtbWVyLnV0aWxzLmV4dGVuZCgKICAgICAgICAgICAgSGFtbWVyLnV0aWxzLmV4dGVuZCh7fSwgSGFtbWVyLmRlZmF1bHRzKSwKICAgICAgICAgICAgb3B0aW9ucyB8fCB7fSk7CgogICAgICAgIC8vIGFkZCBzb21lIGNzcyB0byB0aGUgZWxlbWVudCB0byBwcmV2ZW50IHRoZSBicm93c2VyIGZyb20gZG9pbmcgaXRzIG5hdGl2ZSBiZWhhdm9pcgogICAgICAgIGlmKHRoaXMub3B0aW9ucy5zdG9wX2Jyb3dzZXJfYmVoYXZpb3IpIHsKICAgICAgICAgICAgSGFtbWVyLnV0aWxzLnN0b3BEZWZhdWx0QnJvd3NlckJlaGF2aW9yKHRoaXMuZWxlbWVudCwgdGhpcy5vcHRpb25zLnN0b3BfYnJvd3Nlcl9iZWhhdmlvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBzdGFydCBkZXRlY3Rpb24gb24gdG91Y2hzdGFydAogICAgICAgIEhhbW1lci5ldmVudC5vblRvdWNoKGVsZW1lbnQsIEhhbW1lci5FVkVOVF9TVEFSVCwgZnVuY3Rpb24oZXYpIHsKICAgICAgICAgICAgaWYoc2VsZi5lbmFibGVkKSB7CiAgICAgICAgICAgICAgICBIYW1tZXIuZGV0ZWN0aW9uLnN0YXJ0RGV0ZWN0KHNlbGYsIGV2KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyByZXR1cm4gaW5zdGFuY2UKICAgICAgICByZXR1cm4gdGhpczsKICAgIH07CgoKICAgIEhhbW1lci5JbnN0YW5jZS5wcm90b3R5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogYmluZCBldmVudHMgdG8gdGhlIGluc3RhbmNlCiAgICAgICAgICogQHBhcmFtICAge1N0cmluZ30gICAgICBnZXN0dXJlCiAgICAgICAgICogQHBhcmFtICAge0Z1bmN0aW9ufSAgICBoYW5kbGVyCiAgICAgICAgICogQHJldHVybnMge0hhbW1lci5JbnN0YW5jZX0KICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24gb25FdmVudChnZXN0dXJlLCBoYW5kbGVyKXsKICAgICAgICAgICAgdmFyIGdlc3R1cmVzID0gZ2VzdHVyZS5zcGxpdCgnICcpOwogICAgICAgICAgICBmb3IodmFyIHQ9MDsgdDxnZXN0dXJlcy5sZW5ndGg7IHQrKykgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZ2VzdHVyZXNbdF0sIGhhbmRsZXIsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogdW5iaW5kIGV2ZW50cyB0byB0aGUgaW5zdGFuY2UKICAgICAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgIGdlc3R1cmUKICAgICAgICAgKiBAcGFyYW0gICB7RnVuY3Rpb259ICAgIGhhbmRsZXIKICAgICAgICAgKiBAcmV0dXJucyB7SGFtbWVyLkluc3RhbmNlfQogICAgICAgICAqLwogICAgICAgIG9mZjogZnVuY3Rpb24gb2ZmRXZlbnQoZ2VzdHVyZSwgaGFuZGxlcil7CiAgICAgICAgICAgIHZhciBnZXN0dXJlcyA9IGdlc3R1cmUuc3BsaXQoJyAnKTsKICAgICAgICAgICAgZm9yKHZhciB0PTA7IHQ8Z2VzdHVyZXMubGVuZ3RoOyB0KyspIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKGdlc3R1cmVzW3RdLCBoYW5kbGVyLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIHRyaWdnZXIgZ2VzdHVyZSBldmVudAogICAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgZ2VzdHVyZQogICAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgICAgZXZlbnREYXRhCiAgICAgICAgICogQHJldHVybnMge0hhbW1lci5JbnN0YW5jZX0KICAgICAgICAgKi8KICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiB0cmlnZ2VyRXZlbnQoZ2VzdHVyZSwgZXZlbnREYXRhKXsKICAgICAgICAgICAgLy8gY3JlYXRlIERPTSBldmVudAogICAgICAgICAgICB2YXIgZXZlbnQgPSBIYW1tZXIuRE9DVU1FTlQuY3JlYXRlRXZlbnQoJ0V2ZW50Jyk7CiAgICAgICAgICAgIGV2ZW50LmluaXRFdmVudChnZXN0dXJlLCB0cnVlLCB0cnVlKTsKICAgICAgICAgICAgZXZlbnQuZ2VzdHVyZSA9IGV2ZW50RGF0YTsKCiAgICAgICAgICAgIC8vIHRyaWdnZXIgb24gdGhlIHRhcmdldCBpZiBpdCBpcyBpbiB0aGUgaW5zdGFuY2UgZWxlbWVudCwKICAgICAgICAgICAgLy8gdGhpcyBpcyBmb3IgZXZlbnQgZGVsZWdhdGlvbiB0cmlja3MKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CiAgICAgICAgICAgIGlmKEhhbW1lci51dGlscy5oYXNQYXJlbnQoZXZlbnREYXRhLnRhcmdldCwgZWxlbWVudCkpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBldmVudERhdGEudGFyZ2V0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogZW5hYmxlIG9mIGRpc2FibGUgaGFtbWVyLmpzIGRldGVjdGlvbgogICAgICAgICAqIEBwYXJhbSAgIHtCb29sZWFufSAgIHN0YXRlCiAgICAgICAgICogQHJldHVybnMge0hhbW1lci5JbnN0YW5jZX0KICAgICAgICAgKi8KICAgICAgICBlbmFibGU6IGZ1bmN0aW9uIGVuYWJsZShzdGF0ZSkgewogICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSBzdGF0ZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIHRoaXMgaG9sZHMgdGhlIGxhc3QgbW92ZSBldmVudCwKICAgICAqIHVzZWQgdG8gZml4IGVtcHR5IHRvdWNoZW5kIGlzc3VlCiAgICAgKiBzZWUgdGhlIG9uVG91Y2ggZXZlbnQgZm9yIGFuIGV4cGxhbmF0aW9uCiAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICovCiAgICB2YXIgbGFzdF9tb3ZlX2V2ZW50ID0gbnVsbDsKCgogICAgLyoqCiAgICAgKiB3aGVuIHRoZSBtb3VzZSBpcyBob2xkIGRvd24sIHRoaXMgaXMgdHJ1ZQogICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgKi8KICAgIHZhciBlbmFibGVfZGV0ZWN0ID0gZmFsc2U7CgoKICAgIC8qKgogICAgICogd2hlbiB0b3VjaCBldmVudHMgaGF2ZSBiZWVuIGZpcmVkLCB0aGlzIGlzIHRydWUKICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICovCiAgICB2YXIgdG91Y2hfdHJpZ2dlcmVkID0gZmFsc2U7CgoKICAgIEhhbW1lci5ldmVudCA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBzaW1wbGUgYWRkRXZlbnRMaXN0ZW5lcgogICAgICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBlbGVtZW50CiAgICAgICAgICogQHBhcmFtICAge1N0cmluZ30gICAgICAgIHR5cGUKICAgICAgICAgKiBAcGFyYW0gICB7RnVuY3Rpb259ICAgICAgaGFuZGxlcgogICAgICAgICAqLwogICAgICAgIGJpbmREb206IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGhhbmRsZXIpIHsKICAgICAgICAgICAgdmFyIHR5cGVzID0gdHlwZS5zcGxpdCgnICcpOwogICAgICAgICAgICBmb3IodmFyIHQ9MDsgdDx0eXBlcy5sZW5ndGg7IHQrKykgewogICAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHR5cGVzW3RdLCBoYW5kbGVyLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogdG91Y2ggZXZlbnRzIHdpdGggbW91c2UgZmFsbGJhY2sKICAgICAgICAgKiBAcGFyYW0gICB7SFRNTEVsZW1lbnR9ICAgZWxlbWVudAogICAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgICBldmVudFR5cGUgICAgICAgIGxpa2UgSGFtbWVyLkVWRU5UX01PVkUKICAgICAgICAgKiBAcGFyYW0gICB7RnVuY3Rpb259ICAgICAgaGFuZGxlcgogICAgICAgICAqLwogICAgICAgIG9uVG91Y2g6IGZ1bmN0aW9uIG9uVG91Y2goZWxlbWVudCwgZXZlbnRUeXBlLCBoYW5kbGVyKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmluZERvbShlbGVtZW50LCBIYW1tZXIuRVZFTlRfVFlQRVNbZXZlbnRUeXBlXSwgZnVuY3Rpb24gYmluZERvbU9uVG91Y2goZXYpIHsKICAgICAgICAgICAgICAgIHZhciBzb3VyY2VFdmVudFR5cGUgPSBldi50eXBlLnRvTG93ZXJDYXNlKCk7CgogICAgICAgICAgICAgICAgLy8gb25tb3VzZXVwLCBidXQgd2hlbiB0b3VjaGVuZCBoYXMgYmVlbiBmaXJlZCB3ZSBkbyBub3RoaW5nLgogICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBmb3IgdG91Y2hkZXZpY2VzIHdoaWNoIGFsc28gZmlyZSBhIG1vdXNldXAgb24gdG91Y2hlbmQKICAgICAgICAgICAgICAgIGlmKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvbW91c2UvKSAmJiB0b3VjaF90cmlnZ2VyZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gbW91c2VidXR0b24gbXVzdCBiZSBkb3duIG9yIGEgdG91Y2ggZXZlbnQKICAgICAgICAgICAgICAgIGVsc2UgaWYoIHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdG91Y2gvKSB8fCAgIC8vIHRvdWNoIGV2ZW50cyBhcmUgYWx3YXlzIG9uIHNjcmVlbgogICAgICAgICAgICAgICAgICAgIHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvcG9pbnRlcmRvd24vKSB8fCAvLyBwb2ludGVyZXZlbnRzIHRvdWNoCiAgICAgICAgICAgICAgICAgICAgKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvbW91c2UvKSAmJiBldi53aGljaCA9PT0gMSkgICAvLyBtb3VzZSBpcyBwcmVzc2VkCiAgICAgICAgICAgICAgICAgICAgKXsKICAgICAgICAgICAgICAgICAgICBlbmFibGVfZGV0ZWN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgaW4gYSB0b3VjaCBldmVudCwgc2V0IHRoZSB0b3VjaCB0cmlnZ2VyZWQgYm9vbCB0byB0cnVlLAogICAgICAgICAgICAgICAgLy8gdGhpcyBmb3IgdGhlIGNvbmZsaWN0cyB0aGF0IG1heSBvY2N1ciBvbiBpb3MgYW5kIGFuZHJvaWQKICAgICAgICAgICAgICAgIGlmKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdG91Y2h8cG9pbnRlci8pKSB7CiAgICAgICAgICAgICAgICAgICAgdG91Y2hfdHJpZ2dlcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBjb3VudCB0aGUgdG90YWwgdG91Y2hlcyBvbiB0aGUgc2NyZWVuCiAgICAgICAgICAgICAgICB2YXIgY291bnRfdG91Y2hlcyA9IDA7CgogICAgICAgICAgICAgICAgLy8gd2hlbiB0b3VjaCBoYXMgYmVlbiB0cmlnZ2VyZWQgaW4gdGhpcyBkZXRlY3Rpb24gc2Vzc2lvbgogICAgICAgICAgICAgICAgLy8gYW5kIHdlIGFyZSBub3cgaGFuZGxpbmcgYSBtb3VzZSBldmVudCwgd2Ugc3RvcCB0aGF0IHRvIHByZXZlbnQgY29uZmxpY3RzCiAgICAgICAgICAgICAgICBpZihlbmFibGVfZGV0ZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdXBkYXRlIHBvaW50ZXJldmVudAogICAgICAgICAgICAgICAgICAgIGlmKEhhbW1lci5IQVNfUE9JTlRFUkVWRU5UUyAmJiBldmVudFR5cGUgIT0gSGFtbWVyLkVWRU5UX0VORCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb3VudF90b3VjaGVzID0gSGFtbWVyLlBvaW50ZXJFdmVudC51cGRhdGVQb2ludGVyKGV2ZW50VHlwZSwgZXYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyB0b3VjaAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYoc291cmNlRXZlbnRUeXBlLm1hdGNoKC90b3VjaC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50X3RvdWNoZXMgPSBldi50b3VjaGVzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gbW91c2UKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmKCF0b3VjaF90cmlnZ2VyZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY291bnRfdG91Y2hlcyA9IHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdXAvKSA/IDAgOiAxOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgd2UgYXJlIGluIGEgZW5kIGV2ZW50LCBidXQgd2hlbiB3ZSByZW1vdmUgb25lIHRvdWNoIGFuZAogICAgICAgICAgICAgICAgICAgIC8vIHdlIHN0aWxsIGhhdmUgZW5vdWdoLCBzZXQgZXZlbnRUeXBlIHRvIG1vdmUKICAgICAgICAgICAgICAgICAgICBpZihjb3VudF90b3VjaGVzID4gMCAmJiBldmVudFR5cGUgPT0gSGFtbWVyLkVWRU5UX0VORCkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudFR5cGUgPSBIYW1tZXIuRVZFTlRfTU9WRTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gbm8gdG91Y2hlcywgZm9yY2UgdGhlIGVuZCBldmVudAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYoIWNvdW50X3RvdWNoZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRUeXBlID0gSGFtbWVyLkVWRU5UX0VORDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgdG91Y2hlbmQgaGFzIG5vIHRvdWNoZXMsIGFuZCB3ZSBvZnRlbiB3YW50IHRvIHVzZSB0aGVzZSBpbiBvdXIgZ2VzdHVyZXMsCiAgICAgICAgICAgICAgICAgICAgLy8gd2Ugc2VuZCB0aGUgbGFzdCBtb3ZlIGV2ZW50IGFzIG91ciBldmVudERhdGEgaW4gdG91Y2hlbmQKICAgICAgICAgICAgICAgICAgICBpZighY291bnRfdG91Y2hlcyAmJiBsYXN0X21vdmVfZXZlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXYgPSBsYXN0X21vdmVfZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIHN0b3JlIHRoZSBsYXN0IG1vdmUgZXZlbnQKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9tb3ZlX2V2ZW50ID0gZXY7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyB0cmlnZ2VyIHRoZSBoYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5jYWxsKEhhbW1lci5kZXRlY3Rpb24sIHNlbGYuY29sbGVjdEV2ZW50RGF0YShlbGVtZW50LCBldmVudFR5cGUsIGV2KSk7CgogICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBwb2ludGVyZXZlbnQgZnJvbSBsaXN0CiAgICAgICAgICAgICAgICAgICAgaWYoSGFtbWVyLkhBU19QT0lOVEVSRVZFTlRTICYmIGV2ZW50VHlwZSA9PSBIYW1tZXIuRVZFTlRfRU5EKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50X3RvdWNoZXMgPSBIYW1tZXIuUG9pbnRlckV2ZW50LnVwZGF0ZVBvaW50ZXIoZXZlbnRUeXBlLCBldik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vZGVidWcoc291cmNlRXZlbnRUeXBlICsiICIrIGV2ZW50VHlwZSk7CgogICAgICAgICAgICAgICAgLy8gb24gdGhlIGVuZCB3ZSByZXNldCBldmVyeXRoaW5nCiAgICAgICAgICAgICAgICBpZighY291bnRfdG91Y2hlcykgewogICAgICAgICAgICAgICAgICAgIGxhc3RfbW92ZV9ldmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgZW5hYmxlX2RldGVjdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRvdWNoX3RyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIEhhbW1lci5Qb2ludGVyRXZlbnQucmVzZXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIHdlIGhhdmUgZGlmZmVyZW50IGV2ZW50cyBmb3IgZWFjaCBkZXZpY2UvYnJvd3NlcgogICAgICAgICAqIGRldGVybWluZSB3aGF0IHdlIG5lZWQgYW5kIHNldCB0aGVtIGluIHRoZSBIYW1tZXIuRVZFTlRfVFlQRVMgY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBkZXRlcm1pbmVFdmVudFR5cGVzOiBmdW5jdGlvbiBkZXRlcm1pbmVFdmVudFR5cGVzKCkgewogICAgICAgICAgICAvLyBkZXRlcm1pbmUgdGhlIGV2ZW50dHlwZSB3ZSB3YW50IHRvIHNldAogICAgICAgICAgICB2YXIgdHlwZXM7CgogICAgICAgICAgICAvLyBwb2ludGVyRXZlbnRzIG1hZ2ljCiAgICAgICAgICAgIGlmKEhhbW1lci5IQVNfUE9JTlRFUkVWRU5UUykgewogICAgICAgICAgICAgICAgdHlwZXMgPSBIYW1tZXIuUG9pbnRlckV2ZW50LmdldEV2ZW50cygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG9uIEFuZHJvaWQsIGlPUywgYmxhY2tiZXJyeSwgd2luZG93cyBtb2JpbGUgd2UgZG9udCB3YW50IGFueSBtb3VzZWV2ZW50cwogICAgICAgICAgICBlbHNlIGlmKEhhbW1lci5OT19NT1VTRUVWRU5UUykgewogICAgICAgICAgICAgICAgdHlwZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgJ3RvdWNoc3RhcnQnLAogICAgICAgICAgICAgICAgICAgICd0b3VjaG1vdmUnLAogICAgICAgICAgICAgICAgICAgICd0b3VjaGVuZCB0b3VjaGNhbmNlbCddOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGZvciBub24gcG9pbnRlciBldmVudHMgYnJvd3NlcnMgYW5kIG1peGVkIGJyb3dzZXJzLAogICAgICAgICAgICAvLyBsaWtlIGNocm9tZSBvbiB3aW5kb3dzOCB0b3VjaCBsYXB0b3AKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0eXBlcyA9IFsKICAgICAgICAgICAgICAgICAgICAndG91Y2hzdGFydCBtb3VzZWRvd24nLAogICAgICAgICAgICAgICAgICAgICd0b3VjaG1vdmUgbW91c2Vtb3ZlJywKICAgICAgICAgICAgICAgICAgICAndG91Y2hlbmQgdG91Y2hjYW5jZWwgbW91c2V1cCddOwogICAgICAgICAgICB9CgogICAgICAgICAgICBIYW1tZXIuRVZFTlRfVFlQRVNbSGFtbWVyLkVWRU5UX1NUQVJUXSAgPSB0eXBlc1swXTsKICAgICAgICAgICAgSGFtbWVyLkVWRU5UX1RZUEVTW0hhbW1lci5FVkVOVF9NT1ZFXSAgID0gdHlwZXNbMV07CiAgICAgICAgICAgIEhhbW1lci5FVkVOVF9UWVBFU1tIYW1tZXIuRVZFTlRfRU5EXSAgICA9IHR5cGVzWzJdOwogICAgICAgIH0sCgoKICAgICAgICAvKioKICAgICAgICAgKiBjcmVhdGUgdG91Y2hsaXN0IGRlcGVuZGluZyBvbiB0aGUgZXZlbnQKICAgICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICBldgogICAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgIGV2ZW50VHlwZSAgIHVzZWQgYnkgdGhlIGZha2VtdWx0aXRvdWNoIHBsdWdpbgogICAgICAgICAqLwogICAgICAgIGdldFRvdWNoTGlzdDogZnVuY3Rpb24gZ2V0VG91Y2hMaXN0KGV2LyosIGV2ZW50VHlwZSovKSB7CiAgICAgICAgICAgIC8vIGdldCB0aGUgZmFrZSBwb2ludGVyRXZlbnQgdG91Y2hsaXN0CiAgICAgICAgICAgIGlmKEhhbW1lci5IQVNfUE9JTlRFUkVWRU5UUykgewogICAgICAgICAgICAgICAgcmV0dXJuIEhhbW1lci5Qb2ludGVyRXZlbnQuZ2V0VG91Y2hMaXN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gZ2V0IHRoZSB0b3VjaGxpc3QKICAgICAgICAgICAgZWxzZSBpZihldi50b3VjaGVzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXYudG91Y2hlczsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBtYWtlIGZha2UgdG91Y2hsaXN0IGZyb20gbW91c2UgcG9zaXRpb24KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gW3sKICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyOiAxLAogICAgICAgICAgICAgICAgICAgIHBhZ2VYOiBldi5wYWdlWCwKICAgICAgICAgICAgICAgICAgICBwYWdlWTogZXYucGFnZVksCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBldi50YXJnZXQKICAgICAgICAgICAgICAgIH1dOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIGNvbGxlY3QgZXZlbnQgZGF0YSBmb3IgSGFtbWVyIGpzCiAgICAgICAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgIGVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgICAgZXZlbnRUeXBlICAgICAgICBsaWtlIEhhbW1lci5FVkVOVF9NT1ZFCiAgICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgICAgIGV2ZW50RGF0YQogICAgICAgICAqLwogICAgICAgIGNvbGxlY3RFdmVudERhdGE6IGZ1bmN0aW9uIGNvbGxlY3RFdmVudERhdGEoZWxlbWVudCwgZXZlbnRUeXBlLCBldikgewogICAgICAgICAgICB2YXIgdG91Y2hlcyA9IHRoaXMuZ2V0VG91Y2hMaXN0KGV2LCBldmVudFR5cGUpOwoKICAgICAgICAgICAgLy8gZmluZCBvdXQgcG9pbnRlclR5cGUKICAgICAgICAgICAgdmFyIHBvaW50ZXJUeXBlID0gSGFtbWVyLlBPSU5URVJfVE9VQ0g7CiAgICAgICAgICAgIGlmKGV2LnR5cGUubWF0Y2goL21vdXNlLykgfHwgSGFtbWVyLlBvaW50ZXJFdmVudC5tYXRjaFR5cGUoSGFtbWVyLlBPSU5URVJfTU9VU0UsIGV2KSkgewogICAgICAgICAgICAgICAgcG9pbnRlclR5cGUgPSBIYW1tZXIuUE9JTlRFUl9NT1VTRTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGNlbnRlciAgICAgIDogby51dGlsLmdldENlbnRlcih0b3VjaGVzKSwKICAgICAgICAgICAgICAgIHRpbWVTdGFtcCAgIDogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICB0YXJnZXQgICAgICA6IGV2LnRhcmdldCwKICAgICAgICAgICAgICAgIHRvdWNoZXMgICAgIDogdG91Y2hlcywKICAgICAgICAgICAgICAgIGV2ZW50VHlwZSAgIDogZXZlbnRUeXBlLAogICAgICAgICAgICAgICAgcG9pbnRlclR5cGUgOiBwb2ludGVyVHlwZSwKICAgICAgICAgICAgICAgIHNyY0V2ZW50ICAgIDogZXYsCgoKICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNyY0V2ZW50LnByZXZlbnRNYW5pcHVsYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcmNFdmVudC5wcmV2ZW50TWFuaXB1bGF0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3JjRXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zcmNFdmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgc3RvcERldGVjdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEhhbW1lci5kZXRlY3Rpb24uc3RvcERldGVjdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH07CgogICAgSGFtbWVyLlBvaW50ZXJFdmVudCA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBob2xkcyBhbGwgcG9pbnRlcnMKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIHBvaW50ZXJzOiB7fSwKCiAgICAgICAgLyoqCiAgICAgICAgICogZ2V0IGEgbGlzdCBvZiBwb2ludGVycwogICAgICAgICAqIEByZXR1cm5zIHtBcnJheX0gICAgIHRvdWNobGlzdAogICAgICAgICAqLwogICAgICAgIGdldFRvdWNoTGlzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgdmFyIHRvdWNobGlzdCA9IFtdOwoKICAgICAgICAgICAgLy8gd2UgY2FuIHVzZSBmb3JFYWNoIHNpbmNlIHBvaW50ZXJFdmVudHMgb25seSBpcyBpbiBJRTEwCiAgICAgICAgICAgIE9iamVjdC5rZXlzKHNlbGYucG9pbnRlcnMpLnNvcnQoKS5mb3JFYWNoKGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgICAgICB0b3VjaGxpc3QucHVzaChzZWxmLnBvaW50ZXJzW2lkXSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdG91Y2hsaXN0OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIHVwZGF0ZSB0aGUgcG9zaXRpb24gb2YgYSBwb2ludGVyCiAgICAgICAgICogQHBhcmFtICAge1N0cmluZ30gICB0eXBlICAgICAgICAgICAgIEhhbW1lci5FVkVOVF9FTkQKICAgICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgIHBvaW50ZXJFdmVudAogICAgICAgICAqLwogICAgICAgIHVwZGF0ZVBvaW50ZXI6IGZ1bmN0aW9uKHR5cGUsIHBvaW50ZXJFdmVudCkgewogICAgICAgICAgICBpZih0eXBlID09IEhhbW1lci5FVkVOVF9FTkQpIHsKICAgICAgICAgICAgICAgIHRoaXMucG9pbnRlcnMgPSB7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudC5pZGVudGlmaWVyID0gcG9pbnRlckV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICAgIHRoaXMucG9pbnRlcnNbcG9pbnRlckV2ZW50LnBvaW50ZXJJZF0gPSBwb2ludGVyRXZlbnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnBvaW50ZXJzKS5sZW5ndGg7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogY2hlY2sgaWYgZXYgbWF0Y2hlcyBwb2ludGVydHlwZQogICAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgICBwb2ludGVyVHlwZSAgICAgSGFtbWVyLlBPSU5URVJfTU9VU0UKICAgICAgICAgKiBAcGFyYW0gICB7UG9pbnRlckV2ZW50fSAgZXYKICAgICAgICAgKi8KICAgICAgICBtYXRjaFR5cGU6IGZ1bmN0aW9uKHBvaW50ZXJUeXBlLCBldikgewogICAgICAgICAgICBpZighZXYucG9pbnRlclR5cGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHR5cGVzID0ge307CiAgICAgICAgICAgIHR5cGVzW0hhbW1lci5QT0lOVEVSX01PVVNFXSA9IChldi5wb2ludGVyVHlwZSA9PSBldi5NU1BPSU5URVJfVFlQRV9NT1VTRSB8fCBldi5wb2ludGVyVHlwZSA9PSBIYW1tZXIuUE9JTlRFUl9NT1VTRSk7CiAgICAgICAgICAgIHR5cGVzW0hhbW1lci5QT0lOVEVSX1RPVUNIXSA9IChldi5wb2ludGVyVHlwZSA9PSBldi5NU1BPSU5URVJfVFlQRV9UT1VDSCB8fCBldi5wb2ludGVyVHlwZSA9PSBIYW1tZXIuUE9JTlRFUl9UT1VDSCk7CiAgICAgICAgICAgIHR5cGVzW0hhbW1lci5QT0lOVEVSX1BFTl0gPSAoZXYucG9pbnRlclR5cGUgPT0gZXYuTVNQT0lOVEVSX1RZUEVfUEVOIHx8IGV2LnBvaW50ZXJUeXBlID09IEhhbW1lci5QT0lOVEVSX1BFTik7CiAgICAgICAgICAgIHJldHVybiB0eXBlc1twb2ludGVyVHlwZV07CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIGdldCBldmVudHMKICAgICAgICAgKi8KICAgICAgICBnZXRFdmVudHM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgJ3BvaW50ZXJkb3duIE1TUG9pbnRlckRvd24nLAogICAgICAgICAgICAgICAgJ3BvaW50ZXJtb3ZlIE1TUG9pbnRlck1vdmUnLAogICAgICAgICAgICAgICAgJ3BvaW50ZXJ1cCBwb2ludGVyY2FuY2VsIE1TUG9pbnRlclVwIE1TUG9pbnRlckNhbmNlbCcKICAgICAgICAgICAgXTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiByZXNldCB0aGUgbGlzdAogICAgICAgICAqLwogICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5wb2ludGVycyA9IHt9OwogICAgICAgIH0KICAgIH07CgoKICAgIEhhbW1lci51dGlscyA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBleHRlbmQgbWV0aG9kLAogICAgICAgICAqIGFsc28gdXNlZCBmb3IgY2xvbmluZyB3aGVuIGRlc3QgaXMgYW4gZW1wdHkgb2JqZWN0CiAgICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgZGVzdAogICAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgIHNyYwogICAgICAgICAqIEBwYXJtCXtCb29sZWFufQltZXJnZQkJZG8gYSBtZXJnZQogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9ICAgIGRlc3QKICAgICAgICAgKi8KICAgICAgICBleHRlbmQ6IGZ1bmN0aW9uIGV4dGVuZChkZXN0LCBzcmMsIG1lcmdlKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIHsKICAgICAgICAgICAgICAgIGlmKGRlc3Rba2V5XSAhPT0gdW5kZWZpbmVkICYmIG1lcmdlKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZXN0W2tleV0gPSBzcmNba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGVzdDsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogZmluZCBpZiBhIG5vZGUgaXMgaW4gdGhlIGdpdmVuIHBhcmVudAogICAgICAgICAqIHVzZWQgZm9yIGV2ZW50IGRlbGVnYXRpb24gdHJpY2tzCiAgICAgICAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgIG5vZGUKICAgICAgICAgKiBAcGFyYW0gICB7SFRNTEVsZW1lbnR9ICAgcGFyZW50CiAgICAgICAgICogQHJldHVybnMge2Jvb2xlYW59ICAgICAgIGhhc19wYXJlbnQKICAgICAgICAgKi8KICAgICAgICBoYXNQYXJlbnQ6IGZ1bmN0aW9uKG5vZGUsIHBhcmVudCkgewogICAgICAgICAgICB3aGlsZShub2RlKXsKICAgICAgICAgICAgICAgIGlmKG5vZGUgPT0gcGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogYm9vbGVhbiBpZiB0aGUgZGlyZWN0aW9uIGlzIHZlcnRpY2FsCiAgICAgICAgICogQHBhcmFtICAgIHtTdHJpbmd9ICAgIGRpcmVjdGlvbgogICAgICAgICAqIEByZXR1cm5zICB7Qm9vbGVhbn0gICBpc192ZXJ0aWNhbAogICAgICAgICAqLwogICAgICAgIGlzVmVydGljYWw6IGZ1bmN0aW9uIGlzVmVydGljYWwoZGlyZWN0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiAoZGlyZWN0aW9uID09IEhhbW1lci5ESVJFQ1RJT05fVVAgfHwgZGlyZWN0aW9uID09IEhhbW1lci5ESVJFQ1RJT05fRE9XTik7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIHN0b3AgYnJvd3NlciBkZWZhdWx0IGJlaGF2aW9yIHdpdGggY3NzIHByb3BzCiAgICAgICAgICogQHBhcmFtICAge0h0bWxFbGVtZW50fSAgIGVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgICAgY3NzX3Byb3BzCiAgICAgICAgICovCiAgICAgICAgc3RvcERlZmF1bHRCcm93c2VyQmVoYXZpb3I6IGZ1bmN0aW9uIHN0b3BEZWZhdWx0QnJvd3NlckJlaGF2aW9yKGVsZW1lbnQsIGNzc19wcm9wcykgewogICAgICAgICAgICB2YXIgcHJvcCwKICAgICAgICAgICAgICAgIHZlbmRvcnMgPSBbJ3dlYmtpdCcsJ2todG1sJywnbW96JywnbXMnLCdvJywnJ107CgogICAgICAgICAgICBpZighY3NzX3Byb3BzIHx8ICFlbGVtZW50LnN0eWxlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHdpdGggY3NzIHByb3BlcnRpZXMgZm9yIG1vZGVybiBicm93c2VycwogICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgdmVuZG9ycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgZm9yKHZhciBwIGluIGNzc19wcm9wcykgewogICAgICAgICAgICAgICAgICAgIGlmKGNzc19wcm9wcy5oYXNPd25Qcm9wZXJ0eShwKSkgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9wID0gcDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHZlbmRlciBwcmVmaXggYXQgdGhlIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHZlbmRvcnNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3AgPSB2ZW5kb3JzW2ldICsgcHJvcC5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHByb3Auc3Vic3RyaW5nKDEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXQgdGhlIHN0eWxlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBjc3NfcHJvcHNbcF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBhbHNvIHRoZSBkaXNhYmxlIG9uc2VsZWN0c3RhcnQKICAgICAgICAgICAgaWYoY3NzX3Byb3BzLnVzZXJTZWxlY3QgPT0gJ25vbmUnKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50Lm9uc2VsZWN0c3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICBIYW1tZXIuZGV0ZWN0aW9uID0gewogICAgICAgIC8vIGNvbnRhaW5zIGFsbCByZWdpc3RyZWQgSGFtbWVyLmdlc3R1cmVzIGluIHRoZSBjb3JyZWN0IG9yZGVyCiAgICAgICAgZ2VzdHVyZXM6IFtdLAoKICAgICAgICAvLyBkYXRhIG9mIHRoZSBjdXJyZW50IEhhbW1lci5nZXN0dXJlIGRldGVjdGlvbiBzZXNzaW9uCiAgICAgICAgY3VycmVudDogbnVsbCwKCiAgICAgICAgLy8gdGhlIHByZXZpb3VzIEhhbW1lci5nZXN0dXJlIHNlc3Npb24gZGF0YQogICAgICAgIC8vIGlzIGEgZnVsbCBjbG9uZSBvZiB0aGUgcHJldmlvdXMgZ2VzdHVyZS5jdXJyZW50IG9iamVjdAogICAgICAgIHByZXZpb3VzOiBudWxsLAoKICAgICAgICAvLyB3aGVuIHRoaXMgYmVjb21lcyB0cnVlLCBubyBnZXN0dXJlcyBhcmUgZmlyZWQKICAgICAgICBzdG9wcGVkOiBmYWxzZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIHN0YXJ0IEhhbW1lci5nZXN0dXJlIGRldGVjdGlvbgogICAgICAgICAqIEBwYXJhbSAgIHtIYW1tZXIuSW5zdGFuY2V9ICAgaW5zdAogICAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgICAgICAgICAgZXZlbnREYXRhCiAgICAgICAgICovCiAgICAgICAgc3RhcnREZXRlY3Q6IGZ1bmN0aW9uIHN0YXJ0RGV0ZWN0KGluc3QsIGV2ZW50RGF0YSkgewogICAgICAgICAgICAvLyBhbHJlYWR5IGJ1c3kgd2l0aCBhIEhhbW1lci5nZXN0dXJlIGRldGVjdGlvbiBvbiBhbiBlbGVtZW50CiAgICAgICAgICAgIGlmKHRoaXMuY3VycmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0b3BwZWQgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMuY3VycmVudCA9IHsKICAgICAgICAgICAgICAgIGluc3QgICAgICAgIDogaW5zdCwgLy8gcmVmZXJlbmNlIHRvIEhhbW1lckluc3RhbmNlIHdlJ3JlIHdvcmtpbmcgZm9yCiAgICAgICAgICAgICAgICBzdGFydEV2ZW50ICA6IEhhbW1lci51dGlscy5leHRlbmQoe30sIGV2ZW50RGF0YSksIC8vIHN0YXJ0IGV2ZW50RGF0YSBmb3IgZGlzdGFuY2VzLCB0aW1pbmcgZXRjCiAgICAgICAgICAgICAgICBsYXN0RXZlbnQgICA6IGZhbHNlLCAvLyBsYXN0IGV2ZW50RGF0YQogICAgICAgICAgICAgICAgbmFtZSAgICAgICAgOiAnJyAvLyBjdXJyZW50IGdlc3R1cmUgd2UncmUgaW4vZGV0ZWN0ZWQsIGNhbiBiZSAndGFwJywgJ2hvbGQnIGV0YwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5kZXRlY3QoZXZlbnREYXRhKTsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogSGFtbWVyLmdlc3R1cmUgZGV0ZWN0aW9uCiAgICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgZXZlbnREYXRhCiAgICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgZXZlbnREYXRhCiAgICAgICAgICovCiAgICAgICAgZGV0ZWN0OiBmdW5jdGlvbiBkZXRlY3QoZXZlbnREYXRhKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmN1cnJlbnQgfHwgdGhpcy5zdG9wcGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGV4dGVuZCBldmVudCBkYXRhIHdpdGggY2FsY3VsYXRpb25zIGFib3V0IHNjYWxlLCBkaXN0YW5jZSBldGMKICAgICAgICAgICAgZXZlbnREYXRhID0gdGhpcy5leHRlbmRFdmVudERhdGEoZXZlbnREYXRhKTsKCiAgICAgICAgICAgIC8vIGluc3RhbmNlIG9wdGlvbnMKICAgICAgICAgICAgdmFyIGluc3Rfb3B0aW9ucyA9IHRoaXMuY3VycmVudC5pbnN0Lm9wdGlvbnM7CgogICAgICAgICAgICAvLyBjYWxsIEhhbW1lci5nZXN0dXJlIGhhbmRsZXJzCiAgICAgICAgICAgIGZvcih2YXIgZz0wLGxlbj10aGlzLmdlc3R1cmVzLmxlbmd0aDsgZzxsZW47IGcrKykgewogICAgICAgICAgICAgICAgdmFyIGdlc3R1cmUgPSB0aGlzLmdlc3R1cmVzW2ddOwoKICAgICAgICAgICAgICAgIC8vIG9ubHkgd2hlbiB0aGUgaW5zdGFuY2Ugb3B0aW9ucyBoYXZlIGVuYWJsZWQgdGhpcyBnZXN0dXJlCiAgICAgICAgICAgICAgICBpZighdGhpcy5zdG9wcGVkICYmIGluc3Rfb3B0aW9uc1tnZXN0dXJlLm5hbWVdICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIC8vIGlmIGEgaGFuZGxlciByZXR1cm5zIGZhbHNlLCB3ZSBzdG9wIHdpdGggdGhlIGRldGVjdGlvbgogICAgICAgICAgICAgICAgICAgIGlmKGdlc3R1cmUuaGFuZGxlci5jYWxsKGdlc3R1cmUsIGV2ZW50RGF0YSwgdGhpcy5jdXJyZW50Lmluc3QpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3BEZXRlY3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBzdG9yZSBhcyBwcmV2aW91cyBldmVudCBldmVudAogICAgICAgICAgICBpZih0aGlzLmN1cnJlbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudC5sYXN0RXZlbnQgPSBldmVudERhdGE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGVuZGV2ZW50LCBidXQgbm90IHRoZSBsYXN0IHRvdWNoLCBzbyBkb250IHN0b3AKICAgICAgICAgICAgaWYoZXZlbnREYXRhLmV2ZW50VHlwZSA9PSBIYW1tZXIuRVZFTlRfRU5EICYmICFldmVudERhdGEudG91Y2hlcy5sZW5ndGgtMSkgewogICAgICAgICAgICAgICAgdGhpcy5zdG9wRGV0ZWN0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBldmVudERhdGE7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIGNsZWFyIHRoZSBIYW1tZXIuZ2VzdHVyZSB2YXJzCiAgICAgICAgICogdGhpcyBpcyBjYWxsZWQgb24gZW5kRGV0ZWN0LCBidXQgY2FuIGFsc28gYmUgdXNlZCB3aGVuIGEgZmluYWwgSGFtbWVyLmdlc3R1cmUgaGFzIGJlZW4gZGV0ZWN0ZWQKICAgICAgICAgKiB0byBzdG9wIG90aGVyIEhhbW1lci5nZXN0dXJlcyBmcm9tIGJlaW5nIGZpcmVkCiAgICAgICAgICovCiAgICAgICAgc3RvcERldGVjdDogZnVuY3Rpb24gc3RvcERldGVjdCgpIHsKICAgICAgICAgICAgLy8gY2xvbmUgY3VycmVudCBkYXRhIHRvIHRoZSBzdG9yZSBhcyB0aGUgcHJldmlvdXMgZ2VzdHVyZQogICAgICAgICAgICAvLyB1c2VkIGZvciB0aGUgZG91YmxlIHRhcCBnZXN0dXJlLCBzaW5jZSB0aGlzIGlzIGFuIG90aGVyIGdlc3R1cmUgZGV0ZWN0IHNlc3Npb24KICAgICAgICAgICAgdGhpcy5wcmV2aW91cyA9IEhhbW1lci51dGlscy5leHRlbmQoe30sIHRoaXMuY3VycmVudCk7CgogICAgICAgICAgICAvLyByZXNldCB0aGUgY3VycmVudAogICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSBudWxsOwoKICAgICAgICAgICAgLy8gc3RvcHBlZCEKICAgICAgICAgICAgdGhpcy5zdG9wcGVkID0gdHJ1ZTsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogZXh0ZW5kIGV2ZW50RGF0YSBmb3IgSGFtbWVyLmdlc3R1cmVzCiAgICAgICAgICogQHBhcmFtICAge09iamVjdH0gICBldgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9ICAgZXYKICAgICAgICAgKi8KICAgICAgICBleHRlbmRFdmVudERhdGE6IGZ1bmN0aW9uIGV4dGVuZEV2ZW50RGF0YShldikgewogICAgICAgICAgICB2YXIgc3RhcnRFdiA9IHRoaXMuY3VycmVudC5zdGFydEV2ZW50OwoKICAgICAgICAgICAgLy8gaWYgdGhlIHRvdWNoZXMgY2hhbmdlLCBzZXQgdGhlIG5ldyB0b3VjaGVzIG92ZXIgdGhlIHN0YXJ0RXZlbnQgdG91Y2hlcwogICAgICAgICAgICAvLyB0aGlzIGJlY2F1c2UgdG91Y2hldmVudHMgZG9uJ3QgaGF2ZSBhbGwgdGhlIHRvdWNoZXMgb24gdG91Y2hzdGFydCwgb3IgdGhlCiAgICAgICAgICAgIC8vIHVzZXIgbXVzdCBwbGFjZSBoaXMgZmluZ2VycyBhdCB0aGUgRVhBQ1Qgc2FtZSB0aW1lIG9uIHRoZSBzY3JlZW4sIHdoaWNoIGlzIG5vdCByZWFsaXN0aWMKICAgICAgICAgICAgLy8gYnV0LCBzb21ldGltZXMgaXQgaGFwcGVucyB0aGF0IGJvdGggZmluZ2VycyBhcmUgdG91Y2hpbmcgYXQgdGhlIEVYQUNUIHNhbWUgdGltZQogICAgICAgICAgICBpZihzdGFydEV2ICYmIChldi50b3VjaGVzLmxlbmd0aCAhPSBzdGFydEV2LnRvdWNoZXMubGVuZ3RoIHx8IGV2LnRvdWNoZXMgPT09IHN0YXJ0RXYudG91Y2hlcykpIHsKICAgICAgICAgICAgICAgIC8vIGV4dGVuZCAxIGxldmVsIGRlZXAgdG8gZ2V0IHRoZSB0b3VjaGxpc3Qgd2l0aCB0aGUgdG91Y2ggb2JqZWN0cwogICAgICAgICAgICAgICAgc3RhcnRFdi50b3VjaGVzID0gW107CiAgICAgICAgICAgICAgICBmb3IodmFyIGk9MCxsZW49ZXYudG91Y2hlcy5sZW5ndGg7IGk8bGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBzdGFydEV2LnRvdWNoZXMucHVzaChIYW1tZXIudXRpbHMuZXh0ZW5kKHt9LCBldi50b3VjaGVzW2ldKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkZWx0YV90aW1lID0gZXYudGltZVN0YW1wIC0gc3RhcnRFdi50aW1lU3RhbXAsCiAgICAgICAgICAgICAgICBkZWx0YV94ID0gZXYuY2VudGVyLnBhZ2VYIC0gc3RhcnRFdi5jZW50ZXIucGFnZVgsCiAgICAgICAgICAgICAgICBkZWx0YV95ID0gZXYuY2VudGVyLnBhZ2VZIC0gc3RhcnRFdi5jZW50ZXIucGFnZVksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eSA9IG8udXRpbC5nZXRWZWxvY2l0eShkZWx0YV90aW1lLCBkZWx0YV94LCBkZWx0YV95KTsKCiAgICAgICAgICAgIEhhbW1lci51dGlscy5leHRlbmQoZXYsIHsKICAgICAgICAgICAgICAgIGRlbHRhVGltZSAgIDogZGVsdGFfdGltZSwKCiAgICAgICAgICAgICAgICBkZWx0YVggICAgICA6IGRlbHRhX3gsCiAgICAgICAgICAgICAgICBkZWx0YVkgICAgICA6IGRlbHRhX3ksCgogICAgICAgICAgICAgICAgdmVsb2NpdHlYICAgOiB2ZWxvY2l0eS54LAogICAgICAgICAgICAgICAgdmVsb2NpdHlZICAgOiB2ZWxvY2l0eS55LAoKICAgICAgICAgICAgICAgIGRpc3RhbmNlICAgIDogby51dGlsLmdldERpc3RhbmNlKHN0YXJ0RXYuY2VudGVyLCBldi5jZW50ZXIpLAogICAgICAgICAgICAgICAgYW5nbGUgICAgICAgOiBvLnV0aWwuZ2V0QW5nbGUoc3RhcnRFdi5jZW50ZXIsIGV2LmNlbnRlciksCiAgICAgICAgICAgICAgICBkaXJlY3Rpb24gICA6IG8udXRpbC5nZXREaXJlY3Rpb24oc3RhcnRFdi5jZW50ZXIsIGV2LmNlbnRlciksCgogICAgICAgICAgICAgICAgc2NhbGUgICAgICAgOiBvLnV0aWwuZ2V0U2NhbGUoc3RhcnRFdi50b3VjaGVzLCBldi50b3VjaGVzKSwKICAgICAgICAgICAgICAgIHJvdGF0aW9uICAgIDogby51dGlsLmdldFJvdGF0aW9uKHN0YXJ0RXYudG91Y2hlcywgZXYudG91Y2hlcyksCgogICAgICAgICAgICAgICAgc3RhcnRFdmVudCAgOiBzdGFydEV2CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIGV2OwogICAgICAgIH0sCgoKICAgICAgICAvKioKICAgICAgICAgKiByZWdpc3RlciBuZXcgZ2VzdHVyZQogICAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgIGdlc3R1cmUgb2JqZWN0LCBzZWUgZ2VzdHVyZXMuanMgZm9yIGRvY3VtZW50YXRpb24KICAgICAgICAgKiBAcmV0dXJucyB7QXJyYXl9ICAgICBnZXN0dXJlcwogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiByZWdpc3RlcihnZXN0dXJlKSB7CiAgICAgICAgICAgIC8vIGFkZCBhbiBlbmFibGUgZ2VzdHVyZSBvcHRpb25zIGlmIHRoZXJlIGlzIG5vIGdpdmVuCiAgICAgICAgICAgIHZhciBvcHRpb25zID0gZ2VzdHVyZS5kZWZhdWx0cyB8fCB7fTsKICAgICAgICAgICAgaWYob3B0aW9uc1tnZXN0dXJlLm5hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnNbZ2VzdHVyZS5uYW1lXSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGV4dGVuZCBIYW1tZXIgZGVmYXVsdCBvcHRpb25zIHdpdGggdGhlIEhhbW1lci5nZXN0dXJlIG9wdGlvbnMKICAgICAgICAgICAgSGFtbWVyLnV0aWxzLmV4dGVuZChIYW1tZXIuZGVmYXVsdHMsIG9wdGlvbnMsIHRydWUpOwoKICAgICAgICAgICAgLy8gc2V0IGl0cyBpbmRleAogICAgICAgICAgICBnZXN0dXJlLmluZGV4ID0gZ2VzdHVyZS5pbmRleCB8fCAxMDAwOwoKICAgICAgICAgICAgLy8gYWRkIEhhbW1lci5nZXN0dXJlIHRvIHRoZSBsaXN0CiAgICAgICAgICAgIHRoaXMuZ2VzdHVyZXMucHVzaChnZXN0dXJlKTsKCiAgICAgICAgICAgIC8vIHNvcnQgdGhlIGxpc3QgYnkgaW5kZXgKICAgICAgICAgICAgdGhpcy5nZXN0dXJlcy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgICAgIGlmIChhLmluZGV4IDwgYi5pbmRleCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChhLmluZGV4ID4gYi5pbmRleCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2VzdHVyZXM7CiAgICAgICAgfQogICAgfTsKCgogICAgSGFtbWVyLmdlc3R1cmVzID0gSGFtbWVyLmdlc3R1cmVzIHx8IHt9OwoKICAgIC8qKgogICAgICogQ3VzdG9tIGdlc3R1cmVzCiAgICAgKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAqCiAgICAgKiBHZXN0dXJlIG9iamVjdAogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAqIFRoZSBvYmplY3Qgc3RydWN0dXJlIG9mIGEgZ2VzdHVyZToKICAgICAqCiAgICAgKiB7IG5hbWU6ICdteWdlc3R1cmUnLAogKiAgIGluZGV4OiAxMzM3LAogKiAgIGRlZmF1bHRzOiB7CiAqICAgICBteWdlc3R1cmVfb3B0aW9uOiB0cnVlCiAqICAgfQogKiAgIGhhbmRsZXI6IGZ1bmN0aW9uKHR5cGUsIGV2LCBpbnN0KSB7CiAqICAgICAvLyB0cmlnZ2VyIGdlc3R1cmUgZXZlbnQKICogICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUsIGV2KTsKICogICB9CiAqIH0KCiAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICBuYW1lCiAgICAgKiB0aGlzIHNob3VsZCBiZSB0aGUgbmFtZSBvZiB0aGUgZ2VzdHVyZSwgbG93ZXJjYXNlCiAgICAgKiBpdCBpcyBhbHNvIGJlaW5nIHVzZWQgdG8gZGlzYWJsZS9lbmFibGUgdGhlIGdlc3R1cmUgcGVyIGluc3RhbmNlIGNvbmZpZy4KICAgICAqCiAgICAgKiBAcGFyYW0gICB7TnVtYmVyfSAgICBbaW5kZXg9MTAwMF0KICAgICAqIHRoZSBpbmRleCBvZiB0aGUgZ2VzdHVyZSwgd2hlcmUgaXQgaXMgZ29pbmcgdG8gYmUgaW4gdGhlIHN0YWNrIG9mIGdlc3R1cmVzIGRldGVjdGlvbgogICAgICogbGlrZSB3aGVuIHlvdSBidWlsZCBhbiBnZXN0dXJlIHRoYXQgZGVwZW5kcyBvbiB0aGUgZHJhZyBnZXN0dXJlLCBpdCBpcyBhIGdvb2QKICAgICAqIGlkZWEgdG8gcGxhY2UgaXQgYWZ0ZXIgdGhlIGluZGV4IG9mIHRoZSBkcmFnIGdlc3R1cmUuCiAgICAgKgogICAgICogQHBhcmFtICAge09iamVjdH0gICAgW2RlZmF1bHRzPXt9XQogICAgICogdGhlIGRlZmF1bHQgc2V0dGluZ3Mgb2YgdGhlIGdlc3R1cmUuIHRoZXNlIGFyZSBhZGRlZCB0byB0aGUgaW5zdGFuY2Ugc2V0dGluZ3MsCiAgICAgKiBhbmQgY2FuIGJlIG92ZXJydWxlZCBwZXIgaW5zdGFuY2UuIHlvdSBjYW4gYWxzbyBhZGQgdGhlIG5hbWUgb2YgdGhlIGdlc3R1cmUsCiAgICAgKiBidXQgdGhpcyBpcyBhbHNvIGFkZGVkIGJ5IGRlZmF1bHQgKGFuZCBzZXQgdG8gdHJ1ZSkuCiAgICAgKgogICAgICogQHBhcmFtICAge0Z1bmN0aW9ufSAgaGFuZGxlcgogICAgICogdGhpcyBoYW5kbGVzIHRoZSBnZXN0dXJlIGRldGVjdGlvbiBvZiB5b3VyIGN1c3RvbSBnZXN0dXJlIGFuZCByZWNlaXZlcyB0aGUKICAgICAqIGZvbGxvd2luZyBhcmd1bWVudHM6CiAgICAgKgogICAgICogICAgICBAcGFyYW0gIHtPYmplY3R9ICAgIGV2ZW50RGF0YQogICAgICogICAgICBldmVudCBkYXRhIGNvbnRhaW5pbmcgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICogICAgICAgICAgdGltZVN0YW1wICAge051bWJlcn0gICAgICAgIHRpbWUgdGhlIGV2ZW50IG9jY3VycmVkCiAgICAgKiAgICAgICAgICB0YXJnZXQgICAgICB7SFRNTEVsZW1lbnR9ICAgdGFyZ2V0IGVsZW1lbnQKICAgICAqICAgICAgICAgIHRvdWNoZXMgICAgIHtBcnJheX0gICAgICAgICB0b3VjaGVzIChmaW5nZXJzLCBwb2ludGVycywgbW91c2UpIG9uIHRoZSBzY3JlZW4KICAgICAqICAgICAgICAgIHBvaW50ZXJUeXBlIHtTdHJpbmd9ICAgICAgICBraW5kIG9mIHBvaW50ZXIgdGhhdCB3YXMgdXNlZC4gbWF0Y2hlcyBIYW1tZXIuUE9JTlRFUl9NT1VTRXxUT1VDSAogICAgICogICAgICAgICAgY2VudGVyICAgICAge09iamVjdH0gICAgICAgIGNlbnRlciBwb3NpdGlvbiBvZiB0aGUgdG91Y2hlcy4gY29udGFpbnMgcGFnZVggYW5kIHBhZ2VZCiAgICAgKiAgICAgICAgICBkZWx0YVRpbWUgICB7TnVtYmVyfSAgICAgICAgdGhlIHRvdGFsIHRpbWUgb2YgdGhlIHRvdWNoZXMgaW4gdGhlIHNjcmVlbgogICAgICogICAgICAgICAgZGVsdGFYICAgICAge051bWJlcn0gICAgICAgIHRoZSBkZWx0YSBvbiB4IGF4aXMgd2UgaGF2ZWQgbW92ZWQKICAgICAqICAgICAgICAgIGRlbHRhWSAgICAgIHtOdW1iZXJ9ICAgICAgICB0aGUgZGVsdGEgb24geSBheGlzIHdlIGhhdmVkIG1vdmVkCiAgICAgKiAgICAgICAgICB2ZWxvY2l0eVggICB7TnVtYmVyfSAgICAgICAgdGhlIHZlbG9jaXR5IG9uIHRoZSB4CiAgICAgKiAgICAgICAgICB2ZWxvY2l0eVkgICB7TnVtYmVyfSAgICAgICAgdGhlIHZlbG9jaXR5IG9uIHkKICAgICAqICAgICAgICAgIGFuZ2xlICAgICAgIHtOdW1iZXJ9ICAgICAgICB0aGUgYW5nbGUgd2UgYXJlIG1vdmluZwogICAgICogICAgICAgICAgZGlyZWN0aW9uICAge1N0cmluZ30gICAgICAgIHRoZSBkaXJlY3Rpb24gd2UgYXJlIG1vdmluZy4gbWF0Y2hlcyBIYW1tZXIuRElSRUNUSU9OX1VQfERPV058TEVGVHxSSUdIVAogICAgICogICAgICAgICAgZGlzdGFuY2UgICAge051bWJlcn0gICAgICAgIHRoZSBkaXN0YW5jZSB3ZSBoYXZlZCBtb3ZlZAogICAgICogICAgICAgICAgc2NhbGUgICAgICAge051bWJlcn0gICAgICAgIHNjYWxpbmcgb2YgdGhlIHRvdWNoZXMsIG5lZWRzIDIgdG91Y2hlcwogICAgICogICAgICAgICAgcm90YXRpb24gICAge051bWJlcn0gICAgICAgIHJvdGF0aW9uIG9mIHRoZSB0b3VjaGVzLCBuZWVkcyAyIHRvdWNoZXMgKgogICAgICogICAgICAgICAgZXZlbnRUeXBlICAge1N0cmluZ30gICAgICAgIG1hdGNoZXMgSGFtbWVyLkVWRU5UX1NUQVJUfE1PVkV8RU5ECiAgICAgKiAgICAgICAgICBzcmNFdmVudCAgICB7T2JqZWN0fSAgICAgICAgdGhlIHNvdXJjZSBldmVudCwgbGlrZSBUb3VjaFN0YXJ0IG9yIE1vdXNlRG93biAqCiAgICAgKiAgICAgICAgICBzdGFydEV2ZW50ICB7T2JqZWN0fSAgICAgICAgY29udGFpbnMgdGhlIHNhbWUgcHJvcGVydGllcyBhcyBhYm92ZSwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXQgZnJvbSB0aGUgZmlyc3QgdG91Y2guIHRoaXMgaXMgdXNlZCB0byBjYWxjdWxhdGUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXN0YW5jZXMsIGRlbHRhVGltZSwgc2NhbGluZyBldGMKICAgICAqCiAgICAgKiAgICAgIEBwYXJhbSAge0hhbW1lci5JbnN0YW5jZX0gICAgaW5zdAogICAgICogICAgICB0aGUgaW5zdGFuY2Ugd2UgYXJlIGRvaW5nIHRoZSBkZXRlY3Rpb24gZm9yLiB5b3UgY2FuIGdldCB0aGUgb3B0aW9ucyBmcm9tCiAgICAgKiAgICAgIHRoZSBpbnN0Lm9wdGlvbnMgb2JqZWN0IGFuZCB0cmlnZ2VyIHRoZSBnZXN0dXJlIGV2ZW50IGJ5IGNhbGxpbmcgaW5zdC50cmlnZ2VyCiAgICAgKgogICAgICoKICAgICAqIEhhbmRsZSBnZXN0dXJlcwogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAqIGluc2lkZSB0aGUgaGFuZGxlciB5b3UgY2FuIGdldC9zZXQgSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50LiBUaGlzIGlzIHRoZSBjdXJyZW50CiAgICAgKiBkZXRlY3Rpb24gc2Vzc2lvbi4gSXQgaGFzIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllcwogICAgICogICAgICBAcGFyYW0gIHtTdHJpbmd9ICAgIG5hbWUKICAgICAqICAgICAgY29udGFpbnMgdGhlIG5hbWUgb2YgdGhlIGdlc3R1cmUgd2UgaGF2ZSBkZXRlY3RlZC4gaXQgaGFzIG5vdCBhIHJlYWwgZnVuY3Rpb24sCiAgICAgKiAgICAgIG9ubHkgdG8gY2hlY2sgaW4gb3RoZXIgZ2VzdHVyZXMgaWYgc29tZXRoaW5nIGlzIGRldGVjdGVkLgogICAgICogICAgICBsaWtlIGluIHRoZSBkcmFnIGdlc3R1cmUgd2Ugc2V0IGl0IHRvICdkcmFnJyBhbmQgaW4gdGhlIHN3aXBlIGdlc3R1cmUgd2UgY2FuCiAgICAgKiAgICAgIGNoZWNrIGlmIHRoZSBjdXJyZW50IGdlc3R1cmUgaXMgJ2RyYWcnIGJ5IGFjY2Vzc2luZyBIYW1tZXIuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZQogICAgICoKICAgICAqICAgICAgQHJlYWRvbmx5CiAgICAgKiAgICAgIEBwYXJhbSAge0hhbW1lci5JbnN0YW5jZX0gICAgaW5zdAogICAgICogICAgICB0aGUgaW5zdGFuY2Ugd2UgZG8gdGhlIGRldGVjdGlvbiBmb3IKICAgICAqCiAgICAgKiAgICAgIEByZWFkb25seQogICAgICogICAgICBAcGFyYW0gIHtPYmplY3R9ICAgIHN0YXJ0RXZlbnQKICAgICAqICAgICAgY29udGFpbnMgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGZpcnN0IGdlc3R1cmUgZGV0ZWN0aW9uIGluIHRoaXMgc2Vzc2lvbi4KICAgICAqICAgICAgVXNlZCBmb3IgY2FsY3VsYXRpb25zIGFib3V0IHRpbWluZywgZGlzdGFuY2UsIGV0Yy4KICAgICAqCiAgICAgKiAgICAgIEByZWFkb25seQogICAgICogICAgICBAcGFyYW0gIHtPYmplY3R9ICAgIGxhc3RFdmVudAogICAgICogICAgICBjb250YWlucyBhbGwgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGxhc3QgZ2VzdHVyZSBkZXRlY3QgaW4gdGhpcyBzZXNzaW9uLgogICAgICoKICAgICAqIGFmdGVyIHRoZSBnZXN0dXJlIGRldGVjdGlvbiBzZXNzaW9uIGhhcyBiZWVuIGNvbXBsZXRlZCAodXNlciBoYXMgcmVsZWFzZWQgdGhlIHNjcmVlbikKICAgICAqIHRoZSBIYW1tZXIuZGV0ZWN0aW9uLmN1cnJlbnQgb2JqZWN0IGlzIGNvcGllZCBpbnRvIEhhbW1lci5kZXRlY3Rpb24ucHJldmlvdXMsCiAgICAgKiB0aGlzIGlzIHVzZWZ1bGwgZm9yIGdlc3R1cmVzIGxpa2UgZG91YmxldGFwLCB3aGVyZSB5b3UgbmVlZCB0byBrbm93IGlmIHRoZQogICAgICogcHJldmlvdXMgZ2VzdHVyZSB3YXMgYSB0YXAKICAgICAqCiAgICAgKiBvcHRpb25zIHRoYXQgaGF2ZSBiZWVuIHNldCBieSB0aGUgaW5zdGFuY2UgY2FuIGJlIHJlY2VpdmVkIGJ5IGNhbGxpbmcgaW5zdC5vcHRpb25zCiAgICAgKgogICAgICogWW91IGNhbiB0cmlnZ2VyIGEgZ2VzdHVyZSBldmVudCBieSBjYWxsaW5nIGluc3QudHJpZ2dlcigibXlnZXN0dXJlIiwgZXZlbnQpLgogICAgICogVGhlIGZpcnN0IHBhcmFtIGlzIHRoZSBuYW1lIG9mIHlvdXIgZ2VzdHVyZSwgdGhlIHNlY29uZCB0aGUgZXZlbnQgYXJndW1lbnQKICAgICAqCiAgICAgKgogICAgICogUmVnaXN0ZXIgZ2VzdHVyZXMKICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiBXaGVuIGFuIGdlc3R1cmUgaXMgYWRkZWQgdG8gdGhlIEhhbW1lci5nZXN0dXJlcyBvYmplY3QsIGl0IGlzIGF1dG8gcmVnaXN0ZXJlZAogICAgICogYXQgdGhlIHNldHVwIG9mIHRoZSBmaXJzdCBIYW1tZXIgaW5zdGFuY2UuIFlvdSBjYW4gYWxzbyBjYWxsIEhhbW1lci5kZXRlY3Rpb24ucmVnaXN0ZXIKICAgICAqIG1hbnVhbGx5IGFuZCBwYXNzIHlvdXIgZ2VzdHVyZSBvYmplY3QgYXMgYSBwYXJhbQogICAgICoKICAgICAqLwoKICAgIC8qKgogICAgICogTG9uVGFwCiAgICAgKiBUb3VjaCBzdGF5cyBhdCB0aGUgc2FtZSBwbGFjZSBmb3IgeCB0aW1lCiAgICAgKiBAZXZlbnRzICBsb250YXAKICAgICAqLwogICAgSGFtbWVyLmdlc3R1cmVzLkxvblRhcCA9IHsKICAgICAgICBuYW1lOiAnbG9udGFwJywKICAgICAgICBpbmRleDogMTAsCiAgICAgICAgZGVmYXVsdHM6IHsKICAgICAgICAgICAgaG9sZF90aW1lb3V0CTogNTAwLAogICAgICAgICAgICBob2xkX3RocmVzaG9sZAk6IDEKICAgICAgICB9LAogICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIGhvbGRHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgICAgIHN3aXRjaChldi5ldmVudFR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgSGFtbWVyLkVWRU5UX1NUQVJUOgogICAgICAgICAgICAgICAgICAgIC8vIGNsZWFyIGFueSBydW5uaW5nIHRpbWVycwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gc2V0IHRoZSBnZXN0dXJlIHNvIHdlIGNhbiBjaGVjayBpbiB0aGUgdGltZW91dCBpZiBpdCBzdGlsbCBpcwogICAgICAgICAgICAgICAgICAgIEhhbW1lci5kZXRlY3Rpb24uY3VycmVudC5uYW1lID0gdGhpcy5uYW1lOwoKICAgICAgICAgICAgICAgICAgICAvLyBzZXQgdGltZXIgYW5kIGlmIGFmdGVyIHRoZSB0aW1lb3V0IGl0IHN0aWxsIGlzIGxvbnRhcCwKICAgICAgICAgICAgICAgICAgICAvLyB3ZSB0cmlnZ2VyIHRoZSBsb250YXAgZXZlbnQKICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPT0gJ2xvbnRhcCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3QudHJpZ2dlcignbG9udGFwJywgZXYpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgaW5zdC5vcHRpb25zLmhvbGRfdGltZW91dCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgLy8gd2hlbiB5b3UgbW92ZSBvciBlbmQgd2UgY2xlYXIgdGhlIHRpbWVyCiAgICAgICAgICAgICAgICBjYXNlIEhhbW1lci5FVkVOVF9NT1ZFOgogICAgICAgICAgICAgICAgICAgIGlmKGV2LmRpc3RhbmNlID4gaW5zdC5vcHRpb25zLmhvbGRfdGhyZXNob2xkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSBIYW1tZXIuRVZFTlRfRU5EOgogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogVGFwL0RvdWJsZVRhcAogICAgICogUXVpY2sgdG91Y2ggYXQgYSBwbGFjZSBvciBkb3VibGUgYXQgdGhlIHNhbWUgcGxhY2UKICAgICAqIEBldmVudHMgIHRhcCwgZG91YmxldGFwCiAgICAgKi8KICAgIEhhbW1lci5nZXN0dXJlcy5UYXAgPSB7CiAgICAgICAgbmFtZTogJ3RhcCcsCiAgICAgICAgaW5kZXg6IDEwMCwKICAgICAgICBkZWZhdWx0czogewogICAgICAgICAgICB0YXBfbWF4X3RvdWNodGltZQk6IDI1MCwKICAgICAgICAgICAgdGFwX21heF9kaXN0YW5jZQk6IDEwLAogICAgICAgICAgICB0YXBfYWx3YXlzCQkJOiB0cnVlLAogICAgICAgICAgICBkb3VibGV0YXBfZGlzdGFuY2UJOiAyMCwKICAgICAgICAgICAgZG91YmxldGFwX2ludGVydmFsCTogMzAwCiAgICAgICAgfSwKICAgICAgICBoYW5kbGVyOiBmdW5jdGlvbiB0YXBHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgICAgIGlmKGV2LmV2ZW50VHlwZSA9PSBIYW1tZXIuRVZFTlRfRU5EKSB7CiAgICAgICAgICAgICAgICAvLyBwcmV2aW91cyBnZXN0dXJlLCBmb3IgdGhlIGRvdWJsZSB0YXAgc2luY2UgdGhlc2UgYXJlIHR3byBkaWZmZXJlbnQgZ2VzdHVyZSBkZXRlY3Rpb25zCiAgICAgICAgICAgICAgICB2YXIgcHJldiA9IEhhbW1lci5kZXRlY3Rpb24ucHJldmlvdXMsCiAgICAgICAgICAgICAgICAgICAgZGlkX2RvdWJsZXRhcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgLy8gd2hlbiB0aGUgdG91Y2h0aW1lIGlzIGhpZ2hlciB0aGVuIHRoZSBtYXggdG91Y2ggdGltZQogICAgICAgICAgICAgICAgLy8gb3Igd2hlbiB0aGUgbW92aW5nIGRpc3RhbmNlIGlzIHRvbyBtdWNoCiAgICAgICAgICAgICAgICBpZihldi5kZWx0YVRpbWUgPiBpbnN0Lm9wdGlvbnMudGFwX21heF90b3VjaHRpbWUgfHwKICAgICAgICAgICAgICAgICAgICBldi5kaXN0YW5jZSA+IGluc3Qub3B0aW9ucy50YXBfbWF4X2Rpc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgZG91YmxlIHRhcAogICAgICAgICAgICAgICAgaWYocHJldiAmJiBwcmV2Lm5hbWUgPT0gJ3RhcCcgJiYKICAgICAgICAgICAgICAgICAgICAoZXYudGltZVN0YW1wIC0gcHJldi5sYXN0RXZlbnQudGltZVN0YW1wKSA8IGluc3Qub3B0aW9ucy5kb3VibGV0YXBfaW50ZXJ2YWwgJiYKICAgICAgICAgICAgICAgICAgICBldi5kaXN0YW5jZSA8IGluc3Qub3B0aW9ucy5kb3VibGV0YXBfZGlzdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ2RvdWJsZXRhcCcsIGV2KTsKICAgICAgICAgICAgICAgICAgICBkaWRfZG91YmxldGFwID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBkbyBhIHNpbmdsZSB0YXAKICAgICAgICAgICAgICAgIGlmKCFkaWRfZG91YmxldGFwIHx8IGluc3Qub3B0aW9ucy50YXBfYWx3YXlzKSB7CiAgICAgICAgICAgICAgICAgICAgSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPSAndGFwJzsKICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUsIGV2KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogU3dpcGUKICAgICAqIHRyaWdnZXJzIHN3aXBlIGV2ZW50cyB3aGVuIHRoZSBlbmQgdmVsb2NpdHkgaXMgYWJvdmUgdGhlIHRocmVzaG9sZAogICAgICogQGV2ZW50cyAgc3dpcGUsIHN3aXBlbGVmdCwgc3dpcGVyaWdodCwgc3dpcGV1cCwgc3dpcGVkb3duCiAgICAgKi8KICAgIEhhbW1lci5nZXN0dXJlcy5Td2lwZSA9IHsKICAgICAgICBuYW1lOiAnc3dpcGUnLAogICAgICAgIGluZGV4OiA0MCwKICAgICAgICBkZWZhdWx0czogewogICAgICAgICAgICAvLyBzZXQgMCBmb3IgdW5saW1pdGVkLCBidXQgdGhpcyBjYW4gY29uZmxpY3Qgd2l0aCB0cmFuc2Zvcm0KICAgICAgICAgICAgc3dpcGVfbWF4X3RvdWNoZXMgIDogMSwKICAgICAgICAgICAgc3dpcGVfdmVsb2NpdHkgICAgIDogMC43CiAgICAgICAgfSwKICAgICAgICBoYW5kbGVyOiBmdW5jdGlvbiBzd2lwZUdlc3R1cmUoZXYsIGluc3QpIHsKICAgICAgICAgICAgaWYoZXYuZXZlbnRUeXBlID09IEhhbW1lci5FVkVOVF9FTkQpIHsKICAgICAgICAgICAgICAgIC8vIG1heCB0b3VjaGVzCiAgICAgICAgICAgICAgICBpZihpbnN0Lm9wdGlvbnMuc3dpcGVfbWF4X3RvdWNoZXMgPiAwICYmCiAgICAgICAgICAgICAgICAgICAgZXYudG91Y2hlcy5sZW5ndGggPiBpbnN0Lm9wdGlvbnMuc3dpcGVfbWF4X3RvdWNoZXMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gd2hlbiB0aGUgZGlzdGFuY2Ugd2UgbW92ZWQgaXMgdG9vIHNtYWxsIHdlIHNraXAgdGhpcyBnZXN0dXJlCiAgICAgICAgICAgICAgICAvLyBvciB3ZSBjYW4gYmUgYWxyZWFkeSBpbiBkcmFnZ2luZwogICAgICAgICAgICAgICAgaWYoZXYudmVsb2NpdHlYID4gaW5zdC5vcHRpb25zLnN3aXBlX3ZlbG9jaXR5IHx8CiAgICAgICAgICAgICAgICAgICAgZXYudmVsb2NpdHlZID4gaW5zdC5vcHRpb25zLnN3aXBlX3ZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciBzd2lwZSBldmVudHMKICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lLCBldik7CiAgICAgICAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArIGV2LmRpcmVjdGlvbiwgZXYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCgogICAgLyoqCiAgICAgKiBEcmFnCiAgICAgKiBNb3ZlIHdpdGggeCBmaW5nZXJzIChkZWZhdWx0IDEpIGFyb3VuZCBvbiB0aGUgcGFnZS4gQmxvY2tpbmcgdGhlIHNjcm9sbGluZyB3aGVuCiAgICAgKiBtb3ZpbmcgbGVmdCBhbmQgcmlnaHQgaXMgYSBnb29kIHByYWN0aWNlLiBXaGVuIGFsbCB0aGUgZHJhZyBldmVudHMgYXJlIGJsb2NraW5nCiAgICAgKiB5b3UgZGlzYWJsZSBzY3JvbGxpbmcgb24gdGhhdCBhcmVhLgogICAgICogQGV2ZW50cyAgZHJhZywgZHJhcGxlZnQsIGRyYWdyaWdodCwgZHJhZ3VwLCBkcmFnZG93bgogICAgICovCiAgICBIYW1tZXIuZ2VzdHVyZXMuRHJhZyA9IHsKICAgICAgICBuYW1lOiAnZHJhZycsCiAgICAgICAgaW5kZXg6IDUwLAogICAgICAgIGRlZmF1bHRzOiB7CiAgICAgICAgICAgIGRyYWdfbWluX2Rpc3RhbmNlIDogMTAsCiAgICAgICAgICAgIC8vIHNldCAwIGZvciB1bmxpbWl0ZWQsIGJ1dCB0aGlzIGNhbiBjb25mbGljdCB3aXRoIHRyYW5zZm9ybQogICAgICAgICAgICBkcmFnX21heF90b3VjaGVzICA6IDEsCiAgICAgICAgICAgIC8vIHByZXZlbnQgZGVmYXVsdCBicm93c2VyIGJlaGF2aW9yIHdoZW4gZHJhZ2dpbmcgb2NjdXJzCiAgICAgICAgICAgIC8vIGJlIGNhcmVmdWwgd2l0aCBpdCwgaXQgbWFrZXMgdGhlIGVsZW1lbnQgYSBibG9ja2luZyBlbGVtZW50CiAgICAgICAgICAgIC8vIHdoZW4geW91IGFyZSB1c2luZyB0aGUgZHJhZyBnZXN0dXJlLCBpdCBpcyBhIGdvb2QgcHJhY3RpY2UgdG8gc2V0IHRoaXMgdHJ1ZQogICAgICAgICAgICBkcmFnX2Jsb2NrX2hvcml6b250YWwgICA6IGZhbHNlLAogICAgICAgICAgICBkcmFnX2Jsb2NrX3ZlcnRpY2FsICAgICA6IGZhbHNlLAogICAgICAgICAgICAvLyBkcmFnX2xvY2tfdG9fYXhpcyBrZWVwcyB0aGUgZHJhZyBnZXN0dXJlIG9uIHRoZSBheGlzIHRoYXQgaXQgc3RhcnRlZCBvbiwKICAgICAgICAgICAgLy8gSXQgZGlzYWxsb3dzIHZlcnRpY2FsIGRpcmVjdGlvbnMgaWYgdGhlIGluaXRpYWwgZGlyZWN0aW9uIHdhcyBob3Jpem9udGFsLCBhbmQgdmljZSB2ZXJzYS4KICAgICAgICAgICAgZHJhZ19sb2NrX3RvX2F4aXMgICAgICAgOiBmYWxzZSwKICAgICAgICAgICAgLy8gZHJhZyBsb2NrIG9ubHkga2lja3MgaW4gd2hlbiBkaXN0YW5jZSA+IGRyYWdfbG9ja19taW5fZGlzdGFuY2UKICAgICAgICAgICAgLy8gVGhpcyB3YXksIGxvY2tpbmcgb2NjdXJzIG9ubHkgd2hlbiB0aGUgZGlzdGFuY2UgaGFzIGJlY29tZSBsYXJnZSBlbm91Z2ggdG8gcmVsaWFibHkgZGV0ZXJtaW5lIHRoZSBkaXJlY3Rpb24KICAgICAgICAgICAgZHJhZ19sb2NrX21pbl9kaXN0YW5jZSA6IDI1CiAgICAgICAgfSwKICAgICAgICB0cmlnZ2VyZWQ6IGZhbHNlLAogICAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIGRyYWdHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgICAgIC8vIGN1cnJlbnQgZ2VzdHVyZSBpc250IGRyYWcsIGJ1dCBkcmFnZ2VkIGlzIHRydWUKICAgICAgICAgICAgLy8gdGhpcyBtZWFucyBhbiBvdGhlciBnZXN0dXJlIGlzIGJ1c3kuIG5vdyBjYWxsIGRyYWdlbmQKICAgICAgICAgICAgaWYoSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgIT0gdGhpcy5uYW1lICYmIHRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnZW5kJywgZXYpOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gbWF4IHRvdWNoZXMKICAgICAgICAgICAgaWYoaW5zdC5vcHRpb25zLmRyYWdfbWF4X3RvdWNoZXMgPiAwICYmCiAgICAgICAgICAgICAgICBldi50b3VjaGVzLmxlbmd0aCA+IGluc3Qub3B0aW9ucy5kcmFnX21heF90b3VjaGVzKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3aXRjaChldi5ldmVudFR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgSGFtbWVyLkVWRU5UX1NUQVJUOgogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSBIYW1tZXIuRVZFTlRfTU9WRToKICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSBkaXN0YW5jZSB3ZSBtb3ZlZCBpcyB0b28gc21hbGwgd2Ugc2tpcCB0aGlzIGdlc3R1cmUKICAgICAgICAgICAgICAgICAgICAvLyBvciB3ZSBjYW4gYmUgYWxyZWFkeSBpbiBkcmFnZ2luZwogICAgICAgICAgICAgICAgICAgIGlmKGV2LmRpc3RhbmNlIDwgaW5zdC5vcHRpb25zLmRyYWdfbWluX2Rpc3RhbmNlICYmCiAgICAgICAgICAgICAgICAgICAgICAgIEhhbW1lci5kZXRlY3Rpb24uY3VycmVudC5uYW1lICE9IHRoaXMubmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgZHJhZ2dpbmchCiAgICAgICAgICAgICAgICAgICAgSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPSB0aGlzLm5hbWU7CgogICAgICAgICAgICAgICAgICAgIC8vIGxvY2sgZHJhZyB0byBheGlzPwogICAgICAgICAgICAgICAgICAgIGlmKEhhbW1lci5kZXRlY3Rpb24uY3VycmVudC5sYXN0RXZlbnQuZHJhZ19sb2NrZWRfdG9fYXhpcyB8fCAoaW5zdC5vcHRpb25zLmRyYWdfbG9ja190b19heGlzICYmIGluc3Qub3B0aW9ucy5kcmFnX2xvY2tfbWluX2Rpc3RhbmNlPD1ldi5kaXN0YW5jZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXYuZHJhZ19sb2NrZWRfdG9fYXhpcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBsYXN0X2RpcmVjdGlvbiA9IEhhbW1lci5kZXRlY3Rpb24uY3VycmVudC5sYXN0RXZlbnQuZGlyZWN0aW9uOwogICAgICAgICAgICAgICAgICAgIGlmKGV2LmRyYWdfbG9ja2VkX3RvX2F4aXMgJiYgbGFzdF9kaXJlY3Rpb24gIT09IGV2LmRpcmVjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBrZWVwIGRpcmVjdGlvbiBvbiB0aGUgYXhpcyB0aGF0IHRoZSBkcmFnIGdlc3R1cmUgc3RhcnRlZCBvbgogICAgICAgICAgICAgICAgICAgICAgICBpZihIYW1tZXIudXRpbHMuaXNWZXJ0aWNhbChsYXN0X2RpcmVjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2LmRpcmVjdGlvbiA9IChldi5kZWx0YVkgPCAwKSA/IEhhbW1lci5ESVJFQ1RJT05fVVAgOiBIYW1tZXIuRElSRUNUSU9OX0RPV047CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldi5kaXJlY3Rpb24gPSAoZXYuZGVsdGFYIDwgMCkgPyBIYW1tZXIuRElSRUNUSU9OX0xFRlQgOiBIYW1tZXIuRElSRUNUSU9OX1JJR0hUOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBmaXJzdCB0aW1lLCB0cmlnZ2VyIGRyYWdzdGFydCBldmVudAogICAgICAgICAgICAgICAgICAgIGlmKCF0aGlzLnRyaWdnZXJlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnc3RhcnQnLCBldik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHRyaWdnZXIgbm9ybWFsIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOwoKICAgICAgICAgICAgICAgICAgICAvLyBkaXJlY3Rpb24gZXZlbnQsIGxpa2UgZHJhZ2Rvd24KICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsgZXYuZGlyZWN0aW9uLCBldik7CgogICAgICAgICAgICAgICAgICAgIC8vIGJsb2NrIHRoZSBicm93c2VyIGV2ZW50cwogICAgICAgICAgICAgICAgICAgIGlmKCAoaW5zdC5vcHRpb25zLmRyYWdfYmxvY2tfdmVydGljYWwgJiYgSGFtbWVyLnV0aWxzLmlzVmVydGljYWwoZXYuZGlyZWN0aW9uKSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKGluc3Qub3B0aW9ucy5kcmFnX2Jsb2NrX2hvcml6b250YWwgJiYgIUhhbW1lci51dGlscy5pc1ZlcnRpY2FsKGV2LmRpcmVjdGlvbikpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgSGFtbWVyLkVWRU5UX0VORDoKICAgICAgICAgICAgICAgICAgICAvLyB0cmlnZ2VyIGRyYWdlbmQKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnRyaWdnZXJlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnZW5kJywgZXYpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogVHJhbnNmb3JtCiAgICAgKiBVc2VyIHdhbnQgdG8gc2NhbGUgb3Igcm90YXRlIHdpdGggMiBmaW5nZXJzCiAgICAgKiBAZXZlbnRzICB0cmFuc2Zvcm0sIHBpbmNoLCBwaW5jaGluLCBwaW5jaG91dCwgcm90YXRlCiAgICAgKi8KICAgIEhhbW1lci5nZXN0dXJlcy5UcmFuc2Zvcm0gPSB7CiAgICAgICAgbmFtZTogJ3RyYW5zZm9ybScsCiAgICAgICAgaW5kZXg6IDQ1LAogICAgICAgIGRlZmF1bHRzOiB7CiAgICAgICAgICAgIC8vIGZhY3Rvciwgbm8gc2NhbGUgaXMgMSwgem9vbWluIGlzIHRvIDAgYW5kIHpvb21vdXQgdW50aWwgaGlnaGVyIHRoZW4gMQogICAgICAgICAgICB0cmFuc2Zvcm1fbWluX3NjYWxlICAgICA6IDAuMDEsCiAgICAgICAgICAgIC8vIHJvdGF0aW9uIGluIGRlZ3JlZXMKICAgICAgICAgICAgdHJhbnNmb3JtX21pbl9yb3RhdGlvbiAgOiAxLAogICAgICAgICAgICAvLyBwcmV2ZW50IGRlZmF1bHQgYnJvd3NlciBiZWhhdmlvciB3aGVuIHR3byB0b3VjaGVzIGFyZSBvbiB0aGUgc2NyZWVuCiAgICAgICAgICAgIC8vIGJ1dCBpdCBtYWtlcyB0aGUgZWxlbWVudCBhIGJsb2NraW5nIGVsZW1lbnQKICAgICAgICAgICAgLy8gd2hlbiB5b3UgYXJlIHVzaW5nIHRoZSB0cmFuc2Zvcm0gZ2VzdHVyZSwgaXQgaXMgYSBnb29kIHByYWN0aWNlIHRvIHNldCB0aGlzIHRydWUKICAgICAgICAgICAgdHJhbnNmb3JtX2Fsd2F5c19ibG9jayAgOiBmYWxzZQogICAgICAgIH0sCiAgICAgICAgdHJpZ2dlcmVkOiBmYWxzZSwKICAgICAgICBoYW5kbGVyOiBmdW5jdGlvbiB0cmFuc2Zvcm1HZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgICAgIC8vIGN1cnJlbnQgZ2VzdHVyZSBpc250IGRyYWcsIGJ1dCBkcmFnZ2VkIGlzIHRydWUKICAgICAgICAgICAgLy8gdGhpcyBtZWFucyBhbiBvdGhlciBnZXN0dXJlIGlzIGJ1c3kuIG5vdyBjYWxsIGRyYWdlbmQKICAgICAgICAgICAgaWYoSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgIT0gdGhpcy5uYW1lICYmIHRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnZW5kJywgZXYpOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gYXRsZWFzdCBtdWx0aXRvdWNoCiAgICAgICAgICAgIGlmKGV2LnRvdWNoZXMubGVuZ3RoIDwgMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBwcmV2ZW50IGRlZmF1bHQgd2hlbiB0d28gZmluZ2VycyBhcmUgb24gdGhlIHNjcmVlbgogICAgICAgICAgICBpZihpbnN0Lm9wdGlvbnMudHJhbnNmb3JtX2Fsd2F5c19ibG9jaykgewogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dpdGNoKGV2LmV2ZW50VHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSBIYW1tZXIuRVZFTlRfU1RBUlQ6CiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlIEhhbW1lci5FVkVOVF9NT1ZFOgogICAgICAgICAgICAgICAgICAgIHZhciBzY2FsZV90aHJlc2hvbGQgPSBNYXRoLmFicygxLWV2LnNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcm90YXRpb25fdGhyZXNob2xkID0gTWF0aC5hYnMoZXYucm90YXRpb24pOwoKICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSBkaXN0YW5jZSB3ZSBtb3ZlZCBpcyB0b28gc21hbGwgd2Ugc2tpcCB0aGlzIGdlc3R1cmUKICAgICAgICAgICAgICAgICAgICAvLyBvciB3ZSBjYW4gYmUgYWxyZWFkeSBpbiBkcmFnZ2luZwogICAgICAgICAgICAgICAgICAgIGlmKHNjYWxlX3RocmVzaG9sZCA8IGluc3Qub3B0aW9ucy50cmFuc2Zvcm1fbWluX3NjYWxlICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uX3RocmVzaG9sZCA8IGluc3Qub3B0aW9ucy50cmFuc2Zvcm1fbWluX3JvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSB0cmFuc2Zvcm1pbmchCiAgICAgICAgICAgICAgICAgICAgSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPSB0aGlzLm5hbWU7CgogICAgICAgICAgICAgICAgICAgIC8vIGZpcnN0IHRpbWUsIHRyaWdnZXIgZHJhZ3N0YXJ0IGV2ZW50CiAgICAgICAgICAgICAgICAgICAgaWYoIXRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKydzdGFydCcsIGV2KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOyAvLyBiYXNpYyB0cmFuc2Zvcm0gZXZlbnQKCiAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciByb3RhdGUgZXZlbnQKICAgICAgICAgICAgICAgICAgICBpZihyb3RhdGlvbl90aHJlc2hvbGQgPiBpbnN0Lm9wdGlvbnMudHJhbnNmb3JtX21pbl9yb3RhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ3JvdGF0ZScsIGV2KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHRyaWdnZXIgcGluY2ggZXZlbnQKICAgICAgICAgICAgICAgICAgICBpZihzY2FsZV90aHJlc2hvbGQgPiBpbnN0Lm9wdGlvbnMudHJhbnNmb3JtX21pbl9zY2FsZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ3BpbmNoJywgZXYpOwogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ3BpbmNoJysgKChldi5zY2FsZSA8IDEpID8gJ2luJyA6ICdvdXQnKSwgZXYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlIEhhbW1lci5FVkVOVF9FTkQ6CiAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciBkcmFnZW5kCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy50cmlnZ2VyZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArJ2VuZCcsIGV2KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKCiAgICAvKioKICAgICAqIFRvdWNoCiAgICAgKiBDYWxsZWQgYXMgZmlyc3QsIHRlbGxzIHRoZSB1c2VyIGhhcyB0b3VjaGVkIHRoZSBzY3JlZW4KICAgICAqIEBldmVudHMgIHRvdWNoCiAgICAgKi8KICAgIEhhbW1lci5nZXN0dXJlcy5Ub3VjaCA9IHsKICAgICAgICBuYW1lOiAndG91Y2gnLAogICAgICAgIGluZGV4OiAtSW5maW5pdHksCiAgICAgICAgZGVmYXVsdHM6IHsKICAgICAgICAgICAgLy8gY2FsbCBwcmV2ZW50RGVmYXVsdCBhdCB0b3VjaHN0YXJ0LCBhbmQgbWFrZXMgdGhlIGVsZW1lbnQgYmxvY2tpbmcgYnkKICAgICAgICAgICAgLy8gZGlzYWJsaW5nIHRoZSBzY3JvbGxpbmcgb2YgdGhlIHBhZ2UsIGJ1dCBpdCBpbXByb3ZlcyBnZXN0dXJlcyBsaWtlCiAgICAgICAgICAgIC8vIHRyYW5zZm9ybWluZyBhbmQgZHJhZ2dpbmcuCiAgICAgICAgICAgIC8vIGJlIGNhcmVmdWwgd2l0aCB1c2luZyB0aGlzLCBpdCBjYW4gYmUgdmVyeSBhbm5veWluZyBmb3IgdXNlcnMgdG8gYmUgc3R1Y2sKICAgICAgICAgICAgLy8gb24gdGhlIHBhZ2UKICAgICAgICAgICAgcHJldmVudF9kZWZhdWx0OiBmYWxzZSwKCiAgICAgICAgICAgIC8vIGRpc2FibGUgbW91c2UgZXZlbnRzLCBzbyBvbmx5IHRvdWNoIChvciBwZW4hKSBpbnB1dCB0cmlnZ2VycyBldmVudHMKICAgICAgICAgICAgcHJldmVudF9tb3VzZWV2ZW50czogZmFsc2UKICAgICAgICB9LAogICAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIHRvdWNoR2VzdHVyZShldiwgaW5zdCkgewogICAgICAgICAgICBpZihpbnN0Lm9wdGlvbnMucHJldmVudF9tb3VzZWV2ZW50cyAmJiBldi5wb2ludGVyVHlwZSA9PSBIYW1tZXIuUE9JTlRFUl9NT1VTRSkgewogICAgICAgICAgICAgICAgZXYuc3RvcERldGVjdCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihpbnN0Lm9wdGlvbnMucHJldmVudF9kZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihldi5ldmVudFR5cGUgPT0gIEhhbW1lci5QT0lOVEVSX01PVVNFKSB7CiAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lLCBldik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKCiAgICAvKioKICAgICAqIFJlbGVhc2UKICAgICAqIENhbGxlZCBhcyBsYXN0LCB0ZWxscyB0aGUgdXNlciBoYXMgcmVsZWFzZWQgdGhlIHNjcmVlbgogICAgICogQGV2ZW50cyAgcmVsZWFzZQogICAgICovCiAgICBIYW1tZXIuZ2VzdHVyZXMuUmVsZWFzZSA9IHsKICAgICAgICBuYW1lOiAncmVsZWFzZScsCiAgICAgICAgaW5kZXg6IEluZmluaXR5LAogICAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIHJlbGVhc2VHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgICAgIGlmKGV2LmV2ZW50VHlwZSA9PSAgSGFtbWVyLkVWRU5UX0VORCkgewogICAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICBvLmdlc3R1cmUgPSBIYW1tZXI7Cgp9KShvY3RvcHVzKTsvKioKICogQGZpbGUKICogd2ViYXBw6YCa55So57uE5Lu254i257G7CiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQHJlcXVpcmUgbGliL2RvbS5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICogQGNsYXNzIG9jdG9wdXMuV2lkZ2V0CiAgICAgKiBAZGVzYyBvY3RvcHVzLXVp55qE54i257G7CiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICAgICogQHBhcmFtIG9wdGlvbnMuZWwge0RPTUVsZW1lbnR9IOagueiKgueCuSDlpoLmnpzmsqHmnInliJnliJvlu7rkuIDkuKpkaXYKICAgICAqIEBwYXJhbSBvcHRpb25zLmlkIHtTdHJpbmd9IHdpZGdldOeahGlkIOS5n+S8muaIkOS4uuagueiKgueCueeahGlkCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5ldmVudExpc3RlbmVycyB7T2JqZWN0fSDnlKjku6Xmibnph4/mt7vliqDkuovku7YKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgd2lkZ2V0ID0gbmV3IFdpZGdldCh7CiAgICAgKiAgICAgaWQ6ICJ3aWRnZXQiLAogICAgICogICAgIGV2ZW50TGlzdGVuZXJzOiB7CiAgICAgKiAgICAgICAgICJvblRvdWNoIjogZnVuY3Rpb24gb25Ub3VjaCgpIHt9LAogICAgICogICAgICAgICAib25Nb3ZlIjogZnVuY3Rpb24gb25Nb3ZlKCkge30sCiAgICAgKiAgICAgICAgICJzY29wZSI6IHRoaXMKICAgICAqICAgICB9CiAgICAgKiB9KTsKICAgICAqIEByZXR1cm4gbmV3IFdpZGdldAogICAgICovCiAgICBvLldpZGdldCA9IG8uZGVmaW5lKHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaWQKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGlkOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBvcHRpb25zCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBvcHRpb25zOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIEBkZXNjIHdpZGdldOeahOagueiKgueCuQogICAgICAgICAqIEB0eXBlIHtET01FTGVtZW50fQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjb250YWluZXIKICAgICAgICAgKiBAZGVzYyB3aWRnZXTnmoTlrrnlmagKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBjb250YWluZXI6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGF1dG9BY3RpdmF0ZQogICAgICAgICAqIEBkZXNjIOaYr+WQpuWvueWDj+eUn+aIkOWujOWwseebtOaOpea4suafk++8jOagh+W/l+S9jQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGF1dG9BY3RpdmF0ZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFjdGl2ZQogICAgICAgICAqIEBkZXNjIOaYr+WQpuWkhOS6jua/gOa0u+eKtuaAgQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGFjdGl2ZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50cwogICAgICAgICAqIEB0eXBlIHtvY3RvcHVzLkV2ZW50c30KICAgICAgICAgKi8KICAgICAgICBldmVudHM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzU2hvdwogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzU2hvdzogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGdlc3R1cmUKICAgICAgICAgKiBAdHlwZSB7b2N0b3B1cy5nZXN0dXJlfQogICAgICAgICAqLwogICAgICAgIGdlc3R1cmU6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50TGlzdGVuZXJzCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKiBAZGVzYyDkuovku7bnm5HlkKzlm57osIPliJfooagKICAgICAgICAgKi8KICAgICAgICBldmVudExpc3RlbmVyczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgd2lkZ2V0TWFuYWdlcgogICAgICAgICAqIEB0eXBlIHtvY3RvcHVzLldpZGdldE1hbmFnZXJ9CiAgICAgICAgICogQGRlc2Mgd2lkZ2V0566h55CG5ZmoCiAgICAgICAgICovCiAgICAgICAgd2lkZ2V0TWFuYWdlcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3Igb2N0b3B1cy5XaWRnZXQuaW5pdGlhbGl6ZQogICAgICAgICAqIEBkZXNjIOaehOmAoOWHveaVsAogICAgICAgICAqIEBwYXJhbSBvcHRpb25zICAtICAge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgICB0aGlzLmFkZE9wdGlvbnMob3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gbmV3IG8uRXZlbnRzKHRoaXMpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmUgPSBvLmdlc3R1cmU7CiAgICAgICAgICAgIHRoaXMuaWQgPSB0aGlzLmlkIHx8IG8udXRpbC5jcmVhdGVVbmlxdWVJRCh0aGlzLkNMQVNTX05BTUUgKyAiXyIpOwogICAgICAgICAgICBpZih0aGlzLmV2ZW50TGlzdGVuZXJzIGluc3RhbmNlb2YgT2JqZWN0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50cy5yZWdpc3Rlcih0aGlzLmV2ZW50TGlzdGVuZXJzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVsID0gdGhpcy5lbCB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgISF0aGlzLmVsLmlkID8gdGhpcy5pZCA9IHRoaXMuZWwuaWQgOiB0aGlzLmVsLmlkID0gdGhpcy5pZDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5yZW5kZXIKICAgICAgICAgKiBAZGVzYyDmuLLmn5MKICAgICAgICAgKiBAcGFyYW0gY29udGFpbmVyIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oY29udGFpbmVyKSB7CiAgICAgICAgICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICAgICAgICBpZihsZW4gPT0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSB0aGlzLmNvbnRhaW5lciB8fCBkb2N1bWVudC5ib2R5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBvLmcoYXJndW1lbnRzWzBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIklsbGVnYWwgRG9tISIpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZighIWFyZ3VtZW50c1sxXSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjbG9uZW5vZGUgPSBvLmRvbS5jbG9uZU5vZGUodGhpcy5jb250YWluZXIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQodGhpcy5lbCwgY2xvbmVub2RlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChjbG9uZW5vZGUsIHRoaXMuY29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGNsb25lbm9kZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZCh0aGlzLmVsLCB0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXRoaXMuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2YXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXRoaXMuaXNTaG93KSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5hcHBlbmRDaGlsZAogICAgICAgICAqLwogICAgICAgIGFwcGVuZENoaWxkOiBmdW5jdGlvbihkb20sIGNvbnRhaW5lcikgewogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZG9tKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5hY3RpdmF0ZQogICAgICAgICAqIEBkZXNjIOa/gOa0u+aOp+S7tgogICAgICAgICAqLwogICAgICAgIGFjdGl2YXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModGhpcy5lbCwgImFjdGl2YXRlIik7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5kZWFjdGl2YXRlCiAgICAgICAgICogQGRlc2Mg5oyC6LW35o6n5Lu2CiAgICAgICAgICovCiAgICAgICAgZGVhY3RpdmF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmFjdGl2ZSkgICAgcmV0dXJuOwogICAgICAgICAgICBvLmRvbS5yZW1vdmVDbGFzcyh0aGlzLmVsLCAiYWN0aXZhdGUiKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5kZXN0cm95CiAgICAgICAgICogQGRlc2Mg5pGn5q+BCiAgICAgICAgICovCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDaGlsZCh0aGlzLmVsKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVsID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5vbgogICAgICAgICAqIEBkZXNjIOebkeWQrOiHquWumuS5ieS6i+S7tiDlpoLmnpzkuLrmiYvlir/kuovku7Yg5YiZ55uR5ZCs55qE5piv5qC56IqC54K56Kem5Y+R55qECiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259CiAgICAgICAgICogQHBhcmFtIG9wdiB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIG9uOiBmdW5jdGlvbih0eXBlLCBmdW5jLCBvcHYpIHsKICAgICAgICAgICAgdmFyIEdFU1RVUkVTID0gby5XaWRnZXQuR0VTVFVSRVM7CiAgICAgICAgICAgIGlmKEdFU1RVUkVTLmluZGV4T2YodHlwZSkgIT0gLTEpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZSh0aGlzLmVsLCBvcHYpLm9uKHR5cGUsIGZ1bmMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXZlbnRzLm9uKHR5cGUsIGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LnVuCiAgICAgICAgICogQGRlc2Mg5Y676Zmk55uR5ZCsIOS4jm9u55u45a+5CiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgdW46IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMudW4odHlwZSwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQubm90aWZ5CiAgICAgICAgICogQGRlc2Mg6Kem5Y+R5p+Q6Ieq5a6a5LmJ5LqL5Lu2CiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZXZ0IHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgbm90aWZ5OiBmdW5jdGlvbih0eXBlLCBldnQpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMudHJpZ2dlckV2ZW50KHR5cGUsIGV2dCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGFkZE9wdGlvbnMKICAgICAgICAgKiBAZGVzYyDmt7Hluqbnu5HlrpoKICAgICAgICAgKiBAcGFyYW0gbmV3T3B0aW9ucyAgLSAgIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgYWRkT3B0aW9uczogZnVuY3Rpb24obmV3T3B0aW9ucykgewogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucyA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMub3B0aW9ucywgbmV3T3B0aW9ucyk7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG5ld09wdGlvbnMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LnNob3cKICAgICAgICAgKiBAZGVzYyDmmL7npLp3aWRnZXQKICAgICAgICAgKi8KICAgICAgICBzaG93OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy5pc1Nob3cpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5pc1Nob3cgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LmhpZGRlbgogICAgICAgICAqIEBkZXNjIOmakOiXj3dpZGdldAogICAgICAgICAqLwogICAgICAgIGhpZGRlbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmlzU2hvdykgICAgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzU2hvdyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQudG9nZ2xlVmlzaWJsZQogICAgICAgICAqIEBkZXNjIOWIh+aNouaYvuekuueKtuaAgQogICAgICAgICAqLwogICAgICAgIHRvZ2dsZVZpc2libGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmlzU2hvdykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRkZW4oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuY2xvbmUKICAgICAgICAgKiBAcmV0dXJucyB7Kn0KICAgICAgICAgKi8KICAgICAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBldmFsKCJuZXcgIiArIHRoaXMuQ0xBU1NfTkFNRSArICIoby51dGlsLmNsb25lKHRoaXMub3B0aW9ucykpIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuZ2V0RWwKICAgICAgICAgKiBAZGVzYyDmi793aWRnZXTnmoTmoLnoioLngrkKICAgICAgICAgKi8KICAgICAgICBnZXRFbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LmdldEhlaWdodAogICAgICAgICAqIEBkZXNjIOaLv+WIsHdpZGdldOeahOmrmOW6pgogICAgICAgICAqLwogICAgICAgIGdldEhlaWdodDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBvLmRvbS5nZXRIZWlnaHQodGhpcy5lbCkgfHwgby5kb20uZ2V0U3R5bGUodGhpcy5lbCwgImhlaWdodCIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LmdldFdpZHRoCiAgICAgICAgICogQGRlc2Mg5ou/5Yiwd2lkZ2V055qE5a695bqmCiAgICAgICAgICovCiAgICAgICAgZ2V0V2lkdGg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gby5kb20uZ2V0V2lkdGgodGhpcy5lbCkgfHwgby5kb20uZ2V0U3R5bGUodGhpcy5lbCwgIndpZHRoIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuc2V0TWFuYWdlcgogICAgICAgICAqIEBkZXNjIHdpZGdldOiiq+azqOWGjOi/m3dpZGdldE1hbmFnZXIKICAgICAgICAgKiBAcGFyYW0gbQogICAgICAgICAqLwogICAgICAgIHNldE1hbmFnZXI6IGZ1bmN0aW9uKG0pIHsKICAgICAgICAgICAgdGhpcy53aWRnZXRNYW5hZ2VyID0gbTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5zZXRaSW5kZXgKICAgICAgICAgKiBAZGVzYyDorr7nva7mjqfku7bnmoR6aW5kZXjlgLwKICAgICAgICAgKiBAcGFyYW0geiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHNldFpJbmRleDogZnVuY3Rpb24oeikgewogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLnpJbmRleCA9IHo7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0IgogICAgfSk7CgogICAgby5XaWRnZXQuR0VTVFVSRVMgPSBbInRhcCIsICJsb250YXAiLCAiZG91YmxldGFwIiwgInN3aXBlIiwgInN3aXBlbGVmdCIsCiAgICAgICAgInN3aXBlcmlnaHQiLCAic3dpcGV1cCIsICJzd2lwZWRvd24iLCAiZHJhZyIsICJkcmFwbGVmdCIsICJkcmFncmlnaHQiLAogICAgICAgICJkcmFndXAiLCAiZHJhZ2Rvd24iLCAidG91Y2giLCAicmVsZWFzZSJdOwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLndpZGdldE1hbmFnZXIKICAgICAqIEBkZXNjIOi/lOWbnuS4gOS4qndpZGdldOeahOeuoeeQhuWZqAogICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICogQHBhcmFtIG9wdHMge09iamVjdH0KICAgICAqIEByZXR1cm5zIHtvLldpZGdldE1hbmFnZXJ9CiAgICAgKi8KICAgIG8ud2lkZ2V0TWFuYWdlciA9IGZ1bmN0aW9uKGVsLCBvcHRzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBvLldpZGdldE1hbmFnZXIoZWwsIG9wdHMpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLldpZGdldE1hbmFnZXIKICAgICAqIEBkZXNjIHdpZGdldOeuoeeQhuWZqAogICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fSDnrqHnkIblmajopobnm5bnmoToioLngrkg5b+F6aG75pyJ55qE5Y+C5pWwCiAgICAgKiBAcGFyYW0gb3B0cyB7T2JqZWN0fSDpop3lpJblj4LmlbAg6Z2e5b+F6ZyACiAgICAgKiBAcGFyYW0gb3B0cy5jbGFzc0ZpbHRlciB7U3RyaW5nfSDnrKblkIjmnaHku7bnmoToioLngrnlv4XpnIDljIXmi6zov5nkuKpjbGFzcyDpu5jorqTkuLoib2N0b3B1c3VpLWNvbnRhaW5lciIKICAgICAqIEBwYXJhbSBvcHRzLnN1cHBvcnRUeXBlIHtBcnJheX0g5b2T5YmN6L+Z5Liq566h55CG5Zmo5pSv5oyB55qE5o6n5Lu257G75Z6LIOm7mOiupOS4uiBzbGlkZXIgcmVmcmVzaCBtZW51IG1hc2sgYmFjazJ0b3AKICAgICAqLwogICAgby5XaWRnZXRNYW5hZ2VyID0gby5kZWZpbmUoewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqIEBkZXNjIOeuoeeQhuWZqOimhueblueahOiKgueCueWuueWZqAogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbHMKICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICogQGRlc2Mg56ym5ZCI5p2h5Lu255qE6IqC54K56ZuG5ZCICiAgICAgICAgICovCiAgICAgICAgZWxzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBvcHRzCiAgICAgICAgICogQGRlc2Mg5Y+C5pWw6aG5CiAgICAgICAgICovCiAgICAgICAgb3B0czogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY2xhc3NGaWx0ZXIKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOespuWQiOadoeS7tuiKgueCueeahGNsYXNzCiAgICAgICAgICovCiAgICAgICAgY2xhc3NGaWx0ZXI6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHdpZGdldHMKICAgICAgICAgKiBAZGVzYyDnrqHnkIblmajph4zlt7Lmi7/liLDnmoTmjqfku7YKICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICovCiAgICAgICAgd2lkZ2V0czogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc3VwcG9ydFR5cGUKICAgICAgICAgKiBAZGVzYyDmlK/mjIHnmoTmjqfku7bnsbvlnovpm4blkIgKICAgICAgICAgKi8KICAgICAgICBzdXBwb3J0VHlwZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnQKICAgICAgICAgKi8KICAgICAgICBldmVudDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKiBAcGFyYW0gZWwge1N0cmluZyB8IERPTUVsZW1lbnR9IOino+aekOeahOWuueWZqAogICAgICAgICAqIEBwYXJhbSBvcHRzIHtPYmplY3R9IOS8oOWFpeeahOWPguaVsAogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGVsLCBvcHRzKSB7CiAgICAgICAgICAgIHRoaXMub3B0cyA9IG8uZXh0ZW5kKHt9LCBvcHRzIHx8IHt9KTsKICAgICAgICAgICAgdGhpcy5lbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIGlmKCFvLnV0aWwuaXNOb2RlKHRoaXMuZWwpKSAgdGhyb3cgbmV3IEVycm9yKCJyZXF1aXJlIGEgbm9kZSB0byBpbml0aWFsaXplISIpOwogICAgICAgICAgICB0aGlzLmVscyA9IFtdOwogICAgICAgICAgICB0aGlzLmV2ZW50ID0gbmV3IG8uRXZlbnRzKHRoaXMpOwogICAgICAgICAgICB0aGlzLndpZGdldHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5zdXBwb3J0VHlwZSA9IHRoaXMub3B0cy5zdXBwb3J0VHlwZSB8fCBbInNsaWRlciIsICJiYWNrMnRvcCJdOwogICAgICAgICAgICB0aGlzLmNsYXNzRmlsdGVyID0gdGhpcy5vcHRzLmNsYXNzRmlsdGVyIHx8ICIub2N0b3B1c3VpLWNvbnRhaW5lciI7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0TWFuYWdlci5pbml0CiAgICAgICAgICogQGRlc2Mg5byA5aeL5a+55oyH5a6a6IqC54K55LiL55qE56ym5ZCI5p2h5Lu255qEaHRtbOeJh+auteaOp+S7tuWMlgogICAgICAgICAqLwogICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgZWxzID0gby4kKHRoaXMuY2xhc3NGaWx0ZXIsIHRoaXMuZWwpLAogICAgICAgICAgICAgICAgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIG8udXRpbC5lYWNoKGVscywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgaWYoby51dGlsLmlzTm9kZShpdGVtKSkgewogICAgICAgICAgICAgICAgICAgIHRoYXQuZWxzLnB1c2goaXRlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZih0aGlzLmVscy5sZW5ndGggPT0gMCkgICAgcmV0dXJuOwogICAgICAgICAgICBvLnV0aWwuZWFjaCh0aGlzLmVscywgby51dGlsLmJpbmQodGhpcy5pbml0V2lkZ2V0cywgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBpbml0V2lkZ2V0cwogICAgICAgICAqIEBwYXJhbSBpdGVtIOWNleS4qndpZGdldOeahGh0bWzniYfmrrXnmoTlrrnlmagKICAgICAgICAgKi8KICAgICAgICBpbml0V2lkZ2V0czogZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICB2YXIgdHlwZSA9IG8uZG9tLmRhdGEoaXRlbSwgIm9jdG9wdXN1aS10eXBlIiksCiAgICAgICAgICAgICAgICBpbmRleCA9IHRoaXMuc3VwcG9ydFR5cGUuaW5kZXhPZih0eXBlKTsKICAgICAgICAgICAgaWYoaW5kZXggPT0gLTEgfHwgby5kb20uZGF0YShpdGVtLCAib2N0b3B1c3VpLWxvYWRlZCIpKSAgIHJldHVybjsKICAgICAgICAgICAgdmFyIHdpZGdldCA9IHRoaXNbdGhpcy5zdXBwb3J0VHlwZVtpbmRleF1dKGl0ZW0pOwogICAgICAgICAgICB0aGlzLnJlZ2lzdGVyKHdpZGdldCk7CiAgICAgICAgICAgIG8uZG9tLmRhdGEod2lkZ2V0LmVsLCB7CiAgICAgICAgICAgICAgICAib2N0b3B1c3VpLWxvYWRlZCI6ICJ0cnVlIgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0V2lkZ2V0QnkKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDojrflj5bnsbvlnosKICAgICAgICAgKiBAcGFyYW0gZmlsdGVyIHtTdHJpbmd9IOiOt+WPluiKgueCueeahOmAieaLqeWZqAogICAgICAgICAqLwogICAgICAgIGdldFdpZGdldEJ5OiBmdW5jdGlvbih0eXBlLCBmaWx0ZXIpIHsKICAgICAgICAgICAgdmFyIHdpZGdldHMgPSBbXSwKICAgICAgICAgICAgICAgIGxlbiA9IHRoaXMud2lkZ2V0cy5sZW5ndGgsCiAgICAgICAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgICBmb3IoOyBpLS07ICkgewogICAgICAgICAgICAgICAgdmFyIHdpZGdldCA9IHRoaXMud2lkZ2V0c1tpXTsKICAgICAgICAgICAgICAgIGlmKHdpZGdldFt0eXBlXSA9PSBmaWx0ZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZih0eXBlID09ICJpZCIpIHJldHVybiB3aWRnZXQ7CiAgICAgICAgICAgICAgICAgICAgd2lkZ2V0cy5wdXNoKHdpZGdldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdpZGdldHM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXRNYW5hZ2VyLmdldFdpZGdldEJ5SWQKICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDmoLnmja53aWRnZXTnmoRpZOaLv+WIsHdpZGdldOWvueixoQogICAgICAgICAqLwogICAgICAgIGdldFdpZGdldEJ5SWQ6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFdpZGdldEJ5KCJpZCIsIGlkKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldE1hbmFnZXIuZ2V0V2lkZ2V0QnlDbGFzcwogICAgICAgICAqIEBwYXJhbSBjIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5qC55o2ud2lkZ2V055qEY2xhc3NfbmFtZeaLv3dpZGdldOWvueixoembhuWQiAogICAgICAgICAqLwogICAgICAgIGdldFdpZGdldEJ5Q2xhc3M6IGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0V2lkZ2V0QnkoIkNMQVNTX05BTUUiLCBjKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldE1hbmFnZXIuc2xpZGVyCiAgICAgICAgICogQGRlc2Mg5Yib5bu65LiA5Liq6L2u5pKt5Zu+CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIHNsaWRlcjogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgcmV0dXJuIG8uV2lkZ2V0LnNsaWRlcihlbCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXRNYW5hZ2VyLmJhY2sydG9wCiAgICAgICAgICogQGRlc2Mg5Yib5bu65LiA5LiqZml4ZWTnmoTlhYPntKAKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgYmFjazJ0b3A6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIHJldHVybiBvLldpZGdldC5iYWNrMnRvcChlbCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXRNYW5hZ2VyLnJlZ2lzdGVyCiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKHdpZGdldCkgewogICAgICAgICAgICBpZih0aGlzLndpZGdldHMuaW5kZXhPZih3aWRnZXQpICE9IC0xKSAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB0aGlzLndpZGdldHMucHVzaCh3aWRnZXQpOwogICAgICAgICAgICB3aWRnZXQuc2V0TWFuYWdlcih0aGlzKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldE1hbmFnZXIudW5yZWdpc3RlcgogICAgICAgICAqLwogICAgICAgIHVucmVnaXN0ZXI6IGZ1bmN0aW9uKHdpZGdldCkgewogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLndpZGdldHMuaW5kZXhPZih3aWRnZXQpOwogICAgICAgICAgICBpZihpbmRleCA9PSAtMSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB0aGlzLndpZGdldHNbaW5kZXhdLnNldE1hbmFnZXIobnVsbCk7CiAgICAgICAgICAgIHRoaXMud2lkZ2V0cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLldpZGdldE1hbmFnZXIiCiAgICB9KTsKCn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICogd2ViYXBw6YCa55So57uE5Lu2CiAqIGJhY2sydG9wICAgLSAgIOWbnuWIsOmhtumDqAogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQHJlcXVpcmUgbGliL2RvbS5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICogQHJlcXVpcmUgbGliL3R3ZWVuLmpzCiAqIEByZXF1aXJlIHdpZGdldC93aWRnZXQuanMKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICogQGNsYXNzIG9jdG9wdXMuV2lkZ2V0LkJhY2syVG9wCiAgICAgKiBAcGFyZW50IG9jdG9wdXMuV2lkZ2V0CiAgICAgKiBAZGVzYyDlm57liLDpobbpg6jmjqfku7YKICAgICAqIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9IOaOpeWPl+eahOWPguaVsAogICAgICogQHBhcmFtIG9wdGlvbnMuaXNGYXN0IHtCb29sZWFufSDmmK/lkKbkvb/nlKjpq5jmgKfog73vvIjljbPlvZPmu5rliqjml7bpmpDol4/mjqfku7bvvInmqKHlvI8g6buY6K6k5LiN6YeH55SoCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5hbmltYXRpb24ge0Jvb2xlYW59IOi/lOWbnumhtumDqOaYr+WQpuS9v+eUqOWKqOeUuyDpu5jorqTkuI3ph4fnlKgKICAgICAqIEBwYXJhbSBvcHRpb25zLmJvdHRvbSB7TnVtYmVyfSDmjqfku7bot53nprvlupXpg6jnmoTlgLwKICAgICAqIEBwYXJhbSBvcHRpb25zLmRpcmVjdGlvbiB7U3RyaW5nfSDmjqfku7blnKjlt6bkvqfov5jmmK/lj7Pkvqcg6buY6K6k5Y+z5L6nICJyaWdodCIgfHwgImxlZnQiCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5vZmZzZXRWIHtOdW1iZXJ9IOaOp+S7tui3neemu+W3puS+p+aIluiAheWPs+S+p+eahOi3neemuwogICAgICogQHBhcmFtIG9wdGlvbnMuY3VzdG9taXplIHtCb29sZWFufSDmmK/lkKboh6rlrprliLbngrnlh7vmjqfku7blkI7nmoTlm57osIMg6Iul5Li6dHJ1ZeWImeeCueWHu+aOp+S7tuWPquinpuWPkeiHquWumuS5ieS6i+S7tu+8iGJhY2sydG9wLW9udGFw77yJIOS4jei/lOWbnumhtumDqAogICAgICovCiAgICBvLldpZGdldC5CYWNrMlRvcCA9IG8uZGVmaW5lKG8uV2lkZ2V0LCB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGJvdHRvbQogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg5o6n5Lu26Led56a75bqV6YOo6Led56a7CiAgICAgICAgICovCiAgICAgICAgYm90dG9tOiAxMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGlyZWN0aW9uCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBkaXJlY3Rpb246ICJyaWdodCIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG9mZnNldFYKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOaOp+S7tui3neemu+S4pOS+p+eahOi3neemuwogICAgICAgICAqLwogICAgICAgIG9mZnNldFY6IDEwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc0Fic29sdXRlCiAgICAgICAgICogQGRlc2Mg5p+Q5Lqb5py65Zmo5LiN5pSv5oyBZml4ZWTlsZ7mgKcg55SoYWJzb2x1dGXku6Pmm78KICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc0Fic29sdXRlOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNGYXN0CiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5piv5ZCm5Zyo5rua5Yqo5Lit6ZqQ6JeP5LuO6ICM5o+Q6auY5oCn6IO9CiAgICAgICAgICovCiAgICAgICAgaXNGYXN0OiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc2Nyb2xsVGltZXIKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOeUqOadpeS8mOWMluaAp+iDveeahHNjcm9sbOaXtueahOWumuaXtuWZqAogICAgICAgICAqLwogICAgICAgIHNjcm9sbFRpbWVyOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1Njcm9sbAogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOW9k+WJjeaYr+WQpuWcqHNjcm9sbOeahOagh+W/l+S9jQogICAgICAgICAqLwogICAgICAgIGlzU2Nyb2xsOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY3VzdG9taXplCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5piv5ZCm55So5oi36Ieq5a6a5LmJ54K55Ye75LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgY3VzdG9taXplOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYW5pbWF0aW9uCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5piv5ZCm5pyJ5Yqo55S7CiAgICAgICAgICovCiAgICAgICAgYW5pbWF0aW9uOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbG9vcAogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICogQGRlc2Mg5Yqo55S755qE5YaF5a2Y5a+75Z2ACiAgICAgICAgICovCiAgICAgICAgbG9vcDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY291bnQKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOWKqOeUu+iuoeaVsAogICAgICAgICAqLwogICAgICAgIGNvdW50OiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB0ZXN0Rml4ZWQKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDmmK/lkKbmtYvor5Xov4fmmK/lkKbmlK/mjIFmaXhlZOWxnuaApwogICAgICAgICAqLwogICAgICAgIHRlc3RGaXhlZDogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHRlc3RGaXhhYmxlRG9tCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICogQGRlc2Mg55So5p2l5Yik5pat6K6+5aSH5piv5ZCm5pSv5oyBZml4ZWTnmoToioLngrkKICAgICAgICAgKi8KICAgICAgICB0ZXN0Rml4YWJsZURvbTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModGhpcy5lbCwgIm9jdG9wdXN1aS1iYWNrMnRvcCIpOwogICAgICAgICAgICB0aGlzLmxvb3AgPSB7fTsKICAgICAgICAgICAgdGhpcy5pbml0Rml4ZWQoKTsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnQoKTsKICAgICAgICAgICAgdGhpcy50ZXN0Rml4YWJsZURvbSA9IG8uZG9tLmNyZWF0ZURvbSgiZGl2IiwgbnVsbCwgewogICAgICAgICAgICAgICAgdG9wOiAiNXB4IiwKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiZml4ZWQiCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBpbml0Rml4ZWQKICAgICAgICAgKiBAZGVzYyDliJ3lp4vljJZmaXjlsZ7mgKcg6K6p5YW25YW85a655omA5pyJ5rWP6KeI5ZmoCiAgICAgICAgICovCiAgICAgICAgaW5pdEZpeGVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZigvTTAzMS8udGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXRBYnNvbHV0ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGRpcmVjdGlvbiA9IHRoaXMuZGlyZWN0aW9uOwogICAgICAgICAgICAgICAgby5kb20uc2V0U3R5bGVzKHRoaXMuZWwsIHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogImZpeGVkIiwKICAgICAgICAgICAgICAgICAgICBib3R0b206IHRoaXMuYm90dG9tICsgInB4IgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlW2RpcmVjdGlvbl0gPSB0aGlzLm9mZnNldFYgKyAicHgiOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNldEFic29sdXRlCiAgICAgICAgICogQGRlc2Mg5bCG5LiN5pSv5oyBZml4ZWTnmoToioLngrnorr7nva7kuLphYnNvbHV0ZQogICAgICAgICAqLwogICAgICAgIHNldEFic29sdXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICAgICAgICAgIHRoaXMuaXNBYnNvbHV0ZSA9IHRydWU7CiAgICAgICAgICAgIG8uZXZlbnQub24od2luZG93LCAib3J0Y2hhbmdlIiwgby51dGlsLmJpbmQodGhpcy5vbk9yaWVudGF0aW9uQ2hhbmdlZCwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvbk9yaWVudGF0aW9uQ2hhbmdlZAogICAgICAgICAqLwogICAgICAgIG9uT3JpZW50YXRpb25DaGFuZ2VkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5zdGFydEZpeGVkKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGluaXRFdmVudAogICAgICAgICAqIEBkZXNjIOS6i+S7tuWIneWni+WMlgogICAgICAgICAqLwogICAgICAgIGluaXRFdmVudDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaXNGYXN0ICYmIG8uZXZlbnQub24oZG9jdW1lbnQsICJ0b3VjaG1vdmUiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hNb3ZlLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICBvLmV2ZW50Lm9uKGRvY3VtZW50LCAic2Nyb2xsIiwgby51dGlsLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcy5vbkp1ZGdlU2Nyb2xsLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICBvLmV2ZW50Lm9uKGRvY3VtZW50LCAidG91Y2hlbmQiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hFbmQsIHRoaXMpLCBmYWxzZSk7CiAgICAgICAgICAgIG8uZXZlbnQub24oZG9jdW1lbnQsICJ0b3VjaGNhbmNlbCIsIG8udXRpbC5iaW5kQXNFdmVudExpc3RlbmVyKHRoaXMub25Ub3VjaEVuZCwgdGhpcyksIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5vbigidGFwIiwgby51dGlsLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcy5vblRhcCwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvblRhcAogICAgICAgICAqLwogICAgICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJiYWNrMnRvcC1vbnRhcCIsIGUpOwogICAgICAgICAgICAhdGhpcy5jdXN0b21pemUgJiYgdGhpcy5nb1RvKDEsIHRoaXMuYW5pbWF0aW9uKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5CYWNrMlRvcC5nb1RvCiAgICAgICAgICogQHBhcmFtIHkge051bWJlcn0KICAgICAgICAgKiBAcGFyYW0gYW5pbWF0aW9uIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOS9v+mhtemdoua7muWIsOaMh+WumuS9jee9rgogICAgICAgICAqLwogICAgICAgIGdvVG86IGZ1bmN0aW9uKHksIGFuaW1hdGlvbikgewogICAgICAgICAgICBpZighYW5pbWF0aW9uKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgeSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgX3kgPSB3aW5kb3cucGFnZVlPZmZzZXQ7CiAgICAgICAgICAgICAgICB0aGlzLmNvdW50ID0gMDsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgICsrdGhpcy5jb3VudDsKICAgICAgICAgICAgICAgIHRoaXMubG9vcFt0aGlzLmNvdW50XSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmKHRoYXQubG9vcFt0aGF0LmNvdW50XSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3kgPiAoeSAtIDEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsQnkoMCwgLU1hdGgubWluKDE1MCwgX3kgLSB5ICsgMSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3kgLT0gMTUwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgby51dGlsLnJlcXVlc3RBbmltYXRpb24odGhhdC5sb29wW3RoYXQuY291bnRdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQubG9vcFt0aGF0LmNvdW50XSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0Lmxvb3BbdGhhdC5jb3VudF0gPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKHRoaXMubG9vcFt0aGlzLmNvdW50XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaEVuZAogICAgICAgICAqIEBkZXNjIOWIpOaWreaYr+WQpuW6lOivpeaYvuekugogICAgICAgICAqLwogICAgICAgIG9uVG91Y2hFbmQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmNoZWNrSWZWaXNpYmxlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uSnVkZ2VTY3JvbGwKICAgICAgICAgKi8KICAgICAgICBvbkp1ZGdlU2Nyb2xsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYoIXRoaXMuaXNTY3JvbGwpIHsKICAgICAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoaXMub25TY3JvbGwsIHRoaXMpKTsKICAgICAgICAgICAgICAgIHRoaXMuaXNTY3JvbGwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uU2Nyb2xsCiAgICAgICAgICovCiAgICAgICAgb25TY3JvbGw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmNsZWFyVGltZXIoKTsKICAgICAgICAgICAgdGhpcy5pc0Zhc3QgJiYgdGhpcy5oaWRkZW4oKTsKICAgICAgICAgICAgdGhpcy5pc0Fic29sdXRlICYmIHRoaXMuc3RhcnRGaXhlZCgpOwogICAgICAgICAgICB0aGlzLnNjcm9sbFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoby51dGlsLmJpbmQodGhpcy5vblNjcm9sbFN0b3AsIHRoaXMpLCAzMDApOwogICAgICAgICAgICB0aGlzLmlzU2Nyb2xsID0gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uU2Nyb2xsU3RvcAogICAgICAgICAqLwogICAgICAgIG9uU2Nyb2xsU3RvcDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaXNBYnNvbHV0ZSAmJiB0aGlzLnN0YXJ0Rml4ZWQoKTsKICAgICAgICAgICAgIXRoaXMudGVzdEZpeGVkICYmIHRoaXMudGVzdEZpeGFibGUoKTsKICAgICAgICAgICAgdGhpcy5jaGVja0lmVmlzaWJsZSgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCB0ZXN0Rml4YWJsZQogICAgICAgICAqIEBkZXNjIOWIpOaWreW9k+WJjeiuvuWkh+aYr+WQpuaUr+aMgWZpeGVk5bGe5oCnCiAgICAgICAgICovCiAgICAgICAgdGVzdEZpeGFibGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnRlc3RGaXhlZCA9IHRydWU7CiAgICAgICAgICAgIGlmKHRoaXMudGVzdEZpeGFibGVEb20ub2Zmc2V0VG9wICE9IDUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0QWJzb2x1dGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMudGVzdEZpeGFibGVEb20pOwogICAgICAgICAgICB0aGlzLnRlc3RGaXhhYmxlRG9tID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgY2hlY2tJZlZpc2libGUKICAgICAgICAgKi8KICAgICAgICBjaGVja0lmVmlzaWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHdpbmRvdy5wYWdlWU9mZnNldCA+IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQgPyB0aGlzLnNob3coKSA6IHRoaXMuaGlkZGVuKCkKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaE1vdmUKICAgICAgICAgKi8KICAgICAgICBvblRvdWNoTW92ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaGlkZGVuKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGNsZWFyVGltZXIKICAgICAgICAgKi8KICAgICAgICBjbGVhclRpbWVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy5zY3JvbGxUaW1lcikgewogICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLnNjcm9sbFRpbWVyKTsKICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsVGltZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHN0YXJ0Rml4ZWQKICAgICAgICAgKiBAZGVzYyDlvZPorr7lpIfkuI3mlK/mjIFmaXhlZOaXtueUqGFic29sdXRl55qE5rua5YqoCiAgICAgICAgICovCiAgICAgICAgc3RhcnRGaXhlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmFjdGl2ZSkgICAgcmV0dXJuOwoJCQl2YXIgZGlyZWN0aW9uID0gdGhpcy5kaXJlY3Rpb24gPT0gInJpZ2h0IiA/ICJsZWZ0IiA6ICJyaWdodCI7CiAgICAgICAgICAgIG8uZG9tLnNldFN0eWxlcyh0aGlzLmVsLCB7CiAgICAgICAgICAgICAgICB0b3A6IHdpbmRvdy5wYWdlWU9mZnNldCArIHdpbmRvdy5pbm5lckhlaWdodCAtIHBhcnNlSW50KHRoaXMuZ2V0SGVpZ2h0KCkpIC0gdGhpcy5ib3R0b20gKyAicHgiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmVsLnN0eWxlW2RpcmVjdGlvbl0gPSBkb2N1bWVudC5ib2R5Lm9mZnNldFdpZHRoIC0gcGFyc2VJbnQodGhpcy5nZXRXaWR0aCgpKSAtIHRoaXMub2Zmc2V0ViArICJweCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHJlbmRlcgogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiID0gZG9jdW1lbnQuYm9keSwKICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGI7CiAgICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKHRoaXMuZWwpOwogICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZCh0aGlzLnRlc3RGaXhhYmxlRG9tKQogICAgICAgICAgICB0aGlzLmFwcGVuZENoaWxkKGZyYWdtZW50LCB0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgICAgIGlmKHRoaXMuaXNTaG93KSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzU2hvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zaG93KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXRoaXMuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2YXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAib2N0b3B1cy5XaWRnZXQuQmFjazJUb3AiCiAgICB9KTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuYmFjazJ0b3AKICAgICAqIEBkZXNjIOeUn+aIkOS4jmh0bWzmqKHniYjnm7jnu5HlrprnmoTlm57liLDpobbpg6gg5omA5pyJ55qE5Y+C5pWw6YO95LulaHRtbOaooeeJiOW9ouW8j+S8oOWFpQogICAgICogQHBhcmFtIGVsCiAgICAgKiBAcmV0dXJucyB7by5XaWRnZXQuSHRtbEJhY2syVG9wfQogICAgICovCiAgICBvLldpZGdldC5iYWNrMnRvcCA9IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgcmV0dXJuIG5ldyBvLldpZGdldC5IdG1sQmFjazJUb3AoewogICAgICAgICAgICBlbDogZWwKICAgICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAY2xhc3Mgb2N0b3B1cy5XaWRnZXQuSHRtbEJhY2syVG9wCiAgICAgKiBAcGFyZW50IG9jdG9wdXMuV2lkZ2V0LkJhY2syVG9wCiAgICAgKiBAZGVzYyDlj4LmlbDkuI5vY3RvcHVzLldpZGdldC5CYWNrMlRvcCDkuI3lkIznmoTmmK8g6L+Z5Liq57G75LuF6ZmQ5LqO5a+55bey5pyJ56ym5ZCI6KeE6IyD55qEaHRtbOaooeeJiOeahOaUuemAoOS4juWwgeijhQogICAgICog56ym5ZCI5p2h5Lu255qEaHRtbOaooeeJiOWxnuaAp+WMheaLrAogICAgICogZGF0YS1vY3RvcHVzdWktYmFjazJ0b3AtZGlyZWN0aW9uIOWPr+S7peaMh+WumuaOp+S7tueahOW3puWPsyAibGVmdCIgfHwgInJpZ2h0IgogICAgICogZGF0YS1vY3RvcHVzdWktYmFjazJ0b3AtZmFzdCDlpoLmnpzorr7nva7mraTlsZ7mgKcg5L2/55So6auY5oCn6IO977yI5Y2z5b2T5rua5Yqo5pe26ZqQ6JeP5o6n5Lu277yJ5qih5byPCiAgICAgKiBkYXRhLW9jdG9wdXN1aS1iYWNrMnRvcC1hbmltYXRlIOWmguaenOiuvue9ruatpOWxnuaApyDov5Tlm57pobbpg6jkvJrkvb/nlKjliqjnlLsKICAgICAqIGRhdGEtb2N0b3B1c3VpLWJhY2sydG9wLWJvdHRvbSDorr7nva7ot53lupXpg6jnmoTot53nprsg6buY6K6k5Li6MTAKICAgICAqIGRhdGEtb2N0b3B1c3VpLWJhY2sydG9wLW9mZnNldCDorr7nva7ot53lt6bvvZzlj7PnmoTot53nprsg6buY6K6k5Li6MTAKICAgICAqIGRhdGEtb2N0b3B1c3VpLWJhY2sydG9wLWN1c3RvbWl6ZSDlpoLmnpzorr7nva7mraTlsZ7mgKcg5YiZ6ZyA6KaB6Ieq5a6a5LmJ54K55Ye75ZCO55qE5LqL5Lu2CiAgICAgKi8KICAgIG8uV2lkZ2V0Lkh0bWxCYWNrMlRvcCA9IG8uZGVmaW5lKG8uV2lkZ2V0LkJhY2syVG9wLCB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0cykgewogICAgICAgICAgICBvLldpZGdldC5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLmxvb3AgPSB7fTsKICAgICAgICAgICAgdGhpcy5kaXJlY3Rpb24gPSBvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktYmFjazJ0b3AtZGlyZWN0aW9uIikgfHwgdGhpcy5kaXJlY3Rpb247CiAgICAgICAgICAgIHRoaXMuaXNGYXN0ID0gby5kb20uZGF0YSh0aGlzLmVsLCAib2N0b3B1c3VpLWJhY2sydG9wLWZhc3QiKTsKICAgICAgICAgICAgdGhpcy5hbmltYXRpb24gPSBvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktYmFjazJ0b3AtYW5pbWF0ZSIpOwogICAgICAgICAgICB0aGlzLmJvdHRvbSA9IG8uZG9tLmRhdGEodGhpcy5lbCwgIm9jdG9wdXN1aS1iYWNrMnRvcC1ib3R0b20iKSB8fCB0aGlzLmJvdHRvbTsKICAgICAgICAgICAgdGhpcy5vZmZzZXRWID0gby5kb20uZGF0YSh0aGlzLmVsLCAib2N0b3B1c3VpLWJhY2sydG9wLW9mZnNldCIpIHx8IHRoaXMub2Zmc2V0VjsKICAgICAgICAgICAgdGhpcy5jdXN0b21pemUgPSBvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktYmFjazJ0b3AtY3VzdG9taXplIik7CiAgICAgICAgICAgIHRoaXMudGVzdEZpeGFibGVEb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIG51bGwsIHsKICAgICAgICAgICAgICAgIHRvcDogIjVweCIsCiAgICAgICAgICAgICAgICBwb3NpdGlvbjogImZpeGVkIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYodGhpcy5pc1Nob3cpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNTaG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNoZWNrRG9tKCk7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50KCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHJlbmRlcgogICAgICAgICAqIEBkZXNjIOmYsuatouiiq+iwg+eUqAogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGhpcyBjbGFzcyBjYW4ndCByZW5kZXIhIDopIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGNoZWNrRG9tCiAgICAgICAgICogQGRlc2Mg5Yid5aeL5YyWZG9tCiAgICAgICAgICovCiAgICAgICAgY2hlY2tEb206IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICAgIHRoaXMuaXNTaG93ID0gZmFsc2U7CiAgICAgICAgICAgIG8uZG9tLmFkZENsYXNzKHRoaXMuZWwsICJvY3RvcHVzdWktYmFjazJ0b3AiKTsKICAgICAgICAgICAgdGhpcy5pbml0Rml4ZWQoKTsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuZWwucGFyZW50Tm9kZSwKICAgICAgICAgICAgICAgIGJvZHkgPSBkb2N1bWVudC5ib2R5OwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGJvZHk7CiAgICAgICAgICAgIGlmKHBhcmVudCAhPSBib2R5KSB7CiAgICAgICAgICAgICAgICBwYXJlbnQucmVtb3ZlQ2hpbGQodGhpcy5lbCk7CiAgICAgICAgICAgICAgICBib2R5LmFwcGVuZENoaWxkKHRoaXMuZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQodGhpcy50ZXN0Rml4YWJsZURvbSk7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0Lkh0bWxCYWNrMlRvcCIKICAgIH0pOwoKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKiB3ZWJhcHDpgJrnlKjnu4Tku7YKICogbWFzayAgIC0gICDmta7lsYIKICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEByZXF1aXJlIGxpYi9kb20uanMKICogQHJlcXVpcmUgbGliL2V2ZW50LmpzCiAqIEByZXF1aXJlIGxpYi90d2Vlbi5qcwogKiBAcmVxdWlyZSBsaWIvYW5pbWF0ZS5qcwogKiBAcmVxdWlyZSB3aWRnZXQvd2lkZ2V0LmpzCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLldpZGdldC5NYXNrCiAgICAgKiBAcGFyZW50IG9jdG9wdXMuV2lkZ2V0CiAgICAgKiBAZGVzYyDmta7lsYLpga7nvakKICAgICAqIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9IOWPguaVsAogICAgICogQHBhcmFtIG9wdGlvbnMuaXNTY3JvbGwge0Jvb2xlYW59IOa1ruWxgua1ruWHuuaXtu+8jOaYr+WQpuemgeaOieiDjOWQjueahOa7muWKqOadoeS6i+S7tu+8jGZhbHNl56aB5o6J77yM6buY6K6k5YC85Li6ZmFsc2UKICAgICAqIEBwYXJhbSBvcHRpb25zLmFuaW1hdGlvbiB7U3RyaW5nfSDmta7lsYLmta7lh7rnmoTliqjljJbnsbvlnovvvIzpu5jorqTml6DliqjnlLsg5pSv5oyB55qE57G75Z6L5pyJCiAgICAgKiAiZmFkZSIgLS0g5riQ6ZqQ5riQ5Ye6CiAgICAgKiAic2NhbGUiIC0tIOS4remDqOWRvOWHugogICAgICogInJvdGF0ZSIgLS0g5bem5LiK6KeS6L2s5YWlIOW3puS4i+inkui9rOWHugogICAgICogInNsaWRlTGVmdCIsICJzbGlkZVJpZ2h0IiwgInNsaWRlVXAiLCAic2xpZGVEb3duIiAtLSDkuI48b2N0b3B1cy5hbmltYXRpb24+5L+d5oyB5LiA6Ie0CiAgICAgKiBAcGFyYW0gb3B0aW9ucy5pbm5lckhUTUwge1N0cmluZ30g5rWu5bGC5by55Ye655qE5YaF5a65CiAgICAgKi8KICAgIG8uV2lkZ2V0Lk1hc2sgPSBvLmRlZmluZShvLldpZGdldCwgewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1Njcm9sbAogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOaYr+WQpuWPr+S7pea7muWKqCDpu5jorqTkuI3lj6/ku6UKICAgICAgICAgKi8KICAgICAgICBpc1Njcm9sbDogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzUmVzaXplCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOWIpOaWreW9k+WJjeaYr+WQpuWkhOWcqHJlc2l6ZeS6i+S7tuaJp+ihjAogICAgICAgICAqLwogICAgICAgIGlzUmVzaXplOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYW5pbWF0aW9uCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDlj4LmlbAg6KGo5piO5rWu5bGC5rWu5Ye655qE5Yqo55S757G75Z6LCiAgICAgICAgICovCiAgICAgICAgYW5pbWF0aW9uOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBvcmlnaW4KICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOa1ruWxguWKqOeUu+i1t+Wni+eCuSDlj6rmnInlvZNhbmltYXRpb27kuLoic2NhbGUi5pe255Sf5pWICiAgICAgICAgICovCiAgICAgICAgb3JpZ2luOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpbm5lckhUTUwKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOa1ruWxgueahOWGheWuuQogICAgICAgICAqLwogICAgICAgIGlubmVySFRNTDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModGhpcy5lbCwgIm9jdG9wdXN1aS1tYXNrIik7CiAgICAgICAgICAgIGlmKHRoaXMuaW5uZXJIVE1MKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVsLmlubmVySFRNTCA9IHRoaXMuaW5uZXJIVE1MOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGluaXRFdmVudAogICAgICAgICAqIEBkZXNjIOWIneWni+WMluS6i+S7tgogICAgICAgICAqLwogICAgICAgIGluaXRFdmVudDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICF0aGlzLmlzU2Nyb2xsICYmIG8uZXZlbnQub24oZG9jdW1lbnQsICJ0b3VjaG1vdmUiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hNb3ZlLCB0aGlzKSwgZmFsc2UpOwoJCQlvLmV2ZW50Lm9uKHdpbmRvdywgIm9ydGNoYW5nZSIsIG8udXRpbC5iaW5kKHRoaXMuY2FsY1NlbGZTaXplLCB0aGlzKSwgZmFsc2UpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjYWxjU2VsZlNpemUKICAgICAgICAgKiBAZGVzYyDnm5HlkKx3aW5kb3cub25yZXNpemXkuovku7YKICAgICAgICAgKi8KICAgICAgICBjYWxjU2VsZlNpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZighdGhpcy5pc1Jlc2l6ZSkgewogICAgICAgICAgICAgICAgby51dGlsLnJlcXVlc3RBbmltYXRpb24oby51dGlsLmJpbmQodGhpcy5yZWZyZXNoU2l6ZSwgdGhpcykpOwogICAgICAgICAgICAgICAgdGhpcy5pc1Jlc2l6ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaE1vdmUKICAgICAgICAgKiBAZGVzYyBpc1Njcm9sbOS4umZhbHNl5pe2IOemgeaOiea7muWKqOadoeeahOa7muWKqAogICAgICAgICAqLwogICAgICAgIG9uVG91Y2hNb3ZlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuaXNTaG93ICYmIG8uZXZlbnQuc3RvcChlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5NYXNrLnJlbmRlcgogICAgICAgICAqIEBkZXNjIOWkjeWGmeeItuexu+aWueazlQogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oY29udGFpbmVyLCBjbG9uZSwgb3JpZ2luKSB7CiAgICAgICAgICAgIGlmKHRoaXMuYW5pbWF0aW9uID09ICJzY2FsZSIgJiYgb3JpZ2luKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9yaWdpbiA9IG9yaWdpbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBvLldpZGdldC5wcm90b3R5cGUucmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuTWFzay5hY3RpdmF0ZQogICAgICAgICAqIEBkZXNjIOWkjeWGmeeItuexu+aWueazlSDlnKjoioLngrnmiZTov5tkb23mtYHlkI7lgZrnmoTliJ3lp4vljJYKICAgICAgICAgKi8KICAgICAgICBhY3RpdmF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG8uV2lkZ2V0LnByb3RvdHlwZS5hY3RpdmF0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLnJlZnJlc2hTaXplKCk7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50KCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuTWFzay5yZWZyZXNoU2l6ZQogICAgICAgICAqIEBkZXNjIOiuoeeul+W9k+WJjemBrue9qeeahOWkp+WwjwogICAgICAgICAqLwogICAgICAgIHJlZnJlc2hTaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHBvc2l0aW9uID0gby5kb20uZ2V0U3R5bGUodGhpcy5jb250YWluZXIsICJwb3NpdGlvbiIpOwogICAgICAgICAgICBpZihwb3NpdGlvbiA9PSAic3RhdGljIikgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8uZG9tLnNldFN0eWxlcyh0aGlzLmVsLCB7CiAgICAgICAgICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICAgICAgICAgICAgbGVmdDogIjBweCIsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IE1hdGgubWF4KHRoaXMuY29udGFpbmVyLnNjcm9sbEhlaWdodCwgdGhpcy5jb250YWluZXIuY2xpZW50SGVpZ2h0KSArICJweCIKICAgICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmlzUmVzaXplID0gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuTWFzay5zaG93CiAgICAgICAgICovCiAgICAgICAgc2hvdzogZnVuY3Rpb24ob3JpZ2luKSB7CiAgICAgICAgICAgIGlmKHRoaXMuaXNTaG93KSByZXR1cm47CiAgICAgICAgICAgIGlmKG9yaWdpbiAmJiBvcmlnaW4gIT0gdGhpcy5vcmlnaW4pIHsKICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luID0gb3JpZ2luOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMub3JpZ2luKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlLndlYmtpdFRyYW5zZm9ybU9yaWdpbiA9IHRoaXMub3JpZ2luLmxlZnQgKyAicHggIiArIHRoaXMub3JpZ2luLnRvcCArICJweCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pc1Nob3cgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLnZpc2liaWxpdHkgPSAidmlzaWJsZSI7CiAgICAgICAgICAgIGlmKCEhdGhpc1t0aGlzLmFuaW1hdGlvbl0pIHsKICAgICAgICAgICAgICAgIHRoaXNbdGhpcy5hbmltYXRpb25dKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuTWFzay5oaWRkZW4KICAgICAgICAgKi8KICAgICAgICBoaWRkZW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZighdGhpcy5pc1Nob3cpICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy5pc1Nob3cgPSBmYWxzZTsKICAgICAgICAgICAgaWYoISF0aGlzW3RoaXMuYW5pbWF0aW9uXSkgewogICAgICAgICAgICAgICAgdGhpc1t0aGlzLmFuaW1hdGlvbl0oZmFsc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5faGlkZGVuKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgX2hpZGRlbgogICAgICAgICAqLwogICAgICAgIF9oaWRkZW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLnZpc2liaWxpdHkgPSAiaGlkZGVuIjsKICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS53ZWJraXRUcmFuc2Zvcm1PcmlnaW4gPSAiIjsKICAgICAgICAgICAgaWYodGhpcy5vcmlnaW4pIHsKICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBmYWRlCiAgICAgICAgICogQHBhcmFtIG91dCB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBmYWRlOiBmdW5jdGlvbihvdXQpIHsKICAgICAgICAgICAgaWYob3V0KSB7CiAgICAgICAgICAgICAgICBuZXcgby5Ud2Vlbih0aGlzLmVsLCAib3BhY2l0eSIsIDAsIDEsIC4zLCBvLnV0aWwuZW1wdHksIHsKICAgICAgICAgICAgICAgICAgICBlYXNlOiAiZWFzZS1vdXQiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5ldyBvLlR3ZWVuKHRoaXMuZWwsICJvcGFjaXR5IiwgMSwgMCwgLjMsIG8udXRpbC5iaW5kKHRoaXMuX2hpZGRlbiwgdGhpcyksIHsKICAgICAgICAgICAgICAgICAgICBlYXNlOiAiZWFzZS1vdXQiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBzY2FsZQogICAgICAgICAqIEBwYXJhbSBvdXQge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgc2NhbGU6IGZ1bmN0aW9uKG91dCkgewogICAgICAgICAgICBpZihvdXQpIHsKICAgICAgICAgICAgICAgIG5ldyBvLlR3ZWVuKHRoaXMuZWwsIFsib3BhY2l0eSIsICItd2Via2l0LXRyYW5zZm9ybSJdLCBbMCwgInNjYWxlKDApIl0sIFsxLCAic2NhbGUoMSkiXSwgLjMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3IG8uVHdlZW4odGhpcy5lbCwgWyJvcGFjaXR5IiwgIi13ZWJraXQtdHJhbnNmb3JtIl0sIFsxLCAic2NhbGUoMSkiXSwgWzAsICJzY2FsZSgwKSJdLCAuMywgby51dGlsLmJpbmQodGhpcy5faGlkZGVuLCB0aGlzKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgcm90YXRlCiAgICAgICAgICogQHBhcmFtIG91dCB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICByb3RhdGU6IGZ1bmN0aW9uKG91dCkgewogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLndlYmtpdFRyYW5zZm9ybU9yaWdpbiA9ICJsZWZ0IGJvdHRvbSI7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYob3V0KSB7CiAgICAgICAgICAgICAgICBuZXcgby5Ud2Vlbih0aGlzLmVsLCBbIm9wYWNpdHkiLCAiLXdlYmtpdC10cmFuc2Zvcm0iXSwgWzAsICJyb3RhdGUoLTkwZGVnKSJdLCBbMSwgInJvdGF0ZSgwZGVnKSJdLCAuMyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXcgby5Ud2Vlbih0aGlzLmVsLCBbIm9wYWNpdHkiLCAiLXdlYmtpdC10cmFuc2Zvcm0iXSwgWzEsICJyb3RhdGUoMGRlZykiXSwgWzAsICJyb3RhdGUoOTBkZWcpIl0sIC4zLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0Ll9oaWRkZW4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNsaWRlTGVmdAogICAgICAgICAqIEBwYXJhbSBvdXQge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgc2xpZGVMZWZ0OiBmdW5jdGlvbihvdXQpIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlKCJzbGlkZSIsICJsZWZ0Iiwgb3V0KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2xpZGVSaWdodAogICAgICAgICAqIEBwYXJhbSBvdXQKICAgICAgICAgKi8KICAgICAgICBzbGlkZVJpZ2h0OiBmdW5jdGlvbihvdXQpIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlKCJzbGlkZSIsICJyaWdodCIsIG91dCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNsaWRlVXAKICAgICAgICAgKiBAcGFyYW0gb3V0CiAgICAgICAgICovCiAgICAgICAgc2xpZGVVcDogZnVuY3Rpb24ob3V0KSB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZSgic2xpZGUiLCAidXAiLCBvdXQpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBzbGlkZURvd24KICAgICAgICAgKiBAcGFyYW0gb3V0CiAgICAgICAgICovCiAgICAgICAgc2xpZGVEb3duOiBmdW5jdGlvbihvdXQpIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlKCJzbGlkZSIsICJkb3duIiwgb3V0KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYW5pbWF0ZQogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGRpcmVjdGlvbiB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBvdXQge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgYW5pbWF0ZTogZnVuY3Rpb24odHlwZSwgZGlyZWN0aW9uLCBvdXQpIHsKICAgICAgICAgICAgdmFyIGZ1bmMgPSBvdXQgPyBvLnV0aWwuZW1wdHkgOiBvLnV0aWwuYmluZCh0aGlzLl9oaWRkZW4sIHRoaXMpOwogICAgICAgICAgICBvLmFuaW1hdGUoewogICAgICAgICAgICAgICAgZWw6IHRoaXMuZWwsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgZnVuYzogZnVuYywKICAgICAgICAgICAgICAgIGNvbmZpZzogewogICAgICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogZGlyZWN0aW9uLAogICAgICAgICAgICAgICAgICAgIG91dDogIW91dCwKICAgICAgICAgICAgICAgICAgICBpc0ZhZGU6IHRydWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0Lk1hc2siCiAgICB9KTsKCn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICogd2ViYXBw6YCa55So57uE5Lu2CiAqIG1lbnUgICAtICAg6I+c5Y2VCiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAcmVxdWlyZSBsaWIvZG9tLmpzCiAqIEByZXF1aXJlIGxpYi9ldmVudC5qcwogKiBAcmVxdWlyZSBsaWIvdHdlZW4uanMKICogQHJlcXVpcmUgbGliL2FuaW1hdGUuanMKICogQHJlcXVpcmUgd2lkZ2V0L3dpZGdldC5qcwogKi8KOyhmdW5jdGlvbihvLCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAqIEBjbGFzcyBvY3RvcHVzLldpZGdldC5NZW51CiAgICAqIEBwYXJlbnQgb2N0b3B1cy5XaWRnZXQKICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0g5Y+C5pWwCiAgICAqIEBwYXJhbSBvcHRpb25zLmRhdGEge0FycmF5fSDnlJ/miJDoj5zljZXnmoTmlbDmja4KICAgICogQHBhcmFtIG9wdGlvbnMuYW5pbWF0ZVR5cGUge1N0cmluZ30g6I+c5Y2V5YiH5o2i55qE5pe25YCZ55qE5Yqo55S757G75Z6LIOiuvue9ruS4um51bGwg5YiZ5peg5Yqo55S7IOebruWJjeaUr+aMgeeahOexu+Wei+aciXNsaWRlIGZvbGQgZmFkZSBmbGlwIHBvcCByb3RhdGUg6buY6K6k5Li6c2xpZGUKICAgICogQHBhcmFtIG9wdGlvbnMuZGlyZWN0aW9uIHtTdHJpbmd9IOWKqOeUu+aJp+ihjOeahOaWueWQkSDnm67liY3mlK/mjIEgbGVmdCB1cCBkb3duIHJpZ2h0IOm7mOiupOS4umxlZnQKICAgICogQHBhcmFtIG9wdGlvbnMuc2hvd0FuaW1hdGVUeXBlIHtTdHJpbmd9IOiPnOWNleaYvuekuumakOiXj+aXtuWAmeeahOWKqOeUu+exu+WeiyDmlK/mjIHkuI7kvb/nlKgg5ZCMYW5pbWF0ZVR5cGXkuIDoh7Qg6buY6K6k5Li6ZmFkZQogICAgKiBAcGFyYW0gb3B0aW9ucy5iYWNrQ29udGVudCB7U3RyaW5nfSDov5Tlm57oj5zljZXnmoTmlofmoYgg6buY6K6k5Li6Iui/lOWbnuS4iuS4gOe6pyIKICAgICovCiAgICBvLldpZGdldC5NZW51ID0gby5kZWZpbmUoby5XaWRnZXQsIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGF0YQogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAZGVzYyDnlJ/miJDoj5zljZXnmoTmlbDmja7mupAKICAgICAgICAgKi8KICAgICAgICBkYXRhOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBhbmltYXRlVHlwZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5YiH5o2i5pe25L2/55So55qE5Yqo55S757G75Z6LCiAgICAgICAgICovCiAgICAgICAgYW5pbWF0ZVR5cGU6ICJzbGlkZSIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGRpcmVjdGlvbgogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5YiH5o2i5Yqo55S755qE5pa55ZCRCiAgICAgICAgICovCiAgICAgICAgZGlyZWN0aW9uOiAibGVmdCIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHNob3dBbmltYXRlVHlwZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5pi+56S65pe255qE5Yqo55S757G75Z6LCiAgICAgICAgICovCiAgICAgICAgc2hvd0FuaW1hdGVUeXBlOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjdXJyZW50TWVudVVsCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICogQGRlc2Mg5b2T5YmN6KKr5omT5byA55qEbWVudeeahOWuueWZqOiKgueCuQogICAgICAgICAqLwogICAgICAgIGN1cnJlbnRNZW51VWw6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHJvb3RVbAogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIHJvb3RVbDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgb3BlbkxpCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICogQGRlc2Mg5q+P5qyh5bGV5byA55qEbGnoioLngrkKICAgICAgICAgKi8KICAgICAgICBvcGVuTGk6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGJhY2tDb250ZW50CiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDov5Tlm57oj5zljZXnmoTmlofmoYgKICAgICAgICAgKi8KICAgICAgICBiYWNrQ29udGVudDogIui/lOWbnuS4iuS4gOe6pyIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IERJUkVDVElPTgogICAgICAgICAqIEBkZXNjIOeUqOadpeS/neWtmGRpcmVjdGlvbueahOebuOWvueaWueWQkQogICAgICAgICAqLwogICAgICAgIERJUkVDVElPTjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgaWYoIXRoaXMuZGF0YSkJdGhyb3cgbmV3IEVycm9yKCJyZXF1aXJlIHRoZSBwcm9wZXJ0eSBvZiBkYXRhISIpOwogICAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMuYnVpbGRNZW51KHRoaXMuZGF0YSk7CiAgICAgICAgICAgIHRoaXMuRElSRUNUSU9OID0gewogICAgICAgICAgICAgICAgImxlZnQiOiAicmlnaHQiLAogICAgICAgICAgICAgICAgInJpZ2h0IjogImxlZnQiLAogICAgICAgICAgICAgICAgInVwIjogImRvd24iLAogICAgICAgICAgICAgICAgImRvd24iOiAidXAiCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG8uZG9tLnNldFN0eWxlcyh0aGlzLmVsLCB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgICAiLXdlYmtpdC1iYWNrZmFjZS12aXNpYmlsaXR5IjogImhpZGRlbiIKICAgICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgICAgIG8uZG9tLmFkZENsYXNzKHRoaXMuZWwsICJvY3RvcHVzdWktbWVudSIpOwogICAgICAgICAgICB0aGlzLmVsLmFwcGVuZENoaWxkKHJvb3QpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmUocm9vdCkub24oInRhcCIsIG8udXRpbC5iaW5kQXNFdmVudExpc3RlbmVyKHRoaXMub25UYXAsIHRoaXMpKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYnVpbGRNZW51CiAgICAgICAgICogQGRlc2Mg55Sf5oiQ6IqC54K557uT5p6ECiAgICAgICAgICogQHBhcmFtIGRhdGEge0FycmF5fQogICAgICAgICAqIEBwYXJhbSBpc0NoaWxkIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGJ1aWxkTWVudTogZnVuY3Rpb24oZGF0YSwgaXNDaGlsZCkgewogICAgICAgICAgICBpc0NoaWxkID0gaXNDaGlsZCB8fCBmYWxzZTsKICAgICAgICAgICAgdmFyIHVsZG9tID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidWwiKSwKICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICAgICAgICAgICAgbGVuID0gZGF0YS5sZW5ndGgsCiAgICAgICAgICAgICAgICBpID0gMDsKICAgICAgICAgICAgaWYoaXNDaGlsZCkgewogICAgICAgICAgICAgICAgdmFyIGRvbSA9IG8uZG9tLmNyZWF0ZURvbSgibGkiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJjbGFzcyI6ICJvY3RvcHVzdWktbWVudS1yZXR1cm5wYXJlbnQiCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgX2Fkb20gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgICAgICAgICAgICBfYWRvbS5pbm5lckhUTUwgPSB0aGlzLmJhY2tDb250ZW50OwogICAgICAgICAgICAgICAgZG9tLmFwcGVuZENoaWxkKF9hZG9tKTsKICAgICAgICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh1bGRvbSwgIm9jdG9wdXN1aS1tZW51LWNoaWxkbWVudSIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModWxkb20sICJvY3RvcHVzdWktbWVudS11bCIpOwogICAgICAgICAgICAgICAgdGhpcy5yb290VWwgPSB1bGRvbTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBpdGVtRGF0YSA9IGRhdGFbaV0sCiAgICAgICAgICAgICAgICAgICAgbGlkb20gPSBvLmRvbS5jcmVhdGVEb20oImxpIiwgewogICAgICAgICAgICAgICAgICAgICAgICBpZDogaXRlbURhdGEuaWQgfHwgaXRlbURhdGEubmFtZQogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgIGFkb20gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgICAgICAgICAgICBpZihpdGVtRGF0YS5jaGlsZHJlbiAmJiBpdGVtRGF0YS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgby5kb20uYWRkQ2xhc3MobGlkb20sICJvY3RvcHVzdWktbWVudS1oYXNjaGlsZCIpCiAgICAgICAgICAgICAgICAgICAgdmFyIGZyYWdkb20gPSB0aGlzLmJ1aWxkTWVudShpdGVtRGF0YS5jaGlsZHJlbiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihpdGVtRGF0YS5ocmVmKSB7CiAgICAgICAgICAgICAgICAgICAgby5kb20uZGF0YShsaWRvbSwgewogICAgICAgICAgICAgICAgICAgICAgICBocmVmOiBpdGVtRGF0YS5ocmVmCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhZG9tLmlubmVySFRNTCA9IG8udXRpbC5lbmNvZGVIdG1sKGl0ZW1EYXRhLm5hbWUpOwogICAgICAgICAgICAgICAgbGlkb20uYXBwZW5kQ2hpbGQoYWRvbSk7CiAgICAgICAgICAgICAgICBmcmFnZG9tICYmIGxpZG9tLmFwcGVuZENoaWxkKGZyYWdkb20pOwogICAgICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQobGlkb20pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVsZG9tLmFwcGVuZENoaWxkKGZyYWdtZW50KTsKICAgICAgICAgICAgcmV0dXJuIHVsZG9tOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvblRhcAogICAgICAgICAqIEBkZXNjIOebkeWQrOiiq+eCueWHu+S6i+S7tiDkvJrlj5Hlh7roh6rlrprkuYnkuovku7YgIm1lbnUtaXRlbS1vbnRhcCIKICAgICAgICAgKi8KICAgICAgICBvblRhcDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICBvLmV2ZW50LnN0b3AoZSwgdHJ1ZSk7CiAgICAgICAgICAgIHZhciB0ID0gZS50YXJnZXQsCiAgICAgICAgICAgICAgICB0YWduYW1lID0gdC50YWdOYW1lLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIGlmKHRhZ25hbWUgPT0gIkEiKSB7CiAgICAgICAgICAgICAgICB0ID0gdC5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG8uZG9tLmhhc0NsYXNzKHQsICJvY3RvcHVzdWktbWVudS1kaXNhYmxlIikpCXJldHVybjsKICAgICAgICAgICAgdGhpcy5ub3RpZnkoIm1lbnUtaXRlbS1vbnRhcCIsIHQpOwogICAgICAgICAgICBpZihvLmRvbS5oYXNDbGFzcyh0LCAib2N0b3B1c3VpLW1lbnUtaGFzY2hpbGQiKSkgewogICAgICAgICAgICAgICAgdGhpcy5leHBlbmRNZW51KHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG8uZG9tLmhhc0NsYXNzKHQsICJvY3RvcHVzdWktbWVudS1yZXR1cm5wYXJlbnQiKSkgewogICAgICAgICAgICAgICAgdGhpcy5yZXR1cm5QYXJlbnQodCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgcmV0dXJuUGFyZW50CiAgICAgICAgICogQHBhcmFtIGVsCiAgICAgICAgICogQGRlc2Mg54K55Ye76L+U5Zue5oyJ6ZKu5pe26I+c5Y2V55qE5Y+N5bqUCiAgICAgICAgICovCiAgICAgICAgcmV0dXJuUGFyZW50OiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICBvLmRvbS5yZW1vdmVDbGFzcyh0aGlzLm9wZW5MaSwgIm9jdG9wdXN1aS1tZW51LW9wZW5tZW51Iik7CiAgICAgICAgICAgIGlmKHRoaXMuY3VycmVudE1lbnVVbCA9PSB0aGlzLnJvb3RVbCkgewogICAgICAgICAgICAgICAgby5kb20ucmVtb3ZlQ2xhc3ModGhpcy5yb290VWwsICJvY3RvcHVzdWktbWVudS1jaGlsZHZpZXciKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLmN1cnJlbnRNZW51VWwucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIG8uZG9tLnJlbW92ZUNsYXNzKHBhcmVudCwgIm9jdG9wdXN1aS1tZW51LWNoaWxkdmlldyIpOwogICAgICAgICAgICAgICAgby5kb20uYWRkQ2xhc3MocGFyZW50LCAib2N0b3B1c3VpLW1lbnUtb3Blbm1lbnUiKTsKICAgICAgICAgICAgICAgIHRoaXMub3BlbkxpID0gcGFyZW50OwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50TWVudVVsID0gdGhpcy5vcGVuTGkucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGlyZWN0aW9uID0gdGhpcy5ESVJFQ1RJT05bdGhpcy5kaXJlY3Rpb25dIHx8ICJsZWZ0IjsKICAgICAgICAgICAgaWYodGhpcy5hbmltYXRlVHlwZSkgewogICAgICAgICAgICAgICAgdGhpc1t0aGlzLmFuaW1hdGVUeXBlXSh0aGlzLm9wZW5MaSwgZGlyZWN0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjaGFuZ2VkRXhwZW5kSXRlbQogICAgICAgICAqIEBkZXNjIOW9k+WxleW8gOiKgueCueeahOaXtuWAmSDosIPmlbTmoLflvI8KICAgICAgICAgKi8KICAgICAgICBjaGFuZ2VkRXhwZW5kSXRlbTogZnVuY3Rpb24oY2xvc2Vkb20sIGV4cGVuZGRvbSkgewogICAgICAgICAgICB2YXIgdmMgPSAib2N0b3B1c3VpLW1lbnUtY2hpbGR2aWV3IjsKICAgICAgICAgICAgdGhpcy5jdXJyZW50TWVudVVsID0gY2xvc2Vkb207CiAgICAgICAgICAgIGV4cGVuZGRvbSA9PSB0aGlzLnJvb3RVbCA/IG8uZG9tLnJlbW92ZUNsYXNzKHRoaXMucm9vdFVsLCB2YykgOgogICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh0aGlzLnJvb3RVbCwgdmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBleHBlbmRNZW51CiAgICAgICAgICogQHBhcmFtIGRvbSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDlvoXlsZXlvIDnmoTliIbnsbvoioLngrnmk43kvZwKICAgICAgICAgKi8KICAgICAgICBleHBlbmRNZW51OiBmdW5jdGlvbihkb20pIHsKICAgICAgICAgICAgdmFyIGV4cGVuZE1lbnUgPSBkb20uY2hpbGRyZW5bMV0sCiAgICAgICAgICAgICAgICBwYXJlbnQgPSBkb20ucGFyZW50Tm9kZSwKICAgICAgICAgICAgICAgIG9jID0gIm9jdG9wdXN1aS1tZW51LW9wZW5tZW51IjsKICAgICAgICAgICAgaWYodGhpcy5vcGVuTGkpIHsKICAgICAgICAgICAgICAgIG8uZG9tLnJlbW92ZUNsYXNzKHRoaXMub3BlbkxpLCBvYyk7CiAgICAgICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh0aGlzLm9wZW5MaSwgIm9jdG9wdXN1aS1tZW51LWNoaWxkdmlldyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMub3BlbkxpID0gZG9tOwogICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh0aGlzLm9wZW5MaSwgIm9jdG9wdXN1aS1tZW51LW9wZW5tZW51Iik7CiAgICAgICAgICAgIHRoaXMuY2hhbmdlZEV4cGVuZEl0ZW0ocGFyZW50LCBleHBlbmRNZW51KTsKICAgICAgICAgICAgaWYodGhpcy5hbmltYXRlVHlwZSkgewogICAgICAgICAgICAgICAgdGhpc1t0aGlzLmFuaW1hdGVUeXBlXShleHBlbmRNZW51LCB0aGlzLmRpcmVjdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYW5pbWF0ZQogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBkaXJlY3Rpb24ge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gb3V0IHtCb29sZWFufQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0KICAgICAgICAgKiBAZGVzYyDliqjnlLvmlrnms5UKICAgICAgICAgKi8KICAgICAgICBhbmltYXRlOiBmdW5jdGlvbihlbCwgdHlwZSwgZGlyZWN0aW9uLCBvdXQsIGZ1bmMpIHsKICAgICAgICAgICAgdmFyIGZ1bmMgPSBmdW5jIHx8IG8udXRpbC5lbXB0eTsKICAgICAgICAgICAgby5hbmltYXRlKHsKICAgICAgICAgICAgICAgIGVsOiB0aGlzLmVsLAogICAgICAgICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgICAgICAgIGZ1bmM6IGZ1bmMsCiAgICAgICAgICAgICAgICBjb25maWc6IHsKICAgICAgICAgICAgICAgICAgICBkaXJlY3Rpb246IGRpcmVjdGlvbiwKICAgICAgICAgICAgICAgICAgICBvdXQ6ICFvdXQsCiAgICAgICAgICAgICAgICAgICAgaXNGYWRlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAuMwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5NZW51LnNob3cKICAgICAgICAgKiBAZGVzYyDmmL7npLrmjqfku7YKICAgICAgICAgKi8KICAgICAgICBzaG93OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLnNob3cuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgaWYodGhpcy5zaG93QW5pbWF0ZVR5cGUpIHsKICAgICAgICAgICAgICAgIHRoaXNbdGhpcy5zaG93QW5pbWF0ZVR5cGVdKHRoaXMuZWwsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuTWVudS5oaWRkZW4KICAgICAgICAgKiBAZGVzYyDpmpDol4/mjqfku7YKICAgICAgICAgKi8KICAgICAgICBoaWRkZW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgaCA9IG8uV2lkZ2V0LnByb3RvdHlwZS5oaWRkZW47CiAgICAgICAgICAgIGlmKHRoaXMuc2hvd0FuaW1hdGVUeXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB0aGlzW3RoaXMuc2hvd0FuaW1hdGVUeXBlXSh0aGlzLmVsLCBmYWxzZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaC5hcHBseSh0aGF0LCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIHRoYXQucmVzZXRNZW51KCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGguYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRNZW51KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2xpZGUKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIGRpcmVjdGlvbiB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICBzbGlkZTogZnVuY3Rpb24oZWwsIGRpcmVjdGlvbiwgZnVuYykgewogICAgICAgICAgICB0aGlzLmFuaW1hdGUoZWwsICJzbGlkZSIsIGRpcmVjdGlvbiwgdHJ1ZSwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGZvbGQKICAgICAgICAgKiBAcGFyYW0gZWwKICAgICAgICAgKiBAcGFyYW0gZGlyZWN0aW9uCiAgICAgICAgICogQHBhcmFtIGZ1bmMKICAgICAgICAgKi8KICAgICAgICBmb2xkOiBmdW5jdGlvbihlbCwgZGlyZWN0aW9uLCBmdW5jKSB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZShlbCwgImZvbGQiLCBkaXJlY3Rpb24sIHRydWUsIGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBmYWRlCiAgICAgICAgICogQHBhcmFtIGVsIHtET01FTGVtZW50fQogICAgICAgICAqIEBwYXJhbSBvdXQge0Jvb2xlYW59CiAgICAgICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufQogICAgICAgICAqLwogICAgICAgIGZhZGU6IGZ1bmN0aW9uKGVsLCBvdXQsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlKGVsLCAiZmFkZSIsIG51bGwsIG91dCwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGZsaXAKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIGRpcmVjdGlvbiB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICBmbGlwOiBmdW5jdGlvbihlbCwgZGlyZWN0aW9uLCBmdW5jKSB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZShlbCwgImZsaXAiLCBkaXJlY3Rpb24sIHRydWUsIGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBwb3AKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIG91dCB7Qm9vbGVhbn0KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgcG9wOiBmdW5jdGlvbihlbCwgb3V0LCBmdW5jKSB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZShlbCwgInBvcCIsIG51bGwsIG91dCwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHJvdGF0ZQogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gb3V0IHtCb29sZWFufQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICByb3RhdGU6IGZ1bmN0aW9uKGVsLCBvdXQsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlKGVsLCAicm90YXRlIiwgbnVsbCwgb3V0LCBmdW5jKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5NZW51LnJlc2V0TWVudQogICAgICAgICAqIEBkZXNjIOmHjee9ruiPnOWNlQogICAgICAgICAqLwogICAgICAgIHJlc2V0TWVudTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMucm9vdFVsICYmIG8uZG9tLnJlbW92ZUNsYXNzKHRoaXMucm9vdFVsLCAib2N0b3B1c3VpLW1lbnUtY2hpbGR2aWV3Iik7CiAgICAgICAgICAgIHRoaXMub3BlbkxpICYmIG8uZG9tLnJlbW92ZUNsYXNzKHRoaXMub3BlbkxpLCAib2N0b3B1c3VpLW1lbnUtb3Blbm1lbnUiKTsKICAgICAgICAgICAgdGhpcy5vcGVuTGkgPSBudWxsOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRNZW51VWwgPSBudWxsOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLldpZGdldC5NZW51IgogICAgfSk7Cgp9KShvY3RvcHVzKTsvKioKICogQGZpbGUKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqIHdlYmFwcOmAmueUqOe7hOS7tgogKiBwaWMtcmVhZGVyICAgLSAgIOWbvueJh+mihOiniAogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQHJlcXVpcmUgbGliL2RvbS5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICogQHJlcXVpcmUgd2lkZ2V0L3dpZGdldC5qcwogKiBAcmVxdWlyZSB3aWRnZXQvbWFzay9tYXNrLmpzCiAqIEByZXF1aXJlIHdpZGdldC9zbGlkZXIvc2xpZGVyLmpzCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIEBjbGFzcwogICAgICogQHBhcmVudCBvY3RvcHVzLldpZGdldC5NYXNrCiAgICAgKiBAcGFyYW0gb3B0cyDkvKDlhaXnmoTlj4LmlbAKICAgICAqIEBwYXJhbSBvcHRzLmltZ0VsIHtET01FbGVtZW50fSDlj6/ku6XpgJrov4fkvKDlhaXkuIDkuKroioLngrnop6PmnpDoioLngrnkuIvmiYDmnInnmoRpbWfmoIfnrb4KICAgICAqIEBwYXJhbSBvcHRzLmltZ3Mge0FycmF5fSDop6PmnpDnmoRpbWfmoIfnrb7pm4blkIgg5Y+v5Lul5LiOaW1nRWzlhbHlrZgKICAgICAqIEBwYXJhbSBvcHRzLm1heFcge051bWJlcn0g5bGP5bmV55qE5a695bqmIOWPr+S8oOWPr+S4jeS8oCDkvKDnmoTlpb3lpITlsJHkuIDmrKFyZXBhaW50CiAgICAgKiBAcGFyYW0gb3B0cy5tYXhIIHtOdW1iZXJ9IOWxj+W5leeahOmrmOW6puWHj+WOuzYwcHgg5Y+v5Lyg5Y+v5LiN5LygIOWQjOS4igogICAgICogQHBhcmFtIG9wdHMuaGFzQnV0dG9uIHtCb29sZWFufSDlkIxvY3RvcHVzLldpZGdldC5TbGlkZXLkuK3nmoRoYXNCdXR0b24g6buY6K6k5Li6ZmFsc2UKICAgICAqIEBwYXJhbSBvcHRzLmhhc0dpem1vcyB7Qm9vbGVhbn0g5ZCM5LiKIOm7mOiupOS4umZhbHNlCiAgICAgKiBAcGFyYW0gb3B0cy5oYXNUaXRsZSB7Qm9vbGVhbn0g5ZCM5LiKIOm7mOiupOS4umZhbHNlCiAgICAgKi8KICAgIG8uV2lkZ2V0LlBpY1JlYWRlciA9IG8uZGVmaW5lKG8uV2lkZ2V0Lk1hc2ssIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaW1nRWwKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDlm77niYfpmIXor7vmtonlj4rliLDnmoTmoLnnu5PngrkKICAgICAgICAgKi8KICAgICAgICBpbWdFbDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc2xpZGVyRWwKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDph4zpnaLkuIDkupvkuJzopb/nmoTlrrnlmagKICAgICAgICAgKi8KICAgICAgICBzbGlkZXJFbDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaW1nQ0VsCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICogQGRlc2Mg5pi+56S65Yy65Z+f5Zu+54mH55qE5a655ZmoCiAgICAgICAgICovCiAgICAgICAgaW1nQ0VsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1Jlc2l6ZQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOagh+W/l+S9jSDkuLrkuoborqlyZXNpemXop6blj5HnmoTlho3lsJHkuIDkupsKICAgICAgICAgKi8KICAgICAgICBpc1Jlc2l6ZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG1heFcKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOWxj+W5leeahOWuveW6pgogICAgICAgICAqLwogICAgICAgIG1heFc6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG1heEgKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOWxj+W5leeahOmrmOW6puWHj+WOuzYwCiAgICAgICAgICovCiAgICAgICAgbWF4SDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaW1ncwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAZGVzYyDkvKDlhaXnmoTlm77niYfoioLngrnpm4blkIgKICAgICAgICAgKi8KICAgICAgICBpbWdzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBkYXRhcwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAZGVzYyDnlJ/miJBzbGlkZXLnmoTmlbDmja4KICAgICAgICAgKi8KICAgICAgICBkYXRhczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc2xpZGVyCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBzbGlkZXI6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGhhc0J1dHRvbgogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOeUn+aIkHNsaWRlcueUqOeahOWPguaVsAogICAgICAgICAqLwogICAgICAgIGhhc0J1dHRvbjogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGhhc0dpem1vcwogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOeUn+aIkHNsaWRlcueUqOeahOWPguaVsAogICAgICAgICAqLwogICAgICAgIGhhc0dpem1vczogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGhhc1RpdGxlCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg55Sf5oiQc2xpZGVy55So55qE5Y+C5pWwCiAgICAgICAgICovCiAgICAgICAgaGFzVGl0bGU6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBvLldpZGdldC5NYXNrLnByb3RvdHlwZS5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHRoaXMuaW1ncyA9IHRoaXMuaW1ncyB8fCBbXTsKICAgICAgICAgICAgdGhpcy5kYXRhcyA9IHRoaXMuZGF0YXMgfHwgW107CiAgICAgICAgICAgIGlmKHRoaXMuaW1nRWwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5pdEltZ0V2ZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hbmltYXRpb24gPSAiZmFkZSI7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgby5ldmVudC5vbih3aW5kb3csICJvcnRjaGFuZ2UiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LmlzUmVzaXplKSB7CiAgICAgICAgICAgICAgICAgICAgby51dGlsLnJlcXVlc3RBbmltYXRpb24oby51dGlsLmJpbmQodGhhdC5jaGVja1NpemUsIHRoYXQpKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LmlzUmVzaXplID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmJ1aWxkU2xpZGVyKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGNoZWNrU2l6ZQogICAgICAgICAqIEBkZXNjIOeUqOS6jua1j+iniOWZqHJlc2l6ZeaXtuWvueS6juWxj+W5leWuvemrmOeahOmHjeaWsOiOt+WPlgogICAgICAgICAqLwogICAgICAgIGNoZWNrU2l6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMubWF4VyA9IG8uZG9tLmdldFNjcmVlbldpZHRoKCk7CiAgICAgICAgICAgIHRoaXMubWF4SCA9IG8uZG9tLmdldFNjcmVlbkhlaWdodCgpIC0gNjA7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyLmVsLnN0eWxlLmhlaWdodCA9IHRoaXMubWF4SCArICJweCI7CiAgICAgICAgICAgIHRoaXMuY2FsY1JlY3Qoby5vbmUoImltZyIsIHRoaXMuaW1nQ0VsKSk7CiAgICAgICAgICAgIHRoaXMuaXNSZXNpemUgPSBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYnVpbGRTbGlkZXIKICAgICAgICAgKiBAZGVzYyDnlJ/miJDoioLngrkKICAgICAgICAgKi8KICAgICAgICBidWlsZFNsaWRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyRWwgPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICJjbGFzcyI6ICJvY3RvcHVzdWktcmVhZGVyLXNsaWRlcmNvbnRhaW5lciIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuaW1nQ0VsID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlYWRlci1pbWdjb250YWluZXIiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2YXIgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgICAgICAgICBpbWdkb20gPSBvLmRvbS5jcmVhdGVEb20oImltZyIsIHsKICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlYWRlci1pbWciCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGNsb3NlZG9tID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAgICAgImNsYXNzIjogIm9jdG9wdXN1aS1yZWFkZXItY2xvc2UiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5pbWdDRWwuYXBwZW5kQ2hpbGQoaW1nZG9tKTsKICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQodGhpcy5pbWdDRWwpOwogICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChjbG9zZWRvbSk7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyRWwuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwogICAgICAgICAgICB0aGlzLmVsLmFwcGVuZENoaWxkKHRoaXMuc2xpZGVyRWwpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBpbml0SW1nRXZlbnQKICAgICAgICAgKi8KICAgICAgICBpbml0SW1nRXZlbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgaW1ncyA9IG8uJCgiaW1nIiwgdGhpcy5pbWdFbCk7CiAgICAgICAgICAgIGlmKCFpbWdzKSAgIHJldHVybjsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5pbWdzLCBvLnV0aWwuYmluZCh0aGlzLmFkZEltZ0V2ZW50LCB0aGlzKSk7CiAgICAgICAgICAgIG8udXRpbC5lYWNoKGltZ3MsIG8udXRpbC5iaW5kKHRoaXMuYWRkSW1nRXZlbnQsIHRoaXMpKTsKICAgICAgICAgICAgdGhpcy5zbGlkZXIgPSBuZXcgby5XaWRnZXQuU2xpZGVyKHsKICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMuZGF0YXMsCiAgICAgICAgICAgICAgICBoYXNCdXR0b246IHRoaXMuaGFzQnV0dG9uLAogICAgICAgICAgICAgICAgYXV0b1BsYXk6IGZhbHNlLAogICAgICAgICAgICAgICAgbG9vcDogZmFsc2UsCiAgICAgICAgICAgICAgICBoYXNHaXptb3M6IHRoaXMuaGFzR2l6bW9zLAogICAgICAgICAgICAgICAgaGFzVGl0bGU6IHRoaXMuaGFzVGl0bGUsCiAgICAgICAgICAgICAgICBsb2FkSW1hZ2VOdW1iZXI6IDEsCiAgICAgICAgICAgICAgICBpc0Rpc2FibGVBOiB0cnVlLAogICAgICAgICAgICAgICAgZGlzU2Nyb2xsOiB0cnVlLAogICAgICAgICAgICAgICAgaWQ6ICJvY3RvcHVzdWktcmVhZGVyLXNsaWRlciIKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGFkZEltZ0V2ZW50CiAgICAgICAgICogQHBhcmFtIGl0ZW0KICAgICAgICAgKiBAcGFyYW0gaW5kZXgKICAgICAgICAgKi8KICAgICAgICBhZGRJbWdFdmVudDogZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKICAgICAgICAgICAgaWYoIW8udXRpbC5pc05vZGUoaXRlbSkgfHwgIWl0ZW0uc3JjKSAgICByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaW1ncy5wdXNoKGl0ZW0pOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBzcmMgPSBpdGVtLnNyYzsKICAgICAgICAgICAgby51dGlsLmxvYWRJbWFnZShzcmMsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgby5kb20uZGF0YShpdGVtLCB7CiAgICAgICAgICAgICAgICAgICAgIm9jdG9wdXN1aS1yZWFkZXItd2lkdGgiOiB0aGlzLndpZHRoLAogICAgICAgICAgICAgICAgICAgICJvY3RvcHVzdWktcmVhZGVyLWhlaWdodCI6IHRoaXMuaGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICJvY3RvcHVzdWktcmVhZGVyLWluZGV4IjogaW5kZXgKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoYXQuZ2VzdHVyZShpdGVtKS5vbigidGFwIiwgby51dGlsLmJpbmQodGhhdC5pdGVtT25UYXAsIHRoYXQpKTsKICAgICAgICAgICAgfSwgby51dGlsLmVtcHR5KTsKICAgICAgICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgICAgICAgICB0aXRsZTogby5kb20uZGF0YShpdGVtLCAib2N0b3B1c3VpLXJlYWRlci10aXRsZSIpIHx8ICIiLAogICAgICAgICAgICAgICAgdXJsOiBvLmRvbS5kYXRhKGl0ZW0sICJvY3RvcHVzdWktcmVhZGVyLXVybCIpIHx8ICIiLAogICAgICAgICAgICAgICAgaW1hZ2VfdXJsOiBvLmRvbS5kYXRhKGl0ZW0sICJvY3RvcHVzdWktcmVhZGVyLXNyYyIpIHx8IHNyYwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmRhdGFzLnB1c2goZGF0YSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGl0ZW1PblRhcAogICAgICAgICAqLwogICAgICAgIGl0ZW1PblRhcDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICBvLmV2ZW50LnN0b3AoZSk7CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDsKICAgICAgICAgICAgdGhpcy5hY3RpdmUgPyB0aGlzLnNob3codGFyZ2V0KSA6IHRoaXMucmVuZGVyKHRoaXMuY29udGFpbmVyIHx8IGRvY3VtZW50LmJvZHksIGZhbHNlLCB0YXJnZXQpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlBpY1JlYWRlci5yZW5kZXIKICAgICAgICAgKi8KICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKGNvbnRhaW5lciwgY2xvbmUsIGRvbSkgewogICAgICAgICAgICB0aGlzLnNsaWRlci5jb250YWluZXIgPSB0aGlzLnNsaWRlckVsOwogICAgICAgICAgICB0aGlzLnNsaWRlci5lbC5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyLmlzU2hvdyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNsaWRlckVsLmFwcGVuZENoaWxkKHRoaXMuc2xpZGVyLmVsKTsKCiAgICAgICAgICAgIG8uV2lkZ2V0LnByb3RvdHlwZS5yZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgdGhpcy5tYXhXID0gdGhpcy5tYXhXIHx8IG8uZG9tLmdldFNjcmVlbldpZHRoKCk7CiAgICAgICAgICAgIHRoaXMubWF4SCA9IHRoaXMubWF4SCB8fCBvLmRvbS5nZXRTY3JlZW5IZWlnaHQoKSAtIDYwOwogICAgICAgICAgICB0aGlzLnNsaWRlci5hY3RpdmF0ZSgpOwogICAgICAgICAgICB0aGlzLnNsaWRlci5lbC5zdHlsZS5jc3NUZXh0ID0gImhlaWdodDogIiArIHRoaXMubWF4SCArICJweDsgd2lkdGg6IDEwMCU7IG92ZXJmbG93OiBoaWRkZW47ICIgKwogICAgICAgICAgICAgICAgImRpc3BsYXk6IG5vbmU7IGxlZnQ6IDA7IHRvcDogMDsgYm90dG9tOiAwOyByaWdodDogMDsgbWFyZ2luOiBhdXRvOyBwb3NpdGlvbjogYWJzb2x1dGU7IjsKICAgICAgICAgICAgdGhpcy5kb21FbWVyZ2VkKGRvbSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuUGljUmVhZGVyLnNob3cKICAgICAgICAgKi8KICAgICAgICBzaG93OiBmdW5jdGlvbihkb20pIHsKICAgICAgICAgICAgby5XaWRnZXQuTWFzay5wcm90b3R5cGUuc2hvdy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICBpZighZG9tKSAgICByZXR1cm47CiAgICAgICAgICAgIHRoaXMuZG9tRW1lcmdlZChkb20pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBfaGlkZGVuCiAgICAgICAgICovCiAgICAgICAgX2hpZGRlbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG8uV2lkZ2V0Lk1hc2sucHJvdG90eXBlLl9oaWRkZW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgdGhpcy5pbWdDRWwuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyLmhpZGRlbigpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBkb21FbWVyZ2VkCiAgICAgICAgICovCiAgICAgICAgZG9tRW1lcmdlZDogZnVuY3Rpb24oZG9tKSB7CiAgICAgICAgICAgIHZhciBjbG9uZWRvbSA9IGRvbS5jbG9uZU5vZGUoKSwKICAgICAgICAgICAgICAgIF9jbG9uZSA9IG8uZG9tLmNsb25lTm9kZSh0aGlzLmltZ0NFbCwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIF9jbG9uZS5hcHBlbmRDaGlsZChjbG9uZWRvbSk7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyRWwucmVwbGFjZUNoaWxkKF9jbG9uZSwgdGhpcy5pbWdDRWwpOwogICAgICAgICAgICB0aGlzLmltZ0NFbCA9IF9jbG9uZTsKICAgICAgICAgICAgdGhpcy5jYWxjUmVjdChkb20pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBsb2FkTGFyZ2VJbWcKICAgICAgICAgKi8KICAgICAgICBsb2FkTGFyZ2VJbWc6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIHZhciBzcmMgPSBvLmRvbS5kYXRhKGVsLCAib2N0b3B1c3VpLXJlYWRlci1zcmMiKSwKICAgICAgICAgICAgICAgIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighc3JjIHx8IG8uZG9tLmRhdGEoZWwsICJvY3RvcHVzdWktcmVhZGVyLWxvYWRlZCIpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNoYW5nZWRWaXNpYmxlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZighby5kb20uaGFzQ2xhc3ModGhpcy5pbWdDRWwsICJvY3RvcHVzdWktcmVhZGVyLWxvYWRpbmciKSkgewogICAgICAgICAgICAgICAgICAgIG8uZG9tLmFkZENsYXNzKHRoaXMuaW1nQ0VsLCAib2N0b3B1c3VpLXJlYWRlci1sb2FkaW5nIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvLnV0aWwubG9hZEltYWdlKG8uZG9tLmRhdGEoZWwsICJvY3RvcHVzdWktcmVhZGVyLXNyYyIpLCBvLnV0aWwuZW1wdHksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRoYXQuY2hhbmdlZFZpc2libGUoZWwpOwogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5jaGFuZ2VkVmlzaWJsZShlbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjaGFuZ2VkVmlzaWJsZQogICAgICAgICAqLwogICAgICAgIGNoYW5nZWRWaXNpYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYoby5kb20uaGFzQ2xhc3ModGhpcy5pbWdDRWwsICJvY3RvcHVzdWktcmVhZGVyLWxvYWRpbmciKSkgewogICAgICAgICAgICAgICAgby5kb20ucmVtb3ZlQ2xhc3ModGhpcy5pbWdDRWwsICJvY3RvcHVzdWktcmVhZGVyLWxvYWRpbmciKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihhcmd1bWVudHNbMF0pIHsKICAgICAgICAgICAgICAgIG8uZG9tLmRhdGEoYXJndW1lbnRzWzBdLCB7CiAgICAgICAgICAgICAgICAgICAgIm9jdG9wdXN1aS1yZWFkZXItbG9hZGVkIjogInRydWUiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNsaWRlci5zaG93KCk7CiAgICAgICAgICAgIHRoaXMuaW1nQ0VsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY2FsY1NjcmVlbgogICAgICAgICAqLwogICAgICAgIGNhbGNSZWN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGVsID0gYXJndW1lbnRzWzBdLAogICAgICAgICAgICAgICAgcmVjdCA9IGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLAogICAgICAgICAgICAgICAgcncgPSByZWN0LndpZHRoLAogICAgICAgICAgICAgICAgcmggPSByZWN0LmhlaWdodCwKICAgICAgICAgICAgICAgIHcgPSBvLmRvbS5kYXRhKGVsLCAib2N0b3B1c3VpLXJlYWRlci13aWR0aCIpIHx8IHJ3LAogICAgICAgICAgICAgICAgaCA9IG8uZG9tLmRhdGEoZWwsICJvY3RvcHVzdWktcmVhZGVyLWhlaWdodCIpIHx8IHJoLAogICAgICAgICAgICAgICAgdCA9IHJlY3QudG9wLAogICAgICAgICAgICAgICAgbCA9IHJlY3QubGVmdCwKICAgICAgICAgICAgICAgIG1heFcgPSB0aGlzLm1heFcsCiAgICAgICAgICAgICAgICBtYXhIID0gdGhpcy5tYXhILAogICAgICAgICAgICAgICAgX3csCiAgICAgICAgICAgICAgICBfaCwKICAgICAgICAgICAgICAgIF90LAogICAgICAgICAgICAgICAgX2w7CiAgICAgICAgICAgIGlmKHcgPD0gbWF4VyAmJiBoIDw9IG1heEgpIHsKICAgICAgICAgICAgICAgIF90ID0gKG1heEggLSBoKSAvIDIgKyAzMDsKICAgICAgICAgICAgICAgIF9sID0gKG1heFcgLSB3KSAvIDI7CiAgICAgICAgICAgICAgICBfdyA9IHc7CiAgICAgICAgICAgICAgICBfaCA9IGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZih3ID4gaCkgewogICAgICAgICAgICAgICAgICAgIF93ID0gbWF4VzsKICAgICAgICAgICAgICAgICAgICBfbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgX2ggPSBoICogX3cgLyB3OwogICAgICAgICAgICAgICAgICAgIF90ID0gKG1heEggLSBfaCkgLyAyICsgMzA7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9oID0gbWF4SDsKICAgICAgICAgICAgICAgICAgICBfdCA9IDMwOwogICAgICAgICAgICAgICAgICAgIF93ID0gdyAqIF9oIC8gaDsKICAgICAgICAgICAgICAgICAgICBfbCA9IChtYXhXIC0gX3cpIC8gMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNsaWRlci5zZWxlY3Qoby5kb20uZGF0YShlbCwgIm9jdG9wdXN1aS1yZWFkZXItaW5kZXgiKSAtIDApOwoKICAgICAgICAgICAgdGhpcy5zbGlkZXJBbmltYXRlKFsibGVmdCIsICJ0b3AiLCAid2lkdGgiLCAiaGVpZ2h0Il0sIFtsLCB0LCBydywgcmhdLCBbX2wsIF90LCBfdywgX2hdLCBlbCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNsaWRlckFuaW1hdGUKICAgICAgICAgKi8KICAgICAgICBzbGlkZXJBbmltYXRlOiBmdW5jdGlvbihwcm9wcywgc3ZzLCBldnMsIGVsKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIG5ldyBvLlR3ZWVuKHRoaXMuaW1nQ0VsLCBwcm9wcywgc3ZzLCBldnMsIC40LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoYXQubG9hZExhcmdlSW1nKGVsKTsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgZWFzZTogImVhc2Utb3V0IiwKICAgICAgICAgICAgICAgIGRlbGF5OiAuNAogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAib2N0b3B1cy5XaWRnZXQuUGljUmVhZGVyIgogICAgfSk7Cgp9KShvY3RvcHVzKTsvKioKICogQGZpbGUKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqIHdlYmFwcOmAmueUqOe7hOS7tgogKiBwcm9ncmVzcyAgIC0gICDlm77niYfpooTop4gKICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEByZXF1aXJlIGxpYi9kb20uanMKICogQHJlcXVpcmUgbGliL2V2ZW50LmpzCiAqIEByZXF1aXJlIHdpZGdldC93aWRnZXQuanMKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICogQGNsYXNzIG9jdG9wdXMuV2lkZ2V0LlByb2dyZXNzCiAgICAgKiBAcGFyZW50IG9jdG9wdXMuV2lkZ2V0CiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICAgICogQHBhcmFtIG9wdGlvbnMuZHVyYXRpb24ge051bWJlcn0gbG9hZGluZ+WKqOeUu+eahOaJp+ihjOaXtumXtCDlnKjosIPnlKhnb1Rv562J5pa55rOV5pe25Y+v6YCa6L+H5Lyg5YWl5Y+C5pWw5pS55Y+YIOm7mOiupDJzCiAgICAgKiBAdHlwZSB7KnxGdW5jdGlvbnxuZXd9CiAgICAgKi8KICAgIG8uV2lkZ2V0LlByb2dyZXNzID0gby5kZWZpbmUoby5XaWRnZXQsIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgdmFsdWUKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOiusOW9leeahOiKgueCueeahHRyYW5zbGF0ZeWAvAogICAgICAgICAqLwogICAgICAgIHZhbHVlOiAxMDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0CiAgICAgICAgICogQHByb3BlcnR5IHNwZWVkCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDoh6rliqjliqDovb3nirbmgIHkuIvnmoTluLjph4/lj4LmlbAg5YW25a6e5LiO6YCf5bqm5peg5YWzCiAgICAgICAgICovCiAgICAgICAgc3BlZWQ6IDAuNDksCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0CiAgICAgICAgICogQHByb3BlcnR5IG1pblYKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOiHquWKqOWKoOi9veeKtuaAgeS4i+WPmOWMlumHj+eahOacgOWwj+WAvAogICAgICAgICAqLwogICAgICAgIG1pblY6IDAuNjAwMDksCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGR1cmF0aW9uCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyBsb2FkaW5n5Yqo55S755qE5omn6KGM5pe26Ze0CiAgICAgICAgICovCiAgICAgICAgZHVyYXRpb246IDIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHRpbWVyCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmiafooYznmoTlrprml7blmagKICAgICAgICAgKi8KICAgICAgICB0aW1lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3QKICAgICAgICAgKiBAcHJvcGVydHkgdHJpY2tlcgogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg6Ieq5Yqo5Yqg6L2954q25oCB5LiL55qE5rWu5Yqo5Y+Y6YePCiAgICAgICAgICovCiAgICAgICAgdHJpY2tlcjogMTAwLjAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzU3RvcAogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOagh+W/l+S9jeagh+W/l+W9k+WJjeaYr+WQpuWkhOS6juiHquWKqOWKoOi9veeKtuaAgQogICAgICAgICAqLwogICAgICAgIGlzU3RvcDogdHJ1ZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgdHJpY2tlVGltZXIKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOiHquWKqOWKoOi9veeahOWumuaXtuWZqAogICAgICAgICAqLwogICAgICAgIHRyaWNrZVRpbWVyOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBvLldpZGdldC5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh0aGlzLmVsLCAib2N0b3B1c3VpLXByb2dyZXNzIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGFjdGl2YXRlCiAgICAgICAgICogQGRlc2Mg5bCG5rKh5pyJcG9zaXRpb27lsZ7mgKfnmoToioLngrnmlLnkuLpyZWxhdGl2ZQogICAgICAgICAqLwogICAgICAgIGFjdGl2YXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmFjdGl2YXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGlmKG8uZG9tLmdldFN0eWxlKHRoaXMuY29udGFpbmVyLCAicG9zaXRpb24iKSA9PSAic3RhdGljIikgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuUHJvZ3Jlc3MuZ29UbwogICAgICAgICAqIEBwYXJhbSBvcHZzIOWPguaVsAogICAgICAgICAqIEBwYXJhbSBvcHZzLnZhbHVlIHtOdW1iZXJ9IOiuvue9rmxvYWTnmoTkvY3nva4g5Y+W5YC86IyD5Zu05Li6MC0xMDAKICAgICAgICAgKiBAcGFyYW0gb3B2cy5kdXJhdGlvbiB7TnVtYmVyfSDorr7nva5sb2FkaW5n5Yqo55S755qE5pe26Ze0IOm7mOiupOS4ujIKICAgICAgICAgKiBAcGFyYW0gb3B2cy50eXBlIHtTdHJpbmd9IOiuvue9rmxvYWTkvY3nva7mmK/lkKbkvb/nlKjliqjnlLsg6buY6K6k5LiN5L2/55SoIOiLpemcgOimgeS9v+eUqOWKqOeUuyDor7forr7nva7kuLogImFuaW1hdGlvbiIKICAgICAgICAgKiBAcGFyYW0gb3B2cy5mdW5jIHtGdW5jdGlvbn0g6K6+572u5a6M55qE5Zue6LCD5Ye95pWwIOivt+azqOaEj+S4jeimgeWGjeWbnuiwg+S4reS9v+eUqGdvVG/jgIFwYXNzVHJpY2vnrYnmlrnms5Ug5ZCm5YiZ5Zue6YCg5oiQ6Ieq5byV55SoCiAgICAgICAgICogQGRlc2Mg6K6+572ubG9hZOihjOS4ugogICAgICAgICAqLwogICAgICAgIGdvVG86IGZ1bmN0aW9uKG9wdnMpIHsKICAgICAgICAgICAgaWYoIXRoaXMuaXNTdG9wKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9nb1RvKG9wdnMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBfZ29UbwogICAgICAgICAqIEBwYXJhbSBvcHZzIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgX2dvVG86IGZ1bmN0aW9uKG9wdnMpIHsKICAgICAgICAgICAgdmFyIHYgPSBNYXRoLm1heChNYXRoLm1pbigxMDAgLSBNYXRoLmFicyhvcHZzLnZhbHVlKSwgMTAwKSwgMCksCiAgICAgICAgICAgICAgICBkID0gb3B2cy5kdXJhdGlvbiB8fCB0aGlzLmR1cmF0aW9uLAogICAgICAgICAgICAgICAgdCA9IG9wdnMudHlwZSB8fCAiYXV0byIsCiAgICAgICAgICAgICAgICB2YWx1ZSA9ICJ0cmFuc2xhdGUzZCgtIiArIFN0cmluZyh2KSArICIlLCAwLCAwKSIsCiAgICAgICAgICAgICAgICBmdW5jID0gb3B2cy5mdW5jOwogICAgICAgICAgICBpZih0ID09ICJhdXRvIikgewogICAgICAgICAgICAgICAgdGhpcy5zZXRTdHlsZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICBmdW5jICYmIGZ1bmMoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gIiAiICsgZCArICJzIGxpbmVhciIsCiAgICAgICAgICAgICAgICAgICAgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlLndlYmtpdFRyYW5zaXRpb24gPSAiLXdlYmtpdC10cmFuc2Zvcm0iICsgdDsKICAgICAgICAgICAgICAgIHRoaXMuZWwuc3R5bGUudHJhbnNpdGlvbiA9ICJ0cmFuc2Zvcm0iICsgdDsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRoYXQuc2V0U3R5bGUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgIGlmKHRoYXQudGltZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGF0LnRpbWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50aW1lciA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhhdDsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWwuc3R5bGUud2Via2l0VHJhbnNpdGlvbiA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmVsLnN0eWxlLnRyYW5zaXRpb24gPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyAmJiBmdW5jKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgZCAqIDEwMDAgKyAxNTApOwogICAgICAgICAgICAgICAgfSwgMTAwKTsgICAgLy/lvZPpobXpnaLliqjnlLvpnZ7luLjlpJrnmoTml7blgJkg6L+Z5Liq5pe25YCZ57uZ5LiA5LiqMG1z55qE5bu25pe25a+55LqO5o6n5Lu26Ieq6Lqr55qE5Yqo55S75pi+5b6X5p2v5rC06L2m6JaqCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zZXRWKHYpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBzZXRTdHlsZQogICAgICAgICAqIEBwYXJhbSB2IHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg6K6+572uZWznmoR0cmFuc2Zvcm3lgLwKICAgICAgICAgKi8KICAgICAgICBzZXRTdHlsZTogZnVuY3Rpb24odikgewogICAgICAgICAgICBvLmRvbS5zZXRTdHlsZXModGhpcy5lbCwgewogICAgICAgICAgICAgICAgIi13ZWJraXQtdHJhbnNmb3JtIjogdiwKICAgICAgICAgICAgICAgICJ0cmFuc2Zvcm0iOiB2CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlByb2dyZXNzLnN0b3AKICAgICAgICAgKiBAZGVzYyDlgZzmraLoh6rliqjliqDovb3mlrnms5UKICAgICAgICAgKi8KICAgICAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy50cmlja2VUaW1lcikgewogICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLnRyaWNrZVRpbWVyKTsKICAgICAgICAgICAgICAgIHRoaXMudHJpY2tlVGltZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNldFYKICAgICAgICAgKiBAcGFyYW0gdgogICAgICAgICAqIEBkZXNjIOiuvue9ruW9k+WJjeeahHZhbHVl5YC8CiAgICAgICAgICovCiAgICAgICAgc2V0VjogZnVuY3Rpb24odikgewogICAgICAgICAgICBpZih0aGlzLnZhbHVlID09IHYpIHJldHVybjsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHY7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuUHJvZ3Jlc3MucGFzc0FsbAogICAgICAgICAqIEBkZXNjIOeUqOWBt+aHkueahOaWueazleaXoOmZkOaOpei/keS6juWKoOi9veaIkOWKnwogICAgICAgICAqLwogICAgICAgIHBhc3NUcmljazogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaXNTdG9wID0gZmFsc2U7CiAgICAgICAgICAgIGlmKCFhcmd1bWVudHNbMF0pIHsKICAgICAgICAgICAgICAgIHRoaXMudHJpY2tlciA9IDEwMCAqIHRoaXMuc3BlZWQ7CiAgICAgICAgICAgICAgICB0aGlzLnZhbHVlID0gMTAwOwogICAgICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS53ZWJraXRUcmFuc2l0aW9uID0gIiI7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlLnRyYW5zaXRpb24gPSAiIjsKICAgICAgICAgICAgICAgIHRoaXMuc2V0U3R5bGUoInRyYW5zbGF0ZTNkKC0xMDAlLCAwLCAwKSIpOwogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5fZ29Ubyh7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0aGF0LnRyaWNrZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJhbmltYXRpb24iCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgdGhpcy50cmlja2VUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KG8udXRpbC5iaW5kKHRoaXMuZXhlY3V0ZVRyaWNrZXIsIHRoaXMpLCB0aGlzLmR1cmF0aW9uICogMTAwMCArIDEwMCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGV4ZWN1dGVUcmlja2VyCiAgICAgICAgICogQGRlc2Mg5YW35L2T5omn6KGM6Ieq5Yqo5Yqg6L2955qE5pa55rOVCiAgICAgICAgICovCiAgICAgICAgZXhlY3V0ZVRyaWNrZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnRyaWNrZXIgPSB0aGlzLnRyaWNrZXIgKiB0aGlzLnNwZWVkOwogICAgICAgICAgICBpZih0aGlzLnRyaWNrZXIgPCB0aGlzLm1pblYpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNTdG9wID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2dvVG8oewogICAgICAgICAgICAgICAgdmFsdWU6IDEwMCAtIHRoaXMudmFsdWUgKyB0aGlzLnRyaWNrZXIsCiAgICAgICAgICAgICAgICB0eXBlOiAiYW5pbWF0aW9uIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5wYXNzVHJpY2sodHJ1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0LlByb2dyZXNzIgogICAgfSk7Cgp9KShvY3RvcHVzKTsKLyoqCiAqIEBmaWxlCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKiB3ZWJhcHDpgJrnlKjnu4Tku7YKICogcmVmcmVzaCAgIC0gICDkuIrmi4nkuIvmi4nliLfmlrAKICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEByZXF1aXJlIGxpYi9kb20uanMKICogQHJlcXVpcmUgbGliL2V2ZW50LmpzCiAqIEByZXF1aXJlIHdpZGdldC93aWRnZXQuanMKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICogQGNsYXNzIG9jdG9wdXMuV2lkZ2V0LlJlZnJlc2gKICAgICAqIEBwYXJlbnQgb2N0b3B1cy5XaWRnZXQKICAgICAqIEBkZXNjIOS4iuaLieS4i+aLieWIt+aWsAogICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0g5o6l5Y+X55qE5Y+C5pWwCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5kaXJlY3Rpb24ge1N0cmluZ30g6KGo5piO5piv5LiK5ouJfOS4i+aLieWIt+aWsOaOp+S7tiAidXAifCJkb3duIiDpu5jorqTmmK/kuIrmi4nliLfmlrDmjqfku7YKICAgICAqIEBwYXJhbSBvcHRpb25zLmhlaWdodCB7TnVtYmVyfSDmjqfku7bnmoTpq5jluqYKICAgICAqIEBwYXJhbSBvcHRpb25zLm1heFRyYW5zbGF0ZSB7TnVtYmVyfSDmjqfku7blj6/ku6Xmi4nliqjnmoTmnIDlpKfplb/luqYg6buY6K6k5Li6MTAwIOeUseS6juS4uuS6humBv+WFjem6u+eDpueahOWkmuasoeWkhOeQhiDkuIvmi4nliLfmlrDnmoTmnIDlpKfpq5jluqbkuLrmraTlgLzkuI7mjqfku7bpq5jluqbnmoTlt67lgLwKICAgICAqIEBwYXJhbSBvcHRpb25zLmhhbGZUcmFuc2xhdGUge051bWJlcn0g5p2+5omL5Yqg6L2955qE5Li055WM5YC8CiAgICAgKiBAcGFyYW0gb3B0aW9ucy5wdWxsVGV4dCB7U3RyaW5nfSDmmL7npLrkuLvljLrln5/nmoTmloflrZcKICAgICAqIEBwYXJhbSBvcHRpb25zLmNoYW5nZVB1bGxUZXh0IHtTdHJpbmd9IOaYvuekuuS4u+WMuuWfn+WcqOS4tOeVjOWAvOeahOaWh+WtlwogICAgICogQHBhcmFtIG9wdGlvbnMuc3RhdHVzVGV4dCB7U3RyaW5nfSDmmL7npLrmrKHljLrln5/nmoTmloflrZcKICAgICAqIEBwYXJhbSBvcHRpb25zLmNoYW5nZVN0YXR1c1RleHQge1N0cmluZ30g5pi+56S65qyh5Yy65Z+f5Zyo5Li055WM5YC855qE5paH5a2XCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5sb2FkVGV4dCB7U3RyaW5nfSDliqDovb3kuK3nmoTmloflrZcKICAgICAqLwogICAgby5XaWRnZXQuUmVmcmVzaCA9IG8uZGVmaW5lKG8uV2lkZ2V0LCB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGRpcmVjdGlvbgogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5Yi35paw55qE5pyd5ZCRIOm7mOiupOWQkeS4iuWIt+aWsAogICAgICAgICAqLwogICAgICAgIGRpcmVjdGlvbjogInVwIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZHJhZ0RpcmVjdGlvbgogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5b2T5YmN5ouW5ou955qE5pa55ZCRCiAgICAgICAgICovCiAgICAgICAgZHJhZ0RpcmVjdGlvbjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgdGltZXIKICAgICAgICAgKiBAdHlwZSB7RnVuY3Rpb259CiAgICAgICAgICogQGRlc2Mg5b2TdG91Y2jml7bot5HnmoTlrprml7bmnJ/nqIvluo8KICAgICAgICAgKi8KICAgICAgICB0aW1lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNEcmFnCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOagh+W/l+aYr+WQpuWkhOS6juaLluaLveeKtuaAgQogICAgICAgICAqLwogICAgICAgIGlzRHJhZzogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHBhZ2VEcmFnQwogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg5ouW5ou954K555qEeeWdkOaghwogICAgICAgICAqLwogICAgICAgIHBhZ2VEcmFnU3RhcnRDOiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwYWdlRHJhZ0Rvd24KICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOaLluaLvee7k+adn+eCueeahHnlnZDmoIcKICAgICAgICAgKi8KICAgICAgICBwYWdlRHJhZ0VuZEM6IDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHBhZ2VEcmFnVGVtcEMKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOS4remXtOaLluaLveeCueeahHnlnZDmoIcKICAgICAgICAgKi8KICAgICAgICBwYWdlRHJhZ1RlbXBDOiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBoZWlnaHQKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOaOp+S7tumrmOW6pgogICAgICAgICAqLwogICAgICAgIGhlaWdodDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbWF4VHJhbnNsYXRlCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmjqfku7bnmoTmnIDlpKfmi5bliqjot53nprsKICAgICAgICAgKi8KICAgICAgICBtYXhUcmFuc2xhdGU6IDEwMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaGFsZlRyYW5zbGF0ZQogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg5o6n5Lu255qE5Li055WM6Led56a7CiAgICAgICAgICovCiAgICAgICAgaGFsZlRyYW5zbGF0ZTogMzAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFycm93CiAgICAgICAgICogQGRlc2Mg566t5aS055qE6IqC54K5CiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgYXJyb3c6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHB1bGxUZXh0RG9tCiAgICAgICAgICogQGRlc2Mg5Li75pi+56S65Yy66IqC54K5CiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgcHVsbFRleHREb206IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHB1bGxUZXh0CiAgICAgICAgICogQGRlc2Mg5Li75pi+56S65Yy65paH5a2XCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBwdWxsVGV4dDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY2hhbmdlUHVsbFRleHQKICAgICAgICAgKiBAZGVzYyDkuLTnlYzml7bkuLvmmL7npLrljLrmloflrZcKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGNoYW5nZVB1bGxUZXh0OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBzdGF0dXNUZXh0RG9tCiAgICAgICAgICogQGRlc2Mg54q25oCB5Yy65paH5a2X6IqC54K5CiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgc3RhdHVzVGV4dERvbTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbG9hZGluZ0RvbQogICAgICAgICAqIEBkZXNjIGxvYWRpbmfoioLngrkKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBsb2FkaW5nRG9tOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBzdGF0dXNUZXh0CiAgICAgICAgICogQGRlc2Mg54q25oCB5Yy65paH5a2XCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBzdGF0dXNUZXh0OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBsb2FkVGV4dAogICAgICAgICAqIEBkZXNjIOWKoOi9veaXtueahOaWh+WtlwogICAgICAgICAqLwogICAgICAgIGxvYWRUZXh0OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjaGFuZ2VTdGF0dXNUZXh0CiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDkuLTnlYzml7bnirbmgIHljLrmloflrZcKICAgICAgICAgKi8KICAgICAgICBjaGFuZ2VTdGF0dXNUZXh0OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB0cmFuc2xhdGVWCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDlvZPliY3oioLngrnnmoR0cmFuc2xhdGXlgLwKICAgICAgICAgKi8KICAgICAgICB0cmFuc2xhdGVWOiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc0xvY2tlZAogICAgICAgICAqIEBkZXNjIOmUgeWumuagh+W/l+S9jQogICAgICAgICAqLwogICAgICAgIGlzTG9ja2VkOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgby5kb20uYXR0cih0aGlzLmVsLCB7CiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlZnJlc2ggb2N0b3B1c3VpLXJlZnJlc2giICsgby51dGlsLmNhbWVsaXplKHRoaXMuZGlyZWN0aW9uKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5idWlsZFNlbGYoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgdXBkYXRlVHJhbnNsYXRlVgogICAgICAgICAqIEBkZXNjIOabtOaWsOW9k+WJjeeahHRyYW5zbGF0ZeWAvAogICAgICAgICAqLwogICAgICAgIHVwZGF0ZVRyYW5zbGF0ZVY6IGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgaWYodGhpcy50cmFuc2xhdGVWID09IHYpICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy50cmFuc2xhdGVWID0gdjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYnVpbGRTZWxmCiAgICAgICAgICogQGRlc2Mg5Yid5aeL5YyW6Ieq6Lqr6IqC54K5CiAgICAgICAgICovCiAgICAgICAgYnVpbGRTZWxmOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGRyID0gdGhpcy5kaXJlY3Rpb24sCiAgICAgICAgICAgICAgICBjb25maWcgPSBvLldpZGdldC5SZWZyZXNoLmNvbmZpZzsKICAgICAgICAgICAgdGhpcy5hcnJvdyA9IG8uZG9tLmNyZWF0ZURvbSgiZGl2IiwgewogICAgICAgICAgICAgICAgImNsYXNzIjogY29uZmlnW2RyXVsiYXJyb3dDIl0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciB0ZXh0RG9tID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAgICAgImNsYXNzIjogIm9jdG9wdXN1aS1yZWZyZXNoLXRleHRjb250YWluZXIiCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHRjb250YWluZXIgPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlZnJlc2gtcmVmcmVzaGNvbnRhaW5lciIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnB1bGxUZXh0RG9tID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlZnJlc2gtcHVsbHRleHQgb2N0b3B1c3VpLXRleHQtbGltaXQiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHREb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsICB7CiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlZnJlc2gtc3RhdHVzdGV4dCBvY3RvcHVzdWktdGV4dC1saW1pdCIKICAgICAgICAgICAgfSkKICAgICAgICAgICAgdGhpcy5sb2FkaW5nRG9tID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlZnJlc2gtbG9hZGluZyIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVGV4dCgicHVsbFRleHQiLCAic3RhdHVzVGV4dCIpOwogICAgICAgICAgICB0ZXh0RG9tLmFwcGVuZENoaWxkKHRoaXMucHVsbFRleHREb20pOwogICAgICAgICAgICB0ZXh0RG9tLmFwcGVuZENoaWxkKHRoaXMuc3RhdHVzVGV4dERvbSk7CiAgICAgICAgICAgIHRjb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5hcnJvdyk7CiAgICAgICAgICAgIHRjb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5sb2FkaW5nRG9tKTsKICAgICAgICAgICAgdGNvbnRhaW5lci5hcHBlbmRDaGlsZCh0ZXh0RG9tKTsKICAgICAgICAgICAgdGhpcy5lbC5hcHBlbmRDaGlsZCh0Y29udGFpbmVyKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgdG9nZ2xlTG9hZGluZwogICAgICAgICAqLwogICAgICAgIHRvZ2dsZUxvYWRpbmc6IGZ1bmN0aW9uKGV4aXN0KSB7CiAgICAgICAgICAgIGlmKCFleGlzdCAmJiB0aGlzLmxvYWRpbmdEb20uc3R5bGUuZGlzcGxheSAhPSAibm9uZSIpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9hZGluZ0RvbS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgICB9IGVsc2UgaWYoZXhpc3QgJiYgdGhpcy5sb2FkaW5nRG9tLnN0eWxlLmRpc3BsYXkgIT0gImJsb2NrIikgewogICAgICAgICAgICAgICAgdGhpcy5sb2FkaW5nRG9tLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuUmVmcmVzaC5yZW5kZXIKICAgICAgICAgKi8KICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBvLldpZGdldC5wcm90b3R5cGUucmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGlmKHRoaXMuaGVpZ2h0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gby5kb20uZ2V0SGVpZ2h0KHRoaXMuZWwpOwogICAgICAgICAgICB9CgkJCXRoaXMuYWRkRXZlbnQoKTsKICAgICAgICAgICAgby5kb20uc2Nyb2xsTGl0ZSh0aGlzLmNvbnRhaW5lci5wYXJlbnROb2RlLCBmYWxzZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGFwcGVuZENoaWxkCiAgICAgICAgICogQHBhcmFtIGVsCiAgICAgICAgICogQHBhcmFtIGNvbnRhaW5lcgogICAgICAgICAqIEBkZXNjIOWkjeWGmeeItuexu+eahGFwcGVuZENoaWxkIOWinuWKoOaPkuWFpeacgOWJjeeahOWkhOeQhgogICAgICAgICAqLwogICAgICAgIGFwcGVuZENoaWxkOiBmdW5jdGlvbihlbCwgY29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmKHRoaXMuZGlyZWN0aW9uID09ICJ1cCIpIHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChlbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvLmRvbS5pbnNlcnRGaXJzdChlbCwgY29udGFpbmVyKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBhZGRFdmVudAogICAgICAgICAqIEBkZXNjIOS6i+S7tuebkeWQrAogICAgICAgICAqLwogICAgICAgIGFkZEV2ZW50OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5ldmVudC5vbihkb2N1bWVudCwgInRvdWNoc3RhcnQiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hTdGFydCwgdGhpcyksIGZhbHNlKTsKICAgICAgICAgICAgby5ldmVudC5vbihkb2N1bWVudCwgInRvdWNoZW5kIiwgby51dGlsLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcy5vblRvdWNoRW5kLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICBvLmV2ZW50Lm9uKGRvY3VtZW50LCAidG91Y2hjYW5jZWwiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hFbmQsIHRoaXMpLCBmYWxzZSk7CiAgICAgICAgICAgIG8uZXZlbnQub24oZG9jdW1lbnQsICJ0b3VjaG1vdmUiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hNb3ZlLCB0aGlzKSwgZmFsc2UpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvblRvdWNoU3RhcnQKICAgICAgICAgKiBAZGVzYyDnm5HlkKx0b3VjaHN0YXJ05LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgb25Ub3VjaFN0YXJ0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIG8uZXZlbnQuc3RvcChlLCB0cnVlKTsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgdG91Y2hlcyA9IGUudG91Y2hlczsKICAgICAgICAgICAgaWYoIXRvdWNoZXMgfHwgdG91Y2hlcy5sZW5ndGggPiAxKSAgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzRHJhZyA9IHRydWU7CiAgICAgICAgICAgIHZhciB0b3VjaCA9IHRvdWNoZXNbMF0sCiAgICAgICAgICAgICAgICBkYyA9IHRvdWNoLnBhZ2VZOwogICAgICAgICAgICB0aGlzLnBhZ2VEcmFnU3RhcnRDID0gdGhpcy5wYWdlRHJhZ1RlbXBDID0gZGM7CiAgICAgICAgICAgIHRoaXMudGltZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LnRpbWVyKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZih0aGF0LnBhZ2VEcmFnVGVtcEMgPiB0aGF0LnBhZ2VEcmFnU3RhcnRDKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5kcmFnRGlyZWN0aW9uID0gImRvd24iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKHRoYXQucGFnZURyYWdUZW1wQyA8IHRoYXQucGFnZURyYWdTdGFydEMpIHsKCQkJCQl0aGF0LmRyYWdEaXJlY3Rpb24gPSAidXAiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoKHRoYXQucGFnZURyYWdUZW1wQyA9PSB0aGF0LnBhZ2VEcmFnU3RhcnRDKSB8fCAhdGhhdC5hZGp1c3RTY3JvbGxCYXIoKSkgewogICAgICAgICAgICAgICAgICAgIHRoYXQucGFnZURyYWdTdGFydEMgPSB0aGF0LnBhZ2VEcmFnVGVtcEMKICAgICAgICAgICAgICAgICAgICBvLnV0aWwucmVxdWVzdEFuaW1hdGlvbih0aGF0LnRpbWVyKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CgkJCQl9CiAgICAgICAgICAgICAgICB0aGF0LnBhZ2VEcmFnRW5kQyA9IHRoYXQucGFnZURyYWdUZW1wQzsKICAgICAgICAgICAgICAgIHZhciBkaXMgPSAodGhhdC5wYWdlRHJhZ1RlbXBDIC0gdGhhdC5wYWdlRHJhZ1N0YXJ0Qyk7CiAgICAgICAgICAgICAgICB0aGF0LnBhZ2VEcmFnU3RhcnRDID0gdGhhdC5wYWdlRHJhZ1RlbXBDOwogICAgICAgICAgICAgICAgdmFyIHR2YWx1ZSA9IHRoYXQudHJhbnNsYXRlVjsKICAgICAgICAgICAgICAgIHZhciB2LAogICAgICAgICAgICAgICAgICAgIF92ID0gdHZhbHVlICsgZGlzOwogICAgICAgICAgICAgICAgaWYodGhhdC5kaXJlY3Rpb24gPT0gInVwIikgewogICAgICAgICAgICAgICAgICAgIGlmKHRoYXQuZHJhZ0RpcmVjdGlvbiA9PSAidXAiICYmIHRoYXQuaXNMb2NrZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgby51dGlsLnJlcXVlc3RBbmltYXRpb24odGhhdC50aW1lcik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYoX3YgPCAoMCAtIHRoYXQubWF4VHJhbnNsYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2ID0gKDAgLSB0aGF0Lm1heFRyYW5zbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKF92ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB2ID0gMAogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHYgPSBfdjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYodiA8ICgwIC0gdGhhdC5oYWxmVHJhbnNsYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRvZ2dsZVN0eWxlKHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudG9nZ2xlU3R5bGUoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYodGhhdC5kcmFnRGlyZWN0aW9uID09ICJkb3duIiAmJiB0aGF0LmlzTG9ja2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKHRoYXQudGltZXIpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKF92ID4gdGhhdC5tYXhUcmFuc2xhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHRoYXQubWF4VHJhbnNsYXRlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihfdiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdiA9IDA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdiA9IF92OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZih2ID4gKHRoYXQuaGFsZlRyYW5zbGF0ZSArIHRoYXQuaGVpZ2h0KSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRvZ2dsZVN0eWxlKHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudG9nZ2xlU3R5bGUoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoYXQudXBkYXRlVHJhbnNsYXRlVih2KTsKICAgICAgICAgICAgICAgIHZhciBudmFsdWUgPSAidHJhbnNsYXRlM2QoMCwgIiArIHYgKyAicHgiICsgIiwgMCkiOwogICAgICAgICAgICAgICAgdGhhdC5jb250YWluZXIuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gbnZhbHVlOwogICAgICAgICAgICAgICAgby51dGlsLnJlcXVlc3RBbmltYXRpb24odGhhdC50aW1lcik7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKHRoaXMudGltZXIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCB0b2dnbGVTdHlsZQogICAgICAgICAqIEBwYXJhbSBjaGFuZ2Uge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5L+u5pS55pi+56S65Yy655qE5YaF5a65CiAgICAgICAgICovCiAgICAgICAgdG9nZ2xlU3R5bGU6IGZ1bmN0aW9uKGNoYW5nZSkgewogICAgICAgICAgICBpZihjaGFuZ2UgJiYgIW8uZG9tLmhhc0NsYXNzKHRoaXMuZWwsICJvY3RvcHVzdWktcmVmcmVzaC1jaGFuZ2VkIikpIHsKICAgICAgICAgICAgICAgIG8uZG9tLmFkZENsYXNzKHRoaXMuZWwsICJvY3RvcHVzdWktcmVmcmVzaC1jaGFuZ2VkIik7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVRleHQoImNoYW5nZVB1bGxUZXh0IiwgImNoYW5nZVN0YXR1c1RleHQiKTsKICAgICAgICAgICAgfSBlbHNlIGlmKCFjaGFuZ2UgJiYgby5kb20uaGFzQ2xhc3ModGhpcy5lbCwgIm9jdG9wdXN1aS1yZWZyZXNoLWNoYW5nZWQiKSkgewogICAgICAgICAgICAgICAgby5kb20ucmVtb3ZlQ2xhc3ModGhpcy5lbCwgIm9jdG9wdXN1aS1yZWZyZXNoLWNoYW5nZWQiKTsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVGV4dCgicHVsbFRleHQiLCAic3RhdHVzVGV4dCIpOwogICAgICAgICAgICAgICAgaWYodGhpcy5hcnJvdy5zdHlsZS5kaXNwbGF5ID09ICJub25lIikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXJyb3cuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaE1vdmUKICAgICAgICAgKiBAcGFyYW0gZQogICAgICAgICAqLwogICAgICAgIG9uVG91Y2hNb3ZlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciB0b3VjaGVzID0gZS50b3VjaGVzOwogICAgICAgICAgICBpZighdGhpcy5pc0RyYWcgfHwgIXRvdWNoZXMgfHwgdG91Y2hlcy5sZW5ndGggPiAxKSAgICByZXR1cm47CiAgICAgICAgICAgIHZhciB0b3VjaCA9IHRvdWNoZXNbMF07CgkJCWlmKHRoaXMucGFnZURyYWdUZW1wQyA9PSB0b3VjaC5wYWdlWSkJcmV0dXJuOwoJCQl0aGlzLnBhZ2VEcmFnVGVtcEMgPSB0b3VjaC5wYWdlWTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaEVuZAogICAgICAgICAqLwogICAgICAgIG9uVG91Y2hFbmQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy5pc0RyYWcgPSBmYWxzZTsKICAgICAgICAgICAgaWYodGhpcy50aW1lcikgewogICAgICAgICAgICAgICAgdGhpcy50aW1lciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5kaXJlY3Rpb24gPT0gInVwIikgewogICAgICAgICAgICAgICAgaWYodGhpcy50cmFuc2xhdGVWIDwgKDAgLSB0aGlzLmhhbGZUcmFuc2xhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkTW9yZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKCF0aGlzLmlzTG9ja2VkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZVBvc2l0aW9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZih0aGlzLnRyYW5zbGF0ZVYgPiAodGhpcy5oYWxmVHJhbnNsYXRlICsgdGhpcy5oZWlnaHQpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkTW9yZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKCF0aGlzLmlzTG9ja2VkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZVBvc2l0aW9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgbG9hZE1vcmUKICAgICAgICAgKi8KICAgICAgICBsb2FkTW9yZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaXNMb2NrZWQgPSB0cnVlOwogICAgICAgICAgICB2YXIgc3RhcnRWID0gInRyYW5zbGF0ZTNkKDAsICIgKyB0aGlzLnRyYW5zbGF0ZVYgKyAicHgsIDApIiwKICAgICAgICAgICAgICAgIGVuZFYsCiAgICAgICAgICAgICAgICB2OwogICAgICAgICAgICBpZih0aGlzLmRpcmVjdGlvbiA9PSAidXAiKSB7CiAgICAgICAgICAgICAgICBlbmRWID0gInRyYW5zbGF0ZTNkKDAsIDBweCwgMCkiOwogICAgICAgICAgICAgICAgdiA9IDA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmRWID0gInRyYW5zbGF0ZTNkKDAsICIgKyB0aGlzLmhlaWdodCArICJweCwgMCkiOwogICAgICAgICAgICAgICAgdiA9IHRoaXMuaGVpZ2h0OwogICAgICAgICAgICAgICAgdmFyIGRvbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHN0YXJ0ViA9PSBlbmRWKSAgcmV0dXJuOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHZhciBsaXN0VHdlZW4gPSBuZXcgby5Ud2Vlbih0aGlzLmNvbnRhaW5lciwgIi13ZWJraXQtdHJhbnNmb3JtIiwgc3RhcnRWLAogICAgICAgICAgICAgICAgZW5kViwgMC4zLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnVwZGF0ZVRyYW5zbGF0ZVYodik7CiAgICAgICAgICAgICAgICAgICAgdGhhdC51cGRhdGVUZXh0KCJsb2FkVGV4dCIpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuYXJyb3cuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRvZ2dsZUxvYWRpbmcodHJ1ZSk7CgkJCQkJdGhhdC5ub3RpZnkoInJlZnJlc2gtdWktbG9hZG1vcmUiKTsKICAgICAgICAgICAgICAgICAgICBpZihkb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChkb20pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsgZWFzZTogImVhc2UtaW4tb3V0IiB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgdXBkYXRlVGV4dAogICAgICAgICAqIEBwYXJhbSBwdCB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBzdCB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHVwZGF0ZVRleHQ6IGZ1bmN0aW9uKHB0LCBzdCkgewogICAgICAgICAgICB2YXIgZHIgPSB0aGlzLmRpcmVjdGlvbiwKICAgICAgICAgICAgICAgIGNvbmZpZyA9IG8uV2lkZ2V0LlJlZnJlc2guY29uZmlnOwogICAgICAgICAgICB0aGlzLnB1bGxUZXh0RG9tLmlubmVySFRNTCA9IG8udXRpbC5lbmNvZGVIdG1sKHRoaXNbcHRdIHx8IGNvbmZpZ1tkcl1bcHRdIHx8IGNvbmZpZ1twdF0pOwogICAgICAgICAgICBpZihzdCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0RG9tLmlubmVySFRNTCA9IG8udXRpbC5lbmNvZGVIdG1sKHRoaXNbc3RdIHx8IGNvbmZpZ1tzdF0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0RG9tLmlubmVySFRNTCA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHJlUG9zaXRpb24KICAgICAgICAgKi8KICAgICAgICByZVBvc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5pc0xvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgc3RhcnRWID0gInRyYW5zbGF0ZTNkKDAsICIgKyB0aGlzLnRyYW5zbGF0ZVYgKyAicHgsIDApIiwKICAgICAgICAgICAgICAgIGVuZFYgPSAidHJhbnNsYXRlM2QoMCwgMHB4LCAwKSIsCiAgICAgICAgICAgICAgICB2ID0gMDsKICAgICAgICAgICAgdGhpcy51cGRhdGVUcmFuc2xhdGVWKHYpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVRleHQoInB1bGxUZXh0IiwgInN0YXR1c1RleHQiKTsKICAgICAgICAgICAgdGhpcy50b2dnbGVTdHlsZShmYWxzZSk7CiAgICAgICAgICAgIHRoaXMudG9nZ2xlTG9hZGluZyhmYWxzZSk7CiAgICAgICAgICAgIGlmKHN0YXJ0ViA9PSBlbmRWKSAgcmV0dXJuOwogICAgICAgICAgICB2YXIgZm4gPSBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgIGlmKHRoaXMuZGlyZWN0aW9uID09ICJkb3duIikgewogICAgICAgICAgICAgICAgdmFyIGRvbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICAgICAgZm4gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGRvbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgbGlzdFR3ZWVuID0gbmV3IG8uVHdlZW4odGhpcy5jb250YWluZXIsICItd2Via2l0LXRyYW5zZm9ybSIsIHN0YXJ0ViwKICAgICAgICAgICAgICAgIGVuZFYsIDAuMywgZm4sIHsgZWFzZTogImVhc2UtaW4tb3V0IiB9KTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGFkanVzdEhhc1Njcm9sbEJhcgogICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufQogICAgICAgICAqLwogICAgICAgIGFkanVzdFNjcm9sbEJhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0cmFuc2xhdGUgPSB0aGlzLnRyYW5zbGF0ZVYsCiAgICAgICAgICAgICAgICBib2R5ID0gZG9jdW1lbnQuYm9keSwKICAgICAgICAgICAgICAgIHNjcm9sbEhlaWdodCA9IGJvZHkuc2Nyb2xsSGVpZ2h0LAogICAgICAgICAgICAgICAgaGVpZ2h0ID0gYm9keS5vZmZzZXRIZWlnaHQsCiAgICAgICAgICAgICAgICB0b3AgPSBib2R5LnNjcm9sbFRvcCwKICAgICAgICAgICAgICAgIF9oZWlnaHQgPSBoZWlnaHQgKyB0b3A7CiAgICAgICAgICAgIHJldHVybiAoTWF0aC5hYnModHJhbnNsYXRlKSA8PSB0aGlzLm1heFRyYW5zbGF0ZSAmJgogICAgICAgICAgICAgICAgKHRoaXMuZGlyZWN0aW9uID09ICJ1cCIgJiYgKF9oZWlnaHQgKyA1KSA+PSBzY3JvbGxIZWlnaHQpIHx8CiAgICAgICAgICAgICAgICAodGhpcy5kaXJlY3Rpb24gPT0gImRvd24iICYmIHRvcCA9PSAwKSk7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0LlJlZnJlc2giCiAgICB9KTsKCiAgICBvY3RvcHVzLldpZGdldC5SZWZyZXNoLmNvbmZpZyA9IHsKICAgICAgICAidXAiOiB7CiAgICAgICAgICAgIGFycm93QzogIm9jdG9wdXN1aS1yZWZyZXNoLWFycm93dXAiLAogICAgICAgICAgICBwdWxsVGV4dDogIuS4iuaLieWPr+S7peWKoOi9veabtOWkmiIKICAgICAgICB9LAogICAgICAgICJkb3duIjogewogICAgICAgICAgICBhcnJvd0M6ICJvY3RvcHVzdWktcmVmcmVzaC1hcnJvd2Rvd24iLAogICAgICAgICAgICBwdWxsVGV4dDogIuS4i+aLieWPr+S7peWKoOi9veabtOWkmiIKICAgICAgICB9LAogICAgICAgIHN0YXR1c1RleHQ6ICLkuIrmrKHmm7TmlrDml7bpl7TvvJoiLAogICAgICAgIGNoYW5nZVB1bGxUZXh0OiAi5p2+5omL5Y+v5Lul5Yqg6L295pu05aSaIiwKICAgICAgICBjaGFuZ2VTdGF0dXNUZXh0OiAiIiwKICAgICAgICBsb2FkVGV4dDogIuWKoOi9veS4rS4uLiIKICAgIH07Cgp9KShvY3RvcHVzKTsKLyoqCiAqIEBmaWxlCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKiB3ZWJhcHDpgJrnlKjnu4Tku7YKICogc2lkZWJhciAgIC0gICDlm5vkvqfpmpDol4/nmoTpnaLmnb8KICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEByZXF1aXJlIGxpYi9kb20uanMKICogQHJlcXVpcmUgbGliL2V2ZW50LmpzCiAqIEByZXF1aXJlIGxpYi90d2Vlbi5qcwogKiBAcmVxdWlyZSBsaWIvYW5pbWF0ZS5qcwogKiBAcmVxdWlyZSB3aWRnZXQvd2lkZ2V0LmpzCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLldpZGdldC5TaWRlYmFyCiAgICAgKiBAcGFyZW50IG9jdG9wdXMuV2lkZ2V0CiAgICAgKiBAZGVzYyDnlKjkuo7lnKjmjIflrprlrrnlmajlm5vkvqfnmoTpnaLmnb8KICAgICAqIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9IOS8oOWFpeeahOWPguaVsAogICAgICogQHBhcmFtIG9wdGlvbnMudHlwZSB7U3RyaW5nfSDpu5jorqTnmoTlsZXnjrDnmoTnsbvlnosg5Y+v6YCJ5YC85YyF5ousIGNvdmVyIHwgcHVzaCB8IHJldmVhbCB8IHJvdGF0ZSDlhbbkuK1yb3RhdGXlnKjkvY7niYjmnKzns7vnu5/kuIp3b3Jr55qE5LiN5aW9CiAgICAgKiBAcGFyYW0gb3B0aW9ucy5uZXh0RG9tIHtET01FbGVtZW50fSDkuI7kuYvlubbliJfnmoToioLngrkg5Y2z5Y+v6KeG5Yy65Z+f5pi+56S655qE5Yy65Z+f6IqC54K5IOWmguaenOexu+Wei+S4unJldmVhbOWImeatpOWPguaVsOS4jeWPr+epuue8ugogICAgICogQHBhcmFtIG9wdGlvbnMucG9zaXRpb24ge1N0cmluZ30g5o6n5Lu26LS06L6555qE5L2N572uIOWPr+mAieWAvOWMheaLrCBsZWZ0IHwgcmlnaHQgfCB0b3AgfCBib3R0b20g6buY6K6k5Li6bGVmdCDkuIDnu4/orr7nva7kuI3lj6/mm7TmlLkKICAgICAqIEBwYXJhbSBvcHRpb25zLndpZHRoIHtOdW1iZXJ9IOaOp+S7tueahOWuveW6piDlj6/kvKDmlbDlrZcg5Y2V5L2N5YOP57SgIOS6puWPr+S8oOWtl+espuS4suW9ouW8j+eahOWPr+abv+S7o+WuveW6pueahOihqOi+viDlpoIxMDAlIOm7mOiupOS4ujEwMCUKICAgICAqIEBwYXJhbSBvcHRpb25zLmhlaWdodCB7TnVtYmVyfSDlkIzpq5jluqYKICAgICAqIEBwYXJhbSBvcHRpb25zLmlubmVySFRNTCB7U3RyaW5nfSDlj6/ku6XkvKDlhaXnmoTmjqfku7bnmoRodG1s5YaF5a65CiAgICAgKi8KICAgIG8uV2lkZ2V0LlNpZGViYXIgPSBvLmRlZmluZShvLldpZGdldCwgewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB0eXBlCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDlsZXnjrDnmoTnsbvlnosKICAgICAgICAgKi8KICAgICAgICB0eXBlOiAiY292ZXIiLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBuZXh0RG9tCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICogQGRlc2Mg5p+Q5Lqb57G75Z6L6ZyA6KaB5Lyg5YWl5bm25YiX5pi+56S655qE6IqC54K5CiAgICAgICAgICovCiAgICAgICAgbmV4dERvbTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgcG9zaXRpb24KICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOaOp+S7tui0tOi+ueeahOaWueS9jQogICAgICAgICAqLwogICAgICAgIHBvc2l0aW9uOiAibGVmdCIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHdpZHRoCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDlrrnlmajnmoTlrr3luqYg5LiN5bu66K6u5L+u5pS5CiAgICAgICAgICovCiAgICAgICAgd2lkdGg6ICIxMDAlIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaGVpZ2h0CiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDlrrnlmajnmoTpq5jluqYKICAgICAgICAgKi8KICAgICAgICBoZWlnaHQ6ICIxMDAlIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc3R5bGVzCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKiBAZGVzYyDnlKjmnaXlrZjlj5bkuIDkupvliJ3lp4vmoLflvI/nmoTplK7lgLzlr7kKICAgICAgICAgKi8KICAgICAgICBzdHlsZXM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlubmVySFRNTAogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5o6n5Lu255qE5YaF5a65IOW9k+aOp+S7tuaehOaIkOeugOWNleaXtuWPr+S7peebtOaOpeS8oOWFpSDlpI3mnYLml7blu7rorq7nu6fmib/mraTmjqfku7blvIDlj5EKICAgICAgICAgKi8KICAgICAgICBpbm5lckhUTUw6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzUmVzaXplCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOeUqOS7pXJlc2l6ZQogICAgICAgICAqLwogICAgICAgIGlzUmVzaXplOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbG9ja2VkCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgbG9ja2VkOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgaWYodGhpcy5pbm5lckhUTUwpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWwuaW5uZXJIVE1MID0gdGhpcy5pbm5lckhUTUw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zdHlsZXMgPSB7CiAgICAgICAgICAgICAgICBjc3NUZXh0OiB7CiAgICAgICAgICAgICAgICAgICAgbGVmdDogImxlZnQ6IDBweDsgdG9wOiAwcHg7IiwKICAgICAgICAgICAgICAgICAgICByaWdodDogInJpZ2h0OiAwcHg7IHRvcDogMHB4OyIsCiAgICAgICAgICAgICAgICAgICAgdG9wOiAibGVmdDogMHB4OyB0b3A6IDBweDsiLAogICAgICAgICAgICAgICAgICAgIGJvdHRvbTogImxlZnQ6IDBweDsgYm90dG9tOiAwcHg7IgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogewogICAgICAgICAgICAgICAgICAgIGxlZnQ6ICJ0cmFuc2xhdGUzZCgtMTAwJSwgMCwgMCkiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAidHJhbnNsYXRlM2QoMTAwJSwgMCwgMCkiLAogICAgICAgICAgICAgICAgICAgIHRvcDogInRyYW5zbGF0ZTNkKDAsIC0xMDAlLCAwKSIsCiAgICAgICAgICAgICAgICAgICAgYm90dG9tOiAidHJhbnNsYXRlM2QoMCwgMTAwJSwgMCkiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmKG8udXRpbC5pc051bWVyaWModGhpcy53aWR0aCkpIHsKICAgICAgICAgICAgICAgIHRoaXMud2lkdGggKz0gInB4IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvLnV0aWwuaXNOdW1lcmljKHRoaXMuaGVpZ2h0KSkgewogICAgICAgICAgICAgICAgdGhpcy5oZWlnaHQgKz0gInB4IjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLmNzc1RleHQgPSB0aGlzLnN0eWxlcy5jc3NUZXh0W3RoaXMucG9zaXRpb25dICsgIiB3aWR0aDogIiArIHRoaXMud2lkdGggKyAiOyBoZWlnaHQ6ICIgKyB0aGlzLmhlaWdodCArCiAgICAgICAgICAgICAgICAiOyAtd2Via2l0LXRyYW5zZm9ybS1zdHlsZTogcHJlc2VydmUtM2Q7IHRyYW5zZm9ybS1zdHlsZTogcHJlc2VydmUtM2Q7IjsKICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModGhpcy5lbCwgIm9jdG9wdXN1aS1zaWRlYmFyIik7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgby5ldmVudC5vbih3aW5kb3csICJvcnRjaGFuZ2UiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LmlzUmVzaXplKSB7CiAgICAgICAgICAgICAgICAgICAgby51dGlsLnJlcXVlc3RBbmltYXRpb24oby51dGlsLmJpbmQodGhhdC5jaGVja1NpemUsIHRoYXQpKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LmlzUmVzaXplID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZmFsc2UpOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgY2hlY2tTaXplCiAgICAgICAgICogQGRlc2Mg55So5Lul55uR5ZCscmVzaXpl5LqL5Lu255qE5aSE55CGCiAgICAgICAgICovCiAgICAgICAgY2hlY2tTaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYWxjU2VsZlNpemUoKTsKICAgICAgICAgICAgdGhpcy5pc1Jlc2l6ZSA9IGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlNpZGViYXIuc2hvdwogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOWPr+S7pemAieaLqeS9leenjeaooeW8j+iuqeaOp+S7tuaYvuekuuWHuuadpQogICAgICAgICAqLwogICAgICAgIHNob3c6IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICAgICAgaWYodGhpcy5pc1Nob3cpIHJldHVybjsKICAgICAgICAgICAgaWYodGhpcy50eXBlICE9IHR5cGUpIHsKICAgICAgICAgICAgICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICB0aGlzLnNlcmlhbENTUygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgICAgIHRoaXMuY2FsY1NlbGZTaXplKCk7CiAgICAgICAgICAgIHRoaXNbImFuaW1hdGUiICsgdGhpcy50eXBlLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgdGhpcy50eXBlLnN1YnN0cmluZygxKV0odHJ1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuU2lkZWJhci5oaWRkZW4KICAgICAgICAgKiBAZGVzYyDpmpDol4/mjqfku7YKICAgICAgICAgKi8KICAgICAgICBoaWRkZW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZighdGhpcy5pc1Nob3cpICAgIHJldHVybjsKICAgICAgICAgICAgdGhpc1siYW5pbWF0ZSIgKyB0aGlzLnR5cGUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB0aGlzLnR5cGUuc3Vic3RyaW5nKDEpXShmYWxzZSk7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBhbmltYXRlCiAgICAgICAgICogQGRlc2Mg5Yeg5Liq566A5Y2V5Yqo55S755qE5YWx5pyJ6YOo5YiGCiAgICAgICAgICogQHBhcmFtIHN2cyB7U3RyaW5nfSDliqjnlLvnmoTlvIDlp4vlgLwKICAgICAgICAgKiBAcGFyYW0gZXZzIHtTdHJpbmd9IOWKqOeUu+eahOe7k+adn+WAvAogICAgICAgICAqIEBwYXJhbSB0IHtCb29sZWFufSDmoIflv5fnnYDmraTliqjnlLvmmK/mmL7npLov6ZqQ6JeP5pe26LCD55SoCiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fSDmiafooYzliqjnlLvnmoToioLngrkKICAgICAgICAgKiBAcmV0dXJucyB7by5Ud2Vlbn0KICAgICAgICAgKi8KICAgICAgICBhbmltYXRlOiBmdW5jdGlvbihzdnMsIGV2cywgdCwgZWwpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcG4gPSB0aGlzLmNvbnRhaW5lci5wYXJlbnROb2RlIHx8IHRoaXMuY29udGFpbmVyOwogICAgICAgICAgICBwbi5zdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwogICAgICAgICAgICB0aGlzLmxvY2tlZCA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiBuZXcgby5Ud2VlbihlbCwgWyItd2Via2l0LXRyYW5zZm9ybSJdLCBbc3ZzXSwgW2V2c10sIC4zLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoYXQuaXNTaG93ID0gdDsKICAgICAgICAgICAgICAgIGlmKHQgJiYgKHRoYXQucG9zaXRpb24gPT0gInJpZ2h0IiB8fCB0aGF0LnBvc2l0aW9uID09ICJib3R0b20iKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBkb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuY29udGFpbmVyLmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1lID0gdGhhdDsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBtZS5jb250YWluZXIucmVtb3ZlQ2hpbGQoZG9tKTsKICAgICAgICAgICAgICAgICAgICAgICAgZG9tID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZighdCkgewogICAgICAgICAgICAgICAgICAgIHRoYXQuZWwuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBuLnN0eWxlLm92ZXJmbG93ID0gIiI7CiAgICAgICAgICAgICAgICB0aGF0LmxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYW5pbWF0ZVJvdGF0ZQogICAgICAgICAqIEBwYXJhbSB0CiAgICAgICAgICovCiAgICAgICAgYW5pbWF0ZVJvdGF0ZTogZnVuY3Rpb24odCkgewogICAgICAgICAgICB2YXIgc3ZvcHRpb25zID0gewogICAgICAgICAgICAgICAgICAgICJsZWZ0IjogInRyYW5zbGF0ZTNkKC0xMDAlLCAwLCAwKSByb3RhdGVZKC05MGRlZykiLAogICAgICAgICAgICAgICAgICAgICJyaWdodCI6ICJ0cmFuc2xhdGUzZCgxMDAlLCAwLCAwKSByb3RhdGVZKDkwZGVnKSIsCiAgICAgICAgICAgICAgICAgICAgInRvcCI6ICJ0cmFuc2xhdGUzZCgwLCAtMTAwJSwgMCkgcm90YXRlWCgxMjBkZWcpIiwKICAgICAgICAgICAgICAgICAgICAiYm90dG9tIjogInRyYW5zbGF0ZTNkKDAsIDEwMCUsIDApIHJvdGF0ZVgoLTEyMGRlZykiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZXZzID0gInRyYW5zbGF0ZTNkKDAsIDAsIDApIHJvdGF0ZVkoMGRlZykgcm90YXRlWCgwZGVnKSIsCiAgICAgICAgICAgICAgICBzdnMgPSB0ID8gc3ZvcHRpb25zW3RoaXMucG9zaXRpb25dIDogZXZzOwogICAgICAgICAgICBpZighdCkgewogICAgICAgICAgICAgICAgZXZzID0gc3ZvcHRpb25zW3RoaXMucG9zaXRpb25dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBvciA9IHsKICAgICAgICAgICAgICAgIGxlZnQ6ICIxMDAlIDUwJSIsCiAgICAgICAgICAgICAgICByaWdodDogIjAlIDUwJSIsCiAgICAgICAgICAgICAgICB0b3A6ICI1MCUgMTAwJSIsCiAgICAgICAgICAgICAgICBib3R0b206ICI1MCUgMCUiCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS53ZWJraXRUcmFuc2Zvcm1PcmlnaW4gPSBvclt0aGlzLnBvc2l0aW9uXTsKICAgICAgICAgICAgdGhpcy5hbmltYXRlUmV2ZWFsKHQpOwogICAgICAgICAgICB0aGlzLmFuaW1hdGUoc3ZzLCBldnMsIHQsIHRoaXMuZWwpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBhbmltYXRlQ292ZXIKICAgICAgICAgKiBAZGVzYyB0eXBl5Li6Y292ZXLml7bnmoTliqjnlLsKICAgICAgICAgKiBAcGFyYW0gdCB7Qm9vbGVhbn0g5qCH5b+X5L2NIOagh+W/l+aYvuekuuaIlumakOiXjwogICAgICAgICAqLwogICAgICAgIGFuaW1hdGVDb3ZlcjogZnVuY3Rpb24odCkgewogICAgICAgICAgICB2YXIgc3ZvcHRpb25zID0gewogICAgICAgICAgICAgICAgICAgICJsZWZ0IjogInRyYW5zbGF0ZTNkKC0xMDAlLCAwLCAwKSIsCiAgICAgICAgICAgICAgICAgICAgInJpZ2h0IjogInRyYW5zbGF0ZTNkKDEwMCUsIDAsIDApIiwKICAgICAgICAgICAgICAgICAgICAidG9wIjogInRyYW5zbGF0ZTNkKDAsIC0xMDAlLCAwKSIsCiAgICAgICAgICAgICAgICAgICAgImJvdHRvbSI6ICJ0cmFuc2xhdGUzZCgwLCAxMDAlLCAwKSIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBldnMgPSAidHJhbnNsYXRlM2QoMCwgMCwgMCkiLAogICAgICAgICAgICAgICAgc3ZzID0gdCA/IHN2b3B0aW9uc1t0aGlzLnBvc2l0aW9uXSA6IGV2czsKICAgICAgICAgICAgaWYoIXQpIHsKICAgICAgICAgICAgICAgIGV2cyA9IHN2b3B0aW9uc1t0aGlzLnBvc2l0aW9uXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFuaW1hdGUoc3ZzLCBldnMsIHQsIHRoaXMuZWwpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBhbmltYXRlUHVzaAogICAgICAgICAqIEBwYXJhbSB0CiAgICAgICAgICovCiAgICAgICAgYW5pbWF0ZVB1c2g6IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgdmFyIHN2b3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgICAgICAibGVmdCI6ICJ0cmFuc2xhdGUzZCgiICsgdGhpcy53aWR0aCArICIsIDAsIDApIiwKICAgICAgICAgICAgICAgICAgICAicmlnaHQiOiAidHJhbnNsYXRlM2QoLSIgKyB0aGlzLndpZHRoICsgIiwgMCwgMCkiLAogICAgICAgICAgICAgICAgICAgICJ0b3AiOiAidHJhbnNsYXRlM2QoMCwgIiArIHRoaXMuaGVpZ2h0ICsgIiwgMCkiLAogICAgICAgICAgICAgICAgICAgICJib3R0b20iOiAidHJhbnNsYXRlM2QoMCwgLSIgKyB0aGlzLmhlaWdodCArICIsIDApIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHN2cyA9ICJ0cmFuc2xhdGUzZCgwLCAwLCAwKSIsCiAgICAgICAgICAgICAgICBldnMgPSB0ID8gc3ZvcHRpb25zW3RoaXMucG9zaXRpb25dIDogc3ZzOwogICAgICAgICAgICBpZighdCkgewogICAgICAgICAgICAgICAgc3ZzID0gc3ZvcHRpb25zW3RoaXMucG9zaXRpb25dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZShzdnMsIGV2cywgdCwgdGhpcy5jb250YWluZXIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBhbmltYXRlUmV2ZWFsCiAgICAgICAgICogQHBhcmFtIHQKICAgICAgICAgKi8KICAgICAgICBhbmltYXRlUmV2ZWFsOiBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgIHRoaXMubmV4dERvbSA9IG8uZyh0aGlzLm5leHREb20pOwogICAgICAgICAgICBpZighdGhpcy5uZXh0RG9tKSAgIHRocm93IG5ldyBFcnJvcigicmVxdWlyZSBuZXh0RG9tIHRvIHJldmVhbCEiKTsKICAgICAgICAgICAgdmFyIHN2b3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgICAgICAibGVmdCI6ICJ0cmFuc2xhdGUzZCgiICsgdGhpcy53aWR0aCArICIsIDAsIDApIiwKICAgICAgICAgICAgICAgICAgICAicmlnaHQiOiAidHJhbnNsYXRlM2QoLSIgKyB0aGlzLndpZHRoICsgIiwgMCwgMCkiLAogICAgICAgICAgICAgICAgICAgICJ0b3AiOiAidHJhbnNsYXRlM2QoMCwgIiArIHRoaXMuaGVpZ2h0ICsgIiwgMCkiLAogICAgICAgICAgICAgICAgICAgICJib3R0b20iOiAidHJhbnNsYXRlM2QoMCwgLSIgKyB0aGlzLmhlaWdodCArICIsIDApIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHN2cyA9ICJ0cmFuc2xhdGUzZCgwLCAwLCAwKSIsCiAgICAgICAgICAgICAgICBldnMgPSB0ID8gc3ZvcHRpb25zW3RoaXMucG9zaXRpb25dIDogc3ZzOwogICAgICAgICAgICBpZighdCkgewogICAgICAgICAgICAgICAgc3ZzID0gc3ZvcHRpb25zW3RoaXMucG9zaXRpb25dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZShzdnMsIGV2cywgdCwgdGhpcy5uZXh0RG9tKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2VyaWFsQ1NTCiAgICAgICAgICogQGRlc2Mg55So5p2l5YiH5o2i5LiN5ZCM5qih5byP5LiL6IqC54K55bqU5YyF5ous55qE5qC35byPCiAgICAgICAgICovCiAgICAgICAgc2VyaWFsQ1NTOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy50eXBlID09ICJjb3ZlciIgfHwgdGhpcy50eXBlID09ICJwdXNoIikgewogICAgICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSB0aGlzLnN0eWxlcy50cmFuc2Zvcm1bdGhpcy5wb3NpdGlvbl07CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlLnpJbmRleCA9IDk5OTk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9ICIiOwogICAgICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS56SW5kZXggPSAtMTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBhY3RpdmF0ZQogICAgICAgICAqIEBkZXNjIOWkjeWGmeS6hueItuexu+eahOa/gOa0u+aWueazlQogICAgICAgICAqLwogICAgICAgIGFjdGl2YXRlOiBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgICAgIG8uV2lkZ2V0LnByb3RvdHlwZS5hY3RpdmF0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB2YXIgcG9zID0gby5kb20uZ2V0U3R5bGUodGhpcy5jb250YWluZXIsICJwb3NpdGlvbiIpOwogICAgICAgICAgICBpZihwb3MgPT0gInN0YXRpYyIpIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnR5cGUgPSB0eXBlIHx8IHRoaXMudHlwZTsKICAgICAgICAgICAgdGhpcy5zZXJpYWxDU1MoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5TaWRlYmFyLnJlbmRlcgogICAgICAgICAqIEBkZXNjIOWkjeWGmeS6hueItuexu+eahHJlbmRlcuaWueazlQogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICAgICAgICBpZihsZW4gPT0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSB0aGlzLmNvbnRhaW5lciB8fCBkb2N1bWVudC5ib2R5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBvLmcoYXJndW1lbnRzWzBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh0aGlzLmNvbnRhaW5lciwgIm9jdG9wdXN1aS1zaWRlYmFyLWNvbnRhaW5lciIpOwogICAgICAgICAgICBpZih0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIklsbGVnYWwgRG9tISIpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZighIWFyZ3VtZW50c1sxXSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjbG9uZW5vZGUgPSBvLmRvbS5jbG9uZU5vZGUodGhpcy5jb250YWluZXIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQodGhpcy5lbCwgY2xvbmVub2RlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChjbG9uZW5vZGUsIHRoaXMuY29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGNsb25lbm9kZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZCh0aGlzLmVsLCB0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXRoaXMuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2YXRlKGFyZ3VtZW50c1syXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXRoaXMuaXNTaG93KSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3coYXJndW1lbnRzWzJdKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjYWxjU2VsZlNpemUKICAgICAgICAgKiBAZGVzYyDkuLrpgqPkupvmsqHmnInkuKrlhbfkvZPmlbDlgLzlrr3pq5jnmoTmjqfku7blgZrmn5DkupvliqjnlLvml7bojrflj5blhbfkvZPnmoTmlbDlgLwKICAgICAgICAgKi8KICAgICAgICBjYWxjU2VsZlNpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcG9zID0gdGhpcy5wb3NpdGlvbiwKICAgICAgICAgICAgICAgIHBybyA9IChwb3MgPT0gImxlZnQiIHx8IHBvcyA9PSAicmlnaHQiKSA/ICJ3aWR0aCIgOiAiaGVpZ2h0IjsKICAgICAgICAgICAgdGhpc1twcm9dID0gby5kb21bImdldCIgKyBwcm8uY2hhckF0KDApLnRvTG9jYWxlVXBwZXJDYXNlKCkgKyBwcm8uc3Vic3RyaW5nKDEpXSh0aGlzLmVsKSArICJweCI7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0LlNpZGViYXIiCiAgICB9KTsKCn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICogd2ViYXBw6YCa55So57uE5Lu2CiAqIHNsaWRlciAgIC0gICDova7mkq3lm74KICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEByZXF1aXJlIGxpYi9kb20uanMKICogQHJlcXVpcmUgbGliL2V2ZW50LmpzCiAqIEByZXF1aXJlIGxpYi90d2Vlbi5qcwogKiBAcmVxdWlyZSBsaWIvYW5pbWF0ZS5qcwogKiBAcmVxdWlyZSB3aWRnZXQvd2lkZ2V0LmpzCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLldpZGdldC5TbGlkZXIKICAgICAqIEBwYXJlbnQgb2N0b3B1cy5XaWRnZXQKICAgICAqIEBkZXNjIOi9ruaSreWbvuaIlui9ruaSreiKgueCuQogICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0g5Y+C5pWwCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5kYXRhIHtBcnJheX0g6L2u5pKt5Zu+55qE5Zu+54mH5pWw5o2uIOWmguaenOaMh+WumuS6hmNoaWxkcmVu5bGe5oCnIOWImeatpOWPguaVsOWkseaViAogICAgICogQHBhcmFtIG9wdGlvbnMuY2hpbGRyZW4ge0FycmF5fSDpnIDopoHov5vooYzova7mkq3nmoToioLngrkKICAgICAqIEBwYXJhbSBvcHRpb25zLndpZHRoIHtOdW1iZXJ9IOi9ruaSreeahOWuveW6piDlu7rorq7liJ3lp4vljJbotYvlgLwg5Y+v5Lul55yB5o6J5LiA5qyh6I635Y+W5a695bqm55qEcmVwYWludAogICAgICogQHBhcmFtIG9wdGlvbnMuaGVpZ2h0IHtOdW1iZXJ9IOi9ruaSreeahOmrmOW6piDlu7rorq7liJ3lp4vljJbotYvlgLwKICAgICAqIEBwYXJhbSBvcHRpb25zLmRhdGFGaWVsZCB7T2JqZWN0fSDlm77niYfmqKHlvI/kuIsg5pWw5o2u55qE6Kej5p6Q5YC8IOm7mOiupOS4unsgdGl0bGU6ICJ0aXRsZSIsIHVybDogInVybCIsIGltYWdlX3VybDogImltYWdlX3VybCIgfQogICAgICogQHBhcmFtIG9wdGlvbnMuaXNMb24ge0Jvb2xlYW59IOaYr+WQpue6teWQkei9ruaSrSB0cnVl5Li657q15ZCRIOWQpuWImeS4uuaoquWQkSDpu5jorqRmYWxzZQogICAgICogQHBhcmFtIG9wdGlvbnMuaXNOZXdUYWIge0Jvb2xlYW59IOW9k+eCueWHu+i9ruaSreWbvueahOihjOS4uuS4uum7mOiupOihjOS4uui3s+i9rOaXtueUn+aViCB0cnVl5Li65paw56qX5Y+j5omT5byAIGZhbHNl5Zyo5Y6f56qX5Y+j5omT5byAIOm7mOiupHRydWUKICAgICAqIEBwYXJhbSBvcHRpb25zLmF1dG9QbGF5IHtCb29sZWFufSDmmK/lkKbnlJ/miJDlkI7ov5vooYzliqjnlLsg6buY6K6k5Li6dHJ1ZQogICAgICogQHBhcmFtIG9wdGlvbnMuYXV0b1BsYXlUaW1lIHtOdW1iZXJ9IOi9ruaSreWbvuWKqOeUu+aXtueahOWBnOeVmeaXtumXtCDljZXkvY1tcyDpu5jorqTkuLo0MDAwbXMKICAgICAqIEBwYXJhbSBvcHRpb25zLmFuaW1hdGlvblRpbWUge051bWJlcn0g6L2u5pKt5Zu+5Y2V5qyh5Yqo55S76L+Q6KGM5pe26Ze0IOWNleS9jW1zIOm7mOiupOS4ujQwMG1zCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5hbmltYXRpb25UeXBlIHtTdHJpbmd9IOi9ruaSreWbvueahOWKqOWMluexu+WeiyDpu5jorqTkuLoiZWFzZS1vdXQiCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5sb29wIHtCb29sZWFufSDmmK/lkKbmmK/lvqrnjq/ova7mkq0g6buY6K6k5Li6dHJ1ZQogICAgICogQHBhcmFtIG9wdGlvbnMuaGFzVGl0bGUge0Jvb2xlYW59IOaYr+WQpuaciei9ruaSreWbvuS4i+aWueeahHRpdGxl5Yy65Z+fCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5oYXNHaXptb3Mge0Jvb2xlYW59IOaYr+WQpuaciei9ruaSreWbvuS4i+aWueeahOmAieaLqeWMuuWfnwogICAgICogQHBhcmFtIG9wdGlvbnMuZGlzU2Nyb2xsIHtCb29sZWFufSDmmK/lkKbpmLvmraLmu5rliqjmnaEKICAgICAqLwogICAgby5XaWRnZXQuU2xpZGVyID0gby5kZWZpbmUoby5XaWRnZXQsIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGF0YQogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAZGVzYyDmjqfku7bnmoTmlbDmja4g5aaC5p6c6Z2e5Zu+54mH57G75Z6L55qE6L2u5pKtIOatpOWPguaVsOWkseaViAogICAgICAgICAqLwogICAgICAgIGRhdGE6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHdpZHRoCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmr4/pobXova7mkq3nmoTlrr3luqYKICAgICAgICAgKi8KICAgICAgICB3aWR0aDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaGVpZ2h0CiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmr4/pobXova7mkq3nmoTpq5jluqYKICAgICAgICAgKi8KICAgICAgICBoZWlnaHQ6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNoaWxkcmVuCiAgICAgICAgICogQHR5cGUge0FycmF5IHwgRE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDphY3nva7nmoToioLngrnova7mkq0g5YiZ5Zu+54mH6L2u5pKt6YWN572u5aSx5pWICiAgICAgICAgICovCiAgICAgICAgY2hpbGRyZW46IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGRvbXMKICAgICAgICAgKiBAdHlwZSB7QXJyYXkgfCBET01FbGVtZW50fQogICAgICAgICAqIEBkZXNjIOi9ruaSreWbvuS4rei9ruaSreiKgueCueeahOmbhuWQiAogICAgICAgICAqLwogICAgICAgIGRvbXM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGxlbmd0aAogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg6L2u5pKt55qE6ZW/5bqmCiAgICAgICAgICovCiAgICAgICAgbGVuZ3RoOiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBfdHlwZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOagh+W/l+aYr+WbvueJh+i9ruaSrei/mOaYr+iKgueCuei9ruaSrSAiaW1nIiB8fCAiZG9tIgogICAgICAgICAqLwogICAgICAgIF90eXBlOiAiaW1nIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGF0YUZpbGVkCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKiBAZGVzYyDlm77niYfmqKHlvI/kuIvmlbDmja7nmoTor7vlj5ZrZXkKICAgICAgICAgKi8KICAgICAgICBkYXRhRmllbGQ6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHZpZXdEaXYKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDova7mkq3nmoTovb3kvZMKICAgICAgICAgKi8KICAgICAgICB2aWV3RGl2OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc0xvbgogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOaYr+WQpue6teWQkei9ruaSrQogICAgICAgICAqLwogICAgICAgIGlzTG9uOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNOZXdUYWIKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDphY3nva7pobkg5piv5ZCm54K55Ye75ZCO5paw56qX5Y+j5omT5byACiAgICAgICAgICovCiAgICAgICAgaXNOZXdUYWI6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzRGlzYWJsZUEKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDphY3nva7pobkg5piv5ZCm6Ieq5a6a5LmJ54K55Ye75LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgaXNEaXNhYmxlQTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGN1cnJlbnQKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqIEBkZXNjIOW9k+WJjemAieaLqeeahOiKgueCueS7peWPimluZGV45L+h5oGvCiAgICAgICAgICovCiAgICAgICAgY3VycmVudDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbG9hZEltYWdlTnVtYmVyCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDpu5jorqTkuIDmrKHmi4nlj5bnmoTlm77niYfkuKrmlbAg5Li66LSf5pWw6KGo56S65LiA5qyh5ouJ5Y+W5a6M5q+VCiAgICAgICAgICovCiAgICAgICAgbG9hZEltYWdlTnVtYmVyOiA0LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB0aW1lcgogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg6L2u5pKt55qEdGltZXIKICAgICAgICAgKi8KICAgICAgICB0aW1lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYXV0b1BsYXlUaW1lCiAgICAgICAgICogQGRlc2Mg6L2u5pKt5Zu+55WZ55qE5pe26Ze0CiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKi8KICAgICAgICBhdXRvUGxheVRpbWU6IDQwMDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFuaW1hdGlvblRpbWUKICAgICAgICAgKiBAZGVzYyDova7mkq3pgJ/luqYKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGFuaW1hdGlvblRpbWU6IDQwMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYW5pbWF0aW9uVHlwZQogICAgICAgICAqIEBkZXNjIOi9ruaSreWbvueahOWKqOeUu+exu+WeiwogICAgICAgICAqLwogICAgICAgIGFuaW1hdGlvblR5cGU6ICJlYXNlLW91dCIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGRpc2FibGVBbGwKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBkaXNhYmxlQWxsOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGlzU2Nyb2xsCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5piv5ZCm5YGc5o6J5rua5Yqo5LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgZGlzU2Nyb2xsOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbG9vcAogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOaYr+WQpuW+queOr+i9ruaSrQogICAgICAgICAqLwogICAgICAgIGxvb3A6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGF1dG9QbGF5CiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5piv5ZCm6Ieq5Yqo5pKt5pS+IOiuvue9ruS4umZhbHNl5pe277yM6ZyA6KaB5omL5Yqo5omT5byACiAgICAgICAgICovCiAgICAgICAgYXV0b1BsYXk6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGhhc0J1dHRvbgogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOaYr+WQpuacieW3puWPs+S4pOS+p+eahGJ1dHRvbgogICAgICAgICAqLwogICAgICAgIGhhc0J1dHRvbjogdHJ1ZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaGFzVGl0bGUKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDmmK/lkKblhbfmnInkuIvkvqfnmoR0aXRsZeWMuuWfnwogICAgICAgICAqLwogICAgICAgIGhhc1RpdGxlOiB0cnVlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBoYXNHaXptb3MKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDmmK/lkKblhbfmnInkuIvkvqfnmoTpgInmi6nljLrln58KICAgICAgICAgKi8KICAgICAgICBoYXNHaXptb3M6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHByZURvbQogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqIEBkZXNjIOS4iuS4gOW8oAogICAgICAgICAqLwogICAgICAgIHByZURvbTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbmV4dERvbQogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqIEBkZXNjIOS4i+S4gOW8oAogICAgICAgICAqLwogICAgICAgIG5leHREb206IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGN1cnJlbnRHaXptb3MKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDlvZPliY3nmoTlsI/njqnmhI8KICAgICAgICAgKi8KICAgICAgICBjdXJyZW50R2l6bW9zOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBnaXptb3NEb21zCiAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAqIEBkZXNjIOmAieaLqeWZqOiKgueCueeahOaVsOe7hAogICAgICAgICAqLwogICAgICAgIGdpem1vc0RvbXM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzU2xpZGUKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDmoIflv5fkvY0g5qCH5b+X5piv5ZCm5q2j5Zyo6L2u5pKtCiAgICAgICAgICovCiAgICAgICAgaXNTbGlkZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzRHJhZwogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOagh+W/l+S9jSDmoIflv5fmmK/lkKblpITkuo7mi5bmi73nirbmgIEKICAgICAgICAgKi8KICAgICAgICBpc0RyYWc6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1RpbWVyCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOS4gOS6m+aJi+acuuaXoOazleS9v+eUqHJlbW92ZUV2ZW50TGlzdGVuZXLljrvmjonkuovku7Yg5a+86Ie0dHJhbnNpdGlvbkVuZOS6i+S7tue7keS4iuWQjuaXoOazleWNuOi9vSDlm6DmraTkvb/nlKjmoIflv5fkvY3op6PlhrMKICAgICAgICAgKi8KICAgICAgICBpc1RpbWVyOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgcGFnZURyYWdDCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmi5bmi73ngrkg5qiq5ZCR5LiO57q15ZCR5YiG5Yir5a+55bqUeOS4jnkKICAgICAgICAgKi8KICAgICAgICBwYWdlRHJhZ1N0YXJ0QzogMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgcGFnZURyYWdEb3duCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmi5bmi73nu5PmnZ/ngrkKICAgICAgICAgKi8KICAgICAgICBwYWdlRHJhZ0VuZEM6IDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHBhZ2VEcmFnVGVtcEMKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOS4remXtOaLluaLveeCuQogICAgICAgICAqLwogICAgICAgIHBhZ2VEcmFnVGVtcEM6IDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHBhZ2VEcmFnRGlyZWN0aW9uCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5ouW5ou955qE5pa55ZCRIHRydWXkuLrmraPlkJEgZmFsc2XkuLrmraPmlrnlkJEKICAgICAgICAgKi8KICAgICAgICBwYWdlRHJhZ0RpcmVjdGlvbjogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGRyYWd0aW1lcgogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg5ouW5ou95pe255qEdGltZXIKICAgICAgICAgKi8KICAgICAgICBkcmFndGltZXI6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHRyYW5zbGF0ZVZhbHVlCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDova7mkq3nmoTkvY3nva4KICAgICAgICAgKi8KICAgICAgICB0cmFuc2xhdGVWYWx1ZTogMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY2hhbmdlRGlzCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmi5bmi73mlLnlj5jnmoTot53nprsKICAgICAgICAgKi8KICAgICAgICBjaGFuZ2VEaXM6IDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHNwcmluZ0JhY2tEaXMKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHNwcmluZ0JhY2tEaXM6IDEwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBldmVudFRpbWVyCiAgICAgICAgICovCiAgICAgICAgZXZlbnRUaW1lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgdW5sb2FkSW1hZ2UKICAgICAgICAgKi8KICAgICAgICB1bmxvYWRJbWFnZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgdG91Y2hTdGFydFBpeGVsWAogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgdG91Y2hTdGFydFBpeGVsWDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgdG91Y2hTdGFydFBpeGVsWQogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgdG91Y2hTdGFydFBpeGVsWTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3Igb2N0b3B1cy5XaWRnZXQuU2xpZGVyLmluaXRpYWxpemUKICAgICAgICAgKiBAZGVzYyDkuI7niLbnsbvkv53mjIHkuIDoh7QKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgdGhpcy5kYXRhRmllbGQgPSB0aGlzLmRhdGFGaWVsZCB8fCB7CiAgICAgICAgICAgICAgICB0aXRsZTogInRpdGxlIiwKICAgICAgICAgICAgICAgIHVybDogInVybCIsCiAgICAgICAgICAgICAgICBpbWFnZV91cmw6ICJpbWFnZV91cmwiCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZG9tcyA9IHRoaXMuY2hpbGRyZW4gfHwgW107CiAgICAgICAgICAgIHRoaXMudW5sb2FkSW1hZ2UgPSBbXTsKICAgICAgICAgICAgdGhpcy5sZW5ndGggPSB0aGlzLmRvbXMubGVuZ3RoID09IDAgPyB0aGlzLmRhdGEubGVuZ3RoIDogdGhpcy5kb21zLmxlbmd0aDsKICAgICAgICAgICAgdGhpcy5jdXJyZW50ID0gewogICAgICAgICAgICAgICAgaW5kZXg6IDAsCiAgICAgICAgICAgICAgICBkb206IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5idWlsZERvbXModGhpcy5lbCk7CiAgICAgICAgICAgIHRoaXMuYnVpbGRTbGlkZXIoKTsKICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS5jc3NUZXh0ID0gIm92ZXJmbG93OiBoaWRkZW47IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7IHBvc2l0aW9uOiByZWxhdGl2ZTsiOwogICAgICAgICAgICAvL+WmguaenOaYr+iHquWKqOa4suafk+eUn+aIkCDlv4XpobvkvKDlhaXlrr3luqbkuI7pq5jluqYg5ZCm5YiZ5oqb6ZSZCiAgICAgICAgICAgIGlmKHRoaXMuYXV0b0FjdGl2YXRlKSB7CiAgICAgICAgICAgICAgICBpZih0aGlzLndpZHRoID09IG51bGwgfHwgdGhpcy5oZWlnaHQgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCJSZXF1aXJlIHRoZSBTbGlkZXIncyB3aWR0aCBhbmQgaGVpZ2h0ISIpOwogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGJ1aWxkRG9tcwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBidWlsZERvbXM6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIHRoaXMudmlld0RpdiA9IHRoaXMudmlld0RpdiB8fCBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgIHN0eWxlOiAicG9zaXRpb246IHJlbGF0aXZlOyB0ZXh0LWFsaWduOiBjZW50ZXI7IC13ZWJraXQtdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKTsiICsKICAgICAgICAgICAgICAgICAgICAiIC13ZWJraXQtYmFja2ZhY2UtdmlzaWJpbGl0eTogaGlkZGVuOyAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOyAtd2Via2l0LXVzZXItZHJhZzogbm9uZTsiICsKICAgICAgICAgICAgICAgICAgICAiIC13ZWJraXQtdHJhbnNpdGlvbjogLXdlYmtpdC10cmFuc2Zvcm0gMG1zICIgKyB0aGlzLmFuaW1hdGlvblR5cGUgKyAiOyIsCiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXNsaWRlci12aWV3IgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYodGhpcy5oYXNCdXR0b24gJiYgIXRoaXMuZGlzYWJsZUFsbCAmJiB0aGlzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIHZhciBidG5Dc3NUZXh0ID0gImRpc3BsYXk6IGJsb2NrOyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IjsKICAgICAgICAgICAgICAgIHRoaXMucHJlRG9tID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAgICAgaHJlZjogIiIsCiAgICAgICAgICAgICAgICAgICAgc3R5bGU6IGJ0bkNzc1RleHQsCiAgICAgICAgICAgICAgICAgICAgImNsYXNzIjogIm9jdG9wdXN1aS1zbGlkZXItYnV0dG9uIG9jdG9wdXN1aS1zbGlkZXItcHJlYnV0dG9uIgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLm5leHREb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICAgICBocmVmOiAiIiwKICAgICAgICAgICAgICAgICAgICBzdHlsZTogYnRuQ3NzVGV4dCwKICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXNsaWRlci1idXR0b24gb2N0b3B1c3VpLXNsaWRlci1uZXh0YnV0dG9uIgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmUodGhpcy5wcmVEb20pLm9uKCJ0YXAiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgby5ldmVudC5zdG9wKGUpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuX3NlbGVjdFByZSgpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuYXV0b1BsYXkgJiYgdGhhdC5zdGFydCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmUodGhpcy5uZXh0RG9tKS5vbigidGFwIiwgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcChlKTsKICAgICAgICAgICAgICAgICAgICB0aGF0Ll9zZWxlY3ROZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5hdXRvUGxheSAmJiB0aGF0LnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKHRoaXMucHJlRG9tKTsKICAgICAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKHRoaXMubmV4dERvbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5oYXNHaXptb3MpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2l6bW9zRG9tcyA9IG5ldyBBcnJheSh0aGlzLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICAgICAgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgICAgICAgICAgICAgcm9kb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgImNsYXNzIjogIm9jdG9wdXN1aS1zbGlkZXItZ2l6bW9zIgogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZm9yKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9jbGFzc05hbWUgPSAib2N0b3B1c3VpLXNsaWRlci1naXptb3NpdGVtIjsKICAgICAgICAgICAgICAgICAgICBpZihpID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2NsYXNzTmFtZSA9ICJvY3RvcHVzdWktc2xpZGVyLWdpem1vc2l0ZW0gb2N0b3B1c3VpLXNsaWRlci1jdXJyZW50Z2l6bW9zaXRlbSIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIGRvbSA9IG8uZG9tLmNyZWF0ZURvbSgiZGl2IiwgewogICAgICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiBfY2xhc3NOYW1lCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naXptb3NEb21zW2ldID0gZG9tOwogICAgICAgICAgICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRHaXptb3MgPSB0aGlzLmdpem1vc0RvbXNbMF07CiAgICAgICAgICAgICAgICByb2RvbS5hcHBlbmRDaGlsZChmcmFnbWVudCk7CiAgICAgICAgICAgICAgICBlbC5hcHBlbmRDaGlsZChyb2RvbSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2V0Q3VycmVudAogICAgICAgICAqIEBkZXNjIOiuvue9ruW9k+W8uumAieS4reeahOi9ruaSrQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgc2V0Q3VycmVudDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSBvLmV4dGVuZCh0aGlzLmN1cnJlbnQsIG9wdGlvbnMpOwogICAgICAgICAgICBpZih0aGlzLmN1cnJlbnRHaXptb3MpIHsKICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuY3VycmVudC5pbmRleDsKICAgICAgICAgICAgICAgIGlmKHRoaXMuY3VycmVudEdpem1vcyAhPSB0aGlzLmdpem1vc0RvbXNbaW5kZXhdKSB7CiAgICAgICAgICAgICAgICAgICAgby5kb20ucmVtb3ZlQ2xhc3ModGhpcy5jdXJyZW50R2l6bW9zLCAib2N0b3B1c3VpLXNsaWRlci1jdXJyZW50Z2l6bW9zaXRlbSIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEdpem1vcyA9IHRoaXMuZ2l6bW9zRG9tc1tpbmRleF07CiAgICAgICAgICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModGhpcy5jdXJyZW50R2l6bW9zLCAib2N0b3B1c3VpLXNsaWRlci1jdXJyZW50Z2l6bW9zaXRlbSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlNsaWRlci5idWlsZFNsaWRlcgogICAgICAgICAqIEBkZXNjIOeUn+aIkOWIneWni+iKgueCuee7k+aehAogICAgICAgICAqLwogICAgICAgIGJ1aWxkU2xpZGVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGZyYWdtZW50OwogICAgICAgICAgICBpZih0aGlzLmNoaWxkcmVuID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5idWlsZERlZmF1bHRTbGlkZXIoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5idWlsZERvbVNsaWRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMubG9vcCAmJiB0aGlzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIHZhciBmcmlzdGRvbSA9IHRoaXMuZG9tc1swXS5jbG9uZU5vZGUodHJ1ZSksCiAgICAgICAgICAgICAgICAgICAgbGFzdGRvbSA9IHRoaXMuZG9tc1t0aGlzLmxlbmd0aCAtIDFdLmNsb25lTm9kZSh0cnVlKTsKICAgICAgICAgICAgICAgIGlmKHRoaXMuX3R5cGUgPT0gImltZyIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEltYWdlTG9hZCgwLCBmcmlzdGRvbSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbWFnZUxvYWQodGhpcy5sZW5ndGggLSAxLCBsYXN0ZG9tKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGZyaXN0ZG9tKTsKICAgICAgICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGxhc3Rkb20pOwogICAgICAgICAgICAgICAgdGhpcy5kb21zLnB1c2goZnJpc3Rkb20pOwogICAgICAgICAgICAgICAgdGhpcy5kb21zLnB1c2gobGFzdGRvbSk7CiAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aCArPSAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0Q3VycmVudCh7CiAgICAgICAgICAgICAgICBkb206IHRoaXMuZG9tc1swXQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy52aWV3RGl2LmFwcGVuZENoaWxkKGZyYWdtZW50KTsKICAgICAgICAgICAgdGhpcy5lbC5hcHBlbmRDaGlsZCh0aGlzLnZpZXdEaXYpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBidWlsZFNsaWRlckl0ZW0KICAgICAgICAgKiBAZGVzYyDnlJ/miJDova7mkq3lm77nmoTljZXkvosKICAgICAgICAgKiBAcGFyYW0gaW5kZXgge051bWJlcn0KICAgICAgICAgKi8KICAgICAgICBidWlsZFNsaWRlckl0ZW06IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgIHZhciBkb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXNsaWRlci1jaGlsZHJlbiIsCiAgICAgICAgICAgICAgICAgICAgInN0eWxlIjogInBvc2l0aW9uOiByZWxhdGl2ZTsgLXdlYmtpdC10cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApOyBvdmVyZmxvdzogaGlkZGVuOyIKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaWRvbSA9IG8uZG9tLmNyZWF0ZURvbSgiaW1nIiwgewogICAgICAgICAgICAgICAgICAgICJjbGFzcyI6ICJvY3RvcHVzdWktc2xpZGVyLWltZ0NoaWxkcmVuIiwKICAgICAgICAgICAgICAgICAgICBzdHlsZTogIm1heC13aWR0aDogMTAwJTsgbWF4LWhlaWdodDogMTAwJTsgcG9zaXRpb246IGFic29sdXRlOyBsZWZ0OiAwOyByaWdodDogMDsgdG9wOiAwOyBib3R0b206IDA7IG1hcmdpbjogYXV0bzsiCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIF9fdXJsID0gdGhpcy5nZXREYXRhQnkoaW5kZXgsICJ1cmwiKSB8fCAiIiwKICAgICAgICAgICAgICAgIF9fdGFyZ2V0ID0gdGhpcy5pc05ld1RhYiA/ICJfYmxhbmsiIDogIl9zZWxmIiwKICAgICAgICAgICAgICAgIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBvLmV2ZW50Lm9uKGlkb20sICJjbGljayIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYoIXRoYXQuaXNEaXNhYmxlQSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5vcGVuKF9fdXJsLCBfX3RhcmdldCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhhdC5ub3RpZnkoInNsaWRlci1pdGVtLW9udGFwIiwgdGhhdC5kYXRhW2luZGV4XSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZigoaW5kZXggPCBNYXRoLmNlaWwodGhpcy5sb2FkSW1hZ2VOdW1iZXIgLyAyKSkgfHwKICAgICAgICAgICAgICAgIGluZGV4ID49IE1hdGguZmxvb3IodGhpcy5sZW5ndGggLSB0aGlzLmxvYWRJbWFnZU51bWJlciAvIDIpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEltYWdlTG9hZChpbmRleCwgaWRvbSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnVubG9hZEltYWdlLnB1c2goewogICAgICAgICAgICAgICAgICAgIGluZGV4OiBpbmRleCwKICAgICAgICAgICAgICAgICAgICBkb206IGlkb20KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvbS5hcHBlbmRDaGlsZChpZG9tKTsKICAgICAgICAgICAgaWYodGhpcy5oYXNUaXRsZSkgewogICAgICAgICAgICAgICAgdmFyIHRpdGxlZG9tID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJjbGFzcyI6ICJvY3RvcHVzdWktc2xpZGVyLWltZ1RpdGxlIgogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgIHRpdGxlY29udGVudCA9IG8uZG9tLmNyZWF0ZURvbSgiZGl2IiwgewogICAgICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXNsaWRlci1pbWdUaXRsZUNvbnRlbnQgb2N0b3B1c3VpLXRleHQtbGltaXQiCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aXRsZWNvbnRlbnQuaW5uZXJIVE1MID0gby51dGlsLmVuY29kZUh0bWwodGhpcy5nZXREYXRhQnkoaW5kZXgsICJ0aXRsZSIpKTsKICAgICAgICAgICAgICAgIHRpdGxlZG9tLmFwcGVuZENoaWxkKHRpdGxlY29udGVudCk7CiAgICAgICAgICAgICAgICBkb20uYXBwZW5kQ2hpbGQodGl0bGVkb20pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZG9tcy5wdXNoKGRvbSk7CiAgICAgICAgICAgIHJldHVybiBkb207CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuU2xpZGVyLm9uCiAgICAgICAgICogQGRlc2Mg5ZCMV2lkZ2V0IOWAvOW+l+azqOaEj+eahOaYryDlpoLmnpzoh6rlrprkuYnnm5HlkKzkuoYic2xpZGVyLWl0ZW0tb250YXAi5LqL5Lu2IOm7mOiupOeCueWHu+i9ruaSreWbvuaJk+W8gOaWsOmTvuaOpeeahOihjOS4uuWwhuWkseaViAogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOS6i+S7tuexu+WeiwogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g5LqL5Lu255uR5ZCs5Ye95pWwCiAgICAgICAgICovCiAgICAgICAgb246IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLm9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGlmKHR5cGUgPT0gInNsaWRlci1pdGVtLW9udGFwIiAmJiAhdGhpcy5pc0Rpc2FibGVBKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGlzYWJsZUEgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGJ1aWxkRGVmYXVsdFNsaWRlcgogICAgICAgICAqIEBkZXNjIOeUn+aIkOWbvueJh+i9ruaSrQogICAgICAgICAqLwogICAgICAgIGJ1aWxkRGVmYXVsdFNsaWRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBsZW4gPSB0aGlzLmRhdGEubGVuZ3RoOwogICAgICAgICAgICBpZighISFsZW4pIHRocm93IG5ldyBFcnJvcigiUmVxdWlyZSBkYXRhIG9mIGltYWdlISIpOwogICAgICAgICAgICB2YXIgaSA9IDAsCiAgICAgICAgICAgICAgICBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgZm9yKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZG9tID0gdGhpcy5idWlsZFNsaWRlckl0ZW0oaSk7CiAgICAgICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmcmFnbWVudDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2V0SW1hZ2VMb2FkCiAgICAgICAgICogQHBhcmFtIGluZGV4IHtOdW1iZXJ9IOWbvueJh+eahGluZGV4CiAgICAgICAgICogQHBhcmFtIGRvbSB7RE9NRUxlbWVudH0g5Zu+54mH55qE6L295L2T6IqC54K5CiAgICAgICAgICovCiAgICAgICAgc2V0SW1hZ2VMb2FkOiBmdW5jdGlvbihpbmRleCwgZG9tKSB7CiAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLmdldERhdGFCeShpbmRleCwgImltYWdlX3VybCIpOwogICAgICAgICAgICB2YXIgX2RvbSA9IG8ub25lKCIub2N0b3B1c3VpLXNsaWRlci1pbWdDaGlsZHJlbiIsIGRvbSkgfHwgZG9tOwogICAgICAgICAgICBvLnV0aWwubG9hZEltYWdlKHVybCwgby51dGlsLmVtcHR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIF9kb20uc3JjID0gdXJsOwogICAgICAgICAgICAgICAgby5hbmltYXRpb24uZmFkZShfZG9tLCB7CiAgICAgICAgICAgICAgICAgICAgb3V0OiBmYWxzZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiSW1hZ2UgIiArIHVybCArICIgbG9hZCBmYWlsZWQhIik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBidWlsZERvbVNsaWRlcgogICAgICAgICAqIEBkZXNjIOeUn+aIkOiKgueCuei9ruaSrQogICAgICAgICAqLwogICAgICAgIGJ1aWxkRG9tU2xpZGVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICAgICAgICAgICAgbGVuID0gdGhpcy5kb21zLmxlbmd0aCwKICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICB0aGlzLl90eXBlID0gImRvbSI7CiAgICAgICAgICAgIGZvcig7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQodGhpcy5kb21zW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZnJhZ21lbnQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuU2xpZGVyLnJlbmRlcgogICAgICAgICAqIEBkZXNjIOWkjeWGmeeItuexu+eahHJlbmRlcuaWueazlQogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG8uV2lkZ2V0LnByb3RvdHlwZS5yZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgaWYodGhpcy5hdXRvUGxheSAmJiB0aGlzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm5vdGlmeSgic2xpZGVyLXVpLWFmdGVycmVuZGVyIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGFjdGl2YXRlCiAgICAgICAgICogQGRlc2Mg6L2u5pKt5Zu+55Sf5oiQ5ZCO5Yqg5YWl6aG16Z2i6ZyA6KaB5r+A5rS7CiAgICAgICAgICovCiAgICAgICAgYWN0aXZhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBvLldpZGdldC5wcm90b3R5cGUuYWN0aXZhdGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgdGhpcy5jYWxjU2VsZlNpemUoKTsKICAgICAgICAgICAgaWYoIXRoaXMuZGlzYWJsZUFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5pbml0U2VsZkV2ZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25PcnRDaGFuZ2VkCiAgICAgICAgICovCiAgICAgICAgb25PcnRDaGFuZ2VkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYWxjU2VsZlNpemUoKTsKICAgICAgICAgICAgdGhpcy5zZWxlY3QodGhpcy5jdXJyZW50LmluZGV4KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgdXBkYXRlVHJhbnNsYXRlVmFsdWUKICAgICAgICAgKiBAZGVzYyDmm7TmlrDova7mkq3nmoTkvY3nva4KICAgICAgICAgKiBAcGFyYW0gdiB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHVwZGF0ZVRyYW5zbGF0ZVZhbHVlOiBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgIGlmKCghdiAmJiB2ICE9IDApIHx8IHRoaXMudHJhbnNsYXRlVmFsdWUgPT0gdikgIHJldHVybjsKICAgICAgICAgICAgdGhpcy50cmFuc2xhdGVWYWx1ZSA9IHY7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGNhbGNTZWxmU2l6ZQogICAgICAgICAqIEBkZXNjIOWIneWni+WMluiHqui6q+WuvemrmAogICAgICAgICAqLwogICAgICAgIGNhbGNTZWxmU2l6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaXNMb24gPyB0aGlzLmluaXREb21zUHJvcGVydHkoIndpZHRoIiwgImhlaWdodCIsIGZhbHNlKSA6IHRoaXMuaW5pdERvbXNQcm9wZXJ0eSgiaGVpZ2h0IiwgIndpZHRoIiwgdHJ1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGluaXREb21zV2lkdGgKICAgICAgICAgKiBAZGVzYyDlsIbmiYDmnIlkb23lrr3luqbmiJbpq5jluqborr7nva7kuoYKICAgICAgICAgKi8KICAgICAgICBpbml0RG9tc1Byb3BlcnR5OiBmdW5jdGlvbihwcm8sIHNwcm8sIGlzRmxvYXQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLAogICAgICAgICAgICAgICAgbGVuID0gdGhpcy5sZW5ndGg7CiAgICAgICAgICAgIHRoaXMudmlld0Rpdi5zdHlsZVtwcm9dID0gIjEwMCUiOwogICAgICAgICAgICB2YXIgX3Nwcm8gPSBvLmRvbVsiZ2V0IiArIHNwcm8uY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzcHJvLnN1YnN0cmluZygxKV0odGhpcy5lbCk7CiAgICAgICAgICAgIHRoaXNbc3Byb10gID0gX3Nwcm87CiAgICAgICAgICAgIHRoaXMudmlld0Rpdi5zdHlsZVtzcHJvXSA9IF9zcHJvICogbGVuICsgInB4IjsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5kb21zLCBmdW5jdGlvbihpdGVtLCBpKSB7CiAgICAgICAgICAgICAgICBpdGVtLnN0eWxlW3Byb10gPSAiMTAwJSI7CiAgICAgICAgICAgICAgICBpdGVtLnN0eWxlW3Nwcm9dID0gX3Nwcm8gKyAicHgiOwoJCQkJaWYoaXNGbG9hdCkgewogICAgICAgICAgICAgICAgICAgIGl0ZW0uc3R5bGUuZmxvYXQgPSAibGVmdCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihpID09IGxlbiAtIDEgJiYgdGhhdC5sb29wICYmIHRoYXQubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICAgIHZhciBfX3N0eWxlID0gdGhhdC5pc0xvbiA/ICJ0b3AiIDogImxlZnQiOwogICAgICAgICAgICAgICAgICAgIGl0ZW0uc3R5bGVbX19zdHlsZV0gPSAwIC0gX3Nwcm8gKiBsZW4gKyAicHgiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgaW5pdFNlbGZFdmVudAogICAgICAgICAqIEBkZXNjIOe7mei9ruaSreWbvue7keWumuS6i+S7tgogICAgICAgICAqLwogICAgICAgIGluaXRTZWxmRXZlbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQub24odGhpcy5lbCwgInRvdWNoc3RhcnQiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hTdGFydCwgdGhpcykpOwogICAgICAgICAgICAgICAgby5ldmVudC5vbih0aGlzLmVsLCAidG91Y2htb3ZlIiwgby51dGlsLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcy5vblRvdWNoTW92ZSwgdGhpcykpOwogICAgICAgICAgICAgICAgby5ldmVudC5vbih0aGlzLmVsLCAidG91Y2hlbmQgdG91Y2hjYW5jZWwiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hFbmQsIHRoaXMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvLmV2ZW50Lm9uKHdpbmRvdywgIm9ydGNoYW5nZSIsIG8udXRpbC5iaW5kKHRoaXMub25PcnRDaGFuZ2VkLCB0aGlzKSwgZmFsc2UpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvblRvdWNoU3RhcnQKICAgICAgICAgKiBAZGVzYyDlvIDlp4vmi5bmi70KICAgICAgICAgKiBAcGFyYW0gZSB7d2luZG93LmV2ZW50fQogICAgICAgICAqLwogICAgICAgIG9uVG91Y2hTdGFydDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICBpZih0aGlzLmV2ZW50VGltZXIgfHwgdGhpcy5pc1NsaWRlKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuZGlzU2Nyb2xsICYmIG8uZXZlbnQuc3RvcChlKTsKICAgICAgICAgICAgdmFyIHRvdWNoZXMgPSBlLnRvdWNoZXM7CiAgICAgICAgICAgIGlmKCF0b3VjaGVzIHx8IHRvdWNoZXMubGVuZ3RoID4gMSkgIHJldHVybjsKICAgICAgICAgICAgdGhpcy52aWV3RGl2LnN0eWxlLndlYmtpdFRyYW5zaXRpb25EdXJhdGlvbiA9ICIwbXMiOwogICAgICAgICAgICB0aGlzLmlzRHJhZyA9IHRydWU7CiAgICAgICAgICAgIGlmKHRoaXMuYXV0b1BsYXkpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0b3VjaCA9IHRvdWNoZXNbMF07CiAgICAgICAgICAgIHZhciBkYzsKICAgICAgICAgICAgaWYodGhpcy5pc0xvbikgewogICAgICAgICAgICAgICAgZGMgPSB0b3VjaC5wYWdlWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRjID0gdG91Y2gucGFnZVg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy50b3VjaFN0YXJ0UGl4ZWxYID0gdG91Y2gucGFnZVg7CiAgICAgICAgICAgIHRoaXMudG91Y2hTdGFydFBpeGVsWSA9IHRvdWNoLnBhZ2VZOwogICAgICAgICAgICB0aGlzLnBhZ2VEcmFnU3RhcnRDID0gdGhpcy5wYWdlRHJhZ1RlbXBDID0gZGM7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdGhpcy5kcmFndGltZXIgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZih0aGF0LnBhZ2VEcmFnVGVtcEMgPT0gdGhhdC5wYWdlRHJhZ0VuZEMpIHJldHVybjsKICAgICAgICAgICAgICAgIHRoYXQucGFnZURyYWdFbmRDID0gdGhhdC5wYWdlRHJhZ1RlbXBDOwogICAgICAgICAgICAgICAgdmFyIGRpcyA9IHRoYXQucGFnZURyYWdUZW1wQyAtIHRoYXQucGFnZURyYWdTdGFydEM7CiAgICAgICAgICAgICAgICB0aGF0LnBhZ2VEcmFnU3RhcnRDID0gdGhhdC5wYWdlRHJhZ1RlbXBDOwogICAgICAgICAgICAgICAgdmFyIHR2YWx1ZSA9IHRoYXQudHJhbnNsYXRlVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgbnZhbHVlID0gdHZhbHVlICsgZGlzLAogICAgICAgICAgICAgICAgICAgIG50cmFuc2Zvcm07CiAgICAgICAgICAgICAgICBpZih0aGF0LmlzTG9uKSB7CiAgICAgICAgICAgICAgICAgICAgbnRyYW5zZm9ybSA9ICJ0cmFuc2xhdGUzZCgwLCAiICsgbnZhbHVlICsgInB4LCAwKSI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG50cmFuc2Zvcm0gPSAidHJhbnNsYXRlM2QoIiArIG52YWx1ZSArICJweCwgMCwgMCkiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhhdC51cGRhdGVUcmFuc2xhdGVWYWx1ZShudmFsdWUpOwogICAgICAgICAgICAgICAgdGhhdC5jaGFuZ2VEaXMgKz0gZGlzOwogICAgICAgICAgICAgICAgdGhhdC52aWV3RGl2LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IG50cmFuc2Zvcm07CiAgICAgICAgICAgIH0sIDE2KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaE1vdmUKICAgICAgICAgKiBAZGVzYyDmi5bmi73ov5vooYwKICAgICAgICAgKiBAcGFyYW0gZSB7d2luZG93LmV2ZW50fQogICAgICAgICAqLwogICAgICAgIG9uVG91Y2hNb3ZlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciB0b3VjaGVzID0gZS50b3VjaGVzOwogICAgICAgICAgICBpZighdGhpcy5pc0RyYWcgfHwgIXRvdWNoZXMgfHwgdG91Y2hlcy5sZW5ndGggPiAxKSAgICByZXR1cm47CiAgICAgICAgICAgIHZhciB0b3VjaCA9IHRvdWNoZXNbMF0sCiAgICAgICAgICAgICAgICBkYzsKICAgICAgICAgICAgaWYodGhpcy5pc0xvbikgewogICAgICAgICAgICAgICAgZGMgPSB0b3VjaC5wYWdlWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRjID0gdG91Y2gucGFnZVg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5wYWdlRHJhZ1RlbXBDID09IGRjKQlyZXR1cm47CiAgICAgICAgICAgIHZhciBwaXhlbCA9IHsKICAgICAgICAgICAgICAgIHBhZ2VYOiB0aGlzLnRvdWNoU3RhcnRQaXhlbFgsCiAgICAgICAgICAgICAgICBwYWdlWTogdGhpcy50b3VjaFN0YXJ0UGl4ZWxZCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFuZ2xlID0gby51dGlsLmdldERpcmVjdGlvbihwaXhlbCwgdG91Y2gpOwogICAgICAgICAgICB0aGlzLnBhZ2VEcmFnVGVtcEMgPSBkYzsKICAgICAgICAgICAgaWYodGhpcy5kaXNTY3JvbGwpICByZXR1cm4gby5ldmVudC5zdG9wKGUpOwogICAgICAgICAgICBpZigodGhpcy5pc0xvbiAmJiAoYW5nbGUgPT0gInVwIiB8fCBhbmdsZSA9PSAiZG93biIpKSB8fAogICAgICAgICAgICAgICAgKCF0aGlzLmlzTG9uICYmIChhbmdsZSA9PSAibGVmdCIgfHwgYW5nbGUgPT0gInJpZ2h0IikpKSB7CiAgICAgICAgICAgICAgICBvLmV2ZW50LnN0b3AoZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaEVuZAogICAgICAgICAqIEBkZXNjIOaLluaLvee7k+adnwogICAgICAgICAqIEBwYXJhbSBlIHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICovCiAgICAgICAgb25Ub3VjaEVuZDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB0aGlzLmlzRHJhZyA9IGZhbHNlOwogICAgICAgICAgICBpZih0aGlzLmRyYWd0aW1lcikgewogICAgICAgICAgICAgICAgd2luZG93LmNsZWFySW50ZXJ2YWwodGhpcy5kcmFndGltZXIpOwogICAgICAgICAgICAgICAgdGhpcy5kcmFndGltZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDsKICAgICAgICAgICAgaWYodGFyZ2V0ID09IHRoaXMucHJlRG9tIHx8IHRhcmdldCA9PSB0aGlzLm5leHREb20pIHJldHVybjsKICAgICAgICAgICAgaWYoTWF0aC5hYnModGhpcy5jaGFuZ2VEaXMpIDw9IHRoaXMuc3ByaW5nQmFja0RpcykgewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3QodGhpcy5jdXJyZW50LmluZGV4KTsKICAgICAgICAgICAgfSBlbHNlIGlmKHRoaXMubG9vcCkgewogICAgICAgICAgICAgICAgaWYodGhpcy5jaGFuZ2VEaXMgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VsZWN0TmV4dCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZWxlY3RQcmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmKCF0aGlzLmxvb3ApIHsKICAgICAgICAgICAgICAgIGlmKHRoaXMuY2hhbmdlRGlzIDwgMCAmJiB0aGlzLmN1cnJlbnQuaW5kZXggIT0gdGhpcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VsZWN0TmV4dCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKHRoaXMuY2hhbmdlRGlzID4gMCAmJiB0aGlzLmN1cnJlbnQuaW5kZXggIT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NlbGVjdFByZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdCh0aGlzLmN1cnJlbnQuaW5kZXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY2hhbmdlRGlzID0gMDsKICAgICAgICAgICAgaWYodGhpcy5hdXRvUGxheSkgewogICAgICAgICAgICAgICAgdGhpcy5zdGFydCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGdldERhdGFCeQogICAgICAgICAqIEBkZXNjIOaKiuWtmOeahOaVsOaNruS4reeahOafkOmhueWPluWHuuadpQogICAgICAgICAqIEBwYXJhbSBpbmRleCB7TnVtYmVyfQogICAgICAgICAqIEBwYXJhbSBwcm8ge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBnZXREYXRhQnk6IGZ1bmN0aW9uKGluZGV4LCBwcm8pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YVtpbmRleF1bdGhpcy5kYXRhRmllbGRbcHJvXV07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuU2xpZGVyLnN0YXJ0CiAgICAgICAgICogQGRlc2Mg5byA5aeL6L2u5pKtCiAgICAgICAgICovCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgdGhpcy50aW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KG8udXRpbC5iaW5kKHRoaXMuX2NhbGNDdXJyZW50LCB0aGlzKSwgdGhpcy5hdXRvUGxheVRpbWUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBfY2FsY0N1cnJlbnQKICAgICAgICAgKiBAZGVzYyDov5vooYzova7mkq0KICAgICAgICAgKi8KICAgICAgICBfY2FsY0N1cnJlbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmN1cnJlbnQuaW5kZXg7CiAgICAgICAgICAgIHZhciBsZW5ndGggPSB0aGlzLmxvb3AgPyB0aGlzLmxlbmd0aCAtIDIgOiB0aGlzLmxlbmd0aDsKICAgICAgICAgICAgaW5kZXggPSAoKytpbmRleCA9PSBsZW5ndGgpID8gMCA6IGluZGV4OwogICAgICAgICAgICB0aGlzLnNlbGVjdChpbmRleCwgIm5leHQiKTsKICAgICAgICAgICAgdGhpcy5zdGFydCgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlNsaWRlci5zdG9wCiAgICAgICAgICogQGRlc2Mg5YGc5q2i6L2u5pKtCiAgICAgICAgICovCiAgICAgICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMudGltZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy50aW1lcik7CiAgICAgICAgICAgICAgICB0aGlzLnRpbWVyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlNsaWRlci5zZWxlY3QKICAgICAgICAgKiBAZGVzYyDpgInmi6nnrKxu5Liq5a2Q6IqC54K5CiAgICAgICAgICogQHBhcmFtIGluZGV4IHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgc2VsZWN0OiBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgICB0aGlzLmlzU2xpZGUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnZpZXdEaXYuc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gdGhpcy5hbmltYXRpb25UaW1lICsgIm1zIjsKCiAgICAgICAgICAgIGlmKHRoaXMubG9vcCkgewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RMb29wKGluZGV4LCBhcmd1bWVudHNbMV0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3ROb0xvb3AoaW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0Q3VycmVudCh7CiAgICAgICAgICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgICAgICAgICBkb206IHRoaXMuZG9tc1tpbmRleF0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHRoaXMuX3R5cGUgPT0gImltZyIgJiYgdGhpcy51bmxvYWRJbWFnZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF4ID0gaW5kZXggKyBNYXRoLmNlaWwodGhpcy5sb2FkSW1hZ2VOdW1iZXIgLyAyKSwKICAgICAgICAgICAgICAgICAgICBtaW4gPSBNYXRoLmZsb29yKHRoaXMubG9hZEltYWdlTnVtYmVyIC8gMiksCiAgICAgICAgICAgICAgICAgICAgX2xlbiA9IHRoaXMudW5sb2FkSW1hZ2UubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGkgPSBfbGVuOwogICAgICAgICAgICAgICAgZm9yKDsgaS0tOyApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2luZGV4ID0gdGhpcy51bmxvYWRJbWFnZVtpXS5pbmRleDsKICAgICAgICAgICAgICAgICAgICBpZigoX2luZGV4IDwgbWF4KSAmJiAhdGhpcy5wYWdlRHJhZ0RpcmVjdGlvbiB8fAogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggLSBfaW5kZXgpIDw9IG1pbiAmJiB0aGlzLnBhZ2VEcmFnRGlyZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW1hZ2VMb2FkKF9pbmRleCwgdGhpcy51bmxvYWRJbWFnZVtpXS5kb20pOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVubG9hZEltYWdlLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoYXQuaXNTbGlkZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhhdC5ub3RpZnkoInNsaWRlci11aS1zbGlkZWNoYW5nZSIpOwogICAgICAgICAgICB9LCB0aGlzLmFuaW1hdGlvblRpbWUgKyA1MCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNlbGVjdE5vTG9vcAogICAgICAgICAqIEBkZXNjIOi9ruaSreWIsOacgOWQjuWGjei9ruaSreWbnuadpQogICAgICAgICAqIEBwYXJhbSBpbmRleCB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHNlbGVjdE5vTG9vcDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZXN0ciA9ICJ0cmFuc2xhdGUzZCgiOwogICAgICAgICAgICBpZih0aGlzLmlzTG9uKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IDAgLSAoaW5kZXggKiB0aGlzLmhlaWdodCk7CiAgICAgICAgICAgICAgICB0cmFuc2xhdGVzdHIgKz0gIjAsICIgKyB0ICsgInB4LCAwKSI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IDAgLSAoaW5kZXggKiB0aGlzLndpZHRoKTsKICAgICAgICAgICAgICAgIHRyYW5zbGF0ZXN0ciArPSB0ICsgInB4LCAwLCAwKSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy51cGRhdGVUcmFuc2xhdGVWYWx1ZSh0KTsKICAgICAgICAgICAgdGhpcy52aWV3RGl2LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IHRyYW5zbGF0ZXN0cjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2VsZWN0TG9vcAogICAgICAgICAqIEBkZXNjIOW+queOr+mAieaLqQogICAgICAgICAqIEBwYXJhbSBpbmRleCB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHNlbGVjdExvb3A6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgIHZhciBfaW5kZXggPSB0aGlzLmN1cnJlbnQuaW5kZXgsCiAgICAgICAgICAgICAgICBsZW4gPSB0aGlzLmxlbmd0aCAtIDIsCiAgICAgICAgICAgICAgICB0ZW1wLAogICAgICAgICAgICAgICAgX3RlbXAgPSB0ZW1wID0gInRyYW5zbGF0ZTNkKCI7CiAgICAgICAgICAgIGlmKChpbmRleCA9PSAwICYmIF9pbmRleCA9PSAobGVuIC0gMSkpIHx8IChfaW5kZXggPT0gMCAmJiBpbmRleCA9PSAobGVuIC0gMSkpKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgZCA9IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgICAgIGlmKGxlbiA9PSAyICYmIGQgJiYgKChpbmRleCA9PSAwICYmIF9pbmRleCA9PSAobGVuIC0gMSkgJiYgZCA9PSAicHJlIikKICAgICAgICAgICAgICAgICAgICB8fCAoaW5kZXggPT0gKGxlbiAtIDEpICYmIF9pbmRleCA9PSAwICYmIGQgPT0gIm5leHQiKSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdE5vTG9vcChpbmRleCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoaW5kZXggPT0gMCAmJiBfaW5kZXggPT0gKGxlbiAtIDEpKSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXAgKz0gIjAsIDAsIDApIjsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVRyYW5zbGF0ZVZhbHVlKDApOwogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuaXNMb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcCArPSAiMCwgIiArICgwIC0gdGhpcy5oZWlnaHQgKiBsZW4pICsgInB4LCAwKSI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcCArPSAoMCAtIHRoaXMud2lkdGggKiBsZW4pICsgInB4LCAwLCAwKSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmKGluZGV4ID09IChsZW4gLSAxKSAmJiBfaW5kZXggPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuaXNMb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcCArPSAiMCwgIiArIHRoaXMuaGVpZ2h0ICsgInB4LCAwKSI7CiAgICAgICAgICAgICAgICAgICAgICAgIF90ZW1wICs9ICIwLCAiICsgKDAgLSB0aGlzLmhlaWdodCAqIChsZW4gLSAxKSkgKyAicHgsIDApIjsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVUcmFuc2xhdGVWYWx1ZSgwIC0gdGhpcy5oZWlnaHQgKiAobGVuIC0gMSkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXAgKz0gdGhpcy53aWR0aCArICJweCwgMCwgMCkiOwogICAgICAgICAgICAgICAgICAgICAgICBfdGVtcCArPSAoMCAtIHRoaXMud2lkdGggKiAobGVuIC0gMSkpICsgInB4LCAwLCAwKSI7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVHJhbnNsYXRlVmFsdWUoMCAtIHRoaXMud2lkdGggKiAobGVuIC0gMSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuaXNUaW1lciA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgb25DaGFuZ2VkID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIG8uZXZlbnQudW4odGhhdC52aWV3RGl2LCAid2Via2l0VHJhbnNpdGlvbkVuZCIsIG9uQ2hhbmdlZCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIGlmKCF0aGF0LmlzVGltZXIpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBpZih0aGF0LmV2ZW50VGltZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGF0LmV2ZW50VGltZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmV2ZW50VGltZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGF0LnZpZXdEaXYuc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gIjBtcyI7CiAgICAgICAgICAgICAgICAgICAgdGhhdC52aWV3RGl2LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IF90ZW1wOwogICAgICAgICAgICAgICAgICAgIF90ZW1wID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG8uZXZlbnQub24odGhpcy52aWV3RGl2LCAid2Via2l0VHJhbnNpdGlvbkVuZCIsIG9uQ2hhbmdlZCwgZmFsc2UpOwogICAgICAgICAgICAgICAgdGhpcy52aWV3RGl2LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IHRlbXA7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50VGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBvLmV2ZW50LnVuKHRoYXQudmlld0RpdiwgIndlYmtpdFRyYW5zaXRpb25FbmQiLCBvbkNoYW5nZWQsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LnZpZXdEaXYuc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gIjBtcyI7CiAgICAgICAgICAgICAgICAgICAgdGhhdC52aWV3RGl2LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IF90ZW1wOwogICAgICAgICAgICAgICAgICAgIF90ZW1wID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGF0LmV2ZW50VGltZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHRoYXQuaXNUaW1lciA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSwgdGhpcy5hbmltYXRpb25UaW1lIC0gNTAgPCAwID8gMCA6IHRoaXMuYW5pbWF0aW9uVGltZSAtIDUwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0Tm9Mb29wKGluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlNsaWRlci5fc2VsZWN0UHJlCiAgICAgICAgICogQGRlc2Mg6YCJ5oup5LiK5LiA5byg6L2u5pKt5Zu+CiAgICAgICAgICovCiAgICAgICAgX3NlbGVjdFByZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMuaXNTbGlkZSkgICAgcmV0dXJuOwogICAgICAgICAgICB2YXIgbGVuID0gdGhpcy5sb29wID8gdGhpcy5sZW5ndGggLSAyIDogdGhpcy5sZW5ndGg7CiAgICAgICAgICAgIHZhciBpbmRleCA9ICh0aGlzLmN1cnJlbnQuaW5kZXggLSAxKSA8IDAgPyAobGVuIC0gMSkgOiB0aGlzLmN1cnJlbnQuaW5kZXggLSAxOwogICAgICAgICAgICB0aGlzLnBhZ2VEcmFnRGlyZWN0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zZWxlY3QoaW5kZXgsICJwcmUiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5TbGlkZXIuX3NlbGVjdE5leHQKICAgICAgICAgKiBAZGVzYyDpgInmi6nkuIvkuIDlvKDova7mkq3lm74KICAgICAgICAgKi8KICAgICAgICBfc2VsZWN0TmV4dDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMuaXNTbGlkZSkgICByZXR1cm47CiAgICAgICAgICAgIHZhciBsZW4gPSB0aGlzLmxvb3AgPyB0aGlzLmxlbmd0aCAtIDIgOiB0aGlzLmxlbmd0aDsKICAgICAgICAgICAgdmFyIGluZGV4ID0gKHRoaXMuY3VycmVudC5pbmRleCArIDEpID4gKGxlbiAtIDEpID8gMCA6IHRoaXMuY3VycmVudC5pbmRleCArIDE7CiAgICAgICAgICAgIHRoaXMucGFnZURyYWdEaXJlY3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zZWxlY3QoaW5kZXgsICJuZXh0Iik7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0LlNsaWRlciIKICAgIH0pOwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5zbGlkZXIKICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAqIEByZXR1cm5zIHtvLldpZGdldC5IdG1sU2xpZGVyfQogICAgICogQGRlc2Mg55Sf5oiQ5LiOaHRtbOaooeeJiOebuOe7keWumueahOi9ruaSreWbviDmiYDmnInnmoTlj4LmlbDpg73ku6VodG1s5qih54mI5b2i5byP5Lyg5YWlCiAgICAgKi8KICAgIG8uV2lkZ2V0LnNsaWRlciA9IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgcmV0dXJuIG5ldyBvLldpZGdldC5IdG1sU2xpZGVyKHsKICAgICAgICAgICAgZWw6IGVsCiAgICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQGNsYXNzIG9jdG9wdXMuV2lkZ2V0Lkh0bWxTbGlkZXIKICAgICAqIEBwYXJlbnQgb2N0b3B1cy5XaWRnZXQuU2xpZGVyCiAgICAgKiBAZGVzYyDlj4LmlbDkuI5vY3RvcHVzLldpZGdldC5TbGlkZXLnm7jlkIwg5LiN5ZCM55qE5pivIOi/meS4quexu+S7hemZkOS6juWvueW3suacieespuWQiOinhOiMg+eahGh0bWzmqKHniYjnmoTmlLnpgKDkuI7lsIHoo4UKICAgICAqIOespuWQiOadoeS7tueahGh0bWzmqKHniYjlsZ7mgKfljIXmi6wKICAgICAqIGRhdGEtb2N0b3B1c3VpLXNsaWRlci1sb29wIOWmguaenOaXoOatpOWxnuaAp+WImei9ruaSreWbvuS4jeWJjeWQjuW+queOrwogICAgICogZGF0YS1vY3RvcHVzdWktc2xpZGVyLW5vYnV0dG9uIOWmguaenOiuvue9ruatpOWxnuaApyDliJnkuI3ljIXlkKvkuIrkuIDkuKrkuIvkuIDkuKrmjInpkq4KICAgICAqIGRhdGEtb2N0b3B1c3VpLXNsaWRlci1kaXNhYmxlIOWmguaenOiuvue9ruatpOWxnuaApyDliJnpmaTkuobkuI3ljIXlkKvmjInpkq7lpJYg5Lmf5rKh5pyJ5Lu75L2V5LqL5Lu255uR5ZCsIOWPr+eUqOS6juWNleW8oOWbvgogICAgICogZGF0YS1vY3RvcHVzdWktc2xpZGVyLW5vZ2l6bW9zIOWmguaenOiuvue9ruatpOWxnuaApyDliJnkuI3ljIXlkKvlj7PkuIvop5LnmoTop5LmoIcKICAgICAqIGRhdGEtb2N0b3B1c3VpLXNsaWRlci1ub3RhdXRvIOWmguaenOiuvue9ruatpOWxnuaApyDliJnkuI3oh6rliqjop6blj5Hova7mkq0KICAgICAqIGRhdGEtb2N0b3B1c3VpLXNsaWRlci1hZGFwdGl2ZSDlpoLmnpzorr7nva7mraTlsZ7mgKcg5YiZ6L2u5pKt5Zu+5Lul6buY6K6k5aSn5bCP6Ieq5Yqo5pKR5byACiAgICAgKiBkYXRhLW9jdG9wdXN1aS1zbGlkZXItbm90aXRsZSDlpoLmnpzorr7nva7mraTlsZ7mgKcg5YiZ5LiN5YyF5ZCr6L2u5pKt5Zu+55qEdGl0bGUKICAgICAqLwogICAgby5XaWRnZXQuSHRtbFNsaWRlciA9IG8uZGVmaW5lKG8uV2lkZ2V0LlNsaWRlciwgewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBmcmFnbWVudAogICAgICAgICAqIEB0eXBlIHtEb2N1bWVudEZyYWdtZW50fQogICAgICAgICAqIEBkZXNjIOaWh+aho+eijueJhyDnlKjmnaXnlJ/miJDmlLnpgKDlkI7nmoTlrp7pmYVkb20KICAgICAgICAgKi8KICAgICAgICBmcmFnbWVudDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYWRhcHRpdmUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOeUqOadpeehruiupOW9k+WJjei9ruaSreWbvuaYr+WQpuiHquWKqOaSkeW8gAogICAgICAgICAqLwogICAgICAgIGFkYXB0aXZlOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvL+iZveeEtue7p+aJv+iHqm9jdG9wdXMuV2lkZ2V0LlNsaWRlciDkvYbmmK/mnoTpgKDlh73mlbDov5nph4zluIzmnJvkvb/nlKhvY3RvcHVzLldpZGdldOeahOaehOmAoOWHveaVsAogICAgICAgICAgICBvLldpZGdldC5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLmRhdGFGaWVsZCA9IHsKICAgICAgICAgICAgICAgIHRpdGxlOiAidGl0bGUiLAogICAgICAgICAgICAgICAgdXJsOiAidXJsIgogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IHRoaXMuZWwucGFyZW50Tm9kZTsKICAgICAgICAgICAgdGhpcy5mcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgdGhpcy51bmxvYWRJbWFnZSA9IFtdOwogICAgICAgICAgICB0aGlzLmxvb3AgPSBvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktc2xpZGVyLWxvb3AiKTsKICAgICAgICAgICAgdGhpcy5oYXNCdXR0b24gPSAhby5kb20uZGF0YSh0aGlzLmVsLCAib2N0b3B1c3VpLXNsaWRlci1ub2J1dHRvbiIpOwogICAgICAgICAgICB0aGlzLmhhc0dpem1vcyA9ICFvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktc2xpZGVyLW5vZ2l6bW9zIik7CiAgICAgICAgICAgIHRoaXMuZGlzYWJsZUFsbCA9IG8uZG9tLmRhdGEodGhpcy5lbCwgIm9jdG9wdXN1aS1zbGlkZXItZGlzYWJsZSIpOwogICAgICAgICAgICB0aGlzLmlzRGlzYWJsZUEgPSBvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktc2xpZGVyLWRpc2FibGV0YXAiKTsKICAgICAgICAgICAgdGhpcy5hdXRvUGxheSA9ICFvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktc2xpZGVyLW5vdGF1dG8iKTsKICAgICAgICAgICAgdGhpcy5hZGFwdGl2ZSA9IG8uZG9tLmRhdGEodGhpcy5lbCwgIm9jdG9wdXN1aS1zbGlkZXItYWRhcHRpdmUiKTsKICAgICAgICAgICAgdGhpcy5oYXNUaXRsZSA9ICFvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktc2xpZGVyLW5vdGl0bGUiKTsKICAgICAgICAgICAgdGhpcy5kaXNTY3JvbGwgPSBvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktc2xpZGVyLWRpc3Njcm9sbCIpOwogICAgICAgICAgICB0aGlzLmJ1aWxkU2VsZigpOwogICAgICAgICAgICBpZighdGhpcy5pc1Nob3cpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCF0aGlzLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMuYXV0b1BsYXkgJiYgdGhpcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5ub3RpZnkoInNsaWRlci11aS1hZnRlcnJlbmRlciIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBidWlsZFNlbGYKICAgICAgICAgKiBAZGVzYyDnlJ/miJDoh6rouqvoioLngrkKICAgICAgICAgKi8KICAgICAgICBidWlsZFNlbGY6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLmVsLmNoaWxkcmVuLAogICAgICAgICAgICAgICAgbGVuID0gY2hpbGRyZW4ubGVuZ3RoOwogICAgICAgICAgICBpZihsZW4gPCAyKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gbGVuOwogICAgICAgICAgICB0aGlzLmRhdGEgPSBbXTsKICAgICAgICAgICAgdGhpcy5kb21zID0gW107CiAgICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5lbC5jbG9uZU5vZGUoZmFsc2UpOwogICAgICAgICAgICB0aGlzLmJ1aWxkRG9tcyhub2RlKTsKICAgICAgICAgICAgdGhpcy5idWlsZFNsaWRlcihjaGlsZHJlbik7CiAgICAgICAgICAgIG5vZGUuYXBwZW5kQ2hpbGQodGhpcy52aWV3RGl2KTsKICAgICAgICAgICAgdGhpcy5lbC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChub2RlLCB0aGlzLmVsKTsKICAgICAgICAgICAgdGhpcy5lbCA9IG5vZGU7CiAgICAgICAgICAgIHRoaXMuZWwuc3R5bGUuY3NzVGV4dCA9ICJvdmVyZmxvdzogaGlkZGVuOyBwb3NpdGlvbjogcmVsYXRpdmU7IjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYnVpbGRTbGlkZXIKICAgICAgICAgKiBAZGVzYyDnlJ/miJDova7mkq3lm74KICAgICAgICAgKi8KICAgICAgICBidWlsZFNsaWRlcjogZnVuY3Rpb24oaXRlbXMpIHsKICAgICAgICAgICAgby51dGlsLmVhY2goaXRlbXMsIG8udXRpbC5iaW5kKHRoaXMuYnVpbGRJdGVtLCB0aGlzKSk7CiAgICAgICAgICAgIGlmKHRoaXMubG9vcCAmJiB0aGlzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIHZhciBmcmlzdGRvbSA9IHRoaXMuZG9tc1swXS5jbG9uZU5vZGUodHJ1ZSksCiAgICAgICAgICAgICAgICAgICAgbGFzdGRvbSA9IHRoaXMuZG9tc1t0aGlzLmxlbmd0aCAtIDFdLmNsb25lTm9kZSh0cnVlKTsKICAgICAgICAgICAgICAgIHRoaXMuZG9tcy5wdXNoKGZyaXN0ZG9tKTsKICAgICAgICAgICAgICAgIHRoaXMuZG9tcy5wdXNoKGxhc3Rkb20pOwogICAgICAgICAgICAgICAgdGhpcy5mcmFnbWVudC5hcHBlbmRDaGlsZChmcmlzdGRvbSk7CiAgICAgICAgICAgICAgICB0aGlzLmZyYWdtZW50LmFwcGVuZENoaWxkKGxhc3Rkb20pOwogICAgICAgICAgICAgICAgdGhpcy5sZW5ndGggKz0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNldEN1cnJlbnQoewogICAgICAgICAgICAgICAgZG9tOiB0aGlzLmRvbXNbMF0sCiAgICAgICAgICAgICAgICBpbmRleDogMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy52aWV3RGl2LmFwcGVuZENoaWxkKHRoaXMuZnJhZ21lbnQpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCByZW5kZXIKICAgICAgICAgKiBAZGVzYyDpmLLmraLooqvosIPnlKgKICAgICAgICAgKi8KICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRoaXMgY2xhc3MgY2FuJ3QgcmVuZGVyISA6KSIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBidWlsZEl0ZW0KICAgICAgICAgKiBAZGVzYyDnlJ/miJDmr4/lvKDljZXlvKDnmoTova7mkq3lm74KICAgICAgICAgKi8KICAgICAgICBidWlsZEl0ZW06IGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CiAgICAgICAgICAgIGlmKCFvLnV0aWwuaXNOb2RlKGl0ZW0pKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuZGF0YS5wdXNoKHsKICAgICAgICAgICAgICAgIHVybDogby5kb20uZGF0YShpdGVtLCAib2N0b3B1c3VpLXNsaWRlci11cmwiKSwKICAgICAgICAgICAgICAgIHRpdGxlOiBvLmRvbS5kYXRhKGl0ZW0sICJvY3RvcHVzdWktc2xpZGVyLXRpdGxlIikKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBkb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXNsaWRlci1jaGlsZHJlbiIsCiAgICAgICAgICAgICAgICAgICAgInN0eWxlIjogIi13ZWJraXQtdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKTsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKTsgcG9zaXRpb246IHJlbGF0aXZlOyIKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgX2l0ZW0gPSBpdGVtLmNsb25lTm9kZSh0cnVlKSwKICAgICAgICAgICAgICAgIF9pdGVtY3NzVGV4dCA9ICJ3aWR0aDogMTAwJTsiOwogICAgICAgICAgICAhdGhpcy5hZGFwdGl2ZSAmJiAoX2l0ZW1jc3NUZXh0ICs9ICIgcG9zaXRpb246IGFic29sdXRlOyBsZWZ0OiAwOyByaWdodDogMDsgdG9wOiAwOyBib3R0b206IDA7IG1hcmdpbjogYXV0bzsiLCB0cnVlKTsKICAgICAgICAgICAgX2l0ZW0uc3R5bGUuY3NzVGV4dCA9IF9pdGVtY3NzVGV4dDsKICAgICAgICAgICAgZG9tLmFwcGVuZENoaWxkKF9pdGVtKTsKICAgICAgICAgICAgdmFyIHRpdGxlID0gdGhpcy5nZXREYXRhQnkoaW5kZXgsICJ0aXRsZSIpOwogICAgICAgICAgICBpZih0aGlzLmhhc1RpdGxlICYmIHRpdGxlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGl0bGVkb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgImNsYXNzIjogIm9jdG9wdXN1aS1zbGlkZXItaW1nVGl0bGUiCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgdGl0bGVjb250ZW50ID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJjbGFzcyI6ICJvY3RvcHVzdWktc2xpZGVyLWltZ1RpdGxlQ29udGVudCBvY3RvcHVzdWktdGV4dC1saW1pdCIKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRpdGxlY29udGVudC5pbm5lckhUTUwgPSBvLnV0aWwuZW5jb2RlSHRtbCh0aXRsZSk7CiAgICAgICAgICAgICAgICB0aXRsZWRvbS5hcHBlbmRDaGlsZCh0aXRsZWNvbnRlbnQpOwogICAgICAgICAgICAgICAgZG9tLmFwcGVuZENoaWxkKHRpdGxlZG9tKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBfX3VybCA9IHRoaXMuZ2V0RGF0YUJ5KGluZGV4LCAidXJsIikgfHwgIiIsCiAgICAgICAgICAgICAgICBfX3RhcmdldCA9IHRoaXMuaXNOZXdUYWIgPyAiX2JsYW5rIiA6ICJfc2VsZiI7CiAgICAgICAgICAgIG8uZXZlbnQub24oZG9tLCAiY2xpY2siLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LmlzRGlzYWJsZUEpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cub3BlbihfX3VybCwgX190YXJnZXQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoYXQubm90aWZ5KCJzbGlkZXItaXRlbS1vbnRhcCIsIHRoYXQuZGF0YVtpbmRleF0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5mcmFnbWVudC5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICB0aGlzLmRvbXMucHVzaChkb20pOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLldpZGdldC5IdG1sU2xpZGVyIgogICAgfSk7Cgp9KShvY3RvcHVzKTsvKioKICogQGZpbGUKICogd2ViYXBw6YCa55So57uE5Lu257uT5p6E5paH5Lu2CiAqIOWumuS5ieaooeWdl+euoeeQhgogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQHJlcXVpcmUgbGliL2RvbS5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCgkvKioKCSAqIEBuYW1lc3BhY2Ugb2N0b3B1cy5hcHAKCSAqIEBkZXNjIG9jdG9wdXMgYXBw5qih5Z2X57uT5p6ECgkgKi8KICAgIG8uYXBwID0gKGZ1bmN0aW9uKCkgewoKICAgICAgICB2YXIgYXBwID0gbnVsbDsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLnJlZ2lzdGVyTW9kdWxlCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICogQHBhcmFtIGZ1bmMKICAgICAgICAgKiBAcGFyYW0gaW1tZWRpYXRlCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJNb2R1bGUoaWQsIGZ1bmMsIGltbWVkaWF0ZSkgewogICAgICAgICAgICBpbml0aWFsaXplKHVuZGVmaW5lZCkucmVnaXN0ZXJNb2R1bGUoaWQsIGZ1bmMsIGltbWVkaWF0ZSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgaW5pdGlhbGl6ZQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gaW5pdGlhbGl6ZShvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiAhYXBwID8gKGFwcCA9IG5ldyBvLkFwcChvcHRpb25zKSwgYXBwKSA6ICghIW9wdGlvbnMgPyAoY29uc29sZS53YXJuKCJUaGUgYXBwIGhhcyBhbHJlYWR5IGV4aXN0ISBGYWlsdXJlIHRvIHNldCB1cCB0aGUgY29uZmlnIiksIGFwcCkgOiBhcHApOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLmFkZENvbmZpZwogICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAqIEBwYXJhbSBvYmoKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBhZGRDb25maWcoaWQsIG9iaikgewogICAgICAgICAgICBpbml0aWFsaXplKHVuZGVmaW5lZCkuYWRkQ29uZmlnKGlkLCBvYmopOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLnJlZ2lzdGVyQXBpCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICogQHBhcmFtIG9iagogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyQXBpKGlkLCBvYmopewogICAgICAgICAgICBpbml0aWFsaXplKHVuZGVmaW5lZCkucmVnaXN0ZXJBcGkoaWQsIG9iaik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHB1YmxpYwogICAgICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLmFkZENvbmZpZwogICAgICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgICAgICogQHBhcmFtIG9iagogICAgICAgICAgICAgKi8KICAgICAgICAgICAgYWRkQ29uZmlnOiBhZGRDb25maWcsCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHB1YmxpYwogICAgICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLnJlZ2lzdGVyQXBpCiAgICAgICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAgICAgKiBAcGFyYW0gb2JqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZWdpc3RlckFwaTogcmVnaXN0ZXJBcGksCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHB1YmxpYwogICAgICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLnJlZ2lzdGVyTW9kdWxlCiAgICAgICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAgICAgKiBAcGFyYW0gZnVuYwogICAgICAgICAgICAgKiBAcGFyYW0gaW1tZWRpYXRlCiAgICAgICAgICAgICAqIEBkZXNjIOazqOWGjOS4gOS4quaooeWdlwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcmVnaXN0ZXJNb2R1bGU6IHJlZ2lzdGVyTW9kdWxlLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFwcC5pbml0aWFsaXplCiAgICAgICAgICAgICAqIEBwYXJhbSBvcHRpb25zCiAgICAgICAgICAgICAqIEBkZXNjIOWIneWni+WMlmFwcOWvueixoSDlpoLmnpzkuI3ooqvosIPnlKjliJnmjInnhafpu5jorqTlsZ7mgKfliJ3lp4vljJYKICAgICAgICAgICAgICogQHJldHVybnMge29jdG9wdXMuQXBwfGFwcH0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGluaXRpYWxpemU6IGluaXRpYWxpemUKICAgICAgICB9OwogICAgfSkoKTsKCiAgICBvLkFwcCA9IG8uZGVmaW5lKHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaWQKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGlkOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqIEBkZXNjIGFwcOeahOagueiKgueCuQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB2aWV3RWwKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDlj6/op4boioLngrkKICAgICAgICAgKi8KICAgICAgICB2aWV3RWw6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGxheWVycwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAZGVzYyDnrqHnkIbnmoTmqKHlnZcKICAgICAgICAgKi8KICAgICAgICBsYXllcnM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGN1cnJlbnRMYXllcgogICAgICAgICAqIEB0eXBlIHtvLkxheWVyfQogICAgICAgICAqLwogICAgICAgIGN1cnJlbnRMYXllcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY21kcwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBjbWRzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBtQ3JlYXRvcgogICAgICAgICAqIEBkZXNjIOeUn+aIkOWZqAogICAgICAgICAqLwogICAgICAgIG1DcmVhdG9yOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBldmVudHMKICAgICAgICAgKiBAdHlwZSB7by5FdmVudHN9CiAgICAgICAgICovCiAgICAgICAgZXZlbnRzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBldmVudExpc3RlbmVycwogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgZXZlbnRMaXN0ZW5lcnM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNtZE1hbmFnZXIKICAgICAgICAgKiBAdHlwZSB7by5DbWRNYW5hZ2VyfQogICAgICAgICAqLwogICAgICAgIGNtZE1hbmFnZXI6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50Q2FjaGVzCiAgICAgICAgICogQGRlc2Mg5LqL5Lu257yT5a2YIOS4u+imgemYsuatoiDkuIDkupvmqKHlnZfmnKrlsLHkvY3ml7bnmoTkuovku7bliIblj5EKICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICovCiAgICAgICAgZXZlbnRDYWNoZXM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzTG9hZAogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzTG9hZDogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNvbmZpZwogICAgICAgICAqIEBkZXNjIOmFjee9rumhuQogICAgICAgICAqLwogICAgICAgIGNvbmZpZzogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNSZXNpemUKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc1Jlc2l6ZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHdpZGdldHMKICAgICAgICAgKi8KICAgICAgICB3aWRnZXRzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc0luaXREb20KICAgICAgICAgKi8KICAgICAgICBpc0luaXREb206IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjYWNoZUV2ZW50RGlzcGF0Y2gKICAgICAgICAgKiBAZGVzYyDkuovku7bnvJPlhrLlmagKICAgICAgICAgKi8KICAgICAgICBjYWNoZUV2ZW50RGlzcGF0Y2g6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNvbmZpZ3MKICAgICAgICAgKiBAZGVzYyDphY3nva7pobkKICAgICAgICAgKi8KICAgICAgICBjb25maWdzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGNvbmZpZyA9IHRoaXMuY29uZmlnID0gby5leHRlbmQoe30sIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLm1DcmVhdG9yID0ge307CiAgICAgICAgICAgIHRoaXMuZXZlbnRDYWNoZXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jb25maWdzID0ge307CiAgICAgICAgICAgIHRoaXMuY2FjaGVFdmVudERpc3BhdGNoID0ge307CiAgICAgICAgICAgIHRoaXMuaWQgPSBjb25maWcuaWQgfHwgby51dGlsLmNyZWF0ZVVuaXF1ZUlEKHRoaXMuQ0xBU1NfTkFNRSArICJfIik7CgogICAgICAgICAgICAvL+ebkeWQrHdpbmRvd+S6i+S7tiDlkK/liqjmqKHlnZcKICAgICAgICAgICAgby5ldmVudC5vbih3aW5kb3csICJyZWFkeSIsIG8udXRpbC5iaW5kKHRoaXMub25XaW5kb3dMb2FkLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICBvLmV2ZW50Lm9uKHdpbmRvdywgInVubG9hZCIsIG8udXRpbC5iaW5kKHRoaXMub25XaW5kb3dVbmxvYWQsIHRoaXMpLCBmYWxzZSk7CiAgICAgICAgICAgIG8uZXZlbnQub24od2luZG93LCAicmVzaXplIiwgby51dGlsLmJpbmQodGhpcy5vbldpbmRvd1Jlc2l6ZSwgdGhpcyksIGZhbHNlKTsKICAgICAgICAgICAgaWYoIm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cpIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQub24od2luZG93LCAib3JpZW50YXRpb25jaGFuZ2UiLCBvLnV0aWwuYmluZCh0aGlzLm9uT3JpZW50YXRpb25DaGFuZ2VkLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gbmV3IG8uRXZlbnRzKHRoaXMpOwogICAgICAgICAgICBpZihjb25maWcuZXZlbnRMaXN0ZW5lcnMgJiYgby51dGlsLmlzT2JqZWN0KGNvbmZpZy5ldmVudExpc3RlbmVycykpIHsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRMaXN0ZW5lcnMgPSBjb25maWcuZXZlbnRMaXN0ZW5lcnM7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50cy5yZWdpc3Rlcih0aGlzLmV2ZW50TGlzdGVuZXJzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvL+WRveS7pOaQnuS4iuWOuwogICAgICAgICAgICB0aGlzLmNtZE1hbmFnZXIgPSBuZXcgby5DbWRNYW5hZ2VyKHsKICAgICAgICAgICAgICAgIGFwcDogdGhpcwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYoY29uZmlnLmNtZHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuY21kcyA9IGNvbmZpZy5jbWRzOwogICAgICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5jbWRzLCBvLnV0aWwuYmluZCh0aGlzLnJlZ2lzdGVyQ21kLCB0aGlzKSk7CiAgICAgICAgICAgICAgICB0aGlzLmNtZHMubGVuZ3RoID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnJlZ2lzdGVyQ21kCiAgICAgICAgICogQHBhcmFtIGNtZCB7b2N0b3B1cy5DbWR9CiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXJDbWQ6IGZ1bmN0aW9uKGNtZCkgewogICAgICAgICAgICB0aGlzLmNtZE1hbmFnZXIucmVnaXN0ZXIoY21kKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5leGVjdXRlQ21kCiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gb3BzIHtPYmplY3R9CiAgICAgICAgICogQGRlc2Mg5omn6KGM5oyH5a6a5ZG95LukCiAgICAgICAgICovCiAgICAgICAgZXhlY3V0ZUNtZDogZnVuY3Rpb24obmFtZSwgb3BzKSB7CiAgICAgICAgICAgIHRoaXMuY21kTWFuYWdlci5leGVjdXRlQ29tbWFuZChuYW1lLCBvcHMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnVucmVnaXN0ZXJDbWQKICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHVucmVnaXN0ZXJDbWQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgdGhpcy5jbWRNYW5hZ2VyLnVucmVnaXN0ZXIobmFtZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAucmVnaXN0ZXJNZW1iZXIKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDms6jlhoznmoTnp43nsbsg5Y+v6YCJ5qih5Z2X5oiW6ICFYXBpCiAgICAgICAgICogQHBhcmFtIGlkIHtTdHJpbmd9IOazqOWGjOeahGlkCiAgICAgICAgICogQHBhcmFtIGNyZWF0b3Ige09iamVjdCB8IEZ1bmN0aW9ufSDmnoTpgKDlmagKICAgICAgICAgKi8KICAgICAgICByZWdpc3Rlck1lbWJlcjogZnVuY3Rpb24odHlwZSwgaWQsIGNyZWF0b3IpIHsKICAgICAgICAgICAgdGhpcy5tQ3JlYXRvclt0eXBlXSA9IHRoaXMubUNyZWF0b3JbdHlwZV0gfHwge307CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1DcmVhdG9yW3R5cGVdW2lkXSA9IHsKICAgICAgICAgICAgICAgIGNyZWF0b3I6IGNyZWF0b3IsCiAgICAgICAgICAgICAgICBpbnN0YW5jZTogbnVsbAogICAgICAgICAgICB9OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnN0YXJ0TWVtYmVyCiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBzdGFydE1lbWJlcjogZnVuY3Rpb24odHlwZSwgaWQpIHsKICAgICAgICAgICAgdmFyIGNyZWF0b3IgPSB0aGlzLm1DcmVhdG9yW3R5cGVdW2lkXTsKICAgICAgICAgICAgaWYoIWNyZWF0b3IgfHwgY3JlYXRvci5pbnN0YW5jZSkgICByZXR1cm47CiAgICAgICAgICAgIGNyZWF0b3IuaW5zdGFuY2UgPSBjcmVhdG9yLmNyZWF0b3IodGhpcywgdGhpcy5nZXRDb25maWcoaWQpKTsKICAgICAgICAgICAgY3JlYXRvci5pbnN0YW5jZS5pbml0ICYmIGNyZWF0b3IuaW5zdGFuY2UuaW5pdCgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnJlZ2lzdGVyQXBpCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICogQHBhcmFtIG0KICAgICAgICAgKi8KICAgICAgICByZWdpc3RlckFwaTogZnVuY3Rpb24oaWQsIG0pIHsKICAgICAgICAgICAgdGhpcy5yZWdpc3Rlck1lbWJlcigiYXBpIiwgaWQsIG0pOwogICAgICAgICAgICB0aGlzLnN0YXJ0QXBpKGlkKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5yZWdpc3Rlck1vZHVsZQogICAgICAgICAqIEBwYXJhbSBpZCB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBtIHtPYmplY3QgfCBzci5Nb2R1bGV9CiAgICAgICAgICogQHBhcmFtIGltbWVkaWF0ZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICByZWdpc3Rlck1vZHVsZTogZnVuY3Rpb24oaWQsIG0sIGltbWVkaWF0ZSkgewogICAgICAgICAgICB0aGlzLnJlZ2lzdGVyTWVtYmVyKCJtb2R1bGUiLCBpZCwgbSk7CiAgICAgICAgICAgIHJldHVybiAodGhpcy5pc0xvYWQgfHwgISFpbW1lZGlhdGUpID8gKHRoaXMuc3RhcnRNb2R1bGUoaWQpLCB0cnVlKSA6IGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBzdGFydE1vZHVsZQogICAgICAgICAqIEBwYXJhbSBpZCB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHN0YXJ0TW9kdWxlOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICB0aGlzLnN0YXJ0TWVtYmVyKCJtb2R1bGUiLCBpZCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnN0YXJ0QXBpCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICovCiAgICAgICAgc3RhcnRBcGk6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHRoaXMuc3RhcnRNZW1iZXIoImFwaSIsIGlkKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0QXBpCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICovCiAgICAgICAgZ2V0QXBpOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5tQ3JlYXRvclsiYXBpIl1baWRdLmluc3RhbmNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5nZXRNb2R1bGUKICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBnZXRNb2R1bGU6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1DcmVhdG9yWyJtb2R1bGUiXVtpZF0uaW5zdGFuY2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHN0b3BNb2R1bGUKICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBzdG9wTW9kdWxlOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICB2YXIgbW9kdWxlSXRlbSA9IHRoaXMubUNyZWF0b3JbIm1vZHVsZSJdW2lkXTsKICAgICAgICAgICAgaWYoIW1vZHVsZUl0ZW0uaW5zdGFuY2UpICAgcmV0dXJuOwogICAgICAgICAgICBpZiAobW9kdWxlSXRlbS5pbnN0YW5jZS5kZXN0cm95KSB7CiAgICAgICAgICAgICAgICBtb2R1bGVJdGVtLmluc3RhbmNlLmRlc3Ryb3koKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtb2R1bGVJdGVtLmluc3RhbmNlID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5vbgogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOS6i+S7tuWQjQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g5Zue6LCDCiAgICAgICAgICovCiAgICAgICAgb246IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMub24odHlwZSwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAudW4KICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDkuovku7blkI0KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IOWbnuiwgwogICAgICAgICAqLwogICAgICAgIHVuOiBmdW5jdGlvbih0eXBlLCBmdW5jKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzLnVuKHR5cGUsIGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLm5vdGlmeQogICAgICAgICAqIEBkZXNjIOinpuWPkeafkOiHquWumuS5ieS6i+S7tgogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGV2dCB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIG5vdGlmeTogZnVuY3Rpb24odHlwZSwgZXZ0KSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmlzTG9hZCkgewogICAgICAgICAgICAgICAgdGhpcy5ldmVudENhY2hlcy5wdXNoKFt0eXBlLCBldnRdKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmV2ZW50cy50cmlnZ2VyRXZlbnQodHlwZSwgZXZ0KTsKICAgICAgICAgICAgZm9yKHZhciBrIGluIHRoaXMuY2FjaGVFdmVudERpc3BhdGNoKSB7CiAgICAgICAgICAgICAgICBpZihrLmluZGV4T2YodHlwZSkgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJFdmVudERpc3BhdGNoKGssIHR5cGUsIGV2dCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAudHJpZ2dlckV2ZW50RGlzcGF0Y2gKICAgICAgICAgKiBAZGVzYyDpgJrnn6XnvJPlhrLlmagg5rS75p2l5LqGCiAgICAgICAgICogQHBhcmFtIGlkIOe8k+WGsuWZqOeahGtleQogICAgICAgICAqIEBwYXJhbSB0eXBlIOWujOaIkOeahOW3peS9nHR5cGUKICAgICAgICAgKiBAcGFyYW0gZXZ0IOWujOaIkOeahOW3peS9nOW4puadpeeahOWPmOmHjwogICAgICAgICAqLwogICAgICAgIHRyaWdnZXJFdmVudERpc3BhdGNoOiBmdW5jdGlvbihpZCwgdHlwZSwgZXZ0KSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHRoaXMuY2FjaGVFdmVudERpc3BhdGNoW2lkXTsKICAgICAgICAgICAgaWYoIWRpc3BhdGNoICYmIGRpc3BhdGNoLmhpdEZsYWcgPT0gZGlzcGF0Y2guaGl0cyAgfHwgZGlzcGF0Y2hbImNhY2hlRGF0YSJdW3R5cGVdKSAgcmV0dXJuOwogICAgICAgICAgICBkaXNwYXRjaFsiY2FjaGVEYXRhIl1bdHlwZV0gPSBldnQ7CiAgICAgICAgICAgIGlmKCsrZGlzcGF0Y2guaGl0RmxhZyA9PSBkaXNwYXRjaC5oaXRzKSB7CiAgICAgICAgICAgICAgICBkaXNwYXRjaC5mdW5jLmFwcGx5KHRoaXMsIFtkaXNwYXRjaC5jYWNoZURhdGFdKTsKICAgICAgICAgICAgICAgIGRpc3BhdGNoID0gbnVsbDsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhY2hlRXZlbnREaXNwYXRjaFtpZF07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5hZGRDb25maWcKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKiBAcGFyYW0gY29uZmlnCiAgICAgICAgICovCiAgICAgICAgYWRkQ29uZmlnOiBmdW5jdGlvbihpZCwgY29uZmlnKXsKICAgICAgICAgICAgY29uZmlnID0gY29uZmlnIHx8IHt9OwogICAgICAgICAgICB2YXIgYywgcDsKICAgICAgICAgICAgaWYoaWQpIHsKICAgICAgICAgICAgICAgIGMgPSB0aGlzLmNvbmZpZ3NbaWRdID0gdGhpcy5jb25maWdzW2lkXSB8fCB7fTsKICAgICAgICAgICAgICAgIGZvcihwIGluIGNvbmZpZykgewogICAgICAgICAgICAgICAgICAgIGNbcF0gPSBjb25maWdbcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IocCBpbiBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZ3NbcF0gPSBjb25maWdbcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuZ2V0Q29uZmlnCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICovCiAgICAgICAgZ2V0Q29uZmlnOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jb25maWdzW2lkXSB8fCB7fTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5pbnZva2VFdmVudERpc3BhdGNoCiAgICAgICAgICogQGRlc2Mg5ZCv55So5LiA5Liq5LqL5Lu257yT5Yay5ZmoIOeUqOadpeWkhOeQhuWkmuasoeS6i+S7tuWujOaIkOaJjeWBmuafkOS6i+aDheeahOmcgOaxggogICAgICAgICAqLwogICAgICAgIGludm9rZUV2ZW50RGlzcGF0Y2g6IGZ1bmN0aW9uKGV2ZW50cywgZnVuYykgewogICAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSB0aGlzLmNhY2hlRXZlbnREaXNwYXRjaFtldmVudHNdLAogICAgICAgICAgICAgICAgbGVuID0gU3RyaW5nKGV2ZW50cykuc3BsaXQoIiwiKS5sZW5ndGg7CiAgICAgICAgICAgIGlmKGRpc3BhdGNoICYmIGRpc3BhdGNoLmhpdEZsYWcgPT0gbGVuKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRoaXMga2luZCBvZiBFdmVudERpc3BhdGNoIGhhcyBhbHJlYWR5IGludm9rZWQhIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jYWNoZUV2ZW50RGlzcGF0Y2hbZXZlbnRzXSA9IHRoaXMuY2FjaGVFdmVudERpc3BhdGNoW2V2ZW50c10gfHwgewogICAgICAgICAgICAgICAgaGl0czogbGVuLAogICAgICAgICAgICAgICAgaGl0RmxhZzogMCwKICAgICAgICAgICAgICAgIGNhY2hlRGF0YToge30sCiAgICAgICAgICAgICAgICBmdW5jOiBmdW5jCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uV2luZG93TG9hZAogICAgICAgICAqIEBkZXNjIOebkeWQrG9ubG9hZOS6i+S7tgogICAgICAgICAqLwogICAgICAgIG9uV2luZG93TG9hZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5tQ3JlYXRvclsibW9kdWxlIl0sIGZ1bmN0aW9uKGl0ZW0sIGspIHsKICAgICAgICAgICAgICAgIHRoYXQuc3RhcnRNb2R1bGUoayk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmlzTG9hZCA9IHRydWU7CiAgICAgICAgICAgIGlmKHRoaXMuZXZlbnRDYWNoZXMpIHsKICAgICAgICAgICAgICAgIHZhciBpdGVtOwogICAgICAgICAgICAgICAgd2hpbGUoaXRlbSA9IHRoaXMuZXZlbnRDYWNoZXMuc2hpZnQoKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubm90aWZ5KGl0ZW1bMF0sIGl0ZW1bMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJHbG9iYWwtT2N0b3B1c0FwcC1Nb2R1bGVDb21wbGV0ZWQiLCB7fSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uV2luZG93VW5sb2FkCiAgICAgICAgICogQGRlc2Mg55uR5ZCs6aG16Z2i55qEdW5sb2Fk5LqL5Lu2IOmSiOWvueS9jueJiOacrOa1j+iniOWZqCDkuLvopoHlgZrkuIDkupvlhoXlrZjlm57mlLblt6XkvZwg6Iez5LqO6auY57qn5rWP6KeI5ZmoIOWlveWQpyDkvaDlj6/ku6XorqTkuLrmiJHlnKjoh6rmrLrmrLrkuroKICAgICAgICAgKi8KICAgICAgICBvbldpbmRvd1VubG9hZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5tQ3JlYXRvclsibW9kdWxlIl0sIGZ1bmN0aW9uKGl0ZW0sIGspIHsKICAgICAgICAgICAgICAgIHRoYXQuc3RvcE1vZHVsZShpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAucmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcmVuZGVyOiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICBpZighdGhpcy5pc0xvYWQpICAgIGNvbnNvbGUuZXJyb3IoIlRoZSBwYWdlIGhhc24ndCBsb2FkZWQhIik7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgaWYoIWVsKSAgICBjb25zb2xlLmVycm9yKCJJbnZhbGlkIG5vZGUgdG8gcmVuZGVyISIpOwogICAgICAgICAgICB0aGlzLmluaXREb21Nb2RlKGVsKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgaW5pdERvbU1vZGUKICAgICAgICAgKi8KICAgICAgICBpbml0RG9tTW9kZTogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgLy/oioLngrnmqKHlvI8KICAgICAgICAgICAgdGhpcy5pc0luaXREb20gPSB0cnVlOwogICAgICAgICAgICB2YXIgY29uZmlnID0gdGhpcy5jb25maWcsCiAgICAgICAgICAgICAgICBub2RlID0gZWwsCiAgICAgICAgICAgICAgICBpZCA9IHRoaXMuaWQgKyAiX09jdG9wdXNfVmlld1BvcnQiOwogICAgICAgICAgICB0aGlzLmVsID0gby5kb20uY2xvbmVOb2RlKG5vZGUsIHRydWUpOwogICAgICAgICAgICB0aGlzLnZpZXdFbCA9IG8uZG9tLmNyZWF0ZURvbSgiZGl2IiwgewogICAgICAgICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgICAgICAgImNsYXNzIjogIm9jdG9wdXMtdmlld3BvcnQiLAogICAgICAgICAgICAgICAgc3R5bGU6ICJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOyBwb3NpdGlvbjogcmVsYXRpdmU7IHotaW5kZXg6IDMwMDsgb3ZlcmZsb3c6IGhpZGRlbiIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuZWwuYXBwZW5kQ2hpbGQodGhpcy52aWV3RWwpOwogICAgICAgICAgICAvL+WmguaenOaYr+iKgueCueaooeW8j+S4lOaLpeacieWbvuWxggogICAgICAgICAgICBpZihjb25maWcubGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBvLnV0aWwuZWFjaChjb25maWcubGF5ZXJzLCBvLnV0aWwuYmluZCh0aGlzLmFkZExheWVyLCB0aGlzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy/lpoLmnpzmmK/oioLngrnmqKHlvI/kuJTliJ3lp4vljJZ3aWRnZXTmjqfku7YKICAgICAgICAgICAgaWYoY29uZmlnLndpZGdldHMpIHsKICAgICAgICAgICAgICAgIG8udXRpbC5lYWNoKGNvbmZpZy53aWRnZXRzLCBvLnV0aWwuYmluZCh0aGlzLmFkZFdpZGdldCwgdGhpcykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJHbG9iYWwtT2N0b3B1c0FwcC1CZWZvcmVBcHBDb21wbGV0ZWQiKTsKICAgICAgICAgICAgLy/miorooqvmkJ7lvpfpnaLnm67lhajpnZ7nmoRlbOWKoOWFpeaWh+aho+a1gQogICAgICAgICAgICBpZihub2RlKSB7CiAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMuZWwsIG5vZGUpOwogICAgICAgICAgICAgICAgdGhpcy5ub3RpZnkoIkdsb2JhbC1PY3RvcHVzQXBwLUFwcENvbXBsZXRlZCIpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uT3JpZW50YXRpb25DaGFuZ2VkCiAgICAgICAgICogQGRlc2Mg55uR5ZCs5qiq56uW5bGP5YiH5o2i5LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgb25PcmllbnRhdGlvbkNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLm5vdGlmeSgiR2xvYmFsLU9jdG9wdXNBcHAtT25PcmllbnRhdGlvbkNoYW5nZWQiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25XaW5kb3dSZXNpemUKICAgICAgICAgKi8KICAgICAgICBvbldpbmRvd1Jlc2l6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmlzUmVzaXplKSB7CiAgICAgICAgICAgICAgICBvLnV0aWwucmVxdWVzdEFuaW1hdGlvbihvLnV0aWwuYmluZCh0aGlzLmNoZWNrU2l6ZSwgdGhpcykpOwogICAgICAgICAgICAgICAgdGhpcy5pc1Jlc2l6ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgY2hlY2tTaXplCiAgICAgICAgICovCiAgICAgICAgY2hlY2tTaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5pc1Jlc2l6ZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm5vdGlmeSgiR2xvYmFsLU9jdG9wdXNBcHAtT25XaW5kb3dSZXNpemUiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5hZGRMYXllcgogICAgICAgICAqIEBkZXNjIOe7meW9k+WJjWRvbeS4iuWinuWKoOWbvuWxgiDlpoLmnpzkuI3lrZjlnKh0aGlzLmVsIOWImeatpOaWueazleayoeWunumZheaViOaenAogICAgICAgICAqIEBwYXJhbSBsYXllciB7b2N0b3B1cy5MYXllcn0KICAgICAgICAgKi8KICAgICAgICBhZGRMYXllcjogZnVuY3Rpb24obGF5ZXIpIHsKICAgICAgICAgICAgaWYoIXRoaXMubGF5ZXJzKSAgICB0aGlzLmxheWVycyA9IFtdOwogICAgICAgICAgICBpZih0aGlzLmxheWVycy5pbmRleE9mKGxheWVyKSAhPSAtMSkgIHJldHVybjsKICAgICAgICAgICAgdmFyIGVsID0gbGF5ZXIuZ2V0RWwoKTsKICAgICAgICAgICAgby5kb20uYWRkQ2xhc3MoZWwsICJvY3RvcHVzLWFwcC1sYXllciIpOwogICAgICAgICAgICB0aGlzLnNldExheWVyWkluZGV4KGxheWVyLCB0aGlzLmxheWVycy5sZW5ndGgpOwogICAgICAgICAgICBpZihsYXllci5pc0Jhc2VMYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5lbC5hcHBlbmRDaGlsZChlbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnZpZXdFbC5hcHBlbmRDaGlsZChlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobGF5ZXIuaXNDdXJyZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEN1cnJlbnRMYXllcihsYXllcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5sYXllcnMucHVzaChsYXllcik7CiAgICAgICAgICAgIGxheWVyLnNldEFwcCh0aGlzKTsKICAgICAgICAgICAgdGhpcy5ub3RpZnkoIkdsb2JhbC1PY3RvcHVzQXBwLUxheWVyQWRkIiwge2xheWVyOiBsYXllcn0pOwogICAgICAgICAgICBsYXllci5hZnRlckFkZCgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnNldEN1cnJlbnRMYXllcgogICAgICAgICAqIEBwYXJhbSBsYXllcgogICAgICAgICAqLwogICAgICAgIHNldEN1cnJlbnRMYXllcjogZnVuY3Rpb24obGF5ZXIpIHsKICAgICAgICAgICAgaWYodGhpcy5jdXJyZW50TGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudExheWVyLnNldEN1cnJlbnQoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY3VycmVudExheWVyID0gbGF5ZXI7CiAgICAgICAgICAgIHRoaXMudG9wTGF5ZXIobGF5ZXIpOwogICAgICAgICAgICBsYXllci5zZXRDdXJyZW50KHRydWUpOwogICAgICAgICAgICB0aGlzLm5vdGlmeSgiR2xvYmFsLU9jdG9wdXNBcHAtQ3VycmVudExheWVyQ2hhbmdlZCIsIHtsYXllcjogbGF5ZXJ9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2V0TGF5ZXJaSW5kZXgKICAgICAgICAgKiBAZGVzYyDorr7nva7lm77lsYLnmoRpbmRleAogICAgICAgICAqIEBwYXJhbSBsYXllciB7b2N0b3B1cy5MYXllcn0KICAgICAgICAgKiBAcGFyYW0geklkeCB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHNldExheWVyWkluZGV4OiBmdW5jdGlvbihsYXllciwgeklkeCkgewogICAgICAgICAgICBsYXllci5zZXRaSW5kZXgodGhpcy5aX0lOREVYX0JBU0VbbGF5ZXIuaXNCYXNlTGF5ZXIgPyAiQmFzZUxheWVyIiA6ICJMYXllciJdICsgeklkeCAqIDUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5yZXNldExheWVyc1pJbmRleAogICAgICAgICAqIEBkZXNjIHJlc2V05Zu+5bGCemluZGV4CiAgICAgICAgICovCiAgICAgICAgcmVzZXRMYXllcnNaSW5kZXg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIG8udXRpbC5lYWNoKHRoaXMubGF5ZXJzLCBmdW5jdGlvbihsYXllciwgaSkgewogICAgICAgICAgICAgICAgdGhhdC5zZXRMYXllclpJbmRleChsYXllciwgaSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGdldFRvcFpJbmRleAogICAgICAgICAqLwogICAgICAgIGdldFRvcFpJbmRleDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0b3BJbmRleCA9IHsKICAgICAgICAgICAgICAgIHppbmRleDogMCwKICAgICAgICAgICAgICAgIGluZGV4OiAwCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG8udXRpbC5lYWNoKHRoaXMubGF5ZXJzLCBmdW5jdGlvbihsYXllciwgaSkgewogICAgICAgICAgICAgICAgdmFyIF96aW5kZXggPSBsYXllci5nZXRFbCgpLnN0eWxlLnpJbmRleCB8fCAwOwogICAgICAgICAgICAgICAgaWYoX3ppbmRleCA+IHRvcEluZGV4LnppbmRleCkgewogICAgICAgICAgICAgICAgICAgIHRvcEluZGV4ID0gewogICAgICAgICAgICAgICAgICAgICAgICB6aW5kZXg6IF96aW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRvcEluZGV4OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnRvcExheWVyCiAgICAgICAgICovCiAgICAgICAgdG9wTGF5ZXI6IGZ1bmN0aW9uKGxheWVyKSB7CiAgICAgICAgICAgIHZhciB0b3BJbmRleCA9IHRoaXMuZ2V0VG9wWkluZGV4KCksCiAgICAgICAgICAgICAgICBpbmRleCA9IGxheWVyLmVsLnN0eWxlLnpJbmRleDsKICAgICAgICAgICAgaWYodG9wSW5kZXggPT0gaW5kZXgpCXJldHVybjsKICAgICAgICAgICAgbGF5ZXIuZWwuc3R5bGUuekluZGV4ID0gdG9wSW5kZXguemluZGV4OwogICAgICAgICAgICB0aGlzLmxheWVyc1t0b3BJbmRleC5pbmRleF0uZWwuc3R5bGUuekluZGV4ID0gaW5kZXg7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuZ2V0TGF5ZXIKICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDpnaBpZOiOt+WPluWbvuWxggogICAgICAgICAqLwogICAgICAgIGdldExheWVyOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICB2YXIgbGF5ZXIgPSBudWxsOwogICAgICAgICAgICBvLnV0aWwuZWFjaCh0aGlzLmxheWVycywgZnVuY3Rpb24oX2xheWVyKSB7CiAgICAgICAgICAgICAgICBpZihpZCA9PSBfbGF5ZXIuaWQpIHsKICAgICAgICAgICAgICAgICAgICBsYXllciA9IF9sYXllcjsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBsYXllcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5yZW1vdmVMYXllcgogICAgICAgICAqIEBwYXJhbSBsYXllcgogICAgICAgICAqIEBkZXNjIOWIoOaOieWbvuWxggogICAgICAgICAqLwogICAgICAgIHJlbW92ZUxheWVyOiBmdW5jdGlvbihsYXllcikgewogICAgICAgICAgICBsYXllci5nZXRFbCgpLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobGF5ZXIuZ2V0RWwoKSk7CiAgICAgICAgICAgIG8udXRpbC5yZW1vdmVJdGVtKHRoaXMubGF5ZXJzLCBsYXllcik7CiAgICAgICAgICAgIGxheWVyLnJlbW92ZUFwcCh0aGlzKTsKICAgICAgICAgICAgbGF5ZXIuYXBwID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yZXNldExheWVyc1pJbmRleCgpOwogICAgICAgICAgICB0aGlzLm5vdGlmeSgiR2xvYmFsLU9jdG9wdXNBcHAtTGF5ZXJSZW1vdmUiLCB7bGF5ZXI6IGxheWVyfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuYWRkV2lkZ2V0CiAgICAgICAgICogQHBhcmFtIHdpZGdldCB7b2N0b3B1cy5XaWRnZXR9CiAgICAgICAgICogQHBhcmFtIGF1dG8ge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5re75Yqgd2lkZ2V05YiwYXBw6YeMCiAgICAgICAgICovCiAgICAgICAgYWRkV2lkZ2V0OiBmdW5jdGlvbih3aWRnZXQsIGF1dG8pIHsKICAgICAgICAgICAgaWYoIXRoaXMud2lkZ2V0cykgICAgdGhpcy53aWRnZXRzID0gW107CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMud2lkZ2V0cy5pbmRleE9mKHdpZGdldCk7CiAgICAgICAgICAgIGlmKGluZGV4ID4gLTEpICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHRoaXMud2lkZ2V0cy5wdXNoKHdpZGdldCkKICAgICAgICAgICAgaWYoIWF1dG8pIHsKICAgICAgICAgICAgICAgIHdpZGdldC5jb250YWluZXIgPSB3aWRnZXQub3V0c2lkZVZpZXdwb3J0ID8gdGhpcy5lbCA6IHRoaXMudmlld0VsOwogICAgICAgICAgICAgICAgd2lkZ2V0LnJlbmRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdpZGdldC5zZXRaSW5kZXgodGhpcy5aX0lOREVYX0JBU0UuV2lkZ2V0ICsgdGhpcy53aWRnZXRzLmxlbmd0aCAqIDUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLmdldFdpZGdldAogICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAqLwogICAgICAgIGdldFdpZGdldDogZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgdmFyIHdpZGdldCA9IG51bGwsCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGxlbiA9IHRoaXMud2lkZ2V0cy5sZW5ndGg7CiAgICAgICAgICAgIG8udXRpbC5lYWNoKHRoaXMud2lkZ2V0cywgZnVuY3Rpb24oX3dpZGdldCkgewogICAgICAgICAgICAgICAgaWYoX3dpZGdldC5pZCA9PSBpZCkgewogICAgICAgICAgICAgICAgICAgIHdpZGdldCA9IF93aWRnZXQ7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gd2lkZ2V0OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnJlbW92ZVdpZGdldAogICAgICAgICAqIEBwYXJhbSB3aWRnZXQge29jdG9wdXMuV2lkZ2V0fQogICAgICAgICAqLwogICAgICAgIHJlbW92ZVdpZGdldDogZnVuY3Rpb24od2lkZ2V0KSB7CiAgICAgICAgICAgIGlmICgod2lkZ2V0KSAmJiAod2lkZ2V0ID09IHRoaXMuZ2V0V2lkZ2V0KHdpZGdldC5pZCkpKSB7CiAgICAgICAgICAgICAgICB3aWRnZXQuZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh3aWRnZXQuZWwpOwogICAgICAgICAgICAgICAgby51dGlsLnJlbW92ZUl0ZW0odGhpcy53aWRnZXRzLCB3aWRnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgWl9JTkRFWF9CQVNFOiB7CiAgICAgICAgICAgIEJhc2VMYXllcjogMCwKICAgICAgICAgICAgTGF5ZXI6IDM1MCwKICAgICAgICAgICAgV2lkZ2V0OiA3NTAsCiAgICAgICAgICAgIE1hc2s6IDEwMDAsCiAgICAgICAgICAgIFBvcHVwOiAxNTAwCiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuQXBwIgogICAgfSk7Cn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bnu5PmnoTmlofku7YKICog5a6a5LmJ5ZG95Luk5oiW5pON5L2cCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKi8KOyhmdW5jdGlvbihvLCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgby5DbWQgPSBvLmRlZmluZSh7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG5hbWUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIG5hbWU6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFjdGl2ZQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGFjdGl2ZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFwcAogICAgICAgICAqIEB0eXBlIHtvY3RvcHVzLkFwcH0KICAgICAgICAgKi8KICAgICAgICBhcHA6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24obmFtZSwgb3B0aW9ucykgewogICAgICAgICAgICB0aGlzLm5hbWUgPSB0aGlzLm5hbWUgfHwgdGhpcy5DTEFTU19OQU1FOwogICAgICAgICAgICBvLmV4dGVuZCh0aGlzLCBvcHRpb25zKQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kLmFjdGl2YXRlCiAgICAgICAgICogQGRlc2Mg5r+A5rS75ZG95Luk54q25oCBCiAgICAgICAgICovCiAgICAgICAgYWN0aXZhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZighdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kLmRlYWN0aXZhdGUKICAgICAgICAgKiBAZGVzYyDmjILotbflkb3ku6TnirbmgIEKICAgICAgICAgKi8KICAgICAgICBkZWFjdGl2YXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkNtZC5leGVjdXRlCiAgICAgICAgICogQHBhcmFtIG9wdGlvbgogICAgICAgICAqIEBkZXNjIOaJp+ihjOWRveS7pAogICAgICAgICAqLwogICAgICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgICAgICBpZighdGhpcy5hY3RpdmUpCXJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkNtZC51bmV4ZWN1dGUKICAgICAgICAgKiBAZGVzYyDlrp7njrDmraTmlrnms5XnmoTlkb3ku6TmlK/mjIF1bmRvIHJlZG8KICAgICAgICAgKi8KICAgICAgICB1bmV4ZWN1dGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZighdGhpcy5hY3RpdmUpICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkNtZC5zZXRBcHAKICAgICAgICAgKiBAcGFnZSB7b2N0b3B1cy5BcHB9CiAgICAgICAgICogQGRlc2Mg57uR5a6a5ZG95Luk5YiwYXBwCiAgICAgICAgICovCiAgICAgICAgc2V0QXBwOiBmdW5jdGlvbihhcHApIHsKICAgICAgICAgICAgaWYodGhpcy5hcHAgIT0gYXBwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFwcCA9IGFwcDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuQ21kIgogICAgfSk7Cn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bnu5PmnoTmlofku7YKICog5a6a5LmJ5ZG95Luk566h55CG57G7CiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKi8KOyhmdW5jdGlvbihvLCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgby5DbWRNYW5hZ2VyID0gby5kZWZpbmUoewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBhcHAKICAgICAgICAgKiBAdHlwZSB7b2N0b3B1cy5BcHB9CiAgICAgICAgICovCiAgICAgICAgYXBwOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjb21tYW5kcwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBjb21tYW5kczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXhlY3V0ZUNtZHMKICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICovCiAgICAgICAgZXhlY3V0ZUNtZHM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG5hbWUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIG5hbWU6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICBvLmV4dGVuZCh0aGlzLCBvcHRpb25zKTsKICAgICAgICAgICAgISF0aGlzLmFwcCA/ICh0aGlzLnNldEFwcCh0aGlzLmFwcCksIHRydWUpIDogZmFsc2U7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IHRoaXMubmFtZSB8fCBvLnV0aWwuY3JlYXRlVW5pcXVlSUQodGhpcy5DTEFTU19OQU1FICsgIl8iKTsKICAgICAgICAgICAgdGhpcy5jb21tYW5kcyA9IHRoaXMuY29tbWFuZHMgfHwgW107CiAgICAgICAgICAgIHRoaXMuZXhlY3V0ZUNtZHMgPSB0aGlzLmV4ZWN1dGVDbWRzIHx8IFtdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kTWFuYWdlci5zZXRBcHAKICAgICAgICAgKiBAcGFyYW0gYXBwIHtvY3RvcHVzLkFwcH0KICAgICAgICAgKi8KICAgICAgICBzZXRBcHA6IGZ1bmN0aW9uKGFwcCkgewogICAgICAgICAgICB0aGlzLmFwcCA9PSBhcHAgPyBmYWxzZSA6ICh0aGlzLmFwcCA9IGFwcCwgdHJ1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5DbWRNYW5hZ2VyLnJlZ2lzdGVyCiAgICAgICAgICogQHBhcmFtIGNvbW1hbmQge28uQ21kfQogICAgICAgICAqIEBkZXNjIOazqOWGjOS4gOS4quWRveS7pOWIsOWRveS7pOeuoeeQhuWZqAogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAoY29tbWFuZCkgewogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmNvbW1hbmRzLmluZGV4T2YoY29tbWFuZCk7CiAgICAgICAgICAgIGlmKGluZGV4ICE9IC0xKQlyZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY29tbWFuZHMucHVzaChjb21tYW5kKTsKICAgICAgICAgICAgY29tbWFuZC5zZXRBcHAodGhpcy5hcHApOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkNtZE1hbmFnZXIudW5yZWdpc3RlcgogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgdW5yZWdpc3RlcjogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmdldENvbW1hbmRJbmRleEJ5TmFtZShuYW1lKTsKICAgICAgICAgICAgaWYoaW5kZXggPT0gLTEpCXJldHVybiBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jb21tYW5kcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0Q29tbWFuZEluZGV4QnlOYW1lCiAgICAgICAgICovCiAgICAgICAgZ2V0Q29tbWFuZEluZGV4QnlOYW1lOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHZhciBsZW4gPSB0aGlzLmNvbW1hbmRzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGkgPSBsZW47CiAgICAgICAgICAgIGZvcig7IGktLTsgKSB7CiAgICAgICAgICAgICAgICBpZihuYW1lID09IHRoaXMuY29tbWFuZHNbaV0ubmFtZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkNtZE1hbmFnZXIuZXhlY3V0ZUNvbW1hbmQKICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfSDlkb3ku6TlkI0KICAgICAgICAgKiBAcGFyYW0gb3B0aW9uIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgZXhlY3V0ZUNvbW1hbmQ6IGZ1bmN0aW9uKG5hbWUsIG9wdGlvbikgewogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmdldENvbW1hbmRJbmRleEJ5TmFtZShuYW1lKTsKICAgICAgICAgICAgaWYoaW5kZXggPT0gLTEpCXJldHVybjsKICAgICAgICAgICAgdGhpcy5jb21tYW5kc1tpbmRleF0uZXhlY3V0ZShvcHRpb24pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kTWFuYWdlci5kZXN0cm95CiAgICAgICAgICovCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLmFwcCA9IG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuQ21kTWFuYWdlciIKICAgIH0pOwoKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tue7k+aehOaWh+S7tgogKiDlrprkuYnlm77lsYLln7rnsbsKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBvLkxheWVyID0gby5kZWZpbmUoewogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlkCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBpZDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY29uZmlnCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBjb25maWc6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzQ3VycmVudAogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzQ3VycmVudDogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50CiAgICAgICAgICogQHR5cGUge29jdG9wdXMuRXZlbnRzfQogICAgICAgICAqLwogICAgICAgIGV2ZW50OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLkxheWVyLmlzQmFzZUxheWVyCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNCYXNlTGF5ZXI6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB3aWRnZXRzCiAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAqLwogICAgICAgIHdpZGdldHM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFwcAogICAgICAgICAqIEB0eXBlIHtvY3RvcHVzLkFwcH0KICAgICAgICAgKi8KICAgICAgICBhcHA6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICB2YXIgY29uZmlnID0gdGhpcy5jb25maWcgPSBvLmV4dGVuZCh7fSwgb3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMuaWQgPSBjb25maWcuaWQgfHwgby51dGlsLmNyZWF0ZVVuaXF1ZUlEKHRoaXMuQ0xBU1NfTkFNRSArICJfIik7CiAgICAgICAgICAgIHRoaXMuZWwgPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgIGlkOiB0aGlzLmlkCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmlzQ3VycmVudCA9IGNvbmZpZy5pc0N1cnJlbnQgfHwgdGhpcy5pc0N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuaXNCYXNlTGF5ZXIgPSBjb25maWcuaXNCYXNlTGF5ZXIgfHwgdGhpcy5pc0Jhc2VMYXllcjsKICAgICAgICAgICAgaWYodGhpcy5pc0N1cnJlbnQgfHwgdGhpcy5pc0Jhc2VMYXllcikgewogICAgICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModGhpcy5lbCwgIm9jdG9wdXMtbGF5ZXItYmFzZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXZlbnQgPSBuZXcgby5FdmVudHModGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5MYXllci5nZXRFbAogICAgICAgICAqIEByZXR1cm4ge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZ2V0RWw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5lbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkxheWVyLm9uCiAgICAgICAgICogQGRlc2Mg5LqL5Lu255uR5ZCsCiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgb246IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMub24odHlwZSwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5MYXllci51bgogICAgICAgICAqIEBkZXNjIOS6i+S7tuWPlua2iOebkeWQrAogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufQogICAgICAgICAqLwogICAgICAgIHVuOiBmdW5jdGlvbih0eXBlLCBmdW5jKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzLnVuKHR5cGUsIGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuTGF5ZXIuc2V0QXBwCiAgICAgICAgICogQGRlc2Mg57uR5a6aYXBwCiAgICAgICAgICogQHBhcmFtIGFwcCB7b2N0b3B1cy5BcHB9CiAgICAgICAgICovCiAgICAgICAgc2V0QXBwOiBmdW5jdGlvbihhcHApIHsKICAgICAgICAgICAgcmV0dXJuIGFwcCA9PSB0aGlzLmFwcCA/IGZhbHNlIDogKHRoaXMuYXBwID0gYXBwLCB0cnVlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkxheWVyLmFmdGVyQWRkCiAgICAgICAgICogQGRlc2Mg57uR5a6a5YWlYXBw5ZCO6LCD55SoCiAgICAgICAgICovCiAgICAgICAgYWZ0ZXJBZGQ6IGZ1bmN0aW9uKCkgewoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkxheWVyLnNldEN1cnJlbnQKICAgICAgICAgKiBAcGFyYW0gY3VycmVudCB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBzZXRDdXJyZW50OiBmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgICAgIGlmKChjdXJyZW50ICYmIHRoaXMuaXNDdXJyZW50KSB8fCAoIWN1cnJlbnQgJiYgIXRoaXMuaXNDdXJyZW50KSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzQ3VycmVudCA9IGN1cnJlbnQ7CiAgICAgICAgICAgIGN1cnJlbnQgPyBvLmRvbS5hZGRDbGFzcyh0aGlzLmVsLCAib2N0b3B1cy1sYXllci1zaG93IikgOiBvLmRvbS5yZW1vdmVDbGFzcyh0aGlzLmVsLCAib2N0b3B1cy1sYXllci1zaG93Iik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5MYXllci5zZXRaSW5kZXgKICAgICAgICAgKiBAcGFyYW0gekluZGV4IHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgc2V0WkluZGV4OiBmdW5jdGlvbih6SW5kZXgpIHsKICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS56SW5kZXggPSB6SW5kZXg7CiAgICAgICAgfSwKCiAgICAgICAgYWN0aXZhdGU6IGZ1bmN0aW9uKCkgewoKICAgICAgICB9LAoKICAgICAgICBkZWFjdGl2YXRlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlQXBwOiBmdW5jdGlvbigpIHsKCiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuTGF5ZXIiCiAgICB9KTsKfSkob2N0b3B1cyk7",
                "body": "LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tu+8jOS4u+imgeeUqOS6jumAmueUqOe7hOS7tueahOexu+e7k+aehOWjsOaYjgogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24od2luZG93LCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAgKiDlkb3lkI3nqbrpl7TliY3nvIAg8J+QmQogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzCiAgICAgKiBAZGVzYyDlkb3lkI3nqbrpl7Tor7TmmI4g5omA5pyJ5bCP5YaZ5a2X5q+N5byA5aS055qE5pa55rOV6YO95Y+v5Lul55u05o6l6LCD55SoIOWmgm9jdG9wdXMuZWFzaW5nLmxpbmVhci5lYXNlSW4KICAgICAqIOebuOWPje+8jOWkp+WGmeWtl+avjeW8gOWktOeahOWRveWQjeivtOaYjuivpeWvueixoeaYr+S4gOS4quexu+WvueixoSDpnIDopoHnlKjlhbPplK7lrZduZXcg5aaCIG5ldyBvY3RvcHVzLldpZGdldCgpCiAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICovCiAgICB2YXIgb2N0b3B1cywKICAgICAgICBvID0gb2N0b3B1cyA9IHt2ZXJzaW9uOiAiMS4xIn07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZGVmaW5lCiAgICAgKiBAZGVzYyDnsbvnlJ/miJAu5bCG6L+U5Zue5LiA5Liq5b2i5aaC4oCU4oCUCiAgICAgKiBmdW5jdGlvbiBDKCkgewogICAgICogICAgICB0aGlzLmluaXRpYWxpemUoKQogICAgICogfTsKICAgICAqIEMucHJvdG90eXBlID0geyBjb25zdHJ1Y3RvcjogQywgLi4uIH3nmoTlr7nosaEKICAgICAqIOaUr+aMgeS4pOS4quWPguaVsO+8jOesrOS4gOS4quS4uueItuexu++8iOWPr+S4jeWtmOWcqO+8ie+8jOesrOS6jOS4quS4uueUn+aIkOexu+eahOWQhOWxnuaAp+aWueazleWvueixoSDnlLHkuo7mr4/kuKrnsbvnmoTnlJ/miJDpg73ln7rkuo7lrZDnsbvlr7nniLbnsbvlr7nosaHnmoTmt7Hluqbmi7fotJ3vvIzlm6DmraTvvIwKICAgICAqIOS4uumBv+WFjeWtkOexu+WxnuaAp+abtOaUueWvueeItuexu+mAoOaIkOeahOS4jeWPr+aOp+W9seWTje+8jOmZpE51bWJlcnxTdHJpbmd8Qm9vbGVhbiDlpJbnmoTlr7nosaEg5Yid5aeL5YyW6YO95bu66K6u5pS+5Zyo5p6E6YCg5Ye95pWw5b2T5Lit5Y675YGaIOWIneWni+WMluWAvOW7uuiurgogICAgICog5Li6bnVsbAogICAgICogQGV4YW1wbGUKICAgICAqIHZhciBuZXdDbGFzcyA9IG9jdG9wdXMuZGVmaW5lKHsKICAgICAqICAgICB3aWR0aDogNjQsCiAgICAgKiAgICAgbGVuZ3RoOiAiMTJweCIsCiAgICAgKiAgICAgcHJvcGVydHk6IG51bGwsCiAgICAgKiAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgICAgIHRoaXMucHJvcGVydHkgPSBPYmplY3QuY3JlYXRlKHt9KTsKICAgICAqICAgICB9CiAgICAgKiB9KTsKICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufQogICAgICovCiAgICBvLmRlZmluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICAgICAgICBzID0gYXJndW1lbnRzWzBdLAogICAgICAgICAgICBpID0gYXJndW1lbnRzW2xlbiAtIDFdOwoKICAgICAgICB2YXIgbmMgPSB0eXBlb2YgaS5pbml0aWFsaXplID09ICJmdW5jdGlvbiIgPyBpLmluaXRpYWxpemUgOgogICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICAgIGlmKGxlbiA+IDEpIHsKICAgICAgICAgICAgdmFyIG5ld0FyZ3MgPSBbbmMsIHNdLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpLnNsaWNlKDEsIGxlbiAtIDEpLCBpKTsKICAgICAgICAgICAgby5pbmhlcml0LmFwcGx5KG51bGwsIG5ld0FyZ3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5jLnByb3RvdHlwZSA9IGk7CiAgICAgICAgICAgIG5jLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IG5jOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmM7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLmluaGVyaXQKICAgICAqIEBkZXNjIOe7p+aJvwogICAgICogQHBhcmFtIGNoaWxkIHtGdW5jdGlvbn0g5a2Q57G7CiAgICAgKiBAcGFyYW0gZmF0aGVyIHtGdW5jdGlvbn0g54i257G7CiAgICAgKi8KICAgIG8uaW5oZXJpdCA9IGZ1bmN0aW9uKGNoaWxkLCBmYXRoZXIpIHsKICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uKCkge30sCiAgICAgICAgICAgIGNwLAogICAgICAgICAgICBmcCA9IGZhdGhlci5wcm90b3R5cGU7CiAgICAgICAgZi5wcm90b3R5cGUgPSBmcDsKICAgICAgICBjcCA9IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBmOwogICAgICAgIGNwLmNvbnN0cnVjdG9yID0gY2hpbGQ7CiAgICAgICAgdmFyIGksIGwsIGs7CiAgICAgICAgZm9yKGkgPSAyLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICBrID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICBpZih0eXBlb2YgayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgayA9IGsucHJvdG90eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgayk7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy5leHRlbmQKICAgICAqIEBkZXNjIOWwhuS4gOS4quWvueixoeeahOWxnuaAp+WkjeWItue7meWPpuS4gOS4quWvueixoQogICAgICogQHBhcmFtIGRlc3RpbmF0aW9uIHtvYmplY3R9CiAgICAgKiBAcGFyYW0gc291cmNlIHtvYmplY3R9CiAgICAgKiBAcmV0dXJuIGRlc3RpbmF0aW9uIHtvYmplY3R9IOWkjeWItuWQjueahOWvueixoQogICAgICovCiAgICBvLmV4dGVuZCA9IGZ1bmN0aW9uKGRlc3RpbmF0aW9uLCBzb3VyY2UpIHsKICAgICAgICBkZXN0aW5hdGlvbiA9IGRlc3RpbmF0aW9uIHx8IHt9OwogICAgICAgIGlmKHNvdXJjZSkgewogICAgICAgICAgICBmb3IodmFyIHByb3BlcnR5IGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gc291cmNlW3Byb3BlcnR5XTsKICAgICAgICAgICAgICAgIGlmKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbltwcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc291cmNlSXNFdnQgPSB0eXBlb2Ygd2luZG93LkV2ZW50ID09ICJmdW5jdGlvbiIKICAgICAgICAgICAgICAgICYmIHNvdXJjZSBpbnN0YW5jZW9mIHdpbmRvdy5FdmVudDsKCiAgICAgICAgICAgIGlmICghc291cmNlSXNFdnQgJiYgc291cmNlLmhhc093blByb3BlcnR5ICYmIHNvdXJjZS5oYXNPd25Qcm9wZXJ0eSgidG9TdHJpbmciKSkgewogICAgICAgICAgICAgICAgZGVzdGluYXRpb24udG9TdHJpbmcgPSBzb3VyY2UudG9TdHJpbmc7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlc3RpbmF0aW9uOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lc3BhY2Ugb2N0b3B1cy51dGlsCiAgICAgKiBAZGVzYyDlt6Xlhbfpm4blkIgg55u45b2T5LqOanF1ZXJ555qEZm4KICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgKi8KICAgIG8udXRpbCA9IG8udXRpbCB8fCB7fTsKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLnV0aWwubGFzdFNlcUlkCiAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICovCiAgICBvLnV0aWwubGFzdFNlcUlkID0gMDsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmNyZWF0ZVVuaXF1ZUlECiAgICAgKiBAcGFyYW0gcHJlZml4IHtTdHJpbmd9IOWJjee8gAogICAgICogQHJldHVybiB7U3RyaW5nfSDlhajlsYDllK/kuIDnmoTkuIDkuKrlrZfnrKbkuLIKICAgICAqLwogICAgby51dGlsLmNyZWF0ZVVuaXF1ZUlEID0gZnVuY3Rpb24ocHJlZml4KSB7CiAgICAgICAgcHJlZml4ID0gKHByZWZpeCA9PT0gbnVsbCB8fCBwcmVmaXggPT09IHVuZGVmaW5lZCkgPyAib2N0b3B1cyIgOiBwcmVmaXgucmVwbGFjZSgvXC4vZywgIl8iKTsKICAgICAgICBvLnV0aWwubGFzdFNlcUlkKys7CiAgICAgICAgcmV0dXJuIHByZWZpeCArIG8udXRpbC5sYXN0U2VxSWQ7CiAgICB9OwoKICAgIHdpbmRvdy5vY3RvcHVzID0gbzsKCn0pKHdpbmRvdyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tgogKiB1dGlsIC0gICDlt6Xlhbflh73mlbDpg6jliIYKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIOmBv+WFjeacquWjsOaYjiBvY3RvcHVzLnV0aWwKICAgICAqLwogICAgdmFyIHV0aWwgPSBvLnV0aWwgPSBvLnV0aWwgfHwge307CgogICAgLyoqCiAgICAgKiBAY29uc3Qgb2N0b3B1cy51dGlsLkxFRlQge1N0cmluZ30gImxlZnQiCiAgICAgKiBAY29uc3Qgb2N0b3B1cy51dGlsLlJJR0hUIHtTdHJpbmd9ICJyaWdodCIKICAgICAqIEBjb25zdCBvY3RvcHVzLnV0aWwuVVAge1N0cmluZ30gInVwIgogICAgICogQGNvbnN0IG9jdG9wdXMudXRpbC5ET1dOIHtTdHJpbmd9ICJkb3duIgogICAgICovCiAgICB1dGlsLkxFRlQgPSAibGVmdCI7CiAgICB1dGlsLlJJR0hUID0gInJpZ2h0IjsKICAgIHV0aWwuVVAgPSAidXAiOwogICAgdXRpbC5ET1dOID0gImRvd24iOwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZ2V0Q2VudGVyCiAgICAgKiBAcGFyYW0gdG91Y2hlcyB7QXJyYXl9CiAgICAgKiBAcmV0dXJuIHtvYmplY3R9CiAgICAgKiBAZGVzYyDojrflvpfmiYDmnInop6bmkbjngrnnmoTkuK3lv4MKICAgICAqLwogICAgdXRpbC5nZXRDZW50ZXIgPSBmdW5jdGlvbih0b3VjaGVzKSB7CiAgICAgICAgdmFyIHZhbHVlc1ggPSBbXSwgdmFsdWVzWSA9IFtdOwoKICAgICAgICBmb3IodmFyIHQ9IDAsbGVuPXRvdWNoZXMubGVuZ3RoOyB0PGxlbjsgdCsrKSB7CiAgICAgICAgICAgIHZhbHVlc1gucHVzaCh0b3VjaGVzW3RdLnBhZ2VYKTsKICAgICAgICAgICAgdmFsdWVzWS5wdXNoKHRvdWNoZXNbdF0ucGFnZVkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcGFnZVg6ICgoTWF0aC5taW4uYXBwbHkoTWF0aCwgdmFsdWVzWCkgKyBNYXRoLm1heC5hcHBseShNYXRoLCB2YWx1ZXNYKSkgLyAyKSwKICAgICAgICAgICAgcGFnZVk6ICgoTWF0aC5taW4uYXBwbHkoTWF0aCwgdmFsdWVzWSkgKyBNYXRoLm1heC5hcHBseShNYXRoLCB2YWx1ZXNZKSkgLyAyKQogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZ2V0VmVsb2NpdHkKICAgICAqIEBkZXNjIOiOt+W+l+S4pOeCuemXtOeerOenu+mAn+W6pgogICAgICogQHBhcmFtIGRlbHRhX3RpbWUge051bWJlcn0KICAgICAqIEBwYXJhbSBkZWx0YV94IHtOdW1iZXJ9CiAgICAgKiBAcGFyYW0gZGVsdGFfeSB7TnVtYmVyfQogICAgICogQHJldHVybiB7b2JqZWN0fSB45Li65qiq5ZCR6YCf5bqmIHnkuLrnurXlkJHpgJ/luqYKICAgICAqLwogICAgdXRpbC5nZXRWZWxvY2l0eSA9IGZ1bmN0aW9uKGRlbHRhX3RpbWUsIGRlbHRhX3gsIGRlbHRhX3kpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB4OiBNYXRoLmFicyhkZWx0YV94IC8gZGVsdGFfdGltZSkgfHwgMCwKICAgICAgICAgICAgeTogTWF0aC5hYnMoZGVsdGFfeSAvIGRlbHRhX3RpbWUpIHx8IDAKICAgICAgICB9OwoKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRBbmdsZQogICAgICogQGRlc2Mg6I635b6X5Lik54K56Ze06KeS5bqmCiAgICAgKiBAcGFyYW0gdG91Y2gxIHtPYmplY3R9CiAgICAgKiBAcGFyYW0gdG91Y2gyIHtPYmplY3R9CiAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9CiAgICAgKi8KICAgIHV0aWwuZ2V0QW5nbGUgPSBmdW5jdGlvbih0b3VjaDEsIHRvdWNoMikgewogICAgICAgIHZhciB5ID0gdG91Y2gyLnBhZ2VZIC0gdG91Y2gxLnBhZ2VZLAogICAgICAgICAgICB4ID0gdG91Y2gyLnBhZ2VYIC0gdG91Y2gxLnBhZ2VYOwogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHksIHgpICogMTgwIC8gTWF0aC5QSTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXREaXJlY3Rpb24KICAgICAqIEBkZXNjIOiOt+W+l+inpueisOa7keWKqOaWueWQkQogICAgICogQHBhcmFtIHRvdWNoMSB7T2JqZWN0fQogICAgICogQHBhcmFtIHRvdWNoMiB7T2JqZWN0fQogICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICovCiAgICB1dGlsLmdldERpcmVjdGlvbiA9IGZ1bmN0aW9uKHRvdWNoMSwgdG91Y2gyKSB7CiAgICAgICAgdmFyIHggPSBNYXRoLmFicyh0b3VjaDEucGFnZVggLSB0b3VjaDIucGFnZVgpLAogICAgICAgICAgICB5ID0gTWF0aC5hYnModG91Y2gxLnBhZ2VZIC0gdG91Y2gyLnBhZ2VZKTsKCiAgICAgICAgaWYoeCA+PSB5KSB7CiAgICAgICAgICAgIHJldHVybiB0b3VjaDEucGFnZVggLSB0b3VjaDIucGFnZVggPiAwID8gdXRpbC5MRUZUIDogdXRpbC5SSUdIVDsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0b3VjaDEucGFnZVkgLSB0b3VjaDIucGFnZVkgPiAwID8gdXRpbC5VUCA6IHV0aWwuRE9XTjsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZ2V0RGlzdGFuY2UKICAgICAqIEBkZXNjIOiOt+W+l+S4pOeCuemXtOi3neemuwogICAgICogQHBhcmFtIHRvdWNoMSB7T2JqZWN0fQogICAgICogQHBhcmFtIHRvdWNoMiB7T2JqZWN0fQogICAgICogQHJldHVybiB7TnVtYmVyfQogICAgICovCiAgICB1dGlsLmdldERpc3RhbmNlID0gZnVuY3Rpb24odG91Y2gxLCB0b3VjaDIpIHsKICAgICAgICB2YXIgeCA9IHRvdWNoMi5wYWdlWCAtIHRvdWNoMS5wYWdlWCwKICAgICAgICAgICAgeSA9IHRvdWNoMi5wYWdlWSAtIHRvdWNoMS5wYWdlWTsKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KCh4ICogeCkgKyAoeSAqIHkpKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRTY2FsZQogICAgICogQGRlc2Mg6I635b6X5Lik6Kem5pG454K55ruR5Yqo5ZCO5b6X5Yiw55qE5Lik6Kem5pG454K55LmL5LqO5LmL5YmN55qE5pS+5aSn5YCN5pWwCiAgICAgKiBAcGFyYW0gc3RhcnQge0FycmF5fQogICAgICogQHBhcmFtIGVuZCB7QXJyYXl9CiAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9CiAgICAgKi8KICAgIHV0aWwuZ2V0U2NhbGUgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgICAgaWYoc3RhcnQubGVuZ3RoID49IDIgJiYgZW5kLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERpc3RhbmNlKGVuZFswXSwgZW5kWzFdKSAvCiAgICAgICAgICAgICAgICB0aGlzLmdldERpc3RhbmNlKHN0YXJ0WzBdLCBzdGFydFsxXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAxOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmdldFJvdGF0aW9uCiAgICAgKiBAZGVzYyDojrflvpfkuKTop6bmkbjngrnmu5HliqjlkI7lvpfliLDnmoTkuKTop6bmkbjngrnkuYvkuo7kuYvliY3nmoTml4vovazluqbmlbAKICAgICAqIEBwYXJhbSBzdGFydCB7QXJyYXl9CiAgICAgKiBAcGFyYW0gZW5kIHtBcnJheX0KICAgICAqIEByZXR1cm4ge051bWJlcn0KICAgICAqLwogICAgdXRpbC5nZXRSb3RhdGlvbiA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpIHsKICAgICAgICBpZihzdGFydC5sZW5ndGggPj0gMiAmJiBlbmQubGVuZ3RoID49IDIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QW5nbGUoZW5kWzFdLCBlbmRbMF0pIC0KICAgICAgICAgICAgICAgIHRoaXMuZ2V0QW5nbGUoc3RhcnRbMV0sIHN0YXJ0WzBdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZW5jb2RlSHRtbAogICAgICogQGRlc2Mg5a+55a2X56ym5Liy5Lit55qE54m55q6K5a2X56ym6L+b6KGMaHRtbOe8lueggQogICAgICogQHBhcmFtIHN0ciB7U3RyaW5nfQogICAgICovCiAgICB1dGlsLmVuY29kZUh0bWwgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gU3RyaW5nKHN0cikKICAgICAgICAgICAgLnJlcGxhY2UoLyYvZywgIiZhbXA7IikKICAgICAgICAgICAgLnJlcGxhY2UoLzwvZywgIiZsdDsiKQogICAgICAgICAgICAucmVwbGFjZSgvPi9nLCAiJmd0OyIpCiAgICAgICAgICAgIC5yZXBsYWNlKC8iL2csICImcXVvdDsiKQogICAgICAgICAgICAucmVwbGFjZSgvJy9nLCAiJiMzOTsiKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5kZWNvZGVIdG1sCiAgICAgKiBAZGVzYyDlr7nlrZfnrKbkuLLkuK3nmoRodG1s6L+b6KGM57yW56CBCiAgICAgKiBAcGFyYW0gc3RyIHtTdHJpbmd9CiAgICAgKi8KICAgIHV0aWwuaHRtbERlY29kZURpY3QgPSB7InF1b3QiOiAnIicsICJsdCI6ICI8IiwgImd0IjogIj4iLCAiYW1wIjogIiYiLCAiIzM5IjogIicifTsKICAgIHV0aWwuZGVjb2RlSHRtbCA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHJldHVybiBTdHJpbmcoc3RyKS5yZXBsYWNlKC8mKHF1b3R8bHR8Z3R8YW1wfCMzOSk7L2lnLCBmdW5jdGlvbihhbGwsIGtleSkgewogICAgICAgICAgICByZXR1cm4gdXRpbC5odG1sRGVjb2RlRGljdFtrZXldOwogICAgICAgIH0pLnJlcGxhY2UoLyYjdShbYS1mXGRdezR9KTsvaWcsIGZ1bmN0aW9uKGFsbCwgaGV4KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludCgiMHgiICsgaGV4KSk7CiAgICAgICAgICAgIH0pLnJlcGxhY2UoLyYjKFxkKyk7L2lnLCBmdW5jdGlvbihhbGwsIG51bWJlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoK251bWJlcik7CiAgICAgICAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmxvYWRJbWFnZQogICAgICogQGRlc2Mg5Yqg6L295Zu+54mH5pa55rOVCiAgICAgKiBAcGFyYW0gdXJsIHtTdHJpbmd9IOWbvueJh3VybAogICAgICogQHBhcmFtIHJlYWR5IHtGdW5jdGlvbn0g5q2k5pe25Zu+54mH5rKh5pyJ5Yqg6L295a6MIOS9huaYr+WuvemrmOW3suefpQogICAgICogQHBhcmFtIGxvYWQge0Z1bmN0aW9ufSDlm77niYdvbmxvYWTnmoRjYWxsYmFjawogICAgICogQHBhcmFtIGVycm9yIHtGdW5jdGlvbn0g5Zu+54mH5Yqg6L295aSx6LSl55qEY2FsbGJhY2sKICAgICAqLwogICAgdXRpbC5sb2FkSW1hZ2UgPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGxpc3QgPSBbXSwKICAgICAgICAgICAgaW50ZXJ2YWxJZCA9IG51bGwsCiAgICAgICAgLy/nlKjmnaXmiafooYzpmJ/liJcKICAgICAgICAgICAgdGljayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdFtpXS5lbmQgPyBsaXN0LnNwbGljZShpLS0sIDEpIDogbGlzdFtpXSgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICFsaXN0Lmxlbmd0aCAmJiBzdG9wKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgLy8g5YGc5q2i5omA5pyJ5a6a5pe25Zmo6Zif5YiXCiAgICAgICAgICAgIHN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsSWQpOwogICAgICAgICAgICAgICAgaW50ZXJ2YWxJZCA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh1cmwsIHJlYWR5LCBsb2FkLCBlcnJvcikgewogICAgICAgICAgICB2YXIgb25yZWFkeSwgd2lkdGgsIGhlaWdodCwgbmV3V2lkdGgsIG5ld0hlaWdodCwKICAgICAgICAgICAgICAgIGltZyA9IG5ldyBJbWFnZSgpOwogICAgICAgICAgICBpbWcuc3JjID0gdXJsOwogICAgICAgICAgICAvLyDlpoLmnpzlm77niYfooqvnvJPlrZjvvIzliJnnm7TmjqXov5Tlm57nvJPlrZjmlbDmja4KICAgICAgICAgICAgaWYgKGltZy5jb21wbGV0ZSkgewogICAgICAgICAgICAgICAgcmVhZHkuY2FsbChpbWcpOwogICAgICAgICAgICAgICAgbG9hZCAmJiBsb2FkLmNhbGwoaW1nKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2lkdGggPSBpbWcud2lkdGg7CiAgICAgICAgICAgIGhlaWdodCA9IGltZy5oZWlnaHQ7CiAgICAgICAgICAgIC8vIOWKoOi9vemUmeivr+WQjueahOS6i+S7tgogICAgICAgICAgICBpbWcub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGVycm9yICYmIGVycm9yLmNhbGwoaW1nKTsKICAgICAgICAgICAgICAgIG9ucmVhZHkuZW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGltZyA9IGltZy5vbmxvYWQgPSBpbWcub25lcnJvciA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIOWbvueJh+WwuuWvuOWwsee7qgogICAgICAgICAgICBvbnJlYWR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgbmV3V2lkdGggPSBpbWcud2lkdGg7CiAgICAgICAgICAgICAgICBuZXdIZWlnaHQgPSBpbWcuaGVpZ2h0OwogICAgICAgICAgICAgICAgaWYgKG5ld1dpZHRoICE9PSB3aWR0aCB8fCBuZXdIZWlnaHQgIT09IGhlaWdodCB8fCBuZXdXaWR0aCAqIG5ld0hlaWdodCA+IDEwMjQpIHsKICAgICAgICAgICAgICAgICAgICByZWFkeS5jYWxsKGltZyk7CiAgICAgICAgICAgICAgICAgICAgb25yZWFkeS5lbmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgb25yZWFkeSgpOwogICAgICAgICAgICAvLyDlrozlhajliqDovb3lrozmr5XnmoTkuovku7YKICAgICAgICAgICAgaW1nLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIG9ubG9hZOWcqOWumuaXtuWZqOaXtumXtOW3ruiMg+WbtOWGheWPr+iDveavlG9ucmVhZHnlv6sKICAgICAgICAgICAgICAgIC8vIOi/memHjOi/m+ihjOajgOafpeW5tuS/neivgW9ucmVhZHnkvJjlhYjmiafooYwKICAgICAgICAgICAgICAgICFvbnJlYWR5LmVuZCAmJiBvbnJlYWR5KCk7CiAgICAgICAgICAgICAgICBsb2FkICYmIGxvYWQuY2FsbChpbWcpOwogICAgICAgICAgICAgICAgLy8gSUUgZ2lm5Yqo55S75Lya5b6q546v5omn6KGMb25sb2Fk77yM572u56m6b25sb2Fk5Y2z5Y+vCiAgICAgICAgICAgICAgICBpbWcgPSBpbWcub25sb2FkID0gaW1nLm9uZXJyb3IgPSBudWxsOwogICAgICAgICAgICB9OwogICAgICAgICAgICAvLyDliqDlhaXpmJ/liJfkuK3lrprmnJ/miafooYwKICAgICAgICAgICAgaWYoIW9ucmVhZHkuZW5kKSB7CiAgICAgICAgICAgICAgICBsaXN0LnB1c2gob25yZWFkeSk7CiAgICAgICAgICAgICAgICAvLyDml6DorrrkvZXml7blj6rlhYHorrjlh7rnjrDkuIDkuKrlrprml7blmajvvIzlh4/lsJHmtY/op4jlmajmgKfog73mjZ/ogJcKICAgICAgICAgICAgICAgIGlmIChpbnRlcnZhbElkID09PSBudWxsKSBpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwodGljaywgNDApOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9KSgpOwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZW1wdHkKICAgICAqIEBkZXNjIOepuuWHveaVsAogICAgICovCiAgICB1dGlsLmVtcHR5ID0gZnVuY3Rpb24oKSB7fTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmJpbmQKICAgICAqIEBkZXNjIOaNouS9nOeUqOWfnwogICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufQogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fQogICAgICovCiAgICB1dGlsLmJpbmQgPSBmdW5jdGlvbihmdW5jLCBvYmplY3QpIHsKICAgICAgICAvLyBjcmVhdGUgYSByZWZlcmVuY2UgdG8gYWxsIGFyZ3VtZW50cyBwYXN0IHRoZSBzZWNvbmQgb25lCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzLCBbMl0pOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gUHVzaCBvbiBhbnkgYWRkaXRpb25hbCBhcmd1bWVudHMgZnJvbSB0aGUgYWN0dWFsIGZ1bmN0aW9uIGNhbGwuCiAgICAgICAgICAgIC8vIFRoZXNlIHdpbGwgY29tZSBhZnRlciB0aG9zZSBzZW50IHRvIHRoZSBiaW5kIGNhbGwuCiAgICAgICAgICAgIHZhciBuZXdBcmdzID0gYXJncy5jb25jYXQoCiAgICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzLCBbMF0pCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybiBmdW5jLmFwcGx5KG9iamVjdCwgbmV3QXJncyk7CiAgICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5iaW5kQXNFdmVudExpc3RlbmVyCiAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IOS9nOS4uuS6i+S7tuebkeWQrOeahOWHveaVsAogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fSDkvZznlKjln58KICAgICAqLwogICAgdXRpbC5iaW5kQXNFdmVudExpc3RlbmVyID0gZnVuY3Rpb24oZnVuYywgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwob2JqZWN0LCBldmVudCB8fCB3aW5kb3cuZXZlbnQpOwogICAgICAgIH07CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuaXNOb2RlCiAgICAgKiBAZGVzYyDliKTmlq3lr7nosaHmmK/lkKbmmK/oioLngrkKICAgICAqIEBwYXJhbSBvIHtPYmplY3R9CiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICB1dGlsLmlzTm9kZSA9IGZ1bmN0aW9uKG8pIHsKICAgICAgICByZXR1cm4gISEobyAmJiBvLm5vZGVUeXBlID09PSAxKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5pc09iamVjdAogICAgICogQGRlc2Mg5Yik5pat5a+56LGh5piv5ZCm5piv5a+56LGhCiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICB1dGlsLmlzT2JqZWN0ID0gZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICAgIHJldHVybiAnZnVuY3Rpb24nID09IHR5cGVvZiBzb3VyY2UgfHwgISEoc291cmNlICYmICdvYmplY3QnID09IHR5cGVvZiBzb3VyY2UpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmlzU3RyaW5nCiAgICAgKiBAZGVzYyDliKTmlq3lr7nosaHmmK/lkKbmmK/lrZfnrKbkuLIKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgKi8KICAgIHV0aWwuaXNTdHJpbmcgPSBmdW5jdGlvbiAoc291cmNlKSB7CiAgICAgICAgcmV0dXJuICdbb2JqZWN0IFN0cmluZ10nID09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzb3VyY2UpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmlzQXJyYXkKICAgICAqIEBkZXNjIOWIpOaWreWvueixoeaYr+WQpuaYr+aVsOe7hAogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgdXRpbC5pc0FycmF5ID0gZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgcmV0dXJuICgnW29iamVjdCBBcnJheV0nID09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzb3VyY2UpKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5pc051bWVyaWMKICAgICAqIEBkZXNjIOWIpOaWreWvueixoeaYr+WQpuaYr+aVsOWtlwogICAgICogQHJldHVybnMge0Jvb2xlYW59CiAgICAgKi8KICAgIHV0aWwuaXNOdW1lcmljID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgcmV0dXJuICFpc05hTihwYXJzZUZsb2F0KG9iaikpICYmIGlzRmluaXRlKG9iaik7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuaXNQbGFpbgogICAgICogQGRlc2Mg5Yik5pat5piv5ZCm5piv5pmu6YCa5a+56LGhIOmdnmZ1bmN0aW9uCiAgICAgKi8KICAgIHV0aWwuaXNQbGFpbiAgPSBmdW5jdGlvbihvYmopewogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAgICAgICAgIGtleTsKICAgICAgICBpZiAoICFvYmogfHwKICAgICAgICAgICAgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgIT09ICJbb2JqZWN0IE9iamVjdF0iIHx8CiAgICAgICAgICAgICEoJ2lzUHJvdG90eXBlT2YnIGluIG9iaikKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKCBvYmouY29uc3RydWN0b3IgJiYKICAgICAgICAgICAgIWhhc093blByb3BlcnR5LmNhbGwob2JqLCAiY29uc3RydWN0b3IiKSAmJgogICAgICAgICAgICAhaGFzT3duUHJvcGVydHkuY2FsbChvYmouY29uc3RydWN0b3IucHJvdG90eXBlLCAiaXNQcm90b3R5cGVPZiIpICkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZvciAoIGtleSBpbiBvYmogKSB7fQogICAgICAgIHJldHVybiBrZXkgPT09IHVuZGVmaW5lZCB8fCBoYXNPd25Qcm9wZXJ0eS5jYWxsKCBvYmosIGtleSApOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmlzRW1wdHkKICAgICAqIEBkZXNjIOWIpOaWreS8oOWFpeeahOWPguaVsOaYr+WQpuS4uuepuu+8jAogICAgICogICAgICAg5YyF5ousdW5kZWZpbmVkLCBudWxsLCBmYWxzZSwgbnVtYmVyIDAsCiAgICAgKiAgICAgICBlbXB0eSBzdHJpbmcsIHN0cmluZyAiMCIsIHt9IGFuZCBbXQogICAgICogQHJldHVybnMge0Jvb2xlYW59CiAgICAgKi8KICAgIHV0aWwuaXNFbXB0eSA9IGZ1bmN0aW9uKG1peGVkX3ZhcikgewogICAgICAgIHZhciB1bmRlZiwga2V5LCBpLCBsZW47CiAgICAgICAgdmFyIGVtcHR5VmFsdWVzID0gW3VuZGVmLCBudWxsLCBmYWxzZSwgMCwgIiIsICIwIl07CgogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGVtcHR5VmFsdWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmIChtaXhlZF92YXIgPT09IGVtcHR5VmFsdWVzW2ldKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBtaXhlZF92YXIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIG1peGVkX3ZhcikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmNsb25lCiAgICAgKiBAZGVzYyDmt7Hluqbmi7fotJ3kuIDkuKrlr7nosaEKICAgICAqIEByZXR1cm4g5ou36LSd5ZCO55qE5a+56LGhCiAgICAgKi8KICAgIHV0aWwuY2xvbmUgPSBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gc291cmNlLCBpLCBsZW47CiAgICAgICAgaWYgKCFzb3VyY2UKICAgICAgICAgICAgfHwgc291cmNlIGluc3RhbmNlb2YgTnVtYmVyCiAgICAgICAgICAgIHx8IHNvdXJjZSBpbnN0YW5jZW9mIFN0cmluZwogICAgICAgICAgICB8fCBzb3VyY2UgaW5zdGFuY2VvZiBCb29sZWFuKSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSBlbHNlIGlmKHV0aWwuaXNOb2RlKHNvdXJjZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHNvdXJjZS5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh1dGlsLmlzQXJyYXkoc291cmNlKSkgewogICAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICAgICAgdmFyIHJlc3VsdExlbiA9IDAsCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGxlbiA9IHNvdXJjZS5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIHJlc3VsdFtyZXN1bHRMZW4rK10gPSB1dGlsLmNsb25lKHNvdXJjZVtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHV0aWwuaXNQbGFpbihzb3VyY2UpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHt9OwogICAgICAgICAgICBmb3IgKGkgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgICBpZiAoc291cmNlLmhhc093blByb3BlcnR5KGkpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2ldID0gdXRpbC5jbG9uZShzb3VyY2VbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuZWFjaAogICAgICogQHBhcmFtIHNvdXJjZSB7QXJyYXkgfCBPYmplY3R9CiAgICAgKiBAcGFyYW0gY2FsbGJhY2sge0Z1bmN0aW9ufQogICAgICogQHJldHVybnMgeyp9CiAgICAgKiBAZGVzYyDpgY3ljobmlbDnu4TmiJblr7nosaEKICAgICAqLwogICAgdXRpbC5lYWNoID0gZnVuY3Rpb24oc291cmNlLCBjYWxsYmFjaykgewogICAgICAgIGlmKHV0aWwuaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgICAgIHJldHVybiBBcnJheS5mb3JFYWNoID8gc291cmNlLmZvckVhY2goY2FsbGJhY2spIDogZnVuY3Rpb24oYXIsIGZ1bmMpIHsKICAgICAgICAgICAgICAgIHZhciBsZW4gPSBhci5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgICAgICAgICBmb3IoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5jYWxsKHRoaXMsIGFyW2ldLCBpKTsKICAgICAgICAgICAgICAgICAgICBpZihyZXN1bHQgPT09IHRydWUpIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KHNvdXJjZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICBpZih1dGlsLmlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgICAgICAgZm9yKHZhciBrIGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgaWYoc291cmNlLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrLmNhbGwodGhpcywgc291cmNlW2tdLCBrKTsKICAgICAgICAgICAgICAgICAgICBpZihyZXN1bHQgPT09IHRydWUpIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5mb3JtYXQKICAgICAqIEBwYXJhbSBzdHIge1N0cmluZ30g5b6F6L2s5o2i55qE5a2X56ym5LiyCiAgICAgKiBAcGFyYW0gZGF0YSB7fSDmlbDmja4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9CiAgICAgKi8KICAgIHV0aWwuZm9ybWF0ID0gZnVuY3Rpb24oc3RyLCBkYXRhKSB7CiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC8oIylceyguKj8pXH0vZywgZnVuY3Rpb24oYWxsLCBmbGFnLCBwYXJhbSkgewogICAgICAgICAgICByZXR1cm4gZGF0YSAmJiB0eXBlb2YgZGF0YVtwYXJhbV0gIT0gInVuZGVmaW5lZCIgPyBkYXRhW3BhcmFtXSA6ICIiOwogICAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLmFwcGx5RGVmYXVsdHMKICAgICAqIEBkZXNjIOWwhuS4gOS4quWvueixoemHjOayoeacieeahOWPguaVsOWkjeWItue7meWPpuS4gOS4quWvueixoSDkuI5leHRlbmTnmoTljLrliKvlnKjkuo4g5aaC5p6c5LiN5Lya5aSN5Yi25bey5a2Y5Zyo5bGe5oCnCiAgICAgKiBAcGFyYW0gdG8ge09iamVjdH0KICAgICAqIEBwYXJhbSBmcm9tIHtPYmplY3R9CiAgICAgKi8KICAgIHV0aWwuYXBwbHlEZWZhdWx0cyA9IGZ1bmN0aW9uKHRvLCBmcm9tKSB7CiAgICAgICAgdG8gPSB0byB8fCB7fTsKICAgICAgICB2YXIgZnJvbUlzRXZ0ID0gdHlwZW9mIHdpbmRvdy5FdmVudCA9PSAiZnVuY3Rpb24iCiAgICAgICAgICAgICYmIGZyb20gaW5zdGFuY2VvZiB3aW5kb3cuRXZlbnQ7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGZyb20pIHsKICAgICAgICAgICAgaWYodG9ba2V5XSA9PT0gdW5kZWZpbmVkIHx8CiAgICAgICAgICAgICAgICAoIWZyb21Jc0V2dCAmJiBmcm9tLmhhc093blByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgJiYgZnJvbS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmICF0by5oYXNPd25Qcm9wZXJ0eShrZXkpKSkgewogICAgICAgICAgICAgICAgdG9ba2V5XSA9IGZyb21ba2V5XTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZighZnJvbUlzRXZ0ICYmIGZyb20gJiYgZnJvbS5oYXNPd25Qcm9wZXJ0eQogICAgICAgICAgICAmJiBmcm9tLmhhc093blByb3BlcnR5KCd0b1N0cmluZycpICYmICF0by5oYXNPd25Qcm9wZXJ0eSgndG9TdHJpbmcnKSkgewogICAgICAgICAgICB0by50b1N0cmluZyA9IGZyb20udG9TdHJpbmc7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0bzsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5hcHBseUFkZAogICAgICogQGRlc2Mg5bCG5LiA5Liq5a+56LGh6YeM55qE5Y+C5pWw5rex5bqm5ou36LSd57uZ5Y+m5LiA5Liq5a+56LGhIOWmguaenOWPguaVsOW3suWtmOWcqCDliJnopobnm5Yg5aaC5p6c5LiN5a2Y5ZyoIOWImei/veWKoAogICAgICogQHBhcmFtIHRvIHtPYmplY3R9CiAgICAgKiBAcGFyYW0gZnJvbSAge09iamVjdH0KICAgICAqLwogICAgdXRpbC5hcHBseUFkZCA9IGZ1bmN0aW9uKHRvLCBmcm9tKSB7CiAgICAgICAgdG8gPSB0byB8fCB7fTsKICAgICAgICB2YXIgZnJvbUlzRXZ0ID0gdHlwZW9mIHdpbmRvdy5FdmVudCA9PSAiZnVuY3Rpb24iCiAgICAgICAgICAgICYmIGZyb20gaW5zdGFuY2VvZiB3aW5kb3cuRXZlbnQ7CiAgICAgICAgZm9yKHZhciBrIGluIGZyb20pIHsKICAgICAgICAgICAgaWYodXRpbC5pc09iamVjdCh0b1trXSkgJiYgdXRpbC5pc09iamVjdChmcm9tW2tdKSkgewogICAgICAgICAgICAgICAgdG9ba10gPSB1dGlsLmFwcGx5QWRkKHRvW2tdLCBmcm9tW2tdKTsKICAgICAgICAgICAgfSBlbHNlIGlmKGZyb21ba10gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdG9ba10gPSBmcm9tW2tdCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYoIWZyb21Jc0V2dCAmJiBmcm9tICYmIGZyb20uaGFzT3duUHJvcGVydHkKICAgICAgICAgICAgJiYgZnJvbS5oYXNPd25Qcm9wZXJ0eSgndG9TdHJpbmcnKSAmJiAhdG8uaGFzT3duUHJvcGVydHkoJ3RvU3RyaW5nJykpIHsKICAgICAgICAgICAgdG8udG9TdHJpbmcgPSBmcm9tLnRvU3RyaW5nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG87CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwudXJsQXBwZW5kCiAgICAgKiBAZGVzYyDlsIbmjIflrprlrZfnrKbkuLLph4znmoTlhoXlrrnmi7zov5t1cmwKICAgICAqIEBwYXJhbSB1cmwge1N0cmluZ30KICAgICAqIEBwYXJhbSBwYXJhbVN0ciB7U3RyaW5nfQogICAgICogQGV4YW1wbGUKICAgICAqIHVybCA9ICJodHRwOi8vd3d3Lmdvb2dsZS5jb20iOwogICAgICogb2N0b3B1cy51dGlsLnVybEFwcGVuZCh1cmwsICJhPTEmYj0yIik7CiAgICAgKiByZXR1cm4gImh0dHA6Ly93d3cuZ29vZ2xlLmNvbT9hPTEmYj0yIgogICAgICovCiAgICB1dGlsLnVybEFwcGVuZCA9IGZ1bmN0aW9uKHVybCwgcGFyYW1TdHIpIHsKICAgICAgICB2YXIgbmV3VXJsID0gdXJsOwogICAgICAgIGlmKHBhcmFtU3RyKSB7CiAgICAgICAgICAgIHZhciBwYXJ0cyA9ICh1cmwgKyAiICIpLnNwbGl0KC9bPyZdLyk7CiAgICAgICAgICAgIG5ld1VybCArPSAocGFydHMucG9wKCkgPT09ICIgIiA/CiAgICAgICAgICAgICAgICBwYXJhbVN0ciA6CiAgICAgICAgICAgICAgICBwYXJ0cy5sZW5ndGggPyAiJiIgKyBwYXJhbVN0ciA6ICI/IiArIHBhcmFtU3RyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld1VybDsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRQYXJhbWV0ZXJTdHJpbmcKICAgICAqIEBkZXNjIOS7juaMh+WumuWQjeWAvOWvuemHjOaQnuWHuuadpeWtl+espuS4suW9ouW8jwogICAgICogQHBhcmFtIHBhcmFtcyB7T2JqZWN0fQogICAgICogQGV4YW1wbGUKICAgICAqIHBhcmFtID0geyBhOiAxLCBiOiAyIH0KICAgICAqIG9jdG9wdXMudXRpbC5nZXRQYXJhbWV0ZXJTdHJpbmcocGFyYW0pCiAgICAgKiByZXR1cm4gImE9MSZiPTIiCiAgICAgKi8KICAgIHV0aWwuZ2V0UGFyYW1ldGVyU3RyaW5nID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgdmFyIHBhcmFtc0FycmF5ID0gW107CiAgICAgICAgZm9yICh2YXIga2V5IGluIHBhcmFtcykgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJhbXNba2V5XTsKICAgICAgICAgICAgaWYgKCh2YWx1ZSAhPSBudWxsKSAmJiAodHlwZW9mIHZhbHVlICE9ICdmdW5jdGlvbicpKSB7CiAgICAgICAgICAgICAgICB2YXIgZW5jb2RlZFZhbHVlOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiB2YWx1ZS5jb25zdHJ1Y3RvciA9PSBBcnJheSkgewogICAgICAgICAgICAgICAgICAgIHZhciBlbmNvZGVkSXRlbUFycmF5ID0gW107CiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW07CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaXRlbUluZGV4PTAsIGxlbj12YWx1ZS5sZW5ndGg7IGl0ZW1JbmRleDxsZW47IGl0ZW1JbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0gPSB2YWx1ZVtpdGVtSW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGVkSXRlbUFycmF5LnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGl0ZW0gPT09IG51bGwgfHwgaXRlbSA9PT0gdW5kZWZpbmVkKSA/ICIiIDogaXRlbSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZW5jb2RlZFZhbHVlID0gZW5jb2RlZEl0ZW1BcnJheS5qb2luKCIsIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlbmNvZGVkVmFsdWUgPSBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFyYW1zQXJyYXkucHVzaChlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZWRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcmFtc0FycmF5LmpvaW4oIiYiKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5nZXRQYXJhbWV0ZXJzCiAgICAgKiBAZGVzYyDku451cmzkuK0/5ZCO55qE5a2X56ym5Liy5Lul5a+56LGh5b2i5byP6L+U5ZueCiAgICAgKiBAcGFyYW0gdXJsIHtTdHJpbmd9CiAgICAgKiBAZXhhbXBsZQogICAgICogdXJsID0gImh0dHA6Ly93d3cuYmFpZHUuY29tP2E9MSZiPTIiCiAgICAgKiBvY3RvcHVzLnV0aWwuZ2V0UGFyYW1ldGVycyh1cmwpOwogICAgICogcmV0dXJuIHsgYTogMSwgYjogMiB9CiAgICAgKi8KICAgIHV0aWwuZ2V0UGFyYW1ldGVycyA9IGZ1bmN0aW9uKHVybCkgewogICAgICAgIHVybCA9ICh1cmwgPT09IG51bGwgfHwgdXJsID09PSB1bmRlZmluZWQpID8gd2luZG93LmxvY2F0aW9uLmhyZWYgOiB1cmw7CiAgICAgICAgdmFyIHBhcmFtc1N0cmluZyA9ICIiOwogICAgICAgIGlmKHVybC5pbmRleE9mKCI/IikgIT0gLTEpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdXJsLmluZGV4T2YoJz8nKSArIDE7CiAgICAgICAgICAgIHZhciBlbmQgPSB1cmwuaW5kZXhPZigiIyIpICE9IC0xID8KICAgICAgICAgICAgICAgIHVybC5pbmRleE9mKCcjJykgOiB1cmwubGVuZ3RoOwogICAgICAgICAgICBwYXJhbXNTdHJpbmcgPSB1cmwuc3Vic3RyaW5nKHN0YXJ0LCBlbmQpOwogICAgICAgIH0KICAgICAgICB2YXIgcGFyYW1ldGVycyA9IHt9OwogICAgICAgIHZhciBwYWlycyA9IHBhcmFtc1N0cmluZy5zcGxpdCgvWyY7XS8pLAogICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgbGVuID0gcGFpcnMubGVuZ3RoOwogICAgICAgIGZvciggOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgdmFyIGtleVZhbHVlID0gcGFpcnNbaV0uc3BsaXQoJz0nKTsKICAgICAgICAgICAgaWYoa2V5VmFsdWVbMF0pIHsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBrZXlWYWx1ZVswXTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gZGVjb2RlVVJJQ29tcG9uZW50KGtleSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSB1bmVzY2FwZShrZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gKGtleVZhbHVlWzFdIHx8ICcnKS5yZXBsYWNlKC9cKy9nLCAiICIpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHVuZXNjYXBlKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc3BsaXQoIiwiKTsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT0gMSkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVbMF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcGFyYW1ldGVyczsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5jcmVhdGVVcmxPYmplY3QKICAgICAqIEBkZXNjIOWIm+W7uuS4gOS4qnVybOWvueixoeeahOWQjeWAvOWvuQogICAgICog6YeM6Z2i5oyJ54WndzNjIHVybOagh+WHhuaPkOS+m+S6huavj+S4gOS4queahOWAvAogICAgICogQGV4YW1wbGUKICAgICAqIHVybCA9ICJodHRwOi8vd3d3Lmdvb2dsZS5jb20/YT0xJmI9MiNhYmM9MSI7CiAgICAgKiBvY3RvcHVzLnV0aWwuY3JlYXRlVXJsT2JqZWN0KHVybCk7CiAgICAgKiByZXR1cm4KICAgICAqIHsKICAgICAqICBhcmdzOiBPYmplY3QsCiAgICAgKiAgYTogIjEiLAogICAgICogIGI6ICIyIiwKICAgICAqICBoYXNoOiAiI2FiYz0xIiwKICAgICAqICBob3N0OiAid3d3Lmdvb2dsZS5jb20iLAogICAgICogIHBhdGhuYW1lOiAiLyIsCiAgICAgKiAgcG9ydDogIjgwIiwKICAgICAqICBwcm90b2NvbDogImh0dHA6IiwKICAgICAqIH0KICAgICAqLwogICAgdXRpbC5jcmVhdGVVcmxPYmplY3QgPSBmdW5jdGlvbih1cmwsIG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICB1cmwgPSB1cmwgfHwgd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgaWYoISgvXlx3KzpcL1wvLykudGVzdCh1cmwpKSB7CiAgICAgICAgICAgIHZhciBsb2MgPSB3aW5kb3cubG9jYXRpb247CiAgICAgICAgICAgIHZhciBwb3J0ID0gbG9jLnBvcnQgPyAiOiIgKyBsb2MucG9ydCA6ICIiOwogICAgICAgICAgICB2YXIgZnVsbFVybCA9IGxvYy5wcm90b2NvbCArICIvLyIgKyBsb2MuaG9zdC5zcGxpdCgiOiIpLnNoaWZ0KCkgKyBwb3J0OwogICAgICAgICAgICBpZih1cmwuaW5kZXhPZigiLyIpID09PSAwKSB7CiAgICAgICAgICAgICAgICB1cmwgPSBmdWxsVXJsICsgdXJsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHBhcnRzID0gbG9jLnBhdGhuYW1lLnNwbGl0KCIvIik7CiAgICAgICAgICAgICAgICBwYXJ0cy5wb3AoKTsKICAgICAgICAgICAgICAgIHVybCA9IGZ1bGxVcmwgKyBwYXJ0cy5qb2luKCIvIikgKyAiLyIgKyB1cmw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMuaWdub3JlQ2FzZSkgewogICAgICAgICAgICB1cmwgPSB1cmwudG9Mb3dlckNhc2UoKTsKICAgICAgICB9CiAgICAgICAgdmFyIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYS5ocmVmID0gdXJsOwogICAgICAgIHZhciB1cmxPYmplY3QgPSB7fTsKICAgICAgICB1cmxPYmplY3QuaG9zdCA9IGEuaG9zdC5zcGxpdCgiOiIpLnNoaWZ0KCk7CiAgICAgICAgdXJsT2JqZWN0LnByb3RvY29sID0gYS5wcm90b2NvbDsKICAgICAgICBpZihvcHRpb25zLmlnbm9yZVBvcnQ4MCkgewogICAgICAgICAgICB1cmxPYmplY3QucG9ydCA9IChhLnBvcnQgPT0gIjgwIiB8fCBhLnBvcnQgPT0gIjAiKSA/ICIiIDogYS5wb3J0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVybE9iamVjdC5wb3J0ID0gKGEucG9ydCA9PSAiIiB8fCBhLnBvcnQgPT0gIjAiKSA/ICI4MCIgOiBhLnBvcnQ7CiAgICAgICAgfQoKICAgICAgICAvL2hhc2gKICAgICAgICB1cmxPYmplY3QuaGFzaCA9IChvcHRpb25zLmlnbm9yZUhhc2ggfHwgYS5oYXNoID09PSAiIyIpID8gIiIgOiBhLmhhc2g7CiAgICAgICAgdmFyIHF1ZXJ5U3RyaW5nID0gYS5zZWFyY2g7CiAgICAgICAgaWYgKCFxdWVyeVN0cmluZykgewogICAgICAgICAgICB2YXIgcU1hcmsgPSB1cmwuaW5kZXhPZigiPyIpOwogICAgICAgICAgICBxdWVyeVN0cmluZyA9IChxTWFyayAhPSAtMSkgPyB1cmwuc3Vic3RyKHFNYXJrKSA6ICIiOwogICAgICAgIH0KICAgICAgICB1cmxPYmplY3QuYXJncyA9IHV0aWwuZ2V0UGFyYW1ldGVycyhxdWVyeVN0cmluZyk7CiAgICAgICAgdXJsT2JqZWN0LnBhdGhuYW1lID0gKGEucGF0aG5hbWUuY2hhckF0KDApID09ICIvIikgPyBhLnBhdGhuYW1lIDogIi8iICsgYS5wYXRobmFtZTsKICAgICAgICByZXR1cm4gdXJsT2JqZWN0OwogICAgfTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy51dGlsLnRyaW0KICAgICAqIEBkZXNjIOWOu+aOieWtl+espuS4suS4pOS+p+epuueZvQogICAgICogQHBhcmFtIHN0ciB7U3RyaW5nfQogICAgICovCiAgICB1dGlsLnRyaW0gPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICBzdHIgPSBTdHJpbmcoc3RyKTsKICAgICAgICByZXR1cm4gISFzdHIudHJpbSA/IHN0ci50cmltKCkgOiBzdHIucmVwbGFjZShuZXcgUmVnRXhwKCIoXltcXHNcXHRcXHhhMFxcdTMwMDBdKyl8KFtcXHUzMDAwXFx4YTBcXHNcXHRdK1x4MjQpIiwgImciKSwgJycpOwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC5yZW1vdmVJdGVtCiAgICAgKiBAcGFyYW0gc291cmNlCiAgICAgKiBAcGFyYW0gaXRlbQogICAgICovCiAgICB1dGlsLnJlbW92ZUl0ZW0gPSBmdW5jdGlvbihzb3VyY2UsIGl0ZW0pIHsKICAgICAgICB2YXIgbGVuID0gc291cmNlLmxlbmd0aCwKICAgICAgICAgICAgaSA9IGxlbjsKICAgICAgICBmb3IoOyBpLS07ICkgewogICAgICAgICAgICBpZihzb3VyY2VbaV0gPT09IGl0ZW0pIHsKICAgICAgICAgICAgICAgIHNvdXJjZS5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMudXRpbC51cHBlckNhc2VPYmplY3QKICAgICAqIEBkZXNjIOWwhuaMh+WumuWvueixoemHjOeahGtleemmluWtl+avjeWkp+WGmQogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fQogICAgICovCiAgICB1dGlsLnVwcGVyQ2FzZU9iamVjdCA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgICB2YXIgdU9iamVjdCA9IHt9OwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgICAgdU9iamVjdFtrZXkudG9VcHBlckNhc2UoKV0gPSBvYmplY3Rba2V5XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVPYmplY3Q7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuY2FtZWxpemUKICAgICAqIEBkZXNjIOmpvOWzsOWMluWtl+espuS4sgogICAgICogQHBhcmFtIHNvdXJjZSB7U3RyaW5nfQogICAgICovCiAgICB1dGlsLmNhbWVsaXplID0gZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgdmFyIG9TdHJpbmdMaXN0ID0gc291cmNlLnNwbGl0KC9bXC18X3xcc3xcLl0vZyk7CiAgICAgICAgdmFyIGNhbWVsaXplZFN0cmluZyA9IG9TdHJpbmdMaXN0WzBdLAogICAgICAgICAgICBpID0gMSwKICAgICAgICAgICAgbGVuID0gb1N0cmluZ0xpc3QubGVuZ3RoOwogICAgICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIHZhciBzID0gb1N0cmluZ0xpc3RbaV07CiAgICAgICAgICAgIGNhbWVsaXplZFN0cmluZyArPSBzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcy5zdWJzdHJpbmcoMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjYW1lbGl6ZWRTdHJpbmc7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuc3R5bGVDc3MKICAgICAqIEBkZXNjIOWwhuWJjee8gOexu2NzcyDmoLflvI/ljJYKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgY3NzID0gIi13ZWJraXQtdHJhbnNpdGlvbiI7CiAgICAgKiBvY3RvcHVzLnV0aWwuc3R5bGVDc3MoY3NzKTsKICAgICAqIHJldHVybiAid2Via2l0VHJhbnNpdGlvbiIKICAgICAqLwogICAgdXRpbC5zdHlsZUNzcyA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHZhciBmbGFnID0gdHJ1ZTsKICAgICAgICB2YXIgc3RyID0gc3RyLnJlcGxhY2UoL1wtKFxTKS9nLCBmdW5jdGlvbigkMSwgJDIpIHsKICAgICAgICAgICAgcmV0dXJuIGZsYWcgPyAoZmxhZyA9IGZhbHNlLCAkMikgOiAkMi50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBzdHI7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwuY3NzU3R5bGUKICAgICAqIEBkZXNjIOWwhuagt+W8j+WMlueahOWJjee8gCBjc3PljJYKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgc3R5bGUgPSAid2Via2l0VHJhbnNpdGlvbiIKICAgICAqIG9jdG9wdXMudXRpbC5jc3NTdHlsZShzdHlsZSk7CiAgICAgKiByZXR1cm4gLXdlYmtpdC10cmFuc2l0aW9uCiAgICAgKi8KICAgIHV0aWwuY3NzU3R5bGUgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICB2YXIgc3RyID0gc3RyLnJlcGxhY2UoLyheXFN8W0EtWl0pL2csIGZ1bmN0aW9uKCQxKSB7CiAgICAgICAgICAgIHJldHVybiAiLSIgKyAkMS50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBzdHI7CiAgICB9OwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLnV0aWwucmVxdWVzdEFuaW1hdGlvbgogICAgICovCiAgICB1dGlsLnJlcXVlc3RBbmltYXRpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlcXVlc3QgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgIHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICB3aW5kb3cub1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICB3aW5kb3cubXNSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgZnVuY3Rpb24oY2FsbGJhY2ssIGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGNhbGxiYWNrLCAxNik7CiAgICAgICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbGxiYWNrLCBlbGVtZW50KSB7CiAgICAgICAgICAgIHJlcXVlc3QuYXBwbHkod2luZG93LCBbY2FsbGJhY2ssIGVsZW1lbnRdKTsKICAgICAgICB9OwogICAgfSkoKTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tgogKiBkb20gLSAgIGRvbeaTjeS9nOmDqOWIhgogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIKICAgICAgICAvKioKICAgICAgICAgKiBAZGVzYyDlt6Xlhbflh73mlbDnmoTlkb3lkI3nqbrpl7QKICAgICAgICAgKi8KICAgICAgICB1ID0gby51dGlsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAZGVzYyDlo7DmmI5kb2N1bWVudAogICAgICAgICAqLwogICAgICAgIGRvYyA9IGRvY3VtZW50OwoKICAgIGZ1bmN0aW9uIGdldFNjcmVlbkJ5KHQpIHsKICAgICAgICB2YXIgdiA9IHdpbmRvd1siaW5uZXIiICsgdF0sCiAgICAgICAgICAgIF92ID0gKHUuaXNOdW1lcmljKHYpICYmIHYgPiAwKSA/IHYgOgogICAgICAgICAgICAgICAgKGRvYy5jb21wYXRNb2RlID09ICJDU1MxQ29tcGF0IikgPyBkb2MuZG9jdW1lbnRFbGVtZW50WyJjbGllbnQiICsgdF0gOiBvLmRvbVsiZ2V0IiArIHRdKGRvYy5ib2R5KTsKICAgICAgICByZXR1cm4gX3YgPiAwID8gX3YgOiAwOwogICAgfQoKICAgIC8qKgogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzLmRvbQogICAgICogQGRlc2Mg5LiA5Lqb5Z+656GA55qEZG9t5pON5L2cCiAgICAgKi8KICAgIG8uZG9tID0gewogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uZwogICAgICAgICAqIEBwYXJhbSBlbAogICAgICAgICAqIEBkZXNjIOmdoGlk5ou/5Liq6IqC54K5IOeUseS6juWPquaYr+eugOWNleaUr+aMgSDmsqHmnInlv4XopoHlhpnlvpfpgqPkuYjpq5jnuqcKICAgICAgICAgKi8KICAgICAgICBnOiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICB2YXIgZWwgPSAodS5pc1N0cmluZyhlbCkgPyBkb2MuZ2V0RWxlbWVudEJ5SWQoZWwpIDogKHUuaXNPYmplY3QoZWwpICYmIGVsKSk7CiAgICAgICAgICAgIHJldHVybiBlbCB8fCBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uJAogICAgICAgICAqIEBwYXJhbSBmaWx0ZXIKICAgICAgICAgKiBAcGFyYW0gZWwKICAgICAgICAgKiBAZGVzYyDkuI3mg7Pph43lpI3nmoTljrvlhpnov5nkuYjlpJog5ou/5Yiw5LiA5Liq6IqC54K56ZuG5ZCICiAgICAgICAgICovCiAgICAgICAgJDogZnVuY3Rpb24oZmlsdGVyLCBlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBlbCB8fCBkb2MsCiAgICAgICAgICAgICAgICBfZWwgPSBvLmcoZWwpOwogICAgICAgICAgICByZXR1cm4gKG8udXRpbC5pc05vZGUoX2VsKSB8fCBfZWwgPT0gZG9jKSA/IF9lbC5xdWVyeVNlbGVjdG9yQWxsKGZpbHRlcikgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20ub25lCiAgICAgICAgICogQHBhcmFtIGZpbHRlcgogICAgICAgICAqIEBwYXJhbSBlbAogICAgICAgICAqIEBkZXNjIOaLv+WIsOaMh+WumuiKgueCueS4i+eahOaWh+aho+a1gemHjOeahOesrOS4gOS4quiKgueCuQogICAgICAgICAqLwogICAgICAgIG9uZTogZnVuY3Rpb24oZmlsdGVyLCBlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBlbCB8fCBkb2MsCiAgICAgICAgICAgICAgICBfZWwgPSBvLmcoZWwpOwogICAgICAgICAgICByZXR1cm4gKG8udXRpbC5pc05vZGUoX2VsKSB8fCBfZWwgPT0gZG9jKSA/IF9lbC5xdWVyeVNlbGVjdG9yKGZpbHRlcikgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uaGFzQ2xhc3MKICAgICAgICAgKiBAZGVzYyDliKTmlq3oioLngrnmnIljbGFzcwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGhhc0NsYXNzOiBmdW5jdGlvbihlbCwgbmFtZSkgewogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIHZhciBuYW1lczsKICAgICAgICAgICAgcmV0dXJuICEhZWwuY2xhc3NMaXN0ID8gZWwuY2xhc3NMaXN0LmNvbnRhaW5zKG5hbWUpIDoKICAgICAgICAgICAgICAgIChuYW1lcyA9IGVsLmNsYXNzTmFtZSwgISFuYW1lcyAmJiBuZXcgUmVnRXhwKCIoXnxcXHMpIiArIG5hbWUgKyAiKFxcc3wkKSIpLnRlc3QobmFtZXMpKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLmFkZENsYXNzCiAgICAgICAgICogQGRlc2Mg57uZ5oyH5a6a6IqC54K55aKe5YqgY2xhc3MKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBhZGRDbGFzczogZnVuY3Rpb24oZWwsIG5hbWUpIHsKICAgICAgICAgICAgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICBuYW1lID0gbmFtZSB8fCBudWxsOwogICAgICAgICAgICBpZighbmFtZSkgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHZhciBjbGFzc0xpc3QgPSBlbC5jbGFzc0xpc3Q7CiAgICAgICAgICAgIGlmKCEhY2xhc3NMaXN0KSB7CiAgICAgICAgICAgICAgICBpZighY2xhc3NMaXN0LmNvbnRhaW5zKG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgZWwuY2xhc3NMaXN0LmFkZChuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmKCFvLmRvbS5oYXNDbGFzcyhlbCwgbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBlbC5jbGFzc05hbWUgKz0gKGVsLmNsYXNzTmFtZSA/ICIgIiA6ICIiKSArIG5hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20ucmVtb3ZlQ2xhc3MKICAgICAgICAgKiBAZGVzYyDliKDpmaTmjIflrproioLngrnnmoTmjIflrppjbGFzcwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbihlbCwgbmFtZSkgewogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIHZhciBuYW1lcywKICAgICAgICAgICAgICAgIGNsYXNzTGlzdCA9IGVsLmNsYXNzTGlzdDsKICAgICAgICAgICAgaWYoISFjbGFzc0xpc3QpIHsKICAgICAgICAgICAgICAgIGlmKGNsYXNzTGlzdC5jb250YWlucyhuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUobmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZihvLmRvbS5oYXNDbGFzcyhlbCwgbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBuYW1lcyA9IGVsLmNsYXNzTmFtZTsKICAgICAgICAgICAgICAgICAgICBpZihuYW1lcykgewogICAgICAgICAgICAgICAgICAgICAgICBlbC5jbGFzc05hbWUgPSB1LnRyaW0obmFtZXMpLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgUmVnRXhwKCIoXnxcXHMrKSIgKyBuYW1lICsgIihcXHMrfCQpIiksICIgIgogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS50b2dnbGVDbGFzcwogICAgICAgICAqIEBkZXNjIHRvZ2dsZeaMh+WumuiKgueCueeahOaMh+Wumuagt+W8jwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudCB8IFN0cmluZ30g5oyH5a6a6IqC54K5CiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30g5oyH5a6a5qC35byPCiAgICAgICAgICovCiAgICAgICAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKGVsLCBuYW1lKSB7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIHQgPSBvLmRvbS5oYXNDbGFzcyhlbCwgbmFtZSk7CiAgICAgICAgICAgIGlmKHQpIHsKICAgICAgICAgICAgICAgIG8uZG9tLnJlbW92ZUNsYXNzKGVsLCBuYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG8uZG9tLmFkZENsYXNzKGVsLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIXQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRXaWR0aAogICAgICAgICAqIEBkZXNjIOiOt+W+l+aMh+WumuiKgueCueeahOWuveW6pgogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBnZXRXaWR0aDogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgdmFyIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIHdpZHRoID0gISFlbC5vZmZzZXRXaWR0aCA/IGVsLm9mZnNldFdpZHRoIDogZWwuY2xpZW50V2lkdGg7CiAgICAgICAgICAgIHJldHVybiB3aWR0aCA+IDAgPyB3aWR0aCA6IDA7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRTY3JlZW5XaWR0aAogICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9CiAgICAgICAgICogQGRlc2Mg6I635b6X5bGP5bmV5a695bqmCiAgICAgICAgICovCiAgICAgICAgZ2V0U2NyZWVuV2lkdGg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZ2V0U2NyZWVuQnkoIldpZHRoIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRTY3JlZW5IZWlnaHQKICAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfQogICAgICAgICAqIEBkZXNjIOiOt+W+l+Wxj+W5lemrmOW6pgogICAgICAgICAqLwogICAgICAgIGdldFNjcmVlbkhlaWdodDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRTY3JlZW5CeSgiSGVpZ2h0Iik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRIZWlnaHQKICAgICAgICAgKiBAZGVzYyDojrflvpfmjIflrproioLngrnpq5jluqYKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZ2V0SGVpZ2h0OiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICB2YXIgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICB2YXIgaGVpZ2h0ID0gISFlbC5vZmZzZXRIZWlnaHQgPyBlbC5vZmZzZXRIZWlnaHQgOiBlbC5jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgIHJldHVybiBoZWlnaHQgPiAwID8gaGVpZ2h0IDogMDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLmluc2VydEFmdGVyCiAgICAgICAgICogQGRlc2Mg5o+S5Yiw5oyH5a6a6IqC54K55ZCO6Z2iCiAgICAgICAgICogQHBhcmFtIG5ld2RvbSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gdGFyZG9tIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGluc2VydEFmdGVyOiBmdW5jdGlvbihuZXdkb20sIHRhcmRvbSkgewogICAgICAgICAgICBuZXdkb20gPSBvLmcobmV3ZG9tKTsKICAgICAgICAgICAgdGFyZG9tID0gby5nKHRhcmRvbSk7CiAgICAgICAgICAgIHRhcmRvbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShuZXdkb20sIHRhcmRvbS5uZXh0U2libGluZyk7CiAgICAgICAgICAgIHJldHVybiBuZXdkb207CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5pbnNlcnRGaXJzdAogICAgICAgICAqIEBwYXJhbSBlbAogICAgICAgICAqIEBwYXJhbSBjb250YWluZXIKICAgICAgICAgKi8KICAgICAgICBpbnNlcnRGaXJzdDogZnVuY3Rpb24oZWwsIGNvbnRhaW5lcikgewogICAgICAgICAgICB2YXIgZWwgPSBvLmcoZWwpLAogICAgICAgICAgICAgICAgY29udGFpbmVyID0gby5nKGNvbnRhaW5lciksCiAgICAgICAgICAgICAgICBmaXJzdENoaWxkID0gY29udGFpbmVyLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIGlmKCFmaXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmluc2VydEJlZm9yZShlbCwgZmlyc3RDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLnNldFN0eWxlcwogICAgICAgICAqIEBkZXNjIOaJuemHj+i1i+WAvAogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gb2JqIHtPYmplY3R9CiAgICAgICAgICogQHBhcmFtIGlzaW5pdCB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBzZXRTdHlsZXM6IGZ1bmN0aW9uKGVsLCBvYmosIGlzaW5pdCkgewogICAgICAgICAgICBpc2luaXQgPSBpc2luaXQgfHwgZmFsc2U7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgaWYoaXNpbml0KSB7CiAgICAgICAgICAgICAgICB2YXIgY3NzVGV4dCA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvcih2YXIgayBpbiBvYmopIHsKICAgICAgICAgICAgICAgIGlmKCFpc2luaXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2sgPSBrOwogICAgICAgICAgICAgICAgICAgIGlmKGsubWF0Y2goL14tKHdlYmtpdHxvfG1zfG1veikvZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2sgID0gdS5zdHlsZUNzcyhrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGVbX2tdID0gb2JqW2tdOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3NzVGV4dCArPSBrICsgIjogIiArIG9ialtrXSArICI7IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighIWNzc1RleHQpIHsKICAgICAgICAgICAgICAgIGVsLnN0eWxlLmNzc1RleHQgPSBjc3NUZXh0OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRTdHlsZQogICAgICAgICAqIEBkZXNjIOiOt+WPluaMh+WumuiKgueCueeahOaMh+WumuWxnuaAp+WAvAogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gc3R5bGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBnZXRTdHlsZTogZnVuY3Rpb24oZWwsIHN0eWxlKSB7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gbnVsbDsKICAgICAgICAgICAgaWYgKGVsICYmIGVsLnN0eWxlKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGVsLnN0eWxlW3UuY2FtZWxpemUoc3R5bGUpXTsKICAgICAgICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jLmRlZmF1bHRWaWV3ICYmCiAgICAgICAgICAgICAgICAgICAgICAgIGRvYy5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjc3MgPSBkb2MuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gY3NzID8gY3NzLmdldFByb3BlcnR5VmFsdWUoc3R5bGUpIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVsLmN1cnJlbnRTdHlsZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGVsLmN1cnJlbnRTdHlsZVt1LmNhbWVsaXplKHN0eWxlKV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9ucyA9IFsnbGVmdCcsICd0b3AnLCAncmlnaHQnLCAnYm90dG9tJ107CiAgICAgICAgICAgICAgICBpZiAod2luZG93Lm9wZXJhICYmCiAgICAgICAgICAgICAgICAgICAgKHBvc2l0aW9ucy5pbmRleE9mKHN0eWxlKSAhPSAtMSkgJiYKICAgICAgICAgICAgICAgICAgICAoby5kb20uZ2V0U3R5bGUoZWwsICdwb3NpdGlvbicpID09ICdzdGF0aWMnKSkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSAnYXV0bycgPyBudWxsIDogdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5nZXRQYXJlbnROb2RlCiAgICAgICAgICogQGRlc2Mg5p+l6K+i56ym5ZCI5p2h5Lu255qE56a75oyH5a6a6IqC54K55pyA6L+R55qE54i26IqC54K5CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FTGVtZW50IHwgU3RyaW5nfSDooqvmn6Xmib7nmoTotbflp4voioLngrkKICAgICAgICAgKiBAcGFyYW0gZmlsdGVyIHtTdHJpbmd9IOetm+mAieWZqAogICAgICAgICAqIEBwYXJhbSBtYXhEZXB0aCB7TnVtYmVyfSDmn6XnnIvnmoTmnIDmt7HlsYLmlbAKICAgICAgICAgKi8KICAgICAgICBnZXRQYXJlbnROb2RlOiBmdW5jdGlvbihlbCwgZmlsdGVyLCBtYXhEZXB0aCkgewogICAgICAgICAgICB2YXIgZWwgPSBvLmcoZWwpOwogICAgICAgICAgICBtYXhEZXB0aCA9IG1heERlcHRoIHx8IDUwOwogICAgICAgICAgICB2YXIgZGVwdGggPSAwLAogICAgICAgICAgICAgICAgX2VsID0gbnVsbDsKICAgICAgICAgICAgZWwgPSBlbC5wYXJlbnROb2RlOwogICAgICAgICAgICB3aGlsZSh1LmlzTm9kZShlbCkgJiYgKGRlcHRoIDwgbWF4RGVwdGgpKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gZWwucGFyZW50Tm9kZSwKICAgICAgICAgICAgICAgICAgICBsaXN0ID0gcGFyZW50LnF1ZXJ5U2VsZWN0b3JBbGwoZmlsdGVyKTsKICAgICAgICAgICAgICAgIGlmKGxpc3QgJiYgbGlzdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdS5lYWNoKGxpc3QsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodS5pc05vZGUoaXRlbSkgJiYgaXRlbSA9PSBlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2VsID0gaXRlbTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbCA9IGVsLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICBpZihfZWwgfHwgZWwudGFnTmFtZSA9PSAiSFRNTCIpCWJyZWFrOwogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX2VsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uZ2V0UG9zaXRpb24KICAgICAgICAgKiBAZGVzYyDojrflvpflhYPntKDnm7jlr7nkuo7mtY/op4jlmajlt6bkuIrop5LnmoTlnZDmoIcKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZ2V0UG9zaXRpb246IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgdmFyIGRvYyA9ICEhZWwub3duZXJEb2N1bWVudCA/IGVsLm93bmVyRG9jdW1lbnQgOiBlbCwKICAgICAgICAgICAgICAgIGdldFN0eWxlID0gby5kb20uZ2V0U3R5bGUsCiAgICAgICAgICAgICAgICBwb3MgPSB7ImxlZnQiOiAwLCAidG9wIjogMH0sCiAgICAgICAgICAgICAgICB2aWV3cG9ydCA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCiAgICAgICAgICAgICAgICBwYXJlbnQgPSBlbDsKICAgICAgICAgICAgaWYoZWwgPT0gdmlld3BvcnQpewogICAgICAgICAgICAgICAgcmV0dXJuIHBvczsKICAgICAgICAgICAgfQogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBwb3MubGVmdCArPSBwYXJlbnQub2Zmc2V0TGVmdDsKICAgICAgICAgICAgICAgIHBvcy50b3AgICs9IHBhcmVudC5vZmZzZXRUb3A7CiAgICAgICAgICAgICAgICBpZiAoZ2V0U3R5bGUocGFyZW50LCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgcG9zLmxlZnQgKz0gZG9jLmJvZHkuc2Nyb2xsTGVmdDsKICAgICAgICAgICAgICAgICAgICBwb3MudG9wICArPSBkb2MuYm9keS5zY3JvbGxUb3A7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICAgICAgICB9IHdoaWxlIChwYXJlbnQgJiYgcGFyZW50ICE9IGVsKTsKICAgICAgICAgICAgaWYoZ2V0U3R5bGUoZWwsICdwb3NpdGlvbicpID09ICdhYnNvbHV0ZScpewogICAgICAgICAgICAgICAgcG9zLnRvcCAgLT0gZG9jLmJvZHkub2Zmc2V0VG9wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudCA9IGVsLm9mZnNldFBhcmVudDsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudCAmJiBwYXJlbnQgIT0gZG9jLmJvZHkpIHsKICAgICAgICAgICAgICAgIHBvcy5sZWZ0IC09IHBhcmVudC5zY3JvbGxMZWZ0OwogICAgICAgICAgICAgICAgaWYgKHBhcmVudC50YWdOYW1lICE9ICdUUicpIHsKICAgICAgICAgICAgICAgICAgICBwb3MudG9wIC09IHBhcmVudC5zY3JvbGxUb3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwb3M7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5jcmVhdGVEb20KICAgICAgICAgKiBAZGVzYyDliJvlu7pkb23oioLngrkKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSBkb23nsbvlnosKICAgICAgICAgKiBAcGFyYW0gYXR0cyB7T2JqZWN0fSBkb23lsZ7mgKflkI3lgLzlr7kKICAgICAgICAgKiBAcGFyYW0gc3R5cyB7T2JqZWN0fSBkb23moLflvI/lkI3lgLzlr7kKICAgICAgICAgKi8KICAgICAgICBjcmVhdGVEb206IGZ1bmN0aW9uKHR5cGUsIGF0dHMsIHN0eXMpIHsKICAgICAgICAgICAgdmFyIGRvbSA9IGRvYy5jcmVhdGVFbGVtZW50KHR5cGUpOwogICAgICAgICAgICBhdHRzICYmIHUuZWFjaChhdHRzLCBmdW5jdGlvbih2LCBhdHQpIHsKICAgICAgICAgICAgICAgIGlmKGF0dCA9PSAiaW5uZXJIVE1MIiB8fCBhdHQgPT0gImlubmVyVGV4dCIpIHsKICAgICAgICAgICAgICAgICAgICBkb21bYXR0XSA9IG8udXRpbC5lbmNvZGVIdG1sKHYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkb20uc2V0QXR0cmlidXRlKGF0dCwgdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzdHlzICYmIG8uZG9tLnNldFN0eWxlcyhkb20sIHN0eXMsIHRydWUpOwogICAgICAgICAgICByZXR1cm4gZG9tOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5kb20uY2xvbmVOb2RlCiAgICAgICAgICogQGRlc2MgY2xvbmXoioLngrkg5Y+v5Lul5bCG5LqL5Lu25LiA6LW3Y2xvbmUg6K+l5LqL5Lu25b+F6aG75piv6YCa6L+H5q2k5qGG5p625Yqg5LiK55qECiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fSDlvoVjbG9uZeeahOiKgueCuQogICAgICAgICAqIEBwYXJhbSBldiB7Qm9vbGVhbn0g5piv5ZCmY2xvbmXkuovku7bnm5HlkKwKICAgICAgICAgKiBAcGFyYW0gYyB7Qm9vbGVhbn0g5piv5ZCm5ou36LSd5a2Q6IqC54K5CiAgICAgICAgICovCiAgICAgICAgY2xvbmVOb2RlOiBmdW5jdGlvbihlbCwgZXYsIGMpIHsKICAgICAgICAgICAgZXYgPSBldiB8fCBmYWxzZTsKICAgICAgICAgICAgYyA9IGMgfHwgZmFsc2U7CiAgICAgICAgICAgIHZhciBjbG9uZUVsID0gby5nKGVsKS5jbG9uZU5vZGUoIWMpOwogICAgICAgICAgICBpZighZXYgfHwgIWVsLl9ldmVudENhY2hlSUQpIHJldHVybiBjbG9uZUVsOwogICAgICAgICAgICB2YXIgb2JzID0gby5ldmVudC5vYnNlcnZlcnNbZWwuX2V2ZW50Q2FjaGVJRF07CiAgICAgICAgICAgIHUuZWFjaChvYnMsIGZ1bmN0aW9uKGl0ZW0sIGkpIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lID0gaXRlbS5uYW1lLAogICAgICAgICAgICAgICAgICAgIG9ic2VydmVyID0gdS5jbG9uZShpdGVtLm9ic2VydmVyKSwKICAgICAgICAgICAgICAgICAgICB1c2VDYXB0dXJlID0gdS5jbG9uZShpdGVtLnVzZUNhcHR1cmUpOwogICAgICAgICAgICAgICAgby5ldmVudC5vbihjbG9uZUVsLCBuYW1lLCBvYnNlcnZlciwgdXNlQ2FwdHVyZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gY2xvbmVFbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLnNjcm9sbExpdGUKICAgICAgICAgKiBAZGVzYyDpkojlr7lpb3Porr7lpIfmu5rliqjmnaHmu5rliqjml7bkuovku7bkvKDmkq3mlrnlkJHlr7zoh7TnmoTmu5rliqjlvILluLjop6PlhrMKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9IOa7muWKqOeahOiKgueCuQogICAgICAgICAqIEBwYXJhbSBpc0hvcml6b24ge0Jvb2xlYW59IOaYr+WQpuaoquWQkQogICAgICAgICAqIEBwYXJhbSBwcmV2ZW50RnJvbSB7RE9NRWxlbWVudH0g5byV6LW3YnVn55qE5qC55rqQ5a655ZmoIOWPr+S4jeS8oAogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgc2Nyb2xsTGl0ZTogZnVuY3Rpb24oZWwsIGlzSG9yaXpvbiwgcHJldmVudEZyb20pIHsKICAgICAgICAgICAgdmFyIHBvcyA9IHsgbGVmdDogMCwgdG9wOiAwIH07CiAgICAgICAgICAgIGlmKHByZXZlbnRGcm9tKSB7CiAgICAgICAgICAgICAgICBwcmV2ZW50RnJvbSA9IG8uZyhwcmV2ZW50RnJvbSk7CiAgICAgICAgICAgICAgICBvLmV2ZW50Lm9uKHByZXZlbnRGcm9tLCAidG91Y2htb3ZlIiwgZnVuY3Rpb24oZSkgeyBvLmV2ZW50LnN0b3AoZSwgdHJ1ZSk7IH0sIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIG8uZG9tLnNldFN0eWxlcyhlbCwgewogICAgICAgICAgICAgICAgIi13ZWJraXQtb3ZlcmZsb3ctc2Nyb2xsaW5nIjogInRvdWNoIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgby5ldmVudC5vbihlbCwgInRvdWNoc3RhcnQiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgdG91Y2hlcyA9IGUudG91Y2hlczsKICAgICAgICAgICAgICAgIGlmKCF0b3VjaGVzKSAgICByZXR1cm47CiAgICAgICAgICAgICAgICBwb3MgPSB7CiAgICAgICAgICAgICAgICAgICAgbGVmdDogdG91Y2hlc1swXS5wYWdlWCwKICAgICAgICAgICAgICAgICAgICB0b3A6IHRvdWNoZXNbMF0ucGFnZVkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIG8uZXZlbnQub24oZWwsICJ0b3VjaG1vdmUiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgdG91Y2hlcyA9IGUudG91Y2hlczsKICAgICAgICAgICAgICAgIGlmKCF0b3VjaGVzKSAgICByZXR1cm47CiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS5jdXJyZW50VGFyZ2V0LAogICAgICAgICAgICAgICAgICAgIHNjcm9sbFRvcCA9IHRhcmdldC5zY3JvbGxUb3AsCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsTGVmdCA9IHRhcmdldC5zY3JvbGxMZWZ0LAogICAgICAgICAgICAgICAgICAgIG1vdmVMZWZ0ID0gdG91Y2hlc1swXS5wYWdlWCwKICAgICAgICAgICAgICAgICAgICBtb3ZlVG9wID0gdG91Y2hlc1swXS5wYWdlWSwKICAgICAgICAgICAgICAgICAgICBzdGFydFRvcCA9IHBvcy50b3AsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRMZWZ0ID0gcG9zLmxlZnQ7CiAgICAgICAgICAgICAgICBpZihpc0hvcml6b24pIHsKICAgICAgICAgICAgICAgICAgICBpZigoc2Nyb2xsTGVmdCA8PSAwICYmIG1vdmVMZWZ0ID4gc3RhcnRMZWZ0KSB8fAogICAgICAgICAgICAgICAgICAgICAgICAoc2Nyb2xsTGVmdCA+PSB0YXJnZXQuc2Nyb2xsV2lkdGggLSB0YXJnZXQuY2xpZW50V2lkdGggLSA1ICYmIG1vdmVMZWZ0IDwgc3RhcnRMZWZ0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYoKHNjcm9sbFRvcCA8PSAwICYmIG1vdmVUb3AgPiBzdGFydFRvcCkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHNjcm9sbFRvcCA+PSB0YXJnZXQuc2Nyb2xsSGVpZ2h0IC0gdGFyZ2V0LmNsaWVudEhlaWdodCAtIDUgJiYgbW92ZVRvcCA8IHN0YXJ0VG9wKSkgewogICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZG9tLmRhdGEKICAgICAgICAgKiBAZGVzYyDor7vlj5bmiJborr7nva7mjIflrproioLngrnnmoTmlbDmja4KICAgICAgICAgKiBAcGFyYW0gZWwge1N0cmluZyB8IERPTUVMZW1lbnR9CiAgICAgICAgICogQHBhcmFtIGF0dHJzIHtTdHJpbmcgfCBBcnJheX0KICAgICAgICAgKi8KICAgICAgICBkYXRhOiBmdW5jdGlvbihlbCwgYXR0cnMpIHsKICAgICAgICAgICAgdmFyIHZzID0ge307CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgaWYodS5pc1N0cmluZyhhdHRycykpIHsKICAgICAgICAgICAgICAgIHZhciBhcnMgPSBhdHRycy5zcGxpdCgiICIpLAogICAgICAgICAgICAgICAgICAgIGxlbiA9IGFycy5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZihsZW4gPT0gMSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbC5kYXRhc2V0ICYmIGVsLmRhdGFzZXRbYXJzWzBdXSB8fCBlbC5nZXRBdHRyaWJ1dGUoImRhdGEtIiArIGFyc1swXSkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdS5lYWNoKGFycywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2l0ZW0gPSB1LmNhbWVsaXplKGl0ZW0pOwogICAgICAgICAgICAgICAgICAgICAgICB2c1tpdGVtXSA9IGVsLmRhdGFzZXQgJiYgZWwuZGF0YXNldFtfaXRlbV0gfHwgZWwuZ2V0QXR0cmlidXRlKCJkYXRhLSIgKyBpdGVtKSB8fCBudWxsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdnMgPSBhdHRyczsKICAgICAgICAgICAgICAgIGZvcih2YXIgayBpbiB2cykgewogICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgiZGF0YS0iICsgaywgdnNba10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2czsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmRvbS5hdHRyCiAgICAgICAgICogQGRlc2Mg6K+75Y+W5oiW6K6+572u5oyH5a6a6IqC54K555qE5bGe5oCnCiAgICAgICAgICovCiAgICAgICAgYXR0cjogZnVuY3Rpb24oZWwsIGF0dHJzKSB7CiAgICAgICAgICAgIHZhciB2cyA9IHt9OwogICAgICAgICAgICBlbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIGlmKHUuaXNTdHJpbmcoYXR0cnMpKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJzID0gYXR0cnMuc3BsaXQoIiAiKSwKICAgICAgICAgICAgICAgICAgICBsZW4gPSBhcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYobGVuID09IDEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuZ2V0QXR0cmlidXRlKGFyc1swXSkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdS5lYWNoKGFycywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICB2c1tpdGVtXSA9IGVsLmdldEF0dHJpYnV0ZShpdGVtKSB8fCBudWxsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdnMgPSBhdHRyczsKICAgICAgICAgICAgICAgIGZvcih2YXIgayBpbiB2cykgewogICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZShrLCB2c1trXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZzOwogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAZGVzYyDlsIbluLjnlKjnmoTpgInmi6nlmajmlrnms5XnmoTlkb3lkI3nqbrpl7Tmj5DliY0KICAgICAqLwogICAgby5nID0gby5kb20uZzsKCiAgICBvLiQgPSBvLmRvbS4kOwoKICAgIG8ub25lID0gby5kb20ub25lOwoKICAgICF3aW5kb3cuJCAmJiAod2luZG93LiQgPSBvLiQpOwoKfSkob2N0b3B1cyk7Ci8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICog5LqL5Lu26YOo5YiGIO+8jSAgIGV2ZW50CiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICog5a6a5LmJ5bqT5YaF5LqL5Lu25pSv5pKRCiAgICAgKiBAbmFtZXNwYWNlIG9jdG9wdXMuZXZlbnQKICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgKi8KICAgIG8uZXZlbnQgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvYnNlcnZlcnMKICAgICAgICAgKiBAZGVzYyDkuIDkuKrnvJPlrZjkuovku7bnm5HlkKznmoRoYXNo6KGoCiAgICAgICAgICogQHR5cGUge29iamVjdH0KICAgICAgICAgKi8KICAgICAgICBvYnNlcnZlcnM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5lbGVtZW50CiAgICAgICAgICogQGRlc2Mg6L+U5Zue5LqL5Lu255qE6IqC54K5CiAgICAgICAgICogQHBhcmFtIGV2ZW50IHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICogQHJldHVybiDop6blj5Hkuovku7bnmoToioLngrkge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZWxlbWVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc1NpbmdsZVRvdWNoCiAgICAgICAgICogQGRlc2Mg5Yik5pat5piv5ZCm5Y2V54K5CiAgICAgICAgICogQHBhcmFtIGV2ZW50IHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc1NpbmdsZVRvdWNoOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gZXZlbnQudG91Y2hlcyAmJiBldmVudC50b3VjaGVzLmxlbmd0aCA9PSAxOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc011bHRpVG91Y2gKICAgICAgICAgKiBAZGVzYyDliKTmlq3mmK/lkKblpJrngrkKICAgICAgICAgKiBAcGFyYW0gZXZlbnQge3dpbmRvdy5ldmVudH0KICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzTXVsdGlUb3VjaDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRvdWNoZXMgJiYgZXZlbnQudG91Y2hlcy5sZW5ndGggPiAxOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc0xlZnRDbGljawogICAgICAgICAqIEBkZXNjIOWIpOaWreaYr+WQpuaYr+W3pumUrueCueWHuwogICAgICAgICAqIEBwYXJhbSBldmVudCB7d2luZG93LmV2ZW50fQogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNMZWZ0Q2xpY2s6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAhISgoKGV2ZW50LndoaWNoKSAmJiAoZXZlbnQud2hpY2ggPT0gMSkpIHx8CiAgICAgICAgICAgICAgICAoKGV2ZW50LmJ1dHRvbikgJiYgKGV2ZW50LmJ1dHRvbiA9PSAxKSkpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5pc1JpZ2h0Q2xpY2sKICAgICAgICAgKiBAZGVzYyDliKTmlq3mmK/lkKblj7PplK7ngrnlh7sKICAgICAgICAgKiBAcGFyYW0gZXZlbnQge3dpbmRvdy5ldmVudH0KICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzUmlnaHRDbGljazogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuICEhKCgoZXZlbnQud2hpY2gpICYmIChldmVudC53aGljaCA9PSAzKSkgfHwKICAgICAgICAgICAgICAgICgoZXZlbnQuYnV0dG9uKSAmJiAoZXZlbnQuYnV0dG9uID09IDIpKSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LnN0b3AKICAgICAgICAgKiBAZGVzYyDmiorkuovku7blgZzkuoYKICAgICAgICAgKiBAcGFyYW0gZXZlbnQge3dpbmRvdy5ldmVudH0KICAgICAgICAgKiBAcGFyYW0gYWxsb3dEZWZhdWx0IHtCb29sZWFufSAtICAg5piv5ZCm5oqK6buY6K6k5ZON5bqU5YGc5LqGCiAgICAgICAgICovCiAgICAgICAgc3RvcDogZnVuY3Rpb24oZXZlbnQsIGFsbG93RGVmYXVsdCkgewogICAgICAgICAgICBpZiAoIWFsbG93RGVmYXVsdCkgewogICAgICAgICAgICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LmZpbmRFbGVtZW50CiAgICAgICAgICogQGRlc2Mg5om+5Yiw6Kem5Y+R5LqL5Lu255qE6IqC54K5CiAgICAgICAgICogQHBhcmFtIGV2ZW50IHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICogQHJldHVybiB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBmaW5kRWxlbWVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBvLmV2ZW50LmVsZW1lbnQoZXZlbnQpOwogICAgICAgICAgICB3aGlsZSAoZWxlbWVudC5wYXJlbnROb2RlICYmICghZWxlbWVudC50YWdOYW1lIHx8CiAgICAgICAgICAgICAgICAoZWxlbWVudC50YWdOYW1lLnRvVXBwZXJDYXNlKCkgIT0gdGFnTmFtZS50b1VwcGVyQ2FzZSgpKSkpewogICAgICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZXZlbnQub24KICAgICAgICAgKiBAZGVzYyDnm5HlkKzkuovku7YKICAgICAgICAgKiBAcGFyYW0gZG9tIHtTdHJpbmcgfCBET01FbGVtZW50fQogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZuIHtGdW5jdGlvbn0KICAgICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24oZG9tLCBuYW1lLCBmbiwgdXNlQ2FwdHVyZSkgewogICAgICAgICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KCIgIiksCiAgICAgICAgICAgICAgICBsZW4gPSBuYW1lcy5sZW5ndGgsCiAgICAgICAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgICBpZihsZW4gPT0gMCkgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB2YXIgZWxlbWVudCA9IG8uZyhkb20pLAogICAgICAgICAgICAgICAgdGhhdCA9IG8uZXZlbnQ7CiAgICAgICAgICAgIHVzZUNhcHR1cmUgPSB1c2VDYXB0dXJlIHx8IGZhbHNlOwogICAgICAgICAgICBpZighdGhhdC5vYnNlcnZlcnMpIHsKICAgICAgICAgICAgICAgIHRoYXQub2JzZXJ2ZXJzID0ge307CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIWVsZW1lbnQuX2V2ZW50Q2FjaGVJRCkgewogICAgICAgICAgICAgICAgdmFyIGlkUHJlZml4ID0gImV2ZW50Q2FjaGVJRF8iOwogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuaWQpIHsKICAgICAgICAgICAgICAgICAgICBpZFByZWZpeCA9IGVsZW1lbnQuaWQgKyAiXyIgKyBpZFByZWZpeDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsZW1lbnQuX2V2ZW50Q2FjaGVJRCA9IG8udXRpbC5jcmVhdGVVbmlxdWVJRChpZFByZWZpeCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yKDsgaS0tOyApIHsKICAgICAgICAgICAgICAgIHRoYXQuX29uKGVsZW1lbnQsIG5hbWVzW2ldLCBmbiwgdXNlQ2FwdHVyZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuZXZlbnQuX29uCiAgICAgICAgICogQGRlc2Mg55uR5ZCs5LqL5Lu2CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZuIHtGdW5jdGlvbn0KICAgICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBfb246IGZ1bmN0aW9uKGVsLCBuYW1lLCBmbiwgdXNlQ2FwdHVyZSkgewogICAgICAgICAgICBpZihuYW1lID09ICJvcnRjaGFuZ2UiKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gIm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cgPyAib3JpZW50YXRpb25jaGFuZ2UiIDogInJlc2l6ZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobmFtZSA9PSAicmVhZHkiKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gIkRPTUNvbnRlbnRMb2FkZWQiOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY2FjaGVJRCA9IGVsLl9ldmVudENhY2hlSUQsCiAgICAgICAgICAgICAgICB0aGF0ID0gby5ldmVudDsKICAgICAgICAgICAgaWYoIXRoYXQub2JzZXJ2ZXJzW2NhY2hlSURdKSB7CiAgICAgICAgICAgICAgICB0aGF0Lm9ic2VydmVyc1tjYWNoZUlEXSA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoYXQub2JzZXJ2ZXJzW2NhY2hlSURdLnB1c2goewogICAgICAgICAgICAgICAgJ2VsZW1lbnQnOiBlbCwKICAgICAgICAgICAgICAgICduYW1lJzogbmFtZSwKICAgICAgICAgICAgICAgICdvYnNlcnZlcic6IGZuLAogICAgICAgICAgICAgICAgJ3VzZUNhcHR1cmUnOiB1c2VDYXB0dXJlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihlbC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKG5hbWUsIGZuLCB1c2VDYXB0dXJlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlbC5hdHRhY2hFdmVudCkgewogICAgICAgICAgICAgICAgZWwuYXR0YWNoRXZlbnQoJ29uJyArIG5hbWUsIGZuKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC5zdG9wT2JzZXJ2aW5nRWxlbWVudAogICAgICAgICAqIEBkZXNjIOaKiuaMh+WumuiKgueCueeahOaJgOacieS6i+S7tuebkeWQrOWBnOaOiQogICAgICAgICAqIEBwYXJhbSBkb20ge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgc3RvcE9ic2VydmluZ0VsZW1lbnQ6IGZ1bmN0aW9uKGRvbSkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IG8uZyhkb20pOwogICAgICAgICAgICB2YXIgY2FjaGVJRCA9IGVsZW1lbnQuX2V2ZW50Q2FjaGVJRDsKICAgICAgICAgICAgdGhpcy5fcmVtb3ZlRWxlbWVudE9ic2VydmVycyhvLmV2ZW50Lm9ic2VydmVyc1tjYWNoZUlEXSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LnN0b3BFdmVudE9ic2VydmVyCiAgICAgICAgICogQHBhcmFtIGRvbSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gZXZlbnQge1N0cmluZ30g5oyH5a6a5YGc5o6J55qE5LqL5Lu257G75Z6LCiAgICAgICAgICogQGRlc2Mg5q2k5pa55rOV5Lya5bCG5oyH5a6a6IqC54K55LiK55qE5oyH5a6a5pa55rOV55qE5omA5pyJ5LqL5Lu255uR5ZCs5YGc5o6JIOaFjueUqAogICAgICAgICAqLwogICAgICAgIHN0b3BFdmVudE9ic2VydmVyOiBmdW5jdGlvbihkb20sIGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBjYWNoZUlEID0gby5nKGRvbSkuX2V2ZW50Q2FjaGVJRCwKICAgICAgICAgICAgICAgIHRoYXQgPSBvLmV2ZW50LAogICAgICAgICAgICAgICAgZWxlbWVudE9ic2VydmVycyA9IHRoYXQub2JzZXJ2ZXJzW2NhY2hlSURdOwogICAgICAgICAgICBpZiAoZWxlbWVudE9ic2VydmVycykgewogICAgICAgICAgICAgICAgdmFyIGkgPSBlbGVtZW50T2JzZXJ2ZXJzLmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvcig7IGktLTsgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5ID0gZWxlbWVudE9ic2VydmVyc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZihldmVudCA9PSBlbnRyeS5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGVudHJ5LmVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkub2JzZXJ2ZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS51c2VDYXB0dXJlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC51bi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgX3JlbW92ZUVsZW1lbnRPYnNlcnZlcnMKICAgICAgICAgKiBAZGVzY+WFt+S9k+WBmuS6i+aDheeahOaWueazlQogICAgICAgICAqIEBwYXJhbSBlbGVtZW50T2JzZXJ2ZXJzIHtBcnJheX0g5LiA5aCG5LqL5Lu257yT5a2Y5a+56LGhCiAgICAgICAgICovCiAgICAgICAgX3JlbW92ZUVsZW1lbnRPYnNlcnZlcnM6IGZ1bmN0aW9uKGVsZW1lbnRPYnNlcnZlcnMpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnRPYnNlcnZlcnMpIHsKICAgICAgICAgICAgICAgIHZhciBpID0gIGVsZW1lbnRPYnNlcnZlcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yKCA7IGktLTsgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJ5ID0gZWxlbWVudE9ic2VydmVyc1tpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IG5ldyBBcnJheShlbnRyeS5lbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5vYnNlcnZlciwKICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkudXNlQ2FwdHVyZSk7CiAgICAgICAgICAgICAgICAgICAgby5ldmVudC51bi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5ldmVudC51bgogICAgICAgICAqIEBkZXNjIOWNleWIoOS4gOS4quaMh+WumuS6i+S7tuebkeWQrAogICAgICAgICAqIEBwYXJhbSBkb20ge1N0cmluZyB8IERPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZm4ge0Z1bmN0aW9ufQogICAgICAgICAqIEBwYXJhbSB1c2VDYXB0dXJlIHtCb29sZWFufQogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IOi/lOWbnuino+mZpOebkeWQrOaYr+WQpuaIkOWKnwogICAgICAgICAqLwogICAgICAgIHVuOiBmdW5jdGlvbihkb20sIG5hbWUsIGZuLCB1c2VDYXB0dXJlKSB7CiAgICAgICAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoIiAiKSwKICAgICAgICAgICAgICAgIGxlbiA9IG5hbWVzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGkgPSBsZW47CiAgICAgICAgICAgIGlmKGxlbiA9PSAwKSAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gby5nKGRvbSksCiAgICAgICAgICAgICAgICBjYWNoZUlEID0gZWxlbWVudC5fZXZlbnRDYWNoZUlELAogICAgICAgICAgICAgICAgZm91bmRFbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB1c2VDYXB0dXJlID0gdXNlQ2FwdHVyZSB8fCBmYWxzZTsKICAgICAgICAgICAgZm9yKDsgaS0tOyApIHsKICAgICAgICAgICAgICAgIGZvdW5kRW50cnkgPSBvLmV2ZW50Ll91bihlbGVtZW50LCBuYW1lc1tpXSwgZm4sIHVzZUNhcHR1cmUsIGNhY2hlSUQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmb3VuZEVudHJ5OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmV2ZW50LnVuCiAgICAgICAgICogQGRlc2Mg5Y2V5Yig5LiA5Liq5oyH5a6a5LqL5Lu255uR5ZCsCiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZuIHtGdW5jdGlvbn0KICAgICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufSDov5Tlm57op6PpmaTnm5HlkKzmmK/lkKbmiJDlip8KICAgICAgICAgKi8KICAgICAgICBfdW46IGZ1bmN0aW9uKGVsLCBuYW1lLCBmbiwgdXNlQ2FwdHVyZSwgaWQpIHsKICAgICAgICAgICAgaWYobmFtZSA9PSAib3J0Y2hhbmdlIikgewogICAgICAgICAgICAgICAgbmFtZSA9ICJvcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93ID8gIm9yaWVudGF0aW9uY2hhbmdlIiA6ICJyZXNpemUiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG5hbWUgPT0gInJlYWR5IikgewogICAgICAgICAgICAgICAgbmFtZSA9ICJET01Db250ZW50TG9hZGVkIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihuYW1lID09ICdrZXlwcmVzcycpIHsKICAgICAgICAgICAgICAgIGlmICggbmF2aWdhdG9yLmFwcFZlcnNpb24ubWF0Y2goL0tvbnF1ZXJvcnxTYWZhcml8S0hUTUwvKSB8fAogICAgICAgICAgICAgICAgICAgIGVsLmRldGFjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgbmFtZSA9ICdrZXlkb3duJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZm91bmRFbnRyeSA9IGZhbHNlLAogICAgICAgICAgICAgICAgZWxlbWVudE9ic2VydmVycyA9IG8uZXZlbnQub2JzZXJ2ZXJzW2lkXTsKICAgICAgICAgICAgaWYgKGVsZW1lbnRPYnNlcnZlcnMpIHsKICAgICAgICAgICAgICAgIHZhciBpPTA7CiAgICAgICAgICAgICAgICB3aGlsZSghZm91bmRFbnRyeSAmJiBpIDwgZWxlbWVudE9ic2VydmVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY2FjaGVFbnRyeSA9IGVsZW1lbnRPYnNlcnZlcnNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYgKChjYWNoZUVudHJ5Lm5hbWUgPT0gbmFtZSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKGNhY2hlRW50cnkub2JzZXJ2ZXIgPT0gZm4pICYmCiAgICAgICAgICAgICAgICAgICAgICAgIChjYWNoZUVudHJ5LnVzZUNhcHR1cmUgPT0gdXNlQ2FwdHVyZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudE9ic2VydmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50T2JzZXJ2ZXJzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvLmV2ZW50Lm9ic2VydmVyc1tpZF0gPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kRW50cnkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmb3VuZEVudHJ5KSB7CiAgICAgICAgICAgICAgICBpZiAoZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAgICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIobmFtZSwgZm4sIHVzZUNhcHR1cmUpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbCAmJiBlbC5kZXRhY2hFdmVudCkgewogICAgICAgICAgICAgICAgICAgIGVsLmRldGFjaEV2ZW50KCdvbicgKyBuYW1lLCBmbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZvdW5kRW50cnk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IHVubG9hZENhY2hlCiAgICAgICAgICogQGRlc2Mg6aG16Z2i6ZSA5q+B55qE5pe25YCZ5biM5pyb5Y+v5Lul6YeK5pS+5o6J5omA5pyJ55uR5ZCsCiAgICAgICAgICovCiAgICAgICAgdW5sb2FkQ2FjaGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoby5ldmVudCAmJiBvLmV2ZW50Lm9ic2VydmVycykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgY2FjaGVJRCBpbiBvLmV2ZW50Lm9ic2VydmVycykgewogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtZW50T2JzZXJ2ZXJzID0gby5ldmVudC5vYnNlcnZlcnNbY2FjaGVJRF07CiAgICAgICAgICAgICAgICAgICAgby5ldmVudC5fcmVtb3ZlRWxlbWVudE9ic2VydmVycy5hcHBseSh0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBbZWxlbWVudE9ic2VydmVyc10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgby5ldmVudC5vYnNlcnZlcnMgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgby5ldmVudC5vbih3aW5kb3csICJ1bmxvYWQiLCBvLmV2ZW50LnVubG9hZENhY2hlLCBmYWxzZSk7CgogICAgLyoqCiAgICAgKiBAY2xhc3Mgb2N0b3B1cy5FdmVudHMKICAgICAqIEBkZXNjIOiHquWumuS5ieS6i+S7tuexuwogICAgICogQHBhcmFtIG9iamVjdCB7T2JqZWN0fSDop4Llr5/orqLpmIXkuovku7bnmoTlr7nosaEg5b+F6ZyACiAgICAgKiBAcGFyYW0gZWxlbWVudCB7RE9NRWxlbWVudH0g5LiA5Liq5ZON5bqU5rWP6KeI5Zmo5LqL5Lu255qEZG9tIOmdnuW/hemcgCDlpoLmnpzmjIflrprkuobmraTlgLwg5YiZ6KGo56S66KaB5a+56K+l6IqC54K56L+b6KGM5LiA5qyh5oOo57ud5Lq65a+w55qE5bCB6KOFCiAgICAgKiBAcGFyYW0gZmFsbFRocm91Z2gge0Jvb2xlYW59CiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICAgICovCiAgICBvLkV2ZW50cyA9IG8uZGVmaW5lKHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RhbnQgb2N0b3B1cy5FdmVudHMuQlJPV1NFUl9FVkVOVFMKICAgICAgICAgKiBAZGVzYyDluLjop4TnmoTmtY/op4jlmajkuovku7YKICAgICAgICAgKi8KICAgICAgICBCUk9XU0VSX0VWRU5UUzogWwogICAgICAgICAgICAibW91c2VvdmVyIiwgIm1vdXNlb3V0IiwgIm1vdXNlZG93biIsICJtb3VzZXVwIiwgIm1vdXNlbW92ZSIsCiAgICAgICAgICAgICJjbGljayIsICJkYmxjbGljayIsICJyaWdodGNsaWNrIiwgImRibHJpZ2h0Y2xpY2siLAogICAgICAgICAgICAicmVzaXplIiwKICAgICAgICAgICAgImZvY3VzIiwgImJsdXIiLAogICAgICAgICAgICAidG91Y2hzdGFydCIsICJ0b3VjaG1vdmUiLCAidG91Y2hlbmQiLAogICAgICAgICAgICAia2V5ZG93biIKICAgICAgICBdLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBsaXN0ZW5lcnMKICAgICAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICAgICAqIEBkZXNjIOS6i+S7tuebkeWQrOeahGhhc2jooagKICAgICAgICAgKi8KICAgICAgICBsaXN0ZW5lcnM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG9iagogICAgICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgICAgICogQGRlc2Mg5LqL5Lu25a+56LGh5omA5bGe55qE5Li75L2TCiAgICAgICAgICovCiAgICAgICAgb2JqOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIEB0eXBlIHtET01FTGVtZW50fQogICAgICAgICAqIEBkZXNjIOS6i+S7tue7keWumueahOiKgueCuQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBldmVudEhhbmRsZXIKICAgICAgICAgKiBAZGVzYyDnu5HlrprlnKjoioLngrnkuIrnmoTop6blj5Hlh73mlbAKICAgICAgICAgKiBAdHlwZSB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgZXZlbnRIYW5kbGVyOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBmYWxsVGhyb3VnaAogICAgICAgICAqIEBkZXNjIOS6i+S7tuaYr+WQpuWFgeiuuOS8oOaSrQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGZhbGxUaHJvdWdoOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXh0ZW5zaW9ucwogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICogQGRlc2Mg5omA5pyJ6KKr5rOo5YaM55qE5paw55qE6Ieq5a6a5LmJ5LqL5Lu26ZyA6KaB6L+Z5Liq5a6e5L6LCiAgICAgICAgICog6Ieq5a6a5LmJ5LqL5Lu25piv5oyH5LulT3VwZW5nLkV2ZW50cy4q5byA5aS055qE6Ieq5a6a5LmJ5LqL5Lu2CiAgICAgICAgICoga2V55Li66Ieq5a6a5LmJ5LqL5Lu25ZCN5aaCdGFwIHZhbHVl5Li66Ieq5a6a5LmJ5LqL5Lu25aaCT3VwZW5nLkV2ZW50cy5UYXAg5Y+q5piv5Li+5Liq5L6L5a2Q5LiN55So5aSq6K6k55yfCiAgICAgICAgICovCiAgICAgICAgZXh0ZW5zaW9uczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXh0ZW5zaW9uQ291bnQKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqIEBkZXNjIGtleeaYr+iHquWumuS5ieS6i+S7tueahGtleSB2YWx1ZeaYr2hhbmRsZXLnmoTkuKrmlbAKICAgICAgICAgKi8KICAgICAgICBleHRlbnNpb25Db3VudDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3M6IG9jdG9wdXMuRXZlbnRzLmluaXRpYWxpemUKICAgICAgICAgKiBAcGFyYW0gb2JqIHtPYmplY3R9IOinguWvn+iuoumYheS6i+S7tueahOWvueixoSDlv4XpnIAKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9IOS4gOS4quWTjeW6lOa1j+iniOWZqOS6i+S7tueahGRvbSDpnZ7lv4XpnIAg5aaC5p6c5oyH5a6a5LqG5q2k5YC8IOWImeihqOekuuimgeWvueivpeiKgueCuei/m+ihjOS4gOasoeaDqOe7neS6uuWvsOeahOWwgeijhQogICAgICAgICAqIEBwYXJhbSBmYWxsVGhyb3VnaCB7Qm9vbGVhbn0KICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9iaiwgZWwsIGZhbGxUaHJvdWdoLCBvcHRpb25zKSB7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLm9iaiA9IG9iajsKICAgICAgICAgICAgdGhpcy5mYWxsVGhyb3VnaCA9IGZhbGxUaHJvdWdoOwogICAgICAgICAgICB0aGlzLmxpc3RlbmVycyA9IHt9OwogICAgICAgICAgICB0aGlzLmV4dGVuc2lvbnMgPSB7fTsKICAgICAgICAgICAgdGhpcy5leHRlbnNpb25Db3VudCA9IHt9OwogICAgICAgICAgICBpZiAoZWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5hdHRhY2hUb0VsZW1lbnQoZWwpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy5kZXN0cm95CiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBkZXNjIOWIm+W7uueahOS6i+S7tuWvueixoeiHquaIkeino+iEsQogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZm9yICh2YXIgZSBpbiB0aGlzLmV4dGVuc2lvbnMpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5leHRlbnNpb25zW2VdICE9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV4dGVuc2lvbnNbZV0uZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXh0ZW5zaW9ucyA9IG51bGw7CiAgICAgICAgICAgIGlmICh0aGlzLmVsKSB7CiAgICAgICAgICAgICAgICBvLmV2ZW50LnN0b3BPYnNlcnZpbmdFbGVtZW50KHRoaXMuZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxpc3RlbmVycyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMub2JqID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5mYWxsVGhyb3VnaCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZXZlbnRIYW5kbGVyID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYXR0YWNoVG9FbGVtZW50CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGF0dGFjaFRvRWxlbWVudDogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZWwpIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcE9ic2VydmluZ0VsZW1lbnQodGhpcy5lbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50SGFuZGxlciA9IG8udXRpbC5iaW5kQXNFdmVudExpc3RlbmVyKAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQnJvd3NlckV2ZW50LCB0aGlzCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwgPSBlbDsKICAgICAgICAgICAgdmFyIGkgPSAwLAogICAgICAgICAgICAgICAgbGVuID0gdGhpcy5CUk9XU0VSX0VWRU5UUy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQub24oZWwsIHRoaXMuQlJPV1NFUl9FVkVOVFNbaV0sIHRoaXMuZXZlbnRIYW5kbGVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyDkuI3ljrvmjolpZeS4i+S8mjLmjokKICAgICAgICAgICAgby5ldmVudC5vbihlbCwgImRyYWdzdGFydCIsIG8uZXZlbnQuc3RvcCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGhhbmRsZUJyb3dzZXJFdmVudAogICAgICAgICAqIEBkZXNjIOWcqOaMh+WummRvbeiKgueCueeahOaDheWGteS4iyDlsIHoo4Xor6Vkb23op6blj5HnmoRldmVudOWxnuaApwogICAgICAgICAqLwogICAgICAgIGhhbmRsZUJyb3dzZXJFdmVudDogZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gZXZ0LnR5cGUsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVyc1t0eXBlXTsKICAgICAgICAgICAgaWYoIWxpc3RlbmVycyB8fCBsaXN0ZW5lcnMubGVuZ3RoID09IDApIHJldHVybjsKICAgICAgICAgICAgdmFyIHRvdWNoZXMgPSBldnQudG91Y2hlczsKICAgICAgICAgICAgaWYgKHRvdWNoZXMgJiYgdG91Y2hlc1swXSkgewogICAgICAgICAgICAgICAgdmFyIHggPSAwLAogICAgICAgICAgICAgICAgICAgIHkgPSAwLAogICAgICAgICAgICAgICAgICAgIG51bSA9IHRvdWNoZXMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIHRvdWNoLAogICAgICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBudW07ICsraSkgewogICAgICAgICAgICAgICAgICAgIHRvdWNoID0gdG91Y2hlc1tpXTsKICAgICAgICAgICAgICAgICAgICB4ICs9IHRvdWNoLmNsaWVudFg7CiAgICAgICAgICAgICAgICAgICAgeSArPSB0b3VjaC5jbGllbnRZOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXZ0LmNsaWVudFggPSB4IC8gbnVtOwogICAgICAgICAgICAgICAgZXZ0LmNsaWVudFkgPSB5IC8gbnVtOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudHJpZ2dlckV2ZW50KHR5cGUsIGV2dCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy5vbgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAZGVzYyDmt7vliqDoh6rlrprkuYnkuovku7bnm5HlkKwKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDkuovku7bnsbvlnosKICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IOWbnuiwgwogICAgICAgICAqIEBwYXJhbSBvYmoge09iamVjdH0g5LqL5Lu257uR5a6a55qE5a+56LGhIOm7mOiupOS4unRoaXMub2JqZWN0CiAgICAgICAgICogQHBhcmFtIHByaW9yaXR5IHtCb29sZWFuIHwgT2JqZWN0fSDkuLp0cnVl5pe2IOWwhuWinuWKoOeahOWbnuiwg+aJlOWcqOinpuWPkeWbnuiwg+mYn+WIl+eahOmYn+WktCDlj6/ku6XnkIbop6PkuLrkvKrlkIzmraUKICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24odHlwZSwgZnVuYywgb2JqLCBwcmlvcml0eSkgewogICAgICAgICAgICBpZiAodHlwZSBpbiBvLkV2ZW50cyAmJiAhdGhpcy5leHRlbnNpb25zW3R5cGVdKSB7CiAgICAgICAgICAgICAgICB0aGlzLmV4dGVuc2lvbnNbdHlwZV0gPSBuZXcgby5FdmVudHNbdHlwZV0odGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZ1bmMgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG9iaiA9PSBudWxsIHx8IG9iaiA9PSB1bmRlZmluZWQpICB7CiAgICAgICAgICAgICAgICAgICAgb2JqID0gdGhpcy5vYmo7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnNbdHlwZV07CiAgICAgICAgICAgICAgICBpZiAoIWxpc3RlbmVycykgewogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuZXJzW3R5cGVdID0gbGlzdGVuZXJzOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXh0ZW5zaW9uQ291bnRbdHlwZV0gPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVyID0ge29iajogb2JqLCBmdW5jOiBmdW5jfTsKICAgICAgICAgICAgICAgIGlmIChwcmlvcml0eSkgewogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UodGhpcy5leHRlbnNpb25Db3VudFt0eXBlXSwgMCwgbGlzdGVuZXIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJpb3JpdHkgPT09ICJvYmplY3QiICYmIHByaW9yaXR5LmV4dGVuc2lvbikgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4dGVuc2lvbkNvdW50W3R5cGVdKys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuRXZlbnRzLnVuCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBkZXNjIOWPlua2iOiHquWumuS5ieS6i+S7tueahOebkeWQrAogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOS6i+S7tuexu+WeiwogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g6Kem5Y+R5Zue6LCDCiAgICAgICAgICogQHBhcmFtIG9iaiB7T2JqZWN0fSDpu5jorqToh6rouqsKICAgICAgICAgKi8KICAgICAgICB1bjogZnVuY3Rpb24odHlwZSwgZnVuYywgb2JqKSB7CiAgICAgICAgICAgIGlmIChvYmogPT0gbnVsbCkgIHsKICAgICAgICAgICAgICAgIG9iaiA9IHRoaXMub2JqOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVyc1t0eXBlXTsKICAgICAgICAgICAgaWYgKGxpc3RlbmVycyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsIGxlbj1saXN0ZW5lcnMubGVuZ3RoOyBpPGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3RlbmVyc1tpXS5vYmogPT0gb2JqICYmIGxpc3RlbmVyc1tpXS5mdW5jID09IGZ1bmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy50cmlnZ2VyRXZlbnQKICAgICAgICAgKiBAZGVzYyDop6blj5Hkuovku7YKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDop6blj5Hkuovku7bnsbvlnosKICAgICAgICAgKiBAcGFyYW0gZXZ0IHtldmVudH0KICAgICAgICAgKi8KICAgICAgICB0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGV2dCkgewogICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnNbdHlwZV07CiAgICAgICAgICAgIGlmKCFsaXN0ZW5lcnMgfHwgbGlzdGVuZXJzLmxlbmd0aCA9PSAwKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICBpZiAoZXZ0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV2dCA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2dC5vYmogPSB0aGlzLm9iajsKICAgICAgICAgICAgZXZ0LmVsID0gdGhpcy5lbDsKICAgICAgICAgICAgaWYoIWV2dC50eXBlKSB7CiAgICAgICAgICAgICAgICBldnQudHlwZSA9IHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9jbG9uZeS4gOS7vQogICAgICAgICAgICBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMuc2xpY2UoKTsKICAgICAgICAgICAgdmFyIGNvbnRpbnVlQ2hhaW4sCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGxlbiA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGxpc3RlbmVyc1tpXTsKICAgICAgICAgICAgICAgIC8vIGJpbmQgdGhlIGNvbnRleHQgdG8gY2FsbGJhY2sub2JqCiAgICAgICAgICAgICAgICBjb250aW51ZUNoYWluID0gY2FsbGJhY2suZnVuYy5hcHBseShjYWxsYmFjay5vYmosIFtldnRdKTsKICAgICAgICAgICAgICAgIGlmIChjb250aW51ZUNoYWluID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIC8vIOWmguaenOi/lOWbnuWAvOS4umZhbHNl6KGo56S65Zue6LCD5Yiw5q2k5Li65q2iCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0aGlzLmZhbGxUaHJvdWdoKSB7CiAgICAgICAgICAgICAgICBvLmV2ZW50LnN0b3AoZXZ0LCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGludWVDaGFpbjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuRXZlbnRzLnJlbW92ZQogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAZGVzYyDnm7TmjqXmiormjIflrprkuovku7bnsbvlnovnmoTnm5HlkKzlm57osIPnva7nqboKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHJlbW92ZTogZnVuY3Rpb24odHlwZSkgewogICAgICAgICAgICBpZiAodGhpcy5saXN0ZW5lcnNbdHlwZV0gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5lcnNbdHlwZV0gPSBbXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5FdmVudHMucmVnaXN0ZXIKICAgICAgICAgKiBAZGVzYyDmibnph4/lop7liqDkuovku7YKICAgICAgICAgKiBAcGFyYW0gZXZzIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGV2cykgewogICAgICAgICAgICBmb3IodmFyIHR5cGUgaW4gZXZzKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlICE9ICJzY29wZSIgJiYgZXZzLmhhc093blByb3BlcnR5KHR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbih0eXBlLCBldnNbdHlwZV0sIGV2cy5zY29wZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkV2ZW50cy51bnJlZ2lzdGVyCiAgICAgICAgICogQGRlc2Mg5om56YeP5Y676Zmk5LqL5Lu2CiAgICAgICAgICogQHBhcmFtIGV2cyB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIHVucmVnaXN0ZXI6IGZ1bmN0aW9uKGV2cykgewogICAgICAgICAgICBmb3IodmFyIHR5cGUgaW4gZXZzKSB7CiAgICAgICAgICAgICAgICBpZih0eXBlICE9ICJzY29wZSIgJiYgZXZzLmhhc093blByb3BlcnR5KHR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51bih0eXBlLCBldnNbdHlwZV0sIGV2cy5zY29wZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAiT2N0b3B1cy5FdmVudHMiCiAgICB9KTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tuWfuuehgOW6k+aWh+S7tgogKiDmqKHmnb/lvJXmk47pg6jliIYKICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKi8KOyhmdW5jdGlvbihvLCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAgKiBAbmFtZXNwYWNlIG9jdG9wdXMudGVtcGxhdGUKICAgICAqLwogICAgby50ZW1wbGF0ZSA9IG8udGVtcGxhdGUgfHwge307CgogICAgby5leHRlbmQoby50ZW1wbGF0ZSwgewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjYWNoZXMKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIGNhY2hlczoge30sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCB0ZW1wbGF0ZVRleHQKICAgICAgICAgKiBAcGFyYW0gZWxlbWVudAogICAgICAgICAqLwogICAgICAgIHRlbXBsYXRlVGV4dDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICBpZighby51dGlsLmlzTm9kZShlbGVtZW50KSkgcmV0dXJuICIiOwogICAgICAgICAgICBpZigvXihpbnB1dHx0ZXh0YXJlYSkkL2kudGVzdChlbGVtZW50LnRhZ05hbWUpKSByZXR1cm4gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIG8udXRpbC5kZWNvZGVIdG1sKGVsZW1lbnQuaW5uZXJIVE1MKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgcmVnaXN0ZXIKICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gdGFyZ2V0IHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihpZCwgdGFyZ2V0KSB7CiAgICAgICAgICAgIGlmKCFpZCkgcmV0dXJuOwogICAgICAgICAgICBpZih0aGlzLmNhY2hlc1tpZF0pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNhY2hlc1tpZF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGVzW2lkXSA9IHRoaXMucGFyc2Uoby51dGlsLmlzU3RyaW5nKHRhcmdldCkgPyB0YXJnZXQgOiB0aGlzLnRlbXBsYXRlVGV4dChvLmcodGFyZ2V0KSkpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBwYXJzZQogICAgICAgICAqIEBwYXJhbSB0ZW1wbGF0ZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHBhcnNlOiBmdW5jdGlvbih0ZW1wbGF0ZSkgewogICAgICAgICAgICB2YXIgYm9keSA9IFtdOwogICAgICAgICAgICBib2R5LnB1c2goIndpdGgodGhpcyl7Iik7CiAgICAgICAgICAgIGJvZHkucHVzaCh0ZW1wbGF0ZQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcclxuXSsvZywgIlxuIikgLy8g5Y675o6J5aSa5L2Z55qE5o2i6KGM77yM5bm25LiU5Y675o6JSUXkuK3lm7DmibDkurrnmoRccgogICAgICAgICAgICAgICAgLnJlcGxhY2UoL15cbit8XHMrJC9tZywgIiIpIC8vIOWOu+aOieepuuihjO+8jOmmlumDqOepuuihjO+8jOWwvumDqOepuueZvQogICAgICAgICAgICAgICAgLnJlcGxhY2UoLygoXlxzKls8PiEjXiZcdTAwMDAtXHUwMDA4XHUwMDdGLVx1ZmZmZl0uKiR8Xi4qWzw+XVxzKiR8Xig/IVxzKihlbHNlfGRvfHRyeXxmaW5hbGx5KVxzKiQpW14nIjo7LFxbXF17fSgpXG5cL10rJHxeKFxzKigoW1x3LV0rXHMqPVxzKiJbXiJdKiIpfChbXHctXStccyo9XHMqJ1teJ10qJykpKStccyokfF5ccyooWy4jXVtcdy0uXSsoOlx3Kyk/KFxzKnwsKSkqKD8hKGVsc2V8ZG98d2hpbGV8dHJ5fHJldHVybilcYilbLiNdP1tcdy0uKl0rKDpcdyspP1xzKlx7LiokKVxzPykrL21nLCBmdW5jdGlvbihleHByZXNzaW9uKSB7IC8vIOi+k+WHuuWOn+aWhwogICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSBbJyInLCBleHByZXNzaW9uCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8mbm9uZTsvZywgIiIpIC8vIOepuuWtl+espgogICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvWyInXFxdL2csICJcXCQmIikgLy8g5aSE55CG6L2s5LmJ56ymCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cbi9nLCAiXFxuIikgLy8g5aSE55CG5Zue6L2m6L2s5LmJ56ymCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8oIT8jKVx7KC4qPylcfS9nLCBmdW5jdGlvbiAoYWxsLCBmbGFnLCB0ZW1wbGF0ZSkgeyAvLyDlj5jph4/mm7/mjaIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gdGVtcGxhdGUucmVwbGFjZSgvXFxuL2csICJcbiIpLnJlcGxhY2UoL1xcKFtcXCciXSkvZywgIiQxIik7IC8vIOi/mOWOn+i9rOS5iQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkZW50aWZpZXIgPSAvXlthLXokXVtcdyskXSskL2kudGVzdCh0ZW1wbGF0ZSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAhKC9eKHRydWV8ZmFsc2V8TmFOfG51bGx8dGhpcykkLy50ZXN0KHRlbXBsYXRlKSk7IC8vIOWNlee6r+WPmOmHj++8jOWKoOS4gOS4quacquWumuS5ieS/neaKpAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsnIiwnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPyBbJ3R5cGVvZiAnLCB0ZW1wbGF0ZSwgJz09InVuZGVmaW5lZCI/IiI6J10uam9pbigiIikgOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZmxhZyA9PSAiIyIgPyAnX2VuY29kZV8nIDogIiIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcoJywgdGVtcGxhdGUsICcpLCInXS5qb2luKCIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSksICciJ10uam9pbigiIikucmVwbGFjZSgvXiIiLHwsIiIkL2csICIiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZXhwcmVzc2lvbikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsnX291dHB1dF8ucHVzaCgnLCBleHByZXNzaW9uLCAnKTsnXS5qb2luKCIiKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiAiIjsKICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgYm9keS5wdXNoKCJ9Iik7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBuZXcgRnVuY3Rpb24oIl9vdXRwdXRfIiwgIl9lbmNvZGVfIiwgImhlbHBlciIsIGJvZHkuam9pbigiIikpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMudGVtcGxhdGUuZm9ybWF0CiAgICAgICAgICovCiAgICAgICAgZm9ybWF0OiBmdW5jdGlvbihpZCwgZGF0YSwgaGVscGVyKSB7CiAgICAgICAgICAgIGlmICghaWQpIHJldHVybiAiIjsKICAgICAgICAgICAgdmFyIHJlYWRlciwgZWxlbWVudDsKICAgICAgICAgICAgaWYgKG8udXRpbC5pc05vZGUoaWQpKSB7IC8vIOWmguaenOaYr0RvbeWvueixoQogICAgICAgICAgICAgICAgZWxlbWVudCA9IGlkOwogICAgICAgICAgICAgICAgaWQgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgiaWQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBoZWxwZXIgPSBoZWxwZXIgfHwgdGhpczsKICAgICAgICAgICAgcmVhZGVyID0gdGhpcy5jYWNoZXNbaWRdOwogICAgICAgICAgICBpZighcmVhZGVyKSB7CiAgICAgICAgICAgICAgICBpZighL1teXHctXS8udGVzdChpZCkpIHsKICAgICAgICAgICAgICAgICAgICBpZighZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0gby5nKGlkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmVhZGVyID0gdGhpcy5yZWdpc3RlcihpZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlYWRlciA9IHRoaXMucGFyc2UoaWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSBbXTsKICAgICAgICAgICAgcmVhZGVyLmNhbGwoZGF0YSB8fCAiIiwgb3V0cHV0LCBvLnV0aWwuZW5jb2RlSHRtbCwgaGVscGVyKTsKICAgICAgICAgICAgcmV0dXJuIG91dHB1dC5qb2luKCIiKTsKICAgICAgICB9CiAgICB9KTsKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupMKICogYWpheOaWueazlQogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQHJlcXVpcmUgbGliL2RvbS5qcwogKi8KOyhmdW5jdGlvbiAobywgdW5kZWZpbmVkKSB7CgogICAgby5hamF4ID0gby5hamF4IHx8IHt9OwoKICAgIC8qKgogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzLmFqYXgKICAgICAqIEBkZXNjIGFqYXjor7fmsYLmlrnms5UKICAgICAqLwogICAgby5leHRlbmQoby5hamF4LCB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IERFRkFVTFRfQ09ORklHCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKiBAZGVzYyDphY3nva7pobkKICAgICAgICAgKiB0eXBlIC0ge1N0cmluZ30gR0VULCBQT1NULCBQVVQsIERFTEVURSwgSEVBRCwgT1BUSU9OUy4g6buY6K6k5pivR0VULgogICAgICAgICAqIHVybCAtIHtTdHJpbmd9IOivt+axgueahOWcsOWdgAogICAgICAgICAqIGFzeW5jIC0ge0Jvb2xlYW59IOaYr+WQpuWQjOatpeivt+axgiAg6buY6K6k5pivdHJ1ZS4KICAgICAgICAgKiB1c2VyIC0ge1N0cmluZ30g55So5oi35ZCNCiAgICAgICAgICogcGFzc3dvcmQgLSB7U3RyaW5nfSDlr4bnoIEKICAgICAgICAgKiBkYXRhIC0ge1N0cmluZyB8IE9iamVjdH0gUE9TVOS4jlBVVOaPkOS6pOeahOaVsOaNrgogICAgICAgICAqIGNvbXBsZXRlIC0ge0Z1bmN0aW9ufQogICAgICAgICAqIHN1Y2Nlc3MgLSB7RnVuY3Rpb259CiAgICAgICAgICogZXJyb3IgLSB7RnVuY3Rpb259CiAgICAgICAgICogc2NvcGUgLSB7T2JqZWN0fQogICAgICAgICAqIGJlZm9yZVNlbmQgICAtICAge0Z1bmN0aW9ufSDor7fmsYLlj5Hlh7rliY3osIPnlKgKICAgICAgICAgKiB0aW1lb3V0ICAtICAge051bWJlcn0g5bu25pe2CiAgICAgICAgICovCiAgICAgICAgREVGQVVMVF9DT05GSUc6IHsKICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgIHVybDogd2luZG93LmxvY2F0aW9uLmhyZWYsCiAgICAgICAgICAgIGFzeW5jOiB0cnVlLAogICAgICAgICAgICB1c2VyOiB1bmRlZmluZWQsCiAgICAgICAgICAgIHBhc3N3b3JkOiB1bmRlZmluZWQsCiAgICAgICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgICAgIGNvbXBsZXRlOiBvLnV0aWwuZW1wdHksCiAgICAgICAgICAgIHN1Y2Nlc3M6IG51bGwsCiAgICAgICAgICAgIGVycm9yOiBudWxsLAogICAgICAgICAgICBzY29wZTogbnVsbCwKICAgICAgICAgICAgYmVmb3JlU2VuZDogbnVsbCwKICAgICAgICAgICAgdGltZW91dDogMCwKICAgICAgICAgICAgY3Jvc3NEb21haW46IGZhbHNlCiAgICAgICAgfSwKCiAgICAgICAganNvbnBJRDogMCwKCiAgICAgICAganNvblR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICBodG1sVHlwZTogJ3RleHQvaHRtbCcsCgogICAgICAgIFNDUklQVF9SRUdFWDogLzxzY3JpcHRcYltePF0qKD86KD8hPFwvc2NyaXB0Pik8W148XSopKjxcL3NjcmlwdD4vZ2ksCiAgICAgICAgU0NSSVBUX1RZUEVfUkVHRVg6IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL2phdmFzY3JpcHQvaSwKICAgICAgICBYTUxfVFlQRV9SRUdFWDogL14oPzp0ZXh0fGFwcGxpY2F0aW9uKVwveG1sL2ksCiAgICAgICAgVVJMX1NQTElUX1JFR0VYOiAvKFteOl0qOilcL1wvKFteOl0qOj9bXkBdKkApPyhbXjpcL1w/XSopOj8oW15cL1w/XSopLywKICAgICAgICBCTEFOS19SRUdFWDogL15ccyokLywKICAgICAgICBhY2NlcHRzOiB7CiAgICAgICAgICAgIHNjcmlwdDogJ3RleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCcsCiAgICAgICAgICAgIGpzb246ICAgdGhpcy5qc29uVHlwZSwKICAgICAgICAgICAgeG1sOiAgICAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgICAgICAgIGh0bWw6ICAgdGhpcy5odG1sVHlwZSwKICAgICAgICAgICAgdGV4dDogICAndGV4dC9wbGFpbicKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB4aHIKICAgICAgICAgKiBAdHlwZSB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgeGhyOiBmdW5jdGlvbigpIHsgcmV0dXJuIG5ldyB3aW5kb3cuWE1MSHR0cFJlcXVlc3QoKTsgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG1pbWVUb0RhdGFUeXBlCiAgICAgICAgICovCiAgICAgICAgbWltZVRvRGF0YVR5cGU6IGZ1bmN0aW9uKG1pbWUpIHsKICAgICAgICAgICAgcmV0dXJuIG1pbWUgJiYgKCBtaW1lID09IHRoaXMuaHRtbFR5cGUgPyAnaHRtbCcgOgogICAgICAgICAgICAgICAgbWltZSA9PSB0aGlzLmpzb25UeXBlID8gJ2pzb24nIDoKICAgICAgICAgICAgICAgICAgICB0aGlzLlNDUklQVF9UWVBFX1JFR0VYLnRlc3QobWltZSkgPyAnc2NyaXB0JyA6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuWE1MX1RZUEVfUkVHRVgudGVzdChtaW1lKSAmJiAneG1sJyApIHx8ICd0ZXh0JwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCByZXF1ZXN0CiAgICAgICAgICogQGRlc2Mg5Y+R5Ye66K+35rGCIOWQhOenjQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9IOmFjee9rumhuQogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fQogICAgICAgICAqLwogICAgICAgIHJlcXVlc3Q6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRDb25maWcgPSB0aGlzLkRFRkFVTFRfQ09ORklHLAogICAgICAgICAgICAgICAgY29uZmlnID0gby51dGlsLmFwcGx5RGVmYXVsdHMob3B0aW9ucywgZGVmYXVsdENvbmZpZyksCiAgICAgICAgICAgICAgICBkYXRhVHlwZSA9IGNvbmZpZy5kYXRhVHlwZSwKICAgICAgICAgICAgICAgIHVybCA9IGNvbmZpZy51cmwsCiAgICAgICAgICAgICAgICBkYXRhID0gY29uZmlnLmRhdGEgfHwge30sCiAgICAgICAgICAgICAgICBoZWFkZXJzID0gY29uZmlnLmhlYWRlcnMgfHwge30sCiAgICAgICAgICAgICAgICB1cmxvYmogPSBvLnV0aWwuY3JlYXRlVXJsT2JqZWN0KHVybCk7CiAgICAgICAgICAgIGlmKGNvbmZpZy50eXBlID09ICJqc29ucCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvLmFqYXguYWpheEpTT05QKG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFjb25maWcuY3Jvc3NEb21haW4pIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5jcm9zc0RvbWFpbiA9IHVybG9iai5ob3N0ICE9IHdpbmRvdy5sb2NhdGlvbi5ob3N0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjdXN0b21SZXF1ZXN0ZWRXaXRoSGVhZGVyID0gZmFsc2UsCiAgICAgICAgICAgICAgICBoZWFkZXJLZXk7CiAgICAgICAgICAgIGZvcihoZWFkZXJLZXkgaW4gaGVhZGVycykgewogICAgICAgICAgICAgICAgaWYgKGhlYWRlcktleS50b0xvd2VyQ2FzZSgpID09PSAneC1yZXF1ZXN0ZWQtd2l0aCcpIHsKICAgICAgICAgICAgICAgICAgICBjdXN0b21SZXF1ZXN0ZWRXaXRoSGVhZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZihjdXN0b21SZXF1ZXN0ZWRXaXRoSGVhZGVyID09PSBmYWxzZSB8fCAhY29uZmlnLmNyb3NzRG9tYWluKSB7CiAgICAgICAgICAgICAgICBoZWFkZXJzWydYLVJlcXVlc3RlZC1XaXRoJ10gPSAnWE1MSHR0cFJlcXVlc3QnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRhdGEgPSAgby51dGlsLmdldFBhcmFtZXRlclN0cmluZyhkYXRhIHx8IHt9KTsKICAgICAgICAgICAgaWYoY29uZmlnLnR5cGUgIT0gIlBPU1QiKSB7CiAgICAgICAgICAgICAgICBjb25maWcudXJsID0gby51dGlsLnVybEFwcGVuZCh1cmwsIGRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtaW1lID0gdGhpcy5hY2NlcHRzW2RhdGFUeXBlXSwKICAgICAgICAgICAgICAgIGJhc2VIZWFkZXJzID0ge30sCiAgICAgICAgICAgICAgICB4aHIgPSB0aGlzLnhocigpLCBhYm9ydFRpbWVvdXQ7CiAgICAgICAgICAgIGlmKG1pbWUpIHsKICAgICAgICAgICAgICAgIGJhc2VIZWFkZXJzWydBY2NlcHQnXSA9IG1pbWU7CiAgICAgICAgICAgICAgICBpZihtaW1lLmluZGV4T2YoJywnKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgbWltZSA9IG1pbWUuc3BsaXQoJywnLCAyKVswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlKG1pbWUpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGVhZGVycyA9IG8uZXh0ZW5kKGJhc2VIZWFkZXJzLCBoZWFkZXJzIHx8IHt9KTsKICAgICAgICAgICAgeGhyLm9wZW4oCiAgICAgICAgICAgICAgICBjb25maWcudHlwZSwgY29uZmlnLnVybCwgY29uZmlnLmFzeW5jLCBjb25maWcudXNlciwgY29uZmlnLnBhc3N3b3JkCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGZvcih2YXIgaGVhZGVyIGluIGhlYWRlcnMpIHsKICAgICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGhlYWRlciwgaGVhZGVyc1toZWFkZXJdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKHhoci5yZWFkeVN0YXRlID09IDQpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoYWJvcnRUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aGF0LnJ1bkNhbGxiYWNrcygKICAgICAgICAgICAgICAgICAgICAgICAge3JlcXVlc3Q6IHhociwgY29uZmlnOiBjb25maWcsIHJlcXVlc3RVcmw6IGNvbmZpZy51cmx9CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYoY29uZmlnLmFzeW5jID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgeGhyLnNlbmQoZGF0YSA/IGRhdGEgOiBudWxsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgaWYoeGhyLnJlYWR5U3RhdGUgIT09IDApIHsgLy8gVzNDOiAwLVVOU0VOVAogICAgICAgICAgICAgICAgICAgICAgICB4aHIuc2VuZChkYXRhID8gZGF0YSA6IG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGNvbmZpZy50aW1lb3V0ID4gMCkgewogICAgICAgICAgICAgICAgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgICAgICAgICAgeGhyLmFib3J0KCkKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3I7CiAgICAgICAgICAgICAgICAgICAgaWYoY29uZmlnLmVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgby51dGlsLmJpbmQoY29uZmlnLmVycm9yLCBjb25maWcuc2NvcGUpIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5lcnJvcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoeGhyLCAidGltZW91dCIpOwogICAgICAgICAgICAgICAgfSwgY29uZmlnLnRpbWVvdXQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHhocjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgcnVuQ2FsbGJhY2tzCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBydW5DYWxsYmFja3M6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHJlcXVlc3QgPSBvcHRpb25zLnJlcXVlc3Q7CiAgICAgICAgICAgIHZhciBjb25maWcgPSBvcHRpb25zLmNvbmZpZzsKICAgICAgICAgICAgdmFyIGNvbXBsZXRlID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgby51dGlsLmJpbmQoY29uZmlnLmNvbXBsZXRlLCBjb25maWcuc2NvcGUpIDoKICAgICAgICAgICAgICAgIGNvbmZpZy5jb21wbGV0ZTsKICAgICAgICAgICAgdmFyIHN1Y2Nlc3M7CiAgICAgICAgICAgIGlmKGNvbmZpZy5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBzdWNjZXNzID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgICAgIG8udXRpbC5iaW5kKGNvbmZpZy5zdWNjZXNzLCBjb25maWcuc2NvcGUpIDoKICAgICAgICAgICAgICAgICAgICBjb25maWcuc3VjY2VzczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFpbHVyZTsKICAgICAgICAgICAgaWYoY29uZmlnLmVycm9yKSB7CiAgICAgICAgICAgICAgICBmYWlsdXJlID0gKGNvbmZpZy5zY29wZSkgPwogICAgICAgICAgICAgICAgICAgIG8udXRpbC5iaW5kKGNvbmZpZy5lcnJvciwgY29uZmlnLnNjb3BlKSA6CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLmVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBsZXRlKHJlcXVlc3QpOwogICAgICAgICAgICB2YXIgcmVzdWx0LCBlcnJvciA9IGZhbHNlLAogICAgICAgICAgICAgICAgZGF0YVR5cGUgPSBjb25maWcuZGF0YVR5cGU7CiAgICAgICAgICAgIGlmKChyZXF1ZXN0LnN0YXR1cyA+PSAyMDAgJiYgcmVxdWVzdC5zdGF0dXMgPCAzMDApIHx8IHJlcXVlc3Quc3RhdHVzID09IDMwNCB8fAogICAgICAgICAgICAgICAgKHJlcXVlc3Quc3RhdHVzID09IDAgJiYgby51dGlsLmNyZWF0ZVVybE9iamVjdChjb25maWcudXJsKS5wcm90b2NvbCA9PSAiZmlsZToiKSkgewogICAgICAgICAgICAgICAgZGF0YVR5cGUgPSBkYXRhVHlwZSB8fCB0aGlzLm1pbWVUb0RhdGFUeXBlKHJlcXVlc3QuZ2V0UmVzcG9uc2VIZWFkZXIoJ2NvbnRlbnQtdHlwZScpKTsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlcXVlc3QucmVzcG9uc2VUZXh0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBpZihkYXRhVHlwZSA9PSAnc2NyaXB0JykgICAgKDEsZXZhbCkocmVzdWx0KQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYoZGF0YVR5cGUgPT0gJ3htbCcpICByZXN1bHQgPSByZXF1ZXN0LnJlc3BvbnNlWE1MCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZihkYXRhVHlwZSA9PSAnanNvbicpIHJlc3VsdCA9IHRoaXMuQkxBTktfUkVHRVgudGVzdChyZXN1bHQpID8gbnVsbCA6IEpTT04ucGFyc2UocmVzdWx0KQogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyBlcnJvciA9IGUgfQogICAgICAgICAgICAgICAgb3B0aW9ucy5yZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgICAgICBpZihzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyhyZXF1ZXN0LCByZXN1bHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYoZmFpbHVyZSkgewogICAgICAgICAgICAgICAgICAgIGZhaWx1cmUocmVxdWVzdCwgImVycm9yIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFqYXguZ2V0CiAgICAgICAgICogQGRlc2Mg5Y+R5p2hZ2V06K+35rGCCiAgICAgICAgICogQHBhcmFtIGNvbmZpZyB7T2JqZWN0fQogICAgICAgICAqIEBwYXJhbSBjb25maWcudXJsIHtTdHJpbmd9IOivt+axguWcsOWdgAogICAgICAgICAqIEBwYXJhbSBjb25maWcuYXN5bmMge0Jvb2xlYW59IOWQjOW8guatpQogICAgICAgICAqIEBwYXJhbSBjb25maWcuY29tcGxldGUge0Z1bmN0aW9ufSDor7fmsYLnu5PmnZ/nmoRjYWxsYmFjawogICAgICAgICAqIEBwYXJhbSBjb25maWcuc3VjY2VzcyB7RnVuY3Rpb259IOivt+axguaIkOWKn+eahGNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIGNvbmZpZy5lcnJvciB7RnVuY3Rpb259IOivt+axguWksei0peeahGNhbGxiYWNrCiAgICAgICAgICogQHBhcmFtIGNvbmZpZy50aW1lb3V0IHtOdW1iZXJ9IOi2heaXtuaXtumXtAogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICAiZ2V0IjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIGNvbmZpZyA9IG8uZXh0ZW5kKGNvbmZpZywge3R5cGU6ICJHRVQifSk7CiAgICAgICAgICAgIHJldHVybiBvLmFqYXgucmVxdWVzdChjb25maWcpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYWpheC5wb3N0CiAgICAgICAgICogQGRlc2Mg5Y+R5p2hcG9zdOivt+axggogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMZ2V0CiAgICAgICAgICogQHBhcmFtIGNvbmZpZy5kYXRhIHtPYmplY3R9IOaVsOaNrgogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICBwb3N0OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAgICAgY29uZmlnID0gby5leHRlbmQoY29uZmlnLCB7dHlwZTogIlBPU1QifSk7CiAgICAgICAgICAgIC8vIHNldCBjb250ZW50IHR5cGUgdG8gYXBwbGljYXRpb24veG1sIGlmIGl0IGlzbid0IGFscmVhZHkgc2V0CiAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzID0gY29uZmlnLmhlYWRlcnMgPyBjb25maWcuaGVhZGVycyA6IHt9OwogICAgICAgICAgICBpZighKCJDT05URU5ULVRZUEUiIGluIG8udXRpbC51cHBlckNhc2VPYmplY3QoY29uZmlnLmhlYWRlcnMpKSkgewogICAgICAgICAgICAgICAgY29uZmlnLmhlYWRlcnNbIkNvbnRlbnQtVHlwZSJdID0gImFwcGxpY2F0aW9uL3htbCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG8uYWpheC5yZXF1ZXN0KGNvbmZpZyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hamF4LnB1dAogICAgICAgICAqIEBkZXNjIOWPkeadoXB1dOivt+axggogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMcG9zdAogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICBwdXQ6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcgPSBvLmV4dGVuZChjb25maWcsIHt0eXBlOiAiUFVUIn0pOwogICAgICAgICAgICAvLyBzZXQgY29udGVudCB0eXBlIHRvIGFwcGxpY2F0aW9uL3htbCBpZiBpdCBpc24ndCBhbHJlYWR5IHNldAogICAgICAgICAgICBjb25maWcuaGVhZGVycyA9IGNvbmZpZy5oZWFkZXJzID8gY29uZmlnLmhlYWRlcnMgOiB7fTsKICAgICAgICAgICAgaWYoISgiQ09OVEVOVC1UWVBFIiBpbiBvLnV0aWwudXBwZXJDYXNlT2JqZWN0KGNvbmZpZy5oZWFkZXJzKSkpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5oZWFkZXJzWyJDb250ZW50LVR5cGUiXSA9ICJhcHBsaWNhdGlvbi94bWwiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvLmFqYXgucmVxdWVzdChjb25maWcpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYWpheC5kZWxldGUKICAgICAgICAgKiBAZGVzYyDlj5HmnaFkZWxldGXor7fmsYIKICAgICAgICAgKiBAcGFyYW0gY29uZmlnIHtPYmplY3R9IOWQjGdldAogICAgICAgICAqIEByZXR1cm4ge1hNTEh0dHBSZXF1ZXN0fSBSZXF1ZXN0IG9iamVjdC4KICAgICAgICAgKi8KICAgICAgICAiZGVsZXRlIjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIGNvbmZpZyA9IG8uZXh0ZW5kKGNvbmZpZywge3R5cGU6ICJERUxFVEUifSk7CiAgICAgICAgICAgIHJldHVybiBvLmFqYXgucmVxdWVzdChjb25maWcpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYWpheC5oZWFkCiAgICAgICAgICogQGRlc2Mg5Y+R5p2haGVhZOivt+axggogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMZ2V0CiAgICAgICAgICogQHJldHVybiB7WE1MSHR0cFJlcXVlc3R9IFJlcXVlc3Qgb2JqZWN0LgogICAgICAgICAqLwogICAgICAgIGhlYWQ6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcgPSBvLmV4dGVuZChjb25maWcsIHt0eXBlOiAiSEVBRCJ9KTsKICAgICAgICAgICAgcmV0dXJuIG8uYWpheC5yZXF1ZXN0KGNvbmZpZyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hamF4Lm9wdGlvbnMKICAgICAgICAgKiBAZGVzYyDlj5HmnaFvcHRpb25z6K+35rGCLgogICAgICAgICAqIEBwYXJhbSBjb25maWcge09iamVjdH0g5ZCMZ2V0CiAgICAgICAgICogQHJldHVybiB7WE1MSHR0cFJlcXVlc3R9IFJlcXVlc3Qgb2JqZWN0LgogICAgICAgICAqLwogICAgICAgIG9wdGlvbnM6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBjb25maWcgPSBvLmV4dGVuZChjb25maWcsIHt0eXBlOiAiT1BUSU9OUyJ9KTsKICAgICAgICAgICAgcmV0dXJuIG8uYWpheC5yZXF1ZXN0KGNvbmZpZyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIF9jcmVhdGVTY3JpcHRUYWcKICAgICAgICAgKi8KICAgICAgICBfY3JlYXRlU2NyaXB0VGFnOiBmdW5jdGlvbihzY3IsIHVybCwgY2hhcnNldCkgewogICAgICAgICAgICBzY3Iuc2V0QXR0cmlidXRlKCd0eXBlJywgJ3RleHQvamF2YXNjcmlwdCcpOwogICAgICAgICAgICBjaGFyc2V0ICYmIHNjci5zZXRBdHRyaWJ1dGUoJ2NoYXJzZXQnLCBjaGFyc2V0KTsKICAgICAgICAgICAgc2NyLnNldEF0dHJpYnV0ZSgnc3JjJywgdXJsKTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXS5hcHBlbmRDaGlsZChzY3IpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQE1ldGhvZCBfcmVtb3ZlU2NyaXB0VGFnCiAgICAgICAgICovCiAgICAgICAgX3JlbW92ZVNjcmlwdFRhZzogZnVuY3Rpb24oc2NyKSB7CiAgICAgICAgICAgIGlmIChzY3IuY2xlYXJBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICBzY3IuY2xlYXJBdHRyaWJ1dGVzKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBhdHRyIGluIHNjcikgewogICAgICAgICAgICAgICAgICAgIGlmIChzY3IuaGFzT3duUHJvcGVydHkoYXR0cikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHNjclthdHRyXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoc2NyICYmIHNjci5wYXJlbnROb2RlKXsKICAgICAgICAgICAgICAgIHNjci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2NyID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIHNjcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFqYXguYWpheEpTT05QCiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0KICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy51cmwge1N0cmluZ30g6K+35rGC5Zyw5Z2ACiAgICAgICAgICogQHBhcmFtIG9wdGlvbnMuY29tcGxldGUge0Z1bmN0aW9ufSDmiJDlip/lm57osIMKICAgICAgICAgKiBAcGFyYW0gb3B0aW9ucy5lcnJvciB7RnVuY3Rpb259IOWksei0peWbnuiwgwogICAgICAgICAqIEBwYXJhbSBvcHRpb25zLnRpbWVvdXQge051bWJlcn0g6LaF5pe25pe26ZW/CiAgICAgICAgICovCiAgICAgICAgYWpheEpTT05QOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgIGRlZmF1bHRDb25maWcgPSB0aGlzLkRFRkFVTFRfQ09ORklHLAogICAgICAgICAgICAgICAgcHJlZml4ID0gImpzb25wIiwKICAgICAgICAgICAgICAgIGNhbGxiYWNrTmFtZSwKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBvLnV0aWwuYXBwbHlEZWZhdWx0cyhvcHRpb25zLCBkZWZhdWx0Q29uZmlnKSwKICAgICAgICAgICAgICAgIGNoYXJzZXQgPSBvcHRpb25zWydjaGFyc2V0J10sCiAgICAgICAgICAgICAgICBkYXRhID0gb3B0aW9uc1siZGF0YSJdIHx8IHt9LAogICAgICAgICAgICAgICAgdGltZU91dCA9IG9wdGlvbnNbJ3RpbWVvdXQnXSB8fCAwLAogICAgICAgICAgICAgICAgdGltZXIsCiAgICAgICAgICAgICAgICB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgIHVybCA9IG9wdGlvbnNbInVybCJdLAogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBvcHRpb25zWyJzdWNjZXNzIl0gfHwgb3B0aW9uc1siY29tcGxldGUiXSwKICAgICAgICAgICAgICAgIGpzb25wTmFtZSA9IG9wdGlvbnNbImpzb25wIl0gfHwgImNhbGxiYWNrIiwKICAgICAgICAgICAgICAgIGVycm9yID0gb3B0aW9uc1siZXJyb3IiXSB8fCBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgIGlmKG8udXRpbC5pc1N0cmluZyhjYWxsYmFjaykpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrTmFtZSA9IGNhbGxiYWNrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2FsbGJhY2tOYW1lID0gcHJlZml4ICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjE0NzQ4MzY0OCkudG9TdHJpbmcoMzYpOwogICAgICAgICAgICAgICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBnZXRDYWxsQmFjaygwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aW1lT3V0ID4gMCl7CiAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZ2V0Q2FsbEJhY2soMSksIHRpbWVPdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNjcmlwdC5vbmVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aGF0Ll9yZW1vdmVTY3JpcHRUYWcoc2NyaXB0KTsKICAgICAgICAgICAgICAgIGlmKGNhbGxiYWNrTmFtZSBpbiB3aW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dbY2FsbGJhY2tOYW1lXSA9IGZ1bmN0aW9uKCl7fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVycm9yKCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVybCA9IG8udXRpbC51cmxBcHBlbmQoby51dGlsLnVybEFwcGVuZCh1cmwsCiAgICAgICAgICAgICAgICBvLnV0aWwuZ2V0UGFyYW1ldGVyU3RyaW5nKGRhdGEgfHwge30pKSwganNvbnBOYW1lICsgIj0iICsgY2FsbGJhY2tOYW1lKTsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlU2NyaXB0VGFnKHNjcmlwdCwgdXJsLCBjaGFyc2V0KTsKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q2FsbEJhY2sob25UaW1lT3V0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIG9uVGltZU91dCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkod2luZG93LCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvd1tjYWxsYmFja05hbWVdID0gby51dGlsLmVtcHR5OwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4Y2VwdGlvbikge30KICAgICAgICAgICAgICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5fcmVtb3ZlU2NyaXB0VGFnKHNjcmlwdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvcHRpb25zWyJ4aHIiXTsKICAgICAgICB9CiAgICB9KTsKfSkob2N0b3B1cyk7Ci8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICog5Yqo55S76YOo5YiGCiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLlR3ZWVuCiAgICAgKiBAZGVzYyDliqjnlLvnsbvvvIzlj6/ku6XpgJrov4fmlLnlj5jlsZ7mgKfjgIHotbflp4vlgLzjgIHnu5PmnZ/lgLznrYnphY3nva7orqnmjIflrproioLngrnlrozmiJDliqjmgIHov4fmuKEKICAgICAqIOazqOaEj++8mueUseS6juaDheWGtei/h+S6juWkjeadgiDlh6HmmK/mlLnlj5jlsZ7mgKfmmK90cmFuc2Zvcm3lsZ7mgKfmiJbljIXlkKt0cmFuc2Zvcm3lsZ7mgKfnmoTliqjnlLsg5Y+q6IO95oyJ54WnY3NzM+eahOW9ouW8j+i/m+ihjCDpu5jorqTliqjnlLvnsbvlnovmmK9lYXNlLW91dAogICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fSDmjIflrprlrozmiJDliqjnlLvnmoToioLngrkKICAgICAqIEBwYXJhbSBwcm8ge1N0cmluZyB8IEFycmF5fSDlvoXmlLnlj5jnmoTlsZ7mgKcg5Y+v5Li65aSa5YC8CiAgICAgKiBAcGFyYW0gc3RhcnR2IHtTdHJpbmcgfCBOdW1iZXIgfCBBcnJheX0g6LW35aeL5YC8IOWmguS4uuaVsOe7hCDlv4XpobvkuI7mlLnlj5jlsZ7mgKfkuIDkuIDlr7nlupQg5ZCm5YiZ5Lya5oqb6ZSZCiAgICAgKiBAcGFyYW0gZW5kdiB7U3RyaW5nIHwgTnVtYmVyIHwgQXJyYXl9IOe7k+adn+WAvCDlhbfkvZPopoHmsYLlkIzotbflp4vlgLwKICAgICAqIEBwYXJhbSBkdXJhdGlvbiB7TnVtYmVyfSDliqjljJbov4fmuKHnmoTml7bpl7Qg5Y2V5L2N5Li656eSL3MKICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g5Yqo55S757uT5p2f55qE5Zue6LCD5Ye95pWwCiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fSDlhbbku5bphY3nva7pobkg5Y+v5Li656m6IOm7mOiupOS4umpz5Yqo55S7IOWKqOeUu+exu+Wei+S4uiJvY3RvcHVzLmVhc2luZy4iCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5lYXNlIHtTdHJpbmcgfCBPYmplY3R9IOWKqOeUu+exuyDlpoLmnpzkuLrlrZfnrKbkuLIg5YiZ6YeH55SoY3NzM+eahHRyYW5zaXRpb27liqjnlLsg5ZCm5YiZ6ZyA6KaB5Lyg5YWlIm9jdG9wdXMuZWFzaW5nLlhYWCLnmoTliqjnlLvlr7nosaEKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgbmV3dHdlZW4gPSBuZXcgVHdlZW4oZWwsIFsid2lkdGgiLCAid2Via2l0VHJhbnNmb3JtIl0sIFs2NCwgInRyYW5zbGF0ZTNkKDAsIDAsIDApIl0sCiAgICAgKiAgWzEyOCwgInRyYW5zbGF0ZTNkKDMwcHgsIDAsIDApIl0sIC40LCBmdW5jdGlvbigpIHsKICAgICAqICAgICBjb25zb2xlLmxvZyhBbmltYXRpb24gZmluaXNoZWQhKTsKICAgICAqIH0sIHsKICAgICAqICAgICBlYXNlOiAiZWFzZS1vdXQiIHwgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VPdXQKICAgICAqIH0pOwogICAgICogQHRocm93CiAgICAgKiBAcmV0dXJuIHtvY3RvcHVzLlR3ZWVufQogICAgICovCiAgICBvLlR3ZWVuID0gby5kZWZpbmUoewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwcm9wZXJ0eU5hbWUKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHByb3BlcnR5TmFtZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc3RhcnRWYWx1ZQogICAgICAgICAqIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgc3RhcnRWYWx1ZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZW5kVmFsdWUKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGVuZFZhbHVlOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBkdXJhdGlvbgogICAgICAgICAqIHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgZHVyYXRpb246IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGZ1bmMKICAgICAgICAgKiB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgZnVuYzogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZWFzZQogICAgICAgICAqIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgZWFzZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbmVlZFBhcmFtcwogICAgICAgICAqIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBuZWVkUGFyYW1zOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwYXJhbXNEaWNzCiAgICAgICAgICoge0FycmF5fQogICAgICAgICAqLwogICAgICAgIHBhcmFtc0RpY3M6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHJlcXVlc3RBbmltYXRpb24KICAgICAgICAgKiB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIHJlcXVlc3RBbmltYXRpb246IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNvbG9yTGlzdAogICAgICAgICAqIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBjb2xvckxpc3Q6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHN0b3BSZXF1ZXN0CiAgICAgICAgICoge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgc3RvcFJlcXVlc3Q6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHZlY3RvcgogICAgICAgICAqIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgdmVjdG9yOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwcmVmaXgKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHByZWZpeDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnRQcmVmaXgKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGV2ZW50UHJlZml4OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc09mZkNzcwogICAgICAgICAqIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzT2ZmQ3NzOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZW5kRXZlbnQKICAgICAgICAgKiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGVuZEV2ZW50OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1RyYW5zZm9ybQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzVHJhbnNmb3JtOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnRUaW1lcgogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgZXZlbnRUaW1lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGVsYXkKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGRlbGF5OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvciBvY3RvcHVzLlR3ZWVuCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWwsIHBybywgc3RhcnR2LCBlbmR2LCBkdXJhdGlvbiwgZnVuYywgb3B0aW9ucykgewogICAgICAgICAgICBpZighby51dGlsLmlzTm9kZShlbCkpICAgIHRocm93IG5ldyBFcnJvcigicmVxdWlyZSBhIG5vZGUhIik7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLmVsID0gZWw7CiAgICAgICAgICAgIHRoaXMucHJvcGVydHlOYW1lID0gcHJvOwogICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSBzdGFydHY7CiAgICAgICAgICAgIHRoaXMuZW5kVmFsdWUgPSBlbmR2OwogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMuZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB0aGlzLm5lZWRQYXJhbXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jb2xvckxpc3QgPSBbXTsKICAgICAgICAgICAgdGhpcy5wYXJhbXNEaWNzID0gWyJ3aWR0aCIsICJoZWlnaHQiLCAibGVmdCIsICJ0b3AiLCAicmlnaHQiLCAiYm90dG9tIiwgInBhZGRpbmciLAogICAgICAgICAgICAgICAgInBhZGRpbmctbGVmdCIsICJwYWRkaW5nLXRvcCIsICJwYWRkaW5nLWJvdHRvbSIsICJwYWRkaW5nLXJpZ2h0IiwgIm1hcmdpbiIsCiAgICAgICAgICAgICAgICAibWFyZ2luLWxlZnQiLCAibWFyZ2luLXRvcCIsICJtYXJnaW4tYm90dG9tIiwgIm1hcmdpbi1yaWdodCIsICJmb250LXNpemUiLAogICAgICAgICAgICAgICAgImJhY2tncm91bmQtcG9zaXRpb24iLCAibGluZS1oZWlnaHQiLCAiYm9yZGVyLXdpZHRoIiwgImJvcmRlci1sZWZ0LXdpZHRoIiwKICAgICAgICAgICAgICAgICJib3JkZXItdG9wLXdpZHRoIiwgImJvcmRlci1yaWdodC13aWR0aCIsICJib3JkZXItYm90dG9tLXdpZHRoIl07CiAgICAgICAgICAgIHZhciBsZWdhbGl0eSA9IHRoaXMuY2hlY2soKTsKICAgICAgICAgICAgdGhpcy5lYXNlID0gdGhpcy5lYXNlIHx8ICh0aGlzLmlzVHJhbnNmb3JtID8gImVhc2Utb3V0IiA6IG8uZWFzaW5nLmxpbmVhci5lYXNlT3V0KTsKICAgICAgICAgICAgdGhpcy5kZWxheSA9IHRoaXMuZGVsYXkgfHwgMDsKICAgICAgICAgICAgaWYoIWxlZ2FsaXR5KSB0aHJvdyBuZXcgRXJyb3IoIklsbGVnYWwgYXJndW1lbnRzISIpOwogICAgICAgICAgICBpZihvLnV0aWwuaXNPYmplY3QodGhpcy5lYXNlKSAmJiAhdGhpcy5pc1RyYW5zZm9ybSkgewogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uID0gby51dGlsLnJlcXVlc3RBbmltYXRpb247CiAgICAgICAgICAgICAgICBpZih0aGlzLmRlbGF5ID4gMCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5leGVjdXRlV2l0aEpzKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcy5kZWxheSAqIDEwMDApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGVXaXRoSnMoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMudmVjdG9yID0geyIiIDogIiIsIFdlYmtpdDogIndlYmtpdCIsIE1vejogIiIsIE86ICJvIiwgbXM6ICJNUyJ9OwogICAgICAgICAgICAgICAgZm9yKHZhciBrIGluIHRoaXMudmVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZWwuc3R5bGVbayArICJUcmFuc2l0aW9uUHJvcGVydHkiXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJlZml4ID0gJy0nICsgay50b0xvd2VyQ2FzZSgpICsgJy0nCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRQcmVmaXggPSB0aGlzLnZlY3RvcltrXQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmlzT2ZmQ3NzID0gKHRoaXMuZXZlbnRQcmVmaXggPT0gbnVsbCAmJiB0aGlzLmVsLnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9PSB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgdGhpcy5lbmRFdmVudCA9IHRoaXMuZXZlbnRQcmVmaXggPyB0aGlzLmV2ZW50UHJlZml4ICsgIlRyYW5zaXRpb25FbmQiIDogInRyYW5zaXRpb25FbmQiOwogICAgICAgICAgICAgICAgdGhpcy5leGVjdXRlV2l0aENzcygpOwogICAgICAgICAgICB9CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjaGVjawogICAgICAgICAqIEBkZXNjIOajgOafpeWPguaVsOaYr+WQpm9rCiAgICAgICAgICovCiAgICAgICAgY2hlY2s6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcXVldWUgPSBvLnV0aWwuaXNBcnJheSh0aGlzLnByb3BlcnR5TmFtZSkgJiYKICAgICAgICAgICAgICAgICAgICBvLnV0aWwuaXNBcnJheSh0aGlzLnN0YXJ0VmFsdWUpICYmIG8udXRpbC5pc0FycmF5KHRoaXMuZW5kVmFsdWUpLAogICAgICAgICAgICAgICAgcGFzcyA9IGZhbHNlLAogICAgICAgICAgICAgICAgX3Bhc3M7CiAgICAgICAgICAgIGlmKCFxdWV1ZSl7CiAgICAgICAgICAgICAgICB0aGlzLnByb3BlcnR5TmFtZSA9IFt0aGlzLnByb3BlcnR5TmFtZV07CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSBbdGhpcy5zdGFydFZhbHVlXTsKICAgICAgICAgICAgICAgIHRoaXMuZW5kVmFsdWUgPSBbdGhpcy5lbmRWYWx1ZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmFtc01hdGNoID0gKHRoaXMucHJvcGVydHlOYW1lLmxlbmd0aCA9PSB0aGlzLnN0YXJ0VmFsdWUubGVuZ3RoKSAmJgogICAgICAgICAgICAgICAgICAgICh0aGlzLnN0YXJ0VmFsdWUubGVuZ3RoID09IHRoaXMuZW5kVmFsdWUubGVuZ3RoKTsKICAgICAgICAgICAgaWYocGFyYW1zTWF0Y2gpIHsKICAgICAgICAgICAgICAgIHZhciB1bk9rID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgbGVuID0gdGhpcy5wcm9wZXJ0eU5hbWUubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGkgPSBsZW47CiAgICAgICAgICAgICAgICBmb3IoOyBpLS07ICkgewogICAgICAgICAgICAgICAgICAgIF9wYXNzID0gdGhpcy5jaGVja1ZhbHVlKHRoaXMucHJvcGVydHlOYW1lW2ldLCB0aGlzLnN0YXJ0VmFsdWVbaV0sIHRoaXMuZW5kVmFsdWVbaV0pOwogICAgICAgICAgICAgICAgICAgIGlmKCFfcGFzcykgewogICAgICAgICAgICAgICAgICAgICAgICB1bk9rID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZWVkUGFyYW1zW2ldID0gdGhpcy5wYXJhbXNEaWNzLmluZGV4T2YodGhpcy5wcm9wZXJ0eU5hbWVbaV0pICE9IC0xOwogICAgICAgICAgICAgICAgICAgIHZhciBpc0NvbG9yID0gbmV3IFJlZ0V4cCgiL2NvbG9yfGJhY2tncm91bmQtY29sb3J8Ym9yZGVyLWNvbG9yL2kiKS50ZXN0KHRoaXMucHJvcGVydHlOYW1lW2ldKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbG9yTGlzdFtpXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgaXNDb2xvcjogaXNDb2xvciwKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRWYWx1ZTogaXNDb2xvciA/IHRoaXMuZ2V0Q29sb3IodGhpcy5zdGFydFZhbHVlW2ldKSA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgIGVuZFZhbHVlOiBpc0NvbG9yID8gdGhpcy5nZXRDb2xvcih0aGlzLmVuZFZhbHVlW2ldKSA6IG51bGwKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFzcyA9ICF1bk9rICYmICFpc05hTih0aGlzLmR1cmF0aW9uKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhc3MgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFzczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgY2hlY2tWYWx1ZQogICAgICAgICAqIEBkZXNjIOmqjOivgeWAvOaYr+WQpuWQiOazlQogICAgICAgICAqLwogICAgICAgIGNoZWNrVmFsdWU6IGZ1bmN0aW9uKHByb3BlcnR5TmFtZSwgc3RhcnRWYWx1ZSwgZW5kVmFsdWUpewogICAgICAgICAgICB2YXIgcGFzcyA9IGZhbHNlOwogICAgICAgICAgICBpZigvdHJhbnNmb3JtL2kudGVzdChwcm9wZXJ0eU5hbWUpIHx8IC8td2Via2l0LS9pLnRlc3QocHJvcGVydHlOYW1lKSkgewogICAgICAgICAgICAgICAgdGhpcy5pc1RyYW5zZm9ybSA9IHRydWU7CiAgICAgICAgICAgICAgICBwYXNzID0gISFzdGFydFZhbHVlICYmIG8udXRpbC5pc1N0cmluZyhzdGFydFZhbHVlKSAmJiAhIWVuZFZhbHVlICYmIG8udXRpbC5pc1N0cmluZyhlbmRWYWx1ZSkKICAgICAgICAgICAgfSBlbHNlIGlmKHByb3BlcnR5TmFtZS5pbmRleE9mKCdjb2xvcicpICE9IC0xKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVnID0gLyheXHMqKXwoXHMqJCkvZzsKICAgICAgICAgICAgICAgIHBhc3MgPSAhIXN0YXJ0VmFsdWUgJiYgc3RhcnRWYWx1ZS5yZXBsYWNlKHJlZywgJycpICE9ICcnICYmICEhIGVuZFZhbHVlICYmIGVuZFZhbHVlLnJlcGxhY2UocmVnLCAnJykgIT0gJycKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhc3MgPSAhaXNOYU4oc3RhcnRWYWx1ZSkgJiYgIWlzTmFOKGVuZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFzczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0Q29sb3IKICAgICAgICAgKi8KICAgICAgICBnZXRDb2xvcjogZnVuY3Rpb24oc3RyKSB7CiAgICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKC8oXlxzKil8KFxzKiQpL2csICcnKTsKICAgICAgICAgICAgdmFyIHJnYlJlZyA9IC9eXHMqcmdiXHMqXChccypcZHsxLDN9XHMqXCxccypcZHsxLDN9XHMqXCxccypcZHsxLDN9XHMqXClccyokL2k7CiAgICAgICAgICAgIHZhciBzaXhSZWdBID0gL15ccypcI1thLXpBLVowLTldezN9XHMqJC87CiAgICAgICAgICAgIHZhciBzaXhSZWdCID0gL15ccypcI1thLXpBLVowLTldezZ9XHMqJC87CiAgICAgICAgICAgIHZhciBhcnIgPSBbXTsKICAgICAgICAgICAgaWYocmdiUmVnLnRlc3Qoc3RyKSl7IC8vIOS7pVJHQuW9ouW8j+aMh+WumueahOminOiJsgogICAgICAgICAgICAgICAgdmFyIG5TdHIgPSBzdHIuc3BsaXQoJygnKVsxXS5zcGxpdCgnKScpWzBdLnNwbGl0KCcsJyk7CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwIDsgaSA8IG5TdHIubGVuZ3RoIDsgaSArKyl7CiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goblN0cltpXSAvIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGFycjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihzaXhSZWdCLnRlc3Qoc3RyKSkgeyAvLyDku6UxNui/m+WItuaMh+WumuminOiJsiAoNuS9jSkKICAgICAgICAgICAgICAgIHZhciBtID0gc3RyLnJlcGxhY2UoJyMnLCAnJykubWF0Y2goLyhcd3xcZCl7Mn0vZyk7CgogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCA7IGkgPCBtLmxlbmd0aDsgaSArKyl7CiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goTnVtYmVyKCcweCcgKyBtW2ldKS50b1N0cmluZygxMCkgLyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoc2l4UmVnQS50ZXN0KHN0cikpeyAvLyDku6UxNui/m+WItuaMh+WumuminOiJsigz5L2NKQogICAgICAgICAgICAgICAgdmFyIGNBcnIgPSBzdHIucmVwbGFjZSgnIycsICcnKS5zcGxpdCgnJyk7CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwIDsgaSA8IGNBcnIubGVuZ3RoIDsgaSArKyl7CiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goTnVtYmVyKCcweCcgKyAoY0FycltpXSArIGNBcnJbaV0pKS50b1N0cmluZygxMCkgLyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGV4ZWN1dGVXaXRoSnMKICAgICAgICAgKiDmiafooYwKICAgICAgICAgKi8KICAgICAgICBleGVjdXRlV2l0aEpzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5zdG9wUmVxdWVzdCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBjdXJUaW1lID0gMDsKICAgICAgICAgICAgdmFyIGFuaW1hdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LmVsIHx8IHRoYXQuc3RvcFJlcXVlc3QpewogICAgICAgICAgICAgICAgICAgIHRoYXQuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoYXQuZ2V0U2V0VmFsdWUoY3VyVGltZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgaWYoY3VyVGltZSA+PSB0aGF0LmR1cmF0aW9uICogMTAwMCl7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5nZXRTZXRWYWx1ZShudWxsLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgdGhhdC5mdW5jICYmIHRoYXQuZnVuYygpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuZWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1clRpbWUgKz0gMTY7CiAgICAgICAgICAgICAgICB0aGF0LnJlcXVlc3RBbmltYXRpb24oYW5pbWF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uKGFuaW1hdGUsIHRoaXMuZWwpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBleGVjdXRlV2l0aENzcwogICAgICAgICAqLwogICAgICAgIGV4ZWN1dGVXaXRoQ3NzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy5pc09mZkNzcykgdGhpcy5kdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHZhciBwcm9hcnIgPSB0aGlzLnByb3BlcnR5TmFtZSwKICAgICAgICAgICAgICAgIGxlbiA9IHByb2Fyci5sZW5ndGgsCiAgICAgICAgICAgICAgICB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25BcnIgPSBbXSwKICAgICAgICAgICAgICAgIF9wcmVmaXggPSB0aGlzLnByZWZpeCArICJ0cmFuc2l0aW9uIjsKICAgICAgICAgICAgdGhpcy5lbC5zdHlsZVtfcHJlZml4XSA9ICIiOwogICAgICAgICAgICBvLnV0aWwuZWFjaChwcm9hcnIsIGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CiAgICAgICAgICAgICAgICB0aGF0LmVsLnN0eWxlW2l0ZW1dID0gdGhhdC5nZXRWYWx1ZSh0aGF0LnN0YXJ0VmFsdWVbaW5kZXhdLCBpbmRleCk7CiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uQXJyLnB1c2goaXRlbSArICIgIiArIHRoYXQuZHVyYXRpb24gKyAicyAiICsgdGhhdC5lYXNlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIG8uZXZlbnQub24odGhpcy5lbCwgdGhpcy5lbmRFdmVudCwgby51dGlsLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcy5vbkVuZEV2ZW50Q29tcGxldGVkLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoYXQuZWwuc3R5bGVbX3ByZWZpeF0gPSB0cmFuc2l0aW9uQXJyLmpvaW4oIiwgIik7CiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGF0OwogICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHogPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcig7IHogPCBsZW47IHorKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY3VyVmFsdWUgPSBfdGhpcy5lbmRWYWx1ZVt6XTsKICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZWwuc3R5bGVbcHJvYXJyW3pdXSA9IF90aGlzLmdldFZhbHVlKGN1clZhbHVlLCB6KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2xlYXJFdmVudFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuZXZlbnRUaW1lciA9IHNldFRpbWVvdXQoby51dGlsLmJpbmQoX3RoaXMub25GaW5pc2gsIF90aGlzKSwgX3RoaXMuZHVyYXRpb24gKiAxMDAwKTsKCiAgICAgICAgICAgICAgICB9LCB0aGF0LmRlbGF5ICogMTAwMCk7CiAgICAgICAgICAgIH0sIDApOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjbGVhckV2ZW50VGltZXIKICAgICAgICAgKi8KICAgICAgICBjbGVhckV2ZW50VGltZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmV2ZW50VGltZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy5ldmVudFRpbWVyKTsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRUaW1lciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25GaW5pc2gKICAgICAgICAgKi8KICAgICAgICBvbkZpbmlzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMuZWwpIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcEV2ZW50T2JzZXJ2ZXIodGhpcy5lbCwgdGhpcy5lbmRFdmVudCk7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlW3RoaXMucHJlZml4ICsgInRyYW5zaXRpb24iXSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZnVuYyAmJiB0aGlzLmZ1bmMoKTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uRW5kRXZlbnRDb21wbGV0ZWQKICAgICAgICAgKi8KICAgICAgICBvbkVuZEV2ZW50Q29tcGxldGVkOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGlmKGUudGFyZ2V0ICE9PSBlLmN1cnJlbnRUYXJnZXQpICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy5jbGVhckV2ZW50VGltZXIoKTsKICAgICAgICAgICAgdGhpcy5vbkZpbmlzaCgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5Ud2Vlbi5zdG9wCiAgICAgICAgICogQGRlc2Mg5YGc5o6J5Yqo55S7IOW5tuino+iEseiHquaIkQogICAgICAgICAqLwogICAgICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmVuZEV2ZW50ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcFJlcXVlc3QgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5mdW5jICYmIHRoaXMuZnVuYygpOwogICAgICAgICAgICAgICAgaWYodGhpcy5lbCkgewogICAgICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcEV2ZW50T2JzZXJ2ZXIodGhpcy5lbCwgdGhpcy5lbmRFdmVudCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbC5zdHlsZVt0aGlzLnByZWZpeCArICJ0cmFuc2l0aW9uIl0gPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuVHdlZW4uZGVzdHJveQogICAgICAgICAqIEBkZXNjIOeci+WQjeWtl+WwseefpemBk+W5suWYm+eahAogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmVsID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0U2V0VmFsdWUKICAgICAgICAgKiBAZGVzYyDlj5blh7rlvZPliY3nmoTlsZ7mgKflgLwKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIGN1clRpbWUgIC0gICB7TnVtYmVyfQogICAgICAgICAqIGlzRW5kICAgIC0gICB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBnZXRTZXRWYWx1ZTogZnVuY3Rpb24oY3VyVGltZSwgaXNFbmQpIHsKICAgICAgICAgICAgdmFyIHZhbHVlSW5mbyA9IFtdLAogICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICBpTGVuID0gdGhpcy5wcm9wZXJ0eU5hbWUubGVuZ3RoOwogICAgICAgICAgICBmb3IoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VyVmFsdWU7CiAgICAgICAgICAgICAgICBpZih0aGlzLmNvbG9yTGlzdFtpXS5pc0NvbG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0UlIgPSB0aGlzLmNvbG9yTGlzdFtpXS5zdGFydFZhbHVlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBzdGFydEdHID0gdGhpcy5jb2xvckxpc3RbaV0uc3RhcnRWYWx1ZVsxXSwKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRCQiA9IHRoaXMuY29sb3JMaXN0W2ldLnN0YXJ0VmFsdWVbMl0sCgogICAgICAgICAgICAgICAgICAgICAgICBlbmRSUiA9IHRoaXMuY29sb3JMaXN0W2ldLmVuZFZhbHVlWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBlbmRHRyA9IHRoaXMuY29sb3JMaXN0W2ldLmVuZFZhbHVlWzFdLAogICAgICAgICAgICAgICAgICAgICAgICBlbmRCQiA9IHRoaXMuY29sb3JMaXN0W2ldLmVuZFZhbHVlWzJdOwoKICAgICAgICAgICAgICAgICAgICB2YXIgcnIsIGdnLCBiYjsKICAgICAgICAgICAgICAgICAgICBpZihpc0VuZCkgewogICAgICAgICAgICAgICAgICAgICAgICByciA9IGVuZFJSOwogICAgICAgICAgICAgICAgICAgICAgICBnZyA9IGVuZEdHOwogICAgICAgICAgICAgICAgICAgICAgICBiYiA9IGVuZEJCOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJyID0gTWF0aC5jZWlsKHRoaXMuZWFzZShjdXJUaW1lLCBzdGFydFJSLCBlbmRSUiAtIHN0YXJ0UlIsIHRoaXMuZHVyYXRpb24gKiAxMDAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdnID0gTWF0aC5jZWlsKHRoaXMuZWFzZShjdXJUaW1lLCBzdGFydEdHLCBlbmRHRyAtIHN0YXJ0R0csIHRoaXMuZHVyYXRpb24gKiAxMDAwKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJiID0gTWF0aC5jZWlsKHRoaXMuZWFzZShjdXJUaW1lLCBzdGFydEJCLCBlbmRCQiAtIHN0YXJ0QkIsIHRoaXMuZHVyYXRpb24gKiAxMDAwKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1clZhbHVlID0gJ3JnYignICsgcnIgKyAnLCAnICsgZ2cgKyAnLCAnICsgYmIgKyAnKSc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmKGlzRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1clZhbHVlID0gdGhpcy5lbmRWYWx1ZVtpXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJWYWx1ZSA9IHRoaXMuZWFzZShjdXJUaW1lLCB0aGlzLnN0YXJ0VmFsdWVbaV0sIHRoaXMuZW5kVmFsdWVbaV0gLSB0aGlzLnN0YXJ0VmFsdWVbaV0sIHRoaXMuZHVyYXRpb24gKiAxMDAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YWx1ZUluZm8ucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlOYW1lOiB0aGlzLnByb3BlcnR5TmFtZVtpXSwKICAgICAgICAgICAgICAgICAgICBjdXJWYWx1ZSA6IGN1clZhbHVlLAogICAgICAgICAgICAgICAgICAgIGlzQ29sb3I6IHRoaXMuY29sb3JMaXN0W2ldLmlzQ29sb3IKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodmFsdWVJbmZvKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNldFZhbHVlCiAgICAgICAgICogQGRlc2Mg5pS55Y+Y5YC8CiAgICAgICAgICovCiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlSW5mbykgewogICAgICAgICAgICB2YXIgc2V0SW5mbyA9IHt9LAogICAgICAgICAgICAgICAgbmVlZFNldCA9IGZhbHNlLAogICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICBpTGVuID0gdmFsdWVJbmZvLmxlbmd0aDsKICAgICAgICAgICAgZm9yKDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHZhbHVlSW5mb1tpXS5wcm9wZXJ0eU5hbWUsCiAgICAgICAgICAgICAgICAgICAgY3VyVmFsdWUgPSB2YWx1ZUluZm9baV0uY3VyVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgaXNDb2xvciA9IHZhbHVlSW5mb1tpXS5pc0NvbG9yOwogICAgICAgICAgICAgICAgaWYocHJvcGVydHlOYW1lID09ICdzY3JvbGxMZWZ0JyB8fCBwcm9wZXJ0eU5hbWUgPT0gJ3Njcm9sbFRvcCcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsW3Byb3BlcnR5TmFtZV0gPSB0aGlzLmdldFZhbHVlKGN1clZhbHVlLCBpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SW5mb1twcm9wZXJ0eU5hbWVdID0gaXNDb2xvciA/IGN1clZhbHVlIDogdGhpcy5nZXRWYWx1ZShjdXJWYWx1ZSwgaSk7CiAgICAgICAgICAgICAgICAgICAgbmVlZFNldCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKG5lZWRTZXQpIHsKICAgICAgICAgICAgICAgIGZvcih2YXIga2V5IGluIHNldEluZm8pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlW2tleV0gPSBzZXRJbmZvW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0VmFsdWUKICAgICAgICAgKiBAcGFyYW0gdmFsdWUgICAgLSAgIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIG9yZGVyICAgIC0gICB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgb3JkZXIpewogICAgICAgICAgICByZXR1cm4gdGhpcy5uZWVkUGFyYW1zW29yZGVyXSA/IHZhbHVlICsgJ3B4JyA6IHZhbHVlOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLlR3ZWVuIgogICAgfSk7CgogICAgLyoqCiAgICAgKiBAY2xhc3Mgb2N0b3B1cy5TdGVwVHdlZW4KICAgICAqLwogICAgby5TdGVwVHdlZW4gPSBvLmRlZmluZSh7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHR5cGUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOaViOaenOS8mOWFiOaIluaAp+iDveS8mOWFiAogICAgICAgICAqLwogICAgICAgIHR5cGU6ICJub3JtYWwiLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlYXNlCiAgICAgICAgICovCiAgICAgICAgZWFzZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc3RhcnRWYWx1ZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgc3RhcnRWYWx1ZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZW5kVmFsdWUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGVuZFZhbHVlOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBkdXJhdGlvbgogICAgICAgICAqIEBkZXNjIOS4jm9jdG9wdXMudHdlZW7kuI3lkIwg6L+Z6YeM55qEZHVyYXRpb27ooajnpLrliqjnlLvmiafooYznmoTmrKHmlbAKICAgICAgICAgKi8KICAgICAgICBkdXJhdGlvbjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZnVuYwogICAgICAgICAqIEB0eXBlIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICBmdW5jOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjb3VudAogICAgICAgICAqLwogICAgICAgIGNvdW50OiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwbGF5aW5nCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOagh+W/l+aYr+WQpuWcqOWKqOeUuwogICAgICAgICAqLwogICAgICAgIHBsYXlpbmc6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBwYXJhbSBvcHRpb25zCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICBvLmV4dGVuZCh0aGlzLCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5lYXNlID0gdGhpcy5lYXNlIHx8IG8uZWFzaW5nLmV4cG8uZWFzZU91dDsKICAgICAgICAgICAgdGhpcy5zdGFydCh0aGlzLnN0YXJ0VmFsdWUsIHRoaXMuZW5kVmFsdWUsIHRoaXMuZHVyYXRpb24sIHRoaXMuZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHN0YXJ0CiAgICAgICAgICogQHBhcmFtIHN0YXJ0VmFsdWUKICAgICAgICAgKiBAcGFyYW0gZW5kVmFsdWUKICAgICAgICAgKiBAcGFyYW0gZHVyYXRpb24KICAgICAgICAgKiBAcGFyYW0gZnVuYwogICAgICAgICAqLwogICAgICAgIHN0YXJ0OiBmdW5jdGlvbihzdGFydFZhbHVlLCBlbmRWYWx1ZSwgZHVyYXRpb24sIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5wbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zdGFydFZhbHVlID0gc3RhcnRWYWx1ZTsKICAgICAgICAgICAgdGhpcy5lbmRWYWx1ZSA9IGVuZFZhbHVlOwogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgICAgIHRoaXMuZnVuYyA9IGZ1bmM7CiAgICAgICAgICAgIHRoaXMuY291bnQgPSAwOwogICAgICAgICAgICBpZih0aGlzLmZ1bmMgJiYgdGhpcy5mdW5jLnN0YXJ0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bmMuc3RhcnQuY2FsbCh0aGlzLCB0aGlzLnN0YXJ0VmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoaXMucGxheSwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuU3RlcFR3ZWVuLnN0b3AKICAgICAgICAgKiBAZGVzYyDlgZzmraLliqjnlLsKICAgICAgICAgKi8KICAgICAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYoIXRoaXMucGxheWluZykgcmV0dXJuOwoKICAgICAgICAgICAgaWYodGhpcy5mdW5jICYmIHRoaXMuZnVuYy5kb25lKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bmMuZG9uZS5jYWxsKHRoaXMsIHRoaXMuZW5kVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZGVzdHJveQogICAgICAgICAqLwogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmZ1bmMgPSBudWxsOwogICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSBudWxsOwogICAgICAgICAgICB0aGlzLmVuZFZhbHVlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuY291bnQgPSBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBwbGF5CiAgICAgICAgICovCiAgICAgICAgcGxheTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMucGxheWluZyA9PSBmYWxzZSkJcmV0dXJuOwogICAgICAgICAgICB2YXIgdmFsdWUgPSB7fTsKICAgICAgICAgICAgZm9yKHZhciBrIGluIHRoaXMuc3RhcnRWYWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIGIgPSB0aGlzLnN0YXJ0VmFsdWVba107CiAgICAgICAgICAgICAgICB2YXIgZiA9IHRoaXMuZW5kVmFsdWVba107CiAgICAgICAgICAgICAgICBpZihiID09IG51bGwgfHwgZiA9PSBudWxsIHx8IGlzTmFOKGIpIHx8IGlzTmFOKGYpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIHZhbHVlIGZvciBUd2VlbicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGMgPSBmIC0gYjsKICAgICAgICAgICAgICAgIHZhbHVlW2tdID0gdGhpcy5lYXNlLmFwcGx5KHRoaXMsIFt0aGlzLmNvdW50LCBiLCBjLCB0aGlzLmR1cmF0aW9uXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jb3VudCsrOwogICAgICAgICAgICBpZih0aGlzLmZ1bmMgJiYgdGhpcy5mdW5jLmVhY2hTdGVwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bmMuZWFjaFN0ZXAuY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5jb3VudCA+IHRoaXMuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoaXMucGxheSwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLlN0ZXBUd2VlbiIKICAgIH0pOwoKICAgIC8qKgogICAgICogQG5hbWVzcGFjZSBvY3RvcHVzLmVhc2luZwogICAgICogQGRlc2Mg5Yqo55S75pa55rOVIOavj+S4quaWueazlemDveWMheaLrCAiZWFzZUluIiDmuJDlv6sgImVhc2VPdXQiIOa4kOaFoiAiZWFzZUluT3V0IiDnuqDnu5PnmoTkuInkuKrlgLzlj6/pgIkKICAgICAqLwogICAgby5lYXNpbmcgPSBvLmVhc2luZyB8fCB7fTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLmxpbmVhcgogICAgICogQGRlc2Mg57q/5oCn5Yqo55S7CiAgICAgKi8KICAgIG8uZWFzaW5nLmxpbmVhciA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VJbgogICAgICAgICAqIEBkZXNjIOe6v+aAp+a4kOW/qwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW4KICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluOiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjKnQvZCArIGI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VPdXQKICAgICAgICAgKiBAZGVzYyDnur/mgKfmuJDmhaIKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZU91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjKnQvZCArIGI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcubGluZWFyLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6v+aAp+e6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjKnQvZCArIGI7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLmV4cG8KICAgICAqIEBkZXNjIOaMh+aVsOabsue6v+eahOe8k+WKqAogICAgICoKICAgICAqLwogICAgby5lYXNpbmcuZXhwbyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmV4cG8uZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuICh0PT0wKSA/IGIgOiBjICogTWF0aC5wb3coMiwgMTAgKiAodC9kIC0gMSkpICsgYjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuZXhwby5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gKHQ9PWQpID8gYitjIDogYyAqICgtTWF0aC5wb3coMiwgLTEwICogdC9kKSArIDEpICsgYjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuZXhwby5lYXNlSW5PdXQKICAgICAgICAgKiBAZGVzYyDnuqDnu5MKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbk91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICBpZiAodD09MCkgcmV0dXJuIGI7CiAgICAgICAgICAgIGlmICh0PT1kKSByZXR1cm4gYitjOwogICAgICAgICAgICBpZiAoKHQvPWQvMikgPCAxKSByZXR1cm4gYy8yICogTWF0aC5wb3coMiwgMTAgKiAodCAtIDEpKSArIGI7CiAgICAgICAgICAgIHJldHVybiBjLzIgKiAoLU1hdGgucG93KDIsIC0xMCAqIC0tdCkgKyAyKSArIGI7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLnF1YWQKICAgICAqIEBkZXNjIOS6jOasoeaWueeahOe8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5xdWFkID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcucXVhZC5lYXNlSW4KICAgICAgICAgKiBAZGVzYyDmuJDlv6sKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluCiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbjogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyoodC89ZCkqdCArIGI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1YWQuZWFzZU91dAogICAgICAgICAqIEBkZXNjIOa4kOaFogogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VPdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC1jICoodC89ZCkqKHQtMikgKyBiOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5xdWFkLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmICgodC89ZC8yKSA8IDEpIHJldHVybiBjLzIqdCp0ICsgYjsKICAgICAgICAgICAgcmV0dXJuIC1jLzIgKiAoKC0tdCkqKHQtMikgLSAxKSArIGI7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLmJhY2sKICAgICAqIEBkZXNjIOWcqOi/h+a4oeiMg+WbtOWklueahOS4gOerr+aIluS4pOerr+aJqeWxleWKqOeUu+S4gOasoe+8jOS7peS6p+eUn+S7juWFtuiMg+WbtOWkluWbnuaLieeahOaViOaenOOAggogICAgICog6YCa5L+X6K6y5bCx5piv5YWI5ZCR5ZCOIOWGjeWQkeWPjeaWueWQkQogICAgICovCiAgICBvLmVhc2luZy5iYWNrID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuYmFjay5lYXNlSW4KICAgICAgICAgKiBAZGVzYyDmuJDlv6sKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluCiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbjogZnVuY3Rpb24odCwgYiwgYywgZCwgcykgewogICAgICAgICAgICBpZiAocyA9PSB1bmRlZmluZWQpIHMgPSAxLjcwMTU4OwogICAgICAgICAgICByZXR1cm4gYyAqICh0IC89IGQpICogdCAqICgocyArIDEpICogdCAtIHMpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5iYWNrLmVhc2VPdXQKICAgICAgICAgKiBAZGVzYyDmuJDmhaIKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZU91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkLCBzKSB7CiAgICAgICAgICAgIGlmIChzID09IHVuZGVmaW5lZCkgcyA9IDEuNzAxNTg7CiAgICAgICAgICAgIHJldHVybiBjICogKCh0ID0gdCAvIGQgLSAxKSAqIHQgKiAoKHMgKyAxKSAqIHQgKyBzKSArIDEpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5iYWNrLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkLCBzKSB7CiAgICAgICAgICAgIGlmIChzID09IHVuZGVmaW5lZCkgcyA9IDEuNzAxNTg7CiAgICAgICAgICAgIGlmICgodCAvPSBkIC8gMikgPCAxKSByZXR1cm4gYyAvIDIgKiAodCAqIHQgKiAoKChzICo9ICgxLjUyNSkpICsgMSkgKiB0IC0gcykpICsgYjsKICAgICAgICAgICAgcmV0dXJuIGMgLyAyICogKCh0IC09IDIpICogdCAqICgoKHMgKj0gKDEuNTI1KSkgKyAxKSAqIHQgKyBzKSArIDIpICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5ib3VuY2UKICAgICAqIEBkZXNjIOWcqOi/h+a4oeiMg+WbtOeahOS4gOerr+aIluS4pOerr+WGhea3u+WKoOW8uei3s+aViOaenOOAguexu+S8vOS4gOS4queQg+iQveWQkeWcsOadv+WPiOW8uei1t+WQju+8jOWHoOasoemAkOa4kOWHj+Wwj+eahOWbnuW8uei/kOWKqAogICAgICovCiAgICBvLmVhc2luZy5ib3VuY2UgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5ib3VuY2UuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgLSBvLmVhc2luZy5ib3VuY2UuZWFzZU91dChkIC0gdCwgMCwgYywgZCkgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmJvdW5jZS5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICBpZiAoKHQgLz0gZCkgPCAoMSAvIDIuNzUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiB0ICogdCkgKyBiCiAgICAgICAgICAgIH0gZWxzZSBpZiAodCA8ICgyIC8gMi43NSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjICogKDcuNTYyNSAqICh0IC09ICgxLjUgLyAyLjc1KSkgKiB0ICsgLjc1KSArIGIKICAgICAgICAgICAgfSBlbHNlIGlmICh0IDwgKDIuNSAvIDIuNzUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiAodCAtPSAoMi4yNSAvIDIuNzUpKSAqIHQgKyAuOTM3NSkgKyBiCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiAodCAtPSAoMi42MjUgLyAyLjc1KSkgKiB0ICsgLjk4NDM3NSkgKyBiCiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuYm91bmNlLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmICh0IDwgZCAvIDIpIHJldHVybiBvLmVhc2luZy5ib3VuY2UuZWFzZUluKHQgKiAyLCAwLCBjLCBkKSAqIC41ICsgYjsKICAgICAgICAgICAgZWxzZSByZXR1cm4gby5lYXNpbmcuYm91bmNlLmVhc2VPdXQodCAqIDIgLSBkLCAwLCBjLCBkKSAqIC41ICsgYyAqIC41ICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5lbGFzdGljCiAgICAgKiBAZGVzYyDmt7vliqDkuIDnq6/miJbkuKTnq6/otoXlh7rov4fmuKHojIPlm7TnmoTlvLnmgKfmlYjmnpwg5YW25Lit55qE6L+Q5Yqo55Sx5oyJ54Wn5oyH5pWw5pa55byP6KGw5YeP55qE5q2j5bym5rOi5p2l5a6a5LmJCiAgICAgKiDmjIfmlbDoobDlh4/nmoTmraPlvKbmm7Lnur/nvJPliqgKICAgICAqLwogICAgby5lYXNpbmcuZWxhc3RpYyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmVsYXN0aWMuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQsIGEsIHApIHsKICAgICAgICAgICAgaWYgKHQgPT0gMCkgcmV0dXJuIGI7CiAgICAgICAgICAgIGlmICgodCAvPSBkKSA9PSAxKSByZXR1cm4gYiArIGM7CiAgICAgICAgICAgIGlmICghcCkgcCA9IGQgKiAuMzsKICAgICAgICAgICAgaWYgKCFhIHx8IGEgPCBNYXRoLmFicyhjKSkgewogICAgICAgICAgICAgICAgYSA9IGM7CiAgICAgICAgICAgICAgICB2YXIgcyA9IHAgLyA0CiAgICAgICAgICAgIH0gZWxzZSB2YXIgcyA9IHAgLyAoMiAqIE1hdGguUEkpICogTWF0aC5hc2luKGMgLyBhKTsKICAgICAgICAgICAgcmV0dXJuIC0gKGEgKiBNYXRoLnBvdygyLCAxMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0ICogZCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApKSArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuZWxhc3RpYy5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCwgYSwgcCkgewogICAgICAgICAgICBpZiAodCA9PSAwKSByZXR1cm4gYjsKICAgICAgICAgICAgaWYgKCh0IC89IGQpID09IDEpIHJldHVybiBiICsgYzsKICAgICAgICAgICAgaWYgKCFwKSBwID0gZCAqIC4zOwogICAgICAgICAgICBpZiAoIWEgfHwgYSA8IE1hdGguYWJzKGMpKSB7CiAgICAgICAgICAgICAgICBhID0gYzsKICAgICAgICAgICAgICAgIHZhciBzID0gcCAvIDQKICAgICAgICAgICAgfSBlbHNlIHZhciBzID0gcCAvICgyICogTWF0aC5QSSkgKiBNYXRoLmFzaW4oYyAvIGEpOwogICAgICAgICAgICByZXR1cm4gKGEgKiBNYXRoLnBvdygyLCAtMTAgKiB0KSAqIE1hdGguc2luKCh0ICogZCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApICsgYyArIGIpCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmVsYXN0aWMuZWFzZUluT3V0CiAgICAgICAgICogQGRlc2Mg57qg57uTCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbk91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW5PdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQsIGEsIHApIHsKICAgICAgICAgICAgaWYgKHQgPT0gMCkgcmV0dXJuIGI7CiAgICAgICAgICAgIGlmICgodCAvPSBkIC8gMikgPT0gMikgcmV0dXJuIGIgKyBjOwogICAgICAgICAgICBpZiAoIXApIHAgPSBkICogKC4zICogMS41KTsKICAgICAgICAgICAgaWYgKCFhIHx8IGEgPCBNYXRoLmFicyhjKSkgewogICAgICAgICAgICAgICAgYSA9IGM7CiAgICAgICAgICAgICAgICB2YXIgcyA9IHAgLyA0CiAgICAgICAgICAgIH0gZWxzZSB2YXIgcyA9IHAgLyAoMiAqIE1hdGguUEkpICogTWF0aC5hc2luKGMgLyBhKTsKICAgICAgICAgICAgaWYgKHQgPCAxKSByZXR1cm4gLSAuNSAqIChhICogTWF0aC5wb3coMiwgMTAgKiAodCAtPSAxKSkgKiBNYXRoLnNpbigodCAqIGQgLSBzKSAqICgyICogTWF0aC5QSSkgLyBwKSkgKyBiOwogICAgICAgICAgICByZXR1cm4gYSAqIE1hdGgucG93KDIsIC0xMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0ICogZCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApICogLjUgKyBjICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5jaXJjCiAgICAgKiBAZGVzYyDlnIblvaLmm7Lnur/nmoTnvJPliqgKICAgICAqLwogICAgby5lYXNpbmcuY2lyYyA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmNpcmMuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC0gYyAqIChNYXRoLnNxcnQoMSAtICh0IC89IGQpICogdCkgLSAxKSArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuY2lyYy5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqIE1hdGguc3FydCgxIC0gKHQgPSB0IC8gZCAtIDEpICogdCkgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLmNpcmMuZWFzZUluT3V0CiAgICAgICAgICogQGRlc2Mg57qg57uTCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbk91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW5PdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgaWYgKCh0IC89IGQgLyAyKSA8IDEpIHJldHVybiAtIGMgLyAyICogKE1hdGguc3FydCgxIC0gdCAqIHQpIC0gMSkgKyBiOwogICAgICAgICAgICByZXR1cm4gYyAvIDIgKiAoTWF0aC5zcXJ0KDEgLSAodCAtPSAyKSAqIHQpICsgMSkgKyBiCiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuYW1lIG9jdG9wdXMuZWFzaW5nLnNpbmUKICAgICAqIEBkZXNjIOato+W8puabsue6v+e8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5zaW5lID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuc2luZS5lYXNlSW4KICAgICAgICAgKiBAZGVzYyDmuJDlv6sKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluCiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbjogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gLSBjICogTWF0aC5jb3ModCAvIGQgKiAoTWF0aC5QSSAvIDIpKSArIGMgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnNpbmUuZWFzZU91dAogICAgICAgICAqIEBkZXNjIOa4kOaFogogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VPdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgKiBNYXRoLnNpbih0IC8gZCAqIChNYXRoLlBJIC8gMikpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5zaW5lLmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiAtIGMgLyAyICogKE1hdGguY29zKE1hdGguUEkgKiB0IC8gZCkgLSAxKSArIGIKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcucXVpbnQKICAgICAqIEBkZXNjIOS6lOasoeaWueeahOe8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5xdWludCA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1aW50LmVhc2VJbgogICAgICAgICAqIEBkZXNjIOa4kOW/qwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW4KICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluOiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjICogKHQgLz0gZCkgKiB0ICogdCAqIHQgKiB0ICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5xdWludC5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqICgodCA9IHQgLyBkIC0gMSkgKiB0ICogdCAqIHQgKiB0ICsgMSkgKyBiCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1aW50LmVhc2VJbk91dAogICAgICAgICAqIEBkZXNjIOe6oOe7kwogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlSW5PdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZUluT3V0OiBmdW5jdGlvbih0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmICgodCAvPSBkIC8gMikgPCAxKSByZXR1cm4gYyAvIDIgKiB0ICogdCAqIHQgKiB0ICogdCArIGI7CiAgICAgICAgICAgIHJldHVybiBjIC8gMiAqICgodCAtPSAyKSAqIHQgKiB0ICogdCAqIHQgKyAyKSArIGIKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5hbWUgb2N0b3B1cy5lYXNpbmcucXVhcnQKICAgICAqIEBkZXNjIOWbm+asoeaWueeahOe8k+WKqAogICAgICovCiAgICBvLmVhc2luZy5xdWFydCA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByb3BlcnR5IG9jdG9wdXMuZWFzaW5nLnF1YXJ0LmVhc2VJbgogICAgICAgICAqIEBkZXNjIOa4kOW/qwogICAgICAgICAqCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgKiAodCAvPSBkKSAqIHQgKiB0ICogdCArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcucXVhcnQuZWFzZU91dAogICAgICAgICAqIEBkZXNjIOa4kOaFogogICAgICAgICAqIEZ1bmN0aW9uOiBlYXNlT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VPdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC0gYyAqICgodCA9IHQgLyBkIC0gMSkgKiB0ICogdCAqIHQgLSAxKSArIGIKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcucXVhcnQuZWFzZUluT3V0CiAgICAgICAgICogQGRlc2Mg57qg57uTCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbk91dAogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW5PdXQ6IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgaWYgKCh0IC89IGQgLyAyKSA8IDEpIHJldHVybiBjIC8gMiAqIHQgKiB0ICogdCAqIHQgKyBiOwogICAgICAgICAgICByZXR1cm4gLSBjIC8gMiAqICgodCAtPSAyKSAqIHQgKiB0ICogdCAtIDIpICsgYgogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZSBvY3RvcHVzLmVhc2luZy5jdWJpYwogICAgICogQGRlc2Mg5LiJ5qyh5pa555qE57yT5YqoCiAgICAgKi8KICAgIG8uZWFzaW5nLmN1YmljID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJvcGVydHkgb2N0b3B1cy5lYXNpbmcuY3ViaWMuZWFzZUluCiAgICAgICAgICogQGRlc2Mg5riQ5b+rCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VJbgogICAgICAgICAqCiAgICAgICAgICogUGFyYW1ldGVyczoKICAgICAgICAgKiB0IC0ge0Zsb2F0fSB0aW1lCiAgICAgICAgICogYiAtIHtGbG9hdH0gYmVnaW5uaW5nIHBvc2l0aW9uCiAgICAgICAgICogYyAtIHtGbG9hdH0gdG90YWwgY2hhbmdlCiAgICAgICAgICogZCAtIHtGbG9hdH0gZHVyYXRpb24gb2YgdGhlIHRyYW5zaXRpb24KICAgICAgICAgKi8KICAgICAgICBlYXNlSW46IGZ1bmN0aW9uKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIGMgKiAodCAvPSBkKSAqIHQgKiB0ICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5jdWJpYy5lYXNlT3V0CiAgICAgICAgICogQGRlc2Mg5riQ5oWiCiAgICAgICAgICogRnVuY3Rpb246IGVhc2VPdXQKICAgICAgICAgKgogICAgICAgICAqIFBhcmFtZXRlcnM6CiAgICAgICAgICogdCAtIHtGbG9hdH0gdGltZQogICAgICAgICAqIGIgLSB7RmxvYXR9IGJlZ2lubmluZyBwb3NpdGlvbgogICAgICAgICAqIGMgLSB7RmxvYXR9IHRvdGFsIGNoYW5nZQogICAgICAgICAqIGQgLSB7RmxvYXR9IGR1cmF0aW9uIG9mIHRoZSB0cmFuc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqICgodCA9IHQgLyBkIC0gMSkgKiB0ICogdCArIDEpICsgYgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLmVhc2luZy5jdWJpYy5lYXNlSW5PdXQKICAgICAgICAgKiBAZGVzYyDnuqDnu5MKICAgICAgICAgKiBGdW5jdGlvbjogZWFzZUluT3V0CiAgICAgICAgICoKICAgICAgICAgKiBQYXJhbWV0ZXJzOgogICAgICAgICAqIHQgLSB7RmxvYXR9IHRpbWUKICAgICAgICAgKiBiIC0ge0Zsb2F0fSBiZWdpbm5pbmcgcG9zaXRpb24KICAgICAgICAgKiBjIC0ge0Zsb2F0fSB0b3RhbCBjaGFuZ2UKICAgICAgICAgKiBkIC0ge0Zsb2F0fSBkdXJhdGlvbiBvZiB0aGUgdHJhbnNpdGlvbgogICAgICAgICAqLwogICAgICAgIGVhc2VJbk91dDogZnVuY3Rpb24odCwgYiwgYywgZCkgewogICAgICAgICAgICBpZiAoKHQgLz0gZCAvIDIpIDwgMSkgcmV0dXJuIGMgLyAyICogdCAqIHQgKiB0ICsgYjsKICAgICAgICAgICAgcmV0dXJuIGMgLyAyICogKCh0IC09IDIpICogdCAqIHQgKyAyKSArIGIKICAgICAgICB9CiAgICB9OwoKfSkob2N0b3B1cyk7Ci8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICog5Yqo55S76KGM5Li66YOo5YiGCiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICogQHJlcXVpcmUgbGliL3R3ZWVuLmpzCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKi8KOyhmdW5jdGlvbihvLCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYW5pbWF0ZQogICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0KICAgICAqIEBwYXJhbSBvcHRpb25zLmVsIHtET01FbGVtZW50fSDov5vooYzliqjnlLvnmoToioLngrkKICAgICAqIEBwYXJhbSBvcHRpb25zLnR5cGUge1N0cmluZ30g6L+b6KGM5Yqo55S755qE57G75Z6LCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5jb25maWcge09iamVjdH0g6L+b6KGM5Yqo55S755qE5Y+C5pWwCiAgICAgKiBAcmV0dXJuIG9jdG9wdXMuYW5pbWF0aW9uCiAgICAgKi8KICAgIG8uYW5pbWF0ZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gISFvLmFuaW1hdGlvbltvcHRpb25zLnR5cGVdID8gKG8uYW5pbWF0aW9uW29wdGlvbnMudHlwZV0ob3B0aW9ucy5lbCwgb3B0aW9ucy5jb25maWcsIG9wdGlvbnMuZnVuYykpIDogbnVsbDsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmFtZXNwYWNlIG9jdG9wdXMuYW5pbWF0aW9uCiAgICAgKi8KICAgIG9jdG9wdXMuYW5pbWF0aW9uID0gb2N0b3B1cy5hbmltYXRpb24gfHwgewoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYW5pbWF0aW9uLnNsaWRlCiAgICAgICAgICovCiAgICAgICAgc2xpZGU6IGZ1bmN0aW9uKGVsLCBjb25maWcsIGZ1bmMpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBvLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBkaXJlY3Rpb246ICJsZWZ0IiwKICAgICAgICAgICAgICAgIG91dDogdHJ1ZSwKICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAuNCwKICAgICAgICAgICAgICAgIGlzRmFkZTogZmFsc2UsCiAgICAgICAgICAgICAgICBlYXNlOiAiZWFzZS1vdXQiLAogICAgICAgICAgICAgICAgaXNTY2FsZTogZmFsc2UKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB2YXIgZWwgPSBlbCwKICAgICAgICAgICAgICAgIG91dCA9IG9wdGlvbnMub3V0LAogICAgICAgICAgICAgICAgY3VycmVudE9wYWNpdHksCiAgICAgICAgICAgICAgICB0b09wYWNpdHksCiAgICAgICAgICAgICAgICBkaXJlY3Rpb24gPSBvcHRpb25zLmRpcmVjdGlvbiwKICAgICAgICAgICAgICAgIHRvWCA9IDAsCiAgICAgICAgICAgICAgICB0b1kgPSAwLAogICAgICAgICAgICAgICAgZnJvbVggPSAwLAogICAgICAgICAgICAgICAgZnJvbVkgPSAwLAogICAgICAgICAgICAgICAgZWxPZmZzZXQgPSAxMDAsCiAgICAgICAgICAgICAgICBwcyA9IFtdLAogICAgICAgICAgICAgICAgZnZzID0gW10sCiAgICAgICAgICAgICAgICBldnMgPSBbXTsKICAgICAgICAgICAgaWYoZGlyZWN0aW9uID09ICJsZWZ0IiB8fCBkaXJlY3Rpb24gPT0gInJpZ2h0IikgewogICAgICAgICAgICAgICAgaWYob3V0KSB7CiAgICAgICAgICAgICAgICAgICAgdG9YID0gLWVsT2Zmc2V0OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmcm9tWCA9IGVsT2Zmc2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYoZGlyZWN0aW9uID09ICJ1cCIgfHwgZGlyZWN0aW9uID09ICJkb3duIikgewogICAgICAgICAgICAgICAgaWYob3V0KSB7CiAgICAgICAgICAgICAgICAgICAgdG9ZID0gLWVsT2Zmc2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZnJvbVkgPSBlbE9mZnNldDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlyZWN0aW9uID09ICdyaWdodCcgfHwgZGlyZWN0aW9uID09ICdkb3duJykgewogICAgICAgICAgICAgICAgdG9ZICo9IC0xOwogICAgICAgICAgICAgICAgdG9YICo9IC0xOwogICAgICAgICAgICAgICAgZnJvbVkgKj0gLTE7CiAgICAgICAgICAgICAgICBmcm9tWCAqPSAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwcy5wdXNoKCItd2Via2l0LXRyYW5zZm9ybSIpOwogICAgICAgICAgICBmdnMucHVzaCgidHJhbnNsYXRlM2QoIiArIGZyb21YICsgIiUsICIgKyBmcm9tWSArICIlLCAwKSIpOwogICAgICAgICAgICBldnMucHVzaCgidHJhbnNsYXRlM2QoIiArIHRvWCArICIlLCAiICsgdG9ZICsgIiUsIDApIik7CiAgICAgICAgICAgIGlmKG9wdGlvbnMuaXNGYWRlKSB7CiAgICAgICAgICAgICAgICB0b09wYWNpdHkgPSBvdXQgPyAwIDogMTsKICAgICAgICAgICAgICAgIGN1cnJlbnRPcGFjaXR5ID0gb3V0ID8gMSA6IDA7CiAgICAgICAgICAgICAgICBmdnMucHVzaChjdXJyZW50T3BhY2l0eSk7CiAgICAgICAgICAgICAgICBldnMucHVzaCh0b09wYWNpdHkpOwogICAgICAgICAgICAgICAgcHMucHVzaCgib3BhY2l0eSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG9wdGlvbnMuaXNTY2FsZSAmJiBvdXQpIHsKICAgICAgICAgICAgICAgIHZhciBmcm9tU2NhbGUgPSAxLAogICAgICAgICAgICAgICAgICAgIHRvU2NhbGUgPSAwLjg7CiAgICAgICAgICAgICAgICBmdnMucHVzaCgic2NhbGUoIiArIGZyb21TY2FsZSArICIpIik7CiAgICAgICAgICAgICAgICBldnMucHVzaCgic2NhbGUoIiArIHRvU2NhbGUgKyAiKSIpOwogICAgICAgICAgICAgICAgcHMucHVzaCgiLXdlYmtpdC10cmFuc2Zvcm0iKTsKICAgICAgICAgICAgICAgIHZhciBfaW5kZXggPSBwcy5pbmRleE9mKCJvcGFjaXR5Iik7CiAgICAgICAgICAgICAgICBpZihfaW5kZXggPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBwcy5wdXNoKCJvcGFjaXR5Iik7CiAgICAgICAgICAgICAgICAgICAgZXZzLnB1c2gob3V0ID8gMSA6IDApOwogICAgICAgICAgICAgICAgICAgIGZ2cy5wdXNoKG91dCA/IDAgOiAxKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXZzW19pbmRleF0gPSBvdXQgPyAxIDogMDsKICAgICAgICAgICAgICAgICAgICBmdnNbX2luZGV4XSA9IG91dCA/IDAgOiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgby5Ud2VlbihlbCwgcHMsIGZ2cywgZXZzLCBvcHRpb25zLmR1cmF0aW9uLCBmdW5jLCB7CiAgICAgICAgICAgICAgICBlYXNlOiBvcHRpb25zLmVhc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFuaW1hdGlvbi5mYWRlCiAgICAgICAgICovCiAgICAgICAgZmFkZTogZnVuY3Rpb24oZWwsIGNvbmZpZywgZnVuYykgewogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IG8uZXh0ZW5kKHsKICAgICAgICAgICAgICAgIG91dDogdHJ1ZSwKICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAuNCwKICAgICAgICAgICAgICAgIGVhc2U6ICJlYXNlLW91dCIKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB2YXIgZWwgPSBlbCwKICAgICAgICAgICAgICAgIGZyb21PcGFjaXR5ID0gMSwKICAgICAgICAgICAgICAgIHRvT3BhY2l0eSA9IDEsCiAgICAgICAgICAgICAgICBvdXQgPSBvcHRpb25zLm91dDsKICAgICAgICAgICAgaWYgKG91dCkgewogICAgICAgICAgICAgICAgdG9PcGFjaXR5ID0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZyb21PcGFjaXR5ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZnYgPSBbZnJvbU9wYWNpdHldLAogICAgICAgICAgICAgICAgZXYgPSBbdG9PcGFjaXR5XTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBvLlR3ZWVuKGVsLCBbIm9wYWNpdHkiXSwgZnYsIGV2LCBvcHRpb25zLmR1cmF0aW9uLCBmdW5jLCB7CiAgICAgICAgICAgICAgICBlYXNlOiBvcHRpb25zLmVhc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFuaW1hdGlvbi5wb3AKICAgICAgICAgKi8KICAgICAgICBwb3A6IGZ1bmN0aW9uKGVsLCBjb25maWcsIGZ1bmMpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBvLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBvdXQ6IHRydWUsCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogLjQsCiAgICAgICAgICAgICAgICBlYXNlOiAiZWFzZS1vdXQiLAogICAgICAgICAgICAgICAgc2NhbGVPbkV4aXQ6IHRydWUKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB2YXIgZWwgPSBlbCwKICAgICAgICAgICAgICAgIGZyb21TY2FsZSA9IDEsCiAgICAgICAgICAgICAgICB0b1NjYWxlID0gMSwKICAgICAgICAgICAgICAgIGZyb21PcGFjaXR5ID0gMSwKICAgICAgICAgICAgICAgIHRvT3BhY2l0eSA9IDEsCiAgICAgICAgICAgICAgICBjdXJaID0gby5kb20uZ2V0U3R5bGUoZWwsICd6LWluZGV4JykgfHwgMCwKICAgICAgICAgICAgICAgIGZyb21aID0gY3VyWiwKICAgICAgICAgICAgICAgIHRvWiA9IGN1closCiAgICAgICAgICAgICAgICBvdXQgPSBvcHRpb25zLm91dDsKCiAgICAgICAgICAgIGlmICghb3V0KSB7CiAgICAgICAgICAgICAgICBmcm9tU2NhbGUgPSAwLjAxOwogICAgICAgICAgICAgICAgZnJvbVogPSBjdXJaICsgMTsKICAgICAgICAgICAgICAgIHRvWiA9IGN1clogKyAxOwogICAgICAgICAgICAgICAgZnJvbU9wYWNpdHkgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuc2NhbGVPbkV4aXQpIHsKICAgICAgICAgICAgICAgICAgICB0b1NjYWxlID0gMC4wMTsKICAgICAgICAgICAgICAgICAgICB0b09wYWNpdHkgPSAwOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0b09wYWNpdHkgPSAwLjg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBzID0gWyItd2Via2l0LXRyYW5zZm9ybSIsICItd2Via2l0LXRyYW5zZm9ybS1vcmlnaW4iLCAib3BhY2l0eSIsICJ6LWluZGV4Il0sCiAgICAgICAgICAgICAgICBmdnMgPSBbInNjYWxlKCIgKyBmcm9tU2NhbGUgKyAiKSIsICI1MCUgNTAlIiwgZnJvbU9wYWNpdHksIGZyb21aXSwKICAgICAgICAgICAgICAgIGV2cyA9IFsic2NhbGUoIiArIHRvU2NhbGUgKyAiKSIsICI1MCUgNTAlIiwgdG9PcGFjaXR5LCB0b1pdOwogICAgICAgICAgICByZXR1cm4gbmV3IG8uVHdlZW4oZWwsIHBzLCBmdnMsIGV2cywgb3B0aW9ucy5kdXJhdGlvbiwgZnVuYywgewogICAgICAgICAgICAgICAgZWFzZTogb3B0aW9ucy5lYXNlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hbmltYXRpb24uZmxpcAogICAgICAgICAqLwogICAgICAgIGZsaXA6IGZ1bmN0aW9uKGVsLCBjb25maWcsIGZ1bmMpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBvLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBvdXQ6IHRydWUsCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogLjQsCiAgICAgICAgICAgICAgICBlYXNlOiAiZWFzZS1vdXQiLAogICAgICAgICAgICAgICAgZGlyZWN0aW9uOiAibGVmdCIKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB2YXIgZWwgPSBlbCwKICAgICAgICAgICAgICAgIGRpcmVjdGlvbiA9IG9wdGlvbnMuZGlyZWN0aW9uLAogICAgICAgICAgICAgICAgcm90YXRlUHJvcCA9ICdZJywKICAgICAgICAgICAgICAgIGZyb21TY2FsZSA9IDEsCiAgICAgICAgICAgICAgICB0b1NjYWxlID0gMSwKICAgICAgICAgICAgICAgIGZyb21Sb3RhdGUgPSAwLAogICAgICAgICAgICAgICAgb3V0ID0gb3B0aW9ucy5vdXQsCiAgICAgICAgICAgICAgICB0b1JvdGF0ZSA9IDA7CgogICAgICAgICAgICBpZiAob3V0KSB7CiAgICAgICAgICAgICAgICB0b1JvdGF0ZSA9IC0xODA7CiAgICAgICAgICAgICAgICB0b1NjYWxlID0gMC44OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZnJvbVJvdGF0ZSA9IDE4MDsKICAgICAgICAgICAgICAgIGZyb21TY2FsZSA9IDAuODsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpcmVjdGlvbiA9PSAndXAnIHx8IGRpcmVjdGlvbiA9PSAnZG93bicpIHsKICAgICAgICAgICAgICAgIHJvdGF0ZVByb3AgPSAnWCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaXJlY3Rpb24gPT0gJ3JpZ2h0JyB8fCBkaXJlY3Rpb24gPT0gJ2xlZnQnKSB7CiAgICAgICAgICAgICAgICB0b1JvdGF0ZSAqPSAtMTsKICAgICAgICAgICAgICAgIGZyb21Sb3RhdGUgKj0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWwuc3R5bGUud2Via2l0QmFja2ZhY2VWaXNpYmlsaXR5ID0gImhpZGRlbiIKICAgICAgICAgICAgcmV0dXJuIG5ldyBvLlR3ZWVuKGVsLCAiLXdlYmtpdC10cmFuc2Zvcm0iLCAncm90YXRlJyArIHJvdGF0ZVByb3AgKyAnKCcgKyBmcm9tUm90YXRlICsgJ2RlZykgc2NhbGUoJyArIGZyb21TY2FsZSArICcpJywKICAgICAgICAgICAgICAgICdyb3RhdGUnICsgcm90YXRlUHJvcCArICcoJyArIHRvUm90YXRlICsgJ2RlZykgc2NhbGUoJyArIHRvU2NhbGUgKyAnKScsIG9wdGlvbnMuZHVyYXRpb24sIGZ1bmMsIHsKICAgICAgICAgICAgICAgIGVhc2U6IG9wdGlvbnMuZWFzZQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYW5pbWF0aW9uLndpcGUKICAgICAgICAgKi8KICAgICAgICB3aXBlOiBmdW5jdGlvbihlbCwgY29uZmlnLCBmdW5jKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zID0gby5leHRlbmQoewogICAgICAgICAgICAgICAgb3V0OiB0cnVlLAogICAgICAgICAgICAgICAgZHVyYXRpb246IC40LAogICAgICAgICAgICAgICAgZWFzZTogImVhc2Utb3V0IgogICAgICAgICAgICB9LCBjb25maWcpOwogICAgICAgICAgICBmdW5jID0gZnVuYyB8fCBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgIHZhciBlbCA9IGVsLAogICAgICAgICAgICAgICAgY3VyWiA9IG8uZG9tLmdldFN0eWxlKGVsLCAiei1pbmRleCIpIHx8IDAsCiAgICAgICAgICAgICAgICB6SW5kZXgsCiAgICAgICAgICAgICAgICBvdXQgPSBvcHRpb25zLm91dCwKICAgICAgICAgICAgICAgIG1hc2sgPSAnJzsKCiAgICAgICAgICAgIGlmICghb3V0KSB7CiAgICAgICAgICAgICAgICB6SW5kZXggPSBjdXJaICsgMTsKICAgICAgICAgICAgICAgIG1hc2sgPSAnLXdlYmtpdC1ncmFkaWVudChsaW5lYXIsIGxlZnQgYm90dG9tLCByaWdodCBib3R0b20sIGZyb20odHJhbnNwYXJlbnQpLCB0bygjMDAwKSwgY29sb3Itc3RvcCg2NiUsICMwMDApLCBjb2xvci1zdG9wKDMzJSwgdHJhbnNwYXJlbnQpKSc7CiAgICAgICAgICAgICAgICB2YXIgX3dpZHRoID0gby5kb20uZ2V0V2lkdGgoZWwpOwogICAgICAgICAgICAgICAgZWwuc3R5bGUud2Via2l0TWFza0ltYWdlID0gbWFzazsKICAgICAgICAgICAgICAgIGVsLnN0eWxlLm1hc2tJbWFnZSA9IG1hc2s7CiAgICAgICAgICAgICAgICBlbC5zdHlsZS53ZWJraXRNYXNrU2l6ZSA9IF93aWR0aCAqIDMgKyAicHgiICsgby5kb20uZ2V0SGVpZ2h0KGVsKSArICJweCI7CiAgICAgICAgICAgICAgICBlbC5zdHlsZS5tYXNrU2l6ZSA9IF93aWR0aCAqIDMgKyAicHgiICsgby5kb20uZ2V0SGVpZ2h0KGVsKSArICJweCI7CiAgICAgICAgICAgICAgICBlbC5zdHlsZS56SW5kZXggPSB6SW5kZXg7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IG8uVHdlZW4oZWwsICItd2Via2l0LW1hc2stcG9zaXRpb24teCIsICIwIiwgMCAtIF93aWR0aCArICJweCIsICBvcHRpb25zLmR1cmF0aW9uLCBmdW5jLCB7CiAgICAgICAgICAgICAgICAgICAgZWFzZTogb3B0aW9ucy5lYXNlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jLCBvcHRpb25zLmR1cmF0aW9uICogMTAwMCk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hbmltYXRpb24ucm9sbAogICAgICAgICAqLwogICAgICAgIHJvbGw6IGZ1bmN0aW9uKGVsLCBjb25maWcsIGZ1bmMpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBvLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBvdXQ6IHRydWUsCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogLjQsCiAgICAgICAgICAgICAgICBlYXNlOiAiZWFzZS1vdXQiLAogICAgICAgICAgICAgICAgaXNGYWRlOiBmYWxzZQogICAgICAgICAgICB9LCBjb25maWcpOwogICAgICAgICAgICBmdW5jID0gZnVuYyB8fCBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgIHZhciBlbCA9IGVsLAogICAgICAgICAgICAgICAgb3V0ID0gb3B0aW9ucy5vdXQsCiAgICAgICAgICAgICAgICBmcm9tVHJhbnNmb3JtID0gInRyYW5zbGF0ZVgoLTEwMCUpIHJvdGF0ZSgtMTIwZGVnKSIsCiAgICAgICAgICAgICAgICB0b1RyYW5zZm9ybSA9ICJ0cmFuc2xhdGVYKDBweCkgcm90YXRlKDBkZWcpIiwKICAgICAgICAgICAgICAgIHBzID0gWyItd2Via2l0LXRyYW5zZm9ybSJdLAogICAgICAgICAgICAgICAgZnZzID0gW10sCiAgICAgICAgICAgICAgICBldnMgPSBbXTsKICAgICAgICAgICAgaWYob3V0KSB7CiAgICAgICAgICAgICAgICB2YXIgdGVtcCA9IGZyb21UcmFuc2Zvcm07CiAgICAgICAgICAgICAgICBmcm9tVHJhbnNmb3JtID0gdG9UcmFuc2Zvcm07CiAgICAgICAgICAgICAgICB0b1RyYW5zZm9ybSA9IHRlbXA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnZzLnB1c2goZnJvbVRyYW5zZm9ybSk7CiAgICAgICAgICAgIGV2cy5wdXNoKHRvVHJhbnNmb3JtKTsKICAgICAgICAgICAgaWYob3B0aW9ucy5pc0ZhZGUpIHsKICAgICAgICAgICAgICAgIHBzLnB1c2goIm9wYWNpdHkiKTsKICAgICAgICAgICAgICAgIGZ2cy5wdXNoKG9wdGlvbnMub3V0ID8gMSA6IDApOwogICAgICAgICAgICAgICAgZXZzLnB1c2gob3B0aW9ucy5vdXQgPyAwIDogMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBvLlR3ZWVuKGVsLCBwcywgZnZzLCBldnMsIG9wdGlvbnMuZHVyYXRpb24sIGZ1bmMsIHsKICAgICAgICAgICAgICAgIGVhc2U6IG9wdGlvbnMuZWFzZQogICAgICAgICAgICB9KQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5hbmltYXRpb24ucm90YXRlCiAgICAgICAgICovCiAgICAgICAgcm90YXRlOiBmdW5jdGlvbihlbCwgY29uZmlnLCBmdW5jKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zID0gby5leHRlbmQoewogICAgICAgICAgICAgICAgb3V0OiB0cnVlLAogICAgICAgICAgICAgICAgZHVyYXRpb246IC40LAogICAgICAgICAgICAgICAgZWFzZTogImVhc2Utb3V0IiwKICAgICAgICAgICAgICAgIGhvcml6b246ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgZGlyZWN0aW9uOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgIGlzRmFkZTogZmFsc2UKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB2YXIgZWwgPSBlbCwKICAgICAgICAgICAgICAgIG91dCA9IG9wdGlvbnMub3V0LAogICAgICAgICAgICAgICAgcHMgPSBbIi13ZWJraXQtdHJhbnNmb3JtIl0sCiAgICAgICAgICAgICAgICBmdnMgPSBbXSwKICAgICAgICAgICAgICAgIGZyb21UcmFuc2Zvcm0gPSAicm90YXRlKDIwMGRlZykiLAogICAgICAgICAgICAgICAgdG9UcmFuc2Zvcm0gPSAicm90YXRlKDApIiwKICAgICAgICAgICAgICAgIGV2cyA9IFtdOwogICAgICAgICAgICBpZihvcHRpb25zLmRpcmVjdGlvbiA9PSAidXAiKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLmRpcmVjdGlvbiA9ICJ0b3AiOwogICAgICAgICAgICB9IGVsc2UgaWYob3B0aW9ucy5kaXJlY3Rpb24gPT0gImRvd24iKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLmRpcmVjdGlvbiA9ICJib3R0b20iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsLnN0eWxlLndlYmtpdFRyYW5zZm9ybU9yaWdpbiA9IG9wdGlvbnMuaG9yaXpvbiArICIgIiArIG9wdGlvbnMuZGlyZWN0aW9uOwogICAgICAgICAgICBpZihvcHRpb25zLmhvcml6b24gPT0gImxlZnQiKSB7CiAgICAgICAgICAgICAgICBmcm9tVHJhbnNmb3JtID0gInJvdGF0ZSg5MGRlZykiOwogICAgICAgICAgICB9IGVsc2UgaWYob3B0aW9ucy5ob3Jpem9uID09ICJyaWdodCIpIHsKICAgICAgICAgICAgICAgIGZyb21UcmFuc2Zvcm0gPSAicm90YXRlKC05MGRlZykiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG91dCkgewogICAgICAgICAgICAgICAgdmFyIHRlbXAgPSBmcm9tVHJhbnNmb3JtOwogICAgICAgICAgICAgICAgZnJvbVRyYW5zZm9ybSA9IHRvVHJhbnNmb3JtOwogICAgICAgICAgICAgICAgdG9UcmFuc2Zvcm0gPSB0ZW1wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ2cy5wdXNoKGZyb21UcmFuc2Zvcm0pOwogICAgICAgICAgICBldnMucHVzaCh0b1RyYW5zZm9ybSk7CiAgICAgICAgICAgIGlmKG9wdGlvbnMuaXNGYWRlKSB7CiAgICAgICAgICAgICAgICBwcy5wdXNoKCJvcGFjaXR5Iik7CiAgICAgICAgICAgICAgICBmdnMucHVzaChvcHRpb25zLm91dCA/IDEgOiAwKTsKICAgICAgICAgICAgICAgIGV2cy5wdXNoKG9wdGlvbnMub3V0ID8gMCA6IDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgby5Ud2VlbihlbCwgcHMsIGZ2cywgZXZzLCBvcHRpb25zLmR1cmF0aW9uLCBmdW5jLCB7CiAgICAgICAgICAgICAgICBlYXNlOiBvcHRpb25zLmVhc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFuaW1hdGlvbi5mb2xkCiAgICAgICAgICovCiAgICAgICAgZm9sZDogZnVuY3Rpb24oZWwsIGNvbmZpZywgZnVuYykgewogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IG8uZXh0ZW5kKHsKICAgICAgICAgICAgICAgIG91dDogdHJ1ZSwKICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAuNCwKICAgICAgICAgICAgICAgIGVhc2U6ICJlYXNlLW91dCIsCiAgICAgICAgICAgICAgICBkaXJlY3Rpb246ICJsZWZ0IiwKICAgICAgICAgICAgICAgIGlzRmFkZTogZmFsc2UKICAgICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgICAgZnVuYyA9IGZ1bmMgfHwgby51dGlsLmVtcHR5OwogICAgICAgICAgICB2YXIgZWwgPSBlbCwKICAgICAgICAgICAgICAgIG91dCA9IG9wdGlvbnMub3V0LAogICAgICAgICAgICAgICAgZGlyZWN0aW9uID0gb3B0aW9ucy5kaXJlY3Rpb24sCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm0gPSB7CiAgICAgICAgICAgICAgICAgICAgImxlZnQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJvcmlnaW4iOiAiMTAwJSA1MCUiLAogICAgICAgICAgICAgICAgICAgICAgICAic3RhcnRUcmFuc2Zvcm0iOiAidHJhbnNsYXRlWCgtMTAwJSkgcm90YXRlWSgtOTBkZWcpIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInJpZ2h0IjogewogICAgICAgICAgICAgICAgICAgICAgICAib3JpZ2luIjogIjAlIDUwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGFydFRyYW5zZm9ybSI6ICJ0cmFuc2xhdGVYKDEwMCUpIHJvdGF0ZVkoOTBkZWcpIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInVwIjogewogICAgICAgICAgICAgICAgICAgICAgICAib3JpZ2luIjogIjUwJSAxMDAlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXJ0VHJhbnNmb3JtIjogInRyYW5zbGF0ZVkoLTEwMCUpIHJvdGF0ZVgoOTBkZWcpIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImRvd24iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJvcmlnaW4iOiAiNTAlIDAlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXJ0VHJhbnNmb3JtIjogInRyYW5zbGF0ZVkoMTAwJSkgcm90YXRlWCgtOTBkZWcpIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwcyA9IFsiLXdlYmtpdC10cmFuc2Zvcm0iXSwKICAgICAgICAgICAgICAgIGZ2cyA9IFtdLAogICAgICAgICAgICAgICAgZXZzID0gW10sCiAgICAgICAgICAgICAgICBmcm9tVHJhbnNmb3JtID0gdHJhbnNmb3JtW2RpcmVjdGlvbl1bInN0YXJ0VHJhbnNmb3JtIl0sCiAgICAgICAgICAgICAgICB0b1RyYW5zZm9ybSA9ICJ0cmFuc2xhdGUzZCgwLCAwLCAwKSByb3RhdGUoMCkiOwogICAgICAgICAgICBlbC5zdHlsZS53ZWJraXRUcmFuc2Zvcm1PcmlnaW4gPSB0cmFuc2Zvcm1bZGlyZWN0aW9uXVsib3JpZ2luIl07CiAgICAgICAgICAgIGlmKG91dCkgewogICAgICAgICAgICAgICAgdmFyIHRlbXAgPSBmcm9tVHJhbnNmb3JtOwogICAgICAgICAgICAgICAgZnJvbVRyYW5zZm9ybSA9IHRvVHJhbnNmb3JtOwogICAgICAgICAgICAgICAgdG9UcmFuc2Zvcm0gPSB0ZW1wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ2cy5wdXNoKGZyb21UcmFuc2Zvcm0pOwogICAgICAgICAgICBldnMucHVzaCh0b1RyYW5zZm9ybSk7CiAgICAgICAgICAgIGlmKG9wdGlvbnMuaXNGYWRlKSB7CiAgICAgICAgICAgICAgICBwcy5wdXNoKCJvcGFjaXR5Iik7CiAgICAgICAgICAgICAgICBmdnMucHVzaChvcHRpb25zLm91dCA/IDEgOiAwKTsKICAgICAgICAgICAgICAgIGV2cy5wdXNoKG9wdGlvbnMub3V0ID8gMCA6IDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgby5Ud2VlbihlbCwgcHMsIGZ2cywgZXZzLCBvcHRpb25zLmR1cmF0aW9uLCBmdW5jLCB7CiAgICAgICAgICAgICAgICBlYXNlOiBvcHRpb25zLmVhc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFuaW1hdGlvbi5jYXJvdXNlbAogICAgICAgICAqLwogICAgICAgIGNhcm91c2VsOiBmdW5jdGlvbihlbCwgY29uZmlnLCBmdW5jKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zID0gby5leHRlbmQoewogICAgICAgICAgICAgICAgb3V0OiB0cnVlLAogICAgICAgICAgICAgICAgZHVyYXRpb246IC40LAogICAgICAgICAgICAgICAgZWFzZTogImVhc2Utb3V0IiwKICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogImxlZnQiLAogICAgICAgICAgICAgICAgaXNGYWRlOiBmYWxzZQogICAgICAgICAgICB9LCBjb25maWcpOwogICAgICAgICAgICBmdW5jID0gZnVuYyB8fCBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgIHZhciBlbCA9IGVsLAogICAgICAgICAgICAgICAgb3V0ID0gb3B0aW9ucy5vdXQsCiAgICAgICAgICAgICAgICBkaXJlY3Rpb24gPSBvcHRpb25zLmRpcmVjdGlvbiwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybSA9IHsKICAgICAgICAgICAgICAgICAgICAibGVmdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgIm9yaWdpbk91dCI6ICIxMDAlIDUwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJvcmlnaW5JbiI6ICIwJSA1MCUiLAogICAgICAgICAgICAgICAgICAgICAgICAic3RhcnRUcmFuc2Zvcm1PdXQiOiAidHJhbnNsYXRlWCgtMjAwJSkgc2NhbGUoLjQpIHJvdGF0ZVkoLTY1ZGVnKSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGFydFRyYW5zZm9ybUluIjogInRyYW5zbGF0ZVgoMjAwJSkgc2NhbGUoLjQpIHJvdGF0ZVkoNjVkZWcpIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInJpZ2h0IjogewogICAgICAgICAgICAgICAgICAgICAgICAib3JpZ2luT3V0IjogIjAlIDUwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJvcmlnaW5JbiI6ICIxMDAlIDUwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGFydFRyYW5zZm9ybU91dCI6ICJ0cmFuc2xhdGVYKDIwMCUpIHNjYWxlKC40KSByb3RhdGVZKDY1ZGVnKSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGFydFRyYW5zZm9ybUluIjogInRyYW5zbGF0ZVgoLTIwMCUpIHNjYWxlKC40KSByb3RhdGVZKC02NWRlZykiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAidXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJvcmlnaW5PdXQiOiAiNTAlIDEwMCUiLAogICAgICAgICAgICAgICAgICAgICAgICAib3JpZ2luSW4iOiAiNTAlIDAlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXJ0VHJhbnNmb3JtT3V0IjogInRyYW5zbGF0ZVkoLTIwMCUpIHNjYWxlKC40KSByb3RhdGVYKDY1ZGVnKSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGFydFRyYW5zZm9ybUluIjogInRyYW5zbGF0ZVkoMjAwJSkgc2NhbGUoLjQpIHJvdGF0ZVgoLTY1ZGVnKSIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJkb3duIjogewogICAgICAgICAgICAgICAgICAgICAgICAib3JpZ2luT3V0IjogIjUwJSAwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJvcmlnaW5JbiI6ICI1MCUgMTAwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGFydFRyYW5zZm9ybU91dCI6ICJ0cmFuc2xhdGVZKDIwMCUpIHNjYWxlKC40KSByb3RhdGVYKC02NWRlZykiLAogICAgICAgICAgICAgICAgICAgICAgICAic3RhcnRUcmFuc2Zvcm1JbiI6ICJ0cmFuc2xhdGVZKC0yMDAlKSBzY2FsZSguNCkgcm90YXRlWCg2NWRlZykiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHBzID0gWyItd2Via2l0LXRyYW5zZm9ybSJdLAogICAgICAgICAgICAgICAgZnZzID0gW10sCiAgICAgICAgICAgICAgICBldnMgPSBbXSwKICAgICAgICAgICAgICAgIGZyb21UcmFuc2Zvcm0gPSB0cmFuc2Zvcm1bZGlyZWN0aW9uXVsic3RhcnRUcmFuc2Zvcm1PdXQiXSwKICAgICAgICAgICAgICAgIHRvVHJhbnNmb3JtID0gInRyYW5zbGF0ZTNkKDAsIDAsIDApIHJvdGF0ZSgwKSI7CiAgICAgICAgICAgIGVsLnN0eWxlLndlYmtpdFRyYW5zZm9ybU9yaWdpbiA9IG91dCA/IHRyYW5zZm9ybVtkaXJlY3Rpb25dWyJvcmlnaW5JbiJdIDogdHJhbnNmb3JtW2RpcmVjdGlvbl1bIm9yaWdpbk91dCJdOwogICAgICAgICAgICBpZihvdXQpIHsKICAgICAgICAgICAgICAgIGZyb21UcmFuc2Zvcm0gPSB0b1RyYW5zZm9ybTsKICAgICAgICAgICAgICAgIHRvVHJhbnNmb3JtID0gdHJhbnNmb3JtW2RpcmVjdGlvbl1bInN0YXJ0VHJhbnNmb3JtSW4iXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdnMucHVzaChmcm9tVHJhbnNmb3JtKTsKICAgICAgICAgICAgZXZzLnB1c2godG9UcmFuc2Zvcm0pOwogICAgICAgICAgICBpZihvcHRpb25zLmlzRmFkZSkgewogICAgICAgICAgICAgICAgcHMucHVzaCgib3BhY2l0eSIpOwogICAgICAgICAgICAgICAgZnZzLnB1c2gob3B0aW9ucy5vdXQgPyAxIDogMCk7CiAgICAgICAgICAgICAgICBldnMucHVzaChvcHRpb25zLm91dCA/IDAgOiAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IG8uVHdlZW4oZWwsIHBzLCBmdnMsIGV2cywgb3B0aW9ucy5kdXJhdGlvbiwgZnVuYywgewogICAgICAgICAgICAgICAgZWFzZTogb3B0aW9ucy5lYXNlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07Cn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICog566A5Y2V5a6e546w5oyH5a6a5a655Zmo5LiL55qEbGF6eWxvYWQKICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEByZXF1aXJlIGxpYi9ldmVudC5qcwogKiBAcmVxdWlyZSBsaWIvZG9tLmpzCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKi8KOyhmdW5jdGlvbihvLCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAgKiBAbWV0aG9kIG9jdG9wdXMubGF6eUltZwogICAgICogQHBhcmFtIG9wdHMKICAgICAqLwogICAgby5sYXp5SW1nID0gZnVuY3Rpb24ob3B0cykgewogICAgICAgIHJldHVybiBuZXcgby5JbWdMYXp5TG9hZChvcHRzIHx8IHt9KS5jaGVjaygpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLkltZ0xhenlMb2FkCiAgICAgKiBAZGVzYyDnlKjmnaXlr7nmjIflrprlm77niYfmiJbogIXlrrnlmajlhoXnmoTlm77niYfov5vooYzlu7blkI7liqDovb0KICAgICAqIEBwYXJhbSBvcHRpb25zIOWPguaVsAogICAgICogQHBhcmFtIG9wdGlvbnMuaW1ncyB7U3RyaW5nIHwgQXJyYXkgfCBET01FbGVtZW50fSDpnIDopoHlu7blkI7liqDovb3nmoTlm77niYfmlbDnu4TmiJboioLngrnmiJboioLngrlpZAogICAgICogQHBhcmFtIG9wdGlvbnMuZWwge0RPTUVsZW1lbnQgfCBTdHJpbmd9IOmcgOimgeW7tuWQjuWKoOi9veeahOiKgueCueWuueWZqOaIluiKgueCueWuueWZqGlkIOWmguaenOW3suS8oOWFpW9wdGlvbnMuaW1ncyDliJnmraTlj4LmlbDkuI3nlJ/mlYgKICAgICAqIEBwYXJhbSBvcHRpb25zLmNvbnRhaW5lciB7RE9NRWxlbWVudCB8IFN0cmluZ30g5Ye65rua5Yqo5p2h55qE5a655ZmoCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5zcmNOYW1lIHtTdHJpbmd9IOW7tui/n+WKoOi9veeahOWbvueJh+eahOecn+WunnNyY+WxnuaAp+Wtl+autem7mOiupOS4uiJzcmMiCiAgICAgKi8KICAgIG8uSW1nTGF6eUxvYWQgPSBvLmRlZmluZSh7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGVsCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnQgfCBTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5oyH5a6a5a655Zmo5oiW5Zu+54mHCiAgICAgICAgICovCiAgICAgICAgZWw6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNvbnRhaW5lcgogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50IHwgU3RyaW5nfQogICAgICAgICAqIEBkZXNjIOaMh+WumueahOa7muWKqOWuueWZqAogICAgICAgICAqLwogICAgICAgIGNvbnRhaW5lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaW1ncwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAZGVzYyDpnIDopoHlkI7liqDovb3nmoTpm4blkIgKICAgICAgICAgKi8KICAgICAgICBpbWdzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBzcmNOYW1lCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBzcmNOYW1lOiAic3JjIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgb3B0cwogICAgICAgICAqIEBkZXNjIOS8oOWFpeeahOWPguaVsAogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgb3B0czogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNTY3JvbGwKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDmoIflv5fkvY0KICAgICAgICAgKi8KICAgICAgICBpc1Njcm9sbDogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50CiAgICAgICAgICogQHR5cGUge29jdG9wdXMuRXZlbnR9CiAgICAgICAgICogQGRlc2Mg6Ieq6Lqr5LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgZXZlbnQ6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICB0aGlzLm9wdHMgPSBvLmV4dGVuZCh7fSwgb3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gby5nKG9wdGlvbnMuY29udGFpbmVyKSB8fCBkb2N1bWVudC5ib2R5OwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBwbm9kZSA9ICh0aGlzLmNvbnRhaW5lciA9PSBkb2N1bWVudC5ib2R5KSA/IHdpbmRvdyA6IHRoaXMuY29udGFpbmVyOwogICAgICAgICAgICB2YXIgaW1ncyA9IG9wdGlvbnMuaW1nczsKICAgICAgICAgICAgdGhpcy5pbWdzID0gW107CiAgICAgICAgICAgIHRoaXMuZXZlbnQgPSBuZXcgby5FdmVudHModGhpcyk7CiAgICAgICAgICAgIHRoaXMuc2V0RG9tcyhpbWdzKQogICAgICAgICAgICBvLmV2ZW50Lm9uKHBub2RlLCAic2Nyb2xsIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZighdGhhdC5pc1Njcm9sbCkgewogICAgICAgICAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoYXQuY2hlY2ssIHRoYXQpKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LmlzU2Nyb2xsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgICAgICBvLmV2ZW50Lm9uKHdpbmRvdywgIm9ydGNoYW5nZSIsIG8udXRpbC5iaW5kKHRoaXMucmVzZXQsIHRoaXMpLCBmYWxzZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5JbWdMYXp5TG9hZC5vbgogICAgICAgICAqIEBwYXJhbSBldnQge1N0cmluZ30g5LqL5Lu255uR5ZCs5ZCNCiAgICAgICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufSDlm57osIPlh73mlbAKICAgICAgICAgKiBAZGVzYyDmt7vliqDnm5HlkKzlmagKICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24oZXZ0LCBmdW5jKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnQub24oZXZ0LCBmdW5jKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkltZ0xhenlMb2FkLnVuCiAgICAgICAgICogQHBhcmFtIGV2dCB7U3RyaW5nfSDkuovku7bnm5HlkKzlkI0KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IOWbnuiwg+WHveaVsAogICAgICAgICAqIEBkZXNjIOWNuOi9veebkeWQrOWZqAogICAgICAgICAqLwogICAgICAgIHVuOiBmdW5jdGlvbihldnQsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5ldmVudC51bihldnQsIGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkltZ0xhenlMb2FkLm5vdGlmeQogICAgICAgICAqLwogICAgICAgIG5vdGlmeTogZnVuY3Rpb24oZXZ0LCBvcHRzKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnQudHJpZ2dlckV2ZW50KGV2dCwgb3B0cyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNldERvbXMKICAgICAgICAgKiBAZGVzYyDliJ3lp4vljJblm77niYfoioLngrkKICAgICAgICAgKi8KICAgICAgICBzZXREb21zOiBmdW5jdGlvbihpbWdzKSB7CiAgICAgICAgICAgIGlmKGltZ3MpIHsKICAgICAgICAgICAgICAgIGlmKG8udXRpbC5pc0FycmF5KGltZ3MpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbWdzID0gdGhpcy5pbWdzLmNvbmNhdChpbWdzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGltZyA9IG8uZyhpbWdzKTsKICAgICAgICAgICAgICAgICAgICBvLnV0aWwuaXNOb2RlKGltZykgJiYgdGhpcy5pbWdzLnB1c2goaW1nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmKHRoaXMub3B0cy5lbCkgewogICAgICAgICAgICAgICAgdGhpcy5lbCA9IHRoaXMuZWwgfHwgby5nKHRoaXMub3B0cy5lbCk7CiAgICAgICAgICAgICAgICB2YXIgX2ltZ3MgPSBvLiQoImltZyIsIHRoaXMuZWwpLAogICAgICAgICAgICAgICAgICAgIGxlbiA9IF9pbWdzLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgby51dGlsLmVhY2goX2ltZ3MsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIW8udXRpbC5pc05vZGUoaXRlbSkpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIW8uZG9tLmRhdGEoaXRlbSwgImxvYWRlZCIpICYmIG8uZG9tLmRhdGEoaXRlbSwgdGhhdC5zcmNOYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5pbWdzLnB1c2goaXRlbSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZih0aGlzLmVsLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAiaW1nIiAmJiAhby5kb20uZGF0YSh0aGlzLmVsLCAibG9hZGVkIikgJiYgby5kb20uZGF0YSh0aGlzLmVsLCB0aGlzLnNyY05hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbWdzLnB1c2godGhpcy5lbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkltZ0xhenlMb2FkLnJlc2V0CiAgICAgICAgICogQHBhcmFtIGltZ3Mge1N0cmluZyB8IEFycmF5IHwgRE9NRUxlbWVudH0g5paw55qE6ZyA6KaB5Yqg6L2955qEaW1nIOWmguaenOWIneWni+WMluaXtuS8oOWFpeeahOaYr2VsIOWImeatpOaXtuS4jemcgOimgeWPguaVsHIKICAgICAgICAgKiBAZGVzYyDph43nva7liqDovb0KICAgICAgICAgKi8KICAgICAgICByZXNldDogZnVuY3Rpb24oaW1ncykgewogICAgICAgICAgICB0aGlzLnNldERvbXMoaW1ncyk7CiAgICAgICAgICAgIHRoaXMuY2hlY2soKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkltZ0xhenlMb2FkLmNoZWNrCiAgICAgICAgICogQGRlc2Mg5p+l55yL5b2T5YmN5piv5ZCm56ym5ZCI5Yqg6L295p2h5Lu2CiAgICAgICAgICovCiAgICAgICAgY2hlY2s6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmlzU2Nyb2xsID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBsZW4gPSB0aGlzLmltZ3MubGVuZ3RoOwogICAgICAgICAgICBpZihsZW4gPT0gMCkgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIHZhciB0ID0gdGhpcy5jb250YWluZXIuc2Nyb2xsVG9wLAogICAgICAgICAgICAgICAgaCA9IG8uZG9tLmdldEhlaWdodCh0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgICAgIGlmKHRoaXMuY29udGFpbmVyID09IGRvY3VtZW50LmJvZHkpIHsKICAgICAgICAgICAgICAgIHZhciBfaCA9IG8uZG9tLmdldFNjcmVlbkhlaWdodCgpOwogICAgICAgICAgICAgICAgaCA+IF9oICYmIChoID0gX2gpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpID0gbGVuOwogICAgICAgICAgICBmb3IoOyBpLS07ICkgewogICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLmltZ3NbaV07CiAgICAgICAgICAgICAgICBpZihvLmRvbS5kYXRhKGl0ZW0sICJsb2FkZWQiKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW1ncy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrSW1nKGl0ZW0sIHQsIGgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjaGVja0ltZwogICAgICAgICAqLwogICAgICAgIGNoZWNrSW1nOiBmdW5jdGlvbihpdGVtLCB0LCBoKSB7CiAgICAgICAgICAgIHZhciB1ID0gby51dGlsOwogICAgICAgICAgICBpZighdS5pc05vZGUoaXRlbSkpIHJldHVybjsKICAgICAgICAgICAgdmFyIGQgPSBvLmRvbSwKICAgICAgICAgICAgICAgIGxvYWRlZCA9IGQuZGF0YShpdGVtLCAibG9hZGVkIiksCiAgICAgICAgICAgICAgICBzcmMgPSBkLmRhdGEoaXRlbSwgdGhpcy5zcmNOYW1lKTsKICAgICAgICAgICAgaWYobG9hZGVkKSAgcmV0dXJuOwogICAgICAgICAgICB2YXIgcG9zID0gZC5nZXRQb3NpdGlvbihpdGVtKSwKICAgICAgICAgICAgICAgIGhlaWdodCA9IGQuZ2V0SGVpZ2h0KGl0ZW0pLAogICAgICAgICAgICAgICAgdG9wID0gcG9zLnRvcDsKICAgICAgICAgICAgaWYodCA+PSB0b3AgLSBoICYmIHQgPD0gdG9wICsgaGVpZ2h0ICsgaCkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgdS5sb2FkSW1hZ2Uoc3JjLCB1LmVtcHR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0Lm5vdGlmeSgiaW1nbGF6eWxvYWQtY29yZS1sb2FkaW1nc3VjY2VzcyIsIGl0ZW0pOwogICAgICAgICAgICAgICAgICAgIGQuYXR0cihpdGVtLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogc3JjLAogICAgICAgICAgICAgICAgICAgICAgICAiZGF0YS1sb2FkZWQiOiAibG9hZGVkIgogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRoYXQubm90aWZ5KCJpbWdsYXp5bG9hZC1jb3JlLWxvYWRpbWdmYWlsZSIsIGl0ZW0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bln7rnoYDlupPmlofku7YKICogcHJvbWlzZemDqOWIhgogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQGF1dGhvciB3ZW5jaGVuZwogKiBAdmVyc2lvbiAxLjEKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiCgogICAgaWYgKHR5cGVvZiB3aW5kb3cuUHJvbWlzZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2Ygd2luZG93LlByb21pc2UucmVzb2x2ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBvLlByb21pc2UgPSB3aW5kb3cuUHJvbWlzZTsKICAgIH0KCiAgICB2YXIgU1RBVEVTID0gewogICAgICAgIFBFTkRJTkc6IDAsCiAgICAgICAgUkVTT0xWRUQ6IDEsCiAgICAgICAgUkVKRUNURUQ6IDIKICAgIH0KCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLlByb21pc2UKICAgICAqIEBkZXNjIOi3n2VzNueahOaWsFByb21pc2Xop4TojIPlrozlhajkuIDoh7QKICAgICAqLwogICAgdmFyIFByb21pc2UgPSBvLlByb21pc2UgPSBvLmRlZmluZSh7CgogICAgICAgIHN0YXRlOiBTVEFURVMuUEVORElORywKICAgICAgICByZXNvbHZlczogbnVsbCwKICAgICAgICByZWplY3RzOiBudWxsLAogICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgcmVhc29uOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvciBvY3RvcHVzLlByb21pc2UKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIC0g5Yid5aeL5YyW5Ye95pWw77yM5pyJcmVzb2x2ZSwgcmVqZWN05Lik5Liq5Ye95pWwCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oZnVuYykgewogICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLnN0YXRlID0gU1RBVEVTLlBFTkRJTkc7CiAgICAgICAgICAgIHZhciByZXNvbHZlcyA9IHRoaXMucmVzb2x2ZXMgPSBbXTsKICAgICAgICAgICAgdmFyIHJlamVjdHMgPSB0aGlzLnJlamVjdHMgPSBbXTsKCiAgICAgICAgICAgIC8vIEF0IGZpcnN0IGNoYW5nZSBwcm9taXNlIHN0YXRlIGFmdGVyIHJlc29sdmV8cmVqZWN0CiAgICAgICAgICAgIHRoaXMuX2RvbmUoZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgdGhpcy5kYXRhID0gZGF0YTsKICAgICAgICAgICAgICAgIHByb21pc2Uuc3RhdGUgPSBTVEFURVMuUkVTT0xWRUQ7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9mYWlsKGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgICAgICAgdGhpcy5yZWFzb24gPSByZWFzb247CiAgICAgICAgICAgICAgICBwcm9taXNlLnN0YXRlID0gU1RBVEVTLlJFSkVDVEVEOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZ1bmMuY2FsbCh0aGlzLCBQcm9taXNlLm1ha2VSZXNvbHZlKHRoaXMpLCBQcm9taXNlLm1ha2VSZWplY3QodGhpcykpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiB0aGVuIOa3u+WKoOWbnuiwg+WHveaVsAogICAgICAgICAqIEBwYXJhbSAge0Z1bmN0aW9ufSBkb25lQ2FsbGJhY2sgLSDmiJDlip/lm57osIPlh73mlbAKICAgICAgICAgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZmFpbENhbGxiYWNrIC0g5aSx6LSl5Zue6LCD5Ye95pWwCiAgICAgICAgICogQHJldHVybiB7UHJvbWlzZX0g6L+U5Zue5LiA5Liq5paw55qEUHJvbWlzZeWunuS+iwogICAgICAgICAqLwogICAgICAgIHRoZW46IGZ1bmN0aW9uKGRvbmVDYWxsYmFjaywgZmFpbENhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBwcm9taXNlID0gdGhpczsKCiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgIGlmIChkb25lQ2FsbGJhY2sgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBtb2RpZmllZERvbmVDYWxsYmFjayA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAvLyDov5Tlm57lgLxudWxs566X5LiN566XCiAgICAgICAgICAgICAgICAgICAgdmFyIHJldHVyblZhbCA9IGRvbmVDYWxsYmFjay5jYWxsKHRoaXMsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgIGlmIChQcm9taXNlLmlzUHJvbWlzZShyZXR1cm5WYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblZhbC50aGVuKHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByb21pc2UuX2RvbmUobW9kaWZpZWREb25lQ2FsbGJhY2spOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwcm9taXNlLl9kb25lKHJlc29sdmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJvbWlzZS5fZmFpbChmYWlsQ2FsbGJhY2sgPT0gbnVsbCA/IHJlamVjdCA6IGZhaWxDYWxsYmFjayk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogY2F0Y2gg5o2V5o2J6ZSZ6K+v77yM5Y+v5Lul5o2V5o2J5YmN6Z2iUHJvbWlzZemYn+WIl+acquiiq+aNleaNieeahOmUmeivrwogICAgICAgICAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmYWlsQ2FsbGJhY2sgLSDlpLHotKXlm57osIPlh73mlbAKICAgICAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSDmlrDnmoRQcm9taXNlCiAgICAgICAgICovCiAgICAgICAgY2F0Y2g6IGZ1bmN0aW9uKGZhaWxDYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4gdGhpcy50aGVuKG51bGwsIGZhaWxDYWxsYmFjayk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICog5YaF6YOo5re75Yqg5oiQ5Yqf5Zue6LCD77yM5aaC5p6cUHJvbWlzZeW3suaYr+aIkOWKn+eKtuaAge+8jOWImeebtOaOpeaJp+ihjOaIkOWKn+WbnuiwgwogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgX2RvbmU6IGZ1bmN0aW9uKGRvbmVDYWxsYmFjaykgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gU1RBVEVTLlJFU09MVkVEKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZUNhbGxiYWNrLmNhbGwodGhpcywgdGhpcy5kYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnJlc29sdmVzLnB1c2goZG9uZUNhbGxiYWNrKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICog5YaF6YOo5re75Yqg5aSx6LSl5Zue6LCD77yM5aaC5p6cUHJvbWlzZeW3suaYr+Wksei0peeKtuaAge+8jOWImeebtOaOpeaJp+ihjOWksei0peWbnuiwgwogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgX2ZhaWw6IGZ1bmN0aW9uKGZhaWxDYWxsYmFjaykgewogICAgICAgICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gU1RBVEVTLlJFSkVDVEVEKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFpbENhbGxiYWNrLmNhbGwodGhpcywgdGhpcy5yZWFzb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVqZWN0cy5wdXNoKGZhaWxDYWxsYmFjayk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICogUHJvbWlzZSDlj6/og73nmoTnirbmgIEKICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgKi8KICAgIFByb21pc2UuU1RBVEVTID0gU1RBVEVTOwoKICAgIC8qKgogICAgICog5Yik5pat5piv5ZCm5piv57G7UHJvbWlzZeWvueixoQogICAgICogQHBhcmFtICB7Kn0gIG9iagogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgUHJvbWlzZS5pc1Byb21pc2UgPSBmdW5jdGlvbihvYmopIHsKICAgICAgICByZXR1cm4gb2JqICE9IG51bGwgJiYgdHlwZW9mIG9ialsndGhlbiddID09PSAnZnVuY3Rpb24nOwogICAgfQoKICAgIC8qKgogICAgICog55Sf5oiQUHJvbWlzZeWunuS+i+WGheeahHJlc29sdmXmlrnms5UKICAgICAqIEBwYXJhbSAge1Byb21pc2V9IHByb21pc2UgLSBQcm9taXNl5a6e5L6LCiAgICAgKiBAcmV0dXJuIHtGdW5jdGlvbn0gcmVzb2x2ZeWHveaVsAogICAgICovCiAgICBQcm9taXNlLm1ha2VSZXNvbHZlID0gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgIGlmIChwcm9taXNlLnN0YXRlID4gU1RBVEVTLlBFTkRJTkcpIHJldHVybjsKCiAgICAgICAgICAgIHZhciByZXNvbHZlcyA9IHByb21pc2UucmVzb2x2ZXMsCiAgICAgICAgICAgICAgICBkb25lQ2FsbGJhY2s7CgogICAgICAgICAgICB3aGlsZSAoZG9uZUNhbGxiYWNrID0gcmVzb2x2ZXMuc2hpZnQoKSkgewogICAgICAgICAgICAgICAgZG9uZUNhbGxiYWNrLmNhbGwocHJvbWlzZSwgZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiDnlJ/miJBQcm9taXNl5a6e5L6L5YaF55qEcmVqZWN05pa55rOVCiAgICAgKiBAcGFyYW0gIHtQcm9taXNlfSBwcm9taXNlIC0gUHJvbWlzZeWunuS+iwogICAgICogQHJldHVybiB7RnVuY3Rpb259IHJlamVjdOWHveaVsAogICAgICovCiAgICBQcm9taXNlLm1ha2VSZWplY3QgPSBmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgICBpZiAocHJvbWlzZS5zdGF0ZSA+IFNUQVRFUy5QRU5ESU5HKSByZXR1cm47CgogICAgICAgICAgICB2YXIgcmVqZWN0cyA9IHByb21pc2UucmVqZWN0cywKICAgICAgICAgICAgICAgIGZhaWxDYWxsYmFjazsKCiAgICAgICAgICAgIHdoaWxlIChmYWlsQ2FsbGJhY2sgPSByZWplY3RzLnNoaWZ0KCkpIHsKICAgICAgICAgICAgICAgIGZhaWxDYWxsYmFjay5jYWxsKHByb21pc2UsIHJlYXNvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiDov5Tlm55Qcm9taXNl5a+56LGh77yM5LuldmFsdWXlgLzop6PlhrPjgILlpoLmnpzkvKDlhaXnmoR2YWx1ZeaYr+exu1Byb21pc2XnmoTlr7nosaHvvIzliJnlt7J2YWx1Zei/meS4qlByb21pc2UKICAgICAqIOeahOe7k+aenOS9nOS4ulByb21pc2XnmoTlhrPlrprlgLwKICAgICAqCiAgICAgKiBAcGFyYW0gIHsqfSB2YWx1ZQogICAgICogQHJldHVybiB7UHJvbWlzZX0g5paw55qEUHJvbWlzZeWvueixoQogICAgICovCiAgICBQcm9taXNlLnJlc29sdmUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgaWYgKFByb21pc2UuaXNQcm9taXNlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgdmFsdWUudGhlbihyZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KQogICAgfQoKICAgIC8qKgogICAgICog6L+U5Zue5LiA5Liq5aSx6LSl5Y6f5ZugcmVhc29u55qE5aSx6LSlUHJvbWlzZQogICAgICogQHBhcmFtICB7U3RyaW5nfSByZWFzb24gLSDlpLHotKXljp/lm6AKICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICAgIFByb21pc2UucmVqZWN0ID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICByZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIOeUn+aIkOaWsFByb21pc2UsIOaJgOaciXByb21pc2Vz5oiQ5Yqf5omN5oiQ5Yqf77yM5Y+q6KaB5pyJ5LiA5LiqcHJvbWlzZXPlpLHotKXlsLHlpLHotKUKICAgICAqIEBwYXJhbSAge0FycmF5fSBwcm9taXNlcwogICAgICogQHJldHVybiB7UHJvbWlzZX0g5paw55qEUHJvbWlzZQogICAgICovCiAgICBQcm9taXNlLmFsbCA9IGZ1bmN0aW9uKHByb21pc2VzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICBmdW5jdGlvbiBwZW5kaW5nKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB2YXIgY291bnRlciA9IDAsCiAgICAgICAgICAgICAgICAgICAgdmFsdWVzID0gW107CgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBjdXJJbmRleCA9IGNvdW50ZXI7CiAgICAgICAgICAgICAgICAgICAgY291bnRlcisrOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXNbY3VySW5kZXhdID0gZGF0YTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtLWNvdW50ZXIgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbCh3aW5kb3csIHZhbHVlcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkb25lID0gcGVuZGluZyhmdW5jdGlvbih2YWx1ZXMpIHsKICAgICAgICAgICAgICAgIHJlc29sdmUodmFsdWVzKQogICAgICAgICAgICB9KQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb21pc2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9IHByb21pc2VzW2ldOwogICAgICAgICAgICAgICAgcHJvbWlzZS50aGVuKGRvbmUoKSwgcmVqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICog6L+U5Zue5LiA5Liq5pawUHJvbWlzZSwg5aaC5p6c5pyJ5LiA5LiqcHJvbWlzZeacgOWFiOWujOaIkO+8jOWImeaWsFByb21pc2XnlKjmnIDlhYjlrozmiJDnmoTmlbDmja7lrozmiJDvvIzlpoLmnpwKICAgICAqIOacieS4gOS4qnByb21pc2XmnIDmlrDlpLHotKXvvIzliJnlt7LmnIDlhYjlpLHotKXnmoRwcm9taXNl55qE5Y6f5Zug5aSx6LSlCiAgICAgKiBAcGFyYW0gIHtBcnJheX0gcHJvbWlzZXMKICAgICAqIEByZXR1cm4ge1Byb21pc2V9IOaWsFByb21pc2UKICAgICAqLwogICAgUHJvbWlzZS5yYWNlID0gZnVuY3Rpb24ocHJvbWlzZXMpIHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvbWlzZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHByb21pc2VzW2ldLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKfSkob2N0b3B1cyk7LyoqCiAqIOebtOaOpeW8leeUqGhhbW1lcgogKi8KCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgdmFyIEhhbW1lciA9IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gbmV3IEhhbW1lci5JbnN0YW5jZShlbGVtZW50LCBvcHRpb25zIHx8IHt9KTsKICAgIH07CgogICAgSGFtbWVyLmRlZmF1bHRzID0gewogICAgICAgIC8vIGFkZCBzdHlsZXMgYW5kIGF0dHJpYnV0ZXMgdG8gdGhlIGVsZW1lbnQgdG8gcHJldmVudCB0aGUgYnJvd3NlciBmcm9tIGRvaW5nCiAgICAgICAgLy8gaXRzIG5hdGl2ZSBiZWhhdmlvci4gdGhpcyBkb2VzbnQgcHJldmVudCB0aGUgc2Nyb2xsaW5nLCBidXQgY2FuY2VscwogICAgICAgIC8vIHRoZSBjb250ZXh0bWVudSwgdGFwIGhpZ2hsaWdodGluZyBldGMKICAgICAgICAvLyBzZXQgdG8gZmFsc2UgdG8gZGlzYWJsZSB0aGlzCiAgICAgICAgc3RvcF9icm93c2VyX2JlaGF2aW9yOiB7CiAgICAgICAgICAgIC8vIHRoaXMgYWxzbyB0cmlnZ2VycyBvbnNlbGVjdHN0YXJ0PWZhbHNlIGZvciBJRQogICAgICAgICAgICB1c2VyU2VsZWN0OiAnbm9uZScsCiAgICAgICAgICAgIC8vIHRoaXMgbWFrZXMgdGhlIGVsZW1lbnQgYmxvY2tpbmcgaW4gSUUxMCA+LCB5b3UgY291bGQgZXhwZXJpbWVudCB3aXRoIHRoZSB2YWx1ZQogICAgICAgICAgICAvLyBzZWUgZm9yIG1vcmUgb3B0aW9ucyB0aGlzIGlzc3VlOyBodHRwczovL2dpdGh1Yi5jb20vRWlnaHRNZWRpYS9oYW1tZXIuanMvaXNzdWVzLzI0MQogICAgICAgICAgICB0b3VjaEFjdGlvbjogJ25vbmUnLAogICAgICAgICAgICB0b3VjaENhbGxvdXQ6ICdub25lJywKICAgICAgICAgICAgY29udGVudFpvb21pbmc6ICdub25lJywKICAgICAgICAgICAgdXNlckRyYWc6ICdub25lJywKICAgICAgICAgICAgdGFwSGlnaGxpZ2h0Q29sb3I6ICdyZ2JhKDAsMCwwLDApJwogICAgICAgIH0KCiAgICAgICAgLy8gbW9yZSBzZXR0aW5ncyBhcmUgZGVmaW5lZCBwZXIgZ2VzdHVyZSBhdCBnZXN0dXJlcy5qcwogICAgfTsKCi8vIGRldGVjdCB0b3VjaGV2ZW50cwogICAgSGFtbWVyLkhBU19QT0lOVEVSRVZFTlRTID0gbmF2aWdhdG9yLnBvaW50ZXJFbmFibGVkIHx8IG5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkOwogICAgSGFtbWVyLkhBU19UT1VDSEVWRU5UUyA9ICgnb250b3VjaHN0YXJ0JyBpbiB3aW5kb3cpOwoKLy8gZG9udCB1c2UgbW91c2VldmVudHMgb24gbW9iaWxlIGRldmljZXMKICAgIEhhbW1lci5NT0JJTEVfUkVHRVggPSAvbW9iaWxlfHRhYmxldHxpcChhZHxob25lfG9kKXxhbmRyb2lkL2k7CiAgICBIYW1tZXIuTk9fTU9VU0VFVkVOVFMgPSBIYW1tZXIuSEFTX1RPVUNIRVZFTlRTICYmIG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goSGFtbWVyLk1PQklMRV9SRUdFWCk7CgovLyBldmVudHR5cGVzIHBlciB0b3VjaGV2ZW50IChzdGFydCwgbW92ZSwgZW5kKQovLyBhcmUgZmlsbGVkIGJ5IEhhbW1lci5ldmVudC5kZXRlcm1pbmVFdmVudFR5cGVzIG9uIHNldHVwCiAgICBIYW1tZXIuRVZFTlRfVFlQRVMgPSB7fTsKCi8vIGRpcmVjdGlvbiBkZWZpbmVzCiAgICBIYW1tZXIuRElSRUNUSU9OX0RPV04gPSAnZG93bic7CiAgICBIYW1tZXIuRElSRUNUSU9OX0xFRlQgPSAnbGVmdCc7CiAgICBIYW1tZXIuRElSRUNUSU9OX1VQID0gJ3VwJzsKICAgIEhhbW1lci5ESVJFQ1RJT05fUklHSFQgPSAncmlnaHQnOwoKLy8gcG9pbnRlciB0eXBlCiAgICBIYW1tZXIuUE9JTlRFUl9NT1VTRSA9ICdtb3VzZSc7CiAgICBIYW1tZXIuUE9JTlRFUl9UT1VDSCA9ICd0b3VjaCc7CiAgICBIYW1tZXIuUE9JTlRFUl9QRU4gPSAncGVuJzsKCi8vIHRvdWNoIGV2ZW50IGRlZmluZXMKICAgIEhhbW1lci5FVkVOVF9TVEFSVCA9ICdzdGFydCc7CiAgICBIYW1tZXIuRVZFTlRfTU9WRSA9ICdtb3ZlJzsKICAgIEhhbW1lci5FVkVOVF9FTkQgPSAnZW5kJzsKCi8vIGhhbW1lciBkb2N1bWVudCB3aGVyZSB0aGUgYmFzZSBldmVudHMgYXJlIGFkZGVkIGF0CiAgICBIYW1tZXIuRE9DVU1FTlQgPSBkb2N1bWVudDsKCi8vIHBsdWdpbnMgbmFtZXNwYWNlCiAgICBIYW1tZXIucGx1Z2lucyA9IHt9OwoKLy8gaWYgdGhlIHdpbmRvdyBldmVudHMgYXJlIHNldC4uLgogICAgSGFtbWVyLlJFQURZID0gZmFsc2U7CgogICAgLyoqCiAgICAgKiBzZXR1cCBldmVudHMgdG8gZGV0ZWN0IGdlc3R1cmVzIG9uIHRoZSBkb2N1bWVudAogICAgICovCiAgICBmdW5jdGlvbiBzZXR1cCgpIHsKICAgICAgICBpZihIYW1tZXIuUkVBRFkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gZmluZCB3aGF0IGV2ZW50dHlwZXMgd2UgYWRkIGxpc3RlbmVycyB0bwogICAgICAgIEhhbW1lci5ldmVudC5kZXRlcm1pbmVFdmVudFR5cGVzKCk7CgogICAgICAgIC8vIFJlZ2lzdGVyIGFsbCBnZXN0dXJlcyBpbnNpZGUgSGFtbWVyLmdlc3R1cmVzCiAgICAgICAgZm9yKHZhciBuYW1lIGluIEhhbW1lci5nZXN0dXJlcykgewogICAgICAgICAgICBpZihIYW1tZXIuZ2VzdHVyZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgIEhhbW1lci5kZXRlY3Rpb24ucmVnaXN0ZXIoSGFtbWVyLmdlc3R1cmVzW25hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQWRkIHRvdWNoIGV2ZW50cyBvbiB0aGUgZG9jdW1lbnQKICAgICAgICBIYW1tZXIuZXZlbnQub25Ub3VjaChIYW1tZXIuRE9DVU1FTlQsIEhhbW1lci5FVkVOVF9NT1ZFLCBIYW1tZXIuZGV0ZWN0aW9uLmRldGVjdCk7CiAgICAgICAgSGFtbWVyLmV2ZW50Lm9uVG91Y2goSGFtbWVyLkRPQ1VNRU5ULCBIYW1tZXIuRVZFTlRfRU5ELCBIYW1tZXIuZGV0ZWN0aW9uLmRldGVjdCk7CgogICAgICAgIC8vIEhhbW1lciBpcyByZWFkeS4uLiEKICAgICAgICBIYW1tZXIuUkVBRFkgPSB0cnVlOwogICAgfQoKICAgIEhhbW1lci5JbnN0YW5jZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIC8vIHNldHVwIEhhbW1lckpTIHdpbmRvdyBldmVudHMgYW5kIHJlZ2lzdGVyIGFsbCBnZXN0dXJlcwogICAgICAgIC8vIHRoaXMgYWxzbyBzZXRzIHVwIHRoZSBkZWZhdWx0IG9wdGlvbnMKICAgICAgICBzZXR1cCgpOwoKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwoKICAgICAgICAvLyBzdGFydC9zdG9wIGRldGVjdGlvbiBvcHRpb24KICAgICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwoKICAgICAgICAvLyBtZXJnZSBvcHRpb25zCiAgICAgICAgdGhpcy5vcHRpb25zID0gSGFtbWVyLnV0aWxzLmV4dGVuZCgKICAgICAgICAgICAgSGFtbWVyLnV0aWxzLmV4dGVuZCh7fSwgSGFtbWVyLmRlZmF1bHRzKSwKICAgICAgICAgICAgb3B0aW9ucyB8fCB7fSk7CgogICAgICAgIC8vIGFkZCBzb21lIGNzcyB0byB0aGUgZWxlbWVudCB0byBwcmV2ZW50IHRoZSBicm93c2VyIGZyb20gZG9pbmcgaXRzIG5hdGl2ZSBiZWhhdm9pcgogICAgICAgIGlmKHRoaXMub3B0aW9ucy5zdG9wX2Jyb3dzZXJfYmVoYXZpb3IpIHsKICAgICAgICAgICAgSGFtbWVyLnV0aWxzLnN0b3BEZWZhdWx0QnJvd3NlckJlaGF2aW9yKHRoaXMuZWxlbWVudCwgdGhpcy5vcHRpb25zLnN0b3BfYnJvd3Nlcl9iZWhhdmlvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBzdGFydCBkZXRlY3Rpb24gb24gdG91Y2hzdGFydAogICAgICAgIEhhbW1lci5ldmVudC5vblRvdWNoKGVsZW1lbnQsIEhhbW1lci5FVkVOVF9TVEFSVCwgZnVuY3Rpb24oZXYpIHsKICAgICAgICAgICAgaWYoc2VsZi5lbmFibGVkKSB7CiAgICAgICAgICAgICAgICBIYW1tZXIuZGV0ZWN0aW9uLnN0YXJ0RGV0ZWN0KHNlbGYsIGV2KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyByZXR1cm4gaW5zdGFuY2UKICAgICAgICByZXR1cm4gdGhpczsKICAgIH07CgoKICAgIEhhbW1lci5JbnN0YW5jZS5wcm90b3R5cGUgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogYmluZCBldmVudHMgdG8gdGhlIGluc3RhbmNlCiAgICAgICAgICogQHBhcmFtICAge1N0cmluZ30gICAgICBnZXN0dXJlCiAgICAgICAgICogQHBhcmFtICAge0Z1bmN0aW9ufSAgICBoYW5kbGVyCiAgICAgICAgICogQHJldHVybnMge0hhbW1lci5JbnN0YW5jZX0KICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24gb25FdmVudChnZXN0dXJlLCBoYW5kbGVyKXsKICAgICAgICAgICAgdmFyIGdlc3R1cmVzID0gZ2VzdHVyZS5zcGxpdCgnICcpOwogICAgICAgICAgICBmb3IodmFyIHQ9MDsgdDxnZXN0dXJlcy5sZW5ndGg7IHQrKykgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZ2VzdHVyZXNbdF0sIGhhbmRsZXIsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogdW5iaW5kIGV2ZW50cyB0byB0aGUgaW5zdGFuY2UKICAgICAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgIGdlc3R1cmUKICAgICAgICAgKiBAcGFyYW0gICB7RnVuY3Rpb259ICAgIGhhbmRsZXIKICAgICAgICAgKiBAcmV0dXJucyB7SGFtbWVyLkluc3RhbmNlfQogICAgICAgICAqLwogICAgICAgIG9mZjogZnVuY3Rpb24gb2ZmRXZlbnQoZ2VzdHVyZSwgaGFuZGxlcil7CiAgICAgICAgICAgIHZhciBnZXN0dXJlcyA9IGdlc3R1cmUuc3BsaXQoJyAnKTsKICAgICAgICAgICAgZm9yKHZhciB0PTA7IHQ8Z2VzdHVyZXMubGVuZ3RoOyB0KyspIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKGdlc3R1cmVzW3RdLCBoYW5kbGVyLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIHRyaWdnZXIgZ2VzdHVyZSBldmVudAogICAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgZ2VzdHVyZQogICAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgICAgZXZlbnREYXRhCiAgICAgICAgICogQHJldHVybnMge0hhbW1lci5JbnN0YW5jZX0KICAgICAgICAgKi8KICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiB0cmlnZ2VyRXZlbnQoZ2VzdHVyZSwgZXZlbnREYXRhKXsKICAgICAgICAgICAgLy8gY3JlYXRlIERPTSBldmVudAogICAgICAgICAgICB2YXIgZXZlbnQgPSBIYW1tZXIuRE9DVU1FTlQuY3JlYXRlRXZlbnQoJ0V2ZW50Jyk7CiAgICAgICAgICAgIGV2ZW50LmluaXRFdmVudChnZXN0dXJlLCB0cnVlLCB0cnVlKTsKICAgICAgICAgICAgZXZlbnQuZ2VzdHVyZSA9IGV2ZW50RGF0YTsKCiAgICAgICAgICAgIC8vIHRyaWdnZXIgb24gdGhlIHRhcmdldCBpZiBpdCBpcyBpbiB0aGUgaW5zdGFuY2UgZWxlbWVudCwKICAgICAgICAgICAgLy8gdGhpcyBpcyBmb3IgZXZlbnQgZGVsZWdhdGlvbiB0cmlja3MKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CiAgICAgICAgICAgIGlmKEhhbW1lci51dGlscy5oYXNQYXJlbnQoZXZlbnREYXRhLnRhcmdldCwgZWxlbWVudCkpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBldmVudERhdGEudGFyZ2V0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogZW5hYmxlIG9mIGRpc2FibGUgaGFtbWVyLmpzIGRldGVjdGlvbgogICAgICAgICAqIEBwYXJhbSAgIHtCb29sZWFufSAgIHN0YXRlCiAgICAgICAgICogQHJldHVybnMge0hhbW1lci5JbnN0YW5jZX0KICAgICAgICAgKi8KICAgICAgICBlbmFibGU6IGZ1bmN0aW9uIGVuYWJsZShzdGF0ZSkgewogICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSBzdGF0ZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIHRoaXMgaG9sZHMgdGhlIGxhc3QgbW92ZSBldmVudCwKICAgICAqIHVzZWQgdG8gZml4IGVtcHR5IHRvdWNoZW5kIGlzc3VlCiAgICAgKiBzZWUgdGhlIG9uVG91Y2ggZXZlbnQgZm9yIGFuIGV4cGxhbmF0aW9uCiAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICovCiAgICB2YXIgbGFzdF9tb3ZlX2V2ZW50ID0gbnVsbDsKCgogICAgLyoqCiAgICAgKiB3aGVuIHRoZSBtb3VzZSBpcyBob2xkIGRvd24sIHRoaXMgaXMgdHJ1ZQogICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgKi8KICAgIHZhciBlbmFibGVfZGV0ZWN0ID0gZmFsc2U7CgoKICAgIC8qKgogICAgICogd2hlbiB0b3VjaCBldmVudHMgaGF2ZSBiZWVuIGZpcmVkLCB0aGlzIGlzIHRydWUKICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICovCiAgICB2YXIgdG91Y2hfdHJpZ2dlcmVkID0gZmFsc2U7CgoKICAgIEhhbW1lci5ldmVudCA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBzaW1wbGUgYWRkRXZlbnRMaXN0ZW5lcgogICAgICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBlbGVtZW50CiAgICAgICAgICogQHBhcmFtICAge1N0cmluZ30gICAgICAgIHR5cGUKICAgICAgICAgKiBAcGFyYW0gICB7RnVuY3Rpb259ICAgICAgaGFuZGxlcgogICAgICAgICAqLwogICAgICAgIGJpbmREb206IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGhhbmRsZXIpIHsKICAgICAgICAgICAgdmFyIHR5cGVzID0gdHlwZS5zcGxpdCgnICcpOwogICAgICAgICAgICBmb3IodmFyIHQ9MDsgdDx0eXBlcy5sZW5ndGg7IHQrKykgewogICAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHR5cGVzW3RdLCBoYW5kbGVyLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogdG91Y2ggZXZlbnRzIHdpdGggbW91c2UgZmFsbGJhY2sKICAgICAgICAgKiBAcGFyYW0gICB7SFRNTEVsZW1lbnR9ICAgZWxlbWVudAogICAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgICBldmVudFR5cGUgICAgICAgIGxpa2UgSGFtbWVyLkVWRU5UX01PVkUKICAgICAgICAgKiBAcGFyYW0gICB7RnVuY3Rpb259ICAgICAgaGFuZGxlcgogICAgICAgICAqLwogICAgICAgIG9uVG91Y2g6IGZ1bmN0aW9uIG9uVG91Y2goZWxlbWVudCwgZXZlbnRUeXBlLCBoYW5kbGVyKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuYmluZERvbShlbGVtZW50LCBIYW1tZXIuRVZFTlRfVFlQRVNbZXZlbnRUeXBlXSwgZnVuY3Rpb24gYmluZERvbU9uVG91Y2goZXYpIHsKICAgICAgICAgICAgICAgIHZhciBzb3VyY2VFdmVudFR5cGUgPSBldi50eXBlLnRvTG93ZXJDYXNlKCk7CgogICAgICAgICAgICAgICAgLy8gb25tb3VzZXVwLCBidXQgd2hlbiB0b3VjaGVuZCBoYXMgYmVlbiBmaXJlZCB3ZSBkbyBub3RoaW5nLgogICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBmb3IgdG91Y2hkZXZpY2VzIHdoaWNoIGFsc28gZmlyZSBhIG1vdXNldXAgb24gdG91Y2hlbmQKICAgICAgICAgICAgICAgIGlmKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvbW91c2UvKSAmJiB0b3VjaF90cmlnZ2VyZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gbW91c2VidXR0b24gbXVzdCBiZSBkb3duIG9yIGEgdG91Y2ggZXZlbnQKICAgICAgICAgICAgICAgIGVsc2UgaWYoIHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdG91Y2gvKSB8fCAgIC8vIHRvdWNoIGV2ZW50cyBhcmUgYWx3YXlzIG9uIHNjcmVlbgogICAgICAgICAgICAgICAgICAgIHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvcG9pbnRlcmRvd24vKSB8fCAvLyBwb2ludGVyZXZlbnRzIHRvdWNoCiAgICAgICAgICAgICAgICAgICAgKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvbW91c2UvKSAmJiBldi53aGljaCA9PT0gMSkgICAvLyBtb3VzZSBpcyBwcmVzc2VkCiAgICAgICAgICAgICAgICAgICAgKXsKICAgICAgICAgICAgICAgICAgICBlbmFibGVfZGV0ZWN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgaW4gYSB0b3VjaCBldmVudCwgc2V0IHRoZSB0b3VjaCB0cmlnZ2VyZWQgYm9vbCB0byB0cnVlLAogICAgICAgICAgICAgICAgLy8gdGhpcyBmb3IgdGhlIGNvbmZsaWN0cyB0aGF0IG1heSBvY2N1ciBvbiBpb3MgYW5kIGFuZHJvaWQKICAgICAgICAgICAgICAgIGlmKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdG91Y2h8cG9pbnRlci8pKSB7CiAgICAgICAgICAgICAgICAgICAgdG91Y2hfdHJpZ2dlcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBjb3VudCB0aGUgdG90YWwgdG91Y2hlcyBvbiB0aGUgc2NyZWVuCiAgICAgICAgICAgICAgICB2YXIgY291bnRfdG91Y2hlcyA9IDA7CgogICAgICAgICAgICAgICAgLy8gd2hlbiB0b3VjaCBoYXMgYmVlbiB0cmlnZ2VyZWQgaW4gdGhpcyBkZXRlY3Rpb24gc2Vzc2lvbgogICAgICAgICAgICAgICAgLy8gYW5kIHdlIGFyZSBub3cgaGFuZGxpbmcgYSBtb3VzZSBldmVudCwgd2Ugc3RvcCB0aGF0IHRvIHByZXZlbnQgY29uZmxpY3RzCiAgICAgICAgICAgICAgICBpZihlbmFibGVfZGV0ZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdXBkYXRlIHBvaW50ZXJldmVudAogICAgICAgICAgICAgICAgICAgIGlmKEhhbW1lci5IQVNfUE9JTlRFUkVWRU5UUyAmJiBldmVudFR5cGUgIT0gSGFtbWVyLkVWRU5UX0VORCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb3VudF90b3VjaGVzID0gSGFtbWVyLlBvaW50ZXJFdmVudC51cGRhdGVQb2ludGVyKGV2ZW50VHlwZSwgZXYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyB0b3VjaAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYoc291cmNlRXZlbnRUeXBlLm1hdGNoKC90b3VjaC8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50X3RvdWNoZXMgPSBldi50b3VjaGVzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gbW91c2UKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmKCF0b3VjaF90cmlnZ2VyZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY291bnRfdG91Y2hlcyA9IHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdXAvKSA/IDAgOiAxOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgd2UgYXJlIGluIGEgZW5kIGV2ZW50LCBidXQgd2hlbiB3ZSByZW1vdmUgb25lIHRvdWNoIGFuZAogICAgICAgICAgICAgICAgICAgIC8vIHdlIHN0aWxsIGhhdmUgZW5vdWdoLCBzZXQgZXZlbnRUeXBlIHRvIG1vdmUKICAgICAgICAgICAgICAgICAgICBpZihjb3VudF90b3VjaGVzID4gMCAmJiBldmVudFR5cGUgPT0gSGFtbWVyLkVWRU5UX0VORCkgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudFR5cGUgPSBIYW1tZXIuRVZFTlRfTU9WRTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gbm8gdG91Y2hlcywgZm9yY2UgdGhlIGVuZCBldmVudAogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYoIWNvdW50X3RvdWNoZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRUeXBlID0gSGFtbWVyLkVWRU5UX0VORDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgdG91Y2hlbmQgaGFzIG5vIHRvdWNoZXMsIGFuZCB3ZSBvZnRlbiB3YW50IHRvIHVzZSB0aGVzZSBpbiBvdXIgZ2VzdHVyZXMsCiAgICAgICAgICAgICAgICAgICAgLy8gd2Ugc2VuZCB0aGUgbGFzdCBtb3ZlIGV2ZW50IGFzIG91ciBldmVudERhdGEgaW4gdG91Y2hlbmQKICAgICAgICAgICAgICAgICAgICBpZighY291bnRfdG91Y2hlcyAmJiBsYXN0X21vdmVfZXZlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXYgPSBsYXN0X21vdmVfZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIHN0b3JlIHRoZSBsYXN0IG1vdmUgZXZlbnQKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9tb3ZlX2V2ZW50ID0gZXY7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyB0cmlnZ2VyIHRoZSBoYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5jYWxsKEhhbW1lci5kZXRlY3Rpb24sIHNlbGYuY29sbGVjdEV2ZW50RGF0YShlbGVtZW50LCBldmVudFR5cGUsIGV2KSk7CgogICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBwb2ludGVyZXZlbnQgZnJvbSBsaXN0CiAgICAgICAgICAgICAgICAgICAgaWYoSGFtbWVyLkhBU19QT0lOVEVSRVZFTlRTICYmIGV2ZW50VHlwZSA9PSBIYW1tZXIuRVZFTlRfRU5EKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50X3RvdWNoZXMgPSBIYW1tZXIuUG9pbnRlckV2ZW50LnVwZGF0ZVBvaW50ZXIoZXZlbnRUeXBlLCBldik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vZGVidWcoc291cmNlRXZlbnRUeXBlICsiICIrIGV2ZW50VHlwZSk7CgogICAgICAgICAgICAgICAgLy8gb24gdGhlIGVuZCB3ZSByZXNldCBldmVyeXRoaW5nCiAgICAgICAgICAgICAgICBpZighY291bnRfdG91Y2hlcykgewogICAgICAgICAgICAgICAgICAgIGxhc3RfbW92ZV9ldmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgZW5hYmxlX2RldGVjdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRvdWNoX3RyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIEhhbW1lci5Qb2ludGVyRXZlbnQucmVzZXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIHdlIGhhdmUgZGlmZmVyZW50IGV2ZW50cyBmb3IgZWFjaCBkZXZpY2UvYnJvd3NlcgogICAgICAgICAqIGRldGVybWluZSB3aGF0IHdlIG5lZWQgYW5kIHNldCB0aGVtIGluIHRoZSBIYW1tZXIuRVZFTlRfVFlQRVMgY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBkZXRlcm1pbmVFdmVudFR5cGVzOiBmdW5jdGlvbiBkZXRlcm1pbmVFdmVudFR5cGVzKCkgewogICAgICAgICAgICAvLyBkZXRlcm1pbmUgdGhlIGV2ZW50dHlwZSB3ZSB3YW50IHRvIHNldAogICAgICAgICAgICB2YXIgdHlwZXM7CgogICAgICAgICAgICAvLyBwb2ludGVyRXZlbnRzIG1hZ2ljCiAgICAgICAgICAgIGlmKEhhbW1lci5IQVNfUE9JTlRFUkVWRU5UUykgewogICAgICAgICAgICAgICAgdHlwZXMgPSBIYW1tZXIuUG9pbnRlckV2ZW50LmdldEV2ZW50cygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG9uIEFuZHJvaWQsIGlPUywgYmxhY2tiZXJyeSwgd2luZG93cyBtb2JpbGUgd2UgZG9udCB3YW50IGFueSBtb3VzZWV2ZW50cwogICAgICAgICAgICBlbHNlIGlmKEhhbW1lci5OT19NT1VTRUVWRU5UUykgewogICAgICAgICAgICAgICAgdHlwZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgJ3RvdWNoc3RhcnQnLAogICAgICAgICAgICAgICAgICAgICd0b3VjaG1vdmUnLAogICAgICAgICAgICAgICAgICAgICd0b3VjaGVuZCB0b3VjaGNhbmNlbCddOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGZvciBub24gcG9pbnRlciBldmVudHMgYnJvd3NlcnMgYW5kIG1peGVkIGJyb3dzZXJzLAogICAgICAgICAgICAvLyBsaWtlIGNocm9tZSBvbiB3aW5kb3dzOCB0b3VjaCBsYXB0b3AKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0eXBlcyA9IFsKICAgICAgICAgICAgICAgICAgICAndG91Y2hzdGFydCBtb3VzZWRvd24nLAogICAgICAgICAgICAgICAgICAgICd0b3VjaG1vdmUgbW91c2Vtb3ZlJywKICAgICAgICAgICAgICAgICAgICAndG91Y2hlbmQgdG91Y2hjYW5jZWwgbW91c2V1cCddOwogICAgICAgICAgICB9CgogICAgICAgICAgICBIYW1tZXIuRVZFTlRfVFlQRVNbSGFtbWVyLkVWRU5UX1NUQVJUXSAgPSB0eXBlc1swXTsKICAgICAgICAgICAgSGFtbWVyLkVWRU5UX1RZUEVTW0hhbW1lci5FVkVOVF9NT1ZFXSAgID0gdHlwZXNbMV07CiAgICAgICAgICAgIEhhbW1lci5FVkVOVF9UWVBFU1tIYW1tZXIuRVZFTlRfRU5EXSAgICA9IHR5cGVzWzJdOwogICAgICAgIH0sCgoKICAgICAgICAvKioKICAgICAgICAgKiBjcmVhdGUgdG91Y2hsaXN0IGRlcGVuZGluZyBvbiB0aGUgZXZlbnQKICAgICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICBldgogICAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgIGV2ZW50VHlwZSAgIHVzZWQgYnkgdGhlIGZha2VtdWx0aXRvdWNoIHBsdWdpbgogICAgICAgICAqLwogICAgICAgIGdldFRvdWNoTGlzdDogZnVuY3Rpb24gZ2V0VG91Y2hMaXN0KGV2LyosIGV2ZW50VHlwZSovKSB7CiAgICAgICAgICAgIC8vIGdldCB0aGUgZmFrZSBwb2ludGVyRXZlbnQgdG91Y2hsaXN0CiAgICAgICAgICAgIGlmKEhhbW1lci5IQVNfUE9JTlRFUkVWRU5UUykgewogICAgICAgICAgICAgICAgcmV0dXJuIEhhbW1lci5Qb2ludGVyRXZlbnQuZ2V0VG91Y2hMaXN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gZ2V0IHRoZSB0b3VjaGxpc3QKICAgICAgICAgICAgZWxzZSBpZihldi50b3VjaGVzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXYudG91Y2hlczsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBtYWtlIGZha2UgdG91Y2hsaXN0IGZyb20gbW91c2UgcG9zaXRpb24KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gW3sKICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyOiAxLAogICAgICAgICAgICAgICAgICAgIHBhZ2VYOiBldi5wYWdlWCwKICAgICAgICAgICAgICAgICAgICBwYWdlWTogZXYucGFnZVksCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBldi50YXJnZXQKICAgICAgICAgICAgICAgIH1dOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIGNvbGxlY3QgZXZlbnQgZGF0YSBmb3IgSGFtbWVyIGpzCiAgICAgICAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgIGVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgICAgZXZlbnRUeXBlICAgICAgICBsaWtlIEhhbW1lci5FVkVOVF9NT1ZFCiAgICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgICAgIGV2ZW50RGF0YQogICAgICAgICAqLwogICAgICAgIGNvbGxlY3RFdmVudERhdGE6IGZ1bmN0aW9uIGNvbGxlY3RFdmVudERhdGEoZWxlbWVudCwgZXZlbnRUeXBlLCBldikgewogICAgICAgICAgICB2YXIgdG91Y2hlcyA9IHRoaXMuZ2V0VG91Y2hMaXN0KGV2LCBldmVudFR5cGUpOwoKICAgICAgICAgICAgLy8gZmluZCBvdXQgcG9pbnRlclR5cGUKICAgICAgICAgICAgdmFyIHBvaW50ZXJUeXBlID0gSGFtbWVyLlBPSU5URVJfVE9VQ0g7CiAgICAgICAgICAgIGlmKGV2LnR5cGUubWF0Y2goL21vdXNlLykgfHwgSGFtbWVyLlBvaW50ZXJFdmVudC5tYXRjaFR5cGUoSGFtbWVyLlBPSU5URVJfTU9VU0UsIGV2KSkgewogICAgICAgICAgICAgICAgcG9pbnRlclR5cGUgPSBIYW1tZXIuUE9JTlRFUl9NT1VTRTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGNlbnRlciAgICAgIDogby51dGlsLmdldENlbnRlcih0b3VjaGVzKSwKICAgICAgICAgICAgICAgIHRpbWVTdGFtcCAgIDogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICB0YXJnZXQgICAgICA6IGV2LnRhcmdldCwKICAgICAgICAgICAgICAgIHRvdWNoZXMgICAgIDogdG91Y2hlcywKICAgICAgICAgICAgICAgIGV2ZW50VHlwZSAgIDogZXZlbnRUeXBlLAogICAgICAgICAgICAgICAgcG9pbnRlclR5cGUgOiBwb2ludGVyVHlwZSwKICAgICAgICAgICAgICAgIHNyY0V2ZW50ICAgIDogZXYsCgoKICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNyY0V2ZW50LnByZXZlbnRNYW5pcHVsYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcmNFdmVudC5wcmV2ZW50TWFuaXB1bGF0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3JjRXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zcmNFdmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgc3RvcERldGVjdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEhhbW1lci5kZXRlY3Rpb24uc3RvcERldGVjdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH07CgogICAgSGFtbWVyLlBvaW50ZXJFdmVudCA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBob2xkcyBhbGwgcG9pbnRlcnMKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIHBvaW50ZXJzOiB7fSwKCiAgICAgICAgLyoqCiAgICAgICAgICogZ2V0IGEgbGlzdCBvZiBwb2ludGVycwogICAgICAgICAqIEByZXR1cm5zIHtBcnJheX0gICAgIHRvdWNobGlzdAogICAgICAgICAqLwogICAgICAgIGdldFRvdWNoTGlzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgdmFyIHRvdWNobGlzdCA9IFtdOwoKICAgICAgICAgICAgLy8gd2UgY2FuIHVzZSBmb3JFYWNoIHNpbmNlIHBvaW50ZXJFdmVudHMgb25seSBpcyBpbiBJRTEwCiAgICAgICAgICAgIE9iamVjdC5rZXlzKHNlbGYucG9pbnRlcnMpLnNvcnQoKS5mb3JFYWNoKGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgICAgICB0b3VjaGxpc3QucHVzaChzZWxmLnBvaW50ZXJzW2lkXSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdG91Y2hsaXN0OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIHVwZGF0ZSB0aGUgcG9zaXRpb24gb2YgYSBwb2ludGVyCiAgICAgICAgICogQHBhcmFtICAge1N0cmluZ30gICB0eXBlICAgICAgICAgICAgIEhhbW1lci5FVkVOVF9FTkQKICAgICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgIHBvaW50ZXJFdmVudAogICAgICAgICAqLwogICAgICAgIHVwZGF0ZVBvaW50ZXI6IGZ1bmN0aW9uKHR5cGUsIHBvaW50ZXJFdmVudCkgewogICAgICAgICAgICBpZih0eXBlID09IEhhbW1lci5FVkVOVF9FTkQpIHsKICAgICAgICAgICAgICAgIHRoaXMucG9pbnRlcnMgPSB7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHBvaW50ZXJFdmVudC5pZGVudGlmaWVyID0gcG9pbnRlckV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICAgIHRoaXMucG9pbnRlcnNbcG9pbnRlckV2ZW50LnBvaW50ZXJJZF0gPSBwb2ludGVyRXZlbnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnBvaW50ZXJzKS5sZW5ndGg7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogY2hlY2sgaWYgZXYgbWF0Y2hlcyBwb2ludGVydHlwZQogICAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgICBwb2ludGVyVHlwZSAgICAgSGFtbWVyLlBPSU5URVJfTU9VU0UKICAgICAgICAgKiBAcGFyYW0gICB7UG9pbnRlckV2ZW50fSAgZXYKICAgICAgICAgKi8KICAgICAgICBtYXRjaFR5cGU6IGZ1bmN0aW9uKHBvaW50ZXJUeXBlLCBldikgewogICAgICAgICAgICBpZighZXYucG9pbnRlclR5cGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHR5cGVzID0ge307CiAgICAgICAgICAgIHR5cGVzW0hhbW1lci5QT0lOVEVSX01PVVNFXSA9IChldi5wb2ludGVyVHlwZSA9PSBldi5NU1BPSU5URVJfVFlQRV9NT1VTRSB8fCBldi5wb2ludGVyVHlwZSA9PSBIYW1tZXIuUE9JTlRFUl9NT1VTRSk7CiAgICAgICAgICAgIHR5cGVzW0hhbW1lci5QT0lOVEVSX1RPVUNIXSA9IChldi5wb2ludGVyVHlwZSA9PSBldi5NU1BPSU5URVJfVFlQRV9UT1VDSCB8fCBldi5wb2ludGVyVHlwZSA9PSBIYW1tZXIuUE9JTlRFUl9UT1VDSCk7CiAgICAgICAgICAgIHR5cGVzW0hhbW1lci5QT0lOVEVSX1BFTl0gPSAoZXYucG9pbnRlclR5cGUgPT0gZXYuTVNQT0lOVEVSX1RZUEVfUEVOIHx8IGV2LnBvaW50ZXJUeXBlID09IEhhbW1lci5QT0lOVEVSX1BFTik7CiAgICAgICAgICAgIHJldHVybiB0eXBlc1twb2ludGVyVHlwZV07CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIGdldCBldmVudHMKICAgICAgICAgKi8KICAgICAgICBnZXRFdmVudHM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgJ3BvaW50ZXJkb3duIE1TUG9pbnRlckRvd24nLAogICAgICAgICAgICAgICAgJ3BvaW50ZXJtb3ZlIE1TUG9pbnRlck1vdmUnLAogICAgICAgICAgICAgICAgJ3BvaW50ZXJ1cCBwb2ludGVyY2FuY2VsIE1TUG9pbnRlclVwIE1TUG9pbnRlckNhbmNlbCcKICAgICAgICAgICAgXTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiByZXNldCB0aGUgbGlzdAogICAgICAgICAqLwogICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5wb2ludGVycyA9IHt9OwogICAgICAgIH0KICAgIH07CgoKICAgIEhhbW1lci51dGlscyA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBleHRlbmQgbWV0aG9kLAogICAgICAgICAqIGFsc28gdXNlZCBmb3IgY2xvbmluZyB3aGVuIGRlc3QgaXMgYW4gZW1wdHkgb2JqZWN0CiAgICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgZGVzdAogICAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgIHNyYwogICAgICAgICAqIEBwYXJtCXtCb29sZWFufQltZXJnZQkJZG8gYSBtZXJnZQogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9ICAgIGRlc3QKICAgICAgICAgKi8KICAgICAgICBleHRlbmQ6IGZ1bmN0aW9uIGV4dGVuZChkZXN0LCBzcmMsIG1lcmdlKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIHsKICAgICAgICAgICAgICAgIGlmKGRlc3Rba2V5XSAhPT0gdW5kZWZpbmVkICYmIG1lcmdlKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZXN0W2tleV0gPSBzcmNba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGVzdDsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogZmluZCBpZiBhIG5vZGUgaXMgaW4gdGhlIGdpdmVuIHBhcmVudAogICAgICAgICAqIHVzZWQgZm9yIGV2ZW50IGRlbGVnYXRpb24gdHJpY2tzCiAgICAgICAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgIG5vZGUKICAgICAgICAgKiBAcGFyYW0gICB7SFRNTEVsZW1lbnR9ICAgcGFyZW50CiAgICAgICAgICogQHJldHVybnMge2Jvb2xlYW59ICAgICAgIGhhc19wYXJlbnQKICAgICAgICAgKi8KICAgICAgICBoYXNQYXJlbnQ6IGZ1bmN0aW9uKG5vZGUsIHBhcmVudCkgewogICAgICAgICAgICB3aGlsZShub2RlKXsKICAgICAgICAgICAgICAgIGlmKG5vZGUgPT0gcGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogYm9vbGVhbiBpZiB0aGUgZGlyZWN0aW9uIGlzIHZlcnRpY2FsCiAgICAgICAgICogQHBhcmFtICAgIHtTdHJpbmd9ICAgIGRpcmVjdGlvbgogICAgICAgICAqIEByZXR1cm5zICB7Qm9vbGVhbn0gICBpc192ZXJ0aWNhbAogICAgICAgICAqLwogICAgICAgIGlzVmVydGljYWw6IGZ1bmN0aW9uIGlzVmVydGljYWwoZGlyZWN0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiAoZGlyZWN0aW9uID09IEhhbW1lci5ESVJFQ1RJT05fVVAgfHwgZGlyZWN0aW9uID09IEhhbW1lci5ESVJFQ1RJT05fRE9XTik7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIHN0b3AgYnJvd3NlciBkZWZhdWx0IGJlaGF2aW9yIHdpdGggY3NzIHByb3BzCiAgICAgICAgICogQHBhcmFtICAge0h0bWxFbGVtZW50fSAgIGVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgICAgY3NzX3Byb3BzCiAgICAgICAgICovCiAgICAgICAgc3RvcERlZmF1bHRCcm93c2VyQmVoYXZpb3I6IGZ1bmN0aW9uIHN0b3BEZWZhdWx0QnJvd3NlckJlaGF2aW9yKGVsZW1lbnQsIGNzc19wcm9wcykgewogICAgICAgICAgICB2YXIgcHJvcCwKICAgICAgICAgICAgICAgIHZlbmRvcnMgPSBbJ3dlYmtpdCcsJ2todG1sJywnbW96JywnbXMnLCdvJywnJ107CgogICAgICAgICAgICBpZighY3NzX3Byb3BzIHx8ICFlbGVtZW50LnN0eWxlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHdpdGggY3NzIHByb3BlcnRpZXMgZm9yIG1vZGVybiBicm93c2VycwogICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgdmVuZG9ycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgZm9yKHZhciBwIGluIGNzc19wcm9wcykgewogICAgICAgICAgICAgICAgICAgIGlmKGNzc19wcm9wcy5oYXNPd25Qcm9wZXJ0eShwKSkgewogICAgICAgICAgICAgICAgICAgICAgICBwcm9wID0gcDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHZlbmRlciBwcmVmaXggYXQgdGhlIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHZlbmRvcnNbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3AgPSB2ZW5kb3JzW2ldICsgcHJvcC5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHByb3Auc3Vic3RyaW5nKDEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXQgdGhlIHN0eWxlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBjc3NfcHJvcHNbcF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBhbHNvIHRoZSBkaXNhYmxlIG9uc2VsZWN0c3RhcnQKICAgICAgICAgICAgaWYoY3NzX3Byb3BzLnVzZXJTZWxlY3QgPT0gJ25vbmUnKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50Lm9uc2VsZWN0c3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICBIYW1tZXIuZGV0ZWN0aW9uID0gewogICAgICAgIC8vIGNvbnRhaW5zIGFsbCByZWdpc3RyZWQgSGFtbWVyLmdlc3R1cmVzIGluIHRoZSBjb3JyZWN0IG9yZGVyCiAgICAgICAgZ2VzdHVyZXM6IFtdLAoKICAgICAgICAvLyBkYXRhIG9mIHRoZSBjdXJyZW50IEhhbW1lci5nZXN0dXJlIGRldGVjdGlvbiBzZXNzaW9uCiAgICAgICAgY3VycmVudDogbnVsbCwKCiAgICAgICAgLy8gdGhlIHByZXZpb3VzIEhhbW1lci5nZXN0dXJlIHNlc3Npb24gZGF0YQogICAgICAgIC8vIGlzIGEgZnVsbCBjbG9uZSBvZiB0aGUgcHJldmlvdXMgZ2VzdHVyZS5jdXJyZW50IG9iamVjdAogICAgICAgIHByZXZpb3VzOiBudWxsLAoKICAgICAgICAvLyB3aGVuIHRoaXMgYmVjb21lcyB0cnVlLCBubyBnZXN0dXJlcyBhcmUgZmlyZWQKICAgICAgICBzdG9wcGVkOiBmYWxzZSwKCgogICAgICAgIC8qKgogICAgICAgICAqIHN0YXJ0IEhhbW1lci5nZXN0dXJlIGRldGVjdGlvbgogICAgICAgICAqIEBwYXJhbSAgIHtIYW1tZXIuSW5zdGFuY2V9ICAgaW5zdAogICAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgICAgICAgICAgZXZlbnREYXRhCiAgICAgICAgICovCiAgICAgICAgc3RhcnREZXRlY3Q6IGZ1bmN0aW9uIHN0YXJ0RGV0ZWN0KGluc3QsIGV2ZW50RGF0YSkgewogICAgICAgICAgICAvLyBhbHJlYWR5IGJ1c3kgd2l0aCBhIEhhbW1lci5nZXN0dXJlIGRldGVjdGlvbiBvbiBhbiBlbGVtZW50CiAgICAgICAgICAgIGlmKHRoaXMuY3VycmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0b3BwZWQgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMuY3VycmVudCA9IHsKICAgICAgICAgICAgICAgIGluc3QgICAgICAgIDogaW5zdCwgLy8gcmVmZXJlbmNlIHRvIEhhbW1lckluc3RhbmNlIHdlJ3JlIHdvcmtpbmcgZm9yCiAgICAgICAgICAgICAgICBzdGFydEV2ZW50ICA6IEhhbW1lci51dGlscy5leHRlbmQoe30sIGV2ZW50RGF0YSksIC8vIHN0YXJ0IGV2ZW50RGF0YSBmb3IgZGlzdGFuY2VzLCB0aW1pbmcgZXRjCiAgICAgICAgICAgICAgICBsYXN0RXZlbnQgICA6IGZhbHNlLCAvLyBsYXN0IGV2ZW50RGF0YQogICAgICAgICAgICAgICAgbmFtZSAgICAgICAgOiAnJyAvLyBjdXJyZW50IGdlc3R1cmUgd2UncmUgaW4vZGV0ZWN0ZWQsIGNhbiBiZSAndGFwJywgJ2hvbGQnIGV0YwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5kZXRlY3QoZXZlbnREYXRhKTsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogSGFtbWVyLmdlc3R1cmUgZGV0ZWN0aW9uCiAgICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgZXZlbnREYXRhCiAgICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgZXZlbnREYXRhCiAgICAgICAgICovCiAgICAgICAgZGV0ZWN0OiBmdW5jdGlvbiBkZXRlY3QoZXZlbnREYXRhKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmN1cnJlbnQgfHwgdGhpcy5zdG9wcGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGV4dGVuZCBldmVudCBkYXRhIHdpdGggY2FsY3VsYXRpb25zIGFib3V0IHNjYWxlLCBkaXN0YW5jZSBldGMKICAgICAgICAgICAgZXZlbnREYXRhID0gdGhpcy5leHRlbmRFdmVudERhdGEoZXZlbnREYXRhKTsKCiAgICAgICAgICAgIC8vIGluc3RhbmNlIG9wdGlvbnMKICAgICAgICAgICAgdmFyIGluc3Rfb3B0aW9ucyA9IHRoaXMuY3VycmVudC5pbnN0Lm9wdGlvbnM7CgogICAgICAgICAgICAvLyBjYWxsIEhhbW1lci5nZXN0dXJlIGhhbmRsZXJzCiAgICAgICAgICAgIGZvcih2YXIgZz0wLGxlbj10aGlzLmdlc3R1cmVzLmxlbmd0aDsgZzxsZW47IGcrKykgewogICAgICAgICAgICAgICAgdmFyIGdlc3R1cmUgPSB0aGlzLmdlc3R1cmVzW2ddOwoKICAgICAgICAgICAgICAgIC8vIG9ubHkgd2hlbiB0aGUgaW5zdGFuY2Ugb3B0aW9ucyBoYXZlIGVuYWJsZWQgdGhpcyBnZXN0dXJlCiAgICAgICAgICAgICAgICBpZighdGhpcy5zdG9wcGVkICYmIGluc3Rfb3B0aW9uc1tnZXN0dXJlLm5hbWVdICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIC8vIGlmIGEgaGFuZGxlciByZXR1cm5zIGZhbHNlLCB3ZSBzdG9wIHdpdGggdGhlIGRldGVjdGlvbgogICAgICAgICAgICAgICAgICAgIGlmKGdlc3R1cmUuaGFuZGxlci5jYWxsKGdlc3R1cmUsIGV2ZW50RGF0YSwgdGhpcy5jdXJyZW50Lmluc3QpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3BEZXRlY3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBzdG9yZSBhcyBwcmV2aW91cyBldmVudCBldmVudAogICAgICAgICAgICBpZih0aGlzLmN1cnJlbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudC5sYXN0RXZlbnQgPSBldmVudERhdGE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGVuZGV2ZW50LCBidXQgbm90IHRoZSBsYXN0IHRvdWNoLCBzbyBkb250IHN0b3AKICAgICAgICAgICAgaWYoZXZlbnREYXRhLmV2ZW50VHlwZSA9PSBIYW1tZXIuRVZFTlRfRU5EICYmICFldmVudERhdGEudG91Y2hlcy5sZW5ndGgtMSkgewogICAgICAgICAgICAgICAgdGhpcy5zdG9wRGV0ZWN0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBldmVudERhdGE7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIGNsZWFyIHRoZSBIYW1tZXIuZ2VzdHVyZSB2YXJzCiAgICAgICAgICogdGhpcyBpcyBjYWxsZWQgb24gZW5kRGV0ZWN0LCBidXQgY2FuIGFsc28gYmUgdXNlZCB3aGVuIGEgZmluYWwgSGFtbWVyLmdlc3R1cmUgaGFzIGJlZW4gZGV0ZWN0ZWQKICAgICAgICAgKiB0byBzdG9wIG90aGVyIEhhbW1lci5nZXN0dXJlcyBmcm9tIGJlaW5nIGZpcmVkCiAgICAgICAgICovCiAgICAgICAgc3RvcERldGVjdDogZnVuY3Rpb24gc3RvcERldGVjdCgpIHsKICAgICAgICAgICAgLy8gY2xvbmUgY3VycmVudCBkYXRhIHRvIHRoZSBzdG9yZSBhcyB0aGUgcHJldmlvdXMgZ2VzdHVyZQogICAgICAgICAgICAvLyB1c2VkIGZvciB0aGUgZG91YmxlIHRhcCBnZXN0dXJlLCBzaW5jZSB0aGlzIGlzIGFuIG90aGVyIGdlc3R1cmUgZGV0ZWN0IHNlc3Npb24KICAgICAgICAgICAgdGhpcy5wcmV2aW91cyA9IEhhbW1lci51dGlscy5leHRlbmQoe30sIHRoaXMuY3VycmVudCk7CgogICAgICAgICAgICAvLyByZXNldCB0aGUgY3VycmVudAogICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSBudWxsOwoKICAgICAgICAgICAgLy8gc3RvcHBlZCEKICAgICAgICAgICAgdGhpcy5zdG9wcGVkID0gdHJ1ZTsKICAgICAgICB9LAoKCiAgICAgICAgLyoqCiAgICAgICAgICogZXh0ZW5kIGV2ZW50RGF0YSBmb3IgSGFtbWVyLmdlc3R1cmVzCiAgICAgICAgICogQHBhcmFtICAge09iamVjdH0gICBldgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9ICAgZXYKICAgICAgICAgKi8KICAgICAgICBleHRlbmRFdmVudERhdGE6IGZ1bmN0aW9uIGV4dGVuZEV2ZW50RGF0YShldikgewogICAgICAgICAgICB2YXIgc3RhcnRFdiA9IHRoaXMuY3VycmVudC5zdGFydEV2ZW50OwoKICAgICAgICAgICAgLy8gaWYgdGhlIHRvdWNoZXMgY2hhbmdlLCBzZXQgdGhlIG5ldyB0b3VjaGVzIG92ZXIgdGhlIHN0YXJ0RXZlbnQgdG91Y2hlcwogICAgICAgICAgICAvLyB0aGlzIGJlY2F1c2UgdG91Y2hldmVudHMgZG9uJ3QgaGF2ZSBhbGwgdGhlIHRvdWNoZXMgb24gdG91Y2hzdGFydCwgb3IgdGhlCiAgICAgICAgICAgIC8vIHVzZXIgbXVzdCBwbGFjZSBoaXMgZmluZ2VycyBhdCB0aGUgRVhBQ1Qgc2FtZSB0aW1lIG9uIHRoZSBzY3JlZW4sIHdoaWNoIGlzIG5vdCByZWFsaXN0aWMKICAgICAgICAgICAgLy8gYnV0LCBzb21ldGltZXMgaXQgaGFwcGVucyB0aGF0IGJvdGggZmluZ2VycyBhcmUgdG91Y2hpbmcgYXQgdGhlIEVYQUNUIHNhbWUgdGltZQogICAgICAgICAgICBpZihzdGFydEV2ICYmIChldi50b3VjaGVzLmxlbmd0aCAhPSBzdGFydEV2LnRvdWNoZXMubGVuZ3RoIHx8IGV2LnRvdWNoZXMgPT09IHN0YXJ0RXYudG91Y2hlcykpIHsKICAgICAgICAgICAgICAgIC8vIGV4dGVuZCAxIGxldmVsIGRlZXAgdG8gZ2V0IHRoZSB0b3VjaGxpc3Qgd2l0aCB0aGUgdG91Y2ggb2JqZWN0cwogICAgICAgICAgICAgICAgc3RhcnRFdi50b3VjaGVzID0gW107CiAgICAgICAgICAgICAgICBmb3IodmFyIGk9MCxsZW49ZXYudG91Y2hlcy5sZW5ndGg7IGk8bGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBzdGFydEV2LnRvdWNoZXMucHVzaChIYW1tZXIudXRpbHMuZXh0ZW5kKHt9LCBldi50b3VjaGVzW2ldKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkZWx0YV90aW1lID0gZXYudGltZVN0YW1wIC0gc3RhcnRFdi50aW1lU3RhbXAsCiAgICAgICAgICAgICAgICBkZWx0YV94ID0gZXYuY2VudGVyLnBhZ2VYIC0gc3RhcnRFdi5jZW50ZXIucGFnZVgsCiAgICAgICAgICAgICAgICBkZWx0YV95ID0gZXYuY2VudGVyLnBhZ2VZIC0gc3RhcnRFdi5jZW50ZXIucGFnZVksCiAgICAgICAgICAgICAgICB2ZWxvY2l0eSA9IG8udXRpbC5nZXRWZWxvY2l0eShkZWx0YV90aW1lLCBkZWx0YV94LCBkZWx0YV95KTsKCiAgICAgICAgICAgIEhhbW1lci51dGlscy5leHRlbmQoZXYsIHsKICAgICAgICAgICAgICAgIGRlbHRhVGltZSAgIDogZGVsdGFfdGltZSwKCiAgICAgICAgICAgICAgICBkZWx0YVggICAgICA6IGRlbHRhX3gsCiAgICAgICAgICAgICAgICBkZWx0YVkgICAgICA6IGRlbHRhX3ksCgogICAgICAgICAgICAgICAgdmVsb2NpdHlYICAgOiB2ZWxvY2l0eS54LAogICAgICAgICAgICAgICAgdmVsb2NpdHlZICAgOiB2ZWxvY2l0eS55LAoKICAgICAgICAgICAgICAgIGRpc3RhbmNlICAgIDogby51dGlsLmdldERpc3RhbmNlKHN0YXJ0RXYuY2VudGVyLCBldi5jZW50ZXIpLAogICAgICAgICAgICAgICAgYW5nbGUgICAgICAgOiBvLnV0aWwuZ2V0QW5nbGUoc3RhcnRFdi5jZW50ZXIsIGV2LmNlbnRlciksCiAgICAgICAgICAgICAgICBkaXJlY3Rpb24gICA6IG8udXRpbC5nZXREaXJlY3Rpb24oc3RhcnRFdi5jZW50ZXIsIGV2LmNlbnRlciksCgogICAgICAgICAgICAgICAgc2NhbGUgICAgICAgOiBvLnV0aWwuZ2V0U2NhbGUoc3RhcnRFdi50b3VjaGVzLCBldi50b3VjaGVzKSwKICAgICAgICAgICAgICAgIHJvdGF0aW9uICAgIDogby51dGlsLmdldFJvdGF0aW9uKHN0YXJ0RXYudG91Y2hlcywgZXYudG91Y2hlcyksCgogICAgICAgICAgICAgICAgc3RhcnRFdmVudCAgOiBzdGFydEV2CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIGV2OwogICAgICAgIH0sCgoKICAgICAgICAvKioKICAgICAgICAgKiByZWdpc3RlciBuZXcgZ2VzdHVyZQogICAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgIGdlc3R1cmUgb2JqZWN0LCBzZWUgZ2VzdHVyZXMuanMgZm9yIGRvY3VtZW50YXRpb24KICAgICAgICAgKiBAcmV0dXJucyB7QXJyYXl9ICAgICBnZXN0dXJlcwogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiByZWdpc3RlcihnZXN0dXJlKSB7CiAgICAgICAgICAgIC8vIGFkZCBhbiBlbmFibGUgZ2VzdHVyZSBvcHRpb25zIGlmIHRoZXJlIGlzIG5vIGdpdmVuCiAgICAgICAgICAgIHZhciBvcHRpb25zID0gZ2VzdHVyZS5kZWZhdWx0cyB8fCB7fTsKICAgICAgICAgICAgaWYob3B0aW9uc1tnZXN0dXJlLm5hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnNbZ2VzdHVyZS5uYW1lXSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGV4dGVuZCBIYW1tZXIgZGVmYXVsdCBvcHRpb25zIHdpdGggdGhlIEhhbW1lci5nZXN0dXJlIG9wdGlvbnMKICAgICAgICAgICAgSGFtbWVyLnV0aWxzLmV4dGVuZChIYW1tZXIuZGVmYXVsdHMsIG9wdGlvbnMsIHRydWUpOwoKICAgICAgICAgICAgLy8gc2V0IGl0cyBpbmRleAogICAgICAgICAgICBnZXN0dXJlLmluZGV4ID0gZ2VzdHVyZS5pbmRleCB8fCAxMDAwOwoKICAgICAgICAgICAgLy8gYWRkIEhhbW1lci5nZXN0dXJlIHRvIHRoZSBsaXN0CiAgICAgICAgICAgIHRoaXMuZ2VzdHVyZXMucHVzaChnZXN0dXJlKTsKCiAgICAgICAgICAgIC8vIHNvcnQgdGhlIGxpc3QgYnkgaW5kZXgKICAgICAgICAgICAgdGhpcy5nZXN0dXJlcy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgICAgIGlmIChhLmluZGV4IDwgYi5pbmRleCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChhLmluZGV4ID4gYi5pbmRleCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2VzdHVyZXM7CiAgICAgICAgfQogICAgfTsKCgogICAgSGFtbWVyLmdlc3R1cmVzID0gSGFtbWVyLmdlc3R1cmVzIHx8IHt9OwoKICAgIC8qKgogICAgICogQ3VzdG9tIGdlc3R1cmVzCiAgICAgKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAqCiAgICAgKiBHZXN0dXJlIG9iamVjdAogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAqIFRoZSBvYmplY3Qgc3RydWN0dXJlIG9mIGEgZ2VzdHVyZToKICAgICAqCiAgICAgKiB7IG5hbWU6ICdteWdlc3R1cmUnLAogKiAgIGluZGV4OiAxMzM3LAogKiAgIGRlZmF1bHRzOiB7CiAqICAgICBteWdlc3R1cmVfb3B0aW9uOiB0cnVlCiAqICAgfQogKiAgIGhhbmRsZXI6IGZ1bmN0aW9uKHR5cGUsIGV2LCBpbnN0KSB7CiAqICAgICAvLyB0cmlnZ2VyIGdlc3R1cmUgZXZlbnQKICogICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUsIGV2KTsKICogICB9CiAqIH0KCiAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICBuYW1lCiAgICAgKiB0aGlzIHNob3VsZCBiZSB0aGUgbmFtZSBvZiB0aGUgZ2VzdHVyZSwgbG93ZXJjYXNlCiAgICAgKiBpdCBpcyBhbHNvIGJlaW5nIHVzZWQgdG8gZGlzYWJsZS9lbmFibGUgdGhlIGdlc3R1cmUgcGVyIGluc3RhbmNlIGNvbmZpZy4KICAgICAqCiAgICAgKiBAcGFyYW0gICB7TnVtYmVyfSAgICBbaW5kZXg9MTAwMF0KICAgICAqIHRoZSBpbmRleCBvZiB0aGUgZ2VzdHVyZSwgd2hlcmUgaXQgaXMgZ29pbmcgdG8gYmUgaW4gdGhlIHN0YWNrIG9mIGdlc3R1cmVzIGRldGVjdGlvbgogICAgICogbGlrZSB3aGVuIHlvdSBidWlsZCBhbiBnZXN0dXJlIHRoYXQgZGVwZW5kcyBvbiB0aGUgZHJhZyBnZXN0dXJlLCBpdCBpcyBhIGdvb2QKICAgICAqIGlkZWEgdG8gcGxhY2UgaXQgYWZ0ZXIgdGhlIGluZGV4IG9mIHRoZSBkcmFnIGdlc3R1cmUuCiAgICAgKgogICAgICogQHBhcmFtICAge09iamVjdH0gICAgW2RlZmF1bHRzPXt9XQogICAgICogdGhlIGRlZmF1bHQgc2V0dGluZ3Mgb2YgdGhlIGdlc3R1cmUuIHRoZXNlIGFyZSBhZGRlZCB0byB0aGUgaW5zdGFuY2Ugc2V0dGluZ3MsCiAgICAgKiBhbmQgY2FuIGJlIG92ZXJydWxlZCBwZXIgaW5zdGFuY2UuIHlvdSBjYW4gYWxzbyBhZGQgdGhlIG5hbWUgb2YgdGhlIGdlc3R1cmUsCiAgICAgKiBidXQgdGhpcyBpcyBhbHNvIGFkZGVkIGJ5IGRlZmF1bHQgKGFuZCBzZXQgdG8gdHJ1ZSkuCiAgICAgKgogICAgICogQHBhcmFtICAge0Z1bmN0aW9ufSAgaGFuZGxlcgogICAgICogdGhpcyBoYW5kbGVzIHRoZSBnZXN0dXJlIGRldGVjdGlvbiBvZiB5b3VyIGN1c3RvbSBnZXN0dXJlIGFuZCByZWNlaXZlcyB0aGUKICAgICAqIGZvbGxvd2luZyBhcmd1bWVudHM6CiAgICAgKgogICAgICogICAgICBAcGFyYW0gIHtPYmplY3R9ICAgIGV2ZW50RGF0YQogICAgICogICAgICBldmVudCBkYXRhIGNvbnRhaW5pbmcgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICogICAgICAgICAgdGltZVN0YW1wICAge051bWJlcn0gICAgICAgIHRpbWUgdGhlIGV2ZW50IG9jY3VycmVkCiAgICAgKiAgICAgICAgICB0YXJnZXQgICAgICB7SFRNTEVsZW1lbnR9ICAgdGFyZ2V0IGVsZW1lbnQKICAgICAqICAgICAgICAgIHRvdWNoZXMgICAgIHtBcnJheX0gICAgICAgICB0b3VjaGVzIChmaW5nZXJzLCBwb2ludGVycywgbW91c2UpIG9uIHRoZSBzY3JlZW4KICAgICAqICAgICAgICAgIHBvaW50ZXJUeXBlIHtTdHJpbmd9ICAgICAgICBraW5kIG9mIHBvaW50ZXIgdGhhdCB3YXMgdXNlZC4gbWF0Y2hlcyBIYW1tZXIuUE9JTlRFUl9NT1VTRXxUT1VDSAogICAgICogICAgICAgICAgY2VudGVyICAgICAge09iamVjdH0gICAgICAgIGNlbnRlciBwb3NpdGlvbiBvZiB0aGUgdG91Y2hlcy4gY29udGFpbnMgcGFnZVggYW5kIHBhZ2VZCiAgICAgKiAgICAgICAgICBkZWx0YVRpbWUgICB7TnVtYmVyfSAgICAgICAgdGhlIHRvdGFsIHRpbWUgb2YgdGhlIHRvdWNoZXMgaW4gdGhlIHNjcmVlbgogICAgICogICAgICAgICAgZGVsdGFYICAgICAge051bWJlcn0gICAgICAgIHRoZSBkZWx0YSBvbiB4IGF4aXMgd2UgaGF2ZWQgbW92ZWQKICAgICAqICAgICAgICAgIGRlbHRhWSAgICAgIHtOdW1iZXJ9ICAgICAgICB0aGUgZGVsdGEgb24geSBheGlzIHdlIGhhdmVkIG1vdmVkCiAgICAgKiAgICAgICAgICB2ZWxvY2l0eVggICB7TnVtYmVyfSAgICAgICAgdGhlIHZlbG9jaXR5IG9uIHRoZSB4CiAgICAgKiAgICAgICAgICB2ZWxvY2l0eVkgICB7TnVtYmVyfSAgICAgICAgdGhlIHZlbG9jaXR5IG9uIHkKICAgICAqICAgICAgICAgIGFuZ2xlICAgICAgIHtOdW1iZXJ9ICAgICAgICB0aGUgYW5nbGUgd2UgYXJlIG1vdmluZwogICAgICogICAgICAgICAgZGlyZWN0aW9uICAge1N0cmluZ30gICAgICAgIHRoZSBkaXJlY3Rpb24gd2UgYXJlIG1vdmluZy4gbWF0Y2hlcyBIYW1tZXIuRElSRUNUSU9OX1VQfERPV058TEVGVHxSSUdIVAogICAgICogICAgICAgICAgZGlzdGFuY2UgICAge051bWJlcn0gICAgICAgIHRoZSBkaXN0YW5jZSB3ZSBoYXZlZCBtb3ZlZAogICAgICogICAgICAgICAgc2NhbGUgICAgICAge051bWJlcn0gICAgICAgIHNjYWxpbmcgb2YgdGhlIHRvdWNoZXMsIG5lZWRzIDIgdG91Y2hlcwogICAgICogICAgICAgICAgcm90YXRpb24gICAge051bWJlcn0gICAgICAgIHJvdGF0aW9uIG9mIHRoZSB0b3VjaGVzLCBuZWVkcyAyIHRvdWNoZXMgKgogICAgICogICAgICAgICAgZXZlbnRUeXBlICAge1N0cmluZ30gICAgICAgIG1hdGNoZXMgSGFtbWVyLkVWRU5UX1NUQVJUfE1PVkV8RU5ECiAgICAgKiAgICAgICAgICBzcmNFdmVudCAgICB7T2JqZWN0fSAgICAgICAgdGhlIHNvdXJjZSBldmVudCwgbGlrZSBUb3VjaFN0YXJ0IG9yIE1vdXNlRG93biAqCiAgICAgKiAgICAgICAgICBzdGFydEV2ZW50ICB7T2JqZWN0fSAgICAgICAgY29udGFpbnMgdGhlIHNhbWUgcHJvcGVydGllcyBhcyBhYm92ZSwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXQgZnJvbSB0aGUgZmlyc3QgdG91Y2guIHRoaXMgaXMgdXNlZCB0byBjYWxjdWxhdGUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXN0YW5jZXMsIGRlbHRhVGltZSwgc2NhbGluZyBldGMKICAgICAqCiAgICAgKiAgICAgIEBwYXJhbSAge0hhbW1lci5JbnN0YW5jZX0gICAgaW5zdAogICAgICogICAgICB0aGUgaW5zdGFuY2Ugd2UgYXJlIGRvaW5nIHRoZSBkZXRlY3Rpb24gZm9yLiB5b3UgY2FuIGdldCB0aGUgb3B0aW9ucyBmcm9tCiAgICAgKiAgICAgIHRoZSBpbnN0Lm9wdGlvbnMgb2JqZWN0IGFuZCB0cmlnZ2VyIHRoZSBnZXN0dXJlIGV2ZW50IGJ5IGNhbGxpbmcgaW5zdC50cmlnZ2VyCiAgICAgKgogICAgICoKICAgICAqIEhhbmRsZSBnZXN0dXJlcwogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAqIGluc2lkZSB0aGUgaGFuZGxlciB5b3UgY2FuIGdldC9zZXQgSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50LiBUaGlzIGlzIHRoZSBjdXJyZW50CiAgICAgKiBkZXRlY3Rpb24gc2Vzc2lvbi4gSXQgaGFzIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllcwogICAgICogICAgICBAcGFyYW0gIHtTdHJpbmd9ICAgIG5hbWUKICAgICAqICAgICAgY29udGFpbnMgdGhlIG5hbWUgb2YgdGhlIGdlc3R1cmUgd2UgaGF2ZSBkZXRlY3RlZC4gaXQgaGFzIG5vdCBhIHJlYWwgZnVuY3Rpb24sCiAgICAgKiAgICAgIG9ubHkgdG8gY2hlY2sgaW4gb3RoZXIgZ2VzdHVyZXMgaWYgc29tZXRoaW5nIGlzIGRldGVjdGVkLgogICAgICogICAgICBsaWtlIGluIHRoZSBkcmFnIGdlc3R1cmUgd2Ugc2V0IGl0IHRvICdkcmFnJyBhbmQgaW4gdGhlIHN3aXBlIGdlc3R1cmUgd2UgY2FuCiAgICAgKiAgICAgIGNoZWNrIGlmIHRoZSBjdXJyZW50IGdlc3R1cmUgaXMgJ2RyYWcnIGJ5IGFjY2Vzc2luZyBIYW1tZXIuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZQogICAgICoKICAgICAqICAgICAgQHJlYWRvbmx5CiAgICAgKiAgICAgIEBwYXJhbSAge0hhbW1lci5JbnN0YW5jZX0gICAgaW5zdAogICAgICogICAgICB0aGUgaW5zdGFuY2Ugd2UgZG8gdGhlIGRldGVjdGlvbiBmb3IKICAgICAqCiAgICAgKiAgICAgIEByZWFkb25seQogICAgICogICAgICBAcGFyYW0gIHtPYmplY3R9ICAgIHN0YXJ0RXZlbnQKICAgICAqICAgICAgY29udGFpbnMgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGZpcnN0IGdlc3R1cmUgZGV0ZWN0aW9uIGluIHRoaXMgc2Vzc2lvbi4KICAgICAqICAgICAgVXNlZCBmb3IgY2FsY3VsYXRpb25zIGFib3V0IHRpbWluZywgZGlzdGFuY2UsIGV0Yy4KICAgICAqCiAgICAgKiAgICAgIEByZWFkb25seQogICAgICogICAgICBAcGFyYW0gIHtPYmplY3R9ICAgIGxhc3RFdmVudAogICAgICogICAgICBjb250YWlucyBhbGwgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGxhc3QgZ2VzdHVyZSBkZXRlY3QgaW4gdGhpcyBzZXNzaW9uLgogICAgICoKICAgICAqIGFmdGVyIHRoZSBnZXN0dXJlIGRldGVjdGlvbiBzZXNzaW9uIGhhcyBiZWVuIGNvbXBsZXRlZCAodXNlciBoYXMgcmVsZWFzZWQgdGhlIHNjcmVlbikKICAgICAqIHRoZSBIYW1tZXIuZGV0ZWN0aW9uLmN1cnJlbnQgb2JqZWN0IGlzIGNvcGllZCBpbnRvIEhhbW1lci5kZXRlY3Rpb24ucHJldmlvdXMsCiAgICAgKiB0aGlzIGlzIHVzZWZ1bGwgZm9yIGdlc3R1cmVzIGxpa2UgZG91YmxldGFwLCB3aGVyZSB5b3UgbmVlZCB0byBrbm93IGlmIHRoZQogICAgICogcHJldmlvdXMgZ2VzdHVyZSB3YXMgYSB0YXAKICAgICAqCiAgICAgKiBvcHRpb25zIHRoYXQgaGF2ZSBiZWVuIHNldCBieSB0aGUgaW5zdGFuY2UgY2FuIGJlIHJlY2VpdmVkIGJ5IGNhbGxpbmcgaW5zdC5vcHRpb25zCiAgICAgKgogICAgICogWW91IGNhbiB0cmlnZ2VyIGEgZ2VzdHVyZSBldmVudCBieSBjYWxsaW5nIGluc3QudHJpZ2dlcigibXlnZXN0dXJlIiwgZXZlbnQpLgogICAgICogVGhlIGZpcnN0IHBhcmFtIGlzIHRoZSBuYW1lIG9mIHlvdXIgZ2VzdHVyZSwgdGhlIHNlY29uZCB0aGUgZXZlbnQgYXJndW1lbnQKICAgICAqCiAgICAgKgogICAgICogUmVnaXN0ZXIgZ2VzdHVyZXMKICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiBXaGVuIGFuIGdlc3R1cmUgaXMgYWRkZWQgdG8gdGhlIEhhbW1lci5nZXN0dXJlcyBvYmplY3QsIGl0IGlzIGF1dG8gcmVnaXN0ZXJlZAogICAgICogYXQgdGhlIHNldHVwIG9mIHRoZSBmaXJzdCBIYW1tZXIgaW5zdGFuY2UuIFlvdSBjYW4gYWxzbyBjYWxsIEhhbW1lci5kZXRlY3Rpb24ucmVnaXN0ZXIKICAgICAqIG1hbnVhbGx5IGFuZCBwYXNzIHlvdXIgZ2VzdHVyZSBvYmplY3QgYXMgYSBwYXJhbQogICAgICoKICAgICAqLwoKICAgIC8qKgogICAgICogTG9uVGFwCiAgICAgKiBUb3VjaCBzdGF5cyBhdCB0aGUgc2FtZSBwbGFjZSBmb3IgeCB0aW1lCiAgICAgKiBAZXZlbnRzICBsb250YXAKICAgICAqLwogICAgSGFtbWVyLmdlc3R1cmVzLkxvblRhcCA9IHsKICAgICAgICBuYW1lOiAnbG9udGFwJywKICAgICAgICBpbmRleDogMTAsCiAgICAgICAgZGVmYXVsdHM6IHsKICAgICAgICAgICAgaG9sZF90aW1lb3V0CTogNTAwLAogICAgICAgICAgICBob2xkX3RocmVzaG9sZAk6IDEKICAgICAgICB9LAogICAgICAgIHRpbWVyOiBudWxsLAogICAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIGhvbGRHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgICAgIHN3aXRjaChldi5ldmVudFR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgSGFtbWVyLkVWRU5UX1NUQVJUOgogICAgICAgICAgICAgICAgICAgIC8vIGNsZWFyIGFueSBydW5uaW5nIHRpbWVycwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gc2V0IHRoZSBnZXN0dXJlIHNvIHdlIGNhbiBjaGVjayBpbiB0aGUgdGltZW91dCBpZiBpdCBzdGlsbCBpcwogICAgICAgICAgICAgICAgICAgIEhhbW1lci5kZXRlY3Rpb24uY3VycmVudC5uYW1lID0gdGhpcy5uYW1lOwoKICAgICAgICAgICAgICAgICAgICAvLyBzZXQgdGltZXIgYW5kIGlmIGFmdGVyIHRoZSB0aW1lb3V0IGl0IHN0aWxsIGlzIGxvbnRhcCwKICAgICAgICAgICAgICAgICAgICAvLyB3ZSB0cmlnZ2VyIHRoZSBsb250YXAgZXZlbnQKICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPT0gJ2xvbnRhcCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3QudHJpZ2dlcignbG9udGFwJywgZXYpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgaW5zdC5vcHRpb25zLmhvbGRfdGltZW91dCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgLy8gd2hlbiB5b3UgbW92ZSBvciBlbmQgd2UgY2xlYXIgdGhlIHRpbWVyCiAgICAgICAgICAgICAgICBjYXNlIEhhbW1lci5FVkVOVF9NT1ZFOgogICAgICAgICAgICAgICAgICAgIGlmKGV2LmRpc3RhbmNlID4gaW5zdC5vcHRpb25zLmhvbGRfdGhyZXNob2xkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSBIYW1tZXIuRVZFTlRfRU5EOgogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogVGFwL0RvdWJsZVRhcAogICAgICogUXVpY2sgdG91Y2ggYXQgYSBwbGFjZSBvciBkb3VibGUgYXQgdGhlIHNhbWUgcGxhY2UKICAgICAqIEBldmVudHMgIHRhcCwgZG91YmxldGFwCiAgICAgKi8KICAgIEhhbW1lci5nZXN0dXJlcy5UYXAgPSB7CiAgICAgICAgbmFtZTogJ3RhcCcsCiAgICAgICAgaW5kZXg6IDEwMCwKICAgICAgICBkZWZhdWx0czogewogICAgICAgICAgICB0YXBfbWF4X3RvdWNodGltZQk6IDI1MCwKICAgICAgICAgICAgdGFwX21heF9kaXN0YW5jZQk6IDEwLAogICAgICAgICAgICB0YXBfYWx3YXlzCQkJOiB0cnVlLAogICAgICAgICAgICBkb3VibGV0YXBfZGlzdGFuY2UJOiAyMCwKICAgICAgICAgICAgZG91YmxldGFwX2ludGVydmFsCTogMzAwCiAgICAgICAgfSwKICAgICAgICBoYW5kbGVyOiBmdW5jdGlvbiB0YXBHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgICAgIGlmKGV2LmV2ZW50VHlwZSA9PSBIYW1tZXIuRVZFTlRfRU5EKSB7CiAgICAgICAgICAgICAgICAvLyBwcmV2aW91cyBnZXN0dXJlLCBmb3IgdGhlIGRvdWJsZSB0YXAgc2luY2UgdGhlc2UgYXJlIHR3byBkaWZmZXJlbnQgZ2VzdHVyZSBkZXRlY3Rpb25zCiAgICAgICAgICAgICAgICB2YXIgcHJldiA9IEhhbW1lci5kZXRlY3Rpb24ucHJldmlvdXMsCiAgICAgICAgICAgICAgICAgICAgZGlkX2RvdWJsZXRhcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgLy8gd2hlbiB0aGUgdG91Y2h0aW1lIGlzIGhpZ2hlciB0aGVuIHRoZSBtYXggdG91Y2ggdGltZQogICAgICAgICAgICAgICAgLy8gb3Igd2hlbiB0aGUgbW92aW5nIGRpc3RhbmNlIGlzIHRvbyBtdWNoCiAgICAgICAgICAgICAgICBpZihldi5kZWx0YVRpbWUgPiBpbnN0Lm9wdGlvbnMudGFwX21heF90b3VjaHRpbWUgfHwKICAgICAgICAgICAgICAgICAgICBldi5kaXN0YW5jZSA+IGluc3Qub3B0aW9ucy50YXBfbWF4X2Rpc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgZG91YmxlIHRhcAogICAgICAgICAgICAgICAgaWYocHJldiAmJiBwcmV2Lm5hbWUgPT0gJ3RhcCcgJiYKICAgICAgICAgICAgICAgICAgICAoZXYudGltZVN0YW1wIC0gcHJldi5sYXN0RXZlbnQudGltZVN0YW1wKSA8IGluc3Qub3B0aW9ucy5kb3VibGV0YXBfaW50ZXJ2YWwgJiYKICAgICAgICAgICAgICAgICAgICBldi5kaXN0YW5jZSA8IGluc3Qub3B0aW9ucy5kb3VibGV0YXBfZGlzdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ2RvdWJsZXRhcCcsIGV2KTsKICAgICAgICAgICAgICAgICAgICBkaWRfZG91YmxldGFwID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBkbyBhIHNpbmdsZSB0YXAKICAgICAgICAgICAgICAgIGlmKCFkaWRfZG91YmxldGFwIHx8IGluc3Qub3B0aW9ucy50YXBfYWx3YXlzKSB7CiAgICAgICAgICAgICAgICAgICAgSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPSAndGFwJzsKICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUsIGV2KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogU3dpcGUKICAgICAqIHRyaWdnZXJzIHN3aXBlIGV2ZW50cyB3aGVuIHRoZSBlbmQgdmVsb2NpdHkgaXMgYWJvdmUgdGhlIHRocmVzaG9sZAogICAgICogQGV2ZW50cyAgc3dpcGUsIHN3aXBlbGVmdCwgc3dpcGVyaWdodCwgc3dpcGV1cCwgc3dpcGVkb3duCiAgICAgKi8KICAgIEhhbW1lci5nZXN0dXJlcy5Td2lwZSA9IHsKICAgICAgICBuYW1lOiAnc3dpcGUnLAogICAgICAgIGluZGV4OiA0MCwKICAgICAgICBkZWZhdWx0czogewogICAgICAgICAgICAvLyBzZXQgMCBmb3IgdW5saW1pdGVkLCBidXQgdGhpcyBjYW4gY29uZmxpY3Qgd2l0aCB0cmFuc2Zvcm0KICAgICAgICAgICAgc3dpcGVfbWF4X3RvdWNoZXMgIDogMSwKICAgICAgICAgICAgc3dpcGVfdmVsb2NpdHkgICAgIDogMC43CiAgICAgICAgfSwKICAgICAgICBoYW5kbGVyOiBmdW5jdGlvbiBzd2lwZUdlc3R1cmUoZXYsIGluc3QpIHsKICAgICAgICAgICAgaWYoZXYuZXZlbnRUeXBlID09IEhhbW1lci5FVkVOVF9FTkQpIHsKICAgICAgICAgICAgICAgIC8vIG1heCB0b3VjaGVzCiAgICAgICAgICAgICAgICBpZihpbnN0Lm9wdGlvbnMuc3dpcGVfbWF4X3RvdWNoZXMgPiAwICYmCiAgICAgICAgICAgICAgICAgICAgZXYudG91Y2hlcy5sZW5ndGggPiBpbnN0Lm9wdGlvbnMuc3dpcGVfbWF4X3RvdWNoZXMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gd2hlbiB0aGUgZGlzdGFuY2Ugd2UgbW92ZWQgaXMgdG9vIHNtYWxsIHdlIHNraXAgdGhpcyBnZXN0dXJlCiAgICAgICAgICAgICAgICAvLyBvciB3ZSBjYW4gYmUgYWxyZWFkeSBpbiBkcmFnZ2luZwogICAgICAgICAgICAgICAgaWYoZXYudmVsb2NpdHlYID4gaW5zdC5vcHRpb25zLnN3aXBlX3ZlbG9jaXR5IHx8CiAgICAgICAgICAgICAgICAgICAgZXYudmVsb2NpdHlZID4gaW5zdC5vcHRpb25zLnN3aXBlX3ZlbG9jaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciBzd2lwZSBldmVudHMKICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lLCBldik7CiAgICAgICAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArIGV2LmRpcmVjdGlvbiwgZXYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCgogICAgLyoqCiAgICAgKiBEcmFnCiAgICAgKiBNb3ZlIHdpdGggeCBmaW5nZXJzIChkZWZhdWx0IDEpIGFyb3VuZCBvbiB0aGUgcGFnZS4gQmxvY2tpbmcgdGhlIHNjcm9sbGluZyB3aGVuCiAgICAgKiBtb3ZpbmcgbGVmdCBhbmQgcmlnaHQgaXMgYSBnb29kIHByYWN0aWNlLiBXaGVuIGFsbCB0aGUgZHJhZyBldmVudHMgYXJlIGJsb2NraW5nCiAgICAgKiB5b3UgZGlzYWJsZSBzY3JvbGxpbmcgb24gdGhhdCBhcmVhLgogICAgICogQGV2ZW50cyAgZHJhZywgZHJhcGxlZnQsIGRyYWdyaWdodCwgZHJhZ3VwLCBkcmFnZG93bgogICAgICovCiAgICBIYW1tZXIuZ2VzdHVyZXMuRHJhZyA9IHsKICAgICAgICBuYW1lOiAnZHJhZycsCiAgICAgICAgaW5kZXg6IDUwLAogICAgICAgIGRlZmF1bHRzOiB7CiAgICAgICAgICAgIGRyYWdfbWluX2Rpc3RhbmNlIDogMTAsCiAgICAgICAgICAgIC8vIHNldCAwIGZvciB1bmxpbWl0ZWQsIGJ1dCB0aGlzIGNhbiBjb25mbGljdCB3aXRoIHRyYW5zZm9ybQogICAgICAgICAgICBkcmFnX21heF90b3VjaGVzICA6IDEsCiAgICAgICAgICAgIC8vIHByZXZlbnQgZGVmYXVsdCBicm93c2VyIGJlaGF2aW9yIHdoZW4gZHJhZ2dpbmcgb2NjdXJzCiAgICAgICAgICAgIC8vIGJlIGNhcmVmdWwgd2l0aCBpdCwgaXQgbWFrZXMgdGhlIGVsZW1lbnQgYSBibG9ja2luZyBlbGVtZW50CiAgICAgICAgICAgIC8vIHdoZW4geW91IGFyZSB1c2luZyB0aGUgZHJhZyBnZXN0dXJlLCBpdCBpcyBhIGdvb2QgcHJhY3RpY2UgdG8gc2V0IHRoaXMgdHJ1ZQogICAgICAgICAgICBkcmFnX2Jsb2NrX2hvcml6b250YWwgICA6IGZhbHNlLAogICAgICAgICAgICBkcmFnX2Jsb2NrX3ZlcnRpY2FsICAgICA6IGZhbHNlLAogICAgICAgICAgICAvLyBkcmFnX2xvY2tfdG9fYXhpcyBrZWVwcyB0aGUgZHJhZyBnZXN0dXJlIG9uIHRoZSBheGlzIHRoYXQgaXQgc3RhcnRlZCBvbiwKICAgICAgICAgICAgLy8gSXQgZGlzYWxsb3dzIHZlcnRpY2FsIGRpcmVjdGlvbnMgaWYgdGhlIGluaXRpYWwgZGlyZWN0aW9uIHdhcyBob3Jpem9udGFsLCBhbmQgdmljZSB2ZXJzYS4KICAgICAgICAgICAgZHJhZ19sb2NrX3RvX2F4aXMgICAgICAgOiBmYWxzZSwKICAgICAgICAgICAgLy8gZHJhZyBsb2NrIG9ubHkga2lja3MgaW4gd2hlbiBkaXN0YW5jZSA+IGRyYWdfbG9ja19taW5fZGlzdGFuY2UKICAgICAgICAgICAgLy8gVGhpcyB3YXksIGxvY2tpbmcgb2NjdXJzIG9ubHkgd2hlbiB0aGUgZGlzdGFuY2UgaGFzIGJlY29tZSBsYXJnZSBlbm91Z2ggdG8gcmVsaWFibHkgZGV0ZXJtaW5lIHRoZSBkaXJlY3Rpb24KICAgICAgICAgICAgZHJhZ19sb2NrX21pbl9kaXN0YW5jZSA6IDI1CiAgICAgICAgfSwKICAgICAgICB0cmlnZ2VyZWQ6IGZhbHNlLAogICAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIGRyYWdHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgICAgIC8vIGN1cnJlbnQgZ2VzdHVyZSBpc250IGRyYWcsIGJ1dCBkcmFnZ2VkIGlzIHRydWUKICAgICAgICAgICAgLy8gdGhpcyBtZWFucyBhbiBvdGhlciBnZXN0dXJlIGlzIGJ1c3kuIG5vdyBjYWxsIGRyYWdlbmQKICAgICAgICAgICAgaWYoSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgIT0gdGhpcy5uYW1lICYmIHRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnZW5kJywgZXYpOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gbWF4IHRvdWNoZXMKICAgICAgICAgICAgaWYoaW5zdC5vcHRpb25zLmRyYWdfbWF4X3RvdWNoZXMgPiAwICYmCiAgICAgICAgICAgICAgICBldi50b3VjaGVzLmxlbmd0aCA+IGluc3Qub3B0aW9ucy5kcmFnX21heF90b3VjaGVzKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3aXRjaChldi5ldmVudFR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgSGFtbWVyLkVWRU5UX1NUQVJUOgogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSBIYW1tZXIuRVZFTlRfTU9WRToKICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSBkaXN0YW5jZSB3ZSBtb3ZlZCBpcyB0b28gc21hbGwgd2Ugc2tpcCB0aGlzIGdlc3R1cmUKICAgICAgICAgICAgICAgICAgICAvLyBvciB3ZSBjYW4gYmUgYWxyZWFkeSBpbiBkcmFnZ2luZwogICAgICAgICAgICAgICAgICAgIGlmKGV2LmRpc3RhbmNlIDwgaW5zdC5vcHRpb25zLmRyYWdfbWluX2Rpc3RhbmNlICYmCiAgICAgICAgICAgICAgICAgICAgICAgIEhhbW1lci5kZXRlY3Rpb24uY3VycmVudC5uYW1lICE9IHRoaXMubmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgZHJhZ2dpbmchCiAgICAgICAgICAgICAgICAgICAgSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPSB0aGlzLm5hbWU7CgogICAgICAgICAgICAgICAgICAgIC8vIGxvY2sgZHJhZyB0byBheGlzPwogICAgICAgICAgICAgICAgICAgIGlmKEhhbW1lci5kZXRlY3Rpb24uY3VycmVudC5sYXN0RXZlbnQuZHJhZ19sb2NrZWRfdG9fYXhpcyB8fCAoaW5zdC5vcHRpb25zLmRyYWdfbG9ja190b19heGlzICYmIGluc3Qub3B0aW9ucy5kcmFnX2xvY2tfbWluX2Rpc3RhbmNlPD1ldi5kaXN0YW5jZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXYuZHJhZ19sb2NrZWRfdG9fYXhpcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBsYXN0X2RpcmVjdGlvbiA9IEhhbW1lci5kZXRlY3Rpb24uY3VycmVudC5sYXN0RXZlbnQuZGlyZWN0aW9uOwogICAgICAgICAgICAgICAgICAgIGlmKGV2LmRyYWdfbG9ja2VkX3RvX2F4aXMgJiYgbGFzdF9kaXJlY3Rpb24gIT09IGV2LmRpcmVjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBrZWVwIGRpcmVjdGlvbiBvbiB0aGUgYXhpcyB0aGF0IHRoZSBkcmFnIGdlc3R1cmUgc3RhcnRlZCBvbgogICAgICAgICAgICAgICAgICAgICAgICBpZihIYW1tZXIudXRpbHMuaXNWZXJ0aWNhbChsYXN0X2RpcmVjdGlvbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2LmRpcmVjdGlvbiA9IChldi5kZWx0YVkgPCAwKSA/IEhhbW1lci5ESVJFQ1RJT05fVVAgOiBIYW1tZXIuRElSRUNUSU9OX0RPV047CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldi5kaXJlY3Rpb24gPSAoZXYuZGVsdGFYIDwgMCkgPyBIYW1tZXIuRElSRUNUSU9OX0xFRlQgOiBIYW1tZXIuRElSRUNUSU9OX1JJR0hUOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBmaXJzdCB0aW1lLCB0cmlnZ2VyIGRyYWdzdGFydCBldmVudAogICAgICAgICAgICAgICAgICAgIGlmKCF0aGlzLnRyaWdnZXJlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnc3RhcnQnLCBldik7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHRyaWdnZXIgbm9ybWFsIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOwoKICAgICAgICAgICAgICAgICAgICAvLyBkaXJlY3Rpb24gZXZlbnQsIGxpa2UgZHJhZ2Rvd24KICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsgZXYuZGlyZWN0aW9uLCBldik7CgogICAgICAgICAgICAgICAgICAgIC8vIGJsb2NrIHRoZSBicm93c2VyIGV2ZW50cwogICAgICAgICAgICAgICAgICAgIGlmKCAoaW5zdC5vcHRpb25zLmRyYWdfYmxvY2tfdmVydGljYWwgJiYgSGFtbWVyLnV0aWxzLmlzVmVydGljYWwoZXYuZGlyZWN0aW9uKSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKGluc3Qub3B0aW9ucy5kcmFnX2Jsb2NrX2hvcml6b250YWwgJiYgIUhhbW1lci51dGlscy5pc1ZlcnRpY2FsKGV2LmRpcmVjdGlvbikpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgSGFtbWVyLkVWRU5UX0VORDoKICAgICAgICAgICAgICAgICAgICAvLyB0cmlnZ2VyIGRyYWdlbmQKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnRyaWdnZXJlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnZW5kJywgZXYpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogVHJhbnNmb3JtCiAgICAgKiBVc2VyIHdhbnQgdG8gc2NhbGUgb3Igcm90YXRlIHdpdGggMiBmaW5nZXJzCiAgICAgKiBAZXZlbnRzICB0cmFuc2Zvcm0sIHBpbmNoLCBwaW5jaGluLCBwaW5jaG91dCwgcm90YXRlCiAgICAgKi8KICAgIEhhbW1lci5nZXN0dXJlcy5UcmFuc2Zvcm0gPSB7CiAgICAgICAgbmFtZTogJ3RyYW5zZm9ybScsCiAgICAgICAgaW5kZXg6IDQ1LAogICAgICAgIGRlZmF1bHRzOiB7CiAgICAgICAgICAgIC8vIGZhY3Rvciwgbm8gc2NhbGUgaXMgMSwgem9vbWluIGlzIHRvIDAgYW5kIHpvb21vdXQgdW50aWwgaGlnaGVyIHRoZW4gMQogICAgICAgICAgICB0cmFuc2Zvcm1fbWluX3NjYWxlICAgICA6IDAuMDEsCiAgICAgICAgICAgIC8vIHJvdGF0aW9uIGluIGRlZ3JlZXMKICAgICAgICAgICAgdHJhbnNmb3JtX21pbl9yb3RhdGlvbiAgOiAxLAogICAgICAgICAgICAvLyBwcmV2ZW50IGRlZmF1bHQgYnJvd3NlciBiZWhhdmlvciB3aGVuIHR3byB0b3VjaGVzIGFyZSBvbiB0aGUgc2NyZWVuCiAgICAgICAgICAgIC8vIGJ1dCBpdCBtYWtlcyB0aGUgZWxlbWVudCBhIGJsb2NraW5nIGVsZW1lbnQKICAgICAgICAgICAgLy8gd2hlbiB5b3UgYXJlIHVzaW5nIHRoZSB0cmFuc2Zvcm0gZ2VzdHVyZSwgaXQgaXMgYSBnb29kIHByYWN0aWNlIHRvIHNldCB0aGlzIHRydWUKICAgICAgICAgICAgdHJhbnNmb3JtX2Fsd2F5c19ibG9jayAgOiBmYWxzZQogICAgICAgIH0sCiAgICAgICAgdHJpZ2dlcmVkOiBmYWxzZSwKICAgICAgICBoYW5kbGVyOiBmdW5jdGlvbiB0cmFuc2Zvcm1HZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgICAgIC8vIGN1cnJlbnQgZ2VzdHVyZSBpc250IGRyYWcsIGJ1dCBkcmFnZ2VkIGlzIHRydWUKICAgICAgICAgICAgLy8gdGhpcyBtZWFucyBhbiBvdGhlciBnZXN0dXJlIGlzIGJ1c3kuIG5vdyBjYWxsIGRyYWdlbmQKICAgICAgICAgICAgaWYoSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgIT0gdGhpcy5uYW1lICYmIHRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnZW5kJywgZXYpOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gYXRsZWFzdCBtdWx0aXRvdWNoCiAgICAgICAgICAgIGlmKGV2LnRvdWNoZXMubGVuZ3RoIDwgMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBwcmV2ZW50IGRlZmF1bHQgd2hlbiB0d28gZmluZ2VycyBhcmUgb24gdGhlIHNjcmVlbgogICAgICAgICAgICBpZihpbnN0Lm9wdGlvbnMudHJhbnNmb3JtX2Fsd2F5c19ibG9jaykgewogICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dpdGNoKGV2LmV2ZW50VHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSBIYW1tZXIuRVZFTlRfU1RBUlQ6CiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlIEhhbW1lci5FVkVOVF9NT1ZFOgogICAgICAgICAgICAgICAgICAgIHZhciBzY2FsZV90aHJlc2hvbGQgPSBNYXRoLmFicygxLWV2LnNjYWxlKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcm90YXRpb25fdGhyZXNob2xkID0gTWF0aC5hYnMoZXYucm90YXRpb24pOwoKICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSBkaXN0YW5jZSB3ZSBtb3ZlZCBpcyB0b28gc21hbGwgd2Ugc2tpcCB0aGlzIGdlc3R1cmUKICAgICAgICAgICAgICAgICAgICAvLyBvciB3ZSBjYW4gYmUgYWxyZWFkeSBpbiBkcmFnZ2luZwogICAgICAgICAgICAgICAgICAgIGlmKHNjYWxlX3RocmVzaG9sZCA8IGluc3Qub3B0aW9ucy50cmFuc2Zvcm1fbWluX3NjYWxlICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0aW9uX3RocmVzaG9sZCA8IGluc3Qub3B0aW9ucy50cmFuc2Zvcm1fbWluX3JvdGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSB0cmFuc2Zvcm1pbmchCiAgICAgICAgICAgICAgICAgICAgSGFtbWVyLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPSB0aGlzLm5hbWU7CgogICAgICAgICAgICAgICAgICAgIC8vIGZpcnN0IHRpbWUsIHRyaWdnZXIgZHJhZ3N0YXJ0IGV2ZW50CiAgICAgICAgICAgICAgICAgICAgaWYoIXRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKydzdGFydCcsIGV2KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOyAvLyBiYXNpYyB0cmFuc2Zvcm0gZXZlbnQKCiAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciByb3RhdGUgZXZlbnQKICAgICAgICAgICAgICAgICAgICBpZihyb3RhdGlvbl90aHJlc2hvbGQgPiBpbnN0Lm9wdGlvbnMudHJhbnNmb3JtX21pbl9yb3RhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ3JvdGF0ZScsIGV2KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHRyaWdnZXIgcGluY2ggZXZlbnQKICAgICAgICAgICAgICAgICAgICBpZihzY2FsZV90aHJlc2hvbGQgPiBpbnN0Lm9wdGlvbnMudHJhbnNmb3JtX21pbl9zY2FsZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ3BpbmNoJywgZXYpOwogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ3BpbmNoJysgKChldi5zY2FsZSA8IDEpID8gJ2luJyA6ICdvdXQnKSwgZXYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlIEhhbW1lci5FVkVOVF9FTkQ6CiAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciBkcmFnZW5kCiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy50cmlnZ2VyZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArJ2VuZCcsIGV2KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKCiAgICAvKioKICAgICAqIFRvdWNoCiAgICAgKiBDYWxsZWQgYXMgZmlyc3QsIHRlbGxzIHRoZSB1c2VyIGhhcyB0b3VjaGVkIHRoZSBzY3JlZW4KICAgICAqIEBldmVudHMgIHRvdWNoCiAgICAgKi8KICAgIEhhbW1lci5nZXN0dXJlcy5Ub3VjaCA9IHsKICAgICAgICBuYW1lOiAndG91Y2gnLAogICAgICAgIGluZGV4OiAtSW5maW5pdHksCiAgICAgICAgZGVmYXVsdHM6IHsKICAgICAgICAgICAgLy8gY2FsbCBwcmV2ZW50RGVmYXVsdCBhdCB0b3VjaHN0YXJ0LCBhbmQgbWFrZXMgdGhlIGVsZW1lbnQgYmxvY2tpbmcgYnkKICAgICAgICAgICAgLy8gZGlzYWJsaW5nIHRoZSBzY3JvbGxpbmcgb2YgdGhlIHBhZ2UsIGJ1dCBpdCBpbXByb3ZlcyBnZXN0dXJlcyBsaWtlCiAgICAgICAgICAgIC8vIHRyYW5zZm9ybWluZyBhbmQgZHJhZ2dpbmcuCiAgICAgICAgICAgIC8vIGJlIGNhcmVmdWwgd2l0aCB1c2luZyB0aGlzLCBpdCBjYW4gYmUgdmVyeSBhbm5veWluZyBmb3IgdXNlcnMgdG8gYmUgc3R1Y2sKICAgICAgICAgICAgLy8gb24gdGhlIHBhZ2UKICAgICAgICAgICAgcHJldmVudF9kZWZhdWx0OiBmYWxzZSwKCiAgICAgICAgICAgIC8vIGRpc2FibGUgbW91c2UgZXZlbnRzLCBzbyBvbmx5IHRvdWNoIChvciBwZW4hKSBpbnB1dCB0cmlnZ2VycyBldmVudHMKICAgICAgICAgICAgcHJldmVudF9tb3VzZWV2ZW50czogZmFsc2UKICAgICAgICB9LAogICAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIHRvdWNoR2VzdHVyZShldiwgaW5zdCkgewogICAgICAgICAgICBpZihpbnN0Lm9wdGlvbnMucHJldmVudF9tb3VzZWV2ZW50cyAmJiBldi5wb2ludGVyVHlwZSA9PSBIYW1tZXIuUE9JTlRFUl9NT1VTRSkgewogICAgICAgICAgICAgICAgZXYuc3RvcERldGVjdCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihpbnN0Lm9wdGlvbnMucHJldmVudF9kZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihldi5ldmVudFR5cGUgPT0gIEhhbW1lci5QT0lOVEVSX01PVVNFKSB7CiAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lLCBldik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKCiAgICAvKioKICAgICAqIFJlbGVhc2UKICAgICAqIENhbGxlZCBhcyBsYXN0LCB0ZWxscyB0aGUgdXNlciBoYXMgcmVsZWFzZWQgdGhlIHNjcmVlbgogICAgICogQGV2ZW50cyAgcmVsZWFzZQogICAgICovCiAgICBIYW1tZXIuZ2VzdHVyZXMuUmVsZWFzZSA9IHsKICAgICAgICBuYW1lOiAncmVsZWFzZScsCiAgICAgICAgaW5kZXg6IEluZmluaXR5LAogICAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIHJlbGVhc2VHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgICAgIGlmKGV2LmV2ZW50VHlwZSA9PSAgSGFtbWVyLkVWRU5UX0VORCkgewogICAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICBvLmdlc3R1cmUgPSBIYW1tZXI7Cgp9KShvY3RvcHVzKTsvKioKICogQGZpbGUKICogd2ViYXBw6YCa55So57uE5Lu254i257G7CiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQHJlcXVpcmUgbGliL2RvbS5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICogQGNsYXNzIG9jdG9wdXMuV2lkZ2V0CiAgICAgKiBAZGVzYyBvY3RvcHVzLXVp55qE54i257G7CiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICAgICogQHBhcmFtIG9wdGlvbnMuZWwge0RPTUVsZW1lbnR9IOagueiKgueCuSDlpoLmnpzmsqHmnInliJnliJvlu7rkuIDkuKpkaXYKICAgICAqIEBwYXJhbSBvcHRpb25zLmlkIHtTdHJpbmd9IHdpZGdldOeahGlkIOS5n+S8muaIkOS4uuagueiKgueCueeahGlkCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5ldmVudExpc3RlbmVycyB7T2JqZWN0fSDnlKjku6Xmibnph4/mt7vliqDkuovku7YKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgd2lkZ2V0ID0gbmV3IFdpZGdldCh7CiAgICAgKiAgICAgaWQ6ICJ3aWRnZXQiLAogICAgICogICAgIGV2ZW50TGlzdGVuZXJzOiB7CiAgICAgKiAgICAgICAgICJvblRvdWNoIjogZnVuY3Rpb24gb25Ub3VjaCgpIHt9LAogICAgICogICAgICAgICAib25Nb3ZlIjogZnVuY3Rpb24gb25Nb3ZlKCkge30sCiAgICAgKiAgICAgICAgICJzY29wZSI6IHRoaXMKICAgICAqICAgICB9CiAgICAgKiB9KTsKICAgICAqIEByZXR1cm4gbmV3IFdpZGdldAogICAgICovCiAgICBvLldpZGdldCA9IG8uZGVmaW5lKHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaWQKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGlkOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBvcHRpb25zCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBvcHRpb25zOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIEBkZXNjIHdpZGdldOeahOagueiKgueCuQogICAgICAgICAqIEB0eXBlIHtET01FTGVtZW50fQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjb250YWluZXIKICAgICAgICAgKiBAZGVzYyB3aWRnZXTnmoTlrrnlmagKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBjb250YWluZXI6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGF1dG9BY3RpdmF0ZQogICAgICAgICAqIEBkZXNjIOaYr+WQpuWvueWDj+eUn+aIkOWujOWwseebtOaOpea4suafk++8jOagh+W/l+S9jQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGF1dG9BY3RpdmF0ZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFjdGl2ZQogICAgICAgICAqIEBkZXNjIOaYr+WQpuWkhOS6jua/gOa0u+eKtuaAgQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGFjdGl2ZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50cwogICAgICAgICAqIEB0eXBlIHtvY3RvcHVzLkV2ZW50c30KICAgICAgICAgKi8KICAgICAgICBldmVudHM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzU2hvdwogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzU2hvdzogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGdlc3R1cmUKICAgICAgICAgKiBAdHlwZSB7b2N0b3B1cy5nZXN0dXJlfQogICAgICAgICAqLwogICAgICAgIGdlc3R1cmU6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50TGlzdGVuZXJzCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKiBAZGVzYyDkuovku7bnm5HlkKzlm57osIPliJfooagKICAgICAgICAgKi8KICAgICAgICBldmVudExpc3RlbmVyczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgd2lkZ2V0TWFuYWdlcgogICAgICAgICAqIEB0eXBlIHtvY3RvcHVzLldpZGdldE1hbmFnZXJ9CiAgICAgICAgICogQGRlc2Mgd2lkZ2V0566h55CG5ZmoCiAgICAgICAgICovCiAgICAgICAgd2lkZ2V0TWFuYWdlcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3Igb2N0b3B1cy5XaWRnZXQuaW5pdGlhbGl6ZQogICAgICAgICAqIEBkZXNjIOaehOmAoOWHveaVsAogICAgICAgICAqIEBwYXJhbSBvcHRpb25zICAtICAge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgICB0aGlzLmFkZE9wdGlvbnMob3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gbmV3IG8uRXZlbnRzKHRoaXMpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmUgPSBvLmdlc3R1cmU7CiAgICAgICAgICAgIHRoaXMuaWQgPSB0aGlzLmlkIHx8IG8udXRpbC5jcmVhdGVVbmlxdWVJRCh0aGlzLkNMQVNTX05BTUUgKyAiXyIpOwogICAgICAgICAgICBpZih0aGlzLmV2ZW50TGlzdGVuZXJzIGluc3RhbmNlb2YgT2JqZWN0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50cy5yZWdpc3Rlcih0aGlzLmV2ZW50TGlzdGVuZXJzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVsID0gdGhpcy5lbCB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgISF0aGlzLmVsLmlkID8gdGhpcy5pZCA9IHRoaXMuZWwuaWQgOiB0aGlzLmVsLmlkID0gdGhpcy5pZDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5yZW5kZXIKICAgICAgICAgKiBAZGVzYyDmuLLmn5MKICAgICAgICAgKiBAcGFyYW0gY29udGFpbmVyIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oY29udGFpbmVyKSB7CiAgICAgICAgICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICAgICAgICBpZihsZW4gPT0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSB0aGlzLmNvbnRhaW5lciB8fCBkb2N1bWVudC5ib2R5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBvLmcoYXJndW1lbnRzWzBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIklsbGVnYWwgRG9tISIpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZighIWFyZ3VtZW50c1sxXSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjbG9uZW5vZGUgPSBvLmRvbS5jbG9uZU5vZGUodGhpcy5jb250YWluZXIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQodGhpcy5lbCwgY2xvbmVub2RlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChjbG9uZW5vZGUsIHRoaXMuY29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGNsb25lbm9kZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZCh0aGlzLmVsLCB0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXRoaXMuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2YXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXRoaXMuaXNTaG93KSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5hcHBlbmRDaGlsZAogICAgICAgICAqLwogICAgICAgIGFwcGVuZENoaWxkOiBmdW5jdGlvbihkb20sIGNvbnRhaW5lcikgewogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZG9tKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5hY3RpdmF0ZQogICAgICAgICAqIEBkZXNjIOa/gOa0u+aOp+S7tgogICAgICAgICAqLwogICAgICAgIGFjdGl2YXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy5hY3RpdmUpIHJldHVybjsKICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModGhpcy5lbCwgImFjdGl2YXRlIik7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5kZWFjdGl2YXRlCiAgICAgICAgICogQGRlc2Mg5oyC6LW35o6n5Lu2CiAgICAgICAgICovCiAgICAgICAgZGVhY3RpdmF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmFjdGl2ZSkgICAgcmV0dXJuOwogICAgICAgICAgICBvLmRvbS5yZW1vdmVDbGFzcyh0aGlzLmVsLCAiYWN0aXZhdGUiKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5kZXN0cm95CiAgICAgICAgICogQGRlc2Mg5pGn5q+BCiAgICAgICAgICovCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMuY29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDaGlsZCh0aGlzLmVsKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVsID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5vbgogICAgICAgICAqIEBkZXNjIOebkeWQrOiHquWumuS5ieS6i+S7tiDlpoLmnpzkuLrmiYvlir/kuovku7Yg5YiZ55uR5ZCs55qE5piv5qC56IqC54K56Kem5Y+R55qECiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259CiAgICAgICAgICogQHBhcmFtIG9wdiB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIG9uOiBmdW5jdGlvbih0eXBlLCBmdW5jLCBvcHYpIHsKICAgICAgICAgICAgdmFyIEdFU1RVUkVTID0gby5XaWRnZXQuR0VTVFVSRVM7CiAgICAgICAgICAgIGlmKEdFU1RVUkVTLmluZGV4T2YodHlwZSkgIT0gLTEpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2VzdHVyZSh0aGlzLmVsLCBvcHYpLm9uKHR5cGUsIGZ1bmMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXZlbnRzLm9uKHR5cGUsIGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LnVuCiAgICAgICAgICogQGRlc2Mg5Y676Zmk55uR5ZCsIOS4jm9u55u45a+5CiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgdW46IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMudW4odHlwZSwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQubm90aWZ5CiAgICAgICAgICogQGRlc2Mg6Kem5Y+R5p+Q6Ieq5a6a5LmJ5LqL5Lu2CiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZXZ0IHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgbm90aWZ5OiBmdW5jdGlvbih0eXBlLCBldnQpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMudHJpZ2dlckV2ZW50KHR5cGUsIGV2dCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGFkZE9wdGlvbnMKICAgICAgICAgKiBAZGVzYyDmt7Hluqbnu5HlrpoKICAgICAgICAgKiBAcGFyYW0gbmV3T3B0aW9ucyAgLSAgIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgYWRkT3B0aW9uczogZnVuY3Rpb24obmV3T3B0aW9ucykgewogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucyA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMub3B0aW9ucywgbmV3T3B0aW9ucyk7CiAgICAgICAgICAgIG8uZXh0ZW5kKHRoaXMsIG5ld09wdGlvbnMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LnNob3cKICAgICAgICAgKiBAZGVzYyDmmL7npLp3aWRnZXQKICAgICAgICAgKi8KICAgICAgICBzaG93OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy5pc1Nob3cpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5pc1Nob3cgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LmhpZGRlbgogICAgICAgICAqIEBkZXNjIOmakOiXj3dpZGdldAogICAgICAgICAqLwogICAgICAgIGhpZGRlbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmlzU2hvdykgICAgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzU2hvdyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQudG9nZ2xlVmlzaWJsZQogICAgICAgICAqIEBkZXNjIOWIh+aNouaYvuekuueKtuaAgQogICAgICAgICAqLwogICAgICAgIHRvZ2dsZVZpc2libGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmlzU2hvdykgewogICAgICAgICAgICAgICAgdGhpcy5oaWRkZW4oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuY2xvbmUKICAgICAgICAgKiBAcmV0dXJucyB7Kn0KICAgICAgICAgKi8KICAgICAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBldmFsKCJuZXcgIiArIHRoaXMuQ0xBU1NfTkFNRSArICIoby51dGlsLmNsb25lKHRoaXMub3B0aW9ucykpIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuZ2V0RWwKICAgICAgICAgKiBAZGVzYyDmi793aWRnZXTnmoTmoLnoioLngrkKICAgICAgICAgKi8KICAgICAgICBnZXRFbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LmdldEhlaWdodAogICAgICAgICAqIEBkZXNjIOaLv+WIsHdpZGdldOeahOmrmOW6pgogICAgICAgICAqLwogICAgICAgIGdldEhlaWdodDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBvLmRvbS5nZXRIZWlnaHQodGhpcy5lbCkgfHwgby5kb20uZ2V0U3R5bGUodGhpcy5lbCwgImhlaWdodCIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LmdldFdpZHRoCiAgICAgICAgICogQGRlc2Mg5ou/5Yiwd2lkZ2V055qE5a695bqmCiAgICAgICAgICovCiAgICAgICAgZ2V0V2lkdGg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gby5kb20uZ2V0V2lkdGgodGhpcy5lbCkgfHwgby5kb20uZ2V0U3R5bGUodGhpcy5lbCwgIndpZHRoIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuc2V0TWFuYWdlcgogICAgICAgICAqIEBkZXNjIHdpZGdldOiiq+azqOWGjOi/m3dpZGdldE1hbmFnZXIKICAgICAgICAgKiBAcGFyYW0gbQogICAgICAgICAqLwogICAgICAgIHNldE1hbmFnZXI6IGZ1bmN0aW9uKG0pIHsKICAgICAgICAgICAgdGhpcy53aWRnZXRNYW5hZ2VyID0gbTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5zZXRaSW5kZXgKICAgICAgICAgKiBAZGVzYyDorr7nva7mjqfku7bnmoR6aW5kZXjlgLwKICAgICAgICAgKiBAcGFyYW0geiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHNldFpJbmRleDogZnVuY3Rpb24oeikgewogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLnpJbmRleCA9IHo7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0IgogICAgfSk7CgogICAgby5XaWRnZXQuR0VTVFVSRVMgPSBbInRhcCIsICJsb250YXAiLCAiZG91YmxldGFwIiwgInN3aXBlIiwgInN3aXBlbGVmdCIsCiAgICAgICAgInN3aXBlcmlnaHQiLCAic3dpcGV1cCIsICJzd2lwZWRvd24iLCAiZHJhZyIsICJkcmFwbGVmdCIsICJkcmFncmlnaHQiLAogICAgICAgICJkcmFndXAiLCAiZHJhZ2Rvd24iLCAidG91Y2giLCAicmVsZWFzZSJdOwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLndpZGdldE1hbmFnZXIKICAgICAqIEBkZXNjIOi/lOWbnuS4gOS4qndpZGdldOeahOeuoeeQhuWZqAogICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICogQHBhcmFtIG9wdHMge09iamVjdH0KICAgICAqIEByZXR1cm5zIHtvLldpZGdldE1hbmFnZXJ9CiAgICAgKi8KICAgIG8ud2lkZ2V0TWFuYWdlciA9IGZ1bmN0aW9uKGVsLCBvcHRzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBvLldpZGdldE1hbmFnZXIoZWwsIG9wdHMpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLldpZGdldE1hbmFnZXIKICAgICAqIEBkZXNjIHdpZGdldOeuoeeQhuWZqAogICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fSDnrqHnkIblmajopobnm5bnmoToioLngrkg5b+F6aG75pyJ55qE5Y+C5pWwCiAgICAgKiBAcGFyYW0gb3B0cyB7T2JqZWN0fSDpop3lpJblj4LmlbAg6Z2e5b+F6ZyACiAgICAgKiBAcGFyYW0gb3B0cy5jbGFzc0ZpbHRlciB7U3RyaW5nfSDnrKblkIjmnaHku7bnmoToioLngrnlv4XpnIDljIXmi6zov5nkuKpjbGFzcyDpu5jorqTkuLoib2N0b3B1c3VpLWNvbnRhaW5lciIKICAgICAqIEBwYXJhbSBvcHRzLnN1cHBvcnRUeXBlIHtBcnJheX0g5b2T5YmN6L+Z5Liq566h55CG5Zmo5pSv5oyB55qE5o6n5Lu257G75Z6LIOm7mOiupOS4uiBzbGlkZXIgcmVmcmVzaCBtZW51IG1hc2sgYmFjazJ0b3AKICAgICAqLwogICAgby5XaWRnZXRNYW5hZ2VyID0gby5kZWZpbmUoewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqIEBkZXNjIOeuoeeQhuWZqOimhueblueahOiKgueCueWuueWZqAogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbHMKICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICogQGRlc2Mg56ym5ZCI5p2h5Lu255qE6IqC54K56ZuG5ZCICiAgICAgICAgICovCiAgICAgICAgZWxzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBvcHRzCiAgICAgICAgICogQGRlc2Mg5Y+C5pWw6aG5CiAgICAgICAgICovCiAgICAgICAgb3B0czogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY2xhc3NGaWx0ZXIKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOespuWQiOadoeS7tuiKgueCueeahGNsYXNzCiAgICAgICAgICovCiAgICAgICAgY2xhc3NGaWx0ZXI6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHdpZGdldHMKICAgICAgICAgKiBAZGVzYyDnrqHnkIblmajph4zlt7Lmi7/liLDnmoTmjqfku7YKICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICovCiAgICAgICAgd2lkZ2V0czogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc3VwcG9ydFR5cGUKICAgICAgICAgKiBAZGVzYyDmlK/mjIHnmoTmjqfku7bnsbvlnovpm4blkIgKICAgICAgICAgKi8KICAgICAgICBzdXBwb3J0VHlwZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnQKICAgICAgICAgKi8KICAgICAgICBldmVudDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKiBAcGFyYW0gZWwge1N0cmluZyB8IERPTUVsZW1lbnR9IOino+aekOeahOWuueWZqAogICAgICAgICAqIEBwYXJhbSBvcHRzIHtPYmplY3R9IOS8oOWFpeeahOWPguaVsAogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGVsLCBvcHRzKSB7CiAgICAgICAgICAgIHRoaXMub3B0cyA9IG8uZXh0ZW5kKHt9LCBvcHRzIHx8IHt9KTsKICAgICAgICAgICAgdGhpcy5lbCA9IG8uZyhlbCk7CiAgICAgICAgICAgIGlmKCFvLnV0aWwuaXNOb2RlKHRoaXMuZWwpKSAgdGhyb3cgbmV3IEVycm9yKCJyZXF1aXJlIGEgbm9kZSB0byBpbml0aWFsaXplISIpOwogICAgICAgICAgICB0aGlzLmVscyA9IFtdOwogICAgICAgICAgICB0aGlzLmV2ZW50ID0gbmV3IG8uRXZlbnRzKHRoaXMpOwogICAgICAgICAgICB0aGlzLndpZGdldHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5zdXBwb3J0VHlwZSA9IHRoaXMub3B0cy5zdXBwb3J0VHlwZSB8fCBbInNsaWRlciIsICJiYWNrMnRvcCJdOwogICAgICAgICAgICB0aGlzLmNsYXNzRmlsdGVyID0gdGhpcy5vcHRzLmNsYXNzRmlsdGVyIHx8ICIub2N0b3B1c3VpLWNvbnRhaW5lciI7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0TWFuYWdlci5pbml0CiAgICAgICAgICogQGRlc2Mg5byA5aeL5a+55oyH5a6a6IqC54K55LiL55qE56ym5ZCI5p2h5Lu255qEaHRtbOeJh+auteaOp+S7tuWMlgogICAgICAgICAqLwogICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgZWxzID0gby4kKHRoaXMuY2xhc3NGaWx0ZXIsIHRoaXMuZWwpLAogICAgICAgICAgICAgICAgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIG8udXRpbC5lYWNoKGVscywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgICAgaWYoby51dGlsLmlzTm9kZShpdGVtKSkgewogICAgICAgICAgICAgICAgICAgIHRoYXQuZWxzLnB1c2goaXRlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZih0aGlzLmVscy5sZW5ndGggPT0gMCkgICAgcmV0dXJuOwogICAgICAgICAgICBvLnV0aWwuZWFjaCh0aGlzLmVscywgby51dGlsLmJpbmQodGhpcy5pbml0V2lkZ2V0cywgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBpbml0V2lkZ2V0cwogICAgICAgICAqIEBwYXJhbSBpdGVtIOWNleS4qndpZGdldOeahGh0bWzniYfmrrXnmoTlrrnlmagKICAgICAgICAgKi8KICAgICAgICBpbml0V2lkZ2V0czogZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICB2YXIgdHlwZSA9IG8uZG9tLmRhdGEoaXRlbSwgIm9jdG9wdXN1aS10eXBlIiksCiAgICAgICAgICAgICAgICBpbmRleCA9IHRoaXMuc3VwcG9ydFR5cGUuaW5kZXhPZih0eXBlKTsKICAgICAgICAgICAgaWYoaW5kZXggPT0gLTEgfHwgby5kb20uZGF0YShpdGVtLCAib2N0b3B1c3VpLWxvYWRlZCIpKSAgIHJldHVybjsKICAgICAgICAgICAgdmFyIHdpZGdldCA9IHRoaXNbdGhpcy5zdXBwb3J0VHlwZVtpbmRleF1dKGl0ZW0pOwogICAgICAgICAgICB0aGlzLnJlZ2lzdGVyKHdpZGdldCk7CiAgICAgICAgICAgIG8uZG9tLmRhdGEod2lkZ2V0LmVsLCB7CiAgICAgICAgICAgICAgICAib2N0b3B1c3VpLWxvYWRlZCI6ICJ0cnVlIgogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0V2lkZ2V0QnkKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDojrflj5bnsbvlnosKICAgICAgICAgKiBAcGFyYW0gZmlsdGVyIHtTdHJpbmd9IOiOt+WPluiKgueCueeahOmAieaLqeWZqAogICAgICAgICAqLwogICAgICAgIGdldFdpZGdldEJ5OiBmdW5jdGlvbih0eXBlLCBmaWx0ZXIpIHsKICAgICAgICAgICAgdmFyIHdpZGdldHMgPSBbXSwKICAgICAgICAgICAgICAgIGxlbiA9IHRoaXMud2lkZ2V0cy5sZW5ndGgsCiAgICAgICAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgICBmb3IoOyBpLS07ICkgewogICAgICAgICAgICAgICAgdmFyIHdpZGdldCA9IHRoaXMud2lkZ2V0c1tpXTsKICAgICAgICAgICAgICAgIGlmKHdpZGdldFt0eXBlXSA9PSBmaWx0ZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZih0eXBlID09ICJpZCIpIHJldHVybiB3aWRnZXQ7CiAgICAgICAgICAgICAgICAgICAgd2lkZ2V0cy5wdXNoKHdpZGdldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdpZGdldHM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXRNYW5hZ2VyLmdldFdpZGdldEJ5SWQKICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDmoLnmja53aWRnZXTnmoRpZOaLv+WIsHdpZGdldOWvueixoQogICAgICAgICAqLwogICAgICAgIGdldFdpZGdldEJ5SWQ6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFdpZGdldEJ5KCJpZCIsIGlkKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldE1hbmFnZXIuZ2V0V2lkZ2V0QnlDbGFzcwogICAgICAgICAqIEBwYXJhbSBjIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5qC55o2ud2lkZ2V055qEY2xhc3NfbmFtZeaLv3dpZGdldOWvueixoembhuWQiAogICAgICAgICAqLwogICAgICAgIGdldFdpZGdldEJ5Q2xhc3M6IGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0V2lkZ2V0QnkoIkNMQVNTX05BTUUiLCBjKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldE1hbmFnZXIuc2xpZGVyCiAgICAgICAgICogQGRlc2Mg5Yib5bu65LiA5Liq6L2u5pKt5Zu+CiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIHNsaWRlcjogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgcmV0dXJuIG8uV2lkZ2V0LnNsaWRlcihlbCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXRNYW5hZ2VyLmJhY2sydG9wCiAgICAgICAgICogQGRlc2Mg5Yib5bu65LiA5LiqZml4ZWTnmoTlhYPntKAKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgYmFjazJ0b3A6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIHJldHVybiBvLldpZGdldC5iYWNrMnRvcChlbCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXRNYW5hZ2VyLnJlZ2lzdGVyCiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKHdpZGdldCkgewogICAgICAgICAgICBpZih0aGlzLndpZGdldHMuaW5kZXhPZih3aWRnZXQpICE9IC0xKSAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB0aGlzLndpZGdldHMucHVzaCh3aWRnZXQpOwogICAgICAgICAgICB3aWRnZXQuc2V0TWFuYWdlcih0aGlzKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldE1hbmFnZXIudW5yZWdpc3RlcgogICAgICAgICAqLwogICAgICAgIHVucmVnaXN0ZXI6IGZ1bmN0aW9uKHdpZGdldCkgewogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLndpZGdldHMuaW5kZXhPZih3aWRnZXQpOwogICAgICAgICAgICBpZihpbmRleCA9PSAtMSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB0aGlzLndpZGdldHNbaW5kZXhdLnNldE1hbmFnZXIobnVsbCk7CiAgICAgICAgICAgIHRoaXMud2lkZ2V0cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLldpZGdldE1hbmFnZXIiCiAgICB9KTsKCn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICogd2ViYXBw6YCa55So57uE5Lu2CiAqIGJhY2sydG9wICAgLSAgIOWbnuWIsOmhtumDqAogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQHJlcXVpcmUgbGliL2RvbS5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICogQHJlcXVpcmUgbGliL3R3ZWVuLmpzCiAqIEByZXF1aXJlIHdpZGdldC93aWRnZXQuanMKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICogQGNsYXNzIG9jdG9wdXMuV2lkZ2V0LkJhY2syVG9wCiAgICAgKiBAcGFyZW50IG9jdG9wdXMuV2lkZ2V0CiAgICAgKiBAZGVzYyDlm57liLDpobbpg6jmjqfku7YKICAgICAqIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9IOaOpeWPl+eahOWPguaVsAogICAgICogQHBhcmFtIG9wdGlvbnMuaXNGYXN0IHtCb29sZWFufSDmmK/lkKbkvb/nlKjpq5jmgKfog73vvIjljbPlvZPmu5rliqjml7bpmpDol4/mjqfku7bvvInmqKHlvI8g6buY6K6k5LiN6YeH55SoCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5hbmltYXRpb24ge0Jvb2xlYW59IOi/lOWbnumhtumDqOaYr+WQpuS9v+eUqOWKqOeUuyDpu5jorqTkuI3ph4fnlKgKICAgICAqIEBwYXJhbSBvcHRpb25zLmJvdHRvbSB7TnVtYmVyfSDmjqfku7bot53nprvlupXpg6jnmoTlgLwKICAgICAqIEBwYXJhbSBvcHRpb25zLmRpcmVjdGlvbiB7U3RyaW5nfSDmjqfku7blnKjlt6bkvqfov5jmmK/lj7Pkvqcg6buY6K6k5Y+z5L6nICJyaWdodCIgfHwgImxlZnQiCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5vZmZzZXRWIHtOdW1iZXJ9IOaOp+S7tui3neemu+W3puS+p+aIluiAheWPs+S+p+eahOi3neemuwogICAgICogQHBhcmFtIG9wdGlvbnMuY3VzdG9taXplIHtCb29sZWFufSDmmK/lkKboh6rlrprliLbngrnlh7vmjqfku7blkI7nmoTlm57osIMg6Iul5Li6dHJ1ZeWImeeCueWHu+aOp+S7tuWPquinpuWPkeiHquWumuS5ieS6i+S7tu+8iGJhY2sydG9wLW9udGFw77yJIOS4jei/lOWbnumhtumDqAogICAgICovCiAgICBvLldpZGdldC5CYWNrMlRvcCA9IG8uZGVmaW5lKG8uV2lkZ2V0LCB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGJvdHRvbQogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg5o6n5Lu26Led56a75bqV6YOo6Led56a7CiAgICAgICAgICovCiAgICAgICAgYm90dG9tOiAxMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGlyZWN0aW9uCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBkaXJlY3Rpb246ICJyaWdodCIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG9mZnNldFYKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOaOp+S7tui3neemu+S4pOS+p+eahOi3neemuwogICAgICAgICAqLwogICAgICAgIG9mZnNldFY6IDEwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc0Fic29sdXRlCiAgICAgICAgICogQGRlc2Mg5p+Q5Lqb5py65Zmo5LiN5pSv5oyBZml4ZWTlsZ7mgKcg55SoYWJzb2x1dGXku6Pmm78KICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc0Fic29sdXRlOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNGYXN0CiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5piv5ZCm5Zyo5rua5Yqo5Lit6ZqQ6JeP5LuO6ICM5o+Q6auY5oCn6IO9CiAgICAgICAgICovCiAgICAgICAgaXNGYXN0OiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc2Nyb2xsVGltZXIKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOeUqOadpeS8mOWMluaAp+iDveeahHNjcm9sbOaXtueahOWumuaXtuWZqAogICAgICAgICAqLwogICAgICAgIHNjcm9sbFRpbWVyOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1Njcm9sbAogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOW9k+WJjeaYr+WQpuWcqHNjcm9sbOeahOagh+W/l+S9jQogICAgICAgICAqLwogICAgICAgIGlzU2Nyb2xsOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY3VzdG9taXplCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5piv5ZCm55So5oi36Ieq5a6a5LmJ54K55Ye75LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgY3VzdG9taXplOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYW5pbWF0aW9uCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5piv5ZCm5pyJ5Yqo55S7CiAgICAgICAgICovCiAgICAgICAgYW5pbWF0aW9uOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbG9vcAogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICogQGRlc2Mg5Yqo55S755qE5YaF5a2Y5a+75Z2ACiAgICAgICAgICovCiAgICAgICAgbG9vcDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY291bnQKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOWKqOeUu+iuoeaVsAogICAgICAgICAqLwogICAgICAgIGNvdW50OiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB0ZXN0Rml4ZWQKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDmmK/lkKbmtYvor5Xov4fmmK/lkKbmlK/mjIFmaXhlZOWxnuaApwogICAgICAgICAqLwogICAgICAgIHRlc3RGaXhlZDogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHRlc3RGaXhhYmxlRG9tCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICogQGRlc2Mg55So5p2l5Yik5pat6K6+5aSH5piv5ZCm5pSv5oyBZml4ZWTnmoToioLngrkKICAgICAgICAgKi8KICAgICAgICB0ZXN0Rml4YWJsZURvbTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModGhpcy5lbCwgIm9jdG9wdXN1aS1iYWNrMnRvcCIpOwogICAgICAgICAgICB0aGlzLmxvb3AgPSB7fTsKICAgICAgICAgICAgdGhpcy5pbml0Rml4ZWQoKTsKICAgICAgICAgICAgdGhpcy5pbml0RXZlbnQoKTsKICAgICAgICAgICAgdGhpcy50ZXN0Rml4YWJsZURvbSA9IG8uZG9tLmNyZWF0ZURvbSgiZGl2IiwgbnVsbCwgewogICAgICAgICAgICAgICAgdG9wOiAiNXB4IiwKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiZml4ZWQiCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBpbml0Rml4ZWQKICAgICAgICAgKiBAZGVzYyDliJ3lp4vljJZmaXjlsZ7mgKcg6K6p5YW25YW85a655omA5pyJ5rWP6KeI5ZmoCiAgICAgICAgICovCiAgICAgICAgaW5pdEZpeGVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZigvTTAzMS8udGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXRBYnNvbHV0ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGRpcmVjdGlvbiA9IHRoaXMuZGlyZWN0aW9uOwogICAgICAgICAgICAgICAgby5kb20uc2V0U3R5bGVzKHRoaXMuZWwsIHsKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogImZpeGVkIiwKICAgICAgICAgICAgICAgICAgICBib3R0b206IHRoaXMuYm90dG9tICsgInB4IgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlW2RpcmVjdGlvbl0gPSB0aGlzLm9mZnNldFYgKyAicHgiOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNldEFic29sdXRlCiAgICAgICAgICogQGRlc2Mg5bCG5LiN5pSv5oyBZml4ZWTnmoToioLngrnorr7nva7kuLphYnNvbHV0ZQogICAgICAgICAqLwogICAgICAgIHNldEFic29sdXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICAgICAgICAgIHRoaXMuaXNBYnNvbHV0ZSA9IHRydWU7CiAgICAgICAgICAgIG8uZXZlbnQub24od2luZG93LCAib3J0Y2hhbmdlIiwgby51dGlsLmJpbmQodGhpcy5vbk9yaWVudGF0aW9uQ2hhbmdlZCwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvbk9yaWVudGF0aW9uQ2hhbmdlZAogICAgICAgICAqLwogICAgICAgIG9uT3JpZW50YXRpb25DaGFuZ2VkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5zdGFydEZpeGVkKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGluaXRFdmVudAogICAgICAgICAqIEBkZXNjIOS6i+S7tuWIneWni+WMlgogICAgICAgICAqLwogICAgICAgIGluaXRFdmVudDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaXNGYXN0ICYmIG8uZXZlbnQub24oZG9jdW1lbnQsICJ0b3VjaG1vdmUiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hNb3ZlLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICBvLmV2ZW50Lm9uKGRvY3VtZW50LCAic2Nyb2xsIiwgby51dGlsLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcy5vbkp1ZGdlU2Nyb2xsLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICBvLmV2ZW50Lm9uKGRvY3VtZW50LCAidG91Y2hlbmQiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hFbmQsIHRoaXMpLCBmYWxzZSk7CiAgICAgICAgICAgIG8uZXZlbnQub24oZG9jdW1lbnQsICJ0b3VjaGNhbmNlbCIsIG8udXRpbC5iaW5kQXNFdmVudExpc3RlbmVyKHRoaXMub25Ub3VjaEVuZCwgdGhpcyksIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5vbigidGFwIiwgby51dGlsLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcy5vblRhcCwgdGhpcykpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvblRhcAogICAgICAgICAqLwogICAgICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJiYWNrMnRvcC1vbnRhcCIsIGUpOwogICAgICAgICAgICAhdGhpcy5jdXN0b21pemUgJiYgdGhpcy5nb1RvKDEsIHRoaXMuYW5pbWF0aW9uKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5CYWNrMlRvcC5nb1RvCiAgICAgICAgICogQHBhcmFtIHkge051bWJlcn0KICAgICAgICAgKiBAcGFyYW0gYW5pbWF0aW9uIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOS9v+mhtemdoua7muWIsOaMh+WumuS9jee9rgogICAgICAgICAqLwogICAgICAgIGdvVG86IGZ1bmN0aW9uKHksIGFuaW1hdGlvbikgewogICAgICAgICAgICBpZighYW5pbWF0aW9uKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgeSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgX3kgPSB3aW5kb3cucGFnZVlPZmZzZXQ7CiAgICAgICAgICAgICAgICB0aGlzLmNvdW50ID0gMDsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgICsrdGhpcy5jb3VudDsKICAgICAgICAgICAgICAgIHRoaXMubG9vcFt0aGlzLmNvdW50XSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmKHRoYXQubG9vcFt0aGF0LmNvdW50XSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3kgPiAoeSAtIDEpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsQnkoMCwgLU1hdGgubWluKDE1MCwgX3kgLSB5ICsgMSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3kgLT0gMTUwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgby51dGlsLnJlcXVlc3RBbmltYXRpb24odGhhdC5sb29wW3RoYXQuY291bnRdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQubG9vcFt0aGF0LmNvdW50XSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0Lmxvb3BbdGhhdC5jb3VudF0gPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKHRoaXMubG9vcFt0aGlzLmNvdW50XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaEVuZAogICAgICAgICAqIEBkZXNjIOWIpOaWreaYr+WQpuW6lOivpeaYvuekugogICAgICAgICAqLwogICAgICAgIG9uVG91Y2hFbmQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmNoZWNrSWZWaXNpYmxlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uSnVkZ2VTY3JvbGwKICAgICAgICAgKi8KICAgICAgICBvbkp1ZGdlU2Nyb2xsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYoIXRoaXMuaXNTY3JvbGwpIHsKICAgICAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKG8udXRpbC5iaW5kKHRoaXMub25TY3JvbGwsIHRoaXMpKTsKICAgICAgICAgICAgICAgIHRoaXMuaXNTY3JvbGwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uU2Nyb2xsCiAgICAgICAgICovCiAgICAgICAgb25TY3JvbGw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmNsZWFyVGltZXIoKTsKICAgICAgICAgICAgdGhpcy5pc0Zhc3QgJiYgdGhpcy5oaWRkZW4oKTsKICAgICAgICAgICAgdGhpcy5pc0Fic29sdXRlICYmIHRoaXMuc3RhcnRGaXhlZCgpOwogICAgICAgICAgICB0aGlzLnNjcm9sbFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoby51dGlsLmJpbmQodGhpcy5vblNjcm9sbFN0b3AsIHRoaXMpLCAzMDApOwogICAgICAgICAgICB0aGlzLmlzU2Nyb2xsID0gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uU2Nyb2xsU3RvcAogICAgICAgICAqLwogICAgICAgIG9uU2Nyb2xsU3RvcDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaXNBYnNvbHV0ZSAmJiB0aGlzLnN0YXJ0Rml4ZWQoKTsKICAgICAgICAgICAgIXRoaXMudGVzdEZpeGVkICYmIHRoaXMudGVzdEZpeGFibGUoKTsKICAgICAgICAgICAgdGhpcy5jaGVja0lmVmlzaWJsZSgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCB0ZXN0Rml4YWJsZQogICAgICAgICAqIEBkZXNjIOWIpOaWreW9k+WJjeiuvuWkh+aYr+WQpuaUr+aMgWZpeGVk5bGe5oCnCiAgICAgICAgICovCiAgICAgICAgdGVzdEZpeGFibGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnRlc3RGaXhlZCA9IHRydWU7CiAgICAgICAgICAgIGlmKHRoaXMudGVzdEZpeGFibGVEb20ub2Zmc2V0VG9wICE9IDUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0QWJzb2x1dGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMudGVzdEZpeGFibGVEb20pOwogICAgICAgICAgICB0aGlzLnRlc3RGaXhhYmxlRG9tID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgY2hlY2tJZlZpc2libGUKICAgICAgICAgKi8KICAgICAgICBjaGVja0lmVmlzaWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHdpbmRvdy5wYWdlWU9mZnNldCA+IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQgPyB0aGlzLnNob3coKSA6IHRoaXMuaGlkZGVuKCkKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaE1vdmUKICAgICAgICAgKi8KICAgICAgICBvblRvdWNoTW92ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaGlkZGVuKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGNsZWFyVGltZXIKICAgICAgICAgKi8KICAgICAgICBjbGVhclRpbWVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy5zY3JvbGxUaW1lcikgewogICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLnNjcm9sbFRpbWVyKTsKICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsVGltZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHN0YXJ0Rml4ZWQKICAgICAgICAgKiBAZGVzYyDlvZPorr7lpIfkuI3mlK/mjIFmaXhlZOaXtueUqGFic29sdXRl55qE5rua5YqoCiAgICAgICAgICovCiAgICAgICAgc3RhcnRGaXhlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmFjdGl2ZSkgICAgcmV0dXJuOwoJCQl2YXIgZGlyZWN0aW9uID0gdGhpcy5kaXJlY3Rpb24gPT0gInJpZ2h0IiA/ICJsZWZ0IiA6ICJyaWdodCI7CiAgICAgICAgICAgIG8uZG9tLnNldFN0eWxlcyh0aGlzLmVsLCB7CiAgICAgICAgICAgICAgICB0b3A6IHdpbmRvdy5wYWdlWU9mZnNldCArIHdpbmRvdy5pbm5lckhlaWdodCAtIHBhcnNlSW50KHRoaXMuZ2V0SGVpZ2h0KCkpIC0gdGhpcy5ib3R0b20gKyAicHgiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmVsLnN0eWxlW2RpcmVjdGlvbl0gPSBkb2N1bWVudC5ib2R5Lm9mZnNldFdpZHRoIC0gcGFyc2VJbnQodGhpcy5nZXRXaWR0aCgpKSAtIHRoaXMub2Zmc2V0ViArICJweCI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHJlbmRlcgogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBiID0gZG9jdW1lbnQuYm9keSwKICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGI7CiAgICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKHRoaXMuZWwpOwogICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZCh0aGlzLnRlc3RGaXhhYmxlRG9tKQogICAgICAgICAgICB0aGlzLmFwcGVuZENoaWxkKGZyYWdtZW50LCB0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgICAgIGlmKHRoaXMuaXNTaG93KSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzU2hvdyA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5zaG93KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXRoaXMuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2YXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAib2N0b3B1cy5XaWRnZXQuQmFjazJUb3AiCiAgICB9KTsKCiAgICAvKioKICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuYmFjazJ0b3AKICAgICAqIEBkZXNjIOeUn+aIkOS4jmh0bWzmqKHniYjnm7jnu5HlrprnmoTlm57liLDpobbpg6gg5omA5pyJ55qE5Y+C5pWw6YO95LulaHRtbOaooeeJiOW9ouW8j+S8oOWFpQogICAgICogQHBhcmFtIGVsCiAgICAgKiBAcmV0dXJucyB7by5XaWRnZXQuSHRtbEJhY2syVG9wfQogICAgICovCiAgICBvLldpZGdldC5iYWNrMnRvcCA9IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgcmV0dXJuIG5ldyBvLldpZGdldC5IdG1sQmFjazJUb3AoewogICAgICAgICAgICBlbDogZWwKICAgICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAY2xhc3Mgb2N0b3B1cy5XaWRnZXQuSHRtbEJhY2syVG9wCiAgICAgKiBAcGFyZW50IG9jdG9wdXMuV2lkZ2V0LkJhY2syVG9wCiAgICAgKiBAZGVzYyDlj4LmlbDkuI5vY3RvcHVzLldpZGdldC5CYWNrMlRvcCDkuI3lkIznmoTmmK8g6L+Z5Liq57G75LuF6ZmQ5LqO5a+55bey5pyJ56ym5ZCI6KeE6IyD55qEaHRtbOaooeeJiOeahOaUuemAoOS4juWwgeijhQogICAgICog56ym5ZCI5p2h5Lu255qEaHRtbOaooeeJiOWxnuaAp+WMheaLrAogICAgICogZGF0YS1vY3RvcHVzdWktYmFjazJ0b3AtZGlyZWN0aW9uIOWPr+S7peaMh+WumuaOp+S7tueahOW3puWPsyAibGVmdCIgfHwgInJpZ2h0IgogICAgICogZGF0YS1vY3RvcHVzdWktYmFjazJ0b3AtZmFzdCDlpoLmnpzorr7nva7mraTlsZ7mgKcg5L2/55So6auY5oCn6IO977yI5Y2z5b2T5rua5Yqo5pe26ZqQ6JeP5o6n5Lu277yJ5qih5byPCiAgICAgKiBkYXRhLW9jdG9wdXN1aS1iYWNrMnRvcC1hbmltYXRlIOWmguaenOiuvue9ruatpOWxnuaApyDov5Tlm57pobbpg6jkvJrkvb/nlKjliqjnlLsKICAgICAqIGRhdGEtb2N0b3B1c3VpLWJhY2sydG9wLWJvdHRvbSDorr7nva7ot53lupXpg6jnmoTot53nprsg6buY6K6k5Li6MTAKICAgICAqIGRhdGEtb2N0b3B1c3VpLWJhY2sydG9wLW9mZnNldCDorr7nva7ot53lt6bvvZzlj7PnmoTot53nprsg6buY6K6k5Li6MTAKICAgICAqIGRhdGEtb2N0b3B1c3VpLWJhY2sydG9wLWN1c3RvbWl6ZSDlpoLmnpzorr7nva7mraTlsZ7mgKcg5YiZ6ZyA6KaB6Ieq5a6a5LmJ54K55Ye75ZCO55qE5LqL5Lu2CiAgICAgKi8KICAgIG8uV2lkZ2V0Lkh0bWxCYWNrMlRvcCA9IG8uZGVmaW5lKG8uV2lkZ2V0LkJhY2syVG9wLCB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0cykgewogICAgICAgICAgICBvLldpZGdldC5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLmxvb3AgPSB7fTsKICAgICAgICAgICAgdGhpcy5kaXJlY3Rpb24gPSBvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktYmFjazJ0b3AtZGlyZWN0aW9uIikgfHwgdGhpcy5kaXJlY3Rpb247CiAgICAgICAgICAgIHRoaXMuaXNGYXN0ID0gby5kb20uZGF0YSh0aGlzLmVsLCAib2N0b3B1c3VpLWJhY2sydG9wLWZhc3QiKTsKICAgICAgICAgICAgdGhpcy5hbmltYXRpb24gPSBvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktYmFjazJ0b3AtYW5pbWF0ZSIpOwogICAgICAgICAgICB0aGlzLmJvdHRvbSA9IG8uZG9tLmRhdGEodGhpcy5lbCwgIm9jdG9wdXN1aS1iYWNrMnRvcC1ib3R0b20iKSB8fCB0aGlzLmJvdHRvbTsKICAgICAgICAgICAgdGhpcy5vZmZzZXRWID0gby5kb20uZGF0YSh0aGlzLmVsLCAib2N0b3B1c3VpLWJhY2sydG9wLW9mZnNldCIpIHx8IHRoaXMub2Zmc2V0VjsKICAgICAgICAgICAgdGhpcy5jdXN0b21pemUgPSBvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktYmFjazJ0b3AtY3VzdG9taXplIik7CiAgICAgICAgICAgIHRoaXMudGVzdEZpeGFibGVEb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIG51bGwsIHsKICAgICAgICAgICAgICAgIHRvcDogIjVweCIsCiAgICAgICAgICAgICAgICBwb3NpdGlvbjogImZpeGVkIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYodGhpcy5pc1Nob3cpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNTaG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnNob3coKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNoZWNrRG9tKCk7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50KCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHJlbmRlcgogICAgICAgICAqIEBkZXNjIOmYsuatouiiq+iwg+eUqAogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGhpcyBjbGFzcyBjYW4ndCByZW5kZXIhIDopIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGNoZWNrRG9tCiAgICAgICAgICogQGRlc2Mg5Yid5aeL5YyWZG9tCiAgICAgICAgICovCiAgICAgICAgY2hlY2tEb206IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICAgIHRoaXMuaXNTaG93ID0gZmFsc2U7CiAgICAgICAgICAgIG8uZG9tLmFkZENsYXNzKHRoaXMuZWwsICJvY3RvcHVzdWktYmFjazJ0b3AiKTsKICAgICAgICAgICAgdGhpcy5pbml0Rml4ZWQoKTsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuZWwucGFyZW50Tm9kZSwKICAgICAgICAgICAgICAgIGJvZHkgPSBkb2N1bWVudC5ib2R5OwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGJvZHk7CiAgICAgICAgICAgIGlmKHBhcmVudCAhPSBib2R5KSB7CiAgICAgICAgICAgICAgICBwYXJlbnQucmVtb3ZlQ2hpbGQodGhpcy5lbCk7CiAgICAgICAgICAgICAgICBib2R5LmFwcGVuZENoaWxkKHRoaXMuZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQodGhpcy50ZXN0Rml4YWJsZURvbSk7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0Lkh0bWxCYWNrMlRvcCIKICAgIH0pOwoKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKiB3ZWJhcHDpgJrnlKjnu4Tku7YKICogbWFzayAgIC0gICDmta7lsYIKICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEByZXF1aXJlIGxpYi9kb20uanMKICogQHJlcXVpcmUgbGliL2V2ZW50LmpzCiAqIEByZXF1aXJlIGxpYi90d2Vlbi5qcwogKiBAcmVxdWlyZSBsaWIvYW5pbWF0ZS5qcwogKiBAcmVxdWlyZSB3aWRnZXQvd2lkZ2V0LmpzCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLldpZGdldC5NYXNrCiAgICAgKiBAcGFyZW50IG9jdG9wdXMuV2lkZ2V0CiAgICAgKiBAZGVzYyDmta7lsYLpga7nvakKICAgICAqIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9IOWPguaVsAogICAgICogQHBhcmFtIG9wdGlvbnMuaXNTY3JvbGwge0Jvb2xlYW59IOa1ruWxgua1ruWHuuaXtu+8jOaYr+WQpuemgeaOieiDjOWQjueahOa7muWKqOadoeS6i+S7tu+8jGZhbHNl56aB5o6J77yM6buY6K6k5YC85Li6ZmFsc2UKICAgICAqIEBwYXJhbSBvcHRpb25zLmFuaW1hdGlvbiB7U3RyaW5nfSDmta7lsYLmta7lh7rnmoTliqjljJbnsbvlnovvvIzpu5jorqTml6DliqjnlLsg5pSv5oyB55qE57G75Z6L5pyJCiAgICAgKiAiZmFkZSIgLS0g5riQ6ZqQ5riQ5Ye6CiAgICAgKiAic2NhbGUiIC0tIOS4remDqOWRvOWHugogICAgICogInJvdGF0ZSIgLS0g5bem5LiK6KeS6L2s5YWlIOW3puS4i+inkui9rOWHugogICAgICogInNsaWRlTGVmdCIsICJzbGlkZVJpZ2h0IiwgInNsaWRlVXAiLCAic2xpZGVEb3duIiAtLSDkuI48b2N0b3B1cy5hbmltYXRpb24+5L+d5oyB5LiA6Ie0CiAgICAgKiBAcGFyYW0gb3B0aW9ucy5pbm5lckhUTUwge1N0cmluZ30g5rWu5bGC5by55Ye655qE5YaF5a65CiAgICAgKi8KICAgIG8uV2lkZ2V0Lk1hc2sgPSBvLmRlZmluZShvLldpZGdldCwgewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1Njcm9sbAogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOaYr+WQpuWPr+S7pea7muWKqCDpu5jorqTkuI3lj6/ku6UKICAgICAgICAgKi8KICAgICAgICBpc1Njcm9sbDogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzUmVzaXplCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOWIpOaWreW9k+WJjeaYr+WQpuWkhOWcqHJlc2l6ZeS6i+S7tuaJp+ihjAogICAgICAgICAqLwogICAgICAgIGlzUmVzaXplOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYW5pbWF0aW9uCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDlj4LmlbAg6KGo5piO5rWu5bGC5rWu5Ye655qE5Yqo55S757G75Z6LCiAgICAgICAgICovCiAgICAgICAgYW5pbWF0aW9uOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBvcmlnaW4KICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOa1ruWxguWKqOeUu+i1t+Wni+eCuSDlj6rmnInlvZNhbmltYXRpb27kuLoic2NhbGUi5pe255Sf5pWICiAgICAgICAgICovCiAgICAgICAgb3JpZ2luOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpbm5lckhUTUwKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOa1ruWxgueahOWGheWuuQogICAgICAgICAqLwogICAgICAgIGlubmVySFRNTDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModGhpcy5lbCwgIm9jdG9wdXN1aS1tYXNrIik7CiAgICAgICAgICAgIGlmKHRoaXMuaW5uZXJIVE1MKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVsLmlubmVySFRNTCA9IHRoaXMuaW5uZXJIVE1MOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGluaXRFdmVudAogICAgICAgICAqIEBkZXNjIOWIneWni+WMluS6i+S7tgogICAgICAgICAqLwogICAgICAgIGluaXRFdmVudDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICF0aGlzLmlzU2Nyb2xsICYmIG8uZXZlbnQub24oZG9jdW1lbnQsICJ0b3VjaG1vdmUiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hNb3ZlLCB0aGlzKSwgZmFsc2UpOwoJCQlvLmV2ZW50Lm9uKHdpbmRvdywgIm9ydGNoYW5nZSIsIG8udXRpbC5iaW5kKHRoaXMuY2FsY1NlbGZTaXplLCB0aGlzKSwgZmFsc2UpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjYWxjU2VsZlNpemUKICAgICAgICAgKiBAZGVzYyDnm5HlkKx3aW5kb3cub25yZXNpemXkuovku7YKICAgICAgICAgKi8KICAgICAgICBjYWxjU2VsZlNpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZighdGhpcy5pc1Jlc2l6ZSkgewogICAgICAgICAgICAgICAgby51dGlsLnJlcXVlc3RBbmltYXRpb24oby51dGlsLmJpbmQodGhpcy5yZWZyZXNoU2l6ZSwgdGhpcykpOwogICAgICAgICAgICAgICAgdGhpcy5pc1Jlc2l6ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaE1vdmUKICAgICAgICAgKiBAZGVzYyBpc1Njcm9sbOS4umZhbHNl5pe2IOemgeaOiea7muWKqOadoeeahOa7muWKqAogICAgICAgICAqLwogICAgICAgIG9uVG91Y2hNb3ZlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuaXNTaG93ICYmIG8uZXZlbnQuc3RvcChlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5NYXNrLnJlbmRlcgogICAgICAgICAqIEBkZXNjIOWkjeWGmeeItuexu+aWueazlQogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oY29udGFpbmVyLCBjbG9uZSwgb3JpZ2luKSB7CiAgICAgICAgICAgIGlmKHRoaXMuYW5pbWF0aW9uID09ICJzY2FsZSIgJiYgb3JpZ2luKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9yaWdpbiA9IG9yaWdpbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBvLldpZGdldC5wcm90b3R5cGUucmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuTWFzay5hY3RpdmF0ZQogICAgICAgICAqIEBkZXNjIOWkjeWGmeeItuexu+aWueazlSDlnKjoioLngrnmiZTov5tkb23mtYHlkI7lgZrnmoTliJ3lp4vljJYKICAgICAgICAgKi8KICAgICAgICBhY3RpdmF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG8uV2lkZ2V0LnByb3RvdHlwZS5hY3RpdmF0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLnJlZnJlc2hTaXplKCk7CiAgICAgICAgICAgIHRoaXMuaW5pdEV2ZW50KCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuTWFzay5yZWZyZXNoU2l6ZQogICAgICAgICAqIEBkZXNjIOiuoeeul+W9k+WJjemBrue9qeeahOWkp+WwjwogICAgICAgICAqLwogICAgICAgIHJlZnJlc2hTaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHBvc2l0aW9uID0gby5kb20uZ2V0U3R5bGUodGhpcy5jb250YWluZXIsICJwb3NpdGlvbiIpOwogICAgICAgICAgICBpZihwb3NpdGlvbiA9PSAic3RhdGljIikgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG8uZG9tLnNldFN0eWxlcyh0aGlzLmVsLCB7CiAgICAgICAgICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICAgICAgICAgICAgbGVmdDogIjBweCIsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IE1hdGgubWF4KHRoaXMuY29udGFpbmVyLnNjcm9sbEhlaWdodCwgdGhpcy5jb250YWluZXIuY2xpZW50SGVpZ2h0KSArICJweCIKICAgICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmlzUmVzaXplID0gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuTWFzay5zaG93CiAgICAgICAgICovCiAgICAgICAgc2hvdzogZnVuY3Rpb24ob3JpZ2luKSB7CiAgICAgICAgICAgIGlmKHRoaXMuaXNTaG93KSByZXR1cm47CiAgICAgICAgICAgIGlmKG9yaWdpbiAmJiBvcmlnaW4gIT0gdGhpcy5vcmlnaW4pIHsKICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luID0gb3JpZ2luOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMub3JpZ2luKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlLndlYmtpdFRyYW5zZm9ybU9yaWdpbiA9IHRoaXMub3JpZ2luLmxlZnQgKyAicHggIiArIHRoaXMub3JpZ2luLnRvcCArICJweCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pc1Nob3cgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLnZpc2liaWxpdHkgPSAidmlzaWJsZSI7CiAgICAgICAgICAgIGlmKCEhdGhpc1t0aGlzLmFuaW1hdGlvbl0pIHsKICAgICAgICAgICAgICAgIHRoaXNbdGhpcy5hbmltYXRpb25dKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuTWFzay5oaWRkZW4KICAgICAgICAgKi8KICAgICAgICBoaWRkZW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZighdGhpcy5pc1Nob3cpICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy5pc1Nob3cgPSBmYWxzZTsKICAgICAgICAgICAgaWYoISF0aGlzW3RoaXMuYW5pbWF0aW9uXSkgewogICAgICAgICAgICAgICAgdGhpc1t0aGlzLmFuaW1hdGlvbl0oZmFsc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5faGlkZGVuKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgX2hpZGRlbgogICAgICAgICAqLwogICAgICAgIF9oaWRkZW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLnZpc2liaWxpdHkgPSAiaGlkZGVuIjsKICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS53ZWJraXRUcmFuc2Zvcm1PcmlnaW4gPSAiIjsKICAgICAgICAgICAgaWYodGhpcy5vcmlnaW4pIHsKICAgICAgICAgICAgICAgIHRoaXMub3JpZ2luID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBmYWRlCiAgICAgICAgICogQHBhcmFtIG91dCB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBmYWRlOiBmdW5jdGlvbihvdXQpIHsKICAgICAgICAgICAgaWYob3V0KSB7CiAgICAgICAgICAgICAgICBuZXcgby5Ud2Vlbih0aGlzLmVsLCAib3BhY2l0eSIsIDAsIDEsIC4zLCBvLnV0aWwuZW1wdHksIHsKICAgICAgICAgICAgICAgICAgICBlYXNlOiAiZWFzZS1vdXQiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5ldyBvLlR3ZWVuKHRoaXMuZWwsICJvcGFjaXR5IiwgMSwgMCwgLjMsIG8udXRpbC5iaW5kKHRoaXMuX2hpZGRlbiwgdGhpcyksIHsKICAgICAgICAgICAgICAgICAgICBlYXNlOiAiZWFzZS1vdXQiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBzY2FsZQogICAgICAgICAqIEBwYXJhbSBvdXQge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgc2NhbGU6IGZ1bmN0aW9uKG91dCkgewogICAgICAgICAgICBpZihvdXQpIHsKICAgICAgICAgICAgICAgIG5ldyBvLlR3ZWVuKHRoaXMuZWwsIFsib3BhY2l0eSIsICItd2Via2l0LXRyYW5zZm9ybSJdLCBbMCwgInNjYWxlKDApIl0sIFsxLCAic2NhbGUoMSkiXSwgLjMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3IG8uVHdlZW4odGhpcy5lbCwgWyJvcGFjaXR5IiwgIi13ZWJraXQtdHJhbnNmb3JtIl0sIFsxLCAic2NhbGUoMSkiXSwgWzAsICJzY2FsZSgwKSJdLCAuMywgby51dGlsLmJpbmQodGhpcy5faGlkZGVuLCB0aGlzKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgcm90YXRlCiAgICAgICAgICogQHBhcmFtIG91dCB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICByb3RhdGU6IGZ1bmN0aW9uKG91dCkgewogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLndlYmtpdFRyYW5zZm9ybU9yaWdpbiA9ICJsZWZ0IGJvdHRvbSI7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgaWYob3V0KSB7CiAgICAgICAgICAgICAgICBuZXcgby5Ud2Vlbih0aGlzLmVsLCBbIm9wYWNpdHkiLCAiLXdlYmtpdC10cmFuc2Zvcm0iXSwgWzAsICJyb3RhdGUoLTkwZGVnKSJdLCBbMSwgInJvdGF0ZSgwZGVnKSJdLCAuMyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXcgby5Ud2Vlbih0aGlzLmVsLCBbIm9wYWNpdHkiLCAiLXdlYmtpdC10cmFuc2Zvcm0iXSwgWzEsICJyb3RhdGUoMGRlZykiXSwgWzAsICJyb3RhdGUoOTBkZWcpIl0sIC4zLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0Ll9oaWRkZW4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNsaWRlTGVmdAogICAgICAgICAqIEBwYXJhbSBvdXQge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgc2xpZGVMZWZ0OiBmdW5jdGlvbihvdXQpIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlKCJzbGlkZSIsICJsZWZ0Iiwgb3V0KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2xpZGVSaWdodAogICAgICAgICAqIEBwYXJhbSBvdXQKICAgICAgICAgKi8KICAgICAgICBzbGlkZVJpZ2h0OiBmdW5jdGlvbihvdXQpIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlKCJzbGlkZSIsICJyaWdodCIsIG91dCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNsaWRlVXAKICAgICAgICAgKiBAcGFyYW0gb3V0CiAgICAgICAgICovCiAgICAgICAgc2xpZGVVcDogZnVuY3Rpb24ob3V0KSB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZSgic2xpZGUiLCAidXAiLCBvdXQpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBzbGlkZURvd24KICAgICAgICAgKiBAcGFyYW0gb3V0CiAgICAgICAgICovCiAgICAgICAgc2xpZGVEb3duOiBmdW5jdGlvbihvdXQpIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlKCJzbGlkZSIsICJkb3duIiwgb3V0KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYW5pbWF0ZQogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGRpcmVjdGlvbiB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBvdXQge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgYW5pbWF0ZTogZnVuY3Rpb24odHlwZSwgZGlyZWN0aW9uLCBvdXQpIHsKICAgICAgICAgICAgdmFyIGZ1bmMgPSBvdXQgPyBvLnV0aWwuZW1wdHkgOiBvLnV0aWwuYmluZCh0aGlzLl9oaWRkZW4sIHRoaXMpOwogICAgICAgICAgICBvLmFuaW1hdGUoewogICAgICAgICAgICAgICAgZWw6IHRoaXMuZWwsCiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgZnVuYzogZnVuYywKICAgICAgICAgICAgICAgIGNvbmZpZzogewogICAgICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogZGlyZWN0aW9uLAogICAgICAgICAgICAgICAgICAgIG91dDogIW91dCwKICAgICAgICAgICAgICAgICAgICBpc0ZhZGU6IHRydWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0Lk1hc2siCiAgICB9KTsKCn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICogd2ViYXBw6YCa55So57uE5Lu2CiAqIG1lbnUgICAtICAg6I+c5Y2VCiAqIEByZXF1aXJlIGxpYi9jbGFzcy5qcwogKiBAcmVxdWlyZSBsaWIvdXRpbC5qcwogKiBAcmVxdWlyZSBsaWIvZG9tLmpzCiAqIEByZXF1aXJlIGxpYi9ldmVudC5qcwogKiBAcmVxdWlyZSBsaWIvdHdlZW4uanMKICogQHJlcXVpcmUgbGliL2FuaW1hdGUuanMKICogQHJlcXVpcmUgd2lkZ2V0L3dpZGdldC5qcwogKi8KOyhmdW5jdGlvbihvLCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAqIEBjbGFzcyBvY3RvcHVzLldpZGdldC5NZW51CiAgICAqIEBwYXJlbnQgb2N0b3B1cy5XaWRnZXQKICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0g5Y+C5pWwCiAgICAqIEBwYXJhbSBvcHRpb25zLmRhdGEge0FycmF5fSDnlJ/miJDoj5zljZXnmoTmlbDmja4KICAgICogQHBhcmFtIG9wdGlvbnMuYW5pbWF0ZVR5cGUge1N0cmluZ30g6I+c5Y2V5YiH5o2i55qE5pe25YCZ55qE5Yqo55S757G75Z6LIOiuvue9ruS4um51bGwg5YiZ5peg5Yqo55S7IOebruWJjeaUr+aMgeeahOexu+Wei+aciXNsaWRlIGZvbGQgZmFkZSBmbGlwIHBvcCByb3RhdGUg6buY6K6k5Li6c2xpZGUKICAgICogQHBhcmFtIG9wdGlvbnMuZGlyZWN0aW9uIHtTdHJpbmd9IOWKqOeUu+aJp+ihjOeahOaWueWQkSDnm67liY3mlK/mjIEgbGVmdCB1cCBkb3duIHJpZ2h0IOm7mOiupOS4umxlZnQKICAgICogQHBhcmFtIG9wdGlvbnMuc2hvd0FuaW1hdGVUeXBlIHtTdHJpbmd9IOiPnOWNleaYvuekuumakOiXj+aXtuWAmeeahOWKqOeUu+exu+WeiyDmlK/mjIHkuI7kvb/nlKgg5ZCMYW5pbWF0ZVR5cGXkuIDoh7Qg6buY6K6k5Li6ZmFkZQogICAgKiBAcGFyYW0gb3B0aW9ucy5iYWNrQ29udGVudCB7U3RyaW5nfSDov5Tlm57oj5zljZXnmoTmlofmoYgg6buY6K6k5Li6Iui/lOWbnuS4iuS4gOe6pyIKICAgICovCiAgICBvLldpZGdldC5NZW51ID0gby5kZWZpbmUoby5XaWRnZXQsIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGF0YQogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAZGVzYyDnlJ/miJDoj5zljZXnmoTmlbDmja7mupAKICAgICAgICAgKi8KICAgICAgICBkYXRhOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBhbmltYXRlVHlwZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5YiH5o2i5pe25L2/55So55qE5Yqo55S757G75Z6LCiAgICAgICAgICovCiAgICAgICAgYW5pbWF0ZVR5cGU6ICJzbGlkZSIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGRpcmVjdGlvbgogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5YiH5o2i5Yqo55S755qE5pa55ZCRCiAgICAgICAgICovCiAgICAgICAgZGlyZWN0aW9uOiAibGVmdCIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHNob3dBbmltYXRlVHlwZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5pi+56S65pe255qE5Yqo55S757G75Z6LCiAgICAgICAgICovCiAgICAgICAgc2hvd0FuaW1hdGVUeXBlOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjdXJyZW50TWVudVVsCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICogQGRlc2Mg5b2T5YmN6KKr5omT5byA55qEbWVudeeahOWuueWZqOiKgueCuQogICAgICAgICAqLwogICAgICAgIGN1cnJlbnRNZW51VWw6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHJvb3RVbAogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIHJvb3RVbDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgb3BlbkxpCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICogQGRlc2Mg5q+P5qyh5bGV5byA55qEbGnoioLngrkKICAgICAgICAgKi8KICAgICAgICBvcGVuTGk6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGJhY2tDb250ZW50CiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDov5Tlm57oj5zljZXnmoTmlofmoYgKICAgICAgICAgKi8KICAgICAgICBiYWNrQ29udGVudDogIui/lOWbnuS4iuS4gOe6pyIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IERJUkVDVElPTgogICAgICAgICAqIEBkZXNjIOeUqOadpeS/neWtmGRpcmVjdGlvbueahOebuOWvueaWueWQkQogICAgICAgICAqLwogICAgICAgIERJUkVDVElPTjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgaWYoIXRoaXMuZGF0YSkJdGhyb3cgbmV3IEVycm9yKCJyZXF1aXJlIHRoZSBwcm9wZXJ0eSBvZiBkYXRhISIpOwogICAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMuYnVpbGRNZW51KHRoaXMuZGF0YSk7CiAgICAgICAgICAgIHRoaXMuRElSRUNUSU9OID0gewogICAgICAgICAgICAgICAgImxlZnQiOiAicmlnaHQiLAogICAgICAgICAgICAgICAgInJpZ2h0IjogImxlZnQiLAogICAgICAgICAgICAgICAgInVwIjogImRvd24iLAogICAgICAgICAgICAgICAgImRvd24iOiAidXAiCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG8uZG9tLnNldFN0eWxlcyh0aGlzLmVsLCB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgICAiLXdlYmtpdC1iYWNrZmFjZS12aXNpYmlsaXR5IjogImhpZGRlbiIKICAgICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgICAgIG8uZG9tLmFkZENsYXNzKHRoaXMuZWwsICJvY3RvcHVzdWktbWVudSIpOwogICAgICAgICAgICB0aGlzLmVsLmFwcGVuZENoaWxkKHJvb3QpOwogICAgICAgICAgICB0aGlzLmdlc3R1cmUocm9vdCkub24oInRhcCIsIG8udXRpbC5iaW5kQXNFdmVudExpc3RlbmVyKHRoaXMub25UYXAsIHRoaXMpKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYnVpbGRNZW51CiAgICAgICAgICogQGRlc2Mg55Sf5oiQ6IqC54K557uT5p6ECiAgICAgICAgICogQHBhcmFtIGRhdGEge0FycmF5fQogICAgICAgICAqIEBwYXJhbSBpc0NoaWxkIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGJ1aWxkTWVudTogZnVuY3Rpb24oZGF0YSwgaXNDaGlsZCkgewogICAgICAgICAgICBpc0NoaWxkID0gaXNDaGlsZCB8fCBmYWxzZTsKICAgICAgICAgICAgdmFyIHVsZG9tID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidWwiKSwKICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICAgICAgICAgICAgbGVuID0gZGF0YS5sZW5ndGgsCiAgICAgICAgICAgICAgICBpID0gMDsKICAgICAgICAgICAgaWYoaXNDaGlsZCkgewogICAgICAgICAgICAgICAgdmFyIGRvbSA9IG8uZG9tLmNyZWF0ZURvbSgibGkiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJjbGFzcyI6ICJvY3RvcHVzdWktbWVudS1yZXR1cm5wYXJlbnQiCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgX2Fkb20gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgICAgICAgICAgICBfYWRvbS5pbm5lckhUTUwgPSB0aGlzLmJhY2tDb250ZW50OwogICAgICAgICAgICAgICAgZG9tLmFwcGVuZENoaWxkKF9hZG9tKTsKICAgICAgICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh1bGRvbSwgIm9jdG9wdXN1aS1tZW51LWNoaWxkbWVudSIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModWxkb20sICJvY3RvcHVzdWktbWVudS11bCIpOwogICAgICAgICAgICAgICAgdGhpcy5yb290VWwgPSB1bGRvbTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBpdGVtRGF0YSA9IGRhdGFbaV0sCiAgICAgICAgICAgICAgICAgICAgbGlkb20gPSBvLmRvbS5jcmVhdGVEb20oImxpIiwgewogICAgICAgICAgICAgICAgICAgICAgICBpZDogaXRlbURhdGEuaWQgfHwgaXRlbURhdGEubmFtZQogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgIGFkb20gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgICAgICAgICAgICBpZihpdGVtRGF0YS5jaGlsZHJlbiAmJiBpdGVtRGF0YS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgby5kb20uYWRkQ2xhc3MobGlkb20sICJvY3RvcHVzdWktbWVudS1oYXNjaGlsZCIpCiAgICAgICAgICAgICAgICAgICAgdmFyIGZyYWdkb20gPSB0aGlzLmJ1aWxkTWVudShpdGVtRGF0YS5jaGlsZHJlbiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihpdGVtRGF0YS5ocmVmKSB7CiAgICAgICAgICAgICAgICAgICAgby5kb20uZGF0YShsaWRvbSwgewogICAgICAgICAgICAgICAgICAgICAgICBocmVmOiBpdGVtRGF0YS5ocmVmCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhZG9tLmlubmVySFRNTCA9IG8udXRpbC5lbmNvZGVIdG1sKGl0ZW1EYXRhLm5hbWUpOwogICAgICAgICAgICAgICAgbGlkb20uYXBwZW5kQ2hpbGQoYWRvbSk7CiAgICAgICAgICAgICAgICBmcmFnZG9tICYmIGxpZG9tLmFwcGVuZENoaWxkKGZyYWdkb20pOwogICAgICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQobGlkb20pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVsZG9tLmFwcGVuZENoaWxkKGZyYWdtZW50KTsKICAgICAgICAgICAgcmV0dXJuIHVsZG9tOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvblRhcAogICAgICAgICAqIEBkZXNjIOebkeWQrOiiq+eCueWHu+S6i+S7tiDkvJrlj5Hlh7roh6rlrprkuYnkuovku7YgIm1lbnUtaXRlbS1vbnRhcCIKICAgICAgICAgKi8KICAgICAgICBvblRhcDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICBvLmV2ZW50LnN0b3AoZSwgdHJ1ZSk7CiAgICAgICAgICAgIHZhciB0ID0gZS50YXJnZXQsCiAgICAgICAgICAgICAgICB0YWduYW1lID0gdC50YWdOYW1lLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIGlmKHRhZ25hbWUgPT0gIkEiKSB7CiAgICAgICAgICAgICAgICB0ID0gdC5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG8uZG9tLmhhc0NsYXNzKHQsICJvY3RvcHVzdWktbWVudS1kaXNhYmxlIikpCXJldHVybjsKICAgICAgICAgICAgdGhpcy5ub3RpZnkoIm1lbnUtaXRlbS1vbnRhcCIsIHQpOwogICAgICAgICAgICBpZihvLmRvbS5oYXNDbGFzcyh0LCAib2N0b3B1c3VpLW1lbnUtaGFzY2hpbGQiKSkgewogICAgICAgICAgICAgICAgdGhpcy5leHBlbmRNZW51KHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG8uZG9tLmhhc0NsYXNzKHQsICJvY3RvcHVzdWktbWVudS1yZXR1cm5wYXJlbnQiKSkgewogICAgICAgICAgICAgICAgdGhpcy5yZXR1cm5QYXJlbnQodCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgcmV0dXJuUGFyZW50CiAgICAgICAgICogQHBhcmFtIGVsCiAgICAgICAgICogQGRlc2Mg54K55Ye76L+U5Zue5oyJ6ZKu5pe26I+c5Y2V55qE5Y+N5bqUCiAgICAgICAgICovCiAgICAgICAgcmV0dXJuUGFyZW50OiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICBvLmRvbS5yZW1vdmVDbGFzcyh0aGlzLm9wZW5MaSwgIm9jdG9wdXN1aS1tZW51LW9wZW5tZW51Iik7CiAgICAgICAgICAgIGlmKHRoaXMuY3VycmVudE1lbnVVbCA9PSB0aGlzLnJvb3RVbCkgewogICAgICAgICAgICAgICAgby5kb20ucmVtb3ZlQ2xhc3ModGhpcy5yb290VWwsICJvY3RvcHVzdWktbWVudS1jaGlsZHZpZXciKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLmN1cnJlbnRNZW51VWwucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIG8uZG9tLnJlbW92ZUNsYXNzKHBhcmVudCwgIm9jdG9wdXN1aS1tZW51LWNoaWxkdmlldyIpOwogICAgICAgICAgICAgICAgby5kb20uYWRkQ2xhc3MocGFyZW50LCAib2N0b3B1c3VpLW1lbnUtb3Blbm1lbnUiKTsKICAgICAgICAgICAgICAgIHRoaXMub3BlbkxpID0gcGFyZW50OwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50TWVudVVsID0gdGhpcy5vcGVuTGkucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGlyZWN0aW9uID0gdGhpcy5ESVJFQ1RJT05bdGhpcy5kaXJlY3Rpb25dIHx8ICJsZWZ0IjsKICAgICAgICAgICAgaWYodGhpcy5hbmltYXRlVHlwZSkgewogICAgICAgICAgICAgICAgdGhpc1t0aGlzLmFuaW1hdGVUeXBlXSh0aGlzLm9wZW5MaSwgZGlyZWN0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjaGFuZ2VkRXhwZW5kSXRlbQogICAgICAgICAqIEBkZXNjIOW9k+WxleW8gOiKgueCueeahOaXtuWAmSDosIPmlbTmoLflvI8KICAgICAgICAgKi8KICAgICAgICBjaGFuZ2VkRXhwZW5kSXRlbTogZnVuY3Rpb24oY2xvc2Vkb20sIGV4cGVuZGRvbSkgewogICAgICAgICAgICB2YXIgdmMgPSAib2N0b3B1c3VpLW1lbnUtY2hpbGR2aWV3IjsKICAgICAgICAgICAgdGhpcy5jdXJyZW50TWVudVVsID0gY2xvc2Vkb207CiAgICAgICAgICAgIGV4cGVuZGRvbSA9PSB0aGlzLnJvb3RVbCA/IG8uZG9tLnJlbW92ZUNsYXNzKHRoaXMucm9vdFVsLCB2YykgOgogICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh0aGlzLnJvb3RVbCwgdmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBleHBlbmRNZW51CiAgICAgICAgICogQHBhcmFtIGRvbSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDlvoXlsZXlvIDnmoTliIbnsbvoioLngrnmk43kvZwKICAgICAgICAgKi8KICAgICAgICBleHBlbmRNZW51OiBmdW5jdGlvbihkb20pIHsKICAgICAgICAgICAgdmFyIGV4cGVuZE1lbnUgPSBkb20uY2hpbGRyZW5bMV0sCiAgICAgICAgICAgICAgICBwYXJlbnQgPSBkb20ucGFyZW50Tm9kZSwKICAgICAgICAgICAgICAgIG9jID0gIm9jdG9wdXN1aS1tZW51LW9wZW5tZW51IjsKICAgICAgICAgICAgaWYodGhpcy5vcGVuTGkpIHsKICAgICAgICAgICAgICAgIG8uZG9tLnJlbW92ZUNsYXNzKHRoaXMub3BlbkxpLCBvYyk7CiAgICAgICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh0aGlzLm9wZW5MaSwgIm9jdG9wdXN1aS1tZW51LWNoaWxkdmlldyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMub3BlbkxpID0gZG9tOwogICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh0aGlzLm9wZW5MaSwgIm9jdG9wdXN1aS1tZW51LW9wZW5tZW51Iik7CiAgICAgICAgICAgIHRoaXMuY2hhbmdlZEV4cGVuZEl0ZW0ocGFyZW50LCBleHBlbmRNZW51KTsKICAgICAgICAgICAgaWYodGhpcy5hbmltYXRlVHlwZSkgewogICAgICAgICAgICAgICAgdGhpc1t0aGlzLmFuaW1hdGVUeXBlXShleHBlbmRNZW51LCB0aGlzLmRpcmVjdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYW5pbWF0ZQogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBkaXJlY3Rpb24ge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gb3V0IHtCb29sZWFufQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0KICAgICAgICAgKiBAZGVzYyDliqjnlLvmlrnms5UKICAgICAgICAgKi8KICAgICAgICBhbmltYXRlOiBmdW5jdGlvbihlbCwgdHlwZSwgZGlyZWN0aW9uLCBvdXQsIGZ1bmMpIHsKICAgICAgICAgICAgdmFyIGZ1bmMgPSBmdW5jIHx8IG8udXRpbC5lbXB0eTsKICAgICAgICAgICAgby5hbmltYXRlKHsKICAgICAgICAgICAgICAgIGVsOiB0aGlzLmVsLAogICAgICAgICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgICAgICAgIGZ1bmM6IGZ1bmMsCiAgICAgICAgICAgICAgICBjb25maWc6IHsKICAgICAgICAgICAgICAgICAgICBkaXJlY3Rpb246IGRpcmVjdGlvbiwKICAgICAgICAgICAgICAgICAgICBvdXQ6ICFvdXQsCiAgICAgICAgICAgICAgICAgICAgaXNGYWRlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAuMwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5NZW51LnNob3cKICAgICAgICAgKiBAZGVzYyDmmL7npLrmjqfku7YKICAgICAgICAgKi8KICAgICAgICBzaG93OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLnNob3cuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgaWYodGhpcy5zaG93QW5pbWF0ZVR5cGUpIHsKICAgICAgICAgICAgICAgIHRoaXNbdGhpcy5zaG93QW5pbWF0ZVR5cGVdKHRoaXMuZWwsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuTWVudS5oaWRkZW4KICAgICAgICAgKiBAZGVzYyDpmpDol4/mjqfku7YKICAgICAgICAgKi8KICAgICAgICBoaWRkZW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgaCA9IG8uV2lkZ2V0LnByb3RvdHlwZS5oaWRkZW47CiAgICAgICAgICAgIGlmKHRoaXMuc2hvd0FuaW1hdGVUeXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB0aGlzW3RoaXMuc2hvd0FuaW1hdGVUeXBlXSh0aGlzLmVsLCBmYWxzZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaC5hcHBseSh0aGF0LCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIHRoYXQucmVzZXRNZW51KCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGguYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXRNZW51KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2xpZGUKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIGRpcmVjdGlvbiB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICBzbGlkZTogZnVuY3Rpb24oZWwsIGRpcmVjdGlvbiwgZnVuYykgewogICAgICAgICAgICB0aGlzLmFuaW1hdGUoZWwsICJzbGlkZSIsIGRpcmVjdGlvbiwgdHJ1ZSwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGZvbGQKICAgICAgICAgKiBAcGFyYW0gZWwKICAgICAgICAgKiBAcGFyYW0gZGlyZWN0aW9uCiAgICAgICAgICogQHBhcmFtIGZ1bmMKICAgICAgICAgKi8KICAgICAgICBmb2xkOiBmdW5jdGlvbihlbCwgZGlyZWN0aW9uLCBmdW5jKSB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZShlbCwgImZvbGQiLCBkaXJlY3Rpb24sIHRydWUsIGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBmYWRlCiAgICAgICAgICogQHBhcmFtIGVsIHtET01FTGVtZW50fQogICAgICAgICAqIEBwYXJhbSBvdXQge0Jvb2xlYW59CiAgICAgICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufQogICAgICAgICAqLwogICAgICAgIGZhZGU6IGZ1bmN0aW9uKGVsLCBvdXQsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlKGVsLCAiZmFkZSIsIG51bGwsIG91dCwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGZsaXAKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIGRpcmVjdGlvbiB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICBmbGlwOiBmdW5jdGlvbihlbCwgZGlyZWN0aW9uLCBmdW5jKSB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZShlbCwgImZsaXAiLCBkaXJlY3Rpb24sIHRydWUsIGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBwb3AKICAgICAgICAgKiBAcGFyYW0gZWwge0RPTUVsZW1lbnR9CiAgICAgICAgICogQHBhcmFtIG91dCB7Qm9vbGVhbn0KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgcG9wOiBmdW5jdGlvbihlbCwgb3V0LCBmdW5jKSB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZShlbCwgInBvcCIsIG51bGwsIG91dCwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHJvdGF0ZQogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAcGFyYW0gb3V0IHtCb29sZWFufQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICByb3RhdGU6IGZ1bmN0aW9uKGVsLCBvdXQsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlKGVsLCAicm90YXRlIiwgbnVsbCwgb3V0LCBmdW5jKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5NZW51LnJlc2V0TWVudQogICAgICAgICAqIEBkZXNjIOmHjee9ruiPnOWNlQogICAgICAgICAqLwogICAgICAgIHJlc2V0TWVudTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMucm9vdFVsICYmIG8uZG9tLnJlbW92ZUNsYXNzKHRoaXMucm9vdFVsLCAib2N0b3B1c3VpLW1lbnUtY2hpbGR2aWV3Iik7CiAgICAgICAgICAgIHRoaXMub3BlbkxpICYmIG8uZG9tLnJlbW92ZUNsYXNzKHRoaXMub3BlbkxpLCAib2N0b3B1c3VpLW1lbnUtb3Blbm1lbnUiKTsKICAgICAgICAgICAgdGhpcy5vcGVuTGkgPSBudWxsOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRNZW51VWwgPSBudWxsOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLldpZGdldC5NZW51IgogICAgfSk7Cgp9KShvY3RvcHVzKTsvKioKICogQGZpbGUKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqIHdlYmFwcOmAmueUqOe7hOS7tgogKiBwaWMtcmVhZGVyICAgLSAgIOWbvueJh+mihOiniAogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQHJlcXVpcmUgbGliL2RvbS5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICogQHJlcXVpcmUgd2lkZ2V0L3dpZGdldC5qcwogKiBAcmVxdWlyZSB3aWRnZXQvbWFzay9tYXNrLmpzCiAqIEByZXF1aXJlIHdpZGdldC9zbGlkZXIvc2xpZGVyLmpzCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIEBjbGFzcwogICAgICogQHBhcmVudCBvY3RvcHVzLldpZGdldC5NYXNrCiAgICAgKiBAcGFyYW0gb3B0cyDkvKDlhaXnmoTlj4LmlbAKICAgICAqIEBwYXJhbSBvcHRzLmltZ0VsIHtET01FbGVtZW50fSDlj6/ku6XpgJrov4fkvKDlhaXkuIDkuKroioLngrnop6PmnpDoioLngrnkuIvmiYDmnInnmoRpbWfmoIfnrb4KICAgICAqIEBwYXJhbSBvcHRzLmltZ3Mge0FycmF5fSDop6PmnpDnmoRpbWfmoIfnrb7pm4blkIgg5Y+v5Lul5LiOaW1nRWzlhbHlrZgKICAgICAqIEBwYXJhbSBvcHRzLm1heFcge051bWJlcn0g5bGP5bmV55qE5a695bqmIOWPr+S8oOWPr+S4jeS8oCDkvKDnmoTlpb3lpITlsJHkuIDmrKFyZXBhaW50CiAgICAgKiBAcGFyYW0gb3B0cy5tYXhIIHtOdW1iZXJ9IOWxj+W5leeahOmrmOW6puWHj+WOuzYwcHgg5Y+v5Lyg5Y+v5LiN5LygIOWQjOS4igogICAgICogQHBhcmFtIG9wdHMuaGFzQnV0dG9uIHtCb29sZWFufSDlkIxvY3RvcHVzLldpZGdldC5TbGlkZXLkuK3nmoRoYXNCdXR0b24g6buY6K6k5Li6ZmFsc2UKICAgICAqIEBwYXJhbSBvcHRzLmhhc0dpem1vcyB7Qm9vbGVhbn0g5ZCM5LiKIOm7mOiupOS4umZhbHNlCiAgICAgKiBAcGFyYW0gb3B0cy5oYXNUaXRsZSB7Qm9vbGVhbn0g5ZCM5LiKIOm7mOiupOS4umZhbHNlCiAgICAgKi8KICAgIG8uV2lkZ2V0LlBpY1JlYWRlciA9IG8uZGVmaW5lKG8uV2lkZ2V0Lk1hc2ssIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaW1nRWwKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDlm77niYfpmIXor7vmtonlj4rliLDnmoTmoLnnu5PngrkKICAgICAgICAgKi8KICAgICAgICBpbWdFbDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc2xpZGVyRWwKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDph4zpnaLkuIDkupvkuJzopb/nmoTlrrnlmagKICAgICAgICAgKi8KICAgICAgICBzbGlkZXJFbDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaW1nQ0VsCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICogQGRlc2Mg5pi+56S65Yy65Z+f5Zu+54mH55qE5a655ZmoCiAgICAgICAgICovCiAgICAgICAgaW1nQ0VsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1Jlc2l6ZQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOagh+W/l+S9jSDkuLrkuoborqlyZXNpemXop6blj5HnmoTlho3lsJHkuIDkupsKICAgICAgICAgKi8KICAgICAgICBpc1Jlc2l6ZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG1heFcKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOWxj+W5leeahOWuveW6pgogICAgICAgICAqLwogICAgICAgIG1heFc6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG1heEgKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOWxj+W5leeahOmrmOW6puWHj+WOuzYwCiAgICAgICAgICovCiAgICAgICAgbWF4SDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaW1ncwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAZGVzYyDkvKDlhaXnmoTlm77niYfoioLngrnpm4blkIgKICAgICAgICAgKi8KICAgICAgICBpbWdzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBkYXRhcwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAZGVzYyDnlJ/miJBzbGlkZXLnmoTmlbDmja4KICAgICAgICAgKi8KICAgICAgICBkYXRhczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc2xpZGVyCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBzbGlkZXI6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGhhc0J1dHRvbgogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOeUn+aIkHNsaWRlcueUqOeahOWPguaVsAogICAgICAgICAqLwogICAgICAgIGhhc0J1dHRvbjogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGhhc0dpem1vcwogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOeUn+aIkHNsaWRlcueUqOeahOWPguaVsAogICAgICAgICAqLwogICAgICAgIGhhc0dpem1vczogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGhhc1RpdGxlCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg55Sf5oiQc2xpZGVy55So55qE5Y+C5pWwCiAgICAgICAgICovCiAgICAgICAgaGFzVGl0bGU6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBvLldpZGdldC5NYXNrLnByb3RvdHlwZS5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHRoaXMuaW1ncyA9IHRoaXMuaW1ncyB8fCBbXTsKICAgICAgICAgICAgdGhpcy5kYXRhcyA9IHRoaXMuZGF0YXMgfHwgW107CiAgICAgICAgICAgIGlmKHRoaXMuaW1nRWwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5pdEltZ0V2ZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hbmltYXRpb24gPSAiZmFkZSI7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgby5ldmVudC5vbih3aW5kb3csICJvcnRjaGFuZ2UiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LmlzUmVzaXplKSB7CiAgICAgICAgICAgICAgICAgICAgby51dGlsLnJlcXVlc3RBbmltYXRpb24oby51dGlsLmJpbmQodGhhdC5jaGVja1NpemUsIHRoYXQpKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LmlzUmVzaXplID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmJ1aWxkU2xpZGVyKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGNoZWNrU2l6ZQogICAgICAgICAqIEBkZXNjIOeUqOS6jua1j+iniOWZqHJlc2l6ZeaXtuWvueS6juWxj+W5leWuvemrmOeahOmHjeaWsOiOt+WPlgogICAgICAgICAqLwogICAgICAgIGNoZWNrU2l6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMubWF4VyA9IG8uZG9tLmdldFNjcmVlbldpZHRoKCk7CiAgICAgICAgICAgIHRoaXMubWF4SCA9IG8uZG9tLmdldFNjcmVlbkhlaWdodCgpIC0gNjA7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyLmVsLnN0eWxlLmhlaWdodCA9IHRoaXMubWF4SCArICJweCI7CiAgICAgICAgICAgIHRoaXMuY2FsY1JlY3Qoby5vbmUoImltZyIsIHRoaXMuaW1nQ0VsKSk7CiAgICAgICAgICAgIHRoaXMuaXNSZXNpemUgPSBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYnVpbGRTbGlkZXIKICAgICAgICAgKiBAZGVzYyDnlJ/miJDoioLngrkKICAgICAgICAgKi8KICAgICAgICBidWlsZFNsaWRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyRWwgPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICJjbGFzcyI6ICJvY3RvcHVzdWktcmVhZGVyLXNsaWRlcmNvbnRhaW5lciIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuaW1nQ0VsID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlYWRlci1pbWdjb250YWluZXIiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2YXIgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgICAgICAgICBpbWdkb20gPSBvLmRvbS5jcmVhdGVEb20oImltZyIsIHsKICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlYWRlci1pbWciCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGNsb3NlZG9tID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAgICAgImNsYXNzIjogIm9jdG9wdXN1aS1yZWFkZXItY2xvc2UiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5pbWdDRWwuYXBwZW5kQ2hpbGQoaW1nZG9tKTsKICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQodGhpcy5pbWdDRWwpOwogICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChjbG9zZWRvbSk7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyRWwuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwogICAgICAgICAgICB0aGlzLmVsLmFwcGVuZENoaWxkKHRoaXMuc2xpZGVyRWwpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBpbml0SW1nRXZlbnQKICAgICAgICAgKi8KICAgICAgICBpbml0SW1nRXZlbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgaW1ncyA9IG8uJCgiaW1nIiwgdGhpcy5pbWdFbCk7CiAgICAgICAgICAgIGlmKCFpbWdzKSAgIHJldHVybjsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5pbWdzLCBvLnV0aWwuYmluZCh0aGlzLmFkZEltZ0V2ZW50LCB0aGlzKSk7CiAgICAgICAgICAgIG8udXRpbC5lYWNoKGltZ3MsIG8udXRpbC5iaW5kKHRoaXMuYWRkSW1nRXZlbnQsIHRoaXMpKTsKICAgICAgICAgICAgdGhpcy5zbGlkZXIgPSBuZXcgby5XaWRnZXQuU2xpZGVyKHsKICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMuZGF0YXMsCiAgICAgICAgICAgICAgICBoYXNCdXR0b246IHRoaXMuaGFzQnV0dG9uLAogICAgICAgICAgICAgICAgYXV0b1BsYXk6IGZhbHNlLAogICAgICAgICAgICAgICAgbG9vcDogZmFsc2UsCiAgICAgICAgICAgICAgICBoYXNHaXptb3M6IHRoaXMuaGFzR2l6bW9zLAogICAgICAgICAgICAgICAgaGFzVGl0bGU6IHRoaXMuaGFzVGl0bGUsCiAgICAgICAgICAgICAgICBsb2FkSW1hZ2VOdW1iZXI6IDEsCiAgICAgICAgICAgICAgICBpc0Rpc2FibGVBOiB0cnVlLAogICAgICAgICAgICAgICAgZGlzU2Nyb2xsOiB0cnVlLAogICAgICAgICAgICAgICAgaWQ6ICJvY3RvcHVzdWktcmVhZGVyLXNsaWRlciIKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGFkZEltZ0V2ZW50CiAgICAgICAgICogQHBhcmFtIGl0ZW0KICAgICAgICAgKiBAcGFyYW0gaW5kZXgKICAgICAgICAgKi8KICAgICAgICBhZGRJbWdFdmVudDogZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKICAgICAgICAgICAgaWYoIW8udXRpbC5pc05vZGUoaXRlbSkgfHwgIWl0ZW0uc3JjKSAgICByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaW1ncy5wdXNoKGl0ZW0pOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBzcmMgPSBpdGVtLnNyYzsKICAgICAgICAgICAgby51dGlsLmxvYWRJbWFnZShzcmMsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgby5kb20uZGF0YShpdGVtLCB7CiAgICAgICAgICAgICAgICAgICAgIm9jdG9wdXN1aS1yZWFkZXItd2lkdGgiOiB0aGlzLndpZHRoLAogICAgICAgICAgICAgICAgICAgICJvY3RvcHVzdWktcmVhZGVyLWhlaWdodCI6IHRoaXMuaGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICJvY3RvcHVzdWktcmVhZGVyLWluZGV4IjogaW5kZXgKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoYXQuZ2VzdHVyZShpdGVtKS5vbigidGFwIiwgby51dGlsLmJpbmQodGhhdC5pdGVtT25UYXAsIHRoYXQpKTsKICAgICAgICAgICAgfSwgby51dGlsLmVtcHR5KTsKICAgICAgICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgICAgICAgICB0aXRsZTogby5kb20uZGF0YShpdGVtLCAib2N0b3B1c3VpLXJlYWRlci10aXRsZSIpIHx8ICIiLAogICAgICAgICAgICAgICAgdXJsOiBvLmRvbS5kYXRhKGl0ZW0sICJvY3RvcHVzdWktcmVhZGVyLXVybCIpIHx8ICIiLAogICAgICAgICAgICAgICAgaW1hZ2VfdXJsOiBvLmRvbS5kYXRhKGl0ZW0sICJvY3RvcHVzdWktcmVhZGVyLXNyYyIpIHx8IHNyYwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmRhdGFzLnB1c2goZGF0YSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGl0ZW1PblRhcAogICAgICAgICAqLwogICAgICAgIGl0ZW1PblRhcDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICBvLmV2ZW50LnN0b3AoZSk7CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDsKICAgICAgICAgICAgdGhpcy5hY3RpdmUgPyB0aGlzLnNob3codGFyZ2V0KSA6IHRoaXMucmVuZGVyKHRoaXMuY29udGFpbmVyIHx8IGRvY3VtZW50LmJvZHksIGZhbHNlLCB0YXJnZXQpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlBpY1JlYWRlci5yZW5kZXIKICAgICAgICAgKi8KICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKGNvbnRhaW5lciwgY2xvbmUsIGRvbSkgewogICAgICAgICAgICB0aGlzLnNsaWRlci5jb250YWluZXIgPSB0aGlzLnNsaWRlckVsOwogICAgICAgICAgICB0aGlzLnNsaWRlci5lbC5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyLmlzU2hvdyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNsaWRlckVsLmFwcGVuZENoaWxkKHRoaXMuc2xpZGVyLmVsKTsKCiAgICAgICAgICAgIG8uV2lkZ2V0LnByb3RvdHlwZS5yZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgdGhpcy5tYXhXID0gdGhpcy5tYXhXIHx8IG8uZG9tLmdldFNjcmVlbldpZHRoKCk7CiAgICAgICAgICAgIHRoaXMubWF4SCA9IHRoaXMubWF4SCB8fCBvLmRvbS5nZXRTY3JlZW5IZWlnaHQoKSAtIDYwOwogICAgICAgICAgICB0aGlzLnNsaWRlci5hY3RpdmF0ZSgpOwogICAgICAgICAgICB0aGlzLnNsaWRlci5lbC5zdHlsZS5jc3NUZXh0ID0gImhlaWdodDogIiArIHRoaXMubWF4SCArICJweDsgd2lkdGg6IDEwMCU7IG92ZXJmbG93OiBoaWRkZW47ICIgKwogICAgICAgICAgICAgICAgImRpc3BsYXk6IG5vbmU7IGxlZnQ6IDA7IHRvcDogMDsgYm90dG9tOiAwOyByaWdodDogMDsgbWFyZ2luOiBhdXRvOyBwb3NpdGlvbjogYWJzb2x1dGU7IjsKICAgICAgICAgICAgdGhpcy5kb21FbWVyZ2VkKGRvbSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuUGljUmVhZGVyLnNob3cKICAgICAgICAgKi8KICAgICAgICBzaG93OiBmdW5jdGlvbihkb20pIHsKICAgICAgICAgICAgby5XaWRnZXQuTWFzay5wcm90b3R5cGUuc2hvdy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICBpZighZG9tKSAgICByZXR1cm47CiAgICAgICAgICAgIHRoaXMuZG9tRW1lcmdlZChkb20pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBfaGlkZGVuCiAgICAgICAgICovCiAgICAgICAgX2hpZGRlbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG8uV2lkZ2V0Lk1hc2sucHJvdG90eXBlLl9oaWRkZW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgdGhpcy5pbWdDRWwuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyLmhpZGRlbigpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBkb21FbWVyZ2VkCiAgICAgICAgICovCiAgICAgICAgZG9tRW1lcmdlZDogZnVuY3Rpb24oZG9tKSB7CiAgICAgICAgICAgIHZhciBjbG9uZWRvbSA9IGRvbS5jbG9uZU5vZGUoKSwKICAgICAgICAgICAgICAgIF9jbG9uZSA9IG8uZG9tLmNsb25lTm9kZSh0aGlzLmltZ0NFbCwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIF9jbG9uZS5hcHBlbmRDaGlsZChjbG9uZWRvbSk7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyRWwucmVwbGFjZUNoaWxkKF9jbG9uZSwgdGhpcy5pbWdDRWwpOwogICAgICAgICAgICB0aGlzLmltZ0NFbCA9IF9jbG9uZTsKICAgICAgICAgICAgdGhpcy5jYWxjUmVjdChkb20pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBsb2FkTGFyZ2VJbWcKICAgICAgICAgKi8KICAgICAgICBsb2FkTGFyZ2VJbWc6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIHZhciBzcmMgPSBvLmRvbS5kYXRhKGVsLCAib2N0b3B1c3VpLXJlYWRlci1zcmMiKSwKICAgICAgICAgICAgICAgIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBpZighc3JjIHx8IG8uZG9tLmRhdGEoZWwsICJvY3RvcHVzdWktcmVhZGVyLWxvYWRlZCIpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNoYW5nZWRWaXNpYmxlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZighby5kb20uaGFzQ2xhc3ModGhpcy5pbWdDRWwsICJvY3RvcHVzdWktcmVhZGVyLWxvYWRpbmciKSkgewogICAgICAgICAgICAgICAgICAgIG8uZG9tLmFkZENsYXNzKHRoaXMuaW1nQ0VsLCAib2N0b3B1c3VpLXJlYWRlci1sb2FkaW5nIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvLnV0aWwubG9hZEltYWdlKG8uZG9tLmRhdGEoZWwsICJvY3RvcHVzdWktcmVhZGVyLXNyYyIpLCBvLnV0aWwuZW1wdHksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRoYXQuY2hhbmdlZFZpc2libGUoZWwpOwogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5jaGFuZ2VkVmlzaWJsZShlbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjaGFuZ2VkVmlzaWJsZQogICAgICAgICAqLwogICAgICAgIGNoYW5nZWRWaXNpYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYoby5kb20uaGFzQ2xhc3ModGhpcy5pbWdDRWwsICJvY3RvcHVzdWktcmVhZGVyLWxvYWRpbmciKSkgewogICAgICAgICAgICAgICAgby5kb20ucmVtb3ZlQ2xhc3ModGhpcy5pbWdDRWwsICJvY3RvcHVzdWktcmVhZGVyLWxvYWRpbmciKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihhcmd1bWVudHNbMF0pIHsKICAgICAgICAgICAgICAgIG8uZG9tLmRhdGEoYXJndW1lbnRzWzBdLCB7CiAgICAgICAgICAgICAgICAgICAgIm9jdG9wdXN1aS1yZWFkZXItbG9hZGVkIjogInRydWUiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNsaWRlci5zaG93KCk7CiAgICAgICAgICAgIHRoaXMuaW1nQ0VsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY2FsY1NjcmVlbgogICAgICAgICAqLwogICAgICAgIGNhbGNSZWN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGVsID0gYXJndW1lbnRzWzBdLAogICAgICAgICAgICAgICAgcmVjdCA9IGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLAogICAgICAgICAgICAgICAgcncgPSByZWN0LndpZHRoLAogICAgICAgICAgICAgICAgcmggPSByZWN0LmhlaWdodCwKICAgICAgICAgICAgICAgIHcgPSBvLmRvbS5kYXRhKGVsLCAib2N0b3B1c3VpLXJlYWRlci13aWR0aCIpIHx8IHJ3LAogICAgICAgICAgICAgICAgaCA9IG8uZG9tLmRhdGEoZWwsICJvY3RvcHVzdWktcmVhZGVyLWhlaWdodCIpIHx8IHJoLAogICAgICAgICAgICAgICAgdCA9IHJlY3QudG9wLAogICAgICAgICAgICAgICAgbCA9IHJlY3QubGVmdCwKICAgICAgICAgICAgICAgIG1heFcgPSB0aGlzLm1heFcsCiAgICAgICAgICAgICAgICBtYXhIID0gdGhpcy5tYXhILAogICAgICAgICAgICAgICAgX3csCiAgICAgICAgICAgICAgICBfaCwKICAgICAgICAgICAgICAgIF90LAogICAgICAgICAgICAgICAgX2w7CiAgICAgICAgICAgIGlmKHcgPD0gbWF4VyAmJiBoIDw9IG1heEgpIHsKICAgICAgICAgICAgICAgIF90ID0gKG1heEggLSBoKSAvIDIgKyAzMDsKICAgICAgICAgICAgICAgIF9sID0gKG1heFcgLSB3KSAvIDI7CiAgICAgICAgICAgICAgICBfdyA9IHc7CiAgICAgICAgICAgICAgICBfaCA9IGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZih3ID4gaCkgewogICAgICAgICAgICAgICAgICAgIF93ID0gbWF4VzsKICAgICAgICAgICAgICAgICAgICBfbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgX2ggPSBoICogX3cgLyB3OwogICAgICAgICAgICAgICAgICAgIF90ID0gKG1heEggLSBfaCkgLyAyICsgMzA7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9oID0gbWF4SDsKICAgICAgICAgICAgICAgICAgICBfdCA9IDMwOwogICAgICAgICAgICAgICAgICAgIF93ID0gdyAqIF9oIC8gaDsKICAgICAgICAgICAgICAgICAgICBfbCA9IChtYXhXIC0gX3cpIC8gMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNsaWRlci5zZWxlY3Qoby5kb20uZGF0YShlbCwgIm9jdG9wdXN1aS1yZWFkZXItaW5kZXgiKSAtIDApOwoKICAgICAgICAgICAgdGhpcy5zbGlkZXJBbmltYXRlKFsibGVmdCIsICJ0b3AiLCAid2lkdGgiLCAiaGVpZ2h0Il0sIFtsLCB0LCBydywgcmhdLCBbX2wsIF90LCBfdywgX2hdLCBlbCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNsaWRlckFuaW1hdGUKICAgICAgICAgKi8KICAgICAgICBzbGlkZXJBbmltYXRlOiBmdW5jdGlvbihwcm9wcywgc3ZzLCBldnMsIGVsKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIG5ldyBvLlR3ZWVuKHRoaXMuaW1nQ0VsLCBwcm9wcywgc3ZzLCBldnMsIC40LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoYXQubG9hZExhcmdlSW1nKGVsKTsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgZWFzZTogImVhc2Utb3V0IiwKICAgICAgICAgICAgICAgIGRlbGF5OiAuNAogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBDTEFTU19OQU1FOiAib2N0b3B1cy5XaWRnZXQuUGljUmVhZGVyIgogICAgfSk7Cgp9KShvY3RvcHVzKTsvKioKICogQGZpbGUKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqIHdlYmFwcOmAmueUqOe7hOS7tgogKiBwcm9ncmVzcyAgIC0gICDlm77niYfpooTop4gKICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEByZXF1aXJlIGxpYi9kb20uanMKICogQHJlcXVpcmUgbGliL2V2ZW50LmpzCiAqIEByZXF1aXJlIHdpZGdldC93aWRnZXQuanMKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICogQGNsYXNzIG9jdG9wdXMuV2lkZ2V0LlByb2dyZXNzCiAgICAgKiBAcGFyZW50IG9jdG9wdXMuV2lkZ2V0CiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7T2JqZWN0fQogICAgICogQHBhcmFtIG9wdGlvbnMuZHVyYXRpb24ge051bWJlcn0gbG9hZGluZ+WKqOeUu+eahOaJp+ihjOaXtumXtCDlnKjosIPnlKhnb1Rv562J5pa55rOV5pe25Y+v6YCa6L+H5Lyg5YWl5Y+C5pWw5pS55Y+YIOm7mOiupDJzCiAgICAgKiBAdHlwZSB7KnxGdW5jdGlvbnxuZXd9CiAgICAgKi8KICAgIG8uV2lkZ2V0LlByb2dyZXNzID0gby5kZWZpbmUoby5XaWRnZXQsIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgdmFsdWUKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOiusOW9leeahOiKgueCueeahHRyYW5zbGF0ZeWAvAogICAgICAgICAqLwogICAgICAgIHZhbHVlOiAxMDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0CiAgICAgICAgICogQHByb3BlcnR5IHNwZWVkCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDoh6rliqjliqDovb3nirbmgIHkuIvnmoTluLjph4/lj4LmlbAg5YW25a6e5LiO6YCf5bqm5peg5YWzCiAgICAgICAgICovCiAgICAgICAgc3BlZWQ6IDAuNDksCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0CiAgICAgICAgICogQHByb3BlcnR5IG1pblYKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOiHquWKqOWKoOi9veeKtuaAgeS4i+WPmOWMlumHj+eahOacgOWwj+WAvAogICAgICAgICAqLwogICAgICAgIG1pblY6IDAuNjAwMDksCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGR1cmF0aW9uCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyBsb2FkaW5n5Yqo55S755qE5omn6KGM5pe26Ze0CiAgICAgICAgICovCiAgICAgICAgZHVyYXRpb246IDIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHRpbWVyCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmiafooYznmoTlrprml7blmagKICAgICAgICAgKi8KICAgICAgICB0aW1lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3QKICAgICAgICAgKiBAcHJvcGVydHkgdHJpY2tlcgogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg6Ieq5Yqo5Yqg6L2954q25oCB5LiL55qE5rWu5Yqo5Y+Y6YePCiAgICAgICAgICovCiAgICAgICAgdHJpY2tlcjogMTAwLjAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzU3RvcAogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOagh+W/l+S9jeagh+W/l+W9k+WJjeaYr+WQpuWkhOS6juiHquWKqOWKoOi9veeKtuaAgQogICAgICAgICAqLwogICAgICAgIGlzU3RvcDogdHJ1ZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgdHJpY2tlVGltZXIKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOiHquWKqOWKoOi9veeahOWumuaXtuWZqAogICAgICAgICAqLwogICAgICAgIHRyaWNrZVRpbWVyOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBvLldpZGdldC5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh0aGlzLmVsLCAib2N0b3B1c3VpLXByb2dyZXNzIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGFjdGl2YXRlCiAgICAgICAgICogQGRlc2Mg5bCG5rKh5pyJcG9zaXRpb27lsZ7mgKfnmoToioLngrnmlLnkuLpyZWxhdGl2ZQogICAgICAgICAqLwogICAgICAgIGFjdGl2YXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmFjdGl2YXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGlmKG8uZG9tLmdldFN0eWxlKHRoaXMuY29udGFpbmVyLCAicG9zaXRpb24iKSA9PSAic3RhdGljIikgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuUHJvZ3Jlc3MuZ29UbwogICAgICAgICAqIEBwYXJhbSBvcHZzIOWPguaVsAogICAgICAgICAqIEBwYXJhbSBvcHZzLnZhbHVlIHtOdW1iZXJ9IOiuvue9rmxvYWTnmoTkvY3nva4g5Y+W5YC86IyD5Zu05Li6MC0xMDAKICAgICAgICAgKiBAcGFyYW0gb3B2cy5kdXJhdGlvbiB7TnVtYmVyfSDorr7nva5sb2FkaW5n5Yqo55S755qE5pe26Ze0IOm7mOiupOS4ujIKICAgICAgICAgKiBAcGFyYW0gb3B2cy50eXBlIHtTdHJpbmd9IOiuvue9rmxvYWTkvY3nva7mmK/lkKbkvb/nlKjliqjnlLsg6buY6K6k5LiN5L2/55SoIOiLpemcgOimgeS9v+eUqOWKqOeUuyDor7forr7nva7kuLogImFuaW1hdGlvbiIKICAgICAgICAgKiBAcGFyYW0gb3B2cy5mdW5jIHtGdW5jdGlvbn0g6K6+572u5a6M55qE5Zue6LCD5Ye95pWwIOivt+azqOaEj+S4jeimgeWGjeWbnuiwg+S4reS9v+eUqGdvVG/jgIFwYXNzVHJpY2vnrYnmlrnms5Ug5ZCm5YiZ5Zue6YCg5oiQ6Ieq5byV55SoCiAgICAgICAgICogQGRlc2Mg6K6+572ubG9hZOihjOS4ugogICAgICAgICAqLwogICAgICAgIGdvVG86IGZ1bmN0aW9uKG9wdnMpIHsKICAgICAgICAgICAgaWYoIXRoaXMuaXNTdG9wKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9nb1RvKG9wdnMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBfZ29UbwogICAgICAgICAqIEBwYXJhbSBvcHZzIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgX2dvVG86IGZ1bmN0aW9uKG9wdnMpIHsKICAgICAgICAgICAgdmFyIHYgPSBNYXRoLm1heChNYXRoLm1pbigxMDAgLSBNYXRoLmFicyhvcHZzLnZhbHVlKSwgMTAwKSwgMCksCiAgICAgICAgICAgICAgICBkID0gb3B2cy5kdXJhdGlvbiB8fCB0aGlzLmR1cmF0aW9uLAogICAgICAgICAgICAgICAgdCA9IG9wdnMudHlwZSB8fCAiYXV0byIsCiAgICAgICAgICAgICAgICB2YWx1ZSA9ICJ0cmFuc2xhdGUzZCgtIiArIFN0cmluZyh2KSArICIlLCAwLCAwKSIsCiAgICAgICAgICAgICAgICBmdW5jID0gb3B2cy5mdW5jOwogICAgICAgICAgICBpZih0ID09ICJhdXRvIikgewogICAgICAgICAgICAgICAgdGhpcy5zZXRTdHlsZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICBmdW5jICYmIGZ1bmMoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gIiAiICsgZCArICJzIGxpbmVhciIsCiAgICAgICAgICAgICAgICAgICAgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlLndlYmtpdFRyYW5zaXRpb24gPSAiLXdlYmtpdC10cmFuc2Zvcm0iICsgdDsKICAgICAgICAgICAgICAgIHRoaXMuZWwuc3R5bGUudHJhbnNpdGlvbiA9ICJ0cmFuc2Zvcm0iICsgdDsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRoYXQuc2V0U3R5bGUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgIGlmKHRoYXQudGltZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGF0LnRpbWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50aW1lciA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBzZWxmID0gdGhhdDsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWwuc3R5bGUud2Via2l0VHJhbnNpdGlvbiA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmVsLnN0eWxlLnRyYW5zaXRpb24gPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyAmJiBmdW5jKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgZCAqIDEwMDAgKyAxNTApOwogICAgICAgICAgICAgICAgfSwgMTAwKTsgICAgLy/lvZPpobXpnaLliqjnlLvpnZ7luLjlpJrnmoTml7blgJkg6L+Z5Liq5pe25YCZ57uZ5LiA5LiqMG1z55qE5bu25pe25a+55LqO5o6n5Lu26Ieq6Lqr55qE5Yqo55S75pi+5b6X5p2v5rC06L2m6JaqCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zZXRWKHYpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBzZXRTdHlsZQogICAgICAgICAqIEBwYXJhbSB2IHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg6K6+572uZWznmoR0cmFuc2Zvcm3lgLwKICAgICAgICAgKi8KICAgICAgICBzZXRTdHlsZTogZnVuY3Rpb24odikgewogICAgICAgICAgICBvLmRvbS5zZXRTdHlsZXModGhpcy5lbCwgewogICAgICAgICAgICAgICAgIi13ZWJraXQtdHJhbnNmb3JtIjogdiwKICAgICAgICAgICAgICAgICJ0cmFuc2Zvcm0iOiB2CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlByb2dyZXNzLnN0b3AKICAgICAgICAgKiBAZGVzYyDlgZzmraLoh6rliqjliqDovb3mlrnms5UKICAgICAgICAgKi8KICAgICAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy50cmlja2VUaW1lcikgewogICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLnRyaWNrZVRpbWVyKTsKICAgICAgICAgICAgICAgIHRoaXMudHJpY2tlVGltZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNldFYKICAgICAgICAgKiBAcGFyYW0gdgogICAgICAgICAqIEBkZXNjIOiuvue9ruW9k+WJjeeahHZhbHVl5YC8CiAgICAgICAgICovCiAgICAgICAgc2V0VjogZnVuY3Rpb24odikgewogICAgICAgICAgICBpZih0aGlzLnZhbHVlID09IHYpIHJldHVybjsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHY7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuUHJvZ3Jlc3MucGFzc0FsbAogICAgICAgICAqIEBkZXNjIOeUqOWBt+aHkueahOaWueazleaXoOmZkOaOpei/keS6juWKoOi9veaIkOWKnwogICAgICAgICAqLwogICAgICAgIHBhc3NUcmljazogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaXNTdG9wID0gZmFsc2U7CiAgICAgICAgICAgIGlmKCFhcmd1bWVudHNbMF0pIHsKICAgICAgICAgICAgICAgIHRoaXMudHJpY2tlciA9IDEwMCAqIHRoaXMuc3BlZWQ7CiAgICAgICAgICAgICAgICB0aGlzLnZhbHVlID0gMTAwOwogICAgICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS53ZWJraXRUcmFuc2l0aW9uID0gIiI7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlLnRyYW5zaXRpb24gPSAiIjsKICAgICAgICAgICAgICAgIHRoaXMuc2V0U3R5bGUoInRyYW5zbGF0ZTNkKC0xMDAlLCAwLCAwKSIpOwogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5fZ29Ubyh7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0aGF0LnRyaWNrZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJhbmltYXRpb24iCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgdGhpcy50cmlja2VUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KG8udXRpbC5iaW5kKHRoaXMuZXhlY3V0ZVRyaWNrZXIsIHRoaXMpLCB0aGlzLmR1cmF0aW9uICogMTAwMCArIDEwMCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGV4ZWN1dGVUcmlja2VyCiAgICAgICAgICogQGRlc2Mg5YW35L2T5omn6KGM6Ieq5Yqo5Yqg6L2955qE5pa55rOVCiAgICAgICAgICovCiAgICAgICAgZXhlY3V0ZVRyaWNrZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnRyaWNrZXIgPSB0aGlzLnRyaWNrZXIgKiB0aGlzLnNwZWVkOwogICAgICAgICAgICBpZih0aGlzLnRyaWNrZXIgPCB0aGlzLm1pblYpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNTdG9wID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2dvVG8oewogICAgICAgICAgICAgICAgdmFsdWU6IDEwMCAtIHRoaXMudmFsdWUgKyB0aGlzLnRyaWNrZXIsCiAgICAgICAgICAgICAgICB0eXBlOiAiYW5pbWF0aW9uIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5wYXNzVHJpY2sodHJ1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0LlByb2dyZXNzIgogICAgfSk7Cgp9KShvY3RvcHVzKTsKLyoqCiAqIEBmaWxlCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKiB3ZWJhcHDpgJrnlKjnu4Tku7YKICogcmVmcmVzaCAgIC0gICDkuIrmi4nkuIvmi4nliLfmlrAKICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEByZXF1aXJlIGxpYi9kb20uanMKICogQHJlcXVpcmUgbGliL2V2ZW50LmpzCiAqIEByZXF1aXJlIHdpZGdldC93aWRnZXQuanMKICovCjsoZnVuY3Rpb24obywgdW5kZWZpbmVkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICogQGNsYXNzIG9jdG9wdXMuV2lkZ2V0LlJlZnJlc2gKICAgICAqIEBwYXJlbnQgb2N0b3B1cy5XaWRnZXQKICAgICAqIEBkZXNjIOS4iuaLieS4i+aLieWIt+aWsAogICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0g5o6l5Y+X55qE5Y+C5pWwCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5kaXJlY3Rpb24ge1N0cmluZ30g6KGo5piO5piv5LiK5ouJfOS4i+aLieWIt+aWsOaOp+S7tiAidXAifCJkb3duIiDpu5jorqTmmK/kuIrmi4nliLfmlrDmjqfku7YKICAgICAqIEBwYXJhbSBvcHRpb25zLmhlaWdodCB7TnVtYmVyfSDmjqfku7bnmoTpq5jluqYKICAgICAqIEBwYXJhbSBvcHRpb25zLm1heFRyYW5zbGF0ZSB7TnVtYmVyfSDmjqfku7blj6/ku6Xmi4nliqjnmoTmnIDlpKfplb/luqYg6buY6K6k5Li6MTAwIOeUseS6juS4uuS6humBv+WFjem6u+eDpueahOWkmuasoeWkhOeQhiDkuIvmi4nliLfmlrDnmoTmnIDlpKfpq5jluqbkuLrmraTlgLzkuI7mjqfku7bpq5jluqbnmoTlt67lgLwKICAgICAqIEBwYXJhbSBvcHRpb25zLmhhbGZUcmFuc2xhdGUge051bWJlcn0g5p2+5omL5Yqg6L2955qE5Li055WM5YC8CiAgICAgKiBAcGFyYW0gb3B0aW9ucy5wdWxsVGV4dCB7U3RyaW5nfSDmmL7npLrkuLvljLrln5/nmoTmloflrZcKICAgICAqIEBwYXJhbSBvcHRpb25zLmNoYW5nZVB1bGxUZXh0IHtTdHJpbmd9IOaYvuekuuS4u+WMuuWfn+WcqOS4tOeVjOWAvOeahOaWh+WtlwogICAgICogQHBhcmFtIG9wdGlvbnMuc3RhdHVzVGV4dCB7U3RyaW5nfSDmmL7npLrmrKHljLrln5/nmoTmloflrZcKICAgICAqIEBwYXJhbSBvcHRpb25zLmNoYW5nZVN0YXR1c1RleHQge1N0cmluZ30g5pi+56S65qyh5Yy65Z+f5Zyo5Li055WM5YC855qE5paH5a2XCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5sb2FkVGV4dCB7U3RyaW5nfSDliqDovb3kuK3nmoTmloflrZcKICAgICAqLwogICAgby5XaWRnZXQuUmVmcmVzaCA9IG8uZGVmaW5lKG8uV2lkZ2V0LCB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGRpcmVjdGlvbgogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5Yi35paw55qE5pyd5ZCRIOm7mOiupOWQkeS4iuWIt+aWsAogICAgICAgICAqLwogICAgICAgIGRpcmVjdGlvbjogInVwIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZHJhZ0RpcmVjdGlvbgogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5b2T5YmN5ouW5ou955qE5pa55ZCRCiAgICAgICAgICovCiAgICAgICAgZHJhZ0RpcmVjdGlvbjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgdGltZXIKICAgICAgICAgKiBAdHlwZSB7RnVuY3Rpb259CiAgICAgICAgICogQGRlc2Mg5b2TdG91Y2jml7bot5HnmoTlrprml7bmnJ/nqIvluo8KICAgICAgICAgKi8KICAgICAgICB0aW1lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNEcmFnCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOagh+W/l+aYr+WQpuWkhOS6juaLluaLveeKtuaAgQogICAgICAgICAqLwogICAgICAgIGlzRHJhZzogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHBhZ2VEcmFnQwogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg5ouW5ou954K555qEeeWdkOaghwogICAgICAgICAqLwogICAgICAgIHBhZ2VEcmFnU3RhcnRDOiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBwYWdlRHJhZ0Rvd24KICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOaLluaLvee7k+adn+eCueeahHnlnZDmoIcKICAgICAgICAgKi8KICAgICAgICBwYWdlRHJhZ0VuZEM6IDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHBhZ2VEcmFnVGVtcEMKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOS4remXtOaLluaLveeCueeahHnlnZDmoIcKICAgICAgICAgKi8KICAgICAgICBwYWdlRHJhZ1RlbXBDOiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBoZWlnaHQKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOaOp+S7tumrmOW6pgogICAgICAgICAqLwogICAgICAgIGhlaWdodDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbWF4VHJhbnNsYXRlCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmjqfku7bnmoTmnIDlpKfmi5bliqjot53nprsKICAgICAgICAgKi8KICAgICAgICBtYXhUcmFuc2xhdGU6IDEwMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaGFsZlRyYW5zbGF0ZQogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg5o6n5Lu255qE5Li055WM6Led56a7CiAgICAgICAgICovCiAgICAgICAgaGFsZlRyYW5zbGF0ZTogMzAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFycm93CiAgICAgICAgICogQGRlc2Mg566t5aS055qE6IqC54K5CiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgYXJyb3c6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHB1bGxUZXh0RG9tCiAgICAgICAgICogQGRlc2Mg5Li75pi+56S65Yy66IqC54K5CiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgcHVsbFRleHREb206IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHB1bGxUZXh0CiAgICAgICAgICogQGRlc2Mg5Li75pi+56S65Yy65paH5a2XCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBwdWxsVGV4dDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY2hhbmdlUHVsbFRleHQKICAgICAgICAgKiBAZGVzYyDkuLTnlYzml7bkuLvmmL7npLrljLrmloflrZcKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGNoYW5nZVB1bGxUZXh0OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBzdGF0dXNUZXh0RG9tCiAgICAgICAgICogQGRlc2Mg54q25oCB5Yy65paH5a2X6IqC54K5CiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgc3RhdHVzVGV4dERvbTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbG9hZGluZ0RvbQogICAgICAgICAqIEBkZXNjIGxvYWRpbmfoioLngrkKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBsb2FkaW5nRG9tOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBzdGF0dXNUZXh0CiAgICAgICAgICogQGRlc2Mg54q25oCB5Yy65paH5a2XCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBzdGF0dXNUZXh0OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBsb2FkVGV4dAogICAgICAgICAqIEBkZXNjIOWKoOi9veaXtueahOaWh+WtlwogICAgICAgICAqLwogICAgICAgIGxvYWRUZXh0OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjaGFuZ2VTdGF0dXNUZXh0CiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDkuLTnlYzml7bnirbmgIHljLrmloflrZcKICAgICAgICAgKi8KICAgICAgICBjaGFuZ2VTdGF0dXNUZXh0OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB0cmFuc2xhdGVWCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDlvZPliY3oioLngrnnmoR0cmFuc2xhdGXlgLwKICAgICAgICAgKi8KICAgICAgICB0cmFuc2xhdGVWOiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc0xvY2tlZAogICAgICAgICAqIEBkZXNjIOmUgeWumuagh+W/l+S9jQogICAgICAgICAqLwogICAgICAgIGlzTG9ja2VkOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgby5kb20uYXR0cih0aGlzLmVsLCB7CiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlZnJlc2ggb2N0b3B1c3VpLXJlZnJlc2giICsgby51dGlsLmNhbWVsaXplKHRoaXMuZGlyZWN0aW9uKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5idWlsZFNlbGYoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgdXBkYXRlVHJhbnNsYXRlVgogICAgICAgICAqIEBkZXNjIOabtOaWsOW9k+WJjeeahHRyYW5zbGF0ZeWAvAogICAgICAgICAqLwogICAgICAgIHVwZGF0ZVRyYW5zbGF0ZVY6IGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgaWYodGhpcy50cmFuc2xhdGVWID09IHYpICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy50cmFuc2xhdGVWID0gdjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYnVpbGRTZWxmCiAgICAgICAgICogQGRlc2Mg5Yid5aeL5YyW6Ieq6Lqr6IqC54K5CiAgICAgICAgICovCiAgICAgICAgYnVpbGRTZWxmOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGRyID0gdGhpcy5kaXJlY3Rpb24sCiAgICAgICAgICAgICAgICBjb25maWcgPSBvLldpZGdldC5SZWZyZXNoLmNvbmZpZzsKICAgICAgICAgICAgdGhpcy5hcnJvdyA9IG8uZG9tLmNyZWF0ZURvbSgiZGl2IiwgewogICAgICAgICAgICAgICAgImNsYXNzIjogY29uZmlnW2RyXVsiYXJyb3dDIl0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciB0ZXh0RG9tID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAgICAgImNsYXNzIjogIm9jdG9wdXN1aS1yZWZyZXNoLXRleHRjb250YWluZXIiCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHRjb250YWluZXIgPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlZnJlc2gtcmVmcmVzaGNvbnRhaW5lciIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnB1bGxUZXh0RG9tID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlZnJlc2gtcHVsbHRleHQgb2N0b3B1c3VpLXRleHQtbGltaXQiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnN0YXR1c1RleHREb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsICB7CiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlZnJlc2gtc3RhdHVzdGV4dCBvY3RvcHVzdWktdGV4dC1saW1pdCIKICAgICAgICAgICAgfSkKICAgICAgICAgICAgdGhpcy5sb2FkaW5nRG9tID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXJlZnJlc2gtbG9hZGluZyIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVGV4dCgicHVsbFRleHQiLCAic3RhdHVzVGV4dCIpOwogICAgICAgICAgICB0ZXh0RG9tLmFwcGVuZENoaWxkKHRoaXMucHVsbFRleHREb20pOwogICAgICAgICAgICB0ZXh0RG9tLmFwcGVuZENoaWxkKHRoaXMuc3RhdHVzVGV4dERvbSk7CiAgICAgICAgICAgIHRjb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5hcnJvdyk7CiAgICAgICAgICAgIHRjb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5sb2FkaW5nRG9tKTsKICAgICAgICAgICAgdGNvbnRhaW5lci5hcHBlbmRDaGlsZCh0ZXh0RG9tKTsKICAgICAgICAgICAgdGhpcy5lbC5hcHBlbmRDaGlsZCh0Y29udGFpbmVyKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgdG9nZ2xlTG9hZGluZwogICAgICAgICAqLwogICAgICAgIHRvZ2dsZUxvYWRpbmc6IGZ1bmN0aW9uKGV4aXN0KSB7CiAgICAgICAgICAgIGlmKCFleGlzdCAmJiB0aGlzLmxvYWRpbmdEb20uc3R5bGUuZGlzcGxheSAhPSAibm9uZSIpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9hZGluZ0RvbS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgICB9IGVsc2UgaWYoZXhpc3QgJiYgdGhpcy5sb2FkaW5nRG9tLnN0eWxlLmRpc3BsYXkgIT0gImJsb2NrIikgewogICAgICAgICAgICAgICAgdGhpcy5sb2FkaW5nRG9tLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuUmVmcmVzaC5yZW5kZXIKICAgICAgICAgKi8KICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBvLldpZGdldC5wcm90b3R5cGUucmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGlmKHRoaXMuaGVpZ2h0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gby5kb20uZ2V0SGVpZ2h0KHRoaXMuZWwpOwogICAgICAgICAgICB9CgkJCXRoaXMuYWRkRXZlbnQoKTsKICAgICAgICAgICAgby5kb20uc2Nyb2xsTGl0ZSh0aGlzLmNvbnRhaW5lci5wYXJlbnROb2RlLCBmYWxzZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGFwcGVuZENoaWxkCiAgICAgICAgICogQHBhcmFtIGVsCiAgICAgICAgICogQHBhcmFtIGNvbnRhaW5lcgogICAgICAgICAqIEBkZXNjIOWkjeWGmeeItuexu+eahGFwcGVuZENoaWxkIOWinuWKoOaPkuWFpeacgOWJjeeahOWkhOeQhgogICAgICAgICAqLwogICAgICAgIGFwcGVuZENoaWxkOiBmdW5jdGlvbihlbCwgY29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmKHRoaXMuZGlyZWN0aW9uID09ICJ1cCIpIHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChlbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvLmRvbS5pbnNlcnRGaXJzdChlbCwgY29udGFpbmVyKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBhZGRFdmVudAogICAgICAgICAqIEBkZXNjIOS6i+S7tuebkeWQrAogICAgICAgICAqLwogICAgICAgIGFkZEV2ZW50OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5ldmVudC5vbihkb2N1bWVudCwgInRvdWNoc3RhcnQiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hTdGFydCwgdGhpcyksIGZhbHNlKTsKICAgICAgICAgICAgby5ldmVudC5vbihkb2N1bWVudCwgInRvdWNoZW5kIiwgby51dGlsLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcy5vblRvdWNoRW5kLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICBvLmV2ZW50Lm9uKGRvY3VtZW50LCAidG91Y2hjYW5jZWwiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hFbmQsIHRoaXMpLCBmYWxzZSk7CiAgICAgICAgICAgIG8uZXZlbnQub24oZG9jdW1lbnQsICJ0b3VjaG1vdmUiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hNb3ZlLCB0aGlzKSwgZmFsc2UpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvblRvdWNoU3RhcnQKICAgICAgICAgKiBAZGVzYyDnm5HlkKx0b3VjaHN0YXJ05LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgb25Ub3VjaFN0YXJ0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIG8uZXZlbnQuc3RvcChlLCB0cnVlKTsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgdG91Y2hlcyA9IGUudG91Y2hlczsKICAgICAgICAgICAgaWYoIXRvdWNoZXMgfHwgdG91Y2hlcy5sZW5ndGggPiAxKSAgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzRHJhZyA9IHRydWU7CiAgICAgICAgICAgIHZhciB0b3VjaCA9IHRvdWNoZXNbMF0sCiAgICAgICAgICAgICAgICBkYyA9IHRvdWNoLnBhZ2VZOwogICAgICAgICAgICB0aGlzLnBhZ2VEcmFnU3RhcnRDID0gdGhpcy5wYWdlRHJhZ1RlbXBDID0gZGM7CiAgICAgICAgICAgIHRoaXMudGltZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LnRpbWVyKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZih0aGF0LnBhZ2VEcmFnVGVtcEMgPiB0aGF0LnBhZ2VEcmFnU3RhcnRDKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5kcmFnRGlyZWN0aW9uID0gImRvd24iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKHRoYXQucGFnZURyYWdUZW1wQyA8IHRoYXQucGFnZURyYWdTdGFydEMpIHsKCQkJCQl0aGF0LmRyYWdEaXJlY3Rpb24gPSAidXAiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoKHRoYXQucGFnZURyYWdUZW1wQyA9PSB0aGF0LnBhZ2VEcmFnU3RhcnRDKSB8fCAhdGhhdC5hZGp1c3RTY3JvbGxCYXIoKSkgewogICAgICAgICAgICAgICAgICAgIHRoYXQucGFnZURyYWdTdGFydEMgPSB0aGF0LnBhZ2VEcmFnVGVtcEMKICAgICAgICAgICAgICAgICAgICBvLnV0aWwucmVxdWVzdEFuaW1hdGlvbih0aGF0LnRpbWVyKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CgkJCQl9CiAgICAgICAgICAgICAgICB0aGF0LnBhZ2VEcmFnRW5kQyA9IHRoYXQucGFnZURyYWdUZW1wQzsKICAgICAgICAgICAgICAgIHZhciBkaXMgPSAodGhhdC5wYWdlRHJhZ1RlbXBDIC0gdGhhdC5wYWdlRHJhZ1N0YXJ0Qyk7CiAgICAgICAgICAgICAgICB0aGF0LnBhZ2VEcmFnU3RhcnRDID0gdGhhdC5wYWdlRHJhZ1RlbXBDOwogICAgICAgICAgICAgICAgdmFyIHR2YWx1ZSA9IHRoYXQudHJhbnNsYXRlVjsKICAgICAgICAgICAgICAgIHZhciB2LAogICAgICAgICAgICAgICAgICAgIF92ID0gdHZhbHVlICsgZGlzOwogICAgICAgICAgICAgICAgaWYodGhhdC5kaXJlY3Rpb24gPT0gInVwIikgewogICAgICAgICAgICAgICAgICAgIGlmKHRoYXQuZHJhZ0RpcmVjdGlvbiA9PSAidXAiICYmIHRoYXQuaXNMb2NrZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgby51dGlsLnJlcXVlc3RBbmltYXRpb24odGhhdC50aW1lcik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYoX3YgPCAoMCAtIHRoYXQubWF4VHJhbnNsYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2ID0gKDAgLSB0aGF0Lm1heFRyYW5zbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKF92ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB2ID0gMAogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHYgPSBfdjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYodiA8ICgwIC0gdGhhdC5oYWxmVHJhbnNsYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRvZ2dsZVN0eWxlKHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudG9nZ2xlU3R5bGUoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYodGhhdC5kcmFnRGlyZWN0aW9uID09ICJkb3duIiAmJiB0aGF0LmlzTG9ja2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKHRoYXQudGltZXIpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKF92ID4gdGhhdC5tYXhUcmFuc2xhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHRoYXQubWF4VHJhbnNsYXRlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihfdiA8IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdiA9IDA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdiA9IF92OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZih2ID4gKHRoYXQuaGFsZlRyYW5zbGF0ZSArIHRoYXQuaGVpZ2h0KSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRvZ2dsZVN0eWxlKHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudG9nZ2xlU3R5bGUoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoYXQudXBkYXRlVHJhbnNsYXRlVih2KTsKICAgICAgICAgICAgICAgIHZhciBudmFsdWUgPSAidHJhbnNsYXRlM2QoMCwgIiArIHYgKyAicHgiICsgIiwgMCkiOwogICAgICAgICAgICAgICAgdGhhdC5jb250YWluZXIuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gbnZhbHVlOwogICAgICAgICAgICAgICAgby51dGlsLnJlcXVlc3RBbmltYXRpb24odGhhdC50aW1lcik7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG8udXRpbC5yZXF1ZXN0QW5pbWF0aW9uKHRoaXMudGltZXIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCB0b2dnbGVTdHlsZQogICAgICAgICAqIEBwYXJhbSBjaGFuZ2Uge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5L+u5pS55pi+56S65Yy655qE5YaF5a65CiAgICAgICAgICovCiAgICAgICAgdG9nZ2xlU3R5bGU6IGZ1bmN0aW9uKGNoYW5nZSkgewogICAgICAgICAgICBpZihjaGFuZ2UgJiYgIW8uZG9tLmhhc0NsYXNzKHRoaXMuZWwsICJvY3RvcHVzdWktcmVmcmVzaC1jaGFuZ2VkIikpIHsKICAgICAgICAgICAgICAgIG8uZG9tLmFkZENsYXNzKHRoaXMuZWwsICJvY3RvcHVzdWktcmVmcmVzaC1jaGFuZ2VkIik7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVRleHQoImNoYW5nZVB1bGxUZXh0IiwgImNoYW5nZVN0YXR1c1RleHQiKTsKICAgICAgICAgICAgfSBlbHNlIGlmKCFjaGFuZ2UgJiYgby5kb20uaGFzQ2xhc3ModGhpcy5lbCwgIm9jdG9wdXN1aS1yZWZyZXNoLWNoYW5nZWQiKSkgewogICAgICAgICAgICAgICAgby5kb20ucmVtb3ZlQ2xhc3ModGhpcy5lbCwgIm9jdG9wdXN1aS1yZWZyZXNoLWNoYW5nZWQiKTsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVGV4dCgicHVsbFRleHQiLCAic3RhdHVzVGV4dCIpOwogICAgICAgICAgICAgICAgaWYodGhpcy5hcnJvdy5zdHlsZS5kaXNwbGF5ID09ICJub25lIikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXJyb3cuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaE1vdmUKICAgICAgICAgKiBAcGFyYW0gZQogICAgICAgICAqLwogICAgICAgIG9uVG91Y2hNb3ZlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciB0b3VjaGVzID0gZS50b3VjaGVzOwogICAgICAgICAgICBpZighdGhpcy5pc0RyYWcgfHwgIXRvdWNoZXMgfHwgdG91Y2hlcy5sZW5ndGggPiAxKSAgICByZXR1cm47CiAgICAgICAgICAgIHZhciB0b3VjaCA9IHRvdWNoZXNbMF07CgkJCWlmKHRoaXMucGFnZURyYWdUZW1wQyA9PSB0b3VjaC5wYWdlWSkJcmV0dXJuOwoJCQl0aGlzLnBhZ2VEcmFnVGVtcEMgPSB0b3VjaC5wYWdlWTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaEVuZAogICAgICAgICAqLwogICAgICAgIG9uVG91Y2hFbmQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdGhpcy5pc0RyYWcgPSBmYWxzZTsKICAgICAgICAgICAgaWYodGhpcy50aW1lcikgewogICAgICAgICAgICAgICAgdGhpcy50aW1lciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5kaXJlY3Rpb24gPT0gInVwIikgewogICAgICAgICAgICAgICAgaWYodGhpcy50cmFuc2xhdGVWIDwgKDAgLSB0aGlzLmhhbGZUcmFuc2xhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkTW9yZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKCF0aGlzLmlzTG9ja2VkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZVBvc2l0aW9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZih0aGlzLnRyYW5zbGF0ZVYgPiAodGhpcy5oYWxmVHJhbnNsYXRlICsgdGhpcy5oZWlnaHQpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkTW9yZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKCF0aGlzLmlzTG9ja2VkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZVBvc2l0aW9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgbG9hZE1vcmUKICAgICAgICAgKi8KICAgICAgICBsb2FkTW9yZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaXNMb2NrZWQgPSB0cnVlOwogICAgICAgICAgICB2YXIgc3RhcnRWID0gInRyYW5zbGF0ZTNkKDAsICIgKyB0aGlzLnRyYW5zbGF0ZVYgKyAicHgsIDApIiwKICAgICAgICAgICAgICAgIGVuZFYsCiAgICAgICAgICAgICAgICB2OwogICAgICAgICAgICBpZih0aGlzLmRpcmVjdGlvbiA9PSAidXAiKSB7CiAgICAgICAgICAgICAgICBlbmRWID0gInRyYW5zbGF0ZTNkKDAsIDBweCwgMCkiOwogICAgICAgICAgICAgICAgdiA9IDA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmRWID0gInRyYW5zbGF0ZTNkKDAsICIgKyB0aGlzLmhlaWdodCArICJweCwgMCkiOwogICAgICAgICAgICAgICAgdiA9IHRoaXMuaGVpZ2h0OwogICAgICAgICAgICAgICAgdmFyIGRvbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHN0YXJ0ViA9PSBlbmRWKSAgcmV0dXJuOwogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHZhciBsaXN0VHdlZW4gPSBuZXcgby5Ud2Vlbih0aGlzLmNvbnRhaW5lciwgIi13ZWJraXQtdHJhbnNmb3JtIiwgc3RhcnRWLAogICAgICAgICAgICAgICAgZW5kViwgMC4zLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LnVwZGF0ZVRyYW5zbGF0ZVYodik7CiAgICAgICAgICAgICAgICAgICAgdGhhdC51cGRhdGVUZXh0KCJsb2FkVGV4dCIpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuYXJyb3cuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgICAgICAgICB0aGF0LnRvZ2dsZUxvYWRpbmcodHJ1ZSk7CgkJCQkJdGhhdC5ub3RpZnkoInJlZnJlc2gtdWktbG9hZG1vcmUiKTsKICAgICAgICAgICAgICAgICAgICBpZihkb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChkb20pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHsgZWFzZTogImVhc2UtaW4tb3V0IiB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgdXBkYXRlVGV4dAogICAgICAgICAqIEBwYXJhbSBwdCB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBzdCB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHVwZGF0ZVRleHQ6IGZ1bmN0aW9uKHB0LCBzdCkgewogICAgICAgICAgICB2YXIgZHIgPSB0aGlzLmRpcmVjdGlvbiwKICAgICAgICAgICAgICAgIGNvbmZpZyA9IG8uV2lkZ2V0LlJlZnJlc2guY29uZmlnOwogICAgICAgICAgICB0aGlzLnB1bGxUZXh0RG9tLmlubmVySFRNTCA9IG8udXRpbC5lbmNvZGVIdG1sKHRoaXNbcHRdIHx8IGNvbmZpZ1tkcl1bcHRdIHx8IGNvbmZpZ1twdF0pOwogICAgICAgICAgICBpZihzdCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0RG9tLmlubmVySFRNTCA9IG8udXRpbC5lbmNvZGVIdG1sKHRoaXNbc3RdIHx8IGNvbmZpZ1tzdF0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNUZXh0RG9tLmlubmVySFRNTCA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHJlUG9zaXRpb24KICAgICAgICAgKi8KICAgICAgICByZVBvc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5pc0xvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgc3RhcnRWID0gInRyYW5zbGF0ZTNkKDAsICIgKyB0aGlzLnRyYW5zbGF0ZVYgKyAicHgsIDApIiwKICAgICAgICAgICAgICAgIGVuZFYgPSAidHJhbnNsYXRlM2QoMCwgMHB4LCAwKSIsCiAgICAgICAgICAgICAgICB2ID0gMDsKICAgICAgICAgICAgdGhpcy51cGRhdGVUcmFuc2xhdGVWKHYpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVRleHQoInB1bGxUZXh0IiwgInN0YXR1c1RleHQiKTsKICAgICAgICAgICAgdGhpcy50b2dnbGVTdHlsZShmYWxzZSk7CiAgICAgICAgICAgIHRoaXMudG9nZ2xlTG9hZGluZyhmYWxzZSk7CiAgICAgICAgICAgIGlmKHN0YXJ0ViA9PSBlbmRWKSAgcmV0dXJuOwogICAgICAgICAgICB2YXIgZm4gPSBvLnV0aWwuZW1wdHk7CiAgICAgICAgICAgIGlmKHRoaXMuZGlyZWN0aW9uID09ICJkb3duIikgewogICAgICAgICAgICAgICAgdmFyIGRvbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICAgICAgZm4gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGRvbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgbGlzdFR3ZWVuID0gbmV3IG8uVHdlZW4odGhpcy5jb250YWluZXIsICItd2Via2l0LXRyYW5zZm9ybSIsIHN0YXJ0ViwKICAgICAgICAgICAgICAgIGVuZFYsIDAuMywgZm4sIHsgZWFzZTogImVhc2UtaW4tb3V0IiB9KTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGFkanVzdEhhc1Njcm9sbEJhcgogICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufQogICAgICAgICAqLwogICAgICAgIGFkanVzdFNjcm9sbEJhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0cmFuc2xhdGUgPSB0aGlzLnRyYW5zbGF0ZVYsCiAgICAgICAgICAgICAgICBib2R5ID0gZG9jdW1lbnQuYm9keSwKICAgICAgICAgICAgICAgIHNjcm9sbEhlaWdodCA9IGJvZHkuc2Nyb2xsSGVpZ2h0LAogICAgICAgICAgICAgICAgaGVpZ2h0ID0gYm9keS5vZmZzZXRIZWlnaHQsCiAgICAgICAgICAgICAgICB0b3AgPSBib2R5LnNjcm9sbFRvcCwKICAgICAgICAgICAgICAgIF9oZWlnaHQgPSBoZWlnaHQgKyB0b3A7CiAgICAgICAgICAgIHJldHVybiAoTWF0aC5hYnModHJhbnNsYXRlKSA8PSB0aGlzLm1heFRyYW5zbGF0ZSAmJgogICAgICAgICAgICAgICAgKHRoaXMuZGlyZWN0aW9uID09ICJ1cCIgJiYgKF9oZWlnaHQgKyA1KSA+PSBzY3JvbGxIZWlnaHQpIHx8CiAgICAgICAgICAgICAgICAodGhpcy5kaXJlY3Rpb24gPT0gImRvd24iICYmIHRvcCA9PSAwKSk7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0LlJlZnJlc2giCiAgICB9KTsKCiAgICBvY3RvcHVzLldpZGdldC5SZWZyZXNoLmNvbmZpZyA9IHsKICAgICAgICAidXAiOiB7CiAgICAgICAgICAgIGFycm93QzogIm9jdG9wdXN1aS1yZWZyZXNoLWFycm93dXAiLAogICAgICAgICAgICBwdWxsVGV4dDogIuS4iuaLieWPr+S7peWKoOi9veabtOWkmiIKICAgICAgICB9LAogICAgICAgICJkb3duIjogewogICAgICAgICAgICBhcnJvd0M6ICJvY3RvcHVzdWktcmVmcmVzaC1hcnJvd2Rvd24iLAogICAgICAgICAgICBwdWxsVGV4dDogIuS4i+aLieWPr+S7peWKoOi9veabtOWkmiIKICAgICAgICB9LAogICAgICAgIHN0YXR1c1RleHQ6ICLkuIrmrKHmm7TmlrDml7bpl7TvvJoiLAogICAgICAgIGNoYW5nZVB1bGxUZXh0OiAi5p2+5omL5Y+v5Lul5Yqg6L295pu05aSaIiwKICAgICAgICBjaGFuZ2VTdGF0dXNUZXh0OiAiIiwKICAgICAgICBsb2FkVGV4dDogIuWKoOi9veS4rS4uLiIKICAgIH07Cgp9KShvY3RvcHVzKTsKLyoqCiAqIEBmaWxlCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKiB3ZWJhcHDpgJrnlKjnu4Tku7YKICogc2lkZWJhciAgIC0gICDlm5vkvqfpmpDol4/nmoTpnaLmnb8KICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEByZXF1aXJlIGxpYi9kb20uanMKICogQHJlcXVpcmUgbGliL2V2ZW50LmpzCiAqIEByZXF1aXJlIGxpYi90d2Vlbi5qcwogKiBAcmVxdWlyZSBsaWIvYW5pbWF0ZS5qcwogKiBAcmVxdWlyZSB3aWRnZXQvd2lkZ2V0LmpzCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLldpZGdldC5TaWRlYmFyCiAgICAgKiBAcGFyZW50IG9jdG9wdXMuV2lkZ2V0CiAgICAgKiBAZGVzYyDnlKjkuo7lnKjmjIflrprlrrnlmajlm5vkvqfnmoTpnaLmnb8KICAgICAqIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9IOS8oOWFpeeahOWPguaVsAogICAgICogQHBhcmFtIG9wdGlvbnMudHlwZSB7U3RyaW5nfSDpu5jorqTnmoTlsZXnjrDnmoTnsbvlnosg5Y+v6YCJ5YC85YyF5ousIGNvdmVyIHwgcHVzaCB8IHJldmVhbCB8IHJvdGF0ZSDlhbbkuK1yb3RhdGXlnKjkvY7niYjmnKzns7vnu5/kuIp3b3Jr55qE5LiN5aW9CiAgICAgKiBAcGFyYW0gb3B0aW9ucy5uZXh0RG9tIHtET01FbGVtZW50fSDkuI7kuYvlubbliJfnmoToioLngrkg5Y2z5Y+v6KeG5Yy65Z+f5pi+56S655qE5Yy65Z+f6IqC54K5IOWmguaenOexu+Wei+S4unJldmVhbOWImeatpOWPguaVsOS4jeWPr+epuue8ugogICAgICogQHBhcmFtIG9wdGlvbnMucG9zaXRpb24ge1N0cmluZ30g5o6n5Lu26LS06L6555qE5L2N572uIOWPr+mAieWAvOWMheaLrCBsZWZ0IHwgcmlnaHQgfCB0b3AgfCBib3R0b20g6buY6K6k5Li6bGVmdCDkuIDnu4/orr7nva7kuI3lj6/mm7TmlLkKICAgICAqIEBwYXJhbSBvcHRpb25zLndpZHRoIHtOdW1iZXJ9IOaOp+S7tueahOWuveW6piDlj6/kvKDmlbDlrZcg5Y2V5L2N5YOP57SgIOS6puWPr+S8oOWtl+espuS4suW9ouW8j+eahOWPr+abv+S7o+WuveW6pueahOihqOi+viDlpoIxMDAlIOm7mOiupOS4ujEwMCUKICAgICAqIEBwYXJhbSBvcHRpb25zLmhlaWdodCB7TnVtYmVyfSDlkIzpq5jluqYKICAgICAqIEBwYXJhbSBvcHRpb25zLmlubmVySFRNTCB7U3RyaW5nfSDlj6/ku6XkvKDlhaXnmoTmjqfku7bnmoRodG1s5YaF5a65CiAgICAgKi8KICAgIG8uV2lkZ2V0LlNpZGViYXIgPSBvLmRlZmluZShvLldpZGdldCwgewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB0eXBlCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDlsZXnjrDnmoTnsbvlnosKICAgICAgICAgKi8KICAgICAgICB0eXBlOiAiY292ZXIiLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBuZXh0RG9tCiAgICAgICAgICogQHR5cGUge0RPTUVsZW1lbnR9CiAgICAgICAgICogQGRlc2Mg5p+Q5Lqb57G75Z6L6ZyA6KaB5Lyg5YWl5bm25YiX5pi+56S655qE6IqC54K5CiAgICAgICAgICovCiAgICAgICAgbmV4dERvbTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgcG9zaXRpb24KICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOaOp+S7tui0tOi+ueeahOaWueS9jQogICAgICAgICAqLwogICAgICAgIHBvc2l0aW9uOiAibGVmdCIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHdpZHRoCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDlrrnlmajnmoTlrr3luqYg5LiN5bu66K6u5L+u5pS5CiAgICAgICAgICovCiAgICAgICAgd2lkdGg6ICIxMDAlIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaGVpZ2h0CiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDlrrnlmajnmoTpq5jluqYKICAgICAgICAgKi8KICAgICAgICBoZWlnaHQ6ICIxMDAlIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgc3R5bGVzCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKiBAZGVzYyDnlKjmnaXlrZjlj5bkuIDkupvliJ3lp4vmoLflvI/nmoTplK7lgLzlr7kKICAgICAgICAgKi8KICAgICAgICBzdHlsZXM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlubmVySFRNTAogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5o6n5Lu255qE5YaF5a65IOW9k+aOp+S7tuaehOaIkOeugOWNleaXtuWPr+S7peebtOaOpeS8oOWFpSDlpI3mnYLml7blu7rorq7nu6fmib/mraTmjqfku7blvIDlj5EKICAgICAgICAgKi8KICAgICAgICBpbm5lckhUTUw6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzUmVzaXplCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOeUqOS7pXJlc2l6ZQogICAgICAgICAqLwogICAgICAgIGlzUmVzaXplOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbG9ja2VkCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgbG9ja2VkOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgaWYodGhpcy5pbm5lckhUTUwpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWwuaW5uZXJIVE1MID0gdGhpcy5pbm5lckhUTUw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zdHlsZXMgPSB7CiAgICAgICAgICAgICAgICBjc3NUZXh0OiB7CiAgICAgICAgICAgICAgICAgICAgbGVmdDogImxlZnQ6IDBweDsgdG9wOiAwcHg7IiwKICAgICAgICAgICAgICAgICAgICByaWdodDogInJpZ2h0OiAwcHg7IHRvcDogMHB4OyIsCiAgICAgICAgICAgICAgICAgICAgdG9wOiAibGVmdDogMHB4OyB0b3A6IDBweDsiLAogICAgICAgICAgICAgICAgICAgIGJvdHRvbTogImxlZnQ6IDBweDsgYm90dG9tOiAwcHg7IgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogewogICAgICAgICAgICAgICAgICAgIGxlZnQ6ICJ0cmFuc2xhdGUzZCgtMTAwJSwgMCwgMCkiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAidHJhbnNsYXRlM2QoMTAwJSwgMCwgMCkiLAogICAgICAgICAgICAgICAgICAgIHRvcDogInRyYW5zbGF0ZTNkKDAsIC0xMDAlLCAwKSIsCiAgICAgICAgICAgICAgICAgICAgYm90dG9tOiAidHJhbnNsYXRlM2QoMCwgMTAwJSwgMCkiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmKG8udXRpbC5pc051bWVyaWModGhpcy53aWR0aCkpIHsKICAgICAgICAgICAgICAgIHRoaXMud2lkdGggKz0gInB4IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvLnV0aWwuaXNOdW1lcmljKHRoaXMuaGVpZ2h0KSkgewogICAgICAgICAgICAgICAgdGhpcy5oZWlnaHQgKz0gInB4IjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVsLnN0eWxlLmNzc1RleHQgPSB0aGlzLnN0eWxlcy5jc3NUZXh0W3RoaXMucG9zaXRpb25dICsgIiB3aWR0aDogIiArIHRoaXMud2lkdGggKyAiOyBoZWlnaHQ6ICIgKyB0aGlzLmhlaWdodCArCiAgICAgICAgICAgICAgICAiOyAtd2Via2l0LXRyYW5zZm9ybS1zdHlsZTogcHJlc2VydmUtM2Q7IHRyYW5zZm9ybS1zdHlsZTogcHJlc2VydmUtM2Q7IjsKICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModGhpcy5lbCwgIm9jdG9wdXN1aS1zaWRlYmFyIik7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgby5ldmVudC5vbih3aW5kb3csICJvcnRjaGFuZ2UiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LmlzUmVzaXplKSB7CiAgICAgICAgICAgICAgICAgICAgby51dGlsLnJlcXVlc3RBbmltYXRpb24oby51dGlsLmJpbmQodGhhdC5jaGVja1NpemUsIHRoYXQpKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LmlzUmVzaXplID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZmFsc2UpOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgY2hlY2tTaXplCiAgICAgICAgICogQGRlc2Mg55So5Lul55uR5ZCscmVzaXpl5LqL5Lu255qE5aSE55CGCiAgICAgICAgICovCiAgICAgICAgY2hlY2tTaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYWxjU2VsZlNpemUoKTsKICAgICAgICAgICAgdGhpcy5pc1Jlc2l6ZSA9IGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlNpZGViYXIuc2hvdwogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOWPr+S7pemAieaLqeS9leenjeaooeW8j+iuqeaOp+S7tuaYvuekuuWHuuadpQogICAgICAgICAqLwogICAgICAgIHNob3c6IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICAgICAgaWYodGhpcy5pc1Nob3cpIHJldHVybjsKICAgICAgICAgICAgaWYodGhpcy50eXBlICE9IHR5cGUpIHsKICAgICAgICAgICAgICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICB0aGlzLnNlcmlhbENTUygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgICAgIHRoaXMuY2FsY1NlbGZTaXplKCk7CiAgICAgICAgICAgIHRoaXNbImFuaW1hdGUiICsgdGhpcy50eXBlLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgdGhpcy50eXBlLnN1YnN0cmluZygxKV0odHJ1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuU2lkZWJhci5oaWRkZW4KICAgICAgICAgKiBAZGVzYyDpmpDol4/mjqfku7YKICAgICAgICAgKi8KICAgICAgICBoaWRkZW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZighdGhpcy5pc1Nob3cpICAgIHJldHVybjsKICAgICAgICAgICAgdGhpc1siYW5pbWF0ZSIgKyB0aGlzLnR5cGUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB0aGlzLnR5cGUuc3Vic3RyaW5nKDEpXShmYWxzZSk7CiAgICAgICAgfSwKCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBhbmltYXRlCiAgICAgICAgICogQGRlc2Mg5Yeg5Liq566A5Y2V5Yqo55S755qE5YWx5pyJ6YOo5YiGCiAgICAgICAgICogQHBhcmFtIHN2cyB7U3RyaW5nfSDliqjnlLvnmoTlvIDlp4vlgLwKICAgICAgICAgKiBAcGFyYW0gZXZzIHtTdHJpbmd9IOWKqOeUu+eahOe7k+adn+WAvAogICAgICAgICAqIEBwYXJhbSB0IHtCb29sZWFufSDmoIflv5fnnYDmraTliqjnlLvmmK/mmL7npLov6ZqQ6JeP5pe26LCD55SoCiAgICAgICAgICogQHBhcmFtIGVsIHtET01FbGVtZW50fSDmiafooYzliqjnlLvnmoToioLngrkKICAgICAgICAgKiBAcmV0dXJucyB7by5Ud2Vlbn0KICAgICAgICAgKi8KICAgICAgICBhbmltYXRlOiBmdW5jdGlvbihzdnMsIGV2cywgdCwgZWwpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcG4gPSB0aGlzLmNvbnRhaW5lci5wYXJlbnROb2RlIHx8IHRoaXMuY29udGFpbmVyOwogICAgICAgICAgICBwbi5zdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwogICAgICAgICAgICB0aGlzLmxvY2tlZCA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiBuZXcgby5Ud2VlbihlbCwgWyItd2Via2l0LXRyYW5zZm9ybSJdLCBbc3ZzXSwgW2V2c10sIC4zLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoYXQuaXNTaG93ID0gdDsKICAgICAgICAgICAgICAgIGlmKHQgJiYgKHRoYXQucG9zaXRpb24gPT0gInJpZ2h0IiB8fCB0aGF0LnBvc2l0aW9uID09ICJib3R0b20iKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBkb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuY29udGFpbmVyLmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1lID0gdGhhdDsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBtZS5jb250YWluZXIucmVtb3ZlQ2hpbGQoZG9tKTsKICAgICAgICAgICAgICAgICAgICAgICAgZG9tID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZighdCkgewogICAgICAgICAgICAgICAgICAgIHRoYXQuZWwuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBuLnN0eWxlLm92ZXJmbG93ID0gIiI7CiAgICAgICAgICAgICAgICB0aGF0LmxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYW5pbWF0ZVJvdGF0ZQogICAgICAgICAqIEBwYXJhbSB0CiAgICAgICAgICovCiAgICAgICAgYW5pbWF0ZVJvdGF0ZTogZnVuY3Rpb24odCkgewogICAgICAgICAgICB2YXIgc3ZvcHRpb25zID0gewogICAgICAgICAgICAgICAgICAgICJsZWZ0IjogInRyYW5zbGF0ZTNkKC0xMDAlLCAwLCAwKSByb3RhdGVZKC05MGRlZykiLAogICAgICAgICAgICAgICAgICAgICJyaWdodCI6ICJ0cmFuc2xhdGUzZCgxMDAlLCAwLCAwKSByb3RhdGVZKDkwZGVnKSIsCiAgICAgICAgICAgICAgICAgICAgInRvcCI6ICJ0cmFuc2xhdGUzZCgwLCAtMTAwJSwgMCkgcm90YXRlWCgxMjBkZWcpIiwKICAgICAgICAgICAgICAgICAgICAiYm90dG9tIjogInRyYW5zbGF0ZTNkKDAsIDEwMCUsIDApIHJvdGF0ZVgoLTEyMGRlZykiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZXZzID0gInRyYW5zbGF0ZTNkKDAsIDAsIDApIHJvdGF0ZVkoMGRlZykgcm90YXRlWCgwZGVnKSIsCiAgICAgICAgICAgICAgICBzdnMgPSB0ID8gc3ZvcHRpb25zW3RoaXMucG9zaXRpb25dIDogZXZzOwogICAgICAgICAgICBpZighdCkgewogICAgICAgICAgICAgICAgZXZzID0gc3ZvcHRpb25zW3RoaXMucG9zaXRpb25dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBvciA9IHsKICAgICAgICAgICAgICAgIGxlZnQ6ICIxMDAlIDUwJSIsCiAgICAgICAgICAgICAgICByaWdodDogIjAlIDUwJSIsCiAgICAgICAgICAgICAgICB0b3A6ICI1MCUgMTAwJSIsCiAgICAgICAgICAgICAgICBib3R0b206ICI1MCUgMCUiCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS53ZWJraXRUcmFuc2Zvcm1PcmlnaW4gPSBvclt0aGlzLnBvc2l0aW9uXTsKICAgICAgICAgICAgdGhpcy5hbmltYXRlUmV2ZWFsKHQpOwogICAgICAgICAgICB0aGlzLmFuaW1hdGUoc3ZzLCBldnMsIHQsIHRoaXMuZWwpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBhbmltYXRlQ292ZXIKICAgICAgICAgKiBAZGVzYyB0eXBl5Li6Y292ZXLml7bnmoTliqjnlLsKICAgICAgICAgKiBAcGFyYW0gdCB7Qm9vbGVhbn0g5qCH5b+X5L2NIOagh+W/l+aYvuekuuaIlumakOiXjwogICAgICAgICAqLwogICAgICAgIGFuaW1hdGVDb3ZlcjogZnVuY3Rpb24odCkgewogICAgICAgICAgICB2YXIgc3ZvcHRpb25zID0gewogICAgICAgICAgICAgICAgICAgICJsZWZ0IjogInRyYW5zbGF0ZTNkKC0xMDAlLCAwLCAwKSIsCiAgICAgICAgICAgICAgICAgICAgInJpZ2h0IjogInRyYW5zbGF0ZTNkKDEwMCUsIDAsIDApIiwKICAgICAgICAgICAgICAgICAgICAidG9wIjogInRyYW5zbGF0ZTNkKDAsIC0xMDAlLCAwKSIsCiAgICAgICAgICAgICAgICAgICAgImJvdHRvbSI6ICJ0cmFuc2xhdGUzZCgwLCAxMDAlLCAwKSIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBldnMgPSAidHJhbnNsYXRlM2QoMCwgMCwgMCkiLAogICAgICAgICAgICAgICAgc3ZzID0gdCA/IHN2b3B0aW9uc1t0aGlzLnBvc2l0aW9uXSA6IGV2czsKICAgICAgICAgICAgaWYoIXQpIHsKICAgICAgICAgICAgICAgIGV2cyA9IHN2b3B0aW9uc1t0aGlzLnBvc2l0aW9uXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFuaW1hdGUoc3ZzLCBldnMsIHQsIHRoaXMuZWwpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBhbmltYXRlUHVzaAogICAgICAgICAqIEBwYXJhbSB0CiAgICAgICAgICovCiAgICAgICAgYW5pbWF0ZVB1c2g6IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgdmFyIHN2b3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgICAgICAibGVmdCI6ICJ0cmFuc2xhdGUzZCgiICsgdGhpcy53aWR0aCArICIsIDAsIDApIiwKICAgICAgICAgICAgICAgICAgICAicmlnaHQiOiAidHJhbnNsYXRlM2QoLSIgKyB0aGlzLndpZHRoICsgIiwgMCwgMCkiLAogICAgICAgICAgICAgICAgICAgICJ0b3AiOiAidHJhbnNsYXRlM2QoMCwgIiArIHRoaXMuaGVpZ2h0ICsgIiwgMCkiLAogICAgICAgICAgICAgICAgICAgICJib3R0b20iOiAidHJhbnNsYXRlM2QoMCwgLSIgKyB0aGlzLmhlaWdodCArICIsIDApIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHN2cyA9ICJ0cmFuc2xhdGUzZCgwLCAwLCAwKSIsCiAgICAgICAgICAgICAgICBldnMgPSB0ID8gc3ZvcHRpb25zW3RoaXMucG9zaXRpb25dIDogc3ZzOwogICAgICAgICAgICBpZighdCkgewogICAgICAgICAgICAgICAgc3ZzID0gc3ZvcHRpb25zW3RoaXMucG9zaXRpb25dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZShzdnMsIGV2cywgdCwgdGhpcy5jb250YWluZXIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBhbmltYXRlUmV2ZWFsCiAgICAgICAgICogQHBhcmFtIHQKICAgICAgICAgKi8KICAgICAgICBhbmltYXRlUmV2ZWFsOiBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgIHRoaXMubmV4dERvbSA9IG8uZyh0aGlzLm5leHREb20pOwogICAgICAgICAgICBpZighdGhpcy5uZXh0RG9tKSAgIHRocm93IG5ldyBFcnJvcigicmVxdWlyZSBuZXh0RG9tIHRvIHJldmVhbCEiKTsKICAgICAgICAgICAgdmFyIHN2b3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgICAgICAibGVmdCI6ICJ0cmFuc2xhdGUzZCgiICsgdGhpcy53aWR0aCArICIsIDAsIDApIiwKICAgICAgICAgICAgICAgICAgICAicmlnaHQiOiAidHJhbnNsYXRlM2QoLSIgKyB0aGlzLndpZHRoICsgIiwgMCwgMCkiLAogICAgICAgICAgICAgICAgICAgICJ0b3AiOiAidHJhbnNsYXRlM2QoMCwgIiArIHRoaXMuaGVpZ2h0ICsgIiwgMCkiLAogICAgICAgICAgICAgICAgICAgICJib3R0b20iOiAidHJhbnNsYXRlM2QoMCwgLSIgKyB0aGlzLmhlaWdodCArICIsIDApIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHN2cyA9ICJ0cmFuc2xhdGUzZCgwLCAwLCAwKSIsCiAgICAgICAgICAgICAgICBldnMgPSB0ID8gc3ZvcHRpb25zW3RoaXMucG9zaXRpb25dIDogc3ZzOwogICAgICAgICAgICBpZighdCkgewogICAgICAgICAgICAgICAgc3ZzID0gc3ZvcHRpb25zW3RoaXMucG9zaXRpb25dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZShzdnMsIGV2cywgdCwgdGhpcy5uZXh0RG9tKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2VyaWFsQ1NTCiAgICAgICAgICogQGRlc2Mg55So5p2l5YiH5o2i5LiN5ZCM5qih5byP5LiL6IqC54K55bqU5YyF5ous55qE5qC35byPCiAgICAgICAgICovCiAgICAgICAgc2VyaWFsQ1NTOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy50eXBlID09ICJjb3ZlciIgfHwgdGhpcy50eXBlID09ICJwdXNoIikgewogICAgICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSB0aGlzLnN0eWxlcy50cmFuc2Zvcm1bdGhpcy5wb3NpdGlvbl07CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlLnpJbmRleCA9IDk5OTk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9ICIiOwogICAgICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS56SW5kZXggPSAtMTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBhY3RpdmF0ZQogICAgICAgICAqIEBkZXNjIOWkjeWGmeS6hueItuexu+eahOa/gOa0u+aWueazlQogICAgICAgICAqLwogICAgICAgIGFjdGl2YXRlOiBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgICAgIG8uV2lkZ2V0LnByb3RvdHlwZS5hY3RpdmF0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB2YXIgcG9zID0gby5kb20uZ2V0U3R5bGUodGhpcy5jb250YWluZXIsICJwb3NpdGlvbiIpOwogICAgICAgICAgICBpZihwb3MgPT0gInN0YXRpYyIpIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnR5cGUgPSB0eXBlIHx8IHRoaXMudHlwZTsKICAgICAgICAgICAgdGhpcy5zZXJpYWxDU1MoKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5TaWRlYmFyLnJlbmRlcgogICAgICAgICAqIEBkZXNjIOWkjeWGmeS6hueItuexu+eahHJlbmRlcuaWueazlQogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICAgICAgICBpZihsZW4gPT0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSB0aGlzLmNvbnRhaW5lciB8fCBkb2N1bWVudC5ib2R5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBvLmcoYXJndW1lbnRzWzBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvLmRvbS5hZGRDbGFzcyh0aGlzLmNvbnRhaW5lciwgIm9jdG9wdXN1aS1zaWRlYmFyLWNvbnRhaW5lciIpOwogICAgICAgICAgICBpZih0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIklsbGVnYWwgRG9tISIpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZighIWFyZ3VtZW50c1sxXSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjbG9uZW5vZGUgPSBvLmRvbS5jbG9uZU5vZGUodGhpcy5jb250YWluZXIsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQodGhpcy5lbCwgY2xvbmVub2RlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChjbG9uZW5vZGUsIHRoaXMuY29udGFpbmVyKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGNsb25lbm9kZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZCh0aGlzLmVsLCB0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXRoaXMuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2YXRlKGFyZ3VtZW50c1syXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXRoaXMuaXNTaG93KSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3coYXJndW1lbnRzWzJdKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBjYWxjU2VsZlNpemUKICAgICAgICAgKiBAZGVzYyDkuLrpgqPkupvmsqHmnInkuKrlhbfkvZPmlbDlgLzlrr3pq5jnmoTmjqfku7blgZrmn5DkupvliqjnlLvml7bojrflj5blhbfkvZPnmoTmlbDlgLwKICAgICAgICAgKi8KICAgICAgICBjYWxjU2VsZlNpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcG9zID0gdGhpcy5wb3NpdGlvbiwKICAgICAgICAgICAgICAgIHBybyA9IChwb3MgPT0gImxlZnQiIHx8IHBvcyA9PSAicmlnaHQiKSA/ICJ3aWR0aCIgOiAiaGVpZ2h0IjsKICAgICAgICAgICAgdGhpc1twcm9dID0gby5kb21bImdldCIgKyBwcm8uY2hhckF0KDApLnRvTG9jYWxlVXBwZXJDYXNlKCkgKyBwcm8uc3Vic3RyaW5nKDEpXSh0aGlzLmVsKSArICJweCI7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0LlNpZGViYXIiCiAgICB9KTsKCn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiBAYXV0aG9yIG91cGVuZy1mZQogKiBAdmVyc2lvbiAxLjEKICogd2ViYXBw6YCa55So57uE5Lu2CiAqIHNsaWRlciAgIC0gICDova7mkq3lm74KICogQHJlcXVpcmUgbGliL2NsYXNzLmpzCiAqIEByZXF1aXJlIGxpYi91dGlsLmpzCiAqIEByZXF1aXJlIGxpYi9kb20uanMKICogQHJlcXVpcmUgbGliL2V2ZW50LmpzCiAqIEByZXF1aXJlIGxpYi90d2Vlbi5qcwogKiBAcmVxdWlyZSBsaWIvYW5pbWF0ZS5qcwogKiBAcmVxdWlyZSB3aWRnZXQvd2lkZ2V0LmpzCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIEBjbGFzcyBvY3RvcHVzLldpZGdldC5TbGlkZXIKICAgICAqIEBwYXJlbnQgb2N0b3B1cy5XaWRnZXQKICAgICAqIEBkZXNjIOi9ruaSreWbvuaIlui9ruaSreiKgueCuQogICAgICogQHBhcmFtIG9wdGlvbnMge09iamVjdH0g5Y+C5pWwCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5kYXRhIHtBcnJheX0g6L2u5pKt5Zu+55qE5Zu+54mH5pWw5o2uIOWmguaenOaMh+WumuS6hmNoaWxkcmVu5bGe5oCnIOWImeatpOWPguaVsOWkseaViAogICAgICogQHBhcmFtIG9wdGlvbnMuY2hpbGRyZW4ge0FycmF5fSDpnIDopoHov5vooYzova7mkq3nmoToioLngrkKICAgICAqIEBwYXJhbSBvcHRpb25zLndpZHRoIHtOdW1iZXJ9IOi9ruaSreeahOWuveW6piDlu7rorq7liJ3lp4vljJbotYvlgLwg5Y+v5Lul55yB5o6J5LiA5qyh6I635Y+W5a695bqm55qEcmVwYWludAogICAgICogQHBhcmFtIG9wdGlvbnMuaGVpZ2h0IHtOdW1iZXJ9IOi9ruaSreeahOmrmOW6piDlu7rorq7liJ3lp4vljJbotYvlgLwKICAgICAqIEBwYXJhbSBvcHRpb25zLmRhdGFGaWVsZCB7T2JqZWN0fSDlm77niYfmqKHlvI/kuIsg5pWw5o2u55qE6Kej5p6Q5YC8IOm7mOiupOS4unsgdGl0bGU6ICJ0aXRsZSIsIHVybDogInVybCIsIGltYWdlX3VybDogImltYWdlX3VybCIgfQogICAgICogQHBhcmFtIG9wdGlvbnMuaXNMb24ge0Jvb2xlYW59IOaYr+WQpue6teWQkei9ruaSrSB0cnVl5Li657q15ZCRIOWQpuWImeS4uuaoquWQkSDpu5jorqRmYWxzZQogICAgICogQHBhcmFtIG9wdGlvbnMuaXNOZXdUYWIge0Jvb2xlYW59IOW9k+eCueWHu+i9ruaSreWbvueahOihjOS4uuS4uum7mOiupOihjOS4uui3s+i9rOaXtueUn+aViCB0cnVl5Li65paw56qX5Y+j5omT5byAIGZhbHNl5Zyo5Y6f56qX5Y+j5omT5byAIOm7mOiupHRydWUKICAgICAqIEBwYXJhbSBvcHRpb25zLmF1dG9QbGF5IHtCb29sZWFufSDmmK/lkKbnlJ/miJDlkI7ov5vooYzliqjnlLsg6buY6K6k5Li6dHJ1ZQogICAgICogQHBhcmFtIG9wdGlvbnMuYXV0b1BsYXlUaW1lIHtOdW1iZXJ9IOi9ruaSreWbvuWKqOeUu+aXtueahOWBnOeVmeaXtumXtCDljZXkvY1tcyDpu5jorqTkuLo0MDAwbXMKICAgICAqIEBwYXJhbSBvcHRpb25zLmFuaW1hdGlvblRpbWUge051bWJlcn0g6L2u5pKt5Zu+5Y2V5qyh5Yqo55S76L+Q6KGM5pe26Ze0IOWNleS9jW1zIOm7mOiupOS4ujQwMG1zCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5hbmltYXRpb25UeXBlIHtTdHJpbmd9IOi9ruaSreWbvueahOWKqOWMluexu+WeiyDpu5jorqTkuLoiZWFzZS1vdXQiCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5sb29wIHtCb29sZWFufSDmmK/lkKbmmK/lvqrnjq/ova7mkq0g6buY6K6k5Li6dHJ1ZQogICAgICogQHBhcmFtIG9wdGlvbnMuaGFzVGl0bGUge0Jvb2xlYW59IOaYr+WQpuaciei9ruaSreWbvuS4i+aWueeahHRpdGxl5Yy65Z+fCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5oYXNHaXptb3Mge0Jvb2xlYW59IOaYr+WQpuaciei9ruaSreWbvuS4i+aWueeahOmAieaLqeWMuuWfnwogICAgICogQHBhcmFtIG9wdGlvbnMuZGlzU2Nyb2xsIHtCb29sZWFufSDmmK/lkKbpmLvmraLmu5rliqjmnaEKICAgICAqLwogICAgby5XaWRnZXQuU2xpZGVyID0gby5kZWZpbmUoby5XaWRnZXQsIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGF0YQogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAZGVzYyDmjqfku7bnmoTmlbDmja4g5aaC5p6c6Z2e5Zu+54mH57G75Z6L55qE6L2u5pKtIOatpOWPguaVsOWkseaViAogICAgICAgICAqLwogICAgICAgIGRhdGE6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHdpZHRoCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmr4/pobXova7mkq3nmoTlrr3luqYKICAgICAgICAgKi8KICAgICAgICB3aWR0aDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaGVpZ2h0CiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmr4/pobXova7mkq3nmoTpq5jluqYKICAgICAgICAgKi8KICAgICAgICBoZWlnaHQ6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNoaWxkcmVuCiAgICAgICAgICogQHR5cGUge0FycmF5IHwgRE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDphY3nva7nmoToioLngrnova7mkq0g5YiZ5Zu+54mH6L2u5pKt6YWN572u5aSx5pWICiAgICAgICAgICovCiAgICAgICAgY2hpbGRyZW46IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGRvbXMKICAgICAgICAgKiBAdHlwZSB7QXJyYXkgfCBET01FbGVtZW50fQogICAgICAgICAqIEBkZXNjIOi9ruaSreWbvuS4rei9ruaSreiKgueCueeahOmbhuWQiAogICAgICAgICAqLwogICAgICAgIGRvbXM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGxlbmd0aAogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg6L2u5pKt55qE6ZW/5bqmCiAgICAgICAgICovCiAgICAgICAgbGVuZ3RoOiAwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBfdHlwZQogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOagh+W/l+aYr+WbvueJh+i9ruaSrei/mOaYr+iKgueCuei9ruaSrSAiaW1nIiB8fCAiZG9tIgogICAgICAgICAqLwogICAgICAgIF90eXBlOiAiaW1nIiwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGF0YUZpbGVkCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKiBAZGVzYyDlm77niYfmqKHlvI/kuIvmlbDmja7nmoTor7vlj5ZrZXkKICAgICAgICAgKi8KICAgICAgICBkYXRhRmllbGQ6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHZpZXdEaXYKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDova7mkq3nmoTovb3kvZMKICAgICAgICAgKi8KICAgICAgICB2aWV3RGl2OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc0xvbgogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOaYr+WQpue6teWQkei9ruaSrQogICAgICAgICAqLwogICAgICAgIGlzTG9uOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNOZXdUYWIKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDphY3nva7pobkg5piv5ZCm54K55Ye75ZCO5paw56qX5Y+j5omT5byACiAgICAgICAgICovCiAgICAgICAgaXNOZXdUYWI6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzRGlzYWJsZUEKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDphY3nva7pobkg5piv5ZCm6Ieq5a6a5LmJ54K55Ye75LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgaXNEaXNhYmxlQTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGN1cnJlbnQKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqIEBkZXNjIOW9k+WJjemAieaLqeeahOiKgueCueS7peWPimluZGV45L+h5oGvCiAgICAgICAgICovCiAgICAgICAgY3VycmVudDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbG9hZEltYWdlTnVtYmVyCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDpu5jorqTkuIDmrKHmi4nlj5bnmoTlm77niYfkuKrmlbAg5Li66LSf5pWw6KGo56S65LiA5qyh5ouJ5Y+W5a6M5q+VCiAgICAgICAgICovCiAgICAgICAgbG9hZEltYWdlTnVtYmVyOiA0LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB0aW1lcgogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg6L2u5pKt55qEdGltZXIKICAgICAgICAgKi8KICAgICAgICB0aW1lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYXV0b1BsYXlUaW1lCiAgICAgICAgICogQGRlc2Mg6L2u5pKt5Zu+55WZ55qE5pe26Ze0CiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKi8KICAgICAgICBhdXRvUGxheVRpbWU6IDQwMDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFuaW1hdGlvblRpbWUKICAgICAgICAgKiBAZGVzYyDova7mkq3pgJ/luqYKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGFuaW1hdGlvblRpbWU6IDQwMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYW5pbWF0aW9uVHlwZQogICAgICAgICAqIEBkZXNjIOi9ruaSreWbvueahOWKqOeUu+exu+WeiwogICAgICAgICAqLwogICAgICAgIGFuaW1hdGlvblR5cGU6ICJlYXNlLW91dCIsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGRpc2FibGVBbGwKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBkaXNhYmxlQWxsOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZGlzU2Nyb2xsCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5piv5ZCm5YGc5o6J5rua5Yqo5LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgZGlzU2Nyb2xsOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbG9vcAogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOaYr+WQpuW+queOr+i9ruaSrQogICAgICAgICAqLwogICAgICAgIGxvb3A6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGF1dG9QbGF5CiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5piv5ZCm6Ieq5Yqo5pKt5pS+IOiuvue9ruS4umZhbHNl5pe277yM6ZyA6KaB5omL5Yqo5omT5byACiAgICAgICAgICovCiAgICAgICAgYXV0b1BsYXk6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGhhc0J1dHRvbgogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOaYr+WQpuacieW3puWPs+S4pOS+p+eahGJ1dHRvbgogICAgICAgICAqLwogICAgICAgIGhhc0J1dHRvbjogdHJ1ZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaGFzVGl0bGUKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDmmK/lkKblhbfmnInkuIvkvqfnmoR0aXRsZeWMuuWfnwogICAgICAgICAqLwogICAgICAgIGhhc1RpdGxlOiB0cnVlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBoYXNHaXptb3MKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDmmK/lkKblhbfmnInkuIvkvqfnmoTpgInmi6nljLrln58KICAgICAgICAgKi8KICAgICAgICBoYXNHaXptb3M6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHByZURvbQogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqIEBkZXNjIOS4iuS4gOW8oAogICAgICAgICAqLwogICAgICAgIHByZURvbTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgbmV4dERvbQogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqIEBkZXNjIOS4i+S4gOW8oAogICAgICAgICAqLwogICAgICAgIG5leHREb206IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGN1cnJlbnRHaXptb3MKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDlvZPliY3nmoTlsI/njqnmhI8KICAgICAgICAgKi8KICAgICAgICBjdXJyZW50R2l6bW9zOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBnaXptb3NEb21zCiAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAqIEBkZXNjIOmAieaLqeWZqOiKgueCueeahOaVsOe7hAogICAgICAgICAqLwogICAgICAgIGdpem1vc0RvbXM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzU2xpZGUKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKiBAZGVzYyDmoIflv5fkvY0g5qCH5b+X5piv5ZCm5q2j5Zyo6L2u5pKtCiAgICAgICAgICovCiAgICAgICAgaXNTbGlkZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzRHJhZwogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqIEBkZXNjIOagh+W/l+S9jSDmoIflv5fmmK/lkKblpITkuo7mi5bmi73nirbmgIEKICAgICAgICAgKi8KICAgICAgICBpc0RyYWc6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc1RpbWVyCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5qCH5b+X5L2NIOS4gOS6m+aJi+acuuaXoOazleS9v+eUqHJlbW92ZUV2ZW50TGlzdGVuZXLljrvmjonkuovku7Yg5a+86Ie0dHJhbnNpdGlvbkVuZOS6i+S7tue7keS4iuWQjuaXoOazleWNuOi9vSDlm6DmraTkvb/nlKjmoIflv5fkvY3op6PlhrMKICAgICAgICAgKi8KICAgICAgICBpc1RpbWVyOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgcGFnZURyYWdDCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmi5bmi73ngrkg5qiq5ZCR5LiO57q15ZCR5YiG5Yir5a+55bqUeOS4jnkKICAgICAgICAgKi8KICAgICAgICBwYWdlRHJhZ1N0YXJ0QzogMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgcGFnZURyYWdEb3duCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmi5bmi73nu5PmnZ/ngrkKICAgICAgICAgKi8KICAgICAgICBwYWdlRHJhZ0VuZEM6IDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHBhZ2VEcmFnVGVtcEMKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqIEBkZXNjIOS4remXtOaLluaLveeCuQogICAgICAgICAqLwogICAgICAgIHBhZ2VEcmFnVGVtcEM6IDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHBhZ2VEcmFnRGlyZWN0aW9uCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5ouW5ou955qE5pa55ZCRIHRydWXkuLrmraPlkJEgZmFsc2XkuLrmraPmlrnlkJEKICAgICAgICAgKi8KICAgICAgICBwYWdlRHJhZ0RpcmVjdGlvbjogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGRyYWd0aW1lcgogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICogQGRlc2Mg5ouW5ou95pe255qEdGltZXIKICAgICAgICAgKi8KICAgICAgICBkcmFndGltZXI6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHRyYW5zbGF0ZVZhbHVlCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDova7mkq3nmoTkvY3nva4KICAgICAgICAgKi8KICAgICAgICB0cmFuc2xhdGVWYWx1ZTogMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY2hhbmdlRGlzCiAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgKiBAZGVzYyDmi5bmi73mlLnlj5jnmoTot53nprsKICAgICAgICAgKi8KICAgICAgICBjaGFuZ2VEaXM6IDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHNwcmluZ0JhY2tEaXMKICAgICAgICAgKiBAdHlwZSB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHNwcmluZ0JhY2tEaXM6IDEwLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBldmVudFRpbWVyCiAgICAgICAgICovCiAgICAgICAgZXZlbnRUaW1lcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgdW5sb2FkSW1hZ2UKICAgICAgICAgKi8KICAgICAgICB1bmxvYWRJbWFnZTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgdG91Y2hTdGFydFBpeGVsWAogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgdG91Y2hTdGFydFBpeGVsWDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgdG91Y2hTdGFydFBpeGVsWQogICAgICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgdG91Y2hTdGFydFBpeGVsWTogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAY29uc3RydWN0b3Igb2N0b3B1cy5XaWRnZXQuU2xpZGVyLmluaXRpYWxpemUKICAgICAgICAgKiBAZGVzYyDkuI7niLbnsbvkv53mjIHkuIDoh7QKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgdGhpcy5kYXRhRmllbGQgPSB0aGlzLmRhdGFGaWVsZCB8fCB7CiAgICAgICAgICAgICAgICB0aXRsZTogInRpdGxlIiwKICAgICAgICAgICAgICAgIHVybDogInVybCIsCiAgICAgICAgICAgICAgICBpbWFnZV91cmw6ICJpbWFnZV91cmwiCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZG9tcyA9IHRoaXMuY2hpbGRyZW4gfHwgW107CiAgICAgICAgICAgIHRoaXMudW5sb2FkSW1hZ2UgPSBbXTsKICAgICAgICAgICAgdGhpcy5sZW5ndGggPSB0aGlzLmRvbXMubGVuZ3RoID09IDAgPyB0aGlzLmRhdGEubGVuZ3RoIDogdGhpcy5kb21zLmxlbmd0aDsKICAgICAgICAgICAgdGhpcy5jdXJyZW50ID0gewogICAgICAgICAgICAgICAgaW5kZXg6IDAsCiAgICAgICAgICAgICAgICBkb206IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5idWlsZERvbXModGhpcy5lbCk7CiAgICAgICAgICAgIHRoaXMuYnVpbGRTbGlkZXIoKTsKICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS5jc3NUZXh0ID0gIm92ZXJmbG93OiBoaWRkZW47IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCU7IHBvc2l0aW9uOiByZWxhdGl2ZTsiOwogICAgICAgICAgICAvL+WmguaenOaYr+iHquWKqOa4suafk+eUn+aIkCDlv4XpobvkvKDlhaXlrr3luqbkuI7pq5jluqYg5ZCm5YiZ5oqb6ZSZCiAgICAgICAgICAgIGlmKHRoaXMuYXV0b0FjdGl2YXRlKSB7CiAgICAgICAgICAgICAgICBpZih0aGlzLndpZHRoID09IG51bGwgfHwgdGhpcy5oZWlnaHQgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCJSZXF1aXJlIHRoZSBTbGlkZXIncyB3aWR0aCBhbmQgaGVpZ2h0ISIpOwogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGJ1aWxkRG9tcwogICAgICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAgICAgKi8KICAgICAgICBidWlsZERvbXM6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIHRoaXMudmlld0RpdiA9IHRoaXMudmlld0RpdiB8fCBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgIHN0eWxlOiAicG9zaXRpb246IHJlbGF0aXZlOyB0ZXh0LWFsaWduOiBjZW50ZXI7IC13ZWJraXQtdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKTsiICsKICAgICAgICAgICAgICAgICAgICAiIC13ZWJraXQtYmFja2ZhY2UtdmlzaWJpbGl0eTogaGlkZGVuOyAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOyAtd2Via2l0LXVzZXItZHJhZzogbm9uZTsiICsKICAgICAgICAgICAgICAgICAgICAiIC13ZWJraXQtdHJhbnNpdGlvbjogLXdlYmtpdC10cmFuc2Zvcm0gMG1zICIgKyB0aGlzLmFuaW1hdGlvblR5cGUgKyAiOyIsCiAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXNsaWRlci12aWV3IgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYodGhpcy5oYXNCdXR0b24gJiYgIXRoaXMuZGlzYWJsZUFsbCAmJiB0aGlzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIHZhciBidG5Dc3NUZXh0ID0gImRpc3BsYXk6IGJsb2NrOyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IjsKICAgICAgICAgICAgICAgIHRoaXMucHJlRG9tID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAgICAgaHJlZjogIiIsCiAgICAgICAgICAgICAgICAgICAgc3R5bGU6IGJ0bkNzc1RleHQsCiAgICAgICAgICAgICAgICAgICAgImNsYXNzIjogIm9jdG9wdXN1aS1zbGlkZXItYnV0dG9uIG9jdG9wdXN1aS1zbGlkZXItcHJlYnV0dG9uIgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLm5leHREb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICAgICBocmVmOiAiIiwKICAgICAgICAgICAgICAgICAgICBzdHlsZTogYnRuQ3NzVGV4dCwKICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXNsaWRlci1idXR0b24gb2N0b3B1c3VpLXNsaWRlci1uZXh0YnV0dG9uIgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmUodGhpcy5wcmVEb20pLm9uKCJ0YXAiLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgby5ldmVudC5zdG9wKGUpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuX3NlbGVjdFByZSgpOwogICAgICAgICAgICAgICAgICAgIHRoYXQuYXV0b1BsYXkgJiYgdGhhdC5zdGFydCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLmdlc3R1cmUodGhpcy5uZXh0RG9tKS5vbigidGFwIiwgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIG8uZXZlbnQuc3RvcChlKTsKICAgICAgICAgICAgICAgICAgICB0aGF0Ll9zZWxlY3ROZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5hdXRvUGxheSAmJiB0aGF0LnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKHRoaXMucHJlRG9tKTsKICAgICAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKHRoaXMubmV4dERvbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5oYXNHaXptb3MpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2l6bW9zRG9tcyA9IG5ldyBBcnJheSh0aGlzLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICAgICAgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgICAgICAgICAgICAgcm9kb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgImNsYXNzIjogIm9jdG9wdXN1aS1zbGlkZXItZ2l6bW9zIgogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZm9yKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9jbGFzc05hbWUgPSAib2N0b3B1c3VpLXNsaWRlci1naXptb3NpdGVtIjsKICAgICAgICAgICAgICAgICAgICBpZihpID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgX2NsYXNzTmFtZSA9ICJvY3RvcHVzdWktc2xpZGVyLWdpem1vc2l0ZW0gb2N0b3B1c3VpLXNsaWRlci1jdXJyZW50Z2l6bW9zaXRlbSIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIGRvbSA9IG8uZG9tLmNyZWF0ZURvbSgiZGl2IiwgewogICAgICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiBfY2xhc3NOYW1lCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5naXptb3NEb21zW2ldID0gZG9tOwogICAgICAgICAgICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGRvbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRHaXptb3MgPSB0aGlzLmdpem1vc0RvbXNbMF07CiAgICAgICAgICAgICAgICByb2RvbS5hcHBlbmRDaGlsZChmcmFnbWVudCk7CiAgICAgICAgICAgICAgICBlbC5hcHBlbmRDaGlsZChyb2RvbSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2V0Q3VycmVudAogICAgICAgICAqIEBkZXNjIOiuvue9ruW9k+W8uumAieS4reeahOi9ruaSrQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgc2V0Q3VycmVudDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSBvLmV4dGVuZCh0aGlzLmN1cnJlbnQsIG9wdGlvbnMpOwogICAgICAgICAgICBpZih0aGlzLmN1cnJlbnRHaXptb3MpIHsKICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuY3VycmVudC5pbmRleDsKICAgICAgICAgICAgICAgIGlmKHRoaXMuY3VycmVudEdpem1vcyAhPSB0aGlzLmdpem1vc0RvbXNbaW5kZXhdKSB7CiAgICAgICAgICAgICAgICAgICAgby5kb20ucmVtb3ZlQ2xhc3ModGhpcy5jdXJyZW50R2l6bW9zLCAib2N0b3B1c3VpLXNsaWRlci1jdXJyZW50Z2l6bW9zaXRlbSIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEdpem1vcyA9IHRoaXMuZ2l6bW9zRG9tc1tpbmRleF07CiAgICAgICAgICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModGhpcy5jdXJyZW50R2l6bW9zLCAib2N0b3B1c3VpLXNsaWRlci1jdXJyZW50Z2l6bW9zaXRlbSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlNsaWRlci5idWlsZFNsaWRlcgogICAgICAgICAqIEBkZXNjIOeUn+aIkOWIneWni+iKgueCuee7k+aehAogICAgICAgICAqLwogICAgICAgIGJ1aWxkU2xpZGVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGZyYWdtZW50OwogICAgICAgICAgICBpZih0aGlzLmNoaWxkcmVuID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5idWlsZERlZmF1bHRTbGlkZXIoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5idWlsZERvbVNsaWRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMubG9vcCAmJiB0aGlzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIHZhciBmcmlzdGRvbSA9IHRoaXMuZG9tc1swXS5jbG9uZU5vZGUodHJ1ZSksCiAgICAgICAgICAgICAgICAgICAgbGFzdGRvbSA9IHRoaXMuZG9tc1t0aGlzLmxlbmd0aCAtIDFdLmNsb25lTm9kZSh0cnVlKTsKICAgICAgICAgICAgICAgIGlmKHRoaXMuX3R5cGUgPT0gImltZyIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEltYWdlTG9hZCgwLCBmcmlzdGRvbSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbWFnZUxvYWQodGhpcy5sZW5ndGggLSAxLCBsYXN0ZG9tKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGZyaXN0ZG9tKTsKICAgICAgICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGxhc3Rkb20pOwogICAgICAgICAgICAgICAgdGhpcy5kb21zLnB1c2goZnJpc3Rkb20pOwogICAgICAgICAgICAgICAgdGhpcy5kb21zLnB1c2gobGFzdGRvbSk7CiAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aCArPSAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0Q3VycmVudCh7CiAgICAgICAgICAgICAgICBkb206IHRoaXMuZG9tc1swXQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy52aWV3RGl2LmFwcGVuZENoaWxkKGZyYWdtZW50KTsKICAgICAgICAgICAgdGhpcy5lbC5hcHBlbmRDaGlsZCh0aGlzLnZpZXdEaXYpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBidWlsZFNsaWRlckl0ZW0KICAgICAgICAgKiBAZGVzYyDnlJ/miJDova7mkq3lm77nmoTljZXkvosKICAgICAgICAgKiBAcGFyYW0gaW5kZXgge051bWJlcn0KICAgICAgICAgKi8KICAgICAgICBidWlsZFNsaWRlckl0ZW06IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgIHZhciBkb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXNsaWRlci1jaGlsZHJlbiIsCiAgICAgICAgICAgICAgICAgICAgInN0eWxlIjogInBvc2l0aW9uOiByZWxhdGl2ZTsgLXdlYmtpdC10cmFuc2Zvcm06IHRyYW5zbGF0ZTNkKDAsIDAsIDApOyBvdmVyZmxvdzogaGlkZGVuOyIKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaWRvbSA9IG8uZG9tLmNyZWF0ZURvbSgiaW1nIiwgewogICAgICAgICAgICAgICAgICAgICJjbGFzcyI6ICJvY3RvcHVzdWktc2xpZGVyLWltZ0NoaWxkcmVuIiwKICAgICAgICAgICAgICAgICAgICBzdHlsZTogIm1heC13aWR0aDogMTAwJTsgbWF4LWhlaWdodDogMTAwJTsgcG9zaXRpb246IGFic29sdXRlOyBsZWZ0OiAwOyByaWdodDogMDsgdG9wOiAwOyBib3R0b206IDA7IG1hcmdpbjogYXV0bzsiCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIF9fdXJsID0gdGhpcy5nZXREYXRhQnkoaW5kZXgsICJ1cmwiKSB8fCAiIiwKICAgICAgICAgICAgICAgIF9fdGFyZ2V0ID0gdGhpcy5pc05ld1RhYiA/ICJfYmxhbmsiIDogIl9zZWxmIiwKICAgICAgICAgICAgICAgIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBvLmV2ZW50Lm9uKGlkb20sICJjbGljayIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYoIXRoYXQuaXNEaXNhYmxlQSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5vcGVuKF9fdXJsLCBfX3RhcmdldCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhhdC5ub3RpZnkoInNsaWRlci1pdGVtLW9udGFwIiwgdGhhdC5kYXRhW2luZGV4XSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZigoaW5kZXggPCBNYXRoLmNlaWwodGhpcy5sb2FkSW1hZ2VOdW1iZXIgLyAyKSkgfHwKICAgICAgICAgICAgICAgIGluZGV4ID49IE1hdGguZmxvb3IodGhpcy5sZW5ndGggLSB0aGlzLmxvYWRJbWFnZU51bWJlciAvIDIpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEltYWdlTG9hZChpbmRleCwgaWRvbSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnVubG9hZEltYWdlLnB1c2goewogICAgICAgICAgICAgICAgICAgIGluZGV4OiBpbmRleCwKICAgICAgICAgICAgICAgICAgICBkb206IGlkb20KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvbS5hcHBlbmRDaGlsZChpZG9tKTsKICAgICAgICAgICAgaWYodGhpcy5oYXNUaXRsZSkgewogICAgICAgICAgICAgICAgdmFyIHRpdGxlZG9tID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJjbGFzcyI6ICJvY3RvcHVzdWktc2xpZGVyLWltZ1RpdGxlIgogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgIHRpdGxlY29udGVudCA9IG8uZG9tLmNyZWF0ZURvbSgiZGl2IiwgewogICAgICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXNsaWRlci1pbWdUaXRsZUNvbnRlbnQgb2N0b3B1c3VpLXRleHQtbGltaXQiCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aXRsZWNvbnRlbnQuaW5uZXJIVE1MID0gby51dGlsLmVuY29kZUh0bWwodGhpcy5nZXREYXRhQnkoaW5kZXgsICJ0aXRsZSIpKTsKICAgICAgICAgICAgICAgIHRpdGxlZG9tLmFwcGVuZENoaWxkKHRpdGxlY29udGVudCk7CiAgICAgICAgICAgICAgICBkb20uYXBwZW5kQ2hpbGQodGl0bGVkb20pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZG9tcy5wdXNoKGRvbSk7CiAgICAgICAgICAgIHJldHVybiBkb207CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuU2xpZGVyLm9uCiAgICAgICAgICogQGRlc2Mg5ZCMV2lkZ2V0IOWAvOW+l+azqOaEj+eahOaYryDlpoLmnpzoh6rlrprkuYnnm5HlkKzkuoYic2xpZGVyLWl0ZW0tb250YXAi5LqL5Lu2IOm7mOiupOeCueWHu+i9ruaSreWbvuaJk+W8gOaWsOmTvuaOpeeahOihjOS4uuWwhuWkseaViAogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOS6i+S7tuexu+WeiwogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g5LqL5Lu255uR5ZCs5Ye95pWwCiAgICAgICAgICovCiAgICAgICAgb246IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHsKICAgICAgICAgICAgby5XaWRnZXQucHJvdG90eXBlLm9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGlmKHR5cGUgPT0gInNsaWRlci1pdGVtLW9udGFwIiAmJiAhdGhpcy5pc0Rpc2FibGVBKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzRGlzYWJsZUEgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGJ1aWxkRGVmYXVsdFNsaWRlcgogICAgICAgICAqIEBkZXNjIOeUn+aIkOWbvueJh+i9ruaSrQogICAgICAgICAqLwogICAgICAgIGJ1aWxkRGVmYXVsdFNsaWRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBsZW4gPSB0aGlzLmRhdGEubGVuZ3RoOwogICAgICAgICAgICBpZighISFsZW4pIHRocm93IG5ldyBFcnJvcigiUmVxdWlyZSBkYXRhIG9mIGltYWdlISIpOwogICAgICAgICAgICB2YXIgaSA9IDAsCiAgICAgICAgICAgICAgICBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgZm9yKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZG9tID0gdGhpcy5idWlsZFNsaWRlckl0ZW0oaSk7CiAgICAgICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmcmFnbWVudDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2V0SW1hZ2VMb2FkCiAgICAgICAgICogQHBhcmFtIGluZGV4IHtOdW1iZXJ9IOWbvueJh+eahGluZGV4CiAgICAgICAgICogQHBhcmFtIGRvbSB7RE9NRUxlbWVudH0g5Zu+54mH55qE6L295L2T6IqC54K5CiAgICAgICAgICovCiAgICAgICAgc2V0SW1hZ2VMb2FkOiBmdW5jdGlvbihpbmRleCwgZG9tKSB7CiAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLmdldERhdGFCeShpbmRleCwgImltYWdlX3VybCIpOwogICAgICAgICAgICB2YXIgX2RvbSA9IG8ub25lKCIub2N0b3B1c3VpLXNsaWRlci1pbWdDaGlsZHJlbiIsIGRvbSkgfHwgZG9tOwogICAgICAgICAgICBvLnV0aWwubG9hZEltYWdlKHVybCwgby51dGlsLmVtcHR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIF9kb20uc3JjID0gdXJsOwogICAgICAgICAgICAgICAgby5hbmltYXRpb24uZmFkZShfZG9tLCB7CiAgICAgICAgICAgICAgICAgICAgb3V0OiBmYWxzZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiSW1hZ2UgIiArIHVybCArICIgbG9hZCBmYWlsZWQhIik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBidWlsZERvbVNsaWRlcgogICAgICAgICAqIEBkZXNjIOeUn+aIkOiKgueCuei9ruaSrQogICAgICAgICAqLwogICAgICAgIGJ1aWxkRG9tU2xpZGVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICAgICAgICAgICAgbGVuID0gdGhpcy5kb21zLmxlbmd0aCwKICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICB0aGlzLl90eXBlID0gImRvbSI7CiAgICAgICAgICAgIGZvcig7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQodGhpcy5kb21zW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZnJhZ21lbnQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuU2xpZGVyLnJlbmRlcgogICAgICAgICAqIEBkZXNjIOWkjeWGmeeItuexu+eahHJlbmRlcuaWueazlQogICAgICAgICAqLwogICAgICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG8uV2lkZ2V0LnByb3RvdHlwZS5yZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgaWYodGhpcy5hdXRvUGxheSAmJiB0aGlzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm5vdGlmeSgic2xpZGVyLXVpLWFmdGVycmVuZGVyIik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGFjdGl2YXRlCiAgICAgICAgICogQGRlc2Mg6L2u5pKt5Zu+55Sf5oiQ5ZCO5Yqg5YWl6aG16Z2i6ZyA6KaB5r+A5rS7CiAgICAgICAgICovCiAgICAgICAgYWN0aXZhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBvLldpZGdldC5wcm90b3R5cGUuYWN0aXZhdGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgdGhpcy5jYWxjU2VsZlNpemUoKTsKICAgICAgICAgICAgaWYoIXRoaXMuZGlzYWJsZUFsbCkgewogICAgICAgICAgICAgICAgdGhpcy5pbml0U2VsZkV2ZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25PcnRDaGFuZ2VkCiAgICAgICAgICovCiAgICAgICAgb25PcnRDaGFuZ2VkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5jYWxjU2VsZlNpemUoKTsKICAgICAgICAgICAgdGhpcy5zZWxlY3QodGhpcy5jdXJyZW50LmluZGV4KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgdXBkYXRlVHJhbnNsYXRlVmFsdWUKICAgICAgICAgKiBAZGVzYyDmm7TmlrDova7mkq3nmoTkvY3nva4KICAgICAgICAgKiBAcGFyYW0gdiB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHVwZGF0ZVRyYW5zbGF0ZVZhbHVlOiBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgIGlmKCghdiAmJiB2ICE9IDApIHx8IHRoaXMudHJhbnNsYXRlVmFsdWUgPT0gdikgIHJldHVybjsKICAgICAgICAgICAgdGhpcy50cmFuc2xhdGVWYWx1ZSA9IHY7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGNhbGNTZWxmU2l6ZQogICAgICAgICAqIEBkZXNjIOWIneWni+WMluiHqui6q+WuvemrmAogICAgICAgICAqLwogICAgICAgIGNhbGNTZWxmU2l6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaXNMb24gPyB0aGlzLmluaXREb21zUHJvcGVydHkoIndpZHRoIiwgImhlaWdodCIsIGZhbHNlKSA6IHRoaXMuaW5pdERvbXNQcm9wZXJ0eSgiaGVpZ2h0IiwgIndpZHRoIiwgdHJ1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGluaXREb21zV2lkdGgKICAgICAgICAgKiBAZGVzYyDlsIbmiYDmnIlkb23lrr3luqbmiJbpq5jluqborr7nva7kuoYKICAgICAgICAgKi8KICAgICAgICBpbml0RG9tc1Byb3BlcnR5OiBmdW5jdGlvbihwcm8sIHNwcm8sIGlzRmxvYXQpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLAogICAgICAgICAgICAgICAgbGVuID0gdGhpcy5sZW5ndGg7CiAgICAgICAgICAgIHRoaXMudmlld0Rpdi5zdHlsZVtwcm9dID0gIjEwMCUiOwogICAgICAgICAgICB2YXIgX3Nwcm8gPSBvLmRvbVsiZ2V0IiArIHNwcm8uY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzcHJvLnN1YnN0cmluZygxKV0odGhpcy5lbCk7CiAgICAgICAgICAgIHRoaXNbc3Byb10gID0gX3Nwcm87CiAgICAgICAgICAgIHRoaXMudmlld0Rpdi5zdHlsZVtzcHJvXSA9IF9zcHJvICogbGVuICsgInB4IjsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5kb21zLCBmdW5jdGlvbihpdGVtLCBpKSB7CiAgICAgICAgICAgICAgICBpdGVtLnN0eWxlW3Byb10gPSAiMTAwJSI7CiAgICAgICAgICAgICAgICBpdGVtLnN0eWxlW3Nwcm9dID0gX3Nwcm8gKyAicHgiOwoJCQkJaWYoaXNGbG9hdCkgewogICAgICAgICAgICAgICAgICAgIGl0ZW0uc3R5bGUuZmxvYXQgPSAibGVmdCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihpID09IGxlbiAtIDEgJiYgdGhhdC5sb29wICYmIHRoYXQubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICAgIHZhciBfX3N0eWxlID0gdGhhdC5pc0xvbiA/ICJ0b3AiIDogImxlZnQiOwogICAgICAgICAgICAgICAgICAgIGl0ZW0uc3R5bGVbX19zdHlsZV0gPSAwIC0gX3Nwcm8gKiBsZW4gKyAicHgiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgaW5pdFNlbGZFdmVudAogICAgICAgICAqIEBkZXNjIOe7mei9ruaSreWbvue7keWumuS6i+S7tgogICAgICAgICAqLwogICAgICAgIGluaXRTZWxmRXZlbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQub24odGhpcy5lbCwgInRvdWNoc3RhcnQiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hTdGFydCwgdGhpcykpOwogICAgICAgICAgICAgICAgby5ldmVudC5vbih0aGlzLmVsLCAidG91Y2htb3ZlIiwgby51dGlsLmJpbmRBc0V2ZW50TGlzdGVuZXIodGhpcy5vblRvdWNoTW92ZSwgdGhpcykpOwogICAgICAgICAgICAgICAgby5ldmVudC5vbih0aGlzLmVsLCAidG91Y2hlbmQgdG91Y2hjYW5jZWwiLCBvLnV0aWwuYmluZEFzRXZlbnRMaXN0ZW5lcih0aGlzLm9uVG91Y2hFbmQsIHRoaXMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvLmV2ZW50Lm9uKHdpbmRvdywgIm9ydGNoYW5nZSIsIG8udXRpbC5iaW5kKHRoaXMub25PcnRDaGFuZ2VkLCB0aGlzKSwgZmFsc2UpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvblRvdWNoU3RhcnQKICAgICAgICAgKiBAZGVzYyDlvIDlp4vmi5bmi70KICAgICAgICAgKiBAcGFyYW0gZSB7d2luZG93LmV2ZW50fQogICAgICAgICAqLwogICAgICAgIG9uVG91Y2hTdGFydDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICBpZih0aGlzLmV2ZW50VGltZXIgfHwgdGhpcy5pc1NsaWRlKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuZGlzU2Nyb2xsICYmIG8uZXZlbnQuc3RvcChlKTsKICAgICAgICAgICAgdmFyIHRvdWNoZXMgPSBlLnRvdWNoZXM7CiAgICAgICAgICAgIGlmKCF0b3VjaGVzIHx8IHRvdWNoZXMubGVuZ3RoID4gMSkgIHJldHVybjsKICAgICAgICAgICAgdGhpcy52aWV3RGl2LnN0eWxlLndlYmtpdFRyYW5zaXRpb25EdXJhdGlvbiA9ICIwbXMiOwogICAgICAgICAgICB0aGlzLmlzRHJhZyA9IHRydWU7CiAgICAgICAgICAgIGlmKHRoaXMuYXV0b1BsYXkpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0b3VjaCA9IHRvdWNoZXNbMF07CiAgICAgICAgICAgIHZhciBkYzsKICAgICAgICAgICAgaWYodGhpcy5pc0xvbikgewogICAgICAgICAgICAgICAgZGMgPSB0b3VjaC5wYWdlWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRjID0gdG91Y2gucGFnZVg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy50b3VjaFN0YXJ0UGl4ZWxYID0gdG91Y2gucGFnZVg7CiAgICAgICAgICAgIHRoaXMudG91Y2hTdGFydFBpeGVsWSA9IHRvdWNoLnBhZ2VZOwogICAgICAgICAgICB0aGlzLnBhZ2VEcmFnU3RhcnRDID0gdGhpcy5wYWdlRHJhZ1RlbXBDID0gZGM7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgdGhpcy5kcmFndGltZXIgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZih0aGF0LnBhZ2VEcmFnVGVtcEMgPT0gdGhhdC5wYWdlRHJhZ0VuZEMpIHJldHVybjsKICAgICAgICAgICAgICAgIHRoYXQucGFnZURyYWdFbmRDID0gdGhhdC5wYWdlRHJhZ1RlbXBDOwogICAgICAgICAgICAgICAgdmFyIGRpcyA9IHRoYXQucGFnZURyYWdUZW1wQyAtIHRoYXQucGFnZURyYWdTdGFydEM7CiAgICAgICAgICAgICAgICB0aGF0LnBhZ2VEcmFnU3RhcnRDID0gdGhhdC5wYWdlRHJhZ1RlbXBDOwogICAgICAgICAgICAgICAgdmFyIHR2YWx1ZSA9IHRoYXQudHJhbnNsYXRlVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgbnZhbHVlID0gdHZhbHVlICsgZGlzLAogICAgICAgICAgICAgICAgICAgIG50cmFuc2Zvcm07CiAgICAgICAgICAgICAgICBpZih0aGF0LmlzTG9uKSB7CiAgICAgICAgICAgICAgICAgICAgbnRyYW5zZm9ybSA9ICJ0cmFuc2xhdGUzZCgwLCAiICsgbnZhbHVlICsgInB4LCAwKSI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG50cmFuc2Zvcm0gPSAidHJhbnNsYXRlM2QoIiArIG52YWx1ZSArICJweCwgMCwgMCkiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhhdC51cGRhdGVUcmFuc2xhdGVWYWx1ZShudmFsdWUpOwogICAgICAgICAgICAgICAgdGhhdC5jaGFuZ2VEaXMgKz0gZGlzOwogICAgICAgICAgICAgICAgdGhhdC52aWV3RGl2LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IG50cmFuc2Zvcm07CiAgICAgICAgICAgIH0sIDE2KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaE1vdmUKICAgICAgICAgKiBAZGVzYyDmi5bmi73ov5vooYwKICAgICAgICAgKiBAcGFyYW0gZSB7d2luZG93LmV2ZW50fQogICAgICAgICAqLwogICAgICAgIG9uVG91Y2hNb3ZlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciB0b3VjaGVzID0gZS50b3VjaGVzOwogICAgICAgICAgICBpZighdGhpcy5pc0RyYWcgfHwgIXRvdWNoZXMgfHwgdG91Y2hlcy5sZW5ndGggPiAxKSAgICByZXR1cm47CiAgICAgICAgICAgIHZhciB0b3VjaCA9IHRvdWNoZXNbMF0sCiAgICAgICAgICAgICAgICBkYzsKICAgICAgICAgICAgaWYodGhpcy5pc0xvbikgewogICAgICAgICAgICAgICAgZGMgPSB0b3VjaC5wYWdlWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRjID0gdG91Y2gucGFnZVg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5wYWdlRHJhZ1RlbXBDID09IGRjKQlyZXR1cm47CiAgICAgICAgICAgIHZhciBwaXhlbCA9IHsKICAgICAgICAgICAgICAgIHBhZ2VYOiB0aGlzLnRvdWNoU3RhcnRQaXhlbFgsCiAgICAgICAgICAgICAgICBwYWdlWTogdGhpcy50b3VjaFN0YXJ0UGl4ZWxZCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFuZ2xlID0gby51dGlsLmdldERpcmVjdGlvbihwaXhlbCwgdG91Y2gpOwogICAgICAgICAgICB0aGlzLnBhZ2VEcmFnVGVtcEMgPSBkYzsKICAgICAgICAgICAgaWYodGhpcy5kaXNTY3JvbGwpICByZXR1cm4gby5ldmVudC5zdG9wKGUpOwogICAgICAgICAgICBpZigodGhpcy5pc0xvbiAmJiAoYW5nbGUgPT0gInVwIiB8fCBhbmdsZSA9PSAiZG93biIpKSB8fAogICAgICAgICAgICAgICAgKCF0aGlzLmlzTG9uICYmIChhbmdsZSA9PSAibGVmdCIgfHwgYW5nbGUgPT0gInJpZ2h0IikpKSB7CiAgICAgICAgICAgICAgICBvLmV2ZW50LnN0b3AoZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25Ub3VjaEVuZAogICAgICAgICAqIEBkZXNjIOaLluaLvee7k+adnwogICAgICAgICAqIEBwYXJhbSBlIHt3aW5kb3cuZXZlbnR9CiAgICAgICAgICovCiAgICAgICAgb25Ub3VjaEVuZDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICB0aGlzLmlzRHJhZyA9IGZhbHNlOwogICAgICAgICAgICBpZih0aGlzLmRyYWd0aW1lcikgewogICAgICAgICAgICAgICAgd2luZG93LmNsZWFySW50ZXJ2YWwodGhpcy5kcmFndGltZXIpOwogICAgICAgICAgICAgICAgdGhpcy5kcmFndGltZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDsKICAgICAgICAgICAgaWYodGFyZ2V0ID09IHRoaXMucHJlRG9tIHx8IHRhcmdldCA9PSB0aGlzLm5leHREb20pIHJldHVybjsKICAgICAgICAgICAgaWYoTWF0aC5hYnModGhpcy5jaGFuZ2VEaXMpIDw9IHRoaXMuc3ByaW5nQmFja0RpcykgewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3QodGhpcy5jdXJyZW50LmluZGV4KTsKICAgICAgICAgICAgfSBlbHNlIGlmKHRoaXMubG9vcCkgewogICAgICAgICAgICAgICAgaWYodGhpcy5jaGFuZ2VEaXMgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VsZWN0TmV4dCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZWxlY3RQcmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmKCF0aGlzLmxvb3ApIHsKICAgICAgICAgICAgICAgIGlmKHRoaXMuY2hhbmdlRGlzIDwgMCAmJiB0aGlzLmN1cnJlbnQuaW5kZXggIT0gdGhpcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VsZWN0TmV4dCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKHRoaXMuY2hhbmdlRGlzID4gMCAmJiB0aGlzLmN1cnJlbnQuaW5kZXggIT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NlbGVjdFByZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdCh0aGlzLmN1cnJlbnQuaW5kZXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY2hhbmdlRGlzID0gMDsKICAgICAgICAgICAgaWYodGhpcy5hdXRvUGxheSkgewogICAgICAgICAgICAgICAgdGhpcy5zdGFydCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGdldERhdGFCeQogICAgICAgICAqIEBkZXNjIOaKiuWtmOeahOaVsOaNruS4reeahOafkOmhueWPluWHuuadpQogICAgICAgICAqIEBwYXJhbSBpbmRleCB7TnVtYmVyfQogICAgICAgICAqIEBwYXJhbSBwcm8ge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBnZXREYXRhQnk6IGZ1bmN0aW9uKGluZGV4LCBwcm8pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YVtpbmRleF1bdGhpcy5kYXRhRmllbGRbcHJvXV07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5XaWRnZXQuU2xpZGVyLnN0YXJ0CiAgICAgICAgICogQGRlc2Mg5byA5aeL6L2u5pKtCiAgICAgICAgICovCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgdGhpcy50aW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KG8udXRpbC5iaW5kKHRoaXMuX2NhbGNDdXJyZW50LCB0aGlzKSwgdGhpcy5hdXRvUGxheVRpbWUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBfY2FsY0N1cnJlbnQKICAgICAgICAgKiBAZGVzYyDov5vooYzova7mkq0KICAgICAgICAgKi8KICAgICAgICBfY2FsY0N1cnJlbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmN1cnJlbnQuaW5kZXg7CiAgICAgICAgICAgIHZhciBsZW5ndGggPSB0aGlzLmxvb3AgPyB0aGlzLmxlbmd0aCAtIDIgOiB0aGlzLmxlbmd0aDsKICAgICAgICAgICAgaW5kZXggPSAoKytpbmRleCA9PSBsZW5ndGgpID8gMCA6IGluZGV4OwogICAgICAgICAgICB0aGlzLnNlbGVjdChpbmRleCwgIm5leHQiKTsKICAgICAgICAgICAgdGhpcy5zdGFydCgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlNsaWRlci5zdG9wCiAgICAgICAgICogQGRlc2Mg5YGc5q2i6L2u5pKtCiAgICAgICAgICovCiAgICAgICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMudGltZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy50aW1lcik7CiAgICAgICAgICAgICAgICB0aGlzLnRpbWVyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlNsaWRlci5zZWxlY3QKICAgICAgICAgKiBAZGVzYyDpgInmi6nnrKxu5Liq5a2Q6IqC54K5CiAgICAgICAgICogQHBhcmFtIGluZGV4IHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgc2VsZWN0OiBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgICB0aGlzLmlzU2xpZGUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnZpZXdEaXYuc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gdGhpcy5hbmltYXRpb25UaW1lICsgIm1zIjsKCiAgICAgICAgICAgIGlmKHRoaXMubG9vcCkgewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RMb29wKGluZGV4LCBhcmd1bWVudHNbMV0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3ROb0xvb3AoaW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0Q3VycmVudCh7CiAgICAgICAgICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgICAgICAgICBkb206IHRoaXMuZG9tc1tpbmRleF0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHRoaXMuX3R5cGUgPT0gImltZyIgJiYgdGhpcy51bmxvYWRJbWFnZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF4ID0gaW5kZXggKyBNYXRoLmNlaWwodGhpcy5sb2FkSW1hZ2VOdW1iZXIgLyAyKSwKICAgICAgICAgICAgICAgICAgICBtaW4gPSBNYXRoLmZsb29yKHRoaXMubG9hZEltYWdlTnVtYmVyIC8gMiksCiAgICAgICAgICAgICAgICAgICAgX2xlbiA9IHRoaXMudW5sb2FkSW1hZ2UubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGkgPSBfbGVuOwogICAgICAgICAgICAgICAgZm9yKDsgaS0tOyApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2luZGV4ID0gdGhpcy51bmxvYWRJbWFnZVtpXS5pbmRleDsKICAgICAgICAgICAgICAgICAgICBpZigoX2luZGV4IDwgbWF4KSAmJiAhdGhpcy5wYWdlRHJhZ0RpcmVjdGlvbiB8fAogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZXggLSBfaW5kZXgpIDw9IG1pbiAmJiB0aGlzLnBhZ2VEcmFnRGlyZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW1hZ2VMb2FkKF9pbmRleCwgdGhpcy51bmxvYWRJbWFnZVtpXS5kb20pOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVubG9hZEltYWdlLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoYXQuaXNTbGlkZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhhdC5ub3RpZnkoInNsaWRlci11aS1zbGlkZWNoYW5nZSIpOwogICAgICAgICAgICB9LCB0aGlzLmFuaW1hdGlvblRpbWUgKyA1MCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHNlbGVjdE5vTG9vcAogICAgICAgICAqIEBkZXNjIOi9ruaSreWIsOacgOWQjuWGjei9ruaSreWbnuadpQogICAgICAgICAqIEBwYXJhbSBpbmRleCB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHNlbGVjdE5vTG9vcDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZXN0ciA9ICJ0cmFuc2xhdGUzZCgiOwogICAgICAgICAgICBpZih0aGlzLmlzTG9uKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IDAgLSAoaW5kZXggKiB0aGlzLmhlaWdodCk7CiAgICAgICAgICAgICAgICB0cmFuc2xhdGVzdHIgKz0gIjAsICIgKyB0ICsgInB4LCAwKSI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IDAgLSAoaW5kZXggKiB0aGlzLndpZHRoKTsKICAgICAgICAgICAgICAgIHRyYW5zbGF0ZXN0ciArPSB0ICsgInB4LCAwLCAwKSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy51cGRhdGVUcmFuc2xhdGVWYWx1ZSh0KTsKICAgICAgICAgICAgdGhpcy52aWV3RGl2LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IHRyYW5zbGF0ZXN0cjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2VsZWN0TG9vcAogICAgICAgICAqIEBkZXNjIOW+queOr+mAieaLqQogICAgICAgICAqIEBwYXJhbSBpbmRleCB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHNlbGVjdExvb3A6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgIHZhciBfaW5kZXggPSB0aGlzLmN1cnJlbnQuaW5kZXgsCiAgICAgICAgICAgICAgICBsZW4gPSB0aGlzLmxlbmd0aCAtIDIsCiAgICAgICAgICAgICAgICB0ZW1wLAogICAgICAgICAgICAgICAgX3RlbXAgPSB0ZW1wID0gInRyYW5zbGF0ZTNkKCI7CiAgICAgICAgICAgIGlmKChpbmRleCA9PSAwICYmIF9pbmRleCA9PSAobGVuIC0gMSkpIHx8IChfaW5kZXggPT0gMCAmJiBpbmRleCA9PSAobGVuIC0gMSkpKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgZCA9IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgICAgIGlmKGxlbiA9PSAyICYmIGQgJiYgKChpbmRleCA9PSAwICYmIF9pbmRleCA9PSAobGVuIC0gMSkgJiYgZCA9PSAicHJlIikKICAgICAgICAgICAgICAgICAgICB8fCAoaW5kZXggPT0gKGxlbiAtIDEpICYmIF9pbmRleCA9PSAwICYmIGQgPT0gIm5leHQiKSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdE5vTG9vcChpbmRleCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoaW5kZXggPT0gMCAmJiBfaW5kZXggPT0gKGxlbiAtIDEpKSB7CiAgICAgICAgICAgICAgICAgICAgX3RlbXAgKz0gIjAsIDAsIDApIjsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVRyYW5zbGF0ZVZhbHVlKDApOwogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuaXNMb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcCArPSAiMCwgIiArICgwIC0gdGhpcy5oZWlnaHQgKiBsZW4pICsgInB4LCAwKSI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcCArPSAoMCAtIHRoaXMud2lkdGggKiBsZW4pICsgInB4LCAwLCAwKSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmKGluZGV4ID09IChsZW4gLSAxKSAmJiBfaW5kZXggPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuaXNMb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcCArPSAiMCwgIiArIHRoaXMuaGVpZ2h0ICsgInB4LCAwKSI7CiAgICAgICAgICAgICAgICAgICAgICAgIF90ZW1wICs9ICIwLCAiICsgKDAgLSB0aGlzLmhlaWdodCAqIChsZW4gLSAxKSkgKyAicHgsIDApIjsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVUcmFuc2xhdGVWYWx1ZSgwIC0gdGhpcy5oZWlnaHQgKiAobGVuIC0gMSkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXAgKz0gdGhpcy53aWR0aCArICJweCwgMCwgMCkiOwogICAgICAgICAgICAgICAgICAgICAgICBfdGVtcCArPSAoMCAtIHRoaXMud2lkdGggKiAobGVuIC0gMSkpICsgInB4LCAwLCAwKSI7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVHJhbnNsYXRlVmFsdWUoMCAtIHRoaXMud2lkdGggKiAobGVuIC0gMSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuaXNUaW1lciA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgb25DaGFuZ2VkID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgIG8uZXZlbnQudW4odGhhdC52aWV3RGl2LCAid2Via2l0VHJhbnNpdGlvbkVuZCIsIG9uQ2hhbmdlZCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIGlmKCF0aGF0LmlzVGltZXIpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBpZih0aGF0LmV2ZW50VGltZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGF0LmV2ZW50VGltZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmV2ZW50VGltZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGF0LnZpZXdEaXYuc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gIjBtcyI7CiAgICAgICAgICAgICAgICAgICAgdGhhdC52aWV3RGl2LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IF90ZW1wOwogICAgICAgICAgICAgICAgICAgIF90ZW1wID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG8uZXZlbnQub24odGhpcy52aWV3RGl2LCAid2Via2l0VHJhbnNpdGlvbkVuZCIsIG9uQ2hhbmdlZCwgZmFsc2UpOwogICAgICAgICAgICAgICAgdGhpcy52aWV3RGl2LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IHRlbXA7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50VGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBvLmV2ZW50LnVuKHRoYXQudmlld0RpdiwgIndlYmtpdFRyYW5zaXRpb25FbmQiLCBvbkNoYW5nZWQsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB0aGF0LnZpZXdEaXYuc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gIjBtcyI7CiAgICAgICAgICAgICAgICAgICAgdGhhdC52aWV3RGl2LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IF90ZW1wOwogICAgICAgICAgICAgICAgICAgIF90ZW1wID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGF0LmV2ZW50VGltZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHRoYXQuaXNUaW1lciA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSwgdGhpcy5hbmltYXRpb25UaW1lIC0gNTAgPCAwID8gMCA6IHRoaXMuYW5pbWF0aW9uVGltZSAtIDUwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0Tm9Mb29wKGluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuV2lkZ2V0LlNsaWRlci5fc2VsZWN0UHJlCiAgICAgICAgICogQGRlc2Mg6YCJ5oup5LiK5LiA5byg6L2u5pKt5Zu+CiAgICAgICAgICovCiAgICAgICAgX3NlbGVjdFByZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMuaXNTbGlkZSkgICAgcmV0dXJuOwogICAgICAgICAgICB2YXIgbGVuID0gdGhpcy5sb29wID8gdGhpcy5sZW5ndGggLSAyIDogdGhpcy5sZW5ndGg7CiAgICAgICAgICAgIHZhciBpbmRleCA9ICh0aGlzLmN1cnJlbnQuaW5kZXggLSAxKSA8IDAgPyAobGVuIC0gMSkgOiB0aGlzLmN1cnJlbnQuaW5kZXggLSAxOwogICAgICAgICAgICB0aGlzLnBhZ2VEcmFnRGlyZWN0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zZWxlY3QoaW5kZXgsICJwcmUiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5TbGlkZXIuX3NlbGVjdE5leHQKICAgICAgICAgKiBAZGVzYyDpgInmi6nkuIvkuIDlvKDova7mkq3lm74KICAgICAgICAgKi8KICAgICAgICBfc2VsZWN0TmV4dDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMuaXNTbGlkZSkgICByZXR1cm47CiAgICAgICAgICAgIHZhciBsZW4gPSB0aGlzLmxvb3AgPyB0aGlzLmxlbmd0aCAtIDIgOiB0aGlzLmxlbmd0aDsKICAgICAgICAgICAgdmFyIGluZGV4ID0gKHRoaXMuY3VycmVudC5pbmRleCArIDEpID4gKGxlbiAtIDEpID8gMCA6IHRoaXMuY3VycmVudC5pbmRleCArIDE7CiAgICAgICAgICAgIHRoaXMucGFnZURyYWdEaXJlY3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zZWxlY3QoaW5kZXgsICJuZXh0Iik7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuV2lkZ2V0LlNsaWRlciIKICAgIH0pOwoKICAgIC8qKgogICAgICogQG1ldGhvZCBvY3RvcHVzLldpZGdldC5zbGlkZXIKICAgICAqIEBwYXJhbSBlbCB7RE9NRWxlbWVudH0KICAgICAqIEByZXR1cm5zIHtvLldpZGdldC5IdG1sU2xpZGVyfQogICAgICogQGRlc2Mg55Sf5oiQ5LiOaHRtbOaooeeJiOebuOe7keWumueahOi9ruaSreWbviDmiYDmnInnmoTlj4LmlbDpg73ku6VodG1s5qih54mI5b2i5byP5Lyg5YWlCiAgICAgKi8KICAgIG8uV2lkZ2V0LnNsaWRlciA9IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgcmV0dXJuIG5ldyBvLldpZGdldC5IdG1sU2xpZGVyKHsKICAgICAgICAgICAgZWw6IGVsCiAgICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQGNsYXNzIG9jdG9wdXMuV2lkZ2V0Lkh0bWxTbGlkZXIKICAgICAqIEBwYXJlbnQgb2N0b3B1cy5XaWRnZXQuU2xpZGVyCiAgICAgKiBAZGVzYyDlj4LmlbDkuI5vY3RvcHVzLldpZGdldC5TbGlkZXLnm7jlkIwg5LiN5ZCM55qE5pivIOi/meS4quexu+S7hemZkOS6juWvueW3suacieespuWQiOinhOiMg+eahGh0bWzmqKHniYjnmoTmlLnpgKDkuI7lsIHoo4UKICAgICAqIOespuWQiOadoeS7tueahGh0bWzmqKHniYjlsZ7mgKfljIXmi6wKICAgICAqIGRhdGEtb2N0b3B1c3VpLXNsaWRlci1sb29wIOWmguaenOaXoOatpOWxnuaAp+WImei9ruaSreWbvuS4jeWJjeWQjuW+queOrwogICAgICogZGF0YS1vY3RvcHVzdWktc2xpZGVyLW5vYnV0dG9uIOWmguaenOiuvue9ruatpOWxnuaApyDliJnkuI3ljIXlkKvkuIrkuIDkuKrkuIvkuIDkuKrmjInpkq4KICAgICAqIGRhdGEtb2N0b3B1c3VpLXNsaWRlci1kaXNhYmxlIOWmguaenOiuvue9ruatpOWxnuaApyDliJnpmaTkuobkuI3ljIXlkKvmjInpkq7lpJYg5Lmf5rKh5pyJ5Lu75L2V5LqL5Lu255uR5ZCsIOWPr+eUqOS6juWNleW8oOWbvgogICAgICogZGF0YS1vY3RvcHVzdWktc2xpZGVyLW5vZ2l6bW9zIOWmguaenOiuvue9ruatpOWxnuaApyDliJnkuI3ljIXlkKvlj7PkuIvop5LnmoTop5LmoIcKICAgICAqIGRhdGEtb2N0b3B1c3VpLXNsaWRlci1ub3RhdXRvIOWmguaenOiuvue9ruatpOWxnuaApyDliJnkuI3oh6rliqjop6blj5Hova7mkq0KICAgICAqIGRhdGEtb2N0b3B1c3VpLXNsaWRlci1hZGFwdGl2ZSDlpoLmnpzorr7nva7mraTlsZ7mgKcg5YiZ6L2u5pKt5Zu+5Lul6buY6K6k5aSn5bCP6Ieq5Yqo5pKR5byACiAgICAgKiBkYXRhLW9jdG9wdXN1aS1zbGlkZXItbm90aXRsZSDlpoLmnpzorr7nva7mraTlsZ7mgKcg5YiZ5LiN5YyF5ZCr6L2u5pKt5Zu+55qEdGl0bGUKICAgICAqLwogICAgby5XaWRnZXQuSHRtbFNsaWRlciA9IG8uZGVmaW5lKG8uV2lkZ2V0LlNsaWRlciwgewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBmcmFnbWVudAogICAgICAgICAqIEB0eXBlIHtEb2N1bWVudEZyYWdtZW50fQogICAgICAgICAqIEBkZXNjIOaWh+aho+eijueJhyDnlKjmnaXnlJ/miJDmlLnpgKDlkI7nmoTlrp7pmYVkb20KICAgICAgICAgKi8KICAgICAgICBmcmFnbWVudDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgYWRhcHRpdmUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqIEBkZXNjIOeUqOadpeehruiupOW9k+WJjei9ruaSreWbvuaYr+WQpuiHquWKqOaSkeW8gAogICAgICAgICAqLwogICAgICAgIGFkYXB0aXZlOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvL+iZveeEtue7p+aJv+iHqm9jdG9wdXMuV2lkZ2V0LlNsaWRlciDkvYbmmK/mnoTpgKDlh73mlbDov5nph4zluIzmnJvkvb/nlKhvY3RvcHVzLldpZGdldOeahOaehOmAoOWHveaVsAogICAgICAgICAgICBvLldpZGdldC5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLmRhdGFGaWVsZCA9IHsKICAgICAgICAgICAgICAgIHRpdGxlOiAidGl0bGUiLAogICAgICAgICAgICAgICAgdXJsOiAidXJsIgogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IHRoaXMuZWwucGFyZW50Tm9kZTsKICAgICAgICAgICAgdGhpcy5mcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgdGhpcy51bmxvYWRJbWFnZSA9IFtdOwogICAgICAgICAgICB0aGlzLmxvb3AgPSBvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktc2xpZGVyLWxvb3AiKTsKICAgICAgICAgICAgdGhpcy5oYXNCdXR0b24gPSAhby5kb20uZGF0YSh0aGlzLmVsLCAib2N0b3B1c3VpLXNsaWRlci1ub2J1dHRvbiIpOwogICAgICAgICAgICB0aGlzLmhhc0dpem1vcyA9ICFvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktc2xpZGVyLW5vZ2l6bW9zIik7CiAgICAgICAgICAgIHRoaXMuZGlzYWJsZUFsbCA9IG8uZG9tLmRhdGEodGhpcy5lbCwgIm9jdG9wdXN1aS1zbGlkZXItZGlzYWJsZSIpOwogICAgICAgICAgICB0aGlzLmlzRGlzYWJsZUEgPSBvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktc2xpZGVyLWRpc2FibGV0YXAiKTsKICAgICAgICAgICAgdGhpcy5hdXRvUGxheSA9ICFvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktc2xpZGVyLW5vdGF1dG8iKTsKICAgICAgICAgICAgdGhpcy5hZGFwdGl2ZSA9IG8uZG9tLmRhdGEodGhpcy5lbCwgIm9jdG9wdXN1aS1zbGlkZXItYWRhcHRpdmUiKTsKICAgICAgICAgICAgdGhpcy5oYXNUaXRsZSA9ICFvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktc2xpZGVyLW5vdGl0bGUiKTsKICAgICAgICAgICAgdGhpcy5kaXNTY3JvbGwgPSBvLmRvbS5kYXRhKHRoaXMuZWwsICJvY3RvcHVzdWktc2xpZGVyLWRpc3Njcm9sbCIpOwogICAgICAgICAgICB0aGlzLmJ1aWxkU2VsZigpOwogICAgICAgICAgICBpZighdGhpcy5pc1Nob3cpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCF0aGlzLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMuYXV0b1BsYXkgJiYgdGhpcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5ub3RpZnkoInNsaWRlci11aS1hZnRlcnJlbmRlciIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBidWlsZFNlbGYKICAgICAgICAgKiBAZGVzYyDnlJ/miJDoh6rouqvoioLngrkKICAgICAgICAgKi8KICAgICAgICBidWlsZFNlbGY6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLmVsLmNoaWxkcmVuLAogICAgICAgICAgICAgICAgbGVuID0gY2hpbGRyZW4ubGVuZ3RoOwogICAgICAgICAgICBpZihsZW4gPCAyKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gbGVuOwogICAgICAgICAgICB0aGlzLmRhdGEgPSBbXTsKICAgICAgICAgICAgdGhpcy5kb21zID0gW107CiAgICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5lbC5jbG9uZU5vZGUoZmFsc2UpOwogICAgICAgICAgICB0aGlzLmJ1aWxkRG9tcyhub2RlKTsKICAgICAgICAgICAgdGhpcy5idWlsZFNsaWRlcihjaGlsZHJlbik7CiAgICAgICAgICAgIG5vZGUuYXBwZW5kQ2hpbGQodGhpcy52aWV3RGl2KTsKICAgICAgICAgICAgdGhpcy5lbC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChub2RlLCB0aGlzLmVsKTsKICAgICAgICAgICAgdGhpcy5lbCA9IG5vZGU7CiAgICAgICAgICAgIHRoaXMuZWwuc3R5bGUuY3NzVGV4dCA9ICJvdmVyZmxvdzogaGlkZGVuOyBwb3NpdGlvbjogcmVsYXRpdmU7IjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgYnVpbGRTbGlkZXIKICAgICAgICAgKiBAZGVzYyDnlJ/miJDova7mkq3lm74KICAgICAgICAgKi8KICAgICAgICBidWlsZFNsaWRlcjogZnVuY3Rpb24oaXRlbXMpIHsKICAgICAgICAgICAgby51dGlsLmVhY2goaXRlbXMsIG8udXRpbC5iaW5kKHRoaXMuYnVpbGRJdGVtLCB0aGlzKSk7CiAgICAgICAgICAgIGlmKHRoaXMubG9vcCAmJiB0aGlzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIHZhciBmcmlzdGRvbSA9IHRoaXMuZG9tc1swXS5jbG9uZU5vZGUodHJ1ZSksCiAgICAgICAgICAgICAgICAgICAgbGFzdGRvbSA9IHRoaXMuZG9tc1t0aGlzLmxlbmd0aCAtIDFdLmNsb25lTm9kZSh0cnVlKTsKICAgICAgICAgICAgICAgIHRoaXMuZG9tcy5wdXNoKGZyaXN0ZG9tKTsKICAgICAgICAgICAgICAgIHRoaXMuZG9tcy5wdXNoKGxhc3Rkb20pOwogICAgICAgICAgICAgICAgdGhpcy5mcmFnbWVudC5hcHBlbmRDaGlsZChmcmlzdGRvbSk7CiAgICAgICAgICAgICAgICB0aGlzLmZyYWdtZW50LmFwcGVuZENoaWxkKGxhc3Rkb20pOwogICAgICAgICAgICAgICAgdGhpcy5sZW5ndGggKz0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNldEN1cnJlbnQoewogICAgICAgICAgICAgICAgZG9tOiB0aGlzLmRvbXNbMF0sCiAgICAgICAgICAgICAgICBpbmRleDogMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy52aWV3RGl2LmFwcGVuZENoaWxkKHRoaXMuZnJhZ21lbnQpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCByZW5kZXIKICAgICAgICAgKiBAZGVzYyDpmLLmraLooqvosIPnlKgKICAgICAgICAgKi8KICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRoaXMgY2xhc3MgY2FuJ3QgcmVuZGVyISA6KSIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBidWlsZEl0ZW0KICAgICAgICAgKiBAZGVzYyDnlJ/miJDmr4/lvKDljZXlvKDnmoTova7mkq3lm74KICAgICAgICAgKi8KICAgICAgICBidWlsZEl0ZW06IGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CiAgICAgICAgICAgIGlmKCFvLnV0aWwuaXNOb2RlKGl0ZW0pKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuZGF0YS5wdXNoKHsKICAgICAgICAgICAgICAgIHVybDogby5kb20uZGF0YShpdGVtLCAib2N0b3B1c3VpLXNsaWRlci11cmwiKSwKICAgICAgICAgICAgICAgIHRpdGxlOiBvLmRvbS5kYXRhKGl0ZW0sICJvY3RvcHVzdWktc2xpZGVyLXRpdGxlIikKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBkb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICAgICAiY2xhc3MiOiAib2N0b3B1c3VpLXNsaWRlci1jaGlsZHJlbiIsCiAgICAgICAgICAgICAgICAgICAgInN0eWxlIjogIi13ZWJraXQtdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKTsgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCAwLCAwKTsgcG9zaXRpb246IHJlbGF0aXZlOyIKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgX2l0ZW0gPSBpdGVtLmNsb25lTm9kZSh0cnVlKSwKICAgICAgICAgICAgICAgIF9pdGVtY3NzVGV4dCA9ICJ3aWR0aDogMTAwJTsiOwogICAgICAgICAgICAhdGhpcy5hZGFwdGl2ZSAmJiAoX2l0ZW1jc3NUZXh0ICs9ICIgcG9zaXRpb246IGFic29sdXRlOyBsZWZ0OiAwOyByaWdodDogMDsgdG9wOiAwOyBib3R0b206IDA7IG1hcmdpbjogYXV0bzsiLCB0cnVlKTsKICAgICAgICAgICAgX2l0ZW0uc3R5bGUuY3NzVGV4dCA9IF9pdGVtY3NzVGV4dDsKICAgICAgICAgICAgZG9tLmFwcGVuZENoaWxkKF9pdGVtKTsKICAgICAgICAgICAgdmFyIHRpdGxlID0gdGhpcy5nZXREYXRhQnkoaW5kZXgsICJ0aXRsZSIpOwogICAgICAgICAgICBpZih0aGlzLmhhc1RpdGxlICYmIHRpdGxlKSB7CiAgICAgICAgICAgICAgICB2YXIgdGl0bGVkb20gPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgImNsYXNzIjogIm9jdG9wdXN1aS1zbGlkZXItaW1nVGl0bGUiCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgdGl0bGVjb250ZW50ID0gby5kb20uY3JlYXRlRG9tKCJkaXYiLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJjbGFzcyI6ICJvY3RvcHVzdWktc2xpZGVyLWltZ1RpdGxlQ29udGVudCBvY3RvcHVzdWktdGV4dC1saW1pdCIKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRpdGxlY29udGVudC5pbm5lckhUTUwgPSBvLnV0aWwuZW5jb2RlSHRtbCh0aXRsZSk7CiAgICAgICAgICAgICAgICB0aXRsZWRvbS5hcHBlbmRDaGlsZCh0aXRsZWNvbnRlbnQpOwogICAgICAgICAgICAgICAgZG9tLmFwcGVuZENoaWxkKHRpdGxlZG9tKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBfX3VybCA9IHRoaXMuZ2V0RGF0YUJ5KGluZGV4LCAidXJsIikgfHwgIiIsCiAgICAgICAgICAgICAgICBfX3RhcmdldCA9IHRoaXMuaXNOZXdUYWIgPyAiX2JsYW5rIiA6ICJfc2VsZiI7CiAgICAgICAgICAgIG8uZXZlbnQub24oZG9tLCAiY2xpY2siLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGF0LmlzRGlzYWJsZUEpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cub3BlbihfX3VybCwgX190YXJnZXQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoYXQubm90aWZ5KCJzbGlkZXItaXRlbS1vbnRhcCIsIHRoYXQuZGF0YVtpbmRleF0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5mcmFnbWVudC5hcHBlbmRDaGlsZChkb20pOwogICAgICAgICAgICB0aGlzLmRvbXMucHVzaChkb20pOwogICAgICAgIH0sCgogICAgICAgIENMQVNTX05BTUU6ICJvY3RvcHVzLldpZGdldC5IdG1sU2xpZGVyIgogICAgfSk7Cgp9KShvY3RvcHVzKTsvKioKICogQGZpbGUKICogd2ViYXBw6YCa55So57uE5Lu257uT5p6E5paH5Lu2CiAqIOWumuS5ieaooeWdl+euoeeQhgogKiBAcmVxdWlyZSBsaWIvY2xhc3MuanMKICogQHJlcXVpcmUgbGliL3V0aWwuanMKICogQHJlcXVpcmUgbGliL2RvbS5qcwogKiBAcmVxdWlyZSBsaWIvZXZlbnQuanMKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCgkvKioKCSAqIEBuYW1lc3BhY2Ugb2N0b3B1cy5hcHAKCSAqIEBkZXNjIG9jdG9wdXMgYXBw5qih5Z2X57uT5p6ECgkgKi8KICAgIG8uYXBwID0gKGZ1bmN0aW9uKCkgewoKICAgICAgICB2YXIgYXBwID0gbnVsbDsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLnJlZ2lzdGVyTW9kdWxlCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICogQHBhcmFtIGZ1bmMKICAgICAgICAgKiBAcGFyYW0gaW1tZWRpYXRlCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJNb2R1bGUoaWQsIGZ1bmMsIGltbWVkaWF0ZSkgewogICAgICAgICAgICBpbml0aWFsaXplKHVuZGVmaW5lZCkucmVnaXN0ZXJNb2R1bGUoaWQsIGZ1bmMsIGltbWVkaWF0ZSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgaW5pdGlhbGl6ZQogICAgICAgICAqIEBwYXJhbSBvcHRpb25zCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gaW5pdGlhbGl6ZShvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiAhYXBwID8gKGFwcCA9IG5ldyBvLkFwcChvcHRpb25zKSwgYXBwKSA6ICghIW9wdGlvbnMgPyAoY29uc29sZS53YXJuKCJUaGUgYXBwIGhhcyBhbHJlYWR5IGV4aXN0ISBGYWlsdXJlIHRvIHNldCB1cCB0aGUgY29uZmlnIiksIGFwcCkgOiBhcHApOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLmFkZENvbmZpZwogICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAqIEBwYXJhbSBvYmoKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBhZGRDb25maWcoaWQsIG9iaikgewogICAgICAgICAgICBpbml0aWFsaXplKHVuZGVmaW5lZCkuYWRkQ29uZmlnKGlkLCBvYmopOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLnJlZ2lzdGVyQXBpCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICogQHBhcmFtIG9iagogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyQXBpKGlkLCBvYmopewogICAgICAgICAgICBpbml0aWFsaXplKHVuZGVmaW5lZCkucmVnaXN0ZXJBcGkoaWQsIG9iaik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHB1YmxpYwogICAgICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLmFkZENvbmZpZwogICAgICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgICAgICogQHBhcmFtIG9iagogICAgICAgICAgICAgKi8KICAgICAgICAgICAgYWRkQ29uZmlnOiBhZGRDb25maWcsCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHB1YmxpYwogICAgICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLnJlZ2lzdGVyQXBpCiAgICAgICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAgICAgKiBAcGFyYW0gb2JqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZWdpc3RlckFwaTogcmVnaXN0ZXJBcGksCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHB1YmxpYwogICAgICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuYXBwLnJlZ2lzdGVyTW9kdWxlCiAgICAgICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAgICAgKiBAcGFyYW0gZnVuYwogICAgICAgICAgICAgKiBAcGFyYW0gaW1tZWRpYXRlCiAgICAgICAgICAgICAqIEBkZXNjIOazqOWGjOS4gOS4quaooeWdlwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcmVnaXN0ZXJNb2R1bGU6IHJlZ2lzdGVyTW9kdWxlLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLmFwcC5pbml0aWFsaXplCiAgICAgICAgICAgICAqIEBwYXJhbSBvcHRpb25zCiAgICAgICAgICAgICAqIEBkZXNjIOWIneWni+WMlmFwcOWvueixoSDlpoLmnpzkuI3ooqvosIPnlKjliJnmjInnhafpu5jorqTlsZ7mgKfliJ3lp4vljJYKICAgICAgICAgICAgICogQHJldHVybnMge29jdG9wdXMuQXBwfGFwcH0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGluaXRpYWxpemU6IGluaXRpYWxpemUKICAgICAgICB9OwogICAgfSkoKTsKCiAgICBvLkFwcCA9IG8uZGVmaW5lKHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaWQKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGlkOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqIEBkZXNjIGFwcOeahOagueiKgueCuQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB2aWV3RWwKICAgICAgICAgKiBAdHlwZSB7RE9NRWxlbWVudH0KICAgICAgICAgKiBAZGVzYyDlj6/op4boioLngrkKICAgICAgICAgKi8KICAgICAgICB2aWV3RWw6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGxheWVycwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAZGVzYyDnrqHnkIbnmoTmqKHlnZcKICAgICAgICAgKi8KICAgICAgICBsYXllcnM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGN1cnJlbnRMYXllcgogICAgICAgICAqIEB0eXBlIHtvLkxheWVyfQogICAgICAgICAqLwogICAgICAgIGN1cnJlbnRMYXllcjogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY21kcwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBjbWRzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBtQ3JlYXRvcgogICAgICAgICAqIEBkZXNjIOeUn+aIkOWZqAogICAgICAgICAqLwogICAgICAgIG1DcmVhdG9yOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBldmVudHMKICAgICAgICAgKiBAdHlwZSB7by5FdmVudHN9CiAgICAgICAgICovCiAgICAgICAgZXZlbnRzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBldmVudExpc3RlbmVycwogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgZXZlbnRMaXN0ZW5lcnM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNtZE1hbmFnZXIKICAgICAgICAgKiBAdHlwZSB7by5DbWRNYW5hZ2VyfQogICAgICAgICAqLwogICAgICAgIGNtZE1hbmFnZXI6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50Q2FjaGVzCiAgICAgICAgICogQGRlc2Mg5LqL5Lu257yT5a2YIOS4u+imgemYsuatoiDkuIDkupvmqKHlnZfmnKrlsLHkvY3ml7bnmoTkuovku7bliIblj5EKICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICovCiAgICAgICAgZXZlbnRDYWNoZXM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzTG9hZAogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzTG9hZDogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNvbmZpZwogICAgICAgICAqIEBkZXNjIOmFjee9rumhuQogICAgICAgICAqLwogICAgICAgIGNvbmZpZzogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgaXNSZXNpemUKICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc1Jlc2l6ZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IHdpZGdldHMKICAgICAgICAgKi8KICAgICAgICB3aWRnZXRzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBpc0luaXREb20KICAgICAgICAgKi8KICAgICAgICBpc0luaXREb206IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjYWNoZUV2ZW50RGlzcGF0Y2gKICAgICAgICAgKiBAZGVzYyDkuovku7bnvJPlhrLlmagKICAgICAgICAgKi8KICAgICAgICBjYWNoZUV2ZW50RGlzcGF0Y2g6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGNvbmZpZ3MKICAgICAgICAgKiBAZGVzYyDphY3nva7pobkKICAgICAgICAgKi8KICAgICAgICBjb25maWdzOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqLwogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGNvbmZpZyA9IHRoaXMuY29uZmlnID0gby5leHRlbmQoe30sIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLm1DcmVhdG9yID0ge307CiAgICAgICAgICAgIHRoaXMuZXZlbnRDYWNoZXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jb25maWdzID0ge307CiAgICAgICAgICAgIHRoaXMuY2FjaGVFdmVudERpc3BhdGNoID0ge307CiAgICAgICAgICAgIHRoaXMuaWQgPSBjb25maWcuaWQgfHwgby51dGlsLmNyZWF0ZVVuaXF1ZUlEKHRoaXMuQ0xBU1NfTkFNRSArICJfIik7CgogICAgICAgICAgICAvL+ebkeWQrHdpbmRvd+S6i+S7tiDlkK/liqjmqKHlnZcKICAgICAgICAgICAgby5ldmVudC5vbih3aW5kb3csICJyZWFkeSIsIG8udXRpbC5iaW5kKHRoaXMub25XaW5kb3dMb2FkLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICBvLmV2ZW50Lm9uKHdpbmRvdywgInVubG9hZCIsIG8udXRpbC5iaW5kKHRoaXMub25XaW5kb3dVbmxvYWQsIHRoaXMpLCBmYWxzZSk7CiAgICAgICAgICAgIG8uZXZlbnQub24od2luZG93LCAicmVzaXplIiwgby51dGlsLmJpbmQodGhpcy5vbldpbmRvd1Jlc2l6ZSwgdGhpcyksIGZhbHNlKTsKICAgICAgICAgICAgaWYoIm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3cpIHsKICAgICAgICAgICAgICAgIG8uZXZlbnQub24od2luZG93LCAib3JpZW50YXRpb25jaGFuZ2UiLCBvLnV0aWwuYmluZCh0aGlzLm9uT3JpZW50YXRpb25DaGFuZ2VkLCB0aGlzKSwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gbmV3IG8uRXZlbnRzKHRoaXMpOwogICAgICAgICAgICBpZihjb25maWcuZXZlbnRMaXN0ZW5lcnMgJiYgby51dGlsLmlzT2JqZWN0KGNvbmZpZy5ldmVudExpc3RlbmVycykpIHsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRMaXN0ZW5lcnMgPSBjb25maWcuZXZlbnRMaXN0ZW5lcnM7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50cy5yZWdpc3Rlcih0aGlzLmV2ZW50TGlzdGVuZXJzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvL+WRveS7pOaQnuS4iuWOuwogICAgICAgICAgICB0aGlzLmNtZE1hbmFnZXIgPSBuZXcgby5DbWRNYW5hZ2VyKHsKICAgICAgICAgICAgICAgIGFwcDogdGhpcwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYoY29uZmlnLmNtZHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuY21kcyA9IGNvbmZpZy5jbWRzOwogICAgICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5jbWRzLCBvLnV0aWwuYmluZCh0aGlzLnJlZ2lzdGVyQ21kLCB0aGlzKSk7CiAgICAgICAgICAgICAgICB0aGlzLmNtZHMubGVuZ3RoID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnJlZ2lzdGVyQ21kCiAgICAgICAgICogQHBhcmFtIGNtZCB7b2N0b3B1cy5DbWR9CiAgICAgICAgICovCiAgICAgICAgcmVnaXN0ZXJDbWQ6IGZ1bmN0aW9uKGNtZCkgewogICAgICAgICAgICB0aGlzLmNtZE1hbmFnZXIucmVnaXN0ZXIoY21kKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5leGVjdXRlQ21kCiAgICAgICAgICogQHBhcmFtIG5hbWUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gb3BzIHtPYmplY3R9CiAgICAgICAgICogQGRlc2Mg5omn6KGM5oyH5a6a5ZG95LukCiAgICAgICAgICovCiAgICAgICAgZXhlY3V0ZUNtZDogZnVuY3Rpb24obmFtZSwgb3BzKSB7CiAgICAgICAgICAgIHRoaXMuY21kTWFuYWdlci5leGVjdXRlQ29tbWFuZChuYW1lLCBvcHMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnVucmVnaXN0ZXJDbWQKICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHVucmVnaXN0ZXJDbWQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgdGhpcy5jbWRNYW5hZ2VyLnVucmVnaXN0ZXIobmFtZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAucmVnaXN0ZXJNZW1iZXIKICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDms6jlhoznmoTnp43nsbsg5Y+v6YCJ5qih5Z2X5oiW6ICFYXBpCiAgICAgICAgICogQHBhcmFtIGlkIHtTdHJpbmd9IOazqOWGjOeahGlkCiAgICAgICAgICogQHBhcmFtIGNyZWF0b3Ige09iamVjdCB8IEZ1bmN0aW9ufSDmnoTpgKDlmagKICAgICAgICAgKi8KICAgICAgICByZWdpc3Rlck1lbWJlcjogZnVuY3Rpb24odHlwZSwgaWQsIGNyZWF0b3IpIHsKICAgICAgICAgICAgdGhpcy5tQ3JlYXRvclt0eXBlXSA9IHRoaXMubUNyZWF0b3JbdHlwZV0gfHwge307CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1DcmVhdG9yW3R5cGVdW2lkXSA9IHsKICAgICAgICAgICAgICAgIGNyZWF0b3I6IGNyZWF0b3IsCiAgICAgICAgICAgICAgICBpbnN0YW5jZTogbnVsbAogICAgICAgICAgICB9OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnN0YXJ0TWVtYmVyCiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBzdGFydE1lbWJlcjogZnVuY3Rpb24odHlwZSwgaWQpIHsKICAgICAgICAgICAgdmFyIGNyZWF0b3IgPSB0aGlzLm1DcmVhdG9yW3R5cGVdW2lkXTsKICAgICAgICAgICAgaWYoIWNyZWF0b3IgfHwgY3JlYXRvci5pbnN0YW5jZSkgICByZXR1cm47CiAgICAgICAgICAgIGNyZWF0b3IuaW5zdGFuY2UgPSBjcmVhdG9yLmNyZWF0b3IodGhpcywgdGhpcy5nZXRDb25maWcoaWQpKTsKICAgICAgICAgICAgY3JlYXRvci5pbnN0YW5jZS5pbml0ICYmIGNyZWF0b3IuaW5zdGFuY2UuaW5pdCgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnJlZ2lzdGVyQXBpCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICogQHBhcmFtIG0KICAgICAgICAgKi8KICAgICAgICByZWdpc3RlckFwaTogZnVuY3Rpb24oaWQsIG0pIHsKICAgICAgICAgICAgdGhpcy5yZWdpc3Rlck1lbWJlcigiYXBpIiwgaWQsIG0pOwogICAgICAgICAgICB0aGlzLnN0YXJ0QXBpKGlkKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5yZWdpc3Rlck1vZHVsZQogICAgICAgICAqIEBwYXJhbSBpZCB7U3RyaW5nfQogICAgICAgICAqIEBwYXJhbSBtIHtPYmplY3QgfCBzci5Nb2R1bGV9CiAgICAgICAgICogQHBhcmFtIGltbWVkaWF0ZSB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICByZWdpc3Rlck1vZHVsZTogZnVuY3Rpb24oaWQsIG0sIGltbWVkaWF0ZSkgewogICAgICAgICAgICB0aGlzLnJlZ2lzdGVyTWVtYmVyKCJtb2R1bGUiLCBpZCwgbSk7CiAgICAgICAgICAgIHJldHVybiAodGhpcy5pc0xvYWQgfHwgISFpbW1lZGlhdGUpID8gKHRoaXMuc3RhcnRNb2R1bGUoaWQpLCB0cnVlKSA6IGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBzdGFydE1vZHVsZQogICAgICAgICAqIEBwYXJhbSBpZCB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHN0YXJ0TW9kdWxlOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICB0aGlzLnN0YXJ0TWVtYmVyKCJtb2R1bGUiLCBpZCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnN0YXJ0QXBpCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICovCiAgICAgICAgc3RhcnRBcGk6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHRoaXMuc3RhcnRNZW1iZXIoImFwaSIsIGlkKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0QXBpCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICovCiAgICAgICAgZ2V0QXBpOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5tQ3JlYXRvclsiYXBpIl1baWRdLmluc3RhbmNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5nZXRNb2R1bGUKICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBnZXRNb2R1bGU6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1DcmVhdG9yWyJtb2R1bGUiXVtpZF0uaW5zdGFuY2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIHN0b3BNb2R1bGUKICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBzdG9wTW9kdWxlOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICB2YXIgbW9kdWxlSXRlbSA9IHRoaXMubUNyZWF0b3JbIm1vZHVsZSJdW2lkXTsKICAgICAgICAgICAgaWYoIW1vZHVsZUl0ZW0uaW5zdGFuY2UpICAgcmV0dXJuOwogICAgICAgICAgICBpZiAobW9kdWxlSXRlbS5pbnN0YW5jZS5kZXN0cm95KSB7CiAgICAgICAgICAgICAgICBtb2R1bGVJdGVtLmluc3RhbmNlLmRlc3Ryb3koKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtb2R1bGVJdGVtLmluc3RhbmNlID0gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5vbgogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9IOS6i+S7tuWQjQogICAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0g5Zue6LCDCiAgICAgICAgICovCiAgICAgICAgb246IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMub24odHlwZSwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAudW4KICAgICAgICAgKiBAcGFyYW0gdHlwZSB7U3RyaW5nfSDkuovku7blkI0KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IOWbnuiwgwogICAgICAgICAqLwogICAgICAgIHVuOiBmdW5jdGlvbih0eXBlLCBmdW5jKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzLnVuKHR5cGUsIGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLm5vdGlmeQogICAgICAgICAqIEBkZXNjIOinpuWPkeafkOiHquWumuS5ieS6i+S7tgogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGV2dCB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIG5vdGlmeTogZnVuY3Rpb24odHlwZSwgZXZ0KSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmlzTG9hZCkgewogICAgICAgICAgICAgICAgdGhpcy5ldmVudENhY2hlcy5wdXNoKFt0eXBlLCBldnRdKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmV2ZW50cy50cmlnZ2VyRXZlbnQodHlwZSwgZXZ0KTsKICAgICAgICAgICAgZm9yKHZhciBrIGluIHRoaXMuY2FjaGVFdmVudERpc3BhdGNoKSB7CiAgICAgICAgICAgICAgICBpZihrLmluZGV4T2YodHlwZSkgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJFdmVudERpc3BhdGNoKGssIHR5cGUsIGV2dCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAudHJpZ2dlckV2ZW50RGlzcGF0Y2gKICAgICAgICAgKiBAZGVzYyDpgJrnn6XnvJPlhrLlmagg5rS75p2l5LqGCiAgICAgICAgICogQHBhcmFtIGlkIOe8k+WGsuWZqOeahGtleQogICAgICAgICAqIEBwYXJhbSB0eXBlIOWujOaIkOeahOW3peS9nHR5cGUKICAgICAgICAgKiBAcGFyYW0gZXZ0IOWujOaIkOeahOW3peS9nOW4puadpeeahOWPmOmHjwogICAgICAgICAqLwogICAgICAgIHRyaWdnZXJFdmVudERpc3BhdGNoOiBmdW5jdGlvbihpZCwgdHlwZSwgZXZ0KSB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHRoaXMuY2FjaGVFdmVudERpc3BhdGNoW2lkXTsKICAgICAgICAgICAgaWYoIWRpc3BhdGNoICYmIGRpc3BhdGNoLmhpdEZsYWcgPT0gZGlzcGF0Y2guaGl0cyAgfHwgZGlzcGF0Y2hbImNhY2hlRGF0YSJdW3R5cGVdKSAgcmV0dXJuOwogICAgICAgICAgICBkaXNwYXRjaFsiY2FjaGVEYXRhIl1bdHlwZV0gPSBldnQ7CiAgICAgICAgICAgIGlmKCsrZGlzcGF0Y2guaGl0RmxhZyA9PSBkaXNwYXRjaC5oaXRzKSB7CiAgICAgICAgICAgICAgICBkaXNwYXRjaC5mdW5jLmFwcGx5KHRoaXMsIFtkaXNwYXRjaC5jYWNoZURhdGFdKTsKICAgICAgICAgICAgICAgIGRpc3BhdGNoID0gbnVsbDsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhY2hlRXZlbnREaXNwYXRjaFtpZF07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5hZGRDb25maWcKICAgICAgICAgKiBAcGFyYW0gaWQKICAgICAgICAgKiBAcGFyYW0gY29uZmlnCiAgICAgICAgICovCiAgICAgICAgYWRkQ29uZmlnOiBmdW5jdGlvbihpZCwgY29uZmlnKXsKICAgICAgICAgICAgY29uZmlnID0gY29uZmlnIHx8IHt9OwogICAgICAgICAgICB2YXIgYywgcDsKICAgICAgICAgICAgaWYoaWQpIHsKICAgICAgICAgICAgICAgIGMgPSB0aGlzLmNvbmZpZ3NbaWRdID0gdGhpcy5jb25maWdzW2lkXSB8fCB7fTsKICAgICAgICAgICAgICAgIGZvcihwIGluIGNvbmZpZykgewogICAgICAgICAgICAgICAgICAgIGNbcF0gPSBjb25maWdbcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IocCBpbiBjb25maWcpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZ3NbcF0gPSBjb25maWdbcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuZ2V0Q29uZmlnCiAgICAgICAgICogQHBhcmFtIGlkCiAgICAgICAgICovCiAgICAgICAgZ2V0Q29uZmlnOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jb25maWdzW2lkXSB8fCB7fTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5pbnZva2VFdmVudERpc3BhdGNoCiAgICAgICAgICogQGRlc2Mg5ZCv55So5LiA5Liq5LqL5Lu257yT5Yay5ZmoIOeUqOadpeWkhOeQhuWkmuasoeS6i+S7tuWujOaIkOaJjeWBmuafkOS6i+aDheeahOmcgOaxggogICAgICAgICAqLwogICAgICAgIGludm9rZUV2ZW50RGlzcGF0Y2g6IGZ1bmN0aW9uKGV2ZW50cywgZnVuYykgewogICAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSB0aGlzLmNhY2hlRXZlbnREaXNwYXRjaFtldmVudHNdLAogICAgICAgICAgICAgICAgbGVuID0gU3RyaW5nKGV2ZW50cykuc3BsaXQoIiwiKS5sZW5ndGg7CiAgICAgICAgICAgIGlmKGRpc3BhdGNoICYmIGRpc3BhdGNoLmhpdEZsYWcgPT0gbGVuKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRoaXMga2luZCBvZiBFdmVudERpc3BhdGNoIGhhcyBhbHJlYWR5IGludm9rZWQhIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jYWNoZUV2ZW50RGlzcGF0Y2hbZXZlbnRzXSA9IHRoaXMuY2FjaGVFdmVudERpc3BhdGNoW2V2ZW50c10gfHwgewogICAgICAgICAgICAgICAgaGl0czogbGVuLAogICAgICAgICAgICAgICAgaGl0RmxhZzogMCwKICAgICAgICAgICAgICAgIGNhY2hlRGF0YToge30sCiAgICAgICAgICAgICAgICBmdW5jOiBmdW5jCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uV2luZG93TG9hZAogICAgICAgICAqIEBkZXNjIOebkeWQrG9ubG9hZOS6i+S7tgogICAgICAgICAqLwogICAgICAgIG9uV2luZG93TG9hZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5tQ3JlYXRvclsibW9kdWxlIl0sIGZ1bmN0aW9uKGl0ZW0sIGspIHsKICAgICAgICAgICAgICAgIHRoYXQuc3RhcnRNb2R1bGUoayk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmlzTG9hZCA9IHRydWU7CiAgICAgICAgICAgIGlmKHRoaXMuZXZlbnRDYWNoZXMpIHsKICAgICAgICAgICAgICAgIHZhciBpdGVtOwogICAgICAgICAgICAgICAgd2hpbGUoaXRlbSA9IHRoaXMuZXZlbnRDYWNoZXMuc2hpZnQoKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubm90aWZ5KGl0ZW1bMF0sIGl0ZW1bMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJHbG9iYWwtT2N0b3B1c0FwcC1Nb2R1bGVDb21wbGV0ZWQiLCB7fSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uV2luZG93VW5sb2FkCiAgICAgICAgICogQGRlc2Mg55uR5ZCs6aG16Z2i55qEdW5sb2Fk5LqL5Lu2IOmSiOWvueS9jueJiOacrOa1j+iniOWZqCDkuLvopoHlgZrkuIDkupvlhoXlrZjlm57mlLblt6XkvZwg6Iez5LqO6auY57qn5rWP6KeI5ZmoIOWlveWQpyDkvaDlj6/ku6XorqTkuLrmiJHlnKjoh6rmrLrmrLrkuroKICAgICAgICAgKi8KICAgICAgICBvbldpbmRvd1VubG9hZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgby51dGlsLmVhY2godGhpcy5tQ3JlYXRvclsibW9kdWxlIl0sIGZ1bmN0aW9uKGl0ZW0sIGspIHsKICAgICAgICAgICAgICAgIHRoYXQuc3RvcE1vZHVsZShpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAucmVuZGVyCiAgICAgICAgICovCiAgICAgICAgcmVuZGVyOiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICBpZighdGhpcy5pc0xvYWQpICAgIGNvbnNvbGUuZXJyb3IoIlRoZSBwYWdlIGhhc24ndCBsb2FkZWQhIik7CiAgICAgICAgICAgIGVsID0gby5nKGVsKTsKICAgICAgICAgICAgaWYoIWVsKSAgICBjb25zb2xlLmVycm9yKCJJbnZhbGlkIG5vZGUgdG8gcmVuZGVyISIpOwogICAgICAgICAgICB0aGlzLmluaXREb21Nb2RlKGVsKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgaW5pdERvbU1vZGUKICAgICAgICAgKi8KICAgICAgICBpbml0RG9tTW9kZTogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgLy/oioLngrnmqKHlvI8KICAgICAgICAgICAgdGhpcy5pc0luaXREb20gPSB0cnVlOwogICAgICAgICAgICB2YXIgY29uZmlnID0gdGhpcy5jb25maWcsCiAgICAgICAgICAgICAgICBub2RlID0gZWwsCiAgICAgICAgICAgICAgICBpZCA9IHRoaXMuaWQgKyAiX09jdG9wdXNfVmlld1BvcnQiOwogICAgICAgICAgICB0aGlzLmVsID0gby5kb20uY2xvbmVOb2RlKG5vZGUsIHRydWUpOwogICAgICAgICAgICB0aGlzLnZpZXdFbCA9IG8uZG9tLmNyZWF0ZURvbSgiZGl2IiwgewogICAgICAgICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgICAgICAgImNsYXNzIjogIm9jdG9wdXMtdmlld3BvcnQiLAogICAgICAgICAgICAgICAgc3R5bGU6ICJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOyBwb3NpdGlvbjogcmVsYXRpdmU7IHotaW5kZXg6IDMwMDsgb3ZlcmZsb3c6IGhpZGRlbiIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuZWwuYXBwZW5kQ2hpbGQodGhpcy52aWV3RWwpOwogICAgICAgICAgICAvL+WmguaenOaYr+iKgueCueaooeW8j+S4lOaLpeacieWbvuWxggogICAgICAgICAgICBpZihjb25maWcubGF5ZXJzKSB7CiAgICAgICAgICAgICAgICBvLnV0aWwuZWFjaChjb25maWcubGF5ZXJzLCBvLnV0aWwuYmluZCh0aGlzLmFkZExheWVyLCB0aGlzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy/lpoLmnpzmmK/oioLngrnmqKHlvI/kuJTliJ3lp4vljJZ3aWRnZXTmjqfku7YKICAgICAgICAgICAgaWYoY29uZmlnLndpZGdldHMpIHsKICAgICAgICAgICAgICAgIG8udXRpbC5lYWNoKGNvbmZpZy53aWRnZXRzLCBvLnV0aWwuYmluZCh0aGlzLmFkZFdpZGdldCwgdGhpcykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubm90aWZ5KCJHbG9iYWwtT2N0b3B1c0FwcC1CZWZvcmVBcHBDb21wbGV0ZWQiKTsKICAgICAgICAgICAgLy/miorooqvmkJ7lvpfpnaLnm67lhajpnZ7nmoRlbOWKoOWFpeaWh+aho+a1gQogICAgICAgICAgICBpZihub2RlKSB7CiAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMuZWwsIG5vZGUpOwogICAgICAgICAgICAgICAgdGhpcy5ub3RpZnkoIkdsb2JhbC1PY3RvcHVzQXBwLUFwcENvbXBsZXRlZCIpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIG9uT3JpZW50YXRpb25DaGFuZ2VkCiAgICAgICAgICogQGRlc2Mg55uR5ZCs5qiq56uW5bGP5YiH5o2i5LqL5Lu2CiAgICAgICAgICovCiAgICAgICAgb25PcmllbnRhdGlvbkNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLm5vdGlmeSgiR2xvYmFsLU9jdG9wdXNBcHAtT25PcmllbnRhdGlvbkNoYW5nZWQiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgb25XaW5kb3dSZXNpemUKICAgICAgICAgKi8KICAgICAgICBvbldpbmRvd1Jlc2l6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKCF0aGlzLmlzUmVzaXplKSB7CiAgICAgICAgICAgICAgICBvLnV0aWwucmVxdWVzdEFuaW1hdGlvbihvLnV0aWwuYmluZCh0aGlzLmNoZWNrU2l6ZSwgdGhpcykpOwogICAgICAgICAgICAgICAgdGhpcy5pc1Jlc2l6ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgY2hlY2tTaXplCiAgICAgICAgICovCiAgICAgICAgY2hlY2tTaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5pc1Jlc2l6ZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm5vdGlmeSgiR2xvYmFsLU9jdG9wdXNBcHAtT25XaW5kb3dSZXNpemUiKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5hZGRMYXllcgogICAgICAgICAqIEBkZXNjIOe7meW9k+WJjWRvbeS4iuWinuWKoOWbvuWxgiDlpoLmnpzkuI3lrZjlnKh0aGlzLmVsIOWImeatpOaWueazleayoeWunumZheaViOaenAogICAgICAgICAqIEBwYXJhbSBsYXllciB7b2N0b3B1cy5MYXllcn0KICAgICAgICAgKi8KICAgICAgICBhZGRMYXllcjogZnVuY3Rpb24obGF5ZXIpIHsKICAgICAgICAgICAgaWYoIXRoaXMubGF5ZXJzKSAgICB0aGlzLmxheWVycyA9IFtdOwogICAgICAgICAgICBpZih0aGlzLmxheWVycy5pbmRleE9mKGxheWVyKSAhPSAtMSkgIHJldHVybjsKICAgICAgICAgICAgdmFyIGVsID0gbGF5ZXIuZ2V0RWwoKTsKICAgICAgICAgICAgby5kb20uYWRkQ2xhc3MoZWwsICJvY3RvcHVzLWFwcC1sYXllciIpOwogICAgICAgICAgICB0aGlzLnNldExheWVyWkluZGV4KGxheWVyLCB0aGlzLmxheWVycy5sZW5ndGgpOwogICAgICAgICAgICBpZihsYXllci5pc0Jhc2VMYXllcikgewogICAgICAgICAgICAgICAgdGhpcy5lbC5hcHBlbmRDaGlsZChlbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnZpZXdFbC5hcHBlbmRDaGlsZChlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobGF5ZXIuaXNDdXJyZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEN1cnJlbnRMYXllcihsYXllcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5sYXllcnMucHVzaChsYXllcik7CiAgICAgICAgICAgIGxheWVyLnNldEFwcCh0aGlzKTsKICAgICAgICAgICAgdGhpcy5ub3RpZnkoIkdsb2JhbC1PY3RvcHVzQXBwLUxheWVyQWRkIiwge2xheWVyOiBsYXllcn0pOwogICAgICAgICAgICBsYXllci5hZnRlckFkZCgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnNldEN1cnJlbnRMYXllcgogICAgICAgICAqIEBwYXJhbSBsYXllcgogICAgICAgICAqLwogICAgICAgIHNldEN1cnJlbnRMYXllcjogZnVuY3Rpb24obGF5ZXIpIHsKICAgICAgICAgICAgaWYodGhpcy5jdXJyZW50TGF5ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudExheWVyLnNldEN1cnJlbnQoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY3VycmVudExheWVyID0gbGF5ZXI7CiAgICAgICAgICAgIHRoaXMudG9wTGF5ZXIobGF5ZXIpOwogICAgICAgICAgICBsYXllci5zZXRDdXJyZW50KHRydWUpOwogICAgICAgICAgICB0aGlzLm5vdGlmeSgiR2xvYmFsLU9jdG9wdXNBcHAtQ3VycmVudExheWVyQ2hhbmdlZCIsIHtsYXllcjogbGF5ZXJ9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2Qgc2V0TGF5ZXJaSW5kZXgKICAgICAgICAgKiBAZGVzYyDorr7nva7lm77lsYLnmoRpbmRleAogICAgICAgICAqIEBwYXJhbSBsYXllciB7b2N0b3B1cy5MYXllcn0KICAgICAgICAgKiBAcGFyYW0geklkeCB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHNldExheWVyWkluZGV4OiBmdW5jdGlvbihsYXllciwgeklkeCkgewogICAgICAgICAgICBsYXllci5zZXRaSW5kZXgodGhpcy5aX0lOREVYX0JBU0VbbGF5ZXIuaXNCYXNlTGF5ZXIgPyAiQmFzZUxheWVyIiA6ICJMYXllciJdICsgeklkeCAqIDUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5yZXNldExheWVyc1pJbmRleAogICAgICAgICAqIEBkZXNjIHJlc2V05Zu+5bGCemluZGV4CiAgICAgICAgICovCiAgICAgICAgcmVzZXRMYXllcnNaSW5kZXg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIG8udXRpbC5lYWNoKHRoaXMubGF5ZXJzLCBmdW5jdGlvbihsYXllciwgaSkgewogICAgICAgICAgICAgICAgdGhhdC5zZXRMYXllclpJbmRleChsYXllciwgaSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAbWV0aG9kIGdldFRvcFpJbmRleAogICAgICAgICAqLwogICAgICAgIGdldFRvcFpJbmRleDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0b3BJbmRleCA9IHsKICAgICAgICAgICAgICAgIHppbmRleDogMCwKICAgICAgICAgICAgICAgIGluZGV4OiAwCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG8udXRpbC5lYWNoKHRoaXMubGF5ZXJzLCBmdW5jdGlvbihsYXllciwgaSkgewogICAgICAgICAgICAgICAgdmFyIF96aW5kZXggPSBsYXllci5nZXRFbCgpLnN0eWxlLnpJbmRleCB8fCAwOwogICAgICAgICAgICAgICAgaWYoX3ppbmRleCA+IHRvcEluZGV4LnppbmRleCkgewogICAgICAgICAgICAgICAgICAgIHRvcEluZGV4ID0gewogICAgICAgICAgICAgICAgICAgICAgICB6aW5kZXg6IF96aW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRvcEluZGV4OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnRvcExheWVyCiAgICAgICAgICovCiAgICAgICAgdG9wTGF5ZXI6IGZ1bmN0aW9uKGxheWVyKSB7CiAgICAgICAgICAgIHZhciB0b3BJbmRleCA9IHRoaXMuZ2V0VG9wWkluZGV4KCksCiAgICAgICAgICAgICAgICBpbmRleCA9IGxheWVyLmVsLnN0eWxlLnpJbmRleDsKICAgICAgICAgICAgaWYodG9wSW5kZXggPT0gaW5kZXgpCXJldHVybjsKICAgICAgICAgICAgbGF5ZXIuZWwuc3R5bGUuekluZGV4ID0gdG9wSW5kZXguemluZGV4OwogICAgICAgICAgICB0aGlzLmxheWVyc1t0b3BJbmRleC5pbmRleF0uZWwuc3R5bGUuekluZGV4ID0gaW5kZXg7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuZ2V0TGF5ZXIKICAgICAgICAgKiBAcGFyYW0gaWQge1N0cmluZ30KICAgICAgICAgKiBAZGVzYyDpnaBpZOiOt+WPluWbvuWxggogICAgICAgICAqLwogICAgICAgIGdldExheWVyOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICB2YXIgbGF5ZXIgPSBudWxsOwogICAgICAgICAgICBvLnV0aWwuZWFjaCh0aGlzLmxheWVycywgZnVuY3Rpb24oX2xheWVyKSB7CiAgICAgICAgICAgICAgICBpZihpZCA9PSBfbGF5ZXIuaWQpIHsKICAgICAgICAgICAgICAgICAgICBsYXllciA9IF9sYXllcjsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBsYXllcjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkFwcC5yZW1vdmVMYXllcgogICAgICAgICAqIEBwYXJhbSBsYXllcgogICAgICAgICAqIEBkZXNjIOWIoOaOieWbvuWxggogICAgICAgICAqLwogICAgICAgIHJlbW92ZUxheWVyOiBmdW5jdGlvbihsYXllcikgewogICAgICAgICAgICBsYXllci5nZXRFbCgpLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobGF5ZXIuZ2V0RWwoKSk7CiAgICAgICAgICAgIG8udXRpbC5yZW1vdmVJdGVtKHRoaXMubGF5ZXJzLCBsYXllcik7CiAgICAgICAgICAgIGxheWVyLnJlbW92ZUFwcCh0aGlzKTsKICAgICAgICAgICAgbGF5ZXIuYXBwID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5yZXNldExheWVyc1pJbmRleCgpOwogICAgICAgICAgICB0aGlzLm5vdGlmeSgiR2xvYmFsLU9jdG9wdXNBcHAtTGF5ZXJSZW1vdmUiLCB7bGF5ZXI6IGxheWVyfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5BcHAuYWRkV2lkZ2V0CiAgICAgICAgICogQHBhcmFtIHdpZGdldCB7b2N0b3B1cy5XaWRnZXR9CiAgICAgICAgICogQHBhcmFtIGF1dG8ge0Jvb2xlYW59CiAgICAgICAgICogQGRlc2Mg5re75Yqgd2lkZ2V05YiwYXBw6YeMCiAgICAgICAgICovCiAgICAgICAgYWRkV2lkZ2V0OiBmdW5jdGlvbih3aWRnZXQsIGF1dG8pIHsKICAgICAgICAgICAgaWYoIXRoaXMud2lkZ2V0cykgICAgdGhpcy53aWRnZXRzID0gW107CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMud2lkZ2V0cy5pbmRleE9mKHdpZGdldCk7CiAgICAgICAgICAgIGlmKGluZGV4ID4gLTEpICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHRoaXMud2lkZ2V0cy5wdXNoKHdpZGdldCkKICAgICAgICAgICAgaWYoIWF1dG8pIHsKICAgICAgICAgICAgICAgIHdpZGdldC5jb250YWluZXIgPSB3aWRnZXQub3V0c2lkZVZpZXdwb3J0ID8gdGhpcy5lbCA6IHRoaXMudmlld0VsOwogICAgICAgICAgICAgICAgd2lkZ2V0LnJlbmRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdpZGdldC5zZXRaSW5kZXgodGhpcy5aX0lOREVYX0JBU0UuV2lkZ2V0ICsgdGhpcy53aWRnZXRzLmxlbmd0aCAqIDUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLmdldFdpZGdldAogICAgICAgICAqIEBwYXJhbSBpZAogICAgICAgICAqLwogICAgICAgIGdldFdpZGdldDogZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgdmFyIHdpZGdldCA9IG51bGwsCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIGxlbiA9IHRoaXMud2lkZ2V0cy5sZW5ndGg7CiAgICAgICAgICAgIG8udXRpbC5lYWNoKHRoaXMud2lkZ2V0cywgZnVuY3Rpb24oX3dpZGdldCkgewogICAgICAgICAgICAgICAgaWYoX3dpZGdldC5pZCA9PSBpZCkgewogICAgICAgICAgICAgICAgICAgIHdpZGdldCA9IF93aWRnZXQ7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gd2lkZ2V0OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQXBwLnJlbW92ZVdpZGdldAogICAgICAgICAqIEBwYXJhbSB3aWRnZXQge29jdG9wdXMuV2lkZ2V0fQogICAgICAgICAqLwogICAgICAgIHJlbW92ZVdpZGdldDogZnVuY3Rpb24od2lkZ2V0KSB7CiAgICAgICAgICAgIGlmICgod2lkZ2V0KSAmJiAod2lkZ2V0ID09IHRoaXMuZ2V0V2lkZ2V0KHdpZGdldC5pZCkpKSB7CiAgICAgICAgICAgICAgICB3aWRnZXQuZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh3aWRnZXQuZWwpOwogICAgICAgICAgICAgICAgby51dGlsLnJlbW92ZUl0ZW0odGhpcy53aWRnZXRzLCB3aWRnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgWl9JTkRFWF9CQVNFOiB7CiAgICAgICAgICAgIEJhc2VMYXllcjogMCwKICAgICAgICAgICAgTGF5ZXI6IDM1MCwKICAgICAgICAgICAgV2lkZ2V0OiA3NTAsCiAgICAgICAgICAgIE1hc2s6IDEwMDAsCiAgICAgICAgICAgIFBvcHVwOiAxNTAwCiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuQXBwIgogICAgfSk7Cn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bnu5PmnoTmlofku7YKICog5a6a5LmJ5ZG95Luk5oiW5pON5L2cCiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKi8KOyhmdW5jdGlvbihvLCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgby5DbWQgPSBvLmRlZmluZSh7CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG5hbWUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIG5hbWU6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFjdGl2ZQogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGFjdGl2ZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFwcAogICAgICAgICAqIEB0eXBlIHtvY3RvcHVzLkFwcH0KICAgICAgICAgKi8KICAgICAgICBhcHA6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24obmFtZSwgb3B0aW9ucykgewogICAgICAgICAgICB0aGlzLm5hbWUgPSB0aGlzLm5hbWUgfHwgdGhpcy5DTEFTU19OQU1FOwogICAgICAgICAgICBvLmV4dGVuZCh0aGlzLCBvcHRpb25zKQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kLmFjdGl2YXRlCiAgICAgICAgICogQGRlc2Mg5r+A5rS75ZG95Luk54q25oCBCiAgICAgICAgICovCiAgICAgICAgYWN0aXZhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZighdGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kLmRlYWN0aXZhdGUKICAgICAgICAgKiBAZGVzYyDmjILotbflkb3ku6TnirbmgIEKICAgICAgICAgKi8KICAgICAgICBkZWFjdGl2YXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYodGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkNtZC5leGVjdXRlCiAgICAgICAgICogQHBhcmFtIG9wdGlvbgogICAgICAgICAqIEBkZXNjIOaJp+ihjOWRveS7pAogICAgICAgICAqLwogICAgICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgICAgICBpZighdGhpcy5hY3RpdmUpCXJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkNtZC51bmV4ZWN1dGUKICAgICAgICAgKiBAZGVzYyDlrp7njrDmraTmlrnms5XnmoTlkb3ku6TmlK/mjIF1bmRvIHJlZG8KICAgICAgICAgKi8KICAgICAgICB1bmV4ZWN1dGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZighdGhpcy5hY3RpdmUpICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkNtZC5zZXRBcHAKICAgICAgICAgKiBAcGFnZSB7b2N0b3B1cy5BcHB9CiAgICAgICAgICogQGRlc2Mg57uR5a6a5ZG95Luk5YiwYXBwCiAgICAgICAgICovCiAgICAgICAgc2V0QXBwOiBmdW5jdGlvbihhcHApIHsKICAgICAgICAgICAgaWYodGhpcy5hcHAgIT0gYXBwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFwcCA9IGFwcDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuQ21kIgogICAgfSk7Cn0pKG9jdG9wdXMpOy8qKgogKiBAZmlsZQogKiB3ZWJhcHDpgJrnlKjnu4Tku7bnu5PmnoTmlofku7YKICog5a6a5LmJ5ZG95Luk566h55CG57G7CiAqIEBhdXRob3Igb3VwZW5nLWZlCiAqIEB2ZXJzaW9uIDEuMQogKi8KOyhmdW5jdGlvbihvLCB1bmRlZmluZWQpIHsKCiAgICAidXNlIHN0cmljdCI7CgogICAgby5DbWRNYW5hZ2VyID0gby5kZWZpbmUoewoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBhcHAKICAgICAgICAgKiBAdHlwZSB7b2N0b3B1cy5BcHB9CiAgICAgICAgICovCiAgICAgICAgYXBwOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBjb21tYW5kcwogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKi8KICAgICAgICBjb21tYW5kczogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgZXhlY3V0ZUNtZHMKICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICovCiAgICAgICAgZXhlY3V0ZUNtZHM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IG5hbWUKICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIG5hbWU6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICBvLmV4dGVuZCh0aGlzLCBvcHRpb25zKTsKICAgICAgICAgICAgISF0aGlzLmFwcCA/ICh0aGlzLnNldEFwcCh0aGlzLmFwcCksIHRydWUpIDogZmFsc2U7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IHRoaXMubmFtZSB8fCBvLnV0aWwuY3JlYXRlVW5pcXVlSUQodGhpcy5DTEFTU19OQU1FICsgIl8iKTsKICAgICAgICAgICAgdGhpcy5jb21tYW5kcyA9IHRoaXMuY29tbWFuZHMgfHwgW107CiAgICAgICAgICAgIHRoaXMuZXhlY3V0ZUNtZHMgPSB0aGlzLmV4ZWN1dGVDbWRzIHx8IFtdOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kTWFuYWdlci5zZXRBcHAKICAgICAgICAgKiBAcGFyYW0gYXBwIHtvY3RvcHVzLkFwcH0KICAgICAgICAgKi8KICAgICAgICBzZXRBcHA6IGZ1bmN0aW9uKGFwcCkgewogICAgICAgICAgICB0aGlzLmFwcCA9PSBhcHAgPyBmYWxzZSA6ICh0aGlzLmFwcCA9IGFwcCwgdHJ1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5DbWRNYW5hZ2VyLnJlZ2lzdGVyCiAgICAgICAgICogQHBhcmFtIGNvbW1hbmQge28uQ21kfQogICAgICAgICAqIEBkZXNjIOazqOWGjOS4gOS4quWRveS7pOWIsOWRveS7pOeuoeeQhuWZqAogICAgICAgICAqLwogICAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAoY29tbWFuZCkgewogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmNvbW1hbmRzLmluZGV4T2YoY29tbWFuZCk7CiAgICAgICAgICAgIGlmKGluZGV4ICE9IC0xKQlyZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY29tbWFuZHMucHVzaChjb21tYW5kKTsKICAgICAgICAgICAgY29tbWFuZC5zZXRBcHAodGhpcy5hcHApOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkNtZE1hbmFnZXIudW5yZWdpc3RlcgogICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgdW5yZWdpc3RlcjogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmdldENvbW1hbmRJbmRleEJ5TmFtZShuYW1lKTsKICAgICAgICAgICAgaWYoaW5kZXggPT0gLTEpCXJldHVybiBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jb21tYW5kcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBtZXRob2QgZ2V0Q29tbWFuZEluZGV4QnlOYW1lCiAgICAgICAgICovCiAgICAgICAgZ2V0Q29tbWFuZEluZGV4QnlOYW1lOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHZhciBsZW4gPSB0aGlzLmNvbW1hbmRzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGkgPSBsZW47CiAgICAgICAgICAgIGZvcig7IGktLTsgKSB7CiAgICAgICAgICAgICAgICBpZihuYW1lID09IHRoaXMuY29tbWFuZHNbaV0ubmFtZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkNtZE1hbmFnZXIuZXhlY3V0ZUNvbW1hbmQKICAgICAgICAgKiBAcGFyYW0gbmFtZSB7U3RyaW5nfSDlkb3ku6TlkI0KICAgICAgICAgKiBAcGFyYW0gb3B0aW9uIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgZXhlY3V0ZUNvbW1hbmQ6IGZ1bmN0aW9uKG5hbWUsIG9wdGlvbikgewogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmdldENvbW1hbmRJbmRleEJ5TmFtZShuYW1lKTsKICAgICAgICAgICAgaWYoaW5kZXggPT0gLTEpCXJldHVybjsKICAgICAgICAgICAgdGhpcy5jb21tYW5kc1tpbmRleF0uZXhlY3V0ZShvcHRpb24pOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuQ21kTWFuYWdlci5kZXN0cm95CiAgICAgICAgICovCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLmFwcCA9IG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuQ21kTWFuYWdlciIKICAgIH0pOwoKfSkob2N0b3B1cyk7LyoqCiAqIEBmaWxlCiAqIHdlYmFwcOmAmueUqOe7hOS7tue7k+aehOaWh+S7tgogKiDlrprkuYnlm77lsYLln7rnsbsKICogQGF1dGhvciBvdXBlbmctZmUKICogQHZlcnNpb24gMS4xCiAqLwo7KGZ1bmN0aW9uKG8sIHVuZGVmaW5lZCkgewoKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBvLkxheWVyID0gby5kZWZpbmUoewogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlkCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBpZDogbnVsbCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKiBAcHJvcGVydHkgY29uZmlnCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBjb25maWc6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGlzQ3VycmVudAogICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzQ3VycmVudDogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGV2ZW50CiAgICAgICAgICogQHR5cGUge29jdG9wdXMuRXZlbnRzfQogICAgICAgICAqLwogICAgICAgIGV2ZW50OiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBlbAogICAgICAgICAqIEB0eXBlIHtET01FbGVtZW50fQogICAgICAgICAqLwogICAgICAgIGVsOiBudWxsLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSBvY3RvcHVzLkxheWVyLmlzQmFzZUxheWVyCiAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNCYXNlTGF5ZXI6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqIEBwcm9wZXJ0eSB3aWRnZXRzCiAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAqLwogICAgICAgIHdpZGdldHM6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQHByb3BlcnR5IGFwcAogICAgICAgICAqIEB0eXBlIHtvY3RvcHVzLkFwcH0KICAgICAgICAgKi8KICAgICAgICBhcHA6IG51bGwsCgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICovCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICB2YXIgY29uZmlnID0gdGhpcy5jb25maWcgPSBvLmV4dGVuZCh7fSwgb3B0aW9ucyk7CiAgICAgICAgICAgIHRoaXMuaWQgPSBjb25maWcuaWQgfHwgby51dGlsLmNyZWF0ZVVuaXF1ZUlEKHRoaXMuQ0xBU1NfTkFNRSArICJfIik7CiAgICAgICAgICAgIHRoaXMuZWwgPSBvLmRvbS5jcmVhdGVEb20oImRpdiIsIHsKICAgICAgICAgICAgICAgIGlkOiB0aGlzLmlkCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmlzQ3VycmVudCA9IGNvbmZpZy5pc0N1cnJlbnQgfHwgdGhpcy5pc0N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuaXNCYXNlTGF5ZXIgPSBjb25maWcuaXNCYXNlTGF5ZXIgfHwgdGhpcy5pc0Jhc2VMYXllcjsKICAgICAgICAgICAgaWYodGhpcy5pc0N1cnJlbnQgfHwgdGhpcy5pc0Jhc2VMYXllcikgewogICAgICAgICAgICAgICAgby5kb20uYWRkQ2xhc3ModGhpcy5lbCwgIm9jdG9wdXMtbGF5ZXItYmFzZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXZlbnQgPSBuZXcgby5FdmVudHModGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5MYXllci5nZXRFbAogICAgICAgICAqIEByZXR1cm4ge0RPTUVsZW1lbnR9CiAgICAgICAgICovCiAgICAgICAgZ2V0RWw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5lbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkxheWVyLm9uCiAgICAgICAgICogQGRlc2Mg5LqL5Lu255uR5ZCsCiAgICAgICAgICogQHBhcmFtIHR5cGUge1N0cmluZ30KICAgICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgb246IGZ1bmN0aW9uKHR5cGUsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMub24odHlwZSwgZnVuYyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5MYXllci51bgogICAgICAgICAqIEBkZXNjIOS6i+S7tuWPlua2iOebkeWQrAogICAgICAgICAqIEBwYXJhbSB0eXBlIHtTdHJpbmd9CiAgICAgICAgICogQHBhcmFtIGZ1bmMge0Z1bmN0aW9ufQogICAgICAgICAqLwogICAgICAgIHVuOiBmdW5jdGlvbih0eXBlLCBmdW5jKSB7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzLnVuKHR5cGUsIGZ1bmMpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAbWV0aG9kIG9jdG9wdXMuTGF5ZXIuc2V0QXBwCiAgICAgICAgICogQGRlc2Mg57uR5a6aYXBwCiAgICAgICAgICogQHBhcmFtIGFwcCB7b2N0b3B1cy5BcHB9CiAgICAgICAgICovCiAgICAgICAgc2V0QXBwOiBmdW5jdGlvbihhcHApIHsKICAgICAgICAgICAgcmV0dXJuIGFwcCA9PSB0aGlzLmFwcCA/IGZhbHNlIDogKHRoaXMuYXBwID0gYXBwLCB0cnVlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkxheWVyLmFmdGVyQWRkCiAgICAgICAgICogQGRlc2Mg57uR5a6a5YWlYXBw5ZCO6LCD55SoCiAgICAgICAgICovCiAgICAgICAgYWZ0ZXJBZGQ6IGZ1bmN0aW9uKCkgewoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICogQG1ldGhvZCBvY3RvcHVzLkxheWVyLnNldEN1cnJlbnQKICAgICAgICAgKiBAcGFyYW0gY3VycmVudCB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBzZXRDdXJyZW50OiBmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgICAgIGlmKChjdXJyZW50ICYmIHRoaXMuaXNDdXJyZW50KSB8fCAoIWN1cnJlbnQgJiYgIXRoaXMuaXNDdXJyZW50KSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLmlzQ3VycmVudCA9IGN1cnJlbnQ7CiAgICAgICAgICAgIGN1cnJlbnQgPyBvLmRvbS5hZGRDbGFzcyh0aGlzLmVsLCAib2N0b3B1cy1sYXllci1zaG93IikgOiBvLmRvbS5yZW1vdmVDbGFzcyh0aGlzLmVsLCAib2N0b3B1cy1sYXllci1zaG93Iik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHB1YmxpYwogICAgICAgICAqIEBtZXRob2Qgb2N0b3B1cy5MYXllci5zZXRaSW5kZXgKICAgICAgICAgKiBAcGFyYW0gekluZGV4IHtOdW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgc2V0WkluZGV4OiBmdW5jdGlvbih6SW5kZXgpIHsKICAgICAgICAgICAgdGhpcy5lbC5zdHlsZS56SW5kZXggPSB6SW5kZXg7CiAgICAgICAgfSwKCiAgICAgICAgYWN0aXZhdGU6IGZ1bmN0aW9uKCkgewoKICAgICAgICB9LAoKICAgICAgICBkZWFjdGl2YXRlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlQXBwOiBmdW5jdGlvbigpIHsKCiAgICAgICAgfSwKCiAgICAgICAgQ0xBU1NfTkFNRTogIm9jdG9wdXMuTGF5ZXIiCiAgICB9KTsKfSkob2N0b3B1cyk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 21:16:57 GMT",
                    "Content-Length": "371805",
                    "Date": "Fri, 07 Nov 2014 21:17:02 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}