{
    "url": "http://localhost:9999/jumpbytehq/backbone-jqmobile/test/lib/jquery.mobile-1.1.0/jquery.mobile-1.1.0.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.href</b> via the following statement:<ul><li>location.href = location.href.replace( /#.*/, '' ) + history_hash;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/jumpbytehq/backbone-jqmobile/test/lib/jquery.mobile-1.1.0/jquery.mobile-1.1.0.js",
                "path": "/jumpbytehq/backbone-jqmobile/test/lib/jquery.mobile-1.1.0/jquery.mobile-1.1.0.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9qdW1wYnl0ZWhxL2JhY2tib25lLWpxbW9iaWxlL3Rlc3QvbGliL2pxdWVyeS5tb2JpbGUtMS4xLjAvanF1ZXJ5Lm1vYmlsZS0xLjEuMC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjM4Mzg4DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDExOjI3OjI3IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAxMToyNzoyMiBHTVQNCg0KLyoKKiBqUXVlcnkgTW9iaWxlIEZyYW1ld29yayAxLjEuMCBkYjM0MmIxZjMxNWMyODI2OTI3OTFhYTg3MDQ1NTkwMWZkYjQ2YTU1CiogaHR0cDovL2pxdWVyeW1vYmlsZS5jb20KKgoqIENvcHlyaWdodCAyMDExIChjKSBqUXVlcnkgUHJvamVjdAoqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwooZnVuY3Rpb24gKCByb290LCBkb2MsIGZhY3RvcnkgKSB7CglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCQkvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuCgkJZGVmaW5lKCBbICJqcXVlcnkiIF0sIGZ1bmN0aW9uICggJCApIHsKCQkJZmFjdG9yeSggJCwgcm9vdCwgZG9jICk7CgkJCXJldHVybiAkLm1vYmlsZTsKCQl9KTsKCX0gZWxzZSB7CgkJLy8gQnJvd3NlciBnbG9iYWxzCgkJZmFjdG9yeSggcm9vdC5qUXVlcnksIHJvb3QsIGRvYyApOwoJfQp9KCB0aGlzLCBkb2N1bWVudCwgZnVuY3Rpb24gKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7CgoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCW1vdXNlSG9va1Byb3BzID0gJC5ldmVudC5tb3VzZUhvb2tzID8gJC5ldmVudC5tb3VzZUhvb2tzLnByb3BzIDogW10sCgltb3VzZUV2ZW50UHJvcHMgPSAkLmV2ZW50LnByb3BzLmNvbmNhdCggbW91c2VIb29rUHJvcHMgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMDsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgajsKCglldmVudCA9ICQuRXZlbnQoZXZlbnQpOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCglvZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cglwcm9wcyA9ICQuZXZlbnQucHJvcHM7CgoJLy8gYWRkcmVzc2VzIHNlcGFyYXRpb24gb2YgJC5ldmVudC5wcm9wcyBpbiB0byAkLmV2ZW50Lm1vdXNlSG9vay5wcm9wcyBhbmQgSXNzdWUgMzI4MAoJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zMjgwCglpZiAoIHQuc2VhcmNoKCAvXihtb3VzZXxjbGljaykvICkgPiAtMSApIHsKCQlwcm9wcyA9IG1vdXNlRXZlbnRQcm9wczsKCX0KCgkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkvLyB0aGlzIHdvdWxkIGhhcHBlbiBpZiB3ZSBjb3VsZCBjYWxsICQuZXZlbnQuZml4IGluc3RlYWQgb2YgJC5FdmVudAoJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCWlmICggb2UgKSB7CgkJZm9yICggaSA9IHByb3BzLmxlbmd0aCwgcHJvcDsgaTsgKSB7CgkJCXByb3AgPSBwcm9wc1sgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvZVsgcHJvcCBdOwoJCX0KCX0KCgkvLyBtYWtlIHN1cmUgdGhhdCBpZiB0aGUgbW91c2UgYW5kIGNsaWNrIHZpcnR1YWwgZXZlbnRzIGFyZSBnZW5lcmF0ZWQKCS8vIHdpdGhvdXQgYSAud2hpY2ggb25lIGlzIGRlZmluZWQKCWlmICggdC5zZWFyY2goL21vdXNlKGRvd258dXApfGNsaWNrLykgPiAtMSAmJiAhZXZlbnQud2hpY2ggKXsKCQlldmVudC53aGljaCA9IDE7Cgl9CgoJaWYgKCB0LnNlYXJjaCgvXnRvdWNoLykgIT09IC0xICkgewoJCW5lID0gZ2V0TmF0aXZlRXZlbnQoIG9lICk7CgkJdCA9IG5lLnRvdWNoZXM7CgkJY3QgPSBuZS5jaGFuZ2VkVG91Y2hlczsKCQl0b3VjaCA9ICggdCAmJiB0Lmxlbmd0aCApID8gdFswXSA6ICggKGN0ICYmIGN0Lmxlbmd0aCkgPyBjdFsgMCBdIDogdW5kZWZpbmVkICk7CgoJCWlmICggdG91Y2ggKSB7CgkJCWZvciAoIGogPSAwLCBsZW4gPSB0b3VjaEV2ZW50UHJvcHMubGVuZ3RoOyBqIDwgbGVuOyBqKyspewoJCQkJcHJvcCA9IHRvdWNoRXZlbnRQcm9wc1sgaiBdOwoJCQkJZXZlbnRbIHByb3AgXSA9IHRvdWNoWyBwcm9wIF07CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBlbGVtZW50ICkgewoKCXZhciBmbGFncyA9IHt9LAoJCWIsIGs7CgoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWZvciAoICBrIGluIGIgKSB7CgkJCWlmICggYlsgayBdICkgewoJCQkJZmxhZ3NbIGsgXSA9IGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nID0gdHJ1ZTsKCQkJfQoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIGZsYWdzOwp9CgpmdW5jdGlvbiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZWxlbWVudCwgZXZlbnRUeXBlICkgewoJdmFyIGI7Cgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJaWYgKCBiICYmICggIWV2ZW50VHlwZSB8fCBiWyBldmVudFR5cGUgXSApICkgewoJCQlyZXR1cm4gZWxlbWVudDsKCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBudWxsOwp9CgpmdW5jdGlvbiBlbmFibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIGRpc2FibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gdHJ1ZTsKfQoKZnVuY3Rpb24gZW5hYmxlTW91c2VCaW5kaW5ncygpIHsKCWxhc3RUb3VjaElEID0gMDsKCWNsaWNrQmxvY2tMaXN0Lmxlbmd0aCA9IDA7CglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZTsKCgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBlbmFibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBkaXNhYmxlZC4KCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIGRpc2FibGVNb3VzZUJpbmRpbmdzKCkgewoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZGlzYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGVuYWJsZWQuCgllbmFibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIHN0YXJ0UmVzZXRUaW1lcigpIHsKCWNsZWFyUmVzZXRUaW1lcigpOwoJcmVzZXRUaW1lcklEID0gc2V0VGltZW91dChmdW5jdGlvbigpewoJCXJlc2V0VGltZXJJRCA9IDA7CgkJZW5hYmxlTW91c2VCaW5kaW5ncygpOwoJfSwgJC52bW91c2UucmVzZXRUaW1lckR1cmF0aW9uICk7Cn0KCmZ1bmN0aW9uIGNsZWFyUmVzZXRUaW1lcigpIHsKCWlmICggcmVzZXRUaW1lcklEICl7CgkJY2xlYXJUaW1lb3V0KCByZXNldFRpbWVySUQgKTsKCQlyZXNldFRpbWVySUQgPSAwOwoJfQp9CgpmdW5jdGlvbiB0cmlnZ2VyVmlydHVhbEV2ZW50KCBldmVudFR5cGUsIGV2ZW50LCBmbGFncyApIHsKCXZhciB2ZTsKCglpZiAoICggZmxhZ3MgJiYgZmxhZ3NbIGV2ZW50VHlwZSBdICkgfHwKCQkJCSggIWZsYWdzICYmIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBldmVudC50YXJnZXQsIGV2ZW50VHlwZSApICkgKSB7CgoJCXZlID0gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICk7CgoJCSQoIGV2ZW50LnRhcmdldCkudHJpZ2dlciggdmUgKTsKCX0KCglyZXR1cm4gdmU7Cn0KCmZ1bmN0aW9uIG1vdXNlRXZlbnRDYWxsYmFjayggZXZlbnQgKSB7Cgl2YXIgdG91Y2hJRCA9ICQuZGF0YShldmVudC50YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lKTsKCglpZiAoICFibG9ja01vdXNlVHJpZ2dlcnMgJiYgKCAhbGFzdFRvdWNoSUQgfHwgbGFzdFRvdWNoSUQgIT09IHRvdWNoSUQgKSApewoJCXZhciB2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2IiArIGV2ZW50LnR5cGUsIGV2ZW50ICk7CgkJaWYgKCB2ZSApIHsKCQkJaWYgKCB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQkJaWYgKCB2ZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0KCQkJaWYgKCB2ZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoIGV2ZW50ICkgewoKCXZhciB0b3VjaGVzID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlcywKCQl0YXJnZXQsIGZsYWdzOwoKCWlmICggdG91Y2hlcyAmJiB0b3VjaGVzLmxlbmd0aCA9PT0gMSApIHsKCgkJdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggdGFyZ2V0ICk7CgoJCWlmICggZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgKSB7CgoJCQlsYXN0VG91Y2hJRCA9IG5leHRUb3VjaElEKys7CgkJCSQuZGF0YSggdGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSwgbGFzdFRvdWNoSUQgKTsKCgkJCWNsZWFyUmVzZXRUaW1lcigpOwoKCQkJZGlzYWJsZU1vdXNlQmluZGluZ3MoKTsKCQkJZGlkU2Nyb2xsID0gZmFsc2U7CgoJCQl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXTsKCQkJc3RhcnRYID0gdC5wYWdlWDsKCQkJc3RhcnRZID0gdC5wYWdlWTsKCgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdmVyIiwgZXZlbnQsIGZsYWdzICk7CgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vkb3duIiwgZXZlbnQsIGZsYWdzICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVTY3JvbGwoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApICk7Cgl9CgoJZGlkU2Nyb2xsID0gdHJ1ZTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdLAoJCWRpZENhbmNlbCA9IGRpZFNjcm9sbCwKCQltb3ZlVGhyZXNob2xkID0gJC52bW91c2UubW92ZURpc3RhbmNlVGhyZXNob2xkOwoJCWRpZFNjcm9sbCA9IGRpZFNjcm9sbCB8fAoJCQkoIE1hdGguYWJzKHQucGFnZVggLSBzdGFydFgpID4gbW92ZVRocmVzaG9sZCB8fAoJCQkJTWF0aC5hYnModC5wYWdlWSAtIHN0YXJ0WSkgPiBtb3ZlVGhyZXNob2xkICksCgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKTsKCglpZiAoIGRpZFNjcm9sbCAmJiAhZGlkQ2FuY2VsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZmxhZ3MgKTsKCX0KCgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlbW92ZSIsIGV2ZW50LCBmbGFncyApOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoRW5kKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwoKCXZhciBmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApLAoJCXQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInZjbGljayIsIGV2ZW50LCBmbGFncyApOwoJCWlmICggdmUgJiYgdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCS8vIFRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyB0aGUgdG91Y2hlbmQKCQkJLy8gZXZlbnQgZG9uJ3QgbmVjZXNzYXJpbHkgbWF0Y2ggdGhlIHRhcmdldCB1c2VkIGR1cmluZyB0aGUKCQkJLy8gdG91Y2guIFRoaXMgbWVhbnMgd2UgbmVlZCB0byByZWx5IG9uIGNvb3JkaW5hdGVzIGZvciBibG9ja2luZwoJCQkvLyBhbnkgY2xpY2sgdGhhdCBpcyBnZW5lcmF0ZWQuCgkJCXQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS5jaGFuZ2VkVG91Y2hlc1sgMCBdOwoJCQljbGlja0Jsb2NrTGlzdC5wdXNoKHsKCQkJCXRvdWNoSUQ6IGxhc3RUb3VjaElELAoJCQkJeDogdC5jbGllbnRYLAoJCQkJeTogdC5jbGllbnRZCgkJCX0pOwoKCQkJLy8gUHJldmVudCBhbnkgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IGZyb20gdHJpZ2dlcmluZwoJCQkvLyB2aXJ0dWFsIGV2ZW50IG5vdGlmaWNhdGlvbnMuCgkJCWJsb2NrTW91c2VUcmlnZ2VycyA9IHRydWU7CgkJfQoJfQoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW91dCIsIGV2ZW50LCBmbGFncyk7CglkaWRTY3JvbGwgPSBmYWxzZTsKCglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFzVmlydHVhbEJpbmRpbmdzKCBlbGUgKSB7Cgl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIGVsZSwgZGF0YVByb3BlcnR5TmFtZSApLAoJCWs7CgoJaWYgKCBiaW5kaW5ncyApIHsKCQlmb3IgKCBrIGluIGJpbmRpbmdzICkgewoJCQlpZiAoIGJpbmRpbmdzWyBrIF0gKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCX0KCXJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gZHVtbXlNb3VzZUhhbmRsZXIoKXt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoaXMgZWxlbWVudCwKCQkJLy8gYWRkIGEgYmluZGluZ3Mgb2JqZWN0IHRvIGl0cyBkYXRhLgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUsIHt9KTsKCQkJfQoKCQkJLy8gSWYgc2V0dXAgaXMgY2FsbGVkLCB3ZSBrbm93IGl0IGlzIHRoZSBmaXJzdCBiaW5kaW5nIGZvciB0aGlzCgkJCS8vIGV2ZW50VHlwZSwgc28gaW5pdGlhbGl6ZSB0aGUgY291bnQgZm9yIHRoZSBldmVudFR5cGUgdG8gemVyby4KCQkJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IHRydWU7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGV2ZW50IGZvciB0aGlzIHR5cGUsCgkJCS8vIHJlZ2lzdGVyIGEgZ2xvYmFsIGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gfHwgMCApICsgMTsKCgkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID09PSAxICkgewoJCQkJJGRvY3VtZW50LmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJLy8gU29tZSBicm93c2VycywgbGlrZSBPcGVyYSBNaW5pLCB3b24ndCBkaXNwYXRjaCBtb3VzZS9jbGljayBldmVudHMKCQkJLy8gZm9yIGVsZW1lbnRzIHVubGVzcyB0aGV5IGFjdHVhbGx5IGhhdmUgaGFuZGxlcnMgcmVnaXN0ZXJlZCBvbiB0aGVtLgoJCQkvLyBUbyBnZXQgYXJvdW5kIHRoaXMsIHdlIHJlZ2lzdGVyIGR1bW15IGhhbmRsZXJzIG9uIHRoZSBlbGVtZW50cy4KCgkJCSQoIHRoaXMgKS5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIEZvciBub3csIGlmIGV2ZW50IGNhcHR1cmUgaXMgbm90IHN1cHBvcnRlZCwgd2UgcmVseSBvbiBtb3VzZSBoYW5kbGVycy4KCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoZSBkb2N1bWVudCwKCQkJCS8vIHJlZ2lzdGVyIG91ciB0b3VjaHN0YXJ0IGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJCWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdIHx8IDApICsgMTsKCgkJCQlpZiAoYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxKSB7CgkJCQkJJGRvY3VtZW50LmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgoJCQkJCQkvLyBPbiB0b3VjaCBwbGF0Zm9ybXMsIHRvdWNoaW5nIHRoZSBzY3JlZW4gYW5kIHRoZW4gZHJhZ2dpbmcgeW91ciBmaW5nZXIKCQkJCQkJLy8gY2F1c2VzIHRoZSB3aW5kb3cgY29udGVudCB0byBzY3JvbGwgYWZ0ZXIgc29tZSBkaXN0YW5jZSB0aHJlc2hvbGQgaXMKCQkJCQkJLy8gZXhjZWVkZWQuIE9uIHRoZXNlIHBsYXRmb3JtcywgYSBzY3JvbGwgcHJldmVudHMgYSBjbGljayBldmVudCBmcm9tIGJlaW5nCgkJCQkJCS8vIGRpc3BhdGNoZWQsIGFuZCBvbiBzb21lIHBsYXRmb3JtcywgZXZlbiB0aGUgdG91Y2hlbmQgaXMgc3VwcHJlc3NlZC4gVG8KCQkJCQkJLy8gbWltaWMgdGhlIHN1cHByZXNzaW9uIG9mIHRoZSBjbGljayBldmVudCwgd2UgbmVlZCB0byB3YXRjaCBmb3IgYSBzY3JvbGwKCQkJCQkJLy8gZXZlbnQuIFVuZm9ydHVuYXRlbHksIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TIGRvbid0IGRpc3BhdGNoIHNjcm9sbAoJCQkJCQkvLyBldmVudHMgdW50aWwgKkFGVEVSKiB0aGUgdXNlciBsaWZ0cyB0aGVpciBmaW5nZXIgKHRvdWNoZW5kKS4gVGhpcyBtZWFucwoJCQkJCQkvLyB3ZSBuZWVkIHRvIHdhdGNoIGJvdGggc2Nyb2xsIGFuZCB0b3VjaG1vdmUgZXZlbnRzIHRvIGZpZ3VyZSBvdXQgd2hldGhlcgoJCQkJCQkvLyBvciBub3QgYSBzY3JvbGwgaGFwcGVuZW5zIGJlZm9yZSB0aGUgdG91Y2hlbmQgZXZlbnQgaXMgZmlyZWQuCgoJCQkJCQkuYmluZCggInRvdWNobW92ZSIsIGhhbmRsZVRvdWNoTW92ZSApCgkJCQkJCS5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZSApIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIGJpbmRpbmcgZm9yIHRoaXMgZXZlbnRUeXBlLAoJCQkvLyByZW1vdmUgaXRzIGdsb2JhbCBoYW5kbGVyIGZyb20gdGhlIGRvY3VtZW50LgoKCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF07CgoJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gKSB7CgkJCQkkZG9jdW1lbnQudW5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgaW4gZXhpc3RlbmNlLAoJCQkJLy8gcmVtb3ZlIG91ciBkb2N1bWVudCB0b3VjaHN0YXJ0IGxpc3RlbmVyLgoKCQkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdOwoKCQkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSApIHsKCQkJCQkkZG9jdW1lbnQudW5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkudW5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLnVuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoJCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCWJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCQkvLyB0ZWFyZG93biBtYXkgYmUgY2FsbGVkIHdoZW4gYW4gZWxlbWVudCB3YXMKCQkJLy8gcmVtb3ZlZCBmcm9tIHRoZSBET00uIElmIHRoaXMgaXMgdGhlIGNhc2UsCgkJCS8vIGpRdWVyeSBjb3JlIG1heSBoYXZlIGFscmVhZHkgc3RyaXBwZWQgdGhlIGVsZW1lbnQKCQkJLy8gb2YgYW55IGRhdGEgYmluZGluZ3Mgc28gd2UgbmVlZCB0byBjaGVjayBpdCBiZWZvcmUKCQkJLy8gdXNpbmcgaXQuCgkJCWlmICggYmluZGluZ3MgKSB7CgkJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSBmYWxzZTsKCQkJfQoKCQkJLy8gVW5yZWdpc3RlciB0aGUgZHVtbXkgZXZlbnQgaGFuZGxlci4KCgkJCSR0aGlzLnVuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBvbiB0aGUKCQkJLy8gZWxlbWVudCwgcmVtb3ZlIHRoZSBiaW5kaW5nIGRhdGEgZnJvbSB0aGUgZWxlbWVudC4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJHRoaXMucmVtb3ZlRGF0YSggZGF0YVByb3BlcnR5TmFtZSApOwoJCQl9CgkJfQoJfTsKfQoKLy8gRXhwb3NlIG91ciBjdXN0b20gZXZlbnRzIHRvIHRoZSBqUXVlcnkgYmluZC91bmJpbmQgbWVjaGFuaXNtLgoKZm9yICggdmFyIGkgPSAwOyBpIDwgdmlydHVhbEV2ZW50TmFtZXMubGVuZ3RoOyBpKysgKXsKCSQuZXZlbnQuc3BlY2lhbFsgdmlydHVhbEV2ZW50TmFtZXNbIGkgXSBdID0gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdICk7Cn0KCi8vIEFkZCBhIGNhcHR1cmUgY2xpY2sgaGFuZGxlciB0byBibG9jayBjbGlja3MuCi8vIE5vdGUgdGhhdCB3ZSByZXF1aXJlIGV2ZW50IGNhcHR1cmUgc3VwcG9ydCBmb3IgdGhpcyBzbyBpZiB0aGUgZGV2aWNlCi8vIGRvZXNuJ3Qgc3VwcG9ydCBpdCwgd2UgcHVudCBmb3Igbm93IGFuZCByZWx5IHNvbGVseSBvbiBtb3VzZSBldmVudHMuCmlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggImNsaWNrIiwgZnVuY3Rpb24oIGUgKXsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGVoc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKCi8vIFNjcmlwdDogalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQKLy8gCi8vICpWZXJzaW9uOiAxLjMsIExhc3QgdXBkYXRlZDogNy8yMS8yMDEwKgovLyAKLy8gUHJvamVjdCBIb21lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS1wbHVnaW4vCi8vIEdpdEh1YiAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS8KLy8gU291cmNlICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UuanMKLy8gKE1pbmlmaWVkKSAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UubWluLmpzICgwLjhrYiBnemlwcGVkKQovLyAKLy8gQWJvdXQ6IExpY2Vuc2UKLy8gCi8vIENvcHlyaWdodCAoYykgMjAxMCAiQ293Ym95IiBCZW4gQWxtYW4sCi8vIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgovLyBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCi8vIAovLyBBYm91dDogRXhhbXBsZXMKLy8gCi8vIFRoZXNlIHdvcmtpbmcgZXhhbXBsZXMsIGNvbXBsZXRlIHdpdGggZnVsbHkgY29tbWVudGVkIGNvZGUsIGlsbHVzdHJhdGUgYSBmZXcKLy8gd2F5cyBpbiB3aGljaCB0aGlzIHBsdWdpbiBjYW4gYmUgdXNlZC4KLy8gCi8vIGhhc2hjaGFuZ2UgZXZlbnQgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvaGFzaGNoYW5nZS8KLy8gZG9jdW1lbnQuZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2RvY3VtZW50X2RvbWFpbi8KLy8gCi8vIEFib3V0OiBTdXBwb3J0IGFuZCBUZXN0aW5nCi8vIAovLyBJbmZvcm1hdGlvbiBhYm91dCB3aGF0IHZlcnNpb24gb3IgdmVyc2lvbnMgb2YgalF1ZXJ5IHRoaXMgcGx1Z2luIGhhcyBiZWVuCi8vIHRlc3RlZCB3aXRoLCB3aGF0IGJyb3dzZXJzIGl0IGhhcyBiZWVuIHRlc3RlZCBpbiwgYW5kIHdoZXJlIHRoZSB1bml0IHRlc3RzCi8vIHJlc2lkZSAoc28geW91IGNhbiB0ZXN0IGl0IHlvdXJzZWxmKS4KLy8gCi8vIGpRdWVyeSBWZXJzaW9ucyAtIDEuMi42LCAxLjMuMiwgMS40LjEsIDEuNC4yCi8vIEJyb3dzZXJzIFRlc3RlZCAtIEludGVybmV0IEV4cGxvcmVyIDYtOCwgRmlyZWZveCAyLTQsIENocm9tZSA1LTYsIFNhZmFyaSAzLjItNSwKLy8gICAgICAgICAgICAgICAgICAgT3BlcmEgOS42LTEwLjYwLCBpUGhvbmUgMy4xLCBBbmRyb2lkIDEuNi0yLjIsIEJsYWNrQmVycnkgNC42LTUuCi8vIFVuaXQgVGVzdHMgICAgICAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS91bml0LwovLyAKLy8gQWJvdXQ6IEtub3duIGlzc3VlcwovLyAKLy8gV2hpbGUgdGhpcyBqUXVlcnkgaGFzaGNoYW5nZSBldmVudCBpbXBsZW1lbnRhdGlvbiBpcyBxdWl0ZSBzdGFibGUgYW5kCi8vIHJvYnVzdCwgdGhlcmUgYXJlIGEgZmV3IHVuZm9ydHVuYXRlIGJyb3dzZXIgYnVncyBzdXJyb3VuZGluZyBleHBlY3RlZAovLyBoYXNoY2hhbmdlIGV2ZW50LWJhc2VkIGJlaGF2aW9ycywgaW5kZXBlbmRlbnQgb2YgYW55IEphdmFTY3JpcHQKLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBhYnN0cmFjdGlvbi4gU2VlIHRoZSBmb2xsb3dpbmcgZXhhbXBsZXMgZm9yIG1vcmUKLy8gaW5mb3JtYXRpb246Ci8vIAovLyBDaHJvbWU6IEJhY2sgQnV0dG9uIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1jaHJvbWUtYmFjay1idXR0b24vCi8vIEZpcmVmb3g6IFJlbW90ZSBYTUxIdHRwUmVxdWVzdCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctZmlyZWZveC1yZW1vdGUteGhyLwovLyBXZWJLaXQ6IEJhY2sgQnV0dG9uIGluIGFuIElmcmFtZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctd2Via2l0LWhhc2gtaWZyYW1lLwovLyBTYWZhcmk6IEJhY2sgQnV0dG9uIGZyb20gYSBkaWZmZXJlbnQgZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1zYWZhcmktYmFjay1mcm9tLWRpZmYtZG9tYWluLwovLyAKLy8gQWxzbyBub3RlIHRoYXQgc2hvdWxkIGEgYnJvd3NlciBuYXRpdmVseSBzdXBwb3J0IHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIAovLyBldmVudCwgYnV0IG5vdCByZXBvcnQgdGhhdCBpdCBkb2VzLCB0aGUgZmFsbGJhY2sgcG9sbGluZyBsb29wIHdpbGwgYmUgdXNlZC4KLy8gCi8vIEFib3V0OiBSZWxlYXNlIEhpc3RvcnkKLy8gCi8vIDEuMyAgIC0gKDcvMjEvMjAxMCkgUmVvcmdhbml6ZWQgSUU2LzcgSWZyYW1lIGNvZGUgdG8gbWFrZSBpdCBtb3JlCi8vICAgICAgICAgInJlbW92YWJsZSIgZm9yIG1vYmlsZS1vbmx5IGRldmVsb3BtZW50LiBBZGRlZCBJRTYvNyBkb2N1bWVudC50aXRsZQovLyAgICAgICAgIHN1cHBvcnQuIEF0dGVtcHRlZCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUgYnkgdXNpbmcKLy8gICAgICAgICB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4gQWRkZWQgCi8vICAgICAgICAgc3VwcG9ydCBmb3IgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQod2luZG93KS5oYXNoY2hhbmdlKCBmbiApIGFuZAovLyAgICAgICAgICQod2luZG93KS5oYXNoY2hhbmdlKCkgbGlrZSBqUXVlcnkgcHJvdmlkZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KLy8gICAgICAgICBSZW5hbWVkIGpRdWVyeS5oYXNoY2hhbmdlRGVsYXkgdG8gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBhbmQKLy8gICAgICAgICBsb3dlcmVkIGl0cyBkZWZhdWx0IHZhbHVlIHRvIDUwLiBBZGRlZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPgovLyAgICAgICAgIGFuZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0aWVzIHBsdXMgZG9jdW1lbnQtZG9tYWluLmh0bWwKLy8gICAgICAgICBmaWxlIHRvIGFkZHJlc3MgYWNjZXNzIGRlbmllZCBpc3N1ZXMgd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbgovLyAgICAgICAgIElFNi83LgovLyAxLjIgICAtICgyLzExLzIwMTApIEZpeGVkIGEgYnVnIHdoZXJlIGNvbWluZyBiYWNrIHRvIGEgcGFnZSB1c2luZyB0aGlzIHBsdWdpbgovLyAgICAgICAgIGZyb20gYSBwYWdlIG9uIGFub3RoZXIgZG9tYWluIHdvdWxkIGNhdXNlIGFuIGVycm9yIGluIFNhZmFyaSA0LiBBbHNvLAovLyAgICAgICAgIElFNi83IElmcmFtZSBpcyBub3cgaW5zZXJ0ZWQgYWZ0ZXIgdGhlIGJvZHkgKHRoaXMgYWN0dWFsbHkgd29ya3MpLAovLyAgICAgICAgIHdoaWNoIHByZXZlbnRzIHRoZSBwYWdlIGZyb20gc2Nyb2xsaW5nIHdoZW4gdGhlIGV2ZW50IGlzIGZpcnN0IGJvdW5kLgovLyAgICAgICAgIEV2ZW50IGNhbiBhbHNvIG5vdyBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgaXQgd29uJ3QgYmUgdXNhYmxlCi8vICAgICAgICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcuCi8vIDEuMSAgIC0gKDEvMjEvMjAxMCkgSW5jb3Jwb3JhdGVkIGRvY3VtZW50LmRvY3VtZW50TW9kZSB0ZXN0IHRvIGZpeCBJRTggYnVnCi8vICAgICAgICAgd2hlcmUgYnJvd3NlciB2ZXJzaW9uIGlzIGluY29ycmVjdGx5IHJlcG9ydGVkIGFzIDguMCwgZGVzcGl0ZQovLyAgICAgICAgIGluY2x1c2lvbiBvZiB0aGUgWC1VQS1Db21wYXRpYmxlIElFPUVtdWxhdGVJRTcgbWV0YSB0YWcuCi8vIDEuMCAgIC0gKDEvOS8yMDEwKSBJbml0aWFsIFJlbGVhc2UuIEJyb2tlIG91dCB0aGUgalF1ZXJ5IEJCUSBldmVudC5zcGVjaWFsCi8vICAgICAgICAgd2luZG93Lm9uaGFzaGNoYW5nZSBmdW5jdGlvbmFsaXR5IGludG8gYSBzZXBhcmF0ZSBwbHVnaW4gZm9yIHVzZXJzCi8vICAgICAgICAgd2hvIHdhbnQganVzdCB0aGUgYmFzaWMgZXZlbnQgJiBiYWNrIGJ1dHRvbiBzdXBwb3J0LCB3aXRob3V0IGFsbCB0aGUKLy8gICAgICAgICBleHRyYSBhd2Vzb21lbmVzcyB0aGF0IEJCUSBwcm92aWRlcy4gVGhpcyBwbHVnaW4gd2lsbCBiZSBpbmNsdWRlZCBhcwovLyAgICAgICAgIHBhcnQgb2YgalF1ZXJ5IEJCUSwgYnV0IGFsc28gYmUgYXZhaWxhYmxlIHNlcGFyYXRlbHkuCgooZnVuY3Rpb24oJCx3aW5kb3csdW5kZWZpbmVkKXsKICAvLyBSZXVzZWQgc3RyaW5nLgogIHZhciBzdHJfaGFzaGNoYW5nZSA9ICdoYXNoY2hhbmdlJywKICAgIAogICAgLy8gTWV0aG9kIC8gb2JqZWN0IHJlZmVyZW5jZXMuCiAgICBkb2MgPSBkb2N1bWVudCwKICAgIGZha2Vfb25oYXNoY2hhbmdlLAogICAgc3BlY2lhbCA9ICQuZXZlbnQuc3BlY2lhbCwKICAgIAogICAgLy8gRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IHdpbmRvdy5vbmhhc2hjaGFuZ2U/IE5vdGUgdGhhdCBJRTggcnVubmluZyBpbgogICAgLy8gSUU3IGNvbXBhdGliaWxpdHkgbW9kZSByZXBvcnRzIHRydWUgZm9yICdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdywgZXZlbgogICAgLy8gdGhvdWdoIHRoZSBldmVudCBpc24ndCBzdXBwb3J0ZWQsIHNvIGFsc28gdGVzdCBkb2N1bWVudC5kb2N1bWVudE1vZGUuCiAgICBkb2NfbW9kZSA9IGRvYy5kb2N1bWVudE1vZGUsCiAgICBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgPSAnb24nICsgc3RyX2hhc2hjaGFuZ2UgaW4gd2luZG93ICYmICggZG9jX21vZGUgPT09IHVuZGVmaW5lZCB8fCBkb2NfbW9kZSA+IDcgKTsKICAKICAvLyBHZXQgbG9jYXRpb24uaGFzaCAob3Igd2hhdCB5b3UnZCBleHBlY3QgbG9jYXRpb24uaGFzaCB0byBiZSkgc2FucyBhbnkKICAvLyBsZWFkaW5nICMuIFRoYW5rcyBmb3IgbWFraW5nIHRoaXMgbmVjZXNzYXJ5LCBGaXJlZm94IQogIGZ1bmN0aW9uIGdldF9mcmFnbWVudCggdXJsICkgewogICAgdXJsID0gdXJsIHx8IGxvY2F0aW9uLmhyZWY7CiAgICByZXR1cm4gJyMnICsgdXJsLnJlcGxhY2UoIC9eW14jXSojPyguKikkLywgJyQxJyApOwogIH07CiAgCiAgLy8gTWV0aG9kOiBqUXVlcnkuZm4uaGFzaGNoYW5nZQogIC8vIAogIC8vIEJpbmQgYSBoYW5kbGVyIHRvIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IG9yIHRyaWdnZXIgYWxsIGJvdW5kCiAgLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycy4gVGhpcyBiZWhhdmlvciBpcyBjb25zaXN0ZW50IHdpdGgKICAvLyBqUXVlcnkncyBidWlsdC1pbiBldmVudCBoYW5kbGVycy4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIFsgaGFuZGxlciBdICk7CiAgLy8gCiAgLy8gQXJndW1lbnRzOgogIC8vIAogIC8vICBoYW5kbGVyIC0gKEZ1bmN0aW9uKSBPcHRpb25hbCBoYW5kbGVyIHRvIGJlIGJvdW5kIHRvIHRoZSBoYXNoY2hhbmdlCiAgLy8gICAgZXZlbnQuIFRoaXMgaXMgYSAic2hvcnRjdXQiIGZvciB0aGUgbW9yZSB2ZXJib3NlIGZvcm06CiAgLy8gICAgalF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBoYW5kbGVyICkuIElmIGhhbmRsZXIgaXMgb21pdHRlZCwKICAvLyAgICBhbGwgYm91bmQgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycyB3aWxsIGJlIHRyaWdnZXJlZC4gVGhpcwogIC8vICAgIGlzIGEgc2hvcnRjdXQgZm9yIHRoZSBtb3JlIHZlcmJvc2UKICAvLyAgICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4gVGhlc2UgZm9ybXMgYXJlIGRlc2NyaWJlZCBpbgogIC8vICAgIHRoZSA8aGFzaGNoYW5nZSBldmVudD4gc2VjdGlvbi4KICAvLyAKICAvLyBSZXR1cm5zOgogIC8vIAogIC8vICAoalF1ZXJ5KSBUaGUgaW5pdGlhbCBqUXVlcnkgY29sbGVjdGlvbiBvZiBlbGVtZW50cy4KICAKICAvLyBBbGxvdyB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJChlbGVtKS5oYXNoY2hhbmdlKCBmbiApIGZvciBiaW5kaW5nIGFuZAogIC8vICQoZWxlbSkuaGFzaGNoYW5nZSgpIGZvciB0cmlnZ2VyaW5nLCBsaWtlIGpRdWVyeSBkb2VzIGZvciBidWlsdC1pbiBldmVudHMuCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXSA9IGZ1bmN0aW9uKCBmbiApIHsKICAgIHJldHVybiBmbiA/IHRoaXMuYmluZCggc3RyX2hhc2hjaGFuZ2UsIGZuICkgOiB0aGlzLnRyaWdnZXIoIHN0cl9oYXNoY2hhbmdlICk7CiAgfTsKICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXkKICAvLyAKICAvLyBUaGUgbnVtZXJpYyBpbnRlcnZhbCAoaW4gbWlsbGlzZWNvbmRzKSBhdCB3aGljaCB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+CiAgLy8gcG9sbGluZyBsb29wIGV4ZWN1dGVzLiBEZWZhdWx0cyB0byA1MC4KICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluCiAgLy8gCiAgLy8gSWYgeW91J3JlIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluIHlvdXIgSmF2YVNjcmlwdCwgYW5kIHlvdSB3YW50IGhhc2gKICAvLyBoaXN0b3J5IHRvIHdvcmsgaW4gSUU2LzcsIG5vdCBvbmx5IG11c3QgdGhpcyBwcm9wZXJ0eSBiZSBzZXQsIGJ1dCB5b3UgbXVzdAogIC8vIGFsc28gc2V0IGRvY3VtZW50LmRvbWFpbiBCRUZPUkUgalF1ZXJ5IGlzIGxvYWRlZCBpbnRvIHRoZSBwYWdlLiBUaGlzCiAgLy8gcHJvcGVydHkgaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZwogIC8vIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gSW4gYWRkaXRpb24sIHRoZSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0eSBtdXN0IGJlIHNldCB0byB0aGUKICAvLyBwYXRoIG9mIHRoZSBpbmNsdWRlZCAiZG9jdW1lbnQtZG9tYWluLmh0bWwiIGZpbGUsIHdoaWNoIGNhbiBiZSByZW5hbWVkIG9yCiAgLy8gbW9kaWZpZWQgaWYgbmVjZXNzYXJ5IChub3RlIHRoYXQgdGhlIGRvY3VtZW50LmRvbWFpbiBzcGVjaWZpZWQgbXVzdCBiZSB0aGUKICAvLyBzYW1lIGluIGJvdGggeW91ciBtYWluIEphdmFTY3JpcHQgYXMgd2VsbCBhcyBpbiB0aGlzIGZpbGUpLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vIGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbiA9IGRvY3VtZW50LmRvbWFpbjsKICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjCiAgLy8gCiAgLy8gSWYsIGZvciBzb21lIHJlYXNvbiwgeW91IG5lZWQgdG8gc3BlY2lmeSBhbiBJZnJhbWUgc3JjIGZpbGUgKGZvciBleGFtcGxlLAogIC8vIHdoZW4gc2V0dGluZyBkb2N1bWVudC5kb21haW4gYXMgaW4gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbj4pLCB5b3UgY2FuCiAgLy8gZG8gc28gdXNpbmcgdGhpcyBwcm9wZXJ0eS4gTm90ZSB0aGF0IHdoZW4gdXNpbmcgdGhpcyBwcm9wZXJ0eSwgaGlzdG9yeQogIC8vIHdvbid0IGJlIHJlY29yZGVkIGluIElFNi83IHVudGlsIHRoZSBJZnJhbWUgc3JjIGZpbGUgbG9hZHMuIFRoaXMgcHJvcGVydHkKICAvLyBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMgPSAncGF0aC90by9maWxlLmh0bWwnOwogIAogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgPSA1MDsKICAvKgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluID0gbnVsbDsKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLnNyYyA9IG51bGw7CiAgKi8KICAKICAvLyBFdmVudDogaGFzaGNoYW5nZSBldmVudAogIC8vIAogIC8vIEZpcmVkIHdoZW4gbG9jYXRpb24uaGFzaCBjaGFuZ2VzLiBJbiBicm93c2VycyB0aGF0IHN1cHBvcnQgaXQsIHRoZSBuYXRpdmUKICAvLyBIVE1MNSB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGlzIHVzZWQsIG90aGVyd2lzZSBhIHBvbGxpbmcgbG9vcCBpcwogIC8vIGluaXRpYWxpemVkLCBydW5uaW5nIGV2ZXJ5IDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheT4gbWlsbGlzZWNvbmRzIHRvCiAgLy8gc2VlIGlmIHRoZSBoYXNoIGhhcyBjaGFuZ2VkLiBJbiBJRTYvNyAoYW5kIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLCBhIGhpZGRlbiBJZnJhbWUgaXMgY3JlYXRlZCB0byBhbGxvdyB0aGUgYmFjayBidXR0b24KICAvLyBhbmQgaGFzaC1iYXNlZCBoaXN0b3J5IHRvIHdvcmsuCiAgLy8gCiAgLy8gVXNhZ2UgYXMgZGVzY3JpYmVkIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZT46CiAgLy8gCiAgLy8gPiAvLyBCaW5kIGFuIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKTsKICAvLyAKICAvLyBBIG1vcmUgdmVyYm9zZSB1c2FnZSB0aGF0IGFsbG93cyBmb3IgZXZlbnQgbmFtZXNwYWNpbmc6CiAgLy8gCiAgLy8gPiAvLyBCaW5kIGFuIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5iaW5kKCAnaGFzaGNoYW5nZScsIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4gCiAgLy8gPiAvLyBNYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICk7CiAgLy8gCiAgLy8gQWRkaXRpb25hbCBOb3RlczoKICAvLyAKICAvLyAqIFRoZSBwb2xsaW5nIGxvb3AgYW5kIElmcmFtZSBhcmUgbm90IGNyZWF0ZWQgdW50aWwgYXQgbGVhc3Qgb25lIGhhbmRsZXIKICAvLyAgIGlzIGFjdHVhbGx5IGJvdW5kIHRvIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQuCiAgLy8gKiBJZiB5b3UgbmVlZCB0aGUgYm91bmQgaGFuZGxlcihzKSB0byBleGVjdXRlIGltbWVkaWF0ZWx5LCBpbiBjYXNlcyB3aGVyZQogIC8vICAgYSBsb2NhdGlvbi5oYXNoIGV4aXN0cyBvbiBwYWdlIGxvYWQsIHZpYSBib29rbWFyayBvciBwYWdlIHJlZnJlc2ggZm9yCiAgLy8gICBleGFtcGxlLCB1c2UgalF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSgpIG9yIHRoZSBtb3JlIHZlcmJvc2UgCiAgLy8gICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4KICAvLyAqIFRoZSBldmVudCBjYW4gYmUgYm91bmQgYmVmb3JlIERPTSByZWFkeSwgYnV0IHNpbmNlIGl0IHdvbid0IGJlIHVzYWJsZQogIC8vICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcgKGR1ZSB0byB0aGUgbmVjZXNzYXJ5IElmcmFtZSksIHJlY29tbWVuZGVkIHVzYWdlIGlzCiAgLy8gICB0byBiaW5kIGl0IGluc2lkZSBhIERPTSByZWFkeSBoYW5kbGVyLgogIAogIC8vIE92ZXJyaWRlIGV4aXN0aW5nICQuZXZlbnQuc3BlY2lhbC5oYXNoY2hhbmdlIG1ldGhvZHMgKGFsbG93aW5nIHRoaXMgcGx1Z2luCiAgLy8gdG8gYmUgZGVmaW5lZCBhZnRlciBqUXVlcnkgQkJRIGluIEJCUSdzIHNvdXJjZSBjb2RlKS4KICBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdID0gJC5leHRlbmQoIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0sIHsKICAgIAogICAgLy8gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgZmlyc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIGJvdW5kIHRvIHdpbmRvdy4KICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgLy8gSWYgd2luZG93Lm9uaGFzaGNoYW5nZSBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoZXJlJ3Mgbm90aGluZyB0byBkby4uCiAgICAgIGlmICggc3VwcG9ydHNfb25oYXNoY2hhbmdlICkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgCiAgICAgIC8vIE90aGVyd2lzZSwgd2UgbmVlZCB0byBjcmVhdGUgb3VyIG93bi4gQW5kIHdlIGRvbid0IHdhbnQgdG8gY2FsbCB0aGlzCiAgICAgIC8vIHVudGlsIHRoZSB1c2VyIGJpbmRzIHRvIHRoZSBldmVudCwganVzdCBpbiBjYXNlIHRoZXkgbmV2ZXIgZG8sIHNpbmNlIGl0CiAgICAgIC8vIHdpbGwgY3JlYXRlIGEgcG9sbGluZyBsb29wIGFuZCBwb3NzaWJseSBldmVuIGEgaGlkZGVuIElmcmFtZS4KICAgICAgJCggZmFrZV9vbmhhc2hjaGFuZ2Uuc3RhcnQgKTsKICAgIH0sCiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGxhc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIHVuYm91bmQgZnJvbSB3aW5kb3cuCiAgICB0ZWFyZG93bjogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gc3RvcCBvdXJzIChpZiBwb3NzaWJsZSkuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0b3AgKTsKICAgIH0KICAgIAogIH0pOwogIAogIC8vIGZha2Vfb25oYXNoY2hhbmdlIGRvZXMgYWxsIHRoZSB3b3JrIG9mIHRyaWdnZXJpbmcgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UKICAvLyBldmVudCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBuYXRpdmVseSBzdXBwb3J0IGl0LCBpbmNsdWRpbmcgY3JlYXRpbmcgYQogIC8vIHBvbGxpbmcgbG9vcCB0byB3YXRjaCBmb3IgaGFzaCBjaGFuZ2VzIGFuZCBpbiBJRSA2LzcgY3JlYXRpbmcgYSBoaWRkZW4KICAvLyBJZnJhbWUgdG8gZW5hYmxlIGJhY2sgYW5kIGZvcndhcmQuCiAgZmFrZV9vbmhhc2hjaGFuZ2UgPSAoZnVuY3Rpb24oKXsKICAgIHZhciBzZWxmID0ge30sCiAgICAgIHRpbWVvdXRfaWQsCiAgICAgIAogICAgICAvLyBSZW1lbWJlciB0aGUgaW5pdGlhbCBoYXNoIHNvIGl0IGRvZXNuJ3QgZ2V0IHRyaWdnZXJlZCBpbW1lZGlhdGVseS4KICAgICAgbGFzdF9oYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgIAogICAgICBmbl9yZXR2YWwgPSBmdW5jdGlvbih2YWwpeyByZXR1cm4gdmFsOyB9LAogICAgICBoaXN0b3J5X3NldCA9IGZuX3JldHZhbCwKICAgICAgaGlzdG9yeV9nZXQgPSBmbl9yZXR2YWw7CiAgICAKICAgIC8vIFN0YXJ0IHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgfHwgcG9sbCgpOwogICAgfTsKICAgIAogICAgLy8gU3RvcCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgJiYgY2xlYXJUaW1lb3V0KCB0aW1lb3V0X2lkICk7CiAgICAgIHRpbWVvdXRfaWQgPSB1bmRlZmluZWQ7CiAgICB9OwogICAgCiAgICAvLyBUaGlzIHBvbGxpbmcgbG9vcCBjaGVja3MgZXZlcnkgJC5mbi5oYXNoY2hhbmdlLmRlbGF5IG1pbGxpc2Vjb25kcyB0byBzZWUKICAgIC8vIGlmIGxvY2F0aW9uLmhhc2ggaGFzIGNoYW5nZWQsIGFuZCB0cmlnZ2VycyB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50IG9uCiAgICAvLyB3aW5kb3cgd2hlbiBuZWNlc3NhcnkuCiAgICBmdW5jdGlvbiBwb2xsKCkgewogICAgICB2YXIgaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAgIGhpc3RvcnlfaGFzaCA9IGhpc3RvcnlfZ2V0KCBsYXN0X2hhc2ggKTsKICAgICAgCiAgICAgIGlmICggaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGhpc3Rvcnlfc2V0KCBsYXN0X2hhc2ggPSBoYXNoLCBoaXN0b3J5X2hhc2ggKTsKICAgICAgICAKICAgICAgICAkKHdpbmRvdykudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICAgICAgICAKICAgICAgfSBlbHNlIGlmICggaGlzdG9yeV9oYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgbG9jYXRpb24uaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSggLyMuKi8sICcnICkgKyBoaXN0b3J5X2hhc2g7CiAgICAgIH0KICAgICAgCiAgICAgIHRpbWVvdXRfaWQgPSBzZXRUaW1lb3V0KCBwb2xsLCAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ICk7CiAgICB9OwogICAgCiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYgUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAkLmJyb3dzZXIubXNpZSAmJiAhc3VwcG9ydHNfb25oYXNoY2hhbmdlICYmIChmdW5jdGlvbigpewogICAgICAvLyBOb3Qgb25seSBkbyBJRTYvNyBuZWVkIHRoZSAibWFnaWNhbCIgSWZyYW1lIHRyZWF0bWVudCwgYnV0IHNvIGRvZXMgSUU4CiAgICAgIC8vIHdoZW4gcnVubmluZyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUuCiAgICAgIAogICAgICB2YXIgaWZyYW1lLAogICAgICAgIGlmcmFtZV9zcmM7CiAgICAgIAogICAgICAvLyBXaGVuIHRoZSBldmVudCBpcyBib3VuZCBhbmQgcG9sbGluZyBzdGFydHMgaW4gSUUgNi83LCBjcmVhdGUgYSBoaWRkZW4KICAgICAgLy8gSWZyYW1lIGZvciBoaXN0b3J5IGhhbmRsaW5nLgogICAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKXsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBpZnJhbWVfc3JjIHx8IGhpc3Rvcnlfc2V0KCBnZXRfZnJhZ21lbnQoKSApOwogICAgICAgICAgICAgIHBvbGwoKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvYWQgSWZyYW1lIHNyYyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBub3RoaW5nLgogICAgICAgICAgICAuYXR0ciggJ3NyYycsIGlmcmFtZV9zcmMgfHwgJ2phdmFzY3JpcHQ6MCcgKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwZW5kIElmcmFtZSBhZnRlciB0aGUgZW5kIG9mIHRoZSBib2R5IHRvIHByZXZlbnQgdW5uZWNlc3NhcnkKICAgICAgICAgICAgLy8gaW5pdGlhbCBwYWdlIHNjcm9sbGluZyAoeWVzLCB0aGlzIHdvcmtzKS4KICAgICAgICAgICAgLmluc2VydEFmdGVyKCAnYm9keScgKVswXS5jb250ZW50V2luZG93OwogICAgICAgICAgCiAgICAgICAgICAvLyBXaGVuZXZlciBgZG9jdW1lbnQudGl0bGVgIGNoYW5nZXMsIHVwZGF0ZSB0aGUgSWZyYW1lJ3MgdGl0bGUgdG8KICAgICAgICAgIC8vIHByZXR0aWZ5IHRoZSBiYWNrL25leHQgaGlzdG9yeSBtZW51IGVudHJpZXMuIFNpbmNlIElFIHNvbWV0aW1lcwogICAgICAgICAgLy8gZXJyb3JzIHdpdGggIlVuc3BlY2lmaWVkIGVycm9yIiB0aGUgdmVyeSBmaXJzdCB0aW1lIHRoaXMgaXMgc2V0CiAgICAgICAgICAvLyAoeWVzLCB2ZXJ5IHVzZWZ1bCkgd3JhcCB0aGlzIHdpdGggYSB0cnkvY2F0Y2ggYmxvY2suCiAgICAgICAgICBkb2Mub25wcm9wZXJ0eWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKCBldmVudC5wcm9wZXJ0eU5hbWUgPT09ICd0aXRsZScgKSB7CiAgICAgICAgICAgICAgICBpZnJhbWUuZG9jdW1lbnQudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICB9OwogICAgICAgICAgCiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgICAgLy8gT3ZlcnJpZGUgdGhlICJzdG9wIiBtZXRob2Qgc2luY2UgYW4gSUU2LzcgSWZyYW1lIHdhcyBjcmVhdGVkLiBFdmVuCiAgICAgIC8vIGlmIHRoZXJlIGFyZSBubyBsb25nZXIgYW55IGJvdW5kIGV2ZW50IGhhbmRsZXJzLCB0aGUgcG9sbGluZyBsb29wCiAgICAgIC8vIGlzIHN0aWxsIG5lY2Vzc2FyeSBmb3IgYmFjay9uZXh0IHRvIHdvcmsgYXQgYWxsIQogICAgICBzZWxmLnN0b3AgPSBmbl9yZXR2YWw7CiAgICAgIAogICAgICAvLyBHZXQgaGlzdG9yeSBieSBsb29raW5nIGF0IHRoZSBoaWRkZW4gSWZyYW1lJ3MgbG9jYXRpb24uaGFzaC4KICAgICAgaGlzdG9yeV9nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZ2V0X2ZyYWdtZW50KCBpZnJhbWUubG9jYXRpb24uaHJlZiApOwogICAgICB9OwogICAgICAKICAgICAgLy8gU2V0IGEgbmV3IGhpc3RvcnkgaXRlbSBieSBvcGVuaW5nIGFuZCB0aGVuIGNsb3NpbmcgdGhlIElmcmFtZQogICAgICAvLyBkb2N1bWVudCwgKnRoZW4qIHNldHRpbmcgaXRzIGxvY2F0aW9uLmhhc2guIElmIGRvY3VtZW50LmRvbWFpbiBoYXMKICAgICAgLy8gYmVlbiBzZXQsIHVwZGF0ZSB0aGF0IGFzIHdlbGwuCiAgICAgIGhpc3Rvcnlfc2V0ID0gZnVuY3Rpb24oIGhhc2gsIGhpc3RvcnlfaGFzaCApIHsKICAgICAgICB2YXIgaWZyYW1lX2RvYyA9IGlmcmFtZS5kb2N1bWVudCwKICAgICAgICAgIGRvbWFpbiA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluOwogICAgICAgIAogICAgICAgIGlmICggaGFzaCAhPT0gaGlzdG9yeV9oYXNoICkgewogICAgICAgICAgLy8gVXBkYXRlIElmcmFtZSB3aXRoIGFueSBpbml0aWFsIGBkb2N1bWVudC50aXRsZWAgdGhhdCBtaWdodCBiZSBzZXQuCiAgICAgICAgICBpZnJhbWVfZG9jLnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgCiAgICAgICAgICAvLyBPcGVuaW5nIHRoZSBJZnJhbWUncyBkb2N1bWVudCBhZnRlciBpdCBoYXMgYmVlbiBjbG9zZWQgaXMgd2hhdAogICAgICAgICAgLy8gYWN0dWFsbHkgYWRkcyBhIGhpc3RvcnkgZW50cnkuCiAgICAgICAgICBpZnJhbWVfZG9jLm9wZW4oKTsKICAgICAgICAgIAogICAgICAgICAgLy8gU2V0IGRvY3VtZW50LmRvbWFpbiBmb3IgdGhlIElmcmFtZSBkb2N1bWVudCBhcyB3ZWxsLCBpZiBuZWNlc3NhcnkuCiAgICAgICAgICBkb21haW4gJiYgaWZyYW1lX2RvYy53cml0ZSggJzxzY3JpcHQ+ZG9jdW1lbnQuZG9tYWluPSInICsgZG9tYWluICsgJyI8L3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKLyohCiAqIGpRdWVyeSBVSSBXaWRnZXQgQFZFUlNJT04KICoKICogQ29weXJpZ2h0IDIwMTAsIEFVVEhPUlMudHh0IChodHRwOi8vanF1ZXJ5dWkuY29tL2Fib3V0KQogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1VJL1dpZGdldAogKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8galF1ZXJ5IDEuNCsKaWYgKCAkLmNsZWFuRGF0YSApIHsKCXZhciBfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CgkkLmNsZWFuRGF0YSA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCQlmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCX0KCQlfY2xlYW5EYXRhKCBlbGVtcyApOwoJfTsKfSBlbHNlIHsKCXZhciBfcmVtb3ZlID0gJC5mbi5yZW1vdmU7CgkkLmZuLnJlbW92ZSA9IGZ1bmN0aW9uKCBzZWxlY3Rvciwga2VlcERhdGEgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAha2VlcERhdGEgKSB7CgkJCQlpZiAoICFzZWxlY3RvciB8fCAkLmZpbHRlciggc2VsZWN0b3IsIFsgdGhpcyBdICkubGVuZ3RoICkgewoJCQkJCSQoICIqIiwgdGhpcyApLmFkZCggWyB0aGlzIF0gKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkkKCB0aGlzICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJCQkJfSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIF9yZW1vdmUuY2FsbCggJCh0aGlzKSwgc2VsZWN0b3IsIGtlZXBEYXRhICk7CgkJfSk7Cgl9Owp9CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXSwKCQlmdWxsTmFtZTsKCW5hbWUgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMSBdOwoJZnVsbE5hbWUgPSBuYW1lc3BhY2UgKyAiLSIgKyBuYW1lOwoKCWlmICggIXByb3RvdHlwZSApIHsKCQlwcm90b3R5cGUgPSBiYXNlOwoJCWJhc2UgPSAkLldpZGdldDsKCX0KCgkvLyBjcmVhdGUgc2VsZWN0b3IgZm9yIHBsdWdpbgoJJC5leHByWyAiOiIgXVsgZnVsbE5hbWUgXSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhISQuZGF0YSggZWxlbSwgbmFtZSApOwoJfTsKCgkkWyBuYW1lc3BhY2UgXSA9ICRbIG5hbWVzcGFjZSBdIHx8IHt9OwoJJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCgl2YXIgYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQovLwkkLmVhY2goIGJhc2VQcm90b3R5cGUsIGZ1bmN0aW9uKCBrZXksIHZhbCApIHsKLy8JCWlmICggJC5pc1BsYWluT2JqZWN0KHZhbCkgKSB7Ci8vCQkJYmFzZVByb3RvdHlwZVsga2V5IF0gPSAkLmV4dGVuZCgge30sIHZhbCApOwovLwkJfQovLwl9KTsKCWJhc2VQcm90b3R5cGUub3B0aW9ucyA9ICQuZXh0ZW5kKCB0cnVlLCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkWyBuYW1lc3BhY2UgXVsgbmFtZSBdLnByb3RvdHlwZSA9ICQuZXh0ZW5kKCB0cnVlLCBiYXNlUHJvdG90eXBlLCB7CgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRFdmVudFByZWZpeDogJFsgbmFtZXNwYWNlIF1bIG5hbWUgXS5wcm90b3R5cGUud2lkZ2V0RXZlbnRQcmVmaXggfHwgbmFtZSwKCQl3aWRnZXRCYXNlQ2xhc3M6IGZ1bGxOYW1lCgl9LCBwcm90b3R5cGUgKTsKCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gKTsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCQlyZXR1cm5WYWx1ZSA9IHRoaXM7CgoJCS8vIGFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCW9wdGlvbnMgPSAhaXNNZXRob2RDYWxsICYmIGFyZ3MubGVuZ3RoID8KCQkJJC5leHRlbmQuYXBwbHkoIG51bGwsIFsgdHJ1ZSwgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJLy8gcHJldmVudCBjYWxscyB0byBpbnRlcm5hbCBtZXRob2RzCgkJaWYgKCBpc01ldGhvZENhbGwgJiYgb3B0aW9ucy5jaGFyQXQoIDAgKSA9PT0gIl8iICkgewoJCQlyZXR1cm4gcmV0dXJuVmFsdWU7CgkJfQoKCQlpZiAoIGlzTWV0aG9kQ2FsbCApIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBuYW1lICk7CgkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQl0aHJvdyAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIjsKCQkJCX0KCQkJCWlmICggISQuaXNGdW5jdGlvbiggaW5zdGFuY2Vbb3B0aW9uc10gKSApIHsKCQkJCQl0aHJvdyAibm8gc3VjaCBtZXRob2QgJyIgKyBvcHRpb25zICsgIicgZm9yICIgKyBuYW1lICsgIiB3aWRnZXQgaW5zdGFuY2UiOwoJCQkJfQoJCQkJdmFyIG1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCQkJCWlmICggbWV0aG9kVmFsdWUgIT09IGluc3RhbmNlICYmIG1ldGhvZFZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgbmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIG5hbWUsIG5ldyBvYmplY3QoIG9wdGlvbnMsIHRoaXMgKSApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX07Cn07CgokLldpZGdldCA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCglpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7Cgl9Cn07CgokLldpZGdldC5wcm90b3R5cGUgPSB7Cgl3aWRnZXROYW1lOiAid2lkZ2V0IiwKCXdpZGdldEV2ZW50UHJlZml4OiAiIiwKCW9wdGlvbnM6IHsKCQlkaXNhYmxlZDogZmFsc2UKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyAkLndpZGdldC5icmlkZ2Ugc3RvcmVzIHRoZSBwbHVnaW4gaW5zdGFuY2UsIGJ1dCB3ZSBkbyBpdCBhbnl3YXkKCQkvLyBzbyB0aGF0IGl0J3Mgc3RvcmVkIGV2ZW4gYmVmb3JlIHRoZSBfY3JlYXRlIGZ1bmN0aW9uIHJ1bnMKCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0TmFtZSwgdGhpcyApOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCggdHJ1ZSwge30sCgkJCXRoaXMub3B0aW9ucywKCQkJdGhpcy5fZ2V0Q3JlYXRlT3B0aW9ucygpLAoJCQlvcHRpb25zICk7CgoJCXZhciBzZWxmID0gdGhpczsKCQl0aGlzLmVsZW1lbnQuYmluZCggInJlbW92ZS4iICsgdGhpcy53aWRnZXROYW1lLCBmdW5jdGlvbigpIHsKCQkJc2VsZi5kZXN0cm95KCk7CgkJfSk7CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiICk7CgkJdGhpcy5faW5pdCgpOwoJfSwKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHt9OwoJCWlmICggJC5tZXRhZGF0YSApIHsKCQkJb3B0aW9ucyA9ICQubWV0YWRhdGEuZ2V0KCBlbGVtZW50IClbIHRoaXMud2lkZ2V0TmFtZSBdOwoJCX0KCQlyZXR1cm4gb3B0aW9uczsKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHt9LAoJX2luaXQ6IGZ1bmN0aW9uKCkge30sCgoJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoICIuIiArIHRoaXMud2lkZ2V0TmFtZSApCgkJCS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldE5hbWUgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoICIuIiArIHRoaXMud2lkZ2V0TmFtZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKQoJCQkucmVtb3ZlQ2xhc3MoCgkJCQl0aGlzLndpZGdldEJhc2VDbGFzcyArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkvLyBkb24ndCByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGhhc2gKCQkJcmV0dXJuICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zICk7CgkJfQoKCQlpZiAgKHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgewoJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gdGhpcy5vcHRpb25zWyBrZXkgXTsKCQkJfQoJCQlvcHRpb25zID0ge307CgkJCW9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJJC5lYWNoKCBvcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJc2VsZi5fc2V0T3B0aW9uKCBrZXksIHZhbHVlICk7CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMud2lkZ2V0KCkKCQkJCVsgdmFsdWUgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIl0oCgkJCQkJdGhpcy53aWRnZXRCYXNlQ2xhc3MgKyAiLWRpc2FibGVkIiArICIgIiArCgkJCQkJInVpLXN0YXRlLWRpc2FibGVkIiApCgkJCQkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIGNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCQlpZiAoIGV2ZW50Lm9yaWdpbmFsRXZlbnQgKSB7CgkJCWZvciAoIHZhciBpID0gJC5ldmVudC5wcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQkJcHJvcCA9ICQuZXZlbnQucHJvcHNbIC0taSBdOwoJCQkJZXZlbnRbIHByb3AgXSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnRbIHByb3AgXTsKCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oY2FsbGJhY2spICYmCgkJCWNhbGxiYWNrLmNhbGwoIHRoaXMuZWxlbWVudFswXSwgZXZlbnQsIGRhdGEgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUud2lkZ2V0IiwgewoJLy8gZGVjb3JhdGUgdGhlIHBhcmVudCBfY3JlYXRlV2lkZ2V0IHRvIHRyaWdnZXIgYHdpZGdldGluaXRgIGZvciB1c2VycwoJLy8gd2hvIHdpc2ggdG8gZG8gcG9zdCBwb3N0IGB3aWRnZXRjcmVhdGVgIGFsdGVyYXRpb25zL2FkZGl0aW9ucwoJLy8KCS8vIFRPRE8gY3JlYXRlIGEgcHVsbCByZXF1ZXN0IGZvciBqcXVlcnkgdWkgdG8gdHJpZ2dlciB0aGlzIGV2ZW50CgkvLyBpbiB0aGUgb3JpZ2luYWwgX2NyZWF0ZVdpZGdldAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oKSB7CgkJJC5XaWRnZXQucHJvdG90eXBlLl9jcmVhdGVXaWRnZXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3RyaWdnZXIoICdpbml0JyApOwoJfSwKCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRpb25zID0ge307CgoJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbiggb3B0aW9uICkgewoKCQkJdmFyIHZhbHVlID0gZWxlbS5qcW1EYXRhKCBvcHRpb24ucmVwbGFjZSggL1tBLVpdL2csIGZ1bmN0aW9uKCBjICkgewoJCQkJCQkJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKCQkJCQkJfSkKCQkJCQkpOwoKCQkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oIHRhcmdldCwgdXNlS2VlcE5hdGl2ZSApIHsKCQl0aGlzLmVuaGFuY2UoICQoIHRoaXMub3B0aW9ucy5pbml0U2VsZWN0b3IsICQoIHRhcmdldCApKSwgdXNlS2VlcE5hdGl2ZSApOwoJfSwKCgllbmhhbmNlOiBmdW5jdGlvbiggdGFyZ2V0cywgdXNlS2VlcE5hdGl2ZSApIHsKCQl2YXIgcGFnZSwga2VlcE5hdGl2ZSwgJHdpZGdldEVsZW1lbnRzID0gJCggdGFyZ2V0cyApLCBzZWxmID0gdGhpczsKCgkJLy8gaWYgaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IHRvIHRydWUgdGhlIGZyYW1ld29yayBzaG91bGQKCQkvLyBvbmx5IGVuaGFuY2UgdGhlIHNlbGVjdGVkIGVsZW1lbnRzIHdoZW4gdGhleSBkbyBOT1QgaGF2ZSBhCgkJLy8gcGFyZW50IHdpdGggdGhlIGRhdGEtbmFtZXNwYWNlLWlnbm9yZSBhdHRyaWJ1dGUKCQkkd2lkZ2V0RWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggJHdpZGdldEVsZW1lbnRzICk7CgoJCWlmICggdXNlS2VlcE5hdGl2ZSAmJiAkd2lkZ2V0RWxlbWVudHMubGVuZ3RoICkgewoJCQkvLyBUT0RPIHJlbW92ZSBkZXBlbmRlbmN5IG9uIHRoZSBwYWdlIHdpZGdldCBmb3IgdGhlIGtlZXBOYXRpdmUuCgkJCS8vIEN1cnJlbnRseSB0aGUga2VlcE5hdGl2ZSB2YWx1ZSBpcyBkZWZpbmVkIG9uIHRoZSBwYWdlIHByb3RvdHlwZSBzbwoJCQkvLyB0aGUgbWV0aG9kIGlzIGFzIHdlbGwKCQkJcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJHdpZGdldEVsZW1lbnRzICk7CgkJCWtlZXBOYXRpdmUgPSAocGFnZSAmJiBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpKSB8fCAiIjsKCgkJCSR3aWRnZXRFbGVtZW50cyA9ICR3aWRnZXRFbGVtZW50cy5ub3QoIGtlZXBOYXRpdmUgKTsKCQl9CgoJCSR3aWRnZXRFbGVtZW50c1sgdGhpcy53aWRnZXROYW1lIF0oKTsKCX0sCgoJcmFpc2U6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgIldpZGdldCBbIiArIHRoaXMud2lkZ2V0TmFtZSArICJdOiAiICsgbXNnOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9OwoKCS8vIGpRdWVyeS5tb2JpbGUgY29uZmlndXJhYmxlIG9wdGlvbnMKCSQubW9iaWxlID0gJC5leHRlbmQoIHt9LCB7CgoJCS8vIFZlcnNpb24gb2YgdGhlIGpRdWVyeSBNb2JpbGUgRnJhbWV3b3JrCgkJdmVyc2lvbjogIjEuMS4wIiwKCgkJLy8gTmFtZXNwYWNlIHVzZWQgZnJhbWV3b3JrLXdpZGUgZm9yIGRhdGEtYXR0cnMuIERlZmF1bHQgaXMgbm8gbmFtZXNwYWNlCgkJbnM6ICIiLAoKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCS8vIENsYXNzIGFzc2lnbmVkIHRvIHBhZ2UgY3VycmVudGx5IGluIHZpZXcsIGFuZCBkdXJpbmcgdHJhbnNpdGlvbnMKCQlhY3RpdmVQYWdlQ2xhc3M6ICJ1aS1wYWdlLWFjdGl2ZSIsCgoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImZvY3VzIiBmb3JtIGVsZW1lbnQgc3RhdGUsIGZyb20gQ1NTIGZyYW1ld29yawoJCWZvY3VzQ2xhc3M6ICJ1aS1mb2N1cyIsCgoJCS8vIEF1dG9tYXRpY2FsbHkgaGFuZGxlIGNsaWNrcyBhbmQgZm9ybSBzdWJtaXNzaW9ucyB0aHJvdWdoIEFqYXgsIHdoZW4gc2FtZS1kb21haW4KCQlhamF4RW5hYmxlZDogdHJ1ZSwKCgkJLy8gQXV0b21hdGljYWxseSBsb2FkIGFuZCBzaG93IHBhZ2VzIGJhc2VkIG9uIGxvY2F0aW9uLmhhc2gKCQloYXNoTGlzdGVuaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gZGlzYWJsZSB0byBwcmV2ZW50IGpxdWVyeSBmcm9tIGJvdGhlcmluZyB3aXRoIGxpbmtzCgkJbGlua0JpbmRpbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBTZXQgZGVmYXVsdCBwYWdlIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdFBhZ2VUcmFuc2l0aW9uOiAiZmFkZSIsCgoJCS8vIFNldCBtYXhpbXVtIHdpbmRvdyB3aWR0aCBmb3IgdHJhbnNpdGlvbnMgdG8gYXBwbHkgLSAnZmFsc2UnIGZvciBubyBsaW1pdAoJCW1heFRyYW5zaXRpb25XaWR0aDogZmFsc2UsCgoJCS8vIE1pbmltdW0gc2Nyb2xsIGRpc3RhbmNlIHRoYXQgd2lsbCBiZSByZW1lbWJlcmVkIHdoZW4gcmV0dXJuaW5nIHRvIGEgcGFnZQoJCW1pblNjcm9sbEJhY2s6IDI1MCwKCgkJLy8gREVQUkVDQVRFRDogdGhlIGZvbGxvd2luZyBwcm9wZXJ0eSBpcyBubyBsb25nZXIgaW4gdXNlLCBidXQgZGVmaW5lZCB1bnRpbCAyLjAgdG8gcHJldmVudCBjb25mbGljdHMKCQl0b3VjaE92ZXJmbG93RW5hYmxlZDogZmFsc2UsCgoJCS8vIFNldCBkZWZhdWx0IGRpYWxvZyB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHREaWFsb2dUcmFuc2l0aW9uOiAicG9wIiwKCgkJLy8gU2hvdyBsb2FkaW5nIG1lc3NhZ2UgZHVyaW5nIEFqYXggcmVxdWVzdHMKCQkvLyBpZiBmYWxzZSwgbWVzc2FnZSB3aWxsIG5vdCBhcHBlYXIsIGJ1dCBsb2FkaW5nIGNsYXNzZXMgd2lsbCBzdGlsbCBiZSB0b2dnbGVkIG9uIGh0bWwgZWwKCQlsb2FkaW5nTWVzc2FnZTogImxvYWRpbmciLAoKCQkvLyBFcnJvciByZXNwb25zZSBtZXNzYWdlIC0gYXBwZWFycyB3aGVuIGFuIEFqYXggcGFnZSByZXF1ZXN0IGZhaWxzCgkJcGFnZUxvYWRFcnJvck1lc3NhZ2U6ICJFcnJvciBMb2FkaW5nIFBhZ2UiLAoKCQkvLyBTaG91bGQgdGhlIHRleHQgYmUgdmlzYmxlIGluIHRoZSBsb2FkaW5nIG1lc3NhZ2U/CgkJbG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTogZmFsc2UsCgoJCS8vIFdoZW4gdGhlIHRleHQgaXMgdmlzaWJsZSwgd2hhdCB0aGVtZSBkb2VzIHRoZSBsb2FkaW5nIGJveCB1c2U/CgkJbG9hZGluZ01lc3NhZ2VUaGVtZTogImEiLAoKCQkvLyBGb3IgZXJyb3IgbWVzc2FnZXMsIHdoaWNoIHRoZW1lIGRvZXMgdGhlIGJveCB1c2VzPwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWU6ICJlIiwKCgkJLy9hdXRvbWF0aWNhbGx5IGluaXRpYWxpemUgdGhlIERPTSB3aGVuIGl0J3MgcmVhZHkKCQlhdXRvSW5pdGlhbGl6ZVBhZ2U6IHRydWUsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGFsbG93cyB1c2VycyB0byBvcHQgaW4gdG8gaWdub3JpbmcgY29udGVudCBieSBtYXJraW5nIGEgcGFyZW50IGVsZW1lbnQgYXMKCQkvLyBkYXRhLWlnbm9yZWQKCQlpZ25vcmVDb250ZW50RW5hYmxlZDogZmFsc2UsCgoJCS8vIHR1cm4gb2YgYmluZGluZyB0byB0aGUgbmF0aXZlIG9yaWVudGF0aW9uY2hhbmdlIGR1ZSB0byBhbmRyb2lkIG9yaWVudGF0aW9uIGJlaGF2aW9yCgkJb3JpZW50YXRpb25DaGFuZ2VFbmFibGVkOiB0cnVlLAoKCQlidXR0b25NYXJrdXA6IHsKCQkJaG92ZXJEZWxheTogMjAwCgkJfSwKCgkJLy8gVE9ETyBtaWdodCBiZSB1c2VmdWwgdXBzdHJlYW0gaW4ganF1ZXJ5IGl0c2VsZiA/CgkJa2V5Q29kZTogewoJCQlBTFQ6IDE4LAoJCQlCQUNLU1BBQ0U6IDgsCgkJCUNBUFNfTE9DSzogMjAsCgkJCUNPTU1BOiAxODgsCgkJCUNPTU1BTkQ6IDkxLAoJCQlDT01NQU5EX0xFRlQ6IDkxLCAvLyBDT01NQU5ECgkJCUNPTU1BTkRfUklHSFQ6IDkzLAoJCQlDT05UUk9MOiAxNywKCQkJREVMRVRFOiA0NiwKCQkJRE9XTjogNDAsCgkJCUVORDogMzUsCgkJCUVOVEVSOiAxMywKCQkJRVNDQVBFOiAyNywKCQkJSE9NRTogMzYsCgkJCUlOU0VSVDogNDUsCgkJCUxFRlQ6IDM3LAoJCQlNRU5VOiA5MywgLy8gQ09NTUFORF9SSUdIVAoJCQlOVU1QQURfQUREOiAxMDcsCgkJCU5VTVBBRF9ERUNJTUFMOiAxMTAsCgkJCU5VTVBBRF9ESVZJREU6IDExMSwKCQkJTlVNUEFEX0VOVEVSOiAxMDgsCgkJCU5VTVBBRF9NVUxUSVBMWTogMTA2LAoJCQlOVU1QQURfU1VCVFJBQ1Q6IDEwOSwKCQkJUEFHRV9ET1dOOiAzNCwKCQkJUEFHRV9VUDogMzMsCgkJCVBFUklPRDogMTkwLAoJCQlSSUdIVDogMzksCgkJCVNISUZUOiAxNiwKCQkJU1BBQ0U6IDMyLAoJCQlUQUI6IDksCgkJCVVQOiAzOCwKCQkJV0lORE9XUzogOTEgLy8gQ09NTUFORAoJCX0sCgoJCS8vIFNjcm9sbCBwYWdlIHZlcnRpY2FsbHk6IHNjcm9sbCB0byAwIHRvIGhpZGUgaU9TIGFkZHJlc3MgYmFyLCBvciBwYXNzIGEgWSB2YWx1ZQoJCXNpbGVudFNjcm9sbDogZnVuY3Rpb24oIHlwb3MgKSB7CgkJCWlmICggJC50eXBlKCB5cG9zICkgIT09ICJudW1iZXIiICkgewoJCQkJeXBvcyA9ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCQl9CgoJCQkvLyBwcmV2ZW50IHNjcm9sbHN0YXJ0IGFuZCBzY3JvbGxzdG9wIGV2ZW50cwoJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgeXBvcyApOwoJCQkJJCggZG9jdW1lbnQgKS50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJaWYgKCAhcHJvcCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8ICggbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gPSAkLmNhbWVsQ2FzZSggJC5tb2JpbGUubnMgKyBwcm9wICkgKTsKCQl9LAoKCQlnZXRJbmhlcml0ZWRUaGVtZTogZnVuY3Rpb24oIGVsLCBkZWZhdWx0VGhlbWUgKSB7CgoJCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCQkvLyB3ZSBhcmUgbm90IHVzaW5nICQuZm4uY2xvc2VzdCgpIG9uIHB1cnBvc2UgaGVyZSBiZWNhdXNlIHRoaXMKCQkJLy8gbWV0aG9kIGdldHMgY2FsbGVkIHF1aXRlIGEgYml0IGFuZCB3ZSBuZWVkIGl0IHRvIGJlIGFzIGZhc3QKCQkJLy8gYXMgcG9zc2libGUuCgoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCgkJCXdoaWxlICggZSApIHsKCQkJCXZhciBjID0gZS5jbGFzc05hbWUgfHwgIiI7CgkJCQlpZiAoICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCX0KCgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoKCQkJcmV0dXJuIGx0ciB8fCBkZWZhdWx0VGhlbWUgfHwgImEiOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZvbGxvd2luZyAkIGFuZCAkLmZuIGV4dGVuc2lvbnMgY2FuL3Byb2JhYmx5IHNob3VsZCBiZSBtb3ZlZCBpbnRvIGpxdWVyeS5tb2JpbGUuY29yZS5oZWxwZXJzCgkJLy8KCQkvLyBGaW5kIHRoZSBjbG9zZXN0IGphdmFzY3JpcHQgcGFnZSBlbGVtZW50IHRvIGdhdGhlciBzZXR0aW5ncyBkYXRhIGpzcGVyZiB0ZXN0CgkJLy8gaHR0cDovL2pzcGVyZi5jb20vc2luZ2xlLWNvbXBsZXgtc2VsZWN0b3ItdnMtbWFueS1jb21wbGV4LXNlbGVjdG9ycy9lZGl0CgkJLy8gcG9zc2libHkgbmFpdmUsIGJ1dCBpdCBzaG93cyB0aGF0IHRoZSBwYXJzaW5nIG92ZXJoZWFkIGZvciAqanVzdCogdGhlIHBhZ2Ugc2VsZWN0b3IgdnMKCQkvLyB0aGUgcGFnZSBhbmQgZGlhbG9nIHNlbGVjdG9yIGlzIG5lZ2xpZ2FibGUuIFRoaXMgY291bGQgcHJvYmFibHkgYmUgc3BlZWQgdXAgYnkKCQkvLyBkb2luZyBhIHNpbWlsYXIgcGFyZW50IG5vZGUgdHJhdmVyc2FsIHRvIHRoZSBvbmUgZm91bmQgaW4gdGhlIGluaGVyaXRlZCB0aGVtZSBjb2RlIGFib3ZlCgkJY2xvc2VzdFBhZ2VEYXRhOiBmdW5jdGlvbiggJHRhcmdldCApIHsKCQkJcmV0dXJuICR0YXJnZXQKCQkJCS5jbG9zZXN0KCc6anFtRGF0YShyb2xlPSJwYWdlIiksIDpqcW1EYXRhKHJvbGU9ImRpYWxvZyIpJykKCQkJCS5kYXRhKCJwYWdlIik7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCAkc2V0ICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggJHNldCwgImVuaGFuY2UiICk7CgkJfSwKCgkJaGlqYWNrYWJsZTogZnVuY3Rpb24oICRzZXQgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCAkc2V0LCAiYWpheCIgKTsKCQl9LAoKCQloYXZlUGFyZW50czogZnVuY3Rpb24oICRzZXQsIGF0dHIgKSB7CgkJCWlmKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKXsKCQkJCXJldHVybiAkc2V0OwoJCQl9CgoJCQl2YXIgY291bnQgPSAkc2V0Lmxlbmd0aCwKCQkJCSRuZXdTZXQgPSAkKCksCgkJCQllLCAkZWxlbWVudCwgZXhjbHVkZWQ7CgoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBjb3VudDsgaSsrICkgewoJCQkJJGVsZW1lbnQgPSAkc2V0LmVxKCBpICk7CgkJCQlleGNsdWRlZCA9IGZhbHNlOwoJCQkJZSA9ICRzZXRbIGkgXTsKCgkJCQl3aGlsZSAoIGUgKSB7CgkJCQkJdmFyIGMgPSBlLmdldEF0dHJpYnV0ZSA/IGUuZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBhdHRyICkgOiAiIjsKCgkJCQkJaWYgKCBjID09PSAiZmFsc2UiICkgewoJCQkJCQlleGNsdWRlZCA9IHRydWU7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCgkJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJCX0KCgkJCQlpZiAoICFleGNsdWRlZCApIHsKCQkJCQkkbmV3U2V0ID0gJG5ld1NldC5hZGQoICRlbGVtZW50ICk7CgkJCQl9CgkJCX0KCgkJCXJldHVybiAkbmV3U2V0OwoJCX0KCX0sICQubW9iaWxlICk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPSAidW5kZWZpbmVkIiApIHsKCQkJaWYgKCBwcm9wICkgewoJCQkJcHJvcCA9ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICk7CgkJCX0KCQkJcmVzdWx0ID0gdGhpcy5kYXRhLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMubGVuZ3RoIDwgMiA/IFsgcHJvcCBdIDogWyBwcm9wLCB2YWx1ZSBdICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuanFtRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5mbi5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCkgewoJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCX07CgoJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKTsKCgkJKCAkZWxlbS5qcW1EYXRhKCdkZXBlbmRlbnRzJykgfHwgJCgpICkucmVtb3ZlKCk7CgkJJGVsZW0ucmVtb3ZlKCk7Cgl9OwoKCSQuZm4uYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuZXdEZXBlbmRlbnRzICkgewoJCSQuYWRkRGVwZW5kZW50cyggJCh0aGlzKSwgbmV3RGVwZW5kZW50cyApOwoJfTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgZGVwZW5kZW50cyA9ICQoZWxlbSkuanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpOwoKCQkkKGVsZW0pLmpxbURhdGEoICdkZXBlbmRlbnRzJywgJC5tZXJnZShkZXBlbmRlbnRzLCBuZXdEZXBlbmRlbnRzKSApOwoJfTsKCgkvLyBub3RlIHRoYXQgdGhpcyBoZWxwZXIgZG9lc24ndCBhdHRlbXB0IHRvIGhhbmRsZSB0aGUgY2FsbGJhY2sKCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50cyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkvLyB0byByZXR1cm4gdGhlIGh0bWwgZW5jb2RlZCB2ZXJzaW9uIG9mIHRoZSB0ZXh0IGluIGFsbCBjYXNlcy4gKHRodXMgdGhlIG5hbWUpCgkkLmZuLmdldEVuY29kZWRUZXh0ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICkudGV4dCggJCh0aGlzKS50ZXh0KCkgKS5odG1sKCk7Cgl9OwoKCS8vIGZsdWVudCBoZWxwZXIgZnVuY3Rpb24gZm9yIHRoZSBtb2JpbGUgbmFtZXNwYWNlZCBlcXVpdmFsZW50CgkkLmZuLmpxbUVuaGFuY2VhYmxlID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmVuaGFuY2VhYmxlKCB0aGlzICk7Cgl9OwoKCSQuZm4uanFtSGlqYWNrYWJsZSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5oaWphY2thYmxlKCB0aGlzICk7Cgl9OwoKCS8vIE1vbmtleS1wYXRjaGluZyBTaXp6bGUgdG8gZmlsdGVyIHRoZSA6anFtRGF0YSBzZWxlY3RvcgoJdmFyIG9sZEZpbmQgPSAkLmZpbmQsCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCgkJcmV0dXJuIG9sZEZpbmQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKTsKCX07CgoJJC5leHRlbmQoICQuZmluZCwgb2xkRmluZCApOwoKCSQuZmluZC5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIHNldCApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBzZXQgKTsKCX07CgoJJC5maW5kLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBub2RlLCBleHByICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIFsgbm9kZSBdICkubGVuZ3RoID4gMDsKCX07Cn0pKCBqUXVlcnksIHRoaXMgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciAkd2luZG93ID0gJCggd2luZG93ICksCgkkaHRtbCA9ICQoICJodG1sIiApOwoKLyogJC5tb2JpbGUubWVkaWEgbWV0aG9kOiBwYXNzIGEgQ1NTIG1lZGlhIHR5cGUgb3IgcXVlcnkgYW5kIGdldCBhIGJvb2wgcmV0dXJuCglub3RlOiB0aGlzIGZlYXR1cmUgcmVsaWVzIG9uIGFjdHVhbCBtZWRpYSBxdWVyeSBzdXBwb3J0IGZvciBtZWRpYSBxdWVyaWVzLCB0aG91Z2ggdHlwZXMgd2lsbCB3b3JrIG1vc3QgYW55d2hlcmUKCWV4YW1wbGVzOgoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4nKSAvLyB0ZXN0cyBmb3Igc2NyZWVuIG1lZGlhIHR5cGUKCQkkLm1vYmlsZS5tZWRpYSgnc2NyZWVuIGFuZCAobWluLXdpZHRoOiA0ODBweCknKSAvLyB0ZXN0cyBmb3Igc2NyZWVuIG1lZGlhIHR5cGUgd2l0aCB3aW5kb3cgd2lkdGggPiA0ODBweAoJCSQubW9iaWxlLm1lZGlhKCdAbWVkaWEgc2NyZWVuIGFuZCAoLXdlYmtpdC1taW4tZGV2aWNlLXBpeGVsLXJhdGlvOiAyKScpIC8vIHRlc3RzIGZvciB3ZWJraXQgMnggcGl4ZWwgcmF0aW8gKGlQaG9uZSA0KQoqLwokLm1vYmlsZS5tZWRpYSA9IChmdW5jdGlvbigpIHsKCS8vIFRPRE86IHVzZSB3aW5kb3cubWF0Y2hNZWRpYSBvbmNlIGF0IGxlYXN0IG9uZSBVQSBpbXBsZW1lbnRzIGl0Cgl2YXIgY2FjaGUgPSB7fSwKCQl0ZXN0RGl2ID0gJCggIjxkaXYgaWQ9J2pxdWVyeS1tZWRpYXRlc3QnPiIgKSwKCQlmYWtlQm9keSA9ICQoICI8Ym9keT4iICkuYXBwZW5kKCB0ZXN0RGl2ICk7CgoJcmV0dXJuIGZ1bmN0aW9uKCBxdWVyeSApIHsKCQlpZiAoICEoIHF1ZXJ5IGluIGNhY2hlICkgKSB7CgkJCXZhciBzdHlsZUJsb2NrID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInN0eWxlIiApLAoJCQkJY3NzcnVsZSA9ICJAbWVkaWEgIiArIHF1ZXJ5ICsgIiB7ICNqcXVlcnktbWVkaWF0ZXN0IHsgcG9zaXRpb246YWJzb2x1dGU7IH0gfSI7CgoJCQkvL211c3Qgc2V0IHR5cGUgZm9yIElFIQoJCQlzdHlsZUJsb2NrLnR5cGUgPSAidGV4dC9jc3MiOwoKCQkJaWYgKCBzdHlsZUJsb2NrLnN0eWxlU2hlZXQgICl7CgkJCQlzdHlsZUJsb2NrLnN0eWxlU2hlZXQuY3NzVGV4dCA9IGNzc3J1bGU7CgkJCX0gZWxzZSB7CgkJCQlzdHlsZUJsb2NrLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjc3NydWxlKSApOwoJCQl9CgoJCQkkaHRtbC5wcmVwZW5kKCBmYWtlQm9keSApLnByZXBlbmQoIHN0eWxlQmxvY2sgKTsKCQkJY2FjaGVbIHF1ZXJ5IF0gPSB0ZXN0RGl2LmNzcyggInBvc2l0aW9uIiApID09PSAiYWJzb2x1dGUiOwoJCQlmYWtlQm9keS5hZGQoIHN0eWxlQmxvY2sgKS5yZW1vdmUoKTsKCQl9CgkJcmV0dXJuIGNhY2hlWyBxdWVyeSBdOwoJfTsKfSkoKTsKCn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBmYWtlQm9keSA9ICQoICI8Ym9keT4iICkucHJlcGVuZFRvKCAiaHRtbCIgKSwKCWZiQ1NTID0gZmFrZUJvZHlbIDAgXS5zdHlsZSwKCXZlbmRvcnMgPSBbICJXZWJraXQiLCAiTW96IiwgIk8iIF0sCgl3ZWJvcyA9ICJwYWxtR2V0UmVzb3VyY2UiIGluIHdpbmRvdywgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgc2Nyb2xsVG9wCglvcGVyYW1pbmkgPSB3aW5kb3cub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggd2luZG93Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiwKCWJiID0gd2luZG93LmJsYWNrYmVycnk7IC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IGJveCBzaGFkb3csIGFzIGl0J3MgZmlsbGVkIG9wYXF1ZSBvbiBCQgoKLy8gdGh4IE1vZGVybml6cgpmdW5jdGlvbiBwcm9wRXhpc3RzKCBwcm9wICkgewoJdmFyIHVjX3Byb3AgPSBwcm9wLmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnN1YnN0ciggMSApLAoJCXByb3BzID0gKCBwcm9wICsgIiAiICsgdmVuZG9ycy5qb2luKCB1Y19wcm9wICsgIiAiICkgKyB1Y19wcm9wICkuc3BsaXQoICIgIiApOwoKCWZvciAoIHZhciB2IGluIHByb3BzICl7CgkJaWYgKCBmYkNTU1sgcHJvcHNbIHYgXSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KfQoKZnVuY3Rpb24gdmFsaWRTdHlsZSggcHJvcCwgdmFsdWUsIGNoZWNrX3ZlbmQgKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksCgkJdWMgPSBmdW5jdGlvbiggdHh0ICkgewoJCQlyZXR1cm4gdHh0LmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyB0eHQuc3Vic3RyKCAxICkKCQl9LAoJCXZlbmRfcHJlZiA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJfSwKCQljaGVja19zdHlsZSA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQl2YXIgdmVuZF9wcm9wID0gdmVuZF9wcmVmKCB2ZW5kICkgKyBwcm9wICsgIjogIiArIHZhbHVlICsgIjsiLAoJCQkJdWNfdmVuZCA9IHVjKCB2ZW5kICksCgkJCQlwcm9wU3R5bGUgPSB1Y192ZW5kICsgdWMoIHByb3AgKTsKCQkKCQkJZGl2LnNldEF0dHJpYnV0ZSggInN0eWxlIiwgdmVuZF9wcm9wICk7CgkJCgkJCWlmKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBbIGNoZWNrX3ZlbmQgXSA6IHZlbmRvcnMsCgkJcmV0OwoKCWZvciggaSA9IDA7IGkgPCBjaGVja192ZW5kcy5sZW5ndGg7IGkrKyApIHsKCQljaGVja19zdHlsZSggY2hlY2tfdmVuZHNbaV0gKTsKCX0KCXJldHVybiAhIXJldDsKfQoKLy8gVGhhbmtzIHRvIE1vZGVybml6ciBzcmMgZm9yIHRoaXMgdGVzdCBpZGVhLiBgcGVyc3BlY3RpdmVgIGNoZWNrIGlzIGxpbWl0ZWQgdG8gTW96IHRvIHByZXZlbnQgYSBmYWxzZSBwb3NpdGl2ZSBmb3IgM0QgdHJhbnNmb3JtcyBvbiBBbmRyb2lkLgpmdW5jdGlvbiB0cmFuc2Zvcm0zZFRlc3QoKSB7Cgl2YXIgcHJvcCA9ICJ0cmFuc2Zvcm0tM2QiOwoJcmV0dXJuIHZhbGlkU3R5bGUoICdwZXJzcGVjdGl2ZScsICcxMHB4JywgJ21veicgKSB8fCAkLm1vYmlsZS5tZWRpYSggIigtIiArIHZlbmRvcnMuam9pbiggIi0iICsgcHJvcCArICIpLCgtIiApICsgIi0iICsgcHJvcCArICIpLCgiICsgcHJvcCArICIpIiApOwp9CgovLyBUZXN0IGZvciBkeW5hbWljLXVwZGF0aW5nIGJhc2UgdGFnIHN1cHBvcnQgKCBhbGxvd3MgdXMgdG8gYXZvaWQgaHJlZixzcmMgYXR0ciByZXdyaXRpbmcgKQpmdW5jdGlvbiBiYXNlVGFnVGVzdCgpIHsKCXZhciBmYXV4QmFzZSA9IGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSArICJ1aS1kaXIvIiwKCQliYXNlID0gJCggImhlYWQgYmFzZSIgKSwKCQlmYXV4RWxlID0gbnVsbCwKCQlocmVmID0gIiIsCgkJbGluaywgcmViYXNlOwoKCWlmICggIWJhc2UubGVuZ3RoICkgewoJCWJhc2UgPSBmYXV4RWxlID0gJCggIjxiYXNlPiIsIHsgImhyZWYiOiBmYXV4QmFzZSB9KS5hcHBlbmRUbyggImhlYWQiICk7Cgl9IGVsc2UgewoJCWhyZWYgPSBiYXNlLmF0dHIoICJocmVmIiApOwoJfQoKCWxpbmsgPSAkKCAiPGEgaHJlZj0ndGVzdHVybCcgLz4iICkucHJlcGVuZFRvKCBmYWtlQm9keSApOwoJcmViYXNlID0gbGlua1sgMCBdLmhyZWY7CgliYXNlWyAwIF0uaHJlZiA9IGhyZWYgfHwgbG9jYXRpb24ucGF0aG5hbWU7CgoJaWYgKCBmYXV4RWxlICkgewoJCWZhdXhFbGUucmVtb3ZlKCk7Cgl9CglyZXR1cm4gcmViYXNlLmluZGV4T2YoIGZhdXhCYXNlICkgPT09IDA7Cn0KCgovLyBub24tVUEtYmFzZWQgSUUgdmVyc2lvbiBjaGVjayBieSBKYW1lcyBQYWRvbHNleSwgbW9kaWZpZWQgYnkgamRhbHRvbiAtIGZyb20gaHR0cDovL2dpc3QuZ2l0aHViLmNvbS81Mjc2ODMKLy8gYWxsb3dzIGZvciBpbmNsdXNpb24gb2YgSUUgNissIGluY2x1ZGluZyBXaW5kb3dzIE1vYmlsZSA3CiQuZXh0ZW5kKCAkLm1vYmlsZSwgeyBicm93c2VyOiB7fSB9ICk7CiQubW9iaWxlLmJyb3dzZXIuaWUgPSAoZnVuY3Rpb24oKSB7Cgl2YXIgdiA9IDMsCglkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJYSA9IGRpdi5hbGwgfHwgW107CgoJLy8gYWRkZWQge30gdG8gc2lsZW5jZSBjbG9zdXJlIGNvbXBpbGVyIHdhcm5pbmdzLiByZWdpc3RlcmluZyBteSBkaXNsaWtlIG9mIGFsbCB0aGluZ3MKCS8vIG92ZXJseSBjbGV2ZXIgaGVyZSBmb3IgZnV0dXJlIHJlZmVyZW5jZQoJd2hpbGUgKCBkaXYuaW5uZXJIVE1MID0gIjwhLS1baWYgZ3QgSUUgIiArICggKyt2ICkgKyAiXT48YnI+PCFbZW5kaWZdLS0+IiwgYVsgMCBdICl7fTsKCglyZXR1cm4gdiA+IDQgPyB2IDogIXY7Cn0pKCk7CgoKJC5leHRlbmQoICQuc3VwcG9ydCwgewoJb3JpZW50YXRpb246ICJvcmllbnRhdGlvbiIgaW4gd2luZG93ICYmICJvbm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3csCgl0b3VjaDogIm9udG91Y2hlbmQiIGluIGRvY3VtZW50LAoJY3NzVHJhbnNpdGlvbnM6ICJXZWJLaXRUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdyB8fCB2YWxpZFN0eWxlKCAndHJhbnNpdGlvbicsICdoZWlnaHQgMTAwbXMgbGluZWFyJyApLAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmICJyZXBsYWNlU3RhdGUiIGluIGhpc3RvcnksCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJYm94U2hhZG93OiAhIXByb3BFeGlzdHMoICJib3hTaGFkb3ciICkgJiYgIWJiLAoJc2Nyb2xsVG9wOiAoICJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8ICJzY3JvbGxUb3AiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fCAic2Nyb2xsVG9wIiBpbiBmYWtlQm9keVsgMCBdICkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCglkeW5hbWljQmFzZVRhZzogYmFzZVRhZ1Rlc3QoKQp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKdmFyIG5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCl7CgoJdmFyIHVhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7CgoJLy9UaGUgZm9sbG93aW5nIGlzIGFuIGF0dGVtcHQgdG8gbWF0Y2ggTm9raWEgYnJvd3NlcnMgdGhhdCBhcmUgcnVubmluZyBTeW1iaWFuL3M2MCwgd2l0aCB3ZWJraXQsIHZlcnNpb24gNy4zIG9yIG9sZGVyCglyZXR1cm4gdWEuaW5kZXhPZiggIk5va2lhIiApID4gLTEgJiYKCQkJKCB1YS5pbmRleE9mKCAiU3ltYmlhbi8zIiApID4gLTEgfHwgdWEuaW5kZXhPZiggIlNlcmllczYwLzUiICkgPiAtMSApICYmCgkJCXVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICYmCgkJCXVhLm1hdGNoKCAvKEJyb3dzZXJOR3xOb2tpYUJyb3dzZXIpXC83XC5bMC0zXS8gKTsKfSkoKTsKCi8vIFN1cHBvcnQgY29uZGl0aW9ucyB0aGF0IG11c3QgYmUgbWV0IGluIG9yZGVyIHRvIHByb2NlZWQKLy8gZGVmYXVsdCBlbmhhbmNlZCBxdWFsaWZpY2F0aW9ucyBhcmUgbWVkaWEgcXVlcnkgc3VwcG9ydCBPUiBJRSA3KwokLm1vYmlsZS5ncmFkZUEgPSBmdW5jdGlvbigpewoJcmV0dXJuICQuc3VwcG9ydC5tZWRpYXF1ZXJ5IHx8ICQubW9iaWxlLmJyb3dzZXIuaWUgJiYgJC5tb2JpbGUuYnJvd3Nlci5pZSA+PSA3Owp9OwoKJC5tb2JpbGUuYWpheEJsYWNrbGlzdCA9CgkJCS8vIEJsYWNrQmVycnkgYnJvd3NlcnMsIHByZS13ZWJraXQKCQkJd2luZG93LmJsYWNrYmVycnkgJiYgIXdpbmRvdy5XZWJLaXRQb2ludCB8fAoJCQkvLyBPcGVyYSBNaW5pCgkJCW9wZXJhbWluaSB8fAoJCQkvLyBTeW1iaWFuIHdlYmtpdHMgcHJlIDcuMwoJCQlub2tpYUxURTdfMzsKCi8vIExhc3RseSwgdGhpcyB3b3JrYXJvdW5kIGlzIHRoZSBvbmx5IHdheSB3ZSd2ZSBmb3VuZCBzbyBmYXIgdG8gZ2V0IHByZSA3LjMgU3ltYmlhbiB3ZWJraXQgZGV2aWNlcwovLyB0byByZW5kZXIgdGhlIHN0eWxlc2hlZXRzIHdoZW4gdGhleSdyZSByZWZlcmVuY2VkIGJlZm9yZSB0aGlzIHNjcmlwdCwgYXMgd2UnZCByZWNvbW1lbmQgZG9pbmcuCi8vIFRoaXMgc2ltcGx5IHJlYXBwZW5kcyB0aGUgQ1NTIGluIHBsYWNlLCB3aGljaCBmb3Igc29tZSByZWFzb24gbWFrZXMgaXQgYXBwbHkKaWYgKCBub2tpYUxURTdfMyApIHsKCSQoZnVuY3Rpb24oKSB7CgkJJCggImhlYWQgbGlua1tyZWw9J3N0eWxlc2hlZXQnXSIgKS5hdHRyKCAicmVsIiwgImFsdGVybmF0ZSBzdHlsZXNoZWV0IiApLmF0dHIoICJyZWwiLCAic3R5bGVzaGVldCIgKTsKCX0pOwp9CgovLyBGb3IgcnVsaW5nIG91dCBzaGFkb3dzIHZpYSBjc3MKaWYgKCAhJC5zdXBwb3J0LmJveFNoYWRvdyApIHsKCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbW9iaWxlLW5vc3VwcG9ydC1ib3hzaGFkb3ciICk7Cn0KCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBhZGQgbmV3IGV2ZW50IHNob3J0Y3V0cwokLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kIG9yaWVudGF0aW9uY2hhbmdlIHRocm90dGxlZHJlc2l6ZSAiICsKCQkJCQkidGFwIHRhcGhvbGQgc3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgc2Nyb2xsc3RhcnQgc2Nyb2xsc3RvcCIgKS5zcGxpdCggIiAiICksIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoKCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCX07CgoJJC5hdHRyRm5bIG5hbWUgXSA9IHRydWU7Cn0pOwoKdmFyIHN1cHBvcnRUb3VjaCA9ICQuc3VwcG9ydC50b3VjaCwKCXNjcm9sbEV2ZW50ID0gInRvdWNobW92ZSBzY3JvbGwiLAoJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgl0b3VjaFN0b3BFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaGVuZCIgOiAibW91c2V1cCIsCgl0b3VjaE1vdmVFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaG1vdmUiIDogIm1vdXNlbW92ZSI7CgpmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCXZhciBvcmlnaW5hbFR5cGUgPSBldmVudC50eXBlOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCSQuZXZlbnQuaGFuZGxlLmNhbGwoIG9iaiwgZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cn0KCi8vIGFsc28gaGFuZGxlcyBzY3JvbGxzdG9wCiQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgllbmFibGVkOiB0cnVlLAoKCXNldHVwOiBmdW5jdGlvbigpIHsKCgkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJc2Nyb2xsaW5nLAoJCQl0aW1lcjsKCgkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQlzY3JvbGxpbmcgPSBzdGF0ZTsKCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBzY3JvbGxpbmcgPyAic2Nyb2xsc3RhcnQiIDogInNjcm9sbHN0b3AiLCBldmVudCApOwoJCX0KCgkJLy8gaVBob25lIHRyaWdnZXJzIHNjcm9sbCBhZnRlciBhIHNtYWxsIGRlbGF5OyB1c2UgdG91Y2htb3ZlIGluc3RlYWQKCQkkdGhpcy5iaW5kKCBzY3JvbGxFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCXRyaWdnZXIoIGV2ZW50LCB0cnVlICk7CgkJCX0KCgkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCX0sIDUwICk7CgkJfSk7Cgl9Cn07CgovLyBhbHNvIGhhbmRsZXMgdGFwaG9sZAokLmV2ZW50LnNwZWNpYWwudGFwID0gewoJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJaWYgKCBldmVudC53aGljaCAmJiBldmVudC53aGljaCAhPT0gMSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIG9yaWdUYXJnZXQgPSBldmVudC50YXJnZXQsCgkJCQlvcmlnRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50LAoJCQkJdGltZXI7CgoJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQl9CgoJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJY2xlYXJUYXBUaW1lcigpOwoKCQkJCSR0aGlzLnVuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApCgkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJJCggZG9jdW1lbnQgKS51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCX0KCgkJCWZ1bmN0aW9uIGNsaWNrSGFuZGxlcihldmVudCkgewoJCQkJY2xlYXJUYXBIYW5kbGVycygpOwoKCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCS8vIHRoZSBzYW1lIGFzIHRoZSBzdG9wIHRhcmdldC4KCQkJCWlmICggb3JpZ1RhcmdldCA9PSBldmVudC50YXJnZXQgKSB7CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCX0KCQkJfQoKCQkJJHRoaXMuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApCgkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQl0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwaG9sZCIsICQuRXZlbnQoICJ0YXBob2xkIiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQgfSApICk7CgkJCX0sIDc1MCApOwoJCX0pOwoJfQp9OwoKLy8gYWxzbyBoYW5kbGVzIHN3aXBlbGVmdCwgc3dpcGVyaWdodAokLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CglzY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkOiAxMCwgLy8gTW9yZSB0aGFuIHRoaXMgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQsIGFuZCB3ZSB3aWxsIHN1cHByZXNzIHNjcm9sbGluZy4KCglkdXJhdGlvblRocmVzaG9sZDogMTAwMCwgLy8gTW9yZSB0aW1lIHRoYW4gdGhpcywgYW5kIGl0IGlzbid0IGEgc3dpcGUuCgoJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJdmVydGljYWxEaXN0YW5jZVRocmVzaG9sZDogNzUsICAvLyBTd2lwZSB2ZXJ0aWNhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBsZXNzIHRoYW4gdGhpcy4KCglzZXR1cDogZnVuY3Rpb24oKSB7CgkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJJHRoaXMuYmluZCggdG91Y2hTdGFydEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50LAoJCQkJc3RhcnQgPSB7CgkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJb3JpZ2luOiAkKCBldmVudC50YXJnZXQgKQoJCQkJfSwKCQkJCXN0b3A7CgoJCQlmdW5jdGlvbiBtb3ZlSGFuZGxlciggZXZlbnQgKSB7CgoJCQkJaWYgKCAhc3RhcnQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudDsKCgkJCQlzdG9wID0gewoJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdCgkJCQl9OwoKCQkJCS8vIHByZXZlbnQgc2Nyb2xsaW5nCgkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCgkJCSR0aGlzLmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApCgkJCQkub25lKCB0b3VjaFN0b3BFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgoJCQkJCWlmICggc3RhcnQgJiYgc3RvcCApIHsKCQkJCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQkJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZCAmJgoJCQkJCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDEgXSAtIHN0b3AuY29vcmRzWyAxIF0gKSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS52ZXJ0aWNhbERpc3RhbmNlVGhyZXNob2xkICkgewoKCQkJCQkJCXN0YXJ0Lm9yaWdpbi50cmlnZ2VyKCAic3dpcGUiICkKCQkJCQkJCQkudHJpZ2dlciggc3RhcnQuY29vcmRzWzBdID4gc3RvcC5jb29yZHNbIDAgXSA/ICJzd2lwZWxlZnQiIDogInN3aXBlcmlnaHQiICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJc3RhcnQgPSBzdG9wID0gdW5kZWZpbmVkOwoJCQkJfSk7CgkJfSk7Cgl9Cn07CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCS8vICJDb3dib3kiIEJlbiBBbG1hbgoKCXZhciB3aW4gPSAkKCB3aW5kb3cgKSwKCQlzcGVjaWFsX2V2ZW50LAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfTsKCgkvLyBJdCBzZWVtcyB0aGF0IHNvbWUgZGV2aWNlL2Jyb3dzZXIgdmVuZG9ycyB1c2Ugd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlcyAwIGFuZCAxODAgdG8KCS8vIGRlbm90ZSB0aGUgImRlZmF1bHQiIG9yaWVudGF0aW9uLiBGb3IgaU9TIGRldmljZXMsIGFuZCBtb3N0IG90aGVyIHNtYXJ0LXBob25lcyB0ZXN0ZWQsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyBhbHdheXMgInBvcnRyYWl0IiwgYnV0IGluIHNvbWUgQW5kcm9pZCBhbmQgUklNIGJhc2VkIHRhYmxldHMsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyAibGFuZHNjYXBlIi4gVGhlIGZvbGxvd2luZyBjb2RlIGF0dGVtcHRzIHRvIHVzZSB0aGUgd2luZG93CgkvLyBkaW1lbnNpb25zIHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiBpcywgYW5kIHRoZW4gbWFrZXMgYWRqdXN0bWVudHMKCS8vIHRvIHRoZSB0byB0aGUgcG9ydHJhaXRfbWFwIGlmIG5lY2Vzc2FyeSwgc28gdGhhdCB3ZSBjYW4gcHJvcGVybHkgZGVjb2RlIHRoZQoJLy8gd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlIHdoZW5ldmVyIGdldF9vcmllbnRhdGlvbigpIGlzIGNhbGxlZC4KCS8vCgkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2UgYSBtZWRpYSBxdWVyeSB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIG9yaWVudGF0aW9uIHRoZSBicm93c2VyCgkvLyB0aGlua3MgaXQgaXMgaW46CgkvLwoJLy8gICAgIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gJC5tb2JpbGUubWVkaWEoImFsbCBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIik7CgkvLwoJLy8gYnV0IHRoZXJlIHdhcyBhbiBpUGhvbmUvaVBvZCBUb3VjaCBidWcgYmVnaW5uaW5nIHdpdGggaU9TIDQuMiwgdXAgdGhyb3VnaCBpT1MgNS4xLAoJLy8gd2hlcmUgdGhlIGJyb3dzZXIgKkFMV0FZUyogYXBwbGllZCB0aGUgbGFuZHNjYXBlIG1lZGlhIHF1ZXJ5LiBUaGlzIGJ1ZyBkb2VzIG5vdAoJLy8gaGFwcGVuIG9uIGlQYWQuCgoJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgoJCS8vIENoZWNrIHRoZSB3aW5kb3cgd2lkdGggYW5kIGhlaWdodCB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24KCQkvLyBvZiB0aGUgZGV2aWNlIGlzIGF0IHRoaXMgbW9tZW50LiBOb3RlIHRoYXQgd2UndmUgaW5pdGlhbGl6ZWQgdGhlIHBvcnRyYWl0IG1hcAoJCS8vIHZhbHVlcyB0byAwIGFuZCAxODAsICpBTkQqIHdlIHB1cnBvc2VseSBjaGVjayBmb3IgbGFuZHNjYXBlIHNvIHRoYXQgaWYgd2UgZ3Vlc3MKCQkvLyB3cm9uZywgLCB3ZSBkZWZhdWx0IHRvIHRoZSBhc3N1bXB0aW9uIHRoYXQgcG9ydHJhaXQgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24uCgkJLy8gV2UgdXNlIGEgdGhyZXNob2xkIGNoZWNrIGJlbG93IGJlY2F1c2Ugb24gc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MsIHRoZSBpUGhvbmUKCQkvLyBmb3JtLWZhY3RvciBjYW4gcmVwb3J0IGEgbGFyZ2VyIHdpZHRoIHRoYW4gaGVpZ2h0IGlmIHRoZSB1c2VyIHR1cm5zIG9uIHRoZQoJCS8vIGRldmVsb3BlciBjb25zb2xlLiBUaGUgYWN0dWFsIHRocmVzaG9sZCB2YWx1ZSBpcyBzb21ld2hhdCBhcmJpdHJhcnksIHdlIGp1c3QKCQkvLyBuZWVkIHRvIG1ha2Ugc3VyZSBpdCBpcyBsYXJnZSBlbm91Z2ggdG8gZXhjbHVkZSB0aGUgZGV2ZWxvcGVyIGNvbnNvbGUgY2FzZS4KCgkJdmFyIHd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgJCggd2luZG93ICkud2lkdGgoKSwKCQkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJCggd2luZG93ICkuaGVpZ2h0KCksCgkJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSBzcGVjaWFsX2V2ZW50ID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKXsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfTsKCgkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgdGhpcyBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8KCS8vIHRoZSB3aW5kb3cgcmVzaXplIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCWZ1bmN0aW9uIGhhbmRsZXIoKSB7CgkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uLgoJCXZhciBvcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQlpZiAoIG9yaWVudGF0aW9uICE9PSBsYXN0X29yaWVudGF0aW9uICkgewoJCQkvLyBUaGUgb3JpZW50YXRpb24gaGFzIGNoYW5nZWQsIHNvIHRyaWdnZXIgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJCQlsYXN0X29yaWVudGF0aW9uID0gb3JpZW50YXRpb247CgkJCXdpbi50cmlnZ2VyKCAib3JpZW50YXRpb25jaGFuZ2UiICk7CgkJfQoJfQoKCS8vIEdldCB0aGUgY3VycmVudCBwYWdlIG9yaWVudGF0aW9uLiBUaGlzIG1ldGhvZCBpcyBleHBvc2VkIHB1YmxpY2x5LCBzaG91bGQgaXQKCS8vIGJlIG5lZWRlZCwgYXMgalF1ZXJ5LmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24oKQoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIGlzUG9ydHJhaXQgPSB0cnVlLCBlbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQkvLyBwcmVmZXIgd2luZG93IG9yaWVudGF0aW9uIHRvIHRoZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBzY3JlZW5zaXplIGFzCgkJLy8gdGhlIGFjdHVhbCBzY3JlZW4gcmVzaXplIHRha2VzIHBsYWNlIGJlZm9yZSBvciBhZnRlciB0aGUgb3JpZW50YXRpb24gY2hhbmdlIGV2ZW50CgkJLy8gaGFzIGJlZW4gZmlyZWQgZGVwZW5kaW5nIG9uIGltcGxlbWVudGF0aW9uIChlZyBhbmRyb2lkIDIuMyBpcyBiZWZvcmUsIGlwaG9uZSBhZnRlcikuCgkJLy8gTW9yZSB0ZXN0aW5nIGlzIHJlcXVpcmVkIHRvIGRldGVybWluZSBpZiBhIG1vcmUgcmVsaWFibGUgbWV0aG9kIG9mIGRldGVybWluaW5nIHRoZSBuZXcgc2NyZWVuc2l6ZQoJCS8vIGlzIHBvc3NpYmxlIHdoZW4gb3JpZW50YXRpb25jaGFuZ2UgaXMgZmlyZWQuIChlZywgdXNlIG1lZGlhIHF1ZXJpZXMgKyBlbGVtZW50ICsgb3BhY2l0eSkKCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCQkJLy8gaWYgdGhlIHdpbmRvdyBvcmllbnRhdGlvbiByZWdpc3RlcnMgYXMgMCBvciAxODAgZGVncmVlcyByZXBvcnQKCQkJLy8gcG9ydHJhaXQsIG90aGVyd2lzZSBsYW5kc2NhcGUKCQkJaXNQb3J0cmFpdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgkJfSBlbHNlIHsKCQkJaXNQb3J0cmFpdCA9IGVsZW0gJiYgZWxlbS5jbGllbnRXaWR0aCAvIGVsZW0uY2xpZW50SGVpZ2h0IDwgMS4xOwoJCX0KCgkJcmV0dXJuIGlzUG9ydHJhaXQgPyAicG9ydHJhaXQiIDogImxhbmRzY2FwZSI7Cgl9OwoKfSkoIGpRdWVyeSwgd2luZG93ICk7CgoKLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAooZnVuY3Rpb24oKSB7CgoJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCl7CgkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJfQoJfTsKCgl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJfSBlbHNlIHsKCgkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCX0KCgkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJfQoJCX0sCgkJbGFzdENhbGwgPSAwLAoJCWhlbGRDYWxsLAoJCWN1cnIsCgkJZGlmZjsKfSkoKTsKCgokLmVhY2goewoJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCXRhcGhvbGQ6ICJ0YXAiLAoJc3dpcGVsZWZ0OiAic3dpcGUiLAoJc3dpcGVyaWdodDogInN3aXBlIgp9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCSQuZXZlbnQuc3BlY2lhbFsgZXZlbnQgXSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogImMiLAoJCWRvbUNhY2hlOiBmYWxzZSwKCQlrZWVwTmF0aXZlRGVmYXVsdDogIjpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJLy8gaWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYoIHNlbGYuX3RyaWdnZXIoICJiZWZvcmVjcmVhdGUiICkgPT09IGZhbHNlICl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXNlbGYuZWxlbWVudAoJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJLmFkZENsYXNzKCAidWktcGFnZSB1aS1ib2R5LSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKQoJCQkuYmluZCggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oKXsKCQkJCXNlbGYucmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCgpOwoJCQl9ICkKCQkJLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCl7CgkJCQlzZWxmLnNldENvbnRhaW5lckJhY2tncm91bmQoKTsKCQkJfSApOwoKCX0sCgkKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCl7CgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQucGFyZW50KCkgKSApOwoJfSwKCQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKXsKCQlpZiggdGhpcy5vcHRpb25zLnRoZW1lICl7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyAoIHRoZW1lIHx8IHRoaXMub3B0aW9ucy50aGVtZSApICk7CgkJfQoJfSwKCglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlRGVmaW5lZCA9IG9wdGlvbnMua2VlcE5hdGl2ZSAmJiAkLnRyaW0ob3B0aW9ucy5rZWVwTmF0aXZlKTsKCgkJaWYoIGtlZXBOYXRpdmVEZWZpbmVkICYmIG9wdGlvbnMua2VlcE5hdGl2ZSAhPT0gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdCApewoJCQlyZXR1cm4gW29wdGlvbnMua2VlcE5hdGl2ZSwgb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdF0uam9pbigiLCAiKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0OwoJfQp9KTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgp2YXIgY3JlYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCBzZXF1ZW50aWFsICl7CgkKCS8vIERlZmF1bHQgdG8gc2VxdWVudGlhbAoJaWYoIHNlcXVlbnRpYWwgPT09IHVuZGVmaW5lZCApewoJCXNlcXVlbnRpYWwgPSB0cnVlOwoJfQoJCglyZXR1cm4gZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20gKSB7CgoJCXZhciBkZWZlcnJlZCA9IG5ldyAkLkRlZmVycmVkKCksCgkJCXJldmVyc2VDbGFzcyA9IHJldmVyc2UgPyAiIHJldmVyc2UiIDogIiIsCgkJCWFjdGl2ZQk9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCksCgkJCXRvU2Nyb2xsID0gYWN0aXZlLmxhc3RTY3JvbGwgfHwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwsCgkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQltYXhUcmFuc2l0aW9uT3ZlcnJpZGUgPSAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGggIT09IGZhbHNlICYmICQoIHdpbmRvdyApLndpZHRoKCkgPiAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGgsCgkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8IG1heFRyYW5zaXRpb25PdmVycmlkZSB8fCAhbmFtZSB8fCBuYW1lID09PSAibm9uZSIsCgkJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MgPSBmdW5jdGlvbigpewoJCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci50b2dnbGVDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyBuYW1lICk7CgkJCX0sCgkJCXNjcm9sbFBhZ2UgPSBmdW5jdGlvbigpewoJCQkJLy8gQnkgdXNpbmcgc2Nyb2xsVG8gaW5zdGVhZCBvZiBzaWxlbnRTY3JvbGwsIHdlIGNhbiBrZWVwIHRoaW5ncyBiZXR0ZXIgaW4gb3JkZXIKCQkJCS8vIEp1c3QgdG8gYmUgcHJlY2F1dGlvcywgZGlzYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgkJCQkKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdG9TY3JvbGwgKTsKCQkJCQoJCQkJLy8gcmVlbmFibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJCX0sIDE1MCApOwoJCQl9LAoJCQljbGVhbkZyb20gPSBmdW5jdGlvbigpewoJCQkJJGZyb20KCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgb3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgkJCX0sCgkJCXN0YXJ0T3V0ID0gZnVuY3Rpb24oKXsKCQkJCS8vIGlmIGl0J3Mgbm90IHNlcXVlbnRpYWwsIGNhbGwgdGhlIGRvbmVPdXQgdHJhbnNpdGlvbiB0byBzdGFydCB0aGUgVE8gcGFnZSBhbmltYXRpbmcgaW4gc2ltdWx0YW5lb3VzbHkKCQkJCWlmKCAhc2VxdWVudGlhbCApewoJCQkJCWRvbmVPdXQoKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCSRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCBkb25lT3V0ICk7CQoJCQkJfQoJCQkJCgkJCQkvLyBTZXQgdGhlIGZyb20gcGFnZSdzIGhlaWdodCBhbmQgc3RhcnQgaXQgdHJhbnNpdGlvbmluZyBvdXQKCQkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCQkkZnJvbQoJCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQod2luZG93ICkuc2Nyb2xsVG9wKCkgKQoJCQkJCS5hZGRDbGFzcyggbmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCQl9LAoJCQkKCQkJZG9uZU91dCA9IGZ1bmN0aW9uKCkgewoKCQkJCWlmICggJGZyb20gJiYgc2VxdWVudGlhbCApIHsKCQkJCQljbGVhbkZyb20oKTsKCQkJCX0KCQkJCQoJCQkJc3RhcnRJbigpOwoJCQl9LAoJCQkKCQkJc3RhcnRJbiA9IGZ1bmN0aW9uKCl7CQoJCQkKCQkJCSR0by5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICk7CQkJCQoJCQkKCQkJCS8vIFNlbmQgZm9jdXMgdG8gcGFnZSBhcyBpdCBpcyBub3cgZGlzcGxheTogYmxvY2sKCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggJHRvICk7CgoJCQkJLy8gU2V0IHRvIHBhZ2UgaGVpZ2h0CgkJCQkkdG8uaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyB0b1Njcm9sbCApOwoJCQkJCgkJCQlzY3JvbGxQYWdlKCk7CgkJCQkKCQkJCWlmKCAhbm9uZSApewoJCQkJCSR0by5hbmltYXRpb25Db21wbGV0ZSggZG9uZUluICk7CgkJCQl9CgkJCQkKCQkJCSR0by5hZGRDbGFzcyggbmFtZSArICIgaW4iICsgcmV2ZXJzZUNsYXNzICk7CgkJCQkKCQkJCWlmKCBub25lICl7CgkJCQkJZG9uZUluKCk7CgkJCQl9CgkJCQkKCQkJfSwKCQkKCQkJZG9uZUluID0gZnVuY3Rpb24oKSB7CgkJCQoJCQkJaWYgKCAhc2VxdWVudGlhbCApIHsKCQkJCQkKCQkJCQlpZiggJGZyb20gKXsKCQkJCQkJY2xlYW5Gcm9tKCk7CgkJCQkJfQoJCQkJfQoJCQkKCQkJCSR0bwoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCBpbiByZXZlcnNlICIgKyBuYW1lICkKCQkJCQkuaGVpZ2h0KCAiIiApOwoJCQkJCgkJCQl0b2dnbGVWaWV3cG9ydENsYXNzKCk7CgkJCQkKCQkJCS8vIEluIHNvbWUgYnJvd3NlcnMgKGlPUzUpLCAzRCB0cmFuc2l0aW9ucyBibG9jayB0aGUgYWJpbGl0eSB0byBzY3JvbGwgdG8gdGhlIGRlc2lyZWQgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXRpb24KCQkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCQlpZiggJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgIT09IHRvU2Nyb2xsICl7CgkJCQkJc2Nyb2xsUGFnZSgpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlc29sdmUoIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIHRydWUgKTsKCQkJfTsKCgkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoJCgkJaWYgKCAkZnJvbSAmJiAhbm9uZSApIHsKCQkJc3RhcnRPdXQoKTsKCQl9CgkJZWxzZSB7CgkJCWRvbmVPdXQoKTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9Owp9CgovLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKdmFyIHNlcXVlbnRpYWxIYW5kbGVyID0gY3JlYXRlSGFuZGxlcigpLAoJc2ltdWx0YW5lb3VzSGFuZGxlciA9IGNyZWF0ZUhhbmRsZXIoIGZhbHNlICk7CgovLyBNYWtlIG91ciB0cmFuc2l0aW9uIGhhbmRsZXIgdGhlIHB1YmxpYyBkZWZhdWx0LgokLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSBzZXF1ZW50aWFsSGFuZGxlcjsKCi8vdHJhbnNpdGlvbiBoYW5kbGVyIGRpY3Rpb25hcnkgZm9yIDNyZCBwYXJ0eSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMgPSB7CgkiZGVmYXVsdCI6ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCSJzZXF1ZW50aWFsIjogc2VxdWVudGlhbEhhbmRsZXIsCgkic2ltdWx0YW5lb3VzIjogc2ltdWx0YW5lb3VzSGFuZGxlcgp9OwoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcyA9IHt9OwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgl2YXIgJHdpbmRvdyA9ICQoIHdpbmRvdyApLAoJCSRodG1sID0gJCggJ2h0bWwnICksCgkJJGhlYWQgPSAkKCAnaGVhZCcgKSwKCgkJLy91cmwgcGF0aCBoZWxwZXJzIGZvciB1c2UgaW4gcmVsYXRpdmUgdXJsIG1hbmFnZW1lbnQKCQlwYXRoID0gewoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQl2YXIgYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXSwKCQkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJICAgIC8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCSAgICAvLyBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0ucmVwbGFjZSggL14jLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCBkb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCQl9CgkJCQlyZXR1cm4gYWJzVXJsOwoJCQl9LAoKCQkJLy9nZXQgcGF0aCBmcm9tIGN1cnJlbnQgaGFzaCwgb3IgZnJvbSBhIGZpbGUgcGF0aAoJCQlnZXQ6IGZ1bmN0aW9uKCBuZXdQYXRoICkgewoJCQkJaWYoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gbG9jYXRpb24uaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgJycgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICcmJyArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IGRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBkb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkJLy8gZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoL14jLykudGVzdCggdS5ocmVmICk7CgkJCX0KCQl9LAoKCQkvL3dpbGwgYmUgZGVmaW5lZCB3aGVuIGEgbGluayBpcyBjbGlja2VkIGFuZCBnaXZlbiBhbiBhY3RpdmUgY2xhc3MKCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsLAoKCQkvL3VybEhpc3RvcnkgaXMgcHVyZWx5IGhlcmUgdG8gbWFrZSBndWVzc2VzIGF0IHdoZXRoZXIgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gd2FzIGNsaWNrZWQKCQkvL2FuZCBwcm92aWRlIGFuIGFwcHJvcHJpYXRlIHRyYW5zaXRpb24KCQl1cmxIaXN0b3J5ID0gewoJCQkvLyBBcnJheSBvZiBwYWdlcyB0aGF0IGFyZSB2aXNpdGVkIGR1cmluZyBhIHNpbmdsZSBwYWdlIGxvYWQuCgkJCS8vIEVhY2ggaGFzIGEgdXJsIGFuZCBvcHRpb25hbCB0cmFuc2l0aW9uLCB0aXRsZSwgYW5kIHBhZ2VVcmwgKHdoaWNoIHJlcHJlc2VudHMgdGhlIGZpbGUgcGF0aCwgaW4gY2FzZXMgd2hlcmUgVVJMIGlzIG9ic2N1cmVkLCBzdWNoIGFzIGRpYWxvZ3MpCgkJCXN0YWNrOiBbXSwKCgkJCS8vbWFpbnRhaW4gYW4gaW5kZXggbnVtYmVyIGZvciB0aGUgYWN0aXZlIHBhZ2UgaW4gdGhlIHN0YWNrCgkJCWFjdGl2ZUluZGV4OiAwLAoKCQkJLy9nZXQgYWN0aXZlCgkJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdXJsSGlzdG9yeS5zdGFja1sgdXJsSGlzdG9yeS5hY3RpdmVJbmRleCBdOwoJCQl9LAoKCQkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdXJsSGlzdG9yeS5zdGFja1sgdXJsSGlzdG9yeS5hY3RpdmVJbmRleCAtIDEgXTsKCQkJfSwKCgkJCWdldE5leHQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggKyAxIF07CgkJCX0sCgoJCQkvLyBhZGROZXcgaXMgdXNlZCB3aGVuZXZlciBhIG5ldyBwYWdlIGlzIGFkZGVkCgkJCWFkZE5ldzogZnVuY3Rpb24oIHVybCwgdHJhbnNpdGlvbiwgdGl0bGUsIHBhZ2VVcmwsIHJvbGUgKSB7CgkJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCQlpZiggdXJsSGlzdG9yeS5nZXROZXh0KCkgKSB7CgkJCQkJdXJsSGlzdG9yeS5jbGVhckZvcndhcmQoKTsKCQkJCX0KCgkJCQl1cmxIaXN0b3J5LnN0YWNrLnB1c2goIHt1cmwgOiB1cmwsIHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHRpdGxlOiB0aXRsZSwgcGFnZVVybDogcGFnZVVybCwgcm9sZTogcm9sZSB9ICk7CgoJCQkJdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9IHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoIC0gMTsKCQkJfSwKCgkJCS8vd2lwZSB1cmxzIGFoZWFkIG9mIGFjdGl2ZSBpbmRleAoJCQljbGVhckZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQkJdXJsSGlzdG9yeS5zdGFjayA9IHVybEhpc3Rvcnkuc3RhY2suc2xpY2UoIDAsIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggKyAxICk7CgkJCX0sCgoJCQlkaXJlY3RIYXNoQ2hhbmdlOiBmdW5jdGlvbiggb3B0cyApIHsKCQkJCXZhciBiYWNrICwgZm9yd2FyZCwgbmV3QWN0aXZlSW5kZXgsIHByZXYgPSB0aGlzLmdldEFjdGl2ZSgpOwoKCQkJCS8vIGNoZWNrIGlmIHVybCBpc3AgaW4gaGlzdG9yeSBhbmQgaWYgaXQncyBhaGVhZCBvciBiZWhpbmQgY3VycmVudCBwYWdlCgkJCQkkLmVhY2goIHVybEhpc3Rvcnkuc3RhY2ssIGZ1bmN0aW9uKCBpLCBoaXN0b3J5RW50cnkgKSB7CgoJCQkJCS8vaWYgdGhlIHVybCBpcyBpbiB0aGUgc3RhY2ssIGl0J3MgYSBmb3J3YXJkIG9yIGEgYmFjawoJCQkJCWlmKCBvcHRzLmN1cnJlbnRVcmwgPT09IGhpc3RvcnlFbnRyeS51cmwgKSB7CgkJCQkJCS8vZGVmaW5lIGJhY2sgYW5kIGZvcndhcmQgYnkgd2hldGhlciB1cmwgaXMgb2xkZXIgb3IgbmV3ZXIgdGhhbiBjdXJyZW50IHBhZ2UKCQkJCQkJYmFjayA9IGkgPCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4OwoJCQkJCQlmb3J3YXJkID0gIWJhY2s7CgkJCQkJCW5ld0FjdGl2ZUluZGV4ID0gaTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBzYXZlIG5ldyBwYWdlIGluZGV4LCBudWxsIGNoZWNrIHRvIHByZXZlbnQgZmFsc2V5IDAgcmVzdWx0CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXggIT09IHVuZGVmaW5lZCA/IG5ld0FjdGl2ZUluZGV4IDogdGhpcy5hY3RpdmVJbmRleDsKCgkJCQlpZiggYmFjayApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNCYWNrICkoIHRydWUgKTsKCQkJCX0gZWxzZSBpZiggZm9yd2FyZCApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNGb3J3YXJkICkoIGZhbHNlICk7CgkJCQl9CgkJCX0sCgoJCQkvL2Rpc2FibGUgaGFzaGNoYW5nZSBldmVudCBsaXN0ZW5lciBpbnRlcm5hbGx5IHRvIGlnbm9yZSBvbmUgY2hhbmdlCgkJCS8vdG9nZ2xlZCBpbnRlcm5hbGx5IHdoZW4gbG9jYXRpb24uaGFzaCBpcyB1cGRhdGVkIHRvIG1hdGNoIHRoZSB1cmwgb2YgYSBzdWNjZXNzZnVsIHBhZ2UgbG9hZAoJCQlpZ25vcmVOZXh0SGFzaENoYW5nZTogZmFsc2UKCQl9LAoKCQkvL2RlZmluZSBmaXJzdCBzZWxlY3RvciB0byByZWNlaXZlIGZvY3VzIHdoZW4gYSBwYWdlIGlzIHNob3duCgkJZm9jdXNhYmxlID0gIlt0YWJpbmRleF0sYSxidXR0b246dmlzaWJsZSxzZWxlY3Q6dmlzaWJsZSxpbnB1dCIsCgoJCS8vcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJCXBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy9pbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2UsCgoJCS8vbm9uc2Vuc2UgaGFzaCBjaGFuZ2Uga2V5IGZvciBkaWFsb2dzLCBzbyB0aGV5IGNyZWF0ZSBhIGhpc3RvcnkgZW50cnkKCQlkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciLAoKCQkvL2V4aXN0aW5nIGJhc2UgdGFnPwoJCSRiYXNlID0gJGhlYWQuY2hpbGRyZW4oICJiYXNlIiApLAoKCQkvL3R1Y2sgYXdheSB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgVVJMIG1pbnVzIGFueSBmcmFnbWVudC4KCQlkb2N1bWVudFVybCA9IHBhdGgucGFyc2VVcmwoIGxvY2F0aW9uLmhyZWYgKSwKCgkJLy9pZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGVtYmVkZGVkIGJhc2UgdGFnLCBkb2N1bWVudEJhc2UgaXMgc2V0IHRvIGl0cwoJCS8vaW5pdGlhbCB2YWx1ZS4gSWYgYSBiYXNlIHRhZyBkb2VzIG5vdCBleGlzdCwgdGhlbiB3ZSBkZWZhdWx0IHRvIHRoZSBkb2N1bWVudFVybC4KCQlkb2N1bWVudEJhc2UgPSAkYmFzZS5sZW5ndGggPyBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGJhc2UuYXR0ciggImhyZWYiICksIGRvY3VtZW50VXJsLmhyZWYgKSApIDogZG9jdW1lbnRVcmwsCgoJCS8vY2FjaGUgdGhlIGNvbXBhcmlzb24gb25jZS4KCQlkb2N1bWVudEJhc2VEaWZmZXJzID0gKCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICE9PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApOwoKCQkvL2Jhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCQl2YXIgYmFzZSA9ICQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyA/IHsKCgkJCS8vZGVmaW5lIGJhc2UgZWxlbWVudCwgZm9yIHVzZSBpbiByb3V0aW5nIGFzc2V0IHVybHMgdGhhdCBhcmUgcmVmZXJlbmNlZCBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQkJZWxlbWVudDogKCAkYmFzZS5sZW5ndGggPyAkYmFzZSA6ICQoICI8YmFzZT4iLCB7IGhyZWY6IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoIH0gKS5wcmVwZW5kVG8oICRoZWFkICkgKSwKCgkJCS8vc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiBhdHRyaWJ1dGUgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBocmVmICkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwgcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGRvY3VtZW50QmFzZSApICk7CgkJCX0sCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwgZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKTsKCQkJfQoKCQl9IDogdW5kZWZpbmVkOwoKLyoKCWludGVybmFsIHV0aWxpdHkgZnVuY3Rpb25zCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy9kaXJlY3QgZm9jdXMgdG8gdGhlIHBhZ2UgdGl0bGUsIG9yIG90aGVyd2lzZSBmaXJzdCBmb2N1c2FibGUgZWxlbWVudAoJJC5tb2JpbGUuZm9jdXNQYWdlID0gZnVuY3Rpb24gKCBwYWdlICkgewoJCXZhciBhdXRvZm9jdXMgPSBwYWdlLmZpbmQoIlthdXRvZm9jdXNdIiksCgkJCXBhZ2VUaXRsZSA9IHBhZ2UuZmluZCggIi51aS10aXRsZTplcSgwKSIgKTsKCgkJaWYoIGF1dG9mb2N1cy5sZW5ndGggKSB7CgkJCWF1dG9mb2N1cy5mb2N1cygpOwoJCQlyZXR1cm47CgkJfQoKCQlpZiggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfQoJCWVsc2V7CgkJCXBhZ2UuZm9jdXMoKTsKCQl9Cgl9CgoJLy9yZW1vdmUgYWN0aXZlIGNsYXNzZXMgYWZ0ZXIgcGFnZSB0cmFuc2l0aW9uIG9yIGVycm9yCglmdW5jdGlvbiByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIGZvcmNlUmVtb3ZhbCApIHsKCQlpZiggISEkYWN0aXZlQ2xpY2tlZExpbmsgJiYgKCAhJGFjdGl2ZUNsaWNrZWRMaW5rLmNsb3Nlc3QoICcudWktcGFnZS1hY3RpdmUnICkubGVuZ3RoIHx8IGZvcmNlUmVtb3ZhbCApICkgewoJCQkkYWN0aXZlQ2xpY2tlZExpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfQoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGw7Cgl9CgoJZnVuY3Rpb24gcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpIHsKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJaWYoIHBhZ2VUcmFuc2l0aW9uUXVldWUubGVuZ3RoID4gMCApIHsKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZS5hcHBseSggbnVsbCwgcGFnZVRyYW5zaXRpb25RdWV1ZS5wb3AoKSApOwoJCX0KCX0KCgkvLyBTYXZlIHRoZSBsYXN0IHNjcm9sbCBkaXN0YW5jZSBwZXIgcGFnZSwgYmVmb3JlIGl0IGlzIGhpZGRlbgoJdmFyIHNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZSwKCQlzZXRMYXN0U2Nyb2xsLCBkZWxheWVkU2V0TGFzdFNjcm9sbDsKCglzZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbiB0aGUgYnJvd3NlcgoJCS8vIHNjcm9sbGluZyB0aGUgd2luZG93IGJhc2VkIG9uIGEgaGFzaGNoYW5nZQoJCWlmKCAhc2V0TGFzdFNjcm9sbEVuYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQlpZiggYWN0aXZlICkgewoJCQl2YXIgbGFzdFNjcm9sbCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCQkvLyBTZXQgYWN0aXZlIHBhZ2UncyBsYXN0U2Nyb2xsIHByb3AuCgkJCS8vIElmIHRoZSBsb2NhdGlvbiB3ZSdyZSBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJYWN0aXZlLmxhc3RTY3JvbGwgPSBsYXN0U2Nyb2xsIDwgJC5tb2JpbGUubWluU2Nyb2xsQmFjayA/ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsIDogbGFzdFNjcm9sbDsKCQl9Cgl9OwoKCS8vIGJpbmQgdG8gc2Nyb2xsc3RvcCB0byBnYXRoZXIgc2Nyb2xsIHBvc2l0aW9uLiBUaGUgZGVsYXkgYWxsb3dzIGZvciB0aGUgaGFzaGNoYW5nZQoJLy8gZXZlbnQgdG8gZmlyZSBhbmQgZGlzYWJsZSBzY3JvbGwgcmVjb3JkaW5nIGluIHRoZSBjYXNlIHdoZXJlIHRoZSBicm93c2VyIHNjcm9sbHMKCS8vIHRvIHRoZSBoYXNoIHRhcmdldHMgbG9jYXRpb24gKHNvbWV0aW1lcyB0aGUgdG9wIG9mIHRoZSBwYWdlKS4gb25jZSBwYWdlY2hhbmdlIGZpcmVzCgkvLyBnZXRMYXN0U2Nyb2xsIGlzIGFnYWluIHBlcm1pdHRlZCB0byBvcGVyYXRlCglkZWxheWVkU2V0TGFzdFNjcm9sbCA9IGZ1bmN0aW9uKCkgewoJCXNldFRpbWVvdXQoIHNldExhc3RTY3JvbGwsIDEwMCApOwoJfTsKCgkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLCB0aGlzIG9ubHkgd29ya3MKCS8vIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uIGlzIGRlbGF5ZWQgZm9yIDEwMG1zIGFmdGVyCgkvLyB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlIHBvc2l0aW9uIGJlY2F1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UKCSR3aW5kb3cuYmluZCggJC5zdXBwb3J0LnB1c2hTdGF0ZSA/ICJwb3BzdGF0ZSIgOiAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJIAlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJfSk7CgoJLy8gaGFuZGxlIGluaXRpYWwgaGFzaGNoYW5nZSBmcm9tIGNocm9tZSA6KAoJJHdpbmRvdy5vbmUoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7Cgl9KTsKCgkvLyB3YWl0IHVudGlsIHRoZSBtb2JpbGUgcGFnZSBjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCB0byBiaW5kIHRvIHBhZ2VjaGFuZ2UKCSR3aW5kb3cub25lKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIsIGZ1bmN0aW9uKCl7CgkJLy8gb25jZSB0aGUgcGFnZSBoYXMgY2hhbmdlZCwgcmUtZW5hYmxlIHRoZSBzY3JvbGwgcmVjb3JkaW5nCgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5iaW5kKCAicGFnZWNoYW5nZSIsIGZ1bmN0aW9uKCkgewoKCSAJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQgZGV0ZXJtaW5lZCBmb3IKCQkJLy8gdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJJHdpbmRvdy51bmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkJCS8vIGRldGVybWluZSBhbmQgYmluZCB0byB0aGUgY3VycmVudCBzY29sbCBlbGVtZW50IHdoaWNoIG1heSBiZSB0aGUgd2luZG93CgkJCS8vIG9yIGluIHRoZSBjYXNlIG9mIHRvdWNoIG92ZXJmbG93IHRoZSBlbGVtZW50IHdpdGggdG91Y2ggb3ZlcmZsb3cKCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgkJfSk7Cgl9KTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlIGFzICJwYWdlY2hhbmdlIiB3b24ndCBiZSBmaXJlZCBpbiB0aGF0IGNhc2UKCSR3aW5kb3cuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCS8vZnVuY3Rpb24gZm9yIHRyYW5zaXRpb25pbmcgYmV0d2VlbiB0d28gZXhpc3RpbmcgcGFnZXMKCWZ1bmN0aW9uIHRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgdHJhbnNpdGlvbiwgcmV2ZXJzZSApIHsKCgkJaWYoIGZyb21QYWdlICkgewoJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJZnJvbVBhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJiZWZvcmVoaWRlIiwgbnVsbCwgeyBuZXh0UGFnZTogdG9QYWdlIH0gKTsKCQl9CgoJCXRvUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZXNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCgkJLy9jbGVhciBwYWdlIGxvYWRlcgoJCSQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZygpOwoJCQoJCS8vIElmIHRyYW5zaXRpb24gaXMgZGVmaW5lZCwgY2hlY2sgaWYgY3NzIDNEIHRyYW5zZm9ybXMgYXJlIHN1cHBvcnRlZCwgYW5kIGlmIG5vdCwgaWYgYSBmYWxsYmFjayBpcyBzcGVjaWZpZWQKCQlpZiggdHJhbnNpdGlvbiAmJiAhJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXSApewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrc1sgdHJhbnNpdGlvbiBdOwoJCX0KCQkKCQkvL2ZpbmQgdGhlIHRyYW5zaXRpb24gaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCB0cmFuc2l0aW9uLiBJZiB0aGVyZQoJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkvL2NhbGwgdGhlIGhhbmRsZXIgaW1tZWRpYXRlbHkgdG8ga2ljay1vZmYgdGhlIHRyYW5zaXRpb24uCgkJdmFyIHRoID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIHx8ICJkZWZhdWx0IiBdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCQkJcHJvbWlzZSA9IHRoKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0b1BhZ2UsIGZyb21QYWdlICk7CgoJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCgkJCS8vdHJpZ2dlciBzaG93L2hpZGUgZXZlbnRzCgkJCWlmKCBmcm9tUGFnZSApIHsKCQkJCWZyb21QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAiaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJCX0KCgkJCS8vdHJpZ2dlciBwYWdlc2hvdywgZGVmaW5lIHByZXZQYWdlIGFzIGVpdGhlciBmcm9tUGFnZSBvciBlbXB0eSBqUXVlcnkgb2JqCgkJCXRvUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggInNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCQl9KTsKCgkJcmV0dXJuIHByb21pc2U7Cgl9CgoJLy9zaW1wbHkgc2V0IHRoZSBhY3RpdmUgcGFnZSdzIG1pbmltdW0gaGVpZ2h0IHRvIHNjcmVlbiBoZWlnaHQsIGRlcGVuZGluZyBvbiBvcmllbnRhdGlvbgoJZnVuY3Rpb24gZ2V0U2NyZWVuSGVpZ2h0KCl7CgkJLy8gTmF0aXZlIGlubmVySGVpZ2h0IHJldHVybnMgbW9yZSBhY2N1cmF0ZSB2YWx1ZSBmb3IgdGhpcyBhY3Jvc3MgcGxhdGZvcm1zLCAKCQkvLyBqUXVlcnkgdmVyc2lvbiBpcyBoZXJlIGFzIGEgbm9ybWFsaXplZCBmYWxsYmFjayBmb3IgcGxhdGZvcm1zIGxpa2UgU3ltYmlhbgoJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJCggd2luZG93ICkuaGVpZ2h0KCk7Cgl9CgoJJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0ID0gZ2V0U2NyZWVuSGVpZ2h0OwoKCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCWZ1bmN0aW9uIHJlc2V0QWN0aXZlUGFnZUhlaWdodCgpewoJCXZhciBhUGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQlhUGFnZVBhZFQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLXRvcCIgKSApLAoJCQlhUGFnZVBhZEIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApOwoJCQkJCgkJYVBhZ2UuY3NzKCAibWluLWhlaWdodCIsIGdldFNjcmVlbkhlaWdodCgpIC0gYVBhZ2VQYWRUIC0gYVBhZ2VQYWRCICk7Cgl9CgoJLy9zaGFyZWQgcGFnZSBlbmhhbmNlbWVudHMKCWZ1bmN0aW9uIGVuaGFuY2VQYWdlKCAkcGFnZSwgcm9sZSApIHsKCQkvLyBJZiBhIHJvbGUgd2FzIHNwZWNpZmllZCwgbWFrZSBzdXJlIHRoZSBkYXRhLXJvbGUgYXR0cmlidXRlCgkJLy8gb24gdGhlIHBhZ2UgZWxlbWVudCBpcyBpbiBzeW5jLgoJCWlmKCByb2xlICkgewoJCQkkcGFnZS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHJvbGUgKTsKCQl9CgoJCS8vcnVuIHBhZ2UgcGx1Z2luCgkJJHBhZ2UucGFnZSgpOwoJfQoKLyogZXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzCSAqLwoKCS8vYW5pbWF0aW9uIGNvbXBsZXRlIGNhbGxiYWNrCgkkLmZuLmFuaW1hdGlvbkNvbXBsZXRlID0gZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCWlmKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgKSB7CgkJCXJldHVybiAkKCB0aGlzICkub25lKCAnd2Via2l0QW5pbWF0aW9uRW5kIGFuaW1hdGlvbmVuZCcsIGNhbGxiYWNrICk7CgkJfQoJCWVsc2V7CgkJCS8vIGRlZmVyIGV4ZWN1dGlvbiBmb3IgY29uc2lzdGVuY3kgYmV0d2VlbiB3ZWJraXQvbm9uIHdlYmtpdAoJCQlzZXRUaW1lb3V0KCBjYWxsYmFjaywgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy9leHBvc2UgcGF0aCBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLnBhdGggPSBwYXRoOwoKCS8vZXhwb3NlIGJhc2Ugb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5iYXNlID0gYmFzZTsKCgkvL2hpc3Rvcnkgc3RhY2sKCSQubW9iaWxlLnVybEhpc3RvcnkgPSB1cmxIaXN0b3J5OwoKCSQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgPSBkaWFsb2dIYXNoS2V5OwoKCgoJLy9lbmFibGUgY3Jvc3MtZG9tYWluIHBhZ2Ugc3VwcG9ydAoJJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzID0gZmFsc2U7CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwgPSBmdW5jdGlvbihhc1BhcnNlZE9iamVjdCkgewoJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgZG9jdW1lbnRVcmwgKSA6IGRvY3VtZW50VXJsLmhyZWY7Cgl9OwoKCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oYXNQYXJzZWRPYmplY3QpIHsKCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIGRvY3VtZW50QmFzZSApIDogZG9jdW1lbnRCYXNlLmhyZWY7Cgl9OwoKCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSA9IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gJCh0aGlzKTsKCgkJLy8gd2hlbiBkb20gY2FjaGluZyBpcyBub3QgZW5hYmxlZCBvciB0aGUgcGFnZSBpcyBlbWJlZGRlZCBiaW5kIHRvIHJlbW92ZSB0aGUgcGFnZSBvbiBoaWRlCgkJaWYoICFwYWdlLmRhdGEoInBhZ2UiKS5vcHRpb25zLmRvbUNhY2hlCgkJCQkmJiBwYWdlLmlzKCI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiKSApIHsKCgkJCXBhZ2UuYmluZCggJ3BhZ2VoaWRlLnJlbW92ZScsIGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCWlmKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJCSR0aGlzLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCk7CgkJCQl9CgkJCX0pOwoJCX0KCX07CgoJLy8gTG9hZCBhIHBhZ2UgaW50byB0aGUgRE9NLgoJJC5tb2JpbGUubG9hZFBhZ2UgPSBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJLy8ga25vdyB3aGVuIHRoZSBwYWdlIGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCXZhciBkZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJCS8vIFRoZSBkZWZhdWx0IGxvYWRQYWdlIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5CgkJCS8vIHRoZSBjYWxsZXIuCgkJCXNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgcGFnZSBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCXBhZ2UgPSBudWxsLAoKCQkJLy8gSWYgdGhlIHJlbG9hZFBhZ2Ugb3B0aW9uIGlzIHRydWUsIGFuZCB0aGUgcGFnZSBpcyBhbHJlYWR5CgkJCS8vIGluIHRoZSBET00sIGR1cENhY2hlZFBhZ2Ugd2lsbCBiZSBzZXQgdG8gdGhlIHBhZ2UgZWxlbWVudAoJCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSByZW1vdmVkIGFmdGVyIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUKCQkJLy8gcGFnZSBpcyBsb2FkZWQgb2ZmIHRoZSBuZXR3b3JrLgoJCQlkdXBDYWNoZWRQYWdlID0gbnVsbCwKCgkJCS8vIGRldGVybWluZSB0aGUgY3VycmVudCBiYXNlIHVybAoJCQlmaW5kQmFzZVdpdGhEZWZhdWx0ID0gZnVuY3Rpb24oKXsKCQkJCXZhciBjbG9zZXN0QmFzZSA9ICggJC5tb2JpbGUuYWN0aXZlUGFnZSAmJiBnZXRDbG9zZXN0QmFzZVVybCggJC5tb2JpbGUuYWN0aXZlUGFnZSApICk7CgkJCQlyZXR1cm4gY2xvc2VzdEJhc2UgfHwgZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgkJCX0sCgoJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIHBhc3NlZCBpbnRvIHRoZSBmdW5jdGlvbi4gVGhpcwoJCQkvLyB2ZXJzaW9uIG9mIHRoZSBVUkwgbWF5IGNvbnRhaW4gZGlhbG9nL3N1YnBhZ2UgcGFyYW1zIGluIGl0LgoJCQlhYnNVcmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBmaW5kQmFzZVdpdGhEZWZhdWx0KCkgKTsKCgoJCS8vIElmIHRoZSBjYWxsZXIgcHJvdmlkZWQgZGF0YSwgYW5kIHdlJ3JlIHVzaW5nICJnZXQiIHJlcXVlc3QsCgkJLy8gYXBwZW5kIHRoZSBkYXRhIHRvIHRoZSBVUkwuCgkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJnZXQiICkgewoJCQlhYnNVcmwgPSBwYXRoLmFkZFNlYXJjaFBhcmFtcyggYWJzVXJsLCBzZXR0aW5ncy5kYXRhICk7CgkJCXNldHRpbmdzLmRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQkvLyBJZiB0aGUgY2FsbGVyIGlzIHVzaW5nIGEgInBvc3QiIHJlcXVlc3QsIHJlbG9hZFBhZ2UgbXVzdCBiZSB0cnVlCgkJaWYoICBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJwb3N0IiApewoJCQlzZXR0aW5ncy5yZWxvYWRQYWdlID0gdHJ1ZTsKCQl9CgoJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIG1pbnVzIGFueSBkaWFsb2cvc3VicGFnZSBwYXJhbXMuCgkJCS8vIEluIG90aGVyd29yZHMgdGhlIHJlYWwgVVJMIG9mIHRoZSBwYWdlIHRvIGJlIGxvYWRlZC4KCQl2YXIgZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIGFic1VybCApLAoKCQkJLy8gVGhlIHZlcnNpb24gb2YgdGhlIFVybCBhY3R1YWxseSBzdG9yZWQgaW4gdGhlIGRhdGEtdXJsIGF0dHJpYnV0ZSBvZgoJCQkvLyB0aGUgcGFnZS4gRm9yIGVtYmVkZGVkIHBhZ2VzLCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yIHBhZ2VzCgkJCS8vIHdpdGhpbiB0aGUgc2FtZSBkb21haW4gYXMgdGhlIGRvY3VtZW50IGJhc2UsIGl0IGlzIHRoZSBzaXRlIHJlbGF0aXZlCgkJCS8vIHBhdGguIEZvciBjcm9zcy1kb21haW4gcGFnZXMgKFBob25lIEdhcCBvbmx5KSB0aGUgZW50aXJlIGFic29sdXRlIFVybAoJCQkvLyB1c2VkIHRvIGxvYWQgdGhlIHBhZ2UuCgkJCWRhdGFVcmwgPSBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGFic1VybCApOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiOmpxbURhdGEodXJsPSciICsgZGF0YVVybCArICInKSIgKTsKCgkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkvLyByZWZlcmVuY2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4gSWYgc28sIGl0IG1heSBoYXZlIGJlZW4gZHluYW1pY2FsbHkKCQkvLyBpbmplY3RlZCBieSBhIGRldmVsb3BlciwgaW4gd2hpY2ggY2FzZSBpdCB3b3VsZCBiZSBsYWNraW5nIGEgZGF0YS11cmwKCQkvLyBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCAmJiBkYXRhVXJsICYmICFwYXRoLmlzUGF0aCggZGF0YVVybCApICkgewoJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIiMiICsgZGF0YVVybCApCgkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIGRhdGFVcmwgKTsKCQl9CgoJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCS8vIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgYXBwbGljYXRpb24uIElmIGl0IGlzbid0IGEgcmVmZXJlbmNlCgkJLy8gdG8gdGhlIGZpcnN0IHBhZ2UgYW5kIHJlZmVycyB0byBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSwgZXJyb3Igb3V0LgoJCWlmICggcGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlICYmIHBhdGguaXNGaXJzdFBhZ2VVcmwoIGZpbGVVcmwgKSApIHsKCQkJCS8vIENoZWNrIHRvIG1ha2Ugc3VyZSBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkKCQkJCS8vIGluIHRoZSBET00uIFNvbWUgdXNlciBkZXBsb3llZCBhcHBzIGFyZSBwcnVuaW5nIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBmcm9tIHRoZSBET00gZm9yIHZhcmlvdXMgcmVhc29ucywgd2UgY2hlY2sgZm9yIHRoaXMKCQkJCS8vIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGggYW4gaWQKCQkJCS8vIGZhbGxpbmcgdGhyb3VnaCB0byB0aGUgbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UgZXJyb3IKCQkJCS8vIGNhc2UuIElmIHRoZSBmaXJzdC1wYWdlIGlzIG5vdCBpbiB0aGUgRE9NLCB0aGVuIHdlIGxldAoJCQkJLy8gdGhpbmdzIGZhbGwgdGhyb3VnaCB0byB0aGUgYWpheCBsb2FkaW5nIGNvZGUgYmVsb3cgc28KCQkJCS8vIHRoYXQgaXQgZ2V0cyByZWxvYWRlZC4KCQkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlLnBhcmVudCgpLmxlbmd0aCApIHsKCQkJCQlwYWdlID0gJCggJC5tb2JpbGUuZmlyc3RQYWdlICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIGZpbGVVcmwgKSAgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCX0KCgkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlLgoJCWlmICggYmFzZSApIHsKCQkJYmFzZS5yZXNldCgpOwoJCX0KCgkJLy8gSWYgdGhlIHBhZ2Ugd2UgYXJlIGludGVyZXN0ZWQgaW4gaXMgYWxyZWFkeSBpbiB0aGUgRE9NLAoJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCS8vIHJlbG9hZCBvZiB0aGUgZmlsZSwgd2UgYXJlIGRvbmUuIE90aGVyd2lzZSwgdHJhY2sgdGhlCgkJLy8gZXhpc3RpbmcgcGFnZSBhcyBhIGR1cGxpY2F0ZWQuCgkJaWYgKCBwYWdlLmxlbmd0aCApIHsKCQkJaWYgKCAhc2V0dGluZ3MucmVsb2FkUGFnZSApIHsKCQkJCWVuaGFuY2VQYWdlKCBwYWdlLCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIG9wdGlvbnMsIHBhZ2UgKTsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQkJZHVwQ2FjaGVkUGFnZSA9IHBhZ2U7CgkJfQoKCQl2YXIgbXBjID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciwKCQkJcGJsRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVsb2FkIiApLAoJCQl0cmlnZ2VyRGF0YSA9IHsgdXJsOiB1cmwsIGFic1VybDogYWJzVXJsLCBkYXRhVXJsOiBkYXRhVXJsLCBkZWZlcnJlZDogZGVmZXJyZWQsIG9wdGlvbnM6IHNldHRpbmdzIH07CgoJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBsb2FkIGEgcGFnZS4KCQltcGMudHJpZ2dlciggcGJsRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCWlmKCBwYmxFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCX0KCgkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCS8vIFRoaXMgY29uZmlndXJhYmxlIHRpbWVvdXQgYWxsb3dzIGNhY2hlZCBwYWdlcyBhIGJyaWVmIGRlbGF5IHRvIGxvYWQgd2l0aG91dCBzaG93aW5nIGEgbWVzc2FnZQoJCQl2YXIgbG9hZE1zZ0RlbGF5ID0gc2V0VGltZW91dChmdW5jdGlvbigpewoJCQkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZygpOwoJCQkJfSwgc2V0dGluZ3MubG9hZE1zZ0RlbGF5ICksCgoJCQkJLy8gU2hhcmVkIGxvZ2ljIGZvciBjbGVhcmluZyB0aW1lb3V0IGFuZCByZW1vdmluZyBtZXNzYWdlLgoJCQkJaGlkZU1zZyA9IGZ1bmN0aW9uKCl7CgoJCQkJCS8vIFN0b3AgbWVzc2FnZSBzaG93IHRpbWVyCgkJCQkJY2xlYXJUaW1lb3V0KCBsb2FkTXNnRGVsYXkgKTsKCgkJCQkJLy8gSGlkZSBsb2FkaW5nIG1lc3NhZ2UKCQkJCQkkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2coKTsKCQkJCX07CgkJfQoKCQlpZiAoICEoICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyB8fCBwYXRoLmlzU2FtZURvbWFpbiggZG9jdW1lbnRVcmwsIGFic1VybCApICkgKSB7CgkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJfSBlbHNlIHsKCQkJLy8gTG9hZCB0aGUgbmV3IHBhZ2UuCgkJCSQuYWpheCh7CgkJCQl1cmw6IGZpbGVVcmwsCgkJCQl0eXBlOiBzZXR0aW5ncy50eXBlLAoJCQkJZGF0YTogc2V0dGluZ3MuZGF0YSwKCQkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCQlzdWNjZXNzOiBmdW5jdGlvbiggaHRtbCwgdGV4dFN0YXR1cywgeGhyICkgewoJCQkJCS8vcHJlLXBhcnNlIGh0bWwgdG8gY2hlY2sgZm9yIGEgZGF0YS11cmwsCgkJCQkJLy91c2UgaXQgYXMgdGhlIG5ldyBmaWxlVXJsLCBiYXNlIHBhdGgsIGV0YwoJCQkJCXZhciBhbGwgPSAkKCAiPGRpdj48L2Rpdj4iICksCgoJCQkJCQkvL3BhZ2UgdGl0bGUgcmVnZXhwCgkJCQkJCW5ld1BhZ2VUaXRsZSA9IGh0bWwubWF0Y2goIC88dGl0bGVbXj5dKj4oW148XSopLyApICYmIFJlZ0V4cC4kMSwKCgkJCQkJCS8vIFRPRE8gaGFuZGxlIGRpYWxvZ3MgYWdhaW4KCQkJCQkJcGFnZUVsZW1SZWdleCA9IG5ldyBSZWdFeHAoICIoPFtePl0rXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT1bXCInXT9wYWdlW1wiJ10/W14+XSo+KSIgKSwKCQkJCQkJZGF0YVVybFJlZ2V4ID0gbmV3IFJlZ0V4cCggIlxcYmRhdGEtIiArICQubW9iaWxlLm5zICsgInVybD1bXCInXT8oW15cIic+XSopW1wiJ10/IiApOwoKCgkJCQkJLy8gZGF0YS11cmwgbXVzdCBiZSBwcm92aWRlZCBmb3IgdGhlIGJhc2UgdGFnIHNvIHJlc291cmNlIHJlcXVlc3RzIGNhbiBiZSBkaXJlY3RlZCB0byB0aGUKCQkJCQkvLyBjb3JyZWN0IHVybC4gbG9hZGluZyBpbnRvIGEgdGVtcHJvcmFyeSBlbGVtZW50IG1ha2VzIHRoZXNlIHJlcXVlc3RzIGltbWVkaWF0ZWx5CgkJCQkJaWYoIHBhZ2VFbGVtUmVnZXgudGVzdCggaHRtbCApCgkJCQkJCQkmJiBSZWdFeHAuJDEKCQkJCQkJCSYmIGRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKQoJCQkJCQkJJiYgUmVnRXhwLiQxICkgewoJCQkJCQl1cmwgPSBmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggUmVnRXhwLiQxICk7CgkJCQkJfQoKCQkJCQlpZiAoIGJhc2UgKSB7CgkJCQkJCWJhc2Uuc2V0KCBmaWxlVXJsICk7CgkJCQkJfQoKCQkJCQkvL3dvcmthcm91bmQgdG8gYWxsb3cgc2NyaXB0cyB0byBleGVjdXRlIHdoZW4gaW5jbHVkZWQgaW4gcGFnZSBkaXZzCgkJCQkJYWxsLmdldCggMCApLmlubmVySFRNTCA9IGh0bWw7CgkJCQkJcGFnZSA9IGFsbC5maW5kKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maXJzdCgpOwoKCQkJCQkvL2lmIHBhZ2UgZWxlbSBjb3VsZG4ndCBiZSBmb3VuZCwgY3JlYXRlIG9uZSBhbmQgaW5zZXJ0IHRoZSBib2R5IGVsZW1lbnQncyBjb250ZW50cwoJCQkJCWlmKCAhcGFnZS5sZW5ndGggKXsKCQkJCQkJcGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPiIgKyBodG1sLnNwbGl0KCAvPFwvP2JvZHlbXj5dKj4vZ21pIClbMV0gKyAiPC9kaXY+IiApOwoJCQkJCX0KCgkJCQkJaWYgKCBuZXdQYWdlVGl0bGUgJiYgIXBhZ2UuanFtRGF0YSggInRpdGxlIiApICkgewoJCQkJCQlpZiAoIH5uZXdQYWdlVGl0bGUuaW5kZXhPZiggIiYiICkgKSB7CgkJCQkJCQluZXdQYWdlVGl0bGUgPSAkKCAiPGRpdj4iICsgbmV3UGFnZVRpdGxlICsgIjwvZGl2PiIgKS50ZXh0KCk7CgkJCQkJCX0KCQkJCQkJcGFnZS5qcW1EYXRhKCAidGl0bGUiLCBuZXdQYWdlVGl0bGUgKTsKCQkJCQl9CgoJCQkJCS8vcmV3cml0ZSBzcmMgYW5kIGhyZWYgYXR0cnMgdG8gdXNlIGEgYmFzZSB1cmwKCQkJCQlpZiggISQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyApIHsKCQkJCQkJdmFyIG5ld1BhdGggPSBwYXRoLmdldCggZmlsZVVybCApOwoJCQkJCQlwYWdlLmZpbmQoICJbc3JjXSwgbGlua1tocmVmXSwgYVtyZWw9J2V4dGVybmFsJ10sIDpqcW1EYXRhKGFqYXg9J2ZhbHNlJyksIGFbdGFyZ2V0XSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkJdmFyIHRoaXNBdHRyID0gJCggdGhpcyApLmlzKCAnW2hyZWZdJyApID8gJ2hyZWYnIDoKCQkJCQkJCQkJJCh0aGlzKS5pcygnW3NyY10nKSA/ICdzcmMnIDogJ2FjdGlvbicsCgkJCQkJCQkJdGhpc1VybCA9ICQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciApOwoKCQkJCQkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBmaXggdGhpcyBzbyB0aGF0IGl0IHJlbW92ZXMgdGhlIGRvY3VtZW50CgkJCQkJCQkvLyAgICAgICAgICAgIGJhc2UgVVJMLCBhbmQgdGhlbiBwcmVwZW5kcyB3aXRoIHRoZSBuZXcgcGFnZSBVUkwuCgkJCQkJCQkvL2lmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSwgJycgKTsKCgkJCQkJCQlpZiggIS9eKFx3Kzp8I3xcLykvLnRlc3QoIHRoaXNVcmwgKSApIHsKCQkJCQkJCQkkKCB0aGlzICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCX0KCgkJCQkJLy9hcHBlbmQgdG8gcGFnZSBhbmQgZW5oYW5jZQoJCQkJCS8vIFRPRE8gdGFnaW5nIGEgcGFnZSB3aXRoIGV4dGVybmFsIHRvIG1ha2Ugc3VyZSB0aGF0IGVtYmVkZGVkIHBhZ2VzIGFyZW4ndCByZW1vdmVkCgkJCQkJLy8gICAgICBieSB0aGUgdmFyaW91cyBwYWdlIGhhbmRsaW5nIGNvZGUgaXMgYmFkLiBIYXZpbmcgcGFnZSBoYW5kbGluZyBjb2RlIGluIG1hbnkKCQkJCQkvLyAgICAgIHBsYWNlcyBpcyBiYWQuIFNvbHV0aW9ucyBwb3N0IDEuMAoJCQkJCXBhZ2UKCQkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGZpbGVVcmwgKSApCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZXh0ZXJuYWwtcGFnZSIsIHRydWUgKQoJCQkJCQkuYXBwZW5kVG8oIHNldHRpbmdzLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJLy8gd2FpdCBmb3IgcGFnZSBjcmVhdGlvbiB0byBsZXZlcmFnZSBvcHRpb25zIGRlZmluZWQgb24gd2lkZ2V0CgkJCQkJcGFnZS5vbmUoICdwYWdlY3JlYXRlJywgJC5tb2JpbGUuX2JpbmRQYWdlUmVtb3ZlICk7CgoJCQkJCWVuaGFuY2VQYWdlKCBwYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCQkJCS8vIEVuaGFuY2luZyB0aGUgcGFnZSBtYXkgcmVzdWx0IGluIG5ldyBkaWFsb2dzL3N1YiBwYWdlcyBiZWluZyBpbnNlcnRlZAoJCQkJCS8vIGludG8gdGhlIERPTS4gSWYgdGhlIG9yaWdpbmFsIGFic1VybCByZWZlcnMgdG8gYSBzdWItcGFnZSwgdGhhdCBpcyB0aGUKCQkJCQkvLyByZWFsIHBhZ2Ugd2UgYXJlIGludGVyZXN0ZWQgaW4uCgkJCQkJaWYgKCBhYnNVcmwuaW5kZXhPZiggIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSApID4gLTEgKSB7CgkJCQkJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiOmpxbURhdGEodXJsPSciICsgZGF0YVVybCArICInKSIgKTsKCQkJCQl9CgoJCQkJCS8vYmluZCBwYWdlSGlkZSB0byByZW1vdmVQYWdlIGFmdGVyIGl0J3MgaGlkZGVuLCBpZiB0aGUgcGFnZSBvcHRpb25zIHNwZWNpZnkgdG8gZG8gc28KCgkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCQloaWRlTXNnKCk7CgkJCQkJfQoKCQkJCQkvLyBBZGQgdGhlIHBhZ2UgcmVmZXJlbmNlIGFuZCB4aHIgdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCQl0cmlnZ2VyRGF0YS5wYWdlID0gcGFnZTsKCgkJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBwYWdlIGxvYWRlZCBzdWNjZXNzZnVsbHkuCgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCAicGFnZWxvYWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIG9wdGlvbnMsIHBhZ2UsIGR1cENhY2hlZFBhZ2UgKTsKCQkJCX0sCgkJCQllcnJvcjogZnVuY3Rpb24oIHhociwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24gKSB7CgkJCQkJLy9zZXQgYmFzZSBiYWNrIHRvIGN1cnJlbnQgcGF0aAoJCQkJCWlmKCBiYXNlICkgewoJCQkJCQliYXNlLnNldCggcGF0aC5nZXQoKSApOwoJCQkJCX0KCgkJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCQl2YXIgcGxmRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2Vsb2FkZmFpbGVkIiApOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZCBmYWlsZWQuCgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCBwbGZFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJCS8vIGRlZmVycmVkIG9iamVjdCB3aXRoaW4gdGhlIHRyaWdnZXJEYXRhLgoJCQkJCWlmKCBwbGZFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgoJCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCQloaWRlTXNnKCk7CgoJCQkJCQkvLyBzaG93IGVycm9yIG1lc3NhZ2UKCQkJCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lLCAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZSwgdHJ1ZSApOwoKCQkJCQkJLy8gaGlkZSBhZnRlciBkZWxheQoJCQkJCQlzZXRUaW1lb3V0KCAkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2csIDE1MDAgKTsKCQkJCQl9CgoJCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX07CgoJJC5tb2JpbGUubG9hZFBhZ2UuZGVmYXVsdHMgPSB7CgkJdHlwZTogImdldCIsCgkJZGF0YTogdW5kZWZpbmVkLAoJCXJlbG9hZFBhZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCXNob3dMb2FkTXNnOiBmYWxzZSwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJbG9hZE1zZ0RlbGF5OiA1MCAvLyBUaGlzIGRlbGF5IGFsbG93cyBsb2FkcyB0aGF0IHB1bGwgZnJvbSBicm93c2VyIGNhY2hlIHRvIG9jY3VyIHdpdGhvdXQgc2hvd2luZyB0aGUgbG9hZGluZyBtZXNzYWdlLgoJfTsKCgkvLyBTaG93IGEgc3BlY2lmaWMgcGFnZSBpbiB0aGUgcGFnZSBjb250YWluZXIuCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvUGFnZSwgb3B0aW9ucyApIHsKCQkvLyBJZiB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGEgdHJhbnNpdGlvbiwgcXVldWUgdGhlIGN1cnJlbnQgcmVxdWVzdC4KCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uIHRvCgkJLy8gc2VydmljZSB0aGUgcmVxdWVzdC4KCQlpZiggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICk7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgcGFnZUNvbnRhaW5lciB0byB3b3JrIHdpdGguCgkJc2V0dGluZ3MucGFnZUNvbnRhaW5lciA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBmcm9tUGFnZS4KCQlzZXR0aW5ncy5mcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlIHx8ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHRvUGFnZTogdG9QYWdlLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBiY0V2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiggcGJjRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvUGFnZSBpbiB0aGUgdHJpZ2dlcgoJCS8vIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0b1BhZ2UgaXMgdXBkYXRlZC4KCgkJdG9QYWdlID0gdHJpZ2dlckRhdGEudG9QYWdlOwoKCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCS8vIG9yIHRyYW5zaXRpb25pbmcuCgoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJLy8gdG8gbWFrZSBzdXJlIGl0IGlzIGxvYWRlZCBpbnRvIHRoZSBET00uIFdlJ2xsIGxpc3RlbgoJCS8vIHRvIHRoZSBwcm9taXNlIG9iamVjdCBpdCByZXR1cm5zIHNvIHdlIGtub3cgd2hlbgoJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCWlmICggdHlwZW9mIHRvUGFnZSA9PSAic3RyaW5nIiApIHsKCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHRvUGFnZSwgc2V0dGluZ3MgKQoJCQkJLmRvbmUoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgbmV3UGFnZSwgZHVwQ2FjaGVkUGFnZSApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQkJb3B0aW9ucy5kdXBsaWNhdGVDYWNoZWRQYWdlID0gZHVwQ2FjaGVkUGFnZTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBuZXdQYWdlLCBvcHRpb25zICk7CgkJCQl9KQoJCQkJLmZhaWwoZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgoJCQkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgoJCQkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2VjaGFuZ2VmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoJCQkJfSk7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZmlyc3QtcGFnZSBvZiB0aGUgYXBwbGljYXRpb24sIHdlIG5lZWQgdG8gbWFrZQoJCS8vIHN1cmUgc2V0dGluZ3MuZGF0YVVybCBpcyBzZXQgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVybC4gVGhpcyBhbGxvd3MKCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkvLyBmaXJzdC1wYWdlIG9mIHRoZSBkb2N1bWVudCBoYXMgYW4gaWQgYXR0cmlidXRlIHNwZWNpZmllZC4KCQlpZiAoIHRvUGFnZVsgMCBdID09PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSAmJiAhc2V0dGluZ3MuZGF0YVVybCApIHsKCQkJc2V0dGluZ3MuZGF0YVVybCA9IGRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJfQoKCQkvLyBUaGUgY2FsbGVyIHBhc3NlZCB1cyBhIHJlYWwgcGFnZSBET00gZWxlbWVudC4gVXBkYXRlIG91cgoJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCXZhciBmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlLAoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBzZXR0aW5ncy5kYXRhVXJsICkgKSB8fCB0b1BhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQgYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmwsCgkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCB1cmwgKSwKCQkJYWN0aXZlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9IHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAsCgkJCWhpc3RvcnlEaXIgPSAwLAoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZSwKCQkJaXNEaWFsb2cgPSBzZXR0aW5ncy5yb2xlID09PSAiZGlhbG9nIiB8fCB0b1BhZ2UuanFtRGF0YSggInJvbGUiICkgPT09ICJkaWFsb2ciOwoKCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50IG1hbnVhbGx5L2R5bmFtaWNhbGx5CgkJLy8gYW5kIHJldXNlIHBhZ2VzIHdhbnQgdG8gYmUgYWJsZSB0byB0cmFuc2l0aW9uIHRvIHRoZSBzYW1lIHBhZ2UuIFRvIGFsbG93CgkJLy8gdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0IHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uCgkJLy8gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbiBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLgoJCS8vIEl0IHNob3VsZCBiZSBub3RlZCB0aGF0IG91ciBkZWZhdWx0IHRyYW5zaXRpb24gYW5pbWF0aW9ucyBhc3N1bWUgdGhhdCB0aGUKCQkvLyBmb3JtUGFnZSBhbmQgdG9QYWdlIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuCgkJLy8gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uCgkJLy8gdG8gZWl0aGVyIHR1cm4gb2ZmIHRyYW5zaXRpb24gYW5pbWF0aW9ucywgb3IgbWFrZSBzdXJlIHRoYXQgYW4gYXBwcm9wcmlhdGUKCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCWlmKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmICFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFnZSB3ZSBhcmUgZ2l2ZW4gaGFzIGFscmVhZHkgYmVlbiBlbmhhbmNlZC4KCQllbmhhbmNlUGFnZSggdG9QYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCS8vIElmIHRoZSBjaGFuZ2VQYWdlIHJlcXVlc3Qgd2FzIHNlbnQgZnJvbSBhIGhhc2hDaGFuZ2UgZXZlbnQsIGNoZWNrIHRvIHNlZSBpZiB0aGUKCQkvLyBwYWdlIGlzIGFscmVhZHkgd2l0aGluIHRoZSB1cmxIaXN0b3J5IHN0YWNrLiBJZiBzbywgd2UnbGwgYXNzdW1lIHRoZSB1c2VyIGhpdAoJCS8vIHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUgdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQlpZiggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQljdXJyZW50VXJsOgl1cmwsCgkJCQlpc0JhY2s6CQlmdW5jdGlvbigpIHsgaGlzdG9yeURpciA9IC0xOyB9LAoJCQkJaXNGb3J3YXJkOglmdW5jdGlvbigpIHsgaGlzdG9yeURpciA9IDE7IH0KCQkJfSk7CgkJfQoKCQkvLyBLaWxsIHRoZSBrZXlib2FyZC4KCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gc3RvcCBjcmF3bGluZyB0aGUgZW50aXJlIGRvY3VtZW50IHRvIGtpbGwgZm9jdXMuIEluc3RlYWQsCgkJLy8gICAgICAgICAgICB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkgaGFuZGxlciBzbyB3ZSBhbHJlYWR5IGhhdmUKCQkvLyAgICAgICAgICAgIHRoZSBlbGVtZW50IGluIGhhbmQgYXQgdGhpcyBwb2ludC4KCQkvLyBXcmFwIHRoaXMgaW4gYSB0cnkvY2F0Y2ggYmxvY2sgc2luY2UgSUU5IHRocm93ICJVbnNwZWNpZmllZCBlcnJvciIgaWYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudAoJCS8vIGlzIHVuZGVmaW5lZCB3aGVuIHdlIGFyZSBpbiBhbiBJRnJhbWUuCgkJdHJ5IHsKCQkJaWYoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiBkb2N1bWVudC5hY3RpdmVFbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT0gJ2JvZHknKSB7CgkJCQkkKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpLmJsdXIoKTsKCQkJfSBlbHNlIHsKCQkJCSQoICJpbnB1dDpmb2N1cywgdGV4dGFyZWE6Zm9jdXMsIHNlbGVjdDpmb2N1cyIgKS5ibHVyKCk7CgkJCX0KCQl9IGNhdGNoKGUpIHt9CgoJCS8vIElmIHdlJ3JlIGRpc3BsYXlpbmcgdGhlIHBhZ2UgYXMgYSBkaWFsb2csIHdlIGRvbid0IHdhbnQgdGhlIHVybAoJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCS8vIHRvIGFwcGVuZCB0aGUgZGlhbG9nSGFzaEtleSB0byB0aGUgdXJsIG9mIHRoZSBjdXJyZW50IHBhZ2UuCgkJaWYgKCBpc0RpYWxvZyAmJiBhY3RpdmUgKSB7CgkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlIHNob3VsZAoJCQkvLyBiZSBhbiBlbXB0eSBzdHJpbmcuIE1vdmluZyB0aGUgdW5kZWZpbmVkIC0+IGVtcHR5IHN0cmluZyBiYWNrIGludG8KCQkJLy8gdXJsSGlzdG9yeS5hZGROZXcgc2VlbWVkIGltcHJ1ZGVudCBnaXZlbiB1bmRlZmluZWQgYmV0dGVyIHJlcHJlc2VudHMKCQkJLy8gdGhlIHVybCBzdGF0ZQoJCQl1cmwgPSAoIGFjdGl2ZS51cmwgfHwgIiIgKSArIGRpYWxvZ0hhc2hLZXk7CgkJfQoKCQkvLyBTZXQgdGhlIGxvY2F0aW9uIGhhc2guCgkJaWYoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmIHVybCApIHsKCQkJLy9kaXNhYmxlIGhhc2ggbGlzdGVuaW5nIHRlbXBvcmFyaWx5CgkJCXVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSB0cnVlOwoJCQkvL3VwZGF0ZSBoYXNoIGFuZCBoaXN0b3J5CgkJCXBhdGguc2V0KCB1cmwgKTsKCQl9CgoJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QgdXNlIHBhZ2VUaXRsZQoJCXZhciBuZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKT8gcGFnZVRpdGxlIDogdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSB8fCB0b1BhZ2UuY2hpbGRyZW4oIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIikuZmluZCgiLnVpLXRpdGxlIiApLmdldEVuY29kZWRUZXh0KCk7CgkJaWYoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PSBkb2N1bWVudC50aXRsZSApIHsKCQkJcGFnZVRpdGxlID0gbmV3UGFnZVRpdGxlOwoJCX0KCQlpZiAoICF0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApICkgewoJCQl0b1BhZ2UuanFtRGF0YSggInRpdGxlIiwgcGFnZVRpdGxlICk7CgkJfQoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHRyYW5zaXRpb24gZGVmaW5lZC4KCQlzZXR0aW5ncy50cmFuc2l0aW9uID0gc2V0dGluZ3MudHJhbnNpdGlvbgoJCQl8fCAoICggaGlzdG9yeURpciAmJiAhYWN0aXZlSXNJbml0aWFsUGFnZSApID8gYWN0aXZlLnRyYW5zaXRpb24gOiB1bmRlZmluZWQgKQoJCQl8fCAoIGlzRGlhbG9nID8gJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gOiAkLm1vYmlsZS5kZWZhdWx0UGFnZVRyYW5zaXRpb24gKTsKCgkJLy9hZGQgcGFnZSB0byBoaXN0b3J5IHN0YWNrIGlmIGl0J3Mgbm90IGJhY2sgb3IgZm9yd2FyZAoJCWlmKCAhaGlzdG9yeURpciApIHsKCQkJdXJsSGlzdG9yeS5hZGROZXcoIHVybCwgc2V0dGluZ3MudHJhbnNpdGlvbiwgcGFnZVRpdGxlLCBwYWdlVXJsLCBzZXR0aW5ncy5yb2xlICk7CgkJfQoKCQkvL3NldCBwYWdlIHRpdGxlCgkJZG9jdW1lbnQudGl0bGUgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnRpdGxlOwoKCQkvL3NldCAidG9QYWdlIiBhcyBhY3RpdmVQYWdlCgkJJC5tb2JpbGUuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJLy8gSWYgd2UncmUgbmF2aWdhdGluZyBiYWNrIGluIHRoZSBVUkwgaGlzdG9yeSwgc2V0IHJldmVyc2UgYWNjb3JkaW5nbHkuCgkJc2V0dGluZ3MucmV2ZXJzZSA9IHNldHRpbmdzLnJldmVyc2UgfHwgaGlzdG9yeURpciA8IDA7CgoJCXRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgc2V0dGluZ3MudHJhbnNpdGlvbiwgc2V0dGluZ3MucmV2ZXJzZSApCgkJCS5kb25lKGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tLCBhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcygpOwoKCQkJCS8vaWYgdGhlcmUncyBhIGR1cGxpY2F0ZUNhY2hlZFBhZ2UsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gbm93IHRoYXQgaXQncyBoaWRkZW4KCQkJCWlmICggc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZSApIHsKCQkJCQlzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlLnJlbW92ZSgpOwoJCQkJfQoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gdGhlIG5ld2x5IHNob3duIHBhZ2UuIE1vdmVkIGZyb20gcHJvbWlzZSAuZG9uZSBiaW5kaW5nIGluIHRyYW5zaXRpb25QYWdlcwoJCQkJLy8gaXRzZWxmIHRvIGF2b2lkIGllIGJ1ZyB0aGF0IHJlcG9ydHMgb2Zmc2V0V2lkdGggYXMgPiAwIChjb3JlIGNoZWNrIGZvciB2aXNpYmlsaXR5KQoJCQkJLy8gZGVzcGl0ZSB2aXNpYmlsaXR5OiBoaWRkZW4gYWRkcmVzc2VzIGlzc3VlICMyOTY1CgkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzI5NjUKCQkJCWlmKCAhYWxyZWFkeUZvY3VzZWQgKXsKCQkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoIHRvUGFnZSApOwoJCQkJfQoKCQkJCXJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKTsKCgkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWxsIGRvbmUgY2hhbmdpbmcgdGhlIGN1cnJlbnQgcGFnZS4KCQkJCW1wYy50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgkJCX0pOwoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzID0gewoJCXRyYW5zaXRpb246IHVuZGVmaW5lZCwKCQlyZXZlcnNlOiBmYWxzZSwKCQljaGFuZ2VIYXNoOiB0cnVlLAoJCWZyb21IYXNoQ2hhbmdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlkdXBsaWNhdGVDYWNoZWRQYWdlOiB1bmRlZmluZWQsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCXNob3dMb2FkTXNnOiB0cnVlLCAvL2xvYWRpbmcgbWVzc2FnZSBzaG93cyBieSBkZWZhdWx0IHdoZW4gcGFnZXMgYXJlIGJlaW5nIGZldGNoZWQgZHVyaW5nIGNoYW5nZVBhZ2UKCQlkYXRhVXJsOiB1bmRlZmluZWQsCgkJZnJvbVBhZ2U6IHVuZGVmaW5lZCwKCQlhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbjogZmFsc2UKCX07CgovKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCgl7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCS8vIExvb2sgZm9yIHRoZSBjbG9zZXN0IGVsZW1lbnQgd2l0aCBhIG5vZGVOYW1lIG9mICJhIi4KCQkJLy8gTm90ZSB0aGF0IHdlIGFyZSBjaGVja2luZyBpZiB3ZSBoYXZlIGEgdmFsaWQgbm9kZU5hbWUKCQkJLy8gYmVmb3JlIGF0dGVtcHRpbmcgdG8gYWNjZXNzIGl0LiBUaGlzIGlzIGJlY2F1c2UgdGhlCgkJCS8vIG5vZGUgd2UgZ2V0IGNhbGxlZCB3aXRoIGNvdWxkIGhhdmUgb3JpZ2luYXRlZCBmcm9tIHdpdGhpbgoJCQkvLyBhbiBlbWJlZGRlZCBTVkcgZG9jdW1lbnQgd2hlcmUgc29tZSBzeW1ib2wgaW5zdGFuY2UgZWxlbWVudHMKCQkJLy8gZG9uJ3QgaGF2ZSBub2RlTmFtZSBkZWZpbmVkIG9uIHRoZW0sIG9yIHN0cmluZ3MgYXJlIG9mIHR5cGUKCQkJLy8gU1ZHQW5pbWF0ZWRTdHJpbmcuCgkJCWlmICggKCB0eXBlb2YgZWxlLm5vZGVOYW1lID09PSAic3RyaW5nIiApICYmIGVsZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCS8vIFRoZSBiYXNlIFVSTCBmb3IgYW55IGdpdmVuIGVsZW1lbnQgZGVwZW5kcyBvbiB0aGUgcGFnZSBpdCByZXNpZGVzIGluLgoJZnVuY3Rpb24gZ2V0Q2xvc2VzdEJhc2VVcmwoIGVsZSApCgl7CgkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYWdlIGFuZCBleHRyYWN0IG91dCBpdHMgdXJsLgoJCXZhciB1cmwgPSAkKCBlbGUgKS5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuanFtRGF0YSggInVybCIgKSwKCQkJYmFzZSA9IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoKCQlpZiAoICF1cmwgfHwgIXBhdGguaXNQYXRoKCB1cmwgKSApIHsKCQkJdXJsID0gYmFzZTsKCQl9CgoJCXJldHVybiBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBiYXNlKTsKCX0KCgoJLy9UaGUgZm9sbG93aW5nIGV2ZW50IGJpbmRpbmdzIHNob3VsZCBiZSBib3VuZCBhZnRlciBtb2JpbGVpbml0IGhhcyBiZWVuIHRyaWdnZXJlZAoJLy90aGUgZm9sbG93aW5nIGZ1bmN0aW9uIGlzIGNhbGxlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uKCl7CgoJCS8vYmluZCB0byBmb3JtIHN1Ym1pdCBldmVudHMsIGhhbmRsZSB3aXRoIEFqYXgKCQkkKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiZm9ybSIsICJzdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgdGhlIGZvcm0gaXMsIGl0c2VsZiwgYWpheCBmYWxzZQoJCQkJCSR0aGlzLmlzKCI6anFtRGF0YShhamF4PSdmYWxzZScpIikgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IGFuZAoJCQkJCS8vIHRoZSBmb3JtIG9yIG9uZSBvZiBpdCdzIHBhcmVudHMgaXMgYWpheD1mYWxzZQoJCQkJCSEkdGhpcy5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgdHlwZSA9ICR0aGlzLmF0dHIoICJtZXRob2QiICksCgkJCQl0YXJnZXQgPSAkdGhpcy5hdHRyKCAidGFyZ2V0IiApLAoJCQkJdXJsID0gJHRoaXMuYXR0ciggImFjdGlvbiIgKTsKCgkJCS8vIElmIG5vIGFjdGlvbiBpcyBzcGVjaWZpZWQsIGJyb3dzZXJzIGRlZmF1bHQgdG8gdXNpbmcgdGhlCgkJCS8vIFVSTCBvZiB0aGUgZG9jdW1lbnQgY29udGFpbmluZyB0aGUgZm9ybS4gU2luY2Ugd2UgZHluYW1pY2FsbHkKCQkJLy8gcHVsbCBpbiBwYWdlcyBmcm9tIGV4dGVybmFsIGRvY3VtZW50cywgdGhlIGZvcm0gc2hvdWxkIHN1Ym1pdAoJCQkvLyB0byB0aGUgVVJMIGZvciB0aGUgc291cmNlIGRvY3VtZW50IG9mIHRoZSBwYWdlIGNvbnRhaW5pbmcKCQkJLy8gdGhlIGZvcm0uCgkJCWlmICggIXVybCApIHsKCQkJCS8vIEdldCB0aGUgQGRhdGEtdXJsIGZvciB0aGUgcGFnZSBjb250YWluaW5nIHRoZSBmb3JtLgoJCQkJdXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICR0aGlzICk7CgkJCQlpZiAoIHVybCA9PT0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSB7CgkJCQkJLy8gVGhlIHVybCB3ZSBnb3QgYmFjayBtYXRjaGVzIHRoZSBkb2N1bWVudCBiYXNlLAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoZSBwYWdlIG11c3QgYmUgYW4gaW50ZXJuYWwvZW1iZWRkZWQgcGFnZSwKCQkJCQkvLyBzbyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBhY3R1YWwgZG9jdW1lbnQgdXJsIGFzIGEgYnJvd3NlcgoJCQkJCS8vIHdvdWxkLgoJCQkJCXVybCA9IGRvY3VtZW50VXJsLmhyZWZOb1NlYXJjaDsKCQkJCX0KCQkJfQoKCQkJdXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICB1cmwsIGdldENsb3Nlc3RCYXNlVXJsKCR0aGlzKSApOwoKCQkJLy9leHRlcm5hbCBzdWJtaXRzIHVzZSByZWd1bGFyIEhUVFAKCQkJaWYoIHBhdGguaXNFeHRlcm5hbCggdXJsICkgfHwgdGFyZ2V0ICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKAoJCQkJdXJsLAoJCQkJewoJCQkJCXR5cGU6CQl0eXBlICYmIHR5cGUubGVuZ3RoICYmIHR5cGUudG9Mb3dlckNhc2UoKSB8fCAiZ2V0IiwKCQkJCQlkYXRhOgkJJHRoaXMuc2VyaWFsaXplKCksCgkJCQkJdHJhbnNpdGlvbjoJJHRoaXMuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQkJZGlyZWN0aW9uOgkkdGhpcy5qcW1EYXRhKCAiZGlyZWN0aW9uIiApLAoJCQkJCXJlbG9hZFBhZ2U6CXRydWUKCQkJCX0KCQkJKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQoIGRvY3VtZW50ICkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApOwoKCQkJLy8gc3BsaXQgZnJvbSB0aGUgcHJldmlvdXMgcmV0dXJuIGxvZ2ljIHRvIGF2b2lkIGZpbmQgY2xvc2VzdCB3aGVyZSBwb3NzaWJsZQoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggISQobGluaykuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBsaW5rICkgewoJCQkJaWYgKCBwYXRoLnBhcnNlVXJsKCBsaW5rLmdldEF0dHJpYnV0ZSggImhyZWYiICkgfHwgIiMiICkuaGFzaCAhPT0gIiMiICkgewoJCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoJCQkJCSRhY3RpdmVDbGlja2VkTGluayA9ICQoIGxpbmsgKS5jbG9zZXN0KCAiLnVpLWJ0biIgKS5ub3QoICIudWktZGlzYWJsZWQiICk7CgkJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCSQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgLnVpLWJ0biIgKS5ub3QoIGxpbmsgKS5ibHVyKCk7CgoJCQkJCS8vIEJ5IGNhY2hpbmcgdGhlIGhyZWYgdmFsdWUgdG8gZGF0YSBhbmQgc3dpdGNoaW5nIHRoZSBocmVmIHRvIGEgIywgd2UgY2FuIGF2b2lkIGFkZHJlc3MgYmFyIHNob3dpbmcgaW4gaU9TLiBUaGUgY2xpY2sgaGFuZGxlciByZXNldHMgdGhlIGhyZWYgZHVyaW5nIGl0cyBpbml0aWFsIHN0ZXBzIGlmIHRoaXMgZGF0YSBpcyBwcmVzZW50CgkJCQkJJCggbGluayApCgkJCQkJCS5qcW1EYXRhKCAiaHJlZiIsICQoIGxpbmsgICkuYXR0ciggImhyZWYiICkgICkKCQkJCQkJLmF0dHIoICJocmVmIiwgIiMiICk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJLy8gY2xpY2sgcm91dGluZyAtIGRpcmVjdCB0byBIVFRQIG9yIEFqYXgsIGFjY29yZGluZ2x5CgkJJCggZG9jdW1lbnQgKS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmKCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBsaW5rID0gZmluZENsb3Nlc3RMaW5rKCBldmVudC50YXJnZXQgKSwgJGxpbmsgPSAkKCBsaW5rICksIGh0dHBDbGVhbnVwOwoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggIWxpbmsgfHwgZXZlbnQud2hpY2ggPiAxIHx8ICEkbGluay5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQlodHRwQ2xlYW51cCA9IGZ1bmN0aW9uKCl7CgkJCQl3aW5kb3cuc2V0VGltZW91dCggZnVuY3Rpb24oKSB7IHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOyB9LCAyMDAgKTsKCQkJfTsKCgkJCS8vIElmIHRoZXJlJ3MgZGF0YSBjYWNoZWQgZm9yIHRoZSByZWFsIGhyZWYgdmFsdWUsIHNldCB0aGUgbGluaydzIGhyZWYgYmFjayB0byBpdCBhZ2Fpbi4gVGhpcyBwYWlycyB3aXRoIGFuIGFkZHJlc3MgYmFyIHdvcmthcm91bmQgZnJvbSB0aGUgdmNsaWNrIGhhbmRsZXIKCQkJaWYoICRsaW5rLmpxbURhdGEoICJocmVmIiApICl7CgkJCQkkbGluay5hdHRyKCAiaHJlZiIsICRsaW5rLmpxbURhdGEoICJocmVmIiApICk7CgkJCX0KCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmKCAkbGluay5pcyggIjpqcW1EYXRhKHJlbD0nYmFjaycpIiApICkgewoJCQkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgYmFzZVVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkbGluayApLAoKCQkJCS8vZ2V0IGhyZWYsIGlmIGRlZmluZWQsIG90aGVyd2lzZSBkZWZhdWx0IHRvIGVtcHR5IGhhc2gKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGxpbmsuYXR0ciggImhyZWYiICkgfHwgIiMiLCBiYXNlVXJsICk7CgoJCQkvL2lmIGFqYXggaXMgZGlzYWJsZWQsIGV4aXQgZWFybHkKCQkJaWYoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICl7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPSAtMSApIHsKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJCS8vIFNob3VsZCB3ZSBoYW5kbGUgdGhpcyBsaW5rLCBvciBsZXQgdGhlIGJyb3dzZXIgZGVhbCB3aXRoIGl0PwoJCQl2YXIgdXNlRGVmYXVsdFVybEhhbmRsaW5nID0gJGxpbmsuaXMoICJbcmVsPSdleHRlcm5hbCddIiApIHx8ICRsaW5rLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fCAkbGluay5pcyggIlt0YXJnZXRdIiApLAoKCQkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCQlpc0Nyb3NzRG9tYWluUGFnZUxvYWQgPSAoICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJiBkb2N1bWVudFVybC5wcm90b2NvbCA9PT0gImZpbGU6IiAmJiBocmVmLnNlYXJjaCggL15odHRwcz86LyApICE9IC0xICksCgoJCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJCS8vVE9ETyBvdmVybGFwIGluIGxvZ2ljIGZyb20gaXNFeHRlcm5hbCwgcmVsPWV4dGVybmFsIGNoZWNrIHNob3VsZCBiZQoJCQkJLy8gICAgIG1vdmVkIGludG8gbW9yZSBjb21wcmVoZW5zaXZlIGlzRXh0ZXJuYWxMaW5rCgkJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggcGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgIWlzQ3Jvc3NEb21haW5QYWdlTG9hZCApOwoKCQkJaWYoIGlzRXh0ZXJuYWwgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3VzZSBhamF4CgkJCXZhciB0cmFuc2l0aW9uID0gJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQlkaXJlY3Rpb24gPSAkbGluay5qcW1EYXRhKCAiZGlyZWN0aW9uIiApLAoJCQkJcmV2ZXJzZSA9ICggZGlyZWN0aW9uICYmIGRpcmVjdGlvbiA9PT0gInJldmVyc2UiICkgfHwKCQkJCQkJCS8vIGRlcHJlY2F0ZWQgLSByZW1vdmUgYnkgMS4wCgkJCQkJCQkkbGluay5qcW1EYXRhKCAiYmFjayIgKSwKCgkJCQkvL3RoaXMgbWF5IG5lZWQgdG8gYmUgbW9yZSBzcGVjaWZpYyBhcyB3ZSB1c2UgZGF0YS1yZWwgbW9yZQoJCQkJcm9sZSA9ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfHwgdW5kZWZpbmVkOwoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggaHJlZiwgeyB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCByZXZlcnNlOiByZXZlcnNlLCByb2xlOiByb2xlIH0gKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9wcmVmZXRjaCBwYWdlcyB3aGVuIGFuY2hvcnMgd2l0aCBkYXRhLXByZWZldGNoIGFyZSBlbmNvdW50ZXJlZAoJCSQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICIudWktcGFnZSIsICJwYWdlc2hvdy5wcmVmZXRjaCIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgdXJscyA9IFtdOwoJCQkkKCB0aGlzICkuZmluZCggImE6anFtRGF0YShwcmVmZXRjaCkiICkuZWFjaChmdW5jdGlvbigpewoJCQkJdmFyICRsaW5rID0gJCh0aGlzKSwKCQkJCQl1cmwgPSAkbGluay5hdHRyKCAiaHJlZiIgKTsKCgkJCQlpZiAoIHVybCAmJiAkLmluQXJyYXkoIHVybCwgdXJscyApID09PSAtMSApIHsKCQkJCQl1cmxzLnB1c2goIHVybCApOwoKCQkJCQkkLm1vYmlsZS5sb2FkUGFnZSggdXJsLCB7cm9sZTogJGxpbmsuYXR0cigiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIil9ICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoKCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSA9IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQl2YXIgdG8gPSBwYXRoLnN0cmlwSGFzaCggaGFzaCApLAoJCQkJLy90cmFuc2l0aW9uIGlzIGZhbHNlIGlmIGl0J3MgdGhlIGZpcnN0IHBhZ2UsIHVuZGVmaW5lZCBvdGhlcndpc2UgKGFuZCBtYXkgYmUgb3ZlcnJpZGRlbiBieSBkZWZhdWx0KQoJCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnVybEhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAwID8gIm5vbmUiIDogdW5kZWZpbmVkLAoKCQkJCS8vIGRlZmF1bHQgb3B0aW9ucyBmb3IgdGhlIGNoYW5nUGFnZSBjYWxscyBtYWRlIGFmdGVyIGV4YW1pbmluZyB0aGUgY3VycmVudCBzdGF0ZQoJCQkJLy8gb2YgdGhlIHBhZ2UgYW5kIHRoZSBoYXNoCgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQl0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLAoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlCgkJCQl9OwoKCQkJLy9pZiBsaXN0ZW5pbmcgaXMgZGlzYWJsZWQgKGVpdGhlciBnbG9iYWxseSBvciB0ZW1wb3JhcmlseSksIG9yIGl0J3MgYSBkaWFsb2cgaGFzaAoJCQlpZiggISQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkIHx8IHVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgKSB7CgkJCQl1cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlID0gZmFsc2U7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIHNwZWNpYWwgY2FzZSBmb3IgZGlhbG9ncwoJCQlpZiggdXJsSGlzdG9yeS5zdGFjay5sZW5ndGggPiAxICYmIHRvLmluZGV4T2YoIGRpYWxvZ0hhc2hLZXkgKSA+IC0xICkgewoKCQkJCS8vIElmIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgbm90IGEgZGlhbG9nIHNraXAgdGhlIGRpYWxvZyBhbmQgY29udGludWUKCQkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQkJaWYoISQubW9iaWxlLmFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApKSB7CgkJCQkJLy9kZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZSBhY2NvcmRpbmdseSBwYXN0CgkJCQkJLy90aGUgY3VycmVudCBkaWFsb2cKCQkJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJCQljdXJyZW50VXJsOiB0bywKCQkJCQkJaXNCYWNrOiBmdW5jdGlvbigpIHsgd2luZG93Lmhpc3RvcnkuYmFjaygpOyB9LAoJCQkJCQlpc0ZvcndhcmQ6IGZ1bmN0aW9uKCkgeyB3aW5kb3cuaGlzdG9yeS5mb3J3YXJkKCk7IH0KCQkJCQl9KTsKCgkJCQkJLy8gcHJldmVudCBjaGFuZ2VQYWdlKCkKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgewoJCQkJCS8vIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIGEgZGlhbG9nIGFuZCB3ZSdyZSBuYXZpZ2F0aW5nCgkJCQkJLy8gdG8gYSBkaWFsb2cgdXNlIHRoZSBkaWFsb2cgb2JqZWN0ZWQgc2F2ZWQgaW4gdGhlIHN0YWNrCgkJCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCQkJY3VycmVudFVybDogdG8sCgoJCQkJCQkvLyByZWdhcmRsZXNzIG9mIHRoZSBkaXJlY3Rpb24gb2YgdGhlIGhpc3RvcnkgY2hhbmdlCgkJCQkJCS8vIGRvIHRoZSBmb2xsb3dpbmcKCQkJCQkJZWl0aGVyOiBmdW5jdGlvbiggaXNCYWNrICkgewoJCQkJCQkJdmFyIGFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCk7CgoJCQkJCQkJdG8gPSBhY3RpdmUucGFnZVVybDsKCgkJCQkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSByb2xlLCB0cmFuc2l0aW9uIGFuZCByZXZlcnNhbAoJCQkJCQkJLy8gYXMgbW9zdCBvZiB0aGlzIGlzIGxvc3QgYnkgdGhlIGRvbUNhY2hlIGNsZWFuaW5nCgkJCQkJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIHsKCQkJCQkJCQlyb2xlOiBhY3RpdmUucm9sZSwKCQkJCQkJCQl0cmFuc2l0aW9uOgkgYWN0aXZlLnRyYW5zaXRpb24sCgkJCQkJCQkJcmV2ZXJzZTogaXNCYWNrCgkJCQkJCQl9KTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfQoJCQl9CgoJCQkvL2lmIHRvIGlzIGRlZmluZWQsIGxvYWQgaXQKCQkJaWYgKCB0byApIHsKCQkJCS8vIEF0IHRoaXMgcG9pbnQsICd0bycgY2FuIGJlIG9uZSBvZiAzIHRoaW5ncywgYSBjYWNoZWQgcGFnZSBlbGVtZW50IGZyb20KCQkJCS8vIGEgaGlzdG9yeSBzdGFjayBlbnRyeSwgYW4gaWQsIG9yIHNpdGUtcmVsYXRpdmUvYWJzb2x1dGUgVVJMLiBJZiAndG8nIGlzCgkJCQkvLyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QgdGhlIGRvY3VtZW50QmFzZSwgbm90IHRoZSBsb2NhdGlvbi5ocmVmLAoJCQkJLy8gc2luY2UgdGhlIGhhc2hjaGFuZ2UgY291bGQndmUgYmVlbiB0aGUgcmVzdWx0IG9mIGEgZm9yd2FyZC9iYWNrd2FyZCBuYXZpZ2F0aW9uCgkJCQkvLyB0aGF0IGNyb3NzZXMgZnJvbSBhbiBleHRlcm5hbCBwYWdlL2RpYWxvZyB0byBhbiBpbnRlcm5hbCBwYWdlL2RpYWxvZy4KCQkJCXRvID0gKCB0eXBlb2YgdG8gPT09ICJzdHJpbmciICYmICFwYXRoLmlzUGF0aCggdG8gKSApID8gKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJyMnICsgdG8sIGRvY3VtZW50QmFzZSApICkgOiB0bzsKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIHRvLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCQl9CWVsc2UgewoJCQkJLy90aGVyZSdzIG5vIGhhc2gsIGdvIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBkb20KCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQoJCX07CgoJCS8vaGFzaGNoYW5nZSBldmVudCBoYW5kbGVyCgkJJHdpbmRvdy5iaW5kKCAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCBlLCB0cmlnZ2VyZWQgKSB7CgkJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlKCBsb2NhdGlvbi5oYXNoICk7CgkJfSk7CgoJCS8vc2V0IHBhZ2UgbWluLWhlaWdodHMgdG8gYmUgZGV2aWNlIHNwZWNpZmljCgkJJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZXNob3ciLCByZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCQkkKCB3aW5kb3cgKS5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgcmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgoJfTsvL19yZWdpc3RlckludGVybmFsRXZlbnRzIGNhbGxiYWNrCgp9KSggalF1ZXJ5ICk7CgooIGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyBGb3Igbm93LCBsZXQncyBNb25rZXlwYXRjaCB0aGlzIG9udG8gdGhlIGVuZCBvZiAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cwoJLy8gU2NvcGUgc2VsZiB0byBwdXNoU3RhdGVIYW5kbGVyIHNvIHdlIGNhbiByZWZlcmVuY2UgaXQgc2FuZWx5IHdpdGhpbiB0aGUKCS8vIG1ldGhvZHMgaGFuZGVkIG9mZiBhcyBldmVudCBoYW5kbGVycwoJdmFyCXB1c2hTdGF0ZUhhbmRsZXIgPSB7fSwKCQlzZWxmID0gcHVzaFN0YXRlSGFuZGxlciwKCQkkd2luID0gJCggd2luZG93ICksCgkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggbG9jYXRpb24uaHJlZiApOwoKCSQuZXh0ZW5kKCBwdXNoU3RhdGVIYW5kbGVyLCB7CgkJLy8gVE9ETyBtb3ZlIHRvIGEgcGF0aCBoZWxwZXIsIHRoaXMgaXMgcmF0aGVyIGNvbW1vbiBmdW5jdGlvbmFsaXR5CgkJaW5pdGlhbEZpbGVQYXRoOiAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiB1cmwucGF0aG5hbWUgKyB1cmwuc2VhcmNoOwoJCX0pKCksCgoJCWluaXRpYWxIcmVmOiB1cmwuaHJlZk5vSGFzaCwKCgkJc3RhdGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gewoJCQkJaGFzaDogbG9jYXRpb24uaGFzaCB8fCAiIyIgKyBzZWxmLmluaXRpYWxGaWxlUGF0aCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZSwKCgkJCQkvLyBwZXJzaXN0IGFjcm9zcyByZWZyZXNoCgkJCQlpbml0aWFsSHJlZjogc2VsZi5pbml0aWFsSHJlZgoJCQl9OwoJCX0sCgoJCXJlc2V0VUlLZXlzOiBmdW5jdGlvbiggdXJsICkgewoJCQl2YXIgZGlhbG9nID0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleSwKCQkJCXN1YmtleSA9ICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXksCgkJCQlkaWFsb2dJbmRleCA9IHVybC5pbmRleE9mKCBkaWFsb2cgKTsKCgkJCWlmKCBkaWFsb2dJbmRleCA+IC0xICkgewoJCQkJdXJsID0gdXJsLnNsaWNlKCAwLCBkaWFsb2dJbmRleCApICsgIiMiICsgdXJsLnNsaWNlKCBkaWFsb2dJbmRleCApOwoJCQl9IGVsc2UgaWYoIHVybC5pbmRleE9mKCBzdWJrZXkgKSA+IC0xICkgewoJCQkJdXJsID0gdXJsLnNwbGl0KCBzdWJrZXkgKS5qb2luKCAiIyIgKyBzdWJrZXkgKTsKCQkJfQoKCQkJcmV0dXJuIHVybDsKCQl9LAoKCQloYXNoVmFsdWVBZnRlclJlc2V0OiBmdW5jdGlvbiggdXJsICkgewoJCQl2YXIgcmVzZXRVcmwgPSBzZWxmLnJlc2V0VUlLZXlzKCB1cmwgKTsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGgucGFyc2VVcmwoIHJlc2V0VXJsICkuaGFzaDsKCQl9LAoKCQkvLyBUT0RPIHNvcnQgb3V0IGEgc2luZ2xlIGJhcnJpZXIgdG8gaGFzaGNoYW5nZSBmdW5jdGlvbmFsaXR5CgkJbmV4dEhhc2hDaGFuZ2VQcmV2ZW50ZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJJC5tb2JpbGUudXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSA9IHZhbHVlOwoJCQlzZWxmLm9uSGFzaENoYW5nZURpc2FibGVkID0gdmFsdWU7CgkJfSwKCgkJLy8gb24gaGFzaCBjaGFuZ2Ugd2Ugd2FudCB0byBjbGVhbiB1cCB0aGUgdXJsCgkJLy8gTk9URSB0aGlzIHRha2VzIHBsYWNlICphZnRlciogdGhlIHZhbmlsbGEgbmF2aWdhdGlvbiBoYXNoIGNoYW5nZQoJCS8vIGhhbmRsaW5nIGhhcyB0YWtlbiBwbGFjZSBhbmQgc2V0IHRoZSBzdGF0ZSBvZiB0aGUgRE9NCgkJb25IYXNoQ2hhbmdlOiBmdW5jdGlvbiggZSApIHsKCQkJLy8gZGlzYWJsZSB0aGlzIGhhc2ggY2hhbmdlCgkJCWlmKCBzZWxmLm9uSGFzaENoYW5nZURpc2FibGVkICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBocmVmLCBzdGF0ZSwKCQkJCWhhc2ggPSBsb2NhdGlvbi5oYXNoLAoJCQkJaXNQYXRoID0gJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSwKCQkJCXJlc29sdXRpb25VcmwgPSBpc1BhdGggPyBsb2NhdGlvbi5ocmVmIDogJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwoKTsKCgkJCWhhc2ggPSBpc1BhdGggPyBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6IGhhc2g7CgoKCQkJLy8gcHJvcHVsYXRlIHRoZSBoYXNoIHdoZW4gaXRzIG5vdCBhdmFpbGFibGUKCQkJc3RhdGUgPSBzZWxmLnN0YXRlKCk7CgoJCQkvLyBtYWtlIHRoZSBoYXNoIGFib2x1dGUgd2l0aCB0aGUgY3VycmVudCBocmVmCgkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaGFzaCwgcmVzb2x1dGlvblVybCApOwoKCQkJaWYgKCBpc1BhdGggKSB7CgkJCQlocmVmID0gc2VsZi5yZXNldFVJS2V5cyggaHJlZiApOwoJCQl9CgoJCQkvLyByZXBsYWNlIHRoZSBjdXJyZW50IHVybCB3aXRoIHRoZSBuZXcgaHJlZiBhbmQgc3RvcmUgdGhlIHN0YXRlCgkJCS8vIE5vdGUgdGhhdCBpbiBzb21lIGNhc2VzIHdlIG1pZ2h0IGJlIHJlcGxhY2luZyBhbiB1cmwgd2l0aCB0aGUKCQkJLy8gc2FtZSB1cmwuIFdlIGRvIHRoaXMgYW55d2F5cyBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQKCQkJLy8gYWxsIG9mIG91ciBoaXN0b3J5IGVudHJpZXMgaGF2ZSBhIHN0YXRlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGgKCQkJLy8gdGhlbS4gVGhpcyBhbGxvd3MgdXMgdG8gd29yayBhcm91bmQgdGhlIGNhc2Ugd2hlcmUgd2luZG93Lmhpc3RvcnkuYmFjaygpCgkJCS8vIGlzIGNhbGxlZCB0byB0cmFuc2l0aW9uIGZyb20gYW4gZXh0ZXJuYWwgcGFnZSB0byBhbiBlbWJlZGRlZCBwYWdlLgoJCQkvLyBJbiB0aGF0IHBhcnRpY3VsYXIgY2FzZSwgYSBoYXNoY2hhbmdlIGV2ZW50IGlzICpOT1QqIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4KCQkJLy8gRW5zdXJpbmcgZWFjaCBoaXN0b3J5IGVudHJ5IGhhcyBhIHN0YXRlIG9iamVjdCBtZWFucyB0aGF0IG9uUG9wU3RhdGUoKQoJCQkvLyB3aWxsIGFsd2F5cyB0cmlnZ2VyIG91ciBoYXNoY2hhbmdlIGNhbGxiYWNrIGV2ZW4gd2hlbiBhIGhhc2hjaGFuZ2UgZXZlbnQKCQkJLy8gaXMgbm90IGZpcmVkLgoJCQloaXN0b3J5LnJlcGxhY2VTdGF0ZSggc3RhdGUsIGRvY3VtZW50LnRpdGxlLCBocmVmICk7CgkJfSwKCgkJLy8gb24gcG9wc3RhdGUgKGllIGJhY2sgb3IgZm9yd2FyZCkgd2UgbmVlZCB0byByZXBsYWNlIHRoZSBoYXNoIHRoYXQgd2FzIHRoZXJlIHByZXZpb3VzbHkKCQkvLyBjbGVhbmVkIHVwIGJ5IHRoZSBhZGRpdGlvbmFsIGhhc2ggaGFuZGxpbmcKCQlvblBvcFN0YXRlOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHBvcHBlZFN0YXRlID0gZS5vcmlnaW5hbEV2ZW50LnN0YXRlLAoJCQkJdGltZW91dCwgZnJvbUhhc2gsIHRvSGFzaCwgaGFzaENoYW5nZWQ7CgoJCQkvLyBpZiB0aGVyZSdzIG5vIHN0YXRlIGl0cyBub3QgYSBwb3BzdGF0ZSB3ZSBjYXJlIGFib3V0LCBlZyBjaHJvbWUncyBpbml0aWFsIHBvcHN0YXRlCgkJCWlmKCBwb3BwZWRTdGF0ZSApIHsKCQkJCS8vIHRoZSBhY3RpdmUgdXJsIGluIHRoZSBoaXN0b3J5IHN0YWNrIHdpbGwgc3RpbGwgYmUgZnJvbSB0aGUgcHJldmlvdXMgc3RhdGUKCQkJCS8vIHNvIHdlIGNhbiB1c2UgaXQgdG8gdmVyaWZ5IGlmIGEgaGFzaGNoYW5nZSB3aWxsIGJlIGZpcmVkIGZyb20gdGhlIHBvcHN0YXRlCgkJCQlmcm9tSGFzaCA9IHNlbGYuaGFzaFZhbHVlQWZ0ZXJSZXNldCggJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKS51cmwgKTsKCgkJCQkvLyB0aGUgaGFzaCBzdG9yZWQgaW4gdGhlIHN0YXRlIHBvcHBlZCBvZmYgdGhlIHN0YWNrIHdpbGwgYmUgb3VyIGN1cnJlbnR1cmwgb3IKCQkJCS8vIHRoZSB1cmwgdG8gd2hpY2ggd2Ugd2lzaCB0byBuYXZpZ2F0ZQoJCQkJdG9IYXNoID0gc2VsZi5oYXNoVmFsdWVBZnRlclJlc2V0KCBwb3BwZWRTdGF0ZS5oYXNoLnJlcGxhY2UoIiMiLCAiIikgKTsKCgkJCQkvLyBpZiB0aGUgaGFzaGVzIG9mIHRoZSB1cmxzIGFyZSBkaWZmZXJlbnQgd2UgbXVzdCBhc3N1bWUgdGhhdCB0aGUgYnJvd3NlcgoJCQkJLy8gd2lsbCBmaXJlIGEgaGFzaGNoYW5nZQoJCQkJaGFzaENoYW5nZWQgPSBmcm9tSGFzaCAhPT0gdG9IYXNoOwoKCQkJCS8vIHVubG9jayBoYXNoIGhhbmRsaW5nIG9uY2UgdGhlIGhhc2hjaGFuZ2UgY2F1c2VkIGJlIHRoZSBwb3BzdGF0ZSBoYXMgZmlyZWQKCQkJCWlmKCBoYXNoQ2hhbmdlZCApIHsKCQkJCQkkd2luLm9uZSggImhhc2hjaGFuZ2UucHVzaHN0YXRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJCXNlbGYubmV4dEhhc2hDaGFuZ2VQcmV2ZW50ZWQoIGZhbHNlICk7CgkJCQkJfSk7CgkJCQl9CgoJCQkJLy8gZW5hYmxlIGhhc2ggaGFuZGxpbmcgZm9yIHRoZSB0aGUgX2hhbmRsZUhhc2hDaGFuZ2UgY2FsbAoJCQkJc2VsZi5uZXh0SGFzaENoYW5nZVByZXZlbnRlZCggZmFsc2UgKTsKCgkJCQkvLyBjaGFuZ2UgdGhlIHBhZ2UgYmFzZWQgb24gdGhlIGhhc2gKCQkJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlKCBwb3BwZWRTdGF0ZS5oYXNoICk7CgoJCQkJLy8gb25seSBwcmV2ZW50IGFub3RoZXIgaGFzaCBjaGFuZ2UgaGFuZGxpbmcgaWYgYSBoYXNoIGNoYW5nZSB3aWxsIGJlIGZpcmVkCgkJCQkvLyBieSB0aGUgYnJvd3NlcgoJCQkJaWYoIGhhc2hDaGFuZ2VkICkgewoJCQkJCS8vIGRpc2FibGUgaGFzaCBoYW5kbGluZyB1bnRpbCBvbmUgb2YgdGhlIGFib3ZlIHRpbWVycyBmaXJlcwoJCQkJCXNlbGYubmV4dEhhc2hDaGFuZ2VQcmV2ZW50ZWQoIHRydWUgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCWluaXQ6IGZ1bmN0aW9uKCkgewoJCQkkd2luLmJpbmQoICJoYXNoY2hhbmdlIiwgc2VsZi5vbkhhc2hDaGFuZ2UgKTsKCgkJCS8vIEhhbmRsZSBwb3BzdGF0ZSBldmVudHMgdGhlIG9jY3VyIHRocm91Z2ggaGlzdG9yeSBjaGFuZ2VzCgkJCSR3aW4uYmluZCggInBvcHN0YXRlIiwgc2VsZi5vblBvcFN0YXRlICk7CgoJCQkvLyBpZiB0aGVyZSdzIG5vIGhhc2gsIHdlIG5lZWQgdG8gcmVwbGFjZXN0YXRlIGZvciByZXR1cm5pbmcgdG8gaG9tZQoJCQlpZiAoIGxvY2F0aW9uLmhhc2ggPT09ICIiICkgewoJCQkJaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHNlbGYuc3RhdGUoKSwgZG9jdW1lbnQudGl0bGUsIGxvY2F0aW9uLmhyZWYgKTsKCQkJfQoJCX0KCX0pOwoKCSQoIGZ1bmN0aW9uKCkgewoJCWlmKCAkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkICYmICQuc3VwcG9ydC5wdXNoU3RhdGUgKXsKCQkJcHVzaFN0YXRlSGFuZGxlci5pbml0KCk7CgkJfQoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgcG9wIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5wb3AgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciBzbGlkZSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2xpZGUgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2ltdWx0YW5lb3VzOwoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9uJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZG93biBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVkb3duID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZXVwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZXVwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbGlwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbGlwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciB0dXJuIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy50dXJuID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07CgoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCgl2YXIgcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSgkKGUudGFyZ2V0KSksIG9wdGlvbnM7CgoJaWYoICFwYWdlICkgewoJCXJldHVybjsKCX0KCglvcHRpb25zID0gcGFnZS5vcHRpb25zOwoKCS8vIGRlZ3JhZGUgaW5wdXRzIHRvIGF2b2lkIHBvb3JseSBpbXBsZW1lbnRlZCBuYXRpdmUgZnVuY3Rpb25hbGl0eQoJJCggZS50YXJnZXQgKS5maW5kKCAiaW5wdXQiICkubm90KCBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpICkuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSB8fCAidGV4dCI7CgoJCWlmICggb3B0aW9ucy5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gKSB7CgkJCXZhciBodG1sID0gJCggIjxkaXY+IiApLmh0bWwoICR0aGlzLmNsb25lKCkgKS5odG1sKCksCgkJCQkvLyBJbiBJRSBicm93c2VycywgdGhlIHR5cGUgc29tZXRpbWVzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNsb25lZCBtYXJrdXAsIHNvIHdlIHJlcGxhY2UgdGhlIGNsb3NpbmcgdGFnIGluc3RlYWQKCQkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMSwKCQkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi8sCgkJCQlyZXBzdHIgPSAiIHR5cGU9XCIiICsgb3B0VHlwZSArICJcIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPVwiIiArIHR5cGUgKyAiXCIiICsgKCBoYXNUeXBlID8gIiIgOiAiPiIgKTsKCgkJCSR0aGlzLnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQljbG9zZUJ0blRleHQgCTogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWUJOiAiYSIsCgkJaW5pdFNlbGVjdG9yCTogIjpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQloZWFkZXJDbG9zZUJ1dHRvbiA9ICQoICI8YSBocmVmPScjJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uPSdkZWxldGUnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3M9J25vdGV4dCc+IisgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCArICI8L2E+IiApLAoJCQlkaWFsb2dXcmFwID0gJCgiPGRpdi8+IiwgewoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktY29ybmVyLWFsbCB1aS1vdmVybGF5LXNoYWRvdyIKCQkJCX0pOwoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaWFsb2cgdWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCQoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nCgkJLy8gU2V0IGFyaWEgcm9sZQoJCSRlbAoJCQkud3JhcElubmVyKCBkaWFsb2dXcmFwICkKCQkJLmNoaWxkcmVuKCkKCQkJCS5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkKCQkJCQkucHJlcGVuZCggaGVhZGVyQ2xvc2VCdXR0b24gKQoJCQkJLmVuZCgpCgkJCQkuY2hpbGRyZW4oICc6Zmlyc3QtY2hpbGQnKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICkKCQkJCS5lbmQoKQoJCQkJLmNoaWxkcmVuKCAiOmxhc3QtY2hpbGQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApOwoKCQkvLyB0aGlzIG11c3QgYmUgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgc2VsZWN0IG1lbnUgZGlhbG9ncyBjYW4gcmVwbGFjZQoJCS8vIHRoZSBjbG9zZSBtZXRob2QuIFRoaXMgaXMgYSBjaGFuZ2UgZnJvbSBwcmV2aW91c2x5IGp1c3QgZGVmaW5pbmcgZGF0YS1yZWw9YmFjawoJCS8vIG9uIHRoZSBidXR0b24gYW5kIGxldHRpbmcgbmF2IGhhbmRsZSBpdAoJCS8vCgkJLy8gVXNlIGNsaWNrIHJhdGhlciB0aGFuIHZjbGljayBpbiBvcmRlciB0byBwcmV2ZW50IHRoZSBwb3NzaWJpbGl0eSBvZiB1bmludGVudGlvbmFsbHkKCQkvLyByZW9wZW5pbmcgdGhlIGRpYWxvZyBpZiB0aGUgZGlhbG9nIG9wZW5pbmcgaXRlbSB3YXMgZGlyZWN0bHkgdW5kZXIgdGhlIGNsb3NlIGJ1dHRvbi4KCQloZWFkZXJDbG9zZUJ1dHRvbi5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJc2VsZi5jbG9zZSgpOwoJCX0pOwoKCQkvKiBiaW5kIGV2ZW50cwoJCQktIGNsaWNrcyBhbmQgc3VibWl0cyBzaG91bGQgdXNlIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24gdGhhdCB0aGUgZGlhbG9nIG9wZW5lZCB3aXRoCgkJCSAgdW5sZXNzIGEgZGF0YS10cmFuc2l0aW9uIGlzIHNwZWNpZmllZCBvbiB0aGUgbGluay9mb3JtCgkJCS0gaWYgdGhlIGNsaWNrIHdhcyBvbiB0aGUgY2xvc2UgYnV0dG9uLCBvciB0aGUgbGluayBoYXMgYSBkYXRhLXJlbD0iYmFjayIgaXQnbGwgZ28gYmFjayBpbiBoaXN0b3J5IG5hdHVyYWxseQoJCSovCgkJJGVsLmJpbmQoICJ2Y2xpY2sgc3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siID8gImEiIDogImZvcm0iICksCgkJCQlhY3RpdmU7CgoJCQlpZiAoICR0YXJnZXQubGVuZ3RoICYmICEkdGFyZ2V0LmpxbURhdGEoICJ0cmFuc2l0aW9uIiApICkgewoKCQkJCWFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCkgfHwge307CgoJCQkJJHRhcmdldC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHJhbnNpdGlvbiIsICggYWN0aXZlLnRyYW5zaXRpb24gfHwgJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gKSApCgkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXJlY3Rpb24iLCAicmV2ZXJzZSIgKTsKCQkJfQoJCX0pCgkJLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJJCggdGhpcyApLmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSkKCQkvLyBPdmVycmlkZSB0aGUgdGhlbWUgc2V0IGJ5IHRoZSBwYWdlIHBsdWdpbiBvbiBwYWdlc2hvdwoJCS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpewoJCQlpZiggc2VsZi5vcHRpb25zLm92ZXJsYXlUaGVtZSApewoJCQkJc2VsZi5lbGVtZW50CgkJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkJLnBhZ2UoICJzZXRDb250YWluZXJCYWNrZ3JvdW5kIiwgc2VsZi5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgInBhZ2VjcmVhdGUiLCBmdW5jdGlvbigpewoJJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5lbmhhbmNlKCB0aGlzICk7Cn0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIHVpLWJvZHkgdWktYnIiICk7Cn07CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJCggIjpqcW1EYXRhKHJvbGU9J2ZpZWxkY29udGFpbicpIiwgZS50YXJnZXQgKS5qcW1FbmhhbmNlYWJsZSgpLmZpZWxkY29udGFpbigpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5ncmlkID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQlncmlkOiBudWxsCgkJCX0sb3B0aW9ucyksCgkJCSRraWRzID0gJHRoaXMuY2hpbGRyZW4oKSwKCQkJZ3JpZENvbHMgPSB7c29sbzoxLCBhOjIsIGI6MywgYzo0LCBkOjV9LAoJCQlncmlkID0gby5ncmlkLAoJCQlpdGVyYXRvcjsKCgkJCWlmICggIWdyaWQgKSB7CgkJCQlpZiAoICRraWRzLmxlbmd0aCA8PSA1ICkgewoJCQkJCWZvciAoIHZhciBsZXR0ZXIgaW4gZ3JpZENvbHMgKSB7CgkJCQkJCWlmICggZ3JpZENvbHNbIGxldHRlciBdID09PSAka2lkcy5sZW5ndGggKSB7CgkJCQkJCQlncmlkID0gbGV0dGVyOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlncmlkID0gImEiOwoJCQkJfQoJCQl9CgkJCWl0ZXJhdG9yID0gZ3JpZENvbHNbZ3JpZF07CgoJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC0iICsgZ3JpZCApOwoKCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzEpIiApLmFkZENsYXNzKCAidWktYmxvY2stYSIgKTsKCgkJaWYgKCBpdGVyYXRvciA+IDEgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMikiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1iIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMiApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgzbiszKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWMiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAzICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKDRuKzQpIiApLmFkZENsYXNzKCAidWktYmxvY2stZCIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDQgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoNW4rNSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1lIiApOwoJCX0KCX0pOwp9Owp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCBlLnRhcmdldCApLmFkZENsYXNzKCAidWktbm9qcyIgKTsKCQp9KTsKCn0pKCBqUXVlcnkgKTsKCiggZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uYnV0dG9uTWFya3VwID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7Cgl2YXIgJHdvcmtpbmdTZXQgPSB0aGlzOwoKCS8vIEVuZm9yY2Ugb3B0aW9ucyB0byBiZSBvZiB0eXBlIHN0cmluZwoJb3B0aW9ucyA9ICggb3B0aW9ucyAmJiAoICQudHlwZSggb3B0aW9ucyApID09ICJvYmplY3QiICkgKT8gb3B0aW9ucyA6IHt9OwoJZm9yICggdmFyIGkgPSAwOyBpIDwgJHdvcmtpbmdTZXQubGVuZ3RoOyBpKysgKSB7CgkJdmFyIGVsID0gJHdvcmtpbmdTZXQuZXEoIGkgKSwKCQkJZSA9IGVsWyAwIF0sCgkJCW8gPSAkLmV4dGVuZCgge30sICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzLCB7CgkJCQlpY29uOiAgICAgICBvcHRpb25zLmljb24gICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbiAgICAgICA6IGVsLmpxbURhdGEoICJpY29uIiApLAoJCQkJaWNvbnBvczogICAgb3B0aW9ucy5pY29ucG9zICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25wb3MgICAgOiBlbC5qcW1EYXRhKCAiaWNvbnBvcyIgKSwKCQkJCXRoZW1lOiAgICAgIG9wdGlvbnMudGhlbWUgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy50aGVtZSAgICAgIDogZWwuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICksCgkJCQlpbmxpbmU6ICAgICBvcHRpb25zLmlubGluZSAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaW5saW5lICAgICA6IGVsLmpxbURhdGEoICJpbmxpbmUiICksCgkJCQlzaGFkb3c6ICAgICBvcHRpb25zLnNoYWRvdyAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc2hhZG93ICAgICA6IGVsLmpxbURhdGEoICJzaGFkb3ciICksCgkJCQljb3JuZXJzOiAgICBvcHRpb25zLmNvcm5lcnMgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY29ybmVycyAgICA6IGVsLmpxbURhdGEoICJjb3JuZXJzIiApLAoJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25zaGFkb3cgOiBlbC5qcW1EYXRhKCAiaWNvbnNoYWRvdyIgKSwKCQkJCW1pbmk6ICAgICAgIG9wdGlvbnMubWluaSAgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5taW5pICAgICAgIDogZWwuanFtRGF0YSggIm1pbmkiICkKCQkJfSwgb3B0aW9ucyApLAoKCQkJLy8gQ2xhc3NlcyBEZWZpbmVkCgkJCWlubmVyQ2xhc3MgPSAidWktYnRuLWlubmVyIiwKCQkJdGV4dENsYXNzID0gInVpLWJ0bi10ZXh0IiwKCQkJYnV0dG9uQ2xhc3MsIGljb25DbGFzcywKCQkJLy8gQnV0dG9uIGlubmVyIG1hcmt1cAoJCQlidXR0b25Jbm5lciwKCQkJYnV0dG9uVGV4dCwKCQkJYnV0dG9uSWNvbiwKCQkJYnV0dG9uRWxlbWVudHM7CgoJCSQuZWFjaChvLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CgkJCWUuc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBrZXksIHZhbHVlICk7CgkJCWVsLmpxbURhdGEoa2V5LCB2YWx1ZSk7CgkJfSk7CgoJCS8vIENoZWNrIGlmIHRoaXMgZWxlbWVudCBpcyBhbHJlYWR5IGVuaGFuY2VkCgkJYnV0dG9uRWxlbWVudHMgPSAkLmRhdGEoKChlLnRhZ05hbWUgPT09ICJJTlBVVCIgfHwgZS50YWdOYW1lID09PSAiQlVUVE9OIikgPyBlLnBhcmVudE5vZGUgOiBlKSwgImJ1dHRvbkVsZW1lbnRzIik7CgoJCWlmIChidXR0b25FbGVtZW50cykgewoJCQllID0gYnV0dG9uRWxlbWVudHMub3V0ZXI7CgkJCWVsID0gJChlKTsKCQkJYnV0dG9uSW5uZXIgPSBidXR0b25FbGVtZW50cy5pbm5lcjsKCQkJYnV0dG9uVGV4dCA9IGJ1dHRvbkVsZW1lbnRzLnRleHQ7CgkJCS8vIFdlIHdpbGwgcmVjcmVhdGUgdGhpcyBpY29uIGJlbG93CgkJCSQoYnV0dG9uRWxlbWVudHMuaWNvbikucmVtb3ZlKCk7CgkJCWJ1dHRvbkVsZW1lbnRzLmljb24gPSBudWxsOwoJCX0KCQllbHNlIHsKCQkJYnV0dG9uSW5uZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKTsKCQkJYnV0dG9uVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApOwoJCX0KCQlidXR0b25JY29uID0gby5pY29uID8gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgOiBudWxsOwoKCQlpZiAoIGF0dGFjaEV2ZW50cyAmJiAhYnV0dG9uRWxlbWVudHMpIHsKCQkJYXR0YWNoRXZlbnRzKCk7CgkJfQoJCQoJCS8vIGlmIG5vdCwgdHJ5IHRvIGZpbmQgY2xvc2VzdCB0aGVtZSBjb250YWluZXIJCgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICk7CQoJCX0JCQoKCQlidXR0b25DbGFzcyA9ICJ1aS1idG4gdWktYnRuLXVwLSIgKyBvLnRoZW1lOwoJCWJ1dHRvbkNsYXNzICs9IG8uaW5saW5lID8gIiB1aS1idG4taW5saW5lIiA6ICIiOwoJCWJ1dHRvbkNsYXNzICs9IG8uc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiI7CgkJYnV0dG9uQ2xhc3MgKz0gby5jb3JuZXJzID8gIiB1aS1idG4tY29ybmVyLWFsbCIgOiAiIjsKCgkJaWYgKCBvLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYG1pbmlgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLm1pbmkgPyAiIHVpLW1pbmkiIDogIiB1aS1mdWxsc2l6ZSI7CgkJfQoJCQoJCWlmICggby5pbmxpbmUgIT09IHVuZGVmaW5lZCApIHsJCQkKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYG1pbmlgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLmlubGluZSA9PT0gZmFsc2UgPyAiIHVpLWJ0bi1ibG9jayIgOiAiIHVpLWJ0bi1pbmxpbmUiOwoJCX0KCQkKCQkKCQlpZiAoIG8uaWNvbiApIHsKCQkJby5pY29uID0gInVpLWljb24tIiArIG8uaWNvbjsKCQkJby5pY29ucG9zID0gby5pY29ucG9zIHx8ICJsZWZ0IjsKCgkJCWljb25DbGFzcyA9ICJ1aS1pY29uICIgKyBvLmljb247CgoJCQlpZiAoIG8uaWNvbnNoYWRvdyApIHsKCQkJCWljb25DbGFzcyArPSAiIHVpLWljb24tc2hhZG93IjsKCQkJfQoJCX0KCgkJaWYgKCBvLmljb25wb3MgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWljb24tIiArIG8uaWNvbnBvczsKCgkJCWlmICggby5pY29ucG9zID09ICJub3RleHQiICYmICFlbC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCQllbC5hdHRyKCAidGl0bGUiLCBlbC5nZXRFbmNvZGVkVGV4dCgpICk7CgkJCX0KCQl9CiAgICAKCQlpbm5lckNsYXNzICs9IG8uY29ybmVycyA/ICIgdWktYnRuLWNvcm5lci1hbGwiIDogIiI7CgoJCWlmICggby5pY29ucG9zICYmIG8uaWNvbnBvcyA9PT0gIm5vdGV4dCIgJiYgIWVsLmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJZWwuYXR0ciggInRpdGxlIiwgZWwuZ2V0RW5jb2RlZFRleHQoKSApOwoJCX0KCgkJaWYgKCBidXR0b25FbGVtZW50cyApIHsKCQkJZWwucmVtb3ZlQ2xhc3MoIGJ1dHRvbkVsZW1lbnRzLmJjbHMgfHwgIiIgKTsKCQl9CgkJZWwucmVtb3ZlQ2xhc3MoICJ1aS1saW5rIiApLmFkZENsYXNzKCBidXR0b25DbGFzcyApOwoKCQlidXR0b25Jbm5lci5jbGFzc05hbWUgPSBpbm5lckNsYXNzOwoKCQlidXR0b25UZXh0LmNsYXNzTmFtZSA9IHRleHRDbGFzczsKCQlpZiAoICFidXR0b25FbGVtZW50cyApIHsKCQkJYnV0dG9uSW5uZXIuYXBwZW5kQ2hpbGQoIGJ1dHRvblRleHQgKTsKCQl9CgkJaWYgKCBidXR0b25JY29uICkgewoJCQlidXR0b25JY29uLmNsYXNzTmFtZSA9IGljb25DbGFzczsKCQkJaWYgKCAhKGJ1dHRvbkVsZW1lbnRzICYmIGJ1dHRvbkVsZW1lbnRzLmljb24pICkgewoJCQkJYnV0dG9uSWNvbi5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIlx1MDBhMCIpICk7CgkJCQlidXR0b25Jbm5lci5hcHBlbmRDaGlsZCggYnV0dG9uSWNvbiApOwoJCQl9CgkJfQoKCQl3aGlsZSAoIGUuZmlyc3RDaGlsZCAmJiAhYnV0dG9uRWxlbWVudHMpIHsKCQkJYnV0dG9uVGV4dC5hcHBlbmRDaGlsZCggZS5maXJzdENoaWxkICk7CgkJfQoKCQlpZiAoICFidXR0b25FbGVtZW50cyApIHsKCQkJZS5hcHBlbmRDaGlsZCggYnV0dG9uSW5uZXIgKTsKCQl9CgoJCS8vIEFzc2lnbiBhIHN0cnVjdHVyZSBjb250YWluaW5nIHRoZSBlbGVtZW50cyBvZiB0aGlzIGJ1dHRvbiB0byB0aGUgZWxlbWVudHMgb2YgdGhpcyBidXR0b24uIFRoaXMKCQkvLyB3aWxsIGFsbG93IHVzIHRvIHJlY29nbml6ZSB0aGlzIGFzIGFuIGFscmVhZHktZW5oYW5jZWQgYnV0dG9uIGluIGZ1dHVyZSBjYWxscyB0byBidXR0b25NYXJrdXAoKS4KCQlidXR0b25FbGVtZW50cyA9IHsKCQkJYmNscyAgOiBidXR0b25DbGFzcywKCQkJb3V0ZXIgOiBlLAoJCQlpbm5lciA6IGJ1dHRvbklubmVyLAoJCQl0ZXh0ICA6IGJ1dHRvblRleHQsCgkJCWljb24gIDogYnV0dG9uSWNvbgoJCX07CgoJCSQuZGF0YShlLCAgICAgICAgICAgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMpOwoJCSQuZGF0YShidXR0b25Jbm5lciwgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMpOwoJCSQuZGF0YShidXR0b25UZXh0LCAgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMpOwoJCWlmIChidXR0b25JY29uKSB7CgkJCSQuZGF0YShidXR0b25JY29uLCAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyk7CgkJfQoJfQoKCXJldHVybiB0aGlzOwp9OwoKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7Cgljb3JuZXJzOiB0cnVlLAoJc2hhZG93OiB0cnVlLAoJaWNvbnNoYWRvdzogdHJ1ZSwKCXdyYXBwZXJFbHM6ICJzcGFuIgp9OwoKZnVuY3Rpb24gY2xvc2VzdEVuYWJsZWRCdXR0b24oIGVsZW1lbnQgKSB7CiAgICB2YXIgY25hbWU7CgogICAgd2hpbGUgKCBlbGVtZW50ICkgewoJCS8vIE5vdGUgdGhhdCB3ZSBjaGVjayBmb3IgdHlwZW9mIGNsYXNzTmFtZSBiZWxvdyBiZWNhdXNlIHRoZSBlbGVtZW50IHdlCgkJLy8gaGFuZGVkIGNvdWxkIGJlIGluIGFuIFNWRyBET00gd2hlcmUgY2xhc3NOYW1lIG9uIFNWRyBlbGVtZW50cyBpcyBkZWZpbmVkIHRvCgkJLy8gYmUgb2YgYSBkaWZmZXJlbnQgdHlwZSAoU1ZHQW5pbWF0ZWRTdHJpbmcpLiBXZSBvbmx5IG9wZXJhdGUgb24gSFRNTCBET00KCQkvLyBlbGVtZW50cywgc28gd2UgbG9vayBmb3IgcGxhaW4gInN0cmluZyIuCiAgICAgICAgY25hbWUgPSAoIHR5cGVvZiBlbGVtZW50LmNsYXNzTmFtZSA9PT0gJ3N0cmluZycgKSAmJiAoZWxlbWVudC5jbGFzc05hbWUgKyAnICcpOwogICAgICAgIGlmICggY25hbWUgJiYgY25hbWUuaW5kZXhPZigidWktYnRuICIpID4gLTEgJiYgY25hbWUuaW5kZXhPZigidWktZGlzYWJsZWQgIikgPCAwICkgewogICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICB9CgogICAgcmV0dXJuIGVsZW1lbnQ7Cn0KCnZhciBhdHRhY2hFdmVudHMgPSBmdW5jdGlvbigpIHsKCXZhciBob3ZlckRlbGF5ID0gJC5tb2JpbGUuYnV0dG9uTWFya3VwLmhvdmVyRGVsYXksIGhvdiwgZm9jOwoKCSQoIGRvY3VtZW50ICkuYmluZCggewoJCSJ2bW91c2Vkb3duIHZtb3VzZWNhbmNlbCB2bW91c2V1cCB2bW91c2VvdmVyIHZtb3VzZW91dCBmb2N1cyBibHVyIHNjcm9sbHN0YXJ0IjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgdGhlbWUsCgkJCQkkYnRuID0gJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICksCgkJCQlldnQgPSBldmVudC50eXBlOwoJCQoJCQlpZiAoICRidG4ubGVuZ3RoICkgewoJCQkJdGhlbWUgPSAkYnRuLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIgKTsKCQkKCQkJCWlmICggZXZ0ID09PSAidm1vdXNlZG93biIgKSB7CgkJCQkJaWYgKCAkLnN1cHBvcnQudG91Y2ggKSB7CgkJCQkJCWhvdiA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICk7CgkJCQkJCX0sIGhvdmVyRGVsYXkgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlY2FuY2VsIiB8fCBldnQgPT09ICJ2bW91c2V1cCIgKSB7CgkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApOwoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3ZlciIgfHwgZXZ0ID09PSAiZm9jdXMiICkgewoJCQkJCWlmICggJC5zdXBwb3J0LnRvdWNoICkgewoJCQkJCQlmb2MgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgKTsKCQkJCQkJfSwgaG92ZXJEZWxheSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4taG92ZXItIiArIHRoZW1lICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3V0IiB8fCBldnQgPT09ICJibHVyIiB8fCBldnQgPT09ICJzY3JvbGxzdGFydCIgKSB7CgkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgICsgIiB1aS1idG4tZG93bi0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKTsKCQkJCQlpZiAoIGhvdiApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBob3YgKTsKCQkJCQl9CgkJCQkJaWYgKCBmb2MgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggZm9jICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSwKCQkiZm9jdXNpbiBmb2N1cyI6IGZ1bmN0aW9uKCBldmVudCApewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0sCgkJImZvY3Vzb3V0IGJsdXIiOiBmdW5jdGlvbiggZXZlbnQgKXsKCQkJJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQl9Cgl9KTsKCglhdHRhY2hFdmVudHMgPSBudWxsOwp9OwoKLy9saW5rcyBpbiBiYXJzLCBvciB0aG9zZSB3aXRoICBkYXRhLXJvbGUgYmVjb21lIGJ1dHRvbnMKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCgkkKCAiOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktaGVhZGVyID4gYSwgLnVpLWZvb3RlciA+IGEsIC51aS1iYXIgPiA6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSA+IGEiLCBlLnRhcmdldCApCgkJLm5vdCggIi51aS1idG4sIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmJ1dHRvbk1hcmt1cCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYmFja0J0blRleHQgID0gIkJhY2siOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmFkZEJhY2tCdG4gICA9IGZhbHNlOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UaGVtZSA9IG51bGw7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuaGVhZGVyVGhlbWUgID0gImEiOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmZvb3RlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5jb250ZW50VGhlbWUgPSBudWxsOwoKJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiLCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCXZhciAkcGFnZSA9ICQoIHRoaXMgKSwKCQlvID0gJHBhZ2UuZGF0YSggInBhZ2UiICkub3B0aW9ucywKCQlwYWdlUm9sZSA9ICRwYWdlLmpxbURhdGEoICJyb2xlIiApLAoJCXBhZ2VUaGVtZSA9IG8udGhlbWU7CgoJJCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpLCA6anFtRGF0YShyb2xlPSdmb290ZXInKSwgOmpxbURhdGEocm9sZT0nY29udGVudCcpIiwgdGhpcyApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlyb2xlID0gJHRoaXMuanFtRGF0YSggInJvbGUiICksCgkJCXRoZW1lID0gJHRoaXMuanFtRGF0YSggInRoZW1lIiApLAoJCQljb250ZW50VGhlbWUgPSB0aGVtZSB8fCBvLmNvbnRlbnRUaGVtZSB8fCAoIHBhZ2VSb2xlID09PSAiZGlhbG9nIiAmJiBwYWdlVGhlbWUgKSwKCQkJJGhlYWRlcmFuY2hvcnMsCgkJCWxlZnRidG4sCgkJCXJpZ2h0YnRuLAoJCQliYWNrQnRuOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CgoJCS8vYXBwbHkgdGhlbWluZyBhbmQgbWFya3VwIG1vZGlmaWNhdGlvbnMgdG8gcGFnZSxoZWFkZXIsY29udGVudCxmb290ZXIKCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiIHx8IHJvbGUgPT09ICJmb290ZXIiICkgewoKCQkJdmFyIHRoaXNUaGVtZSA9IHRoZW1lIHx8ICggcm9sZSA9PT0gImhlYWRlciIgPyBvLmhlYWRlclRoZW1lIDogby5mb290ZXJUaGVtZSApIHx8IHBhZ2VUaGVtZTsKCgkJCSR0aGlzCgkJCQkvL2FkZCB0aGVtZSBjbGFzcwoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyB0aGlzVGhlbWUgKQoJCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkJLmF0dHIoICJyb2xlIiwgcm9sZSA9PT0gImhlYWRlciIgPyAiYmFubmVyIiA6ICJjb250ZW50aW5mbyIgKTsKCgkJCWlmKCByb2xlID09PSAiaGVhZGVyIikgewoJCQkJLy8gUmlnaHQsbGVmdCBidXR0b25zCgkJCQkkaGVhZGVyYW5jaG9ycwk9ICR0aGlzLmNoaWxkcmVuKCAiYSIgKTsKCQkJCWxlZnRidG4JPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApOwoJCQkJcmlnaHRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCQlsZWZ0YnRuID0gbGVmdGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMCApLm5vdCggIi51aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tbGVmdCIgKS5sZW5ndGg7CgoJCQkJcmlnaHRidG4gPSByaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMSApLmFkZENsYXNzKCAidWktYnRuLXJpZ2h0IiApLmxlbmd0aDsKCQkJfQoKCQkJLy8gQXV0by1hZGQgYmFjayBidG4gb24gcGFnZXMgYmV5b25kIGZpcnN0IHZpZXcKCQkJaWYgKCBvLmFkZEJhY2tCdG4gJiYKCQkJCXJvbGUgPT09ICJoZWFkZXIiICYmCgkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJJHBhZ2UuanFtRGF0YSggInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJIWxlZnRidG4gKSB7CgoJCQkJYmFja0J0biA9ICQoICI8YSBocmVmPScjJyBjbGFzcz0ndWktYnRuLWxlZnQnIGRhdGEtIisgJC5tb2JpbGUubnMgKyJyZWw9J2JhY2snIGRhdGEtIisgJC5tb2JpbGUubnMgKyJpY29uPSdhcnJvdy1sJz4iKyBvLmJhY2tCdG5UZXh0ICsiPC9hPiIgKQoJCQkJCS8vIElmIHRoZW1lIGlzIHByb3ZpZGVkLCBvdmVycmlkZSBkZWZhdWx0IGluaGVyaXRhbmNlCgkJCQkJLmF0dHIoICJkYXRhLSIrICQubW9iaWxlLm5zICsidGhlbWUiLCBvLmJhY2tCdG5UaGVtZSB8fCB0aGlzVGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oICR0aGlzICk7CgkJCX0KCgkJCS8vIFBhZ2UgdGl0bGUKCQkJJHRoaXMuY2hpbGRyZW4oICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS10aXRsZSIgKQoJCQkJLy8gUmVnYXJkbGVzcyBvZiBoIGVsZW1lbnQgbnVtYmVyIGluIHNyYywgaXQgYmVjb21lcyBoMSBmb3IgdGhlIGVuaGFuY2VkIHBhZ2UKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJoZWFkaW5nIiwKCQkJCQkiYXJpYS1sZXZlbCI6ICIxIgoJCQkJfSk7CgoJCX0gZWxzZSBpZiAoIHJvbGUgPT09ICJjb250ZW50IiApIHsKCQkJaWYgKCBjb250ZW50VGhlbWUgKSB7CgkJCSAgICAkdGhpcy5hZGRDbGFzcyggInVpLWJvZHktIiArICggY29udGVudFRoZW1lICkgKTsKCQkJfQoKCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkkdGhpcy5hdHRyKCAicm9sZSIsICJtYWluIiApOwoJCX0KCX0pOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgkJY29sbGFwc2VDdWVUZXh0OiAiIGNsaWNrIHRvIGNvbGxhcHNlIGNvbnRlbnRzIiwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJdGhlbWU6IG51bGwsCgkJY29udGVudFRoZW1lOiBudWxsLAoJCWljb25UaGVtZTogImQiLAoJCW1pbmk6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWNvbGxhcHNpYmxlID0gJGVsLmFkZENsYXNzKCAidWktY29sbGFwc2libGUiICksCgkJCWNvbGxhcHNpYmxlSGVhZGluZyA9ICRlbC5jaGlsZHJlbiggby5oZWFkaW5nICkuZmlyc3QoKSwKCQkJY29sbGFwc2libGVDb250ZW50ID0gY29sbGFwc2libGUud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCc+PC9kaXY+IiApLmZpbmQoICIudWktY29sbGFwc2libGUtY29udGVudCIgKSwKCQkJY29sbGFwc2libGVTZXQgPSAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApOwoKCQkvLyBSZXBsYWNlIGNvbGxhcHNpYmxlSGVhZGluZyBpZiBpdCdzIGEgbGVnZW5kCgkJaWYgKCBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICJsZWdlbmQiICkgKSB7CgkJCWNvbGxhcHNpYmxlSGVhZGluZyA9ICQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnPiIrIGNvbGxhcHNpYmxlSGVhZGluZy5odG1sKCkgKyI8L2Rpdj4iICkuaW5zZXJ0QmVmb3JlKCBjb2xsYXBzaWJsZUhlYWRpbmcgKTsKCQkJY29sbGFwc2libGVIZWFkaW5nLm5leHQoKS5yZW1vdmUoKTsKCQl9CgoJCS8vIElmIHdlIGFyZSBpbiBhIGNvbGxhcHNpYmxlIHNldAoJCWlmICggY29sbGFwc2libGVTZXQubGVuZ3RoICkgewoJCQkvLyBJbmhlcml0IHRoZSB0aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCQlpZiAoICFvLnRoZW1lICkgewoJCQkJby50aGVtZSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoInRoZW1lIikgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGNvbGxhcHNpYmxlU2V0LCAiYyIgKTsKCQkJfQoJCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQkJby5jb250ZW50VGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQkJfQoKCQkJLy8gR2V0cyB0aGUgcHJlZmVyZW5jZSBpY29uIHBvc2l0aW9uIGluIHRoZSBzZXQKCQkJaWYgKCAhby5pY29uUG9zICkgewoJCQkJby5pY29uUG9zID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImljb25wb3MiICk7CgkJCX0KCgkJCWlmKCAhby5taW5pICkgewoJCQkJby5taW5pID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggIm1pbmkiICk7CgkJCX0KCQl9CgkJY29sbGFwc2libGVDb250ZW50LmFkZENsYXNzKCAoIG8uY29udGVudFRoZW1lICkgPyAoICJ1aS1ib2R5LSIgKyBvLmNvbnRlbnRUaGVtZSApIDogIiIpOwoKCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQkJLmluc2VydEJlZm9yZSggY29sbGFwc2libGVDb250ZW50ICkKCQkJLy9tb2RpZnkgbWFya3VwICYgYXR0cmlidXRlcwoJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCS5hcHBlbmQoICI8c3BhbiBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMnPjwvc3Bhbj4iICkKCQkJLndyYXBJbm5lciggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXRvZ2dsZSc+PC9hPiIgKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCWljb25wb3M6ICRlbC5qcW1EYXRhKCAiaWNvbnBvcyIgKSB8fCBvLmljb25Qb3MgfHwgImxlZnQiLAoJCQkJCWljb246ICJwbHVzIiwKCQkJCQltaW5pOiBvLm1pbmksCgkJCQkJdGhlbWU6IG8udGhlbWUKCQkJCX0pCgkJCS5hZGQoICIudWktYnRuLWlubmVyIiwgJGVsICkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSIgKTsKCgkJLy9ldmVudHMKCQljb2xsYXBzaWJsZQoJCQkuYmluZCggImV4cGFuZCBjb2xsYXBzZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJCWlzQ29sbGFwc2UgPSAoIGV2ZW50LnR5cGUgPT09ICJjb2xsYXBzZSIgKSwKCQkJCQkgICAgY29udGVudFRoZW1lID0gby5jb250ZW50VGhlbWU7CgoJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UpCgkJCQkJCS5maW5kKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApCgkJCQkJCQkudGV4dCggaXNDb2xsYXBzZSA/IG8uZXhwYW5kQ3VlVGV4dCA6IG8uY29sbGFwc2VDdWVUZXh0ICkKCQkJCQkJLmVuZCgpCgkJCQkJCS5maW5kKCAiLnVpLWljb24iICkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tbWludXMiLCAhaXNDb2xsYXBzZSApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLXBsdXMiLCBpc0NvbGxhcHNlICk7CgoJCQkJCSR0aGlzLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApOwoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbnRlbnQtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApLmF0dHIoICJhcmlhLWhpZGRlbiIsIGlzQ29sbGFwc2UgKTsKCgkJCQkJaWYgKCBjb250ZW50VGhlbWUgJiYgKCAhY29sbGFwc2libGVTZXQubGVuZ3RoIHx8IGNvbGxhcHNpYmxlLmpxbURhdGEoICJjb2xsYXBzaWJsZS1sYXN0IiApICkgKSB7CgkJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkKCBjb2xsYXBzaWJsZUhlYWRpbmcuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGVDb250ZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCQkJfQoJCQl9KQoJCQkudHJpZ2dlciggby5jb2xsYXBzZWQgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJdmFyIHR5cGUgPSBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICIudWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgPwoJCQkJCQkJCQkJImV4cGFuZCIgOiAiY29sbGFwc2UiOwoKCQkJCWNvbGxhcHNpYmxlLnRyaWdnZXIoIHR5cGUgKTsKCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZXNldCIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCS8vIEluaGVyaXQgdGhlIHRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCAkZWwsICJjIiApOwoJCX0KCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby5jb250ZW50VGhlbWUgKSB7CgkJCW8uY29udGVudFRoZW1lID0gJGVsLmpxbURhdGEoICJjb250ZW50LXRoZW1lIiApOwoJCX0KCgkJaWYgKCAhby5jb3JuZXJzICkgewoJCQlvLmNvcm5lcnMgPSAkZWwuanFtRGF0YSggImNvcm5lcnMiICkgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBmYWxzZTsKCQl9CgoJCS8vIEluaXRpYWxpemUgdGhlIGNvbGxhcHNpYmxlIHNldCBpZiBpdCdzIG5vdCBhbHJlYWR5IGluaXRpYWxpemVkCgkJaWYgKCAhJGVsLmpxbURhdGEoICJjb2xsYXBzaWJsZWJvdW5kIiApICkgewoJCQkkZWwKCQkJCS5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIsIHRydWUgKQoJCQkJLmJpbmQoICJleHBhbmQgY29sbGFwc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJdmFyIGlzQ29sbGFwc2UgPSAoIGV2ZW50LnR5cGUgPT09ICJjb2xsYXBzZSIgKSwKCQkJCQkJY29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApLAoJCQkJCQl3aWRnZXQgPSBjb2xsYXBzaWJsZS5kYXRhKCAiY29sbGFwc2libGUiICksCgkJCQkJICAgIGNvbnRlbnRUaGVtZSA9IHdpZGdldC5vcHRpb25zLmNvbnRlbnRUaGVtZTsKCQkJCQlpZiAoIGNvbnRlbnRUaGVtZSAmJiBjb2xsYXBzaWJsZS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIgKSApIHsKCQkJCQkJY29sbGFwc2libGUuZmluZCggd2lkZ2V0Lm9wdGlvbnMuaGVhZGluZyApLmZpcnN0KCkKCQkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCQkJCQkuYWRkKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGUuZmluZCggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZXhwYW5kIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCSQoIGV2ZW50LnRhcmdldCApCgkJCQkJCS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApCgkJCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZSIgKQoJCQkJCQkudHJpZ2dlciggImNvbGxhcHNlIiApOwoJCQkJfSk7CgkJfQoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWNvbGxhcHNpYmxlc0luU2V0ID0gJGVsLmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIgKTsKCgkJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2UoIGNvbGxhcHNpYmxlc0luU2V0Lm5vdCggIi51aS1jb2xsYXBzaWJsZSIgKSApOwoKCQkvLyBjbGVhbiB1cCBib3JkZXJzCgkJY29sbGFwc2libGVzSW5TZXQuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUub3B0aW9ucy5oZWFkaW5nICkKCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCQkuYWRkKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIiApOwoJCX0pOwoKCQljb2xsYXBzaWJsZXNJblNldC5maXJzdCgpCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5hZGRDbGFzcyggby5jb3JuZXJzID8gInVpLWNvcm5lci10b3AiIDogIiIgKQoJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKTsKCgkJY29sbGFwc2libGVzSW5TZXQubGFzdCgpCgkJCS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIsIHRydWUgKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYWRkQ2xhc3MoIG8uY29ybmVycyA/ICJ1aS1jb3JuZXItYm90dG9tIiA6ICIiICkKCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20iICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQubW9iaWxlLmNvbGxhcHNpYmxlc2V0LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUubmF2YmFyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJaWNvbnBvczogInRvcCIsCgkJZ3JpZDogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSduYXZiYXInKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKXsKCgkJdmFyICRuYXZiYXIgPSB0aGlzLmVsZW1lbnQsCgkJCSRuYXZidG5zID0gJG5hdmJhci5maW5kKCAiYSIgKSwKCQkJaWNvbnBvcyA9ICRuYXZidG5zLmZpbHRlciggIjpqcW1EYXRhKGljb24pIiApLmxlbmd0aCA/CgkJCQkJCQkJCXRoaXMub3B0aW9ucy5pY29ucG9zIDogdW5kZWZpbmVkOwoKCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyIiApCgkJCS5hdHRyKCAicm9sZSIsIm5hdmlnYXRpb24iICkKCQkJLmZpbmQoICJ1bCIgKQoJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQlpZiAoICFpY29ucG9zICkgewoJCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyLW5vaWNvbnMiICk7CgkJfQoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWlubGluZTogICAgIHRydWUsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiggISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktZGlzYWJsZWQiKSApIHsKCQkJCSRuYXZidG5zLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7CgoJCS8vIEJ1dHRvbnMgaW4gdGhlIG5hdmJhciB3aXRoIHVpLXN0YXRlLXBlcnNpc3QgY2xhc3Mgc2hvdWxkIHJlZ2FpbiB0aGVpciBhY3RpdmUgc3RhdGUgYmVmb3JlIHBhZ2Ugc2hvdwoJCSRuYXZiYXIuY2xvc2VzdCggIi51aS1wYWdlIiApLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkkbmF2YnRucy5maWx0ZXIoICIudWktc3RhdGUtcGVyc2lzdCIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUubmF2YmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy9LZWVwcyB0cmFjayBvZiB0aGUgbnVtYmVyIG9mIGxpc3RzIHBlciBwYWdlIFVJRAovL1RoaXMgYWxsb3dzIHN1cHBvcnQgZm9yIG11bHRpcGxlIG5lc3RlZCBsaXN0IGluIHRoZSBzYW1lIHBhZ2UKLy9odHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzE2MTcKdmFyIGxpc3RDb3VudFBlclBhZ2UgPSB7fTsKCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUud2lkZ2V0LCB7CgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6ICJjIiwKCQloZWFkZXJUaGVtZTogImIiLAoJCWRpdmlkZXJUaGVtZTogImIiLAoJCXNwbGl0SWNvbjogImFycm93LXIiLAoJCXNwbGl0VGhlbWU6ICJiIiwKCQltaW5pOiBmYWxzZSwKCQlpbnNldDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nbGlzdHZpZXcnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSB0aGlzLAoJCQlsaXN0dmlld0NsYXNzZXMgPSAiIjsKCQkJCgkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5pbnNldCA/ICIgdWktbGlzdHZpZXctaW5zZXQgdWktY29ybmVyLWFsbCB1aS1zaGFkb3cgIiA6ICIiOwoJCWxpc3R2aWV3Q2xhc3NlcyArPSB0LmVsZW1lbnQuanFtRGF0YSggIm1pbmkiICkgfHwgdC5vcHRpb25zLm1pbmkgPT09IHRydWUgPyAiIHVpLW1pbmkiIDogIiI7CgkJCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyhmdW5jdGlvbiggaSwgb3JpZyApIHsKCQkJcmV0dXJuIG9yaWcgKyAiIHVpLWxpc3R2aWV3ICIgKyBsaXN0dmlld0NsYXNzZXM7CgkJfSk7CgoJCXQucmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfcmVtb3ZlQ29ybmVyczogZnVuY3Rpb24oIGxpLCB3aGljaCApIHsKCQl2YXIgdG9wID0gInVpLWNvcm5lci10b3AgdWktY29ybmVyLXRyIHVpLWNvcm5lci10bCIsCgkJCWJvdCA9ICJ1aS1jb3JuZXItYm90dG9tIHVpLWNvcm5lci1iciB1aS1jb3JuZXItYmwiOwoKCQlsaSA9IGxpLmFkZCggbGkuZmluZCggIi51aS1idG4taW5uZXIsIC51aS1saS1saW5rLWFsdCwgLnVpLWxpLXRodW1iIiApICk7CgoJCWlmICggd2hpY2ggPT09ICJ0b3AiICkgewoJCQlsaS5yZW1vdmVDbGFzcyggdG9wICk7CgkJfSBlbHNlIGlmICggd2hpY2ggPT09ICJib3R0b20iICkgewoJCQlsaS5yZW1vdmVDbGFzcyggYm90ICk7CgkJfSBlbHNlIHsKCQkJbGkucmVtb3ZlQ2xhc3MoIHRvcCArICIgIiArIGJvdCApOwoJCX0KCX0sCgoJX3JlZnJlc2hDb3JuZXJzOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciAkbGksCgkJCSR2aXNpYmxlbGksCgkJCSR0b3BsaSwKCQkJJGJvdHRvbWxpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5pbnNldCApIHsKCQkJJGxpID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAibGkiICk7CgkJCS8vIGF0IGNyZWF0ZSB0aW1lIHRoZSBsaSBhcmUgbm90IHZpc2libGUgeWV0IHNvIHdlIG5lZWQgdG8gcmVseSBvbiAudWktc2NyZWVuLWhpZGRlbgoJCQkkdmlzaWJsZWxpID0gY3JlYXRlPyRsaS5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTokbGkuZmlsdGVyKCAiOnZpc2libGUiICk7CgoJCQl0aGlzLl9yZW1vdmVDb3JuZXJzKCAkbGkgKTsKCgkJCS8vIFNlbGVjdCB0aGUgZmlyc3QgdmlzaWJsZSBsaSBlbGVtZW50CgkJCSR0b3BsaSA9ICR2aXNpYmxlbGkuZmlyc3QoKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKTsKCgkJCSR0b3BsaS5hZGQoICR0b3BsaS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCS5ub3QoICIudWktbGktbGluay1hbHQgc3BhbjpmaXJzdC1jaGlsZCIgKSApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktbGluay1hbHQsIC51aS1saS1saW5rLWFsdCBzcGFuOmZpcnN0LWNoaWxkIiApCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRyIiApCgkJCQkuZW5kKCkKCQkJCS5maW5kKCAiLnVpLWxpLXRodW1iIiApCgkJCQkJLm5vdCgiLnVpLWxpLWljb24iKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10bCIgKTsKCgkJCS8vIFNlbGVjdCB0aGUgbGFzdCB2aXNpYmxlIGxpIGVsZW1lbnQKCQkJJGJvdHRvbWxpID0gJHZpc2libGVsaS5sYXN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20iICk7CgoJCQkkYm90dG9tbGkuYWRkKCAkYm90dG9tbGkuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJLmZpbmQoICIudWktbGktbGluay1hbHQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYnIiICkKCQkJCS5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktdGh1bWIiICkKCQkJCQkubm90KCIudWktbGktaWNvbiIpCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJsIiApOwoJCX0KCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0sCgoJLy8gVGhpcyBpcyBhIGdlbmVyaWMgdXRpbGl0eSBtZXRob2QgZm9yIGZpbmRpbmcgdGhlIGZpcnN0CgkvLyBub2RlIHdpdGggYSBnaXZlbiBub2RlTmFtZS4gSXQgdXNlcyBiYXNpYyBET00gdHJhdmVyc2FsCgkvLyB0byBiZSBmYXN0IGFuZCBpcyBtZWFudCB0byBiZSBhIHN1YnN0aXR1dGUgZm9yIHNpbXBsZQoJLy8gJC5mbi5jbG9zZXN0KCkgYW5kICQuZm4uY2hpbGRyZW4oKSBjYWxscyBvbiBhIHNpbmdsZQoJLy8gZWxlbWVudC4gTm90ZSB0aGF0IGNhbGxlcnMgbXVzdCBwYXNzIGJvdGggdGhlIGxvd2VyQ2FzZQoJLy8gYW5kIHVwcGVyQ2FzZSB2ZXJzaW9uIG9mIHRoZSBub2RlTmFtZSB0aGV5IGFyZSBsb29raW5nIGZvci4KCS8vIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcyBpcyB0aGF0IHRoaXMgZnVuY3Rpb24gd2lsbCBiZQoJLy8gY2FsbGVkIG1hbnkgdGltZXMgYW5kIHdlIHdhbnQgdG8gYXZvaWQgaGF2aW5nIHRvIGxvd2VyY2FzZQoJLy8gdGhlIG5vZGVOYW1lIGZyb20gdGhlIGVsZW1lbnQgZXZlcnkgdGltZSB0byBlbnN1cmUgd2UgaGF2ZQoJLy8gYSBtYXRjaC4gTm90ZSB0aGF0IHRoaXMgZnVuY3Rpb24gbGl2ZXMgaGVyZSBmb3Igbm93LCBidXQgbWF5CgkvLyBiZSBtb3ZlZCBpbnRvICQubW9iaWxlIGlmIG90aGVyIGNvbXBvbmVudHMgbmVlZCBhIHNpbWlsYXIgbWV0aG9kLgoJX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIG5leHRQcm9wLCBsY05hbWUsIHVjTmFtZSApCgl7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkKCXsKCQl2YXIgcmVzdWx0cyA9IFtdLAoJCQlkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJZWxlID0gZWxlLmZpcnN0Q2hpbGQ7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZSApOwoJCQl9CgkJCWVsZSA9IGVsZS5uZXh0U2libGluZzsKCQl9CgkJcmV0dXJuICQoIHJlc3VsdHMgKTsKCX0sCgoJX2FkZFRodW1iQ2xhc3NlczogZnVuY3Rpb24oIGNvbnRhaW5lcnMgKQoJewoJCXZhciBpLCBpbWcsIGxlbiA9IGNvbnRhaW5lcnMubGVuZ3RoOwoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWltZyA9ICQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGNvbnRhaW5lcnNbIGkgXS5maXJzdENoaWxkLCAibmV4dFNpYmxpbmciLCAiaW1nIiwgIklNRyIgKSApOwoJCQlpZiAoIGltZy5sZW5ndGggKSB7CgkJCQlpbWcuYWRkQ2xhc3MoICJ1aS1saS10aHVtYiIgKTsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5pcyggIi51aS1saS1pY29uIiApID8gInVpLWxpLWhhcy1pY29uIiA6ICJ1aS1saS1oYXMtdGh1bWIiICk7CgkJCX0KCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5wYXJlbnRQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQl0aGlzLl9jcmVhdGVTdWJQYWdlcygpOwoKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCXNlbGYgPSB0aGlzLAoJCQlkaXZpZGVydGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAiZGl2aWRlcnRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lLAoJCQlsaXN0c3BsaXR0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJzcGxpdHRoZW1lIiApLAoJCQlsaXN0c3BsaXRpY29uID0gJGxpc3QuanFtRGF0YSggInNwbGl0aWNvbiIgKSwKCQkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApLAoJCQljb3VudGVyID0gJC5zdXBwb3J0LmNzc1BzZXVkb0VsZW1lbnQgfHwgISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSA/IDAgOiAxLAoJCQlpdGVtQ2xhc3NEaWN0ID0ge30sCgkJCWl0ZW0sIGl0ZW1DbGFzcywgaXRlbVRoZW1lLAoJCQlhLCBsYXN0LCBzcGxpdHRoZW1lLCBjb3VudFBhcmVudCwgaWNvbiwgaW1nUGFyZW50cywgaW1nLCBsaW5rSWNvbjsKCgkJaWYgKCBjb3VudGVyICkgewoJCQkkbGlzdC5maW5kKCAiLnVpLWxpLWRlYyIgKS5yZW1vdmUoKTsKCQl9CgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWZvciAoIHZhciBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAidWktbGkiOwoKCQkJLy8gSWYgd2UncmUgY3JlYXRpbmcgdGhlIGVsZW1lbnQsIHdlIHVwZGF0ZSBpdCByZWdhcmRsZXNzCgkJCWlmICggY3JlYXRlIHx8ICFpdGVtLmhhc0NsYXNzKCAidWktbGkiICkgKSB7CgkJCQlpdGVtVGhlbWUgPSBpdGVtLmpxbURhdGEoInRoZW1lIikgfHwgby50aGVtZTsKCQkJCWEgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggaXRlbVsgMCBdLCAiYSIsICJBIiApOwoKCQkJCWlmICggYS5sZW5ndGggKSB7CgkJCQkJaWNvbiA9IGl0ZW0uanFtRGF0YSgiaWNvbiIpOwoKCQkJCQlpdGVtLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCXdyYXBwZXJFbHM6ICJkaXYiLAoJCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJaWNvbnBvczogInJpZ2h0IiwKCQkJCQkJaWNvbjogYS5sZW5ndGggPiAxIHx8IGljb24gPT09IGZhbHNlID8gZmFsc2UgOiBpY29uIHx8ICJhcnJvdy1yIiwKCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZQoJCQkJCX0pOwoKCQkJCQlpZiAoICggaWNvbiAhPSBmYWxzZSApICYmICggYS5sZW5ndGggPT0gMSApICkgewoJCQkJCQlpdGVtLmFkZENsYXNzKCAidWktbGktaGFzLWFycm93IiApOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggInVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gbGlzdHNwbGl0dGhlbWUgfHwgbGFzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lOwoJCQkJCQlsaW5rSWNvbiA9IGxhc3QuanFtRGF0YSgiaWNvbiIpOwoKCQkJCQkJbGFzdC5hcHBlbmRUbyhpdGVtKQoJCQkJCQkJLmF0dHIoICJ0aXRsZSIsIGxhc3QuZ2V0RW5jb2RlZFRleHQoKSApCgkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1saS1saW5rLWFsdCIgKQoJCQkJCQkJLmVtcHR5KCkKCQkJCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZSwKCQkJCQkJCQlpY29uOiBmYWxzZSwKCQkJCQkJCQlpY29ucG9zOiBmYWxzZQoJCQkJCQkJfSkKCQkJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJCS5hcHBlbmQoCgkJCQkJCQkJCSQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApICkuYnV0dG9uTWFya3VwKHsKCQkJCQkJCQkJCXNoYWRvdzogdHJ1ZSwKCQkJCQkJCQkJCWNvcm5lcnM6IHRydWUsCgkJCQkJCQkJCQl0aGVtZTogc3BsaXR0aGVtZSwKCQkJCQkJCQkJCWljb25wb3M6ICJub3RleHQiLAoJCQkJCQkJCQkJLy8gbGluayBpY29uIG92ZXJyaWRlcyBsaXN0IGl0ZW0gaWNvbiBvdmVycmlkZXMgdWwgZWxlbWVudCBvdmVycmlkZXMgb3B0aW9ucwoJCQkJCQkJCQkJaWNvbjogbGlua0ljb24gfHwgaWNvbiB8fCBsaXN0c3BsaXRpY29uIHx8IG8uc3BsaXRJY29uCgkJCQkJCQkJCX0pCgkJCQkJCQkJKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBpdGVtLmpxbURhdGEoICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApIHsKCgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktZGl2aWRlciB1aS1iYXItIiArIGRpdmlkZXJ0aGVtZTsKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgoJCQkJCS8vcmVzZXQgY291bnRlciB3aGVuIGEgZGl2aWRlciBoZWFkaW5nIGlzIGVuY291bnRlcmVkCgkJCQkJaWYgKCBjb3VudGVyICkgewoJCQkJCQljb3VudGVyID0gMTsKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1zdGF0aWMgdWktYm9keS0iICsgaXRlbVRoZW1lOwoJCQkJfQoJCQl9CgoJCQlpZiAoIGNvdW50ZXIgJiYgaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1kaXZpZGVyIiApIDwgMCApIHsKCQkJCWNvdW50UGFyZW50ID0gaXRlbS5pcyggIi51aS1saS1zdGF0aWM6Zmlyc3QiICkgPyBpdGVtIDogaXRlbS5maW5kKCAiLnVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQljb3VudFBhcmVudC5hZGRDbGFzcyggInVpLWxpLWpzbnVtYmVyaW5nIiApCgkJCQkJLnByZXBlbmQoICI8c3BhbiBjbGFzcz0ndWktbGktZGVjJz4iICsgKGNvdW50ZXIrKykgKyAiLiA8L3NwYW4+IiApOwoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtIGFuZCBpdHMKCQkJLy8gYnRuLWlubmVyIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtCgkJLy8gYW5kIHRoZWlyIGJ0bi1pbm5lciBlbGVtZW50cy4gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICkuY2hpbGRyZW4oICIudWktYnRuLWlubmVyIiApLmFkZENsYXNzKCBpdGVtQ2xhc3MgKTsKCQl9CgoJCSRsaXN0LmZpbmQoICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApLmFkZENsYXNzKCAidWktbGktaGVhZGluZyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAicCwgZGwiICkuYWRkQ2xhc3MoICJ1aS1saS1kZXNjIiApCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktYXNpZGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoJCQkJCSR0aGlzLnByZXBlbmRUbyggJHRoaXMucGFyZW50KCkgKTsgLy9zaGlmdCBhc2lkZSB0byBmcm9udCBmb3IgY3NzIGZsb2F0CgkJCQl9KQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWNvdW50IiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICk7CgkJCQl9KS5hZGRDbGFzcyggInVpLWJ0bi11cC0iICsgKCAkbGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCB0aGlzLm9wdGlvbnMuY291bnRUaGVtZSkgKyAiIHVpLWJ0bi1jb3JuZXItYWxsIiApOwoKCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGxvb2sgYXQgdGhlIGZpcnN0IGltYWdlIGluIHRoZSBsaXN0IGl0ZW0KCQkvLyBpdHNlbGYsIGFuZCBhbnkgLnVpLWxpbmstaW5oZXJpdCBlbGVtZW50IGl0IG1heSBjb250YWluLCBzbyB3ZQoJCS8vIGNhbiBwbGFjZSB0aGUgYXBwcm9wcmlhdGUgY2xhc3NlcyBvbiB0aGUgaW1hZ2UgYW5kIGxpc3QgaXRlbS4KCQkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2Ugc29tZXRoaW5nIGxpa2U6CgkJLy8KCQkvLyAgICBsaS5maW5kKCI+aW1nOmVxKDApLCAudWktbGluay1pbmhlcml0PmltZzplcSgwKSIpLmVhY2goIC4uLiApOwoJCS8vCgkJLy8gQnV0IGV4ZWN1dGluZyBhIGZpbmQoKSBsaWtlIHRoYXQgb24gV2luZG93cyBQaG9uZSA3LjUgdG9vayBhCgkJLy8gcmVhbGx5IGxvbmcgdGltZS4gV2Fsa2luZyB0aGluZ3MgbWFudWFsbHkgd2l0aCB0aGUgY29kZSBiZWxvdwoJCS8vIGFsbG93cyB0aGUgNDAwIGxpc3R2aWV3IGl0ZW0gcGFnZSB0byBsb2FkIGluIGFib3V0IDMgc2Vjb25kcyBhcwoJCS8vIG9wcG9zZWQgdG8gMzAgc2Vjb25kcy4KCgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCBsaSApOwoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggJGxpc3QuZmluZCggIi51aS1saW5rLWluaGVyaXQiICkgKTsKCgkJdGhpcy5fcmVmcmVzaENvcm5lcnMoIGNyZWF0ZSApOwoJfSwKCgkvL2NyZWF0ZSBhIHN0cmluZyBmb3IgSUQvc3VicGFnZSB1cmwgY3JlYXRpb24KCV9pZFN0cmluZ0VzY2FwZTogZnVuY3Rpb24oIHN0ciApIHsKCQlyZXR1cm4gc3RyLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCAnLScpOwoJfSwKCglfY3JlYXRlU3ViUGFnZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRMaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gcGFyZW50TGlzdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXBhcmVudFVybCA9IHBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJcGFyZW50SWQgPSBwYXJlbnRVcmwgfHwgcGFyZW50UGFnZVsgMCBdWyAkLmV4cGFuZG8gXSwKCQkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdC5hdHRyKCAiaWQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWRucyA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXMsCgkJCXBlcnNpc3RlbnRGb290ZXJJRCA9IHBhcmVudFBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLmpxbURhdGEoICJpZCIgKSwKCQkJaGFzU3ViUGFnZXM7CgoJCWlmICggdHlwZW9mIGxpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF0gPT09ICJ1bmRlZmluZWQiICkgewoJCQlsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID0gLTE7CgkJfQoKCQlwYXJlbnRMaXN0SWQgPSBwYXJlbnRMaXN0SWQgfHwgKytsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdOwoKCQkkKCBwYXJlbnRMaXN0LmZpbmQoICJsaT51bCwgbGk+b2wiICkudG9BcnJheSgpLnJldmVyc2UoKSApLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCWxpc3QgPSAkKCB0aGlzICksCgkJCQlsaXN0SWQgPSBsaXN0LmF0dHIoICJpZCIgKSB8fCBwYXJlbnRMaXN0SWQgKyAiLSIgKyBpLAoJCQkJcGFyZW50ID0gbGlzdC5wYXJlbnQoKSwKCQkJCW5vZGVFbHMgPSAkKCBsaXN0LnByZXZBbGwoKS50b0FycmF5KCkucmV2ZXJzZSgpICksCgkJCQlub2RlRWxzID0gbm9kZUVscy5sZW5ndGggPyBub2RlRWxzIDogJCggIjxzcGFuPiIgKyAkLnRyaW0ocGFyZW50LmNvbnRlbnRzKClbIDAgXS5ub2RlVmFsdWUpICsgIjwvc3Bhbj4iICksCgkJCQl0aXRsZSA9IG5vZGVFbHMuZmlyc3QoKS5nZXRFbmNvZGVkVGV4dCgpLC8vdXJsIGxpbWl0cyB0byBmaXJzdCAzMCBjaGFycyBvZiB0ZXh0CgkJCQlpZCA9ICggcGFyZW50VXJsIHx8ICIiICkgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIj0iICsgbGlzdElkLAoJCQkJdGhlbWUgPSBsaXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lLAoJCQkJY291bnRUaGVtZSA9IGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgcGFyZW50TGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCBvLmNvdW50VGhlbWUsCgkJCQluZXdQYWdlLCBhbmNob3I7CgoJCQkvL2RlZmluZSBoYXNTdWJQYWdlcyBmb3IgdXNlIGluIGxhdGVyIHJlbW92YWwKCQkJaGFzU3ViUGFnZXMgPSB0cnVlOwoKCQkJbmV3UGFnZSA9IGxpc3QuZGV0YWNoKCkKCQkJCQkJLndyYXAoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0ncGFnZScgIiArCWRucyArICJ1cmw9JyIgKyBpZCArICInICIgKyBkbnMgKyAidGhlbWU9JyIgKyB0aGVtZSArICInICIgKyBkbnMgKyAiY291bnQtdGhlbWU9JyIgKyBjb3VudFRoZW1lICsgIic+PGRpdiAiICsgZG5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkucGFyZW50KCkKCQkJCQkJCS5iZWZvcmUoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0naGVhZGVyJyAiICsgZG5zICsgInRoZW1lPSciICsgby5oZWFkZXJUaGVtZSArICInPjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgdGl0bGUgKyAiPC9kaXY+PC9kaXY+IiApCgkJCQkJCQkuYWZ0ZXIoIHBlcnNpc3RlbnRGb290ZXJJRCA/ICQoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0nZm9vdGVyJyAiICsgZG5zICsgImlkPSciKyBwZXJzaXN0ZW50Rm9vdGVySUQgKyInPiIpIDogIiIgKQoJCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkJLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQluZXdQYWdlLnBhZ2UoKTsKCgkJCWFuY2hvciA9IHBhcmVudC5maW5kKCdhOmZpcnN0Jyk7CgoJCQlpZiAoICFhbmNob3IubGVuZ3RoICkgewoJCQkJYW5jaG9yID0gJCggIjxhLz4iICkuaHRtbCggbm9kZUVscyB8fCB0aXRsZSApLnByZXBlbmRUbyggcGFyZW50LmVtcHR5KCkgKTsKCQkJfQoKCQkJYW5jaG9yLmF0dHIoICJocmVmIiwgIiMiICsgaWQgKTsKCgkJfSkubGlzdHZpZXcoKTsKCgkJLy8gb24gcGFnZWhpZGUsIHJlbW92ZSBhbnkgbmVzdGVkIHBhZ2VzIGFsb25nIHdpdGggdGhlIHBhcmVudCBwYWdlLCBhcyBsb25nIGFzIHRoZXkgYXJlbid0IGFjdGl2ZQoJCS8vIGFuZCBhcmVuJ3QgZW1iZWRkZWQKCQlpZiggaGFzU3ViUGFnZXMgJiYKCQkJcGFyZW50UGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSAmJgoJCQlwYXJlbnRQYWdlLmRhdGEoInBhZ2UiKS5vcHRpb25zLmRvbUNhY2hlID09PSBmYWxzZSApIHsKCgkJCXZhciBuZXdSZW1vdmUgPSBmdW5jdGlvbiggZSwgdWkgKXsKCQkJCXZhciBuZXh0UGFnZSA9IHVpLm5leHRQYWdlLCBucFVSTDsKCgkJCQlpZiggdWkubmV4dFBhZ2UgKXsKCQkJCQlucFVSTCA9IG5leHRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQkJaWYoIG5wVVJMLmluZGV4T2YoIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSAhPT0gMCApewoJCQkJCQlzZWxmLmNoaWxkUGFnZXMoKS5yZW1vdmUoKTsKCQkJCQkJcGFyZW50UGFnZS5yZW1vdmUoKTsKCQkJCQl9CgkJCQl9CgkJCX07CgoJCQkvLyB1bmJpbmQgdGhlIG9yaWdpbmFsIHBhZ2UgcmVtb3ZlIGFuZCByZXBsYWNlIHdpdGggb3VyIHNwZWNpYWxpemVkIHZlcnNpb24KCQkJcGFyZW50UGFnZQoJCQkJLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKQoJCQkJLmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiLCBuZXdSZW1vdmUpOwoJCX0KCX0sCgoJLy8gVE9ETyBzb3J0IG91dCBhIGJldHRlciB3YXkgdG8gdHJhY2sgc3ViIHBhZ2VzIG9mIHRoZSBsaXN0dmlldyB0aGlzIGlzIGJyaXR0bGUKCWNoaWxkUGFnZXM6IGZ1bmN0aW9uKCl7CgkJdmFyIHBhcmVudFVybCA9IHRoaXMucGFyZW50UGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQlyZXR1cm4gJCggIjpqcW1EYXRhKHVybF49JyIrICBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsiJykiKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyoKKiAiY2hlY2tib3hyYWRpbyIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNoZWNrYm94cmFkaW8iLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdjaGVja2JveCddLGlucHV0W3R5cGU9J3JhZGlvJ10iCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJaW5oZXJpdEF0dHIgPSBmdW5jdGlvbiggaW5wdXQsIGRhdGFBdHRyICkgewoJCQkJcmV0dXJuIGlucHV0LmpxbURhdGEoIGRhdGFBdHRyICkgfHwgaW5wdXQuY2xvc2VzdCggImZvcm0sZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKQoJCQl9LAoJCQkvLyBOT1RFOiBXaW5kb3dzIFBob25lIGNvdWxkIG5vdCBmaW5kIHRoZSBsYWJlbCB0aHJvdWdoIGEgc2VsZWN0b3IKCQkJLy8gZmlsdGVyIHdvcmtzIHRob3VnaC4KCQkJcGFyZW50TGFiZWwgPSAkKCBpbnB1dCApLmNsb3Nlc3QoICJsYWJlbCIgKSwKCQkJbGFiZWwgPSBwYXJlbnRMYWJlbC5sZW5ndGggPyBwYXJlbnRMYWJlbCA6ICQoIGlucHV0ICkuY2xvc2VzdCggImZvcm0sZmllbGRzZXQsOmpxbURhdGEocm9sZT0ncGFnZScpLDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpbmQoICJsYWJlbCIgKS5maWx0ZXIoICJbZm9yPSciICsgaW5wdXRbMF0uaWQgKyAiJ10iICksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCW1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApLAoJCQljaGVja2VkU3RhdGUgPSBpbnB1dHR5cGUgKyAiLW9uIiwKCQkJdW5jaGVja2VkU3RhdGUgPSBpbnB1dHR5cGUgKyAiLW9mZiIsCgkJCWljb24gPSBpbnB1dC5wYXJlbnRzKCAiOmpxbURhdGEodHlwZT0naG9yaXpvbnRhbCcpIiApLmxlbmd0aCA/IHVuZGVmaW5lZCA6IHVuY2hlY2tlZFN0YXRlLAoJCQlpY29ucG9zID0gaW5oZXJpdEF0dHIoIGlucHV0LCAiaWNvbnBvcyIgKSwKCQkJYWN0aXZlQnRuID0gaWNvbiA/ICIiIDogIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgY2hlY2tlZFN0YXRlICsgYWN0aXZlQnRuLAoJCQl1bmNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgdW5jaGVja2VkU3RhdGUsCgkJCWNoZWNrZWRpY29uID0gInVpLWljb24tIiArIGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkaWNvbiA9ICJ1aS1pY29uLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlsYWJlbDogbGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZGljb24sCgkJCXVuY2hlY2tlZGljb246IHVuY2hlY2tlZGljb24KCQl9KTsKCgkJLy8gSWYgdGhlcmUncyBubyBzZWxlY3RlZCB0aGVtZSBjaGVjayB0aGUgZGF0YSBhdHRyCgkJaWYoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMub3B0aW9ucy50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApOwoJCX0KCgkJbGFiZWwuYnV0dG9uTWFya3VwKHsKCQkJdGhlbWU6IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJaWNvbjogaWNvbiwKCQkJc2hhZG93OiBmYWxzZSwKCQkJbWluaTogbWluaSwKCQkJaWNvbnBvczogaWNvbnBvcwoJCX0pOwoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICd1aS0nICsgaW5wdXR0eXBlOwoKCQlpbnB1dC5hZGQoIGxhYmVsICkud3JhcEFsbCggd3JhcHBlciApOwoKCQlsYWJlbC5iaW5kKHsKCQkJdm1vdXNlb3ZlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAkKCB0aGlzICkucGFyZW50KCkuaXMoICIudWktZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCX0sCgoJCQl2Y2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgoJCQkJaW5wdXQucHJvcCggImNoZWNrZWQiLCBpbnB1dHR5cGUgPT09ICJyYWRpbyIgJiYgdHJ1ZSB8fCAhaW5wdXQucHJvcCggImNoZWNrZWQiICkgKTsKCgkJCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCQkJLy8gaG93IGxhYmVsIGNsaWNrcyBiZWhhdmUgbm9ybWFsbHkgaW4gdGhlIGJyb3dzZXJzCgkJCQkvLyBUT0RPOiBpdCB3b3VsZCBiZSBuaWNlIHRvIGxldCB0aGUgYnJvd3NlcidzIGhhbmRsZSB0aGUgY2xpY2tzIGFuZCBwYXNzIHRoZW0KCQkJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJCQkvLyAgICAgICB3cmFwcGVyIGVsZW1lbnQgbGV2ZWwKCQkJCWlucHV0LnRyaWdnZXJIYW5kbGVyKCAnY2xpY2snICk7CgoJCQkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCQkJLy8gYnV0dG9ucywgYnV0IHdpbGwgbm90IGZvciBjaGVja2JveGVzLiBjbGVhcmluZyB0aGUgY2hlY2tlZCBzdGF0dXMKCQkJCS8vIG9mIG90aGVyIHJhZGlvcyBlbnN1cmVzIHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlIGlzIGFwcGxpZWQgcHJvcGVybHkKCQkJCXNlbGYuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoKCQlpbnB1dAoJCQkuYmluZCh7CgkJCQl2bW91c2Vkb3duOiBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLl9jYWNoZVZhbHMoKTsKCQkJCX0sCgoJCQkJdmNsaWNrOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJCQkJaWYgKCAkdGhpcy5pcyggIjpjaGVja2VkIiApICkgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCB0cnVlKTsKCQkJCQkJc2VsZi5fZ2V0SW5wdXRTZXQoKS5ub3QoJHRoaXMpLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQl9LAoKCQkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCQlsYWJlbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfSwKCgkJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCQlsYWJlbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfQoJCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9jYWNoZVZhbHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaChmdW5jdGlvbigpIHsKCQkJJCh0aGlzKS5qcW1EYXRhKCAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy9yZXR1cm5zIGVpdGhlciBhIHNldCBvZiByYWRpb3Mgd2l0aCB0aGUgc2FtZSBuYW1lIGF0dHJpYnV0ZSwgb3IgYSBzaW5nbGUgY2hlY2tib3gKCV9nZXRJbnB1dFNldDogZnVuY3Rpb24oKXsKCQlpZih0aGlzLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IikgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJCX0KCgkJcmV0dXJuIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSxmaWVsZHNldCw6anFtRGF0YShyb2xlPSdwYWdlJykiICkKCQkJLmZpbmQoICJpbnB1dFtuYW1lPSciKyB0aGlzLmVsZW1lbnRbMF0ubmFtZSArIiddW3R5cGU9JyIrIHRoaXMuaW5wdXR0eXBlICsiJ10iICk7Cgl9LAoKCV91cGRhdGVBbGw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJaWYgKCB0aGlzLmNoZWNrZWQgfHwgc2VsZi5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudFswXSwKCQkJbGFiZWwgPSB0aGlzLmxhYmVsLAoJCQlpY29uID0gbGFiZWwuZmluZCggIi51aS1pY29uIiApOwoKCQlpZiAoIGlucHV0LmNoZWNrZWQgKSB7CgkJCWxhYmVsLmFkZENsYXNzKCB0aGlzLmNoZWNrZWRDbGFzcyApLnJlbW92ZUNsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICk7CgkJCWljb24uYWRkQ2xhc3MoIHRoaXMuY2hlY2tlZGljb24gKS5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRpY29uICk7CgkJfSBlbHNlIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIHRoaXMuY2hlY2tlZENsYXNzICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQkJaWNvbi5yZW1vdmVDbGFzcyggdGhpcy5jaGVja2VkaWNvbiApLmFkZENsYXNzKCB0aGlzLnVuY2hlY2tlZGljb24gKTsKCQl9CgoJCWlmICggaW5wdXQuZGlzYWJsZWQgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuZW5hYmxlKCk7CgkJfQoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdHJ1ZSApLnBhcmVudCgpLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIGZhbHNlICkucGFyZW50KCkucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuY2hlY2tib3hyYWRpby5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQlpbmxpbmU6IGZhbHNlLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IHRydWUsCgkJaW5pdFNlbGVjdG9yOiAiYnV0dG9uLCBbdHlwZT0nYnV0dG9uJ10sIFt0eXBlPSdzdWJtaXQnXSwgW3R5cGU9J3Jlc2V0J10sIFt0eXBlPSdpbWFnZSddIiwKCQltaW5pOiBmYWxzZQoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCSRidXR0b24sCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXR5cGUsCgkJCW5hbWUsCgkJCWNsYXNzZXMgPSAiIiwKCQkJJGJ1dHRvblBsYWNlaG9sZGVyOwoKCQkvLyBpZiB0aGlzIGlzIGEgbGluaywgY2hlY2sgaWYgaXQncyBiZWVuIGVuaGFuY2VkIGFuZCwgaWYgbm90LCB1c2UgdGhlIHJpZ2h0IGZ1bmN0aW9uCgkJaWYoICRlbFsgMCBdLnRhZ05hbWUgPT09ICJBIiApIHsKCSAJIAkhJGVsLmhhc0NsYXNzKCAidWktYnRuIiApICYmICRlbC5idXR0b25NYXJrdXAoKTsKCSAJIAlyZXR1cm47CiAJIAl9CgoJCS8vIGdldCB0aGUgaW5oZXJpdGVkIHRoZW1lCgkJLy8gVE9ETyBjZW50cmFsaXplIGZvciBhbGwgd2lkZ2V0cwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYoICEhfiRlbFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmKCAgISF+JGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1yaWdodCI7CgkJfQoKCQkvLyBBZGQgQVJJQSByb2xlCgkJdGhpcy5idXR0b24gPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJLnRleHQoICRlbC50ZXh0KCkgfHwgJGVsLnZhbCgpICkKCQkJLmluc2VydEJlZm9yZSggJGVsICkKCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQl0aGVtZTogby50aGVtZSwKCQkJCWljb246IG8uaWNvbiwKCQkJCWljb25wb3M6IG8uaWNvbnBvcywKCQkJCWlubGluZTogby5pbmxpbmUsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQlzaGFkb3c6IG8uc2hhZG93LAoJCQkJaWNvbnNoYWRvdzogby5pY29uc2hhZG93LAoJCQkJbWluaTogby5taW5pCgkJCX0pCgkJCS5hZGRDbGFzcyggY2xhc3NlcyApCgkJCS5hcHBlbmQoICRlbC5hZGRDbGFzcyggInVpLWJ0bi1oaWRkZW4iICkgKTsKCiAgICAgICAgJGJ1dHRvbiA9IHRoaXMuYnV0dG9uOwoJCXR5cGUgPSAkZWwuYXR0ciggInR5cGUiICk7CgkJbmFtZSA9ICRlbC5hdHRyKCAibmFtZSIgKTsKCgkJLy8gQWRkIGhpZGRlbiBpbnB1dCBkdXJpbmcgc3VibWl0IGlmIGlucHV0IHR5cGU9InN1Ym1pdCIgaGFzIGEgbmFtZS4KCQlpZiAoIHR5cGUgIT09ICJidXR0b24iICYmIHR5cGUgIT09ICJyZXNldCIgJiYgbmFtZSApIHsKCQkJCSRlbC5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCQkJLy8gQWRkIGhpZGRlbiBpbnB1dCBpZiBpdCBkb2VzbuKAmXQgYWxyZWFkeSBleGlzdC4KCQkJCQlpZiggJGJ1dHRvblBsYWNlaG9sZGVyID09PSB1bmRlZmluZWQgKSB7CgkJCQkJCSRidXR0b25QbGFjZWhvbGRlciA9ICQoICI8aW5wdXQ+IiwgewoJCQkJCQkJdHlwZTogImhpZGRlbiIsCgkJCQkJCQluYW1lOiAkZWwuYXR0ciggIm5hbWUiICksCgkJCQkJCQl2YWx1ZTogJGVsLmF0dHIoICJ2YWx1ZSIgKQoJCQkJCQl9KS5pbnNlcnRCZWZvcmUoICRlbCApOwoKCQkJCQkJLy8gQmluZCB0byBkb2MgdG8gcmVtb3ZlIGFmdGVyIHN1Ym1pdCBoYW5kbGluZwoJCQkJCQkkKCBkb2N1bWVudCApLm9uZSgic3VibWl0IiwgZnVuY3Rpb24oKXsKCQkJCQkJCSRidXR0b25QbGFjZWhvbGRlci5yZW1vdmUoKTsKCgkJCQkJCQkvLyByZXNldCB0aGUgbG9jYWwgdmFyIHNvIHRoYXQgdGhlIGhpZGRlbiBpbnB1dAoJCQkJCQkJLy8gd2lsbCBiZSByZS1hZGRlZCBvbiBzdWJzZXF1ZW50IGNsaWNrcwoJCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyID0gdW5kZWZpbmVkOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9KTsKCQl9CgogICAgICAgICRlbC5iaW5kKHsKICAgICAgICAgICAgZm9jdXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJGJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYmx1cjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCAkZWwucHJvcCgiZGlzYWJsZWQiKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9CgoJCS8vIEdyYWIgdGhlIGJ1dHRvbidzIHRleHQgZWxlbWVudCBmcm9tIGl0cyBpbXBsZW1lbnRhdGlvbi1pbmRlcGVuZGVudCBkYXRhIGl0ZW0KCQkkKCB0aGlzLmJ1dHRvbi5kYXRhKCAnYnV0dG9uRWxlbWVudHMnICkudGV4dCApLnRleHQoICRlbC50ZXh0KCkgfHwgJGVsLnZhbCgpICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQubW9iaWxlLmJ1dHRvbi5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uY29udHJvbGdyb3VwID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglmdW5jdGlvbiBmbGlwQ2xhc3NlcyggZWxzLCBmbENvcm5lcnMgICkgewoJCWVscy5yZW1vdmVDbGFzcyggInVpLWJ0bi1jb3JuZXItYWxsIHVpLXNoYWRvdyIgKQoJCQkuZXEoIDAgKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAwIF0gKQoJCQkuZW5kKCkKCQkJLmxhc3QoKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAxIF0gKS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC1sYXN0IiApOwoJfQoKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCQkJZGlyZWN0aW9uOiAkZWwuanFtRGF0YSggInR5cGUiICkgfHwgInZlcnRpY2FsIiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJZXhjbHVkZUludmlzaWJsZTogdHJ1ZSwKCQkJCQkJbWluaTogJGVsLmpxbURhdGEoICJtaW5pIiApCgkJCQkJfSwgb3B0aW9ucyApLAoJCQlncm91cGhlYWRpbmcgPSAkZWwuY2hpbGRyZW4oICJsZWdlbmQiICksCgkJCWZsQ29ybmVycyA9IG8uZGlyZWN0aW9uID09ICJob3Jpem9udGFsIiA/IFsgInVpLWNvcm5lci1sZWZ0IiwgInVpLWNvcm5lci1yaWdodCIgXSA6IFsgInVpLWNvcm5lci10b3AiLCAidWktY29ybmVyLWJvdHRvbSIgXSwKCQkJdHlwZSA9ICRlbC5maW5kKCAiaW5wdXQiICkuZmlyc3QoKS5hdHRyKCAidHlwZSIgKTsKCgkJLy8gUmVwbGFjZSBsZWdlbmQgd2l0aCBtb3JlIHN0eWxhYmxlIHJlcGxhY2VtZW50IGRpdgoJCWlmICggZ3JvdXBoZWFkaW5nLmxlbmd0aCApIHsKCQkJJGVsLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyc+PC9kaXY+IiApOwoJCQkkKCAiPGRpdiByb2xlPSdoZWFkaW5nJyBjbGFzcz0ndWktY29udHJvbGdyb3VwLWxhYmVsJz4iICsgZ3JvdXBoZWFkaW5nLmh0bWwoKSArICI8L2Rpdj4iICkuaW5zZXJ0QmVmb3JlKCAkZWwuY2hpbGRyZW4oMCkgKTsKCQkJZ3JvdXBoZWFkaW5nLnJlbW92ZSgpOwoJCX0KCgkJJGVsLmFkZENsYXNzKCAidWktY29ybmVyLWFsbCB1aS1jb250cm9sZ3JvdXAgdWktY29udHJvbGdyb3VwLSIgKyBvLmRpcmVjdGlvbiApOwoKCQlmbGlwQ2xhc3NlcyggJGVsLmZpbmQoICIudWktYnRuIiArICggby5leGNsdWRlSW52aXNpYmxlID8gIjp2aXNpYmxlIiA6ICIiICkgKS5ub3QoJy51aS1zbGlkZXItaGFuZGxlJyksIGZsQ29ybmVycyApOwoJCWZsaXBDbGFzc2VzKCAkZWwuZmluZCggIi51aS1idG4taW5uZXIiICksIGZsQ29ybmVycyApOwoKCQlpZiAoIG8uc2hhZG93ICkgewoJCQkkZWwuYWRkQ2xhc3MoICJ1aS1zaGFkb3ciICk7CgkJfQoKCQlpZiAoIG8ubWluaSApIHsKCQkJJGVsLmFkZENsYXNzKCAidWktbWluaSIgKTsKCQl9CgoJfSk7Cn07CgovLyBUaGUgcGFnZWNyZWF0ZSBoYW5kbGVyIGZvciBjb250cm9sZ3JvdXAgaXMgaW4ganF1ZXJ5Lm1vYmlsZS5pbml0IGJlY2F1c2Ugb2YgdGhlIHNvZnQtZGVwZW5kZW5jeSBvbiB0aGUgd3JhcHBlZCB3aWRnZXRzCgp9KShqUXVlcnkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcywgdGVzdHMgaW5jbHVkZWQgd2l0aCBwYWdlCgkkKCBlLnRhcmdldCApCgkJLmZpbmQoICJhIiApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkubm90KCAiLnVpLWJ0biwgLnVpLWxpbmstaW5oZXJpdCwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYWRkQ2xhc3MoICJ1aS1saW5rIiApOwoKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKCBmdW5jdGlvbiggJCApIHsKCXZhcgltZXRhID0gJCggIm1ldGFbbmFtZT12aWV3cG9ydF0iICksCiAgICAgICAgaW5pdGlhbENvbnRlbnQgPSBtZXRhLmF0dHIoICJjb250ZW50IiApLAogICAgICAgIGRpc2FibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iLAogICAgICAgIGVuYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MTAsIHVzZXItc2NhbGFibGU9eWVzIiwKCQlkaXNhYmxlZEluaXRpYWxseSA9IC8odXNlci1zY2FsYWJsZVtcc10qPVtcc10qbm8pfChtYXhpbXVtLXNjYWxlW1xzXSo9W1xzXSoxKVskLFxzXS8udGVzdCggaW5pdGlhbENvbnRlbnQgKTsKCQoJJC5tb2JpbGUuem9vbSA9ICQuZXh0ZW5kKCB7fSwgewoJCWVuYWJsZWQ6ICFkaXNhYmxlZEluaXRpYWxseSwKCQlsb2NrZWQ6IGZhbHNlLAoJCWRpc2FibGU6IGZ1bmN0aW9uKCBsb2NrICkgewoJCQlpZiggIWRpc2FibGVkSW5pdGlhbGx5ICYmICEkLm1vYmlsZS56b29tLmxvY2tlZCApewoJICAgICAgICAJbWV0YS5hdHRyKCAiY29udGVudCIsIGRpc2FibGVkWm9vbSApOwoJICAgICAgICAJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gZmFsc2U7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGxvY2sgfHwgZmFsc2U7CgkJCX0KCQl9LAoJCWVuYWJsZTogZnVuY3Rpb24oIHVubG9jayApIHsKCQkJaWYoICFkaXNhYmxlZEluaXRpYWxseSAmJiAoICEkLm1vYmlsZS56b29tLmxvY2tlZCB8fCB1bmxvY2sgPT09IHRydWUgKSApewoJCSAgICAgICAgbWV0YS5hdHRyKCAiY29udGVudCIsIGVuYWJsZWRab29tICk7CgkJICAgICAgICAkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJcmVzdG9yZTogZnVuY3Rpb24oKSB7CgkJCWlmKCAhZGlzYWJsZWRJbml0aWFsbHkgKXsKCSAgICAgICAgCW1ldGEuYXR0ciggImNvbnRlbnQiLCBpbml0aWFsQ29udGVudCApOwoJICAgICAgICAJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCX0pOwoKfSggalF1ZXJ5ICkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwgaW5wdXRbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCBpbnB1dFt0eXBlPSdudW1iZXInXSwgOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIGlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIGlucHV0W3R5cGU9J2VtYWlsJ10sIGlucHV0W3R5cGU9J3VybCddLCBpbnB1dFt0eXBlPSd0ZWwnXSwgdGV4dGFyZWEsIGlucHV0W3R5cGU9J3RpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZSddLCBpbnB1dFt0eXBlPSdtb250aCddLCBpbnB1dFt0eXBlPSd3ZWVrJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIGlucHV0W3R5cGU9J2NvbG9yJ10sIGlucHV0Om5vdChbdHlwZV0pIiwKCQljbGVhclNlYXJjaEJ1dHRvblRleHQ6ICJjbGVhciB0ZXh0IgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50LAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQl0aGVtZSA9IG8udGhlbWUgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICksCgkJCXRoZW1lY2xhc3MgID0gIiB1aS1ib2R5LSIgKyB0aGVtZSwKCQkJbWluaSA9IGlucHV0LmpxbURhdGEoIm1pbmkiKSA9PSB0cnVlLAoJCQltaW5pY2xhc3MgPSBtaW5pID8gIiB1aS1taW5pIiA6ICIiLAoJCQlmb2N1c2VkRWwsIGNsZWFyYnRuOwoKCQkkKCAibGFiZWxbZm9yPSciICsgaW5wdXQuYXR0ciggImlkIiApICsgIiddIiApLmFkZENsYXNzKCAidWktaW5wdXQtdGV4dCIgKTsKCgkJZm9jdXNlZEVsID0gaW5wdXQuYWRkQ2xhc3MoInVpLWlucHV0LXRleHQgdWktYm9keS0iKyB0aGVtZSApOwoKCQkvLyBYWFg6IFRlbXBvcmFyeSB3b3JrYXJvdW5kIGZvciBpc3N1ZSA3ODUgKEFwcGxlIGJ1ZyA4OTEwNTg5KS4KCQkvLyAgICAgIFR1cm4gb2ZmIGF1dG9jb3JyZWN0IGFuZCBhdXRvY29tcGxldGUgb24gbm9uLWlPUyA1IGRldmljZXMKCQkvLyAgICAgIHNpbmNlIHRoZSBwb3B1cCB0aGV5IHVzZSBjYW4ndCBiZSBkaXNtaXNzZWQgYnkgdGhlIHVzZXIuIE5vdGUKCQkvLyAgICAgIHRoYXQgd2UgdGVzdCBmb3IgdGhlIHByZXNlbmNlIG9mIHRoZSBmZWF0dXJlIGJ5IGxvb2tpbmcgZm9yCgkJLy8gICAgICB0aGUgYXV0b2NvcnJlY3QgcHJvcGVydHkgb24gdGhlIGlucHV0IGVsZW1lbnQuIFdlIGN1cnJlbnRseQoJCS8vICAgICAgaGF2ZSBubyB0ZXN0IGZvciBpT1MgNSBvciBuZXdlciBzbyB3ZSdyZSB0ZW1wb3JhcmlseSB1c2luZwoJCS8vICAgICAgdGhlIHRvdWNoT3ZlcmZsb3cgc3VwcG9ydCBmbGFnIGZvciBqUU0gMS4wLiBZZXMsIEkgZmVlbCBkaXJ0eS4gLSBqYmxhcwoJCWlmICggdHlwZW9mIGlucHV0WzBdLmF1dG9jb3JyZWN0ICE9PSAidW5kZWZpbmVkIiAmJiAhJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgKSB7CgkJCS8vIFNldCB0aGUgYXR0cmlidXRlIGluc3RlYWQgb2YgdGhlIHByb3BlcnR5IGp1c3QgaW4gY2FzZSB0aGVyZQoJCQkvLyBpcyBjb2RlIHRoYXQgYXR0ZW1wdHMgdG8gbWFrZSBtb2RpZmljYXRpb25zIHZpYSBIVE1MLgoJCQlpbnB1dFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29ycmVjdCIsICJvZmYiICk7CgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb21wbGV0ZSIsICJvZmYiICk7CgkJfQoKCgkJLy8ic2VhcmNoIiBpbnB1dCB3aWRnZXQKCQlpZiAoIGlucHV0LmlzKCAiW3R5cGU9J3NlYXJjaCddLDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApICkgewoKCQkJZm9jdXNlZEVsID0gaW5wdXQud3JhcCggIjxkaXYgY2xhc3M9J3VpLWlucHV0LXNlYXJjaCB1aS1zaGFkb3ctaW5zZXQgdWktYnRuLWNvcm5lci1hbGwgdWktYnRuLXNoYWRvdyB1aS1pY29uLXNlYXJjaGZpZWxkIiArIHRoZW1lY2xhc3MgKyBtaW5pY2xhc3MgKyAiJz48L2Rpdj4iICkucGFyZW50KCk7CgkJCWNsZWFyYnRuID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1pbnB1dC1jbGVhcicgdGl0bGU9JyIgKyBvLmNsZWFyU2VhcmNoQnV0dG9uVGV4dCArICInPiIgKyBvLmNsZWFyU2VhcmNoQnV0dG9uVGV4dCArICI8L2E+IiApCgkJCQkuYmluZCgnY2xpY2snLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaW5wdXQKCQkJCQkJLnZhbCggIiIgKQoJCQkJCQkuZm9jdXMoKQoJCQkJCQkudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCQljbGVhcmJ0bi5hZGRDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIgKTsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfSkKCQkJCS5hcHBlbmRUbyggZm9jdXNlZEVsICkKCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCWljb246ICJkZWxldGUiLAoJCQkJCWljb25wb3M6ICJub3RleHQiLAoJCQkJCWNvcm5lcnM6IHRydWUsCgkJCQkJc2hhZG93OiB0cnVlLAoJCQkJCW1pbmk6IG1pbmkKCQkJCX0pOwoKCQkJZnVuY3Rpb24gdG9nZ2xlQ2xlYXIoKSB7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCWNsZWFyYnRuLnRvZ2dsZUNsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiwgIWlucHV0LnZhbCgpICk7CgkJCQl9LCAwKTsKCQkJfQoKCQkJdG9nZ2xlQ2xlYXIoKTsKCgkJCWlucHV0LmJpbmQoJ3Bhc3RlIGN1dCBrZXl1cCBmb2N1cyBjaGFuZ2UgYmx1cicsIHRvZ2dsZUNsZWFyKTsKCgkJfSBlbHNlIHsKCQkJaW5wdXQuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLXNoYWRvdy1pbnNldCIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICk7CgkJfQoKCQlpbnB1dC5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCWZvY3VzZWRFbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmx1cihmdW5jdGlvbigpewoJCQkJZm9jdXNlZEVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBzZWxlY3QgdXBvbiB0YXAsIHRoaXMgcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCQkuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiggby5wcmV2ZW50Rm9jdXNab29tICl7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCQl9CgkJCX0pCgkJCS5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJaWYoIG8ucHJldmVudEZvY3VzWm9vbSApewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9CgkJCX0pOwoKCQkvLyBBdXRvZ3JvdwoJCWlmICggaW5wdXQuaXMoICJ0ZXh0YXJlYSIgKSApIHsKCQkJdmFyIGV4dHJhTGluZUhlaWdodCA9IDE1LAoJCQkJa2V5dXBUaW1lb3V0QnVmZmVyID0gMTAwLAoJCQkJa2V5dXAgPSBmdW5jdGlvbigpIHsKCQkJCQl2YXIgc2Nyb2xsSGVpZ2h0ID0gaW5wdXRbIDAgXS5zY3JvbGxIZWlnaHQsCgkJCQkJCWNsaWVudEhlaWdodCA9IGlucHV0WyAwIF0uY2xpZW50SGVpZ2h0OwoKCQkJCQlpZiAoIGNsaWVudEhlaWdodCA8IHNjcm9sbEhlaWdodCApIHsKCQkJCQkJaW5wdXQuaGVpZ2h0KHNjcm9sbEhlaWdodCArIGV4dHJhTGluZUhlaWdodCk7CgkJCQkJfQoJCQkJfSwKCQkJCWtleXVwVGltZW91dDsKCgkJCWlucHV0LmtleXVwKGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KCBrZXl1cFRpbWVvdXQgKTsKCQkJCWtleXVwVGltZW91dCA9IHNldFRpbWVvdXQoIGtleXVwLCBrZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQkJfSk7CgoJCQkvLyBiaW5kaW5nIHRvIHBhZ2VjaGFuZ2UgaGVyZSBlbnN1cmVzIHRoYXQgZm9yIHBhZ2VzIGxvYWRlZCB2aWEKCQkJLy8gYWpheCB0aGUgaGVpZ2h0IGlzIHJlY2FsY3VsYXRlZCB3aXRob3V0IHVzZXIgaW5wdXQKCQkJJCggZG9jdW1lbnQgKS5vbmUoICJwYWdlY2hhbmdlIiwga2V5dXAgKTsKCgkJCS8vIElzc3VlIDUwOTogdGhlIGJyb3dzZXIgaXMgbm90IHByb3ZpZGluZyBzY3JvbGxIZWlnaHQgcHJvcGVybHkgdW50aWwgdGhlIHN0eWxlcyBsb2FkCgkJCWlmICggJC50cmltKCBpbnB1dC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCSQoIHdpbmRvdyApLmxvYWQoIGtleXVwICk7CgkJCX0KCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCl7CgkJKCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApLmlzKCAiW3R5cGU9J3NlYXJjaCddLDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApID8KCQkJdGhpcy5lbGVtZW50LnBhcmVudCgpIDogdGhpcy5lbGVtZW50ICkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpewoJCSggdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlKS5pcyggIlt0eXBlPSdzZWFyY2gnXSw6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSA/CgkJCXRoaXMuZWxlbWVudC5wYXJlbnQoKSA6IHRoaXMuZWxlbWVudCApLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQubW9iaWxlLnRleHRpbnB1dC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlciA9IGZhbHNlOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciA9ICJGaWx0ZXIgaXRlbXMuLi4iOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJUaGVtZSA9ICJjIjsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggdGV4dCwgc2VhcmNoVmFsdWUgKXsKCXJldHVybiB0ZXh0LnRvTG93ZXJDYXNlKCkuaW5kZXhPZiggc2VhcmNoVmFsdWUgKSA9PT0gLTE7Cn07CgokKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiOmpxbURhdGEocm9sZT0nbGlzdHZpZXcnKSIsICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCWxpc3R2aWV3ID0gbGlzdC5kYXRhKCAibGlzdHZpZXciICk7CgoJaWYgKCAhbGlzdHZpZXcub3B0aW9ucy5maWx0ZXIgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB3cmFwcGVyID0gJCggIjxmb3JtPiIsIHsKCQkJImNsYXNzIjogInVpLWxpc3R2aWV3LWZpbHRlciB1aS1iYXItIiArIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyVGhlbWUsCgkJCSJyb2xlIjogInNlYXJjaCIKCQl9KSwKCQlzZWFyY2ggPSAkKCAiPGlucHV0PiIsIHsKCQkJcGxhY2Vob2xkZXI6IGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIKCQl9KQoJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZSIsICJzZWFyY2giICkKCQkuanFtRGF0YSggImxhc3R2YWwiLCAiIiApCgkJLmJpbmQoICJrZXl1cCBjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCgkJCXZhciAkdGhpcyA9ICQodGhpcyksCgkJCQl2YWwgPSB0aGlzLnZhbHVlLnRvTG93ZXJDYXNlKCksCgkJCQlsaXN0SXRlbXMgPSBudWxsLAoJCQkJbGFzdHZhbCA9ICR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiApICsgIiIsCgkJCQljaGlsZEl0ZW1zID0gZmFsc2UsCgkJCQlpdGVtdGV4dCA9ICIiLAoJCQkJaXRlbTsKCgkJCS8vIENoYW5nZSB2YWwgYXMgbGFzdHZhbCBmb3IgbmV4dCBleGVjdXRpb24KCQkJJHRoaXMuanFtRGF0YSggImxhc3R2YWwiICwgdmFsICk7CgkJCWlmICggdmFsLmxlbmd0aCA8IGxhc3R2YWwubGVuZ3RoIHx8IHZhbC5pbmRleE9mKGxhc3R2YWwpICE9PSAwICkgewoKCQkJCS8vIFJlbW92ZWQgY2hhcnMgb3IgcGFzdGVkIHNvbWV0aGluZyB0b3RhbGx5IGRpZmZlcmVudCwgY2hlY2sgYWxsIGl0ZW1zCgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gT25seSBjaGFycyBhZGRlZCwgbm90IHJlbW92ZWQsIG9ubHkgdXNlIHZpc2libGUgc3Vic2V0CgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiOm5vdCgudWktc2NyZWVuLWhpZGRlbikiICk7CgkJCX0KCgkJCWlmICggdmFsICkgewoKCQkJCS8vIFRoaXMgaGFuZGxlcyBoaWRpbmcgcmVndWxhciByb3dzIHdpdGhvdXQgdGhlIHRleHQgd2Ugc2VhcmNoIGZvcgoJCQkJLy8gYW5kIGFueSBsaXN0IGRpdmlkZXJzIHdpdGhvdXQgcmVndWxhciByb3dzIHNob3duIHVuZGVyIGl0CgoJCQkJZm9yICggdmFyIGkgPSBsaXN0SXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQkJaXRlbSA9ICQoIGxpc3RJdGVtc1sgaSBdICk7CgkJCQkJaXRlbXRleHQgPSBpdGVtLmpxbURhdGEoICJmaWx0ZXJ0ZXh0IiApIHx8IGl0ZW0udGV4dCgpOwoKCQkJCQlpZiAoIGl0ZW0uaXMoICJsaTpqcW1EYXRhKHJvbGU9bGlzdC1kaXZpZGVyKSIgKSApIHsKCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsICFjaGlsZEl0ZW1zICk7CgoJCQkJCQkvLyBOZXcgYnVja2V0IQoJCQkJCQljaGlsZEl0ZW1zID0gZmFsc2U7CgoJCQkJCX0gZWxzZSBpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2soIGl0ZW10ZXh0LCB2YWwgKSApIHsKCgkJCQkJCS8vbWFyayB0byBiZSBoaWRkZW4KCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgdHJ1ZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBUaGVyZSdzIGEgc2hvd24gaXRlbSBpbiB0aGUgYnVja2V0CgkJCQkJCWNoaWxkSXRlbXMgPSB0cnVlOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTaG93IGl0ZW1zLCBub3QgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIjpub3QoLnVpLWZpbHRlci1oaWRlcXVldWUpIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgoJCQkJLy8gSGlkZSBpdGVtcywgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIi51aS1maWx0ZXItaGlkZXF1ZXVlIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIHRydWUgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiLCBmYWxzZSApOwoKCQkJfSBlbHNlIHsKCgkJCQkvL2ZpbHRlcnZhbHVlIGlzIGVtcHR5ID0+IHNob3cgYWxsCgkJCQlsaXN0SXRlbXMudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgZmFsc2UgKTsKCQkJfQoJCQlsaXN0dmlldy5fcmVmcmVzaENvcm5lcnMoKTsKCQl9KQoJCS5hcHBlbmRUbyggd3JhcHBlciApCgkJLnRleHRpbnB1dCgpOwoKCWlmICggbGlzdHZpZXcub3B0aW9ucy5pbnNldCApIHsKCQl3cmFwcGVyLmFkZENsYXNzKCAidWktbGlzdHZpZXctZmlsdGVyLWluc2V0IiApOwoJfQoKCXdyYXBwZXIuYmluZCggInN1Ym1pdCIsIGZ1bmN0aW9uKCkgewoJCXJldHVybiBmYWxzZTsKCX0pCgkuaW5zZXJ0QmVmb3JlKCBsaXN0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJdHJhY2tUaGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBUT0RPOiBFYWNoIG9mIHRoZXNlIHNob3VsZCBoYXZlIGNvbW1lbnRzIGV4cGxhaW4gd2hhdCB0aGV5J3JlIGZvcgoJCXZhciBzZWxmID0gdGhpcywKCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBjb250cm9sLCAiYyIgKSwKCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoKCQkJY1R5cGUgPSBjb250cm9sWyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCgkJCXNlbGVjdENsYXNzID0gKCBjVHlwZSA9PSAic2VsZWN0IiApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCgkJCWxhYmVsSUQgPSBjb250cm9sSUQgKyAiLWxhYmVsIiwKCgkJCWxhYmVsID0gJCggIltmb3I9JyIrIGNvbnRyb2xJRCArIiddIiApLmF0dHIoICJpZCIsIGxhYmVsSUQgKSwKCgkJCXZhbCA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICBjVHlwZSA9PSAiaW5wdXQiICA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfSwKCgkJCW1pbiA9ICBjVHlwZSA9PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoKCQkJbWF4ID0gIGNUeXBlID09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgoJCQlpbmxpbmVDbGFzcyA9ICggdGhpcy5vcHRpb25zLmlubGluZSB8fCBjb250cm9sLmpxbURhdGEoImlubGluZSIpID09IHRydWUgKSA/ICIgdWktc2xpZGVyLWlubGluZSIgOiAiIiwKCgkJCW1pbmlDbGFzcyA9ICggdGhpcy5vcHRpb25zLm1pbmkgfHwgY29udHJvbC5qcW1EYXRhKCJtaW5pIikgKSA/ICIgdWktc2xpZGVyLW1pbmkiIDogIiIsCgoKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpLAoJCQloYW5kbGUgPSAkKCBkb21IYW5kbGUgKSwKCQkJZG9tU2xpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksCgkJCXNsaWRlciA9ICQoIGRvbVNsaWRlciApLAoKCQkJdmFsdWViZyA9IGNvbnRyb2wuanFtRGF0YSgiaGlnaGxpZ2h0IikgJiYgY1R5cGUgIT0gInNlbGVjdCIgPyAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICd1aS1zbGlkZXItYmcgdWktYnRuLWFjdGl2ZSB1aS1idG4tY29ybmVyLWFsbCc7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9KSgpIDogZmFsc2UsCgoJCQlvcHRpb25zOwoKICAgICAgICBkb21IYW5kbGUuc2V0QXR0cmlidXRlKCAnaHJlZicsICIjIiApOwoJCWRvbVNsaWRlci5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCdhcHBsaWNhdGlvbicpOwoJCWRvbVNsaWRlci5jbGFzc05hbWUgPSBbJ3VpLXNsaWRlciAnLHNlbGVjdENsYXNzLCIgdWktYnRuLWRvd24tIix0cmFja1RoZW1lLCcgdWktYnRuLWNvcm5lci1hbGwnLCBpbmxpbmVDbGFzcywgbWluaUNsYXNzXS5qb2luKCIiKTsKCQlkb21IYW5kbGUuY2xhc3NOYW1lID0gJ3VpLXNsaWRlci1oYW5kbGUnOwoJCWRvbVNsaWRlci5hcHBlbmRDaGlsZChkb21IYW5kbGUpOwoKCQloYW5kbGUuYnV0dG9uTWFya3VwKHsgY29ybmVyczogdHJ1ZSwgdGhlbWU6IHRoZW1lLCBzaGFkb3c6IHRydWUgfSkKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJzbGlkZXIiLAoJCQkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkJCSJhcmlhLXZhbHVlbm93IjogdmFsKCksCgkJCQkJImFyaWEtdmFsdWV0ZXh0IjogdmFsKCksCgkJCQkJInRpdGxlIjogdmFsKCksCgkJCQkJImFyaWEtbGFiZWxsZWRieSI6IGxhYmVsSUQKCQkJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCXZhbHVlYmc6IHZhbHVlYmcsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggY1R5cGUgPT0gInNlbGVjdCIgKSB7CgkJCXZhciB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCXdyYXBwZXIuY2xhc3NOYW1lID0gJ3VpLXNsaWRlci1pbm5lcm9mZnNldCc7CgoJCQlmb3IodmFyIGogPSAwLGxlbmd0aCA9IGRvbVNsaWRlci5jaGlsZE5vZGVzLmxlbmd0aDtqIDwgbGVuZ3RoO2orKyl7CgkJCQl3cmFwcGVyLmFwcGVuZENoaWxkKGRvbVNsaWRlci5jaGlsZE5vZGVzW2pdKTsKCQkJfQoKCQkJZG9tU2xpZGVyLmFwcGVuZENoaWxkKHdyYXBwZXIpOwoKCQkJLy8gc2xpZGVyLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLXNsaWRlci1pbm5lcm9mZnNldCc+PC9kaXY+IiApOwoKCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQlvcHRpb25zID0gY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoKCQkJZm9yKHZhciBpID0gMCwgb3B0aW9uc0NvdW50ID0gb3B0aW9ucy5sZW5ndGg7IGkgPCBvcHRpb25zQ291bnQ7IGkrKyl7CgkJCQl2YXIgc2lkZSA9ICFpID8gImIiOiJhIiwKCQkJCQlzbGlkZXJUaGVtZSA9ICFpID8gIiB1aS1idG4tZG93bi0iICsgdHJhY2tUaGVtZSA6KCAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLAoJCQkJCXNsaWRlckxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksCgkJCQkJc2xpZGVySW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbJ3VpLXNsaWRlci1sYWJlbCB1aS1zbGlkZXItbGFiZWwtJyxzaWRlLHNsaWRlclRoZW1lLCIgdWktYnRuLWNvcm5lci1hbGwiXS5qb2luKCIiKTsKCQkJCXNsaWRlckltZy5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCdpbWcnKTsKCQkJCXNsaWRlckltZy5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShvcHRpb25zW2ldLmlubmVySFRNTCkpOwoJCQkJJChzbGlkZXJJbWcpLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0KCgkJCXNlbGYuX2xhYmVscyA9ICQoICIudWktc2xpZGVyLWxhYmVsIiwgc2xpZGVyICk7CgoJCX0KCgkJbGFiZWwuYWRkQ2xhc3MoICJ1aS1zbGlkZXIiICk7CgoJCS8vIG1vbml0b3IgdGhlIGlucHV0IGZvciB1cGRhdGVkIHZhbHVlcwoJCWNvbnRyb2wuYWRkQ2xhc3MoIGNUeXBlID09PSAiaW5wdXQiID8gInVpLXNsaWRlci1pbnB1dCIgOiAidWktc2xpZGVyLXN3aXRjaCIgKQoJCQkuY2hhbmdlKCBmdW5jdGlvbigpIHsKCQkJCS8vIGlmIHRoZSB1c2VyIGRyYWdnZWQgdGhlIGhhbmRsZSwgdGhlICJjaGFuZ2UiIGV2ZW50IHdhcyB0cmlnZ2VyZWQgZnJvbSBpbnNpZGUgcmVmcmVzaCgpOyBkb24ndCBjYWxsIHJlZnJlc2goKSBhZ2FpbgoJCQkJaWYgKCFzZWxmLm1vdXNlTW92ZWQpIHsKCQkJCQlzZWxmLnJlZnJlc2goIHZhbCgpLCB0cnVlICk7CgkJCQl9CgkJCX0pCgkJCS5rZXl1cCggZnVuY3Rpb24oKSB7IC8vIG5lY2Vzc2FyeT8KCQkJCXNlbGYucmVmcmVzaCggdmFsKCksIHRydWUsIHRydWUgKTsKCQkJfSkKCQkJLmJsdXIoIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5yZWZyZXNoKCB2YWwoKSwgdHJ1ZSApOwoJCQl9KTsKCgkJLy8gcHJldmVudCBzY3JlZW4gZHJhZyB3aGVuIHNsaWRlciBhY3RpdmF0ZWQKCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoIHNlbGYuZHJhZ2dpbmcgKSB7CgkJCQkvLyBzZWxmLm1vdXNlTW92ZWQgbXVzdCBiZSB1cGRhdGVkIGJlZm9yZSByZWZyZXNoKCkgYmVjYXVzZSBpdCB3aWxsIGJlIHVzZWQgaW4gdGhlIGNvbnRyb2wgImNoYW5nZSIgZXZlbnQKCQkJCXNlbGYubW91c2VNb3ZlZCA9IHRydWU7CgoJCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIgKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgaW4gc3luYyB3aXRoIHRoZSBtb3VzZQoJCQkJCWhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQl9CgoJCQkJc2VsZi5yZWZyZXNoKCBldmVudCApOwoKCQkJCS8vIG9ubHkgYWZ0ZXIgcmVmcmVzaCgpIHlvdSBjYW4gY2FsY3VsYXRlIHNlbGYudXNlck1vZGlmaWVkCgkJCQlzZWxmLnVzZXJNb2RpZmllZCA9IHNlbGYuYmVmb3JlU3RhcnQgIT09IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoKCQlzbGlkZXIuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXNlbGYuZHJhZ2dpbmcgPSB0cnVlOwoJCQlzZWxmLnVzZXJNb2RpZmllZCA9IGZhbHNlOwoJCQlzZWxmLm1vdXNlTW92ZWQgPSBmYWxzZTsKCgkJCWlmICggY1R5cGUgPT09ICJzZWxlY3QiICkgewoJCQkJc2VsZi5iZWZvcmVTdGFydCA9IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfQoKCQkJc2VsZi5yZWZyZXNoKCBldmVudCApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSkKCQkuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCXNsaWRlci5hZGQoIGRvY3VtZW50ICkKCQkJLmJpbmQoICJ2bW91c2V1cCIsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBzZWxmLmRyYWdnaW5nICkgewoKCQkJCQlzZWxmLmRyYWdnaW5nID0gZmFsc2U7CgoJCQkJCWlmICggY1R5cGUgPT09ICJzZWxlY3QiKSB7CgoJCQkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJCQkJaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCQkJCWlmICggc2VsZi5tb3VzZU1vdmVkICkgewoKCQkJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCQkJaWYgKCBzZWxmLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgPT0gMCA/IDEgOiAwICk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIHsKCQkJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgKTsKCQkJCQkJCX0KCgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCQkvLyB0aGlzIGlzIGp1c3QgYSBjbGljaywgY2hhbmdlIHRoZSB2YWx1ZQoJCQkJCQkJc2VsZi5yZWZyZXNoKCBzZWxmLmJlZm9yZVN0YXJ0ID09IDAgPyAxIDogMCApOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJc2VsZi5tb3VzZU1vdmVkID0gZmFsc2U7CgoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgoJCXNsaWRlci5pbnNlcnRBZnRlciggY29udHJvbCApOwoKCQkvLyBPbmx5IGFkZCBmb2N1cyBjbGFzcyB0byB0b2dnbGUgc3dpdGNoLCBzbGlkZXJzIGdldCBpdCBhdXRvbWF0aWNhbGx5IGZyb20gdWktYnRuCgkJaWYoIGNUeXBlID09ICdzZWxlY3QnICkgewoJCQl0aGlzLmhhbmRsZS5iaW5kKHsKCQkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCQlzbGlkZXIuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0sCgoJCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkJc2xpZGVyLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJdGhpcy5oYW5kbGUuYmluZCh7CgkJCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCgkJCXZtb3VzZWRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmZvY3VzKCk7CgkJCX0sCgoJCQl2Y2xpY2s6IGZhbHNlLAoKCQkJa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIGluZGV4ID0gdmFsKCk7CgoJCQkJaWYgKCBzZWxmLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIEluIGFsbCBjYXNlcyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFuZCBtYXJrIHRoZSBoYW5kbGUgYXMgYWN0aXZlCgkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQkJaWYgKCAhc2VsZi5fa2V5U2xpZGluZyApIHsKCQkJCQkJCXNlbGYuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCQkJJCggdGhpcyApLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCS8vIG1vdmUgdGhlIHNsaWRlciBhY2NvcmRpbmcgdG8gdGhlIGtleXByZXNzCgkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJCQlzZWxmLnJlZnJlc2goIG1pbiApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJCQlzZWxmLnJlZnJlc2goIG1heCApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJCQlzZWxmLnJlZnJlc2goIGluZGV4ICsgc3RlcCApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJCQlzZWxmLnJlZnJlc2goIGluZGV4IC0gc3RlcCApOwoJCQkJCQlicmVhazsKCQkJCX0KCQkJfSwgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgoJCQlrZXl1cDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBzZWxmLl9rZXlTbGlkaW5nICkgewoJCQkJCXNlbGYuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQl9CgkJCX0KCQkJfSk7CgoJCXRoaXMucmVmcmVzaCh1bmRlZmluZWQsIHVuZGVmaW5lZCwgdHJ1ZSk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCB2YWwsIGlzZnJvbUNvbnRyb2wsIHByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoJ2Rpc2FibGVkJykpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQl2YXIgY29udHJvbCA9IHRoaXMuZWxlbWVudCwgcGVyY2VudCwKCQkJY1R5cGUgPSBjb250cm9sWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCW1pbiA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aCAtIDEsCgkJCXN0ZXAgPSAoY1R5cGUgPT09ICJpbnB1dCIgJiYgcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApID4gMCkgPyBwYXJzZUZsb2F0KGNvbnRyb2wuYXR0cigic3RlcCIpKSA6IDE7CgoJCWlmICggdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgKSB7CgkJCXZhciBkYXRhID0gdmFsLAoJCQkJLy8gYSBzbGlnaHQgdG9sZXJhbmNlIGhlbHBlZCBnZXQgdG8gdGhlIGVuZHMgb2YgdGhlIHNsaWRlcgoJCQkJdG9sID0gODsKCQkJaWYgKCAhdGhpcy5kcmFnZ2luZyB8fAoJCQkJCWRhdGEucGFnZVggPCB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0IC0gdG9sIHx8CgkJCQkJZGF0YS5wYWdlWCA+IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgKyB0aGlzLnNsaWRlci53aWR0aCgpICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXBlcmNlbnQgPSBNYXRoLnJvdW5kKCAoICggZGF0YS5wYWdlWCAtIHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKSAqIDEwMCApOwoJCX0gZWxzZSB7CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCXZhciBuZXd2YWwgPSAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKyBtaW47CgoJCS8vZnJvbSBqUXVlcnkgVUkgc2xpZGVyLCB0aGUgZm9sbG93aW5nIHNvdXJjZSB3aWxsIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQl2YXIgdmFsTW9kU3RlcCA9ICggbmV3dmFsIC0gbWluICkgJSBzdGVwOwoJCXZhciBhbGlnblZhbHVlID0gbmV3dmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyggdmFsTW9kU3RlcCApICogMiA+PSBzdGVwICkgewoJCQlhbGlnblZhbHVlICs9ICggdmFsTW9kU3RlcCA+IDAgKSA/IHN0ZXAgOiAoIC1zdGVwICk7CgkJfQoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlIGpRdWVyeVVJOiAjNDEyNCkKCQluZXd2YWwgPSBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoNSkgKTsKCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQl0aGlzLmhhbmRsZS5jc3MoICJsZWZ0IiwgcGVyY2VudCArICIlIiApOwoJCXRoaXMuaGFuZGxlLmF0dHIoIHsKCQkJCSJhcmlhLXZhbHVlbm93IjogY1R5cGUgPT09ICJpbnB1dCIgPyBuZXd2YWwgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSwKCQkJCSJhcmlhLXZhbHVldGV4dCI6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpLAoJCQkJdGl0bGU6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpCgkJCX0pOwoJCXRoaXMudmFsdWViZyAmJiB0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgoJCS8vIGRyYWcgdGhlIGxhYmVsIHdpZHRocwoJCWlmICggdGhpcy5fbGFiZWxzICkgewoJCQl2YXIgaGFuZGxlUGVyY2VudCA9IHRoaXMuaGFuZGxlLndpZHRoKCkgLyB0aGlzLnNsaWRlci53aWR0aCgpICogMTAwLAoJCQkJYVBlcmNlbnQgPSBwZXJjZW50ICYmIGhhbmRsZVBlcmNlbnQgKyAoIDEwMCAtIGhhbmRsZVBlcmNlbnQgKSAqIHBlcmNlbnQgLyAxMDAsCgkJCQliUGVyY2VudCA9IHBlcmNlbnQgPT09IDEwMCA/IDAgOiBNYXRoLm1pbiggaGFuZGxlUGVyY2VudCArIDEwMCAtIGFQZXJjZW50LCAxMDAgKTsKCgkJCXRoaXMuX2xhYmVscy5lYWNoKGZ1bmN0aW9uKCl7CgkJCQl2YXIgYWIgPSAkKHRoaXMpLmlzKCAiLnVpLXNsaWRlci1sYWJlbC1hIiApOwoJCQkJJCggdGhpcyApLndpZHRoKCAoIGFiID8gYVBlcmNlbnQgOiBiUGVyY2VudCAgKSArICIlIiApOwoJCQl9KTsKCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFyIHZhbHVlQ2hhbmdlZCA9IGZhbHNlOwoKCQkJLy8gdXBkYXRlIGNvbnRyb2wicyB2YWx1ZQoJCQlpZiAoIGNUeXBlID09PSAiaW5wdXQiICkgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbC52YWwoKSAhPT0gbmV3dmFsOwoJCQkJY29udHJvbC52YWwoIG5ld3ZhbCApOwoJCQl9IGVsc2UgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ID0gbmV3dmFsOwoJCQl9CgkJCWlmICggIWlzZnJvbUNvbnRyb2wgJiYgdmFsdWVDaGFuZ2VkICkgewoJCQkJY29udHJvbC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCXRoaXMuc2xpZGVyLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBmYWxzZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJdGhpcy5zbGlkZXIuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9Cgp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5zbGlkZXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zZWxlY3RtZW51IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWljb246ICJhcnJvdy1kIiwKCQlpY29ucG9zOiAicmlnaHQiLAoJCWlubGluZTogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpKSIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCiAgX3NlbGVjdE9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7CiAgfSwKCgkvLyBzZXR1cCBpdGVtcyB0aGF0IGFyZSBnZW5lcmFsbHkgbmVjZXNzYXJ5IGZvciBzZWxlY3QgbWVudSBleHRlbnNpb24KCV9wcmVFeHRlbnNpb246IGZ1bmN0aW9uKCl7CgkJdmFyIGNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYoICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gICIgdWktYnRuLWxlZnQiOwoJCX0KCQkKCQlpZiggICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLXJpZ2h0IjsKCQl9CgkJCgkJdGhpcy5zZWxlY3QgPSB0aGlzLmVsZW1lbnQud3JhcCggIjxkaXYgY2xhc3M9J3VpLXNlbGVjdCIgKyBjbGFzc2VzICsgIic+IiApOwoJCXRoaXMuc2VsZWN0SUQgID0gdGhpcy5zZWxlY3QuYXR0ciggImlkIiApOwoJCXRoaXMubGFiZWwgPSAkKCAibGFiZWxbZm9yPSciKyB0aGlzLnNlbGVjdElEICsiJ10iICkuYWRkQ2xhc3MoICJ1aS1zZWxlY3QiICk7CgkJdGhpcy5pc011bHRpcGxlID0gdGhpcy5zZWxlY3RbIDAgXS5tdWx0aXBsZTsKCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMub3B0aW9ucy50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLnNlbGVjdCwgImMiICk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9wcmVFeHRlbnNpb24oKTsKCiAJCS8vIEFsbG93cyBmb3IgZXh0ZW5zaW9uIG9mIHRoZSBuYXRpdmUgc2VsZWN0IGZvciBjdXN0b20gc2VsZWN0cyBhbmQgb3RoZXIgcGx1Z2lucwoJCS8vIHNlZSBzZWxlY3QuY3VzdG9tIGZvciBleGFtcGxlIGV4dGVuc2lvbgoJCS8vIFRPRE8gZXhwbG9yZSBwbHVnaW4gcmVnaXN0cmF0aW9uCgkJdGhpcy5fdHJpZ2dlciggImJlZm9yZUNyZWF0ZSIgKTsKCgkJdGhpcy5idXR0b24gPSB0aGlzLl9idXR0b24oKTsKCgkJdmFyIHNlbGYgPSB0aGlzLAoKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCgkJCS8vIElFIHRocm93cyBhbiBleGNlcHRpb24gYXQgb3B0aW9ucy5pdGVtKCkgZnVuY3Rpb24gd2hlbgoJCQkvLyB0aGVyZSBpcyBubyBzZWxlY3RlZCBpdGVtCgkJCS8vIHNlbGVjdCBmaXJzdCBpbiB0aGlzIGNhc2UKCQkJc2VsZWN0ZWRJbmRleCA9IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCA9PSAtMSA/IDAgOiB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgoJCQkvLyBUT0RPIHZhbHVlcyBidXR0b25JZCBhbmQgbWVudUlkIGFyZSB1bmRlZmluZWQgaGVyZQoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLnRleHQoICQoIHRoaXMuc2VsZWN0WyAwIF0ub3B0aW9ucy5pdGVtKCBzZWxlY3RlZEluZGV4ICkgKS50ZXh0KCkgKQoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmJ1dHRvbk1hcmt1cCggewoJCQkJCXRoZW1lOiBvcHRpb25zLnRoZW1lLAoJCQkJCWljb246IG9wdGlvbnMuaWNvbiwKCQkJCQlpY29ucG9zOiBvcHRpb25zLmljb25wb3MsCgkJCQkJaW5saW5lOiBvcHRpb25zLmlubGluZSwKCQkJCQljb3JuZXJzOiBvcHRpb25zLmNvcm5lcnMsCgkJCQkJc2hhZG93OiBvcHRpb25zLnNoYWRvdywKCQkJCQlpY29uc2hhZG93OiBvcHRpb25zLmljb25zaGFkb3csCgkJCQkJbWluaTogb3B0aW9ucy5taW5pCgkJCQl9KTsKCgkJLy8gT3BlcmEgZG9lcyBub3QgcHJvcGVybHkgc3VwcG9ydCBvcGFjaXR5IG9uIHNlbGVjdCBlbGVtZW50cwoJCS8vIEluIE1pbmksIGl0IGhpZGVzIHRoZSBlbGVtZW50LCBidXQgbm90IGl0cyB0ZXh0CgkJLy8gT24gdGhlIGRlc2t0b3AsaXQgc2VlbXMgdG8gZG8gdGhlIG9wcG9zaXRlCgkJLy8gZm9yIHRoZXNlIHJlYXNvbnMsIHVzaW5nIHRoZSBuYXRpdmVNZW51IG9wdGlvbiByZXN1bHRzIGluIGEgZnVsbCBuYXRpdmUgc2VsZWN0IGluIE9wZXJhCgkJaWYgKCBvcHRpb25zLm5hdGl2ZU1lbnUgJiYgd2luZG93Lm9wZXJhICYmIHdpbmRvdy5vcGVyYS52ZXJzaW9uICkgewoJCQl0aGlzLnNlbGVjdC5hZGRDbGFzcyggInVpLXNlbGVjdC1uYXRpdmVvbmx5IiApOwoJCX0KCgkJLy8gQWRkIGNvdW50ZXIgZm9yIG11bHRpIHNlbGVjdHMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudCA9ICQoICI8c3Bhbj4iICkKCQkJCS5hZGRDbGFzcyggInVpLWxpLWNvdW50IHVpLWJ0bi11cC1jIHVpLWJ0bi1jb3JuZXItYWxsIiApCgkJCQkuaGlkZSgpCgkJCQkuYXBwZW5kVG8oIGJ1dHRvbi5hZGRDbGFzcygndWktbGktaGFzLWNvdW50JykgKTsKCQl9CgoJCS8vIERpc2FibGUgaWYgc3BlY2lmaWVkCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCdkaXNhYmxlZCcpKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gRXZlbnRzIG9uIG5hdGl2ZSBzZWxlY3QKCQl0aGlzLnNlbGVjdC5jaGFuZ2UoIGZ1bmN0aW9uKCkgewoJCQlzZWxmLnJlZnJlc2goKTsKCQl9KTsKCgkJdGhpcy5idWlsZCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLnNlbGVjdAoJCQkuYXBwZW5kVG8oIHNlbGYuYnV0dG9uICkKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBBZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCiAgICAgICAgICAgIC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKICAgICAgICAgICAgfSkKCQkJLmJpbmQoICJmb2N1cyB2bW91c2VvdmVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCQkJfSkKCQkJLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIG9uIHNjcm9sbC90b3VjaG1vdmUKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIHZtb3VzZW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW91dCIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCX0pOwoKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQlzZWxmLmJ1dHRvbi5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQlpZiggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKXsKCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSkKCQkuYmluZCggIm1vdXNldXAiLCBmdW5jdGlvbigpIHsKCQkJaWYoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICl7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7Cgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5pbmRleCggdGhpcyApOwoJCX0pLmdldCgpOwoJfSwKCglzZXRCdXR0b25UZXh0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLnRleHQoIGZ1bmN0aW9uKCkgewoJCQlpZiAoICFzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQlyZXR1cm4gc2VsZWN0ZWQudGV4dCgpOwoJCQl9CgoJCQlyZXR1cm4gc2VsZWN0ZWQubGVuZ3RoID8gc2VsZWN0ZWQubWFwKCBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQl9KS5nZXQoKS5qb2luKCAiLCAiICkgOiBzZWxmLnBsYWNlaG9sZGVyOwoJCX0pOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuc2VsZWN0bWVudS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cn0pKCBqUXVlcnkgKTsKCi8qCiogY3VzdG9tICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIGV4dGVuZFNlbGVjdCA9IGZ1bmN0aW9uKCB3aWRnZXQgKXsKCgkJdmFyIHNlbGVjdCA9IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEICA9IHdpZGdldC5zZWxlY3RJRCwKCQkJbGFiZWwgPSB3aWRnZXQubGFiZWwsCgkJCXRoaXNQYWdlID0gd2lkZ2V0LnNlbGVjdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXNjcmVlbiA9ICQoICI8ZGl2PiIsIHsiY2xhc3MiOiAidWktc2VsZWN0bWVudS1zY3JlZW4gdWktc2NyZWVuLWhpZGRlbiJ9ICkuYXBwZW5kVG8oIHRoaXNQYWdlICksCgkJCXNlbGVjdE9wdGlvbnMgPSB3aWRnZXQuX3NlbGVjdE9wdGlvbnMoKSwKCQkJaXNNdWx0aXBsZSA9IHdpZGdldC5pc011bHRpcGxlID0gd2lkZ2V0LnNlbGVjdFsgMCBdLm11bHRpcGxlLAoJCQlidXR0b25JZCA9IHNlbGVjdElEICsgIi1idXR0b24iLAoJCQltZW51SWQgPSBzZWxlY3RJRCArICItbWVudSIsCgkJCW1lbnVQYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nZGlhbG9nJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgInRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy50aGVtZSArIicgZGF0YS0iICskLm1vYmlsZS5ucyArICJvdmVybGF5LXRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy5vdmVybGF5VGhlbWUgKyInPiIgKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0naGVhZGVyJz4iICsKCQkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJCSI8L2Rpdj4iKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nY29udGVudCc+PC9kaXY+IisKCQkJCSI8L2Rpdj4iICksCgoJCQlsaXN0Ym94ID0gICQoIjxkaXY+IiwgeyAiY2xhc3MiOiAidWktc2VsZWN0bWVudSB1aS1zZWxlY3RtZW51LWhpZGRlbiB1aS1vdmVybGF5LXNoYWRvdyB1aS1jb3JuZXItYWxsIHVpLWJvZHktIiArIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArICIgIiArICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIH0gKS5pbnNlcnRBZnRlcihzY3JlZW4pLAoKCQkJbGlzdCA9ICQoICI8dWw+IiwgewoJCQkJImNsYXNzIjogInVpLXNlbGVjdG1lbnUtbGlzdCIsCgkJCQkiaWQiOiBtZW51SWQsCgkJCQkicm9sZSI6ICJsaXN0Ym94IiwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBidXR0b25JZAoJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiLCB3aWRnZXQub3B0aW9ucy50aGVtZSApLmFwcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXIgPSAkKCAiPGRpdj4iLCB7CgkJCQkiY2xhc3MiOiAidWktaGVhZGVyIHVpLWJhci0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUKCQkJfSkucHJlcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXJUaXRsZSA9ICQoICI8aDE+IiwgewoJCQkJImNsYXNzIjogInVpLXRpdGxlIgoJCQl9KS5hcHBlbmRUbyggaGVhZGVyICksCgoJCQltZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2UsCgkJCWhlYWRlckNsb3NlOwoKCQlpZiggd2lkZ2V0LmlzTXVsdGlwbGUgKSB7CgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJ0ZXh0Ijogd2lkZ2V0Lm9wdGlvbnMuY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuLWxlZnQiCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiwgIm5vdGV4dCIgKS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbiIsICJkZWxldGUiICkuYXBwZW5kVG8oIGhlYWRlciApLmJ1dHRvbk1hcmt1cCgpOwoJCX0KCgkJJC5leHRlbmQoIHdpZGdldCwgewoJCQlzZWxlY3Q6IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEOiBzZWxlY3RJRCwKCQkJYnV0dG9uSWQ6IGJ1dHRvbklkLAoJCQltZW51SWQ6IG1lbnVJZCwKCQkJdGhpc1BhZ2U6IHRoaXNQYWdlLAoJCQltZW51UGFnZTogbWVudVBhZ2UsCgkJCWxhYmVsOiBsYWJlbCwKCQkJc2NyZWVuOiBzY3JlZW4sCgkJCXNlbGVjdE9wdGlvbnM6IHNlbGVjdE9wdGlvbnMsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiB3aWRnZXQub3B0aW9ucy50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiLAoKCQkJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCS8vIENyZWF0ZSBsaXN0IGZyb20gc2VsZWN0LCB1cGRhdGUgc3RhdGUKCQkJCXNlbGYucmVmcmVzaCgpOwoKCQkJCXNlbGYuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuYmx1cigpOwoJCQkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJCQl9KTsKCgkJCQkvLyBCdXR0b24gZXZlbnRzCgkJCQlzZWxmLmJ1dHRvbi5iaW5kKCAidmNsaWNrIGtleWRvd24iICwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmICggZXZlbnQudHlwZSA9PSAidmNsaWNrIiB8fAoJCQkJCQkJIGV2ZW50LmtleUNvZGUgJiYgKCBldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8CgkJCQkJCQkJCQkJCQkJCQkJZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5TUEFDRSApICkgewoKCQkJCQkJc2VsZi5vcGVuKCk7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIGZvciBsaXN0IGl0ZW1zCgkJCQlzZWxmLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKQoJCQkJCS5iaW5kKCAiZm9jdXNpbiIsIGZ1bmN0aW9uKCBlICl7CgkJCQkJCSQoIGUudGFyZ2V0ICkKCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkJCQkJLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoKCQkJCQl9KQoJCQkJCS5iaW5kKCAiZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApewoJCQkJCQkkKCBlLnRhcmdldCApCgkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApCgkJCQkJCQkudHJpZ2dlciggInZtb3VzZW91dCIgKTsKCQkJCQl9KQoJCQkJCS5kZWxlZ2F0ZSggImxpOm5vdCgudWktZGlzYWJsZWQsIC51aS1saS1kaXZpZGVyKSIsICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkJCS8vIGluZGV4IG9mIG9wdGlvbiB0YWcgdG8gYmUgc2VsZWN0ZWQKCQkJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCQkJbmV3SW5kZXggPSBzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuaW5kZXgoIHRoaXMgKSwKCQkJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCQkJLy8gdG9nZ2xlIHNlbGVjdGVkIHN0YXR1cyBvbiB0aGUgdGFnIGZvciBtdWx0aSBzZWxlY3RzCgkJCQkJCW9wdGlvbi5zZWxlY3RlZCA9IHNlbGYuaXNNdWx0aXBsZSA/ICFvcHRpb24uc2VsZWN0ZWQgOiB0cnVlOwoKCQkJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJJCggdGhpcyApLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iLCBvcHRpb24uc2VsZWN0ZWQgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJCQl9CgoJCQkJCQkvLyB0cmlnZ2VyIGNoYW5nZSBpZiB2YWx1ZSBjaGFuZ2VkCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQkJCXNlbGYuc2VsZWN0LnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJCX0KCgkJCQkJCS8vaGlkZSBjdXN0b20gc2VsZWN0IGZvciBzaW5nbGUgc2VsZWN0cyBvbmx5CgkJCQkJCWlmICggIXNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJfQoKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9KQoJCQkJCS5rZXlkb3duKGZ1bmN0aW9uKCBldmVudCApIHsgIC8va2V5Ym9hcmQgZXZlbnRzIGZvciBtZW51IGl0ZW1zCgkJCQkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJCQkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKSwKCQkJCQkJCXByZXYsIG5leHQ7CgoJCQkJCQkvLyBzd2l0Y2ggbG9naWMgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkJCQkvLyB1cCBvciBsZWZ0IGFycm93IGtleXMKCQkJCQkJIGNhc2UgMzg6CgkJCQkJCQlwcmV2ID0gbGkucHJldigpLm5vdCggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoKCQkJCQkJCWlmKCBwcmV2LmlzKCAiLnVpLWxpLWRpdmlkZXIiICkgKSB7CgkJCQkJCQkJcHJldiA9IHByZXYucHJldigpOwoJCQkJCQkJfQoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIHByZXYubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCXByZXYuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQkJLy8gZG93biBvciByaWdodCBhcnJvdyBrZXlzCgkJCQkJCSBjYXNlIDQwOgoJCQkJCQkJbmV4dCA9IGxpLm5leHQoKTsKCgkJCQkJCQlpZiggbmV4dC5pcyggIi51aS1saS1kaXZpZGVyIiApICkgewoJCQkJCQkJCW5leHQgPSBuZXh0Lm5leHQoKTsKCQkJCQkJCX0KCgkJCQkJCQkvLyBpZiB0aGVyZSdzIGEgbmV4dCBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIG5leHQubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCW5leHQuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQkJLy8gSWYgZW50ZXIgb3Igc3BhY2UgaXMgcHJlc3NlZCwgdHJpZ2dlciBjbGljawoJCQkJCQkgY2FzZSAxMzoKCQkJCQkJIGNhc2UgMzI6CgkJCQkJCQl0YXJnZXQudHJpZ2dlciggImNsaWNrIiApOwoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfSk7CgoJCQkJLy8gYnV0dG9uIHJlZm9jdXMgZW5zdXJlcyBwcm9wZXIgaGVpZ2h0IGNhbGN1bGF0aW9uCgkJCQkvLyBieSByZW1vdmluZyB0aGUgaW5saW5lIHN0eWxlIGFuZCBlbnN1cmluZyBwYWdlIGluY2x1c2lvbgoJCQkJc2VsZi5tZW51UGFnZS5iaW5kKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmxpc3QuYXBwZW5kVG8oIHNlbGYubGlzdGJveCApOwoJCQkJCXNlbGYuX2ZvY3VzQnV0dG9uKCk7CgoJCQkJCS8vIFRPRE8gY2VudHJhbGl6ZSBwYWdlIHJlbW92YWwgYmluZGluZyAvIGhhbmRsaW5nIGluIHRoZSBwYWdlIHBsdWdpbi4KCQkJCQkvLyBTdWdnZXN0aW9uIGZyb20gQGpibGFzIHRvIGRvIHJlZmNvdW50aW5nCgkJCQkJLy8KCQkJCQkvLyBUT0RPIGV4dHJlbWVseSBjb25mdXNpbmcgZGVwZW5kZW5jeSBvbiB0aGUgb3BlbiBtZXRob2Qgd2hlcmUgdGhlIHBhZ2VoaWRlLnJlbW92ZQoJCQkJCS8vIGJpbmRpbmdzIGFyZSBzdHJpcHBlZCB0byBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGRpc2FwcGVhcmluZy4gVGhlIHdheQoJCQkJCS8vIHdlJ3JlIGtlZXBpbmcgcGFnZXMgaW4gdGhlIERPTSByaWdodCBub3cgc3Vja3MKCQkJCQkvLwoJCQkJCS8vIHJlYmluZCB0aGUgcGFnZSByZW1vdmUgdGhhdCB3YXMgdW5ib3VuZCBpbiB0aGUgb3BlbiBmdW5jdGlvbgoJCQkJCS8vIHRvIGFsbG93IGZvciB0aGUgcGFyZW50IHBhZ2UgcmVtb3ZhbCBmcm9tIGFjdGlvbnMgb3RoZXIgdGhhbiB0aGUgdXNlCgkJCQkJLy8gb2YgYSBkaWFsb2cgc2l6ZWQgY3VzdG9tIHNlbGVjdAoJCQkJCS8vCgkJCQkJLy8gZG9pbmcgdGhpcyBoZXJlIHByb3ZpZGVzIGZvciB0aGUgYmFjayBidXR0b24gb24gdGhlIGN1c3RvbSBzZWxlY3QgZGlhbG9nCgkJCQkJJC5tb2JpbGUuX2JpbmRQYWdlUmVtb3ZlLmNhbGwoIHNlbGYudGhpc1BhZ2UgKTsKCQkJCX0pOwoKCQkJCS8vIEV2ZW50cyBvbiAic2NyZWVuIiBvdmVybGF5CgkJCQlzZWxmLnNjcmVlbi5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoKCQkJCS8vIENsb3NlIGJ1dHRvbiBvbiBzbWFsbCBvdmVybGF5cwoJCQkJaWYoIHNlbGYuaXNNdWx0aXBsZSApewoJCQkJCXNlbGYuaGVhZGVyQ2xvc2UuY2xpY2soIGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT0gIm92ZXJsYXkiICkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgoJCQkJLy8gdHJhY2sgdGhpcyBkZXBlbmRlbmN5IHNvIHRoYXQgd2hlbiB0aGUgcGFyZW50IHBhZ2UKCQkJCS8vIGlzIHJlbW92ZWQgb24gcGFnZWhpZGUgaXQgd2lsbCBhbHNvIHJlbW92ZSB0aGUgbWVudXBhZ2UKCQkJCXNlbGYudGhpc1BhZ2UuYWRkRGVwZW5kZW50cyggdGhpcy5tZW51UGFnZSApOwoJCQl9LAoKCQkJX2lzUmVidWlsZFJlcXVpcmVkOiBmdW5jdGlvbigpIHsKCQkJCXZhciBsaXN0ID0gdGhpcy5saXN0LmZpbmQoICJsaSIgKSwKCQkJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpOwoKCQkJCS8vIFRPRE8gZXhjZWVkaW5nbHkgbmFpdmUgbWV0aG9kIHRvIGRldGVybWluZSBkaWZmZXJlbmNlCgkJCQkvLyBpZ25vcmVzIHZhbHVlIGNoYW5nZXMgZXRjIGluIGZhdm9yIG9mIGEgZm9yY2VkUmVidWlsZAoJCQkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQkJCXJldHVybiBvcHRpb25zLnRleHQoKSAhPT0gbGlzdC50ZXh0KCk7CgkJCX0sCgoJCQlyZWZyZXNoOiBmdW5jdGlvbiggZm9yY2VSZWJ1aWxkICwgZm9vICl7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlzZWxlY3QgPSB0aGlzLmVsZW1lbnQsCgkJCQlpc011bHRpcGxlID0gdGhpcy5pc011bHRpcGxlLAoJCQkJb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKSwKCQkJCXNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpLAoJCQkJLy8gcmV0dXJuIGFuIGFycmF5IG9mIGFsbCBzZWxlY3RlZCBpbmRleCdzCgkJCQlpbmRpY2llcyA9IHRoaXMuc2VsZWN0ZWRJbmRpY2VzKCk7CgoJCQkJaWYgKCAgZm9yY2VSZWJ1aWxkIHx8IHRoaXMuX2lzUmVidWlsZFJlcXVpcmVkKCkgKSB7CgkJCQkJc2VsZi5fYnVpbGRMaXN0KCk7CgkJCQl9CgoJCQkJc2VsZi5zZXRCdXR0b25UZXh0KCk7CgkJCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApCgkJCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkJCS5lYWNoKGZ1bmN0aW9uKCBpICkgewoKCQkJCQkJaWYgKCAkLmluQXJyYXkoIGksIGluZGljaWVzICkgPiAtMSApIHsKCQkJCQkJCXZhciBpdGVtID0gJCggdGhpcyApOwoKCQkJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCQkJaXRlbS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIHRydWUgKTsKCgkJCQkJCQkvLyBNdWx0aXBsZSBzZWxlY3RzOiBhZGQgdGhlICJvbiIgY2hlY2tib3ggc3RhdGUgdG8gdGhlIGljb24KCQkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJCWl0ZW0uZmluZCggIi51aS1pY29uIiApLnJlbW92ZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiICkuYWRkQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiApOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlpZiggaXRlbS5pcyggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApICkgewoJCQkJCQkJCQlpdGVtLm5leHQoKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQlpdGVtLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQl9LAoKCQkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09ICJwYWdlIiApIHsKCQkJCQkvLyBkb2Vzbid0IHNvbHZlIHRoZSBwb3NzaWJsZSBpc3N1ZSB3aXRoIGNhbGxpbmcgY2hhbmdlIHBhZ2UKCQkJCQkvLyB3aGVyZSB0aGUgb2JqZWN0cyBkb24ndCBkZWZpbmUgZGF0YSB1cmxzIHdoaWNoIHByZXZlbnRzIGRpYWxvZyBrZXkKCQkJCQkvLyBzdHJpcHBpbmcgLSBjaGFuZ2VQYWdlIGhhcyBpbmNvbWluZyByZWZhY3RvcgoJCQkJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5zY3JlZW4uYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJCXNlbGYubGlzdGJveC5hZGRDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApLnJlbW92ZUF0dHIoICJzdHlsZSIgKS5yZW1vdmVDbGFzcyggImluIiApOwoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkJCX0KCgkJCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJfSwKCgkJCW9wZW46IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpcywKICAgICAgICAgICR3aW5kb3cgPSAkKCB3aW5kb3cgKSwKICAgICAgICAgIHNlbGZMaXN0UGFyZW50ID0gc2VsZi5saXN0LnBhcmVudCgpLAoJCQkJCW1lbnVIZWlnaHQgPSBzZWxmTGlzdFBhcmVudC5vdXRlckhlaWdodCgpLAoJCQkJCW1lbnVXaWR0aCA9IHNlbGZMaXN0UGFyZW50Lm91dGVyV2lkdGgoKSwKCQkJCQlhY3RpdmVQYWdlID0gJCggIi51aS1wYWdlLWFjdGl2ZSIgKSwKCQkJCQl0U2Nyb2xsRWxlbSA9IGFjdGl2ZVBhZ2UsCgkJCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCQlidG5PZmZzZXQgPSBzZWxmLmJ1dHRvbi5vZmZzZXQoKS50b3AsCgkJCQkJc2NyZWVuSGVpZ2h0ID0gJHdpbmRvdy5oZWlnaHQoKSwKCQkJCQlzY3JlZW5XaWR0aCA9ICR3aW5kb3cud2lkdGgoKTsKCgkJCQkvL2FkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkvL3JlbW92ZSBhZnRlciBkZWxheQoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9LCAzMDApOwoKCQkJCWZ1bmN0aW9uIGZvY3VzTWVudUl0ZW0oKSB7CgkJCQkJc2VsZi5saXN0LmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiBhIiApLmZvY3VzKCk7CgkJCQl9CgoJCQkJaWYgKCBtZW51SGVpZ2h0ID4gc2NyZWVuSGVpZ2h0IC0gODAgfHwgISQuc3VwcG9ydC5zY3JvbGxUb3AgKSB7CgoJCQkJCXNlbGYubWVudVBhZ2UuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCk7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQgPSBtZW51UGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICk7CgkJCQkJc2VsZi5tZW51UGFnZUNsb3NlID0gbWVudVBhZ2UuZmluZCggIi51aS1oZWFkZXIgYSIgKTsKCgkJCQkJLy8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBiZWluZyByZW1vdmVkIGZyb20gdGhlIERPTSwKCQkJCQkvLyBvdGhlcndpc2UgdGhlIHJlc3VsdHMgb2Ygc2VsZWN0aW5nIGEgbGlzdCBpdGVtIGluIHRoZSBkaWFsb2cKCQkJCQkvLyBmYWxsIGludG8gYSBibGFjayBob2xlCgkJCQkJc2VsZi50aGlzUGFnZS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICk7CgoJCQkJCS8vZm9yIFdlYk9TL09wZXJhIE1pbmkgKHNldCBsYXN0c2Nyb2xsIHVzaW5nIGJ1dHRvbiBvZmZzZXQpCgkJCQkJaWYgKCBzY3JvbGxUb3AgPT0gMCAmJiBidG5PZmZzZXQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQkJCXNlbGYudGhpc1BhZ2Uub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAibGFzdFNjcm9sbCIsIGJ0bk9mZnNldCApOwoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCXNlbGYubWVudVBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJZm9jdXNNZW51SXRlbSgpOwoJCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQkJfSk7CgoJCQkJCXNlbGYubWVudVR5cGUgPSAicGFnZSI7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQuYXBwZW5kKCBzZWxmLmxpc3QgKTsKCQkJCQlzZWxmLm1lbnVQYWdlLmZpbmQoImRpdiAudWktdGl0bGUiKS50ZXh0KHNlbGYubGFiZWwudGV4dCgpKTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBzZWxmLm1lbnVQYWdlLCB7CgkJCQkJCXRyYW5zaXRpb246ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uCgkJCQkJfSk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubWVudVR5cGUgPSAib3ZlcmxheSI7CgoJCQkJCXNlbGYuc2NyZWVuLmhlaWdodCggJChkb2N1bWVudCkuaGVpZ2h0KCkgKQoJCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoKCQkJCQkvLyBUcnkgYW5kIGNlbnRlciB0aGUgb3ZlcmxheSBvdmVyIHRoZSBidXR0b24KCQkJCQl2YXIgcm9vbXRvcCA9IGJ0bk9mZnNldCAtIHNjcm9sbFRvcCwKCQkJCQkJcm9vbWJvdCA9IHNjcm9sbFRvcCArIHNjcmVlbkhlaWdodCAtIGJ0bk9mZnNldCwKCQkJCQkJaGFsZmhlaWdodCA9IG1lbnVIZWlnaHQgLyAyLAoJCQkJCQltYXh3aWR0aCA9IHBhcnNlRmxvYXQoIHNlbGYubGlzdC5wYXJlbnQoKS5jc3MoICJtYXgtd2lkdGgiICkgKSwKCQkJCQkJbmV3dG9wLCBuZXdsZWZ0OwoKCQkJCQlpZiAoIHJvb210b3AgPiBtZW51SGVpZ2h0IC8gMiAmJiByb29tYm90ID4gbWVudUhlaWdodCAvIDIgKSB7CgkJCQkJCW5ld3RvcCA9IGJ0bk9mZnNldCArICggc2VsZi5idXR0b24ub3V0ZXJIZWlnaHQoKSAvIDIgKSAtIGhhbGZoZWlnaHQ7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gMzBweCB0b2xlcmFuY2Ugb2ZmIHRoZSBlZGdlcwoJCQkJCQluZXd0b3AgPSByb29tdG9wID4gcm9vbWJvdCA/IHNjcm9sbFRvcCArIHNjcmVlbkhlaWdodCAtIG1lbnVIZWlnaHQgLSAzMCA6IHNjcm9sbFRvcCArIDMwOwoJCQkJCX0KCgkJCQkJLy8gSWYgdGhlIG1lbnV3aWR0aCBpcyBzbWFsbGVyIHRoYW4gdGhlIHNjcmVlbiBjZW50ZXIgaXMKCQkJCQlpZiAoIG1lbnVXaWR0aCA8IG1heHdpZHRoICkgewoJCQkJCQluZXdsZWZ0ID0gKCBzY3JlZW5XaWR0aCAtIG1lbnVXaWR0aCApIC8gMjsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy9vdGhlcndpc2UgaW5zdXJlIGEgPj0gMzBweCBvZmZzZXQgZnJvbSB0aGUgbGVmdAoJCQkJCQluZXdsZWZ0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkubGVmdCArIHNlbGYuYnV0dG9uLm91dGVyV2lkdGgoKSAvIDIgLSBtZW51V2lkdGggLyAyOwoKCQkJCQkJLy8gMzBweCB0b2xlcmFuY2Ugb2ZmIHRoZSBlZGdlcwoJCQkJCQlpZiAoIG5ld2xlZnQgPCAzMCApIHsKCQkJCQkJCW5ld2xlZnQgPSAzMDsKCQkJCQkJfSBlbHNlIGlmICggKG5ld2xlZnQgKyBtZW51V2lkdGgpID4gc2NyZWVuV2lkdGggKSB7CgkJCQkJCQluZXdsZWZ0ID0gc2NyZWVuV2lkdGggLSBtZW51V2lkdGggLSAzMDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJc2VsZi5saXN0Ym94LmFwcGVuZCggc2VsZi5saXN0ICkKCQkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2VsZWN0bWVudS1oaWRkZW4iICkKCQkJCQkJLmNzcyh7CgkJCQkJCQl0b3A6IG5ld3RvcCwKCQkJCQkJCWxlZnQ6IG5ld2xlZnQKCQkJCQkJfSkKCQkJCQkJLmFkZENsYXNzKCAiaW4iICk7CgoJCQkJCWZvY3VzTWVudUl0ZW0oKTsKCgkJCQkJLy8gZHVwbGljYXRlIHdpdGggdmFsdWUgc2V0IGluIHBhZ2Ugc2hvdyBmb3IgZGlhbG9nIHNpemVkIHNlbGVjdHMKCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQl9CgkJCX0sCgoJCQlfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQkJCW9wdGdyb3VwcyA9IFtdLAoJCQkJCWxpcyA9IFtdLAoJCQkJCWRhdGFJY29uID0gc2VsZi5pc011bHRpcGxlID8gImNoZWNrYm94LW9mZiIgOiAiZmFsc2UiOwoKCQkJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgoJCQkJdmFyICRvcHRpb25zID0gc2VsZi5zZWxlY3QuZmluZCgib3B0aW9uIiksCgkJCQkJbnVtT3B0aW9ucyA9ICRvcHRpb25zLmxlbmd0aCwKCQkJCQlzZWxlY3QgPSB0aGlzLnNlbGVjdFsgMCBdLAoJCQkJCWRhdGFQcmVmaXggPSAnZGF0YS0nICsgJC5tb2JpbGUubnMsCgkJCQkJZGF0YUluZGV4QXR0ciA9IGRhdGFQcmVmaXggKyAnb3B0aW9uLWluZGV4JywKCQkJCQlkYXRhSWNvbkF0dHIgPSBkYXRhUHJlZml4ICsgJ2ljb24nLAoJCQkJCWRhdGFSb2xlQXR0ciA9IGRhdGFQcmVmaXggKyAncm9sZScsCgkJCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCQkJb3B0R3JvdXA7CgoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBudW1PcHRpb25zO2krKyl7CgkJCQkJdmFyIG9wdGlvbiA9ICRvcHRpb25zW2ldLAoJCQkJCQkkb3B0aW9uID0gJChvcHRpb24pLAoJCQkJCQlwYXJlbnQgPSBvcHRpb24ucGFyZW50Tm9kZSwKCQkJCQkJdGV4dCA9ICRvcHRpb24udGV4dCgpLAoJCQkJCQlhbmNob3IgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpLAoJCQkJCQljbGFzc2VzID0gW107CgoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCcjJyk7CgkJCQkJYW5jaG9yLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpKTsKCgkJCQkJLy8gQXJlIHdlIGluc2lkZSBhbiBvcHRncm91cD8KCQkJCQlpZiAocGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIpewoJCQkJCQl2YXIgb3B0TGFiZWwgPSBwYXJlbnQuZ2V0QXR0cmlidXRlKCdsYWJlbCcpOwoJCQkJCQlpZiAoIG9wdExhYmVsICE9IG9wdEdyb3VwKSB7CgkJCQkJCQl2YXIgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZShkYXRhUm9sZUF0dHIsJ2xpc3QtZGl2aWRlcicpOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCdvcHRpb24nKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsJy0xJyk7CgkJCQkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKG9wdExhYmVsKSk7CgkJCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZChkaXZpZGVyKTsKCQkJCQkJCW9wdEdyb3VwID0gb3B0TGFiZWw7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmIChuZWVkUGxhY2Vob2xkZXIgJiYgKCFvcHRpb24uZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgfHwgdGV4dC5sZW5ndGggPT0gMCB8fCAkb3B0aW9uLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSkpIHsKCQkJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQkJCWlmICggby5oaWRlUGxhY2Vob2xkZXJNZW51SXRlbXMgKSB7CgkJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoJCQkJCQl9CgkJCQkJCWlmICghcGxhY2Vob2xkZXIpIHsKCQkJCQkJCXBsYWNlaG9sZGVyID0gc2VsZi5wbGFjZWhvbGRlciA9IHRleHQ7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCXZhciBpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTsKCQkJCQlpZiAoIG9wdGlvbi5kaXNhYmxlZCApIHsKCQkJCQkJY2xhc3Nlcy5wdXNoKCAidWktZGlzYWJsZWQiICk7CgkJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCdhcmlhLWRpc2FibGVkJyx0cnVlKTsKCQkJCQl9CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoZGF0YUluZGV4QXR0cixpKTsKCQkJCQlpdGVtLnNldEF0dHJpYnV0ZShkYXRhSWNvbkF0dHIsZGF0YUljb24pOwoJCQkJCWl0ZW0uY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCIgIik7CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCdvcHRpb24nKTsKCQkJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsJy0xJyk7CgkJCQkJaXRlbS5hcHBlbmRDaGlsZChhbmNob3IpOwoJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKGl0ZW0pOwoJCQkJfQoKCQkJCXNlbGYubGlzdFswXS5hcHBlbmRDaGlsZChmcmFnbWVudCk7CgoJCQkJLy8gSGlkZSBoZWFkZXIgaWYgaXQncyBub3QgYSBtdWx0aXNlbGVjdCBhbmQgdGhlcmUncyBubyBwbGFjZWhvbGRlcgoJCQkJaWYgKCAhdGhpcy5pc011bHRpcGxlICYmICFwbGFjZWhvbGRlci5sZW5ndGggKSB7CgkJCQkJdGhpcy5oZWFkZXIuaGlkZSgpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmhlYWRlclRpdGxlLnRleHQoIHRoaXMucGxhY2Vob2xkZXIgKTsKCQkJCX0KCgkJCQkvLyBOb3cgcG9wdWxhdGVkLCBjcmVhdGUgbGlzdHZpZXcKCQkJCXNlbGYubGlzdC5saXN0dmlldygpOwoJCQl9LAoKCQkJX2J1dHRvbjogZnVuY3Rpb24oKXsKCQkJCXJldHVybiAkKCAiPGE+IiwgewoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCQkiaWQiOiB0aGlzLmJ1dHRvbklkLAoJCQkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJhcmlhLW93bnMiOiB0aGlzLm1lbnVJZAoJCQkJfSk7CgkJCX0KCQl9KTsKCX07CgoJLy8gaXNzdWUgIzM4OTQgLSBjb3JlIGRvZXNuJ3QgdHJpZ2dlcmVkIGV2ZW50cyBvbiBkaXNhYmxlZCBkZWxlZ2F0ZXMKCSQoIGRvY3VtZW50ICkuYmluZCggInNlbGVjdG1lbnViZWZvcmVjcmVhdGUiLCBmdW5jdGlvbiggZXZlbnQgKXsKCQl2YXIgc2VsZWN0bWVudVdpZGdldCA9ICQoIGV2ZW50LnRhcmdldCApLmRhdGEoICJzZWxlY3RtZW51IiApOwoKCQlpZiggIXNlbGVjdG1lbnVXaWRnZXQub3B0aW9ucy5uYXRpdmVNZW51ICl7CgkJCWV4dGVuZFNlbGVjdCggc2VsZWN0bWVudVdpZGdldCApOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgoJJC53aWRnZXQoICJtb2JpbGUuZml4ZWR0b29sYmFyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgkJb3B0aW9uczogewoJCQl2aXNpYmxlT25QYWdlU2hvdzogdHJ1ZSwKCQkJZGlzYWJsZVBhZ2Vab29tOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAic2xpZGUiLCAvL2NhbiBiZSBub25lLCBmYWRlLCBzbGlkZSAoc2xpZGUgbWFwcyB0byBzbGlkZXVwIG9yIHNsaWRlZG93bikKCQkJZnVsbHNjcmVlbjogZmFsc2UsCgkJCXRhcFRvZ2dsZTogdHJ1ZSwKCQkJdGFwVG9nZ2xlQmxhY2tsaXN0OiAiYSwgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIC51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiLAoJCQloaWRlRHVyaW5nRm9jdXM6ICJpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCIsCgkJCXVwZGF0ZVBhZ2VQYWRkaW5nOiB0cnVlLAoJCQl0cmFja1BlcnNpc3RlbnRUb29sYmFyczogdHJ1ZSwKCgkJCS8vIEJyb3dzZXIgZGV0ZWN0aW9uISBXZWVlZSwgaGVyZSB3ZSBnby4uLgoJCQkvLyBVbmZvcnR1bmF0ZWx5LCBwb3NpdGlvbjpmaXhlZCBpcyBjb3N0bHksIG5vdCB0byBtZW50aW9uIHByb2JhYmx5IGltcG9zc2libGUsIHRvIGZlYXR1cmUtZGV0ZWN0IGFjY3VyYXRlbHkuCgkJCS8vIFNvbWUgdGVzdHMgZXhpc3QsIGJ1dCB0aGV5IGN1cnJlbnRseSByZXR1cm4gZmFsc2UgcmVzdWx0cyBpbiBjcml0aWNhbCBkZXZpY2VzIGFuZCBicm93c2Vycywgd2hpY2ggY291bGQgbGVhZCB0byBhIGJyb2tlbiBleHBlcmllbmNlLgoJCQkvLyBUZXN0aW5nIGZpeGVkIHBvc2l0aW9uaW5nIGlzIGFsc28gcHJldHR5IG9idHJ1c2l2ZSB0byBwYWdlIGxvYWQsIHJlcXVpcmluZyBpbmplY3RlZCBlbGVtZW50cyBhbmQgc2Nyb2xsaW5nIHRoZSB3aW5kb3cKCQkJLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBzZXJ2ZXMgdG8gcnVsZSBvdXQgc29tZSBwb3B1bGFyIGJyb3dzZXJzIHdpdGgga25vd24gZml4ZWQtcG9zaXRpb25pbmcgaXNzdWVzCgkJCS8vIFRoaXMgaXMgYSBwbHVnaW4gb3B0aW9uIGxpa2UgYW55IG90aGVyLCBzbyBmZWVsIGZyZWUgdG8gaW1wcm92ZSBvciBvdmVyd3JpdGUgaXQKCQkJc3VwcG9ydEJsYWNrbGlzdDogZnVuY3Rpb24oKXsKCQkJCXZhciB3ID0gd2luZG93LAoJCQkJCXVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkJCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCQkJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQkJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQkJCWZmbWF0Y2ggPSB1YS5tYXRjaCggL0Zlbm5lY1wvKFswLTldKykvICksCgkJCQkJZmZ2ZXJzaW9uID0gISFmZm1hdGNoICYmIGZmbWF0Y2hbIDEgXSwKCQkJCQlvcGVyYW1tb2JpbGVtYXRjaCA9IHVhLm1hdGNoKCAvT3BlcmEgTW9iaVwvKFswLTldKykvICksCgkJCQkJb212ZXJzaW9uID0gISFvcGVyYW1tb2JpbGVtYXRjaCAmJiBvcGVyYW1tb2JpbGVtYXRjaFsgMSBdOwoKCQkJCWlmKAoJCQkJCS8vIGlPUyA0LjMgYW5kIG9sZGVyIDogUGxhdGZvcm0gaXMgaVBob25lL1BhZC9Ub3VjaCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzNCAoaW9zNSkKCQkJCQkoICggcGxhdGZvcm0uaW5kZXhPZiggImlQaG9uZSIgKSA+IC0xIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUGFkIiApID4gLTEgIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUG9kIiApID4gLTEgKSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkKCQkJCQl8fAoJCQkJCS8vIE9wZXJhIE1pbmkKCQkJCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKQoJCQkJCXx8CgkJCQkJKCBvcGVyYW1tb2JpbGVtYXRjaCAmJiBvbXZlcnNpb24gPCA3NDU4ICkKCQkJCQl8fAoJCQkJCS8vQW5kcm9pZCBsdGUgMi4xOiBQbGF0Zm9ybSBpcyBBbmRyb2lkIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTMzIChBbmRyb2lkIDIuMikKCQkJCQkoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzMyApCgkJCQkJfHwKCQkJCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkJCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkKCQkJCQl8fAoJCQkJCS8vIFdlYk9TIGxlc3MgdGhhbiAzCgkJCQkJKCAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3cgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApCgkJCQkJfHwKCQkJCQkvLyBNZWVHbwoJCQkJCSggdWEuaW5kZXhPZiggIk1lZUdvIiApID4gLTEgJiYgdWEuaW5kZXhPZiggIk5va2lhQnJvd3Nlci84LjUuMCIgKSA+IC0xICkKCQkJCSl7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9LAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQkkZWwgPSBzZWxmLmVsZW1lbnQsCgkJCQl0YnR5cGUgPSAkZWwuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciIsCgkJCQkkcGFnZSA9ICRlbC5jbG9zZXN0KCIudWktcGFnZSIpOwoKCQkJLy8gRmVhdHVyZSBkZXRlY3Rpbmcgc3VwcG9ydCBmb3IKCQkJaWYoIG8uc3VwcG9ydEJsYWNrbGlzdCgpICl7CgkJCQlzZWxmLmRlc3Ryb3koKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJJGVsLmFkZENsYXNzKCAidWktIisgdGJ0eXBlICsiLWZpeGVkIiApOwoKCQkJLy8gImZ1bGxzY3JlZW4iIG92ZXJsYXkgcG9zaXRpb25pbmcKCQkJaWYoIG8uZnVsbHNjcmVlbiApewoJCQkJJGVsLmFkZENsYXNzKCAidWktIisgdGJ0eXBlICsiLWZ1bGxzY3JlZW4iICk7CgkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRidHlwZSArICItZnVsbHNjcmVlbiIgKTsKCQkJfQoJCQkvLyBJZiBub3QgZnVsbHNjcmVlbiwgYWRkIGNsYXNzIHRvIHBhZ2UgdG8gc2V0IHRvcCBvciBib3R0b20gcGFkZGluZwoJCQllbHNlewoJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0YnR5cGUgKyAiLWZpeGVkIiApOwoJCQl9CgoJCQlzZWxmLl9hZGRUcmFuc2l0aW9uQ2xhc3MoKTsKCQkJc2VsZi5fYmluZFBhZ2VFdmVudHMoKTsKCQkJc2VsZi5fYmluZFRvZ2dsZUhhbmRsZXJzKCk7CgkJfSwKCgkJX2FkZFRyYW5zaXRpb25DbGFzczogZnVuY3Rpb24oKXsKCQkJdmFyIHRjbGFzcyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoKCQkJaWYoIHRjbGFzcyAmJiB0Y2xhc3MgIT09ICJub25lIiApewoJCQkJLy8gdXNlIGFwcHJvcHJpYXRlIHNsaWRlIGZvciBoZWFkZXIgb3IgZm9vdGVyCgkJCQlpZiggdGNsYXNzID09PSAic2xpZGUiICl7CgkJCQkJdGNsYXNzID0gdGhpcy5lbGVtZW50LmlzKCAiLnVpLWhlYWRlciIgKSA/ICJzbGlkZWRvd24iIDogInNsaWRldXAiOwoJCQkJfQoKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGNsYXNzICk7CgkJCX0KCQl9LAoKCQlfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCl7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQkkZWwgPSBzZWxmLmVsZW1lbnQ7CgoJCQkvL3BhZ2UgZXZlbnQgYmluZGluZ3MKCQkJLy8gRml4ZWQgdG9vbGJhcnMgcmVxdWlyZSBwYWdlIHpvb20gdG8gYmUgZGlzYWJsZWQsIG90aGVyd2lzZSB1c2FiaWxpdHkgaXNzdWVzIGNyb3AgdXAKCQkJLy8gVGhpcyBtZXRob2QgaXMgbWVhbnQgdG8gZGlzYWJsZSB6b29tIHdoaWxlIGEgZml4ZWQtcG9zaXRpb25lZCB0b29sYmFyIHBhZ2UgaXMgdmlzaWJsZQoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApCgkJCQkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKXsKCQkJCQlpZiggby5kaXNhYmxlUGFnZVpvb20gKXsKCQkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCQkJfQoJCQkJCWlmKCAhby52aXNpYmxlT25QYWdlU2hvdyApewoJCQkJCQlzZWxmLmhpZGUoIHRydWUgKTsKCQkJCQl9CgkJCQl9ICkKCQkJCS5iaW5kKCAid2Via2l0QW5pbWF0aW9uU3RhcnQgYW5pbWF0aW9uc3RhcnQgdXBkYXRlbGF5b3V0IiwgZnVuY3Rpb24oKXsKCQkJCQlpZiggby51cGRhdGVQYWdlUGFkZGluZyApewoJCQkJCQlzZWxmLnVwZGF0ZVBhZ2VQYWRkaW5nKCk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAicGFnZXNob3ciLCBmdW5jdGlvbigpewoJCQkJCXNlbGYudXBkYXRlUGFnZVBhZGRpbmcoKTsKCQkJCQlpZiggby51cGRhdGVQYWdlUGFkZGluZyApewoJCQkJCQkkKCB3aW5kb3cgKS5iaW5kKCAidGhyb3R0bGVkcmVzaXplLiIgKyBzZWxmLndpZGdldE5hbWUsIGZ1bmN0aW9uKCl7CgkJCQkJCSAJc2VsZi51cGRhdGVQYWdlUGFkZGluZygpOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9KQoJCQkJLmJpbmQoICJwYWdlYmVmb3JlaGlkZSIsIGZ1bmN0aW9uKCBlLCB1aSApewoJCQkJCWlmKCBvLmRpc2FibGVQYWdlWm9vbSApewoJCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJCX0KCQkJCQlpZiggby51cGRhdGVQYWdlUGFkZGluZyApewoJCQkJCQkkKCB3aW5kb3cgKS51bmJpbmQoICJ0aHJvdHRsZWRyZXNpemUuIiArIHNlbGYud2lkZ2V0TmFtZSApOwoJCQkJCX0KCgkJCQkJaWYoIG8udHJhY2tQZXJzaXN0ZW50VG9vbGJhcnMgKXsKCQkJCQkJdmFyIHRoaXNGb290ZXIgPSAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMgKSwKCQkJCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMgKSwKCQkJCQkJCW5leHRGb290ZXIgPSB0aGlzRm9vdGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0Zvb3Rlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApLAoJCQkJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICk7CgoJCQkJCQluZXh0Rm9vdGVyID0gbmV4dEZvb3RlciB8fCAkKCk7CgoJCQkJCQkJaWYoIG5leHRGb290ZXIubGVuZ3RoIHx8IG5leHRIZWFkZXIubGVuZ3RoICl7CgoJCQkJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpewoJCQkJCQkJCQluZXh0Rm9vdGVyLmFkZCggbmV4dEhlYWRlciApLmFwcGVuZFRvKCB0aGlzICk7CgkJCQkJCQkJfSk7CgkJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5pcyggIi51aS1oZWFkZXIiICk7CgoJCQkvLyBUaGlzIGJlaGF2aW9yIG9ubHkgYXBwbGllcyB0byAiZml4ZWQiLCBub3QgImZ1bGxzY3JlZW4iCgkJCWlmKCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiApeyByZXR1cm47IH0KCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICRlbC5vdXRlckhlaWdodCgpICk7CgkJfSwKCQkKCQlfdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApewoJCQl2YXIgJHdpbiA9ICQoIHdpbmRvdyApLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuaGVpZ2h0KCksCgkJCQl2aWV3cG9ydEhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiOwoJCQkJCgkJCXJldHVybiAhbm90cmFuc2l0aW9uICYmCgkJCQkoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICYmIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICE9PSAibm9uZSIgJiYKCQkJCSgKCQkJCQkoIHRidHlwZSA9PT0gImhlYWRlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCA+IGVsSGVpZ2h0ICkgfHwKCQkJCQkoIHRidHlwZSA9PT0gImZvb3RlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCArIHZpZXdwb3J0SGVpZ2h0IDwgcEhlaWdodCAtIGVsSGVpZ2h0ICkKCQkJCSkgfHwgdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4KCQkJCSk7CgkJfSwKCgkJc2hvdzogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCQkJaWYoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICl7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwucmVtb3ZlQ2xhc3MoIGhpZGVDbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSB0cnVlOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKXsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKXsKCQkJCSRlbAoJCQkJCS5hZGRDbGFzcyggb3V0Y2xhc3MgKQoJCQkJCS5yZW1vdmVDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCBmdW5jdGlvbigpewoJCQkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gZmFsc2U7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbigpewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50OwoKCQkJLy8gdGFwIHRvZ2dsZQoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApCgkJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBlICl7CgkJCQkJaWYoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICl7CgkJCQkJCXNlbGYudG9nZ2xlKCk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZm9jdXNpbiBmb2N1c291dCIsIGZ1bmN0aW9uKCBlICl7CgkJCQkJaWYoIHNjcmVlbi53aWR0aCA8IDUwMCAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApewoJCQkJCQlzZWxmWyAoIGUudHlwZSA9PT0gImZvY3VzaW4iICYmIHNlbGYuX3Zpc2libGUgKSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJZGVzdHJveTogZnVuY3Rpb24oKXsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwoKCS8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwoJJCggZG9jdW1lbnQgKQoJCS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJCQkKCQkJLy8gREVQUkVDQVRFRCBpbiAxLjE6IHN1cHBvcnQgZm9yIGRhdGEtZnVsbHNjcmVlbj10cnVlfGZhbHNlIG9uIHRoZSBwYWdlIGVsZW1lbnQuCgkJCS8vIFRoaXMgbGluZSBlbnN1cmVzIGl0IHN0aWxsIHdvcmtzLCBidXQgd2UgcmVjb21tZW5kIG1vdmluZyB0aGUgYXR0cmlidXRlIHRvIHRoZSB0b29sYmFycyB0aGVtc2VsdmVzLgoJCQlpZiggJCggZS50YXJnZXQgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIgKSApewoJCQkJJCggJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5ub3QoICI6anFtRGF0YShmdWxsc2NyZWVuKSIgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIsIHRydWUgKTsKCQkJfQoJCQkKCQkJJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwoJCX0pOwoKfSkoIGpRdWVyeSApOwoKKCBmdW5jdGlvbiggJCwgd2luZG93ICkgewoJCgkvLyBUaGlzIGZpeCBhZGRyZXNzZXMgYW4gaU9TIGJ1Zywgc28gcmV0dXJuIGVhcmx5IGlmIHRoZSBVQSBjbGFpbXMgaXQncyBzb21ldGhpbmcgZWxzZS4KCWlmKCAhKC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICkgKXsKCQlyZXR1cm47Cgl9CgkKICAgIHZhciB6b29tID0gJC5tb2JpbGUuem9vbSwKCQlldnQsIHgsIHksIHosIGFpZzsKCQogICAgZnVuY3Rpb24gY2hlY2tUaWx0KCBlICl7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoJCQoJCXggPSBNYXRoLmFicyggYWlnLnggKTsKCQl5ID0gTWF0aC5hYnMoIGFpZy55ICk7CgkJeiA9IE1hdGguYWJzKCBhaWcueiApOwoJCQkJCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCiAgICAgICAgaWYoICF3aW5kb3cub3JpZW50YXRpb24gJiYgKCB4ID4gNyB8fCAoICggeiA+IDYgJiYgeSA8IDggfHwgeiA8IDggJiYgeSA+IDYgKSAmJiB4ID4gNSApICkgKXsKCQkJaWYoIHpvb20uZW5hYmxlZCApewoJCQkJem9vbS5kaXNhYmxlKCk7CgkJCX0gICAgICAgIAkKICAgICAgICB9CgkJZWxzZSBpZiggIXpvb20uZW5hYmxlZCApewoJCQl6b29tLmVuYWJsZSgpOwogICAgICAgIH0KICAgIH0KCiAgICAkKCB3aW5kb3cgKQoJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJLmJpbmQoICJkZXZpY2Vtb3Rpb24uaW9zb3JpZW50YXRpb25maXgiLCBjaGVja1RpbHQgKTsKCn0oIGpRdWVyeSwgdGhpcyApKTsKCiggZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJCSRoZWFkID0gJCggImhlYWQiICksCgkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCiAJLy8gdHJpZ2dlciBtb2JpbGVpbml0IGV2ZW50IC0gdXNlZnVsIGhvb2sgZm9yIGNvbmZpZ3VyaW5nICQubW9iaWxlIHNldHRpbmdzIGJlZm9yZSB0aGV5J3JlIHVzZWQKCSQoIHdpbmRvdy5kb2N1bWVudCApLnRyaWdnZXIoICJtb2JpbGVpbml0IiApOwoKCS8vIHN1cHBvcnQgY29uZGl0aW9ucwoJLy8gaWYgZGV2aWNlIHN1cHBvcnQgY29uZGl0aW9uKHMpIGFyZW4ndCBtZXQsIGxlYXZlIHRoaW5ncyBhcyB0aGV5IGFyZSAtPiBhIGJhc2ljLCB1c2FibGUgZXhwZXJpZW5jZSwKCS8vIG90aGVyd2lzZSwgcHJvY2VlZCB3aXRoIHRoZSBlbmhhbmNlbWVudHMKCWlmICggISQubW9iaWxlLmdyYWRlQSgpICkgewoJCXJldHVybjsKCX0KCgkvLyBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzCgkvLyBvciBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChCQjUsIE9wZXJhIE1pbmkpCglpZiAoICQubW9iaWxlLmFqYXhCbGFja2xpc3QgKSB7CgkJJC5tb2JpbGUuYWpheEVuYWJsZWQgPSBmYWxzZTsKCX0KCgkvLyBBZGQgbW9iaWxlLCBpbml0aWFsIGxvYWQgInJlbmRlcmluZyIgY2xhc3NlcyB0byBkb2NFbAoJJGh0bWwuYWRkQ2xhc3MoICJ1aS1tb2JpbGUgdWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCgkvLyBUaGlzIGlzIGEgZmFsbGJhY2suIElmIGFueXRoaW5nIGdvZXMgd3JvbmcgKEpTIGVycm9ycywgZXRjKSwgb3IgZXZlbnRzIGRvbid0IGZpcmUsCgkvLyB0aGlzIGVuc3VyZXMgdGhlIHJlbmRlcmluZyBjbGFzcyBpcyByZW1vdmVkIGFmdGVyIDUgc2Vjb25kcywgc28gY29udGVudCBpcyB2aXNpYmxlIGFuZCBhY2Nlc3NpYmxlCglzZXRUaW1lb3V0KCBoaWRlUmVuZGVyaW5nQ2xhc3MsIDUwMDAgKTsKCgkvLyBsb2FkaW5nIGRpdiB3aGljaCBhcHBlYXJzIGR1cmluZyBBamF4IHJlcXVlc3RzCgkvLyB3aWxsIG5vdCBhcHBlYXIgaWYgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgaXMgZmFsc2UKCXZhciBsb2FkZXJDbGFzcyA9ICJ1aS1sb2FkZXIiLAoJCSRsb2FkZXIgPSAkKCAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+PHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi1sb2FkaW5nJz48L3NwYW4+PGgxPjwvaDE+PC9kaXY+IiApOwoKCS8vIEZvciBub24tZml4ZWQgc3VwcG9ydGluIGJyb3dzZXJzLiBQb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCglmdW5jdGlvbiBmYWtlRml4TG9hZGVyKCl7CgkJdmFyIGFjdGl2ZUJ0biA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZmlyc3QoKTsKCgkJJGxvYWRlcgoJCQkuY3NzKHsKCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiAkd2luZG93LnNjcm9sbFRvcCgpICsgJHdpbmRvdy5oZWlnaHQoKSAvIDIgfHwKCQkJCWFjdGl2ZUJ0bi5sZW5ndGggJiYgYWN0aXZlQnRuLm9mZnNldCgpLnRvcCB8fCAxMDAKCQkJfSk7Cgl9CgoJLy8gY2hlY2sgcG9zaXRpb24gb2YgbG9hZGVyIHRvIHNlZSBpZiBpdCBhcHBlYXJzIHRvIGJlICJmaXhlZCIgdG8gY2VudGVyCgkvLyBpZiBub3QsIHVzZSBhYnMgcG9zaXRpb25pbmcKCWZ1bmN0aW9uIGNoZWNrTG9hZGVyUG9zaXRpb24oKXsKCQl2YXIgb2Zmc2V0ID0gJGxvYWRlci5vZmZzZXQoKSwKCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWlmKCBvZmZzZXQudG9wIDwgc2Nyb2xsVG9wIHx8IChvZmZzZXQudG9wIC0gc2Nyb2xsVG9wKSA+IHNjcmVlbkhlaWdodCApIHsKCQkJJGxvYWRlci5hZGRDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQlmYWtlRml4TG9hZGVyKCk7CgkJCSR3aW5kb3cKCQkJCS51bmJpbmQoICJzY3JvbGwiLCBjaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCS5iaW5kKCAic2Nyb2xsIiwgZmFrZUZpeExvYWRlciApOwoJCX0KCX0KCgkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCglmdW5jdGlvbiBoaWRlUmVuZGVyaW5nQ2xhc3MoKXsKCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLW1vYmlsZS1yZW5kZXJpbmciICk7Cgl9CgoJJC5leHRlbmQoJC5tb2JpbGUsIHsKCQkvLyB0dXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4KCQlzaG93UGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCSRodG1sLmFkZENsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgKSB7CgkJCQkvLyB0ZXh0IHZpc2liaWxpdHkgZnJvbSBhcmd1bWVudCB0YWtlcyBwcmlvcml0eQoJCQkJdmFyIHRleHRWaXNpYmxlID0gdGV4dG9ubHkgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTsKCgkJCQl0aGVtZSA9IHRoZW1lIHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGhlbWUsCgoJCQkJJGxvYWRlcgoJCQkJCS5hdHRyKCAiY2xhc3MiLCBsb2FkZXJDbGFzcyArICIgdWktY29ybmVyLWFsbCB1aS1ib2R5LSIgKyAoIHRoZW1lIHx8ICJhIiApICsgIiB1aS1sb2FkZXItIiArICggdGV4dFZpc2libGUgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArICggdGV4dG9ubHkgPyAiIHVpLWxvYWRlci10ZXh0b25seSIgOiAiIiApICkKCQkJCQkuZmluZCggImgxIiApCgkJCQkJCS50ZXh0KCBtc2dUZXh0IHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICkKCQkJCQkJLmVuZCgpCgkJCQkJLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQkJY2hlY2tMb2FkZXJQb3NpdGlvbigpOwoJCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsIiwgY2hlY2tMb2FkZXJQb3NpdGlvbiApOwoJCQl9CgkJfSwKCgkJaGlkZVBhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICl7CgkJCQkkbG9hZGVyLnJlbW92ZUNsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCX0KCgkJCSQoIHdpbmRvdyApLnVuYmluZCggInNjcm9sbCIsIGZha2VGaXhMb2FkZXIgKTsKCQkJJCggd2luZG93ICkudW5iaW5kKCAic2Nyb2xsIiwgY2hlY2tMb2FkZXJQb3NpdGlvbiApOwoJCX0sCgoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyICRwYWdlcyA9ICQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApOwoKCQkJLy8gaWYgbm8gcGFnZXMgYXJlIGZvdW5kLCBjcmVhdGUgb25lIHdpdGggYm9keSdzIGlubmVyIGh0bWwKCQkJaWYgKCAhJHBhZ2VzLmxlbmd0aCApIHsKCQkJCSRwYWdlcyA9ICQoICJib2R5IiApLndyYXBJbm5lciggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+PC9kaXY+IiApLmNoaWxkcmVuKCAwICk7CgkJCX0KCgkJCS8vIGFkZCBkaWFsb2dzLCBzZXQgZGF0YS11cmwgYXR0cnMKCQkJJHBhZ2VzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJCS8vIHVubGVzcyB0aGUgZGF0YSB1cmwgaXMgYWxyZWFkeSBzZXQgc2V0IGl0IHRvIHRoZSBwYXRobmFtZQoJCQkJaWYgKCAhJHRoaXMuanFtRGF0YSgidXJsIikgKSB7CgkJCQkJJHRoaXMuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsICR0aGlzLmF0dHIoICJpZCIgKSB8fCBsb2NhdGlvbi5wYXRobmFtZSArIGxvY2F0aW9uLnNlYXJjaCApOwoJCQkJfQoJCQl9KTsKCgkJCS8vIGRlZmluZSBmaXJzdCBwYWdlIGluIGRvbSBjYXNlIG9uZSBiYWNrcyBvdXQgdG8gdGhlIGRpcmVjdG9yeSByb290IChub3QgYWx3YXlzIHRoZSBmaXJzdCBwYWdlIHZpc2l0ZWQsIGJ1dCBkZWZpbmVkIGFzIGZhbGxiYWNrKQoJCQkkLm1vYmlsZS5maXJzdFBhZ2UgPSAkcGFnZXMuZmlyc3QoKTsKCgkJCS8vIGRlZmluZSBwYWdlIGNvbnRhaW5lcgoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyID0gJHBhZ2VzLmZpcnN0KCkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCBvciB0aGVyZSdzIG5vIGhhc2ggZGVlcGxpbmssIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCWlmICggISQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkIHx8ICEkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggbG9jYXRpb24uaGFzaCApICkgewoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7IHRyYW5zaXRpb246ICJub25lIiwgcmV2ZXJzZTogdHJ1ZSwgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCQkvLyBvdGhlcndpc2UsIHRyaWdnZXIgYSBoYXNoY2hhbmdlIHRvIGxvYWQgYSBkZWVwbGluawoJCQllbHNlIHsKCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbIHRydWUgXSApOwoJCQl9CgkJfQoJfSk7CgoJLy8gaW5pdGlhbGl6ZSBldmVudHMgbm93LCBhZnRlciBtb2JpbGVpbml0IGhhcyBvY2N1cnJlZAoJJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMoKTsKCgkvLyBjaGVjayB3aGljaCBzY3JvbGxUb3AgdmFsdWUgc2hvdWxkIGJlIHVzZWQgYnkgc2Nyb2xsaW5nIHRvIDEgaW1tZWRpYXRlbHkgYXQgZG9tcmVhZHkKCS8vIHRoZW4gY2hlY2sgd2hhdCB0aGUgc2Nyb2xsIHRvcCBpcy4gQW5kcm9pZCB3aWxsIHJlcG9ydCAwLi4uIG90aGVycyAxCgkvLyBub3RlIHRoYXQgdGhpcyBpbml0aWFsIHNjcm9sbCB3b24ndCBoaWRlIHRoZSBhZGRyZXNzIGJhci4gSXQncyBqdXN0IGZvciB0aGUgY2hlY2suCgkkKGZ1bmN0aW9uKCkgewoJCXdpbmRvdy5zY3JvbGxUbyggMCwgMSApOwoKCQkvLyBpZiBkZWZhdWx0SG9tZVNjcm9sbCBoYXNuJ3QgYmVlbiBzZXQgeWV0LCBzZWUgaWYgc2Nyb2xsVG9wIGlzIDEKCQkvLyBpdCBzaG91bGQgYmUgMSBpbiBtb3N0IGJyb3dzZXJzLCBidXQgYW5kcm9pZCB0cmVhdHMgMSBhcyAwIChmb3IgaGlkaW5nIGFkZHIgYmFyKQoJCS8vIHNvIGlmIGl0J3MgMSwgdXNlIDAgZnJvbSBub3cgb24KCQkkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA9ICggISQuc3VwcG9ydC5zY3JvbGxUb3AgfHwgJCh3aW5kb3cpLnNjcm9sbFRvcCgpID09PSAxICkgPyAwIDogMTsKCgoJCS8vIFRPRE86IEltcGxlbWVudCBhIHByb3BlciByZWdpc3RyYXRpb24gbWVjaGFuaXNtIHdpdGggZGVwZW5kZW5jeSBoYW5kbGluZyBpbiBvcmRlciB0byBub3QgaGF2ZSBleGNlcHRpb25zIGxpa2UgdGhlIG9uZSBiZWxvdwoJCS8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cyBmb3IgdGhvc2Ugd2lkZ2V0cyB0aGF0IGhhdmUgYSBzb2Z0IGRlcGVuZGVuY3kgb24gb3RoZXJzCgkJaWYgKCAkLmZuLmNvbnRyb2xncm91cCApIHsKCQkJJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJCQkJJCggIjpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpIiwgZS50YXJnZXQgKQoJCQkJCS5qcW1FbmhhbmNlYWJsZSgpCgkJCQkJLmNvbnRyb2xncm91cCh7IGV4Y2x1ZGVJbnZpc2libGU6IGZhbHNlIH0pOwoJCQl9KTsKCQl9CgoJCS8vZG9tLXJlYWR5IGluaXRzCgkJaWYoICQubW9iaWxlLmF1dG9Jbml0aWFsaXplUGFnZSApewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkCgkJJHdpbmRvdy5sb2FkKCAkLm1vYmlsZS5zaWxlbnRTY3JvbGwgKTsKCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "body": "LyoKKiBqUXVlcnkgTW9iaWxlIEZyYW1ld29yayAxLjEuMCBkYjM0MmIxZjMxNWMyODI2OTI3OTFhYTg3MDQ1NTkwMWZkYjQ2YTU1CiogaHR0cDovL2pxdWVyeW1vYmlsZS5jb20KKgoqIENvcHlyaWdodCAyMDExIChjKSBqUXVlcnkgUHJvamVjdAoqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBvciBHUEwgVmVyc2lvbiAyIGxpY2Vuc2VzLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwooZnVuY3Rpb24gKCByb290LCBkb2MsIGZhY3RvcnkgKSB7CglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCQkvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuCgkJZGVmaW5lKCBbICJqcXVlcnkiIF0sIGZ1bmN0aW9uICggJCApIHsKCQkJZmFjdG9yeSggJCwgcm9vdCwgZG9jICk7CgkJCXJldHVybiAkLm1vYmlsZTsKCQl9KTsKCX0gZWxzZSB7CgkJLy8gQnJvd3NlciBnbG9iYWxzCgkJZmFjdG9yeSggcm9vdC5qUXVlcnksIHJvb3QsIGRvYyApOwoJfQp9KCB0aGlzLCBkb2N1bWVudCwgZnVuY3Rpb24gKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7CgoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCW1vdXNlSG9va1Byb3BzID0gJC5ldmVudC5tb3VzZUhvb2tzID8gJC5ldmVudC5tb3VzZUhvb2tzLnByb3BzIDogW10sCgltb3VzZUV2ZW50UHJvcHMgPSAkLmV2ZW50LnByb3BzLmNvbmNhdCggbW91c2VIb29rUHJvcHMgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMDsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgajsKCglldmVudCA9ICQuRXZlbnQoZXZlbnQpOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCglvZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7Cglwcm9wcyA9ICQuZXZlbnQucHJvcHM7CgoJLy8gYWRkcmVzc2VzIHNlcGFyYXRpb24gb2YgJC5ldmVudC5wcm9wcyBpbiB0byAkLmV2ZW50Lm1vdXNlSG9vay5wcm9wcyBhbmQgSXNzdWUgMzI4MAoJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zMjgwCglpZiAoIHQuc2VhcmNoKCAvXihtb3VzZXxjbGljaykvICkgPiAtMSApIHsKCQlwcm9wcyA9IG1vdXNlRXZlbnRQcm9wczsKCX0KCgkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkvLyB0aGlzIHdvdWxkIGhhcHBlbiBpZiB3ZSBjb3VsZCBjYWxsICQuZXZlbnQuZml4IGluc3RlYWQgb2YgJC5FdmVudAoJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCWlmICggb2UgKSB7CgkJZm9yICggaSA9IHByb3BzLmxlbmd0aCwgcHJvcDsgaTsgKSB7CgkJCXByb3AgPSBwcm9wc1sgLS1pIF07CgkJCWV2ZW50WyBwcm9wIF0gPSBvZVsgcHJvcCBdOwoJCX0KCX0KCgkvLyBtYWtlIHN1cmUgdGhhdCBpZiB0aGUgbW91c2UgYW5kIGNsaWNrIHZpcnR1YWwgZXZlbnRzIGFyZSBnZW5lcmF0ZWQKCS8vIHdpdGhvdXQgYSAud2hpY2ggb25lIGlzIGRlZmluZWQKCWlmICggdC5zZWFyY2goL21vdXNlKGRvd258dXApfGNsaWNrLykgPiAtMSAmJiAhZXZlbnQud2hpY2ggKXsKCQlldmVudC53aGljaCA9IDE7Cgl9CgoJaWYgKCB0LnNlYXJjaCgvXnRvdWNoLykgIT09IC0xICkgewoJCW5lID0gZ2V0TmF0aXZlRXZlbnQoIG9lICk7CgkJdCA9IG5lLnRvdWNoZXM7CgkJY3QgPSBuZS5jaGFuZ2VkVG91Y2hlczsKCQl0b3VjaCA9ICggdCAmJiB0Lmxlbmd0aCApID8gdFswXSA6ICggKGN0ICYmIGN0Lmxlbmd0aCkgPyBjdFsgMCBdIDogdW5kZWZpbmVkICk7CgoJCWlmICggdG91Y2ggKSB7CgkJCWZvciAoIGogPSAwLCBsZW4gPSB0b3VjaEV2ZW50UHJvcHMubGVuZ3RoOyBqIDwgbGVuOyBqKyspewoJCQkJcHJvcCA9IHRvdWNoRXZlbnRQcm9wc1sgaiBdOwoJCQkJZXZlbnRbIHByb3AgXSA9IHRvdWNoWyBwcm9wIF07CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBlbGVtZW50ICkgewoKCXZhciBmbGFncyA9IHt9LAoJCWIsIGs7CgoJd2hpbGUgKCBlbGVtZW50ICkgewoKCQliID0gJC5kYXRhKCBlbGVtZW50LCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCWZvciAoICBrIGluIGIgKSB7CgkJCWlmICggYlsgayBdICkgewoJCQkJZmxhZ3NbIGsgXSA9IGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nID0gdHJ1ZTsKCQkJfQoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIGZsYWdzOwp9CgpmdW5jdGlvbiBnZXRDbG9zZXN0RWxlbWVudFdpdGhWaXJ0dWFsQmluZGluZyggZWxlbWVudCwgZXZlbnRUeXBlICkgewoJdmFyIGI7Cgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJaWYgKCBiICYmICggIWV2ZW50VHlwZSB8fCBiWyBldmVudFR5cGUgXSApICkgewoJCQlyZXR1cm4gZWxlbWVudDsKCQl9CgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCX0KCXJldHVybiBudWxsOwp9CgpmdW5jdGlvbiBlbmFibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIGRpc2FibGVUb3VjaEJpbmRpbmdzKCkgewoJYmxvY2tUb3VjaFRyaWdnZXJzID0gdHJ1ZTsKfQoKZnVuY3Rpb24gZW5hYmxlTW91c2VCaW5kaW5ncygpIHsKCWxhc3RUb3VjaElEID0gMDsKCWNsaWNrQmxvY2tMaXN0Lmxlbmd0aCA9IDA7CglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZTsKCgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBlbmFibGVkLCBvdXIKCS8vIHRvdWNoIGJpbmRpbmdzIGFyZSBkaXNhYmxlZC4KCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIGRpc2FibGVNb3VzZUJpbmRpbmdzKCkgewoJLy8gV2hlbiBtb3VzZSBiaW5kaW5ncyBhcmUgZGlzYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGVuYWJsZWQuCgllbmFibGVUb3VjaEJpbmRpbmdzKCk7Cn0KCmZ1bmN0aW9uIHN0YXJ0UmVzZXRUaW1lcigpIHsKCWNsZWFyUmVzZXRUaW1lcigpOwoJcmVzZXRUaW1lcklEID0gc2V0VGltZW91dChmdW5jdGlvbigpewoJCXJlc2V0VGltZXJJRCA9IDA7CgkJZW5hYmxlTW91c2VCaW5kaW5ncygpOwoJfSwgJC52bW91c2UucmVzZXRUaW1lckR1cmF0aW9uICk7Cn0KCmZ1bmN0aW9uIGNsZWFyUmVzZXRUaW1lcigpIHsKCWlmICggcmVzZXRUaW1lcklEICl7CgkJY2xlYXJUaW1lb3V0KCByZXNldFRpbWVySUQgKTsKCQlyZXNldFRpbWVySUQgPSAwOwoJfQp9CgpmdW5jdGlvbiB0cmlnZ2VyVmlydHVhbEV2ZW50KCBldmVudFR5cGUsIGV2ZW50LCBmbGFncyApIHsKCXZhciB2ZTsKCglpZiAoICggZmxhZ3MgJiYgZmxhZ3NbIGV2ZW50VHlwZSBdICkgfHwKCQkJCSggIWZsYWdzICYmIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBldmVudC50YXJnZXQsIGV2ZW50VHlwZSApICkgKSB7CgoJCXZlID0gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICk7CgoJCSQoIGV2ZW50LnRhcmdldCkudHJpZ2dlciggdmUgKTsKCX0KCglyZXR1cm4gdmU7Cn0KCmZ1bmN0aW9uIG1vdXNlRXZlbnRDYWxsYmFjayggZXZlbnQgKSB7Cgl2YXIgdG91Y2hJRCA9ICQuZGF0YShldmVudC50YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lKTsKCglpZiAoICFibG9ja01vdXNlVHJpZ2dlcnMgJiYgKCAhbGFzdFRvdWNoSUQgfHwgbGFzdFRvdWNoSUQgIT09IHRvdWNoSUQgKSApewoJCXZhciB2ZSA9IHRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2IiArIGV2ZW50LnR5cGUsIGV2ZW50ICk7CgkJaWYgKCB2ZSApIHsKCQkJaWYgKCB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQkJaWYgKCB2ZS5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCX0KCQkJaWYgKCB2ZS5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCX0KCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoIGV2ZW50ICkgewoKCXZhciB0b3VjaGVzID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlcywKCQl0YXJnZXQsIGZsYWdzOwoKCWlmICggdG91Y2hlcyAmJiB0b3VjaGVzLmxlbmd0aCA9PT0gMSApIHsKCgkJdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggdGFyZ2V0ICk7CgoJCWlmICggZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgKSB7CgoJCQlsYXN0VG91Y2hJRCA9IG5leHRUb3VjaElEKys7CgkJCSQuZGF0YSggdGFyZ2V0LCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSwgbGFzdFRvdWNoSUQgKTsKCgkJCWNsZWFyUmVzZXRUaW1lcigpOwoKCQkJZGlzYWJsZU1vdXNlQmluZGluZ3MoKTsKCQkJZGlkU2Nyb2xsID0gZmFsc2U7CgoJCQl2YXIgdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXTsKCQkJc3RhcnRYID0gdC5wYWdlWDsKCQkJc3RhcnRZID0gdC5wYWdlWTsKCgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdmVyIiwgZXZlbnQsIGZsYWdzICk7CgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vkb3duIiwgZXZlbnQsIGZsYWdzICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVTY3JvbGwoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApICk7Cgl9CgoJZGlkU2Nyb2xsID0gdHJ1ZTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdLAoJCWRpZENhbmNlbCA9IGRpZFNjcm9sbCwKCQltb3ZlVGhyZXNob2xkID0gJC52bW91c2UubW92ZURpc3RhbmNlVGhyZXNob2xkOwoJCWRpZFNjcm9sbCA9IGRpZFNjcm9sbCB8fAoJCQkoIE1hdGguYWJzKHQucGFnZVggLSBzdGFydFgpID4gbW92ZVRocmVzaG9sZCB8fAoJCQkJTWF0aC5hYnModC5wYWdlWSAtIHN0YXJ0WSkgPiBtb3ZlVGhyZXNob2xkICksCgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKTsKCglpZiAoIGRpZFNjcm9sbCAmJiAhZGlkQ2FuY2VsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZmxhZ3MgKTsKCX0KCgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlbW92ZSIsIGV2ZW50LCBmbGFncyApOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoRW5kKCBldmVudCApIHsKCWlmICggYmxvY2tUb3VjaFRyaWdnZXJzICkgewoJCXJldHVybjsKCX0KCglkaXNhYmxlVG91Y2hCaW5kaW5ncygpOwoKCXZhciBmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApLAoJCXQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInZjbGljayIsIGV2ZW50LCBmbGFncyApOwoJCWlmICggdmUgJiYgdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCS8vIFRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlIGV2ZW50cyB0aGF0IGZvbGxvdyB0aGUgdG91Y2hlbmQKCQkJLy8gZXZlbnQgZG9uJ3QgbmVjZXNzYXJpbHkgbWF0Y2ggdGhlIHRhcmdldCB1c2VkIGR1cmluZyB0aGUKCQkJLy8gdG91Y2guIFRoaXMgbWVhbnMgd2UgbmVlZCB0byByZWx5IG9uIGNvb3JkaW5hdGVzIGZvciBibG9ja2luZwoJCQkvLyBhbnkgY2xpY2sgdGhhdCBpcyBnZW5lcmF0ZWQuCgkJCXQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS5jaGFuZ2VkVG91Y2hlc1sgMCBdOwoJCQljbGlja0Jsb2NrTGlzdC5wdXNoKHsKCQkJCXRvdWNoSUQ6IGxhc3RUb3VjaElELAoJCQkJeDogdC5jbGllbnRYLAoJCQkJeTogdC5jbGllbnRZCgkJCX0pOwoKCQkJLy8gUHJldmVudCBhbnkgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IGZyb20gdHJpZ2dlcmluZwoJCQkvLyB2aXJ0dWFsIGV2ZW50IG5vdGlmaWNhdGlvbnMuCgkJCWJsb2NrTW91c2VUcmlnZ2VycyA9IHRydWU7CgkJfQoJfQoJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW91dCIsIGV2ZW50LCBmbGFncyk7CglkaWRTY3JvbGwgPSBmYWxzZTsKCglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFzVmlydHVhbEJpbmRpbmdzKCBlbGUgKSB7Cgl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIGVsZSwgZGF0YVByb3BlcnR5TmFtZSApLAoJCWs7CgoJaWYgKCBiaW5kaW5ncyApIHsKCQlmb3IgKCBrIGluIGJpbmRpbmdzICkgewoJCQlpZiAoIGJpbmRpbmdzWyBrIF0gKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCX0KCXJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gZHVtbXlNb3VzZUhhbmRsZXIoKXt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoaXMgZWxlbWVudCwKCQkJLy8gYWRkIGEgYmluZGluZ3Mgb2JqZWN0IHRvIGl0cyBkYXRhLgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUsIHt9KTsKCQkJfQoKCQkJLy8gSWYgc2V0dXAgaXMgY2FsbGVkLCB3ZSBrbm93IGl0IGlzIHRoZSBmaXJzdCBiaW5kaW5nIGZvciB0aGlzCgkJCS8vIGV2ZW50VHlwZSwgc28gaW5pdGlhbGl6ZSB0aGUgY291bnQgZm9yIHRoZSBldmVudFR5cGUgdG8gemVyby4KCQkJdmFyIGJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IHRydWU7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGV2ZW50IGZvciB0aGlzIHR5cGUsCgkJCS8vIHJlZ2lzdGVyIGEgZ2xvYmFsIGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gfHwgMCApICsgMTsKCgkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdID09PSAxICkgewoJCQkJJGRvY3VtZW50LmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJLy8gU29tZSBicm93c2VycywgbGlrZSBPcGVyYSBNaW5pLCB3b24ndCBkaXNwYXRjaCBtb3VzZS9jbGljayBldmVudHMKCQkJLy8gZm9yIGVsZW1lbnRzIHVubGVzcyB0aGV5IGFjdHVhbGx5IGhhdmUgaGFuZGxlcnMgcmVnaXN0ZXJlZCBvbiB0aGVtLgoJCQkvLyBUbyBnZXQgYXJvdW5kIHRoaXMsIHdlIHJlZ2lzdGVyIGR1bW15IGhhbmRsZXJzIG9uIHRoZSBlbGVtZW50cy4KCgkJCSQoIHRoaXMgKS5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIEZvciBub3csIGlmIGV2ZW50IGNhcHR1cmUgaXMgbm90IHN1cHBvcnRlZCwgd2UgcmVseSBvbiBtb3VzZSBoYW5kbGVycy4KCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoZSBkb2N1bWVudCwKCQkJCS8vIHJlZ2lzdGVyIG91ciB0b3VjaHN0YXJ0IGhhbmRsZXIgb24gdGhlIGRvY3VtZW50LgoKCQkJCWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdIHx8IDApICsgMTsKCgkJCQlpZiAoYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxKSB7CgkJCQkJJGRvY3VtZW50LmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgoJCQkJCQkvLyBPbiB0b3VjaCBwbGF0Zm9ybXMsIHRvdWNoaW5nIHRoZSBzY3JlZW4gYW5kIHRoZW4gZHJhZ2dpbmcgeW91ciBmaW5nZXIKCQkJCQkJLy8gY2F1c2VzIHRoZSB3aW5kb3cgY29udGVudCB0byBzY3JvbGwgYWZ0ZXIgc29tZSBkaXN0YW5jZSB0aHJlc2hvbGQgaXMKCQkJCQkJLy8gZXhjZWVkZWQuIE9uIHRoZXNlIHBsYXRmb3JtcywgYSBzY3JvbGwgcHJldmVudHMgYSBjbGljayBldmVudCBmcm9tIGJlaW5nCgkJCQkJCS8vIGRpc3BhdGNoZWQsIGFuZCBvbiBzb21lIHBsYXRmb3JtcywgZXZlbiB0aGUgdG91Y2hlbmQgaXMgc3VwcHJlc3NlZC4gVG8KCQkJCQkJLy8gbWltaWMgdGhlIHN1cHByZXNzaW9uIG9mIHRoZSBjbGljayBldmVudCwgd2UgbmVlZCB0byB3YXRjaCBmb3IgYSBzY3JvbGwKCQkJCQkJLy8gZXZlbnQuIFVuZm9ydHVuYXRlbHksIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TIGRvbid0IGRpc3BhdGNoIHNjcm9sbAoJCQkJCQkvLyBldmVudHMgdW50aWwgKkFGVEVSKiB0aGUgdXNlciBsaWZ0cyB0aGVpciBmaW5nZXIgKHRvdWNoZW5kKS4gVGhpcyBtZWFucwoJCQkJCQkvLyB3ZSBuZWVkIHRvIHdhdGNoIGJvdGggc2Nyb2xsIGFuZCB0b3VjaG1vdmUgZXZlbnRzIHRvIGZpZ3VyZSBvdXQgd2hldGhlcgoJCQkJCQkvLyBvciBub3QgYSBzY3JvbGwgaGFwcGVuZW5zIGJlZm9yZSB0aGUgdG91Y2hlbmQgZXZlbnQgaXMgZmlyZWQuCgoJCQkJCQkuYmluZCggInRvdWNobW92ZSIsIGhhbmRsZVRvdWNoTW92ZSApCgkJCQkJCS5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZSApIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIGJpbmRpbmcgZm9yIHRoaXMgZXZlbnRUeXBlLAoJCQkvLyByZW1vdmUgaXRzIGdsb2JhbCBoYW5kbGVyIGZyb20gdGhlIGRvY3VtZW50LgoKCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF07CgoJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gKSB7CgkJCQkkZG9jdW1lbnQudW5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgaW4gZXhpc3RlbmNlLAoJCQkJLy8gcmVtb3ZlIG91ciBkb2N1bWVudCB0b3VjaHN0YXJ0IGxpc3RlbmVyLgoKCQkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdOwoKCQkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSApIHsKCQkJCQkkZG9jdW1lbnQudW5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkudW5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLnVuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoJCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCWJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCQkvLyB0ZWFyZG93biBtYXkgYmUgY2FsbGVkIHdoZW4gYW4gZWxlbWVudCB3YXMKCQkJLy8gcmVtb3ZlZCBmcm9tIHRoZSBET00uIElmIHRoaXMgaXMgdGhlIGNhc2UsCgkJCS8vIGpRdWVyeSBjb3JlIG1heSBoYXZlIGFscmVhZHkgc3RyaXBwZWQgdGhlIGVsZW1lbnQKCQkJLy8gb2YgYW55IGRhdGEgYmluZGluZ3Mgc28gd2UgbmVlZCB0byBjaGVjayBpdCBiZWZvcmUKCQkJLy8gdXNpbmcgaXQuCgkJCWlmICggYmluZGluZ3MgKSB7CgkJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSBmYWxzZTsKCQkJfQoKCQkJLy8gVW5yZWdpc3RlciB0aGUgZHVtbXkgZXZlbnQgaGFuZGxlci4KCgkJCSR0aGlzLnVuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBvbiB0aGUKCQkJLy8gZWxlbWVudCwgcmVtb3ZlIHRoZSBiaW5kaW5nIGRhdGEgZnJvbSB0aGUgZWxlbWVudC4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJHRoaXMucmVtb3ZlRGF0YSggZGF0YVByb3BlcnR5TmFtZSApOwoJCQl9CgkJfQoJfTsKfQoKLy8gRXhwb3NlIG91ciBjdXN0b20gZXZlbnRzIHRvIHRoZSBqUXVlcnkgYmluZC91bmJpbmQgbWVjaGFuaXNtLgoKZm9yICggdmFyIGkgPSAwOyBpIDwgdmlydHVhbEV2ZW50TmFtZXMubGVuZ3RoOyBpKysgKXsKCSQuZXZlbnQuc3BlY2lhbFsgdmlydHVhbEV2ZW50TmFtZXNbIGkgXSBdID0gZ2V0U3BlY2lhbEV2ZW50T2JqZWN0KCB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdICk7Cn0KCi8vIEFkZCBhIGNhcHR1cmUgY2xpY2sgaGFuZGxlciB0byBibG9jayBjbGlja3MuCi8vIE5vdGUgdGhhdCB3ZSByZXF1aXJlIGV2ZW50IGNhcHR1cmUgc3VwcG9ydCBmb3IgdGhpcyBzbyBpZiB0aGUgZGV2aWNlCi8vIGRvZXNuJ3Qgc3VwcG9ydCBpdCwgd2UgcHVudCBmb3Igbm93IGFuZCByZWx5IHNvbGVseSBvbiBtb3VzZSBldmVudHMuCmlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggImNsaWNrIiwgZnVuY3Rpb24oIGUgKXsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGVoc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKCi8vIFNjcmlwdDogalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQKLy8gCi8vICpWZXJzaW9uOiAxLjMsIExhc3QgdXBkYXRlZDogNy8yMS8yMDEwKgovLyAKLy8gUHJvamVjdCBIb21lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS1wbHVnaW4vCi8vIEdpdEh1YiAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS8KLy8gU291cmNlICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UuanMKLy8gKE1pbmlmaWVkKSAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlL3Jhdy9tYXN0ZXIvanF1ZXJ5LmJhLWhhc2hjaGFuZ2UubWluLmpzICgwLjhrYiBnemlwcGVkKQovLyAKLy8gQWJvdXQ6IExpY2Vuc2UKLy8gCi8vIENvcHlyaWdodCAoYykgMjAxMCAiQ293Ym95IiBCZW4gQWxtYW4sCi8vIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzLgovLyBodHRwOi8vYmVuYWxtYW4uY29tL2Fib3V0L2xpY2Vuc2UvCi8vIAovLyBBYm91dDogRXhhbXBsZXMKLy8gCi8vIFRoZXNlIHdvcmtpbmcgZXhhbXBsZXMsIGNvbXBsZXRlIHdpdGggZnVsbHkgY29tbWVudGVkIGNvZGUsIGlsbHVzdHJhdGUgYSBmZXcKLy8gd2F5cyBpbiB3aGljaCB0aGlzIHBsdWdpbiBjYW4gYmUgdXNlZC4KLy8gCi8vIGhhc2hjaGFuZ2UgZXZlbnQgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvaGFzaGNoYW5nZS8KLy8gZG9jdW1lbnQuZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2RvY3VtZW50X2RvbWFpbi8KLy8gCi8vIEFib3V0OiBTdXBwb3J0IGFuZCBUZXN0aW5nCi8vIAovLyBJbmZvcm1hdGlvbiBhYm91dCB3aGF0IHZlcnNpb24gb3IgdmVyc2lvbnMgb2YgalF1ZXJ5IHRoaXMgcGx1Z2luIGhhcyBiZWVuCi8vIHRlc3RlZCB3aXRoLCB3aGF0IGJyb3dzZXJzIGl0IGhhcyBiZWVuIHRlc3RlZCBpbiwgYW5kIHdoZXJlIHRoZSB1bml0IHRlc3RzCi8vIHJlc2lkZSAoc28geW91IGNhbiB0ZXN0IGl0IHlvdXJzZWxmKS4KLy8gCi8vIGpRdWVyeSBWZXJzaW9ucyAtIDEuMi42LCAxLjMuMiwgMS40LjEsIDEuNC4yCi8vIEJyb3dzZXJzIFRlc3RlZCAtIEludGVybmV0IEV4cGxvcmVyIDYtOCwgRmlyZWZveCAyLTQsIENocm9tZSA1LTYsIFNhZmFyaSAzLjItNSwKLy8gICAgICAgICAgICAgICAgICAgT3BlcmEgOS42LTEwLjYwLCBpUGhvbmUgMy4xLCBBbmRyb2lkIDEuNi0yLjIsIEJsYWNrQmVycnkgNC42LTUuCi8vIFVuaXQgVGVzdHMgICAgICAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS91bml0LwovLyAKLy8gQWJvdXQ6IEtub3duIGlzc3VlcwovLyAKLy8gV2hpbGUgdGhpcyBqUXVlcnkgaGFzaGNoYW5nZSBldmVudCBpbXBsZW1lbnRhdGlvbiBpcyBxdWl0ZSBzdGFibGUgYW5kCi8vIHJvYnVzdCwgdGhlcmUgYXJlIGEgZmV3IHVuZm9ydHVuYXRlIGJyb3dzZXIgYnVncyBzdXJyb3VuZGluZyBleHBlY3RlZAovLyBoYXNoY2hhbmdlIGV2ZW50LWJhc2VkIGJlaGF2aW9ycywgaW5kZXBlbmRlbnQgb2YgYW55IEphdmFTY3JpcHQKLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBhYnN0cmFjdGlvbi4gU2VlIHRoZSBmb2xsb3dpbmcgZXhhbXBsZXMgZm9yIG1vcmUKLy8gaW5mb3JtYXRpb246Ci8vIAovLyBDaHJvbWU6IEJhY2sgQnV0dG9uIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1jaHJvbWUtYmFjay1idXR0b24vCi8vIEZpcmVmb3g6IFJlbW90ZSBYTUxIdHRwUmVxdWVzdCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctZmlyZWZveC1yZW1vdGUteGhyLwovLyBXZWJLaXQ6IEJhY2sgQnV0dG9uIGluIGFuIElmcmFtZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctd2Via2l0LWhhc2gtaWZyYW1lLwovLyBTYWZhcmk6IEJhY2sgQnV0dG9uIGZyb20gYSBkaWZmZXJlbnQgZG9tYWluIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1zYWZhcmktYmFjay1mcm9tLWRpZmYtZG9tYWluLwovLyAKLy8gQWxzbyBub3RlIHRoYXQgc2hvdWxkIGEgYnJvd3NlciBuYXRpdmVseSBzdXBwb3J0IHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIAovLyBldmVudCwgYnV0IG5vdCByZXBvcnQgdGhhdCBpdCBkb2VzLCB0aGUgZmFsbGJhY2sgcG9sbGluZyBsb29wIHdpbGwgYmUgdXNlZC4KLy8gCi8vIEFib3V0OiBSZWxlYXNlIEhpc3RvcnkKLy8gCi8vIDEuMyAgIC0gKDcvMjEvMjAxMCkgUmVvcmdhbml6ZWQgSUU2LzcgSWZyYW1lIGNvZGUgdG8gbWFrZSBpdCBtb3JlCi8vICAgICAgICAgInJlbW92YWJsZSIgZm9yIG1vYmlsZS1vbmx5IGRldmVsb3BtZW50LiBBZGRlZCBJRTYvNyBkb2N1bWVudC50aXRsZQovLyAgICAgICAgIHN1cHBvcnQuIEF0dGVtcHRlZCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUgYnkgdXNpbmcKLy8gICAgICAgICB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4gQWRkZWQgCi8vICAgICAgICAgc3VwcG9ydCBmb3IgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQod2luZG93KS5oYXNoY2hhbmdlKCBmbiApIGFuZAovLyAgICAgICAgICQod2luZG93KS5oYXNoY2hhbmdlKCkgbGlrZSBqUXVlcnkgcHJvdmlkZXMgZm9yIGJ1aWx0LWluIGV2ZW50cy4KLy8gICAgICAgICBSZW5hbWVkIGpRdWVyeS5oYXNoY2hhbmdlRGVsYXkgdG8gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5PiBhbmQKLy8gICAgICAgICBsb3dlcmVkIGl0cyBkZWZhdWx0IHZhbHVlIHRvIDUwLiBBZGRlZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluPgovLyAgICAgICAgIGFuZCA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0aWVzIHBsdXMgZG9jdW1lbnQtZG9tYWluLmh0bWwKLy8gICAgICAgICBmaWxlIHRvIGFkZHJlc3MgYWNjZXNzIGRlbmllZCBpc3N1ZXMgd2hlbiBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbgovLyAgICAgICAgIElFNi83LgovLyAxLjIgICAtICgyLzExLzIwMTApIEZpeGVkIGEgYnVnIHdoZXJlIGNvbWluZyBiYWNrIHRvIGEgcGFnZSB1c2luZyB0aGlzIHBsdWdpbgovLyAgICAgICAgIGZyb20gYSBwYWdlIG9uIGFub3RoZXIgZG9tYWluIHdvdWxkIGNhdXNlIGFuIGVycm9yIGluIFNhZmFyaSA0LiBBbHNvLAovLyAgICAgICAgIElFNi83IElmcmFtZSBpcyBub3cgaW5zZXJ0ZWQgYWZ0ZXIgdGhlIGJvZHkgKHRoaXMgYWN0dWFsbHkgd29ya3MpLAovLyAgICAgICAgIHdoaWNoIHByZXZlbnRzIHRoZSBwYWdlIGZyb20gc2Nyb2xsaW5nIHdoZW4gdGhlIGV2ZW50IGlzIGZpcnN0IGJvdW5kLgovLyAgICAgICAgIEV2ZW50IGNhbiBhbHNvIG5vdyBiZSBib3VuZCBiZWZvcmUgRE9NIHJlYWR5LCBidXQgaXQgd29uJ3QgYmUgdXNhYmxlCi8vICAgICAgICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcuCi8vIDEuMSAgIC0gKDEvMjEvMjAxMCkgSW5jb3Jwb3JhdGVkIGRvY3VtZW50LmRvY3VtZW50TW9kZSB0ZXN0IHRvIGZpeCBJRTggYnVnCi8vICAgICAgICAgd2hlcmUgYnJvd3NlciB2ZXJzaW9uIGlzIGluY29ycmVjdGx5IHJlcG9ydGVkIGFzIDguMCwgZGVzcGl0ZQovLyAgICAgICAgIGluY2x1c2lvbiBvZiB0aGUgWC1VQS1Db21wYXRpYmxlIElFPUVtdWxhdGVJRTcgbWV0YSB0YWcuCi8vIDEuMCAgIC0gKDEvOS8yMDEwKSBJbml0aWFsIFJlbGVhc2UuIEJyb2tlIG91dCB0aGUgalF1ZXJ5IEJCUSBldmVudC5zcGVjaWFsCi8vICAgICAgICAgd2luZG93Lm9uaGFzaGNoYW5nZSBmdW5jdGlvbmFsaXR5IGludG8gYSBzZXBhcmF0ZSBwbHVnaW4gZm9yIHVzZXJzCi8vICAgICAgICAgd2hvIHdhbnQganVzdCB0aGUgYmFzaWMgZXZlbnQgJiBiYWNrIGJ1dHRvbiBzdXBwb3J0LCB3aXRob3V0IGFsbCB0aGUKLy8gICAgICAgICBleHRyYSBhd2Vzb21lbmVzcyB0aGF0IEJCUSBwcm92aWRlcy4gVGhpcyBwbHVnaW4gd2lsbCBiZSBpbmNsdWRlZCBhcwovLyAgICAgICAgIHBhcnQgb2YgalF1ZXJ5IEJCUSwgYnV0IGFsc28gYmUgYXZhaWxhYmxlIHNlcGFyYXRlbHkuCgooZnVuY3Rpb24oJCx3aW5kb3csdW5kZWZpbmVkKXsKICAvLyBSZXVzZWQgc3RyaW5nLgogIHZhciBzdHJfaGFzaGNoYW5nZSA9ICdoYXNoY2hhbmdlJywKICAgIAogICAgLy8gTWV0aG9kIC8gb2JqZWN0IHJlZmVyZW5jZXMuCiAgICBkb2MgPSBkb2N1bWVudCwKICAgIGZha2Vfb25oYXNoY2hhbmdlLAogICAgc3BlY2lhbCA9ICQuZXZlbnQuc3BlY2lhbCwKICAgIAogICAgLy8gRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IHdpbmRvdy5vbmhhc2hjaGFuZ2U/IE5vdGUgdGhhdCBJRTggcnVubmluZyBpbgogICAgLy8gSUU3IGNvbXBhdGliaWxpdHkgbW9kZSByZXBvcnRzIHRydWUgZm9yICdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdywgZXZlbgogICAgLy8gdGhvdWdoIHRoZSBldmVudCBpc24ndCBzdXBwb3J0ZWQsIHNvIGFsc28gdGVzdCBkb2N1bWVudC5kb2N1bWVudE1vZGUuCiAgICBkb2NfbW9kZSA9IGRvYy5kb2N1bWVudE1vZGUsCiAgICBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgPSAnb24nICsgc3RyX2hhc2hjaGFuZ2UgaW4gd2luZG93ICYmICggZG9jX21vZGUgPT09IHVuZGVmaW5lZCB8fCBkb2NfbW9kZSA+IDcgKTsKICAKICAvLyBHZXQgbG9jYXRpb24uaGFzaCAob3Igd2hhdCB5b3UnZCBleHBlY3QgbG9jYXRpb24uaGFzaCB0byBiZSkgc2FucyBhbnkKICAvLyBsZWFkaW5nICMuIFRoYW5rcyBmb3IgbWFraW5nIHRoaXMgbmVjZXNzYXJ5LCBGaXJlZm94IQogIGZ1bmN0aW9uIGdldF9mcmFnbWVudCggdXJsICkgewogICAgdXJsID0gdXJsIHx8IGxvY2F0aW9uLmhyZWY7CiAgICByZXR1cm4gJyMnICsgdXJsLnJlcGxhY2UoIC9eW14jXSojPyguKikkLywgJyQxJyApOwogIH07CiAgCiAgLy8gTWV0aG9kOiBqUXVlcnkuZm4uaGFzaGNoYW5nZQogIC8vIAogIC8vIEJpbmQgYSBoYW5kbGVyIHRvIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IG9yIHRyaWdnZXIgYWxsIGJvdW5kCiAgLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycy4gVGhpcyBiZWhhdmlvciBpcyBjb25zaXN0ZW50IHdpdGgKICAvLyBqUXVlcnkncyBidWlsdC1pbiBldmVudCBoYW5kbGVycy4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIFsgaGFuZGxlciBdICk7CiAgLy8gCiAgLy8gQXJndW1lbnRzOgogIC8vIAogIC8vICBoYW5kbGVyIC0gKEZ1bmN0aW9uKSBPcHRpb25hbCBoYW5kbGVyIHRvIGJlIGJvdW5kIHRvIHRoZSBoYXNoY2hhbmdlCiAgLy8gICAgZXZlbnQuIFRoaXMgaXMgYSAic2hvcnRjdXQiIGZvciB0aGUgbW9yZSB2ZXJib3NlIGZvcm06CiAgLy8gICAgalF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBoYW5kbGVyICkuIElmIGhhbmRsZXIgaXMgb21pdHRlZCwKICAvLyAgICBhbGwgYm91bmQgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycyB3aWxsIGJlIHRyaWdnZXJlZC4gVGhpcwogIC8vICAgIGlzIGEgc2hvcnRjdXQgZm9yIHRoZSBtb3JlIHZlcmJvc2UKICAvLyAgICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4gVGhlc2UgZm9ybXMgYXJlIGRlc2NyaWJlZCBpbgogIC8vICAgIHRoZSA8aGFzaGNoYW5nZSBldmVudD4gc2VjdGlvbi4KICAvLyAKICAvLyBSZXR1cm5zOgogIC8vIAogIC8vICAoalF1ZXJ5KSBUaGUgaW5pdGlhbCBqUXVlcnkgY29sbGVjdGlvbiBvZiBlbGVtZW50cy4KICAKICAvLyBBbGxvdyB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJChlbGVtKS5oYXNoY2hhbmdlKCBmbiApIGZvciBiaW5kaW5nIGFuZAogIC8vICQoZWxlbSkuaGFzaGNoYW5nZSgpIGZvciB0cmlnZ2VyaW5nLCBsaWtlIGpRdWVyeSBkb2VzIGZvciBidWlsdC1pbiBldmVudHMuCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXSA9IGZ1bmN0aW9uKCBmbiApIHsKICAgIHJldHVybiBmbiA/IHRoaXMuYmluZCggc3RyX2hhc2hjaGFuZ2UsIGZuICkgOiB0aGlzLnRyaWdnZXIoIHN0cl9oYXNoY2hhbmdlICk7CiAgfTsKICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXkKICAvLyAKICAvLyBUaGUgbnVtZXJpYyBpbnRlcnZhbCAoaW4gbWlsbGlzZWNvbmRzKSBhdCB3aGljaCB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+CiAgLy8gcG9sbGluZyBsb29wIGV4ZWN1dGVzLiBEZWZhdWx0cyB0byA1MC4KICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluCiAgLy8gCiAgLy8gSWYgeW91J3JlIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluIHlvdXIgSmF2YVNjcmlwdCwgYW5kIHlvdSB3YW50IGhhc2gKICAvLyBoaXN0b3J5IHRvIHdvcmsgaW4gSUU2LzcsIG5vdCBvbmx5IG11c3QgdGhpcyBwcm9wZXJ0eSBiZSBzZXQsIGJ1dCB5b3UgbXVzdAogIC8vIGFsc28gc2V0IGRvY3VtZW50LmRvbWFpbiBCRUZPUkUgalF1ZXJ5IGlzIGxvYWRlZCBpbnRvIHRoZSBwYWdlLiBUaGlzCiAgLy8gcHJvcGVydHkgaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZwogIC8vIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gSW4gYWRkaXRpb24sIHRoZSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0eSBtdXN0IGJlIHNldCB0byB0aGUKICAvLyBwYXRoIG9mIHRoZSBpbmNsdWRlZCAiZG9jdW1lbnQtZG9tYWluLmh0bWwiIGZpbGUsIHdoaWNoIGNhbiBiZSByZW5hbWVkIG9yCiAgLy8gbW9kaWZpZWQgaWYgbmVjZXNzYXJ5IChub3RlIHRoYXQgdGhlIGRvY3VtZW50LmRvbWFpbiBzcGVjaWZpZWQgbXVzdCBiZSB0aGUKICAvLyBzYW1lIGluIGJvdGggeW91ciBtYWluIEphdmFTY3JpcHQgYXMgd2VsbCBhcyBpbiB0aGlzIGZpbGUpLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vIGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbiA9IGRvY3VtZW50LmRvbWFpbjsKICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjCiAgLy8gCiAgLy8gSWYsIGZvciBzb21lIHJlYXNvbiwgeW91IG5lZWQgdG8gc3BlY2lmeSBhbiBJZnJhbWUgc3JjIGZpbGUgKGZvciBleGFtcGxlLAogIC8vIHdoZW4gc2V0dGluZyBkb2N1bWVudC5kb21haW4gYXMgaW4gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbj4pLCB5b3UgY2FuCiAgLy8gZG8gc28gdXNpbmcgdGhpcyBwcm9wZXJ0eS4gTm90ZSB0aGF0IHdoZW4gdXNpbmcgdGhpcyBwcm9wZXJ0eSwgaGlzdG9yeQogIC8vIHdvbid0IGJlIHJlY29yZGVkIGluIElFNi83IHVudGlsIHRoZSBJZnJhbWUgc3JjIGZpbGUgbG9hZHMuIFRoaXMgcHJvcGVydHkKICAvLyBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMgPSAncGF0aC90by9maWxlLmh0bWwnOwogIAogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgPSA1MDsKICAvKgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluID0gbnVsbDsKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLnNyYyA9IG51bGw7CiAgKi8KICAKICAvLyBFdmVudDogaGFzaGNoYW5nZSBldmVudAogIC8vIAogIC8vIEZpcmVkIHdoZW4gbG9jYXRpb24uaGFzaCBjaGFuZ2VzLiBJbiBicm93c2VycyB0aGF0IHN1cHBvcnQgaXQsIHRoZSBuYXRpdmUKICAvLyBIVE1MNSB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGlzIHVzZWQsIG90aGVyd2lzZSBhIHBvbGxpbmcgbG9vcCBpcwogIC8vIGluaXRpYWxpemVkLCBydW5uaW5nIGV2ZXJ5IDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheT4gbWlsbGlzZWNvbmRzIHRvCiAgLy8gc2VlIGlmIHRoZSBoYXNoIGhhcyBjaGFuZ2VkLiBJbiBJRTYvNyAoYW5kIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLCBhIGhpZGRlbiBJZnJhbWUgaXMgY3JlYXRlZCB0byBhbGxvdyB0aGUgYmFjayBidXR0b24KICAvLyBhbmQgaGFzaC1iYXNlZCBoaXN0b3J5IHRvIHdvcmsuCiAgLy8gCiAgLy8gVXNhZ2UgYXMgZGVzY3JpYmVkIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZT46CiAgLy8gCiAgLy8gPiAvLyBCaW5kIGFuIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKTsKICAvLyAKICAvLyBBIG1vcmUgdmVyYm9zZSB1c2FnZSB0aGF0IGFsbG93cyBmb3IgZXZlbnQgbmFtZXNwYWNpbmc6CiAgLy8gCiAgLy8gPiAvLyBCaW5kIGFuIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5iaW5kKCAnaGFzaGNoYW5nZScsIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4gCiAgLy8gPiAvLyBNYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICk7CiAgLy8gCiAgLy8gQWRkaXRpb25hbCBOb3RlczoKICAvLyAKICAvLyAqIFRoZSBwb2xsaW5nIGxvb3AgYW5kIElmcmFtZSBhcmUgbm90IGNyZWF0ZWQgdW50aWwgYXQgbGVhc3Qgb25lIGhhbmRsZXIKICAvLyAgIGlzIGFjdHVhbGx5IGJvdW5kIHRvIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQuCiAgLy8gKiBJZiB5b3UgbmVlZCB0aGUgYm91bmQgaGFuZGxlcihzKSB0byBleGVjdXRlIGltbWVkaWF0ZWx5LCBpbiBjYXNlcyB3aGVyZQogIC8vICAgYSBsb2NhdGlvbi5oYXNoIGV4aXN0cyBvbiBwYWdlIGxvYWQsIHZpYSBib29rbWFyayBvciBwYWdlIHJlZnJlc2ggZm9yCiAgLy8gICBleGFtcGxlLCB1c2UgalF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSgpIG9yIHRoZSBtb3JlIHZlcmJvc2UgCiAgLy8gICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4KICAvLyAqIFRoZSBldmVudCBjYW4gYmUgYm91bmQgYmVmb3JlIERPTSByZWFkeSwgYnV0IHNpbmNlIGl0IHdvbid0IGJlIHVzYWJsZQogIC8vICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcgKGR1ZSB0byB0aGUgbmVjZXNzYXJ5IElmcmFtZSksIHJlY29tbWVuZGVkIHVzYWdlIGlzCiAgLy8gICB0byBiaW5kIGl0IGluc2lkZSBhIERPTSByZWFkeSBoYW5kbGVyLgogIAogIC8vIE92ZXJyaWRlIGV4aXN0aW5nICQuZXZlbnQuc3BlY2lhbC5oYXNoY2hhbmdlIG1ldGhvZHMgKGFsbG93aW5nIHRoaXMgcGx1Z2luCiAgLy8gdG8gYmUgZGVmaW5lZCBhZnRlciBqUXVlcnkgQkJRIGluIEJCUSdzIHNvdXJjZSBjb2RlKS4KICBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdID0gJC5leHRlbmQoIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0sIHsKICAgIAogICAgLy8gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgZmlyc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIGJvdW5kIHRvIHdpbmRvdy4KICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgLy8gSWYgd2luZG93Lm9uaGFzaGNoYW5nZSBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoZXJlJ3Mgbm90aGluZyB0byBkby4uCiAgICAgIGlmICggc3VwcG9ydHNfb25oYXNoY2hhbmdlICkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgCiAgICAgIC8vIE90aGVyd2lzZSwgd2UgbmVlZCB0byBjcmVhdGUgb3VyIG93bi4gQW5kIHdlIGRvbid0IHdhbnQgdG8gY2FsbCB0aGlzCiAgICAgIC8vIHVudGlsIHRoZSB1c2VyIGJpbmRzIHRvIHRoZSBldmVudCwganVzdCBpbiBjYXNlIHRoZXkgbmV2ZXIgZG8sIHNpbmNlIGl0CiAgICAgIC8vIHdpbGwgY3JlYXRlIGEgcG9sbGluZyBsb29wIGFuZCBwb3NzaWJseSBldmVuIGEgaGlkZGVuIElmcmFtZS4KICAgICAgJCggZmFrZV9vbmhhc2hjaGFuZ2Uuc3RhcnQgKTsKICAgIH0sCiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGxhc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIHVuYm91bmQgZnJvbSB3aW5kb3cuCiAgICB0ZWFyZG93bjogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gc3RvcCBvdXJzIChpZiBwb3NzaWJsZSkuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0b3AgKTsKICAgIH0KICAgIAogIH0pOwogIAogIC8vIGZha2Vfb25oYXNoY2hhbmdlIGRvZXMgYWxsIHRoZSB3b3JrIG9mIHRyaWdnZXJpbmcgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UKICAvLyBldmVudCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBuYXRpdmVseSBzdXBwb3J0IGl0LCBpbmNsdWRpbmcgY3JlYXRpbmcgYQogIC8vIHBvbGxpbmcgbG9vcCB0byB3YXRjaCBmb3IgaGFzaCBjaGFuZ2VzIGFuZCBpbiBJRSA2LzcgY3JlYXRpbmcgYSBoaWRkZW4KICAvLyBJZnJhbWUgdG8gZW5hYmxlIGJhY2sgYW5kIGZvcndhcmQuCiAgZmFrZV9vbmhhc2hjaGFuZ2UgPSAoZnVuY3Rpb24oKXsKICAgIHZhciBzZWxmID0ge30sCiAgICAgIHRpbWVvdXRfaWQsCiAgICAgIAogICAgICAvLyBSZW1lbWJlciB0aGUgaW5pdGlhbCBoYXNoIHNvIGl0IGRvZXNuJ3QgZ2V0IHRyaWdnZXJlZCBpbW1lZGlhdGVseS4KICAgICAgbGFzdF9oYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgIAogICAgICBmbl9yZXR2YWwgPSBmdW5jdGlvbih2YWwpeyByZXR1cm4gdmFsOyB9LAogICAgICBoaXN0b3J5X3NldCA9IGZuX3JldHZhbCwKICAgICAgaGlzdG9yeV9nZXQgPSBmbl9yZXR2YWw7CiAgICAKICAgIC8vIFN0YXJ0IHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgfHwgcG9sbCgpOwogICAgfTsKICAgIAogICAgLy8gU3RvcCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdG9wID0gZnVuY3Rpb24oKSB7CiAgICAgIHRpbWVvdXRfaWQgJiYgY2xlYXJUaW1lb3V0KCB0aW1lb3V0X2lkICk7CiAgICAgIHRpbWVvdXRfaWQgPSB1bmRlZmluZWQ7CiAgICB9OwogICAgCiAgICAvLyBUaGlzIHBvbGxpbmcgbG9vcCBjaGVja3MgZXZlcnkgJC5mbi5oYXNoY2hhbmdlLmRlbGF5IG1pbGxpc2Vjb25kcyB0byBzZWUKICAgIC8vIGlmIGxvY2F0aW9uLmhhc2ggaGFzIGNoYW5nZWQsIGFuZCB0cmlnZ2VycyB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50IG9uCiAgICAvLyB3aW5kb3cgd2hlbiBuZWNlc3NhcnkuCiAgICBmdW5jdGlvbiBwb2xsKCkgewogICAgICB2YXIgaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAgIGhpc3RvcnlfaGFzaCA9IGhpc3RvcnlfZ2V0KCBsYXN0X2hhc2ggKTsKICAgICAgCiAgICAgIGlmICggaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGhpc3Rvcnlfc2V0KCBsYXN0X2hhc2ggPSBoYXNoLCBoaXN0b3J5X2hhc2ggKTsKICAgICAgICAKICAgICAgICAkKHdpbmRvdykudHJpZ2dlciggc3RyX2hhc2hjaGFuZ2UgKTsKICAgICAgICAKICAgICAgfSBlbHNlIGlmICggaGlzdG9yeV9oYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgbG9jYXRpb24uaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSggLyMuKi8sICcnICkgKyBoaXN0b3J5X2hhc2g7CiAgICAgIH0KICAgICAgCiAgICAgIHRpbWVvdXRfaWQgPSBzZXRUaW1lb3V0KCBwb2xsLCAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ICk7CiAgICB9OwogICAgCiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYgUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAkLmJyb3dzZXIubXNpZSAmJiAhc3VwcG9ydHNfb25oYXNoY2hhbmdlICYmIChmdW5jdGlvbigpewogICAgICAvLyBOb3Qgb25seSBkbyBJRTYvNyBuZWVkIHRoZSAibWFnaWNhbCIgSWZyYW1lIHRyZWF0bWVudCwgYnV0IHNvIGRvZXMgSUU4CiAgICAgIC8vIHdoZW4gcnVubmluZyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUuCiAgICAgIAogICAgICB2YXIgaWZyYW1lLAogICAgICAgIGlmcmFtZV9zcmM7CiAgICAgIAogICAgICAvLyBXaGVuIHRoZSBldmVudCBpcyBib3VuZCBhbmQgcG9sbGluZyBzdGFydHMgaW4gSUUgNi83LCBjcmVhdGUgYSBoaWRkZW4KICAgICAgLy8gSWZyYW1lIGZvciBoaXN0b3J5IGhhbmRsaW5nLgogICAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKXsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBpZnJhbWVfc3JjIHx8IGhpc3Rvcnlfc2V0KCBnZXRfZnJhZ21lbnQoKSApOwogICAgICAgICAgICAgIHBvbGwoKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvYWQgSWZyYW1lIHNyYyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBub3RoaW5nLgogICAgICAgICAgICAuYXR0ciggJ3NyYycsIGlmcmFtZV9zcmMgfHwgJ2phdmFzY3JpcHQ6MCcgKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwZW5kIElmcmFtZSBhZnRlciB0aGUgZW5kIG9mIHRoZSBib2R5IHRvIHByZXZlbnQgdW5uZWNlc3NhcnkKICAgICAgICAgICAgLy8gaW5pdGlhbCBwYWdlIHNjcm9sbGluZyAoeWVzLCB0aGlzIHdvcmtzKS4KICAgICAgICAgICAgLmluc2VydEFmdGVyKCAnYm9keScgKVswXS5jb250ZW50V2luZG93OwogICAgICAgICAgCiAgICAgICAgICAvLyBXaGVuZXZlciBgZG9jdW1lbnQudGl0bGVgIGNoYW5nZXMsIHVwZGF0ZSB0aGUgSWZyYW1lJ3MgdGl0bGUgdG8KICAgICAgICAgIC8vIHByZXR0aWZ5IHRoZSBiYWNrL25leHQgaGlzdG9yeSBtZW51IGVudHJpZXMuIFNpbmNlIElFIHNvbWV0aW1lcwogICAgICAgICAgLy8gZXJyb3JzIHdpdGggIlVuc3BlY2lmaWVkIGVycm9yIiB0aGUgdmVyeSBmaXJzdCB0aW1lIHRoaXMgaXMgc2V0CiAgICAgICAgICAvLyAoeWVzLCB2ZXJ5IHVzZWZ1bCkgd3JhcCB0aGlzIHdpdGggYSB0cnkvY2F0Y2ggYmxvY2suCiAgICAgICAgICBkb2Mub25wcm9wZXJ0eWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKCBldmVudC5wcm9wZXJ0eU5hbWUgPT09ICd0aXRsZScgKSB7CiAgICAgICAgICAgICAgICBpZnJhbWUuZG9jdW1lbnQudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICB9OwogICAgICAgICAgCiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgICAgLy8gT3ZlcnJpZGUgdGhlICJzdG9wIiBtZXRob2Qgc2luY2UgYW4gSUU2LzcgSWZyYW1lIHdhcyBjcmVhdGVkLiBFdmVuCiAgICAgIC8vIGlmIHRoZXJlIGFyZSBubyBsb25nZXIgYW55IGJvdW5kIGV2ZW50IGhhbmRsZXJzLCB0aGUgcG9sbGluZyBsb29wCiAgICAgIC8vIGlzIHN0aWxsIG5lY2Vzc2FyeSBmb3IgYmFjay9uZXh0IHRvIHdvcmsgYXQgYWxsIQogICAgICBzZWxmLnN0b3AgPSBmbl9yZXR2YWw7CiAgICAgIAogICAgICAvLyBHZXQgaGlzdG9yeSBieSBsb29raW5nIGF0IHRoZSBoaWRkZW4gSWZyYW1lJ3MgbG9jYXRpb24uaGFzaC4KICAgICAgaGlzdG9yeV9nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZ2V0X2ZyYWdtZW50KCBpZnJhbWUubG9jYXRpb24uaHJlZiApOwogICAgICB9OwogICAgICAKICAgICAgLy8gU2V0IGEgbmV3IGhpc3RvcnkgaXRlbSBieSBvcGVuaW5nIGFuZCB0aGVuIGNsb3NpbmcgdGhlIElmcmFtZQogICAgICAvLyBkb2N1bWVudCwgKnRoZW4qIHNldHRpbmcgaXRzIGxvY2F0aW9uLmhhc2guIElmIGRvY3VtZW50LmRvbWFpbiBoYXMKICAgICAgLy8gYmVlbiBzZXQsIHVwZGF0ZSB0aGF0IGFzIHdlbGwuCiAgICAgIGhpc3Rvcnlfc2V0ID0gZnVuY3Rpb24oIGhhc2gsIGhpc3RvcnlfaGFzaCApIHsKICAgICAgICB2YXIgaWZyYW1lX2RvYyA9IGlmcmFtZS5kb2N1bWVudCwKICAgICAgICAgIGRvbWFpbiA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluOwogICAgICAgIAogICAgICAgIGlmICggaGFzaCAhPT0gaGlzdG9yeV9oYXNoICkgewogICAgICAgICAgLy8gVXBkYXRlIElmcmFtZSB3aXRoIGFueSBpbml0aWFsIGBkb2N1bWVudC50aXRsZWAgdGhhdCBtaWdodCBiZSBzZXQuCiAgICAgICAgICBpZnJhbWVfZG9jLnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgCiAgICAgICAgICAvLyBPcGVuaW5nIHRoZSBJZnJhbWUncyBkb2N1bWVudCBhZnRlciBpdCBoYXMgYmVlbiBjbG9zZWQgaXMgd2hhdAogICAgICAgICAgLy8gYWN0dWFsbHkgYWRkcyBhIGhpc3RvcnkgZW50cnkuCiAgICAgICAgICBpZnJhbWVfZG9jLm9wZW4oKTsKICAgICAgICAgIAogICAgICAgICAgLy8gU2V0IGRvY3VtZW50LmRvbWFpbiBmb3IgdGhlIElmcmFtZSBkb2N1bWVudCBhcyB3ZWxsLCBpZiBuZWNlc3NhcnkuCiAgICAgICAgICBkb21haW4gJiYgaWZyYW1lX2RvYy53cml0ZSggJzxzY3JpcHQ+ZG9jdW1lbnQuZG9tYWluPSInICsgZG9tYWluICsgJyI8L3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKLyohCiAqIGpRdWVyeSBVSSBXaWRnZXQgQFZFUlNJT04KICoKICogQ29weXJpZ2h0IDIwMTAsIEFVVEhPUlMudHh0IChodHRwOi8vanF1ZXJ5dWkuY29tL2Fib3V0KQogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1VJL1dpZGdldAogKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8galF1ZXJ5IDEuNCsKaWYgKCAkLmNsZWFuRGF0YSApIHsKCXZhciBfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CgkkLmNsZWFuRGF0YSA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCQlmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCX0KCQlfY2xlYW5EYXRhKCBlbGVtcyApOwoJfTsKfSBlbHNlIHsKCXZhciBfcmVtb3ZlID0gJC5mbi5yZW1vdmU7CgkkLmZuLnJlbW92ZSA9IGZ1bmN0aW9uKCBzZWxlY3Rvciwga2VlcERhdGEgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAha2VlcERhdGEgKSB7CgkJCQlpZiAoICFzZWxlY3RvciB8fCAkLmZpbHRlciggc2VsZWN0b3IsIFsgdGhpcyBdICkubGVuZ3RoICkgewoJCQkJCSQoICIqIiwgdGhpcyApLmFkZCggWyB0aGlzIF0gKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkkKCB0aGlzICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJCQkJfSk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIF9yZW1vdmUuY2FsbCggJCh0aGlzKSwgc2VsZWN0b3IsIGtlZXBEYXRhICk7CgkJfSk7Cgl9Owp9CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXSwKCQlmdWxsTmFtZTsKCW5hbWUgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMSBdOwoJZnVsbE5hbWUgPSBuYW1lc3BhY2UgKyAiLSIgKyBuYW1lOwoKCWlmICggIXByb3RvdHlwZSApIHsKCQlwcm90b3R5cGUgPSBiYXNlOwoJCWJhc2UgPSAkLldpZGdldDsKCX0KCgkvLyBjcmVhdGUgc2VsZWN0b3IgZm9yIHBsdWdpbgoJJC5leHByWyAiOiIgXVsgZnVsbE5hbWUgXSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhISQuZGF0YSggZWxlbSwgbmFtZSApOwoJfTsKCgkkWyBuYW1lc3BhY2UgXSA9ICRbIG5hbWVzcGFjZSBdIHx8IHt9OwoJJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCgl2YXIgYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQovLwkkLmVhY2goIGJhc2VQcm90b3R5cGUsIGZ1bmN0aW9uKCBrZXksIHZhbCApIHsKLy8JCWlmICggJC5pc1BsYWluT2JqZWN0KHZhbCkgKSB7Ci8vCQkJYmFzZVByb3RvdHlwZVsga2V5IF0gPSAkLmV4dGVuZCgge30sIHZhbCApOwovLwkJfQovLwl9KTsKCWJhc2VQcm90b3R5cGUub3B0aW9ucyA9ICQuZXh0ZW5kKCB0cnVlLCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkWyBuYW1lc3BhY2UgXVsgbmFtZSBdLnByb3RvdHlwZSA9ICQuZXh0ZW5kKCB0cnVlLCBiYXNlUHJvdG90eXBlLCB7CgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRFdmVudFByZWZpeDogJFsgbmFtZXNwYWNlIF1bIG5hbWUgXS5wcm90b3R5cGUud2lkZ2V0RXZlbnRQcmVmaXggfHwgbmFtZSwKCQl3aWRnZXRCYXNlQ2xhc3M6IGZ1bGxOYW1lCgl9LCBwcm90b3R5cGUgKTsKCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gKTsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCQlyZXR1cm5WYWx1ZSA9IHRoaXM7CgoJCS8vIGFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCW9wdGlvbnMgPSAhaXNNZXRob2RDYWxsICYmIGFyZ3MubGVuZ3RoID8KCQkJJC5leHRlbmQuYXBwbHkoIG51bGwsIFsgdHJ1ZSwgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJLy8gcHJldmVudCBjYWxscyB0byBpbnRlcm5hbCBtZXRob2RzCgkJaWYgKCBpc01ldGhvZENhbGwgJiYgb3B0aW9ucy5jaGFyQXQoIDAgKSA9PT0gIl8iICkgewoJCQlyZXR1cm4gcmV0dXJuVmFsdWU7CgkJfQoKCQlpZiAoIGlzTWV0aG9kQ2FsbCApIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBuYW1lICk7CgkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQl0aHJvdyAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIjsKCQkJCX0KCQkJCWlmICggISQuaXNGdW5jdGlvbiggaW5zdGFuY2Vbb3B0aW9uc10gKSApIHsKCQkJCQl0aHJvdyAibm8gc3VjaCBtZXRob2QgJyIgKyBvcHRpb25zICsgIicgZm9yICIgKyBuYW1lICsgIiB3aWRnZXQgaW5zdGFuY2UiOwoJCQkJfQoJCQkJdmFyIG1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCQkJCWlmICggbWV0aG9kVmFsdWUgIT09IGluc3RhbmNlICYmIG1ldGhvZFZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgbmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIG5hbWUsIG5ldyBvYmplY3QoIG9wdGlvbnMsIHRoaXMgKSApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiByZXR1cm5WYWx1ZTsKCX07Cn07CgokLldpZGdldCA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCglpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7Cgl9Cn07CgokLldpZGdldC5wcm90b3R5cGUgPSB7Cgl3aWRnZXROYW1lOiAid2lkZ2V0IiwKCXdpZGdldEV2ZW50UHJlZml4OiAiIiwKCW9wdGlvbnM6IHsKCQlkaXNhYmxlZDogZmFsc2UKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyAkLndpZGdldC5icmlkZ2Ugc3RvcmVzIHRoZSBwbHVnaW4gaW5zdGFuY2UsIGJ1dCB3ZSBkbyBpdCBhbnl3YXkKCQkvLyBzbyB0aGF0IGl0J3Mgc3RvcmVkIGV2ZW4gYmVmb3JlIHRoZSBfY3JlYXRlIGZ1bmN0aW9uIHJ1bnMKCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0TmFtZSwgdGhpcyApOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCggdHJ1ZSwge30sCgkJCXRoaXMub3B0aW9ucywKCQkJdGhpcy5fZ2V0Q3JlYXRlT3B0aW9ucygpLAoJCQlvcHRpb25zICk7CgoJCXZhciBzZWxmID0gdGhpczsKCQl0aGlzLmVsZW1lbnQuYmluZCggInJlbW92ZS4iICsgdGhpcy53aWRnZXROYW1lLCBmdW5jdGlvbigpIHsKCQkJc2VsZi5kZXN0cm95KCk7CgkJfSk7CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiICk7CgkJdGhpcy5faW5pdCgpOwoJfSwKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHt9OwoJCWlmICggJC5tZXRhZGF0YSApIHsKCQkJb3B0aW9ucyA9ICQubWV0YWRhdGEuZ2V0KCBlbGVtZW50IClbIHRoaXMud2lkZ2V0TmFtZSBdOwoJCX0KCQlyZXR1cm4gb3B0aW9uczsKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHt9LAoJX2luaXQ6IGZ1bmN0aW9uKCkge30sCgoJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoICIuIiArIHRoaXMud2lkZ2V0TmFtZSApCgkJCS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldE5hbWUgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoICIuIiArIHRoaXMud2lkZ2V0TmFtZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKQoJCQkucmVtb3ZlQ2xhc3MoCgkJCQl0aGlzLndpZGdldEJhc2VDbGFzcyArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkvLyBkb24ndCByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGhhc2gKCQkJcmV0dXJuICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zICk7CgkJfQoKCQlpZiAgKHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgewoJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gdGhpcy5vcHRpb25zWyBrZXkgXTsKCQkJfQoJCQlvcHRpb25zID0ge307CgkJCW9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJJC5lYWNoKCBvcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJc2VsZi5fc2V0T3B0aW9uKCBrZXksIHZhbHVlICk7CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMud2lkZ2V0KCkKCQkJCVsgdmFsdWUgPyAiYWRkQ2xhc3MiIDogInJlbW92ZUNsYXNzIl0oCgkJCQkJdGhpcy53aWRnZXRCYXNlQ2xhc3MgKyAiLWRpc2FibGVkIiArICIgIiArCgkJCQkJInVpLXN0YXRlLWRpc2FibGVkIiApCgkJCQkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIGNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkJLy8gYnV0IHdlIGRvbid0IGhhdmUgYSB3YXkgdG8gZm9yY2UgYW4gZXZlbnQgdG8gYmUgZml4ZWQgbXVsdGlwbGUgdGltZXMKCQlpZiAoIGV2ZW50Lm9yaWdpbmFsRXZlbnQgKSB7CgkJCWZvciAoIHZhciBpID0gJC5ldmVudC5wcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQkJcHJvcCA9ICQuZXZlbnQucHJvcHNbIC0taSBdOwoJCQkJZXZlbnRbIHByb3AgXSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnRbIHByb3AgXTsKCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oY2FsbGJhY2spICYmCgkJCWNhbGxiYWNrLmNhbGwoIHRoaXMuZWxlbWVudFswXSwgZXZlbnQsIGRhdGEgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUud2lkZ2V0IiwgewoJLy8gZGVjb3JhdGUgdGhlIHBhcmVudCBfY3JlYXRlV2lkZ2V0IHRvIHRyaWdnZXIgYHdpZGdldGluaXRgIGZvciB1c2VycwoJLy8gd2hvIHdpc2ggdG8gZG8gcG9zdCBwb3N0IGB3aWRnZXRjcmVhdGVgIGFsdGVyYXRpb25zL2FkZGl0aW9ucwoJLy8KCS8vIFRPRE8gY3JlYXRlIGEgcHVsbCByZXF1ZXN0IGZvciBqcXVlcnkgdWkgdG8gdHJpZ2dlciB0aGlzIGV2ZW50CgkvLyBpbiB0aGUgb3JpZ2luYWwgX2NyZWF0ZVdpZGdldAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oKSB7CgkJJC5XaWRnZXQucHJvdG90eXBlLl9jcmVhdGVXaWRnZXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3RyaWdnZXIoICdpbml0JyApOwoJfSwKCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQlvcHRpb25zID0ge307CgoJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbiggb3B0aW9uICkgewoKCQkJdmFyIHZhbHVlID0gZWxlbS5qcW1EYXRhKCBvcHRpb24ucmVwbGFjZSggL1tBLVpdL2csIGZ1bmN0aW9uKCBjICkgewoJCQkJCQkJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKCQkJCQkJfSkKCQkJCQkpOwoKCQkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oIHRhcmdldCwgdXNlS2VlcE5hdGl2ZSApIHsKCQl0aGlzLmVuaGFuY2UoICQoIHRoaXMub3B0aW9ucy5pbml0U2VsZWN0b3IsICQoIHRhcmdldCApKSwgdXNlS2VlcE5hdGl2ZSApOwoJfSwKCgllbmhhbmNlOiBmdW5jdGlvbiggdGFyZ2V0cywgdXNlS2VlcE5hdGl2ZSApIHsKCQl2YXIgcGFnZSwga2VlcE5hdGl2ZSwgJHdpZGdldEVsZW1lbnRzID0gJCggdGFyZ2V0cyApLCBzZWxmID0gdGhpczsKCgkJLy8gaWYgaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IHRvIHRydWUgdGhlIGZyYW1ld29yayBzaG91bGQKCQkvLyBvbmx5IGVuaGFuY2UgdGhlIHNlbGVjdGVkIGVsZW1lbnRzIHdoZW4gdGhleSBkbyBOT1QgaGF2ZSBhCgkJLy8gcGFyZW50IHdpdGggdGhlIGRhdGEtbmFtZXNwYWNlLWlnbm9yZSBhdHRyaWJ1dGUKCQkkd2lkZ2V0RWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggJHdpZGdldEVsZW1lbnRzICk7CgoJCWlmICggdXNlS2VlcE5hdGl2ZSAmJiAkd2lkZ2V0RWxlbWVudHMubGVuZ3RoICkgewoJCQkvLyBUT0RPIHJlbW92ZSBkZXBlbmRlbmN5IG9uIHRoZSBwYWdlIHdpZGdldCBmb3IgdGhlIGtlZXBOYXRpdmUuCgkJCS8vIEN1cnJlbnRseSB0aGUga2VlcE5hdGl2ZSB2YWx1ZSBpcyBkZWZpbmVkIG9uIHRoZSBwYWdlIHByb3RvdHlwZSBzbwoJCQkvLyB0aGUgbWV0aG9kIGlzIGFzIHdlbGwKCQkJcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJHdpZGdldEVsZW1lbnRzICk7CgkJCWtlZXBOYXRpdmUgPSAocGFnZSAmJiBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpKSB8fCAiIjsKCgkJCSR3aWRnZXRFbGVtZW50cyA9ICR3aWRnZXRFbGVtZW50cy5ub3QoIGtlZXBOYXRpdmUgKTsKCQl9CgoJCSR3aWRnZXRFbGVtZW50c1sgdGhpcy53aWRnZXROYW1lIF0oKTsKCX0sCgoJcmFpc2U6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgIldpZGdldCBbIiArIHRoaXMud2lkZ2V0TmFtZSArICJdOiAiICsgbXNnOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9OwoKCS8vIGpRdWVyeS5tb2JpbGUgY29uZmlndXJhYmxlIG9wdGlvbnMKCSQubW9iaWxlID0gJC5leHRlbmQoIHt9LCB7CgoJCS8vIFZlcnNpb24gb2YgdGhlIGpRdWVyeSBNb2JpbGUgRnJhbWV3b3JrCgkJdmVyc2lvbjogIjEuMS4wIiwKCgkJLy8gTmFtZXNwYWNlIHVzZWQgZnJhbWV3b3JrLXdpZGUgZm9yIGRhdGEtYXR0cnMuIERlZmF1bHQgaXMgbm8gbmFtZXNwYWNlCgkJbnM6ICIiLAoKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCS8vIENsYXNzIGFzc2lnbmVkIHRvIHBhZ2UgY3VycmVudGx5IGluIHZpZXcsIGFuZCBkdXJpbmcgdHJhbnNpdGlvbnMKCQlhY3RpdmVQYWdlQ2xhc3M6ICJ1aS1wYWdlLWFjdGl2ZSIsCgoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImZvY3VzIiBmb3JtIGVsZW1lbnQgc3RhdGUsIGZyb20gQ1NTIGZyYW1ld29yawoJCWZvY3VzQ2xhc3M6ICJ1aS1mb2N1cyIsCgoJCS8vIEF1dG9tYXRpY2FsbHkgaGFuZGxlIGNsaWNrcyBhbmQgZm9ybSBzdWJtaXNzaW9ucyB0aHJvdWdoIEFqYXgsIHdoZW4gc2FtZS1kb21haW4KCQlhamF4RW5hYmxlZDogdHJ1ZSwKCgkJLy8gQXV0b21hdGljYWxseSBsb2FkIGFuZCBzaG93IHBhZ2VzIGJhc2VkIG9uIGxvY2F0aW9uLmhhc2gKCQloYXNoTGlzdGVuaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gZGlzYWJsZSB0byBwcmV2ZW50IGpxdWVyeSBmcm9tIGJvdGhlcmluZyB3aXRoIGxpbmtzCgkJbGlua0JpbmRpbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBTZXQgZGVmYXVsdCBwYWdlIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdFBhZ2VUcmFuc2l0aW9uOiAiZmFkZSIsCgoJCS8vIFNldCBtYXhpbXVtIHdpbmRvdyB3aWR0aCBmb3IgdHJhbnNpdGlvbnMgdG8gYXBwbHkgLSAnZmFsc2UnIGZvciBubyBsaW1pdAoJCW1heFRyYW5zaXRpb25XaWR0aDogZmFsc2UsCgoJCS8vIE1pbmltdW0gc2Nyb2xsIGRpc3RhbmNlIHRoYXQgd2lsbCBiZSByZW1lbWJlcmVkIHdoZW4gcmV0dXJuaW5nIHRvIGEgcGFnZQoJCW1pblNjcm9sbEJhY2s6IDI1MCwKCgkJLy8gREVQUkVDQVRFRDogdGhlIGZvbGxvd2luZyBwcm9wZXJ0eSBpcyBubyBsb25nZXIgaW4gdXNlLCBidXQgZGVmaW5lZCB1bnRpbCAyLjAgdG8gcHJldmVudCBjb25mbGljdHMKCQl0b3VjaE92ZXJmbG93RW5hYmxlZDogZmFsc2UsCgoJCS8vIFNldCBkZWZhdWx0IGRpYWxvZyB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHREaWFsb2dUcmFuc2l0aW9uOiAicG9wIiwKCgkJLy8gU2hvdyBsb2FkaW5nIG1lc3NhZ2UgZHVyaW5nIEFqYXggcmVxdWVzdHMKCQkvLyBpZiBmYWxzZSwgbWVzc2FnZSB3aWxsIG5vdCBhcHBlYXIsIGJ1dCBsb2FkaW5nIGNsYXNzZXMgd2lsbCBzdGlsbCBiZSB0b2dnbGVkIG9uIGh0bWwgZWwKCQlsb2FkaW5nTWVzc2FnZTogImxvYWRpbmciLAoKCQkvLyBFcnJvciByZXNwb25zZSBtZXNzYWdlIC0gYXBwZWFycyB3aGVuIGFuIEFqYXggcGFnZSByZXF1ZXN0IGZhaWxzCgkJcGFnZUxvYWRFcnJvck1lc3NhZ2U6ICJFcnJvciBMb2FkaW5nIFBhZ2UiLAoKCQkvLyBTaG91bGQgdGhlIHRleHQgYmUgdmlzYmxlIGluIHRoZSBsb2FkaW5nIG1lc3NhZ2U/CgkJbG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTogZmFsc2UsCgoJCS8vIFdoZW4gdGhlIHRleHQgaXMgdmlzaWJsZSwgd2hhdCB0aGVtZSBkb2VzIHRoZSBsb2FkaW5nIGJveCB1c2U/CgkJbG9hZGluZ01lc3NhZ2VUaGVtZTogImEiLAoKCQkvLyBGb3IgZXJyb3IgbWVzc2FnZXMsIHdoaWNoIHRoZW1lIGRvZXMgdGhlIGJveCB1c2VzPwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWU6ICJlIiwKCgkJLy9hdXRvbWF0aWNhbGx5IGluaXRpYWxpemUgdGhlIERPTSB3aGVuIGl0J3MgcmVhZHkKCQlhdXRvSW5pdGlhbGl6ZVBhZ2U6IHRydWUsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGFsbG93cyB1c2VycyB0byBvcHQgaW4gdG8gaWdub3JpbmcgY29udGVudCBieSBtYXJraW5nIGEgcGFyZW50IGVsZW1lbnQgYXMKCQkvLyBkYXRhLWlnbm9yZWQKCQlpZ25vcmVDb250ZW50RW5hYmxlZDogZmFsc2UsCgoJCS8vIHR1cm4gb2YgYmluZGluZyB0byB0aGUgbmF0aXZlIG9yaWVudGF0aW9uY2hhbmdlIGR1ZSB0byBhbmRyb2lkIG9yaWVudGF0aW9uIGJlaGF2aW9yCgkJb3JpZW50YXRpb25DaGFuZ2VFbmFibGVkOiB0cnVlLAoKCQlidXR0b25NYXJrdXA6IHsKCQkJaG92ZXJEZWxheTogMjAwCgkJfSwKCgkJLy8gVE9ETyBtaWdodCBiZSB1c2VmdWwgdXBzdHJlYW0gaW4ganF1ZXJ5IGl0c2VsZiA/CgkJa2V5Q29kZTogewoJCQlBTFQ6IDE4LAoJCQlCQUNLU1BBQ0U6IDgsCgkJCUNBUFNfTE9DSzogMjAsCgkJCUNPTU1BOiAxODgsCgkJCUNPTU1BTkQ6IDkxLAoJCQlDT01NQU5EX0xFRlQ6IDkxLCAvLyBDT01NQU5ECgkJCUNPTU1BTkRfUklHSFQ6IDkzLAoJCQlDT05UUk9MOiAxNywKCQkJREVMRVRFOiA0NiwKCQkJRE9XTjogNDAsCgkJCUVORDogMzUsCgkJCUVOVEVSOiAxMywKCQkJRVNDQVBFOiAyNywKCQkJSE9NRTogMzYsCgkJCUlOU0VSVDogNDUsCgkJCUxFRlQ6IDM3LAoJCQlNRU5VOiA5MywgLy8gQ09NTUFORF9SSUdIVAoJCQlOVU1QQURfQUREOiAxMDcsCgkJCU5VTVBBRF9ERUNJTUFMOiAxMTAsCgkJCU5VTVBBRF9ESVZJREU6IDExMSwKCQkJTlVNUEFEX0VOVEVSOiAxMDgsCgkJCU5VTVBBRF9NVUxUSVBMWTogMTA2LAoJCQlOVU1QQURfU1VCVFJBQ1Q6IDEwOSwKCQkJUEFHRV9ET1dOOiAzNCwKCQkJUEFHRV9VUDogMzMsCgkJCVBFUklPRDogMTkwLAoJCQlSSUdIVDogMzksCgkJCVNISUZUOiAxNiwKCQkJU1BBQ0U6IDMyLAoJCQlUQUI6IDksCgkJCVVQOiAzOCwKCQkJV0lORE9XUzogOTEgLy8gQ09NTUFORAoJCX0sCgoJCS8vIFNjcm9sbCBwYWdlIHZlcnRpY2FsbHk6IHNjcm9sbCB0byAwIHRvIGhpZGUgaU9TIGFkZHJlc3MgYmFyLCBvciBwYXNzIGEgWSB2YWx1ZQoJCXNpbGVudFNjcm9sbDogZnVuY3Rpb24oIHlwb3MgKSB7CgkJCWlmICggJC50eXBlKCB5cG9zICkgIT09ICJudW1iZXIiICkgewoJCQkJeXBvcyA9ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCQl9CgoJCQkvLyBwcmV2ZW50IHNjcm9sbHN0YXJ0IGFuZCBzY3JvbGxzdG9wIGV2ZW50cwoJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgeXBvcyApOwoJCQkJJCggZG9jdW1lbnQgKS50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJaWYgKCAhcHJvcCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8ICggbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gPSAkLmNhbWVsQ2FzZSggJC5tb2JpbGUubnMgKyBwcm9wICkgKTsKCQl9LAoKCQlnZXRJbmhlcml0ZWRUaGVtZTogZnVuY3Rpb24oIGVsLCBkZWZhdWx0VGhlbWUgKSB7CgoJCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCQkvLyB3ZSBhcmUgbm90IHVzaW5nICQuZm4uY2xvc2VzdCgpIG9uIHB1cnBvc2UgaGVyZSBiZWNhdXNlIHRoaXMKCQkJLy8gbWV0aG9kIGdldHMgY2FsbGVkIHF1aXRlIGEgYml0IGFuZCB3ZSBuZWVkIGl0IHRvIGJlIGFzIGZhc3QKCQkJLy8gYXMgcG9zc2libGUuCgoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCgkJCXdoaWxlICggZSApIHsKCQkJCXZhciBjID0gZS5jbGFzc05hbWUgfHwgIiI7CgkJCQlpZiAoICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCX0KCgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoKCQkJcmV0dXJuIGx0ciB8fCBkZWZhdWx0VGhlbWUgfHwgImEiOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZvbGxvd2luZyAkIGFuZCAkLmZuIGV4dGVuc2lvbnMgY2FuL3Byb2JhYmx5IHNob3VsZCBiZSBtb3ZlZCBpbnRvIGpxdWVyeS5tb2JpbGUuY29yZS5oZWxwZXJzCgkJLy8KCQkvLyBGaW5kIHRoZSBjbG9zZXN0IGphdmFzY3JpcHQgcGFnZSBlbGVtZW50IHRvIGdhdGhlciBzZXR0aW5ncyBkYXRhIGpzcGVyZiB0ZXN0CgkJLy8gaHR0cDovL2pzcGVyZi5jb20vc2luZ2xlLWNvbXBsZXgtc2VsZWN0b3ItdnMtbWFueS1jb21wbGV4LXNlbGVjdG9ycy9lZGl0CgkJLy8gcG9zc2libHkgbmFpdmUsIGJ1dCBpdCBzaG93cyB0aGF0IHRoZSBwYXJzaW5nIG92ZXJoZWFkIGZvciAqanVzdCogdGhlIHBhZ2Ugc2VsZWN0b3IgdnMKCQkvLyB0aGUgcGFnZSBhbmQgZGlhbG9nIHNlbGVjdG9yIGlzIG5lZ2xpZ2FibGUuIFRoaXMgY291bGQgcHJvYmFibHkgYmUgc3BlZWQgdXAgYnkKCQkvLyBkb2luZyBhIHNpbWlsYXIgcGFyZW50IG5vZGUgdHJhdmVyc2FsIHRvIHRoZSBvbmUgZm91bmQgaW4gdGhlIGluaGVyaXRlZCB0aGVtZSBjb2RlIGFib3ZlCgkJY2xvc2VzdFBhZ2VEYXRhOiBmdW5jdGlvbiggJHRhcmdldCApIHsKCQkJcmV0dXJuICR0YXJnZXQKCQkJCS5jbG9zZXN0KCc6anFtRGF0YShyb2xlPSJwYWdlIiksIDpqcW1EYXRhKHJvbGU9ImRpYWxvZyIpJykKCQkJCS5kYXRhKCJwYWdlIik7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCAkc2V0ICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggJHNldCwgImVuaGFuY2UiICk7CgkJfSwKCgkJaGlqYWNrYWJsZTogZnVuY3Rpb24oICRzZXQgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCAkc2V0LCAiYWpheCIgKTsKCQl9LAoKCQloYXZlUGFyZW50czogZnVuY3Rpb24oICRzZXQsIGF0dHIgKSB7CgkJCWlmKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKXsKCQkJCXJldHVybiAkc2V0OwoJCQl9CgoJCQl2YXIgY291bnQgPSAkc2V0Lmxlbmd0aCwKCQkJCSRuZXdTZXQgPSAkKCksCgkJCQllLCAkZWxlbWVudCwgZXhjbHVkZWQ7CgoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBjb3VudDsgaSsrICkgewoJCQkJJGVsZW1lbnQgPSAkc2V0LmVxKCBpICk7CgkJCQlleGNsdWRlZCA9IGZhbHNlOwoJCQkJZSA9ICRzZXRbIGkgXTsKCgkJCQl3aGlsZSAoIGUgKSB7CgkJCQkJdmFyIGMgPSBlLmdldEF0dHJpYnV0ZSA/IGUuZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBhdHRyICkgOiAiIjsKCgkJCQkJaWYgKCBjID09PSAiZmFsc2UiICkgewoJCQkJCQlleGNsdWRlZCA9IHRydWU7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCgkJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJCX0KCgkJCQlpZiAoICFleGNsdWRlZCApIHsKCQkJCQkkbmV3U2V0ID0gJG5ld1NldC5hZGQoICRlbGVtZW50ICk7CgkJCQl9CgkJCX0KCgkJCXJldHVybiAkbmV3U2V0OwoJCX0KCX0sICQubW9iaWxlICk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPSAidW5kZWZpbmVkIiApIHsKCQkJaWYgKCBwcm9wICkgewoJCQkJcHJvcCA9ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICk7CgkJCX0KCQkJcmVzdWx0ID0gdGhpcy5kYXRhLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMubGVuZ3RoIDwgMiA/IFsgcHJvcCBdIDogWyBwcm9wLCB2YWx1ZSBdICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuanFtRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5mbi5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCkgewoJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCX07CgoJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKTsKCgkJKCAkZWxlbS5qcW1EYXRhKCdkZXBlbmRlbnRzJykgfHwgJCgpICkucmVtb3ZlKCk7CgkJJGVsZW0ucmVtb3ZlKCk7Cgl9OwoKCSQuZm4uYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuZXdEZXBlbmRlbnRzICkgewoJCSQuYWRkRGVwZW5kZW50cyggJCh0aGlzKSwgbmV3RGVwZW5kZW50cyApOwoJfTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgZGVwZW5kZW50cyA9ICQoZWxlbSkuanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpOwoKCQkkKGVsZW0pLmpxbURhdGEoICdkZXBlbmRlbnRzJywgJC5tZXJnZShkZXBlbmRlbnRzLCBuZXdEZXBlbmRlbnRzKSApOwoJfTsKCgkvLyBub3RlIHRoYXQgdGhpcyBoZWxwZXIgZG9lc24ndCBhdHRlbXB0IHRvIGhhbmRsZSB0aGUgY2FsbGJhY2sKCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50cyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkvLyB0byByZXR1cm4gdGhlIGh0bWwgZW5jb2RlZCB2ZXJzaW9uIG9mIHRoZSB0ZXh0IGluIGFsbCBjYXNlcy4gKHRodXMgdGhlIG5hbWUpCgkkLmZuLmdldEVuY29kZWRUZXh0ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICkudGV4dCggJCh0aGlzKS50ZXh0KCkgKS5odG1sKCk7Cgl9OwoKCS8vIGZsdWVudCBoZWxwZXIgZnVuY3Rpb24gZm9yIHRoZSBtb2JpbGUgbmFtZXNwYWNlZCBlcXVpdmFsZW50CgkkLmZuLmpxbUVuaGFuY2VhYmxlID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmVuaGFuY2VhYmxlKCB0aGlzICk7Cgl9OwoKCSQuZm4uanFtSGlqYWNrYWJsZSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5oaWphY2thYmxlKCB0aGlzICk7Cgl9OwoKCS8vIE1vbmtleS1wYXRjaGluZyBTaXp6bGUgdG8gZmlsdGVyIHRoZSA6anFtRGF0YSBzZWxlY3RvcgoJdmFyIG9sZEZpbmQgPSAkLmZpbmQsCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCgkJcmV0dXJuIG9sZEZpbmQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKTsKCX07CgoJJC5leHRlbmQoICQuZmluZCwgb2xkRmluZCApOwoKCSQuZmluZC5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIHNldCApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBzZXQgKTsKCX07CgoJJC5maW5kLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBub2RlLCBleHByICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIFsgbm9kZSBdICkubGVuZ3RoID4gMDsKCX07Cn0pKCBqUXVlcnksIHRoaXMgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciAkd2luZG93ID0gJCggd2luZG93ICksCgkkaHRtbCA9ICQoICJodG1sIiApOwoKLyogJC5tb2JpbGUubWVkaWEgbWV0aG9kOiBwYXNzIGEgQ1NTIG1lZGlhIHR5cGUgb3IgcXVlcnkgYW5kIGdldCBhIGJvb2wgcmV0dXJuCglub3RlOiB0aGlzIGZlYXR1cmUgcmVsaWVzIG9uIGFjdHVhbCBtZWRpYSBxdWVyeSBzdXBwb3J0IGZvciBtZWRpYSBxdWVyaWVzLCB0aG91Z2ggdHlwZXMgd2lsbCB3b3JrIG1vc3QgYW55d2hlcmUKCWV4YW1wbGVzOgoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4nKSAvLyB0ZXN0cyBmb3Igc2NyZWVuIG1lZGlhIHR5cGUKCQkkLm1vYmlsZS5tZWRpYSgnc2NyZWVuIGFuZCAobWluLXdpZHRoOiA0ODBweCknKSAvLyB0ZXN0cyBmb3Igc2NyZWVuIG1lZGlhIHR5cGUgd2l0aCB3aW5kb3cgd2lkdGggPiA0ODBweAoJCSQubW9iaWxlLm1lZGlhKCdAbWVkaWEgc2NyZWVuIGFuZCAoLXdlYmtpdC1taW4tZGV2aWNlLXBpeGVsLXJhdGlvOiAyKScpIC8vIHRlc3RzIGZvciB3ZWJraXQgMnggcGl4ZWwgcmF0aW8gKGlQaG9uZSA0KQoqLwokLm1vYmlsZS5tZWRpYSA9IChmdW5jdGlvbigpIHsKCS8vIFRPRE86IHVzZSB3aW5kb3cubWF0Y2hNZWRpYSBvbmNlIGF0IGxlYXN0IG9uZSBVQSBpbXBsZW1lbnRzIGl0Cgl2YXIgY2FjaGUgPSB7fSwKCQl0ZXN0RGl2ID0gJCggIjxkaXYgaWQ9J2pxdWVyeS1tZWRpYXRlc3QnPiIgKSwKCQlmYWtlQm9keSA9ICQoICI8Ym9keT4iICkuYXBwZW5kKCB0ZXN0RGl2ICk7CgoJcmV0dXJuIGZ1bmN0aW9uKCBxdWVyeSApIHsKCQlpZiAoICEoIHF1ZXJ5IGluIGNhY2hlICkgKSB7CgkJCXZhciBzdHlsZUJsb2NrID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInN0eWxlIiApLAoJCQkJY3NzcnVsZSA9ICJAbWVkaWEgIiArIHF1ZXJ5ICsgIiB7ICNqcXVlcnktbWVkaWF0ZXN0IHsgcG9zaXRpb246YWJzb2x1dGU7IH0gfSI7CgoJCQkvL211c3Qgc2V0IHR5cGUgZm9yIElFIQoJCQlzdHlsZUJsb2NrLnR5cGUgPSAidGV4dC9jc3MiOwoKCQkJaWYgKCBzdHlsZUJsb2NrLnN0eWxlU2hlZXQgICl7CgkJCQlzdHlsZUJsb2NrLnN0eWxlU2hlZXQuY3NzVGV4dCA9IGNzc3J1bGU7CgkJCX0gZWxzZSB7CgkJCQlzdHlsZUJsb2NrLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjc3NydWxlKSApOwoJCQl9CgoJCQkkaHRtbC5wcmVwZW5kKCBmYWtlQm9keSApLnByZXBlbmQoIHN0eWxlQmxvY2sgKTsKCQkJY2FjaGVbIHF1ZXJ5IF0gPSB0ZXN0RGl2LmNzcyggInBvc2l0aW9uIiApID09PSAiYWJzb2x1dGUiOwoJCQlmYWtlQm9keS5hZGQoIHN0eWxlQmxvY2sgKS5yZW1vdmUoKTsKCQl9CgkJcmV0dXJuIGNhY2hlWyBxdWVyeSBdOwoJfTsKfSkoKTsKCn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBmYWtlQm9keSA9ICQoICI8Ym9keT4iICkucHJlcGVuZFRvKCAiaHRtbCIgKSwKCWZiQ1NTID0gZmFrZUJvZHlbIDAgXS5zdHlsZSwKCXZlbmRvcnMgPSBbICJXZWJraXQiLCAiTW96IiwgIk8iIF0sCgl3ZWJvcyA9ICJwYWxtR2V0UmVzb3VyY2UiIGluIHdpbmRvdywgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgc2Nyb2xsVG9wCglvcGVyYW1pbmkgPSB3aW5kb3cub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggd2luZG93Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiwKCWJiID0gd2luZG93LmJsYWNrYmVycnk7IC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IGJveCBzaGFkb3csIGFzIGl0J3MgZmlsbGVkIG9wYXF1ZSBvbiBCQgoKLy8gdGh4IE1vZGVybml6cgpmdW5jdGlvbiBwcm9wRXhpc3RzKCBwcm9wICkgewoJdmFyIHVjX3Byb3AgPSBwcm9wLmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnN1YnN0ciggMSApLAoJCXByb3BzID0gKCBwcm9wICsgIiAiICsgdmVuZG9ycy5qb2luKCB1Y19wcm9wICsgIiAiICkgKyB1Y19wcm9wICkuc3BsaXQoICIgIiApOwoKCWZvciAoIHZhciB2IGluIHByb3BzICl7CgkJaWYgKCBmYkNTU1sgcHJvcHNbIHYgXSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KfQoKZnVuY3Rpb24gdmFsaWRTdHlsZSggcHJvcCwgdmFsdWUsIGNoZWNrX3ZlbmQgKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksCgkJdWMgPSBmdW5jdGlvbiggdHh0ICkgewoJCQlyZXR1cm4gdHh0LmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyB0eHQuc3Vic3RyKCAxICkKCQl9LAoJCXZlbmRfcHJlZiA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJfSwKCQljaGVja19zdHlsZSA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQl2YXIgdmVuZF9wcm9wID0gdmVuZF9wcmVmKCB2ZW5kICkgKyBwcm9wICsgIjogIiArIHZhbHVlICsgIjsiLAoJCQkJdWNfdmVuZCA9IHVjKCB2ZW5kICksCgkJCQlwcm9wU3R5bGUgPSB1Y192ZW5kICsgdWMoIHByb3AgKTsKCQkKCQkJZGl2LnNldEF0dHJpYnV0ZSggInN0eWxlIiwgdmVuZF9wcm9wICk7CgkJCgkJCWlmKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBbIGNoZWNrX3ZlbmQgXSA6IHZlbmRvcnMsCgkJcmV0OwoKCWZvciggaSA9IDA7IGkgPCBjaGVja192ZW5kcy5sZW5ndGg7IGkrKyApIHsKCQljaGVja19zdHlsZSggY2hlY2tfdmVuZHNbaV0gKTsKCX0KCXJldHVybiAhIXJldDsKfQoKLy8gVGhhbmtzIHRvIE1vZGVybml6ciBzcmMgZm9yIHRoaXMgdGVzdCBpZGVhLiBgcGVyc3BlY3RpdmVgIGNoZWNrIGlzIGxpbWl0ZWQgdG8gTW96IHRvIHByZXZlbnQgYSBmYWxzZSBwb3NpdGl2ZSBmb3IgM0QgdHJhbnNmb3JtcyBvbiBBbmRyb2lkLgpmdW5jdGlvbiB0cmFuc2Zvcm0zZFRlc3QoKSB7Cgl2YXIgcHJvcCA9ICJ0cmFuc2Zvcm0tM2QiOwoJcmV0dXJuIHZhbGlkU3R5bGUoICdwZXJzcGVjdGl2ZScsICcxMHB4JywgJ21veicgKSB8fCAkLm1vYmlsZS5tZWRpYSggIigtIiArIHZlbmRvcnMuam9pbiggIi0iICsgcHJvcCArICIpLCgtIiApICsgIi0iICsgcHJvcCArICIpLCgiICsgcHJvcCArICIpIiApOwp9CgovLyBUZXN0IGZvciBkeW5hbWljLXVwZGF0aW5nIGJhc2UgdGFnIHN1cHBvcnQgKCBhbGxvd3MgdXMgdG8gYXZvaWQgaHJlZixzcmMgYXR0ciByZXdyaXRpbmcgKQpmdW5jdGlvbiBiYXNlVGFnVGVzdCgpIHsKCXZhciBmYXV4QmFzZSA9IGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSArICJ1aS1kaXIvIiwKCQliYXNlID0gJCggImhlYWQgYmFzZSIgKSwKCQlmYXV4RWxlID0gbnVsbCwKCQlocmVmID0gIiIsCgkJbGluaywgcmViYXNlOwoKCWlmICggIWJhc2UubGVuZ3RoICkgewoJCWJhc2UgPSBmYXV4RWxlID0gJCggIjxiYXNlPiIsIHsgImhyZWYiOiBmYXV4QmFzZSB9KS5hcHBlbmRUbyggImhlYWQiICk7Cgl9IGVsc2UgewoJCWhyZWYgPSBiYXNlLmF0dHIoICJocmVmIiApOwoJfQoKCWxpbmsgPSAkKCAiPGEgaHJlZj0ndGVzdHVybCcgLz4iICkucHJlcGVuZFRvKCBmYWtlQm9keSApOwoJcmViYXNlID0gbGlua1sgMCBdLmhyZWY7CgliYXNlWyAwIF0uaHJlZiA9IGhyZWYgfHwgbG9jYXRpb24ucGF0aG5hbWU7CgoJaWYgKCBmYXV4RWxlICkgewoJCWZhdXhFbGUucmVtb3ZlKCk7Cgl9CglyZXR1cm4gcmViYXNlLmluZGV4T2YoIGZhdXhCYXNlICkgPT09IDA7Cn0KCgovLyBub24tVUEtYmFzZWQgSUUgdmVyc2lvbiBjaGVjayBieSBKYW1lcyBQYWRvbHNleSwgbW9kaWZpZWQgYnkgamRhbHRvbiAtIGZyb20gaHR0cDovL2dpc3QuZ2l0aHViLmNvbS81Mjc2ODMKLy8gYWxsb3dzIGZvciBpbmNsdXNpb24gb2YgSUUgNissIGluY2x1ZGluZyBXaW5kb3dzIE1vYmlsZSA3CiQuZXh0ZW5kKCAkLm1vYmlsZSwgeyBicm93c2VyOiB7fSB9ICk7CiQubW9iaWxlLmJyb3dzZXIuaWUgPSAoZnVuY3Rpb24oKSB7Cgl2YXIgdiA9IDMsCglkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJYSA9IGRpdi5hbGwgfHwgW107CgoJLy8gYWRkZWQge30gdG8gc2lsZW5jZSBjbG9zdXJlIGNvbXBpbGVyIHdhcm5pbmdzLiByZWdpc3RlcmluZyBteSBkaXNsaWtlIG9mIGFsbCB0aGluZ3MKCS8vIG92ZXJseSBjbGV2ZXIgaGVyZSBmb3IgZnV0dXJlIHJlZmVyZW5jZQoJd2hpbGUgKCBkaXYuaW5uZXJIVE1MID0gIjwhLS1baWYgZ3QgSUUgIiArICggKyt2ICkgKyAiXT48YnI+PCFbZW5kaWZdLS0+IiwgYVsgMCBdICl7fTsKCglyZXR1cm4gdiA+IDQgPyB2IDogIXY7Cn0pKCk7CgoKJC5leHRlbmQoICQuc3VwcG9ydCwgewoJb3JpZW50YXRpb246ICJvcmllbnRhdGlvbiIgaW4gd2luZG93ICYmICJvbm9yaWVudGF0aW9uY2hhbmdlIiBpbiB3aW5kb3csCgl0b3VjaDogIm9udG91Y2hlbmQiIGluIGRvY3VtZW50LAoJY3NzVHJhbnNpdGlvbnM6ICJXZWJLaXRUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdyB8fCB2YWxpZFN0eWxlKCAndHJhbnNpdGlvbicsICdoZWlnaHQgMTAwbXMgbGluZWFyJyApLAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmICJyZXBsYWNlU3RhdGUiIGluIGhpc3RvcnksCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJYm94U2hhZG93OiAhIXByb3BFeGlzdHMoICJib3hTaGFkb3ciICkgJiYgIWJiLAoJc2Nyb2xsVG9wOiAoICJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8ICJzY3JvbGxUb3AiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fCAic2Nyb2xsVG9wIiBpbiBmYWtlQm9keVsgMCBdICkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCglkeW5hbWljQmFzZVRhZzogYmFzZVRhZ1Rlc3QoKQp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKdmFyIG5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCl7CgoJdmFyIHVhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7CgoJLy9UaGUgZm9sbG93aW5nIGlzIGFuIGF0dGVtcHQgdG8gbWF0Y2ggTm9raWEgYnJvd3NlcnMgdGhhdCBhcmUgcnVubmluZyBTeW1iaWFuL3M2MCwgd2l0aCB3ZWJraXQsIHZlcnNpb24gNy4zIG9yIG9sZGVyCglyZXR1cm4gdWEuaW5kZXhPZiggIk5va2lhIiApID4gLTEgJiYKCQkJKCB1YS5pbmRleE9mKCAiU3ltYmlhbi8zIiApID4gLTEgfHwgdWEuaW5kZXhPZiggIlNlcmllczYwLzUiICkgPiAtMSApICYmCgkJCXVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICYmCgkJCXVhLm1hdGNoKCAvKEJyb3dzZXJOR3xOb2tpYUJyb3dzZXIpXC83XC5bMC0zXS8gKTsKfSkoKTsKCi8vIFN1cHBvcnQgY29uZGl0aW9ucyB0aGF0IG11c3QgYmUgbWV0IGluIG9yZGVyIHRvIHByb2NlZWQKLy8gZGVmYXVsdCBlbmhhbmNlZCBxdWFsaWZpY2F0aW9ucyBhcmUgbWVkaWEgcXVlcnkgc3VwcG9ydCBPUiBJRSA3KwokLm1vYmlsZS5ncmFkZUEgPSBmdW5jdGlvbigpewoJcmV0dXJuICQuc3VwcG9ydC5tZWRpYXF1ZXJ5IHx8ICQubW9iaWxlLmJyb3dzZXIuaWUgJiYgJC5tb2JpbGUuYnJvd3Nlci5pZSA+PSA3Owp9OwoKJC5tb2JpbGUuYWpheEJsYWNrbGlzdCA9CgkJCS8vIEJsYWNrQmVycnkgYnJvd3NlcnMsIHByZS13ZWJraXQKCQkJd2luZG93LmJsYWNrYmVycnkgJiYgIXdpbmRvdy5XZWJLaXRQb2ludCB8fAoJCQkvLyBPcGVyYSBNaW5pCgkJCW9wZXJhbWluaSB8fAoJCQkvLyBTeW1iaWFuIHdlYmtpdHMgcHJlIDcuMwoJCQlub2tpYUxURTdfMzsKCi8vIExhc3RseSwgdGhpcyB3b3JrYXJvdW5kIGlzIHRoZSBvbmx5IHdheSB3ZSd2ZSBmb3VuZCBzbyBmYXIgdG8gZ2V0IHByZSA3LjMgU3ltYmlhbiB3ZWJraXQgZGV2aWNlcwovLyB0byByZW5kZXIgdGhlIHN0eWxlc2hlZXRzIHdoZW4gdGhleSdyZSByZWZlcmVuY2VkIGJlZm9yZSB0aGlzIHNjcmlwdCwgYXMgd2UnZCByZWNvbW1lbmQgZG9pbmcuCi8vIFRoaXMgc2ltcGx5IHJlYXBwZW5kcyB0aGUgQ1NTIGluIHBsYWNlLCB3aGljaCBmb3Igc29tZSByZWFzb24gbWFrZXMgaXQgYXBwbHkKaWYgKCBub2tpYUxURTdfMyApIHsKCSQoZnVuY3Rpb24oKSB7CgkJJCggImhlYWQgbGlua1tyZWw9J3N0eWxlc2hlZXQnXSIgKS5hdHRyKCAicmVsIiwgImFsdGVybmF0ZSBzdHlsZXNoZWV0IiApLmF0dHIoICJyZWwiLCAic3R5bGVzaGVldCIgKTsKCX0pOwp9CgovLyBGb3IgcnVsaW5nIG91dCBzaGFkb3dzIHZpYSBjc3MKaWYgKCAhJC5zdXBwb3J0LmJveFNoYWRvdyApIHsKCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbW9iaWxlLW5vc3VwcG9ydC1ib3hzaGFkb3ciICk7Cn0KCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBhZGQgbmV3IGV2ZW50IHNob3J0Y3V0cwokLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kIG9yaWVudGF0aW9uY2hhbmdlIHRocm90dGxlZHJlc2l6ZSAiICsKCQkJCQkidGFwIHRhcGhvbGQgc3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgc2Nyb2xsc3RhcnQgc2Nyb2xsc3RvcCIgKS5zcGxpdCggIiAiICksIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoKCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCX07CgoJJC5hdHRyRm5bIG5hbWUgXSA9IHRydWU7Cn0pOwoKdmFyIHN1cHBvcnRUb3VjaCA9ICQuc3VwcG9ydC50b3VjaCwKCXNjcm9sbEV2ZW50ID0gInRvdWNobW92ZSBzY3JvbGwiLAoJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgl0b3VjaFN0b3BFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaGVuZCIgOiAibW91c2V1cCIsCgl0b3VjaE1vdmVFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaG1vdmUiIDogIm1vdXNlbW92ZSI7CgpmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCXZhciBvcmlnaW5hbFR5cGUgPSBldmVudC50eXBlOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCSQuZXZlbnQuaGFuZGxlLmNhbGwoIG9iaiwgZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cn0KCi8vIGFsc28gaGFuZGxlcyBzY3JvbGxzdG9wCiQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgllbmFibGVkOiB0cnVlLAoKCXNldHVwOiBmdW5jdGlvbigpIHsKCgkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJc2Nyb2xsaW5nLAoJCQl0aW1lcjsKCgkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQlzY3JvbGxpbmcgPSBzdGF0ZTsKCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBzY3JvbGxpbmcgPyAic2Nyb2xsc3RhcnQiIDogInNjcm9sbHN0b3AiLCBldmVudCApOwoJCX0KCgkJLy8gaVBob25lIHRyaWdnZXJzIHNjcm9sbCBhZnRlciBhIHNtYWxsIGRlbGF5OyB1c2UgdG91Y2htb3ZlIGluc3RlYWQKCQkkdGhpcy5iaW5kKCBzY3JvbGxFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCXRyaWdnZXIoIGV2ZW50LCB0cnVlICk7CgkJCX0KCgkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCX0sIDUwICk7CgkJfSk7Cgl9Cn07CgovLyBhbHNvIGhhbmRsZXMgdGFwaG9sZAokLmV2ZW50LnNwZWNpYWwudGFwID0gewoJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJaWYgKCBldmVudC53aGljaCAmJiBldmVudC53aGljaCAhPT0gMSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIG9yaWdUYXJnZXQgPSBldmVudC50YXJnZXQsCgkJCQlvcmlnRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50LAoJCQkJdGltZXI7CgoJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQl9CgoJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJY2xlYXJUYXBUaW1lcigpOwoKCQkJCSR0aGlzLnVuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApCgkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJJCggZG9jdW1lbnQgKS51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCX0KCgkJCWZ1bmN0aW9uIGNsaWNrSGFuZGxlcihldmVudCkgewoJCQkJY2xlYXJUYXBIYW5kbGVycygpOwoKCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCS8vIHRoZSBzYW1lIGFzIHRoZSBzdG9wIHRhcmdldC4KCQkJCWlmICggb3JpZ1RhcmdldCA9PSBldmVudC50YXJnZXQgKSB7CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCX0KCQkJfQoKCQkJJHRoaXMuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApCgkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQl0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwaG9sZCIsICQuRXZlbnQoICJ0YXBob2xkIiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQgfSApICk7CgkJCX0sIDc1MCApOwoJCX0pOwoJfQp9OwoKLy8gYWxzbyBoYW5kbGVzIHN3aXBlbGVmdCwgc3dpcGVyaWdodAokLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CglzY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkOiAxMCwgLy8gTW9yZSB0aGFuIHRoaXMgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQsIGFuZCB3ZSB3aWxsIHN1cHByZXNzIHNjcm9sbGluZy4KCglkdXJhdGlvblRocmVzaG9sZDogMTAwMCwgLy8gTW9yZSB0aW1lIHRoYW4gdGhpcywgYW5kIGl0IGlzbid0IGEgc3dpcGUuCgoJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJdmVydGljYWxEaXN0YW5jZVRocmVzaG9sZDogNzUsICAvLyBTd2lwZSB2ZXJ0aWNhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBsZXNzIHRoYW4gdGhpcy4KCglzZXR1cDogZnVuY3Rpb24oKSB7CgkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJJHRoaXMuYmluZCggdG91Y2hTdGFydEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50LAoJCQkJc3RhcnQgPSB7CgkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJb3JpZ2luOiAkKCBldmVudC50YXJnZXQgKQoJCQkJfSwKCQkJCXN0b3A7CgoJCQlmdW5jdGlvbiBtb3ZlSGFuZGxlciggZXZlbnQgKSB7CgoJCQkJaWYgKCAhc3RhcnQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudDsKCgkJCQlzdG9wID0gewoJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdCgkJCQl9OwoKCQkJCS8vIHByZXZlbnQgc2Nyb2xsaW5nCgkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCgkJCSR0aGlzLmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApCgkJCQkub25lKCB0b3VjaFN0b3BFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgoJCQkJCWlmICggc3RhcnQgJiYgc3RvcCApIHsKCQkJCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQkJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZCAmJgoJCQkJCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDEgXSAtIHN0b3AuY29vcmRzWyAxIF0gKSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS52ZXJ0aWNhbERpc3RhbmNlVGhyZXNob2xkICkgewoKCQkJCQkJCXN0YXJ0Lm9yaWdpbi50cmlnZ2VyKCAic3dpcGUiICkKCQkJCQkJCQkudHJpZ2dlciggc3RhcnQuY29vcmRzWzBdID4gc3RvcC5jb29yZHNbIDAgXSA/ICJzd2lwZWxlZnQiIDogInN3aXBlcmlnaHQiICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJc3RhcnQgPSBzdG9wID0gdW5kZWZpbmVkOwoJCQkJfSk7CgkJfSk7Cgl9Cn07CgooZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCS8vICJDb3dib3kiIEJlbiBBbG1hbgoKCXZhciB3aW4gPSAkKCB3aW5kb3cgKSwKCQlzcGVjaWFsX2V2ZW50LAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfTsKCgkvLyBJdCBzZWVtcyB0aGF0IHNvbWUgZGV2aWNlL2Jyb3dzZXIgdmVuZG9ycyB1c2Ugd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlcyAwIGFuZCAxODAgdG8KCS8vIGRlbm90ZSB0aGUgImRlZmF1bHQiIG9yaWVudGF0aW9uLiBGb3IgaU9TIGRldmljZXMsIGFuZCBtb3N0IG90aGVyIHNtYXJ0LXBob25lcyB0ZXN0ZWQsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyBhbHdheXMgInBvcnRyYWl0IiwgYnV0IGluIHNvbWUgQW5kcm9pZCBhbmQgUklNIGJhc2VkIHRhYmxldHMsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyAibGFuZHNjYXBlIi4gVGhlIGZvbGxvd2luZyBjb2RlIGF0dGVtcHRzIHRvIHVzZSB0aGUgd2luZG93CgkvLyBkaW1lbnNpb25zIHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiBpcywgYW5kIHRoZW4gbWFrZXMgYWRqdXN0bWVudHMKCS8vIHRvIHRoZSB0byB0aGUgcG9ydHJhaXRfbWFwIGlmIG5lY2Vzc2FyeSwgc28gdGhhdCB3ZSBjYW4gcHJvcGVybHkgZGVjb2RlIHRoZQoJLy8gd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlIHdoZW5ldmVyIGdldF9vcmllbnRhdGlvbigpIGlzIGNhbGxlZC4KCS8vCgkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2UgYSBtZWRpYSBxdWVyeSB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIG9yaWVudGF0aW9uIHRoZSBicm93c2VyCgkvLyB0aGlua3MgaXQgaXMgaW46CgkvLwoJLy8gICAgIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gJC5tb2JpbGUubWVkaWEoImFsbCBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIik7CgkvLwoJLy8gYnV0IHRoZXJlIHdhcyBhbiBpUGhvbmUvaVBvZCBUb3VjaCBidWcgYmVnaW5uaW5nIHdpdGggaU9TIDQuMiwgdXAgdGhyb3VnaCBpT1MgNS4xLAoJLy8gd2hlcmUgdGhlIGJyb3dzZXIgKkFMV0FZUyogYXBwbGllZCB0aGUgbGFuZHNjYXBlIG1lZGlhIHF1ZXJ5LiBUaGlzIGJ1ZyBkb2VzIG5vdAoJLy8gaGFwcGVuIG9uIGlQYWQuCgoJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgoJCS8vIENoZWNrIHRoZSB3aW5kb3cgd2lkdGggYW5kIGhlaWdodCB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24KCQkvLyBvZiB0aGUgZGV2aWNlIGlzIGF0IHRoaXMgbW9tZW50LiBOb3RlIHRoYXQgd2UndmUgaW5pdGlhbGl6ZWQgdGhlIHBvcnRyYWl0IG1hcAoJCS8vIHZhbHVlcyB0byAwIGFuZCAxODAsICpBTkQqIHdlIHB1cnBvc2VseSBjaGVjayBmb3IgbGFuZHNjYXBlIHNvIHRoYXQgaWYgd2UgZ3Vlc3MKCQkvLyB3cm9uZywgLCB3ZSBkZWZhdWx0IHRvIHRoZSBhc3N1bXB0aW9uIHRoYXQgcG9ydHJhaXQgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24uCgkJLy8gV2UgdXNlIGEgdGhyZXNob2xkIGNoZWNrIGJlbG93IGJlY2F1c2Ugb24gc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MsIHRoZSBpUGhvbmUKCQkvLyBmb3JtLWZhY3RvciBjYW4gcmVwb3J0IGEgbGFyZ2VyIHdpZHRoIHRoYW4gaGVpZ2h0IGlmIHRoZSB1c2VyIHR1cm5zIG9uIHRoZQoJCS8vIGRldmVsb3BlciBjb25zb2xlLiBUaGUgYWN0dWFsIHRocmVzaG9sZCB2YWx1ZSBpcyBzb21ld2hhdCBhcmJpdHJhcnksIHdlIGp1c3QKCQkvLyBuZWVkIHRvIG1ha2Ugc3VyZSBpdCBpcyBsYXJnZSBlbm91Z2ggdG8gZXhjbHVkZSB0aGUgZGV2ZWxvcGVyIGNvbnNvbGUgY2FzZS4KCgkJdmFyIHd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgJCggd2luZG93ICkud2lkdGgoKSwKCQkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJCggd2luZG93ICkuaGVpZ2h0KCksCgkJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgoJCS8vIE5vdyBjaGVjayB0byBzZWUgaWYgdGhlIGN1cnJlbnQgd2luZG93Lm9yaWVudGF0aW9uIGlzIDAgb3IgMTgwLgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgoJCS8vIElmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIGxhbmRzY2FwZSwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDAgb3IgMTgwLCAqT1IqCgkJLy8gaWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgcG9ydHJhaXQsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyA5MCBvciAtOTAsIHdlCgkJLy8gbmVlZCB0byBmbGlwIG91ciBwb3J0cmFpdF9tYXAgdmFsdWVzIGJlY2F1c2UgbGFuZHNjYXBlIGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGZvcgoJCS8vIHRoaXMgZGV2aWNlL2Jyb3dzZXIuCgkJaWYgKCAoIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmIGluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApIHx8ICggIWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlICYmICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSApIHsKCQkJcG9ydHJhaXRfbWFwID0geyAiLTkwIjogdHJ1ZSwgIjkwIjogdHJ1ZSB9OwoJCX0KCX0KCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSBzcGVjaWFsX2V2ZW50ID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKXsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfTsKCgkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgdGhpcyBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8KCS8vIHRoZSB3aW5kb3cgcmVzaXplIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCWZ1bmN0aW9uIGhhbmRsZXIoKSB7CgkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uLgoJCXZhciBvcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQlpZiAoIG9yaWVudGF0aW9uICE9PSBsYXN0X29yaWVudGF0aW9uICkgewoJCQkvLyBUaGUgb3JpZW50YXRpb24gaGFzIGNoYW5nZWQsIHNvIHRyaWdnZXIgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJCQlsYXN0X29yaWVudGF0aW9uID0gb3JpZW50YXRpb247CgkJCXdpbi50cmlnZ2VyKCAib3JpZW50YXRpb25jaGFuZ2UiICk7CgkJfQoJfQoKCS8vIEdldCB0aGUgY3VycmVudCBwYWdlIG9yaWVudGF0aW9uLiBUaGlzIG1ldGhvZCBpcyBleHBvc2VkIHB1YmxpY2x5LCBzaG91bGQgaXQKCS8vIGJlIG5lZWRlZCwgYXMgalF1ZXJ5LmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24oKQoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIGlzUG9ydHJhaXQgPSB0cnVlLCBlbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQkvLyBwcmVmZXIgd2luZG93IG9yaWVudGF0aW9uIHRvIHRoZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBzY3JlZW5zaXplIGFzCgkJLy8gdGhlIGFjdHVhbCBzY3JlZW4gcmVzaXplIHRha2VzIHBsYWNlIGJlZm9yZSBvciBhZnRlciB0aGUgb3JpZW50YXRpb24gY2hhbmdlIGV2ZW50CgkJLy8gaGFzIGJlZW4gZmlyZWQgZGVwZW5kaW5nIG9uIGltcGxlbWVudGF0aW9uIChlZyBhbmRyb2lkIDIuMyBpcyBiZWZvcmUsIGlwaG9uZSBhZnRlcikuCgkJLy8gTW9yZSB0ZXN0aW5nIGlzIHJlcXVpcmVkIHRvIGRldGVybWluZSBpZiBhIG1vcmUgcmVsaWFibGUgbWV0aG9kIG9mIGRldGVybWluaW5nIHRoZSBuZXcgc2NyZWVuc2l6ZQoJCS8vIGlzIHBvc3NpYmxlIHdoZW4gb3JpZW50YXRpb25jaGFuZ2UgaXMgZmlyZWQuIChlZywgdXNlIG1lZGlhIHF1ZXJpZXMgKyBlbGVtZW50ICsgb3BhY2l0eSkKCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCQkJLy8gaWYgdGhlIHdpbmRvdyBvcmllbnRhdGlvbiByZWdpc3RlcnMgYXMgMCBvciAxODAgZGVncmVlcyByZXBvcnQKCQkJLy8gcG9ydHJhaXQsIG90aGVyd2lzZSBsYW5kc2NhcGUKCQkJaXNQb3J0cmFpdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgkJfSBlbHNlIHsKCQkJaXNQb3J0cmFpdCA9IGVsZW0gJiYgZWxlbS5jbGllbnRXaWR0aCAvIGVsZW0uY2xpZW50SGVpZ2h0IDwgMS4xOwoJCX0KCgkJcmV0dXJuIGlzUG9ydHJhaXQgPyAicG9ydHJhaXQiIDogImxhbmRzY2FwZSI7Cgl9OwoKfSkoIGpRdWVyeSwgd2luZG93ICk7CgoKLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAooZnVuY3Rpb24oKSB7CgoJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCl7CgkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJfQoJfTsKCgl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJfSBlbHNlIHsKCgkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCX0KCgkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJfQoJCX0sCgkJbGFzdENhbGwgPSAwLAoJCWhlbGRDYWxsLAoJCWN1cnIsCgkJZGlmZjsKfSkoKTsKCgokLmVhY2goewoJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCXRhcGhvbGQ6ICJ0YXAiLAoJc3dpcGVsZWZ0OiAic3dpcGUiLAoJc3dpcGVyaWdodDogInN3aXBlIgp9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCSQuZXZlbnQuc3BlY2lhbFsgZXZlbnQgXSA9IHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogImMiLAoJCWRvbUNhY2hlOiBmYWxzZSwKCQlrZWVwTmF0aXZlRGVmYXVsdDogIjpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJLy8gaWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYoIHNlbGYuX3RyaWdnZXIoICJiZWZvcmVjcmVhdGUiICkgPT09IGZhbHNlICl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXNlbGYuZWxlbWVudAoJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJLmFkZENsYXNzKCAidWktcGFnZSB1aS1ib2R5LSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKQoJCQkuYmluZCggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oKXsKCQkJCXNlbGYucmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCgpOwoJCQl9ICkKCQkJLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCl7CgkJCQlzZWxmLnNldENvbnRhaW5lckJhY2tncm91bmQoKTsKCQkJfSApOwoKCX0sCgkKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCl7CgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQucGFyZW50KCkgKSApOwoJfSwKCQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKXsKCQlpZiggdGhpcy5vcHRpb25zLnRoZW1lICl7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyAoIHRoZW1lIHx8IHRoaXMub3B0aW9ucy50aGVtZSApICk7CgkJfQoJfSwKCglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlRGVmaW5lZCA9IG9wdGlvbnMua2VlcE5hdGl2ZSAmJiAkLnRyaW0ob3B0aW9ucy5rZWVwTmF0aXZlKTsKCgkJaWYoIGtlZXBOYXRpdmVEZWZpbmVkICYmIG9wdGlvbnMua2VlcE5hdGl2ZSAhPT0gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdCApewoJCQlyZXR1cm4gW29wdGlvbnMua2VlcE5hdGl2ZSwgb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdF0uam9pbigiLCAiKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0OwoJfQp9KTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgp2YXIgY3JlYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCBzZXF1ZW50aWFsICl7CgkKCS8vIERlZmF1bHQgdG8gc2VxdWVudGlhbAoJaWYoIHNlcXVlbnRpYWwgPT09IHVuZGVmaW5lZCApewoJCXNlcXVlbnRpYWwgPSB0cnVlOwoJfQoJCglyZXR1cm4gZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20gKSB7CgoJCXZhciBkZWZlcnJlZCA9IG5ldyAkLkRlZmVycmVkKCksCgkJCXJldmVyc2VDbGFzcyA9IHJldmVyc2UgPyAiIHJldmVyc2UiIDogIiIsCgkJCWFjdGl2ZQk9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCksCgkJCXRvU2Nyb2xsID0gYWN0aXZlLmxhc3RTY3JvbGwgfHwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwsCgkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQltYXhUcmFuc2l0aW9uT3ZlcnJpZGUgPSAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGggIT09IGZhbHNlICYmICQoIHdpbmRvdyApLndpZHRoKCkgPiAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGgsCgkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8IG1heFRyYW5zaXRpb25PdmVycmlkZSB8fCAhbmFtZSB8fCBuYW1lID09PSAibm9uZSIsCgkJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MgPSBmdW5jdGlvbigpewoJCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci50b2dnbGVDbGFzcyggInVpLW1vYmlsZS12aWV3cG9ydC10cmFuc2l0aW9uaW5nIHZpZXdwb3J0LSIgKyBuYW1lICk7CgkJCX0sCgkJCXNjcm9sbFBhZ2UgPSBmdW5jdGlvbigpewoJCQkJLy8gQnkgdXNpbmcgc2Nyb2xsVG8gaW5zdGVhZCBvZiBzaWxlbnRTY3JvbGwsIHdlIGNhbiBrZWVwIHRoaW5ncyBiZXR0ZXIgaW4gb3JkZXIKCQkJCS8vIEp1c3QgdG8gYmUgcHJlY2F1dGlvcywgZGlzYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgkJCQkKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdG9TY3JvbGwgKTsKCQkJCQoJCQkJLy8gcmVlbmFibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJCX0sIDE1MCApOwoJCQl9LAoJCQljbGVhbkZyb20gPSBmdW5jdGlvbigpewoJCQkJJGZyb20KCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgb3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgkJCX0sCgkJCXN0YXJ0T3V0ID0gZnVuY3Rpb24oKXsKCQkJCS8vIGlmIGl0J3Mgbm90IHNlcXVlbnRpYWwsIGNhbGwgdGhlIGRvbmVPdXQgdHJhbnNpdGlvbiB0byBzdGFydCB0aGUgVE8gcGFnZSBhbmltYXRpbmcgaW4gc2ltdWx0YW5lb3VzbHkKCQkJCWlmKCAhc2VxdWVudGlhbCApewoJCQkJCWRvbmVPdXQoKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCSRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCBkb25lT3V0ICk7CQoJCQkJfQoJCQkJCgkJCQkvLyBTZXQgdGhlIGZyb20gcGFnZSdzIGhlaWdodCBhbmQgc3RhcnQgaXQgdHJhbnNpdGlvbmluZyBvdXQKCQkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCQkkZnJvbQoJCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQod2luZG93ICkuc2Nyb2xsVG9wKCkgKQoJCQkJCS5hZGRDbGFzcyggbmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCQl9LAoJCQkKCQkJZG9uZU91dCA9IGZ1bmN0aW9uKCkgewoKCQkJCWlmICggJGZyb20gJiYgc2VxdWVudGlhbCApIHsKCQkJCQljbGVhbkZyb20oKTsKCQkJCX0KCQkJCQoJCQkJc3RhcnRJbigpOwoJCQl9LAoJCQkKCQkJc3RhcnRJbiA9IGZ1bmN0aW9uKCl7CQoJCQkKCQkJCSR0by5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICk7CQkJCQoJCQkKCQkJCS8vIFNlbmQgZm9jdXMgdG8gcGFnZSBhcyBpdCBpcyBub3cgZGlzcGxheTogYmxvY2sKCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggJHRvICk7CgoJCQkJLy8gU2V0IHRvIHBhZ2UgaGVpZ2h0CgkJCQkkdG8uaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyB0b1Njcm9sbCApOwoJCQkJCgkJCQlzY3JvbGxQYWdlKCk7CgkJCQkKCQkJCWlmKCAhbm9uZSApewoJCQkJCSR0by5hbmltYXRpb25Db21wbGV0ZSggZG9uZUluICk7CgkJCQl9CgkJCQkKCQkJCSR0by5hZGRDbGFzcyggbmFtZSArICIgaW4iICsgcmV2ZXJzZUNsYXNzICk7CgkJCQkKCQkJCWlmKCBub25lICl7CgkJCQkJZG9uZUluKCk7CgkJCQl9CgkJCQkKCQkJfSwKCQkKCQkJZG9uZUluID0gZnVuY3Rpb24oKSB7CgkJCQoJCQkJaWYgKCAhc2VxdWVudGlhbCApIHsKCQkJCQkKCQkJCQlpZiggJGZyb20gKXsKCQkJCQkJY2xlYW5Gcm9tKCk7CgkJCQkJfQoJCQkJfQoJCQkKCQkJCSR0bwoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCBpbiByZXZlcnNlICIgKyBuYW1lICkKCQkJCQkuaGVpZ2h0KCAiIiApOwoJCQkJCgkJCQl0b2dnbGVWaWV3cG9ydENsYXNzKCk7CgkJCQkKCQkJCS8vIEluIHNvbWUgYnJvd3NlcnMgKGlPUzUpLCAzRCB0cmFuc2l0aW9ucyBibG9jayB0aGUgYWJpbGl0eSB0byBzY3JvbGwgdG8gdGhlIGRlc2lyZWQgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXRpb24KCQkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCQlpZiggJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgIT09IHRvU2Nyb2xsICl7CgkJCQkJc2Nyb2xsUGFnZSgpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlc29sdmUoIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIHRydWUgKTsKCQkJfTsKCgkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoJCgkJaWYgKCAkZnJvbSAmJiAhbm9uZSApIHsKCQkJc3RhcnRPdXQoKTsKCQl9CgkJZWxzZSB7CgkJCWRvbmVPdXQoKTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9Owp9CgovLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKdmFyIHNlcXVlbnRpYWxIYW5kbGVyID0gY3JlYXRlSGFuZGxlcigpLAoJc2ltdWx0YW5lb3VzSGFuZGxlciA9IGNyZWF0ZUhhbmRsZXIoIGZhbHNlICk7CgovLyBNYWtlIG91ciB0cmFuc2l0aW9uIGhhbmRsZXIgdGhlIHB1YmxpYyBkZWZhdWx0LgokLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSBzZXF1ZW50aWFsSGFuZGxlcjsKCi8vdHJhbnNpdGlvbiBoYW5kbGVyIGRpY3Rpb25hcnkgZm9yIDNyZCBwYXJ0eSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMgPSB7CgkiZGVmYXVsdCI6ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCSJzZXF1ZW50aWFsIjogc2VxdWVudGlhbEhhbmRsZXIsCgkic2ltdWx0YW5lb3VzIjogc2ltdWx0YW5lb3VzSGFuZGxlcgp9OwoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcyA9IHt9OwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgl2YXIgJHdpbmRvdyA9ICQoIHdpbmRvdyApLAoJCSRodG1sID0gJCggJ2h0bWwnICksCgkJJGhlYWQgPSAkKCAnaGVhZCcgKSwKCgkJLy91cmwgcGF0aCBoZWxwZXJzIGZvciB1c2UgaW4gcmVsYXRpdmUgdXJsIG1hbmFnZW1lbnQKCQlwYXRoID0gewoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQl2YXIgYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXSwKCQkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJICAgIC8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCSAgICAvLyBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0ucmVwbGFjZSggL14jLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCBkb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCQl9CgkJCQlyZXR1cm4gYWJzVXJsOwoJCQl9LAoKCQkJLy9nZXQgcGF0aCBmcm9tIGN1cnJlbnQgaGFzaCwgb3IgZnJvbSBhIGZpbGUgcGF0aAoJCQlnZXQ6IGZ1bmN0aW9uKCBuZXdQYXRoICkgewoJCQkJaWYoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gbG9jYXRpb24uaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgJycgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICcmJyArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IGRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBkb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkJLy8gZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoL14jLykudGVzdCggdS5ocmVmICk7CgkJCX0KCQl9LAoKCQkvL3dpbGwgYmUgZGVmaW5lZCB3aGVuIGEgbGluayBpcyBjbGlja2VkIGFuZCBnaXZlbiBhbiBhY3RpdmUgY2xhc3MKCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsLAoKCQkvL3VybEhpc3RvcnkgaXMgcHVyZWx5IGhlcmUgdG8gbWFrZSBndWVzc2VzIGF0IHdoZXRoZXIgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gd2FzIGNsaWNrZWQKCQkvL2FuZCBwcm92aWRlIGFuIGFwcHJvcHJpYXRlIHRyYW5zaXRpb24KCQl1cmxIaXN0b3J5ID0gewoJCQkvLyBBcnJheSBvZiBwYWdlcyB0aGF0IGFyZSB2aXNpdGVkIGR1cmluZyBhIHNpbmdsZSBwYWdlIGxvYWQuCgkJCS8vIEVhY2ggaGFzIGEgdXJsIGFuZCBvcHRpb25hbCB0cmFuc2l0aW9uLCB0aXRsZSwgYW5kIHBhZ2VVcmwgKHdoaWNoIHJlcHJlc2VudHMgdGhlIGZpbGUgcGF0aCwgaW4gY2FzZXMgd2hlcmUgVVJMIGlzIG9ic2N1cmVkLCBzdWNoIGFzIGRpYWxvZ3MpCgkJCXN0YWNrOiBbXSwKCgkJCS8vbWFpbnRhaW4gYW4gaW5kZXggbnVtYmVyIGZvciB0aGUgYWN0aXZlIHBhZ2UgaW4gdGhlIHN0YWNrCgkJCWFjdGl2ZUluZGV4OiAwLAoKCQkJLy9nZXQgYWN0aXZlCgkJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdXJsSGlzdG9yeS5zdGFja1sgdXJsSGlzdG9yeS5hY3RpdmVJbmRleCBdOwoJCQl9LAoKCQkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdXJsSGlzdG9yeS5zdGFja1sgdXJsSGlzdG9yeS5hY3RpdmVJbmRleCAtIDEgXTsKCQkJfSwKCgkJCWdldE5leHQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggKyAxIF07CgkJCX0sCgoJCQkvLyBhZGROZXcgaXMgdXNlZCB3aGVuZXZlciBhIG5ldyBwYWdlIGlzIGFkZGVkCgkJCWFkZE5ldzogZnVuY3Rpb24oIHVybCwgdHJhbnNpdGlvbiwgdGl0bGUsIHBhZ2VVcmwsIHJvbGUgKSB7CgkJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCQlpZiggdXJsSGlzdG9yeS5nZXROZXh0KCkgKSB7CgkJCQkJdXJsSGlzdG9yeS5jbGVhckZvcndhcmQoKTsKCQkJCX0KCgkJCQl1cmxIaXN0b3J5LnN0YWNrLnB1c2goIHt1cmwgOiB1cmwsIHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHRpdGxlOiB0aXRsZSwgcGFnZVVybDogcGFnZVVybCwgcm9sZTogcm9sZSB9ICk7CgoJCQkJdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9IHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoIC0gMTsKCQkJfSwKCgkJCS8vd2lwZSB1cmxzIGFoZWFkIG9mIGFjdGl2ZSBpbmRleAoJCQljbGVhckZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQkJdXJsSGlzdG9yeS5zdGFjayA9IHVybEhpc3Rvcnkuc3RhY2suc2xpY2UoIDAsIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggKyAxICk7CgkJCX0sCgoJCQlkaXJlY3RIYXNoQ2hhbmdlOiBmdW5jdGlvbiggb3B0cyApIHsKCQkJCXZhciBiYWNrICwgZm9yd2FyZCwgbmV3QWN0aXZlSW5kZXgsIHByZXYgPSB0aGlzLmdldEFjdGl2ZSgpOwoKCQkJCS8vIGNoZWNrIGlmIHVybCBpc3AgaW4gaGlzdG9yeSBhbmQgaWYgaXQncyBhaGVhZCBvciBiZWhpbmQgY3VycmVudCBwYWdlCgkJCQkkLmVhY2goIHVybEhpc3Rvcnkuc3RhY2ssIGZ1bmN0aW9uKCBpLCBoaXN0b3J5RW50cnkgKSB7CgoJCQkJCS8vaWYgdGhlIHVybCBpcyBpbiB0aGUgc3RhY2ssIGl0J3MgYSBmb3J3YXJkIG9yIGEgYmFjawoJCQkJCWlmKCBvcHRzLmN1cnJlbnRVcmwgPT09IGhpc3RvcnlFbnRyeS51cmwgKSB7CgkJCQkJCS8vZGVmaW5lIGJhY2sgYW5kIGZvcndhcmQgYnkgd2hldGhlciB1cmwgaXMgb2xkZXIgb3IgbmV3ZXIgdGhhbiBjdXJyZW50IHBhZ2UKCQkJCQkJYmFjayA9IGkgPCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4OwoJCQkJCQlmb3J3YXJkID0gIWJhY2s7CgkJCQkJCW5ld0FjdGl2ZUluZGV4ID0gaTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBzYXZlIG5ldyBwYWdlIGluZGV4LCBudWxsIGNoZWNrIHRvIHByZXZlbnQgZmFsc2V5IDAgcmVzdWx0CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXggIT09IHVuZGVmaW5lZCA/IG5ld0FjdGl2ZUluZGV4IDogdGhpcy5hY3RpdmVJbmRleDsKCgkJCQlpZiggYmFjayApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNCYWNrICkoIHRydWUgKTsKCQkJCX0gZWxzZSBpZiggZm9yd2FyZCApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNGb3J3YXJkICkoIGZhbHNlICk7CgkJCQl9CgkJCX0sCgoJCQkvL2Rpc2FibGUgaGFzaGNoYW5nZSBldmVudCBsaXN0ZW5lciBpbnRlcm5hbGx5IHRvIGlnbm9yZSBvbmUgY2hhbmdlCgkJCS8vdG9nZ2xlZCBpbnRlcm5hbGx5IHdoZW4gbG9jYXRpb24uaGFzaCBpcyB1cGRhdGVkIHRvIG1hdGNoIHRoZSB1cmwgb2YgYSBzdWNjZXNzZnVsIHBhZ2UgbG9hZAoJCQlpZ25vcmVOZXh0SGFzaENoYW5nZTogZmFsc2UKCQl9LAoKCQkvL2RlZmluZSBmaXJzdCBzZWxlY3RvciB0byByZWNlaXZlIGZvY3VzIHdoZW4gYSBwYWdlIGlzIHNob3duCgkJZm9jdXNhYmxlID0gIlt0YWJpbmRleF0sYSxidXR0b246dmlzaWJsZSxzZWxlY3Q6dmlzaWJsZSxpbnB1dCIsCgoJCS8vcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJCXBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy9pbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2UsCgoJCS8vbm9uc2Vuc2UgaGFzaCBjaGFuZ2Uga2V5IGZvciBkaWFsb2dzLCBzbyB0aGV5IGNyZWF0ZSBhIGhpc3RvcnkgZW50cnkKCQlkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciLAoKCQkvL2V4aXN0aW5nIGJhc2UgdGFnPwoJCSRiYXNlID0gJGhlYWQuY2hpbGRyZW4oICJiYXNlIiApLAoKCQkvL3R1Y2sgYXdheSB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgVVJMIG1pbnVzIGFueSBmcmFnbWVudC4KCQlkb2N1bWVudFVybCA9IHBhdGgucGFyc2VVcmwoIGxvY2F0aW9uLmhyZWYgKSwKCgkJLy9pZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGVtYmVkZGVkIGJhc2UgdGFnLCBkb2N1bWVudEJhc2UgaXMgc2V0IHRvIGl0cwoJCS8vaW5pdGlhbCB2YWx1ZS4gSWYgYSBiYXNlIHRhZyBkb2VzIG5vdCBleGlzdCwgdGhlbiB3ZSBkZWZhdWx0IHRvIHRoZSBkb2N1bWVudFVybC4KCQlkb2N1bWVudEJhc2UgPSAkYmFzZS5sZW5ndGggPyBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGJhc2UuYXR0ciggImhyZWYiICksIGRvY3VtZW50VXJsLmhyZWYgKSApIDogZG9jdW1lbnRVcmwsCgoJCS8vY2FjaGUgdGhlIGNvbXBhcmlzb24gb25jZS4KCQlkb2N1bWVudEJhc2VEaWZmZXJzID0gKCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICE9PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApOwoKCQkvL2Jhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCQl2YXIgYmFzZSA9ICQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyA/IHsKCgkJCS8vZGVmaW5lIGJhc2UgZWxlbWVudCwgZm9yIHVzZSBpbiByb3V0aW5nIGFzc2V0IHVybHMgdGhhdCBhcmUgcmVmZXJlbmNlZCBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQkJZWxlbWVudDogKCAkYmFzZS5sZW5ndGggPyAkYmFzZSA6ICQoICI8YmFzZT4iLCB7IGhyZWY6IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoIH0gKS5wcmVwZW5kVG8oICRoZWFkICkgKSwKCgkJCS8vc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiBhdHRyaWJ1dGUgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBocmVmICkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwgcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGRvY3VtZW50QmFzZSApICk7CgkJCX0sCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwgZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKTsKCQkJfQoKCQl9IDogdW5kZWZpbmVkOwoKLyoKCWludGVybmFsIHV0aWxpdHkgZnVuY3Rpb25zCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy9kaXJlY3QgZm9jdXMgdG8gdGhlIHBhZ2UgdGl0bGUsIG9yIG90aGVyd2lzZSBmaXJzdCBmb2N1c2FibGUgZWxlbWVudAoJJC5tb2JpbGUuZm9jdXNQYWdlID0gZnVuY3Rpb24gKCBwYWdlICkgewoJCXZhciBhdXRvZm9jdXMgPSBwYWdlLmZpbmQoIlthdXRvZm9jdXNdIiksCgkJCXBhZ2VUaXRsZSA9IHBhZ2UuZmluZCggIi51aS10aXRsZTplcSgwKSIgKTsKCgkJaWYoIGF1dG9mb2N1cy5sZW5ndGggKSB7CgkJCWF1dG9mb2N1cy5mb2N1cygpOwoJCQlyZXR1cm47CgkJfQoKCQlpZiggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfQoJCWVsc2V7CgkJCXBhZ2UuZm9jdXMoKTsKCQl9Cgl9CgoJLy9yZW1vdmUgYWN0aXZlIGNsYXNzZXMgYWZ0ZXIgcGFnZSB0cmFuc2l0aW9uIG9yIGVycm9yCglmdW5jdGlvbiByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIGZvcmNlUmVtb3ZhbCApIHsKCQlpZiggISEkYWN0aXZlQ2xpY2tlZExpbmsgJiYgKCAhJGFjdGl2ZUNsaWNrZWRMaW5rLmNsb3Nlc3QoICcudWktcGFnZS1hY3RpdmUnICkubGVuZ3RoIHx8IGZvcmNlUmVtb3ZhbCApICkgewoJCQkkYWN0aXZlQ2xpY2tlZExpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfQoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGw7Cgl9CgoJZnVuY3Rpb24gcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpIHsKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJaWYoIHBhZ2VUcmFuc2l0aW9uUXVldWUubGVuZ3RoID4gMCApIHsKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZS5hcHBseSggbnVsbCwgcGFnZVRyYW5zaXRpb25RdWV1ZS5wb3AoKSApOwoJCX0KCX0KCgkvLyBTYXZlIHRoZSBsYXN0IHNjcm9sbCBkaXN0YW5jZSBwZXIgcGFnZSwgYmVmb3JlIGl0IGlzIGhpZGRlbgoJdmFyIHNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZSwKCQlzZXRMYXN0U2Nyb2xsLCBkZWxheWVkU2V0TGFzdFNjcm9sbDsKCglzZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbiB0aGUgYnJvd3NlcgoJCS8vIHNjcm9sbGluZyB0aGUgd2luZG93IGJhc2VkIG9uIGEgaGFzaGNoYW5nZQoJCWlmKCAhc2V0TGFzdFNjcm9sbEVuYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQlpZiggYWN0aXZlICkgewoJCQl2YXIgbGFzdFNjcm9sbCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCQkvLyBTZXQgYWN0aXZlIHBhZ2UncyBsYXN0U2Nyb2xsIHByb3AuCgkJCS8vIElmIHRoZSBsb2NhdGlvbiB3ZSdyZSBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJYWN0aXZlLmxhc3RTY3JvbGwgPSBsYXN0U2Nyb2xsIDwgJC5tb2JpbGUubWluU2Nyb2xsQmFjayA/ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsIDogbGFzdFNjcm9sbDsKCQl9Cgl9OwoKCS8vIGJpbmQgdG8gc2Nyb2xsc3RvcCB0byBnYXRoZXIgc2Nyb2xsIHBvc2l0aW9uLiBUaGUgZGVsYXkgYWxsb3dzIGZvciB0aGUgaGFzaGNoYW5nZQoJLy8gZXZlbnQgdG8gZmlyZSBhbmQgZGlzYWJsZSBzY3JvbGwgcmVjb3JkaW5nIGluIHRoZSBjYXNlIHdoZXJlIHRoZSBicm93c2VyIHNjcm9sbHMKCS8vIHRvIHRoZSBoYXNoIHRhcmdldHMgbG9jYXRpb24gKHNvbWV0aW1lcyB0aGUgdG9wIG9mIHRoZSBwYWdlKS4gb25jZSBwYWdlY2hhbmdlIGZpcmVzCgkvLyBnZXRMYXN0U2Nyb2xsIGlzIGFnYWluIHBlcm1pdHRlZCB0byBvcGVyYXRlCglkZWxheWVkU2V0TGFzdFNjcm9sbCA9IGZ1bmN0aW9uKCkgewoJCXNldFRpbWVvdXQoIHNldExhc3RTY3JvbGwsIDEwMCApOwoJfTsKCgkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLCB0aGlzIG9ubHkgd29ya3MKCS8vIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uIGlzIGRlbGF5ZWQgZm9yIDEwMG1zIGFmdGVyCgkvLyB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlIHBvc2l0aW9uIGJlY2F1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UKCSR3aW5kb3cuYmluZCggJC5zdXBwb3J0LnB1c2hTdGF0ZSA/ICJwb3BzdGF0ZSIgOiAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJIAlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJfSk7CgoJLy8gaGFuZGxlIGluaXRpYWwgaGFzaGNoYW5nZSBmcm9tIGNocm9tZSA6KAoJJHdpbmRvdy5vbmUoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7Cgl9KTsKCgkvLyB3YWl0IHVudGlsIHRoZSBtb2JpbGUgcGFnZSBjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCB0byBiaW5kIHRvIHBhZ2VjaGFuZ2UKCSR3aW5kb3cub25lKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIsIGZ1bmN0aW9uKCl7CgkJLy8gb25jZSB0aGUgcGFnZSBoYXMgY2hhbmdlZCwgcmUtZW5hYmxlIHRoZSBzY3JvbGwgcmVjb3JkaW5nCgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5iaW5kKCAicGFnZWNoYW5nZSIsIGZ1bmN0aW9uKCkgewoKCSAJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQgZGV0ZXJtaW5lZCBmb3IKCQkJLy8gdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJJHdpbmRvdy51bmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkJCS8vIGRldGVybWluZSBhbmQgYmluZCB0byB0aGUgY3VycmVudCBzY29sbCBlbGVtZW50IHdoaWNoIG1heSBiZSB0aGUgd2luZG93CgkJCS8vIG9yIGluIHRoZSBjYXNlIG9mIHRvdWNoIG92ZXJmbG93IHRoZSBlbGVtZW50IHdpdGggdG91Y2ggb3ZlcmZsb3cKCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgkJfSk7Cgl9KTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlIGFzICJwYWdlY2hhbmdlIiB3b24ndCBiZSBmaXJlZCBpbiB0aGF0IGNhc2UKCSR3aW5kb3cuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCS8vZnVuY3Rpb24gZm9yIHRyYW5zaXRpb25pbmcgYmV0d2VlbiB0d28gZXhpc3RpbmcgcGFnZXMKCWZ1bmN0aW9uIHRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgdHJhbnNpdGlvbiwgcmV2ZXJzZSApIHsKCgkJaWYoIGZyb21QYWdlICkgewoJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJZnJvbVBhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJiZWZvcmVoaWRlIiwgbnVsbCwgeyBuZXh0UGFnZTogdG9QYWdlIH0gKTsKCQl9CgoJCXRvUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZXNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCgkJLy9jbGVhciBwYWdlIGxvYWRlcgoJCSQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZygpOwoJCQoJCS8vIElmIHRyYW5zaXRpb24gaXMgZGVmaW5lZCwgY2hlY2sgaWYgY3NzIDNEIHRyYW5zZm9ybXMgYXJlIHN1cHBvcnRlZCwgYW5kIGlmIG5vdCwgaWYgYSBmYWxsYmFjayBpcyBzcGVjaWZpZWQKCQlpZiggdHJhbnNpdGlvbiAmJiAhJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXSApewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrc1sgdHJhbnNpdGlvbiBdOwoJCX0KCQkKCQkvL2ZpbmQgdGhlIHRyYW5zaXRpb24gaGFuZGxlciBmb3IgdGhlIHNwZWNpZmllZCB0cmFuc2l0aW9uLiBJZiB0aGVyZQoJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkvL2NhbGwgdGhlIGhhbmRsZXIgaW1tZWRpYXRlbHkgdG8ga2ljay1vZmYgdGhlIHRyYW5zaXRpb24uCgkJdmFyIHRoID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIHx8ICJkZWZhdWx0IiBdIHx8ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCQkJcHJvbWlzZSA9IHRoKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0b1BhZ2UsIGZyb21QYWdlICk7CgoJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCgkJCS8vdHJpZ2dlciBzaG93L2hpZGUgZXZlbnRzCgkJCWlmKCBmcm9tUGFnZSApIHsKCQkJCWZyb21QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAiaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJCX0KCgkJCS8vdHJpZ2dlciBwYWdlc2hvdywgZGVmaW5lIHByZXZQYWdlIGFzIGVpdGhlciBmcm9tUGFnZSBvciBlbXB0eSBqUXVlcnkgb2JqCgkJCXRvUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggInNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCQl9KTsKCgkJcmV0dXJuIHByb21pc2U7Cgl9CgoJLy9zaW1wbHkgc2V0IHRoZSBhY3RpdmUgcGFnZSdzIG1pbmltdW0gaGVpZ2h0IHRvIHNjcmVlbiBoZWlnaHQsIGRlcGVuZGluZyBvbiBvcmllbnRhdGlvbgoJZnVuY3Rpb24gZ2V0U2NyZWVuSGVpZ2h0KCl7CgkJLy8gTmF0aXZlIGlubmVySGVpZ2h0IHJldHVybnMgbW9yZSBhY2N1cmF0ZSB2YWx1ZSBmb3IgdGhpcyBhY3Jvc3MgcGxhdGZvcm1zLCAKCQkvLyBqUXVlcnkgdmVyc2lvbiBpcyBoZXJlIGFzIGEgbm9ybWFsaXplZCBmYWxsYmFjayBmb3IgcGxhdGZvcm1zIGxpa2UgU3ltYmlhbgoJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJCggd2luZG93ICkuaGVpZ2h0KCk7Cgl9CgoJJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0ID0gZ2V0U2NyZWVuSGVpZ2h0OwoKCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCWZ1bmN0aW9uIHJlc2V0QWN0aXZlUGFnZUhlaWdodCgpewoJCXZhciBhUGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQlhUGFnZVBhZFQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLXRvcCIgKSApLAoJCQlhUGFnZVBhZEIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApOwoJCQkJCgkJYVBhZ2UuY3NzKCAibWluLWhlaWdodCIsIGdldFNjcmVlbkhlaWdodCgpIC0gYVBhZ2VQYWRUIC0gYVBhZ2VQYWRCICk7Cgl9CgoJLy9zaGFyZWQgcGFnZSBlbmhhbmNlbWVudHMKCWZ1bmN0aW9uIGVuaGFuY2VQYWdlKCAkcGFnZSwgcm9sZSApIHsKCQkvLyBJZiBhIHJvbGUgd2FzIHNwZWNpZmllZCwgbWFrZSBzdXJlIHRoZSBkYXRhLXJvbGUgYXR0cmlidXRlCgkJLy8gb24gdGhlIHBhZ2UgZWxlbWVudCBpcyBpbiBzeW5jLgoJCWlmKCByb2xlICkgewoJCQkkcGFnZS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHJvbGUgKTsKCQl9CgoJCS8vcnVuIHBhZ2UgcGx1Z2luCgkJJHBhZ2UucGFnZSgpOwoJfQoKLyogZXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzCSAqLwoKCS8vYW5pbWF0aW9uIGNvbXBsZXRlIGNhbGxiYWNrCgkkLmZuLmFuaW1hdGlvbkNvbXBsZXRlID0gZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCWlmKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgKSB7CgkJCXJldHVybiAkKCB0aGlzICkub25lKCAnd2Via2l0QW5pbWF0aW9uRW5kIGFuaW1hdGlvbmVuZCcsIGNhbGxiYWNrICk7CgkJfQoJCWVsc2V7CgkJCS8vIGRlZmVyIGV4ZWN1dGlvbiBmb3IgY29uc2lzdGVuY3kgYmV0d2VlbiB3ZWJraXQvbm9uIHdlYmtpdAoJCQlzZXRUaW1lb3V0KCBjYWxsYmFjaywgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy9leHBvc2UgcGF0aCBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLnBhdGggPSBwYXRoOwoKCS8vZXhwb3NlIGJhc2Ugb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5iYXNlID0gYmFzZTsKCgkvL2hpc3Rvcnkgc3RhY2sKCSQubW9iaWxlLnVybEhpc3RvcnkgPSB1cmxIaXN0b3J5OwoKCSQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgPSBkaWFsb2dIYXNoS2V5OwoKCgoJLy9lbmFibGUgY3Jvc3MtZG9tYWluIHBhZ2Ugc3VwcG9ydAoJJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzID0gZmFsc2U7CgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwgPSBmdW5jdGlvbihhc1BhcnNlZE9iamVjdCkgewoJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgZG9jdW1lbnRVcmwgKSA6IGRvY3VtZW50VXJsLmhyZWY7Cgl9OwoKCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oYXNQYXJzZWRPYmplY3QpIHsKCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIGRvY3VtZW50QmFzZSApIDogZG9jdW1lbnRCYXNlLmhyZWY7Cgl9OwoKCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSA9IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gJCh0aGlzKTsKCgkJLy8gd2hlbiBkb20gY2FjaGluZyBpcyBub3QgZW5hYmxlZCBvciB0aGUgcGFnZSBpcyBlbWJlZGRlZCBiaW5kIHRvIHJlbW92ZSB0aGUgcGFnZSBvbiBoaWRlCgkJaWYoICFwYWdlLmRhdGEoInBhZ2UiKS5vcHRpb25zLmRvbUNhY2hlCgkJCQkmJiBwYWdlLmlzKCI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiKSApIHsKCgkJCXBhZ2UuYmluZCggJ3BhZ2VoaWRlLnJlbW92ZScsIGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCXByRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2VyZW1vdmUiICk7CgoJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCWlmKCAhcHJFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJCSR0aGlzLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCk7CgkJCQl9CgkJCX0pOwoJCX0KCX07CgoJLy8gTG9hZCBhIHBhZ2UgaW50byB0aGUgRE9NLgoJJC5tb2JpbGUubG9hZFBhZ2UgPSBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJLy8ga25vdyB3aGVuIHRoZSBwYWdlIGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCXZhciBkZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJCS8vIFRoZSBkZWZhdWx0IGxvYWRQYWdlIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5CgkJCS8vIHRoZSBjYWxsZXIuCgkJCXNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgcGFnZSBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCXBhZ2UgPSBudWxsLAoKCQkJLy8gSWYgdGhlIHJlbG9hZFBhZ2Ugb3B0aW9uIGlzIHRydWUsIGFuZCB0aGUgcGFnZSBpcyBhbHJlYWR5CgkJCS8vIGluIHRoZSBET00sIGR1cENhY2hlZFBhZ2Ugd2lsbCBiZSBzZXQgdG8gdGhlIHBhZ2UgZWxlbWVudAoJCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSByZW1vdmVkIGFmdGVyIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUKCQkJLy8gcGFnZSBpcyBsb2FkZWQgb2ZmIHRoZSBuZXR3b3JrLgoJCQlkdXBDYWNoZWRQYWdlID0gbnVsbCwKCgkJCS8vIGRldGVybWluZSB0aGUgY3VycmVudCBiYXNlIHVybAoJCQlmaW5kQmFzZVdpdGhEZWZhdWx0ID0gZnVuY3Rpb24oKXsKCQkJCXZhciBjbG9zZXN0QmFzZSA9ICggJC5tb2JpbGUuYWN0aXZlUGFnZSAmJiBnZXRDbG9zZXN0QmFzZVVybCggJC5tb2JpbGUuYWN0aXZlUGFnZSApICk7CgkJCQlyZXR1cm4gY2xvc2VzdEJhc2UgfHwgZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgkJCX0sCgoJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIHBhc3NlZCBpbnRvIHRoZSBmdW5jdGlvbi4gVGhpcwoJCQkvLyB2ZXJzaW9uIG9mIHRoZSBVUkwgbWF5IGNvbnRhaW4gZGlhbG9nL3N1YnBhZ2UgcGFyYW1zIGluIGl0LgoJCQlhYnNVcmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBmaW5kQmFzZVdpdGhEZWZhdWx0KCkgKTsKCgoJCS8vIElmIHRoZSBjYWxsZXIgcHJvdmlkZWQgZGF0YSwgYW5kIHdlJ3JlIHVzaW5nICJnZXQiIHJlcXVlc3QsCgkJLy8gYXBwZW5kIHRoZSBkYXRhIHRvIHRoZSBVUkwuCgkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJnZXQiICkgewoJCQlhYnNVcmwgPSBwYXRoLmFkZFNlYXJjaFBhcmFtcyggYWJzVXJsLCBzZXR0aW5ncy5kYXRhICk7CgkJCXNldHRpbmdzLmRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQkvLyBJZiB0aGUgY2FsbGVyIGlzIHVzaW5nIGEgInBvc3QiIHJlcXVlc3QsIHJlbG9hZFBhZ2UgbXVzdCBiZSB0cnVlCgkJaWYoICBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJwb3N0IiApewoJCQlzZXR0aW5ncy5yZWxvYWRQYWdlID0gdHJ1ZTsKCQl9CgoJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIG1pbnVzIGFueSBkaWFsb2cvc3VicGFnZSBwYXJhbXMuCgkJCS8vIEluIG90aGVyd29yZHMgdGhlIHJlYWwgVVJMIG9mIHRoZSBwYWdlIHRvIGJlIGxvYWRlZC4KCQl2YXIgZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIGFic1VybCApLAoKCQkJLy8gVGhlIHZlcnNpb24gb2YgdGhlIFVybCBhY3R1YWxseSBzdG9yZWQgaW4gdGhlIGRhdGEtdXJsIGF0dHJpYnV0ZSBvZgoJCQkvLyB0aGUgcGFnZS4gRm9yIGVtYmVkZGVkIHBhZ2VzLCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yIHBhZ2VzCgkJCS8vIHdpdGhpbiB0aGUgc2FtZSBkb21haW4gYXMgdGhlIGRvY3VtZW50IGJhc2UsIGl0IGlzIHRoZSBzaXRlIHJlbGF0aXZlCgkJCS8vIHBhdGguIEZvciBjcm9zcy1kb21haW4gcGFnZXMgKFBob25lIEdhcCBvbmx5KSB0aGUgZW50aXJlIGFic29sdXRlIFVybAoJCQkvLyB1c2VkIHRvIGxvYWQgdGhlIHBhZ2UuCgkJCWRhdGFVcmwgPSBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGFic1VybCApOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiOmpxbURhdGEodXJsPSciICsgZGF0YVVybCArICInKSIgKTsKCgkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkvLyByZWZlcmVuY2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4gSWYgc28sIGl0IG1heSBoYXZlIGJlZW4gZHluYW1pY2FsbHkKCQkvLyBpbmplY3RlZCBieSBhIGRldmVsb3BlciwgaW4gd2hpY2ggY2FzZSBpdCB3b3VsZCBiZSBsYWNraW5nIGEgZGF0YS11cmwKCQkvLyBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCAmJiBkYXRhVXJsICYmICFwYXRoLmlzUGF0aCggZGF0YVVybCApICkgewoJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIiMiICsgZGF0YVVybCApCgkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsIGRhdGFVcmwgKTsKCQl9CgoJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCS8vIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgYXBwbGljYXRpb24uIElmIGl0IGlzbid0IGEgcmVmZXJlbmNlCgkJLy8gdG8gdGhlIGZpcnN0IHBhZ2UgYW5kIHJlZmVycyB0byBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSwgZXJyb3Igb3V0LgoJCWlmICggcGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlICYmIHBhdGguaXNGaXJzdFBhZ2VVcmwoIGZpbGVVcmwgKSApIHsKCQkJCS8vIENoZWNrIHRvIG1ha2Ugc3VyZSBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkKCQkJCS8vIGluIHRoZSBET00uIFNvbWUgdXNlciBkZXBsb3llZCBhcHBzIGFyZSBwcnVuaW5nIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBmcm9tIHRoZSBET00gZm9yIHZhcmlvdXMgcmVhc29ucywgd2UgY2hlY2sgZm9yIHRoaXMKCQkJCS8vIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGggYW4gaWQKCQkJCS8vIGZhbGxpbmcgdGhyb3VnaCB0byB0aGUgbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UgZXJyb3IKCQkJCS8vIGNhc2UuIElmIHRoZSBmaXJzdC1wYWdlIGlzIG5vdCBpbiB0aGUgRE9NLCB0aGVuIHdlIGxldAoJCQkJLy8gdGhpbmdzIGZhbGwgdGhyb3VnaCB0byB0aGUgYWpheCBsb2FkaW5nIGNvZGUgYmVsb3cgc28KCQkJCS8vIHRoYXQgaXQgZ2V0cyByZWxvYWRlZC4KCQkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlLnBhcmVudCgpLmxlbmd0aCApIHsKCQkJCQlwYWdlID0gJCggJC5tb2JpbGUuZmlyc3RQYWdlICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIGZpbGVVcmwgKSAgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCX0KCgkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlLgoJCWlmICggYmFzZSApIHsKCQkJYmFzZS5yZXNldCgpOwoJCX0KCgkJLy8gSWYgdGhlIHBhZ2Ugd2UgYXJlIGludGVyZXN0ZWQgaW4gaXMgYWxyZWFkeSBpbiB0aGUgRE9NLAoJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCS8vIHJlbG9hZCBvZiB0aGUgZmlsZSwgd2UgYXJlIGRvbmUuIE90aGVyd2lzZSwgdHJhY2sgdGhlCgkJLy8gZXhpc3RpbmcgcGFnZSBhcyBhIGR1cGxpY2F0ZWQuCgkJaWYgKCBwYWdlLmxlbmd0aCApIHsKCQkJaWYgKCAhc2V0dGluZ3MucmVsb2FkUGFnZSApIHsKCQkJCWVuaGFuY2VQYWdlKCBwYWdlLCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIG9wdGlvbnMsIHBhZ2UgKTsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQkJZHVwQ2FjaGVkUGFnZSA9IHBhZ2U7CgkJfQoKCQl2YXIgbXBjID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciwKCQkJcGJsRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVsb2FkIiApLAoJCQl0cmlnZ2VyRGF0YSA9IHsgdXJsOiB1cmwsIGFic1VybDogYWJzVXJsLCBkYXRhVXJsOiBkYXRhVXJsLCBkZWZlcnJlZDogZGVmZXJyZWQsIG9wdGlvbnM6IHNldHRpbmdzIH07CgoJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBsb2FkIGEgcGFnZS4KCQltcGMudHJpZ2dlciggcGJsRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCWlmKCBwYmxFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCX0KCgkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCS8vIFRoaXMgY29uZmlndXJhYmxlIHRpbWVvdXQgYWxsb3dzIGNhY2hlZCBwYWdlcyBhIGJyaWVmIGRlbGF5IHRvIGxvYWQgd2l0aG91dCBzaG93aW5nIGEgbWVzc2FnZQoJCQl2YXIgbG9hZE1zZ0RlbGF5ID0gc2V0VGltZW91dChmdW5jdGlvbigpewoJCQkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZygpOwoJCQkJfSwgc2V0dGluZ3MubG9hZE1zZ0RlbGF5ICksCgoJCQkJLy8gU2hhcmVkIGxvZ2ljIGZvciBjbGVhcmluZyB0aW1lb3V0IGFuZCByZW1vdmluZyBtZXNzYWdlLgoJCQkJaGlkZU1zZyA9IGZ1bmN0aW9uKCl7CgoJCQkJCS8vIFN0b3AgbWVzc2FnZSBzaG93IHRpbWVyCgkJCQkJY2xlYXJUaW1lb3V0KCBsb2FkTXNnRGVsYXkgKTsKCgkJCQkJLy8gSGlkZSBsb2FkaW5nIG1lc3NhZ2UKCQkJCQkkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2coKTsKCQkJCX07CgkJfQoKCQlpZiAoICEoICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyB8fCBwYXRoLmlzU2FtZURvbWFpbiggZG9jdW1lbnRVcmwsIGFic1VybCApICkgKSB7CgkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJfSBlbHNlIHsKCQkJLy8gTG9hZCB0aGUgbmV3IHBhZ2UuCgkJCSQuYWpheCh7CgkJCQl1cmw6IGZpbGVVcmwsCgkJCQl0eXBlOiBzZXR0aW5ncy50eXBlLAoJCQkJZGF0YTogc2V0dGluZ3MuZGF0YSwKCQkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCQlzdWNjZXNzOiBmdW5jdGlvbiggaHRtbCwgdGV4dFN0YXR1cywgeGhyICkgewoJCQkJCS8vcHJlLXBhcnNlIGh0bWwgdG8gY2hlY2sgZm9yIGEgZGF0YS11cmwsCgkJCQkJLy91c2UgaXQgYXMgdGhlIG5ldyBmaWxlVXJsLCBiYXNlIHBhdGgsIGV0YwoJCQkJCXZhciBhbGwgPSAkKCAiPGRpdj48L2Rpdj4iICksCgoJCQkJCQkvL3BhZ2UgdGl0bGUgcmVnZXhwCgkJCQkJCW5ld1BhZ2VUaXRsZSA9IGh0bWwubWF0Y2goIC88dGl0bGVbXj5dKj4oW148XSopLyApICYmIFJlZ0V4cC4kMSwKCgkJCQkJCS8vIFRPRE8gaGFuZGxlIGRpYWxvZ3MgYWdhaW4KCQkJCQkJcGFnZUVsZW1SZWdleCA9IG5ldyBSZWdFeHAoICIoPFtePl0rXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT1bXCInXT9wYWdlW1wiJ10/W14+XSo+KSIgKSwKCQkJCQkJZGF0YVVybFJlZ2V4ID0gbmV3IFJlZ0V4cCggIlxcYmRhdGEtIiArICQubW9iaWxlLm5zICsgInVybD1bXCInXT8oW15cIic+XSopW1wiJ10/IiApOwoKCgkJCQkJLy8gZGF0YS11cmwgbXVzdCBiZSBwcm92aWRlZCBmb3IgdGhlIGJhc2UgdGFnIHNvIHJlc291cmNlIHJlcXVlc3RzIGNhbiBiZSBkaXJlY3RlZCB0byB0aGUKCQkJCQkvLyBjb3JyZWN0IHVybC4gbG9hZGluZyBpbnRvIGEgdGVtcHJvcmFyeSBlbGVtZW50IG1ha2VzIHRoZXNlIHJlcXVlc3RzIGltbWVkaWF0ZWx5CgkJCQkJaWYoIHBhZ2VFbGVtUmVnZXgudGVzdCggaHRtbCApCgkJCQkJCQkmJiBSZWdFeHAuJDEKCQkJCQkJCSYmIGRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKQoJCQkJCQkJJiYgUmVnRXhwLiQxICkgewoJCQkJCQl1cmwgPSBmaWxlVXJsID0gcGF0aC5nZXRGaWxlUGF0aCggUmVnRXhwLiQxICk7CgkJCQkJfQoKCQkJCQlpZiAoIGJhc2UgKSB7CgkJCQkJCWJhc2Uuc2V0KCBmaWxlVXJsICk7CgkJCQkJfQoKCQkJCQkvL3dvcmthcm91bmQgdG8gYWxsb3cgc2NyaXB0cyB0byBleGVjdXRlIHdoZW4gaW5jbHVkZWQgaW4gcGFnZSBkaXZzCgkJCQkJYWxsLmdldCggMCApLmlubmVySFRNTCA9IGh0bWw7CgkJCQkJcGFnZSA9IGFsbC5maW5kKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maXJzdCgpOwoKCQkJCQkvL2lmIHBhZ2UgZWxlbSBjb3VsZG4ndCBiZSBmb3VuZCwgY3JlYXRlIG9uZSBhbmQgaW5zZXJ0IHRoZSBib2R5IGVsZW1lbnQncyBjb250ZW50cwoJCQkJCWlmKCAhcGFnZS5sZW5ndGggKXsKCQkJCQkJcGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPiIgKyBodG1sLnNwbGl0KCAvPFwvP2JvZHlbXj5dKj4vZ21pIClbMV0gKyAiPC9kaXY+IiApOwoJCQkJCX0KCgkJCQkJaWYgKCBuZXdQYWdlVGl0bGUgJiYgIXBhZ2UuanFtRGF0YSggInRpdGxlIiApICkgewoJCQkJCQlpZiAoIH5uZXdQYWdlVGl0bGUuaW5kZXhPZiggIiYiICkgKSB7CgkJCQkJCQluZXdQYWdlVGl0bGUgPSAkKCAiPGRpdj4iICsgbmV3UGFnZVRpdGxlICsgIjwvZGl2PiIgKS50ZXh0KCk7CgkJCQkJCX0KCQkJCQkJcGFnZS5qcW1EYXRhKCAidGl0bGUiLCBuZXdQYWdlVGl0bGUgKTsKCQkJCQl9CgoJCQkJCS8vcmV3cml0ZSBzcmMgYW5kIGhyZWYgYXR0cnMgdG8gdXNlIGEgYmFzZSB1cmwKCQkJCQlpZiggISQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyApIHsKCQkJCQkJdmFyIG5ld1BhdGggPSBwYXRoLmdldCggZmlsZVVybCApOwoJCQkJCQlwYWdlLmZpbmQoICJbc3JjXSwgbGlua1tocmVmXSwgYVtyZWw9J2V4dGVybmFsJ10sIDpqcW1EYXRhKGFqYXg9J2ZhbHNlJyksIGFbdGFyZ2V0XSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCQkJdmFyIHRoaXNBdHRyID0gJCggdGhpcyApLmlzKCAnW2hyZWZdJyApID8gJ2hyZWYnIDoKCQkJCQkJCQkJJCh0aGlzKS5pcygnW3NyY10nKSA/ICdzcmMnIDogJ2FjdGlvbicsCgkJCQkJCQkJdGhpc1VybCA9ICQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciApOwoKCQkJCQkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBmaXggdGhpcyBzbyB0aGF0IGl0IHJlbW92ZXMgdGhlIGRvY3VtZW50CgkJCQkJCQkvLyAgICAgICAgICAgIGJhc2UgVVJMLCBhbmQgdGhlbiBwcmVwZW5kcyB3aXRoIHRoZSBuZXcgcGFnZSBVUkwuCgkJCQkJCQkvL2lmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSwgJycgKTsKCgkJCQkJCQlpZiggIS9eKFx3Kzp8I3xcLykvLnRlc3QoIHRoaXNVcmwgKSApIHsKCQkJCQkJCQkkKCB0aGlzICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCX0KCgkJCQkJLy9hcHBlbmQgdG8gcGFnZSBhbmQgZW5oYW5jZQoJCQkJCS8vIFRPRE8gdGFnaW5nIGEgcGFnZSB3aXRoIGV4dGVybmFsIHRvIG1ha2Ugc3VyZSB0aGF0IGVtYmVkZGVkIHBhZ2VzIGFyZW4ndCByZW1vdmVkCgkJCQkJLy8gICAgICBieSB0aGUgdmFyaW91cyBwYWdlIGhhbmRsaW5nIGNvZGUgaXMgYmFkLiBIYXZpbmcgcGFnZSBoYW5kbGluZyBjb2RlIGluIG1hbnkKCQkJCQkvLyAgICAgIHBsYWNlcyBpcyBiYWQuIFNvbHV0aW9ucyBwb3N0IDEuMAoJCQkJCXBhZ2UKCQkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGZpbGVVcmwgKSApCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZXh0ZXJuYWwtcGFnZSIsIHRydWUgKQoJCQkJCQkuYXBwZW5kVG8oIHNldHRpbmdzLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJLy8gd2FpdCBmb3IgcGFnZSBjcmVhdGlvbiB0byBsZXZlcmFnZSBvcHRpb25zIGRlZmluZWQgb24gd2lkZ2V0CgkJCQkJcGFnZS5vbmUoICdwYWdlY3JlYXRlJywgJC5tb2JpbGUuX2JpbmRQYWdlUmVtb3ZlICk7CgoJCQkJCWVuaGFuY2VQYWdlKCBwYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCQkJCS8vIEVuaGFuY2luZyB0aGUgcGFnZSBtYXkgcmVzdWx0IGluIG5ldyBkaWFsb2dzL3N1YiBwYWdlcyBiZWluZyBpbnNlcnRlZAoJCQkJCS8vIGludG8gdGhlIERPTS4gSWYgdGhlIG9yaWdpbmFsIGFic1VybCByZWZlcnMgdG8gYSBzdWItcGFnZSwgdGhhdCBpcyB0aGUKCQkJCQkvLyByZWFsIHBhZ2Ugd2UgYXJlIGludGVyZXN0ZWQgaW4uCgkJCQkJaWYgKCBhYnNVcmwuaW5kZXhPZiggIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSApID4gLTEgKSB7CgkJCQkJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiOmpxbURhdGEodXJsPSciICsgZGF0YVVybCArICInKSIgKTsKCQkJCQl9CgoJCQkJCS8vYmluZCBwYWdlSGlkZSB0byByZW1vdmVQYWdlIGFmdGVyIGl0J3MgaGlkZGVuLCBpZiB0aGUgcGFnZSBvcHRpb25zIHNwZWNpZnkgdG8gZG8gc28KCgkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCQloaWRlTXNnKCk7CgkJCQkJfQoKCQkJCQkvLyBBZGQgdGhlIHBhZ2UgcmVmZXJlbmNlIGFuZCB4aHIgdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCQl0cmlnZ2VyRGF0YS5wYWdlID0gcGFnZTsKCgkJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBwYWdlIGxvYWRlZCBzdWNjZXNzZnVsbHkuCgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCAicGFnZWxvYWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIG9wdGlvbnMsIHBhZ2UsIGR1cENhY2hlZFBhZ2UgKTsKCQkJCX0sCgkJCQllcnJvcjogZnVuY3Rpb24oIHhociwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24gKSB7CgkJCQkJLy9zZXQgYmFzZSBiYWNrIHRvIGN1cnJlbnQgcGF0aAoJCQkJCWlmKCBiYXNlICkgewoJCQkJCQliYXNlLnNldCggcGF0aC5nZXQoKSApOwoJCQkJCX0KCgkJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJCXRyaWdnZXJEYXRhLnhociA9IHhocjsKCQkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCQkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCQl2YXIgcGxmRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2Vsb2FkZmFpbGVkIiApOwoKCQkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgdGhlIHBhZ2UgbG9hZCBmYWlsZWQuCgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCBwbGZFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJCS8vIGRlZmVycmVkIG9iamVjdCB3aXRoaW4gdGhlIHRyaWdnZXJEYXRhLgoJCQkJCWlmKCBwbGZFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgoJCQkJCQkvLyBSZW1vdmUgbG9hZGluZyBtZXNzYWdlLgoJCQkJCQloaWRlTXNnKCk7CgoJCQkJCQkvLyBzaG93IGVycm9yIG1lc3NhZ2UKCQkJCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lLCAkLm1vYmlsZS5wYWdlTG9hZEVycm9yTWVzc2FnZSwgdHJ1ZSApOwoKCQkJCQkJLy8gaGlkZSBhZnRlciBkZWxheQoJCQkJCQlzZXRUaW1lb3V0KCAkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2csIDE1MDAgKTsKCQkJCQl9CgoJCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX07CgoJJC5tb2JpbGUubG9hZFBhZ2UuZGVmYXVsdHMgPSB7CgkJdHlwZTogImdldCIsCgkJZGF0YTogdW5kZWZpbmVkLAoJCXJlbG9hZFBhZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCXNob3dMb2FkTXNnOiBmYWxzZSwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJbG9hZE1zZ0RlbGF5OiA1MCAvLyBUaGlzIGRlbGF5IGFsbG93cyBsb2FkcyB0aGF0IHB1bGwgZnJvbSBicm93c2VyIGNhY2hlIHRvIG9jY3VyIHdpdGhvdXQgc2hvd2luZyB0aGUgbG9hZGluZyBtZXNzYWdlLgoJfTsKCgkvLyBTaG93IGEgc3BlY2lmaWMgcGFnZSBpbiB0aGUgcGFnZSBjb250YWluZXIuCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvUGFnZSwgb3B0aW9ucyApIHsKCQkvLyBJZiB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGEgdHJhbnNpdGlvbiwgcXVldWUgdGhlIGN1cnJlbnQgcmVxdWVzdC4KCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uIHRvCgkJLy8gc2VydmljZSB0aGUgcmVxdWVzdC4KCQlpZiggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICk7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgcGFnZUNvbnRhaW5lciB0byB3b3JrIHdpdGguCgkJc2V0dGluZ3MucGFnZUNvbnRhaW5lciA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBmcm9tUGFnZS4KCQlzZXR0aW5ncy5mcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlIHx8ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHRvUGFnZTogdG9QYWdlLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBiY0V2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiggcGJjRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvUGFnZSBpbiB0aGUgdHJpZ2dlcgoJCS8vIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0b1BhZ2UgaXMgdXBkYXRlZC4KCgkJdG9QYWdlID0gdHJpZ2dlckRhdGEudG9QYWdlOwoKCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCS8vIG9yIHRyYW5zaXRpb25pbmcuCgoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJLy8gdG8gbWFrZSBzdXJlIGl0IGlzIGxvYWRlZCBpbnRvIHRoZSBET00uIFdlJ2xsIGxpc3RlbgoJCS8vIHRvIHRoZSBwcm9taXNlIG9iamVjdCBpdCByZXR1cm5zIHNvIHdlIGtub3cgd2hlbgoJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCWlmICggdHlwZW9mIHRvUGFnZSA9PSAic3RyaW5nIiApIHsKCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHRvUGFnZSwgc2V0dGluZ3MgKQoJCQkJLmRvbmUoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgbmV3UGFnZSwgZHVwQ2FjaGVkUGFnZSApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQkJb3B0aW9ucy5kdXBsaWNhdGVDYWNoZWRQYWdlID0gZHVwQ2FjaGVkUGFnZTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBuZXdQYWdlLCBvcHRpb25zICk7CgkJCQl9KQoJCQkJLmZhaWwoZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgoJCQkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgoJCQkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2VjaGFuZ2VmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoJCQkJfSk7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZmlyc3QtcGFnZSBvZiB0aGUgYXBwbGljYXRpb24sIHdlIG5lZWQgdG8gbWFrZQoJCS8vIHN1cmUgc2V0dGluZ3MuZGF0YVVybCBpcyBzZXQgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVybC4gVGhpcyBhbGxvd3MKCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkvLyBmaXJzdC1wYWdlIG9mIHRoZSBkb2N1bWVudCBoYXMgYW4gaWQgYXR0cmlidXRlIHNwZWNpZmllZC4KCQlpZiAoIHRvUGFnZVsgMCBdID09PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSAmJiAhc2V0dGluZ3MuZGF0YVVybCApIHsKCQkJc2V0dGluZ3MuZGF0YVVybCA9IGRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJfQoKCQkvLyBUaGUgY2FsbGVyIHBhc3NlZCB1cyBhIHJlYWwgcGFnZSBET00gZWxlbWVudC4gVXBkYXRlIG91cgoJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCXZhciBmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlLAoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBzZXR0aW5ncy5kYXRhVXJsICkgKSB8fCB0b1BhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQgYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmwsCgkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCB1cmwgKSwKCQkJYWN0aXZlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9IHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAsCgkJCWhpc3RvcnlEaXIgPSAwLAoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZSwKCQkJaXNEaWFsb2cgPSBzZXR0aW5ncy5yb2xlID09PSAiZGlhbG9nIiB8fCB0b1BhZ2UuanFtRGF0YSggInJvbGUiICkgPT09ICJkaWFsb2ciOwoKCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50IG1hbnVhbGx5L2R5bmFtaWNhbGx5CgkJLy8gYW5kIHJldXNlIHBhZ2VzIHdhbnQgdG8gYmUgYWJsZSB0byB0cmFuc2l0aW9uIHRvIHRoZSBzYW1lIHBhZ2UuIFRvIGFsbG93CgkJLy8gdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0IHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uCgkJLy8gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbiBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLgoJCS8vIEl0IHNob3VsZCBiZSBub3RlZCB0aGF0IG91ciBkZWZhdWx0IHRyYW5zaXRpb24gYW5pbWF0aW9ucyBhc3N1bWUgdGhhdCB0aGUKCQkvLyBmb3JtUGFnZSBhbmQgdG9QYWdlIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuCgkJLy8gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uCgkJLy8gdG8gZWl0aGVyIHR1cm4gb2ZmIHRyYW5zaXRpb24gYW5pbWF0aW9ucywgb3IgbWFrZSBzdXJlIHRoYXQgYW4gYXBwcm9wcmlhdGUKCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCWlmKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmICFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFnZSB3ZSBhcmUgZ2l2ZW4gaGFzIGFscmVhZHkgYmVlbiBlbmhhbmNlZC4KCQllbmhhbmNlUGFnZSggdG9QYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCS8vIElmIHRoZSBjaGFuZ2VQYWdlIHJlcXVlc3Qgd2FzIHNlbnQgZnJvbSBhIGhhc2hDaGFuZ2UgZXZlbnQsIGNoZWNrIHRvIHNlZSBpZiB0aGUKCQkvLyBwYWdlIGlzIGFscmVhZHkgd2l0aGluIHRoZSB1cmxIaXN0b3J5IHN0YWNrLiBJZiBzbywgd2UnbGwgYXNzdW1lIHRoZSB1c2VyIGhpdAoJCS8vIHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUgdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQlpZiggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQljdXJyZW50VXJsOgl1cmwsCgkJCQlpc0JhY2s6CQlmdW5jdGlvbigpIHsgaGlzdG9yeURpciA9IC0xOyB9LAoJCQkJaXNGb3J3YXJkOglmdW5jdGlvbigpIHsgaGlzdG9yeURpciA9IDE7IH0KCQkJfSk7CgkJfQoKCQkvLyBLaWxsIHRoZSBrZXlib2FyZC4KCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gc3RvcCBjcmF3bGluZyB0aGUgZW50aXJlIGRvY3VtZW50IHRvIGtpbGwgZm9jdXMuIEluc3RlYWQsCgkJLy8gICAgICAgICAgICB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkgaGFuZGxlciBzbyB3ZSBhbHJlYWR5IGhhdmUKCQkvLyAgICAgICAgICAgIHRoZSBlbGVtZW50IGluIGhhbmQgYXQgdGhpcyBwb2ludC4KCQkvLyBXcmFwIHRoaXMgaW4gYSB0cnkvY2F0Y2ggYmxvY2sgc2luY2UgSUU5IHRocm93ICJVbnNwZWNpZmllZCBlcnJvciIgaWYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudAoJCS8vIGlzIHVuZGVmaW5lZCB3aGVuIHdlIGFyZSBpbiBhbiBJRnJhbWUuCgkJdHJ5IHsKCQkJaWYoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiBkb2N1bWVudC5hY3RpdmVFbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT0gJ2JvZHknKSB7CgkJCQkkKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpLmJsdXIoKTsKCQkJfSBlbHNlIHsKCQkJCSQoICJpbnB1dDpmb2N1cywgdGV4dGFyZWE6Zm9jdXMsIHNlbGVjdDpmb2N1cyIgKS5ibHVyKCk7CgkJCX0KCQl9IGNhdGNoKGUpIHt9CgoJCS8vIElmIHdlJ3JlIGRpc3BsYXlpbmcgdGhlIHBhZ2UgYXMgYSBkaWFsb2csIHdlIGRvbid0IHdhbnQgdGhlIHVybAoJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCS8vIHRvIGFwcGVuZCB0aGUgZGlhbG9nSGFzaEtleSB0byB0aGUgdXJsIG9mIHRoZSBjdXJyZW50IHBhZ2UuCgkJaWYgKCBpc0RpYWxvZyAmJiBhY3RpdmUgKSB7CgkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlIHNob3VsZAoJCQkvLyBiZSBhbiBlbXB0eSBzdHJpbmcuIE1vdmluZyB0aGUgdW5kZWZpbmVkIC0+IGVtcHR5IHN0cmluZyBiYWNrIGludG8KCQkJLy8gdXJsSGlzdG9yeS5hZGROZXcgc2VlbWVkIGltcHJ1ZGVudCBnaXZlbiB1bmRlZmluZWQgYmV0dGVyIHJlcHJlc2VudHMKCQkJLy8gdGhlIHVybCBzdGF0ZQoJCQl1cmwgPSAoIGFjdGl2ZS51cmwgfHwgIiIgKSArIGRpYWxvZ0hhc2hLZXk7CgkJfQoKCQkvLyBTZXQgdGhlIGxvY2F0aW9uIGhhc2guCgkJaWYoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmIHVybCApIHsKCQkJLy9kaXNhYmxlIGhhc2ggbGlzdGVuaW5nIHRlbXBvcmFyaWx5CgkJCXVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSB0cnVlOwoJCQkvL3VwZGF0ZSBoYXNoIGFuZCBoaXN0b3J5CgkJCXBhdGguc2V0KCB1cmwgKTsKCQl9CgoJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QgdXNlIHBhZ2VUaXRsZQoJCXZhciBuZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKT8gcGFnZVRpdGxlIDogdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSB8fCB0b1BhZ2UuY2hpbGRyZW4oIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIikuZmluZCgiLnVpLXRpdGxlIiApLmdldEVuY29kZWRUZXh0KCk7CgkJaWYoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PSBkb2N1bWVudC50aXRsZSApIHsKCQkJcGFnZVRpdGxlID0gbmV3UGFnZVRpdGxlOwoJCX0KCQlpZiAoICF0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApICkgewoJCQl0b1BhZ2UuanFtRGF0YSggInRpdGxlIiwgcGFnZVRpdGxlICk7CgkJfQoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHRyYW5zaXRpb24gZGVmaW5lZC4KCQlzZXR0aW5ncy50cmFuc2l0aW9uID0gc2V0dGluZ3MudHJhbnNpdGlvbgoJCQl8fCAoICggaGlzdG9yeURpciAmJiAhYWN0aXZlSXNJbml0aWFsUGFnZSApID8gYWN0aXZlLnRyYW5zaXRpb24gOiB1bmRlZmluZWQgKQoJCQl8fCAoIGlzRGlhbG9nID8gJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gOiAkLm1vYmlsZS5kZWZhdWx0UGFnZVRyYW5zaXRpb24gKTsKCgkJLy9hZGQgcGFnZSB0byBoaXN0b3J5IHN0YWNrIGlmIGl0J3Mgbm90IGJhY2sgb3IgZm9yd2FyZAoJCWlmKCAhaGlzdG9yeURpciApIHsKCQkJdXJsSGlzdG9yeS5hZGROZXcoIHVybCwgc2V0dGluZ3MudHJhbnNpdGlvbiwgcGFnZVRpdGxlLCBwYWdlVXJsLCBzZXR0aW5ncy5yb2xlICk7CgkJfQoKCQkvL3NldCBwYWdlIHRpdGxlCgkJZG9jdW1lbnQudGl0bGUgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnRpdGxlOwoKCQkvL3NldCAidG9QYWdlIiBhcyBhY3RpdmVQYWdlCgkJJC5tb2JpbGUuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJLy8gSWYgd2UncmUgbmF2aWdhdGluZyBiYWNrIGluIHRoZSBVUkwgaGlzdG9yeSwgc2V0IHJldmVyc2UgYWNjb3JkaW5nbHkuCgkJc2V0dGluZ3MucmV2ZXJzZSA9IHNldHRpbmdzLnJldmVyc2UgfHwgaGlzdG9yeURpciA8IDA7CgoJCXRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgc2V0dGluZ3MudHJhbnNpdGlvbiwgc2V0dGluZ3MucmV2ZXJzZSApCgkJCS5kb25lKGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tLCBhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcygpOwoKCQkJCS8vaWYgdGhlcmUncyBhIGR1cGxpY2F0ZUNhY2hlZFBhZ2UsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gbm93IHRoYXQgaXQncyBoaWRkZW4KCQkJCWlmICggc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZSApIHsKCQkJCQlzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlLnJlbW92ZSgpOwoJCQkJfQoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gdGhlIG5ld2x5IHNob3duIHBhZ2UuIE1vdmVkIGZyb20gcHJvbWlzZSAuZG9uZSBiaW5kaW5nIGluIHRyYW5zaXRpb25QYWdlcwoJCQkJLy8gaXRzZWxmIHRvIGF2b2lkIGllIGJ1ZyB0aGF0IHJlcG9ydHMgb2Zmc2V0V2lkdGggYXMgPiAwIChjb3JlIGNoZWNrIGZvciB2aXNpYmlsaXR5KQoJCQkJLy8gZGVzcGl0ZSB2aXNpYmlsaXR5OiBoaWRkZW4gYWRkcmVzc2VzIGlzc3VlICMyOTY1CgkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzI5NjUKCQkJCWlmKCAhYWxyZWFkeUZvY3VzZWQgKXsKCQkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoIHRvUGFnZSApOwoJCQkJfQoKCQkJCXJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKTsKCgkJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWxsIGRvbmUgY2hhbmdpbmcgdGhlIGN1cnJlbnQgcGFnZS4KCQkJCW1wYy50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgkJCX0pOwoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzID0gewoJCXRyYW5zaXRpb246IHVuZGVmaW5lZCwKCQlyZXZlcnNlOiBmYWxzZSwKCQljaGFuZ2VIYXNoOiB0cnVlLAoJCWZyb21IYXNoQ2hhbmdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlkdXBsaWNhdGVDYWNoZWRQYWdlOiB1bmRlZmluZWQsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCXNob3dMb2FkTXNnOiB0cnVlLCAvL2xvYWRpbmcgbWVzc2FnZSBzaG93cyBieSBkZWZhdWx0IHdoZW4gcGFnZXMgYXJlIGJlaW5nIGZldGNoZWQgZHVyaW5nIGNoYW5nZVBhZ2UKCQlkYXRhVXJsOiB1bmRlZmluZWQsCgkJZnJvbVBhZ2U6IHVuZGVmaW5lZCwKCQlhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbjogZmFsc2UKCX07CgovKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCgl7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCS8vIExvb2sgZm9yIHRoZSBjbG9zZXN0IGVsZW1lbnQgd2l0aCBhIG5vZGVOYW1lIG9mICJhIi4KCQkJLy8gTm90ZSB0aGF0IHdlIGFyZSBjaGVja2luZyBpZiB3ZSBoYXZlIGEgdmFsaWQgbm9kZU5hbWUKCQkJLy8gYmVmb3JlIGF0dGVtcHRpbmcgdG8gYWNjZXNzIGl0LiBUaGlzIGlzIGJlY2F1c2UgdGhlCgkJCS8vIG5vZGUgd2UgZ2V0IGNhbGxlZCB3aXRoIGNvdWxkIGhhdmUgb3JpZ2luYXRlZCBmcm9tIHdpdGhpbgoJCQkvLyBhbiBlbWJlZGRlZCBTVkcgZG9jdW1lbnQgd2hlcmUgc29tZSBzeW1ib2wgaW5zdGFuY2UgZWxlbWVudHMKCQkJLy8gZG9uJ3QgaGF2ZSBub2RlTmFtZSBkZWZpbmVkIG9uIHRoZW0sIG9yIHN0cmluZ3MgYXJlIG9mIHR5cGUKCQkJLy8gU1ZHQW5pbWF0ZWRTdHJpbmcuCgkJCWlmICggKCB0eXBlb2YgZWxlLm5vZGVOYW1lID09PSAic3RyaW5nIiApICYmIGVsZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCS8vIFRoZSBiYXNlIFVSTCBmb3IgYW55IGdpdmVuIGVsZW1lbnQgZGVwZW5kcyBvbiB0aGUgcGFnZSBpdCByZXNpZGVzIGluLgoJZnVuY3Rpb24gZ2V0Q2xvc2VzdEJhc2VVcmwoIGVsZSApCgl7CgkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYWdlIGFuZCBleHRyYWN0IG91dCBpdHMgdXJsLgoJCXZhciB1cmwgPSAkKCBlbGUgKS5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuanFtRGF0YSggInVybCIgKSwKCQkJYmFzZSA9IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoKCQlpZiAoICF1cmwgfHwgIXBhdGguaXNQYXRoKCB1cmwgKSApIHsKCQkJdXJsID0gYmFzZTsKCQl9CgoJCXJldHVybiBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBiYXNlKTsKCX0KCgoJLy9UaGUgZm9sbG93aW5nIGV2ZW50IGJpbmRpbmdzIHNob3VsZCBiZSBib3VuZCBhZnRlciBtb2JpbGVpbml0IGhhcyBiZWVuIHRyaWdnZXJlZAoJLy90aGUgZm9sbG93aW5nIGZ1bmN0aW9uIGlzIGNhbGxlZCBpbiB0aGUgaW5pdCBmaWxlCgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uKCl7CgoJCS8vYmluZCB0byBmb3JtIHN1Ym1pdCBldmVudHMsIGhhbmRsZSB3aXRoIEFqYXgKCQkkKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiZm9ybSIsICJzdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgdGhlIGZvcm0gaXMsIGl0c2VsZiwgYWpheCBmYWxzZQoJCQkJCSR0aGlzLmlzKCI6anFtRGF0YShhamF4PSdmYWxzZScpIikgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IGFuZAoJCQkJCS8vIHRoZSBmb3JtIG9yIG9uZSBvZiBpdCdzIHBhcmVudHMgaXMgYWpheD1mYWxzZQoJCQkJCSEkdGhpcy5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgdHlwZSA9ICR0aGlzLmF0dHIoICJtZXRob2QiICksCgkJCQl0YXJnZXQgPSAkdGhpcy5hdHRyKCAidGFyZ2V0IiApLAoJCQkJdXJsID0gJHRoaXMuYXR0ciggImFjdGlvbiIgKTsKCgkJCS8vIElmIG5vIGFjdGlvbiBpcyBzcGVjaWZpZWQsIGJyb3dzZXJzIGRlZmF1bHQgdG8gdXNpbmcgdGhlCgkJCS8vIFVSTCBvZiB0aGUgZG9jdW1lbnQgY29udGFpbmluZyB0aGUgZm9ybS4gU2luY2Ugd2UgZHluYW1pY2FsbHkKCQkJLy8gcHVsbCBpbiBwYWdlcyBmcm9tIGV4dGVybmFsIGRvY3VtZW50cywgdGhlIGZvcm0gc2hvdWxkIHN1Ym1pdAoJCQkvLyB0byB0aGUgVVJMIGZvciB0aGUgc291cmNlIGRvY3VtZW50IG9mIHRoZSBwYWdlIGNvbnRhaW5pbmcKCQkJLy8gdGhlIGZvcm0uCgkJCWlmICggIXVybCApIHsKCQkJCS8vIEdldCB0aGUgQGRhdGEtdXJsIGZvciB0aGUgcGFnZSBjb250YWluaW5nIHRoZSBmb3JtLgoJCQkJdXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICR0aGlzICk7CgkJCQlpZiAoIHVybCA9PT0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSB7CgkJCQkJLy8gVGhlIHVybCB3ZSBnb3QgYmFjayBtYXRjaGVzIHRoZSBkb2N1bWVudCBiYXNlLAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoZSBwYWdlIG11c3QgYmUgYW4gaW50ZXJuYWwvZW1iZWRkZWQgcGFnZSwKCQkJCQkvLyBzbyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBhY3R1YWwgZG9jdW1lbnQgdXJsIGFzIGEgYnJvd3NlcgoJCQkJCS8vIHdvdWxkLgoJCQkJCXVybCA9IGRvY3VtZW50VXJsLmhyZWZOb1NlYXJjaDsKCQkJCX0KCQkJfQoKCQkJdXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICB1cmwsIGdldENsb3Nlc3RCYXNlVXJsKCR0aGlzKSApOwoKCQkJLy9leHRlcm5hbCBzdWJtaXRzIHVzZSByZWd1bGFyIEhUVFAKCQkJaWYoIHBhdGguaXNFeHRlcm5hbCggdXJsICkgfHwgdGFyZ2V0ICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKAoJCQkJdXJsLAoJCQkJewoJCQkJCXR5cGU6CQl0eXBlICYmIHR5cGUubGVuZ3RoICYmIHR5cGUudG9Mb3dlckNhc2UoKSB8fCAiZ2V0IiwKCQkJCQlkYXRhOgkJJHRoaXMuc2VyaWFsaXplKCksCgkJCQkJdHJhbnNpdGlvbjoJJHRoaXMuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQkJZGlyZWN0aW9uOgkkdGhpcy5qcW1EYXRhKCAiZGlyZWN0aW9uIiApLAoJCQkJCXJlbG9hZFBhZ2U6CXRydWUKCQkJCX0KCQkJKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQoIGRvY3VtZW50ICkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApOwoKCQkJLy8gc3BsaXQgZnJvbSB0aGUgcHJldmlvdXMgcmV0dXJuIGxvZ2ljIHRvIGF2b2lkIGZpbmQgY2xvc2VzdCB3aGVyZSBwb3NzaWJsZQoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggISQobGluaykuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBsaW5rICkgewoJCQkJaWYgKCBwYXRoLnBhcnNlVXJsKCBsaW5rLmdldEF0dHJpYnV0ZSggImhyZWYiICkgfHwgIiMiICkuaGFzaCAhPT0gIiMiICkgewoJCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoJCQkJCSRhY3RpdmVDbGlja2VkTGluayA9ICQoIGxpbmsgKS5jbG9zZXN0KCAiLnVpLWJ0biIgKS5ub3QoICIudWktZGlzYWJsZWQiICk7CgkJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCSQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgLnVpLWJ0biIgKS5ub3QoIGxpbmsgKS5ibHVyKCk7CgoJCQkJCS8vIEJ5IGNhY2hpbmcgdGhlIGhyZWYgdmFsdWUgdG8gZGF0YSBhbmQgc3dpdGNoaW5nIHRoZSBocmVmIHRvIGEgIywgd2UgY2FuIGF2b2lkIGFkZHJlc3MgYmFyIHNob3dpbmcgaW4gaU9TLiBUaGUgY2xpY2sgaGFuZGxlciByZXNldHMgdGhlIGhyZWYgZHVyaW5nIGl0cyBpbml0aWFsIHN0ZXBzIGlmIHRoaXMgZGF0YSBpcyBwcmVzZW50CgkJCQkJJCggbGluayApCgkJCQkJCS5qcW1EYXRhKCAiaHJlZiIsICQoIGxpbmsgICkuYXR0ciggImhyZWYiICkgICkKCQkJCQkJLmF0dHIoICJocmVmIiwgIiMiICk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJLy8gY2xpY2sgcm91dGluZyAtIGRpcmVjdCB0byBIVFRQIG9yIEFqYXgsIGFjY29yZGluZ2x5CgkJJCggZG9jdW1lbnQgKS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmKCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBsaW5rID0gZmluZENsb3Nlc3RMaW5rKCBldmVudC50YXJnZXQgKSwgJGxpbmsgPSAkKCBsaW5rICksIGh0dHBDbGVhbnVwOwoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggIWxpbmsgfHwgZXZlbnQud2hpY2ggPiAxIHx8ICEkbGluay5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQlodHRwQ2xlYW51cCA9IGZ1bmN0aW9uKCl7CgkJCQl3aW5kb3cuc2V0VGltZW91dCggZnVuY3Rpb24oKSB7IHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOyB9LCAyMDAgKTsKCQkJfTsKCgkJCS8vIElmIHRoZXJlJ3MgZGF0YSBjYWNoZWQgZm9yIHRoZSByZWFsIGhyZWYgdmFsdWUsIHNldCB0aGUgbGluaydzIGhyZWYgYmFjayB0byBpdCBhZ2Fpbi4gVGhpcyBwYWlycyB3aXRoIGFuIGFkZHJlc3MgYmFyIHdvcmthcm91bmQgZnJvbSB0aGUgdmNsaWNrIGhhbmRsZXIKCQkJaWYoICRsaW5rLmpxbURhdGEoICJocmVmIiApICl7CgkJCQkkbGluay5hdHRyKCAiaHJlZiIsICRsaW5rLmpxbURhdGEoICJocmVmIiApICk7CgkJCX0KCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmKCAkbGluay5pcyggIjpqcW1EYXRhKHJlbD0nYmFjaycpIiApICkgewoJCQkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgYmFzZVVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkbGluayApLAoKCQkJCS8vZ2V0IGhyZWYsIGlmIGRlZmluZWQsIG90aGVyd2lzZSBkZWZhdWx0IHRvIGVtcHR5IGhhc2gKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGxpbmsuYXR0ciggImhyZWYiICkgfHwgIiMiLCBiYXNlVXJsICk7CgoJCQkvL2lmIGFqYXggaXMgZGlzYWJsZWQsIGV4aXQgZWFybHkKCQkJaWYoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICl7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPSAtMSApIHsKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJCS8vIFNob3VsZCB3ZSBoYW5kbGUgdGhpcyBsaW5rLCBvciBsZXQgdGhlIGJyb3dzZXIgZGVhbCB3aXRoIGl0PwoJCQl2YXIgdXNlRGVmYXVsdFVybEhhbmRsaW5nID0gJGxpbmsuaXMoICJbcmVsPSdleHRlcm5hbCddIiApIHx8ICRsaW5rLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fCAkbGluay5pcyggIlt0YXJnZXRdIiApLAoKCQkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCQlpc0Nyb3NzRG9tYWluUGFnZUxvYWQgPSAoICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJiBkb2N1bWVudFVybC5wcm90b2NvbCA9PT0gImZpbGU6IiAmJiBocmVmLnNlYXJjaCggL15odHRwcz86LyApICE9IC0xICksCgoJCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJCS8vVE9ETyBvdmVybGFwIGluIGxvZ2ljIGZyb20gaXNFeHRlcm5hbCwgcmVsPWV4dGVybmFsIGNoZWNrIHNob3VsZCBiZQoJCQkJLy8gICAgIG1vdmVkIGludG8gbW9yZSBjb21wcmVoZW5zaXZlIGlzRXh0ZXJuYWxMaW5rCgkJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggcGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgIWlzQ3Jvc3NEb21haW5QYWdlTG9hZCApOwoKCQkJaWYoIGlzRXh0ZXJuYWwgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3VzZSBhamF4CgkJCXZhciB0cmFuc2l0aW9uID0gJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQlkaXJlY3Rpb24gPSAkbGluay5qcW1EYXRhKCAiZGlyZWN0aW9uIiApLAoJCQkJcmV2ZXJzZSA9ICggZGlyZWN0aW9uICYmIGRpcmVjdGlvbiA9PT0gInJldmVyc2UiICkgfHwKCQkJCQkJCS8vIGRlcHJlY2F0ZWQgLSByZW1vdmUgYnkgMS4wCgkJCQkJCQkkbGluay5qcW1EYXRhKCAiYmFjayIgKSwKCgkJCQkvL3RoaXMgbWF5IG5lZWQgdG8gYmUgbW9yZSBzcGVjaWZpYyBhcyB3ZSB1c2UgZGF0YS1yZWwgbW9yZQoJCQkJcm9sZSA9ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfHwgdW5kZWZpbmVkOwoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggaHJlZiwgeyB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCByZXZlcnNlOiByZXZlcnNlLCByb2xlOiByb2xlIH0gKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9wcmVmZXRjaCBwYWdlcyB3aGVuIGFuY2hvcnMgd2l0aCBkYXRhLXByZWZldGNoIGFyZSBlbmNvdW50ZXJlZAoJCSQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICIudWktcGFnZSIsICJwYWdlc2hvdy5wcmVmZXRjaCIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgdXJscyA9IFtdOwoJCQkkKCB0aGlzICkuZmluZCggImE6anFtRGF0YShwcmVmZXRjaCkiICkuZWFjaChmdW5jdGlvbigpewoJCQkJdmFyICRsaW5rID0gJCh0aGlzKSwKCQkJCQl1cmwgPSAkbGluay5hdHRyKCAiaHJlZiIgKTsKCgkJCQlpZiAoIHVybCAmJiAkLmluQXJyYXkoIHVybCwgdXJscyApID09PSAtMSApIHsKCQkJCQl1cmxzLnB1c2goIHVybCApOwoKCQkJCQkkLm1vYmlsZS5sb2FkUGFnZSggdXJsLCB7cm9sZTogJGxpbmsuYXR0cigiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIil9ICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoKCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSA9IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQl2YXIgdG8gPSBwYXRoLnN0cmlwSGFzaCggaGFzaCApLAoJCQkJLy90cmFuc2l0aW9uIGlzIGZhbHNlIGlmIGl0J3MgdGhlIGZpcnN0IHBhZ2UsIHVuZGVmaW5lZCBvdGhlcndpc2UgKGFuZCBtYXkgYmUgb3ZlcnJpZGRlbiBieSBkZWZhdWx0KQoJCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnVybEhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAwID8gIm5vbmUiIDogdW5kZWZpbmVkLAoKCQkJCS8vIGRlZmF1bHQgb3B0aW9ucyBmb3IgdGhlIGNoYW5nUGFnZSBjYWxscyBtYWRlIGFmdGVyIGV4YW1pbmluZyB0aGUgY3VycmVudCBzdGF0ZQoJCQkJLy8gb2YgdGhlIHBhZ2UgYW5kIHRoZSBoYXNoCgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQl0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLAoJCQkJCWNoYW5nZUhhc2g6IGZhbHNlLAoJCQkJCWZyb21IYXNoQ2hhbmdlOiB0cnVlCgkJCQl9OwoKCQkJLy9pZiBsaXN0ZW5pbmcgaXMgZGlzYWJsZWQgKGVpdGhlciBnbG9iYWxseSBvciB0ZW1wb3JhcmlseSksIG9yIGl0J3MgYSBkaWFsb2cgaGFzaAoJCQlpZiggISQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkIHx8IHVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgKSB7CgkJCQl1cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlID0gZmFsc2U7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIHNwZWNpYWwgY2FzZSBmb3IgZGlhbG9ncwoJCQlpZiggdXJsSGlzdG9yeS5zdGFjay5sZW5ndGggPiAxICYmIHRvLmluZGV4T2YoIGRpYWxvZ0hhc2hLZXkgKSA+IC0xICkgewoKCQkJCS8vIElmIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgbm90IGEgZGlhbG9nIHNraXAgdGhlIGRpYWxvZyBhbmQgY29udGludWUKCQkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQkJaWYoISQubW9iaWxlLmFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApKSB7CgkJCQkJLy9kZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZSBhY2NvcmRpbmdseSBwYXN0CgkJCQkJLy90aGUgY3VycmVudCBkaWFsb2cKCQkJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJCQljdXJyZW50VXJsOiB0bywKCQkJCQkJaXNCYWNrOiBmdW5jdGlvbigpIHsgd2luZG93Lmhpc3RvcnkuYmFjaygpOyB9LAoJCQkJCQlpc0ZvcndhcmQ6IGZ1bmN0aW9uKCkgeyB3aW5kb3cuaGlzdG9yeS5mb3J3YXJkKCk7IH0KCQkJCQl9KTsKCgkJCQkJLy8gcHJldmVudCBjaGFuZ2VQYWdlKCkKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgewoJCQkJCS8vIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIGEgZGlhbG9nIGFuZCB3ZSdyZSBuYXZpZ2F0aW5nCgkJCQkJLy8gdG8gYSBkaWFsb2cgdXNlIHRoZSBkaWFsb2cgb2JqZWN0ZWQgc2F2ZWQgaW4gdGhlIHN0YWNrCgkJCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCQkJY3VycmVudFVybDogdG8sCgoJCQkJCQkvLyByZWdhcmRsZXNzIG9mIHRoZSBkaXJlY3Rpb24gb2YgdGhlIGhpc3RvcnkgY2hhbmdlCgkJCQkJCS8vIGRvIHRoZSBmb2xsb3dpbmcKCQkJCQkJZWl0aGVyOiBmdW5jdGlvbiggaXNCYWNrICkgewoJCQkJCQkJdmFyIGFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCk7CgoJCQkJCQkJdG8gPSBhY3RpdmUucGFnZVVybDsKCgkJCQkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSByb2xlLCB0cmFuc2l0aW9uIGFuZCByZXZlcnNhbAoJCQkJCQkJLy8gYXMgbW9zdCBvZiB0aGlzIGlzIGxvc3QgYnkgdGhlIGRvbUNhY2hlIGNsZWFuaW5nCgkJCQkJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIHsKCQkJCQkJCQlyb2xlOiBhY3RpdmUucm9sZSwKCQkJCQkJCQl0cmFuc2l0aW9uOgkgYWN0aXZlLnRyYW5zaXRpb24sCgkJCQkJCQkJcmV2ZXJzZTogaXNCYWNrCgkJCQkJCQl9KTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfQoJCQl9CgoJCQkvL2lmIHRvIGlzIGRlZmluZWQsIGxvYWQgaXQKCQkJaWYgKCB0byApIHsKCQkJCS8vIEF0IHRoaXMgcG9pbnQsICd0bycgY2FuIGJlIG9uZSBvZiAzIHRoaW5ncywgYSBjYWNoZWQgcGFnZSBlbGVtZW50IGZyb20KCQkJCS8vIGEgaGlzdG9yeSBzdGFjayBlbnRyeSwgYW4gaWQsIG9yIHNpdGUtcmVsYXRpdmUvYWJzb2x1dGUgVVJMLiBJZiAndG8nIGlzCgkJCQkvLyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QgdGhlIGRvY3VtZW50QmFzZSwgbm90IHRoZSBsb2NhdGlvbi5ocmVmLAoJCQkJLy8gc2luY2UgdGhlIGhhc2hjaGFuZ2UgY291bGQndmUgYmVlbiB0aGUgcmVzdWx0IG9mIGEgZm9yd2FyZC9iYWNrd2FyZCBuYXZpZ2F0aW9uCgkJCQkvLyB0aGF0IGNyb3NzZXMgZnJvbSBhbiBleHRlcm5hbCBwYWdlL2RpYWxvZyB0byBhbiBpbnRlcm5hbCBwYWdlL2RpYWxvZy4KCQkJCXRvID0gKCB0eXBlb2YgdG8gPT09ICJzdHJpbmciICYmICFwYXRoLmlzUGF0aCggdG8gKSApID8gKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJyMnICsgdG8sIGRvY3VtZW50QmFzZSApICkgOiB0bzsKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIHRvLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCQl9CWVsc2UgewoJCQkJLy90aGVyZSdzIG5vIGhhc2gsIGdvIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBkb20KCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQoJCX07CgoJCS8vaGFzaGNoYW5nZSBldmVudCBoYW5kbGVyCgkJJHdpbmRvdy5iaW5kKCAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCBlLCB0cmlnZ2VyZWQgKSB7CgkJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlKCBsb2NhdGlvbi5oYXNoICk7CgkJfSk7CgoJCS8vc2V0IHBhZ2UgbWluLWhlaWdodHMgdG8gYmUgZGV2aWNlIHNwZWNpZmljCgkJJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZXNob3ciLCByZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCQkkKCB3aW5kb3cgKS5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgcmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgoJfTsvL19yZWdpc3RlckludGVybmFsRXZlbnRzIGNhbGxiYWNrCgp9KSggalF1ZXJ5ICk7CgooIGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyBGb3Igbm93LCBsZXQncyBNb25rZXlwYXRjaCB0aGlzIG9udG8gdGhlIGVuZCBvZiAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cwoJLy8gU2NvcGUgc2VsZiB0byBwdXNoU3RhdGVIYW5kbGVyIHNvIHdlIGNhbiByZWZlcmVuY2UgaXQgc2FuZWx5IHdpdGhpbiB0aGUKCS8vIG1ldGhvZHMgaGFuZGVkIG9mZiBhcyBldmVudCBoYW5kbGVycwoJdmFyCXB1c2hTdGF0ZUhhbmRsZXIgPSB7fSwKCQlzZWxmID0gcHVzaFN0YXRlSGFuZGxlciwKCQkkd2luID0gJCggd2luZG93ICksCgkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggbG9jYXRpb24uaHJlZiApOwoKCSQuZXh0ZW5kKCBwdXNoU3RhdGVIYW5kbGVyLCB7CgkJLy8gVE9ETyBtb3ZlIHRvIGEgcGF0aCBoZWxwZXIsIHRoaXMgaXMgcmF0aGVyIGNvbW1vbiBmdW5jdGlvbmFsaXR5CgkJaW5pdGlhbEZpbGVQYXRoOiAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiB1cmwucGF0aG5hbWUgKyB1cmwuc2VhcmNoOwoJCX0pKCksCgoJCWluaXRpYWxIcmVmOiB1cmwuaHJlZk5vSGFzaCwKCgkJc3RhdGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gewoJCQkJaGFzaDogbG9jYXRpb24uaGFzaCB8fCAiIyIgKyBzZWxmLmluaXRpYWxGaWxlUGF0aCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZSwKCgkJCQkvLyBwZXJzaXN0IGFjcm9zcyByZWZyZXNoCgkJCQlpbml0aWFsSHJlZjogc2VsZi5pbml0aWFsSHJlZgoJCQl9OwoJCX0sCgoJCXJlc2V0VUlLZXlzOiBmdW5jdGlvbiggdXJsICkgewoJCQl2YXIgZGlhbG9nID0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleSwKCQkJCXN1YmtleSA9ICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXksCgkJCQlkaWFsb2dJbmRleCA9IHVybC5pbmRleE9mKCBkaWFsb2cgKTsKCgkJCWlmKCBkaWFsb2dJbmRleCA+IC0xICkgewoJCQkJdXJsID0gdXJsLnNsaWNlKCAwLCBkaWFsb2dJbmRleCApICsgIiMiICsgdXJsLnNsaWNlKCBkaWFsb2dJbmRleCApOwoJCQl9IGVsc2UgaWYoIHVybC5pbmRleE9mKCBzdWJrZXkgKSA+IC0xICkgewoJCQkJdXJsID0gdXJsLnNwbGl0KCBzdWJrZXkgKS5qb2luKCAiIyIgKyBzdWJrZXkgKTsKCQkJfQoKCQkJcmV0dXJuIHVybDsKCQl9LAoKCQloYXNoVmFsdWVBZnRlclJlc2V0OiBmdW5jdGlvbiggdXJsICkgewoJCQl2YXIgcmVzZXRVcmwgPSBzZWxmLnJlc2V0VUlLZXlzKCB1cmwgKTsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGgucGFyc2VVcmwoIHJlc2V0VXJsICkuaGFzaDsKCQl9LAoKCQkvLyBUT0RPIHNvcnQgb3V0IGEgc2luZ2xlIGJhcnJpZXIgdG8gaGFzaGNoYW5nZSBmdW5jdGlvbmFsaXR5CgkJbmV4dEhhc2hDaGFuZ2VQcmV2ZW50ZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJJC5tb2JpbGUudXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSA9IHZhbHVlOwoJCQlzZWxmLm9uSGFzaENoYW5nZURpc2FibGVkID0gdmFsdWU7CgkJfSwKCgkJLy8gb24gaGFzaCBjaGFuZ2Ugd2Ugd2FudCB0byBjbGVhbiB1cCB0aGUgdXJsCgkJLy8gTk9URSB0aGlzIHRha2VzIHBsYWNlICphZnRlciogdGhlIHZhbmlsbGEgbmF2aWdhdGlvbiBoYXNoIGNoYW5nZQoJCS8vIGhhbmRsaW5nIGhhcyB0YWtlbiBwbGFjZSBhbmQgc2V0IHRoZSBzdGF0ZSBvZiB0aGUgRE9NCgkJb25IYXNoQ2hhbmdlOiBmdW5jdGlvbiggZSApIHsKCQkJLy8gZGlzYWJsZSB0aGlzIGhhc2ggY2hhbmdlCgkJCWlmKCBzZWxmLm9uSGFzaENoYW5nZURpc2FibGVkICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBocmVmLCBzdGF0ZSwKCQkJCWhhc2ggPSBsb2NhdGlvbi5oYXNoLAoJCQkJaXNQYXRoID0gJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSwKCQkJCXJlc29sdXRpb25VcmwgPSBpc1BhdGggPyBsb2NhdGlvbi5ocmVmIDogJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwoKTsKCgkJCWhhc2ggPSBpc1BhdGggPyBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6IGhhc2g7CgoKCQkJLy8gcHJvcHVsYXRlIHRoZSBoYXNoIHdoZW4gaXRzIG5vdCBhdmFpbGFibGUKCQkJc3RhdGUgPSBzZWxmLnN0YXRlKCk7CgoJCQkvLyBtYWtlIHRoZSBoYXNoIGFib2x1dGUgd2l0aCB0aGUgY3VycmVudCBocmVmCgkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaGFzaCwgcmVzb2x1dGlvblVybCApOwoKCQkJaWYgKCBpc1BhdGggKSB7CgkJCQlocmVmID0gc2VsZi5yZXNldFVJS2V5cyggaHJlZiApOwoJCQl9CgoJCQkvLyByZXBsYWNlIHRoZSBjdXJyZW50IHVybCB3aXRoIHRoZSBuZXcgaHJlZiBhbmQgc3RvcmUgdGhlIHN0YXRlCgkJCS8vIE5vdGUgdGhhdCBpbiBzb21lIGNhc2VzIHdlIG1pZ2h0IGJlIHJlcGxhY2luZyBhbiB1cmwgd2l0aCB0aGUKCQkJLy8gc2FtZSB1cmwuIFdlIGRvIHRoaXMgYW55d2F5cyBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQKCQkJLy8gYWxsIG9mIG91ciBoaXN0b3J5IGVudHJpZXMgaGF2ZSBhIHN0YXRlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGgKCQkJLy8gdGhlbS4gVGhpcyBhbGxvd3MgdXMgdG8gd29yayBhcm91bmQgdGhlIGNhc2Ugd2hlcmUgd2luZG93Lmhpc3RvcnkuYmFjaygpCgkJCS8vIGlzIGNhbGxlZCB0byB0cmFuc2l0aW9uIGZyb20gYW4gZXh0ZXJuYWwgcGFnZSB0byBhbiBlbWJlZGRlZCBwYWdlLgoJCQkvLyBJbiB0aGF0IHBhcnRpY3VsYXIgY2FzZSwgYSBoYXNoY2hhbmdlIGV2ZW50IGlzICpOT1QqIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4KCQkJLy8gRW5zdXJpbmcgZWFjaCBoaXN0b3J5IGVudHJ5IGhhcyBhIHN0YXRlIG9iamVjdCBtZWFucyB0aGF0IG9uUG9wU3RhdGUoKQoJCQkvLyB3aWxsIGFsd2F5cyB0cmlnZ2VyIG91ciBoYXNoY2hhbmdlIGNhbGxiYWNrIGV2ZW4gd2hlbiBhIGhhc2hjaGFuZ2UgZXZlbnQKCQkJLy8gaXMgbm90IGZpcmVkLgoJCQloaXN0b3J5LnJlcGxhY2VTdGF0ZSggc3RhdGUsIGRvY3VtZW50LnRpdGxlLCBocmVmICk7CgkJfSwKCgkJLy8gb24gcG9wc3RhdGUgKGllIGJhY2sgb3IgZm9yd2FyZCkgd2UgbmVlZCB0byByZXBsYWNlIHRoZSBoYXNoIHRoYXQgd2FzIHRoZXJlIHByZXZpb3VzbHkKCQkvLyBjbGVhbmVkIHVwIGJ5IHRoZSBhZGRpdGlvbmFsIGhhc2ggaGFuZGxpbmcKCQlvblBvcFN0YXRlOiBmdW5jdGlvbiggZSApIHsKCQkJdmFyIHBvcHBlZFN0YXRlID0gZS5vcmlnaW5hbEV2ZW50LnN0YXRlLAoJCQkJdGltZW91dCwgZnJvbUhhc2gsIHRvSGFzaCwgaGFzaENoYW5nZWQ7CgoJCQkvLyBpZiB0aGVyZSdzIG5vIHN0YXRlIGl0cyBub3QgYSBwb3BzdGF0ZSB3ZSBjYXJlIGFib3V0LCBlZyBjaHJvbWUncyBpbml0aWFsIHBvcHN0YXRlCgkJCWlmKCBwb3BwZWRTdGF0ZSApIHsKCQkJCS8vIHRoZSBhY3RpdmUgdXJsIGluIHRoZSBoaXN0b3J5IHN0YWNrIHdpbGwgc3RpbGwgYmUgZnJvbSB0aGUgcHJldmlvdXMgc3RhdGUKCQkJCS8vIHNvIHdlIGNhbiB1c2UgaXQgdG8gdmVyaWZ5IGlmIGEgaGFzaGNoYW5nZSB3aWxsIGJlIGZpcmVkIGZyb20gdGhlIHBvcHN0YXRlCgkJCQlmcm9tSGFzaCA9IHNlbGYuaGFzaFZhbHVlQWZ0ZXJSZXNldCggJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKS51cmwgKTsKCgkJCQkvLyB0aGUgaGFzaCBzdG9yZWQgaW4gdGhlIHN0YXRlIHBvcHBlZCBvZmYgdGhlIHN0YWNrIHdpbGwgYmUgb3VyIGN1cnJlbnR1cmwgb3IKCQkJCS8vIHRoZSB1cmwgdG8gd2hpY2ggd2Ugd2lzaCB0byBuYXZpZ2F0ZQoJCQkJdG9IYXNoID0gc2VsZi5oYXNoVmFsdWVBZnRlclJlc2V0KCBwb3BwZWRTdGF0ZS5oYXNoLnJlcGxhY2UoIiMiLCAiIikgKTsKCgkJCQkvLyBpZiB0aGUgaGFzaGVzIG9mIHRoZSB1cmxzIGFyZSBkaWZmZXJlbnQgd2UgbXVzdCBhc3N1bWUgdGhhdCB0aGUgYnJvd3NlcgoJCQkJLy8gd2lsbCBmaXJlIGEgaGFzaGNoYW5nZQoJCQkJaGFzaENoYW5nZWQgPSBmcm9tSGFzaCAhPT0gdG9IYXNoOwoKCQkJCS8vIHVubG9jayBoYXNoIGhhbmRsaW5nIG9uY2UgdGhlIGhhc2hjaGFuZ2UgY2F1c2VkIGJlIHRoZSBwb3BzdGF0ZSBoYXMgZmlyZWQKCQkJCWlmKCBoYXNoQ2hhbmdlZCApIHsKCQkJCQkkd2luLm9uZSggImhhc2hjaGFuZ2UucHVzaHN0YXRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJCXNlbGYubmV4dEhhc2hDaGFuZ2VQcmV2ZW50ZWQoIGZhbHNlICk7CgkJCQkJfSk7CgkJCQl9CgoJCQkJLy8gZW5hYmxlIGhhc2ggaGFuZGxpbmcgZm9yIHRoZSB0aGUgX2hhbmRsZUhhc2hDaGFuZ2UgY2FsbAoJCQkJc2VsZi5uZXh0SGFzaENoYW5nZVByZXZlbnRlZCggZmFsc2UgKTsKCgkJCQkvLyBjaGFuZ2UgdGhlIHBhZ2UgYmFzZWQgb24gdGhlIGhhc2gKCQkJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlKCBwb3BwZWRTdGF0ZS5oYXNoICk7CgoJCQkJLy8gb25seSBwcmV2ZW50IGFub3RoZXIgaGFzaCBjaGFuZ2UgaGFuZGxpbmcgaWYgYSBoYXNoIGNoYW5nZSB3aWxsIGJlIGZpcmVkCgkJCQkvLyBieSB0aGUgYnJvd3NlcgoJCQkJaWYoIGhhc2hDaGFuZ2VkICkgewoJCQkJCS8vIGRpc2FibGUgaGFzaCBoYW5kbGluZyB1bnRpbCBvbmUgb2YgdGhlIGFib3ZlIHRpbWVycyBmaXJlcwoJCQkJCXNlbGYubmV4dEhhc2hDaGFuZ2VQcmV2ZW50ZWQoIHRydWUgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCWluaXQ6IGZ1bmN0aW9uKCkgewoJCQkkd2luLmJpbmQoICJoYXNoY2hhbmdlIiwgc2VsZi5vbkhhc2hDaGFuZ2UgKTsKCgkJCS8vIEhhbmRsZSBwb3BzdGF0ZSBldmVudHMgdGhlIG9jY3VyIHRocm91Z2ggaGlzdG9yeSBjaGFuZ2VzCgkJCSR3aW4uYmluZCggInBvcHN0YXRlIiwgc2VsZi5vblBvcFN0YXRlICk7CgoJCQkvLyBpZiB0aGVyZSdzIG5vIGhhc2gsIHdlIG5lZWQgdG8gcmVwbGFjZXN0YXRlIGZvciByZXR1cm5pbmcgdG8gaG9tZQoJCQlpZiAoIGxvY2F0aW9uLmhhc2ggPT09ICIiICkgewoJCQkJaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHNlbGYuc3RhdGUoKSwgZG9jdW1lbnQudGl0bGUsIGxvY2F0aW9uLmhyZWYgKTsKCQkJfQoJCX0KCX0pOwoKCSQoIGZ1bmN0aW9uKCkgewoJCWlmKCAkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkICYmICQuc3VwcG9ydC5wdXNoU3RhdGUgKXsKCQkJcHVzaFN0YXRlSGFuZGxlci5pbml0KCk7CgkJfQoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgcG9wIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5wb3AgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciBzbGlkZSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2xpZGUgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2ltdWx0YW5lb3VzOwoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9uJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZG93biBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVkb3duID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZXVwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZXVwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbGlwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbGlwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciB0dXJuIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy50dXJuID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07CgoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCgl2YXIgcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSgkKGUudGFyZ2V0KSksIG9wdGlvbnM7CgoJaWYoICFwYWdlICkgewoJCXJldHVybjsKCX0KCglvcHRpb25zID0gcGFnZS5vcHRpb25zOwoKCS8vIGRlZ3JhZGUgaW5wdXRzIHRvIGF2b2lkIHBvb3JseSBpbXBsZW1lbnRlZCBuYXRpdmUgZnVuY3Rpb25hbGl0eQoJJCggZS50YXJnZXQgKS5maW5kKCAiaW5wdXQiICkubm90KCBwYWdlLmtlZXBOYXRpdmVTZWxlY3RvcigpICkuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSB8fCAidGV4dCI7CgoJCWlmICggb3B0aW9ucy5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gKSB7CgkJCXZhciBodG1sID0gJCggIjxkaXY+IiApLmh0bWwoICR0aGlzLmNsb25lKCkgKS5odG1sKCksCgkJCQkvLyBJbiBJRSBicm93c2VycywgdGhlIHR5cGUgc29tZXRpbWVzIGRvZXNuJ3QgZXhpc3QgaW4gdGhlIGNsb25lZCBtYXJrdXAsIHNvIHdlIHJlcGxhY2UgdGhlIGNsb3NpbmcgdGFnIGluc3RlYWQKCQkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMSwKCQkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi8sCgkJCQlyZXBzdHIgPSAiIHR5cGU9XCIiICsgb3B0VHlwZSArICJcIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPVwiIiArIHR5cGUgKyAiXCIiICsgKCBoYXNUeXBlID8gIiIgOiAiPiIgKTsKCgkJCSR0aGlzLnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQljbG9zZUJ0blRleHQgCTogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWUJOiAiYSIsCgkJaW5pdFNlbGVjdG9yCTogIjpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQloZWFkZXJDbG9zZUJ1dHRvbiA9ICQoICI8YSBocmVmPScjJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uPSdkZWxldGUnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3M9J25vdGV4dCc+IisgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCArICI8L2E+IiApLAoJCQlkaWFsb2dXcmFwID0gJCgiPGRpdi8+IiwgewoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktY29ybmVyLWFsbCB1aS1vdmVybGF5LXNoYWRvdyIKCQkJCX0pOwoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaWFsb2cgdWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCQoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nCgkJLy8gU2V0IGFyaWEgcm9sZQoJCSRlbAoJCQkud3JhcElubmVyKCBkaWFsb2dXcmFwICkKCQkJLmNoaWxkcmVuKCkKCQkJCS5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkKCQkJCQkucHJlcGVuZCggaGVhZGVyQ2xvc2VCdXR0b24gKQoJCQkJLmVuZCgpCgkJCQkuY2hpbGRyZW4oICc6Zmlyc3QtY2hpbGQnKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICkKCQkJCS5lbmQoKQoJCQkJLmNoaWxkcmVuKCAiOmxhc3QtY2hpbGQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApOwoKCQkvLyB0aGlzIG11c3QgYmUgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgc2VsZWN0IG1lbnUgZGlhbG9ncyBjYW4gcmVwbGFjZQoJCS8vIHRoZSBjbG9zZSBtZXRob2QuIFRoaXMgaXMgYSBjaGFuZ2UgZnJvbSBwcmV2aW91c2x5IGp1c3QgZGVmaW5pbmcgZGF0YS1yZWw9YmFjawoJCS8vIG9uIHRoZSBidXR0b24gYW5kIGxldHRpbmcgbmF2IGhhbmRsZSBpdAoJCS8vCgkJLy8gVXNlIGNsaWNrIHJhdGhlciB0aGFuIHZjbGljayBpbiBvcmRlciB0byBwcmV2ZW50IHRoZSBwb3NzaWJpbGl0eSBvZiB1bmludGVudGlvbmFsbHkKCQkvLyByZW9wZW5pbmcgdGhlIGRpYWxvZyBpZiB0aGUgZGlhbG9nIG9wZW5pbmcgaXRlbSB3YXMgZGlyZWN0bHkgdW5kZXIgdGhlIGNsb3NlIGJ1dHRvbi4KCQloZWFkZXJDbG9zZUJ1dHRvbi5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJc2VsZi5jbG9zZSgpOwoJCX0pOwoKCQkvKiBiaW5kIGV2ZW50cwoJCQktIGNsaWNrcyBhbmQgc3VibWl0cyBzaG91bGQgdXNlIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24gdGhhdCB0aGUgZGlhbG9nIG9wZW5lZCB3aXRoCgkJCSAgdW5sZXNzIGEgZGF0YS10cmFuc2l0aW9uIGlzIHNwZWNpZmllZCBvbiB0aGUgbGluay9mb3JtCgkJCS0gaWYgdGhlIGNsaWNrIHdhcyBvbiB0aGUgY2xvc2UgYnV0dG9uLCBvciB0aGUgbGluayBoYXMgYSBkYXRhLXJlbD0iYmFjayIgaXQnbGwgZ28gYmFjayBpbiBoaXN0b3J5IG5hdHVyYWxseQoJCSovCgkJJGVsLmJpbmQoICJ2Y2xpY2sgc3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siID8gImEiIDogImZvcm0iICksCgkJCQlhY3RpdmU7CgoJCQlpZiAoICR0YXJnZXQubGVuZ3RoICYmICEkdGFyZ2V0LmpxbURhdGEoICJ0cmFuc2l0aW9uIiApICkgewoKCQkJCWFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCkgfHwge307CgoJCQkJJHRhcmdldC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHJhbnNpdGlvbiIsICggYWN0aXZlLnRyYW5zaXRpb24gfHwgJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gKSApCgkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXJlY3Rpb24iLCAicmV2ZXJzZSIgKTsKCQkJfQoJCX0pCgkJLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJJCggdGhpcyApLmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSkKCQkvLyBPdmVycmlkZSB0aGUgdGhlbWUgc2V0IGJ5IHRoZSBwYWdlIHBsdWdpbiBvbiBwYWdlc2hvdwoJCS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpewoJCQlpZiggc2VsZi5vcHRpb25zLm92ZXJsYXlUaGVtZSApewoJCQkJc2VsZi5lbGVtZW50CgkJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkJLnBhZ2UoICJzZXRDb250YWluZXJCYWNrZ3JvdW5kIiwgc2VsZi5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgInBhZ2VjcmVhdGUiLCBmdW5jdGlvbigpewoJJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5lbmhhbmNlKCB0aGlzICk7Cn0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIHVpLWJvZHkgdWktYnIiICk7Cn07CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJCggIjpqcW1EYXRhKHJvbGU9J2ZpZWxkY29udGFpbicpIiwgZS50YXJnZXQgKS5qcW1FbmhhbmNlYWJsZSgpLmZpZWxkY29udGFpbigpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5ncmlkID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQlncmlkOiBudWxsCgkJCX0sb3B0aW9ucyksCgkJCSRraWRzID0gJHRoaXMuY2hpbGRyZW4oKSwKCQkJZ3JpZENvbHMgPSB7c29sbzoxLCBhOjIsIGI6MywgYzo0LCBkOjV9LAoJCQlncmlkID0gby5ncmlkLAoJCQlpdGVyYXRvcjsKCgkJCWlmICggIWdyaWQgKSB7CgkJCQlpZiAoICRraWRzLmxlbmd0aCA8PSA1ICkgewoJCQkJCWZvciAoIHZhciBsZXR0ZXIgaW4gZ3JpZENvbHMgKSB7CgkJCQkJCWlmICggZ3JpZENvbHNbIGxldHRlciBdID09PSAka2lkcy5sZW5ndGggKSB7CgkJCQkJCQlncmlkID0gbGV0dGVyOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlncmlkID0gImEiOwoJCQkJfQoJCQl9CgkJCWl0ZXJhdG9yID0gZ3JpZENvbHNbZ3JpZF07CgoJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC0iICsgZ3JpZCApOwoKCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzEpIiApLmFkZENsYXNzKCAidWktYmxvY2stYSIgKTsKCgkJaWYgKCBpdGVyYXRvciA+IDEgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMikiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1iIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMiApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgzbiszKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWMiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAzICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKDRuKzQpIiApLmFkZENsYXNzKCAidWktYmxvY2stZCIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDQgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoNW4rNSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1lIiApOwoJCX0KCX0pOwp9Owp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCBlLnRhcmdldCApLmFkZENsYXNzKCAidWktbm9qcyIgKTsKCQp9KTsKCn0pKCBqUXVlcnkgKTsKCiggZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uYnV0dG9uTWFya3VwID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7Cgl2YXIgJHdvcmtpbmdTZXQgPSB0aGlzOwoKCS8vIEVuZm9yY2Ugb3B0aW9ucyB0byBiZSBvZiB0eXBlIHN0cmluZwoJb3B0aW9ucyA9ICggb3B0aW9ucyAmJiAoICQudHlwZSggb3B0aW9ucyApID09ICJvYmplY3QiICkgKT8gb3B0aW9ucyA6IHt9OwoJZm9yICggdmFyIGkgPSAwOyBpIDwgJHdvcmtpbmdTZXQubGVuZ3RoOyBpKysgKSB7CgkJdmFyIGVsID0gJHdvcmtpbmdTZXQuZXEoIGkgKSwKCQkJZSA9IGVsWyAwIF0sCgkJCW8gPSAkLmV4dGVuZCgge30sICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzLCB7CgkJCQlpY29uOiAgICAgICBvcHRpb25zLmljb24gICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbiAgICAgICA6IGVsLmpxbURhdGEoICJpY29uIiApLAoJCQkJaWNvbnBvczogICAgb3B0aW9ucy5pY29ucG9zICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25wb3MgICAgOiBlbC5qcW1EYXRhKCAiaWNvbnBvcyIgKSwKCQkJCXRoZW1lOiAgICAgIG9wdGlvbnMudGhlbWUgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy50aGVtZSAgICAgIDogZWwuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICksCgkJCQlpbmxpbmU6ICAgICBvcHRpb25zLmlubGluZSAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaW5saW5lICAgICA6IGVsLmpxbURhdGEoICJpbmxpbmUiICksCgkJCQlzaGFkb3c6ICAgICBvcHRpb25zLnNoYWRvdyAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc2hhZG93ICAgICA6IGVsLmpxbURhdGEoICJzaGFkb3ciICksCgkJCQljb3JuZXJzOiAgICBvcHRpb25zLmNvcm5lcnMgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY29ybmVycyAgICA6IGVsLmpxbURhdGEoICJjb3JuZXJzIiApLAoJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25zaGFkb3cgOiBlbC5qcW1EYXRhKCAiaWNvbnNoYWRvdyIgKSwKCQkJCW1pbmk6ICAgICAgIG9wdGlvbnMubWluaSAgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5taW5pICAgICAgIDogZWwuanFtRGF0YSggIm1pbmkiICkKCQkJfSwgb3B0aW9ucyApLAoKCQkJLy8gQ2xhc3NlcyBEZWZpbmVkCgkJCWlubmVyQ2xhc3MgPSAidWktYnRuLWlubmVyIiwKCQkJdGV4dENsYXNzID0gInVpLWJ0bi10ZXh0IiwKCQkJYnV0dG9uQ2xhc3MsIGljb25DbGFzcywKCQkJLy8gQnV0dG9uIGlubmVyIG1hcmt1cAoJCQlidXR0b25Jbm5lciwKCQkJYnV0dG9uVGV4dCwKCQkJYnV0dG9uSWNvbiwKCQkJYnV0dG9uRWxlbWVudHM7CgoJCSQuZWFjaChvLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CgkJCWUuc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBrZXksIHZhbHVlICk7CgkJCWVsLmpxbURhdGEoa2V5LCB2YWx1ZSk7CgkJfSk7CgoJCS8vIENoZWNrIGlmIHRoaXMgZWxlbWVudCBpcyBhbHJlYWR5IGVuaGFuY2VkCgkJYnV0dG9uRWxlbWVudHMgPSAkLmRhdGEoKChlLnRhZ05hbWUgPT09ICJJTlBVVCIgfHwgZS50YWdOYW1lID09PSAiQlVUVE9OIikgPyBlLnBhcmVudE5vZGUgOiBlKSwgImJ1dHRvbkVsZW1lbnRzIik7CgoJCWlmIChidXR0b25FbGVtZW50cykgewoJCQllID0gYnV0dG9uRWxlbWVudHMub3V0ZXI7CgkJCWVsID0gJChlKTsKCQkJYnV0dG9uSW5uZXIgPSBidXR0b25FbGVtZW50cy5pbm5lcjsKCQkJYnV0dG9uVGV4dCA9IGJ1dHRvbkVsZW1lbnRzLnRleHQ7CgkJCS8vIFdlIHdpbGwgcmVjcmVhdGUgdGhpcyBpY29uIGJlbG93CgkJCSQoYnV0dG9uRWxlbWVudHMuaWNvbikucmVtb3ZlKCk7CgkJCWJ1dHRvbkVsZW1lbnRzLmljb24gPSBudWxsOwoJCX0KCQllbHNlIHsKCQkJYnV0dG9uSW5uZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKTsKCQkJYnV0dG9uVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApOwoJCX0KCQlidXR0b25JY29uID0gby5pY29uID8gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgOiBudWxsOwoKCQlpZiAoIGF0dGFjaEV2ZW50cyAmJiAhYnV0dG9uRWxlbWVudHMpIHsKCQkJYXR0YWNoRXZlbnRzKCk7CgkJfQoJCQoJCS8vIGlmIG5vdCwgdHJ5IHRvIGZpbmQgY2xvc2VzdCB0aGVtZSBjb250YWluZXIJCgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICk7CQoJCX0JCQoKCQlidXR0b25DbGFzcyA9ICJ1aS1idG4gdWktYnRuLXVwLSIgKyBvLnRoZW1lOwoJCWJ1dHRvbkNsYXNzICs9IG8uaW5saW5lID8gIiB1aS1idG4taW5saW5lIiA6ICIiOwoJCWJ1dHRvbkNsYXNzICs9IG8uc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiI7CgkJYnV0dG9uQ2xhc3MgKz0gby5jb3JuZXJzID8gIiB1aS1idG4tY29ybmVyLWFsbCIgOiAiIjsKCgkJaWYgKCBvLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYG1pbmlgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLm1pbmkgPyAiIHVpLW1pbmkiIDogIiB1aS1mdWxsc2l6ZSI7CgkJfQoJCQoJCWlmICggby5pbmxpbmUgIT09IHVuZGVmaW5lZCApIHsJCQkKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYG1pbmlgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLmlubGluZSA9PT0gZmFsc2UgPyAiIHVpLWJ0bi1ibG9jayIgOiAiIHVpLWJ0bi1pbmxpbmUiOwoJCX0KCQkKCQkKCQlpZiAoIG8uaWNvbiApIHsKCQkJby5pY29uID0gInVpLWljb24tIiArIG8uaWNvbjsKCQkJby5pY29ucG9zID0gby5pY29ucG9zIHx8ICJsZWZ0IjsKCgkJCWljb25DbGFzcyA9ICJ1aS1pY29uICIgKyBvLmljb247CgoJCQlpZiAoIG8uaWNvbnNoYWRvdyApIHsKCQkJCWljb25DbGFzcyArPSAiIHVpLWljb24tc2hhZG93IjsKCQkJfQoJCX0KCgkJaWYgKCBvLmljb25wb3MgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWljb24tIiArIG8uaWNvbnBvczsKCgkJCWlmICggby5pY29ucG9zID09ICJub3RleHQiICYmICFlbC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCQllbC5hdHRyKCAidGl0bGUiLCBlbC5nZXRFbmNvZGVkVGV4dCgpICk7CgkJCX0KCQl9CiAgICAKCQlpbm5lckNsYXNzICs9IG8uY29ybmVycyA/ICIgdWktYnRuLWNvcm5lci1hbGwiIDogIiI7CgoJCWlmICggby5pY29ucG9zICYmIG8uaWNvbnBvcyA9PT0gIm5vdGV4dCIgJiYgIWVsLmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJZWwuYXR0ciggInRpdGxlIiwgZWwuZ2V0RW5jb2RlZFRleHQoKSApOwoJCX0KCgkJaWYgKCBidXR0b25FbGVtZW50cyApIHsKCQkJZWwucmVtb3ZlQ2xhc3MoIGJ1dHRvbkVsZW1lbnRzLmJjbHMgfHwgIiIgKTsKCQl9CgkJZWwucmVtb3ZlQ2xhc3MoICJ1aS1saW5rIiApLmFkZENsYXNzKCBidXR0b25DbGFzcyApOwoKCQlidXR0b25Jbm5lci5jbGFzc05hbWUgPSBpbm5lckNsYXNzOwoKCQlidXR0b25UZXh0LmNsYXNzTmFtZSA9IHRleHRDbGFzczsKCQlpZiAoICFidXR0b25FbGVtZW50cyApIHsKCQkJYnV0dG9uSW5uZXIuYXBwZW5kQ2hpbGQoIGJ1dHRvblRleHQgKTsKCQl9CgkJaWYgKCBidXR0b25JY29uICkgewoJCQlidXR0b25JY29uLmNsYXNzTmFtZSA9IGljb25DbGFzczsKCQkJaWYgKCAhKGJ1dHRvbkVsZW1lbnRzICYmIGJ1dHRvbkVsZW1lbnRzLmljb24pICkgewoJCQkJYnV0dG9uSWNvbi5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIlx1MDBhMCIpICk7CgkJCQlidXR0b25Jbm5lci5hcHBlbmRDaGlsZCggYnV0dG9uSWNvbiApOwoJCQl9CgkJfQoKCQl3aGlsZSAoIGUuZmlyc3RDaGlsZCAmJiAhYnV0dG9uRWxlbWVudHMpIHsKCQkJYnV0dG9uVGV4dC5hcHBlbmRDaGlsZCggZS5maXJzdENoaWxkICk7CgkJfQoKCQlpZiAoICFidXR0b25FbGVtZW50cyApIHsKCQkJZS5hcHBlbmRDaGlsZCggYnV0dG9uSW5uZXIgKTsKCQl9CgoJCS8vIEFzc2lnbiBhIHN0cnVjdHVyZSBjb250YWluaW5nIHRoZSBlbGVtZW50cyBvZiB0aGlzIGJ1dHRvbiB0byB0aGUgZWxlbWVudHMgb2YgdGhpcyBidXR0b24uIFRoaXMKCQkvLyB3aWxsIGFsbG93IHVzIHRvIHJlY29nbml6ZSB0aGlzIGFzIGFuIGFscmVhZHktZW5oYW5jZWQgYnV0dG9uIGluIGZ1dHVyZSBjYWxscyB0byBidXR0b25NYXJrdXAoKS4KCQlidXR0b25FbGVtZW50cyA9IHsKCQkJYmNscyAgOiBidXR0b25DbGFzcywKCQkJb3V0ZXIgOiBlLAoJCQlpbm5lciA6IGJ1dHRvbklubmVyLAoJCQl0ZXh0ICA6IGJ1dHRvblRleHQsCgkJCWljb24gIDogYnV0dG9uSWNvbgoJCX07CgoJCSQuZGF0YShlLCAgICAgICAgICAgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMpOwoJCSQuZGF0YShidXR0b25Jbm5lciwgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMpOwoJCSQuZGF0YShidXR0b25UZXh0LCAgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMpOwoJCWlmIChidXR0b25JY29uKSB7CgkJCSQuZGF0YShidXR0b25JY29uLCAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyk7CgkJfQoJfQoKCXJldHVybiB0aGlzOwp9OwoKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7Cgljb3JuZXJzOiB0cnVlLAoJc2hhZG93OiB0cnVlLAoJaWNvbnNoYWRvdzogdHJ1ZSwKCXdyYXBwZXJFbHM6ICJzcGFuIgp9OwoKZnVuY3Rpb24gY2xvc2VzdEVuYWJsZWRCdXR0b24oIGVsZW1lbnQgKSB7CiAgICB2YXIgY25hbWU7CgogICAgd2hpbGUgKCBlbGVtZW50ICkgewoJCS8vIE5vdGUgdGhhdCB3ZSBjaGVjayBmb3IgdHlwZW9mIGNsYXNzTmFtZSBiZWxvdyBiZWNhdXNlIHRoZSBlbGVtZW50IHdlCgkJLy8gaGFuZGVkIGNvdWxkIGJlIGluIGFuIFNWRyBET00gd2hlcmUgY2xhc3NOYW1lIG9uIFNWRyBlbGVtZW50cyBpcyBkZWZpbmVkIHRvCgkJLy8gYmUgb2YgYSBkaWZmZXJlbnQgdHlwZSAoU1ZHQW5pbWF0ZWRTdHJpbmcpLiBXZSBvbmx5IG9wZXJhdGUgb24gSFRNTCBET00KCQkvLyBlbGVtZW50cywgc28gd2UgbG9vayBmb3IgcGxhaW4gInN0cmluZyIuCiAgICAgICAgY25hbWUgPSAoIHR5cGVvZiBlbGVtZW50LmNsYXNzTmFtZSA9PT0gJ3N0cmluZycgKSAmJiAoZWxlbWVudC5jbGFzc05hbWUgKyAnICcpOwogICAgICAgIGlmICggY25hbWUgJiYgY25hbWUuaW5kZXhPZigidWktYnRuICIpID4gLTEgJiYgY25hbWUuaW5kZXhPZigidWktZGlzYWJsZWQgIikgPCAwICkgewogICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICB9CgogICAgcmV0dXJuIGVsZW1lbnQ7Cn0KCnZhciBhdHRhY2hFdmVudHMgPSBmdW5jdGlvbigpIHsKCXZhciBob3ZlckRlbGF5ID0gJC5tb2JpbGUuYnV0dG9uTWFya3VwLmhvdmVyRGVsYXksIGhvdiwgZm9jOwoKCSQoIGRvY3VtZW50ICkuYmluZCggewoJCSJ2bW91c2Vkb3duIHZtb3VzZWNhbmNlbCB2bW91c2V1cCB2bW91c2VvdmVyIHZtb3VzZW91dCBmb2N1cyBibHVyIHNjcm9sbHN0YXJ0IjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgdGhlbWUsCgkJCQkkYnRuID0gJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICksCgkJCQlldnQgPSBldmVudC50eXBlOwoJCQoJCQlpZiAoICRidG4ubGVuZ3RoICkgewoJCQkJdGhlbWUgPSAkYnRuLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIgKTsKCQkKCQkJCWlmICggZXZ0ID09PSAidm1vdXNlZG93biIgKSB7CgkJCQkJaWYgKCAkLnN1cHBvcnQudG91Y2ggKSB7CgkJCQkJCWhvdiA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICk7CgkJCQkJCX0sIGhvdmVyRGVsYXkgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlY2FuY2VsIiB8fCBldnQgPT09ICJ2bW91c2V1cCIgKSB7CgkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApOwoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3ZlciIgfHwgZXZ0ID09PSAiZm9jdXMiICkgewoJCQkJCWlmICggJC5zdXBwb3J0LnRvdWNoICkgewoJCQkJCQlmb2MgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgKTsKCQkJCQkJfSwgaG92ZXJEZWxheSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4taG92ZXItIiArIHRoZW1lICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3V0IiB8fCBldnQgPT09ICJibHVyIiB8fCBldnQgPT09ICJzY3JvbGxzdGFydCIgKSB7CgkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgICsgIiB1aS1idG4tZG93bi0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKTsKCQkJCQlpZiAoIGhvdiApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBob3YgKTsKCQkJCQl9CgkJCQkJaWYgKCBmb2MgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggZm9jICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSwKCQkiZm9jdXNpbiBmb2N1cyI6IGZ1bmN0aW9uKCBldmVudCApewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0sCgkJImZvY3Vzb3V0IGJsdXIiOiBmdW5jdGlvbiggZXZlbnQgKXsKCQkJJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQl9Cgl9KTsKCglhdHRhY2hFdmVudHMgPSBudWxsOwp9OwoKLy9saW5rcyBpbiBiYXJzLCBvciB0aG9zZSB3aXRoICBkYXRhLXJvbGUgYmVjb21lIGJ1dHRvbnMKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCgkkKCAiOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktaGVhZGVyID4gYSwgLnVpLWZvb3RlciA+IGEsIC51aS1iYXIgPiA6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSA+IGEiLCBlLnRhcmdldCApCgkJLm5vdCggIi51aS1idG4sIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmJ1dHRvbk1hcmt1cCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYmFja0J0blRleHQgID0gIkJhY2siOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmFkZEJhY2tCdG4gICA9IGZhbHNlOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UaGVtZSA9IG51bGw7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuaGVhZGVyVGhlbWUgID0gImEiOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmZvb3RlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5jb250ZW50VGhlbWUgPSBudWxsOwoKJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiLCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCXZhciAkcGFnZSA9ICQoIHRoaXMgKSwKCQlvID0gJHBhZ2UuZGF0YSggInBhZ2UiICkub3B0aW9ucywKCQlwYWdlUm9sZSA9ICRwYWdlLmpxbURhdGEoICJyb2xlIiApLAoJCXBhZ2VUaGVtZSA9IG8udGhlbWU7CgoJJCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpLCA6anFtRGF0YShyb2xlPSdmb290ZXInKSwgOmpxbURhdGEocm9sZT0nY29udGVudCcpIiwgdGhpcyApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlyb2xlID0gJHRoaXMuanFtRGF0YSggInJvbGUiICksCgkJCXRoZW1lID0gJHRoaXMuanFtRGF0YSggInRoZW1lIiApLAoJCQljb250ZW50VGhlbWUgPSB0aGVtZSB8fCBvLmNvbnRlbnRUaGVtZSB8fCAoIHBhZ2VSb2xlID09PSAiZGlhbG9nIiAmJiBwYWdlVGhlbWUgKSwKCQkJJGhlYWRlcmFuY2hvcnMsCgkJCWxlZnRidG4sCgkJCXJpZ2h0YnRuLAoJCQliYWNrQnRuOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CgoJCS8vYXBwbHkgdGhlbWluZyBhbmQgbWFya3VwIG1vZGlmaWNhdGlvbnMgdG8gcGFnZSxoZWFkZXIsY29udGVudCxmb290ZXIKCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiIHx8IHJvbGUgPT09ICJmb290ZXIiICkgewoKCQkJdmFyIHRoaXNUaGVtZSA9IHRoZW1lIHx8ICggcm9sZSA9PT0gImhlYWRlciIgPyBvLmhlYWRlclRoZW1lIDogby5mb290ZXJUaGVtZSApIHx8IHBhZ2VUaGVtZTsKCgkJCSR0aGlzCgkJCQkvL2FkZCB0aGVtZSBjbGFzcwoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyB0aGlzVGhlbWUgKQoJCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkJLmF0dHIoICJyb2xlIiwgcm9sZSA9PT0gImhlYWRlciIgPyAiYmFubmVyIiA6ICJjb250ZW50aW5mbyIgKTsKCgkJCWlmKCByb2xlID09PSAiaGVhZGVyIikgewoJCQkJLy8gUmlnaHQsbGVmdCBidXR0b25zCgkJCQkkaGVhZGVyYW5jaG9ycwk9ICR0aGlzLmNoaWxkcmVuKCAiYSIgKTsKCQkJCWxlZnRidG4JPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApOwoJCQkJcmlnaHRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCQlsZWZ0YnRuID0gbGVmdGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMCApLm5vdCggIi51aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tbGVmdCIgKS5sZW5ndGg7CgoJCQkJcmlnaHRidG4gPSByaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMSApLmFkZENsYXNzKCAidWktYnRuLXJpZ2h0IiApLmxlbmd0aDsKCQkJfQoKCQkJLy8gQXV0by1hZGQgYmFjayBidG4gb24gcGFnZXMgYmV5b25kIGZpcnN0IHZpZXcKCQkJaWYgKCBvLmFkZEJhY2tCdG4gJiYKCQkJCXJvbGUgPT09ICJoZWFkZXIiICYmCgkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJJHBhZ2UuanFtRGF0YSggInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJIWxlZnRidG4gKSB7CgoJCQkJYmFja0J0biA9ICQoICI8YSBocmVmPScjJyBjbGFzcz0ndWktYnRuLWxlZnQnIGRhdGEtIisgJC5tb2JpbGUubnMgKyJyZWw9J2JhY2snIGRhdGEtIisgJC5tb2JpbGUubnMgKyJpY29uPSdhcnJvdy1sJz4iKyBvLmJhY2tCdG5UZXh0ICsiPC9hPiIgKQoJCQkJCS8vIElmIHRoZW1lIGlzIHByb3ZpZGVkLCBvdmVycmlkZSBkZWZhdWx0IGluaGVyaXRhbmNlCgkJCQkJLmF0dHIoICJkYXRhLSIrICQubW9iaWxlLm5zICsidGhlbWUiLCBvLmJhY2tCdG5UaGVtZSB8fCB0aGlzVGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oICR0aGlzICk7CgkJCX0KCgkJCS8vIFBhZ2UgdGl0bGUKCQkJJHRoaXMuY2hpbGRyZW4oICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS10aXRsZSIgKQoJCQkJLy8gUmVnYXJkbGVzcyBvZiBoIGVsZW1lbnQgbnVtYmVyIGluIHNyYywgaXQgYmVjb21lcyBoMSBmb3IgdGhlIGVuaGFuY2VkIHBhZ2UKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJoZWFkaW5nIiwKCQkJCQkiYXJpYS1sZXZlbCI6ICIxIgoJCQkJfSk7CgoJCX0gZWxzZSBpZiAoIHJvbGUgPT09ICJjb250ZW50IiApIHsKCQkJaWYgKCBjb250ZW50VGhlbWUgKSB7CgkJCSAgICAkdGhpcy5hZGRDbGFzcyggInVpLWJvZHktIiArICggY29udGVudFRoZW1lICkgKTsKCQkJfQoKCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkkdGhpcy5hdHRyKCAicm9sZSIsICJtYWluIiApOwoJCX0KCX0pOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgkJY29sbGFwc2VDdWVUZXh0OiAiIGNsaWNrIHRvIGNvbGxhcHNlIGNvbnRlbnRzIiwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJdGhlbWU6IG51bGwsCgkJY29udGVudFRoZW1lOiBudWxsLAoJCWljb25UaGVtZTogImQiLAoJCW1pbmk6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWNvbGxhcHNpYmxlID0gJGVsLmFkZENsYXNzKCAidWktY29sbGFwc2libGUiICksCgkJCWNvbGxhcHNpYmxlSGVhZGluZyA9ICRlbC5jaGlsZHJlbiggby5oZWFkaW5nICkuZmlyc3QoKSwKCQkJY29sbGFwc2libGVDb250ZW50ID0gY29sbGFwc2libGUud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCc+PC9kaXY+IiApLmZpbmQoICIudWktY29sbGFwc2libGUtY29udGVudCIgKSwKCQkJY29sbGFwc2libGVTZXQgPSAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApOwoKCQkvLyBSZXBsYWNlIGNvbGxhcHNpYmxlSGVhZGluZyBpZiBpdCdzIGEgbGVnZW5kCgkJaWYgKCBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICJsZWdlbmQiICkgKSB7CgkJCWNvbGxhcHNpYmxlSGVhZGluZyA9ICQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnPiIrIGNvbGxhcHNpYmxlSGVhZGluZy5odG1sKCkgKyI8L2Rpdj4iICkuaW5zZXJ0QmVmb3JlKCBjb2xsYXBzaWJsZUhlYWRpbmcgKTsKCQkJY29sbGFwc2libGVIZWFkaW5nLm5leHQoKS5yZW1vdmUoKTsKCQl9CgoJCS8vIElmIHdlIGFyZSBpbiBhIGNvbGxhcHNpYmxlIHNldAoJCWlmICggY29sbGFwc2libGVTZXQubGVuZ3RoICkgewoJCQkvLyBJbmhlcml0IHRoZSB0aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCQlpZiAoICFvLnRoZW1lICkgewoJCQkJby50aGVtZSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoInRoZW1lIikgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGNvbGxhcHNpYmxlU2V0LCAiYyIgKTsKCQkJfQoJCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQkJby5jb250ZW50VGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQkJfQoKCQkJLy8gR2V0cyB0aGUgcHJlZmVyZW5jZSBpY29uIHBvc2l0aW9uIGluIHRoZSBzZXQKCQkJaWYgKCAhby5pY29uUG9zICkgewoJCQkJby5pY29uUG9zID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImljb25wb3MiICk7CgkJCX0KCgkJCWlmKCAhby5taW5pICkgewoJCQkJby5taW5pID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggIm1pbmkiICk7CgkJCX0KCQl9CgkJY29sbGFwc2libGVDb250ZW50LmFkZENsYXNzKCAoIG8uY29udGVudFRoZW1lICkgPyAoICJ1aS1ib2R5LSIgKyBvLmNvbnRlbnRUaGVtZSApIDogIiIpOwoKCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQkJLmluc2VydEJlZm9yZSggY29sbGFwc2libGVDb250ZW50ICkKCQkJLy9tb2RpZnkgbWFya3VwICYgYXR0cmlidXRlcwoJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCS5hcHBlbmQoICI8c3BhbiBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMnPjwvc3Bhbj4iICkKCQkJLndyYXBJbm5lciggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXRvZ2dsZSc+PC9hPiIgKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCWljb25wb3M6ICRlbC5qcW1EYXRhKCAiaWNvbnBvcyIgKSB8fCBvLmljb25Qb3MgfHwgImxlZnQiLAoJCQkJCWljb246ICJwbHVzIiwKCQkJCQltaW5pOiBvLm1pbmksCgkJCQkJdGhlbWU6IG8udGhlbWUKCQkJCX0pCgkJCS5hZGQoICIudWktYnRuLWlubmVyIiwgJGVsICkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSIgKTsKCgkJLy9ldmVudHMKCQljb2xsYXBzaWJsZQoJCQkuYmluZCggImV4cGFuZCBjb2xsYXBzZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJCWlzQ29sbGFwc2UgPSAoIGV2ZW50LnR5cGUgPT09ICJjb2xsYXBzZSIgKSwKCQkJCQkgICAgY29udGVudFRoZW1lID0gby5jb250ZW50VGhlbWU7CgoJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UpCgkJCQkJCS5maW5kKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApCgkJCQkJCQkudGV4dCggaXNDb2xsYXBzZSA/IG8uZXhwYW5kQ3VlVGV4dCA6IG8uY29sbGFwc2VDdWVUZXh0ICkKCQkJCQkJLmVuZCgpCgkJCQkJCS5maW5kKCAiLnVpLWljb24iICkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tbWludXMiLCAhaXNDb2xsYXBzZSApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLXBsdXMiLCBpc0NvbGxhcHNlICk7CgoJCQkJCSR0aGlzLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApOwoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbnRlbnQtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApLmF0dHIoICJhcmlhLWhpZGRlbiIsIGlzQ29sbGFwc2UgKTsKCgkJCQkJaWYgKCBjb250ZW50VGhlbWUgJiYgKCAhY29sbGFwc2libGVTZXQubGVuZ3RoIHx8IGNvbGxhcHNpYmxlLmpxbURhdGEoICJjb2xsYXBzaWJsZS1sYXN0IiApICkgKSB7CgkJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkKCBjb2xsYXBzaWJsZUhlYWRpbmcuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGVDb250ZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCQkJfQoJCQl9KQoJCQkudHJpZ2dlciggby5jb2xsYXBzZWQgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJdmFyIHR5cGUgPSBjb2xsYXBzaWJsZUhlYWRpbmcuaXMoICIudWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgPwoJCQkJCQkJCQkJImV4cGFuZCIgOiAiY29sbGFwc2UiOwoKCQkJCWNvbGxhcHNpYmxlLnRyaWdnZXIoIHR5cGUgKTsKCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZXNldCIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCS8vIEluaGVyaXQgdGhlIHRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCAkZWwsICJjIiApOwoJCX0KCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJaWYgKCAhby5jb250ZW50VGhlbWUgKSB7CgkJCW8uY29udGVudFRoZW1lID0gJGVsLmpxbURhdGEoICJjb250ZW50LXRoZW1lIiApOwoJCX0KCgkJaWYgKCAhby5jb3JuZXJzICkgewoJCQlvLmNvcm5lcnMgPSAkZWwuanFtRGF0YSggImNvcm5lcnMiICkgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBmYWxzZTsKCQl9CgoJCS8vIEluaXRpYWxpemUgdGhlIGNvbGxhcHNpYmxlIHNldCBpZiBpdCdzIG5vdCBhbHJlYWR5IGluaXRpYWxpemVkCgkJaWYgKCAhJGVsLmpxbURhdGEoICJjb2xsYXBzaWJsZWJvdW5kIiApICkgewoJCQkkZWwKCQkJCS5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIsIHRydWUgKQoJCQkJLmJpbmQoICJleHBhbmQgY29sbGFwc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJdmFyIGlzQ29sbGFwc2UgPSAoIGV2ZW50LnR5cGUgPT09ICJjb2xsYXBzZSIgKSwKCQkJCQkJY29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApLAoJCQkJCQl3aWRnZXQgPSBjb2xsYXBzaWJsZS5kYXRhKCAiY29sbGFwc2libGUiICksCgkJCQkJICAgIGNvbnRlbnRUaGVtZSA9IHdpZGdldC5vcHRpb25zLmNvbnRlbnRUaGVtZTsKCQkJCQlpZiAoIGNvbnRlbnRUaGVtZSAmJiBjb2xsYXBzaWJsZS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIgKSApIHsKCQkJCQkJY29sbGFwc2libGUuZmluZCggd2lkZ2V0Lm9wdGlvbnMuaGVhZGluZyApLmZpcnN0KCkKCQkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCQkJCQkuYWRkKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGUuZmluZCggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZXhwYW5kIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCSQoIGV2ZW50LnRhcmdldCApCgkJCQkJCS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApCgkJCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZSIgKQoJCQkJCQkudHJpZ2dlciggImNvbGxhcHNlIiApOwoJCQkJfSk7CgkJfQoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWNvbGxhcHNpYmxlc0luU2V0ID0gJGVsLmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIgKTsKCgkJJC5tb2JpbGUuY29sbGFwc2libGUucHJvdG90eXBlLmVuaGFuY2UoIGNvbGxhcHNpYmxlc0luU2V0Lm5vdCggIi51aS1jb2xsYXBzaWJsZSIgKSApOwoKCQkvLyBjbGVhbiB1cCBib3JkZXJzCgkJY29sbGFwc2libGVzSW5TZXQuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUub3B0aW9ucy5oZWFkaW5nICkKCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCQkuYWRkKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIiApOwoJCX0pOwoKCQljb2xsYXBzaWJsZXNJblNldC5maXJzdCgpCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5hZGRDbGFzcyggby5jb3JuZXJzID8gInVpLWNvcm5lci10b3AiIDogIiIgKQoJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKTsKCgkJY29sbGFwc2libGVzSW5TZXQubGFzdCgpCgkJCS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIsIHRydWUgKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYWRkQ2xhc3MoIG8uY29ybmVycyA/ICJ1aS1jb3JuZXItYm90dG9tIiA6ICIiICkKCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20iICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQubW9iaWxlLmNvbGxhcHNpYmxlc2V0LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUubmF2YmFyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJaWNvbnBvczogInRvcCIsCgkJZ3JpZDogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSduYXZiYXInKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKXsKCgkJdmFyICRuYXZiYXIgPSB0aGlzLmVsZW1lbnQsCgkJCSRuYXZidG5zID0gJG5hdmJhci5maW5kKCAiYSIgKSwKCQkJaWNvbnBvcyA9ICRuYXZidG5zLmZpbHRlciggIjpqcW1EYXRhKGljb24pIiApLmxlbmd0aCA/CgkJCQkJCQkJCXRoaXMub3B0aW9ucy5pY29ucG9zIDogdW5kZWZpbmVkOwoKCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyIiApCgkJCS5hdHRyKCAicm9sZSIsIm5hdmlnYXRpb24iICkKCQkJLmZpbmQoICJ1bCIgKQoJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQlpZiAoICFpY29ucG9zICkgewoJCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyLW5vaWNvbnMiICk7CgkJfQoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWlubGluZTogICAgIHRydWUsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiggISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktZGlzYWJsZWQiKSApIHsKCQkJCSRuYXZidG5zLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7CgoJCS8vIEJ1dHRvbnMgaW4gdGhlIG5hdmJhciB3aXRoIHVpLXN0YXRlLXBlcnNpc3QgY2xhc3Mgc2hvdWxkIHJlZ2FpbiB0aGVpciBhY3RpdmUgc3RhdGUgYmVmb3JlIHBhZ2Ugc2hvdwoJCSRuYXZiYXIuY2xvc2VzdCggIi51aS1wYWdlIiApLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkkbmF2YnRucy5maWx0ZXIoICIudWktc3RhdGUtcGVyc2lzdCIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUubmF2YmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy9LZWVwcyB0cmFjayBvZiB0aGUgbnVtYmVyIG9mIGxpc3RzIHBlciBwYWdlIFVJRAovL1RoaXMgYWxsb3dzIHN1cHBvcnQgZm9yIG11bHRpcGxlIG5lc3RlZCBsaXN0IGluIHRoZSBzYW1lIHBhZ2UKLy9odHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzE2MTcKdmFyIGxpc3RDb3VudFBlclBhZ2UgPSB7fTsKCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUud2lkZ2V0LCB7CgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6ICJjIiwKCQloZWFkZXJUaGVtZTogImIiLAoJCWRpdmlkZXJUaGVtZTogImIiLAoJCXNwbGl0SWNvbjogImFycm93LXIiLAoJCXNwbGl0VGhlbWU6ICJiIiwKCQltaW5pOiBmYWxzZSwKCQlpbnNldDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nbGlzdHZpZXcnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSB0aGlzLAoJCQlsaXN0dmlld0NsYXNzZXMgPSAiIjsKCQkJCgkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5pbnNldCA/ICIgdWktbGlzdHZpZXctaW5zZXQgdWktY29ybmVyLWFsbCB1aS1zaGFkb3cgIiA6ICIiOwoJCWxpc3R2aWV3Q2xhc3NlcyArPSB0LmVsZW1lbnQuanFtRGF0YSggIm1pbmkiICkgfHwgdC5vcHRpb25zLm1pbmkgPT09IHRydWUgPyAiIHVpLW1pbmkiIDogIiI7CgkJCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyhmdW5jdGlvbiggaSwgb3JpZyApIHsKCQkJcmV0dXJuIG9yaWcgKyAiIHVpLWxpc3R2aWV3ICIgKyBsaXN0dmlld0NsYXNzZXM7CgkJfSk7CgoJCXQucmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfcmVtb3ZlQ29ybmVyczogZnVuY3Rpb24oIGxpLCB3aGljaCApIHsKCQl2YXIgdG9wID0gInVpLWNvcm5lci10b3AgdWktY29ybmVyLXRyIHVpLWNvcm5lci10bCIsCgkJCWJvdCA9ICJ1aS1jb3JuZXItYm90dG9tIHVpLWNvcm5lci1iciB1aS1jb3JuZXItYmwiOwoKCQlsaSA9IGxpLmFkZCggbGkuZmluZCggIi51aS1idG4taW5uZXIsIC51aS1saS1saW5rLWFsdCwgLnVpLWxpLXRodW1iIiApICk7CgoJCWlmICggd2hpY2ggPT09ICJ0b3AiICkgewoJCQlsaS5yZW1vdmVDbGFzcyggdG9wICk7CgkJfSBlbHNlIGlmICggd2hpY2ggPT09ICJib3R0b20iICkgewoJCQlsaS5yZW1vdmVDbGFzcyggYm90ICk7CgkJfSBlbHNlIHsKCQkJbGkucmVtb3ZlQ2xhc3MoIHRvcCArICIgIiArIGJvdCApOwoJCX0KCX0sCgoJX3JlZnJlc2hDb3JuZXJzOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciAkbGksCgkJCSR2aXNpYmxlbGksCgkJCSR0b3BsaSwKCQkJJGJvdHRvbWxpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5pbnNldCApIHsKCQkJJGxpID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAibGkiICk7CgkJCS8vIGF0IGNyZWF0ZSB0aW1lIHRoZSBsaSBhcmUgbm90IHZpc2libGUgeWV0IHNvIHdlIG5lZWQgdG8gcmVseSBvbiAudWktc2NyZWVuLWhpZGRlbgoJCQkkdmlzaWJsZWxpID0gY3JlYXRlPyRsaS5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTokbGkuZmlsdGVyKCAiOnZpc2libGUiICk7CgoJCQl0aGlzLl9yZW1vdmVDb3JuZXJzKCAkbGkgKTsKCgkJCS8vIFNlbGVjdCB0aGUgZmlyc3QgdmlzaWJsZSBsaSBlbGVtZW50CgkJCSR0b3BsaSA9ICR2aXNpYmxlbGkuZmlyc3QoKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKTsKCgkJCSR0b3BsaS5hZGQoICR0b3BsaS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCS5ub3QoICIudWktbGktbGluay1hbHQgc3BhbjpmaXJzdC1jaGlsZCIgKSApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktbGluay1hbHQsIC51aS1saS1saW5rLWFsdCBzcGFuOmZpcnN0LWNoaWxkIiApCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRyIiApCgkJCQkuZW5kKCkKCQkJCS5maW5kKCAiLnVpLWxpLXRodW1iIiApCgkJCQkJLm5vdCgiLnVpLWxpLWljb24iKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10bCIgKTsKCgkJCS8vIFNlbGVjdCB0aGUgbGFzdCB2aXNpYmxlIGxpIGVsZW1lbnQKCQkJJGJvdHRvbWxpID0gJHZpc2libGVsaS5sYXN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20iICk7CgoJCQkkYm90dG9tbGkuYWRkKCAkYm90dG9tbGkuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJLmZpbmQoICIudWktbGktbGluay1hbHQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYnIiICkKCQkJCS5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktdGh1bWIiICkKCQkJCQkubm90KCIudWktbGktaWNvbiIpCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJsIiApOwoJCX0KCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0sCgoJLy8gVGhpcyBpcyBhIGdlbmVyaWMgdXRpbGl0eSBtZXRob2QgZm9yIGZpbmRpbmcgdGhlIGZpcnN0CgkvLyBub2RlIHdpdGggYSBnaXZlbiBub2RlTmFtZS4gSXQgdXNlcyBiYXNpYyBET00gdHJhdmVyc2FsCgkvLyB0byBiZSBmYXN0IGFuZCBpcyBtZWFudCB0byBiZSBhIHN1YnN0aXR1dGUgZm9yIHNpbXBsZQoJLy8gJC5mbi5jbG9zZXN0KCkgYW5kICQuZm4uY2hpbGRyZW4oKSBjYWxscyBvbiBhIHNpbmdsZQoJLy8gZWxlbWVudC4gTm90ZSB0aGF0IGNhbGxlcnMgbXVzdCBwYXNzIGJvdGggdGhlIGxvd2VyQ2FzZQoJLy8gYW5kIHVwcGVyQ2FzZSB2ZXJzaW9uIG9mIHRoZSBub2RlTmFtZSB0aGV5IGFyZSBsb29raW5nIGZvci4KCS8vIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcyBpcyB0aGF0IHRoaXMgZnVuY3Rpb24gd2lsbCBiZQoJLy8gY2FsbGVkIG1hbnkgdGltZXMgYW5kIHdlIHdhbnQgdG8gYXZvaWQgaGF2aW5nIHRvIGxvd2VyY2FzZQoJLy8gdGhlIG5vZGVOYW1lIGZyb20gdGhlIGVsZW1lbnQgZXZlcnkgdGltZSB0byBlbnN1cmUgd2UgaGF2ZQoJLy8gYSBtYXRjaC4gTm90ZSB0aGF0IHRoaXMgZnVuY3Rpb24gbGl2ZXMgaGVyZSBmb3Igbm93LCBidXQgbWF5CgkvLyBiZSBtb3ZlZCBpbnRvICQubW9iaWxlIGlmIG90aGVyIGNvbXBvbmVudHMgbmVlZCBhIHNpbWlsYXIgbWV0aG9kLgoJX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIG5leHRQcm9wLCBsY05hbWUsIHVjTmFtZSApCgl7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkKCXsKCQl2YXIgcmVzdWx0cyA9IFtdLAoJCQlkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJZWxlID0gZWxlLmZpcnN0Q2hpbGQ7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZSApOwoJCQl9CgkJCWVsZSA9IGVsZS5uZXh0U2libGluZzsKCQl9CgkJcmV0dXJuICQoIHJlc3VsdHMgKTsKCX0sCgoJX2FkZFRodW1iQ2xhc3NlczogZnVuY3Rpb24oIGNvbnRhaW5lcnMgKQoJewoJCXZhciBpLCBpbWcsIGxlbiA9IGNvbnRhaW5lcnMubGVuZ3RoOwoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWltZyA9ICQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGNvbnRhaW5lcnNbIGkgXS5maXJzdENoaWxkLCAibmV4dFNpYmxpbmciLCAiaW1nIiwgIklNRyIgKSApOwoJCQlpZiAoIGltZy5sZW5ndGggKSB7CgkJCQlpbWcuYWRkQ2xhc3MoICJ1aS1saS10aHVtYiIgKTsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5pcyggIi51aS1saS1pY29uIiApID8gInVpLWxpLWhhcy1pY29uIiA6ICJ1aS1saS1oYXMtdGh1bWIiICk7CgkJCX0KCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5wYXJlbnRQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQl0aGlzLl9jcmVhdGVTdWJQYWdlcygpOwoKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCXNlbGYgPSB0aGlzLAoJCQlkaXZpZGVydGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAiZGl2aWRlcnRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lLAoJCQlsaXN0c3BsaXR0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJzcGxpdHRoZW1lIiApLAoJCQlsaXN0c3BsaXRpY29uID0gJGxpc3QuanFtRGF0YSggInNwbGl0aWNvbiIgKSwKCQkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApLAoJCQljb3VudGVyID0gJC5zdXBwb3J0LmNzc1BzZXVkb0VsZW1lbnQgfHwgISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSA/IDAgOiAxLAoJCQlpdGVtQ2xhc3NEaWN0ID0ge30sCgkJCWl0ZW0sIGl0ZW1DbGFzcywgaXRlbVRoZW1lLAoJCQlhLCBsYXN0LCBzcGxpdHRoZW1lLCBjb3VudFBhcmVudCwgaWNvbiwgaW1nUGFyZW50cywgaW1nLCBsaW5rSWNvbjsKCgkJaWYgKCBjb3VudGVyICkgewoJCQkkbGlzdC5maW5kKCAiLnVpLWxpLWRlYyIgKS5yZW1vdmUoKTsKCQl9CgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWZvciAoIHZhciBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAidWktbGkiOwoKCQkJLy8gSWYgd2UncmUgY3JlYXRpbmcgdGhlIGVsZW1lbnQsIHdlIHVwZGF0ZSBpdCByZWdhcmRsZXNzCgkJCWlmICggY3JlYXRlIHx8ICFpdGVtLmhhc0NsYXNzKCAidWktbGkiICkgKSB7CgkJCQlpdGVtVGhlbWUgPSBpdGVtLmpxbURhdGEoInRoZW1lIikgfHwgby50aGVtZTsKCQkJCWEgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggaXRlbVsgMCBdLCAiYSIsICJBIiApOwoKCQkJCWlmICggYS5sZW5ndGggKSB7CgkJCQkJaWNvbiA9IGl0ZW0uanFtRGF0YSgiaWNvbiIpOwoKCQkJCQlpdGVtLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCXdyYXBwZXJFbHM6ICJkaXYiLAoJCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJaWNvbnBvczogInJpZ2h0IiwKCQkJCQkJaWNvbjogYS5sZW5ndGggPiAxIHx8IGljb24gPT09IGZhbHNlID8gZmFsc2UgOiBpY29uIHx8ICJhcnJvdy1yIiwKCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZQoJCQkJCX0pOwoKCQkJCQlpZiAoICggaWNvbiAhPSBmYWxzZSApICYmICggYS5sZW5ndGggPT0gMSApICkgewoJCQkJCQlpdGVtLmFkZENsYXNzKCAidWktbGktaGFzLWFycm93IiApOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggInVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gbGlzdHNwbGl0dGhlbWUgfHwgbGFzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lOwoJCQkJCQlsaW5rSWNvbiA9IGxhc3QuanFtRGF0YSgiaWNvbiIpOwoKCQkJCQkJbGFzdC5hcHBlbmRUbyhpdGVtKQoJCQkJCQkJLmF0dHIoICJ0aXRsZSIsIGxhc3QuZ2V0RW5jb2RlZFRleHQoKSApCgkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1saS1saW5rLWFsdCIgKQoJCQkJCQkJLmVtcHR5KCkKCQkJCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZSwKCQkJCQkJCQlpY29uOiBmYWxzZSwKCQkJCQkJCQlpY29ucG9zOiBmYWxzZQoJCQkJCQkJfSkKCQkJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJCS5hcHBlbmQoCgkJCQkJCQkJCSQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApICkuYnV0dG9uTWFya3VwKHsKCQkJCQkJCQkJCXNoYWRvdzogdHJ1ZSwKCQkJCQkJCQkJCWNvcm5lcnM6IHRydWUsCgkJCQkJCQkJCQl0aGVtZTogc3BsaXR0aGVtZSwKCQkJCQkJCQkJCWljb25wb3M6ICJub3RleHQiLAoJCQkJCQkJCQkJLy8gbGluayBpY29uIG92ZXJyaWRlcyBsaXN0IGl0ZW0gaWNvbiBvdmVycmlkZXMgdWwgZWxlbWVudCBvdmVycmlkZXMgb3B0aW9ucwoJCQkJCQkJCQkJaWNvbjogbGlua0ljb24gfHwgaWNvbiB8fCBsaXN0c3BsaXRpY29uIHx8IG8uc3BsaXRJY29uCgkJCQkJCQkJCX0pCgkJCQkJCQkJKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBpdGVtLmpxbURhdGEoICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApIHsKCgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktZGl2aWRlciB1aS1iYXItIiArIGRpdmlkZXJ0aGVtZTsKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgoJCQkJCS8vcmVzZXQgY291bnRlciB3aGVuIGEgZGl2aWRlciBoZWFkaW5nIGlzIGVuY291bnRlcmVkCgkJCQkJaWYgKCBjb3VudGVyICkgewoJCQkJCQljb3VudGVyID0gMTsKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1zdGF0aWMgdWktYm9keS0iICsgaXRlbVRoZW1lOwoJCQkJfQoJCQl9CgoJCQlpZiAoIGNvdW50ZXIgJiYgaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1kaXZpZGVyIiApIDwgMCApIHsKCQkJCWNvdW50UGFyZW50ID0gaXRlbS5pcyggIi51aS1saS1zdGF0aWM6Zmlyc3QiICkgPyBpdGVtIDogaXRlbS5maW5kKCAiLnVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQljb3VudFBhcmVudC5hZGRDbGFzcyggInVpLWxpLWpzbnVtYmVyaW5nIiApCgkJCQkJLnByZXBlbmQoICI8c3BhbiBjbGFzcz0ndWktbGktZGVjJz4iICsgKGNvdW50ZXIrKykgKyAiLiA8L3NwYW4+IiApOwoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtIGFuZCBpdHMKCQkJLy8gYnRuLWlubmVyIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtCgkJLy8gYW5kIHRoZWlyIGJ0bi1pbm5lciBlbGVtZW50cy4gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICkuY2hpbGRyZW4oICIudWktYnRuLWlubmVyIiApLmFkZENsYXNzKCBpdGVtQ2xhc3MgKTsKCQl9CgoJCSRsaXN0LmZpbmQoICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApLmFkZENsYXNzKCAidWktbGktaGVhZGluZyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAicCwgZGwiICkuYWRkQ2xhc3MoICJ1aS1saS1kZXNjIiApCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktYXNpZGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoJCQkJCSR0aGlzLnByZXBlbmRUbyggJHRoaXMucGFyZW50KCkgKTsgLy9zaGlmdCBhc2lkZSB0byBmcm9udCBmb3IgY3NzIGZsb2F0CgkJCQl9KQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWNvdW50IiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICk7CgkJCQl9KS5hZGRDbGFzcyggInVpLWJ0bi11cC0iICsgKCAkbGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCB0aGlzLm9wdGlvbnMuY291bnRUaGVtZSkgKyAiIHVpLWJ0bi1jb3JuZXItYWxsIiApOwoKCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGxvb2sgYXQgdGhlIGZpcnN0IGltYWdlIGluIHRoZSBsaXN0IGl0ZW0KCQkvLyBpdHNlbGYsIGFuZCBhbnkgLnVpLWxpbmstaW5oZXJpdCBlbGVtZW50IGl0IG1heSBjb250YWluLCBzbyB3ZQoJCS8vIGNhbiBwbGFjZSB0aGUgYXBwcm9wcmlhdGUgY2xhc3NlcyBvbiB0aGUgaW1hZ2UgYW5kIGxpc3QgaXRlbS4KCQkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2Ugc29tZXRoaW5nIGxpa2U6CgkJLy8KCQkvLyAgICBsaS5maW5kKCI+aW1nOmVxKDApLCAudWktbGluay1pbmhlcml0PmltZzplcSgwKSIpLmVhY2goIC4uLiApOwoJCS8vCgkJLy8gQnV0IGV4ZWN1dGluZyBhIGZpbmQoKSBsaWtlIHRoYXQgb24gV2luZG93cyBQaG9uZSA3LjUgdG9vayBhCgkJLy8gcmVhbGx5IGxvbmcgdGltZS4gV2Fsa2luZyB0aGluZ3MgbWFudWFsbHkgd2l0aCB0aGUgY29kZSBiZWxvdwoJCS8vIGFsbG93cyB0aGUgNDAwIGxpc3R2aWV3IGl0ZW0gcGFnZSB0byBsb2FkIGluIGFib3V0IDMgc2Vjb25kcyBhcwoJCS8vIG9wcG9zZWQgdG8gMzAgc2Vjb25kcy4KCgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCBsaSApOwoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggJGxpc3QuZmluZCggIi51aS1saW5rLWluaGVyaXQiICkgKTsKCgkJdGhpcy5fcmVmcmVzaENvcm5lcnMoIGNyZWF0ZSApOwoJfSwKCgkvL2NyZWF0ZSBhIHN0cmluZyBmb3IgSUQvc3VicGFnZSB1cmwgY3JlYXRpb24KCV9pZFN0cmluZ0VzY2FwZTogZnVuY3Rpb24oIHN0ciApIHsKCQlyZXR1cm4gc3RyLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCAnLScpOwoJfSwKCglfY3JlYXRlU3ViUGFnZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRMaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gcGFyZW50TGlzdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXBhcmVudFVybCA9IHBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJcGFyZW50SWQgPSBwYXJlbnRVcmwgfHwgcGFyZW50UGFnZVsgMCBdWyAkLmV4cGFuZG8gXSwKCQkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdC5hdHRyKCAiaWQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWRucyA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXMsCgkJCXBlcnNpc3RlbnRGb290ZXJJRCA9IHBhcmVudFBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLmpxbURhdGEoICJpZCIgKSwKCQkJaGFzU3ViUGFnZXM7CgoJCWlmICggdHlwZW9mIGxpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF0gPT09ICJ1bmRlZmluZWQiICkgewoJCQlsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID0gLTE7CgkJfQoKCQlwYXJlbnRMaXN0SWQgPSBwYXJlbnRMaXN0SWQgfHwgKytsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdOwoKCQkkKCBwYXJlbnRMaXN0LmZpbmQoICJsaT51bCwgbGk+b2wiICkudG9BcnJheSgpLnJldmVyc2UoKSApLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCWxpc3QgPSAkKCB0aGlzICksCgkJCQlsaXN0SWQgPSBsaXN0LmF0dHIoICJpZCIgKSB8fCBwYXJlbnRMaXN0SWQgKyAiLSIgKyBpLAoJCQkJcGFyZW50ID0gbGlzdC5wYXJlbnQoKSwKCQkJCW5vZGVFbHMgPSAkKCBsaXN0LnByZXZBbGwoKS50b0FycmF5KCkucmV2ZXJzZSgpICksCgkJCQlub2RlRWxzID0gbm9kZUVscy5sZW5ndGggPyBub2RlRWxzIDogJCggIjxzcGFuPiIgKyAkLnRyaW0ocGFyZW50LmNvbnRlbnRzKClbIDAgXS5ub2RlVmFsdWUpICsgIjwvc3Bhbj4iICksCgkJCQl0aXRsZSA9IG5vZGVFbHMuZmlyc3QoKS5nZXRFbmNvZGVkVGV4dCgpLC8vdXJsIGxpbWl0cyB0byBmaXJzdCAzMCBjaGFycyBvZiB0ZXh0CgkJCQlpZCA9ICggcGFyZW50VXJsIHx8ICIiICkgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIj0iICsgbGlzdElkLAoJCQkJdGhlbWUgPSBsaXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lLAoJCQkJY291bnRUaGVtZSA9IGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgcGFyZW50TGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCBvLmNvdW50VGhlbWUsCgkJCQluZXdQYWdlLCBhbmNob3I7CgoJCQkvL2RlZmluZSBoYXNTdWJQYWdlcyBmb3IgdXNlIGluIGxhdGVyIHJlbW92YWwKCQkJaGFzU3ViUGFnZXMgPSB0cnVlOwoKCQkJbmV3UGFnZSA9IGxpc3QuZGV0YWNoKCkKCQkJCQkJLndyYXAoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0ncGFnZScgIiArCWRucyArICJ1cmw9JyIgKyBpZCArICInICIgKyBkbnMgKyAidGhlbWU9JyIgKyB0aGVtZSArICInICIgKyBkbnMgKyAiY291bnQtdGhlbWU9JyIgKyBjb3VudFRoZW1lICsgIic+PGRpdiAiICsgZG5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkucGFyZW50KCkKCQkJCQkJCS5iZWZvcmUoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0naGVhZGVyJyAiICsgZG5zICsgInRoZW1lPSciICsgby5oZWFkZXJUaGVtZSArICInPjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgdGl0bGUgKyAiPC9kaXY+PC9kaXY+IiApCgkJCQkJCQkuYWZ0ZXIoIHBlcnNpc3RlbnRGb290ZXJJRCA/ICQoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0nZm9vdGVyJyAiICsgZG5zICsgImlkPSciKyBwZXJzaXN0ZW50Rm9vdGVySUQgKyInPiIpIDogIiIgKQoJCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkJLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQluZXdQYWdlLnBhZ2UoKTsKCgkJCWFuY2hvciA9IHBhcmVudC5maW5kKCdhOmZpcnN0Jyk7CgoJCQlpZiAoICFhbmNob3IubGVuZ3RoICkgewoJCQkJYW5jaG9yID0gJCggIjxhLz4iICkuaHRtbCggbm9kZUVscyB8fCB0aXRsZSApLnByZXBlbmRUbyggcGFyZW50LmVtcHR5KCkgKTsKCQkJfQoKCQkJYW5jaG9yLmF0dHIoICJocmVmIiwgIiMiICsgaWQgKTsKCgkJfSkubGlzdHZpZXcoKTsKCgkJLy8gb24gcGFnZWhpZGUsIHJlbW92ZSBhbnkgbmVzdGVkIHBhZ2VzIGFsb25nIHdpdGggdGhlIHBhcmVudCBwYWdlLCBhcyBsb25nIGFzIHRoZXkgYXJlbid0IGFjdGl2ZQoJCS8vIGFuZCBhcmVuJ3QgZW1iZWRkZWQKCQlpZiggaGFzU3ViUGFnZXMgJiYKCQkJcGFyZW50UGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSAmJgoJCQlwYXJlbnRQYWdlLmRhdGEoInBhZ2UiKS5vcHRpb25zLmRvbUNhY2hlID09PSBmYWxzZSApIHsKCgkJCXZhciBuZXdSZW1vdmUgPSBmdW5jdGlvbiggZSwgdWkgKXsKCQkJCXZhciBuZXh0UGFnZSA9IHVpLm5leHRQYWdlLCBucFVSTDsKCgkJCQlpZiggdWkubmV4dFBhZ2UgKXsKCQkJCQlucFVSTCA9IG5leHRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCQkJaWYoIG5wVVJMLmluZGV4T2YoIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSAhPT0gMCApewoJCQkJCQlzZWxmLmNoaWxkUGFnZXMoKS5yZW1vdmUoKTsKCQkJCQkJcGFyZW50UGFnZS5yZW1vdmUoKTsKCQkJCQl9CgkJCQl9CgkJCX07CgoJCQkvLyB1bmJpbmQgdGhlIG9yaWdpbmFsIHBhZ2UgcmVtb3ZlIGFuZCByZXBsYWNlIHdpdGggb3VyIHNwZWNpYWxpemVkIHZlcnNpb24KCQkJcGFyZW50UGFnZQoJCQkJLnVuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIgKQoJCQkJLmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiLCBuZXdSZW1vdmUpOwoJCX0KCX0sCgoJLy8gVE9ETyBzb3J0IG91dCBhIGJldHRlciB3YXkgdG8gdHJhY2sgc3ViIHBhZ2VzIG9mIHRoZSBsaXN0dmlldyB0aGlzIGlzIGJyaXR0bGUKCWNoaWxkUGFnZXM6IGZ1bmN0aW9uKCl7CgkJdmFyIHBhcmVudFVybCA9IHRoaXMucGFyZW50UGFnZS5qcW1EYXRhKCAidXJsIiApOwoKCQlyZXR1cm4gJCggIjpqcW1EYXRhKHVybF49JyIrICBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsiJykiKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyoKKiAiY2hlY2tib3hyYWRpbyIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNoZWNrYm94cmFkaW8iLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdjaGVja2JveCddLGlucHV0W3R5cGU9J3JhZGlvJ10iCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJaW5oZXJpdEF0dHIgPSBmdW5jdGlvbiggaW5wdXQsIGRhdGFBdHRyICkgewoJCQkJcmV0dXJuIGlucHV0LmpxbURhdGEoIGRhdGFBdHRyICkgfHwgaW5wdXQuY2xvc2VzdCggImZvcm0sZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKQoJCQl9LAoJCQkvLyBOT1RFOiBXaW5kb3dzIFBob25lIGNvdWxkIG5vdCBmaW5kIHRoZSBsYWJlbCB0aHJvdWdoIGEgc2VsZWN0b3IKCQkJLy8gZmlsdGVyIHdvcmtzIHRob3VnaC4KCQkJcGFyZW50TGFiZWwgPSAkKCBpbnB1dCApLmNsb3Nlc3QoICJsYWJlbCIgKSwKCQkJbGFiZWwgPSBwYXJlbnRMYWJlbC5sZW5ndGggPyBwYXJlbnRMYWJlbCA6ICQoIGlucHV0ICkuY2xvc2VzdCggImZvcm0sZmllbGRzZXQsOmpxbURhdGEocm9sZT0ncGFnZScpLDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpbmQoICJsYWJlbCIgKS5maWx0ZXIoICJbZm9yPSciICsgaW5wdXRbMF0uaWQgKyAiJ10iICksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCW1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApLAoJCQljaGVja2VkU3RhdGUgPSBpbnB1dHR5cGUgKyAiLW9uIiwKCQkJdW5jaGVja2VkU3RhdGUgPSBpbnB1dHR5cGUgKyAiLW9mZiIsCgkJCWljb24gPSBpbnB1dC5wYXJlbnRzKCAiOmpxbURhdGEodHlwZT0naG9yaXpvbnRhbCcpIiApLmxlbmd0aCA/IHVuZGVmaW5lZCA6IHVuY2hlY2tlZFN0YXRlLAoJCQlpY29ucG9zID0gaW5oZXJpdEF0dHIoIGlucHV0LCAiaWNvbnBvcyIgKSwKCQkJYWN0aXZlQnRuID0gaWNvbiA/ICIiIDogIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgY2hlY2tlZFN0YXRlICsgYWN0aXZlQnRuLAoJCQl1bmNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgdW5jaGVja2VkU3RhdGUsCgkJCWNoZWNrZWRpY29uID0gInVpLWljb24tIiArIGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkaWNvbiA9ICJ1aS1pY29uLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlsYWJlbDogbGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZGljb24sCgkJCXVuY2hlY2tlZGljb246IHVuY2hlY2tlZGljb24KCQl9KTsKCgkJLy8gSWYgdGhlcmUncyBubyBzZWxlY3RlZCB0aGVtZSBjaGVjayB0aGUgZGF0YSBhdHRyCgkJaWYoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMub3B0aW9ucy50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApOwoJCX0KCgkJbGFiZWwuYnV0dG9uTWFya3VwKHsKCQkJdGhlbWU6IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJaWNvbjogaWNvbiwKCQkJc2hhZG93OiBmYWxzZSwKCQkJbWluaTogbWluaSwKCQkJaWNvbnBvczogaWNvbnBvcwoJCX0pOwoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICd1aS0nICsgaW5wdXR0eXBlOwoKCQlpbnB1dC5hZGQoIGxhYmVsICkud3JhcEFsbCggd3JhcHBlciApOwoKCQlsYWJlbC5iaW5kKHsKCQkJdm1vdXNlb3ZlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAkKCB0aGlzICkucGFyZW50KCkuaXMoICIudWktZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCX0sCgoJCQl2Y2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgoJCQkJaW5wdXQucHJvcCggImNoZWNrZWQiLCBpbnB1dHR5cGUgPT09ICJyYWRpbyIgJiYgdHJ1ZSB8fCAhaW5wdXQucHJvcCggImNoZWNrZWQiICkgKTsKCgkJCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCQkJLy8gaG93IGxhYmVsIGNsaWNrcyBiZWhhdmUgbm9ybWFsbHkgaW4gdGhlIGJyb3dzZXJzCgkJCQkvLyBUT0RPOiBpdCB3b3VsZCBiZSBuaWNlIHRvIGxldCB0aGUgYnJvd3NlcidzIGhhbmRsZSB0aGUgY2xpY2tzIGFuZCBwYXNzIHRoZW0KCQkJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJCQkvLyAgICAgICB3cmFwcGVyIGVsZW1lbnQgbGV2ZWwKCQkJCWlucHV0LnRyaWdnZXJIYW5kbGVyKCAnY2xpY2snICk7CgoJCQkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCQkJLy8gYnV0dG9ucywgYnV0IHdpbGwgbm90IGZvciBjaGVja2JveGVzLiBjbGVhcmluZyB0aGUgY2hlY2tlZCBzdGF0dXMKCQkJCS8vIG9mIG90aGVyIHJhZGlvcyBlbnN1cmVzIHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlIGlzIGFwcGxpZWQgcHJvcGVybHkKCQkJCXNlbGYuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoKCQlpbnB1dAoJCQkuYmluZCh7CgkJCQl2bW91c2Vkb3duOiBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLl9jYWNoZVZhbHMoKTsKCQkJCX0sCgoJCQkJdmNsaWNrOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJCQkJaWYgKCAkdGhpcy5pcyggIjpjaGVja2VkIiApICkgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCB0cnVlKTsKCQkJCQkJc2VsZi5fZ2V0SW5wdXRTZXQoKS5ub3QoJHRoaXMpLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQl9LAoKCQkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCQlsYWJlbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfSwKCgkJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCQlsYWJlbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfQoJCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9jYWNoZVZhbHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaChmdW5jdGlvbigpIHsKCQkJJCh0aGlzKS5qcW1EYXRhKCAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy9yZXR1cm5zIGVpdGhlciBhIHNldCBvZiByYWRpb3Mgd2l0aCB0aGUgc2FtZSBuYW1lIGF0dHJpYnV0ZSwgb3IgYSBzaW5nbGUgY2hlY2tib3gKCV9nZXRJbnB1dFNldDogZnVuY3Rpb24oKXsKCQlpZih0aGlzLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IikgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJCX0KCgkJcmV0dXJuIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSxmaWVsZHNldCw6anFtRGF0YShyb2xlPSdwYWdlJykiICkKCQkJLmZpbmQoICJpbnB1dFtuYW1lPSciKyB0aGlzLmVsZW1lbnRbMF0ubmFtZSArIiddW3R5cGU9JyIrIHRoaXMuaW5wdXR0eXBlICsiJ10iICk7Cgl9LAoKCV91cGRhdGVBbGw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJaWYgKCB0aGlzLmNoZWNrZWQgfHwgc2VsZi5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudFswXSwKCQkJbGFiZWwgPSB0aGlzLmxhYmVsLAoJCQlpY29uID0gbGFiZWwuZmluZCggIi51aS1pY29uIiApOwoKCQlpZiAoIGlucHV0LmNoZWNrZWQgKSB7CgkJCWxhYmVsLmFkZENsYXNzKCB0aGlzLmNoZWNrZWRDbGFzcyApLnJlbW92ZUNsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICk7CgkJCWljb24uYWRkQ2xhc3MoIHRoaXMuY2hlY2tlZGljb24gKS5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRpY29uICk7CgkJfSBlbHNlIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoIHRoaXMuY2hlY2tlZENsYXNzICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQkJaWNvbi5yZW1vdmVDbGFzcyggdGhpcy5jaGVja2VkaWNvbiApLmFkZENsYXNzKCB0aGlzLnVuY2hlY2tlZGljb24gKTsKCQl9CgoJCWlmICggaW5wdXQuZGlzYWJsZWQgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuZW5hYmxlKCk7CgkJfQoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdHJ1ZSApLnBhcmVudCgpLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIGZhbHNlICkucGFyZW50KCkucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuY2hlY2tib3hyYWRpby5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQlpbmxpbmU6IGZhbHNlLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IHRydWUsCgkJaW5pdFNlbGVjdG9yOiAiYnV0dG9uLCBbdHlwZT0nYnV0dG9uJ10sIFt0eXBlPSdzdWJtaXQnXSwgW3R5cGU9J3Jlc2V0J10sIFt0eXBlPSdpbWFnZSddIiwKCQltaW5pOiBmYWxzZQoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCSRidXR0b24sCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXR5cGUsCgkJCW5hbWUsCgkJCWNsYXNzZXMgPSAiIiwKCQkJJGJ1dHRvblBsYWNlaG9sZGVyOwoKCQkvLyBpZiB0aGlzIGlzIGEgbGluaywgY2hlY2sgaWYgaXQncyBiZWVuIGVuaGFuY2VkIGFuZCwgaWYgbm90LCB1c2UgdGhlIHJpZ2h0IGZ1bmN0aW9uCgkJaWYoICRlbFsgMCBdLnRhZ05hbWUgPT09ICJBIiApIHsKCSAJIAkhJGVsLmhhc0NsYXNzKCAidWktYnRuIiApICYmICRlbC5idXR0b25NYXJrdXAoKTsKCSAJIAlyZXR1cm47CiAJIAl9CgoJCS8vIGdldCB0aGUgaW5oZXJpdGVkIHRoZW1lCgkJLy8gVE9ETyBjZW50cmFsaXplIGZvciBhbGwgd2lkZ2V0cwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYoICEhfiRlbFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmKCAgISF+JGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1yaWdodCI7CgkJfQoKCQkvLyBBZGQgQVJJQSByb2xlCgkJdGhpcy5idXR0b24gPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJLnRleHQoICRlbC50ZXh0KCkgfHwgJGVsLnZhbCgpICkKCQkJLmluc2VydEJlZm9yZSggJGVsICkKCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQl0aGVtZTogby50aGVtZSwKCQkJCWljb246IG8uaWNvbiwKCQkJCWljb25wb3M6IG8uaWNvbnBvcywKCQkJCWlubGluZTogby5pbmxpbmUsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQlzaGFkb3c6IG8uc2hhZG93LAoJCQkJaWNvbnNoYWRvdzogby5pY29uc2hhZG93LAoJCQkJbWluaTogby5taW5pCgkJCX0pCgkJCS5hZGRDbGFzcyggY2xhc3NlcyApCgkJCS5hcHBlbmQoICRlbC5hZGRDbGFzcyggInVpLWJ0bi1oaWRkZW4iICkgKTsKCiAgICAgICAgJGJ1dHRvbiA9IHRoaXMuYnV0dG9uOwoJCXR5cGUgPSAkZWwuYXR0ciggInR5cGUiICk7CgkJbmFtZSA9ICRlbC5hdHRyKCAibmFtZSIgKTsKCgkJLy8gQWRkIGhpZGRlbiBpbnB1dCBkdXJpbmcgc3VibWl0IGlmIGlucHV0IHR5cGU9InN1Ym1pdCIgaGFzIGEgbmFtZS4KCQlpZiAoIHR5cGUgIT09ICJidXR0b24iICYmIHR5cGUgIT09ICJyZXNldCIgJiYgbmFtZSApIHsKCQkJCSRlbC5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCQkJLy8gQWRkIGhpZGRlbiBpbnB1dCBpZiBpdCBkb2VzbuKAmXQgYWxyZWFkeSBleGlzdC4KCQkJCQlpZiggJGJ1dHRvblBsYWNlaG9sZGVyID09PSB1bmRlZmluZWQgKSB7CgkJCQkJCSRidXR0b25QbGFjZWhvbGRlciA9ICQoICI8aW5wdXQ+IiwgewoJCQkJCQkJdHlwZTogImhpZGRlbiIsCgkJCQkJCQluYW1lOiAkZWwuYXR0ciggIm5hbWUiICksCgkJCQkJCQl2YWx1ZTogJGVsLmF0dHIoICJ2YWx1ZSIgKQoJCQkJCQl9KS5pbnNlcnRCZWZvcmUoICRlbCApOwoKCQkJCQkJLy8gQmluZCB0byBkb2MgdG8gcmVtb3ZlIGFmdGVyIHN1Ym1pdCBoYW5kbGluZwoJCQkJCQkkKCBkb2N1bWVudCApLm9uZSgic3VibWl0IiwgZnVuY3Rpb24oKXsKCQkJCQkJCSRidXR0b25QbGFjZWhvbGRlci5yZW1vdmUoKTsKCgkJCQkJCQkvLyByZXNldCB0aGUgbG9jYWwgdmFyIHNvIHRoYXQgdGhlIGhpZGRlbiBpbnB1dAoJCQkJCQkJLy8gd2lsbCBiZSByZS1hZGRlZCBvbiBzdWJzZXF1ZW50IGNsaWNrcwoJCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyID0gdW5kZWZpbmVkOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9KTsKCQl9CgogICAgICAgICRlbC5iaW5kKHsKICAgICAgICAgICAgZm9jdXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJGJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYmx1cjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCAkZWwucHJvcCgiZGlzYWJsZWQiKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9CgoJCS8vIEdyYWIgdGhlIGJ1dHRvbidzIHRleHQgZWxlbWVudCBmcm9tIGl0cyBpbXBsZW1lbnRhdGlvbi1pbmRlcGVuZGVudCBkYXRhIGl0ZW0KCQkkKCB0aGlzLmJ1dHRvbi5kYXRhKCAnYnV0dG9uRWxlbWVudHMnICkudGV4dCApLnRleHQoICRlbC50ZXh0KCkgfHwgJGVsLnZhbCgpICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQubW9iaWxlLmJ1dHRvbi5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uY29udHJvbGdyb3VwID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglmdW5jdGlvbiBmbGlwQ2xhc3NlcyggZWxzLCBmbENvcm5lcnMgICkgewoJCWVscy5yZW1vdmVDbGFzcyggInVpLWJ0bi1jb3JuZXItYWxsIHVpLXNoYWRvdyIgKQoJCQkuZXEoIDAgKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAwIF0gKQoJCQkuZW5kKCkKCQkJLmxhc3QoKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAxIF0gKS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC1sYXN0IiApOwoJfQoKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCQkJZGlyZWN0aW9uOiAkZWwuanFtRGF0YSggInR5cGUiICkgfHwgInZlcnRpY2FsIiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJZXhjbHVkZUludmlzaWJsZTogdHJ1ZSwKCQkJCQkJbWluaTogJGVsLmpxbURhdGEoICJtaW5pIiApCgkJCQkJfSwgb3B0aW9ucyApLAoJCQlncm91cGhlYWRpbmcgPSAkZWwuY2hpbGRyZW4oICJsZWdlbmQiICksCgkJCWZsQ29ybmVycyA9IG8uZGlyZWN0aW9uID09ICJob3Jpem9udGFsIiA/IFsgInVpLWNvcm5lci1sZWZ0IiwgInVpLWNvcm5lci1yaWdodCIgXSA6IFsgInVpLWNvcm5lci10b3AiLCAidWktY29ybmVyLWJvdHRvbSIgXSwKCQkJdHlwZSA9ICRlbC5maW5kKCAiaW5wdXQiICkuZmlyc3QoKS5hdHRyKCAidHlwZSIgKTsKCgkJLy8gUmVwbGFjZSBsZWdlbmQgd2l0aCBtb3JlIHN0eWxhYmxlIHJlcGxhY2VtZW50IGRpdgoJCWlmICggZ3JvdXBoZWFkaW5nLmxlbmd0aCApIHsKCQkJJGVsLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyc+PC9kaXY+IiApOwoJCQkkKCAiPGRpdiByb2xlPSdoZWFkaW5nJyBjbGFzcz0ndWktY29udHJvbGdyb3VwLWxhYmVsJz4iICsgZ3JvdXBoZWFkaW5nLmh0bWwoKSArICI8L2Rpdj4iICkuaW5zZXJ0QmVmb3JlKCAkZWwuY2hpbGRyZW4oMCkgKTsKCQkJZ3JvdXBoZWFkaW5nLnJlbW92ZSgpOwoJCX0KCgkJJGVsLmFkZENsYXNzKCAidWktY29ybmVyLWFsbCB1aS1jb250cm9sZ3JvdXAgdWktY29udHJvbGdyb3VwLSIgKyBvLmRpcmVjdGlvbiApOwoKCQlmbGlwQ2xhc3NlcyggJGVsLmZpbmQoICIudWktYnRuIiArICggby5leGNsdWRlSW52aXNpYmxlID8gIjp2aXNpYmxlIiA6ICIiICkgKS5ub3QoJy51aS1zbGlkZXItaGFuZGxlJyksIGZsQ29ybmVycyApOwoJCWZsaXBDbGFzc2VzKCAkZWwuZmluZCggIi51aS1idG4taW5uZXIiICksIGZsQ29ybmVycyApOwoKCQlpZiAoIG8uc2hhZG93ICkgewoJCQkkZWwuYWRkQ2xhc3MoICJ1aS1zaGFkb3ciICk7CgkJfQoKCQlpZiAoIG8ubWluaSApIHsKCQkJJGVsLmFkZENsYXNzKCAidWktbWluaSIgKTsKCQl9CgoJfSk7Cn07CgovLyBUaGUgcGFnZWNyZWF0ZSBoYW5kbGVyIGZvciBjb250cm9sZ3JvdXAgaXMgaW4ganF1ZXJ5Lm1vYmlsZS5pbml0IGJlY2F1c2Ugb2YgdGhlIHNvZnQtZGVwZW5kZW5jeSBvbiB0aGUgd3JhcHBlZCB3aWRnZXRzCgp9KShqUXVlcnkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcywgdGVzdHMgaW5jbHVkZWQgd2l0aCBwYWdlCgkkKCBlLnRhcmdldCApCgkJLmZpbmQoICJhIiApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkubm90KCAiLnVpLWJ0biwgLnVpLWxpbmstaW5oZXJpdCwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYWRkQ2xhc3MoICJ1aS1saW5rIiApOwoKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKCBmdW5jdGlvbiggJCApIHsKCXZhcgltZXRhID0gJCggIm1ldGFbbmFtZT12aWV3cG9ydF0iICksCiAgICAgICAgaW5pdGlhbENvbnRlbnQgPSBtZXRhLmF0dHIoICJjb250ZW50IiApLAogICAgICAgIGRpc2FibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iLAogICAgICAgIGVuYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MTAsIHVzZXItc2NhbGFibGU9eWVzIiwKCQlkaXNhYmxlZEluaXRpYWxseSA9IC8odXNlci1zY2FsYWJsZVtcc10qPVtcc10qbm8pfChtYXhpbXVtLXNjYWxlW1xzXSo9W1xzXSoxKVskLFxzXS8udGVzdCggaW5pdGlhbENvbnRlbnQgKTsKCQoJJC5tb2JpbGUuem9vbSA9ICQuZXh0ZW5kKCB7fSwgewoJCWVuYWJsZWQ6ICFkaXNhYmxlZEluaXRpYWxseSwKCQlsb2NrZWQ6IGZhbHNlLAoJCWRpc2FibGU6IGZ1bmN0aW9uKCBsb2NrICkgewoJCQlpZiggIWRpc2FibGVkSW5pdGlhbGx5ICYmICEkLm1vYmlsZS56b29tLmxvY2tlZCApewoJICAgICAgICAJbWV0YS5hdHRyKCAiY29udGVudCIsIGRpc2FibGVkWm9vbSApOwoJICAgICAgICAJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gZmFsc2U7CgkJCQkkLm1vYmlsZS56b29tLmxvY2tlZCA9IGxvY2sgfHwgZmFsc2U7CgkJCX0KCQl9LAoJCWVuYWJsZTogZnVuY3Rpb24oIHVubG9jayApIHsKCQkJaWYoICFkaXNhYmxlZEluaXRpYWxseSAmJiAoICEkLm1vYmlsZS56b29tLmxvY2tlZCB8fCB1bmxvY2sgPT09IHRydWUgKSApewoJCSAgICAgICAgbWV0YS5hdHRyKCAiY29udGVudCIsIGVuYWJsZWRab29tICk7CgkJICAgICAgICAkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJcmVzdG9yZTogZnVuY3Rpb24oKSB7CgkJCWlmKCAhZGlzYWJsZWRJbml0aWFsbHkgKXsKCSAgICAgICAgCW1ldGEuYXR0ciggImNvbnRlbnQiLCBpbml0aWFsQ29udGVudCApOwoJICAgICAgICAJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCX0pOwoKfSggalF1ZXJ5ICkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwgaW5wdXRbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCBpbnB1dFt0eXBlPSdudW1iZXInXSwgOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIGlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIGlucHV0W3R5cGU9J2VtYWlsJ10sIGlucHV0W3R5cGU9J3VybCddLCBpbnB1dFt0eXBlPSd0ZWwnXSwgdGV4dGFyZWEsIGlucHV0W3R5cGU9J3RpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZSddLCBpbnB1dFt0eXBlPSdtb250aCddLCBpbnB1dFt0eXBlPSd3ZWVrJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIGlucHV0W3R5cGU9J2NvbG9yJ10sIGlucHV0Om5vdChbdHlwZV0pIiwKCQljbGVhclNlYXJjaEJ1dHRvblRleHQ6ICJjbGVhciB0ZXh0IgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50LAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQl0aGVtZSA9IG8udGhlbWUgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICksCgkJCXRoZW1lY2xhc3MgID0gIiB1aS1ib2R5LSIgKyB0aGVtZSwKCQkJbWluaSA9IGlucHV0LmpxbURhdGEoIm1pbmkiKSA9PSB0cnVlLAoJCQltaW5pY2xhc3MgPSBtaW5pID8gIiB1aS1taW5pIiA6ICIiLAoJCQlmb2N1c2VkRWwsIGNsZWFyYnRuOwoKCQkkKCAibGFiZWxbZm9yPSciICsgaW5wdXQuYXR0ciggImlkIiApICsgIiddIiApLmFkZENsYXNzKCAidWktaW5wdXQtdGV4dCIgKTsKCgkJZm9jdXNlZEVsID0gaW5wdXQuYWRkQ2xhc3MoInVpLWlucHV0LXRleHQgdWktYm9keS0iKyB0aGVtZSApOwoKCQkvLyBYWFg6IFRlbXBvcmFyeSB3b3JrYXJvdW5kIGZvciBpc3N1ZSA3ODUgKEFwcGxlIGJ1ZyA4OTEwNTg5KS4KCQkvLyAgICAgIFR1cm4gb2ZmIGF1dG9jb3JyZWN0IGFuZCBhdXRvY29tcGxldGUgb24gbm9uLWlPUyA1IGRldmljZXMKCQkvLyAgICAgIHNpbmNlIHRoZSBwb3B1cCB0aGV5IHVzZSBjYW4ndCBiZSBkaXNtaXNzZWQgYnkgdGhlIHVzZXIuIE5vdGUKCQkvLyAgICAgIHRoYXQgd2UgdGVzdCBmb3IgdGhlIHByZXNlbmNlIG9mIHRoZSBmZWF0dXJlIGJ5IGxvb2tpbmcgZm9yCgkJLy8gICAgICB0aGUgYXV0b2NvcnJlY3QgcHJvcGVydHkgb24gdGhlIGlucHV0IGVsZW1lbnQuIFdlIGN1cnJlbnRseQoJCS8vICAgICAgaGF2ZSBubyB0ZXN0IGZvciBpT1MgNSBvciBuZXdlciBzbyB3ZSdyZSB0ZW1wb3JhcmlseSB1c2luZwoJCS8vICAgICAgdGhlIHRvdWNoT3ZlcmZsb3cgc3VwcG9ydCBmbGFnIGZvciBqUU0gMS4wLiBZZXMsIEkgZmVlbCBkaXJ0eS4gLSBqYmxhcwoJCWlmICggdHlwZW9mIGlucHV0WzBdLmF1dG9jb3JyZWN0ICE9PSAidW5kZWZpbmVkIiAmJiAhJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgKSB7CgkJCS8vIFNldCB0aGUgYXR0cmlidXRlIGluc3RlYWQgb2YgdGhlIHByb3BlcnR5IGp1c3QgaW4gY2FzZSB0aGVyZQoJCQkvLyBpcyBjb2RlIHRoYXQgYXR0ZW1wdHMgdG8gbWFrZSBtb2RpZmljYXRpb25zIHZpYSBIVE1MLgoJCQlpbnB1dFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29ycmVjdCIsICJvZmYiICk7CgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb21wbGV0ZSIsICJvZmYiICk7CgkJfQoKCgkJLy8ic2VhcmNoIiBpbnB1dCB3aWRnZXQKCQlpZiAoIGlucHV0LmlzKCAiW3R5cGU9J3NlYXJjaCddLDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApICkgewoKCQkJZm9jdXNlZEVsID0gaW5wdXQud3JhcCggIjxkaXYgY2xhc3M9J3VpLWlucHV0LXNlYXJjaCB1aS1zaGFkb3ctaW5zZXQgdWktYnRuLWNvcm5lci1hbGwgdWktYnRuLXNoYWRvdyB1aS1pY29uLXNlYXJjaGZpZWxkIiArIHRoZW1lY2xhc3MgKyBtaW5pY2xhc3MgKyAiJz48L2Rpdj4iICkucGFyZW50KCk7CgkJCWNsZWFyYnRuID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1pbnB1dC1jbGVhcicgdGl0bGU9JyIgKyBvLmNsZWFyU2VhcmNoQnV0dG9uVGV4dCArICInPiIgKyBvLmNsZWFyU2VhcmNoQnV0dG9uVGV4dCArICI8L2E+IiApCgkJCQkuYmluZCgnY2xpY2snLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaW5wdXQKCQkJCQkJLnZhbCggIiIgKQoJCQkJCQkuZm9jdXMoKQoJCQkJCQkudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCQljbGVhcmJ0bi5hZGRDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIgKTsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfSkKCQkJCS5hcHBlbmRUbyggZm9jdXNlZEVsICkKCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCWljb246ICJkZWxldGUiLAoJCQkJCWljb25wb3M6ICJub3RleHQiLAoJCQkJCWNvcm5lcnM6IHRydWUsCgkJCQkJc2hhZG93OiB0cnVlLAoJCQkJCW1pbmk6IG1pbmkKCQkJCX0pOwoKCQkJZnVuY3Rpb24gdG9nZ2xlQ2xlYXIoKSB7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCWNsZWFyYnRuLnRvZ2dsZUNsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiwgIWlucHV0LnZhbCgpICk7CgkJCQl9LCAwKTsKCQkJfQoKCQkJdG9nZ2xlQ2xlYXIoKTsKCgkJCWlucHV0LmJpbmQoJ3Bhc3RlIGN1dCBrZXl1cCBmb2N1cyBjaGFuZ2UgYmx1cicsIHRvZ2dsZUNsZWFyKTsKCgkJfSBlbHNlIHsKCQkJaW5wdXQuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLXNoYWRvdy1pbnNldCIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICk7CgkJfQoKCQlpbnB1dC5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCWZvY3VzZWRFbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmx1cihmdW5jdGlvbigpewoJCQkJZm9jdXNlZEVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS8vIEluIG1hbnkgc2l0dWF0aW9ucywgaU9TIHdpbGwgem9vbSBpbnRvIHRoZSBzZWxlY3QgdXBvbiB0YXAsIHRoaXMgcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCQkuYmluZCggImZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiggby5wcmV2ZW50Rm9jdXNab29tICl7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCQl9CgkJCX0pCgkJCS5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJaWYoIG8ucHJldmVudEZvY3VzWm9vbSApewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9CgkJCX0pOwoKCQkvLyBBdXRvZ3JvdwoJCWlmICggaW5wdXQuaXMoICJ0ZXh0YXJlYSIgKSApIHsKCQkJdmFyIGV4dHJhTGluZUhlaWdodCA9IDE1LAoJCQkJa2V5dXBUaW1lb3V0QnVmZmVyID0gMTAwLAoJCQkJa2V5dXAgPSBmdW5jdGlvbigpIHsKCQkJCQl2YXIgc2Nyb2xsSGVpZ2h0ID0gaW5wdXRbIDAgXS5zY3JvbGxIZWlnaHQsCgkJCQkJCWNsaWVudEhlaWdodCA9IGlucHV0WyAwIF0uY2xpZW50SGVpZ2h0OwoKCQkJCQlpZiAoIGNsaWVudEhlaWdodCA8IHNjcm9sbEhlaWdodCApIHsKCQkJCQkJaW5wdXQuaGVpZ2h0KHNjcm9sbEhlaWdodCArIGV4dHJhTGluZUhlaWdodCk7CgkJCQkJfQoJCQkJfSwKCQkJCWtleXVwVGltZW91dDsKCgkJCWlucHV0LmtleXVwKGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KCBrZXl1cFRpbWVvdXQgKTsKCQkJCWtleXVwVGltZW91dCA9IHNldFRpbWVvdXQoIGtleXVwLCBrZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQkJfSk7CgoJCQkvLyBiaW5kaW5nIHRvIHBhZ2VjaGFuZ2UgaGVyZSBlbnN1cmVzIHRoYXQgZm9yIHBhZ2VzIGxvYWRlZCB2aWEKCQkJLy8gYWpheCB0aGUgaGVpZ2h0IGlzIHJlY2FsY3VsYXRlZCB3aXRob3V0IHVzZXIgaW5wdXQKCQkJJCggZG9jdW1lbnQgKS5vbmUoICJwYWdlY2hhbmdlIiwga2V5dXAgKTsKCgkJCS8vIElzc3VlIDUwOTogdGhlIGJyb3dzZXIgaXMgbm90IHByb3ZpZGluZyBzY3JvbGxIZWlnaHQgcHJvcGVybHkgdW50aWwgdGhlIHN0eWxlcyBsb2FkCgkJCWlmICggJC50cmltKCBpbnB1dC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCSQoIHdpbmRvdyApLmxvYWQoIGtleXVwICk7CgkJCX0KCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCl7CgkJKCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApLmlzKCAiW3R5cGU9J3NlYXJjaCddLDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApID8KCQkJdGhpcy5lbGVtZW50LnBhcmVudCgpIDogdGhpcy5lbGVtZW50ICkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpewoJCSggdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlKS5pcyggIlt0eXBlPSdzZWFyY2gnXSw6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSA/CgkJCXRoaXMuZWxlbWVudC5wYXJlbnQoKSA6IHRoaXMuZWxlbWVudCApLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQubW9iaWxlLnRleHRpbnB1dC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlciA9IGZhbHNlOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciA9ICJGaWx0ZXIgaXRlbXMuLi4iOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJUaGVtZSA9ICJjIjsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggdGV4dCwgc2VhcmNoVmFsdWUgKXsKCXJldHVybiB0ZXh0LnRvTG93ZXJDYXNlKCkuaW5kZXhPZiggc2VhcmNoVmFsdWUgKSA9PT0gLTE7Cn07CgokKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiOmpxbURhdGEocm9sZT0nbGlzdHZpZXcnKSIsICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCWxpc3R2aWV3ID0gbGlzdC5kYXRhKCAibGlzdHZpZXciICk7CgoJaWYgKCAhbGlzdHZpZXcub3B0aW9ucy5maWx0ZXIgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB3cmFwcGVyID0gJCggIjxmb3JtPiIsIHsKCQkJImNsYXNzIjogInVpLWxpc3R2aWV3LWZpbHRlciB1aS1iYXItIiArIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyVGhlbWUsCgkJCSJyb2xlIjogInNlYXJjaCIKCQl9KSwKCQlzZWFyY2ggPSAkKCAiPGlucHV0PiIsIHsKCQkJcGxhY2Vob2xkZXI6IGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIKCQl9KQoJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZSIsICJzZWFyY2giICkKCQkuanFtRGF0YSggImxhc3R2YWwiLCAiIiApCgkJLmJpbmQoICJrZXl1cCBjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCgkJCXZhciAkdGhpcyA9ICQodGhpcyksCgkJCQl2YWwgPSB0aGlzLnZhbHVlLnRvTG93ZXJDYXNlKCksCgkJCQlsaXN0SXRlbXMgPSBudWxsLAoJCQkJbGFzdHZhbCA9ICR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiApICsgIiIsCgkJCQljaGlsZEl0ZW1zID0gZmFsc2UsCgkJCQlpdGVtdGV4dCA9ICIiLAoJCQkJaXRlbTsKCgkJCS8vIENoYW5nZSB2YWwgYXMgbGFzdHZhbCBmb3IgbmV4dCBleGVjdXRpb24KCQkJJHRoaXMuanFtRGF0YSggImxhc3R2YWwiICwgdmFsICk7CgkJCWlmICggdmFsLmxlbmd0aCA8IGxhc3R2YWwubGVuZ3RoIHx8IHZhbC5pbmRleE9mKGxhc3R2YWwpICE9PSAwICkgewoKCQkJCS8vIFJlbW92ZWQgY2hhcnMgb3IgcGFzdGVkIHNvbWV0aGluZyB0b3RhbGx5IGRpZmZlcmVudCwgY2hlY2sgYWxsIGl0ZW1zCgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gT25seSBjaGFycyBhZGRlZCwgbm90IHJlbW92ZWQsIG9ubHkgdXNlIHZpc2libGUgc3Vic2V0CgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiOm5vdCgudWktc2NyZWVuLWhpZGRlbikiICk7CgkJCX0KCgkJCWlmICggdmFsICkgewoKCQkJCS8vIFRoaXMgaGFuZGxlcyBoaWRpbmcgcmVndWxhciByb3dzIHdpdGhvdXQgdGhlIHRleHQgd2Ugc2VhcmNoIGZvcgoJCQkJLy8gYW5kIGFueSBsaXN0IGRpdmlkZXJzIHdpdGhvdXQgcmVndWxhciByb3dzIHNob3duIHVuZGVyIGl0CgoJCQkJZm9yICggdmFyIGkgPSBsaXN0SXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQkJaXRlbSA9ICQoIGxpc3RJdGVtc1sgaSBdICk7CgkJCQkJaXRlbXRleHQgPSBpdGVtLmpxbURhdGEoICJmaWx0ZXJ0ZXh0IiApIHx8IGl0ZW0udGV4dCgpOwoKCQkJCQlpZiAoIGl0ZW0uaXMoICJsaTpqcW1EYXRhKHJvbGU9bGlzdC1kaXZpZGVyKSIgKSApIHsKCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsICFjaGlsZEl0ZW1zICk7CgoJCQkJCQkvLyBOZXcgYnVja2V0IQoJCQkJCQljaGlsZEl0ZW1zID0gZmFsc2U7CgoJCQkJCX0gZWxzZSBpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2soIGl0ZW10ZXh0LCB2YWwgKSApIHsKCgkJCQkJCS8vbWFyayB0byBiZSBoaWRkZW4KCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgdHJ1ZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBUaGVyZSdzIGEgc2hvd24gaXRlbSBpbiB0aGUgYnVja2V0CgkJCQkJCWNoaWxkSXRlbXMgPSB0cnVlOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTaG93IGl0ZW1zLCBub3QgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIjpub3QoLnVpLWZpbHRlci1oaWRlcXVldWUpIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgoJCQkJLy8gSGlkZSBpdGVtcywgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIi51aS1maWx0ZXItaGlkZXF1ZXVlIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIHRydWUgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiLCBmYWxzZSApOwoKCQkJfSBlbHNlIHsKCgkJCQkvL2ZpbHRlcnZhbHVlIGlzIGVtcHR5ID0+IHNob3cgYWxsCgkJCQlsaXN0SXRlbXMudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgZmFsc2UgKTsKCQkJfQoJCQlsaXN0dmlldy5fcmVmcmVzaENvcm5lcnMoKTsKCQl9KQoJCS5hcHBlbmRUbyggd3JhcHBlciApCgkJLnRleHRpbnB1dCgpOwoKCWlmICggbGlzdHZpZXcub3B0aW9ucy5pbnNldCApIHsKCQl3cmFwcGVyLmFkZENsYXNzKCAidWktbGlzdHZpZXctZmlsdGVyLWluc2V0IiApOwoJfQoKCXdyYXBwZXIuYmluZCggInN1Ym1pdCIsIGZ1bmN0aW9uKCkgewoJCXJldHVybiBmYWxzZTsKCX0pCgkuaW5zZXJ0QmVmb3JlKCBsaXN0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJdHJhY2tUaGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBUT0RPOiBFYWNoIG9mIHRoZXNlIHNob3VsZCBoYXZlIGNvbW1lbnRzIGV4cGxhaW4gd2hhdCB0aGV5J3JlIGZvcgoJCXZhciBzZWxmID0gdGhpcywKCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBjb250cm9sLCAiYyIgKSwKCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoKCQkJY1R5cGUgPSBjb250cm9sWyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCgkJCXNlbGVjdENsYXNzID0gKCBjVHlwZSA9PSAic2VsZWN0IiApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCgkJCWxhYmVsSUQgPSBjb250cm9sSUQgKyAiLWxhYmVsIiwKCgkJCWxhYmVsID0gJCggIltmb3I9JyIrIGNvbnRyb2xJRCArIiddIiApLmF0dHIoICJpZCIsIGxhYmVsSUQgKSwKCgkJCXZhbCA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICBjVHlwZSA9PSAiaW5wdXQiICA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfSwKCgkJCW1pbiA9ICBjVHlwZSA9PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoKCQkJbWF4ID0gIGNUeXBlID09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgoJCQlpbmxpbmVDbGFzcyA9ICggdGhpcy5vcHRpb25zLmlubGluZSB8fCBjb250cm9sLmpxbURhdGEoImlubGluZSIpID09IHRydWUgKSA/ICIgdWktc2xpZGVyLWlubGluZSIgOiAiIiwKCgkJCW1pbmlDbGFzcyA9ICggdGhpcy5vcHRpb25zLm1pbmkgfHwgY29udHJvbC5qcW1EYXRhKCJtaW5pIikgKSA/ICIgdWktc2xpZGVyLW1pbmkiIDogIiIsCgoKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpLAoJCQloYW5kbGUgPSAkKCBkb21IYW5kbGUgKSwKCQkJZG9tU2xpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksCgkJCXNsaWRlciA9ICQoIGRvbVNsaWRlciApLAoKCQkJdmFsdWViZyA9IGNvbnRyb2wuanFtRGF0YSgiaGlnaGxpZ2h0IikgJiYgY1R5cGUgIT0gInNlbGVjdCIgPyAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICd1aS1zbGlkZXItYmcgdWktYnRuLWFjdGl2ZSB1aS1idG4tY29ybmVyLWFsbCc7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9KSgpIDogZmFsc2UsCgoJCQlvcHRpb25zOwoKICAgICAgICBkb21IYW5kbGUuc2V0QXR0cmlidXRlKCAnaHJlZicsICIjIiApOwoJCWRvbVNsaWRlci5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCdhcHBsaWNhdGlvbicpOwoJCWRvbVNsaWRlci5jbGFzc05hbWUgPSBbJ3VpLXNsaWRlciAnLHNlbGVjdENsYXNzLCIgdWktYnRuLWRvd24tIix0cmFja1RoZW1lLCcgdWktYnRuLWNvcm5lci1hbGwnLCBpbmxpbmVDbGFzcywgbWluaUNsYXNzXS5qb2luKCIiKTsKCQlkb21IYW5kbGUuY2xhc3NOYW1lID0gJ3VpLXNsaWRlci1oYW5kbGUnOwoJCWRvbVNsaWRlci5hcHBlbmRDaGlsZChkb21IYW5kbGUpOwoKCQloYW5kbGUuYnV0dG9uTWFya3VwKHsgY29ybmVyczogdHJ1ZSwgdGhlbWU6IHRoZW1lLCBzaGFkb3c6IHRydWUgfSkKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJzbGlkZXIiLAoJCQkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkJCSJhcmlhLXZhbHVlbm93IjogdmFsKCksCgkJCQkJImFyaWEtdmFsdWV0ZXh0IjogdmFsKCksCgkJCQkJInRpdGxlIjogdmFsKCksCgkJCQkJImFyaWEtbGFiZWxsZWRieSI6IGxhYmVsSUQKCQkJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCXZhbHVlYmc6IHZhbHVlYmcsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggY1R5cGUgPT0gInNlbGVjdCIgKSB7CgkJCXZhciB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCXdyYXBwZXIuY2xhc3NOYW1lID0gJ3VpLXNsaWRlci1pbm5lcm9mZnNldCc7CgoJCQlmb3IodmFyIGogPSAwLGxlbmd0aCA9IGRvbVNsaWRlci5jaGlsZE5vZGVzLmxlbmd0aDtqIDwgbGVuZ3RoO2orKyl7CgkJCQl3cmFwcGVyLmFwcGVuZENoaWxkKGRvbVNsaWRlci5jaGlsZE5vZGVzW2pdKTsKCQkJfQoKCQkJZG9tU2xpZGVyLmFwcGVuZENoaWxkKHdyYXBwZXIpOwoKCQkJLy8gc2xpZGVyLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLXNsaWRlci1pbm5lcm9mZnNldCc+PC9kaXY+IiApOwoKCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQlvcHRpb25zID0gY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoKCQkJZm9yKHZhciBpID0gMCwgb3B0aW9uc0NvdW50ID0gb3B0aW9ucy5sZW5ndGg7IGkgPCBvcHRpb25zQ291bnQ7IGkrKyl7CgkJCQl2YXIgc2lkZSA9ICFpID8gImIiOiJhIiwKCQkJCQlzbGlkZXJUaGVtZSA9ICFpID8gIiB1aS1idG4tZG93bi0iICsgdHJhY2tUaGVtZSA6KCAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLAoJCQkJCXNsaWRlckxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksCgkJCQkJc2xpZGVySW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbJ3VpLXNsaWRlci1sYWJlbCB1aS1zbGlkZXItbGFiZWwtJyxzaWRlLHNsaWRlclRoZW1lLCIgdWktYnRuLWNvcm5lci1hbGwiXS5qb2luKCIiKTsKCQkJCXNsaWRlckltZy5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCdpbWcnKTsKCQkJCXNsaWRlckltZy5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShvcHRpb25zW2ldLmlubmVySFRNTCkpOwoJCQkJJChzbGlkZXJJbWcpLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0KCgkJCXNlbGYuX2xhYmVscyA9ICQoICIudWktc2xpZGVyLWxhYmVsIiwgc2xpZGVyICk7CgoJCX0KCgkJbGFiZWwuYWRkQ2xhc3MoICJ1aS1zbGlkZXIiICk7CgoJCS8vIG1vbml0b3IgdGhlIGlucHV0IGZvciB1cGRhdGVkIHZhbHVlcwoJCWNvbnRyb2wuYWRkQ2xhc3MoIGNUeXBlID09PSAiaW5wdXQiID8gInVpLXNsaWRlci1pbnB1dCIgOiAidWktc2xpZGVyLXN3aXRjaCIgKQoJCQkuY2hhbmdlKCBmdW5jdGlvbigpIHsKCQkJCS8vIGlmIHRoZSB1c2VyIGRyYWdnZWQgdGhlIGhhbmRsZSwgdGhlICJjaGFuZ2UiIGV2ZW50IHdhcyB0cmlnZ2VyZWQgZnJvbSBpbnNpZGUgcmVmcmVzaCgpOyBkb24ndCBjYWxsIHJlZnJlc2goKSBhZ2FpbgoJCQkJaWYgKCFzZWxmLm1vdXNlTW92ZWQpIHsKCQkJCQlzZWxmLnJlZnJlc2goIHZhbCgpLCB0cnVlICk7CgkJCQl9CgkJCX0pCgkJCS5rZXl1cCggZnVuY3Rpb24oKSB7IC8vIG5lY2Vzc2FyeT8KCQkJCXNlbGYucmVmcmVzaCggdmFsKCksIHRydWUsIHRydWUgKTsKCQkJfSkKCQkJLmJsdXIoIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5yZWZyZXNoKCB2YWwoKSwgdHJ1ZSApOwoJCQl9KTsKCgkJLy8gcHJldmVudCBzY3JlZW4gZHJhZyB3aGVuIHNsaWRlciBhY3RpdmF0ZWQKCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoIHNlbGYuZHJhZ2dpbmcgKSB7CgkJCQkvLyBzZWxmLm1vdXNlTW92ZWQgbXVzdCBiZSB1cGRhdGVkIGJlZm9yZSByZWZyZXNoKCkgYmVjYXVzZSBpdCB3aWxsIGJlIHVzZWQgaW4gdGhlIGNvbnRyb2wgImNoYW5nZSIgZXZlbnQKCQkJCXNlbGYubW91c2VNb3ZlZCA9IHRydWU7CgoJCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIgKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgaW4gc3luYyB3aXRoIHRoZSBtb3VzZQoJCQkJCWhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQl9CgoJCQkJc2VsZi5yZWZyZXNoKCBldmVudCApOwoKCQkJCS8vIG9ubHkgYWZ0ZXIgcmVmcmVzaCgpIHlvdSBjYW4gY2FsY3VsYXRlIHNlbGYudXNlck1vZGlmaWVkCgkJCQlzZWxmLnVzZXJNb2RpZmllZCA9IHNlbGYuYmVmb3JlU3RhcnQgIT09IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoKCQlzbGlkZXIuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXNlbGYuZHJhZ2dpbmcgPSB0cnVlOwoJCQlzZWxmLnVzZXJNb2RpZmllZCA9IGZhbHNlOwoJCQlzZWxmLm1vdXNlTW92ZWQgPSBmYWxzZTsKCgkJCWlmICggY1R5cGUgPT09ICJzZWxlY3QiICkgewoJCQkJc2VsZi5iZWZvcmVTdGFydCA9IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfQoKCQkJc2VsZi5yZWZyZXNoKCBldmVudCApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSkKCQkuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCXNsaWRlci5hZGQoIGRvY3VtZW50ICkKCQkJLmJpbmQoICJ2bW91c2V1cCIsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBzZWxmLmRyYWdnaW5nICkgewoKCQkJCQlzZWxmLmRyYWdnaW5nID0gZmFsc2U7CgoJCQkJCWlmICggY1R5cGUgPT09ICJzZWxlY3QiKSB7CgoJCQkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJCQkJaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCQkJCWlmICggc2VsZi5tb3VzZU1vdmVkICkgewoKCQkJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCQkJaWYgKCBzZWxmLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgPT0gMCA/IDEgOiAwICk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIHsKCQkJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgKTsKCQkJCQkJCX0KCgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCQkvLyB0aGlzIGlzIGp1c3QgYSBjbGljaywgY2hhbmdlIHRoZSB2YWx1ZQoJCQkJCQkJc2VsZi5yZWZyZXNoKCBzZWxmLmJlZm9yZVN0YXJ0ID09IDAgPyAxIDogMCApOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJc2VsZi5tb3VzZU1vdmVkID0gZmFsc2U7CgoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgoJCXNsaWRlci5pbnNlcnRBZnRlciggY29udHJvbCApOwoKCQkvLyBPbmx5IGFkZCBmb2N1cyBjbGFzcyB0byB0b2dnbGUgc3dpdGNoLCBzbGlkZXJzIGdldCBpdCBhdXRvbWF0aWNhbGx5IGZyb20gdWktYnRuCgkJaWYoIGNUeXBlID09ICdzZWxlY3QnICkgewoJCQl0aGlzLmhhbmRsZS5iaW5kKHsKCQkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCQlzbGlkZXIuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0sCgoJCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkJc2xpZGVyLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJdGhpcy5oYW5kbGUuYmluZCh7CgkJCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCgkJCXZtb3VzZWRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmZvY3VzKCk7CgkJCX0sCgoJCQl2Y2xpY2s6IGZhbHNlLAoKCQkJa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIGluZGV4ID0gdmFsKCk7CgoJCQkJaWYgKCBzZWxmLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIEluIGFsbCBjYXNlcyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFuZCBtYXJrIHRoZSBoYW5kbGUgYXMgYWN0aXZlCgkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQkJaWYgKCAhc2VsZi5fa2V5U2xpZGluZyApIHsKCQkJCQkJCXNlbGYuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCQkJJCggdGhpcyApLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCS8vIG1vdmUgdGhlIHNsaWRlciBhY2NvcmRpbmcgdG8gdGhlIGtleXByZXNzCgkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJCQlzZWxmLnJlZnJlc2goIG1pbiApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJCQlzZWxmLnJlZnJlc2goIG1heCApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJCQlzZWxmLnJlZnJlc2goIGluZGV4ICsgc3RlcCApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJCQlzZWxmLnJlZnJlc2goIGluZGV4IC0gc3RlcCApOwoJCQkJCQlicmVhazsKCQkJCX0KCQkJfSwgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgoJCQlrZXl1cDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBzZWxmLl9rZXlTbGlkaW5nICkgewoJCQkJCXNlbGYuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQl9CgkJCX0KCQkJfSk7CgoJCXRoaXMucmVmcmVzaCh1bmRlZmluZWQsIHVuZGVmaW5lZCwgdHJ1ZSk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCB2YWwsIGlzZnJvbUNvbnRyb2wsIHByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoJ2Rpc2FibGVkJykpIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQl2YXIgY29udHJvbCA9IHRoaXMuZWxlbWVudCwgcGVyY2VudCwKCQkJY1R5cGUgPSBjb250cm9sWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCW1pbiA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1heCIgKSApIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmxlbmd0aCAtIDEsCgkJCXN0ZXAgPSAoY1R5cGUgPT09ICJpbnB1dCIgJiYgcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApID4gMCkgPyBwYXJzZUZsb2F0KGNvbnRyb2wuYXR0cigic3RlcCIpKSA6IDE7CgoJCWlmICggdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgKSB7CgkJCXZhciBkYXRhID0gdmFsLAoJCQkJLy8gYSBzbGlnaHQgdG9sZXJhbmNlIGhlbHBlZCBnZXQgdG8gdGhlIGVuZHMgb2YgdGhlIHNsaWRlcgoJCQkJdG9sID0gODsKCQkJaWYgKCAhdGhpcy5kcmFnZ2luZyB8fAoJCQkJCWRhdGEucGFnZVggPCB0aGlzLnNsaWRlci5vZmZzZXQoKS5sZWZ0IC0gdG9sIHx8CgkJCQkJZGF0YS5wYWdlWCA+IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgKyB0aGlzLnNsaWRlci53aWR0aCgpICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXBlcmNlbnQgPSBNYXRoLnJvdW5kKCAoICggZGF0YS5wYWdlWCAtIHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgKSAvIHRoaXMuc2xpZGVyLndpZHRoKCkgKSAqIDEwMCApOwoJCX0gZWxzZSB7CgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSBjVHlwZSA9PT0gImlucHV0IiA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCXZhciBuZXd2YWwgPSAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKyBtaW47CgoJCS8vZnJvbSBqUXVlcnkgVUkgc2xpZGVyLCB0aGUgZm9sbG93aW5nIHNvdXJjZSB3aWxsIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQl2YXIgdmFsTW9kU3RlcCA9ICggbmV3dmFsIC0gbWluICkgJSBzdGVwOwoJCXZhciBhbGlnblZhbHVlID0gbmV3dmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyggdmFsTW9kU3RlcCApICogMiA+PSBzdGVwICkgewoJCQlhbGlnblZhbHVlICs9ICggdmFsTW9kU3RlcCA+IDAgKSA/IHN0ZXAgOiAoIC1zdGVwICk7CgkJfQoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlIGpRdWVyeVVJOiAjNDEyNCkKCQluZXd2YWwgPSBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoNSkgKTsKCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQl0aGlzLmhhbmRsZS5jc3MoICJsZWZ0IiwgcGVyY2VudCArICIlIiApOwoJCXRoaXMuaGFuZGxlLmF0dHIoIHsKCQkJCSJhcmlhLXZhbHVlbm93IjogY1R5cGUgPT09ICJpbnB1dCIgPyBuZXd2YWwgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSwKCQkJCSJhcmlhLXZhbHVldGV4dCI6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpLAoJCQkJdGl0bGU6IGNUeXBlID09PSAiaW5wdXQiID8gbmV3dmFsIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpCgkJCX0pOwoJCXRoaXMudmFsdWViZyAmJiB0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgoJCS8vIGRyYWcgdGhlIGxhYmVsIHdpZHRocwoJCWlmICggdGhpcy5fbGFiZWxzICkgewoJCQl2YXIgaGFuZGxlUGVyY2VudCA9IHRoaXMuaGFuZGxlLndpZHRoKCkgLyB0aGlzLnNsaWRlci53aWR0aCgpICogMTAwLAoJCQkJYVBlcmNlbnQgPSBwZXJjZW50ICYmIGhhbmRsZVBlcmNlbnQgKyAoIDEwMCAtIGhhbmRsZVBlcmNlbnQgKSAqIHBlcmNlbnQgLyAxMDAsCgkJCQliUGVyY2VudCA9IHBlcmNlbnQgPT09IDEwMCA/IDAgOiBNYXRoLm1pbiggaGFuZGxlUGVyY2VudCArIDEwMCAtIGFQZXJjZW50LCAxMDAgKTsKCgkJCXRoaXMuX2xhYmVscy5lYWNoKGZ1bmN0aW9uKCl7CgkJCQl2YXIgYWIgPSAkKHRoaXMpLmlzKCAiLnVpLXNsaWRlci1sYWJlbC1hIiApOwoJCQkJJCggdGhpcyApLndpZHRoKCAoIGFiID8gYVBlcmNlbnQgOiBiUGVyY2VudCAgKSArICIlIiApOwoJCQl9KTsKCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFyIHZhbHVlQ2hhbmdlZCA9IGZhbHNlOwoKCQkJLy8gdXBkYXRlIGNvbnRyb2wicyB2YWx1ZQoJCQlpZiAoIGNUeXBlID09PSAiaW5wdXQiICkgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbC52YWwoKSAhPT0gbmV3dmFsOwoJCQkJY29udHJvbC52YWwoIG5ld3ZhbCApOwoJCQl9IGVsc2UgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ID0gbmV3dmFsOwoJCQl9CgkJCWlmICggIWlzZnJvbUNvbnRyb2wgJiYgdmFsdWVDaGFuZ2VkICkgewoJCQkJY29udHJvbC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCXRoaXMuc2xpZGVyLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBmYWxzZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJdGhpcy5zbGlkZXIuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9Cgp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5zbGlkZXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zZWxlY3RtZW51IiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWljb246ICJhcnJvdy1kIiwKCQlpY29ucG9zOiAicmlnaHQiLAoJCWlubGluZTogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQloaWRlUGxhY2Vob2xkZXJNZW51SXRlbXM6IHRydWUsCgkJY2xvc2VUZXh0OiAiQ2xvc2UiLAoJCW5hdGl2ZU1lbnU6IHRydWUsCgkJLy8gVGhpcyBvcHRpb24gZGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MgZGV2aWNlcy4KCQlwcmV2ZW50Rm9jdXNab29tOiAvaVBob25lfGlQYWR8aVBvZC8udGVzdCggbmF2aWdhdG9yLnBsYXRmb3JtICkgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSwKCQlpbml0U2VsZWN0b3I6ICJzZWxlY3Q6bm90KDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpKSIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gJCggIjxkaXYvPiIgKTsKCX0sCgoJX3NldERpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5idXR0b24uYXR0ciggImFyaWEtZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHZhbHVlICk7Cgl9LAoKCV9mb2N1c0J1dHRvbiA6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJfSwgNDApOwoJfSwKCiAgX3NlbGVjdE9wdGlvbnM6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuc2VsZWN0LmZpbmQoICJvcHRpb24iICk7CiAgfSwKCgkvLyBzZXR1cCBpdGVtcyB0aGF0IGFyZSBnZW5lcmFsbHkgbmVjZXNzYXJ5IGZvciBzZWxlY3QgbWVudSBleHRlbnNpb24KCV9wcmVFeHRlbnNpb246IGZ1bmN0aW9uKCl7CgkJdmFyIGNsYXNzZXMgPSAiIjsKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYoICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1sZWZ0IiApICkgewoJCQljbGFzc2VzID0gICIgdWktYnRuLWxlZnQiOwoJCX0KCQkKCQlpZiggICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLXJpZ2h0IjsKCQl9CgkJCgkJdGhpcy5zZWxlY3QgPSB0aGlzLmVsZW1lbnQud3JhcCggIjxkaXYgY2xhc3M9J3VpLXNlbGVjdCIgKyBjbGFzc2VzICsgIic+IiApOwoJCXRoaXMuc2VsZWN0SUQgID0gdGhpcy5zZWxlY3QuYXR0ciggImlkIiApOwoJCXRoaXMubGFiZWwgPSAkKCAibGFiZWxbZm9yPSciKyB0aGlzLnNlbGVjdElEICsiJ10iICkuYWRkQ2xhc3MoICJ1aS1zZWxlY3QiICk7CgkJdGhpcy5pc011bHRpcGxlID0gdGhpcy5zZWxlY3RbIDAgXS5tdWx0aXBsZTsKCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMub3B0aW9ucy50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLnNlbGVjdCwgImMiICk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9wcmVFeHRlbnNpb24oKTsKCiAJCS8vIEFsbG93cyBmb3IgZXh0ZW5zaW9uIG9mIHRoZSBuYXRpdmUgc2VsZWN0IGZvciBjdXN0b20gc2VsZWN0cyBhbmQgb3RoZXIgcGx1Z2lucwoJCS8vIHNlZSBzZWxlY3QuY3VzdG9tIGZvciBleGFtcGxlIGV4dGVuc2lvbgoJCS8vIFRPRE8gZXhwbG9yZSBwbHVnaW4gcmVnaXN0cmF0aW9uCgkJdGhpcy5fdHJpZ2dlciggImJlZm9yZUNyZWF0ZSIgKTsKCgkJdGhpcy5idXR0b24gPSB0aGlzLl9idXR0b24oKTsKCgkJdmFyIHNlbGYgPSB0aGlzLAoKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCgkJCS8vIElFIHRocm93cyBhbiBleGNlcHRpb24gYXQgb3B0aW9ucy5pdGVtKCkgZnVuY3Rpb24gd2hlbgoJCQkvLyB0aGVyZSBpcyBubyBzZWxlY3RlZCBpdGVtCgkJCS8vIHNlbGVjdCBmaXJzdCBpbiB0aGlzIGNhc2UKCQkJc2VsZWN0ZWRJbmRleCA9IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCA9PSAtMSA/IDAgOiB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgoJCQkvLyBUT0RPIHZhbHVlcyBidXR0b25JZCBhbmQgbWVudUlkIGFyZSB1bmRlZmluZWQgaGVyZQoJCQlidXR0b24gPSB0aGlzLmJ1dHRvbgoJCQkJLnRleHQoICQoIHRoaXMuc2VsZWN0WyAwIF0ub3B0aW9ucy5pdGVtKCBzZWxlY3RlZEluZGV4ICkgKS50ZXh0KCkgKQoJCQkJLmluc2VydEJlZm9yZSggdGhpcy5zZWxlY3QgKQoJCQkJLmJ1dHRvbk1hcmt1cCggewoJCQkJCXRoZW1lOiBvcHRpb25zLnRoZW1lLAoJCQkJCWljb246IG9wdGlvbnMuaWNvbiwKCQkJCQlpY29ucG9zOiBvcHRpb25zLmljb25wb3MsCgkJCQkJaW5saW5lOiBvcHRpb25zLmlubGluZSwKCQkJCQljb3JuZXJzOiBvcHRpb25zLmNvcm5lcnMsCgkJCQkJc2hhZG93OiBvcHRpb25zLnNoYWRvdywKCQkJCQlpY29uc2hhZG93OiBvcHRpb25zLmljb25zaGFkb3csCgkJCQkJbWluaTogb3B0aW9ucy5taW5pCgkJCQl9KTsKCgkJLy8gT3BlcmEgZG9lcyBub3QgcHJvcGVybHkgc3VwcG9ydCBvcGFjaXR5IG9uIHNlbGVjdCBlbGVtZW50cwoJCS8vIEluIE1pbmksIGl0IGhpZGVzIHRoZSBlbGVtZW50LCBidXQgbm90IGl0cyB0ZXh0CgkJLy8gT24gdGhlIGRlc2t0b3AsaXQgc2VlbXMgdG8gZG8gdGhlIG9wcG9zaXRlCgkJLy8gZm9yIHRoZXNlIHJlYXNvbnMsIHVzaW5nIHRoZSBuYXRpdmVNZW51IG9wdGlvbiByZXN1bHRzIGluIGEgZnVsbCBuYXRpdmUgc2VsZWN0IGluIE9wZXJhCgkJaWYgKCBvcHRpb25zLm5hdGl2ZU1lbnUgJiYgd2luZG93Lm9wZXJhICYmIHdpbmRvdy5vcGVyYS52ZXJzaW9uICkgewoJCQl0aGlzLnNlbGVjdC5hZGRDbGFzcyggInVpLXNlbGVjdC1uYXRpdmVvbmx5IiApOwoJCX0KCgkJLy8gQWRkIGNvdW50ZXIgZm9yIG11bHRpIHNlbGVjdHMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudCA9ICQoICI8c3Bhbj4iICkKCQkJCS5hZGRDbGFzcyggInVpLWxpLWNvdW50IHVpLWJ0bi11cC1jIHVpLWJ0bi1jb3JuZXItYWxsIiApCgkJCQkuaGlkZSgpCgkJCQkuYXBwZW5kVG8oIGJ1dHRvbi5hZGRDbGFzcygndWktbGktaGFzLWNvdW50JykgKTsKCQl9CgoJCS8vIERpc2FibGUgaWYgc3BlY2lmaWVkCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCdkaXNhYmxlZCcpKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gRXZlbnRzIG9uIG5hdGl2ZSBzZWxlY3QKCQl0aGlzLnNlbGVjdC5jaGFuZ2UoIGZ1bmN0aW9uKCkgewoJCQlzZWxmLnJlZnJlc2goKTsKCQl9KTsKCgkJdGhpcy5idWlsZCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLnNlbGVjdAoJCQkuYXBwZW5kVG8oIHNlbGYuYnV0dG9uICkKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBBZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCiAgICAgICAgICAgIC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKICAgICAgICAgICAgfSkKCQkJLmJpbmQoICJmb2N1cyB2bW91c2VvdmVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCQkJfSkKCQkJLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIG9uIHNjcm9sbC90b3VjaG1vdmUKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIHZtb3VzZW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW91dCIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCX0pOwoKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQlzZWxmLmJ1dHRvbi5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQlpZiggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKXsKCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSkKCQkuYmluZCggIm1vdXNldXAiLCBmdW5jdGlvbigpIHsKCQkJaWYoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICl7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7Cgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5pbmRleCggdGhpcyApOwoJCX0pLmdldCgpOwoJfSwKCglzZXRCdXR0b25UZXh0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLnRleHQoIGZ1bmN0aW9uKCkgewoJCQlpZiAoICFzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQlyZXR1cm4gc2VsZWN0ZWQudGV4dCgpOwoJCQl9CgoJCQlyZXR1cm4gc2VsZWN0ZWQubGVuZ3RoID8gc2VsZWN0ZWQubWFwKCBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQl9KS5nZXQoKS5qb2luKCAiLCAiICkgOiBzZWxmLnBsYWNlaG9sZGVyOwoJCX0pOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuc2VsZWN0bWVudS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cn0pKCBqUXVlcnkgKTsKCi8qCiogY3VzdG9tICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIGV4dGVuZFNlbGVjdCA9IGZ1bmN0aW9uKCB3aWRnZXQgKXsKCgkJdmFyIHNlbGVjdCA9IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEICA9IHdpZGdldC5zZWxlY3RJRCwKCQkJbGFiZWwgPSB3aWRnZXQubGFiZWwsCgkJCXRoaXNQYWdlID0gd2lkZ2V0LnNlbGVjdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXNjcmVlbiA9ICQoICI8ZGl2PiIsIHsiY2xhc3MiOiAidWktc2VsZWN0bWVudS1zY3JlZW4gdWktc2NyZWVuLWhpZGRlbiJ9ICkuYXBwZW5kVG8oIHRoaXNQYWdlICksCgkJCXNlbGVjdE9wdGlvbnMgPSB3aWRnZXQuX3NlbGVjdE9wdGlvbnMoKSwKCQkJaXNNdWx0aXBsZSA9IHdpZGdldC5pc011bHRpcGxlID0gd2lkZ2V0LnNlbGVjdFsgMCBdLm11bHRpcGxlLAoJCQlidXR0b25JZCA9IHNlbGVjdElEICsgIi1idXR0b24iLAoJCQltZW51SWQgPSBzZWxlY3RJRCArICItbWVudSIsCgkJCW1lbnVQYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nZGlhbG9nJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgInRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy50aGVtZSArIicgZGF0YS0iICskLm1vYmlsZS5ucyArICJvdmVybGF5LXRoZW1lPSciKyB3aWRnZXQub3B0aW9ucy5vdmVybGF5VGhlbWUgKyInPiIgKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0naGVhZGVyJz4iICsKCQkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJCSI8L2Rpdj4iKwoJCQkJIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nY29udGVudCc+PC9kaXY+IisKCQkJCSI8L2Rpdj4iICksCgoJCQlsaXN0Ym94ID0gICQoIjxkaXY+IiwgeyAiY2xhc3MiOiAidWktc2VsZWN0bWVudSB1aS1zZWxlY3RtZW51LWhpZGRlbiB1aS1vdmVybGF5LXNoYWRvdyB1aS1jb3JuZXItYWxsIHVpLWJvZHktIiArIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArICIgIiArICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIH0gKS5pbnNlcnRBZnRlcihzY3JlZW4pLAoKCQkJbGlzdCA9ICQoICI8dWw+IiwgewoJCQkJImNsYXNzIjogInVpLXNlbGVjdG1lbnUtbGlzdCIsCgkJCQkiaWQiOiBtZW51SWQsCgkJCQkicm9sZSI6ICJsaXN0Ym94IiwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBidXR0b25JZAoJCQl9KS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiLCB3aWRnZXQub3B0aW9ucy50aGVtZSApLmFwcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXIgPSAkKCAiPGRpdj4iLCB7CgkJCQkiY2xhc3MiOiAidWktaGVhZGVyIHVpLWJhci0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUKCQkJfSkucHJlcGVuZFRvKCBsaXN0Ym94ICksCgoJCQloZWFkZXJUaXRsZSA9ICQoICI8aDE+IiwgewoJCQkJImNsYXNzIjogInVpLXRpdGxlIgoJCQl9KS5hcHBlbmRUbyggaGVhZGVyICksCgoJCQltZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2UsCgkJCWhlYWRlckNsb3NlOwoKCQlpZiggd2lkZ2V0LmlzTXVsdGlwbGUgKSB7CgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJ0ZXh0Ijogd2lkZ2V0Lm9wdGlvbnMuY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuLWxlZnQiCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiwgIm5vdGV4dCIgKS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbiIsICJkZWxldGUiICkuYXBwZW5kVG8oIGhlYWRlciApLmJ1dHRvbk1hcmt1cCgpOwoJCX0KCgkJJC5leHRlbmQoIHdpZGdldCwgewoJCQlzZWxlY3Q6IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEOiBzZWxlY3RJRCwKCQkJYnV0dG9uSWQ6IGJ1dHRvbklkLAoJCQltZW51SWQ6IG1lbnVJZCwKCQkJdGhpc1BhZ2U6IHRoaXNQYWdlLAoJCQltZW51UGFnZTogbWVudVBhZ2UsCgkJCWxhYmVsOiBsYWJlbCwKCQkJc2NyZWVuOiBzY3JlZW4sCgkJCXNlbGVjdE9wdGlvbnM6IHNlbGVjdE9wdGlvbnMsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiB3aWRnZXQub3B0aW9ucy50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiLAoKCQkJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCS8vIENyZWF0ZSBsaXN0IGZyb20gc2VsZWN0LCB1cGRhdGUgc3RhdGUKCQkJCXNlbGYucmVmcmVzaCgpOwoKCQkJCXNlbGYuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuYmx1cigpOwoJCQkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJCQl9KTsKCgkJCQkvLyBCdXR0b24gZXZlbnRzCgkJCQlzZWxmLmJ1dHRvbi5iaW5kKCAidmNsaWNrIGtleWRvd24iICwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmICggZXZlbnQudHlwZSA9PSAidmNsaWNrIiB8fAoJCQkJCQkJIGV2ZW50LmtleUNvZGUgJiYgKCBldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8CgkJCQkJCQkJCQkJCQkJCQkJZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5TUEFDRSApICkgewoKCQkJCQkJc2VsZi5vcGVuKCk7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIGZvciBsaXN0IGl0ZW1zCgkJCQlzZWxmLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKQoJCQkJCS5iaW5kKCAiZm9jdXNpbiIsIGZ1bmN0aW9uKCBlICl7CgkJCQkJCSQoIGUudGFyZ2V0ICkKCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkJCQkJLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoKCQkJCQl9KQoJCQkJCS5iaW5kKCAiZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApewoJCQkJCQkkKCBlLnRhcmdldCApCgkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApCgkJCQkJCQkudHJpZ2dlciggInZtb3VzZW91dCIgKTsKCQkJCQl9KQoJCQkJCS5kZWxlZ2F0ZSggImxpOm5vdCgudWktZGlzYWJsZWQsIC51aS1saS1kaXZpZGVyKSIsICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkJCS8vIGluZGV4IG9mIG9wdGlvbiB0YWcgdG8gYmUgc2VsZWN0ZWQKCQkJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCQkJbmV3SW5kZXggPSBzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuaW5kZXgoIHRoaXMgKSwKCQkJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCQkJLy8gdG9nZ2xlIHNlbGVjdGVkIHN0YXR1cyBvbiB0aGUgdGFnIGZvciBtdWx0aSBzZWxlY3RzCgkJCQkJCW9wdGlvbi5zZWxlY3RlZCA9IHNlbGYuaXNNdWx0aXBsZSA/ICFvcHRpb24uc2VsZWN0ZWQgOiB0cnVlOwoKCQkJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJJCggdGhpcyApLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iLCBvcHRpb24uc2VsZWN0ZWQgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJCQl9CgoJCQkJCQkvLyB0cmlnZ2VyIGNoYW5nZSBpZiB2YWx1ZSBjaGFuZ2VkCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQkJCXNlbGYuc2VsZWN0LnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJCX0KCgkJCQkJCS8vaGlkZSBjdXN0b20gc2VsZWN0IGZvciBzaW5nbGUgc2VsZWN0cyBvbmx5CgkJCQkJCWlmICggIXNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJfQoKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9KQoJCQkJCS5rZXlkb3duKGZ1bmN0aW9uKCBldmVudCApIHsgIC8va2V5Ym9hcmQgZXZlbnRzIGZvciBtZW51IGl0ZW1zCgkJCQkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJCQkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKSwKCQkJCQkJCXByZXYsIG5leHQ7CgoJCQkJCQkvLyBzd2l0Y2ggbG9naWMgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkJCQkvLyB1cCBvciBsZWZ0IGFycm93IGtleXMKCQkJCQkJIGNhc2UgMzg6CgkJCQkJCQlwcmV2ID0gbGkucHJldigpLm5vdCggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoKCQkJCQkJCWlmKCBwcmV2LmlzKCAiLnVpLWxpLWRpdmlkZXIiICkgKSB7CgkJCQkJCQkJcHJldiA9IHByZXYucHJldigpOwoJCQkJCQkJfQoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIHByZXYubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCXByZXYuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQkJLy8gZG93biBvciByaWdodCBhcnJvdyBrZXlzCgkJCQkJCSBjYXNlIDQwOgoJCQkJCQkJbmV4dCA9IGxpLm5leHQoKTsKCgkJCQkJCQlpZiggbmV4dC5pcyggIi51aS1saS1kaXZpZGVyIiApICkgewoJCQkJCQkJCW5leHQgPSBuZXh0Lm5leHQoKTsKCQkJCQkJCX0KCgkJCQkJCQkvLyBpZiB0aGVyZSdzIGEgbmV4dCBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIG5leHQubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCW5leHQuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQkJLy8gSWYgZW50ZXIgb3Igc3BhY2UgaXMgcHJlc3NlZCwgdHJpZ2dlciBjbGljawoJCQkJCQkgY2FzZSAxMzoKCQkJCQkJIGNhc2UgMzI6CgkJCQkJCQl0YXJnZXQudHJpZ2dlciggImNsaWNrIiApOwoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfSk7CgoJCQkJLy8gYnV0dG9uIHJlZm9jdXMgZW5zdXJlcyBwcm9wZXIgaGVpZ2h0IGNhbGN1bGF0aW9uCgkJCQkvLyBieSByZW1vdmluZyB0aGUgaW5saW5lIHN0eWxlIGFuZCBlbnN1cmluZyBwYWdlIGluY2x1c2lvbgoJCQkJc2VsZi5tZW51UGFnZS5iaW5kKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmxpc3QuYXBwZW5kVG8oIHNlbGYubGlzdGJveCApOwoJCQkJCXNlbGYuX2ZvY3VzQnV0dG9uKCk7CgoJCQkJCS8vIFRPRE8gY2VudHJhbGl6ZSBwYWdlIHJlbW92YWwgYmluZGluZyAvIGhhbmRsaW5nIGluIHRoZSBwYWdlIHBsdWdpbi4KCQkJCQkvLyBTdWdnZXN0aW9uIGZyb20gQGpibGFzIHRvIGRvIHJlZmNvdW50aW5nCgkJCQkJLy8KCQkJCQkvLyBUT0RPIGV4dHJlbWVseSBjb25mdXNpbmcgZGVwZW5kZW5jeSBvbiB0aGUgb3BlbiBtZXRob2Qgd2hlcmUgdGhlIHBhZ2VoaWRlLnJlbW92ZQoJCQkJCS8vIGJpbmRpbmdzIGFyZSBzdHJpcHBlZCB0byBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGRpc2FwcGVhcmluZy4gVGhlIHdheQoJCQkJCS8vIHdlJ3JlIGtlZXBpbmcgcGFnZXMgaW4gdGhlIERPTSByaWdodCBub3cgc3Vja3MKCQkJCQkvLwoJCQkJCS8vIHJlYmluZCB0aGUgcGFnZSByZW1vdmUgdGhhdCB3YXMgdW5ib3VuZCBpbiB0aGUgb3BlbiBmdW5jdGlvbgoJCQkJCS8vIHRvIGFsbG93IGZvciB0aGUgcGFyZW50IHBhZ2UgcmVtb3ZhbCBmcm9tIGFjdGlvbnMgb3RoZXIgdGhhbiB0aGUgdXNlCgkJCQkJLy8gb2YgYSBkaWFsb2cgc2l6ZWQgY3VzdG9tIHNlbGVjdAoJCQkJCS8vCgkJCQkJLy8gZG9pbmcgdGhpcyBoZXJlIHByb3ZpZGVzIGZvciB0aGUgYmFjayBidXR0b24gb24gdGhlIGN1c3RvbSBzZWxlY3QgZGlhbG9nCgkJCQkJJC5tb2JpbGUuX2JpbmRQYWdlUmVtb3ZlLmNhbGwoIHNlbGYudGhpc1BhZ2UgKTsKCQkJCX0pOwoKCQkJCS8vIEV2ZW50cyBvbiAic2NyZWVuIiBvdmVybGF5CgkJCQlzZWxmLnNjcmVlbi5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoKCQkJCS8vIENsb3NlIGJ1dHRvbiBvbiBzbWFsbCBvdmVybGF5cwoJCQkJaWYoIHNlbGYuaXNNdWx0aXBsZSApewoJCQkJCXNlbGYuaGVhZGVyQ2xvc2UuY2xpY2soIGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT0gIm92ZXJsYXkiICkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgoJCQkJLy8gdHJhY2sgdGhpcyBkZXBlbmRlbmN5IHNvIHRoYXQgd2hlbiB0aGUgcGFyZW50IHBhZ2UKCQkJCS8vIGlzIHJlbW92ZWQgb24gcGFnZWhpZGUgaXQgd2lsbCBhbHNvIHJlbW92ZSB0aGUgbWVudXBhZ2UKCQkJCXNlbGYudGhpc1BhZ2UuYWRkRGVwZW5kZW50cyggdGhpcy5tZW51UGFnZSApOwoJCQl9LAoKCQkJX2lzUmVidWlsZFJlcXVpcmVkOiBmdW5jdGlvbigpIHsKCQkJCXZhciBsaXN0ID0gdGhpcy5saXN0LmZpbmQoICJsaSIgKSwKCQkJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpOwoKCQkJCS8vIFRPRE8gZXhjZWVkaW5nbHkgbmFpdmUgbWV0aG9kIHRvIGRldGVybWluZSBkaWZmZXJlbmNlCgkJCQkvLyBpZ25vcmVzIHZhbHVlIGNoYW5nZXMgZXRjIGluIGZhdm9yIG9mIGEgZm9yY2VkUmVidWlsZAoJCQkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQkJCXJldHVybiBvcHRpb25zLnRleHQoKSAhPT0gbGlzdC50ZXh0KCk7CgkJCX0sCgoJCQlyZWZyZXNoOiBmdW5jdGlvbiggZm9yY2VSZWJ1aWxkICwgZm9vICl7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlzZWxlY3QgPSB0aGlzLmVsZW1lbnQsCgkJCQlpc011bHRpcGxlID0gdGhpcy5pc011bHRpcGxlLAoJCQkJb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKSwKCQkJCXNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpLAoJCQkJLy8gcmV0dXJuIGFuIGFycmF5IG9mIGFsbCBzZWxlY3RlZCBpbmRleCdzCgkJCQlpbmRpY2llcyA9IHRoaXMuc2VsZWN0ZWRJbmRpY2VzKCk7CgoJCQkJaWYgKCAgZm9yY2VSZWJ1aWxkIHx8IHRoaXMuX2lzUmVidWlsZFJlcXVpcmVkKCkgKSB7CgkJCQkJc2VsZi5fYnVpbGRMaXN0KCk7CgkJCQl9CgoJCQkJc2VsZi5zZXRCdXR0b25UZXh0KCk7CgkJCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApCgkJCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkJCS5lYWNoKGZ1bmN0aW9uKCBpICkgewoKCQkJCQkJaWYgKCAkLmluQXJyYXkoIGksIGluZGljaWVzICkgPiAtMSApIHsKCQkJCQkJCXZhciBpdGVtID0gJCggdGhpcyApOwoKCQkJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCQkJaXRlbS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIHRydWUgKTsKCgkJCQkJCQkvLyBNdWx0aXBsZSBzZWxlY3RzOiBhZGQgdGhlICJvbiIgY2hlY2tib3ggc3RhdGUgdG8gdGhlIGljb24KCQkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJCWl0ZW0uZmluZCggIi51aS1pY29uIiApLnJlbW92ZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiICkuYWRkQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiApOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlpZiggaXRlbS5pcyggIi51aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApICkgewoJCQkJCQkJCQlpdGVtLm5leHQoKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQlpdGVtLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQl9LAoKCQkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09ICJwYWdlIiApIHsKCQkJCQkvLyBkb2Vzbid0IHNvbHZlIHRoZSBwb3NzaWJsZSBpc3N1ZSB3aXRoIGNhbGxpbmcgY2hhbmdlIHBhZ2UKCQkJCQkvLyB3aGVyZSB0aGUgb2JqZWN0cyBkb24ndCBkZWZpbmUgZGF0YSB1cmxzIHdoaWNoIHByZXZlbnRzIGRpYWxvZyBrZXkKCQkJCQkvLyBzdHJpcHBpbmcgLSBjaGFuZ2VQYWdlIGhhcyBpbmNvbWluZyByZWZhY3RvcgoJCQkJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5zY3JlZW4uYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJCXNlbGYubGlzdGJveC5hZGRDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApLnJlbW92ZUF0dHIoICJzdHlsZSIgKS5yZW1vdmVDbGFzcyggImluIiApOwoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkJCX0KCgkJCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJfSwKCgkJCW9wZW46IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpcywKICAgICAgICAgICR3aW5kb3cgPSAkKCB3aW5kb3cgKSwKICAgICAgICAgIHNlbGZMaXN0UGFyZW50ID0gc2VsZi5saXN0LnBhcmVudCgpLAoJCQkJCW1lbnVIZWlnaHQgPSBzZWxmTGlzdFBhcmVudC5vdXRlckhlaWdodCgpLAoJCQkJCW1lbnVXaWR0aCA9IHNlbGZMaXN0UGFyZW50Lm91dGVyV2lkdGgoKSwKCQkJCQlhY3RpdmVQYWdlID0gJCggIi51aS1wYWdlLWFjdGl2ZSIgKSwKCQkJCQl0U2Nyb2xsRWxlbSA9IGFjdGl2ZVBhZ2UsCgkJCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCQlidG5PZmZzZXQgPSBzZWxmLmJ1dHRvbi5vZmZzZXQoKS50b3AsCgkJCQkJc2NyZWVuSGVpZ2h0ID0gJHdpbmRvdy5oZWlnaHQoKSwKCQkJCQlzY3JlZW5XaWR0aCA9ICR3aW5kb3cud2lkdGgoKTsKCgkJCQkvL2FkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkvL3JlbW92ZSBhZnRlciBkZWxheQoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9LCAzMDApOwoKCQkJCWZ1bmN0aW9uIGZvY3VzTWVudUl0ZW0oKSB7CgkJCQkJc2VsZi5saXN0LmZpbmQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiBhIiApLmZvY3VzKCk7CgkJCQl9CgoJCQkJaWYgKCBtZW51SGVpZ2h0ID4gc2NyZWVuSGVpZ2h0IC0gODAgfHwgISQuc3VwcG9ydC5zY3JvbGxUb3AgKSB7CgoJCQkJCXNlbGYubWVudVBhZ2UuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCk7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQgPSBtZW51UGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICk7CgkJCQkJc2VsZi5tZW51UGFnZUNsb3NlID0gbWVudVBhZ2UuZmluZCggIi51aS1oZWFkZXIgYSIgKTsKCgkJCQkJLy8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBiZWluZyByZW1vdmVkIGZyb20gdGhlIERPTSwKCQkJCQkvLyBvdGhlcndpc2UgdGhlIHJlc3VsdHMgb2Ygc2VsZWN0aW5nIGEgbGlzdCBpdGVtIGluIHRoZSBkaWFsb2cKCQkJCQkvLyBmYWxsIGludG8gYSBibGFjayBob2xlCgkJCQkJc2VsZi50aGlzUGFnZS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICk7CgoJCQkJCS8vZm9yIFdlYk9TL09wZXJhIE1pbmkgKHNldCBsYXN0c2Nyb2xsIHVzaW5nIGJ1dHRvbiBvZmZzZXQpCgkJCQkJaWYgKCBzY3JvbGxUb3AgPT0gMCAmJiBidG5PZmZzZXQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQkJCXNlbGYudGhpc1BhZ2Uub25lKCAicGFnZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAibGFzdFNjcm9sbCIsIGJ0bk9mZnNldCApOwoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCXNlbGYubWVudVBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJZm9jdXNNZW51SXRlbSgpOwoJCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQkJfSk7CgoJCQkJCXNlbGYubWVudVR5cGUgPSAicGFnZSI7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQuYXBwZW5kKCBzZWxmLmxpc3QgKTsKCQkJCQlzZWxmLm1lbnVQYWdlLmZpbmQoImRpdiAudWktdGl0bGUiKS50ZXh0KHNlbGYubGFiZWwudGV4dCgpKTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBzZWxmLm1lbnVQYWdlLCB7CgkJCQkJCXRyYW5zaXRpb246ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uCgkJCQkJfSk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubWVudVR5cGUgPSAib3ZlcmxheSI7CgoJCQkJCXNlbGYuc2NyZWVuLmhlaWdodCggJChkb2N1bWVudCkuaGVpZ2h0KCkgKQoJCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoKCQkJCQkvLyBUcnkgYW5kIGNlbnRlciB0aGUgb3ZlcmxheSBvdmVyIHRoZSBidXR0b24KCQkJCQl2YXIgcm9vbXRvcCA9IGJ0bk9mZnNldCAtIHNjcm9sbFRvcCwKCQkJCQkJcm9vbWJvdCA9IHNjcm9sbFRvcCArIHNjcmVlbkhlaWdodCAtIGJ0bk9mZnNldCwKCQkJCQkJaGFsZmhlaWdodCA9IG1lbnVIZWlnaHQgLyAyLAoJCQkJCQltYXh3aWR0aCA9IHBhcnNlRmxvYXQoIHNlbGYubGlzdC5wYXJlbnQoKS5jc3MoICJtYXgtd2lkdGgiICkgKSwKCQkJCQkJbmV3dG9wLCBuZXdsZWZ0OwoKCQkJCQlpZiAoIHJvb210b3AgPiBtZW51SGVpZ2h0IC8gMiAmJiByb29tYm90ID4gbWVudUhlaWdodCAvIDIgKSB7CgkJCQkJCW5ld3RvcCA9IGJ0bk9mZnNldCArICggc2VsZi5idXR0b24ub3V0ZXJIZWlnaHQoKSAvIDIgKSAtIGhhbGZoZWlnaHQ7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gMzBweCB0b2xlcmFuY2Ugb2ZmIHRoZSBlZGdlcwoJCQkJCQluZXd0b3AgPSByb29tdG9wID4gcm9vbWJvdCA/IHNjcm9sbFRvcCArIHNjcmVlbkhlaWdodCAtIG1lbnVIZWlnaHQgLSAzMCA6IHNjcm9sbFRvcCArIDMwOwoJCQkJCX0KCgkJCQkJLy8gSWYgdGhlIG1lbnV3aWR0aCBpcyBzbWFsbGVyIHRoYW4gdGhlIHNjcmVlbiBjZW50ZXIgaXMKCQkJCQlpZiAoIG1lbnVXaWR0aCA8IG1heHdpZHRoICkgewoJCQkJCQluZXdsZWZ0ID0gKCBzY3JlZW5XaWR0aCAtIG1lbnVXaWR0aCApIC8gMjsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy9vdGhlcndpc2UgaW5zdXJlIGEgPj0gMzBweCBvZmZzZXQgZnJvbSB0aGUgbGVmdAoJCQkJCQluZXdsZWZ0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkubGVmdCArIHNlbGYuYnV0dG9uLm91dGVyV2lkdGgoKSAvIDIgLSBtZW51V2lkdGggLyAyOwoKCQkJCQkJLy8gMzBweCB0b2xlcmFuY2Ugb2ZmIHRoZSBlZGdlcwoJCQkJCQlpZiAoIG5ld2xlZnQgPCAzMCApIHsKCQkJCQkJCW5ld2xlZnQgPSAzMDsKCQkJCQkJfSBlbHNlIGlmICggKG5ld2xlZnQgKyBtZW51V2lkdGgpID4gc2NyZWVuV2lkdGggKSB7CgkJCQkJCQluZXdsZWZ0ID0gc2NyZWVuV2lkdGggLSBtZW51V2lkdGggLSAzMDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJc2VsZi5saXN0Ym94LmFwcGVuZCggc2VsZi5saXN0ICkKCQkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2VsZWN0bWVudS1oaWRkZW4iICkKCQkJCQkJLmNzcyh7CgkJCQkJCQl0b3A6IG5ld3RvcCwKCQkJCQkJCWxlZnQ6IG5ld2xlZnQKCQkJCQkJfSkKCQkJCQkJLmFkZENsYXNzKCAiaW4iICk7CgoJCQkJCWZvY3VzTWVudUl0ZW0oKTsKCgkJCQkJLy8gZHVwbGljYXRlIHdpdGggdmFsdWUgc2V0IGluIHBhZ2Ugc2hvdyBmb3IgZGlhbG9nIHNpemVkIHNlbGVjdHMKCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQl9CgkJCX0sCgoJCQlfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJCQluZWVkUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQkJCW9wdGdyb3VwcyA9IFtdLAoJCQkJCWxpcyA9IFtdLAoJCQkJCWRhdGFJY29uID0gc2VsZi5pc011bHRpcGxlID8gImNoZWNrYm94LW9mZiIgOiAiZmFsc2UiOwoKCQkJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgoJCQkJdmFyICRvcHRpb25zID0gc2VsZi5zZWxlY3QuZmluZCgib3B0aW9uIiksCgkJCQkJbnVtT3B0aW9ucyA9ICRvcHRpb25zLmxlbmd0aCwKCQkJCQlzZWxlY3QgPSB0aGlzLnNlbGVjdFsgMCBdLAoJCQkJCWRhdGFQcmVmaXggPSAnZGF0YS0nICsgJC5tb2JpbGUubnMsCgkJCQkJZGF0YUluZGV4QXR0ciA9IGRhdGFQcmVmaXggKyAnb3B0aW9uLWluZGV4JywKCQkJCQlkYXRhSWNvbkF0dHIgPSBkYXRhUHJlZml4ICsgJ2ljb24nLAoJCQkJCWRhdGFSb2xlQXR0ciA9IGRhdGFQcmVmaXggKyAncm9sZScsCgkJCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCQkJb3B0R3JvdXA7CgoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBudW1PcHRpb25zO2krKyl7CgkJCQkJdmFyIG9wdGlvbiA9ICRvcHRpb25zW2ldLAoJCQkJCQkkb3B0aW9uID0gJChvcHRpb24pLAoJCQkJCQlwYXJlbnQgPSBvcHRpb24ucGFyZW50Tm9kZSwKCQkJCQkJdGV4dCA9ICRvcHRpb24udGV4dCgpLAoJCQkJCQlhbmNob3IgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpLAoJCQkJCQljbGFzc2VzID0gW107CgoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCcjJyk7CgkJCQkJYW5jaG9yLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpKTsKCgkJCQkJLy8gQXJlIHdlIGluc2lkZSBhbiBvcHRncm91cD8KCQkJCQlpZiAocGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIpewoJCQkJCQl2YXIgb3B0TGFiZWwgPSBwYXJlbnQuZ2V0QXR0cmlidXRlKCdsYWJlbCcpOwoJCQkJCQlpZiAoIG9wdExhYmVsICE9IG9wdEdyb3VwKSB7CgkJCQkJCQl2YXIgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZShkYXRhUm9sZUF0dHIsJ2xpc3QtZGl2aWRlcicpOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCdvcHRpb24nKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsJy0xJyk7CgkJCQkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKG9wdExhYmVsKSk7CgkJCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZChkaXZpZGVyKTsKCQkJCQkJCW9wdEdyb3VwID0gb3B0TGFiZWw7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmIChuZWVkUGxhY2Vob2xkZXIgJiYgKCFvcHRpb24uZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgfHwgdGV4dC5sZW5ndGggPT0gMCB8fCAkb3B0aW9uLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSkpIHsKCQkJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQkJCWlmICggby5oaWRlUGxhY2Vob2xkZXJNZW51SXRlbXMgKSB7CgkJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zZWxlY3RtZW51LXBsYWNlaG9sZGVyIiApOwoJCQkJCQl9CgkJCQkJCWlmICghcGxhY2Vob2xkZXIpIHsKCQkJCQkJCXBsYWNlaG9sZGVyID0gc2VsZi5wbGFjZWhvbGRlciA9IHRleHQ7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCXZhciBpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTsKCQkJCQlpZiAoIG9wdGlvbi5kaXNhYmxlZCApIHsKCQkJCQkJY2xhc3Nlcy5wdXNoKCAidWktZGlzYWJsZWQiICk7CgkJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCdhcmlhLWRpc2FibGVkJyx0cnVlKTsKCQkJCQl9CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoZGF0YUluZGV4QXR0cixpKTsKCQkJCQlpdGVtLnNldEF0dHJpYnV0ZShkYXRhSWNvbkF0dHIsZGF0YUljb24pOwoJCQkJCWl0ZW0uY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCIgIik7CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCdvcHRpb24nKTsKCQkJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsJy0xJyk7CgkJCQkJaXRlbS5hcHBlbmRDaGlsZChhbmNob3IpOwoJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKGl0ZW0pOwoJCQkJfQoKCQkJCXNlbGYubGlzdFswXS5hcHBlbmRDaGlsZChmcmFnbWVudCk7CgoJCQkJLy8gSGlkZSBoZWFkZXIgaWYgaXQncyBub3QgYSBtdWx0aXNlbGVjdCBhbmQgdGhlcmUncyBubyBwbGFjZWhvbGRlcgoJCQkJaWYgKCAhdGhpcy5pc011bHRpcGxlICYmICFwbGFjZWhvbGRlci5sZW5ndGggKSB7CgkJCQkJdGhpcy5oZWFkZXIuaGlkZSgpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmhlYWRlclRpdGxlLnRleHQoIHRoaXMucGxhY2Vob2xkZXIgKTsKCQkJCX0KCgkJCQkvLyBOb3cgcG9wdWxhdGVkLCBjcmVhdGUgbGlzdHZpZXcKCQkJCXNlbGYubGlzdC5saXN0dmlldygpOwoJCQl9LAoKCQkJX2J1dHRvbjogZnVuY3Rpb24oKXsKCQkJCXJldHVybiAkKCAiPGE+IiwgewoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCQkiaWQiOiB0aGlzLmJ1dHRvbklkLAoJCQkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJhcmlhLW93bnMiOiB0aGlzLm1lbnVJZAoJCQkJfSk7CgkJCX0KCQl9KTsKCX07CgoJLy8gaXNzdWUgIzM4OTQgLSBjb3JlIGRvZXNuJ3QgdHJpZ2dlcmVkIGV2ZW50cyBvbiBkaXNhYmxlZCBkZWxlZ2F0ZXMKCSQoIGRvY3VtZW50ICkuYmluZCggInNlbGVjdG1lbnViZWZvcmVjcmVhdGUiLCBmdW5jdGlvbiggZXZlbnQgKXsKCQl2YXIgc2VsZWN0bWVudVdpZGdldCA9ICQoIGV2ZW50LnRhcmdldCApLmRhdGEoICJzZWxlY3RtZW51IiApOwoKCQlpZiggIXNlbGVjdG1lbnVXaWRnZXQub3B0aW9ucy5uYXRpdmVNZW51ICl7CgkJCWV4dGVuZFNlbGVjdCggc2VsZWN0bWVudVdpZGdldCApOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgoJJC53aWRnZXQoICJtb2JpbGUuZml4ZWR0b29sYmFyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgkJb3B0aW9uczogewoJCQl2aXNpYmxlT25QYWdlU2hvdzogdHJ1ZSwKCQkJZGlzYWJsZVBhZ2Vab29tOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAic2xpZGUiLCAvL2NhbiBiZSBub25lLCBmYWRlLCBzbGlkZSAoc2xpZGUgbWFwcyB0byBzbGlkZXVwIG9yIHNsaWRlZG93bikKCQkJZnVsbHNjcmVlbjogZmFsc2UsCgkJCXRhcFRvZ2dsZTogdHJ1ZSwKCQkJdGFwVG9nZ2xlQmxhY2tsaXN0OiAiYSwgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIC51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiLAoJCQloaWRlRHVyaW5nRm9jdXM6ICJpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCIsCgkJCXVwZGF0ZVBhZ2VQYWRkaW5nOiB0cnVlLAoJCQl0cmFja1BlcnNpc3RlbnRUb29sYmFyczogdHJ1ZSwKCgkJCS8vIEJyb3dzZXIgZGV0ZWN0aW9uISBXZWVlZSwgaGVyZSB3ZSBnby4uLgoJCQkvLyBVbmZvcnR1bmF0ZWx5LCBwb3NpdGlvbjpmaXhlZCBpcyBjb3N0bHksIG5vdCB0byBtZW50aW9uIHByb2JhYmx5IGltcG9zc2libGUsIHRvIGZlYXR1cmUtZGV0ZWN0IGFjY3VyYXRlbHkuCgkJCS8vIFNvbWUgdGVzdHMgZXhpc3QsIGJ1dCB0aGV5IGN1cnJlbnRseSByZXR1cm4gZmFsc2UgcmVzdWx0cyBpbiBjcml0aWNhbCBkZXZpY2VzIGFuZCBicm93c2Vycywgd2hpY2ggY291bGQgbGVhZCB0byBhIGJyb2tlbiBleHBlcmllbmNlLgoJCQkvLyBUZXN0aW5nIGZpeGVkIHBvc2l0aW9uaW5nIGlzIGFsc28gcHJldHR5IG9idHJ1c2l2ZSB0byBwYWdlIGxvYWQsIHJlcXVpcmluZyBpbmplY3RlZCBlbGVtZW50cyBhbmQgc2Nyb2xsaW5nIHRoZSB3aW5kb3cKCQkJLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBzZXJ2ZXMgdG8gcnVsZSBvdXQgc29tZSBwb3B1bGFyIGJyb3dzZXJzIHdpdGgga25vd24gZml4ZWQtcG9zaXRpb25pbmcgaXNzdWVzCgkJCS8vIFRoaXMgaXMgYSBwbHVnaW4gb3B0aW9uIGxpa2UgYW55IG90aGVyLCBzbyBmZWVsIGZyZWUgdG8gaW1wcm92ZSBvciBvdmVyd3JpdGUgaXQKCQkJc3VwcG9ydEJsYWNrbGlzdDogZnVuY3Rpb24oKXsKCQkJCXZhciB3ID0gd2luZG93LAoJCQkJCXVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkJCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCQkJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQkJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQkJCWZmbWF0Y2ggPSB1YS5tYXRjaCggL0Zlbm5lY1wvKFswLTldKykvICksCgkJCQkJZmZ2ZXJzaW9uID0gISFmZm1hdGNoICYmIGZmbWF0Y2hbIDEgXSwKCQkJCQlvcGVyYW1tb2JpbGVtYXRjaCA9IHVhLm1hdGNoKCAvT3BlcmEgTW9iaVwvKFswLTldKykvICksCgkJCQkJb212ZXJzaW9uID0gISFvcGVyYW1tb2JpbGVtYXRjaCAmJiBvcGVyYW1tb2JpbGVtYXRjaFsgMSBdOwoKCQkJCWlmKAoJCQkJCS8vIGlPUyA0LjMgYW5kIG9sZGVyIDogUGxhdGZvcm0gaXMgaVBob25lL1BhZC9Ub3VjaCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzNCAoaW9zNSkKCQkJCQkoICggcGxhdGZvcm0uaW5kZXhPZiggImlQaG9uZSIgKSA+IC0xIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUGFkIiApID4gLTEgIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUG9kIiApID4gLTEgKSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkKCQkJCQl8fAoJCQkJCS8vIE9wZXJhIE1pbmkKCQkJCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKQoJCQkJCXx8CgkJCQkJKCBvcGVyYW1tb2JpbGVtYXRjaCAmJiBvbXZlcnNpb24gPCA3NDU4ICkKCQkJCQl8fAoJCQkJCS8vQW5kcm9pZCBsdGUgMi4xOiBQbGF0Zm9ybSBpcyBBbmRyb2lkIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTMzIChBbmRyb2lkIDIuMikKCQkJCQkoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzMyApCgkJCQkJfHwKCQkJCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkJCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkKCQkJCQl8fAoJCQkJCS8vIFdlYk9TIGxlc3MgdGhhbiAzCgkJCQkJKCAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3cgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApCgkJCQkJfHwKCQkJCQkvLyBNZWVHbwoJCQkJCSggdWEuaW5kZXhPZiggIk1lZUdvIiApID4gLTEgJiYgdWEuaW5kZXhPZiggIk5va2lhQnJvd3Nlci84LjUuMCIgKSA+IC0xICkKCQkJCSl7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9LAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQkkZWwgPSBzZWxmLmVsZW1lbnQsCgkJCQl0YnR5cGUgPSAkZWwuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciIsCgkJCQkkcGFnZSA9ICRlbC5jbG9zZXN0KCIudWktcGFnZSIpOwoKCQkJLy8gRmVhdHVyZSBkZXRlY3Rpbmcgc3VwcG9ydCBmb3IKCQkJaWYoIG8uc3VwcG9ydEJsYWNrbGlzdCgpICl7CgkJCQlzZWxmLmRlc3Ryb3koKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJJGVsLmFkZENsYXNzKCAidWktIisgdGJ0eXBlICsiLWZpeGVkIiApOwoKCQkJLy8gImZ1bGxzY3JlZW4iIG92ZXJsYXkgcG9zaXRpb25pbmcKCQkJaWYoIG8uZnVsbHNjcmVlbiApewoJCQkJJGVsLmFkZENsYXNzKCAidWktIisgdGJ0eXBlICsiLWZ1bGxzY3JlZW4iICk7CgkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRidHlwZSArICItZnVsbHNjcmVlbiIgKTsKCQkJfQoJCQkvLyBJZiBub3QgZnVsbHNjcmVlbiwgYWRkIGNsYXNzIHRvIHBhZ2UgdG8gc2V0IHRvcCBvciBib3R0b20gcGFkZGluZwoJCQllbHNlewoJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0YnR5cGUgKyAiLWZpeGVkIiApOwoJCQl9CgoJCQlzZWxmLl9hZGRUcmFuc2l0aW9uQ2xhc3MoKTsKCQkJc2VsZi5fYmluZFBhZ2VFdmVudHMoKTsKCQkJc2VsZi5fYmluZFRvZ2dsZUhhbmRsZXJzKCk7CgkJfSwKCgkJX2FkZFRyYW5zaXRpb25DbGFzczogZnVuY3Rpb24oKXsKCQkJdmFyIHRjbGFzcyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoKCQkJaWYoIHRjbGFzcyAmJiB0Y2xhc3MgIT09ICJub25lIiApewoJCQkJLy8gdXNlIGFwcHJvcHJpYXRlIHNsaWRlIGZvciBoZWFkZXIgb3IgZm9vdGVyCgkJCQlpZiggdGNsYXNzID09PSAic2xpZGUiICl7CgkJCQkJdGNsYXNzID0gdGhpcy5lbGVtZW50LmlzKCAiLnVpLWhlYWRlciIgKSA/ICJzbGlkZWRvd24iIDogInNsaWRldXAiOwoJCQkJfQoKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGNsYXNzICk7CgkJCX0KCQl9LAoKCQlfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCl7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQkkZWwgPSBzZWxmLmVsZW1lbnQ7CgoJCQkvL3BhZ2UgZXZlbnQgYmluZGluZ3MKCQkJLy8gRml4ZWQgdG9vbGJhcnMgcmVxdWlyZSBwYWdlIHpvb20gdG8gYmUgZGlzYWJsZWQsIG90aGVyd2lzZSB1c2FiaWxpdHkgaXNzdWVzIGNyb3AgdXAKCQkJLy8gVGhpcyBtZXRob2QgaXMgbWVhbnQgdG8gZGlzYWJsZSB6b29tIHdoaWxlIGEgZml4ZWQtcG9zaXRpb25lZCB0b29sYmFyIHBhZ2UgaXMgdmlzaWJsZQoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApCgkJCQkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKXsKCQkJCQlpZiggby5kaXNhYmxlUGFnZVpvb20gKXsKCQkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCQkJfQoJCQkJCWlmKCAhby52aXNpYmxlT25QYWdlU2hvdyApewoJCQkJCQlzZWxmLmhpZGUoIHRydWUgKTsKCQkJCQl9CgkJCQl9ICkKCQkJCS5iaW5kKCAid2Via2l0QW5pbWF0aW9uU3RhcnQgYW5pbWF0aW9uc3RhcnQgdXBkYXRlbGF5b3V0IiwgZnVuY3Rpb24oKXsKCQkJCQlpZiggby51cGRhdGVQYWdlUGFkZGluZyApewoJCQkJCQlzZWxmLnVwZGF0ZVBhZ2VQYWRkaW5nKCk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAicGFnZXNob3ciLCBmdW5jdGlvbigpewoJCQkJCXNlbGYudXBkYXRlUGFnZVBhZGRpbmcoKTsKCQkJCQlpZiggby51cGRhdGVQYWdlUGFkZGluZyApewoJCQkJCQkkKCB3aW5kb3cgKS5iaW5kKCAidGhyb3R0bGVkcmVzaXplLiIgKyBzZWxmLndpZGdldE5hbWUsIGZ1bmN0aW9uKCl7CgkJCQkJCSAJc2VsZi51cGRhdGVQYWdlUGFkZGluZygpOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9KQoJCQkJLmJpbmQoICJwYWdlYmVmb3JlaGlkZSIsIGZ1bmN0aW9uKCBlLCB1aSApewoJCQkJCWlmKCBvLmRpc2FibGVQYWdlWm9vbSApewoJCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJCX0KCQkJCQlpZiggby51cGRhdGVQYWdlUGFkZGluZyApewoJCQkJCQkkKCB3aW5kb3cgKS51bmJpbmQoICJ0aHJvdHRsZWRyZXNpemUuIiArIHNlbGYud2lkZ2V0TmFtZSApOwoJCQkJCX0KCgkJCQkJaWYoIG8udHJhY2tQZXJzaXN0ZW50VG9vbGJhcnMgKXsKCQkJCQkJdmFyIHRoaXNGb290ZXIgPSAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMgKSwKCQkJCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMgKSwKCQkJCQkJCW5leHRGb290ZXIgPSB0aGlzRm9vdGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0Zvb3Rlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApLAoJCQkJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICk7CgoJCQkJCQluZXh0Rm9vdGVyID0gbmV4dEZvb3RlciB8fCAkKCk7CgoJCQkJCQkJaWYoIG5leHRGb290ZXIubGVuZ3RoIHx8IG5leHRIZWFkZXIubGVuZ3RoICl7CgoJCQkJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpewoJCQkJCQkJCQluZXh0Rm9vdGVyLmFkZCggbmV4dEhlYWRlciApLmFwcGVuZFRvKCB0aGlzICk7CgkJCQkJCQkJfSk7CgkJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5pcyggIi51aS1oZWFkZXIiICk7CgoJCQkvLyBUaGlzIGJlaGF2aW9yIG9ubHkgYXBwbGllcyB0byAiZml4ZWQiLCBub3QgImZ1bGxzY3JlZW4iCgkJCWlmKCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiApeyByZXR1cm47IH0KCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICRlbC5vdXRlckhlaWdodCgpICk7CgkJfSwKCQkKCQlfdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApewoJCQl2YXIgJHdpbiA9ICQoIHdpbmRvdyApLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuaGVpZ2h0KCksCgkJCQl2aWV3cG9ydEhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiOwoJCQkJCgkJCXJldHVybiAhbm90cmFuc2l0aW9uICYmCgkJCQkoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICYmIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uICE9PSAibm9uZSIgJiYKCQkJCSgKCQkJCQkoIHRidHlwZSA9PT0gImhlYWRlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCA+IGVsSGVpZ2h0ICkgfHwKCQkJCQkoIHRidHlwZSA9PT0gImZvb3RlciIgJiYgIXRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICYmIHNjcm9sbCArIHZpZXdwb3J0SGVpZ2h0IDwgcEhlaWdodCAtIGVsSGVpZ2h0ICkKCQkJCSkgfHwgdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4KCQkJCSk7CgkJfSwKCgkJc2hvdzogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCQkJaWYoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICl7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwucmVtb3ZlQ2xhc3MoIGhpZGVDbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSB0cnVlOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKXsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKXsKCQkJCSRlbAoJCQkJCS5hZGRDbGFzcyggb3V0Y2xhc3MgKQoJCQkJCS5yZW1vdmVDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCBmdW5jdGlvbigpewoJCQkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gZmFsc2U7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbigpewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50OwoKCQkJLy8gdGFwIHRvZ2dsZQoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApCgkJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBlICl7CgkJCQkJaWYoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICl7CgkJCQkJCXNlbGYudG9nZ2xlKCk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZm9jdXNpbiBmb2N1c291dCIsIGZ1bmN0aW9uKCBlICl7CgkJCQkJaWYoIHNjcmVlbi53aWR0aCA8IDUwMCAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApewoJCQkJCQlzZWxmWyAoIGUudHlwZSA9PT0gImZvY3VzaW4iICYmIHNlbGYuX3Zpc2libGUgKSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJZGVzdHJveTogZnVuY3Rpb24oKXsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwoKCS8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwoJJCggZG9jdW1lbnQgKQoJCS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJCQkKCQkJLy8gREVQUkVDQVRFRCBpbiAxLjE6IHN1cHBvcnQgZm9yIGRhdGEtZnVsbHNjcmVlbj10cnVlfGZhbHNlIG9uIHRoZSBwYWdlIGVsZW1lbnQuCgkJCS8vIFRoaXMgbGluZSBlbnN1cmVzIGl0IHN0aWxsIHdvcmtzLCBidXQgd2UgcmVjb21tZW5kIG1vdmluZyB0aGUgYXR0cmlidXRlIHRvIHRoZSB0b29sYmFycyB0aGVtc2VsdmVzLgoJCQlpZiggJCggZS50YXJnZXQgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIgKSApewoJCQkJJCggJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5ub3QoICI6anFtRGF0YShmdWxsc2NyZWVuKSIgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIsIHRydWUgKTsKCQkJfQoJCQkKCQkJJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwoJCX0pOwoKfSkoIGpRdWVyeSApOwoKKCBmdW5jdGlvbiggJCwgd2luZG93ICkgewoJCgkvLyBUaGlzIGZpeCBhZGRyZXNzZXMgYW4gaU9TIGJ1Zywgc28gcmV0dXJuIGVhcmx5IGlmIHRoZSBVQSBjbGFpbXMgaXQncyBzb21ldGhpbmcgZWxzZS4KCWlmKCAhKC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICkgKXsKCQlyZXR1cm47Cgl9CgkKICAgIHZhciB6b29tID0gJC5tb2JpbGUuem9vbSwKCQlldnQsIHgsIHksIHosIGFpZzsKCQogICAgZnVuY3Rpb24gY2hlY2tUaWx0KCBlICl7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoJCQoJCXggPSBNYXRoLmFicyggYWlnLnggKTsKCQl5ID0gTWF0aC5hYnMoIGFpZy55ICk7CgkJeiA9IE1hdGguYWJzKCBhaWcueiApOwoJCQkJCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCiAgICAgICAgaWYoICF3aW5kb3cub3JpZW50YXRpb24gJiYgKCB4ID4gNyB8fCAoICggeiA+IDYgJiYgeSA8IDggfHwgeiA8IDggJiYgeSA+IDYgKSAmJiB4ID4gNSApICkgKXsKCQkJaWYoIHpvb20uZW5hYmxlZCApewoJCQkJem9vbS5kaXNhYmxlKCk7CgkJCX0gICAgICAgIAkKICAgICAgICB9CgkJZWxzZSBpZiggIXpvb20uZW5hYmxlZCApewoJCQl6b29tLmVuYWJsZSgpOwogICAgICAgIH0KICAgIH0KCiAgICAkKCB3aW5kb3cgKQoJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJLmJpbmQoICJkZXZpY2Vtb3Rpb24uaW9zb3JpZW50YXRpb25maXgiLCBjaGVja1RpbHQgKTsKCn0oIGpRdWVyeSwgdGhpcyApKTsKCiggZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJCSRoZWFkID0gJCggImhlYWQiICksCgkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCiAJLy8gdHJpZ2dlciBtb2JpbGVpbml0IGV2ZW50IC0gdXNlZnVsIGhvb2sgZm9yIGNvbmZpZ3VyaW5nICQubW9iaWxlIHNldHRpbmdzIGJlZm9yZSB0aGV5J3JlIHVzZWQKCSQoIHdpbmRvdy5kb2N1bWVudCApLnRyaWdnZXIoICJtb2JpbGVpbml0IiApOwoKCS8vIHN1cHBvcnQgY29uZGl0aW9ucwoJLy8gaWYgZGV2aWNlIHN1cHBvcnQgY29uZGl0aW9uKHMpIGFyZW4ndCBtZXQsIGxlYXZlIHRoaW5ncyBhcyB0aGV5IGFyZSAtPiBhIGJhc2ljLCB1c2FibGUgZXhwZXJpZW5jZSwKCS8vIG90aGVyd2lzZSwgcHJvY2VlZCB3aXRoIHRoZSBlbmhhbmNlbWVudHMKCWlmICggISQubW9iaWxlLmdyYWRlQSgpICkgewoJCXJldHVybjsKCX0KCgkvLyBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzCgkvLyBvciBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChCQjUsIE9wZXJhIE1pbmkpCglpZiAoICQubW9iaWxlLmFqYXhCbGFja2xpc3QgKSB7CgkJJC5tb2JpbGUuYWpheEVuYWJsZWQgPSBmYWxzZTsKCX0KCgkvLyBBZGQgbW9iaWxlLCBpbml0aWFsIGxvYWQgInJlbmRlcmluZyIgY2xhc3NlcyB0byBkb2NFbAoJJGh0bWwuYWRkQ2xhc3MoICJ1aS1tb2JpbGUgdWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCgkvLyBUaGlzIGlzIGEgZmFsbGJhY2suIElmIGFueXRoaW5nIGdvZXMgd3JvbmcgKEpTIGVycm9ycywgZXRjKSwgb3IgZXZlbnRzIGRvbid0IGZpcmUsCgkvLyB0aGlzIGVuc3VyZXMgdGhlIHJlbmRlcmluZyBjbGFzcyBpcyByZW1vdmVkIGFmdGVyIDUgc2Vjb25kcywgc28gY29udGVudCBpcyB2aXNpYmxlIGFuZCBhY2Nlc3NpYmxlCglzZXRUaW1lb3V0KCBoaWRlUmVuZGVyaW5nQ2xhc3MsIDUwMDAgKTsKCgkvLyBsb2FkaW5nIGRpdiB3aGljaCBhcHBlYXJzIGR1cmluZyBBamF4IHJlcXVlc3RzCgkvLyB3aWxsIG5vdCBhcHBlYXIgaWYgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgaXMgZmFsc2UKCXZhciBsb2FkZXJDbGFzcyA9ICJ1aS1sb2FkZXIiLAoJCSRsb2FkZXIgPSAkKCAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+PHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi1sb2FkaW5nJz48L3NwYW4+PGgxPjwvaDE+PC9kaXY+IiApOwoKCS8vIEZvciBub24tZml4ZWQgc3VwcG9ydGluIGJyb3dzZXJzLiBQb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCglmdW5jdGlvbiBmYWtlRml4TG9hZGVyKCl7CgkJdmFyIGFjdGl2ZUJ0biA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZmlyc3QoKTsKCgkJJGxvYWRlcgoJCQkuY3NzKHsKCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiAkd2luZG93LnNjcm9sbFRvcCgpICsgJHdpbmRvdy5oZWlnaHQoKSAvIDIgfHwKCQkJCWFjdGl2ZUJ0bi5sZW5ndGggJiYgYWN0aXZlQnRuLm9mZnNldCgpLnRvcCB8fCAxMDAKCQkJfSk7Cgl9CgoJLy8gY2hlY2sgcG9zaXRpb24gb2YgbG9hZGVyIHRvIHNlZSBpZiBpdCBhcHBlYXJzIHRvIGJlICJmaXhlZCIgdG8gY2VudGVyCgkvLyBpZiBub3QsIHVzZSBhYnMgcG9zaXRpb25pbmcKCWZ1bmN0aW9uIGNoZWNrTG9hZGVyUG9zaXRpb24oKXsKCQl2YXIgb2Zmc2V0ID0gJGxvYWRlci5vZmZzZXQoKSwKCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWlmKCBvZmZzZXQudG9wIDwgc2Nyb2xsVG9wIHx8IChvZmZzZXQudG9wIC0gc2Nyb2xsVG9wKSA+IHNjcmVlbkhlaWdodCApIHsKCQkJJGxvYWRlci5hZGRDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQlmYWtlRml4TG9hZGVyKCk7CgkJCSR3aW5kb3cKCQkJCS51bmJpbmQoICJzY3JvbGwiLCBjaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCS5iaW5kKCAic2Nyb2xsIiwgZmFrZUZpeExvYWRlciApOwoJCX0KCX0KCgkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCglmdW5jdGlvbiBoaWRlUmVuZGVyaW5nQ2xhc3MoKXsKCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLW1vYmlsZS1yZW5kZXJpbmciICk7Cgl9CgoJJC5leHRlbmQoJC5tb2JpbGUsIHsKCQkvLyB0dXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4KCQlzaG93UGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCSRodG1sLmFkZENsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgKSB7CgkJCQkvLyB0ZXh0IHZpc2liaWxpdHkgZnJvbSBhcmd1bWVudCB0YWtlcyBwcmlvcml0eQoJCQkJdmFyIHRleHRWaXNpYmxlID0gdGV4dG9ubHkgfHwgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTsKCgkJCQl0aGVtZSA9IHRoZW1lIHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGhlbWUsCgoJCQkJJGxvYWRlcgoJCQkJCS5hdHRyKCAiY2xhc3MiLCBsb2FkZXJDbGFzcyArICIgdWktY29ybmVyLWFsbCB1aS1ib2R5LSIgKyAoIHRoZW1lIHx8ICJhIiApICsgIiB1aS1sb2FkZXItIiArICggdGV4dFZpc2libGUgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArICggdGV4dG9ubHkgPyAiIHVpLWxvYWRlci10ZXh0b25seSIgOiAiIiApICkKCQkJCQkuZmluZCggImgxIiApCgkJCQkJCS50ZXh0KCBtc2dUZXh0IHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICkKCQkJCQkJLmVuZCgpCgkJCQkJLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQkJY2hlY2tMb2FkZXJQb3NpdGlvbigpOwoJCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsIiwgY2hlY2tMb2FkZXJQb3NpdGlvbiApOwoJCQl9CgkJfSwKCgkJaGlkZVBhZ2VMb2FkaW5nTXNnOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICl7CgkJCQkkbG9hZGVyLnJlbW92ZUNsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCX0KCgkJCSQoIHdpbmRvdyApLnVuYmluZCggInNjcm9sbCIsIGZha2VGaXhMb2FkZXIgKTsKCQkJJCggd2luZG93ICkudW5iaW5kKCAic2Nyb2xsIiwgY2hlY2tMb2FkZXJQb3NpdGlvbiApOwoJCX0sCgoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyICRwYWdlcyA9ICQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApOwoKCQkJLy8gaWYgbm8gcGFnZXMgYXJlIGZvdW5kLCBjcmVhdGUgb25lIHdpdGggYm9keSdzIGlubmVyIGh0bWwKCQkJaWYgKCAhJHBhZ2VzLmxlbmd0aCApIHsKCQkJCSRwYWdlcyA9ICQoICJib2R5IiApLndyYXBJbm5lciggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+PC9kaXY+IiApLmNoaWxkcmVuKCAwICk7CgkJCX0KCgkJCS8vIGFkZCBkaWFsb2dzLCBzZXQgZGF0YS11cmwgYXR0cnMKCQkJJHBhZ2VzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJCS8vIHVubGVzcyB0aGUgZGF0YSB1cmwgaXMgYWxyZWFkeSBzZXQgc2V0IGl0IHRvIHRoZSBwYXRobmFtZQoJCQkJaWYgKCAhJHRoaXMuanFtRGF0YSgidXJsIikgKSB7CgkJCQkJJHRoaXMuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIsICR0aGlzLmF0dHIoICJpZCIgKSB8fCBsb2NhdGlvbi5wYXRobmFtZSArIGxvY2F0aW9uLnNlYXJjaCApOwoJCQkJfQoJCQl9KTsKCgkJCS8vIGRlZmluZSBmaXJzdCBwYWdlIGluIGRvbSBjYXNlIG9uZSBiYWNrcyBvdXQgdG8gdGhlIGRpcmVjdG9yeSByb290IChub3QgYWx3YXlzIHRoZSBmaXJzdCBwYWdlIHZpc2l0ZWQsIGJ1dCBkZWZpbmVkIGFzIGZhbGxiYWNrKQoJCQkkLm1vYmlsZS5maXJzdFBhZ2UgPSAkcGFnZXMuZmlyc3QoKTsKCgkJCS8vIGRlZmluZSBwYWdlIGNvbnRhaW5lcgoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyID0gJHBhZ2VzLmZpcnN0KCkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCBvciB0aGVyZSdzIG5vIGhhc2ggZGVlcGxpbmssIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCWlmICggISQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkIHx8ICEkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggbG9jYXRpb24uaGFzaCApICkgewoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7IHRyYW5zaXRpb246ICJub25lIiwgcmV2ZXJzZTogdHJ1ZSwgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCQkvLyBvdGhlcndpc2UsIHRyaWdnZXIgYSBoYXNoY2hhbmdlIHRvIGxvYWQgYSBkZWVwbGluawoJCQllbHNlIHsKCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbIHRydWUgXSApOwoJCQl9CgkJfQoJfSk7CgoJLy8gaW5pdGlhbGl6ZSBldmVudHMgbm93LCBhZnRlciBtb2JpbGVpbml0IGhhcyBvY2N1cnJlZAoJJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMoKTsKCgkvLyBjaGVjayB3aGljaCBzY3JvbGxUb3AgdmFsdWUgc2hvdWxkIGJlIHVzZWQgYnkgc2Nyb2xsaW5nIHRvIDEgaW1tZWRpYXRlbHkgYXQgZG9tcmVhZHkKCS8vIHRoZW4gY2hlY2sgd2hhdCB0aGUgc2Nyb2xsIHRvcCBpcy4gQW5kcm9pZCB3aWxsIHJlcG9ydCAwLi4uIG90aGVycyAxCgkvLyBub3RlIHRoYXQgdGhpcyBpbml0aWFsIHNjcm9sbCB3b24ndCBoaWRlIHRoZSBhZGRyZXNzIGJhci4gSXQncyBqdXN0IGZvciB0aGUgY2hlY2suCgkkKGZ1bmN0aW9uKCkgewoJCXdpbmRvdy5zY3JvbGxUbyggMCwgMSApOwoKCQkvLyBpZiBkZWZhdWx0SG9tZVNjcm9sbCBoYXNuJ3QgYmVlbiBzZXQgeWV0LCBzZWUgaWYgc2Nyb2xsVG9wIGlzIDEKCQkvLyBpdCBzaG91bGQgYmUgMSBpbiBtb3N0IGJyb3dzZXJzLCBidXQgYW5kcm9pZCB0cmVhdHMgMSBhcyAwIChmb3IgaGlkaW5nIGFkZHIgYmFyKQoJCS8vIHNvIGlmIGl0J3MgMSwgdXNlIDAgZnJvbSBub3cgb24KCQkkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA9ICggISQuc3VwcG9ydC5zY3JvbGxUb3AgfHwgJCh3aW5kb3cpLnNjcm9sbFRvcCgpID09PSAxICkgPyAwIDogMTsKCgoJCS8vIFRPRE86IEltcGxlbWVudCBhIHByb3BlciByZWdpc3RyYXRpb24gbWVjaGFuaXNtIHdpdGggZGVwZW5kZW5jeSBoYW5kbGluZyBpbiBvcmRlciB0byBub3QgaGF2ZSBleGNlcHRpb25zIGxpa2UgdGhlIG9uZSBiZWxvdwoJCS8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cyBmb3IgdGhvc2Ugd2lkZ2V0cyB0aGF0IGhhdmUgYSBzb2Z0IGRlcGVuZGVuY3kgb24gb3RoZXJzCgkJaWYgKCAkLmZuLmNvbnRyb2xncm91cCApIHsKCQkJJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJCQkJJCggIjpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpIiwgZS50YXJnZXQgKQoJCQkJCS5qcW1FbmhhbmNlYWJsZSgpCgkJCQkJLmNvbnRyb2xncm91cCh7IGV4Y2x1ZGVJbnZpc2libGU6IGZhbHNlIH0pOwoJCQl9KTsKCQl9CgoJCS8vZG9tLXJlYWR5IGluaXRzCgkJaWYoICQubW9iaWxlLmF1dG9Jbml0aWFsaXplUGFnZSApewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkCgkJJHdpbmRvdy5sb2FkKCAkLm1vYmlsZS5zaWxlbnRTY3JvbGwgKTsKCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 11:27:22 GMT",
                    "Content-Length": "238388",
                    "Date": "Thu, 06 Nov 2014 11:27:27 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}