{
    "url": "http://localhost:9999/bq/blockly/apps/common.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.search</b> and written to <b>window.location</b> via the following statements:<ul><li>var search = window.location.search;</li><li>search = search.replace(/\\?/, '?lang=' + newLang + '&amp;');</li><li>window.location = window.location.protocol + '//' +       window.location.host + window.location.pathname + search;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/bq/blockly/apps/common.js",
                "path": "/bq/blockly/apps/common.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9icS9ibG9ja2x5L2FwcHMvY29tbW9uLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjY5ODENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTI6NTI6MTYgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDEyOjUyOjEwIEdNVA0KDQovKioKICogQmxvY2tseSBBcHBzOiBDb21tb24gY29kZQogKgogKiBDb3B5cmlnaHQgMjAxMyBHb29nbGUgSW5jLgogKiBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9ibG9ja2x5LwogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgovKioKICogQGZpbGVvdmVydmlldyBDb21tb24gc3VwcG9ydCBjb2RlIGZvciBCbG9ja2x5IGFwcHMuCiAqIEBhdXRob3IgZnJhc2VyQGdvb2dsZS5jb20gKE5laWwgRnJhc2VyKQogKi8KJ3VzZSBzdHJpY3QnOwoKdmFyIEJsb2NrbHlBcHBzID0ge307CgovKioKICogTG9va3VwIGZvciBuYW1lcyBvZiBsYW5ndWFnZXMuICBLZXlzIHNob3VsZCBiZSBpbiBJU08gNjM5IGZvcm1hdC4KICovCkJsb2NrbHlBcHBzLkxBTkdVQUdFX05BTUUgPSB7CiAgJ2FjZSc6ICfYqNmH2LPYpyDYp9qG2YrZhycsCiAgJ2FmJzogJ0FmcmlrYWFucycsCiAgJ2FyJzogJ9in2YTYudix2KjZitipJywKICAnYXonOiAnQXrJmXJiYXljYW5jYScsCiAgJ2JlLXRhcmFzayc6ICdUYXJhxaFraWV2aWNhJywKICAnYnInOiAnQnJlemhvbmVnJywKICAnY2EnOiAnQ2F0YWzDoCcsCiAgJ2Nkbyc6ICfplqnmnbHoqp4nLAogICdjcyc6ICfEjGVza3knLAogICdkYSc6ICdEYW5zaycsCiAgJ2RlJzogJ0RldXRzY2gnLAogICdlbCc6ICfOlc67zrvOt869zrnOus6sJywKICAnZW4nOiAnRW5nbGlzaCcsCiAgJ2VzJzogJ0VzcGHDsW9sJywKICAnZXUnOiAnRXVza2FyYScsCiAgJ2ZhJzogJ9mB2KfYsdiz24wnLAogICdmaSc6ICdTdW9taScsCiAgJ2ZvJzogJ0bDuHJveXNrdCcsCiAgJ2ZyJzogJ0ZyYW7Dp2FpcycsCiAgJ2Zycic6ICdGcmFzY2gnLAogICdnbCc6ICdHYWxlZ28nLAogICdoYWsnOiAn5a6i5a626KmxJywKICAnaGUnOiAn16LXkdeo15nXqicsCiAgJ2hpJzogJ+CkueCkv+CkqOCljeCkpuClgCcsCiAgJ2hyeCc6ICdIdW5zcmlrJywKICAnaHUnOiAnTWFneWFyJywKICAnaWEnOiAnSW50ZXJsaW5ndWEnLAogICdpZCc6ICdCYWhhc2EgSW5kb25lc2lhJywKICAnaXMnOiAnw41zbGVuc2thJywKICAnaXQnOiAnSXRhbGlhbm8nLAogICdqYSc6ICfml6XmnKzoqp4nLAogICdrYSc6ICfhg6Xhg5Dhg6Dhg5fhg6Phg5rhg5gnLAogICdrbSc6ICfhnpfhnrbhnp/hnrbhnoHhn5Lhnpjhn4LhnponLAogICdrbyc6ICftlZzqta3slrQnLAogICdrc2gnOiAnUmlwb2FyxJdzY2gnLAogICdreSc6ICfQmtGL0YDQs9GL0LfRh9CwJywKICAnbGEnOiAnTGF0aW5lJywKICAnbGInOiAnTMOrdHplYnVlcmdlc2NoJywKICAnbHQnOiAnTGlldHV2acWzJywKICAnbHYnOiAnTGF0dmllxaF1JywKICAnbWcnOiAnTWFsYWdhc3knLAogICdtbCc6ICfgtK7gtLLgtK/gtL7gtLPgtIInLAogICdtayc6ICfQnNCw0LrQtdC00L7QvdGB0LrQuCcsCiAgJ21yJzogJ+CkruCksOCkvuCkoOClgCcsCiAgJ21zJzogJ0JhaGFzYSBNZWxheXUnLAogICdtem4nOiAn2YXYp9iy2ZDYsdmI2YbbjCcsCiAgJ25iJzogJ05vcnNrIEJva23DpWwnLAogICdubCc6ICdOZWRlcmxhbmRzLCBWbGFhbXMnLAogICdvYyc6ICdMZW5nYSBkXCfDsmMnLAogICdwYSc6ICfgpKrgpILgpJzgpL7gpKzgpYAnLAogICdwbCc6ICdQb2xza2knLAogICdwbXMnOiAnUGllbW9udMOoaXMnLAogICdwcyc6ICfZvtqa2KrZiCcsCiAgJ3B0JzogJ1BvcnR1Z3XDqnMnLAogICdybyc6ICdSb23Dom7EgycsCiAgJ3B0LWJyJzogJ1BvcnR1Z3XDqnMgQnJhc2lsZWlybycsCiAgJ3J1JzogJ9Cg0YPRgdGB0LrQuNC5JywKICAnc2MnOiAnU2FyZHUnLAogICdzY28nOiAnU2NvdHMnLAogICdzaSc6ICfgt4Pgt5LgtoLgt4Tgtr0nLAogICdzayc6ICdTbG92ZW7EjWluYScsCiAgJ3NyJzogJ9Ch0YDQv9GB0LrQuCcsCiAgJ3N2JzogJ1N2ZW5za2EnLAogICdzdyc6ICdLaXNod2FoaWxpJywKICAndGgnOiAn4Lig4Liy4Lip4Liy4LmE4LiX4LiiJywKICAndGwnOiAnVGFnYWxvZycsCiAgJ3RsaCc6ICd0bGhJbmdhbiBIb2wnLAogICd0cic6ICdUw7xya8OnZScsCiAgJ3VrJzogJ9Cj0LrRgNCw0ZfQvdGB0YzQutCwJywKICAndmknOiAnVGnhur9uZyBWaeG7h3QnLAogICd6aC1oYW5zJzogJ+ewoemrlOS4reaWhycsCiAgJ3poLWhhbnQnOiAn5q2j6auU5Lit5paHJwp9OwoKLyoqCiAqIExpc3Qgb2YgUlRMIGxhbmd1YWdlcy4KICovCkJsb2NrbHlBcHBzLkxBTkdVQUdFX1JUTCA9IFsnYWNlJywgJ2FyJywgJ2ZhJywgJ2hlJywgJ216bicsICdwcyddOwoKLyoqCiAqIExvb2t1cCBmb3IgQmxvY2tseSBjb3JlIGJsb2NrIGxhbmd1YWdlIHBhY2suCiAqLwpCbG9ja2x5QXBwcy5MQU5HVUFHRV9QQUNLID0gewogICdhcic6ICdtc2cvanMvYXIuanMnLAogICdhei1sYXRuJzogJ21zZy9qcy9hei1sYXRuLmpzJywKICAnYXonOiAnbXNnL2pzL2F6LmpzJywKICAnY2EnOiAnbXNnL2pzL2NhLmpzJywKICAnY2RvJzogJ21zZy9qcy96aC1oYW50LmpzJywKICAnY3MnOiAnbXNnL2pzL2NzLmpzJywKICAnZGEnOiAnbXNnL2pzL2RhLmpzJywKICAnZGUnOiAnbXNnL2pzL2RlLmpzJywKICAnZWwnOiAnbXNnL2pzL2VsLmpzJywKICAnZW4nOiAnbXNnL2pzL2VuLmpzJywKICAnZW5fdXMnOiAnbXNnL2pzL2VuX3VzLmpzJywKICAnZXMnOiAnbXNnL2pzL2VzLmpzJywKICAnZmEnOiAnbXNnL2pzL2ZhLmpzJywKICAnZmknOiAnbXNnL2pzL2ZpLmpzJywKICAnZnInOiAnbXNnL2pzL2ZyLmpzJywKICAnZnJyJzogJ21zZy9qcy9kZS5qcycsCiAgJ2hlJzogJ21zZy9qcy9oZS5qcycsCiAgJ2hyeCc6ICdtc2cvanMvaHJ4LmpzJywKICAnaHUnOiAnbXNnL2pzL2h1LmpzJywKICAnaWQnOiAnbXNnL2pzL2lkLmpzJywKICAnaXMnOiAnbXNnL2pzL2lzLmpzJywKICAnaXQnOiAnbXNnL2pzL2l0LmpzJywKICAnamEnOiAnbXNnL2pzL2phLmpzJywKICAna28nOiAnbXNnL2pzL2tvLmpzJywKICAna3NoJzogJ21zZy9qcy9kZS5qcycsCiAgJ2xiJzogJ21zZy9qcy9kZS5qcycsCiAgJ21zJzogJ21zZy9qcy9tcy5qcycsCiAgJ25iJzogJ21zZy9qcy9uYi5qcycsCiAgJ25sJzogJ21zZy9qcy9ubC5qcycsCiAgJ25vJzogJ21zZy9qcy9uby5qcycsCiAgJ3BsJzogJ21zZy9qcy9wbC5qcycsCiAgJ3Btcyc6ICdtc2cvanMvcG1zLmpzJywKICAncHQnOiAnbXNnL2pzL3B0LmpzJywKICAncHQtYnInOiAnbXNnL2pzL3B0LWJyLmpzJywKICAvLyBXZSB1c2VkIHRvIHVzZSBwdF9iciBmb3IgcHQtYnIgKHVudGlsIE5vdmVtYmVyIDIwMTMpLgogIC8vIFVzZXJzIG1heSBzdGlsbCBoYXZlIFVSTHMuCiAgJ3B0X2JyJzogJ21zZy9qcy9wdC1ici5qcycsCiAgJ3JvJzogJ21zZy9qcy9yby5qcycsCiAgJ3J1JzogJ21zZy9qcy9ydS5qcycsCiAgJ3NxJzogJ21zZy9qcy9zcS5qcycsCiAgJ3NyJzogJ21zZy9qcy9zci5qcycsCiAgJ3N2JzogJ21zZy9qcy9zdi5qcycsCiAgJ3RoJzogJ21zZy9qcy90aC5qcycsCiAgJ3RsJzogJ21zZy9qcy90bC5qcycsCiAgJ3RsaCc6ICdtc2cvanMvdGxoLmpzJywKICAndHInOiAnbXNnL2pzL3RyLmpzJywKICAndWsnOiAnbXNnL2pzL3VrLmpzJywKICAndmknOiAnbXNnL2pzL3ZpLmpzJywKICAnemgtaGFucyc6ICdtc2cvanMvemgtaGFucy5qcycsCiAgJ3poLWhhbnQnOiAnbXNnL2pzL3poLWhhbnQuanMnLAogIC8vIFdlIHVzZWQgdG8gdXNlIHpoLXR3IGZvciB6aC1oYW50ICh1bnRpbCBOb3ZlbWJlciAyMDEzKS4KICAvLyBVc2VycyBtYXkgc3RpbGwgaGF2ZSBVUkxzLgogICd6aC10dyc6ICdtc2cvanMvemgtaGFudC5qcycsCiAgJ2RlZmF1bHQnOiAnbXNnL2pzL2VuLmpzJwp9OwoKLyoqCiAqIFVzZXIncyBsYW5ndWFnZSAoZS5nLiAiZW4iKS4KICogQHR5cGUgc3RyaW5nPQogKi8KQmxvY2tseUFwcHMuTEFORyA9IHVuZGVmaW5lZDsKCi8qKgogKiBMaXN0IG9mIGxhbmd1YWdlcyBzdXBwb3J0ZWQgYnkgdGhpcyBhcHAuICBWYWx1ZXMgc2hvdWxkIGJlIGluIElTTyA2MzkgZm9ybWF0LgogKiBAdHlwZSAhQXJyYXkuPHN0cmluZz49CiAqLwpCbG9ja2x5QXBwcy5MQU5HVUFHRVMgPSB1bmRlZmluZWQ7CgovKioKICogTGVuZ3RoIG9mIHRpbWUgdG8gc3VwcmVzcyBjbGlja3MgdG8gYXZvaWQgYSBkb3VibGUtY2xpY2suCiAqIEB0eXBlIG51bWJlcgogKi8KQmxvY2tseUFwcHMuRE9VQkxFX0NMSUNLX1RJTUUgPSA0MDA7CgovKioKICogRXh0cmFjdHMgYSBwYXJhbWV0ZXIgZnJvbSB0aGUgVVJMLgogKiBJZiB0aGUgcGFyYW1ldGVyIGlzIGFic2VudCBkZWZhdWx0X3ZhbHVlIGlzIHJldHVybmVkLgogKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgcGFyYW1ldGVyLgogKiBAcGFyYW0ge3N0cmluZ30gZGVmYXVsdFZhbHVlIFZhbHVlIHRvIHJldHVybiBpZiBwYXJhbWF0ZXIgbm90IGZvdW5kLgogKiBAcmV0dXJuIHtzdHJpbmd9IFRoZSBwYXJhbWV0ZXIgdmFsdWUgb3IgdGhlIGRlZmF1bHQgdmFsdWUgaWYgbm90IGZvdW5kLgogKi8KQmxvY2tseUFwcHMuZ2V0U3RyaW5nUGFyYW1Gcm9tVXJsID0gZnVuY3Rpb24obmFtZSwgZGVmYXVsdFZhbHVlKSB7CiAgdmFyIHZhbCA9CiAgICAgIHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gubWF0Y2gobmV3IFJlZ0V4cCgnWz8mXScgKyBuYW1lICsgJz0oW14mXSspJykpOwogIHJldHVybiB2YWwgPyBkZWNvZGVVUklDb21wb25lbnQodmFsWzFdLnJlcGxhY2UoL1wrL2csICclMjAnKSkgOiBkZWZhdWx0VmFsdWU7Cn07CgovKioKICogRXh0cmFjdHMgYSBudW1lcmljIHBhcmFtZXRlciBmcm9tIHRoZSBVUkwuCiAqIElmIHRoZSBwYXJhbWV0ZXIgaXMgYWJzZW50IG9yIGxlc3MgdGhhbiBtaW5fdmFsdWUsIG1pbl92YWx1ZSBpcwogKiByZXR1cm5lZC4gIElmIGl0IGlzIGdyZWF0ZXIgdGhhbiBtYXhfdmFsdWUsIG1heF92YWx1ZSBpcyByZXR1cm5lZC4KICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHBhcmFtZXRlci4KICogQHBhcmFtIHtudW1iZXJ9IG1pblZhbHVlIFRoZSBtaW5pbXVtIGxlZ2FsIHZhbHVlLgogKiBAcGFyYW0ge251bWJlcn0gbWF4VmFsdWUgVGhlIG1heGltdW0gbGVnYWwgdmFsdWUuCiAqIEByZXR1cm4ge251bWJlcn0gQSBudW1iZXIgaW4gdGhlIHJhbmdlIFttaW5fdmFsdWUsIG1heF92YWx1ZV0uCiAqLwpCbG9ja2x5QXBwcy5nZXROdW1iZXJQYXJhbUZyb21VcmwgPSBmdW5jdGlvbihuYW1lLCBtaW5WYWx1ZSwgbWF4VmFsdWUpIHsKICB2YXIgdmFsID0gTnVtYmVyKEJsb2NrbHlBcHBzLmdldFN0cmluZ1BhcmFtRnJvbVVybChuYW1lLCAnTmFOJykpOwogIHJldHVybiBpc05hTih2YWwpID8gbWluVmFsdWUgOiBNYXRoLm1pbihNYXRoLm1heChtaW5WYWx1ZSwgdmFsKSwgbWF4VmFsdWUpOwp9OwoKLyoqCiAqIFVzZSBhIHNlcmllcyBvZiBoZXVyaXN0aWNzIHRoYXQgZGV0ZXJtaW5lIHRoZSBsaWtlbHkgbGFuZ3VhZ2Ugb2YgdGhpcyB1c2VyLgogKiBVc2UgYSBzZXNzaW9uIGNvb2tpZSB0byBsb2FkL3NhdmUgdGhlIGxhbmd1YWdlIHByZWZlcmVuY2UuCiAqIEByZXR1cm4ge3N0cmluZ30gVXNlcidzIGxhbmd1YWdlLgogKiBAdGhyb3dzIHtzdHJpbmd9IElmIG5vIGxhbmd1YWdlcyBleGlzdCBpbiB0aGlzIGFwcC4KICovCkJsb2NrbHlBcHBzLmdldExhbmcgPSBmdW5jdGlvbigpIHsKICAvLyBGaXJzdCBjaG9pY2U6IFRoZSBVUkwgc3BlY2lmaWVkIGxhbmd1YWdlLgogIHZhciBsYW5nID0gQmxvY2tseUFwcHMuZ2V0U3RyaW5nUGFyYW1Gcm9tVXJsKCdsYW5nJywgJycpOwogIGlmIChCbG9ja2x5QXBwcy5MQU5HVUFHRVMuaW5kZXhPZihsYW5nKSAhPSAtMSkgewogICAgLy8gU2F2ZSB0aGlzIGV4cGxpY2l0IGNob2ljZSBhcyBjb29raWUuCiAgICAvLyBVc2Ugb2YgYSBzZXNzaW9uIGNvb2tpZSBmb3Igc2F2aW5nIGxhbmd1YWdlIGlzIGV4cGxpY2l0bHkgcGVybWl0dGVkCiAgICAvLyBpbiB0aGUgRVUncyBDb29raWUgQ29uc2VudCBFeGVtcHRpb24gcG9saWN5LiAgU2VjdGlvbiAzLjY6CiAgICAvLyBodHRwOi8vZWMuZXVyb3BhLmV1L2p1c3RpY2UvZGF0YS1wcm90ZWN0aW9uL2FydGljbGUtMjkvZG9jdW1lbnRhdGlvbi8KICAgIC8vICAgb3Bpbmlvbi1yZWNvbW1lbmRhdGlvbi9maWxlcy8yMDEyL3dwMTk0X2VuLnBkZgogICAgZG9jdW1lbnQuY29va2llID0gJ2xhbmc9JyArIGVzY2FwZShsYW5nKSArICc7IHBhdGg9Lyc7CiAgICByZXR1cm4gbGFuZzsKICB9CiAgLy8gU2Vjb25kIGNob2ljZTogTGFuZ3VhZ2UgY29va2llLgogIHZhciBjb29raWUgPSBkb2N1bWVudC5jb29raWUubWF0Y2goLyhefDspXHMqbGFuZz0oXHcrKS8pOwogIGlmIChjb29raWUpIHsKICAgIGxhbmcgPSB1bmVzY2FwZShjb29raWVbMl0pOwogICAgaWYgKEJsb2NrbHlBcHBzLkxBTkdVQUdFUy5pbmRleE9mKGxhbmcpICE9IC0xKSB7CiAgICAgIHJldHVybiBsYW5nOwogICAgfQogIH0KICAvLyBUaGlyZCBjaG9pY2U6IFRoZSBicm93c2VyJ3MgbGFuZ3VhZ2UuCiAgbGFuZyA9IG5hdmlnYXRvci5sYW5ndWFnZTsKICBpZiAoQmxvY2tseUFwcHMuTEFOR1VBR0VTLmluZGV4T2YobGFuZykgIT0gLTEpIHsKICAgIHJldHVybiBsYW5nOwogIH0KICAvLyBGb3VydGggY2hvaWNlOiBFbmdsaXNoLgogIGxhbmcgPSAnZW4nOwogIGlmIChCbG9ja2x5QXBwcy5MQU5HVUFHRVMuaW5kZXhPZihsYW5nKSAhPSAtMSkgewogICAgcmV0dXJuIGxhbmc7CiAgfQogIC8vIEZpZnRoIGNob2ljZTogSSdtIGZlZWxpbmcgbHVja3kuCiAgaWYgKEJsb2NrbHlBcHBzLkxBTkdVQUdFUy5sZW5ndGgpIHsKICAgIHJldHVybiBCbG9ja2x5QXBwcy5MQU5HVUFHRVNbMF07CiAgfQogIC8vIFNpeHRoIGNob2ljZTogRGllLgogIHRocm93ICdObyBsYW5ndWFnZXMgYXZhaWxhYmxlLic7Cn07CgovKioKICogSXMgdGhlIGN1cnJlbnQgbGFuZ3VhZ2UgKEJsb2NrbHlBcHBzLkxBTkcpIGFuIFJUTCBsYW5ndWFnZT8KICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBSVEwsIGZhbHNlIGlmIExUUi4KICovCkJsb2NrbHlBcHBzLmlzUnRsID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIEJsb2NrbHlBcHBzLkxBTkdVQUdFX1JUTC5pbmRleE9mKEJsb2NrbHlBcHBzLkxBTkcpICE9IC0xOwp9OwoKLyoqCiAqIExvb2sgdXAgdGhlIEJsb2NrbHkgbGFuZ3VhZ2UgcGFjayBmb3IgY3VycmVudCBsYW5ndWFnZSAoQmxvY2tseUFwcHMuTEFORykuCiAqIEByZXR1cm4ge3N0cmluZ30gVVJMIHRvIGxhbmd1Z2FlIHBhY2sgKGUuZy4gJ21zZy9qcy9lbi5qcycpLgogKi8KQmxvY2tseUFwcHMubGFuZ3VhZ2VQYWNrID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIEJsb2NrbHlBcHBzLkxBTkdVQUdFX1BBQ0tbQmxvY2tseUFwcHMuTEFOR10gfHwKICAgIEJsb2NrbHlBcHBzLkxBTkdVQUdFX1BBQ0tbJ2RlZmF1bHQnXTsKfTsKCi8qKgogKiBDb21tb24gc3RhcnR1cCB0YXNrcyBmb3IgYWxsIGFwcHMuCiAqLwpCbG9ja2x5QXBwcy5pbml0ID0gZnVuY3Rpb24oKSB7CiAgLy8gU2V0IHRoZSBwYWdlIHRpdGxlIHdpdGggdGhlIGNvbnRlbnQgb2YgdGhlIEgxIHRpdGxlLgogIGRvY3VtZW50LnRpdGxlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RpdGxlJykudGV4dENvbnRlbnQ7CgogIC8vIFNldCB0aGUgSFRNTCdzIGxhbmd1YWdlIGFuZCBkaXJlY3Rpb24uCiAgLy8gZG9jdW1lbnQuZGlyIGZhaWxzIGluIE1vemlsbGEsIHVzZSBkb2N1bWVudC5ib2R5LnBhcmVudE5vZGUuZGlyIGluc3RlYWQuCiAgLy8gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MTUxNDA3CiAgdmFyIHJ0bCA9IEJsb2NrbHlBcHBzLmlzUnRsKCk7CiAgZG9jdW1lbnQuaGVhZC5wYXJlbnRFbGVtZW50LnNldEF0dHJpYnV0ZSgnZGlyJywgcnRsID8gJ3J0bCcgOiAnbHRyJyk7CiAgZG9jdW1lbnQuaGVhZC5wYXJlbnRFbGVtZW50LnNldEF0dHJpYnV0ZSgnbGFuZycsIEJsb2NrbHlBcHBzLkxBTkcpOwoKICAvLyBTb3J0IGxhbmd1YWdlcyBhbHBoYWJldGljYWxseS4KICB2YXIgbGFuZ3VhZ2VzID0gW107CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBCbG9ja2x5QXBwcy5MQU5HVUFHRVMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBsYW5nID0gQmxvY2tseUFwcHMuTEFOR1VBR0VTW2ldOwogICAgbGFuZ3VhZ2VzLnB1c2goW0Jsb2NrbHlBcHBzLkxBTkdVQUdFX05BTUVbbGFuZ10sIGxhbmddKTsKICB9CiAgdmFyIGNvbXAgPSBmdW5jdGlvbihhLCBiKSB7CiAgICAvLyBTb3J0IGJhc2VkIG9uIGZpcnN0IGFyZ3VtZW50ICgnRW5nbGlzaCcsICfQoNGD0YHRgdC60LjQuScsICfnroDkvZPlrZcnLCBldGMpLgogICAgaWYgKGFbMF0gPiBiWzBdKSByZXR1cm4gMTsKICAgIGlmIChhWzBdIDwgYlswXSkgcmV0dXJuIC0xOwogICAgcmV0dXJuIDA7CiAgfTsKICBsYW5ndWFnZXMuc29ydChjb21wKTsKICAvLyBQb3B1bGF0ZSB0aGUgbGFuZ3VhZ2Ugc2VsZWN0aW9uIG1lbnUuCiAgdmFyIGxhbmd1YWdlTWVudSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsYW5ndWFnZU1lbnUnKTsKICBsYW5ndWFnZU1lbnUub3B0aW9ucy5sZW5ndGggPSAwOwogIGZvciAodmFyIGkgPSAwOyBpIDwgbGFuZ3VhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgdHVwbGUgPSBsYW5ndWFnZXNbaV07CiAgICB2YXIgbGFuZyA9IHR1cGxlW3R1cGxlLmxlbmd0aCAtIDFdOwogICAgdmFyIG9wdGlvbiA9IG5ldyBPcHRpb24odHVwbGVbMF0sIGxhbmcpOwogICAgaWYgKGxhbmcgPT0gQmxvY2tseUFwcHMuTEFORykgewogICAgICBvcHRpb24uc2VsZWN0ZWQgPSB0cnVlOwogICAgfQogICAgbGFuZ3VhZ2VNZW51Lm9wdGlvbnMuYWRkKG9wdGlvbik7CiAgfQogIGxhbmd1YWdlTWVudS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBCbG9ja2x5QXBwcy5jaGFuZ2VMYW5ndWFnZSwgdHJ1ZSk7CgogIC8vIERpc2FibGUgdGhlIGxpbmsgYnV0dG9uIGlmIHBhZ2UgaXNuJ3QgYmFja2VkIGJ5IEFwcCBFbmdpbmUgc3RvcmFnZS4KICB2YXIgbGlua0J1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsaW5rQnV0dG9uJyk7CiAgaWYgKCdCbG9ja2x5U3RvcmFnZScgaW4gd2luZG93KSB7CiAgICBCbG9ja2x5U3RvcmFnZVsnSFRUUFJFUVVFU1RfRVJST1InXSA9CiAgICAgICAgQmxvY2tseUFwcHMuZ2V0TXNnKCdodHRwUmVxdWVzdEVycm9yJyk7CiAgICBCbG9ja2x5U3RvcmFnZVsnTElOS19BTEVSVCddID0gQmxvY2tseUFwcHMuZ2V0TXNnKCdsaW5rQWxlcnQnKTsKICAgIEJsb2NrbHlTdG9yYWdlWydIQVNIX0VSUk9SJ10gPSBCbG9ja2x5QXBwcy5nZXRNc2coJ2hhc2hFcnJvcicpOwogICAgQmxvY2tseVN0b3JhZ2VbJ1hNTF9FUlJPUiddID0gQmxvY2tseUFwcHMuZ2V0TXNnKCd4bWxFcnJvcicpOwogICAgLy8gU3dhcCBvdXQgdGhlIEJsb2NrbHlTdG9yYWdlJ3MgYWxlcnQoKSBmb3IgYSBuaWNlciBkaWFsb2cuCiAgICBCbG9ja2x5U3RvcmFnZS5hbGVydCA9IEJsb2NrbHlBcHBzLnN0b3JhZ2VBbGVydDsKICAgIEJsb2NrbHlBcHBzLmJpbmRDbGljayhsaW5rQnV0dG9uLCBCbG9ja2x5U3RvcmFnZS5saW5rKTsKICB9IGVsc2UgaWYgKGxpbmtCdXR0b24pIHsKICAgIGxpbmtCdXR0b24uY2xhc3NOYW1lID0gJ2Rpc2FibGVkJzsKICB9CgogIGlmIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29kZUJ1dHRvbicpKSB7CiAgICBCbG9ja2x5QXBwcy5iaW5kQ2xpY2soJ2NvZGVCdXR0b24nLCBCbG9ja2x5QXBwcy5zaG93Q29kZSk7CiAgfQoKICAvLyBGaXhlcyB2aWV3cG9ydCBmb3Igc21hbGwgc2NyZWVucy4KICB2YXIgdmlld3BvcnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtZXRhW25hbWU9InZpZXdwb3J0Il0nKTsKICBpZiAodmlld3BvcnQgJiYgc2NyZWVuLmF2YWlsV2lkdGggPCA3MjUpIHsKICAgIHZpZXdwb3J0LnNldEF0dHJpYnV0ZSgnY29udGVudCcsCiAgICAgICAgJ3dpZHRoPTcyNSwgaW5pdGlhbC1zY2FsZT0uMzUsIHVzZXItc2NhbGFibGU9bm8nKTsKICB9Cn07CgovKioKICogSW5pdGlhbGl6ZSBCbG9ja2x5IGZvciBhIHJlYWRvbmx5IGlmcmFtZS4gIENhbGxlZCBvbiBwYWdlIGxvYWQuCiAqIFhNTCBhcmd1bWVudCBtYXkgYmUgZ2VuZXJhdGVkIGZyb20gdGhlIGNvbnNvbGUgd2l0aDoKICogZW5jb2RlVVJJQ29tcG9uZW50KEJsb2NrbHkuWG1sLmRvbVRvVGV4dChCbG9ja2x5LlhtbC53b3Jrc3BhY2VUb0RvbShCbG9ja2x5Lm1haW5Xb3Jrc3BhY2UpKS5zbGljZSg1LCAtNikpCiAqLwpCbG9ja2x5QXBwcy5pbml0UmVhZG9ubHkgPSBmdW5jdGlvbigpIHsKICBCbG9ja2x5LmluamVjdChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYmxvY2tseScpLAogICAgICB7cGF0aDogJy4uLy4uLycsCiAgICAgICByZWFkT25seTogdHJ1ZSwKICAgICAgIHJ0bDogQmxvY2tseUFwcHMuaXNSdGwoKSwKICAgICAgIHNjcm9sbGJhcnM6IGZhbHNlfSk7CgogIC8vIEFkZCB0aGUgYmxvY2tzLgogIHZhciB4bWwgPSBCbG9ja2x5QXBwcy5nZXRTdHJpbmdQYXJhbUZyb21VcmwoJ3htbCcsICcnKTsKICB4bWwgPSBCbG9ja2x5LlhtbC50ZXh0VG9Eb20oJzx4bWw+JyArIHhtbCArICc8L3htbD4nKTsKICBCbG9ja2x5LlhtbC5kb21Ub1dvcmtzcGFjZShCbG9ja2x5Lm1haW5Xb3Jrc3BhY2UsIHhtbCk7Cn07CgovKioKICogTG9hZCBibG9ja3Mgc2F2ZWQgb24gQXBwIEVuZ2luZSBTdG9yYWdlIG9yIGluIHNlc3Npb24vbG9jYWwgc3RvcmFnZS4KICogQHBhcmFtIHtzdHJpbmd9IGRlZmF1bHRYbWwgVGV4dCByZXByZXNlbnRhdGlvbiBvZiBkZWZhdWx0IGJsb2Nrcy4KICovCkJsb2NrbHlBcHBzLmxvYWRCbG9ja3MgPSBmdW5jdGlvbihkZWZhdWx0WG1sKSB7CiAgdHJ5IHsKICAgIHZhciBsb2FkT25jZSA9IHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5sb2FkT25jZUJsb2NrczsKICB9IGNhdGNoKGUpIHsKICAgIC8vIEZpcmVmb3ggc29tZXRpbWVzIHRocm93cyBhIFNlY3VyaXR5RXJyb3Igd2hlbiBhY2Nlc3Npbmcgc2Vzc2lvblN0b3JhZ2UuCiAgICAvLyBSZXN0YXJ0aW5nIEZpcmVmb3ggZml4ZXMgdGhpcywgc28gaXQgbG9va3MgbGlrZSBhIGJ1Zy4KICAgIHZhciBsb2FkT25jZSA9IG51bGw7CiAgfQogIGlmICgnQmxvY2tseVN0b3JhZ2UnIGluIHdpbmRvdyAmJiB3aW5kb3cubG9jYXRpb24uaGFzaC5sZW5ndGggPiAxKSB7CiAgICAvLyBBbiBocmVmIHdpdGggI2tleSB0cmlnZXJzIGFuIEFKQVggY2FsbCB0byByZXRyaWV2ZSBzYXZlZCBibG9ja3MuCiAgICBCbG9ja2x5U3RvcmFnZS5yZXRyaWV2ZVhtbCh3aW5kb3cubG9jYXRpb24uaGFzaC5zdWJzdHJpbmcoMSkpOwogIH0gZWxzZSBpZiAobG9hZE9uY2UpIHsKICAgIC8vIExhbmd1YWdlIHN3aXRjaGluZyBzdG9yZXMgdGhlIGJsb2NrcyBkdXJpbmcgdGhlIHJlbG9hZC4KICAgIGRlbGV0ZSB3aW5kb3cuc2Vzc2lvblN0b3JhZ2UubG9hZE9uY2VCbG9ja3M7CiAgICB2YXIgeG1sID0gQmxvY2tseS5YbWwudGV4dFRvRG9tKGxvYWRPbmNlKTsKICAgIEJsb2NrbHkuWG1sLmRvbVRvV29ya3NwYWNlKEJsb2NrbHkubWFpbldvcmtzcGFjZSwgeG1sKTsKICB9IGVsc2UgaWYgKGRlZmF1bHRYbWwpIHsKICAgIC8vIExvYWQgdGhlIGVkaXRvciB3aXRoIGRlZmF1bHQgc3RhcnRpbmcgYmxvY2tzLgogICAgdmFyIHhtbCA9IEJsb2NrbHkuWG1sLnRleHRUb0RvbShkZWZhdWx0WG1sKTsKICAgIEJsb2NrbHkuWG1sLmRvbVRvV29ya3NwYWNlKEJsb2NrbHkubWFpbldvcmtzcGFjZSwgeG1sKTsKICB9IGVsc2UgaWYgKCdCbG9ja2x5U3RvcmFnZScgaW4gd2luZG93KSB7CiAgICAvLyBSZXN0b3JlIHNhdmVkIGJsb2NrcyBpbiBhIHNlcGFyYXRlIHRocmVhZCBzbyB0aGF0IHN1YnNlcXVlbnQKICAgIC8vIGluaXRpYWxpemF0aW9uIGlzIG5vdCBhZmZlY3RlZCBmcm9tIGEgZmFpbGVkIGxvYWQuCiAgICB3aW5kb3cuc2V0VGltZW91dChCbG9ja2x5U3RvcmFnZS5yZXN0b3JlQmxvY2tzLCAwKTsKICB9Cn07CgovKioKICogU2F2ZSB0aGUgYmxvY2tzIGFuZCByZWxvYWQgd2l0aCBhIGRpZmZlcmVudCBsYW5ndWFnZS4KICovCkJsb2NrbHlBcHBzLmNoYW5nZUxhbmd1YWdlID0gZnVuY3Rpb24oKSB7CiAgLy8gU3RvcmUgdGhlIGJsb2NrcyBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSByZWxvYWQuCiAgLy8gVGhpcyBzaG91bGQgYmUgc2tpcHBlZCBmb3IgdGhlIGluZGV4IHBhZ2UsIHdoaWNoIGhhcyBubyBibG9ja3MgYW5kIGRvZXMKICAvLyBub3QgbG9hZCBCbG9ja2x5LgogIC8vIE1TSUUgMTEgZG9lcyBub3Qgc3VwcG9ydCBzZXNzaW9uU3RvcmFnZSBvbiBmaWxlOi8vIFVSTHMuCiAgaWYgKHR5cGVvZiBCbG9ja2x5ICE9ICd1bmRlZmluZWQnICYmIHdpbmRvdy5zZXNzaW9uU3RvcmFnZSkgewogICAgdmFyIHhtbCA9IEJsb2NrbHkuWG1sLndvcmtzcGFjZVRvRG9tKEJsb2NrbHkubWFpbldvcmtzcGFjZSk7CiAgICB2YXIgdGV4dCA9IEJsb2NrbHkuWG1sLmRvbVRvVGV4dCh4bWwpOwogICAgd2luZG93LnNlc3Npb25TdG9yYWdlLmxvYWRPbmNlQmxvY2tzID0gdGV4dDsKICB9CgogIHZhciBsYW5ndWFnZU1lbnUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGFuZ3VhZ2VNZW51Jyk7CiAgdmFyIG5ld0xhbmcgPSBlbmNvZGVVUklDb21wb25lbnQoCiAgICAgIGxhbmd1YWdlTWVudS5vcHRpb25zW2xhbmd1YWdlTWVudS5zZWxlY3RlZEluZGV4XS52YWx1ZSk7CiAgdmFyIHNlYXJjaCA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2g7CiAgaWYgKHNlYXJjaC5sZW5ndGggPD0gMSkgewogICAgc2VhcmNoID0gJz9sYW5nPScgKyBuZXdMYW5nOwogIH0gZWxzZSBpZiAoc2VhcmNoLm1hdGNoKC9bPyZdbGFuZz1bXiZdKi8pKSB7CiAgICBzZWFyY2ggPSBzZWFyY2gucmVwbGFjZSgvKFs/Jl1sYW5nPSlbXiZdKi8sICckMScgKyBuZXdMYW5nKTsKICB9IGVsc2UgewogICAgc2VhcmNoID0gc2VhcmNoLnJlcGxhY2UoL1w/LywgJz9sYW5nPScgKyBuZXdMYW5nICsgJyYnKTsKICB9CgogIHdpbmRvdy5sb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCArICcvLycgKwogICAgICB3aW5kb3cubG9jYXRpb24uaG9zdCArIHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSArIHNlYXJjaDsKfTsKCi8qKgogKiBIaWdobGlnaHQgdGhlIGJsb2NrIChvciBjbGVhciBoaWdobGlnaHRpbmcpLgogKiBAcGFyYW0gez9zdHJpbmd9IGlkIElEIG9mIGJsb2NrIHRoYXQgdHJpZ2dlcmVkIHRoaXMgYWN0aW9uLgogKi8KQmxvY2tseUFwcHMuaGlnaGxpZ2h0ID0gZnVuY3Rpb24oaWQpIHsKICBpZiAoaWQpIHsKICAgIHZhciBtID0gaWQubWF0Y2goL15ibG9ja19pZF8oXGQrKSQvKTsKICAgIGlmIChtKSB7CiAgICAgIGlkID0gbVsxXTsKICAgIH0KICB9CiAgQmxvY2tseS5tYWluV29ya3NwYWNlLmhpZ2hsaWdodEJsb2NrKGlkKTsKfTsKCi8qKgogKiBJZiB0aGUgdXNlciBoYXMgZXhlY3V0ZWQgdG9vIG1hbnkgYWN0aW9ucywgd2UncmUgcHJvYmFibHkgaW4gYW4gaW5maW5pdGUKICogbG9vcC4gIFNhZGx5IEkgd2Fzbid0IGFibGUgdG8gc29sdmUgdGhlIEhhbHRpbmcgUHJvYmxlbS4KICogQHBhcmFtIHs/c3RyaW5nfSBvcHRfaWQgSUQgb2YgbG9vcCBibG9jayB0byBoaWdobGlnaHQuCiAqIEB0aHJvd3Mge0luZmluaXR5fSBUaHJvd3MgYW4gZXJyb3IgdG8gdGVybWluYXRlIHRoZSB1c2VyJ3MgcHJvZ3JhbS4KICovCkJsb2NrbHlBcHBzLmNoZWNrVGltZW91dCA9IGZ1bmN0aW9uKG9wdF9pZCkgewogIGlmIChvcHRfaWQpIHsKICAgIEJsb2NrbHlBcHBzLmxvZy5wdXNoKFtudWxsLCBvcHRfaWRdKTsKICB9CiAgaWYgKEJsb2NrbHlBcHBzLnRpY2tzLS0gPCAwKSB7CiAgICB0aHJvdyBJbmZpbml0eTsKICB9Cn07CgovKioKICogSXMgdGhlIGRpYWxvZyBjdXJyZW50bHkgb25zY3JlZW4/CiAqIEBwcml2YXRlCiAqLwpCbG9ja2x5QXBwcy5pc0RpYWxvZ1Zpc2libGVfID0gZmFsc2U7CgovKioKICogQSBjbG9zaW5nIGRpYWxvZyBzaG91bGQgYW5pbWF0ZSB0b3dhcmRzIHRoaXMgZWxlbWVudC4KICogQHR5cGUgRWxlbWVudAogKiBAcHJpdmF0ZQogKi8KQmxvY2tseUFwcHMuZGlhbG9nT3JpZ2luXyA9IG51bGw7CgovKioKICogQSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gYSBkaWFsb2cgY2xvc2VzLgogKiBAdHlwZSBGdW5jdGlvbgogKiBAcHJpdmF0ZQogKi8KQmxvY2tseUFwcHMuZGlhbG9nRGlzcG9zZV8gPSBudWxsOwoKLyoqCiAqIFNob3cgdGhlIGRpYWxvZyBwb3AtdXAuCiAqIEBwYXJhbSB7IUVsZW1lbnR9IGNvbnRlbnQgRE9NIGVsZW1lbnQgdG8gZGlzcGxheSBpbiB0aGUgZGlhbG9nLgogKiBAcGFyYW0ge0VsZW1lbnR9IG9yaWdpbiBBbmltYXRlIHRoZSBkaWFsb2cgb3BlbmluZy9jbG9zaW5nIGZyb20vdG8gdGhpcwogKiAgICAgRE9NIGVsZW1lbnQuICBJZiBudWxsLCBkb24ndCBzaG93IGFueSBhbmltYXRpb25zIGZvciBvcGVuaW5nIG9yIGNsb3NpbmcuCiAqIEBwYXJhbSB7Ym9vbGVhbn0gYW5pbWF0ZSBBbmltYXRlIHRoZSBkaWFsb2cgb3BlbmluZyAoaWYgb3JpZ2luIG5vdCBudWxsKS4KICogQHBhcmFtIHtib29sZWFufSBtb2RhbCBJZiB0cnVlLCBncmV5IG91dCBiYWNrZ3JvdW5kIGFuZCBwcmV2ZW50IGludGVyYWN0aW9uLgogKiBAcGFyYW0geyFPYmplY3R9IHN0eWxlIEEgZGljdGlvbmFyeSBvZiBzdHlsZSBydWxlcyBmb3IgdGhlIGRpYWxvZy4KICogQHBhcmFtIHtGdW5jdGlvbn0gZGlzcG9zZUZ1bmMgQW4gb3B0aW9uYWwgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBkaWFsb2cKICogICAgIGNsb3Nlcy4gIE5vcm1hbGx5IHVzZWQgZm9yIHVuaG9va2luZyBldmVudHMuCiAqLwpCbG9ja2x5QXBwcy5zaG93RGlhbG9nID0gZnVuY3Rpb24oY29udGVudCwgb3JpZ2luLCBhbmltYXRlLCBtb2RhbCwgc3R5bGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwb3NlRnVuYykgewogIGlmIChCbG9ja2x5QXBwcy5pc0RpYWxvZ1Zpc2libGVfKSB7CiAgICBCbG9ja2x5QXBwcy5oaWRlRGlhbG9nKGZhbHNlKTsKICB9CiAgQmxvY2tseUFwcHMuaXNEaWFsb2dWaXNpYmxlXyA9IHRydWU7CiAgQmxvY2tseUFwcHMuZGlhbG9nT3JpZ2luXyA9IG9yaWdpbjsKICBCbG9ja2x5QXBwcy5kaWFsb2dEaXNwb3NlXyA9IGRpc3Bvc2VGdW5jOwogIHZhciBkaWFsb2cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGlhbG9nJyk7CiAgdmFyIHNoYWRvdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2dTaGFkb3cnKTsKICB2YXIgYm9yZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpYWxvZ0JvcmRlcicpOwoKICAvLyBDb3B5IGFsbCB0aGUgc3BlY2lmaWVkIHN0eWxlcyB0byB0aGUgZGlhbG9nLgogIGZvciAodmFyIG5hbWUgaW4gc3R5bGUpIHsKICAgIGRpYWxvZy5zdHlsZVtuYW1lXSA9IHN0eWxlW25hbWVdOwogIH0KICBpZiAobW9kYWwpIHsKICAgIHNoYWRvdy5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwogICAgc2hhZG93LnN0eWxlLm9wYWNpdHkgPSAwLjM7CiAgICB2YXIgaGVhZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBoZWFkZXIuaWQgPSAnZGlhbG9nSGVhZGVyJzsKICAgIGRpYWxvZy5hcHBlbmRDaGlsZChoZWFkZXIpOwogICAgQmxvY2tseUFwcHMuZGlhbG9nTW91c2VEb3duV3JhcHBlcl8gPQogICAgICAgIEJsb2NrbHkuYmluZEV2ZW50XyhoZWFkZXIsICdtb3VzZWRvd24nLCBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAgICBCbG9ja2x5QXBwcy5kaWFsb2dNb3VzZURvd25fKTsKICB9CiAgZGlhbG9nLmFwcGVuZENoaWxkKGNvbnRlbnQpOwogIGNvbnRlbnQuY2xhc3NOYW1lID0gY29udGVudC5jbGFzc05hbWUucmVwbGFjZSgnZGlhbG9nSGlkZGVuQ29udGVudCcsICcnKTsKCiAgZnVuY3Rpb24gZW5kUmVzdWx0KCkgewogICAgLy8gQ2hlY2sgdGhhdCB0aGUgZGlhbG9nIHdhc24ndCBjbG9zZWQgZHVyaW5nIG9wZW5pbmcuCiAgICBpZiAoQmxvY2tseUFwcHMuaXNEaWFsb2dWaXNpYmxlXykgewogICAgICBkaWFsb2cuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgZGlhbG9nLnN0eWxlLnpJbmRleCA9IDE7CiAgICAgIGJvcmRlci5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CiAgICB9CiAgfQogIGlmIChhbmltYXRlICYmIG9yaWdpbikgewogICAgQmxvY2tseUFwcHMubWF0Y2hCb3JkZXJfKG9yaWdpbiwgZmFsc2UsIDAuMik7CiAgICBCbG9ja2x5QXBwcy5tYXRjaEJvcmRlcl8oZGlhbG9nLCB0cnVlLCAwLjgpOwogICAgLy8gSW4gMTc1bXMgc2hvdyB0aGUgZGlhbG9nIGFuZCBoaWRlIHRoZSBhbmltYXRlZCBib3JkZXIuCiAgICB3aW5kb3cuc2V0VGltZW91dChlbmRSZXN1bHQsIDE3NSk7CiAgfSBlbHNlIHsKICAgIC8vIE5vIGFuaW1hdGlvbi4gIEp1c3Qgc2V0IHRoZSBmaW5hbCBzdGF0ZS4KICAgIGVuZFJlc3VsdCgpOwogIH0KfTsKCi8qKgogKiBIb3Jpem9udGFsIHN0YXJ0IGNvb3JkaW5hdGUgb2YgZGlhbG9nIGRyYWcuCiAqLwpCbG9ja2x5QXBwcy5kaWFsb2dTdGFydFhfID0gMDsKCi8qKgogKiBWZXJ0aWNhbCBzdGFydCBjb29yZGluYXRlIG9mIGRpYWxvZyBkcmFnLgogKi8KQmxvY2tseUFwcHMuZGlhbG9nU3RhcnRZXyA9IDA7CgovKioKICogSGFuZGxlIHN0YXJ0IG9mIGRyYWcgb2YgZGlhbG9nLgogKiBAcGFyYW0geyFFdmVudH0gZSBNb3VzZSBkb3duIGV2ZW50LgogKiBAcHJpdmF0ZQogKi8KQmxvY2tseUFwcHMuZGlhbG9nTW91c2VEb3duXyA9IGZ1bmN0aW9uKGUpIHsKICBCbG9ja2x5QXBwcy5kaWFsb2dVbmJpbmREcmFnRXZlbnRzXygpOwogIGlmIChCbG9ja2x5LmlzUmlnaHRCdXR0b24oZSkpIHsKICAgIC8vIFJpZ2h0LWNsaWNrLgogICAgcmV0dXJuOwogIH0KICAvLyBMZWZ0IGNsaWNrIChvciBtaWRkbGUgY2xpY2spLgogIC8vIFJlY29yZCB0aGUgc3RhcnRpbmcgb2Zmc2V0IGJldHdlZW4gdGhlIGN1cnJlbnQgbG9jYXRpb24gYW5kIHRoZSBtb3VzZS4KICB2YXIgZGlhbG9nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpYWxvZycpOwogIEJsb2NrbHlBcHBzLmRpYWxvZ1N0YXJ0WF8gPSBkaWFsb2cub2Zmc2V0TGVmdCAtIGUuY2xpZW50WDsKICBCbG9ja2x5QXBwcy5kaWFsb2dTdGFydFlfID0gZGlhbG9nLm9mZnNldFRvcCAtIGUuY2xpZW50WTsKCiAgQmxvY2tseUFwcHMuZGlhbG9nTW91c2VVcFdyYXBwZXJfID0gQmxvY2tseS5iaW5kRXZlbnRfKGRvY3VtZW50LAogICAgICAnbW91c2V1cCcsIG51bGwsIEJsb2NrbHlBcHBzLmRpYWxvZ1VuYmluZERyYWdFdmVudHNfKTsKICBCbG9ja2x5QXBwcy5kaWFsb2dNb3VzZU1vdmVXcmFwcGVyXyA9IEJsb2NrbHkuYmluZEV2ZW50Xyhkb2N1bWVudCwKICAgICAgJ21vdXNlbW92ZScsIG51bGwsIEJsb2NrbHlBcHBzLmRpYWxvZ01vdXNlTW92ZV8pOwogIC8vIFRoaXMgZXZlbnQgaGFzIGJlZW4gaGFuZGxlZC4gIE5vIG5lZWQgdG8gYnViYmxlIHVwIHRvIHRoZSBkb2N1bWVudC4KICBlLnN0b3BQcm9wYWdhdGlvbigpOwp9OwoKLyoqCiAqIERyYWcgdGhlIGRpYWxvZyB0byBmb2xsb3cgdGhlIG1vdXNlLgogKiBAcGFyYW0geyFFdmVudH0gZSBNb3VzZSBtb3ZlIGV2ZW50LgogKiBAcHJpdmF0ZQogKi8KQmxvY2tseUFwcHMuZGlhbG9nTW91c2VNb3ZlXyA9IGZ1bmN0aW9uKGUpIHsKICB2YXIgZGlhbG9nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpYWxvZycpOwogIHZhciBkaWFsb2dMZWZ0ID0gQmxvY2tseUFwcHMuZGlhbG9nU3RhcnRYXyArIGUuY2xpZW50WDsKICB2YXIgZGlhbG9nVG9wID0gQmxvY2tseUFwcHMuZGlhbG9nU3RhcnRZXyArIGUuY2xpZW50WTsKICBkaWFsb2dUb3AgPSBNYXRoLm1heChkaWFsb2dUb3AsIDApOwogIGRpYWxvZ1RvcCA9IE1hdGgubWluKGRpYWxvZ1RvcCwgd2luZG93LmlubmVySGVpZ2h0IC0gZGlhbG9nLm9mZnNldEhlaWdodCk7CiAgZGlhbG9nTGVmdCA9IE1hdGgubWF4KGRpYWxvZ0xlZnQsIDApOwogIGRpYWxvZ0xlZnQgPSBNYXRoLm1pbihkaWFsb2dMZWZ0LCB3aW5kb3cuaW5uZXJXaWR0aCAtIGRpYWxvZy5vZmZzZXRXaWR0aCk7CiAgZGlhbG9nLnN0eWxlLmxlZnQgPSBkaWFsb2dMZWZ0ICsgJ3B4JzsKICBkaWFsb2cuc3R5bGUudG9wID0gZGlhbG9nVG9wICsgJ3B4JzsKfTsKCi8qKgogKiBTdG9wIGJpbmRpbmcgdG8gdGhlIGdsb2JhbCBtb3VzZXVwIGFuZCBtb3VzZW1vdmUgZXZlbnRzLgogKiBAcHJpdmF0ZQogKi8KQmxvY2tseUFwcHMuZGlhbG9nVW5iaW5kRHJhZ0V2ZW50c18gPSBmdW5jdGlvbigpIHsKICBpZiAoQmxvY2tseUFwcHMuZGlhbG9nTW91c2VVcFdyYXBwZXJfKSB7CiAgICBCbG9ja2x5LnVuYmluZEV2ZW50XyhCbG9ja2x5QXBwcy5kaWFsb2dNb3VzZVVwV3JhcHBlcl8pOwogICAgQmxvY2tseUFwcHMuZGlhbG9nTW91c2VVcFdyYXBwZXJfID0gbnVsbDsKICB9CiAgaWYgKEJsb2NrbHlBcHBzLmRpYWxvZ01vdXNlTW92ZVdyYXBwZXJfKSB7CiAgICBCbG9ja2x5LnVuYmluZEV2ZW50XyhCbG9ja2x5QXBwcy5kaWFsb2dNb3VzZU1vdmVXcmFwcGVyXyk7CiAgICBCbG9ja2x5QXBwcy5kaWFsb2dNb3VzZU1vdmVXcmFwcGVyXyA9IG51bGw7CiAgfQp9OwoKLyoqCiAqIEhpZGUgdGhlIGRpYWxvZyBwb3AtdXAuCiAqIEBwYXJhbSB7Ym9vbGVhbn0gb3B0X2FuaW1hdGUgQW5pbWF0ZSB0aGUgZGlhbG9nIGNsb3NpbmcuICBEZWZhdWx0cyB0byB0cnVlLgogKiAgICAgUmVxdWlyZXMgdGhhdCBvcmlnaW4gd2FzIG5vdCBudWxsIHdoZW4gZGlhbG9nIHdhcyBvcGVuZWQuCiAqLwpCbG9ja2x5QXBwcy5oaWRlRGlhbG9nID0gZnVuY3Rpb24ob3B0X2FuaW1hdGUpIHsKICBpZiAoIUJsb2NrbHlBcHBzLmlzRGlhbG9nVmlzaWJsZV8pIHsKICAgIHJldHVybjsKICB9CiAgQmxvY2tseUFwcHMuZGlhbG9nVW5iaW5kRHJhZ0V2ZW50c18oKTsKICBpZiAoQmxvY2tseUFwcHMuZGlhbG9nTW91c2VEb3duV3JhcHBlcl8pIHsKICAgIEJsb2NrbHkudW5iaW5kRXZlbnRfKEJsb2NrbHlBcHBzLmRpYWxvZ01vdXNlRG93bldyYXBwZXJfKTsKICAgIEJsb2NrbHlBcHBzLmRpYWxvZ01vdXNlRG93bldyYXBwZXJfID0gbnVsbDsKICB9CgogIEJsb2NrbHlBcHBzLmlzRGlhbG9nVmlzaWJsZV8gPSBmYWxzZTsKICBCbG9ja2x5QXBwcy5kaWFsb2dEaXNwb3NlXyAmJiBCbG9ja2x5QXBwcy5kaWFsb2dEaXNwb3NlXygpOwogIEJsb2NrbHlBcHBzLmRpYWxvZ0Rpc3Bvc2VfID0gbnVsbDsKICB2YXIgb3JpZ2luID0gKG9wdF9hbmltYXRlID09PSBmYWxzZSkgPyBudWxsIDogQmxvY2tseUFwcHMuZGlhbG9nT3JpZ2luXzsKICB2YXIgZGlhbG9nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpYWxvZycpOwogIHZhciBzaGFkb3cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGlhbG9nU2hhZG93Jyk7CiAgdmFyIGJvcmRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2dCb3JkZXInKTsKCiAgc2hhZG93LnN0eWxlLm9wYWNpdHkgPSAwOwoKICBmdW5jdGlvbiBlbmRSZXN1bHQoKSB7CiAgICBzaGFkb3cuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwogICAgYm9yZGVyLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKICB9CiAgaWYgKG9yaWdpbikgewogICAgQmxvY2tseUFwcHMubWF0Y2hCb3JkZXJfKGRpYWxvZywgZmFsc2UsIDAuOCk7CiAgICBCbG9ja2x5QXBwcy5tYXRjaEJvcmRlcl8ob3JpZ2luLCB0cnVlLCAwLjIpOwogICAgLy8gSW4gMTc1bXMgaGlkZSBib3RoIHRoZSBzaGFkb3cgYW5kIHRoZSBhbmltYXRlZCBib3JkZXIuCiAgICB3aW5kb3cuc2V0VGltZW91dChlbmRSZXN1bHQsIDE3NSk7CiAgfSBlbHNlIHsKICAgIC8vIE5vIGFuaW1hdGlvbi4gIEp1c3Qgc2V0IHRoZSBmaW5hbCBzdGF0ZS4KICAgIGVuZFJlc3VsdCgpOwogIH0KICBkaWFsb2cuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwogIGRpYWxvZy5zdHlsZS56SW5kZXggPSAtMTsKICB2YXIgaGVhZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpYWxvZ0hlYWRlcicpOwogIGlmIChoZWFkZXIpIHsKICAgIGhlYWRlci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGhlYWRlcik7CiAgfQogIHdoaWxlIChkaWFsb2cuZmlyc3RDaGlsZCkgewogICAgdmFyIGNvbnRlbnQgPSBkaWFsb2cuZmlyc3RDaGlsZDsKICAgIGNvbnRlbnQuY2xhc3NOYW1lICs9ICcgZGlhbG9nSGlkZGVuQ29udGVudCc7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGNvbnRlbnQpOwogIH0KfTsKCi8qKgogKiBNYXRjaCB0aGUgYW5pbWF0ZWQgYm9yZGVyIHRvIHRoZSBhIGVsZW1lbnQncyBzaXplIGFuZCBsb2NhdGlvbi4KICogQHBhcmFtIHshRWxlbWVudH0gZWxlbWVudCBFbGVtZW50IHRvIG1hdGNoLgogKiBAcGFyYW0ge2Jvb2xlYW59IGFuaW1hdGUgQW5pbWF0ZSB0byB0aGUgbmV3IGxvY2F0aW9uLgogKiBAcGFyYW0ge251bWJlcn0gb3BhY2l0eSBPcGFjaXR5IG9mIGJvcmRlci4KICogQHByaXZhdGUKICovCkJsb2NrbHlBcHBzLm1hdGNoQm9yZGVyXyA9IGZ1bmN0aW9uKGVsZW1lbnQsIGFuaW1hdGUsIG9wYWNpdHkpIHsKICBpZiAoIWVsZW1lbnQpIHsKICAgIHJldHVybjsKICB9CiAgdmFyIGJvcmRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2dCb3JkZXInKTsKICB2YXIgYkJveCA9IEJsb2NrbHlBcHBzLmdldEJCb3hfKGVsZW1lbnQpOwogIGZ1bmN0aW9uIGNoYW5nZSgpIHsKICAgIGJvcmRlci5zdHlsZS53aWR0aCA9IGJCb3gud2lkdGggKyAncHgnOwogICAgYm9yZGVyLnN0eWxlLmhlaWdodCA9IGJCb3guaGVpZ2h0ICsgJ3B4JzsKICAgIGJvcmRlci5zdHlsZS5sZWZ0ID0gYkJveC54ICsgJ3B4JzsKICAgIGJvcmRlci5zdHlsZS50b3AgPSBiQm94LnkgKyAncHgnOwogICAgYm9yZGVyLnN0eWxlLm9wYWNpdHkgPSBvcGFjaXR5OwogIH0KICBpZiAoYW5pbWF0ZSkgewogICAgYm9yZGVyLmNsYXNzTmFtZSA9ICdkaWFsb2dBbmltYXRlJzsKICAgIHdpbmRvdy5zZXRUaW1lb3V0KGNoYW5nZSwgMSk7CiAgfSBlbHNlIHsKICAgIGJvcmRlci5jbGFzc05hbWUgPSAnJzsKICAgIGNoYW5nZSgpOwogIH0KICBib3JkZXIuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKfTsKCi8qKgogKiBDb21wdXRlIHRoZSBhYnNvbHV0ZSBjb29yZGluYXRlcyBhbmQgZGltZW5zaW9ucyBvZiBhbiBIVE1MIG9yIFNWRyBlbGVtZW50LgogKiBAcGFyYW0geyFFbGVtZW50fSBlbGVtZW50IEVsZW1lbnQgdG8gbWF0Y2guCiAqIEByZXR1cm4geyFPYmplY3R9IENvbnRhaW5zIGhlaWdodCwgd2lkdGgsIHgsIGFuZCB5IHByb3BlcnRpZXMuCiAqIEBwcml2YXRlCiAqLwpCbG9ja2x5QXBwcy5nZXRCQm94XyA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICBpZiAoZWxlbWVudC5nZXRCQm94KSB7CiAgICAvLyBTVkcgZWxlbWVudC4KICAgIHZhciBiQm94ID0gZWxlbWVudC5nZXRCQm94KCk7CiAgICB2YXIgaGVpZ2h0ID0gYkJveC5oZWlnaHQ7CiAgICB2YXIgd2lkdGggPSBiQm94LndpZHRoOwogICAgdmFyIHh5ID0gQmxvY2tseS5nZXRBYnNvbHV0ZVhZXyhlbGVtZW50KTsKICAgIHZhciB4ID0geHkueDsKICAgIHZhciB5ID0geHkueTsKICB9IGVsc2UgewogICAgLy8gSFRNTCBlbGVtZW50LgogICAgdmFyIGhlaWdodCA9IGVsZW1lbnQub2Zmc2V0SGVpZ2h0OwogICAgdmFyIHdpZHRoID0gZWxlbWVudC5vZmZzZXRXaWR0aDsKICAgIHZhciB4ID0gMDsKICAgIHZhciB5ID0gMDsKICAgIGRvIHsKICAgICAgeCArPSBlbGVtZW50Lm9mZnNldExlZnQ7CiAgICAgIHkgKz0gZWxlbWVudC5vZmZzZXRUb3A7CiAgICAgIGVsZW1lbnQgPSBlbGVtZW50Lm9mZnNldFBhcmVudDsKICAgIH0gd2hpbGUgKGVsZW1lbnQpOwogIH0KICByZXR1cm4gewogICAgaGVpZ2h0OiBoZWlnaHQsCiAgICB3aWR0aDogd2lkdGgsCiAgICB4OiB4LAogICAgeTogeQogIH07Cn07CgovKioKICogRGlzcGxheSBhIHN0b3JhZ2UtcmVsYXRlZCBtb2RhbCBkaWFsb2cuCiAqIEBwYXJhbSB7c3RyaW5nfSBtZXNzYWdlIFRleHQgdG8gYWxlcnQuCiAqLwpCbG9ja2x5QXBwcy5zdG9yYWdlQWxlcnQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb250YWluZXJTdG9yYWdlJyk7CiAgY29udGFpbmVyLnRleHRDb250ZW50ID0gJyc7CiAgdmFyIGxpbmVzID0gbWVzc2FnZS5zcGxpdCgnXG4nKTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTsKICAgIHAuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUobGluZXNbaV0pKTsKICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChwKTsKICB9CgogIHZhciBjb250ZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpYWxvZ1N0b3JhZ2UnKTsKICB2YXIgb3JpZ2luID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xpbmtCdXR0b24nKTsKICB2YXIgc3R5bGUgPSB7CiAgICB3aWR0aDogJzUwJScsCiAgICBsZWZ0OiAnMjUlJywKICAgIHRvcDogJzVlbScKICB9OwogIEJsb2NrbHlBcHBzLnNob3dEaWFsb2coY29udGVudCwgb3JpZ2luLCB0cnVlLCB0cnVlLCBzdHlsZSwKICAgICAgQmxvY2tseUFwcHMuc3RvcERpYWxvZ0tleURvd24oKSk7CiAgQmxvY2tseUFwcHMuc3RhcnREaWFsb2dLZXlEb3duKCk7Cn07CgovKioKICogQ29udmVydCB0aGUgdXNlcidzIGNvZGUgdG8gcmF3IEphdmFTY3JpcHQuCiAqIEBwYXJhbSB7c3RyaW5nfSBjb2RlIEdlbmVyYXRlZCBjb2RlLgogKiBAcmV0dXJuIHtzdHJpbmd9IFRoZSBjb2RlIHdpdGhvdXQgc2VyaWFsIG51bWJlcnMgYW5kIHRpbWVvdXQgY2hlY2tzLgogKi8KQmxvY2tseUFwcHMuc3RyaXBDb2RlID0gZnVuY3Rpb24oY29kZSkgewogIC8vIFN0cmlwIG91dCBzZXJpYWwgbnVtYmVycy4KICBjb2RlID0gY29kZS5yZXBsYWNlKC8oLFxzKik/J2Jsb2NrX2lkX1xkKydcKS9nLCAnKScpOwogIC8vIFJlbW92ZSB0aW1lb3V0cy4KICB2YXIgcmVnZXggPSBuZXcgUmVnRXhwKEJsb2NrbHkuSmF2YVNjcmlwdC5JTkZJTklURV9MT09QX1RSQVAKICAgICAgLnJlcGxhY2UoJyglMSknLCAnXFwoKFwnXFxkK1wnKT9cXCknKSwgJ2cnKTsKICByZXR1cm4gY29kZS5yZXBsYWNlKHJlZ2V4LCAnJyk7Cn07CgovKioKICogU2hvdyB0aGUgdXNlcidzIGNvZGUgaW4gcmF3IEphdmFTY3JpcHQuCiAqIEBwYXJhbSB7IUV2ZW50fSBlIE1vdXNlIG9yIHRvdWNoIGV2ZW50LgogKi8KQmxvY2tseUFwcHMuc2hvd0NvZGUgPSBmdW5jdGlvbihlKSB7CiAgdmFyIG9yaWdpbiA9IGUudGFyZ2V0OwogIHZhciBjb2RlID0gQmxvY2tseS5KYXZhU2NyaXB0LndvcmtzcGFjZVRvQ29kZSgpOwogIGNvZGUgPSBCbG9ja2x5QXBwcy5zdHJpcENvZGUoY29kZSk7CiAgdmFyIHByZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb250YWluZXJDb2RlJyk7CiAgcHJlLnRleHRDb250ZW50ID0gY29kZTsKICBpZiAodHlwZW9mIHByZXR0eVByaW50T25lID09ICdmdW5jdGlvbicpIHsKICAgIGNvZGUgPSBwcmUuaW5uZXJIVE1MOwogICAgY29kZSA9IHByZXR0eVByaW50T25lKGNvZGUsICdqcycpOwogICAgcHJlLmlubmVySFRNTCA9IGNvZGU7CiAgfQoKICB2YXIgY29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2dDb2RlJyk7CiAgdmFyIHN0eWxlID0gewogICAgd2lkdGg6ICc0MCUnLAogICAgbGVmdDogJzMwJScsCiAgICB0b3A6ICc1ZW0nCiAgfTsKICBCbG9ja2x5QXBwcy5zaG93RGlhbG9nKGNvbnRlbnQsIG9yaWdpbiwgdHJ1ZSwgdHJ1ZSwgc3R5bGUsCiAgICAgIEJsb2NrbHlBcHBzLnN0b3BEaWFsb2dLZXlEb3duKTsKICBCbG9ja2x5QXBwcy5zdGFydERpYWxvZ0tleURvd24oKTsKfTsKCi8qKgogKiBJZiB0aGUgdXNlciBwcmVzZXMgZW50ZXIsIGVzY2FwZSwgb3Igc3BhY2UsIGhpZGUgdGhlIGRpYWxvZy4KICogQHBhcmFtIHshRXZlbnR9IGUgS2V5Ym9hcmQgZXZlbnQuCiAqIEBwcml2YXRlCiAqLwpCbG9ja2x5QXBwcy5kaWFsb2dLZXlEb3duXyA9IGZ1bmN0aW9uKGUpIHsKICBpZiAoQmxvY2tseUFwcHMuaXNEaWFsb2dWaXNpYmxlXykgewogICAgaWYgKGUua2V5Q29kZSA9PSAxMyB8fAogICAgICAgIGUua2V5Q29kZSA9PSAyNyB8fAogICAgICAgIGUua2V5Q29kZSA9PSAzMikgewogICAgICBCbG9ja2x5QXBwcy5oaWRlRGlhbG9nKHRydWUpOwogICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB9CiAgfQp9OwoKLyoqCiAqIFN0YXJ0IGxpc3RlbmluZyBmb3IgQmxvY2tseUFwcHMuZGlhbG9nS2V5RG93bl8uCiAqLwpCbG9ja2x5QXBwcy5zdGFydERpYWxvZ0tleURvd24gPSBmdW5jdGlvbigpIHsKICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLAogICAgICBCbG9ja2x5QXBwcy5kaWFsb2dLZXlEb3duXywgdHJ1ZSk7Cn07CgovKioKICogU3RvcCBsaXN0ZW5pbmcgZm9yIEJsb2NrbHlBcHBzLmRpYWxvZ0tleURvd25fLgogKi8KQmxvY2tseUFwcHMuc3RvcERpYWxvZ0tleURvd24gPSBmdW5jdGlvbigpIHsKICBkb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLAogICAgICBCbG9ja2x5QXBwcy5kaWFsb2dLZXlEb3duXywgdHJ1ZSk7Cn07CgovKioKICogR2V0cyB0aGUgbWVzc2FnZSB3aXRoIHRoZSBnaXZlbiBrZXkgZnJvbSB0aGUgZG9jdW1lbnQuCiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgZG9jdW1lbnQgZWxlbWVudC4KICogQHJldHVybiB7c3RyaW5nfSBUaGUgdGV4dENvbnRlbnQgb2YgdGhlIHNwZWNpZmllZCBlbGVtZW50LAogKiAgICAgb3IgYW4gZXJyb3IgbWVzc2FnZSBpZiB0aGUgZWxlbWVudCB3YXMgbm90IGZvdW5kLgogKi8KQmxvY2tseUFwcHMuZ2V0TXNnID0gZnVuY3Rpb24oa2V5KSB7CiAgdmFyIG1zZyA9IEJsb2NrbHlBcHBzLmdldE1zZ09yTnVsbChrZXkpOwogIHJldHVybiBtc2cgPT09IG51bGwgPyAnW1Vua25vd24gbWVzc2FnZTogJyArIGtleSArICddJyA6IG1zZzsKfTsKCi8qKgogKiBHZXRzIHRoZSBtZXNzYWdlIHdpdGggdGhlIGdpdmVuIGtleSBmcm9tIHRoZSBkb2N1bWVudC4KICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSBkb2N1bWVudCBlbGVtZW50LgogKiBAcmV0dXJuIHtzdHJpbmd9IFRoZSB0ZXh0Q29udGVudCBvZiB0aGUgc3BlY2lmaWVkIGVsZW1lbnQsCiAqICAgICBvciBudWxsIGlmIHRoZSBlbGVtZW50IHdhcyBub3QgZm91bmQuCiAqLwpCbG9ja2x5QXBwcy5nZXRNc2dPck51bGwgPSBmdW5jdGlvbihrZXkpIHsKICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGtleSk7CiAgaWYgKGVsZW1lbnQpIHsKICAgIHZhciB0ZXh0ID0gZWxlbWVudC50ZXh0Q29udGVudDsKICAgIC8vIENvbnZlcnQgbmV3bGluZSBzZXF1ZW5jZXMuCiAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9cXG4vZywgJ1xuJyk7CiAgICByZXR1cm4gdGV4dDsKICB9IGVsc2UgewogICAgcmV0dXJuIG51bGw7CiAgfQp9OwoKLyoqCiAqIEJpbmQgYSBmdW5jdGlvbiB0byBhIGJ1dHRvbidzIGNsaWNrIGV2ZW50LgogKiBPbiB0b3VjaCBlbmFibGVkIGJyb3dzZXJzLCBvbnRvdWNoZW5kIGlzIHRyZWF0ZWQgYXMgZXF1aXZhbGVudCB0byBvbmNsaWNrLgogKiBAcGFyYW0geyFFbGVtZW50fHN0cmluZ30gZWwgQnV0dG9uIGVsZW1lbnQgb3IgSUQgdGhlcmVvZi4KICogQHBhcmFtIHshRnVuY3Rpb259IGZ1bmMgRXZlbnQgaGFuZGxlciB0byBiaW5kLgogKi8KQmxvY2tseUFwcHMuYmluZENsaWNrID0gZnVuY3Rpb24oZWwsIGZ1bmMpIHsKICBpZiAodHlwZW9mIGVsID09ICdzdHJpbmcnKSB7CiAgICBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVsKTsKICB9CiAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jLCB0cnVlKTsKICBlbC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGZ1bmMsIHRydWUpOwp9OwoKLyoqCiAqIExvYWQgdGhlIFByZXR0aWZ5IENTUyBhbmQgSmF2YVNjcmlwdC4KICovCkJsb2NrbHlBcHBzLmltcG9ydFByZXR0aWZ5ID0gZnVuY3Rpb24oKSB7CiAgLy88bGluayByZWw9InN0eWxlc2hlZXQiIHR5cGU9InRleHQvY3NzIiBocmVmPSIuLi9wcmV0dGlmeS5jc3MiPgogIC8vPHNjcmlwdCB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiIHNyYz0iLi4vcHJldHRpZnkuanMiPjwvc2NyaXB0PgogIHZhciBsaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwogIGxpbmsuc2V0QXR0cmlidXRlKCdyZWwnLCAnc3R5bGVzaGVldCcpOwogIGxpbmsuc2V0QXR0cmlidXRlKCd0eXBlJywgJ3RleHQvY3NzJyk7CiAgbGluay5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnLi4vcHJldHRpZnkuY3NzJyk7CiAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsaW5rKTsKICB2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgc2NyaXB0LnNldEF0dHJpYnV0ZSgndHlwZScsICd0ZXh0L2phdmFzY3JpcHQnKTsKICBzY3JpcHQuc2V0QXR0cmlidXRlKCdzcmMnLCAnLi4vcHJldHRpZnkuanMnKTsKICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7Cn07Cg==",
                "body": "LyoqCiAqIEJsb2NrbHkgQXBwczogQ29tbW9uIGNvZGUKICoKICogQ29weXJpZ2h0IDIwMTMgR29vZ2xlIEluYy4KICogaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vYmxvY2tseS8KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqCiAqICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKLyoqCiAqIEBmaWxlb3ZlcnZpZXcgQ29tbW9uIHN1cHBvcnQgY29kZSBmb3IgQmxvY2tseSBhcHBzLgogKiBAYXV0aG9yIGZyYXNlckBnb29nbGUuY29tIChOZWlsIEZyYXNlcikKICovCid1c2Ugc3RyaWN0JzsKCnZhciBCbG9ja2x5QXBwcyA9IHt9OwoKLyoqCiAqIExvb2t1cCBmb3IgbmFtZXMgb2YgbGFuZ3VhZ2VzLiAgS2V5cyBzaG91bGQgYmUgaW4gSVNPIDYzOSBmb3JtYXQuCiAqLwpCbG9ja2x5QXBwcy5MQU5HVUFHRV9OQU1FID0gewogICdhY2UnOiAn2KjZh9iz2Kcg2KfahtmK2YcnLAogICdhZic6ICdBZnJpa2FhbnMnLAogICdhcic6ICfYp9mE2LnYsdio2YrYqScsCiAgJ2F6JzogJ0F6yZlyYmF5Y2FuY2EnLAogICdiZS10YXJhc2snOiAnVGFyYcWha2lldmljYScsCiAgJ2JyJzogJ0JyZXpob25lZycsCiAgJ2NhJzogJ0NhdGFsw6AnLAogICdjZG8nOiAn6Zap5p2x6KqeJywKICAnY3MnOiAnxIxlc2t5JywKICAnZGEnOiAnRGFuc2snLAogICdkZSc6ICdEZXV0c2NoJywKICAnZWwnOiAnzpXOu867zrfOvc65zrrOrCcsCiAgJ2VuJzogJ0VuZ2xpc2gnLAogICdlcyc6ICdFc3Bhw7FvbCcsCiAgJ2V1JzogJ0V1c2thcmEnLAogICdmYSc6ICfZgdin2LHYs9uMJywKICAnZmknOiAnU3VvbWknLAogICdmbyc6ICdGw7hyb3lza3QnLAogICdmcic6ICdGcmFuw6dhaXMnLAogICdmcnInOiAnRnJhc2NoJywKICAnZ2wnOiAnR2FsZWdvJywKICAnaGFrJzogJ+WuouWutuipsScsCiAgJ2hlJzogJ9ei15HXqNeZ16onLAogICdoaSc6ICfgpLngpL/gpKjgpY3gpKbgpYAnLAogICdocngnOiAnSHVuc3JpaycsCiAgJ2h1JzogJ01hZ3lhcicsCiAgJ2lhJzogJ0ludGVybGluZ3VhJywKICAnaWQnOiAnQmFoYXNhIEluZG9uZXNpYScsCiAgJ2lzJzogJ8ONc2xlbnNrYScsCiAgJ2l0JzogJ0l0YWxpYW5vJywKICAnamEnOiAn5pel5pys6KqeJywKICAna2EnOiAn4YOl4YOQ4YOg4YOX4YOj4YOa4YOYJywKICAna20nOiAn4Z6X4Z624Z6f4Z624Z6B4Z+S4Z6Y4Z+C4Z6aJywKICAna28nOiAn7ZWc6rWt7Ja0JywKICAna3NoJzogJ1JpcG9hcsSXc2NoJywKICAna3knOiAn0JrRi9GA0LPRi9C30YfQsCcsCiAgJ2xhJzogJ0xhdGluZScsCiAgJ2xiJzogJ0zDq3R6ZWJ1ZXJnZXNjaCcsCiAgJ2x0JzogJ0xpZXR1dmnFsycsCiAgJ2x2JzogJ0xhdHZpZcWhdScsCiAgJ21nJzogJ01hbGFnYXN5JywKICAnbWwnOiAn4LSu4LSy4LSv4LS+4LSz4LSCJywKICAnbWsnOiAn0JzQsNC60LXQtNC+0L3RgdC60LgnLAogICdtcic6ICfgpK7gpLDgpL7gpKDgpYAnLAogICdtcyc6ICdCYWhhc2EgTWVsYXl1JywKICAnbXpuJzogJ9mF2KfYstmQ2LHZiNmG24wnLAogICduYic6ICdOb3JzayBCb2ttw6VsJywKICAnbmwnOiAnTmVkZXJsYW5kcywgVmxhYW1zJywKICAnb2MnOiAnTGVuZ2EgZFwnw7JjJywKICAncGEnOiAn4KSq4KSC4KSc4KS+4KSs4KWAJywKICAncGwnOiAnUG9sc2tpJywKICAncG1zJzogJ1BpZW1vbnTDqGlzJywKICAncHMnOiAn2b7amtiq2YgnLAogICdwdCc6ICdQb3J0dWd1w6pzJywKICAncm8nOiAnUm9tw6JuxIMnLAogICdwdC1icic6ICdQb3J0dWd1w6pzIEJyYXNpbGVpcm8nLAogICdydSc6ICfQoNGD0YHRgdC60LjQuScsCiAgJ3NjJzogJ1NhcmR1JywKICAnc2NvJzogJ1Njb3RzJywKICAnc2knOiAn4LeD4LeS4LaC4LeE4La9JywKICAnc2snOiAnU2xvdmVuxI1pbmEnLAogICdzcic6ICfQodGA0L/RgdC60LgnLAogICdzdic6ICdTdmVuc2thJywKICAnc3cnOiAnS2lzaHdhaGlsaScsCiAgJ3RoJzogJ+C4oOC4suC4qeC4suC5hOC4l+C4oicsCiAgJ3RsJzogJ1RhZ2Fsb2cnLAogICd0bGgnOiAndGxoSW5nYW4gSG9sJywKICAndHInOiAnVMO8cmvDp2UnLAogICd1ayc6ICfQo9C60YDQsNGX0L3RgdGM0LrQsCcsCiAgJ3ZpJzogJ1Rp4bq/bmcgVmnhu4d0JywKICAnemgtaGFucyc6ICfnsKHpq5TkuK3mlocnLAogICd6aC1oYW50JzogJ+ato+mrlOS4reaWhycKfTsKCi8qKgogKiBMaXN0IG9mIFJUTCBsYW5ndWFnZXMuCiAqLwpCbG9ja2x5QXBwcy5MQU5HVUFHRV9SVEwgPSBbJ2FjZScsICdhcicsICdmYScsICdoZScsICdtem4nLCAncHMnXTsKCi8qKgogKiBMb29rdXAgZm9yIEJsb2NrbHkgY29yZSBibG9jayBsYW5ndWFnZSBwYWNrLgogKi8KQmxvY2tseUFwcHMuTEFOR1VBR0VfUEFDSyA9IHsKICAnYXInOiAnbXNnL2pzL2FyLmpzJywKICAnYXotbGF0bic6ICdtc2cvanMvYXotbGF0bi5qcycsCiAgJ2F6JzogJ21zZy9qcy9hei5qcycsCiAgJ2NhJzogJ21zZy9qcy9jYS5qcycsCiAgJ2Nkbyc6ICdtc2cvanMvemgtaGFudC5qcycsCiAgJ2NzJzogJ21zZy9qcy9jcy5qcycsCiAgJ2RhJzogJ21zZy9qcy9kYS5qcycsCiAgJ2RlJzogJ21zZy9qcy9kZS5qcycsCiAgJ2VsJzogJ21zZy9qcy9lbC5qcycsCiAgJ2VuJzogJ21zZy9qcy9lbi5qcycsCiAgJ2VuX3VzJzogJ21zZy9qcy9lbl91cy5qcycsCiAgJ2VzJzogJ21zZy9qcy9lcy5qcycsCiAgJ2ZhJzogJ21zZy9qcy9mYS5qcycsCiAgJ2ZpJzogJ21zZy9qcy9maS5qcycsCiAgJ2ZyJzogJ21zZy9qcy9mci5qcycsCiAgJ2Zycic6ICdtc2cvanMvZGUuanMnLAogICdoZSc6ICdtc2cvanMvaGUuanMnLAogICdocngnOiAnbXNnL2pzL2hyeC5qcycsCiAgJ2h1JzogJ21zZy9qcy9odS5qcycsCiAgJ2lkJzogJ21zZy9qcy9pZC5qcycsCiAgJ2lzJzogJ21zZy9qcy9pcy5qcycsCiAgJ2l0JzogJ21zZy9qcy9pdC5qcycsCiAgJ2phJzogJ21zZy9qcy9qYS5qcycsCiAgJ2tvJzogJ21zZy9qcy9rby5qcycsCiAgJ2tzaCc6ICdtc2cvanMvZGUuanMnLAogICdsYic6ICdtc2cvanMvZGUuanMnLAogICdtcyc6ICdtc2cvanMvbXMuanMnLAogICduYic6ICdtc2cvanMvbmIuanMnLAogICdubCc6ICdtc2cvanMvbmwuanMnLAogICdubyc6ICdtc2cvanMvbm8uanMnLAogICdwbCc6ICdtc2cvanMvcGwuanMnLAogICdwbXMnOiAnbXNnL2pzL3Btcy5qcycsCiAgJ3B0JzogJ21zZy9qcy9wdC5qcycsCiAgJ3B0LWJyJzogJ21zZy9qcy9wdC1ici5qcycsCiAgLy8gV2UgdXNlZCB0byB1c2UgcHRfYnIgZm9yIHB0LWJyICh1bnRpbCBOb3ZlbWJlciAyMDEzKS4KICAvLyBVc2VycyBtYXkgc3RpbGwgaGF2ZSBVUkxzLgogICdwdF9icic6ICdtc2cvanMvcHQtYnIuanMnLAogICdybyc6ICdtc2cvanMvcm8uanMnLAogICdydSc6ICdtc2cvanMvcnUuanMnLAogICdzcSc6ICdtc2cvanMvc3EuanMnLAogICdzcic6ICdtc2cvanMvc3IuanMnLAogICdzdic6ICdtc2cvanMvc3YuanMnLAogICd0aCc6ICdtc2cvanMvdGguanMnLAogICd0bCc6ICdtc2cvanMvdGwuanMnLAogICd0bGgnOiAnbXNnL2pzL3RsaC5qcycsCiAgJ3RyJzogJ21zZy9qcy90ci5qcycsCiAgJ3VrJzogJ21zZy9qcy91ay5qcycsCiAgJ3ZpJzogJ21zZy9qcy92aS5qcycsCiAgJ3poLWhhbnMnOiAnbXNnL2pzL3poLWhhbnMuanMnLAogICd6aC1oYW50JzogJ21zZy9qcy96aC1oYW50LmpzJywKICAvLyBXZSB1c2VkIHRvIHVzZSB6aC10dyBmb3IgemgtaGFudCAodW50aWwgTm92ZW1iZXIgMjAxMykuCiAgLy8gVXNlcnMgbWF5IHN0aWxsIGhhdmUgVVJMcy4KICAnemgtdHcnOiAnbXNnL2pzL3poLWhhbnQuanMnLAogICdkZWZhdWx0JzogJ21zZy9qcy9lbi5qcycKfTsKCi8qKgogKiBVc2VyJ3MgbGFuZ3VhZ2UgKGUuZy4gImVuIikuCiAqIEB0eXBlIHN0cmluZz0KICovCkJsb2NrbHlBcHBzLkxBTkcgPSB1bmRlZmluZWQ7CgovKioKICogTGlzdCBvZiBsYW5ndWFnZXMgc3VwcG9ydGVkIGJ5IHRoaXMgYXBwLiAgVmFsdWVzIHNob3VsZCBiZSBpbiBJU08gNjM5IGZvcm1hdC4KICogQHR5cGUgIUFycmF5LjxzdHJpbmc+PQogKi8KQmxvY2tseUFwcHMuTEFOR1VBR0VTID0gdW5kZWZpbmVkOwoKLyoqCiAqIExlbmd0aCBvZiB0aW1lIHRvIHN1cHJlc3MgY2xpY2tzIHRvIGF2b2lkIGEgZG91YmxlLWNsaWNrLgogKiBAdHlwZSBudW1iZXIKICovCkJsb2NrbHlBcHBzLkRPVUJMRV9DTElDS19USU1FID0gNDAwOwoKLyoqCiAqIEV4dHJhY3RzIGEgcGFyYW1ldGVyIGZyb20gdGhlIFVSTC4KICogSWYgdGhlIHBhcmFtZXRlciBpcyBhYnNlbnQgZGVmYXVsdF92YWx1ZSBpcyByZXR1cm5lZC4KICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHBhcmFtZXRlci4KICogQHBhcmFtIHtzdHJpbmd9IGRlZmF1bHRWYWx1ZSBWYWx1ZSB0byByZXR1cm4gaWYgcGFyYW1hdGVyIG5vdCBmb3VuZC4KICogQHJldHVybiB7c3RyaW5nfSBUaGUgcGFyYW1ldGVyIHZhbHVlIG9yIHRoZSBkZWZhdWx0IHZhbHVlIGlmIG5vdCBmb3VuZC4KICovCkJsb2NrbHlBcHBzLmdldFN0cmluZ1BhcmFtRnJvbVVybCA9IGZ1bmN0aW9uKG5hbWUsIGRlZmF1bHRWYWx1ZSkgewogIHZhciB2YWwgPQogICAgICB3aW5kb3cubG9jYXRpb24uc2VhcmNoLm1hdGNoKG5ldyBSZWdFeHAoJ1s/Jl0nICsgbmFtZSArICc9KFteJl0rKScpKTsKICByZXR1cm4gdmFsID8gZGVjb2RlVVJJQ29tcG9uZW50KHZhbFsxXS5yZXBsYWNlKC9cKy9nLCAnJTIwJykpIDogZGVmYXVsdFZhbHVlOwp9OwoKLyoqCiAqIEV4dHJhY3RzIGEgbnVtZXJpYyBwYXJhbWV0ZXIgZnJvbSB0aGUgVVJMLgogKiBJZiB0aGUgcGFyYW1ldGVyIGlzIGFic2VudCBvciBsZXNzIHRoYW4gbWluX3ZhbHVlLCBtaW5fdmFsdWUgaXMKICogcmV0dXJuZWQuICBJZiBpdCBpcyBncmVhdGVyIHRoYW4gbWF4X3ZhbHVlLCBtYXhfdmFsdWUgaXMgcmV0dXJuZWQuCiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBwYXJhbWV0ZXIuCiAqIEBwYXJhbSB7bnVtYmVyfSBtaW5WYWx1ZSBUaGUgbWluaW11bSBsZWdhbCB2YWx1ZS4KICogQHBhcmFtIHtudW1iZXJ9IG1heFZhbHVlIFRoZSBtYXhpbXVtIGxlZ2FsIHZhbHVlLgogKiBAcmV0dXJuIHtudW1iZXJ9IEEgbnVtYmVyIGluIHRoZSByYW5nZSBbbWluX3ZhbHVlLCBtYXhfdmFsdWVdLgogKi8KQmxvY2tseUFwcHMuZ2V0TnVtYmVyUGFyYW1Gcm9tVXJsID0gZnVuY3Rpb24obmFtZSwgbWluVmFsdWUsIG1heFZhbHVlKSB7CiAgdmFyIHZhbCA9IE51bWJlcihCbG9ja2x5QXBwcy5nZXRTdHJpbmdQYXJhbUZyb21VcmwobmFtZSwgJ05hTicpKTsKICByZXR1cm4gaXNOYU4odmFsKSA/IG1pblZhbHVlIDogTWF0aC5taW4oTWF0aC5tYXgobWluVmFsdWUsIHZhbCksIG1heFZhbHVlKTsKfTsKCi8qKgogKiBVc2UgYSBzZXJpZXMgb2YgaGV1cmlzdGljcyB0aGF0IGRldGVybWluZSB0aGUgbGlrZWx5IGxhbmd1YWdlIG9mIHRoaXMgdXNlci4KICogVXNlIGEgc2Vzc2lvbiBjb29raWUgdG8gbG9hZC9zYXZlIHRoZSBsYW5ndWFnZSBwcmVmZXJlbmNlLgogKiBAcmV0dXJuIHtzdHJpbmd9IFVzZXIncyBsYW5ndWFnZS4KICogQHRocm93cyB7c3RyaW5nfSBJZiBubyBsYW5ndWFnZXMgZXhpc3QgaW4gdGhpcyBhcHAuCiAqLwpCbG9ja2x5QXBwcy5nZXRMYW5nID0gZnVuY3Rpb24oKSB7CiAgLy8gRmlyc3QgY2hvaWNlOiBUaGUgVVJMIHNwZWNpZmllZCBsYW5ndWFnZS4KICB2YXIgbGFuZyA9IEJsb2NrbHlBcHBzLmdldFN0cmluZ1BhcmFtRnJvbVVybCgnbGFuZycsICcnKTsKICBpZiAoQmxvY2tseUFwcHMuTEFOR1VBR0VTLmluZGV4T2YobGFuZykgIT0gLTEpIHsKICAgIC8vIFNhdmUgdGhpcyBleHBsaWNpdCBjaG9pY2UgYXMgY29va2llLgogICAgLy8gVXNlIG9mIGEgc2Vzc2lvbiBjb29raWUgZm9yIHNhdmluZyBsYW5ndWFnZSBpcyBleHBsaWNpdGx5IHBlcm1pdHRlZAogICAgLy8gaW4gdGhlIEVVJ3MgQ29va2llIENvbnNlbnQgRXhlbXB0aW9uIHBvbGljeS4gIFNlY3Rpb24gMy42OgogICAgLy8gaHR0cDovL2VjLmV1cm9wYS5ldS9qdXN0aWNlL2RhdGEtcHJvdGVjdGlvbi9hcnRpY2xlLTI5L2RvY3VtZW50YXRpb24vCiAgICAvLyAgIG9waW5pb24tcmVjb21tZW5kYXRpb24vZmlsZXMvMjAxMi93cDE5NF9lbi5wZGYKICAgIGRvY3VtZW50LmNvb2tpZSA9ICdsYW5nPScgKyBlc2NhcGUobGFuZykgKyAnOyBwYXRoPS8nOwogICAgcmV0dXJuIGxhbmc7CiAgfQogIC8vIFNlY29uZCBjaG9pY2U6IExhbmd1YWdlIGNvb2tpZS4KICB2YXIgY29va2llID0gZG9jdW1lbnQuY29va2llLm1hdGNoKC8oXnw7KVxzKmxhbmc9KFx3KykvKTsKICBpZiAoY29va2llKSB7CiAgICBsYW5nID0gdW5lc2NhcGUoY29va2llWzJdKTsKICAgIGlmIChCbG9ja2x5QXBwcy5MQU5HVUFHRVMuaW5kZXhPZihsYW5nKSAhPSAtMSkgewogICAgICByZXR1cm4gbGFuZzsKICAgIH0KICB9CiAgLy8gVGhpcmQgY2hvaWNlOiBUaGUgYnJvd3NlcidzIGxhbmd1YWdlLgogIGxhbmcgPSBuYXZpZ2F0b3IubGFuZ3VhZ2U7CiAgaWYgKEJsb2NrbHlBcHBzLkxBTkdVQUdFUy5pbmRleE9mKGxhbmcpICE9IC0xKSB7CiAgICByZXR1cm4gbGFuZzsKICB9CiAgLy8gRm91cnRoIGNob2ljZTogRW5nbGlzaC4KICBsYW5nID0gJ2VuJzsKICBpZiAoQmxvY2tseUFwcHMuTEFOR1VBR0VTLmluZGV4T2YobGFuZykgIT0gLTEpIHsKICAgIHJldHVybiBsYW5nOwogIH0KICAvLyBGaWZ0aCBjaG9pY2U6IEknbSBmZWVsaW5nIGx1Y2t5LgogIGlmIChCbG9ja2x5QXBwcy5MQU5HVUFHRVMubGVuZ3RoKSB7CiAgICByZXR1cm4gQmxvY2tseUFwcHMuTEFOR1VBR0VTWzBdOwogIH0KICAvLyBTaXh0aCBjaG9pY2U6IERpZS4KICB0aHJvdyAnTm8gbGFuZ3VhZ2VzIGF2YWlsYWJsZS4nOwp9OwoKLyoqCiAqIElzIHRoZSBjdXJyZW50IGxhbmd1YWdlIChCbG9ja2x5QXBwcy5MQU5HKSBhbiBSVEwgbGFuZ3VhZ2U/CiAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgUlRMLCBmYWxzZSBpZiBMVFIuCiAqLwpCbG9ja2x5QXBwcy5pc1J0bCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBCbG9ja2x5QXBwcy5MQU5HVUFHRV9SVEwuaW5kZXhPZihCbG9ja2x5QXBwcy5MQU5HKSAhPSAtMTsKfTsKCi8qKgogKiBMb29rIHVwIHRoZSBCbG9ja2x5IGxhbmd1YWdlIHBhY2sgZm9yIGN1cnJlbnQgbGFuZ3VhZ2UgKEJsb2NrbHlBcHBzLkxBTkcpLgogKiBAcmV0dXJuIHtzdHJpbmd9IFVSTCB0byBsYW5ndWdhZSBwYWNrIChlLmcuICdtc2cvanMvZW4uanMnKS4KICovCkJsb2NrbHlBcHBzLmxhbmd1YWdlUGFjayA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBCbG9ja2x5QXBwcy5MQU5HVUFHRV9QQUNLW0Jsb2NrbHlBcHBzLkxBTkddIHx8CiAgICBCbG9ja2x5QXBwcy5MQU5HVUFHRV9QQUNLWydkZWZhdWx0J107Cn07CgovKioKICogQ29tbW9uIHN0YXJ0dXAgdGFza3MgZm9yIGFsbCBhcHBzLgogKi8KQmxvY2tseUFwcHMuaW5pdCA9IGZ1bmN0aW9uKCkgewogIC8vIFNldCB0aGUgcGFnZSB0aXRsZSB3aXRoIHRoZSBjb250ZW50IG9mIHRoZSBIMSB0aXRsZS4KICBkb2N1bWVudC50aXRsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0aXRsZScpLnRleHRDb250ZW50OwoKICAvLyBTZXQgdGhlIEhUTUwncyBsYW5ndWFnZSBhbmQgZGlyZWN0aW9uLgogIC8vIGRvY3VtZW50LmRpciBmYWlscyBpbiBNb3ppbGxhLCB1c2UgZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlLmRpciBpbnN0ZWFkLgogIC8vIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTE1MTQwNwogIHZhciBydGwgPSBCbG9ja2x5QXBwcy5pc1J0bCgpOwogIGRvY3VtZW50LmhlYWQucGFyZW50RWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2RpcicsIHJ0bCA/ICdydGwnIDogJ2x0cicpOwogIGRvY3VtZW50LmhlYWQucGFyZW50RWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2xhbmcnLCBCbG9ja2x5QXBwcy5MQU5HKTsKCiAgLy8gU29ydCBsYW5ndWFnZXMgYWxwaGFiZXRpY2FsbHkuCiAgdmFyIGxhbmd1YWdlcyA9IFtdOwogIGZvciAodmFyIGkgPSAwOyBpIDwgQmxvY2tseUFwcHMuTEFOR1VBR0VTLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgbGFuZyA9IEJsb2NrbHlBcHBzLkxBTkdVQUdFU1tpXTsKICAgIGxhbmd1YWdlcy5wdXNoKFtCbG9ja2x5QXBwcy5MQU5HVUFHRV9OQU1FW2xhbmddLCBsYW5nXSk7CiAgfQogIHZhciBjb21wID0gZnVuY3Rpb24oYSwgYikgewogICAgLy8gU29ydCBiYXNlZCBvbiBmaXJzdCBhcmd1bWVudCAoJ0VuZ2xpc2gnLCAn0KDRg9GB0YHQutC40LknLCAn566A5L2T5a2XJywgZXRjKS4KICAgIGlmIChhWzBdID4gYlswXSkgcmV0dXJuIDE7CiAgICBpZiAoYVswXSA8IGJbMF0pIHJldHVybiAtMTsKICAgIHJldHVybiAwOwogIH07CiAgbGFuZ3VhZ2VzLnNvcnQoY29tcCk7CiAgLy8gUG9wdWxhdGUgdGhlIGxhbmd1YWdlIHNlbGVjdGlvbiBtZW51LgogIHZhciBsYW5ndWFnZU1lbnUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGFuZ3VhZ2VNZW51Jyk7CiAgbGFuZ3VhZ2VNZW51Lm9wdGlvbnMubGVuZ3RoID0gMDsKICBmb3IgKHZhciBpID0gMDsgaSA8IGxhbmd1YWdlcy5sZW5ndGg7IGkrKykgewogICAgdmFyIHR1cGxlID0gbGFuZ3VhZ2VzW2ldOwogICAgdmFyIGxhbmcgPSB0dXBsZVt0dXBsZS5sZW5ndGggLSAxXTsKICAgIHZhciBvcHRpb24gPSBuZXcgT3B0aW9uKHR1cGxlWzBdLCBsYW5nKTsKICAgIGlmIChsYW5nID09IEJsb2NrbHlBcHBzLkxBTkcpIHsKICAgICAgb3B0aW9uLnNlbGVjdGVkID0gdHJ1ZTsKICAgIH0KICAgIGxhbmd1YWdlTWVudS5vcHRpb25zLmFkZChvcHRpb24pOwogIH0KICBsYW5ndWFnZU1lbnUuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgQmxvY2tseUFwcHMuY2hhbmdlTGFuZ3VhZ2UsIHRydWUpOwoKICAvLyBEaXNhYmxlIHRoZSBsaW5rIGJ1dHRvbiBpZiBwYWdlIGlzbid0IGJhY2tlZCBieSBBcHAgRW5naW5lIHN0b3JhZ2UuCiAgdmFyIGxpbmtCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGlua0J1dHRvbicpOwogIGlmICgnQmxvY2tseVN0b3JhZ2UnIGluIHdpbmRvdykgewogICAgQmxvY2tseVN0b3JhZ2VbJ0hUVFBSRVFVRVNUX0VSUk9SJ10gPQogICAgICAgIEJsb2NrbHlBcHBzLmdldE1zZygnaHR0cFJlcXVlc3RFcnJvcicpOwogICAgQmxvY2tseVN0b3JhZ2VbJ0xJTktfQUxFUlQnXSA9IEJsb2NrbHlBcHBzLmdldE1zZygnbGlua0FsZXJ0Jyk7CiAgICBCbG9ja2x5U3RvcmFnZVsnSEFTSF9FUlJPUiddID0gQmxvY2tseUFwcHMuZ2V0TXNnKCdoYXNoRXJyb3InKTsKICAgIEJsb2NrbHlTdG9yYWdlWydYTUxfRVJST1InXSA9IEJsb2NrbHlBcHBzLmdldE1zZygneG1sRXJyb3InKTsKICAgIC8vIFN3YXAgb3V0IHRoZSBCbG9ja2x5U3RvcmFnZSdzIGFsZXJ0KCkgZm9yIGEgbmljZXIgZGlhbG9nLgogICAgQmxvY2tseVN0b3JhZ2UuYWxlcnQgPSBCbG9ja2x5QXBwcy5zdG9yYWdlQWxlcnQ7CiAgICBCbG9ja2x5QXBwcy5iaW5kQ2xpY2sobGlua0J1dHRvbiwgQmxvY2tseVN0b3JhZ2UubGluayk7CiAgfSBlbHNlIGlmIChsaW5rQnV0dG9uKSB7CiAgICBsaW5rQnV0dG9uLmNsYXNzTmFtZSA9ICdkaXNhYmxlZCc7CiAgfQoKICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvZGVCdXR0b24nKSkgewogICAgQmxvY2tseUFwcHMuYmluZENsaWNrKCdjb2RlQnV0dG9uJywgQmxvY2tseUFwcHMuc2hvd0NvZGUpOwogIH0KCiAgLy8gRml4ZXMgdmlld3BvcnQgZm9yIHNtYWxsIHNjcmVlbnMuCiAgdmFyIHZpZXdwb3J0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignbWV0YVtuYW1lPSJ2aWV3cG9ydCJdJyk7CiAgaWYgKHZpZXdwb3J0ICYmIHNjcmVlbi5hdmFpbFdpZHRoIDwgNzI1KSB7CiAgICB2aWV3cG9ydC5zZXRBdHRyaWJ1dGUoJ2NvbnRlbnQnLAogICAgICAgICd3aWR0aD03MjUsIGluaXRpYWwtc2NhbGU9LjM1LCB1c2VyLXNjYWxhYmxlPW5vJyk7CiAgfQp9OwoKLyoqCiAqIEluaXRpYWxpemUgQmxvY2tseSBmb3IgYSByZWFkb25seSBpZnJhbWUuICBDYWxsZWQgb24gcGFnZSBsb2FkLgogKiBYTUwgYXJndW1lbnQgbWF5IGJlIGdlbmVyYXRlZCBmcm9tIHRoZSBjb25zb2xlIHdpdGg6CiAqIGVuY29kZVVSSUNvbXBvbmVudChCbG9ja2x5LlhtbC5kb21Ub1RleHQoQmxvY2tseS5YbWwud29ya3NwYWNlVG9Eb20oQmxvY2tseS5tYWluV29ya3NwYWNlKSkuc2xpY2UoNSwgLTYpKQogKi8KQmxvY2tseUFwcHMuaW5pdFJlYWRvbmx5ID0gZnVuY3Rpb24oKSB7CiAgQmxvY2tseS5pbmplY3QoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Jsb2NrbHknKSwKICAgICAge3BhdGg6ICcuLi8uLi8nLAogICAgICAgcmVhZE9ubHk6IHRydWUsCiAgICAgICBydGw6IEJsb2NrbHlBcHBzLmlzUnRsKCksCiAgICAgICBzY3JvbGxiYXJzOiBmYWxzZX0pOwoKICAvLyBBZGQgdGhlIGJsb2Nrcy4KICB2YXIgeG1sID0gQmxvY2tseUFwcHMuZ2V0U3RyaW5nUGFyYW1Gcm9tVXJsKCd4bWwnLCAnJyk7CiAgeG1sID0gQmxvY2tseS5YbWwudGV4dFRvRG9tKCc8eG1sPicgKyB4bWwgKyAnPC94bWw+Jyk7CiAgQmxvY2tseS5YbWwuZG9tVG9Xb3Jrc3BhY2UoQmxvY2tseS5tYWluV29ya3NwYWNlLCB4bWwpOwp9OwoKLyoqCiAqIExvYWQgYmxvY2tzIHNhdmVkIG9uIEFwcCBFbmdpbmUgU3RvcmFnZSBvciBpbiBzZXNzaW9uL2xvY2FsIHN0b3JhZ2UuCiAqIEBwYXJhbSB7c3RyaW5nfSBkZWZhdWx0WG1sIFRleHQgcmVwcmVzZW50YXRpb24gb2YgZGVmYXVsdCBibG9ja3MuCiAqLwpCbG9ja2x5QXBwcy5sb2FkQmxvY2tzID0gZnVuY3Rpb24oZGVmYXVsdFhtbCkgewogIHRyeSB7CiAgICB2YXIgbG9hZE9uY2UgPSB3aW5kb3cuc2Vzc2lvblN0b3JhZ2UubG9hZE9uY2VCbG9ja3M7CiAgfSBjYXRjaChlKSB7CiAgICAvLyBGaXJlZm94IHNvbWV0aW1lcyB0aHJvd3MgYSBTZWN1cml0eUVycm9yIHdoZW4gYWNjZXNzaW5nIHNlc3Npb25TdG9yYWdlLgogICAgLy8gUmVzdGFydGluZyBGaXJlZm94IGZpeGVzIHRoaXMsIHNvIGl0IGxvb2tzIGxpa2UgYSBidWcuCiAgICB2YXIgbG9hZE9uY2UgPSBudWxsOwogIH0KICBpZiAoJ0Jsb2NrbHlTdG9yYWdlJyBpbiB3aW5kb3cgJiYgd2luZG93LmxvY2F0aW9uLmhhc2gubGVuZ3RoID4gMSkgewogICAgLy8gQW4gaHJlZiB3aXRoICNrZXkgdHJpZ2VycyBhbiBBSkFYIGNhbGwgdG8gcmV0cmlldmUgc2F2ZWQgYmxvY2tzLgogICAgQmxvY2tseVN0b3JhZ2UucmV0cmlldmVYbWwod2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyaW5nKDEpKTsKICB9IGVsc2UgaWYgKGxvYWRPbmNlKSB7CiAgICAvLyBMYW5ndWFnZSBzd2l0Y2hpbmcgc3RvcmVzIHRoZSBibG9ja3MgZHVyaW5nIHRoZSByZWxvYWQuCiAgICBkZWxldGUgd2luZG93LnNlc3Npb25TdG9yYWdlLmxvYWRPbmNlQmxvY2tzOwogICAgdmFyIHhtbCA9IEJsb2NrbHkuWG1sLnRleHRUb0RvbShsb2FkT25jZSk7CiAgICBCbG9ja2x5LlhtbC5kb21Ub1dvcmtzcGFjZShCbG9ja2x5Lm1haW5Xb3Jrc3BhY2UsIHhtbCk7CiAgfSBlbHNlIGlmIChkZWZhdWx0WG1sKSB7CiAgICAvLyBMb2FkIHRoZSBlZGl0b3Igd2l0aCBkZWZhdWx0IHN0YXJ0aW5nIGJsb2Nrcy4KICAgIHZhciB4bWwgPSBCbG9ja2x5LlhtbC50ZXh0VG9Eb20oZGVmYXVsdFhtbCk7CiAgICBCbG9ja2x5LlhtbC5kb21Ub1dvcmtzcGFjZShCbG9ja2x5Lm1haW5Xb3Jrc3BhY2UsIHhtbCk7CiAgfSBlbHNlIGlmICgnQmxvY2tseVN0b3JhZ2UnIGluIHdpbmRvdykgewogICAgLy8gUmVzdG9yZSBzYXZlZCBibG9ja3MgaW4gYSBzZXBhcmF0ZSB0aHJlYWQgc28gdGhhdCBzdWJzZXF1ZW50CiAgICAvLyBpbml0aWFsaXphdGlvbiBpcyBub3QgYWZmZWN0ZWQgZnJvbSBhIGZhaWxlZCBsb2FkLgogICAgd2luZG93LnNldFRpbWVvdXQoQmxvY2tseVN0b3JhZ2UucmVzdG9yZUJsb2NrcywgMCk7CiAgfQp9OwoKLyoqCiAqIFNhdmUgdGhlIGJsb2NrcyBhbmQgcmVsb2FkIHdpdGggYSBkaWZmZXJlbnQgbGFuZ3VhZ2UuCiAqLwpCbG9ja2x5QXBwcy5jaGFuZ2VMYW5ndWFnZSA9IGZ1bmN0aW9uKCkgewogIC8vIFN0b3JlIHRoZSBibG9ja3MgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgcmVsb2FkLgogIC8vIFRoaXMgc2hvdWxkIGJlIHNraXBwZWQgZm9yIHRoZSBpbmRleCBwYWdlLCB3aGljaCBoYXMgbm8gYmxvY2tzIGFuZCBkb2VzCiAgLy8gbm90IGxvYWQgQmxvY2tseS4KICAvLyBNU0lFIDExIGRvZXMgbm90IHN1cHBvcnQgc2Vzc2lvblN0b3JhZ2Ugb24gZmlsZTovLyBVUkxzLgogIGlmICh0eXBlb2YgQmxvY2tseSAhPSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuc2Vzc2lvblN0b3JhZ2UpIHsKICAgIHZhciB4bWwgPSBCbG9ja2x5LlhtbC53b3Jrc3BhY2VUb0RvbShCbG9ja2x5Lm1haW5Xb3Jrc3BhY2UpOwogICAgdmFyIHRleHQgPSBCbG9ja2x5LlhtbC5kb21Ub1RleHQoeG1sKTsKICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5sb2FkT25jZUJsb2NrcyA9IHRleHQ7CiAgfQoKICB2YXIgbGFuZ3VhZ2VNZW51ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xhbmd1YWdlTWVudScpOwogIHZhciBuZXdMYW5nID0gZW5jb2RlVVJJQ29tcG9uZW50KAogICAgICBsYW5ndWFnZU1lbnUub3B0aW9uc1tsYW5ndWFnZU1lbnUuc2VsZWN0ZWRJbmRleF0udmFsdWUpOwogIHZhciBzZWFyY2ggPSB3aW5kb3cubG9jYXRpb24uc2VhcmNoOwogIGlmIChzZWFyY2gubGVuZ3RoIDw9IDEpIHsKICAgIHNlYXJjaCA9ICc/bGFuZz0nICsgbmV3TGFuZzsKICB9IGVsc2UgaWYgKHNlYXJjaC5tYXRjaCgvWz8mXWxhbmc9W14mXSovKSkgewogICAgc2VhcmNoID0gc2VhcmNoLnJlcGxhY2UoLyhbPyZdbGFuZz0pW14mXSovLCAnJDEnICsgbmV3TGFuZyk7CiAgfSBlbHNlIHsKICAgIHNlYXJjaCA9IHNlYXJjaC5yZXBsYWNlKC9cPy8sICc/bGFuZz0nICsgbmV3TGFuZyArICcmJyk7CiAgfQoKICB3aW5kb3cubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wgKyAnLy8nICsKICAgICAgd2luZG93LmxvY2F0aW9uLmhvc3QgKyB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgKyBzZWFyY2g7Cn07CgovKioKICogSGlnaGxpZ2h0IHRoZSBibG9jayAob3IgY2xlYXIgaGlnaGxpZ2h0aW5nKS4KICogQHBhcmFtIHs/c3RyaW5nfSBpZCBJRCBvZiBibG9jayB0aGF0IHRyaWdnZXJlZCB0aGlzIGFjdGlvbi4KICovCkJsb2NrbHlBcHBzLmhpZ2hsaWdodCA9IGZ1bmN0aW9uKGlkKSB7CiAgaWYgKGlkKSB7CiAgICB2YXIgbSA9IGlkLm1hdGNoKC9eYmxvY2tfaWRfKFxkKykkLyk7CiAgICBpZiAobSkgewogICAgICBpZCA9IG1bMV07CiAgICB9CiAgfQogIEJsb2NrbHkubWFpbldvcmtzcGFjZS5oaWdobGlnaHRCbG9jayhpZCk7Cn07CgovKioKICogSWYgdGhlIHVzZXIgaGFzIGV4ZWN1dGVkIHRvbyBtYW55IGFjdGlvbnMsIHdlJ3JlIHByb2JhYmx5IGluIGFuIGluZmluaXRlCiAqIGxvb3AuICBTYWRseSBJIHdhc24ndCBhYmxlIHRvIHNvbHZlIHRoZSBIYWx0aW5nIFByb2JsZW0uCiAqIEBwYXJhbSB7P3N0cmluZ30gb3B0X2lkIElEIG9mIGxvb3AgYmxvY2sgdG8gaGlnaGxpZ2h0LgogKiBAdGhyb3dzIHtJbmZpbml0eX0gVGhyb3dzIGFuIGVycm9yIHRvIHRlcm1pbmF0ZSB0aGUgdXNlcidzIHByb2dyYW0uCiAqLwpCbG9ja2x5QXBwcy5jaGVja1RpbWVvdXQgPSBmdW5jdGlvbihvcHRfaWQpIHsKICBpZiAob3B0X2lkKSB7CiAgICBCbG9ja2x5QXBwcy5sb2cucHVzaChbbnVsbCwgb3B0X2lkXSk7CiAgfQogIGlmIChCbG9ja2x5QXBwcy50aWNrcy0tIDwgMCkgewogICAgdGhyb3cgSW5maW5pdHk7CiAgfQp9OwoKLyoqCiAqIElzIHRoZSBkaWFsb2cgY3VycmVudGx5IG9uc2NyZWVuPwogKiBAcHJpdmF0ZQogKi8KQmxvY2tseUFwcHMuaXNEaWFsb2dWaXNpYmxlXyA9IGZhbHNlOwoKLyoqCiAqIEEgY2xvc2luZyBkaWFsb2cgc2hvdWxkIGFuaW1hdGUgdG93YXJkcyB0aGlzIGVsZW1lbnQuCiAqIEB0eXBlIEVsZW1lbnQKICogQHByaXZhdGUKICovCkJsb2NrbHlBcHBzLmRpYWxvZ09yaWdpbl8gPSBudWxsOwoKLyoqCiAqIEEgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIGEgZGlhbG9nIGNsb3Nlcy4KICogQHR5cGUgRnVuY3Rpb24KICogQHByaXZhdGUKICovCkJsb2NrbHlBcHBzLmRpYWxvZ0Rpc3Bvc2VfID0gbnVsbDsKCi8qKgogKiBTaG93IHRoZSBkaWFsb2cgcG9wLXVwLgogKiBAcGFyYW0geyFFbGVtZW50fSBjb250ZW50IERPTSBlbGVtZW50IHRvIGRpc3BsYXkgaW4gdGhlIGRpYWxvZy4KICogQHBhcmFtIHtFbGVtZW50fSBvcmlnaW4gQW5pbWF0ZSB0aGUgZGlhbG9nIG9wZW5pbmcvY2xvc2luZyBmcm9tL3RvIHRoaXMKICogICAgIERPTSBlbGVtZW50LiAgSWYgbnVsbCwgZG9uJ3Qgc2hvdyBhbnkgYW5pbWF0aW9ucyBmb3Igb3BlbmluZyBvciBjbG9zaW5nLgogKiBAcGFyYW0ge2Jvb2xlYW59IGFuaW1hdGUgQW5pbWF0ZSB0aGUgZGlhbG9nIG9wZW5pbmcgKGlmIG9yaWdpbiBub3QgbnVsbCkuCiAqIEBwYXJhbSB7Ym9vbGVhbn0gbW9kYWwgSWYgdHJ1ZSwgZ3JleSBvdXQgYmFja2dyb3VuZCBhbmQgcHJldmVudCBpbnRlcmFjdGlvbi4KICogQHBhcmFtIHshT2JqZWN0fSBzdHlsZSBBIGRpY3Rpb25hcnkgb2Ygc3R5bGUgcnVsZXMgZm9yIHRoZSBkaWFsb2cuCiAqIEBwYXJhbSB7RnVuY3Rpb259IGRpc3Bvc2VGdW5jIEFuIG9wdGlvbmFsIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGUgZGlhbG9nCiAqICAgICBjbG9zZXMuICBOb3JtYWxseSB1c2VkIGZvciB1bmhvb2tpbmcgZXZlbnRzLgogKi8KQmxvY2tseUFwcHMuc2hvd0RpYWxvZyA9IGZ1bmN0aW9uKGNvbnRlbnQsIG9yaWdpbiwgYW5pbWF0ZSwgbW9kYWwsIHN0eWxlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcG9zZUZ1bmMpIHsKICBpZiAoQmxvY2tseUFwcHMuaXNEaWFsb2dWaXNpYmxlXykgewogICAgQmxvY2tseUFwcHMuaGlkZURpYWxvZyhmYWxzZSk7CiAgfQogIEJsb2NrbHlBcHBzLmlzRGlhbG9nVmlzaWJsZV8gPSB0cnVlOwogIEJsb2NrbHlBcHBzLmRpYWxvZ09yaWdpbl8gPSBvcmlnaW47CiAgQmxvY2tseUFwcHMuZGlhbG9nRGlzcG9zZV8gPSBkaXNwb3NlRnVuYzsKICB2YXIgZGlhbG9nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpYWxvZycpOwogIHZhciBzaGFkb3cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGlhbG9nU2hhZG93Jyk7CiAgdmFyIGJvcmRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2dCb3JkZXInKTsKCiAgLy8gQ29weSBhbGwgdGhlIHNwZWNpZmllZCBzdHlsZXMgdG8gdGhlIGRpYWxvZy4KICBmb3IgKHZhciBuYW1lIGluIHN0eWxlKSB7CiAgICBkaWFsb2cuc3R5bGVbbmFtZV0gPSBzdHlsZVtuYW1lXTsKICB9CiAgaWYgKG1vZGFsKSB7CiAgICBzaGFkb3cuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgIHNoYWRvdy5zdHlsZS5vcGFjaXR5ID0gMC4zOwogICAgdmFyIGhlYWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgaGVhZGVyLmlkID0gJ2RpYWxvZ0hlYWRlcic7CiAgICBkaWFsb2cuYXBwZW5kQ2hpbGQoaGVhZGVyKTsKICAgIEJsb2NrbHlBcHBzLmRpYWxvZ01vdXNlRG93bldyYXBwZXJfID0KICAgICAgICBCbG9ja2x5LmJpbmRFdmVudF8oaGVhZGVyLCAnbW91c2Vkb3duJywgbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgQmxvY2tseUFwcHMuZGlhbG9nTW91c2VEb3duXyk7CiAgfQogIGRpYWxvZy5hcHBlbmRDaGlsZChjb250ZW50KTsKICBjb250ZW50LmNsYXNzTmFtZSA9IGNvbnRlbnQuY2xhc3NOYW1lLnJlcGxhY2UoJ2RpYWxvZ0hpZGRlbkNvbnRlbnQnLCAnJyk7CgogIGZ1bmN0aW9uIGVuZFJlc3VsdCgpIHsKICAgIC8vIENoZWNrIHRoYXQgdGhlIGRpYWxvZyB3YXNuJ3QgY2xvc2VkIGR1cmluZyBvcGVuaW5nLgogICAgaWYgKEJsb2NrbHlBcHBzLmlzRGlhbG9nVmlzaWJsZV8pIHsKICAgICAgZGlhbG9nLnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CiAgICAgIGRpYWxvZy5zdHlsZS56SW5kZXggPSAxOwogICAgICBib3JkZXIuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwogICAgfQogIH0KICBpZiAoYW5pbWF0ZSAmJiBvcmlnaW4pIHsKICAgIEJsb2NrbHlBcHBzLm1hdGNoQm9yZGVyXyhvcmlnaW4sIGZhbHNlLCAwLjIpOwogICAgQmxvY2tseUFwcHMubWF0Y2hCb3JkZXJfKGRpYWxvZywgdHJ1ZSwgMC44KTsKICAgIC8vIEluIDE3NW1zIHNob3cgdGhlIGRpYWxvZyBhbmQgaGlkZSB0aGUgYW5pbWF0ZWQgYm9yZGVyLgogICAgd2luZG93LnNldFRpbWVvdXQoZW5kUmVzdWx0LCAxNzUpOwogIH0gZWxzZSB7CiAgICAvLyBObyBhbmltYXRpb24uICBKdXN0IHNldCB0aGUgZmluYWwgc3RhdGUuCiAgICBlbmRSZXN1bHQoKTsKICB9Cn07CgovKioKICogSG9yaXpvbnRhbCBzdGFydCBjb29yZGluYXRlIG9mIGRpYWxvZyBkcmFnLgogKi8KQmxvY2tseUFwcHMuZGlhbG9nU3RhcnRYXyA9IDA7CgovKioKICogVmVydGljYWwgc3RhcnQgY29vcmRpbmF0ZSBvZiBkaWFsb2cgZHJhZy4KICovCkJsb2NrbHlBcHBzLmRpYWxvZ1N0YXJ0WV8gPSAwOwoKLyoqCiAqIEhhbmRsZSBzdGFydCBvZiBkcmFnIG9mIGRpYWxvZy4KICogQHBhcmFtIHshRXZlbnR9IGUgTW91c2UgZG93biBldmVudC4KICogQHByaXZhdGUKICovCkJsb2NrbHlBcHBzLmRpYWxvZ01vdXNlRG93bl8gPSBmdW5jdGlvbihlKSB7CiAgQmxvY2tseUFwcHMuZGlhbG9nVW5iaW5kRHJhZ0V2ZW50c18oKTsKICBpZiAoQmxvY2tseS5pc1JpZ2h0QnV0dG9uKGUpKSB7CiAgICAvLyBSaWdodC1jbGljay4KICAgIHJldHVybjsKICB9CiAgLy8gTGVmdCBjbGljayAob3IgbWlkZGxlIGNsaWNrKS4KICAvLyBSZWNvcmQgdGhlIHN0YXJ0aW5nIG9mZnNldCBiZXR3ZWVuIHRoZSBjdXJyZW50IGxvY2F0aW9uIGFuZCB0aGUgbW91c2UuCiAgdmFyIGRpYWxvZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2cnKTsKICBCbG9ja2x5QXBwcy5kaWFsb2dTdGFydFhfID0gZGlhbG9nLm9mZnNldExlZnQgLSBlLmNsaWVudFg7CiAgQmxvY2tseUFwcHMuZGlhbG9nU3RhcnRZXyA9IGRpYWxvZy5vZmZzZXRUb3AgLSBlLmNsaWVudFk7CgogIEJsb2NrbHlBcHBzLmRpYWxvZ01vdXNlVXBXcmFwcGVyXyA9IEJsb2NrbHkuYmluZEV2ZW50Xyhkb2N1bWVudCwKICAgICAgJ21vdXNldXAnLCBudWxsLCBCbG9ja2x5QXBwcy5kaWFsb2dVbmJpbmREcmFnRXZlbnRzXyk7CiAgQmxvY2tseUFwcHMuZGlhbG9nTW91c2VNb3ZlV3JhcHBlcl8gPSBCbG9ja2x5LmJpbmRFdmVudF8oZG9jdW1lbnQsCiAgICAgICdtb3VzZW1vdmUnLCBudWxsLCBCbG9ja2x5QXBwcy5kaWFsb2dNb3VzZU1vdmVfKTsKICAvLyBUaGlzIGV2ZW50IGhhcyBiZWVuIGhhbmRsZWQuICBObyBuZWVkIHRvIGJ1YmJsZSB1cCB0byB0aGUgZG9jdW1lbnQuCiAgZS5zdG9wUHJvcGFnYXRpb24oKTsKfTsKCi8qKgogKiBEcmFnIHRoZSBkaWFsb2cgdG8gZm9sbG93IHRoZSBtb3VzZS4KICogQHBhcmFtIHshRXZlbnR9IGUgTW91c2UgbW92ZSBldmVudC4KICogQHByaXZhdGUKICovCkJsb2NrbHlBcHBzLmRpYWxvZ01vdXNlTW92ZV8gPSBmdW5jdGlvbihlKSB7CiAgdmFyIGRpYWxvZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2cnKTsKICB2YXIgZGlhbG9nTGVmdCA9IEJsb2NrbHlBcHBzLmRpYWxvZ1N0YXJ0WF8gKyBlLmNsaWVudFg7CiAgdmFyIGRpYWxvZ1RvcCA9IEJsb2NrbHlBcHBzLmRpYWxvZ1N0YXJ0WV8gKyBlLmNsaWVudFk7CiAgZGlhbG9nVG9wID0gTWF0aC5tYXgoZGlhbG9nVG9wLCAwKTsKICBkaWFsb2dUb3AgPSBNYXRoLm1pbihkaWFsb2dUb3AsIHdpbmRvdy5pbm5lckhlaWdodCAtIGRpYWxvZy5vZmZzZXRIZWlnaHQpOwogIGRpYWxvZ0xlZnQgPSBNYXRoLm1heChkaWFsb2dMZWZ0LCAwKTsKICBkaWFsb2dMZWZ0ID0gTWF0aC5taW4oZGlhbG9nTGVmdCwgd2luZG93LmlubmVyV2lkdGggLSBkaWFsb2cub2Zmc2V0V2lkdGgpOwogIGRpYWxvZy5zdHlsZS5sZWZ0ID0gZGlhbG9nTGVmdCArICdweCc7CiAgZGlhbG9nLnN0eWxlLnRvcCA9IGRpYWxvZ1RvcCArICdweCc7Cn07CgovKioKICogU3RvcCBiaW5kaW5nIHRvIHRoZSBnbG9iYWwgbW91c2V1cCBhbmQgbW91c2Vtb3ZlIGV2ZW50cy4KICogQHByaXZhdGUKICovCkJsb2NrbHlBcHBzLmRpYWxvZ1VuYmluZERyYWdFdmVudHNfID0gZnVuY3Rpb24oKSB7CiAgaWYgKEJsb2NrbHlBcHBzLmRpYWxvZ01vdXNlVXBXcmFwcGVyXykgewogICAgQmxvY2tseS51bmJpbmRFdmVudF8oQmxvY2tseUFwcHMuZGlhbG9nTW91c2VVcFdyYXBwZXJfKTsKICAgIEJsb2NrbHlBcHBzLmRpYWxvZ01vdXNlVXBXcmFwcGVyXyA9IG51bGw7CiAgfQogIGlmIChCbG9ja2x5QXBwcy5kaWFsb2dNb3VzZU1vdmVXcmFwcGVyXykgewogICAgQmxvY2tseS51bmJpbmRFdmVudF8oQmxvY2tseUFwcHMuZGlhbG9nTW91c2VNb3ZlV3JhcHBlcl8pOwogICAgQmxvY2tseUFwcHMuZGlhbG9nTW91c2VNb3ZlV3JhcHBlcl8gPSBudWxsOwogIH0KfTsKCi8qKgogKiBIaWRlIHRoZSBkaWFsb2cgcG9wLXVwLgogKiBAcGFyYW0ge2Jvb2xlYW59IG9wdF9hbmltYXRlIEFuaW1hdGUgdGhlIGRpYWxvZyBjbG9zaW5nLiAgRGVmYXVsdHMgdG8gdHJ1ZS4KICogICAgIFJlcXVpcmVzIHRoYXQgb3JpZ2luIHdhcyBub3QgbnVsbCB3aGVuIGRpYWxvZyB3YXMgb3BlbmVkLgogKi8KQmxvY2tseUFwcHMuaGlkZURpYWxvZyA9IGZ1bmN0aW9uKG9wdF9hbmltYXRlKSB7CiAgaWYgKCFCbG9ja2x5QXBwcy5pc0RpYWxvZ1Zpc2libGVfKSB7CiAgICByZXR1cm47CiAgfQogIEJsb2NrbHlBcHBzLmRpYWxvZ1VuYmluZERyYWdFdmVudHNfKCk7CiAgaWYgKEJsb2NrbHlBcHBzLmRpYWxvZ01vdXNlRG93bldyYXBwZXJfKSB7CiAgICBCbG9ja2x5LnVuYmluZEV2ZW50XyhCbG9ja2x5QXBwcy5kaWFsb2dNb3VzZURvd25XcmFwcGVyXyk7CiAgICBCbG9ja2x5QXBwcy5kaWFsb2dNb3VzZURvd25XcmFwcGVyXyA9IG51bGw7CiAgfQoKICBCbG9ja2x5QXBwcy5pc0RpYWxvZ1Zpc2libGVfID0gZmFsc2U7CiAgQmxvY2tseUFwcHMuZGlhbG9nRGlzcG9zZV8gJiYgQmxvY2tseUFwcHMuZGlhbG9nRGlzcG9zZV8oKTsKICBCbG9ja2x5QXBwcy5kaWFsb2dEaXNwb3NlXyA9IG51bGw7CiAgdmFyIG9yaWdpbiA9IChvcHRfYW5pbWF0ZSA9PT0gZmFsc2UpID8gbnVsbCA6IEJsb2NrbHlBcHBzLmRpYWxvZ09yaWdpbl87CiAgdmFyIGRpYWxvZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2cnKTsKICB2YXIgc2hhZG93ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpYWxvZ1NoYWRvdycpOwogIHZhciBib3JkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGlhbG9nQm9yZGVyJyk7CgogIHNoYWRvdy5zdHlsZS5vcGFjaXR5ID0gMDsKCiAgZnVuY3Rpb24gZW5kUmVzdWx0KCkgewogICAgc2hhZG93LnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKICAgIGJvcmRlci5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CiAgfQogIGlmIChvcmlnaW4pIHsKICAgIEJsb2NrbHlBcHBzLm1hdGNoQm9yZGVyXyhkaWFsb2csIGZhbHNlLCAwLjgpOwogICAgQmxvY2tseUFwcHMubWF0Y2hCb3JkZXJfKG9yaWdpbiwgdHJ1ZSwgMC4yKTsKICAgIC8vIEluIDE3NW1zIGhpZGUgYm90aCB0aGUgc2hhZG93IGFuZCB0aGUgYW5pbWF0ZWQgYm9yZGVyLgogICAgd2luZG93LnNldFRpbWVvdXQoZW5kUmVzdWx0LCAxNzUpOwogIH0gZWxzZSB7CiAgICAvLyBObyBhbmltYXRpb24uICBKdXN0IHNldCB0aGUgZmluYWwgc3RhdGUuCiAgICBlbmRSZXN1bHQoKTsKICB9CiAgZGlhbG9nLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKICBkaWFsb2cuc3R5bGUuekluZGV4ID0gLTE7CiAgdmFyIGhlYWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2dIZWFkZXInKTsKICBpZiAoaGVhZGVyKSB7CiAgICBoZWFkZXIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChoZWFkZXIpOwogIH0KICB3aGlsZSAoZGlhbG9nLmZpcnN0Q2hpbGQpIHsKICAgIHZhciBjb250ZW50ID0gZGlhbG9nLmZpcnN0Q2hpbGQ7CiAgICBjb250ZW50LmNsYXNzTmFtZSArPSAnIGRpYWxvZ0hpZGRlbkNvbnRlbnQnOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChjb250ZW50KTsKICB9Cn07CgovKioKICogTWF0Y2ggdGhlIGFuaW1hdGVkIGJvcmRlciB0byB0aGUgYSBlbGVtZW50J3Mgc2l6ZSBhbmQgbG9jYXRpb24uCiAqIEBwYXJhbSB7IUVsZW1lbnR9IGVsZW1lbnQgRWxlbWVudCB0byBtYXRjaC4KICogQHBhcmFtIHtib29sZWFufSBhbmltYXRlIEFuaW1hdGUgdG8gdGhlIG5ldyBsb2NhdGlvbi4KICogQHBhcmFtIHtudW1iZXJ9IG9wYWNpdHkgT3BhY2l0eSBvZiBib3JkZXIuCiAqIEBwcml2YXRlCiAqLwpCbG9ja2x5QXBwcy5tYXRjaEJvcmRlcl8gPSBmdW5jdGlvbihlbGVtZW50LCBhbmltYXRlLCBvcGFjaXR5KSB7CiAgaWYgKCFlbGVtZW50KSB7CiAgICByZXR1cm47CiAgfQogIHZhciBib3JkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGlhbG9nQm9yZGVyJyk7CiAgdmFyIGJCb3ggPSBCbG9ja2x5QXBwcy5nZXRCQm94XyhlbGVtZW50KTsKICBmdW5jdGlvbiBjaGFuZ2UoKSB7CiAgICBib3JkZXIuc3R5bGUud2lkdGggPSBiQm94LndpZHRoICsgJ3B4JzsKICAgIGJvcmRlci5zdHlsZS5oZWlnaHQgPSBiQm94LmhlaWdodCArICdweCc7CiAgICBib3JkZXIuc3R5bGUubGVmdCA9IGJCb3gueCArICdweCc7CiAgICBib3JkZXIuc3R5bGUudG9wID0gYkJveC55ICsgJ3B4JzsKICAgIGJvcmRlci5zdHlsZS5vcGFjaXR5ID0gb3BhY2l0eTsKICB9CiAgaWYgKGFuaW1hdGUpIHsKICAgIGJvcmRlci5jbGFzc05hbWUgPSAnZGlhbG9nQW5pbWF0ZSc7CiAgICB3aW5kb3cuc2V0VGltZW91dChjaGFuZ2UsIDEpOwogIH0gZWxzZSB7CiAgICBib3JkZXIuY2xhc3NOYW1lID0gJyc7CiAgICBjaGFuZ2UoKTsKICB9CiAgYm9yZGVyLnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7Cn07CgovKioKICogQ29tcHV0ZSB0aGUgYWJzb2x1dGUgY29vcmRpbmF0ZXMgYW5kIGRpbWVuc2lvbnMgb2YgYW4gSFRNTCBvciBTVkcgZWxlbWVudC4KICogQHBhcmFtIHshRWxlbWVudH0gZWxlbWVudCBFbGVtZW50IHRvIG1hdGNoLgogKiBAcmV0dXJuIHshT2JqZWN0fSBDb250YWlucyBoZWlnaHQsIHdpZHRoLCB4LCBhbmQgeSBwcm9wZXJ0aWVzLgogKiBAcHJpdmF0ZQogKi8KQmxvY2tseUFwcHMuZ2V0QkJveF8gPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgaWYgKGVsZW1lbnQuZ2V0QkJveCkgewogICAgLy8gU1ZHIGVsZW1lbnQuCiAgICB2YXIgYkJveCA9IGVsZW1lbnQuZ2V0QkJveCgpOwogICAgdmFyIGhlaWdodCA9IGJCb3guaGVpZ2h0OwogICAgdmFyIHdpZHRoID0gYkJveC53aWR0aDsKICAgIHZhciB4eSA9IEJsb2NrbHkuZ2V0QWJzb2x1dGVYWV8oZWxlbWVudCk7CiAgICB2YXIgeCA9IHh5Lng7CiAgICB2YXIgeSA9IHh5Lnk7CiAgfSBlbHNlIHsKICAgIC8vIEhUTUwgZWxlbWVudC4KICAgIHZhciBoZWlnaHQgPSBlbGVtZW50Lm9mZnNldEhlaWdodDsKICAgIHZhciB3aWR0aCA9IGVsZW1lbnQub2Zmc2V0V2lkdGg7CiAgICB2YXIgeCA9IDA7CiAgICB2YXIgeSA9IDA7CiAgICBkbyB7CiAgICAgIHggKz0gZWxlbWVudC5vZmZzZXRMZWZ0OwogICAgICB5ICs9IGVsZW1lbnQub2Zmc2V0VG9wOwogICAgICBlbGVtZW50ID0gZWxlbWVudC5vZmZzZXRQYXJlbnQ7CiAgICB9IHdoaWxlIChlbGVtZW50KTsKICB9CiAgcmV0dXJuIHsKICAgIGhlaWdodDogaGVpZ2h0LAogICAgd2lkdGg6IHdpZHRoLAogICAgeDogeCwKICAgIHk6IHkKICB9Owp9OwoKLyoqCiAqIERpc3BsYXkgYSBzdG9yYWdlLXJlbGF0ZWQgbW9kYWwgZGlhbG9nLgogKiBAcGFyYW0ge3N0cmluZ30gbWVzc2FnZSBUZXh0IHRvIGFsZXJ0LgogKi8KQmxvY2tseUFwcHMuc3RvcmFnZUFsZXJ0ID0gZnVuY3Rpb24obWVzc2FnZSkgewogIHZhciBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29udGFpbmVyU3RvcmFnZScpOwogIGNvbnRhaW5lci50ZXh0Q29udGVudCA9ICcnOwogIHZhciBsaW5lcyA9IG1lc3NhZ2Uuc3BsaXQoJ1xuJyk7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykgewogICAgdmFyIHAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7CiAgICBwLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGxpbmVzW2ldKSk7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQocCk7CiAgfQoKICB2YXIgY29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2dTdG9yYWdlJyk7CiAgdmFyIG9yaWdpbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsaW5rQnV0dG9uJyk7CiAgdmFyIHN0eWxlID0gewogICAgd2lkdGg6ICc1MCUnLAogICAgbGVmdDogJzI1JScsCiAgICB0b3A6ICc1ZW0nCiAgfTsKICBCbG9ja2x5QXBwcy5zaG93RGlhbG9nKGNvbnRlbnQsIG9yaWdpbiwgdHJ1ZSwgdHJ1ZSwgc3R5bGUsCiAgICAgIEJsb2NrbHlBcHBzLnN0b3BEaWFsb2dLZXlEb3duKCkpOwogIEJsb2NrbHlBcHBzLnN0YXJ0RGlhbG9nS2V5RG93bigpOwp9OwoKLyoqCiAqIENvbnZlcnQgdGhlIHVzZXIncyBjb2RlIHRvIHJhdyBKYXZhU2NyaXB0LgogKiBAcGFyYW0ge3N0cmluZ30gY29kZSBHZW5lcmF0ZWQgY29kZS4KICogQHJldHVybiB7c3RyaW5nfSBUaGUgY29kZSB3aXRob3V0IHNlcmlhbCBudW1iZXJzIGFuZCB0aW1lb3V0IGNoZWNrcy4KICovCkJsb2NrbHlBcHBzLnN0cmlwQ29kZSA9IGZ1bmN0aW9uKGNvZGUpIHsKICAvLyBTdHJpcCBvdXQgc2VyaWFsIG51bWJlcnMuCiAgY29kZSA9IGNvZGUucmVwbGFjZSgvKCxccyopPydibG9ja19pZF9cZCsnXCkvZywgJyknKTsKICAvLyBSZW1vdmUgdGltZW91dHMuCiAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cChCbG9ja2x5LkphdmFTY3JpcHQuSU5GSU5JVEVfTE9PUF9UUkFQCiAgICAgIC5yZXBsYWNlKCcoJTEpJywgJ1xcKChcJ1xcZCtcJyk/XFwpJyksICdnJyk7CiAgcmV0dXJuIGNvZGUucmVwbGFjZShyZWdleCwgJycpOwp9OwoKLyoqCiAqIFNob3cgdGhlIHVzZXIncyBjb2RlIGluIHJhdyBKYXZhU2NyaXB0LgogKiBAcGFyYW0geyFFdmVudH0gZSBNb3VzZSBvciB0b3VjaCBldmVudC4KICovCkJsb2NrbHlBcHBzLnNob3dDb2RlID0gZnVuY3Rpb24oZSkgewogIHZhciBvcmlnaW4gPSBlLnRhcmdldDsKICB2YXIgY29kZSA9IEJsb2NrbHkuSmF2YVNjcmlwdC53b3Jrc3BhY2VUb0NvZGUoKTsKICBjb2RlID0gQmxvY2tseUFwcHMuc3RyaXBDb2RlKGNvZGUpOwogIHZhciBwcmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29udGFpbmVyQ29kZScpOwogIHByZS50ZXh0Q29udGVudCA9IGNvZGU7CiAgaWYgKHR5cGVvZiBwcmV0dHlQcmludE9uZSA9PSAnZnVuY3Rpb24nKSB7CiAgICBjb2RlID0gcHJlLmlubmVySFRNTDsKICAgIGNvZGUgPSBwcmV0dHlQcmludE9uZShjb2RlLCAnanMnKTsKICAgIHByZS5pbm5lckhUTUwgPSBjb2RlOwogIH0KCiAgdmFyIGNvbnRlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGlhbG9nQ29kZScpOwogIHZhciBzdHlsZSA9IHsKICAgIHdpZHRoOiAnNDAlJywKICAgIGxlZnQ6ICczMCUnLAogICAgdG9wOiAnNWVtJwogIH07CiAgQmxvY2tseUFwcHMuc2hvd0RpYWxvZyhjb250ZW50LCBvcmlnaW4sIHRydWUsIHRydWUsIHN0eWxlLAogICAgICBCbG9ja2x5QXBwcy5zdG9wRGlhbG9nS2V5RG93bik7CiAgQmxvY2tseUFwcHMuc3RhcnREaWFsb2dLZXlEb3duKCk7Cn07CgovKioKICogSWYgdGhlIHVzZXIgcHJlc2VzIGVudGVyLCBlc2NhcGUsIG9yIHNwYWNlLCBoaWRlIHRoZSBkaWFsb2cuCiAqIEBwYXJhbSB7IUV2ZW50fSBlIEtleWJvYXJkIGV2ZW50LgogKiBAcHJpdmF0ZQogKi8KQmxvY2tseUFwcHMuZGlhbG9nS2V5RG93bl8gPSBmdW5jdGlvbihlKSB7CiAgaWYgKEJsb2NrbHlBcHBzLmlzRGlhbG9nVmlzaWJsZV8pIHsKICAgIGlmIChlLmtleUNvZGUgPT0gMTMgfHwKICAgICAgICBlLmtleUNvZGUgPT0gMjcgfHwKICAgICAgICBlLmtleUNvZGUgPT0gMzIpIHsKICAgICAgQmxvY2tseUFwcHMuaGlkZURpYWxvZyh0cnVlKTsKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgfQogIH0KfTsKCi8qKgogKiBTdGFydCBsaXN0ZW5pbmcgZm9yIEJsb2NrbHlBcHBzLmRpYWxvZ0tleURvd25fLgogKi8KQmxvY2tseUFwcHMuc3RhcnREaWFsb2dLZXlEb3duID0gZnVuY3Rpb24oKSB7CiAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywKICAgICAgQmxvY2tseUFwcHMuZGlhbG9nS2V5RG93bl8sIHRydWUpOwp9OwoKLyoqCiAqIFN0b3AgbGlzdGVuaW5nIGZvciBCbG9ja2x5QXBwcy5kaWFsb2dLZXlEb3duXy4KICovCkJsb2NrbHlBcHBzLnN0b3BEaWFsb2dLZXlEb3duID0gZnVuY3Rpb24oKSB7CiAgZG9jdW1lbnQuYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywKICAgICAgQmxvY2tseUFwcHMuZGlhbG9nS2V5RG93bl8sIHRydWUpOwp9OwoKLyoqCiAqIEdldHMgdGhlIG1lc3NhZ2Ugd2l0aCB0aGUgZ2l2ZW4ga2V5IGZyb20gdGhlIGRvY3VtZW50LgogKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIGRvY3VtZW50IGVsZW1lbnQuCiAqIEByZXR1cm4ge3N0cmluZ30gVGhlIHRleHRDb250ZW50IG9mIHRoZSBzcGVjaWZpZWQgZWxlbWVudCwKICogICAgIG9yIGFuIGVycm9yIG1lc3NhZ2UgaWYgdGhlIGVsZW1lbnQgd2FzIG5vdCBmb3VuZC4KICovCkJsb2NrbHlBcHBzLmdldE1zZyA9IGZ1bmN0aW9uKGtleSkgewogIHZhciBtc2cgPSBCbG9ja2x5QXBwcy5nZXRNc2dPck51bGwoa2V5KTsKICByZXR1cm4gbXNnID09PSBudWxsID8gJ1tVbmtub3duIG1lc3NhZ2U6ICcgKyBrZXkgKyAnXScgOiBtc2c7Cn07CgovKioKICogR2V0cyB0aGUgbWVzc2FnZSB3aXRoIHRoZSBnaXZlbiBrZXkgZnJvbSB0aGUgZG9jdW1lbnQuCiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgZG9jdW1lbnQgZWxlbWVudC4KICogQHJldHVybiB7c3RyaW5nfSBUaGUgdGV4dENvbnRlbnQgb2YgdGhlIHNwZWNpZmllZCBlbGVtZW50LAogKiAgICAgb3IgbnVsbCBpZiB0aGUgZWxlbWVudCB3YXMgbm90IGZvdW5kLgogKi8KQmxvY2tseUFwcHMuZ2V0TXNnT3JOdWxsID0gZnVuY3Rpb24oa2V5KSB7CiAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChrZXkpOwogIGlmIChlbGVtZW50KSB7CiAgICB2YXIgdGV4dCA9IGVsZW1lbnQudGV4dENvbnRlbnQ7CiAgICAvLyBDb252ZXJ0IG5ld2xpbmUgc2VxdWVuY2VzLgogICAgdGV4dCA9IHRleHQucmVwbGFjZSgvXFxuL2csICdcbicpOwogICAgcmV0dXJuIHRleHQ7CiAgfSBlbHNlIHsKICAgIHJldHVybiBudWxsOwogIH0KfTsKCi8qKgogKiBCaW5kIGEgZnVuY3Rpb24gdG8gYSBidXR0b24ncyBjbGljayBldmVudC4KICogT24gdG91Y2ggZW5hYmxlZCBicm93c2Vycywgb250b3VjaGVuZCBpcyB0cmVhdGVkIGFzIGVxdWl2YWxlbnQgdG8gb25jbGljay4KICogQHBhcmFtIHshRWxlbWVudHxzdHJpbmd9IGVsIEJ1dHRvbiBlbGVtZW50IG9yIElEIHRoZXJlb2YuCiAqIEBwYXJhbSB7IUZ1bmN0aW9ufSBmdW5jIEV2ZW50IGhhbmRsZXIgdG8gYmluZC4KICovCkJsb2NrbHlBcHBzLmJpbmRDbGljayA9IGZ1bmN0aW9uKGVsLCBmdW5jKSB7CiAgaWYgKHR5cGVvZiBlbCA9PSAnc3RyaW5nJykgewogICAgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbCk7CiAgfQogIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuYywgdHJ1ZSk7CiAgZWwuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBmdW5jLCB0cnVlKTsKfTsKCi8qKgogKiBMb2FkIHRoZSBQcmV0dGlmeSBDU1MgYW5kIEphdmFTY3JpcHQuCiAqLwpCbG9ja2x5QXBwcy5pbXBvcnRQcmV0dGlmeSA9IGZ1bmN0aW9uKCkgewogIC8vPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiB0eXBlPSJ0ZXh0L2NzcyIgaHJlZj0iLi4vcHJldHRpZnkuY3NzIj4KICAvLzxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0IiBzcmM9Ii4uL3ByZXR0aWZ5LmpzIj48L3NjcmlwdD4KICB2YXIgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKTsKICBsaW5rLnNldEF0dHJpYnV0ZSgncmVsJywgJ3N0eWxlc2hlZXQnKTsKICBsaW5rLnNldEF0dHJpYnV0ZSgndHlwZScsICd0ZXh0L2NzcycpOwogIGxpbmsuc2V0QXR0cmlidXRlKCdocmVmJywgJy4uL3ByZXR0aWZ5LmNzcycpOwogIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobGluayk7CiAgdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwogIHNjcmlwdC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7CiAgc2NyaXB0LnNldEF0dHJpYnV0ZSgnc3JjJywgJy4uL3ByZXR0aWZ5LmpzJyk7CiAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwp9Owo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 12:52:10 GMT",
                    "Content-Length": "26981",
                    "Date": "Thu, 06 Nov 2014 12:52:16 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}