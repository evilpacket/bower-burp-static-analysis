{
    "url": "http://localhost:9999/Constellation/escodegen/test/3rdparty/jquery.mobile-1.0.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location.pathname</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>base[ 0 ].href = href || location.pathname;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/Constellation/escodegen/test/3rdparty/jquery.mobile-1.0.js",
                "path": "/Constellation/escodegen/test/3rdparty/jquery.mobile-1.0.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9Db25zdGVsbGF0aW9uL2VzY29kZWdlbi90ZXN0LzNyZHBhcnR5L2pxdWVyeS5tb2JpbGUtMS4wLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjE0ODI5DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDIzOjI0OjAxIEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAyMzoyNDowMSBHTVQNCg0KLyoKKiBqUXVlcnkgTW9iaWxlIEZyYW1ld29yayAxLjAKKiBodHRwOi8vanF1ZXJ5bW9iaWxlLmNvbQoqCiogQ29weXJpZ2h0IDIwMTEgKGMpIGpRdWVyeSBQcm9qZWN0CiogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IEBWRVJTSU9OCiAqCiAqIENvcHlyaWdodCAyMDEwLCBBVVRIT1JTLnR4dCAoaHR0cDovL2pxdWVyeXVpLmNvbS9hYm91dCkKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2RvY3MuanF1ZXJ5LmNvbS9VSS9XaWRnZXQKICovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIGpRdWVyeSAxLjQrCmlmICggJC5jbGVhbkRhdGEgKSB7Cgl2YXIgX2NsZWFuRGF0YSA9ICQuY2xlYW5EYXRhOwoJJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7CgkJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCSQoIGVsZW0gKS50cmlnZ2VySGFuZGxlciggInJlbW92ZSIgKTsKCQl9CgkJX2NsZWFuRGF0YSggZWxlbXMgKTsKCX07Cn0gZWxzZSB7Cgl2YXIgX3JlbW92ZSA9ICQuZm4ucmVtb3ZlOwoJJC5mbi5yZW1vdmUgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGtlZXBEYXRhICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggIWtlZXBEYXRhICkgewoJCQkJaWYgKCAhc2VsZWN0b3IgfHwgJC5maWx0ZXIoIHNlbGVjdG9yLCBbIHRoaXMgXSApLmxlbmd0aCApIHsKCQkJCQkkKCAiKiIsIHRoaXMgKS5hZGQoIFsgdGhpcyBdICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkJJCggdGhpcyApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJCXJldHVybiBfcmVtb3ZlLmNhbGwoICQodGhpcyksIHNlbGVjdG9yLCBrZWVwRGF0YSApOwoJCX0pOwoJfTsKfQoKJC53aWRnZXQgPSBmdW5jdGlvbiggbmFtZSwgYmFzZSwgcHJvdG90eXBlICkgewoJdmFyIG5hbWVzcGFjZSA9IG5hbWUuc3BsaXQoICIuIiApWyAwIF0sCgkJZnVsbE5hbWU7CgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsKCWZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJLy8gY3JlYXRlIHNlbGVjdG9yIGZvciBwbHVnaW4KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG5hbWUgKTsKCX07CgoJJFsgbmFtZXNwYWNlIF0gPSAkWyBuYW1lc3BhY2UgXSB8fCB7fTsKCSRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXRoaXMuX2NyZWF0ZVdpZGdldCggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCX07CgoJdmFyIGJhc2VQcm90b3R5cGUgPSBuZXcgYmFzZSgpOwoJLy8gd2UgbmVlZCB0byBtYWtlIHRoZSBvcHRpb25zIGhhc2ggYSBwcm9wZXJ0eSBkaXJlY3RseSBvbiB0aGUgbmV3IGluc3RhbmNlCgkvLyBvdGhlcndpc2Ugd2UnbGwgbW9kaWZ5IHRoZSBvcHRpb25zIGhhc2ggb24gdGhlIHByb3RvdHlwZSB0aGF0IHdlJ3JlCgkvLyBpbmhlcml0aW5nIGZyb20KLy8JJC5lYWNoKCBiYXNlUHJvdG90eXBlLCBmdW5jdGlvbigga2V5LCB2YWwgKSB7Ci8vCQlpZiAoICQuaXNQbGFpbk9iamVjdCh2YWwpICkgewovLwkJCWJhc2VQcm90b3R5cGVbIGtleSBdID0gJC5leHRlbmQoIHt9LCB2YWwgKTsKLy8JCX0KLy8JfSk7CgliYXNlUHJvdG90eXBlLm9wdGlvbnMgPSAkLmV4dGVuZCggdHJ1ZSwge30sIGJhc2VQcm90b3R5cGUub3B0aW9ucyApOwoJJFsgbmFtZXNwYWNlIF1bIG5hbWUgXS5wcm90b3R5cGUgPSAkLmV4dGVuZCggdHJ1ZSwgYmFzZVByb3RvdHlwZSwgewoJCW5hbWVzcGFjZTogbmFtZXNwYWNlLAoJCXdpZGdldE5hbWU6IG5hbWUsCgkJd2lkZ2V0RXZlbnRQcmVmaXg6ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0ucHJvdG90eXBlLndpZGdldEV2ZW50UHJlZml4IHx8IG5hbWUsCgkJd2lkZ2V0QmFzZUNsYXNzOiBmdWxsTmFtZQoJfSwgcHJvdG90eXBlICk7CgoJJC53aWRnZXQuYnJpZGdlKCBuYW1lLCAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdICk7Cn07CgokLndpZGdldC5icmlkZ2UgPSBmdW5jdGlvbiggbmFtZSwgb2JqZWN0ICkgewoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlzTWV0aG9kQ2FsbCA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiwKCQkJYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwKCQkJcmV0dXJuVmFsdWUgPSB0aGlzOwoKCQkvLyBhbGxvdyBtdWx0aXBsZSBoYXNoZXMgdG8gYmUgcGFzc2VkIG9uIGluaXQKCQlvcHRpb25zID0gIWlzTWV0aG9kQ2FsbCAmJiBhcmdzLmxlbmd0aCA/CgkJCSQuZXh0ZW5kLmFwcGx5KCBudWxsLCBbIHRydWUsIG9wdGlvbnMgXS5jb25jYXQoYXJncykgKSA6CgkJCW9wdGlvbnM7CgoJCS8vIHByZXZlbnQgY2FsbHMgdG8gaW50ZXJuYWwgbWV0aG9kcwoJCWlmICggaXNNZXRob2RDYWxsICYmIG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCX0KCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgbmFtZSApOwoJCQkJaWYgKCAhaW5zdGFuY2UgKSB7CgkJCQkJdGhyb3cgImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKyAiIHByaW9yIHRvIGluaXRpYWxpemF0aW9uOyAiICsKCQkJCQkJImF0dGVtcHRlZCB0byBjYWxsIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyI7CgkJCQl9CgkJCQlpZiAoICEkLmlzRnVuY3Rpb24oIGluc3RhbmNlW29wdGlvbnNdICkgKSB7CgkJCQkJdGhyb3cgIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIjsKCQkJCX0KCQkJCXZhciBtZXRob2RWYWx1ZSA9IGluc3RhbmNlWyBvcHRpb25zIF0uYXBwbHkoIGluc3RhbmNlLCBhcmdzICk7CgkJCQlpZiAoIG1ldGhvZFZhbHVlICE9PSBpbnN0YW5jZSAmJiBtZXRob2RWYWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVyblZhbHVlID0gbWV0aG9kVmFsdWU7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIG5hbWUgKTsKCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICkuX2luaXQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJJC5kYXRhKCB0aGlzLCBuYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCXRoaXMuX2NyZWF0ZVdpZGdldCggb3B0aW9ucywgZWxlbWVudCApOwoJfQp9OwoKJC5XaWRnZXQucHJvdG90eXBlID0gewoJd2lkZ2V0TmFtZTogIndpZGdldCIsCgl3aWRnZXRFdmVudFByZWZpeDogIiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlCgl9LAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJLy8gJC53aWRnZXQuYnJpZGdlIHN0b3JlcyB0aGUgcGx1Z2luIGluc3RhbmNlLCBidXQgd2UgZG8gaXQgYW55d2F5CgkJLy8gc28gdGhhdCBpdCdzIHN0b3JlZCBldmVuIGJlZm9yZSB0aGUgX2NyZWF0ZSBmdW5jdGlvbiBydW5zCgkJJC5kYXRhKCBlbGVtZW50LCB0aGlzLndpZGdldE5hbWUsIHRoaXMgKTsKCQl0aGlzLmVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJdGhpcy5vcHRpb25zID0gJC5leHRlbmQoIHRydWUsIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl2YXIgc2VsZiA9IHRoaXM7CgkJdGhpcy5lbGVtZW50LmJpbmQoICJyZW1vdmUuIiArIHRoaXMud2lkZ2V0TmFtZSwgZnVuY3Rpb24oKSB7CgkJCXNlbGYuZGVzdHJveSgpOwoJCX0pOwoKCQl0aGlzLl9jcmVhdGUoKTsKCQl0aGlzLl90cmlnZ2VyKCAiY3JlYXRlIiApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB7fTsKCQlpZiAoICQubWV0YWRhdGEgKSB7CgkJCW9wdGlvbnMgPSAkLm1ldGFkYXRhLmdldCggZWxlbWVudCApWyB0aGlzLndpZGdldE5hbWUgXTsKCQl9CgkJcmV0dXJuIG9wdGlvbnM7Cgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7fSwKCV9pbml0OiBmdW5jdGlvbigpIHt9LAoKCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudAoJCQkudW5iaW5kKCAiLiIgKyB0aGlzLndpZGdldE5hbWUgKQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXROYW1lICk7CgkJdGhpcy53aWRnZXQoKQoJCQkudW5iaW5kKCAiLiIgKyB0aGlzLndpZGdldE5hbWUgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRCYXNlQ2xhc3MgKyAiLWRpc2FibGVkICIgKwoJCQkJInVpLXN0YXRlLWRpc2FibGVkIiApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucyApOwoJCX0KCgkJaWYgICh0eXBlb2Yga2V5ID09PSAic3RyaW5nIiApIHsKCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF07CgkJCX0KCQkJb3B0aW9ucyA9IHt9OwoJCQlvcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCSQuZWFjaCggb3B0aW9ucywgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCXNlbGYuX3NldE9wdGlvbigga2V5LCB2YWx1ZSApOwoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzLndpZGdldCgpCgkJCQlbIHZhbHVlID8gImFkZENsYXNzIiA6ICJyZW1vdmVDbGFzcyJdKAoJCQkJCXRoaXMud2lkZ2V0QmFzZUNsYXNzICsgIi1kaXNhYmxlZCIgKyAiICIgKwoJCQkJCSJ1aS1zdGF0ZS1kaXNhYmxlZCIgKQoJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglfdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGV2ZW50LCBkYXRhICkgewoJCXZhciBjYWxsYmFjayA9IHRoaXMub3B0aW9uc1sgdHlwZSBdOwoKCQlldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CgkJZXZlbnQudHlwZSA9ICggdHlwZSA9PT0gdGhpcy53aWRnZXRFdmVudFByZWZpeCA/CgkJCXR5cGUgOgoJCQl0aGlzLndpZGdldEV2ZW50UHJlZml4ICsgdHlwZSApLnRvTG93ZXJDYXNlKCk7CgkJZGF0YSA9IGRhdGEgfHwge307CgoJCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQkvLyB0aGlzIHdvdWxkIGhhcHBlbiBpZiB3ZSBjb3VsZCBjYWxsICQuZXZlbnQuZml4IGluc3RlYWQgb2YgJC5FdmVudAoJCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCgkJaWYgKCBldmVudC5vcmlnaW5hbEV2ZW50ICkgewoJCQlmb3IgKCB2YXIgaSA9ICQuZXZlbnQucHJvcHMubGVuZ3RoLCBwcm9wOyBpOyApIHsKCQkJCXByb3AgPSAkLmV2ZW50LnByb3BzWyAtLWkgXTsKCQkJCWV2ZW50WyBwcm9wIF0gPSBldmVudC5vcmlnaW5hbEV2ZW50WyBwcm9wIF07CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoKCQlyZXR1cm4gISggJC5pc0Z1bmN0aW9uKGNhbGxiYWNrKSAmJgoJCQljYWxsYmFjay5jYWxsKCB0aGlzLmVsZW1lbnRbMF0sIGV2ZW50LCBkYXRhICkgPT09IGZhbHNlIHx8CgkJCWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7Ci8qCiogd2lkZ2V0IGZhY3RvcnkgZXh0ZW50aW9ucyBmb3IgbW9iaWxlCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLndpZGdldCIsIHsKCS8vIGRlY29yYXRlIHRoZSBwYXJlbnQgX2NyZWF0ZVdpZGdldCB0byB0cmlnZ2VyIGB3aWRnZXRpbml0YCBmb3IgdXNlcnMKCS8vIHdobyB3aXNoIHRvIGRvIHBvc3QgcG9zdCBgd2lkZ2V0Y3JlYXRlYCBhbHRlcmF0aW9ucy9hZGRpdGlvbnMKCS8vCgkvLyBUT0RPIGNyZWF0ZSBhIHB1bGwgcmVxdWVzdCBmb3IganF1ZXJ5IHVpIHRvIHRyaWdnZXIgdGhpcyBldmVudAoJLy8gaW4gdGhlIG9yaWdpbmFsIF9jcmVhdGVXaWRnZXQKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fY3JlYXRlV2lkZ2V0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl90cmlnZ2VyKCAnaW5pdCcgKTsKCX0sCgoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0aW9ucyA9IHt9OwoKCQkkLmVhY2goIHRoaXMub3B0aW9ucywgZnVuY3Rpb24oIG9wdGlvbiApIHsKCgkJCXZhciB2YWx1ZSA9IGVsZW0uanFtRGF0YSggb3B0aW9uLnJlcGxhY2UoIC9bQS1aXS9nLCBmdW5jdGlvbiggYyApIHsKCQkJCQkJCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7CgkJCQkJCX0pCgkJCQkJKTsKCgkJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCW9wdGlvbnNbIG9wdGlvbiBdID0gdmFsdWU7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIG9wdGlvbnM7Cgl9LAoKCWVuaGFuY2VXaXRoaW46IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkJLy8gVE9ETyByZW1vdmUgZGVwZW5kZW5jeSBvbiB0aGUgcGFnZSB3aWRnZXQgZm9yIHRoZSBrZWVwTmF0aXZlLgoJCS8vIEN1cnJlbnRseSB0aGUga2VlcE5hdGl2ZSB2YWx1ZSBpcyBkZWZpbmVkIG9uIHRoZSBwYWdlIHByb3RvdHlwZSBzbwoJCS8vIHRoZSBtZXRob2QgaXMgYXMgd2VsbAoJCXZhciBwYWdlID0gJCh0YXJnZXQpLmNsb3Nlc3QoIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIpLmRhdGEoICJwYWdlIiApLAoJCQlrZWVwTmF0aXZlID0gKHBhZ2UgJiYgcGFnZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSkgfHwgIiI7CgoJCSQoIHRoaXMub3B0aW9ucy5pbml0U2VsZWN0b3IsIHRhcmdldCApLm5vdCgga2VlcE5hdGl2ZSApWyB0aGlzLndpZGdldE5hbWUgXSgpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiBhIHdvcmthcm91bmQgZm9yIHdpbmRvdy5tYXRjaE1lZGlhCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciAkd2luZG93ID0gJCggd2luZG93ICksCgkkaHRtbCA9ICQoICJodG1sIiApOwoKLyogJC5tb2JpbGUubWVkaWEgbWV0aG9kOiBwYXNzIGEgQ1NTIG1lZGlhIHR5cGUgb3IgcXVlcnkgYW5kIGdldCBhIGJvb2wgcmV0dXJuCglub3RlOiB0aGlzIGZlYXR1cmUgcmVsaWVzIG9uIGFjdHVhbCBtZWRpYSBxdWVyeSBzdXBwb3J0IGZvciBtZWRpYSBxdWVyaWVzLCB0aG91Z2ggdHlwZXMgd2lsbCB3b3JrIG1vc3QgYW55d2hlcmUKCWV4YW1wbGVzOgoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4nKSAvLz4+IHRlc3RzIGZvciBzY3JlZW4gbWVkaWEgdHlwZQoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4gYW5kIChtaW4td2lkdGg6IDQ4MHB4KScpIC8vPj4gdGVzdHMgZm9yIHNjcmVlbiBtZWRpYSB0eXBlIHdpdGggd2luZG93IHdpZHRoID4gNDgwcHgKCQkkLm1vYmlsZS5tZWRpYSgnQG1lZGlhIHNjcmVlbiBhbmQgKC13ZWJraXQtbWluLWRldmljZS1waXhlbC1yYXRpbzogMiknKSAvLz4+IHRlc3RzIGZvciB3ZWJraXQgMnggcGl4ZWwgcmF0aW8gKGlQaG9uZSA0KQoqLwokLm1vYmlsZS5tZWRpYSA9IChmdW5jdGlvbigpIHsKCS8vIFRPRE86IHVzZSB3aW5kb3cubWF0Y2hNZWRpYSBvbmNlIGF0IGxlYXN0IG9uZSBVQSBpbXBsZW1lbnRzIGl0Cgl2YXIgY2FjaGUgPSB7fSwKCQl0ZXN0RGl2ID0gJCggIjxkaXYgaWQ9J2pxdWVyeS1tZWRpYXRlc3QnPiIgKSwKCQlmYWtlQm9keSA9ICQoICI8Ym9keT4iICkuYXBwZW5kKCB0ZXN0RGl2ICk7CgoJcmV0dXJuIGZ1bmN0aW9uKCBxdWVyeSApIHsKCQlpZiAoICEoIHF1ZXJ5IGluIGNhY2hlICkgKSB7CgkJCXZhciBzdHlsZUJsb2NrID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInN0eWxlIiApLAoJCQkJY3NzcnVsZSA9ICJAbWVkaWEgIiArIHF1ZXJ5ICsgIiB7ICNqcXVlcnktbWVkaWF0ZXN0IHsgcG9zaXRpb246YWJzb2x1dGU7IH0gfSI7CgoJCQkvL211c3Qgc2V0IHR5cGUgZm9yIElFIQoJCQlzdHlsZUJsb2NrLnR5cGUgPSAidGV4dC9jc3MiOwoKCQkJaWYgKCBzdHlsZUJsb2NrLnN0eWxlU2hlZXQgICl7CgkJCQlzdHlsZUJsb2NrLnN0eWxlU2hlZXQuY3NzVGV4dCA9IGNzc3J1bGU7CgkJCX0gZWxzZSB7CgkJCQlzdHlsZUJsb2NrLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjc3NydWxlKSApOwoJCQl9CgoJCQkkaHRtbC5wcmVwZW5kKCBmYWtlQm9keSApLnByZXBlbmQoIHN0eWxlQmxvY2sgKTsKCQkJY2FjaGVbIHF1ZXJ5IF0gPSB0ZXN0RGl2LmNzcyggInBvc2l0aW9uIiApID09PSAiYWJzb2x1dGUiOwoJCQlmYWtlQm9keS5hZGQoIHN0eWxlQmxvY2sgKS5yZW1vdmUoKTsKCQl9CgkJcmV0dXJuIGNhY2hlWyBxdWVyeSBdOwoJfTsKfSkoKTsKCn0pKGpRdWVyeSk7Ci8qCiogc3VwcG9ydCB0ZXN0cwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5OyAvL29ubHkgdXNlZCB0byBydWxlIG91dCBib3ggc2hhZG93LCBhcyBpdCdzIGZpbGxlZCBvcGFxdWUgb24gQkIKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKTsKCglmb3IgKCB2YXIgdiBpbiBwcm9wcyApewoJCWlmICggZmJDU1NbIHByb3BzWyB2IF0gXSAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKCi8vIG5vbi1VQS1iYXNlZCBJRSB2ZXJzaW9uIGNoZWNrIGJ5IEphbWVzIFBhZG9sc2V5LCBtb2RpZmllZCBieSBqZGFsdG9uIC0gZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzUyNzY4MwovLyBhbGxvd3MgZm9yIGluY2x1c2lvbiBvZiBJRSA2KywgaW5jbHVkaW5nIFdpbmRvd3MgTW9iaWxlIDcKJC5tb2JpbGUuYnJvd3NlciA9IHt9OwokLm1vYmlsZS5icm93c2VyLmllID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCWEgPSBkaXYuYWxsIHx8IFtdOwoKCXdoaWxlICggZGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGd0IElFICIgKyAoICsrdiApICsgIl0+PGJyPjwhW2VuZGlmXS0tPiIsIGFbIDAgXSApOwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCgokLmV4dGVuZCggJC5zdXBwb3J0LCB7CglvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiBpbiB3aW5kb3cgJiYgIm9ub3JpZW50YXRpb25jaGFuZ2UiIGluIHdpbmRvdywKCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQsCgljc3NUcmFuc2l0aW9uczogIldlYktpdFRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93LAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmICJyZXBsYWNlU3RhdGUiIGluIGhpc3RvcnksCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJYm94U2hhZG93OiAhIXByb3BFeGlzdHMoICJib3hTaGFkb3ciICkgJiYgIWJiLAoJc2Nyb2xsVG9wOiAoICJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8ICJzY3JvbGxUb3AiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fCAic2Nyb2xsVG9wIiBpbiBmYWtlQm9keVsgMCBdICkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCglkeW5hbWljQmFzZVRhZzogYmFzZVRhZ1Rlc3QoKQp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKdmFyIG5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCl7CgoJdmFyIHVhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7CgoJLy9UaGUgZm9sbG93aW5nIGlzIGFuIGF0dGVtcHQgdG8gbWF0Y2ggTm9raWEgYnJvd3NlcnMgdGhhdCBhcmUgcnVubmluZyBTeW1iaWFuL3M2MCwgd2l0aCB3ZWJraXQsIHZlcnNpb24gNy4zIG9yIG9sZGVyCglyZXR1cm4gdWEuaW5kZXhPZiggIk5va2lhIiApID4gLTEgJiYKCQkJKCB1YS5pbmRleE9mKCAiU3ltYmlhbi8zIiApID4gLTEgfHwgdWEuaW5kZXhPZiggIlNlcmllczYwLzUiICkgPiAtMSApICYmCgkJCXVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICYmCgkJCXVhLm1hdGNoKCAvKEJyb3dzZXJOR3xOb2tpYUJyb3dzZXIpXC83XC5bMC0zXS8gKTsKfSkoKTsKCiQubW9iaWxlLmFqYXhCbGFja2xpc3QgPQoJCQkvLyBCbGFja0JlcnJ5IGJyb3dzZXJzLCBwcmUtd2Via2l0CgkJCXdpbmRvdy5ibGFja2JlcnJ5ICYmICF3aW5kb3cuV2ViS2l0UG9pbnQgfHwKCQkJLy8gT3BlcmEgTWluaQoJCQlvcGVyYW1pbmkgfHwKCQkJLy8gU3ltYmlhbiB3ZWJraXRzIHByZSA3LjMKCQkJbm9raWFMVEU3XzM7CgovLyBMYXN0bHksIHRoaXMgd29ya2Fyb3VuZCBpcyB0aGUgb25seSB3YXkgd2UndmUgZm91bmQgc28gZmFyIHRvIGdldCBwcmUgNy4zIFN5bWJpYW4gd2Via2l0IGRldmljZXMKLy8gdG8gcmVuZGVyIHRoZSBzdHlsZXNoZWV0cyB3aGVuIHRoZXkncmUgcmVmZXJlbmNlZCBiZWZvcmUgdGhpcyBzY3JpcHQsIGFzIHdlJ2QgcmVjb21tZW5kIGRvaW5nLgovLyBUaGlzIHNpbXBseSByZWFwcGVuZHMgdGhlIENTUyBpbiBwbGFjZSwgd2hpY2ggZm9yIHNvbWUgcmVhc29uIG1ha2VzIGl0IGFwcGx5CmlmICggbm9raWFMVEU3XzMgKSB7CgkkKGZ1bmN0aW9uKCkgewoJCSQoICJoZWFkIGxpbmtbcmVsPSdzdHlsZXNoZWV0J10iICkuYXR0ciggInJlbCIsICJhbHRlcm5hdGUgc3R5bGVzaGVldCIgKS5hdHRyKCAicmVsIiwgInN0eWxlc2hlZXQiICk7Cgl9KTsKfQoKLy8gRm9yIHJ1bGluZyBvdXQgc2hhZG93cyB2aWEgY3NzCmlmICggISQuc3VwcG9ydC5ib3hTaGFkb3cgKSB7CgkkKCAiaHRtbCIgKS5hZGRDbGFzcyggInVpLW1vYmlsZS1ub3N1cHBvcnQtYm94c2hhZG93IiApOwp9Cgp9KSggalF1ZXJ5ICk7Ci8qCiogIm1vdXNlIiBwbHVnaW4KKi8KCi8vIFRoaXMgcGx1Z2luIGlzIGFuIGV4cGVyaW1lbnQgZm9yIGFic3RyYWN0aW5nIGF3YXkgdGhlIHRvdWNoIGFuZCBtb3VzZQovLyBldmVudHMgc28gdGhhdCBkZXZlbG9wZXJzIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgd2hpY2ggbWV0aG9kIG9mIGlucHV0Ci8vIHRoZSBkZXZpY2UgdGhlaXIgZG9jdW1lbnQgaXMgbG9hZGVkIG9uIHN1cHBvcnRzLgovLwovLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGFsbG93IHRoZSBkZXZlbG9wZXIgdG8gcmVnaXN0ZXIgbGlzdGVuZXJzIGZvciB0aGUKLy8gYmFzaWMgbW91c2UgZXZlbnRzLCBzdWNoIGFzIG1vdXNlZG93biwgbW91c2Vtb3ZlLCBtb3VzZXVwLCBhbmQgY2xpY2ssCi8vIGFuZCB0aGUgcGx1Z2luIHdpbGwgdGFrZSBjYXJlIG9mIHJlZ2lzdGVyaW5nIHRoZSBjb3JyZWN0IGxpc3RlbmVycwovLyBiZWhpbmQgdGhlIHNjZW5lcyB0byBpbnZva2UgdGhlIGxpc3RlbmVyIGF0IHRoZSBmYXN0ZXN0IHBvc3NpYmxlIHRpbWUKLy8gZm9yIHRoYXQgZGV2aWNlLCB3aGlsZSBzdGlsbCByZXRhaW5pbmcgdGhlIG9yZGVyIG9mIGV2ZW50IGZpcmluZyBpbgovLyB0aGUgdHJhZGl0aW9uYWwgbW91c2UgZW52aXJvbm1lbnQsIHNob3VsZCBtdWx0aXBsZSBoYW5kbGVycyBiZSByZWdpc3RlcmVkCi8vIG9uIHRoZSBzYW1lIGVsZW1lbnQgZm9yIGRpZmZlcmVudCBldmVudHMuCi8vCi8vIFRoZSBjdXJyZW50IHZlcnNpb24gZXhwb3NlcyB0aGUgZm9sbG93aW5nIHZpcnR1YWwgZXZlbnRzIHRvIGpRdWVyeSBiaW5kIG1ldGhvZHM6Ci8vICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIKCihmdW5jdGlvbiggJCwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewoKdmFyIGRhdGFQcm9wZXJ0eU5hbWUgPSAidmlydHVhbE1vdXNlQmluZGluZ3MiLAoJdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgPSAidmlydHVhbFRvdWNoSUQiLAoJdmlydHVhbEV2ZW50TmFtZXMgPSAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiLnNwbGl0KCAiICIgKSwKCXRvdWNoRXZlbnRQcm9wcyA9ICJjbGllbnRYIGNsaWVudFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIi5zcGxpdCggIiAiICksCglhY3RpdmVEb2NIYW5kbGVycyA9IHt9LAoJcmVzZXRUaW1lcklEID0gMCwKCXN0YXJ0WCA9IDAsCglzdGFydFkgPSAwLAoJZGlkU2Nyb2xsID0gZmFsc2UsCgljbGlja0Jsb2NrTGlzdCA9IFtdLAoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2UsCglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZSwKCWV2ZW50Q2FwdHVyZVN1cHBvcnRlZCA9ICJhZGRFdmVudExpc3RlbmVyIiBpbiBkb2N1bWVudCwKCSRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICksCgluZXh0VG91Y2hJRCA9IDEsCglsYXN0VG91Y2hJRCA9IDA7CgokLnZtb3VzZSA9IHsKCW1vdmVEaXN0YW5jZVRocmVzaG9sZDogMTAsCgljbGlja0Rpc3RhbmNlVGhyZXNob2xkOiAxMCwKCXJlc2V0VGltZXJEdXJhdGlvbjogMTUwMAp9OwoKZnVuY3Rpb24gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkgewoKCXdoaWxlICggZXZlbnQgJiYgdHlwZW9mIGV2ZW50Lm9yaWdpbmFsRXZlbnQgIT09ICJ1bmRlZmluZWQiICkgewoJCWV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCX0KCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICkgewoKCXZhciB0ID0gZXZlbnQudHlwZSwKCQlvZSwgcHJvcHMsIG5lLCBwcm9wLCBjdCwgdG91Y2gsIGksIGo7CgoJZXZlbnQgPSAkLkV2ZW50KGV2ZW50KTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgoJb2UgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJcHJvcHMgPSAkLmV2ZW50LnByb3BzOwoKCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkvLyBidXQgd2UgZG9uJ3QgaGF2ZSBhIHdheSB0byBmb3JjZSBhbiBldmVudCB0byBiZSBmaXhlZCBtdWx0aXBsZSB0aW1lcwoJaWYgKCBvZSApIHsKCQlmb3IgKCBpID0gcHJvcHMubGVuZ3RoLCBwcm9wOyBpOyApIHsKCQkJcHJvcCA9IHByb3BzWyAtLWkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9lWyBwcm9wIF07CgkJfQoJfQoKCS8vIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZSBtb3VzZSBhbmQgY2xpY2sgdmlydHVhbCBldmVudHMgYXJlIGdlbmVyYXRlZAoJLy8gd2l0aG91dCBhIC53aGljaCBvbmUgaXMgZGVmaW5lZAoJaWYgKCB0LnNlYXJjaCgvbW91c2UoZG93bnx1cCl8Y2xpY2svKSA+IC0xICYmICFldmVudC53aGljaCApewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoY3QgJiYgY3QubGVuZ3RoKSA/IGN0WyAwIF0gOiB1bmRlZmluZWQgKTsKCgkJaWYgKCB0b3VjaCApIHsKCQkJZm9yICggaiA9IDAsIGxlbiA9IHRvdWNoRXZlbnRQcm9wcy5sZW5ndGg7IGogPCBsZW47IGorKyl7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkJcmVzZXRUaW1lcklEID0gMDsKCQllbmFibGVNb3VzZUJpbmRpbmdzKCk7Cgl9LCAkLnZtb3VzZS5yZXNldFRpbWVyRHVyYXRpb24gKTsKfQoKZnVuY3Rpb24gY2xlYXJSZXNldFRpbWVyKCkgewoJaWYgKCByZXNldFRpbWVySUQgKXsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKGV2ZW50LnRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUpOwoKCWlmICggIWJsb2NrTW91c2VUcmlnZ2VycyAmJiAoICFsYXN0VG91Y2hJRCB8fCBsYXN0VG91Y2hJRCAhPT0gdG91Y2hJRCApICl7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInYiICsgZXZlbnQudHlwZSwgZXZlbnQgKTsKCQlpZiAoIHZlICkgewoJCQlpZiAoIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCQlpZiAoIHZlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCQlpZiAoIHZlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydCggZXZlbnQgKSB7CgoJdmFyIHRvdWNoZXMgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzLAoJCXRhcmdldCwgZmxhZ3M7CgoJaWYgKCB0b3VjaGVzICYmIHRvdWNoZXMubGVuZ3RoID09PSAxICkgewoKCQl0YXJnZXQgPSBldmVudC50YXJnZXQ7CgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCB0YXJnZXQgKTsKCgkJaWYgKCBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyApIHsKCgkJCWxhc3RUb3VjaElEID0gbmV4dFRvdWNoSUQrKzsKCQkJJC5kYXRhKCB0YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lLCBsYXN0VG91Y2hJRCApOwoKCQkJY2xlYXJSZXNldFRpbWVyKCk7CgoJCQlkaXNhYmxlTW91c2VCaW5kaW5ncygpOwoJCQlkaWRTY3JvbGwgPSBmYWxzZTsKCgkJCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdOwoJCQlzdGFydFggPSB0LnBhZ2VYOwoJCQlzdGFydFkgPSB0LnBhZ2VZOwoKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW92ZXIiLCBldmVudCwgZmxhZ3MgKTsKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWRvd24iLCBldmVudCwgZmxhZ3MgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVNjcm9sbCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICkgKTsKCX0KCglkaWRTY3JvbGwgPSB0cnVlOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF0sCgkJZGlkQ2FuY2VsID0gZGlkU2Nyb2xsLAoJCW1vdmVUaHJlc2hvbGQgPSAkLnZtb3VzZS5tb3ZlRGlzdGFuY2VUaHJlc2hvbGQ7CgkJZGlkU2Nyb2xsID0gZGlkU2Nyb2xsIHx8CgkJCSggTWF0aC5hYnModC5wYWdlWCAtIHN0YXJ0WCkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyh0LnBhZ2VZIC0gc3RhcnRZKSA+IG1vdmVUaHJlc2hvbGQgKSwKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApOwoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdDsKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2V1cCIsIGV2ZW50LCBmbGFncyApOwoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpe30KCmZ1bmN0aW9uIGdldFNwZWNpYWxFdmVudE9iamVjdCggZXZlbnRUeXBlICkgewoJdmFyIHJlYWxUeXBlID0gZXZlbnRUeXBlLnN1YnN0ciggMSApOwoKCXJldHVybiB7CgkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhpcyBlbGVtZW50LAoJCQkvLyBhZGQgYSBiaW5kaW5ncyBvYmplY3QgdG8gaXRzIGRhdGEuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSwge30pOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmIChhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPT09IDEpIHsKCQkJCQkkZG9jdW1lbnQuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCgkJCQkJCS8vIE9uIHRvdWNoIHBsYXRmb3JtcywgdG91Y2hpbmcgdGhlIHNjcmVlbiBhbmQgdGhlbiBkcmFnZ2luZyB5b3VyIGZpbmdlcgoJCQkJCQkvLyBjYXVzZXMgdGhlIHdpbmRvdyBjb250ZW50IHRvIHNjcm9sbCBhZnRlciBzb21lIGRpc3RhbmNlIHRocmVzaG9sZCBpcwoJCQkJCQkvLyBleGNlZWRlZC4gT24gdGhlc2UgcGxhdGZvcm1zLCBhIHNjcm9sbCBwcmV2ZW50cyBhIGNsaWNrIGV2ZW50IGZyb20gYmVpbmcKCQkJCQkJLy8gZGlzcGF0Y2hlZCwgYW5kIG9uIHNvbWUgcGxhdGZvcm1zLCBldmVuIHRoZSB0b3VjaGVuZCBpcyBzdXBwcmVzc2VkLiBUbwoJCQkJCQkvLyBtaW1pYyB0aGUgc3VwcHJlc3Npb24gb2YgdGhlIGNsaWNrIGV2ZW50LCB3ZSBuZWVkIHRvIHdhdGNoIGZvciBhIHNjcm9sbAoJCQkJCQkvLyBldmVudC4gVW5mb3J0dW5hdGVseSwgc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MgZG9uJ3QgZGlzcGF0Y2ggc2Nyb2xsCgkJCQkJCS8vIGV2ZW50cyB1bnRpbCAqQUZURVIqIHRoZSB1c2VyIGxpZnRzIHRoZWlyIGZpbmdlciAodG91Y2hlbmQpLiBUaGlzIG1lYW5zCgkJCQkJCS8vIHdlIG5lZWQgdG8gd2F0Y2ggYm90aCBzY3JvbGwgYW5kIHRvdWNobW92ZSBldmVudHMgdG8gZmlndXJlIG91dCB3aGV0aGVyCgkJCQkJCS8vIG9yIG5vdCBhIHNjcm9sbCBoYXBwZW5lbnMgYmVmb3JlIHRoZSB0b3VjaGVuZCBldmVudCBpcyBmaXJlZC4KCgkJCQkJCS5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCB2YXIgaSA9IDA7IGkgPCB2aXJ0dWFsRXZlbnROYW1lcy5sZW5ndGg7IGkrKyApewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApewoJCXZhciBjbnQgPSBjbGlja0Jsb2NrTGlzdC5sZW5ndGgsCgkJCXRhcmdldCA9IGUudGFyZ2V0LAoJCQl4LCB5LCBlbGUsIGksIG8sIHRvdWNoSUQ7CgoJCWlmICggY250ICkgewoJCQl4ID0gZS5jbGllbnRYOwoJCQl5ID0gZS5jbGllbnRZOwoJCQl0aHJlc2hvbGQgPSAkLnZtb3VzZS5jbGlja0Rpc3RhbmNlVGhyZXNob2xkOwoKCQkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBydW4gdGhyb3VnaCB0aGUgY2xpY2tCbG9ja0xpc3QgdG8gc2VlIGlmCgkJCS8vIHRoZSBjdXJyZW50IGNsaWNrIGV2ZW50IGlzIGluIHRoZSBwcm94aW1pdHkgb2Ygb25lIG9mIG91cgoJCQkvLyB2Y2xpY2sgZXZlbnRzIHRoYXQgaGFkIHByZXZlbnREZWZhdWx0KCkgY2FsbGVkIG9uIGl0LiBJZiB3ZSBmaW5kCgkJCS8vIG9uZSwgdGhlbiB3ZSBibG9jayB0aGUgY2xpY2suCgkJCS8vCgkJCS8vIFdoeSBkbyB3ZSBoYXZlIHRvIHJlbHkgb24gcHJveGltaXR5PwoJCQkvLwoJCQkvLyBCZWNhdXNlIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoIGV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoZSB2Y2xpY2sKCQkJLy8gY2FuIGJlIGRpZmZlcmVudCBmcm9tIHRoZSB0YXJnZXQgb2YgdGhlIGNsaWNrIGV2ZW50IHN5bnRoZXNpemVkCgkJCS8vIGJ5IHRoZSBicm93c2VyLiBUaGUgdGFyZ2V0IG9mIGEgbW91c2UvY2xpY2sgZXZlbnQgdGhhdCBpcyBzeW50ZWhzaXplZAoJCQkvLyBmcm9tIGEgdG91Y2ggZXZlbnQgc2VlbXMgdG8gYmUgaW1wbGVtZW50YXRpb24gc3BlY2lmaWMuIEZvciBleGFtcGxlLAoJCQkvLyBzb21lIGJyb3dzZXJzIHdpbGwgZmlyZSBtb3VzZS9jbGljayBldmVudHMgZm9yIGEgbGluayB0aGF0IGlzIG5lYXIKCQkJLy8gYSB0b3VjaCBldmVudCwgZXZlbiB0aG91Z2ggdGhlIHRhcmdldCBvZiB0aGUgdG91Y2hzdGFydC90b3VjaGVuZCBldmVudAoJCQkvLyBzYXlzIHRoZSB1c2VyIHRvdWNoZWQgb3V0c2lkZSB0aGUgbGluay4gQWxzbywgaXQgc2VlbXMgdGhhdCB3aXRoIG1vc3QKCQkJLy8gYnJvd3NlcnMsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIGV2ZW50IGlzIG5vdCBjYWxjdWxhdGVkIHVudGlsIHRoZQoJCQkvLyB0aW1lIGl0IGlzIGRpc3BhdGNoZWQsIHNvIGlmIHlvdSByZXBsYWNlIGFuIGVsZW1lbnQgdGhhdCB5b3UgdG91Y2hlZAoJCQkvLyB3aXRoIGFub3RoZXIgZWxlbWVudCwgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgd2lsbCBiZSB0aGUgbmV3CgkJCS8vIGVsZW1lbnQgdW5kZXJuZWF0aCB0aGF0IHBvaW50LgoJCQkvLwoJCQkvLyBBc2lkZSBmcm9tIHByb3hpbWl0eSwgd2UgYWxzbyBjaGVjayB0byBzZWUgaWYgdGhlIHRhcmdldCBhbmQgYW55CgkJCS8vIG9mIGl0cyBhbmNlc3RvcnMgd2VyZSB0aGUgb25lcyB0aGF0IGJsb2NrZWQgYSBjbGljay4gVGhpcyBpcyBuZWNlc3NhcnkKCQkJLy8gYmVjYXVzZSBvZiB0aGUgc3RyYW5nZSBtb3VzZS9jbGljayB0YXJnZXQgY2FsY3VsYXRpb24gZG9uZSBpbiB0aGUKCQkJLy8gQW5kcm9pZCAyLjEgYnJvd3Nlciwgd2hlcmUgaWYgeW91IGNsaWNrIG9uIGFuIGVsZW1lbnQsIGFuZCB0aGVyZSBpcyBhCgkJCS8vIG1vdXNlL2NsaWNrIGhhbmRsZXIgb24gb25lIG9mIGl0cyBhbmNlc3RvcnMsIHRoZSB0YXJnZXQgd2lsbCBiZSB0aGUKCQkJLy8gaW5uZXJtb3N0IGNoaWxkIG9mIHRoZSB0b3VjaGVkIGVsZW1lbnQsIGV2ZW4gaWYgdGhhdCBjaGlsZCBpcyBubyB3aGVyZQoJCQkvLyBuZWFyIHRoZSBwb2ludCBvZiB0b3VjaC4KCgkJCWVsZSA9IHRhcmdldDsKCgkJCXdoaWxlICggZWxlICkgewoJCQkJZm9yICggaSA9IDA7IGkgPCBjbnQ7IGkrKyApIHsKCQkJCQlvID0gY2xpY2tCbG9ja0xpc3RbIGkgXTsKCQkJCQl0b3VjaElEID0gMDsKCgkJCQkJaWYgKCAoIGVsZSA9PT0gdGFyZ2V0ICYmIE1hdGguYWJzKCBvLnggLSB4ICkgPCB0aHJlc2hvbGQgJiYgTWF0aC5hYnMoIG8ueSAtIHkgKSA8IHRocmVzaG9sZCApIHx8CgkJCQkJCQkJJC5kYXRhKCBlbGUsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICkgPT09IG8udG91Y2hJRCApIHsKCQkJCQkJLy8gWFhYOiBXZSBtYXkgd2FudCB0byBjb25zaWRlciByZW1vdmluZyBtYXRjaGVzIGZyb20gdGhlIGJsb2NrIGxpc3QKCQkJCQkJLy8gICAgICBpbnN0ZWFkIG9mIHdhaXRpbmcgZm9yIHRoZSByZXNldCB0aW1lciB0byBmaXJlLgoJCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQl9CgkJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQkJfQoJCX0KCX0sIHRydWUpOwp9Cn0pKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQgKTsKLyogCiogImV2ZW50cyIgcGx1Z2luIC0gSGFuZGxlcyBldmVudHMKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBhZGQgbmV3IGV2ZW50IHNob3J0Y3V0cwokLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kIG9yaWVudGF0aW9uY2hhbmdlIHRocm90dGxlZHJlc2l6ZSAiICsKCQkJCQkidGFwIHRhcGhvbGQgc3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgc2Nyb2xsc3RhcnQgc2Nyb2xsc3RvcCIgKS5zcGxpdCggIiAiICksIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoKCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCX07CgoJJC5hdHRyRm5bIG5hbWUgXSA9IHRydWU7Cn0pOwoKdmFyIHN1cHBvcnRUb3VjaCA9ICQuc3VwcG9ydC50b3VjaCwKCXNjcm9sbEV2ZW50ID0gInRvdWNobW92ZSBzY3JvbGwiLAoJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgl0b3VjaFN0b3BFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaGVuZCIgOiAibW91c2V1cCIsCgl0b3VjaE1vdmVFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaG1vdmUiIDogIm1vdXNlbW92ZSI7CgpmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCXZhciBvcmlnaW5hbFR5cGUgPSBldmVudC50eXBlOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCSQuZXZlbnQuaGFuZGxlLmNhbGwoIG9iaiwgZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cn0KCi8vIGFsc28gaGFuZGxlcyBzY3JvbGxzdG9wCiQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgllbmFibGVkOiB0cnVlLAoKCXNldHVwOiBmdW5jdGlvbigpIHsKCgkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJc2Nyb2xsaW5nLAoJCQl0aW1lcjsKCgkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQlzY3JvbGxpbmcgPSBzdGF0ZTsKCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBzY3JvbGxpbmcgPyAic2Nyb2xsc3RhcnQiIDogInNjcm9sbHN0b3AiLCBldmVudCApOwoJCX0KCgkJLy8gaVBob25lIHRyaWdnZXJzIHNjcm9sbCBhZnRlciBhIHNtYWxsIGRlbGF5OyB1c2UgdG91Y2htb3ZlIGluc3RlYWQKCQkkdGhpcy5iaW5kKCBzY3JvbGxFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCXRyaWdnZXIoIGV2ZW50LCB0cnVlICk7CgkJCX0KCgkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCX0sIDUwICk7CgkJfSk7Cgl9Cn07CgovLyBhbHNvIGhhbmRsZXMgdGFwaG9sZAokLmV2ZW50LnNwZWNpYWwudGFwID0gewoJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJaWYgKCBldmVudC53aGljaCAmJiBldmVudC53aGljaCAhPT0gMSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIG9yaWdUYXJnZXQgPSBldmVudC50YXJnZXQsCgkJCQlvcmlnRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50LAoJCQkJdGltZXI7CgoJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQl9CgoJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJY2xlYXJUYXBUaW1lcigpOwoKCQkJCSR0aGlzLnVuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApCgkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApCgkJCQkJLnVuYmluZCggInZtb3VzZWNhbmNlbCIsIGNsZWFyVGFwSGFuZGxlcnMgKTsKCQkJfQoKCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKGV2ZW50KSB7CgkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJLy8gT05MWSB0cmlnZ2VyIGEgJ3RhcCcgZXZlbnQgaWYgdGhlIHN0YXJ0IHRhcmdldCBpcwoJCQkJLy8gdGhlIHNhbWUgYXMgdGhlIHN0b3AgdGFyZ2V0LgoJCQkJaWYgKCBvcmlnVGFyZ2V0ID09IGV2ZW50LnRhcmdldCApIHsKCQkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJ0YXAiLCBldmVudCApOwoJCQkJfQoJCQl9CgoJCQkkdGhpcy5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApCgkJCQkuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApCgkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoKCQkJdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIgKSApOwoJCQl9LCA3NTAgKTsKCQl9KTsKCX0KfTsKCi8vIGFsc28gaGFuZGxlcyBzd2lwZWxlZnQsIHN3aXBlcmlnaHQKJC5ldmVudC5zcGVjaWFsLnN3aXBlID0gewoJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMTAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJZHVyYXRpb25UaHJlc2hvbGQ6IDEwMDAsIC8vIE1vcmUgdGltZSB0aGFuIHRoaXMsIGFuZCBpdCBpc24ndCBhIHN3aXBlLgoKCWhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZDogMzAsICAvLyBTd2lwZSBob3Jpem9udGFsIGRpc3BsYWNlbWVudCBtdXN0IGJlIG1vcmUgdGhhbiB0aGlzLgoKCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZGF0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA/CgkJCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudCwKCQkJCXN0YXJ0ID0gewoJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdLAoJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCX0sCgkJCQlzdG9wOwoKCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoKCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgZGF0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA/CgkJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgoJCQkJc3RvcCA9IHsKCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJfTsKCgkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJaWYgKCBNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZCApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9CgoJCQkkdGhpcy5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKQoJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkkdGhpcy51bmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApOwoKCQkJCQlpZiAoIHN0YXJ0ICYmIHN0b3AgKSB7CgkJCQkJCWlmICggc3RvcC50aW1lIC0gc3RhcnQudGltZSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5kdXJhdGlvblRocmVzaG9sZCAmJgoJCQkJCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQgJiYKCQkJCQkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCgkJCQkJCQlzdGFydC5vcmlnaW4udHJpZ2dlciggInN3aXBlIiApCgkJCQkJCQkJLnRyaWdnZXIoIHN0YXJ0LmNvb3Jkc1swXSA+IHN0b3AuY29vcmRzWyAwIF0gPyAic3dpcGVsZWZ0IiA6ICJzd2lwZXJpZ2h0IiApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXN0YXJ0ID0gc3RvcCA9IHVuZGVmaW5lZDsKCQkJCX0pOwoJCX0pOwoJfQp9OwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyAiQ293Ym95IiBCZW4gQWxtYW4KCgl2YXIgd2luID0gJCggd2luZG93ICksCgkJc3BlY2lhbF9ldmVudCwKCQlnZXRfb3JpZW50YXRpb24sCgkJbGFzdF9vcmllbnRhdGlvbjsKCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSBzcGVjaWFsX2V2ZW50ID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKXsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfTsKCgkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgdGhpcyBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8KCS8vIHRoZSB3aW5kb3cgcmVzaXplIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCWZ1bmN0aW9uIGhhbmRsZXIoKSB7CgkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uLgoJCXZhciBvcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQlpZiAoIG9yaWVudGF0aW9uICE9PSBsYXN0X29yaWVudGF0aW9uICkgewoJCQkvLyBUaGUgb3JpZW50YXRpb24gaGFzIGNoYW5nZWQsIHNvIHRyaWdnZXIgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJCQlsYXN0X29yaWVudGF0aW9uID0gb3JpZW50YXRpb247CgkJCXdpbi50cmlnZ2VyKCAib3JpZW50YXRpb25jaGFuZ2UiICk7CgkJfQoJfQoKCS8vIEdldCB0aGUgY3VycmVudCBwYWdlIG9yaWVudGF0aW9uLiBUaGlzIG1ldGhvZCBpcyBleHBvc2VkIHB1YmxpY2x5LCBzaG91bGQgaXQKCS8vIGJlIG5lZWRlZCwgYXMgalF1ZXJ5LmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24oKQoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIGlzUG9ydHJhaXQgPSB0cnVlLCBlbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQkvLyBwcmVmZXIgd2luZG93IG9yaWVudGF0aW9uIHRvIHRoZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBzY3JlZW5zaXplIGFzCgkJLy8gdGhlIGFjdHVhbCBzY3JlZW4gcmVzaXplIHRha2VzIHBsYWNlIGJlZm9yZSBvciBhZnRlciB0aGUgb3JpZW50YXRpb24gY2hhbmdlIGV2ZW50CgkJLy8gaGFzIGJlZW4gZmlyZWQgZGVwZW5kaW5nIG9uIGltcGxlbWVudGF0aW9uIChlZyBhbmRyb2lkIDIuMyBpcyBiZWZvcmUsIGlwaG9uZSBhZnRlcikuCgkJLy8gTW9yZSB0ZXN0aW5nIGlzIHJlcXVpcmVkIHRvIGRldGVybWluZSBpZiBhIG1vcmUgcmVsaWFibGUgbWV0aG9kIG9mIGRldGVybWluaW5nIHRoZSBuZXcgc2NyZWVuc2l6ZQoJCS8vIGlzIHBvc3NpYmxlIHdoZW4gb3JpZW50YXRpb25jaGFuZ2UgaXMgZmlyZWQuIChlZywgdXNlIG1lZGlhIHF1ZXJpZXMgKyBlbGVtZW50ICsgb3BhY2l0eSkKCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCQkJLy8gaWYgdGhlIHdpbmRvdyBvcmllbnRhdGlvbiByZWdpc3RlcnMgYXMgMCBvciAxODAgZGVncmVlcyByZXBvcnQKCQkJLy8gcG9ydHJhaXQsIG90aGVyd2lzZSBsYW5kc2NhcGUKCQkJaXNQb3J0cmFpdCA9IHdpbmRvdy5vcmllbnRhdGlvbiAlIDE4MCA9PSAwOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCn0pKCBqUXVlcnksIHdpbmRvdyApOwoKCi8vIHRocm90dGxlZCByZXNpemUgZXZlbnQKKGZ1bmN0aW9uKCkgewoKCSQuZXZlbnQuc3BlY2lhbC50aHJvdHRsZWRyZXNpemUgPSB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpewoJCQkkKCB0aGlzICkudW5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCX0KCX07CgoJdmFyIHRocm90dGxlID0gMjUwLAoJCWhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCQkJY3VyciA9ICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsKCQkJZGlmZiA9IGN1cnIgLSBsYXN0Q2FsbDsKCgkJCWlmICggZGlmZiA+PSB0aHJvdHRsZSApIHsKCgkJCQlsYXN0Q2FsbCA9IGN1cnI7CgkJCQkkKCB0aGlzICkudHJpZ2dlciggInRocm90dGxlZHJlc2l6ZSIgKTsKCgkJCX0gZWxzZSB7CgoJCQkJaWYgKCBoZWxkQ2FsbCApIHsKCQkJCQljbGVhclRpbWVvdXQoIGhlbGRDYWxsICk7CgkJCQl9CgoJCQkJLy8gUHJvbWlzZSBhIGhlbGQgY2FsbCB3aWxsIHN0aWxsIGV4ZWN1dGUKCQkJCWhlbGRDYWxsID0gc2V0VGltZW91dCggaGFuZGxlciwgdGhyb3R0bGUgLSBkaWZmICk7CgkJCX0KCQl9LAoJCWxhc3RDYWxsID0gMCwKCQloZWxkQ2FsbCwKCQljdXJyLAoJCWRpZmY7Cn0pKCk7CgoKJC5lYWNoKHsKCXNjcm9sbHN0b3A6ICJzY3JvbGxzdGFydCIsCgl0YXBob2xkOiAidGFwIiwKCXN3aXBlbGVmdDogInN3aXBlIiwKCXN3aXBlcmlnaHQ6ICJzd2lwZSIKfSwgZnVuY3Rpb24oIGV2ZW50LCBzb3VyY2VFdmVudCApIHsKCgkkLmV2ZW50LnNwZWNpYWxbIGV2ZW50IF0gPSB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuYmluZCggc291cmNlRXZlbnQsICQubm9vcCApOwoJCX0KCX07Cn0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovLyBTY3JpcHQ6IGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50Ci8vIAovLyAqVmVyc2lvbjogMS4zLCBMYXN0IHVwZGF0ZWQ6IDcvMjEvMjAxMCoKLy8gCi8vIFByb2plY3QgSG9tZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UtcGx1Z2luLwovLyBHaXRIdWIgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvCi8vIFNvdXJjZSAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLmpzCi8vIChNaW5pZmllZCkgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLm1pbi5qcyAoMC44a2IgZ3ppcHBlZCkKLy8gCi8vIEFib3V0OiBMaWNlbnNlCi8vIAovLyBDb3B5cmlnaHQgKGMpIDIwMTAgIkNvd2JveSIgQmVuIEFsbWFuLAovLyBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlcy4KLy8gaHR0cDovL2JlbmFsbWFuLmNvbS9hYm91dC9saWNlbnNlLwovLyAKLy8gQWJvdXQ6IEV4YW1wbGVzCi8vIAovLyBUaGVzZSB3b3JraW5nIGV4YW1wbGVzLCBjb21wbGV0ZSB3aXRoIGZ1bGx5IGNvbW1lbnRlZCBjb2RlLCBpbGx1c3RyYXRlIGEgZmV3Ci8vIHdheXMgaW4gd2hpY2ggdGhpcyBwbHVnaW4gY2FuIGJlIHVzZWQuCi8vIAovLyBoYXNoY2hhbmdlIGV2ZW50IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2hhc2hjaGFuZ2UvCi8vIGRvY3VtZW50LmRvbWFpbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9kb2N1bWVudF9kb21haW4vCi8vIAovLyBBYm91dDogU3VwcG9ydCBhbmQgVGVzdGluZwovLyAKLy8gSW5mb3JtYXRpb24gYWJvdXQgd2hhdCB2ZXJzaW9uIG9yIHZlcnNpb25zIG9mIGpRdWVyeSB0aGlzIHBsdWdpbiBoYXMgYmVlbgovLyB0ZXN0ZWQgd2l0aCwgd2hhdCBicm93c2VycyBpdCBoYXMgYmVlbiB0ZXN0ZWQgaW4sIGFuZCB3aGVyZSB0aGUgdW5pdCB0ZXN0cwovLyByZXNpZGUgKHNvIHlvdSBjYW4gdGVzdCBpdCB5b3Vyc2VsZikuCi8vIAovLyBqUXVlcnkgVmVyc2lvbnMgLSAxLjIuNiwgMS4zLjIsIDEuNC4xLCAxLjQuMgovLyBCcm93c2VycyBUZXN0ZWQgLSBJbnRlcm5ldCBFeHBsb3JlciA2LTgsIEZpcmVmb3ggMi00LCBDaHJvbWUgNS02LCBTYWZhcmkgMy4yLTUsCi8vICAgICAgICAgICAgICAgICAgIE9wZXJhIDkuNi0xMC42MCwgaVBob25lIDMuMSwgQW5kcm9pZCAxLjYtMi4yLCBCbGFja0JlcnJ5IDQuNi01LgovLyBVbml0IFRlc3RzICAgICAgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvdW5pdC8KLy8gCi8vIEFib3V0OiBLbm93biBpc3N1ZXMKLy8gCi8vIFdoaWxlIHRoaXMgalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQgaW1wbGVtZW50YXRpb24gaXMgcXVpdGUgc3RhYmxlIGFuZAovLyByb2J1c3QsIHRoZXJlIGFyZSBhIGZldyB1bmZvcnR1bmF0ZSBicm93c2VyIGJ1Z3Mgc3Vycm91bmRpbmcgZXhwZWN0ZWQKLy8gaGFzaGNoYW5nZSBldmVudC1iYXNlZCBiZWhhdmlvcnMsIGluZGVwZW5kZW50IG9mIGFueSBKYXZhU2NyaXB0Ci8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgYWJzdHJhY3Rpb24uIFNlZSB0aGUgZm9sbG93aW5nIGV4YW1wbGVzIGZvciBtb3JlCi8vIGluZm9ybWF0aW9uOgovLyAKLy8gQ2hyb21lOiBCYWNrIEJ1dHRvbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctY2hyb21lLWJhY2stYnV0dG9uLwovLyBGaXJlZm94OiBSZW1vdGUgWE1MSHR0cFJlcXVlc3QgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWZpcmVmb3gtcmVtb3RlLXhoci8KLy8gV2ViS2l0OiBCYWNrIEJ1dHRvbiBpbiBhbiBJZnJhbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXdlYmtpdC1oYXNoLWlmcmFtZS8KLy8gU2FmYXJpOiBCYWNrIEJ1dHRvbiBmcm9tIGEgZGlmZmVyZW50IGRvbWFpbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctc2FmYXJpLWJhY2stZnJvbS1kaWZmLWRvbWFpbi8KLy8gCi8vIEFsc28gbm90ZSB0aGF0IHNob3VsZCBhIGJyb3dzZXIgbmF0aXZlbHkgc3VwcG9ydCB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSAKLy8gZXZlbnQsIGJ1dCBub3QgcmVwb3J0IHRoYXQgaXQgZG9lcywgdGhlIGZhbGxiYWNrIHBvbGxpbmcgbG9vcCB3aWxsIGJlIHVzZWQuCi8vIAovLyBBYm91dDogUmVsZWFzZSBIaXN0b3J5Ci8vIAovLyAxLjMgICAtICg3LzIxLzIwMTApIFJlb3JnYW5pemVkIElFNi83IElmcmFtZSBjb2RlIHRvIG1ha2UgaXQgbW9yZQovLyAgICAgICAgICJyZW1vdmFibGUiIGZvciBtb2JpbGUtb25seSBkZXZlbG9wbWVudC4gQWRkZWQgSUU2LzcgZG9jdW1lbnQudGl0bGUKLy8gICAgICAgICBzdXBwb3J0LiBBdHRlbXB0ZWQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlIGJ5IHVzaW5nCi8vICAgICAgICAgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuIEFkZGVkIAovLyAgICAgICAgIHN1cHBvcnQgZm9yIHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKHdpbmRvdykuaGFzaGNoYW5nZSggZm4gKSBhbmQKLy8gICAgICAgICAkKHdpbmRvdykuaGFzaGNoYW5nZSgpIGxpa2UgalF1ZXJ5IHByb3ZpZGVzIGZvciBidWlsdC1pbiBldmVudHMuCi8vICAgICAgICAgUmVuYW1lZCBqUXVlcnkuaGFzaGNoYW5nZURlbGF5IHRvIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheT4gYW5kCi8vICAgICAgICAgbG93ZXJlZCBpdHMgZGVmYXVsdCB2YWx1ZSB0byA1MC4gQWRkZWQgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbj4KLy8gICAgICAgICBhbmQgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydGllcyBwbHVzIGRvY3VtZW50LWRvbWFpbi5odG1sCi8vICAgICAgICAgZmlsZSB0byBhZGRyZXNzIGFjY2VzcyBkZW5pZWQgaXNzdWVzIHdoZW4gc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4KLy8gICAgICAgICBJRTYvNy4KLy8gMS4yICAgLSAoMi8xMS8yMDEwKSBGaXhlZCBhIGJ1ZyB3aGVyZSBjb21pbmcgYmFjayB0byBhIHBhZ2UgdXNpbmcgdGhpcyBwbHVnaW4KLy8gICAgICAgICBmcm9tIGEgcGFnZSBvbiBhbm90aGVyIGRvbWFpbiB3b3VsZCBjYXVzZSBhbiBlcnJvciBpbiBTYWZhcmkgNC4gQWxzbywKLy8gICAgICAgICBJRTYvNyBJZnJhbWUgaXMgbm93IGluc2VydGVkIGFmdGVyIHRoZSBib2R5ICh0aGlzIGFjdHVhbGx5IHdvcmtzKSwKLy8gICAgICAgICB3aGljaCBwcmV2ZW50cyB0aGUgcGFnZSBmcm9tIHNjcm9sbGluZyB3aGVuIHRoZSBldmVudCBpcyBmaXJzdCBib3VuZC4KLy8gICAgICAgICBFdmVudCBjYW4gYWxzbyBub3cgYmUgYm91bmQgYmVmb3JlIERPTSByZWFkeSwgYnV0IGl0IHdvbid0IGJlIHVzYWJsZQovLyAgICAgICAgIGJlZm9yZSB0aGVuIGluIElFNi83LgovLyAxLjEgICAtICgxLzIxLzIwMTApIEluY29ycG9yYXRlZCBkb2N1bWVudC5kb2N1bWVudE1vZGUgdGVzdCB0byBmaXggSUU4IGJ1ZwovLyAgICAgICAgIHdoZXJlIGJyb3dzZXIgdmVyc2lvbiBpcyBpbmNvcnJlY3RseSByZXBvcnRlZCBhcyA4LjAsIGRlc3BpdGUKLy8gICAgICAgICBpbmNsdXNpb24gb2YgdGhlIFgtVUEtQ29tcGF0aWJsZSBJRT1FbXVsYXRlSUU3IG1ldGEgdGFnLgovLyAxLjAgICAtICgxLzkvMjAxMCkgSW5pdGlhbCBSZWxlYXNlLiBCcm9rZSBvdXQgdGhlIGpRdWVyeSBCQlEgZXZlbnQuc3BlY2lhbAovLyAgICAgICAgIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZnVuY3Rpb25hbGl0eSBpbnRvIGEgc2VwYXJhdGUgcGx1Z2luIGZvciB1c2VycwovLyAgICAgICAgIHdobyB3YW50IGp1c3QgdGhlIGJhc2ljIGV2ZW50ICYgYmFjayBidXR0b24gc3VwcG9ydCwgd2l0aG91dCBhbGwgdGhlCi8vICAgICAgICAgZXh0cmEgYXdlc29tZW5lc3MgdGhhdCBCQlEgcHJvdmlkZXMuIFRoaXMgcGx1Z2luIHdpbGwgYmUgaW5jbHVkZWQgYXMKLy8gICAgICAgICBwYXJ0IG9mIGpRdWVyeSBCQlEsIGJ1dCBhbHNvIGJlIGF2YWlsYWJsZSBzZXBhcmF0ZWx5LgoKKGZ1bmN0aW9uKCQsd2luZG93LHVuZGVmaW5lZCl7CiAgJyQ6bm9tdW5nZSc7IC8vIFVzZWQgYnkgWVVJIGNvbXByZXNzb3IuCiAgCiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCl7CiAgICB2YXIgc2VsZiA9IHt9LAogICAgICB0aW1lb3V0X2lkLAogICAgICAKICAgICAgLy8gUmVtZW1iZXIgdGhlIGluaXRpYWwgaGFzaCBzbyBpdCBkb2Vzbid0IGdldCB0cmlnZ2VyZWQgaW1tZWRpYXRlbHkuCiAgICAgIGxhc3RfaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAKICAgICAgZm5fcmV0dmFsID0gZnVuY3Rpb24odmFsKXsgcmV0dXJuIHZhbDsgfSwKICAgICAgaGlzdG9yeV9zZXQgPSBmbl9yZXR2YWwsCiAgICAgIGhpc3RvcnlfZ2V0ID0gZm5fcmV0dmFsOwogICAgCiAgICAvLyBTdGFydCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICB0aW1lb3V0X2lkIHx8IHBvbGwoKTsKICAgIH07CiAgICAKICAgIC8vIFN0b3AgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICB0aW1lb3V0X2lkICYmIGNsZWFyVGltZW91dCggdGltZW91dF9pZCApOwogICAgICB0aW1lb3V0X2lkID0gdW5kZWZpbmVkOwogICAgfTsKICAgIAogICAgLy8gVGhpcyBwb2xsaW5nIGxvb3AgY2hlY2tzIGV2ZXJ5ICQuZm4uaGFzaGNoYW5nZS5kZWxheSBtaWxsaXNlY29uZHMgdG8gc2VlCiAgICAvLyBpZiBsb2NhdGlvbi5oYXNoIGhhcyBjaGFuZ2VkLCBhbmQgdHJpZ2dlcnMgdGhlICdoYXNoY2hhbmdlJyBldmVudCBvbgogICAgLy8gd2luZG93IHdoZW4gbmVjZXNzYXJ5LgogICAgZnVuY3Rpb24gcG9sbCgpIHsKICAgICAgdmFyIGhhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgICBoaXN0b3J5X2hhc2ggPSBoaXN0b3J5X2dldCggbGFzdF9oYXNoICk7CiAgICAgIAogICAgICBpZiAoIGhhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBoaXN0b3J5X3NldCggbGFzdF9oYXNoID0gaGFzaCwgaGlzdG9yeV9oYXNoICk7CiAgICAgICAgCiAgICAgICAgJCh3aW5kb3cpLnRyaWdnZXIoIHN0cl9oYXNoY2hhbmdlICk7CiAgICAgICAgCiAgICAgIH0gZWxzZSBpZiAoIGhpc3RvcnlfaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGxvY2F0aW9uLmhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoIC8jLiovLCAnJyApICsgaGlzdG9yeV9oYXNoOwogICAgICB9CiAgICAgIAogICAgICB0aW1lb3V0X2lkID0gc2V0VGltZW91dCggcG9sbCwgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kZWxheSApOwogICAgfTsKICAgIAogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2IFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgJC5icm93c2VyLm1zaWUgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKXsKICAgICAgLy8gTm90IG9ubHkgZG8gSUU2LzcgbmVlZCB0aGUgIm1hZ2ljYWwiIElmcmFtZSB0cmVhdG1lbnQsIGJ1dCBzbyBkb2VzIElFOAogICAgICAvLyB3aGVuIHJ1bm5pbmcgaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlLgogICAgICAKICAgICAgdmFyIGlmcmFtZSwKICAgICAgICBpZnJhbWVfc3JjOwogICAgICAKICAgICAgLy8gV2hlbiB0aGUgZXZlbnQgaXMgYm91bmQgYW5kIHBvbGxpbmcgc3RhcnRzIGluIElFIDYvNywgY3JlYXRlIGEgaGlkZGVuCiAgICAgIC8vIElmcmFtZSBmb3IgaGlzdG9yeSBoYW5kbGluZy4KICAgICAgc2VsZi5zdGFydCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKCAhaWZyYW1lICkgewogICAgICAgICAgaWZyYW1lX3NyYyA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uc3JjOwogICAgICAgICAgaWZyYW1lX3NyYyA9IGlmcmFtZV9zcmMgJiYgaWZyYW1lX3NyYyArIGdldF9mcmFnbWVudCgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBDcmVhdGUgaGlkZGVuIElmcmFtZS4gQXR0ZW1wdCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUKICAgICAgICAgIC8vIGJ5IHVzaW5nIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LgogICAgICAgICAgaWZyYW1lID0gJCgnPGlmcmFtZSB0YWJpbmRleD0iLTEiIHRpdGxlPSJlbXB0eSIvPicpLmhpZGUoKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gV2hlbiBJZnJhbWUgaGFzIGNvbXBsZXRlbHkgbG9hZGVkLCBpbml0aWFsaXplIHRoZSBoaXN0b3J5IGFuZAogICAgICAgICAgICAvLyBzdGFydCBwb2xsaW5nLgogICAgICAgICAgICAub25lKCAnbG9hZCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgaWZyYW1lX3NyYyB8fCBoaXN0b3J5X3NldCggZ2V0X2ZyYWdtZW50KCkgKTsKICAgICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2FkIElmcmFtZSBzcmMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugbm90aGluZy4KICAgICAgICAgICAgLmF0dHIoICdzcmMnLCBpZnJhbWVfc3JjIHx8ICdqYXZhc2NyaXB0OjAnICkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGVuZCBJZnJhbWUgYWZ0ZXIgdGhlIGVuZCBvZiB0aGUgYm9keSB0byBwcmV2ZW50IHVubmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluaXRpYWwgcGFnZSBzY3JvbGxpbmcgKHllcywgdGhpcyB3b3JrcykuCiAgICAgICAgICAgIC5pbnNlcnRBZnRlciggJ2JvZHknIClbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgIAogICAgICAgICAgLy8gV2hlbmV2ZXIgYGRvY3VtZW50LnRpdGxlYCBjaGFuZ2VzLCB1cGRhdGUgdGhlIElmcmFtZSdzIHRpdGxlIHRvCiAgICAgICAgICAvLyBwcmV0dGlmeSB0aGUgYmFjay9uZXh0IGhpc3RvcnkgbWVudSBlbnRyaWVzLiBTaW5jZSBJRSBzb21ldGltZXMKICAgICAgICAgIC8vIGVycm9ycyB3aXRoICJVbnNwZWNpZmllZCBlcnJvciIgdGhlIHZlcnkgZmlyc3QgdGltZSB0aGlzIGlzIHNldAogICAgICAgICAgLy8gKHllcywgdmVyeSB1c2VmdWwpIHdyYXAgdGhpcyB3aXRoIGEgdHJ5L2NhdGNoIGJsb2NrLgogICAgICAgICAgZG9jLm9ucHJvcGVydHljaGFuZ2UgPSBmdW5jdGlvbigpewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmICggZXZlbnQucHJvcGVydHlOYW1lID09PSAndGl0bGUnICkgewogICAgICAgICAgICAgICAgaWZyYW1lLmRvY3VtZW50LnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaChlKSB7fQogICAgICAgICAgfTsKICAgICAgICAgIAogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICAgIC8vIE92ZXJyaWRlIHRoZSAic3RvcCIgbWV0aG9kIHNpbmNlIGFuIElFNi83IElmcmFtZSB3YXMgY3JlYXRlZC4gRXZlbgogICAgICAvLyBpZiB0aGVyZSBhcmUgbm8gbG9uZ2VyIGFueSBib3VuZCBldmVudCBoYW5kbGVycywgdGhlIHBvbGxpbmcgbG9vcAogICAgICAvLyBpcyBzdGlsbCBuZWNlc3NhcnkgZm9yIGJhY2svbmV4dCB0byB3b3JrIGF0IGFsbCEKICAgICAgc2VsZi5zdG9wID0gZm5fcmV0dmFsOwogICAgICAKICAgICAgLy8gR2V0IGhpc3RvcnkgYnkgbG9va2luZyBhdCB0aGUgaGlkZGVuIElmcmFtZSdzIGxvY2F0aW9uLmhhc2guCiAgICAgIGhpc3RvcnlfZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGdldF9mcmFnbWVudCggaWZyYW1lLmxvY2F0aW9uLmhyZWYgKTsKICAgICAgfTsKICAgICAgCiAgICAgIC8vIFNldCBhIG5ldyBoaXN0b3J5IGl0ZW0gYnkgb3BlbmluZyBhbmQgdGhlbiBjbG9zaW5nIHRoZSBJZnJhbWUKICAgICAgLy8gZG9jdW1lbnQsICp0aGVuKiBzZXR0aW5nIGl0cyBsb2NhdGlvbi5oYXNoLiBJZiBkb2N1bWVudC5kb21haW4gaGFzCiAgICAgIC8vIGJlZW4gc2V0LCB1cGRhdGUgdGhhdCBhcyB3ZWxsLgogICAgICBoaXN0b3J5X3NldCA9IGZ1bmN0aW9uKCBoYXNoLCBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgdmFyIGlmcmFtZV9kb2MgPSBpZnJhbWUuZG9jdW1lbnQsCiAgICAgICAgICBkb21haW4gPSAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbjsKICAgICAgICAKICAgICAgICBpZiAoIGhhc2ggIT09IGhpc3RvcnlfaGFzaCApIHsKICAgICAgICAgIC8vIFVwZGF0ZSBJZnJhbWUgd2l0aCBhbnkgaW5pdGlhbCBgZG9jdW1lbnQudGl0bGVgIHRoYXQgbWlnaHQgYmUgc2V0LgogICAgICAgICAgaWZyYW1lX2RvYy50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgIAogICAgICAgICAgLy8gT3BlbmluZyB0aGUgSWZyYW1lJ3MgZG9jdW1lbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gY2xvc2VkIGlzIHdoYXQKICAgICAgICAgIC8vIGFjdHVhbGx5IGFkZHMgYSBoaXN0b3J5IGVudHJ5LgogICAgICAgICAgaWZyYW1lX2RvYy5vcGVuKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFNldCBkb2N1bWVudC5kb21haW4gZm9yIHRoZSBJZnJhbWUgZG9jdW1lbnQgYXMgd2VsbCwgaWYgbmVjZXNzYXJ5LgogICAgICAgICAgZG9tYWluICYmIGlmcmFtZV9kb2Mud3JpdGUoICc8c2NyaXB0PmRvY3VtZW50LmRvbWFpbj0iJyArIGRvbWFpbiArICciPC9zY3JpcHQ+JyApOwogICAgICAgICAgCiAgICAgICAgICBpZnJhbWVfZG9jLmNsb3NlKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgSWZyYW1lJ3MgaGFzaCwgZm9yIGdyZWF0IGp1c3RpY2UuCiAgICAgICAgICBpZnJhbWUubG9jYXRpb24uaGFzaCA9IGhhc2g7CiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgIH0pKCk7CiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl4gUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAKICAgIHJldHVybiBzZWxmOwogIH0pKCk7CiAgCn0pKGpRdWVyeSx0aGlzKTsKLyoKKiAicGFnZSIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogImMiLAoJCWRvbUNhY2hlOiBmYWxzZSwKCQlrZWVwTmF0aXZlRGVmYXVsdDogIjpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdGhpcy5fdHJpZ2dlciggImJlZm9yZWNyZWF0ZSIgKTsKCgkJdGhpcy5lbGVtZW50CgkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wYWdlIHVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoJfSwKCglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlRGVmaW5lZCA9IG9wdGlvbnMua2VlcE5hdGl2ZSAmJiAkLnRyaW0ob3B0aW9ucy5rZWVwTmF0aXZlKTsKCgkJaWYoIGtlZXBOYXRpdmVEZWZpbmVkICYmIG9wdGlvbnMua2VlcE5hdGl2ZSAhPT0gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdCApewoJCQlyZXR1cm4gW29wdGlvbnMua2VlcE5hdGl2ZSwgb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdF0uam9pbigiLCAiKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0OwoJfQp9KTsKfSkoIGpRdWVyeSApOwovKiAKKiAiY29yZSIgLSBUaGUgYmFzZSBmaWxlIGZvciBqUW0KKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9OwoKCS8vIGpRdWVyeS5tb2JpbGUgY29uZmlndXJhYmxlIG9wdGlvbnMKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoKCQkvLyBOYW1lc3BhY2UgdXNlZCBmcmFtZXdvcmstd2lkZSBmb3IgZGF0YS1hdHRycy4gRGVmYXVsdCBpcyBubyBuYW1lc3BhY2UKCQluczogIiIsCgoJCS8vIERlZmluZSB0aGUgdXJsIHBhcmFtZXRlciB1c2VkIGZvciByZWZlcmVuY2luZyB3aWRnZXQtZ2VuZXJhdGVkIHN1Yi1wYWdlcy4KCQkvLyBUcmFuc2xhdGVzIHRvIHRvIGV4YW1wbGUuaHRtbCZ1aS1wYWdlPXN1YnBhZ2VJZGVudGlmaWVyCgkJLy8gaGFzaCBzZWdtZW50IGJlZm9yZSAmdWktcGFnZT0gaXMgdXNlZCB0byBtYWtlIEFqYXggcmVxdWVzdAoJCXN1YlBhZ2VVcmxLZXk6ICJ1aS1wYWdlIiwKCgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImFjdGl2ZSIgYnV0dG9uIHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlhY3RpdmVCdG5DbGFzczogInVpLWJ0bi1hY3RpdmUiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogInNsaWRlIiwKCgkJLy8gTWluaW11bSBzY3JvbGwgZGlzdGFuY2UgdGhhdCB3aWxsIGJlIHJlbWVtYmVyZWQgd2hlbiByZXR1cm5pbmcgdG8gYSBwYWdlCgkJbWluU2Nyb2xsQmFjazogMjUwLAoKCQkvLyBTZXQgZGVmYXVsdCBkaWFsb2cgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjogInBvcCIsCgoJCS8vIFNob3cgbG9hZGluZyBtZXNzYWdlIGR1cmluZyBBamF4IHJlcXVlc3RzCgkJLy8gaWYgZmFsc2UsIG1lc3NhZ2Ugd2lsbCBub3QgYXBwZWFyLCBidXQgbG9hZGluZyBjbGFzc2VzIHdpbGwgc3RpbGwgYmUgdG9nZ2xlZCBvbiBodG1sIGVsCgkJbG9hZGluZ01lc3NhZ2U6ICJsb2FkaW5nIiwKCgkJLy8gRXJyb3IgcmVzcG9uc2UgbWVzc2FnZSAtIGFwcGVhcnMgd2hlbiBhbiBBamF4IHBhZ2UgcmVxdWVzdCBmYWlscwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlOiAiRXJyb3IgTG9hZGluZyBQYWdlIiwKCgkJLy9hdXRvbWF0aWNhbGx5IGluaXRpYWxpemUgdGhlIERPTSB3aGVuIGl0J3MgcmVhZHkKCQlhdXRvSW5pdGlhbGl6ZVBhZ2U6IHRydWUsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCS8vIHR1cm4gb2YgYmluZGluZyB0byB0aGUgbmF0aXZlIG9yaWVudGF0aW9uY2hhbmdlIGR1ZSB0byBhbmRyb2lkIG9yaWVudGF0aW9uIGJlaGF2aW9yCgkJb3JpZW50YXRpb25DaGFuZ2VFbmFibGVkOiB0cnVlLAoKCQkvLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCgkJLy8gZGVmYXVsdCBlbmhhbmNlZCBxdWFsaWZpY2F0aW9ucyBhcmUgbWVkaWEgcXVlcnkgc3VwcG9ydCBPUiBJRSA3KwoJCWdyYWRlQTogZnVuY3Rpb24oKXsKCQkJcmV0dXJuICQuc3VwcG9ydC5tZWRpYXF1ZXJ5IHx8ICQubW9iaWxlLmJyb3dzZXIuaWUgJiYgJC5tb2JpbGUuYnJvd3Nlci5pZSA+PSA3OwoJCX0sCgoJCS8vIFRPRE8gbWlnaHQgYmUgdXNlZnVsIHVwc3RyZWFtIGluIGpxdWVyeSBpdHNlbGYgPwoJCWtleUNvZGU6IHsKCQkJQUxUOiAxOCwKCQkJQkFDS1NQQUNFOiA4LAoJCQlDQVBTX0xPQ0s6IDIwLAoJCQlDT01NQTogMTg4LAoJCQlDT01NQU5EOiA5MSwKCQkJQ09NTUFORF9MRUZUOiA5MSwgLy8gQ09NTUFORAoJCQlDT01NQU5EX1JJR0hUOiA5MywKCQkJQ09OVFJPTDogMTcsCgkJCURFTEVURTogNDYsCgkJCURPV046IDQwLAoJCQlFTkQ6IDM1LAoJCQlFTlRFUjogMTMsCgkJCUVTQ0FQRTogMjcsCgkJCUhPTUU6IDM2LAoJCQlJTlNFUlQ6IDQ1LAoJCQlMRUZUOiAzNywKCQkJTUVOVTogOTMsIC8vIENPTU1BTkRfUklHSFQKCQkJTlVNUEFEX0FERDogMTA3LAoJCQlOVU1QQURfREVDSU1BTDogMTEwLAoJCQlOVU1QQURfRElWSURFOiAxMTEsCgkJCU5VTVBBRF9FTlRFUjogMTA4LAoJCQlOVU1QQURfTVVMVElQTFk6IDEwNiwKCQkJTlVNUEFEX1NVQlRSQUNUOiAxMDksCgkJCVBBR0VfRE9XTjogMzQsCgkJCVBBR0VfVVA6IDMzLAoJCQlQRVJJT0Q6IDE5MCwKCQkJUklHSFQ6IDM5LAoJCQlTSElGVDogMTYsCgkJCVNQQUNFOiAzMiwKCQkJVEFCOiA5LAoJCQlVUDogMzgsCgkJCVdJTkRPV1M6IDkxIC8vIENPTU1BTkQKCQl9LAoKCQkvLyBTY3JvbGwgcGFnZSB2ZXJ0aWNhbGx5OiBzY3JvbGwgdG8gMCB0byBoaWRlIGlPUyBhZGRyZXNzIGJhciwgb3IgcGFzcyBhIFkgdmFsdWUKCQlzaWxlbnRTY3JvbGw6IGZ1bmN0aW9uKCB5cG9zICkgewoJCQlpZiAoICQudHlwZSggeXBvcyApICE9PSAibnVtYmVyIiApIHsKCQkJCXlwb3MgPSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCQkJfQoKCQkJLy8gcHJldmVudCBzY3JvbGxzdGFydCBhbmQgc2Nyb2xsc3RvcCBldmVudHMKCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHlwb3MgKTsKCQkJCSQoIGRvY3VtZW50ICkudHJpZ2dlciggInNpbGVudHNjcm9sbCIsIHsgeDogMCwgeTogeXBvcyB9KTsKCQkJfSwgMjAgKTsKCgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCX0sIDE1MCApOwoJCX0sCgoJCS8vIEV4cG9zZSBvdXIgY2FjaGUgZm9yIHRlc3RpbmcgcHVycG9zZXMuCgkJbnNOb3JtYWxpemVEaWN0OiBuc05vcm1hbGl6ZURpY3QsCgoJCS8vIFRha2UgYSBkYXRhIGF0dHJpYnV0ZSBwcm9wZXJ0eSwgcHJlcGVuZCB0aGUgbmFtZXNwYWNlCgkJLy8gYW5kIHRoZW4gY2FtZWwgY2FzZSB0aGUgYXR0cmlidXRlIHN0cmluZy4gQWRkIHRoZSByZXN1bHQKCQkvLyB0byBvdXIgbnNOb3JtYWxpemVEaWN0IHNvIHdlIGRvbid0IGhhdmUgdG8gZG8gdGhpcyBhZ2Fpbi4KCQluc05vcm1hbGl6ZTogZnVuY3Rpb24oIHByb3AgKSB7CgkJCWlmICggIXByb3AgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXJldHVybiBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSB8fCAoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoKCQkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzIG9uIGl0LiBOb3RlIHRoYXQKCQkJLy8gd2UgYXJlIG5vdCB1c2luZyAkLmZuLmNsb3Nlc3QoKSBvbiBwdXJwb3NlIGhlcmUgYmVjYXVzZSB0aGlzCgkJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJCS8vIGFzIHBvc3NpYmxlLgoKCQkJdmFyIGUgPSBlbFsgMCBdLAoJCQkJbHRyID0gIiIsCgkJCQlyZSA9IC91aS0oYmFyfGJvZHkpLShbYS16XSlcYi8sCgkJCQljLCBtOwoKCQkJd2hpbGUgKCBlICkgewoJCQkJdmFyIGMgPSBlLmNsYXNzTmFtZSB8fCAiIjsKCQkJCWlmICggKCBtID0gcmUuZXhlYyggYyApICkgJiYgKCBsdHIgPSBtWyAyIF0gKSApIHsKCQkJCQkvLyBXZSBmb3VuZCBhIHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3MKCQkJCQkvLyBvbiBpdCBzbyBiYWlsIGZyb20gdGhpcyBsb29wLgoJCQkJCWJyZWFrOwoJCQkJfQoJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJfQoJCQkKCQkJLy8gUmV0dXJuIHRoZSB0aGVtZSBsZXR0ZXIgd2UgZm91bmQsIGlmIG5vbmUsIHJldHVybiB0aGUKCQkJLy8gc3BlY2lmaWVkIGRlZmF1bHQuCgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfQoJfSk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuanFtRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5mbi5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCkgewoJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCX07CgoJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKTsKCgkJKCAkZWxlbS5qcW1EYXRhKCdkZXBlbmRlbnRzJykgfHwgJCgpICkucmVtb3ZlKCk7CgkJJGVsZW0ucmVtb3ZlKCk7Cgl9OwoKCSQuZm4uYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuZXdEZXBlbmRlbnRzICkgewoJCSQuYWRkRGVwZW5kZW50cyggJCh0aGlzKSwgbmV3RGVwZW5kZW50cyApOwoJfTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgZGVwZW5kZW50cyA9ICQoZWxlbSkuanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpOwoKCQkkKGVsZW0pLmpxbURhdGEoICdkZXBlbmRlbnRzJywgJC5tZXJnZShkZXBlbmRlbnRzLCBuZXdEZXBlbmRlbnRzKSApOwoJfTsKCgkvLyBub3RlIHRoYXQgdGhpcyBoZWxwZXIgZG9lc24ndCBhdHRlbXB0IHRvIGhhbmRsZSB0aGUgY2FsbGJhY2sKCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50cyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkvLyB0byByZXR1cm4gdGhlIGh0bWwgZW5jb2RlZCB2ZXJzaW9uIG9mIHRoZSB0ZXh0IGluIGFsbCBjYXNlcy4gKHRodXMgdGhlIG5hbWUpCgkkLmZuLmdldEVuY29kZWRUZXh0ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICkudGV4dCggJCh0aGlzKS50ZXh0KCkgKS5odG1sKCk7Cgl9OwoKCS8vIE1vbmtleS1wYXRjaGluZyBTaXp6bGUgdG8gZmlsdGVyIHRoZSA6anFtRGF0YSBzZWxlY3RvcgoJdmFyIG9sZEZpbmQgPSAkLmZpbmQsCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCgkJcmV0dXJuIG9sZEZpbmQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKTsKCX07CgoJJC5leHRlbmQoICQuZmluZCwgb2xkRmluZCApOwoKCSQuZmluZC5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIHNldCApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBzZXQgKTsKCX07CgoJJC5maW5kLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBub2RlLCBleHByICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIFsgbm9kZSBdICkubGVuZ3RoID4gMDsKCX07Cn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogY29yZSB1dGlsaXRpZXMgZm9yIGF1dG8gYWpheCBuYXZpZ2F0aW9uLCBiYXNlIHRhZyBtZ210LAoqLwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgl2YXIgJHdpbmRvdyA9ICQoIHdpbmRvdyApLAoJCSRodG1sID0gJCggJ2h0bWwnICksCgkJJGhlYWQgPSAkKCAnaGVhZCcgKSwKCgkJLy91cmwgcGF0aCBoZWxwZXJzIGZvciB1c2UgaW4gcmVsYXRpdmUgdXJsIG1hbmFnZW1lbnQKCQlwYXRoID0gewoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQl2YXIgYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXSwKCQkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJICAgIC8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCSAgICAvLyBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0ucmVwbGFjZSggL14jLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCBkb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCQl9CgkJCQlyZXR1cm4gYWJzVXJsOwoJCQl9LAoKCQkJLy9nZXQgcGF0aCBmcm9tIGN1cnJlbnQgaGFzaCwgb3IgZnJvbSBhIGZpbGUgcGF0aAoJCQlnZXQ6IGZ1bmN0aW9uKCBuZXdQYXRoICkgewoJCQkJaWYoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gbG9jYXRpb24uaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgJycgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICcmJyArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IGRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBkb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkJLy8gZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoL14jLykudGVzdCggdS5ocmVmICk7CgkJCX0KCQl9LAoKCQkvL3dpbGwgYmUgZGVmaW5lZCB3aGVuIGEgbGluayBpcyBjbGlja2VkIGFuZCBnaXZlbiBhbiBhY3RpdmUgY2xhc3MKCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsLAoKCQkvL3VybEhpc3RvcnkgaXMgcHVyZWx5IGhlcmUgdG8gbWFrZSBndWVzc2VzIGF0IHdoZXRoZXIgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gd2FzIGNsaWNrZWQKCQkvL2FuZCBwcm92aWRlIGFuIGFwcHJvcHJpYXRlIHRyYW5zaXRpb24KCQl1cmxIaXN0b3J5ID0gewoJCQkvLyBBcnJheSBvZiBwYWdlcyB0aGF0IGFyZSB2aXNpdGVkIGR1cmluZyBhIHNpbmdsZSBwYWdlIGxvYWQuCgkJCS8vIEVhY2ggaGFzIGEgdXJsIGFuZCBvcHRpb25hbCB0cmFuc2l0aW9uLCB0aXRsZSwgYW5kIHBhZ2VVcmwgKHdoaWNoIHJlcHJlc2VudHMgdGhlIGZpbGUgcGF0aCwgaW4gY2FzZXMgd2hlcmUgVVJMIGlzIG9ic2N1cmVkLCBzdWNoIGFzIGRpYWxvZ3MpCgkJCXN0YWNrOiBbXSwKCgkJCS8vbWFpbnRhaW4gYW4gaW5kZXggbnVtYmVyIGZvciB0aGUgYWN0aXZlIHBhZ2UgaW4gdGhlIHN0YWNrCgkJCWFjdGl2ZUluZGV4OiAwLAoKCQkJLy9nZXQgYWN0aXZlCgkJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdXJsSGlzdG9yeS5zdGFja1sgdXJsSGlzdG9yeS5hY3RpdmVJbmRleCBdOwoJCQl9LAoKCQkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdXJsSGlzdG9yeS5zdGFja1sgdXJsSGlzdG9yeS5hY3RpdmVJbmRleCAtIDEgXTsKCQkJfSwKCgkJCWdldE5leHQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggKyAxIF07CgkJCX0sCgoJCQkvLyBhZGROZXcgaXMgdXNlZCB3aGVuZXZlciBhIG5ldyBwYWdlIGlzIGFkZGVkCgkJCWFkZE5ldzogZnVuY3Rpb24oIHVybCwgdHJhbnNpdGlvbiwgdGl0bGUsIHBhZ2VVcmwsIHJvbGUgKSB7CgkJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCQlpZiggdXJsSGlzdG9yeS5nZXROZXh0KCkgKSB7CgkJCQkJdXJsSGlzdG9yeS5jbGVhckZvcndhcmQoKTsKCQkJCX0KCgkJCQl1cmxIaXN0b3J5LnN0YWNrLnB1c2goIHt1cmwgOiB1cmwsIHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHRpdGxlOiB0aXRsZSwgcGFnZVVybDogcGFnZVVybCwgcm9sZTogcm9sZSB9ICk7CgoJCQkJdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9IHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoIC0gMTsKCQkJfSwKCgkJCS8vd2lwZSB1cmxzIGFoZWFkIG9mIGFjdGl2ZSBpbmRleAoJCQljbGVhckZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQkJdXJsSGlzdG9yeS5zdGFjayA9IHVybEhpc3Rvcnkuc3RhY2suc2xpY2UoIDAsIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggKyAxICk7CgkJCX0sCgoJCQlkaXJlY3RIYXNoQ2hhbmdlOiBmdW5jdGlvbiggb3B0cyApIHsKCQkJCXZhciBiYWNrICwgZm9yd2FyZCwgbmV3QWN0aXZlSW5kZXgsIHByZXYgPSB0aGlzLmdldEFjdGl2ZSgpOwoKCQkJCS8vIGNoZWNrIGlmIHVybCBpc3AgaW4gaGlzdG9yeSBhbmQgaWYgaXQncyBhaGVhZCBvciBiZWhpbmQgY3VycmVudCBwYWdlCgkJCQkkLmVhY2goIHVybEhpc3Rvcnkuc3RhY2ssIGZ1bmN0aW9uKCBpLCBoaXN0b3J5RW50cnkgKSB7CgoJCQkJCS8vaWYgdGhlIHVybCBpcyBpbiB0aGUgc3RhY2ssIGl0J3MgYSBmb3J3YXJkIG9yIGEgYmFjawoJCQkJCWlmKCBvcHRzLmN1cnJlbnRVcmwgPT09IGhpc3RvcnlFbnRyeS51cmwgKSB7CgkJCQkJCS8vZGVmaW5lIGJhY2sgYW5kIGZvcndhcmQgYnkgd2hldGhlciB1cmwgaXMgb2xkZXIgb3IgbmV3ZXIgdGhhbiBjdXJyZW50IHBhZ2UKCQkJCQkJYmFjayA9IGkgPCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4OwoJCQkJCQlmb3J3YXJkID0gIWJhY2s7CgkJCQkJCW5ld0FjdGl2ZUluZGV4ID0gaTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBzYXZlIG5ldyBwYWdlIGluZGV4LCBudWxsIGNoZWNrIHRvIHByZXZlbnQgZmFsc2V5IDAgcmVzdWx0CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXggIT09IHVuZGVmaW5lZCA/IG5ld0FjdGl2ZUluZGV4IDogdGhpcy5hY3RpdmVJbmRleDsKCgkJCQlpZiggYmFjayApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNCYWNrICkoIHRydWUgKTsKCQkJCX0gZWxzZSBpZiggZm9yd2FyZCApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNGb3J3YXJkICkoIGZhbHNlICk7CgkJCQl9CgkJCX0sCgoJCQkvL2Rpc2FibGUgaGFzaGNoYW5nZSBldmVudCBsaXN0ZW5lciBpbnRlcm5hbGx5IHRvIGlnbm9yZSBvbmUgY2hhbmdlCgkJCS8vdG9nZ2xlZCBpbnRlcm5hbGx5IHdoZW4gbG9jYXRpb24uaGFzaCBpcyB1cGRhdGVkIHRvIG1hdGNoIHRoZSB1cmwgb2YgYSBzdWNjZXNzZnVsIHBhZ2UgbG9hZAoJCQlpZ25vcmVOZXh0SGFzaENoYW5nZTogZmFsc2UKCQl9LAoKCQkvL2RlZmluZSBmaXJzdCBzZWxlY3RvciB0byByZWNlaXZlIGZvY3VzIHdoZW4gYSBwYWdlIGlzIHNob3duCgkJZm9jdXNhYmxlID0gIlt0YWJpbmRleF0sYSxidXR0b246dmlzaWJsZSxzZWxlY3Q6dmlzaWJsZSxpbnB1dCIsCgoJCS8vcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJCXBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy9pbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2UsCgoJCS8vbm9uc2Vuc2UgaGFzaCBjaGFuZ2Uga2V5IGZvciBkaWFsb2dzLCBzbyB0aGV5IGNyZWF0ZSBhIGhpc3RvcnkgZW50cnkKCQlkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciLAoKCQkvL2V4aXN0aW5nIGJhc2UgdGFnPwoJCSRiYXNlID0gJGhlYWQuY2hpbGRyZW4oICJiYXNlIiApLAoKCQkvL3R1Y2sgYXdheSB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgVVJMIG1pbnVzIGFueSBmcmFnbWVudC4KCQlkb2N1bWVudFVybCA9IHBhdGgucGFyc2VVcmwoIGxvY2F0aW9uLmhyZWYgKSwKCgkJLy9pZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGVtYmVkZGVkIGJhc2UgdGFnLCBkb2N1bWVudEJhc2UgaXMgc2V0IHRvIGl0cwoJCS8vaW5pdGlhbCB2YWx1ZS4gSWYgYSBiYXNlIHRhZyBkb2VzIG5vdCBleGlzdCwgdGhlbiB3ZSBkZWZhdWx0IHRvIHRoZSBkb2N1bWVudFVybC4KCQlkb2N1bWVudEJhc2UgPSAkYmFzZS5sZW5ndGggPyBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGJhc2UuYXR0ciggImhyZWYiICksIGRvY3VtZW50VXJsLmhyZWYgKSApIDogZG9jdW1lbnRVcmwsCgoJCS8vY2FjaGUgdGhlIGNvbXBhcmlzb24gb25jZS4KCQlkb2N1bWVudEJhc2VEaWZmZXJzID0gKCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICE9PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApOwoKCQkvL2Jhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCQl2YXIgYmFzZSA9ICQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyA/IHsKCgkJCS8vZGVmaW5lIGJhc2UgZWxlbWVudCwgZm9yIHVzZSBpbiByb3V0aW5nIGFzc2V0IHVybHMgdGhhdCBhcmUgcmVmZXJlbmNlZCBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQkJZWxlbWVudDogKCAkYmFzZS5sZW5ndGggPyAkYmFzZSA6ICQoICI8YmFzZT4iLCB7IGhyZWY6IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoIH0gKS5wcmVwZW5kVG8oICRoZWFkICkgKSwKCgkJCS8vc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiBhdHRyaWJ1dGUgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBocmVmICkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwgcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGRvY3VtZW50QmFzZSApICk7CgkJCX0sCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwgZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKTsKCQkJfQoKCQl9IDogdW5kZWZpbmVkOwoKLyoKCWludGVybmFsIHV0aWxpdHkgZnVuY3Rpb25zCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy9kaXJlY3QgZm9jdXMgdG8gdGhlIHBhZ2UgdGl0bGUsIG9yIG90aGVyd2lzZSBmaXJzdCBmb2N1c2FibGUgZWxlbWVudAoJZnVuY3Rpb24gcmVGb2N1cyggcGFnZSApIHsKCQl2YXIgcGFnZVRpdGxlID0gcGFnZS5maW5kKCAiLnVpLXRpdGxlOmVxKDApIiApOwoKCQlpZiggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfQoJCWVsc2V7CgkJCXBhZ2UuZm9jdXMoKTsKCQl9Cgl9CgoJLy9yZW1vdmUgYWN0aXZlIGNsYXNzZXMgYWZ0ZXIgcGFnZSB0cmFuc2l0aW9uIG9yIGVycm9yCglmdW5jdGlvbiByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIGZvcmNlUmVtb3ZhbCApIHsKCQlpZiggISEkYWN0aXZlQ2xpY2tlZExpbmsgJiYgKCAhJGFjdGl2ZUNsaWNrZWRMaW5rLmNsb3Nlc3QoICcudWktcGFnZS1hY3RpdmUnICkubGVuZ3RoIHx8IGZvcmNlUmVtb3ZhbCApICkgewoJCQkkYWN0aXZlQ2xpY2tlZExpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfQoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGw7Cgl9CgoJZnVuY3Rpb24gcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpIHsKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJaWYoIHBhZ2VUcmFuc2l0aW9uUXVldWUubGVuZ3RoID4gMCApIHsKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZS5hcHBseSggbnVsbCwgcGFnZVRyYW5zaXRpb25RdWV1ZS5wb3AoKSApOwoJCX0KCX0KCgkvLyBTYXZlIHRoZSBsYXN0IHNjcm9sbCBkaXN0YW5jZSBwZXIgcGFnZSwgYmVmb3JlIGl0IGlzIGhpZGRlbgoJdmFyIHNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZSwKCQlmaXJzdFNjcm9sbEVsZW0sIGdldFNjcm9sbEVsZW0sIHNldExhc3RTY3JvbGwsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsOwoKCWdldFNjcm9sbEVsZW0gPSBmdW5jdGlvbigpIHsKCQl2YXIgc2Nyb2xsRWxlbSA9ICR3aW5kb3csIGFjdGl2ZVBhZ2UsCgkJCXRvdWNoT3ZlcmZsb3cgPSAkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyAmJiAkLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZDsKCgkJaWYoIHRvdWNoT3ZlcmZsb3cgKXsKCQkJYWN0aXZlUGFnZSA9ICQoICIudWktcGFnZS1hY3RpdmUiICk7CgkJCXNjcm9sbEVsZW0gPSBhY3RpdmVQYWdlLmlzKCAiLnVpLW5hdGl2ZS1maXhlZCIgKSA/IGFjdGl2ZVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApIDogYWN0aXZlUGFnZTsKCQl9CgoJCXJldHVybiBzY3JvbGxFbGVtOwoJfTsKCglzZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oIHNjcm9sbEVsZW0gKSB7CgkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbiB0aGUgYnJvd3NlcgoJCS8vIHNjcm9sbGluZyB0aGUgd2luZG93IGJhc2VkIG9uIGEgaGFzaGNoYW5nZQoJCWlmKCAhc2V0TGFzdFNjcm9sbEVuYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQlpZiggYWN0aXZlICkgewoJCQl2YXIgbGFzdFNjcm9sbCA9IHNjcm9sbEVsZW0gJiYgc2Nyb2xsRWxlbS5zY3JvbGxUb3AoKTsKCgkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4KCQkJLy8gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlIHNjcm9sbGluZyB0byBpcyBsZXNzIHRoYW4gbWluU2Nyb2xsQmFjaywgbGV0IGl0IGdvLgoJCQlhY3RpdmUubGFzdFNjcm9sbCA9IGxhc3RTY3JvbGwgPCAkLm1vYmlsZS5taW5TY3JvbGxCYWNrID8gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgOiBsYXN0U2Nyb2xsOwoJCX0KCX07CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIHRvIGdhdGhlciBzY3JvbGwgcG9zaXRpb24uIFRoZSBkZWxheSBhbGxvd3MgZm9yIHRoZSBoYXNoY2hhbmdlCgkvLyBldmVudCB0byBmaXJlIGFuZCBkaXNhYmxlIHNjcm9sbCByZWNvcmRpbmcgaW4gdGhlIGNhc2Ugd2hlcmUgdGhlIGJyb3dzZXIgc2Nyb2xscwoJLy8gdG8gdGhlIGhhc2ggdGFyZ2V0cyBsb2NhdGlvbiAoc29tZXRpbWVzIHRoZSB0b3Agb2YgdGhlIHBhZ2UpLiBvbmNlIHBhZ2VjaGFuZ2UgZmlyZXMKCS8vIGdldExhc3RTY3JvbGwgaXMgYWdhaW4gcGVybWl0dGVkIHRvIG9wZXJhdGUKCWRlbGF5ZWRTZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJc2V0VGltZW91dCggc2V0TGFzdFNjcm9sbCwgMTAwLCAkKHRoaXMpICk7Cgl9OwoKCS8vIGRpc2FibGUgYW4gc2Nyb2xsIHNldHRpbmcgd2hlbiBhIGhhc2hjaGFuZ2UgaGFzIGJlZW4gZmlyZWQsIHRoaXMgb25seSB3b3JrcwoJLy8gYmVjYXVzZSB0aGUgcmVjb3JkaW5nIG9mIHRoZSBzY3JvbGwgcG9zaXRpb24gaXMgZGVsYXllZCBmb3IgMTAwbXMgYWZ0ZXIKCS8vIHRoZSBicm93c2VyIG1pZ2h0IGhhdmUgY2hhbmdlZCB0aGUgcG9zaXRpb24gYmVjYXVzZSBvZiB0aGUgaGFzaGNoYW5nZQoJJHdpbmRvdy5iaW5kKCAkLnN1cHBvcnQucHVzaFN0YXRlID8gInBvcHN0YXRlIiA6ICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkgCXNldExhc3RTY3JvbGxFbmFibGVkID0gZmFsc2U7Cgl9KTsKCgkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkkd2luZG93Lm9uZSggJC5zdXBwb3J0LnB1c2hTdGF0ZSA/ICJwb3BzdGF0ZSIgOiAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCX0pOwoKCS8vIHdhaXQgdW50aWwgdGhlIG1vYmlsZSBwYWdlIGNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIHRvIGJpbmQgdG8gcGFnZWNoYW5nZQoJJHdpbmRvdy5vbmUoICJwYWdlY29udGFpbmVyY3JlYXRlIiwgZnVuY3Rpb24oKXsKCQkvLyBvbmNlIHRoZSBwYWdlIGhhcyBjaGFuZ2VkLCByZS1lbmFibGUgdGhlIHNjcm9sbCByZWNvcmRpbmcKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmJpbmQoICJwYWdlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkJCXZhciBzY3JvbGxFbGVtID0gZ2V0U2Nyb2xsRWxlbSgpOwoKCSAJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQgZGV0ZXJtaW5lZCBmb3IKCQkJLy8gdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJc2Nyb2xsRWxlbS51bmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkJCS8vIGRldGVybWluZSBhbmQgYmluZCB0byB0aGUgY3VycmVudCBzY29sbCBlbGVtZW50IHdoaWNoIG1heSBiZSB0aGUgd2luZG93CgkJCS8vIG9yIGluIHRoZSBjYXNlIG9mIHRvdWNoIG92ZXJmbG93IHRoZSBlbGVtZW50IHdpdGggdG91Y2ggb3ZlcmZsb3cKCQkJc2Nyb2xsRWxlbS5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgkJfSk7Cgl9KTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlIGFzICJwYWdlY2hhbmdlIiB3b24ndCBiZSBmaXJlZCBpbiB0aGF0IGNhc2UKCWdldFNjcm9sbEVsZW0oKS5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgoJLy8gTWFrZSB0aGUgaU9TIGNsb2NrIHF1aWNrLXNjcm9sbCB3b3JrIGFnYWluIGlmIHdlJ3JlIHVzaW5nIG5hdGl2ZSBvdmVyZmxvdyBzY3JvbGxpbmcKCS8qCglpZiggJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgKXsKCQlpZiggJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgKXsKCQkJJCggd2luZG93ICkuYmluZCggInNjcm9sbHN0b3AiLCBmdW5jdGlvbigpewoJCQkJaWYoICQoIHRoaXMgKS5zY3JvbGxUb3AoKSA9PT0gMCApewoJCQkJCSQubW9iaWxlLmFjdGl2ZVBhZ2Uuc2Nyb2xsVG9wKCAwICk7CgkJCQl9CgkJCX0pOwoJCX0KCX0KCSovCgoJLy9mdW5jdGlvbiBmb3IgdHJhbnNpdGlvbmluZyBiZXR3ZWVuIHR3byBleGlzdGluZyBwYWdlcwoJZnVuY3Rpb24gdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCB0cmFuc2l0aW9uLCByZXZlcnNlICkgewoKCQkvL2dldCBjdXJyZW50IHNjcm9sbCBkaXN0YW5jZQoJCXZhciBhY3RpdmUJPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpLAoJCQl0b3VjaE92ZXJmbG93ID0gJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQsCgkJCXRvU2Nyb2xsID0gYWN0aXZlLmxhc3RTY3JvbGwgfHwgKCB0b3VjaE92ZXJmbG93ID8gMCA6ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICksCgkJCXNjcmVlbkhlaWdodCA9IGdldFNjcmVlbkhlaWdodCgpOwoKCQkvLyBTY3JvbGwgdG8gdG9wLCBoaWRlIGFkZHIgYmFyCgkJd2luZG93LnNjcm9sbFRvKCAwLCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApOwoKCQlpZiggZnJvbVBhZ2UgKSB7CgkJCS8vdHJpZ2dlciBiZWZvcmUgc2hvdy9oaWRlIGV2ZW50cwoJCQlmcm9tUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZWhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCX0KCgkJaWYoICF0b3VjaE92ZXJmbG93KXsKCQkJdG9QYWdlLmhlaWdodCggc2NyZWVuSGVpZ2h0ICsgdG9TY3JvbGwgKTsKCQl9CgoJCXRvUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZXNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCgkJLy9jbGVhciBwYWdlIGxvYWRlcgoJCSQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZygpOwoKCQlpZiggdG91Y2hPdmVyZmxvdyAmJiB0b1Njcm9sbCApewoKCQkJdG9QYWdlLmFkZENsYXNzKCAidWktbW9iaWxlLXByZS10cmFuc2l0aW9uIiApOwoJCQkvLyBTZW5kIGZvY3VzIHRvIHBhZ2UgYXMgaXQgaXMgbm93IGRpc3BsYXk6IGJsb2NrCgkJCXJlRm9jdXMoIHRvUGFnZSApOwoKCQkJLy9zZXQgcGFnZSdzIHNjcm9sbFRvcCB0byByZW1lbWJlcmVkIGRpc3RhbmNlCgkJCWlmKCB0b1BhZ2UuaXMoICIudWktbmF0aXZlLWZpeGVkIiApICl7CgkJCQl0b1BhZ2UuZmluZCggIi51aS1jb250ZW50IiApLnNjcm9sbFRvcCggdG9TY3JvbGwgKTsKCQkJfQoJCQllbHNlewoJCQkJdG9QYWdlLnNjcm9sbFRvcCggdG9TY3JvbGwgKTsKCQkJfQoJCX0KCgkJLy9maW5kIHRoZSB0cmFuc2l0aW9uIGhhbmRsZXIgZm9yIHRoZSBzcGVjaWZpZWQgdHJhbnNpdGlvbi4gSWYgdGhlcmUKCQkvL2lzbid0IG9uZSBpbiBvdXIgdHJhbnNpdGlvbkhhbmRsZXJzIGRpY3Rpb25hcnksIHVzZSB0aGUgZGVmYXVsdCBvbmUuCgkJLy9jYWxsIHRoZSBoYW5kbGVyIGltbWVkaWF0ZWx5IHRvIGtpY2stb2ZmIHRoZSB0cmFuc2l0aW9uLgoJCXZhciB0aCA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVyc1t0cmFuc2l0aW9uIHx8ICJub25lIl0gfHwgJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyLAoJCQlwcm9taXNlID0gdGgoIHRyYW5zaXRpb24sIHJldmVyc2UsIHRvUGFnZSwgZnJvbVBhZ2UgKTsKCgkJcHJvbWlzZS5kb25lKGZ1bmN0aW9uKCkgewoJCQkvL3Jlc2V0IHRvUGFnZSBoZWlnaHQgYmFjawoJCQlpZiggIXRvdWNoT3ZlcmZsb3cgKXsKCQkJCXRvUGFnZS5oZWlnaHQoICIiICk7CgkJCQkvLyBTZW5kIGZvY3VzIHRvIHRoZSBuZXdseSBzaG93biBwYWdlCgkJCQlyZUZvY3VzKCB0b1BhZ2UgKTsKCQkJfQoKCQkJLy8gSnVtcCB0byB0b3Agb3IgcHJldiBzY3JvbGwsIHNvbWV0aW1lcyBvbiBpT1MgdGhlIHBhZ2UgaGFzIG5vdCByZW5kZXJlZCB5ZXQuCgkJCWlmKCAhdG91Y2hPdmVyZmxvdyApewoJCQkJJC5tb2JpbGUuc2lsZW50U2Nyb2xsKCB0b1Njcm9sbCApOwoJCQl9CgoJCQkvL3RyaWdnZXIgc2hvdy9oaWRlIGV2ZW50cwoJCQlpZiggZnJvbVBhZ2UgKSB7CgkJCQlpZiggIXRvdWNoT3ZlcmZsb3cgKXsKCQkJCQlmcm9tUGFnZS5oZWlnaHQoICIiICk7CgkJCQl9CgoJCQkJZnJvbVBhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJoaWRlIiwgbnVsbCwgeyBuZXh0UGFnZTogdG9QYWdlIH0gKTsKCQkJfQoKCQkJLy90cmlnZ2VyIHBhZ2VzaG93LCBkZWZpbmUgcHJldlBhZ2UgYXMgZWl0aGVyIGZyb21QYWdlIG9yIGVtcHR5IGpRdWVyeSBvYmoKCQkJdG9QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAic2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoJCX0pOwoKCQlyZXR1cm4gcHJvbWlzZTsKCX0KCgkvL3NpbXBseSBzZXQgdGhlIGFjdGl2ZSBwYWdlJ3MgbWluaW11bSBoZWlnaHQgdG8gc2NyZWVuIGhlaWdodCwgZGVwZW5kaW5nIG9uIG9yaWVudGF0aW9uCglmdW5jdGlvbiBnZXRTY3JlZW5IZWlnaHQoKXsKCQl2YXIgb3JpZW50YXRpb24gCT0gJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCksCgkJCXBvcnQJCQk9IG9yaWVudGF0aW9uID09PSAicG9ydHJhaXQiLAoJCQl3aW5NaW4JCQk9IHBvcnQgPyA0ODAgOiAzMjAsCgkJCXNjcmVlbkhlaWdodAk9IHBvcnQgPyBzY3JlZW4uYXZhaWxIZWlnaHQgOiBzY3JlZW4uYXZhaWxXaWR0aCwKCQkJd2luSGVpZ2h0CQk9IE1hdGgubWF4KCB3aW5NaW4sICQoIHdpbmRvdyApLmhlaWdodCgpICksCgkJCXBhZ2VNaW4JCQk9IE1hdGgubWluKCBzY3JlZW5IZWlnaHQsIHdpbkhlaWdodCApOwoKCQlyZXR1cm4gcGFnZU1pbjsKCX0KCgkkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQgPSBnZXRTY3JlZW5IZWlnaHQ7CgoJLy9zaW1wbHkgc2V0IHRoZSBhY3RpdmUgcGFnZSdzIG1pbmltdW0gaGVpZ2h0IHRvIHNjcmVlbiBoZWlnaHQsIGRlcGVuZGluZyBvbiBvcmllbnRhdGlvbgoJZnVuY3Rpb24gcmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCl7CgkJLy8gRG9uJ3QgYXBwbHkgdGhpcyBoZWlnaHQgaW4gdG91Y2ggb3ZlcmZsb3cgZW5hYmxlZCBtb2RlCgkJaWYoICQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICYmICQubW9iaWxlLnRvdWNoT3ZlcmZsb3dFbmFibGVkICl7CgkJCXJldHVybjsKCQl9CgkJJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICkuY3NzKCAibWluLWhlaWdodCIsIGdldFNjcmVlbkhlaWdodCgpICk7Cgl9CgoJLy9zaGFyZWQgcGFnZSBlbmhhbmNlbWVudHMKCWZ1bmN0aW9uIGVuaGFuY2VQYWdlKCAkcGFnZSwgcm9sZSApIHsKCQkvLyBJZiBhIHJvbGUgd2FzIHNwZWNpZmllZCwgbWFrZSBzdXJlIHRoZSBkYXRhLXJvbGUgYXR0cmlidXRlCgkJLy8gb24gdGhlIHBhZ2UgZWxlbWVudCBpcyBpbiBzeW5jLgoJCWlmKCByb2xlICkgewoJCQkkcGFnZS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHJvbGUgKTsKCQl9CgoJCS8vcnVuIHBhZ2UgcGx1Z2luCgkJJHBhZ2UucGFnZSgpOwoJfQoKLyogZXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzCSAqLwoKCS8vYW5pbWF0aW9uIGNvbXBsZXRlIGNhbGxiYWNrCgkkLmZuLmFuaW1hdGlvbkNvbXBsZXRlID0gZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCWlmKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgKSB7CgkJCXJldHVybiAkKCB0aGlzICkub25lKCAnd2Via2l0QW5pbWF0aW9uRW5kJywgY2FsbGJhY2sgKTsKCQl9CgkJZWxzZXsKCQkJLy8gZGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCXJldHVybiAkKCB0aGlzICk7CgkJfQoJfTsKCgkvL2V4cG9zZSBwYXRoIG9iamVjdCBvbiAkLm1vYmlsZQoJJC5tb2JpbGUucGF0aCA9IHBhdGg7CgoJLy9leHBvc2UgYmFzZSBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLmJhc2UgPSBiYXNlOwoKCS8vaGlzdG9yeSBzdGFjawoJJC5tb2JpbGUudXJsSGlzdG9yeSA9IHVybEhpc3Rvcnk7CgoJJC5tb2JpbGUuZGlhbG9nSGFzaEtleSA9IGRpYWxvZ0hhc2hLZXk7CgoJLy9kZWZhdWx0IG5vbi1hbmltYXRpb24gdHJhbnNpdGlvbiBoYW5kbGVyCgkkLm1vYmlsZS5ub25lVHJhbnNpdGlvbkhhbmRsZXIgPSBmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvUGFnZSwgJGZyb21QYWdlICkgewoJCWlmICggJGZyb21QYWdlICkgewoJCQkkZnJvbVBhZ2UucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApOwoJCX0KCQkkdG9QYWdlLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCgkJcmV0dXJuICQuRGVmZXJyZWQoKS5yZXNvbHZlKCBuYW1lLCByZXZlcnNlLCAkdG9QYWdlLCAkZnJvbVBhZ2UgKS5wcm9taXNlKCk7Cgl9OwoKCS8vZGVmYXVsdCBoYW5kbGVyIGZvciB1bmtub3duIHRyYW5zaXRpb25zCgkkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSAkLm1vYmlsZS5ub25lVHJhbnNpdGlvbkhhbmRsZXI7CgoJLy90cmFuc2l0aW9uIGhhbmRsZXIgZGljdGlvbmFyeSBmb3IgM3JkIHBhcnR5IHRyYW5zaXRpb25zCgkkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMgPSB7CgkJbm9uZTogJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyCgl9OwoKCS8vZW5hYmxlIGNyb3NzLWRvbWFpbiBwYWdlIHN1cHBvcnQKCSQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyA9IGZhbHNlOwoKCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCSQubW9iaWxlLmdldERvY3VtZW50VXJsID0gZnVuY3Rpb24oYXNQYXJzZWRPYmplY3QpIHsKCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIGRvY3VtZW50VXJsICkgOiBkb2N1bWVudFVybC5ocmVmOwoJfTsKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCSQubW9iaWxlLmdldERvY3VtZW50QmFzZSA9IGZ1bmN0aW9uKGFzUGFyc2VkT2JqZWN0KSB7CgkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBkb2N1bWVudEJhc2UgKSA6IGRvY3VtZW50QmFzZS5ocmVmOwoJfTsKCgkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUgPSBmdW5jdGlvbigpIHsKCQl2YXIgcGFnZSA9ICQodGhpcyk7CgoJCS8vIHdoZW4gZG9tIGNhY2hpbmcgaXMgbm90IGVuYWJsZWQgb3IgdGhlIHBhZ2UgaXMgZW1iZWRkZWQgYmluZCB0byByZW1vdmUgdGhlIHBhZ2Ugb24gaGlkZQoJCWlmKCAhcGFnZS5kYXRhKCJwYWdlIikub3B0aW9ucy5kb21DYWNoZQoJCQkJJiYgcGFnZS5pcygiOmpxbURhdGEoZXh0ZXJuYWwtcGFnZT0ndHJ1ZScpIikgKSB7CgoJCQlwYWdlLmJpbmQoICdwYWdlaGlkZS5yZW1vdmUnLCBmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQlwckV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlcmVtb3ZlIiApOwoKCQkJCSR0aGlzLnRyaWdnZXIoIHByRXZlbnQgKTsKCgkJCQlpZiggIXByRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJfQoJCQl9KTsKCQl9Cgl9OwoKCS8vIExvYWQgYSBwYWdlIGludG8gdGhlIERPTS4KCSQubW9iaWxlLmxvYWRQYWdlID0gZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkvLyBUaGlzIGZ1bmN0aW9uIHVzZXMgZGVmZXJyZWQgbm90aWZpY2F0aW9ucyB0byBsZXQgY2FsbGVycwoJCS8vIGtub3cgd2hlbiB0aGUgcGFnZSBpcyBkb25lIGxvYWRpbmcsIG9yIGlmIGFuIGVycm9yIGhhcyBvY2N1cnJlZC4KCQl2YXIgZGVmZXJyZWQgPSAkLkRlZmVycmVkKCksCgoJCQkvLyBUaGUgZGVmYXVsdCBsb2FkUGFnZSBvcHRpb25zIHdpdGggb3ZlcnJpZGVzIHNwZWNpZmllZCBieQoJCQkvLyB0aGUgY2FsbGVyLgoJCQlzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUubG9hZFBhZ2UuZGVmYXVsdHMsIG9wdGlvbnMgKSwKCgkJCS8vIFRoZSBET00gZWxlbWVudCBmb3IgdGhlIHBhZ2UgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9hZGVkLgoJCQlwYWdlID0gbnVsbCwKCgkJCS8vIElmIHRoZSByZWxvYWRQYWdlIG9wdGlvbiBpcyB0cnVlLCBhbmQgdGhlIHBhZ2UgaXMgYWxyZWFkeQoJCQkvLyBpbiB0aGUgRE9NLCBkdXBDYWNoZWRQYWdlIHdpbGwgYmUgc2V0IHRvIHRoZSBwYWdlIGVsZW1lbnQKCQkJLy8gc28gdGhhdCBpdCBjYW4gYmUgcmVtb3ZlZCBhZnRlciB0aGUgbmV3IHZlcnNpb24gb2YgdGhlCgkJCS8vIHBhZ2UgaXMgbG9hZGVkIG9mZiB0aGUgbmV0d29yay4KCQkJZHVwQ2FjaGVkUGFnZSA9IG51bGwsCgoJCQkvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYmFzZSB1cmwKCQkJZmluZEJhc2VXaXRoRGVmYXVsdCA9IGZ1bmN0aW9uKCl7CgkJCQl2YXIgY2xvc2VzdEJhc2UgPSAoICQubW9iaWxlLmFjdGl2ZVBhZ2UgJiYgZ2V0Q2xvc2VzdEJhc2VVcmwoICQubW9iaWxlLmFjdGl2ZVBhZ2UgKSApOwoJCQkJcmV0dXJuIGNsb3Nlc3RCYXNlIHx8IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoJCQl9LAoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBwYXNzZWQgaW50byB0aGUgZnVuY3Rpb24uIFRoaXMKCQkJLy8gdmVyc2lvbiBvZiB0aGUgVVJMIG1heSBjb250YWluIGRpYWxvZy9zdWJwYWdlIHBhcmFtcyBpbiBpdC4KCQkJYWJzVXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgZmluZEJhc2VXaXRoRGVmYXVsdCgpICk7CgoKCQkvLyBJZiB0aGUgY2FsbGVyIHByb3ZpZGVkIGRhdGEsIGFuZCB3ZSdyZSB1c2luZyAiZ2V0IiByZXF1ZXN0LAoJCS8vIGFwcGVuZCB0aGUgZGF0YSB0byB0aGUgVVJMLgoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJYWJzVXJsID0gcGF0aC5hZGRTZWFyY2hQYXJhbXMoIGFic1VybCwgc2V0dGluZ3MuZGF0YSApOwoJCQlzZXR0aW5ncy5kYXRhID0gdW5kZWZpbmVkOwoJCX0KCgkJLy8gSWYgdGhlIGNhbGxlciBpcyB1c2luZyBhICJwb3N0IiByZXF1ZXN0LCByZWxvYWRQYWdlIG11c3QgYmUgdHJ1ZQoJCWlmKCAgc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAicG9zdCIgKXsKCQkJc2V0dGluZ3MucmVsb2FkUGFnZSA9IHRydWU7CgkJfQoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YnBhZ2UgcGFyYW1zLgoJCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgcGFnZSB0byBiZSBsb2FkZWQuCgkJdmFyIGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCBhYnNVcmwgKSwKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIHBhZ2UuIEZvciBlbWJlZGRlZCBwYWdlcywgaXQgaXMganVzdCB0aGUgaWQgb2YgdGhlIHBhZ2UuIEZvciBwYWdlcwoJCQkvLyB3aXRoaW4gdGhlIHNhbWUgZG9tYWluIGFzIHRoZSBkb2N1bWVudCBiYXNlLCBpdCBpcyB0aGUgc2l0ZSByZWxhdGl2ZQoJCQkvLyBwYXRoLiBGb3IgY3Jvc3MtZG9tYWluIHBhZ2VzIChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZSBhYnNvbHV0ZSBVcmwKCQkJLy8gdXNlZCB0byBsb2FkIHRoZSBwYWdlLgoJCQlkYXRhVXJsID0gcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBhYnNVcmwgKTsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBwYWdlQ29udGFpbmVyIHRvIHdvcmsgd2l0aC4KCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkvLyBDaGVjayB0byBzZWUgaWYgdGhlIHBhZ2UgYWxyZWFkeSBleGlzdHMgaW4gdGhlIERPTS4KCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIjpqcW1EYXRhKHVybD0nIiArIGRhdGFVcmwgKyAiJykiICk7CgoJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIHRoZSBwYWdlLCBjaGVjayB0byBzZWUgaWYgdGhlIHVybCBpcyBhCgkJLy8gcmVmZXJlbmNlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuIElmIHNvLCBpdCBtYXkgaGF2ZSBiZWVuIGR5bmFtaWNhbGx5CgkJLy8gaW5qZWN0ZWQgYnkgYSBkZXZlbG9wZXIsIGluIHdoaWNoIGNhc2UgaXQgd291bGQgYmUgbGFja2luZyBhIGRhdGEtdXJsCgkJLy8gYXR0cmlidXRlIGFuZCBpbiBuZWVkIG9mIGVuaGFuY2VtZW50LgoJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYgZGF0YVVybCAmJiAhcGF0aC5pc1BhdGgoIGRhdGFVcmwgKSApIHsKCQkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICIjIiArIGRhdGFVcmwgKQoJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCBkYXRhVXJsICk7CgkJfQoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCBhIHBhZ2UgaW4gdGhlIERPTSwgY2hlY2sgdGhlIFVSTCB0byBzZWUgaWYgaXQKCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZQoJCS8vIHRvIHRoZSBmaXJzdCBwYWdlIGFuZCByZWZlcnMgdG8gbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UsIGVycm9yIG91dC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICkgewoJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZSAmJiBwYXRoLmlzRmlyc3RQYWdlVXJsKCBmaWxlVXJsICkgKSB7CgkJCQkvLyBDaGVjayB0byBtYWtlIHN1cmUgb3VyIGNhY2hlZC1maXJzdC1wYWdlIGlzIGFjdHVhbGx5CgkJCQkvLyBpbiB0aGUgRE9NLiBTb21lIHVzZXIgZGVwbG95ZWQgYXBwcyBhcmUgcHJ1bmluZyB0aGUgZmlyc3QKCQkJCS8vIHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMsIHdlIGNoZWNrIGZvciB0aGlzCgkJCQkvLyBjYXNlIGhlcmUgYmVjYXVzZSB3ZSBkb24ndCB3YW50IGEgZmlyc3QtcGFnZSB3aXRoIGFuIGlkCgkJCQkvLyBmYWxsaW5nIHRocm91Z2ggdG8gdGhlIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlIGVycm9yCgkJCQkvLyBjYXNlLiBJZiB0aGUgZmlyc3QtcGFnZSBpcyBub3QgaW4gdGhlIERPTSwgdGhlbiB3ZSBsZXQKCQkJCS8vIHRoaW5ncyBmYWxsIHRocm91Z2ggdG8gdGhlIGFqYXggbG9hZGluZyBjb2RlIGJlbG93IHNvCgkJCQkvLyB0aGF0IGl0IGdldHMgcmVsb2FkZWQuCgkJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZS5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCQkJcGFnZSA9ICQoICQubW9iaWxlLmZpcnN0UGFnZSApOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCBmaWxlVXJsICkgICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQl9CgoJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZS4KCQlpZiAoIGJhc2UgKSB7CgkJCWJhc2UucmVzZXQoKTsKCQl9CgoJCS8vIElmIHRoZSBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluIGlzIGFscmVhZHkgaW4gdGhlIERPTSwKCQkvLyBhbmQgdGhlIGNhbGxlciBkaWQgbm90IGluZGljYXRlIHRoYXQgd2Ugc2hvdWxkIGZvcmNlIGEKCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBPdGhlcndpc2UsIHRyYWNrIHRoZQoJCS8vIGV4aXN0aW5nIHBhZ2UgYXMgYSBkdXBsaWNhdGVkLgoJCWlmICggcGFnZS5sZW5ndGggKSB7CgkJCWlmICggIXNldHRpbmdzLnJlbG9hZFBhZ2UgKSB7CgkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlICk7CgkJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCQl9CgkJCWR1cENhY2hlZFBhZ2UgPSBwYWdlOwoJCX0KCgkJdmFyIG1wYyA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIsCgkJCXBibEV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlbG9hZCIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHVybDogdXJsLCBhYnNVcmw6IGFic1VybCwgZGF0YVVybDogZGF0YVVybCwgZGVmZXJyZWQ6IGRlZmVycmVkLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBhIHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBibEV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiggcGJsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQl9CgoJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgoJCQkvLyBUaGlzIGNvbmZpZ3VyYWJsZSB0aW1lb3V0IGFsbG93cyBjYWNoZWQgcGFnZXMgYSBicmllZiBkZWxheSB0byBsb2FkIHdpdGhvdXQgc2hvd2luZyBhIG1lc3NhZ2UKCQkJdmFyIGxvYWRNc2dEZWxheSA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCQkJCX0sIHNldHRpbmdzLmxvYWRNc2dEZWxheSApLAoKCQkJCS8vIFNoYXJlZCBsb2dpYyBmb3IgY2xlYXJpbmcgdGltZW91dCBhbmQgcmVtb3ZpbmcgbWVzc2FnZS4KCQkJCWhpZGVNc2cgPSBmdW5jdGlvbigpewoKCQkJCQkvLyBTdG9wIG1lc3NhZ2Ugc2hvdyB0aW1lcgoJCQkJCWNsZWFyVGltZW91dCggbG9hZE1zZ0RlbGF5ICk7CgoJCQkJCS8vIEhpZGUgbG9hZGluZyBtZXNzYWdlCgkJCQkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9OwoJCX0KCgkJaWYgKCAhKCAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgfHwgcGF0aC5pc1NhbWVEb21haW4oIGRvY3VtZW50VXJsLCBhYnNVcmwgKSApICkgewoJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCX0gZWxzZSB7CgkJCS8vIExvYWQgdGhlIG5ldyBwYWdlLgoJCQkkLmFqYXgoewoJCQkJdXJsOiBmaWxlVXJsLAoJCQkJdHlwZTogc2V0dGluZ3MudHlwZSwKCQkJCWRhdGE6IHNldHRpbmdzLmRhdGEsCgkJCQlkYXRhVHlwZTogImh0bWwiLAoJCQkJc3VjY2VzczogZnVuY3Rpb24oIGh0bWwsIHRleHRTdGF0dXMsIHhociApIHsKCQkJCQkvL3ByZS1wYXJzZSBodG1sIHRvIGNoZWNrIGZvciBhIGRhdGEtdXJsLAoJCQkJCS8vdXNlIGl0IGFzIHRoZSBuZXcgZmlsZVVybCwgYmFzZSBwYXRoLCBldGMKCQkJCQl2YXIgYWxsID0gJCggIjxkaXY+PC9kaXY+IiApLAoKCQkJCQkJLy9wYWdlIHRpdGxlIHJlZ2V4cAoJCQkJCQluZXdQYWdlVGl0bGUgPSBodG1sLm1hdGNoKCAvPHRpdGxlW14+XSo+KFtePF0qKS8gKSAmJiBSZWdFeHAuJDEsCgoJCQkJCQkvLyBUT0RPIGhhbmRsZSBkaWFsb2dzIGFnYWluCgkJCQkJCXBhZ2VFbGVtUmVnZXggPSBuZXcgUmVnRXhwKCAiKDxbXj5dK1xcYmRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9W1wiJ10/cGFnZVtcIiddP1tePl0qPikiICksCgkJCQkJCWRhdGFVcmxSZWdleCA9IG5ldyBSZWdFeHAoICJcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmw9W1wiJ10/KFteXCInPl0qKVtcIiddPyIgKTsKCgoJCQkJCS8vIGRhdGEtdXJsIG11c3QgYmUgcHJvdmlkZWQgZm9yIHRoZSBiYXNlIHRhZyBzbyByZXNvdXJjZSByZXF1ZXN0cyBjYW4gYmUgZGlyZWN0ZWQgdG8gdGhlCgkJCQkJLy8gY29ycmVjdCB1cmwuIGxvYWRpbmcgaW50byBhIHRlbXByb3JhcnkgZWxlbWVudCBtYWtlcyB0aGVzZSByZXF1ZXN0cyBpbW1lZGlhdGVseQoJCQkJCWlmKCBwYWdlRWxlbVJlZ2V4LnRlc3QoIGh0bWwgKQoJCQkJCQkJJiYgUmVnRXhwLiQxCgkJCQkJCQkmJiBkYXRhVXJsUmVnZXgudGVzdCggUmVnRXhwLiQxICkKCQkJCQkJCSYmIFJlZ0V4cC4kMSApIHsKCQkJCQkJdXJsID0gZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIFJlZ0V4cC4kMSApOwoJCQkJCX0KCgkJCQkJaWYgKCBiYXNlICkgewoJCQkJCQliYXNlLnNldCggZmlsZVVybCApOwoJCQkJCX0KCgkJCQkJLy93b3JrYXJvdW5kIHRvIGFsbG93IHNjcmlwdHMgdG8gZXhlY3V0ZSB3aGVuIGluY2x1ZGVkIGluIHBhZ2UgZGl2cwoJCQkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoJCQkJCXBhZ2UgPSBhbGwuZmluZCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkuZmlyc3QoKTsKCgkJCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJCQlpZiggIXBhZ2UubGVuZ3RoICl7CgkJCQkJCXBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz4iICsgaHRtbC5zcGxpdCggLzxcLz9ib2R5W14+XSo+L2dtaSApWzFdICsgIjwvZGl2PiIgKTsKCQkJCQl9CgoJCQkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCQkJaWYgKCB+bmV3UGFnZVRpdGxlLmluZGV4T2YoICImIiApICkgewoJCQkJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJCQl9CgkJCQkJCXBhZ2UuanFtRGF0YSggInRpdGxlIiwgbmV3UGFnZVRpdGxlICk7CgkJCQkJfQoKCQkJCQkvL3Jld3JpdGUgc3JjIGFuZCBocmVmIGF0dHJzIHRvIHVzZSBhIGJhc2UgdXJsCgkJCQkJaWYoICEkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgKSB7CgkJCQkJCXZhciBuZXdQYXRoID0gcGF0aC5nZXQoIGZpbGVVcmwgKTsKCQkJCQkJcGFnZS5maW5kKCAiW3NyY10sIGxpbmtbaHJlZl0sIGFbcmVsPSdleHRlcm5hbCddLCA6anFtRGF0YShhamF4PSdmYWxzZScpLCBhW3RhcmdldF0iICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkJCXZhciB0aGlzQXR0ciA9ICQoIHRoaXMgKS5pcyggJ1tocmVmXScgKSA/ICdocmVmJyA6CgkJCQkJCQkJCSQodGhpcykuaXMoJ1tzcmNdJykgPyAnc3JjJyA6ICdhY3Rpb24nLAoJCQkJCQkJCXRoaXNVcmwgPSAkKCB0aGlzICkuYXR0ciggdGhpc0F0dHIgKTsKCgkJCQkJCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gZml4IHRoaXMgc28gdGhhdCBpdCByZW1vdmVzIHRoZSBkb2N1bWVudAoJCQkJCQkJLy8gICAgICAgICAgICBiYXNlIFVSTCwgYW5kIHRoZW4gcHJlcGVuZHMgd2l0aCB0aGUgbmV3IHBhZ2UgVVJMLgoJCQkJCQkJLy9pZiBmdWxsIHBhdGggZXhpc3RzIGFuZCBpcyBzYW1lLCBjaG9wIGl0IC0gaGVscHMgSUUgb3V0CgkJCQkJCQl0aGlzVXJsID0gdGhpc1VybC5yZXBsYWNlKCBsb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUsICcnICk7CgoJCQkJCQkJaWYoICEvXihcdys6fCN8XC8pLy50ZXN0KCB0aGlzVXJsICkgKSB7CgkJCQkJCQkJJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyLCBuZXdQYXRoICsgdGhpc1VybCApOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCS8vYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJCQkvLyBUT0RPIHRhZ2luZyBhIHBhZ2Ugd2l0aCBleHRlcm5hbCB0byBtYWtlIHN1cmUgdGhhdCBlbWJlZGRlZCBwYWdlcyBhcmVuJ3QgcmVtb3ZlZAoJCQkJCS8vICAgICAgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZSBpbiBtYW55CgkJCQkJLy8gICAgICBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJCQlwYWdlCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBmaWxlVXJsICkgKQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICkKCQkJCQkJLmFwcGVuZFRvKCBzZXR0aW5ncy5wYWdlQ29udGFpbmVyICk7CgoJCQkJCS8vIHdhaXQgZm9yIHBhZ2UgY3JlYXRpb24gdG8gbGV2ZXJhZ2Ugb3B0aW9ucyBkZWZpbmVkIG9uIHdpZGdldAoJCQkJCXBhZ2Uub25lKCAncGFnZWNyZWF0ZScsICQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSApOwoKCQkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJCQkvLyBFbmhhbmNpbmcgdGhlIHBhZ2UgbWF5IHJlc3VsdCBpbiBuZXcgZGlhbG9ncy9zdWIgcGFnZXMgYmVpbmcgaW5zZXJ0ZWQKCQkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLXBhZ2UsIHRoYXQgaXMgdGhlCgkJCQkJLy8gcmVhbCBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluLgoJCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIjpqcW1EYXRhKHVybD0nIiArIGRhdGFVcmwgKyAiJykiICk7CgkJCQkJfQoKCQkJCQkvL2JpbmQgcGFnZUhpZGUgdG8gcmVtb3ZlUGFnZSBhZnRlciBpdCdzIGhpZGRlbiwgaWYgdGhlIHBhZ2Ugb3B0aW9ucyBzcGVjaWZ5IHRvIGRvIHNvCgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQkJaGlkZU1zZygpOwoJCQkJCX0KCgkJCQkJLy8gQWRkIHRoZSBwYWdlIHJlZmVyZW5jZSBhbmQgeGhyIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEucGFnZSA9IHBhZ2U7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2Vsb2FkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlLCBkdXBDYWNoZWRQYWdlICk7CgkJCQl9LAoJCQkJZXJyb3I6IGZ1bmN0aW9uKCB4aHIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duICkgewoJCQkJCS8vc2V0IGJhc2UgYmFjayB0byBjdXJyZW50IHBhdGgKCQkJCQlpZiggYmFzZSApIHsKCQkJCQkJYmFzZS5zZXQoIHBhdGguZ2V0KCkgKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCBlcnJvciBpbmZvIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEuZXJyb3JUaHJvd24gPSBlcnJvclRocm93bjsKCgkJCQkJdmFyIHBsZkV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlbG9hZGZhaWxlZCIgKTsKCgkJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBwYWdlIGxvYWQgZmFpbGVkLgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggcGxmRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCQkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCQkvLyB0aGF0IGNhbGxlZCBwcmV2ZW50RGVmYXVsdCgpLCB0byByZXNvbHZlL3JlamVjdCB0aGUKCQkJCQkvLyBkZWZlcnJlZCBvYmplY3Qgd2l0aGluIHRoZSB0cmlnZ2VyRGF0YS4KCQkJCQlpZiggcGxmRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQkJaGlkZU1zZygpOwoKCQkJCQkJLy9zaG93IGVycm9yIG1lc3NhZ2UKCQkJCQkJJCggIjxkaXYgY2xhc3M9J3VpLWxvYWRlciB1aS1vdmVybGF5LXNoYWRvdyB1aS1ib2R5LWUgdWktY29ybmVyLWFsbCc+PGgxPiIrICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlICsiPC9oMT48L2Rpdj4iICkKCQkJCQkJCS5jc3MoeyAiZGlzcGxheSI6ICJibG9jayIsICJvcGFjaXR5IjogMC45NiwgInRvcCI6ICR3aW5kb3cuc2Nyb2xsVG9wKCkgKyAxMDAgfSkKCQkJCQkJCS5hcHBlbmRUbyggc2V0dGluZ3MucGFnZUNvbnRhaW5lciApCgkJCQkJCQkuZGVsYXkoIDgwMCApCgkJCQkJCQkuZmFkZU91dCggNDAwLCBmdW5jdGlvbigpIHsKCQkJCQkJCQkkKCB0aGlzICkucmVtb3ZlKCk7CgkJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX07CgoJJC5tb2JpbGUubG9hZFBhZ2UuZGVmYXVsdHMgPSB7CgkJdHlwZTogImdldCIsCgkJZGF0YTogdW5kZWZpbmVkLAoJCXJlbG9hZFBhZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCXNob3dMb2FkTXNnOiBmYWxzZSwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJbG9hZE1zZ0RlbGF5OiA1MCAvLyBUaGlzIGRlbGF5IGFsbG93cyBsb2FkcyB0aGF0IHB1bGwgZnJvbSBicm93c2VyIGNhY2hlIHRvIG9jY3VyIHdpdGhvdXQgc2hvd2luZyB0aGUgbG9hZGluZyBtZXNzYWdlLgoJfTsKCgkvLyBTaG93IGEgc3BlY2lmaWMgcGFnZSBpbiB0aGUgcGFnZSBjb250YWluZXIuCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvUGFnZSwgb3B0aW9ucyApIHsKCQkvLyBJZiB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGEgdHJhbnNpdGlvbiwgcXVldWUgdGhlIGN1cnJlbnQgcmVxdWVzdC4KCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uIHRvCgkJLy8gc2VydmljZSB0aGUgcmVxdWVzdC4KCQlpZiggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICk7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgcGFnZUNvbnRhaW5lciB0byB3b3JrIHdpdGguCgkJc2V0dGluZ3MucGFnZUNvbnRhaW5lciA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBmcm9tUGFnZS4KCQlzZXR0aW5ncy5mcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlIHx8ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHRvUGFnZTogdG9QYWdlLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBiY0V2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiggcGJjRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvUGFnZSBpbiB0aGUgdHJpZ2dlcgoJCS8vIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0b1BhZ2UgaXMgdXBkYXRlZC4KCgkJdG9QYWdlID0gdHJpZ2dlckRhdGEudG9QYWdlOwoKCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCS8vIG9yIHRyYW5zaXRpb25pbmcuCgoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJLy8gdG8gbWFrZSBzdXJlIGl0IGlzIGxvYWRlZCBpbnRvIHRoZSBET00uIFdlJ2xsIGxpc3RlbgoJCS8vIHRvIHRoZSBwcm9taXNlIG9iamVjdCBpdCByZXR1cm5zIHNvIHdlIGtub3cgd2hlbgoJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCWlmICggdHlwZW9mIHRvUGFnZSA9PSAic3RyaW5nIiApIHsKCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHRvUGFnZSwgc2V0dGluZ3MgKQoJCQkJLmRvbmUoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgbmV3UGFnZSwgZHVwQ2FjaGVkUGFnZSApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQkJb3B0aW9ucy5kdXBsaWNhdGVDYWNoZWRQYWdlID0gZHVwQ2FjaGVkUGFnZTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBuZXdQYWdlLCBvcHRpb25zICk7CgkJCQl9KQoJCQkJLmZhaWwoZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgoJCQkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgoJCQkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2VjaGFuZ2VmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoJCQkJfSk7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZmlyc3QtcGFnZSBvZiB0aGUgYXBwbGljYXRpb24sIHdlIG5lZWQgdG8gbWFrZQoJCS8vIHN1cmUgc2V0dGluZ3MuZGF0YVVybCBpcyBzZXQgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVybC4gVGhpcyBhbGxvd3MKCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkvLyBmaXJzdC1wYWdlIG9mIHRoZSBkb2N1bWVudCBoYXMgYW4gaWQgYXR0cmlidXRlIHNwZWNpZmllZC4KCQlpZiAoIHRvUGFnZVsgMCBdID09PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSAmJiAhc2V0dGluZ3MuZGF0YVVybCApIHsKCQkJc2V0dGluZ3MuZGF0YVVybCA9IGRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJfQoKCQkvLyBUaGUgY2FsbGVyIHBhc3NlZCB1cyBhIHJlYWwgcGFnZSBET00gZWxlbWVudC4gVXBkYXRlIG91cgoJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCXZhciBmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlLAoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBzZXR0aW5ncy5kYXRhVXJsICkgKSB8fCB0b1BhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQgYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmwsCgkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCB1cmwgKSwKCQkJYWN0aXZlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9IHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAsCgkJCWhpc3RvcnlEaXIgPSAwLAoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZSwKCQkJaXNEaWFsb2cgPSBzZXR0aW5ncy5yb2xlID09PSAiZGlhbG9nIiB8fCB0b1BhZ2UuanFtRGF0YSggInJvbGUiICkgPT09ICJkaWFsb2ciOwoKCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50IG1hbnVhbGx5L2R5bmFtaWNhbGx5CgkJLy8gYW5kIHJldXNlIHBhZ2VzIHdhbnQgdG8gYmUgYWJsZSB0byB0cmFuc2l0aW9uIHRvIHRoZSBzYW1lIHBhZ2UuIFRvIGFsbG93CgkJLy8gdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0IHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uCgkJLy8gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbiBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLgoJCS8vIEl0IHNob3VsZCBiZSBub3RlZCB0aGF0IG91ciBkZWZhdWx0IHRyYW5zaXRpb24gYW5pbWF0aW9ucyBhc3N1bWUgdGhhdCB0aGUKCQkvLyBmb3JtUGFnZSBhbmQgdG9QYWdlIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuCgkJLy8gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uCgkJLy8gdG8gZWl0aGVyIHR1cm4gb2ZmIHRyYW5zaXRpb24gYW5pbWF0aW9ucywgb3IgbWFrZSBzdXJlIHRoYXQgYW4gYXBwcm9wcmlhdGUKCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCWlmKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmICFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFnZSB3ZSBhcmUgZ2l2ZW4gaGFzIGFscmVhZHkgYmVlbiBlbmhhbmNlZC4KCQllbmhhbmNlUGFnZSggdG9QYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCS8vIElmIHRoZSBjaGFuZ2VQYWdlIHJlcXVlc3Qgd2FzIHNlbnQgZnJvbSBhIGhhc2hDaGFuZ2UgZXZlbnQsIGNoZWNrIHRvIHNlZSBpZiB0aGUKCQkvLyBwYWdlIGlzIGFscmVhZHkgd2l0aGluIHRoZSB1cmxIaXN0b3J5IHN0YWNrLiBJZiBzbywgd2UnbGwgYXNzdW1lIHRoZSB1c2VyIGhpdAoJCS8vIHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUgdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQlpZiggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQljdXJyZW50VXJsOgl1cmwsCgkJCQlpc0JhY2s6CQlmdW5jdGlvbigpIHsgaGlzdG9yeURpciA9IC0xOyB9LAoJCQkJaXNGb3J3YXJkOglmdW5jdGlvbigpIHsgaGlzdG9yeURpciA9IDE7IH0KCQkJfSk7CgkJfQoKCQkvLyBLaWxsIHRoZSBrZXlib2FyZC4KCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gc3RvcCBjcmF3bGluZyB0aGUgZW50aXJlIGRvY3VtZW50IHRvIGtpbGwgZm9jdXMuIEluc3RlYWQsCgkJLy8gICAgICAgICAgICB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGxpdmUoKSBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZQoJCS8vICAgICAgICAgICAgdGhlIGVsZW1lbnQgaW4gaGFuZCBhdCB0aGlzIHBvaW50LgoJCS8vIFdyYXAgdGhpcyBpbiBhIHRyeS9jYXRjaCBibG9jayBzaW5jZSBJRTkgdGhyb3cgIlVuc3BlY2lmaWVkIGVycm9yIiBpZiBkb2N1bWVudC5hY3RpdmVFbGVtZW50CgkJLy8gaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQl0cnkgewoJCQlpZihkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPSAnYm9keScpIHsKCQkJCSQoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkuYmx1cigpOwoJCQl9IGVsc2UgewoJCQkJJCggImlucHV0OmZvY3VzLCB0ZXh0YXJlYTpmb2N1cywgc2VsZWN0OmZvY3VzIiApLmJsdXIoKTsKCQkJfQoJCX0gY2F0Y2goZSkge30KCgkJLy8gSWYgd2UncmUgZGlzcGxheWluZyB0aGUgcGFnZSBhcyBhIGRpYWxvZywgd2UgZG9uJ3Qgd2FudCB0aGUgdXJsCgkJLy8gZm9yIHRoZSBkaWFsb2cgY29udGVudCB0byBiZSB1c2VkIGluIHRoZSBoYXNoLiBJbnN0ZWFkLCB3ZSB3YW50CgkJLy8gdG8gYXBwZW5kIHRoZSBkaWFsb2dIYXNoS2V5IHRvIHRoZSB1cmwgb2YgdGhlIGN1cnJlbnQgcGFnZS4KCQlpZiAoIGlzRGlhbG9nICYmIGFjdGl2ZSApIHsKCQkJLy8gb24gdGhlIGluaXRpYWwgcGFnZSBsb2FkIGFjdGl2ZS51cmwgaXMgdW5kZWZpbmVkIGFuZCBpbiB0aGF0IGNhc2Ugc2hvdWxkCgkJCS8vIGJlIGFuIGVtcHR5IHN0cmluZy4gTW92aW5nIHRoZSB1bmRlZmluZWQgLT4gZW1wdHkgc3RyaW5nIGJhY2sgaW50bwoJCQkvLyB1cmxIaXN0b3J5LmFkZE5ldyBzZWVtZWQgaW1wcnVkZW50IGdpdmVuIHVuZGVmaW5lZCBiZXR0ZXIgcmVwcmVzZW50cwoJCQkvLyB0aGUgdXJsIHN0YXRlCgkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApICsgZGlhbG9nSGFzaEtleTsKCQl9CgoJCS8vIFNldCB0aGUgbG9jYXRpb24gaGFzaC4KCQlpZiggc2V0dGluZ3MuY2hhbmdlSGFzaCAhPT0gZmFsc2UgJiYgdXJsICkgewoJCQkvL2Rpc2FibGUgaGFzaCBsaXN0ZW5pbmcgdGVtcG9yYXJpbHkKCQkJdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSA9IHRydWU7CgkJCS8vdXBkYXRlIGhhc2ggYW5kIGhpc3RvcnkKCQkJcGF0aC5zZXQoIHVybCApOwoJCX0KCgkJLy8gaWYgdGl0bGUgZWxlbWVudCB3YXNuJ3QgZm91bmQsIHRyeSB0aGUgcGFnZSBkaXYgZGF0YSBhdHRyIHRvbwoJCS8vIElmIHRoaXMgaXMgYSBkZWVwLWxpbmsgb3IgYSByZWxvYWQgKCBhY3RpdmUgPT09IHVuZGVmaW5lZCApIHRoZW4ganVzdCB1c2UgcGFnZVRpdGxlCgkJdmFyIG5ld1BhZ2VUaXRsZSA9ICggIWFjdGl2ZSApPyBwYWdlVGl0bGUgOiB0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApIHx8IHRvUGFnZS5jaGlsZHJlbigiOmpxbURhdGEocm9sZT0naGVhZGVyJykiKS5maW5kKCIudWktdGl0bGUiICkuZ2V0RW5jb2RlZFRleHQoKTsKCQlpZiggISFuZXdQYWdlVGl0bGUgJiYgcGFnZVRpdGxlID09IGRvY3VtZW50LnRpdGxlICkgewoJCQlwYWdlVGl0bGUgPSBuZXdQYWdlVGl0bGU7CgkJfQoJCWlmICggIXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiLCBwYWdlVGl0bGUgKTsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgdHJhbnNpdGlvbiBkZWZpbmVkLgoJCXNldHRpbmdzLnRyYW5zaXRpb24gPSBzZXR0aW5ncy50cmFuc2l0aW9uCgkJCXx8ICggKCBoaXN0b3J5RGlyICYmICFhY3RpdmVJc0luaXRpYWxQYWdlICkgPyBhY3RpdmUudHJhbnNpdGlvbiA6IHVuZGVmaW5lZCApCgkJCXx8ICggaXNEaWFsb2cgPyAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiA6ICQubW9iaWxlLmRlZmF1bHRQYWdlVHJhbnNpdGlvbiApOwoKCQkvL2FkZCBwYWdlIHRvIGhpc3Rvcnkgc3RhY2sgaWYgaXQncyBub3QgYmFjayBvciBmb3J3YXJkCgkJaWYoICFoaXN0b3J5RGlyICkgewoJCQl1cmxIaXN0b3J5LmFkZE5ldyggdXJsLCBzZXR0aW5ncy50cmFuc2l0aW9uLCBwYWdlVGl0bGUsIHBhZ2VVcmwsIHNldHRpbmdzLnJvbGUgKTsKCQl9CgoJCS8vc2V0IHBhZ2UgdGl0bGUKCQlkb2N1bWVudC50aXRsZSA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCkudGl0bGU7CgoJCS8vc2V0ICJ0b1BhZ2UiIGFzIGFjdGl2ZVBhZ2UKCQkkLm1vYmlsZS5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQlzZXR0aW5ncy5yZXZlcnNlID0gc2V0dGluZ3MucmV2ZXJzZSB8fCBoaXN0b3J5RGlyIDwgMDsKCgkJdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCBzZXR0aW5ncy50cmFuc2l0aW9uLCBzZXR0aW5ncy5yZXZlcnNlICkKCQkJLmRvbmUoZnVuY3Rpb24oKSB7CgkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoKTsKCgkJCQkvL2lmIHRoZXJlJ3MgYSBkdXBsaWNhdGVDYWNoZWRQYWdlLCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NIG5vdyB0aGF0IGl0J3MgaGlkZGVuCgkJCQlpZiAoIHNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgKSB7CgkJCQkJc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZS5yZW1vdmUoKTsKCQkJCX0KCgkJCQkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCgkJCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhbGwgZG9uZSBjaGFuZ2luZyB0aGUgY3VycmVudCBwYWdlLgoJCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCi8qIEV2ZW50IEJpbmRpbmdzIC0gaGFzaGNoYW5nZSwgc3VibWl0LCBhbmQgY2xpY2sgKi8KCWZ1bmN0aW9uIGZpbmRDbG9zZXN0TGluayggZWxlICkKCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImEiICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBlbGU7Cgl9CgoJLy8gVGhlIGJhc2UgVVJMIGZvciBhbnkgZ2l2ZW4gZWxlbWVudCBkZXBlbmRzIG9uIHRoZSBwYWdlIGl0IHJlc2lkZXMgaW4uCglmdW5jdGlvbiBnZXRDbG9zZXN0QmFzZVVybCggZWxlICkKCXsKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhZ2UgYW5kIGV4dHJhY3Qgb3V0IGl0cyB1cmwuCgkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQliYXNlID0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCWlmICggIXVybCB8fCAhcGF0aC5pc1BhdGgoIHVybCApICkgewoJCQl1cmwgPSBiYXNlOwoJCX0KCgkJcmV0dXJuIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UpOwoJfQoKCgkvL1RoZSBmb2xsb3dpbmcgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGJlIGJvdW5kIGFmdGVyIG1vYmlsZWluaXQgaGFzIGJlZW4gdHJpZ2dlcmVkCgkvL3RoZSBmb2xsb3dpbmcgZnVuY3Rpb24gaXMgY2FsbGVkIGluIHRoZSBpbml0IGZpbGUKCSQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzID0gZnVuY3Rpb24oKXsKCgkJLy9iaW5kIHRvIGZvcm0gc3VibWl0IGV2ZW50cywgaGFuZGxlIHdpdGggQWpheAoJCSQoICJmb3JtIiApLmxpdmUoJ3N1Ym1pdCcsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoJCQlpZiggISQubW9iaWxlLmFqYXhFbmFibGVkIHx8CgkJCQkkdGhpcy5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJdmFyIHR5cGUgPSAkdGhpcy5hdHRyKCAibWV0aG9kIiApLAoJCQkJdGFyZ2V0ID0gJHRoaXMuYXR0ciggInRhcmdldCIgKSwKCQkJCXVybCA9ICR0aGlzLmF0dHIoICJhY3Rpb24iICk7CgoJCQkvLyBJZiBubyBhY3Rpb24gaXMgc3BlY2lmaWVkLCBicm93c2VycyBkZWZhdWx0IHRvIHVzaW5nIHRoZQoJCQkvLyBVUkwgb2YgdGhlIGRvY3VtZW50IGNvbnRhaW5pbmcgdGhlIGZvcm0uIFNpbmNlIHdlIGR5bmFtaWNhbGx5CgkJCS8vIHB1bGwgaW4gcGFnZXMgZnJvbSBleHRlcm5hbCBkb2N1bWVudHMsIHRoZSBmb3JtIHNob3VsZCBzdWJtaXQKCQkJLy8gdG8gdGhlIFVSTCBmb3IgdGhlIHNvdXJjZSBkb2N1bWVudCBvZiB0aGUgcGFnZSBjb250YWluaW5nCgkJCS8vIHRoZSBmb3JtLgoJCQlpZiAoICF1cmwgKSB7CgkJCQkvLyBHZXQgdGhlIEBkYXRhLXVybCBmb3IgdGhlIHBhZ2UgY29udGFpbmluZyB0aGUgZm9ybS4KCQkJCXVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkdGhpcyApOwoJCQkJaWYgKCB1cmwgPT09IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgewoJCQkJCS8vIFRoZSB1cmwgd2UgZ290IGJhY2sgbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYmFzZSwKCQkJCQkvLyB3aGljaCBtZWFucyB0aGUgcGFnZSBtdXN0IGJlIGFuIGludGVybmFsL2VtYmVkZGVkIHBhZ2UsCgkJCQkJLy8gc28gZGVmYXVsdCB0byB1c2luZyB0aGUgYWN0dWFsIGRvY3VtZW50IHVybCBhcyBhIGJyb3dzZXIKCQkJCQkvLyB3b3VsZC4KCQkJCQl1cmwgPSBkb2N1bWVudFVybC5ocmVmTm9TZWFyY2g7CgkJCQl9CgkJCX0KCgkJCXVybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCAgdXJsLCBnZXRDbG9zZXN0QmFzZVVybCgkdGhpcykgKTsKCgkJCS8vZXh0ZXJuYWwgc3VibWl0cyB1c2UgcmVndWxhciBIVFRQCgkJCWlmKCBwYXRoLmlzRXh0ZXJuYWwoIHVybCApIHx8IHRhcmdldCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSgKCQkJCXVybCwKCQkJCXsKCQkJCQl0eXBlOgkJdHlwZSAmJiB0eXBlLmxlbmd0aCAmJiB0eXBlLnRvTG93ZXJDYXNlKCkgfHwgImdldCIsCgkJCQkJZGF0YToJCSR0aGlzLnNlcmlhbGl6ZSgpLAoJCQkJCXRyYW5zaXRpb246CSR0aGlzLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJCWRpcmVjdGlvbjoJJHRoaXMuanFtRGF0YSggImRpcmVjdGlvbiIgKSwKCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQl9CgkJCSk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vYWRkIGFjdGl2ZSBzdGF0ZSBvbiB2Y2xpY2sKCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIGlmIHRoaXMgaXNuJ3QgYSBsZWZ0IGNsaWNrIHdlIGRvbid0IGNhcmUuIEl0cyBpbXBvcnRhbnQgdG8gbm90ZQoJCQkvLyB0aGF0IHdoZW4gdGhlIHZpcnR1YWwgZXZlbnQgaXMgZ2VuZXJhdGVkIGl0IHdpbGwgY3JlYXRlCgkJCWlmICggZXZlbnQud2hpY2ggPiAxIHx8ICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApOwoJCQlpZiAoIGxpbmsgKSB7CgkJCQlpZiAoIHBhdGgucGFyc2VVcmwoIGxpbmsuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSB7CgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gJCggbGluayApLmNsb3Nlc3QoICIudWktYnRuIiApLm5vdCggIi51aS1kaXNhYmxlZCIgKTsKCQkJCQkkYWN0aXZlQ2xpY2tlZExpbmsuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiAudWktYnRuIiApLm5vdCggbGluayApLmJsdXIoKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkKCBkb2N1bWVudCApLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYoICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApOwoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgJGxpbmsgPSAkKCBsaW5rICksCgkJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpewoJCQkJCXdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsgcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7IH0sIDIwMCApOwoJCQkJfTsKCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmKCAkbGluay5pcyggIjpqcW1EYXRhKHJlbD0nYmFjaycpIiApICkgewoJCQkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgYmFzZVVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkbGluayApLAoKCQkJCS8vZ2V0IGhyZWYsIGlmIGRlZmluZWQsIG90aGVyd2lzZSBkZWZhdWx0IHRvIGVtcHR5IGhhc2gKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGxpbmsuYXR0ciggImhyZWYiICkgfHwgIiMiLCBiYXNlVXJsICk7CgoJCQkvL2lmIGFqYXggaXMgZGlzYWJsZWQsIGV4aXQgZWFybHkKCQkJaWYoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICl7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPSAtMSApIHsKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJCS8vIFNob3VsZCB3ZSBoYW5kbGUgdGhpcyBsaW5rLCBvciBsZXQgdGhlIGJyb3dzZXIgZGVhbCB3aXRoIGl0PwoJCQl2YXIgdXNlRGVmYXVsdFVybEhhbmRsaW5nID0gJGxpbmsuaXMoICJbcmVsPSdleHRlcm5hbCddIiApIHx8ICRsaW5rLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fCAkbGluay5pcyggIlt0YXJnZXRdIiApLAoKCQkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCQlpc0Nyb3NzRG9tYWluUGFnZUxvYWQgPSAoICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJiBkb2N1bWVudFVybC5wcm90b2NvbCA9PT0gImZpbGU6IiAmJiBocmVmLnNlYXJjaCggL15odHRwcz86LyApICE9IC0xICksCgoJCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJCS8vVE9ETyBvdmVybGFwIGluIGxvZ2ljIGZyb20gaXNFeHRlcm5hbCwgcmVsPWV4dGVybmFsIGNoZWNrIHNob3VsZCBiZQoJCQkJLy8gICAgIG1vdmVkIGludG8gbW9yZSBjb21wcmVoZW5zaXZlIGlzRXh0ZXJuYWxMaW5rCgkJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggcGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgIWlzQ3Jvc3NEb21haW5QYWdlTG9hZCApOwoKCQkJaWYoIGlzRXh0ZXJuYWwgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3VzZSBhamF4CgkJCXZhciB0cmFuc2l0aW9uID0gJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQlkaXJlY3Rpb24gPSAkbGluay5qcW1EYXRhKCAiZGlyZWN0aW9uIiApLAoJCQkJcmV2ZXJzZSA9ICggZGlyZWN0aW9uICYmIGRpcmVjdGlvbiA9PT0gInJldmVyc2UiICkgfHwKCQkJCQkJCS8vIGRlcHJlY2F0ZWQgLSByZW1vdmUgYnkgMS4wCgkJCQkJCQkkbGluay5qcW1EYXRhKCAiYmFjayIgKSwKCgkJCQkvL3RoaXMgbWF5IG5lZWQgdG8gYmUgbW9yZSBzcGVjaWZpYyBhcyB3ZSB1c2UgZGF0YS1yZWwgbW9yZQoJCQkJcm9sZSA9ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfHwgdW5kZWZpbmVkOwoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggaHJlZiwgeyB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCByZXZlcnNlOiByZXZlcnNlLCByb2xlOiByb2xlIH0gKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9wcmVmZXRjaCBwYWdlcyB3aGVuIGFuY2hvcnMgd2l0aCBkYXRhLXByZWZldGNoIGFyZSBlbmNvdW50ZXJlZAoJCSQoICIudWktcGFnZSIgKS5saXZlKCAicGFnZXNob3cucHJlZmV0Y2giLCBmdW5jdGlvbigpIHsKCQkJdmFyIHVybHMgPSBbXTsKCQkJJCggdGhpcyApLmZpbmQoICJhOmpxbURhdGEocHJlZmV0Y2gpIiApLmVhY2goZnVuY3Rpb24oKXsKCQkJCXZhciAkbGluayA9ICQodGhpcyksCgkJCQkJdXJsID0gJGxpbmsuYXR0ciggImhyZWYiICk7CgoJCQkJaWYgKCB1cmwgJiYgJC5pbkFycmF5KCB1cmwsIHVybHMgKSA9PT0gLTEgKSB7CgkJCQkJdXJscy5wdXNoKCB1cmwgKTsKCgkJCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHVybCwge3JvbGU6ICRsaW5rLmF0dHIoImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIpfSApOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UgPSBmdW5jdGlvbiggaGFzaCApIHsKCQkJLy9maW5kIGZpcnN0IHBhZ2UgdmlhIGhhc2gKCQkJdmFyIHRvID0gcGF0aC5zdHJpcEhhc2goIGhhc2ggKSwKCQkJCS8vdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQgb3RoZXJ3aXNlIChhbmQgbWF5IGJlIG92ZXJyaWRkZW4gYnkgZGVmYXVsdCkKCQkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS51cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMCA/ICJub25lIiA6IHVuZGVmaW5lZCwKCgkJCQkvLyBkZWZhdWx0IG9wdGlvbnMgZm9yIHRoZSBjaGFuZ1BhZ2UgY2FsbHMgbWFkZSBhZnRlciBleGFtaW5pbmcgdGhlIGN1cnJlbnQgc3RhdGUKCQkJCS8vIG9mIHRoZSBwYWdlIGFuZCB0aGUgaGFzaAoJCQkJY2hhbmdlUGFnZU9wdGlvbnMgPSB7CgkJCQkJdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZQoJCQkJfTsKCgkJCS8vaWYgbGlzdGVuaW5nIGlzIGRpc2FibGVkIChlaXRoZXIgZ2xvYmFsbHkgb3IgdGVtcG9yYXJpbHkpLCBvciBpdCdzIGEgZGlhbG9nIGhhc2gKCQkJaWYoICEkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCB8fCB1cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlICkgewoJCQkJdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSA9IGZhbHNlOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBzcGVjaWFsIGNhc2UgZm9yIGRpYWxvZ3MKCQkJaWYoIHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoID4gMSAmJiB0by5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSApIHsKCgkJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCQkvLyBpbiB0aGUgc2FtZSBkaXJlY3Rpb24KCQkJCWlmKCEkLm1vYmlsZS5hY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKSkgewoJCQkJCS8vZGV0ZXJtaW5lIGlmIHdlJ3JlIGhlYWRpbmcgZm9yd2FyZCBvciBiYWNrd2FyZCBhbmQgY29udGludWUgYWNjb3JkaW5nbHkgcGFzdAoJCQkJCS8vdGhlIGN1cnJlbnQgZGlhbG9nCgkJCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCQkJY3VycmVudFVybDogdG8sCgkJCQkJCWlzQmFjazogZnVuY3Rpb24oKSB7IHdpbmRvdy5oaXN0b3J5LmJhY2soKTsgfSwKCQkJCQkJaXNGb3J3YXJkOiBmdW5jdGlvbigpIHsgd2luZG93Lmhpc3RvcnkuZm9yd2FyZCgpOyB9CgkJCQkJfSk7CgoJCQkJCS8vIHByZXZlbnQgY2hhbmdlUGFnZSgpCgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBpZiB0aGUgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBhIGRpYWxvZyBhbmQgd2UncmUgbmF2aWdhdGluZwoJCQkJCS8vIHRvIGEgZGlhbG9nIHVzZSB0aGUgZGlhbG9nIG9iamVjdGVkIHNhdmVkIGluIHRoZSBzdGFjawoJCQkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQkJCWN1cnJlbnRVcmw6IHRvLAoKCQkJCQkJLy8gcmVnYXJkbGVzcyBvZiB0aGUgZGlyZWN0aW9uIG9mIHRoZSBoaXN0b3J5IGNoYW5nZQoJCQkJCQkvLyBkbyB0aGUgZm9sbG93aW5nCgkJCQkJCWVpdGhlcjogZnVuY3Rpb24oIGlzQmFjayApIHsKCQkJCQkJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQkJCQkJCXRvID0gYWN0aXZlLnBhZ2VVcmw7CgoJCQkJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgcm9sZSwgdHJhbnNpdGlvbiBhbmQgcmV2ZXJzYWwKCQkJCQkJCS8vIGFzIG1vc3Qgb2YgdGhpcyBpcyBsb3N0IGJ5IHRoZSBkb21DYWNoZSBjbGVhbmluZwoJCQkJCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCB7CgkJCQkJCQkJcm9sZTogYWN0aXZlLnJvbGUsCgkJCQkJCQkJdHJhbnNpdGlvbjoJIGFjdGl2ZS50cmFuc2l0aW9uLAoJCQkJCQkJCXJldmVyc2U6IGlzQmFjawoJCQkJCQkJfSk7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0KCQkJfQoKCQkJLy9pZiB0byBpcyBkZWZpbmVkLCBsb2FkIGl0CgkJCWlmICggdG8gKSB7CgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UgZWxlbWVudCBmcm9tCgkJCQkvLyBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlL2Fic29sdXRlIFVSTC4gSWYgJ3RvJyBpcwoJCQkJLy8gYW4gaWQsIHdlIG5lZWQgdG8gcmVzb2x2ZSBpdCBhZ2FpbnN0IHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwKCQkJCS8vIHNpbmNlIHRoZSBoYXNoY2hhbmdlIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwgcGFnZS9kaWFsb2cuCgkJCQl0byA9ICggdHlwZW9mIHRvID09PSAic3RyaW5nIiAmJiAhcGF0aC5pc1BhdGgoIHRvICkgKSA/ICggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHRvLCBkb2N1bWVudEJhc2UgKSApIDogdG87CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCB0bywgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQllbHNlIHsKCQkJCS8vdGhlcmUncyBubyBoYXNoLCBnbyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgZG9tCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJCX0KCQl9OwoKCQkvL2hhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcgoJCSR3aW5kb3cuYmluZCggImhhc2hjaGFuZ2UiLCBmdW5jdGlvbiggZSwgdHJpZ2dlcmVkICkgewoJCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSggbG9jYXRpb24uaGFzaCApOwoJCX0pOwoKCQkvL3NldCBwYWdlIG1pbi1oZWlnaHRzIHRvIGJlIGRldmljZSBzcGVjaWZpYwoJCSQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VzaG93IiwgcmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgkJJCggd2luZG93ICkuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIHJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoKCX07Ly9fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyBjYWxsYmFjawoKfSkoIGpRdWVyeSApOwovKgoqIGhpc3RvcnkucHVzaFN0YXRlIHN1cHBvcnQsIGxheWVyZWQgb24gdG9wIG9mIGhhc2hjaGFuZ2UKKi8KCiggZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCS8vIEZvciBub3csIGxldCdzIE1vbmtleXBhdGNoIHRoaXMgb250byB0aGUgZW5kIG9mICQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzCgkvLyBTY29wZSBzZWxmIHRvIHB1c2hTdGF0ZUhhbmRsZXIgc28gd2UgY2FuIHJlZmVyZW5jZSBpdCBzYW5lbHkgd2l0aGluIHRoZQoJLy8gbWV0aG9kcyBoYW5kZWQgb2ZmIGFzIGV2ZW50IGhhbmRsZXJzCgl2YXIJcHVzaFN0YXRlSGFuZGxlciA9IHt9LAoJCXNlbGYgPSBwdXNoU3RhdGVIYW5kbGVyLAoJCSR3aW4gPSAkKCB3aW5kb3cgKSwKCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCBsb2NhdGlvbi5ocmVmICk7CgoJJC5leHRlbmQoIHB1c2hTdGF0ZUhhbmRsZXIsIHsKCQkvLyBUT0RPIG1vdmUgdG8gYSBwYXRoIGhlbHBlciwgdGhpcyBpcyByYXRoZXIgY29tbW9uIGZ1bmN0aW9uYWxpdHkKCQlpbml0aWFsRmlsZVBhdGg6IChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHVybC5wYXRobmFtZSArIHVybC5zZWFyY2g7CgkJfSkoKSwKCgkJaW5pdGlhbEhyZWY6IHVybC5ocmVmTm9IYXNoLAoKCQkvLyBGbGFnIGZvciB0cmFja2luZyBpZiBhIEhhc2hjaGFuZ2UgbmF0dXJhbGx5IG9jY3VycyBhZnRlciBlYWNoIHBvcHN0YXRlICsgcmVwbGFjZQoJCWhhc2hjaGFuZ2VGaXJlZDogZmFsc2UsCgoJCXN0YXRlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHsKCQkJCWhhc2g6IGxvY2F0aW9uLmhhc2ggfHwgIiMiICsgc2VsZi5pbml0aWFsRmlsZVBhdGgsCgkJCQl0aXRsZTogZG9jdW1lbnQudGl0bGUsCgoJCQkJLy8gcGVyc2lzdCBhY3Jvc3MgcmVmcmVzaAoJCQkJaW5pdGlhbEhyZWY6IHNlbGYuaW5pdGlhbEhyZWYKCQkJfTsKCQl9LAoKCQlyZXNldFVJS2V5czogZnVuY3Rpb24oIHVybCApIHsKCQkJdmFyIGRpYWxvZyA9ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXksCgkJCQlzdWJrZXkgPSAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5LAoJCQkJZGlhbG9nSW5kZXggPSB1cmwuaW5kZXhPZiggZGlhbG9nICk7CgoJCQlpZiggZGlhbG9nSW5kZXggPiAtMSApIHsKCQkJCXVybCA9IHVybC5zbGljZSggMCwgZGlhbG9nSW5kZXggKSArICIjIiArIHVybC5zbGljZSggZGlhbG9nSW5kZXggKTsKCQkJfSBlbHNlIGlmKCB1cmwuaW5kZXhPZiggc3Via2V5ICkgPiAtMSApIHsKCQkJCXVybCA9IHVybC5zcGxpdCggc3Via2V5ICkuam9pbiggIiMiICsgc3Via2V5ICk7CgkJCX0KCgkJCXJldHVybiB1cmw7CgkJfSwKCgkJLy8gVE9ETyBzb3J0IG91dCBhIHNpbmdsZSBiYXJyaWVyIHRvIGhhc2hjaGFuZ2UgZnVuY3Rpb25hbGl0eQoJCW5leHRIYXNoQ2hhbmdlUHJldmVudGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCSQubW9iaWxlLnVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSB2YWx1ZTsKCQkJc2VsZi5vbkhhc2hDaGFuZ2VEaXNhYmxlZCA9IHZhbHVlOwoJCX0sCgoJCS8vIG9uIGhhc2ggY2hhbmdlIHdlIHdhbnQgdG8gY2xlYW4gdXAgdGhlIHVybAoJCS8vIE5PVEUgdGhpcyB0YWtlcyBwbGFjZSAqYWZ0ZXIqIHRoZSB2YW5pbGxhIG5hdmlnYXRpb24gaGFzaCBjaGFuZ2UKCQkvLyBoYW5kbGluZyBoYXMgdGFrZW4gcGxhY2UgYW5kIHNldCB0aGUgc3RhdGUgb2YgdGhlIERPTQoJCW9uSGFzaENoYW5nZTogZnVuY3Rpb24oIGUgKSB7CgkJCS8vIGRpc2FibGUgdGhpcyBoYXNoIGNoYW5nZQoJCQlpZiggc2VsZi5vbkhhc2hDaGFuZ2VEaXNhYmxlZCApewoJCQkJcmV0dXJuOwoJCQl9CgkJCQoJCQl2YXIgaHJlZiwgc3RhdGUsCgkJCQloYXNoID0gbG9jYXRpb24uaGFzaCwKCQkJCWlzUGF0aCA9ICQubW9iaWxlLnBhdGguaXNQYXRoKCBoYXNoICksCgkJCQlyZXNvbHV0aW9uVXJsID0gaXNQYXRoID8gbG9jYXRpb24uaHJlZiA6ICQubW9iaWxlLmdldERvY3VtZW50VXJsKCk7CgkJCWhhc2ggPSBpc1BhdGggPyBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6IGhhc2g7CgoJCQkvLyBwcm9wdWxhdGUgdGhlIGhhc2ggd2hlbiBpdHMgbm90IGF2YWlsYWJsZQoJCQlzdGF0ZSA9IHNlbGYuc3RhdGUoKTsKCgkJCS8vIG1ha2UgdGhlIGhhc2ggYWJvbHV0ZSB3aXRoIHRoZSBjdXJyZW50IGhyZWYKCQkJaHJlZiA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCBoYXNoLCByZXNvbHV0aW9uVXJsICk7CgoJCQlpZiAoIGlzUGF0aCApIHsKCQkJCWhyZWYgPSBzZWxmLnJlc2V0VUlLZXlzKCBocmVmICk7CgkJCX0KCgkJCS8vIHJlcGxhY2UgdGhlIGN1cnJlbnQgdXJsIHdpdGggdGhlIG5ldyBocmVmIGFuZCBzdG9yZSB0aGUgc3RhdGUKCQkJLy8gTm90ZSB0aGF0IGluIHNvbWUgY2FzZXMgd2UgbWlnaHQgYmUgcmVwbGFjaW5nIGFuIHVybCB3aXRoIHRoZQoJCQkvLyBzYW1lIHVybC4gV2UgZG8gdGhpcyBhbnl3YXlzIGJlY2F1c2Ugd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdAoJCQkvLyBhbGwgb2Ygb3VyIGhpc3RvcnkgZW50cmllcyBoYXZlIGEgc3RhdGUgb2JqZWN0IGFzc29jaWF0ZWQgd2l0aAoJCQkvLyB0aGVtLiBUaGlzIGFsbG93cyB1cyB0byB3b3JrIGFyb3VuZCB0aGUgY2FzZSB3aGVyZSB3aW5kb3cuaGlzdG9yeS5iYWNrKCkKCQkJLy8gaXMgY2FsbGVkIHRvIHRyYW5zaXRpb24gZnJvbSBhbiBleHRlcm5hbCBwYWdlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuCgkJCS8vIEluIHRoYXQgcGFydGljdWxhciBjYXNlLCBhIGhhc2hjaGFuZ2UgZXZlbnQgaXMgKk5PVCogZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLgoJCQkvLyBFbnN1cmluZyBlYWNoIGhpc3RvcnkgZW50cnkgaGFzIGEgc3RhdGUgb2JqZWN0IG1lYW5zIHRoYXQgb25Qb3BTdGF0ZSgpCgkJCS8vIHdpbGwgYWx3YXlzIHRyaWdnZXIgb3VyIGhhc2hjaGFuZ2UgY2FsbGJhY2sgZXZlbiB3aGVuIGEgaGFzaGNoYW5nZSBldmVudAoJCQkvLyBpcyBub3QgZmlyZWQuCgkJCWhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCQl9LAoKCQkvLyBvbiBwb3BzdGF0ZSAoaWUgYmFjayBvciBmb3J3YXJkKSB3ZSBuZWVkIHRvIHJlcGxhY2UgdGhlIGhhc2ggdGhhdCB3YXMgdGhlcmUgcHJldmlvdXNseQoJCS8vIGNsZWFuZWQgdXAgYnkgdGhlIGFkZGl0aW9uYWwgaGFzaCBoYW5kbGluZwoJCW9uUG9wU3RhdGU6IGZ1bmN0aW9uKCBlICkgewoJCQl2YXIgcG9wcGVkU3RhdGUgPSBlLm9yaWdpbmFsRXZlbnQuc3RhdGUsIGhvbGRuZXh0aGFzaGNoYW5nZSA9IGZhbHNlOwoKCQkJLy8gaWYgdGhlcmUncyBubyBzdGF0ZSBpdHMgbm90IGEgcG9wc3RhdGUgd2UgY2FyZSBhYm91dCwgaWUgY2hyb21lJ3MgaW5pdGlhbCBwb3BzdGF0ZQoJCQkvLyBvciBmb3J3YXJkIHBvcHN0YXRlCgkJCWlmKCBwb3BwZWRTdGF0ZSApIHsKCQkJCS8vIGRpc2FibGUgYW55IGhhc2hjaGFuZ2UgdHJpZ2dlcmVkIGJ5IHRoZSBicm93c2VyCgkJCQlzZWxmLm5leHRIYXNoQ2hhbmdlUHJldmVudGVkKCB0cnVlICk7CgoJCQkJLy8gZGVmZXIgb3VyIG1hbnVhbCBoYXNoY2hhbmdlIHVudGlsIGFmdGVyIHRoZSBicm93c2VyIGZpcmVkCgkJCQkvLyB2ZXJzaW9uIGhhcyBjb21lIGFuZCBnb25lCgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBtYW51YWwgaGFzaCBoYW5kbGluZyB0YWtlcyBwbGFjZQoJCQkJCXNlbGYubmV4dEhhc2hDaGFuZ2VQcmV2ZW50ZWQoIGZhbHNlICk7CgoJCQkJCS8vIGNoYW5nZSB0aGUgcGFnZSBiYXNlZCBvbiB0aGUgaGFzaAoJCQkJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlKCBwb3BwZWRTdGF0ZS5oYXNoICk7CgkJCQl9LCAxMDApOwoJCQl9CgkJfSwKCgkJaW5pdDogZnVuY3Rpb24oKSB7CgkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UiLCBzZWxmLm9uSGFzaENoYW5nZSApOwoKCQkJLy8gSGFuZGxlIHBvcHN0YXRlIGV2ZW50cyB0aGUgb2NjdXIgdGhyb3VnaCBoaXN0b3J5IGNoYW5nZXMKCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUiLCBzZWxmLm9uUG9wU3RhdGUgKTsKCgkJCS8vIGlmIHRoZXJlJ3Mgbm8gaGFzaCwgd2UgbmVlZCB0byByZXBsYWNlc3RhdGUgZm9yIHJldHVybmluZyB0byBob21lCgkJCWlmICggbG9jYXRpb24uaGFzaCA9PT0gIiIgKSB7CgkJCQloaXN0b3J5LnJlcGxhY2VTdGF0ZSggc2VsZi5zdGF0ZSgpLCBkb2N1bWVudC50aXRsZSwgbG9jYXRpb24uaHJlZiApOwoJCQl9CgkJfQoJfSk7CgoJJCggZnVuY3Rpb24oKSB7CgkJaWYoICQubW9iaWxlLnB1c2hTdGF0ZUVuYWJsZWQgJiYgJC5zdXBwb3J0LnB1c2hTdGF0ZSApewoJCQlwdXNoU3RhdGVIYW5kbGVyLmluaXQoKTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqICJ0cmFuc2l0aW9ucyIgcGx1Z2luIC0gUGFnZSBjaGFuZ2UgdHJhbmlzdGlvbnMKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBjc3MzVHJhbnNpdGlvbkhhbmRsZXIoIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20gKSB7CgoJdmFyIGRlZmVycmVkID0gbmV3ICQuRGVmZXJyZWQoKSwKCQlyZXZlcnNlQ2xhc3MgPSByZXZlcnNlID8gIiByZXZlcnNlIiA6ICIiLAoJCXZpZXdwb3J0Q2xhc3MgPSAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIG5hbWUsCgkJZG9uZUZ1bmMgPSBmdW5jdGlvbigpIHsKCgkJCSR0by5hZGQoICRmcm9tICkucmVtb3ZlQ2xhc3MoICJvdXQgaW4gcmV2ZXJzZSAiICsgbmFtZSApOwoKCQkJaWYgKCAkZnJvbSAmJiAkZnJvbVsgMCBdICE9PSAkdG9bIDAgXSApIHsKCQkJCSRmcm9tLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCQkJfQoKCQkJJHRvLnBhcmVudCgpLnJlbW92ZUNsYXNzKCB2aWV3cG9ydENsYXNzICk7CgoJCQlkZWZlcnJlZC5yZXNvbHZlKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tICk7CgkJfTsKCgkkdG8uYW5pbWF0aW9uQ29tcGxldGUoIGRvbmVGdW5jICk7CgoJJHRvLnBhcmVudCgpLmFkZENsYXNzKCB2aWV3cG9ydENsYXNzICk7CgoJaWYgKCAkZnJvbSApIHsKCQkkZnJvbS5hZGRDbGFzcyggbmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJfQoJJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyAiICIgKyBuYW1lICsgIiBpbiIgKyByZXZlcnNlQ2xhc3MgKTsKCglyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwp9CgovLyBNYWtlIG91ciB0cmFuc2l0aW9uIGhhbmRsZXIgcHVibGljLgokLm1vYmlsZS5jc3MzVHJhbnNpdGlvbkhhbmRsZXIgPSBjc3MzVHJhbnNpdGlvbkhhbmRsZXI7CgovLyBJZiB0aGUgZGVmYXVsdCB0cmFuc2l0aW9uIGhhbmRsZXIgaXMgdGhlICdub25lJyBoYW5kbGVyLCByZXBsYWNlIGl0IHdpdGggb3VyIGhhbmRsZXIuCmlmICggJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID09PSAkLm1vYmlsZS5ub25lVHJhbnNpdGlvbkhhbmRsZXIgKSB7CgkkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSBjc3MzVHJhbnNpdGlvbkhhbmRsZXI7Cn0KCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiAiZGVncmFkZUlucHV0cyIgcGx1Z2luIC0gZGVncmFkZXMgaW5wdXRzIHRvIGFub3RoZXIgdHlwZSBhZnRlciBjdXN0b20gZW5oYW5jZW1lbnRzIGFyZSBtYWRlLgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07CgoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCgl2YXIgcGFnZSA9ICQoZS50YXJnZXQpLmNsb3Nlc3QoJzpqcW1EYXRhKHJvbGU9InBhZ2UiKScpLmRhdGEoInBhZ2UiKSwgb3B0aW9uczsKCglpZiggIXBhZ2UgKSB7CgkJcmV0dXJuOwoJfQoKCW9wdGlvbnMgPSBwYWdlLm9wdGlvbnM7CgoJLy8gZGVncmFkZSBpbnB1dHMgdG8gYXZvaWQgcG9vcmx5IGltcGxlbWVudGVkIG5hdGl2ZSBmdW5jdGlvbmFsaXR5CgkkKCBlLnRhcmdldCApLmZpbmQoICJpbnB1dCIgKS5ub3QoIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJdHlwZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCAidHlwZSIgKSwKCQkJb3B0VHlwZSA9IG9wdGlvbnMuZGVncmFkZUlucHV0c1sgdHlwZSBdIHx8ICJ0ZXh0IjsKCgkJaWYgKCBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSApIHsKCQkJdmFyIGh0bWwgPSAkKCAiPGRpdj4iICkuaHRtbCggJHRoaXMuY2xvbmUoKSApLmh0bWwoKSwKCQkJCS8vIEluIElFIGJyb3dzZXJzLCB0aGUgdHlwZSBzb21ldGltZXMgZG9lc24ndCBleGlzdCBpbiB0aGUgY2xvbmVkIG1hcmt1cCwgc28gd2UgcmVwbGFjZSB0aGUgY2xvc2luZyB0YWcgaW5zdGVhZAoJCQkJaGFzVHlwZSA9IGh0bWwuaW5kZXhPZiggIiB0eXBlPSIgKSA+IC0xLAoJCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LywKCQkJCXJlcHN0ciA9ICIgdHlwZT1cIiIgKyBvcHRUeXBlICsgIlwiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9XCIiICsgdHlwZSArICJcIiIgKyAoIGhhc1R5cGUgPyAiIiA6ICI+IiApOwoKCQkJJHRoaXMucmVwbGFjZVdpdGgoIGh0bWwucmVwbGFjZSggZmluZHN0ciwgcmVwc3RyICkgKTsKCQl9Cgl9KTsKCn0pOwoKfSkoIGpRdWVyeSApOy8qCiogImRpYWxvZyIgcGx1Z2luLgoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmRpYWxvZyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWNsb3NlQnRuVGV4dCAJOiAiQ2xvc2UiLAoJCW92ZXJsYXlUaGVtZQk6ICJhIiwKCQlpbml0U2VsZWN0b3IJOiAiOmpxbURhdGEocm9sZT0nZGlhbG9nJykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCWhlYWRlckNsb3NlQnV0dG9uID0gJCggIjxhIGhyZWY9JyMnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb249J2RlbGV0ZScgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcz0nbm90ZXh0Jz4iKyB0aGlzLm9wdGlvbnMuY2xvc2VCdG5UZXh0ICsgIjwvYT4iICk7CgoJCSRlbC5hZGRDbGFzcyggInVpLW92ZXJsYXktIiArIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCgkJLy8gQ2xhc3MgdGhlIG1hcmt1cCBmb3IgZGlhbG9nIHN0eWxpbmcKCQkvLyBTZXQgYXJpYSByb2xlCgkJJGVsLmF0dHIoICJyb2xlIiwgImRpYWxvZyIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1kaWFsb2ciICkKCQkJLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIHVpLW92ZXJsYXktc2hhZG93IiApCgkJCQkucHJlcGVuZCggaGVhZGVyQ2xvc2VCdXR0b24gKQoJCQkuZW5kKCkKCQkJLmZpbmQoICI6anFtRGF0YShyb2xlPSdjb250ZW50JyksOmpxbURhdGEocm9sZT0nZm9vdGVyJykiICkKCQkJCS5hZGRDbGFzcyggInVpLW92ZXJsYXktc2hhZG93IiApCgkJCQkubGFzdCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApOwoKCQkvLyB0aGlzIG11c3QgYmUgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgc2VsZWN0IG1lbnUgZGlhbG9ncyBjYW4gcmVwbGFjZQoJCS8vIHRoZSBjbG9zZSBtZXRob2QuIFRoaXMgaXMgYSBjaGFuZ2UgZnJvbSBwcmV2aW91c2x5IGp1c3QgZGVmaW5pbmcgZGF0YS1yZWw9YmFjawoJCS8vIG9uIHRoZSBidXR0b24gYW5kIGxldHRpbmcgbmF2IGhhbmRsZSBpdAoJCWhlYWRlckNsb3NlQnV0dG9uLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbigpIHsKCQkJc2VsZi5jbG9zZSgpOwoJCX0pOwoKCQkvKiBiaW5kIGV2ZW50cwoJCQktIGNsaWNrcyBhbmQgc3VibWl0cyBzaG91bGQgdXNlIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24gdGhhdCB0aGUgZGlhbG9nIG9wZW5lZCB3aXRoCgkJCSAgdW5sZXNzIGEgZGF0YS10cmFuc2l0aW9uIGlzIHNwZWNpZmllZCBvbiB0aGUgbGluay9mb3JtCgkJCS0gaWYgdGhlIGNsaWNrIHdhcyBvbiB0aGUgY2xvc2UgYnV0dG9uLCBvciB0aGUgbGluayBoYXMgYSBkYXRhLXJlbD0iYmFjayIgaXQnbGwgZ28gYmFjayBpbiBoaXN0b3J5IG5hdHVyYWxseQoJCSovCgkJJGVsLmJpbmQoICJ2Y2xpY2sgc3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siID8gImEiIDogImZvcm0iICksCgkJCQlhY3RpdmU7CgoJCQlpZiAoICR0YXJnZXQubGVuZ3RoICYmICEkdGFyZ2V0LmpxbURhdGEoICJ0cmFuc2l0aW9uIiApICkgewoKCQkJCWFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCkgfHwge307CgoJCQkJJHRhcmdldC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHJhbnNpdGlvbiIsICggYWN0aXZlLnRyYW5zaXRpb24gfHwgJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gKSApCgkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXJlY3Rpb24iLCAicmV2ZXJzZSIgKTsKCQkJfQoJCX0pCgkJLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuZmluZCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0sCgoJLy8gQ2xvc2UgbWV0aG9kIGdvZXMgYmFjayBpbiBoaXN0b3J5CgljbG9zZTogZnVuY3Rpb24oKSB7CgkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCAkLm1vYmlsZS5kaWFsb2cucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yICkubGl2ZSggInBhZ2VjcmVhdGUiLCBmdW5jdGlvbigpewoJJCggdGhpcyApLmRpYWxvZygpOwp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBUaGlzIHBsdWdpbiBoYW5kbGVzIHRoZW1pbmcgYW5kIGxheW91dCBvZiBoZWFkZXJzLCBmb290ZXJzLCBhbmQgY29udGVudCBhcmVhcwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UZXh0ICA9ICJCYWNrIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5hZGRCYWNrQnRuICAgPSBmYWxzZTsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGhlbWUgPSBudWxsOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmhlYWRlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5mb290ZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuY29udGVudFRoZW1lID0gbnVsbDsKCiQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmxpdmUoICJwYWdlY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkKCXZhciAkcGFnZSA9ICQoIHRoaXMgKSwKCQlvID0gJHBhZ2UuZGF0YSggInBhZ2UiICkub3B0aW9ucywKCQlwYWdlUm9sZSA9ICRwYWdlLmpxbURhdGEoICJyb2xlIiApLAoJCXBhZ2VUaGVtZSA9IG8udGhlbWU7CgkKCSQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSwgOmpxbURhdGEocm9sZT0nZm9vdGVyJyksIDpqcW1EYXRhKHJvbGU9J2NvbnRlbnQnKSIsIHRoaXMgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJcm9sZSA9ICR0aGlzLmpxbURhdGEoICJyb2xlIiApLAoJCQl0aGVtZSA9ICR0aGlzLmpxbURhdGEoICJ0aGVtZSIgKSwKCQkJY29udGVudFRoZW1lID0gdGhlbWUgfHwgby5jb250ZW50VGhlbWUgfHwgKCBwYWdlUm9sZSA9PT0gImRpYWxvZyIgJiYgcGFnZVRoZW1lICksCgkJCSRoZWFkZXJhbmNob3JzLAoJCQlsZWZ0YnRuLAoJCQlyaWdodGJ0biwKCQkJYmFja0J0bjsKCQkJCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS0iICsgcm9sZSApOwkKCgkJLy9hcHBseSB0aGVtaW5nIGFuZCBtYXJrdXAgbW9kaWZpY2F0aW9ucyB0byBwYWdlLGhlYWRlcixjb250ZW50LGZvb3RlcgoJCWlmICggcm9sZSA9PT0gImhlYWRlciIgfHwgcm9sZSA9PT0gImZvb3RlciIgKSB7CgkJCQoJCQl2YXIgdGhpc1RoZW1lID0gdGhlbWUgfHwgKCByb2xlID09PSAiaGVhZGVyIiA/IG8uaGVhZGVyVGhlbWUgOiBvLmZvb3RlclRoZW1lICkgfHwgcGFnZVRoZW1lOwoKCQkJJHRoaXMKCQkJCS8vYWRkIHRoZW1lIGNsYXNzCgkJCQkuYWRkQ2xhc3MoICJ1aS1iYXItIiArIHRoaXNUaGVtZSApCgkJCQkvLyBBZGQgQVJJQSByb2xlCgkJCQkuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApOwoKCQkJLy8gUmlnaHQsbGVmdCBidXR0b25zCgkJCSRoZWFkZXJhbmNob3JzCT0gJHRoaXMuY2hpbGRyZW4oICJhIiApOwoJCQlsZWZ0YnRuCT0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKTsKCQkJcmlnaHRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCWxlZnRidG4gPSBsZWZ0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAwICkubm90KCAiLnVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCQkJCgkJCXJpZ2h0YnRuID0gcmlnaHRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDEgKS5hZGRDbGFzcyggInVpLWJ0bi1yaWdodCIgKS5sZW5ndGg7CgkJCQoJCQkvLyBBdXRvLWFkZCBiYWNrIGJ0biBvbiBwYWdlcyBiZXlvbmQgZmlyc3QgdmlldwoJCQlpZiAoIG8uYWRkQmFja0J0biAmJiAKCQkJCXJvbGUgPT09ICJoZWFkZXIiICYmCgkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJJHRoaXMuanFtRGF0YSggInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJIWxlZnRidG4gKSB7CgoJCQkJYmFja0J0biA9ICQoICI8YSBocmVmPScjJyBjbGFzcz0ndWktYnRuLWxlZnQnIGRhdGEtIisgJC5tb2JpbGUubnMgKyJyZWw9J2JhY2snIGRhdGEtIisgJC5tb2JpbGUubnMgKyJpY29uPSdhcnJvdy1sJz4iKyBvLmJhY2tCdG5UZXh0ICsiPC9hPiIgKQoJCQkJCS8vIElmIHRoZW1lIGlzIHByb3ZpZGVkLCBvdmVycmlkZSBkZWZhdWx0IGluaGVyaXRhbmNlCgkJCQkJLmF0dHIoICJkYXRhLSIrICQubW9iaWxlLm5zICsidGhlbWUiLCBvLmJhY2tCdG5UaGVtZSB8fCB0aGlzVGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oICR0aGlzICk7CQkJCQoJCQl9CgoJCQkvLyBQYWdlIHRpdGxlCgkJCSR0aGlzLmNoaWxkcmVuKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKQoJCQkJLmFkZENsYXNzKCAidWktdGl0bGUiICkKCQkJCS8vIFJlZ2FyZGxlc3Mgb2YgaCBlbGVtZW50IG51bWJlciBpbiBzcmMsIGl0IGJlY29tZXMgaDEgZm9yIHRoZSBlbmhhbmNlZCBwYWdlCgkJCQkuYXR0cih7CgkJCQkJInRhYmluZGV4IjogIjAiLAoJCQkJCSJyb2xlIjogImhlYWRpbmciLAoJCQkJCSJhcmlhLWxldmVsIjogIjEiCgkJCQl9KTsKCgkJfSBlbHNlIGlmICggcm9sZSA9PT0gImNvbnRlbnQiICkgewoJCQlpZiAoIGNvbnRlbnRUaGVtZSApIHsKCQkJICAgICR0aGlzLmFkZENsYXNzKCAidWktYm9keS0iICsgKCBjb250ZW50VGhlbWUgKSApOwoJCQl9CgoJCQkvLyBBZGQgQVJJQSByb2xlCgkJCSR0aGlzLmF0dHIoICJyb2xlIiwgIm1haW4iICk7CgkJfQoJfSk7Cn0pOwoKfSkoIGpRdWVyeSApOy8qCiogImNvbGxhcHNpYmxlIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgkJY29sbGFwc2VDdWVUZXh0OiAiIGNsaWNrIHRvIGNvbGxhcHNlIGNvbnRlbnRzIiwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJdGhlbWU6IG51bGwsCgkJY29udGVudFRoZW1lOiBudWxsLAoJCWljb25UaGVtZTogImQiLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWNvbGxhcHNpYmxlID0gJGVsLmFkZENsYXNzKCAidWktY29sbGFwc2libGUiICksCgkJCWNvbGxhcHNpYmxlSGVhZGluZyA9ICRlbC5jaGlsZHJlbiggby5oZWFkaW5nICkuZmlyc3QoKSwKCQkJY29sbGFwc2libGVDb250ZW50ID0gY29sbGFwc2libGUud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCc+PC9kaXY+IiApLmZpbmQoICIudWktY29sbGFwc2libGUtY29udGVudCIgKSwKCQkJY29sbGFwc2libGVTZXQgPSAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApLAoJCQljb2xsYXBzaWJsZXNJblNldCA9IGNvbGxhcHNpYmxlU2V0LmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIgKTsKCgkJLy8gUmVwbGFjZSBjb2xsYXBzaWJsZUhlYWRpbmcgaWYgaXQncyBhIGxlZ2VuZAoJCWlmICggY29sbGFwc2libGVIZWFkaW5nLmlzKCAibGVnZW5kIiApICkgewoJCQljb2xsYXBzaWJsZUhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyBjb2xsYXBzaWJsZUhlYWRpbmcuaHRtbCgpICsiPC9kaXY+IiApLmluc2VydEJlZm9yZSggY29sbGFwc2libGVIZWFkaW5nICk7CgkJCWNvbGxhcHNpYmxlSGVhZGluZy5uZXh0KCkucmVtb3ZlKCk7CgkJfQoKCQkvLyBJZiB3ZSBhcmUgaW4gYSBjb2xsYXBzaWJsZSBzZXQKCQlpZiAoIGNvbGxhcHNpYmxlU2V0Lmxlbmd0aCApIHsKCQkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby50aGVtZSApIHsKCQkJCW8udGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAidGhlbWUiICk7CgkJCX0KCQkJLy8gSW5oZXJpdCB0aGUgY29udGVudC10aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCQlpZiAoICFvLmNvbnRlbnRUaGVtZSApIHsKCQkJCW8uY29udGVudFRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImNvbnRlbnQtdGhlbWUiICk7CgkJCX0KCQl9CgoJCWNvbGxhcHNpYmxlQ29udGVudC5hZGRDbGFzcyggKCBvLmNvbnRlbnRUaGVtZSApID8gKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKSA6ICIiKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS8vZHJvcCBoZWFkaW5nIGluIGJlZm9yZSBjb250ZW50CgkJCS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlQ29udGVudCApCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApCgkJCS53cmFwSW5uZXIoICI8YSBocmVmPScjJyBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy10b2dnbGUnPjwvYT4iICkKCQkJLmZpbmQoICJhIiApCgkJCQkuZmlyc3QoKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQlpY29uUG9zOiAibGVmdCIsCgkJCQkJaWNvbjogInBsdXMiLAoJCQkJCXRoZW1lOiBvLnRoZW1lCgkJCQl9KTsKCgkJaWYgKCAhY29sbGFwc2libGVTZXQubGVuZ3RoICkgewoJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLmFkZCggY29sbGFwc2libGVIZWFkaW5nLmZpbmQoICIudWktYnRuLWlubmVyIiApICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20iICk7CgkJfSBlbHNlIHsKCQkJLy8gSWYgd2UgYXJlIGluIGEgY29sbGFwc2libGUgc2V0CgoJCQkvLyBJbml0aWFsaXplIHRoZSBjb2xsYXBzaWJsZSBzZXQgaWYgaXQncyBub3QgYWxyZWFkeSBpbml0aWFsaXplZAoJCQlpZiAoICFjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIgKSApIHsKCgkJCQljb2xsYXBzaWJsZVNldAoJCQkJCS5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIsIHRydWUgKQoJCQkJCS5iaW5kKCAiZXhwYW5kIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCQkJJCggZXZlbnQudGFyZ2V0ICkKCQkJCQkJCS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApCgkJCQkJCQkuc2libGluZ3MoICIudWktY29sbGFwc2libGUiICkKCQkJCQkJCS50cmlnZ2VyKCAiY29sbGFwc2UiICk7CgoJCQkJCX0pOwoJCQl9CgoJCQljb2xsYXBzaWJsZXNJblNldC5maXJzdCgpCgkJCQkuZmluZCggImEiICkKCQkJCQkuZmlyc3QoKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICkKCQkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApOwoKCQkJY29sbGFwc2libGVzSW5TZXQubGFzdCgpCgkJCQkuanFtRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiLCB0cnVlICkKCQkJCS5maW5kKCAiYSIgKQoJCQkJCS5maXJzdCgpCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKQoJCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20iICk7CgoKCQkJaWYgKCBjb2xsYXBzaWJsZS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIgKSApIHsKCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLmFkZCAoIGNvbGxhcHNpYmxlSGVhZGluZy5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKSApCgkJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20iICk7CgkJCX0KCQl9CgoJCS8vZXZlbnRzCgkJY29sbGFwc2libGUKCQkJLmJpbmQoICJleHBhbmQgY29sbGFwc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCQlpc0NvbGxhcHNlID0gKCBldmVudC50eXBlID09PSAiY29sbGFwc2UiICksCgkJCQkJICAgIGNvbnRlbnRUaGVtZSA9IG8uY29udGVudFRoZW1lOwoKCQkJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlKQoJCQkJCQkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyIgKQoJCQkJCQkJLnRleHQoIGlzQ29sbGFwc2UgPyBvLmV4cGFuZEN1ZVRleHQgOiBvLmNvbGxhcHNlQ3VlVGV4dCApCgkJCQkJCS5lbmQoKQoJCQkJCQkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLW1pbnVzIiwgIWlzQ29sbGFwc2UgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1wbHVzIiwgaXNDb2xsYXBzZSApOwoKCQkJCQkkdGhpcy50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKTsKCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKS5hdHRyKCAiYXJpYS1oaWRkZW4iLCBpc0NvbGxhcHNlICk7CgoJCQkJCWlmICggY29udGVudFRoZW1lICYmICggIWNvbGxhcHNpYmxlU2V0Lmxlbmd0aCB8fCBjb2xsYXBzaWJsZS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIgKSApICkgewoJCQkJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLmFkZCggY29sbGFwc2libGVIZWFkaW5nLmZpbmQoICIudWktYnRuLWlubmVyIiApICkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1ib3R0b20iLCBpc0NvbGxhcHNlICk7CgkJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1ib3R0b20iLCAhaXNDb2xsYXBzZSApOwoJCQkJCX0KCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudHJpZ2dlciggInVwZGF0ZWxheW91dCIgKTsKCQkJCX0KCQkJfSkKCQkJLnRyaWdnZXIoIG8uY29sbGFwc2VkID8gImNvbGxhcHNlIiA6ICJleHBhbmQiICk7CgoJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCXZhciB0eXBlID0gY29sbGFwc2libGVIZWFkaW5nLmlzKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiApID8KCQkJCQkJCQkJCSJleHBhbmQiIDogImNvbGxhcHNlIjsKCgkJCQljb2xsYXBzaWJsZS50cmlnZ2VyKCB0eXBlICk7CgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICQubW9iaWxlLmNvbGxhcHNpYmxlLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5jb2xsYXBzaWJsZSgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAiZmllbGRjb250YWluIiBwbHVnaW4gLSBzaW1wbGUgY2xhc3MgYWRkaXRpb25zIHRvIG1ha2UgZm9ybSByb3cgc2VwYXJhdG9ycwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIHVpLWJvZHkgdWktYnIiICk7Cn07CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJCggIjpqcW1EYXRhKHJvbGU9J2ZpZWxkY29udGFpbicpIiwgZS50YXJnZXQgKS5maWVsZGNvbnRhaW4oKTsKfSk7Cgp9KSggalF1ZXJ5ICk7LyoKKiBwbHVnaW4gZm9yIGNyZWF0aW5nIENTUyBncmlkcwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmdyaWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCWdyaWQ6IG51bGwKCQkJfSxvcHRpb25zKSwKCQkJJGtpZHMgPSAkdGhpcy5jaGlsZHJlbigpLAoJCQlncmlkQ29scyA9IHtzb2xvOjEsIGE6MiwgYjozLCBjOjQsIGQ6NX0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggdmFyIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQl9CgkJCX0KCQkJaXRlcmF0b3IgPSBncmlkQ29sc1tncmlkXTsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLSIgKyBncmlkICk7CgoJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1hIiApOwoKCQlpZiAoIGl0ZXJhdG9yID4gMSApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisyKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWIiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAyICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKDNuKzMpIiApLmFkZENsYXNzKCAidWktYmxvY2stYyIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDMgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoNG4rNCkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1kIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gNCApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCg1bis1KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWUiICk7CgkJfQoJfSk7Cn07Cn0pKCBqUXVlcnkgKTsvKgoqICJuYXZiYXIiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J25hdmJhcicpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpewoKCQl2YXIgJG5hdmJhciA9IHRoaXMuZWxlbWVudCwKCQkJJG5hdmJ0bnMgPSAkbmF2YmFyLmZpbmQoICJhIiApLAoJCQlpY29ucG9zID0gJG5hdmJ0bnMuZmlsdGVyKCAiOmpxbURhdGEoaWNvbikiICkubGVuZ3RoID8KCQkJCQkJCQkJdGhpcy5vcHRpb25zLmljb25wb3MgOiB1bmRlZmluZWQ7CgoJCSRuYXZiYXIuYWRkQ2xhc3MoICJ1aS1uYXZiYXIiICkKCQkJLmF0dHIoICJyb2xlIiwibmF2aWdhdGlvbiIgKQoJCQkuZmluZCggInVsIiApCgkJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQlpZiAoICFpY29ucG9zICkgewoJCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyLW5vaWNvbnMiICk7CgkJfQoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkkbmF2YnRucy5ub3QoICIudWktc3RhdGUtcGVyc2lzdCIgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0pOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkKCAkLm1vYmlsZS5uYXZiYXIucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCBlLnRhcmdldCApLm5hdmJhcigpOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAibGlzdHZpZXciIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovL0tlZXBzIHRyYWNrIG9mIHRoZSBudW1iZXIgb2YgbGlzdHMgcGVyIHBhZ2UgVUlECi8vVGhpcyBhbGxvd3Mgc3VwcG9ydCBmb3IgbXVsdGlwbGUgbmVzdGVkIGxpc3QgaW4gdGhlIHNhbWUgcGFnZQovL2h0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMTYxNwp2YXIgbGlzdENvdW50UGVyUGFnZSA9IHt9OwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3VudFRoZW1lOiAiYyIsCgkJaGVhZGVyVGhlbWU6ICJiIiwKCQlkaXZpZGVyVGhlbWU6ICJiIiwKCQlzcGxpdEljb246ICJhcnJvdy1yIiwKCQlzcGxpdFRoZW1lOiAiYiIsCgkJaW5zZXQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2xpc3R2aWV3JykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0ID0gdGhpczsKCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyhmdW5jdGlvbiggaSwgb3JpZyApIHsKCQkJcmV0dXJuIG9yaWcgKyAiIHVpLWxpc3R2aWV3ICIgKyAoIHQub3B0aW9ucy5pbnNldCA/ICIgdWktbGlzdHZpZXctaW5zZXQgdWktY29ybmVyLWFsbCB1aS1zaGFkb3cgIiA6ICIiICk7CgkJfSk7CgoJCXQucmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfcmVtb3ZlQ29ybmVyczogZnVuY3Rpb24oIGxpLCB3aGljaCApIHsKCQl2YXIgdG9wID0gInVpLWNvcm5lci10b3AgdWktY29ybmVyLXRyIHVpLWNvcm5lci10bCIsCgkJCWJvdCA9ICJ1aS1jb3JuZXItYm90dG9tIHVpLWNvcm5lci1iciB1aS1jb3JuZXItYmwiOwoKCQlsaSA9IGxpLmFkZCggbGkuZmluZCggIi51aS1idG4taW5uZXIsIC51aS1saS1saW5rLWFsdCwgLnVpLWxpLXRodW1iIiApICk7CgoJCWlmICggd2hpY2ggPT09ICJ0b3AiICkgewoJCQlsaS5yZW1vdmVDbGFzcyggdG9wICk7CgkJfSBlbHNlIGlmICggd2hpY2ggPT09ICJib3R0b20iICkgewoJCQlsaS5yZW1vdmVDbGFzcyggYm90ICk7CgkJfSBlbHNlIHsKCQkJbGkucmVtb3ZlQ2xhc3MoIHRvcCArICIgIiArIGJvdCApOwoJCX0KCX0sCgoJX3JlZnJlc2hDb3JuZXJzOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciAkbGksCgkJCSR2aXNpYmxlbGksCgkJCSR0b3BsaSwKCQkJJGJvdHRvbWxpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5pbnNldCApIHsKCQkJJGxpID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAibGkiICk7CgkJCS8vIGF0IGNyZWF0ZSB0aW1lIHRoZSBsaSBhcmUgbm90IHZpc2libGUgeWV0IHNvIHdlIG5lZWQgdG8gcmVseSBvbiAudWktc2NyZWVuLWhpZGRlbgoJCQkkdmlzaWJsZWxpID0gY3JlYXRlPyRsaS5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTokbGkuZmlsdGVyKCAiOnZpc2libGUiICk7CgoJCQl0aGlzLl9yZW1vdmVDb3JuZXJzKCAkbGkgKTsKCgkJCS8vIFNlbGVjdCB0aGUgZmlyc3QgdmlzaWJsZSBsaSBlbGVtZW50CgkJCSR0b3BsaSA9ICR2aXNpYmxlbGkuZmlyc3QoKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKTsKCgkJCSR0b3BsaS5hZGQoICR0b3BsaS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCS5ub3QoICIudWktbGktbGluay1hbHQgc3BhbjpmaXJzdC1jaGlsZCIgKSApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktbGluay1hbHQsIC51aS1saS1saW5rLWFsdCBzcGFuOmZpcnN0LWNoaWxkIiApCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRyIiApCgkJCQkuZW5kKCkKCQkJCS5maW5kKCAiLnVpLWxpLXRodW1iIiApCgkJCQkJLm5vdCgiLnVpLWxpLWljb24iKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10bCIgKTsKCgkJCS8vIFNlbGVjdCB0aGUgbGFzdCB2aXNpYmxlIGxpIGVsZW1lbnQKCQkJJGJvdHRvbWxpID0gJHZpc2libGVsaS5sYXN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20iICk7CgoJCQkkYm90dG9tbGkuYWRkKCAkYm90dG9tbGkuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJLmZpbmQoICIudWktbGktbGluay1hbHQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYnIiICkKCQkJCS5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktdGh1bWIiICkKCQkJCQkubm90KCIudWktbGktaWNvbiIpCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJsIiApOwoJCX0KCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0sCgoJLy8gVGhpcyBpcyBhIGdlbmVyaWMgdXRpbGl0eSBtZXRob2QgZm9yIGZpbmRpbmcgdGhlIGZpcnN0CgkvLyBub2RlIHdpdGggYSBnaXZlbiBub2RlTmFtZS4gSXQgdXNlcyBiYXNpYyBET00gdHJhdmVyc2FsCgkvLyB0byBiZSBmYXN0IGFuZCBpcyBtZWFudCB0byBiZSBhIHN1YnN0aXR1dGUgZm9yIHNpbXBsZQoJLy8gJC5mbi5jbG9zZXN0KCkgYW5kICQuZm4uY2hpbGRyZW4oKSBjYWxscyBvbiBhIHNpbmdsZQoJLy8gZWxlbWVudC4gTm90ZSB0aGF0IGNhbGxlcnMgbXVzdCBwYXNzIGJvdGggdGhlIGxvd2VyQ2FzZQoJLy8gYW5kIHVwcGVyQ2FzZSB2ZXJzaW9uIG9mIHRoZSBub2RlTmFtZSB0aGV5IGFyZSBsb29raW5nIGZvci4KCS8vIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcyBpcyB0aGF0IHRoaXMgZnVuY3Rpb24gd2lsbCBiZQoJLy8gY2FsbGVkIG1hbnkgdGltZXMgYW5kIHdlIHdhbnQgdG8gYXZvaWQgaGF2aW5nIHRvIGxvd2VyY2FzZQoJLy8gdGhlIG5vZGVOYW1lIGZyb20gdGhlIGVsZW1lbnQgZXZlcnkgdGltZSB0byBlbnN1cmUgd2UgaGF2ZQoJLy8gYSBtYXRjaC4gTm90ZSB0aGF0IHRoaXMgZnVuY3Rpb24gbGl2ZXMgaGVyZSBmb3Igbm93LCBidXQgbWF5CgkvLyBiZSBtb3ZlZCBpbnRvICQubW9iaWxlIGlmIG90aGVyIGNvbXBvbmVudHMgbmVlZCBhIHNpbWlsYXIgbWV0aG9kLgoJX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIG5leHRQcm9wLCBsY05hbWUsIHVjTmFtZSApCgl7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkKCXsKCQl2YXIgcmVzdWx0cyA9IFtdLAoJCQlkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJZWxlID0gZWxlLmZpcnN0Q2hpbGQ7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZSApOwoJCQl9CgkJCWVsZSA9IGVsZS5uZXh0U2libGluZzsKCQl9CgkJcmV0dXJuICQoIHJlc3VsdHMgKTsKCX0sCgoJX2FkZFRodW1iQ2xhc3NlczogZnVuY3Rpb24oIGNvbnRhaW5lcnMgKQoJewoJCXZhciBpLCBpbWcsIGxlbiA9IGNvbnRhaW5lcnMubGVuZ3RoOwoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWltZyA9ICQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGNvbnRhaW5lcnNbIGkgXS5maXJzdENoaWxkLCAibmV4dFNpYmxpbmciLCAiaW1nIiwgIklNRyIgKSApOwoJCQlpZiAoIGltZy5sZW5ndGggKSB7CgkJCQlpbWcuYWRkQ2xhc3MoICJ1aS1saS10aHVtYiIgKTsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5pcyggIi51aS1saS1pY29uIiApID8gInVpLWxpLWhhcy1pY29uIiA6ICJ1aS1saS1oYXMtdGh1bWIiICk7CgkJCX0KCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5wYXJlbnRQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQl0aGlzLl9jcmVhdGVTdWJQYWdlcygpOwoKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCXNlbGYgPSB0aGlzLAoJCQlkaXZpZGVydGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAiZGl2aWRlcnRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lLAoJCQlsaXN0c3BsaXR0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJzcGxpdHRoZW1lIiApLAoJCQlsaXN0c3BsaXRpY29uID0gJGxpc3QuanFtRGF0YSggInNwbGl0aWNvbiIgKSwKCQkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApLAoJCQljb3VudGVyID0gJC5zdXBwb3J0LmNzc1BzZXVkb0VsZW1lbnQgfHwgISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSA/IDAgOiAxLAoJCQlpdGVtQ2xhc3NEaWN0ID0ge30sCgkJCWl0ZW0sIGl0ZW1DbGFzcywgaXRlbVRoZW1lLAoJCQlhLCBsYXN0LCBzcGxpdHRoZW1lLCBjb3VudFBhcmVudCwgaWNvbiwgaW1nUGFyZW50cywgaW1nOwoKCQlpZiAoIGNvdW50ZXIgKSB7CgkJCSRsaXN0LmZpbmQoICIudWktbGktZGVjIiApLnJlbW92ZSgpOwoJCX0KCQkKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQlmb3IgKCB2YXIgcG9zID0gMCwgbnVtbGkgPSBsaS5sZW5ndGg7IHBvcyA8IG51bWxpOyBwb3MrKyApIHsKCQkJaXRlbSA9IGxpLmVxKCBwb3MgKTsKCQkJaXRlbUNsYXNzID0gInVpLWxpIjsKCgkJCS8vIElmIHdlJ3JlIGNyZWF0aW5nIHRoZSBlbGVtZW50LCB3ZSB1cGRhdGUgaXQgcmVnYXJkbGVzcwoJCQlpZiAoIGNyZWF0ZSB8fCAhaXRlbS5oYXNDbGFzcyggInVpLWxpIiApICkgewoJCQkJaXRlbVRoZW1lID0gaXRlbS5qcW1EYXRhKCJ0aGVtZSIpIHx8IG8udGhlbWU7CgkJCQlhID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIGl0ZW1bIDAgXSwgImEiLCAiQSIgKTsKCgkJCQlpZiAoIGEubGVuZ3RoICkgewoJCQkJCWljb24gPSBpdGVtLmpxbURhdGEoImljb24iKTsKCgkJCQkJaXRlbS5idXR0b25NYXJrdXAoewoJCQkJCQl3cmFwcGVyRWxzOiAiZGl2IiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCWljb25wb3M6ICJyaWdodCIsCgkJCQkJCWljb246IGEubGVuZ3RoID4gMSB8fCBpY29uID09PSBmYWxzZSA/IGZhbHNlIDogaWNvbiB8fCAiYXJyb3ctciIsCgkJCQkJCXRoZW1lOiBpdGVtVGhlbWUKCQkJCQl9KTsKCgkJCQkJaWYgKCAoIGljb24gIT0gZmFsc2UgKSAmJiAoIGEubGVuZ3RoID09IDEgKSApIHsKCQkJCQkJaXRlbS5hZGRDbGFzcyggInVpLWxpLWhhcy1hcnJvdyIgKTsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5hZGRDbGFzcyggInVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gbGlzdHNwbGl0dGhlbWUgfHwgbGFzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lOwoKCQkJCQkJbGFzdC5hcHBlbmRUbyhpdGVtKQoJCQkJCQkJLmF0dHIoICJ0aXRsZSIsIGxhc3QuZ2V0RW5jb2RlZFRleHQoKSApCgkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1saS1saW5rLWFsdCIgKQoJCQkJCQkJLmVtcHR5KCkKCQkJCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZSwKCQkJCQkJCQlpY29uOiBmYWxzZSwKCQkJCQkJCQlpY29ucG9zOiBmYWxzZQoJCQkJCQkJfSkKCQkJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJCS5hcHBlbmQoCgkJCQkJCQkJCSQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApICkuYnV0dG9uTWFya3VwKHsKCQkJCQkJCQkJCXNoYWRvdzogdHJ1ZSwKCQkJCQkJCQkJCWNvcm5lcnM6IHRydWUsCgkJCQkJCQkJCQl0aGVtZTogc3BsaXR0aGVtZSwKCQkJCQkJCQkJCWljb25wb3M6ICJub3RleHQiLAoJCQkJCQkJCQkJaWNvbjogbGlzdHNwbGl0aWNvbiB8fCBsYXN0LmpxbURhdGEoICJpY29uIiApIHx8IG8uc3BsaXRJY29uCgkJCQkJCQkJCX0pCgkJCQkJCQkJKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBpdGVtLmpxbURhdGEoICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApIHsKCgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktZGl2aWRlciB1aS1idG4gdWktYmFyLSIgKyBkaXZpZGVydGhlbWU7CgkJCQkJaXRlbS5hdHRyKCAicm9sZSIsICJoZWFkaW5nIiApOwoKCQkJCQkvL3Jlc2V0IGNvdW50ZXIgd2hlbiBhIGRpdmlkZXIgaGVhZGluZyBpcyBlbmNvdW50ZXJlZAoJCQkJCWlmICggY291bnRlciApIHsKCQkJCQkJY291bnRlciA9IDE7CgkJCQkJfQoKCQkJCX0gZWxzZSB7CgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktc3RhdGljIHVpLWJvZHktIiArIGl0ZW1UaGVtZTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBjb3VudGVyICYmIGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktZGl2aWRlciIgKSA8IDAgKSB7CgkJCQljb3VudFBhcmVudCA9IGl0ZW0uaXMoICIudWktbGktc3RhdGljOmZpcnN0IiApID8gaXRlbSA6IGl0ZW0uZmluZCggIi51aS1saW5rLWluaGVyaXQiICk7CgoJCQkJY291bnRQYXJlbnQuYWRkQ2xhc3MoICJ1aS1saS1qc251bWJlcmluZyIgKQoJCQkJCS5wcmVwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWxpLWRlYyc+IiArIChjb3VudGVyKyspICsgIi4gPC9zcGFuPiIgKTsKCQkJfQoKCQkJLy8gSW5zdGVhZCBvZiBzZXR0aW5nIGl0ZW0gY2xhc3MgZGlyZWN0bHkgb24gdGhlIGxpc3QgaXRlbSBhbmQgaXRzCgkJCS8vIGJ0bi1pbm5lciBhdCB0aGlzIHBvaW50IGluIHRpbWUsIHB1c2ggdGhlIGl0ZW0gaW50byBhIGRpY3Rpb25hcnkKCQkJLy8gdGhhdCB0ZWxscyB1cyB3aGF0IGNsYXNzIHRvIHNldCBvbiBpdCBzbyB3ZSBjYW4gZG8gdGhpcyBhZnRlciB0aGlzCgkJCS8vIHByb2Nlc3NpbmcgbG9vcCBpcyBmaW5pc2hlZC4KCgkJCWlmICggIWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkgewoJCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gPSBbXTsKCQkJfQoKCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0ucHVzaCggaXRlbVsgMCBdICk7CgkJfQoKCQkvLyBTZXQgdGhlIGFwcHJvcHJpYXRlIGxpc3R2aWV3IGl0ZW0gY2xhc3NlcyBvbiBlYWNoIGxpc3QgaXRlbQoJCS8vIGFuZCB0aGVpciBidG4taW5uZXIgZWxlbWVudHMuIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApLmNoaWxkcmVuKCAiLnVpLWJ0bi1pbm5lciIgKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQkkbGlzdC5maW5kKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKS5hZGRDbGFzcyggInVpLWxpLWhlYWRpbmciICkKCQkJLmVuZCgpCgoJCQkuZmluZCggInAsIGRsIiApLmFkZENsYXNzKCAidWktbGktZGVzYyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWFzaWRlIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCh0aGlzKTsKCQkJCQkkdGhpcy5wcmVwZW5kVG8oICR0aGlzLnBhcmVudCgpICk7IC8vc2hpZnQgYXNpZGUgdG8gZnJvbnQgZm9yIGNzcyBmbG9hdAoJCQkJfSkKCQkJLmVuZCgpCgoJCQkuZmluZCggIi51aS1saS1jb3VudCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCQkJfSkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArICggJGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUpICsgIiB1aS1idG4tY29ybmVyLWFsbCIgKTsKCgkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBsb29rIGF0IHRoZSBmaXJzdCBpbWFnZSBpbiB0aGUgbGlzdCBpdGVtCgkJLy8gaXRzZWxmLCBhbmQgYW55IC51aS1saW5rLWluaGVyaXQgZWxlbWVudCBpdCBtYXkgY29udGFpbiwgc28gd2UKCQkvLyBjYW4gcGxhY2UgdGhlIGFwcHJvcHJpYXRlIGNsYXNzZXMgb24gdGhlIGltYWdlIGFuZCBsaXN0IGl0ZW0uCgkJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIHNvbWV0aGluZyBsaWtlOgoJCS8vCgkJLy8gICAgbGkuZmluZCgiPmltZzplcSgwKSwgLnVpLWxpbmstaW5oZXJpdD5pbWc6ZXEoMCkiKS5lYWNoKCAuLi4gKTsKCQkvLwoJCS8vIEJ1dCBleGVjdXRpbmcgYSBmaW5kKCkgbGlrZSB0aGF0IG9uIFdpbmRvd3MgUGhvbmUgNy41IHRvb2sgYQoJCS8vIHJlYWxseSBsb25nIHRpbWUuIFdhbGtpbmcgdGhpbmdzIG1hbnVhbGx5IHdpdGggdGhlIGNvZGUgYmVsb3cKCQkvLyBhbGxvd3MgdGhlIDQwMCBsaXN0dmlldyBpdGVtIHBhZ2UgdG8gbG9hZCBpbiBhYm91dCAzIHNlY29uZHMgYXMKCQkvLyBvcHBvc2VkIHRvIDMwIHNlY29uZHMuCgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoICRsaXN0LmZpbmQoICIudWktbGluay1pbmhlcml0IiApICk7CgoJCXRoaXMuX3JlZnJlc2hDb3JuZXJzKCBjcmVhdGUgKTsKCX0sCgoJLy9jcmVhdGUgYSBzdHJpbmcgZm9yIElEL3N1YnBhZ2UgdXJsIGNyZWF0aW9uCglfaWRTdHJpbmdFc2NhcGU6IGZ1bmN0aW9uKCBzdHIgKSB7CgkJcmV0dXJuIHN0ci5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywgJy0nKTsKCX0sCgoJX2NyZWF0ZVN1YlBhZ2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFyZW50TGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50UGFnZSA9IHBhcmVudExpc3QuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlwYXJlbnRVcmwgPSBwYXJlbnRQYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCXBhcmVudElkID0gcGFyZW50VXJsIHx8IHBhcmVudFBhZ2VbIDAgXVsgJC5leHBhbmRvIF0sCgkJCXBhcmVudExpc3RJZCA9IHBhcmVudExpc3QuYXR0ciggImlkIiApLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlkbnMgPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCXNlbGYgPSB0aGlzLAoJCQlwZXJzaXN0ZW50Rm9vdGVySUQgPSBwYXJlbnRQYWdlLmZpbmQoICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKS5qcW1EYXRhKCAiaWQiICksCgkJCWhhc1N1YlBhZ2VzOwoKCQlpZiAoIHR5cGVvZiBsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID09PSAidW5kZWZpbmVkIiApIHsKCQkJbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXSA9IC0xOwoJCX0KCgkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdElkIHx8ICsrbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXTsKCgkJJCggcGFyZW50TGlzdC5maW5kKCAibGk+dWwsIGxpPm9sIiApLnRvQXJyYXkoKS5yZXZlcnNlKCkgKS5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlsaXN0ID0gJCggdGhpcyApLAoJCQkJbGlzdElkID0gbGlzdC5hdHRyKCAiaWQiICkgfHwgcGFyZW50TGlzdElkICsgIi0iICsgaSwKCQkJCXBhcmVudCA9IGxpc3QucGFyZW50KCksCgkJCQlub2RlRWxzID0gJCggbGlzdC5wcmV2QWxsKCkudG9BcnJheSgpLnJldmVyc2UoKSApLAoJCQkJbm9kZUVscyA9IG5vZGVFbHMubGVuZ3RoID8gbm9kZUVscyA6ICQoICI8c3Bhbj4iICsgJC50cmltKHBhcmVudC5jb250ZW50cygpWyAwIF0ubm9kZVZhbHVlKSArICI8L3NwYW4+IiApLAoJCQkJdGl0bGUgPSBub2RlRWxzLmZpcnN0KCkuZ2V0RW5jb2RlZFRleHQoKSwvL3VybCBsaW1pdHMgdG8gZmlyc3QgMzAgY2hhcnMgb2YgdGV4dAoJCQkJaWQgPSAoIHBhcmVudFVybCB8fCAiIiApICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArICI9IiArIGxpc3RJZCwKCQkJCXRoZW1lID0gbGlzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby50aGVtZSwKCQkJCWNvdW50VGhlbWUgPSBsaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IHBhcmVudExpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgby5jb3VudFRoZW1lLAoJCQkJbmV3UGFnZSwgYW5jaG9yOwoKCQkJLy9kZWZpbmUgaGFzU3ViUGFnZXMgZm9yIHVzZSBpbiBsYXRlciByZW1vdmFsCgkJCWhhc1N1YlBhZ2VzID0gdHJ1ZTsKCgkJCW5ld1BhZ2UgPSBsaXN0LmRldGFjaCgpCgkJCQkJCS53cmFwKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J3BhZ2UnICIgKwlkbnMgKyAidXJsPSciICsgaWQgKyAiJyAiICsgZG5zICsgInRoZW1lPSciICsgdGhlbWUgKyAiJyAiICsgZG5zICsgImNvdW50LXRoZW1lPSciICsgY291bnRUaGVtZSArICInPjxkaXYgIiArIGRucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj48L2Rpdj4iICkKCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkuYmVmb3JlKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2hlYWRlcicgIiArIGRucyArICJ0aGVtZT0nIiArIG8uaGVhZGVyVGhlbWUgKyAiJz48ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIHRpdGxlICsgIjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkJLmFmdGVyKCBwZXJzaXN0ZW50Rm9vdGVySUQgPyAkKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2Zvb3RlcicgIiArIGRucyArICJpZD0nIisgcGVyc2lzdGVudEZvb3RlcklEICsiJz4iKSA6ICIiICkKCQkJCQkJCS5wYXJlbnQoKQoJCQkJCQkJCS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJbmV3UGFnZS5wYWdlKCk7CgoJCQlhbmNob3IgPSBwYXJlbnQuZmluZCgnYTpmaXJzdCcpOwoKCQkJaWYgKCAhYW5jaG9yLmxlbmd0aCApIHsKCQkJCWFuY2hvciA9ICQoICI8YS8+IiApLmh0bWwoIG5vZGVFbHMgfHwgdGl0bGUgKS5wcmVwZW5kVG8oIHBhcmVudC5lbXB0eSgpICk7CgkJCX0KCgkJCWFuY2hvci5hdHRyKCAiaHJlZiIsICIjIiArIGlkICk7CgoJCX0pLmxpc3R2aWV3KCk7CgoJCS8vIG9uIHBhZ2VoaWRlLCByZW1vdmUgYW55IG5lc3RlZCBwYWdlcyBhbG9uZyB3aXRoIHRoZSBwYXJlbnQgcGFnZSwgYXMgbG9uZyBhcyB0aGV5IGFyZW4ndCBhY3RpdmUKCQkvLyBhbmQgYXJlbid0IGVtYmVkZGVkCgkJaWYoIGhhc1N1YlBhZ2VzICYmCgkJCXBhcmVudFBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgJiYKCQkJcGFyZW50UGFnZS5kYXRhKCJwYWdlIikub3B0aW9ucy5kb21DYWNoZSA9PT0gZmFsc2UgKSB7CgoJCQl2YXIgbmV3UmVtb3ZlID0gZnVuY3Rpb24oIGUsIHVpICl7CgkJCQl2YXIgbmV4dFBhZ2UgPSB1aS5uZXh0UGFnZSwgbnBVUkw7CgoJCQkJaWYoIHVpLm5leHRQYWdlICl7CgkJCQkJbnBVUkwgPSBuZXh0UGFnZS5qcW1EYXRhKCAidXJsIiApOwoJCQkJCWlmKCBucFVSTC5pbmRleE9mKCBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgIT09IDAgKXsKCQkJCQkJc2VsZi5jaGlsZFBhZ2VzKCkucmVtb3ZlKCk7CgkJCQkJCXBhcmVudFBhZ2UucmVtb3ZlKCk7CgkJCQkJfQoJCQkJfQoJCQl9OwoKCQkJLy8gdW5iaW5kIHRoZSBvcmlnaW5hbCBwYWdlIHJlbW92ZSBhbmQgcmVwbGFjZSB3aXRoIG91ciBzcGVjaWFsaXplZCB2ZXJzaW9uCgkJCXBhcmVudFBhZ2UKCQkJCS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICkKCQkJCS5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiwgbmV3UmVtb3ZlKTsKCQl9Cgl9LAoKCS8vIFRPRE8gc29ydCBvdXQgYSBiZXR0ZXIgd2F5IHRvIHRyYWNrIHN1YiBwYWdlcyBvZiB0aGUgbGlzdHZpZXcgdGhpcyBpcyBicml0dGxlCgljaGlsZFBhZ2VzOiBmdW5jdGlvbigpewoJCXZhciBwYXJlbnRVcmwgPSB0aGlzLnBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKTsKCgkJcmV0dXJuICQoICI6anFtRGF0YSh1cmxePSciKyAgcGFyZW50VXJsICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArIicpIik7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5saXN0dmlldygpOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAibGlzdHZpZXciIGZpbHRlciBleHRlbnNpb24KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyID0gZmFsc2U7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyID0gIkZpbHRlciBpdGVtcy4uLiI7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclRoZW1lID0gImMiOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCB0ZXh0LCBzZWFyY2hWYWx1ZSApewoJcmV0dXJuIHRleHQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCBzZWFyY2hWYWx1ZSApID09PSAtMTsKfTsKCiQoICI6anFtRGF0YShyb2xlPSdsaXN0dmlldycpIiApLmxpdmUoICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCWxpc3R2aWV3ID0gbGlzdC5kYXRhKCAibGlzdHZpZXciICk7CgoJaWYgKCAhbGlzdHZpZXcub3B0aW9ucy5maWx0ZXIgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB3cmFwcGVyID0gJCggIjxmb3JtPiIsIHsKCQkJImNsYXNzIjogInVpLWxpc3R2aWV3LWZpbHRlciB1aS1iYXItIiArIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyVGhlbWUsCgkJCSJyb2xlIjogInNlYXJjaCIKCQl9KSwKCQlzZWFyY2ggPSAkKCAiPGlucHV0PiIsIHsKCQkJcGxhY2Vob2xkZXI6IGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIKCQl9KQoJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZSIsICJzZWFyY2giICkKCQkuanFtRGF0YSggImxhc3R2YWwiLCAiIiApCgkJLmJpbmQoICJrZXl1cCBjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCgkJCXZhciAkdGhpcyA9ICQodGhpcyksCgkJCQl2YWwgPSB0aGlzLnZhbHVlLnRvTG93ZXJDYXNlKCksCgkJCQlsaXN0SXRlbXMgPSBudWxsLAoJCQkJbGFzdHZhbCA9ICR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiApICsgIiIsCgkJCQljaGlsZEl0ZW1zID0gZmFsc2UsCgkJCQlpdGVtdGV4dCA9ICIiLAoJCQkJaXRlbSwgY2hhbmdlOwoKCQkJLy8gQ2hhbmdlIHZhbCBhcyBsYXN0dmFsIGZvciBuZXh0IGV4ZWN1dGlvbgoJCQkkdGhpcy5qcW1EYXRhKCAibGFzdHZhbCIgLCB2YWwgKTsKCQkJY2hhbmdlID0gdmFsLnN1YnN0ciggMCAsIGxhc3R2YWwubGVuZ3RoIC0gMSApLnJlcGxhY2UoIGxhc3R2YWwgLCAiIiApOwoKCQkJaWYgKCB2YWwubGVuZ3RoIDwgbGFzdHZhbC5sZW5ndGggfHwgY2hhbmdlLmxlbmd0aCAhPSAoIHZhbC5sZW5ndGggLSBsYXN0dmFsLmxlbmd0aCApICkgewoKCQkJCS8vIFJlbW92ZWQgY2hhcnMgb3IgcGFzdGVkIHNvbWV0aGluZyB0b3RhbGx5IGRpZmZlcmVudCwgY2hlY2sgYWxsIGl0ZW1zCgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gT25seSBjaGFycyBhZGRlZCwgbm90IHJlbW92ZWQsIG9ubHkgdXNlIHZpc2libGUgc3Vic2V0CgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiOm5vdCgudWktc2NyZWVuLWhpZGRlbikiICk7CgkJCX0KCgkJCWlmICggdmFsICkgewoKCQkJCS8vIFRoaXMgaGFuZGxlcyBoaWRpbmcgcmVndWxhciByb3dzIHdpdGhvdXQgdGhlIHRleHQgd2Ugc2VhcmNoIGZvcgoJCQkJLy8gYW5kIGFueSBsaXN0IGRpdmlkZXJzIHdpdGhvdXQgcmVndWxhciByb3dzIHNob3duIHVuZGVyIGl0CgoJCQkJZm9yICggdmFyIGkgPSBsaXN0SXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQkJaXRlbSA9ICQoIGxpc3RJdGVtc1sgaSBdICk7CgkJCQkJaXRlbXRleHQgPSBpdGVtLmpxbURhdGEoICJmaWx0ZXJ0ZXh0IiApIHx8IGl0ZW0udGV4dCgpOwoKCQkJCQlpZiAoIGl0ZW0uaXMoICJsaTpqcW1EYXRhKHJvbGU9bGlzdC1kaXZpZGVyKSIgKSApIHsKCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsICFjaGlsZEl0ZW1zICk7CgoJCQkJCQkvLyBOZXcgYnVja2V0IQoJCQkJCQljaGlsZEl0ZW1zID0gZmFsc2U7CgoJCQkJCX0gZWxzZSBpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2soIGl0ZW10ZXh0LCB2YWwgKSApIHsKCgkJCQkJCS8vbWFyayB0byBiZSBoaWRkZW4KCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgdHJ1ZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBUaGVyZSdzIGEgc2hvd24gaXRlbSBpbiB0aGUgYnVja2V0CgkJCQkJCWNoaWxkSXRlbXMgPSB0cnVlOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTaG93IGl0ZW1zLCBub3QgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIjpub3QoLnVpLWZpbHRlci1oaWRlcXVldWUpIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgoJCQkJLy8gSGlkZSBpdGVtcywgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIi51aS1maWx0ZXItaGlkZXF1ZXVlIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIHRydWUgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiLCBmYWxzZSApOwoKCQkJfSBlbHNlIHsKCgkJCQkvL2ZpbHRlcnZhbHVlIGlzIGVtcHR5ID0+IHNob3cgYWxsCgkJCQlsaXN0SXRlbXMudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgZmFsc2UgKTsKCQkJfQoJCQlsaXN0dmlldy5fcmVmcmVzaENvcm5lcnMoKTsKCQl9KQoJCS5hcHBlbmRUbyggd3JhcHBlciApCgkJLnRleHRpbnB1dCgpOwoKCWlmICggJCggdGhpcyApLmpxbURhdGEoICJpbnNldCIgKSApIHsKCQl3cmFwcGVyLmFkZENsYXNzKCAidWktbGlzdHZpZXctZmlsdGVyLWluc2V0IiApOwoJfQoKCXdyYXBwZXIuYmluZCggInN1Ym1pdCIsIGZ1bmN0aW9uKCkgewoJCXJldHVybiBmYWxzZTsKCX0pCgkuaW5zZXJ0QmVmb3JlKCBsaXN0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOy8qCiogIm5vanMiIHBsdWdpbiAtIGNsYXNzIHRvIG1ha2UgZWxlbWVudHMgaGlkZGVuIHRvIEEgZ3JhZGUgYnJvd3NlcnMKKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJCggIjpqcW1EYXRhKHJvbGU9J25vanMnKSIsIGUudGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1ub2pzIiApOwoJCn0pOwoKfSkoIGpRdWVyeSApOy8qCiogImNoZWNrYm94cmFkaW8iIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jaGVja2JveHJhZGlvIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCS8vIE5PVEU6IFdpbmRvd3MgUGhvbmUgY291bGQgbm90IGZpbmQgdGhlIGxhYmVsIHRocm91Z2ggYSBzZWxlY3RvcgoJCQkvLyBmaWx0ZXIgd29ya3MgdGhvdWdoLgoJCQlsYWJlbCA9IGlucHV0LmNsb3Nlc3QoICJmb3JtLGZpZWxkc2V0LDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKS5maW5kKCAibGFiZWxbZm9yPSciICsgaW5wdXRbIDAgXS5pZCArICInXSIpLAoJCQlpbnB1dHR5cGUgPSBpbnB1dC5hdHRyKCAidHlwZSIgKSwKCQkJY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vZmYiLAoJCQlpY29uID0gaW5wdXQucGFyZW50cyggIjpqcW1EYXRhKHR5cGU9J2hvcml6b250YWwnKSIgKS5sZW5ndGggPyB1bmRlZmluZWQgOiB1bmNoZWNrZWRTdGF0ZSwKCQkJYWN0aXZlQnRuID0gaWNvbiA/ICIiIDogIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgY2hlY2tlZFN0YXRlICsgYWN0aXZlQnRuLAoJCQl1bmNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgdW5jaGVja2VkU3RhdGUsCgkJCWNoZWNrZWRpY29uID0gInVpLWljb24tIiArIGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkaWNvbiA9ICJ1aS1pY29uLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlsYWJlbDogbGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZGljb24sCgkJCXVuY2hlY2tlZGljb246IHVuY2hlY2tlZGljb24KCQl9KTsKCgkJLy8gSWYgdGhlcmUncyBubyBzZWxlY3RlZCB0aGVtZS4uLgoJCWlmKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSB0aGlzLmVsZW1lbnQuanFtRGF0YSggInRoZW1lIiApOwoJCX0KCgkJbGFiZWwuYnV0dG9uTWFya3VwKHsKCQkJdGhlbWU6IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJaWNvbjogaWNvbiwKCQkJc2hhZG93OiBmYWxzZQoJCX0pOwoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJaW5wdXQuYWRkKCBsYWJlbCApCgkJCS53cmFwQWxsKCAiPGRpdiBjbGFzcz0ndWktIiArIGlucHV0dHlwZSArICInPjwvZGl2PiIgKTsKCgkJbGFiZWwuYmluZCh7CgkJCXZtb3VzZW92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLnBhcmVudCgpLmlzKCAiLnVpLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQl9LAoKCQkJdmNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXNlbGYuX2NhY2hlVmFscygpOwoKCQkJCWlucHV0LnByb3AoICJjaGVja2VkIiwgaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCQkJLy8gdHJpZ2dlciBjbGljayBoYW5kbGVyJ3MgYm91bmQgZGlyZWN0bHkgdG8gdGhlIGlucHV0IGFzIGEgc3Vic3RpdHV0ZSBmb3IKCQkJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCQkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJCQkvLyAgICAgICB0aHJvdWdoIHRvIHRoZSBhc3NvY2lhdGUgaW5wdXQuIHdlIGNhbiBzd2FsbG93IHRoYXQgY2xpY2sgYXQgdGhlIHBhcmVudAoJCQkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJCQlpbnB1dC50cmlnZ2VySGFuZGxlciggJ2NsaWNrJyApOwoKCQkJCS8vIElucHV0IHNldCBmb3IgY29tbW9uIHJhZGlvIGJ1dHRvbnMgd2lsbCBjb250YWluIGFsbCB0aGUgcmFkaW8KCQkJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggaW5wdXQgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgoJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJfSk7CgoJCWlucHV0CgkJCS5iaW5kKHsKCQkJCXZtb3VzZWRvd246IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuX2NhY2hlVmFscygpOwoJCQkJfSwKCgkJCQl2Y2xpY2s6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciAkdGhpcyA9ICQodGhpcyk7CgoJCQkJCS8vIEFkZHMgY2hlY2tlZCBhdHRyaWJ1dGUgdG8gY2hlY2tlZCBpbnB1dCB3aGVuIGtleWJvYXJkIGlzIHVzZWQKCQkJCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgKSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIHRydWUpOwoJCQkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCgkdGhpcykucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCX0sCgoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLmFkZENsYXNzKCAidWktZm9jdXMiICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLnJlbW92ZUNsYXNzKCAidWktZm9jdXMiICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2NhY2hlVmFsczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJJHRoaXMuanFtRGF0YSggImNhY2hlVmFsIiwgJHRoaXMuaXMoICI6Y2hlY2tlZCIgKSApOwoJCX0pOwoJfSwKCgkvL3JldHVybnMgZWl0aGVyIGEgc2V0IG9mIHJhZGlvcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXR0cmlidXRlLCBvciBhIHNpbmdsZSBjaGVja2JveAoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpewoJCWlmKHRoaXMuaW5wdXR0eXBlID09ICJjaGVja2JveCIpIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCQl9CgoJCXJldHVybiB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0sZmllbGRzZXQsOmpxbURhdGEocm9sZT0ncGFnZScpIiApCgkJCS5maW5kKCAiaW5wdXRbbmFtZT0nIisgdGhpcy5lbGVtZW50LmF0dHIoICJuYW1lIiApICsiJ11bdHlwZT0nIisgdGhpcy5pbnB1dHR5cGUgKyInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQodGhpcyk7CgoJCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgfHwgc2VsZi5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbGFiZWwgPSB0aGlzLmxhYmVsLAoJCQlpY29uID0gbGFiZWwuZmluZCggIi51aS1pY29uIiApOwoKCQkvLyBpbnB1dFswXS5jaGVja2VkIGV4cGFuZG8gZG9lc24ndCBhbHdheXMgcmVwb3J0IHRoZSBwcm9wZXIgdmFsdWUKCQkvLyBmb3IgY2hlY2tlZD0nY2hlY2tlZCcKCQlpZiAoICQoIGlucHV0WyAwIF0gKS5wcm9wKCAiY2hlY2tlZCIgKSApIHsKCgkJCWxhYmVsLmFkZENsYXNzKCB0aGlzLmNoZWNrZWRDbGFzcyApLnJlbW92ZUNsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICk7CgkJCWljb24uYWRkQ2xhc3MoIHRoaXMuY2hlY2tlZGljb24gKS5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRpY29uICk7CgoJCX0gZWxzZSB7CgoJCQlsYWJlbC5yZW1vdmVDbGFzcyggdGhpcy5jaGVja2VkQ2xhc3MgKS5hZGRDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCQlpY29uLnJlbW92ZUNsYXNzKCB0aGlzLmNoZWNrZWRpY29uICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkaWNvbiApOwoJCX0KCgkJaWYgKCBpbnB1dC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB0cnVlICkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgZmFsc2UgKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5jaGVja2JveHJhZGlvLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAiYnV0dG9uIiBwbHVnaW4gLSBsaW5rcyB0aGF0IHByb3h5IHRvIG5hdGl2ZSBpbnB1dC9idXR0b25zCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQlpbmxpbmU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlpbml0U2VsZWN0b3I6ICJidXR0b24sIFt0eXBlPSdidXR0b24nXSwgW3R5cGU9J3N1Ym1pdCddLCBbdHlwZT0ncmVzZXQnXSwgW3R5cGU9J2ltYWdlJ10iCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdHlwZSwKCQkJbmFtZSwKCQkJJGJ1dHRvblBsYWNlaG9sZGVyOwoKCQkvLyBBZGQgQVJJQSByb2xlCgkJdGhpcy5idXR0b24gPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJLnRleHQoICRlbC50ZXh0KCkgfHwgJGVsLnZhbCgpICkKCQkJLmluc2VydEJlZm9yZSggJGVsICkKCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQl0aGVtZTogby50aGVtZSwKCQkJCWljb246IG8uaWNvbiwKCQkJCWljb25wb3M6IG8uaWNvbnBvcywKCQkJCWlubGluZTogby5pbmxpbmUsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQlzaGFkb3c6IG8uc2hhZG93LAoJCQkJaWNvbnNoYWRvdzogby5pY29uc2hhZG93CgkJCX0pCgkJCS5hcHBlbmQoICRlbC5hZGRDbGFzcyggInVpLWJ0bi1oaWRkZW4iICkgKTsKCgkJdHlwZSA9ICRlbC5hdHRyKCAidHlwZSIgKTsKCQluYW1lID0gJGVsLmF0dHIoICJuYW1lIiApOwoKCQkvLyBBZGQgaGlkZGVuIGlucHV0IGR1cmluZyBzdWJtaXQgaWYgaW5wdXQgdHlwZT0ic3VibWl0IiBoYXMgYSBuYW1lLgoJCWlmICggdHlwZSAhPT0gImJ1dHRvbiIgJiYgdHlwZSAhPT0gInJlc2V0IiAmJiBuYW1lICkgewoJCQkJJGVsLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbigpIHsKCQkJCQkvLyBBZGQgaGlkZGVuIGlucHV0IGlmIGl0IGRvZXNu4oCZdCBhbHJlYWR5IGV4aXN0LgoJCQkJCWlmKCAkYnV0dG9uUGxhY2Vob2xkZXIgPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyID0gJCggIjxpbnB1dD4iLCB7CgkJCQkJCQl0eXBlOiAiaGlkZGVuIiwKCQkJCQkJCW5hbWU6ICRlbC5hdHRyKCAibmFtZSIgKSwKCQkJCQkJCXZhbHVlOiAkZWwuYXR0ciggInZhbHVlIiApCgkJCQkJCX0pLmluc2VydEJlZm9yZSggJGVsICk7CgoJCQkJCQkvLyBCaW5kIHRvIGRvYyB0byByZW1vdmUgYWZ0ZXIgc3VibWl0IGhhbmRsaW5nCgkJCQkJCSQoIGRvY3VtZW50ICkub25lKCJzdWJtaXQiLCBmdW5jdGlvbigpewoJCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyLnJlbW92ZSgpOwoKCQkJCQkJCS8vIHJlc2V0IHRoZSBsb2NhbCB2YXIgc28gdGhhdCB0aGUgaGlkZGVuIGlucHV0CgkJCQkJCQkvLyB3aWxsIGJlIHJlLWFkZGVkIG9uIHN1YnNlcXVlbnQgY2xpY2tzCgkJCQkJCQkkYnV0dG9uUGxhY2Vob2xkZXIgPSB1bmRlZmluZWQ7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pOwoJCX0KCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCAkZWwucHJvcCgiZGlzYWJsZWQiKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9CgoJCS8vIHRoZSB0ZXh0V3JhcHBlciBpcyBzdG9yZWQgYXMgYSBkYXRhIGVsZW1lbnQgb24gdGhlIGJ1dHRvbiBvYmplY3QKCQkvLyB0byBwcmV2ZW50IHJlZmVyZW5jaW5nIGJ5IGl0J3MgaW1wbGVtZW50YXRpb24gZGV0YWlscyAoZWcgJ2NsYXNzJykKCQl0aGlzLmJ1dHRvbi5kYXRhKCAndGV4dFdyYXBwZXInICkudGV4dCggJGVsLnRleHQoKSB8fCAkZWwudmFsKCkgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuYnV0dG9uLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJzbGlkZXIiIHBsdWdpbgoqLwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJdHJhY2tUaGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBUT0RPOiBFYWNoIG9mIHRoZXNlIHNob3VsZCBoYXZlIGNvbW1lbnRzIGV4cGxhaW4gd2hhdCB0aGV5J3JlIGZvcgoJCXZhciBzZWxmID0gdGhpcywKCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBjb250cm9sLCAiYyIgKSwKCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoKCQkJY1R5cGUgPSBjb250cm9sWyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCgkJCXNlbGVjdENsYXNzID0gKCBjVHlwZSA9PSAic2VsZWN0IiApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCgkJCWxhYmVsSUQgPSBjb250cm9sSUQgKyAiLWxhYmVsIiwKCgkJCWxhYmVsID0gJCggIltmb3I9JyIrIGNvbnRyb2xJRCArIiddIiApLmF0dHIoICJpZCIsIGxhYmVsSUQgKSwKCgkJCXZhbCA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICBjVHlwZSA9PSAiaW5wdXQiICA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfSwKCgkJCW1pbiA9ICBjVHlwZSA9PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoKCQkJbWF4ID0gIGNUeXBlID09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgoJCQlzbGlkZXIgPSAkKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyICIgKyBzZWxlY3RDbGFzcyArICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgKwoJCQkJCQkJCQkiIHVpLWJ0bi1jb3JuZXItYWxsJyByb2xlPSdhcHBsaWNhdGlvbic+PC9kaXY+IiApLAoKCQkJaGFuZGxlID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1zbGlkZXItaGFuZGxlJz48L2E+IiApCgkJCQkuYXBwZW5kVG8oIHNsaWRlciApCgkJCQkuYnV0dG9uTWFya3VwKHsgY29ybmVyczogdHJ1ZSwgdGhlbWU6IHRoZW1lLCBzaGFkb3c6IHRydWUgfSkKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJzbGlkZXIiLAoJCQkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkJCSJhcmlhLXZhbHVlbm93IjogdmFsKCksCgkJCQkJImFyaWEtdmFsdWV0ZXh0IjogdmFsKCksCgkJCQkJInRpdGxlIjogdmFsKCksCgkJCQkJImFyaWEtbGFiZWxsZWRieSI6IGxhYmVsSUQKCQkJCX0pLAoJCQlvcHRpb25zOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggY1R5cGUgPT0gInNlbGVjdCIgKSB7CgoJCQlzbGlkZXIud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyLWlubmVyb2Zmc2V0Jz48L2Rpdj4iICk7CgkJCQoJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCW9wdGlvbnMgPSBjb250cm9sLmZpbmQoICJvcHRpb24iICk7CgoJCQljb250cm9sLmZpbmQoICJvcHRpb24iICkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQl2YXIgc2lkZSA9ICFpID8gImIiOiJhIiwKCQkJCQljb3JuZXJzID0gIWkgPyAicmlnaHQiIDoibGVmdCIsCgkJCQkJdGhlbWUgPSAhaSA/ICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgOiggIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkkKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyLWxhYmVsYmcgdWktc2xpZGVyLWxhYmVsYmctIiArIHNpZGUgKyB0aGVtZSArICIgdWktYnRuLWNvcm5lci0iICsgY29ybmVycyArICInPjwvZGl2PiIgKQoJCQkJCS5wcmVwZW5kVG8oIHNsaWRlciApOwoKCQkJCSQoICI8c3BhbiBjbGFzcz0ndWktc2xpZGVyLWxhYmVsIHVpLXNsaWRlci1sYWJlbC0iICsgc2lkZSArIHRoZW1lICsgIiB1aS1idG4tY29ybmVyLSIgKyBjb3JuZXJzICsgIicgcm9sZT0naW1nJz4iICsgJCggdGhpcyApLmdldEVuY29kZWRUZXh0KCkgKyAiPC9zcGFuPiIgKQoJCQkJCS5wcmVwZW5kVG8oIGhhbmRsZSApOwoJCQl9KTsKCgkJfQoKCQlsYWJlbC5hZGRDbGFzcyggInVpLXNsaWRlciIgKTsKCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggY1R5cGUgPT09ICJpbnB1dCIgPyAidWktc2xpZGVyLWlucHV0IiA6ICJ1aS1zbGlkZXItc3dpdGNoIiApCgkJCS5jaGFuZ2UoIGZ1bmN0aW9uKCkgewoJCQkJLy8gaWYgdGhlIHVzZXIgZHJhZ2dlZCB0aGUgaGFuZGxlLCB0aGUgImNoYW5nZSIgZXZlbnQgd2FzIHRyaWdnZXJlZCBmcm9tIGluc2lkZSByZWZyZXNoKCk7IGRvbid0IGNhbGwgcmVmcmVzaCgpIGFnYWluCgkJCQlpZiAoIXNlbGYubW91c2VNb3ZlZCkgewoJCQkJCXNlbGYucmVmcmVzaCggdmFsKCksIHRydWUgKTsKCQkJCX0KCQkJfSkKCQkJLmtleXVwKCBmdW5jdGlvbigpIHsgLy8gbmVjZXNzYXJ5PwoJCQkJc2VsZi5yZWZyZXNoKCB2YWwoKSwgdHJ1ZSwgdHJ1ZSApOwoJCQl9KQoJCQkuYmx1ciggZnVuY3Rpb24oKSB7CgkJCQlzZWxmLnJlZnJlc2goIHZhbCgpLCB0cnVlICk7CgkJCX0pOwoKCQkvLyBwcmV2ZW50IHNjcmVlbiBkcmFnIHdoZW4gc2xpZGVyIGFjdGl2YXRlZAoJCSQoIGRvY3VtZW50ICkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggc2VsZi5kcmFnZ2luZyApIHsKCQkJCS8vIHNlbGYubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJc2VsZi5tb3VzZU1vdmVkID0gdHJ1ZTsKCQkJCQoJCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIgKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgaW4gc3luYyB3aXRoIHRoZSBtb3VzZQoJCQkJCWhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQl9CgkJCQkKCQkJCXNlbGYucmVmcmVzaCggZXZlbnQgKTsKCQkJCQoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgc2VsZi51c2VyTW9kaWZpZWQKCQkJCXNlbGYudXNlck1vZGlmaWVkID0gc2VsZi5iZWZvcmVTdGFydCAhPT0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJc2VsZi5kcmFnZ2luZyA9IHRydWU7CgkJCXNlbGYudXNlck1vZGlmaWVkID0gZmFsc2U7CgkJCXNlbGYubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIgKSB7CgkJCQlzZWxmLmJlZm9yZVN0YXJ0ID0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCQoJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9KTsKCgkJc2xpZGVyLmFkZCggZG9jdW1lbnQgKQoJCQkuYmluZCggInZtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuZHJhZ2dpbmcgKSB7CgoJCQkJCXNlbGYuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIpIHsKCQkJCQkKCQkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCQkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQkJCgkJCQkJCWlmICggc2VsZi5tb3VzZU1vdmVkICkgewoJCQkJCQkKCQkJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCQkJaWYgKCBzZWxmLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgPT0gMCA/IDEgOiAwICk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIHsKCQkJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgKTsKCQkJCQkJCX0KCQkJCQkJCQoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJLy8gdGhpcyBpcyBqdXN0IGEgY2xpY2ssIGNoYW5nZSB0aGUgdmFsdWUKCQkJCQkJCXNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCA9PSAwID8gMSA6IDAgKTsKCQkJCQkJfQoJCQkJCQkKCQkJCQl9CgkJCQkJCgkJCQkJc2VsZi5tb3VzZU1vdmVkID0gZmFsc2U7CgkJCQkJCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCgkJdGhpcy5oYW5kbGUKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuZm9jdXMoKTsKCQkJfSkKCQkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLmhhbmRsZQoJCQkuYmluZCggImtleWRvd24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl2YXIgaW5kZXggPSB2YWwoKTsKCgkJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gSW4gYWxsIGNhc2VzIHByZXZlbnQgdGhlIGRlZmF1bHQgYW5kIG1hcmsgdGhlIGhhbmRsZSBhcyBhY3RpdmUKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJIGNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkJaWYgKCAhc2VsZi5fa2V5U2xpZGluZyApIHsKCQkJCQkJc2VsZi5fa2V5U2xpZGluZyA9IHRydWU7CgkJCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCQl9CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJLy8gbW92ZSB0aGUgc2xpZGVyIGFjY29yZGluZyB0byB0aGUga2V5cHJlc3MKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQkJc2VsZi5yZWZyZXNoKCBtaW4gKTsKCQkJCQlicmVhazsKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJCXNlbGYucmVmcmVzaCggbWF4ICk7CgkJCQkJYnJlYWs7CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQkJIGNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCQlzZWxmLnJlZnJlc2goIGluZGV4ICsgc3RlcCApOwoJCQkJCWJyZWFrOwoJCQkJIGNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQkJc2VsZi5yZWZyZXNoKCBpbmRleCAtIHN0ZXAgKTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfSkgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgkJCS5rZXl1cCggZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBzZWxmLl9rZXlTbGlkaW5nICkgewoJCQkJCXNlbGYuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLnJlZnJlc2godW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggdmFsLCBpc2Zyb21Db250cm9sLCBwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCdkaXNhYmxlZCcpKSB7IAoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCXZhciBjb250cm9sID0gdGhpcy5lbGVtZW50LCBwZXJjZW50LAoJCQljVHlwZSA9IGNvbnRyb2xbMF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJbWluID0gY1R5cGUgPT09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkubGVuZ3RoIC0gMTsKCgkJaWYgKCB0eXBlb2YgdmFsID09PSAib2JqZWN0IiApIHsKCQkJdmFyIGRhdGEgPSB2YWwsCgkJCQkvLyBhIHNsaWdodCB0b2xlcmFuY2UgaGVscGVkIGdldCB0byB0aGUgZW5kcyBvZiB0aGUgc2xpZGVyCgkJCQl0b2wgPSA4OwoJCQlpZiAoICF0aGlzLmRyYWdnaW5nIHx8CgkJCQkJZGF0YS5wYWdlWCA8IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgLSB0b2wgfHwKCQkJCQlkYXRhLnBhZ2VYID4gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdCArIHRoaXMuc2xpZGVyLndpZHRoKCkgKyB0b2wgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJcGVyY2VudCA9IE1hdGgucm91bmQoICggKCBkYXRhLnBhZ2VYIC0gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdCApIC8gdGhpcy5zbGlkZXIud2lkdGgoKSApICogMTAwICk7CgkJfSBlbHNlIHsKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCXZhciBuZXd2YWwgPSBNYXRoLnJvdW5kKCAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKSArIG1pbjsKCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQkvLyBGbGlwIHRoZSBzdGFjayBvZiB0aGUgYmcgY29sb3JzCgkJaWYgKCBwZXJjZW50ID4gNjAgJiYgY1R5cGUgPT09ICJzZWxlY3QiICkgewoJCQkvLyBUT0RPOiBEZWFkIHBhdGg/CgkJfQoJCXRoaXMuaGFuZGxlLmNzcyggImxlZnQiLCBwZXJjZW50ICsgIiUiICk7CgkJdGhpcy5oYW5kbGUuYXR0ciggewoJCQkJImFyaWEtdmFsdWVub3ciOiBjVHlwZSA9PT0gImlucHV0IiA/IG5ld3ZhbCA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5lcSggbmV3dmFsICkuYXR0ciggInZhbHVlIiApLAoJCQkJImFyaWEtdmFsdWV0ZXh0IjogY1R5cGUgPT09ICJpbnB1dCIgPyBuZXd2YWwgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCksCgkJCQl0aXRsZTogbmV3dmFsCgkJCX0pOwoKCQkvLyBhZGQvcmVtb3ZlIGNsYXNzZXMgZm9yIGZsaXAgdG9nZ2xlIHN3aXRjaAoJCWlmICggY1R5cGUgPT09ICJzZWxlY3QiICkgewoJCQlpZiAoIG5ld3ZhbCA9PT0gMCApIHsKCQkJCXRoaXMuc2xpZGVyLmFkZENsYXNzKCAidWktc2xpZGVyLXN3aXRjaC1hIiApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLXN3aXRjaC1iIiApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5zbGlkZXIuYWRkQ2xhc3MoICJ1aS1zbGlkZXItc3dpdGNoLWIiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zbGlkZXItc3dpdGNoLWEiICk7CgkJCX0KCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFyIHZhbHVlQ2hhbmdlZCA9IGZhbHNlOwoKCQkJLy8gdXBkYXRlIGNvbnRyb2wicyB2YWx1ZQoJCQlpZiAoIGNUeXBlID09PSAiaW5wdXQiICkgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbC52YWwoKSAhPT0gbmV3dmFsOwoJCQkJY29udHJvbC52YWwoIG5ld3ZhbCApOwoJCQl9IGVsc2UgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ID0gbmV3dmFsOwoJCQl9CgkJCWlmICggIWlzZnJvbUNvbnRyb2wgJiYgdmFsdWVDaGFuZ2VkICkgewoJCQkJY29udHJvbC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCXRoaXMuc2xpZGVyLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBmYWxzZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJdGhpcy5zbGlkZXIuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9Cgp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5zbGlkZXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwovKgoqICJ0ZXh0aW5wdXQiIHBsdWdpbiBmb3IgdGV4dCBpbnB1dHMsIHRleHRhcmVhcwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSd0ZXh0J10sIGlucHV0W3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSwgaW5wdXRbdHlwZT0nbnVtYmVyJ10sIDpqcW1EYXRhKHR5cGU9J251bWJlcicpLCBpbnB1dFt0eXBlPSdwYXNzd29yZCddLCBpbnB1dFt0eXBlPSdlbWFpbCddLCBpbnB1dFt0eXBlPSd1cmwnXSwgaW5wdXRbdHlwZT0ndGVsJ10sIHRleHRhcmVhLCBpbnB1dFt0eXBlPSd0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGUnXSwgaW5wdXRbdHlwZT0nbW9udGgnXSwgaW5wdXRbdHlwZT0nd2VlayddLCBpbnB1dFt0eXBlPSdkYXRldGltZSddLCBpbnB1dFt0eXBlPSdkYXRldGltZS1sb2NhbCddLCBpbnB1dFt0eXBlPSdjb2xvciddLCBpbnB1dDpub3QoW3R5cGVdKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdGhlbWUgPSBvLnRoZW1lIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApLAoJCQl0aGVtZWNsYXNzICA9ICIgdWktYm9keS0iICsgdGhlbWUsCgkJCWZvY3VzZWRFbCwgY2xlYXJidG47CgoJCSQoICJsYWJlbFtmb3I9JyIgKyBpbnB1dC5hdHRyKCAiaWQiICkgKyAiJ10iICkuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IiApOwoKCQlmb2N1c2VkRWwgPSBpbnB1dC5hZGRDbGFzcygidWktaW5wdXQtdGV4dCB1aS1ib2R5LSIrIHRoZW1lICk7CgoJCS8vIFhYWDogVGVtcG9yYXJ5IHdvcmthcm91bmQgZm9yIGlzc3VlIDc4NSAoQXBwbGUgYnVnIDg5MTA1ODkpLgoJCS8vICAgICAgVHVybiBvZmYgYXV0b2NvcnJlY3QgYW5kIGF1dG9jb21wbGV0ZSBvbiBub24taU9TIDUgZGV2aWNlcwoJCS8vICAgICAgc2luY2UgdGhlIHBvcHVwIHRoZXkgdXNlIGNhbid0IGJlIGRpc21pc3NlZCBieSB0aGUgdXNlci4gTm90ZQoJCS8vICAgICAgdGhhdCB3ZSB0ZXN0IGZvciB0aGUgcHJlc2VuY2Ugb2YgdGhlIGZlYXR1cmUgYnkgbG9va2luZyBmb3IKCQkvLyAgICAgIHRoZSBhdXRvY29ycmVjdCBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC4gV2UgY3VycmVudGx5CgkJLy8gICAgICBoYXZlIG5vIHRlc3QgZm9yIGlPUyA1IG9yIG5ld2VyIHNvIHdlJ3JlIHRlbXBvcmFyaWx5IHVzaW5nCgkJLy8gICAgICB0aGUgdG91Y2hPdmVyZmxvdyBzdXBwb3J0IGZsYWcgZm9yIGpRTSAxLjAuIFllcywgSSBmZWVsIGRpcnR5LiAtIGpibGFzCgkJaWYgKCB0eXBlb2YgaW5wdXRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmICEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb3JyZWN0IiwgIm9mZiIgKTsKCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCQl9CgoKCQkvLyJzZWFyY2giIGlucHV0IHdpZGdldAoJCWlmICggaW5wdXQuaXMoICJbdHlwZT0nc2VhcmNoJ10sOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgKSB7CgoJCQlmb2N1c2VkRWwgPSBpbnB1dC53cmFwKCAiPGRpdiBjbGFzcz0ndWktaW5wdXQtc2VhcmNoIHVpLXNoYWRvdy1pbnNldCB1aS1idG4tY29ybmVyLWFsbCB1aS1idG4tc2hhZG93IHVpLWljb24tc2VhcmNoZmllbGQiICsgdGhlbWVjbGFzcyArICInPjwvZGl2PiIgKS5wYXJlbnQoKTsKCQkJY2xlYXJidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyJyB0aXRsZT0nY2xlYXIgdGV4dCc+Y2xlYXIgdGV4dDwvYT4iICkKCQkJCS50YXAoZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlucHV0LnZhbCggIiIgKS5mb2N1cygpOwoJCQkJCWlucHV0LnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJY2xlYXJidG4uYWRkQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0pCgkJCQkuYXBwZW5kVG8oIGZvY3VzZWRFbCApCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlpY29uOiAiZGVsZXRlIiwKCQkJCQlpY29ucG9zOiAibm90ZXh0IiwKCQkJCQljb3JuZXJzOiB0cnVlLAoJCQkJCXNoYWRvdzogdHJ1ZQoJCQkJfSk7CgoJCQlmdW5jdGlvbiB0b2dnbGVDbGVhcigpIHsKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJY2xlYXJidG4udG9nZ2xlQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iLCAhaW5wdXQudmFsKCkgKTsKCQkJCX0sIDApOwoJCQl9CgoJCQl0b2dnbGVDbGVhcigpOwoKCQkJaW5wdXQuYmluZCgncGFzdGUgY3V0IGtleXVwIGZvY3VzIGNoYW5nZSBibHVyJywgdG9nZ2xlQ2xlYXIpOwoKCQl9IGVsc2UgewoJCQlpbnB1dC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktc2hhZG93LWluc2V0IiArIHRoZW1lY2xhc3MgKTsKCQl9CgoJCWlucHV0LmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJZm9jdXNlZEVsLmFkZENsYXNzKCAidWktZm9jdXMiICk7CgkJCX0pCgkJCS5ibHVyKGZ1bmN0aW9uKCl7CgkJCQlmb2N1c2VkRWwucmVtb3ZlQ2xhc3MoICJ1aS1mb2N1cyIgKTsKCQkJfSk7CgoJCS8vIEF1dG9ncm93CgkJaWYgKCBpbnB1dC5pcyggInRleHRhcmVhIiApICkgewoJCQl2YXIgZXh0cmFMaW5lSGVpZ2h0ID0gMTUsCgkJCQlrZXl1cFRpbWVvdXRCdWZmZXIgPSAxMDAsCgkJCQlrZXl1cCA9IGZ1bmN0aW9uKCkgewoJCQkJCXZhciBzY3JvbGxIZWlnaHQgPSBpbnB1dFsgMCBdLnNjcm9sbEhlaWdodCwKCQkJCQkJY2xpZW50SGVpZ2h0ID0gaW5wdXRbIDAgXS5jbGllbnRIZWlnaHQ7CgoJCQkJCWlmICggY2xpZW50SGVpZ2h0IDwgc2Nyb2xsSGVpZ2h0ICkgewoJCQkJCQlpbnB1dC5oZWlnaHQoc2Nyb2xsSGVpZ2h0ICsgZXh0cmFMaW5lSGVpZ2h0KTsKCQkJCQl9CgkJCQl9LAoJCQkJa2V5dXBUaW1lb3V0OwoKCQkJaW5wdXQua2V5dXAoZnVuY3Rpb24oKSB7CgkJCQljbGVhclRpbWVvdXQoIGtleXVwVGltZW91dCApOwoJCQkJa2V5dXBUaW1lb3V0ID0gc2V0VGltZW91dCgga2V5dXAsIGtleXVwVGltZW91dEJ1ZmZlciApOwoJCQl9KTsKCgkJCS8vIElzc3VlIDUwOTogdGhlIGJyb3dzZXIgaXMgbm90IHByb3ZpZGluZyBzY3JvbGxIZWlnaHQgcHJvcGVybHkgdW50aWwgdGhlIHN0eWxlcyBsb2FkCgkJCWlmICggJC50cmltKCBpbnB1dC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCSQoIHdpbmRvdyApLmxvYWQoIGtleXVwICk7CgoJCQkJLy8gYmluZGluZyB0byBwYWdlY2hhbmdlIGhlcmUgZW5zdXJlcyB0aGF0IGZvciBwYWdlcyBsb2FkZWQgdmlhCgkJCQkvLyBhamF4IHRoZSBoZWlnaHQgaXMgcmVjYWxjdWxhdGVkIHdpdGhvdXQgdXNlciBpbnB1dAoJCQkJJCggZG9jdW1lbnQgKS5vbmUoICJwYWdlY2hhbmdlIiwga2V5dXAgKTsKCQkJfQoJCX0KCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKXsKCQkoIHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICkuaXMoICJbdHlwZT0nc2VhcmNoJ10sOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgPwoJCQl0aGlzLmVsZW1lbnQucGFyZW50KCkgOiB0aGlzLmVsZW1lbnQgKS5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCl7CgkJKCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UpLmlzKCAiW3R5cGU9J3NlYXJjaCddLDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApID8KCQkJdGhpcy5lbGVtZW50LnBhcmVudCgpIDogdGhpcy5lbGVtZW50ICkucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUudGV4dGlucHV0LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgZXh0ZW5kU2VsZWN0ID0gZnVuY3Rpb24oIHdpZGdldCApewoKCQl2YXIgc2VsZWN0ID0gd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQgID0gd2lkZ2V0LnNlbGVjdElELAoJCQlsYWJlbCA9IHdpZGdldC5sYWJlbCwKCQkJdGhpc1BhZ2UgPSB3aWRnZXQuc2VsZWN0LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJc2NyZWVuID0gJCggIjxkaXY+IiwgeyJjbGFzcyI6ICJ1aS1zZWxlY3RtZW51LXNjcmVlbiB1aS1zY3JlZW4taGlkZGVuIn0gKS5hcHBlbmRUbyggdGhpc1BhZ2UgKSwKCQkJc2VsZWN0T3B0aW9ucyA9IHdpZGdldC5fc2VsZWN0T3B0aW9ucygpLAoJCQlpc011bHRpcGxlID0gd2lkZ2V0LmlzTXVsdGlwbGUgPSB3aWRnZXQuc2VsZWN0WyAwIF0ubXVsdGlwbGUsCgkJCWJ1dHRvbklkID0gc2VsZWN0SUQgKyAiLWJ1dHRvbiIsCgkJCW1lbnVJZCA9IHNlbGVjdElEICsgIi1tZW51IiwKCQkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGRhdGEtIiArJC5tb2JpbGUubnMgKyAidGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLnRoZW1lICsiJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgIm92ZXJsYXktdGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArIic+IiArCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgbGFiZWwuZ2V0RW5jb2RlZFRleHQoKSArICI8L2Rpdj4iKwoJCQkJIjwvZGl2PiIrCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkJIjwvZGl2PiIgKS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApLnBhZ2UoKSwKCgkJCWxpc3Rib3ggPSAgJCgiPGRpdj4iLCB7ICJjbGFzcyI6ICJ1aS1zZWxlY3RtZW51IHVpLXNlbGVjdG1lbnUtaGlkZGVuIHVpLW92ZXJsYXktc2hhZG93IHVpLWNvcm5lci1hbGwgdWktYm9keS0iICsgd2lkZ2V0Lm9wdGlvbnMub3ZlcmxheVRoZW1lICsgIiAiICsgJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gfSApLmluc2VydEFmdGVyKHNjcmVlbiksCgoJCQlsaXN0ID0gJCggIjx1bD4iLCB7CgkJCQkiY2xhc3MiOiAidWktc2VsZWN0bWVudS1saXN0IiwKCQkJCSJpZCI6IG1lbnVJZCwKCQkJCSJyb2xlIjogImxpc3Rib3giLAoJCQkJImFyaWEtbGFiZWxsZWRieSI6IGJ1dHRvbklkCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIsIHdpZGdldC5vcHRpb25zLnRoZW1lICkuYXBwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlciA9ICQoICI8ZGl2PiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS1oZWFkZXIgdWktYmFyLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZQoJCQl9KS5wcmVwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlclRpdGxlID0gJCggIjxoMT4iLCB7CgkJCQkiY2xhc3MiOiAidWktdGl0bGUiCgkJCX0pLmFwcGVuZFRvKCBoZWFkZXIgKSwKCgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJ0ZXh0Ijogd2lkZ2V0Lm9wdGlvbnMuY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuLWxlZnQiCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiwgIm5vdGV4dCIgKS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbiIsICJkZWxldGUiICkuYXBwZW5kVG8oIGhlYWRlciApLmJ1dHRvbk1hcmt1cCgpLAoKCQkJbWVudVBhZ2VDb250ZW50ID0gbWVudVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApLAoKCQkJbWVudVBhZ2VDbG9zZSA9IG1lbnVQYWdlLmZpbmQoICIudWktaGVhZGVyIGEiICk7CgoKCQkkLmV4dGVuZCggd2lkZ2V0LCB7CgkJCXNlbGVjdDogd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQ6IHNlbGVjdElELAoJCQlidXR0b25JZDogYnV0dG9uSWQsCgkJCW1lbnVJZDogbWVudUlkLAoJCQl0aGlzUGFnZTogdGhpc1BhZ2UsCgkJCW1lbnVQYWdlOiBtZW51UGFnZSwKCQkJbGFiZWw6IGxhYmVsLAoJCQlzY3JlZW46IHNjcmVlbiwKCQkJc2VsZWN0T3B0aW9uczogc2VsZWN0T3B0aW9ucywKCQkJaXNNdWx0aXBsZTogaXNNdWx0aXBsZSwKCQkJdGhlbWU6IHdpZGdldC5vcHRpb25zLnRoZW1lLAoJCQlsaXN0Ym94OiBsaXN0Ym94LAoJCQlsaXN0OiBsaXN0LAoJCQloZWFkZXI6IGhlYWRlciwKCQkJaGVhZGVyVGl0bGU6IGhlYWRlclRpdGxlLAoJCQloZWFkZXJDbG9zZTogaGVhZGVyQ2xvc2UsCgkJCW1lbnVQYWdlQ29udGVudDogbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlOiBtZW51UGFnZUNsb3NlLAoJCQlwbGFjZWhvbGRlcjogIiIsCgoJCQlidWlsZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJLy8gQ3JlYXRlIGxpc3QgZnJvbSBzZWxlY3QsIHVwZGF0ZSBzdGF0ZQoJCQkJc2VsZi5yZWZyZXNoKCk7CgoJCQkJc2VsZi5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgIi0xIiApLmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQkJCX0pOwoKCQkJCS8vIEJ1dHRvbiBldmVudHMKCQkJCXNlbGYuYnV0dG9uLmJpbmQoICJ2Y2xpY2sga2V5ZG93biIgLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBldmVudC50eXBlID09ICJ2Y2xpY2siIHx8CgkJCQkJCQkgZXZlbnQua2V5Q29kZSAmJiAoIGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRU5URVIgfHwKCQkJCQkJCQkJCQkJCQkJCQlldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFICkgKSB7CgoJCQkJCQlzZWxmLm9wZW4oKTsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQkJCXNlbGYubGlzdC5hdHRyKCAicm9sZSIsICJsaXN0Ym94IiApCgkJCQkJLmRlbGVnYXRlKCAiLnVpLWxpPmEiLCAiZm9jdXNpbiIsIGZ1bmN0aW9uKCkgewoJCQkJCQkkKCB0aGlzICkuYXR0ciggInRhYmluZGV4IiwgIjAiICk7CgkJCQkJfSkKCQkJCQkuZGVsZWdhdGUoICIudWktbGk+YSIsICJmb2N1c291dCIsIGZ1bmN0aW9uKCkgewoJCQkJCQkkKCB0aGlzICkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoJCQkJCX0pCgkJCQkJLmRlbGVnYXRlKCAibGk6bm90KC51aS1kaXNhYmxlZCwgLnVpLWxpLWRpdmlkZXIpIiwgImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJCQl2YXIgb2xkSW5kZXggPSBzZWxmLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgkJCQkJCQluZXdJbmRleCA9IHNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5pbmRleCggdGhpcyApLAoJCQkJCQkJb3B0aW9uID0gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmVxKCBuZXdJbmRleCApWyAwIF07CgoJCQkJCQkvLyB0b2dnbGUgc2VsZWN0ZWQgc3RhdHVzIG9uIHRoZSB0YWcgZm9yIG11bHRpIHNlbGVjdHMKCQkJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJCQkvLyB0b2dnbGUgY2hlY2tib3ggY2xhc3MgZm9yIG11bHRpcGxlIHNlbGVjdHMKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkkKCB0aGlzICkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiLCAhb3B0aW9uLnNlbGVjdGVkICk7CgkJCQkJCX0KCgkJCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgfHwgb2xkSW5kZXggIT09IG5ld0luZGV4ICkgewoJCQkJCQkJc2VsZi5zZWxlY3QudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCQkJfQoKCQkJCQkJLy9oaWRlIGN1c3RvbSBzZWxlY3QgZm9yIHNpbmdsZSBzZWxlY3RzIG9ubHkKCQkJCQkJaWYgKCAhc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQl9CgoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0pCgkJCQkJLmtleWRvd24oZnVuY3Rpb24oIGV2ZW50ICkgeyAgLy9rZXlib2FyZCBldmVudHMgZm9yIG1lbnUgaXRlbXMKCQkJCQkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQkJCQkJbGkgPSB0YXJnZXQuY2xvc2VzdCggImxpIiApLAoJCQkJCQkJcHJldiwgbmV4dDsKCgkJCQkJCS8vIHN3aXRjaCBsb2dpYyBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQkJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCQkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCQkJCQkgY2FzZSAzODoKCQkJCQkJCXByZXYgPSBsaS5wcmV2KCk7CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIHByZXZpb3VzIG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggcHJldi5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJcHJldi5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQkJLy8gZG93biBvciByaWdodCBhcnJvdyBrZXlzCgkJCQkJCSBjYXNlIDQwOgoJCQkJCQkJbmV4dCA9IGxpLm5leHQoKTsKCgkJCQkJCQkvLyBpZiB0aGVyZSdzIGEgbmV4dCBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIG5leHQubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCW5leHQuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCWJyZWFrOwoKCQkJCQkJCS8vIElmIGVudGVyIG9yIHNwYWNlIGlzIHByZXNzZWQsIHRyaWdnZXIgY2xpY2sKCQkJCQkJIGNhc2UgMTM6CgkJCQkJCSBjYXNlIDMyOgoJCQkJCQkJdGFyZ2V0LnRyaWdnZXIoICJjbGljayIgKTsKCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoJCQkJCX0pOwoKCQkJCS8vIGJ1dHRvbiByZWZvY3VzIGVuc3VyZXMgcHJvcGVyIGhlaWdodCBjYWxjdWxhdGlvbgoJCQkJLy8gYnkgcmVtb3ZpbmcgdGhlIGlubGluZSBzdHlsZSBhbmQgZW5zdXJpbmcgcGFnZSBpbmNsdXNpb24KCQkJCXNlbGYubWVudVBhZ2UuYmluZCggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5saXN0LmFwcGVuZFRvKCBzZWxmLmxpc3Rib3ggKTsKCQkJCQlzZWxmLl9mb2N1c0J1dHRvbigpOwoKCQkJCQkvLyBUT0RPIGNlbnRyYWxpemUgcGFnZSByZW1vdmFsIGJpbmRpbmcgLyBoYW5kbGluZyBpbiB0aGUgcGFnZSBwbHVnaW4uCgkJCQkJLy8gU3VnZ2VzdGlvbiBmcm9tIEBqYmxhcyB0byBkbyByZWZjb3VudGluZwoJCQkJCS8vCgkJCQkJLy8gVE9ETyBleHRyZW1lbHkgY29uZnVzaW5nIGRlcGVuZGVuY3kgb24gdGhlIG9wZW4gbWV0aG9kIHdoZXJlIHRoZSBwYWdlaGlkZS5yZW1vdmUKCQkJCQkvLyBiaW5kaW5ncyBhcmUgc3RyaXBwZWQgdG8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBkaXNhcHBlYXJpbmcuIFRoZSB3YXkKCQkJCQkvLyB3ZSdyZSBrZWVwaW5nIHBhZ2VzIGluIHRoZSBET00gcmlnaHQgbm93IHN1Y2tzCgkJCQkJLy8KCQkJCQkvLyByZWJpbmQgdGhlIHBhZ2UgcmVtb3ZlIHRoYXQgd2FzIHVuYm91bmQgaW4gdGhlIG9wZW4gZnVuY3Rpb24KCQkJCQkvLyB0byBhbGxvdyBmb3IgdGhlIHBhcmVudCBwYWdlIHJlbW92YWwgZnJvbSBhY3Rpb25zIG90aGVyIHRoYW4gdGhlIHVzZQoJCQkJCS8vIG9mIGEgZGlhbG9nIHNpemVkIGN1c3RvbSBzZWxlY3QKCQkJCQkvLwoJCQkJCS8vIGRvaW5nIHRoaXMgaGVyZSBwcm92aWRlcyBmb3IgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBjdXN0b20gc2VsZWN0IGRpYWxvZwoJCQkJCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZS5jYWxsKCBzZWxmLnRoaXNQYWdlICk7CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgb24gInNjcmVlbiIgb3ZlcmxheQoJCQkJc2VsZi5zY3JlZW4uYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCgkJCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQkJCXNlbGYuaGVhZGVyQ2xvc2UuY2xpY2soIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0pOwoKCQkJCS8vIHRyYWNrIHRoaXMgZGVwZW5kZW5jeSBzbyB0aGF0IHdoZW4gdGhlIHBhcmVudCBwYWdlCgkJCQkvLyBpcyByZW1vdmVkIG9uIHBhZ2VoaWRlIGl0IHdpbGwgYWxzbyByZW1vdmUgdGhlIG1lbnVwYWdlCgkJCQlzZWxmLnRoaXNQYWdlLmFkZERlcGVuZGVudHMoIHRoaXMubWVudVBhZ2UgKTsKCQkJfSwKCgkJCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgbGlzdCA9IHRoaXMubGlzdC5maW5kKCAibGkiICksCgkJCQkJb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKTsKCgkJCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCQkJLy8gaWdub3JlcyB2YWx1ZSBjaGFuZ2VzIGV0YyBpbiBmYXZvciBvZiBhIGZvcmNlZFJlYnVpbGQKCQkJCS8vIGZyb20gdGhlIHVzZXIgaW4gdGhlIHJlZnJlc2ggbWV0aG9kCgkJCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJCQl9LAoKCQkJcmVmcmVzaDogZnVuY3Rpb24oIGZvcmNlUmVidWlsZCAsIGZvbyApewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJc2VsZWN0ID0gdGhpcy5lbGVtZW50LAoJCQkJaXNNdWx0aXBsZSA9IHRoaXMuaXNNdWx0aXBsZSwKCQkJCW9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCksCgkJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJCS8vIHJldHVybiBhbiBhcnJheSBvZiBhbGwgc2VsZWN0ZWQgaW5kZXgncwoJCQkJaW5kaWNpZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQkJCWlmICggIGZvcmNlUmVidWlsZCB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQkJCXNlbGYuX2J1aWxkTGlzdCgpOwoJCQkJfQoKCQkJCXNlbGYuc2V0QnV0dG9uVGV4dCgpOwoJCQkJc2VsZi5zZXRCdXR0b25Db3VudCgpOwoKCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKQoJCQkJCS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIGZhbHNlICkKCQkJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQkJCWlmICggJC5pbkFycmF5KCBpLCBpbmRpY2llcyApID4gLTEgKSB7CgkJCQkJCQl2YXIgaXRlbSA9ICQoIHRoaXMgKTsKCgkJCQkJCQkvLyBBcmlhIHNlbGVjdGVkIGF0dHIKCQkJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCQkJLy8gTXVsdGlwbGUgc2VsZWN0czogYWRkIHRoZSAib24iIGNoZWNrYm94IHN0YXRlIHRvIHRoZSBpY29uCgkJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCQlpdGVtLmZpbmQoICIudWktaWNvbiIgKS5yZW1vdmVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiApLmFkZENsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaXRlbS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQl9LAoKCQkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09ICJwYWdlIiApIHsKCQkJCQkvLyBkb2Vzbid0IHNvbHZlIHRoZSBwb3NzaWJsZSBpc3N1ZSB3aXRoIGNhbGxpbmcgY2hhbmdlIHBhZ2UKCQkJCQkvLyB3aGVyZSB0aGUgb2JqZWN0cyBkb24ndCBkZWZpbmUgZGF0YSB1cmxzIHdoaWNoIHByZXZlbnRzIGRpYWxvZyBrZXkKCQkJCQkvLyBzdHJpcHBpbmcgLSBjaGFuZ2VQYWdlIGhhcyBpbmNvbWluZyByZWZhY3RvcgoJCQkJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5zY3JlZW4uYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJCXNlbGYubGlzdGJveC5hZGRDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApLnJlbW92ZUF0dHIoICJzdHlsZSIgKS5yZW1vdmVDbGFzcyggImluIiApOwoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkJCX0KCgkJCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJfSwKCgkJCW9wZW46IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQltZW51SGVpZ2h0ID0gc2VsZi5saXN0LnBhcmVudCgpLm91dGVySGVpZ2h0KCksCgkJCQkJbWVudVdpZHRoID0gc2VsZi5saXN0LnBhcmVudCgpLm91dGVyV2lkdGgoKSwKCQkJCQlhY3RpdmVQYWdlID0gJCggIi51aS1wYWdlLWFjdGl2ZSIgKSwKCQkJCQl0T3ZlcmZsb3cgPSAkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyAmJiAkLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZCwKCQkJCQl0U2Nyb2xsRWxlbSA9IGFjdGl2ZVBhZ2UuaXMoICIudWktbmF0aXZlLWZpeGVkIiApID8gYWN0aXZlUGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICkgOiBhY3RpdmVQYWdlOwoJCQkJCXNjcm9sbFRvcCA9IHRPdmVyZmxvdyA/IHRTY3JvbGxFbGVtLnNjcm9sbFRvcCgpIDogJCggd2luZG93ICkuc2Nyb2xsVG9wKCksCgkJCQkJYnRuT2Zmc2V0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkudG9wLAoJCQkJCXNjcmVlbkhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCwKCQkJCQlzY3JlZW5XaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoOwoKCQkJCS8vYWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCS8vcmVtb3ZlIGFmdGVyIGRlbGF5CgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0sIDMwMCk7CgoJCQkJZnVuY3Rpb24gZm9jdXNNZW51SXRlbSgpIHsKCQkJCQlzZWxmLmxpc3QuZmluZCggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5mb2N1cygpOwoJCQkJfQoKCQkJCWlmICggbWVudUhlaWdodCA+IHNjcmVlbkhlaWdodCAtIDgwIHx8ICEkLnN1cHBvcnQuc2Nyb2xsVG9wICkgewoJCQkJCS8vIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSBET00sCgkJCQkJLy8gb3RoZXJ3aXNlIHRoZSByZXN1bHRzIG9mIHNlbGVjdGluZyBhIGxpc3QgaXRlbSBpbiB0aGUgZGlhbG9nCgkJCQkJLy8gZmFsbCBpbnRvIGEgYmxhY2sgaG9sZQoJCQkJCXNlbGYudGhpc1BhZ2UudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApOwoKCQkJCQkvL2ZvciBXZWJPUy9PcGVyYSBNaW5pIChzZXQgbGFzdHNjcm9sbCB1c2luZyBidXR0b24gb2Zmc2V0KQoJCQkJCWlmICggc2Nyb2xsVG9wID09IDAgJiYgYnRuT2Zmc2V0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJCQlzZWxmLnRoaXNQYWdlLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJCQkkKCB0aGlzICkuanFtRGF0YSggImxhc3RTY3JvbGwiLCBidG5PZmZzZXQgKTsKCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQlzZWxmLm1lbnVQYWdlLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCS8vIHNpbGVudFNjcm9sbCgpIGlzIGNhbGxlZCB3aGVuZXZlciBhIHBhZ2UgaXMgc2hvd24gdG8gcmVzdG9yZQoJCQkJCQkvLyBhbnkgcHJldmlvdXMgc2Nyb2xsIHBvc2l0aW9uIHRoZSBwYWdlIG1heSBoYXZlIGhhZC4gV2UgbmVlZCB0bwoJCQkJCQkvLyB3YWl0IGZvciB0aGUgInNpbGVudHNjcm9sbCIgZXZlbnQgYmVmb3JlIHNldHRpbmcgZm9jdXMgdG8gYXZvaWQKCQkJCQkJLy8gdGhlIGJyb3dzZXIicyAiZmVhdHVyZSIgd2hpY2ggb2Zmc2V0cyByZW5kZXJpbmcgdG8gbWFrZSBzdXJlCgkJCQkJCS8vIHdoYXRldmVyIGhhcyBmb2N1cyBpcyBpbiB2aWV3LgoJCQkJCQkkKCB3aW5kb3cgKS5vbmUoICJzaWxlbnRzY3JvbGwiLCBmdW5jdGlvbigpIHsKCQkJCQkJCWZvY3VzTWVudUl0ZW0oKTsKCQkJCQkJfSk7CgoJCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQkJfSk7CgoJCQkJCXNlbGYubWVudVR5cGUgPSAicGFnZSI7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQuYXBwZW5kKCBzZWxmLmxpc3QgKTsKCQkJCQlzZWxmLm1lbnVQYWdlLmZpbmQoImRpdiAudWktdGl0bGUiKS50ZXh0KHNlbGYubGFiZWwudGV4dCgpKTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBzZWxmLm1lbnVQYWdlLCB7CgkJCQkJCXRyYW5zaXRpb246ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uCgkJCQkJfSk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubWVudVR5cGUgPSAib3ZlcmxheSI7CgoJCQkJCXNlbGYuc2NyZWVuLmhlaWdodCggJChkb2N1bWVudCkuaGVpZ2h0KCkgKQoJCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoKCQkJCQkvLyBUcnkgYW5kIGNlbnRlciB0aGUgb3ZlcmxheSBvdmVyIHRoZSBidXR0b24KCQkJCQl2YXIgcm9vbXRvcCA9IGJ0bk9mZnNldCAtIHNjcm9sbFRvcCwKCQkJCQkJcm9vbWJvdCA9IHNjcm9sbFRvcCArIHNjcmVlbkhlaWdodCAtIGJ0bk9mZnNldCwKCQkJCQkJaGFsZmhlaWdodCA9IG1lbnVIZWlnaHQgLyAyLAoJCQkJCQltYXh3aWR0aCA9IHBhcnNlRmxvYXQoIHNlbGYubGlzdC5wYXJlbnQoKS5jc3MoICJtYXgtd2lkdGgiICkgKSwKCQkJCQkJbmV3dG9wLCBuZXdsZWZ0OwoKCQkJCQlpZiAoIHJvb210b3AgPiBtZW51SGVpZ2h0IC8gMiAmJiByb29tYm90ID4gbWVudUhlaWdodCAvIDIgKSB7CgkJCQkJCW5ld3RvcCA9IGJ0bk9mZnNldCArICggc2VsZi5idXR0b24ub3V0ZXJIZWlnaHQoKSAvIDIgKSAtIGhhbGZoZWlnaHQ7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gMzBweCB0b2xlcmFuY2Ugb2ZmIHRoZSBlZGdlcwoJCQkJCQluZXd0b3AgPSByb29tdG9wID4gcm9vbWJvdCA/IHNjcm9sbFRvcCArIHNjcmVlbkhlaWdodCAtIG1lbnVIZWlnaHQgLSAzMCA6IHNjcm9sbFRvcCArIDMwOwoJCQkJCX0KCgkJCQkJLy8gSWYgdGhlIG1lbnV3aWR0aCBpcyBzbWFsbGVyIHRoYW4gdGhlIHNjcmVlbiBjZW50ZXIgaXMKCQkJCQlpZiAoIG1lbnVXaWR0aCA8IG1heHdpZHRoICkgewoJCQkJCQluZXdsZWZ0ID0gKCBzY3JlZW5XaWR0aCAtIG1lbnVXaWR0aCApIC8gMjsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy9vdGhlcndpc2UgaW5zdXJlIGEgPj0gMzBweCBvZmZzZXQgZnJvbSB0aGUgbGVmdAoJCQkJCQluZXdsZWZ0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkubGVmdCArIHNlbGYuYnV0dG9uLm91dGVyV2lkdGgoKSAvIDIgLSBtZW51V2lkdGggLyAyOwoKCQkJCQkJLy8gMzBweCB0b2xlcmFuY2Ugb2ZmIHRoZSBlZGdlcwoJCQkJCQlpZiAoIG5ld2xlZnQgPCAzMCApIHsKCQkJCQkJCW5ld2xlZnQgPSAzMDsKCQkJCQkJfSBlbHNlIGlmICggKG5ld2xlZnQgKyBtZW51V2lkdGgpID4gc2NyZWVuV2lkdGggKSB7CgkJCQkJCQluZXdsZWZ0ID0gc2NyZWVuV2lkdGggLSBtZW51V2lkdGggLSAzMDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJc2VsZi5saXN0Ym94LmFwcGVuZCggc2VsZi5saXN0ICkKCQkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2VsZWN0bWVudS1oaWRkZW4iICkKCQkJCQkJLmNzcyh7CgkJCQkJCQl0b3A6IG5ld3RvcCwKCQkJCQkJCWxlZnQ6IG5ld2xlZnQKCQkJCQkJfSkKCQkJCQkJLmFkZENsYXNzKCAiaW4iICk7CgoJCQkJCWZvY3VzTWVudUl0ZW0oKTsKCgkJCQkJLy8gZHVwbGljYXRlIHdpdGggdmFsdWUgc2V0IGluIHBhZ2Ugc2hvdyBmb3IgZGlhbG9nIHNpemVkIHNlbGVjdHMKCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQl9CgkJCX0sCgoJCQlfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJCQlvcHRncm91cHMgPSBbXSwKCQkJCQlsaXMgPSBbXSwKCQkJCQlkYXRhSWNvbiA9IHNlbGYuaXNNdWx0aXBsZSA/ICJjaGVja2JveC1vZmYiIDogImZhbHNlIjsKCgkJCQlzZWxmLmxpc3QuZW1wdHkoKS5maWx0ZXIoICIudWktbGlzdHZpZXciICkubGlzdHZpZXcoICJkZXN0cm95IiApOwoKCQkJCS8vIFBvcHVsYXRlIG1lbnUgd2l0aCBvcHRpb25zIGZyb20gc2VsZWN0IGVsZW1lbnQKCQkJCXNlbGYuc2VsZWN0LmZpbmQoICJvcHRpb24iICkuZWFjaCggZnVuY3Rpb24oIGkgKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCQkkcGFyZW50ID0gJHRoaXMucGFyZW50KCksCgkJCQkJCXRleHQgPSAkdGhpcy5nZXRFbmNvZGVkVGV4dCgpLAoJCQkJCQlhbmNob3IgPSAiPGEgaHJlZj0nIyc+IisgdGV4dCArIjwvYT4iLAoJCQkJCQljbGFzc2VzID0gW10sCgkJCQkJCWV4dHJhQXR0cnMgPSBbXTsKCgkJCQkJLy8gQXJlIHdlIGluc2lkZSBhbiBvcHRncm91cD8KCQkJCQlpZiAoICRwYXJlbnQuaXMoICJvcHRncm91cCIgKSApIHsKCQkJCQkJdmFyIG9wdExhYmVsID0gJHBhcmVudC5hdHRyKCAibGFiZWwiICk7CgoJCQkJCQkvLyBoYXMgdGhpcyBvcHRncm91cCBhbHJlYWR5IGJlZW4gYnVpbHQgeWV0PwoJCQkJCQlpZiAoICQuaW5BcnJheSggb3B0TGFiZWwsIG9wdGdyb3VwcyApID09PSAtMSApIHsKCQkJCQkJCWxpcy5wdXNoKCAiPGxpIGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2xpc3QtZGl2aWRlcic+Iisgb3B0TGFiZWwgKyI8L2xpPiIgKTsKCQkJCQkJCW9wdGdyb3Vwcy5wdXNoKCBvcHRMYWJlbCApOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBGaW5kIHBsYWNlaG9sZGVyIHRleHQKCQkJCQkvLyBUT0RPOiBBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gdXNlIGdldEF0dHJpYnV0ZT8gXlJXCgkJCQkJaWYgKCAhdGhpcy5nZXRBdHRyaWJ1dGUoICJ2YWx1ZSIgKSB8fCB0ZXh0Lmxlbmd0aCA9PSAwIHx8ICR0aGlzLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSApIHsKCQkJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQkJCWNsYXNzZXMucHVzaCggInVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgkJCQkJCX0KCQkJCQkJcGxhY2Vob2xkZXIgPSBzZWxmLnBsYWNlaG9sZGVyID0gdGV4dDsKCQkJCQl9CgoJCQkJCS8vIHN1cHBvcnQgZGlzYWJsZWQgb3B0aW9uIHRhZ3MKCQkJCQlpZiAoIHRoaXMuZGlzYWJsZWQgKSB7CgkJCQkJCWNsYXNzZXMucHVzaCggInVpLWRpc2FibGVkIiApOwoJCQkJCQlleHRyYUF0dHJzLnB1c2goICJhcmlhLWRpc2FibGVkPSd0cnVlJyIgKTsKCQkJCQl9CgoJCQkJCWxpcy5wdXNoKCAiPGxpIGRhdGEtIiArICQubW9iaWxlLm5zICsgIm9wdGlvbi1pbmRleD0nIiArIGkgKyAiJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uPSciKyBkYXRhSWNvbiArIicgY2xhc3M9JyIrIGNsYXNzZXMuam9pbigiICIpICsgIicgIiArIGV4dHJhQXR0cnMuam9pbigiICIpICsiPiIrIGFuY2hvciArIjwvbGk+IiApOwoJCQkJfSk7CgoJCQkJc2VsZi5saXN0Lmh0bWwoIGxpcy5qb2luKCIgIikgKTsKCgkJCQlzZWxmLmxpc3QuZmluZCggImxpIiApCgkJCQkJLmF0dHIoeyAicm9sZSI6ICJvcHRpb24iLCAidGFiaW5kZXgiOiAiLTEiIH0pCgkJCQkJLmZpcnN0KCkuYXR0ciggInRhYmluZGV4IiwgIjAiICk7CgoJCQkJLy8gSGlkZSBoZWFkZXIgY2xvc2UgbGluayBmb3Igc2luZ2xlIHNlbGVjdHMKCQkJCWlmICggIXRoaXMuaXNNdWx0aXBsZSApIHsKCQkJCQl0aGlzLmhlYWRlckNsb3NlLmhpZGUoKTsKCQkJCX0KCgkJCQkvLyBIaWRlIGhlYWRlciBpZiBpdCdzIG5vdCBhIG11bHRpc2VsZWN0IGFuZCB0aGVyZSdzIG5vIHBsYWNlaG9sZGVyCgkJCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJCQl0aGlzLmhlYWRlci5oaWRlKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCQkJfQoKCQkJCS8vIE5vdyBwb3B1bGF0ZWQsIGNyZWF0ZSBsaXN0dmlldwoJCQkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7CgkJCX0sCgoJCQlfYnV0dG9uOiBmdW5jdGlvbigpewoJCQkJcmV0dXJuICQoICI8YT4iLCB7CgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkJImFyaWEtaGFzcG9wdXAiOiAidHJ1ZSIsCgoJCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCQl9KTsKCQkJfQoJCX0pOwoJfTsKCgkkKCAic2VsZWN0IiApLmxpdmUoICJzZWxlY3RtZW51YmVmb3JlY3JlYXRlIiwgZnVuY3Rpb24oKXsKCQl2YXIgc2VsZWN0bWVudVdpZGdldCA9ICQoIHRoaXMgKS5kYXRhKCAic2VsZWN0bWVudSIgKTsKCgkJaWYoICFzZWxlY3RtZW51V2lkZ2V0Lm9wdGlvbnMubmF0aXZlTWVudSApewoJCQlleHRlbmRTZWxlY3QoIHNlbGVjdG1lbnVXaWRnZXQgKTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwovKgoqICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWRpc2FibGVkOiBmYWxzZSwKCQlpY29uOiAiYXJyb3ctZCIsCgkJaWNvbnBvczogInJpZ2h0IiwKCQlpbmxpbmU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQltZW51UGFnZVRoZW1lOiAiYiIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zOiB0cnVlLAoJCWNsb3NlVGV4dDogIkNsb3NlIiwKCQluYXRpdmVNZW51OiB0cnVlLAoJCWluaXRTZWxlY3RvcjogInNlbGVjdDpub3QoOmpxbURhdGEocm9sZT0nc2xpZGVyJykpIgoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKICBfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKICB9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKXsKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0Jz4iICk7CgkJdGhpcy5zZWxlY3RJRCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICk7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SUQgKyInXSIgKS5hZGRDbGFzcyggInVpLXNlbGVjdCIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuc2VsZWN0LCAiYyIgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKIAkJLy8gQWxsb3dzIGZvciBleHRlbnNpb24gb2YgdGhlIG5hdGl2ZSBzZWxlY3QgZm9yIGN1c3RvbSBzZWxlY3RzIGFuZCBvdGhlciBwbHVnaW5zCgkJLy8gc2VlIHNlbGVjdC5jdXN0b20gZm9yIGV4YW1wbGUgZXh0ZW5zaW9uCgkJLy8gVE9ETyBleHBsb3JlIHBsdWdpbiByZWdpc3RyYXRpb24KCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlQ3JlYXRlIiApOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJLy8gSUUgdGhyb3dzIGFuIGV4Y2VwdGlvbiBhdCBvcHRpb25zLml0ZW0oKSBmdW5jdGlvbiB3aGVuCgkJCS8vIHRoZXJlIGlzIG5vIHNlbGVjdGVkIGl0ZW0KCQkJLy8gc2VsZWN0IGZpcnN0IGluIHRoaXMgY2FzZQoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4ID09IC0xID8gMCA6IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCgkJCS8vIFRPRE8gdmFsdWVzIGJ1dHRvbklkIGFuZCBtZW51SWQgYXJlIHVuZGVmaW5lZCBoZXJlCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkudGV4dCggJCggdGhpcy5zZWxlY3RbIDAgXS5vcHRpb25zLml0ZW0oIHNlbGVjdGVkSW5kZXggKSApLnRleHQoKSApCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYnV0dG9uTWFya3VwKCB7CgkJCQkJdGhlbWU6IG9wdGlvbnMudGhlbWUsCgkJCQkJaWNvbjogb3B0aW9ucy5pY29uLAoJCQkJCWljb25wb3M6IG9wdGlvbnMuaWNvbnBvcywKCQkJCQlpbmxpbmU6IG9wdGlvbnMuaW5saW5lLAoJCQkJCWNvcm5lcnM6IG9wdGlvbnMuY29ybmVycywKCQkJCQlzaGFkb3c6IG9wdGlvbnMuc2hhZG93LAoJCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdwoJCQkJfSk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJdGhpcy5zZWxlY3QuYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1idG4tdXAtYyB1aS1idG4tY29ybmVyLWFsbCIgKQoJCQkJLmhpZGUoKQoJCQkJLmFwcGVuZFRvKCBidXR0b24uYWRkQ2xhc3MoJ3VpLWxpLWhhcy1jb3VudCcpICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0cignZGlzYWJsZWQnKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIEV2ZW50cyBvbiBuYXRpdmUgc2VsZWN0CgkJdGhpcy5zZWxlY3QuY2hhbmdlKCBmdW5jdGlvbigpIHsKCQkJc2VsZi5yZWZyZXNoKCk7CgkJfSk7CgoJCXRoaXMuYnVpbGQoKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5zZWxlY3QKCQkJLmFwcGVuZFRvKCBzZWxmLmJ1dHRvbiApCgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIHZtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoJCQl9KQoJCQkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCS8vIFJlbW92ZSBhY3RpdmUgY2xhc3Mgb24gc2Nyb2xsL3RvdWNobW92ZQoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIgdm1vdXNlb3V0IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3V0IiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWJ0bi1kb3duLSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKTsKCQkJfSk7Cgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5pbmRleCggdGhpcyApOwoJCX0pLmdldCgpOwoJfSwKCglzZXRCdXR0b25UZXh0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLnRleHQoIGZ1bmN0aW9uKCkgewoJCQlpZiAoICFzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQlyZXR1cm4gc2VsZWN0ZWQudGV4dCgpOwoJCQl9CgoJCQlyZXR1cm4gc2VsZWN0ZWQubGVuZ3RoID8gc2VsZWN0ZWQubWFwKCBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQl9KS5nZXQoKS5qb2luKCAiLCAiICkgOiBzZWxmLnBsYWNlaG9sZGVyOwoJCX0pOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuc2VsZWN0bWVudS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cn0pKCBqUXVlcnkgKTsKLyoKKiAiYnV0dG9ucyIgcGx1Z2luIC0gZm9yIG1ha2luZyBidXR0b24tbGlrZSBsaW5rcwoqLwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5idXR0b25NYXJrdXAgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKCWZvciAoIHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKysgKSB7CgkJdmFyIGVsID0gdGhpcy5lcSggaSApLAoJCQllID0gZWxbIDAgXSwKCQkJbyA9ICQuZXh0ZW5kKCB7fSwgJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMsIHsKCQkJCWljb246ICAgICAgIG9wdGlvbnMuaWNvbiAgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29uICAgICAgIDogZWwuanFtRGF0YSggImljb24iICksCgkJCQlpY29ucG9zOiAgICBvcHRpb25zLmljb25wb3MgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbnBvcyAgICA6IGVsLmpxbURhdGEoICJpY29ucG9zIiApLAoJCQkJdGhlbWU6ICAgICAgb3B0aW9ucy50aGVtZSAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnRoZW1lICAgICAgOiBlbC5qcW1EYXRhKCAidGhlbWUiICksCgkJCQlpbmxpbmU6ICAgICBvcHRpb25zLmlubGluZSAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaW5saW5lICAgICA6IGVsLmpxbURhdGEoICJpbmxpbmUiICksCgkJCQlzaGFkb3c6ICAgICBvcHRpb25zLnNoYWRvdyAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc2hhZG93ICAgICA6IGVsLmpxbURhdGEoICJzaGFkb3ciICksCgkJCQljb3JuZXJzOiAgICBvcHRpb25zLmNvcm5lcnMgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY29ybmVycyAgICA6IGVsLmpxbURhdGEoICJjb3JuZXJzIiApLAoJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25zaGFkb3cgOiBlbC5qcW1EYXRhKCAiaWNvbnNoYWRvdyIgKQoJCQl9LCBvcHRpb25zICksCgoJCQkvLyBDbGFzc2VzIERlZmluZWQKCQkJaW5uZXJDbGFzcyA9ICJ1aS1idG4taW5uZXIiLAoJCQl0ZXh0Q2xhc3MgPSAidWktYnRuLXRleHQiLAoJCQlidXR0b25DbGFzcywgaWNvbkNsYXNzLAoKCQkJLy8gQnV0dG9uIGlubmVyIG1hcmt1cAoJCQlidXR0b25Jbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApLAoJCQlidXR0b25UZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggby53cmFwcGVyRWxzICksCgkJCWJ1dHRvbkljb24gPSBvLmljb24gPyBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSA6IG51bGw7CgoJCWlmICggYXR0YWNoRXZlbnRzICkgewoJCQlhdHRhY2hFdmVudHMoKTsKCQl9CgoJCS8vIGlmIG5vdCwgdHJ5IHRvIGZpbmQgY2xvc2VzdCB0aGVtZSBjb250YWluZXIKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGVsLCAiYyIgKTsKCQl9CgoJCWJ1dHRvbkNsYXNzID0gInVpLWJ0biB1aS1idG4tdXAtIiArIG8udGhlbWU7CgoJCWlmICggby5pbmxpbmUgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWlubGluZSI7CgkJfQoKCQlpZiAoIG8uaWNvbiApIHsKCQkJby5pY29uID0gInVpLWljb24tIiArIG8uaWNvbjsKCQkJby5pY29ucG9zID0gby5pY29ucG9zIHx8ICJsZWZ0IjsKCgkJCWljb25DbGFzcyA9ICJ1aS1pY29uICIgKyBvLmljb247CgoJCQlpZiAoIG8uaWNvbnNoYWRvdyApIHsKCQkJCWljb25DbGFzcyArPSAiIHVpLWljb24tc2hhZG93IjsKCQkJfQoJCX0KCgkJaWYgKCBvLmljb25wb3MgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWljb24tIiArIG8uaWNvbnBvczsKCgkJCWlmICggby5pY29ucG9zID09ICJub3RleHQiICYmICFlbC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCQllbC5hdHRyKCAidGl0bGUiLCBlbC5nZXRFbmNvZGVkVGV4dCgpICk7CgkJCX0KCQl9CgoJCWlmICggby5jb3JuZXJzICkgewoJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi1jb3JuZXItYWxsIjsKCQkJaW5uZXJDbGFzcyArPSAiIHVpLWJ0bi1jb3JuZXItYWxsIjsKCQl9CgoJCWlmICggby5zaGFkb3cgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktc2hhZG93IjsKCQl9CgoJCWUuc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiLCBvLnRoZW1lICk7CgkJZWwuYWRkQ2xhc3MoIGJ1dHRvbkNsYXNzICk7CgoJCWJ1dHRvbklubmVyLmNsYXNzTmFtZSA9IGlubmVyQ2xhc3M7CgkJYnV0dG9uSW5uZXIuc2V0QXR0cmlidXRlKCJhcmlhLWhpZGRlbiIsICJ0cnVlIik7CgoJCWJ1dHRvblRleHQuY2xhc3NOYW1lID0gdGV4dENsYXNzOwoJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25UZXh0ICk7CgoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJYnV0dG9uSWNvbi5jbGFzc05hbWUgPSBpY29uQ2xhc3M7CgkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25JY29uICk7CgkJfQoKCQl3aGlsZSAoIGUuZmlyc3RDaGlsZCApIHsKCQkJYnV0dG9uVGV4dC5hcHBlbmRDaGlsZCggZS5maXJzdENoaWxkICk7CgkJfQoKCQllLmFwcGVuZENoaWxkKCBidXR0b25Jbm5lciApOwoJCQoJCS8vIFRPRE8gb2J2aW91c2x5IGl0IHdvdWxkIGJlIG5pY2UgdG8gcHVsbCB0aGlzIGVsZW1lbnQgb3V0IGluc3RlYWQgb2YKCQkvLyByZXRyaWV2aW5nIGl0IGZyb20gdGhlIERPTSBhZ2FpbiwgYnV0IHRoaXMgY2hhbmdlIGlzIG11Y2ggbGVzcyBvYnRydXNpdmUKCQkvLyBhbmQgMS4wIGRyYXdzIG5pZ2gKCQkkLmRhdGEoIGUsICd0ZXh0V3JhcHBlcicsICQoIGJ1dHRvblRleHQgKSApOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7Cgljb3JuZXJzOiB0cnVlLAoJc2hhZG93OiB0cnVlLAoJaWNvbnNoYWRvdzogdHJ1ZSwKCWlubGluZTogZmFsc2UsCgl3cmFwcGVyRWxzOiAic3BhbiIKfTsKCmZ1bmN0aW9uIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBlbGVtZW50ICkgewogICAgdmFyIGNuYW1lOwoKICAgIHdoaWxlICggZWxlbWVudCApIHsKCQkvLyBOb3RlIHRoYXQgd2UgY2hlY2sgZm9yIHR5cGVvZiBjbGFzc05hbWUgYmVsb3cgYmVjYXVzZSB0aGUgZWxlbWVudCB3ZQoJCS8vIGhhbmRlZCBjb3VsZCBiZSBpbiBhbiBTVkcgRE9NIHdoZXJlIGNsYXNzTmFtZSBvbiBTVkcgZWxlbWVudHMgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIG9mIGEgZGlmZmVyZW50IHR5cGUgKFNWR0FuaW1hdGVkU3RyaW5nKS4gV2Ugb25seSBvcGVyYXRlIG9uIEhUTUwgRE9NCgkJLy8gZWxlbWVudHMsIHNvIHdlIGxvb2sgZm9yIHBsYWluICJzdHJpbmciLgoKICAgICAgICBjbmFtZSA9ICggdHlwZW9mIGVsZW1lbnQuY2xhc3NOYW1lID09PSAnc3RyaW5nJyApICYmIGVsZW1lbnQuY2xhc3NOYW1lLnNwbGl0KCcgJyk7CgogICAgICAgIGlmICggY25hbWUgJiYgJC5pbkFycmF5KCAidWktYnRuIiwgY25hbWUgKSA+IC0xICYmICQuaW5BcnJheSggInVpLWRpc2FibGVkIiwgY25hbWUgKSA8IDAgKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgfQoKICAgIHJldHVybiBlbGVtZW50Owp9Cgp2YXIgYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24oKSB7CgkkKCBkb2N1bWVudCApLmJpbmQoIHsKCQkidm1vdXNlZG93biI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGJ0biA9IGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSwKCQkJCSRidG4sIHRoZW1lOwoKCQkJaWYgKCBidG4gKSB7CgkJCQkkYnRuID0gJCggYnRuICk7CgkJCQl0aGVtZSA9ICRidG4uYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiApOwoJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB0aGVtZSApOwoJCQl9CgkJfSwKCQkidm1vdXNlY2FuY2VsIHZtb3VzZXVwIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgYnRuID0gY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApLAoJCQkJJGJ0biwgdGhlbWU7CgoJCQlpZiAoIGJ0biApIHsKCQkJCSRidG4gPSAkKCBidG4gKTsKCQkJCXRoZW1lID0gJGJ0bi5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiICk7CgkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICk7CgkJCX0KCQl9LAoJCSJ2bW91c2VvdmVyIGZvY3VzIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgYnRuID0gY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApLAoJCQkJJGJ0biwgdGhlbWU7CgoJCQlpZiAoIGJ0biApIHsKCQkJCSRidG4gPSAkKCBidG4gKTsKCQkJCXRoZW1lID0gJGJ0bi5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiICk7CgkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSApOwoJCQl9CgkJfSwKCQkidm1vdXNlb3V0IGJsdXIiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBidG4gPSBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICksCgkJCQkkYnRuLCB0aGVtZTsKCgkJCWlmICggYnRuICkgewoJCQkJJGJ0biA9ICQoIGJ0biApOwoJCQkJdGhlbWUgPSAkYnRuLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIgKTsKCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4taG92ZXItIiArIHRoZW1lICArICIgdWktYnRuLWRvd24tIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICk7CgkJCX0KCQl9Cgl9KTsKCglhdHRhY2hFdmVudHMgPSBudWxsOwp9OwoKLy9saW5rcyBpbiBiYXJzLCBvciB0aG9zZSB3aXRoICBkYXRhLXJvbGUgYmVjb21lIGJ1dHRvbnMKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCgkkKCAiOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktaGVhZGVyID4gYSwgLnVpLWZvb3RlciA+IGEsIC51aS1iYXIgPiA6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSA+IGEiLCBlLnRhcmdldCApCgkJLm5vdCggIi51aS1idG4sIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmJ1dHRvbk1hcmt1cCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyogCiogImNvbnRyb2xncm91cCIgcGx1Z2luIC0gY29ybmVyLXJvdW5kaW5nIGZvciBncm91cHMgb2YgYnV0dG9ucywgY2hlY2tzLCByYWRpb3MsIGV0YwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmNvbnRyb2xncm91cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkZWwgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQkJCWRpcmVjdGlvbjogJGVsLmpxbURhdGEoICJ0eXBlIiApIHx8ICJ2ZXJ0aWNhbCIsCgkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCWV4Y2x1ZGVJbnZpc2libGU6IHRydWUKCQkJCQl9LCBvcHRpb25zICksCgkJCWdyb3VwaGVhZGluZyA9ICRlbC5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJZmxDb3JuZXJzID0gby5kaXJlY3Rpb24gPT0gImhvcml6b250YWwiID8gWyAidWktY29ybmVyLWxlZnQiLCAidWktY29ybmVyLXJpZ2h0IiBdIDogWyAidWktY29ybmVyLXRvcCIsICJ1aS1jb3JuZXItYm90dG9tIiBdLAoJCQl0eXBlID0gJGVsLmZpbmQoICJpbnB1dCIgKS5maXJzdCgpLmF0dHIoICJ0eXBlIiApOwoKCQkvLyBSZXBsYWNlIGxlZ2VuZCB3aXRoIG1vcmUgc3R5bGFibGUgcmVwbGFjZW1lbnQgZGl2CgkJaWYgKCBncm91cGhlYWRpbmcubGVuZ3RoICkgewoJCQkkZWwud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29udHJvbGdyb3VwLWNvbnRyb2xzJz48L2Rpdj4iICk7CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPiIgKyBncm91cGhlYWRpbmcuaHRtbCgpICsgIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoICRlbC5jaGlsZHJlbigwKSApOwoJCQlncm91cGhlYWRpbmcucmVtb3ZlKCk7CgkJfQoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLWNvbnRyb2xncm91cCB1aS1jb250cm9sZ3JvdXAtIiArIG8uZGlyZWN0aW9uICk7CgoJCS8vIFRPRE86IFRoaXMgc2hvdWxkIGJlIG1vdmVkIG91dCB0byB0aGUgY2xvc3VyZQoJCS8vIG90aGVyd2lzZSBpdCBpcyByZWRlZmluZWQgZWFjaCB0aW1lIGNvbnRyb2xncm91cCgpIGlzIGNhbGxlZAoJCWZ1bmN0aW9uIGZsaXBDbGFzc2VzKCBlbHMgKSB7CgkJCWVscy5yZW1vdmVDbGFzcyggInVpLWJ0bi1jb3JuZXItYWxsIHVpLXNoYWRvdyIgKQoJCQkJLmVxKCAwICkuYWRkQ2xhc3MoIGZsQ29ybmVyc1sgMCBdICkKCQkJCS5lbmQoKQoJCQkJLmxhc3QoKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAxIF0gKS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC1sYXN0IiApOwoJCX0KCgkJZmxpcENsYXNzZXMoICRlbC5maW5kKCAiLnVpLWJ0biIgKyAoIG8uZXhjbHVkZUludmlzaWJsZSA/ICI6dmlzaWJsZSIgOiAiIiApICkgKTsKCQlmbGlwQ2xhc3NlcyggJGVsLmZpbmQoICIudWktYnRuLWlubmVyIiApICk7CgoJCWlmICggby5zaGFkb3cgKSB7CgkJCSRlbC5hZGRDbGFzcyggInVpLXNoYWRvdyIgKTsKCQl9Cgl9KTsKfTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkKCAiOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykiLCBlLnRhcmdldCApLmNvbnRyb2xncm91cCh7IGV4Y2x1ZGVJbnZpc2libGU6IGZhbHNlIH0pOwp9KTsKCn0pKGpRdWVyeSk7LyoKKiAibGlua3MiIHBsdWdpbiAtIHNpbXBsZSBjbGFzcyBhZGRpdGlvbnMgZm9yIGxpbmtzCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCQoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcwoJJCggZS50YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5ub3QoICIudWktYnRuLCAudWktbGluay1pbmhlcml0LCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5hZGRDbGFzcyggInVpLWxpbmsiICk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJmaXhIZWFkZXJGb290ZXIiIHBsdWdpbiAtIG9uLWRlbWFuZCBwb3NpdGlvbmluZyBmb3IgaGVhZGVycyxmb290ZXJzCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBzbGlkZURvd25DbGFzcyA9ICJ1aS1oZWFkZXItZml4ZWQgdWktZml4ZWQtaW5saW5lIGZhZGUiLAoJc2xpZGVVcENsYXNzID0gInVpLWZvb3Rlci1maXhlZCB1aS1maXhlZC1pbmxpbmUgZmFkZSIsCgoJc2xpZGVEb3duU2VsZWN0b3IgPSAiLnVpLWhlYWRlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIiwKCXNsaWRlVXBTZWxlY3RvciA9ICIudWktZm9vdGVyOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiOwoKJC5mbi5maXhIZWFkZXJGb290ZXIgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCglpZiAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICggJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgKSApIHsKCQlyZXR1cm4gdGhpczsKCX0KCglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJaWYgKCAkdGhpcy5qcW1EYXRhKCAiZnVsbHNjcmVlbiIgKSApIHsKCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1wYWdlLWZ1bGxzY3JlZW4iICk7CgkJfQoKCQkvLyBTaG91bGQgYmUgc2xpZGVkb3duCgkJJHRoaXMuZmluZCggc2xpZGVEb3duU2VsZWN0b3IgKS5hZGRDbGFzcyggc2xpZGVEb3duQ2xhc3MgKTsKCgkJLy8gU2hvdWxkIGJlIHNsaWRldXAKCQkkdGhpcy5maW5kKCBzbGlkZVVwU2VsZWN0b3IgKS5hZGRDbGFzcyggc2xpZGVVcENsYXNzICk7Cgl9KTsKfTsKCi8vIHNpbmdsZSBjb250cm9sbGVyIGZvciBhbGwgc2hvd2luZyxoaWRpbmcsdG9nZ2xpbmcKJC5tb2JpbGUuZml4ZWRUb29sYmFycyA9IChmdW5jdGlvbigpIHsKCglpZiAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICggJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgKSApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHN0aWNreUZvb3RlciwgZGVsYXlUaW1lciwKCQljdXJyZW50c3RhdGUgPSAiaW5saW5lIiwKCQlhdXRvSGlkZU1vZGUgPSBmYWxzZSwKCQlzaG93RGVsYXkgPSAxMDAsCgkJaWdub3JlVGFyZ2V0cyA9ICJhLGlucHV0LHRleHRhcmVhLHNlbGVjdCxidXR0b24sbGFiZWwsLnVpLWhlYWRlci1maXhlZCwudWktZm9vdGVyLWZpeGVkIiwKCQl0b29sYmFyU2VsZWN0b3IgPSAiLnVpLWhlYWRlci1maXhlZDpmaXJzdCwgLnVpLWZvb3Rlci1maXhlZDpub3QoLnVpLWZvb3Rlci1kdXBsaWNhdGUpOmxhc3QiLAoJCS8vIGZvciBzdG9yaW5nIHF1aWNrIHJlZmVyZW5jZXMgdG8gZHVwbGljYXRlIGZvb3RlcnMKCQlzdXBwb3J0VG91Y2ggPSAkLnN1cHBvcnQudG91Y2gsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXN0YXRlQmVmb3JlID0gbnVsbCwKCQlzY3JvbGxUcmlnZ2VyZWQgPSBmYWxzZSwKCQl0b3VjaFRvZ2dsZUVuYWJsZWQgPSB0cnVlOwoKCWZ1bmN0aW9uIHNob3dFdmVudENhbGxiYWNrKCBldmVudCApIHsKCQkvLyBBbiBldmVudCB0aGF0IGFmZmVjdHMgdGhlIGRpbWVuc2lvbnMgb2YgdGhlIHZpc3VhbCB2aWV3cG9ydCBoYXMKCQkvLyBiZWVuIHRyaWdnZXJlZC4gSWYgdGhlIGhlYWRlciBhbmQvb3IgZm9vdGVyIGZvciB0aGUgY3VycmVudCBwYWdlIGFyZSBpbiBvdmVybGF5CgkJLy8gbW9kZSwgd2Ugd2FudCB0byBoaWRlIHRoZW0sIGFuZCB0aGVuIGZpcmUgb2ZmIGEgdGltZXIgdG8gc2hvdyB0aGVtIGF0IGEgbGF0ZXIKCQkvLyBwb2ludC4gRXZlbnRzIGxpa2UgYSByZXNpemUgY2FuIGJlIHRyaWdnZXJlZCBjb250aW51b3VzbHkgZHVyaW5nIGEgc2Nyb2xsLCBvbgoJCS8vIHNvbWUgcGxhdGZvcm1zLCBzbyB0aGUgdGltZXIgaXMgdXNlZCB0byBkZWxheSB0aGUgYWN0dWFsIHBvc2l0aW9uaW5nIHVudGlsIHRoZQoJCS8vIGZsb29kIG9mIGV2ZW50cyBoYXZlIHN1YnNpZGVkLgoJCS8vCgkJLy8gSWYgd2UgYXJlIGluIGF1dG9IaWRlTW9kZSwgd2UgZG9uJ3QgZG8gYW55dGhpbmcgYmVjYXVzZSB3ZSBrbm93IHRoZSBzY3JvbGwKCQkvLyBjYWxsYmFja3MgZm9yIHRoZSBwbHVnaW4gd2lsbCBmaXJlIG9mZiBhIHNob3cgd2hlbiB0aGUgc2Nyb2xsaW5nIGhhcyBzdG9wcGVkLgoJCWlmICggIWF1dG9IaWRlTW9kZSAmJiBjdXJyZW50c3RhdGUgPT09ICJvdmVybGF5IiApIHsKCQkJaWYgKCAhZGVsYXlUaW1lciApIHsKCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuaGlkZSggdHJ1ZSApOwoJCQl9CgoJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLnN0YXJ0U2hvd1RpbWVyKCk7CgkJfQoJfQoKCSQoZnVuY3Rpb24oKSB7CgkJdmFyICRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICksCgkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCgkJJGRvY3VtZW50CgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdG91Y2hUb2dnbGVFbmFibGVkICkgewoJCQkJCXN0YXRlQmVmb3JlID0gY3VycmVudHN0YXRlOwoJCQkJfQoJCQl9KQoJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdG91Y2hUb2dnbGVFbmFibGVkICkgewoKCQkJCQlpZiAoICQoZXZlbnQudGFyZ2V0KS5jbG9zZXN0KCBpZ25vcmVUYXJnZXRzICkubGVuZ3RoICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlpZiAoICFzY3JvbGxUcmlnZ2VyZWQgKSB7CgkJCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMudG9nZ2xlKCBzdGF0ZUJlZm9yZSApOwoJCQkJCQlzdGF0ZUJlZm9yZSA9IG51bGw7CgkJCQkJfQoJCQkJfQoJCQl9KQoJCQkuYmluZCggInNpbGVudHNjcm9sbCIsIHNob3dFdmVudENhbGxiYWNrICk7CgoKCQkvLyBUaGUgYmVsb3cgY2hlY2tzIGZpcnN0IGZvciBhICQoZG9jdW1lbnQpLnNjcm9sbFRvcCgpIHZhbHVlLCBhbmQgaWYgemVybywgYmluZHMgc2Nyb2xsIGV2ZW50cyB0byAkKHdpbmRvdykgaW5zdGVhZC4KCQkvLyBJZiB0aGUgc2Nyb2xsVG9wIHZhbHVlIGlzIGFjdHVhbGx5IHplcm8sIGJvdGggd2lsbCByZXR1cm4gemVybyBhbnl3YXkuCgkJLy8KCQkvLyBXb3JrcyB3aXRoICQoZG9jdW1lbnQpLCBub3QgJCh3aW5kb3cpIDogT3BlcmEgTW9iaWxlIChXaW5NTyBwaG9uZTsga2luZGEgYnJva2VuIGFueXdheSkKCQkvLyBXb3JrcyB3aXRoICQod2luZG93KSwgbm90ICQoZG9jdW1lbnQpIDogSUUgNy84CgkJLy8gV29ya3Mgd2l0aCBlaXRoZXIgJCh3aW5kb3cpIG9yICQoZG9jdW1lbnQpIDogQ2hyb21lLCBGRiAzLjYvNCwgQW5kcm9pZCAxLjYvMi4xLCBpT1MKCQkvLyBOZWVkcyB3b3JrIGVpdGhlciB3YXkgOiBCQjUsIE9wZXJhIE1vYmlsZSAoaU9TKQoKCQkoICggJGRvY3VtZW50LnNjcm9sbFRvcCgpID09PSAwICkgPyAkd2luZG93IDogJGRvY3VtZW50ICkKCQkJLmJpbmQoICJzY3JvbGxzdGFydCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlzY3JvbGxUcmlnZ2VyZWQgPSB0cnVlOwoKCQkJCWlmICggc3RhdGVCZWZvcmUgPT09IG51bGwgKSB7CgkJCQkJc3RhdGVCZWZvcmUgPSBjdXJyZW50c3RhdGU7CgkJCQl9CgoJCQkJLy8gV2Ugb25seSBlbnRlciBhdXRvSGlkZU1vZGUgaWYgdGhlIGhlYWRlcnMvZm9vdGVycyBhcmUgaW4KCQkJCS8vIGFuIG92ZXJsYXkgc3RhdGUgb3IgdGhlIHNob3cgdGltZXIgd2FzIHN0YXJ0ZWQuIElmIHRoZQoJCQkJLy8gc2hvdyB0aW1lciBpcyBzZXQsIGNsZWFyIGl0IHNvIHRoZSBoZWFkZXJzL2Zvb3RlcnMgZG9uJ3QKCQkJCS8vIHNob3cgdXAgdW50aWwgYWZ0ZXIgd2UncmUgZG9uZSBzY3JvbGxpbmcuCgkJCQl2YXIgaXNPdmVybGF5U3RhdGUgPSBzdGF0ZUJlZm9yZSA9PSAib3ZlcmxheSI7CgoJCQkJYXV0b0hpZGVNb2RlID0gaXNPdmVybGF5U3RhdGUgfHwgISFkZWxheVRpbWVyOwoKCQkJCWlmICggYXV0b0hpZGVNb2RlICkgewoJCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuY2xlYXJTaG93VGltZXIoKTsKCgkJCQkJaWYgKCBpc092ZXJsYXlTdGF0ZSApIHsKCQkJCQkJJC5tb2JpbGUuZml4ZWRUb29sYmFycy5oaWRlKCB0cnVlICk7CgkJCQkJfQoJCQkJfQoJCQl9KQoJCQkuYmluZCggInNjcm9sbHN0b3AiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBpZ25vcmVUYXJnZXRzICkubGVuZ3RoICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlzY3JvbGxUcmlnZ2VyZWQgPSBmYWxzZTsKCgkJCQlpZiAoIGF1dG9IaWRlTW9kZSApIHsKCQkJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLnN0YXJ0U2hvd1RpbWVyKCk7CgkJCQkJYXV0b0hpZGVNb2RlID0gZmFsc2U7CgkJCQl9CgkJCQlzdGF0ZUJlZm9yZSA9IG51bGw7CgkJCX0pOwoKCQkJJHdpbmRvdy5iaW5kKCAicmVzaXplIHVwZGF0ZWxheW91dCIsIHNob3dFdmVudENhbGxiYWNrICk7Cgl9KTsKCgkvLyAxLiBCZWZvcmUgcGFnZSBpcyBzaG93biwgY2hlY2sgZm9yIGR1cGxpY2F0ZSBmb290ZXIKCS8vIDIuIEFmdGVyIHBhZ2UgaXMgc2hvd24sIGFwcGVuZCBmb290ZXIgdG8gbmV3IHBhZ2UKCSQoICIudWktcGFnZSIgKQoJCS5saXZlKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoKCQkJdmFyIHBhZ2UgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJCWZvb3RlciA9IHBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLAoJCQkJaWQgPSBmb290ZXIuZGF0YSggImlkIiApLAoJCQkJcHJldlBhZ2UgPSB1aS5wcmV2UGFnZSwKCQkJCXByZXZGb290ZXIgPSBwcmV2UGFnZSAmJiBwcmV2UGFnZS5maW5kKCAiOmpxbURhdGEocm9sZT0nZm9vdGVyJykiICksCgkJCQlwcmV2Rm9vdGVyTWF0Y2hlcyA9IHByZXZGb290ZXIubGVuZ3RoICYmIHByZXZGb290ZXIuanFtRGF0YSggImlkIiApID09PSBpZDsKCgkJCWlmICggaWQgJiYgcHJldkZvb3Rlck1hdGNoZXMgKSB7CgkJCQlzdGlja3lGb290ZXIgPSBmb290ZXI7CgkJCQlzZXRUb3AoIHN0aWNreUZvb3Rlci5yZW1vdmVDbGFzcyggImZhZGUgaW4gb3V0IiApLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICkgKTsKCQkJfQoJCX0pCgkJLmxpdmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoIHN0aWNreUZvb3RlciAmJiBzdGlja3lGb290ZXIubGVuZ3RoICkgewoKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJc2V0VG9wKCBzdGlja3lGb290ZXIuYXBwZW5kVG8oICR0aGlzICkuYWRkQ2xhc3MoICJmYWRlIiApICk7CgkJCQkJc3RpY2t5Rm9vdGVyID0gbnVsbDsKCQkJCX0sIDUwMCk7CgkJCX0KCgkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuc2hvdyggdHJ1ZSwgdGhpcyApOwoJCX0pOwoKCS8vIFdoZW4gYSBjb2xsYXBzaWFibGUgaXMgaGlkZGVuIG9yIHNob3duIHdlIG5lZWQgdG8gdHJpZ2dlciB0aGUgZml4ZWQgdG9vbGJhciB0byByZXBvc2l0aW9uIGl0c2VsZiAoIzE2MzUpCgkkKCAiLnVpLWNvbGxhcHNpYmxlLWNvbnRhaW4iICkubGl2ZSggImNvbGxhcHNlIGV4cGFuZCIsIHNob3dFdmVudENhbGxiYWNrICk7CgoJLy8gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSBpcyBicm9rZW4gaW4gaU9TIDMuMi4xIG9uIHRoZSBpUGFkLiBUaGUKCS8vIGNvb3JkaW5hdGVzIGluc2lkZSBvZiB0aGUgcmVjdCBpdCByZXR1cm5zIGRvbid0IGhhdmUgdGhlIHBhZ2Ugc2Nyb2xsIHBvc2l0aW9uCgkvLyBmYWN0b3JlZCBvdXQgb2YgaXQgbGlrZSB0aGUgb3RoZXIgcGxhdGZvcm1zIGRvLiBUbyBnZXQgYXJvdW5kIHRoaXMsCgkvLyB3ZSdsbCBqdXN0IGNhbGN1bGF0ZSB0aGUgdG9wIG9mZnNldCB0aGUgb2xkIGZhc2hpb25lZCB3YXkgdW50aWwgY29yZSBoYXMKCS8vIGEgY2hhbmNlIHRvIGZpZ3VyZSBvdXQgaG93IHRvIGhhbmRsZSB0aGlzIHNpdHVhdGlvbi4KCS8vCgkvLyBUT0RPOiBXZSdsbCBuZWVkIHRvIGdldCByaWQgb2YgZ2V0T2Zmc2V0VG9wKCkgb25jZSBhIGZpeCBnZXRzIGZvbGRlZCBpbnRvIGNvcmUuCgoJZnVuY3Rpb24gZ2V0T2Zmc2V0VG9wKCBlbGUgKSB7CgkJdmFyIHRvcCA9IDAsCgkJCW9wLCBib2R5OwoKCQlpZiAoIGVsZSApIHsKCQkJYm9keSA9IGRvY3VtZW50LmJvZHk7CgkJCW9wID0gZWxlLm9mZnNldFBhcmVudDsKCQkJdG9wID0gZWxlLm9mZnNldFRvcDsKCgkJCXdoaWxlICggZWxlICYmIGVsZSAhPSBib2R5ICkgewoJCQkJdG9wICs9IGVsZS5zY3JvbGxUb3AgfHwgMDsKCgkJCQlpZiAoIGVsZSA9PSBvcCApIHsKCQkJCQl0b3AgKz0gb3Aub2Zmc2V0VG9wOwoJCQkJCW9wID0gZWxlLm9mZnNldFBhcmVudDsKCQkJCX0KCgkJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQkJfQoJCX0KCQlyZXR1cm4gdG9wOwoJfQoKCWZ1bmN0aW9uIHNldFRvcCggZWwgKSB7CgkJdmFyIGZyb21Ub3AgPSAkKHdpbmRvdykuc2Nyb2xsVG9wKCksCgkJCXRoaXNUb3AgPSBnZXRPZmZzZXRUb3AoIGVsWyAwIF0gKSwgLy8gZWwub2Zmc2V0KCkudG9wIHJldHVybnMgdGhlIHdyb25nIHZhbHVlIG9uIGlQYWQgaU9TIDMuMi4xLCBjYWxsIG91ciB3b3JrYXJvdW5kIGluc3RlYWQuCgkJCXRoaXNDU1N0b3AgPSBlbC5jc3MoICJ0b3AiICkgPT0gImF1dG8iID8gMCA6IHBhcnNlRmxvYXQoZWwuY3NzKCAidG9wIiApKSwKCQkJc2NyZWVuSGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0LAoJCQl0aGlzSGVpZ2h0ID0gZWwub3V0ZXJIZWlnaHQoKSwKCQkJdXNlUmVsYXRpdmUgPSBlbC5wYXJlbnRzKCAiLnVpLXBhZ2U6bm90KC51aS1wYWdlLWZ1bGxzY3JlZW4pIiApLmxlbmd0aCwKCQkJcmVsdmFsOwoKCQlpZiAoIGVsLmlzKCAiLnVpLWhlYWRlci1maXhlZCIgKSApIHsKCgkJCXJlbHZhbCA9IGZyb21Ub3AgLSB0aGlzVG9wICsgdGhpc0NTU3RvcDsKCgkJCWlmICggcmVsdmFsIDwgdGhpc1RvcCApIHsKCQkJCXJlbHZhbCA9IDA7CgkJCX0KCgkJCXJldHVybiBlbC5jc3MoICJ0b3AiLCB1c2VSZWxhdGl2ZSA/IHJlbHZhbCA6IGZyb21Ub3AgKTsKCQl9IGVsc2UgewoJCQkvLyByZWx2YWwgPSAtMSAqICh0aGlzVG9wIC0gKGZyb21Ub3AgKyBzY3JlZW5IZWlnaHQpICsgdGhpc0NTU3RvcCArIHRoaXNIZWlnaHQpOwoJCQkvLyBpZiAoIHJlbHZhbCA+IHRoaXNUb3AgKSB7IHJlbHZhbCA9IDA7IH0KCQkJcmVsdmFsID0gZnJvbVRvcCArIHNjcmVlbkhlaWdodCAtIHRoaXNIZWlnaHQgLSAodGhpc1RvcCAtIHRoaXNDU1N0b3AgKTsKCgkJCXJldHVybiBlbC5jc3MoICJ0b3AiLCB1c2VSZWxhdGl2ZSA/IHJlbHZhbCA6IGZyb21Ub3AgKyBzY3JlZW5IZWlnaHQgLSB0aGlzSGVpZ2h0ICk7CgkJfQoJfQoKCS8vIEV4cG9zZWQgbWV0aG9kcwoJcmV0dXJuIHsKCgkJc2hvdzogZnVuY3Rpb24oIGltbWVkaWF0ZWx5LCBwYWdlICkgewoKCQkJJC5tb2JpbGUuZml4ZWRUb29sYmFycy5jbGVhclNob3dUaW1lcigpOwoKCQkJY3VycmVudHN0YXRlID0gIm92ZXJsYXkiOwoKCQkJdmFyICRhcCA9IHBhZ2UgPyAkKCBwYWdlICkgOgoJCQkJCSggJC5tb2JpbGUuYWN0aXZlUGFnZSA/ICQubW9iaWxlLmFjdGl2ZVBhZ2UgOgoJCQkJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApICk7CgoJCQlyZXR1cm4gJGFwLmNoaWxkcmVuKCB0b29sYmFyU2VsZWN0b3IgKS5lYWNoKGZ1bmN0aW9uKCkgewoKCQkJCXZhciBlbCA9ICQoIHRoaXMgKSwKCQkJCQlmcm9tVG9wID0gJCggd2luZG93ICkuc2Nyb2xsVG9wKCksCgkJCQkJLy8gZWwub2Zmc2V0KCkudG9wIHJldHVybnMgdGhlIHdyb25nIHZhbHVlIG9uIGlQYWQgaU9TIDMuMi4xLCBjYWxsIG91ciB3b3JrYXJvdW5kIGluc3RlYWQuCgkJCQkJdGhpc1RvcCA9IGdldE9mZnNldFRvcCggZWxbIDAgXSApLAoJCQkJCXNjcmVlbkhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCwKCQkJCQl0aGlzSGVpZ2h0ID0gZWwub3V0ZXJIZWlnaHQoKSwKCQkJCQlhbHJlYWR5VmlzaWJsZSA9ICggZWwuaXMoICIudWktaGVhZGVyLWZpeGVkIiApICYmIGZyb21Ub3AgPD0gdGhpc1RvcCArIHRoaXNIZWlnaHQgKSB8fAoJCQkJCQkJCQkJCQkJCSggZWwuaXMoICIudWktZm9vdGVyLWZpeGVkIiApICYmIHRoaXNUb3AgPD0gZnJvbVRvcCArIHNjcmVlbkhlaWdodCApOwoKCQkJCS8vIEFkZCBzdGF0ZSBjbGFzcwoJCQkJZWwuYWRkQ2xhc3MoICJ1aS1maXhlZC1vdmVybGF5IiApLnJlbW92ZUNsYXNzKCAidWktZml4ZWQtaW5saW5lIiApOwoKCQkJCWlmICggIWFscmVhZHlWaXNpYmxlICYmICFpbW1lZGlhdGVseSApIHsKCQkJCQllbC5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbigpIHsKCQkJCQkJZWwucmVtb3ZlQ2xhc3MoICJpbiIgKTsKCQkJCQl9KS5hZGRDbGFzcyggImluIiApOwoJCQkJfQoJCQkJc2V0VG9wKGVsKTsKCQkJfSk7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oIGltbWVkaWF0ZWx5ICkgewoKCQkJY3VycmVudHN0YXRlID0gImlubGluZSI7CgoJCQl2YXIgJGFwID0gJC5tb2JpbGUuYWN0aXZlUGFnZSA/ICQubW9iaWxlLmFjdGl2ZVBhZ2UgOgoJCQkJCQkJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApOwoKCQkJcmV0dXJuICRhcC5jaGlsZHJlbiggdG9vbGJhclNlbGVjdG9yICkuZWFjaChmdW5jdGlvbigpIHsKCgkJCQl2YXIgZWwgPSAkKHRoaXMpLAoJCQkJCXRoaXNDU1N0b3AgPSBlbC5jc3MoICJ0b3AiICksCgkJCQkJY2xhc3NlczsKCgkJCQl0aGlzQ1NTdG9wID0gdGhpc0NTU3RvcCA9PSAiYXV0byIgPyAwIDoKCQkJCQkJCQkJCQlwYXJzZUZsb2F0KHRoaXNDU1N0b3ApOwoKCQkJCS8vIEFkZCBzdGF0ZSBjbGFzcwoJCQkJZWwuYWRkQ2xhc3MoICJ1aS1maXhlZC1pbmxpbmUiICkucmVtb3ZlQ2xhc3MoICJ1aS1maXhlZC1vdmVybGF5IiApOwoKCQkJCWlmICggdGhpc0NTU3RvcCA8IDAgfHwgKCBlbC5pcyggIi51aS1oZWFkZXItZml4ZWQiICkgJiYgdGhpc0NTU3RvcCAhPT0gMCApICkgewoKCQkJCQlpZiAoIGltbWVkaWF0ZWx5ICkgewoJCQkJCQllbC5jc3MoICJ0b3AiLCAwKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJaWYgKCBlbC5jc3MoICJ0b3AiICkgIT09ICJhdXRvIiAmJiBwYXJzZUZsb2F0KCBlbC5jc3MoICJ0b3AiICkgKSAhPT0gMCApIHsKCgkJCQkJCQljbGFzc2VzID0gIm91dCByZXZlcnNlIjsKCgkJCQkJCQllbC5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbigpIHsKCQkJCQkJCQllbC5yZW1vdmVDbGFzcyggY2xhc3NlcyApLmNzcyggInRvcCIsIDAgKTsKCQkJCQkJCX0pLmFkZENsYXNzKCBjbGFzc2VzICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0sCgoJCXN0YXJ0U2hvd1RpbWVyOiBmdW5jdGlvbigpIHsKCgkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuY2xlYXJTaG93VGltZXIoKTsKCgkJCXZhciBhcmdzID0gW10uc2xpY2UuY2FsbCggYXJndW1lbnRzICk7CgoJCQlkZWxheVRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCWRlbGF5VGltZXIgPSB1bmRlZmluZWQ7CgkJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLnNob3cuYXBwbHkoIG51bGwsIGFyZ3MgKTsKCQkJfSwgc2hvd0RlbGF5KTsKCQl9LAoKCQljbGVhclNob3dUaW1lcjogZnVuY3Rpb24oKSB7CgkJCWlmICggZGVsYXlUaW1lciApIHsKCQkJCWNsZWFyVGltZW91dCggZGVsYXlUaW1lciApOwoJCQl9CgkJCWRlbGF5VGltZXIgPSB1bmRlZmluZWQ7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbiggZnJvbSApIHsKCQkJaWYgKCBmcm9tICkgewoJCQkJY3VycmVudHN0YXRlID0gZnJvbTsKCQkJfQoJCQlyZXR1cm4gKCBjdXJyZW50c3RhdGUgPT09ICJvdmVybGF5IiApID8gJC5tb2JpbGUuZml4ZWRUb29sYmFycy5oaWRlKCkgOgoJCQkJCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuc2hvdygpOwoJCX0sCgoJCXNldFRvdWNoVG9nZ2xlRW5hYmxlZDogZnVuY3Rpb24oIGVuYWJsZWQgKSB7CgkJCXRvdWNoVG9nZ2xlRW5hYmxlZCA9IGVuYWJsZWQ7CgkJfQoJfTsKfSkoKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCglpZiAoICQoICI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIsIGV2ZW50LnRhcmdldCApLmxlbmd0aCApIHsKCgkJJCggZXZlbnQudGFyZ2V0ICkuZWFjaChmdW5jdGlvbigpIHsKCgkJCWlmICggISQuc3VwcG9ydC5zY3JvbGxUb3AgfHwgKCAkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyAmJiAkLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZCApICkgewoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmICggJHRoaXMuanFtRGF0YSggImZ1bGxzY3JlZW4iICkgKSB7CgkJCQkkdGhpcy5hZGRDbGFzcyggInVpLXBhZ2UtZnVsbHNjcmVlbiIgKTsKCQkJfQoKCQkJLy8gU2hvdWxkIGJlIHNsaWRlZG93bgoJCQkkdGhpcy5maW5kKCBzbGlkZURvd25TZWxlY3RvciApLmFkZENsYXNzKCBzbGlkZURvd25DbGFzcyApOwoKCQkJLy8gU2hvdWxkIGJlIHNsaWRldXAKCQkJJHRoaXMuZmluZCggc2xpZGVVcFNlbGVjdG9yICkuYWRkQ2xhc3MoIHNsaWRlVXBDbGFzcyApOwoKCQl9KQoKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7Ci8qCiogImZpeEhlYWRlckZvb3RlciIgbmF0aXZlIHBsdWdpbiAtIEJlaGF2aW9yIGZvciAiZml4ZWQiIGhlYWRlcnMsZm9vdGVycywgYW5kIHNjcm9sbGluZyBpbm5lciBjb250ZW50CiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIEVuYWJsZSB0b3VjaCBvdmVyZmxvdyBzY3JvbGxpbmcgd2hlbiBpdCdzIG5hdGl2ZWx5IHN1cHBvcnRlZAokLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZCA9IGZhbHNlOwoKLy8gRW5hYmxlZCB6b29tIHdoZW4gdG91Y2ggb3ZlcmZsb3cgaXMgZW5hYmxlZC4gQ2FuIGNhdXNlIHVzYWJpbGl0eSBpc3N1ZXMsIHVuZm9ydHVuYXRlbHkKJC5tb2JpbGUudG91Y2hPdmVyZmxvd1pvb21FbmFibGVkID0gZmFsc2U7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJaWYoICQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICYmICQubW9iaWxlLnRvdWNoT3ZlcmZsb3dFbmFibGVkICl7CgkJCgkJdmFyICR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJc2Nyb2xsU3RhcnRZID0gMDsKCQkJCgkJaWYoICR0YXJnZXQuaXMoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICkgKXsKCQkJCgkJCSR0YXJnZXQuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkcGFnZSA9ICQoIHRoaXMgKSwKCQkJCQkkZml4aWVzID0gJHBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpLCA6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKS5maWx0ZXIoICI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIgKSwKCQkJCQlmdWxsU2NyZWVuID0gJHBhZ2UuanFtRGF0YSggImZ1bGxzY3JlZW4iICksCgkJCQkJJHNjcm9sbEVsZW0gPSAkZml4aWVzLmxlbmd0aCA/ICRwYWdlLmZpbmQoICIudWktY29udGVudCIgKSA6ICRwYWdlOwoJCQkJCgkJCQkkcGFnZS5hZGRDbGFzcyggInVpLW1vYmlsZS10b3VjaC1vdmVyZmxvdyIgKTsKCQkJCQoJCQkJJHNjcm9sbEVsZW0uYmluZCggInNjcm9sbHN0b3AiLCBmdW5jdGlvbigpewoJCQkJCWlmKCAkc2Nyb2xsRWxlbS5zY3JvbGxUb3AoKSA+IDAgKXsKCQkJCQkJd2luZG93LnNjcm9sbFRvKCAwLCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApOwoJCQkJCX0KCQkJCX0pOwkKCQkJCQoJCQkJaWYoICRmaXhpZXMubGVuZ3RoICl7CgkJCQkJCgkJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1uYXRpdmUtZml4ZWQiICk7CgkJCQkJCgkJCQkJaWYoIGZ1bGxTY3JlZW4gKXsKCgkJCQkJCSRwYWdlLmFkZENsYXNzKCAidWktbmF0aXZlLWZ1bGxzY3JlZW4iICk7CgoJCQkJCQkkZml4aWVzLmFkZENsYXNzKCAiZmFkZSBpbiIgKTsKCgkJCQkJCSQoIGRvY3VtZW50ICkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCl7CgkJCQkJCQkkZml4aWVzCgkJCQkJCQkJLnJlbW92ZUNsYXNzKCAidWktbmF0aXZlLWJhcnMtaGlkZGVuIiApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAiaW4gb3V0IiApCgkJCQkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uKCl7CgkJCQkJCQkJCSQodGhpcykubm90KCAiLmluIiApLmFkZENsYXNzKCAidWktbmF0aXZlLWJhcnMtaGlkZGVuIiApOwoJCQkJCQkJCX0pOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7Ci8qCiogImluaXQiIC0gSW5pdGlhbGl6ZSB0aGUgZnJhbWV3b3JrCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJCSRoZWFkID0gJCggImhlYWQiICksCgkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCiAJLy8gdHJpZ2dlciBtb2JpbGVpbml0IGV2ZW50IC0gdXNlZnVsIGhvb2sgZm9yIGNvbmZpZ3VyaW5nICQubW9iaWxlIHNldHRpbmdzIGJlZm9yZSB0aGV5J3JlIHVzZWQKCSQoIHdpbmRvdy5kb2N1bWVudCApLnRyaWdnZXIoICJtb2JpbGVpbml0IiApOwoKCS8vIHN1cHBvcnQgY29uZGl0aW9ucwoJLy8gaWYgZGV2aWNlIHN1cHBvcnQgY29uZGl0aW9uKHMpIGFyZW4ndCBtZXQsIGxlYXZlIHRoaW5ncyBhcyB0aGV5IGFyZSAtPiBhIGJhc2ljLCB1c2FibGUgZXhwZXJpZW5jZSwKCS8vIG90aGVyd2lzZSwgcHJvY2VlZCB3aXRoIHRoZSBlbmhhbmNlbWVudHMKCWlmICggISQubW9iaWxlLmdyYWRlQSgpICkgewoJCXJldHVybjsKCX0KCgkvLyBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzCgkvLyBvciBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChCQjUsIE9wZXJhIE1pbmkpCglpZiAoICQubW9iaWxlLmFqYXhCbGFja2xpc3QgKSB7CgkJJC5tb2JpbGUuYWpheEVuYWJsZWQgPSBmYWxzZTsKCX0KCgkvLyBhZGQgbW9iaWxlLCBpbml0aWFsIGxvYWQgInJlbmRlcmluZyIgY2xhc3NlcyB0byBkb2NFbAoJJGh0bWwuYWRkQ2xhc3MoICJ1aS1tb2JpbGUgdWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCgkvLyBsb2FkaW5nIGRpdiB3aGljaCBhcHBlYXJzIGR1cmluZyBBamF4IHJlcXVlc3RzCgkvLyB3aWxsIG5vdCBhcHBlYXIgaWYgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgaXMgZmFsc2UKCXZhciAkbG9hZGVyID0gJCggIjxkaXYgY2xhc3M9J3VpLWxvYWRlciB1aS1ib2R5LWEgdWktY29ybmVyLWFsbCc+PHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi1sb2FkaW5nIHNwaW4nPjwvc3Bhbj48aDE+PC9oMT48L2Rpdj4iICk7CgoJJC5leHRlbmQoJC5tb2JpbGUsIHsKCQkvLyB0dXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4KCQlzaG93UGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICkgewoJCQkJdmFyIGFjdGl2ZUJ0biA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZmlyc3QoKTsKCgkJCQkkbG9hZGVyCgkJCQkJLmZpbmQoICJoMSIgKQoJCQkJCQkudGV4dCggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgKQoJCQkJCQkuZW5kKCkKCQkJCQkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKQoJCQkJCS8vIHBvc2l0aW9uIGF0IHkgY2VudGVyIChpZiBzY3JvbGxUb3Agc3VwcG9ydGVkKSwgYWJvdmUgdGhlIGFjdGl2ZUJ0biAoaWYgZGVmaW5lZCksIG9yIGp1c3QgMTAwcHggZnJvbSB0b3AKCQkJCQkuY3NzKHsKCQkJCQkJdG9wOiAkLnN1cHBvcnQuc2Nyb2xsVG9wICYmICR3aW5kb3cuc2Nyb2xsVG9wKCkgKyAkd2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJCQlhY3RpdmVCdG4ubGVuZ3RoICYmIGFjdGl2ZUJ0bi5vZmZzZXQoKS50b3AgfHwgMTAwCgkJCQkJfSk7CgkJCX0KCgkJCSRodG1sLmFkZENsYXNzKCAidWktbG9hZGluZyIgKTsKCQl9LAoKCQloaWRlUGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCkgewoJCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLWxvYWRpbmciICk7CgkJfSwKCgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKTsKCgkJCS8vIGlmIG5vIHBhZ2VzIGFyZSBmb3VuZCwgY3JlYXRlIG9uZSB3aXRoIGJvZHkncyBpbm5lciBodG1sCgkJCWlmICggISRwYWdlcy5sZW5ndGggKSB7CgkJCQkkcGFnZXMgPSAkKCAiYm9keSIgKS53cmFwSW5uZXIoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPjwvZGl2PiIgKS5jaGlsZHJlbiggMCApOwoJCQl9CgoJCQkvLyBhZGQgZGlhbG9ncywgc2V0IGRhdGEtdXJsIGF0dHJzCgkJCSRwYWdlcy5hZGQoICI6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCh0aGlzKTsKCgkJCQkvLyB1bmxlc3MgdGhlIGRhdGEgdXJsIGlzIGFscmVhZHkgc2V0IHNldCBpdCB0byB0aGUgcGF0aG5hbWUKCQkJCWlmICggISR0aGlzLmpxbURhdGEoInVybCIpICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICRwYWdlcy5maXJzdCgpLnBhcmVudCgpLmFkZENsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0IiApOwoKCQkJLy8gYWxlcnQgbGlzdGVuZXJzIHRoYXQgdGhlIHBhZ2Vjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCBmb3IgYmluZGluZwoJCQkvLyB0byBldmVudHMgdHJpZ2dlcmVkIG9uIGl0CgkJCSR3aW5kb3cudHJpZ2dlciggInBhZ2Vjb250YWluZXJjcmVhdGUiICk7CgoJCQkvLyBjdWUgcGFnZSBsb2FkaW5nIG1lc3NhZ2UKCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCBvciB0aGVyZSdzIG5vIGhhc2ggZGVlcGxpbmssIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCWlmICggISQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkIHx8ICEkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggbG9jYXRpb24uaGFzaCApICkgewoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7IHRyYW5zaXRpb246ICJub25lIiwgcmV2ZXJzZTogdHJ1ZSwgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCQkvLyBvdGhlcndpc2UsIHRyaWdnZXIgYSBoYXNoY2hhbmdlIHRvIGxvYWQgYSBkZWVwbGluawoJCQllbHNlIHsKCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbIHRydWUgXSApOwoJCQl9CgkJfQoJfSk7CgkKCS8vIFRoaXMgZnVuY3Rpb24gaW5qZWN0cyBhIG1ldGEgdmlld3BvcnQgdGFnIHRvIHByZXZlbnQgc2NhbGluZy4gT2ZmIGJ5IGRlZmF1bHQsIG9uIGJ5IGRlZmF1bHQgd2hlbiB0b3VjaE92ZXJmbG93IHNjcm9sbGluZyBpcyBlbmFibGVkCglmdW5jdGlvbiBkaXNhYmxlWm9vbSgpIHsKCQl2YXIgY29udCA9ICJ1c2VyLXNjYWxhYmxlPW5vIiwKCQkJbWV0YSA9ICQoICJtZXRhW25hbWU9J3ZpZXdwb3J0J10iICk7CgkJCQoJCWlmKCBtZXRhLmxlbmd0aCApewoJCQltZXRhLmF0dHIoICJjb250ZW50IiwgbWV0YS5hdHRyKCAiY29udGVudCIgKSArICIsICIgKyBjb250ICk7CgkJfQoJCWVsc2V7CgkJCSQoICJoZWFkIiApLnByZXBlbmQoICI8bWV0YT4iLCB7ICJuYW1lIjogInZpZXdwb3J0IiwgImNvbnRlbnQiOiBjb250IH0gKTsKCQl9Cgl9CgkKCS8vIGlmIHRvdWNoLW92ZXJmbG93IGlzIGVuYWJsZWQsIGRpc2FibGUgdXNlciBzY2FsaW5nLCBhcyBpdCBjcmVhdGVzIHVzYWJpbGl0eSBpc3N1ZXMKCWlmKCAkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyAmJiAkLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZCAmJiAhJC5tb2JpbGUudG91Y2hPdmVyZmxvd1pvb21FbmFibGVkICl7CgkJZGlzYWJsZVpvb20oKTsKCX0KCgkvLyBpbml0aWFsaXplIGV2ZW50cyBub3csIGFmdGVyIG1vYmlsZWluaXQgaGFzIG9jY3VycmVkCgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cygpOwoKCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJLy8gdGhlbiBjaGVjayB3aGF0IHRoZSBzY3JvbGwgdG9wIGlzLiBBbmRyb2lkIHdpbGwgcmVwb3J0IDAuLi4gb3RoZXJzIDEKCS8vIG5vdGUgdGhhdCB0aGlzIGluaXRpYWwgc2Nyb2xsIHdvbid0IGhpZGUgdGhlIGFkZHJlc3MgYmFyLiBJdCdzIGp1c3QgZm9yIHRoZSBjaGVjay4KCSQoZnVuY3Rpb24oKSB7CgkJd2luZG93LnNjcm9sbFRvKCAwLCAxICk7CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkKHdpbmRvdykuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmKCAkLm1vYmlsZS5hdXRvSW5pdGlhbGl6ZVBhZ2UgKXsKCQkJJC5tb2JpbGUuaW5pdGlhbGl6ZVBhZ2UoKTsKCQl9CgoJCS8vIHdpbmRvdyBsb2FkIGV2ZW50CgkJLy8gaGlkZSBpT1MgYnJvd3NlciBjaHJvbWUgb24gbG9hZAoJCSR3aW5kb3cubG9hZCggJC5tb2JpbGUuc2lsZW50U2Nyb2xsICk7Cgl9KTsKfSkoIGpRdWVyeSwgdGhpcyApOwo=",
                "body": "LyoKKiBqUXVlcnkgTW9iaWxlIEZyYW1ld29yayAxLjAKKiBodHRwOi8vanF1ZXJ5bW9iaWxlLmNvbQoqCiogQ29weXJpZ2h0IDIwMTEgKGMpIGpRdWVyeSBQcm9qZWN0CiogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IEBWRVJTSU9OCiAqCiAqIENvcHlyaWdodCAyMDEwLCBBVVRIT1JTLnR4dCAoaHR0cDovL2pxdWVyeXVpLmNvbS9hYm91dCkKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIG9yIEdQTCBWZXJzaW9uIDIgbGljZW5zZXMuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2RvY3MuanF1ZXJ5LmNvbS9VSS9XaWRnZXQKICovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIGpRdWVyeSAxLjQrCmlmICggJC5jbGVhbkRhdGEgKSB7Cgl2YXIgX2NsZWFuRGF0YSA9ICQuY2xlYW5EYXRhOwoJJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7CgkJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCSQoIGVsZW0gKS50cmlnZ2VySGFuZGxlciggInJlbW92ZSIgKTsKCQl9CgkJX2NsZWFuRGF0YSggZWxlbXMgKTsKCX07Cn0gZWxzZSB7Cgl2YXIgX3JlbW92ZSA9ICQuZm4ucmVtb3ZlOwoJJC5mbi5yZW1vdmUgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGtlZXBEYXRhICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggIWtlZXBEYXRhICkgewoJCQkJaWYgKCAhc2VsZWN0b3IgfHwgJC5maWx0ZXIoIHNlbGVjdG9yLCBbIHRoaXMgXSApLmxlbmd0aCApIHsKCQkJCQkkKCAiKiIsIHRoaXMgKS5hZGQoIFsgdGhpcyBdICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkJJCggdGhpcyApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJCXJldHVybiBfcmVtb3ZlLmNhbGwoICQodGhpcyksIHNlbGVjdG9yLCBrZWVwRGF0YSApOwoJCX0pOwoJfTsKfQoKJC53aWRnZXQgPSBmdW5jdGlvbiggbmFtZSwgYmFzZSwgcHJvdG90eXBlICkgewoJdmFyIG5hbWVzcGFjZSA9IG5hbWUuc3BsaXQoICIuIiApWyAwIF0sCgkJZnVsbE5hbWU7CgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsKCWZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJLy8gY3JlYXRlIHNlbGVjdG9yIGZvciBwbHVnaW4KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG5hbWUgKTsKCX07CgoJJFsgbmFtZXNwYWNlIF0gPSAkWyBuYW1lc3BhY2UgXSB8fCB7fTsKCSRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXRoaXMuX2NyZWF0ZVdpZGdldCggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCX07CgoJdmFyIGJhc2VQcm90b3R5cGUgPSBuZXcgYmFzZSgpOwoJLy8gd2UgbmVlZCB0byBtYWtlIHRoZSBvcHRpb25zIGhhc2ggYSBwcm9wZXJ0eSBkaXJlY3RseSBvbiB0aGUgbmV3IGluc3RhbmNlCgkvLyBvdGhlcndpc2Ugd2UnbGwgbW9kaWZ5IHRoZSBvcHRpb25zIGhhc2ggb24gdGhlIHByb3RvdHlwZSB0aGF0IHdlJ3JlCgkvLyBpbmhlcml0aW5nIGZyb20KLy8JJC5lYWNoKCBiYXNlUHJvdG90eXBlLCBmdW5jdGlvbigga2V5LCB2YWwgKSB7Ci8vCQlpZiAoICQuaXNQbGFpbk9iamVjdCh2YWwpICkgewovLwkJCWJhc2VQcm90b3R5cGVbIGtleSBdID0gJC5leHRlbmQoIHt9LCB2YWwgKTsKLy8JCX0KLy8JfSk7CgliYXNlUHJvdG90eXBlLm9wdGlvbnMgPSAkLmV4dGVuZCggdHJ1ZSwge30sIGJhc2VQcm90b3R5cGUub3B0aW9ucyApOwoJJFsgbmFtZXNwYWNlIF1bIG5hbWUgXS5wcm90b3R5cGUgPSAkLmV4dGVuZCggdHJ1ZSwgYmFzZVByb3RvdHlwZSwgewoJCW5hbWVzcGFjZTogbmFtZXNwYWNlLAoJCXdpZGdldE5hbWU6IG5hbWUsCgkJd2lkZ2V0RXZlbnRQcmVmaXg6ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0ucHJvdG90eXBlLndpZGdldEV2ZW50UHJlZml4IHx8IG5hbWUsCgkJd2lkZ2V0QmFzZUNsYXNzOiBmdWxsTmFtZQoJfSwgcHJvdG90eXBlICk7CgoJJC53aWRnZXQuYnJpZGdlKCBuYW1lLCAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdICk7Cn07CgokLndpZGdldC5icmlkZ2UgPSBmdW5jdGlvbiggbmFtZSwgb2JqZWN0ICkgewoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlzTWV0aG9kQ2FsbCA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiwKCQkJYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwKCQkJcmV0dXJuVmFsdWUgPSB0aGlzOwoKCQkvLyBhbGxvdyBtdWx0aXBsZSBoYXNoZXMgdG8gYmUgcGFzc2VkIG9uIGluaXQKCQlvcHRpb25zID0gIWlzTWV0aG9kQ2FsbCAmJiBhcmdzLmxlbmd0aCA/CgkJCSQuZXh0ZW5kLmFwcGx5KCBudWxsLCBbIHRydWUsIG9wdGlvbnMgXS5jb25jYXQoYXJncykgKSA6CgkJCW9wdGlvbnM7CgoJCS8vIHByZXZlbnQgY2FsbHMgdG8gaW50ZXJuYWwgbWV0aG9kcwoJCWlmICggaXNNZXRob2RDYWxsICYmIG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCX0KCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgbmFtZSApOwoJCQkJaWYgKCAhaW5zdGFuY2UgKSB7CgkJCQkJdGhyb3cgImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKyAiIHByaW9yIHRvIGluaXRpYWxpemF0aW9uOyAiICsKCQkJCQkJImF0dGVtcHRlZCB0byBjYWxsIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyI7CgkJCQl9CgkJCQlpZiAoICEkLmlzRnVuY3Rpb24oIGluc3RhbmNlW29wdGlvbnNdICkgKSB7CgkJCQkJdGhyb3cgIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIjsKCQkJCX0KCQkJCXZhciBtZXRob2RWYWx1ZSA9IGluc3RhbmNlWyBvcHRpb25zIF0uYXBwbHkoIGluc3RhbmNlLCBhcmdzICk7CgkJCQlpZiAoIG1ldGhvZFZhbHVlICE9PSBpbnN0YW5jZSAmJiBtZXRob2RWYWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVyblZhbHVlID0gbWV0aG9kVmFsdWU7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIG5hbWUgKTsKCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICkuX2luaXQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJJC5kYXRhKCB0aGlzLCBuYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCXRoaXMuX2NyZWF0ZVdpZGdldCggb3B0aW9ucywgZWxlbWVudCApOwoJfQp9OwoKJC5XaWRnZXQucHJvdG90eXBlID0gewoJd2lkZ2V0TmFtZTogIndpZGdldCIsCgl3aWRnZXRFdmVudFByZWZpeDogIiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlCgl9LAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJLy8gJC53aWRnZXQuYnJpZGdlIHN0b3JlcyB0aGUgcGx1Z2luIGluc3RhbmNlLCBidXQgd2UgZG8gaXQgYW55d2F5CgkJLy8gc28gdGhhdCBpdCdzIHN0b3JlZCBldmVuIGJlZm9yZSB0aGUgX2NyZWF0ZSBmdW5jdGlvbiBydW5zCgkJJC5kYXRhKCBlbGVtZW50LCB0aGlzLndpZGdldE5hbWUsIHRoaXMgKTsKCQl0aGlzLmVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJdGhpcy5vcHRpb25zID0gJC5leHRlbmQoIHRydWUsIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl2YXIgc2VsZiA9IHRoaXM7CgkJdGhpcy5lbGVtZW50LmJpbmQoICJyZW1vdmUuIiArIHRoaXMud2lkZ2V0TmFtZSwgZnVuY3Rpb24oKSB7CgkJCXNlbGYuZGVzdHJveSgpOwoJCX0pOwoKCQl0aGlzLl9jcmVhdGUoKTsKCQl0aGlzLl90cmlnZ2VyKCAiY3JlYXRlIiApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB7fTsKCQlpZiAoICQubWV0YWRhdGEgKSB7CgkJCW9wdGlvbnMgPSAkLm1ldGFkYXRhLmdldCggZWxlbWVudCApWyB0aGlzLndpZGdldE5hbWUgXTsKCQl9CgkJcmV0dXJuIG9wdGlvbnM7Cgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7fSwKCV9pbml0OiBmdW5jdGlvbigpIHt9LAoKCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudAoJCQkudW5iaW5kKCAiLiIgKyB0aGlzLndpZGdldE5hbWUgKQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXROYW1lICk7CgkJdGhpcy53aWRnZXQoKQoJCQkudW5iaW5kKCAiLiIgKyB0aGlzLndpZGdldE5hbWUgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRCYXNlQ2xhc3MgKyAiLWRpc2FibGVkICIgKwoJCQkJInVpLXN0YXRlLWRpc2FibGVkIiApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucyApOwoJCX0KCgkJaWYgICh0eXBlb2Yga2V5ID09PSAic3RyaW5nIiApIHsKCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF07CgkJCX0KCQkJb3B0aW9ucyA9IHt9OwoJCQlvcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCSQuZWFjaCggb3B0aW9ucywgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCXNlbGYuX3NldE9wdGlvbigga2V5LCB2YWx1ZSApOwoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzLndpZGdldCgpCgkJCQlbIHZhbHVlID8gImFkZENsYXNzIiA6ICJyZW1vdmVDbGFzcyJdKAoJCQkJCXRoaXMud2lkZ2V0QmFzZUNsYXNzICsgIi1kaXNhYmxlZCIgKyAiICIgKwoJCQkJCSJ1aS1zdGF0ZS1kaXNhYmxlZCIgKQoJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglfdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGV2ZW50LCBkYXRhICkgewoJCXZhciBjYWxsYmFjayA9IHRoaXMub3B0aW9uc1sgdHlwZSBdOwoKCQlldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CgkJZXZlbnQudHlwZSA9ICggdHlwZSA9PT0gdGhpcy53aWRnZXRFdmVudFByZWZpeCA/CgkJCXR5cGUgOgoJCQl0aGlzLndpZGdldEV2ZW50UHJlZml4ICsgdHlwZSApLnRvTG93ZXJDYXNlKCk7CgkJZGF0YSA9IGRhdGEgfHwge307CgoJCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQkvLyB0aGlzIHdvdWxkIGhhcHBlbiBpZiB3ZSBjb3VsZCBjYWxsICQuZXZlbnQuZml4IGluc3RlYWQgb2YgJC5FdmVudAoJCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCgkJaWYgKCBldmVudC5vcmlnaW5hbEV2ZW50ICkgewoJCQlmb3IgKCB2YXIgaSA9ICQuZXZlbnQucHJvcHMubGVuZ3RoLCBwcm9wOyBpOyApIHsKCQkJCXByb3AgPSAkLmV2ZW50LnByb3BzWyAtLWkgXTsKCQkJCWV2ZW50WyBwcm9wIF0gPSBldmVudC5vcmlnaW5hbEV2ZW50WyBwcm9wIF07CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoKCQlyZXR1cm4gISggJC5pc0Z1bmN0aW9uKGNhbGxiYWNrKSAmJgoJCQljYWxsYmFjay5jYWxsKCB0aGlzLmVsZW1lbnRbMF0sIGV2ZW50LCBkYXRhICkgPT09IGZhbHNlIHx8CgkJCWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7Ci8qCiogd2lkZ2V0IGZhY3RvcnkgZXh0ZW50aW9ucyBmb3IgbW9iaWxlCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLndpZGdldCIsIHsKCS8vIGRlY29yYXRlIHRoZSBwYXJlbnQgX2NyZWF0ZVdpZGdldCB0byB0cmlnZ2VyIGB3aWRnZXRpbml0YCBmb3IgdXNlcnMKCS8vIHdobyB3aXNoIHRvIGRvIHBvc3QgcG9zdCBgd2lkZ2V0Y3JlYXRlYCBhbHRlcmF0aW9ucy9hZGRpdGlvbnMKCS8vCgkvLyBUT0RPIGNyZWF0ZSBhIHB1bGwgcmVxdWVzdCBmb3IganF1ZXJ5IHVpIHRvIHRyaWdnZXIgdGhpcyBldmVudAoJLy8gaW4gdGhlIG9yaWdpbmFsIF9jcmVhdGVXaWRnZXQKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fY3JlYXRlV2lkZ2V0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl90cmlnZ2VyKCAnaW5pdCcgKTsKCX0sCgoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0aW9ucyA9IHt9OwoKCQkkLmVhY2goIHRoaXMub3B0aW9ucywgZnVuY3Rpb24oIG9wdGlvbiApIHsKCgkJCXZhciB2YWx1ZSA9IGVsZW0uanFtRGF0YSggb3B0aW9uLnJlcGxhY2UoIC9bQS1aXS9nLCBmdW5jdGlvbiggYyApIHsKCQkJCQkJCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7CgkJCQkJCX0pCgkJCQkJKTsKCgkJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCW9wdGlvbnNbIG9wdGlvbiBdID0gdmFsdWU7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIG9wdGlvbnM7Cgl9LAoKCWVuaGFuY2VXaXRoaW46IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkJLy8gVE9ETyByZW1vdmUgZGVwZW5kZW5jeSBvbiB0aGUgcGFnZSB3aWRnZXQgZm9yIHRoZSBrZWVwTmF0aXZlLgoJCS8vIEN1cnJlbnRseSB0aGUga2VlcE5hdGl2ZSB2YWx1ZSBpcyBkZWZpbmVkIG9uIHRoZSBwYWdlIHByb3RvdHlwZSBzbwoJCS8vIHRoZSBtZXRob2QgaXMgYXMgd2VsbAoJCXZhciBwYWdlID0gJCh0YXJnZXQpLmNsb3Nlc3QoIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIpLmRhdGEoICJwYWdlIiApLAoJCQlrZWVwTmF0aXZlID0gKHBhZ2UgJiYgcGFnZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSkgfHwgIiI7CgoJCSQoIHRoaXMub3B0aW9ucy5pbml0U2VsZWN0b3IsIHRhcmdldCApLm5vdCgga2VlcE5hdGl2ZSApWyB0aGlzLndpZGdldE5hbWUgXSgpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiBhIHdvcmthcm91bmQgZm9yIHdpbmRvdy5tYXRjaE1lZGlhCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciAkd2luZG93ID0gJCggd2luZG93ICksCgkkaHRtbCA9ICQoICJodG1sIiApOwoKLyogJC5tb2JpbGUubWVkaWEgbWV0aG9kOiBwYXNzIGEgQ1NTIG1lZGlhIHR5cGUgb3IgcXVlcnkgYW5kIGdldCBhIGJvb2wgcmV0dXJuCglub3RlOiB0aGlzIGZlYXR1cmUgcmVsaWVzIG9uIGFjdHVhbCBtZWRpYSBxdWVyeSBzdXBwb3J0IGZvciBtZWRpYSBxdWVyaWVzLCB0aG91Z2ggdHlwZXMgd2lsbCB3b3JrIG1vc3QgYW55d2hlcmUKCWV4YW1wbGVzOgoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4nKSAvLz4+IHRlc3RzIGZvciBzY3JlZW4gbWVkaWEgdHlwZQoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4gYW5kIChtaW4td2lkdGg6IDQ4MHB4KScpIC8vPj4gdGVzdHMgZm9yIHNjcmVlbiBtZWRpYSB0eXBlIHdpdGggd2luZG93IHdpZHRoID4gNDgwcHgKCQkkLm1vYmlsZS5tZWRpYSgnQG1lZGlhIHNjcmVlbiBhbmQgKC13ZWJraXQtbWluLWRldmljZS1waXhlbC1yYXRpbzogMiknKSAvLz4+IHRlc3RzIGZvciB3ZWJraXQgMnggcGl4ZWwgcmF0aW8gKGlQaG9uZSA0KQoqLwokLm1vYmlsZS5tZWRpYSA9IChmdW5jdGlvbigpIHsKCS8vIFRPRE86IHVzZSB3aW5kb3cubWF0Y2hNZWRpYSBvbmNlIGF0IGxlYXN0IG9uZSBVQSBpbXBsZW1lbnRzIGl0Cgl2YXIgY2FjaGUgPSB7fSwKCQl0ZXN0RGl2ID0gJCggIjxkaXYgaWQ9J2pxdWVyeS1tZWRpYXRlc3QnPiIgKSwKCQlmYWtlQm9keSA9ICQoICI8Ym9keT4iICkuYXBwZW5kKCB0ZXN0RGl2ICk7CgoJcmV0dXJuIGZ1bmN0aW9uKCBxdWVyeSApIHsKCQlpZiAoICEoIHF1ZXJ5IGluIGNhY2hlICkgKSB7CgkJCXZhciBzdHlsZUJsb2NrID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInN0eWxlIiApLAoJCQkJY3NzcnVsZSA9ICJAbWVkaWEgIiArIHF1ZXJ5ICsgIiB7ICNqcXVlcnktbWVkaWF0ZXN0IHsgcG9zaXRpb246YWJzb2x1dGU7IH0gfSI7CgoJCQkvL211c3Qgc2V0IHR5cGUgZm9yIElFIQoJCQlzdHlsZUJsb2NrLnR5cGUgPSAidGV4dC9jc3MiOwoKCQkJaWYgKCBzdHlsZUJsb2NrLnN0eWxlU2hlZXQgICl7CgkJCQlzdHlsZUJsb2NrLnN0eWxlU2hlZXQuY3NzVGV4dCA9IGNzc3J1bGU7CgkJCX0gZWxzZSB7CgkJCQlzdHlsZUJsb2NrLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjc3NydWxlKSApOwoJCQl9CgoJCQkkaHRtbC5wcmVwZW5kKCBmYWtlQm9keSApLnByZXBlbmQoIHN0eWxlQmxvY2sgKTsKCQkJY2FjaGVbIHF1ZXJ5IF0gPSB0ZXN0RGl2LmNzcyggInBvc2l0aW9uIiApID09PSAiYWJzb2x1dGUiOwoJCQlmYWtlQm9keS5hZGQoIHN0eWxlQmxvY2sgKS5yZW1vdmUoKTsKCQl9CgkJcmV0dXJuIGNhY2hlWyBxdWVyeSBdOwoJfTsKfSkoKTsKCn0pKGpRdWVyeSk7Ci8qCiogc3VwcG9ydCB0ZXN0cwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgZmFrZUJvZHkgPSAkKCAiPGJvZHk+IiApLnByZXBlbmRUbyggImh0bWwiICksCglmYkNTUyA9IGZha2VCb2R5WyAwIF0uc3R5bGUsCgl2ZW5kb3JzID0gWyAiV2Via2l0IiwgIk1veiIsICJPIiBdLAoJd2Vib3MgPSAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3csIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IHNjcm9sbFRvcAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5OyAvL29ubHkgdXNlZCB0byBydWxlIG91dCBib3ggc2hhZG93LCBhcyBpdCdzIGZpbGxlZCBvcGFxdWUgb24gQkIKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKTsKCglmb3IgKCB2YXIgdiBpbiBwcm9wcyApewoJCWlmICggZmJDU1NbIHByb3BzWyB2IF0gXSAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKCi8vIG5vbi1VQS1iYXNlZCBJRSB2ZXJzaW9uIGNoZWNrIGJ5IEphbWVzIFBhZG9sc2V5LCBtb2RpZmllZCBieSBqZGFsdG9uIC0gZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzUyNzY4MwovLyBhbGxvd3MgZm9yIGluY2x1c2lvbiBvZiBJRSA2KywgaW5jbHVkaW5nIFdpbmRvd3MgTW9iaWxlIDcKJC5tb2JpbGUuYnJvd3NlciA9IHt9OwokLm1vYmlsZS5icm93c2VyLmllID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCWEgPSBkaXYuYWxsIHx8IFtdOwoKCXdoaWxlICggZGl2LmlubmVySFRNTCA9ICI8IS0tW2lmIGd0IElFICIgKyAoICsrdiApICsgIl0+PGJyPjwhW2VuZGlmXS0tPiIsIGFbIDAgXSApOwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCgokLmV4dGVuZCggJC5zdXBwb3J0LCB7CglvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiBpbiB3aW5kb3cgJiYgIm9ub3JpZW50YXRpb25jaGFuZ2UiIGluIHdpbmRvdywKCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQsCgljc3NUcmFuc2l0aW9uczogIldlYktpdFRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93LAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmICJyZXBsYWNlU3RhdGUiIGluIGhpc3RvcnksCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJYm94U2hhZG93OiAhIXByb3BFeGlzdHMoICJib3hTaGFkb3ciICkgJiYgIWJiLAoJc2Nyb2xsVG9wOiAoICJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8ICJzY3JvbGxUb3AiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fCAic2Nyb2xsVG9wIiBpbiBmYWtlQm9keVsgMCBdICkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCglkeW5hbWljQmFzZVRhZzogYmFzZVRhZ1Rlc3QoKQp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKdmFyIG5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCl7CgoJdmFyIHVhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7CgoJLy9UaGUgZm9sbG93aW5nIGlzIGFuIGF0dGVtcHQgdG8gbWF0Y2ggTm9raWEgYnJvd3NlcnMgdGhhdCBhcmUgcnVubmluZyBTeW1iaWFuL3M2MCwgd2l0aCB3ZWJraXQsIHZlcnNpb24gNy4zIG9yIG9sZGVyCglyZXR1cm4gdWEuaW5kZXhPZiggIk5va2lhIiApID4gLTEgJiYKCQkJKCB1YS5pbmRleE9mKCAiU3ltYmlhbi8zIiApID4gLTEgfHwgdWEuaW5kZXhPZiggIlNlcmllczYwLzUiICkgPiAtMSApICYmCgkJCXVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICYmCgkJCXVhLm1hdGNoKCAvKEJyb3dzZXJOR3xOb2tpYUJyb3dzZXIpXC83XC5bMC0zXS8gKTsKfSkoKTsKCiQubW9iaWxlLmFqYXhCbGFja2xpc3QgPQoJCQkvLyBCbGFja0JlcnJ5IGJyb3dzZXJzLCBwcmUtd2Via2l0CgkJCXdpbmRvdy5ibGFja2JlcnJ5ICYmICF3aW5kb3cuV2ViS2l0UG9pbnQgfHwKCQkJLy8gT3BlcmEgTWluaQoJCQlvcGVyYW1pbmkgfHwKCQkJLy8gU3ltYmlhbiB3ZWJraXRzIHByZSA3LjMKCQkJbm9raWFMVEU3XzM7CgovLyBMYXN0bHksIHRoaXMgd29ya2Fyb3VuZCBpcyB0aGUgb25seSB3YXkgd2UndmUgZm91bmQgc28gZmFyIHRvIGdldCBwcmUgNy4zIFN5bWJpYW4gd2Via2l0IGRldmljZXMKLy8gdG8gcmVuZGVyIHRoZSBzdHlsZXNoZWV0cyB3aGVuIHRoZXkncmUgcmVmZXJlbmNlZCBiZWZvcmUgdGhpcyBzY3JpcHQsIGFzIHdlJ2QgcmVjb21tZW5kIGRvaW5nLgovLyBUaGlzIHNpbXBseSByZWFwcGVuZHMgdGhlIENTUyBpbiBwbGFjZSwgd2hpY2ggZm9yIHNvbWUgcmVhc29uIG1ha2VzIGl0IGFwcGx5CmlmICggbm9raWFMVEU3XzMgKSB7CgkkKGZ1bmN0aW9uKCkgewoJCSQoICJoZWFkIGxpbmtbcmVsPSdzdHlsZXNoZWV0J10iICkuYXR0ciggInJlbCIsICJhbHRlcm5hdGUgc3R5bGVzaGVldCIgKS5hdHRyKCAicmVsIiwgInN0eWxlc2hlZXQiICk7Cgl9KTsKfQoKLy8gRm9yIHJ1bGluZyBvdXQgc2hhZG93cyB2aWEgY3NzCmlmICggISQuc3VwcG9ydC5ib3hTaGFkb3cgKSB7CgkkKCAiaHRtbCIgKS5hZGRDbGFzcyggInVpLW1vYmlsZS1ub3N1cHBvcnQtYm94c2hhZG93IiApOwp9Cgp9KSggalF1ZXJ5ICk7Ci8qCiogIm1vdXNlIiBwbHVnaW4KKi8KCi8vIFRoaXMgcGx1Z2luIGlzIGFuIGV4cGVyaW1lbnQgZm9yIGFic3RyYWN0aW5nIGF3YXkgdGhlIHRvdWNoIGFuZCBtb3VzZQovLyBldmVudHMgc28gdGhhdCBkZXZlbG9wZXJzIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgd2hpY2ggbWV0aG9kIG9mIGlucHV0Ci8vIHRoZSBkZXZpY2UgdGhlaXIgZG9jdW1lbnQgaXMgbG9hZGVkIG9uIHN1cHBvcnRzLgovLwovLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGFsbG93IHRoZSBkZXZlbG9wZXIgdG8gcmVnaXN0ZXIgbGlzdGVuZXJzIGZvciB0aGUKLy8gYmFzaWMgbW91c2UgZXZlbnRzLCBzdWNoIGFzIG1vdXNlZG93biwgbW91c2Vtb3ZlLCBtb3VzZXVwLCBhbmQgY2xpY2ssCi8vIGFuZCB0aGUgcGx1Z2luIHdpbGwgdGFrZSBjYXJlIG9mIHJlZ2lzdGVyaW5nIHRoZSBjb3JyZWN0IGxpc3RlbmVycwovLyBiZWhpbmQgdGhlIHNjZW5lcyB0byBpbnZva2UgdGhlIGxpc3RlbmVyIGF0IHRoZSBmYXN0ZXN0IHBvc3NpYmxlIHRpbWUKLy8gZm9yIHRoYXQgZGV2aWNlLCB3aGlsZSBzdGlsbCByZXRhaW5pbmcgdGhlIG9yZGVyIG9mIGV2ZW50IGZpcmluZyBpbgovLyB0aGUgdHJhZGl0aW9uYWwgbW91c2UgZW52aXJvbm1lbnQsIHNob3VsZCBtdWx0aXBsZSBoYW5kbGVycyBiZSByZWdpc3RlcmVkCi8vIG9uIHRoZSBzYW1lIGVsZW1lbnQgZm9yIGRpZmZlcmVudCBldmVudHMuCi8vCi8vIFRoZSBjdXJyZW50IHZlcnNpb24gZXhwb3NlcyB0aGUgZm9sbG93aW5nIHZpcnR1YWwgZXZlbnRzIHRvIGpRdWVyeSBiaW5kIG1ldGhvZHM6Ci8vICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIKCihmdW5jdGlvbiggJCwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewoKdmFyIGRhdGFQcm9wZXJ0eU5hbWUgPSAidmlydHVhbE1vdXNlQmluZGluZ3MiLAoJdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgPSAidmlydHVhbFRvdWNoSUQiLAoJdmlydHVhbEV2ZW50TmFtZXMgPSAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiLnNwbGl0KCAiICIgKSwKCXRvdWNoRXZlbnRQcm9wcyA9ICJjbGllbnRYIGNsaWVudFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIi5zcGxpdCggIiAiICksCglhY3RpdmVEb2NIYW5kbGVycyA9IHt9LAoJcmVzZXRUaW1lcklEID0gMCwKCXN0YXJ0WCA9IDAsCglzdGFydFkgPSAwLAoJZGlkU2Nyb2xsID0gZmFsc2UsCgljbGlja0Jsb2NrTGlzdCA9IFtdLAoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2UsCglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZSwKCWV2ZW50Q2FwdHVyZVN1cHBvcnRlZCA9ICJhZGRFdmVudExpc3RlbmVyIiBpbiBkb2N1bWVudCwKCSRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICksCgluZXh0VG91Y2hJRCA9IDEsCglsYXN0VG91Y2hJRCA9IDA7CgokLnZtb3VzZSA9IHsKCW1vdmVEaXN0YW5jZVRocmVzaG9sZDogMTAsCgljbGlja0Rpc3RhbmNlVGhyZXNob2xkOiAxMCwKCXJlc2V0VGltZXJEdXJhdGlvbjogMTUwMAp9OwoKZnVuY3Rpb24gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkgewoKCXdoaWxlICggZXZlbnQgJiYgdHlwZW9mIGV2ZW50Lm9yaWdpbmFsRXZlbnQgIT09ICJ1bmRlZmluZWQiICkgewoJCWV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCX0KCXJldHVybiBldmVudDsKfQoKZnVuY3Rpb24gY3JlYXRlVmlydHVhbEV2ZW50KCBldmVudCwgZXZlbnRUeXBlICkgewoKCXZhciB0ID0gZXZlbnQudHlwZSwKCQlvZSwgcHJvcHMsIG5lLCBwcm9wLCBjdCwgdG91Y2gsIGksIGo7CgoJZXZlbnQgPSAkLkV2ZW50KGV2ZW50KTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgoJb2UgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJcHJvcHMgPSAkLmV2ZW50LnByb3BzOwoKCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCS8vIHRoaXMgd291bGQgaGFwcGVuIGlmIHdlIGNvdWxkIGNhbGwgJC5ldmVudC5maXggaW5zdGVhZCBvZiAkLkV2ZW50CgkvLyBidXQgd2UgZG9uJ3QgaGF2ZSBhIHdheSB0byBmb3JjZSBhbiBldmVudCB0byBiZSBmaXhlZCBtdWx0aXBsZSB0aW1lcwoJaWYgKCBvZSApIHsKCQlmb3IgKCBpID0gcHJvcHMubGVuZ3RoLCBwcm9wOyBpOyApIHsKCQkJcHJvcCA9IHByb3BzWyAtLWkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9lWyBwcm9wIF07CgkJfQoJfQoKCS8vIG1ha2Ugc3VyZSB0aGF0IGlmIHRoZSBtb3VzZSBhbmQgY2xpY2sgdmlydHVhbCBldmVudHMgYXJlIGdlbmVyYXRlZAoJLy8gd2l0aG91dCBhIC53aGljaCBvbmUgaXMgZGVmaW5lZAoJaWYgKCB0LnNlYXJjaCgvbW91c2UoZG93bnx1cCl8Y2xpY2svKSA+IC0xICYmICFldmVudC53aGljaCApewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoY3QgJiYgY3QubGVuZ3RoKSA/IGN0WyAwIF0gOiB1bmRlZmluZWQgKTsKCgkJaWYgKCB0b3VjaCApIHsKCQkJZm9yICggaiA9IDAsIGxlbiA9IHRvdWNoRXZlbnRQcm9wcy5sZW5ndGg7IGogPCBsZW47IGorKyl7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkJcmVzZXRUaW1lcklEID0gMDsKCQllbmFibGVNb3VzZUJpbmRpbmdzKCk7Cgl9LCAkLnZtb3VzZS5yZXNldFRpbWVyRHVyYXRpb24gKTsKfQoKZnVuY3Rpb24gY2xlYXJSZXNldFRpbWVyKCkgewoJaWYgKCByZXNldFRpbWVySUQgKXsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKGV2ZW50LnRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUpOwoKCWlmICggIWJsb2NrTW91c2VUcmlnZ2VycyAmJiAoICFsYXN0VG91Y2hJRCB8fCBsYXN0VG91Y2hJRCAhPT0gdG91Y2hJRCApICl7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInYiICsgZXZlbnQudHlwZSwgZXZlbnQgKTsKCQlpZiAoIHZlICkgewoJCQlpZiAoIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCQlpZiAoIHZlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCQlpZiAoIHZlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydCggZXZlbnQgKSB7CgoJdmFyIHRvdWNoZXMgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzLAoJCXRhcmdldCwgZmxhZ3M7CgoJaWYgKCB0b3VjaGVzICYmIHRvdWNoZXMubGVuZ3RoID09PSAxICkgewoKCQl0YXJnZXQgPSBldmVudC50YXJnZXQ7CgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCB0YXJnZXQgKTsKCgkJaWYgKCBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyApIHsKCgkJCWxhc3RUb3VjaElEID0gbmV4dFRvdWNoSUQrKzsKCQkJJC5kYXRhKCB0YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lLCBsYXN0VG91Y2hJRCApOwoKCQkJY2xlYXJSZXNldFRpbWVyKCk7CgoJCQlkaXNhYmxlTW91c2VCaW5kaW5ncygpOwoJCQlkaWRTY3JvbGwgPSBmYWxzZTsKCgkJCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdOwoJCQlzdGFydFggPSB0LnBhZ2VYOwoJCQlzdGFydFkgPSB0LnBhZ2VZOwoKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW92ZXIiLCBldmVudCwgZmxhZ3MgKTsKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWRvd24iLCBldmVudCwgZmxhZ3MgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVNjcm9sbCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICkgKTsKCX0KCglkaWRTY3JvbGwgPSB0cnVlOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF0sCgkJZGlkQ2FuY2VsID0gZGlkU2Nyb2xsLAoJCW1vdmVUaHJlc2hvbGQgPSAkLnZtb3VzZS5tb3ZlRGlzdGFuY2VUaHJlc2hvbGQ7CgkJZGlkU2Nyb2xsID0gZGlkU2Nyb2xsIHx8CgkJCSggTWF0aC5hYnModC5wYWdlWCAtIHN0YXJ0WCkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyh0LnBhZ2VZIC0gc3RhcnRZKSA+IG1vdmVUaHJlc2hvbGQgKSwKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApOwoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdDsKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2V1cCIsIGV2ZW50LCBmbGFncyApOwoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpe30KCmZ1bmN0aW9uIGdldFNwZWNpYWxFdmVudE9iamVjdCggZXZlbnRUeXBlICkgewoJdmFyIHJlYWxUeXBlID0gZXZlbnRUeXBlLnN1YnN0ciggMSApOwoKCXJldHVybiB7CgkJc2V0dXA6IGZ1bmN0aW9uKCBkYXRhLCBuYW1lc3BhY2UgKSB7CgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhpcyBlbGVtZW50LAoJCQkvLyBhZGQgYSBiaW5kaW5ncyBvYmplY3QgdG8gaXRzIGRhdGEuCgoJCQlpZiAoICFoYXNWaXJ0dWFsQmluZGluZ3MoIHRoaXMgKSApIHsKCQkJCSQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSwge30pOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmIChhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPT09IDEpIHsKCQkJCQkkZG9jdW1lbnQuYmluZCggInRvdWNoc3RhcnQiLCBoYW5kbGVUb3VjaFN0YXJ0ICkKCQkJCQkJLmJpbmQoICJ0b3VjaGVuZCIsIGhhbmRsZVRvdWNoRW5kICkKCgkJCQkJCS8vIE9uIHRvdWNoIHBsYXRmb3JtcywgdG91Y2hpbmcgdGhlIHNjcmVlbiBhbmQgdGhlbiBkcmFnZ2luZyB5b3VyIGZpbmdlcgoJCQkJCQkvLyBjYXVzZXMgdGhlIHdpbmRvdyBjb250ZW50IHRvIHNjcm9sbCBhZnRlciBzb21lIGRpc3RhbmNlIHRocmVzaG9sZCBpcwoJCQkJCQkvLyBleGNlZWRlZC4gT24gdGhlc2UgcGxhdGZvcm1zLCBhIHNjcm9sbCBwcmV2ZW50cyBhIGNsaWNrIGV2ZW50IGZyb20gYmVpbmcKCQkJCQkJLy8gZGlzcGF0Y2hlZCwgYW5kIG9uIHNvbWUgcGxhdGZvcm1zLCBldmVuIHRoZSB0b3VjaGVuZCBpcyBzdXBwcmVzc2VkLiBUbwoJCQkJCQkvLyBtaW1pYyB0aGUgc3VwcHJlc3Npb24gb2YgdGhlIGNsaWNrIGV2ZW50LCB3ZSBuZWVkIHRvIHdhdGNoIGZvciBhIHNjcm9sbAoJCQkJCQkvLyBldmVudC4gVW5mb3J0dW5hdGVseSwgc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MgZG9uJ3QgZGlzcGF0Y2ggc2Nyb2xsCgkJCQkJCS8vIGV2ZW50cyB1bnRpbCAqQUZURVIqIHRoZSB1c2VyIGxpZnRzIHRoZWlyIGZpbmdlciAodG91Y2hlbmQpLiBUaGlzIG1lYW5zCgkJCQkJCS8vIHdlIG5lZWQgdG8gd2F0Y2ggYm90aCBzY3JvbGwgYW5kIHRvdWNobW92ZSBldmVudHMgdG8gZmlndXJlIG91dCB3aGV0aGVyCgkJCQkJCS8vIG9yIG5vdCBhIHNjcm9sbCBoYXBwZW5lbnMgYmVmb3JlIHRoZSB0b3VjaGVuZCBldmVudCBpcyBmaXJlZC4KCgkJCQkJCS5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCB2YXIgaSA9IDA7IGkgPCB2aXJ0dWFsRXZlbnROYW1lcy5sZW5ndGg7IGkrKyApewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApewoJCXZhciBjbnQgPSBjbGlja0Jsb2NrTGlzdC5sZW5ndGgsCgkJCXRhcmdldCA9IGUudGFyZ2V0LAoJCQl4LCB5LCBlbGUsIGksIG8sIHRvdWNoSUQ7CgoJCWlmICggY250ICkgewoJCQl4ID0gZS5jbGllbnRYOwoJCQl5ID0gZS5jbGllbnRZOwoJCQl0aHJlc2hvbGQgPSAkLnZtb3VzZS5jbGlja0Rpc3RhbmNlVGhyZXNob2xkOwoKCQkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBydW4gdGhyb3VnaCB0aGUgY2xpY2tCbG9ja0xpc3QgdG8gc2VlIGlmCgkJCS8vIHRoZSBjdXJyZW50IGNsaWNrIGV2ZW50IGlzIGluIHRoZSBwcm94aW1pdHkgb2Ygb25lIG9mIG91cgoJCQkvLyB2Y2xpY2sgZXZlbnRzIHRoYXQgaGFkIHByZXZlbnREZWZhdWx0KCkgY2FsbGVkIG9uIGl0LiBJZiB3ZSBmaW5kCgkJCS8vIG9uZSwgdGhlbiB3ZSBibG9jayB0aGUgY2xpY2suCgkJCS8vCgkJCS8vIFdoeSBkbyB3ZSBoYXZlIHRvIHJlbHkgb24gcHJveGltaXR5PwoJCQkvLwoJCQkvLyBCZWNhdXNlIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoIGV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoZSB2Y2xpY2sKCQkJLy8gY2FuIGJlIGRpZmZlcmVudCBmcm9tIHRoZSB0YXJnZXQgb2YgdGhlIGNsaWNrIGV2ZW50IHN5bnRoZXNpemVkCgkJCS8vIGJ5IHRoZSBicm93c2VyLiBUaGUgdGFyZ2V0IG9mIGEgbW91c2UvY2xpY2sgZXZlbnQgdGhhdCBpcyBzeW50ZWhzaXplZAoJCQkvLyBmcm9tIGEgdG91Y2ggZXZlbnQgc2VlbXMgdG8gYmUgaW1wbGVtZW50YXRpb24gc3BlY2lmaWMuIEZvciBleGFtcGxlLAoJCQkvLyBzb21lIGJyb3dzZXJzIHdpbGwgZmlyZSBtb3VzZS9jbGljayBldmVudHMgZm9yIGEgbGluayB0aGF0IGlzIG5lYXIKCQkJLy8gYSB0b3VjaCBldmVudCwgZXZlbiB0aG91Z2ggdGhlIHRhcmdldCBvZiB0aGUgdG91Y2hzdGFydC90b3VjaGVuZCBldmVudAoJCQkvLyBzYXlzIHRoZSB1c2VyIHRvdWNoZWQgb3V0c2lkZSB0aGUgbGluay4gQWxzbywgaXQgc2VlbXMgdGhhdCB3aXRoIG1vc3QKCQkJLy8gYnJvd3NlcnMsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIGV2ZW50IGlzIG5vdCBjYWxjdWxhdGVkIHVudGlsIHRoZQoJCQkvLyB0aW1lIGl0IGlzIGRpc3BhdGNoZWQsIHNvIGlmIHlvdSByZXBsYWNlIGFuIGVsZW1lbnQgdGhhdCB5b3UgdG91Y2hlZAoJCQkvLyB3aXRoIGFub3RoZXIgZWxlbWVudCwgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgd2lsbCBiZSB0aGUgbmV3CgkJCS8vIGVsZW1lbnQgdW5kZXJuZWF0aCB0aGF0IHBvaW50LgoJCQkvLwoJCQkvLyBBc2lkZSBmcm9tIHByb3hpbWl0eSwgd2UgYWxzbyBjaGVjayB0byBzZWUgaWYgdGhlIHRhcmdldCBhbmQgYW55CgkJCS8vIG9mIGl0cyBhbmNlc3RvcnMgd2VyZSB0aGUgb25lcyB0aGF0IGJsb2NrZWQgYSBjbGljay4gVGhpcyBpcyBuZWNlc3NhcnkKCQkJLy8gYmVjYXVzZSBvZiB0aGUgc3RyYW5nZSBtb3VzZS9jbGljayB0YXJnZXQgY2FsY3VsYXRpb24gZG9uZSBpbiB0aGUKCQkJLy8gQW5kcm9pZCAyLjEgYnJvd3Nlciwgd2hlcmUgaWYgeW91IGNsaWNrIG9uIGFuIGVsZW1lbnQsIGFuZCB0aGVyZSBpcyBhCgkJCS8vIG1vdXNlL2NsaWNrIGhhbmRsZXIgb24gb25lIG9mIGl0cyBhbmNlc3RvcnMsIHRoZSB0YXJnZXQgd2lsbCBiZSB0aGUKCQkJLy8gaW5uZXJtb3N0IGNoaWxkIG9mIHRoZSB0b3VjaGVkIGVsZW1lbnQsIGV2ZW4gaWYgdGhhdCBjaGlsZCBpcyBubyB3aGVyZQoJCQkvLyBuZWFyIHRoZSBwb2ludCBvZiB0b3VjaC4KCgkJCWVsZSA9IHRhcmdldDsKCgkJCXdoaWxlICggZWxlICkgewoJCQkJZm9yICggaSA9IDA7IGkgPCBjbnQ7IGkrKyApIHsKCQkJCQlvID0gY2xpY2tCbG9ja0xpc3RbIGkgXTsKCQkJCQl0b3VjaElEID0gMDsKCgkJCQkJaWYgKCAoIGVsZSA9PT0gdGFyZ2V0ICYmIE1hdGguYWJzKCBvLnggLSB4ICkgPCB0aHJlc2hvbGQgJiYgTWF0aC5hYnMoIG8ueSAtIHkgKSA8IHRocmVzaG9sZCApIHx8CgkJCQkJCQkJJC5kYXRhKCBlbGUsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICkgPT09IG8udG91Y2hJRCApIHsKCQkJCQkJLy8gWFhYOiBXZSBtYXkgd2FudCB0byBjb25zaWRlciByZW1vdmluZyBtYXRjaGVzIGZyb20gdGhlIGJsb2NrIGxpc3QKCQkJCQkJLy8gICAgICBpbnN0ZWFkIG9mIHdhaXRpbmcgZm9yIHRoZSByZXNldCB0aW1lciB0byBmaXJlLgoJCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQl9CgkJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQkJfQoJCX0KCX0sIHRydWUpOwp9Cn0pKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQgKTsKLyogCiogImV2ZW50cyIgcGx1Z2luIC0gSGFuZGxlcyBldmVudHMKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBhZGQgbmV3IGV2ZW50IHNob3J0Y3V0cwokLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kIG9yaWVudGF0aW9uY2hhbmdlIHRocm90dGxlZHJlc2l6ZSAiICsKCQkJCQkidGFwIHRhcGhvbGQgc3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgc2Nyb2xsc3RhcnQgc2Nyb2xsc3RvcCIgKS5zcGxpdCggIiAiICksIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoKCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCX07CgoJJC5hdHRyRm5bIG5hbWUgXSA9IHRydWU7Cn0pOwoKdmFyIHN1cHBvcnRUb3VjaCA9ICQuc3VwcG9ydC50b3VjaCwKCXNjcm9sbEV2ZW50ID0gInRvdWNobW92ZSBzY3JvbGwiLAoJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgl0b3VjaFN0b3BFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaGVuZCIgOiAibW91c2V1cCIsCgl0b3VjaE1vdmVFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaG1vdmUiIDogIm1vdXNlbW92ZSI7CgpmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCXZhciBvcmlnaW5hbFR5cGUgPSBldmVudC50eXBlOwoJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCSQuZXZlbnQuaGFuZGxlLmNhbGwoIG9iaiwgZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cn0KCi8vIGFsc28gaGFuZGxlcyBzY3JvbGxzdG9wCiQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgllbmFibGVkOiB0cnVlLAoKCXNldHVwOiBmdW5jdGlvbigpIHsKCgkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJc2Nyb2xsaW5nLAoJCQl0aW1lcjsKCgkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQlzY3JvbGxpbmcgPSBzdGF0ZTsKCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBzY3JvbGxpbmcgPyAic2Nyb2xsc3RhcnQiIDogInNjcm9sbHN0b3AiLCBldmVudCApOwoJCX0KCgkJLy8gaVBob25lIHRyaWdnZXJzIHNjcm9sbCBhZnRlciBhIHNtYWxsIGRlbGF5OyB1c2UgdG91Y2htb3ZlIGluc3RlYWQKCQkkdGhpcy5iaW5kKCBzY3JvbGxFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCXRyaWdnZXIoIGV2ZW50LCB0cnVlICk7CgkJCX0KCgkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCX0sIDUwICk7CgkJfSk7Cgl9Cn07CgovLyBhbHNvIGhhbmRsZXMgdGFwaG9sZAokLmV2ZW50LnNwZWNpYWwudGFwID0gewoJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJaWYgKCBldmVudC53aGljaCAmJiBldmVudC53aGljaCAhPT0gMSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIG9yaWdUYXJnZXQgPSBldmVudC50YXJnZXQsCgkJCQlvcmlnRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50LAoJCQkJdGltZXI7CgoJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQl9CgoJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJY2xlYXJUYXBUaW1lcigpOwoKCQkJCSR0aGlzLnVuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApCgkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApCgkJCQkJLnVuYmluZCggInZtb3VzZWNhbmNlbCIsIGNsZWFyVGFwSGFuZGxlcnMgKTsKCQkJfQoKCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKGV2ZW50KSB7CgkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJLy8gT05MWSB0cmlnZ2VyIGEgJ3RhcCcgZXZlbnQgaWYgdGhlIHN0YXJ0IHRhcmdldCBpcwoJCQkJLy8gdGhlIHNhbWUgYXMgdGhlIHN0b3AgdGFyZ2V0LgoJCQkJaWYgKCBvcmlnVGFyZ2V0ID09IGV2ZW50LnRhcmdldCApIHsKCQkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJ0YXAiLCBldmVudCApOwoJCQkJfQoJCQl9CgoJCQkkdGhpcy5iaW5kKCAidm1vdXNlY2FuY2VsIiwgY2xlYXJUYXBIYW5kbGVycyApCgkJCQkuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApCgkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoKCQkJdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIgKSApOwoJCQl9LCA3NTAgKTsKCQl9KTsKCX0KfTsKCi8vIGFsc28gaGFuZGxlcyBzd2lwZWxlZnQsIHN3aXBlcmlnaHQKJC5ldmVudC5zcGVjaWFsLnN3aXBlID0gewoJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMTAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJZHVyYXRpb25UaHJlc2hvbGQ6IDEwMDAsIC8vIE1vcmUgdGltZSB0aGFuIHRoaXMsIGFuZCBpdCBpc24ndCBhIHN3aXBlLgoKCWhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZDogMzAsICAvLyBTd2lwZSBob3Jpem9udGFsIGRpc3BsYWNlbWVudCBtdXN0IGJlIG1vcmUgdGhhbiB0aGlzLgoKCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZGF0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA/CgkJCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudCwKCQkJCXN0YXJ0ID0gewoJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdLAoJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCX0sCgkJCQlzdG9wOwoKCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoKCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgZGF0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA/CgkJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgoJCQkJc3RvcCA9IHsKCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJfTsKCgkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJaWYgKCBNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZCApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9CgoJCQkkdGhpcy5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKQoJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkkdGhpcy51bmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApOwoKCQkJCQlpZiAoIHN0YXJ0ICYmIHN0b3AgKSB7CgkJCQkJCWlmICggc3RvcC50aW1lIC0gc3RhcnQudGltZSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5kdXJhdGlvblRocmVzaG9sZCAmJgoJCQkJCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQgJiYKCQkJCQkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCgkJCQkJCQlzdGFydC5vcmlnaW4udHJpZ2dlciggInN3aXBlIiApCgkJCQkJCQkJLnRyaWdnZXIoIHN0YXJ0LmNvb3Jkc1swXSA+IHN0b3AuY29vcmRzWyAwIF0gPyAic3dpcGVsZWZ0IiA6ICJzd2lwZXJpZ2h0IiApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXN0YXJ0ID0gc3RvcCA9IHVuZGVmaW5lZDsKCQkJCX0pOwoJCX0pOwoJfQp9OwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyAiQ293Ym95IiBCZW4gQWxtYW4KCgl2YXIgd2luID0gJCggd2luZG93ICksCgkJc3BlY2lhbF9ldmVudCwKCQlnZXRfb3JpZW50YXRpb24sCgkJbGFzdF9vcmllbnRhdGlvbjsKCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UgPSBzcGVjaWFsX2V2ZW50ID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgcmV0dXJuIGZhbHNlIHNvIHRoYXQgalF1ZXJ5CgkJCS8vIHdpbGwgYmluZCB0byB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKXsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICQubW9iaWxlLm9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgdW5iaW5kIHRoZQoJCQkvLyByZXNpemUgZXZlbnQgaGFuZGxlci4KCQkJd2luLnVuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCWFkZDogZnVuY3Rpb24oIGhhbmRsZU9iaiApIHsKCQkJLy8gU2F2ZSBhIHJlZmVyZW5jZSB0byB0aGUgYm91bmQgZXZlbnQgaGFuZGxlci4KCQkJdmFyIG9sZF9oYW5kbGVyID0gaGFuZGxlT2JqLmhhbmRsZXI7CgoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfTsKCgkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgdGhpcyBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8KCS8vIHRoZSB3aW5kb3cgcmVzaXplIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCWZ1bmN0aW9uIGhhbmRsZXIoKSB7CgkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uLgoJCXZhciBvcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQlpZiAoIG9yaWVudGF0aW9uICE9PSBsYXN0X29yaWVudGF0aW9uICkgewoJCQkvLyBUaGUgb3JpZW50YXRpb24gaGFzIGNoYW5nZWQsIHNvIHRyaWdnZXIgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJCQlsYXN0X29yaWVudGF0aW9uID0gb3JpZW50YXRpb247CgkJCXdpbi50cmlnZ2VyKCAib3JpZW50YXRpb25jaGFuZ2UiICk7CgkJfQoJfQoKCS8vIEdldCB0aGUgY3VycmVudCBwYWdlIG9yaWVudGF0aW9uLiBUaGlzIG1ldGhvZCBpcyBleHBvc2VkIHB1YmxpY2x5LCBzaG91bGQgaXQKCS8vIGJlIG5lZWRlZCwgYXMgalF1ZXJ5LmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24oKQoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIGlzUG9ydHJhaXQgPSB0cnVlLCBlbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQkvLyBwcmVmZXIgd2luZG93IG9yaWVudGF0aW9uIHRvIHRoZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBzY3JlZW5zaXplIGFzCgkJLy8gdGhlIGFjdHVhbCBzY3JlZW4gcmVzaXplIHRha2VzIHBsYWNlIGJlZm9yZSBvciBhZnRlciB0aGUgb3JpZW50YXRpb24gY2hhbmdlIGV2ZW50CgkJLy8gaGFzIGJlZW4gZmlyZWQgZGVwZW5kaW5nIG9uIGltcGxlbWVudGF0aW9uIChlZyBhbmRyb2lkIDIuMyBpcyBiZWZvcmUsIGlwaG9uZSBhZnRlcikuCgkJLy8gTW9yZSB0ZXN0aW5nIGlzIHJlcXVpcmVkIHRvIGRldGVybWluZSBpZiBhIG1vcmUgcmVsaWFibGUgbWV0aG9kIG9mIGRldGVybWluaW5nIHRoZSBuZXcgc2NyZWVuc2l6ZQoJCS8vIGlzIHBvc3NpYmxlIHdoZW4gb3JpZW50YXRpb25jaGFuZ2UgaXMgZmlyZWQuIChlZywgdXNlIG1lZGlhIHF1ZXJpZXMgKyBlbGVtZW50ICsgb3BhY2l0eSkKCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCQkJLy8gaWYgdGhlIHdpbmRvdyBvcmllbnRhdGlvbiByZWdpc3RlcnMgYXMgMCBvciAxODAgZGVncmVlcyByZXBvcnQKCQkJLy8gcG9ydHJhaXQsIG90aGVyd2lzZSBsYW5kc2NhcGUKCQkJaXNQb3J0cmFpdCA9IHdpbmRvdy5vcmllbnRhdGlvbiAlIDE4MCA9PSAwOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCn0pKCBqUXVlcnksIHdpbmRvdyApOwoKCi8vIHRocm90dGxlZCByZXNpemUgZXZlbnQKKGZ1bmN0aW9uKCkgewoKCSQuZXZlbnQuc3BlY2lhbC50aHJvdHRsZWRyZXNpemUgPSB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpewoJCQkkKCB0aGlzICkudW5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCX0KCX07CgoJdmFyIHRocm90dGxlID0gMjUwLAoJCWhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCQkJY3VyciA9ICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsKCQkJZGlmZiA9IGN1cnIgLSBsYXN0Q2FsbDsKCgkJCWlmICggZGlmZiA+PSB0aHJvdHRsZSApIHsKCgkJCQlsYXN0Q2FsbCA9IGN1cnI7CgkJCQkkKCB0aGlzICkudHJpZ2dlciggInRocm90dGxlZHJlc2l6ZSIgKTsKCgkJCX0gZWxzZSB7CgoJCQkJaWYgKCBoZWxkQ2FsbCApIHsKCQkJCQljbGVhclRpbWVvdXQoIGhlbGRDYWxsICk7CgkJCQl9CgoJCQkJLy8gUHJvbWlzZSBhIGhlbGQgY2FsbCB3aWxsIHN0aWxsIGV4ZWN1dGUKCQkJCWhlbGRDYWxsID0gc2V0VGltZW91dCggaGFuZGxlciwgdGhyb3R0bGUgLSBkaWZmICk7CgkJCX0KCQl9LAoJCWxhc3RDYWxsID0gMCwKCQloZWxkQ2FsbCwKCQljdXJyLAoJCWRpZmY7Cn0pKCk7CgoKJC5lYWNoKHsKCXNjcm9sbHN0b3A6ICJzY3JvbGxzdGFydCIsCgl0YXBob2xkOiAidGFwIiwKCXN3aXBlbGVmdDogInN3aXBlIiwKCXN3aXBlcmlnaHQ6ICJzd2lwZSIKfSwgZnVuY3Rpb24oIGV2ZW50LCBzb3VyY2VFdmVudCApIHsKCgkkLmV2ZW50LnNwZWNpYWxbIGV2ZW50IF0gPSB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuYmluZCggc291cmNlRXZlbnQsICQubm9vcCApOwoJCX0KCX07Cn0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovLyBTY3JpcHQ6IGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50Ci8vIAovLyAqVmVyc2lvbjogMS4zLCBMYXN0IHVwZGF0ZWQ6IDcvMjEvMjAxMCoKLy8gCi8vIFByb2plY3QgSG9tZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UtcGx1Z2luLwovLyBHaXRIdWIgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvCi8vIFNvdXJjZSAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLmpzCi8vIChNaW5pZmllZCkgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLm1pbi5qcyAoMC44a2IgZ3ppcHBlZCkKLy8gCi8vIEFib3V0OiBMaWNlbnNlCi8vIAovLyBDb3B5cmlnaHQgKGMpIDIwMTAgIkNvd2JveSIgQmVuIEFsbWFuLAovLyBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlcy4KLy8gaHR0cDovL2JlbmFsbWFuLmNvbS9hYm91dC9saWNlbnNlLwovLyAKLy8gQWJvdXQ6IEV4YW1wbGVzCi8vIAovLyBUaGVzZSB3b3JraW5nIGV4YW1wbGVzLCBjb21wbGV0ZSB3aXRoIGZ1bGx5IGNvbW1lbnRlZCBjb2RlLCBpbGx1c3RyYXRlIGEgZmV3Ci8vIHdheXMgaW4gd2hpY2ggdGhpcyBwbHVnaW4gY2FuIGJlIHVzZWQuCi8vIAovLyBoYXNoY2hhbmdlIGV2ZW50IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2hhc2hjaGFuZ2UvCi8vIGRvY3VtZW50LmRvbWFpbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9kb2N1bWVudF9kb21haW4vCi8vIAovLyBBYm91dDogU3VwcG9ydCBhbmQgVGVzdGluZwovLyAKLy8gSW5mb3JtYXRpb24gYWJvdXQgd2hhdCB2ZXJzaW9uIG9yIHZlcnNpb25zIG9mIGpRdWVyeSB0aGlzIHBsdWdpbiBoYXMgYmVlbgovLyB0ZXN0ZWQgd2l0aCwgd2hhdCBicm93c2VycyBpdCBoYXMgYmVlbiB0ZXN0ZWQgaW4sIGFuZCB3aGVyZSB0aGUgdW5pdCB0ZXN0cwovLyByZXNpZGUgKHNvIHlvdSBjYW4gdGVzdCBpdCB5b3Vyc2VsZikuCi8vIAovLyBqUXVlcnkgVmVyc2lvbnMgLSAxLjIuNiwgMS4zLjIsIDEuNC4xLCAxLjQuMgovLyBCcm93c2VycyBUZXN0ZWQgLSBJbnRlcm5ldCBFeHBsb3JlciA2LTgsIEZpcmVmb3ggMi00LCBDaHJvbWUgNS02LCBTYWZhcmkgMy4yLTUsCi8vICAgICAgICAgICAgICAgICAgIE9wZXJhIDkuNi0xMC42MCwgaVBob25lIDMuMSwgQW5kcm9pZCAxLjYtMi4yLCBCbGFja0JlcnJ5IDQuNi01LgovLyBVbml0IFRlc3RzICAgICAgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvdW5pdC8KLy8gCi8vIEFib3V0OiBLbm93biBpc3N1ZXMKLy8gCi8vIFdoaWxlIHRoaXMgalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQgaW1wbGVtZW50YXRpb24gaXMgcXVpdGUgc3RhYmxlIGFuZAovLyByb2J1c3QsIHRoZXJlIGFyZSBhIGZldyB1bmZvcnR1bmF0ZSBicm93c2VyIGJ1Z3Mgc3Vycm91bmRpbmcgZXhwZWN0ZWQKLy8gaGFzaGNoYW5nZSBldmVudC1iYXNlZCBiZWhhdmlvcnMsIGluZGVwZW5kZW50IG9mIGFueSBKYXZhU2NyaXB0Ci8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgYWJzdHJhY3Rpb24uIFNlZSB0aGUgZm9sbG93aW5nIGV4YW1wbGVzIGZvciBtb3JlCi8vIGluZm9ybWF0aW9uOgovLyAKLy8gQ2hyb21lOiBCYWNrIEJ1dHRvbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctY2hyb21lLWJhY2stYnV0dG9uLwovLyBGaXJlZm94OiBSZW1vdGUgWE1MSHR0cFJlcXVlc3QgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWZpcmVmb3gtcmVtb3RlLXhoci8KLy8gV2ViS2l0OiBCYWNrIEJ1dHRvbiBpbiBhbiBJZnJhbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXdlYmtpdC1oYXNoLWlmcmFtZS8KLy8gU2FmYXJpOiBCYWNrIEJ1dHRvbiBmcm9tIGEgZGlmZmVyZW50IGRvbWFpbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctc2FmYXJpLWJhY2stZnJvbS1kaWZmLWRvbWFpbi8KLy8gCi8vIEFsc28gbm90ZSB0aGF0IHNob3VsZCBhIGJyb3dzZXIgbmF0aXZlbHkgc3VwcG9ydCB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSAKLy8gZXZlbnQsIGJ1dCBub3QgcmVwb3J0IHRoYXQgaXQgZG9lcywgdGhlIGZhbGxiYWNrIHBvbGxpbmcgbG9vcCB3aWxsIGJlIHVzZWQuCi8vIAovLyBBYm91dDogUmVsZWFzZSBIaXN0b3J5Ci8vIAovLyAxLjMgICAtICg3LzIxLzIwMTApIFJlb3JnYW5pemVkIElFNi83IElmcmFtZSBjb2RlIHRvIG1ha2UgaXQgbW9yZQovLyAgICAgICAgICJyZW1vdmFibGUiIGZvciBtb2JpbGUtb25seSBkZXZlbG9wbWVudC4gQWRkZWQgSUU2LzcgZG9jdW1lbnQudGl0bGUKLy8gICAgICAgICBzdXBwb3J0LiBBdHRlbXB0ZWQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlIGJ5IHVzaW5nCi8vICAgICAgICAgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuIEFkZGVkIAovLyAgICAgICAgIHN1cHBvcnQgZm9yIHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKHdpbmRvdykuaGFzaGNoYW5nZSggZm4gKSBhbmQKLy8gICAgICAgICAkKHdpbmRvdykuaGFzaGNoYW5nZSgpIGxpa2UgalF1ZXJ5IHByb3ZpZGVzIGZvciBidWlsdC1pbiBldmVudHMuCi8vICAgICAgICAgUmVuYW1lZCBqUXVlcnkuaGFzaGNoYW5nZURlbGF5IHRvIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheT4gYW5kCi8vICAgICAgICAgbG93ZXJlZCBpdHMgZGVmYXVsdCB2YWx1ZSB0byA1MC4gQWRkZWQgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbj4KLy8gICAgICAgICBhbmQgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydGllcyBwbHVzIGRvY3VtZW50LWRvbWFpbi5odG1sCi8vICAgICAgICAgZmlsZSB0byBhZGRyZXNzIGFjY2VzcyBkZW5pZWQgaXNzdWVzIHdoZW4gc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4KLy8gICAgICAgICBJRTYvNy4KLy8gMS4yICAgLSAoMi8xMS8yMDEwKSBGaXhlZCBhIGJ1ZyB3aGVyZSBjb21pbmcgYmFjayB0byBhIHBhZ2UgdXNpbmcgdGhpcyBwbHVnaW4KLy8gICAgICAgICBmcm9tIGEgcGFnZSBvbiBhbm90aGVyIGRvbWFpbiB3b3VsZCBjYXVzZSBhbiBlcnJvciBpbiBTYWZhcmkgNC4gQWxzbywKLy8gICAgICAgICBJRTYvNyBJZnJhbWUgaXMgbm93IGluc2VydGVkIGFmdGVyIHRoZSBib2R5ICh0aGlzIGFjdHVhbGx5IHdvcmtzKSwKLy8gICAgICAgICB3aGljaCBwcmV2ZW50cyB0aGUgcGFnZSBmcm9tIHNjcm9sbGluZyB3aGVuIHRoZSBldmVudCBpcyBmaXJzdCBib3VuZC4KLy8gICAgICAgICBFdmVudCBjYW4gYWxzbyBub3cgYmUgYm91bmQgYmVmb3JlIERPTSByZWFkeSwgYnV0IGl0IHdvbid0IGJlIHVzYWJsZQovLyAgICAgICAgIGJlZm9yZSB0aGVuIGluIElFNi83LgovLyAxLjEgICAtICgxLzIxLzIwMTApIEluY29ycG9yYXRlZCBkb2N1bWVudC5kb2N1bWVudE1vZGUgdGVzdCB0byBmaXggSUU4IGJ1ZwovLyAgICAgICAgIHdoZXJlIGJyb3dzZXIgdmVyc2lvbiBpcyBpbmNvcnJlY3RseSByZXBvcnRlZCBhcyA4LjAsIGRlc3BpdGUKLy8gICAgICAgICBpbmNsdXNpb24gb2YgdGhlIFgtVUEtQ29tcGF0aWJsZSBJRT1FbXVsYXRlSUU3IG1ldGEgdGFnLgovLyAxLjAgICAtICgxLzkvMjAxMCkgSW5pdGlhbCBSZWxlYXNlLiBCcm9rZSBvdXQgdGhlIGpRdWVyeSBCQlEgZXZlbnQuc3BlY2lhbAovLyAgICAgICAgIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZnVuY3Rpb25hbGl0eSBpbnRvIGEgc2VwYXJhdGUgcGx1Z2luIGZvciB1c2VycwovLyAgICAgICAgIHdobyB3YW50IGp1c3QgdGhlIGJhc2ljIGV2ZW50ICYgYmFjayBidXR0b24gc3VwcG9ydCwgd2l0aG91dCBhbGwgdGhlCi8vICAgICAgICAgZXh0cmEgYXdlc29tZW5lc3MgdGhhdCBCQlEgcHJvdmlkZXMuIFRoaXMgcGx1Z2luIHdpbGwgYmUgaW5jbHVkZWQgYXMKLy8gICAgICAgICBwYXJ0IG9mIGpRdWVyeSBCQlEsIGJ1dCBhbHNvIGJlIGF2YWlsYWJsZSBzZXBhcmF0ZWx5LgoKKGZ1bmN0aW9uKCQsd2luZG93LHVuZGVmaW5lZCl7CiAgJyQ6bm9tdW5nZSc7IC8vIFVzZWQgYnkgWVVJIGNvbXByZXNzb3IuCiAgCiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCl7CiAgICB2YXIgc2VsZiA9IHt9LAogICAgICB0aW1lb3V0X2lkLAogICAgICAKICAgICAgLy8gUmVtZW1iZXIgdGhlIGluaXRpYWwgaGFzaCBzbyBpdCBkb2Vzbid0IGdldCB0cmlnZ2VyZWQgaW1tZWRpYXRlbHkuCiAgICAgIGxhc3RfaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAKICAgICAgZm5fcmV0dmFsID0gZnVuY3Rpb24odmFsKXsgcmV0dXJuIHZhbDsgfSwKICAgICAgaGlzdG9yeV9zZXQgPSBmbl9yZXR2YWwsCiAgICAgIGhpc3RvcnlfZ2V0ID0gZm5fcmV0dmFsOwogICAgCiAgICAvLyBTdGFydCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICB0aW1lb3V0X2lkIHx8IHBvbGwoKTsKICAgIH07CiAgICAKICAgIC8vIFN0b3AgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICB0aW1lb3V0X2lkICYmIGNsZWFyVGltZW91dCggdGltZW91dF9pZCApOwogICAgICB0aW1lb3V0X2lkID0gdW5kZWZpbmVkOwogICAgfTsKICAgIAogICAgLy8gVGhpcyBwb2xsaW5nIGxvb3AgY2hlY2tzIGV2ZXJ5ICQuZm4uaGFzaGNoYW5nZS5kZWxheSBtaWxsaXNlY29uZHMgdG8gc2VlCiAgICAvLyBpZiBsb2NhdGlvbi5oYXNoIGhhcyBjaGFuZ2VkLCBhbmQgdHJpZ2dlcnMgdGhlICdoYXNoY2hhbmdlJyBldmVudCBvbgogICAgLy8gd2luZG93IHdoZW4gbmVjZXNzYXJ5LgogICAgZnVuY3Rpb24gcG9sbCgpIHsKICAgICAgdmFyIGhhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgICBoaXN0b3J5X2hhc2ggPSBoaXN0b3J5X2dldCggbGFzdF9oYXNoICk7CiAgICAgIAogICAgICBpZiAoIGhhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBoaXN0b3J5X3NldCggbGFzdF9oYXNoID0gaGFzaCwgaGlzdG9yeV9oYXNoICk7CiAgICAgICAgCiAgICAgICAgJCh3aW5kb3cpLnRyaWdnZXIoIHN0cl9oYXNoY2hhbmdlICk7CiAgICAgICAgCiAgICAgIH0gZWxzZSBpZiAoIGhpc3RvcnlfaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGxvY2F0aW9uLmhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoIC8jLiovLCAnJyApICsgaGlzdG9yeV9oYXNoOwogICAgICB9CiAgICAgIAogICAgICB0aW1lb3V0X2lkID0gc2V0VGltZW91dCggcG9sbCwgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kZWxheSApOwogICAgfTsKICAgIAogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2IFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgJC5icm93c2VyLm1zaWUgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKXsKICAgICAgLy8gTm90IG9ubHkgZG8gSUU2LzcgbmVlZCB0aGUgIm1hZ2ljYWwiIElmcmFtZSB0cmVhdG1lbnQsIGJ1dCBzbyBkb2VzIElFOAogICAgICAvLyB3aGVuIHJ1bm5pbmcgaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlLgogICAgICAKICAgICAgdmFyIGlmcmFtZSwKICAgICAgICBpZnJhbWVfc3JjOwogICAgICAKICAgICAgLy8gV2hlbiB0aGUgZXZlbnQgaXMgYm91bmQgYW5kIHBvbGxpbmcgc3RhcnRzIGluIElFIDYvNywgY3JlYXRlIGEgaGlkZGVuCiAgICAgIC8vIElmcmFtZSBmb3IgaGlzdG9yeSBoYW5kbGluZy4KICAgICAgc2VsZi5zdGFydCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKCAhaWZyYW1lICkgewogICAgICAgICAgaWZyYW1lX3NyYyA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uc3JjOwogICAgICAgICAgaWZyYW1lX3NyYyA9IGlmcmFtZV9zcmMgJiYgaWZyYW1lX3NyYyArIGdldF9mcmFnbWVudCgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBDcmVhdGUgaGlkZGVuIElmcmFtZS4gQXR0ZW1wdCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUKICAgICAgICAgIC8vIGJ5IHVzaW5nIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LgogICAgICAgICAgaWZyYW1lID0gJCgnPGlmcmFtZSB0YWJpbmRleD0iLTEiIHRpdGxlPSJlbXB0eSIvPicpLmhpZGUoKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gV2hlbiBJZnJhbWUgaGFzIGNvbXBsZXRlbHkgbG9hZGVkLCBpbml0aWFsaXplIHRoZSBoaXN0b3J5IGFuZAogICAgICAgICAgICAvLyBzdGFydCBwb2xsaW5nLgogICAgICAgICAgICAub25lKCAnbG9hZCcsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgaWZyYW1lX3NyYyB8fCBoaXN0b3J5X3NldCggZ2V0X2ZyYWdtZW50KCkgKTsKICAgICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2FkIElmcmFtZSBzcmMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugbm90aGluZy4KICAgICAgICAgICAgLmF0dHIoICdzcmMnLCBpZnJhbWVfc3JjIHx8ICdqYXZhc2NyaXB0OjAnICkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGVuZCBJZnJhbWUgYWZ0ZXIgdGhlIGVuZCBvZiB0aGUgYm9keSB0byBwcmV2ZW50IHVubmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluaXRpYWwgcGFnZSBzY3JvbGxpbmcgKHllcywgdGhpcyB3b3JrcykuCiAgICAgICAgICAgIC5pbnNlcnRBZnRlciggJ2JvZHknIClbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgIAogICAgICAgICAgLy8gV2hlbmV2ZXIgYGRvY3VtZW50LnRpdGxlYCBjaGFuZ2VzLCB1cGRhdGUgdGhlIElmcmFtZSdzIHRpdGxlIHRvCiAgICAgICAgICAvLyBwcmV0dGlmeSB0aGUgYmFjay9uZXh0IGhpc3RvcnkgbWVudSBlbnRyaWVzLiBTaW5jZSBJRSBzb21ldGltZXMKICAgICAgICAgIC8vIGVycm9ycyB3aXRoICJVbnNwZWNpZmllZCBlcnJvciIgdGhlIHZlcnkgZmlyc3QgdGltZSB0aGlzIGlzIHNldAogICAgICAgICAgLy8gKHllcywgdmVyeSB1c2VmdWwpIHdyYXAgdGhpcyB3aXRoIGEgdHJ5L2NhdGNoIGJsb2NrLgogICAgICAgICAgZG9jLm9ucHJvcGVydHljaGFuZ2UgPSBmdW5jdGlvbigpewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmICggZXZlbnQucHJvcGVydHlOYW1lID09PSAndGl0bGUnICkgewogICAgICAgICAgICAgICAgaWZyYW1lLmRvY3VtZW50LnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaChlKSB7fQogICAgICAgICAgfTsKICAgICAgICAgIAogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICAgIC8vIE92ZXJyaWRlIHRoZSAic3RvcCIgbWV0aG9kIHNpbmNlIGFuIElFNi83IElmcmFtZSB3YXMgY3JlYXRlZC4gRXZlbgogICAgICAvLyBpZiB0aGVyZSBhcmUgbm8gbG9uZ2VyIGFueSBib3VuZCBldmVudCBoYW5kbGVycywgdGhlIHBvbGxpbmcgbG9vcAogICAgICAvLyBpcyBzdGlsbCBuZWNlc3NhcnkgZm9yIGJhY2svbmV4dCB0byB3b3JrIGF0IGFsbCEKICAgICAgc2VsZi5zdG9wID0gZm5fcmV0dmFsOwogICAgICAKICAgICAgLy8gR2V0IGhpc3RvcnkgYnkgbG9va2luZyBhdCB0aGUgaGlkZGVuIElmcmFtZSdzIGxvY2F0aW9uLmhhc2guCiAgICAgIGhpc3RvcnlfZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGdldF9mcmFnbWVudCggaWZyYW1lLmxvY2F0aW9uLmhyZWYgKTsKICAgICAgfTsKICAgICAgCiAgICAgIC8vIFNldCBhIG5ldyBoaXN0b3J5IGl0ZW0gYnkgb3BlbmluZyBhbmQgdGhlbiBjbG9zaW5nIHRoZSBJZnJhbWUKICAgICAgLy8gZG9jdW1lbnQsICp0aGVuKiBzZXR0aW5nIGl0cyBsb2NhdGlvbi5oYXNoLiBJZiBkb2N1bWVudC5kb21haW4gaGFzCiAgICAgIC8vIGJlZW4gc2V0LCB1cGRhdGUgdGhhdCBhcyB3ZWxsLgogICAgICBoaXN0b3J5X3NldCA9IGZ1bmN0aW9uKCBoYXNoLCBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgdmFyIGlmcmFtZV9kb2MgPSBpZnJhbWUuZG9jdW1lbnQsCiAgICAgICAgICBkb21haW4gPSAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbjsKICAgICAgICAKICAgICAgICBpZiAoIGhhc2ggIT09IGhpc3RvcnlfaGFzaCApIHsKICAgICAgICAgIC8vIFVwZGF0ZSBJZnJhbWUgd2l0aCBhbnkgaW5pdGlhbCBgZG9jdW1lbnQudGl0bGVgIHRoYXQgbWlnaHQgYmUgc2V0LgogICAgICAgICAgaWZyYW1lX2RvYy50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgIAogICAgICAgICAgLy8gT3BlbmluZyB0aGUgSWZyYW1lJ3MgZG9jdW1lbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gY2xvc2VkIGlzIHdoYXQKICAgICAgICAgIC8vIGFjdHVhbGx5IGFkZHMgYSBoaXN0b3J5IGVudHJ5LgogICAgICAgICAgaWZyYW1lX2RvYy5vcGVuKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFNldCBkb2N1bWVudC5kb21haW4gZm9yIHRoZSBJZnJhbWUgZG9jdW1lbnQgYXMgd2VsbCwgaWYgbmVjZXNzYXJ5LgogICAgICAgICAgZG9tYWluICYmIGlmcmFtZV9kb2Mud3JpdGUoICc8c2NyaXB0PmRvY3VtZW50LmRvbWFpbj0iJyArIGRvbWFpbiArICciPC9zY3JpcHQ+JyApOwogICAgICAgICAgCiAgICAgICAgICBpZnJhbWVfZG9jLmNsb3NlKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgSWZyYW1lJ3MgaGFzaCwgZm9yIGdyZWF0IGp1c3RpY2UuCiAgICAgICAgICBpZnJhbWUubG9jYXRpb24uaGFzaCA9IGhhc2g7CiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgIH0pKCk7CiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl4gUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAKICAgIHJldHVybiBzZWxmOwogIH0pKCk7CiAgCn0pKGpRdWVyeSx0aGlzKTsKLyoKKiAicGFnZSIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogImMiLAoJCWRvbUNhY2hlOiBmYWxzZSwKCQlrZWVwTmF0aXZlRGVmYXVsdDogIjpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdGhpcy5fdHJpZ2dlciggImJlZm9yZWNyZWF0ZSIgKTsKCgkJdGhpcy5lbGVtZW50CgkJCS5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wYWdlIHVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZSApOwoJfSwKCglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlRGVmaW5lZCA9IG9wdGlvbnMua2VlcE5hdGl2ZSAmJiAkLnRyaW0ob3B0aW9ucy5rZWVwTmF0aXZlKTsKCgkJaWYoIGtlZXBOYXRpdmVEZWZpbmVkICYmIG9wdGlvbnMua2VlcE5hdGl2ZSAhPT0gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdCApewoJCQlyZXR1cm4gW29wdGlvbnMua2VlcE5hdGl2ZSwgb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdF0uam9pbigiLCAiKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0OwoJfQp9KTsKfSkoIGpRdWVyeSApOwovKiAKKiAiY29yZSIgLSBUaGUgYmFzZSBmaWxlIGZvciBqUW0KKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9OwoKCS8vIGpRdWVyeS5tb2JpbGUgY29uZmlndXJhYmxlIG9wdGlvbnMKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoKCQkvLyBOYW1lc3BhY2UgdXNlZCBmcmFtZXdvcmstd2lkZSBmb3IgZGF0YS1hdHRycy4gRGVmYXVsdCBpcyBubyBuYW1lc3BhY2UKCQluczogIiIsCgoJCS8vIERlZmluZSB0aGUgdXJsIHBhcmFtZXRlciB1c2VkIGZvciByZWZlcmVuY2luZyB3aWRnZXQtZ2VuZXJhdGVkIHN1Yi1wYWdlcy4KCQkvLyBUcmFuc2xhdGVzIHRvIHRvIGV4YW1wbGUuaHRtbCZ1aS1wYWdlPXN1YnBhZ2VJZGVudGlmaWVyCgkJLy8gaGFzaCBzZWdtZW50IGJlZm9yZSAmdWktcGFnZT0gaXMgdXNlZCB0byBtYWtlIEFqYXggcmVxdWVzdAoJCXN1YlBhZ2VVcmxLZXk6ICJ1aS1wYWdlIiwKCgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImFjdGl2ZSIgYnV0dG9uIHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlhY3RpdmVCdG5DbGFzczogInVpLWJ0bi1hY3RpdmUiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogInNsaWRlIiwKCgkJLy8gTWluaW11bSBzY3JvbGwgZGlzdGFuY2UgdGhhdCB3aWxsIGJlIHJlbWVtYmVyZWQgd2hlbiByZXR1cm5pbmcgdG8gYSBwYWdlCgkJbWluU2Nyb2xsQmFjazogMjUwLAoKCQkvLyBTZXQgZGVmYXVsdCBkaWFsb2cgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjogInBvcCIsCgoJCS8vIFNob3cgbG9hZGluZyBtZXNzYWdlIGR1cmluZyBBamF4IHJlcXVlc3RzCgkJLy8gaWYgZmFsc2UsIG1lc3NhZ2Ugd2lsbCBub3QgYXBwZWFyLCBidXQgbG9hZGluZyBjbGFzc2VzIHdpbGwgc3RpbGwgYmUgdG9nZ2xlZCBvbiBodG1sIGVsCgkJbG9hZGluZ01lc3NhZ2U6ICJsb2FkaW5nIiwKCgkJLy8gRXJyb3IgcmVzcG9uc2UgbWVzc2FnZSAtIGFwcGVhcnMgd2hlbiBhbiBBamF4IHBhZ2UgcmVxdWVzdCBmYWlscwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlOiAiRXJyb3IgTG9hZGluZyBQYWdlIiwKCgkJLy9hdXRvbWF0aWNhbGx5IGluaXRpYWxpemUgdGhlIERPTSB3aGVuIGl0J3MgcmVhZHkKCQlhdXRvSW5pdGlhbGl6ZVBhZ2U6IHRydWUsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCS8vIHR1cm4gb2YgYmluZGluZyB0byB0aGUgbmF0aXZlIG9yaWVudGF0aW9uY2hhbmdlIGR1ZSB0byBhbmRyb2lkIG9yaWVudGF0aW9uIGJlaGF2aW9yCgkJb3JpZW50YXRpb25DaGFuZ2VFbmFibGVkOiB0cnVlLAoKCQkvLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCgkJLy8gZGVmYXVsdCBlbmhhbmNlZCBxdWFsaWZpY2F0aW9ucyBhcmUgbWVkaWEgcXVlcnkgc3VwcG9ydCBPUiBJRSA3KwoJCWdyYWRlQTogZnVuY3Rpb24oKXsKCQkJcmV0dXJuICQuc3VwcG9ydC5tZWRpYXF1ZXJ5IHx8ICQubW9iaWxlLmJyb3dzZXIuaWUgJiYgJC5tb2JpbGUuYnJvd3Nlci5pZSA+PSA3OwoJCX0sCgoJCS8vIFRPRE8gbWlnaHQgYmUgdXNlZnVsIHVwc3RyZWFtIGluIGpxdWVyeSBpdHNlbGYgPwoJCWtleUNvZGU6IHsKCQkJQUxUOiAxOCwKCQkJQkFDS1NQQUNFOiA4LAoJCQlDQVBTX0xPQ0s6IDIwLAoJCQlDT01NQTogMTg4LAoJCQlDT01NQU5EOiA5MSwKCQkJQ09NTUFORF9MRUZUOiA5MSwgLy8gQ09NTUFORAoJCQlDT01NQU5EX1JJR0hUOiA5MywKCQkJQ09OVFJPTDogMTcsCgkJCURFTEVURTogNDYsCgkJCURPV046IDQwLAoJCQlFTkQ6IDM1LAoJCQlFTlRFUjogMTMsCgkJCUVTQ0FQRTogMjcsCgkJCUhPTUU6IDM2LAoJCQlJTlNFUlQ6IDQ1LAoJCQlMRUZUOiAzNywKCQkJTUVOVTogOTMsIC8vIENPTU1BTkRfUklHSFQKCQkJTlVNUEFEX0FERDogMTA3LAoJCQlOVU1QQURfREVDSU1BTDogMTEwLAoJCQlOVU1QQURfRElWSURFOiAxMTEsCgkJCU5VTVBBRF9FTlRFUjogMTA4LAoJCQlOVU1QQURfTVVMVElQTFk6IDEwNiwKCQkJTlVNUEFEX1NVQlRSQUNUOiAxMDksCgkJCVBBR0VfRE9XTjogMzQsCgkJCVBBR0VfVVA6IDMzLAoJCQlQRVJJT0Q6IDE5MCwKCQkJUklHSFQ6IDM5LAoJCQlTSElGVDogMTYsCgkJCVNQQUNFOiAzMiwKCQkJVEFCOiA5LAoJCQlVUDogMzgsCgkJCVdJTkRPV1M6IDkxIC8vIENPTU1BTkQKCQl9LAoKCQkvLyBTY3JvbGwgcGFnZSB2ZXJ0aWNhbGx5OiBzY3JvbGwgdG8gMCB0byBoaWRlIGlPUyBhZGRyZXNzIGJhciwgb3IgcGFzcyBhIFkgdmFsdWUKCQlzaWxlbnRTY3JvbGw6IGZ1bmN0aW9uKCB5cG9zICkgewoJCQlpZiAoICQudHlwZSggeXBvcyApICE9PSAibnVtYmVyIiApIHsKCQkJCXlwb3MgPSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCQkJfQoKCQkJLy8gcHJldmVudCBzY3JvbGxzdGFydCBhbmQgc2Nyb2xsc3RvcCBldmVudHMKCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHlwb3MgKTsKCQkJCSQoIGRvY3VtZW50ICkudHJpZ2dlciggInNpbGVudHNjcm9sbCIsIHsgeDogMCwgeTogeXBvcyB9KTsKCQkJfSwgMjAgKTsKCgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCX0sIDE1MCApOwoJCX0sCgoJCS8vIEV4cG9zZSBvdXIgY2FjaGUgZm9yIHRlc3RpbmcgcHVycG9zZXMuCgkJbnNOb3JtYWxpemVEaWN0OiBuc05vcm1hbGl6ZURpY3QsCgoJCS8vIFRha2UgYSBkYXRhIGF0dHJpYnV0ZSBwcm9wZXJ0eSwgcHJlcGVuZCB0aGUgbmFtZXNwYWNlCgkJLy8gYW5kIHRoZW4gY2FtZWwgY2FzZSB0aGUgYXR0cmlidXRlIHN0cmluZy4gQWRkIHRoZSByZXN1bHQKCQkvLyB0byBvdXIgbnNOb3JtYWxpemVEaWN0IHNvIHdlIGRvbid0IGhhdmUgdG8gZG8gdGhpcyBhZ2Fpbi4KCQluc05vcm1hbGl6ZTogZnVuY3Rpb24oIHByb3AgKSB7CgkJCWlmICggIXByb3AgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXJldHVybiBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSB8fCAoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoKCQkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzIG9uIGl0LiBOb3RlIHRoYXQKCQkJLy8gd2UgYXJlIG5vdCB1c2luZyAkLmZuLmNsb3Nlc3QoKSBvbiBwdXJwb3NlIGhlcmUgYmVjYXVzZSB0aGlzCgkJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJCS8vIGFzIHBvc3NpYmxlLgoKCQkJdmFyIGUgPSBlbFsgMCBdLAoJCQkJbHRyID0gIiIsCgkJCQlyZSA9IC91aS0oYmFyfGJvZHkpLShbYS16XSlcYi8sCgkJCQljLCBtOwoKCQkJd2hpbGUgKCBlICkgewoJCQkJdmFyIGMgPSBlLmNsYXNzTmFtZSB8fCAiIjsKCQkJCWlmICggKCBtID0gcmUuZXhlYyggYyApICkgJiYgKCBsdHIgPSBtWyAyIF0gKSApIHsKCQkJCQkvLyBXZSBmb3VuZCBhIHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3MKCQkJCQkvLyBvbiBpdCBzbyBiYWlsIGZyb20gdGhpcyBsb29wLgoJCQkJCWJyZWFrOwoJCQkJfQoJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJfQoJCQkKCQkJLy8gUmV0dXJuIHRoZSB0aGVtZSBsZXR0ZXIgd2UgZm91bmQsIGlmIG5vbmUsIHJldHVybiB0aGUKCQkJLy8gc3BlY2lmaWVkIGRlZmF1bHQuCgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfQoJfSk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuanFtRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5mbi5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCkgewoJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCX07CgoJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKTsKCgkJKCAkZWxlbS5qcW1EYXRhKCdkZXBlbmRlbnRzJykgfHwgJCgpICkucmVtb3ZlKCk7CgkJJGVsZW0ucmVtb3ZlKCk7Cgl9OwoKCSQuZm4uYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuZXdEZXBlbmRlbnRzICkgewoJCSQuYWRkRGVwZW5kZW50cyggJCh0aGlzKSwgbmV3RGVwZW5kZW50cyApOwoJfTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgZGVwZW5kZW50cyA9ICQoZWxlbSkuanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpOwoKCQkkKGVsZW0pLmpxbURhdGEoICdkZXBlbmRlbnRzJywgJC5tZXJnZShkZXBlbmRlbnRzLCBuZXdEZXBlbmRlbnRzKSApOwoJfTsKCgkvLyBub3RlIHRoYXQgdGhpcyBoZWxwZXIgZG9lc24ndCBhdHRlbXB0IHRvIGhhbmRsZSB0aGUgY2FsbGJhY2sKCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50cyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkvLyB0byByZXR1cm4gdGhlIGh0bWwgZW5jb2RlZCB2ZXJzaW9uIG9mIHRoZSB0ZXh0IGluIGFsbCBjYXNlcy4gKHRodXMgdGhlIG5hbWUpCgkkLmZuLmdldEVuY29kZWRUZXh0ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICkudGV4dCggJCh0aGlzKS50ZXh0KCkgKS5odG1sKCk7Cgl9OwoKCS8vIE1vbmtleS1wYXRjaGluZyBTaXp6bGUgdG8gZmlsdGVyIHRoZSA6anFtRGF0YSBzZWxlY3RvcgoJdmFyIG9sZEZpbmQgPSAkLmZpbmQsCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCgkJcmV0dXJuIG9sZEZpbmQuY2FsbCggdGhpcywgc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKTsKCX07CgoJJC5leHRlbmQoICQuZmluZCwgb2xkRmluZCApOwoKCSQuZmluZC5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIHNldCApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBzZXQgKTsKCX07CgoJJC5maW5kLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBub2RlLCBleHByICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIFsgbm9kZSBdICkubGVuZ3RoID4gMDsKCX07Cn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogY29yZSB1dGlsaXRpZXMgZm9yIGF1dG8gYWpheCBuYXZpZ2F0aW9uLCBiYXNlIHRhZyBtZ210LAoqLwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgl2YXIgJHdpbmRvdyA9ICQoIHdpbmRvdyApLAoJCSRodG1sID0gJCggJ2h0bWwnICksCgkJJGhlYWQgPSAkKCAnaGVhZCcgKSwKCgkJLy91cmwgcGF0aCBoZWxwZXJzIGZvciB1c2UgaW4gcmVsYXRpdmUgdXJsIG1hbmFnZW1lbnQKCQlwYXRoID0gewoKCQkJLy8gVGhpcyBzY2FyeSBsb29raW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiBwYXJzZXMgYW4gYWJzb2x1dGUgVVJMIG9yIGl0cyByZWxhdGl2ZQoJCQkvLyB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgYW5kIGhhc2gpLCBpbnRvIHRoZSB2YXJpb3VzCgkJCS8vIGNvbXBvbmVudHMgKHByb3RvY29sLCBob3N0LCBwYXRoLCBxdWVyeSwgZnJhZ21lbnQsIGV0YyB0aGF0IG1ha2UgdXAgdGhlCgkJCS8vIFVSTCBhcyB3ZWxsIGFzIHNvbWUgb3RoZXIgY29tbW9ubHkgdXNlZCBzdWItcGFydHMuIFdoZW4gdXNlZCB3aXRoIFJlZ0V4cC5leGVjKCkKCQkJLy8gb3IgU3RyaW5nLm1hdGNoLCBpdCBwYXJzZXMgdGhlIFVSTCBpbnRvIGEgcmVzdWx0cyBhcnJheSB0aGF0IGxvb2tzIGxpa2UgdGhpczoKCQkJLy8KCQkJLy8gICAgIFswXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkI21zZy1jb250ZW50CgkJCS8vICAgICBbMV06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICAgWzJdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3gKCQkJLy8gICAgIFszXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzRdOiBodHRwOgoJCQkvLyAgICAgWzVdOiAvLwoJCQkvLyAgICAgWzZdOiBqYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs3XTogamJsYXM6cGFzc3dvcmQKCQkJLy8gICAgIFs4XTogamJsYXMKCQkJLy8gICAgIFs5XTogcGFzc3dvcmQKCQkJLy8gICAgWzEwXTogbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgIFsxMV06IG15Y29tcGFueS5jb20KCQkJLy8gICAgWzEyXTogODA4MAoJCQkvLyAgICBbMTNdOiAvbWFpbC9pbmJveAoJCQkvLyAgICBbMTRdOiAvbWFpbC8KCQkJLy8gICAgWzE1XTogaW5ib3gKCQkJLy8gICAgWzE2XTogP21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgIFsxN106ICNtc2ctY29udGVudAoJCQkvLwoJCQl1cmxQYXJzZVJFOiAvXigoKChbXjpcLyNcP10rOik/KD86KFwvXC8pKCg/OigoW146QFwvI1w/XSspKD86XDooW146QFwvI1w/XSspKT8pQCk/KChbXjpcLyNcP1xdXFtdK3xcW1teXC9cXUAjP10rXF0pKD86XDooWzAtOV0rKSk/KSk/KT8pPygoXC8/KD86W15cL1w/I10rXC8rKSopKFteXD8jXSopKSk/KFw/W14jXSspPykoIy4qKT8vLAoKCQkJLy9QYXJzZSBhIFVSTCBpbnRvIGEgc3RydWN0dXJlIHRoYXQgYWxsb3dzIGVhc3kgYWNjZXNzIHRvCgkJCS8vYWxsIG9mIHRoZSBVUkwgY29tcG9uZW50cyBieSBuYW1lLgoJCQlwYXJzZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIElmIHdlJ3JlIHBhc3NlZCBhbiBvYmplY3QsIHdlJ2xsIGFzc3VtZSB0aGF0IGl0IGlzCgkJCQkvLyBhIHBhcnNlZCB1cmwgb2JqZWN0IGFuZCBqdXN0IHJldHVybiBpdCBiYWNrIHRvIHRoZSBjYWxsZXIuCgkJCQlpZiAoICQudHlwZSggdXJsICkgPT09ICJvYmplY3QiICkgewoJCQkJCXJldHVybiB1cmw7CgkJCQl9CgoJCQkJdmFyIG1hdGNoZXMgPSBwYXRoLnVybFBhcnNlUkUuZXhlYyggdXJsIHx8ICIiICkgfHwgW107CgoJCQkJCS8vIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhbGxvd3MgdGhlIGNhbGxlciB0byBhY2Nlc3MgdGhlIHN1Yi1tYXRjaGVzCgkJCQkJLy8gYnkgbmFtZS4gTm90ZSB0aGF0IElFIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nIGluc3RlYWQgb2YgdW5kZWZpbmVkLAoJCQkJCS8vIGxpa2UgYWxsIG90aGVyIGJyb3dzZXJzIGRvLCBzbyB3ZSBub3JtYWxpemUgZXZlcnl0aGluZyBzbyBpdHMgY29uc2lzdGVudAoJCQkJCS8vIG5vIG1hdHRlciB3aGF0IGJyb3dzZXIgd2UncmUgcnVubmluZyBvbi4KCQkJCQlyZXR1cm4gewoJCQkJCQlocmVmOiAgICAgICAgIG1hdGNoZXNbICAwIF0gfHwgIiIsCgkJCQkJCWhyZWZOb0hhc2g6ICAgbWF0Y2hlc1sgIDEgXSB8fCAiIiwKCQkJCQkJaHJlZk5vU2VhcmNoOiBtYXRjaGVzWyAgMiBdIHx8ICIiLAoJCQkJCQlkb21haW46ICAgICAgIG1hdGNoZXNbICAzIF0gfHwgIiIsCgkJCQkJCXByb3RvY29sOiAgICAgbWF0Y2hlc1sgIDQgXSB8fCAiIiwKCQkJCQkJZG91YmxlU2xhc2g6ICBtYXRjaGVzWyAgNSBdIHx8ICIiLAoJCQkJCQlhdXRob3JpdHk6ICAgIG1hdGNoZXNbICA2IF0gfHwgIiIsCgkJCQkJCXVzZXJuYW1lOiAgICAgbWF0Y2hlc1sgIDggXSB8fCAiIiwKCQkJCQkJcGFzc3dvcmQ6ICAgICBtYXRjaGVzWyAgOSBdIHx8ICIiLAoJCQkJCQlob3N0OiAgICAgICAgIG1hdGNoZXNbIDEwIF0gfHwgIiIsCgkJCQkJCWhvc3RuYW1lOiAgICAgbWF0Y2hlc1sgMTEgXSB8fCAiIiwKCQkJCQkJcG9ydDogICAgICAgICBtYXRjaGVzWyAxMiBdIHx8ICIiLAoJCQkJCQlwYXRobmFtZTogICAgIG1hdGNoZXNbIDEzIF0gfHwgIiIsCgkJCQkJCWRpcmVjdG9yeTogICAgbWF0Y2hlc1sgMTQgXSB8fCAiIiwKCQkJCQkJZmlsZW5hbWU6ICAgICBtYXRjaGVzWyAxNSBdIHx8ICIiLAoJCQkJCQlzZWFyY2g6ICAgICAgIG1hdGNoZXNbIDE2IF0gfHwgIiIsCgkJCQkJCWhhc2g6ICAgICAgICAgbWF0Y2hlc1sgMTcgXSB8fCAiIgoJCQkJCX07CgkJCX0sCgoJCQkvL1R1cm4gcmVsUGF0aCBpbnRvIGFuIGFzYm9sdXRlIHBhdGguIGFic1BhdGggaXMKCQkJLy9hbiBvcHRpb25hbCBhYnNvbHV0ZSBwYXRoIHdoaWNoIGRlc2NyaWJlcyB3aGF0CgkJCS8vcmVsUGF0aCBpcyByZWxhdGl2ZSB0by4KCQkJbWFrZVBhdGhBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFBhdGgsIGFic1BhdGggKSB7CgkJCQlpZiAoIHJlbFBhdGggJiYgcmVsUGF0aC5jaGFyQXQoIDAgKSA9PT0gIi8iICkgewoJCQkJCXJldHVybiByZWxQYXRoOwoJCQkJfQoKCQkJCXJlbFBhdGggPSByZWxQYXRoIHx8ICIiOwoJCQkJYWJzUGF0aCA9IGFic1BhdGggPyBhYnNQYXRoLnJlcGxhY2UoIC9eXC98KFwvW15cL10qfFteXC9dKykkL2csICIiICkgOiAiIjsKCgkJCQl2YXIgYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXSwKCQkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGQgPSByZWxTdGFja1sgaSBdOwoJCQkJCXN3aXRjaCAoIGQgKSB7CgkJCQkJCWNhc2UgIi4iOgoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIi4uIjoKCQkJCQkJCWlmICggYWJzU3RhY2subGVuZ3RoICkgewoJCQkJCQkJCWFic1N0YWNrLnBvcCgpOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlhYnNTdGFjay5wdXNoKCBkICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gIi8iICsgYWJzU3RhY2suam9pbiggIi8iICk7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBpZiBib3RoIHVybHMgaGF2ZSB0aGUgc2FtZSBkb21haW4uCgkJCWlzU2FtZURvbWFpbjogZnVuY3Rpb24oIGFic1VybDEsIGFic1VybDIgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggYWJzVXJsMSApLmRvbWFpbiA9PT0gcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbnkgcmVsYXRpdmUgdmFyaWFudC4KCQkJaXNSZWxhdGl2ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIEFsbCByZWxhdGl2ZSBVcmwgdmFyaWFudHMgaGF2ZSBvbmUgdGhpbmcgaW4gY29tbW9uLCBubyBwcm90b2NvbC4KCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCA9PT0gIiI7CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW4gYWJzb2x1dGUgdXJsLgoJCQlpc0Fic29sdXRlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sICE9PSAiIjsKCQkJfSwKCgkJCS8vVHVybiB0aGUgc3BlY2lmaWVkIHJlYWx0aXZlIFVSTCBpbnRvIGFuIGFic29sdXRlIG9uZS4gVGhpcyBmdW5jdGlvbgoJCQkvL2NhbiBoYW5kbGUgYWxsIHJlbGF0aXZlIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBmcmFnbWVudCkuCgkJCW1ha2VVcmxBYnNvbHV0ZTogZnVuY3Rpb24oIHJlbFVybCwgYWJzVXJsICkgewoJCQkJaWYgKCAhcGF0aC5pc1JlbGF0aXZlVXJsKCByZWxVcmwgKSApIHsKCQkJCQlyZXR1cm4gcmVsVXJsOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJICAgIC8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCSAgICAvLyBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0ucmVwbGFjZSggL14jLywgIiIgKTsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNTYW1lRG9tYWluKCB1LCBkb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCQl9CgkJCQlyZXR1cm4gYWJzVXJsOwoJCQl9LAoKCQkJLy9nZXQgcGF0aCBmcm9tIGN1cnJlbnQgaGFzaCwgb3IgZnJvbSBhIGZpbGUgcGF0aAoJCQlnZXQ6IGZ1bmN0aW9uKCBuZXdQYXRoICkgewoJCQkJaWYoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gbG9jYXRpb24uaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgJycgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICcmJyArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIGRvY3VtZW50QmFzZS5kb21haW4sICIiICk7CgkJCX0sCgoJCQkvL2p1c3QgcmV0dXJuIHRoZSB1cmwgd2l0aG91dCBhbiBpbml0aWFsICMKCQkJc3RyaXBIYXNoOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXiMvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IGRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBkb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkJLy8gZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoL14jLykudGVzdCggdS5ocmVmICk7CgkJCX0KCQl9LAoKCQkvL3dpbGwgYmUgZGVmaW5lZCB3aGVuIGEgbGluayBpcyBjbGlja2VkIGFuZCBnaXZlbiBhbiBhY3RpdmUgY2xhc3MKCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsLAoKCQkvL3VybEhpc3RvcnkgaXMgcHVyZWx5IGhlcmUgdG8gbWFrZSBndWVzc2VzIGF0IHdoZXRoZXIgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gd2FzIGNsaWNrZWQKCQkvL2FuZCBwcm92aWRlIGFuIGFwcHJvcHJpYXRlIHRyYW5zaXRpb24KCQl1cmxIaXN0b3J5ID0gewoJCQkvLyBBcnJheSBvZiBwYWdlcyB0aGF0IGFyZSB2aXNpdGVkIGR1cmluZyBhIHNpbmdsZSBwYWdlIGxvYWQuCgkJCS8vIEVhY2ggaGFzIGEgdXJsIGFuZCBvcHRpb25hbCB0cmFuc2l0aW9uLCB0aXRsZSwgYW5kIHBhZ2VVcmwgKHdoaWNoIHJlcHJlc2VudHMgdGhlIGZpbGUgcGF0aCwgaW4gY2FzZXMgd2hlcmUgVVJMIGlzIG9ic2N1cmVkLCBzdWNoIGFzIGRpYWxvZ3MpCgkJCXN0YWNrOiBbXSwKCgkJCS8vbWFpbnRhaW4gYW4gaW5kZXggbnVtYmVyIGZvciB0aGUgYWN0aXZlIHBhZ2UgaW4gdGhlIHN0YWNrCgkJCWFjdGl2ZUluZGV4OiAwLAoKCQkJLy9nZXQgYWN0aXZlCgkJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdXJsSGlzdG9yeS5zdGFja1sgdXJsSGlzdG9yeS5hY3RpdmVJbmRleCBdOwoJCQl9LAoKCQkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdXJsSGlzdG9yeS5zdGFja1sgdXJsSGlzdG9yeS5hY3RpdmVJbmRleCAtIDEgXTsKCQkJfSwKCgkJCWdldE5leHQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggKyAxIF07CgkJCX0sCgoJCQkvLyBhZGROZXcgaXMgdXNlZCB3aGVuZXZlciBhIG5ldyBwYWdlIGlzIGFkZGVkCgkJCWFkZE5ldzogZnVuY3Rpb24oIHVybCwgdHJhbnNpdGlvbiwgdGl0bGUsIHBhZ2VVcmwsIHJvbGUgKSB7CgkJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCQlpZiggdXJsSGlzdG9yeS5nZXROZXh0KCkgKSB7CgkJCQkJdXJsSGlzdG9yeS5jbGVhckZvcndhcmQoKTsKCQkJCX0KCgkJCQl1cmxIaXN0b3J5LnN0YWNrLnB1c2goIHt1cmwgOiB1cmwsIHRyYW5zaXRpb246IHRyYW5zaXRpb24sIHRpdGxlOiB0aXRsZSwgcGFnZVVybDogcGFnZVVybCwgcm9sZTogcm9sZSB9ICk7CgoJCQkJdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9IHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoIC0gMTsKCQkJfSwKCgkJCS8vd2lwZSB1cmxzIGFoZWFkIG9mIGFjdGl2ZSBpbmRleAoJCQljbGVhckZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQkJdXJsSGlzdG9yeS5zdGFjayA9IHVybEhpc3Rvcnkuc3RhY2suc2xpY2UoIDAsIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggKyAxICk7CgkJCX0sCgoJCQlkaXJlY3RIYXNoQ2hhbmdlOiBmdW5jdGlvbiggb3B0cyApIHsKCQkJCXZhciBiYWNrICwgZm9yd2FyZCwgbmV3QWN0aXZlSW5kZXgsIHByZXYgPSB0aGlzLmdldEFjdGl2ZSgpOwoKCQkJCS8vIGNoZWNrIGlmIHVybCBpc3AgaW4gaGlzdG9yeSBhbmQgaWYgaXQncyBhaGVhZCBvciBiZWhpbmQgY3VycmVudCBwYWdlCgkJCQkkLmVhY2goIHVybEhpc3Rvcnkuc3RhY2ssIGZ1bmN0aW9uKCBpLCBoaXN0b3J5RW50cnkgKSB7CgoJCQkJCS8vaWYgdGhlIHVybCBpcyBpbiB0aGUgc3RhY2ssIGl0J3MgYSBmb3J3YXJkIG9yIGEgYmFjawoJCQkJCWlmKCBvcHRzLmN1cnJlbnRVcmwgPT09IGhpc3RvcnlFbnRyeS51cmwgKSB7CgkJCQkJCS8vZGVmaW5lIGJhY2sgYW5kIGZvcndhcmQgYnkgd2hldGhlciB1cmwgaXMgb2xkZXIgb3IgbmV3ZXIgdGhhbiBjdXJyZW50IHBhZ2UKCQkJCQkJYmFjayA9IGkgPCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4OwoJCQkJCQlmb3J3YXJkID0gIWJhY2s7CgkJCQkJCW5ld0FjdGl2ZUluZGV4ID0gaTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBzYXZlIG5ldyBwYWdlIGluZGV4LCBudWxsIGNoZWNrIHRvIHByZXZlbnQgZmFsc2V5IDAgcmVzdWx0CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXggIT09IHVuZGVmaW5lZCA/IG5ld0FjdGl2ZUluZGV4IDogdGhpcy5hY3RpdmVJbmRleDsKCgkJCQlpZiggYmFjayApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNCYWNrICkoIHRydWUgKTsKCQkJCX0gZWxzZSBpZiggZm9yd2FyZCApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNGb3J3YXJkICkoIGZhbHNlICk7CgkJCQl9CgkJCX0sCgoJCQkvL2Rpc2FibGUgaGFzaGNoYW5nZSBldmVudCBsaXN0ZW5lciBpbnRlcm5hbGx5IHRvIGlnbm9yZSBvbmUgY2hhbmdlCgkJCS8vdG9nZ2xlZCBpbnRlcm5hbGx5IHdoZW4gbG9jYXRpb24uaGFzaCBpcyB1cGRhdGVkIHRvIG1hdGNoIHRoZSB1cmwgb2YgYSBzdWNjZXNzZnVsIHBhZ2UgbG9hZAoJCQlpZ25vcmVOZXh0SGFzaENoYW5nZTogZmFsc2UKCQl9LAoKCQkvL2RlZmluZSBmaXJzdCBzZWxlY3RvciB0byByZWNlaXZlIGZvY3VzIHdoZW4gYSBwYWdlIGlzIHNob3duCgkJZm9jdXNhYmxlID0gIlt0YWJpbmRleF0sYSxidXR0b246dmlzaWJsZSxzZWxlY3Q6dmlzaWJsZSxpbnB1dCIsCgoJCS8vcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJCXBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy9pbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2UsCgoJCS8vbm9uc2Vuc2UgaGFzaCBjaGFuZ2Uga2V5IGZvciBkaWFsb2dzLCBzbyB0aGV5IGNyZWF0ZSBhIGhpc3RvcnkgZW50cnkKCQlkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciLAoKCQkvL2V4aXN0aW5nIGJhc2UgdGFnPwoJCSRiYXNlID0gJGhlYWQuY2hpbGRyZW4oICJiYXNlIiApLAoKCQkvL3R1Y2sgYXdheSB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgVVJMIG1pbnVzIGFueSBmcmFnbWVudC4KCQlkb2N1bWVudFVybCA9IHBhdGgucGFyc2VVcmwoIGxvY2F0aW9uLmhyZWYgKSwKCgkJLy9pZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGVtYmVkZGVkIGJhc2UgdGFnLCBkb2N1bWVudEJhc2UgaXMgc2V0IHRvIGl0cwoJCS8vaW5pdGlhbCB2YWx1ZS4gSWYgYSBiYXNlIHRhZyBkb2VzIG5vdCBleGlzdCwgdGhlbiB3ZSBkZWZhdWx0IHRvIHRoZSBkb2N1bWVudFVybC4KCQlkb2N1bWVudEJhc2UgPSAkYmFzZS5sZW5ndGggPyBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGJhc2UuYXR0ciggImhyZWYiICksIGRvY3VtZW50VXJsLmhyZWYgKSApIDogZG9jdW1lbnRVcmwsCgoJCS8vY2FjaGUgdGhlIGNvbXBhcmlzb24gb25jZS4KCQlkb2N1bWVudEJhc2VEaWZmZXJzID0gKCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICE9PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApOwoKCQkvL2Jhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCQl2YXIgYmFzZSA9ICQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyA/IHsKCgkJCS8vZGVmaW5lIGJhc2UgZWxlbWVudCwgZm9yIHVzZSBpbiByb3V0aW5nIGFzc2V0IHVybHMgdGhhdCBhcmUgcmVmZXJlbmNlZCBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQkJZWxlbWVudDogKCAkYmFzZS5sZW5ndGggPyAkYmFzZSA6ICQoICI8YmFzZT4iLCB7IGhyZWY6IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoIH0gKS5wcmVwZW5kVG8oICRoZWFkICkgKSwKCgkJCS8vc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiBhdHRyaWJ1dGUgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBocmVmICkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwgcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGRvY3VtZW50QmFzZSApICk7CgkJCX0sCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwgZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKTsKCQkJfQoKCQl9IDogdW5kZWZpbmVkOwoKLyoKCWludGVybmFsIHV0aWxpdHkgZnVuY3Rpb25zCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy9kaXJlY3QgZm9jdXMgdG8gdGhlIHBhZ2UgdGl0bGUsIG9yIG90aGVyd2lzZSBmaXJzdCBmb2N1c2FibGUgZWxlbWVudAoJZnVuY3Rpb24gcmVGb2N1cyggcGFnZSApIHsKCQl2YXIgcGFnZVRpdGxlID0gcGFnZS5maW5kKCAiLnVpLXRpdGxlOmVxKDApIiApOwoKCQlpZiggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfQoJCWVsc2V7CgkJCXBhZ2UuZm9jdXMoKTsKCQl9Cgl9CgoJLy9yZW1vdmUgYWN0aXZlIGNsYXNzZXMgYWZ0ZXIgcGFnZSB0cmFuc2l0aW9uIG9yIGVycm9yCglmdW5jdGlvbiByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIGZvcmNlUmVtb3ZhbCApIHsKCQlpZiggISEkYWN0aXZlQ2xpY2tlZExpbmsgJiYgKCAhJGFjdGl2ZUNsaWNrZWRMaW5rLmNsb3Nlc3QoICcudWktcGFnZS1hY3RpdmUnICkubGVuZ3RoIHx8IGZvcmNlUmVtb3ZhbCApICkgewoJCQkkYWN0aXZlQ2xpY2tlZExpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfQoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGw7Cgl9CgoJZnVuY3Rpb24gcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpIHsKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJaWYoIHBhZ2VUcmFuc2l0aW9uUXVldWUubGVuZ3RoID4gMCApIHsKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZS5hcHBseSggbnVsbCwgcGFnZVRyYW5zaXRpb25RdWV1ZS5wb3AoKSApOwoJCX0KCX0KCgkvLyBTYXZlIHRoZSBsYXN0IHNjcm9sbCBkaXN0YW5jZSBwZXIgcGFnZSwgYmVmb3JlIGl0IGlzIGhpZGRlbgoJdmFyIHNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZSwKCQlmaXJzdFNjcm9sbEVsZW0sIGdldFNjcm9sbEVsZW0sIHNldExhc3RTY3JvbGwsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsOwoKCWdldFNjcm9sbEVsZW0gPSBmdW5jdGlvbigpIHsKCQl2YXIgc2Nyb2xsRWxlbSA9ICR3aW5kb3csIGFjdGl2ZVBhZ2UsCgkJCXRvdWNoT3ZlcmZsb3cgPSAkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyAmJiAkLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZDsKCgkJaWYoIHRvdWNoT3ZlcmZsb3cgKXsKCQkJYWN0aXZlUGFnZSA9ICQoICIudWktcGFnZS1hY3RpdmUiICk7CgkJCXNjcm9sbEVsZW0gPSBhY3RpdmVQYWdlLmlzKCAiLnVpLW5hdGl2ZS1maXhlZCIgKSA/IGFjdGl2ZVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApIDogYWN0aXZlUGFnZTsKCQl9CgoJCXJldHVybiBzY3JvbGxFbGVtOwoJfTsKCglzZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oIHNjcm9sbEVsZW0gKSB7CgkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbiB0aGUgYnJvd3NlcgoJCS8vIHNjcm9sbGluZyB0aGUgd2luZG93IGJhc2VkIG9uIGEgaGFzaGNoYW5nZQoJCWlmKCAhc2V0TGFzdFNjcm9sbEVuYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQlpZiggYWN0aXZlICkgewoJCQl2YXIgbGFzdFNjcm9sbCA9IHNjcm9sbEVsZW0gJiYgc2Nyb2xsRWxlbS5zY3JvbGxUb3AoKTsKCgkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4KCQkJLy8gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlIHNjcm9sbGluZyB0byBpcyBsZXNzIHRoYW4gbWluU2Nyb2xsQmFjaywgbGV0IGl0IGdvLgoJCQlhY3RpdmUubGFzdFNjcm9sbCA9IGxhc3RTY3JvbGwgPCAkLm1vYmlsZS5taW5TY3JvbGxCYWNrID8gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgOiBsYXN0U2Nyb2xsOwoJCX0KCX07CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIHRvIGdhdGhlciBzY3JvbGwgcG9zaXRpb24uIFRoZSBkZWxheSBhbGxvd3MgZm9yIHRoZSBoYXNoY2hhbmdlCgkvLyBldmVudCB0byBmaXJlIGFuZCBkaXNhYmxlIHNjcm9sbCByZWNvcmRpbmcgaW4gdGhlIGNhc2Ugd2hlcmUgdGhlIGJyb3dzZXIgc2Nyb2xscwoJLy8gdG8gdGhlIGhhc2ggdGFyZ2V0cyBsb2NhdGlvbiAoc29tZXRpbWVzIHRoZSB0b3Agb2YgdGhlIHBhZ2UpLiBvbmNlIHBhZ2VjaGFuZ2UgZmlyZXMKCS8vIGdldExhc3RTY3JvbGwgaXMgYWdhaW4gcGVybWl0dGVkIHRvIG9wZXJhdGUKCWRlbGF5ZWRTZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJc2V0VGltZW91dCggc2V0TGFzdFNjcm9sbCwgMTAwLCAkKHRoaXMpICk7Cgl9OwoKCS8vIGRpc2FibGUgYW4gc2Nyb2xsIHNldHRpbmcgd2hlbiBhIGhhc2hjaGFuZ2UgaGFzIGJlZW4gZmlyZWQsIHRoaXMgb25seSB3b3JrcwoJLy8gYmVjYXVzZSB0aGUgcmVjb3JkaW5nIG9mIHRoZSBzY3JvbGwgcG9zaXRpb24gaXMgZGVsYXllZCBmb3IgMTAwbXMgYWZ0ZXIKCS8vIHRoZSBicm93c2VyIG1pZ2h0IGhhdmUgY2hhbmdlZCB0aGUgcG9zaXRpb24gYmVjYXVzZSBvZiB0aGUgaGFzaGNoYW5nZQoJJHdpbmRvdy5iaW5kKCAkLnN1cHBvcnQucHVzaFN0YXRlID8gInBvcHN0YXRlIiA6ICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkgCXNldExhc3RTY3JvbGxFbmFibGVkID0gZmFsc2U7Cgl9KTsKCgkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkkd2luZG93Lm9uZSggJC5zdXBwb3J0LnB1c2hTdGF0ZSA/ICJwb3BzdGF0ZSIgOiAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCkgewoJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCX0pOwoKCS8vIHdhaXQgdW50aWwgdGhlIG1vYmlsZSBwYWdlIGNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIHRvIGJpbmQgdG8gcGFnZWNoYW5nZQoJJHdpbmRvdy5vbmUoICJwYWdlY29udGFpbmVyY3JlYXRlIiwgZnVuY3Rpb24oKXsKCQkvLyBvbmNlIHRoZSBwYWdlIGhhcyBjaGFuZ2VkLCByZS1lbmFibGUgdGhlIHNjcm9sbCByZWNvcmRpbmcKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmJpbmQoICJwYWdlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkJCXZhciBzY3JvbGxFbGVtID0gZ2V0U2Nyb2xsRWxlbSgpOwoKCSAJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQgZGV0ZXJtaW5lZCBmb3IKCQkJLy8gdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJc2Nyb2xsRWxlbS51bmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkJCS8vIGRldGVybWluZSBhbmQgYmluZCB0byB0aGUgY3VycmVudCBzY29sbCBlbGVtZW50IHdoaWNoIG1heSBiZSB0aGUgd2luZG93CgkJCS8vIG9yIGluIHRoZSBjYXNlIG9mIHRvdWNoIG92ZXJmbG93IHRoZSBlbGVtZW50IHdpdGggdG91Y2ggb3ZlcmZsb3cKCQkJc2Nyb2xsRWxlbS5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgkJfSk7Cgl9KTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlIGFzICJwYWdlY2hhbmdlIiB3b24ndCBiZSBmaXJlZCBpbiB0aGF0IGNhc2UKCWdldFNjcm9sbEVsZW0oKS5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgoJLy8gTWFrZSB0aGUgaU9TIGNsb2NrIHF1aWNrLXNjcm9sbCB3b3JrIGFnYWluIGlmIHdlJ3JlIHVzaW5nIG5hdGl2ZSBvdmVyZmxvdyBzY3JvbGxpbmcKCS8qCglpZiggJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgKXsKCQlpZiggJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgKXsKCQkJJCggd2luZG93ICkuYmluZCggInNjcm9sbHN0b3AiLCBmdW5jdGlvbigpewoJCQkJaWYoICQoIHRoaXMgKS5zY3JvbGxUb3AoKSA9PT0gMCApewoJCQkJCSQubW9iaWxlLmFjdGl2ZVBhZ2Uuc2Nyb2xsVG9wKCAwICk7CgkJCQl9CgkJCX0pOwoJCX0KCX0KCSovCgoJLy9mdW5jdGlvbiBmb3IgdHJhbnNpdGlvbmluZyBiZXR3ZWVuIHR3byBleGlzdGluZyBwYWdlcwoJZnVuY3Rpb24gdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCB0cmFuc2l0aW9uLCByZXZlcnNlICkgewoKCQkvL2dldCBjdXJyZW50IHNjcm9sbCBkaXN0YW5jZQoJCXZhciBhY3RpdmUJPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpLAoJCQl0b3VjaE92ZXJmbG93ID0gJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQsCgkJCXRvU2Nyb2xsID0gYWN0aXZlLmxhc3RTY3JvbGwgfHwgKCB0b3VjaE92ZXJmbG93ID8gMCA6ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICksCgkJCXNjcmVlbkhlaWdodCA9IGdldFNjcmVlbkhlaWdodCgpOwoKCQkvLyBTY3JvbGwgdG8gdG9wLCBoaWRlIGFkZHIgYmFyCgkJd2luZG93LnNjcm9sbFRvKCAwLCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApOwoKCQlpZiggZnJvbVBhZ2UgKSB7CgkJCS8vdHJpZ2dlciBiZWZvcmUgc2hvdy9oaWRlIGV2ZW50cwoJCQlmcm9tUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZWhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCX0KCgkJaWYoICF0b3VjaE92ZXJmbG93KXsKCQkJdG9QYWdlLmhlaWdodCggc2NyZWVuSGVpZ2h0ICsgdG9TY3JvbGwgKTsKCQl9CgoJCXRvUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZXNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCgkJLy9jbGVhciBwYWdlIGxvYWRlcgoJCSQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZygpOwoKCQlpZiggdG91Y2hPdmVyZmxvdyAmJiB0b1Njcm9sbCApewoKCQkJdG9QYWdlLmFkZENsYXNzKCAidWktbW9iaWxlLXByZS10cmFuc2l0aW9uIiApOwoJCQkvLyBTZW5kIGZvY3VzIHRvIHBhZ2UgYXMgaXQgaXMgbm93IGRpc3BsYXk6IGJsb2NrCgkJCXJlRm9jdXMoIHRvUGFnZSApOwoKCQkJLy9zZXQgcGFnZSdzIHNjcm9sbFRvcCB0byByZW1lbWJlcmVkIGRpc3RhbmNlCgkJCWlmKCB0b1BhZ2UuaXMoICIudWktbmF0aXZlLWZpeGVkIiApICl7CgkJCQl0b1BhZ2UuZmluZCggIi51aS1jb250ZW50IiApLnNjcm9sbFRvcCggdG9TY3JvbGwgKTsKCQkJfQoJCQllbHNlewoJCQkJdG9QYWdlLnNjcm9sbFRvcCggdG9TY3JvbGwgKTsKCQkJfQoJCX0KCgkJLy9maW5kIHRoZSB0cmFuc2l0aW9uIGhhbmRsZXIgZm9yIHRoZSBzcGVjaWZpZWQgdHJhbnNpdGlvbi4gSWYgdGhlcmUKCQkvL2lzbid0IG9uZSBpbiBvdXIgdHJhbnNpdGlvbkhhbmRsZXJzIGRpY3Rpb25hcnksIHVzZSB0aGUgZGVmYXVsdCBvbmUuCgkJLy9jYWxsIHRoZSBoYW5kbGVyIGltbWVkaWF0ZWx5IHRvIGtpY2stb2ZmIHRoZSB0cmFuc2l0aW9uLgoJCXZhciB0aCA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVyc1t0cmFuc2l0aW9uIHx8ICJub25lIl0gfHwgJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyLAoJCQlwcm9taXNlID0gdGgoIHRyYW5zaXRpb24sIHJldmVyc2UsIHRvUGFnZSwgZnJvbVBhZ2UgKTsKCgkJcHJvbWlzZS5kb25lKGZ1bmN0aW9uKCkgewoJCQkvL3Jlc2V0IHRvUGFnZSBoZWlnaHQgYmFjawoJCQlpZiggIXRvdWNoT3ZlcmZsb3cgKXsKCQkJCXRvUGFnZS5oZWlnaHQoICIiICk7CgkJCQkvLyBTZW5kIGZvY3VzIHRvIHRoZSBuZXdseSBzaG93biBwYWdlCgkJCQlyZUZvY3VzKCB0b1BhZ2UgKTsKCQkJfQoKCQkJLy8gSnVtcCB0byB0b3Agb3IgcHJldiBzY3JvbGwsIHNvbWV0aW1lcyBvbiBpT1MgdGhlIHBhZ2UgaGFzIG5vdCByZW5kZXJlZCB5ZXQuCgkJCWlmKCAhdG91Y2hPdmVyZmxvdyApewoJCQkJJC5tb2JpbGUuc2lsZW50U2Nyb2xsKCB0b1Njcm9sbCApOwoJCQl9CgoJCQkvL3RyaWdnZXIgc2hvdy9oaWRlIGV2ZW50cwoJCQlpZiggZnJvbVBhZ2UgKSB7CgkJCQlpZiggIXRvdWNoT3ZlcmZsb3cgKXsKCQkJCQlmcm9tUGFnZS5oZWlnaHQoICIiICk7CgkJCQl9CgoJCQkJZnJvbVBhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJoaWRlIiwgbnVsbCwgeyBuZXh0UGFnZTogdG9QYWdlIH0gKTsKCQkJfQoKCQkJLy90cmlnZ2VyIHBhZ2VzaG93LCBkZWZpbmUgcHJldlBhZ2UgYXMgZWl0aGVyIGZyb21QYWdlIG9yIGVtcHR5IGpRdWVyeSBvYmoKCQkJdG9QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAic2hvdyIsIG51bGwsIHsgcHJldlBhZ2U6IGZyb21QYWdlIHx8ICQoICIiICkgfSApOwoJCX0pOwoKCQlyZXR1cm4gcHJvbWlzZTsKCX0KCgkvL3NpbXBseSBzZXQgdGhlIGFjdGl2ZSBwYWdlJ3MgbWluaW11bSBoZWlnaHQgdG8gc2NyZWVuIGhlaWdodCwgZGVwZW5kaW5nIG9uIG9yaWVudGF0aW9uCglmdW5jdGlvbiBnZXRTY3JlZW5IZWlnaHQoKXsKCQl2YXIgb3JpZW50YXRpb24gCT0gJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCksCgkJCXBvcnQJCQk9IG9yaWVudGF0aW9uID09PSAicG9ydHJhaXQiLAoJCQl3aW5NaW4JCQk9IHBvcnQgPyA0ODAgOiAzMjAsCgkJCXNjcmVlbkhlaWdodAk9IHBvcnQgPyBzY3JlZW4uYXZhaWxIZWlnaHQgOiBzY3JlZW4uYXZhaWxXaWR0aCwKCQkJd2luSGVpZ2h0CQk9IE1hdGgubWF4KCB3aW5NaW4sICQoIHdpbmRvdyApLmhlaWdodCgpICksCgkJCXBhZ2VNaW4JCQk9IE1hdGgubWluKCBzY3JlZW5IZWlnaHQsIHdpbkhlaWdodCApOwoKCQlyZXR1cm4gcGFnZU1pbjsKCX0KCgkkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQgPSBnZXRTY3JlZW5IZWlnaHQ7CgoJLy9zaW1wbHkgc2V0IHRoZSBhY3RpdmUgcGFnZSdzIG1pbmltdW0gaGVpZ2h0IHRvIHNjcmVlbiBoZWlnaHQsIGRlcGVuZGluZyBvbiBvcmllbnRhdGlvbgoJZnVuY3Rpb24gcmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCl7CgkJLy8gRG9uJ3QgYXBwbHkgdGhpcyBoZWlnaHQgaW4gdG91Y2ggb3ZlcmZsb3cgZW5hYmxlZCBtb2RlCgkJaWYoICQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICYmICQubW9iaWxlLnRvdWNoT3ZlcmZsb3dFbmFibGVkICl7CgkJCXJldHVybjsKCQl9CgkJJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICkuY3NzKCAibWluLWhlaWdodCIsIGdldFNjcmVlbkhlaWdodCgpICk7Cgl9CgoJLy9zaGFyZWQgcGFnZSBlbmhhbmNlbWVudHMKCWZ1bmN0aW9uIGVuaGFuY2VQYWdlKCAkcGFnZSwgcm9sZSApIHsKCQkvLyBJZiBhIHJvbGUgd2FzIHNwZWNpZmllZCwgbWFrZSBzdXJlIHRoZSBkYXRhLXJvbGUgYXR0cmlidXRlCgkJLy8gb24gdGhlIHBhZ2UgZWxlbWVudCBpcyBpbiBzeW5jLgoJCWlmKCByb2xlICkgewoJCQkkcGFnZS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHJvbGUgKTsKCQl9CgoJCS8vcnVuIHBhZ2UgcGx1Z2luCgkJJHBhZ2UucGFnZSgpOwoJfQoKLyogZXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzCSAqLwoKCS8vYW5pbWF0aW9uIGNvbXBsZXRlIGNhbGxiYWNrCgkkLmZuLmFuaW1hdGlvbkNvbXBsZXRlID0gZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCWlmKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgKSB7CgkJCXJldHVybiAkKCB0aGlzICkub25lKCAnd2Via2l0QW5pbWF0aW9uRW5kJywgY2FsbGJhY2sgKTsKCQl9CgkJZWxzZXsKCQkJLy8gZGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCXJldHVybiAkKCB0aGlzICk7CgkJfQoJfTsKCgkvL2V4cG9zZSBwYXRoIG9iamVjdCBvbiAkLm1vYmlsZQoJJC5tb2JpbGUucGF0aCA9IHBhdGg7CgoJLy9leHBvc2UgYmFzZSBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLmJhc2UgPSBiYXNlOwoKCS8vaGlzdG9yeSBzdGFjawoJJC5tb2JpbGUudXJsSGlzdG9yeSA9IHVybEhpc3Rvcnk7CgoJJC5tb2JpbGUuZGlhbG9nSGFzaEtleSA9IGRpYWxvZ0hhc2hLZXk7CgoJLy9kZWZhdWx0IG5vbi1hbmltYXRpb24gdHJhbnNpdGlvbiBoYW5kbGVyCgkkLm1vYmlsZS5ub25lVHJhbnNpdGlvbkhhbmRsZXIgPSBmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvUGFnZSwgJGZyb21QYWdlICkgewoJCWlmICggJGZyb21QYWdlICkgewoJCQkkZnJvbVBhZ2UucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApOwoJCX0KCQkkdG9QYWdlLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCgkJcmV0dXJuICQuRGVmZXJyZWQoKS5yZXNvbHZlKCBuYW1lLCByZXZlcnNlLCAkdG9QYWdlLCAkZnJvbVBhZ2UgKS5wcm9taXNlKCk7Cgl9OwoKCS8vZGVmYXVsdCBoYW5kbGVyIGZvciB1bmtub3duIHRyYW5zaXRpb25zCgkkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSAkLm1vYmlsZS5ub25lVHJhbnNpdGlvbkhhbmRsZXI7CgoJLy90cmFuc2l0aW9uIGhhbmRsZXIgZGljdGlvbmFyeSBmb3IgM3JkIHBhcnR5IHRyYW5zaXRpb25zCgkkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMgPSB7CgkJbm9uZTogJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyCgl9OwoKCS8vZW5hYmxlIGNyb3NzLWRvbWFpbiBwYWdlIHN1cHBvcnQKCSQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyA9IGZhbHNlOwoKCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCSQubW9iaWxlLmdldERvY3VtZW50VXJsID0gZnVuY3Rpb24oYXNQYXJzZWRPYmplY3QpIHsKCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIGRvY3VtZW50VXJsICkgOiBkb2N1bWVudFVybC5ocmVmOwoJfTsKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCSQubW9iaWxlLmdldERvY3VtZW50QmFzZSA9IGZ1bmN0aW9uKGFzUGFyc2VkT2JqZWN0KSB7CgkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBkb2N1bWVudEJhc2UgKSA6IGRvY3VtZW50QmFzZS5ocmVmOwoJfTsKCgkkLm1vYmlsZS5fYmluZFBhZ2VSZW1vdmUgPSBmdW5jdGlvbigpIHsKCQl2YXIgcGFnZSA9ICQodGhpcyk7CgoJCS8vIHdoZW4gZG9tIGNhY2hpbmcgaXMgbm90IGVuYWJsZWQgb3IgdGhlIHBhZ2UgaXMgZW1iZWRkZWQgYmluZCB0byByZW1vdmUgdGhlIHBhZ2Ugb24gaGlkZQoJCWlmKCAhcGFnZS5kYXRhKCJwYWdlIikub3B0aW9ucy5kb21DYWNoZQoJCQkJJiYgcGFnZS5pcygiOmpxbURhdGEoZXh0ZXJuYWwtcGFnZT0ndHJ1ZScpIikgKSB7CgoJCQlwYWdlLmJpbmQoICdwYWdlaGlkZS5yZW1vdmUnLCBmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQlwckV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlcmVtb3ZlIiApOwoKCQkJCSR0aGlzLnRyaWdnZXIoIHByRXZlbnQgKTsKCgkJCQlpZiggIXByRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJfQoJCQl9KTsKCQl9Cgl9OwoKCS8vIExvYWQgYSBwYWdlIGludG8gdGhlIERPTS4KCSQubW9iaWxlLmxvYWRQYWdlID0gZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkvLyBUaGlzIGZ1bmN0aW9uIHVzZXMgZGVmZXJyZWQgbm90aWZpY2F0aW9ucyB0byBsZXQgY2FsbGVycwoJCS8vIGtub3cgd2hlbiB0aGUgcGFnZSBpcyBkb25lIGxvYWRpbmcsIG9yIGlmIGFuIGVycm9yIGhhcyBvY2N1cnJlZC4KCQl2YXIgZGVmZXJyZWQgPSAkLkRlZmVycmVkKCksCgoJCQkvLyBUaGUgZGVmYXVsdCBsb2FkUGFnZSBvcHRpb25zIHdpdGggb3ZlcnJpZGVzIHNwZWNpZmllZCBieQoJCQkvLyB0aGUgY2FsbGVyLgoJCQlzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUubG9hZFBhZ2UuZGVmYXVsdHMsIG9wdGlvbnMgKSwKCgkJCS8vIFRoZSBET00gZWxlbWVudCBmb3IgdGhlIHBhZ2UgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9hZGVkLgoJCQlwYWdlID0gbnVsbCwKCgkJCS8vIElmIHRoZSByZWxvYWRQYWdlIG9wdGlvbiBpcyB0cnVlLCBhbmQgdGhlIHBhZ2UgaXMgYWxyZWFkeQoJCQkvLyBpbiB0aGUgRE9NLCBkdXBDYWNoZWRQYWdlIHdpbGwgYmUgc2V0IHRvIHRoZSBwYWdlIGVsZW1lbnQKCQkJLy8gc28gdGhhdCBpdCBjYW4gYmUgcmVtb3ZlZCBhZnRlciB0aGUgbmV3IHZlcnNpb24gb2YgdGhlCgkJCS8vIHBhZ2UgaXMgbG9hZGVkIG9mZiB0aGUgbmV0d29yay4KCQkJZHVwQ2FjaGVkUGFnZSA9IG51bGwsCgoJCQkvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYmFzZSB1cmwKCQkJZmluZEJhc2VXaXRoRGVmYXVsdCA9IGZ1bmN0aW9uKCl7CgkJCQl2YXIgY2xvc2VzdEJhc2UgPSAoICQubW9iaWxlLmFjdGl2ZVBhZ2UgJiYgZ2V0Q2xvc2VzdEJhc2VVcmwoICQubW9iaWxlLmFjdGl2ZVBhZ2UgKSApOwoJCQkJcmV0dXJuIGNsb3Nlc3RCYXNlIHx8IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoJCQl9LAoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBwYXNzZWQgaW50byB0aGUgZnVuY3Rpb24uIFRoaXMKCQkJLy8gdmVyc2lvbiBvZiB0aGUgVVJMIG1heSBjb250YWluIGRpYWxvZy9zdWJwYWdlIHBhcmFtcyBpbiBpdC4KCQkJYWJzVXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgZmluZEJhc2VXaXRoRGVmYXVsdCgpICk7CgoKCQkvLyBJZiB0aGUgY2FsbGVyIHByb3ZpZGVkIGRhdGEsIGFuZCB3ZSdyZSB1c2luZyAiZ2V0IiByZXF1ZXN0LAoJCS8vIGFwcGVuZCB0aGUgZGF0YSB0byB0aGUgVVJMLgoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJYWJzVXJsID0gcGF0aC5hZGRTZWFyY2hQYXJhbXMoIGFic1VybCwgc2V0dGluZ3MuZGF0YSApOwoJCQlzZXR0aW5ncy5kYXRhID0gdW5kZWZpbmVkOwoJCX0KCgkJLy8gSWYgdGhlIGNhbGxlciBpcyB1c2luZyBhICJwb3N0IiByZXF1ZXN0LCByZWxvYWRQYWdlIG11c3QgYmUgdHJ1ZQoJCWlmKCAgc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAicG9zdCIgKXsKCQkJc2V0dGluZ3MucmVsb2FkUGFnZSA9IHRydWU7CgkJfQoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YnBhZ2UgcGFyYW1zLgoJCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgcGFnZSB0byBiZSBsb2FkZWQuCgkJdmFyIGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCBhYnNVcmwgKSwKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIHBhZ2UuIEZvciBlbWJlZGRlZCBwYWdlcywgaXQgaXMganVzdCB0aGUgaWQgb2YgdGhlIHBhZ2UuIEZvciBwYWdlcwoJCQkvLyB3aXRoaW4gdGhlIHNhbWUgZG9tYWluIGFzIHRoZSBkb2N1bWVudCBiYXNlLCBpdCBpcyB0aGUgc2l0ZSByZWxhdGl2ZQoJCQkvLyBwYXRoLiBGb3IgY3Jvc3MtZG9tYWluIHBhZ2VzIChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZSBhYnNvbHV0ZSBVcmwKCQkJLy8gdXNlZCB0byBsb2FkIHRoZSBwYWdlLgoJCQlkYXRhVXJsID0gcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBhYnNVcmwgKTsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBwYWdlQ29udGFpbmVyIHRvIHdvcmsgd2l0aC4KCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkvLyBDaGVjayB0byBzZWUgaWYgdGhlIHBhZ2UgYWxyZWFkeSBleGlzdHMgaW4gdGhlIERPTS4KCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIjpqcW1EYXRhKHVybD0nIiArIGRhdGFVcmwgKyAiJykiICk7CgoJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIHRoZSBwYWdlLCBjaGVjayB0byBzZWUgaWYgdGhlIHVybCBpcyBhCgkJLy8gcmVmZXJlbmNlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuIElmIHNvLCBpdCBtYXkgaGF2ZSBiZWVuIGR5bmFtaWNhbGx5CgkJLy8gaW5qZWN0ZWQgYnkgYSBkZXZlbG9wZXIsIGluIHdoaWNoIGNhc2UgaXQgd291bGQgYmUgbGFja2luZyBhIGRhdGEtdXJsCgkJLy8gYXR0cmlidXRlIGFuZCBpbiBuZWVkIG9mIGVuaGFuY2VtZW50LgoJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYgZGF0YVVybCAmJiAhcGF0aC5pc1BhdGgoIGRhdGFVcmwgKSApIHsKCQkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICIjIiArIGRhdGFVcmwgKQoJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCBkYXRhVXJsICk7CgkJfQoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCBhIHBhZ2UgaW4gdGhlIERPTSwgY2hlY2sgdGhlIFVSTCB0byBzZWUgaWYgaXQKCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZQoJCS8vIHRvIHRoZSBmaXJzdCBwYWdlIGFuZCByZWZlcnMgdG8gbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UsIGVycm9yIG91dC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICkgewoJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZSAmJiBwYXRoLmlzRmlyc3RQYWdlVXJsKCBmaWxlVXJsICkgKSB7CgkJCQkvLyBDaGVjayB0byBtYWtlIHN1cmUgb3VyIGNhY2hlZC1maXJzdC1wYWdlIGlzIGFjdHVhbGx5CgkJCQkvLyBpbiB0aGUgRE9NLiBTb21lIHVzZXIgZGVwbG95ZWQgYXBwcyBhcmUgcHJ1bmluZyB0aGUgZmlyc3QKCQkJCS8vIHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMsIHdlIGNoZWNrIGZvciB0aGlzCgkJCQkvLyBjYXNlIGhlcmUgYmVjYXVzZSB3ZSBkb24ndCB3YW50IGEgZmlyc3QtcGFnZSB3aXRoIGFuIGlkCgkJCQkvLyBmYWxsaW5nIHRocm91Z2ggdG8gdGhlIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlIGVycm9yCgkJCQkvLyBjYXNlLiBJZiB0aGUgZmlyc3QtcGFnZSBpcyBub3QgaW4gdGhlIERPTSwgdGhlbiB3ZSBsZXQKCQkJCS8vIHRoaW5ncyBmYWxsIHRocm91Z2ggdG8gdGhlIGFqYXggbG9hZGluZyBjb2RlIGJlbG93IHNvCgkJCQkvLyB0aGF0IGl0IGdldHMgcmVsb2FkZWQuCgkJCQlpZiAoICQubW9iaWxlLmZpcnN0UGFnZS5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCQkJcGFnZSA9ICQoICQubW9iaWxlLmZpcnN0UGFnZSApOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCBwYXRoLmlzRW1iZWRkZWRQYWdlKCBmaWxlVXJsICkgICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIG9wdGlvbnMgKTsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQl9CgoJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZS4KCQlpZiAoIGJhc2UgKSB7CgkJCWJhc2UucmVzZXQoKTsKCQl9CgoJCS8vIElmIHRoZSBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluIGlzIGFscmVhZHkgaW4gdGhlIERPTSwKCQkvLyBhbmQgdGhlIGNhbGxlciBkaWQgbm90IGluZGljYXRlIHRoYXQgd2Ugc2hvdWxkIGZvcmNlIGEKCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBPdGhlcndpc2UsIHRyYWNrIHRoZQoJCS8vIGV4aXN0aW5nIHBhZ2UgYXMgYSBkdXBsaWNhdGVkLgoJCWlmICggcGFnZS5sZW5ndGggKSB7CgkJCWlmICggIXNldHRpbmdzLnJlbG9hZFBhZ2UgKSB7CgkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlICk7CgkJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCQl9CgkJCWR1cENhY2hlZFBhZ2UgPSBwYWdlOwoJCX0KCgkJdmFyIG1wYyA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIsCgkJCXBibEV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlbG9hZCIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHVybDogdXJsLCBhYnNVcmw6IGFic1VybCwgZGF0YVVybDogZGF0YVVybCwgZGVmZXJyZWQ6IGRlZmVycmVkLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBhIHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBibEV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiggcGJsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQl9CgoJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgoJCQkvLyBUaGlzIGNvbmZpZ3VyYWJsZSB0aW1lb3V0IGFsbG93cyBjYWNoZWQgcGFnZXMgYSBicmllZiBkZWxheSB0byBsb2FkIHdpdGhvdXQgc2hvd2luZyBhIG1lc3NhZ2UKCQkJdmFyIGxvYWRNc2dEZWxheSA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCQkJCX0sIHNldHRpbmdzLmxvYWRNc2dEZWxheSApLAoKCQkJCS8vIFNoYXJlZCBsb2dpYyBmb3IgY2xlYXJpbmcgdGltZW91dCBhbmQgcmVtb3ZpbmcgbWVzc2FnZS4KCQkJCWhpZGVNc2cgPSBmdW5jdGlvbigpewoKCQkJCQkvLyBTdG9wIG1lc3NhZ2Ugc2hvdyB0aW1lcgoJCQkJCWNsZWFyVGltZW91dCggbG9hZE1zZ0RlbGF5ICk7CgoJCQkJCS8vIEhpZGUgbG9hZGluZyBtZXNzYWdlCgkJCQkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9OwoJCX0KCgkJaWYgKCAhKCAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgfHwgcGF0aC5pc1NhbWVEb21haW4oIGRvY3VtZW50VXJsLCBhYnNVcmwgKSApICkgewoJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCX0gZWxzZSB7CgkJCS8vIExvYWQgdGhlIG5ldyBwYWdlLgoJCQkkLmFqYXgoewoJCQkJdXJsOiBmaWxlVXJsLAoJCQkJdHlwZTogc2V0dGluZ3MudHlwZSwKCQkJCWRhdGE6IHNldHRpbmdzLmRhdGEsCgkJCQlkYXRhVHlwZTogImh0bWwiLAoJCQkJc3VjY2VzczogZnVuY3Rpb24oIGh0bWwsIHRleHRTdGF0dXMsIHhociApIHsKCQkJCQkvL3ByZS1wYXJzZSBodG1sIHRvIGNoZWNrIGZvciBhIGRhdGEtdXJsLAoJCQkJCS8vdXNlIGl0IGFzIHRoZSBuZXcgZmlsZVVybCwgYmFzZSBwYXRoLCBldGMKCQkJCQl2YXIgYWxsID0gJCggIjxkaXY+PC9kaXY+IiApLAoKCQkJCQkJLy9wYWdlIHRpdGxlIHJlZ2V4cAoJCQkJCQluZXdQYWdlVGl0bGUgPSBodG1sLm1hdGNoKCAvPHRpdGxlW14+XSo+KFtePF0qKS8gKSAmJiBSZWdFeHAuJDEsCgoJCQkJCQkvLyBUT0RPIGhhbmRsZSBkaWFsb2dzIGFnYWluCgkJCQkJCXBhZ2VFbGVtUmVnZXggPSBuZXcgUmVnRXhwKCAiKDxbXj5dK1xcYmRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9W1wiJ10/cGFnZVtcIiddP1tePl0qPikiICksCgkJCQkJCWRhdGFVcmxSZWdleCA9IG5ldyBSZWdFeHAoICJcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmw9W1wiJ10/KFteXCInPl0qKVtcIiddPyIgKTsKCgoJCQkJCS8vIGRhdGEtdXJsIG11c3QgYmUgcHJvdmlkZWQgZm9yIHRoZSBiYXNlIHRhZyBzbyByZXNvdXJjZSByZXF1ZXN0cyBjYW4gYmUgZGlyZWN0ZWQgdG8gdGhlCgkJCQkJLy8gY29ycmVjdCB1cmwuIGxvYWRpbmcgaW50byBhIHRlbXByb3JhcnkgZWxlbWVudCBtYWtlcyB0aGVzZSByZXF1ZXN0cyBpbW1lZGlhdGVseQoJCQkJCWlmKCBwYWdlRWxlbVJlZ2V4LnRlc3QoIGh0bWwgKQoJCQkJCQkJJiYgUmVnRXhwLiQxCgkJCQkJCQkmJiBkYXRhVXJsUmVnZXgudGVzdCggUmVnRXhwLiQxICkKCQkJCQkJCSYmIFJlZ0V4cC4kMSApIHsKCQkJCQkJdXJsID0gZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIFJlZ0V4cC4kMSApOwoJCQkJCX0KCgkJCQkJaWYgKCBiYXNlICkgewoJCQkJCQliYXNlLnNldCggZmlsZVVybCApOwoJCQkJCX0KCgkJCQkJLy93b3JrYXJvdW5kIHRvIGFsbG93IHNjcmlwdHMgdG8gZXhlY3V0ZSB3aGVuIGluY2x1ZGVkIGluIHBhZ2UgZGl2cwoJCQkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoJCQkJCXBhZ2UgPSBhbGwuZmluZCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkuZmlyc3QoKTsKCgkJCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJCQlpZiggIXBhZ2UubGVuZ3RoICl7CgkJCQkJCXBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz4iICsgaHRtbC5zcGxpdCggLzxcLz9ib2R5W14+XSo+L2dtaSApWzFdICsgIjwvZGl2PiIgKTsKCQkJCQl9CgoJCQkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCQkJaWYgKCB+bmV3UGFnZVRpdGxlLmluZGV4T2YoICImIiApICkgewoJCQkJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJCQl9CgkJCQkJCXBhZ2UuanFtRGF0YSggInRpdGxlIiwgbmV3UGFnZVRpdGxlICk7CgkJCQkJfQoKCQkJCQkvL3Jld3JpdGUgc3JjIGFuZCBocmVmIGF0dHJzIHRvIHVzZSBhIGJhc2UgdXJsCgkJCQkJaWYoICEkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgKSB7CgkJCQkJCXZhciBuZXdQYXRoID0gcGF0aC5nZXQoIGZpbGVVcmwgKTsKCQkJCQkJcGFnZS5maW5kKCAiW3NyY10sIGxpbmtbaHJlZl0sIGFbcmVsPSdleHRlcm5hbCddLCA6anFtRGF0YShhamF4PSdmYWxzZScpLCBhW3RhcmdldF0iICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkJCXZhciB0aGlzQXR0ciA9ICQoIHRoaXMgKS5pcyggJ1tocmVmXScgKSA/ICdocmVmJyA6CgkJCQkJCQkJCSQodGhpcykuaXMoJ1tzcmNdJykgPyAnc3JjJyA6ICdhY3Rpb24nLAoJCQkJCQkJCXRoaXNVcmwgPSAkKCB0aGlzICkuYXR0ciggdGhpc0F0dHIgKTsKCgkJCQkJCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gZml4IHRoaXMgc28gdGhhdCBpdCByZW1vdmVzIHRoZSBkb2N1bWVudAoJCQkJCQkJLy8gICAgICAgICAgICBiYXNlIFVSTCwgYW5kIHRoZW4gcHJlcGVuZHMgd2l0aCB0aGUgbmV3IHBhZ2UgVVJMLgoJCQkJCQkJLy9pZiBmdWxsIHBhdGggZXhpc3RzIGFuZCBpcyBzYW1lLCBjaG9wIGl0IC0gaGVscHMgSUUgb3V0CgkJCQkJCQl0aGlzVXJsID0gdGhpc1VybC5yZXBsYWNlKCBsb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUsICcnICk7CgoJCQkJCQkJaWYoICEvXihcdys6fCN8XC8pLy50ZXN0KCB0aGlzVXJsICkgKSB7CgkJCQkJCQkJJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyLCBuZXdQYXRoICsgdGhpc1VybCApOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCS8vYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJCQkvLyBUT0RPIHRhZ2luZyBhIHBhZ2Ugd2l0aCBleHRlcm5hbCB0byBtYWtlIHN1cmUgdGhhdCBlbWJlZGRlZCBwYWdlcyBhcmVuJ3QgcmVtb3ZlZAoJCQkJCS8vICAgICAgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZSBpbiBtYW55CgkJCQkJLy8gICAgICBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJCQlwYWdlCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBmaWxlVXJsICkgKQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICkKCQkJCQkJLmFwcGVuZFRvKCBzZXR0aW5ncy5wYWdlQ29udGFpbmVyICk7CgoJCQkJCS8vIHdhaXQgZm9yIHBhZ2UgY3JlYXRpb24gdG8gbGV2ZXJhZ2Ugb3B0aW9ucyBkZWZpbmVkIG9uIHdpZGdldAoJCQkJCXBhZ2Uub25lKCAncGFnZWNyZWF0ZScsICQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSApOwoKCQkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJCQkvLyBFbmhhbmNpbmcgdGhlIHBhZ2UgbWF5IHJlc3VsdCBpbiBuZXcgZGlhbG9ncy9zdWIgcGFnZXMgYmVpbmcgaW5zZXJ0ZWQKCQkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLXBhZ2UsIHRoYXQgaXMgdGhlCgkJCQkJLy8gcmVhbCBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluLgoJCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIjpqcW1EYXRhKHVybD0nIiArIGRhdGFVcmwgKyAiJykiICk7CgkJCQkJfQoKCQkJCQkvL2JpbmQgcGFnZUhpZGUgdG8gcmVtb3ZlUGFnZSBhZnRlciBpdCdzIGhpZGRlbiwgaWYgdGhlIHBhZ2Ugb3B0aW9ucyBzcGVjaWZ5IHRvIGRvIHNvCgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQkJaGlkZU1zZygpOwoJCQkJCX0KCgkJCQkJLy8gQWRkIHRoZSBwYWdlIHJlZmVyZW5jZSBhbmQgeGhyIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEucGFnZSA9IHBhZ2U7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2Vsb2FkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlLCBkdXBDYWNoZWRQYWdlICk7CgkJCQl9LAoJCQkJZXJyb3I6IGZ1bmN0aW9uKCB4aHIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duICkgewoJCQkJCS8vc2V0IGJhc2UgYmFjayB0byBjdXJyZW50IHBhdGgKCQkJCQlpZiggYmFzZSApIHsKCQkJCQkJYmFzZS5zZXQoIHBhdGguZ2V0KCkgKTsKCQkJCQl9CgoJCQkJCS8vIEFkZCBlcnJvciBpbmZvIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEuZXJyb3JUaHJvd24gPSBlcnJvclRocm93bjsKCgkJCQkJdmFyIHBsZkV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlbG9hZGZhaWxlZCIgKTsKCgkJCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHRoZSBwYWdlIGxvYWQgZmFpbGVkLgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggcGxmRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCQkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCQkvLyB0aGF0IGNhbGxlZCBwcmV2ZW50RGVmYXVsdCgpLCB0byByZXNvbHZlL3JlamVjdCB0aGUKCQkJCQkvLyBkZWZlcnJlZCBvYmplY3Qgd2l0aGluIHRoZSB0cmlnZ2VyRGF0YS4KCQkJCQlpZiggcGxmRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQkJaGlkZU1zZygpOwoKCQkJCQkJLy9zaG93IGVycm9yIG1lc3NhZ2UKCQkJCQkJJCggIjxkaXYgY2xhc3M9J3VpLWxvYWRlciB1aS1vdmVybGF5LXNoYWRvdyB1aS1ib2R5LWUgdWktY29ybmVyLWFsbCc+PGgxPiIrICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlICsiPC9oMT48L2Rpdj4iICkKCQkJCQkJCS5jc3MoeyAiZGlzcGxheSI6ICJibG9jayIsICJvcGFjaXR5IjogMC45NiwgInRvcCI6ICR3aW5kb3cuc2Nyb2xsVG9wKCkgKyAxMDAgfSkKCQkJCQkJCS5hcHBlbmRUbyggc2V0dGluZ3MucGFnZUNvbnRhaW5lciApCgkJCQkJCQkuZGVsYXkoIDgwMCApCgkJCQkJCQkuZmFkZU91dCggNDAwLCBmdW5jdGlvbigpIHsKCQkJCQkJCQkkKCB0aGlzICkucmVtb3ZlKCk7CgkJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCX07CgoJJC5tb2JpbGUubG9hZFBhZ2UuZGVmYXVsdHMgPSB7CgkJdHlwZTogImdldCIsCgkJZGF0YTogdW5kZWZpbmVkLAoJCXJlbG9hZFBhZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCXNob3dMb2FkTXNnOiBmYWxzZSwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJbG9hZE1zZ0RlbGF5OiA1MCAvLyBUaGlzIGRlbGF5IGFsbG93cyBsb2FkcyB0aGF0IHB1bGwgZnJvbSBicm93c2VyIGNhY2hlIHRvIG9jY3VyIHdpdGhvdXQgc2hvd2luZyB0aGUgbG9hZGluZyBtZXNzYWdlLgoJfTsKCgkvLyBTaG93IGEgc3BlY2lmaWMgcGFnZSBpbiB0aGUgcGFnZSBjb250YWluZXIuCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvUGFnZSwgb3B0aW9ucyApIHsKCQkvLyBJZiB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGEgdHJhbnNpdGlvbiwgcXVldWUgdGhlIGN1cnJlbnQgcmVxdWVzdC4KCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uIHRvCgkJLy8gc2VydmljZSB0aGUgcmVxdWVzdC4KCQlpZiggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJcGFnZVRyYW5zaXRpb25RdWV1ZS51bnNoaWZ0KCBhcmd1bWVudHMgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzLCBvcHRpb25zICk7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgcGFnZUNvbnRhaW5lciB0byB3b3JrIHdpdGguCgkJc2V0dGluZ3MucGFnZUNvbnRhaW5lciA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBmcm9tUGFnZS4KCQlzZXR0aW5ncy5mcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlIHx8ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgoJCXZhciBtcGMgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLAoJCQlwYmNFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWJlZm9yZWNoYW5nZSIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHRvUGFnZTogdG9QYWdlLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gY2hhbmdlIHRoZSBjdXJyZW50IHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBiY0V2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiggcGJjRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvUGFnZSBpbiB0aGUgdHJpZ2dlcgoJCS8vIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0b1BhZ2UgaXMgdXBkYXRlZC4KCgkJdG9QYWdlID0gdHJpZ2dlckRhdGEudG9QYWdlOwoKCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCS8vIG9yIHRyYW5zaXRpb25pbmcuCgoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJLy8gdG8gbWFrZSBzdXJlIGl0IGlzIGxvYWRlZCBpbnRvIHRoZSBET00uIFdlJ2xsIGxpc3RlbgoJCS8vIHRvIHRoZSBwcm9taXNlIG9iamVjdCBpdCByZXR1cm5zIHNvIHdlIGtub3cgd2hlbgoJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCWlmICggdHlwZW9mIHRvUGFnZSA9PSAic3RyaW5nIiApIHsKCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHRvUGFnZSwgc2V0dGluZ3MgKQoJCQkJLmRvbmUoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgbmV3UGFnZSwgZHVwQ2FjaGVkUGFnZSApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQkJb3B0aW9ucy5kdXBsaWNhdGVDYWNoZWRQYWdlID0gZHVwQ2FjaGVkUGFnZTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBuZXdQYWdlLCBvcHRpb25zICk7CgkJCQl9KQoJCQkJLmZhaWwoZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgoJCQkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgoJCQkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2VjaGFuZ2VmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoJCQkJfSk7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZmlyc3QtcGFnZSBvZiB0aGUgYXBwbGljYXRpb24sIHdlIG5lZWQgdG8gbWFrZQoJCS8vIHN1cmUgc2V0dGluZ3MuZGF0YVVybCBpcyBzZXQgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVybC4gVGhpcyBhbGxvd3MKCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkvLyBmaXJzdC1wYWdlIG9mIHRoZSBkb2N1bWVudCBoYXMgYW4gaWQgYXR0cmlidXRlIHNwZWNpZmllZC4KCQlpZiAoIHRvUGFnZVsgMCBdID09PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSAmJiAhc2V0dGluZ3MuZGF0YVVybCApIHsKCQkJc2V0dGluZ3MuZGF0YVVybCA9IGRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJfQoKCQkvLyBUaGUgY2FsbGVyIHBhc3NlZCB1cyBhIHJlYWwgcGFnZSBET00gZWxlbWVudC4gVXBkYXRlIG91cgoJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCXZhciBmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlLAoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBzZXR0aW5ncy5kYXRhVXJsICkgKSB8fCB0b1BhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQgYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmwsCgkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCB1cmwgKSwKCQkJYWN0aXZlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9IHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAsCgkJCWhpc3RvcnlEaXIgPSAwLAoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZSwKCQkJaXNEaWFsb2cgPSBzZXR0aW5ncy5yb2xlID09PSAiZGlhbG9nIiB8fCB0b1BhZ2UuanFtRGF0YSggInJvbGUiICkgPT09ICJkaWFsb2ciOwoKCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCS8vIGFyZSB0aGUgc2FtZSBlbGVtZW50LCBidXQgZm9sa3MgdGhhdCBnZW5lcmF0ZSBjb250ZW50IG1hbnVhbGx5L2R5bmFtaWNhbGx5CgkJLy8gYW5kIHJldXNlIHBhZ2VzIHdhbnQgdG8gYmUgYWJsZSB0byB0cmFuc2l0aW9uIHRvIHRoZSBzYW1lIHBhZ2UuIFRvIGFsbG93CgkJLy8gdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0IHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uCgkJLy8gdG8gdHJ1ZSwgKk9SKiwgcGFzcyBpdCBpbiBhcyBhbiBvcHRpb24gd2hlbiB0aGV5IG1hbnVhbGx5IGNhbGwgY2hhbmdlUGFnZSgpLgoJCS8vIEl0IHNob3VsZCBiZSBub3RlZCB0aGF0IG91ciBkZWZhdWx0IHRyYW5zaXRpb24gYW5pbWF0aW9ucyBhc3N1bWUgdGhhdCB0aGUKCQkvLyBmb3JtUGFnZSBhbmQgdG9QYWdlIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuCgkJLy8gSXQgaXMgdXAgdG8gdGhlIGRldmVsb3BlciB0aGF0IHR1cm5zIG9uIHRoZSBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbmEgb3B0aW9uCgkJLy8gdG8gZWl0aGVyIHR1cm4gb2ZmIHRyYW5zaXRpb24gYW5pbWF0aW9ucywgb3IgbWFrZSBzdXJlIHRoYXQgYW4gYXBwcm9wcmlhdGUKCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCWlmKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmICFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFnZSB3ZSBhcmUgZ2l2ZW4gaGFzIGFscmVhZHkgYmVlbiBlbmhhbmNlZC4KCQllbmhhbmNlUGFnZSggdG9QYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCS8vIElmIHRoZSBjaGFuZ2VQYWdlIHJlcXVlc3Qgd2FzIHNlbnQgZnJvbSBhIGhhc2hDaGFuZ2UgZXZlbnQsIGNoZWNrIHRvIHNlZSBpZiB0aGUKCQkvLyBwYWdlIGlzIGFscmVhZHkgd2l0aGluIHRoZSB1cmxIaXN0b3J5IHN0YWNrLiBJZiBzbywgd2UnbGwgYXNzdW1lIHRoZSB1c2VyIGhpdAoJCS8vIHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUgdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQlpZiggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQljdXJyZW50VXJsOgl1cmwsCgkJCQlpc0JhY2s6CQlmdW5jdGlvbigpIHsgaGlzdG9yeURpciA9IC0xOyB9LAoJCQkJaXNGb3J3YXJkOglmdW5jdGlvbigpIHsgaGlzdG9yeURpciA9IDE7IH0KCQkJfSk7CgkJfQoKCQkvLyBLaWxsIHRoZSBrZXlib2FyZC4KCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gc3RvcCBjcmF3bGluZyB0aGUgZW50aXJlIGRvY3VtZW50IHRvIGtpbGwgZm9jdXMuIEluc3RlYWQsCgkJLy8gICAgICAgICAgICB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGxpdmUoKSBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZQoJCS8vICAgICAgICAgICAgdGhlIGVsZW1lbnQgaW4gaGFuZCBhdCB0aGlzIHBvaW50LgoJCS8vIFdyYXAgdGhpcyBpbiBhIHRyeS9jYXRjaCBibG9jayBzaW5jZSBJRTkgdGhyb3cgIlVuc3BlY2lmaWVkIGVycm9yIiBpZiBkb2N1bWVudC5hY3RpdmVFbGVtZW50CgkJLy8gaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQl0cnkgewoJCQlpZihkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPSAnYm9keScpIHsKCQkJCSQoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkuYmx1cigpOwoJCQl9IGVsc2UgewoJCQkJJCggImlucHV0OmZvY3VzLCB0ZXh0YXJlYTpmb2N1cywgc2VsZWN0OmZvY3VzIiApLmJsdXIoKTsKCQkJfQoJCX0gY2F0Y2goZSkge30KCgkJLy8gSWYgd2UncmUgZGlzcGxheWluZyB0aGUgcGFnZSBhcyBhIGRpYWxvZywgd2UgZG9uJ3Qgd2FudCB0aGUgdXJsCgkJLy8gZm9yIHRoZSBkaWFsb2cgY29udGVudCB0byBiZSB1c2VkIGluIHRoZSBoYXNoLiBJbnN0ZWFkLCB3ZSB3YW50CgkJLy8gdG8gYXBwZW5kIHRoZSBkaWFsb2dIYXNoS2V5IHRvIHRoZSB1cmwgb2YgdGhlIGN1cnJlbnQgcGFnZS4KCQlpZiAoIGlzRGlhbG9nICYmIGFjdGl2ZSApIHsKCQkJLy8gb24gdGhlIGluaXRpYWwgcGFnZSBsb2FkIGFjdGl2ZS51cmwgaXMgdW5kZWZpbmVkIGFuZCBpbiB0aGF0IGNhc2Ugc2hvdWxkCgkJCS8vIGJlIGFuIGVtcHR5IHN0cmluZy4gTW92aW5nIHRoZSB1bmRlZmluZWQgLT4gZW1wdHkgc3RyaW5nIGJhY2sgaW50bwoJCQkvLyB1cmxIaXN0b3J5LmFkZE5ldyBzZWVtZWQgaW1wcnVkZW50IGdpdmVuIHVuZGVmaW5lZCBiZXR0ZXIgcmVwcmVzZW50cwoJCQkvLyB0aGUgdXJsIHN0YXRlCgkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApICsgZGlhbG9nSGFzaEtleTsKCQl9CgoJCS8vIFNldCB0aGUgbG9jYXRpb24gaGFzaC4KCQlpZiggc2V0dGluZ3MuY2hhbmdlSGFzaCAhPT0gZmFsc2UgJiYgdXJsICkgewoJCQkvL2Rpc2FibGUgaGFzaCBsaXN0ZW5pbmcgdGVtcG9yYXJpbHkKCQkJdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSA9IHRydWU7CgkJCS8vdXBkYXRlIGhhc2ggYW5kIGhpc3RvcnkKCQkJcGF0aC5zZXQoIHVybCApOwoJCX0KCgkJLy8gaWYgdGl0bGUgZWxlbWVudCB3YXNuJ3QgZm91bmQsIHRyeSB0aGUgcGFnZSBkaXYgZGF0YSBhdHRyIHRvbwoJCS8vIElmIHRoaXMgaXMgYSBkZWVwLWxpbmsgb3IgYSByZWxvYWQgKCBhY3RpdmUgPT09IHVuZGVmaW5lZCApIHRoZW4ganVzdCB1c2UgcGFnZVRpdGxlCgkJdmFyIG5ld1BhZ2VUaXRsZSA9ICggIWFjdGl2ZSApPyBwYWdlVGl0bGUgOiB0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApIHx8IHRvUGFnZS5jaGlsZHJlbigiOmpxbURhdGEocm9sZT0naGVhZGVyJykiKS5maW5kKCIudWktdGl0bGUiICkuZ2V0RW5jb2RlZFRleHQoKTsKCQlpZiggISFuZXdQYWdlVGl0bGUgJiYgcGFnZVRpdGxlID09IGRvY3VtZW50LnRpdGxlICkgewoJCQlwYWdlVGl0bGUgPSBuZXdQYWdlVGl0bGU7CgkJfQoJCWlmICggIXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiLCBwYWdlVGl0bGUgKTsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgdHJhbnNpdGlvbiBkZWZpbmVkLgoJCXNldHRpbmdzLnRyYW5zaXRpb24gPSBzZXR0aW5ncy50cmFuc2l0aW9uCgkJCXx8ICggKCBoaXN0b3J5RGlyICYmICFhY3RpdmVJc0luaXRpYWxQYWdlICkgPyBhY3RpdmUudHJhbnNpdGlvbiA6IHVuZGVmaW5lZCApCgkJCXx8ICggaXNEaWFsb2cgPyAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiA6ICQubW9iaWxlLmRlZmF1bHRQYWdlVHJhbnNpdGlvbiApOwoKCQkvL2FkZCBwYWdlIHRvIGhpc3Rvcnkgc3RhY2sgaWYgaXQncyBub3QgYmFjayBvciBmb3J3YXJkCgkJaWYoICFoaXN0b3J5RGlyICkgewoJCQl1cmxIaXN0b3J5LmFkZE5ldyggdXJsLCBzZXR0aW5ncy50cmFuc2l0aW9uLCBwYWdlVGl0bGUsIHBhZ2VVcmwsIHNldHRpbmdzLnJvbGUgKTsKCQl9CgoJCS8vc2V0IHBhZ2UgdGl0bGUKCQlkb2N1bWVudC50aXRsZSA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCkudGl0bGU7CgoJCS8vc2V0ICJ0b1BhZ2UiIGFzIGFjdGl2ZVBhZ2UKCQkkLm1vYmlsZS5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQlzZXR0aW5ncy5yZXZlcnNlID0gc2V0dGluZ3MucmV2ZXJzZSB8fCBoaXN0b3J5RGlyIDwgMDsKCgkJdHJhbnNpdGlvblBhZ2VzKCB0b1BhZ2UsIGZyb21QYWdlLCBzZXR0aW5ncy50cmFuc2l0aW9uLCBzZXR0aW5ncy5yZXZlcnNlICkKCQkJLmRvbmUoZnVuY3Rpb24oKSB7CgkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoKTsKCgkJCQkvL2lmIHRoZXJlJ3MgYSBkdXBsaWNhdGVDYWNoZWRQYWdlLCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NIG5vdyB0aGF0IGl0J3MgaGlkZGVuCgkJCQlpZiAoIHNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgKSB7CgkJCQkJc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZS5yZW1vdmUoKTsKCQkJCX0KCgkJCQkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCgkJCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhbGwgZG9uZSBjaGFuZ2luZyB0aGUgY3VycmVudCBwYWdlLgoJCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCi8qIEV2ZW50IEJpbmRpbmdzIC0gaGFzaGNoYW5nZSwgc3VibWl0LCBhbmQgY2xpY2sgKi8KCWZ1bmN0aW9uIGZpbmRDbG9zZXN0TGluayggZWxlICkKCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImEiICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBlbGU7Cgl9CgoJLy8gVGhlIGJhc2UgVVJMIGZvciBhbnkgZ2l2ZW4gZWxlbWVudCBkZXBlbmRzIG9uIHRoZSBwYWdlIGl0IHJlc2lkZXMgaW4uCglmdW5jdGlvbiBnZXRDbG9zZXN0QmFzZVVybCggZWxlICkKCXsKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhZ2UgYW5kIGV4dHJhY3Qgb3V0IGl0cyB1cmwuCgkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQliYXNlID0gZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCWlmICggIXVybCB8fCAhcGF0aC5pc1BhdGgoIHVybCApICkgewoJCQl1cmwgPSBiYXNlOwoJCX0KCgkJcmV0dXJuIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UpOwoJfQoKCgkvL1RoZSBmb2xsb3dpbmcgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGJlIGJvdW5kIGFmdGVyIG1vYmlsZWluaXQgaGFzIGJlZW4gdHJpZ2dlcmVkCgkvL3RoZSBmb2xsb3dpbmcgZnVuY3Rpb24gaXMgY2FsbGVkIGluIHRoZSBpbml0IGZpbGUKCSQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzID0gZnVuY3Rpb24oKXsKCgkJLy9iaW5kIHRvIGZvcm0gc3VibWl0IGV2ZW50cywgaGFuZGxlIHdpdGggQWpheAoJCSQoICJmb3JtIiApLmxpdmUoJ3N1Ym1pdCcsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoJCQlpZiggISQubW9iaWxlLmFqYXhFbmFibGVkIHx8CgkJCQkkdGhpcy5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJdmFyIHR5cGUgPSAkdGhpcy5hdHRyKCAibWV0aG9kIiApLAoJCQkJdGFyZ2V0ID0gJHRoaXMuYXR0ciggInRhcmdldCIgKSwKCQkJCXVybCA9ICR0aGlzLmF0dHIoICJhY3Rpb24iICk7CgoJCQkvLyBJZiBubyBhY3Rpb24gaXMgc3BlY2lmaWVkLCBicm93c2VycyBkZWZhdWx0IHRvIHVzaW5nIHRoZQoJCQkvLyBVUkwgb2YgdGhlIGRvY3VtZW50IGNvbnRhaW5pbmcgdGhlIGZvcm0uIFNpbmNlIHdlIGR5bmFtaWNhbGx5CgkJCS8vIHB1bGwgaW4gcGFnZXMgZnJvbSBleHRlcm5hbCBkb2N1bWVudHMsIHRoZSBmb3JtIHNob3VsZCBzdWJtaXQKCQkJLy8gdG8gdGhlIFVSTCBmb3IgdGhlIHNvdXJjZSBkb2N1bWVudCBvZiB0aGUgcGFnZSBjb250YWluaW5nCgkJCS8vIHRoZSBmb3JtLgoJCQlpZiAoICF1cmwgKSB7CgkJCQkvLyBHZXQgdGhlIEBkYXRhLXVybCBmb3IgdGhlIHBhZ2UgY29udGFpbmluZyB0aGUgZm9ybS4KCQkJCXVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkdGhpcyApOwoJCQkJaWYgKCB1cmwgPT09IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgewoJCQkJCS8vIFRoZSB1cmwgd2UgZ290IGJhY2sgbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYmFzZSwKCQkJCQkvLyB3aGljaCBtZWFucyB0aGUgcGFnZSBtdXN0IGJlIGFuIGludGVybmFsL2VtYmVkZGVkIHBhZ2UsCgkJCQkJLy8gc28gZGVmYXVsdCB0byB1c2luZyB0aGUgYWN0dWFsIGRvY3VtZW50IHVybCBhcyBhIGJyb3dzZXIKCQkJCQkvLyB3b3VsZC4KCQkJCQl1cmwgPSBkb2N1bWVudFVybC5ocmVmTm9TZWFyY2g7CgkJCQl9CgkJCX0KCgkJCXVybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCAgdXJsLCBnZXRDbG9zZXN0QmFzZVVybCgkdGhpcykgKTsKCgkJCS8vZXh0ZXJuYWwgc3VibWl0cyB1c2UgcmVndWxhciBIVFRQCgkJCWlmKCBwYXRoLmlzRXh0ZXJuYWwoIHVybCApIHx8IHRhcmdldCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSgKCQkJCXVybCwKCQkJCXsKCQkJCQl0eXBlOgkJdHlwZSAmJiB0eXBlLmxlbmd0aCAmJiB0eXBlLnRvTG93ZXJDYXNlKCkgfHwgImdldCIsCgkJCQkJZGF0YToJCSR0aGlzLnNlcmlhbGl6ZSgpLAoJCQkJCXRyYW5zaXRpb246CSR0aGlzLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJCWRpcmVjdGlvbjoJJHRoaXMuanFtRGF0YSggImRpcmVjdGlvbiIgKSwKCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQl9CgkJCSk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vYWRkIGFjdGl2ZSBzdGF0ZSBvbiB2Y2xpY2sKCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIGlmIHRoaXMgaXNuJ3QgYSBsZWZ0IGNsaWNrIHdlIGRvbid0IGNhcmUuIEl0cyBpbXBvcnRhbnQgdG8gbm90ZQoJCQkvLyB0aGF0IHdoZW4gdGhlIHZpcnR1YWwgZXZlbnQgaXMgZ2VuZXJhdGVkIGl0IHdpbGwgY3JlYXRlCgkJCWlmICggZXZlbnQud2hpY2ggPiAxIHx8ICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApOwoJCQlpZiAoIGxpbmsgKSB7CgkJCQlpZiAoIHBhdGgucGFyc2VVcmwoIGxpbmsuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSB7CgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gJCggbGluayApLmNsb3Nlc3QoICIudWktYnRuIiApLm5vdCggIi51aS1kaXNhYmxlZCIgKTsKCQkJCQkkYWN0aXZlQ2xpY2tlZExpbmsuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiAudWktYnRuIiApLm5vdCggbGluayApLmJsdXIoKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkKCBkb2N1bWVudCApLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYoICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApOwoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgJGxpbmsgPSAkKCBsaW5rICksCgkJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpewoJCQkJCXdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsgcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7IH0sIDIwMCApOwoJCQkJfTsKCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmKCAkbGluay5pcyggIjpqcW1EYXRhKHJlbD0nYmFjaycpIiApICkgewoJCQkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgYmFzZVVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkbGluayApLAoKCQkJCS8vZ2V0IGhyZWYsIGlmIGRlZmluZWQsIG90aGVyd2lzZSBkZWZhdWx0IHRvIGVtcHR5IGhhc2gKCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGxpbmsuYXR0ciggImhyZWYiICkgfHwgIiMiLCBiYXNlVXJsICk7CgoJCQkvL2lmIGFqYXggaXMgZGlzYWJsZWQsIGV4aXQgZWFybHkKCQkJaWYoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhcGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICl7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPSAtMSApIHsKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoIHBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJCS8vIFNob3VsZCB3ZSBoYW5kbGUgdGhpcyBsaW5rLCBvciBsZXQgdGhlIGJyb3dzZXIgZGVhbCB3aXRoIGl0PwoJCQl2YXIgdXNlRGVmYXVsdFVybEhhbmRsaW5nID0gJGxpbmsuaXMoICJbcmVsPSdleHRlcm5hbCddIiApIHx8ICRsaW5rLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fCAkbGluay5pcyggIlt0YXJnZXRdIiApLAoKCQkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkJLy8gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0byAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYwoJCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCQkvLyByZXF1ZXN0cyB0byBnbyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCQlpc0Nyb3NzRG9tYWluUGFnZUxvYWQgPSAoICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJiBkb2N1bWVudFVybC5wcm90b2NvbCA9PT0gImZpbGU6IiAmJiBocmVmLnNlYXJjaCggL15odHRwcz86LyApICE9IC0xICksCgoJCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJCS8vVE9ETyBvdmVybGFwIGluIGxvZ2ljIGZyb20gaXNFeHRlcm5hbCwgcmVsPWV4dGVybmFsIGNoZWNrIHNob3VsZCBiZQoJCQkJLy8gICAgIG1vdmVkIGludG8gbW9yZSBjb21wcmVoZW5zaXZlIGlzRXh0ZXJuYWxMaW5rCgkJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggcGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgIWlzQ3Jvc3NEb21haW5QYWdlTG9hZCApOwoKCQkJaWYoIGlzRXh0ZXJuYWwgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3VzZSBhamF4CgkJCXZhciB0cmFuc2l0aW9uID0gJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQlkaXJlY3Rpb24gPSAkbGluay5qcW1EYXRhKCAiZGlyZWN0aW9uIiApLAoJCQkJcmV2ZXJzZSA9ICggZGlyZWN0aW9uICYmIGRpcmVjdGlvbiA9PT0gInJldmVyc2UiICkgfHwKCQkJCQkJCS8vIGRlcHJlY2F0ZWQgLSByZW1vdmUgYnkgMS4wCgkJCQkJCQkkbGluay5qcW1EYXRhKCAiYmFjayIgKSwKCgkJCQkvL3RoaXMgbWF5IG5lZWQgdG8gYmUgbW9yZSBzcGVjaWZpYyBhcyB3ZSB1c2UgZGF0YS1yZWwgbW9yZQoJCQkJcm9sZSA9ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfHwgdW5kZWZpbmVkOwoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggaHJlZiwgeyB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCByZXZlcnNlOiByZXZlcnNlLCByb2xlOiByb2xlIH0gKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9KTsKCgkJLy9wcmVmZXRjaCBwYWdlcyB3aGVuIGFuY2hvcnMgd2l0aCBkYXRhLXByZWZldGNoIGFyZSBlbmNvdW50ZXJlZAoJCSQoICIudWktcGFnZSIgKS5saXZlKCAicGFnZXNob3cucHJlZmV0Y2giLCBmdW5jdGlvbigpIHsKCQkJdmFyIHVybHMgPSBbXTsKCQkJJCggdGhpcyApLmZpbmQoICJhOmpxbURhdGEocHJlZmV0Y2gpIiApLmVhY2goZnVuY3Rpb24oKXsKCQkJCXZhciAkbGluayA9ICQodGhpcyksCgkJCQkJdXJsID0gJGxpbmsuYXR0ciggImhyZWYiICk7CgoJCQkJaWYgKCB1cmwgJiYgJC5pbkFycmF5KCB1cmwsIHVybHMgKSA9PT0gLTEgKSB7CgkJCQkJdXJscy5wdXNoKCB1cmwgKTsKCgkJCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHVybCwge3JvbGU6ICRsaW5rLmF0dHIoImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIpfSApOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UgPSBmdW5jdGlvbiggaGFzaCApIHsKCQkJLy9maW5kIGZpcnN0IHBhZ2UgdmlhIGhhc2gKCQkJdmFyIHRvID0gcGF0aC5zdHJpcEhhc2goIGhhc2ggKSwKCQkJCS8vdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQgb3RoZXJ3aXNlIChhbmQgbWF5IGJlIG92ZXJyaWRkZW4gYnkgZGVmYXVsdCkKCQkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS51cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMCA/ICJub25lIiA6IHVuZGVmaW5lZCwKCgkJCQkvLyBkZWZhdWx0IG9wdGlvbnMgZm9yIHRoZSBjaGFuZ1BhZ2UgY2FsbHMgbWFkZSBhZnRlciBleGFtaW5pbmcgdGhlIGN1cnJlbnQgc3RhdGUKCQkJCS8vIG9mIHRoZSBwYWdlIGFuZCB0aGUgaGFzaAoJCQkJY2hhbmdlUGFnZU9wdGlvbnMgPSB7CgkJCQkJdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZQoJCQkJfTsKCgkJCS8vaWYgbGlzdGVuaW5nIGlzIGRpc2FibGVkIChlaXRoZXIgZ2xvYmFsbHkgb3IgdGVtcG9yYXJpbHkpLCBvciBpdCdzIGEgZGlhbG9nIGhhc2gKCQkJaWYoICEkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCB8fCB1cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlICkgewoJCQkJdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSA9IGZhbHNlOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBzcGVjaWFsIGNhc2UgZm9yIGRpYWxvZ3MKCQkJaWYoIHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoID4gMSAmJiB0by5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSApIHsKCgkJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCQkvLyBpbiB0aGUgc2FtZSBkaXJlY3Rpb24KCQkJCWlmKCEkLm1vYmlsZS5hY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKSkgewoJCQkJCS8vZGV0ZXJtaW5lIGlmIHdlJ3JlIGhlYWRpbmcgZm9yd2FyZCBvciBiYWNrd2FyZCBhbmQgY29udGludWUgYWNjb3JkaW5nbHkgcGFzdAoJCQkJCS8vdGhlIGN1cnJlbnQgZGlhbG9nCgkJCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCQkJY3VycmVudFVybDogdG8sCgkJCQkJCWlzQmFjazogZnVuY3Rpb24oKSB7IHdpbmRvdy5oaXN0b3J5LmJhY2soKTsgfSwKCQkJCQkJaXNGb3J3YXJkOiBmdW5jdGlvbigpIHsgd2luZG93Lmhpc3RvcnkuZm9yd2FyZCgpOyB9CgkJCQkJfSk7CgoJCQkJCS8vIHByZXZlbnQgY2hhbmdlUGFnZSgpCgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBpZiB0aGUgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBhIGRpYWxvZyBhbmQgd2UncmUgbmF2aWdhdGluZwoJCQkJCS8vIHRvIGEgZGlhbG9nIHVzZSB0aGUgZGlhbG9nIG9iamVjdGVkIHNhdmVkIGluIHRoZSBzdGFjawoJCQkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQkJCWN1cnJlbnRVcmw6IHRvLAoKCQkJCQkJLy8gcmVnYXJkbGVzcyBvZiB0aGUgZGlyZWN0aW9uIG9mIHRoZSBoaXN0b3J5IGNoYW5nZQoJCQkJCQkvLyBkbyB0aGUgZm9sbG93aW5nCgkJCQkJCWVpdGhlcjogZnVuY3Rpb24oIGlzQmFjayApIHsKCQkJCQkJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQkJCQkJCXRvID0gYWN0aXZlLnBhZ2VVcmw7CgoJCQkJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgcm9sZSwgdHJhbnNpdGlvbiBhbmQgcmV2ZXJzYWwKCQkJCQkJCS8vIGFzIG1vc3Qgb2YgdGhpcyBpcyBsb3N0IGJ5IHRoZSBkb21DYWNoZSBjbGVhbmluZwoJCQkJCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCB7CgkJCQkJCQkJcm9sZTogYWN0aXZlLnJvbGUsCgkJCQkJCQkJdHJhbnNpdGlvbjoJIGFjdGl2ZS50cmFuc2l0aW9uLAoJCQkJCQkJCXJldmVyc2U6IGlzQmFjawoJCQkJCQkJfSk7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0KCQkJfQoKCQkJLy9pZiB0byBpcyBkZWZpbmVkLCBsb2FkIGl0CgkJCWlmICggdG8gKSB7CgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UgZWxlbWVudCBmcm9tCgkJCQkvLyBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlL2Fic29sdXRlIFVSTC4gSWYgJ3RvJyBpcwoJCQkJLy8gYW4gaWQsIHdlIG5lZWQgdG8gcmVzb2x2ZSBpdCBhZ2FpbnN0IHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwKCQkJCS8vIHNpbmNlIHRoZSBoYXNoY2hhbmdlIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwgcGFnZS9kaWFsb2cuCgkJCQl0byA9ICggdHlwZW9mIHRvID09PSAic3RyaW5nIiAmJiAhcGF0aC5pc1BhdGgoIHRvICkgKSA/ICggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICcjJyArIHRvLCBkb2N1bWVudEJhc2UgKSApIDogdG87CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCB0bywgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQllbHNlIHsKCQkJCS8vdGhlcmUncyBubyBoYXNoLCBnbyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgZG9tCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJCX0KCQl9OwoKCQkvL2hhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcgoJCSR3aW5kb3cuYmluZCggImhhc2hjaGFuZ2UiLCBmdW5jdGlvbiggZSwgdHJpZ2dlcmVkICkgewoJCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSggbG9jYXRpb24uaGFzaCApOwoJCX0pOwoKCQkvL3NldCBwYWdlIG1pbi1oZWlnaHRzIHRvIGJlIGRldmljZSBzcGVjaWZpYwoJCSQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VzaG93IiwgcmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgkJJCggd2luZG93ICkuYmluZCggInRocm90dGxlZHJlc2l6ZSIsIHJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoKCX07Ly9fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyBjYWxsYmFjawoKfSkoIGpRdWVyeSApOwovKgoqIGhpc3RvcnkucHVzaFN0YXRlIHN1cHBvcnQsIGxheWVyZWQgb24gdG9wIG9mIGhhc2hjaGFuZ2UKKi8KCiggZnVuY3Rpb24oICQsIHdpbmRvdyApIHsKCS8vIEZvciBub3csIGxldCdzIE1vbmtleXBhdGNoIHRoaXMgb250byB0aGUgZW5kIG9mICQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzCgkvLyBTY29wZSBzZWxmIHRvIHB1c2hTdGF0ZUhhbmRsZXIgc28gd2UgY2FuIHJlZmVyZW5jZSBpdCBzYW5lbHkgd2l0aGluIHRoZQoJLy8gbWV0aG9kcyBoYW5kZWQgb2ZmIGFzIGV2ZW50IGhhbmRsZXJzCgl2YXIJcHVzaFN0YXRlSGFuZGxlciA9IHt9LAoJCXNlbGYgPSBwdXNoU3RhdGVIYW5kbGVyLAoJCSR3aW4gPSAkKCB3aW5kb3cgKSwKCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCBsb2NhdGlvbi5ocmVmICk7CgoJJC5leHRlbmQoIHB1c2hTdGF0ZUhhbmRsZXIsIHsKCQkvLyBUT0RPIG1vdmUgdG8gYSBwYXRoIGhlbHBlciwgdGhpcyBpcyByYXRoZXIgY29tbW9uIGZ1bmN0aW9uYWxpdHkKCQlpbml0aWFsRmlsZVBhdGg6IChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHVybC5wYXRobmFtZSArIHVybC5zZWFyY2g7CgkJfSkoKSwKCgkJaW5pdGlhbEhyZWY6IHVybC5ocmVmTm9IYXNoLAoKCQkvLyBGbGFnIGZvciB0cmFja2luZyBpZiBhIEhhc2hjaGFuZ2UgbmF0dXJhbGx5IG9jY3VycyBhZnRlciBlYWNoIHBvcHN0YXRlICsgcmVwbGFjZQoJCWhhc2hjaGFuZ2VGaXJlZDogZmFsc2UsCgoJCXN0YXRlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHsKCQkJCWhhc2g6IGxvY2F0aW9uLmhhc2ggfHwgIiMiICsgc2VsZi5pbml0aWFsRmlsZVBhdGgsCgkJCQl0aXRsZTogZG9jdW1lbnQudGl0bGUsCgoJCQkJLy8gcGVyc2lzdCBhY3Jvc3MgcmVmcmVzaAoJCQkJaW5pdGlhbEhyZWY6IHNlbGYuaW5pdGlhbEhyZWYKCQkJfTsKCQl9LAoKCQlyZXNldFVJS2V5czogZnVuY3Rpb24oIHVybCApIHsKCQkJdmFyIGRpYWxvZyA9ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXksCgkJCQlzdWJrZXkgPSAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5LAoJCQkJZGlhbG9nSW5kZXggPSB1cmwuaW5kZXhPZiggZGlhbG9nICk7CgoJCQlpZiggZGlhbG9nSW5kZXggPiAtMSApIHsKCQkJCXVybCA9IHVybC5zbGljZSggMCwgZGlhbG9nSW5kZXggKSArICIjIiArIHVybC5zbGljZSggZGlhbG9nSW5kZXggKTsKCQkJfSBlbHNlIGlmKCB1cmwuaW5kZXhPZiggc3Via2V5ICkgPiAtMSApIHsKCQkJCXVybCA9IHVybC5zcGxpdCggc3Via2V5ICkuam9pbiggIiMiICsgc3Via2V5ICk7CgkJCX0KCgkJCXJldHVybiB1cmw7CgkJfSwKCgkJLy8gVE9ETyBzb3J0IG91dCBhIHNpbmdsZSBiYXJyaWVyIHRvIGhhc2hjaGFuZ2UgZnVuY3Rpb25hbGl0eQoJCW5leHRIYXNoQ2hhbmdlUHJldmVudGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCSQubW9iaWxlLnVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSB2YWx1ZTsKCQkJc2VsZi5vbkhhc2hDaGFuZ2VEaXNhYmxlZCA9IHZhbHVlOwoJCX0sCgoJCS8vIG9uIGhhc2ggY2hhbmdlIHdlIHdhbnQgdG8gY2xlYW4gdXAgdGhlIHVybAoJCS8vIE5PVEUgdGhpcyB0YWtlcyBwbGFjZSAqYWZ0ZXIqIHRoZSB2YW5pbGxhIG5hdmlnYXRpb24gaGFzaCBjaGFuZ2UKCQkvLyBoYW5kbGluZyBoYXMgdGFrZW4gcGxhY2UgYW5kIHNldCB0aGUgc3RhdGUgb2YgdGhlIERPTQoJCW9uSGFzaENoYW5nZTogZnVuY3Rpb24oIGUgKSB7CgkJCS8vIGRpc2FibGUgdGhpcyBoYXNoIGNoYW5nZQoJCQlpZiggc2VsZi5vbkhhc2hDaGFuZ2VEaXNhYmxlZCApewoJCQkJcmV0dXJuOwoJCQl9CgkJCQoJCQl2YXIgaHJlZiwgc3RhdGUsCgkJCQloYXNoID0gbG9jYXRpb24uaGFzaCwKCQkJCWlzUGF0aCA9ICQubW9iaWxlLnBhdGguaXNQYXRoKCBoYXNoICksCgkJCQlyZXNvbHV0aW9uVXJsID0gaXNQYXRoID8gbG9jYXRpb24uaHJlZiA6ICQubW9iaWxlLmdldERvY3VtZW50VXJsKCk7CgkJCWhhc2ggPSBpc1BhdGggPyBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6IGhhc2g7CgoJCQkvLyBwcm9wdWxhdGUgdGhlIGhhc2ggd2hlbiBpdHMgbm90IGF2YWlsYWJsZQoJCQlzdGF0ZSA9IHNlbGYuc3RhdGUoKTsKCgkJCS8vIG1ha2UgdGhlIGhhc2ggYWJvbHV0ZSB3aXRoIHRoZSBjdXJyZW50IGhyZWYKCQkJaHJlZiA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCBoYXNoLCByZXNvbHV0aW9uVXJsICk7CgoJCQlpZiAoIGlzUGF0aCApIHsKCQkJCWhyZWYgPSBzZWxmLnJlc2V0VUlLZXlzKCBocmVmICk7CgkJCX0KCgkJCS8vIHJlcGxhY2UgdGhlIGN1cnJlbnQgdXJsIHdpdGggdGhlIG5ldyBocmVmIGFuZCBzdG9yZSB0aGUgc3RhdGUKCQkJLy8gTm90ZSB0aGF0IGluIHNvbWUgY2FzZXMgd2UgbWlnaHQgYmUgcmVwbGFjaW5nIGFuIHVybCB3aXRoIHRoZQoJCQkvLyBzYW1lIHVybC4gV2UgZG8gdGhpcyBhbnl3YXlzIGJlY2F1c2Ugd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdAoJCQkvLyBhbGwgb2Ygb3VyIGhpc3RvcnkgZW50cmllcyBoYXZlIGEgc3RhdGUgb2JqZWN0IGFzc29jaWF0ZWQgd2l0aAoJCQkvLyB0aGVtLiBUaGlzIGFsbG93cyB1cyB0byB3b3JrIGFyb3VuZCB0aGUgY2FzZSB3aGVyZSB3aW5kb3cuaGlzdG9yeS5iYWNrKCkKCQkJLy8gaXMgY2FsbGVkIHRvIHRyYW5zaXRpb24gZnJvbSBhbiBleHRlcm5hbCBwYWdlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuCgkJCS8vIEluIHRoYXQgcGFydGljdWxhciBjYXNlLCBhIGhhc2hjaGFuZ2UgZXZlbnQgaXMgKk5PVCogZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLgoJCQkvLyBFbnN1cmluZyBlYWNoIGhpc3RvcnkgZW50cnkgaGFzIGEgc3RhdGUgb2JqZWN0IG1lYW5zIHRoYXQgb25Qb3BTdGF0ZSgpCgkJCS8vIHdpbGwgYWx3YXlzIHRyaWdnZXIgb3VyIGhhc2hjaGFuZ2UgY2FsbGJhY2sgZXZlbiB3aGVuIGEgaGFzaGNoYW5nZSBldmVudAoJCQkvLyBpcyBub3QgZmlyZWQuCgkJCWhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCQl9LAoKCQkvLyBvbiBwb3BzdGF0ZSAoaWUgYmFjayBvciBmb3J3YXJkKSB3ZSBuZWVkIHRvIHJlcGxhY2UgdGhlIGhhc2ggdGhhdCB3YXMgdGhlcmUgcHJldmlvdXNseQoJCS8vIGNsZWFuZWQgdXAgYnkgdGhlIGFkZGl0aW9uYWwgaGFzaCBoYW5kbGluZwoJCW9uUG9wU3RhdGU6IGZ1bmN0aW9uKCBlICkgewoJCQl2YXIgcG9wcGVkU3RhdGUgPSBlLm9yaWdpbmFsRXZlbnQuc3RhdGUsIGhvbGRuZXh0aGFzaGNoYW5nZSA9IGZhbHNlOwoKCQkJLy8gaWYgdGhlcmUncyBubyBzdGF0ZSBpdHMgbm90IGEgcG9wc3RhdGUgd2UgY2FyZSBhYm91dCwgaWUgY2hyb21lJ3MgaW5pdGlhbCBwb3BzdGF0ZQoJCQkvLyBvciBmb3J3YXJkIHBvcHN0YXRlCgkJCWlmKCBwb3BwZWRTdGF0ZSApIHsKCQkJCS8vIGRpc2FibGUgYW55IGhhc2hjaGFuZ2UgdHJpZ2dlcmVkIGJ5IHRoZSBicm93c2VyCgkJCQlzZWxmLm5leHRIYXNoQ2hhbmdlUHJldmVudGVkKCB0cnVlICk7CgoJCQkJLy8gZGVmZXIgb3VyIG1hbnVhbCBoYXNoY2hhbmdlIHVudGlsIGFmdGVyIHRoZSBicm93c2VyIGZpcmVkCgkJCQkvLyB2ZXJzaW9uIGhhcyBjb21lIGFuZCBnb25lCgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBtYW51YWwgaGFzaCBoYW5kbGluZyB0YWtlcyBwbGFjZQoJCQkJCXNlbGYubmV4dEhhc2hDaGFuZ2VQcmV2ZW50ZWQoIGZhbHNlICk7CgoJCQkJCS8vIGNoYW5nZSB0aGUgcGFnZSBiYXNlZCBvbiB0aGUgaGFzaAoJCQkJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlKCBwb3BwZWRTdGF0ZS5oYXNoICk7CgkJCQl9LCAxMDApOwoJCQl9CgkJfSwKCgkJaW5pdDogZnVuY3Rpb24oKSB7CgkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UiLCBzZWxmLm9uSGFzaENoYW5nZSApOwoKCQkJLy8gSGFuZGxlIHBvcHN0YXRlIGV2ZW50cyB0aGUgb2NjdXIgdGhyb3VnaCBoaXN0b3J5IGNoYW5nZXMKCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUiLCBzZWxmLm9uUG9wU3RhdGUgKTsKCgkJCS8vIGlmIHRoZXJlJ3Mgbm8gaGFzaCwgd2UgbmVlZCB0byByZXBsYWNlc3RhdGUgZm9yIHJldHVybmluZyB0byBob21lCgkJCWlmICggbG9jYXRpb24uaGFzaCA9PT0gIiIgKSB7CgkJCQloaXN0b3J5LnJlcGxhY2VTdGF0ZSggc2VsZi5zdGF0ZSgpLCBkb2N1bWVudC50aXRsZSwgbG9jYXRpb24uaHJlZiApOwoJCQl9CgkJfQoJfSk7CgoJJCggZnVuY3Rpb24oKSB7CgkJaWYoICQubW9iaWxlLnB1c2hTdGF0ZUVuYWJsZWQgJiYgJC5zdXBwb3J0LnB1c2hTdGF0ZSApewoJCQlwdXNoU3RhdGVIYW5kbGVyLmluaXQoKTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqICJ0cmFuc2l0aW9ucyIgcGx1Z2luIC0gUGFnZSBjaGFuZ2UgdHJhbmlzdGlvbnMKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBjc3MzVHJhbnNpdGlvbkhhbmRsZXIoIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20gKSB7CgoJdmFyIGRlZmVycmVkID0gbmV3ICQuRGVmZXJyZWQoKSwKCQlyZXZlcnNlQ2xhc3MgPSByZXZlcnNlID8gIiByZXZlcnNlIiA6ICIiLAoJCXZpZXdwb3J0Q2xhc3MgPSAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIG5hbWUsCgkJZG9uZUZ1bmMgPSBmdW5jdGlvbigpIHsKCgkJCSR0by5hZGQoICRmcm9tICkucmVtb3ZlQ2xhc3MoICJvdXQgaW4gcmV2ZXJzZSAiICsgbmFtZSApOwoKCQkJaWYgKCAkZnJvbSAmJiAkZnJvbVsgMCBdICE9PSAkdG9bIDAgXSApIHsKCQkJCSRmcm9tLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCQkJfQoKCQkJJHRvLnBhcmVudCgpLnJlbW92ZUNsYXNzKCB2aWV3cG9ydENsYXNzICk7CgoJCQlkZWZlcnJlZC5yZXNvbHZlKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tICk7CgkJfTsKCgkkdG8uYW5pbWF0aW9uQ29tcGxldGUoIGRvbmVGdW5jICk7CgoJJHRvLnBhcmVudCgpLmFkZENsYXNzKCB2aWV3cG9ydENsYXNzICk7CgoJaWYgKCAkZnJvbSApIHsKCQkkZnJvbS5hZGRDbGFzcyggbmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJfQoJJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyAiICIgKyBuYW1lICsgIiBpbiIgKyByZXZlcnNlQ2xhc3MgKTsKCglyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwp9CgovLyBNYWtlIG91ciB0cmFuc2l0aW9uIGhhbmRsZXIgcHVibGljLgokLm1vYmlsZS5jc3MzVHJhbnNpdGlvbkhhbmRsZXIgPSBjc3MzVHJhbnNpdGlvbkhhbmRsZXI7CgovLyBJZiB0aGUgZGVmYXVsdCB0cmFuc2l0aW9uIGhhbmRsZXIgaXMgdGhlICdub25lJyBoYW5kbGVyLCByZXBsYWNlIGl0IHdpdGggb3VyIGhhbmRsZXIuCmlmICggJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyID09PSAkLm1vYmlsZS5ub25lVHJhbnNpdGlvbkhhbmRsZXIgKSB7CgkkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSBjc3MzVHJhbnNpdGlvbkhhbmRsZXI7Cn0KCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiAiZGVncmFkZUlucHV0cyIgcGx1Z2luIC0gZGVncmFkZXMgaW5wdXRzIHRvIGFub3RoZXIgdHlwZSBhZnRlciBjdXN0b20gZW5oYW5jZW1lbnRzIGFyZSBtYWRlLgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07CgoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCgl2YXIgcGFnZSA9ICQoZS50YXJnZXQpLmNsb3Nlc3QoJzpqcW1EYXRhKHJvbGU9InBhZ2UiKScpLmRhdGEoInBhZ2UiKSwgb3B0aW9uczsKCglpZiggIXBhZ2UgKSB7CgkJcmV0dXJuOwoJfQoKCW9wdGlvbnMgPSBwYWdlLm9wdGlvbnM7CgoJLy8gZGVncmFkZSBpbnB1dHMgdG8gYXZvaWQgcG9vcmx5IGltcGxlbWVudGVkIG5hdGl2ZSBmdW5jdGlvbmFsaXR5CgkkKCBlLnRhcmdldCApLmZpbmQoICJpbnB1dCIgKS5ub3QoIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJdHlwZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCAidHlwZSIgKSwKCQkJb3B0VHlwZSA9IG9wdGlvbnMuZGVncmFkZUlucHV0c1sgdHlwZSBdIHx8ICJ0ZXh0IjsKCgkJaWYgKCBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSApIHsKCQkJdmFyIGh0bWwgPSAkKCAiPGRpdj4iICkuaHRtbCggJHRoaXMuY2xvbmUoKSApLmh0bWwoKSwKCQkJCS8vIEluIElFIGJyb3dzZXJzLCB0aGUgdHlwZSBzb21ldGltZXMgZG9lc24ndCBleGlzdCBpbiB0aGUgY2xvbmVkIG1hcmt1cCwgc28gd2UgcmVwbGFjZSB0aGUgY2xvc2luZyB0YWcgaW5zdGVhZAoJCQkJaGFzVHlwZSA9IGh0bWwuaW5kZXhPZiggIiB0eXBlPSIgKSA+IC0xLAoJCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LywKCQkJCXJlcHN0ciA9ICIgdHlwZT1cIiIgKyBvcHRUeXBlICsgIlwiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9XCIiICsgdHlwZSArICJcIiIgKyAoIGhhc1R5cGUgPyAiIiA6ICI+IiApOwoKCQkJJHRoaXMucmVwbGFjZVdpdGgoIGh0bWwucmVwbGFjZSggZmluZHN0ciwgcmVwc3RyICkgKTsKCQl9Cgl9KTsKCn0pOwoKfSkoIGpRdWVyeSApOy8qCiogImRpYWxvZyIgcGx1Z2luLgoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmRpYWxvZyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWNsb3NlQnRuVGV4dCAJOiAiQ2xvc2UiLAoJCW92ZXJsYXlUaGVtZQk6ICJhIiwKCQlpbml0U2VsZWN0b3IJOiAiOmpxbURhdGEocm9sZT0nZGlhbG9nJykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCWhlYWRlckNsb3NlQnV0dG9uID0gJCggIjxhIGhyZWY9JyMnIGRhdGEtIiArICQubW9iaWxlLm5zICsgImljb249J2RlbGV0ZScgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbnBvcz0nbm90ZXh0Jz4iKyB0aGlzLm9wdGlvbnMuY2xvc2VCdG5UZXh0ICsgIjwvYT4iICk7CgoJCSRlbC5hZGRDbGFzcyggInVpLW92ZXJsYXktIiArIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCgkJLy8gQ2xhc3MgdGhlIG1hcmt1cCBmb3IgZGlhbG9nIHN0eWxpbmcKCQkvLyBTZXQgYXJpYSByb2xlCgkJJGVsLmF0dHIoICJyb2xlIiwgImRpYWxvZyIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1kaWFsb2ciICkKCQkJLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIHVpLW92ZXJsYXktc2hhZG93IiApCgkJCQkucHJlcGVuZCggaGVhZGVyQ2xvc2VCdXR0b24gKQoJCQkuZW5kKCkKCQkJLmZpbmQoICI6anFtRGF0YShyb2xlPSdjb250ZW50JyksOmpxbURhdGEocm9sZT0nZm9vdGVyJykiICkKCQkJCS5hZGRDbGFzcyggInVpLW92ZXJsYXktc2hhZG93IiApCgkJCQkubGFzdCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApOwoKCQkvLyB0aGlzIG11c3QgYmUgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgc2VsZWN0IG1lbnUgZGlhbG9ncyBjYW4gcmVwbGFjZQoJCS8vIHRoZSBjbG9zZSBtZXRob2QuIFRoaXMgaXMgYSBjaGFuZ2UgZnJvbSBwcmV2aW91c2x5IGp1c3QgZGVmaW5pbmcgZGF0YS1yZWw9YmFjawoJCS8vIG9uIHRoZSBidXR0b24gYW5kIGxldHRpbmcgbmF2IGhhbmRsZSBpdAoJCWhlYWRlckNsb3NlQnV0dG9uLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbigpIHsKCQkJc2VsZi5jbG9zZSgpOwoJCX0pOwoKCQkvKiBiaW5kIGV2ZW50cwoJCQktIGNsaWNrcyBhbmQgc3VibWl0cyBzaG91bGQgdXNlIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24gdGhhdCB0aGUgZGlhbG9nIG9wZW5lZCB3aXRoCgkJCSAgdW5sZXNzIGEgZGF0YS10cmFuc2l0aW9uIGlzIHNwZWNpZmllZCBvbiB0aGUgbGluay9mb3JtCgkJCS0gaWYgdGhlIGNsaWNrIHdhcyBvbiB0aGUgY2xvc2UgYnV0dG9uLCBvciB0aGUgbGluayBoYXMgYSBkYXRhLXJlbD0iYmFjayIgaXQnbGwgZ28gYmFjayBpbiBoaXN0b3J5IG5hdHVyYWxseQoJCSovCgkJJGVsLmJpbmQoICJ2Y2xpY2sgc3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siID8gImEiIDogImZvcm0iICksCgkJCQlhY3RpdmU7CgoJCQlpZiAoICR0YXJnZXQubGVuZ3RoICYmICEkdGFyZ2V0LmpxbURhdGEoICJ0cmFuc2l0aW9uIiApICkgewoKCQkJCWFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCkgfHwge307CgoJCQkJJHRhcmdldC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHJhbnNpdGlvbiIsICggYWN0aXZlLnRyYW5zaXRpb24gfHwgJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gKSApCgkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXJlY3Rpb24iLCAicmV2ZXJzZSIgKTsKCQkJfQoJCX0pCgkJLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuZmluZCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0sCgoJLy8gQ2xvc2UgbWV0aG9kIGdvZXMgYmFjayBpbiBoaXN0b3J5CgljbG9zZTogZnVuY3Rpb24oKSB7CgkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCAkLm1vYmlsZS5kaWFsb2cucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yICkubGl2ZSggInBhZ2VjcmVhdGUiLCBmdW5jdGlvbigpewoJJCggdGhpcyApLmRpYWxvZygpOwp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBUaGlzIHBsdWdpbiBoYW5kbGVzIHRoZW1pbmcgYW5kIGxheW91dCBvZiBoZWFkZXJzLCBmb290ZXJzLCBhbmQgY29udGVudCBhcmVhcwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UZXh0ICA9ICJCYWNrIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5hZGRCYWNrQnRuICAgPSBmYWxzZTsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGhlbWUgPSBudWxsOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmhlYWRlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5mb290ZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuY29udGVudFRoZW1lID0gbnVsbDsKCiQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmxpdmUoICJwYWdlY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkKCXZhciAkcGFnZSA9ICQoIHRoaXMgKSwKCQlvID0gJHBhZ2UuZGF0YSggInBhZ2UiICkub3B0aW9ucywKCQlwYWdlUm9sZSA9ICRwYWdlLmpxbURhdGEoICJyb2xlIiApLAoJCXBhZ2VUaGVtZSA9IG8udGhlbWU7CgkKCSQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSwgOmpxbURhdGEocm9sZT0nZm9vdGVyJyksIDpqcW1EYXRhKHJvbGU9J2NvbnRlbnQnKSIsIHRoaXMgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJcm9sZSA9ICR0aGlzLmpxbURhdGEoICJyb2xlIiApLAoJCQl0aGVtZSA9ICR0aGlzLmpxbURhdGEoICJ0aGVtZSIgKSwKCQkJY29udGVudFRoZW1lID0gdGhlbWUgfHwgby5jb250ZW50VGhlbWUgfHwgKCBwYWdlUm9sZSA9PT0gImRpYWxvZyIgJiYgcGFnZVRoZW1lICksCgkJCSRoZWFkZXJhbmNob3JzLAoJCQlsZWZ0YnRuLAoJCQlyaWdodGJ0biwKCQkJYmFja0J0bjsKCQkJCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS0iICsgcm9sZSApOwkKCgkJLy9hcHBseSB0aGVtaW5nIGFuZCBtYXJrdXAgbW9kaWZpY2F0aW9ucyB0byBwYWdlLGhlYWRlcixjb250ZW50LGZvb3RlcgoJCWlmICggcm9sZSA9PT0gImhlYWRlciIgfHwgcm9sZSA9PT0gImZvb3RlciIgKSB7CgkJCQoJCQl2YXIgdGhpc1RoZW1lID0gdGhlbWUgfHwgKCByb2xlID09PSAiaGVhZGVyIiA/IG8uaGVhZGVyVGhlbWUgOiBvLmZvb3RlclRoZW1lICkgfHwgcGFnZVRoZW1lOwoKCQkJJHRoaXMKCQkJCS8vYWRkIHRoZW1lIGNsYXNzCgkJCQkuYWRkQ2xhc3MoICJ1aS1iYXItIiArIHRoaXNUaGVtZSApCgkJCQkvLyBBZGQgQVJJQSByb2xlCgkJCQkuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApOwoKCQkJLy8gUmlnaHQsbGVmdCBidXR0b25zCgkJCSRoZWFkZXJhbmNob3JzCT0gJHRoaXMuY2hpbGRyZW4oICJhIiApOwoJCQlsZWZ0YnRuCT0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKTsKCQkJcmlnaHRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCWxlZnRidG4gPSBsZWZ0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAwICkubm90KCAiLnVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCQkJCgkJCXJpZ2h0YnRuID0gcmlnaHRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDEgKS5hZGRDbGFzcyggInVpLWJ0bi1yaWdodCIgKS5sZW5ndGg7CgkJCQoJCQkvLyBBdXRvLWFkZCBiYWNrIGJ0biBvbiBwYWdlcyBiZXlvbmQgZmlyc3QgdmlldwoJCQlpZiAoIG8uYWRkQmFja0J0biAmJiAKCQkJCXJvbGUgPT09ICJoZWFkZXIiICYmCgkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJJHRoaXMuanFtRGF0YSggInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJIWxlZnRidG4gKSB7CgoJCQkJYmFja0J0biA9ICQoICI8YSBocmVmPScjJyBjbGFzcz0ndWktYnRuLWxlZnQnIGRhdGEtIisgJC5tb2JpbGUubnMgKyJyZWw9J2JhY2snIGRhdGEtIisgJC5tb2JpbGUubnMgKyJpY29uPSdhcnJvdy1sJz4iKyBvLmJhY2tCdG5UZXh0ICsiPC9hPiIgKQoJCQkJCS8vIElmIHRoZW1lIGlzIHByb3ZpZGVkLCBvdmVycmlkZSBkZWZhdWx0IGluaGVyaXRhbmNlCgkJCQkJLmF0dHIoICJkYXRhLSIrICQubW9iaWxlLm5zICsidGhlbWUiLCBvLmJhY2tCdG5UaGVtZSB8fCB0aGlzVGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oICR0aGlzICk7CQkJCQoJCQl9CgoJCQkvLyBQYWdlIHRpdGxlCgkJCSR0aGlzLmNoaWxkcmVuKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKQoJCQkJLmFkZENsYXNzKCAidWktdGl0bGUiICkKCQkJCS8vIFJlZ2FyZGxlc3Mgb2YgaCBlbGVtZW50IG51bWJlciBpbiBzcmMsIGl0IGJlY29tZXMgaDEgZm9yIHRoZSBlbmhhbmNlZCBwYWdlCgkJCQkuYXR0cih7CgkJCQkJInRhYmluZGV4IjogIjAiLAoJCQkJCSJyb2xlIjogImhlYWRpbmciLAoJCQkJCSJhcmlhLWxldmVsIjogIjEiCgkJCQl9KTsKCgkJfSBlbHNlIGlmICggcm9sZSA9PT0gImNvbnRlbnQiICkgewoJCQlpZiAoIGNvbnRlbnRUaGVtZSApIHsKCQkJICAgICR0aGlzLmFkZENsYXNzKCAidWktYm9keS0iICsgKCBjb250ZW50VGhlbWUgKSApOwoJCQl9CgoJCQkvLyBBZGQgQVJJQSByb2xlCgkJCSR0aGlzLmF0dHIoICJyb2xlIiwgIm1haW4iICk7CgkJfQoJfSk7Cn0pOwoKfSkoIGpRdWVyeSApOy8qCiogImNvbGxhcHNpYmxlIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgkJY29sbGFwc2VDdWVUZXh0OiAiIGNsaWNrIHRvIGNvbGxhcHNlIGNvbnRlbnRzIiwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJdGhlbWU6IG51bGwsCgkJY29udGVudFRoZW1lOiBudWxsLAoJCWljb25UaGVtZTogImQiLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWNvbGxhcHNpYmxlID0gJGVsLmFkZENsYXNzKCAidWktY29sbGFwc2libGUiICksCgkJCWNvbGxhcHNpYmxlSGVhZGluZyA9ICRlbC5jaGlsZHJlbiggby5oZWFkaW5nICkuZmlyc3QoKSwKCQkJY29sbGFwc2libGVDb250ZW50ID0gY29sbGFwc2libGUud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCc+PC9kaXY+IiApLmZpbmQoICIudWktY29sbGFwc2libGUtY29udGVudCIgKSwKCQkJY29sbGFwc2libGVTZXQgPSAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApLAoJCQljb2xsYXBzaWJsZXNJblNldCA9IGNvbGxhcHNpYmxlU2V0LmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIgKTsKCgkJLy8gUmVwbGFjZSBjb2xsYXBzaWJsZUhlYWRpbmcgaWYgaXQncyBhIGxlZ2VuZAoJCWlmICggY29sbGFwc2libGVIZWFkaW5nLmlzKCAibGVnZW5kIiApICkgewoJCQljb2xsYXBzaWJsZUhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyBjb2xsYXBzaWJsZUhlYWRpbmcuaHRtbCgpICsiPC9kaXY+IiApLmluc2VydEJlZm9yZSggY29sbGFwc2libGVIZWFkaW5nICk7CgkJCWNvbGxhcHNpYmxlSGVhZGluZy5uZXh0KCkucmVtb3ZlKCk7CgkJfQoKCQkvLyBJZiB3ZSBhcmUgaW4gYSBjb2xsYXBzaWJsZSBzZXQKCQlpZiAoIGNvbGxhcHNpYmxlU2V0Lmxlbmd0aCApIHsKCQkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby50aGVtZSApIHsKCQkJCW8udGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAidGhlbWUiICk7CgkJCX0KCQkJLy8gSW5oZXJpdCB0aGUgY29udGVudC10aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCQlpZiAoICFvLmNvbnRlbnRUaGVtZSApIHsKCQkJCW8uY29udGVudFRoZW1lID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImNvbnRlbnQtdGhlbWUiICk7CgkJCX0KCQl9CgoJCWNvbGxhcHNpYmxlQ29udGVudC5hZGRDbGFzcyggKCBvLmNvbnRlbnRUaGVtZSApID8gKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKSA6ICIiKTsKCgkJY29sbGFwc2libGVIZWFkaW5nCgkJCS8vZHJvcCBoZWFkaW5nIGluIGJlZm9yZSBjb250ZW50CgkJCS5pbnNlcnRCZWZvcmUoIGNvbGxhcHNpYmxlQ29udGVudCApCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApCgkJCS53cmFwSW5uZXIoICI8YSBocmVmPScjJyBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy10b2dnbGUnPjwvYT4iICkKCQkJLmZpbmQoICJhIiApCgkJCQkuZmlyc3QoKQoJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQlpY29uUG9zOiAibGVmdCIsCgkJCQkJaWNvbjogInBsdXMiLAoJCQkJCXRoZW1lOiBvLnRoZW1lCgkJCQl9KTsKCgkJaWYgKCAhY29sbGFwc2libGVTZXQubGVuZ3RoICkgewoJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLmFkZCggY29sbGFwc2libGVIZWFkaW5nLmZpbmQoICIudWktYnRuLWlubmVyIiApICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20iICk7CgkJfSBlbHNlIHsKCQkJLy8gSWYgd2UgYXJlIGluIGEgY29sbGFwc2libGUgc2V0CgoJCQkvLyBJbml0aWFsaXplIHRoZSBjb2xsYXBzaWJsZSBzZXQgaWYgaXQncyBub3QgYWxyZWFkeSBpbml0aWFsaXplZAoJCQlpZiAoICFjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIgKSApIHsKCgkJCQljb2xsYXBzaWJsZVNldAoJCQkJCS5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIsIHRydWUgKQoJCQkJCS5iaW5kKCAiZXhwYW5kIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCQkJJCggZXZlbnQudGFyZ2V0ICkKCQkJCQkJCS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApCgkJCQkJCQkuc2libGluZ3MoICIudWktY29sbGFwc2libGUiICkKCQkJCQkJCS50cmlnZ2VyKCAiY29sbGFwc2UiICk7CgoJCQkJCX0pOwoJCQl9CgoJCQljb2xsYXBzaWJsZXNJblNldC5maXJzdCgpCgkJCQkuZmluZCggImEiICkKCQkJCQkuZmlyc3QoKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICkKCQkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApOwoKCQkJY29sbGFwc2libGVzSW5TZXQubGFzdCgpCgkJCQkuanFtRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiLCB0cnVlICkKCQkJCS5maW5kKCAiYSIgKQoJCQkJCS5maXJzdCgpCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJvdHRvbSIgKQoJCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20iICk7CgoKCQkJaWYgKCBjb2xsYXBzaWJsZS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIgKSApIHsKCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLmFkZCAoIGNvbGxhcHNpYmxlSGVhZGluZy5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKSApCgkJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20iICk7CgkJCX0KCQl9CgoJCS8vZXZlbnRzCgkJY29sbGFwc2libGUKCQkJLmJpbmQoICJleHBhbmQgY29sbGFwc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCQlpc0NvbGxhcHNlID0gKCBldmVudC50eXBlID09PSAiY29sbGFwc2UiICksCgkJCQkJICAgIGNvbnRlbnRUaGVtZSA9IG8uY29udGVudFRoZW1lOwoKCQkJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlKQoJCQkJCQkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyIgKQoJCQkJCQkJLnRleHQoIGlzQ29sbGFwc2UgPyBvLmV4cGFuZEN1ZVRleHQgOiBvLmNvbGxhcHNlQ3VlVGV4dCApCgkJCQkJCS5lbmQoKQoJCQkJCQkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLW1pbnVzIiwgIWlzQ29sbGFwc2UgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1wbHVzIiwgaXNDb2xsYXBzZSApOwoKCQkJCQkkdGhpcy50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKTsKCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKS5hdHRyKCAiYXJpYS1oaWRkZW4iLCBpc0NvbGxhcHNlICk7CgoJCQkJCWlmICggY29udGVudFRoZW1lICYmICggIWNvbGxhcHNpYmxlU2V0Lmxlbmd0aCB8fCBjb2xsYXBzaWJsZS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIgKSApICkgewoJCQkJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLmFkZCggY29sbGFwc2libGVIZWFkaW5nLmZpbmQoICIudWktYnRuLWlubmVyIiApICkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1ib3R0b20iLCBpc0NvbGxhcHNlICk7CgkJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1ib3R0b20iLCAhaXNDb2xsYXBzZSApOwoJCQkJCX0KCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudHJpZ2dlciggInVwZGF0ZWxheW91dCIgKTsKCQkJCX0KCQkJfSkKCQkJLnRyaWdnZXIoIG8uY29sbGFwc2VkID8gImNvbGxhcHNlIiA6ICJleHBhbmQiICk7CgoJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCXZhciB0eXBlID0gY29sbGFwc2libGVIZWFkaW5nLmlzKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiApID8KCQkJCQkJCQkJCSJleHBhbmQiIDogImNvbGxhcHNlIjsKCgkJCQljb2xsYXBzaWJsZS50cmlnZ2VyKCB0eXBlICk7CgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfSk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICQubW9iaWxlLmNvbGxhcHNpYmxlLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5jb2xsYXBzaWJsZSgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAiZmllbGRjb250YWluIiBwbHVnaW4gLSBzaW1wbGUgY2xhc3MgYWRkaXRpb25zIHRvIG1ha2UgZm9ybSByb3cgc2VwYXJhdG9ycwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIHVpLWJvZHkgdWktYnIiICk7Cn07CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJCggIjpqcW1EYXRhKHJvbGU9J2ZpZWxkY29udGFpbicpIiwgZS50YXJnZXQgKS5maWVsZGNvbnRhaW4oKTsKfSk7Cgp9KSggalF1ZXJ5ICk7LyoKKiBwbHVnaW4gZm9yIGNyZWF0aW5nIENTUyBncmlkcwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmdyaWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCWdyaWQ6IG51bGwKCQkJfSxvcHRpb25zKSwKCQkJJGtpZHMgPSAkdGhpcy5jaGlsZHJlbigpLAoJCQlncmlkQ29scyA9IHtzb2xvOjEsIGE6MiwgYjozLCBjOjQsIGQ6NX0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggdmFyIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQl9CgkJCX0KCQkJaXRlcmF0b3IgPSBncmlkQ29sc1tncmlkXTsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLSIgKyBncmlkICk7CgoJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1hIiApOwoKCQlpZiAoIGl0ZXJhdG9yID4gMSApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisyKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWIiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAyICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKDNuKzMpIiApLmFkZENsYXNzKCAidWktYmxvY2stYyIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDMgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoNG4rNCkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1kIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gNCApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCg1bis1KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWUiICk7CgkJfQoJfSk7Cn07Cn0pKCBqUXVlcnkgKTsvKgoqICJuYXZiYXIiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J25hdmJhcicpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpewoKCQl2YXIgJG5hdmJhciA9IHRoaXMuZWxlbWVudCwKCQkJJG5hdmJ0bnMgPSAkbmF2YmFyLmZpbmQoICJhIiApLAoJCQlpY29ucG9zID0gJG5hdmJ0bnMuZmlsdGVyKCAiOmpxbURhdGEoaWNvbikiICkubGVuZ3RoID8KCQkJCQkJCQkJdGhpcy5vcHRpb25zLmljb25wb3MgOiB1bmRlZmluZWQ7CgoJCSRuYXZiYXIuYWRkQ2xhc3MoICJ1aS1uYXZiYXIiICkKCQkJLmF0dHIoICJyb2xlIiwibmF2aWdhdGlvbiIgKQoJCQkuZmluZCggInVsIiApCgkJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQlpZiAoICFpY29ucG9zICkgewoJCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyLW5vaWNvbnMiICk7CgkJfQoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkkbmF2YnRucy5ub3QoICIudWktc3RhdGUtcGVyc2lzdCIgKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0pOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkKCAkLm1vYmlsZS5uYXZiYXIucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCBlLnRhcmdldCApLm5hdmJhcigpOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAibGlzdHZpZXciIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovL0tlZXBzIHRyYWNrIG9mIHRoZSBudW1iZXIgb2YgbGlzdHMgcGVyIHBhZ2UgVUlECi8vVGhpcyBhbGxvd3Mgc3VwcG9ydCBmb3IgbXVsdGlwbGUgbmVzdGVkIGxpc3QgaW4gdGhlIHNhbWUgcGFnZQovL2h0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMTYxNwp2YXIgbGlzdENvdW50UGVyUGFnZSA9IHt9OwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3VudFRoZW1lOiAiYyIsCgkJaGVhZGVyVGhlbWU6ICJiIiwKCQlkaXZpZGVyVGhlbWU6ICJiIiwKCQlzcGxpdEljb246ICJhcnJvdy1yIiwKCQlzcGxpdFRoZW1lOiAiYiIsCgkJaW5zZXQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2xpc3R2aWV3JykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0ID0gdGhpczsKCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyhmdW5jdGlvbiggaSwgb3JpZyApIHsKCQkJcmV0dXJuIG9yaWcgKyAiIHVpLWxpc3R2aWV3ICIgKyAoIHQub3B0aW9ucy5pbnNldCA/ICIgdWktbGlzdHZpZXctaW5zZXQgdWktY29ybmVyLWFsbCB1aS1zaGFkb3cgIiA6ICIiICk7CgkJfSk7CgoJCXQucmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfcmVtb3ZlQ29ybmVyczogZnVuY3Rpb24oIGxpLCB3aGljaCApIHsKCQl2YXIgdG9wID0gInVpLWNvcm5lci10b3AgdWktY29ybmVyLXRyIHVpLWNvcm5lci10bCIsCgkJCWJvdCA9ICJ1aS1jb3JuZXItYm90dG9tIHVpLWNvcm5lci1iciB1aS1jb3JuZXItYmwiOwoKCQlsaSA9IGxpLmFkZCggbGkuZmluZCggIi51aS1idG4taW5uZXIsIC51aS1saS1saW5rLWFsdCwgLnVpLWxpLXRodW1iIiApICk7CgoJCWlmICggd2hpY2ggPT09ICJ0b3AiICkgewoJCQlsaS5yZW1vdmVDbGFzcyggdG9wICk7CgkJfSBlbHNlIGlmICggd2hpY2ggPT09ICJib3R0b20iICkgewoJCQlsaS5yZW1vdmVDbGFzcyggYm90ICk7CgkJfSBlbHNlIHsKCQkJbGkucmVtb3ZlQ2xhc3MoIHRvcCArICIgIiArIGJvdCApOwoJCX0KCX0sCgoJX3JlZnJlc2hDb3JuZXJzOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciAkbGksCgkJCSR2aXNpYmxlbGksCgkJCSR0b3BsaSwKCQkJJGJvdHRvbWxpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5pbnNldCApIHsKCQkJJGxpID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAibGkiICk7CgkJCS8vIGF0IGNyZWF0ZSB0aW1lIHRoZSBsaSBhcmUgbm90IHZpc2libGUgeWV0IHNvIHdlIG5lZWQgdG8gcmVseSBvbiAudWktc2NyZWVuLWhpZGRlbgoJCQkkdmlzaWJsZWxpID0gY3JlYXRlPyRsaS5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTokbGkuZmlsdGVyKCAiOnZpc2libGUiICk7CgoJCQl0aGlzLl9yZW1vdmVDb3JuZXJzKCAkbGkgKTsKCgkJCS8vIFNlbGVjdCB0aGUgZmlyc3QgdmlzaWJsZSBsaSBlbGVtZW50CgkJCSR0b3BsaSA9ICR2aXNpYmxlbGkuZmlyc3QoKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKTsKCgkJCSR0b3BsaS5hZGQoICR0b3BsaS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCS5ub3QoICIudWktbGktbGluay1hbHQgc3BhbjpmaXJzdC1jaGlsZCIgKSApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktbGluay1hbHQsIC51aS1saS1saW5rLWFsdCBzcGFuOmZpcnN0LWNoaWxkIiApCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRyIiApCgkJCQkuZW5kKCkKCQkJCS5maW5kKCAiLnVpLWxpLXRodW1iIiApCgkJCQkJLm5vdCgiLnVpLWxpLWljb24iKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10bCIgKTsKCgkJCS8vIFNlbGVjdCB0aGUgbGFzdCB2aXNpYmxlIGxpIGVsZW1lbnQKCQkJJGJvdHRvbWxpID0gJHZpc2libGVsaS5sYXN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20iICk7CgoJCQkkYm90dG9tbGkuYWRkKCAkYm90dG9tbGkuZmluZCggIi51aS1idG4taW5uZXIiICkgKQoJCQkJLmZpbmQoICIudWktbGktbGluay1hbHQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYnIiICkKCQkJCS5lbmQoKQoJCQkJLmZpbmQoICIudWktbGktdGh1bWIiICkKCQkJCQkubm90KCIudWktbGktaWNvbiIpCgkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWJsIiApOwoJCX0KCQlpZiAoICFjcmVhdGUgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCX0KCX0sCgoJLy8gVGhpcyBpcyBhIGdlbmVyaWMgdXRpbGl0eSBtZXRob2QgZm9yIGZpbmRpbmcgdGhlIGZpcnN0CgkvLyBub2RlIHdpdGggYSBnaXZlbiBub2RlTmFtZS4gSXQgdXNlcyBiYXNpYyBET00gdHJhdmVyc2FsCgkvLyB0byBiZSBmYXN0IGFuZCBpcyBtZWFudCB0byBiZSBhIHN1YnN0aXR1dGUgZm9yIHNpbXBsZQoJLy8gJC5mbi5jbG9zZXN0KCkgYW5kICQuZm4uY2hpbGRyZW4oKSBjYWxscyBvbiBhIHNpbmdsZQoJLy8gZWxlbWVudC4gTm90ZSB0aGF0IGNhbGxlcnMgbXVzdCBwYXNzIGJvdGggdGhlIGxvd2VyQ2FzZQoJLy8gYW5kIHVwcGVyQ2FzZSB2ZXJzaW9uIG9mIHRoZSBub2RlTmFtZSB0aGV5IGFyZSBsb29raW5nIGZvci4KCS8vIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcyBpcyB0aGF0IHRoaXMgZnVuY3Rpb24gd2lsbCBiZQoJLy8gY2FsbGVkIG1hbnkgdGltZXMgYW5kIHdlIHdhbnQgdG8gYXZvaWQgaGF2aW5nIHRvIGxvd2VyY2FzZQoJLy8gdGhlIG5vZGVOYW1lIGZyb20gdGhlIGVsZW1lbnQgZXZlcnkgdGltZSB0byBlbnN1cmUgd2UgaGF2ZQoJLy8gYSBtYXRjaC4gTm90ZSB0aGF0IHRoaXMgZnVuY3Rpb24gbGl2ZXMgaGVyZSBmb3Igbm93LCBidXQgbWF5CgkvLyBiZSBtb3ZlZCBpbnRvICQubW9iaWxlIGlmIG90aGVyIGNvbXBvbmVudHMgbmVlZCBhIHNpbWlsYXIgbWV0aG9kLgoJX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIG5leHRQcm9wLCBsY05hbWUsIHVjTmFtZSApCgl7CgkJdmFyIGRpY3QgPSB7fTsKCQlkaWN0WyBsY05hbWUgXSA9IGRpY3RbIHVjTmFtZSBdID0gdHJ1ZTsKCQl3aGlsZSAoIGVsZSApIHsKCQkJaWYgKCBkaWN0WyBlbGUubm9kZU5hbWUgXSApIHsKCQkJCXJldHVybiBlbGU7CgkJCX0KCQkJZWxlID0gZWxlWyBuZXh0UHJvcCBdOwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCglfZ2V0Q2hpbGRyZW5CeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIGxjTmFtZSwgdWNOYW1lICkKCXsKCQl2YXIgcmVzdWx0cyA9IFtdLAoJCQlkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJZWxlID0gZWxlLmZpcnN0Q2hpbGQ7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZSApOwoJCQl9CgkJCWVsZSA9IGVsZS5uZXh0U2libGluZzsKCQl9CgkJcmV0dXJuICQoIHJlc3VsdHMgKTsKCX0sCgoJX2FkZFRodW1iQ2xhc3NlczogZnVuY3Rpb24oIGNvbnRhaW5lcnMgKQoJewoJCXZhciBpLCBpbWcsIGxlbiA9IGNvbnRhaW5lcnMubGVuZ3RoOwoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWltZyA9ICQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGNvbnRhaW5lcnNbIGkgXS5maXJzdENoaWxkLCAibmV4dFNpYmxpbmciLCAiaW1nIiwgIklNRyIgKSApOwoJCQlpZiAoIGltZy5sZW5ndGggKSB7CgkJCQlpbWcuYWRkQ2xhc3MoICJ1aS1saS10aHVtYiIgKTsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5pcyggIi51aS1saS1pY29uIiApID8gInVpLWxpLWhhcy1pY29uIiA6ICJ1aS1saS1oYXMtdGh1bWIiICk7CgkJCX0KCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5wYXJlbnRQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQl0aGlzLl9jcmVhdGVTdWJQYWdlcygpOwoKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCXNlbGYgPSB0aGlzLAoJCQlkaXZpZGVydGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAiZGl2aWRlcnRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lLAoJCQlsaXN0c3BsaXR0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJzcGxpdHRoZW1lIiApLAoJCQlsaXN0c3BsaXRpY29uID0gJGxpc3QuanFtRGF0YSggInNwbGl0aWNvbiIgKSwKCQkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApLAoJCQljb3VudGVyID0gJC5zdXBwb3J0LmNzc1BzZXVkb0VsZW1lbnQgfHwgISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSA/IDAgOiAxLAoJCQlpdGVtQ2xhc3NEaWN0ID0ge30sCgkJCWl0ZW0sIGl0ZW1DbGFzcywgaXRlbVRoZW1lLAoJCQlhLCBsYXN0LCBzcGxpdHRoZW1lLCBjb3VudFBhcmVudCwgaWNvbiwgaW1nUGFyZW50cywgaW1nOwoKCQlpZiAoIGNvdW50ZXIgKSB7CgkJCSRsaXN0LmZpbmQoICIudWktbGktZGVjIiApLnJlbW92ZSgpOwoJCX0KCQkKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQlmb3IgKCB2YXIgcG9zID0gMCwgbnVtbGkgPSBsaS5sZW5ndGg7IHBvcyA8IG51bWxpOyBwb3MrKyApIHsKCQkJaXRlbSA9IGxpLmVxKCBwb3MgKTsKCQkJaXRlbUNsYXNzID0gInVpLWxpIjsKCgkJCS8vIElmIHdlJ3JlIGNyZWF0aW5nIHRoZSBlbGVtZW50LCB3ZSB1cGRhdGUgaXQgcmVnYXJkbGVzcwoJCQlpZiAoIGNyZWF0ZSB8fCAhaXRlbS5oYXNDbGFzcyggInVpLWxpIiApICkgewoJCQkJaXRlbVRoZW1lID0gaXRlbS5qcW1EYXRhKCJ0aGVtZSIpIHx8IG8udGhlbWU7CgkJCQlhID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIGl0ZW1bIDAgXSwgImEiLCAiQSIgKTsKCgkJCQlpZiAoIGEubGVuZ3RoICkgewoJCQkJCWljb24gPSBpdGVtLmpxbURhdGEoImljb24iKTsKCgkJCQkJaXRlbS5idXR0b25NYXJrdXAoewoJCQkJCQl3cmFwcGVyRWxzOiAiZGl2IiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCWljb25wb3M6ICJyaWdodCIsCgkJCQkJCWljb246IGEubGVuZ3RoID4gMSB8fCBpY29uID09PSBmYWxzZSA/IGZhbHNlIDogaWNvbiB8fCAiYXJyb3ctciIsCgkJCQkJCXRoZW1lOiBpdGVtVGhlbWUKCQkJCQl9KTsKCgkJCQkJaWYgKCAoIGljb24gIT0gZmFsc2UgKSAmJiAoIGEubGVuZ3RoID09IDEgKSApIHsKCQkJCQkJaXRlbS5hZGRDbGFzcyggInVpLWxpLWhhcy1hcnJvdyIgKTsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5hZGRDbGFzcyggInVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gbGlzdHNwbGl0dGhlbWUgfHwgbGFzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lOwoKCQkJCQkJbGFzdC5hcHBlbmRUbyhpdGVtKQoJCQkJCQkJLmF0dHIoICJ0aXRsZSIsIGxhc3QuZ2V0RW5jb2RlZFRleHQoKSApCgkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1saS1saW5rLWFsdCIgKQoJCQkJCQkJLmVtcHR5KCkKCQkJCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZSwKCQkJCQkJCQlpY29uOiBmYWxzZSwKCQkJCQkJCQlpY29ucG9zOiBmYWxzZQoJCQkJCQkJfSkKCQkJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJCS5hcHBlbmQoCgkJCQkJCQkJCSQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApICkuYnV0dG9uTWFya3VwKHsKCQkJCQkJCQkJCXNoYWRvdzogdHJ1ZSwKCQkJCQkJCQkJCWNvcm5lcnM6IHRydWUsCgkJCQkJCQkJCQl0aGVtZTogc3BsaXR0aGVtZSwKCQkJCQkJCQkJCWljb25wb3M6ICJub3RleHQiLAoJCQkJCQkJCQkJaWNvbjogbGlzdHNwbGl0aWNvbiB8fCBsYXN0LmpxbURhdGEoICJpY29uIiApIHx8IG8uc3BsaXRJY29uCgkJCQkJCQkJCX0pCgkJCQkJCQkJKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBpdGVtLmpxbURhdGEoICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApIHsKCgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktZGl2aWRlciB1aS1idG4gdWktYmFyLSIgKyBkaXZpZGVydGhlbWU7CgkJCQkJaXRlbS5hdHRyKCAicm9sZSIsICJoZWFkaW5nIiApOwoKCQkJCQkvL3Jlc2V0IGNvdW50ZXIgd2hlbiBhIGRpdmlkZXIgaGVhZGluZyBpcyBlbmNvdW50ZXJlZAoJCQkJCWlmICggY291bnRlciApIHsKCQkJCQkJY291bnRlciA9IDE7CgkJCQkJfQoKCQkJCX0gZWxzZSB7CgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktc3RhdGljIHVpLWJvZHktIiArIGl0ZW1UaGVtZTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBjb3VudGVyICYmIGl0ZW1DbGFzcy5pbmRleE9mKCAidWktbGktZGl2aWRlciIgKSA8IDAgKSB7CgkJCQljb3VudFBhcmVudCA9IGl0ZW0uaXMoICIudWktbGktc3RhdGljOmZpcnN0IiApID8gaXRlbSA6IGl0ZW0uZmluZCggIi51aS1saW5rLWluaGVyaXQiICk7CgoJCQkJY291bnRQYXJlbnQuYWRkQ2xhc3MoICJ1aS1saS1qc251bWJlcmluZyIgKQoJCQkJCS5wcmVwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWxpLWRlYyc+IiArIChjb3VudGVyKyspICsgIi4gPC9zcGFuPiIgKTsKCQkJfQoKCQkJLy8gSW5zdGVhZCBvZiBzZXR0aW5nIGl0ZW0gY2xhc3MgZGlyZWN0bHkgb24gdGhlIGxpc3QgaXRlbSBhbmQgaXRzCgkJCS8vIGJ0bi1pbm5lciBhdCB0aGlzIHBvaW50IGluIHRpbWUsIHB1c2ggdGhlIGl0ZW0gaW50byBhIGRpY3Rpb25hcnkKCQkJLy8gdGhhdCB0ZWxscyB1cyB3aGF0IGNsYXNzIHRvIHNldCBvbiBpdCBzbyB3ZSBjYW4gZG8gdGhpcyBhZnRlciB0aGlzCgkJCS8vIHByb2Nlc3NpbmcgbG9vcCBpcyBmaW5pc2hlZC4KCgkJCWlmICggIWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkgewoJCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gPSBbXTsKCQkJfQoKCQkJaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0ucHVzaCggaXRlbVsgMCBdICk7CgkJfQoKCQkvLyBTZXQgdGhlIGFwcHJvcHJpYXRlIGxpc3R2aWV3IGl0ZW0gY2xhc3NlcyBvbiBlYWNoIGxpc3QgaXRlbQoJCS8vIGFuZCB0aGVpciBidG4taW5uZXIgZWxlbWVudHMuIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApLmNoaWxkcmVuKCAiLnVpLWJ0bi1pbm5lciIgKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQkkbGlzdC5maW5kKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKS5hZGRDbGFzcyggInVpLWxpLWhlYWRpbmciICkKCQkJLmVuZCgpCgoJCQkuZmluZCggInAsIGRsIiApLmFkZENsYXNzKCAidWktbGktZGVzYyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAiLnVpLWxpLWFzaWRlIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJdmFyICR0aGlzID0gJCh0aGlzKTsKCQkJCQkkdGhpcy5wcmVwZW5kVG8oICR0aGlzLnBhcmVudCgpICk7IC8vc2hpZnQgYXNpZGUgdG8gZnJvbnQgZm9yIGNzcyBmbG9hdAoJCQkJfSkKCQkJLmVuZCgpCgoJCQkuZmluZCggIi51aS1saS1jb3VudCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCQkJfSkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArICggJGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUpICsgIiB1aS1idG4tY29ybmVyLWFsbCIgKTsKCgkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBsb29rIGF0IHRoZSBmaXJzdCBpbWFnZSBpbiB0aGUgbGlzdCBpdGVtCgkJLy8gaXRzZWxmLCBhbmQgYW55IC51aS1saW5rLWluaGVyaXQgZWxlbWVudCBpdCBtYXkgY29udGFpbiwgc28gd2UKCQkvLyBjYW4gcGxhY2UgdGhlIGFwcHJvcHJpYXRlIGNsYXNzZXMgb24gdGhlIGltYWdlIGFuZCBsaXN0IGl0ZW0uCgkJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIHNvbWV0aGluZyBsaWtlOgoJCS8vCgkJLy8gICAgbGkuZmluZCgiPmltZzplcSgwKSwgLnVpLWxpbmstaW5oZXJpdD5pbWc6ZXEoMCkiKS5lYWNoKCAuLi4gKTsKCQkvLwoJCS8vIEJ1dCBleGVjdXRpbmcgYSBmaW5kKCkgbGlrZSB0aGF0IG9uIFdpbmRvd3MgUGhvbmUgNy41IHRvb2sgYQoJCS8vIHJlYWxseSBsb25nIHRpbWUuIFdhbGtpbmcgdGhpbmdzIG1hbnVhbGx5IHdpdGggdGhlIGNvZGUgYmVsb3cKCQkvLyBhbGxvd3MgdGhlIDQwMCBsaXN0dmlldyBpdGVtIHBhZ2UgdG8gbG9hZCBpbiBhYm91dCAzIHNlY29uZHMgYXMKCQkvLyBvcHBvc2VkIHRvIDMwIHNlY29uZHMuCgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoICRsaXN0LmZpbmQoICIudWktbGluay1pbmhlcml0IiApICk7CgoJCXRoaXMuX3JlZnJlc2hDb3JuZXJzKCBjcmVhdGUgKTsKCX0sCgoJLy9jcmVhdGUgYSBzdHJpbmcgZm9yIElEL3N1YnBhZ2UgdXJsIGNyZWF0aW9uCglfaWRTdHJpbmdFc2NhcGU6IGZ1bmN0aW9uKCBzdHIgKSB7CgkJcmV0dXJuIHN0ci5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywgJy0nKTsKCX0sCgoJX2NyZWF0ZVN1YlBhZ2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFyZW50TGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50UGFnZSA9IHBhcmVudExpc3QuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlwYXJlbnRVcmwgPSBwYXJlbnRQYWdlLmpxbURhdGEoICJ1cmwiICksCgkJCXBhcmVudElkID0gcGFyZW50VXJsIHx8IHBhcmVudFBhZ2VbIDAgXVsgJC5leHBhbmRvIF0sCgkJCXBhcmVudExpc3RJZCA9IHBhcmVudExpc3QuYXR0ciggImlkIiApLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlkbnMgPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJCXNlbGYgPSB0aGlzLAoJCQlwZXJzaXN0ZW50Rm9vdGVySUQgPSBwYXJlbnRQYWdlLmZpbmQoICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKS5qcW1EYXRhKCAiaWQiICksCgkJCWhhc1N1YlBhZ2VzOwoKCQlpZiAoIHR5cGVvZiBsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID09PSAidW5kZWZpbmVkIiApIHsKCQkJbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXSA9IC0xOwoJCX0KCgkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdElkIHx8ICsrbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXTsKCgkJJCggcGFyZW50TGlzdC5maW5kKCAibGk+dWwsIGxpPm9sIiApLnRvQXJyYXkoKS5yZXZlcnNlKCkgKS5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlsaXN0ID0gJCggdGhpcyApLAoJCQkJbGlzdElkID0gbGlzdC5hdHRyKCAiaWQiICkgfHwgcGFyZW50TGlzdElkICsgIi0iICsgaSwKCQkJCXBhcmVudCA9IGxpc3QucGFyZW50KCksCgkJCQlub2RlRWxzID0gJCggbGlzdC5wcmV2QWxsKCkudG9BcnJheSgpLnJldmVyc2UoKSApLAoJCQkJbm9kZUVscyA9IG5vZGVFbHMubGVuZ3RoID8gbm9kZUVscyA6ICQoICI8c3Bhbj4iICsgJC50cmltKHBhcmVudC5jb250ZW50cygpWyAwIF0ubm9kZVZhbHVlKSArICI8L3NwYW4+IiApLAoJCQkJdGl0bGUgPSBub2RlRWxzLmZpcnN0KCkuZ2V0RW5jb2RlZFRleHQoKSwvL3VybCBsaW1pdHMgdG8gZmlyc3QgMzAgY2hhcnMgb2YgdGV4dAoJCQkJaWQgPSAoIHBhcmVudFVybCB8fCAiIiApICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArICI9IiArIGxpc3RJZCwKCQkJCXRoZW1lID0gbGlzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby50aGVtZSwKCQkJCWNvdW50VGhlbWUgPSBsaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IHBhcmVudExpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgby5jb3VudFRoZW1lLAoJCQkJbmV3UGFnZSwgYW5jaG9yOwoKCQkJLy9kZWZpbmUgaGFzU3ViUGFnZXMgZm9yIHVzZSBpbiBsYXRlciByZW1vdmFsCgkJCWhhc1N1YlBhZ2VzID0gdHJ1ZTsKCgkJCW5ld1BhZ2UgPSBsaXN0LmRldGFjaCgpCgkJCQkJCS53cmFwKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J3BhZ2UnICIgKwlkbnMgKyAidXJsPSciICsgaWQgKyAiJyAiICsgZG5zICsgInRoZW1lPSciICsgdGhlbWUgKyAiJyAiICsgZG5zICsgImNvdW50LXRoZW1lPSciICsgY291bnRUaGVtZSArICInPjxkaXYgIiArIGRucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj48L2Rpdj4iICkKCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkuYmVmb3JlKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2hlYWRlcicgIiArIGRucyArICJ0aGVtZT0nIiArIG8uaGVhZGVyVGhlbWUgKyAiJz48ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIHRpdGxlICsgIjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkJLmFmdGVyKCBwZXJzaXN0ZW50Rm9vdGVySUQgPyAkKCAiPGRpdiAiICsgZG5zICsgInJvbGU9J2Zvb3RlcicgIiArIGRucyArICJpZD0nIisgcGVyc2lzdGVudEZvb3RlcklEICsiJz4iKSA6ICIiICkKCQkJCQkJCS5wYXJlbnQoKQoJCQkJCQkJCS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJbmV3UGFnZS5wYWdlKCk7CgoJCQlhbmNob3IgPSBwYXJlbnQuZmluZCgnYTpmaXJzdCcpOwoKCQkJaWYgKCAhYW5jaG9yLmxlbmd0aCApIHsKCQkJCWFuY2hvciA9ICQoICI8YS8+IiApLmh0bWwoIG5vZGVFbHMgfHwgdGl0bGUgKS5wcmVwZW5kVG8oIHBhcmVudC5lbXB0eSgpICk7CgkJCX0KCgkJCWFuY2hvci5hdHRyKCAiaHJlZiIsICIjIiArIGlkICk7CgoJCX0pLmxpc3R2aWV3KCk7CgoJCS8vIG9uIHBhZ2VoaWRlLCByZW1vdmUgYW55IG5lc3RlZCBwYWdlcyBhbG9uZyB3aXRoIHRoZSBwYXJlbnQgcGFnZSwgYXMgbG9uZyBhcyB0aGV5IGFyZW4ndCBhY3RpdmUKCQkvLyBhbmQgYXJlbid0IGVtYmVkZGVkCgkJaWYoIGhhc1N1YlBhZ2VzICYmCgkJCXBhcmVudFBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgJiYKCQkJcGFyZW50UGFnZS5kYXRhKCJwYWdlIikub3B0aW9ucy5kb21DYWNoZSA9PT0gZmFsc2UgKSB7CgoJCQl2YXIgbmV3UmVtb3ZlID0gZnVuY3Rpb24oIGUsIHVpICl7CgkJCQl2YXIgbmV4dFBhZ2UgPSB1aS5uZXh0UGFnZSwgbnBVUkw7CgoJCQkJaWYoIHVpLm5leHRQYWdlICl7CgkJCQkJbnBVUkwgPSBuZXh0UGFnZS5qcW1EYXRhKCAidXJsIiApOwoJCQkJCWlmKCBucFVSTC5pbmRleE9mKCBwYXJlbnRVcmwgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgIT09IDAgKXsKCQkJCQkJc2VsZi5jaGlsZFBhZ2VzKCkucmVtb3ZlKCk7CgkJCQkJCXBhcmVudFBhZ2UucmVtb3ZlKCk7CgkJCQkJfQoJCQkJfQoJCQl9OwoKCQkJLy8gdW5iaW5kIHRoZSBvcmlnaW5hbCBwYWdlIHJlbW92ZSBhbmQgcmVwbGFjZSB3aXRoIG91ciBzcGVjaWFsaXplZCB2ZXJzaW9uCgkJCXBhcmVudFBhZ2UKCQkJCS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICkKCQkJCS5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiwgbmV3UmVtb3ZlKTsKCQl9Cgl9LAoKCS8vIFRPRE8gc29ydCBvdXQgYSBiZXR0ZXIgd2F5IHRvIHRyYWNrIHN1YiBwYWdlcyBvZiB0aGUgbGlzdHZpZXcgdGhpcyBpcyBicml0dGxlCgljaGlsZFBhZ2VzOiBmdW5jdGlvbigpewoJCXZhciBwYXJlbnRVcmwgPSB0aGlzLnBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKTsKCgkJcmV0dXJuICQoICI6anFtRGF0YSh1cmxePSciKyAgcGFyZW50VXJsICsgIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSArIicpIik7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCSQoICQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5saXN0dmlldygpOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAibGlzdHZpZXciIGZpbHRlciBleHRlbnNpb24KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyID0gZmFsc2U7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyID0gIkZpbHRlciBpdGVtcy4uLiI7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclRoZW1lID0gImMiOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCB0ZXh0LCBzZWFyY2hWYWx1ZSApewoJcmV0dXJuIHRleHQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCBzZWFyY2hWYWx1ZSApID09PSAtMTsKfTsKCiQoICI6anFtRGF0YShyb2xlPSdsaXN0dmlldycpIiApLmxpdmUoICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCWxpc3R2aWV3ID0gbGlzdC5kYXRhKCAibGlzdHZpZXciICk7CgoJaWYgKCAhbGlzdHZpZXcub3B0aW9ucy5maWx0ZXIgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB3cmFwcGVyID0gJCggIjxmb3JtPiIsIHsKCQkJImNsYXNzIjogInVpLWxpc3R2aWV3LWZpbHRlciB1aS1iYXItIiArIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyVGhlbWUsCgkJCSJyb2xlIjogInNlYXJjaCIKCQl9KSwKCQlzZWFyY2ggPSAkKCAiPGlucHV0PiIsIHsKCQkJcGxhY2Vob2xkZXI6IGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIKCQl9KQoJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZSIsICJzZWFyY2giICkKCQkuanFtRGF0YSggImxhc3R2YWwiLCAiIiApCgkJLmJpbmQoICJrZXl1cCBjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCgkJCXZhciAkdGhpcyA9ICQodGhpcyksCgkJCQl2YWwgPSB0aGlzLnZhbHVlLnRvTG93ZXJDYXNlKCksCgkJCQlsaXN0SXRlbXMgPSBudWxsLAoJCQkJbGFzdHZhbCA9ICR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiApICsgIiIsCgkJCQljaGlsZEl0ZW1zID0gZmFsc2UsCgkJCQlpdGVtdGV4dCA9ICIiLAoJCQkJaXRlbSwgY2hhbmdlOwoKCQkJLy8gQ2hhbmdlIHZhbCBhcyBsYXN0dmFsIGZvciBuZXh0IGV4ZWN1dGlvbgoJCQkkdGhpcy5qcW1EYXRhKCAibGFzdHZhbCIgLCB2YWwgKTsKCQkJY2hhbmdlID0gdmFsLnN1YnN0ciggMCAsIGxhc3R2YWwubGVuZ3RoIC0gMSApLnJlcGxhY2UoIGxhc3R2YWwgLCAiIiApOwoKCQkJaWYgKCB2YWwubGVuZ3RoIDwgbGFzdHZhbC5sZW5ndGggfHwgY2hhbmdlLmxlbmd0aCAhPSAoIHZhbC5sZW5ndGggLSBsYXN0dmFsLmxlbmd0aCApICkgewoKCQkJCS8vIFJlbW92ZWQgY2hhcnMgb3IgcGFzdGVkIHNvbWV0aGluZyB0b3RhbGx5IGRpZmZlcmVudCwgY2hlY2sgYWxsIGl0ZW1zCgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gT25seSBjaGFycyBhZGRlZCwgbm90IHJlbW92ZWQsIG9ubHkgdXNlIHZpc2libGUgc3Vic2V0CgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiOm5vdCgudWktc2NyZWVuLWhpZGRlbikiICk7CgkJCX0KCgkJCWlmICggdmFsICkgewoKCQkJCS8vIFRoaXMgaGFuZGxlcyBoaWRpbmcgcmVndWxhciByb3dzIHdpdGhvdXQgdGhlIHRleHQgd2Ugc2VhcmNoIGZvcgoJCQkJLy8gYW5kIGFueSBsaXN0IGRpdmlkZXJzIHdpdGhvdXQgcmVndWxhciByb3dzIHNob3duIHVuZGVyIGl0CgoJCQkJZm9yICggdmFyIGkgPSBsaXN0SXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQkJaXRlbSA9ICQoIGxpc3RJdGVtc1sgaSBdICk7CgkJCQkJaXRlbXRleHQgPSBpdGVtLmpxbURhdGEoICJmaWx0ZXJ0ZXh0IiApIHx8IGl0ZW0udGV4dCgpOwoKCQkJCQlpZiAoIGl0ZW0uaXMoICJsaTpqcW1EYXRhKHJvbGU9bGlzdC1kaXZpZGVyKSIgKSApIHsKCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsICFjaGlsZEl0ZW1zICk7CgoJCQkJCQkvLyBOZXcgYnVja2V0IQoJCQkJCQljaGlsZEl0ZW1zID0gZmFsc2U7CgoJCQkJCX0gZWxzZSBpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2soIGl0ZW10ZXh0LCB2YWwgKSApIHsKCgkJCQkJCS8vbWFyayB0byBiZSBoaWRkZW4KCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgdHJ1ZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBUaGVyZSdzIGEgc2hvd24gaXRlbSBpbiB0aGUgYnVja2V0CgkJCQkJCWNoaWxkSXRlbXMgPSB0cnVlOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTaG93IGl0ZW1zLCBub3QgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIjpub3QoLnVpLWZpbHRlci1oaWRlcXVldWUpIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgoJCQkJLy8gSGlkZSBpdGVtcywgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIi51aS1maWx0ZXItaGlkZXF1ZXVlIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIHRydWUgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiLCBmYWxzZSApOwoKCQkJfSBlbHNlIHsKCgkJCQkvL2ZpbHRlcnZhbHVlIGlzIGVtcHR5ID0+IHNob3cgYWxsCgkJCQlsaXN0SXRlbXMudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgZmFsc2UgKTsKCQkJfQoJCQlsaXN0dmlldy5fcmVmcmVzaENvcm5lcnMoKTsKCQl9KQoJCS5hcHBlbmRUbyggd3JhcHBlciApCgkJLnRleHRpbnB1dCgpOwoKCWlmICggJCggdGhpcyApLmpxbURhdGEoICJpbnNldCIgKSApIHsKCQl3cmFwcGVyLmFkZENsYXNzKCAidWktbGlzdHZpZXctZmlsdGVyLWluc2V0IiApOwoJfQoKCXdyYXBwZXIuYmluZCggInN1Ym1pdCIsIGZ1bmN0aW9uKCkgewoJCXJldHVybiBmYWxzZTsKCX0pCgkuaW5zZXJ0QmVmb3JlKCBsaXN0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOy8qCiogIm5vanMiIHBsdWdpbiAtIGNsYXNzIHRvIG1ha2UgZWxlbWVudHMgaGlkZGVuIHRvIEEgZ3JhZGUgYnJvd3NlcnMKKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJCggIjpqcW1EYXRhKHJvbGU9J25vanMnKSIsIGUudGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1ub2pzIiApOwoJCn0pOwoKfSkoIGpRdWVyeSApOy8qCiogImNoZWNrYm94cmFkaW8iIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jaGVja2JveHJhZGlvIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCS8vIE5PVEU6IFdpbmRvd3MgUGhvbmUgY291bGQgbm90IGZpbmQgdGhlIGxhYmVsIHRocm91Z2ggYSBzZWxlY3RvcgoJCQkvLyBmaWx0ZXIgd29ya3MgdGhvdWdoLgoJCQlsYWJlbCA9IGlucHV0LmNsb3Nlc3QoICJmb3JtLGZpZWxkc2V0LDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKS5maW5kKCAibGFiZWxbZm9yPSciICsgaW5wdXRbIDAgXS5pZCArICInXSIpLAoJCQlpbnB1dHR5cGUgPSBpbnB1dC5hdHRyKCAidHlwZSIgKSwKCQkJY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZFN0YXRlID0gaW5wdXR0eXBlICsgIi1vZmYiLAoJCQlpY29uID0gaW5wdXQucGFyZW50cyggIjpqcW1EYXRhKHR5cGU9J2hvcml6b250YWwnKSIgKS5sZW5ndGggPyB1bmRlZmluZWQgOiB1bmNoZWNrZWRTdGF0ZSwKCQkJYWN0aXZlQnRuID0gaWNvbiA/ICIiIDogIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgY2hlY2tlZFN0YXRlICsgYWN0aXZlQnRuLAoJCQl1bmNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgdW5jaGVja2VkU3RhdGUsCgkJCWNoZWNrZWRpY29uID0gInVpLWljb24tIiArIGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkaWNvbiA9ICJ1aS1pY29uLSIgKyB1bmNoZWNrZWRTdGF0ZTsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlsYWJlbDogbGFiZWwsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzLAoJCQljaGVja2VkaWNvbjogY2hlY2tlZGljb24sCgkJCXVuY2hlY2tlZGljb246IHVuY2hlY2tlZGljb24KCQl9KTsKCgkJLy8gSWYgdGhlcmUncyBubyBzZWxlY3RlZCB0aGVtZS4uLgoJCWlmKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSB0aGlzLmVsZW1lbnQuanFtRGF0YSggInRoZW1lIiApOwoJCX0KCgkJbGFiZWwuYnV0dG9uTWFya3VwKHsKCQkJdGhlbWU6IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJaWNvbjogaWNvbiwKCQkJc2hhZG93OiBmYWxzZQoJCX0pOwoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJaW5wdXQuYWRkKCBsYWJlbCApCgkJCS53cmFwQWxsKCAiPGRpdiBjbGFzcz0ndWktIiArIGlucHV0dHlwZSArICInPjwvZGl2PiIgKTsKCgkJbGFiZWwuYmluZCh7CgkJCXZtb3VzZW92ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLnBhcmVudCgpLmlzKCAiLnVpLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQl9LAoKCQkJdmNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXNlbGYuX2NhY2hlVmFscygpOwoKCQkJCWlucHV0LnByb3AoICJjaGVja2VkIiwgaW5wdXR0eXBlID09PSAicmFkaW8iICYmIHRydWUgfHwgIWlucHV0LnByb3AoICJjaGVja2VkIiApICk7CgoJCQkJLy8gdHJpZ2dlciBjbGljayBoYW5kbGVyJ3MgYm91bmQgZGlyZWN0bHkgdG8gdGhlIGlucHV0IGFzIGEgc3Vic3RpdHV0ZSBmb3IKCQkJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCQkJLy8gVE9ETzogaXQgd291bGQgYmUgbmljZSB0byBsZXQgdGhlIGJyb3dzZXIncyBoYW5kbGUgdGhlIGNsaWNrcyBhbmQgcGFzcyB0aGVtCgkJCQkvLyAgICAgICB0aHJvdWdoIHRvIHRoZSBhc3NvY2lhdGUgaW5wdXQuIHdlIGNhbiBzd2FsbG93IHRoYXQgY2xpY2sgYXQgdGhlIHBhcmVudAoJCQkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJCQlpbnB1dC50cmlnZ2VySGFuZGxlciggJ2NsaWNrJyApOwoKCQkJCS8vIElucHV0IHNldCBmb3IgY29tbW9uIHJhZGlvIGJ1dHRvbnMgd2lsbCBjb250YWluIGFsbCB0aGUgcmFkaW8KCQkJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJCQkvLyBvZiBvdGhlciByYWRpb3MgZW5zdXJlcyB0aGUgYWN0aXZlIGJ1dHRvbiBzdGF0ZSBpcyBhcHBsaWVkIHByb3Blcmx5CgkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggaW5wdXQgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgoJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJfSk7CgoJCWlucHV0CgkJCS5iaW5kKHsKCQkJCXZtb3VzZWRvd246IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuX2NhY2hlVmFscygpOwoJCQkJfSwKCgkJCQl2Y2xpY2s6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciAkdGhpcyA9ICQodGhpcyk7CgoJCQkJCS8vIEFkZHMgY2hlY2tlZCBhdHRyaWJ1dGUgdG8gY2hlY2tlZCBpbnB1dCB3aGVuIGtleWJvYXJkIGlzIHVzZWQKCQkJCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgKSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIHRydWUpOwoJCQkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCgkdGhpcykucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCX0sCgoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLmFkZENsYXNzKCAidWktZm9jdXMiICk7CgkJCQl9LAoKCQkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJCWxhYmVsLnJlbW92ZUNsYXNzKCAidWktZm9jdXMiICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2NhY2hlVmFsczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKHRoaXMpOwoKCQkJJHRoaXMuanFtRGF0YSggImNhY2hlVmFsIiwgJHRoaXMuaXMoICI6Y2hlY2tlZCIgKSApOwoJCX0pOwoJfSwKCgkvL3JldHVybnMgZWl0aGVyIGEgc2V0IG9mIHJhZGlvcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXR0cmlidXRlLCBvciBhIHNpbmdsZSBjaGVja2JveAoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpewoJCWlmKHRoaXMuaW5wdXR0eXBlID09ICJjaGVja2JveCIpIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCQl9CgoJCXJldHVybiB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0sZmllbGRzZXQsOmpxbURhdGEocm9sZT0ncGFnZScpIiApCgkJCS5maW5kKCAiaW5wdXRbbmFtZT0nIisgdGhpcy5lbGVtZW50LmF0dHIoICJuYW1lIiApICsiJ11bdHlwZT0nIisgdGhpcy5pbnB1dHR5cGUgKyInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQodGhpcyk7CgoJCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgfHwgc2VsZi5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbGFiZWwgPSB0aGlzLmxhYmVsLAoJCQlpY29uID0gbGFiZWwuZmluZCggIi51aS1pY29uIiApOwoKCQkvLyBpbnB1dFswXS5jaGVja2VkIGV4cGFuZG8gZG9lc24ndCBhbHdheXMgcmVwb3J0IHRoZSBwcm9wZXIgdmFsdWUKCQkvLyBmb3IgY2hlY2tlZD0nY2hlY2tlZCcKCQlpZiAoICQoIGlucHV0WyAwIF0gKS5wcm9wKCAiY2hlY2tlZCIgKSApIHsKCgkJCWxhYmVsLmFkZENsYXNzKCB0aGlzLmNoZWNrZWRDbGFzcyApLnJlbW92ZUNsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICk7CgkJCWljb24uYWRkQ2xhc3MoIHRoaXMuY2hlY2tlZGljb24gKS5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRpY29uICk7CgoJCX0gZWxzZSB7CgoJCQlsYWJlbC5yZW1vdmVDbGFzcyggdGhpcy5jaGVja2VkQ2xhc3MgKS5hZGRDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCQlpY29uLnJlbW92ZUNsYXNzKCB0aGlzLmNoZWNrZWRpY29uICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkaWNvbiApOwoJCX0KCgkJaWYgKCBpbnB1dC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB0cnVlICkucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgZmFsc2UgKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5jaGVja2JveHJhZGlvLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiAiYnV0dG9uIiBwbHVnaW4gLSBsaW5rcyB0aGF0IHByb3h5IHRvIG5hdGl2ZSBpbnB1dC9idXR0b25zCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmJ1dHRvbiIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQlpbmxpbmU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQlpbml0U2VsZWN0b3I6ICJidXR0b24sIFt0eXBlPSdidXR0b24nXSwgW3R5cGU9J3N1Ym1pdCddLCBbdHlwZT0ncmVzZXQnXSwgW3R5cGU9J2ltYWdlJ10iCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdHlwZSwKCQkJbmFtZSwKCQkJJGJ1dHRvblBsYWNlaG9sZGVyOwoKCQkvLyBBZGQgQVJJQSByb2xlCgkJdGhpcy5idXR0b24gPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJLnRleHQoICRlbC50ZXh0KCkgfHwgJGVsLnZhbCgpICkKCQkJLmluc2VydEJlZm9yZSggJGVsICkKCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQl0aGVtZTogby50aGVtZSwKCQkJCWljb246IG8uaWNvbiwKCQkJCWljb25wb3M6IG8uaWNvbnBvcywKCQkJCWlubGluZTogby5pbmxpbmUsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQlzaGFkb3c6IG8uc2hhZG93LAoJCQkJaWNvbnNoYWRvdzogby5pY29uc2hhZG93CgkJCX0pCgkJCS5hcHBlbmQoICRlbC5hZGRDbGFzcyggInVpLWJ0bi1oaWRkZW4iICkgKTsKCgkJdHlwZSA9ICRlbC5hdHRyKCAidHlwZSIgKTsKCQluYW1lID0gJGVsLmF0dHIoICJuYW1lIiApOwoKCQkvLyBBZGQgaGlkZGVuIGlucHV0IGR1cmluZyBzdWJtaXQgaWYgaW5wdXQgdHlwZT0ic3VibWl0IiBoYXMgYSBuYW1lLgoJCWlmICggdHlwZSAhPT0gImJ1dHRvbiIgJiYgdHlwZSAhPT0gInJlc2V0IiAmJiBuYW1lICkgewoJCQkJJGVsLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbigpIHsKCQkJCQkvLyBBZGQgaGlkZGVuIGlucHV0IGlmIGl0IGRvZXNu4oCZdCBhbHJlYWR5IGV4aXN0LgoJCQkJCWlmKCAkYnV0dG9uUGxhY2Vob2xkZXIgPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyID0gJCggIjxpbnB1dD4iLCB7CgkJCQkJCQl0eXBlOiAiaGlkZGVuIiwKCQkJCQkJCW5hbWU6ICRlbC5hdHRyKCAibmFtZSIgKSwKCQkJCQkJCXZhbHVlOiAkZWwuYXR0ciggInZhbHVlIiApCgkJCQkJCX0pLmluc2VydEJlZm9yZSggJGVsICk7CgoJCQkJCQkvLyBCaW5kIHRvIGRvYyB0byByZW1vdmUgYWZ0ZXIgc3VibWl0IGhhbmRsaW5nCgkJCQkJCSQoIGRvY3VtZW50ICkub25lKCJzdWJtaXQiLCBmdW5jdGlvbigpewoJCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyLnJlbW92ZSgpOwoKCQkJCQkJCS8vIHJlc2V0IHRoZSBsb2NhbCB2YXIgc28gdGhhdCB0aGUgaGlkZGVuIGlucHV0CgkJCQkJCQkvLyB3aWxsIGJlIHJlLWFkZGVkIG9uIHN1YnNlcXVlbnQgY2xpY2tzCgkJCQkJCQkkYnV0dG9uUGxhY2Vob2xkZXIgPSB1bmRlZmluZWQ7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pOwoJCX0KCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIGZhbHNlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCAkZWwucHJvcCgiZGlzYWJsZWQiKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbmFibGUoKTsKCQl9CgoJCS8vIHRoZSB0ZXh0V3JhcHBlciBpcyBzdG9yZWQgYXMgYSBkYXRhIGVsZW1lbnQgb24gdGhlIGJ1dHRvbiBvYmplY3QKCQkvLyB0byBwcmV2ZW50IHJlZmVyZW5jaW5nIGJ5IGl0J3MgaW1wbGVtZW50YXRpb24gZGV0YWlscyAoZWcgJ2NsYXNzJykKCQl0aGlzLmJ1dHRvbi5kYXRhKCAndGV4dFdyYXBwZXInICkudGV4dCggJGVsLnRleHQoKSB8fCAkZWwudmFsKCkgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuYnV0dG9uLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJzbGlkZXIiIHBsdWdpbgoqLwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJdHJhY2tUaGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBUT0RPOiBFYWNoIG9mIHRoZXNlIHNob3VsZCBoYXZlIGNvbW1lbnRzIGV4cGxhaW4gd2hhdCB0aGV5J3JlIGZvcgoJCXZhciBzZWxmID0gdGhpcywKCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgoJCQlwYXJlbnRUaGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBjb250cm9sLCAiYyIgKSwKCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoKCQkJY1R5cGUgPSBjb250cm9sWyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCgkJCXNlbGVjdENsYXNzID0gKCBjVHlwZSA9PSAic2VsZWN0IiApID8gInVpLXNsaWRlci1zd2l0Y2giIDogIiIsCgoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCgkJCWxhYmVsSUQgPSBjb250cm9sSUQgKyAiLWxhYmVsIiwKCgkJCWxhYmVsID0gJCggIltmb3I9JyIrIGNvbnRyb2xJRCArIiddIiApLmF0dHIoICJpZCIsIGxhYmVsSUQgKSwKCgkJCXZhbCA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICBjVHlwZSA9PSAiaW5wdXQiICA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfSwKCgkJCW1pbiA9ICBjVHlwZSA9PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoKCQkJbWF4ID0gIGNUeXBlID09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgoJCQlzbGlkZXIgPSAkKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyICIgKyBzZWxlY3RDbGFzcyArICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgKwoJCQkJCQkJCQkiIHVpLWJ0bi1jb3JuZXItYWxsJyByb2xlPSdhcHBsaWNhdGlvbic+PC9kaXY+IiApLAoKCQkJaGFuZGxlID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1zbGlkZXItaGFuZGxlJz48L2E+IiApCgkJCQkuYXBwZW5kVG8oIHNsaWRlciApCgkJCQkuYnV0dG9uTWFya3VwKHsgY29ybmVyczogdHJ1ZSwgdGhlbWU6IHRoZW1lLCBzaGFkb3c6IHRydWUgfSkKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJzbGlkZXIiLAoJCQkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkJCSJhcmlhLXZhbHVlbm93IjogdmFsKCksCgkJCQkJImFyaWEtdmFsdWV0ZXh0IjogdmFsKCksCgkJCQkJInRpdGxlIjogdmFsKCksCgkJCQkJImFyaWEtbGFiZWxsZWRieSI6IGxhYmVsSUQKCQkJCX0pLAoJCQlvcHRpb25zOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggY1R5cGUgPT0gInNlbGVjdCIgKSB7CgoJCQlzbGlkZXIud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyLWlubmVyb2Zmc2V0Jz48L2Rpdj4iICk7CgkJCQoJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCW9wdGlvbnMgPSBjb250cm9sLmZpbmQoICJvcHRpb24iICk7CgoJCQljb250cm9sLmZpbmQoICJvcHRpb24iICkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQl2YXIgc2lkZSA9ICFpID8gImIiOiJhIiwKCQkJCQljb3JuZXJzID0gIWkgPyAicmlnaHQiIDoibGVmdCIsCgkJCQkJdGhlbWUgPSAhaSA/ICIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUgOiggIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCgkJCQkkKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyLWxhYmVsYmcgdWktc2xpZGVyLWxhYmVsYmctIiArIHNpZGUgKyB0aGVtZSArICIgdWktYnRuLWNvcm5lci0iICsgY29ybmVycyArICInPjwvZGl2PiIgKQoJCQkJCS5wcmVwZW5kVG8oIHNsaWRlciApOwoKCQkJCSQoICI8c3BhbiBjbGFzcz0ndWktc2xpZGVyLWxhYmVsIHVpLXNsaWRlci1sYWJlbC0iICsgc2lkZSArIHRoZW1lICsgIiB1aS1idG4tY29ybmVyLSIgKyBjb3JuZXJzICsgIicgcm9sZT0naW1nJz4iICsgJCggdGhpcyApLmdldEVuY29kZWRUZXh0KCkgKyAiPC9zcGFuPiIgKQoJCQkJCS5wcmVwZW5kVG8oIGhhbmRsZSApOwoJCQl9KTsKCgkJfQoKCQlsYWJlbC5hZGRDbGFzcyggInVpLXNsaWRlciIgKTsKCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggY1R5cGUgPT09ICJpbnB1dCIgPyAidWktc2xpZGVyLWlucHV0IiA6ICJ1aS1zbGlkZXItc3dpdGNoIiApCgkJCS5jaGFuZ2UoIGZ1bmN0aW9uKCkgewoJCQkJLy8gaWYgdGhlIHVzZXIgZHJhZ2dlZCB0aGUgaGFuZGxlLCB0aGUgImNoYW5nZSIgZXZlbnQgd2FzIHRyaWdnZXJlZCBmcm9tIGluc2lkZSByZWZyZXNoKCk7IGRvbid0IGNhbGwgcmVmcmVzaCgpIGFnYWluCgkJCQlpZiAoIXNlbGYubW91c2VNb3ZlZCkgewoJCQkJCXNlbGYucmVmcmVzaCggdmFsKCksIHRydWUgKTsKCQkJCX0KCQkJfSkKCQkJLmtleXVwKCBmdW5jdGlvbigpIHsgLy8gbmVjZXNzYXJ5PwoJCQkJc2VsZi5yZWZyZXNoKCB2YWwoKSwgdHJ1ZSwgdHJ1ZSApOwoJCQl9KQoJCQkuYmx1ciggZnVuY3Rpb24oKSB7CgkJCQlzZWxmLnJlZnJlc2goIHZhbCgpLCB0cnVlICk7CgkJCX0pOwoKCQkvLyBwcmV2ZW50IHNjcmVlbiBkcmFnIHdoZW4gc2xpZGVyIGFjdGl2YXRlZAoJCSQoIGRvY3VtZW50ICkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggc2VsZi5kcmFnZ2luZyApIHsKCQkJCS8vIHNlbGYubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJc2VsZi5tb3VzZU1vdmVkID0gdHJ1ZTsKCQkJCQoJCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIgKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgaW4gc3luYyB3aXRoIHRoZSBtb3VzZQoJCQkJCWhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQl9CgkJCQkKCQkJCXNlbGYucmVmcmVzaCggZXZlbnQgKTsKCQkJCQoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgc2VsZi51c2VyTW9kaWZpZWQKCQkJCXNlbGYudXNlck1vZGlmaWVkID0gc2VsZi5iZWZvcmVTdGFydCAhPT0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJc2VsZi5kcmFnZ2luZyA9IHRydWU7CgkJCXNlbGYudXNlck1vZGlmaWVkID0gZmFsc2U7CgkJCXNlbGYubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIgKSB7CgkJCQlzZWxmLmJlZm9yZVN0YXJ0ID0gY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCQoJCQlzZWxmLnJlZnJlc2goIGV2ZW50ICk7CgkJCXJldHVybiBmYWxzZTsKCQl9KTsKCgkJc2xpZGVyLmFkZCggZG9jdW1lbnQgKQoJCQkuYmluZCggInZtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuZHJhZ2dpbmcgKSB7CgoJCQkJCXNlbGYuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCQkJaWYgKCBjVHlwZSA9PT0gInNlbGVjdCIpIHsKCQkJCQkKCQkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCQkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQkJCgkJCQkJCWlmICggc2VsZi5tb3VzZU1vdmVkICkgewoJCQkJCQkKCQkJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCQkJaWYgKCBzZWxmLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgPT0gMCA/IDEgOiAwICk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIHsKCQkJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgKTsKCQkJCQkJCX0KCQkJCQkJCQoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJLy8gdGhpcyBpcyBqdXN0IGEgY2xpY2ssIGNoYW5nZSB0aGUgdmFsdWUKCQkJCQkJCXNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCA9PSAwID8gMSA6IDAgKTsKCQkJCQkJfQoJCQkJCQkKCQkJCQl9CgkJCQkJCgkJCQkJc2VsZi5tb3VzZU1vdmVkID0gZmFsc2U7CgkJCQkJCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCgkJdGhpcy5oYW5kbGUKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuZm9jdXMoKTsKCQkJfSkKCQkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLmhhbmRsZQoJCQkuYmluZCggImtleWRvd24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl2YXIgaW5kZXggPSB2YWwoKTsKCgkJCQlpZiAoIHNlbGYub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gSW4gYWxsIGNhc2VzIHByZXZlbnQgdGhlIGRlZmF1bHQgYW5kIG1hcmsgdGhlIGhhbmRsZSBhcyBhY3RpdmUKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJIGNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkJaWYgKCAhc2VsZi5fa2V5U2xpZGluZyApIHsKCQkJCQkJc2VsZi5fa2V5U2xpZGluZyA9IHRydWU7CgkJCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCQl9CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJLy8gbW92ZSB0aGUgc2xpZGVyIGFjY29yZGluZyB0byB0aGUga2V5cHJlc3MKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQkJc2VsZi5yZWZyZXNoKCBtaW4gKTsKCQkJCQlicmVhazsKCQkJCSBjYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJCXNlbGYucmVmcmVzaCggbWF4ICk7CgkJCQkJYnJlYWs7CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQkJIGNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCQlzZWxmLnJlZnJlc2goIGluZGV4ICsgc3RlcCApOwoJCQkJCWJyZWFrOwoJCQkJIGNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCQkgY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQkJc2VsZi5yZWZyZXNoKCBpbmRleCAtIHN0ZXAgKTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfSkgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgkJCS5rZXl1cCggZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBzZWxmLl9rZXlTbGlkaW5nICkgewoJCQkJCXNlbGYuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLnJlZnJlc2godW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggdmFsLCBpc2Zyb21Db250cm9sLCBwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZWxlbWVudC5hdHRyKCdkaXNhYmxlZCcpKSB7IAoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCXZhciBjb250cm9sID0gdGhpcy5lbGVtZW50LCBwZXJjZW50LAoJCQljVHlwZSA9IGNvbnRyb2xbMF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJbWluID0gY1R5cGUgPT09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkubGVuZ3RoIC0gMTsKCgkJaWYgKCB0eXBlb2YgdmFsID09PSAib2JqZWN0IiApIHsKCQkJdmFyIGRhdGEgPSB2YWwsCgkJCQkvLyBhIHNsaWdodCB0b2xlcmFuY2UgaGVscGVkIGdldCB0byB0aGUgZW5kcyBvZiB0aGUgc2xpZGVyCgkJCQl0b2wgPSA4OwoJCQlpZiAoICF0aGlzLmRyYWdnaW5nIHx8CgkJCQkJZGF0YS5wYWdlWCA8IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgLSB0b2wgfHwKCQkJCQlkYXRhLnBhZ2VYID4gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdCArIHRoaXMuc2xpZGVyLndpZHRoKCkgKyB0b2wgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJcGVyY2VudCA9IE1hdGgucm91bmQoICggKCBkYXRhLnBhZ2VYIC0gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdCApIC8gdGhpcy5zbGlkZXIud2lkdGgoKSApICogMTAwICk7CgkJfSBlbHNlIHsKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCXZhciBuZXd2YWwgPSBNYXRoLnJvdW5kKCAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKSArIG1pbjsKCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQkvLyBGbGlwIHRoZSBzdGFjayBvZiB0aGUgYmcgY29sb3JzCgkJaWYgKCBwZXJjZW50ID4gNjAgJiYgY1R5cGUgPT09ICJzZWxlY3QiICkgewoJCQkvLyBUT0RPOiBEZWFkIHBhdGg/CgkJfQoJCXRoaXMuaGFuZGxlLmNzcyggImxlZnQiLCBwZXJjZW50ICsgIiUiICk7CgkJdGhpcy5oYW5kbGUuYXR0ciggewoJCQkJImFyaWEtdmFsdWVub3ciOiBjVHlwZSA9PT0gImlucHV0IiA/IG5ld3ZhbCA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5lcSggbmV3dmFsICkuYXR0ciggInZhbHVlIiApLAoJCQkJImFyaWEtdmFsdWV0ZXh0IjogY1R5cGUgPT09ICJpbnB1dCIgPyBuZXd2YWwgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCksCgkJCQl0aXRsZTogbmV3dmFsCgkJCX0pOwoKCQkvLyBhZGQvcmVtb3ZlIGNsYXNzZXMgZm9yIGZsaXAgdG9nZ2xlIHN3aXRjaAoJCWlmICggY1R5cGUgPT09ICJzZWxlY3QiICkgewoJCQlpZiAoIG5ld3ZhbCA9PT0gMCApIHsKCQkJCXRoaXMuc2xpZGVyLmFkZENsYXNzKCAidWktc2xpZGVyLXN3aXRjaC1hIiApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLXN3aXRjaC1iIiApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5zbGlkZXIuYWRkQ2xhc3MoICJ1aS1zbGlkZXItc3dpdGNoLWIiICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zbGlkZXItc3dpdGNoLWEiICk7CgkJCX0KCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFyIHZhbHVlQ2hhbmdlZCA9IGZhbHNlOwoKCQkJLy8gdXBkYXRlIGNvbnRyb2wicyB2YWx1ZQoJCQlpZiAoIGNUeXBlID09PSAiaW5wdXQiICkgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbC52YWwoKSAhPT0gbmV3dmFsOwoJCQkJY29udHJvbC52YWwoIG5ld3ZhbCApOwoJCQl9IGVsc2UgewoJCQkJdmFsdWVDaGFuZ2VkID0gY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ID0gbmV3dmFsOwoJCQl9CgkJCWlmICggIWlzZnJvbUNvbnRyb2wgJiYgdmFsdWVDaGFuZ2VkICkgewoJCQkJY29udHJvbC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCXRoaXMuc2xpZGVyLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBmYWxzZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJdGhpcy5zbGlkZXIuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9Cgp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkLm1vYmlsZS5zbGlkZXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwovKgoqICJ0ZXh0aW5wdXQiIHBsdWdpbiBmb3IgdGV4dCBpbnB1dHMsIHRleHRhcmVhcwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSd0ZXh0J10sIGlucHV0W3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSwgaW5wdXRbdHlwZT0nbnVtYmVyJ10sIDpqcW1EYXRhKHR5cGU9J251bWJlcicpLCBpbnB1dFt0eXBlPSdwYXNzd29yZCddLCBpbnB1dFt0eXBlPSdlbWFpbCddLCBpbnB1dFt0eXBlPSd1cmwnXSwgaW5wdXRbdHlwZT0ndGVsJ10sIHRleHRhcmVhLCBpbnB1dFt0eXBlPSd0aW1lJ10sIGlucHV0W3R5cGU9J2RhdGUnXSwgaW5wdXRbdHlwZT0nbW9udGgnXSwgaW5wdXRbdHlwZT0nd2VlayddLCBpbnB1dFt0eXBlPSdkYXRldGltZSddLCBpbnB1dFt0eXBlPSdkYXRldGltZS1sb2NhbCddLCBpbnB1dFt0eXBlPSdjb2xvciddLCBpbnB1dDpub3QoW3R5cGVdKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdGhlbWUgPSBvLnRoZW1lIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApLAoJCQl0aGVtZWNsYXNzICA9ICIgdWktYm9keS0iICsgdGhlbWUsCgkJCWZvY3VzZWRFbCwgY2xlYXJidG47CgoJCSQoICJsYWJlbFtmb3I9JyIgKyBpbnB1dC5hdHRyKCAiaWQiICkgKyAiJ10iICkuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IiApOwoKCQlmb2N1c2VkRWwgPSBpbnB1dC5hZGRDbGFzcygidWktaW5wdXQtdGV4dCB1aS1ib2R5LSIrIHRoZW1lICk7CgoJCS8vIFhYWDogVGVtcG9yYXJ5IHdvcmthcm91bmQgZm9yIGlzc3VlIDc4NSAoQXBwbGUgYnVnIDg5MTA1ODkpLgoJCS8vICAgICAgVHVybiBvZmYgYXV0b2NvcnJlY3QgYW5kIGF1dG9jb21wbGV0ZSBvbiBub24taU9TIDUgZGV2aWNlcwoJCS8vICAgICAgc2luY2UgdGhlIHBvcHVwIHRoZXkgdXNlIGNhbid0IGJlIGRpc21pc3NlZCBieSB0aGUgdXNlci4gTm90ZQoJCS8vICAgICAgdGhhdCB3ZSB0ZXN0IGZvciB0aGUgcHJlc2VuY2Ugb2YgdGhlIGZlYXR1cmUgYnkgbG9va2luZyBmb3IKCQkvLyAgICAgIHRoZSBhdXRvY29ycmVjdCBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC4gV2UgY3VycmVudGx5CgkJLy8gICAgICBoYXZlIG5vIHRlc3QgZm9yIGlPUyA1IG9yIG5ld2VyIHNvIHdlJ3JlIHRlbXBvcmFyaWx5IHVzaW5nCgkJLy8gICAgICB0aGUgdG91Y2hPdmVyZmxvdyBzdXBwb3J0IGZsYWcgZm9yIGpRTSAxLjAuIFllcywgSSBmZWVsIGRpcnR5LiAtIGpibGFzCgkJaWYgKCB0eXBlb2YgaW5wdXRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmICEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb3JyZWN0IiwgIm9mZiIgKTsKCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCQl9CgoKCQkvLyJzZWFyY2giIGlucHV0IHdpZGdldAoJCWlmICggaW5wdXQuaXMoICJbdHlwZT0nc2VhcmNoJ10sOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgKSB7CgoJCQlmb2N1c2VkRWwgPSBpbnB1dC53cmFwKCAiPGRpdiBjbGFzcz0ndWktaW5wdXQtc2VhcmNoIHVpLXNoYWRvdy1pbnNldCB1aS1idG4tY29ybmVyLWFsbCB1aS1idG4tc2hhZG93IHVpLWljb24tc2VhcmNoZmllbGQiICsgdGhlbWVjbGFzcyArICInPjwvZGl2PiIgKS5wYXJlbnQoKTsKCQkJY2xlYXJidG4gPSAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyJyB0aXRsZT0nY2xlYXIgdGV4dCc+Y2xlYXIgdGV4dDwvYT4iICkKCQkJCS50YXAoZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlucHV0LnZhbCggIiIgKS5mb2N1cygpOwoJCQkJCWlucHV0LnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJY2xlYXJidG4uYWRkQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0pCgkJCQkuYXBwZW5kVG8oIGZvY3VzZWRFbCApCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlpY29uOiAiZGVsZXRlIiwKCQkJCQlpY29ucG9zOiAibm90ZXh0IiwKCQkJCQljb3JuZXJzOiB0cnVlLAoJCQkJCXNoYWRvdzogdHJ1ZQoJCQkJfSk7CgoJCQlmdW5jdGlvbiB0b2dnbGVDbGVhcigpIHsKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJY2xlYXJidG4udG9nZ2xlQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iLCAhaW5wdXQudmFsKCkgKTsKCQkJCX0sIDApOwoJCQl9CgoJCQl0b2dnbGVDbGVhcigpOwoKCQkJaW5wdXQuYmluZCgncGFzdGUgY3V0IGtleXVwIGZvY3VzIGNoYW5nZSBibHVyJywgdG9nZ2xlQ2xlYXIpOwoKCQl9IGVsc2UgewoJCQlpbnB1dC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktc2hhZG93LWluc2V0IiArIHRoZW1lY2xhc3MgKTsKCQl9CgoJCWlucHV0LmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJZm9jdXNlZEVsLmFkZENsYXNzKCAidWktZm9jdXMiICk7CgkJCX0pCgkJCS5ibHVyKGZ1bmN0aW9uKCl7CgkJCQlmb2N1c2VkRWwucmVtb3ZlQ2xhc3MoICJ1aS1mb2N1cyIgKTsKCQkJfSk7CgoJCS8vIEF1dG9ncm93CgkJaWYgKCBpbnB1dC5pcyggInRleHRhcmVhIiApICkgewoJCQl2YXIgZXh0cmFMaW5lSGVpZ2h0ID0gMTUsCgkJCQlrZXl1cFRpbWVvdXRCdWZmZXIgPSAxMDAsCgkJCQlrZXl1cCA9IGZ1bmN0aW9uKCkgewoJCQkJCXZhciBzY3JvbGxIZWlnaHQgPSBpbnB1dFsgMCBdLnNjcm9sbEhlaWdodCwKCQkJCQkJY2xpZW50SGVpZ2h0ID0gaW5wdXRbIDAgXS5jbGllbnRIZWlnaHQ7CgoJCQkJCWlmICggY2xpZW50SGVpZ2h0IDwgc2Nyb2xsSGVpZ2h0ICkgewoJCQkJCQlpbnB1dC5oZWlnaHQoc2Nyb2xsSGVpZ2h0ICsgZXh0cmFMaW5lSGVpZ2h0KTsKCQkJCQl9CgkJCQl9LAoJCQkJa2V5dXBUaW1lb3V0OwoKCQkJaW5wdXQua2V5dXAoZnVuY3Rpb24oKSB7CgkJCQljbGVhclRpbWVvdXQoIGtleXVwVGltZW91dCApOwoJCQkJa2V5dXBUaW1lb3V0ID0gc2V0VGltZW91dCgga2V5dXAsIGtleXVwVGltZW91dEJ1ZmZlciApOwoJCQl9KTsKCgkJCS8vIElzc3VlIDUwOTogdGhlIGJyb3dzZXIgaXMgbm90IHByb3ZpZGluZyBzY3JvbGxIZWlnaHQgcHJvcGVybHkgdW50aWwgdGhlIHN0eWxlcyBsb2FkCgkJCWlmICggJC50cmltKCBpbnB1dC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCSQoIHdpbmRvdyApLmxvYWQoIGtleXVwICk7CgoJCQkJLy8gYmluZGluZyB0byBwYWdlY2hhbmdlIGhlcmUgZW5zdXJlcyB0aGF0IGZvciBwYWdlcyBsb2FkZWQgdmlhCgkJCQkvLyBhamF4IHRoZSBoZWlnaHQgaXMgcmVjYWxjdWxhdGVkIHdpdGhvdXQgdXNlciBpbnB1dAoJCQkJJCggZG9jdW1lbnQgKS5vbmUoICJwYWdlY2hhbmdlIiwga2V5dXAgKTsKCQkJfQoJCX0KCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKXsKCQkoIHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICkuaXMoICJbdHlwZT0nc2VhcmNoJ10sOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgPwoJCQl0aGlzLmVsZW1lbnQucGFyZW50KCkgOiB0aGlzLmVsZW1lbnQgKS5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCl7CgkJKCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UpLmlzKCAiW3R5cGU9J3NlYXJjaCddLDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApID8KCQkJdGhpcy5lbGVtZW50LnBhcmVudCgpIDogdGhpcy5lbGVtZW50ICkucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUudGV4dGlucHV0LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgl2YXIgZXh0ZW5kU2VsZWN0ID0gZnVuY3Rpb24oIHdpZGdldCApewoKCQl2YXIgc2VsZWN0ID0gd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQgID0gd2lkZ2V0LnNlbGVjdElELAoJCQlsYWJlbCA9IHdpZGdldC5sYWJlbCwKCQkJdGhpc1BhZ2UgPSB3aWRnZXQuc2VsZWN0LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJc2NyZWVuID0gJCggIjxkaXY+IiwgeyJjbGFzcyI6ICJ1aS1zZWxlY3RtZW51LXNjcmVlbiB1aS1zY3JlZW4taGlkZGVuIn0gKS5hcHBlbmRUbyggdGhpc1BhZ2UgKSwKCQkJc2VsZWN0T3B0aW9ucyA9IHdpZGdldC5fc2VsZWN0T3B0aW9ucygpLAoJCQlpc011bHRpcGxlID0gd2lkZ2V0LmlzTXVsdGlwbGUgPSB3aWRnZXQuc2VsZWN0WyAwIF0ubXVsdGlwbGUsCgkJCWJ1dHRvbklkID0gc2VsZWN0SUQgKyAiLWJ1dHRvbiIsCgkJCW1lbnVJZCA9IHNlbGVjdElEICsgIi1tZW51IiwKCQkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGRhdGEtIiArJC5tb2JpbGUubnMgKyAidGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLnRoZW1lICsiJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgIm92ZXJsYXktdGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArIic+IiArCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgbGFiZWwuZ2V0RW5jb2RlZFRleHQoKSArICI8L2Rpdj4iKwoJCQkJIjwvZGl2PiIrCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkJIjwvZGl2PiIgKS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApLnBhZ2UoKSwKCgkJCWxpc3Rib3ggPSAgJCgiPGRpdj4iLCB7ICJjbGFzcyI6ICJ1aS1zZWxlY3RtZW51IHVpLXNlbGVjdG1lbnUtaGlkZGVuIHVpLW92ZXJsYXktc2hhZG93IHVpLWNvcm5lci1hbGwgdWktYm9keS0iICsgd2lkZ2V0Lm9wdGlvbnMub3ZlcmxheVRoZW1lICsgIiAiICsgJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gfSApLmluc2VydEFmdGVyKHNjcmVlbiksCgoJCQlsaXN0ID0gJCggIjx1bD4iLCB7CgkJCQkiY2xhc3MiOiAidWktc2VsZWN0bWVudS1saXN0IiwKCQkJCSJpZCI6IG1lbnVJZCwKCQkJCSJyb2xlIjogImxpc3Rib3giLAoJCQkJImFyaWEtbGFiZWxsZWRieSI6IGJ1dHRvbklkCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIsIHdpZGdldC5vcHRpb25zLnRoZW1lICkuYXBwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlciA9ICQoICI8ZGl2PiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS1oZWFkZXIgdWktYmFyLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZQoJCQl9KS5wcmVwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlclRpdGxlID0gJCggIjxoMT4iLCB7CgkJCQkiY2xhc3MiOiAidWktdGl0bGUiCgkJCX0pLmFwcGVuZFRvKCBoZWFkZXIgKSwKCgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJ0ZXh0Ijogd2lkZ2V0Lm9wdGlvbnMuY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuLWxlZnQiCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiwgIm5vdGV4dCIgKS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbiIsICJkZWxldGUiICkuYXBwZW5kVG8oIGhlYWRlciApLmJ1dHRvbk1hcmt1cCgpLAoKCQkJbWVudVBhZ2VDb250ZW50ID0gbWVudVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApLAoKCQkJbWVudVBhZ2VDbG9zZSA9IG1lbnVQYWdlLmZpbmQoICIudWktaGVhZGVyIGEiICk7CgoKCQkkLmV4dGVuZCggd2lkZ2V0LCB7CgkJCXNlbGVjdDogd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQ6IHNlbGVjdElELAoJCQlidXR0b25JZDogYnV0dG9uSWQsCgkJCW1lbnVJZDogbWVudUlkLAoJCQl0aGlzUGFnZTogdGhpc1BhZ2UsCgkJCW1lbnVQYWdlOiBtZW51UGFnZSwKCQkJbGFiZWw6IGxhYmVsLAoJCQlzY3JlZW46IHNjcmVlbiwKCQkJc2VsZWN0T3B0aW9uczogc2VsZWN0T3B0aW9ucywKCQkJaXNNdWx0aXBsZTogaXNNdWx0aXBsZSwKCQkJdGhlbWU6IHdpZGdldC5vcHRpb25zLnRoZW1lLAoJCQlsaXN0Ym94OiBsaXN0Ym94LAoJCQlsaXN0OiBsaXN0LAoJCQloZWFkZXI6IGhlYWRlciwKCQkJaGVhZGVyVGl0bGU6IGhlYWRlclRpdGxlLAoJCQloZWFkZXJDbG9zZTogaGVhZGVyQ2xvc2UsCgkJCW1lbnVQYWdlQ29udGVudDogbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlOiBtZW51UGFnZUNsb3NlLAoJCQlwbGFjZWhvbGRlcjogIiIsCgoJCQlidWlsZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJLy8gQ3JlYXRlIGxpc3QgZnJvbSBzZWxlY3QsIHVwZGF0ZSBzdGF0ZQoJCQkJc2VsZi5yZWZyZXNoKCk7CgoJCQkJc2VsZi5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgIi0xIiApLmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQkJCX0pOwoKCQkJCS8vIEJ1dHRvbiBldmVudHMKCQkJCXNlbGYuYnV0dG9uLmJpbmQoICJ2Y2xpY2sga2V5ZG93biIgLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBldmVudC50eXBlID09ICJ2Y2xpY2siIHx8CgkJCQkJCQkgZXZlbnQua2V5Q29kZSAmJiAoIGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRU5URVIgfHwKCQkJCQkJCQkJCQkJCQkJCQlldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFICkgKSB7CgoJCQkJCQlzZWxmLm9wZW4oKTsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgZm9yIGxpc3QgaXRlbXMKCQkJCXNlbGYubGlzdC5hdHRyKCAicm9sZSIsICJsaXN0Ym94IiApCgkJCQkJLmRlbGVnYXRlKCAiLnVpLWxpPmEiLCAiZm9jdXNpbiIsIGZ1bmN0aW9uKCkgewoJCQkJCQkkKCB0aGlzICkuYXR0ciggInRhYmluZGV4IiwgIjAiICk7CgkJCQkJfSkKCQkJCQkuZGVsZWdhdGUoICIudWktbGk+YSIsICJmb2N1c291dCIsIGZ1bmN0aW9uKCkgewoJCQkJCQkkKCB0aGlzICkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoJCQkJCX0pCgkJCQkJLmRlbGVnYXRlKCAibGk6bm90KC51aS1kaXNhYmxlZCwgLnVpLWxpLWRpdmlkZXIpIiwgImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJCQl2YXIgb2xkSW5kZXggPSBzZWxmLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgkJCQkJCQluZXdJbmRleCA9IHNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5pbmRleCggdGhpcyApLAoJCQkJCQkJb3B0aW9uID0gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmVxKCBuZXdJbmRleCApWyAwIF07CgoJCQkJCQkvLyB0b2dnbGUgc2VsZWN0ZWQgc3RhdHVzIG9uIHRoZSB0YWcgZm9yIG11bHRpIHNlbGVjdHMKCQkJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJCQkvLyB0b2dnbGUgY2hlY2tib3ggY2xhc3MgZm9yIG11bHRpcGxlIHNlbGVjdHMKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkkKCB0aGlzICkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiLCAhb3B0aW9uLnNlbGVjdGVkICk7CgkJCQkJCX0KCgkJCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgfHwgb2xkSW5kZXggIT09IG5ld0luZGV4ICkgewoJCQkJCQkJc2VsZi5zZWxlY3QudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCQkJfQoKCQkJCQkJLy9oaWRlIGN1c3RvbSBzZWxlY3QgZm9yIHNpbmdsZSBzZWxlY3RzIG9ubHkKCQkJCQkJaWYgKCAhc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQl9CgoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0pCgkJCQkJLmtleWRvd24oZnVuY3Rpb24oIGV2ZW50ICkgeyAgLy9rZXlib2FyZCBldmVudHMgZm9yIG1lbnUgaXRlbXMKCQkJCQkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQkJCQkJbGkgPSB0YXJnZXQuY2xvc2VzdCggImxpIiApLAoJCQkJCQkJcHJldiwgbmV4dDsKCgkJCQkJCS8vIHN3aXRjaCBsb2dpYyBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQkJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCQkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCQkJCQkgY2FzZSAzODoKCQkJCQkJCXByZXYgPSBsaS5wcmV2KCk7CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIHByZXZpb3VzIG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggcHJldi5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJcHJldi5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQkJLy8gZG93biBvciByaWdodCBhcnJvdyBrZXlzCgkJCQkJCSBjYXNlIDQwOgoJCQkJCQkJbmV4dCA9IGxpLm5leHQoKTsKCgkJCQkJCQkvLyBpZiB0aGVyZSdzIGEgbmV4dCBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIG5leHQubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCW5leHQuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCWJyZWFrOwoKCQkJCQkJCS8vIElmIGVudGVyIG9yIHNwYWNlIGlzIHByZXNzZWQsIHRyaWdnZXIgY2xpY2sKCQkJCQkJIGNhc2UgMTM6CgkJCQkJCSBjYXNlIDMyOgoJCQkJCQkJdGFyZ2V0LnRyaWdnZXIoICJjbGljayIgKTsKCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoJCQkJCX0pOwoKCQkJCS8vIGJ1dHRvbiByZWZvY3VzIGVuc3VyZXMgcHJvcGVyIGhlaWdodCBjYWxjdWxhdGlvbgoJCQkJLy8gYnkgcmVtb3ZpbmcgdGhlIGlubGluZSBzdHlsZSBhbmQgZW5zdXJpbmcgcGFnZSBpbmNsdXNpb24KCQkJCXNlbGYubWVudVBhZ2UuYmluZCggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5saXN0LmFwcGVuZFRvKCBzZWxmLmxpc3Rib3ggKTsKCQkJCQlzZWxmLl9mb2N1c0J1dHRvbigpOwoKCQkJCQkvLyBUT0RPIGNlbnRyYWxpemUgcGFnZSByZW1vdmFsIGJpbmRpbmcgLyBoYW5kbGluZyBpbiB0aGUgcGFnZSBwbHVnaW4uCgkJCQkJLy8gU3VnZ2VzdGlvbiBmcm9tIEBqYmxhcyB0byBkbyByZWZjb3VudGluZwoJCQkJCS8vCgkJCQkJLy8gVE9ETyBleHRyZW1lbHkgY29uZnVzaW5nIGRlcGVuZGVuY3kgb24gdGhlIG9wZW4gbWV0aG9kIHdoZXJlIHRoZSBwYWdlaGlkZS5yZW1vdmUKCQkJCQkvLyBiaW5kaW5ncyBhcmUgc3RyaXBwZWQgdG8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBkaXNhcHBlYXJpbmcuIFRoZSB3YXkKCQkJCQkvLyB3ZSdyZSBrZWVwaW5nIHBhZ2VzIGluIHRoZSBET00gcmlnaHQgbm93IHN1Y2tzCgkJCQkJLy8KCQkJCQkvLyByZWJpbmQgdGhlIHBhZ2UgcmVtb3ZlIHRoYXQgd2FzIHVuYm91bmQgaW4gdGhlIG9wZW4gZnVuY3Rpb24KCQkJCQkvLyB0byBhbGxvdyBmb3IgdGhlIHBhcmVudCBwYWdlIHJlbW92YWwgZnJvbSBhY3Rpb25zIG90aGVyIHRoYW4gdGhlIHVzZQoJCQkJCS8vIG9mIGEgZGlhbG9nIHNpemVkIGN1c3RvbSBzZWxlY3QKCQkJCQkvLwoJCQkJCS8vIGRvaW5nIHRoaXMgaGVyZSBwcm92aWRlcyBmb3IgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBjdXN0b20gc2VsZWN0IGRpYWxvZwoJCQkJCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZS5jYWxsKCBzZWxmLnRoaXNQYWdlICk7CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgb24gInNjcmVlbiIgb3ZlcmxheQoJCQkJc2VsZi5zY3JlZW4uYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCgkJCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQkJCXNlbGYuaGVhZGVyQ2xvc2UuY2xpY2soIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0pOwoKCQkJCS8vIHRyYWNrIHRoaXMgZGVwZW5kZW5jeSBzbyB0aGF0IHdoZW4gdGhlIHBhcmVudCBwYWdlCgkJCQkvLyBpcyByZW1vdmVkIG9uIHBhZ2VoaWRlIGl0IHdpbGwgYWxzbyByZW1vdmUgdGhlIG1lbnVwYWdlCgkJCQlzZWxmLnRoaXNQYWdlLmFkZERlcGVuZGVudHMoIHRoaXMubWVudVBhZ2UgKTsKCQkJfSwKCgkJCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgbGlzdCA9IHRoaXMubGlzdC5maW5kKCAibGkiICksCgkJCQkJb3B0aW9ucyA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKTsKCgkJCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCQkJLy8gaWdub3JlcyB2YWx1ZSBjaGFuZ2VzIGV0YyBpbiBmYXZvciBvZiBhIGZvcmNlZFJlYnVpbGQKCQkJCS8vIGZyb20gdGhlIHVzZXIgaW4gdGhlIHJlZnJlc2ggbWV0aG9kCgkJCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJCQl9LAoKCQkJcmVmcmVzaDogZnVuY3Rpb24oIGZvcmNlUmVidWlsZCAsIGZvbyApewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJc2VsZWN0ID0gdGhpcy5lbGVtZW50LAoJCQkJaXNNdWx0aXBsZSA9IHRoaXMuaXNNdWx0aXBsZSwKCQkJCW9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCksCgkJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJCS8vIHJldHVybiBhbiBhcnJheSBvZiBhbGwgc2VsZWN0ZWQgaW5kZXgncwoJCQkJaW5kaWNpZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQkJCWlmICggIGZvcmNlUmVidWlsZCB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQkJCXNlbGYuX2J1aWxkTGlzdCgpOwoJCQkJfQoKCQkJCXNlbGYuc2V0QnV0dG9uVGV4dCgpOwoJCQkJc2VsZi5zZXRCdXR0b25Db3VudCgpOwoKCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKQoJCQkJCS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIGZhbHNlICkKCQkJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQkJCWlmICggJC5pbkFycmF5KCBpLCBpbmRpY2llcyApID4gLTEgKSB7CgkJCQkJCQl2YXIgaXRlbSA9ICQoIHRoaXMgKTsKCgkJCQkJCQkvLyBBcmlhIHNlbGVjdGVkIGF0dHIKCQkJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCQkJLy8gTXVsdGlwbGUgc2VsZWN0czogYWRkIHRoZSAib24iIGNoZWNrYm94IHN0YXRlIHRvIHRoZSBpY29uCgkJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCQlpdGVtLmZpbmQoICIudWktaWNvbiIgKS5yZW1vdmVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiApLmFkZENsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaXRlbS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQl9LAoKCQkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgIXRoaXMuaXNPcGVuICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09ICJwYWdlIiApIHsKCQkJCQkvLyBkb2Vzbid0IHNvbHZlIHRoZSBwb3NzaWJsZSBpc3N1ZSB3aXRoIGNhbGxpbmcgY2hhbmdlIHBhZ2UKCQkJCQkvLyB3aGVyZSB0aGUgb2JqZWN0cyBkb24ndCBkZWZpbmUgZGF0YSB1cmxzIHdoaWNoIHByZXZlbnRzIGRpYWxvZyBrZXkKCQkJCQkvLyBzdHJpcHBpbmcgLSBjaGFuZ2VQYWdlIGhhcyBpbmNvbWluZyByZWZhY3RvcgoJCQkJCXdpbmRvdy5oaXN0b3J5LmJhY2soKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5zY3JlZW4uYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJCXNlbGYubGlzdGJveC5hZGRDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApLnJlbW92ZUF0dHIoICJzdHlsZSIgKS5yZW1vdmVDbGFzcyggImluIiApOwoJCQkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkJCX0KCgkJCQkvLyBhbGxvdyB0aGUgZGlhbG9nIHRvIGJlIGNsb3NlZCBhZ2FpbgoJCQkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCQkJfSwKCgkJCW9wZW46IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQltZW51SGVpZ2h0ID0gc2VsZi5saXN0LnBhcmVudCgpLm91dGVySGVpZ2h0KCksCgkJCQkJbWVudVdpZHRoID0gc2VsZi5saXN0LnBhcmVudCgpLm91dGVyV2lkdGgoKSwKCQkJCQlhY3RpdmVQYWdlID0gJCggIi51aS1wYWdlLWFjdGl2ZSIgKSwKCQkJCQl0T3ZlcmZsb3cgPSAkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyAmJiAkLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZCwKCQkJCQl0U2Nyb2xsRWxlbSA9IGFjdGl2ZVBhZ2UuaXMoICIudWktbmF0aXZlLWZpeGVkIiApID8gYWN0aXZlUGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICkgOiBhY3RpdmVQYWdlOwoJCQkJCXNjcm9sbFRvcCA9IHRPdmVyZmxvdyA/IHRTY3JvbGxFbGVtLnNjcm9sbFRvcCgpIDogJCggd2luZG93ICkuc2Nyb2xsVG9wKCksCgkJCQkJYnRuT2Zmc2V0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkudG9wLAoJCQkJCXNjcmVlbkhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCwKCQkJCQlzY3JlZW5XaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoOwoKCQkJCS8vYWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCS8vcmVtb3ZlIGFmdGVyIGRlbGF5CgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0sIDMwMCk7CgoJCQkJZnVuY3Rpb24gZm9jdXNNZW51SXRlbSgpIHsKCQkJCQlzZWxmLmxpc3QuZmluZCggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5mb2N1cygpOwoJCQkJfQoKCQkJCWlmICggbWVudUhlaWdodCA+IHNjcmVlbkhlaWdodCAtIDgwIHx8ICEkLnN1cHBvcnQuc2Nyb2xsVG9wICkgewoJCQkJCS8vIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSBET00sCgkJCQkJLy8gb3RoZXJ3aXNlIHRoZSByZXN1bHRzIG9mIHNlbGVjdGluZyBhIGxpc3QgaXRlbSBpbiB0aGUgZGlhbG9nCgkJCQkJLy8gZmFsbCBpbnRvIGEgYmxhY2sgaG9sZQoJCQkJCXNlbGYudGhpc1BhZ2UudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApOwoKCQkJCQkvL2ZvciBXZWJPUy9PcGVyYSBNaW5pIChzZXQgbGFzdHNjcm9sbCB1c2luZyBidXR0b24gb2Zmc2V0KQoJCQkJCWlmICggc2Nyb2xsVG9wID09IDAgJiYgYnRuT2Zmc2V0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJCQlzZWxmLnRoaXNQYWdlLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJCQkkKCB0aGlzICkuanFtRGF0YSggImxhc3RTY3JvbGwiLCBidG5PZmZzZXQgKTsKCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQlzZWxmLm1lbnVQYWdlLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCS8vIHNpbGVudFNjcm9sbCgpIGlzIGNhbGxlZCB3aGVuZXZlciBhIHBhZ2UgaXMgc2hvd24gdG8gcmVzdG9yZQoJCQkJCQkvLyBhbnkgcHJldmlvdXMgc2Nyb2xsIHBvc2l0aW9uIHRoZSBwYWdlIG1heSBoYXZlIGhhZC4gV2UgbmVlZCB0bwoJCQkJCQkvLyB3YWl0IGZvciB0aGUgInNpbGVudHNjcm9sbCIgZXZlbnQgYmVmb3JlIHNldHRpbmcgZm9jdXMgdG8gYXZvaWQKCQkJCQkJLy8gdGhlIGJyb3dzZXIicyAiZmVhdHVyZSIgd2hpY2ggb2Zmc2V0cyByZW5kZXJpbmcgdG8gbWFrZSBzdXJlCgkJCQkJCS8vIHdoYXRldmVyIGhhcyBmb2N1cyBpcyBpbiB2aWV3LgoJCQkJCQkkKCB3aW5kb3cgKS5vbmUoICJzaWxlbnRzY3JvbGwiLCBmdW5jdGlvbigpIHsKCQkJCQkJCWZvY3VzTWVudUl0ZW0oKTsKCQkJCQkJfSk7CgoJCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQkJfSk7CgoJCQkJCXNlbGYubWVudVR5cGUgPSAicGFnZSI7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQuYXBwZW5kKCBzZWxmLmxpc3QgKTsKCQkJCQlzZWxmLm1lbnVQYWdlLmZpbmQoImRpdiAudWktdGl0bGUiKS50ZXh0KHNlbGYubGFiZWwudGV4dCgpKTsKCQkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCBzZWxmLm1lbnVQYWdlLCB7CgkJCQkJCXRyYW5zaXRpb246ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uCgkJCQkJfSk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubWVudVR5cGUgPSAib3ZlcmxheSI7CgoJCQkJCXNlbGYuc2NyZWVuLmhlaWdodCggJChkb2N1bWVudCkuaGVpZ2h0KCkgKQoJCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoKCQkJCQkvLyBUcnkgYW5kIGNlbnRlciB0aGUgb3ZlcmxheSBvdmVyIHRoZSBidXR0b24KCQkJCQl2YXIgcm9vbXRvcCA9IGJ0bk9mZnNldCAtIHNjcm9sbFRvcCwKCQkJCQkJcm9vbWJvdCA9IHNjcm9sbFRvcCArIHNjcmVlbkhlaWdodCAtIGJ0bk9mZnNldCwKCQkJCQkJaGFsZmhlaWdodCA9IG1lbnVIZWlnaHQgLyAyLAoJCQkJCQltYXh3aWR0aCA9IHBhcnNlRmxvYXQoIHNlbGYubGlzdC5wYXJlbnQoKS5jc3MoICJtYXgtd2lkdGgiICkgKSwKCQkJCQkJbmV3dG9wLCBuZXdsZWZ0OwoKCQkJCQlpZiAoIHJvb210b3AgPiBtZW51SGVpZ2h0IC8gMiAmJiByb29tYm90ID4gbWVudUhlaWdodCAvIDIgKSB7CgkJCQkJCW5ld3RvcCA9IGJ0bk9mZnNldCArICggc2VsZi5idXR0b24ub3V0ZXJIZWlnaHQoKSAvIDIgKSAtIGhhbGZoZWlnaHQ7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gMzBweCB0b2xlcmFuY2Ugb2ZmIHRoZSBlZGdlcwoJCQkJCQluZXd0b3AgPSByb29tdG9wID4gcm9vbWJvdCA/IHNjcm9sbFRvcCArIHNjcmVlbkhlaWdodCAtIG1lbnVIZWlnaHQgLSAzMCA6IHNjcm9sbFRvcCArIDMwOwoJCQkJCX0KCgkJCQkJLy8gSWYgdGhlIG1lbnV3aWR0aCBpcyBzbWFsbGVyIHRoYW4gdGhlIHNjcmVlbiBjZW50ZXIgaXMKCQkJCQlpZiAoIG1lbnVXaWR0aCA8IG1heHdpZHRoICkgewoJCQkJCQluZXdsZWZ0ID0gKCBzY3JlZW5XaWR0aCAtIG1lbnVXaWR0aCApIC8gMjsKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy9vdGhlcndpc2UgaW5zdXJlIGEgPj0gMzBweCBvZmZzZXQgZnJvbSB0aGUgbGVmdAoJCQkJCQluZXdsZWZ0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkubGVmdCArIHNlbGYuYnV0dG9uLm91dGVyV2lkdGgoKSAvIDIgLSBtZW51V2lkdGggLyAyOwoKCQkJCQkJLy8gMzBweCB0b2xlcmFuY2Ugb2ZmIHRoZSBlZGdlcwoJCQkJCQlpZiAoIG5ld2xlZnQgPCAzMCApIHsKCQkJCQkJCW5ld2xlZnQgPSAzMDsKCQkJCQkJfSBlbHNlIGlmICggKG5ld2xlZnQgKyBtZW51V2lkdGgpID4gc2NyZWVuV2lkdGggKSB7CgkJCQkJCQluZXdsZWZ0ID0gc2NyZWVuV2lkdGggLSBtZW51V2lkdGggLSAzMDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJc2VsZi5saXN0Ym94LmFwcGVuZCggc2VsZi5saXN0ICkKCQkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2VsZWN0bWVudS1oaWRkZW4iICkKCQkJCQkJLmNzcyh7CgkJCQkJCQl0b3A6IG5ld3RvcCwKCQkJCQkJCWxlZnQ6IG5ld2xlZnQKCQkJCQkJfSkKCQkJCQkJLmFkZENsYXNzKCAiaW4iICk7CgoJCQkJCWZvY3VzTWVudUl0ZW0oKTsKCgkJCQkJLy8gZHVwbGljYXRlIHdpdGggdmFsdWUgc2V0IGluIHBhZ2Ugc2hvdyBmb3IgZGlhbG9nIHNpemVkIHNlbGVjdHMKCQkJCQlzZWxmLmlzT3BlbiA9IHRydWU7CgkJCQl9CgkJCX0sCgoJCQlfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJCQlvcHRncm91cHMgPSBbXSwKCQkJCQlsaXMgPSBbXSwKCQkJCQlkYXRhSWNvbiA9IHNlbGYuaXNNdWx0aXBsZSA/ICJjaGVja2JveC1vZmYiIDogImZhbHNlIjsKCgkJCQlzZWxmLmxpc3QuZW1wdHkoKS5maWx0ZXIoICIudWktbGlzdHZpZXciICkubGlzdHZpZXcoICJkZXN0cm95IiApOwoKCQkJCS8vIFBvcHVsYXRlIG1lbnUgd2l0aCBvcHRpb25zIGZyb20gc2VsZWN0IGVsZW1lbnQKCQkJCXNlbGYuc2VsZWN0LmZpbmQoICJvcHRpb24iICkuZWFjaCggZnVuY3Rpb24oIGkgKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCQkkcGFyZW50ID0gJHRoaXMucGFyZW50KCksCgkJCQkJCXRleHQgPSAkdGhpcy5nZXRFbmNvZGVkVGV4dCgpLAoJCQkJCQlhbmNob3IgPSAiPGEgaHJlZj0nIyc+IisgdGV4dCArIjwvYT4iLAoJCQkJCQljbGFzc2VzID0gW10sCgkJCQkJCWV4dHJhQXR0cnMgPSBbXTsKCgkJCQkJLy8gQXJlIHdlIGluc2lkZSBhbiBvcHRncm91cD8KCQkJCQlpZiAoICRwYXJlbnQuaXMoICJvcHRncm91cCIgKSApIHsKCQkJCQkJdmFyIG9wdExhYmVsID0gJHBhcmVudC5hdHRyKCAibGFiZWwiICk7CgoJCQkJCQkvLyBoYXMgdGhpcyBvcHRncm91cCBhbHJlYWR5IGJlZW4gYnVpbHQgeWV0PwoJCQkJCQlpZiAoICQuaW5BcnJheSggb3B0TGFiZWwsIG9wdGdyb3VwcyApID09PSAtMSApIHsKCQkJCQkJCWxpcy5wdXNoKCAiPGxpIGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2xpc3QtZGl2aWRlcic+Iisgb3B0TGFiZWwgKyI8L2xpPiIgKTsKCQkJCQkJCW9wdGdyb3Vwcy5wdXNoKCBvcHRMYWJlbCApOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBGaW5kIHBsYWNlaG9sZGVyIHRleHQKCQkJCQkvLyBUT0RPOiBBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gdXNlIGdldEF0dHJpYnV0ZT8gXlJXCgkJCQkJaWYgKCAhdGhpcy5nZXRBdHRyaWJ1dGUoICJ2YWx1ZSIgKSB8fCB0ZXh0Lmxlbmd0aCA9PSAwIHx8ICR0aGlzLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSApIHsKCQkJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQkJCWNsYXNzZXMucHVzaCggInVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgkJCQkJCX0KCQkJCQkJcGxhY2Vob2xkZXIgPSBzZWxmLnBsYWNlaG9sZGVyID0gdGV4dDsKCQkJCQl9CgoJCQkJCS8vIHN1cHBvcnQgZGlzYWJsZWQgb3B0aW9uIHRhZ3MKCQkJCQlpZiAoIHRoaXMuZGlzYWJsZWQgKSB7CgkJCQkJCWNsYXNzZXMucHVzaCggInVpLWRpc2FibGVkIiApOwoJCQkJCQlleHRyYUF0dHJzLnB1c2goICJhcmlhLWRpc2FibGVkPSd0cnVlJyIgKTsKCQkJCQl9CgoJCQkJCWxpcy5wdXNoKCAiPGxpIGRhdGEtIiArICQubW9iaWxlLm5zICsgIm9wdGlvbi1pbmRleD0nIiArIGkgKyAiJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uPSciKyBkYXRhSWNvbiArIicgY2xhc3M9JyIrIGNsYXNzZXMuam9pbigiICIpICsgIicgIiArIGV4dHJhQXR0cnMuam9pbigiICIpICsiPiIrIGFuY2hvciArIjwvbGk+IiApOwoJCQkJfSk7CgoJCQkJc2VsZi5saXN0Lmh0bWwoIGxpcy5qb2luKCIgIikgKTsKCgkJCQlzZWxmLmxpc3QuZmluZCggImxpIiApCgkJCQkJLmF0dHIoeyAicm9sZSI6ICJvcHRpb24iLCAidGFiaW5kZXgiOiAiLTEiIH0pCgkJCQkJLmZpcnN0KCkuYXR0ciggInRhYmluZGV4IiwgIjAiICk7CgoJCQkJLy8gSGlkZSBoZWFkZXIgY2xvc2UgbGluayBmb3Igc2luZ2xlIHNlbGVjdHMKCQkJCWlmICggIXRoaXMuaXNNdWx0aXBsZSApIHsKCQkJCQl0aGlzLmhlYWRlckNsb3NlLmhpZGUoKTsKCQkJCX0KCgkJCQkvLyBIaWRlIGhlYWRlciBpZiBpdCdzIG5vdCBhIG11bHRpc2VsZWN0IGFuZCB0aGVyZSdzIG5vIHBsYWNlaG9sZGVyCgkJCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJCQl0aGlzLmhlYWRlci5oaWRlKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCQkJfQoKCQkJCS8vIE5vdyBwb3B1bGF0ZWQsIGNyZWF0ZSBsaXN0dmlldwoJCQkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7CgkJCX0sCgoJCQlfYnV0dG9uOiBmdW5jdGlvbigpewoJCQkJcmV0dXJuICQoICI8YT4iLCB7CgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkJImFyaWEtaGFzcG9wdXAiOiAidHJ1ZSIsCgoJCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCQl9KTsKCQkJfQoJCX0pOwoJfTsKCgkkKCAic2VsZWN0IiApLmxpdmUoICJzZWxlY3RtZW51YmVmb3JlY3JlYXRlIiwgZnVuY3Rpb24oKXsKCQl2YXIgc2VsZWN0bWVudVdpZGdldCA9ICQoIHRoaXMgKS5kYXRhKCAic2VsZWN0bWVudSIgKTsKCgkJaWYoICFzZWxlY3RtZW51V2lkZ2V0Lm9wdGlvbnMubmF0aXZlTWVudSApewoJCQlleHRlbmRTZWxlY3QoIHNlbGVjdG1lbnVXaWRnZXQgKTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwovKgoqICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWRpc2FibGVkOiBmYWxzZSwKCQlpY29uOiAiYXJyb3ctZCIsCgkJaWNvbnBvczogInJpZ2h0IiwKCQlpbmxpbmU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaWNvbnNoYWRvdzogdHJ1ZSwKCQltZW51UGFnZVRoZW1lOiAiYiIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zOiB0cnVlLAoJCWNsb3NlVGV4dDogIkNsb3NlIiwKCQluYXRpdmVNZW51OiB0cnVlLAoJCWluaXRTZWxlY3RvcjogInNlbGVjdDpub3QoOmpxbURhdGEocm9sZT0nc2xpZGVyJykpIgoJfSwKCglfYnV0dG9uOiBmdW5jdGlvbigpewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKICBfc2VsZWN0T3B0aW9uczogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKICB9LAoKCS8vIHNldHVwIGl0ZW1zIHRoYXQgYXJlIGdlbmVyYWxseSBuZWNlc3NhcnkgZm9yIHNlbGVjdCBtZW51IGV4dGVuc2lvbgoJX3ByZUV4dGVuc2lvbjogZnVuY3Rpb24oKXsKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0Jz4iICk7CgkJdGhpcy5zZWxlY3RJRCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICk7CgkJdGhpcy5sYWJlbCA9ICQoICJsYWJlbFtmb3I9JyIrIHRoaXMuc2VsZWN0SUQgKyInXSIgKS5hZGRDbGFzcyggInVpLXNlbGVjdCIgKTsKCQl0aGlzLmlzTXVsdGlwbGUgPSB0aGlzLnNlbGVjdFsgMCBdLm11bHRpcGxlOwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuc2VsZWN0LCAiYyIgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKIAkJLy8gQWxsb3dzIGZvciBleHRlbnNpb24gb2YgdGhlIG5hdGl2ZSBzZWxlY3QgZm9yIGN1c3RvbSBzZWxlY3RzIGFuZCBvdGhlciBwbHVnaW5zCgkJLy8gc2VlIHNlbGVjdC5jdXN0b20gZm9yIGV4YW1wbGUgZXh0ZW5zaW9uCgkJLy8gVE9ETyBleHBsb3JlIHBsdWdpbiByZWdpc3RyYXRpb24KCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlQ3JlYXRlIiApOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJLy8gSUUgdGhyb3dzIGFuIGV4Y2VwdGlvbiBhdCBvcHRpb25zLml0ZW0oKSBmdW5jdGlvbiB3aGVuCgkJCS8vIHRoZXJlIGlzIG5vIHNlbGVjdGVkIGl0ZW0KCQkJLy8gc2VsZWN0IGZpcnN0IGluIHRoaXMgY2FzZQoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4ID09IC0xID8gMCA6IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCgkJCS8vIFRPRE8gdmFsdWVzIGJ1dHRvbklkIGFuZCBtZW51SWQgYXJlIHVuZGVmaW5lZCBoZXJlCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkudGV4dCggJCggdGhpcy5zZWxlY3RbIDAgXS5vcHRpb25zLml0ZW0oIHNlbGVjdGVkSW5kZXggKSApLnRleHQoKSApCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYnV0dG9uTWFya3VwKCB7CgkJCQkJdGhlbWU6IG9wdGlvbnMudGhlbWUsCgkJCQkJaWNvbjogb3B0aW9ucy5pY29uLAoJCQkJCWljb25wb3M6IG9wdGlvbnMuaWNvbnBvcywKCQkJCQlpbmxpbmU6IG9wdGlvbnMuaW5saW5lLAoJCQkJCWNvcm5lcnM6IG9wdGlvbnMuY29ybmVycywKCQkJCQlzaGFkb3c6IG9wdGlvbnMuc2hhZG93LAoJCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdwoJCQkJfSk7CgoJCS8vIE9wZXJhIGRvZXMgbm90IHByb3Blcmx5IHN1cHBvcnQgb3BhY2l0eSBvbiBzZWxlY3QgZWxlbWVudHMKCQkvLyBJbiBNaW5pLCBpdCBoaWRlcyB0aGUgZWxlbWVudCwgYnV0IG5vdCBpdHMgdGV4dAoJCS8vIE9uIHRoZSBkZXNrdG9wLGl0IHNlZW1zIHRvIGRvIHRoZSBvcHBvc2l0ZQoJCS8vIGZvciB0aGVzZSByZWFzb25zLCB1c2luZyB0aGUgbmF0aXZlTWVudSBvcHRpb24gcmVzdWx0cyBpbiBhIGZ1bGwgbmF0aXZlIHNlbGVjdCBpbiBPcGVyYQoJCWlmICggb3B0aW9ucy5uYXRpdmVNZW51ICYmIHdpbmRvdy5vcGVyYSAmJiB3aW5kb3cub3BlcmEudmVyc2lvbiApIHsKCQkJdGhpcy5zZWxlY3QuYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1idG4tdXAtYyB1aS1idG4tY29ybmVyLWFsbCIgKQoJCQkJLmhpZGUoKQoJCQkJLmFwcGVuZFRvKCBidXR0b24uYWRkQ2xhc3MoJ3VpLWxpLWhhcy1jb3VudCcpICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0cignZGlzYWJsZWQnKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIEV2ZW50cyBvbiBuYXRpdmUgc2VsZWN0CgkJdGhpcy5zZWxlY3QuY2hhbmdlKCBmdW5jdGlvbigpIHsKCQkJc2VsZi5yZWZyZXNoKCk7CgkJfSk7CgoJCXRoaXMuYnVpbGQoKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5zZWxlY3QKCQkJLmFwcGVuZFRvKCBzZWxmLmJ1dHRvbiApCgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQkJLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBidXR0b24KCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIHZtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoJCQl9KQoJCQkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCS8vIFJlbW92ZSBhY3RpdmUgY2xhc3Mgb24gc2Nyb2xsL3RvdWNobW92ZQoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIgdm1vdXNlb3V0IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3V0IiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWJ0bi1kb3duLSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKTsKCQkJfSk7Cgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5pbmRleCggdGhpcyApOwoJCX0pLmdldCgpOwoJfSwKCglzZXRCdXR0b25UZXh0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLnRleHQoIGZ1bmN0aW9uKCkgewoJCQlpZiAoICFzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQlyZXR1cm4gc2VsZWN0ZWQudGV4dCgpOwoJCQl9CgoJCQlyZXR1cm4gc2VsZWN0ZWQubGVuZ3RoID8gc2VsZWN0ZWQubWFwKCBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQl9KS5nZXQoKS5qb2luKCAiLCAiICkgOiBzZWxmLnBsYWNlaG9sZGVyOwoJCX0pOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApewoJJC5tb2JpbGUuc2VsZWN0bWVudS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cn0pKCBqUXVlcnkgKTsKLyoKKiAiYnV0dG9ucyIgcGx1Z2luIC0gZm9yIG1ha2luZyBidXR0b24tbGlrZSBsaW5rcwoqLwoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5idXR0b25NYXJrdXAgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKCWZvciAoIHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKysgKSB7CgkJdmFyIGVsID0gdGhpcy5lcSggaSApLAoJCQllID0gZWxbIDAgXSwKCQkJbyA9ICQuZXh0ZW5kKCB7fSwgJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMsIHsKCQkJCWljb246ICAgICAgIG9wdGlvbnMuaWNvbiAgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29uICAgICAgIDogZWwuanFtRGF0YSggImljb24iICksCgkJCQlpY29ucG9zOiAgICBvcHRpb25zLmljb25wb3MgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbnBvcyAgICA6IGVsLmpxbURhdGEoICJpY29ucG9zIiApLAoJCQkJdGhlbWU6ICAgICAgb3B0aW9ucy50aGVtZSAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnRoZW1lICAgICAgOiBlbC5qcW1EYXRhKCAidGhlbWUiICksCgkJCQlpbmxpbmU6ICAgICBvcHRpb25zLmlubGluZSAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaW5saW5lICAgICA6IGVsLmpxbURhdGEoICJpbmxpbmUiICksCgkJCQlzaGFkb3c6ICAgICBvcHRpb25zLnNoYWRvdyAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc2hhZG93ICAgICA6IGVsLmpxbURhdGEoICJzaGFkb3ciICksCgkJCQljb3JuZXJzOiAgICBvcHRpb25zLmNvcm5lcnMgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY29ybmVycyAgICA6IGVsLmpxbURhdGEoICJjb3JuZXJzIiApLAoJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25zaGFkb3cgOiBlbC5qcW1EYXRhKCAiaWNvbnNoYWRvdyIgKQoJCQl9LCBvcHRpb25zICksCgoJCQkvLyBDbGFzc2VzIERlZmluZWQKCQkJaW5uZXJDbGFzcyA9ICJ1aS1idG4taW5uZXIiLAoJCQl0ZXh0Q2xhc3MgPSAidWktYnRuLXRleHQiLAoJCQlidXR0b25DbGFzcywgaWNvbkNsYXNzLAoKCQkJLy8gQnV0dG9uIGlubmVyIG1hcmt1cAoJCQlidXR0b25Jbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApLAoJCQlidXR0b25UZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggby53cmFwcGVyRWxzICksCgkJCWJ1dHRvbkljb24gPSBvLmljb24gPyBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSA6IG51bGw7CgoJCWlmICggYXR0YWNoRXZlbnRzICkgewoJCQlhdHRhY2hFdmVudHMoKTsKCQl9CgoJCS8vIGlmIG5vdCwgdHJ5IHRvIGZpbmQgY2xvc2VzdCB0aGVtZSBjb250YWluZXIKCQlpZiAoICFvLnRoZW1lICkgewoJCQlvLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGVsLCAiYyIgKTsKCQl9CgoJCWJ1dHRvbkNsYXNzID0gInVpLWJ0biB1aS1idG4tdXAtIiArIG8udGhlbWU7CgoJCWlmICggby5pbmxpbmUgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWlubGluZSI7CgkJfQoKCQlpZiAoIG8uaWNvbiApIHsKCQkJby5pY29uID0gInVpLWljb24tIiArIG8uaWNvbjsKCQkJby5pY29ucG9zID0gby5pY29ucG9zIHx8ICJsZWZ0IjsKCgkJCWljb25DbGFzcyA9ICJ1aS1pY29uICIgKyBvLmljb247CgoJCQlpZiAoIG8uaWNvbnNoYWRvdyApIHsKCQkJCWljb25DbGFzcyArPSAiIHVpLWljb24tc2hhZG93IjsKCQkJfQoJCX0KCgkJaWYgKCBvLmljb25wb3MgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWljb24tIiArIG8uaWNvbnBvczsKCgkJCWlmICggby5pY29ucG9zID09ICJub3RleHQiICYmICFlbC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCQllbC5hdHRyKCAidGl0bGUiLCBlbC5nZXRFbmNvZGVkVGV4dCgpICk7CgkJCX0KCQl9CgoJCWlmICggby5jb3JuZXJzICkgewoJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi1jb3JuZXItYWxsIjsKCQkJaW5uZXJDbGFzcyArPSAiIHVpLWJ0bi1jb3JuZXItYWxsIjsKCQl9CgoJCWlmICggby5zaGFkb3cgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktc2hhZG93IjsKCQl9CgoJCWUuc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiLCBvLnRoZW1lICk7CgkJZWwuYWRkQ2xhc3MoIGJ1dHRvbkNsYXNzICk7CgoJCWJ1dHRvbklubmVyLmNsYXNzTmFtZSA9IGlubmVyQ2xhc3M7CgkJYnV0dG9uSW5uZXIuc2V0QXR0cmlidXRlKCJhcmlhLWhpZGRlbiIsICJ0cnVlIik7CgoJCWJ1dHRvblRleHQuY2xhc3NOYW1lID0gdGV4dENsYXNzOwoJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25UZXh0ICk7CgoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJYnV0dG9uSWNvbi5jbGFzc05hbWUgPSBpY29uQ2xhc3M7CgkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25JY29uICk7CgkJfQoKCQl3aGlsZSAoIGUuZmlyc3RDaGlsZCApIHsKCQkJYnV0dG9uVGV4dC5hcHBlbmRDaGlsZCggZS5maXJzdENoaWxkICk7CgkJfQoKCQllLmFwcGVuZENoaWxkKCBidXR0b25Jbm5lciApOwoJCQoJCS8vIFRPRE8gb2J2aW91c2x5IGl0IHdvdWxkIGJlIG5pY2UgdG8gcHVsbCB0aGlzIGVsZW1lbnQgb3V0IGluc3RlYWQgb2YKCQkvLyByZXRyaWV2aW5nIGl0IGZyb20gdGhlIERPTSBhZ2FpbiwgYnV0IHRoaXMgY2hhbmdlIGlzIG11Y2ggbGVzcyBvYnRydXNpdmUKCQkvLyBhbmQgMS4wIGRyYXdzIG5pZ2gKCQkkLmRhdGEoIGUsICd0ZXh0V3JhcHBlcicsICQoIGJ1dHRvblRleHQgKSApOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7Cgljb3JuZXJzOiB0cnVlLAoJc2hhZG93OiB0cnVlLAoJaWNvbnNoYWRvdzogdHJ1ZSwKCWlubGluZTogZmFsc2UsCgl3cmFwcGVyRWxzOiAic3BhbiIKfTsKCmZ1bmN0aW9uIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBlbGVtZW50ICkgewogICAgdmFyIGNuYW1lOwoKICAgIHdoaWxlICggZWxlbWVudCApIHsKCQkvLyBOb3RlIHRoYXQgd2UgY2hlY2sgZm9yIHR5cGVvZiBjbGFzc05hbWUgYmVsb3cgYmVjYXVzZSB0aGUgZWxlbWVudCB3ZQoJCS8vIGhhbmRlZCBjb3VsZCBiZSBpbiBhbiBTVkcgRE9NIHdoZXJlIGNsYXNzTmFtZSBvbiBTVkcgZWxlbWVudHMgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIG9mIGEgZGlmZmVyZW50IHR5cGUgKFNWR0FuaW1hdGVkU3RyaW5nKS4gV2Ugb25seSBvcGVyYXRlIG9uIEhUTUwgRE9NCgkJLy8gZWxlbWVudHMsIHNvIHdlIGxvb2sgZm9yIHBsYWluICJzdHJpbmciLgoKICAgICAgICBjbmFtZSA9ICggdHlwZW9mIGVsZW1lbnQuY2xhc3NOYW1lID09PSAnc3RyaW5nJyApICYmIGVsZW1lbnQuY2xhc3NOYW1lLnNwbGl0KCcgJyk7CgogICAgICAgIGlmICggY25hbWUgJiYgJC5pbkFycmF5KCAidWktYnRuIiwgY25hbWUgKSA+IC0xICYmICQuaW5BcnJheSggInVpLWRpc2FibGVkIiwgY25hbWUgKSA8IDAgKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgfQoKICAgIHJldHVybiBlbGVtZW50Owp9Cgp2YXIgYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24oKSB7CgkkKCBkb2N1bWVudCApLmJpbmQoIHsKCQkidm1vdXNlZG93biI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGJ0biA9IGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSwKCQkJCSRidG4sIHRoZW1lOwoKCQkJaWYgKCBidG4gKSB7CgkJCQkkYnRuID0gJCggYnRuICk7CgkJCQl0aGVtZSA9ICRidG4uYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiApOwoJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB0aGVtZSApOwoJCQl9CgkJfSwKCQkidm1vdXNlY2FuY2VsIHZtb3VzZXVwIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgYnRuID0gY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApLAoJCQkJJGJ0biwgdGhlbWU7CgoJCQlpZiAoIGJ0biApIHsKCQkJCSRidG4gPSAkKCBidG4gKTsKCQkJCXRoZW1lID0gJGJ0bi5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiICk7CgkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICk7CgkJCX0KCQl9LAoJCSJ2bW91c2VvdmVyIGZvY3VzIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgYnRuID0gY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApLAoJCQkJJGJ0biwgdGhlbWU7CgoJCQlpZiAoIGJ0biApIHsKCQkJCSRidG4gPSAkKCBidG4gKTsKCQkJCXRoZW1lID0gJGJ0bi5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWUiICk7CgkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSApOwoJCQl9CgkJfSwKCQkidm1vdXNlb3V0IGJsdXIiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBidG4gPSBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICksCgkJCQkkYnRuLCB0aGVtZTsKCgkJCWlmICggYnRuICkgewoJCQkJJGJ0biA9ICQoIGJ0biApOwoJCQkJdGhlbWUgPSAkYnRuLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIgKTsKCQkJCSRidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4taG92ZXItIiArIHRoZW1lICArICIgdWktYnRuLWRvd24tIiArIHRoZW1lICkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArIHRoZW1lICk7CgkJCX0KCQl9Cgl9KTsKCglhdHRhY2hFdmVudHMgPSBudWxsOwp9OwoKLy9saW5rcyBpbiBiYXJzLCBvciB0aG9zZSB3aXRoICBkYXRhLXJvbGUgYmVjb21lIGJ1dHRvbnMKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCgkkKCAiOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktaGVhZGVyID4gYSwgLnVpLWZvb3RlciA+IGEsIC51aS1iYXIgPiA6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSA+IGEiLCBlLnRhcmdldCApCgkJLm5vdCggIi51aS1idG4sIDpqcW1EYXRhKHJvbGU9J25vbmUnKSwgOmpxbURhdGEocm9sZT0nbm9qcycpIiApCgkJLmJ1dHRvbk1hcmt1cCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKLyogCiogImNvbnRyb2xncm91cCIgcGx1Z2luIC0gY29ybmVyLXJvdW5kaW5nIGZvciBncm91cHMgb2YgYnV0dG9ucywgY2hlY2tzLCByYWRpb3MsIGV0YwoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmNvbnRyb2xncm91cCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkZWwgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQkJCWRpcmVjdGlvbjogJGVsLmpxbURhdGEoICJ0eXBlIiApIHx8ICJ2ZXJ0aWNhbCIsCgkJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJCWV4Y2x1ZGVJbnZpc2libGU6IHRydWUKCQkJCQl9LCBvcHRpb25zICksCgkJCWdyb3VwaGVhZGluZyA9ICRlbC5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJZmxDb3JuZXJzID0gby5kaXJlY3Rpb24gPT0gImhvcml6b250YWwiID8gWyAidWktY29ybmVyLWxlZnQiLCAidWktY29ybmVyLXJpZ2h0IiBdIDogWyAidWktY29ybmVyLXRvcCIsICJ1aS1jb3JuZXItYm90dG9tIiBdLAoJCQl0eXBlID0gJGVsLmZpbmQoICJpbnB1dCIgKS5maXJzdCgpLmF0dHIoICJ0eXBlIiApOwoKCQkvLyBSZXBsYWNlIGxlZ2VuZCB3aXRoIG1vcmUgc3R5bGFibGUgcmVwbGFjZW1lbnQgZGl2CgkJaWYgKCBncm91cGhlYWRpbmcubGVuZ3RoICkgewoJCQkkZWwud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29udHJvbGdyb3VwLWNvbnRyb2xzJz48L2Rpdj4iICk7CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPiIgKyBncm91cGhlYWRpbmcuaHRtbCgpICsgIjwvZGl2PiIgKS5pbnNlcnRCZWZvcmUoICRlbC5jaGlsZHJlbigwKSApOwoJCQlncm91cGhlYWRpbmcucmVtb3ZlKCk7CgkJfQoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLWNvbnRyb2xncm91cCB1aS1jb250cm9sZ3JvdXAtIiArIG8uZGlyZWN0aW9uICk7CgoJCS8vIFRPRE86IFRoaXMgc2hvdWxkIGJlIG1vdmVkIG91dCB0byB0aGUgY2xvc3VyZQoJCS8vIG90aGVyd2lzZSBpdCBpcyByZWRlZmluZWQgZWFjaCB0aW1lIGNvbnRyb2xncm91cCgpIGlzIGNhbGxlZAoJCWZ1bmN0aW9uIGZsaXBDbGFzc2VzKCBlbHMgKSB7CgkJCWVscy5yZW1vdmVDbGFzcyggInVpLWJ0bi1jb3JuZXItYWxsIHVpLXNoYWRvdyIgKQoJCQkJLmVxKCAwICkuYWRkQ2xhc3MoIGZsQ29ybmVyc1sgMCBdICkKCQkJCS5lbmQoKQoJCQkJLmxhc3QoKS5hZGRDbGFzcyggZmxDb3JuZXJzWyAxIF0gKS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC1sYXN0IiApOwoJCX0KCgkJZmxpcENsYXNzZXMoICRlbC5maW5kKCAiLnVpLWJ0biIgKyAoIG8uZXhjbHVkZUludmlzaWJsZSA/ICI6dmlzaWJsZSIgOiAiIiApICkgKTsKCQlmbGlwQ2xhc3NlcyggJGVsLmZpbmQoICIudWktYnRuLWlubmVyIiApICk7CgoJCWlmICggby5zaGFkb3cgKSB7CgkJCSRlbC5hZGRDbGFzcyggInVpLXNoYWRvdyIgKTsKCQl9Cgl9KTsKfTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICl7CgkkKCAiOmpxbURhdGEocm9sZT0nY29udHJvbGdyb3VwJykiLCBlLnRhcmdldCApLmNvbnRyb2xncm91cCh7IGV4Y2x1ZGVJbnZpc2libGU6IGZhbHNlIH0pOwp9KTsKCn0pKGpRdWVyeSk7LyoKKiAibGlua3MiIHBsdWdpbiAtIHNpbXBsZSBjbGFzcyBhZGRpdGlvbnMgZm9yIGxpbmtzCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKXsKCQoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcwoJJCggZS50YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5ub3QoICIudWktYnRuLCAudWktbGluay1pbmhlcml0LCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5hZGRDbGFzcyggInVpLWxpbmsiICk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsvKgoqICJmaXhIZWFkZXJGb290ZXIiIHBsdWdpbiAtIG9uLWRlbWFuZCBwb3NpdGlvbmluZyBmb3IgaGVhZGVycyxmb290ZXJzCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBzbGlkZURvd25DbGFzcyA9ICJ1aS1oZWFkZXItZml4ZWQgdWktZml4ZWQtaW5saW5lIGZhZGUiLAoJc2xpZGVVcENsYXNzID0gInVpLWZvb3Rlci1maXhlZCB1aS1maXhlZC1pbmxpbmUgZmFkZSIsCgoJc2xpZGVEb3duU2VsZWN0b3IgPSAiLnVpLWhlYWRlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpIiwKCXNsaWRlVXBTZWxlY3RvciA9ICIudWktZm9vdGVyOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiOwoKJC5mbi5maXhIZWFkZXJGb290ZXIgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCglpZiAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICggJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgKSApIHsKCQlyZXR1cm4gdGhpczsKCX0KCglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJaWYgKCAkdGhpcy5qcW1EYXRhKCAiZnVsbHNjcmVlbiIgKSApIHsKCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1wYWdlLWZ1bGxzY3JlZW4iICk7CgkJfQoKCQkvLyBTaG91bGQgYmUgc2xpZGVkb3duCgkJJHRoaXMuZmluZCggc2xpZGVEb3duU2VsZWN0b3IgKS5hZGRDbGFzcyggc2xpZGVEb3duQ2xhc3MgKTsKCgkJLy8gU2hvdWxkIGJlIHNsaWRldXAKCQkkdGhpcy5maW5kKCBzbGlkZVVwU2VsZWN0b3IgKS5hZGRDbGFzcyggc2xpZGVVcENsYXNzICk7Cgl9KTsKfTsKCi8vIHNpbmdsZSBjb250cm9sbGVyIGZvciBhbGwgc2hvd2luZyxoaWRpbmcsdG9nZ2xpbmcKJC5tb2JpbGUuZml4ZWRUb29sYmFycyA9IChmdW5jdGlvbigpIHsKCglpZiAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICggJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgJiYgJC5tb2JpbGUudG91Y2hPdmVyZmxvd0VuYWJsZWQgKSApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHN0aWNreUZvb3RlciwgZGVsYXlUaW1lciwKCQljdXJyZW50c3RhdGUgPSAiaW5saW5lIiwKCQlhdXRvSGlkZU1vZGUgPSBmYWxzZSwKCQlzaG93RGVsYXkgPSAxMDAsCgkJaWdub3JlVGFyZ2V0cyA9ICJhLGlucHV0LHRleHRhcmVhLHNlbGVjdCxidXR0b24sbGFiZWwsLnVpLWhlYWRlci1maXhlZCwudWktZm9vdGVyLWZpeGVkIiwKCQl0b29sYmFyU2VsZWN0b3IgPSAiLnVpLWhlYWRlci1maXhlZDpmaXJzdCwgLnVpLWZvb3Rlci1maXhlZDpub3QoLnVpLWZvb3Rlci1kdXBsaWNhdGUpOmxhc3QiLAoJCS8vIGZvciBzdG9yaW5nIHF1aWNrIHJlZmVyZW5jZXMgdG8gZHVwbGljYXRlIGZvb3RlcnMKCQlzdXBwb3J0VG91Y2ggPSAkLnN1cHBvcnQudG91Y2gsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXN0YXRlQmVmb3JlID0gbnVsbCwKCQlzY3JvbGxUcmlnZ2VyZWQgPSBmYWxzZSwKCQl0b3VjaFRvZ2dsZUVuYWJsZWQgPSB0cnVlOwoKCWZ1bmN0aW9uIHNob3dFdmVudENhbGxiYWNrKCBldmVudCApIHsKCQkvLyBBbiBldmVudCB0aGF0IGFmZmVjdHMgdGhlIGRpbWVuc2lvbnMgb2YgdGhlIHZpc3VhbCB2aWV3cG9ydCBoYXMKCQkvLyBiZWVuIHRyaWdnZXJlZC4gSWYgdGhlIGhlYWRlciBhbmQvb3IgZm9vdGVyIGZvciB0aGUgY3VycmVudCBwYWdlIGFyZSBpbiBvdmVybGF5CgkJLy8gbW9kZSwgd2Ugd2FudCB0byBoaWRlIHRoZW0sIGFuZCB0aGVuIGZpcmUgb2ZmIGEgdGltZXIgdG8gc2hvdyB0aGVtIGF0IGEgbGF0ZXIKCQkvLyBwb2ludC4gRXZlbnRzIGxpa2UgYSByZXNpemUgY2FuIGJlIHRyaWdnZXJlZCBjb250aW51b3VzbHkgZHVyaW5nIGEgc2Nyb2xsLCBvbgoJCS8vIHNvbWUgcGxhdGZvcm1zLCBzbyB0aGUgdGltZXIgaXMgdXNlZCB0byBkZWxheSB0aGUgYWN0dWFsIHBvc2l0aW9uaW5nIHVudGlsIHRoZQoJCS8vIGZsb29kIG9mIGV2ZW50cyBoYXZlIHN1YnNpZGVkLgoJCS8vCgkJLy8gSWYgd2UgYXJlIGluIGF1dG9IaWRlTW9kZSwgd2UgZG9uJ3QgZG8gYW55dGhpbmcgYmVjYXVzZSB3ZSBrbm93IHRoZSBzY3JvbGwKCQkvLyBjYWxsYmFja3MgZm9yIHRoZSBwbHVnaW4gd2lsbCBmaXJlIG9mZiBhIHNob3cgd2hlbiB0aGUgc2Nyb2xsaW5nIGhhcyBzdG9wcGVkLgoJCWlmICggIWF1dG9IaWRlTW9kZSAmJiBjdXJyZW50c3RhdGUgPT09ICJvdmVybGF5IiApIHsKCQkJaWYgKCAhZGVsYXlUaW1lciApIHsKCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuaGlkZSggdHJ1ZSApOwoJCQl9CgoJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLnN0YXJ0U2hvd1RpbWVyKCk7CgkJfQoJfQoKCSQoZnVuY3Rpb24oKSB7CgkJdmFyICRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICksCgkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCgkJJGRvY3VtZW50CgkJCS5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdG91Y2hUb2dnbGVFbmFibGVkICkgewoJCQkJCXN0YXRlQmVmb3JlID0gY3VycmVudHN0YXRlOwoJCQkJfQoJCQl9KQoJCQkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdG91Y2hUb2dnbGVFbmFibGVkICkgewoKCQkJCQlpZiAoICQoZXZlbnQudGFyZ2V0KS5jbG9zZXN0KCBpZ25vcmVUYXJnZXRzICkubGVuZ3RoICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlpZiAoICFzY3JvbGxUcmlnZ2VyZWQgKSB7CgkJCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMudG9nZ2xlKCBzdGF0ZUJlZm9yZSApOwoJCQkJCQlzdGF0ZUJlZm9yZSA9IG51bGw7CgkJCQkJfQoJCQkJfQoJCQl9KQoJCQkuYmluZCggInNpbGVudHNjcm9sbCIsIHNob3dFdmVudENhbGxiYWNrICk7CgoKCQkvLyBUaGUgYmVsb3cgY2hlY2tzIGZpcnN0IGZvciBhICQoZG9jdW1lbnQpLnNjcm9sbFRvcCgpIHZhbHVlLCBhbmQgaWYgemVybywgYmluZHMgc2Nyb2xsIGV2ZW50cyB0byAkKHdpbmRvdykgaW5zdGVhZC4KCQkvLyBJZiB0aGUgc2Nyb2xsVG9wIHZhbHVlIGlzIGFjdHVhbGx5IHplcm8sIGJvdGggd2lsbCByZXR1cm4gemVybyBhbnl3YXkuCgkJLy8KCQkvLyBXb3JrcyB3aXRoICQoZG9jdW1lbnQpLCBub3QgJCh3aW5kb3cpIDogT3BlcmEgTW9iaWxlIChXaW5NTyBwaG9uZTsga2luZGEgYnJva2VuIGFueXdheSkKCQkvLyBXb3JrcyB3aXRoICQod2luZG93KSwgbm90ICQoZG9jdW1lbnQpIDogSUUgNy84CgkJLy8gV29ya3Mgd2l0aCBlaXRoZXIgJCh3aW5kb3cpIG9yICQoZG9jdW1lbnQpIDogQ2hyb21lLCBGRiAzLjYvNCwgQW5kcm9pZCAxLjYvMi4xLCBpT1MKCQkvLyBOZWVkcyB3b3JrIGVpdGhlciB3YXkgOiBCQjUsIE9wZXJhIE1vYmlsZSAoaU9TKQoKCQkoICggJGRvY3VtZW50LnNjcm9sbFRvcCgpID09PSAwICkgPyAkd2luZG93IDogJGRvY3VtZW50ICkKCQkJLmJpbmQoICJzY3JvbGxzdGFydCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlzY3JvbGxUcmlnZ2VyZWQgPSB0cnVlOwoKCQkJCWlmICggc3RhdGVCZWZvcmUgPT09IG51bGwgKSB7CgkJCQkJc3RhdGVCZWZvcmUgPSBjdXJyZW50c3RhdGU7CgkJCQl9CgoJCQkJLy8gV2Ugb25seSBlbnRlciBhdXRvSGlkZU1vZGUgaWYgdGhlIGhlYWRlcnMvZm9vdGVycyBhcmUgaW4KCQkJCS8vIGFuIG92ZXJsYXkgc3RhdGUgb3IgdGhlIHNob3cgdGltZXIgd2FzIHN0YXJ0ZWQuIElmIHRoZQoJCQkJLy8gc2hvdyB0aW1lciBpcyBzZXQsIGNsZWFyIGl0IHNvIHRoZSBoZWFkZXJzL2Zvb3RlcnMgZG9uJ3QKCQkJCS8vIHNob3cgdXAgdW50aWwgYWZ0ZXIgd2UncmUgZG9uZSBzY3JvbGxpbmcuCgkJCQl2YXIgaXNPdmVybGF5U3RhdGUgPSBzdGF0ZUJlZm9yZSA9PSAib3ZlcmxheSI7CgoJCQkJYXV0b0hpZGVNb2RlID0gaXNPdmVybGF5U3RhdGUgfHwgISFkZWxheVRpbWVyOwoKCQkJCWlmICggYXV0b0hpZGVNb2RlICkgewoJCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuY2xlYXJTaG93VGltZXIoKTsKCgkJCQkJaWYgKCBpc092ZXJsYXlTdGF0ZSApIHsKCQkJCQkJJC5tb2JpbGUuZml4ZWRUb29sYmFycy5oaWRlKCB0cnVlICk7CgkJCQkJfQoJCQkJfQoJCQl9KQoJCQkuYmluZCggInNjcm9sbHN0b3AiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBpZ25vcmVUYXJnZXRzICkubGVuZ3RoICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlzY3JvbGxUcmlnZ2VyZWQgPSBmYWxzZTsKCgkJCQlpZiAoIGF1dG9IaWRlTW9kZSApIHsKCQkJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLnN0YXJ0U2hvd1RpbWVyKCk7CgkJCQkJYXV0b0hpZGVNb2RlID0gZmFsc2U7CgkJCQl9CgkJCQlzdGF0ZUJlZm9yZSA9IG51bGw7CgkJCX0pOwoKCQkJJHdpbmRvdy5iaW5kKCAicmVzaXplIHVwZGF0ZWxheW91dCIsIHNob3dFdmVudENhbGxiYWNrICk7Cgl9KTsKCgkvLyAxLiBCZWZvcmUgcGFnZSBpcyBzaG93biwgY2hlY2sgZm9yIGR1cGxpY2F0ZSBmb290ZXIKCS8vIDIuIEFmdGVyIHBhZ2UgaXMgc2hvd24sIGFwcGVuZCBmb290ZXIgdG8gbmV3IHBhZ2UKCSQoICIudWktcGFnZSIgKQoJCS5saXZlKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoKCQkJdmFyIHBhZ2UgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJCWZvb3RlciA9IHBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLAoJCQkJaWQgPSBmb290ZXIuZGF0YSggImlkIiApLAoJCQkJcHJldlBhZ2UgPSB1aS5wcmV2UGFnZSwKCQkJCXByZXZGb290ZXIgPSBwcmV2UGFnZSAmJiBwcmV2UGFnZS5maW5kKCAiOmpxbURhdGEocm9sZT0nZm9vdGVyJykiICksCgkJCQlwcmV2Rm9vdGVyTWF0Y2hlcyA9IHByZXZGb290ZXIubGVuZ3RoICYmIHByZXZGb290ZXIuanFtRGF0YSggImlkIiApID09PSBpZDsKCgkJCWlmICggaWQgJiYgcHJldkZvb3Rlck1hdGNoZXMgKSB7CgkJCQlzdGlja3lGb290ZXIgPSBmb290ZXI7CgkJCQlzZXRUb3AoIHN0aWNreUZvb3Rlci5yZW1vdmVDbGFzcyggImZhZGUgaW4gb3V0IiApLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICkgKTsKCQkJfQoJCX0pCgkJLmxpdmUoICJwYWdlc2hvdyIsIGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoIHN0aWNreUZvb3RlciAmJiBzdGlja3lGb290ZXIubGVuZ3RoICkgewoKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJc2V0VG9wKCBzdGlja3lGb290ZXIuYXBwZW5kVG8oICR0aGlzICkuYWRkQ2xhc3MoICJmYWRlIiApICk7CgkJCQkJc3RpY2t5Rm9vdGVyID0gbnVsbDsKCQkJCX0sIDUwMCk7CgkJCX0KCgkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuc2hvdyggdHJ1ZSwgdGhpcyApOwoJCX0pOwoKCS8vIFdoZW4gYSBjb2xsYXBzaWFibGUgaXMgaGlkZGVuIG9yIHNob3duIHdlIG5lZWQgdG8gdHJpZ2dlciB0aGUgZml4ZWQgdG9vbGJhciB0byByZXBvc2l0aW9uIGl0c2VsZiAoIzE2MzUpCgkkKCAiLnVpLWNvbGxhcHNpYmxlLWNvbnRhaW4iICkubGl2ZSggImNvbGxhcHNlIGV4cGFuZCIsIHNob3dFdmVudENhbGxiYWNrICk7CgoJLy8gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSBpcyBicm9rZW4gaW4gaU9TIDMuMi4xIG9uIHRoZSBpUGFkLiBUaGUKCS8vIGNvb3JkaW5hdGVzIGluc2lkZSBvZiB0aGUgcmVjdCBpdCByZXR1cm5zIGRvbid0IGhhdmUgdGhlIHBhZ2Ugc2Nyb2xsIHBvc2l0aW9uCgkvLyBmYWN0b3JlZCBvdXQgb2YgaXQgbGlrZSB0aGUgb3RoZXIgcGxhdGZvcm1zIGRvLiBUbyBnZXQgYXJvdW5kIHRoaXMsCgkvLyB3ZSdsbCBqdXN0IGNhbGN1bGF0ZSB0aGUgdG9wIG9mZnNldCB0aGUgb2xkIGZhc2hpb25lZCB3YXkgdW50aWwgY29yZSBoYXMKCS8vIGEgY2hhbmNlIHRvIGZpZ3VyZSBvdXQgaG93IHRvIGhhbmRsZSB0aGlzIHNpdHVhdGlvbi4KCS8vCgkvLyBUT0RPOiBXZSdsbCBuZWVkIHRvIGdldCByaWQgb2YgZ2V0T2Zmc2V0VG9wKCkgb25jZSBhIGZpeCBnZXRzIGZvbGRlZCBpbnRvIGNvcmUuCgoJZnVuY3Rpb24gZ2V0T2Zmc2V0VG9wKCBlbGUgKSB7CgkJdmFyIHRvcCA9IDAsCgkJCW9wLCBib2R5OwoKCQlpZiAoIGVsZSApIHsKCQkJYm9keSA9IGRvY3VtZW50LmJvZHk7CgkJCW9wID0gZWxlLm9mZnNldFBhcmVudDsKCQkJdG9wID0gZWxlLm9mZnNldFRvcDsKCgkJCXdoaWxlICggZWxlICYmIGVsZSAhPSBib2R5ICkgewoJCQkJdG9wICs9IGVsZS5zY3JvbGxUb3AgfHwgMDsKCgkJCQlpZiAoIGVsZSA9PSBvcCApIHsKCQkJCQl0b3AgKz0gb3Aub2Zmc2V0VG9wOwoJCQkJCW9wID0gZWxlLm9mZnNldFBhcmVudDsKCQkJCX0KCgkJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQkJfQoJCX0KCQlyZXR1cm4gdG9wOwoJfQoKCWZ1bmN0aW9uIHNldFRvcCggZWwgKSB7CgkJdmFyIGZyb21Ub3AgPSAkKHdpbmRvdykuc2Nyb2xsVG9wKCksCgkJCXRoaXNUb3AgPSBnZXRPZmZzZXRUb3AoIGVsWyAwIF0gKSwgLy8gZWwub2Zmc2V0KCkudG9wIHJldHVybnMgdGhlIHdyb25nIHZhbHVlIG9uIGlQYWQgaU9TIDMuMi4xLCBjYWxsIG91ciB3b3JrYXJvdW5kIGluc3RlYWQuCgkJCXRoaXNDU1N0b3AgPSBlbC5jc3MoICJ0b3AiICkgPT0gImF1dG8iID8gMCA6IHBhcnNlRmxvYXQoZWwuY3NzKCAidG9wIiApKSwKCQkJc2NyZWVuSGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0LAoJCQl0aGlzSGVpZ2h0ID0gZWwub3V0ZXJIZWlnaHQoKSwKCQkJdXNlUmVsYXRpdmUgPSBlbC5wYXJlbnRzKCAiLnVpLXBhZ2U6bm90KC51aS1wYWdlLWZ1bGxzY3JlZW4pIiApLmxlbmd0aCwKCQkJcmVsdmFsOwoKCQlpZiAoIGVsLmlzKCAiLnVpLWhlYWRlci1maXhlZCIgKSApIHsKCgkJCXJlbHZhbCA9IGZyb21Ub3AgLSB0aGlzVG9wICsgdGhpc0NTU3RvcDsKCgkJCWlmICggcmVsdmFsIDwgdGhpc1RvcCApIHsKCQkJCXJlbHZhbCA9IDA7CgkJCX0KCgkJCXJldHVybiBlbC5jc3MoICJ0b3AiLCB1c2VSZWxhdGl2ZSA/IHJlbHZhbCA6IGZyb21Ub3AgKTsKCQl9IGVsc2UgewoJCQkvLyByZWx2YWwgPSAtMSAqICh0aGlzVG9wIC0gKGZyb21Ub3AgKyBzY3JlZW5IZWlnaHQpICsgdGhpc0NTU3RvcCArIHRoaXNIZWlnaHQpOwoJCQkvLyBpZiAoIHJlbHZhbCA+IHRoaXNUb3AgKSB7IHJlbHZhbCA9IDA7IH0KCQkJcmVsdmFsID0gZnJvbVRvcCArIHNjcmVlbkhlaWdodCAtIHRoaXNIZWlnaHQgLSAodGhpc1RvcCAtIHRoaXNDU1N0b3AgKTsKCgkJCXJldHVybiBlbC5jc3MoICJ0b3AiLCB1c2VSZWxhdGl2ZSA/IHJlbHZhbCA6IGZyb21Ub3AgKyBzY3JlZW5IZWlnaHQgLSB0aGlzSGVpZ2h0ICk7CgkJfQoJfQoKCS8vIEV4cG9zZWQgbWV0aG9kcwoJcmV0dXJuIHsKCgkJc2hvdzogZnVuY3Rpb24oIGltbWVkaWF0ZWx5LCBwYWdlICkgewoKCQkJJC5tb2JpbGUuZml4ZWRUb29sYmFycy5jbGVhclNob3dUaW1lcigpOwoKCQkJY3VycmVudHN0YXRlID0gIm92ZXJsYXkiOwoKCQkJdmFyICRhcCA9IHBhZ2UgPyAkKCBwYWdlICkgOgoJCQkJCSggJC5tb2JpbGUuYWN0aXZlUGFnZSA/ICQubW9iaWxlLmFjdGl2ZVBhZ2UgOgoJCQkJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApICk7CgoJCQlyZXR1cm4gJGFwLmNoaWxkcmVuKCB0b29sYmFyU2VsZWN0b3IgKS5lYWNoKGZ1bmN0aW9uKCkgewoKCQkJCXZhciBlbCA9ICQoIHRoaXMgKSwKCQkJCQlmcm9tVG9wID0gJCggd2luZG93ICkuc2Nyb2xsVG9wKCksCgkJCQkJLy8gZWwub2Zmc2V0KCkudG9wIHJldHVybnMgdGhlIHdyb25nIHZhbHVlIG9uIGlQYWQgaU9TIDMuMi4xLCBjYWxsIG91ciB3b3JrYXJvdW5kIGluc3RlYWQuCgkJCQkJdGhpc1RvcCA9IGdldE9mZnNldFRvcCggZWxbIDAgXSApLAoJCQkJCXNjcmVlbkhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCwKCQkJCQl0aGlzSGVpZ2h0ID0gZWwub3V0ZXJIZWlnaHQoKSwKCQkJCQlhbHJlYWR5VmlzaWJsZSA9ICggZWwuaXMoICIudWktaGVhZGVyLWZpeGVkIiApICYmIGZyb21Ub3AgPD0gdGhpc1RvcCArIHRoaXNIZWlnaHQgKSB8fAoJCQkJCQkJCQkJCQkJCSggZWwuaXMoICIudWktZm9vdGVyLWZpeGVkIiApICYmIHRoaXNUb3AgPD0gZnJvbVRvcCArIHNjcmVlbkhlaWdodCApOwoKCQkJCS8vIEFkZCBzdGF0ZSBjbGFzcwoJCQkJZWwuYWRkQ2xhc3MoICJ1aS1maXhlZC1vdmVybGF5IiApLnJlbW92ZUNsYXNzKCAidWktZml4ZWQtaW5saW5lIiApOwoKCQkJCWlmICggIWFscmVhZHlWaXNpYmxlICYmICFpbW1lZGlhdGVseSApIHsKCQkJCQllbC5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbigpIHsKCQkJCQkJZWwucmVtb3ZlQ2xhc3MoICJpbiIgKTsKCQkJCQl9KS5hZGRDbGFzcyggImluIiApOwoJCQkJfQoJCQkJc2V0VG9wKGVsKTsKCQkJfSk7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oIGltbWVkaWF0ZWx5ICkgewoKCQkJY3VycmVudHN0YXRlID0gImlubGluZSI7CgoJCQl2YXIgJGFwID0gJC5tb2JpbGUuYWN0aXZlUGFnZSA/ICQubW9iaWxlLmFjdGl2ZVBhZ2UgOgoJCQkJCQkJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApOwoKCQkJcmV0dXJuICRhcC5jaGlsZHJlbiggdG9vbGJhclNlbGVjdG9yICkuZWFjaChmdW5jdGlvbigpIHsKCgkJCQl2YXIgZWwgPSAkKHRoaXMpLAoJCQkJCXRoaXNDU1N0b3AgPSBlbC5jc3MoICJ0b3AiICksCgkJCQkJY2xhc3NlczsKCgkJCQl0aGlzQ1NTdG9wID0gdGhpc0NTU3RvcCA9PSAiYXV0byIgPyAwIDoKCQkJCQkJCQkJCQlwYXJzZUZsb2F0KHRoaXNDU1N0b3ApOwoKCQkJCS8vIEFkZCBzdGF0ZSBjbGFzcwoJCQkJZWwuYWRkQ2xhc3MoICJ1aS1maXhlZC1pbmxpbmUiICkucmVtb3ZlQ2xhc3MoICJ1aS1maXhlZC1vdmVybGF5IiApOwoKCQkJCWlmICggdGhpc0NTU3RvcCA8IDAgfHwgKCBlbC5pcyggIi51aS1oZWFkZXItZml4ZWQiICkgJiYgdGhpc0NTU3RvcCAhPT0gMCApICkgewoKCQkJCQlpZiAoIGltbWVkaWF0ZWx5ICkgewoJCQkJCQllbC5jc3MoICJ0b3AiLCAwKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJaWYgKCBlbC5jc3MoICJ0b3AiICkgIT09ICJhdXRvIiAmJiBwYXJzZUZsb2F0KCBlbC5jc3MoICJ0b3AiICkgKSAhPT0gMCApIHsKCgkJCQkJCQljbGFzc2VzID0gIm91dCByZXZlcnNlIjsKCgkJCQkJCQllbC5hbmltYXRpb25Db21wbGV0ZShmdW5jdGlvbigpIHsKCQkJCQkJCQllbC5yZW1vdmVDbGFzcyggY2xhc3NlcyApLmNzcyggInRvcCIsIDAgKTsKCQkJCQkJCX0pLmFkZENsYXNzKCBjbGFzc2VzICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0sCgoJCXN0YXJ0U2hvd1RpbWVyOiBmdW5jdGlvbigpIHsKCgkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuY2xlYXJTaG93VGltZXIoKTsKCgkJCXZhciBhcmdzID0gW10uc2xpY2UuY2FsbCggYXJndW1lbnRzICk7CgoJCQlkZWxheVRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCWRlbGF5VGltZXIgPSB1bmRlZmluZWQ7CgkJCQkkLm1vYmlsZS5maXhlZFRvb2xiYXJzLnNob3cuYXBwbHkoIG51bGwsIGFyZ3MgKTsKCQkJfSwgc2hvd0RlbGF5KTsKCQl9LAoKCQljbGVhclNob3dUaW1lcjogZnVuY3Rpb24oKSB7CgkJCWlmICggZGVsYXlUaW1lciApIHsKCQkJCWNsZWFyVGltZW91dCggZGVsYXlUaW1lciApOwoJCQl9CgkJCWRlbGF5VGltZXIgPSB1bmRlZmluZWQ7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbiggZnJvbSApIHsKCQkJaWYgKCBmcm9tICkgewoJCQkJY3VycmVudHN0YXRlID0gZnJvbTsKCQkJfQoJCQlyZXR1cm4gKCBjdXJyZW50c3RhdGUgPT09ICJvdmVybGF5IiApID8gJC5tb2JpbGUuZml4ZWRUb29sYmFycy5oaWRlKCkgOgoJCQkJCQkJCSQubW9iaWxlLmZpeGVkVG9vbGJhcnMuc2hvdygpOwoJCX0sCgoJCXNldFRvdWNoVG9nZ2xlRW5hYmxlZDogZnVuY3Rpb24oIGVuYWJsZWQgKSB7CgkJCXRvdWNoVG9nZ2xlRW5hYmxlZCA9IGVuYWJsZWQ7CgkJfQoJfTsKfSkoKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCglpZiAoICQoICI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIsIGV2ZW50LnRhcmdldCApLmxlbmd0aCApIHsKCgkJJCggZXZlbnQudGFyZ2V0ICkuZWFjaChmdW5jdGlvbigpIHsKCgkJCWlmICggISQuc3VwcG9ydC5zY3JvbGxUb3AgfHwgKCAkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyAmJiAkLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZCApICkgewoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmICggJHRoaXMuanFtRGF0YSggImZ1bGxzY3JlZW4iICkgKSB7CgkJCQkkdGhpcy5hZGRDbGFzcyggInVpLXBhZ2UtZnVsbHNjcmVlbiIgKTsKCQkJfQoKCQkJLy8gU2hvdWxkIGJlIHNsaWRlZG93bgoJCQkkdGhpcy5maW5kKCBzbGlkZURvd25TZWxlY3RvciApLmFkZENsYXNzKCBzbGlkZURvd25DbGFzcyApOwoKCQkJLy8gU2hvdWxkIGJlIHNsaWRldXAKCQkJJHRoaXMuZmluZCggc2xpZGVVcFNlbGVjdG9yICkuYWRkQ2xhc3MoIHNsaWRlVXBDbGFzcyApOwoKCQl9KQoKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7Ci8qCiogImZpeEhlYWRlckZvb3RlciIgbmF0aXZlIHBsdWdpbiAtIEJlaGF2aW9yIGZvciAiZml4ZWQiIGhlYWRlcnMsZm9vdGVycywgYW5kIHNjcm9sbGluZyBpbm5lciBjb250ZW50CiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIEVuYWJsZSB0b3VjaCBvdmVyZmxvdyBzY3JvbGxpbmcgd2hlbiBpdCdzIG5hdGl2ZWx5IHN1cHBvcnRlZAokLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZCA9IGZhbHNlOwoKLy8gRW5hYmxlZCB6b29tIHdoZW4gdG91Y2ggb3ZlcmZsb3cgaXMgZW5hYmxlZC4gQ2FuIGNhdXNlIHVzYWJpbGl0eSBpc3N1ZXMsIHVuZm9ydHVuYXRlbHkKJC5tb2JpbGUudG91Y2hPdmVyZmxvd1pvb21FbmFibGVkID0gZmFsc2U7CgokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJaWYoICQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICYmICQubW9iaWxlLnRvdWNoT3ZlcmZsb3dFbmFibGVkICl7CgkJCgkJdmFyICR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJc2Nyb2xsU3RhcnRZID0gMDsKCQkJCgkJaWYoICR0YXJnZXQuaXMoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICkgKXsKCQkJCgkJCSR0YXJnZXQuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkcGFnZSA9ICQoIHRoaXMgKSwKCQkJCQkkZml4aWVzID0gJHBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpLCA6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKS5maWx0ZXIoICI6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSIgKSwKCQkJCQlmdWxsU2NyZWVuID0gJHBhZ2UuanFtRGF0YSggImZ1bGxzY3JlZW4iICksCgkJCQkJJHNjcm9sbEVsZW0gPSAkZml4aWVzLmxlbmd0aCA/ICRwYWdlLmZpbmQoICIudWktY29udGVudCIgKSA6ICRwYWdlOwoJCQkJCgkJCQkkcGFnZS5hZGRDbGFzcyggInVpLW1vYmlsZS10b3VjaC1vdmVyZmxvdyIgKTsKCQkJCQoJCQkJJHNjcm9sbEVsZW0uYmluZCggInNjcm9sbHN0b3AiLCBmdW5jdGlvbigpewoJCQkJCWlmKCAkc2Nyb2xsRWxlbS5zY3JvbGxUb3AoKSA+IDAgKXsKCQkJCQkJd2luZG93LnNjcm9sbFRvKCAwLCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApOwoJCQkJCX0KCQkJCX0pOwkKCQkJCQoJCQkJaWYoICRmaXhpZXMubGVuZ3RoICl7CgkJCQkJCgkJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1uYXRpdmUtZml4ZWQiICk7CgkJCQkJCgkJCQkJaWYoIGZ1bGxTY3JlZW4gKXsKCgkJCQkJCSRwYWdlLmFkZENsYXNzKCAidWktbmF0aXZlLWZ1bGxzY3JlZW4iICk7CgoJCQkJCQkkZml4aWVzLmFkZENsYXNzKCAiZmFkZSBpbiIgKTsKCgkJCQkJCSQoIGRvY3VtZW50ICkuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCl7CgkJCQkJCQkkZml4aWVzCgkJCQkJCQkJLnJlbW92ZUNsYXNzKCAidWktbmF0aXZlLWJhcnMtaGlkZGVuIiApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAiaW4gb3V0IiApCgkJCQkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uKCl7CgkJCQkJCQkJCSQodGhpcykubm90KCAiLmluIiApLmFkZENsYXNzKCAidWktbmF0aXZlLWJhcnMtaGlkZGVuIiApOwoJCQkJCQkJCX0pOwoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7Ci8qCiogImluaXQiIC0gSW5pdGlhbGl6ZSB0aGUgZnJhbWV3b3JrCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJCSRoZWFkID0gJCggImhlYWQiICksCgkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCiAJLy8gdHJpZ2dlciBtb2JpbGVpbml0IGV2ZW50IC0gdXNlZnVsIGhvb2sgZm9yIGNvbmZpZ3VyaW5nICQubW9iaWxlIHNldHRpbmdzIGJlZm9yZSB0aGV5J3JlIHVzZWQKCSQoIHdpbmRvdy5kb2N1bWVudCApLnRyaWdnZXIoICJtb2JpbGVpbml0IiApOwoKCS8vIHN1cHBvcnQgY29uZGl0aW9ucwoJLy8gaWYgZGV2aWNlIHN1cHBvcnQgY29uZGl0aW9uKHMpIGFyZW4ndCBtZXQsIGxlYXZlIHRoaW5ncyBhcyB0aGV5IGFyZSAtPiBhIGJhc2ljLCB1c2FibGUgZXhwZXJpZW5jZSwKCS8vIG90aGVyd2lzZSwgcHJvY2VlZCB3aXRoIHRoZSBlbmhhbmNlbWVudHMKCWlmICggISQubW9iaWxlLmdyYWRlQSgpICkgewoJCXJldHVybjsKCX0KCgkvLyBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzCgkvLyBvciBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChCQjUsIE9wZXJhIE1pbmkpCglpZiAoICQubW9iaWxlLmFqYXhCbGFja2xpc3QgKSB7CgkJJC5tb2JpbGUuYWpheEVuYWJsZWQgPSBmYWxzZTsKCX0KCgkvLyBhZGQgbW9iaWxlLCBpbml0aWFsIGxvYWQgInJlbmRlcmluZyIgY2xhc3NlcyB0byBkb2NFbAoJJGh0bWwuYWRkQ2xhc3MoICJ1aS1tb2JpbGUgdWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCgkvLyBsb2FkaW5nIGRpdiB3aGljaCBhcHBlYXJzIGR1cmluZyBBamF4IHJlcXVlc3RzCgkvLyB3aWxsIG5vdCBhcHBlYXIgaWYgJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgaXMgZmFsc2UKCXZhciAkbG9hZGVyID0gJCggIjxkaXYgY2xhc3M9J3VpLWxvYWRlciB1aS1ib2R5LWEgdWktY29ybmVyLWFsbCc+PHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi1sb2FkaW5nIHNwaW4nPjwvc3Bhbj48aDE+PC9oMT48L2Rpdj4iICk7CgoJJC5leHRlbmQoJC5tb2JpbGUsIHsKCQkvLyB0dXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4KCQlzaG93UGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlICkgewoJCQkJdmFyIGFjdGl2ZUJ0biA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZmlyc3QoKTsKCgkJCQkkbG9hZGVyCgkJCQkJLmZpbmQoICJoMSIgKQoJCQkJCQkudGV4dCggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgKQoJCQkJCQkuZW5kKCkKCQkJCQkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKQoJCQkJCS8vIHBvc2l0aW9uIGF0IHkgY2VudGVyIChpZiBzY3JvbGxUb3Agc3VwcG9ydGVkKSwgYWJvdmUgdGhlIGFjdGl2ZUJ0biAoaWYgZGVmaW5lZCksIG9yIGp1c3QgMTAwcHggZnJvbSB0b3AKCQkJCQkuY3NzKHsKCQkJCQkJdG9wOiAkLnN1cHBvcnQuc2Nyb2xsVG9wICYmICR3aW5kb3cuc2Nyb2xsVG9wKCkgKyAkd2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJCQlhY3RpdmVCdG4ubGVuZ3RoICYmIGFjdGl2ZUJ0bi5vZmZzZXQoKS50b3AgfHwgMTAwCgkJCQkJfSk7CgkJCX0KCgkJCSRodG1sLmFkZENsYXNzKCAidWktbG9hZGluZyIgKTsKCQl9LAoKCQloaWRlUGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCkgewoJCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLWxvYWRpbmciICk7CgkJfSwKCgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKTsKCgkJCS8vIGlmIG5vIHBhZ2VzIGFyZSBmb3VuZCwgY3JlYXRlIG9uZSB3aXRoIGJvZHkncyBpbm5lciBodG1sCgkJCWlmICggISRwYWdlcy5sZW5ndGggKSB7CgkJCQkkcGFnZXMgPSAkKCAiYm9keSIgKS53cmFwSW5uZXIoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPjwvZGl2PiIgKS5jaGlsZHJlbiggMCApOwoJCQl9CgoJCQkvLyBhZGQgZGlhbG9ncywgc2V0IGRhdGEtdXJsIGF0dHJzCgkJCSRwYWdlcy5hZGQoICI6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCh0aGlzKTsKCgkJCQkvLyB1bmxlc3MgdGhlIGRhdGEgdXJsIGlzIGFscmVhZHkgc2V0IHNldCBpdCB0byB0aGUgcGF0aG5hbWUKCQkJCWlmICggISR0aGlzLmpxbURhdGEoInVybCIpICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICRwYWdlcy5maXJzdCgpLnBhcmVudCgpLmFkZENsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0IiApOwoKCQkJLy8gYWxlcnQgbGlzdGVuZXJzIHRoYXQgdGhlIHBhZ2Vjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCBmb3IgYmluZGluZwoJCQkvLyB0byBldmVudHMgdHJpZ2dlcmVkIG9uIGl0CgkJCSR3aW5kb3cudHJpZ2dlciggInBhZ2Vjb250YWluZXJjcmVhdGUiICk7CgoJCQkvLyBjdWUgcGFnZSBsb2FkaW5nIG1lc3NhZ2UKCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCBvciB0aGVyZSdzIG5vIGhhc2ggZGVlcGxpbmssIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCWlmICggISQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkIHx8ICEkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggbG9jYXRpb24uaGFzaCApICkgewoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7IHRyYW5zaXRpb246ICJub25lIiwgcmV2ZXJzZTogdHJ1ZSwgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCQkvLyBvdGhlcndpc2UsIHRyaWdnZXIgYSBoYXNoY2hhbmdlIHRvIGxvYWQgYSBkZWVwbGluawoJCQllbHNlIHsKCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbIHRydWUgXSApOwoJCQl9CgkJfQoJfSk7CgkKCS8vIFRoaXMgZnVuY3Rpb24gaW5qZWN0cyBhIG1ldGEgdmlld3BvcnQgdGFnIHRvIHByZXZlbnQgc2NhbGluZy4gT2ZmIGJ5IGRlZmF1bHQsIG9uIGJ5IGRlZmF1bHQgd2hlbiB0b3VjaE92ZXJmbG93IHNjcm9sbGluZyBpcyBlbmFibGVkCglmdW5jdGlvbiBkaXNhYmxlWm9vbSgpIHsKCQl2YXIgY29udCA9ICJ1c2VyLXNjYWxhYmxlPW5vIiwKCQkJbWV0YSA9ICQoICJtZXRhW25hbWU9J3ZpZXdwb3J0J10iICk7CgkJCQoJCWlmKCBtZXRhLmxlbmd0aCApewoJCQltZXRhLmF0dHIoICJjb250ZW50IiwgbWV0YS5hdHRyKCAiY29udGVudCIgKSArICIsICIgKyBjb250ICk7CgkJfQoJCWVsc2V7CgkJCSQoICJoZWFkIiApLnByZXBlbmQoICI8bWV0YT4iLCB7ICJuYW1lIjogInZpZXdwb3J0IiwgImNvbnRlbnQiOiBjb250IH0gKTsKCQl9Cgl9CgkKCS8vIGlmIHRvdWNoLW92ZXJmbG93IGlzIGVuYWJsZWQsIGRpc2FibGUgdXNlciBzY2FsaW5nLCBhcyBpdCBjcmVhdGVzIHVzYWJpbGl0eSBpc3N1ZXMKCWlmKCAkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyAmJiAkLm1vYmlsZS50b3VjaE92ZXJmbG93RW5hYmxlZCAmJiAhJC5tb2JpbGUudG91Y2hPdmVyZmxvd1pvb21FbmFibGVkICl7CgkJZGlzYWJsZVpvb20oKTsKCX0KCgkvLyBpbml0aWFsaXplIGV2ZW50cyBub3csIGFmdGVyIG1vYmlsZWluaXQgaGFzIG9jY3VycmVkCgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cygpOwoKCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJLy8gdGhlbiBjaGVjayB3aGF0IHRoZSBzY3JvbGwgdG9wIGlzLiBBbmRyb2lkIHdpbGwgcmVwb3J0IDAuLi4gb3RoZXJzIDEKCS8vIG5vdGUgdGhhdCB0aGlzIGluaXRpYWwgc2Nyb2xsIHdvbid0IGhpZGUgdGhlIGFkZHJlc3MgYmFyLiBJdCdzIGp1c3QgZm9yIHRoZSBjaGVjay4KCSQoZnVuY3Rpb24oKSB7CgkJd2luZG93LnNjcm9sbFRvKCAwLCAxICk7CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkKHdpbmRvdykuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmKCAkLm1vYmlsZS5hdXRvSW5pdGlhbGl6ZVBhZ2UgKXsKCQkJJC5tb2JpbGUuaW5pdGlhbGl6ZVBhZ2UoKTsKCQl9CgoJCS8vIHdpbmRvdyBsb2FkIGV2ZW50CgkJLy8gaGlkZSBpT1MgYnJvd3NlciBjaHJvbWUgb24gbG9hZAoJCSR3aW5kb3cubG9hZCggJC5tb2JpbGUuc2lsZW50U2Nyb2xsICk7Cgl9KTsKfSkoIGpRdWVyeSwgdGhpcyApOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 23:24:01 GMT",
                    "Content-Length": "214829",
                    "Date": "Thu, 06 Nov 2014 23:24:01 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}