{
    "url": "http://localhost:9999/Polymer/mdv/src/TemplateBinding.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>the 'baseURI' property of a DOM element</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>base.href = document.baseURI;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/Polymer/mdv/src/TemplateBinding.js",
                "path": "/Polymer/mdv/src/TemplateBinding.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9Qb2x5bWVyL21kdi9zcmMvVGVtcGxhdGVCaW5kaW5nLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzgxNDENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDk6MzU6MjAgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDA5OjM1OjIwIEdNVA0KDQovLyBDb3B5cmlnaHQgKGMpIDIwMTQgVGhlIFBvbHltZXIgUHJvamVjdCBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgovLyBUaGlzIGNvZGUgbWF5IG9ubHkgYmUgdXNlZCB1bmRlciB0aGUgQlNEIHN0eWxlIGxpY2Vuc2UgZm91bmQgYXQgaHR0cDovL3BvbHltZXIuZ2l0aHViLmlvL0xJQ0VOU0UudHh0Ci8vIFRoZSBjb21wbGV0ZSBzZXQgb2YgYXV0aG9ycyBtYXkgYmUgZm91bmQgYXQgaHR0cDovL3BvbHltZXIuZ2l0aHViLmlvL0FVVEhPUlMudHh0Ci8vIFRoZSBjb21wbGV0ZSBzZXQgb2YgY29udHJpYnV0b3JzIG1heSBiZSBmb3VuZCBhdCBodHRwOi8vcG9seW1lci5naXRodWIuaW8vQ09OVFJJQlVUT1JTLnR4dAovLyBDb2RlIGRpc3RyaWJ1dGVkIGJ5IEdvb2dsZSBhcyBwYXJ0IG9mIHRoZSBwb2x5bWVyIHByb2plY3QgaXMgYWxzbwovLyBzdWJqZWN0IHRvIGFuIGFkZGl0aW9uYWwgSVAgcmlnaHRzIGdyYW50IGZvdW5kIGF0IGh0dHA6Ly9wb2x5bWVyLmdpdGh1Yi5pby9QQVRFTlRTLnR4dAoKKGZ1bmN0aW9uKGdsb2JhbCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZnVuY3Rpb24gYXNzZXJ0KHYpIHsKICAgIGlmICghdikKICAgICAgdGhyb3cgbmV3IEVycm9yKCdBc3NlcnRpb24gZmFpbGVkJyk7CiAgfQoKICB2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgogIGZ1bmN0aW9uIGdldEZyYWdtZW50Um9vdChub2RlKSB7CiAgICB2YXIgcDsKICAgIHdoaWxlIChwID0gbm9kZS5wYXJlbnROb2RlKSB7CiAgICAgIG5vZGUgPSBwOwogICAgfQoKICAgIHJldHVybiBub2RlOwogIH0KCiAgZnVuY3Rpb24gc2VhcmNoUmVmSWQobm9kZSwgaWQpIHsKICAgIGlmICghaWQpCiAgICAgIHJldHVybjsKCiAgICB2YXIgcmVmOwogICAgdmFyIHNlbGVjdG9yID0gJyMnICsgaWQ7CiAgICB3aGlsZSAoIXJlZikgewogICAgICBub2RlID0gZ2V0RnJhZ21lbnRSb290KG5vZGUpOwoKICAgICAgaWYgKG5vZGUucHJvdG9Db250ZW50XykKICAgICAgICByZWYgPSBub2RlLnByb3RvQ29udGVudF8ucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7CiAgICAgIGVsc2UgaWYgKG5vZGUuZ2V0RWxlbWVudEJ5SWQpCiAgICAgICAgcmVmID0gbm9kZS5nZXRFbGVtZW50QnlJZChpZCk7CgogICAgICBpZiAocmVmIHx8ICFub2RlLnRlbXBsYXRlQ3JlYXRvcl8pCiAgICAgICAgYnJlYWsKCiAgICAgIG5vZGUgPSBub2RlLnRlbXBsYXRlQ3JlYXRvcl87CiAgICB9CgogICAgcmV0dXJuIHJlZjsKICB9CgogIGZ1bmN0aW9uIGdldEluc3RhbmNlUm9vdChub2RlKSB7CiAgICB3aGlsZSAobm9kZS5wYXJlbnROb2RlKSB7CiAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICB9CiAgICByZXR1cm4gbm9kZS50ZW1wbGF0ZUNyZWF0b3JfID8gbm9kZSA6IG51bGw7CiAgfQoKICB2YXIgTWFwOwogIGlmIChnbG9iYWwuTWFwICYmIHR5cGVvZiBnbG9iYWwuTWFwLnByb3RvdHlwZS5mb3JFYWNoID09PSAnZnVuY3Rpb24nKSB7CiAgICBNYXAgPSBnbG9iYWwuTWFwOwogIH0gZWxzZSB7CiAgICBNYXAgPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5rZXlzID0gW107CiAgICAgIHRoaXMudmFsdWVzID0gW107CiAgICB9OwoKICAgIE1hcC5wcm90b3R5cGUgPSB7CiAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBpbmRleCA9IHRoaXMua2V5cy5pbmRleE9mKGtleSk7CiAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgdGhpcy5rZXlzLnB1c2goa2V5KTsKICAgICAgICAgIHRoaXMudmFsdWVzLnB1c2godmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnZhbHVlc1tpbmRleF0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHZhciBpbmRleCA9IHRoaXMua2V5cy5pbmRleE9mKGtleSk7CiAgICAgICAgaWYgKGluZGV4IDwgMCkKICAgICAgICAgIHJldHVybjsKCiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVzW2luZGV4XTsKICAgICAgfSwKCiAgICAgIGRlbGV0ZTogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBpbmRleCA9IHRoaXMua2V5cy5pbmRleE9mKGtleSk7CiAgICAgICAgaWYgKGluZGV4IDwgMCkKICAgICAgICAgIHJldHVybiBmYWxzZTsKCiAgICAgICAgdGhpcy5rZXlzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy52YWx1ZXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwKCiAgICAgIGZvckVhY2g6IGZ1bmN0aW9uKGYsIG9wdF90aGlzKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmtleXMubGVuZ3RoOyBpKyspCiAgICAgICAgICBmLmNhbGwob3B0X3RoaXMgfHwgdGhpcywgdGhpcy52YWx1ZXNbaV0sIHRoaXMua2V5c1tpXSwgdGhpcyk7CiAgICAgIH0KICAgIH07CiAgfQoKICAvLyBKU2NyaXB0IGRvZXMgbm90IGhhdmUgX19wcm90b19fLiBXZSB3cmFwIGFsbCBvYmplY3QgbGl0ZXJhbHMgd2l0aAogIC8vIGNyZWF0ZU9iamVjdCB3aGljaCB1c2VzIE9iamVjdC5jcmVhdGUsIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSBhbmQKICAvLyBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdGhhdCBkb2VzIHRoZSBleGFjdAogIC8vIHNhbWUgdGhpbmcuIFRoZSBtYWluIGRvd25zaWRlIHRvIHRoaXMgc29sdXRpb24gaXMgdGhhdCB3ZSBoYXZlIHRvIGV4dHJhY3QKICAvLyBhbGwgdGhvc2UgcHJvcGVydHkgZGVzY3JpcHRvcnMgZm9yIElFLgogIHZhciBjcmVhdGVPYmplY3QgPSAoJ19fcHJvdG9fXycgaW4ge30pID8KICAgICAgZnVuY3Rpb24ob2JqKSB7IHJldHVybiBvYmo7IH0gOgogICAgICBmdW5jdGlvbihvYmopIHsKICAgICAgICB2YXIgcHJvdG8gPSBvYmouX19wcm90b19fOwogICAgICAgIGlmICghcHJvdG8pCiAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgIHZhciBuZXdPYmplY3QgPSBPYmplY3QuY3JlYXRlKHByb3RvKTsKICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhvYmopLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5ld09iamVjdCwgbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBuYW1lKSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG5ld09iamVjdDsKICAgICAgfTsKCiAgLy8gSUUgZG9lcyBub3Qgc3VwcG9ydCBoYXZlIERvY3VtZW50LnByb3RvdHlwZS5jb250YWlucy4KICBpZiAodHlwZW9mIGRvY3VtZW50LmNvbnRhaW5zICE9ICdmdW5jdGlvbicpIHsKICAgIERvY3VtZW50LnByb3RvdHlwZS5jb250YWlucyA9IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgaWYgKG5vZGUgPT09IHRoaXMgfHwgbm9kZS5wYXJlbnROb2RlID09PSB0aGlzKQogICAgICAgIHJldHVybiB0cnVlOwogICAgICByZXR1cm4gdGhpcy5kb2N1bWVudEVsZW1lbnQuY29udGFpbnMobm9kZSk7CiAgICB9CiAgfQoKICB2YXIgQklORCA9ICdiaW5kJzsKICB2YXIgUkVQRUFUID0gJ3JlcGVhdCc7CiAgdmFyIElGID0gJ2lmJzsKCiAgdmFyIHRlbXBsYXRlQXR0cmlidXRlRGlyZWN0aXZlcyA9IHsKICAgICd0ZW1wbGF0ZSc6IHRydWUsCiAgICAncmVwZWF0JzogdHJ1ZSwKICAgICdiaW5kJzogdHJ1ZSwKICAgICdyZWYnOiB0cnVlCiAgfTsKCiAgdmFyIHNlbWFudGljVGVtcGxhdGVFbGVtZW50cyA9IHsKICAgICdUSEVBRCc6IHRydWUsCiAgICAnVEJPRFknOiB0cnVlLAogICAgJ1RGT09UJzogdHJ1ZSwKICAgICdUSCc6IHRydWUsCiAgICAnVFInOiB0cnVlLAogICAgJ1REJzogdHJ1ZSwKICAgICdDT0xHUk9VUCc6IHRydWUsCiAgICAnQ09MJzogdHJ1ZSwKICAgICdDQVBUSU9OJzogdHJ1ZSwKICAgICdPUFRJT04nOiB0cnVlLAogICAgJ09QVEdST1VQJzogdHJ1ZQogIH07CgogIHZhciBoYXNUZW1wbGF0ZUVsZW1lbnQgPSB0eXBlb2YgSFRNTFRlbXBsYXRlRWxlbWVudCAhPT0gJ3VuZGVmaW5lZCc7CiAgaWYgKGhhc1RlbXBsYXRlRWxlbWVudCkgewogICAgLy8gVE9ETyhyYWZhZWx3KTogUmVtb3ZlIHdoZW4gZml4IGZvcgogICAgLy8gaHR0cHM6Ly9jb2RlcmV2aWV3LmNocm9taXVtLm9yZy8xNjQ4MDMwMDIvCiAgICAvLyBtYWtlcyBpdCB0byBDaHJvbWUgcmVsZWFzZS4KICAgIChmdW5jdGlvbigpIHsKICAgICAgdmFyIHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZW1wbGF0ZScpOwogICAgICB2YXIgZCA9IHQuY29udGVudC5vd25lckRvY3VtZW50OwogICAgICB2YXIgaHRtbCA9IGQuYXBwZW5kQ2hpbGQoZC5jcmVhdGVFbGVtZW50KCdodG1sJykpOwogICAgICB2YXIgaGVhZCA9IGh0bWwuYXBwZW5kQ2hpbGQoZC5jcmVhdGVFbGVtZW50KCdoZWFkJykpOwogICAgICB2YXIgYmFzZSA9IGQuY3JlYXRlRWxlbWVudCgnYmFzZScpOwogICAgICBiYXNlLmhyZWYgPSBkb2N1bWVudC5iYXNlVVJJOwogICAgICBoZWFkLmFwcGVuZENoaWxkKGJhc2UpOwogICAgfSkoKTsKICB9CgogIHZhciBhbGxUZW1wbGF0ZXNTZWxlY3RvcnMgPSAndGVtcGxhdGUsICcgKwogICAgICBPYmplY3Qua2V5cyhzZW1hbnRpY1RlbXBsYXRlRWxlbWVudHMpLm1hcChmdW5jdGlvbih0YWdOYW1lKSB7CiAgICAgICAgcmV0dXJuIHRhZ05hbWUudG9Mb3dlckNhc2UoKSArICdbdGVtcGxhdGVdJzsKICAgICAgfSkuam9pbignLCAnKTsKCiAgZnVuY3Rpb24gaXNTVkdUZW1wbGF0ZShlbCkgewogICAgcmV0dXJuIGVsLnRhZ05hbWUgPT0gJ3RlbXBsYXRlJyAmJgogICAgICAgICAgIGVsLm5hbWVzcGFjZVVSSSA9PSAnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnOwogIH0KCiAgZnVuY3Rpb24gaXNIVE1MVGVtcGxhdGUoZWwpIHsKICAgIHJldHVybiBlbC50YWdOYW1lID09ICdURU1QTEFURScgJiYKICAgICAgICAgICBlbC5uYW1lc3BhY2VVUkkgPT0gJ2h0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwnOwogIH0KCiAgZnVuY3Rpb24gaXNBdHRyaWJ1dGVUZW1wbGF0ZShlbCkgewogICAgcmV0dXJuIEJvb2xlYW4oc2VtYW50aWNUZW1wbGF0ZUVsZW1lbnRzW2VsLnRhZ05hbWVdICYmCiAgICAgICAgICAgICAgICAgICBlbC5oYXNBdHRyaWJ1dGUoJ3RlbXBsYXRlJykpOwogIH0KCiAgZnVuY3Rpb24gaXNUZW1wbGF0ZShlbCkgewogICAgaWYgKGVsLmlzVGVtcGxhdGVfID09PSB1bmRlZmluZWQpCiAgICAgIGVsLmlzVGVtcGxhdGVfID0gZWwudGFnTmFtZSA9PSAnVEVNUExBVEUnIHx8IGlzQXR0cmlidXRlVGVtcGxhdGUoZWwpOwoKICAgIHJldHVybiBlbC5pc1RlbXBsYXRlXzsKICB9CgogIC8vIEZJWE1FOiBPYnNlcnZlIHRlbXBsYXRlcyBiZWluZyBhZGRlZC9yZW1vdmVkIGZyb20gZG9jdW1lbnRzCiAgLy8gRklYTUU6IEV4cG9zZSBpbXBlcmF0aXZlIEFQSSB0byBkZWNvcmF0ZSBhbmQgb2JzZXJ2ZSB0ZW1wbGF0ZXMgaW4KICAvLyAiZGlzY29ubmVjdGVkIHRyZXNzIiAoZS5nLiBTaGFkb3dSb290KQogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbihlKSB7CiAgICBib290c3RyYXBUZW1wbGF0ZXNSZWN1cnNpdmVseUZyb20oZG9jdW1lbnQpOwogICAgLy8gRklYTUU6IElzIHRoaXMgbmVlZGVkPyBTZWVtcyBsaWtlIGl0IHNob3VsZG4ndCBiZS4KICAgIFBsYXRmb3JtLnBlcmZvcm1NaWNyb3Rhc2tDaGVja3BvaW50KCk7CiAgfSwgZmFsc2UpOwoKICBmdW5jdGlvbiBmb3JBbGxUZW1wbGF0ZXNGcm9tKG5vZGUsIGZuKSB7CiAgICB2YXIgc3ViVGVtcGxhdGVzID0gbm9kZS5xdWVyeVNlbGVjdG9yQWxsKGFsbFRlbXBsYXRlc1NlbGVjdG9ycyk7CgogICAgaWYgKGlzVGVtcGxhdGUobm9kZSkpCiAgICAgIGZuKG5vZGUpCiAgICBmb3JFYWNoKHN1YlRlbXBsYXRlcywgZm4pOwogIH0KCiAgZnVuY3Rpb24gYm9vdHN0cmFwVGVtcGxhdGVzUmVjdXJzaXZlbHlGcm9tKG5vZGUpIHsKICAgIGZ1bmN0aW9uIGJvb3RzdHJhcCh0ZW1wbGF0ZSkgewogICAgICBpZiAoIUhUTUxUZW1wbGF0ZUVsZW1lbnQuZGVjb3JhdGUodGVtcGxhdGUpKQogICAgICAgIGJvb3RzdHJhcFRlbXBsYXRlc1JlY3Vyc2l2ZWx5RnJvbSh0ZW1wbGF0ZS5jb250ZW50KTsKICAgIH0KCiAgICBmb3JBbGxUZW1wbGF0ZXNGcm9tKG5vZGUsIGJvb3RzdHJhcCk7CiAgfQoKICBpZiAoIWhhc1RlbXBsYXRlRWxlbWVudCkgewogICAgLyoqCiAgICAgKiBUaGlzIHJlcHJlc2VudHMgYSA8dGVtcGxhdGU+IGVsZW1lbnQuCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBleHRlbmRzIHtIVE1MRWxlbWVudH0KICAgICAqLwogICAgZ2xvYmFsLkhUTUxUZW1wbGF0ZUVsZW1lbnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGhyb3cgVHlwZUVycm9yKCdJbGxlZ2FsIGNvbnN0cnVjdG9yJyk7CiAgICB9OwogIH0KCiAgdmFyIGhhc1Byb3RvID0gJ19fcHJvdG9fXycgaW4ge307CgogIGZ1bmN0aW9uIG1peGluKHRvLCBmcm9tKSB7CiAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhmcm9tKS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRvLCBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihmcm9tLCBuYW1lKSk7CiAgICB9KTsKICB9CgogIC8vIGh0dHA6Ly9kdmNzLnczLm9yZy9oZy93ZWJjb21wb25lbnRzL3Jhdy1maWxlL3RpcC9zcGVjL3RlbXBsYXRlcy9pbmRleC5odG1sI2Rmbi10ZW1wbGF0ZS1jb250ZW50cy1vd25lcgogIGZ1bmN0aW9uIGdldE9yQ3JlYXRlVGVtcGxhdGVDb250ZW50c093bmVyKHRlbXBsYXRlKSB7CiAgICB2YXIgZG9jID0gdGVtcGxhdGUub3duZXJEb2N1bWVudAogICAgaWYgKCFkb2MuZGVmYXVsdFZpZXcpCiAgICAgIHJldHVybiBkb2M7CiAgICB2YXIgZCA9IGRvYy50ZW1wbGF0ZUNvbnRlbnRzT3duZXJfOwogICAgaWYgKCFkKSB7CiAgICAgIC8vIFRPRE8oYXJ2KTogVGhpcyBzaG91bGQgZWl0aGVyIGJlIGEgRG9jdW1lbnQgb3IgSFRNTERvY3VtZW50IGRlcGVuZGluZwogICAgICAvLyBvbiBkb2MuCiAgICAgIGQgPSBkb2MuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KCcnKTsKICAgICAgd2hpbGUgKGQubGFzdENoaWxkKSB7CiAgICAgICAgZC5yZW1vdmVDaGlsZChkLmxhc3RDaGlsZCk7CiAgICAgIH0KICAgICAgZG9jLnRlbXBsYXRlQ29udGVudHNPd25lcl8gPSBkOwogICAgfQogICAgcmV0dXJuIGQ7CiAgfQoKICBmdW5jdGlvbiBnZXRUZW1wbGF0ZVN0YWdpbmdEb2N1bWVudCh0ZW1wbGF0ZSkgewogICAgaWYgKCF0ZW1wbGF0ZS5zdGFnaW5nRG9jdW1lbnRfKSB7CiAgICAgIHZhciBvd25lciA9IHRlbXBsYXRlLm93bmVyRG9jdW1lbnQ7CiAgICAgIGlmICghb3duZXIuc3RhZ2luZ0RvY3VtZW50XykgewogICAgICAgIG93bmVyLnN0YWdpbmdEb2N1bWVudF8gPSBvd25lci5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoJycpOwogICAgICAgIG93bmVyLnN0YWdpbmdEb2N1bWVudF8uaXNTdGFnaW5nRG9jdW1lbnQgPSB0cnVlOwogICAgICAgIC8vIFRPRE8ocmFmYWVsdyk6IFJlbW92ZSB3aGVuIGZpeCBmb3IKICAgICAgICAvLyBodHRwczovL2NvZGVyZXZpZXcuY2hyb21pdW0ub3JnLzE2NDgwMzAwMi8KICAgICAgICAvLyBtYWtlcyBpdCB0byBDaHJvbWUgcmVsZWFzZS4KICAgICAgICB2YXIgYmFzZSA9IG93bmVyLnN0YWdpbmdEb2N1bWVudF8uY3JlYXRlRWxlbWVudCgnYmFzZScpOwogICAgICAgIGJhc2UuaHJlZiA9IGRvY3VtZW50LmJhc2VVUkk7CiAgICAgICAgb3duZXIuc3RhZ2luZ0RvY3VtZW50Xy5oZWFkLmFwcGVuZENoaWxkKGJhc2UpOwoKICAgICAgICBvd25lci5zdGFnaW5nRG9jdW1lbnRfLnN0YWdpbmdEb2N1bWVudF8gPSBvd25lci5zdGFnaW5nRG9jdW1lbnRfOwogICAgICB9CgogICAgICB0ZW1wbGF0ZS5zdGFnaW5nRG9jdW1lbnRfID0gb3duZXIuc3RhZ2luZ0RvY3VtZW50XzsKICAgIH0KCiAgICByZXR1cm4gdGVtcGxhdGUuc3RhZ2luZ0RvY3VtZW50XzsKICB9CgogIC8vIEZvciBub24tdGVtcGxhdGUgYnJvd3NlcnMsIHRoZSBwYXJzZXIgd2lsbCBkaXNhbGxvdyA8dGVtcGxhdGU+IGluIGNlcnRhaW4KICAvLyBsb2NhdGlvbnMsIHNvIHdlIGFsbG93ICJhdHRyaWJ1dGUgdGVtcGxhdGVzIiB3aGljaCBjb21iaW5lIHRoZSB0ZW1wbGF0ZQogIC8vIGVsZW1lbnQgd2l0aCB0aGUgdG9wLWxldmVsIGNvbnRhaW5lciBub2RlIG9mIHRoZSBjb250ZW50LCBlLmcuCiAgLy8KICAvLyAgIDx0ciB0ZW1wbGF0ZSByZXBlYXQ9Int7IGZvbyB9fSIiIGNsYXNzPSJiYXIiPjx0ZD5CYXI8L3RkPjwvdHI+CiAgLy8KICAvLyBiZWNvbWVzCiAgLy8KICAvLyAgIDx0ZW1wbGF0ZSByZXBlYXQ9Int7IGZvbyB9fSI+CiAgLy8gICArICNkb2N1bWVudC1mcmFnbWVudAogIC8vICAgICArIDx0ciBjbGFzcz0iYmFyIj4KICAvLyAgICAgICArIDx0ZD5CYXI8L3RkPgogIC8vCiAgZnVuY3Rpb24gZXh0cmFjdFRlbXBsYXRlRnJvbUF0dHJpYnV0ZVRlbXBsYXRlKGVsKSB7CiAgICB2YXIgdGVtcGxhdGUgPSBlbC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RlbXBsYXRlJyk7CiAgICBlbC5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0ZW1wbGF0ZSwgZWwpOwoKICAgIHZhciBhdHRyaWJzID0gZWwuYXR0cmlidXRlczsKICAgIHZhciBjb3VudCA9IGF0dHJpYnMubGVuZ3RoOwogICAgd2hpbGUgKGNvdW50LS0gPiAwKSB7CiAgICAgIHZhciBhdHRyaWIgPSBhdHRyaWJzW2NvdW50XTsKICAgICAgaWYgKHRlbXBsYXRlQXR0cmlidXRlRGlyZWN0aXZlc1thdHRyaWIubmFtZV0pIHsKICAgICAgICBpZiAoYXR0cmliLm5hbWUgIT09ICd0ZW1wbGF0ZScpCiAgICAgICAgICB0ZW1wbGF0ZS5zZXRBdHRyaWJ1dGUoYXR0cmliLm5hbWUsIGF0dHJpYi52YWx1ZSk7CiAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKGF0dHJpYi5uYW1lKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0ZW1wbGF0ZTsKICB9CgogIGZ1bmN0aW9uIGV4dHJhY3RUZW1wbGF0ZUZyb21TVkdUZW1wbGF0ZShlbCkgewogICAgdmFyIHRlbXBsYXRlID0gZWwub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZW1wbGF0ZScpOwogICAgZWwucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGVtcGxhdGUsIGVsKTsKCiAgICB2YXIgYXR0cmlicyA9IGVsLmF0dHJpYnV0ZXM7CiAgICB2YXIgY291bnQgPSBhdHRyaWJzLmxlbmd0aDsKICAgIHdoaWxlIChjb3VudC0tID4gMCkgewogICAgICB2YXIgYXR0cmliID0gYXR0cmlic1tjb3VudF07CiAgICAgIHRlbXBsYXRlLnNldEF0dHJpYnV0ZShhdHRyaWIubmFtZSwgYXR0cmliLnZhbHVlKTsKICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKGF0dHJpYi5uYW1lKTsKICAgIH0KCiAgICBlbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsKTsKICAgIHJldHVybiB0ZW1wbGF0ZTsKICB9CgogIGZ1bmN0aW9uIGxpZnROb25OYXRpdmVUZW1wbGF0ZUNoaWxkcmVuSW50b0NvbnRlbnQodGVtcGxhdGUsIGVsLCB1c2VSb290KSB7CiAgICB2YXIgY29udGVudCA9IHRlbXBsYXRlLmNvbnRlbnQ7CiAgICBpZiAodXNlUm9vdCkgewogICAgICBjb250ZW50LmFwcGVuZENoaWxkKGVsKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBjaGlsZDsKICAgIHdoaWxlIChjaGlsZCA9IGVsLmZpcnN0Q2hpbGQpIHsKICAgICAgY29udGVudC5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICB9CiAgfQoKICB2YXIgdGVtcGxhdGVPYnNlcnZlcjsKICBpZiAodHlwZW9mIE11dGF0aW9uT2JzZXJ2ZXIgPT0gJ2Z1bmN0aW9uJykgewogICAgdGVtcGxhdGVPYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGZ1bmN0aW9uKHJlY29yZHMpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWNvcmRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVjb3Jkc1tpXS50YXJnZXQucmVmQ2hhbmdlZF8oKTsKICAgICAgfQogICAgfSk7CiAgfQoKICAvKioKICAgKiBFbnN1cmVzIHByb3BlciBBUEkgYW5kIGNvbnRlbnQgbW9kZWwgZm9yIHRlbXBsYXRlIGVsZW1lbnRzLgogICAqIEBwYXJhbSB7SFRNTFRlbXBsYXRlRWxlbWVudH0gb3B0X2luc3RhbmNlUmVmIFRoZSB0ZW1wbGF0ZSBlbGVtZW50IHdoaWNoCiAgICogICAgIHxlbHwgdGVtcGxhdGUgZWxlbWVudCB3aWxsIHJldHVybiBhcyB0aGUgdmFsdWUgb2YgaXRzIHJlZigpLCBhbmQgd2hvc2UKICAgKiAgICAgY29udGVudCB3aWxsIGJlIHVzZWQgYXMgc291cmNlIHdoZW4gY3JlYXRlSW5zdGFuY2UoKSBpcyBpbnZva2VkLgogICAqLwogIEhUTUxUZW1wbGF0ZUVsZW1lbnQuZGVjb3JhdGUgPSBmdW5jdGlvbihlbCwgb3B0X2luc3RhbmNlUmVmKSB7CiAgICBpZiAoZWwudGVtcGxhdGVJc0RlY29yYXRlZF8pCiAgICAgIHJldHVybiBmYWxzZTsKCiAgICB2YXIgdGVtcGxhdGVFbGVtZW50ID0gZWw7CiAgICB0ZW1wbGF0ZUVsZW1lbnQudGVtcGxhdGVJc0RlY29yYXRlZF8gPSB0cnVlOwoKICAgIHZhciBpc05hdGl2ZUhUTUxUZW1wbGF0ZSA9IGlzSFRNTFRlbXBsYXRlKHRlbXBsYXRlRWxlbWVudCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc1RlbXBsYXRlRWxlbWVudDsKICAgIHZhciBib290c3RyYXBDb250ZW50cyA9IGlzTmF0aXZlSFRNTFRlbXBsYXRlOwogICAgdmFyIGxpZnRDb250ZW50cyA9ICFpc05hdGl2ZUhUTUxUZW1wbGF0ZTsKICAgIHZhciBsaWZ0Um9vdCA9IGZhbHNlOwoKICAgIGlmICghaXNOYXRpdmVIVE1MVGVtcGxhdGUpIHsKICAgICAgaWYgKGlzQXR0cmlidXRlVGVtcGxhdGUodGVtcGxhdGVFbGVtZW50KSkgewogICAgICAgIGFzc2VydCghb3B0X2luc3RhbmNlUmVmKTsKICAgICAgICB0ZW1wbGF0ZUVsZW1lbnQgPSBleHRyYWN0VGVtcGxhdGVGcm9tQXR0cmlidXRlVGVtcGxhdGUoZWwpOwogICAgICAgIHRlbXBsYXRlRWxlbWVudC50ZW1wbGF0ZUlzRGVjb3JhdGVkXyA9IHRydWU7CiAgICAgICAgaXNOYXRpdmVIVE1MVGVtcGxhdGUgPSBoYXNUZW1wbGF0ZUVsZW1lbnQ7CiAgICAgICAgbGlmdFJvb3QgPSB0cnVlOwogICAgICB9IGVsc2UgaWYgKGlzU1ZHVGVtcGxhdGUodGVtcGxhdGVFbGVtZW50KSkgewogICAgICAgIHRlbXBsYXRlRWxlbWVudCA9IGV4dHJhY3RUZW1wbGF0ZUZyb21TVkdUZW1wbGF0ZShlbCk7CiAgICAgICAgdGVtcGxhdGVFbGVtZW50LnRlbXBsYXRlSXNEZWNvcmF0ZWRfID0gdHJ1ZTsKICAgICAgICBpc05hdGl2ZUhUTUxUZW1wbGF0ZSA9IGhhc1RlbXBsYXRlRWxlbWVudDsKICAgICAgfQogICAgfQoKICAgIGlmICghaXNOYXRpdmVIVE1MVGVtcGxhdGUpIHsKICAgICAgZml4VGVtcGxhdGVFbGVtZW50UHJvdG90eXBlKHRlbXBsYXRlRWxlbWVudCk7CiAgICAgIHZhciBkb2MgPSBnZXRPckNyZWF0ZVRlbXBsYXRlQ29udGVudHNPd25lcih0ZW1wbGF0ZUVsZW1lbnQpOwogICAgICB0ZW1wbGF0ZUVsZW1lbnQuY29udGVudF8gPSBkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgfQoKICAgIGlmIChvcHRfaW5zdGFuY2VSZWYpIHsKICAgICAgLy8gdGVtcGxhdGUgaXMgY29udGFpbmVkIHdpdGhpbiBhbiBpbnN0YW5jZSwgaXRzIGRpcmVjdCBjb250ZW50IG11c3QgYmUKICAgICAgLy8gZW1wdHkKICAgICAgdGVtcGxhdGVFbGVtZW50Lmluc3RhbmNlUmVmXyA9IG9wdF9pbnN0YW5jZVJlZjsKICAgIH0gZWxzZSBpZiAobGlmdENvbnRlbnRzKSB7CiAgICAgIGxpZnROb25OYXRpdmVUZW1wbGF0ZUNoaWxkcmVuSW50b0NvbnRlbnQodGVtcGxhdGVFbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZnRSb290KTsKICAgIH0gZWxzZSBpZiAoYm9vdHN0cmFwQ29udGVudHMpIHsKICAgICAgYm9vdHN0cmFwVGVtcGxhdGVzUmVjdXJzaXZlbHlGcm9tKHRlbXBsYXRlRWxlbWVudC5jb250ZW50KTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvLyBUT0RPKHJhZmFlbHcpOiBUaGlzIHVzZWQgdG8gZGVjb3JhdGUgcmVjdXJzaXZlbHkgYWxsIHRlbXBsYXRlcyBmcm9tIGEgZ2l2ZW4KICAvLyBub2RlLiBUaGlzIGhhcHBlbnMgYnkgZGVmYXVsdCBvbiAnRE9NQ29udGVudExvYWRlZCcsIGJ1dCBtYXkgYmUgbmVlZGVkCiAgLy8gaW4gc3VidHJlZXMgbm90IGRlc2NlbmRlbnQgZnJvbSBkb2N1bWVudCAoZS5nLiBTaGFkb3dSb290KS4KICAvLyBSZXZpZXcgd2hldGhlciB0aGlzIGlzIHRoZSByaWdodCBwdWJsaWMgQVBJLgogIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwID0gYm9vdHN0cmFwVGVtcGxhdGVzUmVjdXJzaXZlbHlGcm9tOwoKICB2YXIgaHRtbEVsZW1lbnQgPSBnbG9iYWwuSFRNTFVua25vd25FbGVtZW50IHx8IEhUTUxFbGVtZW50OwoKICB2YXIgY29udGVudERlc2NyaXB0b3IgPSB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5jb250ZW50XzsKICAgIH0sCiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlCiAgfTsKCiAgaWYgKCFoYXNUZW1wbGF0ZUVsZW1lbnQpIHsKICAgIC8vIEdlY2tvIGlzIG1vcmUgcGlja3kgd2l0aCB0aGUgcHJvdG90eXBlIHRoYW4gV2ViS2l0LiBNYWtlIHN1cmUgdG8gdXNlIHRoZQogICAgLy8gc2FtZSBwcm90b3R5cGUgYXMgY3JlYXRlZCBpbiB0aGUgY29uc3RydWN0b3IuCiAgICBIVE1MVGVtcGxhdGVFbGVtZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoaHRtbEVsZW1lbnQucHJvdG90eXBlKTsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoSFRNTFRlbXBsYXRlRWxlbWVudC5wcm90b3R5cGUsICdjb250ZW50JywKICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50RGVzY3JpcHRvcik7CiAgfQoKICBmdW5jdGlvbiBmaXhUZW1wbGF0ZUVsZW1lbnRQcm90b3R5cGUoZWwpIHsKICAgIGlmIChoYXNQcm90bykKICAgICAgZWwuX19wcm90b19fID0gSFRNTFRlbXBsYXRlRWxlbWVudC5wcm90b3R5cGU7CiAgICBlbHNlCiAgICAgIG1peGluKGVsLCBIVE1MVGVtcGxhdGVFbGVtZW50LnByb3RvdHlwZSk7CiAgfQoKICBmdW5jdGlvbiBlbnN1cmVTZXRNb2RlbFNjaGVkdWxlZCh0ZW1wbGF0ZSkgewogICAgaWYgKCF0ZW1wbGF0ZS5zZXRNb2RlbEZuXykgewogICAgICB0ZW1wbGF0ZS5zZXRNb2RlbEZuXyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRlbXBsYXRlLnNldE1vZGVsRm5TY2hlZHVsZWRfID0gZmFsc2U7CiAgICAgICAgdmFyIG1hcCA9IGdldEJpbmRpbmdzKHRlbXBsYXRlLAogICAgICAgICAgICB0ZW1wbGF0ZS5kZWxlZ2F0ZV8gJiYgdGVtcGxhdGUuZGVsZWdhdGVfLnByZXBhcmVCaW5kaW5nKTsKICAgICAgICBwcm9jZXNzQmluZGluZ3ModGVtcGxhdGUsIG1hcCwgdGVtcGxhdGUubW9kZWxfKTsKICAgICAgfTsKICAgIH0KCiAgICBpZiAoIXRlbXBsYXRlLnNldE1vZGVsRm5TY2hlZHVsZWRfKSB7CiAgICAgIHRlbXBsYXRlLnNldE1vZGVsRm5TY2hlZHVsZWRfID0gdHJ1ZTsKICAgICAgT2JzZXJ2ZXIucnVuRU9NXyh0ZW1wbGF0ZS5zZXRNb2RlbEZuXyk7CiAgICB9CiAgfQoKICBtaXhpbihIVE1MVGVtcGxhdGVFbGVtZW50LnByb3RvdHlwZSwgewogICAgYmluZDogZnVuY3Rpb24obmFtZSwgdmFsdWUsIG9uZVRpbWUpIHsKICAgICAgaWYgKG5hbWUgIT0gJ3JlZicpCiAgICAgICAgcmV0dXJuIEVsZW1lbnQucHJvdG90eXBlLmJpbmQuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgb25lVGltZSk7CgogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciByZWYgPSBvbmVUaW1lID8gdmFsdWUgOiB2YWx1ZS5vcGVuKGZ1bmN0aW9uKHJlZikgewogICAgICAgIHNlbGYuc2V0QXR0cmlidXRlKCdyZWYnLCByZWYpOwogICAgICAgIHNlbGYucmVmQ2hhbmdlZF8oKTsKICAgICAgfSk7CgogICAgICB0aGlzLnNldEF0dHJpYnV0ZSgncmVmJywgcmVmKTsKICAgICAgdGhpcy5yZWZDaGFuZ2VkXygpOwogICAgICBpZiAob25lVGltZSkKICAgICAgICByZXR1cm47CgogICAgICBpZiAoIXRoaXMuYmluZGluZ3NfKSB7CiAgICAgICAgdGhpcy5iaW5kaW5nc18gPSB7IHJlZjogdmFsdWUgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmJpbmRpbmdzXy5yZWYgPSB2YWx1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSwKCiAgICBwcm9jZXNzQmluZGluZ0RpcmVjdGl2ZXNfOiBmdW5jdGlvbihkaXJlY3RpdmVzKSB7CiAgICAgIGlmICh0aGlzLml0ZXJhdG9yXykKICAgICAgICB0aGlzLml0ZXJhdG9yXy5jbG9zZURlcHMoKTsKCiAgICAgIGlmICghZGlyZWN0aXZlcy5pZiAmJiAhZGlyZWN0aXZlcy5iaW5kICYmICFkaXJlY3RpdmVzLnJlcGVhdCkgewogICAgICAgIGlmICh0aGlzLml0ZXJhdG9yXykgewogICAgICAgICAgdGhpcy5pdGVyYXRvcl8uY2xvc2UoKTsKICAgICAgICAgIHRoaXMuaXRlcmF0b3JfID0gdW5kZWZpbmVkOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuaXRlcmF0b3JfKSB7CiAgICAgICAgdGhpcy5pdGVyYXRvcl8gPSBuZXcgVGVtcGxhdGVJdGVyYXRvcih0aGlzKTsKICAgICAgfQoKICAgICAgdGhpcy5pdGVyYXRvcl8udXBkYXRlRGVwZW5kZW5jaWVzKGRpcmVjdGl2ZXMsIHRoaXMubW9kZWxfKTsKCiAgICAgIGlmICh0ZW1wbGF0ZU9ic2VydmVyKSB7CiAgICAgICAgdGVtcGxhdGVPYnNlcnZlci5vYnNlcnZlKHRoaXMsIHsgYXR0cmlidXRlczogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVGaWx0ZXI6IFsncmVmJ10gfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLml0ZXJhdG9yXzsKICAgIH0sCgogICAgY3JlYXRlSW5zdGFuY2U6IGZ1bmN0aW9uKG1vZGVsLCBiaW5kaW5nRGVsZWdhdGUsIGRlbGVnYXRlXykgewogICAgICBpZiAoYmluZGluZ0RlbGVnYXRlKQogICAgICAgIGRlbGVnYXRlXyA9IHRoaXMubmV3RGVsZWdhdGVfKGJpbmRpbmdEZWxlZ2F0ZSk7CiAgICAgIGVsc2UgaWYgKCFkZWxlZ2F0ZV8pCiAgICAgICAgZGVsZWdhdGVfID0gdGhpcy5kZWxlZ2F0ZV87CgogICAgICBpZiAoIXRoaXMucmVmQ29udGVudF8pCiAgICAgICAgdGhpcy5yZWZDb250ZW50XyA9IHRoaXMucmVmXy5jb250ZW50OwogICAgICB2YXIgY29udGVudCA9IHRoaXMucmVmQ29udGVudF87CiAgICAgIGlmIChjb250ZW50LmZpcnN0Q2hpbGQgPT09IG51bGwpCiAgICAgICAgcmV0dXJuIGVtcHR5SW5zdGFuY2U7CgogICAgICB2YXIgbWFwID0gZ2V0SW5zdGFuY2VCaW5kaW5nTWFwKGNvbnRlbnQsIGRlbGVnYXRlXyk7CiAgICAgIHZhciBzdGFnaW5nRG9jdW1lbnQgPSBnZXRUZW1wbGF0ZVN0YWdpbmdEb2N1bWVudCh0aGlzKTsKICAgICAgdmFyIGluc3RhbmNlID0gc3RhZ2luZ0RvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgaW5zdGFuY2UudGVtcGxhdGVDcmVhdG9yXyA9IHRoaXM7CiAgICAgIGluc3RhbmNlLnByb3RvQ29udGVudF8gPSBjb250ZW50OwogICAgICBpbnN0YW5jZS5iaW5kaW5nc18gPSBbXTsKICAgICAgaW5zdGFuY2UudGVybWluYXRvcl8gPSBudWxsOwogICAgICB2YXIgaW5zdGFuY2VSZWNvcmQgPSBpbnN0YW5jZS50ZW1wbGF0ZUluc3RhbmNlXyA9IHsKICAgICAgICBmaXJzdE5vZGU6IG51bGwsCiAgICAgICAgbGFzdE5vZGU6IG51bGwsCiAgICAgICAgbW9kZWw6IG1vZGVsCiAgICAgIH07CgogICAgICB2YXIgaSA9IDA7CiAgICAgIHZhciBjb2xsZWN0VGVybWluYXRvciA9IGZhbHNlOwogICAgICBmb3IgKHZhciBjaGlsZCA9IGNvbnRlbnQuZmlyc3RDaGlsZDsgY2hpbGQ7IGNoaWxkID0gY2hpbGQubmV4dFNpYmxpbmcpIHsKICAgICAgICAvLyBUaGUgdGVybWluYXRvciBvZiB0aGUgaW5zdGFuY2UgaXMgdGhlIGNsb25lIG9mIHRoZSBsYXN0IGNoaWxkIG9mIHRoZQogICAgICAgIC8vIGNvbnRlbnQuIElmIHRoZSBsYXN0IGNoaWxkIGlzIGFuIGFjdGl2ZSB0ZW1wbGF0ZSwgaXQgbWF5IHByb2R1Y2UKICAgICAgICAvLyBpbnN0YW5jZXMgYXMgYSByZXN1bHQgb2YgcHJvZHVjdGlvbiwgc28gc2ltcGx5IGNvbGxlY3RpbmcgdGhlIGxhc3QKICAgICAgICAvLyBjaGlsZCBvZiB0aGUgaW5zdGFuY2UgYWZ0ZXIgaXQgaGFzIGZpbmlzaGVkIHByb2R1Y2luZyBtYXkgYmUgd3JvbmcuCiAgICAgICAgaWYgKGNoaWxkLm5leHRTaWJsaW5nID09PSBudWxsKQogICAgICAgICAgY29sbGVjdFRlcm1pbmF0b3IgPSB0cnVlOwoKICAgICAgICB2YXIgY2xvbmUgPSBjbG9uZUFuZEJpbmRJbnN0YW5jZShjaGlsZCwgaW5zdGFuY2UsIHN0YWdpbmdEb2N1bWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAuY2hpbGRyZW5baSsrXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxlZ2F0ZV8sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuYmluZGluZ3NfKTsKICAgICAgICBjbG9uZS50ZW1wbGF0ZUluc3RhbmNlXyA9IGluc3RhbmNlUmVjb3JkOwogICAgICAgIGlmIChjb2xsZWN0VGVybWluYXRvcikKICAgICAgICAgIGluc3RhbmNlLnRlcm1pbmF0b3JfID0gY2xvbmU7CiAgICAgIH0KCiAgICAgIGluc3RhbmNlUmVjb3JkLmZpcnN0Tm9kZSA9IGluc3RhbmNlLmZpcnN0Q2hpbGQ7CiAgICAgIGluc3RhbmNlUmVjb3JkLmxhc3ROb2RlID0gaW5zdGFuY2UubGFzdENoaWxkOwogICAgICBpbnN0YW5jZS50ZW1wbGF0ZUNyZWF0b3JfID0gdW5kZWZpbmVkOwogICAgICBpbnN0YW5jZS5wcm90b0NvbnRlbnRfID0gdW5kZWZpbmVkOwogICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICB9LAoKICAgIGdldCBtb2RlbCgpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxfOwogICAgfSwKCiAgICBzZXQgbW9kZWwobW9kZWwpIHsKICAgICAgdGhpcy5tb2RlbF8gPSBtb2RlbDsKICAgICAgZW5zdXJlU2V0TW9kZWxTY2hlZHVsZWQodGhpcyk7CiAgICB9LAoKICAgIGdldCBiaW5kaW5nRGVsZWdhdGUoKSB7CiAgICAgIHJldHVybiB0aGlzLmRlbGVnYXRlXyAmJiB0aGlzLmRlbGVnYXRlXy5yYXc7CiAgICB9LAoKICAgIHJlZkNoYW5nZWRfOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLml0ZXJhdG9yXyB8fCB0aGlzLnJlZkNvbnRlbnRfID09PSB0aGlzLnJlZl8uY29udGVudCkKICAgICAgICByZXR1cm47CgogICAgICB0aGlzLnJlZkNvbnRlbnRfID0gdW5kZWZpbmVkOwogICAgICB0aGlzLml0ZXJhdG9yXy52YWx1ZUNoYW5nZWQoKTsKICAgICAgdGhpcy5pdGVyYXRvcl8udXBkYXRlSXRlcmF0ZWRWYWx1ZSh0aGlzLml0ZXJhdG9yXy5nZXRVcGRhdGVkVmFsdWUoKSk7CiAgICB9LAoKICAgIGNsZWFyOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5tb2RlbF8gPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuZGVsZWdhdGVfID0gdW5kZWZpbmVkOwogICAgICBpZiAodGhpcy5iaW5kaW5nc18gJiYgdGhpcy5iaW5kaW5nc18ucmVmKQogICAgICAgIHRoaXMuYmluZGluZ3NfLnJlZi5jbG9zZSgpCiAgICAgIHRoaXMucmVmQ29udGVudF8gPSB1bmRlZmluZWQ7CiAgICAgIGlmICghdGhpcy5pdGVyYXRvcl8pCiAgICAgICAgcmV0dXJuOwogICAgICB0aGlzLml0ZXJhdG9yXy52YWx1ZUNoYW5nZWQoKTsKICAgICAgdGhpcy5pdGVyYXRvcl8uY2xvc2UoKQogICAgICB0aGlzLml0ZXJhdG9yXyA9IHVuZGVmaW5lZDsKICAgIH0sCgogICAgc2V0RGVsZWdhdGVfOiBmdW5jdGlvbihkZWxlZ2F0ZSkgewogICAgICB0aGlzLmRlbGVnYXRlXyA9IGRlbGVnYXRlOwogICAgICB0aGlzLmJpbmRpbmdNYXBfID0gdW5kZWZpbmVkOwogICAgICBpZiAodGhpcy5pdGVyYXRvcl8pIHsKICAgICAgICB0aGlzLml0ZXJhdG9yXy5pbnN0YW5jZVBvc2l0aW9uQ2hhbmdlZEZuXyA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLml0ZXJhdG9yXy5pbnN0YW5jZU1vZGVsRm5fID0gdW5kZWZpbmVkOwogICAgICB9CiAgICB9LAoKICAgIG5ld0RlbGVnYXRlXzogZnVuY3Rpb24oYmluZGluZ0RlbGVnYXRlKSB7CiAgICAgIGlmICghYmluZGluZ0RlbGVnYXRlKQogICAgICAgIHJldHVybjsKCiAgICAgIGZ1bmN0aW9uIGRlbGVnYXRlRm4obmFtZSkgewogICAgICAgIHZhciBmbiA9IGJpbmRpbmdEZWxlZ2F0ZSAmJiBiaW5kaW5nRGVsZWdhdGVbbmFtZV07CiAgICAgICAgaWYgKHR5cGVvZiBmbiAhPSAnZnVuY3Rpb24nKQogICAgICAgICAgcmV0dXJuOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gZm4uYXBwbHkoYmluZGluZ0RlbGVnYXRlLCBhcmd1bWVudHMpOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgYmluZGluZ01hcHM6IHt9LAogICAgICAgIHJhdzogYmluZGluZ0RlbGVnYXRlLAogICAgICAgIHByZXBhcmVCaW5kaW5nOiBkZWxlZ2F0ZUZuKCdwcmVwYXJlQmluZGluZycpLAogICAgICAgIHByZXBhcmVJbnN0YW5jZU1vZGVsOiBkZWxlZ2F0ZUZuKCdwcmVwYXJlSW5zdGFuY2VNb2RlbCcpLAogICAgICAgIHByZXBhcmVJbnN0YW5jZVBvc2l0aW9uQ2hhbmdlZDoKICAgICAgICAgICAgZGVsZWdhdGVGbigncHJlcGFyZUluc3RhbmNlUG9zaXRpb25DaGFuZ2VkJykKICAgICAgfTsKICAgIH0sCgogICAgc2V0IGJpbmRpbmdEZWxlZ2F0ZShiaW5kaW5nRGVsZWdhdGUpIHsKICAgICAgaWYgKHRoaXMuZGVsZWdhdGVfKSB7CiAgICAgICAgdGhyb3cgRXJyb3IoJ1RlbXBsYXRlIG11c3QgYmUgY2xlYXJlZCBiZWZvcmUgYSBuZXcgYmluZGluZ0RlbGVnYXRlICcgKwogICAgICAgICAgICAgICAgICAgICdjYW4gYmUgYXNzaWduZWQnKTsKICAgICAgfQoKICAgICAgdGhpcy5zZXREZWxlZ2F0ZV8odGhpcy5uZXdEZWxlZ2F0ZV8oYmluZGluZ0RlbGVnYXRlKSk7CiAgICB9LAoKICAgIGdldCByZWZfKCkgewogICAgICB2YXIgcmVmID0gc2VhcmNoUmVmSWQodGhpcywgdGhpcy5nZXRBdHRyaWJ1dGUoJ3JlZicpKTsKICAgICAgaWYgKCFyZWYpCiAgICAgICAgcmVmID0gdGhpcy5pbnN0YW5jZVJlZl87CgogICAgICBpZiAoIXJlZikKICAgICAgICByZXR1cm4gdGhpczsKCiAgICAgIHZhciBuZXh0UmVmID0gcmVmLnJlZl87CiAgICAgIHJldHVybiBuZXh0UmVmID8gbmV4dFJlZiA6IHJlZjsKICAgIH0KICB9KTsKCiAgLy8gUmV0dXJucwogIC8vICAgYSkgdW5kZWZpbmVkIGlmIHRoZXJlIGFyZSBubyBtdXN0YWNoZXMuCiAgLy8gICBiKSBbVEVYVCwgKE9ORV9USU1FPywgUEFUSCwgREVMRUdBVEVfRk4sIFRFWFQpK10gaWYgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIG11c3RhY2hlLgogIGZ1bmN0aW9uIHBhcnNlTXVzdGFjaGVzKHMsIG5hbWUsIG5vZGUsIHByZXBhcmVCaW5kaW5nRm4pIHsKICAgIGlmICghcyB8fCAhcy5sZW5ndGgpCiAgICAgIHJldHVybjsKCiAgICB2YXIgdG9rZW5zOwogICAgdmFyIGxlbmd0aCA9IHMubGVuZ3RoOwogICAgdmFyIHN0YXJ0SW5kZXggPSAwLCBsYXN0SW5kZXggPSAwLCBlbmRJbmRleCA9IDA7CiAgICB2YXIgb25seU9uZVRpbWUgPSB0cnVlOwogICAgd2hpbGUgKGxhc3RJbmRleCA8IGxlbmd0aCkgewogICAgICB2YXIgc3RhcnRJbmRleCA9IHMuaW5kZXhPZigne3snLCBsYXN0SW5kZXgpOwogICAgICB2YXIgb25lVGltZVN0YXJ0ID0gcy5pbmRleE9mKCdbWycsIGxhc3RJbmRleCk7CiAgICAgIHZhciBvbmVUaW1lID0gZmFsc2U7CiAgICAgIHZhciB0ZXJtaW5hdG9yID0gJ319JzsKCiAgICAgIGlmIChvbmVUaW1lU3RhcnQgPj0gMCAmJgogICAgICAgICAgKHN0YXJ0SW5kZXggPCAwIHx8IG9uZVRpbWVTdGFydCA8IHN0YXJ0SW5kZXgpKSB7CiAgICAgICAgc3RhcnRJbmRleCA9IG9uZVRpbWVTdGFydDsKICAgICAgICBvbmVUaW1lID0gdHJ1ZTsKICAgICAgICB0ZXJtaW5hdG9yID0gJ11dJzsKICAgICAgfQoKICAgICAgZW5kSW5kZXggPSBzdGFydEluZGV4IDwgMCA/IC0xIDogcy5pbmRleE9mKHRlcm1pbmF0b3IsIHN0YXJ0SW5kZXggKyAyKTsKCiAgICAgIGlmIChlbmRJbmRleCA8IDApIHsKICAgICAgICBpZiAoIXRva2VucykKICAgICAgICAgIHJldHVybjsKCiAgICAgICAgdG9rZW5zLnB1c2gocy5zbGljZShsYXN0SW5kZXgpKTsgLy8gVEVYVAogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICB0b2tlbnMgPSB0b2tlbnMgfHwgW107CiAgICAgIHRva2Vucy5wdXNoKHMuc2xpY2UobGFzdEluZGV4LCBzdGFydEluZGV4KSk7IC8vIFRFWFQKICAgICAgdmFyIHBhdGhTdHJpbmcgPSBzLnNsaWNlKHN0YXJ0SW5kZXggKyAyLCBlbmRJbmRleCkudHJpbSgpOwogICAgICB0b2tlbnMucHVzaChvbmVUaW1lKTsgLy8gT05FX1RJTUU/CiAgICAgIG9ubHlPbmVUaW1lID0gb25seU9uZVRpbWUgJiYgb25lVGltZTsKICAgICAgdmFyIGRlbGVnYXRlRm4gPSBwcmVwYXJlQmluZGluZ0ZuICYmCiAgICAgICAgICAgICAgICAgICAgICAgcHJlcGFyZUJpbmRpbmdGbihwYXRoU3RyaW5nLCBuYW1lLCBub2RlKTsKICAgICAgLy8gRG9uJ3QgdHJ5IHRvIHBhcnNlIHRoZSBleHByZXNzaW9uIGlmIHRoZXJlJ3MgYSBwcmVwYXJlQmluZGluZyBmdW5jdGlvbgogICAgICBpZiAoZGVsZWdhdGVGbiA9PSBudWxsKSB7CiAgICAgICAgdG9rZW5zLnB1c2goUGF0aC5nZXQocGF0aFN0cmluZykpOyAvLyBQQVRICiAgICAgIH0gZWxzZSB7CiAgICAgICAgdG9rZW5zLnB1c2gobnVsbCk7CiAgICAgIH0KICAgICAgdG9rZW5zLnB1c2goZGVsZWdhdGVGbik7IC8vIERFTEVHQVRFX0ZOCiAgICAgIGxhc3RJbmRleCA9IGVuZEluZGV4ICsgMjsKICAgIH0KCiAgICBpZiAobGFzdEluZGV4ID09PSBsZW5ndGgpCiAgICAgIHRva2Vucy5wdXNoKCcnKTsgLy8gVEVYVAoKICAgIHRva2Vucy5oYXNPbmVQYXRoID0gdG9rZW5zLmxlbmd0aCA9PT0gNTsKICAgIHRva2Vucy5pc1NpbXBsZVBhdGggPSB0b2tlbnMuaGFzT25lUGF0aCAmJgogICAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vuc1swXSA9PSAnJyAmJgogICAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vuc1s0XSA9PSAnJzsKICAgIHRva2Vucy5vbmx5T25lVGltZSA9IG9ubHlPbmVUaW1lOwoKICAgIHRva2Vucy5jb21iaW5hdG9yID0gZnVuY3Rpb24odmFsdWVzKSB7CiAgICAgIHZhciBuZXdWYWx1ZSA9IHRva2Vuc1swXTsKCiAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSArPSA0KSB7CiAgICAgICAgdmFyIHZhbHVlID0gdG9rZW5zLmhhc09uZVBhdGggPyB2YWx1ZXMgOiB2YWx1ZXNbKGkgLSAxKSAvIDRdOwogICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgbmV3VmFsdWUgKz0gdmFsdWU7CiAgICAgICAgbmV3VmFsdWUgKz0gdG9rZW5zW2kgKyAzXTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5ld1ZhbHVlOwogICAgfQoKICAgIHJldHVybiB0b2tlbnM7CiAgfTsKCiAgZnVuY3Rpb24gcHJvY2Vzc09uZVRpbWVCaW5kaW5nKG5hbWUsIHRva2Vucywgbm9kZSwgbW9kZWwpIHsKICAgIGlmICh0b2tlbnMuaGFzT25lUGF0aCkgewogICAgICB2YXIgZGVsZWdhdGVGbiA9IHRva2Vuc1szXTsKICAgICAgdmFyIHZhbHVlID0gZGVsZWdhdGVGbiA/IGRlbGVnYXRlRm4obW9kZWwsIG5vZGUsIHRydWUpIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vuc1syXS5nZXRWYWx1ZUZyb20obW9kZWwpOwogICAgICByZXR1cm4gdG9rZW5zLmlzU2ltcGxlUGF0aCA/IHZhbHVlIDogdG9rZW5zLmNvbWJpbmF0b3IodmFsdWUpOwogICAgfQoKICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSArPSA0KSB7CiAgICAgIHZhciBkZWxlZ2F0ZUZuID0gdG9rZW5zW2kgKyAyXTsKICAgICAgdmFsdWVzWyhpIC0gMSkgLyA0XSA9IGRlbGVnYXRlRm4gPyBkZWxlZ2F0ZUZuKG1vZGVsLCBub2RlKSA6CiAgICAgICAgICB0b2tlbnNbaSArIDFdLmdldFZhbHVlRnJvbShtb2RlbCk7CiAgICB9CgogICAgcmV0dXJuIHRva2Vucy5jb21iaW5hdG9yKHZhbHVlcyk7CiAgfQoKICBmdW5jdGlvbiBwcm9jZXNzU2luZ2xlUGF0aEJpbmRpbmcobmFtZSwgdG9rZW5zLCBub2RlLCBtb2RlbCkgewogICAgdmFyIGRlbGVnYXRlRm4gPSB0b2tlbnNbM107CiAgICB2YXIgb2JzZXJ2ZXIgPSBkZWxlZ2F0ZUZuID8gZGVsZWdhdGVGbihtb2RlbCwgbm9kZSwgZmFsc2UpIDoKICAgICAgICBuZXcgUGF0aE9ic2VydmVyKG1vZGVsLCB0b2tlbnNbMl0pOwoKICAgIHJldHVybiB0b2tlbnMuaXNTaW1wbGVQYXRoID8gb2JzZXJ2ZXIgOgogICAgICAgIG5ldyBPYnNlcnZlclRyYW5zZm9ybShvYnNlcnZlciwgdG9rZW5zLmNvbWJpbmF0b3IpOwogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc0JpbmRpbmcobmFtZSwgdG9rZW5zLCBub2RlLCBtb2RlbCkgewogICAgaWYgKHRva2Vucy5vbmx5T25lVGltZSkKICAgICAgcmV0dXJuIHByb2Nlc3NPbmVUaW1lQmluZGluZyhuYW1lLCB0b2tlbnMsIG5vZGUsIG1vZGVsKTsKCiAgICBpZiAodG9rZW5zLmhhc09uZVBhdGgpCiAgICAgIHJldHVybiBwcm9jZXNzU2luZ2xlUGF0aEJpbmRpbmcobmFtZSwgdG9rZW5zLCBub2RlLCBtb2RlbCk7CgogICAgdmFyIG9ic2VydmVyID0gbmV3IENvbXBvdW5kT2JzZXJ2ZXIoKTsKCiAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRva2Vucy5sZW5ndGg7IGkgKz0gNCkgewogICAgICB2YXIgb25lVGltZSA9IHRva2Vuc1tpXTsKICAgICAgdmFyIGRlbGVnYXRlRm4gPSB0b2tlbnNbaSArIDJdOwoKICAgICAgaWYgKGRlbGVnYXRlRm4pIHsKICAgICAgICB2YXIgdmFsdWUgPSBkZWxlZ2F0ZUZuKG1vZGVsLCBub2RlLCBvbmVUaW1lKTsKICAgICAgICBpZiAob25lVGltZSkKICAgICAgICAgIG9ic2VydmVyLmFkZFBhdGgodmFsdWUpCiAgICAgICAgZWxzZQogICAgICAgICAgb2JzZXJ2ZXIuYWRkT2JzZXJ2ZXIodmFsdWUpOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICB2YXIgcGF0aCA9IHRva2Vuc1tpICsgMV07CiAgICAgIGlmIChvbmVUaW1lKQogICAgICAgIG9ic2VydmVyLmFkZFBhdGgocGF0aC5nZXRWYWx1ZUZyb20obW9kZWwpKQogICAgICBlbHNlCiAgICAgICAgb2JzZXJ2ZXIuYWRkUGF0aChtb2RlbCwgcGF0aCk7CiAgICB9CgogICAgcmV0dXJuIG5ldyBPYnNlcnZlclRyYW5zZm9ybShvYnNlcnZlciwgdG9rZW5zLmNvbWJpbmF0b3IpOwogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc0JpbmRpbmdzKG5vZGUsIGJpbmRpbmdzLCBtb2RlbCwgaW5zdGFuY2VCaW5kaW5ncykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBiaW5kaW5ncy5sZW5ndGg7IGkgKz0gMikgewogICAgICB2YXIgbmFtZSA9IGJpbmRpbmdzW2ldCiAgICAgIHZhciB0b2tlbnMgPSBiaW5kaW5nc1tpICsgMV07CiAgICAgIHZhciB2YWx1ZSA9IHByb2Nlc3NCaW5kaW5nKG5hbWUsIHRva2Vucywgbm9kZSwgbW9kZWwpOwogICAgICB2YXIgYmluZGluZyA9IG5vZGUuYmluZChuYW1lLCB2YWx1ZSwgdG9rZW5zLm9ubHlPbmVUaW1lKTsKICAgICAgaWYgKGJpbmRpbmcgJiYgaW5zdGFuY2VCaW5kaW5ncykKICAgICAgICBpbnN0YW5jZUJpbmRpbmdzLnB1c2goYmluZGluZyk7CiAgICB9CgogICAgbm9kZS5iaW5kRmluaXNoZWQoKTsKICAgIGlmICghYmluZGluZ3MuaXNUZW1wbGF0ZSkKICAgICAgcmV0dXJuOwoKICAgIG5vZGUubW9kZWxfID0gbW9kZWw7CiAgICB2YXIgaXRlciA9IG5vZGUucHJvY2Vzc0JpbmRpbmdEaXJlY3RpdmVzXyhiaW5kaW5ncyk7CiAgICBpZiAoaW5zdGFuY2VCaW5kaW5ncyAmJiBpdGVyKQogICAgICBpbnN0YW5jZUJpbmRpbmdzLnB1c2goaXRlcik7CiAgfQoKICBmdW5jdGlvbiBwYXJzZVdpdGhEZWZhdWx0KGVsLCBuYW1lLCBwcmVwYXJlQmluZGluZ0ZuKSB7CiAgICB2YXIgdiA9IGVsLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgIHJldHVybiBwYXJzZU11c3RhY2hlcyh2ID09ICcnID8gJ3t7fX0nIDogdiwgbmFtZSwgZWwsIHByZXBhcmVCaW5kaW5nRm4pOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VBdHRyaWJ1dGVCaW5kaW5ncyhlbGVtZW50LCBwcmVwYXJlQmluZGluZ0ZuKSB7CiAgICBhc3NlcnQoZWxlbWVudCk7CgogICAgdmFyIGJpbmRpbmdzID0gW107CiAgICB2YXIgaWZGb3VuZCA9IGZhbHNlOwogICAgdmFyIGJpbmRGb3VuZCA9IGZhbHNlOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudC5hdHRyaWJ1dGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBhdHRyID0gZWxlbWVudC5hdHRyaWJ1dGVzW2ldOwogICAgICB2YXIgbmFtZSA9IGF0dHIubmFtZTsKICAgICAgdmFyIHZhbHVlID0gYXR0ci52YWx1ZTsKCiAgICAgIC8vIEFsbG93IGJpbmRpbmdzIGV4cHJlc3NlZCBpbiBhdHRyaWJ1dGVzIHRvIGJlIHByZWZpeGVkIHdpdGggdW5kZXJiYXJzLgogICAgICAvLyBXZSBkbyB0aGlzIHRvIGFsbG93IGNvcnJlY3Qgc2VtYW50aWNzIGZvciBicm93c2VycyB0aGF0IGRvbid0IGltcGxlbWVudAogICAgICAvLyA8dGVtcGxhdGU+IHdoZXJlIGNlcnRhaW4gYXR0cmlidXRlcyBtaWdodCB0cmlnZ2VyIHNpZGUtZWZmZWN0cyAtLSBhbmQKICAgICAgLy8gZm9yIElFIHdoaWNoIHNhbml0aXplcyBjZXJ0YWluIGF0dHJpYnV0ZXMsIGRpc2FsbG93aW5nIG11c3RhY2hlCiAgICAgIC8vIHJlcGxhY2VtZW50cyBpbiB0aGVpciB0ZXh0LgogICAgICB3aGlsZSAobmFtZVswXSA9PT0gJ18nKSB7CiAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyaW5nKDEpOwogICAgICB9CgogICAgICBpZiAoaXNUZW1wbGF0ZShlbGVtZW50KSAmJgogICAgICAgICAgKG5hbWUgPT09IElGIHx8IG5hbWUgPT09IEJJTkQgfHwgbmFtZSA9PT0gUkVQRUFUKSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICB2YXIgdG9rZW5zID0gcGFyc2VNdXN0YWNoZXModmFsdWUsIG5hbWUsIGVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVwYXJlQmluZGluZ0ZuKTsKICAgICAgaWYgKCF0b2tlbnMpCiAgICAgICAgY29udGludWU7CgogICAgICBiaW5kaW5ncy5wdXNoKG5hbWUsIHRva2Vucyk7CiAgICB9CgogICAgaWYgKGlzVGVtcGxhdGUoZWxlbWVudCkpIHsKICAgICAgYmluZGluZ3MuaXNUZW1wbGF0ZSA9IHRydWU7CiAgICAgIGJpbmRpbmdzLmlmID0gcGFyc2VXaXRoRGVmYXVsdChlbGVtZW50LCBJRiwgcHJlcGFyZUJpbmRpbmdGbik7CiAgICAgIGJpbmRpbmdzLmJpbmQgPSBwYXJzZVdpdGhEZWZhdWx0KGVsZW1lbnQsIEJJTkQsIHByZXBhcmVCaW5kaW5nRm4pOwogICAgICBiaW5kaW5ncy5yZXBlYXQgPSBwYXJzZVdpdGhEZWZhdWx0KGVsZW1lbnQsIFJFUEVBVCwgcHJlcGFyZUJpbmRpbmdGbik7CgogICAgICBpZiAoYmluZGluZ3MuaWYgJiYgIWJpbmRpbmdzLmJpbmQgJiYgIWJpbmRpbmdzLnJlcGVhdCkKICAgICAgICBiaW5kaW5ncy5iaW5kID0gcGFyc2VNdXN0YWNoZXMoJ3t7fX0nLCBCSU5ELCBlbGVtZW50LCBwcmVwYXJlQmluZGluZ0ZuKTsKICAgIH0KCiAgICByZXR1cm4gYmluZGluZ3M7CiAgfQoKICBmdW5jdGlvbiBnZXRCaW5kaW5ncyhub2RlLCBwcmVwYXJlQmluZGluZ0ZuKSB7CiAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpCiAgICAgIHJldHVybiBwYXJzZUF0dHJpYnV0ZUJpbmRpbmdzKG5vZGUsIHByZXBhcmVCaW5kaW5nRm4pOwoKICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBOb2RlLlRFWFRfTk9ERSkgewogICAgICB2YXIgdG9rZW5zID0gcGFyc2VNdXN0YWNoZXMobm9kZS5kYXRhLCAndGV4dENvbnRlbnQnLCBub2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlcGFyZUJpbmRpbmdGbik7CiAgICAgIGlmICh0b2tlbnMpCiAgICAgICAgcmV0dXJuIFsndGV4dENvbnRlbnQnLCB0b2tlbnNdOwogICAgfQoKICAgIHJldHVybiBbXTsKICB9CgogIGZ1bmN0aW9uIGNsb25lQW5kQmluZEluc3RhbmNlKG5vZGUsIHBhcmVudCwgc3RhZ2luZ0RvY3VtZW50LCBiaW5kaW5ncywgbW9kZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZWdhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VCaW5kaW5ncywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZVJlY29yZCkgewogICAgdmFyIGNsb25lID0gcGFyZW50LmFwcGVuZENoaWxkKHN0YWdpbmdEb2N1bWVudC5pbXBvcnROb2RlKG5vZGUsIGZhbHNlKSk7CgogICAgdmFyIGkgPSAwOwogICAgZm9yICh2YXIgY2hpbGQgPSBub2RlLmZpcnN0Q2hpbGQ7IGNoaWxkOyBjaGlsZCA9IGNoaWxkLm5leHRTaWJsaW5nKSB7CiAgICAgIGNsb25lQW5kQmluZEluc3RhbmNlKGNoaWxkLCBjbG9uZSwgc3RhZ2luZ0RvY3VtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MuY2hpbGRyZW5baSsrXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZWdhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZUJpbmRpbmdzKTsKICAgIH0KCiAgICBpZiAoYmluZGluZ3MuaXNUZW1wbGF0ZSkgewogICAgICBIVE1MVGVtcGxhdGVFbGVtZW50LmRlY29yYXRlKGNsb25lLCBub2RlKTsKICAgICAgaWYgKGRlbGVnYXRlKQogICAgICAgIGNsb25lLnNldERlbGVnYXRlXyhkZWxlZ2F0ZSk7CiAgICB9CgogICAgcHJvY2Vzc0JpbmRpbmdzKGNsb25lLCBiaW5kaW5ncywgbW9kZWwsIGluc3RhbmNlQmluZGluZ3MpOwogICAgcmV0dXJuIGNsb25lOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlSW5zdGFuY2VCaW5kaW5nTWFwKG5vZGUsIHByZXBhcmVCaW5kaW5nRm4pIHsKICAgIHZhciBtYXAgPSBnZXRCaW5kaW5ncyhub2RlLCBwcmVwYXJlQmluZGluZ0ZuKTsKICAgIG1hcC5jaGlsZHJlbiA9IHt9OwogICAgdmFyIGluZGV4ID0gMDsKICAgIGZvciAodmFyIGNoaWxkID0gbm9kZS5maXJzdENoaWxkOyBjaGlsZDsgY2hpbGQgPSBjaGlsZC5uZXh0U2libGluZykgewogICAgICBtYXAuY2hpbGRyZW5baW5kZXgrK10gPSBjcmVhdGVJbnN0YW5jZUJpbmRpbmdNYXAoY2hpbGQsIHByZXBhcmVCaW5kaW5nRm4pOwogICAgfQoKICAgIHJldHVybiBtYXA7CiAgfQoKICB2YXIgY29udGVudFVpZENvdW50ZXIgPSAxOwoKICAvLyBUT0RPKHJhZmFlbHcpOiBTZXR1cCBhIE11dGF0aW9uT2JzZXJ2ZXIgb24gY29udGVudCB3aGljaCBjbGVhcnMgdGhlIGlkCiAgLy8gc28gdGhhdCBiaW5kaW5nTWFwcyByZWdlbmVyYXRlIHdoZW4gdGhlIHRlbXBsYXRlLmNvbnRlbnQgY2hhbmdlcy4KICBmdW5jdGlvbiBnZXRDb250ZW50VWlkKGNvbnRlbnQpIHsKICAgIHZhciBpZCA9IGNvbnRlbnQuaWRfOwogICAgaWYgKCFpZCkKICAgICAgaWQgPSBjb250ZW50LmlkXyA9IGNvbnRlbnRVaWRDb3VudGVyKys7CiAgICByZXR1cm4gaWQ7CiAgfQoKICAvLyBFYWNoIGRlbGVnYXRlIGlzIGFzc29jaWF0ZWQgd2l0aCBhIHNldCBvZiBiaW5kaW5nTWFwcywgb25lIGZvciBlYWNoCiAgLy8gY29udGVudCB3aGljaCBtYXkgYmUgdXNlZCBieSBhIHRlbXBsYXRlLiBUaGUgaW50ZW50IGlzIHRoYXQgZWFjaCBiaW5kaW5nCiAgLy8gZGVsZWdhdGUgZ2V0cyB0aGUgb3Bwb3J0dW5pdHkgdG8gcHJlcGFyZSB0aGUgaW5zdGFuY2UgKHZpYSB0aGUgcHJlcGFyZSoKICAvLyBkZWxlZ2F0ZSBjYWxscykgb25jZSBhY3Jvc3MgYWxsIHVzZXMuCiAgLy8gVE9ETyhyYWZhZWx3KTogU2VwYXJhdGUgb3V0IHRoZSBwYXJzZSBtYXAgZnJvbSB0aGUgYmluZGluZyBtYXAuIEluIHRoZQogIC8vIGN1cnJlbnQgaW1wbGVtZW50YXRpb24sIGlmIHR3byBkZWxlZ2F0ZXMgbmVlZCBhIGJpbmRpbmcgbWFwIGZvciB0aGUgc2FtZQogIC8vIGNvbnRlbnQsIHRoZSBzZWNvbmQgd2lsbCBoYXZlIHRvIHJlcGFyc2UuCiAgZnVuY3Rpb24gZ2V0SW5zdGFuY2VCaW5kaW5nTWFwKGNvbnRlbnQsIGRlbGVnYXRlXykgewogICAgdmFyIGNvbnRlbnRJZCA9IGdldENvbnRlbnRVaWQoY29udGVudCk7CiAgICBpZiAoZGVsZWdhdGVfKSB7CiAgICAgIHZhciBtYXAgPSBkZWxlZ2F0ZV8uYmluZGluZ01hcHNbY29udGVudElkXTsKICAgICAgaWYgKCFtYXApIHsKICAgICAgICBtYXAgPSBkZWxlZ2F0ZV8uYmluZGluZ01hcHNbY29udGVudElkXSA9CiAgICAgICAgICAgIGNyZWF0ZUluc3RhbmNlQmluZGluZ01hcChjb250ZW50LCBkZWxlZ2F0ZV8ucHJlcGFyZUJpbmRpbmcpIHx8IFtdOwogICAgICB9CiAgICAgIHJldHVybiBtYXA7CiAgICB9CgogICAgdmFyIG1hcCA9IGNvbnRlbnQuYmluZGluZ01hcF87CiAgICBpZiAoIW1hcCkgewogICAgICBtYXAgPSBjb250ZW50LmJpbmRpbmdNYXBfID0KICAgICAgICAgIGNyZWF0ZUluc3RhbmNlQmluZGluZ01hcChjb250ZW50LCB1bmRlZmluZWQpIHx8IFtdOwogICAgfQogICAgcmV0dXJuIG1hcDsKICB9CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShOb2RlLnByb3RvdHlwZSwgJ3RlbXBsYXRlSW5zdGFuY2UnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaW5zdGFuY2UgPSB0aGlzLnRlbXBsYXRlSW5zdGFuY2VfOwogICAgICByZXR1cm4gaW5zdGFuY2UgPyBpbnN0YW5jZSA6CiAgICAgICAgICAodGhpcy5wYXJlbnROb2RlID8gdGhpcy5wYXJlbnROb2RlLnRlbXBsYXRlSW5zdGFuY2UgOiB1bmRlZmluZWQpOwogICAgfQogIH0pOwoKICB2YXIgZW1wdHlJbnN0YW5jZSA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICBlbXB0eUluc3RhbmNlLmJpbmRpbmdzXyA9IFtdOwogIGVtcHR5SW5zdGFuY2UudGVybWluYXRvcl8gPSBudWxsOwoKICBmdW5jdGlvbiBUZW1wbGF0ZUl0ZXJhdG9yKHRlbXBsYXRlRWxlbWVudCkgewogICAgdGhpcy5jbG9zZWQgPSBmYWxzZTsKICAgIHRoaXMudGVtcGxhdGVFbGVtZW50XyA9IHRlbXBsYXRlRWxlbWVudDsKICAgIHRoaXMuaW5zdGFuY2VzID0gW107CiAgICB0aGlzLmRlcHMgPSB1bmRlZmluZWQ7CiAgICB0aGlzLml0ZXJhdGVkVmFsdWUgPSBbXTsKICAgIHRoaXMucHJlc2VudFZhbHVlID0gdW5kZWZpbmVkOwogICAgdGhpcy5hcnJheU9ic2VydmVyID0gdW5kZWZpbmVkOwogIH0KCiAgVGVtcGxhdGVJdGVyYXRvci5wcm90b3R5cGUgPSB7CiAgICBjbG9zZURlcHM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZGVwcyA9IHRoaXMuZGVwczsKICAgICAgaWYgKGRlcHMpIHsKICAgICAgICBpZiAoZGVwcy5pZk9uZVRpbWUgPT09IGZhbHNlKQogICAgICAgICAgZGVwcy5pZlZhbHVlLmNsb3NlKCk7CiAgICAgICAgaWYgKGRlcHMub25lVGltZSA9PT0gZmFsc2UpCiAgICAgICAgICBkZXBzLnZhbHVlLmNsb3NlKCk7CiAgICAgIH0KICAgIH0sCgogICAgdXBkYXRlRGVwZW5kZW5jaWVzOiBmdW5jdGlvbihkaXJlY3RpdmVzLCBtb2RlbCkgewogICAgICB0aGlzLmNsb3NlRGVwcygpOwoKICAgICAgdmFyIGRlcHMgPSB0aGlzLmRlcHMgPSB7fTsKICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy50ZW1wbGF0ZUVsZW1lbnRfOwoKICAgICAgdmFyIGlmVmFsdWUgPSB0cnVlOwogICAgICBpZiAoZGlyZWN0aXZlcy5pZikgewogICAgICAgIGRlcHMuaGFzSWYgPSB0cnVlOwogICAgICAgIGRlcHMuaWZPbmVUaW1lID0gZGlyZWN0aXZlcy5pZi5vbmx5T25lVGltZTsKICAgICAgICBkZXBzLmlmVmFsdWUgPSBwcm9jZXNzQmluZGluZyhJRiwgZGlyZWN0aXZlcy5pZiwgdGVtcGxhdGUsIG1vZGVsKTsKCiAgICAgICAgaWZWYWx1ZSA9IGRlcHMuaWZWYWx1ZTsKCiAgICAgICAgLy8gb25lVGltZSBpZiAmIHByZWRpY2F0ZSBpcyBmYWxzZS4gbm90aGluZyBlbHNlIHRvIGRvLgogICAgICAgIGlmIChkZXBzLmlmT25lVGltZSAmJiAhaWZWYWx1ZSkgewogICAgICAgICAgdGhpcy52YWx1ZUNoYW5nZWQoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICghZGVwcy5pZk9uZVRpbWUpCiAgICAgICAgICBpZlZhbHVlID0gaWZWYWx1ZS5vcGVuKHRoaXMudXBkYXRlSWZWYWx1ZSwgdGhpcyk7CiAgICAgIH0KCiAgICAgIGlmIChkaXJlY3RpdmVzLnJlcGVhdCkgewogICAgICAgIGRlcHMucmVwZWF0ID0gdHJ1ZTsKICAgICAgICBkZXBzLm9uZVRpbWUgPSBkaXJlY3RpdmVzLnJlcGVhdC5vbmx5T25lVGltZTsKICAgICAgICBkZXBzLnZhbHVlID0gcHJvY2Vzc0JpbmRpbmcoUkVQRUFULCBkaXJlY3RpdmVzLnJlcGVhdCwgdGVtcGxhdGUsIG1vZGVsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZXBzLnJlcGVhdCA9IGZhbHNlOwogICAgICAgIGRlcHMub25lVGltZSA9IGRpcmVjdGl2ZXMuYmluZC5vbmx5T25lVGltZTsKICAgICAgICBkZXBzLnZhbHVlID0gcHJvY2Vzc0JpbmRpbmcoQklORCwgZGlyZWN0aXZlcy5iaW5kLCB0ZW1wbGF0ZSwgbW9kZWwpOwogICAgICB9CgogICAgICB2YXIgdmFsdWUgPSBkZXBzLnZhbHVlOwogICAgICBpZiAoIWRlcHMub25lVGltZSkKICAgICAgICB2YWx1ZSA9IHZhbHVlLm9wZW4odGhpcy51cGRhdGVJdGVyYXRlZFZhbHVlLCB0aGlzKTsKCiAgICAgIGlmICghaWZWYWx1ZSkgewogICAgICAgIHRoaXMudmFsdWVDaGFuZ2VkKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLnVwZGF0ZVZhbHVlKHZhbHVlKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSB1cGRhdGVkIHZhbHVlIG9mIHRoZSBiaW5kL3JlcGVhdC4gVGhpcyBjYW4gcG90ZW50aWFsbHkgY2FsbAogICAgICogdXNlciBjb2RlIChpZiBhIGJpbmRpbmdEZWxlZ2F0ZSBpcyBzZXQgdXApIHNvIHdlIHRyeSB0byBhdm9pZCBpdCBpZiB3ZQogICAgICogYWxyZWFkeSBoYXZlIHRoZSB2YWx1ZSBpbiBoYW5kIChmcm9tIE9ic2VydmVyLm9wZW4pLgogICAgICovCiAgICBnZXRVcGRhdGVkVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmFsdWUgPSB0aGlzLmRlcHMudmFsdWU7CiAgICAgIGlmICghdGhpcy5kZXBzLm9uZVRpbWUpCiAgICAgICAgdmFsdWUgPSB2YWx1ZS5kaXNjYXJkQ2hhbmdlcygpOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9LAoKICAgIHVwZGF0ZUlmVmFsdWU6IGZ1bmN0aW9uKGlmVmFsdWUpIHsKICAgICAgaWYgKCFpZlZhbHVlKSB7CiAgICAgICAgdGhpcy52YWx1ZUNoYW5nZWQoKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMudXBkYXRlVmFsdWUodGhpcy5nZXRVcGRhdGVkVmFsdWUoKSk7CiAgICB9LAoKICAgIHVwZGF0ZUl0ZXJhdGVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0aGlzLmRlcHMuaGFzSWYpIHsKICAgICAgICB2YXIgaWZWYWx1ZSA9IHRoaXMuZGVwcy5pZlZhbHVlOwogICAgICAgIGlmICghdGhpcy5kZXBzLmlmT25lVGltZSkKICAgICAgICAgIGlmVmFsdWUgPSBpZlZhbHVlLmRpc2NhcmRDaGFuZ2VzKCk7CiAgICAgICAgaWYgKCFpZlZhbHVlKSB7CiAgICAgICAgICB0aGlzLnZhbHVlQ2hhbmdlZCgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy51cGRhdGVWYWx1ZSh2YWx1ZSk7CiAgICB9LAoKICAgIHVwZGF0ZVZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoIXRoaXMuZGVwcy5yZXBlYXQpCiAgICAgICAgdmFsdWUgPSBbdmFsdWVdOwogICAgICB2YXIgb2JzZXJ2ZSA9IHRoaXMuZGVwcy5yZXBlYXQgJiYKICAgICAgICAgICAgICAgICAgICAhdGhpcy5kZXBzLm9uZVRpbWUgJiYKICAgICAgICAgICAgICAgICAgICBBcnJheS5pc0FycmF5KHZhbHVlKTsKICAgICAgdGhpcy52YWx1ZUNoYW5nZWQodmFsdWUsIG9ic2VydmUpOwogICAgfSwKCiAgICB2YWx1ZUNoYW5nZWQ6IGZ1bmN0aW9uKHZhbHVlLCBvYnNlcnZlVmFsdWUpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlKSkKICAgICAgICB2YWx1ZSA9IFtdOwoKICAgICAgaWYgKHZhbHVlID09PSB0aGlzLml0ZXJhdGVkVmFsdWUpCiAgICAgICAgcmV0dXJuOwoKICAgICAgdGhpcy51bm9ic2VydmUoKTsKICAgICAgdGhpcy5wcmVzZW50VmFsdWUgPSB2YWx1ZTsKICAgICAgaWYgKG9ic2VydmVWYWx1ZSkgewogICAgICAgIHRoaXMuYXJyYXlPYnNlcnZlciA9IG5ldyBBcnJheU9ic2VydmVyKHRoaXMucHJlc2VudFZhbHVlKTsKICAgICAgICB0aGlzLmFycmF5T2JzZXJ2ZXIub3Blbih0aGlzLmhhbmRsZVNwbGljZXMsIHRoaXMpOwogICAgICB9CgogICAgICB0aGlzLmhhbmRsZVNwbGljZXMoQXJyYXlPYnNlcnZlci5jYWxjdWxhdGVTcGxpY2VzKHRoaXMucHJlc2VudFZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlcmF0ZWRWYWx1ZSkpOwogICAgfSwKCiAgICBnZXRMYXN0SW5zdGFuY2VOb2RlOiBmdW5jdGlvbihpbmRleCkgewogICAgICBpZiAoaW5kZXggPT0gLTEpCiAgICAgICAgcmV0dXJuIHRoaXMudGVtcGxhdGVFbGVtZW50XzsKICAgICAgdmFyIGluc3RhbmNlID0gdGhpcy5pbnN0YW5jZXNbaW5kZXhdOwogICAgICB2YXIgdGVybWluYXRvciA9IGluc3RhbmNlLnRlcm1pbmF0b3JfOwogICAgICBpZiAoIXRlcm1pbmF0b3IpCiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TGFzdEluc3RhbmNlTm9kZShpbmRleCAtIDEpOwoKICAgICAgaWYgKHRlcm1pbmF0b3Iubm9kZVR5cGUgIT09IE5vZGUuRUxFTUVOVF9OT0RFIHx8CiAgICAgICAgICB0aGlzLnRlbXBsYXRlRWxlbWVudF8gPT09IHRlcm1pbmF0b3IpIHsKICAgICAgICByZXR1cm4gdGVybWluYXRvcjsKICAgICAgfQoKICAgICAgdmFyIHN1YnRlbXBsYXRlSXRlcmF0b3IgPSB0ZXJtaW5hdG9yLml0ZXJhdG9yXzsKICAgICAgaWYgKCFzdWJ0ZW1wbGF0ZUl0ZXJhdG9yKQogICAgICAgIHJldHVybiB0ZXJtaW5hdG9yOwoKICAgICAgcmV0dXJuIHN1YnRlbXBsYXRlSXRlcmF0b3IuZ2V0TGFzdFRlbXBsYXRlTm9kZSgpOwogICAgfSwKCiAgICBnZXRMYXN0VGVtcGxhdGVOb2RlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0TGFzdEluc3RhbmNlTm9kZSh0aGlzLmluc3RhbmNlcy5sZW5ndGggLSAxKTsKICAgIH0sCgogICAgaW5zZXJ0SW5zdGFuY2VBdDogZnVuY3Rpb24oaW5kZXgsIGZyYWdtZW50KSB7CiAgICAgIHZhciBwcmV2aW91c0luc3RhbmNlTGFzdCA9IHRoaXMuZ2V0TGFzdEluc3RhbmNlTm9kZShpbmRleCAtIDEpOwogICAgICB2YXIgcGFyZW50ID0gdGhpcy50ZW1wbGF0ZUVsZW1lbnRfLnBhcmVudE5vZGU7CiAgICAgIHRoaXMuaW5zdGFuY2VzLnNwbGljZShpbmRleCwgMCwgZnJhZ21lbnQpOwoKICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShmcmFnbWVudCwgcHJldmlvdXNJbnN0YW5jZUxhc3QubmV4dFNpYmxpbmcpOwogICAgfSwKCiAgICBleHRyYWN0SW5zdGFuY2VBdDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgdmFyIHByZXZpb3VzSW5zdGFuY2VMYXN0ID0gdGhpcy5nZXRMYXN0SW5zdGFuY2VOb2RlKGluZGV4IC0gMSk7CiAgICAgIHZhciBsYXN0Tm9kZSA9IHRoaXMuZ2V0TGFzdEluc3RhbmNlTm9kZShpbmRleCk7CiAgICAgIHZhciBwYXJlbnQgPSB0aGlzLnRlbXBsYXRlRWxlbWVudF8ucGFyZW50Tm9kZTsKICAgICAgdmFyIGluc3RhbmNlID0gdGhpcy5pbnN0YW5jZXMuc3BsaWNlKGluZGV4LCAxKVswXTsKCiAgICAgIHdoaWxlIChsYXN0Tm9kZSAhPT0gcHJldmlvdXNJbnN0YW5jZUxhc3QpIHsKICAgICAgICB2YXIgbm9kZSA9IHByZXZpb3VzSW5zdGFuY2VMYXN0Lm5leHRTaWJsaW5nOwogICAgICAgIGlmIChub2RlID09IGxhc3ROb2RlKQogICAgICAgICAgbGFzdE5vZGUgPSBwcmV2aW91c0luc3RhbmNlTGFzdDsKCiAgICAgICAgaW5zdGFuY2UuYXBwZW5kQ2hpbGQocGFyZW50LnJlbW92ZUNoaWxkKG5vZGUpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgfSwKCiAgICBnZXREZWxlZ2F0ZUZuOiBmdW5jdGlvbihmbikgewogICAgICBmbiA9IGZuICYmIGZuKHRoaXMudGVtcGxhdGVFbGVtZW50Xyk7CiAgICAgIHJldHVybiB0eXBlb2YgZm4gPT09ICdmdW5jdGlvbicgPyBmbiA6IG51bGw7CiAgICB9LAoKICAgIGhhbmRsZVNwbGljZXM6IGZ1bmN0aW9uKHNwbGljZXMpIHsKICAgICAgaWYgKHRoaXMuY2xvc2VkIHx8ICFzcGxpY2VzLmxlbmd0aCkKICAgICAgICByZXR1cm47CgogICAgICB2YXIgdGVtcGxhdGUgPSB0aGlzLnRlbXBsYXRlRWxlbWVudF87CgogICAgICBpZiAoIXRlbXBsYXRlLnBhcmVudE5vZGUpIHsKICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBBcnJheU9ic2VydmVyLmFwcGx5U3BsaWNlcyh0aGlzLml0ZXJhdGVkVmFsdWUsIHRoaXMucHJlc2VudFZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGxpY2VzKTsKCiAgICAgIHZhciBkZWxlZ2F0ZSA9IHRlbXBsYXRlLmRlbGVnYXRlXzsKICAgICAgaWYgKHRoaXMuaW5zdGFuY2VNb2RlbEZuXyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5pbnN0YW5jZU1vZGVsRm5fID0KICAgICAgICAgICAgdGhpcy5nZXREZWxlZ2F0ZUZuKGRlbGVnYXRlICYmIGRlbGVnYXRlLnByZXBhcmVJbnN0YW5jZU1vZGVsKTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuaW5zdGFuY2VQb3NpdGlvbkNoYW5nZWRGbl8gPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuaW5zdGFuY2VQb3NpdGlvbkNoYW5nZWRGbl8gPQogICAgICAgICAgICB0aGlzLmdldERlbGVnYXRlRm4oZGVsZWdhdGUgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGVnYXRlLnByZXBhcmVJbnN0YW5jZVBvc2l0aW9uQ2hhbmdlZCk7CiAgICAgIH0KCiAgICAgIC8vIEluc3RhbmNlIFJlbW92YWxzCiAgICAgIHZhciBpbnN0YW5jZUNhY2hlID0gbmV3IE1hcDsKICAgICAgdmFyIHJlbW92ZURlbHRhID0gMDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGxpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHNwbGljZSA9IHNwbGljZXNbaV07CiAgICAgICAgdmFyIHJlbW92ZWQgPSBzcGxpY2UucmVtb3ZlZDsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJlbW92ZWQubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHZhciBtb2RlbCA9IHJlbW92ZWRbal07CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0aGlzLmV4dHJhY3RJbnN0YW5jZUF0KHNwbGljZS5pbmRleCArIHJlbW92ZURlbHRhKTsKICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gZW1wdHlJbnN0YW5jZSkgewogICAgICAgICAgICBpbnN0YW5jZUNhY2hlLnNldChtb2RlbCwgaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmVtb3ZlRGVsdGEgLT0gc3BsaWNlLmFkZGVkQ291bnQ7CiAgICAgIH0KCiAgICAgIC8vIEluc3RhbmNlIEluc2VydGlvbnMKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGxpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHNwbGljZSA9IHNwbGljZXNbaV07CiAgICAgICAgdmFyIGFkZEluZGV4ID0gc3BsaWNlLmluZGV4OwogICAgICAgIGZvciAoOyBhZGRJbmRleCA8IHNwbGljZS5pbmRleCArIHNwbGljZS5hZGRlZENvdW50OyBhZGRJbmRleCsrKSB7CiAgICAgICAgICB2YXIgbW9kZWwgPSB0aGlzLml0ZXJhdGVkVmFsdWVbYWRkSW5kZXhdOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gaW5zdGFuY2VDYWNoZS5nZXQobW9kZWwpOwogICAgICAgICAgaWYgKGluc3RhbmNlKSB7CiAgICAgICAgICAgIGluc3RhbmNlQ2FjaGUuZGVsZXRlKG1vZGVsKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0aGlzLmluc3RhbmNlTW9kZWxGbl8pIHsKICAgICAgICAgICAgICBtb2RlbCA9IHRoaXMuaW5zdGFuY2VNb2RlbEZuXyhtb2RlbCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChtb2RlbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgaW5zdGFuY2UgPSBlbXB0eUluc3RhbmNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGluc3RhbmNlID0gdGVtcGxhdGUuY3JlYXRlSW5zdGFuY2UobW9kZWwsIHVuZGVmaW5lZCwgZGVsZWdhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5pbnNlcnRJbnN0YW5jZUF0KGFkZEluZGV4LCBpbnN0YW5jZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpbnN0YW5jZUNhY2hlLmZvckVhY2goZnVuY3Rpb24oaW5zdGFuY2UpIHsKICAgICAgICB0aGlzLmNsb3NlSW5zdGFuY2VCaW5kaW5ncyhpbnN0YW5jZSk7CiAgICAgIH0sIHRoaXMpOwoKICAgICAgaWYgKHRoaXMuaW5zdGFuY2VQb3NpdGlvbkNoYW5nZWRGbl8pCiAgICAgICAgdGhpcy5yZXBvcnRJbnN0YW5jZXNNb3ZlZChzcGxpY2VzKTsKICAgIH0sCgogICAgcmVwb3J0SW5zdGFuY2VNb3ZlZDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgdmFyIGluc3RhbmNlID0gdGhpcy5pbnN0YW5jZXNbaW5kZXhdOwogICAgICBpZiAoaW5zdGFuY2UgPT09IGVtcHR5SW5zdGFuY2UpCiAgICAgICAgcmV0dXJuOwoKICAgICAgdGhpcy5pbnN0YW5jZVBvc2l0aW9uQ2hhbmdlZEZuXyhpbnN0YW5jZS50ZW1wbGF0ZUluc3RhbmNlXywgaW5kZXgpOwogICAgfSwKCiAgICByZXBvcnRJbnN0YW5jZXNNb3ZlZDogZnVuY3Rpb24oc3BsaWNlcykgewogICAgICB2YXIgaW5kZXggPSAwOwogICAgICB2YXIgb2Zmc2V0ID0gMDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGxpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHNwbGljZSA9IHNwbGljZXNbaV07CiAgICAgICAgaWYgKG9mZnNldCAhPSAwKSB7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPCBzcGxpY2UuaW5kZXgpIHsKICAgICAgICAgICAgdGhpcy5yZXBvcnRJbnN0YW5jZU1vdmVkKGluZGV4KTsKICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaW5kZXggPSBzcGxpY2UuaW5kZXg7CiAgICAgICAgfQoKICAgICAgICB3aGlsZSAoaW5kZXggPCBzcGxpY2UuaW5kZXggKyBzcGxpY2UuYWRkZWRDb3VudCkgewogICAgICAgICAgdGhpcy5yZXBvcnRJbnN0YW5jZU1vdmVkKGluZGV4KTsKICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgfQoKICAgICAgICBvZmZzZXQgKz0gc3BsaWNlLmFkZGVkQ291bnQgLSBzcGxpY2UucmVtb3ZlZC5sZW5ndGg7CiAgICAgIH0KCiAgICAgIGlmIChvZmZzZXQgPT0gMCkKICAgICAgICByZXR1cm47CgogICAgICB2YXIgbGVuZ3RoID0gdGhpcy5pbnN0YW5jZXMubGVuZ3RoOwogICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB0aGlzLnJlcG9ydEluc3RhbmNlTW92ZWQoaW5kZXgpOwogICAgICAgIGluZGV4Kys7CiAgICAgIH0KICAgIH0sCgogICAgY2xvc2VJbnN0YW5jZUJpbmRpbmdzOiBmdW5jdGlvbihpbnN0YW5jZSkgewogICAgICB2YXIgYmluZGluZ3MgPSBpbnN0YW5jZS5iaW5kaW5nc187CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYmluZGluZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBiaW5kaW5nc1tpXS5jbG9zZSgpOwogICAgICB9CiAgICB9LAoKICAgIHVub2JzZXJ2ZTogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5hcnJheU9ic2VydmVyKQogICAgICAgIHJldHVybjsKCiAgICAgIHRoaXMuYXJyYXlPYnNlcnZlci5jbG9zZSgpOwogICAgICB0aGlzLmFycmF5T2JzZXJ2ZXIgPSB1bmRlZmluZWQ7CiAgICB9LAoKICAgIGNsb3NlOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuY2xvc2VkKQogICAgICAgIHJldHVybjsKICAgICAgdGhpcy51bm9ic2VydmUoKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmluc3RhbmNlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuY2xvc2VJbnN0YW5jZUJpbmRpbmdzKHRoaXMuaW5zdGFuY2VzW2ldKTsKICAgICAgfQoKICAgICAgdGhpcy5pbnN0YW5jZXMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5jbG9zZURlcHMoKTsKICAgICAgdGhpcy50ZW1wbGF0ZUVsZW1lbnRfLml0ZXJhdG9yXyA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5jbG9zZWQgPSB0cnVlOwogICAgfQogIH07CgogIC8vIFBvbHlmaWxsLXNwZWNpZmljIEFQSS4KICBIVE1MVGVtcGxhdGVFbGVtZW50LmZvckFsbFRlbXBsYXRlc0Zyb21fID0gZm9yQWxsVGVtcGxhdGVzRnJvbTsKfSkodGhpcyk7Cg==",
                "body": "Ly8gQ29weXJpZ2h0IChjKSAyMDE0IFRoZSBQb2x5bWVyIFByb2plY3QgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KLy8gVGhpcyBjb2RlIG1heSBvbmx5IGJlIHVzZWQgdW5kZXIgdGhlIEJTRCBzdHlsZSBsaWNlbnNlIGZvdW5kIGF0IGh0dHA6Ly9wb2x5bWVyLmdpdGh1Yi5pby9MSUNFTlNFLnR4dAovLyBUaGUgY29tcGxldGUgc2V0IG9mIGF1dGhvcnMgbWF5IGJlIGZvdW5kIGF0IGh0dHA6Ly9wb2x5bWVyLmdpdGh1Yi5pby9BVVRIT1JTLnR4dAovLyBUaGUgY29tcGxldGUgc2V0IG9mIGNvbnRyaWJ1dG9ycyBtYXkgYmUgZm91bmQgYXQgaHR0cDovL3BvbHltZXIuZ2l0aHViLmlvL0NPTlRSSUJVVE9SUy50eHQKLy8gQ29kZSBkaXN0cmlidXRlZCBieSBHb29nbGUgYXMgcGFydCBvZiB0aGUgcG9seW1lciBwcm9qZWN0IGlzIGFsc28KLy8gc3ViamVjdCB0byBhbiBhZGRpdGlvbmFsIElQIHJpZ2h0cyBncmFudCBmb3VuZCBhdCBodHRwOi8vcG9seW1lci5naXRodWIuaW8vUEFURU5UUy50eHQKCihmdW5jdGlvbihnbG9iYWwpIHsKICAndXNlIHN0cmljdCc7CgogIGZ1bmN0aW9uIGFzc2VydCh2KSB7CiAgICBpZiAoIXYpCiAgICAgIHRocm93IG5ldyBFcnJvcignQXNzZXJ0aW9uIGZhaWxlZCcpOwogIH0KCiAgdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKICBmdW5jdGlvbiBnZXRGcmFnbWVudFJvb3Qobm9kZSkgewogICAgdmFyIHA7CiAgICB3aGlsZSAocCA9IG5vZGUucGFyZW50Tm9kZSkgewogICAgICBub2RlID0gcDsKICAgIH0KCiAgICByZXR1cm4gbm9kZTsKICB9CgogIGZ1bmN0aW9uIHNlYXJjaFJlZklkKG5vZGUsIGlkKSB7CiAgICBpZiAoIWlkKQogICAgICByZXR1cm47CgogICAgdmFyIHJlZjsKICAgIHZhciBzZWxlY3RvciA9ICcjJyArIGlkOwogICAgd2hpbGUgKCFyZWYpIHsKICAgICAgbm9kZSA9IGdldEZyYWdtZW50Um9vdChub2RlKTsKCiAgICAgIGlmIChub2RlLnByb3RvQ29udGVudF8pCiAgICAgICAgcmVmID0gbm9kZS5wcm90b0NvbnRlbnRfLnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpOwogICAgICBlbHNlIGlmIChub2RlLmdldEVsZW1lbnRCeUlkKQogICAgICAgIHJlZiA9IG5vZGUuZ2V0RWxlbWVudEJ5SWQoaWQpOwoKICAgICAgaWYgKHJlZiB8fCAhbm9kZS50ZW1wbGF0ZUNyZWF0b3JfKQogICAgICAgIGJyZWFrCgogICAgICBub2RlID0gbm9kZS50ZW1wbGF0ZUNyZWF0b3JfOwogICAgfQoKICAgIHJldHVybiByZWY7CiAgfQoKICBmdW5jdGlvbiBnZXRJbnN0YW5jZVJvb3Qobm9kZSkgewogICAgd2hpbGUgKG5vZGUucGFyZW50Tm9kZSkgewogICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgfQogICAgcmV0dXJuIG5vZGUudGVtcGxhdGVDcmVhdG9yXyA/IG5vZGUgOiBudWxsOwogIH0KCiAgdmFyIE1hcDsKICBpZiAoZ2xvYmFsLk1hcCAmJiB0eXBlb2YgZ2xvYmFsLk1hcC5wcm90b3R5cGUuZm9yRWFjaCA9PT0gJ2Z1bmN0aW9uJykgewogICAgTWFwID0gZ2xvYmFsLk1hcDsKICB9IGVsc2UgewogICAgTWFwID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMua2V5cyA9IFtdOwogICAgICB0aGlzLnZhbHVlcyA9IFtdOwogICAgfTsKCiAgICBNYXAucHJvdG90eXBlID0gewogICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmtleXMuaW5kZXhPZihrZXkpOwogICAgICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgIHRoaXMua2V5cy5wdXNoKGtleSk7CiAgICAgICAgICB0aGlzLnZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy52YWx1ZXNbaW5kZXhdID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmtleXMuaW5kZXhPZihrZXkpOwogICAgICAgIGlmIChpbmRleCA8IDApCiAgICAgICAgICByZXR1cm47CgogICAgICAgIHJldHVybiB0aGlzLnZhbHVlc1tpbmRleF07CiAgICAgIH0sCgogICAgICBkZWxldGU6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmtleXMuaW5kZXhPZihrZXkpOwogICAgICAgIGlmIChpbmRleCA8IDApCiAgICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgICAgIHRoaXMua2V5cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIHRoaXMudmFsdWVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0sCgogICAgICBmb3JFYWNoOiBmdW5jdGlvbihmLCBvcHRfdGhpcykgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5rZXlzLmxlbmd0aDsgaSsrKQogICAgICAgICAgZi5jYWxsKG9wdF90aGlzIHx8IHRoaXMsIHRoaXMudmFsdWVzW2ldLCB0aGlzLmtleXNbaV0sIHRoaXMpOwogICAgICB9CiAgICB9OwogIH0KCiAgLy8gSlNjcmlwdCBkb2VzIG5vdCBoYXZlIF9fcHJvdG9fXy4gV2Ugd3JhcCBhbGwgb2JqZWN0IGxpdGVyYWxzIHdpdGgKICAvLyBjcmVhdGVPYmplY3Qgd2hpY2ggdXNlcyBPYmplY3QuY3JlYXRlLCBPYmplY3QuZGVmaW5lUHJvcGVydHkgYW5kCiAgLy8gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvciB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRoYXQgZG9lcyB0aGUgZXhhY3QKICAvLyBzYW1lIHRoaW5nLiBUaGUgbWFpbiBkb3duc2lkZSB0byB0aGlzIHNvbHV0aW9uIGlzIHRoYXQgd2UgaGF2ZSB0byBleHRyYWN0CiAgLy8gYWxsIHRob3NlIHByb3BlcnR5IGRlc2NyaXB0b3JzIGZvciBJRS4KICB2YXIgY3JlYXRlT2JqZWN0ID0gKCdfX3Byb3RvX18nIGluIHt9KSA/CiAgICAgIGZ1bmN0aW9uKG9iaikgeyByZXR1cm4gb2JqOyB9IDoKICAgICAgZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgdmFyIHByb3RvID0gb2JqLl9fcHJvdG9fXzsKICAgICAgICBpZiAoIXByb3RvKQogICAgICAgICAgcmV0dXJuIG9iajsKICAgICAgICB2YXIgbmV3T2JqZWN0ID0gT2JqZWN0LmNyZWF0ZShwcm90byk7CiAgICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMob2JqKS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuZXdPYmplY3QsIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwgbmFtZSkpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBuZXdPYmplY3Q7CiAgICAgIH07CgogIC8vIElFIGRvZXMgbm90IHN1cHBvcnQgaGF2ZSBEb2N1bWVudC5wcm90b3R5cGUuY29udGFpbnMuCiAgaWYgKHR5cGVvZiBkb2N1bWVudC5jb250YWlucyAhPSAnZnVuY3Rpb24nKSB7CiAgICBEb2N1bWVudC5wcm90b3R5cGUuY29udGFpbnMgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgIGlmIChub2RlID09PSB0aGlzIHx8IG5vZGUucGFyZW50Tm9kZSA9PT0gdGhpcykKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMuZG9jdW1lbnRFbGVtZW50LmNvbnRhaW5zKG5vZGUpOwogICAgfQogIH0KCiAgdmFyIEJJTkQgPSAnYmluZCc7CiAgdmFyIFJFUEVBVCA9ICdyZXBlYXQnOwogIHZhciBJRiA9ICdpZic7CgogIHZhciB0ZW1wbGF0ZUF0dHJpYnV0ZURpcmVjdGl2ZXMgPSB7CiAgICAndGVtcGxhdGUnOiB0cnVlLAogICAgJ3JlcGVhdCc6IHRydWUsCiAgICAnYmluZCc6IHRydWUsCiAgICAncmVmJzogdHJ1ZQogIH07CgogIHZhciBzZW1hbnRpY1RlbXBsYXRlRWxlbWVudHMgPSB7CiAgICAnVEhFQUQnOiB0cnVlLAogICAgJ1RCT0RZJzogdHJ1ZSwKICAgICdURk9PVCc6IHRydWUsCiAgICAnVEgnOiB0cnVlLAogICAgJ1RSJzogdHJ1ZSwKICAgICdURCc6IHRydWUsCiAgICAnQ09MR1JPVVAnOiB0cnVlLAogICAgJ0NPTCc6IHRydWUsCiAgICAnQ0FQVElPTic6IHRydWUsCiAgICAnT1BUSU9OJzogdHJ1ZSwKICAgICdPUFRHUk9VUCc6IHRydWUKICB9OwoKICB2YXIgaGFzVGVtcGxhdGVFbGVtZW50ID0gdHlwZW9mIEhUTUxUZW1wbGF0ZUVsZW1lbnQgIT09ICd1bmRlZmluZWQnOwogIGlmIChoYXNUZW1wbGF0ZUVsZW1lbnQpIHsKICAgIC8vIFRPRE8ocmFmYWVsdyk6IFJlbW92ZSB3aGVuIGZpeCBmb3IKICAgIC8vIGh0dHBzOi8vY29kZXJldmlldy5jaHJvbWl1bS5vcmcvMTY0ODAzMDAyLwogICAgLy8gbWFrZXMgaXQgdG8gQ2hyb21lIHJlbGVhc2UuCiAgICAoZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGVtcGxhdGUnKTsKICAgICAgdmFyIGQgPSB0LmNvbnRlbnQub3duZXJEb2N1bWVudDsKICAgICAgdmFyIGh0bWwgPSBkLmFwcGVuZENoaWxkKGQuY3JlYXRlRWxlbWVudCgnaHRtbCcpKTsKICAgICAgdmFyIGhlYWQgPSBodG1sLmFwcGVuZENoaWxkKGQuY3JlYXRlRWxlbWVudCgnaGVhZCcpKTsKICAgICAgdmFyIGJhc2UgPSBkLmNyZWF0ZUVsZW1lbnQoJ2Jhc2UnKTsKICAgICAgYmFzZS5ocmVmID0gZG9jdW1lbnQuYmFzZVVSSTsKICAgICAgaGVhZC5hcHBlbmRDaGlsZChiYXNlKTsKICAgIH0pKCk7CiAgfQoKICB2YXIgYWxsVGVtcGxhdGVzU2VsZWN0b3JzID0gJ3RlbXBsYXRlLCAnICsKICAgICAgT2JqZWN0LmtleXMoc2VtYW50aWNUZW1wbGF0ZUVsZW1lbnRzKS5tYXAoZnVuY3Rpb24odGFnTmFtZSkgewogICAgICAgIHJldHVybiB0YWdOYW1lLnRvTG93ZXJDYXNlKCkgKyAnW3RlbXBsYXRlXSc7CiAgICAgIH0pLmpvaW4oJywgJyk7CgogIGZ1bmN0aW9uIGlzU1ZHVGVtcGxhdGUoZWwpIHsKICAgIHJldHVybiBlbC50YWdOYW1lID09ICd0ZW1wbGF0ZScgJiYKICAgICAgICAgICBlbC5uYW1lc3BhY2VVUkkgPT0gJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJzsKICB9CgogIGZ1bmN0aW9uIGlzSFRNTFRlbXBsYXRlKGVsKSB7CiAgICByZXR1cm4gZWwudGFnTmFtZSA9PSAnVEVNUExBVEUnICYmCiAgICAgICAgICAgZWwubmFtZXNwYWNlVVJJID09ICdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sJzsKICB9CgogIGZ1bmN0aW9uIGlzQXR0cmlidXRlVGVtcGxhdGUoZWwpIHsKICAgIHJldHVybiBCb29sZWFuKHNlbWFudGljVGVtcGxhdGVFbGVtZW50c1tlbC50YWdOYW1lXSAmJgogICAgICAgICAgICAgICAgICAgZWwuaGFzQXR0cmlidXRlKCd0ZW1wbGF0ZScpKTsKICB9CgogIGZ1bmN0aW9uIGlzVGVtcGxhdGUoZWwpIHsKICAgIGlmIChlbC5pc1RlbXBsYXRlXyA9PT0gdW5kZWZpbmVkKQogICAgICBlbC5pc1RlbXBsYXRlXyA9IGVsLnRhZ05hbWUgPT0gJ1RFTVBMQVRFJyB8fCBpc0F0dHJpYnV0ZVRlbXBsYXRlKGVsKTsKCiAgICByZXR1cm4gZWwuaXNUZW1wbGF0ZV87CiAgfQoKICAvLyBGSVhNRTogT2JzZXJ2ZSB0ZW1wbGF0ZXMgYmVpbmcgYWRkZWQvcmVtb3ZlZCBmcm9tIGRvY3VtZW50cwogIC8vIEZJWE1FOiBFeHBvc2UgaW1wZXJhdGl2ZSBBUEkgdG8gZGVjb3JhdGUgYW5kIG9ic2VydmUgdGVtcGxhdGVzIGluCiAgLy8gImRpc2Nvbm5lY3RlZCB0cmVzcyIgKGUuZy4gU2hhZG93Um9vdCkKICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZnVuY3Rpb24oZSkgewogICAgYm9vdHN0cmFwVGVtcGxhdGVzUmVjdXJzaXZlbHlGcm9tKGRvY3VtZW50KTsKICAgIC8vIEZJWE1FOiBJcyB0aGlzIG5lZWRlZD8gU2VlbXMgbGlrZSBpdCBzaG91bGRuJ3QgYmUuCiAgICBQbGF0Zm9ybS5wZXJmb3JtTWljcm90YXNrQ2hlY2twb2ludCgpOwogIH0sIGZhbHNlKTsKCiAgZnVuY3Rpb24gZm9yQWxsVGVtcGxhdGVzRnJvbShub2RlLCBmbikgewogICAgdmFyIHN1YlRlbXBsYXRlcyA9IG5vZGUucXVlcnlTZWxlY3RvckFsbChhbGxUZW1wbGF0ZXNTZWxlY3RvcnMpOwoKICAgIGlmIChpc1RlbXBsYXRlKG5vZGUpKQogICAgICBmbihub2RlKQogICAgZm9yRWFjaChzdWJUZW1wbGF0ZXMsIGZuKTsKICB9CgogIGZ1bmN0aW9uIGJvb3RzdHJhcFRlbXBsYXRlc1JlY3Vyc2l2ZWx5RnJvbShub2RlKSB7CiAgICBmdW5jdGlvbiBib290c3RyYXAodGVtcGxhdGUpIHsKICAgICAgaWYgKCFIVE1MVGVtcGxhdGVFbGVtZW50LmRlY29yYXRlKHRlbXBsYXRlKSkKICAgICAgICBib290c3RyYXBUZW1wbGF0ZXNSZWN1cnNpdmVseUZyb20odGVtcGxhdGUuY29udGVudCk7CiAgICB9CgogICAgZm9yQWxsVGVtcGxhdGVzRnJvbShub2RlLCBib290c3RyYXApOwogIH0KCiAgaWYgKCFoYXNUZW1wbGF0ZUVsZW1lbnQpIHsKICAgIC8qKgogICAgICogVGhpcyByZXByZXNlbnRzIGEgPHRlbXBsYXRlPiBlbGVtZW50LgogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKiBAZXh0ZW5kcyB7SFRNTEVsZW1lbnR9CiAgICAgKi8KICAgIGdsb2JhbC5IVE1MVGVtcGxhdGVFbGVtZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRocm93IFR5cGVFcnJvcignSWxsZWdhbCBjb25zdHJ1Y3RvcicpOwogICAgfTsKICB9CgogIHZhciBoYXNQcm90byA9ICdfX3Byb3RvX18nIGluIHt9OwoKICBmdW5jdGlvbiBtaXhpbih0bywgZnJvbSkgewogICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoZnJvbSkuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0bywgbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZnJvbSwgbmFtZSkpOwogICAgfSk7CiAgfQoKICAvLyBodHRwOi8vZHZjcy53My5vcmcvaGcvd2ViY29tcG9uZW50cy9yYXctZmlsZS90aXAvc3BlYy90ZW1wbGF0ZXMvaW5kZXguaHRtbCNkZm4tdGVtcGxhdGUtY29udGVudHMtb3duZXIKICBmdW5jdGlvbiBnZXRPckNyZWF0ZVRlbXBsYXRlQ29udGVudHNPd25lcih0ZW1wbGF0ZSkgewogICAgdmFyIGRvYyA9IHRlbXBsYXRlLm93bmVyRG9jdW1lbnQKICAgIGlmICghZG9jLmRlZmF1bHRWaWV3KQogICAgICByZXR1cm4gZG9jOwogICAgdmFyIGQgPSBkb2MudGVtcGxhdGVDb250ZW50c093bmVyXzsKICAgIGlmICghZCkgewogICAgICAvLyBUT0RPKGFydik6IFRoaXMgc2hvdWxkIGVpdGhlciBiZSBhIERvY3VtZW50IG9yIEhUTUxEb2N1bWVudCBkZXBlbmRpbmcKICAgICAgLy8gb24gZG9jLgogICAgICBkID0gZG9jLmltcGxlbWVudGF0aW9uLmNyZWF0ZUhUTUxEb2N1bWVudCgnJyk7CiAgICAgIHdoaWxlIChkLmxhc3RDaGlsZCkgewogICAgICAgIGQucmVtb3ZlQ2hpbGQoZC5sYXN0Q2hpbGQpOwogICAgICB9CiAgICAgIGRvYy50ZW1wbGF0ZUNvbnRlbnRzT3duZXJfID0gZDsKICAgIH0KICAgIHJldHVybiBkOwogIH0KCiAgZnVuY3Rpb24gZ2V0VGVtcGxhdGVTdGFnaW5nRG9jdW1lbnQodGVtcGxhdGUpIHsKICAgIGlmICghdGVtcGxhdGUuc3RhZ2luZ0RvY3VtZW50XykgewogICAgICB2YXIgb3duZXIgPSB0ZW1wbGF0ZS5vd25lckRvY3VtZW50OwogICAgICBpZiAoIW93bmVyLnN0YWdpbmdEb2N1bWVudF8pIHsKICAgICAgICBvd25lci5zdGFnaW5nRG9jdW1lbnRfID0gb3duZXIuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KCcnKTsKICAgICAgICBvd25lci5zdGFnaW5nRG9jdW1lbnRfLmlzU3RhZ2luZ0RvY3VtZW50ID0gdHJ1ZTsKICAgICAgICAvLyBUT0RPKHJhZmFlbHcpOiBSZW1vdmUgd2hlbiBmaXggZm9yCiAgICAgICAgLy8gaHR0cHM6Ly9jb2RlcmV2aWV3LmNocm9taXVtLm9yZy8xNjQ4MDMwMDIvCiAgICAgICAgLy8gbWFrZXMgaXQgdG8gQ2hyb21lIHJlbGVhc2UuCiAgICAgICAgdmFyIGJhc2UgPSBvd25lci5zdGFnaW5nRG9jdW1lbnRfLmNyZWF0ZUVsZW1lbnQoJ2Jhc2UnKTsKICAgICAgICBiYXNlLmhyZWYgPSBkb2N1bWVudC5iYXNlVVJJOwogICAgICAgIG93bmVyLnN0YWdpbmdEb2N1bWVudF8uaGVhZC5hcHBlbmRDaGlsZChiYXNlKTsKCiAgICAgICAgb3duZXIuc3RhZ2luZ0RvY3VtZW50Xy5zdGFnaW5nRG9jdW1lbnRfID0gb3duZXIuc3RhZ2luZ0RvY3VtZW50XzsKICAgICAgfQoKICAgICAgdGVtcGxhdGUuc3RhZ2luZ0RvY3VtZW50XyA9IG93bmVyLnN0YWdpbmdEb2N1bWVudF87CiAgICB9CgogICAgcmV0dXJuIHRlbXBsYXRlLnN0YWdpbmdEb2N1bWVudF87CiAgfQoKICAvLyBGb3Igbm9uLXRlbXBsYXRlIGJyb3dzZXJzLCB0aGUgcGFyc2VyIHdpbGwgZGlzYWxsb3cgPHRlbXBsYXRlPiBpbiBjZXJ0YWluCiAgLy8gbG9jYXRpb25zLCBzbyB3ZSBhbGxvdyAiYXR0cmlidXRlIHRlbXBsYXRlcyIgd2hpY2ggY29tYmluZSB0aGUgdGVtcGxhdGUKICAvLyBlbGVtZW50IHdpdGggdGhlIHRvcC1sZXZlbCBjb250YWluZXIgbm9kZSBvZiB0aGUgY29udGVudCwgZS5nLgogIC8vCiAgLy8gICA8dHIgdGVtcGxhdGUgcmVwZWF0PSJ7eyBmb28gfX0iIiBjbGFzcz0iYmFyIj48dGQ+QmFyPC90ZD48L3RyPgogIC8vCiAgLy8gYmVjb21lcwogIC8vCiAgLy8gICA8dGVtcGxhdGUgcmVwZWF0PSJ7eyBmb28gfX0iPgogIC8vICAgKyAjZG9jdW1lbnQtZnJhZ21lbnQKICAvLyAgICAgKyA8dHIgY2xhc3M9ImJhciI+CiAgLy8gICAgICAgKyA8dGQ+QmFyPC90ZD4KICAvLwogIGZ1bmN0aW9uIGV4dHJhY3RUZW1wbGF0ZUZyb21BdHRyaWJ1dGVUZW1wbGF0ZShlbCkgewogICAgdmFyIHRlbXBsYXRlID0gZWwub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZW1wbGF0ZScpOwogICAgZWwucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGVtcGxhdGUsIGVsKTsKCiAgICB2YXIgYXR0cmlicyA9IGVsLmF0dHJpYnV0ZXM7CiAgICB2YXIgY291bnQgPSBhdHRyaWJzLmxlbmd0aDsKICAgIHdoaWxlIChjb3VudC0tID4gMCkgewogICAgICB2YXIgYXR0cmliID0gYXR0cmlic1tjb3VudF07CiAgICAgIGlmICh0ZW1wbGF0ZUF0dHJpYnV0ZURpcmVjdGl2ZXNbYXR0cmliLm5hbWVdKSB7CiAgICAgICAgaWYgKGF0dHJpYi5uYW1lICE9PSAndGVtcGxhdGUnKQogICAgICAgICAgdGVtcGxhdGUuc2V0QXR0cmlidXRlKGF0dHJpYi5uYW1lLCBhdHRyaWIudmFsdWUpOwogICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWIubmFtZSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfQoKICBmdW5jdGlvbiBleHRyYWN0VGVtcGxhdGVGcm9tU1ZHVGVtcGxhdGUoZWwpIHsKICAgIHZhciB0ZW1wbGF0ZSA9IGVsLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGVtcGxhdGUnKTsKICAgIGVsLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRlbXBsYXRlLCBlbCk7CgogICAgdmFyIGF0dHJpYnMgPSBlbC5hdHRyaWJ1dGVzOwogICAgdmFyIGNvdW50ID0gYXR0cmlicy5sZW5ndGg7CiAgICB3aGlsZSAoY291bnQtLSA+IDApIHsKICAgICAgdmFyIGF0dHJpYiA9IGF0dHJpYnNbY291bnRdOwogICAgICB0ZW1wbGF0ZS5zZXRBdHRyaWJ1dGUoYXR0cmliLm5hbWUsIGF0dHJpYi52YWx1ZSk7CiAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWIubmFtZSk7CiAgICB9CgogICAgZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbCk7CiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfQoKICBmdW5jdGlvbiBsaWZ0Tm9uTmF0aXZlVGVtcGxhdGVDaGlsZHJlbkludG9Db250ZW50KHRlbXBsYXRlLCBlbCwgdXNlUm9vdCkgewogICAgdmFyIGNvbnRlbnQgPSB0ZW1wbGF0ZS5jb250ZW50OwogICAgaWYgKHVzZVJvb3QpIHsKICAgICAgY29udGVudC5hcHBlbmRDaGlsZChlbCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgY2hpbGQ7CiAgICB3aGlsZSAoY2hpbGQgPSBlbC5maXJzdENoaWxkKSB7CiAgICAgIGNvbnRlbnQuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgfQogIH0KCiAgdmFyIHRlbXBsYXRlT2JzZXJ2ZXI7CiAgaWYgKHR5cGVvZiBNdXRhdGlvbk9ic2VydmVyID09ICdmdW5jdGlvbicpIHsKICAgIHRlbXBsYXRlT2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihmdW5jdGlvbihyZWNvcmRzKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVjb3Jkcy5sZW5ndGg7IGkrKykgewogICAgICAgIHJlY29yZHNbaV0udGFyZ2V0LnJlZkNoYW5nZWRfKCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLyoqCiAgICogRW5zdXJlcyBwcm9wZXIgQVBJIGFuZCBjb250ZW50IG1vZGVsIGZvciB0ZW1wbGF0ZSBlbGVtZW50cy4KICAgKiBAcGFyYW0ge0hUTUxUZW1wbGF0ZUVsZW1lbnR9IG9wdF9pbnN0YW5jZVJlZiBUaGUgdGVtcGxhdGUgZWxlbWVudCB3aGljaAogICAqICAgICB8ZWx8IHRlbXBsYXRlIGVsZW1lbnQgd2lsbCByZXR1cm4gYXMgdGhlIHZhbHVlIG9mIGl0cyByZWYoKSwgYW5kIHdob3NlCiAgICogICAgIGNvbnRlbnQgd2lsbCBiZSB1c2VkIGFzIHNvdXJjZSB3aGVuIGNyZWF0ZUluc3RhbmNlKCkgaXMgaW52b2tlZC4KICAgKi8KICBIVE1MVGVtcGxhdGVFbGVtZW50LmRlY29yYXRlID0gZnVuY3Rpb24oZWwsIG9wdF9pbnN0YW5jZVJlZikgewogICAgaWYgKGVsLnRlbXBsYXRlSXNEZWNvcmF0ZWRfKQogICAgICByZXR1cm4gZmFsc2U7CgogICAgdmFyIHRlbXBsYXRlRWxlbWVudCA9IGVsOwogICAgdGVtcGxhdGVFbGVtZW50LnRlbXBsYXRlSXNEZWNvcmF0ZWRfID0gdHJ1ZTsKCiAgICB2YXIgaXNOYXRpdmVIVE1MVGVtcGxhdGUgPSBpc0hUTUxUZW1wbGF0ZSh0ZW1wbGF0ZUVsZW1lbnQpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNUZW1wbGF0ZUVsZW1lbnQ7CiAgICB2YXIgYm9vdHN0cmFwQ29udGVudHMgPSBpc05hdGl2ZUhUTUxUZW1wbGF0ZTsKICAgIHZhciBsaWZ0Q29udGVudHMgPSAhaXNOYXRpdmVIVE1MVGVtcGxhdGU7CiAgICB2YXIgbGlmdFJvb3QgPSBmYWxzZTsKCiAgICBpZiAoIWlzTmF0aXZlSFRNTFRlbXBsYXRlKSB7CiAgICAgIGlmIChpc0F0dHJpYnV0ZVRlbXBsYXRlKHRlbXBsYXRlRWxlbWVudCkpIHsKICAgICAgICBhc3NlcnQoIW9wdF9pbnN0YW5jZVJlZik7CiAgICAgICAgdGVtcGxhdGVFbGVtZW50ID0gZXh0cmFjdFRlbXBsYXRlRnJvbUF0dHJpYnV0ZVRlbXBsYXRlKGVsKTsKICAgICAgICB0ZW1wbGF0ZUVsZW1lbnQudGVtcGxhdGVJc0RlY29yYXRlZF8gPSB0cnVlOwogICAgICAgIGlzTmF0aXZlSFRNTFRlbXBsYXRlID0gaGFzVGVtcGxhdGVFbGVtZW50OwogICAgICAgIGxpZnRSb290ID0gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChpc1NWR1RlbXBsYXRlKHRlbXBsYXRlRWxlbWVudCkpIHsKICAgICAgICB0ZW1wbGF0ZUVsZW1lbnQgPSBleHRyYWN0VGVtcGxhdGVGcm9tU1ZHVGVtcGxhdGUoZWwpOwogICAgICAgIHRlbXBsYXRlRWxlbWVudC50ZW1wbGF0ZUlzRGVjb3JhdGVkXyA9IHRydWU7CiAgICAgICAgaXNOYXRpdmVIVE1MVGVtcGxhdGUgPSBoYXNUZW1wbGF0ZUVsZW1lbnQ7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoIWlzTmF0aXZlSFRNTFRlbXBsYXRlKSB7CiAgICAgIGZpeFRlbXBsYXRlRWxlbWVudFByb3RvdHlwZSh0ZW1wbGF0ZUVsZW1lbnQpOwogICAgICB2YXIgZG9jID0gZ2V0T3JDcmVhdGVUZW1wbGF0ZUNvbnRlbnRzT3duZXIodGVtcGxhdGVFbGVtZW50KTsKICAgICAgdGVtcGxhdGVFbGVtZW50LmNvbnRlbnRfID0gZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgIH0KCiAgICBpZiAob3B0X2luc3RhbmNlUmVmKSB7CiAgICAgIC8vIHRlbXBsYXRlIGlzIGNvbnRhaW5lZCB3aXRoaW4gYW4gaW5zdGFuY2UsIGl0cyBkaXJlY3QgY29udGVudCBtdXN0IGJlCiAgICAgIC8vIGVtcHR5CiAgICAgIHRlbXBsYXRlRWxlbWVudC5pbnN0YW5jZVJlZl8gPSBvcHRfaW5zdGFuY2VSZWY7CiAgICB9IGVsc2UgaWYgKGxpZnRDb250ZW50cykgewogICAgICBsaWZ0Tm9uTmF0aXZlVGVtcGxhdGVDaGlsZHJlbkludG9Db250ZW50KHRlbXBsYXRlRWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZ0Um9vdCk7CiAgICB9IGVsc2UgaWYgKGJvb3RzdHJhcENvbnRlbnRzKSB7CiAgICAgIGJvb3RzdHJhcFRlbXBsYXRlc1JlY3Vyc2l2ZWx5RnJvbSh0ZW1wbGF0ZUVsZW1lbnQuY29udGVudCk7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLy8gVE9ETyhyYWZhZWx3KTogVGhpcyB1c2VkIHRvIGRlY29yYXRlIHJlY3Vyc2l2ZWx5IGFsbCB0ZW1wbGF0ZXMgZnJvbSBhIGdpdmVuCiAgLy8gbm9kZS4gVGhpcyBoYXBwZW5zIGJ5IGRlZmF1bHQgb24gJ0RPTUNvbnRlbnRMb2FkZWQnLCBidXQgbWF5IGJlIG5lZWRlZAogIC8vIGluIHN1YnRyZWVzIG5vdCBkZXNjZW5kZW50IGZyb20gZG9jdW1lbnQgKGUuZy4gU2hhZG93Um9vdCkuCiAgLy8gUmV2aWV3IHdoZXRoZXIgdGhpcyBpcyB0aGUgcmlnaHQgcHVibGljIEFQSS4KICBIVE1MVGVtcGxhdGVFbGVtZW50LmJvb3RzdHJhcCA9IGJvb3RzdHJhcFRlbXBsYXRlc1JlY3Vyc2l2ZWx5RnJvbTsKCiAgdmFyIGh0bWxFbGVtZW50ID0gZ2xvYmFsLkhUTUxVbmtub3duRWxlbWVudCB8fCBIVE1MRWxlbWVudDsKCiAgdmFyIGNvbnRlbnREZXNjcmlwdG9yID0gewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuY29udGVudF87CiAgICB9LAogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogIH07CgogIGlmICghaGFzVGVtcGxhdGVFbGVtZW50KSB7CiAgICAvLyBHZWNrbyBpcyBtb3JlIHBpY2t5IHdpdGggdGhlIHByb3RvdHlwZSB0aGFuIFdlYktpdC4gTWFrZSBzdXJlIHRvIHVzZSB0aGUKICAgIC8vIHNhbWUgcHJvdG90eXBlIGFzIGNyZWF0ZWQgaW4gdGhlIGNvbnN0cnVjdG9yLgogICAgSFRNTFRlbXBsYXRlRWxlbWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGh0bWxFbGVtZW50LnByb3RvdHlwZSk7CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEhUTUxUZW1wbGF0ZUVsZW1lbnQucHJvdG90eXBlLCAnY29udGVudCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudERlc2NyaXB0b3IpOwogIH0KCiAgZnVuY3Rpb24gZml4VGVtcGxhdGVFbGVtZW50UHJvdG90eXBlKGVsKSB7CiAgICBpZiAoaGFzUHJvdG8pCiAgICAgIGVsLl9fcHJvdG9fXyA9IEhUTUxUZW1wbGF0ZUVsZW1lbnQucHJvdG90eXBlOwogICAgZWxzZQogICAgICBtaXhpbihlbCwgSFRNTFRlbXBsYXRlRWxlbWVudC5wcm90b3R5cGUpOwogIH0KCiAgZnVuY3Rpb24gZW5zdXJlU2V0TW9kZWxTY2hlZHVsZWQodGVtcGxhdGUpIHsKICAgIGlmICghdGVtcGxhdGUuc2V0TW9kZWxGbl8pIHsKICAgICAgdGVtcGxhdGUuc2V0TW9kZWxGbl8gPSBmdW5jdGlvbigpIHsKICAgICAgICB0ZW1wbGF0ZS5zZXRNb2RlbEZuU2NoZWR1bGVkXyA9IGZhbHNlOwogICAgICAgIHZhciBtYXAgPSBnZXRCaW5kaW5ncyh0ZW1wbGF0ZSwKICAgICAgICAgICAgdGVtcGxhdGUuZGVsZWdhdGVfICYmIHRlbXBsYXRlLmRlbGVnYXRlXy5wcmVwYXJlQmluZGluZyk7CiAgICAgICAgcHJvY2Vzc0JpbmRpbmdzKHRlbXBsYXRlLCBtYXAsIHRlbXBsYXRlLm1vZGVsXyk7CiAgICAgIH07CiAgICB9CgogICAgaWYgKCF0ZW1wbGF0ZS5zZXRNb2RlbEZuU2NoZWR1bGVkXykgewogICAgICB0ZW1wbGF0ZS5zZXRNb2RlbEZuU2NoZWR1bGVkXyA9IHRydWU7CiAgICAgIE9ic2VydmVyLnJ1bkVPTV8odGVtcGxhdGUuc2V0TW9kZWxGbl8pOwogICAgfQogIH0KCiAgbWl4aW4oSFRNTFRlbXBsYXRlRWxlbWVudC5wcm90b3R5cGUsIHsKICAgIGJpbmQ6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCBvbmVUaW1lKSB7CiAgICAgIGlmIChuYW1lICE9ICdyZWYnKQogICAgICAgIHJldHVybiBFbGVtZW50LnByb3RvdHlwZS5iaW5kLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIG9uZVRpbWUpOwoKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgcmVmID0gb25lVGltZSA/IHZhbHVlIDogdmFsdWUub3BlbihmdW5jdGlvbihyZWYpIHsKICAgICAgICBzZWxmLnNldEF0dHJpYnV0ZSgncmVmJywgcmVmKTsKICAgICAgICBzZWxmLnJlZkNoYW5nZWRfKCk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ3JlZicsIHJlZik7CiAgICAgIHRoaXMucmVmQ2hhbmdlZF8oKTsKICAgICAgaWYgKG9uZVRpbWUpCiAgICAgICAgcmV0dXJuOwoKICAgICAgaWYgKCF0aGlzLmJpbmRpbmdzXykgewogICAgICAgIHRoaXMuYmluZGluZ3NfID0geyByZWY6IHZhbHVlIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5iaW5kaW5nc18ucmVmID0gdmFsdWU7CiAgICAgIH0KCiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCgogICAgcHJvY2Vzc0JpbmRpbmdEaXJlY3RpdmVzXzogZnVuY3Rpb24oZGlyZWN0aXZlcykgewogICAgICBpZiAodGhpcy5pdGVyYXRvcl8pCiAgICAgICAgdGhpcy5pdGVyYXRvcl8uY2xvc2VEZXBzKCk7CgogICAgICBpZiAoIWRpcmVjdGl2ZXMuaWYgJiYgIWRpcmVjdGl2ZXMuYmluZCAmJiAhZGlyZWN0aXZlcy5yZXBlYXQpIHsKICAgICAgICBpZiAodGhpcy5pdGVyYXRvcl8pIHsKICAgICAgICAgIHRoaXMuaXRlcmF0b3JfLmNsb3NlKCk7CiAgICAgICAgICB0aGlzLml0ZXJhdG9yXyA9IHVuZGVmaW5lZDsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLml0ZXJhdG9yXykgewogICAgICAgIHRoaXMuaXRlcmF0b3JfID0gbmV3IFRlbXBsYXRlSXRlcmF0b3IodGhpcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuaXRlcmF0b3JfLnVwZGF0ZURlcGVuZGVuY2llcyhkaXJlY3RpdmVzLCB0aGlzLm1vZGVsXyk7CgogICAgICBpZiAodGVtcGxhdGVPYnNlcnZlcikgewogICAgICAgIHRlbXBsYXRlT2JzZXJ2ZXIub2JzZXJ2ZSh0aGlzLCB7IGF0dHJpYnV0ZXM6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlRmlsdGVyOiBbJ3JlZiddIH0pOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5pdGVyYXRvcl87CiAgICB9LAoKICAgIGNyZWF0ZUluc3RhbmNlOiBmdW5jdGlvbihtb2RlbCwgYmluZGluZ0RlbGVnYXRlLCBkZWxlZ2F0ZV8pIHsKICAgICAgaWYgKGJpbmRpbmdEZWxlZ2F0ZSkKICAgICAgICBkZWxlZ2F0ZV8gPSB0aGlzLm5ld0RlbGVnYXRlXyhiaW5kaW5nRGVsZWdhdGUpOwogICAgICBlbHNlIGlmICghZGVsZWdhdGVfKQogICAgICAgIGRlbGVnYXRlXyA9IHRoaXMuZGVsZWdhdGVfOwoKICAgICAgaWYgKCF0aGlzLnJlZkNvbnRlbnRfKQogICAgICAgIHRoaXMucmVmQ29udGVudF8gPSB0aGlzLnJlZl8uY29udGVudDsKICAgICAgdmFyIGNvbnRlbnQgPSB0aGlzLnJlZkNvbnRlbnRfOwogICAgICBpZiAoY29udGVudC5maXJzdENoaWxkID09PSBudWxsKQogICAgICAgIHJldHVybiBlbXB0eUluc3RhbmNlOwoKICAgICAgdmFyIG1hcCA9IGdldEluc3RhbmNlQmluZGluZ01hcChjb250ZW50LCBkZWxlZ2F0ZV8pOwogICAgICB2YXIgc3RhZ2luZ0RvY3VtZW50ID0gZ2V0VGVtcGxhdGVTdGFnaW5nRG9jdW1lbnQodGhpcyk7CiAgICAgIHZhciBpbnN0YW5jZSA9IHN0YWdpbmdEb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIGluc3RhbmNlLnRlbXBsYXRlQ3JlYXRvcl8gPSB0aGlzOwogICAgICBpbnN0YW5jZS5wcm90b0NvbnRlbnRfID0gY29udGVudDsKICAgICAgaW5zdGFuY2UuYmluZGluZ3NfID0gW107CiAgICAgIGluc3RhbmNlLnRlcm1pbmF0b3JfID0gbnVsbDsKICAgICAgdmFyIGluc3RhbmNlUmVjb3JkID0gaW5zdGFuY2UudGVtcGxhdGVJbnN0YW5jZV8gPSB7CiAgICAgICAgZmlyc3ROb2RlOiBudWxsLAogICAgICAgIGxhc3ROb2RlOiBudWxsLAogICAgICAgIG1vZGVsOiBtb2RlbAogICAgICB9OwoKICAgICAgdmFyIGkgPSAwOwogICAgICB2YXIgY29sbGVjdFRlcm1pbmF0b3IgPSBmYWxzZTsKICAgICAgZm9yICh2YXIgY2hpbGQgPSBjb250ZW50LmZpcnN0Q2hpbGQ7IGNoaWxkOyBjaGlsZCA9IGNoaWxkLm5leHRTaWJsaW5nKSB7CiAgICAgICAgLy8gVGhlIHRlcm1pbmF0b3Igb2YgdGhlIGluc3RhbmNlIGlzIHRoZSBjbG9uZSBvZiB0aGUgbGFzdCBjaGlsZCBvZiB0aGUKICAgICAgICAvLyBjb250ZW50LiBJZiB0aGUgbGFzdCBjaGlsZCBpcyBhbiBhY3RpdmUgdGVtcGxhdGUsIGl0IG1heSBwcm9kdWNlCiAgICAgICAgLy8gaW5zdGFuY2VzIGFzIGEgcmVzdWx0IG9mIHByb2R1Y3Rpb24sIHNvIHNpbXBseSBjb2xsZWN0aW5nIHRoZSBsYXN0CiAgICAgICAgLy8gY2hpbGQgb2YgdGhlIGluc3RhbmNlIGFmdGVyIGl0IGhhcyBmaW5pc2hlZCBwcm9kdWNpbmcgbWF5IGJlIHdyb25nLgogICAgICAgIGlmIChjaGlsZC5uZXh0U2libGluZyA9PT0gbnVsbCkKICAgICAgICAgIGNvbGxlY3RUZXJtaW5hdG9yID0gdHJ1ZTsKCiAgICAgICAgdmFyIGNsb25lID0gY2xvbmVBbmRCaW5kSW5zdGFuY2UoY2hpbGQsIGluc3RhbmNlLCBzdGFnaW5nRG9jdW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwLmNoaWxkcmVuW2krK10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZWdhdGVfLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmJpbmRpbmdzXyk7CiAgICAgICAgY2xvbmUudGVtcGxhdGVJbnN0YW5jZV8gPSBpbnN0YW5jZVJlY29yZDsKICAgICAgICBpZiAoY29sbGVjdFRlcm1pbmF0b3IpCiAgICAgICAgICBpbnN0YW5jZS50ZXJtaW5hdG9yXyA9IGNsb25lOwogICAgICB9CgogICAgICBpbnN0YW5jZVJlY29yZC5maXJzdE5vZGUgPSBpbnN0YW5jZS5maXJzdENoaWxkOwogICAgICBpbnN0YW5jZVJlY29yZC5sYXN0Tm9kZSA9IGluc3RhbmNlLmxhc3RDaGlsZDsKICAgICAgaW5zdGFuY2UudGVtcGxhdGVDcmVhdG9yXyA9IHVuZGVmaW5lZDsKICAgICAgaW5zdGFuY2UucHJvdG9Db250ZW50XyA9IHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgfSwKCiAgICBnZXQgbW9kZWwoKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGVsXzsKICAgIH0sCgogICAgc2V0IG1vZGVsKG1vZGVsKSB7CiAgICAgIHRoaXMubW9kZWxfID0gbW9kZWw7CiAgICAgIGVuc3VyZVNldE1vZGVsU2NoZWR1bGVkKHRoaXMpOwogICAgfSwKCiAgICBnZXQgYmluZGluZ0RlbGVnYXRlKCkgewogICAgICByZXR1cm4gdGhpcy5kZWxlZ2F0ZV8gJiYgdGhpcy5kZWxlZ2F0ZV8ucmF3OwogICAgfSwKCiAgICByZWZDaGFuZ2VkXzogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5pdGVyYXRvcl8gfHwgdGhpcy5yZWZDb250ZW50XyA9PT0gdGhpcy5yZWZfLmNvbnRlbnQpCiAgICAgICAgcmV0dXJuOwoKICAgICAgdGhpcy5yZWZDb250ZW50XyA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5pdGVyYXRvcl8udmFsdWVDaGFuZ2VkKCk7CiAgICAgIHRoaXMuaXRlcmF0b3JfLnVwZGF0ZUl0ZXJhdGVkVmFsdWUodGhpcy5pdGVyYXRvcl8uZ2V0VXBkYXRlZFZhbHVlKCkpOwogICAgfSwKCiAgICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubW9kZWxfID0gdW5kZWZpbmVkOwogICAgICB0aGlzLmRlbGVnYXRlXyA9IHVuZGVmaW5lZDsKICAgICAgaWYgKHRoaXMuYmluZGluZ3NfICYmIHRoaXMuYmluZGluZ3NfLnJlZikKICAgICAgICB0aGlzLmJpbmRpbmdzXy5yZWYuY2xvc2UoKQogICAgICB0aGlzLnJlZkNvbnRlbnRfID0gdW5kZWZpbmVkOwogICAgICBpZiAoIXRoaXMuaXRlcmF0b3JfKQogICAgICAgIHJldHVybjsKICAgICAgdGhpcy5pdGVyYXRvcl8udmFsdWVDaGFuZ2VkKCk7CiAgICAgIHRoaXMuaXRlcmF0b3JfLmNsb3NlKCkKICAgICAgdGhpcy5pdGVyYXRvcl8gPSB1bmRlZmluZWQ7CiAgICB9LAoKICAgIHNldERlbGVnYXRlXzogZnVuY3Rpb24oZGVsZWdhdGUpIHsKICAgICAgdGhpcy5kZWxlZ2F0ZV8gPSBkZWxlZ2F0ZTsKICAgICAgdGhpcy5iaW5kaW5nTWFwXyA9IHVuZGVmaW5lZDsKICAgICAgaWYgKHRoaXMuaXRlcmF0b3JfKSB7CiAgICAgICAgdGhpcy5pdGVyYXRvcl8uaW5zdGFuY2VQb3NpdGlvbkNoYW5nZWRGbl8gPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5pdGVyYXRvcl8uaW5zdGFuY2VNb2RlbEZuXyA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgfSwKCiAgICBuZXdEZWxlZ2F0ZV86IGZ1bmN0aW9uKGJpbmRpbmdEZWxlZ2F0ZSkgewogICAgICBpZiAoIWJpbmRpbmdEZWxlZ2F0ZSkKICAgICAgICByZXR1cm47CgogICAgICBmdW5jdGlvbiBkZWxlZ2F0ZUZuKG5hbWUpIHsKICAgICAgICB2YXIgZm4gPSBiaW5kaW5nRGVsZWdhdGUgJiYgYmluZGluZ0RlbGVnYXRlW25hbWVdOwogICAgICAgIGlmICh0eXBlb2YgZm4gIT0gJ2Z1bmN0aW9uJykKICAgICAgICAgIHJldHVybjsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KGJpbmRpbmdEZWxlZ2F0ZSwgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGJpbmRpbmdNYXBzOiB7fSwKICAgICAgICByYXc6IGJpbmRpbmdEZWxlZ2F0ZSwKICAgICAgICBwcmVwYXJlQmluZGluZzogZGVsZWdhdGVGbigncHJlcGFyZUJpbmRpbmcnKSwKICAgICAgICBwcmVwYXJlSW5zdGFuY2VNb2RlbDogZGVsZWdhdGVGbigncHJlcGFyZUluc3RhbmNlTW9kZWwnKSwKICAgICAgICBwcmVwYXJlSW5zdGFuY2VQb3NpdGlvbkNoYW5nZWQ6CiAgICAgICAgICAgIGRlbGVnYXRlRm4oJ3ByZXBhcmVJbnN0YW5jZVBvc2l0aW9uQ2hhbmdlZCcpCiAgICAgIH07CiAgICB9LAoKICAgIHNldCBiaW5kaW5nRGVsZWdhdGUoYmluZGluZ0RlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLmRlbGVnYXRlXykgewogICAgICAgIHRocm93IEVycm9yKCdUZW1wbGF0ZSBtdXN0IGJlIGNsZWFyZWQgYmVmb3JlIGEgbmV3IGJpbmRpbmdEZWxlZ2F0ZSAnICsKICAgICAgICAgICAgICAgICAgICAnY2FuIGJlIGFzc2lnbmVkJyk7CiAgICAgIH0KCiAgICAgIHRoaXMuc2V0RGVsZWdhdGVfKHRoaXMubmV3RGVsZWdhdGVfKGJpbmRpbmdEZWxlZ2F0ZSkpOwogICAgfSwKCiAgICBnZXQgcmVmXygpIHsKICAgICAgdmFyIHJlZiA9IHNlYXJjaFJlZklkKHRoaXMsIHRoaXMuZ2V0QXR0cmlidXRlKCdyZWYnKSk7CiAgICAgIGlmICghcmVmKQogICAgICAgIHJlZiA9IHRoaXMuaW5zdGFuY2VSZWZfOwoKICAgICAgaWYgKCFyZWYpCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgICB2YXIgbmV4dFJlZiA9IHJlZi5yZWZfOwogICAgICByZXR1cm4gbmV4dFJlZiA/IG5leHRSZWYgOiByZWY7CiAgICB9CiAgfSk7CgogIC8vIFJldHVybnMKICAvLyAgIGEpIHVuZGVmaW5lZCBpZiB0aGVyZSBhcmUgbm8gbXVzdGFjaGVzLgogIC8vICAgYikgW1RFWFQsIChPTkVfVElNRT8sIFBBVEgsIERFTEVHQVRFX0ZOLCBURVhUKStdIGlmIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBtdXN0YWNoZS4KICBmdW5jdGlvbiBwYXJzZU11c3RhY2hlcyhzLCBuYW1lLCBub2RlLCBwcmVwYXJlQmluZGluZ0ZuKSB7CiAgICBpZiAoIXMgfHwgIXMubGVuZ3RoKQogICAgICByZXR1cm47CgogICAgdmFyIHRva2VuczsKICAgIHZhciBsZW5ndGggPSBzLmxlbmd0aDsKICAgIHZhciBzdGFydEluZGV4ID0gMCwgbGFzdEluZGV4ID0gMCwgZW5kSW5kZXggPSAwOwogICAgdmFyIG9ubHlPbmVUaW1lID0gdHJ1ZTsKICAgIHdoaWxlIChsYXN0SW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHN0YXJ0SW5kZXggPSBzLmluZGV4T2YoJ3t7JywgbGFzdEluZGV4KTsKICAgICAgdmFyIG9uZVRpbWVTdGFydCA9IHMuaW5kZXhPZignW1snLCBsYXN0SW5kZXgpOwogICAgICB2YXIgb25lVGltZSA9IGZhbHNlOwogICAgICB2YXIgdGVybWluYXRvciA9ICd9fSc7CgogICAgICBpZiAob25lVGltZVN0YXJ0ID49IDAgJiYKICAgICAgICAgIChzdGFydEluZGV4IDwgMCB8fCBvbmVUaW1lU3RhcnQgPCBzdGFydEluZGV4KSkgewogICAgICAgIHN0YXJ0SW5kZXggPSBvbmVUaW1lU3RhcnQ7CiAgICAgICAgb25lVGltZSA9IHRydWU7CiAgICAgICAgdGVybWluYXRvciA9ICddXSc7CiAgICAgIH0KCiAgICAgIGVuZEluZGV4ID0gc3RhcnRJbmRleCA8IDAgPyAtMSA6IHMuaW5kZXhPZih0ZXJtaW5hdG9yLCBzdGFydEluZGV4ICsgMik7CgogICAgICBpZiAoZW5kSW5kZXggPCAwKSB7CiAgICAgICAgaWYgKCF0b2tlbnMpCiAgICAgICAgICByZXR1cm47CgogICAgICAgIHRva2Vucy5wdXNoKHMuc2xpY2UobGFzdEluZGV4KSk7IC8vIFRFWFQKICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgdG9rZW5zID0gdG9rZW5zIHx8IFtdOwogICAgICB0b2tlbnMucHVzaChzLnNsaWNlKGxhc3RJbmRleCwgc3RhcnRJbmRleCkpOyAvLyBURVhUCiAgICAgIHZhciBwYXRoU3RyaW5nID0gcy5zbGljZShzdGFydEluZGV4ICsgMiwgZW5kSW5kZXgpLnRyaW0oKTsKICAgICAgdG9rZW5zLnB1c2gob25lVGltZSk7IC8vIE9ORV9USU1FPwogICAgICBvbmx5T25lVGltZSA9IG9ubHlPbmVUaW1lICYmIG9uZVRpbWU7CiAgICAgIHZhciBkZWxlZ2F0ZUZuID0gcHJlcGFyZUJpbmRpbmdGbiAmJgogICAgICAgICAgICAgICAgICAgICAgIHByZXBhcmVCaW5kaW5nRm4ocGF0aFN0cmluZywgbmFtZSwgbm9kZSk7CiAgICAgIC8vIERvbid0IHRyeSB0byBwYXJzZSB0aGUgZXhwcmVzc2lvbiBpZiB0aGVyZSdzIGEgcHJlcGFyZUJpbmRpbmcgZnVuY3Rpb24KICAgICAgaWYgKGRlbGVnYXRlRm4gPT0gbnVsbCkgewogICAgICAgIHRva2Vucy5wdXNoKFBhdGguZ2V0KHBhdGhTdHJpbmcpKTsgLy8gUEFUSAogICAgICB9IGVsc2UgewogICAgICAgIHRva2Vucy5wdXNoKG51bGwpOwogICAgICB9CiAgICAgIHRva2Vucy5wdXNoKGRlbGVnYXRlRm4pOyAvLyBERUxFR0FURV9GTgogICAgICBsYXN0SW5kZXggPSBlbmRJbmRleCArIDI7CiAgICB9CgogICAgaWYgKGxhc3RJbmRleCA9PT0gbGVuZ3RoKQogICAgICB0b2tlbnMucHVzaCgnJyk7IC8vIFRFWFQKCiAgICB0b2tlbnMuaGFzT25lUGF0aCA9IHRva2Vucy5sZW5ndGggPT09IDU7CiAgICB0b2tlbnMuaXNTaW1wbGVQYXRoID0gdG9rZW5zLmhhc09uZVBhdGggJiYKICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnNbMF0gPT0gJycgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnNbNF0gPT0gJyc7CiAgICB0b2tlbnMub25seU9uZVRpbWUgPSBvbmx5T25lVGltZTsKCiAgICB0b2tlbnMuY29tYmluYXRvciA9IGZ1bmN0aW9uKHZhbHVlcykgewogICAgICB2YXIgbmV3VmFsdWUgPSB0b2tlbnNbMF07CgogICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRva2Vucy5sZW5ndGg7IGkgKz0gNCkgewogICAgICAgIHZhciB2YWx1ZSA9IHRva2Vucy5oYXNPbmVQYXRoID8gdmFsdWVzIDogdmFsdWVzWyhpIC0gMSkgLyA0XTsKICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkKICAgICAgICAgIG5ld1ZhbHVlICs9IHZhbHVlOwogICAgICAgIG5ld1ZhbHVlICs9IHRva2Vuc1tpICsgM107CiAgICAgIH0KCiAgICAgIHJldHVybiBuZXdWYWx1ZTsKICAgIH0KCiAgICByZXR1cm4gdG9rZW5zOwogIH07CgogIGZ1bmN0aW9uIHByb2Nlc3NPbmVUaW1lQmluZGluZyhuYW1lLCB0b2tlbnMsIG5vZGUsIG1vZGVsKSB7CiAgICBpZiAodG9rZW5zLmhhc09uZVBhdGgpIHsKICAgICAgdmFyIGRlbGVnYXRlRm4gPSB0b2tlbnNbM107CiAgICAgIHZhciB2YWx1ZSA9IGRlbGVnYXRlRm4gPyBkZWxlZ2F0ZUZuKG1vZGVsLCBub2RlLCB0cnVlKSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnNbMl0uZ2V0VmFsdWVGcm9tKG1vZGVsKTsKICAgICAgcmV0dXJuIHRva2Vucy5pc1NpbXBsZVBhdGggPyB2YWx1ZSA6IHRva2Vucy5jb21iaW5hdG9yKHZhbHVlKTsKICAgIH0KCiAgICB2YXIgdmFsdWVzID0gW107CiAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRva2Vucy5sZW5ndGg7IGkgKz0gNCkgewogICAgICB2YXIgZGVsZWdhdGVGbiA9IHRva2Vuc1tpICsgMl07CiAgICAgIHZhbHVlc1soaSAtIDEpIC8gNF0gPSBkZWxlZ2F0ZUZuID8gZGVsZWdhdGVGbihtb2RlbCwgbm9kZSkgOgogICAgICAgICAgdG9rZW5zW2kgKyAxXS5nZXRWYWx1ZUZyb20obW9kZWwpOwogICAgfQoKICAgIHJldHVybiB0b2tlbnMuY29tYmluYXRvcih2YWx1ZXMpOwogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc1NpbmdsZVBhdGhCaW5kaW5nKG5hbWUsIHRva2Vucywgbm9kZSwgbW9kZWwpIHsKICAgIHZhciBkZWxlZ2F0ZUZuID0gdG9rZW5zWzNdOwogICAgdmFyIG9ic2VydmVyID0gZGVsZWdhdGVGbiA/IGRlbGVnYXRlRm4obW9kZWwsIG5vZGUsIGZhbHNlKSA6CiAgICAgICAgbmV3IFBhdGhPYnNlcnZlcihtb2RlbCwgdG9rZW5zWzJdKTsKCiAgICByZXR1cm4gdG9rZW5zLmlzU2ltcGxlUGF0aCA/IG9ic2VydmVyIDoKICAgICAgICBuZXcgT2JzZXJ2ZXJUcmFuc2Zvcm0ob2JzZXJ2ZXIsIHRva2Vucy5jb21iaW5hdG9yKTsKICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NCaW5kaW5nKG5hbWUsIHRva2Vucywgbm9kZSwgbW9kZWwpIHsKICAgIGlmICh0b2tlbnMub25seU9uZVRpbWUpCiAgICAgIHJldHVybiBwcm9jZXNzT25lVGltZUJpbmRpbmcobmFtZSwgdG9rZW5zLCBub2RlLCBtb2RlbCk7CgogICAgaWYgKHRva2Vucy5oYXNPbmVQYXRoKQogICAgICByZXR1cm4gcHJvY2Vzc1NpbmdsZVBhdGhCaW5kaW5nKG5hbWUsIHRva2Vucywgbm9kZSwgbW9kZWwpOwoKICAgIHZhciBvYnNlcnZlciA9IG5ldyBDb21wb3VuZE9ic2VydmVyKCk7CgogICAgZm9yICh2YXIgaSA9IDE7IGkgPCB0b2tlbnMubGVuZ3RoOyBpICs9IDQpIHsKICAgICAgdmFyIG9uZVRpbWUgPSB0b2tlbnNbaV07CiAgICAgIHZhciBkZWxlZ2F0ZUZuID0gdG9rZW5zW2kgKyAyXTsKCiAgICAgIGlmIChkZWxlZ2F0ZUZuKSB7CiAgICAgICAgdmFyIHZhbHVlID0gZGVsZWdhdGVGbihtb2RlbCwgbm9kZSwgb25lVGltZSk7CiAgICAgICAgaWYgKG9uZVRpbWUpCiAgICAgICAgICBvYnNlcnZlci5hZGRQYXRoKHZhbHVlKQogICAgICAgIGVsc2UKICAgICAgICAgIG9ic2VydmVyLmFkZE9ic2VydmVyKHZhbHVlKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgdmFyIHBhdGggPSB0b2tlbnNbaSArIDFdOwogICAgICBpZiAob25lVGltZSkKICAgICAgICBvYnNlcnZlci5hZGRQYXRoKHBhdGguZ2V0VmFsdWVGcm9tKG1vZGVsKSkKICAgICAgZWxzZQogICAgICAgIG9ic2VydmVyLmFkZFBhdGgobW9kZWwsIHBhdGgpOwogICAgfQoKICAgIHJldHVybiBuZXcgT2JzZXJ2ZXJUcmFuc2Zvcm0ob2JzZXJ2ZXIsIHRva2Vucy5jb21iaW5hdG9yKTsKICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NCaW5kaW5ncyhub2RlLCBiaW5kaW5ncywgbW9kZWwsIGluc3RhbmNlQmluZGluZ3MpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYmluZGluZ3MubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgdmFyIG5hbWUgPSBiaW5kaW5nc1tpXQogICAgICB2YXIgdG9rZW5zID0gYmluZGluZ3NbaSArIDFdOwogICAgICB2YXIgdmFsdWUgPSBwcm9jZXNzQmluZGluZyhuYW1lLCB0b2tlbnMsIG5vZGUsIG1vZGVsKTsKICAgICAgdmFyIGJpbmRpbmcgPSBub2RlLmJpbmQobmFtZSwgdmFsdWUsIHRva2Vucy5vbmx5T25lVGltZSk7CiAgICAgIGlmIChiaW5kaW5nICYmIGluc3RhbmNlQmluZGluZ3MpCiAgICAgICAgaW5zdGFuY2VCaW5kaW5ncy5wdXNoKGJpbmRpbmcpOwogICAgfQoKICAgIG5vZGUuYmluZEZpbmlzaGVkKCk7CiAgICBpZiAoIWJpbmRpbmdzLmlzVGVtcGxhdGUpCiAgICAgIHJldHVybjsKCiAgICBub2RlLm1vZGVsXyA9IG1vZGVsOwogICAgdmFyIGl0ZXIgPSBub2RlLnByb2Nlc3NCaW5kaW5nRGlyZWN0aXZlc18oYmluZGluZ3MpOwogICAgaWYgKGluc3RhbmNlQmluZGluZ3MgJiYgaXRlcikKICAgICAgaW5zdGFuY2VCaW5kaW5ncy5wdXNoKGl0ZXIpOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VXaXRoRGVmYXVsdChlbCwgbmFtZSwgcHJlcGFyZUJpbmRpbmdGbikgewogICAgdmFyIHYgPSBlbC5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICByZXR1cm4gcGFyc2VNdXN0YWNoZXModiA9PSAnJyA/ICd7e319JyA6IHYsIG5hbWUsIGVsLCBwcmVwYXJlQmluZGluZ0ZuKTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQXR0cmlidXRlQmluZGluZ3MoZWxlbWVudCwgcHJlcGFyZUJpbmRpbmdGbikgewogICAgYXNzZXJ0KGVsZW1lbnQpOwoKICAgIHZhciBiaW5kaW5ncyA9IFtdOwogICAgdmFyIGlmRm91bmQgPSBmYWxzZTsKICAgIHZhciBiaW5kRm91bmQgPSBmYWxzZTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVsZW1lbnQuYXR0cmlidXRlcy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgYXR0ciA9IGVsZW1lbnQuYXR0cmlidXRlc1tpXTsKICAgICAgdmFyIG5hbWUgPSBhdHRyLm5hbWU7CiAgICAgIHZhciB2YWx1ZSA9IGF0dHIudmFsdWU7CgogICAgICAvLyBBbGxvdyBiaW5kaW5ncyBleHByZXNzZWQgaW4gYXR0cmlidXRlcyB0byBiZSBwcmVmaXhlZCB3aXRoIHVuZGVyYmFycy4KICAgICAgLy8gV2UgZG8gdGhpcyB0byBhbGxvdyBjb3JyZWN0IHNlbWFudGljcyBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBpbXBsZW1lbnQKICAgICAgLy8gPHRlbXBsYXRlPiB3aGVyZSBjZXJ0YWluIGF0dHJpYnV0ZXMgbWlnaHQgdHJpZ2dlciBzaWRlLWVmZmVjdHMgLS0gYW5kCiAgICAgIC8vIGZvciBJRSB3aGljaCBzYW5pdGl6ZXMgY2VydGFpbiBhdHRyaWJ1dGVzLCBkaXNhbGxvd2luZyBtdXN0YWNoZQogICAgICAvLyByZXBsYWNlbWVudHMgaW4gdGhlaXIgdGV4dC4KICAgICAgd2hpbGUgKG5hbWVbMF0gPT09ICdfJykgewogICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cmluZygxKTsKICAgICAgfQoKICAgICAgaWYgKGlzVGVtcGxhdGUoZWxlbWVudCkgJiYKICAgICAgICAgIChuYW1lID09PSBJRiB8fCBuYW1lID09PSBCSU5EIHx8IG5hbWUgPT09IFJFUEVBVCkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgdmFyIHRva2VucyA9IHBhcnNlTXVzdGFjaGVzKHZhbHVlLCBuYW1lLCBlbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlcGFyZUJpbmRpbmdGbik7CiAgICAgIGlmICghdG9rZW5zKQogICAgICAgIGNvbnRpbnVlOwoKICAgICAgYmluZGluZ3MucHVzaChuYW1lLCB0b2tlbnMpOwogICAgfQoKICAgIGlmIChpc1RlbXBsYXRlKGVsZW1lbnQpKSB7CiAgICAgIGJpbmRpbmdzLmlzVGVtcGxhdGUgPSB0cnVlOwogICAgICBiaW5kaW5ncy5pZiA9IHBhcnNlV2l0aERlZmF1bHQoZWxlbWVudCwgSUYsIHByZXBhcmVCaW5kaW5nRm4pOwogICAgICBiaW5kaW5ncy5iaW5kID0gcGFyc2VXaXRoRGVmYXVsdChlbGVtZW50LCBCSU5ELCBwcmVwYXJlQmluZGluZ0ZuKTsKICAgICAgYmluZGluZ3MucmVwZWF0ID0gcGFyc2VXaXRoRGVmYXVsdChlbGVtZW50LCBSRVBFQVQsIHByZXBhcmVCaW5kaW5nRm4pOwoKICAgICAgaWYgKGJpbmRpbmdzLmlmICYmICFiaW5kaW5ncy5iaW5kICYmICFiaW5kaW5ncy5yZXBlYXQpCiAgICAgICAgYmluZGluZ3MuYmluZCA9IHBhcnNlTXVzdGFjaGVzKCd7e319JywgQklORCwgZWxlbWVudCwgcHJlcGFyZUJpbmRpbmdGbik7CiAgICB9CgogICAgcmV0dXJuIGJpbmRpbmdzOwogIH0KCiAgZnVuY3Rpb24gZ2V0QmluZGluZ3Mobm9kZSwgcHJlcGFyZUJpbmRpbmdGbikgewogICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFKQogICAgICByZXR1cm4gcGFyc2VBdHRyaWJ1dGVCaW5kaW5ncyhub2RlLCBwcmVwYXJlQmluZGluZ0ZuKTsKCiAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gTm9kZS5URVhUX05PREUpIHsKICAgICAgdmFyIHRva2VucyA9IHBhcnNlTXVzdGFjaGVzKG5vZGUuZGF0YSwgJ3RleHRDb250ZW50Jywgbm9kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXBhcmVCaW5kaW5nRm4pOwogICAgICBpZiAodG9rZW5zKQogICAgICAgIHJldHVybiBbJ3RleHRDb250ZW50JywgdG9rZW5zXTsKICAgIH0KCiAgICByZXR1cm4gW107CiAgfQoKICBmdW5jdGlvbiBjbG9uZUFuZEJpbmRJbnN0YW5jZShub2RlLCBwYXJlbnQsIHN0YWdpbmdEb2N1bWVudCwgYmluZGluZ3MsIG1vZGVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGVnYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlQmluZGluZ3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VSZWNvcmQpIHsKICAgIHZhciBjbG9uZSA9IHBhcmVudC5hcHBlbmRDaGlsZChzdGFnaW5nRG9jdW1lbnQuaW1wb3J0Tm9kZShub2RlLCBmYWxzZSkpOwoKICAgIHZhciBpID0gMDsKICAgIGZvciAodmFyIGNoaWxkID0gbm9kZS5maXJzdENoaWxkOyBjaGlsZDsgY2hpbGQgPSBjaGlsZC5uZXh0U2libGluZykgewogICAgICBjbG9uZUFuZEJpbmRJbnN0YW5jZShjaGlsZCwgY2xvbmUsIHN0YWdpbmdEb2N1bWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzLmNoaWxkcmVuW2krK10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGVnYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VCaW5kaW5ncyk7CiAgICB9CgogICAgaWYgKGJpbmRpbmdzLmlzVGVtcGxhdGUpIHsKICAgICAgSFRNTFRlbXBsYXRlRWxlbWVudC5kZWNvcmF0ZShjbG9uZSwgbm9kZSk7CiAgICAgIGlmIChkZWxlZ2F0ZSkKICAgICAgICBjbG9uZS5zZXREZWxlZ2F0ZV8oZGVsZWdhdGUpOwogICAgfQoKICAgIHByb2Nlc3NCaW5kaW5ncyhjbG9uZSwgYmluZGluZ3MsIG1vZGVsLCBpbnN0YW5jZUJpbmRpbmdzKTsKICAgIHJldHVybiBjbG9uZTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlQmluZGluZ01hcChub2RlLCBwcmVwYXJlQmluZGluZ0ZuKSB7CiAgICB2YXIgbWFwID0gZ2V0QmluZGluZ3Mobm9kZSwgcHJlcGFyZUJpbmRpbmdGbik7CiAgICBtYXAuY2hpbGRyZW4gPSB7fTsKICAgIHZhciBpbmRleCA9IDA7CiAgICBmb3IgKHZhciBjaGlsZCA9IG5vZGUuZmlyc3RDaGlsZDsgY2hpbGQ7IGNoaWxkID0gY2hpbGQubmV4dFNpYmxpbmcpIHsKICAgICAgbWFwLmNoaWxkcmVuW2luZGV4KytdID0gY3JlYXRlSW5zdGFuY2VCaW5kaW5nTWFwKGNoaWxkLCBwcmVwYXJlQmluZGluZ0ZuKTsKICAgIH0KCiAgICByZXR1cm4gbWFwOwogIH0KCiAgdmFyIGNvbnRlbnRVaWRDb3VudGVyID0gMTsKCiAgLy8gVE9ETyhyYWZhZWx3KTogU2V0dXAgYSBNdXRhdGlvbk9ic2VydmVyIG9uIGNvbnRlbnQgd2hpY2ggY2xlYXJzIHRoZSBpZAogIC8vIHNvIHRoYXQgYmluZGluZ01hcHMgcmVnZW5lcmF0ZSB3aGVuIHRoZSB0ZW1wbGF0ZS5jb250ZW50IGNoYW5nZXMuCiAgZnVuY3Rpb24gZ2V0Q29udGVudFVpZChjb250ZW50KSB7CiAgICB2YXIgaWQgPSBjb250ZW50LmlkXzsKICAgIGlmICghaWQpCiAgICAgIGlkID0gY29udGVudC5pZF8gPSBjb250ZW50VWlkQ291bnRlcisrOwogICAgcmV0dXJuIGlkOwogIH0KCiAgLy8gRWFjaCBkZWxlZ2F0ZSBpcyBhc3NvY2lhdGVkIHdpdGggYSBzZXQgb2YgYmluZGluZ01hcHMsIG9uZSBmb3IgZWFjaAogIC8vIGNvbnRlbnQgd2hpY2ggbWF5IGJlIHVzZWQgYnkgYSB0ZW1wbGF0ZS4gVGhlIGludGVudCBpcyB0aGF0IGVhY2ggYmluZGluZwogIC8vIGRlbGVnYXRlIGdldHMgdGhlIG9wcG9ydHVuaXR5IHRvIHByZXBhcmUgdGhlIGluc3RhbmNlICh2aWEgdGhlIHByZXBhcmUqCiAgLy8gZGVsZWdhdGUgY2FsbHMpIG9uY2UgYWNyb3NzIGFsbCB1c2VzLgogIC8vIFRPRE8ocmFmYWVsdyk6IFNlcGFyYXRlIG91dCB0aGUgcGFyc2UgbWFwIGZyb20gdGhlIGJpbmRpbmcgbWFwLiBJbiB0aGUKICAvLyBjdXJyZW50IGltcGxlbWVudGF0aW9uLCBpZiB0d28gZGVsZWdhdGVzIG5lZWQgYSBiaW5kaW5nIG1hcCBmb3IgdGhlIHNhbWUKICAvLyBjb250ZW50LCB0aGUgc2Vjb25kIHdpbGwgaGF2ZSB0byByZXBhcnNlLgogIGZ1bmN0aW9uIGdldEluc3RhbmNlQmluZGluZ01hcChjb250ZW50LCBkZWxlZ2F0ZV8pIHsKICAgIHZhciBjb250ZW50SWQgPSBnZXRDb250ZW50VWlkKGNvbnRlbnQpOwogICAgaWYgKGRlbGVnYXRlXykgewogICAgICB2YXIgbWFwID0gZGVsZWdhdGVfLmJpbmRpbmdNYXBzW2NvbnRlbnRJZF07CiAgICAgIGlmICghbWFwKSB7CiAgICAgICAgbWFwID0gZGVsZWdhdGVfLmJpbmRpbmdNYXBzW2NvbnRlbnRJZF0gPQogICAgICAgICAgICBjcmVhdGVJbnN0YW5jZUJpbmRpbmdNYXAoY29udGVudCwgZGVsZWdhdGVfLnByZXBhcmVCaW5kaW5nKSB8fCBbXTsKICAgICAgfQogICAgICByZXR1cm4gbWFwOwogICAgfQoKICAgIHZhciBtYXAgPSBjb250ZW50LmJpbmRpbmdNYXBfOwogICAgaWYgKCFtYXApIHsKICAgICAgbWFwID0gY29udGVudC5iaW5kaW5nTWFwXyA9CiAgICAgICAgICBjcmVhdGVJbnN0YW5jZUJpbmRpbmdNYXAoY29udGVudCwgdW5kZWZpbmVkKSB8fCBbXTsKICAgIH0KICAgIHJldHVybiBtYXA7CiAgfQoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTm9kZS5wcm90b3R5cGUsICd0ZW1wbGF0ZUluc3RhbmNlJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGluc3RhbmNlID0gdGhpcy50ZW1wbGF0ZUluc3RhbmNlXzsKICAgICAgcmV0dXJuIGluc3RhbmNlID8gaW5zdGFuY2UgOgogICAgICAgICAgKHRoaXMucGFyZW50Tm9kZSA/IHRoaXMucGFyZW50Tm9kZS50ZW1wbGF0ZUluc3RhbmNlIDogdW5kZWZpbmVkKTsKICAgIH0KICB9KTsKCiAgdmFyIGVtcHR5SW5zdGFuY2UgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgZW1wdHlJbnN0YW5jZS5iaW5kaW5nc18gPSBbXTsKICBlbXB0eUluc3RhbmNlLnRlcm1pbmF0b3JfID0gbnVsbDsKCiAgZnVuY3Rpb24gVGVtcGxhdGVJdGVyYXRvcih0ZW1wbGF0ZUVsZW1lbnQpIHsKICAgIHRoaXMuY2xvc2VkID0gZmFsc2U7CiAgICB0aGlzLnRlbXBsYXRlRWxlbWVudF8gPSB0ZW1wbGF0ZUVsZW1lbnQ7CiAgICB0aGlzLmluc3RhbmNlcyA9IFtdOwogICAgdGhpcy5kZXBzID0gdW5kZWZpbmVkOwogICAgdGhpcy5pdGVyYXRlZFZhbHVlID0gW107CiAgICB0aGlzLnByZXNlbnRWYWx1ZSA9IHVuZGVmaW5lZDsKICAgIHRoaXMuYXJyYXlPYnNlcnZlciA9IHVuZGVmaW5lZDsKICB9CgogIFRlbXBsYXRlSXRlcmF0b3IucHJvdG90eXBlID0gewogICAgY2xvc2VEZXBzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGRlcHMgPSB0aGlzLmRlcHM7CiAgICAgIGlmIChkZXBzKSB7CiAgICAgICAgaWYgKGRlcHMuaWZPbmVUaW1lID09PSBmYWxzZSkKICAgICAgICAgIGRlcHMuaWZWYWx1ZS5jbG9zZSgpOwogICAgICAgIGlmIChkZXBzLm9uZVRpbWUgPT09IGZhbHNlKQogICAgICAgICAgZGVwcy52YWx1ZS5jbG9zZSgpOwogICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZURlcGVuZGVuY2llczogZnVuY3Rpb24oZGlyZWN0aXZlcywgbW9kZWwpIHsKICAgICAgdGhpcy5jbG9zZURlcHMoKTsKCiAgICAgIHZhciBkZXBzID0gdGhpcy5kZXBzID0ge307CiAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGVFbGVtZW50XzsKCiAgICAgIHZhciBpZlZhbHVlID0gdHJ1ZTsKICAgICAgaWYgKGRpcmVjdGl2ZXMuaWYpIHsKICAgICAgICBkZXBzLmhhc0lmID0gdHJ1ZTsKICAgICAgICBkZXBzLmlmT25lVGltZSA9IGRpcmVjdGl2ZXMuaWYub25seU9uZVRpbWU7CiAgICAgICAgZGVwcy5pZlZhbHVlID0gcHJvY2Vzc0JpbmRpbmcoSUYsIGRpcmVjdGl2ZXMuaWYsIHRlbXBsYXRlLCBtb2RlbCk7CgogICAgICAgIGlmVmFsdWUgPSBkZXBzLmlmVmFsdWU7CgogICAgICAgIC8vIG9uZVRpbWUgaWYgJiBwcmVkaWNhdGUgaXMgZmFsc2UuIG5vdGhpbmcgZWxzZSB0byBkby4KICAgICAgICBpZiAoZGVwcy5pZk9uZVRpbWUgJiYgIWlmVmFsdWUpIHsKICAgICAgICAgIHRoaXMudmFsdWVDaGFuZ2VkKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoIWRlcHMuaWZPbmVUaW1lKQogICAgICAgICAgaWZWYWx1ZSA9IGlmVmFsdWUub3Blbih0aGlzLnVwZGF0ZUlmVmFsdWUsIHRoaXMpOwogICAgICB9CgogICAgICBpZiAoZGlyZWN0aXZlcy5yZXBlYXQpIHsKICAgICAgICBkZXBzLnJlcGVhdCA9IHRydWU7CiAgICAgICAgZGVwcy5vbmVUaW1lID0gZGlyZWN0aXZlcy5yZXBlYXQub25seU9uZVRpbWU7CiAgICAgICAgZGVwcy52YWx1ZSA9IHByb2Nlc3NCaW5kaW5nKFJFUEVBVCwgZGlyZWN0aXZlcy5yZXBlYXQsIHRlbXBsYXRlLCBtb2RlbCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVwcy5yZXBlYXQgPSBmYWxzZTsKICAgICAgICBkZXBzLm9uZVRpbWUgPSBkaXJlY3RpdmVzLmJpbmQub25seU9uZVRpbWU7CiAgICAgICAgZGVwcy52YWx1ZSA9IHByb2Nlc3NCaW5kaW5nKEJJTkQsIGRpcmVjdGl2ZXMuYmluZCwgdGVtcGxhdGUsIG1vZGVsKTsKICAgICAgfQoKICAgICAgdmFyIHZhbHVlID0gZGVwcy52YWx1ZTsKICAgICAgaWYgKCFkZXBzLm9uZVRpbWUpCiAgICAgICAgdmFsdWUgPSB2YWx1ZS5vcGVuKHRoaXMudXBkYXRlSXRlcmF0ZWRWYWx1ZSwgdGhpcyk7CgogICAgICBpZiAoIWlmVmFsdWUpIHsKICAgICAgICB0aGlzLnZhbHVlQ2hhbmdlZCgpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy51cGRhdGVWYWx1ZSh2YWx1ZSk7CiAgICB9LAoKICAgIC8qKgogICAgICogR2V0cyB0aGUgdXBkYXRlZCB2YWx1ZSBvZiB0aGUgYmluZC9yZXBlYXQuIFRoaXMgY2FuIHBvdGVudGlhbGx5IGNhbGwKICAgICAqIHVzZXIgY29kZSAoaWYgYSBiaW5kaW5nRGVsZWdhdGUgaXMgc2V0IHVwKSBzbyB3ZSB0cnkgdG8gYXZvaWQgaXQgaWYgd2UKICAgICAqIGFscmVhZHkgaGF2ZSB0aGUgdmFsdWUgaW4gaGFuZCAoZnJvbSBPYnNlcnZlci5vcGVuKS4KICAgICAqLwogICAgZ2V0VXBkYXRlZFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5kZXBzLnZhbHVlOwogICAgICBpZiAoIXRoaXMuZGVwcy5vbmVUaW1lKQogICAgICAgIHZhbHVlID0gdmFsdWUuZGlzY2FyZENoYW5nZXMoKTsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSwKCiAgICB1cGRhdGVJZlZhbHVlOiBmdW5jdGlvbihpZlZhbHVlKSB7CiAgICAgIGlmICghaWZWYWx1ZSkgewogICAgICAgIHRoaXMudmFsdWVDaGFuZ2VkKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLnVwZGF0ZVZhbHVlKHRoaXMuZ2V0VXBkYXRlZFZhbHVlKCkpOwogICAgfSwKCiAgICB1cGRhdGVJdGVyYXRlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodGhpcy5kZXBzLmhhc0lmKSB7CiAgICAgICAgdmFyIGlmVmFsdWUgPSB0aGlzLmRlcHMuaWZWYWx1ZTsKICAgICAgICBpZiAoIXRoaXMuZGVwcy5pZk9uZVRpbWUpCiAgICAgICAgICBpZlZhbHVlID0gaWZWYWx1ZS5kaXNjYXJkQ2hhbmdlcygpOwogICAgICAgIGlmICghaWZWYWx1ZSkgewogICAgICAgICAgdGhpcy52YWx1ZUNoYW5nZWQoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMudXBkYXRlVmFsdWUodmFsdWUpOwogICAgfSwKCiAgICB1cGRhdGVWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKCF0aGlzLmRlcHMucmVwZWF0KQogICAgICAgIHZhbHVlID0gW3ZhbHVlXTsKICAgICAgdmFyIG9ic2VydmUgPSB0aGlzLmRlcHMucmVwZWF0ICYmCiAgICAgICAgICAgICAgICAgICAgIXRoaXMuZGVwcy5vbmVUaW1lICYmCiAgICAgICAgICAgICAgICAgICAgQXJyYXkuaXNBcnJheSh2YWx1ZSk7CiAgICAgIHRoaXMudmFsdWVDaGFuZ2VkKHZhbHVlLCBvYnNlcnZlKTsKICAgIH0sCgogICAgdmFsdWVDaGFuZ2VkOiBmdW5jdGlvbih2YWx1ZSwgb2JzZXJ2ZVZhbHVlKSB7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkpCiAgICAgICAgdmFsdWUgPSBbXTsKCiAgICAgIGlmICh2YWx1ZSA9PT0gdGhpcy5pdGVyYXRlZFZhbHVlKQogICAgICAgIHJldHVybjsKCiAgICAgIHRoaXMudW5vYnNlcnZlKCk7CiAgICAgIHRoaXMucHJlc2VudFZhbHVlID0gdmFsdWU7CiAgICAgIGlmIChvYnNlcnZlVmFsdWUpIHsKICAgICAgICB0aGlzLmFycmF5T2JzZXJ2ZXIgPSBuZXcgQXJyYXlPYnNlcnZlcih0aGlzLnByZXNlbnRWYWx1ZSk7CiAgICAgICAgdGhpcy5hcnJheU9ic2VydmVyLm9wZW4odGhpcy5oYW5kbGVTcGxpY2VzLCB0aGlzKTsKICAgICAgfQoKICAgICAgdGhpcy5oYW5kbGVTcGxpY2VzKEFycmF5T2JzZXJ2ZXIuY2FsY3VsYXRlU3BsaWNlcyh0aGlzLnByZXNlbnRWYWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZXJhdGVkVmFsdWUpKTsKICAgIH0sCgogICAgZ2V0TGFzdEluc3RhbmNlTm9kZTogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgaWYgKGluZGV4ID09IC0xKQogICAgICAgIHJldHVybiB0aGlzLnRlbXBsYXRlRWxlbWVudF87CiAgICAgIHZhciBpbnN0YW5jZSA9IHRoaXMuaW5zdGFuY2VzW2luZGV4XTsKICAgICAgdmFyIHRlcm1pbmF0b3IgPSBpbnN0YW5jZS50ZXJtaW5hdG9yXzsKICAgICAgaWYgKCF0ZXJtaW5hdG9yKQogICAgICAgIHJldHVybiB0aGlzLmdldExhc3RJbnN0YW5jZU5vZGUoaW5kZXggLSAxKTsKCiAgICAgIGlmICh0ZXJtaW5hdG9yLm5vZGVUeXBlICE9PSBOb2RlLkVMRU1FTlRfTk9ERSB8fAogICAgICAgICAgdGhpcy50ZW1wbGF0ZUVsZW1lbnRfID09PSB0ZXJtaW5hdG9yKSB7CiAgICAgICAgcmV0dXJuIHRlcm1pbmF0b3I7CiAgICAgIH0KCiAgICAgIHZhciBzdWJ0ZW1wbGF0ZUl0ZXJhdG9yID0gdGVybWluYXRvci5pdGVyYXRvcl87CiAgICAgIGlmICghc3VidGVtcGxhdGVJdGVyYXRvcikKICAgICAgICByZXR1cm4gdGVybWluYXRvcjsKCiAgICAgIHJldHVybiBzdWJ0ZW1wbGF0ZUl0ZXJhdG9yLmdldExhc3RUZW1wbGF0ZU5vZGUoKTsKICAgIH0sCgogICAgZ2V0TGFzdFRlbXBsYXRlTm9kZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmdldExhc3RJbnN0YW5jZU5vZGUodGhpcy5pbnN0YW5jZXMubGVuZ3RoIC0gMSk7CiAgICB9LAoKICAgIGluc2VydEluc3RhbmNlQXQ6IGZ1bmN0aW9uKGluZGV4LCBmcmFnbWVudCkgewogICAgICB2YXIgcHJldmlvdXNJbnN0YW5jZUxhc3QgPSB0aGlzLmdldExhc3RJbnN0YW5jZU5vZGUoaW5kZXggLSAxKTsKICAgICAgdmFyIHBhcmVudCA9IHRoaXMudGVtcGxhdGVFbGVtZW50Xy5wYXJlbnROb2RlOwogICAgICB0aGlzLmluc3RhbmNlcy5zcGxpY2UoaW5kZXgsIDAsIGZyYWdtZW50KTsKCiAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUoZnJhZ21lbnQsIHByZXZpb3VzSW5zdGFuY2VMYXN0Lm5leHRTaWJsaW5nKTsKICAgIH0sCgogICAgZXh0cmFjdEluc3RhbmNlQXQ6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgIHZhciBwcmV2aW91c0luc3RhbmNlTGFzdCA9IHRoaXMuZ2V0TGFzdEluc3RhbmNlTm9kZShpbmRleCAtIDEpOwogICAgICB2YXIgbGFzdE5vZGUgPSB0aGlzLmdldExhc3RJbnN0YW5jZU5vZGUoaW5kZXgpOwogICAgICB2YXIgcGFyZW50ID0gdGhpcy50ZW1wbGF0ZUVsZW1lbnRfLnBhcmVudE5vZGU7CiAgICAgIHZhciBpbnN0YW5jZSA9IHRoaXMuaW5zdGFuY2VzLnNwbGljZShpbmRleCwgMSlbMF07CgogICAgICB3aGlsZSAobGFzdE5vZGUgIT09IHByZXZpb3VzSW5zdGFuY2VMYXN0KSB7CiAgICAgICAgdmFyIG5vZGUgPSBwcmV2aW91c0luc3RhbmNlTGFzdC5uZXh0U2libGluZzsKICAgICAgICBpZiAobm9kZSA9PSBsYXN0Tm9kZSkKICAgICAgICAgIGxhc3ROb2RlID0gcHJldmlvdXNJbnN0YW5jZUxhc3Q7CgogICAgICAgIGluc3RhbmNlLmFwcGVuZENoaWxkKHBhcmVudC5yZW1vdmVDaGlsZChub2RlKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgIH0sCgogICAgZ2V0RGVsZWdhdGVGbjogZnVuY3Rpb24oZm4pIHsKICAgICAgZm4gPSBmbiAmJiBmbih0aGlzLnRlbXBsYXRlRWxlbWVudF8pOwogICAgICByZXR1cm4gdHlwZW9mIGZuID09PSAnZnVuY3Rpb24nID8gZm4gOiBudWxsOwogICAgfSwKCiAgICBoYW5kbGVTcGxpY2VzOiBmdW5jdGlvbihzcGxpY2VzKSB7CiAgICAgIGlmICh0aGlzLmNsb3NlZCB8fCAhc3BsaWNlcy5sZW5ndGgpCiAgICAgICAgcmV0dXJuOwoKICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy50ZW1wbGF0ZUVsZW1lbnRfOwoKICAgICAgaWYgKCF0ZW1wbGF0ZS5wYXJlbnROb2RlKSB7CiAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgQXJyYXlPYnNlcnZlci5hcHBseVNwbGljZXModGhpcy5pdGVyYXRlZFZhbHVlLCB0aGlzLnByZXNlbnRWYWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BsaWNlcyk7CgogICAgICB2YXIgZGVsZWdhdGUgPSB0ZW1wbGF0ZS5kZWxlZ2F0ZV87CiAgICAgIGlmICh0aGlzLmluc3RhbmNlTW9kZWxGbl8gPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuaW5zdGFuY2VNb2RlbEZuXyA9CiAgICAgICAgICAgIHRoaXMuZ2V0RGVsZWdhdGVGbihkZWxlZ2F0ZSAmJiBkZWxlZ2F0ZS5wcmVwYXJlSW5zdGFuY2VNb2RlbCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmluc3RhbmNlUG9zaXRpb25DaGFuZ2VkRm5fID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLmluc3RhbmNlUG9zaXRpb25DaGFuZ2VkRm5fID0KICAgICAgICAgICAgdGhpcy5nZXREZWxlZ2F0ZUZuKGRlbGVnYXRlICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxlZ2F0ZS5wcmVwYXJlSW5zdGFuY2VQb3NpdGlvbkNoYW5nZWQpOwogICAgICB9CgogICAgICAvLyBJbnN0YW5jZSBSZW1vdmFscwogICAgICB2YXIgaW5zdGFuY2VDYWNoZSA9IG5ldyBNYXA7CiAgICAgIHZhciByZW1vdmVEZWx0YSA9IDA7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3BsaWNlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBzcGxpY2UgPSBzcGxpY2VzW2ldOwogICAgICAgIHZhciByZW1vdmVkID0gc3BsaWNlLnJlbW92ZWQ7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCByZW1vdmVkLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICB2YXIgbW9kZWwgPSByZW1vdmVkW2pdOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gdGhpcy5leHRyYWN0SW5zdGFuY2VBdChzcGxpY2UuaW5kZXggKyByZW1vdmVEZWx0YSk7CiAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IGVtcHR5SW5zdGFuY2UpIHsKICAgICAgICAgICAgaW5zdGFuY2VDYWNoZS5zZXQobW9kZWwsIGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJlbW92ZURlbHRhIC09IHNwbGljZS5hZGRlZENvdW50OwogICAgICB9CgogICAgICAvLyBJbnN0YW5jZSBJbnNlcnRpb25zCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3BsaWNlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBzcGxpY2UgPSBzcGxpY2VzW2ldOwogICAgICAgIHZhciBhZGRJbmRleCA9IHNwbGljZS5pbmRleDsKICAgICAgICBmb3IgKDsgYWRkSW5kZXggPCBzcGxpY2UuaW5kZXggKyBzcGxpY2UuYWRkZWRDb3VudDsgYWRkSW5kZXgrKykgewogICAgICAgICAgdmFyIG1vZGVsID0gdGhpcy5pdGVyYXRlZFZhbHVlW2FkZEluZGV4XTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGluc3RhbmNlQ2FjaGUuZ2V0KG1vZGVsKTsKICAgICAgICAgIGlmIChpbnN0YW5jZSkgewogICAgICAgICAgICBpbnN0YW5jZUNhY2hlLmRlbGV0ZShtb2RlbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGhpcy5pbnN0YW5jZU1vZGVsRm5fKSB7CiAgICAgICAgICAgICAgbW9kZWwgPSB0aGlzLmluc3RhbmNlTW9kZWxGbl8obW9kZWwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobW9kZWwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGluc3RhbmNlID0gZW1wdHlJbnN0YW5jZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpbnN0YW5jZSA9IHRlbXBsYXRlLmNyZWF0ZUluc3RhbmNlKG1vZGVsLCB1bmRlZmluZWQsIGRlbGVnYXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMuaW5zZXJ0SW5zdGFuY2VBdChhZGRJbmRleCwgaW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaW5zdGFuY2VDYWNoZS5mb3JFYWNoKGZ1bmN0aW9uKGluc3RhbmNlKSB7CiAgICAgICAgdGhpcy5jbG9zZUluc3RhbmNlQmluZGluZ3MoaW5zdGFuY2UpOwogICAgICB9LCB0aGlzKTsKCiAgICAgIGlmICh0aGlzLmluc3RhbmNlUG9zaXRpb25DaGFuZ2VkRm5fKQogICAgICAgIHRoaXMucmVwb3J0SW5zdGFuY2VzTW92ZWQoc3BsaWNlcyk7CiAgICB9LAoKICAgIHJlcG9ydEluc3RhbmNlTW92ZWQ6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgIHZhciBpbnN0YW5jZSA9IHRoaXMuaW5zdGFuY2VzW2luZGV4XTsKICAgICAgaWYgKGluc3RhbmNlID09PSBlbXB0eUluc3RhbmNlKQogICAgICAgIHJldHVybjsKCiAgICAgIHRoaXMuaW5zdGFuY2VQb3NpdGlvbkNoYW5nZWRGbl8oaW5zdGFuY2UudGVtcGxhdGVJbnN0YW5jZV8sIGluZGV4KTsKICAgIH0sCgogICAgcmVwb3J0SW5zdGFuY2VzTW92ZWQ6IGZ1bmN0aW9uKHNwbGljZXMpIHsKICAgICAgdmFyIGluZGV4ID0gMDsKICAgICAgdmFyIG9mZnNldCA9IDA7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3BsaWNlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBzcGxpY2UgPSBzcGxpY2VzW2ldOwogICAgICAgIGlmIChvZmZzZXQgIT0gMCkgewogICAgICAgICAgd2hpbGUgKGluZGV4IDwgc3BsaWNlLmluZGV4KSB7CiAgICAgICAgICAgIHRoaXMucmVwb3J0SW5zdGFuY2VNb3ZlZChpbmRleCk7CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGluZGV4ID0gc3BsaWNlLmluZGV4OwogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKGluZGV4IDwgc3BsaWNlLmluZGV4ICsgc3BsaWNlLmFkZGVkQ291bnQpIHsKICAgICAgICAgIHRoaXMucmVwb3J0SW5zdGFuY2VNb3ZlZChpbmRleCk7CiAgICAgICAgICBpbmRleCsrOwogICAgICAgIH0KCiAgICAgICAgb2Zmc2V0ICs9IHNwbGljZS5hZGRlZENvdW50IC0gc3BsaWNlLnJlbW92ZWQubGVuZ3RoOwogICAgICB9CgogICAgICBpZiAob2Zmc2V0ID09IDApCiAgICAgICAgcmV0dXJuOwoKICAgICAgdmFyIGxlbmd0aCA9IHRoaXMuaW5zdGFuY2VzLmxlbmd0aDsKICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdGhpcy5yZXBvcnRJbnN0YW5jZU1vdmVkKGluZGV4KTsKICAgICAgICBpbmRleCsrOwogICAgICB9CiAgICB9LAoKICAgIGNsb3NlSW5zdGFuY2VCaW5kaW5nczogZnVuY3Rpb24oaW5zdGFuY2UpIHsKICAgICAgdmFyIGJpbmRpbmdzID0gaW5zdGFuY2UuYmluZGluZ3NfOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJpbmRpbmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYmluZGluZ3NbaV0uY2xvc2UoKTsKICAgICAgfQogICAgfSwKCiAgICB1bm9ic2VydmU6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMuYXJyYXlPYnNlcnZlcikKICAgICAgICByZXR1cm47CgogICAgICB0aGlzLmFycmF5T2JzZXJ2ZXIuY2xvc2UoKTsKICAgICAgdGhpcy5hcnJheU9ic2VydmVyID0gdW5kZWZpbmVkOwogICAgfSwKCiAgICBjbG9zZTogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmNsb3NlZCkKICAgICAgICByZXR1cm47CiAgICAgIHRoaXMudW5vYnNlcnZlKCk7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5pbnN0YW5jZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLmNsb3NlSW5zdGFuY2VCaW5kaW5ncyh0aGlzLmluc3RhbmNlc1tpXSk7CiAgICAgIH0KCiAgICAgIHRoaXMuaW5zdGFuY2VzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMuY2xvc2VEZXBzKCk7CiAgICAgIHRoaXMudGVtcGxhdGVFbGVtZW50Xy5pdGVyYXRvcl8gPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuY2xvc2VkID0gdHJ1ZTsKICAgIH0KICB9OwoKICAvLyBQb2x5ZmlsbC1zcGVjaWZpYyBBUEkuCiAgSFRNTFRlbXBsYXRlRWxlbWVudC5mb3JBbGxUZW1wbGF0ZXNGcm9tXyA9IGZvckFsbFRlbXBsYXRlc0Zyb207Cn0pKHRoaXMpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 09:35:20 GMT",
                    "Content-Length": "38141",
                    "Date": "Fri, 07 Nov 2014 09:35:20 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}