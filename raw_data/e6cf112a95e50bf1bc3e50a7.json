{
    "url": "http://localhost:9999/x-tag/slidebox/demo/x-tag-components.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>document.URL</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statement:<ul><li>base.setAttribute('href', document.baseURI || document.URL);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/x-tag/slidebox/demo/x-tag-components.js",
                "path": "/x-tag/slidebox/demo/x-tag-components.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC94LXRhZy9zbGlkZWJveC9kZW1vL3gtdGFnLWNvbXBvbmVudHMuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogOTI2MTQNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDM6NDQ6NTIgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAzOjQ0OjUyIEdNVA0KDQovLyBXZSBkb24ndCB1c2UgdGhlIHBsYXRmb3JtIGJvb3RzdHJhcHBlciwgc28gZmFrZSB0aGlzIHN0dWZmLgoKd2luZG93LlBsYXRmb3JtID0ge307CnZhciBsb2dGbGFncyA9IHt9OwoKCgovLyBET01Ub2tlbkxpc3QgcG9seWZpbGwgZmlyIElFOQooZnVuY3Rpb24gKCkgewoKaWYgKHR5cGVvZiB3aW5kb3cuRWxlbWVudCA9PT0gInVuZGVmaW5lZCIgfHwgImNsYXNzTGlzdCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSByZXR1cm47Cgp2YXIgcHJvdG90eXBlID0gQXJyYXkucHJvdG90eXBlLAogICAgaW5kZXhPZiA9IHByb3RvdHlwZS5pbmRleE9mLAogICAgc2xpY2UgPSBwcm90b3R5cGUuc2xpY2UsCiAgICBwdXNoID0gcHJvdG90eXBlLnB1c2gsCiAgICBzcGxpY2UgPSBwcm90b3R5cGUuc3BsaWNlLAogICAgam9pbiA9IHByb3RvdHlwZS5qb2luOwoKZnVuY3Rpb24gRE9NVG9rZW5MaXN0KGVsKSB7CiAgdGhpcy5fZWxlbWVudCA9IGVsOwogIGlmIChlbC5jbGFzc05hbWUgIT0gdGhpcy5fY2xhc3NDYWNoZSkgewogICAgdGhpcy5fY2xhc3NDYWNoZSA9IGVsLmNsYXNzTmFtZTsKCiAgICBpZiAoIXRoaXMuX2NsYXNzQ2FjaGUpIHJldHVybjsKCiAgICAgIC8vIFRoZSBjbGFzc05hbWUgbmVlZHMgdG8gYmUgdHJpbW1lZCBhbmQgc3BsaXQgb24gd2hpdGVzcGFjZQogICAgICAvLyB0byByZXRyaWV2ZSBhIGxpc3Qgb2YgY2xhc3Nlcy4KICAgICAgdmFyIGNsYXNzZXMgPSB0aGlzLl9jbGFzc0NhY2hlLnJlcGxhY2UoL15ccyt8XHMrJC9nLCcnKS5zcGxpdCgvXHMrLyksCiAgICAgICAgaTsKICAgIGZvciAoaSA9IDA7IGkgPCBjbGFzc2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHB1c2guY2FsbCh0aGlzLCBjbGFzc2VzW2ldKTsKICAgIH0KICB9Cn07CgpmdW5jdGlvbiBzZXRUb0NsYXNzTmFtZShlbCwgY2xhc3NlcykgewogIGVsLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbignICcpOwp9CgpET01Ub2tlbkxpc3QucHJvdG90eXBlID0gewogIGFkZDogZnVuY3Rpb24odG9rZW4pIHsKICAgIGlmKHRoaXMuY29udGFpbnModG9rZW4pKSByZXR1cm47CiAgICBwdXNoLmNhbGwodGhpcywgdG9rZW4pOwogICAgc2V0VG9DbGFzc05hbWUodGhpcy5fZWxlbWVudCwgc2xpY2UuY2FsbCh0aGlzLCAwKSk7CiAgfSwKICBjb250YWluczogZnVuY3Rpb24odG9rZW4pIHsKICAgIHJldHVybiBpbmRleE9mLmNhbGwodGhpcywgdG9rZW4pICE9PSAtMTsKICB9LAogIGl0ZW06IGZ1bmN0aW9uKGluZGV4KSB7CiAgICByZXR1cm4gdGhpc1tpbmRleF0gfHwgbnVsbDsKICB9LAogIHJlbW92ZTogZnVuY3Rpb24odG9rZW4pIHsKICAgIHZhciBpID0gaW5kZXhPZi5jYWxsKHRoaXMsIHRva2VuKTsKICAgICBpZiAoaSA9PT0gLTEpIHsKICAgICAgIHJldHVybjsKICAgICB9CiAgICBzcGxpY2UuY2FsbCh0aGlzLCBpLCAxKTsKICAgIHNldFRvQ2xhc3NOYW1lKHRoaXMuX2VsZW1lbnQsIHNsaWNlLmNhbGwodGhpcywgMCkpOwogIH0sCiAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGpvaW4uY2FsbCh0aGlzLCAnICcpOwogIH0sCiAgdG9nZ2xlOiBmdW5jdGlvbih0b2tlbikgewogICAgaWYgKGluZGV4T2YuY2FsbCh0aGlzLCB0b2tlbikgPT09IC0xKSB7CiAgICAgIHRoaXMuYWRkKHRva2VuKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucmVtb3ZlKHRva2VuKTsKICAgIH0KICB9Cn07Cgp3aW5kb3cuRE9NVG9rZW5MaXN0ID0gRE9NVG9rZW5MaXN0OwoKZnVuY3Rpb24gZGVmaW5lRWxlbWVudEdldHRlciAob2JqLCBwcm9wLCBnZXR0ZXIpIHsKICBpZiAoT2JqZWN0LmRlZmluZVByb3BlcnR5KSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBwcm9wLHsKICAgICAgZ2V0IDogZ2V0dGVyCiAgICB9KQogIH0gZWxzZSB7CiAgICBvYmouX19kZWZpbmVHZXR0ZXJfXyhwcm9wLCBnZXR0ZXIpOwogIH0KfQoKZGVmaW5lRWxlbWVudEdldHRlcihFbGVtZW50LnByb3RvdHlwZSwgJ2NsYXNzTGlzdCcsIGZ1bmN0aW9uICgpIHsKICByZXR1cm4gbmV3IERPTVRva2VuTGlzdCh0aGlzKTsKfSk7Cgp9KSgpOwoKCi8qCiAqIENvcHlyaWdodCAyMDEyIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVyZW5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKLy8gU2lkZVRhYmxlIGlzIGEgd2VhayBtYXAgd2hlcmUgcG9zc2libGUuIElmIFdlYWtNYXAgaXMgbm90IGF2YWlsYWJsZSB0aGUKLy8gYXNzb2NpYXRpb24gaXMgc3RvcmVkIGFzIGFuIGV4cGFuZG8gcHJvcGVydHkuCnZhciBTaWRlVGFibGU7Ci8vIFRPRE8oYXJ2KTogV2Vha01hcCBkb2VzIG5vdCBhbGxvdyBmb3IgTm9kZSBldGMgdG8gYmUga2V5cyBpbiBGaXJlZm94CmlmICh0eXBlb2YgV2Vha01hcCAhPT0gJ3VuZGVmaW5lZCcgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdGaXJlZm94LycpIDwgMCkgewogIFNpZGVUYWJsZSA9IFdlYWtNYXA7Cn0gZWxzZSB7CiAgKGZ1bmN0aW9uKCkgewogICAgdmFyIGRlZmluZVByb3BlcnR5ID0gT2JqZWN0LmRlZmluZVByb3BlcnR5OwogICAgdmFyIGNvdW50ZXIgPSBEYXRlLm5vdygpICUgMWU5OwoKICAgIFNpZGVUYWJsZSA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5hbWUgPSAnX19zdCcgKyAoTWF0aC5yYW5kb20oKSAqIDFlOSA+Pj4gMCkgKyAoY291bnRlcisrICsgJ19fJyk7CiAgICB9OwoKICAgIFNpZGVUYWJsZS5wcm90b3R5cGUgPSB7CiAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBlbnRyeSA9IGtleVt0aGlzLm5hbWVdOwogICAgICAgIGlmIChlbnRyeSAmJiBlbnRyeVswXSA9PT0ga2V5KQogICAgICAgICAgZW50cnlbMV0gPSB2YWx1ZTsKICAgICAgICBlbHNlCiAgICAgICAgICBkZWZpbmVQcm9wZXJ0eShrZXksIHRoaXMubmFtZSwge3ZhbHVlOiBba2V5LCB2YWx1ZV0sIHdyaXRhYmxlOiB0cnVlfSk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgdmFyIGVudHJ5OwogICAgICAgIHJldHVybiAoZW50cnkgPSBrZXlbdGhpcy5uYW1lXSkgJiYgZW50cnlbMF0gPT09IGtleSA/CiAgICAgICAgICAgIGVudHJ5WzFdIDogdW5kZWZpbmVkOwogICAgICB9LAogICAgICBkZWxldGU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHRoaXMuc2V0KGtleSwgdW5kZWZpbmVkKTsKICAgICAgfQogICAgfQogIH0pKCk7Cn0KCi8qCiAqIENvcHlyaWdodCAyMDEyIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVyZW5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKGdsb2JhbCkgewoKICB2YXIgcmVnaXN0cmF0aW9uc1RhYmxlID0gbmV3IFNpZGVUYWJsZSgpOwoKICAvLyBXZSB1c2Ugc2V0SW1tZWRpYXRlIG9yIHBvc3RNZXNzYWdlIGZvciBvdXIgZnV0dXJlIGNhbGxiYWNrLgogIHZhciBzZXRJbW1lZGlhdGUgPSB3aW5kb3cubXNTZXRJbW1lZGlhdGU7CgogIC8vIFVzZSBwb3N0IG1lc3NhZ2UgdG8gZW11bGF0ZSBzZXRJbW1lZGlhdGUuCiAgaWYgKCFzZXRJbW1lZGlhdGUpIHsKICAgIHZhciBzZXRJbW1lZGlhdGVRdWV1ZSA9IFtdOwogICAgdmFyIHNlbnRpbmVsID0gU3RyaW5nKE1hdGgucmFuZG9tKCkpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBmdW5jdGlvbihlKSB7CiAgICAgIGlmIChlLmRhdGEgPT09IHNlbnRpbmVsKSB7CiAgICAgICAgdmFyIHF1ZXVlID0gc2V0SW1tZWRpYXRlUXVldWU7CiAgICAgICAgc2V0SW1tZWRpYXRlUXVldWUgPSBbXTsKICAgICAgICBxdWV1ZS5mb3JFYWNoKGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgICAgIGZ1bmMoKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICBzZXRJbW1lZGlhdGUgPSBmdW5jdGlvbihmdW5jKSB7CiAgICAgIHNldEltbWVkaWF0ZVF1ZXVlLnB1c2goZnVuYyk7CiAgICAgIHdpbmRvdy5wb3N0TWVzc2FnZShzZW50aW5lbCwgJyonKTsKICAgIH07CiAgfQoKICAvLyBUaGlzIGlzIHVzZWQgdG8gZW5zdXJlIHRoYXQgd2UgbmV2ZXIgc2NoZWR1bGUgMiBjYWxsYXMgdG8gc2V0SW1tZWRpYXRlCiAgdmFyIGlzU2NoZWR1bGVkID0gZmFsc2U7CgogIC8vIEtlZXAgdHJhY2sgb2Ygb2JzZXJ2ZXJzIHRoYXQgbmVlZHMgdG8gYmUgbm90aWZpZWQgbmV4dCB0aW1lLgogIHZhciBzY2hlZHVsZWRPYnNlcnZlcnMgPSBbXTsKCiAgLyoqCiAgICogU2NoZWR1bGVzIHxkaXNwYXRjaENhbGxiYWNrfCB0byBiZSBjYWxsZWQgaW4gdGhlIGZ1dHVyZS4KICAgKiBAcGFyYW0ge011dGF0aW9uT2JzZXJ2ZXJ9IG9ic2VydmVyCiAgICovCiAgZnVuY3Rpb24gc2NoZWR1bGVDYWxsYmFjayhvYnNlcnZlcikgewogICAgc2NoZWR1bGVkT2JzZXJ2ZXJzLnB1c2gob2JzZXJ2ZXIpOwogICAgaWYgKCFpc1NjaGVkdWxlZCkgewogICAgICBpc1NjaGVkdWxlZCA9IHRydWU7CiAgICAgIHNldEltbWVkaWF0ZShkaXNwYXRjaENhbGxiYWNrcyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB3cmFwSWZOZWVkZWQobm9kZSkgewogICAgcmV0dXJuIHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbCAmJgogICAgICAgIHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbC53cmFwSWZOZWVkZWQobm9kZSkgfHwKICAgICAgICBub2RlOwogIH0KCiAgZnVuY3Rpb24gZGlzcGF0Y2hDYWxsYmFja3MoKSB7CiAgICAvLyBodHRwOi8vZG9tLnNwZWMud2hhdHdnLm9yZy8jbXV0YXRpb24tb2JzZXJ2ZXJzCgogICAgaXNTY2hlZHVsZWQgPSBmYWxzZTsgLy8gVXNlZCB0byBhbGxvdyBhIG5ldyBzZXRJbW1lZGlhdGUgY2FsbCBhYm92ZS4KCiAgICB2YXIgb2JzZXJ2ZXJzID0gc2NoZWR1bGVkT2JzZXJ2ZXJzOwogICAgc2NoZWR1bGVkT2JzZXJ2ZXJzID0gW107CiAgICAvLyBTb3J0IG9ic2VydmVycyBiYXNlZCBvbiB0aGVpciBjcmVhdGlvbiBVSUQgKGluY3JlbWVudGFsKS4KICAgIG9ic2VydmVycy5zb3J0KGZ1bmN0aW9uKG8xLCBvMikgewogICAgICByZXR1cm4gbzEudWlkXyAtIG8yLnVpZF87CiAgICB9KTsKCiAgICB2YXIgYW55Tm9uRW1wdHkgPSBmYWxzZTsKICAgIG9ic2VydmVycy5mb3JFYWNoKGZ1bmN0aW9uKG9ic2VydmVyKSB7CgogICAgICAvLyAyLjEsIDIuMgogICAgICB2YXIgcXVldWUgPSBvYnNlcnZlci50YWtlUmVjb3JkcygpOwogICAgICAvLyAyLjMuIFJlbW92ZSBhbGwgdHJhbnNpZW50IHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzIHdob3NlIG9ic2VydmVyIGlzIG1vLgogICAgICByZW1vdmVUcmFuc2llbnRPYnNlcnZlcnNGb3Iob2JzZXJ2ZXIpOwoKICAgICAgLy8gMi40CiAgICAgIGlmIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgICBvYnNlcnZlci5jYWxsYmFja18ocXVldWUsIG9ic2VydmVyKTsKICAgICAgICBhbnlOb25FbXB0eSA9IHRydWU7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIDMuCiAgICBpZiAoYW55Tm9uRW1wdHkpCiAgICAgIGRpc3BhdGNoQ2FsbGJhY2tzKCk7CiAgfQoKICBmdW5jdGlvbiByZW1vdmVUcmFuc2llbnRPYnNlcnZlcnNGb3Iob2JzZXJ2ZXIpIHsKICAgIG9ic2VydmVyLm5vZGVzXy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICBpZiAoIXJlZ2lzdHJhdGlvbnMpCiAgICAgICAgcmV0dXJuOwogICAgICByZWdpc3RyYXRpb25zLmZvckVhY2goZnVuY3Rpb24ocmVnaXN0cmF0aW9uKSB7CiAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbi5vYnNlcnZlciA9PT0gb2JzZXJ2ZXIpCiAgICAgICAgICByZWdpc3RyYXRpb24ucmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzKCk7CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgZm9yIHRoZSAiRm9yIGVhY2ggcmVnaXN0ZXJlZCBvYnNlcnZlciBvYnNlcnZlciAod2l0aAogICAqIG9ic2VydmVyJ3Mgb3B0aW9ucyBhcyBvcHRpb25zKSBpbiB0YXJnZXQncyBsaXN0IG9mIHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzLAogICAqIHJ1biB0aGVzZSBzdWJzdGVwczoiIGFuZCB0aGUgIkZvciBlYWNoIGFuY2VzdG9yIGFuY2VzdG9yIG9mIHRhcmdldCwgYW5kIGZvcgogICAqIGVhY2ggcmVnaXN0ZXJlZCBvYnNlcnZlciBvYnNlcnZlciAod2l0aCBvcHRpb25zIG9wdGlvbnMpIGluIGFuY2VzdG9yJ3MgbGlzdAogICAqIG9mIHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzLCBydW4gdGhlc2Ugc3Vic3RlcHM6IiBwYXJ0IG9mIHRoZSBhbGdvcml0aG1zLiBUaGUKICAgKiB8b3B0aW9ucy5zdWJ0cmVlfCBpcyBjaGVja2VkIHRvIGVuc3VyZSB0aGF0IHRoZSBjYWxsYmFjayBpcyBjYWxsZWQKICAgKiBjb3JyZWN0bHkuCiAgICoKICAgKiBAcGFyYW0ge05vZGV9IHRhcmdldAogICAqIEBwYXJhbSB7ZnVuY3Rpb24oTXV0YXRpb25PYnNlcnZlckluaXQpOk11dGF0aW9uUmVjb3JkfSBjYWxsYmFjawogICAqLwogIGZ1bmN0aW9uIGZvckVhY2hBbmNlc3RvckFuZE9ic2VydmVyRW5xdWV1ZVJlY29yZCh0YXJnZXQsIGNhbGxiYWNrKSB7CiAgICBmb3IgKHZhciBub2RlID0gdGFyZ2V0OyBub2RlOyBub2RlID0gbm9kZS5wYXJlbnROb2RlKSB7CiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKCiAgICAgIGlmIChyZWdpc3RyYXRpb25zKSB7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uID0gcmVnaXN0cmF0aW9uc1tqXTsKICAgICAgICAgIHZhciBvcHRpb25zID0gcmVnaXN0cmF0aW9uLm9wdGlvbnM7CgogICAgICAgICAgLy8gT25seSB0YXJnZXQgaWdub3JlcyBzdWJ0cmVlLgogICAgICAgICAgaWYgKG5vZGUgIT09IHRhcmdldCAmJiAhb3B0aW9ucy5zdWJ0cmVlKQogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICB2YXIgcmVjb3JkID0gY2FsbGJhY2sob3B0aW9ucyk7CiAgICAgICAgICBpZiAocmVjb3JkKQogICAgICAgICAgICByZWdpc3RyYXRpb24uZW5xdWV1ZShyZWNvcmQpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgdmFyIHVpZENvdW50ZXIgPSAwOwoKICAvKioKICAgKiBUaGUgY2xhc3MgdGhhdCBtYXBzIHRvIHRoZSBET00gTXV0YXRpb25PYnNlcnZlciBpbnRlcmZhY2UuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2suCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gSnNNdXRhdGlvbk9ic2VydmVyKGNhbGxiYWNrKSB7CiAgICB0aGlzLmNhbGxiYWNrXyA9IGNhbGxiYWNrOwogICAgdGhpcy5ub2Rlc18gPSBbXTsKICAgIHRoaXMucmVjb3Jkc18gPSBbXTsKICAgIHRoaXMudWlkXyA9ICsrdWlkQ291bnRlcjsKICB9CgogIEpzTXV0YXRpb25PYnNlcnZlci5wcm90b3R5cGUgPSB7CiAgICBvYnNlcnZlOiBmdW5jdGlvbih0YXJnZXQsIG9wdGlvbnMpIHsKICAgICAgdGFyZ2V0ID0gd3JhcElmTmVlZGVkKHRhcmdldCk7CgogICAgICAvLyAxLjEKICAgICAgaWYgKCFvcHRpb25zLmNoaWxkTGlzdCAmJiAhb3B0aW9ucy5hdHRyaWJ1dGVzICYmICFvcHRpb25zLmNoYXJhY3RlckRhdGEgfHwKCiAgICAgICAgICAvLyAxLjIKICAgICAgICAgIG9wdGlvbnMuYXR0cmlidXRlT2xkVmFsdWUgJiYgIW9wdGlvbnMuYXR0cmlidXRlcyB8fAoKICAgICAgICAgIC8vIDEuMwogICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIgJiYgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIubGVuZ3RoICYmCiAgICAgICAgICAgICAgIW9wdGlvbnMuYXR0cmlidXRlcyB8fAoKICAgICAgICAgIC8vIDEuNAogICAgICAgICAgb3B0aW9ucy5jaGFyYWN0ZXJEYXRhT2xkVmFsdWUgJiYgIW9wdGlvbnMuY2hhcmFjdGVyRGF0YSkgewoKICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoKTsKICAgICAgfQoKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KHRhcmdldCk7CiAgICAgIGlmICghcmVnaXN0cmF0aW9ucykKICAgICAgICByZWdpc3RyYXRpb25zVGFibGUuc2V0KHRhcmdldCwgcmVnaXN0cmF0aW9ucyA9IFtdKTsKCiAgICAgIC8vIDIKICAgICAgLy8gSWYgdGFyZ2V0J3MgbGlzdCBvZiByZWdpc3RlcmVkIG9ic2VydmVycyBhbHJlYWR5IGluY2x1ZGVzIGEgcmVnaXN0ZXJlZAogICAgICAvLyBvYnNlcnZlciBhc3NvY2lhdGVkIHdpdGggdGhlIGNvbnRleHQgb2JqZWN0LCByZXBsYWNlIHRoYXQgcmVnaXN0ZXJlZAogICAgICAvLyBvYnNlcnZlcidzIG9wdGlvbnMgd2l0aCBvcHRpb25zLgogICAgICB2YXIgcmVnaXN0cmF0aW9uOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAocmVnaXN0cmF0aW9uc1tpXS5vYnNlcnZlciA9PT0gdGhpcykgewogICAgICAgICAgcmVnaXN0cmF0aW9uID0gcmVnaXN0cmF0aW9uc1tpXTsKICAgICAgICAgIHJlZ2lzdHJhdGlvbi5yZW1vdmVMaXN0ZW5lcnMoKTsKICAgICAgICAgIHJlZ2lzdHJhdGlvbi5vcHRpb25zID0gb3B0aW9uczsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gMy4KICAgICAgLy8gT3RoZXJ3aXNlLCBhZGQgYSBuZXcgcmVnaXN0ZXJlZCBvYnNlcnZlciB0byB0YXJnZXQncyBsaXN0IG9mIHJlZ2lzdGVyZWQKICAgICAgLy8gb2JzZXJ2ZXJzIHdpdGggdGhlIGNvbnRleHQgb2JqZWN0IGFzIHRoZSBvYnNlcnZlciBhbmQgb3B0aW9ucyBhcyB0aGUKICAgICAgLy8gb3B0aW9ucywgYW5kIGFkZCB0YXJnZXQgdG8gY29udGV4dCBvYmplY3QncyBsaXN0IG9mIG5vZGVzIG9uIHdoaWNoIGl0CiAgICAgIC8vIGlzIHJlZ2lzdGVyZWQuCiAgICAgIGlmICghcmVnaXN0cmF0aW9uKSB7CiAgICAgICAgcmVnaXN0cmF0aW9uID0gbmV3IFJlZ2lzdHJhdGlvbih0aGlzLCB0YXJnZXQsIG9wdGlvbnMpOwogICAgICAgIHJlZ2lzdHJhdGlvbnMucHVzaChyZWdpc3RyYXRpb24pOwogICAgICAgIHRoaXMubm9kZXNfLnB1c2godGFyZ2V0KTsKICAgICAgfQoKICAgICAgcmVnaXN0cmF0aW9uLmFkZExpc3RlbmVycygpOwogICAgfSwKCiAgICBkaXNjb25uZWN0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5ub2Rlc18uZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbiA9IHJlZ2lzdHJhdGlvbnNbaV07CiAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uLm9ic2VydmVyID09PSB0aGlzKSB7CiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbi5yZW1vdmVMaXN0ZW5lcnMoKTsKICAgICAgICAgICAgcmVnaXN0cmF0aW9ucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIC8vIEVhY2ggbm9kZSBjYW4gb25seSBoYXZlIG9uZSByZWdpc3RlcmVkIG9ic2VydmVyIGFzc29jaWF0ZWQgd2l0aAogICAgICAgICAgICAvLyB0aGlzIG9ic2VydmVyLgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgICB0aGlzLnJlY29yZHNfID0gW107CiAgICB9LAoKICAgIHRha2VSZWNvcmRzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvcHlPZlJlY29yZHMgPSB0aGlzLnJlY29yZHNfOwogICAgICB0aGlzLnJlY29yZHNfID0gW107CiAgICAgIHJldHVybiBjb3B5T2ZSZWNvcmRzOwogICAgfQogIH07CgogIC8qKgogICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlCiAgICogQHBhcmFtIHtOb2RlfSB0YXJnZXQKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBNdXRhdGlvblJlY29yZCh0eXBlLCB0YXJnZXQpIHsKICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgIHRoaXMuYWRkZWROb2RlcyA9IFtdOwogICAgdGhpcy5yZW1vdmVkTm9kZXMgPSBbXTsKICAgIHRoaXMucHJldmlvdXNTaWJsaW5nID0gbnVsbDsKICAgIHRoaXMubmV4dFNpYmxpbmcgPSBudWxsOwogICAgdGhpcy5hdHRyaWJ1dGVOYW1lID0gbnVsbDsKICAgIHRoaXMuYXR0cmlidXRlTmFtZXNwYWNlID0gbnVsbDsKICAgIHRoaXMub2xkVmFsdWUgPSBudWxsOwogIH0KCiAgZnVuY3Rpb24gY29weU11dGF0aW9uUmVjb3JkKG9yaWdpbmFsKSB7CiAgICB2YXIgcmVjb3JkID0gbmV3IE11dGF0aW9uUmVjb3JkKG9yaWdpbmFsLnR5cGUsIG9yaWdpbmFsLnRhcmdldCk7CiAgICByZWNvcmQuYWRkZWROb2RlcyA9IG9yaWdpbmFsLmFkZGVkTm9kZXMuc2xpY2UoKTsKICAgIHJlY29yZC5yZW1vdmVkTm9kZXMgPSBvcmlnaW5hbC5yZW1vdmVkTm9kZXMuc2xpY2UoKTsKICAgIHJlY29yZC5wcmV2aW91c1NpYmxpbmcgPSBvcmlnaW5hbC5wcmV2aW91c1NpYmxpbmc7CiAgICByZWNvcmQubmV4dFNpYmxpbmcgPSBvcmlnaW5hbC5uZXh0U2libGluZzsKICAgIHJlY29yZC5hdHRyaWJ1dGVOYW1lID0gb3JpZ2luYWwuYXR0cmlidXRlTmFtZTsKICAgIHJlY29yZC5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBvcmlnaW5hbC5hdHRyaWJ1dGVOYW1lc3BhY2U7CiAgICByZWNvcmQub2xkVmFsdWUgPSBvcmlnaW5hbC5vbGRWYWx1ZTsKICAgIHJldHVybiByZWNvcmQ7CiAgfTsKCiAgLy8gV2Uga2VlcCB0cmFjayBvZiB0aGUgdHdvIChwb3NzaWJseSBvbmUpIHJlY29yZHMgdXNlZCBpbiBhIHNpbmdsZSBtdXRhdGlvbi4KICB2YXIgY3VycmVudFJlY29yZCwgcmVjb3JkV2l0aE9sZFZhbHVlOwoKICAvKioKICAgKiBDcmVhdGVzIGEgcmVjb3JkIHdpdGhvdXQgfG9sZFZhbHVlfCBhbmQgY2FjaGVzIGl0IGFzIHxjdXJyZW50UmVjb3JkfCBmb3IKICAgKiBsYXRlciB1c2UuCiAgICogQHBhcmFtIHtzdHJpbmd9IG9sZFZhbHVlCiAgICogQHJldHVybiB7TXV0YXRpb25SZWNvcmR9CiAgICovCiAgZnVuY3Rpb24gZ2V0UmVjb3JkKHR5cGUsIHRhcmdldCkgewogICAgcmV0dXJuIGN1cnJlbnRSZWNvcmQgPSBuZXcgTXV0YXRpb25SZWNvcmQodHlwZSwgdGFyZ2V0KTsKICB9CgogIC8qKgogICAqIEdldHMgb3IgY3JlYXRlcyBhIHJlY29yZCB3aXRoIHxvbGRWYWx1ZXwgYmFzZWQgaW4gdGhlIHxjdXJyZW50UmVjb3JkfAogICAqIEBwYXJhbSB7c3RyaW5nfSBvbGRWYWx1ZQogICAqIEByZXR1cm4ge011dGF0aW9uUmVjb3JkfQogICAqLwogIGZ1bmN0aW9uIGdldFJlY29yZFdpdGhPbGRWYWx1ZShvbGRWYWx1ZSkgewogICAgaWYgKHJlY29yZFdpdGhPbGRWYWx1ZSkKICAgICAgcmV0dXJuIHJlY29yZFdpdGhPbGRWYWx1ZTsKICAgIHJlY29yZFdpdGhPbGRWYWx1ZSA9IGNvcHlNdXRhdGlvblJlY29yZChjdXJyZW50UmVjb3JkKTsKICAgIHJlY29yZFdpdGhPbGRWYWx1ZS5vbGRWYWx1ZSA9IG9sZFZhbHVlOwogICAgcmV0dXJuIHJlY29yZFdpdGhPbGRWYWx1ZTsKICB9CgogIGZ1bmN0aW9uIGNsZWFyUmVjb3JkcygpIHsKICAgIGN1cnJlbnRSZWNvcmQgPSByZWNvcmRXaXRoT2xkVmFsdWUgPSB1bmRlZmluZWQ7CiAgfQoKICAvKioKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfSByZWNvcmQKICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSByZWNvcmQgcmVwcmVzZW50cyBhIHJlY29yZCBmcm9tIHRoZSBjdXJyZW50CiAgICogbXV0YXRpb24gZXZlbnQuCiAgICovCiAgZnVuY3Rpb24gcmVjb3JkUmVwcmVzZW50c0N1cnJlbnRNdXRhdGlvbihyZWNvcmQpIHsKICAgIHJldHVybiByZWNvcmQgPT09IHJlY29yZFdpdGhPbGRWYWx1ZSB8fCByZWNvcmQgPT09IGN1cnJlbnRSZWNvcmQ7CiAgfQoKICAvKioKICAgKiBTZWxlY3RzIHdoaWNoIHJlY29yZCwgaWYgYW55LCB0byByZXBsYWNlIHRoZSBsYXN0IHJlY29yZCBpbiB0aGUgcXVldWUuCiAgICogVGhpcyByZXR1cm5zIHxudWxsfCBpZiBubyByZWNvcmQgc2hvdWxkIGJlIHJlcGxhY2VkLgogICAqCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0gbGFzdFJlY29yZAogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9IG5ld1JlY29yZAogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9CiAgICovCiAgZnVuY3Rpb24gc2VsZWN0UmVjb3JkKGxhc3RSZWNvcmQsIG5ld1JlY29yZCkgewogICAgaWYgKGxhc3RSZWNvcmQgPT09IG5ld1JlY29yZCkKICAgICAgcmV0dXJuIGxhc3RSZWNvcmQ7CgogICAgLy8gQ2hlY2sgaWYgdGhlIHRoZSByZWNvcmQgd2UgYXJlIGFkZGluZyByZXByZXNlbnRzIHRoZSBzYW1lIHJlY29yZC4gSWYKICAgIC8vIHNvLCB3ZSBrZWVwIHRoZSBvbmUgd2l0aCB0aGUgb2xkVmFsdWUgaW4gaXQuCiAgICBpZiAocmVjb3JkV2l0aE9sZFZhbHVlICYmIHJlY29yZFJlcHJlc2VudHNDdXJyZW50TXV0YXRpb24obGFzdFJlY29yZCkpCiAgICAgIHJldHVybiByZWNvcmRXaXRoT2xkVmFsdWU7CgogICAgcmV0dXJuIG51bGw7CiAgfQoKICAvKioKICAgKiBDbGFzcyB1c2VkIHRvIHJlcHJlc2VudCBhIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIuCiAgICogQHBhcmFtIHtNdXRhdGlvbk9ic2VydmVyfSBvYnNlcnZlcgogICAqIEBwYXJhbSB7Tm9kZX0gdGFyZ2V0CiAgICogQHBhcmFtIHtNdXRhdGlvbk9ic2VydmVySW5pdH0gb3B0aW9ucwogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIFJlZ2lzdHJhdGlvbihvYnNlcnZlciwgdGFyZ2V0LCBvcHRpb25zKSB7CiAgICB0aGlzLm9ic2VydmVyID0gb2JzZXJ2ZXI7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXMgPSBbXTsKICB9CgogIFJlZ2lzdHJhdGlvbi5wcm90b3R5cGUgPSB7CiAgICBlbnF1ZXVlOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgdmFyIHJlY29yZHMgPSB0aGlzLm9ic2VydmVyLnJlY29yZHNfOwogICAgICB2YXIgbGVuZ3RoID0gcmVjb3Jkcy5sZW5ndGg7CgogICAgICAvLyBUaGVyZSBhcmUgY2FzZXMgd2hlcmUgd2UgcmVwbGFjZSB0aGUgbGFzdCByZWNvcmQgd2l0aCB0aGUgbmV3IHJlY29yZC4KICAgICAgLy8gRm9yIGV4YW1wbGUgaWYgdGhlIHJlY29yZCByZXByZXNlbnRzIHRoZSBzYW1lIG11dGF0aW9uIHdlIG5lZWQgdG8gdXNlCiAgICAgIC8vIHRoZSBvbmUgd2l0aCB0aGUgb2xkVmFsdWUuIElmIHdlIGdldCBzYW1lIHJlY29yZCAodGhpcyBjYW4gaGFwcGVuIGFzIHdlCiAgICAgIC8vIHdhbGsgdXAgdGhlIHRyZWUpIHdlIGlnbm9yZSB0aGUgbmV3IHJlY29yZC4KICAgICAgaWYgKHJlY29yZHMubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBsYXN0UmVjb3JkID0gcmVjb3Jkc1tsZW5ndGggLSAxXTsKICAgICAgICB2YXIgcmVjb3JkVG9SZXBsYWNlTGFzdCA9IHNlbGVjdFJlY29yZChsYXN0UmVjb3JkLCByZWNvcmQpOwogICAgICAgIGlmIChyZWNvcmRUb1JlcGxhY2VMYXN0KSB7CiAgICAgICAgICByZWNvcmRzW2xlbmd0aCAtIDFdID0gcmVjb3JkVG9SZXBsYWNlTGFzdDsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2NoZWR1bGVDYWxsYmFjayh0aGlzLm9ic2VydmVyKTsKICAgICAgfQoKICAgICAgcmVjb3Jkc1tsZW5ndGhdID0gcmVjb3JkOwogICAgfSwKCiAgICBhZGRMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmFkZExpc3RlbmVyc18odGhpcy50YXJnZXQpOwogICAgfSwKCiAgICBhZGRMaXN0ZW5lcnNfOiBmdW5jdGlvbihub2RlKSB7CiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVzKQogICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignRE9NQXR0ck1vZGlmaWVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGFyYWN0ZXJEYXRhKQogICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ2hhcmFjdGVyRGF0YU1vZGlmaWVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGlsZExpc3QpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlSW5zZXJ0ZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCB8fCBvcHRpb25zLnN1YnRyZWUpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlUmVtb3ZlZCcsIHRoaXMsIHRydWUpOwogICAgfSwKCiAgICByZW1vdmVMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyc18odGhpcy50YXJnZXQpOwogICAgfSwKCiAgICByZW1vdmVMaXN0ZW5lcnNfOiBmdW5jdGlvbihub2RlKSB7CiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVzKQogICAgICAgIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NQXR0ck1vZGlmaWVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGFyYWN0ZXJEYXRhKQogICAgICAgIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NQ2hhcmFjdGVyRGF0YU1vZGlmaWVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGlsZExpc3QpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01Ob2RlSW5zZXJ0ZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCB8fCBvcHRpb25zLnN1YnRyZWUpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01Ob2RlUmVtb3ZlZCcsIHRoaXMsIHRydWUpOwogICAgfSwKCiAgICAvKioKICAgICAqIEFkZHMgYSB0cmFuc2llbnQgb2JzZXJ2ZXIgb24gbm9kZS4gVGhlIHRyYW5zaWVudCBvYnNlcnZlciBnZXRzIHJlbW92ZWQKICAgICAqIG5leHQgdGltZSB3ZSBkZWxpdmVyIHRoZSBjaGFuZ2UgcmVjb3Jkcy4KICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZQogICAgICovCiAgICBhZGRUcmFuc2llbnRPYnNlcnZlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAvLyBEb24ndCBhZGQgdHJhbnNpZW50IG9ic2VydmVycyBvbiB0aGUgdGFyZ2V0IGl0c2VsZi4gV2UgYWxyZWFkeSBoYXZlIGFsbAogICAgICAvLyB0aGUgcmVxdWlyZWQgbGlzdGVuZXJzIHNldCB1cCBvbiB0aGUgdGFyZ2V0LgogICAgICBpZiAobm9kZSA9PT0gdGhpcy50YXJnZXQpCiAgICAgICAgcmV0dXJuOwoKICAgICAgdGhpcy5hZGRMaXN0ZW5lcnNfKG5vZGUpOwogICAgICB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXMucHVzaChub2RlKTsKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICBpZiAoIXJlZ2lzdHJhdGlvbnMpCiAgICAgICAgcmVnaXN0cmF0aW9uc1RhYmxlLnNldChub2RlLCByZWdpc3RyYXRpb25zID0gW10pOwoKICAgICAgLy8gV2Uga25vdyB0aGF0IHJlZ2lzdHJhdGlvbnMgZG9lcyBub3QgY29udGFpbiB0aGlzIGJlY2F1c2Ugd2UgYWxyZWFkeQogICAgICAvLyBjaGVja2VkIGlmIG5vZGUgPT09IHRoaXMudGFyZ2V0LgogICAgICByZWdpc3RyYXRpb25zLnB1c2godGhpcyk7CiAgICB9LAoKICAgIHJlbW92ZVRyYW5zaWVudE9ic2VydmVyczogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0cmFuc2llbnRPYnNlcnZlZE5vZGVzID0gdGhpcy50cmFuc2llbnRPYnNlcnZlZE5vZGVzOwogICAgICB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXMgPSBbXTsKCiAgICAgIHRyYW5zaWVudE9ic2VydmVkTm9kZXMuZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgICAgLy8gVHJhbnNpZW50IG9ic2VydmVycyBhcmUgbmV2ZXIgYWRkZWQgdG8gdGhlIHRhcmdldC4KICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyc18obm9kZSk7CgogICAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25zW2ldID09PSB0aGlzKSB7CiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAvLyBFYWNoIG5vZGUgY2FuIG9ubHkgaGF2ZSBvbmUgcmVnaXN0ZXJlZCBvYnNlcnZlciBhc3NvY2lhdGVkIHdpdGgKICAgICAgICAgICAgLy8gdGhpcyBvYnNlcnZlci4KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgIH0sCgogICAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgLy8gU3RvcCBwcm9wYWdhdGlvbiBzaW5jZSB3ZSBhcmUgbWFuYWdpbmcgdGhlIHByb3BhZ2F0aW9uIG1hbnVhbGx5LgogICAgICAvLyBUaGlzIG1lYW5zIHRoYXQgb3RoZXIgbXV0YXRpb24gZXZlbnRzIG9uIHRoZSBwYWdlIHdpbGwgbm90IHdvcmsKICAgICAgLy8gY29ycmVjdGx5IGJ1dCB0aGF0IGlzIGJ5IGRlc2lnbi4KICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCiAgICAgIHN3aXRjaCAoZS50eXBlKSB7CiAgICAgICAgY2FzZSAnRE9NQXR0ck1vZGlmaWVkJzoKICAgICAgICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LW1vLXF1ZXVlLWF0dHJpYnV0ZXMKCiAgICAgICAgICB2YXIgbmFtZSA9IGUuYXR0ck5hbWU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gZS5yZWxhdGVkTm9kZS5uYW1lc3BhY2VVUkk7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS50YXJnZXQ7CgogICAgICAgICAgLy8gMS4KICAgICAgICAgIHZhciByZWNvcmQgPSBuZXcgZ2V0UmVjb3JkKCdhdHRyaWJ1dGVzJywgdGFyZ2V0KTsKICAgICAgICAgIHJlY29yZC5hdHRyaWJ1dGVOYW1lID0gbmFtZTsKICAgICAgICAgIHJlY29yZC5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBuYW1lc3BhY2U7CgogICAgICAgICAgLy8gMi4KICAgICAgICAgIHZhciBvbGRWYWx1ZSA9CiAgICAgICAgICAgICAgZS5hdHRyQ2hhbmdlID09PSBNdXRhdGlvbkV2ZW50LkFERElUSU9OID8gbnVsbCA6IGUucHJldlZhbHVlOwoKICAgICAgICAgIGZvckVhY2hBbmNlc3RvckFuZE9ic2VydmVyRW5xdWV1ZVJlY29yZCh0YXJnZXQsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgLy8gMy4xLCA0LjIKICAgICAgICAgICAgaWYgKCFvcHRpb25zLmF0dHJpYnV0ZXMpCiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMy4yLCA0LjMKICAgICAgICAgICAgaWYgKG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyICYmIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyLmxlbmd0aCAmJgogICAgICAgICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIuaW5kZXhPZihuYW1lKSA9PT0gLTEgJiYKICAgICAgICAgICAgICAgIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyLmluZGV4T2YobmFtZXNwYWNlKSA9PT0gLTEpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gMy4zLCA0LjQKICAgICAgICAgICAgaWYgKG9wdGlvbnMuYXR0cmlidXRlT2xkVmFsdWUpCiAgICAgICAgICAgICAgcmV0dXJuIGdldFJlY29yZFdpdGhPbGRWYWx1ZShvbGRWYWx1ZSk7CgogICAgICAgICAgICAvLyAzLjQsIDQuNQogICAgICAgICAgICByZXR1cm4gcmVjb3JkOwogICAgICAgICAgfSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ0RPTUNoYXJhY3RlckRhdGFNb2RpZmllZCc6CiAgICAgICAgICAvLyBodHRwOi8vZG9tLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC1tby1xdWV1ZS1jaGFyYWN0ZXJkYXRhCiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS50YXJnZXQ7CgogICAgICAgICAgLy8gMS4KICAgICAgICAgIHZhciByZWNvcmQgPSBnZXRSZWNvcmQoJ2NoYXJhY3RlckRhdGEnLCB0YXJnZXQpOwoKICAgICAgICAgIC8vIDIuCiAgICAgICAgICB2YXIgb2xkVmFsdWUgPSBlLnByZXZWYWx1ZTsKCgogICAgICAgICAgZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICAvLyAzLjEsIDQuMgogICAgICAgICAgICBpZiAoIW9wdGlvbnMuY2hhcmFjdGVyRGF0YSkKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAvLyAzLjIsIDQuMwogICAgICAgICAgICBpZiAob3B0aW9ucy5jaGFyYWN0ZXJEYXRhT2xkVmFsdWUpCiAgICAgICAgICAgICAgcmV0dXJuIGdldFJlY29yZFdpdGhPbGRWYWx1ZShvbGRWYWx1ZSk7CgogICAgICAgICAgICAvLyAzLjMsIDQuNAogICAgICAgICAgICByZXR1cm4gcmVjb3JkOwogICAgICAgICAgfSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ0RPTU5vZGVSZW1vdmVkJzoKICAgICAgICAgIHRoaXMuYWRkVHJhbnNpZW50T2JzZXJ2ZXIoZS50YXJnZXQpOwogICAgICAgICAgLy8gRmFsbCB0aHJvdWdoLgogICAgICAgIGNhc2UgJ0RPTU5vZGVJbnNlcnRlZCc6CiAgICAgICAgICAvLyBodHRwOi8vZG9tLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC1tby1xdWV1ZS1jaGlsZGxpc3QKICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnJlbGF0ZWROb2RlOwogICAgICAgICAgdmFyIGNoYW5nZWROb2RlID0gZS50YXJnZXQ7CiAgICAgICAgICB2YXIgYWRkZWROb2RlcywgcmVtb3ZlZE5vZGVzOwogICAgICAgICAgaWYgKGUudHlwZSA9PT0gJ0RPTU5vZGVJbnNlcnRlZCcpIHsKICAgICAgICAgICAgYWRkZWROb2RlcyA9IFtjaGFuZ2VkTm9kZV07CiAgICAgICAgICAgIHJlbW92ZWROb2RlcyA9IFtdOwogICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIGFkZGVkTm9kZXMgPSBbXTsKICAgICAgICAgICAgcmVtb3ZlZE5vZGVzID0gW2NoYW5nZWROb2RlXTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2aW91c1NpYmxpbmcgPSBjaGFuZ2VkTm9kZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICB2YXIgbmV4dFNpYmxpbmcgPSBjaGFuZ2VkTm9kZS5uZXh0U2libGluZzsKCiAgICAgICAgICAvLyAxLgogICAgICAgICAgdmFyIHJlY29yZCA9IGdldFJlY29yZCgnY2hpbGRMaXN0JywgdGFyZ2V0KTsKICAgICAgICAgIHJlY29yZC5hZGRlZE5vZGVzID0gYWRkZWROb2RlczsKICAgICAgICAgIHJlY29yZC5yZW1vdmVkTm9kZXMgPSByZW1vdmVkTm9kZXM7CiAgICAgICAgICByZWNvcmQucHJldmlvdXNTaWJsaW5nID0gcHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgcmVjb3JkLm5leHRTaWJsaW5nID0gbmV4dFNpYmxpbmc7CgogICAgICAgICAgZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICAvLyAyLjEsIDMuMgogICAgICAgICAgICBpZiAoIW9wdGlvbnMuY2hpbGRMaXN0KQogICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIDIuMiwgMy4zCiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7CiAgICAgICAgICB9KTsKCiAgICAgIH0KCiAgICAgIGNsZWFyUmVjb3JkcygpOwogICAgfQogIH07CgogIGdsb2JhbC5Kc011dGF0aW9uT2JzZXJ2ZXIgPSBKc011dGF0aW9uT2JzZXJ2ZXI7Cgp9KSh0aGlzKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgppZiAoIXdpbmRvdy5NdXRhdGlvbk9ic2VydmVyKSB7CiAgd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIgPSAKICAgICAgd2luZG93LldlYktpdE11dGF0aW9uT2JzZXJ2ZXIgfHwgCiAgICAgIHdpbmRvdy5Kc011dGF0aW9uT2JzZXJ2ZXI7CiAgaWYgKCFNdXRhdGlvbk9ic2VydmVyKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIm5vIG11dGF0aW9uIG9ic2VydmVyIHN1cHBvcnQiKTsKICB9Cn0KCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgovKioKICogSW1wbGVtZW50cyBgZG9jdW1lbnQucmVnaXN0ZXJgCiAqIEBtb2R1bGUgQ3VzdG9tRWxlbWVudHMKKi8KCi8qKgogKiBQb2x5ZmlsbGVkIGV4dGVuc2lvbnMgdG8gdGhlIGBkb2N1bWVudGAgb2JqZWN0LgogKiBAY2xhc3MgRG9jdW1lbnQKKi8KCihmdW5jdGlvbihzY29wZSkgewoKLy8gaW1wb3J0cwoKaWYgKCFzY29wZSkgewogIHNjb3BlID0gd2luZG93LkN1c3RvbUVsZW1lbnRzID0ge2ZsYWdzOnt9fTsKfQp2YXIgZmxhZ3MgPSBzY29wZS5mbGFnczsKCi8vIG5hdGl2ZSBkb2N1bWVudC5yZWdpc3Rlcj8KCnZhciBoYXNOYXRpdmUgPSBCb29sZWFuKGRvY3VtZW50LnJlZ2lzdGVyKTsKdmFyIHVzZU5hdGl2ZSA9ICFmbGFncy5yZWdpc3RlciAmJiBoYXNOYXRpdmU7CgppZiAodXNlTmF0aXZlKSB7CgogIC8vIHN0dWIKICB2YXIgbm9wID0gZnVuY3Rpb24oKSB7fTsKCiAgLy8gZXhwb3J0cwogIHNjb3BlLnJlZ2lzdHJ5ID0ge307CiAgc2NvcGUudXBncmFkZUVsZW1lbnQgPSBub3A7CiAgCiAgc2NvcGUud2F0Y2hTaGFkb3cgPSBub3A7CiAgc2NvcGUudXBncmFkZSA9IG5vcDsKICBzY29wZS51cGdyYWRlQWxsID0gbm9wOwogIHNjb3BlLnVwZ3JhZGVTdWJ0cmVlID0gbm9wOwogIHNjb3BlLm9ic2VydmVEb2N1bWVudCA9IG5vcDsKICBzY29wZS51cGdyYWRlRG9jdW1lbnQgPSBub3A7CiAgc2NvcGUudGFrZVJlY29yZHMgPSBub3A7Cgp9IGVsc2UgewoKICAvKioKICAgKiBSZWdpc3RlcnMgYSBjdXN0b20gdGFnIG5hbWUgd2l0aCB0aGUgZG9jdW1lbnQuCiAgICoKICAgKiBXaGVuIGEgcmVnaXN0ZXJlZCBlbGVtZW50IGlzIGNyZWF0ZWQsIGEgYHJlYWR5Q2FsbGJhY2tgIG1ldGhvZCBpcyBjYWxsZWQKICAgKiBpbiB0aGUgc2NvcGUgb2YgdGhlIGVsZW1lbnQuIFRoZSBgcmVhZHlDYWxsYmFja2AgbWV0aG9kIGNhbiBiZSBzcGVjaWZpZWQgb24KICAgKiBlaXRoZXIgYG9wdGlvbnMucHJvdG90eXBlYCBvciBgb3B0aW9ucy5saWZlY3ljbGVgIHdpdGggdGhlIGxhdHRlciB0YWtpbmcKICAgKiBwcmVjZWRlbmNlLgogICAqCiAgICogQG1ldGhvZCByZWdpc3RlcgogICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0YWcgbmFtZSB0byByZWdpc3Rlci4gTXVzdCBpbmNsdWRlIGEgZGFzaCAoJy0nKSwKICAgKiAgICBmb3IgZXhhbXBsZSAneC1jb21wb25lbnQnLgogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICogICAgQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLmV4dGVuZHNdCiAgICogICAgICAoX29mZiBzcGVjXykgVGFnIG5hbWUgb2YgYW4gZWxlbWVudCB0byBleHRlbmQgKG9yIGJsYW5rIGZvciBhIG5ldwogICAqICAgICAgZWxlbWVudCkuIFRoaXMgcGFyYW1ldGVyIGlzIG5vdCBwYXJ0IG9mIHRoZSBzcGVjaWZpY2F0aW9uLCBidXQgaW5zdGVhZAogICAqICAgICAgaXMgYSBoaW50IGZvciB0aGUgcG9seWZpbGwgYmVjYXVzZSB0aGUgZXh0ZW5kZWUgaXMgZGlmZmljdWx0IHRvIGluZmVyLgogICAqICAgICAgUmVtZW1iZXIgdGhhdCB0aGUgaW5wdXQgcHJvdG90eXBlIG11c3QgY2hhaW4gdG8gdGhlIGV4dGVuZGVkIGVsZW1lbnQncwogICAqICAgICAgcHJvdG90eXBlIChvciBIVE1MRWxlbWVudC5wcm90b3R5cGUpIHJlZ2FyZGxlc3Mgb2YgdGhlIHZhbHVlIG9mCiAgICogICAgICBgZXh0ZW5kc2AuCiAgICogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMucHJvdG90eXBlIFRoZSBwcm90b3R5cGUgdG8gdXNlIGZvciB0aGUgbmV3CiAgICogICAgICBlbGVtZW50LiBUaGUgcHJvdG90eXBlIG11c3QgaW5oZXJpdCBmcm9tIEhUTUxFbGVtZW50LgogICAqICAgIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucy5saWZlY3ljbGVdCiAgICogICAgICBDYWxsYmFja3MgdGhhdCBmaXJlIGF0IGltcG9ydGFudCBwaGFzZXMgaW4gdGhlIGxpZmUgb2YgdGhlIGN1c3RvbQogICAqICAgICAgZWxlbWVudC4KICAgKgogICAqIEBleGFtcGxlCiAgICogICAgICBGYW5jeUJ1dHRvbiA9IGRvY3VtZW50LnJlZ2lzdGVyKCJmYW5jeS1idXR0b24iLCB7CiAgICogICAgICAgIGV4dGVuZHM6ICdidXR0b24nLAogICAqICAgICAgICBwcm90b3R5cGU6IE9iamVjdC5jcmVhdGUoSFRNTEJ1dHRvbkVsZW1lbnQucHJvdG90eXBlLCB7CiAgICogICAgICAgICAgcmVhZHlDYWxsYmFjazogewogICAqICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogICAqICAgICAgICAgICAgICBjb25zb2xlLmxvZygiYSBmYW5jeS1idXR0b24gd2FzIGNyZWF0ZWQiLAogICAqICAgICAgICAgICAgfQogICAqICAgICAgICAgIH0KICAgKiAgICAgICAgfSkKICAgKiAgICAgIH0pOwogICAqIEByZXR1cm4ge0Z1bmN0aW9ufSBDb25zdHJ1Y3RvciBmb3IgdGhlIG5ld2x5IHJlZ2lzdGVyZWQgdHlwZS4KICAgKi8KICBmdW5jdGlvbiByZWdpc3RlcihuYW1lLCBvcHRpb25zKSB7CiAgICAvL2NvbnNvbGUud2FybignZG9jdW1lbnQucmVnaXN0ZXIoIicgKyBuYW1lICsgJyIsICcsIG9wdGlvbnMsICcpJyk7CiAgICAvLyBjb25zdHJ1Y3QgYSBkZWZpbnRpb24gb3V0IG9mIG9wdGlvbnMKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHByb2JhYmx5IHNob3VsZCBjbG9uZSBvcHRpb25zIGluc3RlYWQgb2YgbXV0YXRpbmcgaXQKICAgIHZhciBkZWZpbml0aW9uID0gb3B0aW9ucyB8fCB7fTsKICAgIGlmICghbmFtZSkgewogICAgICAvLyBUT0RPKHNqbWlsZXMpOiByZXBsYWNlIHdpdGggbW9yZSBhcHByb3ByaWF0ZSBlcnJvciAoRXJpY0IgY2FuIHByb2JhYmx5CiAgICAgIC8vIG9mZmVyIGd1aWRhbmNlKQogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2RvY3VtZW50LnJlZ2lzdGVyOiBmaXJzdCBhcmd1bWVudCBgbmFtZWAgbXVzdCBub3QgYmUgZW1wdHknKTsKICAgIH0KICAgIGlmIChuYW1lLmluZGV4T2YoJy0nKSA8IDApIHsKICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVwbGFjZSB3aXRoIG1vcmUgYXBwcm9wcmlhdGUgZXJyb3IgKEVyaWNCIGNhbiBwcm9iYWJseQogICAgICAvLyBvZmZlciBndWlkYW5jZSkKICAgICAgdGhyb3cgbmV3IEVycm9yKCdkb2N1bWVudC5yZWdpc3RlcjogZmlyc3QgYXJndW1lbnQgKFwnbmFtZVwnKSBtdXN0IGNvbnRhaW4gYSBkYXNoIChcJy1cJykuIEFyZ3VtZW50IHByb3ZpZGVkIHdhcyBcJycgKyBTdHJpbmcobmFtZSkgKyAnXCcuJyk7CiAgICB9CiAgICAvLyByZWNvcmQgbmFtZQogICAgZGVmaW5pdGlvbi5uYW1lID0gbmFtZTsKICAgIC8vIG11c3QgaGF2ZSBhIHByb3RvdHlwZSwgZGVmYXVsdCB0byBhbiBleHRlbnNpb24gb2YgSFRNTEVsZW1lbnQKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHByb2JhYmx5IHNob3VsZCB0aHJvdyBpZiBubyBwcm90b3R5cGUsIGNoZWNrIHNwZWMKICAgIGlmICghZGVmaW5pdGlvbi5wcm90b3R5cGUpIHsKICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVwbGFjZSB3aXRoIG1vcmUgYXBwcm9wcmlhdGUgZXJyb3IgKEVyaWNCIGNhbiBwcm9iYWJseQogICAgICAvLyBvZmZlciBndWlkYW5jZSkKICAgICAgdGhyb3cgbmV3IEVycm9yKCdPcHRpb25zIG1pc3NpbmcgcmVxdWlyZWQgcHJvdG90eXBlIHByb3BlcnR5Jyk7CiAgICB9CiAgICAvLyBlbnN1cmUgYSBsaWZlY3ljbGUgb2JqZWN0IHNvIHdlIGRvbid0IGhhdmUgdG8gbnVsbCB0ZXN0IGl0CiAgICBkZWZpbml0aW9uLmxpZmVjeWNsZSA9IGRlZmluaXRpb24ubGlmZWN5Y2xlIHx8IHt9OwogICAgLy8gYnVpbGQgYSBsaXN0IG9mIGFuY2VzdHJhbCBjdXN0b20gZWxlbWVudHMgKGZvciBuYXRpdmUgYmFzZSBkZXRlY3Rpb24pCiAgICAvLyBUT0RPKHNqbWlsZXMpOiB3ZSB1c2VkIHRvIG5lZWQgdG8gc3RvcmUgdGhpcywgYnV0IGN1cnJlbnQgY29kZSBvbmx5CiAgICAvLyB1c2VzIGl0IGluICdyZXNvbHZlVGFnTmFtZSc6IGl0IHNob3VsZCBwcm9iYWJseSBiZSBpbmxpbmVkCiAgICBkZWZpbml0aW9uLmFuY2VzdHJ5ID0gYW5jZXN0cnkoZGVmaW5pdGlvbi5leHRlbmRzKTsKICAgIC8vIGV4dGVuc2lvbnMgb2YgbmF0aXZlIHNwZWNpYWxpemF0aW9ucyBvZiBIVE1MRWxlbWVudCByZXF1aXJlIGxvY2FsTmFtZQogICAgLy8gdG8gcmVtYWluIG5hdGl2ZSwgYW5kIHVzZSBzZWNvbmRhcnkgJ2lzJyBzcGVjaWZpZXIgZm9yIGV4dGVuc2lvbiB0eXBlCiAgICByZXNvbHZlVGFnTmFtZShkZWZpbml0aW9uKTsKICAgIC8vIHNvbWUgcGxhdGZvcm1zIHJlcXVpcmUgbW9kaWZpY2F0aW9ucyB0byB0aGUgdXNlci1zdXBwbGllZCBwcm90b3R5cGUKICAgIC8vIGNoYWluCiAgICByZXNvbHZlUHJvdG90eXBlQ2hhaW4oZGVmaW5pdGlvbik7CiAgICAvLyBvdmVycmlkZXMgdG8gaW1wbGVtZW50IGF0dHJpYnV0ZUNoYW5nZWQgY2FsbGJhY2sKICAgIG92ZXJyaWRlQXR0cmlidXRlQXBpKGRlZmluaXRpb24ucHJvdG90eXBlKTsKICAgIC8vIDcuMS41OiBSZWdpc3RlciB0aGUgREVGSU5JVElPTiB3aXRoIERPQ1VNRU5UCiAgICByZWdpc3RlckRlZmluaXRpb24obmFtZSwgZGVmaW5pdGlvbik7CiAgICAvLyA3LjEuNy4gUnVuIGN1c3RvbSBlbGVtZW50IGNvbnN0cnVjdG9yIGdlbmVyYXRpb24gYWxnb3JpdGhtIHdpdGggUFJPVE9UWVBFCiAgICAvLyA3LjEuOC4gUmV0dXJuIHRoZSBvdXRwdXQgb2YgdGhlIHByZXZpb3VzIHN0ZXAuCiAgICBkZWZpbml0aW9uLmN0b3IgPSBnZW5lcmF0ZUNvbnN0cnVjdG9yKGRlZmluaXRpb24pOwogICAgZGVmaW5pdGlvbi5jdG9yLnByb3RvdHlwZSA9IGRlZmluaXRpb24ucHJvdG90eXBlOwogICAgLy8gZm9yY2Ugb3VyIC5jb25zdHJ1Y3RvciB0byBiZSBvdXIgYWN0dWFsIGNvbnN0cnVjdG9yCiAgICBkZWZpbml0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGRlZmluaXRpb24uY3RvcjsKICAgIC8vIGlmIGluaXRpYWwgcGFyc2luZyBpcyBjb21wbGV0ZQogICAgaWYgKHNjb3BlLnJlYWR5KSB7CiAgICAgIC8vIHVwZ3JhZGUgYW55IHByZS1leGlzdGluZyBub2RlcyBvZiB0aGlzIHR5cGUKICAgICAgc2NvcGUudXBncmFkZUFsbChkb2N1bWVudCk7CiAgICB9CiAgICByZXR1cm4gZGVmaW5pdGlvbi5jdG9yOwogIH0KCiAgZnVuY3Rpb24gYW5jZXN0cnkoZXh0bmRzKSB7CiAgICB2YXIgZXh0ZW5kZWUgPSByZWdpc3RyeVtleHRuZHNdOwogICAgaWYgKGV4dGVuZGVlKSB7CiAgICAgIHJldHVybiBhbmNlc3RyeShleHRlbmRlZS5leHRlbmRzKS5jb25jYXQoW2V4dGVuZGVlXSk7CiAgICB9CiAgICByZXR1cm4gW107CiAgfQoKICBmdW5jdGlvbiByZXNvbHZlVGFnTmFtZShkZWZpbml0aW9uKSB7CiAgICAvLyBpZiB3ZSBhcmUgZXhwbGljaXRseSBleHRlbmRpbmcgc29tZXRoaW5nLCB0aGF0IHRoaW5nIGlzIG91cgogICAgLy8gYmFzZVRhZywgdW5sZXNzIGl0IHJlcHJlc2VudHMgYSBjdXN0b20gY29tcG9uZW50CiAgICB2YXIgYmFzZVRhZyA9IGRlZmluaXRpb24uZXh0ZW5kczsKICAgIC8vIGlmIG91ciBhbmNlc3RyeSBpbmNsdWRlcyBjdXN0b20gY29tcG9uZW50cywgd2Ugb25seSBoYXZlIGEKICAgIC8vIGJhc2VUYWcgaWYgb25lIG9mIHRoZW0gZG9lcwogICAgZm9yICh2YXIgaT0wLCBhOyAoYT1kZWZpbml0aW9uLmFuY2VzdHJ5W2ldKTsgaSsrKSB7CiAgICAgIGJhc2VUYWcgPSBhLmlzICYmIGEudGFnOwogICAgfQogICAgLy8gb3VyIHRhZyBpcyBvdXIgYmFzZVRhZywgaWYgaXQgZXhpc3RzLCBhbmQgb3RoZXJ3aXNlIGp1c3Qgb3VyIG5hbWUKICAgIGRlZmluaXRpb24udGFnID0gYmFzZVRhZyB8fCBkZWZpbml0aW9uLm5hbWU7CiAgICBpZiAoYmFzZVRhZykgewogICAgICAvLyBpZiB0aGVyZSBpcyBhIGJhc2UgdGFnLCB1c2Ugc2Vjb25kYXJ5ICdpcycgc3BlY2lmaWVyCiAgICAgIGRlZmluaXRpb24uaXMgPSBkZWZpbml0aW9uLm5hbWU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZXNvbHZlUHJvdG90eXBlQ2hhaW4oZGVmaW5pdGlvbikgewogICAgLy8gaWYgd2UgZG9uJ3Qgc3VwcG9ydCBfX3Byb3RvX18gd2UgbmVlZCB0byBsb2NhdGUgdGhlIG5hdGl2ZSBsZXZlbAogICAgLy8gcHJvdG90eXBlIGZvciBwcmVjaXNlIG1peGluZyBpbgogICAgaWYgKCFPYmplY3QuX19wcm90b19fKSB7CiAgICAgIC8vIGRlZmF1bHQgcHJvdG90eXBlCiAgICAgIHZhciBuYXRpdmVQcm90b3R5cGUgPSBIVE1MRWxlbWVudC5wcm90b3R5cGU7CiAgICAgIC8vIHdvcmsgb3V0IHByb3RvdHlwZSB3aGVuIHVzaW5nIHR5cGUtZXh0ZW5zaW9uCiAgICAgIGlmIChkZWZpbml0aW9uLmlzKSB7CiAgICAgICAgdmFyIGluc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGRlZmluaXRpb24udGFnKTsKICAgICAgICBuYXRpdmVQcm90b3R5cGUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoaW5zdCk7CiAgICAgIH0KICAgICAgLy8gZW5zdXJlIF9fcHJvdG9fXyByZWZlcmVuY2UgaXMgaW5zdGFsbGVkIGF0IGVhY2ggcG9pbnQgb24gdGhlIHByb3RvdHlwZQogICAgICAvLyBjaGFpbi4KICAgICAgLy8gTk9URTogT24gcGxhdGZvcm1zIHdpdGhvdXQgX19wcm90b19fLCBhIG1peGluIHN0cmF0ZWd5IGlzIHVzZWQgaW5zdGVhZAogICAgICAvLyBvZiBwcm90b3R5cGUgc3dpenpsaW5nLiBJbiB0aGlzIGNhc2UsIHRoaXMgZ2VuZXJhdGVkIF9fcHJvdG9fXyBwcm92aWRlcwogICAgICAvLyBsaW1pdGVkIHN1cHBvcnQgZm9yIHByb3RvdHlwZSB0cmF2ZXJzYWwuCiAgICAgIHZhciBwcm90byA9IGRlZmluaXRpb24ucHJvdG90eXBlLCBhbmNlc3RvcjsKICAgICAgd2hpbGUgKHByb3RvICYmIChwcm90byAhPT0gbmF0aXZlUHJvdG90eXBlKSkgewogICAgICAgIHZhciBhbmNlc3RvciA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihwcm90byk7CiAgICAgICAgcHJvdG8uX19wcm90b19fID0gYW5jZXN0b3I7CiAgICAgICAgcHJvdG8gPSBhbmNlc3RvcjsKICAgICAgfQogICAgfQogICAgLy8gY2FjaGUgdGhpcyBpbiBjYXNlIG9mIG1peGluCiAgICBkZWZpbml0aW9uLm5hdGl2ZSA9IG5hdGl2ZVByb3RvdHlwZTsKICB9CgogIC8vIFNFQ1RJT04gNAoKICBmdW5jdGlvbiBpbnN0YW50aWF0ZShkZWZpbml0aW9uKSB7CiAgICAvLyA0LmEuMS4gQ3JlYXRlIGEgbmV3IG9iamVjdCB0aGF0IGltcGxlbWVudHMgUFJPVE9UWVBFCiAgICAvLyA0LmEuMi4gTGV0IEVMRU1FTlQgYnkgdGhpcyBuZXcgb2JqZWN0CiAgICAvLwogICAgLy8gdGhlIGN1c3RvbSBlbGVtZW50IGluc3RhbnRpYXRpb24gYWxnb3JpdGhtIG11c3QgYWxzbyBlbnN1cmUgdGhhdCB0aGUKICAgIC8vIG91dHB1dCBpcyBhIHZhbGlkIERPTSBlbGVtZW50IHdpdGggdGhlIHByb3BlciB3cmFwcGVyIGluIHBsYWNlLgogICAgLy8KICAgIHJldHVybiB1cGdyYWRlKGRvbUNyZWF0ZUVsZW1lbnQoZGVmaW5pdGlvbi50YWcpLCBkZWZpbml0aW9uKTsKICB9CgogIGZ1bmN0aW9uIHVwZ3JhZGUoZWxlbWVudCwgZGVmaW5pdGlvbikgewogICAgLy8gc29tZSBkZWZpbml0aW9ucyBzcGVjaWZ5IGFuICdpcycgYXR0cmlidXRlCiAgICBpZiAoZGVmaW5pdGlvbi5pcykgewogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnaXMnLCBkZWZpbml0aW9uLmlzKTsKICAgIH0KICAgIC8vIG1ha2UgJ2VsZW1lbnQnIGltcGxlbWVudCBkZWZpbml0aW9uLnByb3RvdHlwZQogICAgaW1wbGVtZW50KGVsZW1lbnQsIGRlZmluaXRpb24pOwogICAgLy8gZmxhZyBhcyB1cGdyYWRlZAogICAgZWxlbWVudC5fX3VwZ3JhZGVkX18gPSB0cnVlOwogICAgLy8gdGhlcmUgc2hvdWxkIG5ldmVyIGJlIGEgc2hhZG93IHJvb3Qgb24gZWxlbWVudCBhdCB0aGlzIHBvaW50CiAgICAvLyB3ZSByZXF1aXJlIGNoaWxkIG5vZGVzIGJlIHVwZ3JhZGVkIGJlZm9yZSBgY3JlYXRlZGAKICAgIHNjb3BlLnVwZ3JhZGVTdWJ0cmVlKGVsZW1lbnQpOwogICAgLy8gbGlmZWN5Y2xlIG1hbmFnZW1lbnQKICAgIGNyZWF0ZWQoZWxlbWVudCk7CiAgICAvLyBPVVRQVVQKICAgIHJldHVybiBlbGVtZW50OwogIH0KCiAgZnVuY3Rpb24gaW1wbGVtZW50KGVsZW1lbnQsIGRlZmluaXRpb24pIHsKICAgIC8vIHByb3RvdHlwZSBzd2l6emxpbmcgaXMgYmVzdAogICAgaWYgKE9iamVjdC5fX3Byb3RvX18pIHsKICAgICAgZWxlbWVudC5fX3Byb3RvX18gPSBkZWZpbml0aW9uLnByb3RvdHlwZTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHdoZXJlIGFib3ZlIHdlIGNhbiByZS1hY3F1aXJlIGluUHJvdG90eXBlIHZpYQogICAgICAvLyBnZXRQcm90b3R5cGVPZihFbGVtZW50KSwgd2UgY2Fubm90IGRvIHNvIHdoZW4KICAgICAgLy8gd2UgdXNlIG1peGluLCBzbyB3ZSBpbnN0YWxsIGEgbWFnaWMgcmVmZXJlbmNlCiAgICAgIGN1c3RvbU1peGluKGVsZW1lbnQsIGRlZmluaXRpb24ucHJvdG90eXBlLCBkZWZpbml0aW9uLm5hdGl2ZSk7CiAgICAgIGVsZW1lbnQuX19wcm90b19fID0gZGVmaW5pdGlvbi5wcm90b3R5cGU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjdXN0b21NaXhpbihpblRhcmdldCwgaW5TcmMsIGluTmF0aXZlKSB7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiAndXNlZCcgYWxsb3dzIHVzIHRvIG9ubHkgY29weSB0aGUgJ3lvdW5nZXN0JyB2ZXJzaW9uIG9mCiAgICAvLyBhbnkgcHJvcGVydHkuIFRoaXMgc2V0IHNob3VsZCBiZSBwcmVjYWxjdWxhdGVkLiBXZSBhbHNvIG5lZWQgdG8KICAgIC8vIGNvbnNpZGVyIHRoaXMgZm9yIHN1cHBvcnRpbmcgJ3N1cGVyJy4KICAgIHZhciB1c2VkID0ge307CiAgICAvLyBzdGFydCB3aXRoIGluU3JjCiAgICB2YXIgcCA9IGluU3JjOwogICAgLy8gc29tZXRpbWVzIHRoZSBkZWZhdWx0IGlzIEhUTUxVbmtub3duRWxlbWVudC5wcm90b3R5cGUgaW5zdGVhZCBvZgogICAgLy8gSFRNTEVsZW1lbnQucHJvdG90eXBlLCBzbyB3ZSBhZGQgYSB0ZXN0CiAgICAvLyB0aGUgaWRlYSBpcyB0byBhdm9pZCBtaXhpbmcgaW4gbmF0aXZlIHByb3RvdHlwZXMsIHNvIGFkZGluZwogICAgLy8gdGhlIHNlY29uZCB0ZXN0IGlzIFdMT0cKICAgIHdoaWxlIChwICE9PSBpbk5hdGl2ZSAmJiBwICE9PSBIVE1MVW5rbm93bkVsZW1lbnQucHJvdG90eXBlKSB7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocCk7CiAgICAgIGZvciAodmFyIGk9MCwgazsgaz1rZXlzW2ldOyBpKyspIHsKICAgICAgICBpZiAoIXVzZWRba10pIHsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShpblRhcmdldCwgaywKICAgICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHAsIGspKTsKICAgICAgICAgIHVzZWRba10gPSAxOwogICAgICAgIH0KICAgICAgfQogICAgICBwID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHApOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlZChlbGVtZW50KSB7CiAgICAvLyBpbnZva2UgY3JlYXRlZENhbGxiYWNrCiAgICBpZiAoZWxlbWVudC5jcmVhdGVkQ2FsbGJhY2spIHsKICAgICAgZWxlbWVudC5jcmVhdGVkQ2FsbGJhY2soKTsKICAgIH0KICB9CgogIC8vIGF0dHJpYnV0ZSB3YXRjaGluZwoKICBmdW5jdGlvbiBvdmVycmlkZUF0dHJpYnV0ZUFwaShwcm90b3R5cGUpIHsKICAgIC8vIG92ZXJyaWRlcyB0byBpbXBsZW1lbnQgY2FsbGJhY2tzCiAgICAvLyBUT0RPKHNqbWlsZXMpOiBzaG91bGQgc3VwcG9ydCBhY2Nlc3MgdmlhIC5hdHRyaWJ1dGVzIE5hbWVkTm9kZU1hcAogICAgLy8gVE9ETyhzam1pbGVzKTogcHJlc2VydmVzIHVzZXIgZGVmaW5lZCBvdmVycmlkZXMsIGlmIGFueQogICAgdmFyIHNldEF0dHJpYnV0ZSA9IHByb3RvdHlwZS5zZXRBdHRyaWJ1dGU7CiAgICBwcm90b3R5cGUuc2V0QXR0cmlidXRlID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgY2hhbmdlQXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIHNldEF0dHJpYnV0ZSk7CiAgICB9CiAgICB2YXIgcmVtb3ZlQXR0cmlidXRlID0gcHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZTsKICAgIHByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICBjaGFuZ2VBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgcmVtb3ZlQXR0cmlidXRlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNoYW5nZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgb3BlcmF0aW9uKSB7CiAgICB2YXIgb2xkVmFsdWUgPSB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgIG9wZXJhdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKHRoaXMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrIAogICAgICAgICYmICh0aGlzLmdldEF0dHJpYnV0ZShuYW1lKSAhPT0gb2xkVmFsdWUpKSB7CiAgICAgIHRoaXMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKG5hbWUsIG9sZFZhbHVlKTsKICAgIH0KICB9CgogIC8vIGVsZW1lbnQgcmVnaXN0cnkgKG1hcHMgdGFnIG5hbWVzIHRvIGRlZmluaXRpb25zKQoKICB2YXIgcmVnaXN0cnkgPSB7fTsKCiAgZnVuY3Rpb24gcmVnaXN0ZXJEZWZpbml0aW9uKG5hbWUsIGRlZmluaXRpb24pIHsKICAgIHJlZ2lzdHJ5W25hbWVdID0gZGVmaW5pdGlvbjsKICB9CgogIGZ1bmN0aW9uIGdlbmVyYXRlQ29uc3RydWN0b3IoZGVmaW5pdGlvbikgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gaW5zdGFudGlhdGUoZGVmaW5pdGlvbik7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudCh0YWcsIHR5cGVFeHRlbnNpb24pIHsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IGlnbm9yZSAndGFnJyB3aGVuIHVzaW5nICd0eXBlRXh0ZW5zaW9uJywgd2UgY291bGQKICAgIC8vIGVycm9yIGNoZWNrIGl0LCBvciBwZXJoYXBzIHRoZXJlIHNob3VsZCBvbmx5IGV2ZXIgYmUgb25lIGFyZ3VtZW50CiAgICB2YXIgZGVmaW5pdGlvbiA9IHJlZ2lzdHJ5W3R5cGVFeHRlbnNpb24gfHwgdGFnXTsKICAgIGlmIChkZWZpbml0aW9uKSB7CiAgICAgIHJldHVybiBuZXcgZGVmaW5pdGlvbi5jdG9yKCk7CiAgICB9CiAgICByZXR1cm4gZG9tQ3JlYXRlRWxlbWVudCh0YWcpOwogIH0KCiAgZnVuY3Rpb24gdXBncmFkZUVsZW1lbnQoZWxlbWVudCkgewogICAgaWYgKCFlbGVtZW50Ll9fdXBncmFkZWRfXyAmJiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpKSB7CiAgICAgIHZhciB0eXBlID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgZWxlbWVudC5sb2NhbE5hbWU7CiAgICAgIHZhciBkZWZpbml0aW9uID0gcmVnaXN0cnlbdHlwZV07CiAgICAgIHJldHVybiBkZWZpbml0aW9uICYmIHVwZ3JhZGUoZWxlbWVudCwgZGVmaW5pdGlvbik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjbG9uZU5vZGUoZGVlcCkgewogICAgLy8gY2FsbCBvcmlnaW5hbCBjbG9uZQogICAgdmFyIG4gPSBkb21DbG9uZU5vZGUuY2FsbCh0aGlzLCBkZWVwKTsKICAgIC8vIHVwZ3JhZGUgdGhlIGVsZW1lbnQgYW5kIHN1YnRyZWUKICAgIHNjb3BlLnVwZ3JhZGVBbGwobik7CiAgICAvLyByZXR1cm4gdGhlIGNsb25lCiAgICByZXR1cm4gbjsKICB9CiAgLy8gY2FwdHVyZSBuYXRpdmUgY3JlYXRlRWxlbWVudCBiZWZvcmUgd2Ugb3ZlcnJpZGUgaXQKCiAgdmFyIGRvbUNyZWF0ZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50LmJpbmQoZG9jdW1lbnQpOwoKICAvLyBjYXB0dXJlIG5hdGl2ZSBjbG9uZU5vZGUgYmVmb3JlIHdlIG92ZXJyaWRlIGl0CgogIHZhciBkb21DbG9uZU5vZGUgPSBOb2RlLnByb3RvdHlwZS5jbG9uZU5vZGU7CgogIC8vIGV4cG9ydHMKCiAgZG9jdW1lbnQucmVnaXN0ZXIgPSByZWdpc3RlcjsKICBkb2N1bWVudC5jcmVhdGVFbGVtZW50ID0gY3JlYXRlRWxlbWVudDsgLy8gb3ZlcnJpZGUKICBOb2RlLnByb3RvdHlwZS5jbG9uZU5vZGUgPSBjbG9uZU5vZGU7IC8vIG92ZXJyaWRlCgogIHNjb3BlLnJlZ2lzdHJ5ID0gcmVnaXN0cnk7CgogIC8qKgogICAqIFVwZ3JhZGUgYW4gZWxlbWVudCB0byBhIGN1c3RvbSBlbGVtZW50LiBVcGdyYWRpbmcgYW4gZWxlbWVudAogICAqIGNhdXNlcyB0aGUgY3VzdG9tIHByb3RvdHlwZSB0byBiZSBhcHBsaWVkLCBhbiBgaXNgIGF0dHJpYnV0ZSAKICAgKiB0byBiZSBhdHRhY2hlZCAoYXMgbmVlZGVkKSwgYW5kIGludm9jYXRpb24gb2YgdGhlIGByZWFkeUNhbGxiYWNrYC4KICAgKiBgdXBncmFkZWAgZG9lcyBub3RoaW5nIGlmIHRoZSBlbGVtZW50IGlzIGFscmVhZHkgdXBncmFkZWQsIG9yCiAgICogaWYgaXQgbWF0Y2hlcyBubyByZWdpc3RlcmVkIGN1c3RvbSB0YWcgbmFtZS4KICAgKgogICAqIEBtZXRob2QgdWdwcmFkZQogICAqIEBwYXJhbSB7RWxlbWVudH0gZWxlbWVudCBUaGUgZWxlbWVudCB0byB1cGdyYWRlLgogICAqIEByZXR1cm4ge0VsZW1lbnR9IFRoZSB1cGdyYWRlZCBlbGVtZW50LgogICAqLwogIHNjb3BlLnVwZ3JhZGUgPSB1cGdyYWRlRWxlbWVudDsKfQoKc2NvcGUuaGFzTmF0aXZlID0gaGFzTmF0aXZlOwpzY29wZS51c2VOYXRpdmUgPSB1c2VOYXRpdmU7Cgp9KSh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpOwoKIC8qDQpDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLg0KVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUNCmxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4NCiovDQoNCihmdW5jdGlvbihzY29wZSl7DQoNCnZhciBsb2dGbGFncyA9IHdpbmRvdy5sb2dGbGFncyB8fCB7fTsNCg0KLy8gd2FsayB0aGUgc3VidHJlZSByb290ZWQgYXQgbm9kZSwgYXBwbHlpbmcgJ2ZpbmQoZWxlbWVudCwgZGF0YSknIGZ1bmN0aW9uDQovLyB0byBlYWNoIGVsZW1lbnQNCi8vIGlmICdmaW5kJyByZXR1cm5zIHRydWUgZm9yICdlbGVtZW50JywgZG8gbm90IHNlYXJjaCBlbGVtZW50J3Mgc3VidHJlZQ0KZnVuY3Rpb24gZmluZEFsbChub2RlLCBmaW5kLCBkYXRhKSB7DQogIHZhciBlID0gbm9kZS5maXJzdEVsZW1lbnRDaGlsZDsNCiAgaWYgKCFlKSB7DQogICAgZSA9IG5vZGUuZmlyc3RDaGlsZDsNCiAgICB3aGlsZSAoZSAmJiBlLm5vZGVUeXBlICE9PSBOb2RlLkVMRU1FTlRfTk9ERSkgew0KICAgICAgZSA9IGUubmV4dFNpYmxpbmc7DQogICAgfQ0KICB9DQogIHdoaWxlIChlKSB7DQogICAgaWYgKGZpbmQoZSwgZGF0YSkgIT09IHRydWUpIHsNCiAgICAgIGZpbmRBbGwoZSwgZmluZCwgZGF0YSk7DQogICAgfQ0KICAgIGUgPSBlLm5leHRFbGVtZW50U2libGluZzsNCiAgfQ0KICByZXR1cm4gbnVsbDsNCn0NCg0KLy8gd2FsayBhbGwgc2hhZG93Um9vdHMgb24gYSBnaXZlbiBub2RlLg0KZnVuY3Rpb24gZm9yUm9vdHMobm9kZSwgY2IpIHsNCiAgdmFyIHJvb3QgPSBub2RlLnNoYWRvd1Jvb3Q7DQogIHdoaWxlKHJvb3QpIHsNCiAgICBmb3JTdWJ0cmVlKHJvb3QsIGNiKTsNCiAgICByb290ID0gcm9vdC5vbGRlclNoYWRvd1Jvb3Q7DQogIH0NCn0NCg0KLy8gd2FsayB0aGUgc3VidHJlZSByb290ZWQgYXQgbm9kZSwgaW5jbHVkaW5nIGRlc2NlbnQgaW50byBzaGFkb3ctcm9vdHMsDQovLyBhcHBseWluZyAnY2InIHRvIGVhY2ggZWxlbWVudA0KZnVuY3Rpb24gZm9yU3VidHJlZShub2RlLCBjYikgew0KICAvL2xvZ0ZsYWdzLmRvbSAmJiBub2RlLmNoaWxkTm9kZXMgJiYgbm9kZS5jaGlsZE5vZGVzLmxlbmd0aCAmJiBjb25zb2xlLmdyb3VwKCdzdWJUcmVlOiAnLCBub2RlKTsNCiAgZmluZEFsbChub2RlLCBmdW5jdGlvbihlKSB7DQogICAgaWYgKGNiKGUpKSB7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogICAgZm9yUm9vdHMoZSwgY2IpOw0KICB9KTsNCiAgZm9yUm9vdHMobm9kZSwgY2IpOw0KICAvL2xvZ0ZsYWdzLmRvbSAmJiBub2RlLmNoaWxkTm9kZXMgJiYgbm9kZS5jaGlsZE5vZGVzLmxlbmd0aCAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQp9DQoNCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZQ0KZnVuY3Rpb24gYWRkZWQobm9kZSkgew0KICBpZiAodXBncmFkZShub2RlKSkgew0KICAgIGluc2VydGVkTm9kZShub2RlKTsNCiAgICByZXR1cm4gdHJ1ZTsNCiAgfQ0KICBpbnNlcnRlZChub2RlKTsNCn0NCg0KLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlJ3Mgc3VidHJlZSBvbmx5DQpmdW5jdGlvbiBhZGRlZFN1YnRyZWUobm9kZSkgew0KICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsNCiAgICBpZiAoYWRkZWQoZSkpIHsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgfSk7DQp9DQoNCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZSBhbmQgaXQncyBzdWJ0cmVlDQpmdW5jdGlvbiBhZGRlZE5vZGUobm9kZSkgew0KICByZXR1cm4gYWRkZWQobm9kZSkgfHwgYWRkZWRTdWJ0cmVlKG5vZGUpOw0KfQ0KDQovLyB1cGdyYWRlIGN1c3RvbSBlbGVtZW50cyBhdCBub2RlLCBpZiBhcHBsaWNhYmxlDQpmdW5jdGlvbiB1cGdyYWRlKG5vZGUpIHsNCiAgaWYgKCFub2RlLl9fdXBncmFkZWRfXyAmJiBub2RlLm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkgew0KICAgIHZhciB0eXBlID0gbm9kZS5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgbm9kZS5sb2NhbE5hbWU7DQogICAgdmFyIGRlZmluaXRpb24gPSBzY29wZS5yZWdpc3RyeVt0eXBlXTsNCiAgICBpZiAoZGVmaW5pdGlvbikgew0KICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ3VwZ3JhZGU6Jywgbm9kZS5sb2NhbE5hbWUpOw0KICAgICAgc2NvcGUudXBncmFkZShub2RlKTsNCiAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogIH0NCn0NCg0KZnVuY3Rpb24gaW5zZXJ0ZWROb2RlKG5vZGUpIHsNCiAgaW5zZXJ0ZWQobm9kZSk7DQogIGlmIChpbkRvY3VtZW50KG5vZGUpKSB7DQogICAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7DQogICAgICBpbnNlcnRlZChlKTsNCiAgICB9KTsNCiAgfQ0KfQ0KDQoNCi8vIFRPRE8oc29ydmVsbCk6IG9uIHBsYXRmb3JtcyB3aXRob3V0IE11dGF0aW9uT2JzZXJ2ZXIsIG11dGF0aW9ucyBtYXkgbm90IGJlIA0KLy8gcmVsaWFibGUgYW5kIHRoZXJlZm9yZSBlbnRlcmVkL2xlZnRWaWV3IGFyZSBub3QgcmVsaWFibGUuDQovLyBUbyBtYWtlIHRoZXNlIGNhbGxiYWNrcyBsZXNzIGxpa2VseSB0byBmYWlsLCB3ZSBkZWZlciBhbGwgaW5zZXJ0cyBhbmQgcmVtb3Zlcw0KLy8gdG8gZ2l2ZSBhIGNoYW5jZSBmb3IgZWxlbWVudHMgdG8gYmUgaW5zZXJ0ZWQgaW50byBkb20uIA0KLy8gVGhpcyBlbnN1cmVzIGVudGVyZWRWaWV3Q2FsbGJhY2sgZmlyZXMgZm9yIGVsZW1lbnRzIHRoYXQgYXJlIGNyZWF0ZWQgYW5kIA0KLy8gaW1tZWRpYXRlbHkgYWRkZWQgdG8gZG9tLg0KdmFyIGhhc1BvbHlmaWxsTXV0YXRpb25zID0gKCF3aW5kb3cuTXV0YXRpb25PYnNlcnZlciB8fA0KICAgICh3aW5kb3cuTXV0YXRpb25PYnNlcnZlciA9PT0gd2luZG93LkpzTXV0YXRpb25PYnNlcnZlcikpOw0Kc2NvcGUuaGFzUG9seWZpbGxNdXRhdGlvbnMgPSBoYXNQb2x5ZmlsbE11dGF0aW9uczsNCg0KdmFyIGlzUGVuZGluZ011dGF0aW9ucyA9IGZhbHNlOw0KdmFyIHBlbmRpbmdNdXRhdGlvbnMgPSBbXTsNCmZ1bmN0aW9uIGRlZmVyTXV0YXRpb24oZm4pIHsNCiAgcGVuZGluZ011dGF0aW9ucy5wdXNoKGZuKTsNCiAgaWYgKCFpc1BlbmRpbmdNdXRhdGlvbnMpIHsNCiAgICBpc1BlbmRpbmdNdXRhdGlvbnMgPSB0cnVlOw0KICAgIHZhciBhc3luYyA9ICh3aW5kb3cuUGxhdGZvcm0gJiYgd2luZG93LlBsYXRmb3JtLmVuZE9mTWljcm90YXNrKSB8fA0KICAgICAgICBzZXRUaW1lb3V0Ow0KICAgIGFzeW5jKHRha2VNdXRhdGlvbnMpOw0KICB9DQp9DQoNCmZ1bmN0aW9uIHRha2VNdXRhdGlvbnMoKSB7DQogIGlzUGVuZGluZ011dGF0aW9ucyA9IGZhbHNlOw0KICB2YXIgJHAgPSBwZW5kaW5nTXV0YXRpb25zOw0KICBmb3IgKHZhciBpPTAsIGw9JHAubGVuZ3RoLCBwOyAoaTxsKSAmJiAocD0kcFtpXSk7IGkrKykgew0KICAgIHAoKTsNCiAgfQ0KICBwZW5kaW5nTXV0YXRpb25zID0gW107DQp9DQoNCmZ1bmN0aW9uIGluc2VydGVkKGVsZW1lbnQpIHsNCiAgaWYgKGhhc1BvbHlmaWxsTXV0YXRpb25zKSB7DQogICAgZGVmZXJNdXRhdGlvbihmdW5jdGlvbigpIHsNCiAgICAgIF9pbnNlcnRlZChlbGVtZW50KTsNCiAgICB9KTsNCiAgfSBlbHNlIHsNCiAgICBfaW5zZXJ0ZWQoZWxlbWVudCk7DQogIH0NCn0NCg0KLy8gVE9ETyhzam1pbGVzKTogaWYgdGhlcmUgYXJlIGRlc2NlbnRzIGludG8gdHJlZXMgdGhhdCBjYW4gbmV2ZXIgaGF2ZSBpbkRvY3VtZW50KCopIHRydWUsIGZpeCB0aGlzDQpmdW5jdGlvbiBfaW5zZXJ0ZWQoZWxlbWVudCkgew0KICAvLyBUT0RPKHNqbWlsZXMpOiBpdCdzIHBvc3NpYmxlIHdlIHdlcmUgaW5zZXJ0ZWQgYW5kIHJlbW92ZWQgaW4gdGhlIHNwYWNlDQogIC8vIG9mIG9uZSBtaWNyb3Rhc2ssIGluIHdoaWNoIGNhc2Ugd2Ugd29uJ3QgYmUgJ2luRG9jdW1lbnQnIGhlcmUNCiAgLy8gQnV0IHRoZXJlIGFyZSBvdGhlciBjYXNlcyB3aGVyZSB3ZSBhcmUgdGVzdGluZyBmb3IgaW5zZXJ0ZWQgd2l0aG91dA0KICAvLyBzcGVjaWZpYyBrbm93bGVkZ2Ugb2YgbXV0YXRpb25zLCBhbmQgbXVzdCB0ZXN0ICdpbkRvY3VtZW50JyB0byBkZXRlcm1pbmUNCiAgLy8gd2hldGhlciB0byBjYWxsIGluc2VydGVkDQogIC8vIElmIHdlIGNhbiBmYWN0b3IgdGhlc2UgY2FzZXMgaW50byBzZXBhcmF0ZSBjb2RlIHBhdGhzIHdlIGNhbiBoYXZlDQogIC8vIGJldHRlciBkaWFnbm9zdGljcy4NCiAgLy8gVE9ETyhzam1pbGVzKTogd2hlbiBsb2dnaW5nLCBkbyB3b3JrIG9uIGFsbCBjdXN0b20gZWxlbWVudHMgc28gd2UgY2FuDQogIC8vIHRyYWNrIGJlaGF2aW9yIGV2ZW4gd2hlbiBjYWxsYmFja3Mgbm90IGRlZmluZWQNCiAgLy9jb25zb2xlLmxvZygnaW5zZXJ0ZWQ6ICcsIGVsZW1lbnQubG9jYWxOYW1lKTsNCiAgaWYgKGVsZW1lbnQuZW50ZXJlZFZpZXdDYWxsYmFjayB8fCAoZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgbG9nRmxhZ3MuZG9tKSkgew0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7DQogICAgaWYgKGluRG9jdW1lbnQoZWxlbWVudCkpIHsNCiAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IChlbGVtZW50Ll9faW5zZXJ0ZWQgfHwgMCkgKyAxOw0KICAgICAgLy8gaWYgd2UgYXJlIGluIGEgJ3JlbW92ZWQnIHN0YXRlLCBibHVudGx5IGFkanVzdCB0byBhbiAnaW5zZXJ0ZWQnIHN0YXRlDQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkIDwgMSkgew0KICAgICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAxOw0KICAgICAgfQ0KICAgICAgLy8gaWYgd2UgYXJlICdvdmVyIGluc2VydGVkJywgc3F1ZWxjaCB0aGUgY2FsbGJhY2sNCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPiAxKSB7DQogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLndhcm4oJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lLA0KICAgICAgICAgICdpbnNlcnQvcmVtb3ZlIGNvdW50OicsIGVsZW1lbnQuX19pbnNlcnRlZCkNCiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5lbnRlcmVkVmlld0NhbGxiYWNrKSB7DQogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygnaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOw0KICAgICAgICBlbGVtZW50LmVudGVyZWRWaWV3Q2FsbGJhY2soKTsNCiAgICAgIH0NCiAgICB9DQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiByZW1vdmVkTm9kZShub2RlKSB7DQogIHJlbW92ZWQobm9kZSk7DQogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgIHJlbW92ZWQoZSk7DQogIH0pOw0KfQ0KDQoNCmZ1bmN0aW9uIHJlbW92ZWQoZWxlbWVudCkgew0KICBpZiAoaGFzUG9seWZpbGxNdXRhdGlvbnMpIHsNCiAgICBkZWZlck11dGF0aW9uKGZ1bmN0aW9uKCkgew0KICAgICAgX3JlbW92ZWQoZWxlbWVudCk7DQogICAgfSk7DQogIH0gZWxzZSB7DQogICAgX3JlbW92ZWQoZWxlbWVudCk7DQogIH0NCn0NCg0KZnVuY3Rpb24gcmVtb3ZlZChlbGVtZW50KSB7DQogIC8vIFRPRE8oc2ptaWxlcyk6IHRlbXBvcmFyeTogZG8gd29yayBvbiBhbGwgY3VzdG9tIGVsZW1lbnRzIHNvIHdlIGNhbiB0cmFjaw0KICAvLyBiZWhhdmlvciBldmVuIHdoZW4gY2FsbGJhY2tzIG5vdCBkZWZpbmVkDQogIGlmIChlbGVtZW50LmxlZnRWaWV3Q2FsbGJhY2sgfHwgKGVsZW1lbnQuX191cGdyYWRlZF9fICYmIGxvZ0ZsYWdzLmRvbSkpIHsNCiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ3JlbW92ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOw0KICAgIGlmICghaW5Eb2N1bWVudChlbGVtZW50KSkgew0KICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gKGVsZW1lbnQuX19pbnNlcnRlZCB8fCAwKSAtIDE7DQogICAgICAvLyBpZiB3ZSBhcmUgaW4gYSAnaW5zZXJ0ZWQnIHN0YXRlLCBibHVudGx5IGFkanVzdCB0byBhbiAncmVtb3ZlZCcgc3RhdGUNCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPiAwKSB7DQogICAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IDA7DQogICAgICB9DQogICAgICAvLyBpZiB3ZSBhcmUgJ292ZXIgcmVtb3ZlZCcsIHNxdWVsY2ggdGhlIGNhbGxiYWNrDQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkIDwgMCkgew0KICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS53YXJuKCdyZW1vdmVkOicsIGVsZW1lbnQubG9jYWxOYW1lLA0KICAgICAgICAgICAgJ2luc2VydC9yZW1vdmUgY291bnQ6JywgZWxlbWVudC5fX2luc2VydGVkKQ0KICAgICAgfSBlbHNlIGlmIChlbGVtZW50LmxlZnRWaWV3Q2FsbGJhY2spIHsNCiAgICAgICAgZWxlbWVudC5sZWZ0Vmlld0NhbGxiYWNrKCk7DQogICAgICB9DQogICAgfQ0KICB9DQp9DQoNCmZ1bmN0aW9uIGluRG9jdW1lbnQoZWxlbWVudCkgew0KICB2YXIgcCA9IGVsZW1lbnQ7DQogIHZhciBkb2MgPSB3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwgJiYNCiAgICAgIHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbC53cmFwSWZOZWVkZWQoZG9jdW1lbnQpIHx8IGRvY3VtZW50Ow0KICB3aGlsZSAocCkgew0KICAgIGlmIChwID09IGRvYykgew0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICAgIHAgPSBwLnBhcmVudE5vZGUgfHwgcC5ob3N0Ow0KICB9DQp9DQoNCmZ1bmN0aW9uIHdhdGNoU2hhZG93KG5vZGUpIHsNCiAgaWYgKG5vZGUuc2hhZG93Um9vdCAmJiAhbm9kZS5zaGFkb3dSb290Ll9fd2F0Y2hlZCkgew0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygnd2F0Y2hpbmcgc2hhZG93LXJvb3QgZm9yOiAnLCBub2RlLmxvY2FsTmFtZSk7DQogICAgLy8gd2F0Y2ggYWxsIHVud2F0Y2hlZCByb290cy4uLg0KICAgIHZhciByb290ID0gbm9kZS5zaGFkb3dSb290Ow0KICAgIHdoaWxlIChyb290KSB7DQogICAgICB3YXRjaFJvb3Qocm9vdCk7DQogICAgICByb290ID0gcm9vdC5vbGRlclNoYWRvd1Jvb3Q7DQogICAgfQ0KICB9DQp9DQoNCmZ1bmN0aW9uIHdhdGNoUm9vdChyb290KSB7DQogIGlmICghcm9vdC5fX3dhdGNoZWQpIHsNCiAgICBvYnNlcnZlKHJvb3QpOw0KICAgIHJvb3QuX193YXRjaGVkID0gdHJ1ZTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiBmaWx0ZXIoaW5Ob2RlKSB7DQogIHN3aXRjaCAoaW5Ob2RlLmxvY2FsTmFtZSkgew0KICAgIGNhc2UgJ3N0eWxlJzoNCiAgICBjYXNlICdzY3JpcHQnOg0KICAgIGNhc2UgJ3RlbXBsYXRlJzoNCiAgICBjYXNlIHVuZGVmaW5lZDoNCiAgICAgIHJldHVybiB0cnVlOw0KICB9DQp9DQoNCmZ1bmN0aW9uIGhhbmRsZXIobXV0YXRpb25zKSB7DQogIC8vDQogIGlmIChsb2dGbGFncy5kb20pIHsNCiAgICB2YXIgbXggPSBtdXRhdGlvbnNbMF07DQogICAgaWYgKG14ICYmIG14LnR5cGUgPT09ICdjaGlsZExpc3QnICYmIG14LmFkZGVkTm9kZXMpIHsNCiAgICAgICAgaWYgKG14LmFkZGVkTm9kZXMpIHsNCiAgICAgICAgICB2YXIgZCA9IG14LmFkZGVkTm9kZXNbMF07DQogICAgICAgICAgd2hpbGUgKGQgJiYgZCAhPT0gZG9jdW1lbnQgJiYgIWQuaG9zdCkgew0KICAgICAgICAgICAgZCA9IGQucGFyZW50Tm9kZTsNCiAgICAgICAgICB9DQogICAgICAgICAgdmFyIHUgPSBkICYmIChkLlVSTCB8fCBkLl9VUkwgfHwgKGQuaG9zdCAmJiBkLmhvc3QubG9jYWxOYW1lKSkgfHwgJyc7DQogICAgICAgICAgdSA9IHUuc3BsaXQoJy8/Jykuc2hpZnQoKS5zcGxpdCgnLycpLnBvcCgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIGNvbnNvbGUuZ3JvdXAoJ211dGF0aW9ucyAoJWQpIFslc10nLCBtdXRhdGlvbnMubGVuZ3RoLCB1IHx8ICcnKTsNCiAgfQ0KICAvLw0KICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihteCkgew0KICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ211dGF0aW9uJyk7DQogICAgaWYgKG14LnR5cGUgPT09ICdjaGlsZExpc3QnKSB7DQogICAgICBmb3JFYWNoKG14LmFkZGVkTm9kZXMsIGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2cobi5sb2NhbE5hbWUpOw0KICAgICAgICBpZiAoZmlsdGVyKG4pKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIC8vIG5vZGVzIGFkZGVkIG1heSBuZWVkIGxpZmVjeWNsZSBtYW5hZ2VtZW50DQogICAgICAgIGFkZGVkTm9kZShuKTsNCiAgICAgIH0pOw0KICAgICAgLy8gcmVtb3ZlZCBub2RlcyBtYXkgbmVlZCBsaWZlY3ljbGUgbWFuYWdlbWVudA0KICAgICAgZm9yRWFjaChteC5yZW1vdmVkTm9kZXMsIGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2cobi5sb2NhbE5hbWUpOw0KICAgICAgICBpZiAoZmlsdGVyKG4pKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIHJlbW92ZWROb2RlKG4pOw0KICAgICAgfSk7DQogICAgfQ0KICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCiAgfSk7DQogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQp9Ow0KDQp2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihoYW5kbGVyKTsNCg0KZnVuY3Rpb24gdGFrZVJlY29yZHMoKSB7DQogIC8vIFRPRE8oc2ptaWxlcyk6IGFzayBSYWYgd2h5IHdlIGhhdmUgdG8gY2FsbCBoYW5kbGVyIG91cnNlbHZlcw0KICBoYW5kbGVyKG9ic2VydmVyLnRha2VSZWNvcmRzKCkpOw0KICB0YWtlTXV0YXRpb25zKCk7DQp9DQoNCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsNCg0KZnVuY3Rpb24gb2JzZXJ2ZShpblJvb3QpIHsNCiAgb2JzZXJ2ZXIub2JzZXJ2ZShpblJvb3QsIHtjaGlsZExpc3Q6IHRydWUsIHN1YnRyZWU6IHRydWV9KTsNCn0NCg0KZnVuY3Rpb24gb2JzZXJ2ZURvY3VtZW50KGRvY3VtZW50KSB7DQogIG9ic2VydmUoZG9jdW1lbnQpOw0KfQ0KDQpmdW5jdGlvbiB1cGdyYWRlRG9jdW1lbnQoZG9jdW1lbnQpIHsNCiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ3VwZ3JhZGVEb2N1bWVudDogJywgKGRvY3VtZW50LlVSTCB8fCBkb2N1bWVudC5fVVJMIHx8ICcnKS5zcGxpdCgnLycpLnBvcCgpKTsNCiAgYWRkZWROb2RlKGRvY3VtZW50KTsNCiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCn0NCg0KLy8gZXhwb3J0cw0KDQpzY29wZS53YXRjaFNoYWRvdyA9IHdhdGNoU2hhZG93Ow0Kc2NvcGUudXBncmFkZUFsbCA9IGFkZGVkTm9kZTsNCnNjb3BlLnVwZ3JhZGVTdWJ0cmVlID0gYWRkZWRTdWJ0cmVlOw0KDQpzY29wZS5vYnNlcnZlRG9jdW1lbnQgPSBvYnNlcnZlRG9jdW1lbnQ7DQpzY29wZS51cGdyYWRlRG9jdW1lbnQgPSB1cGdyYWRlRG9jdW1lbnQ7DQoNCnNjb3BlLnRha2VSZWNvcmRzID0gdGFrZVJlY29yZHM7DQoNCn0pKHdpbmRvdy5DdXN0b21FbGVtZW50cyk7DQoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihzY29wZSkgewoKaWYgKCFzY29wZSkgewogIHNjb3BlID0gd2luZG93LkhUTUxJbXBvcnRzID0ge2ZsYWdzOnt9fTsKfQoKLy8gaW1wb3J0cwoKdmFyIHhociA9IHNjb3BlLnhocjsKCi8vIGltcG9ydGVyCgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9ICdpbXBvcnQnOwp2YXIgU1RZTEVfTElOS19UWVBFID0gJ3N0eWxlc2hlZXQnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgcmVwcmVzZW50cyBhIHByaW1hcnkgZG9jdW1lbnQgKHRoZSBhcmd1bWVudCB0byAnbG9hZCcpCi8vIGF0IHRoZSByb290IG9mIGEgdHJlZSBvZiBkb2N1bWVudHMKCi8vIGZvciBhbnkgZG9jdW1lbnQsIGltcG9ydGVyOgovLyAtIGxvYWRzIGFueSBsaW5rZWQgZG9jdW1lbnRzICh3aXRoIGRlZHVwaW5nKSwgbW9kaWZpZXMgcGF0aHMgYW5kIGZlZWRzIHRoZW0gYmFjayBpbnRvIGltcG9ydGVyCi8vIC0gbG9hZHMgdGV4dCBvZiBleHRlcm5hbCBzY3JpcHQgdGFncwovLyAtIGxvYWRzIHRleHQgb2YgZXh0ZXJuYWwgc3R5bGUgdGFncyBpbnNpZGUgb2YgPGVsZW1lbnQ+LCBtb2RpZmllcyBwYXRocwoKLy8gd2hlbiBpbXBvcnRlciAnbW9kaWZpZXMgcGF0aHMnIGluIGEgZG9jdW1lbnQsIHRoaXMgaW5jbHVkZXMKLy8gLSBocmVmL3NyYy9hY3Rpb24gaW4gbm9kZSBhdHRyaWJ1dGVzCi8vIC0gcGF0aHMgaW4gaW5saW5lIHN0eWxlc2hlZXRzCi8vIC0gYWxsIGNvbnRlbnQgaW5zaWRlIHRlbXBsYXRlcwoKLy8gbGlua2VkIHN0eWxlIHNoZWV0cyBpbiBhbiBpbXBvcnQgaGF2ZSB0aGVpciBvd24gcGF0aCBmaXhlZCB1cCB3aGVuIHRoZWlyIGNvbnRhaW5pbmcgaW1wb3J0IG1vZGlmaWVzIHBhdGhzCi8vIGxpbmtlZCBzdHlsZSBzaGVldHMgaW4gYW4gPGVsZW1lbnQ+IGFyZSBsb2FkZWQsIGFuZCB0aGUgY29udGVudCBnZXRzIHBhdGggZml4dXBzCi8vIGlubGluZSBzdHlsZSBzaGVldHMgZ2V0IHBhdGggZml4dXBzIHdoZW4gdGhlaXIgY29udGFpbmluZyBpbXBvcnQgbW9kaWZpZXMgcGF0aHMKCnZhciBsb2FkZXI7Cgp2YXIgaW1wb3J0ZXIgPSB7CiAgZG9jdW1lbnRzOiB7fSwKICBjYWNoZToge30sCiAgcHJlbG9hZFNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nLAogICAgJ2VsZW1lbnQgbGlua1tyZWw9JyArIFNUWUxFX0xJTktfVFlQRSArICddJywKICAgICd0ZW1wbGF0ZScsCiAgICAnc2NyaXB0W3NyY106bm90KFt0eXBlXSknLAogICAgJ3NjcmlwdFtzcmNdW3R5cGU9InRleHQvamF2YXNjcmlwdCJdJwogIF0uam9pbignLCcpLAogIGxvYWRlcjogZnVuY3Rpb24obmV4dCkgewogICAgLy8gY29uc3RydWN0IGEgbG9hZGVyIGluc3RhbmNlCiAgICBsb2FkZXIgPSBuZXcgTG9hZGVyKGltcG9ydGVyLmxvYWRlZCwgbmV4dCk7CiAgICAvLyBhbGlhcyB0aGUgbG9hZGVyIGNhY2hlIChmb3IgZGVidWdnaW5nKQogICAgbG9hZGVyLmNhY2hlID0gaW1wb3J0ZXIuY2FjaGU7CiAgICByZXR1cm4gbG9hZGVyOwogIH0sCiAgbG9hZDogZnVuY3Rpb24oZG9jLCBuZXh0KSB7CiAgICAvLyBjb25zdHJ1Y3QgYSBsb2FkZXIgaW5zdGFuY2UKICAgIGxvYWRlciA9IGltcG9ydGVyLmxvYWRlcihuZXh0KTsKICAgIC8vIGFkZCBub2RlcyBmcm9tIGRvY3VtZW50IGludG8gbG9hZGVyIHF1ZXVlCiAgICBpbXBvcnRlci5wcmVsb2FkKGRvYyk7CiAgfSwKICBwcmVsb2FkOiBmdW5jdGlvbihkb2MpIHsKICAgIC8vIGFsbCBwcmVsb2FkYWJsZSBub2RlcyBpbiBpbkRvY3VtZW50CiAgICB2YXIgbm9kZXMgPSBkb2MucXVlcnlTZWxlY3RvckFsbChpbXBvcnRlci5wcmVsb2FkU2VsZWN0b3JzKTsKICAgIC8vIGZyb20gdGhlIG1haW4gZG9jdW1lbnQsIG9ubHkgbG9hZCBpbXBvcnRzCiAgICAvLyBUT0RPKHNqbWlsZXMpOiBkbyB0aGlzIGJ5IGFsdGVyaW5nIHRoZSBzZWxlY3RvciBsaXN0IGluc3RlYWQKICAgIG5vZGVzID0gdGhpcy5maWx0ZXJNYWluRG9jdW1lbnROb2Rlcyhkb2MsIG5vZGVzKTsKICAgIC8vIGV4dHJhIGxpbmsgbm9kZXMgZnJvbSB0ZW1wbGF0ZXMsIGZpbHRlciB0ZW1wbGF0ZXMgb3V0IG9mIHRoZSBub2RlcyBsaXN0CiAgICBub2RlcyA9IHRoaXMuZXh0cmFjdFRlbXBsYXRlTm9kZXMobm9kZXMpOwogICAgLy8gYWRkIHRoZXNlIG5vZGVzIHRvIGxvYWRlcidzIHF1ZXVlCiAgICBsb2FkZXIuYWRkTm9kZXMobm9kZXMpOwogIH0sCiAgZmlsdGVyTWFpbkRvY3VtZW50Tm9kZXM6IGZ1bmN0aW9uKGRvYywgbm9kZXMpIHsKICAgIGlmIChkb2MgPT09IGRvY3VtZW50KSB7CiAgICAgIG5vZGVzID0gQXJyYXkucHJvdG90eXBlLmZpbHRlci5jYWxsKG5vZGVzLCBmdW5jdGlvbihuKSB7CiAgICAgICAgcmV0dXJuICFpc1NjcmlwdChuKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbm9kZXM7CiAgfSwKICBleHRyYWN0VGVtcGxhdGVOb2RlczogZnVuY3Rpb24obm9kZXMpIHsKICAgIHZhciBleHRyYSA9IFtdOwogICAgbm9kZXMgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgaWYgKG4ubG9jYWxOYW1lID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgaWYgKG4uY29udGVudCkgewogICAgICAgICAgdmFyIGwkID0gbi5jb250ZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2xpbmtbcmVsPScgKyBTVFlMRV9MSU5LX1RZUEUgKwogICAgICAgICAgICAnXScpOwogICAgICAgICAgaWYgKGwkLmxlbmd0aCkgewogICAgICAgICAgICBleHRyYSA9IGV4dHJhLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChsJCwgMCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICAgIGlmIChleHRyYS5sZW5ndGgpIHsKICAgICAgbm9kZXMgPSBub2Rlcy5jb25jYXQoZXh0cmEpOwogICAgfQogICAgcmV0dXJuIG5vZGVzOwogIH0sCiAgbG9hZGVkOiBmdW5jdGlvbih1cmwsIGVsdCwgcmVzb3VyY2UpIHsKICAgIGlmIChpc0RvY3VtZW50TGluayhlbHQpKSB7CiAgICAgIHZhciBkb2N1bWVudCA9IGltcG9ydGVyLmRvY3VtZW50c1t1cmxdOwogICAgICAvLyBpZiB3ZSd2ZSBuZXZlciBzZWVuIGEgZG9jdW1lbnQgYXQgdGhpcyB1cmwKICAgICAgaWYgKCFkb2N1bWVudCkgewogICAgICAgIC8vIGdlbmVyYXRlIGFuIEhUTUxEb2N1bWVudCBmcm9tIGRhdGEKICAgICAgICBkb2N1bWVudCA9IG1ha2VEb2N1bWVudChyZXNvdXJjZSwgdXJsKTsKICAgICAgICAvLyByZXNvbHZlIHJlc291cmNlIHBhdGhzIHJlbGF0aXZlIHRvIGhvc3QgZG9jdW1lbnQKICAgICAgICBwYXRoLnJlc29sdmVQYXRoc0luSFRNTChkb2N1bWVudCk7CiAgICAgICAgLy8gY2FjaGUgZG9jdW1lbnQKICAgICAgICBpbXBvcnRlci5kb2N1bWVudHNbdXJsXSA9IGRvY3VtZW50OwogICAgICAgIC8vIGFkZCBub2RlcyBmcm9tIHRoaXMgZG9jdW1lbnQgdG8gdGhlIGxvYWRlciBxdWV1ZQogICAgICAgIGltcG9ydGVyLnByZWxvYWQoZG9jdW1lbnQpOwogICAgICB9CiAgICAgIC8vIHN0b3JlIGltcG9ydCByZWNvcmQKICAgICAgZWx0LmltcG9ydCA9IHsKICAgICAgICBocmVmOiB1cmwsCiAgICAgICAgb3duZXJOb2RlOiBlbHQsCiAgICAgICAgY29udGVudDogZG9jdW1lbnQKICAgICAgfTsKICAgICAgLy8gc3RvcmUgZG9jdW1lbnQgcmVzb3VyY2UKICAgICAgZWx0LmNvbnRlbnQgPSByZXNvdXJjZSA9IGRvY3VtZW50OwogICAgfQogICAgLy8gc3RvcmUgZ2VuZXJpYyByZXNvdXJjZQogICAgLy8gVE9ETyhzb3J2ZWxsKTogZmFpbHMgZm9yIG5vZGVzIGluc2lkZSA8dGVtcGxhdGU+LmNvbnRlbnQKICAgIC8vIHNlZSBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9MjQ5MzgxLgogICAgZWx0Ll9fcmVzb3VyY2UgPSByZXNvdXJjZTsKICAgIC8vIGNzcyBwYXRoIGZpeHVwcwogICAgaWYgKGlzU3R5bGVzaGVldExpbmsoZWx0KSkgewogICAgICBwYXRoLnJlc29sdmVQYXRoc0luU3R5bGVzaGVldChlbHQpOwogICAgfQogIH0KfTsKCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGVsdCkgewogIHJldHVybiBpc0xpbmtSZWwoZWx0LCBJTVBPUlRfTElOS19UWVBFKTsKfQoKZnVuY3Rpb24gaXNTdHlsZXNoZWV0TGluayhlbHQpIHsKICByZXR1cm4gaXNMaW5rUmVsKGVsdCwgU1RZTEVfTElOS19UWVBFKTsKfQoKZnVuY3Rpb24gaXNMaW5rUmVsKGVsdCwgcmVsKSB7CiAgcmV0dXJuIGVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJyAmJiBlbHQuZ2V0QXR0cmlidXRlKCdyZWwnKSA9PT0gcmVsOwp9CgpmdW5jdGlvbiBpc1NjcmlwdChlbHQpIHsKICByZXR1cm4gZWx0LmxvY2FsTmFtZSA9PT0gJ3NjcmlwdCc7Cn0KCmZ1bmN0aW9uIG1ha2VEb2N1bWVudChyZXNvdXJjZSwgdXJsKSB7CiAgLy8gY3JlYXRlIGEgbmV3IEhUTUwgZG9jdW1lbnQKICB2YXIgZG9jID0gcmVzb3VyY2U7CiAgaWYgKCEoZG9jIGluc3RhbmNlb2YgRG9jdW1lbnQpKSB7CiAgICBkb2MgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoSU1QT1JUX0xJTktfVFlQRSk7CiAgICAvLyBpbnN0YWxsIGh0bWwKICAgIGRvYy5ib2R5LmlubmVySFRNTCA9IHJlc291cmNlOwogIH0KICAvLyBjYWNoZSB0aGUgbmV3IGRvY3VtZW50J3Mgc291cmNlIHVybAogIGRvYy5fVVJMID0gdXJsOwogIC8vIGVzdGFibGlzaCBhIHJlbGF0aXZlIHBhdGggdmlhIDxiYXNlPgogIHZhciBiYXNlID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2Jhc2UnKTsKICBiYXNlLnNldEF0dHJpYnV0ZSgnaHJlZicsIGRvY3VtZW50LmJhc2VVUkkgfHwgZG9jdW1lbnQuVVJMKTsKICBkb2MuaGVhZC5hcHBlbmRDaGlsZChiYXNlKTsKICAvLyBUT0RPKHNvcnZlbGwpOiBpZGVhbGx5IHRoaXMgY29kZSBpcyBub3QgYXdhcmUgb2YgVGVtcGxhdGUgcG9seWZpbGwsCiAgLy8gYnV0IGZvciBub3cgdGhlIHBvbHlmaWxsIG5lZWRzIGhlbHAgdG8gYm9vdHN0cmFwIHRoZXNlIHRlbXBsYXRlcwogIGlmICh3aW5kb3cuSFRNTFRlbXBsYXRlRWxlbWVudCAmJiBIVE1MVGVtcGxhdGVFbGVtZW50LmJvb3RzdHJhcCkgewogICAgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXAoZG9jKTsKICB9CiAgcmV0dXJuIGRvYzsKfQoKdmFyIExvYWRlciA9IGZ1bmN0aW9uKG9uTG9hZCwgb25Db21wbGV0ZSkgewogIHRoaXMub25sb2FkID0gb25Mb2FkOwogIHRoaXMub25jb21wbGV0ZSA9IG9uQ29tcGxldGU7CiAgdGhpcy5pbmZsaWdodCA9IDA7CiAgdGhpcy5wZW5kaW5nID0ge307CiAgdGhpcy5jYWNoZSA9IHt9Owp9OwoKTG9hZGVyLnByb3RvdHlwZSA9IHsKICBhZGROb2RlczogZnVuY3Rpb24obm9kZXMpIHsKICAgIC8vIG51bWJlciBvZiB0cmFuc2FjdGlvbnMgdG8gY29tcGxldGUKICAgIHRoaXMuaW5mbGlnaHQgKz0gbm9kZXMubGVuZ3RoOwogICAgLy8gY29tbWVuY2UgdHJhbnNhY3Rpb25zCiAgICBmb3JFYWNoKG5vZGVzLCB0aGlzLnJlcXVpcmUsIHRoaXMpOwogICAgLy8gYW55dGhpbmcgdG8gZG8/CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgcmVxdWlyZTogZnVuY3Rpb24oZWx0KSB7CiAgICB2YXIgdXJsID0gcGF0aC5ub2RlVXJsKGVsdCk7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBhZC1ob2MKICAgIGVsdC5fX25vZGVVcmwgPSB1cmw7CiAgICAvLyBkZWR1cGxpY2F0aW9uCiAgICBpZiAoIXRoaXMuZGVkdXBlKHVybCwgZWx0KSkgewogICAgICAvLyBmZXRjaCB0aGlzIHJlc291cmNlCiAgICAgIHRoaXMuZmV0Y2godXJsLCBlbHQpOwogICAgfQogIH0sCiAgZGVkdXBlOiBmdW5jdGlvbih1cmwsIGVsdCkgewogICAgaWYgKHRoaXMucGVuZGluZ1t1cmxdKSB7CiAgICAgIC8vIGFkZCB0byBsaXN0IG9mIG5vZGVzIHdhaXRpbmcgZm9yIGluVXJsCiAgICAgIHRoaXMucGVuZGluZ1t1cmxdLnB1c2goZWx0KTsKICAgICAgLy8gZG9uJ3QgbmVlZCBmZXRjaAogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmICh0aGlzLmNhY2hlW3VybF0pIHsKICAgICAgLy8gY29tcGxldGUgbG9hZCB1c2luZyBjYWNoZSBkYXRhCiAgICAgIHRoaXMub25sb2FkKHVybCwgZWx0LCBsb2FkZXIuY2FjaGVbdXJsXSk7CiAgICAgIC8vIGZpbmlzaGVkIHRoaXMgdHJhbnNhY3Rpb24KICAgICAgdGhpcy50YWlsKCk7CiAgICAgIC8vIGRvbid0IG5lZWQgZmV0Y2gKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBmaXJzdCBub2RlIHdhaXRpbmcgZm9yIGluVXJsCiAgICB0aGlzLnBlbmRpbmdbdXJsXSA9IFtlbHRdOwogICAgLy8gbmVlZCBmZXRjaCAobm90IGEgZHVwZSkKICAgIHJldHVybiBmYWxzZTsKICB9LAogIGZldGNoOiBmdW5jdGlvbih1cmwsIGVsdCkgewogICAgdmFyIHJlY2VpdmVYaHIgPSBmdW5jdGlvbihlcnIsIHJlc291cmNlKSB7CiAgICAgIHRoaXMucmVjZWl2ZSh1cmwsIGVsdCwgZXJyLCByZXNvdXJjZSk7CiAgICB9LmJpbmQodGhpcyk7CiAgICB4aHIubG9hZCh1cmwsIHJlY2VpdmVYaHIpOwogICAgLy8gVE9ETyhzb3J2ZWxsKTogYmxvY2tlZCBvbgogICAgLy8gaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTI1NzIyMQogICAgLy8geGhyJ2luZyBmb3IgYSBkb2N1bWVudCBtYWtlcyBzY3JpcHRzIGluIGltcG9ydHMgcnVubmFibGU7IG90aGVyd2lzZQogICAgLy8gdGhleSBhcmUgbm90OyBob3dldmVyLCBpdCByZXF1aXJlcyB0aGF0IHdlIGhhdmUgZG9jdHlwZT1odG1sIGluCiAgICAvLyB0aGUgaW1wb3J0IHdoaWNoIGlzIHVuYWNjZXB0YWJsZS4gVGhpcyBpcyBvbmx5IG5lZWRlZCBvbiBDaHJvbWUKICAgIC8vIHRvIGF2b2lkIHRoZSBidWcgYWJvdmUuCiAgICAvKgogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGVsdCkpIHsKICAgICAgeGhyLmxvYWREb2N1bWVudCh1cmwsIHJlY2VpdmVYaHIpOwogICAgfSBlbHNlIHsKICAgICAgeGhyLmxvYWQodXJsLCByZWNlaXZlWGhyKTsKICAgIH0KICAgICovCiAgfSwKICByZWNlaXZlOiBmdW5jdGlvbih1cmwsIGVsdCwgZXJyLCByZXNvdXJjZSkgewogICAgaWYgKCFlcnIpIHsKICAgICAgbG9hZGVyLmNhY2hlW3VybF0gPSByZXNvdXJjZTsKICAgIH0KICAgIGxvYWRlci5wZW5kaW5nW3VybF0uZm9yRWFjaChmdW5jdGlvbihlKSB7CiAgICAgIGlmICghZXJyKSB7CiAgICAgICAgdGhpcy5vbmxvYWQodXJsLCBlLCByZXNvdXJjZSk7CiAgICAgIH0KICAgICAgdGhpcy50YWlsKCk7CiAgICB9LCB0aGlzKTsKICAgIGxvYWRlci5wZW5kaW5nW3VybF0gPSBudWxsOwogIH0sCiAgdGFpbDogZnVuY3Rpb24oKSB7CiAgICAtLXRoaXMuaW5mbGlnaHQ7CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgY2hlY2tEb25lOiBmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5pbmZsaWdodCkgewogICAgICB0aGlzLm9uY29tcGxldGUoKTsKICAgIH0KICB9Cn07Cgp2YXIgVVJMX0FUVFJTID0gWydocmVmJywgJ3NyYycsICdhY3Rpb24nXTsKdmFyIFVSTF9BVFRSU19TRUxFQ1RPUiA9ICdbJyArIFVSTF9BVFRSUy5qb2luKCddLFsnKSArICddJzsKdmFyIFVSTF9URU1QTEFURV9TRUFSQ0ggPSAne3suKn19JzsKCnZhciBwYXRoID0gewogIG5vZGVVcmw6IGZ1bmN0aW9uKG5vZGUpIHsKICAgIHJldHVybiBwYXRoLnJlc29sdmVVcmwocGF0aC5kb2N1bWVudFVSTCwgcGF0aC5ocmVmT3JTcmMobm9kZSkpOwogIH0sCiAgaHJlZk9yU3JjOiBmdW5jdGlvbihub2RlKSB7CiAgICByZXR1cm4gbm9kZS5nZXRBdHRyaWJ1dGUoImhyZWYiKSB8fCBub2RlLmdldEF0dHJpYnV0ZSgic3JjIik7CiAgfSwKICBkb2N1bWVudFVybEZyb21Ob2RlOiBmdW5jdGlvbihub2RlKSB7CiAgICByZXR1cm4gcGF0aC5nZXREb2N1bWVudFVybChub2RlLm93bmVyRG9jdW1lbnQgfHwgbm9kZSk7CiAgfSwKICBnZXREb2N1bWVudFVybDogZnVuY3Rpb24oZG9jKSB7CiAgICB2YXIgdXJsID0gZG9jICYmCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NUG9seWZpbGwgaW50cnVzaW9uCiAgICAgICAgKGRvYy5fVVJMIHx8IChkb2MuaW1wbCAmJiBkb2MuaW1wbC5fVVJMKQogICAgICAgICAgICB8fCBkb2MuYmFzZVVSSSB8fCBkb2MuVVJMKQogICAgICAgICAgICAgICAgfHwgJyc7CiAgICAvLyB0YWtlIG9ubHkgdGhlIGxlZnQgc2lkZSBpZiB0aGVyZSBpcyBhICMKICAgIHJldHVybiB1cmwuc3BsaXQoJyMnKVswXTsKICB9LAogIHJlc29sdmVVcmw6IGZ1bmN0aW9uKGJhc2VVcmwsIHVybCkgewogICAgaWYgKHRoaXMuaXNBYnNVcmwodXJsKSkgewogICAgICByZXR1cm4gdXJsOwogICAgfQogICAgcmV0dXJuIHRoaXMuY29tcHJlc3NVcmwodGhpcy51cmxUb1BhdGgoYmFzZVVybCkgKyB1cmwpOwogIH0sCiAgcmVzb2x2ZVJlbGF0aXZlVXJsOiBmdW5jdGlvbihiYXNlVXJsLCB1cmwpIHsKICAgIGlmICh0aGlzLmlzQWJzVXJsKHVybCkpIHsKICAgICAgcmV0dXJuIHVybDsKICAgIH0KICAgIHJldHVybiB0aGlzLm1ha2VEb2N1bWVudFJlbFBhdGgodGhpcy5yZXNvbHZlVXJsKGJhc2VVcmwsIHVybCkpOwogIH0sCiAgaXNBYnNVcmw6IGZ1bmN0aW9uKHVybCkgewogICAgcmV0dXJuIC8oXmRhdGE6KXwoXmh0dHBbc10/Oil8KF5cLykvLnRlc3QodXJsKTsKICB9LAogIHVybFRvUGF0aDogZnVuY3Rpb24oYmFzZVVybCkgewogICAgdmFyIHBhcnRzID0gYmFzZVVybC5zcGxpdCgiLyIpOwogICAgcGFydHMucG9wKCk7CiAgICBwYXJ0cy5wdXNoKCcnKTsKICAgIHJldHVybiBwYXJ0cy5qb2luKCIvIik7CiAgfSwKICBjb21wcmVzc1VybDogZnVuY3Rpb24odXJsKSB7CiAgICB2YXIgc2VhcmNoID0gJyc7CiAgICB2YXIgc2VhcmNoUG9zID0gdXJsLmluZGV4T2YoJz8nKTsKICAgIC8vIHF1ZXJ5IHN0cmluZyBpcyBub3QgcGFydCBvZiB0aGUgcGF0aAogICAgaWYgKHNlYXJjaFBvcyA+IC0xKSB7CiAgICAgIHNlYXJjaCA9IHVybC5zdWJzdHJpbmcoc2VhcmNoUG9zKTsKICAgICAgdXJsID0gdXJsLnN1YnN0cmluZyhzZWFyY2hQb3MsIDApOwogICAgfQogICAgdmFyIHBhcnRzID0gdXJsLnNwbGl0KCcvJyk7CiAgICBmb3IgKHZhciBpPTAsIHA7IGk8cGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgcCA9IHBhcnRzW2ldOwogICAgICBpZiAocCA9PT0gJy4uJykgewogICAgICAgIHBhcnRzLnNwbGljZShpLTEsIDIpOwogICAgICAgIGkgLT0gMjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHBhcnRzLmpvaW4oJy8nKSArIHNlYXJjaDsKICB9LAogIG1ha2VEb2N1bWVudFJlbFBhdGg6IGZ1bmN0aW9uKHVybCkgewogICAgLy8gdGVzdCB1cmwgYWdhaW5zdCBkb2N1bWVudCB0byBzZWUgaWYgd2UgY2FuIGNvbnN0cnVjdCBhIHJlbGF0aXZlIHBhdGgKICAgIHBhdGgudXJsRWx0LmhyZWYgPSB1cmw7CiAgICAvLyBJRSBkb2VzIG5vdCBzZXQgaG9zdCBpZiBzYW1lIGFzIGRvY3VtZW50CiAgICBpZiAoIXBhdGgudXJsRWx0Lmhvc3QgfHwgCiAgICAgICAgKHBhdGgudXJsRWx0Lmhvc3QgPT09IHdpbmRvdy5sb2NhdGlvbi5ob3N0ICYmCiAgICAgICAgcGF0aC51cmxFbHQucHJvdG9jb2wgPT09IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCkpIHsKICAgICAgcmV0dXJuIHRoaXMubWFrZVJlbFBhdGgocGF0aC5kb2N1bWVudFVSTCwgcGF0aC51cmxFbHQuaHJlZik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdXJsOwogICAgfQogIH0sCiAgLy8gbWFrZSBhIHJlbGF0aXZlIHBhdGggZnJvbSBzb3VyY2UgdG8gdGFyZ2V0CiAgbWFrZVJlbFBhdGg6IGZ1bmN0aW9uKHNvdXJjZSwgdGFyZ2V0KSB7CiAgICB2YXIgcyA9IHNvdXJjZS5zcGxpdCgnLycpOwogICAgdmFyIHQgPSB0YXJnZXQuc3BsaXQoJy8nKTsKICAgIHdoaWxlIChzLmxlbmd0aCAmJiBzWzBdID09PSB0WzBdKXsKICAgICAgcy5zaGlmdCgpOwogICAgICB0LnNoaWZ0KCk7CiAgICB9CiAgICBmb3IodmFyIGkgPSAwLCBsID0gcy5sZW5ndGgtMTsgaSA8IGw7IGkrKykgewogICAgICB0LnVuc2hpZnQoJy4uJyk7CiAgICB9CiAgICB2YXIgciA9IHQuam9pbignLycpOwogICAgcmV0dXJuIHI7CiAgfSwKICByZXNvbHZlUGF0aHNJbkhUTUw6IGZ1bmN0aW9uKHJvb3QsIHVybCkgewogICAgdXJsID0gdXJsIHx8IHBhdGguZG9jdW1lbnRVcmxGcm9tTm9kZShyb290KQogICAgcGF0aC5yZXNvbHZlQXR0cmlidXRlcyhyb290LCB1cmwpOwogICAgcGF0aC5yZXNvbHZlU3R5bGVFbHRzKHJvb3QsIHVybCk7CiAgICAvLyBoYW5kbGUgdGVtcGxhdGUuY29udGVudAogICAgdmFyIHRlbXBsYXRlcyA9IHJvb3QucXVlcnlTZWxlY3RvckFsbCgndGVtcGxhdGUnKTsKICAgIGlmICh0ZW1wbGF0ZXMpIHsKICAgICAgZm9yRWFjaCh0ZW1wbGF0ZXMsIGZ1bmN0aW9uKHQpIHsKICAgICAgICBpZiAodC5jb250ZW50KSB7CiAgICAgICAgICBwYXRoLnJlc29sdmVQYXRoc0luSFRNTCh0LmNvbnRlbnQsIHVybCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LAogIHJlc29sdmVQYXRoc0luU3R5bGVzaGVldDogZnVuY3Rpb24oc2hlZXQpIHsKICAgIHZhciBkb2NVcmwgPSBwYXRoLm5vZGVVcmwoc2hlZXQpOwogICAgc2hlZXQuX19yZXNvdXJjZSA9IHBhdGgucmVzb2x2ZUNzc1RleHQoc2hlZXQuX19yZXNvdXJjZSwgZG9jVXJsKTsKICB9LAogIHJlc29sdmVTdHlsZUVsdHM6IGZ1bmN0aW9uKHJvb3QsIHVybCkgewogICAgdmFyIHN0eWxlcyA9IHJvb3QucXVlcnlTZWxlY3RvckFsbCgnc3R5bGUnKTsKICAgIGlmIChzdHlsZXMpIHsKICAgICAgZm9yRWFjaChzdHlsZXMsIGZ1bmN0aW9uKHN0eWxlKSB7CiAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBwYXRoLnJlc29sdmVDc3NUZXh0KHN0eWxlLnRleHRDb250ZW50LCB1cmwpOwogICAgICB9KTsKICAgIH0KICB9LAogIHJlc29sdmVDc3NUZXh0OiBmdW5jdGlvbihjc3NUZXh0LCBiYXNlVXJsKSB7CiAgICByZXR1cm4gY3NzVGV4dC5yZXBsYWNlKC91cmxcKFteKV0qXCkvZywgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgLy8gZmluZCB0aGUgdXJsIHBhdGgsIGlnbm9yZSBxdW90ZXMgaW4gdXJsIHN0cmluZwogICAgICB2YXIgdXJsUGF0aCA9IG1hdGNoLnJlcGxhY2UoL1siJ10vZywgIiIpLnNsaWNlKDQsIC0xKTsKICAgICAgdXJsUGF0aCA9IHBhdGgucmVzb2x2ZVJlbGF0aXZlVXJsKGJhc2VVcmwsIHVybFBhdGgpOwogICAgICByZXR1cm4gInVybCgiICsgdXJsUGF0aCArICIpIjsKICAgIH0pOwogIH0sCiAgcmVzb2x2ZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKHJvb3QsIHVybCkgewogICAgLy8gc2VhcmNoIGZvciBhdHRyaWJ1dGVzIHRoYXQgaG9zdCB1cmxzCiAgICB2YXIgbm9kZXMgPSByb290ICYmIHJvb3QucXVlcnlTZWxlY3RvckFsbChVUkxfQVRUUlNfU0VMRUNUT1IpOwogICAgaWYgKG5vZGVzKSB7CiAgICAgIGZvckVhY2gobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICB0aGlzLnJlc29sdmVOb2RlQXR0cmlidXRlcyhuLCB1cmwpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9LAogIHJlc29sdmVOb2RlQXR0cmlidXRlczogZnVuY3Rpb24obm9kZSwgdXJsKSB7CiAgICBVUkxfQVRUUlMuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIHZhciBhdHRyID0gbm9kZS5hdHRyaWJ1dGVzW3ZdOwogICAgICBpZiAoYXR0ciAmJiBhdHRyLnZhbHVlICYmCiAgICAgICAgIChhdHRyLnZhbHVlLnNlYXJjaChVUkxfVEVNUExBVEVfU0VBUkNIKSA8IDApKSB7CiAgICAgICAgdmFyIHVybFBhdGggPSBwYXRoLnJlc29sdmVSZWxhdGl2ZVVybCh1cmwsIGF0dHIudmFsdWUpOwogICAgICAgIGF0dHIudmFsdWUgPSB1cmxQYXRoOwogICAgICB9CiAgICB9KTsKICB9Cn07CgpwYXRoLmRvY3VtZW50VVJMID0gcGF0aC5nZXREb2N1bWVudFVybChkb2N1bWVudCk7CnBhdGgudXJsRWx0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwoKeGhyID0geGhyIHx8IHsKICBhc3luYzogdHJ1ZSwKICBvazogZnVuY3Rpb24ocmVxdWVzdCkgewogICAgcmV0dXJuIChyZXF1ZXN0LnN0YXR1cyA+PSAyMDAgJiYgcmVxdWVzdC5zdGF0dXMgPCAzMDApCiAgICAgICAgfHwgKHJlcXVlc3Quc3RhdHVzID09PSAzMDQpCiAgICAgICAgfHwgKHJlcXVlc3Quc3RhdHVzID09PSAwKTsKICB9LAogIGxvYWQ6IGZ1bmN0aW9uKHVybCwgbmV4dCwgbmV4dENvbnRleHQpIHsKICAgIHZhciByZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICBpZiAoc2NvcGUuZmxhZ3MuZGVidWcgfHwgc2NvcGUuZmxhZ3MuYnVzdCkgewogICAgICB1cmwgKz0gJz8nICsgTWF0aC5yYW5kb20oKTsKICAgIH0KICAgIHJlcXVlc3Qub3BlbignR0VUJywgdXJsLCB4aHIuYXN5bmMpOwogICAgcmVxdWVzdC5hZGRFdmVudExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgZnVuY3Rpb24oZSkgewogICAgICBpZiAocmVxdWVzdC5yZWFkeVN0YXRlID09PSA0KSB7CiAgICAgICAgbmV4dC5jYWxsKG5leHRDb250ZXh0LCAheGhyLm9rKHJlcXVlc3QpICYmIHJlcXVlc3QsCiAgICAgICAgICByZXF1ZXN0LnJlc3BvbnNlLCB1cmwpOwogICAgICB9CiAgICB9KTsKICAgIHJlcXVlc3Quc2VuZCgpOwogICAgcmV0dXJuIHJlcXVlc3Q7CiAgfSwKICBsb2FkRG9jdW1lbnQ6IGZ1bmN0aW9uKHVybCwgbmV4dCwgbmV4dENvbnRleHQpIHsKICAgIHRoaXMubG9hZCh1cmwsIG5leHQsIG5leHRDb250ZXh0KS5yZXNwb25zZVR5cGUgPSAnZG9jdW1lbnQnOwogIH0KfTsKCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsKCi8vIGV4cG9ydHMKCnNjb3BlLnBhdGggPSBwYXRoOwpzY29wZS54aHIgPSB4aHI7CnNjb3BlLmltcG9ydGVyID0gaW1wb3J0ZXI7CnNjb3BlLmdldERvY3VtZW50VXJsID0gcGF0aC5nZXREb2N1bWVudFVybDsKc2NvcGUuSU1QT1JUX0xJTktfVFlQRSA9IElNUE9SVF9MSU5LX1RZUEU7Cgp9KSh3aW5kb3cuSFRNTEltcG9ydHMpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihzY29wZSkgewoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSAnaW1wb3J0JzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IGZvciBwYXJzaW5nIGEgZG9jdW1lbnQgdHJlZQoKdmFyIGltcG9ydFBhcnNlciA9IHsKICBzZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJywKICAgICdsaW5rW3JlbD1zdHlsZXNoZWV0XScsCiAgICAnc3R5bGUnLAogICAgJ3NjcmlwdDpub3QoW3R5cGVdKScsCiAgICAnc2NyaXB0W3R5cGU9InRleHQvamF2YXNjcmlwdCJdJwogIF0sCiAgbWFwOiB7CiAgICBsaW5rOiAncGFyc2VMaW5rJywKICAgIHNjcmlwdDogJ3BhcnNlU2NyaXB0JywKICAgIHN0eWxlOiAncGFyc2VHZW5lcmljJwogIH0sCiAgcGFyc2U6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIGlmICghaW5Eb2N1bWVudC5fX2ltcG9ydFBhcnNlZCkgewogICAgICAvLyBvbmx5IHBhcnNlIG9uY2UKICAgICAgaW5Eb2N1bWVudC5fX2ltcG9ydFBhcnNlZCA9IHRydWU7CiAgICAgIC8vIGFsbCBwYXJzYWJsZSBlbGVtZW50cyBpbiBpbkRvY3VtZW50IChkZXB0aC1maXJzdCBwcmUtb3JkZXIgdHJhdmVyc2FsKQogICAgICB2YXIgZWx0cyA9IGluRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChpbXBvcnRQYXJzZXIuc2VsZWN0b3JzKTsKICAgICAgLy8gZm9yIGVhY2ggcGFyc2FibGUgbm9kZSB0eXBlLCBjYWxsIHRoZSBtYXBwZWQgcGFyc2luZyBtZXRob2QKICAgICAgZm9yRWFjaChlbHRzLCBmdW5jdGlvbihlKSB7CiAgICAgICAgaW1wb3J0UGFyc2VyW2ltcG9ydFBhcnNlci5tYXBbZS5sb2NhbE5hbWVdXShlKTsKICAgICAgfSk7CiAgICB9CiAgfSwKICBwYXJzZUxpbms6IGZ1bmN0aW9uKGxpbmtFbHQpIHsKICAgIGlmIChpc0RvY3VtZW50TGluayhsaW5rRWx0KSkgewogICAgICBpZiAobGlua0VsdC5jb250ZW50KSB7CiAgICAgICAgaW1wb3J0UGFyc2VyLnBhcnNlKGxpbmtFbHQuY29udGVudCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucGFyc2VHZW5lcmljKGxpbmtFbHQpOwogICAgfQogIH0sCiAgcGFyc2VHZW5lcmljOiBmdW5jdGlvbihlbHQpIHsKICAgIGlmIChuZWVkc01haW5Eb2N1bWVudENvbnRleHQoZWx0KSkgewogICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGVsdCk7CiAgICB9CiAgfSwKICBwYXJzZVNjcmlwdDogZnVuY3Rpb24oc2NyaXB0RWx0KSB7CiAgICBpZiAobmVlZHNNYWluRG9jdW1lbnRDb250ZXh0KHNjcmlwdEVsdCkpIHsKICAgICAgLy8gYWNxdWlyZSBjb2RlIHRvIGV4ZWN1dGUKICAgICAgdmFyIGNvZGUgPSAoc2NyaXB0RWx0Ll9fcmVzb3VyY2UgfHwgc2NyaXB0RWx0LnRleHRDb250ZW50KS50cmltKCk7CiAgICAgIGlmIChjb2RlKSB7CiAgICAgICAgLy8gY2FsY3VsYXRlIHNvdXJjZSBtYXAgaGludAogICAgICAgIHZhciBtb25pa2VyID0gc2NyaXB0RWx0Ll9fbm9kZVVybDsKICAgICAgICBpZiAoIW1vbmlrZXIpIHsKICAgICAgICAgIHZhciBtb25pa2VyID0gc2NvcGUucGF0aC5kb2N1bWVudFVybEZyb21Ob2RlKHNjcmlwdEVsdCk7CiAgICAgICAgICAvLyB0aGVyZSBjb3VsZCBiZSBtb3JlIHRoYW4gb25lIHNjcmlwdCB0aGlzIHVybAogICAgICAgICAgdmFyIHRhZyA9ICdbJyArIE1hdGguZmxvb3IoKE1hdGgucmFuZG9tKCkrMSkqMTAwMCkgKyAnXSc7CiAgICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiBQb2x5bWVyIGhhY2ssIHNob3VsZCBiZSBwbHVnZ2FibGUgaWYgd2UgbmVlZCB0byBhbGxvdyAKICAgICAgICAgIC8vIHRoaXMgc29ydCBvZiB0aGluZwogICAgICAgICAgdmFyIG1hdGNoZXMgPSBjb2RlLm1hdGNoKC9Qb2x5bWVyXChbJyJdKFteJyJdKikvKTsKICAgICAgICAgIHRhZyA9IG1hdGNoZXMgJiYgbWF0Y2hlc1sxXSB8fCB0YWc7CiAgICAgICAgICAvLyB0YWcgdGhlIG1vbmlrZXIKICAgICAgICAgIG1vbmlrZXIgKz0gJy8nICsgdGFnICsgJy5qcyc7CiAgICAgICAgfQogICAgICAgIC8vIHNvdXJjZSBtYXAgaGludAogICAgICAgIGNvZGUgKz0gIlxuLy8jIHNvdXJjZVVSTD0iICsgbW9uaWtlciArICJcbiI7CiAgICAgICAgLy8gZXZhbHVhdGUgdGhlIGNvZGUKICAgICAgICBldmFsLmNhbGwod2luZG93LCBjb2RlKTsKICAgICAgfQogICAgfQogIH0KfTsKCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsKCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGVsdCkgewogIHJldHVybiBlbHQubG9jYWxOYW1lID09PSAnbGluaycKICAgICAgJiYgZWx0LmdldEF0dHJpYnV0ZSgncmVsJykgPT09IElNUE9SVF9MSU5LX1RZUEU7Cn0KCmZ1bmN0aW9uIG5lZWRzTWFpbkRvY3VtZW50Q29udGV4dChub2RlKSB7CiAgLy8gbm9kZXMgY2FuIGJlIG1vdmVkIHRvIHRoZSBtYWluIGRvY3VtZW50OgogIC8vIGlmIHRoZXkgYXJlIGluIGEgdHJlZSBidXQgbm90IGluIHRoZSBtYWluIGRvY3VtZW50IGFuZCBub3QgY2hpbGRyZW4gb2YgPGVsZW1lbnQ+CiAgcmV0dXJuIG5vZGUucGFyZW50Tm9kZSAmJiAhaW5NYWluRG9jdW1lbnQobm9kZSkgCiAgICAgICYmICFpc0VsZW1lbnRFbGVtZW50Q2hpbGQobm9kZSk7Cn0KCmZ1bmN0aW9uIGluTWFpbkRvY3VtZW50KGVsdCkgewogIHJldHVybiBlbHQub3duZXJEb2N1bWVudCA9PT0gZG9jdW1lbnQgfHwKICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTVBvbHlmaWxsIGludHJ1c2lvbgogICAgZWx0Lm93bmVyRG9jdW1lbnQuaW1wbCA9PT0gZG9jdW1lbnQ7Cn0KCmZ1bmN0aW9uIGlzRWxlbWVudEVsZW1lbnRDaGlsZChlbHQpIHsKICByZXR1cm4gZWx0LnBhcmVudE5vZGUgJiYgZWx0LnBhcmVudE5vZGUubG9jYWxOYW1lID09PSAnZWxlbWVudCc7Cn0KCi8vIGV4cG9ydHMKCnNjb3BlLnBhcnNlciA9IGltcG9ydFBhcnNlcjsKCn0pKEhUTUxJbXBvcnRzKTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCl7CgovLyBib290c3RyYXAKCi8vIElFIHNoaW0gZm9yIEN1c3RvbUV2ZW50CmlmICh0eXBlb2Ygd2luZG93LkN1c3RvbUV2ZW50ICE9PSAnZnVuY3Rpb24nKSB7CiAgd2luZG93LkN1c3RvbUV2ZW50ID0gZnVuY3Rpb24oaW5UeXBlKSB7CiAgICAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogICAgIGUuaW5pdEV2ZW50KGluVHlwZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgcmV0dXJuIGU7CiAgfTsKfQoKZnVuY3Rpb24gYm9vdHN0cmFwKCkgewogIC8vIHByZWxvYWQgZG9jdW1lbnQgcmVzb3VyY2UgdHJlZXMKICBIVE1MSW1wb3J0cy5pbXBvcnRlci5sb2FkKGRvY3VtZW50LCBmdW5jdGlvbigpIHsKICAgIEhUTUxJbXBvcnRzLnBhcnNlci5wYXJzZShkb2N1bWVudCk7CiAgICBIVE1MSW1wb3J0cy5yZWFkeVRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIC8vIHNlbmQgSFRNTEltcG9ydHNMb2FkZWQgd2hlbiBmaW5pc2hlZAogICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudCgKICAgICAgbmV3IEN1c3RvbUV2ZW50KCdIVE1MSW1wb3J0c0xvYWRlZCcsIHtidWJibGVzOiB0cnVlfSkKICAgICk7CiAgfSk7Cn07CgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJykgewogIGJvb3RzdHJhcCgpOwp9IGVsc2UgewogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgYm9vdHN0cmFwKTsKfQoKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oKSB7CgovLyBpbXBvcnQKCnZhciBJTVBPUlRfTElOS19UWVBFID0gd2luZG93LkhUTUxJbXBvcnRzID8gSFRNTEltcG9ydHMuSU1QT1JUX0xJTktfVFlQRSA6ICdub25lJzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IGZvciBwYXJzaW5nIGEgZG9jdW1lbnQgdHJlZQoKdmFyIHBhcnNlciA9IHsKICBzZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJwogIF0sCiAgbWFwOiB7CiAgICBsaW5rOiAncGFyc2VMaW5rJwogIH0sCiAgcGFyc2U6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIGlmICghaW5Eb2N1bWVudC5fX3BhcnNlZCkgewogICAgICAvLyBvbmx5IHBhcnNlIG9uY2UKICAgICAgaW5Eb2N1bWVudC5fX3BhcnNlZCA9IHRydWU7CiAgICAgIC8vIGFsbCBwYXJzYWJsZSBlbGVtZW50cyBpbiBpbkRvY3VtZW50IChkZXB0aC1maXJzdCBwcmUtb3JkZXIgdHJhdmVyc2FsKQogICAgICB2YXIgZWx0cyA9IGluRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChwYXJzZXIuc2VsZWN0b3JzKTsKICAgICAgLy8gZm9yIGVhY2ggcGFyc2FibGUgbm9kZSB0eXBlLCBjYWxsIHRoZSBtYXBwZWQgcGFyc2luZyBtZXRob2QKICAgICAgZm9yRWFjaChlbHRzLCBmdW5jdGlvbihlKSB7CiAgICAgICAgcGFyc2VyW3BhcnNlci5tYXBbZS5sb2NhbE5hbWVdXShlKTsKICAgICAgfSk7CiAgICAgIC8vIHVwZ3JhZGUgYWxsIHVwZ3JhZGVhYmxlIHN0YXRpYyBlbGVtZW50cywgYW55dGhpbmcgZHluYW1pY2FsbHkKICAgICAgLy8gY3JlYXRlZCBzaG91bGQgYmUgY2F1Z2h0IGJ5IG9ic2VydmVyCiAgICAgIEN1c3RvbUVsZW1lbnRzLnVwZ3JhZGVEb2N1bWVudChpbkRvY3VtZW50KTsKICAgICAgLy8gb2JzZXJ2ZSBkb2N1bWVudCBmb3IgZG9tIGNoYW5nZXMKICAgICAgQ3VzdG9tRWxlbWVudHMub2JzZXJ2ZURvY3VtZW50KGluRG9jdW1lbnQpOwogICAgfQogIH0sCiAgcGFyc2VMaW5rOiBmdW5jdGlvbihsaW5rRWx0KSB7CiAgICAvLyBpbXBvcnRzCiAgICBpZiAoaXNEb2N1bWVudExpbmsobGlua0VsdCkpIHsKICAgICAgdGhpcy5wYXJzZUltcG9ydChsaW5rRWx0KTsKICAgIH0KICB9LAogIHBhcnNlSW1wb3J0OiBmdW5jdGlvbihsaW5rRWx0KSB7CiAgICBpZiAobGlua0VsdC5jb250ZW50KSB7CiAgICAgIHBhcnNlci5wYXJzZShsaW5rRWx0LmNvbnRlbnQpOwogICAgfQogIH0KfTsKCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGluRWx0KSB7CiAgcmV0dXJuIChpbkVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJwogICAgICAmJiBpbkVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSBJTVBPUlRfTElOS19UWVBFKTsKfQoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKLy8gZXhwb3J0cwoKQ3VzdG9tRWxlbWVudHMucGFyc2VyID0gcGFyc2VyOwoKfSkoKTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCl7CgovLyBib290c3RyYXAgcGFyc2luZwpmdW5jdGlvbiBib290c3RyYXAoKSB7CiAgLy8gcGFyc2UgZG9jdW1lbnQKICBDdXN0b21FbGVtZW50cy5wYXJzZXIucGFyc2UoZG9jdW1lbnQpOwogIC8vIG9uZSBtb3JlIHBhc3MgYmVmb3JlIHJlZ2lzdGVyIGlzICdsaXZlJwogIEN1c3RvbUVsZW1lbnRzLnVwZ3JhZGVEb2N1bWVudChkb2N1bWVudCk7ICAKICAvLyBjaG9vc2UgYXN5bmMKICB2YXIgYXN5bmMgPSB3aW5kb3cuUGxhdGZvcm0gJiYgUGxhdGZvcm0uZW5kT2ZNaWNyb3Rhc2sgPyAKICAgIFBsYXRmb3JtLmVuZE9mTWljcm90YXNrIDoKICAgIHNldFRpbWVvdXQ7CiAgYXN5bmMoZnVuY3Rpb24oKSB7CiAgICAvLyBzZXQgaW50ZXJuYWwgJ3JlYWR5JyBmbGFnLCBub3cgZG9jdW1lbnQucmVnaXN0ZXIgd2lsbCB0cmlnZ2VyIAogICAgLy8gc3luY2hyb25vdXMgdXBncmFkZXMKICAgIEN1c3RvbUVsZW1lbnRzLnJlYWR5ID0gdHJ1ZTsKICAgIC8vIGNhcHR1cmUgYmx1bnQgcHJvZmlsaW5nIGRhdGEKICAgIEN1c3RvbUVsZW1lbnRzLnJlYWR5VGltZSA9IERhdGUubm93KCk7CiAgICBpZiAod2luZG93LkhUTUxJbXBvcnRzKSB7CiAgICAgIEN1c3RvbUVsZW1lbnRzLmVsYXBzZWQgPSBDdXN0b21FbGVtZW50cy5yZWFkeVRpbWUgLSBIVE1MSW1wb3J0cy5yZWFkeVRpbWU7CiAgICB9CiAgICAvLyBub3RpZnkgdGhlIHN5c3RlbSB0aGF0IHdlIGFyZSBib290c3RyYXBwZWQKICAgIGRvY3VtZW50LmJvZHkuZGlzcGF0Y2hFdmVudCgKICAgICAgbmV3IEN1c3RvbUV2ZW50KCdXZWJDb21wb25lbnRzUmVhZHknLCB7YnViYmxlczogdHJ1ZX0pCiAgICApOwogIH0pOwp9CgovLyBDdXN0b21FdmVudCBzaGltIGZvciBJRQppZiAodHlwZW9mIHdpbmRvdy5DdXN0b21FdmVudCAhPT0gJ2Z1bmN0aW9uJykgewogIHdpbmRvdy5DdXN0b21FdmVudCA9IGZ1bmN0aW9uKGluVHlwZSkgewogICAgIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgICBlLmluaXRFdmVudChpblR5cGUsIHRydWUsIHRydWUpOwogICAgIHJldHVybiBlOwogIH07Cn0KCmlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7CiAgYm9vdHN0cmFwKCk7Cn0gZWxzZSB7CiAgdmFyIGxvYWRFdmVudCA9IHdpbmRvdy5IVE1MSW1wb3J0cyA/ICdIVE1MSW1wb3J0c0xvYWRlZCcgOiAnRE9NQ29udGVudExvYWRlZCc7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIobG9hZEV2ZW50LCBib290c3RyYXApOwp9Cgp9KSgpOwoKKGZ1bmN0aW9uICgpIHsKCi8qKiogVmFyaWFibGVzICoqKi8KCiAgdmFyIHdpbiA9IHdpbmRvdywKICAgIGRvYyA9IGRvY3VtZW50LAogICAgbm9vcCA9IGZ1bmN0aW9uKCl7fSwKICAgIHRydWVvcCA9IGZ1bmN0aW9uKCl7IHJldHVybiB0cnVlOyB9LAogICAgcmVnZXhQc2V1ZG9TcGxpdCA9IC8oW1x3LV0rKD86XChbXlwpXStcKSk/KS9nLAogICAgcmVnZXhQc2V1ZG9SZXBsYWNlID0gLyhcdyopKD86XCgoW15cKV0qKVwpKT8vLAogICAgcmVnZXhEaWdpdHMgPSAvKFxkKykvZywKICAgIGtleXBzZXVkbyA9IHsKICAgICAgYWN0aW9uOiBmdW5jdGlvbiAocHNldWRvLCBldmVudCkgewogICAgICAgIHJldHVybiBwc2V1ZG8udmFsdWUubWF0Y2gocmVnZXhEaWdpdHMpLmluZGV4T2YoU3RyaW5nKGV2ZW50LmtleUNvZGUpKSA+IC0xID09IChwc2V1ZG8ubmFtZSA9PSAna2V5cGFzcycpIHx8IG51bGw7CiAgICAgIH0KICAgIH0sCiAgICBwcmVmaXggPSAoZnVuY3Rpb24gKCkgewogICAgICB2YXIgc3R5bGVzID0gd2luLmdldENvbXB1dGVkU3R5bGUoZG9jLmRvY3VtZW50RWxlbWVudCwgJycpLAogICAgICAgICAgcHJlID0gKEFycmF5LnByb3RvdHlwZS5zbGljZQogICAgICAgICAgICAuY2FsbChzdHlsZXMpCiAgICAgICAgICAgIC5qb2luKCcnKQogICAgICAgICAgICAubWF0Y2goLy0obW96fHdlYmtpdHxtcyktLykgfHwgKHN0eWxlcy5PTGluayA9PT0gJycgJiYgWycnLCAnbyddKQogICAgICAgICAgKVsxXTsKICAgICAgcmV0dXJuIHsKICAgICAgICBkb206IHByZSA9PSAnbXMnID8gJ01TJyA6IHByZSwKICAgICAgICBsb3dlcmNhc2U6IHByZSwKICAgICAgICBjc3M6ICctJyArIHByZSArICctJywKICAgICAgICBqczogcHJlID09ICdtcycgPyBwcmUgOiBwcmVbMF0udG9VcHBlckNhc2UoKSArIHByZS5zdWJzdHIoMSkKICAgICAgfTsKICAgIH0pKCksCiAgICBtYXRjaFNlbGVjdG9yID0gRWxlbWVudC5wcm90b3R5cGUubWF0Y2hlc1NlbGVjdG9yIHx8IEVsZW1lbnQucHJvdG90eXBlW3ByZWZpeC5sb3dlcmNhc2UgKyAnTWF0Y2hlc1NlbGVjdG9yJ10sCiAgICBtdXRhdGlvbiA9IHdpbi5NdXRhdGlvbk9ic2VydmVyIHx8IHdpbltwcmVmaXguanMgKyAnTXV0YXRpb25PYnNlcnZlciddOwoKLyoqKiBGdW5jdGlvbnMgKioqLwoKLy8gVXRpbGl0aWVzCgogIHZhciB0eXBlQ2FjaGUgPSB7fSwKICAgICAgdHlwZVN0cmluZyA9IHR5cGVDYWNoZS50b1N0cmluZywKICAgICAgdHlwZVJlZ2V4cCA9IC9ccyhbYS16QS1aXSspLzsKICBmdW5jdGlvbiB0eXBlT2Yob2JqKSB7CiAgICB2YXIgdHlwZSA9IHR5cGVTdHJpbmcuY2FsbChvYmopOwogICAgcmV0dXJuIHR5cGVDYWNoZVt0eXBlXSB8fCAodHlwZUNhY2hlW3R5cGVdID0gdHlwZS5tYXRjaCh0eXBlUmVnZXhwKVsxXS50b0xvd2VyQ2FzZSgpKTsKICB9CgogIGZ1bmN0aW9uIGNsb25lKGl0ZW0sIHR5cGUpewogICAgdmFyIGZuID0gY2xvbmVbdHlwZSB8fCB0eXBlT2YoaXRlbSldOwogICAgcmV0dXJuIGZuID8gZm4oaXRlbSkgOiBpdGVtOwogIH0KICAgIGNsb25lLm9iamVjdCA9IGZ1bmN0aW9uKHNyYyl7CiAgICAgIHZhciBvYmogPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHNyYykgb2JqW2tleV0gPSBjbG9uZShzcmNba2V5XSk7CiAgICAgIHJldHVybiBvYmo7CiAgICB9OwogICAgY2xvbmUuYXJyYXkgPSBmdW5jdGlvbihzcmMpewogICAgICB2YXIgaSA9IHNyYy5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwogICAgICB3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGNsb25lKHNyY1tpXSk7CiAgICAgIHJldHVybiBhcnJheTsKICAgIH07CgogIHZhciB1bnNsaWNlYWJsZSA9IFsndW5kZWZpbmVkJywgJ251bGwnLCAnbnVtYmVyJywgJ2Jvb2xlYW4nLCAnc3RyaW5nJywgJ2Z1bmN0aW9uJ107CiAgZnVuY3Rpb24gdG9BcnJheShvYmopewogICAgcmV0dXJuIHVuc2xpY2VhYmxlLmluZGV4T2YodHlwZU9mKG9iaikpID09IC0xID8KICAgIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKG9iaiwgMCkgOgogICAgW29ial07CiAgfQoKLy8gRE9NCiAgdmFyIHN0ciA9ICcnOwogIGZ1bmN0aW9uIHF1ZXJ5KGVsZW1lbnQsIHNlbGVjdG9yKXsKICAgIHJldHVybiAoc2VsZWN0b3IgfHwgc3RyKS5sZW5ndGggPyB0b0FycmF5KGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikpIDogW107CiAgfQoKICBmdW5jdGlvbiBwYXJzZU11dGF0aW9ucyhlbGVtZW50LCBtdXRhdGlvbnMpIHsKICAgIHZhciBkaWZmID0geyBhZGRlZDogW10sIHJlbW92ZWQ6IFtdIH07CiAgICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihyZWNvcmQpewogICAgICByZWNvcmQuX211dGF0aW9uID0gdHJ1ZTsKICAgICAgZm9yICh2YXIgeiBpbiBkaWZmKSB7CiAgICAgICAgdmFyIHR5cGUgPSBlbGVtZW50Ll9yZWNvcmRzWyh6ID09ICdhZGRlZCcpID8gJ2luc2VydGVkJyA6ICdyZW1vdmVkJ10sCiAgICAgICAgICBub2RlcyA9IHJlY29yZFt6ICsgJ05vZGVzJ10sIGxlbmd0aCA9IG5vZGVzLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aCAmJiBkaWZmW3pdLmluZGV4T2Yobm9kZXNbaV0pID09IC0xOyBpKyspewogICAgICAgICAgZGlmZlt6XS5wdXNoKG5vZGVzW2ldKTsKICAgICAgICAgIHR5cGUuZm9yRWFjaChmdW5jdGlvbihmbil7CiAgICAgICAgICAgIGZuKG5vZGVzW2ldLCByZWNvcmQpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CgovLyBNaXhpbnMKCiAgZnVuY3Rpb24gbWVyZ2VPbmUoc291cmNlLCBrZXksIGN1cnJlbnQpewogICAgdmFyIHR5cGUgPSB0eXBlT2YoY3VycmVudCk7CiAgICBpZiAodHlwZSA9PSAnb2JqZWN0JyAmJiB0eXBlT2Yoc291cmNlW2tleV0pID09ICdvYmplY3QnKSB4dGFnLm1lcmdlKHNvdXJjZVtrZXldLCBjdXJyZW50KTsKICAgIGVsc2Ugc291cmNlW2tleV0gPSBjbG9uZShjdXJyZW50LCB0eXBlKTsKICAgIHJldHVybiBzb3VyY2U7CiAgfQoKICBmdW5jdGlvbiBtZXJnZU1peGluKHR5cGUsIG1peGluLCBvcHRpb24pIHsKICAgIHZhciBvcmlnaW5hbCA9IHt9OwogICAgZm9yICh2YXIgbyBpbiBvcHRpb24pIG9yaWdpbmFsW28uc3BsaXQoJzonKVswXV0gPSB0cnVlOwogICAgZm9yICh2YXIgeCBpbiBtaXhpbikgaWYgKCFvcmlnaW5hbFt4LnNwbGl0KCc6JylbMF1dKSBvcHRpb25beF0gPSBtaXhpblt4XTsKICB9CgogIGZ1bmN0aW9uIGFwcGx5TWl4aW5zKHRhZykgewogICAgdGFnLm1peGlucy5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHZhciBtaXhpbiA9IHh0YWcubWl4aW5zW25hbWVdOwogICAgICBmb3IgKHZhciB0eXBlIGluIG1peGluKSB7CiAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICBjYXNlICdsaWZlY3ljbGUnOiBjYXNlICdtZXRob2RzJzoKICAgICAgICAgICAgbWVyZ2VNaXhpbih0eXBlLCBtaXhpblt0eXBlXSwgdGFnW3R5cGVdKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdhY2Nlc3NvcnMnOiBjYXNlICdwcm90b3R5cGUnOgogICAgICAgICAgICBmb3IgKHZhciB6IGluIG1peGluW3R5cGVdKSBtZXJnZU1peGluKHosIG1peGluW3R5cGVdLCB0YWcuYWNjZXNzb3JzKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdldmVudHMnOgogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHRhZzsKICB9CgovLyBFdmVudHMKCiAgZnVuY3Rpb24gZGVsZWdhdGVBY3Rpb24ocHNldWRvLCBldmVudCkgewogICAgdmFyIHRhcmdldCA9IHF1ZXJ5KHRoaXMsIHBzZXVkby52YWx1ZSkuZmlsdGVyKGZ1bmN0aW9uKG5vZGUpewogICAgICByZXR1cm4gbm9kZSA9PSBldmVudC50YXJnZXQgfHwgbm9kZS5jb250YWlucyA/IG5vZGUuY29udGFpbnMoZXZlbnQudGFyZ2V0KSA6IG51bGw7CiAgICB9KVswXTsKICAgIHJldHVybiB0YXJnZXQgPyBwc2V1ZG8ubGlzdGVuZXIgPSBwc2V1ZG8ubGlzdGVuZXIuYmluZCh0YXJnZXQpIDogbnVsbDsKICB9CgogIGZ1bmN0aW9uIHRvdWNoRmlsdGVyKGV2ZW50KSB7CiAgICBpZiAoZXZlbnQudHlwZS5tYXRjaCgndG91Y2gnKSl7CiAgICAgIGV2ZW50LnRhcmdldC5fX3RvdWNoZWRfXyA9IHRydWU7CiAgICB9CiAgICBlbHNlIGlmIChldmVudC50YXJnZXQuX190b3VjaGVkX18gJiYgZXZlbnQudHlwZS5tYXRjaCgnbW91c2UnKSl7CiAgICAgIGRlbGV0ZSBldmVudC50YXJnZXQuX190b3VjaGVkX187CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRmxvd0V2ZW50KHR5cGUpIHsKICAgIHZhciBmbG93ID0gdHlwZSA9PSAnb3Zlcic7CiAgICByZXR1cm4gewogICAgICBhdHRhY2g6ICdPdmVyZmxvd0V2ZW50JyBpbiB3aW4gPyAnb3ZlcmZsb3djaGFuZ2VkJyA6IFtdLAogICAgICBjb25kaXRpb246IGZ1bmN0aW9uIChldmVudCwgY3VzdG9tKSB7CiAgICAgICAgZXZlbnQuZmxvdyA9IHR5cGU7CiAgICAgICAgcmV0dXJuIGV2ZW50LnR5cGUgPT0gKHR5cGUgKyAnZmxvdycpIHx8CiAgICAgICAgKChldmVudC5vcmllbnQgPT09IDAgJiYgZXZlbnQuaG9yaXpvbnRhbE92ZXJmbG93ID09IGZsb3cpIHx8CiAgICAgICAgKGV2ZW50Lm9yaWVudCA9PSAxICYmIGV2ZW50LnZlcnRpY2FsT3ZlcmZsb3cgPT0gZmxvdykgfHwKICAgICAgICAoZXZlbnQub3JpZW50ID09IDIgJiYgZXZlbnQuaG9yaXpvbnRhbE92ZXJmbG93ID09IGZsb3cgJiYgZXZlbnQudmVydGljYWxPdmVyZmxvdyA9PSBmbG93KSk7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiB3cml0ZVByb3BlcnR5KGtleSwgZXZlbnQsIGJhc2UsIGRlc2MpewogICAgaWYgKGRlc2MpIGV2ZW50W2tleV0gPSBiYXNlW2tleV07CiAgICBlbHNlIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShldmVudCwga2V5LCB7CiAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICB2YWx1ZTogYmFzZVtrZXldCiAgICB9KTsKICB9CgogIHZhciBza2lwUHJvcHMgPSB7fTsKICBmb3IgKHZhciB6IGluIGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdDdXN0b21FdmVudCcpKSBza2lwUHJvcHNbel0gPSAxOwogIGZ1bmN0aW9uIGluaGVyaXRFdmVudChldmVudCwgYmFzZSl7CiAgICB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZXZlbnQsICd0YXJnZXQnKTsKICAgIGZvciAodmFyIHogaW4gYmFzZSkgewogICAgICBpZiAoIXNraXBQcm9wc1t6XSkgd3JpdGVQcm9wZXJ0eSh6LCBldmVudCwgYmFzZSwgZGVzYyk7CiAgICB9CiAgICBldmVudC5iYXNlRXZlbnQgPSBiYXNlOwogIH0KCi8vIEFjY2Vzc29ycwoKICBmdW5jdGlvbiBnZXRBcmdzKGF0dHIsIHZhbHVlKXsKICAgIHJldHVybiB7CiAgICAgIHZhbHVlOiBhdHRyLmJvb2xlYW4gPyAnJyA6IHZhbHVlLAogICAgICBtZXRob2Q6IGF0dHIuYm9vbGVhbiAmJiAhdmFsdWUgPyAncmVtb3ZlQXR0cmlidXRlJyA6ICdzZXRBdHRyaWJ1dGUnCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gbW9kQXR0cihlbGVtZW50LCBhdHRyLCBuYW1lLCB2YWx1ZSl7CiAgICB2YXIgYXJncyA9IGdldEFyZ3MoYXR0ciwgdmFsdWUpOwogICAgZWxlbWVudFthcmdzLm1ldGhvZF0obmFtZSwgYXJncy52YWx1ZSk7CiAgfQoKICBmdW5jdGlvbiBzeW5jQXR0cihlbGVtZW50LCBhdHRyLCBuYW1lLCB2YWx1ZSwgbWV0aG9kKXsKICAgIHZhciBub2RlcyA9IGF0dHIucHJvcGVydHkgPyBbZWxlbWVudC54dGFnW2F0dHIucHJvcGVydHldXSA6IGF0dHIuc2VsZWN0b3IgPyB4dGFnLnF1ZXJ5KGVsZW1lbnQsIGF0dHIuc2VsZWN0b3IpIDogW10sCiAgICAgICAgaW5kZXggPSBub2Rlcy5sZW5ndGg7CiAgICB3aGlsZSAoaW5kZXgtLSkgbm9kZXNbaW5kZXhdW21ldGhvZF0obmFtZSwgdmFsdWUpOwogIH0KCiAgZnVuY3Rpb24gdXBkYXRlVmlldyhlbGVtZW50LCBuYW1lLCB2YWx1ZSl7CiAgICBpZiAoZWxlbWVudC5fX3ZpZXdfXyl7CiAgICAgIGVsZW1lbnQuX192aWV3X18udXBkYXRlQmluZGluZ1ZhbHVlKGVsZW1lbnQsIG5hbWUsIHZhbHVlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGF0dGFjaFByb3BlcnRpZXModGFnLCBwcm9wLCB6LCBhY2Nlc3NvciwgYXR0ciwgbmFtZSl7CiAgICB2YXIga2V5ID0gei5zcGxpdCgnOicpLCB0eXBlID0ga2V5WzBdOwogICAgaWYgKHR5cGUgPT0gJ2dldCcpIHsKICAgICAga2V5WzBdID0gcHJvcDsKICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQgPSB4dGFnLmFwcGx5UHNldWRvcyhrZXkuam9pbignOicpLCBhY2Nlc3Nvclt6XSwgdGFnLnBzZXVkb3MpOwogICAgfQogICAgZWxzZSBpZiAodHlwZSA9PSAnc2V0JykgewogICAgICBrZXlbMF0gPSBwcm9wOwogICAgICB2YXIgc2V0dGVyID0gdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQgPSB4dGFnLmFwcGx5UHNldWRvcyhrZXkuam9pbignOicpLCBhdHRyID8gZnVuY3Rpb24odmFsdWUpewogICAgICAgIHRoaXMueHRhZy5fc2tpcFNldCA9IHRydWU7CiAgICAgICAgaWYgKCF0aGlzLnh0YWcuX3NraXBBdHRyKSBtb2RBdHRyKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICBpZiAodGhpcy54dGFnLl9za2lwQXR0ciAmJiBhdHRyLnNraXApIGRlbGV0ZSB0aGlzLnh0YWcuX3NraXBBdHRyOwogICAgICAgIGFjY2Vzc29yW3pdLmNhbGwodGhpcywgYXR0ci5ib29sZWFuID8gISF2YWx1ZSA6IHZhbHVlKTsKICAgICAgICB1cGRhdGVWaWV3KHRoaXMsIG5hbWUsIHZhbHVlKTsKICAgICAgICBkZWxldGUgdGhpcy54dGFnLl9za2lwU2V0OwogICAgICB9IDogYWNjZXNzb3Jbel0gPyBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgYWNjZXNzb3Jbel0uY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgdXBkYXRlVmlldyh0aGlzLCBuYW1lLCB2YWx1ZSk7CiAgICAgIH0gOiBudWxsLCB0YWcucHNldWRvcyk7CgogICAgICBpZiAoYXR0cikgYXR0ci5zZXR0ZXIgPSBzZXR0ZXI7CiAgICB9CiAgICBlbHNlIHRhZy5wcm90b3R5cGVbcHJvcF1bel0gPSBhY2Nlc3Nvclt6XTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQWNjZXNzb3IodGFnLCBwcm9wKXsKICAgIHRhZy5wcm90b3R5cGVbcHJvcF0gPSB7fTsKICAgIHZhciBhY2Nlc3NvciA9IHRhZy5hY2Nlc3NvcnNbcHJvcF0sCiAgICAgICAgYXR0ciA9IGFjY2Vzc29yLmF0dHJpYnV0ZSwKICAgICAgICBuYW1lID0gYXR0ciAmJiBhdHRyLm5hbWUgPyBhdHRyLm5hbWUudG9Mb3dlckNhc2UoKSA6IHByb3A7CgogICAgaWYgKGF0dHIpIHsKICAgICAgYXR0ci5rZXkgPSBwcm9wOwogICAgICB0YWcuYXR0cmlidXRlc1tuYW1lXSA9IGF0dHI7CiAgICB9CgogICAgZm9yICh2YXIgeiBpbiBhY2Nlc3NvcikgYXR0YWNoUHJvcGVydGllcyh0YWcsIHByb3AsIHosIGFjY2Vzc29yLCBhdHRyLCBuYW1lKTsKCiAgICBpZiAoYXR0cikgewogICAgICBpZiAoIXRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0KSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IChhdHRyLmJvb2xlYW4gPyAnaGFzJyA6ICdnZXQnKSArICdBdHRyaWJ1dGUnOwogICAgICAgIHRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0ID0gZnVuY3Rpb24oKXsKICAgICAgICAgIHJldHVybiB0aGlzW21ldGhvZF0obmFtZSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAoIXRhZy5wcm90b3R5cGVbcHJvcF0uc2V0KSB0YWcucHJvdG90eXBlW3Byb3BdLnNldCA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICBtb2RBdHRyKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICB1cGRhdGVWaWV3KHRoaXMsIG5hbWUsIHZhbHVlKTsKICAgICAgfTsKICAgIH0KICB9CgovKioqIFgtVGFnIE9iamVjdCBEZWZpbml0aW9uICoqKi8KCiAgdmFyIHh0YWcgPSB7CiAgICB0YWdzOiB7fSwKICAgIGRlZmF1bHRPcHRpb25zOiB7CiAgICAgIHBzZXVkb3M6IFtdLAogICAgICBtaXhpbnM6IFtdLAogICAgICBldmVudHM6IHt9LAogICAgICBtZXRob2RzOiB7fSwKICAgICAgYWNjZXNzb3JzOiB7fSwKICAgICAgbGlmZWN5Y2xlOiB7fSwKICAgICAgYXR0cmlidXRlczoge30sCiAgICAgICdwcm90b3R5cGUnOiB7CiAgICAgICAgeHRhZzogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gdGhpcy5fX3h0YWdfXyA/IHRoaXMuX194dGFnX18gOiAodGhpcy5fX3h0YWdfXyA9IHsgZGF0YToge30gfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcmVnaXN0ZXI6IGZ1bmN0aW9uIChuYW1lLCBvcHRpb25zKSB7CiAgICAgIHZhciBfbmFtZTsKICAgICAgaWYgKHR5cGVvZiBuYW1lID09ICdzdHJpbmcnKSB7CiAgICAgICAgX25hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBzYXZlIHByb3RvdHlwZSBmb3IgYWN0dWFsIG9iamVjdCBjcmVhdGlvbiBiZWxvdwogICAgICB2YXIgYmFzZVByb3RvdHlwZSA9IG9wdGlvbnMucHJvdG90eXBlOwogICAgICBkZWxldGUgb3B0aW9ucy5wcm90b3R5cGU7CgogICAgICB2YXIgdGFnID0geHRhZy50YWdzW19uYW1lXSA9IGFwcGx5TWl4aW5zKHh0YWcubWVyZ2Uoe30sIHh0YWcuZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpKTsKCiAgICAgIGZvciAodmFyIHogaW4gdGFnLmV2ZW50cykgdGFnLmV2ZW50c1t6XSA9IHh0YWcucGFyc2VFdmVudCh6LCB0YWcuZXZlbnRzW3pdKTsKICAgICAgZm9yICh6IGluIHRhZy5saWZlY3ljbGUpIHRhZy5saWZlY3ljbGVbei5zcGxpdCgnOicpWzBdXSA9IHh0YWcuYXBwbHlQc2V1ZG9zKHosIHRhZy5saWZlY3ljbGVbel0sIHRhZy5wc2V1ZG9zKTsKICAgICAgZm9yICh6IGluIHRhZy5tZXRob2RzKSB0YWcucHJvdG90eXBlW3ouc3BsaXQoJzonKVswXV0gPSB7IHZhbHVlOiB4dGFnLmFwcGx5UHNldWRvcyh6LCB0YWcubWV0aG9kc1t6XSwgdGFnLnBzZXVkb3MpLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGZvciAoeiBpbiB0YWcuYWNjZXNzb3JzKSBwYXJzZUFjY2Vzc29yKHRhZywgeik7CgogICAgICB2YXIgcmVhZHkgPSB0YWcubGlmZWN5Y2xlLmNyZWF0ZWQgfHwgdGFnLmxpZmVjeWNsZS5yZWFkeTsKICAgICAgdGFnLnByb3RvdHlwZS5jcmVhdGVkQ2FsbGJhY2sgPSB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24oKXsKICAgICAgICAgIHZhciBlbGVtZW50ID0gdGhpczsKICAgICAgICAgIHh0YWcuYWRkRXZlbnRzKHRoaXMsIHRhZy5ldmVudHMpOwogICAgICAgICAgdGFnLm1peGlucy5mb3JFYWNoKGZ1bmN0aW9uKG1peGluKXsKICAgICAgICAgICAgaWYgKHh0YWcubWl4aW5zW21peGluXS5ldmVudHMpIHh0YWcuYWRkRXZlbnRzKGVsZW1lbnQsIHh0YWcubWl4aW5zW21peGluXS5ldmVudHMpOwogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgb3V0cHV0ID0gcmVhZHkgPyByZWFkeS5hcHBseSh0aGlzLCB0b0FycmF5KGFyZ3VtZW50cykpIDogbnVsbDsKICAgICAgICAgIGZvciAodmFyIG5hbWUgaW4gdGFnLmF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lXSwKICAgICAgICAgICAgICAgIGhhc0F0dHIgPSB0aGlzLmhhc0F0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgaWYgKGhhc0F0dHIgfHwgYXR0ci5ib29sZWFuKSB7CiAgICAgICAgICAgICAgdGhpc1thdHRyLmtleV0gPSBhdHRyLmJvb2xlYW4gPyBoYXNBdHRyIDogdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRhZy5wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICAgICAgb2JqLm9uQWRkLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAodGFnLmxpZmVjeWNsZS5pbnNlcnRlZCkgdGFnLnByb3RvdHlwZS5lbnRlcmVkVmlld0NhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5pbnNlcnRlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBpZiAodGFnLmxpZmVjeWNsZS5yZW1vdmVkKSB0YWcucHJvdG90eXBlLmxlZnREb2N1bWVudENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5yZW1vdmVkLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLmF0dHJpYnV0ZUNoYW5nZWQpIHRhZy5wcm90b3R5cGUuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5hdHRyaWJ1dGVDaGFuZ2VkLCBlbnVtZXJhYmxlOiB0cnVlIH07CgogICAgICB2YXIgc2V0QXR0cmlidXRlID0gdGFnLnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgfHwgSFRNTEVsZW1lbnQucHJvdG90eXBlLnNldEF0dHJpYnV0ZTsKICAgICAgdGFnLnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSB7CiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgZW51bWJlcmFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSl7CiAgICAgICAgICB2YXIgYXR0ciA9IHRhZy5hdHRyaWJ1dGVzW25hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICBpZiAoIXRoaXMueHRhZy5fc2tpcEF0dHIpIHNldEF0dHJpYnV0ZS5jYWxsKHRoaXMsIG5hbWUsIGF0dHIgJiYgYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSk7CiAgICAgICAgICBpZiAoYXR0cikgewogICAgICAgICAgICBpZiAoYXR0ci5zZXR0ZXIgJiYgIXRoaXMueHRhZy5fc2tpcFNldCkgewogICAgICAgICAgICAgIHRoaXMueHRhZy5fc2tpcEF0dHIgPSB0cnVlOwogICAgICAgICAgICAgIGF0dHIuc2V0dGVyLmNhbGwodGhpcywgYXR0ci5ib29sZWFuID8gdHJ1ZSA6IHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YWx1ZSA9IGF0dHIuc2tpcCA/IGF0dHIuYm9vbGVhbiA/IHRoaXMuaGFzQXR0cmlidXRlKG5hbWUpIDogdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkgOiB2YWx1ZTsKICAgICAgICAgICAgc3luY0F0dHIodGhpcywgYXR0ciwgbmFtZSwgYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSwgJ3NldEF0dHJpYnV0ZScpOwogICAgICAgICAgfQogICAgICAgICAgZGVsZXRlIHRoaXMueHRhZy5fc2tpcEF0dHI7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIHJlbW92ZUF0dHJpYnV0ZSA9IHRhZy5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlIHx8IEhUTUxFbGVtZW50LnByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGU7CiAgICAgIHRhZy5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlID0gewogICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgIGVudW1iZXJhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiAobmFtZSl7CiAgICAgICAgICB2YXIgYXR0ciA9IHRhZy5hdHRyaWJ1dGVzW25hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICBpZiAoIXRoaXMueHRhZy5fc2tpcEF0dHIpIHJlbW92ZUF0dHJpYnV0ZS5jYWxsKHRoaXMsIG5hbWUpOwogICAgICAgICAgaWYgKGF0dHIpIHsKICAgICAgICAgICAgaWYgKGF0dHIuc2V0dGVyICYmICF0aGlzLnh0YWcuX3NraXBTZXQpIHsKICAgICAgICAgICAgICB0aGlzLnh0YWcuX3NraXBBdHRyID0gdHJ1ZTsKICAgICAgICAgICAgICBhdHRyLnNldHRlci5jYWxsKHRoaXMsIGF0dHIuYm9vbGVhbiA/IGZhbHNlIDogdW5kZWZpbmVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzeW5jQXR0cih0aGlzLCBhdHRyLCBuYW1lLCB1bmRlZmluZWQsICdyZW1vdmVBdHRyaWJ1dGUnKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlbGV0ZSB0aGlzLnh0YWcuX3NraXBBdHRyOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciBlbGVtZW50UHJvdG8gPSBiYXNlUHJvdG90eXBlID8KICAgICAgICBiYXNlUHJvdG90eXBlIDoKICAgICAgICAgIG9wdGlvbnNbJ2V4dGVuZHMnXSA/CiAgICAgICAgICAgIE9iamVjdC5jcmVhdGUoZG9jLmNyZWF0ZUVsZW1lbnQob3B0aW9uc1snZXh0ZW5kcyddKQogICAgICAgICAgICAgIC5jb25zdHJ1Y3RvcikucHJvdG90eXBlIDoKICAgICAgICAgIHdpbi5IVE1MRWxlbWVudC5wcm90b3R5cGU7CgogICAgICB2YXIgZGVmaW5pdGlvbiA9IHsKICAgICAgICAncHJvdG90eXBlJzogT2JqZWN0LmNyZWF0ZShlbGVtZW50UHJvdG8sIHRhZy5wcm90b3R5cGUpCiAgICAgIH07CiAgICAgIGlmIChvcHRpb25zWydleHRlbmRzJ10pIHsKICAgICAgICBkZWZpbml0aW9uWydleHRlbmRzJ10gPSBvcHRpb25zWydleHRlbmRzJ107CiAgICAgIH0KICAgICAgcmV0dXJuIGRvYy5yZWdpc3RlcihfbmFtZSwgZGVmaW5pdGlvbik7CiAgICB9LAoKICAgIC8qIEV4cG9zZWQgVmFyaWFibGVzICovCgogICAgbWl4aW5zOiB7fSwKICAgIHByZWZpeDogcHJlZml4LAogICAgdG91Y2hlczogewogICAgICBhY3RpdmU6IFtdLAogICAgICBjaGFuZ2VkOiBbXQogICAgfSwKICAgIGNhcHR1cmVFdmVudHM6IFsnZm9jdXMnLCAnYmx1cicsICdzY3JvbGwnLCAndW5kZXJmbG93JywgJ292ZXJmbG93JywgJ292ZXJmbG93Y2hhbmdlZCddLAogICAgY3VzdG9tRXZlbnRzOiB7CiAgICAgIG92ZXJmbG93OiBjcmVhdGVGbG93RXZlbnQoJ292ZXInKSwKICAgICAgdW5kZXJmbG93OiBjcmVhdGVGbG93RXZlbnQoJ3VuZGVyJyksCiAgICAgIGFuaW1hdGlvbnN0YXJ0OiB7CiAgICAgICAgYXR0YWNoOiBbcHJlZml4LmRvbSArICdBbmltYXRpb25TdGFydCddCiAgICAgIH0sCiAgICAgIGFuaW1hdGlvbmVuZDogewogICAgICAgIGF0dGFjaDogW3ByZWZpeC5kb20gKyAnQW5pbWF0aW9uRW5kJ10KICAgICAgfSwKICAgICAgdHJhbnNpdGlvbmVuZDogewogICAgICAgIGF0dGFjaDogW3ByZWZpeC5kb20gKyAnVHJhbnNpdGlvbkVuZCddCiAgICAgIH0sCiAgICAgIG1vdmU6IHsKICAgICAgICBhdHRhY2g6IFsnbW91c2Vtb3ZlJywgJ3RvdWNobW92ZSddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgZW50ZXI6IHsKICAgICAgICBhdHRhY2g6IFsnbW91c2VvdmVyJywgJ3RvdWNoZW50ZXInXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIGxlYXZlOiB7CiAgICAgICAgYXR0YWNoOiBbJ21vdXNlb3V0JywgJ3RvdWNobGVhdmUnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcHN0YXJ0OiB7CiAgICAgICAgb2JzZXJ2ZTogewogICAgICAgICAgbW91c2Vkb3duOiBkb2MsCiAgICAgICAgICB0b3VjaHN0YXJ0OiBkb2MKICAgICAgICB9LAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwZW5kOiB7CiAgICAgICAgb2JzZXJ2ZTogewogICAgICAgICAgbW91c2V1cDogZG9jLAogICAgICAgICAgdG91Y2hlbmQ6IGRvYwogICAgICAgIH0sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBtb3ZlOiB7CiAgICAgICAgYXR0YWNoOiBbJ3RhcHN0YXJ0JywgJ2RyYWdlbmQnLCAndG91Y2hjYW5jZWwnXSwKICAgICAgICBjb25kaXRpb246IGZ1bmN0aW9uKGV2ZW50LCBjdXN0b20pewogICAgICAgICAgc3dpdGNoIChldmVudC50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgJ21vdmUnOiAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGNhc2UgJ2RyYWdvdmVyJzoKICAgICAgICAgICAgICB2YXIgbGFzdCA9IGN1c3RvbS5sYXN0RHJhZyB8fCB7fTsKICAgICAgICAgICAgICBjdXN0b20ubGFzdERyYWcgPSBldmVudDsKICAgICAgICAgICAgICByZXR1cm4gKGxhc3QucGFnZVggIT0gZXZlbnQucGFnZVggJiYgbGFzdC5wYWdlWSAhPSBldmVudC5wYWdlWSkgfHwgbnVsbDsKICAgICAgICAgICAgY2FzZSAndGFwc3RhcnQnOgogICAgICAgICAgICAgIGN1c3RvbS50b3VjaGVzID0gY3VzdG9tLnRvdWNoZXMgfHwgMTsKICAgICAgICAgICAgICBpZiAoIWN1c3RvbS5tb3ZlKSB7CiAgICAgICAgICAgICAgICBjdXN0b20uY3VycmVudCA9IHRoaXM7CiAgICAgICAgICAgICAgICBjdXN0b20ubW92ZSA9IHh0YWcuYWRkRXZlbnRzKHRoaXMsIHsKICAgICAgICAgICAgICAgICAgbW92ZTogY3VzdG9tLmxpc3RlbmVyLAogICAgICAgICAgICAgICAgICBkcmFnb3ZlcjogY3VzdG9tLmxpc3RlbmVyCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGN1c3RvbS50YXBlbmQgPSB4dGFnLmFkZEV2ZW50KGRvYywgJ3RhcGVuZCcsIGN1c3RvbS5saXN0ZW5lcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICd0YXBlbmQnOiBjYXNlICdkcmFnZW5kJzogY2FzZSAndG91Y2hjYW5jZWwnOgogICAgICAgICAgICAgIGN1c3RvbS50b3VjaGVzLS07CiAgICAgICAgICAgICAgaWYgKCFjdXN0b20udG91Y2hlcykgewogICAgICAgICAgICAgICAgeHRhZy5yZW1vdmVFdmVudHMoY3VzdG9tLmN1cnJlbnQgLCBjdXN0b20ubW92ZSB8fCB7fSk7CiAgICAgICAgICAgICAgICB4dGFnLnJlbW92ZUV2ZW50KGRvYywgY3VzdG9tLnRhcGVuZCB8fCB7fSk7CiAgICAgICAgICAgICAgICBkZWxldGUgY3VzdG9tLmxhc3REcmFnOwogICAgICAgICAgICAgICAgZGVsZXRlIGN1c3RvbS5jdXJyZW50OwogICAgICAgICAgICAgICAgZGVsZXRlIGN1c3RvbS50YXBlbmQ7CiAgICAgICAgICAgICAgICBkZWxldGUgY3VzdG9tLm1vdmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHBzZXVkb3M6IHsKICAgICAga2V5cGFzczoga2V5cHNldWRvLAogICAgICBrZXlmYWlsOiBrZXlwc2V1ZG8sCiAgICAgIGRlbGVnYXRlOiB7IGFjdGlvbjogZGVsZWdhdGVBY3Rpb24gfSwKICAgICAgd2l0aGluOiB7CiAgICAgICAgYWN0aW9uOiBkZWxlZ2F0ZUFjdGlvbiwKICAgICAgICBvbkFkZDogZnVuY3Rpb24ocHNldWRvKXsKICAgICAgICAgIHZhciBjb25kaXRpb24gPSBwc2V1ZG8uc291cmNlLmNvbmRpdGlvbjsKICAgICAgICAgIGlmIChjb25kaXRpb24pIHBzZXVkby5zb3VyY2UuY29uZGl0aW9uID0gZnVuY3Rpb24oZXZlbnQsIGN1c3RvbSl7CiAgICAgICAgICAgIHJldHVybiB4dGFnLnF1ZXJ5KHRoaXMsIHBzZXVkby52YWx1ZSkuZmlsdGVyKGZ1bmN0aW9uKG5vZGUpewogICAgICAgICAgICAgIHJldHVybiBub2RlID09IGV2ZW50LnRhcmdldCB8fCBub2RlLmNvbnRhaW5zID8gbm9kZS5jb250YWlucyhldmVudC50YXJnZXQpIDogbnVsbDsKICAgICAgICAgICAgfSlbMF0gPyBjb25kaXRpb24uY2FsbCh0aGlzLCBldmVudCwgY3VzdG9tKSA6IG51bGw7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJldmVudGFibGU6IHsKICAgICAgICBhY3Rpb246IGZ1bmN0aW9uIChwc2V1ZG8sIGV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qIFVUSUxJVElFUyAqLwoKICAgIGNsb25lOiBjbG9uZSwKICAgIHR5cGVPZjogdHlwZU9mLAogICAgdG9BcnJheTogdG9BcnJheSwKCiAgICB3cmFwOiBmdW5jdGlvbiAob3JpZ2luYWwsIGZuKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgcmV0dXJuZWQgPSBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICByZXR1cm4gcmV0dXJuZWQgPT09IGZhbHNlID8gZmFsc2UgOiBmbi5hcHBseSh0aGlzLCB0eXBlb2YgcmV0dXJuZWQgIT0gJ3VuZGVmaW5lZCcgPyB0b0FycmF5KHJldHVybmVkKSA6IGFyZ3MpOwogICAgICB9OwogICAgfSwKCiAgICBtZXJnZTogZnVuY3Rpb24oc291cmNlLCBrLCB2KXsKICAgICAgaWYgKHR5cGVPZihrKSA9PSAnc3RyaW5nJykgcmV0dXJuIG1lcmdlT25lKHNvdXJjZSwgaywgdik7CiAgICAgIGZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CiAgICAgICAgdmFyIG9iamVjdCA9IGFyZ3VtZW50c1tpXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBtZXJnZU9uZShzb3VyY2UsIGtleSwgb2JqZWN0W2tleV0pOwogICAgICB9CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9LAoKICAgIHVpZDogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLDEwKTsKICAgIH0sCgogICAgLyogRE9NICovCgogICAgcXVlcnk6IHF1ZXJ5LAoKICAgIHNraXBUcmFuc2l0aW9uOiBmdW5jdGlvbihlbGVtZW50LCBmbiwgYmluZCl7CiAgICAgIHZhciBwcm9wID0gcHJlZml4LmpzICsgJ1RyYW5zaXRpb25Qcm9wZXJ0eSc7CiAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICdub25lJzsKICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY2FsbGJhY2s7CiAgICAgICAgaWYgKGZuKSBjYWxsYmFjayA9IGZuLmNhbGwoYmluZCk7CiAgICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICcnOwogICAgICAgICAgaWYgKGNhbGxiYWNrKSB4dGFnLnJlcXVlc3RGcmFtZShjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKCiAgICByZXF1ZXN0RnJhbWU6IChmdW5jdGlvbigpewogICAgICB2YXIgcmFmID0gd2luLnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbltwcmVmaXgubG93ZXJjYXNlICsgJ1JlcXVlc3RBbmltYXRpb25GcmFtZSddIHx8CiAgICAgICAgZnVuY3Rpb24oZm4peyByZXR1cm4gd2luLnNldFRpbWVvdXQoZm4sIDIwKTsgfTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZuKXsKICAgICAgICByZXR1cm4gcmFmLmNhbGwod2luLCBmbik7CiAgICAgIH07CiAgICB9KSgpLAoKICAgIG1hdGNoU2VsZWN0b3I6IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICByZXR1cm4gbWF0Y2hTZWxlY3Rvci5jYWxsKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAoZWxlbWVudCwgbWV0aG9kLCB2YWx1ZSkgewogICAgICBlbGVtZW50W21ldGhvZF0gPSB2YWx1ZTsKICAgICAgaWYgKHdpbmRvdy5DdXN0b21FbGVtZW50cykgQ3VzdG9tRWxlbWVudHMudXBncmFkZUFsbChlbGVtZW50KTsKICAgIH0sCgogICAgaW5uZXJIVE1MOiBmdW5jdGlvbihlbCwgaHRtbCl7CiAgICAgIHh0YWcuc2V0KGVsLCAnaW5uZXJIVE1MJywgaHRtbCk7CiAgICB9LAoKICAgIGhhc0NsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQuY2xhc3NOYW1lLnNwbGl0KCcgJykuaW5kZXhPZihrbGFzcy50cmltKCkpPi0xOwogICAgfSwKCiAgICBhZGRDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHZhciBsaXN0ID0gZWxlbWVudC5jbGFzc05hbWUudHJpbSgpLnNwbGl0KCcgJyk7CiAgICAgIGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBpZiAoIX5saXN0LmluZGV4T2YobmFtZSkpIGxpc3QucHVzaChuYW1lKTsKICAgICAgfSk7CiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gbGlzdC5qb2luKCcgJykudHJpbSgpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0sCgogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICB2YXIgY2xhc3NlcyA9IGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpOwogICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnRyaW0oKS5zcGxpdCgnICcpLmZpbHRlcihmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHJldHVybiBuYW1lICYmICF+Y2xhc3Nlcy5pbmRleE9mKG5hbWUpOwogICAgICB9KS5qb2luKCcgJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfSwKCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHJldHVybiB4dGFnW3h0YWcuaGFzQ2xhc3MoZWxlbWVudCwga2xhc3MpID8gJ3JlbW92ZUNsYXNzJyA6ICdhZGRDbGFzcyddLmNhbGwobnVsbCwgZWxlbWVudCwga2xhc3MpOwogICAgfSwKCiAgICBxdWVyeUNoaWxkcmVuOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgdmFyIGlkID0gZWxlbWVudC5pZCwKICAgICAgICBndWlkID0gZWxlbWVudC5pZCA9IGlkIHx8ICd4XycgKyB4dGFnLnVpZCgpLAogICAgICAgIGF0dHIgPSAnIycgKyBndWlkICsgJyA+ICc7CiAgICAgIHNlbGVjdG9yID0gYXR0ciArIChzZWxlY3RvciArICcnKS5yZXBsYWNlKCcsJywgJywnICsgYXR0ciwgJ2cnKTsKICAgICAgdmFyIHJlc3VsdCA9IGVsZW1lbnQucGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTsKICAgICAgaWYgKCFpZCkgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CiAgICAgIHJldHVybiB0b0FycmF5KHJlc3VsdCk7CiAgICB9LAoKICAgIGNyZWF0ZUZyYWdtZW50OiBmdW5jdGlvbihjb250ZW50KSB7CiAgICAgIHZhciBmcmFnID0gZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgaWYgKGNvbnRlbnQpIHsKICAgICAgICB2YXIgZGl2ID0gZnJhZy5hcHBlbmRDaGlsZChkb2MuY3JlYXRlRWxlbWVudCgnZGl2JykpLAogICAgICAgICAgbm9kZXMgPSB0b0FycmF5KGNvbnRlbnQubm9kZU5hbWUgPyBhcmd1bWVudHMgOiAhKGRpdi5pbm5lckhUTUwgPSBjb250ZW50KSB8fCBkaXYuY2hpbGRyZW4pLAogICAgICAgICAgbGVuZ3RoID0gbm9kZXMubGVuZ3RoLAogICAgICAgICAgaW5kZXggPSAwOwogICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgZnJhZy5pbnNlcnRCZWZvcmUobm9kZXNbaW5kZXgrK10sIGRpdik7CiAgICAgICAgZnJhZy5yZW1vdmVDaGlsZChkaXYpOwogICAgICB9CiAgICAgIHJldHVybiBmcmFnOwogICAgfSwKCiAgICBtYW5pcHVsYXRlOiBmdW5jdGlvbihlbGVtZW50LCBmbil7CiAgICAgIHZhciBuZXh0ID0gZWxlbWVudC5uZXh0U2libGluZywKICAgICAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGUsCiAgICAgICAgZnJhZyA9IGRvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgcmV0dXJuZWQgPSBmbi5jYWxsKGZyYWcuYXBwZW5kQ2hpbGQoZWxlbWVudCksIGZyYWcpIHx8IGVsZW1lbnQ7CiAgICAgIGlmIChuZXh0KSBwYXJlbnQuaW5zZXJ0QmVmb3JlKHJldHVybmVkLCBuZXh0KTsKICAgICAgZWxzZSBwYXJlbnQuYXBwZW5kQ2hpbGQocmV0dXJuZWQpOwogICAgfSwKCiAgICAvKiBQU0VVRE9TICovCgogICAgYXBwbHlQc2V1ZG9zOiBmdW5jdGlvbihrZXksIGZuLCBlbGVtZW50LCBzb3VyY2UpIHsKICAgICAgdmFyIGxpc3RlbmVyID0gZm4sCiAgICAgICAgICBwc2V1ZG9zID0ge307CiAgICAgIGlmIChrZXkubWF0Y2goJzonKSkgewogICAgICAgIHZhciBzcGxpdCA9IGtleS5tYXRjaChyZWdleFBzZXVkb1NwbGl0KSwKICAgICAgICAgICAgaSA9IHNwbGl0Lmxlbmd0aDsKICAgICAgICB3aGlsZSAoLS1pKSB7CiAgICAgICAgICBzcGxpdFtpXS5yZXBsYWNlKHJlZ2V4UHNldWRvUmVwbGFjZSwgZnVuY3Rpb24gKG1hdGNoLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoIXh0YWcucHNldWRvc1tuYW1lXSkgdGhyb3cgInBzZXVkbyBub3QgZm91bmQ6ICIgKyBuYW1lICsgIiAiICsgc3BsaXQ7CiAgICAgICAgICAgIHZhciBwc2V1ZG8gPSBwc2V1ZG9zW2ldID0gT2JqZWN0LmNyZWF0ZSh4dGFnLnBzZXVkb3NbbmFtZV0pOwogICAgICAgICAgICAgICAgcHNldWRvLmtleSA9IGtleTsKICAgICAgICAgICAgICAgIHBzZXVkby5uYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIHBzZXVkby52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgcHNldWRvWydhcmd1bWVudHMnXSA9ICh2YWx1ZSB8fCAnJykuc3BsaXQoJywnKTsKICAgICAgICAgICAgICAgIHBzZXVkby5hY3Rpb24gPSBwc2V1ZG8uYWN0aW9uIHx8IHRydWVvcDsKICAgICAgICAgICAgICAgIHBzZXVkby5zb3VyY2UgPSBzb3VyY2U7CiAgICAgICAgICAgIHZhciBsYXN0ID0gbGlzdGVuZXI7CiAgICAgICAgICAgIGxpc3RlbmVyID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICAgICAgICAgICAgb2JqID0gewogICAgICAgICAgICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgICAgICAgIHNvdXJjZTogc291cmNlLAogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyOiBsYXN0CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdmFyIG91dHB1dCA9IHBzZXVkby5hY3Rpb24uYXBwbHkodGhpcywgW29ial0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICBpZiAob3V0cHV0ID09PSBudWxsIHx8IG91dHB1dCA9PT0gZmFsc2UpIHJldHVybiBvdXRwdXQ7CiAgICAgICAgICAgICAgcmV0dXJuIG9iai5saXN0ZW5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgJiYgcHNldWRvLm9uQWRkKSB7CiAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKSBwc2V1ZG8ub25BZGQuY2FsbChlbGVtZW50LCBwc2V1ZG8pOwogICAgICAgICAgICAgIGVsc2UgZWxlbWVudC5wdXNoKHBzZXVkbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKHZhciB6IGluIHBzZXVkb3MpIHsKICAgICAgICBpZiAocHNldWRvc1t6XS5vbkNvbXBpbGVkKSBsaXN0ZW5lciA9IHBzZXVkb3Nbel0ub25Db21waWxlZChsaXN0ZW5lciwgcHNldWRvc1t6XSkgfHwgbGlzdGVuZXI7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgfSwKCiAgICByZW1vdmVQc2V1ZG9zOiBmdW5jdGlvbihlbGVtZW50LCBldmVudCl7CiAgICAgIGV2ZW50Ll9wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICBpZiAob2JqLm9uUmVtb3ZlKSBvYmoub25SZW1vdmUuY2FsbChlbGVtZW50LCBvYmopOwogICAgICB9KTsKICAgIH0sCgogIC8qKiogRXZlbnRzICoqKi8KCiAgICBwYXJzZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbikgewogICAgICB2YXIgcHNldWRvcyA9IHR5cGUuc3BsaXQoJzonKSwKICAgICAgICAgIGtleSA9IHBzZXVkb3Muc2hpZnQoKSwKICAgICAgICAgIGN1c3RvbSA9IHh0YWcuY3VzdG9tRXZlbnRzW2tleV0sCiAgICAgICAgICBldmVudCA9IHh0YWcubWVyZ2UoewogICAgICAgICAgICB0eXBlOiBrZXksCiAgICAgICAgICAgIHN0YWNrOiBub29wLAogICAgICAgICAgICBjb25kaXRpb246IHRydWVvcCwKICAgICAgICAgICAgYXR0YWNoOiBbXSwKICAgICAgICAgICAgX2F0dGFjaDogW10sCiAgICAgICAgICAgIHBzZXVkb3M6ICcnLAogICAgICAgICAgICBfcHNldWRvczogW10sCiAgICAgICAgICAgIG9uQWRkOiBub29wLAogICAgICAgICAgICBvblJlbW92ZTogbm9vcAogICAgICAgICAgfSwgY3VzdG9tIHx8IHt9KTsKICAgICAgZXZlbnQuYXR0YWNoID0gdG9BcnJheShldmVudC5iYXNlIHx8IGV2ZW50LmF0dGFjaCk7CiAgICAgIGV2ZW50LmNoYWluID0ga2V5ICsgKGV2ZW50LnBzZXVkb3MubGVuZ3RoID8gJzonICsgZXZlbnQucHNldWRvcyA6ICcnKSArIChwc2V1ZG9zLmxlbmd0aCA/ICc6JyArIHBzZXVkb3Muam9pbignOicpIDogJycpOwogICAgICB2YXIgY29uZGl0aW9uID0gZXZlbnQuY29uZGl0aW9uOwogICAgICBldmVudC5jb25kaXRpb24gPSBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgdCA9IGUudG91Y2hlcywgdHQgPSBlLnRhcmdldFRvdWNoZXM7CiAgICAgICAgcmV0dXJuIGNvbmRpdGlvbi5hcHBseSh0aGlzLCB0b0FycmF5KGFyZ3VtZW50cykpOwogICAgICB9OwogICAgICB2YXIgc3RhY2sgPSB4dGFnLmFwcGx5UHNldWRvcyhldmVudC5jaGFpbiwgZm4sIGV2ZW50Ll9wc2V1ZG9zLCBldmVudCk7CiAgICAgIGV2ZW50LnN0YWNrID0gZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIHQgPSBlLnRvdWNoZXMsIHR0ID0gZS50YXJnZXRUb3VjaGVzOwogICAgICAgIHZhciBkZXRhaWwgPSBlLmRldGFpbCB8fCB7fTsKICAgICAgICBpZiAoIWRldGFpbC5fX3N0YWNrX18pIHJldHVybiBzdGFjay5hcHBseSh0aGlzLCB0b0FycmF5KGFyZ3VtZW50cykpOwogICAgICAgIGVsc2UgaWYgKGRldGFpbC5fX3N0YWNrX18gPT0gc3RhY2spIHsKICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICBlLmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICAgICAgICByZXR1cm4gc3RhY2suYXBwbHkodGhpcywgdG9BcnJheShhcmd1bWVudHMpKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGV2ZW50Lmxpc3RlbmVyID0gZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICAgIG91dHB1dCA9IGV2ZW50LmNvbmRpdGlvbi5hcHBseSh0aGlzLCBhcmdzLmNvbmNhdChbZXZlbnRdKSk7CiAgICAgICAgaWYgKCFvdXRwdXQpIHJldHVybiBvdXRwdXQ7CiAgICAgICAgaWYgKGUudHlwZSAhPSBrZXkpIHh0YWcuZmlyZUV2ZW50KGUudGFyZ2V0LCBrZXksIHsgYmFzZUV2ZW50OiBlLCBkZXRhaWw6IHsgX19zdGFja19fOiBzdGFjayB9IH0pOwogICAgICAgIGVsc2UgcmV0dXJuIGV2ZW50LnN0YWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9OwogICAgICBldmVudC5hdHRhY2guZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgZXZlbnQuX2F0dGFjaC5wdXNoKHh0YWcucGFyc2VFdmVudChuYW1lLCBldmVudC5saXN0ZW5lcikpOwogICAgICB9KTsKICAgICAgaWYgKGN1c3RvbSAmJiBjdXN0b20ub2JzZXJ2ZSAmJiAhY3VzdG9tLl9fb2JzZXJ2aW5nX18pIHsKICAgICAgICBjdXN0b20ub2JzZXJ2ZXIgPSBmdW5jdGlvbihlKXsKICAgICAgICAgIHZhciBvdXRwdXQgPSBldmVudC5jb25kaXRpb24uYXBwbHkodGhpcywgdG9BcnJheShhcmd1bWVudHMpLmNvbmNhdChbY3VzdG9tXSkpOwogICAgICAgICAgaWYgKCFvdXRwdXQpIHJldHVybiBvdXRwdXQ7CiAgICAgICAgICB4dGFnLmZpcmVFdmVudChlLnRhcmdldCwga2V5LCB7IGJhc2VFdmVudDogZSB9KTsKICAgICAgICB9OwogICAgICAgIGZvciAodmFyIHogaW4gY3VzdG9tLm9ic2VydmUpIHh0YWcuYWRkRXZlbnQoY3VzdG9tLm9ic2VydmVbel0gfHwgZG9jdW1lbnQsIHosIGN1c3RvbS5vYnNlcnZlciwgdHJ1ZSk7CiAgICAgICAgY3VzdG9tLl9fb2JzZXJ2aW5nX18gPSB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBldmVudDsKICAgIH0sCgogICAgYWRkRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbiwgY2FwdHVyZSkgewogICAgICB2YXIgZXZlbnQgPSAodHlwZW9mIGZuID09ICdmdW5jdGlvbicpID8geHRhZy5wYXJzZUV2ZW50KHR5cGUsIGZuKSA6IGZuOwogICAgICBldmVudC5fcHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgb2JqLm9uQWRkLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgfSk7CiAgICAgIGV2ZW50Ll9hdHRhY2guZm9yRWFjaChmdW5jdGlvbihvYmopIHsKICAgICAgICB4dGFnLmFkZEV2ZW50KGVsZW1lbnQsIG9iai50eXBlLCBvYmopOwogICAgICB9KTsKICAgICAgZXZlbnQub25BZGQuY2FsbChlbGVtZW50LCBldmVudCwgZXZlbnQubGlzdGVuZXIpOwogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQudHlwZSwgZXZlbnQuc3RhY2ssIGNhcHR1cmUgfHwgeHRhZy5jYXB0dXJlRXZlbnRzLmluZGV4T2YoZXZlbnQudHlwZSkgPiAtMSk7CiAgICAgIHJldHVybiBldmVudDsKICAgIH0sCgogICAgYWRkRXZlbnRzOiBmdW5jdGlvbiAoZWxlbWVudCwgb2JqKSB7CiAgICAgIHZhciBldmVudHMgPSB7fTsKICAgICAgZm9yICh2YXIgeiBpbiBvYmopIHsKICAgICAgICBldmVudHNbel0gPSB4dGFnLmFkZEV2ZW50KGVsZW1lbnQsIHosIG9ialt6XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50czsKICAgIH0sCgogICAgcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBldmVudCkgewogICAgICBldmVudCA9IGV2ZW50IHx8IHR5cGU7CiAgICAgIGV2ZW50Lm9uUmVtb3ZlLmNhbGwoZWxlbWVudCwgZXZlbnQsIGV2ZW50Lmxpc3RlbmVyKTsKICAgICAgeHRhZy5yZW1vdmVQc2V1ZG9zKGVsZW1lbnQsIGV2ZW50KTsKICAgICAgZXZlbnQuX2F0dGFjaC5mb3JFYWNoKGZ1bmN0aW9uKG9iaikgewogICAgICAgIHh0YWcucmVtb3ZlRXZlbnQoZWxlbWVudCwgb2JqKTsKICAgICAgfSk7CiAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudC50eXBlLCBldmVudC5zdGFjayk7CiAgICB9LAoKICAgIHJlbW92ZUV2ZW50czogZnVuY3Rpb24oZWxlbWVudCwgb2JqKXsKICAgICAgZm9yICh2YXIgeiBpbiBvYmopIHh0YWcucmVtb3ZlRXZlbnQoZWxlbWVudCwgb2JqW3pdKTsKICAgIH0sCgogICAgZmlyZUV2ZW50OiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBvcHRpb25zLCB3YXJuKXsKICAgICAgdmFyIGV2ZW50ID0gZG9jLmNyZWF0ZUV2ZW50KCdDdXN0b21FdmVudCcpOwogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgaWYgKHdhcm4pIGNvbnNvbGUud2FybignZmlyZUV2ZW50IGhhcyBiZWVuIG1vZGlmaWVkLCBtb3JlIGluZm8gaGVyZTogJyk7CiAgICAgIGV2ZW50LmluaXRDdXN0b21FdmVudCh0eXBlLAogICAgICAgIG9wdGlvbnMuYnViYmxlcyAhPT0gZmFsc2UsCiAgICAgICAgb3B0aW9ucy5jYW5jZWxhYmxlICE9PSBmYWxzZSwKICAgICAgICBvcHRpb25zLmRldGFpbAogICAgICApOwogICAgICBpZiAob3B0aW9ucy5iYXNlRXZlbnQpIGluaGVyaXRFdmVudChldmVudCwgb3B0aW9ucy5iYXNlRXZlbnQpOwogICAgICB0cnkgeyBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOyB9CiAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdUaGlzIGVycm9yIG1heSBoYXZlIGJlZW4gY2F1c2VkIGJ5IGEgY2hhbmdlIGluIHRoZSBmaXJlRXZlbnQgbWV0aG9kLCBtb3JlIGluZm8gaGVyZTogJywgZSk7CiAgICAgIH0KICAgIH0sCgogICAgYWRkT2JzZXJ2ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgaWYgKCFlbGVtZW50Ll9yZWNvcmRzKSB7CiAgICAgICAgZWxlbWVudC5fcmVjb3JkcyA9IHsgaW5zZXJ0ZWQ6IFtdLCByZW1vdmVkOiBbXSB9OwogICAgICAgIGlmIChtdXRhdGlvbil7CiAgICAgICAgICBlbGVtZW50Ll9vYnNlcnZlciA9IG5ldyBtdXRhdGlvbihmdW5jdGlvbihtdXRhdGlvbnMpIHsKICAgICAgICAgICAgcGFyc2VNdXRhdGlvbnMoZWxlbWVudCwgbXV0YXRpb25zKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZWxlbWVudC5fb2JzZXJ2ZXIub2JzZXJ2ZShlbGVtZW50LCB7CiAgICAgICAgICAgIHN1YnRyZWU6IHRydWUsCiAgICAgICAgICAgIGNoaWxkTGlzdDogdHJ1ZSwKICAgICAgICAgICAgYXR0cmlidXRlczogIXRydWUsCiAgICAgICAgICAgIGNoYXJhY3RlckRhdGE6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBbJ0luc2VydGVkJywgJ1JlbW92ZWQnXS5mb3JFYWNoKGZ1bmN0aW9uKHR5cGUpewogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlJyArIHR5cGUsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgICAgZXZlbnQuX211dGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZWxlbWVudC5fcmVjb3Jkc1t0eXBlLnRvTG93ZXJDYXNlKCldLmZvckVhY2goZnVuY3Rpb24oZm4pewogICAgICAgICAgICAgIGZuKGV2ZW50LnRhcmdldCwgZXZlbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoZWxlbWVudC5fcmVjb3Jkc1t0eXBlXS5pbmRleE9mKGZuKSA9PSAtMSkgZWxlbWVudC5fcmVjb3Jkc1t0eXBlXS5wdXNoKGZuKTsKICAgIH0sCgogICAgcmVtb3ZlT2JzZXJ2ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgdmFyIG9iaiA9IGVsZW1lbnQuX3JlY29yZHM7CiAgICAgIGlmIChvYmogJiYgZm4pewogICAgICAgIG9ialt0eXBlXS5zcGxpY2Uob2JqW3R5cGVdLmluZGV4T2YoZm4pLCAxKTsKICAgICAgfQogICAgICBlbHNlewogICAgICAgIG9ialt0eXBlXSA9IFtdOwogICAgICB9CiAgICB9CgogIH07CgovKioqIFVuaXZlcnNhbCBUb3VjaCAqKiovCgp2YXIgdG91Y2hDb3VudCA9IDAsIHRvdWNoVGFyZ2V0ID0gbnVsbDsKCmRvYy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBmdW5jdGlvbihlKXsKICB0b3VjaENvdW50Kys7CiAgdG91Y2hUYXJnZXQgPSBlLnRhcmdldDsKfSwgdHJ1ZSk7Cgpkb2MuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGZ1bmN0aW9uKCl7CiAgdG91Y2hDb3VudC0tOwogIHRvdWNoVGFyZ2V0ID0gbnVsbDsKfSwgZmFsc2UpOwoKdmFyIFVJRXZlbnRQcm90byA9IHsKICB0b3VjaGVzOiB7CiAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLl9fdG91Y2hlc19fIHx8CiAgICAgICAgKHRoaXMuaWRlbnRpZmllciA9IDApIHx8CiAgICAgICAgKHRoaXMuX190b3VjaGVzX18gPSB0b3VjaENvdW50ID8gW3RoaXNdIDogW10pOwogICAgfQogIH0sCiAgdGFyZ2V0VG91Y2hlczogewogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5fX3RhcmdldFRvdWNoZXNfXyB8fCAodGhpcy5fX3RhcmdldFRvdWNoZXNfXyA9CiAgICAgICAgKHRvdWNoQ291bnQgJiYgdGhpcy5jdXJyZW50VGFyZ2V0ICYmCiAgICAgICAgKHRoaXMuY3VycmVudFRhcmdldCA9PSB0b3VjaFRhcmdldCB8fAogICAgICAgICh0aGlzLmN1cnJlbnRUYXJnZXQuY29udGFpbnMgJiYgdGhpcy5jdXJyZW50VGFyZ2V0LmNvbnRhaW5zKHRvdWNoVGFyZ2V0KSkpKSA/IFt0aGlzXSA6IFtdKTsKICAgIH0KICB9LAogIGNoYW5nZWRUb3VjaGVzOiB7CiAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLnRvdWNoZXM7CiAgICB9CiAgfQp9OwoKZm9yICh6IGluIFVJRXZlbnRQcm90byl7CiAgVUlFdmVudC5wcm90b3R5cGVbel0gPSBVSUV2ZW50UHJvdG9bel07CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFVJRXZlbnQucHJvdG90eXBlLCB6LCBVSUV2ZW50UHJvdG9bel0pOwp9Cgp2YXIgdG91Y2hSZXNldCA9IHsKICAgIHZhbHVlOiBudWxsLAogICAgd3JpdGFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUKICB9LAogIFRvdWNoRXZlbnRQcm90byA9IHsKICAgIHRvdWNoZXM6IHRvdWNoUmVzZXQsCiAgICB0YXJnZXRUb3VjaGVzOiB0b3VjaFJlc2V0LAogICAgY2hhbmdlZFRvdWNoZXM6IHRvdWNoUmVzZXQKICB9OwoKaWYgKHdpbi5Ub3VjaEV2ZW50KSB7CiAgZm9yICh6IGluIFRvdWNoRXZlbnRQcm90bykgewogICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHdpbi5Ub3VjaEV2ZW50LnByb3RvdHlwZSwgeik7CiAgICBpZiAoZGVzYykgd2luLlRvdWNoRXZlbnQucHJvdG90eXBlW3pdID0gVG91Y2hFdmVudFByb3RvW3pdOwogICAgZWxzZSBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luLlRvdWNoRXZlbnQucHJvdG90eXBlLCB6LCBUb3VjaEV2ZW50UHJvdG9bel0pOwogIH0KfQoKLyoqKiBDdXN0b20gRXZlbnQgRGVmaW5pdGlvbnMgKioqLwoKICBmdW5jdGlvbiBhZGRUYXAoZWwsIHRhcCwgZSl7CiAgICBpZiAoIWVsLl9fdGFwX18pIHsKICAgICAgZWwuX190YXBfXyA9IHsgY2xpY2s6IGUudHlwZSA9PSAnbW91c2Vkb3duJyB9OwogICAgICBpZiAoZWwuX190YXBfXy5jbGljaykgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0YXAub2JzZXJ2ZXIpOwogICAgICBlbHNlIHsKICAgICAgICBlbC5fX3RhcF9fLnNjcm9sbCA9IHRhcC5vYnNlcnZlci5iaW5kKGVsKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgZWwuX190YXBfXy5zY3JvbGwsIHRydWUpOwogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRhcC5vYnNlcnZlcik7CiAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCB0YXAub2JzZXJ2ZXIpOwogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgdGFwLm9ic2VydmVyKTsKICAgICAgfQogICAgfQogICAgaWYgKCFlbC5fX3RhcF9fLmNsaWNrKSB7CiAgICAgIGVsLl9fdGFwX18ueCA9IGUudG91Y2hlc1swXS5wYWdlWDsKICAgICAgZWwuX190YXBfXy55ID0gZS50b3VjaGVzWzBdLnBhZ2VZOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlVGFwKGVsLCB0YXApewogICAgaWYgKGVsLl9fdGFwX18pIHsKICAgICAgaWYgKGVsLl9fdGFwX18uY2xpY2spIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGFwLm9ic2VydmVyKTsKICAgICAgZWxzZSB7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIGVsLl9fdGFwX18uc2Nyb2xsLCB0cnVlKTsKICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0YXAub2JzZXJ2ZXIpOwogICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgdGFwLm9ic2VydmVyKTsKICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRhcC5vYnNlcnZlcik7CiAgICAgIH0KICAgICAgZGVsZXRlIGVsLl9fdGFwX187CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjaGVja1RhcFBvc2l0aW9uKGVsLCB0YXAsIGUpewogICAgdmFyIHRvdWNoID0gZS5jaGFuZ2VkVG91Y2hlc1swXTsKICAgIGlmICgKICAgICAgdG91Y2gucGFnZVggPCBlbC5fX3RhcF9fLnggKyB0YXAuZ2VzdHVyZS50b2xlcmFuY2UgJiYKICAgICAgdG91Y2gucGFnZVggPiBlbC5fX3RhcF9fLnggLSB0YXAuZ2VzdHVyZS50b2xlcmFuY2UgJiYKICAgICAgdG91Y2gucGFnZVkgPCBlbC5fX3RhcF9fLnkgKyB0YXAuZ2VzdHVyZS50b2xlcmFuY2UgJiYKICAgICAgdG91Y2gucGFnZVkgPiBlbC5fX3RhcF9fLnkgLSB0YXAuZ2VzdHVyZS50b2xlcmFuY2UKICAgICkgcmV0dXJuIHRydWU7CiAgfQoKICB4dGFnLmN1c3RvbUV2ZW50cy50YXAgPSB7CiAgICBvYnNlcnZlOiB7CiAgICAgIG1vdXNlZG93bjogZG9jdW1lbnQsCiAgICAgIHRvdWNoc3RhcnQ6IGRvY3VtZW50CiAgICB9LAogICAgZ2VzdHVyZTogewogICAgICB0b2xlcmFuY2U6IDgKICAgIH0sCiAgICBjb25kaXRpb246IGZ1bmN0aW9uKGUsIHRhcCl7CiAgICAgIHZhciBlbCA9IGUudGFyZ2V0OwogICAgICBzd2l0Y2ggKGUudHlwZSkgewogICAgICAgIGNhc2UgJ3RvdWNoc3RhcnQnOgogICAgICAgICAgaWYgKGVsLl9fdGFwX18gJiYgZWwuX190YXBfXy5jbGljaykgcmVtb3ZlVGFwKGVsLCB0YXApOwogICAgICAgICAgYWRkVGFwKGVsLCB0YXAsIGUpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIGNhc2UgJ21vdXNlZG93bic6CiAgICAgICAgICBpZiAoIWVsLl9fdGFwX18pIGFkZFRhcChlbCwgdGFwLCBlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICBjYXNlICdzY3JvbGwnOgogICAgICAgIGNhc2UgJ3RvdWNoY2FuY2VsJzoKICAgICAgICAgIHJlbW92ZVRhcCh0aGlzLCB0YXApOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIGNhc2UgJ3RvdWNobW92ZSc6CiAgICAgICAgY2FzZSAndG91Y2hlbmQnOgogICAgICAgICAgaWYgKHRoaXMuX190YXBfXyAmJiAhY2hlY2tUYXBQb3NpdGlvbih0aGlzLCB0YXAsIGUpKSB7CiAgICAgICAgICAgIHJlbW92ZVRhcCh0aGlzLCB0YXApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZS50eXBlID09ICd0b3VjaGVuZCcgfHwgbnVsbDsKICAgICAgICBjYXNlICdjbGljayc6CiAgICAgICAgICByZW1vdmVUYXAodGhpcywgdGFwKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgfTsKCiAgd2luLnh0YWcgPSB4dGFnOwogIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgZGVmaW5lKHh0YWcpOwoKICBkb2MuYWRkRXZlbnRMaXN0ZW5lcignV2ViQ29tcG9uZW50c1JlYWR5JywgZnVuY3Rpb24oKXsKICAgIHh0YWcuZmlyZUV2ZW50KGRvYy5ib2R5LCAnRE9NQ29tcG9uZW50c0xvYWRlZCcpOwogIH0pOwoKfSkoKTsK",
                "body": "Ly8gV2UgZG9uJ3QgdXNlIHRoZSBwbGF0Zm9ybSBib290c3RyYXBwZXIsIHNvIGZha2UgdGhpcyBzdHVmZi4KCndpbmRvdy5QbGF0Zm9ybSA9IHt9Owp2YXIgbG9nRmxhZ3MgPSB7fTsKCgoKLy8gRE9NVG9rZW5MaXN0IHBvbHlmaWxsIGZpciBJRTkKKGZ1bmN0aW9uICgpIHsKCmlmICh0eXBlb2Ygd2luZG93LkVsZW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8ICJjbGFzc0xpc3QiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgcmV0dXJuOwoKdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKICAgIGluZGV4T2YgPSBwcm90b3R5cGUuaW5kZXhPZiwKICAgIHNsaWNlID0gcHJvdG90eXBlLnNsaWNlLAogICAgcHVzaCA9IHByb3RvdHlwZS5wdXNoLAogICAgc3BsaWNlID0gcHJvdG90eXBlLnNwbGljZSwKICAgIGpvaW4gPSBwcm90b3R5cGUuam9pbjsKCmZ1bmN0aW9uIERPTVRva2VuTGlzdChlbCkgewogIHRoaXMuX2VsZW1lbnQgPSBlbDsKICBpZiAoZWwuY2xhc3NOYW1lICE9IHRoaXMuX2NsYXNzQ2FjaGUpIHsKICAgIHRoaXMuX2NsYXNzQ2FjaGUgPSBlbC5jbGFzc05hbWU7CgogICAgaWYgKCF0aGlzLl9jbGFzc0NhY2hlKSByZXR1cm47CgogICAgICAvLyBUaGUgY2xhc3NOYW1lIG5lZWRzIHRvIGJlIHRyaW1tZWQgYW5kIHNwbGl0IG9uIHdoaXRlc3BhY2UKICAgICAgLy8gdG8gcmV0cmlldmUgYSBsaXN0IG9mIGNsYXNzZXMuCiAgICAgIHZhciBjbGFzc2VzID0gdGhpcy5fY2xhc3NDYWNoZS5yZXBsYWNlKC9eXHMrfFxzKyQvZywnJykuc3BsaXQoL1xzKy8pLAogICAgICAgIGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKykgewogICAgICBwdXNoLmNhbGwodGhpcywgY2xhc3Nlc1tpXSk7CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gc2V0VG9DbGFzc05hbWUoZWwsIGNsYXNzZXMpIHsKICBlbC5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTsKfQoKRE9NVG9rZW5MaXN0LnByb3RvdHlwZSA9IHsKICBhZGQ6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICBpZih0aGlzLmNvbnRhaW5zKHRva2VuKSkgcmV0dXJuOwogICAgcHVzaC5jYWxsKHRoaXMsIHRva2VuKTsKICAgIHNldFRvQ2xhc3NOYW1lKHRoaXMuX2VsZW1lbnQsIHNsaWNlLmNhbGwodGhpcywgMCkpOwogIH0sCiAgY29udGFpbnM6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICByZXR1cm4gaW5kZXhPZi5jYWxsKHRoaXMsIHRva2VuKSAhPT0gLTE7CiAgfSwKICBpdGVtOiBmdW5jdGlvbihpbmRleCkgewogICAgcmV0dXJuIHRoaXNbaW5kZXhdIHx8IG51bGw7CiAgfSwKICByZW1vdmU6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICB2YXIgaSA9IGluZGV4T2YuY2FsbCh0aGlzLCB0b2tlbik7CiAgICAgaWYgKGkgPT09IC0xKSB7CiAgICAgICByZXR1cm47CiAgICAgfQogICAgc3BsaWNlLmNhbGwodGhpcywgaSwgMSk7CiAgICBzZXRUb0NsYXNzTmFtZSh0aGlzLl9lbGVtZW50LCBzbGljZS5jYWxsKHRoaXMsIDApKTsKICB9LAogIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBqb2luLmNhbGwodGhpcywgJyAnKTsKICB9LAogIHRvZ2dsZTogZnVuY3Rpb24odG9rZW4pIHsKICAgIGlmIChpbmRleE9mLmNhbGwodGhpcywgdG9rZW4pID09PSAtMSkgewogICAgICB0aGlzLmFkZCh0b2tlbik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnJlbW92ZSh0b2tlbik7CiAgICB9CiAgfQp9OwoKd2luZG93LkRPTVRva2VuTGlzdCA9IERPTVRva2VuTGlzdDsKCmZ1bmN0aW9uIGRlZmluZUVsZW1lbnRHZXR0ZXIgKG9iaiwgcHJvcCwgZ2V0dGVyKSB7CiAgaWYgKE9iamVjdC5kZWZpbmVQcm9wZXJ0eSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgcHJvcCx7CiAgICAgIGdldCA6IGdldHRlcgogICAgfSkKICB9IGVsc2UgewogICAgb2JqLl9fZGVmaW5lR2V0dGVyX18ocHJvcCwgZ2V0dGVyKTsKICB9Cn0KCmRlZmluZUVsZW1lbnRHZXR0ZXIoRWxlbWVudC5wcm90b3R5cGUsICdjbGFzc0xpc3QnLCBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIG5ldyBET01Ub2tlbkxpc3QodGhpcyk7Cn0pOwoKfSkoKTsKCgovKgogKiBDb3B5cmlnaHQgMjAxMiBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3ZlcmVuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8vIFNpZGVUYWJsZSBpcyBhIHdlYWsgbWFwIHdoZXJlIHBvc3NpYmxlLiBJZiBXZWFrTWFwIGlzIG5vdCBhdmFpbGFibGUgdGhlCi8vIGFzc29jaWF0aW9uIGlzIHN0b3JlZCBhcyBhbiBleHBhbmRvIHByb3BlcnR5Lgp2YXIgU2lkZVRhYmxlOwovLyBUT0RPKGFydik6IFdlYWtNYXAgZG9lcyBub3QgYWxsb3cgZm9yIE5vZGUgZXRjIHRvIGJlIGtleXMgaW4gRmlyZWZveAppZiAodHlwZW9mIFdlYWtNYXAgIT09ICd1bmRlZmluZWQnICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignRmlyZWZveC8nKSA8IDApIHsKICBTaWRlVGFibGUgPSBXZWFrTWFwOwp9IGVsc2UgewogIChmdW5jdGlvbigpIHsKICAgIHZhciBkZWZpbmVQcm9wZXJ0eSA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICAgIHZhciBjb3VudGVyID0gRGF0ZS5ub3coKSAlIDFlOTsKCiAgICBTaWRlVGFibGUgPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5uYW1lID0gJ19fc3QnICsgKE1hdGgucmFuZG9tKCkgKiAxZTkgPj4+IDApICsgKGNvdW50ZXIrKyArICdfXycpOwogICAgfTsKCiAgICBTaWRlVGFibGUucHJvdG90eXBlID0gewogICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICB2YXIgZW50cnkgPSBrZXlbdGhpcy5uYW1lXTsKICAgICAgICBpZiAoZW50cnkgJiYgZW50cnlbMF0gPT09IGtleSkKICAgICAgICAgIGVudHJ5WzFdID0gdmFsdWU7CiAgICAgICAgZWxzZQogICAgICAgICAgZGVmaW5lUHJvcGVydHkoa2V5LCB0aGlzLm5hbWUsIHt2YWx1ZTogW2tleSwgdmFsdWVdLCB3cml0YWJsZTogdHJ1ZX0pOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHZhciBlbnRyeTsKICAgICAgICByZXR1cm4gKGVudHJ5ID0ga2V5W3RoaXMubmFtZV0pICYmIGVudHJ5WzBdID09PSBrZXkgPwogICAgICAgICAgICBlbnRyeVsxXSA6IHVuZGVmaW5lZDsKICAgICAgfSwKICAgICAgZGVsZXRlOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICB0aGlzLnNldChrZXksIHVuZGVmaW5lZCk7CiAgICAgIH0KICAgIH0KICB9KSgpOwp9CgovKgogKiBDb3B5cmlnaHQgMjAxMiBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3ZlcmVuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihnbG9iYWwpIHsKCiAgdmFyIHJlZ2lzdHJhdGlvbnNUYWJsZSA9IG5ldyBTaWRlVGFibGUoKTsKCiAgLy8gV2UgdXNlIHNldEltbWVkaWF0ZSBvciBwb3N0TWVzc2FnZSBmb3Igb3VyIGZ1dHVyZSBjYWxsYmFjay4KICB2YXIgc2V0SW1tZWRpYXRlID0gd2luZG93Lm1zU2V0SW1tZWRpYXRlOwoKICAvLyBVc2UgcG9zdCBtZXNzYWdlIHRvIGVtdWxhdGUgc2V0SW1tZWRpYXRlLgogIGlmICghc2V0SW1tZWRpYXRlKSB7CiAgICB2YXIgc2V0SW1tZWRpYXRlUXVldWUgPSBbXTsKICAgIHZhciBzZW50aW5lbCA9IFN0cmluZyhNYXRoLnJhbmRvbSgpKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZnVuY3Rpb24oZSkgewogICAgICBpZiAoZS5kYXRhID09PSBzZW50aW5lbCkgewogICAgICAgIHZhciBxdWV1ZSA9IHNldEltbWVkaWF0ZVF1ZXVlOwogICAgICAgIHNldEltbWVkaWF0ZVF1ZXVlID0gW107CiAgICAgICAgcXVldWUuZm9yRWFjaChmdW5jdGlvbihmdW5jKSB7CiAgICAgICAgICBmdW5jKCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgc2V0SW1tZWRpYXRlID0gZnVuY3Rpb24oZnVuYykgewogICAgICBzZXRJbW1lZGlhdGVRdWV1ZS5wdXNoKGZ1bmMpOwogICAgICB3aW5kb3cucG9zdE1lc3NhZ2Uoc2VudGluZWwsICcqJyk7CiAgICB9OwogIH0KCiAgLy8gVGhpcyBpcyB1c2VkIHRvIGVuc3VyZSB0aGF0IHdlIG5ldmVyIHNjaGVkdWxlIDIgY2FsbGFzIHRvIHNldEltbWVkaWF0ZQogIHZhciBpc1NjaGVkdWxlZCA9IGZhbHNlOwoKICAvLyBLZWVwIHRyYWNrIG9mIG9ic2VydmVycyB0aGF0IG5lZWRzIHRvIGJlIG5vdGlmaWVkIG5leHQgdGltZS4KICB2YXIgc2NoZWR1bGVkT2JzZXJ2ZXJzID0gW107CgogIC8qKgogICAqIFNjaGVkdWxlcyB8ZGlzcGF0Y2hDYWxsYmFja3wgdG8gYmUgY2FsbGVkIGluIHRoZSBmdXR1cmUuCiAgICogQHBhcmFtIHtNdXRhdGlvbk9ic2VydmVyfSBvYnNlcnZlcgogICAqLwogIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbGJhY2sob2JzZXJ2ZXIpIHsKICAgIHNjaGVkdWxlZE9ic2VydmVycy5wdXNoKG9ic2VydmVyKTsKICAgIGlmICghaXNTY2hlZHVsZWQpIHsKICAgICAgaXNTY2hlZHVsZWQgPSB0cnVlOwogICAgICBzZXRJbW1lZGlhdGUoZGlzcGF0Y2hDYWxsYmFja3MpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gd3JhcElmTmVlZGVkKG5vZGUpIHsKICAgIHJldHVybiB3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwgJiYKICAgICAgICB3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwud3JhcElmTmVlZGVkKG5vZGUpIHx8CiAgICAgICAgbm9kZTsKICB9CgogIGZ1bmN0aW9uIGRpc3BhdGNoQ2FsbGJhY2tzKCkgewogICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI211dGF0aW9uLW9ic2VydmVycwoKICAgIGlzU2NoZWR1bGVkID0gZmFsc2U7IC8vIFVzZWQgdG8gYWxsb3cgYSBuZXcgc2V0SW1tZWRpYXRlIGNhbGwgYWJvdmUuCgogICAgdmFyIG9ic2VydmVycyA9IHNjaGVkdWxlZE9ic2VydmVyczsKICAgIHNjaGVkdWxlZE9ic2VydmVycyA9IFtdOwogICAgLy8gU29ydCBvYnNlcnZlcnMgYmFzZWQgb24gdGhlaXIgY3JlYXRpb24gVUlEIChpbmNyZW1lbnRhbCkuCiAgICBvYnNlcnZlcnMuc29ydChmdW5jdGlvbihvMSwgbzIpIHsKICAgICAgcmV0dXJuIG8xLnVpZF8gLSBvMi51aWRfOwogICAgfSk7CgogICAgdmFyIGFueU5vbkVtcHR5ID0gZmFsc2U7CiAgICBvYnNlcnZlcnMuZm9yRWFjaChmdW5jdGlvbihvYnNlcnZlcikgewoKICAgICAgLy8gMi4xLCAyLjIKICAgICAgdmFyIHF1ZXVlID0gb2JzZXJ2ZXIudGFrZVJlY29yZHMoKTsKICAgICAgLy8gMi4zLiBSZW1vdmUgYWxsIHRyYW5zaWVudCByZWdpc3RlcmVkIG9ic2VydmVycyB3aG9zZSBvYnNlcnZlciBpcyBtby4KICAgICAgcmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzRm9yKG9ic2VydmVyKTsKCiAgICAgIC8vIDIuNAogICAgICBpZiAocXVldWUubGVuZ3RoKSB7CiAgICAgICAgb2JzZXJ2ZXIuY2FsbGJhY2tfKHF1ZXVlLCBvYnNlcnZlcik7CiAgICAgICAgYW55Tm9uRW1wdHkgPSB0cnVlOwogICAgICB9CiAgICB9KTsKCiAgICAvLyAzLgogICAgaWYgKGFueU5vbkVtcHR5KQogICAgICBkaXNwYXRjaENhbGxiYWNrcygpOwogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzRm9yKG9ic2VydmVyKSB7CiAgICBvYnNlcnZlci5ub2Rlc18uZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKICAgICAgaWYgKCFyZWdpc3RyYXRpb25zKQogICAgICAgIHJldHVybjsKICAgICAgcmVnaXN0cmF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHJlZ2lzdHJhdGlvbikgewogICAgICAgIGlmIChyZWdpc3RyYXRpb24ub2JzZXJ2ZXIgPT09IG9ic2VydmVyKQogICAgICAgICAgcmVnaXN0cmF0aW9uLnJlbW92ZVRyYW5zaWVudE9ic2VydmVycygpOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGZvciB0aGUgIkZvciBlYWNoIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgb2JzZXJ2ZXIgKHdpdGgKICAgKiBvYnNlcnZlcidzIG9wdGlvbnMgYXMgb3B0aW9ucykgaW4gdGFyZ2V0J3MgbGlzdCBvZiByZWdpc3RlcmVkIG9ic2VydmVycywKICAgKiBydW4gdGhlc2Ugc3Vic3RlcHM6IiBhbmQgdGhlICJGb3IgZWFjaCBhbmNlc3RvciBhbmNlc3RvciBvZiB0YXJnZXQsIGFuZCBmb3IKICAgKiBlYWNoIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgb2JzZXJ2ZXIgKHdpdGggb3B0aW9ucyBvcHRpb25zKSBpbiBhbmNlc3RvcidzIGxpc3QKICAgKiBvZiByZWdpc3RlcmVkIG9ic2VydmVycywgcnVuIHRoZXNlIHN1YnN0ZXBzOiIgcGFydCBvZiB0aGUgYWxnb3JpdGhtcy4gVGhlCiAgICogfG9wdGlvbnMuc3VidHJlZXwgaXMgY2hlY2tlZCB0byBlbnN1cmUgdGhhdCB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkCiAgICogY29ycmVjdGx5LgogICAqCiAgICogQHBhcmFtIHtOb2RlfSB0YXJnZXQKICAgKiBAcGFyYW0ge2Z1bmN0aW9uKE11dGF0aW9uT2JzZXJ2ZXJJbml0KTpNdXRhdGlvblJlY29yZH0gY2FsbGJhY2sKICAgKi8KICBmdW5jdGlvbiBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBjYWxsYmFjaykgewogICAgZm9yICh2YXIgbm9kZSA9IHRhcmdldDsgbm9kZTsgbm9kZSA9IG5vZGUucGFyZW50Tm9kZSkgewogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CgogICAgICBpZiAocmVnaXN0cmF0aW9ucykgewogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGorKykgewogICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbiA9IHJlZ2lzdHJhdGlvbnNbal07CiAgICAgICAgICB2YXIgb3B0aW9ucyA9IHJlZ2lzdHJhdGlvbi5vcHRpb25zOwoKICAgICAgICAgIC8vIE9ubHkgdGFyZ2V0IGlnbm9yZXMgc3VidHJlZS4KICAgICAgICAgIGlmIChub2RlICE9PSB0YXJnZXQgJiYgIW9wdGlvbnMuc3VidHJlZSkKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgdmFyIHJlY29yZCA9IGNhbGxiYWNrKG9wdGlvbnMpOwogICAgICAgICAgaWYgKHJlY29yZCkKICAgICAgICAgICAgcmVnaXN0cmF0aW9uLmVucXVldWUocmVjb3JkKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIHZhciB1aWRDb3VudGVyID0gMDsKCiAgLyoqCiAgICogVGhlIGNsYXNzIHRoYXQgbWFwcyB0byB0aGUgRE9NIE11dGF0aW9uT2JzZXJ2ZXIgaW50ZXJmYWNlLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrLgogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIEpzTXV0YXRpb25PYnNlcnZlcihjYWxsYmFjaykgewogICAgdGhpcy5jYWxsYmFja18gPSBjYWxsYmFjazsKICAgIHRoaXMubm9kZXNfID0gW107CiAgICB0aGlzLnJlY29yZHNfID0gW107CiAgICB0aGlzLnVpZF8gPSArK3VpZENvdW50ZXI7CiAgfQoKICBKc011dGF0aW9uT2JzZXJ2ZXIucHJvdG90eXBlID0gewogICAgb2JzZXJ2ZTogZnVuY3Rpb24odGFyZ2V0LCBvcHRpb25zKSB7CiAgICAgIHRhcmdldCA9IHdyYXBJZk5lZWRlZCh0YXJnZXQpOwoKICAgICAgLy8gMS4xCiAgICAgIGlmICghb3B0aW9ucy5jaGlsZExpc3QgJiYgIW9wdGlvbnMuYXR0cmlidXRlcyAmJiAhb3B0aW9ucy5jaGFyYWN0ZXJEYXRhIHx8CgogICAgICAgICAgLy8gMS4yCiAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZU9sZFZhbHVlICYmICFvcHRpb25zLmF0dHJpYnV0ZXMgfHwKCiAgICAgICAgICAvLyAxLjMKICAgICAgICAgIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyICYmIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyLmxlbmd0aCAmJgogICAgICAgICAgICAgICFvcHRpb25zLmF0dHJpYnV0ZXMgfHwKCiAgICAgICAgICAvLyAxLjQKICAgICAgICAgIG9wdGlvbnMuY2hhcmFjdGVyRGF0YU9sZFZhbHVlICYmICFvcHRpb25zLmNoYXJhY3RlckRhdGEpIHsKCiAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCk7CiAgICAgIH0KCiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldCh0YXJnZXQpOwogICAgICBpZiAoIXJlZ2lzdHJhdGlvbnMpCiAgICAgICAgcmVnaXN0cmF0aW9uc1RhYmxlLnNldCh0YXJnZXQsIHJlZ2lzdHJhdGlvbnMgPSBbXSk7CgogICAgICAvLyAyCiAgICAgIC8vIElmIHRhcmdldCdzIGxpc3Qgb2YgcmVnaXN0ZXJlZCBvYnNlcnZlcnMgYWxyZWFkeSBpbmNsdWRlcyBhIHJlZ2lzdGVyZWQKICAgICAgLy8gb2JzZXJ2ZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBjb250ZXh0IG9iamVjdCwgcmVwbGFjZSB0aGF0IHJlZ2lzdGVyZWQKICAgICAgLy8gb2JzZXJ2ZXIncyBvcHRpb25zIHdpdGggb3B0aW9ucy4KICAgICAgdmFyIHJlZ2lzdHJhdGlvbjsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbnNbaV0ub2JzZXJ2ZXIgPT09IHRoaXMpIHsKICAgICAgICAgIHJlZ2lzdHJhdGlvbiA9IHJlZ2lzdHJhdGlvbnNbaV07CiAgICAgICAgICByZWdpc3RyYXRpb24ucmVtb3ZlTGlzdGVuZXJzKCk7CiAgICAgICAgICByZWdpc3RyYXRpb24ub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIDMuCiAgICAgIC8vIE90aGVyd2lzZSwgYWRkIGEgbmV3IHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgdG8gdGFyZ2V0J3MgbGlzdCBvZiByZWdpc3RlcmVkCiAgICAgIC8vIG9ic2VydmVycyB3aXRoIHRoZSBjb250ZXh0IG9iamVjdCBhcyB0aGUgb2JzZXJ2ZXIgYW5kIG9wdGlvbnMgYXMgdGhlCiAgICAgIC8vIG9wdGlvbnMsIGFuZCBhZGQgdGFyZ2V0IHRvIGNvbnRleHQgb2JqZWN0J3MgbGlzdCBvZiBub2RlcyBvbiB3aGljaCBpdAogICAgICAvLyBpcyByZWdpc3RlcmVkLgogICAgICBpZiAoIXJlZ2lzdHJhdGlvbikgewogICAgICAgIHJlZ2lzdHJhdGlvbiA9IG5ldyBSZWdpc3RyYXRpb24odGhpcywgdGFyZ2V0LCBvcHRpb25zKTsKICAgICAgICByZWdpc3RyYXRpb25zLnB1c2gocmVnaXN0cmF0aW9uKTsKICAgICAgICB0aGlzLm5vZGVzXy5wdXNoKHRhcmdldCk7CiAgICAgIH0KCiAgICAgIHJlZ2lzdHJhdGlvbi5hZGRMaXN0ZW5lcnMoKTsKICAgIH0sCgogICAgZGlzY29ubmVjdDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubm9kZXNfLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciByZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25zW2ldOwogICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbi5vYnNlcnZlciA9PT0gdGhpcykgewogICAgICAgICAgICByZWdpc3RyYXRpb24ucmVtb3ZlTGlzdGVuZXJzKCk7CiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAvLyBFYWNoIG5vZGUgY2FuIG9ubHkgaGF2ZSBvbmUgcmVnaXN0ZXJlZCBvYnNlcnZlciBhc3NvY2lhdGVkIHdpdGgKICAgICAgICAgICAgLy8gdGhpcyBvYnNlcnZlci4KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgICAgdGhpcy5yZWNvcmRzXyA9IFtdOwogICAgfSwKCiAgICB0YWtlUmVjb3JkczogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjb3B5T2ZSZWNvcmRzID0gdGhpcy5yZWNvcmRzXzsKICAgICAgdGhpcy5yZWNvcmRzXyA9IFtdOwogICAgICByZXR1cm4gY29weU9mUmVjb3JkczsKICAgIH0KICB9OwoKICAvKioKICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZQogICAqIEBwYXJhbSB7Tm9kZX0gdGFyZ2V0CiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gTXV0YXRpb25SZWNvcmQodHlwZSwgdGFyZ2V0KSB7CiAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CiAgICB0aGlzLmFkZGVkTm9kZXMgPSBbXTsKICAgIHRoaXMucmVtb3ZlZE5vZGVzID0gW107CiAgICB0aGlzLnByZXZpb3VzU2libGluZyA9IG51bGw7CiAgICB0aGlzLm5leHRTaWJsaW5nID0gbnVsbDsKICAgIHRoaXMuYXR0cmlidXRlTmFtZSA9IG51bGw7CiAgICB0aGlzLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IG51bGw7CiAgICB0aGlzLm9sZFZhbHVlID0gbnVsbDsKICB9CgogIGZ1bmN0aW9uIGNvcHlNdXRhdGlvblJlY29yZChvcmlnaW5hbCkgewogICAgdmFyIHJlY29yZCA9IG5ldyBNdXRhdGlvblJlY29yZChvcmlnaW5hbC50eXBlLCBvcmlnaW5hbC50YXJnZXQpOwogICAgcmVjb3JkLmFkZGVkTm9kZXMgPSBvcmlnaW5hbC5hZGRlZE5vZGVzLnNsaWNlKCk7CiAgICByZWNvcmQucmVtb3ZlZE5vZGVzID0gb3JpZ2luYWwucmVtb3ZlZE5vZGVzLnNsaWNlKCk7CiAgICByZWNvcmQucHJldmlvdXNTaWJsaW5nID0gb3JpZ2luYWwucHJldmlvdXNTaWJsaW5nOwogICAgcmVjb3JkLm5leHRTaWJsaW5nID0gb3JpZ2luYWwubmV4dFNpYmxpbmc7CiAgICByZWNvcmQuYXR0cmlidXRlTmFtZSA9IG9yaWdpbmFsLmF0dHJpYnV0ZU5hbWU7CiAgICByZWNvcmQuYXR0cmlidXRlTmFtZXNwYWNlID0gb3JpZ2luYWwuYXR0cmlidXRlTmFtZXNwYWNlOwogICAgcmVjb3JkLm9sZFZhbHVlID0gb3JpZ2luYWwub2xkVmFsdWU7CiAgICByZXR1cm4gcmVjb3JkOwogIH07CgogIC8vIFdlIGtlZXAgdHJhY2sgb2YgdGhlIHR3byAocG9zc2libHkgb25lKSByZWNvcmRzIHVzZWQgaW4gYSBzaW5nbGUgbXV0YXRpb24uCiAgdmFyIGN1cnJlbnRSZWNvcmQsIHJlY29yZFdpdGhPbGRWYWx1ZTsKCiAgLyoqCiAgICogQ3JlYXRlcyBhIHJlY29yZCB3aXRob3V0IHxvbGRWYWx1ZXwgYW5kIGNhY2hlcyBpdCBhcyB8Y3VycmVudFJlY29yZHwgZm9yCiAgICogbGF0ZXIgdXNlLgogICAqIEBwYXJhbSB7c3RyaW5nfSBvbGRWYWx1ZQogICAqIEByZXR1cm4ge011dGF0aW9uUmVjb3JkfQogICAqLwogIGZ1bmN0aW9uIGdldFJlY29yZCh0eXBlLCB0YXJnZXQpIHsKICAgIHJldHVybiBjdXJyZW50UmVjb3JkID0gbmV3IE11dGF0aW9uUmVjb3JkKHR5cGUsIHRhcmdldCk7CiAgfQoKICAvKioKICAgKiBHZXRzIG9yIGNyZWF0ZXMgYSByZWNvcmQgd2l0aCB8b2xkVmFsdWV8IGJhc2VkIGluIHRoZSB8Y3VycmVudFJlY29yZHwKICAgKiBAcGFyYW0ge3N0cmluZ30gb2xkVmFsdWUKICAgKiBAcmV0dXJuIHtNdXRhdGlvblJlY29yZH0KICAgKi8KICBmdW5jdGlvbiBnZXRSZWNvcmRXaXRoT2xkVmFsdWUob2xkVmFsdWUpIHsKICAgIGlmIChyZWNvcmRXaXRoT2xkVmFsdWUpCiAgICAgIHJldHVybiByZWNvcmRXaXRoT2xkVmFsdWU7CiAgICByZWNvcmRXaXRoT2xkVmFsdWUgPSBjb3B5TXV0YXRpb25SZWNvcmQoY3VycmVudFJlY29yZCk7CiAgICByZWNvcmRXaXRoT2xkVmFsdWUub2xkVmFsdWUgPSBvbGRWYWx1ZTsKICAgIHJldHVybiByZWNvcmRXaXRoT2xkVmFsdWU7CiAgfQoKICBmdW5jdGlvbiBjbGVhclJlY29yZHMoKSB7CiAgICBjdXJyZW50UmVjb3JkID0gcmVjb3JkV2l0aE9sZFZhbHVlID0gdW5kZWZpbmVkOwogIH0KCiAgLyoqCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0gcmVjb3JkCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgcmVjb3JkIHJlcHJlc2VudHMgYSByZWNvcmQgZnJvbSB0aGUgY3VycmVudAogICAqIG11dGF0aW9uIGV2ZW50LgogICAqLwogIGZ1bmN0aW9uIHJlY29yZFJlcHJlc2VudHNDdXJyZW50TXV0YXRpb24ocmVjb3JkKSB7CiAgICByZXR1cm4gcmVjb3JkID09PSByZWNvcmRXaXRoT2xkVmFsdWUgfHwgcmVjb3JkID09PSBjdXJyZW50UmVjb3JkOwogIH0KCiAgLyoqCiAgICogU2VsZWN0cyB3aGljaCByZWNvcmQsIGlmIGFueSwgdG8gcmVwbGFjZSB0aGUgbGFzdCByZWNvcmQgaW4gdGhlIHF1ZXVlLgogICAqIFRoaXMgcmV0dXJucyB8bnVsbHwgaWYgbm8gcmVjb3JkIHNob3VsZCBiZSByZXBsYWNlZC4KICAgKgogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9IGxhc3RSZWNvcmQKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfSBuZXdSZWNvcmQKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfQogICAqLwogIGZ1bmN0aW9uIHNlbGVjdFJlY29yZChsYXN0UmVjb3JkLCBuZXdSZWNvcmQpIHsKICAgIGlmIChsYXN0UmVjb3JkID09PSBuZXdSZWNvcmQpCiAgICAgIHJldHVybiBsYXN0UmVjb3JkOwoKICAgIC8vIENoZWNrIGlmIHRoZSB0aGUgcmVjb3JkIHdlIGFyZSBhZGRpbmcgcmVwcmVzZW50cyB0aGUgc2FtZSByZWNvcmQuIElmCiAgICAvLyBzbywgd2Uga2VlcCB0aGUgb25lIHdpdGggdGhlIG9sZFZhbHVlIGluIGl0LgogICAgaWYgKHJlY29yZFdpdGhPbGRWYWx1ZSAmJiByZWNvcmRSZXByZXNlbnRzQ3VycmVudE11dGF0aW9uKGxhc3RSZWNvcmQpKQogICAgICByZXR1cm4gcmVjb3JkV2l0aE9sZFZhbHVlOwoKICAgIHJldHVybiBudWxsOwogIH0KCiAgLyoqCiAgICogQ2xhc3MgdXNlZCB0byByZXByZXNlbnQgYSByZWdpc3RlcmVkIG9ic2VydmVyLgogICAqIEBwYXJhbSB7TXV0YXRpb25PYnNlcnZlcn0gb2JzZXJ2ZXIKICAgKiBAcGFyYW0ge05vZGV9IHRhcmdldAogICAqIEBwYXJhbSB7TXV0YXRpb25PYnNlcnZlckluaXR9IG9wdGlvbnMKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBSZWdpc3RyYXRpb24ob2JzZXJ2ZXIsIHRhcmdldCwgb3B0aW9ucykgewogICAgdGhpcy5vYnNlcnZlciA9IG9ic2VydmVyOwogICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgdGhpcy50cmFuc2llbnRPYnNlcnZlZE5vZGVzID0gW107CiAgfQoKICBSZWdpc3RyYXRpb24ucHJvdG90eXBlID0gewogICAgZW5xdWV1ZTogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHZhciByZWNvcmRzID0gdGhpcy5vYnNlcnZlci5yZWNvcmRzXzsKICAgICAgdmFyIGxlbmd0aCA9IHJlY29yZHMubGVuZ3RoOwoKICAgICAgLy8gVGhlcmUgYXJlIGNhc2VzIHdoZXJlIHdlIHJlcGxhY2UgdGhlIGxhc3QgcmVjb3JkIHdpdGggdGhlIG5ldyByZWNvcmQuCiAgICAgIC8vIEZvciBleGFtcGxlIGlmIHRoZSByZWNvcmQgcmVwcmVzZW50cyB0aGUgc2FtZSBtdXRhdGlvbiB3ZSBuZWVkIHRvIHVzZQogICAgICAvLyB0aGUgb25lIHdpdGggdGhlIG9sZFZhbHVlLiBJZiB3ZSBnZXQgc2FtZSByZWNvcmQgKHRoaXMgY2FuIGhhcHBlbiBhcyB3ZQogICAgICAvLyB3YWxrIHVwIHRoZSB0cmVlKSB3ZSBpZ25vcmUgdGhlIG5ldyByZWNvcmQuCiAgICAgIGlmIChyZWNvcmRzLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgbGFzdFJlY29yZCA9IHJlY29yZHNbbGVuZ3RoIC0gMV07CiAgICAgICAgdmFyIHJlY29yZFRvUmVwbGFjZUxhc3QgPSBzZWxlY3RSZWNvcmQobGFzdFJlY29yZCwgcmVjb3JkKTsKICAgICAgICBpZiAocmVjb3JkVG9SZXBsYWNlTGFzdCkgewogICAgICAgICAgcmVjb3Jkc1tsZW5ndGggLSAxXSA9IHJlY29yZFRvUmVwbGFjZUxhc3Q7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHNjaGVkdWxlQ2FsbGJhY2sodGhpcy5vYnNlcnZlcik7CiAgICAgIH0KCiAgICAgIHJlY29yZHNbbGVuZ3RoXSA9IHJlY29yZDsKICAgIH0sCgogICAgYWRkTGlzdGVuZXJzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5hZGRMaXN0ZW5lcnNfKHRoaXMudGFyZ2V0KTsKICAgIH0sCgogICAgYWRkTGlzdGVuZXJzXzogZnVuY3Rpb24obm9kZSkgewogICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKICAgICAgaWYgKG9wdGlvbnMuYXR0cmlidXRlcykKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUF0dHJNb2RpZmllZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hhcmFjdGVyRGF0YSkKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNoYXJhY3RlckRhdGFNb2RpZmllZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0KQogICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignRE9NTm9kZUluc2VydGVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGlsZExpc3QgfHwgb3B0aW9ucy5zdWJ0cmVlKQogICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignRE9NTm9kZVJlbW92ZWQnLCB0aGlzLCB0cnVlKTsKICAgIH0sCgogICAgcmVtb3ZlTGlzdGVuZXJzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcnNfKHRoaXMudGFyZ2V0KTsKICAgIH0sCgogICAgcmVtb3ZlTGlzdGVuZXJzXzogZnVuY3Rpb24obm9kZSkgewogICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKICAgICAgaWYgKG9wdGlvbnMuYXR0cmlidXRlcykKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTUF0dHJNb2RpZmllZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hhcmFjdGVyRGF0YSkKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTUNoYXJhY3RlckRhdGFNb2RpZmllZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0KQogICAgICAgIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NTm9kZUluc2VydGVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGlsZExpc3QgfHwgb3B0aW9ucy5zdWJ0cmVlKQogICAgICAgIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NTm9kZVJlbW92ZWQnLCB0aGlzLCB0cnVlKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBBZGRzIGEgdHJhbnNpZW50IG9ic2VydmVyIG9uIG5vZGUuIFRoZSB0cmFuc2llbnQgb2JzZXJ2ZXIgZ2V0cyByZW1vdmVkCiAgICAgKiBuZXh0IHRpbWUgd2UgZGVsaXZlciB0aGUgY2hhbmdlIHJlY29yZHMuCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqLwogICAgYWRkVHJhbnNpZW50T2JzZXJ2ZXI6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgLy8gRG9uJ3QgYWRkIHRyYW5zaWVudCBvYnNlcnZlcnMgb24gdGhlIHRhcmdldCBpdHNlbGYuIFdlIGFscmVhZHkgaGF2ZSBhbGwKICAgICAgLy8gdGhlIHJlcXVpcmVkIGxpc3RlbmVycyBzZXQgdXAgb24gdGhlIHRhcmdldC4KICAgICAgaWYgKG5vZGUgPT09IHRoaXMudGFyZ2V0KQogICAgICAgIHJldHVybjsKCiAgICAgIHRoaXMuYWRkTGlzdGVuZXJzXyhub2RlKTsKICAgICAgdGhpcy50cmFuc2llbnRPYnNlcnZlZE5vZGVzLnB1c2gobm9kZSk7CiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKICAgICAgaWYgKCFyZWdpc3RyYXRpb25zKQogICAgICAgIHJlZ2lzdHJhdGlvbnNUYWJsZS5zZXQobm9kZSwgcmVnaXN0cmF0aW9ucyA9IFtdKTsKCiAgICAgIC8vIFdlIGtub3cgdGhhdCByZWdpc3RyYXRpb25zIGRvZXMgbm90IGNvbnRhaW4gdGhpcyBiZWNhdXNlIHdlIGFscmVhZHkKICAgICAgLy8gY2hlY2tlZCBpZiBub2RlID09PSB0aGlzLnRhcmdldC4KICAgICAgcmVnaXN0cmF0aW9ucy5wdXNoKHRoaXMpOwogICAgfSwKCiAgICByZW1vdmVUcmFuc2llbnRPYnNlcnZlcnM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdHJhbnNpZW50T2JzZXJ2ZWROb2RlcyA9IHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2RlczsKICAgICAgdGhpcy50cmFuc2llbnRPYnNlcnZlZE5vZGVzID0gW107CgogICAgICB0cmFuc2llbnRPYnNlcnZlZE5vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICAgIC8vIFRyYW5zaWVudCBvYnNlcnZlcnMgYXJlIG5ldmVyIGFkZGVkIHRvIHRoZSB0YXJnZXQuCiAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcnNfKG5vZGUpOwoKICAgICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uc1tpXSA9PT0gdGhpcykgewogICAgICAgICAgICByZWdpc3RyYXRpb25zLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgLy8gRWFjaCBub2RlIGNhbiBvbmx5IGhhdmUgb25lIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgYXNzb2NpYXRlZCB3aXRoCiAgICAgICAgICAgIC8vIHRoaXMgb2JzZXJ2ZXIuCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgdGhpcyk7CiAgICB9LAoKICAgIGhhbmRsZUV2ZW50OiBmdW5jdGlvbihlKSB7CiAgICAgIC8vIFN0b3AgcHJvcGFnYXRpb24gc2luY2Ugd2UgYXJlIG1hbmFnaW5nIHRoZSBwcm9wYWdhdGlvbiBtYW51YWxseS4KICAgICAgLy8gVGhpcyBtZWFucyB0aGF0IG90aGVyIG11dGF0aW9uIGV2ZW50cyBvbiB0aGUgcGFnZSB3aWxsIG5vdCB3b3JrCiAgICAgIC8vIGNvcnJlY3RseSBidXQgdGhhdCBpcyBieSBkZXNpZ24uCiAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgogICAgICBzd2l0Y2ggKGUudHlwZSkgewogICAgICAgIGNhc2UgJ0RPTUF0dHJNb2RpZmllZCc6CiAgICAgICAgICAvLyBodHRwOi8vZG9tLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC1tby1xdWV1ZS1hdHRyaWJ1dGVzCgogICAgICAgICAgdmFyIG5hbWUgPSBlLmF0dHJOYW1lOwogICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IGUucmVsYXRlZE5vZGUubmFtZXNwYWNlVVJJOwogICAgICAgICAgdmFyIHRhcmdldCA9IGUudGFyZ2V0OwoKICAgICAgICAgIC8vIDEuCiAgICAgICAgICB2YXIgcmVjb3JkID0gbmV3IGdldFJlY29yZCgnYXR0cmlidXRlcycsIHRhcmdldCk7CiAgICAgICAgICByZWNvcmQuYXR0cmlidXRlTmFtZSA9IG5hbWU7CiAgICAgICAgICByZWNvcmQuYXR0cmlidXRlTmFtZXNwYWNlID0gbmFtZXNwYWNlOwoKICAgICAgICAgIC8vIDIuCiAgICAgICAgICB2YXIgb2xkVmFsdWUgPQogICAgICAgICAgICAgIGUuYXR0ckNoYW5nZSA9PT0gTXV0YXRpb25FdmVudC5BRERJVElPTiA/IG51bGwgOiBlLnByZXZWYWx1ZTsKCiAgICAgICAgICBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIDMuMSwgNC4yCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5hdHRyaWJ1dGVzKQogICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIDMuMiwgNC4zCiAgICAgICAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZUZpbHRlciAmJiBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5sZW5ndGggJiYKICAgICAgICAgICAgICAgIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyLmluZGV4T2YobmFtZSkgPT09IC0xICYmCiAgICAgICAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5pbmRleE9mKG5hbWVzcGFjZSkgPT09IC0xKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIDMuMywgNC40CiAgICAgICAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZU9sZFZhbHVlKQogICAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmRXaXRoT2xkVmFsdWUob2xkVmFsdWUpOwoKICAgICAgICAgICAgLy8gMy40LCA0LjUKICAgICAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdET01DaGFyYWN0ZXJEYXRhTW9kaWZpZWQnOgogICAgICAgICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtbW8tcXVldWUtY2hhcmFjdGVyZGF0YQogICAgICAgICAgdmFyIHRhcmdldCA9IGUudGFyZ2V0OwoKICAgICAgICAgIC8vIDEuCiAgICAgICAgICB2YXIgcmVjb3JkID0gZ2V0UmVjb3JkKCdjaGFyYWN0ZXJEYXRhJywgdGFyZ2V0KTsKCiAgICAgICAgICAvLyAyLgogICAgICAgICAgdmFyIG9sZFZhbHVlID0gZS5wcmV2VmFsdWU7CgoKICAgICAgICAgIGZvckVhY2hBbmNlc3RvckFuZE9ic2VydmVyRW5xdWV1ZVJlY29yZCh0YXJnZXQsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgLy8gMy4xLCA0LjIKICAgICAgICAgICAgaWYgKCFvcHRpb25zLmNoYXJhY3RlckRhdGEpCiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMy4yLCA0LjMKICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2hhcmFjdGVyRGF0YU9sZFZhbHVlKQogICAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmRXaXRoT2xkVmFsdWUob2xkVmFsdWUpOwoKICAgICAgICAgICAgLy8gMy4zLCA0LjQKICAgICAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdET01Ob2RlUmVtb3ZlZCc6CiAgICAgICAgICB0aGlzLmFkZFRyYW5zaWVudE9ic2VydmVyKGUudGFyZ2V0KTsKICAgICAgICAgIC8vIEZhbGwgdGhyb3VnaC4KICAgICAgICBjYXNlICdET01Ob2RlSW5zZXJ0ZWQnOgogICAgICAgICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtbW8tcXVldWUtY2hpbGRsaXN0CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS5yZWxhdGVkTm9kZTsKICAgICAgICAgIHZhciBjaGFuZ2VkTm9kZSA9IGUudGFyZ2V0OwogICAgICAgICAgdmFyIGFkZGVkTm9kZXMsIHJlbW92ZWROb2RlczsKICAgICAgICAgIGlmIChlLnR5cGUgPT09ICdET01Ob2RlSW5zZXJ0ZWQnKSB7CiAgICAgICAgICAgIGFkZGVkTm9kZXMgPSBbY2hhbmdlZE5vZGVdOwogICAgICAgICAgICByZW1vdmVkTm9kZXMgPSBbXTsKICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBhZGRlZE5vZGVzID0gW107CiAgICAgICAgICAgIHJlbW92ZWROb2RlcyA9IFtjaGFuZ2VkTm9kZV07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNTaWJsaW5nID0gY2hhbmdlZE5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgdmFyIG5leHRTaWJsaW5nID0gY2hhbmdlZE5vZGUubmV4dFNpYmxpbmc7CgogICAgICAgICAgLy8gMS4KICAgICAgICAgIHZhciByZWNvcmQgPSBnZXRSZWNvcmQoJ2NoaWxkTGlzdCcsIHRhcmdldCk7CiAgICAgICAgICByZWNvcmQuYWRkZWROb2RlcyA9IGFkZGVkTm9kZXM7CiAgICAgICAgICByZWNvcmQucmVtb3ZlZE5vZGVzID0gcmVtb3ZlZE5vZGVzOwogICAgICAgICAgcmVjb3JkLnByZXZpb3VzU2libGluZyA9IHByZXZpb3VzU2libGluZzsKICAgICAgICAgIHJlY29yZC5uZXh0U2libGluZyA9IG5leHRTaWJsaW5nOwoKICAgICAgICAgIGZvckVhY2hBbmNlc3RvckFuZE9ic2VydmVyRW5xdWV1ZVJlY29yZCh0YXJnZXQsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgLy8gMi4xLCAzLjIKICAgICAgICAgICAgaWYgKCFvcHRpb25zLmNoaWxkTGlzdCkKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAvLyAyLjIsIDMuMwogICAgICAgICAgICByZXR1cm4gcmVjb3JkOwogICAgICAgICAgfSk7CgogICAgICB9CgogICAgICBjbGVhclJlY29yZHMoKTsKICAgIH0KICB9OwoKICBnbG9iYWwuSnNNdXRhdGlvbk9ic2VydmVyID0gSnNNdXRhdGlvbk9ic2VydmVyOwoKfSkodGhpcyk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKaWYgKCF3aW5kb3cuTXV0YXRpb25PYnNlcnZlcikgewogIHdpbmRvdy5NdXRhdGlvbk9ic2VydmVyID0gCiAgICAgIHdpbmRvdy5XZWJLaXRNdXRhdGlvbk9ic2VydmVyIHx8IAogICAgICB3aW5kb3cuSnNNdXRhdGlvbk9ic2VydmVyOwogIGlmICghTXV0YXRpb25PYnNlcnZlcikgewogICAgdGhyb3cgbmV3IEVycm9yKCJubyBtdXRhdGlvbiBvYnNlcnZlciBzdXBwb3J0Iik7CiAgfQp9CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKLyoqCiAqIEltcGxlbWVudHMgYGRvY3VtZW50LnJlZ2lzdGVyYAogKiBAbW9kdWxlIEN1c3RvbUVsZW1lbnRzCiovCgovKioKICogUG9seWZpbGxlZCBleHRlbnNpb25zIHRvIHRoZSBgZG9jdW1lbnRgIG9iamVjdC4KICogQGNsYXNzIERvY3VtZW50CiovCgooZnVuY3Rpb24oc2NvcGUpIHsKCi8vIGltcG9ydHMKCmlmICghc2NvcGUpIHsKICBzY29wZSA9IHdpbmRvdy5DdXN0b21FbGVtZW50cyA9IHtmbGFnczp7fX07Cn0KdmFyIGZsYWdzID0gc2NvcGUuZmxhZ3M7CgovLyBuYXRpdmUgZG9jdW1lbnQucmVnaXN0ZXI/Cgp2YXIgaGFzTmF0aXZlID0gQm9vbGVhbihkb2N1bWVudC5yZWdpc3Rlcik7CnZhciB1c2VOYXRpdmUgPSAhZmxhZ3MucmVnaXN0ZXIgJiYgaGFzTmF0aXZlOwoKaWYgKHVzZU5hdGl2ZSkgewoKICAvLyBzdHViCiAgdmFyIG5vcCA9IGZ1bmN0aW9uKCkge307CgogIC8vIGV4cG9ydHMKICBzY29wZS5yZWdpc3RyeSA9IHt9OwogIHNjb3BlLnVwZ3JhZGVFbGVtZW50ID0gbm9wOwogIAogIHNjb3BlLndhdGNoU2hhZG93ID0gbm9wOwogIHNjb3BlLnVwZ3JhZGUgPSBub3A7CiAgc2NvcGUudXBncmFkZUFsbCA9IG5vcDsKICBzY29wZS51cGdyYWRlU3VidHJlZSA9IG5vcDsKICBzY29wZS5vYnNlcnZlRG9jdW1lbnQgPSBub3A7CiAgc2NvcGUudXBncmFkZURvY3VtZW50ID0gbm9wOwogIHNjb3BlLnRha2VSZWNvcmRzID0gbm9wOwoKfSBlbHNlIHsKCiAgLyoqCiAgICogUmVnaXN0ZXJzIGEgY3VzdG9tIHRhZyBuYW1lIHdpdGggdGhlIGRvY3VtZW50LgogICAqCiAgICogV2hlbiBhIHJlZ2lzdGVyZWQgZWxlbWVudCBpcyBjcmVhdGVkLCBhIGByZWFkeUNhbGxiYWNrYCBtZXRob2QgaXMgY2FsbGVkCiAgICogaW4gdGhlIHNjb3BlIG9mIHRoZSBlbGVtZW50LiBUaGUgYHJlYWR5Q2FsbGJhY2tgIG1ldGhvZCBjYW4gYmUgc3BlY2lmaWVkIG9uCiAgICogZWl0aGVyIGBvcHRpb25zLnByb3RvdHlwZWAgb3IgYG9wdGlvbnMubGlmZWN5Y2xlYCB3aXRoIHRoZSBsYXR0ZXIgdGFraW5nCiAgICogcHJlY2VkZW5jZS4KICAgKgogICAqIEBtZXRob2QgcmVnaXN0ZXIKICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgdGFnIG5hbWUgdG8gcmVnaXN0ZXIuIE11c3QgaW5jbHVkZSBhIGRhc2ggKCctJyksCiAgICogICAgZm9yIGV4YW1wbGUgJ3gtY29tcG9uZW50Jy4KICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqICAgIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5leHRlbmRzXQogICAqICAgICAgKF9vZmYgc3BlY18pIFRhZyBuYW1lIG9mIGFuIGVsZW1lbnQgdG8gZXh0ZW5kIChvciBibGFuayBmb3IgYSBuZXcKICAgKiAgICAgIGVsZW1lbnQpLiBUaGlzIHBhcmFtZXRlciBpcyBub3QgcGFydCBvZiB0aGUgc3BlY2lmaWNhdGlvbiwgYnV0IGluc3RlYWQKICAgKiAgICAgIGlzIGEgaGludCBmb3IgdGhlIHBvbHlmaWxsIGJlY2F1c2UgdGhlIGV4dGVuZGVlIGlzIGRpZmZpY3VsdCB0byBpbmZlci4KICAgKiAgICAgIFJlbWVtYmVyIHRoYXQgdGhlIGlucHV0IHByb3RvdHlwZSBtdXN0IGNoYWluIHRvIHRoZSBleHRlbmRlZCBlbGVtZW50J3MKICAgKiAgICAgIHByb3RvdHlwZSAob3IgSFRNTEVsZW1lbnQucHJvdG90eXBlKSByZWdhcmRsZXNzIG9mIHRoZSB2YWx1ZSBvZgogICAqICAgICAgYGV4dGVuZHNgLgogICAqICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zLnByb3RvdHlwZSBUaGUgcHJvdG90eXBlIHRvIHVzZSBmb3IgdGhlIG5ldwogICAqICAgICAgZWxlbWVudC4gVGhlIHByb3RvdHlwZSBtdXN0IGluaGVyaXQgZnJvbSBIVE1MRWxlbWVudC4KICAgKiAgICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnMubGlmZWN5Y2xlXQogICAqICAgICAgQ2FsbGJhY2tzIHRoYXQgZmlyZSBhdCBpbXBvcnRhbnQgcGhhc2VzIGluIHRoZSBsaWZlIG9mIHRoZSBjdXN0b20KICAgKiAgICAgIGVsZW1lbnQuCiAgICoKICAgKiBAZXhhbXBsZQogICAqICAgICAgRmFuY3lCdXR0b24gPSBkb2N1bWVudC5yZWdpc3RlcigiZmFuY3ktYnV0dG9uIiwgewogICAqICAgICAgICBleHRlbmRzOiAnYnV0dG9uJywKICAgKiAgICAgICAgcHJvdG90eXBlOiBPYmplY3QuY3JlYXRlKEhUTUxCdXR0b25FbGVtZW50LnByb3RvdHlwZSwgewogICAqICAgICAgICAgIHJlYWR5Q2FsbGJhY2s6IHsKICAgKiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgKiAgICAgICAgICAgICAgY29uc29sZS5sb2coImEgZmFuY3ktYnV0dG9uIHdhcyBjcmVhdGVkIiwKICAgKiAgICAgICAgICAgIH0KICAgKiAgICAgICAgICB9CiAgICogICAgICAgIH0pCiAgICogICAgICB9KTsKICAgKiBAcmV0dXJuIHtGdW5jdGlvbn0gQ29uc3RydWN0b3IgZm9yIHRoZSBuZXdseSByZWdpc3RlcmVkIHR5cGUuCiAgICovCiAgZnVuY3Rpb24gcmVnaXN0ZXIobmFtZSwgb3B0aW9ucykgewogICAgLy9jb25zb2xlLndhcm4oJ2RvY3VtZW50LnJlZ2lzdGVyKCInICsgbmFtZSArICciLCAnLCBvcHRpb25zLCAnKScpOwogICAgLy8gY29uc3RydWN0IGEgZGVmaW50aW9uIG91dCBvZiBvcHRpb25zCiAgICAvLyBUT0RPKHNqbWlsZXMpOiBwcm9iYWJseSBzaG91bGQgY2xvbmUgb3B0aW9ucyBpbnN0ZWFkIG9mIG11dGF0aW5nIGl0CiAgICB2YXIgZGVmaW5pdGlvbiA9IG9wdGlvbnMgfHwge307CiAgICBpZiAoIW5hbWUpIHsKICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVwbGFjZSB3aXRoIG1vcmUgYXBwcm9wcmlhdGUgZXJyb3IgKEVyaWNCIGNhbiBwcm9iYWJseQogICAgICAvLyBvZmZlciBndWlkYW5jZSkKICAgICAgdGhyb3cgbmV3IEVycm9yKCdkb2N1bWVudC5yZWdpc3RlcjogZmlyc3QgYXJndW1lbnQgYG5hbWVgIG11c3Qgbm90IGJlIGVtcHR5Jyk7CiAgICB9CiAgICBpZiAobmFtZS5pbmRleE9mKCctJykgPCAwKSB7CiAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlcGxhY2Ugd2l0aCBtb3JlIGFwcHJvcHJpYXRlIGVycm9yIChFcmljQiBjYW4gcHJvYmFibHkKICAgICAgLy8gb2ZmZXIgZ3VpZGFuY2UpCiAgICAgIHRocm93IG5ldyBFcnJvcignZG9jdW1lbnQucmVnaXN0ZXI6IGZpcnN0IGFyZ3VtZW50IChcJ25hbWVcJykgbXVzdCBjb250YWluIGEgZGFzaCAoXCctXCcpLiBBcmd1bWVudCBwcm92aWRlZCB3YXMgXCcnICsgU3RyaW5nKG5hbWUpICsgJ1wnLicpOwogICAgfQogICAgLy8gcmVjb3JkIG5hbWUKICAgIGRlZmluaXRpb24ubmFtZSA9IG5hbWU7CiAgICAvLyBtdXN0IGhhdmUgYSBwcm90b3R5cGUsIGRlZmF1bHQgdG8gYW4gZXh0ZW5zaW9uIG9mIEhUTUxFbGVtZW50CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBwcm9iYWJseSBzaG91bGQgdGhyb3cgaWYgbm8gcHJvdG90eXBlLCBjaGVjayBzcGVjCiAgICBpZiAoIWRlZmluaXRpb24ucHJvdG90eXBlKSB7CiAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlcGxhY2Ugd2l0aCBtb3JlIGFwcHJvcHJpYXRlIGVycm9yIChFcmljQiBjYW4gcHJvYmFibHkKICAgICAgLy8gb2ZmZXIgZ3VpZGFuY2UpCiAgICAgIHRocm93IG5ldyBFcnJvcignT3B0aW9ucyBtaXNzaW5nIHJlcXVpcmVkIHByb3RvdHlwZSBwcm9wZXJ0eScpOwogICAgfQogICAgLy8gZW5zdXJlIGEgbGlmZWN5Y2xlIG9iamVjdCBzbyB3ZSBkb24ndCBoYXZlIHRvIG51bGwgdGVzdCBpdAogICAgZGVmaW5pdGlvbi5saWZlY3ljbGUgPSBkZWZpbml0aW9uLmxpZmVjeWNsZSB8fCB7fTsKICAgIC8vIGJ1aWxkIGEgbGlzdCBvZiBhbmNlc3RyYWwgY3VzdG9tIGVsZW1lbnRzIChmb3IgbmF0aXZlIGJhc2UgZGV0ZWN0aW9uKQogICAgLy8gVE9ETyhzam1pbGVzKTogd2UgdXNlZCB0byBuZWVkIHRvIHN0b3JlIHRoaXMsIGJ1dCBjdXJyZW50IGNvZGUgb25seQogICAgLy8gdXNlcyBpdCBpbiAncmVzb2x2ZVRhZ05hbWUnOiBpdCBzaG91bGQgcHJvYmFibHkgYmUgaW5saW5lZAogICAgZGVmaW5pdGlvbi5hbmNlc3RyeSA9IGFuY2VzdHJ5KGRlZmluaXRpb24uZXh0ZW5kcyk7CiAgICAvLyBleHRlbnNpb25zIG9mIG5hdGl2ZSBzcGVjaWFsaXphdGlvbnMgb2YgSFRNTEVsZW1lbnQgcmVxdWlyZSBsb2NhbE5hbWUKICAgIC8vIHRvIHJlbWFpbiBuYXRpdmUsIGFuZCB1c2Ugc2Vjb25kYXJ5ICdpcycgc3BlY2lmaWVyIGZvciBleHRlbnNpb24gdHlwZQogICAgcmVzb2x2ZVRhZ05hbWUoZGVmaW5pdGlvbik7CiAgICAvLyBzb21lIHBsYXRmb3JtcyByZXF1aXJlIG1vZGlmaWNhdGlvbnMgdG8gdGhlIHVzZXItc3VwcGxpZWQgcHJvdG90eXBlCiAgICAvLyBjaGFpbgogICAgcmVzb2x2ZVByb3RvdHlwZUNoYWluKGRlZmluaXRpb24pOwogICAgLy8gb3ZlcnJpZGVzIHRvIGltcGxlbWVudCBhdHRyaWJ1dGVDaGFuZ2VkIGNhbGxiYWNrCiAgICBvdmVycmlkZUF0dHJpYnV0ZUFwaShkZWZpbml0aW9uLnByb3RvdHlwZSk7CiAgICAvLyA3LjEuNTogUmVnaXN0ZXIgdGhlIERFRklOSVRJT04gd2l0aCBET0NVTUVOVAogICAgcmVnaXN0ZXJEZWZpbml0aW9uKG5hbWUsIGRlZmluaXRpb24pOwogICAgLy8gNy4xLjcuIFJ1biBjdXN0b20gZWxlbWVudCBjb25zdHJ1Y3RvciBnZW5lcmF0aW9uIGFsZ29yaXRobSB3aXRoIFBST1RPVFlQRQogICAgLy8gNy4xLjguIFJldHVybiB0aGUgb3V0cHV0IG9mIHRoZSBwcmV2aW91cyBzdGVwLgogICAgZGVmaW5pdGlvbi5jdG9yID0gZ2VuZXJhdGVDb25zdHJ1Y3RvcihkZWZpbml0aW9uKTsKICAgIGRlZmluaXRpb24uY3Rvci5wcm90b3R5cGUgPSBkZWZpbml0aW9uLnByb3RvdHlwZTsKICAgIC8vIGZvcmNlIG91ciAuY29uc3RydWN0b3IgdG8gYmUgb3VyIGFjdHVhbCBjb25zdHJ1Y3RvcgogICAgZGVmaW5pdGlvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBkZWZpbml0aW9uLmN0b3I7CiAgICAvLyBpZiBpbml0aWFsIHBhcnNpbmcgaXMgY29tcGxldGUKICAgIGlmIChzY29wZS5yZWFkeSkgewogICAgICAvLyB1cGdyYWRlIGFueSBwcmUtZXhpc3Rpbmcgbm9kZXMgb2YgdGhpcyB0eXBlCiAgICAgIHNjb3BlLnVwZ3JhZGVBbGwoZG9jdW1lbnQpOwogICAgfQogICAgcmV0dXJuIGRlZmluaXRpb24uY3RvcjsKICB9CgogIGZ1bmN0aW9uIGFuY2VzdHJ5KGV4dG5kcykgewogICAgdmFyIGV4dGVuZGVlID0gcmVnaXN0cnlbZXh0bmRzXTsKICAgIGlmIChleHRlbmRlZSkgewogICAgICByZXR1cm4gYW5jZXN0cnkoZXh0ZW5kZWUuZXh0ZW5kcykuY29uY2F0KFtleHRlbmRlZV0pOwogICAgfQogICAgcmV0dXJuIFtdOwogIH0KCiAgZnVuY3Rpb24gcmVzb2x2ZVRhZ05hbWUoZGVmaW5pdGlvbikgewogICAgLy8gaWYgd2UgYXJlIGV4cGxpY2l0bHkgZXh0ZW5kaW5nIHNvbWV0aGluZywgdGhhdCB0aGluZyBpcyBvdXIKICAgIC8vIGJhc2VUYWcsIHVubGVzcyBpdCByZXByZXNlbnRzIGEgY3VzdG9tIGNvbXBvbmVudAogICAgdmFyIGJhc2VUYWcgPSBkZWZpbml0aW9uLmV4dGVuZHM7CiAgICAvLyBpZiBvdXIgYW5jZXN0cnkgaW5jbHVkZXMgY3VzdG9tIGNvbXBvbmVudHMsIHdlIG9ubHkgaGF2ZSBhCiAgICAvLyBiYXNlVGFnIGlmIG9uZSBvZiB0aGVtIGRvZXMKICAgIGZvciAodmFyIGk9MCwgYTsgKGE9ZGVmaW5pdGlvbi5hbmNlc3RyeVtpXSk7IGkrKykgewogICAgICBiYXNlVGFnID0gYS5pcyAmJiBhLnRhZzsKICAgIH0KICAgIC8vIG91ciB0YWcgaXMgb3VyIGJhc2VUYWcsIGlmIGl0IGV4aXN0cywgYW5kIG90aGVyd2lzZSBqdXN0IG91ciBuYW1lCiAgICBkZWZpbml0aW9uLnRhZyA9IGJhc2VUYWcgfHwgZGVmaW5pdGlvbi5uYW1lOwogICAgaWYgKGJhc2VUYWcpIHsKICAgICAgLy8gaWYgdGhlcmUgaXMgYSBiYXNlIHRhZywgdXNlIHNlY29uZGFyeSAnaXMnIHNwZWNpZmllcgogICAgICBkZWZpbml0aW9uLmlzID0gZGVmaW5pdGlvbi5uYW1lOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVzb2x2ZVByb3RvdHlwZUNoYWluKGRlZmluaXRpb24pIHsKICAgIC8vIGlmIHdlIGRvbid0IHN1cHBvcnQgX19wcm90b19fIHdlIG5lZWQgdG8gbG9jYXRlIHRoZSBuYXRpdmUgbGV2ZWwKICAgIC8vIHByb3RvdHlwZSBmb3IgcHJlY2lzZSBtaXhpbmcgaW4KICAgIGlmICghT2JqZWN0Ll9fcHJvdG9fXykgewogICAgICAvLyBkZWZhdWx0IHByb3RvdHlwZQogICAgICB2YXIgbmF0aXZlUHJvdG90eXBlID0gSFRNTEVsZW1lbnQucHJvdG90eXBlOwogICAgICAvLyB3b3JrIG91dCBwcm90b3R5cGUgd2hlbiB1c2luZyB0eXBlLWV4dGVuc2lvbgogICAgICBpZiAoZGVmaW5pdGlvbi5pcykgewogICAgICAgIHZhciBpbnN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChkZWZpbml0aW9uLnRhZyk7CiAgICAgICAgbmF0aXZlUHJvdG90eXBlID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGluc3QpOwogICAgICB9CiAgICAgIC8vIGVuc3VyZSBfX3Byb3RvX18gcmVmZXJlbmNlIGlzIGluc3RhbGxlZCBhdCBlYWNoIHBvaW50IG9uIHRoZSBwcm90b3R5cGUKICAgICAgLy8gY2hhaW4uCiAgICAgIC8vIE5PVEU6IE9uIHBsYXRmb3JtcyB3aXRob3V0IF9fcHJvdG9fXywgYSBtaXhpbiBzdHJhdGVneSBpcyB1c2VkIGluc3RlYWQKICAgICAgLy8gb2YgcHJvdG90eXBlIHN3aXp6bGluZy4gSW4gdGhpcyBjYXNlLCB0aGlzIGdlbmVyYXRlZCBfX3Byb3RvX18gcHJvdmlkZXMKICAgICAgLy8gbGltaXRlZCBzdXBwb3J0IGZvciBwcm90b3R5cGUgdHJhdmVyc2FsLgogICAgICB2YXIgcHJvdG8gPSBkZWZpbml0aW9uLnByb3RvdHlwZSwgYW5jZXN0b3I7CiAgICAgIHdoaWxlIChwcm90byAmJiAocHJvdG8gIT09IG5hdGl2ZVByb3RvdHlwZSkpIHsKICAgICAgICB2YXIgYW5jZXN0b3IgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YocHJvdG8pOwogICAgICAgIHByb3RvLl9fcHJvdG9fXyA9IGFuY2VzdG9yOwogICAgICAgIHByb3RvID0gYW5jZXN0b3I7CiAgICAgIH0KICAgIH0KICAgIC8vIGNhY2hlIHRoaXMgaW4gY2FzZSBvZiBtaXhpbgogICAgZGVmaW5pdGlvbi5uYXRpdmUgPSBuYXRpdmVQcm90b3R5cGU7CiAgfQoKICAvLyBTRUNUSU9OIDQKCiAgZnVuY3Rpb24gaW5zdGFudGlhdGUoZGVmaW5pdGlvbikgewogICAgLy8gNC5hLjEuIENyZWF0ZSBhIG5ldyBvYmplY3QgdGhhdCBpbXBsZW1lbnRzIFBST1RPVFlQRQogICAgLy8gNC5hLjIuIExldCBFTEVNRU5UIGJ5IHRoaXMgbmV3IG9iamVjdAogICAgLy8KICAgIC8vIHRoZSBjdXN0b20gZWxlbWVudCBpbnN0YW50aWF0aW9uIGFsZ29yaXRobSBtdXN0IGFsc28gZW5zdXJlIHRoYXQgdGhlCiAgICAvLyBvdXRwdXQgaXMgYSB2YWxpZCBET00gZWxlbWVudCB3aXRoIHRoZSBwcm9wZXIgd3JhcHBlciBpbiBwbGFjZS4KICAgIC8vCiAgICByZXR1cm4gdXBncmFkZShkb21DcmVhdGVFbGVtZW50KGRlZmluaXRpb24udGFnKSwgZGVmaW5pdGlvbik7CiAgfQoKICBmdW5jdGlvbiB1cGdyYWRlKGVsZW1lbnQsIGRlZmluaXRpb24pIHsKICAgIC8vIHNvbWUgZGVmaW5pdGlvbnMgc3BlY2lmeSBhbiAnaXMnIGF0dHJpYnV0ZQogICAgaWYgKGRlZmluaXRpb24uaXMpIHsKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2lzJywgZGVmaW5pdGlvbi5pcyk7CiAgICB9CiAgICAvLyBtYWtlICdlbGVtZW50JyBpbXBsZW1lbnQgZGVmaW5pdGlvbi5wcm90b3R5cGUKICAgIGltcGxlbWVudChlbGVtZW50LCBkZWZpbml0aW9uKTsKICAgIC8vIGZsYWcgYXMgdXBncmFkZWQKICAgIGVsZW1lbnQuX191cGdyYWRlZF9fID0gdHJ1ZTsKICAgIC8vIHRoZXJlIHNob3VsZCBuZXZlciBiZSBhIHNoYWRvdyByb290IG9uIGVsZW1lbnQgYXQgdGhpcyBwb2ludAogICAgLy8gd2UgcmVxdWlyZSBjaGlsZCBub2RlcyBiZSB1cGdyYWRlZCBiZWZvcmUgYGNyZWF0ZWRgCiAgICBzY29wZS51cGdyYWRlU3VidHJlZShlbGVtZW50KTsKICAgIC8vIGxpZmVjeWNsZSBtYW5hZ2VtZW50CiAgICBjcmVhdGVkKGVsZW1lbnQpOwogICAgLy8gT1VUUFVUCiAgICByZXR1cm4gZWxlbWVudDsKICB9CgogIGZ1bmN0aW9uIGltcGxlbWVudChlbGVtZW50LCBkZWZpbml0aW9uKSB7CiAgICAvLyBwcm90b3R5cGUgc3dpenpsaW5nIGlzIGJlc3QKICAgIGlmIChPYmplY3QuX19wcm90b19fKSB7CiAgICAgIGVsZW1lbnQuX19wcm90b19fID0gZGVmaW5pdGlvbi5wcm90b3R5cGU7CiAgICB9IGVsc2UgewogICAgICAvLyB3aGVyZSBhYm92ZSB3ZSBjYW4gcmUtYWNxdWlyZSBpblByb3RvdHlwZSB2aWEKICAgICAgLy8gZ2V0UHJvdG90eXBlT2YoRWxlbWVudCksIHdlIGNhbm5vdCBkbyBzbyB3aGVuCiAgICAgIC8vIHdlIHVzZSBtaXhpbiwgc28gd2UgaW5zdGFsbCBhIG1hZ2ljIHJlZmVyZW5jZQogICAgICBjdXN0b21NaXhpbihlbGVtZW50LCBkZWZpbml0aW9uLnByb3RvdHlwZSwgZGVmaW5pdGlvbi5uYXRpdmUpOwogICAgICBlbGVtZW50Ll9fcHJvdG9fXyA9IGRlZmluaXRpb24ucHJvdG90eXBlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY3VzdG9tTWl4aW4oaW5UYXJnZXQsIGluU3JjLCBpbk5hdGl2ZSkgewogICAgLy8gVE9ETyhzam1pbGVzKTogJ3VzZWQnIGFsbG93cyB1cyB0byBvbmx5IGNvcHkgdGhlICd5b3VuZ2VzdCcgdmVyc2lvbiBvZgogICAgLy8gYW55IHByb3BlcnR5LiBUaGlzIHNldCBzaG91bGQgYmUgcHJlY2FsY3VsYXRlZC4gV2UgYWxzbyBuZWVkIHRvCiAgICAvLyBjb25zaWRlciB0aGlzIGZvciBzdXBwb3J0aW5nICdzdXBlcicuCiAgICB2YXIgdXNlZCA9IHt9OwogICAgLy8gc3RhcnQgd2l0aCBpblNyYwogICAgdmFyIHAgPSBpblNyYzsKICAgIC8vIHNvbWV0aW1lcyB0aGUgZGVmYXVsdCBpcyBIVE1MVW5rbm93bkVsZW1lbnQucHJvdG90eXBlIGluc3RlYWQgb2YKICAgIC8vIEhUTUxFbGVtZW50LnByb3RvdHlwZSwgc28gd2UgYWRkIGEgdGVzdAogICAgLy8gdGhlIGlkZWEgaXMgdG8gYXZvaWQgbWl4aW5nIGluIG5hdGl2ZSBwcm90b3R5cGVzLCBzbyBhZGRpbmcKICAgIC8vIHRoZSBzZWNvbmQgdGVzdCBpcyBXTE9HCiAgICB3aGlsZSAocCAhPT0gaW5OYXRpdmUgJiYgcCAhPT0gSFRNTFVua25vd25FbGVtZW50LnByb3RvdHlwZSkgewogICAgICB2YXIga2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHApOwogICAgICBmb3IgKHZhciBpPTAsIGs7IGs9a2V5c1tpXTsgaSsrKSB7CiAgICAgICAgaWYgKCF1c2VkW2tdKSB7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaW5UYXJnZXQsIGssCiAgICAgICAgICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwLCBrKSk7CiAgICAgICAgICB1c2VkW2tdID0gMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihwKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZWQoZWxlbWVudCkgewogICAgLy8gaW52b2tlIGNyZWF0ZWRDYWxsYmFjawogICAgaWYgKGVsZW1lbnQuY3JlYXRlZENhbGxiYWNrKSB7CiAgICAgIGVsZW1lbnQuY3JlYXRlZENhbGxiYWNrKCk7CiAgICB9CiAgfQoKICAvLyBhdHRyaWJ1dGUgd2F0Y2hpbmcKCiAgZnVuY3Rpb24gb3ZlcnJpZGVBdHRyaWJ1dGVBcGkocHJvdG90eXBlKSB7CiAgICAvLyBvdmVycmlkZXMgdG8gaW1wbGVtZW50IGNhbGxiYWNrcwogICAgLy8gVE9ETyhzam1pbGVzKTogc2hvdWxkIHN1cHBvcnQgYWNjZXNzIHZpYSAuYXR0cmlidXRlcyBOYW1lZE5vZGVNYXAKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHByZXNlcnZlcyB1c2VyIGRlZmluZWQgb3ZlcnJpZGVzLCBpZiBhbnkKICAgIHZhciBzZXRBdHRyaWJ1dGUgPSBwcm90b3R5cGUuc2V0QXR0cmlidXRlOwogICAgcHJvdG90eXBlLnNldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIGNoYW5nZUF0dHJpYnV0ZS5jYWxsKHRoaXMsIG5hbWUsIHZhbHVlLCBzZXRBdHRyaWJ1dGUpOwogICAgfQogICAgdmFyIHJlbW92ZUF0dHJpYnV0ZSA9IHByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGU7CiAgICBwcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgY2hhbmdlQXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIHJlbW92ZUF0dHJpYnV0ZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjaGFuZ2VBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG9wZXJhdGlvbikgewogICAgdmFyIG9sZFZhbHVlID0gdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICBvcGVyYXRpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmICh0aGlzLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayAKICAgICAgICAmJiAodGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkgIT09IG9sZFZhbHVlKSkgewogICAgICB0aGlzLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayhuYW1lLCBvbGRWYWx1ZSk7CiAgICB9CiAgfQoKICAvLyBlbGVtZW50IHJlZ2lzdHJ5IChtYXBzIHRhZyBuYW1lcyB0byBkZWZpbml0aW9ucykKCiAgdmFyIHJlZ2lzdHJ5ID0ge307CgogIGZ1bmN0aW9uIHJlZ2lzdGVyRGVmaW5pdGlvbihuYW1lLCBkZWZpbml0aW9uKSB7CiAgICByZWdpc3RyeVtuYW1lXSA9IGRlZmluaXRpb247CiAgfQoKICBmdW5jdGlvbiBnZW5lcmF0ZUNvbnN0cnVjdG9yKGRlZmluaXRpb24pIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGluc3RhbnRpYXRlKGRlZmluaXRpb24pOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQodGFnLCB0eXBlRXh0ZW5zaW9uKSB7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBpZ25vcmUgJ3RhZycgd2hlbiB1c2luZyAndHlwZUV4dGVuc2lvbicsIHdlIGNvdWxkCiAgICAvLyBlcnJvciBjaGVjayBpdCwgb3IgcGVyaGFwcyB0aGVyZSBzaG91bGQgb25seSBldmVyIGJlIG9uZSBhcmd1bWVudAogICAgdmFyIGRlZmluaXRpb24gPSByZWdpc3RyeVt0eXBlRXh0ZW5zaW9uIHx8IHRhZ107CiAgICBpZiAoZGVmaW5pdGlvbikgewogICAgICByZXR1cm4gbmV3IGRlZmluaXRpb24uY3RvcigpOwogICAgfQogICAgcmV0dXJuIGRvbUNyZWF0ZUVsZW1lbnQodGFnKTsKICB9CgogIGZ1bmN0aW9uIHVwZ3JhZGVFbGVtZW50KGVsZW1lbnQpIHsKICAgIGlmICghZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgKGVsZW1lbnQubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFKSkgewogICAgICB2YXIgdHlwZSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdpcycpIHx8IGVsZW1lbnQubG9jYWxOYW1lOwogICAgICB2YXIgZGVmaW5pdGlvbiA9IHJlZ2lzdHJ5W3R5cGVdOwogICAgICByZXR1cm4gZGVmaW5pdGlvbiAmJiB1cGdyYWRlKGVsZW1lbnQsIGRlZmluaXRpb24pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2xvbmVOb2RlKGRlZXApIHsKICAgIC8vIGNhbGwgb3JpZ2luYWwgY2xvbmUKICAgIHZhciBuID0gZG9tQ2xvbmVOb2RlLmNhbGwodGhpcywgZGVlcCk7CiAgICAvLyB1cGdyYWRlIHRoZSBlbGVtZW50IGFuZCBzdWJ0cmVlCiAgICBzY29wZS51cGdyYWRlQWxsKG4pOwogICAgLy8gcmV0dXJuIHRoZSBjbG9uZQogICAgcmV0dXJuIG47CiAgfQogIC8vIGNhcHR1cmUgbmF0aXZlIGNyZWF0ZUVsZW1lbnQgYmVmb3JlIHdlIG92ZXJyaWRlIGl0CgogIHZhciBkb21DcmVhdGVFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudC5iaW5kKGRvY3VtZW50KTsKCiAgLy8gY2FwdHVyZSBuYXRpdmUgY2xvbmVOb2RlIGJlZm9yZSB3ZSBvdmVycmlkZSBpdAoKICB2YXIgZG9tQ2xvbmVOb2RlID0gTm9kZS5wcm90b3R5cGUuY2xvbmVOb2RlOwoKICAvLyBleHBvcnRzCgogIGRvY3VtZW50LnJlZ2lzdGVyID0gcmVnaXN0ZXI7CiAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQ7IC8vIG92ZXJyaWRlCiAgTm9kZS5wcm90b3R5cGUuY2xvbmVOb2RlID0gY2xvbmVOb2RlOyAvLyBvdmVycmlkZQoKICBzY29wZS5yZWdpc3RyeSA9IHJlZ2lzdHJ5OwoKICAvKioKICAgKiBVcGdyYWRlIGFuIGVsZW1lbnQgdG8gYSBjdXN0b20gZWxlbWVudC4gVXBncmFkaW5nIGFuIGVsZW1lbnQKICAgKiBjYXVzZXMgdGhlIGN1c3RvbSBwcm90b3R5cGUgdG8gYmUgYXBwbGllZCwgYW4gYGlzYCBhdHRyaWJ1dGUgCiAgICogdG8gYmUgYXR0YWNoZWQgKGFzIG5lZWRlZCksIGFuZCBpbnZvY2F0aW9uIG9mIHRoZSBgcmVhZHlDYWxsYmFja2AuCiAgICogYHVwZ3JhZGVgIGRvZXMgbm90aGluZyBpZiB0aGUgZWxlbWVudCBpcyBhbHJlYWR5IHVwZ3JhZGVkLCBvcgogICAqIGlmIGl0IG1hdGNoZXMgbm8gcmVnaXN0ZXJlZCBjdXN0b20gdGFnIG5hbWUuCiAgICoKICAgKiBAbWV0aG9kIHVncHJhZGUKICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgVGhlIGVsZW1lbnQgdG8gdXBncmFkZS4KICAgKiBAcmV0dXJuIHtFbGVtZW50fSBUaGUgdXBncmFkZWQgZWxlbWVudC4KICAgKi8KICBzY29wZS51cGdyYWRlID0gdXBncmFkZUVsZW1lbnQ7Cn0KCnNjb3BlLmhhc05hdGl2ZSA9IGhhc05hdGl2ZTsKc2NvcGUudXNlTmF0aXZlID0gdXNlTmF0aXZlOwoKfSkod2luZG93LkN1c3RvbUVsZW1lbnRzKTsKCiAvKg0KQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4NClVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlDQpsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuDQoqLw0KDQooZnVuY3Rpb24oc2NvcGUpew0KDQp2YXIgbG9nRmxhZ3MgPSB3aW5kb3cubG9nRmxhZ3MgfHwge307DQoNCi8vIHdhbGsgdGhlIHN1YnRyZWUgcm9vdGVkIGF0IG5vZGUsIGFwcGx5aW5nICdmaW5kKGVsZW1lbnQsIGRhdGEpJyBmdW5jdGlvbg0KLy8gdG8gZWFjaCBlbGVtZW50DQovLyBpZiAnZmluZCcgcmV0dXJucyB0cnVlIGZvciAnZWxlbWVudCcsIGRvIG5vdCBzZWFyY2ggZWxlbWVudCdzIHN1YnRyZWUNCmZ1bmN0aW9uIGZpbmRBbGwobm9kZSwgZmluZCwgZGF0YSkgew0KICB2YXIgZSA9IG5vZGUuZmlyc3RFbGVtZW50Q2hpbGQ7DQogIGlmICghZSkgew0KICAgIGUgPSBub2RlLmZpcnN0Q2hpbGQ7DQogICAgd2hpbGUgKGUgJiYgZS5ub2RlVHlwZSAhPT0gTm9kZS5FTEVNRU5UX05PREUpIHsNCiAgICAgIGUgPSBlLm5leHRTaWJsaW5nOw0KICAgIH0NCiAgfQ0KICB3aGlsZSAoZSkgew0KICAgIGlmIChmaW5kKGUsIGRhdGEpICE9PSB0cnVlKSB7DQogICAgICBmaW5kQWxsKGUsIGZpbmQsIGRhdGEpOw0KICAgIH0NCiAgICBlID0gZS5uZXh0RWxlbWVudFNpYmxpbmc7DQogIH0NCiAgcmV0dXJuIG51bGw7DQp9DQoNCi8vIHdhbGsgYWxsIHNoYWRvd1Jvb3RzIG9uIGEgZ2l2ZW4gbm9kZS4NCmZ1bmN0aW9uIGZvclJvb3RzKG5vZGUsIGNiKSB7DQogIHZhciByb290ID0gbm9kZS5zaGFkb3dSb290Ow0KICB3aGlsZShyb290KSB7DQogICAgZm9yU3VidHJlZShyb290LCBjYik7DQogICAgcm9vdCA9IHJvb3Qub2xkZXJTaGFkb3dSb290Ow0KICB9DQp9DQoNCi8vIHdhbGsgdGhlIHN1YnRyZWUgcm9vdGVkIGF0IG5vZGUsIGluY2x1ZGluZyBkZXNjZW50IGludG8gc2hhZG93LXJvb3RzLA0KLy8gYXBwbHlpbmcgJ2NiJyB0byBlYWNoIGVsZW1lbnQNCmZ1bmN0aW9uIGZvclN1YnRyZWUobm9kZSwgY2IpIHsNCiAgLy9sb2dGbGFncy5kb20gJiYgbm9kZS5jaGlsZE5vZGVzICYmIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggJiYgY29uc29sZS5ncm91cCgnc3ViVHJlZTogJywgbm9kZSk7DQogIGZpbmRBbGwobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgIGlmIChjYihlKSkgew0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICAgIGZvclJvb3RzKGUsIGNiKTsNCiAgfSk7DQogIGZvclJvb3RzKG5vZGUsIGNiKTsNCiAgLy9sb2dGbGFncy5kb20gJiYgbm9kZS5jaGlsZE5vZGVzICYmIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggJiYgY29uc29sZS5ncm91cEVuZCgpOw0KfQ0KDQovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUNCmZ1bmN0aW9uIGFkZGVkKG5vZGUpIHsNCiAgaWYgKHVwZ3JhZGUobm9kZSkpIHsNCiAgICBpbnNlcnRlZE5vZGUobm9kZSk7DQogICAgcmV0dXJuIHRydWU7DQogIH0NCiAgaW5zZXJ0ZWQobm9kZSk7DQp9DQoNCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZSdzIHN1YnRyZWUgb25seQ0KZnVuY3Rpb24gYWRkZWRTdWJ0cmVlKG5vZGUpIHsNCiAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7DQogICAgaWYgKGFkZGVkKGUpKSB7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogIH0pOw0KfQ0KDQovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUgYW5kIGl0J3Mgc3VidHJlZQ0KZnVuY3Rpb24gYWRkZWROb2RlKG5vZGUpIHsNCiAgcmV0dXJuIGFkZGVkKG5vZGUpIHx8IGFkZGVkU3VidHJlZShub2RlKTsNCn0NCg0KLy8gdXBncmFkZSBjdXN0b20gZWxlbWVudHMgYXQgbm9kZSwgaWYgYXBwbGljYWJsZQ0KZnVuY3Rpb24gdXBncmFkZShub2RlKSB7DQogIGlmICghbm9kZS5fX3VwZ3JhZGVkX18gJiYgbm9kZS5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpIHsNCiAgICB2YXIgdHlwZSA9IG5vZGUuZ2V0QXR0cmlidXRlKCdpcycpIHx8IG5vZGUubG9jYWxOYW1lOw0KICAgIHZhciBkZWZpbml0aW9uID0gc2NvcGUucmVnaXN0cnlbdHlwZV07DQogICAgaWYgKGRlZmluaXRpb24pIHsNCiAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCd1cGdyYWRlOicsIG5vZGUubG9jYWxOYW1lKTsNCiAgICAgIHNjb3BlLnVwZ3JhZGUobm9kZSk7DQogICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOw0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICB9DQp9DQoNCmZ1bmN0aW9uIGluc2VydGVkTm9kZShub2RlKSB7DQogIGluc2VydGVkKG5vZGUpOw0KICBpZiAoaW5Eb2N1bWVudChub2RlKSkgew0KICAgIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgICAgaW5zZXJ0ZWQoZSk7DQogICAgfSk7DQogIH0NCn0NCg0KDQovLyBUT0RPKHNvcnZlbGwpOiBvbiBwbGF0Zm9ybXMgd2l0aG91dCBNdXRhdGlvbk9ic2VydmVyLCBtdXRhdGlvbnMgbWF5IG5vdCBiZSANCi8vIHJlbGlhYmxlIGFuZCB0aGVyZWZvcmUgZW50ZXJlZC9sZWZ0VmlldyBhcmUgbm90IHJlbGlhYmxlLg0KLy8gVG8gbWFrZSB0aGVzZSBjYWxsYmFja3MgbGVzcyBsaWtlbHkgdG8gZmFpbCwgd2UgZGVmZXIgYWxsIGluc2VydHMgYW5kIHJlbW92ZXMNCi8vIHRvIGdpdmUgYSBjaGFuY2UgZm9yIGVsZW1lbnRzIHRvIGJlIGluc2VydGVkIGludG8gZG9tLiANCi8vIFRoaXMgZW5zdXJlcyBlbnRlcmVkVmlld0NhbGxiYWNrIGZpcmVzIGZvciBlbGVtZW50cyB0aGF0IGFyZSBjcmVhdGVkIGFuZCANCi8vIGltbWVkaWF0ZWx5IGFkZGVkIHRvIGRvbS4NCnZhciBoYXNQb2x5ZmlsbE11dGF0aW9ucyA9ICghd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIgfHwNCiAgICAod2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIgPT09IHdpbmRvdy5Kc011dGF0aW9uT2JzZXJ2ZXIpKTsNCnNjb3BlLmhhc1BvbHlmaWxsTXV0YXRpb25zID0gaGFzUG9seWZpbGxNdXRhdGlvbnM7DQoNCnZhciBpc1BlbmRpbmdNdXRhdGlvbnMgPSBmYWxzZTsNCnZhciBwZW5kaW5nTXV0YXRpb25zID0gW107DQpmdW5jdGlvbiBkZWZlck11dGF0aW9uKGZuKSB7DQogIHBlbmRpbmdNdXRhdGlvbnMucHVzaChmbik7DQogIGlmICghaXNQZW5kaW5nTXV0YXRpb25zKSB7DQogICAgaXNQZW5kaW5nTXV0YXRpb25zID0gdHJ1ZTsNCiAgICB2YXIgYXN5bmMgPSAod2luZG93LlBsYXRmb3JtICYmIHdpbmRvdy5QbGF0Zm9ybS5lbmRPZk1pY3JvdGFzaykgfHwNCiAgICAgICAgc2V0VGltZW91dDsNCiAgICBhc3luYyh0YWtlTXV0YXRpb25zKTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiB0YWtlTXV0YXRpb25zKCkgew0KICBpc1BlbmRpbmdNdXRhdGlvbnMgPSBmYWxzZTsNCiAgdmFyICRwID0gcGVuZGluZ011dGF0aW9uczsNCiAgZm9yICh2YXIgaT0wLCBsPSRwLmxlbmd0aCwgcDsgKGk8bCkgJiYgKHA9JHBbaV0pOyBpKyspIHsNCiAgICBwKCk7DQogIH0NCiAgcGVuZGluZ011dGF0aW9ucyA9IFtdOw0KfQ0KDQpmdW5jdGlvbiBpbnNlcnRlZChlbGVtZW50KSB7DQogIGlmIChoYXNQb2x5ZmlsbE11dGF0aW9ucykgew0KICAgIGRlZmVyTXV0YXRpb24oZnVuY3Rpb24oKSB7DQogICAgICBfaW5zZXJ0ZWQoZWxlbWVudCk7DQogICAgfSk7DQogIH0gZWxzZSB7DQogICAgX2luc2VydGVkKGVsZW1lbnQpOw0KICB9DQp9DQoNCi8vIFRPRE8oc2ptaWxlcyk6IGlmIHRoZXJlIGFyZSBkZXNjZW50cyBpbnRvIHRyZWVzIHRoYXQgY2FuIG5ldmVyIGhhdmUgaW5Eb2N1bWVudCgqKSB0cnVlLCBmaXggdGhpcw0KZnVuY3Rpb24gX2luc2VydGVkKGVsZW1lbnQpIHsNCiAgLy8gVE9ETyhzam1pbGVzKTogaXQncyBwb3NzaWJsZSB3ZSB3ZXJlIGluc2VydGVkIGFuZCByZW1vdmVkIGluIHRoZSBzcGFjZQ0KICAvLyBvZiBvbmUgbWljcm90YXNrLCBpbiB3aGljaCBjYXNlIHdlIHdvbid0IGJlICdpbkRvY3VtZW50JyBoZXJlDQogIC8vIEJ1dCB0aGVyZSBhcmUgb3RoZXIgY2FzZXMgd2hlcmUgd2UgYXJlIHRlc3RpbmcgZm9yIGluc2VydGVkIHdpdGhvdXQNCiAgLy8gc3BlY2lmaWMga25vd2xlZGdlIG9mIG11dGF0aW9ucywgYW5kIG11c3QgdGVzdCAnaW5Eb2N1bWVudCcgdG8gZGV0ZXJtaW5lDQogIC8vIHdoZXRoZXIgdG8gY2FsbCBpbnNlcnRlZA0KICAvLyBJZiB3ZSBjYW4gZmFjdG9yIHRoZXNlIGNhc2VzIGludG8gc2VwYXJhdGUgY29kZSBwYXRocyB3ZSBjYW4gaGF2ZQ0KICAvLyBiZXR0ZXIgZGlhZ25vc3RpY3MuDQogIC8vIFRPRE8oc2ptaWxlcyk6IHdoZW4gbG9nZ2luZywgZG8gd29yayBvbiBhbGwgY3VzdG9tIGVsZW1lbnRzIHNvIHdlIGNhbg0KICAvLyB0cmFjayBiZWhhdmlvciBldmVuIHdoZW4gY2FsbGJhY2tzIG5vdCBkZWZpbmVkDQogIC8vY29uc29sZS5sb2coJ2luc2VydGVkOiAnLCBlbGVtZW50LmxvY2FsTmFtZSk7DQogIGlmIChlbGVtZW50LmVudGVyZWRWaWV3Q2FsbGJhY2sgfHwgKGVsZW1lbnQuX191cGdyYWRlZF9fICYmIGxvZ0ZsYWdzLmRvbSkpIHsNCiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgnaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOw0KICAgIGlmIChpbkRvY3VtZW50KGVsZW1lbnQpKSB7DQogICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAoZWxlbWVudC5fX2luc2VydGVkIHx8IDApICsgMTsNCiAgICAgIC8vIGlmIHdlIGFyZSBpbiBhICdyZW1vdmVkJyBzdGF0ZSwgYmx1bnRseSBhZGp1c3QgdG8gYW4gJ2luc2VydGVkJyBzdGF0ZQ0KICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA8IDEpIHsNCiAgICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gMTsNCiAgICAgIH0NCiAgICAgIC8vIGlmIHdlIGFyZSAnb3ZlciBpbnNlcnRlZCcsIHNxdWVsY2ggdGhlIGNhbGxiYWNrDQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkID4gMSkgew0KICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS53YXJuKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSwNCiAgICAgICAgICAnaW5zZXJ0L3JlbW92ZSBjb3VudDonLCBlbGVtZW50Ll9faW5zZXJ0ZWQpDQogICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuZW50ZXJlZFZpZXdDYWxsYmFjaykgew0KICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsNCiAgICAgICAgZWxlbWVudC5lbnRlcmVkVmlld0NhbGxiYWNrKCk7DQogICAgICB9DQogICAgfQ0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQogIH0NCn0NCg0KZnVuY3Rpb24gcmVtb3ZlZE5vZGUobm9kZSkgew0KICByZW1vdmVkKG5vZGUpOw0KICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsNCiAgICByZW1vdmVkKGUpOw0KICB9KTsNCn0NCg0KDQpmdW5jdGlvbiByZW1vdmVkKGVsZW1lbnQpIHsNCiAgaWYgKGhhc1BvbHlmaWxsTXV0YXRpb25zKSB7DQogICAgZGVmZXJNdXRhdGlvbihmdW5jdGlvbigpIHsNCiAgICAgIF9yZW1vdmVkKGVsZW1lbnQpOw0KICAgIH0pOw0KICB9IGVsc2Ugew0KICAgIF9yZW1vdmVkKGVsZW1lbnQpOw0KICB9DQp9DQoNCmZ1bmN0aW9uIHJlbW92ZWQoZWxlbWVudCkgew0KICAvLyBUT0RPKHNqbWlsZXMpOiB0ZW1wb3Jhcnk6IGRvIHdvcmsgb24gYWxsIGN1c3RvbSBlbGVtZW50cyBzbyB3ZSBjYW4gdHJhY2sNCiAgLy8gYmVoYXZpb3IgZXZlbiB3aGVuIGNhbGxiYWNrcyBub3QgZGVmaW5lZA0KICBpZiAoZWxlbWVudC5sZWZ0Vmlld0NhbGxiYWNrIHx8IChlbGVtZW50Ll9fdXBncmFkZWRfXyAmJiBsb2dGbGFncy5kb20pKSB7DQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCdyZW1vdmVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsNCiAgICBpZiAoIWluRG9jdW1lbnQoZWxlbWVudCkpIHsNCiAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IChlbGVtZW50Ll9faW5zZXJ0ZWQgfHwgMCkgLSAxOw0KICAgICAgLy8gaWYgd2UgYXJlIGluIGEgJ2luc2VydGVkJyBzdGF0ZSwgYmx1bnRseSBhZGp1c3QgdG8gYW4gJ3JlbW92ZWQnIHN0YXRlDQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkID4gMCkgew0KICAgICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAwOw0KICAgICAgfQ0KICAgICAgLy8gaWYgd2UgYXJlICdvdmVyIHJlbW92ZWQnLCBzcXVlbGNoIHRoZSBjYWxsYmFjaw0KICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA8IDApIHsNCiAgICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUud2FybigncmVtb3ZlZDonLCBlbGVtZW50LmxvY2FsTmFtZSwNCiAgICAgICAgICAgICdpbnNlcnQvcmVtb3ZlIGNvdW50OicsIGVsZW1lbnQuX19pbnNlcnRlZCkNCiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5sZWZ0Vmlld0NhbGxiYWNrKSB7DQogICAgICAgIGVsZW1lbnQubGVmdFZpZXdDYWxsYmFjaygpOw0KICAgICAgfQ0KICAgIH0NCiAgfQ0KfQ0KDQpmdW5jdGlvbiBpbkRvY3VtZW50KGVsZW1lbnQpIHsNCiAgdmFyIHAgPSBlbGVtZW50Ow0KICB2YXIgZG9jID0gd2luZG93LlNoYWRvd0RPTVBvbHlmaWxsICYmDQogICAgICB3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwud3JhcElmTmVlZGVkKGRvY3VtZW50KSB8fCBkb2N1bWVudDsNCiAgd2hpbGUgKHApIHsNCiAgICBpZiAocCA9PSBkb2MpIHsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICBwID0gcC5wYXJlbnROb2RlIHx8IHAuaG9zdDsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiB3YXRjaFNoYWRvdyhub2RlKSB7DQogIGlmIChub2RlLnNoYWRvd1Jvb3QgJiYgIW5vZGUuc2hhZG93Um9vdC5fX3dhdGNoZWQpIHsNCiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ3dhdGNoaW5nIHNoYWRvdy1yb290IGZvcjogJywgbm9kZS5sb2NhbE5hbWUpOw0KICAgIC8vIHdhdGNoIGFsbCB1bndhdGNoZWQgcm9vdHMuLi4NCiAgICB2YXIgcm9vdCA9IG5vZGUuc2hhZG93Um9vdDsNCiAgICB3aGlsZSAocm9vdCkgew0KICAgICAgd2F0Y2hSb290KHJvb3QpOw0KICAgICAgcm9vdCA9IHJvb3Qub2xkZXJTaGFkb3dSb290Ow0KICAgIH0NCiAgfQ0KfQ0KDQpmdW5jdGlvbiB3YXRjaFJvb3Qocm9vdCkgew0KICBpZiAoIXJvb3QuX193YXRjaGVkKSB7DQogICAgb2JzZXJ2ZShyb290KTsNCiAgICByb290Ll9fd2F0Y2hlZCA9IHRydWU7DQogIH0NCn0NCg0KZnVuY3Rpb24gZmlsdGVyKGluTm9kZSkgew0KICBzd2l0Y2ggKGluTm9kZS5sb2NhbE5hbWUpIHsNCiAgICBjYXNlICdzdHlsZSc6DQogICAgY2FzZSAnc2NyaXB0JzoNCiAgICBjYXNlICd0ZW1wbGF0ZSc6DQogICAgY2FzZSB1bmRlZmluZWQ6DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiBoYW5kbGVyKG11dGF0aW9ucykgew0KICAvLw0KICBpZiAobG9nRmxhZ3MuZG9tKSB7DQogICAgdmFyIG14ID0gbXV0YXRpb25zWzBdOw0KICAgIGlmIChteCAmJiBteC50eXBlID09PSAnY2hpbGRMaXN0JyAmJiBteC5hZGRlZE5vZGVzKSB7DQogICAgICAgIGlmIChteC5hZGRlZE5vZGVzKSB7DQogICAgICAgICAgdmFyIGQgPSBteC5hZGRlZE5vZGVzWzBdOw0KICAgICAgICAgIHdoaWxlIChkICYmIGQgIT09IGRvY3VtZW50ICYmICFkLmhvc3QpIHsNCiAgICAgICAgICAgIGQgPSBkLnBhcmVudE5vZGU7DQogICAgICAgICAgfQ0KICAgICAgICAgIHZhciB1ID0gZCAmJiAoZC5VUkwgfHwgZC5fVVJMIHx8IChkLmhvc3QgJiYgZC5ob3N0LmxvY2FsTmFtZSkpIHx8ICcnOw0KICAgICAgICAgIHUgPSB1LnNwbGl0KCcvPycpLnNoaWZ0KCkuc3BsaXQoJy8nKS5wb3AoKTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICBjb25zb2xlLmdyb3VwKCdtdXRhdGlvbnMgKCVkKSBbJXNdJywgbXV0YXRpb25zLmxlbmd0aCwgdSB8fCAnJyk7DQogIH0NCiAgLy8NCiAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24obXgpIHsNCiAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCdtdXRhdGlvbicpOw0KICAgIGlmIChteC50eXBlID09PSAnY2hpbGRMaXN0Jykgew0KICAgICAgZm9yRWFjaChteC5hZGRlZE5vZGVzLCBmdW5jdGlvbihuKSB7DQogICAgICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKG4ubG9jYWxOYW1lKTsNCiAgICAgICAgaWYgKGZpbHRlcihuKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICAvLyBub2RlcyBhZGRlZCBtYXkgbmVlZCBsaWZlY3ljbGUgbWFuYWdlbWVudA0KICAgICAgICBhZGRlZE5vZGUobik7DQogICAgICB9KTsNCiAgICAgIC8vIHJlbW92ZWQgbm9kZXMgbWF5IG5lZWQgbGlmZWN5Y2xlIG1hbmFnZW1lbnQNCiAgICAgIGZvckVhY2gobXgucmVtb3ZlZE5vZGVzLCBmdW5jdGlvbihuKSB7DQogICAgICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKG4ubG9jYWxOYW1lKTsNCiAgICAgICAgaWYgKGZpbHRlcihuKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICByZW1vdmVkTm9kZShuKTsNCiAgICAgIH0pOw0KICAgIH0NCiAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQogIH0pOw0KICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOw0KfTsNCg0KdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoaGFuZGxlcik7DQoNCmZ1bmN0aW9uIHRha2VSZWNvcmRzKCkgew0KICAvLyBUT0RPKHNqbWlsZXMpOiBhc2sgUmFmIHdoeSB3ZSBoYXZlIHRvIGNhbGwgaGFuZGxlciBvdXJzZWx2ZXMNCiAgaGFuZGxlcihvYnNlcnZlci50YWtlUmVjb3JkcygpKTsNCiAgdGFrZU11dGF0aW9ucygpOw0KfQ0KDQp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7DQoNCmZ1bmN0aW9uIG9ic2VydmUoaW5Sb290KSB7DQogIG9ic2VydmVyLm9ic2VydmUoaW5Sb290LCB7Y2hpbGRMaXN0OiB0cnVlLCBzdWJ0cmVlOiB0cnVlfSk7DQp9DQoNCmZ1bmN0aW9uIG9ic2VydmVEb2N1bWVudChkb2N1bWVudCkgew0KICBvYnNlcnZlKGRvY3VtZW50KTsNCn0NCg0KZnVuY3Rpb24gdXBncmFkZURvY3VtZW50KGRvY3VtZW50KSB7DQogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCd1cGdyYWRlRG9jdW1lbnQ6ICcsIChkb2N1bWVudC5VUkwgfHwgZG9jdW1lbnQuX1VSTCB8fCAnJykuc3BsaXQoJy8nKS5wb3AoKSk7DQogIGFkZGVkTm9kZShkb2N1bWVudCk7DQogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQp9DQoNCi8vIGV4cG9ydHMNCg0Kc2NvcGUud2F0Y2hTaGFkb3cgPSB3YXRjaFNoYWRvdzsNCnNjb3BlLnVwZ3JhZGVBbGwgPSBhZGRlZE5vZGU7DQpzY29wZS51cGdyYWRlU3VidHJlZSA9IGFkZGVkU3VidHJlZTsNCg0Kc2NvcGUub2JzZXJ2ZURvY3VtZW50ID0gb2JzZXJ2ZURvY3VtZW50Ow0Kc2NvcGUudXBncmFkZURvY3VtZW50ID0gdXBncmFkZURvY3VtZW50Ow0KDQpzY29wZS50YWtlUmVjb3JkcyA9IHRha2VSZWNvcmRzOw0KDQp9KSh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpOw0KCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oc2NvcGUpIHsKCmlmICghc2NvcGUpIHsKICBzY29wZSA9IHdpbmRvdy5IVE1MSW1wb3J0cyA9IHtmbGFnczp7fX07Cn0KCi8vIGltcG9ydHMKCnZhciB4aHIgPSBzY29wZS54aHI7CgovLyBpbXBvcnRlcgoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSAnaW1wb3J0JzsKdmFyIFNUWUxFX0xJTktfVFlQRSA9ICdzdHlsZXNoZWV0JzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IHJlcHJlc2VudHMgYSBwcmltYXJ5IGRvY3VtZW50ICh0aGUgYXJndW1lbnQgdG8gJ2xvYWQnKQovLyBhdCB0aGUgcm9vdCBvZiBhIHRyZWUgb2YgZG9jdW1lbnRzCgovLyBmb3IgYW55IGRvY3VtZW50LCBpbXBvcnRlcjoKLy8gLSBsb2FkcyBhbnkgbGlua2VkIGRvY3VtZW50cyAod2l0aCBkZWR1cGluZyksIG1vZGlmaWVzIHBhdGhzIGFuZCBmZWVkcyB0aGVtIGJhY2sgaW50byBpbXBvcnRlcgovLyAtIGxvYWRzIHRleHQgb2YgZXh0ZXJuYWwgc2NyaXB0IHRhZ3MKLy8gLSBsb2FkcyB0ZXh0IG9mIGV4dGVybmFsIHN0eWxlIHRhZ3MgaW5zaWRlIG9mIDxlbGVtZW50PiwgbW9kaWZpZXMgcGF0aHMKCi8vIHdoZW4gaW1wb3J0ZXIgJ21vZGlmaWVzIHBhdGhzJyBpbiBhIGRvY3VtZW50LCB0aGlzIGluY2x1ZGVzCi8vIC0gaHJlZi9zcmMvYWN0aW9uIGluIG5vZGUgYXR0cmlidXRlcwovLyAtIHBhdGhzIGluIGlubGluZSBzdHlsZXNoZWV0cwovLyAtIGFsbCBjb250ZW50IGluc2lkZSB0ZW1wbGF0ZXMKCi8vIGxpbmtlZCBzdHlsZSBzaGVldHMgaW4gYW4gaW1wb3J0IGhhdmUgdGhlaXIgb3duIHBhdGggZml4ZWQgdXAgd2hlbiB0aGVpciBjb250YWluaW5nIGltcG9ydCBtb2RpZmllcyBwYXRocwovLyBsaW5rZWQgc3R5bGUgc2hlZXRzIGluIGFuIDxlbGVtZW50PiBhcmUgbG9hZGVkLCBhbmQgdGhlIGNvbnRlbnQgZ2V0cyBwYXRoIGZpeHVwcwovLyBpbmxpbmUgc3R5bGUgc2hlZXRzIGdldCBwYXRoIGZpeHVwcyB3aGVuIHRoZWlyIGNvbnRhaW5pbmcgaW1wb3J0IG1vZGlmaWVzIHBhdGhzCgp2YXIgbG9hZGVyOwoKdmFyIGltcG9ydGVyID0gewogIGRvY3VtZW50czoge30sCiAgY2FjaGU6IHt9LAogIHByZWxvYWRTZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJywKICAgICdlbGVtZW50IGxpbmtbcmVsPScgKyBTVFlMRV9MSU5LX1RZUEUgKyAnXScsCiAgICAndGVtcGxhdGUnLAogICAgJ3NjcmlwdFtzcmNdOm5vdChbdHlwZV0pJywKICAgICdzY3JpcHRbc3JjXVt0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiXScKICBdLmpvaW4oJywnKSwKICBsb2FkZXI6IGZ1bmN0aW9uKG5leHQpIHsKICAgIC8vIGNvbnN0cnVjdCBhIGxvYWRlciBpbnN0YW5jZQogICAgbG9hZGVyID0gbmV3IExvYWRlcihpbXBvcnRlci5sb2FkZWQsIG5leHQpOwogICAgLy8gYWxpYXMgdGhlIGxvYWRlciBjYWNoZSAoZm9yIGRlYnVnZ2luZykKICAgIGxvYWRlci5jYWNoZSA9IGltcG9ydGVyLmNhY2hlOwogICAgcmV0dXJuIGxvYWRlcjsKICB9LAogIGxvYWQ6IGZ1bmN0aW9uKGRvYywgbmV4dCkgewogICAgLy8gY29uc3RydWN0IGEgbG9hZGVyIGluc3RhbmNlCiAgICBsb2FkZXIgPSBpbXBvcnRlci5sb2FkZXIobmV4dCk7CiAgICAvLyBhZGQgbm9kZXMgZnJvbSBkb2N1bWVudCBpbnRvIGxvYWRlciBxdWV1ZQogICAgaW1wb3J0ZXIucHJlbG9hZChkb2MpOwogIH0sCiAgcHJlbG9hZDogZnVuY3Rpb24oZG9jKSB7CiAgICAvLyBhbGwgcHJlbG9hZGFibGUgbm9kZXMgaW4gaW5Eb2N1bWVudAogICAgdmFyIG5vZGVzID0gZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoaW1wb3J0ZXIucHJlbG9hZFNlbGVjdG9ycyk7CiAgICAvLyBmcm9tIHRoZSBtYWluIGRvY3VtZW50LCBvbmx5IGxvYWQgaW1wb3J0cwogICAgLy8gVE9ETyhzam1pbGVzKTogZG8gdGhpcyBieSBhbHRlcmluZyB0aGUgc2VsZWN0b3IgbGlzdCBpbnN0ZWFkCiAgICBub2RlcyA9IHRoaXMuZmlsdGVyTWFpbkRvY3VtZW50Tm9kZXMoZG9jLCBub2Rlcyk7CiAgICAvLyBleHRyYSBsaW5rIG5vZGVzIGZyb20gdGVtcGxhdGVzLCBmaWx0ZXIgdGVtcGxhdGVzIG91dCBvZiB0aGUgbm9kZXMgbGlzdAogICAgbm9kZXMgPSB0aGlzLmV4dHJhY3RUZW1wbGF0ZU5vZGVzKG5vZGVzKTsKICAgIC8vIGFkZCB0aGVzZSBub2RlcyB0byBsb2FkZXIncyBxdWV1ZQogICAgbG9hZGVyLmFkZE5vZGVzKG5vZGVzKTsKICB9LAogIGZpbHRlck1haW5Eb2N1bWVudE5vZGVzOiBmdW5jdGlvbihkb2MsIG5vZGVzKSB7CiAgICBpZiAoZG9jID09PSBkb2N1bWVudCkgewogICAgICBub2RlcyA9IEFycmF5LnByb3RvdHlwZS5maWx0ZXIuY2FsbChub2RlcywgZnVuY3Rpb24obikgewogICAgICAgIHJldHVybiAhaXNTY3JpcHQobik7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG5vZGVzOwogIH0sCiAgZXh0cmFjdFRlbXBsYXRlTm9kZXM6IGZ1bmN0aW9uKG5vZGVzKSB7CiAgICB2YXIgZXh0cmEgPSBbXTsKICAgIG5vZGVzID0gQXJyYXkucHJvdG90eXBlLmZpbHRlci5jYWxsKG5vZGVzLCBmdW5jdGlvbihuKSB7CiAgICAgIGlmIChuLmxvY2FsTmFtZSA9PT0gJ3RlbXBsYXRlJykgewogICAgICAgIGlmIChuLmNvbnRlbnQpIHsKICAgICAgICAgIHZhciBsJCA9IG4uY29udGVudC5xdWVyeVNlbGVjdG9yQWxsKCdsaW5rW3JlbD0nICsgU1RZTEVfTElOS19UWVBFICsKICAgICAgICAgICAgJ10nKTsKICAgICAgICAgIGlmIChsJC5sZW5ndGgpIHsKICAgICAgICAgICAgZXh0cmEgPSBleHRyYS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwobCQsIDApKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSk7CiAgICBpZiAoZXh0cmEubGVuZ3RoKSB7CiAgICAgIG5vZGVzID0gbm9kZXMuY29uY2F0KGV4dHJhKTsKICAgIH0KICAgIHJldHVybiBub2RlczsKICB9LAogIGxvYWRlZDogZnVuY3Rpb24odXJsLCBlbHQsIHJlc291cmNlKSB7CiAgICBpZiAoaXNEb2N1bWVudExpbmsoZWx0KSkgewogICAgICB2YXIgZG9jdW1lbnQgPSBpbXBvcnRlci5kb2N1bWVudHNbdXJsXTsKICAgICAgLy8gaWYgd2UndmUgbmV2ZXIgc2VlbiBhIGRvY3VtZW50IGF0IHRoaXMgdXJsCiAgICAgIGlmICghZG9jdW1lbnQpIHsKICAgICAgICAvLyBnZW5lcmF0ZSBhbiBIVE1MRG9jdW1lbnQgZnJvbSBkYXRhCiAgICAgICAgZG9jdW1lbnQgPSBtYWtlRG9jdW1lbnQocmVzb3VyY2UsIHVybCk7CiAgICAgICAgLy8gcmVzb2x2ZSByZXNvdXJjZSBwYXRocyByZWxhdGl2ZSB0byBob3N0IGRvY3VtZW50CiAgICAgICAgcGF0aC5yZXNvbHZlUGF0aHNJbkhUTUwoZG9jdW1lbnQpOwogICAgICAgIC8vIGNhY2hlIGRvY3VtZW50CiAgICAgICAgaW1wb3J0ZXIuZG9jdW1lbnRzW3VybF0gPSBkb2N1bWVudDsKICAgICAgICAvLyBhZGQgbm9kZXMgZnJvbSB0aGlzIGRvY3VtZW50IHRvIHRoZSBsb2FkZXIgcXVldWUKICAgICAgICBpbXBvcnRlci5wcmVsb2FkKGRvY3VtZW50KTsKICAgICAgfQogICAgICAvLyBzdG9yZSBpbXBvcnQgcmVjb3JkCiAgICAgIGVsdC5pbXBvcnQgPSB7CiAgICAgICAgaHJlZjogdXJsLAogICAgICAgIG93bmVyTm9kZTogZWx0LAogICAgICAgIGNvbnRlbnQ6IGRvY3VtZW50CiAgICAgIH07CiAgICAgIC8vIHN0b3JlIGRvY3VtZW50IHJlc291cmNlCiAgICAgIGVsdC5jb250ZW50ID0gcmVzb3VyY2UgPSBkb2N1bWVudDsKICAgIH0KICAgIC8vIHN0b3JlIGdlbmVyaWMgcmVzb3VyY2UKICAgIC8vIFRPRE8oc29ydmVsbCk6IGZhaWxzIGZvciBub2RlcyBpbnNpZGUgPHRlbXBsYXRlPi5jb250ZW50CiAgICAvLyBzZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTI0OTM4MS4KICAgIGVsdC5fX3Jlc291cmNlID0gcmVzb3VyY2U7CiAgICAvLyBjc3MgcGF0aCBmaXh1cHMKICAgIGlmIChpc1N0eWxlc2hlZXRMaW5rKGVsdCkpIHsKICAgICAgcGF0aC5yZXNvbHZlUGF0aHNJblN0eWxlc2hlZXQoZWx0KTsKICAgIH0KICB9Cn07CgpmdW5jdGlvbiBpc0RvY3VtZW50TGluayhlbHQpIHsKICByZXR1cm4gaXNMaW5rUmVsKGVsdCwgSU1QT1JUX0xJTktfVFlQRSk7Cn0KCmZ1bmN0aW9uIGlzU3R5bGVzaGVldExpbmsoZWx0KSB7CiAgcmV0dXJuIGlzTGlua1JlbChlbHQsIFNUWUxFX0xJTktfVFlQRSk7Cn0KCmZ1bmN0aW9uIGlzTGlua1JlbChlbHQsIHJlbCkgewogIHJldHVybiBlbHQubG9jYWxOYW1lID09PSAnbGluaycgJiYgZWx0LmdldEF0dHJpYnV0ZSgncmVsJykgPT09IHJlbDsKfQoKZnVuY3Rpb24gaXNTY3JpcHQoZWx0KSB7CiAgcmV0dXJuIGVsdC5sb2NhbE5hbWUgPT09ICdzY3JpcHQnOwp9CgpmdW5jdGlvbiBtYWtlRG9jdW1lbnQocmVzb3VyY2UsIHVybCkgewogIC8vIGNyZWF0ZSBhIG5ldyBIVE1MIGRvY3VtZW50CiAgdmFyIGRvYyA9IHJlc291cmNlOwogIGlmICghKGRvYyBpbnN0YW5jZW9mIERvY3VtZW50KSkgewogICAgZG9jID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KElNUE9SVF9MSU5LX1RZUEUpOwogICAgLy8gaW5zdGFsbCBodG1sCiAgICBkb2MuYm9keS5pbm5lckhUTUwgPSByZXNvdXJjZTsKICB9CiAgLy8gY2FjaGUgdGhlIG5ldyBkb2N1bWVudCdzIHNvdXJjZSB1cmwKICBkb2MuX1VSTCA9IHVybDsKICAvLyBlc3RhYmxpc2ggYSByZWxhdGl2ZSBwYXRoIHZpYSA8YmFzZT4KICB2YXIgYmFzZSA9IGRvYy5jcmVhdGVFbGVtZW50KCdiYXNlJyk7CiAgYmFzZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBkb2N1bWVudC5iYXNlVVJJIHx8IGRvY3VtZW50LlVSTCk7CiAgZG9jLmhlYWQuYXBwZW5kQ2hpbGQoYmFzZSk7CiAgLy8gVE9ETyhzb3J2ZWxsKTogaWRlYWxseSB0aGlzIGNvZGUgaXMgbm90IGF3YXJlIG9mIFRlbXBsYXRlIHBvbHlmaWxsLAogIC8vIGJ1dCBmb3Igbm93IHRoZSBwb2x5ZmlsbCBuZWVkcyBoZWxwIHRvIGJvb3RzdHJhcCB0aGVzZSB0ZW1wbGF0ZXMKICBpZiAod2luZG93LkhUTUxUZW1wbGF0ZUVsZW1lbnQgJiYgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXApIHsKICAgIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKGRvYyk7CiAgfQogIHJldHVybiBkb2M7Cn0KCnZhciBMb2FkZXIgPSBmdW5jdGlvbihvbkxvYWQsIG9uQ29tcGxldGUpIHsKICB0aGlzLm9ubG9hZCA9IG9uTG9hZDsKICB0aGlzLm9uY29tcGxldGUgPSBvbkNvbXBsZXRlOwogIHRoaXMuaW5mbGlnaHQgPSAwOwogIHRoaXMucGVuZGluZyA9IHt9OwogIHRoaXMuY2FjaGUgPSB7fTsKfTsKCkxvYWRlci5wcm90b3R5cGUgPSB7CiAgYWRkTm9kZXM6IGZ1bmN0aW9uKG5vZGVzKSB7CiAgICAvLyBudW1iZXIgb2YgdHJhbnNhY3Rpb25zIHRvIGNvbXBsZXRlCiAgICB0aGlzLmluZmxpZ2h0ICs9IG5vZGVzLmxlbmd0aDsKICAgIC8vIGNvbW1lbmNlIHRyYW5zYWN0aW9ucwogICAgZm9yRWFjaChub2RlcywgdGhpcy5yZXF1aXJlLCB0aGlzKTsKICAgIC8vIGFueXRoaW5nIHRvIGRvPwogICAgdGhpcy5jaGVja0RvbmUoKTsKICB9LAogIHJlcXVpcmU6IGZ1bmN0aW9uKGVsdCkgewogICAgdmFyIHVybCA9IHBhdGgubm9kZVVybChlbHQpOwogICAgLy8gVE9ETyhzam1pbGVzKTogYWQtaG9jCiAgICBlbHQuX19ub2RlVXJsID0gdXJsOwogICAgLy8gZGVkdXBsaWNhdGlvbgogICAgaWYgKCF0aGlzLmRlZHVwZSh1cmwsIGVsdCkpIHsKICAgICAgLy8gZmV0Y2ggdGhpcyByZXNvdXJjZQogICAgICB0aGlzLmZldGNoKHVybCwgZWx0KTsKICAgIH0KICB9LAogIGRlZHVwZTogZnVuY3Rpb24odXJsLCBlbHQpIHsKICAgIGlmICh0aGlzLnBlbmRpbmdbdXJsXSkgewogICAgICAvLyBhZGQgdG8gbGlzdCBvZiBub2RlcyB3YWl0aW5nIGZvciBpblVybAogICAgICB0aGlzLnBlbmRpbmdbdXJsXS5wdXNoKGVsdCk7CiAgICAgIC8vIGRvbid0IG5lZWQgZmV0Y2gKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAodGhpcy5jYWNoZVt1cmxdKSB7CiAgICAgIC8vIGNvbXBsZXRlIGxvYWQgdXNpbmcgY2FjaGUgZGF0YQogICAgICB0aGlzLm9ubG9hZCh1cmwsIGVsdCwgbG9hZGVyLmNhY2hlW3VybF0pOwogICAgICAvLyBmaW5pc2hlZCB0aGlzIHRyYW5zYWN0aW9uCiAgICAgIHRoaXMudGFpbCgpOwogICAgICAvLyBkb24ndCBuZWVkIGZldGNoCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gZmlyc3Qgbm9kZSB3YWl0aW5nIGZvciBpblVybAogICAgdGhpcy5wZW5kaW5nW3VybF0gPSBbZWx0XTsKICAgIC8vIG5lZWQgZmV0Y2ggKG5vdCBhIGR1cGUpCiAgICByZXR1cm4gZmFsc2U7CiAgfSwKICBmZXRjaDogZnVuY3Rpb24odXJsLCBlbHQpIHsKICAgIHZhciByZWNlaXZlWGhyID0gZnVuY3Rpb24oZXJyLCByZXNvdXJjZSkgewogICAgICB0aGlzLnJlY2VpdmUodXJsLCBlbHQsIGVyciwgcmVzb3VyY2UpOwogICAgfS5iaW5kKHRoaXMpOwogICAgeGhyLmxvYWQodXJsLCByZWNlaXZlWGhyKTsKICAgIC8vIFRPRE8oc29ydmVsbCk6IGJsb2NrZWQgb24KICAgIC8vIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD0yNTcyMjEKICAgIC8vIHhocidpbmcgZm9yIGEgZG9jdW1lbnQgbWFrZXMgc2NyaXB0cyBpbiBpbXBvcnRzIHJ1bm5hYmxlOyBvdGhlcndpc2UKICAgIC8vIHRoZXkgYXJlIG5vdDsgaG93ZXZlciwgaXQgcmVxdWlyZXMgdGhhdCB3ZSBoYXZlIGRvY3R5cGU9aHRtbCBpbgogICAgLy8gdGhlIGltcG9ydCB3aGljaCBpcyB1bmFjY2VwdGFibGUuIFRoaXMgaXMgb25seSBuZWVkZWQgb24gQ2hyb21lCiAgICAvLyB0byBhdm9pZCB0aGUgYnVnIGFib3ZlLgogICAgLyoKICAgIGlmIChpc0RvY3VtZW50TGluayhlbHQpKSB7CiAgICAgIHhoci5sb2FkRG9jdW1lbnQodXJsLCByZWNlaXZlWGhyKTsKICAgIH0gZWxzZSB7CiAgICAgIHhoci5sb2FkKHVybCwgcmVjZWl2ZVhocik7CiAgICB9CiAgICAqLwogIH0sCiAgcmVjZWl2ZTogZnVuY3Rpb24odXJsLCBlbHQsIGVyciwgcmVzb3VyY2UpIHsKICAgIGlmICghZXJyKSB7CiAgICAgIGxvYWRlci5jYWNoZVt1cmxdID0gcmVzb3VyY2U7CiAgICB9CiAgICBsb2FkZXIucGVuZGluZ1t1cmxdLmZvckVhY2goZnVuY3Rpb24oZSkgewogICAgICBpZiAoIWVycikgewogICAgICAgIHRoaXMub25sb2FkKHVybCwgZSwgcmVzb3VyY2UpOwogICAgICB9CiAgICAgIHRoaXMudGFpbCgpOwogICAgfSwgdGhpcyk7CiAgICBsb2FkZXIucGVuZGluZ1t1cmxdID0gbnVsbDsKICB9LAogIHRhaWw6IGZ1bmN0aW9uKCkgewogICAgLS10aGlzLmluZmxpZ2h0OwogICAgdGhpcy5jaGVja0RvbmUoKTsKICB9LAogIGNoZWNrRG9uZTogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuaW5mbGlnaHQpIHsKICAgICAgdGhpcy5vbmNvbXBsZXRlKCk7CiAgICB9CiAgfQp9OwoKdmFyIFVSTF9BVFRSUyA9IFsnaHJlZicsICdzcmMnLCAnYWN0aW9uJ107CnZhciBVUkxfQVRUUlNfU0VMRUNUT1IgPSAnWycgKyBVUkxfQVRUUlMuam9pbignXSxbJykgKyAnXSc7CnZhciBVUkxfVEVNUExBVEVfU0VBUkNIID0gJ3t7Lip9fSc7Cgp2YXIgcGF0aCA9IHsKICBub2RlVXJsOiBmdW5jdGlvbihub2RlKSB7CiAgICByZXR1cm4gcGF0aC5yZXNvbHZlVXJsKHBhdGguZG9jdW1lbnRVUkwsIHBhdGguaHJlZk9yU3JjKG5vZGUpKTsKICB9LAogIGhyZWZPclNyYzogZnVuY3Rpb24obm9kZSkgewogICAgcmV0dXJuIG5vZGUuZ2V0QXR0cmlidXRlKCJocmVmIikgfHwgbm9kZS5nZXRBdHRyaWJ1dGUoInNyYyIpOwogIH0sCiAgZG9jdW1lbnRVcmxGcm9tTm9kZTogZnVuY3Rpb24obm9kZSkgewogICAgcmV0dXJuIHBhdGguZ2V0RG9jdW1lbnRVcmwobm9kZS5vd25lckRvY3VtZW50IHx8IG5vZGUpOwogIH0sCiAgZ2V0RG9jdW1lbnRVcmw6IGZ1bmN0aW9uKGRvYykgewogICAgdmFyIHVybCA9IGRvYyAmJgogICAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTVBvbHlmaWxsIGludHJ1c2lvbgogICAgICAgIChkb2MuX1VSTCB8fCAoZG9jLmltcGwgJiYgZG9jLmltcGwuX1VSTCkKICAgICAgICAgICAgfHwgZG9jLmJhc2VVUkkgfHwgZG9jLlVSTCkKICAgICAgICAgICAgICAgIHx8ICcnOwogICAgLy8gdGFrZSBvbmx5IHRoZSBsZWZ0IHNpZGUgaWYgdGhlcmUgaXMgYSAjCiAgICByZXR1cm4gdXJsLnNwbGl0KCcjJylbMF07CiAgfSwKICByZXNvbHZlVXJsOiBmdW5jdGlvbihiYXNlVXJsLCB1cmwpIHsKICAgIGlmICh0aGlzLmlzQWJzVXJsKHVybCkpIHsKICAgICAgcmV0dXJuIHVybDsKICAgIH0KICAgIHJldHVybiB0aGlzLmNvbXByZXNzVXJsKHRoaXMudXJsVG9QYXRoKGJhc2VVcmwpICsgdXJsKTsKICB9LAogIHJlc29sdmVSZWxhdGl2ZVVybDogZnVuY3Rpb24oYmFzZVVybCwgdXJsKSB7CiAgICBpZiAodGhpcy5pc0Fic1VybCh1cmwpKSB7CiAgICAgIHJldHVybiB1cmw7CiAgICB9CiAgICByZXR1cm4gdGhpcy5tYWtlRG9jdW1lbnRSZWxQYXRoKHRoaXMucmVzb2x2ZVVybChiYXNlVXJsLCB1cmwpKTsKICB9LAogIGlzQWJzVXJsOiBmdW5jdGlvbih1cmwpIHsKICAgIHJldHVybiAvKF5kYXRhOil8KF5odHRwW3NdPzopfCheXC8pLy50ZXN0KHVybCk7CiAgfSwKICB1cmxUb1BhdGg6IGZ1bmN0aW9uKGJhc2VVcmwpIHsKICAgIHZhciBwYXJ0cyA9IGJhc2VVcmwuc3BsaXQoIi8iKTsKICAgIHBhcnRzLnBvcCgpOwogICAgcGFydHMucHVzaCgnJyk7CiAgICByZXR1cm4gcGFydHMuam9pbigiLyIpOwogIH0sCiAgY29tcHJlc3NVcmw6IGZ1bmN0aW9uKHVybCkgewogICAgdmFyIHNlYXJjaCA9ICcnOwogICAgdmFyIHNlYXJjaFBvcyA9IHVybC5pbmRleE9mKCc/Jyk7CiAgICAvLyBxdWVyeSBzdHJpbmcgaXMgbm90IHBhcnQgb2YgdGhlIHBhdGgKICAgIGlmIChzZWFyY2hQb3MgPiAtMSkgewogICAgICBzZWFyY2ggPSB1cmwuc3Vic3RyaW5nKHNlYXJjaFBvcyk7CiAgICAgIHVybCA9IHVybC5zdWJzdHJpbmcoc2VhcmNoUG9zLCAwKTsKICAgIH0KICAgIHZhciBwYXJ0cyA9IHVybC5zcGxpdCgnLycpOwogICAgZm9yICh2YXIgaT0wLCBwOyBpPHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHAgPSBwYXJ0c1tpXTsKICAgICAgaWYgKHAgPT09ICcuLicpIHsKICAgICAgICBwYXJ0cy5zcGxpY2UoaS0xLCAyKTsKICAgICAgICBpIC09IDI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwYXJ0cy5qb2luKCcvJykgKyBzZWFyY2g7CiAgfSwKICBtYWtlRG9jdW1lbnRSZWxQYXRoOiBmdW5jdGlvbih1cmwpIHsKICAgIC8vIHRlc3QgdXJsIGFnYWluc3QgZG9jdW1lbnQgdG8gc2VlIGlmIHdlIGNhbiBjb25zdHJ1Y3QgYSByZWxhdGl2ZSBwYXRoCiAgICBwYXRoLnVybEVsdC5ocmVmID0gdXJsOwogICAgLy8gSUUgZG9lcyBub3Qgc2V0IGhvc3QgaWYgc2FtZSBhcyBkb2N1bWVudAogICAgaWYgKCFwYXRoLnVybEVsdC5ob3N0IHx8IAogICAgICAgIChwYXRoLnVybEVsdC5ob3N0ID09PSB3aW5kb3cubG9jYXRpb24uaG9zdCAmJgogICAgICAgIHBhdGgudXJsRWx0LnByb3RvY29sID09PSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wpKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VSZWxQYXRoKHBhdGguZG9jdW1lbnRVUkwsIHBhdGgudXJsRWx0LmhyZWYpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHVybDsKICAgIH0KICB9LAogIC8vIG1ha2UgYSByZWxhdGl2ZSBwYXRoIGZyb20gc291cmNlIHRvIHRhcmdldAogIG1ha2VSZWxQYXRoOiBmdW5jdGlvbihzb3VyY2UsIHRhcmdldCkgewogICAgdmFyIHMgPSBzb3VyY2Uuc3BsaXQoJy8nKTsKICAgIHZhciB0ID0gdGFyZ2V0LnNwbGl0KCcvJyk7CiAgICB3aGlsZSAocy5sZW5ndGggJiYgc1swXSA9PT0gdFswXSl7CiAgICAgIHMuc2hpZnQoKTsKICAgICAgdC5zaGlmdCgpOwogICAgfQogICAgZm9yKHZhciBpID0gMCwgbCA9IHMubGVuZ3RoLTE7IGkgPCBsOyBpKyspIHsKICAgICAgdC51bnNoaWZ0KCcuLicpOwogICAgfQogICAgdmFyIHIgPSB0LmpvaW4oJy8nKTsKICAgIHJldHVybiByOwogIH0sCiAgcmVzb2x2ZVBhdGhzSW5IVE1MOiBmdW5jdGlvbihyb290LCB1cmwpIHsKICAgIHVybCA9IHVybCB8fCBwYXRoLmRvY3VtZW50VXJsRnJvbU5vZGUocm9vdCkKICAgIHBhdGgucmVzb2x2ZUF0dHJpYnV0ZXMocm9vdCwgdXJsKTsKICAgIHBhdGgucmVzb2x2ZVN0eWxlRWx0cyhyb290LCB1cmwpOwogICAgLy8gaGFuZGxlIHRlbXBsYXRlLmNvbnRlbnQKICAgIHZhciB0ZW1wbGF0ZXMgPSByb290LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RlbXBsYXRlJyk7CiAgICBpZiAodGVtcGxhdGVzKSB7CiAgICAgIGZvckVhY2godGVtcGxhdGVzLCBmdW5jdGlvbih0KSB7CiAgICAgICAgaWYgKHQuY29udGVudCkgewogICAgICAgICAgcGF0aC5yZXNvbHZlUGF0aHNJbkhUTUwodC5jb250ZW50LCB1cmwpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwKICByZXNvbHZlUGF0aHNJblN0eWxlc2hlZXQ6IGZ1bmN0aW9uKHNoZWV0KSB7CiAgICB2YXIgZG9jVXJsID0gcGF0aC5ub2RlVXJsKHNoZWV0KTsKICAgIHNoZWV0Ll9fcmVzb3VyY2UgPSBwYXRoLnJlc29sdmVDc3NUZXh0KHNoZWV0Ll9fcmVzb3VyY2UsIGRvY1VybCk7CiAgfSwKICByZXNvbHZlU3R5bGVFbHRzOiBmdW5jdGlvbihyb290LCB1cmwpIHsKICAgIHZhciBzdHlsZXMgPSByb290LnF1ZXJ5U2VsZWN0b3JBbGwoJ3N0eWxlJyk7CiAgICBpZiAoc3R5bGVzKSB7CiAgICAgIGZvckVhY2goc3R5bGVzLCBmdW5jdGlvbihzdHlsZSkgewogICAgICAgIHN0eWxlLnRleHRDb250ZW50ID0gcGF0aC5yZXNvbHZlQ3NzVGV4dChzdHlsZS50ZXh0Q29udGVudCwgdXJsKTsKICAgICAgfSk7CiAgICB9CiAgfSwKICByZXNvbHZlQ3NzVGV4dDogZnVuY3Rpb24oY3NzVGV4dCwgYmFzZVVybCkgewogICAgcmV0dXJuIGNzc1RleHQucmVwbGFjZSgvdXJsXChbXildKlwpL2csIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgIC8vIGZpbmQgdGhlIHVybCBwYXRoLCBpZ25vcmUgcXVvdGVzIGluIHVybCBzdHJpbmcKICAgICAgdmFyIHVybFBhdGggPSBtYXRjaC5yZXBsYWNlKC9bIiddL2csICIiKS5zbGljZSg0LCAtMSk7CiAgICAgIHVybFBhdGggPSBwYXRoLnJlc29sdmVSZWxhdGl2ZVVybChiYXNlVXJsLCB1cmxQYXRoKTsKICAgICAgcmV0dXJuICJ1cmwoIiArIHVybFBhdGggKyAiKSI7CiAgICB9KTsKICB9LAogIHJlc29sdmVBdHRyaWJ1dGVzOiBmdW5jdGlvbihyb290LCB1cmwpIHsKICAgIC8vIHNlYXJjaCBmb3IgYXR0cmlidXRlcyB0aGF0IGhvc3QgdXJscwogICAgdmFyIG5vZGVzID0gcm9vdCAmJiByb290LnF1ZXJ5U2VsZWN0b3JBbGwoVVJMX0FUVFJTX1NFTEVDVE9SKTsKICAgIGlmIChub2RlcykgewogICAgICBmb3JFYWNoKG5vZGVzLCBmdW5jdGlvbihuKSB7CiAgICAgICAgdGhpcy5yZXNvbHZlTm9kZUF0dHJpYnV0ZXMobiwgdXJsKTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSwKICByZXNvbHZlTm9kZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKG5vZGUsIHVybCkgewogICAgVVJMX0FUVFJTLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICB2YXIgYXR0ciA9IG5vZGUuYXR0cmlidXRlc1t2XTsKICAgICAgaWYgKGF0dHIgJiYgYXR0ci52YWx1ZSAmJgogICAgICAgICAoYXR0ci52YWx1ZS5zZWFyY2goVVJMX1RFTVBMQVRFX1NFQVJDSCkgPCAwKSkgewogICAgICAgIHZhciB1cmxQYXRoID0gcGF0aC5yZXNvbHZlUmVsYXRpdmVVcmwodXJsLCBhdHRyLnZhbHVlKTsKICAgICAgICBhdHRyLnZhbHVlID0gdXJsUGF0aDsKICAgICAgfQogICAgfSk7CiAgfQp9OwoKcGF0aC5kb2N1bWVudFVSTCA9IHBhdGguZ2V0RG9jdW1lbnRVcmwoZG9jdW1lbnQpOwpwYXRoLnVybEVsdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKCnhociA9IHhociB8fCB7CiAgYXN5bmM6IHRydWUsCiAgb2s6IGZ1bmN0aW9uKHJlcXVlc3QpIHsKICAgIHJldHVybiAocmVxdWVzdC5zdGF0dXMgPj0gMjAwICYmIHJlcXVlc3Quc3RhdHVzIDwgMzAwKQogICAgICAgIHx8IChyZXF1ZXN0LnN0YXR1cyA9PT0gMzA0KQogICAgICAgIHx8IChyZXF1ZXN0LnN0YXR1cyA9PT0gMCk7CiAgfSwKICBsb2FkOiBmdW5jdGlvbih1cmwsIG5leHQsIG5leHRDb250ZXh0KSB7CiAgICB2YXIgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgaWYgKHNjb3BlLmZsYWdzLmRlYnVnIHx8IHNjb3BlLmZsYWdzLmJ1c3QpIHsKICAgICAgdXJsICs9ICc/JyArIE1hdGgucmFuZG9tKCk7CiAgICB9CiAgICByZXF1ZXN0Lm9wZW4oJ0dFVCcsIHVybCwgeGhyLmFzeW5jKTsKICAgIHJlcXVlc3QuYWRkRXZlbnRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKHJlcXVlc3QucmVhZHlTdGF0ZSA9PT0gNCkgewogICAgICAgIG5leHQuY2FsbChuZXh0Q29udGV4dCwgIXhoci5vayhyZXF1ZXN0KSAmJiByZXF1ZXN0LAogICAgICAgICAgcmVxdWVzdC5yZXNwb25zZSwgdXJsKTsKICAgICAgfQogICAgfSk7CiAgICByZXF1ZXN0LnNlbmQoKTsKICAgIHJldHVybiByZXF1ZXN0OwogIH0sCiAgbG9hZERvY3VtZW50OiBmdW5jdGlvbih1cmwsIG5leHQsIG5leHRDb250ZXh0KSB7CiAgICB0aGlzLmxvYWQodXJsLCBuZXh0LCBuZXh0Q29udGV4dCkucmVzcG9uc2VUeXBlID0gJ2RvY3VtZW50JzsKICB9Cn07Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgovLyBleHBvcnRzCgpzY29wZS5wYXRoID0gcGF0aDsKc2NvcGUueGhyID0geGhyOwpzY29wZS5pbXBvcnRlciA9IGltcG9ydGVyOwpzY29wZS5nZXREb2N1bWVudFVybCA9IHBhdGguZ2V0RG9jdW1lbnRVcmw7CnNjb3BlLklNUE9SVF9MSU5LX1RZUEUgPSBJTVBPUlRfTElOS19UWVBFOwoKfSkod2luZG93LkhUTUxJbXBvcnRzKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oc2NvcGUpIHsKCnZhciBJTVBPUlRfTElOS19UWVBFID0gJ2ltcG9ydCc7CgovLyBoaWdobGFuZGVyIG9iamVjdCBmb3IgcGFyc2luZyBhIGRvY3VtZW50IHRyZWUKCnZhciBpbXBvcnRQYXJzZXIgPSB7CiAgc2VsZWN0b3JzOiBbCiAgICAnbGlua1tyZWw9JyArIElNUE9SVF9MSU5LX1RZUEUgKyAnXScsCiAgICAnbGlua1tyZWw9c3R5bGVzaGVldF0nLAogICAgJ3N0eWxlJywKICAgICdzY3JpcHQ6bm90KFt0eXBlXSknLAogICAgJ3NjcmlwdFt0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiXScKICBdLAogIG1hcDogewogICAgbGluazogJ3BhcnNlTGluaycsCiAgICBzY3JpcHQ6ICdwYXJzZVNjcmlwdCcsCiAgICBzdHlsZTogJ3BhcnNlR2VuZXJpYycKICB9LAogIHBhcnNlOiBmdW5jdGlvbihpbkRvY3VtZW50KSB7CiAgICBpZiAoIWluRG9jdW1lbnQuX19pbXBvcnRQYXJzZWQpIHsKICAgICAgLy8gb25seSBwYXJzZSBvbmNlCiAgICAgIGluRG9jdW1lbnQuX19pbXBvcnRQYXJzZWQgPSB0cnVlOwogICAgICAvLyBhbGwgcGFyc2FibGUgZWxlbWVudHMgaW4gaW5Eb2N1bWVudCAoZGVwdGgtZmlyc3QgcHJlLW9yZGVyIHRyYXZlcnNhbCkKICAgICAgdmFyIGVsdHMgPSBpbkRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoaW1wb3J0UGFyc2VyLnNlbGVjdG9ycyk7CiAgICAgIC8vIGZvciBlYWNoIHBhcnNhYmxlIG5vZGUgdHlwZSwgY2FsbCB0aGUgbWFwcGVkIHBhcnNpbmcgbWV0aG9kCiAgICAgIGZvckVhY2goZWx0cywgZnVuY3Rpb24oZSkgewogICAgICAgIGltcG9ydFBhcnNlcltpbXBvcnRQYXJzZXIubWFwW2UubG9jYWxOYW1lXV0oZSk7CiAgICAgIH0pOwogICAgfQogIH0sCiAgcGFyc2VMaW5rOiBmdW5jdGlvbihsaW5rRWx0KSB7CiAgICBpZiAoaXNEb2N1bWVudExpbmsobGlua0VsdCkpIHsKICAgICAgaWYgKGxpbmtFbHQuY29udGVudCkgewogICAgICAgIGltcG9ydFBhcnNlci5wYXJzZShsaW5rRWx0LmNvbnRlbnQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aGlzLnBhcnNlR2VuZXJpYyhsaW5rRWx0KTsKICAgIH0KICB9LAogIHBhcnNlR2VuZXJpYzogZnVuY3Rpb24oZWx0KSB7CiAgICBpZiAobmVlZHNNYWluRG9jdW1lbnRDb250ZXh0KGVsdCkpIHsKICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChlbHQpOwogICAgfQogIH0sCiAgcGFyc2VTY3JpcHQ6IGZ1bmN0aW9uKHNjcmlwdEVsdCkgewogICAgaWYgKG5lZWRzTWFpbkRvY3VtZW50Q29udGV4dChzY3JpcHRFbHQpKSB7CiAgICAgIC8vIGFjcXVpcmUgY29kZSB0byBleGVjdXRlCiAgICAgIHZhciBjb2RlID0gKHNjcmlwdEVsdC5fX3Jlc291cmNlIHx8IHNjcmlwdEVsdC50ZXh0Q29udGVudCkudHJpbSgpOwogICAgICBpZiAoY29kZSkgewogICAgICAgIC8vIGNhbGN1bGF0ZSBzb3VyY2UgbWFwIGhpbnQKICAgICAgICB2YXIgbW9uaWtlciA9IHNjcmlwdEVsdC5fX25vZGVVcmw7CiAgICAgICAgaWYgKCFtb25pa2VyKSB7CiAgICAgICAgICB2YXIgbW9uaWtlciA9IHNjb3BlLnBhdGguZG9jdW1lbnRVcmxGcm9tTm9kZShzY3JpcHRFbHQpOwogICAgICAgICAgLy8gdGhlcmUgY291bGQgYmUgbW9yZSB0aGFuIG9uZSBzY3JpcHQgdGhpcyB1cmwKICAgICAgICAgIHZhciB0YWcgPSAnWycgKyBNYXRoLmZsb29yKChNYXRoLnJhbmRvbSgpKzEpKjEwMDApICsgJ10nOwogICAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogUG9seW1lciBoYWNrLCBzaG91bGQgYmUgcGx1Z2dhYmxlIGlmIHdlIG5lZWQgdG8gYWxsb3cgCiAgICAgICAgICAvLyB0aGlzIHNvcnQgb2YgdGhpbmcKICAgICAgICAgIHZhciBtYXRjaGVzID0gY29kZS5tYXRjaCgvUG9seW1lclwoWyciXShbXiciXSopLyk7CiAgICAgICAgICB0YWcgPSBtYXRjaGVzICYmIG1hdGNoZXNbMV0gfHwgdGFnOwogICAgICAgICAgLy8gdGFnIHRoZSBtb25pa2VyCiAgICAgICAgICBtb25pa2VyICs9ICcvJyArIHRhZyArICcuanMnOwogICAgICAgIH0KICAgICAgICAvLyBzb3VyY2UgbWFwIGhpbnQKICAgICAgICBjb2RlICs9ICJcbi8vIyBzb3VyY2VVUkw9IiArIG1vbmlrZXIgKyAiXG4iOwogICAgICAgIC8vIGV2YWx1YXRlIHRoZSBjb2RlCiAgICAgICAgZXZhbC5jYWxsKHdpbmRvdywgY29kZSk7CiAgICAgIH0KICAgIH0KICB9Cn07Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgpmdW5jdGlvbiBpc0RvY3VtZW50TGluayhlbHQpIHsKICByZXR1cm4gZWx0LmxvY2FsTmFtZSA9PT0gJ2xpbmsnCiAgICAgICYmIGVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSBJTVBPUlRfTElOS19UWVBFOwp9CgpmdW5jdGlvbiBuZWVkc01haW5Eb2N1bWVudENvbnRleHQobm9kZSkgewogIC8vIG5vZGVzIGNhbiBiZSBtb3ZlZCB0byB0aGUgbWFpbiBkb2N1bWVudDoKICAvLyBpZiB0aGV5IGFyZSBpbiBhIHRyZWUgYnV0IG5vdCBpbiB0aGUgbWFpbiBkb2N1bWVudCBhbmQgbm90IGNoaWxkcmVuIG9mIDxlbGVtZW50PgogIHJldHVybiBub2RlLnBhcmVudE5vZGUgJiYgIWluTWFpbkRvY3VtZW50KG5vZGUpIAogICAgICAmJiAhaXNFbGVtZW50RWxlbWVudENoaWxkKG5vZGUpOwp9CgpmdW5jdGlvbiBpbk1haW5Eb2N1bWVudChlbHQpIHsKICByZXR1cm4gZWx0Lm93bmVyRG9jdW1lbnQgPT09IGRvY3VtZW50IHx8CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET01Qb2x5ZmlsbCBpbnRydXNpb24KICAgIGVsdC5vd25lckRvY3VtZW50LmltcGwgPT09IGRvY3VtZW50Owp9CgpmdW5jdGlvbiBpc0VsZW1lbnRFbGVtZW50Q2hpbGQoZWx0KSB7CiAgcmV0dXJuIGVsdC5wYXJlbnROb2RlICYmIGVsdC5wYXJlbnROb2RlLmxvY2FsTmFtZSA9PT0gJ2VsZW1lbnQnOwp9CgovLyBleHBvcnRzCgpzY29wZS5wYXJzZXIgPSBpbXBvcnRQYXJzZXI7Cgp9KShIVE1MSW1wb3J0cyk7Ci8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCihmdW5jdGlvbigpewoKLy8gYm9vdHN0cmFwCgovLyBJRSBzaGltIGZvciBDdXN0b21FdmVudAppZiAodHlwZW9mIHdpbmRvdy5DdXN0b21FdmVudCAhPT0gJ2Z1bmN0aW9uJykgewogIHdpbmRvdy5DdXN0b21FdmVudCA9IGZ1bmN0aW9uKGluVHlwZSkgewogICAgIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgICBlLmluaXRFdmVudChpblR5cGUsIHRydWUsIHRydWUpOwogICAgIHJldHVybiBlOwogIH07Cn0KCmZ1bmN0aW9uIGJvb3RzdHJhcCgpIHsKICAvLyBwcmVsb2FkIGRvY3VtZW50IHJlc291cmNlIHRyZWVzCiAgSFRNTEltcG9ydHMuaW1wb3J0ZXIubG9hZChkb2N1bWVudCwgZnVuY3Rpb24oKSB7CiAgICBIVE1MSW1wb3J0cy5wYXJzZXIucGFyc2UoZG9jdW1lbnQpOwogICAgSFRNTEltcG9ydHMucmVhZHlUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAvLyBzZW5kIEhUTUxJbXBvcnRzTG9hZGVkIHdoZW4gZmluaXNoZWQKICAgIGRvY3VtZW50LmRpc3BhdGNoRXZlbnQoCiAgICAgIG5ldyBDdXN0b21FdmVudCgnSFRNTEltcG9ydHNMb2FkZWQnLCB7YnViYmxlczogdHJ1ZX0pCiAgICApOwogIH0pOwp9OwoKaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScpIHsKICBib290c3RyYXAoKTsKfSBlbHNlIHsKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGJvb3RzdHJhcCk7Cn0KCn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKCkgewoKLy8gaW1wb3J0Cgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9IHdpbmRvdy5IVE1MSW1wb3J0cyA/IEhUTUxJbXBvcnRzLklNUE9SVF9MSU5LX1RZUEUgOiAnbm9uZSc7CgovLyBoaWdobGFuZGVyIG9iamVjdCBmb3IgcGFyc2luZyBhIGRvY3VtZW50IHRyZWUKCnZhciBwYXJzZXIgPSB7CiAgc2VsZWN0b3JzOiBbCiAgICAnbGlua1tyZWw9JyArIElNUE9SVF9MSU5LX1RZUEUgKyAnXScKICBdLAogIG1hcDogewogICAgbGluazogJ3BhcnNlTGluaycKICB9LAogIHBhcnNlOiBmdW5jdGlvbihpbkRvY3VtZW50KSB7CiAgICBpZiAoIWluRG9jdW1lbnQuX19wYXJzZWQpIHsKICAgICAgLy8gb25seSBwYXJzZSBvbmNlCiAgICAgIGluRG9jdW1lbnQuX19wYXJzZWQgPSB0cnVlOwogICAgICAvLyBhbGwgcGFyc2FibGUgZWxlbWVudHMgaW4gaW5Eb2N1bWVudCAoZGVwdGgtZmlyc3QgcHJlLW9yZGVyIHRyYXZlcnNhbCkKICAgICAgdmFyIGVsdHMgPSBpbkRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwocGFyc2VyLnNlbGVjdG9ycyk7CiAgICAgIC8vIGZvciBlYWNoIHBhcnNhYmxlIG5vZGUgdHlwZSwgY2FsbCB0aGUgbWFwcGVkIHBhcnNpbmcgbWV0aG9kCiAgICAgIGZvckVhY2goZWx0cywgZnVuY3Rpb24oZSkgewogICAgICAgIHBhcnNlcltwYXJzZXIubWFwW2UubG9jYWxOYW1lXV0oZSk7CiAgICAgIH0pOwogICAgICAvLyB1cGdyYWRlIGFsbCB1cGdyYWRlYWJsZSBzdGF0aWMgZWxlbWVudHMsIGFueXRoaW5nIGR5bmFtaWNhbGx5CiAgICAgIC8vIGNyZWF0ZWQgc2hvdWxkIGJlIGNhdWdodCBieSBvYnNlcnZlcgogICAgICBDdXN0b21FbGVtZW50cy51cGdyYWRlRG9jdW1lbnQoaW5Eb2N1bWVudCk7CiAgICAgIC8vIG9ic2VydmUgZG9jdW1lbnQgZm9yIGRvbSBjaGFuZ2VzCiAgICAgIEN1c3RvbUVsZW1lbnRzLm9ic2VydmVEb2N1bWVudChpbkRvY3VtZW50KTsKICAgIH0KICB9LAogIHBhcnNlTGluazogZnVuY3Rpb24obGlua0VsdCkgewogICAgLy8gaW1wb3J0cwogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGxpbmtFbHQpKSB7CiAgICAgIHRoaXMucGFyc2VJbXBvcnQobGlua0VsdCk7CiAgICB9CiAgfSwKICBwYXJzZUltcG9ydDogZnVuY3Rpb24obGlua0VsdCkgewogICAgaWYgKGxpbmtFbHQuY29udGVudCkgewogICAgICBwYXJzZXIucGFyc2UobGlua0VsdC5jb250ZW50KTsKICAgIH0KICB9Cn07CgpmdW5jdGlvbiBpc0RvY3VtZW50TGluayhpbkVsdCkgewogIHJldHVybiAoaW5FbHQubG9jYWxOYW1lID09PSAnbGluaycKICAgICAgJiYgaW5FbHQuZ2V0QXR0cmlidXRlKCdyZWwnKSA9PT0gSU1QT1JUX0xJTktfVFlQRSk7Cn0KCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsKCi8vIGV4cG9ydHMKCkN1c3RvbUVsZW1lbnRzLnBhcnNlciA9IHBhcnNlcjsKCn0pKCk7Ci8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCihmdW5jdGlvbigpewoKLy8gYm9vdHN0cmFwIHBhcnNpbmcKZnVuY3Rpb24gYm9vdHN0cmFwKCkgewogIC8vIHBhcnNlIGRvY3VtZW50CiAgQ3VzdG9tRWxlbWVudHMucGFyc2VyLnBhcnNlKGRvY3VtZW50KTsKICAvLyBvbmUgbW9yZSBwYXNzIGJlZm9yZSByZWdpc3RlciBpcyAnbGl2ZScKICBDdXN0b21FbGVtZW50cy51cGdyYWRlRG9jdW1lbnQoZG9jdW1lbnQpOyAgCiAgLy8gY2hvb3NlIGFzeW5jCiAgdmFyIGFzeW5jID0gd2luZG93LlBsYXRmb3JtICYmIFBsYXRmb3JtLmVuZE9mTWljcm90YXNrID8gCiAgICBQbGF0Zm9ybS5lbmRPZk1pY3JvdGFzayA6CiAgICBzZXRUaW1lb3V0OwogIGFzeW5jKGZ1bmN0aW9uKCkgewogICAgLy8gc2V0IGludGVybmFsICdyZWFkeScgZmxhZywgbm93IGRvY3VtZW50LnJlZ2lzdGVyIHdpbGwgdHJpZ2dlciAKICAgIC8vIHN5bmNocm9ub3VzIHVwZ3JhZGVzCiAgICBDdXN0b21FbGVtZW50cy5yZWFkeSA9IHRydWU7CiAgICAvLyBjYXB0dXJlIGJsdW50IHByb2ZpbGluZyBkYXRhCiAgICBDdXN0b21FbGVtZW50cy5yZWFkeVRpbWUgPSBEYXRlLm5vdygpOwogICAgaWYgKHdpbmRvdy5IVE1MSW1wb3J0cykgewogICAgICBDdXN0b21FbGVtZW50cy5lbGFwc2VkID0gQ3VzdG9tRWxlbWVudHMucmVhZHlUaW1lIC0gSFRNTEltcG9ydHMucmVhZHlUaW1lOwogICAgfQogICAgLy8gbm90aWZ5IHRoZSBzeXN0ZW0gdGhhdCB3ZSBhcmUgYm9vdHN0cmFwcGVkCiAgICBkb2N1bWVudC5ib2R5LmRpc3BhdGNoRXZlbnQoCiAgICAgIG5ldyBDdXN0b21FdmVudCgnV2ViQ29tcG9uZW50c1JlYWR5Jywge2J1YmJsZXM6IHRydWV9KQogICAgKTsKICB9KTsKfQoKLy8gQ3VzdG9tRXZlbnQgc2hpbSBmb3IgSUUKaWYgKHR5cGVvZiB3aW5kb3cuQ3VzdG9tRXZlbnQgIT09ICdmdW5jdGlvbicpIHsKICB3aW5kb3cuQ3VzdG9tRXZlbnQgPSBmdW5jdGlvbihpblR5cGUpIHsKICAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgICAgZS5pbml0RXZlbnQoaW5UeXBlLCB0cnVlLCB0cnVlKTsKICAgICByZXR1cm4gZTsKICB9Owp9CgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJykgewogIGJvb3RzdHJhcCgpOwp9IGVsc2UgewogIHZhciBsb2FkRXZlbnQgPSB3aW5kb3cuSFRNTEltcG9ydHMgPyAnSFRNTEltcG9ydHNMb2FkZWQnIDogJ0RPTUNvbnRlbnRMb2FkZWQnOwogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKGxvYWRFdmVudCwgYm9vdHN0cmFwKTsKfQoKfSkoKTsKCihmdW5jdGlvbiAoKSB7CgovKioqIFZhcmlhYmxlcyAqKiovCgogIHZhciB3aW4gPSB3aW5kb3csCiAgICBkb2MgPSBkb2N1bWVudCwKICAgIG5vb3AgPSBmdW5jdGlvbigpe30sCiAgICB0cnVlb3AgPSBmdW5jdGlvbigpeyByZXR1cm4gdHJ1ZTsgfSwKICAgIHJlZ2V4UHNldWRvU3BsaXQgPSAvKFtcdy1dKyg/OlwoW15cKV0rXCkpPykvZywKICAgIHJlZ2V4UHNldWRvUmVwbGFjZSA9IC8oXHcqKSg/OlwoKFteXCldKilcKSk/LywKICAgIHJlZ2V4RGlnaXRzID0gLyhcZCspL2csCiAgICBrZXlwc2V1ZG8gPSB7CiAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICByZXR1cm4gcHNldWRvLnZhbHVlLm1hdGNoKHJlZ2V4RGlnaXRzKS5pbmRleE9mKFN0cmluZyhldmVudC5rZXlDb2RlKSkgPiAtMSA9PSAocHNldWRvLm5hbWUgPT0gJ2tleXBhc3MnKSB8fCBudWxsOwogICAgICB9CiAgICB9LAogICAgcHJlZml4ID0gKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHN0eWxlcyA9IHdpbi5nZXRDb21wdXRlZFN0eWxlKGRvYy5kb2N1bWVudEVsZW1lbnQsICcnKSwKICAgICAgICAgIHByZSA9IChBcnJheS5wcm90b3R5cGUuc2xpY2UKICAgICAgICAgICAgLmNhbGwoc3R5bGVzKQogICAgICAgICAgICAuam9pbignJykKICAgICAgICAgICAgLm1hdGNoKC8tKG1venx3ZWJraXR8bXMpLS8pIHx8IChzdHlsZXMuT0xpbmsgPT09ICcnICYmIFsnJywgJ28nXSkKICAgICAgICAgIClbMV07CiAgICAgIHJldHVybiB7CiAgICAgICAgZG9tOiBwcmUgPT0gJ21zJyA/ICdNUycgOiBwcmUsCiAgICAgICAgbG93ZXJjYXNlOiBwcmUsCiAgICAgICAgY3NzOiAnLScgKyBwcmUgKyAnLScsCiAgICAgICAganM6IHByZSA9PSAnbXMnID8gcHJlIDogcHJlWzBdLnRvVXBwZXJDYXNlKCkgKyBwcmUuc3Vic3RyKDEpCiAgICAgIH07CiAgICB9KSgpLAogICAgbWF0Y2hTZWxlY3RvciA9IEVsZW1lbnQucHJvdG90eXBlLm1hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50LnByb3RvdHlwZVtwcmVmaXgubG93ZXJjYXNlICsgJ01hdGNoZXNTZWxlY3RvciddLAogICAgbXV0YXRpb24gPSB3aW4uTXV0YXRpb25PYnNlcnZlciB8fCB3aW5bcHJlZml4LmpzICsgJ011dGF0aW9uT2JzZXJ2ZXInXTsKCi8qKiogRnVuY3Rpb25zICoqKi8KCi8vIFV0aWxpdGllcwoKICB2YXIgdHlwZUNhY2hlID0ge30sCiAgICAgIHR5cGVTdHJpbmcgPSB0eXBlQ2FjaGUudG9TdHJpbmcsCiAgICAgIHR5cGVSZWdleHAgPSAvXHMoW2EtekEtWl0rKS87CiAgZnVuY3Rpb24gdHlwZU9mKG9iaikgewogICAgdmFyIHR5cGUgPSB0eXBlU3RyaW5nLmNhbGwob2JqKTsKICAgIHJldHVybiB0eXBlQ2FjaGVbdHlwZV0gfHwgKHR5cGVDYWNoZVt0eXBlXSA9IHR5cGUubWF0Y2godHlwZVJlZ2V4cClbMV0udG9Mb3dlckNhc2UoKSk7CiAgfQoKICBmdW5jdGlvbiBjbG9uZShpdGVtLCB0eXBlKXsKICAgIHZhciBmbiA9IGNsb25lW3R5cGUgfHwgdHlwZU9mKGl0ZW0pXTsKICAgIHJldHVybiBmbiA/IGZuKGl0ZW0pIDogaXRlbTsKICB9CiAgICBjbG9uZS5vYmplY3QgPSBmdW5jdGlvbihzcmMpewogICAgICB2YXIgb2JqID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIG9ialtrZXldID0gY2xvbmUoc3JjW2tleV0pOwogICAgICByZXR1cm4gb2JqOwogICAgfTsKICAgIGNsb25lLmFycmF5ID0gZnVuY3Rpb24oc3JjKXsKICAgICAgdmFyIGkgPSBzcmMubGVuZ3RoLCBhcnJheSA9IG5ldyBBcnJheShpKTsKICAgICAgd2hpbGUgKGktLSkgYXJyYXlbaV0gPSBjbG9uZShzcmNbaV0pOwogICAgICByZXR1cm4gYXJyYXk7CiAgICB9OwoKICB2YXIgdW5zbGljZWFibGUgPSBbJ3VuZGVmaW5lZCcsICdudWxsJywgJ251bWJlcicsICdib29sZWFuJywgJ3N0cmluZycsICdmdW5jdGlvbiddOwogIGZ1bmN0aW9uIHRvQXJyYXkob2JqKXsKICAgIHJldHVybiB1bnNsaWNlYWJsZS5pbmRleE9mKHR5cGVPZihvYmopKSA9PSAtMSA/CiAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChvYmosIDApIDoKICAgIFtvYmpdOwogIH0KCi8vIERPTQogIHZhciBzdHIgPSAnJzsKICBmdW5jdGlvbiBxdWVyeShlbGVtZW50LCBzZWxlY3Rvcil7CiAgICByZXR1cm4gKHNlbGVjdG9yIHx8IHN0cikubGVuZ3RoID8gdG9BcnJheShlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpKSA6IFtdOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VNdXRhdGlvbnMoZWxlbWVudCwgbXV0YXRpb25zKSB7CiAgICB2YXIgZGlmZiA9IHsgYWRkZWQ6IFtdLCByZW1vdmVkOiBbXSB9OwogICAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24ocmVjb3JkKXsKICAgICAgcmVjb3JkLl9tdXRhdGlvbiA9IHRydWU7CiAgICAgIGZvciAodmFyIHogaW4gZGlmZikgewogICAgICAgIHZhciB0eXBlID0gZWxlbWVudC5fcmVjb3Jkc1soeiA9PSAnYWRkZWQnKSA/ICdpbnNlcnRlZCcgOiAncmVtb3ZlZCddLAogICAgICAgICAgbm9kZXMgPSByZWNvcmRbeiArICdOb2RlcyddLCBsZW5ndGggPSBub2Rlcy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGggJiYgZGlmZlt6XS5pbmRleE9mKG5vZGVzW2ldKSA9PSAtMTsgaSsrKXsKICAgICAgICAgIGRpZmZbel0ucHVzaChub2Rlc1tpXSk7CiAgICAgICAgICB0eXBlLmZvckVhY2goZnVuY3Rpb24oZm4pewogICAgICAgICAgICBmbihub2Rlc1tpXSwgcmVjb3JkKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKLy8gTWl4aW5zCgogIGZ1bmN0aW9uIG1lcmdlT25lKHNvdXJjZSwga2V5LCBjdXJyZW50KXsKICAgIHZhciB0eXBlID0gdHlwZU9mKGN1cnJlbnQpOwogICAgaWYgKHR5cGUgPT0gJ29iamVjdCcgJiYgdHlwZU9mKHNvdXJjZVtrZXldKSA9PSAnb2JqZWN0JykgeHRhZy5tZXJnZShzb3VyY2Vba2V5XSwgY3VycmVudCk7CiAgICBlbHNlIHNvdXJjZVtrZXldID0gY2xvbmUoY3VycmVudCwgdHlwZSk7CiAgICByZXR1cm4gc291cmNlOwogIH0KCiAgZnVuY3Rpb24gbWVyZ2VNaXhpbih0eXBlLCBtaXhpbiwgb3B0aW9uKSB7CiAgICB2YXIgb3JpZ2luYWwgPSB7fTsKICAgIGZvciAodmFyIG8gaW4gb3B0aW9uKSBvcmlnaW5hbFtvLnNwbGl0KCc6JylbMF1dID0gdHJ1ZTsKICAgIGZvciAodmFyIHggaW4gbWl4aW4pIGlmICghb3JpZ2luYWxbeC5zcGxpdCgnOicpWzBdXSkgb3B0aW9uW3hdID0gbWl4aW5beF07CiAgfQoKICBmdW5jdGlvbiBhcHBseU1peGlucyh0YWcpIHsKICAgIHRhZy5taXhpbnMuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICB2YXIgbWl4aW4gPSB4dGFnLm1peGluc1tuYW1lXTsKICAgICAgZm9yICh2YXIgdHlwZSBpbiBtaXhpbikgewogICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgY2FzZSAnbGlmZWN5Y2xlJzogY2FzZSAnbWV0aG9kcyc6CiAgICAgICAgICAgIG1lcmdlTWl4aW4odHlwZSwgbWl4aW5bdHlwZV0sIHRhZ1t0eXBlXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnYWNjZXNzb3JzJzogY2FzZSAncHJvdG90eXBlJzoKICAgICAgICAgICAgZm9yICh2YXIgeiBpbiBtaXhpblt0eXBlXSkgbWVyZ2VNaXhpbih6LCBtaXhpblt0eXBlXSwgdGFnLmFjY2Vzc29ycyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnZXZlbnRzJzoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHJldHVybiB0YWc7CiAgfQoKLy8gRXZlbnRzCgogIGZ1bmN0aW9uIGRlbGVnYXRlQWN0aW9uKHBzZXVkbywgZXZlbnQpIHsKICAgIHZhciB0YXJnZXQgPSBxdWVyeSh0aGlzLCBwc2V1ZG8udmFsdWUpLmZpbHRlcihmdW5jdGlvbihub2RlKXsKICAgICAgcmV0dXJuIG5vZGUgPT0gZXZlbnQudGFyZ2V0IHx8IG5vZGUuY29udGFpbnMgPyBub2RlLmNvbnRhaW5zKGV2ZW50LnRhcmdldCkgOiBudWxsOwogICAgfSlbMF07CiAgICByZXR1cm4gdGFyZ2V0ID8gcHNldWRvLmxpc3RlbmVyID0gcHNldWRvLmxpc3RlbmVyLmJpbmQodGFyZ2V0KSA6IG51bGw7CiAgfQoKICBmdW5jdGlvbiB0b3VjaEZpbHRlcihldmVudCkgewogICAgaWYgKGV2ZW50LnR5cGUubWF0Y2goJ3RvdWNoJykpewogICAgICBldmVudC50YXJnZXQuX190b3VjaGVkX18gPSB0cnVlOwogICAgfQogICAgZWxzZSBpZiAoZXZlbnQudGFyZ2V0Ll9fdG91Y2hlZF9fICYmIGV2ZW50LnR5cGUubWF0Y2goJ21vdXNlJykpewogICAgICBkZWxldGUgZXZlbnQudGFyZ2V0Ll9fdG91Y2hlZF9fOwogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUZsb3dFdmVudCh0eXBlKSB7CiAgICB2YXIgZmxvdyA9IHR5cGUgPT0gJ292ZXInOwogICAgcmV0dXJuIHsKICAgICAgYXR0YWNoOiAnT3ZlcmZsb3dFdmVudCcgaW4gd2luID8gJ292ZXJmbG93Y2hhbmdlZCcgOiBbXSwKICAgICAgY29uZGl0aW9uOiBmdW5jdGlvbiAoZXZlbnQsIGN1c3RvbSkgewogICAgICAgIGV2ZW50LmZsb3cgPSB0eXBlOwogICAgICAgIHJldHVybiBldmVudC50eXBlID09ICh0eXBlICsgJ2Zsb3cnKSB8fAogICAgICAgICgoZXZlbnQub3JpZW50ID09PSAwICYmIGV2ZW50Lmhvcml6b250YWxPdmVyZmxvdyA9PSBmbG93KSB8fAogICAgICAgIChldmVudC5vcmllbnQgPT0gMSAmJiBldmVudC52ZXJ0aWNhbE92ZXJmbG93ID09IGZsb3cpIHx8CiAgICAgICAgKGV2ZW50Lm9yaWVudCA9PSAyICYmIGV2ZW50Lmhvcml6b250YWxPdmVyZmxvdyA9PSBmbG93ICYmIGV2ZW50LnZlcnRpY2FsT3ZlcmZsb3cgPT0gZmxvdykpOwogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gd3JpdGVQcm9wZXJ0eShrZXksIGV2ZW50LCBiYXNlLCBkZXNjKXsKICAgIGlmIChkZXNjKSBldmVudFtrZXldID0gYmFzZVtrZXldOwogICAgZWxzZSBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXZlbnQsIGtleSwgewogICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6IGJhc2Vba2V5XQogICAgfSk7CiAgfQoKICB2YXIgc2tpcFByb3BzID0ge307CiAgZm9yICh2YXIgeiBpbiBkb2N1bWVudC5jcmVhdGVFdmVudCgnQ3VzdG9tRXZlbnQnKSkgc2tpcFByb3BzW3pdID0gMTsKICBmdW5jdGlvbiBpbmhlcml0RXZlbnQoZXZlbnQsIGJhc2UpewogICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGV2ZW50LCAndGFyZ2V0Jyk7CiAgICBmb3IgKHZhciB6IGluIGJhc2UpIHsKICAgICAgaWYgKCFza2lwUHJvcHNbel0pIHdyaXRlUHJvcGVydHkoeiwgZXZlbnQsIGJhc2UsIGRlc2MpOwogICAgfQogICAgZXZlbnQuYmFzZUV2ZW50ID0gYmFzZTsKICB9CgovLyBBY2Nlc3NvcnMKCiAgZnVuY3Rpb24gZ2V0QXJncyhhdHRyLCB2YWx1ZSl7CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSwKICAgICAgbWV0aG9kOiBhdHRyLmJvb2xlYW4gJiYgIXZhbHVlID8gJ3JlbW92ZUF0dHJpYnV0ZScgOiAnc2V0QXR0cmlidXRlJwogICAgfTsKICB9CgogIGZ1bmN0aW9uIG1vZEF0dHIoZWxlbWVudCwgYXR0ciwgbmFtZSwgdmFsdWUpewogICAgdmFyIGFyZ3MgPSBnZXRBcmdzKGF0dHIsIHZhbHVlKTsKICAgIGVsZW1lbnRbYXJncy5tZXRob2RdKG5hbWUsIGFyZ3MudmFsdWUpOwogIH0KCiAgZnVuY3Rpb24gc3luY0F0dHIoZWxlbWVudCwgYXR0ciwgbmFtZSwgdmFsdWUsIG1ldGhvZCl7CiAgICB2YXIgbm9kZXMgPSBhdHRyLnByb3BlcnR5ID8gW2VsZW1lbnQueHRhZ1thdHRyLnByb3BlcnR5XV0gOiBhdHRyLnNlbGVjdG9yID8geHRhZy5xdWVyeShlbGVtZW50LCBhdHRyLnNlbGVjdG9yKSA6IFtdLAogICAgICAgIGluZGV4ID0gbm9kZXMubGVuZ3RoOwogICAgd2hpbGUgKGluZGV4LS0pIG5vZGVzW2luZGV4XVttZXRob2RdKG5hbWUsIHZhbHVlKTsKICB9CgogIGZ1bmN0aW9uIHVwZGF0ZVZpZXcoZWxlbWVudCwgbmFtZSwgdmFsdWUpewogICAgaWYgKGVsZW1lbnQuX192aWV3X18pewogICAgICBlbGVtZW50Ll9fdmlld19fLnVwZGF0ZUJpbmRpbmdWYWx1ZShlbGVtZW50LCBuYW1lLCB2YWx1ZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhdHRhY2hQcm9wZXJ0aWVzKHRhZywgcHJvcCwgeiwgYWNjZXNzb3IsIGF0dHIsIG5hbWUpewogICAgdmFyIGtleSA9IHouc3BsaXQoJzonKSwgdHlwZSA9IGtleVswXTsKICAgIGlmICh0eXBlID09ICdnZXQnKSB7CiAgICAgIGtleVswXSA9IHByb3A7CiAgICAgIHRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0ID0geHRhZy5hcHBseVBzZXVkb3Moa2V5LmpvaW4oJzonKSwgYWNjZXNzb3Jbel0sIHRhZy5wc2V1ZG9zKTsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGUgPT0gJ3NldCcpIHsKICAgICAga2V5WzBdID0gcHJvcDsKICAgICAgdmFyIHNldHRlciA9IHRhZy5wcm90b3R5cGVbcHJvcF0uc2V0ID0geHRhZy5hcHBseVBzZXVkb3Moa2V5LmpvaW4oJzonKSwgYXR0ciA/IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICB0aGlzLnh0YWcuX3NraXBTZXQgPSB0cnVlOwogICAgICAgIGlmICghdGhpcy54dGFnLl9za2lwQXR0cikgbW9kQXR0cih0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgaWYgKHRoaXMueHRhZy5fc2tpcEF0dHIgJiYgYXR0ci5za2lwKSBkZWxldGUgdGhpcy54dGFnLl9za2lwQXR0cjsKICAgICAgICBhY2Nlc3Nvclt6XS5jYWxsKHRoaXMsIGF0dHIuYm9vbGVhbiA/ICEhdmFsdWUgOiB2YWx1ZSk7CiAgICAgICAgdXBkYXRlVmlldyh0aGlzLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgZGVsZXRlIHRoaXMueHRhZy5fc2tpcFNldDsKICAgICAgfSA6IGFjY2Vzc29yW3pdID8gZnVuY3Rpb24odmFsdWUpewogICAgICAgIGFjY2Vzc29yW3pdLmNhbGwodGhpcywgdmFsdWUpOwogICAgICAgIHVwZGF0ZVZpZXcodGhpcywgbmFtZSwgdmFsdWUpOwogICAgICB9IDogbnVsbCwgdGFnLnBzZXVkb3MpOwoKICAgICAgaWYgKGF0dHIpIGF0dHIuc2V0dGVyID0gc2V0dGVyOwogICAgfQogICAgZWxzZSB0YWcucHJvdG90eXBlW3Byb3BdW3pdID0gYWNjZXNzb3Jbel07CiAgfQoKICBmdW5jdGlvbiBwYXJzZUFjY2Vzc29yKHRhZywgcHJvcCl7CiAgICB0YWcucHJvdG90eXBlW3Byb3BdID0ge307CiAgICB2YXIgYWNjZXNzb3IgPSB0YWcuYWNjZXNzb3JzW3Byb3BdLAogICAgICAgIGF0dHIgPSBhY2Nlc3Nvci5hdHRyaWJ1dGUsCiAgICAgICAgbmFtZSA9IGF0dHIgJiYgYXR0ci5uYW1lID8gYXR0ci5uYW1lLnRvTG93ZXJDYXNlKCkgOiBwcm9wOwoKICAgIGlmIChhdHRyKSB7CiAgICAgIGF0dHIua2V5ID0gcHJvcDsKICAgICAgdGFnLmF0dHJpYnV0ZXNbbmFtZV0gPSBhdHRyOwogICAgfQoKICAgIGZvciAodmFyIHogaW4gYWNjZXNzb3IpIGF0dGFjaFByb3BlcnRpZXModGFnLCBwcm9wLCB6LCBhY2Nlc3NvciwgYXR0ciwgbmFtZSk7CgogICAgaWYgKGF0dHIpIHsKICAgICAgaWYgKCF0YWcucHJvdG90eXBlW3Byb3BdLmdldCkgewogICAgICAgIHZhciBtZXRob2QgPSAoYXR0ci5ib29sZWFuID8gJ2hhcycgOiAnZ2V0JykgKyAnQXR0cmlidXRlJzsKICAgICAgICB0YWcucHJvdG90eXBlW3Byb3BdLmdldCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICByZXR1cm4gdGhpc1ttZXRob2RdKG5hbWUpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgaWYgKCF0YWcucHJvdG90eXBlW3Byb3BdLnNldCkgdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgbW9kQXR0cih0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgdXBkYXRlVmlldyh0aGlzLCBuYW1lLCB2YWx1ZSk7CiAgICAgIH07CiAgICB9CiAgfQoKLyoqKiBYLVRhZyBPYmplY3QgRGVmaW5pdGlvbiAqKiovCgogIHZhciB4dGFnID0gewogICAgdGFnczoge30sCiAgICBkZWZhdWx0T3B0aW9uczogewogICAgICBwc2V1ZG9zOiBbXSwKICAgICAgbWl4aW5zOiBbXSwKICAgICAgZXZlbnRzOiB7fSwKICAgICAgbWV0aG9kczoge30sCiAgICAgIGFjY2Vzc29yczoge30sCiAgICAgIGxpZmVjeWNsZToge30sCiAgICAgIGF0dHJpYnV0ZXM6IHt9LAogICAgICAncHJvdG90eXBlJzogewogICAgICAgIHh0YWc6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX194dGFnX18gPyB0aGlzLl9feHRhZ19fIDogKHRoaXMuX194dGFnX18gPSB7IGRhdGE6IHt9IH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAobmFtZSwgb3B0aW9ucykgewogICAgICB2YXIgX25hbWU7CiAgICAgIGlmICh0eXBlb2YgbmFtZSA9PSAnc3RyaW5nJykgewogICAgICAgIF9uYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gc2F2ZSBwcm90b3R5cGUgZm9yIGFjdHVhbCBvYmplY3QgY3JlYXRpb24gYmVsb3cKICAgICAgdmFyIGJhc2VQcm90b3R5cGUgPSBvcHRpb25zLnByb3RvdHlwZTsKICAgICAgZGVsZXRlIG9wdGlvbnMucHJvdG90eXBlOwoKICAgICAgdmFyIHRhZyA9IHh0YWcudGFnc1tfbmFtZV0gPSBhcHBseU1peGlucyh4dGFnLm1lcmdlKHt9LCB4dGFnLmRlZmF1bHRPcHRpb25zLCBvcHRpb25zKSk7CgogICAgICBmb3IgKHZhciB6IGluIHRhZy5ldmVudHMpIHRhZy5ldmVudHNbel0gPSB4dGFnLnBhcnNlRXZlbnQoeiwgdGFnLmV2ZW50c1t6XSk7CiAgICAgIGZvciAoeiBpbiB0YWcubGlmZWN5Y2xlKSB0YWcubGlmZWN5Y2xlW3ouc3BsaXQoJzonKVswXV0gPSB4dGFnLmFwcGx5UHNldWRvcyh6LCB0YWcubGlmZWN5Y2xlW3pdLCB0YWcucHNldWRvcyk7CiAgICAgIGZvciAoeiBpbiB0YWcubWV0aG9kcykgdGFnLnByb3RvdHlwZVt6LnNwbGl0KCc6JylbMF1dID0geyB2YWx1ZTogeHRhZy5hcHBseVBzZXVkb3MoeiwgdGFnLm1ldGhvZHNbel0sIHRhZy5wc2V1ZG9zKSwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBmb3IgKHogaW4gdGFnLmFjY2Vzc29ycykgcGFyc2VBY2Nlc3Nvcih0YWcsIHopOwoKICAgICAgdmFyIHJlYWR5ID0gdGFnLmxpZmVjeWNsZS5jcmVhdGVkIHx8IHRhZy5saWZlY3ljbGUucmVhZHk7CiAgICAgIHRhZy5wcm90b3R5cGUuY3JlYXRlZENhbGxiYWNrID0gewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKCl7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXM7CiAgICAgICAgICB4dGFnLmFkZEV2ZW50cyh0aGlzLCB0YWcuZXZlbnRzKTsKICAgICAgICAgIHRhZy5taXhpbnMuZm9yRWFjaChmdW5jdGlvbihtaXhpbil7CiAgICAgICAgICAgIGlmICh4dGFnLm1peGluc1ttaXhpbl0uZXZlbnRzKSB4dGFnLmFkZEV2ZW50cyhlbGVtZW50LCB4dGFnLm1peGluc1ttaXhpbl0uZXZlbnRzKTsKICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIG91dHB1dCA9IHJlYWR5ID8gcmVhZHkuYXBwbHkodGhpcywgdG9BcnJheShhcmd1bWVudHMpKSA6IG51bGw7CiAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIHRhZy5hdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgIHZhciBhdHRyID0gdGFnLmF0dHJpYnV0ZXNbbmFtZV0sCiAgICAgICAgICAgICAgICBoYXNBdHRyID0gdGhpcy5oYXNBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgICAgIGlmIChoYXNBdHRyIHx8IGF0dHIuYm9vbGVhbikgewogICAgICAgICAgICAgIHRoaXNbYXR0ci5rZXldID0gYXR0ci5ib29sZWFuID8gaGFzQXR0ciA6IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0YWcucHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgICAgIG9iai5vbkFkZC5jYWxsKGVsZW1lbnQsIG9iaik7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgaWYgKHRhZy5saWZlY3ljbGUuaW5zZXJ0ZWQpIHRhZy5wcm90b3R5cGUuZW50ZXJlZFZpZXdDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUuaW5zZXJ0ZWQsIGVudW1lcmFibGU6IHRydWUgfTsKICAgICAgaWYgKHRhZy5saWZlY3ljbGUucmVtb3ZlZCkgdGFnLnByb3RvdHlwZS5sZWZ0RG9jdW1lbnRDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUucmVtb3ZlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBpZiAodGFnLmxpZmVjeWNsZS5hdHRyaWJ1dGVDaGFuZ2VkKSB0YWcucHJvdG90eXBlLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUuYXR0cmlidXRlQ2hhbmdlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwoKICAgICAgdmFyIHNldEF0dHJpYnV0ZSA9IHRhZy5wcm90b3R5cGUuc2V0QXR0cmlidXRlIHx8IEhUTUxFbGVtZW50LnByb3RvdHlwZS5zZXRBdHRyaWJ1dGU7CiAgICAgIHRhZy5wcm90b3R5cGUuc2V0QXR0cmlidXRlID0gewogICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgIGVudW1iZXJhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpewogICAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgICAgaWYgKCF0aGlzLnh0YWcuX3NraXBBdHRyKSBzZXRBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCBhdHRyICYmIGF0dHIuYm9vbGVhbiA/ICcnIDogdmFsdWUpOwogICAgICAgICAgaWYgKGF0dHIpIHsKICAgICAgICAgICAgaWYgKGF0dHIuc2V0dGVyICYmICF0aGlzLnh0YWcuX3NraXBTZXQpIHsKICAgICAgICAgICAgICB0aGlzLnh0YWcuX3NraXBBdHRyID0gdHJ1ZTsKICAgICAgICAgICAgICBhdHRyLnNldHRlci5jYWxsKHRoaXMsIGF0dHIuYm9vbGVhbiA/IHRydWUgOiB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFsdWUgPSBhdHRyLnNraXAgPyBhdHRyLmJvb2xlYW4gPyB0aGlzLmhhc0F0dHJpYnV0ZShuYW1lKSA6IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpIDogdmFsdWU7CiAgICAgICAgICAgIHN5bmNBdHRyKHRoaXMsIGF0dHIsIG5hbWUsIGF0dHIuYm9vbGVhbiA/ICcnIDogdmFsdWUsICdzZXRBdHRyaWJ1dGUnKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlbGV0ZSB0aGlzLnh0YWcuX3NraXBBdHRyOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciByZW1vdmVBdHRyaWJ1dGUgPSB0YWcucHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZSB8fCBIVE1MRWxlbWVudC5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlOwogICAgICB0YWcucHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZSA9IHsKICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICBlbnVtYmVyYWJsZTogdHJ1ZSwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gKG5hbWUpewogICAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgICAgaWYgKCF0aGlzLnh0YWcuX3NraXBBdHRyKSByZW1vdmVBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lKTsKICAgICAgICAgIGlmIChhdHRyKSB7CiAgICAgICAgICAgIGlmIChhdHRyLnNldHRlciAmJiAhdGhpcy54dGFnLl9za2lwU2V0KSB7CiAgICAgICAgICAgICAgdGhpcy54dGFnLl9za2lwQXR0ciA9IHRydWU7CiAgICAgICAgICAgICAgYXR0ci5zZXR0ZXIuY2FsbCh0aGlzLCBhdHRyLmJvb2xlYW4gPyBmYWxzZSA6IHVuZGVmaW5lZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3luY0F0dHIodGhpcywgYXR0ciwgbmFtZSwgdW5kZWZpbmVkLCAncmVtb3ZlQXR0cmlidXRlJyk7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgdGhpcy54dGFnLl9za2lwQXR0cjsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgZWxlbWVudFByb3RvID0gYmFzZVByb3RvdHlwZSA/CiAgICAgICAgYmFzZVByb3RvdHlwZSA6CiAgICAgICAgICBvcHRpb25zWydleHRlbmRzJ10gPwogICAgICAgICAgICBPYmplY3QuY3JlYXRlKGRvYy5jcmVhdGVFbGVtZW50KG9wdGlvbnNbJ2V4dGVuZHMnXSkKICAgICAgICAgICAgICAuY29uc3RydWN0b3IpLnByb3RvdHlwZSA6CiAgICAgICAgICB3aW4uSFRNTEVsZW1lbnQucHJvdG90eXBlOwoKICAgICAgdmFyIGRlZmluaXRpb24gPSB7CiAgICAgICAgJ3Byb3RvdHlwZSc6IE9iamVjdC5jcmVhdGUoZWxlbWVudFByb3RvLCB0YWcucHJvdG90eXBlKQogICAgICB9OwogICAgICBpZiAob3B0aW9uc1snZXh0ZW5kcyddKSB7CiAgICAgICAgZGVmaW5pdGlvblsnZXh0ZW5kcyddID0gb3B0aW9uc1snZXh0ZW5kcyddOwogICAgICB9CiAgICAgIHJldHVybiBkb2MucmVnaXN0ZXIoX25hbWUsIGRlZmluaXRpb24pOwogICAgfSwKCiAgICAvKiBFeHBvc2VkIFZhcmlhYmxlcyAqLwoKICAgIG1peGluczoge30sCiAgICBwcmVmaXg6IHByZWZpeCwKICAgIHRvdWNoZXM6IHsKICAgICAgYWN0aXZlOiBbXSwKICAgICAgY2hhbmdlZDogW10KICAgIH0sCiAgICBjYXB0dXJlRXZlbnRzOiBbJ2ZvY3VzJywgJ2JsdXInLCAnc2Nyb2xsJywgJ3VuZGVyZmxvdycsICdvdmVyZmxvdycsICdvdmVyZmxvd2NoYW5nZWQnXSwKICAgIGN1c3RvbUV2ZW50czogewogICAgICBvdmVyZmxvdzogY3JlYXRlRmxvd0V2ZW50KCdvdmVyJyksCiAgICAgIHVuZGVyZmxvdzogY3JlYXRlRmxvd0V2ZW50KCd1bmRlcicpLAogICAgICBhbmltYXRpb25zdGFydDogewogICAgICAgIGF0dGFjaDogW3ByZWZpeC5kb20gKyAnQW5pbWF0aW9uU3RhcnQnXQogICAgICB9LAogICAgICBhbmltYXRpb25lbmQ6IHsKICAgICAgICBhdHRhY2g6IFtwcmVmaXguZG9tICsgJ0FuaW1hdGlvbkVuZCddCiAgICAgIH0sCiAgICAgIHRyYW5zaXRpb25lbmQ6IHsKICAgICAgICBhdHRhY2g6IFtwcmVmaXguZG9tICsgJ1RyYW5zaXRpb25FbmQnXQogICAgICB9LAogICAgICBtb3ZlOiB7CiAgICAgICAgYXR0YWNoOiBbJ21vdXNlbW92ZScsICd0b3VjaG1vdmUnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIGVudGVyOiB7CiAgICAgICAgYXR0YWNoOiBbJ21vdXNlb3ZlcicsICd0b3VjaGVudGVyJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICBsZWF2ZTogewogICAgICAgIGF0dGFjaDogWydtb3VzZW91dCcsICd0b3VjaGxlYXZlJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBzdGFydDogewogICAgICAgIG9ic2VydmU6IHsKICAgICAgICAgIG1vdXNlZG93bjogZG9jLAogICAgICAgICAgdG91Y2hzdGFydDogZG9jCiAgICAgICAgfSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcGVuZDogewogICAgICAgIG9ic2VydmU6IHsKICAgICAgICAgIG1vdXNldXA6IGRvYywKICAgICAgICAgIHRvdWNoZW5kOiBkb2MKICAgICAgICB9LAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwbW92ZTogewogICAgICAgIGF0dGFjaDogWyd0YXBzdGFydCcsICdkcmFnZW5kJywgJ3RvdWNoY2FuY2VsJ10sCiAgICAgICAgY29uZGl0aW9uOiBmdW5jdGlvbihldmVudCwgY3VzdG9tKXsKICAgICAgICAgIHN3aXRjaCAoZXZlbnQudHlwZSkgewogICAgICAgICAgICBjYXNlICdtb3ZlJzogIHJldHVybiB0cnVlOwogICAgICAgICAgICBjYXNlICdkcmFnb3Zlcic6CiAgICAgICAgICAgICAgdmFyIGxhc3QgPSBjdXN0b20ubGFzdERyYWcgfHwge307CiAgICAgICAgICAgICAgY3VzdG9tLmxhc3REcmFnID0gZXZlbnQ7CiAgICAgICAgICAgICAgcmV0dXJuIChsYXN0LnBhZ2VYICE9IGV2ZW50LnBhZ2VYICYmIGxhc3QucGFnZVkgIT0gZXZlbnQucGFnZVkpIHx8IG51bGw7CiAgICAgICAgICAgIGNhc2UgJ3RhcHN0YXJ0JzoKICAgICAgICAgICAgICBjdXN0b20udG91Y2hlcyA9IGN1c3RvbS50b3VjaGVzIHx8IDE7CiAgICAgICAgICAgICAgaWYgKCFjdXN0b20ubW92ZSkgewogICAgICAgICAgICAgICAgY3VzdG9tLmN1cnJlbnQgPSB0aGlzOwogICAgICAgICAgICAgICAgY3VzdG9tLm1vdmUgPSB4dGFnLmFkZEV2ZW50cyh0aGlzLCB7CiAgICAgICAgICAgICAgICAgIG1vdmU6IGN1c3RvbS5saXN0ZW5lciwKICAgICAgICAgICAgICAgICAgZHJhZ292ZXI6IGN1c3RvbS5saXN0ZW5lcgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBjdXN0b20udGFwZW5kID0geHRhZy5hZGRFdmVudChkb2MsICd0YXBlbmQnLCBjdXN0b20ubGlzdGVuZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAndGFwZW5kJzogY2FzZSAnZHJhZ2VuZCc6IGNhc2UgJ3RvdWNoY2FuY2VsJzoKICAgICAgICAgICAgICBjdXN0b20udG91Y2hlcy0tOwogICAgICAgICAgICAgIGlmICghY3VzdG9tLnRvdWNoZXMpIHsKICAgICAgICAgICAgICAgIHh0YWcucmVtb3ZlRXZlbnRzKGN1c3RvbS5jdXJyZW50ICwgY3VzdG9tLm1vdmUgfHwge30pOwogICAgICAgICAgICAgICAgeHRhZy5yZW1vdmVFdmVudChkb2MsIGN1c3RvbS50YXBlbmQgfHwge30pOwogICAgICAgICAgICAgICAgZGVsZXRlIGN1c3RvbS5sYXN0RHJhZzsKICAgICAgICAgICAgICAgIGRlbGV0ZSBjdXN0b20uY3VycmVudDsKICAgICAgICAgICAgICAgIGRlbGV0ZSBjdXN0b20udGFwZW5kOwogICAgICAgICAgICAgICAgZGVsZXRlIGN1c3RvbS5tb3ZlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBwc2V1ZG9zOiB7CiAgICAgIGtleXBhc3M6IGtleXBzZXVkbywKICAgICAga2V5ZmFpbDoga2V5cHNldWRvLAogICAgICBkZWxlZ2F0ZTogeyBhY3Rpb246IGRlbGVnYXRlQWN0aW9uIH0sCiAgICAgIHdpdGhpbjogewogICAgICAgIGFjdGlvbjogZGVsZWdhdGVBY3Rpb24sCiAgICAgICAgb25BZGQ6IGZ1bmN0aW9uKHBzZXVkbyl7CiAgICAgICAgICB2YXIgY29uZGl0aW9uID0gcHNldWRvLnNvdXJjZS5jb25kaXRpb247CiAgICAgICAgICBpZiAoY29uZGl0aW9uKSBwc2V1ZG8uc291cmNlLmNvbmRpdGlvbiA9IGZ1bmN0aW9uKGV2ZW50LCBjdXN0b20pewogICAgICAgICAgICByZXR1cm4geHRhZy5xdWVyeSh0aGlzLCBwc2V1ZG8udmFsdWUpLmZpbHRlcihmdW5jdGlvbihub2RlKXsKICAgICAgICAgICAgICByZXR1cm4gbm9kZSA9PSBldmVudC50YXJnZXQgfHwgbm9kZS5jb250YWlucyA/IG5vZGUuY29udGFpbnMoZXZlbnQudGFyZ2V0KSA6IG51bGw7CiAgICAgICAgICAgIH0pWzBdID8gY29uZGl0aW9uLmNhbGwodGhpcywgZXZlbnQsIGN1c3RvbSkgOiBudWxsOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXZlbnRhYmxlOiB7CiAgICAgICAgYWN0aW9uOiBmdW5jdGlvbiAocHNldWRvLCBldmVudCkgewogICAgICAgICAgcmV0dXJuICFldmVudC5kZWZhdWx0UHJldmVudGVkOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICAvKiBVVElMSVRJRVMgKi8KCiAgICBjbG9uZTogY2xvbmUsCiAgICB0eXBlT2Y6IHR5cGVPZiwKICAgIHRvQXJyYXk6IHRvQXJyYXksCgogICAgd3JhcDogZnVuY3Rpb24gKG9yaWdpbmFsLCBmbikgewogICAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICAgIHJldHVybmVkID0gb3JpZ2luYWwuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgcmV0dXJuIHJldHVybmVkID09PSBmYWxzZSA/IGZhbHNlIDogZm4uYXBwbHkodGhpcywgdHlwZW9mIHJldHVybmVkICE9ICd1bmRlZmluZWQnID8gdG9BcnJheShyZXR1cm5lZCkgOiBhcmdzKTsKICAgICAgfTsKICAgIH0sCgogICAgbWVyZ2U6IGZ1bmN0aW9uKHNvdXJjZSwgaywgdil7CiAgICAgIGlmICh0eXBlT2YoaykgPT0gJ3N0cmluZycpIHJldHVybiBtZXJnZU9uZShzb3VyY2UsIGssIHYpOwogICAgICBmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewogICAgICAgIHZhciBvYmplY3QgPSBhcmd1bWVudHNbaV07CiAgICAgICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgbWVyZ2VPbmUoc291cmNlLCBrZXksIG9iamVjdFtrZXldKTsKICAgICAgfQogICAgICByZXR1cm4gc291cmNlOwogICAgfSwKCiAgICB1aWQ6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwxMCk7CiAgICB9LAoKICAgIC8qIERPTSAqLwoKICAgIHF1ZXJ5OiBxdWVyeSwKCiAgICBza2lwVHJhbnNpdGlvbjogZnVuY3Rpb24oZWxlbWVudCwgZm4sIGJpbmQpewogICAgICB2YXIgcHJvcCA9IHByZWZpeC5qcyArICdUcmFuc2l0aW9uUHJvcGVydHknOwogICAgICBlbGVtZW50LnN0eWxlW3Byb3BdID0gZWxlbWVudC5zdHlsZS50cmFuc2l0aW9uUHJvcGVydHkgPSAnbm9uZSc7CiAgICAgIHh0YWcucmVxdWVzdEZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGNhbGxiYWNrOwogICAgICAgIGlmIChmbikgY2FsbGJhY2sgPSBmbi5jYWxsKGJpbmQpOwogICAgICAgIHh0YWcucmVxdWVzdEZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgICBlbGVtZW50LnN0eWxlW3Byb3BdID0gZWxlbWVudC5zdHlsZS50cmFuc2l0aW9uUHJvcGVydHkgPSAnJzsKICAgICAgICAgIGlmIChjYWxsYmFjaykgeHRhZy5yZXF1ZXN0RnJhbWUoY2FsbGJhY2spOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCgogICAgcmVxdWVzdEZyYW1lOiAoZnVuY3Rpb24oKXsKICAgICAgdmFyIHJhZiA9IHdpbi5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICB3aW5bcHJlZml4Lmxvd2VyY2FzZSArICdSZXF1ZXN0QW5pbWF0aW9uRnJhbWUnXSB8fAogICAgICAgIGZ1bmN0aW9uKGZuKXsgcmV0dXJuIHdpbi5zZXRUaW1lb3V0KGZuLCAyMCk7IH07CiAgICAgIHJldHVybiBmdW5jdGlvbihmbil7CiAgICAgICAgcmV0dXJuIHJhZi5jYWxsKHdpbiwgZm4pOwogICAgICB9OwogICAgfSkoKSwKCiAgICBtYXRjaFNlbGVjdG9yOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIG1hdGNoU2VsZWN0b3IuY2FsbChlbGVtZW50LCBzZWxlY3Rvcik7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKGVsZW1lbnQsIG1ldGhvZCwgdmFsdWUpIHsKICAgICAgZWxlbWVudFttZXRob2RdID0gdmFsdWU7CiAgICAgIGlmICh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpIEN1c3RvbUVsZW1lbnRzLnVwZ3JhZGVBbGwoZWxlbWVudCk7CiAgICB9LAoKICAgIGlubmVySFRNTDogZnVuY3Rpb24oZWwsIGh0bWwpewogICAgICB4dGFnLnNldChlbCwgJ2lubmVySFRNTCcsIGh0bWwpOwogICAgfSwKCiAgICBoYXNDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHJldHVybiBlbGVtZW50LmNsYXNzTmFtZS5zcGxpdCgnICcpLmluZGV4T2Yoa2xhc3MudHJpbSgpKT4tMTsKICAgIH0sCgogICAgYWRkQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICB2YXIgbGlzdCA9IGVsZW1lbnQuY2xhc3NOYW1lLnRyaW0oKS5zcGxpdCgnICcpOwogICAgICBrbGFzcy50cmltKCkuc3BsaXQoJyAnKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgaWYgKCF+bGlzdC5pbmRleE9mKG5hbWUpKSBsaXN0LnB1c2gobmFtZSk7CiAgICAgIH0pOwogICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGxpc3Quam9pbignICcpLnRyaW0oKTsKICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICB9LAoKICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgdmFyIGNsYXNzZXMgPSBrbGFzcy50cmltKCkuc3BsaXQoJyAnKTsKICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBlbGVtZW50LmNsYXNzTmFtZS50cmltKCkuc3BsaXQoJyAnKS5maWx0ZXIoZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICByZXR1cm4gbmFtZSAmJiAhfmNsYXNzZXMuaW5kZXhPZihuYW1lKTsKICAgICAgfSkuam9pbignICcpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0sCgogICAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICByZXR1cm4geHRhZ1t4dGFnLmhhc0NsYXNzKGVsZW1lbnQsIGtsYXNzKSA/ICdyZW1vdmVDbGFzcycgOiAnYWRkQ2xhc3MnXS5jYWxsKG51bGwsIGVsZW1lbnQsIGtsYXNzKTsKICAgIH0sCgogICAgcXVlcnlDaGlsZHJlbjogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgIHZhciBpZCA9IGVsZW1lbnQuaWQsCiAgICAgICAgZ3VpZCA9IGVsZW1lbnQuaWQgPSBpZCB8fCAneF8nICsgeHRhZy51aWQoKSwKICAgICAgICBhdHRyID0gJyMnICsgZ3VpZCArICcgPiAnOwogICAgICBzZWxlY3RvciA9IGF0dHIgKyAoc2VsZWN0b3IgKyAnJykucmVwbGFjZSgnLCcsICcsJyArIGF0dHIsICdnJyk7CiAgICAgIHZhciByZXN1bHQgPSBlbGVtZW50LnBhcmVudE5vZGUucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICAgIGlmICghaWQpIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwogICAgICByZXR1cm4gdG9BcnJheShyZXN1bHQpOwogICAgfSwKCiAgICBjcmVhdGVGcmFnbWVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICB2YXIgZnJhZyA9IGRvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIGlmIChjb250ZW50KSB7CiAgICAgICAgdmFyIGRpdiA9IGZyYWcuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpKSwKICAgICAgICAgIG5vZGVzID0gdG9BcnJheShjb250ZW50Lm5vZGVOYW1lID8gYXJndW1lbnRzIDogIShkaXYuaW5uZXJIVE1MID0gY29udGVudCkgfHwgZGl2LmNoaWxkcmVuKSwKICAgICAgICAgIGxlbmd0aCA9IG5vZGVzLmxlbmd0aCwKICAgICAgICAgIGluZGV4ID0gMDsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIGZyYWcuaW5zZXJ0QmVmb3JlKG5vZGVzW2luZGV4KytdLCBkaXYpOwogICAgICAgIGZyYWcucmVtb3ZlQ2hpbGQoZGl2KTsKICAgICAgfQogICAgICByZXR1cm4gZnJhZzsKICAgIH0sCgogICAgbWFuaXB1bGF0ZTogZnVuY3Rpb24oZWxlbWVudCwgZm4pewogICAgICB2YXIgbmV4dCA9IGVsZW1lbnQubmV4dFNpYmxpbmcsCiAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlLAogICAgICAgIGZyYWcgPSBkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICAgIHJldHVybmVkID0gZm4uY2FsbChmcmFnLmFwcGVuZENoaWxkKGVsZW1lbnQpLCBmcmFnKSB8fCBlbGVtZW50OwogICAgICBpZiAobmV4dCkgcGFyZW50Lmluc2VydEJlZm9yZShyZXR1cm5lZCwgbmV4dCk7CiAgICAgIGVsc2UgcGFyZW50LmFwcGVuZENoaWxkKHJldHVybmVkKTsKICAgIH0sCgogICAgLyogUFNFVURPUyAqLwoKICAgIGFwcGx5UHNldWRvczogZnVuY3Rpb24oa2V5LCBmbiwgZWxlbWVudCwgc291cmNlKSB7CiAgICAgIHZhciBsaXN0ZW5lciA9IGZuLAogICAgICAgICAgcHNldWRvcyA9IHt9OwogICAgICBpZiAoa2V5Lm1hdGNoKCc6JykpIHsKICAgICAgICB2YXIgc3BsaXQgPSBrZXkubWF0Y2gocmVnZXhQc2V1ZG9TcGxpdCksCiAgICAgICAgICAgIGkgPSBzcGxpdC5sZW5ndGg7CiAgICAgICAgd2hpbGUgKC0taSkgewogICAgICAgICAgc3BsaXRbaV0ucmVwbGFjZShyZWdleFBzZXVkb1JlcGxhY2UsIGZ1bmN0aW9uIChtYXRjaCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKCF4dGFnLnBzZXVkb3NbbmFtZV0pIHRocm93ICJwc2V1ZG8gbm90IGZvdW5kOiAiICsgbmFtZSArICIgIiArIHNwbGl0OwogICAgICAgICAgICB2YXIgcHNldWRvID0gcHNldWRvc1tpXSA9IE9iamVjdC5jcmVhdGUoeHRhZy5wc2V1ZG9zW25hbWVdKTsKICAgICAgICAgICAgICAgIHBzZXVkby5rZXkgPSBrZXk7CiAgICAgICAgICAgICAgICBwc2V1ZG8ubmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBwc2V1ZG8udmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHBzZXVkb1snYXJndW1lbnRzJ10gPSAodmFsdWUgfHwgJycpLnNwbGl0KCcsJyk7CiAgICAgICAgICAgICAgICBwc2V1ZG8uYWN0aW9uID0gcHNldWRvLmFjdGlvbiB8fCB0cnVlb3A7CiAgICAgICAgICAgICAgICBwc2V1ZG8uc291cmNlID0gc291cmNlOwogICAgICAgICAgICB2YXIgbGFzdCA9IGxpc3RlbmVyOwogICAgICAgICAgICBsaXN0ZW5lciA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICAgICAgICAgIG9iaiA9IHsKICAgICAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICBzb3VyY2U6IHNvdXJjZSwKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcjogbGFzdAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHZhciBvdXRwdXQgPSBwc2V1ZG8uYWN0aW9uLmFwcGx5KHRoaXMsIFtvYmpdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgICAgaWYgKG91dHB1dCA9PT0gbnVsbCB8fCBvdXRwdXQgPT09IGZhbHNlKSByZXR1cm4gb3V0cHV0OwogICAgICAgICAgICAgIHJldHVybiBvYmoubGlzdGVuZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIHBzZXVkby5vbkFkZCkgewogICAgICAgICAgICAgIGlmIChlbGVtZW50LmdldEF0dHJpYnV0ZSkgcHNldWRvLm9uQWRkLmNhbGwoZWxlbWVudCwgcHNldWRvKTsKICAgICAgICAgICAgICBlbHNlIGVsZW1lbnQucHVzaChwc2V1ZG8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yICh2YXIgeiBpbiBwc2V1ZG9zKSB7CiAgICAgICAgaWYgKHBzZXVkb3Nbel0ub25Db21waWxlZCkgbGlzdGVuZXIgPSBwc2V1ZG9zW3pdLm9uQ29tcGlsZWQobGlzdGVuZXIsIHBzZXVkb3Nbel0pIHx8IGxpc3RlbmVyOwogICAgICB9CiAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgIH0sCgogICAgcmVtb3ZlUHNldWRvczogZnVuY3Rpb24oZWxlbWVudCwgZXZlbnQpewogICAgICBldmVudC5fcHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgaWYgKG9iai5vblJlbW92ZSkgb2JqLm9uUmVtb3ZlLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgfSk7CiAgICB9LAoKICAvKioqIEV2ZW50cyAqKiovCgogICAgcGFyc2VFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pIHsKICAgICAgdmFyIHBzZXVkb3MgPSB0eXBlLnNwbGl0KCc6JyksCiAgICAgICAgICBrZXkgPSBwc2V1ZG9zLnNoaWZ0KCksCiAgICAgICAgICBjdXN0b20gPSB4dGFnLmN1c3RvbUV2ZW50c1trZXldLAogICAgICAgICAgZXZlbnQgPSB4dGFnLm1lcmdlKHsKICAgICAgICAgICAgdHlwZToga2V5LAogICAgICAgICAgICBzdGFjazogbm9vcCwKICAgICAgICAgICAgY29uZGl0aW9uOiB0cnVlb3AsCiAgICAgICAgICAgIGF0dGFjaDogW10sCiAgICAgICAgICAgIF9hdHRhY2g6IFtdLAogICAgICAgICAgICBwc2V1ZG9zOiAnJywKICAgICAgICAgICAgX3BzZXVkb3M6IFtdLAogICAgICAgICAgICBvbkFkZDogbm9vcCwKICAgICAgICAgICAgb25SZW1vdmU6IG5vb3AKICAgICAgICAgIH0sIGN1c3RvbSB8fCB7fSk7CiAgICAgIGV2ZW50LmF0dGFjaCA9IHRvQXJyYXkoZXZlbnQuYmFzZSB8fCBldmVudC5hdHRhY2gpOwogICAgICBldmVudC5jaGFpbiA9IGtleSArIChldmVudC5wc2V1ZG9zLmxlbmd0aCA/ICc6JyArIGV2ZW50LnBzZXVkb3MgOiAnJykgKyAocHNldWRvcy5sZW5ndGggPyAnOicgKyBwc2V1ZG9zLmpvaW4oJzonKSA6ICcnKTsKICAgICAgdmFyIGNvbmRpdGlvbiA9IGV2ZW50LmNvbmRpdGlvbjsKICAgICAgZXZlbnQuY29uZGl0aW9uID0gZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIHQgPSBlLnRvdWNoZXMsIHR0ID0gZS50YXJnZXRUb3VjaGVzOwogICAgICAgIHJldHVybiBjb25kaXRpb24uYXBwbHkodGhpcywgdG9BcnJheShhcmd1bWVudHMpKTsKICAgICAgfTsKICAgICAgdmFyIHN0YWNrID0geHRhZy5hcHBseVBzZXVkb3MoZXZlbnQuY2hhaW4sIGZuLCBldmVudC5fcHNldWRvcywgZXZlbnQpOwogICAgICBldmVudC5zdGFjayA9IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciB0ID0gZS50b3VjaGVzLCB0dCA9IGUudGFyZ2V0VG91Y2hlczsKICAgICAgICB2YXIgZGV0YWlsID0gZS5kZXRhaWwgfHwge307CiAgICAgICAgaWYgKCFkZXRhaWwuX19zdGFja19fKSByZXR1cm4gc3RhY2suYXBwbHkodGhpcywgdG9BcnJheShhcmd1bWVudHMpKTsKICAgICAgICBlbHNlIGlmIChkZXRhaWwuX19zdGFja19fID09IHN0YWNrKSB7CiAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgZS5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIHN0YWNrLmFwcGx5KHRoaXMsIHRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgfQogICAgICB9OwogICAgICBldmVudC5saXN0ZW5lciA9IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgICBvdXRwdXQgPSBldmVudC5jb25kaXRpb24uYXBwbHkodGhpcywgYXJncy5jb25jYXQoW2V2ZW50XSkpOwogICAgICAgIGlmICghb3V0cHV0KSByZXR1cm4gb3V0cHV0OwogICAgICAgIGlmIChlLnR5cGUgIT0ga2V5KSB4dGFnLmZpcmVFdmVudChlLnRhcmdldCwga2V5LCB7IGJhc2VFdmVudDogZSwgZGV0YWlsOiB7IF9fc3RhY2tfXzogc3RhY2sgfSB9KTsKICAgICAgICBlbHNlIHJldHVybiBldmVudC5zdGFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfTsKICAgICAgZXZlbnQuYXR0YWNoLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgIGV2ZW50Ll9hdHRhY2gucHVzaCh4dGFnLnBhcnNlRXZlbnQobmFtZSwgZXZlbnQubGlzdGVuZXIpKTsKICAgICAgfSk7CiAgICAgIGlmIChjdXN0b20gJiYgY3VzdG9tLm9ic2VydmUgJiYgIWN1c3RvbS5fX29ic2VydmluZ19fKSB7CiAgICAgICAgY3VzdG9tLm9ic2VydmVyID0gZnVuY3Rpb24oZSl7CiAgICAgICAgICB2YXIgb3V0cHV0ID0gZXZlbnQuY29uZGl0aW9uLmFwcGx5KHRoaXMsIHRvQXJyYXkoYXJndW1lbnRzKS5jb25jYXQoW2N1c3RvbV0pKTsKICAgICAgICAgIGlmICghb3V0cHV0KSByZXR1cm4gb3V0cHV0OwogICAgICAgICAgeHRhZy5maXJlRXZlbnQoZS50YXJnZXQsIGtleSwgeyBiYXNlRXZlbnQ6IGUgfSk7CiAgICAgICAgfTsKICAgICAgICBmb3IgKHZhciB6IGluIGN1c3RvbS5vYnNlcnZlKSB4dGFnLmFkZEV2ZW50KGN1c3RvbS5vYnNlcnZlW3pdIHx8IGRvY3VtZW50LCB6LCBjdXN0b20ub2JzZXJ2ZXIsIHRydWUpOwogICAgICAgIGN1c3RvbS5fX29ic2VydmluZ19fID0gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gZXZlbnQ7CiAgICB9LAoKICAgIGFkZEV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4sIGNhcHR1cmUpIHsKICAgICAgdmFyIGV2ZW50ID0gKHR5cGVvZiBmbiA9PSAnZnVuY3Rpb24nKSA/IHh0YWcucGFyc2VFdmVudCh0eXBlLCBmbikgOiBmbjsKICAgICAgZXZlbnQuX3BzZXVkb3MuZm9yRWFjaChmdW5jdGlvbihvYmopewogICAgICAgIG9iai5vbkFkZC5jYWxsKGVsZW1lbnQsIG9iaik7CiAgICAgIH0pOwogICAgICBldmVudC5fYXR0YWNoLmZvckVhY2goZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgeHRhZy5hZGRFdmVudChlbGVtZW50LCBvYmoudHlwZSwgb2JqKTsKICAgICAgfSk7CiAgICAgIGV2ZW50Lm9uQWRkLmNhbGwoZWxlbWVudCwgZXZlbnQsIGV2ZW50Lmxpc3RlbmVyKTsKICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LnR5cGUsIGV2ZW50LnN0YWNrLCBjYXB0dXJlIHx8IHh0YWcuY2FwdHVyZUV2ZW50cy5pbmRleE9mKGV2ZW50LnR5cGUpID4gLTEpOwogICAgICByZXR1cm4gZXZlbnQ7CiAgICB9LAoKICAgIGFkZEV2ZW50czogZnVuY3Rpb24gKGVsZW1lbnQsIG9iaikgewogICAgICB2YXIgZXZlbnRzID0ge307CiAgICAgIGZvciAodmFyIHogaW4gb2JqKSB7CiAgICAgICAgZXZlbnRzW3pdID0geHRhZy5hZGRFdmVudChlbGVtZW50LCB6LCBvYmpbel0pOwogICAgICB9CiAgICAgIHJldHVybiBldmVudHM7CiAgICB9LAoKICAgIHJlbW92ZUV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZXZlbnQpIHsKICAgICAgZXZlbnQgPSBldmVudCB8fCB0eXBlOwogICAgICBldmVudC5vblJlbW92ZS5jYWxsKGVsZW1lbnQsIGV2ZW50LCBldmVudC5saXN0ZW5lcik7CiAgICAgIHh0YWcucmVtb3ZlUHNldWRvcyhlbGVtZW50LCBldmVudCk7CiAgICAgIGV2ZW50Ll9hdHRhY2guZm9yRWFjaChmdW5jdGlvbihvYmopIHsKICAgICAgICB4dGFnLnJlbW92ZUV2ZW50KGVsZW1lbnQsIG9iaik7CiAgICAgIH0pOwogICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnQudHlwZSwgZXZlbnQuc3RhY2spOwogICAgfSwKCiAgICByZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGVsZW1lbnQsIG9iail7CiAgICAgIGZvciAodmFyIHogaW4gb2JqKSB4dGFnLnJlbW92ZUV2ZW50KGVsZW1lbnQsIG9ialt6XSk7CiAgICB9LAoKICAgIGZpcmVFdmVudDogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgb3B0aW9ucywgd2Fybil7CiAgICAgIHZhciBldmVudCA9IGRvYy5jcmVhdGVFdmVudCgnQ3VzdG9tRXZlbnQnKTsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIGlmICh3YXJuKSBjb25zb2xlLndhcm4oJ2ZpcmVFdmVudCBoYXMgYmVlbiBtb2RpZmllZCwgbW9yZSBpbmZvIGhlcmU6ICcpOwogICAgICBldmVudC5pbml0Q3VzdG9tRXZlbnQodHlwZSwKICAgICAgICBvcHRpb25zLmJ1YmJsZXMgIT09IGZhbHNlLAogICAgICAgIG9wdGlvbnMuY2FuY2VsYWJsZSAhPT0gZmFsc2UsCiAgICAgICAgb3B0aW9ucy5kZXRhaWwKICAgICAgKTsKICAgICAgaWYgKG9wdGlvbnMuYmFzZUV2ZW50KSBpbmhlcml0RXZlbnQoZXZlbnQsIG9wdGlvbnMuYmFzZUV2ZW50KTsKICAgICAgdHJ5IHsgZWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsgfQogICAgICBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUud2FybignVGhpcyBlcnJvciBtYXkgaGF2ZSBiZWVuIGNhdXNlZCBieSBhIGNoYW5nZSBpbiB0aGUgZmlyZUV2ZW50IG1ldGhvZCwgbW9yZSBpbmZvIGhlcmU6ICcsIGUpOwogICAgICB9CiAgICB9LAoKICAgIGFkZE9ic2VydmVyOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbil7CiAgICAgIGlmICghZWxlbWVudC5fcmVjb3JkcykgewogICAgICAgIGVsZW1lbnQuX3JlY29yZHMgPSB7IGluc2VydGVkOiBbXSwgcmVtb3ZlZDogW10gfTsKICAgICAgICBpZiAobXV0YXRpb24pewogICAgICAgICAgZWxlbWVudC5fb2JzZXJ2ZXIgPSBuZXcgbXV0YXRpb24oZnVuY3Rpb24obXV0YXRpb25zKSB7CiAgICAgICAgICAgIHBhcnNlTXV0YXRpb25zKGVsZW1lbnQsIG11dGF0aW9ucyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGVsZW1lbnQuX29ic2VydmVyLm9ic2VydmUoZWxlbWVudCwgewogICAgICAgICAgICBzdWJ0cmVlOiB0cnVlLAogICAgICAgICAgICBjaGlsZExpc3Q6IHRydWUsCiAgICAgICAgICAgIGF0dHJpYnV0ZXM6ICF0cnVlLAogICAgICAgICAgICBjaGFyYWN0ZXJEYXRhOiBmYWxzZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgWydJbnNlcnRlZCcsICdSZW1vdmVkJ10uZm9yRWFjaChmdW5jdGlvbih0eXBlKXsKICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NTm9kZScgKyB0eXBlLCBmdW5jdGlvbihldmVudCl7CiAgICAgICAgICAgIGV2ZW50Ll9tdXRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVsZW1lbnQuX3JlY29yZHNbdHlwZS50b0xvd2VyQ2FzZSgpXS5mb3JFYWNoKGZ1bmN0aW9uKGZuKXsKICAgICAgICAgICAgICBmbihldmVudC50YXJnZXQsIGV2ZW50KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKGVsZW1lbnQuX3JlY29yZHNbdHlwZV0uaW5kZXhPZihmbikgPT0gLTEpIGVsZW1lbnQuX3JlY29yZHNbdHlwZV0ucHVzaChmbik7CiAgICB9LAoKICAgIHJlbW92ZU9ic2VydmVyOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbil7CiAgICAgIHZhciBvYmogPSBlbGVtZW50Ll9yZWNvcmRzOwogICAgICBpZiAob2JqICYmIGZuKXsKICAgICAgICBvYmpbdHlwZV0uc3BsaWNlKG9ialt0eXBlXS5pbmRleE9mKGZuKSwgMSk7CiAgICAgIH0KICAgICAgZWxzZXsKICAgICAgICBvYmpbdHlwZV0gPSBbXTsKICAgICAgfQogICAgfQoKICB9OwoKLyoqKiBVbml2ZXJzYWwgVG91Y2ggKioqLwoKdmFyIHRvdWNoQ291bnQgPSAwLCB0b3VjaFRhcmdldCA9IG51bGw7Cgpkb2MuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgZnVuY3Rpb24oZSl7CiAgdG91Y2hDb3VudCsrOwogIHRvdWNoVGFyZ2V0ID0gZS50YXJnZXQ7Cn0sIHRydWUpOwoKZG9jLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBmdW5jdGlvbigpewogIHRvdWNoQ291bnQtLTsKICB0b3VjaFRhcmdldCA9IG51bGw7Cn0sIGZhbHNlKTsKCnZhciBVSUV2ZW50UHJvdG8gPSB7CiAgdG91Y2hlczogewogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5fX3RvdWNoZXNfXyB8fAogICAgICAgICh0aGlzLmlkZW50aWZpZXIgPSAwKSB8fAogICAgICAgICh0aGlzLl9fdG91Y2hlc19fID0gdG91Y2hDb3VudCA/IFt0aGlzXSA6IFtdKTsKICAgIH0KICB9LAogIHRhcmdldFRvdWNoZXM6IHsKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMuX190YXJnZXRUb3VjaGVzX18gfHwgKHRoaXMuX190YXJnZXRUb3VjaGVzX18gPQogICAgICAgICh0b3VjaENvdW50ICYmIHRoaXMuY3VycmVudFRhcmdldCAmJgogICAgICAgICh0aGlzLmN1cnJlbnRUYXJnZXQgPT0gdG91Y2hUYXJnZXQgfHwKICAgICAgICAodGhpcy5jdXJyZW50VGFyZ2V0LmNvbnRhaW5zICYmIHRoaXMuY3VycmVudFRhcmdldC5jb250YWlucyh0b3VjaFRhcmdldCkpKSkgPyBbdGhpc10gOiBbXSk7CiAgICB9CiAgfSwKICBjaGFuZ2VkVG91Y2hlczogewogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy50b3VjaGVzOwogICAgfQogIH0KfTsKCmZvciAoeiBpbiBVSUV2ZW50UHJvdG8pewogIFVJRXZlbnQucHJvdG90eXBlW3pdID0gVUlFdmVudFByb3RvW3pdOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShVSUV2ZW50LnByb3RvdHlwZSwgeiwgVUlFdmVudFByb3RvW3pdKTsKfQoKdmFyIHRvdWNoUmVzZXQgPSB7CiAgICB2YWx1ZTogbnVsbCwKICAgIHdyaXRhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlCiAgfSwKICBUb3VjaEV2ZW50UHJvdG8gPSB7CiAgICB0b3VjaGVzOiB0b3VjaFJlc2V0LAogICAgdGFyZ2V0VG91Y2hlczogdG91Y2hSZXNldCwKICAgIGNoYW5nZWRUb3VjaGVzOiB0b3VjaFJlc2V0CiAgfTsKCmlmICh3aW4uVG91Y2hFdmVudCkgewogIGZvciAoeiBpbiBUb3VjaEV2ZW50UHJvdG8pIHsKICAgIHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih3aW4uVG91Y2hFdmVudC5wcm90b3R5cGUsIHopOwogICAgaWYgKGRlc2MpIHdpbi5Ub3VjaEV2ZW50LnByb3RvdHlwZVt6XSA9IFRvdWNoRXZlbnRQcm90b1t6XTsKICAgIGVsc2UgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbi5Ub3VjaEV2ZW50LnByb3RvdHlwZSwgeiwgVG91Y2hFdmVudFByb3RvW3pdKTsKICB9Cn0KCi8qKiogQ3VzdG9tIEV2ZW50IERlZmluaXRpb25zICoqKi8KCiAgZnVuY3Rpb24gYWRkVGFwKGVsLCB0YXAsIGUpewogICAgaWYgKCFlbC5fX3RhcF9fKSB7CiAgICAgIGVsLl9fdGFwX18gPSB7IGNsaWNrOiBlLnR5cGUgPT0gJ21vdXNlZG93bicgfTsKICAgICAgaWYgKGVsLl9fdGFwX18uY2xpY2spIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGFwLm9ic2VydmVyKTsKICAgICAgZWxzZSB7CiAgICAgICAgZWwuX190YXBfXy5zY3JvbGwgPSB0YXAub2JzZXJ2ZXIuYmluZChlbCk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIGVsLl9fdGFwX18uc2Nyb2xsLCB0cnVlKTsKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0YXAub2JzZXJ2ZXIpOwogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgdGFwLm9ic2VydmVyKTsKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRhcC5vYnNlcnZlcik7CiAgICAgIH0KICAgIH0KICAgIGlmICghZWwuX190YXBfXy5jbGljaykgewogICAgICBlbC5fX3RhcF9fLnggPSBlLnRvdWNoZXNbMF0ucGFnZVg7CiAgICAgIGVsLl9fdGFwX18ueSA9IGUudG91Y2hlc1swXS5wYWdlWTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbW92ZVRhcChlbCwgdGFwKXsKICAgIGlmIChlbC5fX3RhcF9fKSB7CiAgICAgIGlmIChlbC5fX3RhcF9fLmNsaWNrKSBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRhcC5vYnNlcnZlcik7CiAgICAgIGVsc2UgewogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCBlbC5fX3RhcF9fLnNjcm9sbCwgdHJ1ZSk7CiAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGFwLm9ic2VydmVyKTsKICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIHRhcC5vYnNlcnZlcik7CiAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0YXAub2JzZXJ2ZXIpOwogICAgICB9CiAgICAgIGRlbGV0ZSBlbC5fX3RhcF9fOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2hlY2tUYXBQb3NpdGlvbihlbCwgdGFwLCBlKXsKICAgIHZhciB0b3VjaCA9IGUuY2hhbmdlZFRvdWNoZXNbMF07CiAgICBpZiAoCiAgICAgIHRvdWNoLnBhZ2VYIDwgZWwuX190YXBfXy54ICsgdGFwLmdlc3R1cmUudG9sZXJhbmNlICYmCiAgICAgIHRvdWNoLnBhZ2VYID4gZWwuX190YXBfXy54IC0gdGFwLmdlc3R1cmUudG9sZXJhbmNlICYmCiAgICAgIHRvdWNoLnBhZ2VZIDwgZWwuX190YXBfXy55ICsgdGFwLmdlc3R1cmUudG9sZXJhbmNlICYmCiAgICAgIHRvdWNoLnBhZ2VZID4gZWwuX190YXBfXy55IC0gdGFwLmdlc3R1cmUudG9sZXJhbmNlCiAgICApIHJldHVybiB0cnVlOwogIH0KCiAgeHRhZy5jdXN0b21FdmVudHMudGFwID0gewogICAgb2JzZXJ2ZTogewogICAgICBtb3VzZWRvd246IGRvY3VtZW50LAogICAgICB0b3VjaHN0YXJ0OiBkb2N1bWVudAogICAgfSwKICAgIGdlc3R1cmU6IHsKICAgICAgdG9sZXJhbmNlOiA4CiAgICB9LAogICAgY29uZGl0aW9uOiBmdW5jdGlvbihlLCB0YXApewogICAgICB2YXIgZWwgPSBlLnRhcmdldDsKICAgICAgc3dpdGNoIChlLnR5cGUpIHsKICAgICAgICBjYXNlICd0b3VjaHN0YXJ0JzoKICAgICAgICAgIGlmIChlbC5fX3RhcF9fICYmIGVsLl9fdGFwX18uY2xpY2spIHJlbW92ZVRhcChlbCwgdGFwKTsKICAgICAgICAgIGFkZFRhcChlbCwgdGFwLCBlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICBjYXNlICdtb3VzZWRvd24nOgogICAgICAgICAgaWYgKCFlbC5fX3RhcF9fKSBhZGRUYXAoZWwsIHRhcCwgZSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgY2FzZSAnc2Nyb2xsJzoKICAgICAgICBjYXNlICd0b3VjaGNhbmNlbCc6CiAgICAgICAgICByZW1vdmVUYXAodGhpcywgdGFwKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICBjYXNlICd0b3VjaG1vdmUnOgogICAgICAgIGNhc2UgJ3RvdWNoZW5kJzoKICAgICAgICAgIGlmICh0aGlzLl9fdGFwX18gJiYgIWNoZWNrVGFwUG9zaXRpb24odGhpcywgdGFwLCBlKSkgewogICAgICAgICAgICByZW1vdmVUYXAodGhpcywgdGFwKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGUudHlwZSA9PSAndG91Y2hlbmQnIHx8IG51bGw7CiAgICAgICAgY2FzZSAnY2xpY2snOgogICAgICAgICAgcmVtb3ZlVGFwKHRoaXMsIHRhcCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogIH07CgogIHdpbi54dGFnID0geHRhZzsKICBpZiAodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIGRlZmluZSh4dGFnKTsKCiAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoJ1dlYkNvbXBvbmVudHNSZWFkeScsIGZ1bmN0aW9uKCl7CiAgICB4dGFnLmZpcmVFdmVudChkb2MuYm9keSwgJ0RPTUNvbXBvbmVudHNMb2FkZWQnKTsKICB9KTsKCn0pKCk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 03:44:52 GMT",
                    "Content-Length": "92614",
                    "Date": "Sun, 09 Nov 2014 03:44:52 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}