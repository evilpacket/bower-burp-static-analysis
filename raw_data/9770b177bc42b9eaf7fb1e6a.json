{
    "url": "http://localhost:9999/WiserTogether/chiropractor/chiropractor.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/WiserTogether/chiropractor/chiropractor.js",
                "path": "/WiserTogether/chiropractor/chiropractor.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9XaXNlclRvZ2V0aGVyL2NoaXJvcHJhY3Rvci9jaGlyb3ByYWN0b3IuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzA5ODc2DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDE1OjA3OjM3IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAxNTowNzozNSBHTVQNCg0KKGZ1bmN0aW9uICgpIHsvLyAgICAgQmFja2JvbmUuanMgMS4xLjAKCi8vICAgICAoYykgMjAxMC0yMDExIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBJbmMuCi8vICAgICAoYykgMjAxMS0yMDEzIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCi8vICAgICBCYWNrYm9uZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KLy8gICAgIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKLy8gICAgIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZwoKKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKICAvLyBTZXQgdXAgQmFja2JvbmUgYXBwcm9wcmlhdGVseSBmb3IgdGhlIGVudmlyb25tZW50LgogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIC8vIE5vZGUvQ29tbW9uSlMsIG5vIG5lZWQgZm9yIGpRdWVyeSBpbiB0aGF0IGNhc2UuCiAgICBmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIC8vIEFNRAogICAgZGVmaW5lKCdiYWNrYm9uZScsWyd1bmRlcnNjb3JlJywgJ2pxdWVyeScsICdleHBvcnRzJ10sIGZ1bmN0aW9uKF8sICQsIGV4cG9ydHMpIHsKICAgICAgLy8gRXhwb3J0IGdsb2JhbCBldmVuIGluIEFNRCBjYXNlIGluIGNhc2UgdGhpcyBzY3JpcHQgaXMgbG9hZGVkIHdpdGgKICAgICAgLy8gb3RoZXJzIHRoYXQgbWF5IHN0aWxsIGV4cGVjdCBhIGdsb2JhbCBCYWNrYm9uZS4KICAgICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXywgJCk7CiAgICB9KTsKICB9IGVsc2UgewogICAgLy8gQnJvd3NlciBnbG9iYWxzCiAgICByb290LkJhY2tib25lID0gZmFjdG9yeShyb290LCB7fSwgcm9vdC5fLCAocm9vdC5qUXVlcnkgfHwgcm9vdC5aZXB0byB8fCByb290LmVuZGVyIHx8IHJvb3QuJCkpOwogIH0KfSh0aGlzLCBmdW5jdGlvbihyb290LCBCYWNrYm9uZSwgXywgJCkgewoKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCiAgdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoKICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgogIHZhciBhcnJheSA9IFtdOwogIHZhciBwdXNoID0gYXJyYXkucHVzaDsKICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwoKICAvLyBDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLgogIEJhY2tib25lLlZFUlNJT04gPSAnMS4xLjAnOwoKICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgb3IgRW5kZXIgb3ducyB0aGUgYCRgIHZhcmlhYmxlLgogIEJhY2tib25lLiQgPSAkOwoKICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCiAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgLy8gd2lsbCBmYWtlIGAiUEFUQ0giYCwgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgogIC8vIEJhY2tib25lLkV2ZW50cwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCiAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawogIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCiAgLy8gc3VjY2Vzc2lvbi4KICAvLwogIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAvLwogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgogICAgLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CiAgICAgIGV2ZW50cy5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYub2ZmKG5hbWUsIG9uY2UpOwogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0pOwogICAgICBvbmNlLl9jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgIH0sCgogICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwogICAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhZXZlbnRzQXBpKHRoaXMsICdvZmYnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAoZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdKSB7CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSByZXRhaW4gPSBbXTsKICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CiAgICAgICAgICAgIGZvciAoaiA9IDAsIGsgPSBldmVudHMubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgICAgZXYgPSBldmVudHNbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjaykgfHwKICAgICAgICAgICAgICAgICAgKGNvbnRleHQgJiYgY29udGV4dCAhPT0gZXYuY29udGV4dCkpIHsKICAgICAgICAgICAgICAgIHJldGFpbi5wdXNoKGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKICAgICAgaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwogICAgICBpZiAoYWxsRXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGFsbEV2ZW50cywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvOwogICAgICBpZiAoIWxpc3RlbmluZ1RvKSByZXR1cm4gdGhpczsKICAgICAgdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgaWYgKG9iaikgKGxpc3RlbmluZ1RvID0ge30pW29iai5fbGlzdGVuSWRdID0gb2JqOwogICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5pbmdUbykgewogICAgICAgIG9iaiA9IGxpc3RlbmluZ1RvW2lkXTsKICAgICAgICBvYmoub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgICBpZiAocmVtb3ZlIHx8IF8uaXNFbXB0eShvYmouX2V2ZW50cykpIGRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogIH07CgogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwoKICAgIC8vIEhhbmRsZSBldmVudCBtYXBzLgogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBIYW5kbGUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50IG5hbWVzLgogICAgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewogICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgogIC8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKICAvLyBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHsKICAgICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7IHJldHVybjsKICAgICAgY2FzZSAxOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOyByZXR1cm47CiAgICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7IHJldHVybjsKICAgICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7IHJldHVybjsKICAgICAgZGVmYXVsdDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsKICAgIH0KICB9OwoKICB2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwoKICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwogIC8vIGxpc3RlbiB0byBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MKICAvLyBsaXN0ZW5pbmcgdG8uCiAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uKGltcGxlbWVudGF0aW9uLCBtZXRob2QpIHsKICAgIEV2ZW50c1ttZXRob2RdID0gZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbyB8fCAodGhpcy5fbGlzdGVuaW5nVG8gPSB7fSk7CiAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5pbmdUb1tpZF0gPSBvYmo7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CiAgICAgIG9ialtpbXBsZW1lbnRhdGlvbl0obmFtZSwgY2FsbGJhY2ssIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgfSk7CgogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CiAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgogIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCiAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CgogIC8vIEJhY2tib25lLk1vZGVsCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gQmFja2JvbmUgKipNb2RlbHMqKiBhcmUgdGhlIGJhc2ljIGRhdGEgb2JqZWN0IGluIHRoZSBmcmFtZXdvcmsgLS0KICAvLyBmcmVxdWVudGx5IHJlcHJlc2VudGluZyBhIHJvdyBpbiBhIHRhYmxlIGluIGEgZGF0YWJhc2Ugb24geW91ciBzZXJ2ZXIuCiAgLy8gQSBkaXNjcmV0ZSBjaHVuayBvZiBkYXRhIGFuZCBhIGJ1bmNoIG9mIHVzZWZ1bCwgcmVsYXRlZCBtZXRob2RzIGZvcgogIC8vIHBlcmZvcm1pbmcgY29tcHV0YXRpb25zIGFuZCB0cmFuc2Zvcm1hdGlvbnMgb24gdGhhdCBkYXRhLgoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCB0aGUgc3BlY2lmaWVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMsIG9wdGlvbnMpIHx8IHt9OwogICAgYXR0cnMgPSBfLmRlZmF1bHRzKHt9LCBhdHRycywgXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpOwogICAgdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgIGNoYW5nZWQ6IG51bGwsCgogICAgLy8gVGhlIHZhbHVlIHJldHVybmVkIGR1cmluZyB0aGUgbGFzdCBmYWlsZWQgdmFsaWRhdGlvbi4KICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAogICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgLiBUaGlzIGlzCiAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwogICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdW5zZXQgICAgICAgICAgID0gb3B0aW9ucy51bnNldDsKICAgICAgc2lsZW50ICAgICAgICAgID0gb3B0aW9ucy5zaWxlbnQ7CiAgICAgIGNoYW5nZXMgICAgICAgICA9IFtdOwogICAgICBjaGFuZ2luZyAgICAgICAgPSB0aGlzLl9jaGFuZ2luZzsKICAgICAgdGhpcy5fY2hhbmdpbmcgID0gdHJ1ZTsKCiAgICAgIGlmICghY2hhbmdpbmcpIHsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIH0KICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKCiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgewogICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwogICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpIGNoYW5nZXMucHVzaChhdHRyKTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChwcmV2W2F0dHJdLCB2YWwpKSB7CiAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CiAgICAgICAgfQogICAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwogICAgICB9CgogICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSB0cnVlOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KICAgICAgLy8gYmUgcmVjdXJzaXZlbHkgbmVzdGVkIHdpdGhpbiBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IGZhbHNlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuIGB1bnNldGAgaXMgYSBub29wCiAgICAvLyBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuCiAgICB1bnNldDogZnVuY3Rpb24oYXR0ciwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0ciwgdm9pZCAwLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBDbGVhciBhbGwgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLgogICAgY2xlYXI6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmF0dHJpYnV0ZXMpIGF0dHJzW2tleV0gPSB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRycywgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgogICAgLy8gSWYgeW91IHNwZWNpZnkgYW4gYXR0cmlidXRlIG5hbWUsIGRldGVybWluZSBpZiB0aGF0IGF0dHJpYnV0ZSBoYXMgY2hhbmdlZC4KICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCkgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5jaGFuZ2VkKTsKICAgICAgcmV0dXJuIF8uaGFzKHRoaXMuY2hhbmdlZCwgYXR0cik7CiAgICB9LAoKICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCiAgICAvLyBmYWxzZSBpZiB0aGVyZSBhcmUgbm8gY2hhbmdlZCBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIGRldGVybWluaW5nIHdoYXQKICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCiAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICAvLyBZb3UgY2FuIGFsc28gcGFzcyBhbiBhdHRyaWJ1dGVzIG9iamVjdCB0byBkaWZmIGFnYWluc3QgdGhlIG1vZGVsLAogICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbihkaWZmKSB7CiAgICAgIGlmICghZGlmZikgcmV0dXJuIHRoaXMuaGFzQ2hhbmdlZCgpID8gXy5jbG9uZSh0aGlzLmNoYW5nZWQpIDogZmFsc2U7CiAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgdmFyIG9sZCA9IHRoaXMuX2NoYW5naW5nID8gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIDogdGhpcy5hdHRyaWJ1dGVzOwogICAgICBmb3IgKHZhciBhdHRyIGluIGRpZmYpIHsKICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7CiAgICAgICAgKGNoYW5nZWQgfHwgKGNoYW5nZWQgPSB7fSkpW2F0dHJdID0gdmFsOwogICAgICB9CiAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHByZXZpb3VzIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZSwgcmVjb3JkZWQgYXQgdGhlIHRpbWUgdGhlIGxhc3QKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgcHJldmlvdXM6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCB8fCAhdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKICAgIH0sCgogICAgLy8gR2V0IGFsbCBvZiB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgYXQgdGhlIHRpbWUgb2YgdGhlIHByZXZpb3VzCiAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgogICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQogICAgLy8gbW9kZWwgZGlmZmVycyBmcm9tIGl0cyBjdXJyZW50IGF0dHJpYnV0ZXMsIHRoZXkgd2lsbCBiZSBvdmVycmlkZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyksIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLgogICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoa2V5ID09IG51bGwgfHwgdHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CgogICAgICBvcHRpb25zID0gXy5leHRlbmQoe3ZhbGlkYXRlOiB0cnVlfSwgb3B0aW9ucyk7CgogICAgICAvLyBJZiB3ZSdyZSBub3Qgd2FpdGluZyBhbmQgYXR0cmlidXRlcyBleGlzdCwgc2F2ZSBhY3RzIGFzCiAgICAgIC8vIGBzZXQoYXR0cikuc2F2ZShudWxsLCBvcHRzKWAgd2l0aCB2YWxpZGF0aW9uLiBPdGhlcndpc2UsIGNoZWNrIGlmCiAgICAgIC8vIHRoZSBtb2RlbCB3aWxsIGJlIHZhbGlkIHdoZW4gdGhlIGF0dHJpYnV0ZXMsIGlmIGFueSwgYXJlIHNldC4KICAgICAgaWYgKGF0dHJzICYmICFvcHRpb25zLndhaXQpIHsKICAgICAgICBpZiAoIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIC8vIFNldCB0ZW1wb3JhcnkgYXR0cmlidXRlcyBpZiBge3dhaXQ6IHRydWV9YC4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgewogICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IF8uZXh0ZW5kKHt9LCBhdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgIH0KCiAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBzZXJ2ZXItc2lkZSBzYXZlLCB0aGUgY2xpZW50IGlzIChvcHRpb25hbGx5KQogICAgICAvLyB1cGRhdGVkIHdpdGggdGhlIHNlcnZlci1zaWRlIHN0YXRlLgogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICAvLyBFbnN1cmUgYXR0cmlidXRlcyBhcmUgcmVzdG9yZWQgZHVyaW5nIHN5bmNocm9ub3VzIHNhdmVzLgogICAgICAgIG1vZGVsLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwogICAgICAgIHZhciBzZXJ2ZXJBdHRycyA9IG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLndhaXQpIHNlcnZlckF0dHJzID0gXy5leHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsKICAgICAgICBpZiAoXy5pc09iamVjdChzZXJ2ZXJBdHRycykgJiYgIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCiAgICAgIG1ldGhvZCA9IHRoaXMuaXNOZXcoKSA/ICdjcmVhdGUnIDogKG9wdGlvbnMucGF0Y2ggPyAncGF0Y2gnIDogJ3VwZGF0ZScpOwogICAgICBpZiAobWV0aG9kID09PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7CiAgICAgIHhociA9IHRoaXMuc3luYyhtZXRob2QsIHRoaXMsIG9wdGlvbnMpOwoKICAgICAgLy8gUmVzdG9yZSBhdHRyaWJ1dGVzLgogICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwoKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVzdHJveSB0aGlzIG1vZGVsIG9uIHRoZSBzZXJ2ZXIgaWYgaXQgd2FzIGFscmVhZHkgcGVyc2lzdGVkLgogICAgLy8gT3B0aW1pc3RpY2FsbHkgcmVtb3ZlcyB0aGUgbW9kZWwgZnJvbSBpdHMgY29sbGVjdGlvbiwgaWYgaXQgaGFzIG9uZS4KICAgIC8vIElmIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIHdhaXRzIGZvciB0aGUgc2VydmVyIHRvIHJlc3BvbmQgYmVmb3JlIHJlbW92YWwuCiAgICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCiAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbW9kZWwudHJpZ2dlcignZGVzdHJveScsIG1vZGVsLCBtb2RlbC5jb2xsZWN0aW9uLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0IHx8IG1vZGVsLmlzTmV3KCkpIGRlc3Ryb3koKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKCFtb2RlbC5pc05ldygpKSBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgewogICAgICAgIG9wdGlvbnMuc3VjY2VzcygpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCiAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CiAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgdXJsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHJldHVybiBiYXNlOwogICAgICByZXR1cm4gYmFzZSArIChiYXNlLmNoYXJBdChiYXNlLmxlbmd0aCAtIDEpID09PSAnLycgPyAnJyA6ICcvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOwogICAgfSwKCiAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuCiAgICBpc1ZhbGlkOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CiAgICB9LAoKICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsCiAgICAvLyByZXR1cm5pbmcgYHRydWVgIGlmIGFsbCBpcyB3ZWxsLiBPdGhlcndpc2UsIGZpcmUgYW4gYCJpbnZhbGlkImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghb3B0aW9ucy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRpb25FcnJvciA9IHRoaXMudmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpIHx8IG51bGw7CiAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwogICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBlcnJvciwgXy5leHRlbmQob3B0aW9ucywge3ZhbGlkYXRpb25FcnJvcjogZXJyb3J9KSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBNb2RlbC4KICB2YXIgbW9kZWxNZXRob2RzID0gWydrZXlzJywgJ3ZhbHVlcycsICdwYWlycycsICdpbnZlcnQnLCAncGljaycsICdvbWl0J107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYE1vZGVsI2F0dHJpYnV0ZXNgLgogIF8uZWFjaChtb2RlbE1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgTW9kZWwucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSWYgbW9kZWxzIHRlbmQgdG8gcmVwcmVzZW50IGEgc2luZ2xlIHJvdyBvZiBkYXRhLCBhIEJhY2tib25lIENvbGxlY3Rpb24gaXMKICAvLyBtb3JlIGFuYWxhZ291cyB0byBhIHRhYmxlIGZ1bGwgb2YgZGF0YSAuLi4gb3IgYSBzbWFsbCBzbGljZSBvciBwYWdlIG9mIHRoYXQKICAvLyB0YWJsZSwgb3IgYSBjb2xsZWN0aW9uIG9mIHJvd3MgdGhhdCBiZWxvbmcgdG9nZXRoZXIgZm9yIGEgcGFydGljdWxhciByZWFzb24KICAvLyAtLSBhbGwgb2YgdGhlIG1lc3NhZ2VzIGluIHRoaXMgcGFydGljdWxhciBmb2xkZXIsIGFsbCBvZiB0aGUgZG9jdW1lbnRzCiAgLy8gYmVsb25naW5nIHRvIHRoaXMgcGFydGljdWxhciBhdXRob3IsIGFuZCBzbyBvbi4gQ29sbGVjdGlvbnMgbWFpbnRhaW4KICAvLyBpbmRleGVzIG9mIHRoZWlyIG1vZGVscywgYm90aCBpbiBvcmRlciwgYW5kIGZvciBsb29rdXAgYnkgYGlkYC4KCiAgLy8gQ3JlYXRlIGEgbmV3ICoqQ29sbGVjdGlvbioqLCBwZXJoYXBzIHRvIGNvbnRhaW4gYSBzcGVjaWZpYyB0eXBlIG9mIGBtb2RlbGAuCiAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fcmVzZXQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgfTsKCiAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgogIHZhciBzZXRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiB0cnVlLCBtZXJnZTogdHJ1ZX07CiAgdmFyIGFkZE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IGZhbHNlfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4KICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZXh0ZW5kKHttZXJnZTogZmFsc2V9LCBvcHRpb25zLCBhZGRPcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyBbbW9kZWxzXSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXSA9IHRoaXMuZ2V0KG1vZGVsc1tpXSk7CiAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmNpZF07CiAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwogICAgfSwKCiAgICAvLyBVcGRhdGUgYSBjb2xsZWN0aW9uIGJ5IGBzZXRgLWluZyBhIG5ldyBsaXN0IG9mIG1vZGVscywgYWRkaW5nIG5ldyBvbmVzLAogICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAogICAgLy8gYWxyZWFkeSBleGlzdCBpbiB0aGUgY29sbGVjdGlvbiwgYXMgbmVjZXNzYXJ5LiBTaW1pbGFyIHRvICoqTW9kZWwjc2V0KiosCiAgICAvLyB0aGUgY29yZSBvcGVyYXRpb24gZm9yIHVwZGF0aW5nIHRoZSBkYXRhIGNvbnRhaW5lZCBieSB0aGUgY29sbGVjdGlvbi4KICAgIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXRPcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzLCBvcHRpb25zKTsKICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwogICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IChtb2RlbHMgPyBbbW9kZWxzXSA6IFtdKSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgdmFyIGksIGwsIGlkLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBzb3J0OwogICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwogICAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwogICAgICB2YXIgc29ydGFibGUgPSB0aGlzLmNvbXBhcmF0b3IgJiYgKGF0ID09IG51bGwpICYmIG9wdGlvbnMuc29ydCAhPT0gZmFsc2U7CiAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CiAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CiAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBhdHRycyA9IG1vZGVsc1tpXTsKICAgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgICAgaWQgPSBtb2RlbCA9IGF0dHJzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZCA9IGF0dHJzW3RhcmdldE1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZV07CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nID0gdGhpcy5nZXQoaWQpKSB7CiAgICAgICAgICBpZiAocmVtb3ZlKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKICAgICAgICAgIGlmIChtZXJnZSkgewogICAgICAgICAgICBhdHRycyA9IGF0dHJzID09PSBtb2RlbCA/IG1vZGVsLmF0dHJpYnV0ZXMgOiBhdHRyczsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBleGlzdGluZy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoc29ydGFibGUgJiYgIXNvcnQgJiYgZXhpc3RpbmcuaGFzQ2hhbmdlZChzb3J0QXR0cikpIHNvcnQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgbW9kZWxzW2ldID0gZXhpc3Rpbmc7CgogICAgICAgIC8vIElmIHRoaXMgaXMgYSBuZXcsIHZhbGlkIG1vZGVsLCBwdXNoIGl0IHRvIHRoZSBgdG9BZGRgIGxpc3QuCiAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKICAgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgICAgdG9BZGQucHVzaChtb2RlbCk7CgogICAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAgIC8vIGBpZGAgYW5kIGJ5IGBjaWRgLgogICAgICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICAgIH0KICAgICAgICBpZiAob3JkZXIpIG9yZGVyLnB1c2goZXhpc3RpbmcgfHwgbW9kZWwpOwogICAgICB9CgogICAgICAvLyBSZW1vdmUgbm9uZXhpc3RlbnQgbW9kZWxzIGlmIGFwcHJvcHJpYXRlLgogICAgICBpZiAocmVtb3ZlKSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICBpZiAoIW1vZGVsTWFwWyhtb2RlbCA9IHRoaXMubW9kZWxzW2ldKS5jaWRdKSB0b1JlbW92ZS5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRvUmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUodG9SZW1vdmUsIG9wdGlvbnMpOwogICAgICB9CgogICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCiAgICAgIGlmICh0b0FkZC5sZW5ndGggfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHsKICAgICAgICBpZiAoc29ydGFibGUpIHNvcnQgPSB0cnVlOwogICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoYXQgKyBpLCAwLCB0b0FkZFtpXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChvcmRlcikgdGhpcy5tb2RlbHMubGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBvcmRlcmVkTW9kZWxzID0gb3JkZXIgfHwgdG9BZGQ7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gb3JkZXJlZE1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5tb2RlbHMucHVzaChvcmRlcmVkTW9kZWxzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChzb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoKICAgICAgLy8gVW5sZXNzIHNpbGVuY2VkLCBpdCdzIHRpbWUgdG8gZmlyZSBhbGwgYXBwcm9wcmlhdGUgYWRkL3NvcnQgZXZlbnRzLgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvcnQgfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIAogICAgICAvLyBSZXR1cm4gdGhlIGFkZGVkIChvciBtZXJnZWQpIG1vZGVsIChvciBtb2RlbHMpLgogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgLy8gVXNlZnVsIGZvciBidWxrIG9wZXJhdGlvbnMgYW5kIG9wdGltaXphdGlvbnMuCiAgICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldKTsKICAgICAgfQogICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHM7CiAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICAgIG1vZGVscyA9IHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdyZXNldCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWxzOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IHRoaXMubGVuZ3RofSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgogICAgc2xpY2U6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc2xpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KICAgIGdldDogZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuX2J5SWRbb2JqLmlkXSB8fCB0aGlzLl9ieUlkW29iai5jaWRdIHx8IHRoaXMuX2J5SWRbb2JqXTsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzW2luZGV4XTsKICAgIH0sCgogICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mCiAgICAvLyBgZmlsdGVyYC4KICAgIHdoZXJlOiBmdW5jdGlvbihhdHRycywgZmlyc3QpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBmaXJzdCA/IHZvaWQgMCA6IFtdOwogICAgICByZXR1cm4gdGhpc1tmaXJzdCA/ICdmaW5kJyA6ICdmaWx0ZXInXShmdW5jdGlvbihtb2RlbCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KTsKICAgIH0sCgogICAgLy8gUmV0dXJuIHRoZSBmaXJzdCBtb2RlbCB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzCiAgICAvLyBvZiBgZmluZGAuCiAgICBmaW5kV2hlcmU6IGZ1bmN0aW9uKGF0dHJzKSB7CiAgICAgIHJldHVybiB0aGlzLndoZXJlKGF0dHJzLCB0cnVlKTsKICAgIH0sCgogICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcgogICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQogICAgLy8gaXMgYWRkZWQuCiAgICBzb3J0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gc29ydCBiYXNlZCBvbiB0eXBlIG9mIGBjb21wYXJhdG9yYC4KICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOwogICAgICB9CgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFBsdWNrIGFuIGF0dHJpYnV0ZSBmcm9tIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICBwbHVjazogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCiAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKICAgIC8vIGRhdGEgd2lsbCBiZSBwYXNzZWQgdGhyb3VnaCB0aGUgYHJlc2V0YCBtZXRob2QgaW5zdGVhZCBvZiBgc2V0YC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBjb2xsZWN0aW9uLnRyaWdnZXIoJ3N5bmMnLCBjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgogICAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpKSkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFByaXZhdGUgbWV0aG9kIHRvIHJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24KICAgIC8vIGlzIGZpcnN0IGluaXRpYWxpemVkIG9yIHJlc2V0LgogICAgX3Jlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICB0aGlzLm1vZGVscyA9IFtdOwogICAgICB0aGlzLl9ieUlkICA9IHt9OwogICAgfSwKCiAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwogICAgLy8gY29sbGVjdGlvbi4KICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSB7CiAgICAgICAgaWYgKCFhdHRycy5jb2xsZWN0aW9uKSBhdHRycy5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgICByZXR1cm4gYXR0cnM7CiAgICAgIH0KICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC52YWxpZGF0aW9uRXJyb3IpIHJldHVybiBtb2RlbDsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgbW9kZWwudmFsaWRhdGlvbkVycm9yLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V2ZXIgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgogIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEJhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCiAgLy8gcmlnaHQgaGVyZToKICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdjb2xsZWN0JywgJ3JlZHVjZScsICdmb2xkbCcsCiAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAogICAgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsICdjb250YWlucycsICdpbnZva2UnLAogICAgJ21heCcsICdtaW4nLCAndG9BcnJheScsICdzaXplJywgJ2ZpcnN0JywgJ2hlYWQnLCAndGFrZScsICdpbml0aWFsJywgJ3Jlc3QnLAogICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnZGlmZmVyZW5jZScsICdpbmRleE9mJywgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknLCAnY2hhaW4nXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIEJhY2tib25lIFZpZXdzIGFyZSBhbG1vc3QgbW9yZSBjb252ZW50aW9uIHRoYW4gdGhleSBhcmUgYWN0dWFsIGNvZGUuIEEgVmlldwogIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCiAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCiAgLy8gZXZlbiB0aGUgc3Vycm91bmRpbmcgZnJhbWUgd2hpY2ggd3JhcHMgeW91ciB3aG9sZSBhcHAuIERlZmluaW5nIGEgY2h1bmsgb2YKICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CiAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCiAgLy8gcmVhY3QgdG8gc3BlY2lmaWMgY2hhbmdlcyBpbiB0aGUgc3RhdGUgb2YgeW91ciBtb2RlbHMuCgogIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAogIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCiAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwoKICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KICAgIHRhZ05hbWU6ICdkaXYnLAoKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICB9LAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgIC8vCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgLy8KICAgIC8vICAgICB7CiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScsCiAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9CiAgICAvLyAgICAgfQogICAgLy8KICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5LgogICAgLy8gVXNlcyBldmVudCBkZWxlZ2F0aW9uIGZvciBlZmZpY2llbmN5LgogICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuCiAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQKICAgIC8vIG5vdCBgY2hhbmdlYCwgYHN1Ym1pdGAsIGFuZCBgcmVzZXRgIGluIEludGVybmV0IEV4cGxvcmVyLgogICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm4gdGhpczsKICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpIGNvbnRpbnVlOwoKICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKICAgICAgICB2YXIgZXZlbnROYW1lID0gbWF0Y2hbMV0sIHNlbGVjdG9yID0gbWF0Y2hbMl07CiAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CiAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgaWYgKHNlbGVjdG9yID09PSAnJykgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIHNlbGVjdG9yLCBtZXRob2QpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBWaWV3IGhhcyBhIERPTSBlbGVtZW50IHRvIHJlbmRlciBpbnRvLgogICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CiAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCiAgICAvLyBhbiBlbGVtZW50IGZyb20gdGhlIGBpZGAsIGBjbGFzc05hbWVgIGFuZCBgdGFnTmFtZWAgcHJvcGVydGllcy4KICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgIGlmICh0aGlzLmlkKSBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CiAgICAgICAgdmFyICRlbCA9IEJhY2tib25lLiQoJzwnICsgXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSArICc+JykuYXR0cihhdHRycyk7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KCRlbCwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiBub1hoclBhdGNoKSB7CiAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgICAgIH07CiAgICB9CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CgogIHZhciBub1hoclBhdGNoID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgISF3aW5kb3cuQWN0aXZlWE9iamVjdCAmJiAhKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCAmJiAobmV3IFhNTEh0dHBSZXF1ZXN0KS5kaXNwYXRjaEV2ZW50KTsKCiAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uCiAgdmFyIG1ldGhvZE1hcCA9IHsKICAgICdjcmVhdGUnOiAnUE9TVCcsCiAgICAndXBkYXRlJzogJ1BVVCcsCiAgICAncGF0Y2gnOiAgJ1BBVENIJywKICAgICdkZWxldGUnOiAnREVMRVRFJywKICAgICdyZWFkJzogICAnR0VUJwogIH07CgogIC8vIFNldCB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBgQmFja2JvbmUuYWpheGAgdG8gcHJveHkgdGhyb3VnaCB0byBgJGAuCiAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBCYWNrYm9uZS4kLmFqYXguYXBwbHkoQmFja2JvbmUuJCwgYXJndW1lbnRzKTsKICB9OwoKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gICAgPSAvKFwoXD8pPzpcdysvZzsKICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwogIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKICAgIC8vCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAvLyAgICAgICAuLi4KICAgIC8vICAgICB9KTsKICAgIC8vCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgICBjYWxsYmFjayA9IG5hbWU7CiAgICAgICAgbmFtZSA9ICcnOwogICAgICB9CiAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgICAgdmFyIHJvdXRlciA9IHRoaXM7CiAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkocm91dGVyLCBhcmdzKTsKICAgICAgICByb3V0ZXIudHJpZ2dlci5hcHBseShyb3V0ZXIsIFsncm91dGU6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgcm91dGVyLnRyaWdnZXIoJ3JvdXRlJywgbmFtZSwgYXJncyk7CiAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHJvdXRlciwgbmFtZSwgYXJncyk7CiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQogICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAogICAgLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4KICAgIF9iaW5kUm91dGVzOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLnJvdXRlcykgcmV0dXJuOwogICAgICB0aGlzLnJvdXRlcyA9IF8ucmVzdWx0KHRoaXMsICdyb3V0ZXMnKTsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCkgewogICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uYWwgPyBtYXRjaCA6ICcoW15cL10rKSc7CiAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyguKj8pJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyQnKTsKICAgIH0sCgogICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgogICAgLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQogICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewogICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtKSB7CiAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CiAgICAgIH0pOwogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuSGlzdG9yeQogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCiAgLy8gW3B1c2hTdGF0ZV0oaHR0cDovL2RpdmVpbnRvaHRtbDUuaW5mby9oaXN0b3J5Lmh0bWwpIGFuZCByZWFsIFVSTHMsIG9yCiAgLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCiAgLy8gZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgdXJscyBvZiBoYXNoIGFuZCBxdWVyeS4KICB2YXIgcGF0aFN0cmlwcGVyID0gL1s/I10uKiQvOwoKICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CiAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgaW50ZXJ2YWwgdG8gcG9sbCBmb3IgaGFzaCBjaGFuZ2VzLCBpZiBuZWNlc3NhcnksIGlzCiAgICAvLyB0d2VudHkgdGltZXMgYSBzZWNvbmQuCiAgICBpbnRlcnZhbDogNTAsCgogICAgLy8gR2V0cyB0aGUgdHJ1ZSBoYXNoIHZhbHVlLiBDYW5ub3QgdXNlIGxvY2F0aW9uLmhhc2ggZGlyZWN0bHkgZHVlIHRvIGJ1ZwogICAgLy8gaW4gRmlyZWZveCB3aGVyZSBsb2NhdGlvbi5oYXNoIHdpbGwgYWx3YXlzIGJlIGRlY29kZWQuCiAgICBnZXRIYXNoOiBmdW5jdGlvbih3aW5kb3cpIHsKICAgICAgdmFyIG1hdGNoID0gKHdpbmRvdyB8fCB0aGlzKS5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLAogICAgLy8gdGhlIGhhc2gsIG9yIHRoZSBvdmVycmlkZS4KICAgIGdldEZyYWdtZW50OiBmdW5jdGlvbihmcmFnbWVudCwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgaWYgKGZyYWdtZW50ID09IG51bGwpIHsKICAgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlIHx8ICF0aGlzLl93YW50c0hhc2hDaGFuZ2UgfHwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5sb2NhdGlvbi5wYXRobmFtZTsKICAgICAgICAgIHZhciByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwogICAgICAgICAgaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnNsaWNlKHJvb3QubGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgfSwKCiAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCiAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CgogICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwogICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwogICAgICB0aGlzLm9wdGlvbnMgICAgICAgICAgPSBfLmV4dGVuZCh7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLmlmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CiAgICAgIHZhciBhdFJvb3QgPSBsb2MucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CgogICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQogICAgICAvLyByZXF1ZXN0ZWQuCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCiAgICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkCiAgICAgICAgLy8gYnJvd3NlciwgYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhYXRSb290KSB7CiAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChudWxsLCB0cnVlKTsKICAgICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICAgIH0gZWxzZSBpZiAodGhpcy5faGFzUHVzaFN0YXRlICYmIGF0Um9vdCAmJiBsb2MuaGFzaCkgewogICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQgKyBsb2Muc2VhcmNoKTsKICAgICAgICB9CgogICAgICB9CgogICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogICAgfSwKCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50KTsKICAgICAgcmV0dXJuIF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgIC8vCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiAhIW9wdGlvbnN9OwoKICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIChmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQgfHwgJycpKTsKCiAgICAgIC8vIFN0cmlwIHRoZSBmcmFnbWVudCBvZiB0aGUgcXVlcnkgYW5kIGhhc2ggZm9yIG1hdGNoaW5nLgogICAgICBmcmFnbWVudCA9IGZyYWdtZW50LnJlcGxhY2UocGF0aFN0cmlwcGVyLCAnJyk7CgogICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHJldHVybjsKICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwoKICAgICAgLy8gRG9uJ3QgaW5jbHVkZSBhIHRyYWlsaW5nIHNsYXNoIG9uIHRoZSByb290LgogICAgICBpZiAoZnJhZ21lbnQgPT09ICcnICYmIHVybCAhPT0gJy8nKSB1cmwgPSB1cmwuc2xpY2UoMCwgLTEpOwoKICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgogICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAogICAgICAvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgaWYgKHRoaXMuaWZyYW1lICYmIChmcmFnbWVudCAhPT0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKSkpIHsKICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQogICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKICAgICAgICAgIC8vIHdhbnQgdGhpcy4KICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOwogICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgfQoKICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCiAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpIHJldHVybiB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwogICAgfSwKCiAgICAvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwogICAgLy8gYSBuZXcgb25lIHRvIHRoZSBicm93c2VyIGhpc3RvcnkuCiAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsKICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLgogICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKICAgICAgfQogICAgfQoKICB9KTsKCiAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCiAgQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5OwoKICAvLyBIZWxwZXJzCiAgLy8gLS0tLS0tLQoKICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpczsKICAgIHZhciBjaGlsZDsKCiAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CiAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewogICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CiAgICB9IGVsc2UgewogICAgICBjaGlsZCA9IGZ1bmN0aW9uKCl7IHJldHVybiBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKICAgIH0KCiAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KICAgIF8uZXh0ZW5kKGNoaWxkLCBwYXJlbnQsIHN0YXRpY1Byb3BzKTsKCiAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwogICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgIHZhciBTdXJyb2dhdGUgPSBmdW5jdGlvbigpeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH07CiAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGU7CgogICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCiAgICAvLyBpZiBzdXBwbGllZC4KICAgIGlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKICAgIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQKICAgIC8vIGxhdGVyLgogICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCiAgICByZXR1cm4gY2hpbGQ7CiAgfTsKCiAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciB0aGUgbW9kZWwsIGNvbGxlY3Rpb24sIHJvdXRlciwgdmlldyBhbmQgaGlzdG9yeS4KICBNb2RlbC5leHRlbmQgPSBDb2xsZWN0aW9uLmV4dGVuZCA9IFJvdXRlci5leHRlbmQgPSBWaWV3LmV4dGVuZCA9IEhpc3RvcnkuZXh0ZW5kID0gZXh0ZW5kOwoKICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCiAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24oKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0EgInVybCIgcHJvcGVydHkgb3IgZnVuY3Rpb24gbXVzdCBiZSBzcGVjaWZpZWQnKTsKICB9OwoKICAvLyBXcmFwIGFuIG9wdGlvbmFsIGVycm9yIGNhbGxiYWNrIHdpdGggYSBmYWxsYmFjayBlcnJvciBldmVudC4KICB2YXIgd3JhcEVycm9yID0gZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgIHZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7CiAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24ocmVzcCkgewogICAgICBpZiAoZXJyb3IpIGVycm9yKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICB9OwogIH07CgogIHJldHVybiBCYWNrYm9uZTsKfSkpOwoKLy8gYmFja2JvbmUtc3Vicm91dGUuanMgdjAuNC4yCi8vCi8vIENvcHlyaWdodCAoQykgMjAxMiBEYXZlIENhZHdhbGxhZGVyLCBNb2RlbCBOLCBJbmMuICAKLy8gRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlCi8vCi8vIERvY3VtZW50YXRpb24gYW5kIGZ1bGwgbGljZW5zZSBhdmFpbGFibGUgYXQ6Ci8vIGh0dHBzOi8vZ2l0aHViLmNvbS9Nb2RlbE4vYmFja2JvbmUuc3Vicm91dGUKCihmdW5jdGlvbihmYWN0b3J5KSB7CiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgLy8gUmVnaXN0ZXIgYXMgYW4gQU1EIG1vZHVsZSBpZiBhdmFpbGFibGUuLi4KICAgICAgICBkZWZpbmUoJ2JhY2tib25lLnN1YnJvdXRlJyxbJ3VuZGVyc2NvcmUnLCAnYmFja2JvbmUnXSwgZmFjdG9yeSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewogICAgICAgIC8vIE5leHQgZm9yIE5vZGUuanMsIENvbW1vbkpTLCBicm93c2VyaWZ5Li4uCiAgICAgICAgZmFjdG9yeShyZXF1aXJlKCd1bmRlcnNjb3JlJyksIHJlcXVpcmUoJ2JhY2tib25lJykpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBCcm93c2VyIGdsb2JhbHMgZm9yIHRoZSB1bmVubGlnaHRlbmVkLi4uCiAgICAgICAgZmFjdG9yeShfLCBCYWNrYm9uZSk7CiAgICB9Cn0oZnVuY3Rpb24oXywgQmFja2JvbmUpIHsKCiAgICBCYWNrYm9uZS5TdWJSb3V0ZSA9IEJhY2tib25lLlJvdXRlci5leHRlbmQoewogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihwcmVmaXgsIG9wdGlvbnMpIHsKCiAgICAgICAgICAgIC8vIGVhY2ggc3Vicm91dGUgaW5zdGFuY2Ugc2hvdWxkIGhhdmUgaXRzIG93biByb3V0ZXMgaGFzaAogICAgICAgICAgICB0aGlzLnJvdXRlcyA9IF8uY2xvbmUodGhpcy5yb3V0ZXMpIHx8IHt9OwoKICAgICAgICAgICAgLy8gUHJlZml4IGlzIG9wdGlvbmFsLCBzZXQgdG8gZW1wdHkgc3RyaW5nIGlmIG5vdCBwYXNzZWQKICAgICAgICAgICAgdGhpcy5wcmVmaXggPSBwcmVmaXggPSBwcmVmaXggfHwgIiI7CgogICAgICAgICAgICAvLyBTdWJSb3V0ZSBpbnN0YW5jZXMgbWF5IGJlIGluc3RhbnRpYXRlZCB1c2luZyBhIHByZWZpeCB3aXRoIG9yIHdpdGhvdXQgYSB0cmFpbGluZyBzbGFzaC4KICAgICAgICAgICAgLy8gSWYgdGhlIHByZWZpeCBkb2VzICpub3QqIGhhdmUgYSB0cmFpbGluZyBzbGFzaCwgd2UgbmVlZCB0byBpbnNlcnQgYSBzbGFzaCBhcyBhIHNlcGFyYXRvcgogICAgICAgICAgICAvLyBiZXR3ZWVuIHRoZSBwcmVmaXggYW5kIHRoZSBzdWItcm91dGUgcGF0aCBmb3IgZWFjaCByb3V0ZSB0aGF0IHdlIHJlZ2lzdGVyIHdpdGggQmFja2JvbmUuICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXBhcmF0b3IgPSAocHJlZml4LnNsaWNlKC0xKSA9PT0gIi8iKSA/ICIiIDogIi8iOwoKICAgICAgICAgICAgLy8gaWYgeW91IHdhbnQgdG8gbWF0Y2ggImJvb2tzIiBhbmQgImJvb2tzLyIgd2l0aG91dCBjcmVhdGluZyBzZXBhcmF0ZSByb3V0ZXMsIHNldCB0aGlzCiAgICAgICAgICAgIC8vIG9wdGlvbiB0byAidHJ1ZSIgYW5kIHRoZSBzdWItcm91dGVyIHdpbGwgYXV0b21hdGljYWxseSBjcmVhdGUgdGhvc2Ugcm91dGVzIGZvciB5b3UuCiAgICAgICAgICAgIHRoaXMuY3JlYXRlVHJhaWxpbmdTbGFzaFJvdXRlcyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5jcmVhdGVUcmFpbGluZ1NsYXNoUm91dGVzOwoKICAgICAgICAgICAgLy8gUmVxdWlyZWQgdG8gaGF2ZSBCYWNrYm9uZSBzZXQgdXAgcm91dGVzCiAgICAgICAgICAgIEJhY2tib25lLlJvdXRlci5wcm90b3R5cGUuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBvcHRpb25zKTsKCiAgICAgICAgICAgIC8vIGdyYWIgdGhlIGZ1bGwgVVJMCiAgICAgICAgICAgIHZhciBoYXNoOwogICAgICAgICAgICBpZiAoQmFja2JvbmUuaGlzdG9yeS5mcmFnbWVudCkgewogICAgICAgICAgICAgICAgaGFzaCA9IEJhY2tib25lLmhpc3RvcnkuZ2V0RnJhZ21lbnQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhhc2ggPSBCYWNrYm9uZS5oaXN0b3J5LmdldEhhc2goKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVHJpZ2dlciB0aGUgc3Vicm91dGUgaW1tZWRpYXRlbHkuICB0aGlzIHN1cHBvcnRzIHRoZSBjYXNlIHdoZXJlIAogICAgICAgICAgICAvLyBhIHVzZXIgZGlyZWN0bHkgbmF2aWdhdGVzIHRvIGEgVVJMIHdpdGggYSBzdWJyb3V0ZSBvbiB0aGUgZmlyc3QgcGFnZSBsb2FkLgogICAgICAgICAgICAvLyBDaGVjayBldmVyeSBlbGVtZW50LCBpZiBvbmUgbWF0Y2hlcywgYnJlYWsuIFByZXZlbnQgbXVsdGlwbGUgbWF0Y2hlcwogICAgICAgICAgICBfLmV2ZXJ5KHRoaXMucm91dGVzLCBmdW5jdGlvbihrZXksIHJvdXRlKSB7CiAgICAgICAgICAgICAgICAvLyBVc2UgdGhlIEJhY2tib25lIHBhcnNlciB0byB0dXJuIHJvdXRlIGludG8gcmVnZXggZm9yIG1hdGNoaW5nCiAgICAgICAgICAgICAgICBpZiAoaGFzaC5tYXRjaChCYWNrYm9uZS5Sb3V0ZXIucHJvdG90eXBlLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKSkpIHsKICAgICAgICAgICAgICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LmxvYWRVcmwoaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAgICAgaWYgKHRoaXMucG9zdEluaXRpYWxpemUpIHsKICAgICAgICAgICAgICAgIHRoaXMucG9zdEluaXRpYWxpemUob3B0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG5hdmlnYXRlOiBmdW5jdGlvbihyb3V0ZSwgb3B0aW9ucykgewogICAgICAgICAgICBpZiAocm91dGUuc3Vic3RyKDAsIDEpICE9ICcvJyAmJgogICAgICAgICAgICAgICAgcm91dGUuaW5kZXhPZih0aGlzLnByZWZpeC5zdWJzdHIoMCwgdGhpcy5wcmVmaXgubGVuZ3RoIC0gMSkpICE9PSAwKSB7CgogICAgICAgICAgICAgICAgcm91dGUgPSB0aGlzLnByZWZpeCArCiAgICAgICAgICAgICAgICAgICAgKHJvdXRlID8gdGhpcy5zZXBhcmF0b3IgOiAiIikgKwogICAgICAgICAgICAgICAgICAgIHJvdXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEJhY2tib25lLlJvdXRlci5wcm90b3R5cGUubmF2aWdhdGUuY2FsbCh0aGlzLCByb3V0ZSwgb3B0aW9ucyk7CiAgICAgICAgfSwKICAgICAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIC8vIHN0cmlwIG9mZiBhbnkgbGVhZGluZyBzbGFzaGVzIGluIHRoZSBzdWItcm91dGUgcGF0aCwgCiAgICAgICAgICAgIC8vIHNpbmNlIHdlIGFscmVhZHkgaGFuZGxlIGluc2VydGluZyB0aGVtIHdoZW4gbmVlZGVkLgogICAgICAgICAgICBpZiAocm91dGUuc3Vic3RyKDApID09PSAiLyIpIHsKICAgICAgICAgICAgICAgIHJvdXRlID0gcm91dGUuc3Vic3RyKDEsIHJvdXRlLmxlbmd0aCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBfcm91dGUgPSB0aGlzLnByZWZpeDsKICAgICAgICAgICAgaWYgKHJvdXRlICYmIHJvdXRlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByZWZpeC5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgIF9yb3V0ZSArPSB0aGlzLnNlcGFyYXRvcjsKCiAgICAgICAgICAgICAgICBfcm91dGUgKz0gcm91dGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmNyZWF0ZVRyYWlsaW5nU2xhc2hSb3V0ZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMucm91dGVzW19yb3V0ZSArICcvJ10gPSBuYW1lOwogICAgICAgICAgICAgICAgQmFja2JvbmUuUm91dGVyLnByb3RvdHlwZS5yb3V0ZS5jYWxsKHRoaXMsIF9yb3V0ZSArICcvJywgbmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyByZW1vdmUgdGhlIHVuLXByZWZpeGVkIHJvdXRlIGZyb20gb3VyIHJvdXRlcyBoYXNoCiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnJvdXRlc1tyb3V0ZV07CgogICAgICAgICAgICAvLyBhZGQgdGhlIHByZWZpeGVkLXJvdXRlLiAgbm90ZSB0aGF0IHRoaXMgcm91dGVzIGhhc2ggaXMganVzdCBwcm92aWRlZCAKICAgICAgICAgICAgLy8gZm9yIGluZm9ybWF0aW9uYWwgYW5kIGRlYnVnZ2luZyBwdXJwb3NlcyBhbmQgaXMgbm90IHVzZWQgYnkgdGhlIGFjdHVhbCByb3V0aW5nIGNvZGUuCiAgICAgICAgICAgIHRoaXMucm91dGVzW19yb3V0ZV0gPSBuYW1lOwoKICAgICAgICAgICAgLy8gZGVsZWdhdGUgdGhlIGNyZWF0aW9uIG9mIHRoZSBwcm9wZXJseS1wcmVmaXhlZCByb3V0ZSB0byBCYWNrYm9uZQogICAgICAgICAgICByZXR1cm4gQmFja2JvbmUuUm91dGVyLnByb3RvdHlwZS5yb3V0ZS5jYWxsKHRoaXMsIF9yb3V0ZSwgbmFtZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIEJhY2tib25lLlN1YlJvdXRlOwp9KSk7CgovKgogICAganNvbjIuanMKICAgIDIwMTMtMDUtMjYKCiAgICBQdWJsaWMgRG9tYWluLgoKICAgIE5PIFdBUlJBTlRZIEVYUFJFU1NFRCBPUiBJTVBMSUVELiBVU0UgQVQgWU9VUiBPV04gUklTSy4KCiAgICBTZWUgaHR0cDovL3d3dy5KU09OLm9yZy9qcy5odG1sCgoKICAgIFRoaXMgY29kZSBzaG91bGQgYmUgbWluaWZpZWQgYmVmb3JlIGRlcGxveW1lbnQuCiAgICBTZWUgaHR0cDovL2phdmFzY3JpcHQuY3JvY2tmb3JkLmNvbS9qc21pbi5odG1sCgogICAgVVNFIFlPVVIgT1dOIENPUFkuIElUIElTIEVYVFJFTUVMWSBVTldJU0UgVE8gTE9BRCBDT0RFIEZST00gU0VSVkVSUyBZT1UgRE8KICAgIE5PVCBDT05UUk9MLgoKCiAgICBUaGlzIGZpbGUgY3JlYXRlcyBhIGdsb2JhbCBKU09OIG9iamVjdCBjb250YWluaW5nIHR3byBtZXRob2RzOiBzdHJpbmdpZnkKICAgIGFuZCBwYXJzZS4KCiAgICAgICAgSlNPTi5zdHJpbmdpZnkodmFsdWUsIHJlcGxhY2VyLCBzcGFjZSkKICAgICAgICAgICAgdmFsdWUgICAgICAgYW55IEphdmFTY3JpcHQgdmFsdWUsIHVzdWFsbHkgYW4gb2JqZWN0IG9yIGFycmF5LgoKICAgICAgICAgICAgcmVwbGFjZXIgICAgYW4gb3B0aW9uYWwgcGFyYW1ldGVyIHRoYXQgZGV0ZXJtaW5lcyBob3cgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcyBhcmUgc3RyaW5naWZpZWQgZm9yIG9iamVjdHMuIEl0IGNhbiBiZSBhCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN0cmluZ3MuCgogICAgICAgICAgICBzcGFjZSAgICAgICBhbiBvcHRpb25hbCBwYXJhbWV0ZXIgdGhhdCBzcGVjaWZpZXMgdGhlIGluZGVudGF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIG9mIG5lc3RlZCBzdHJ1Y3R1cmVzLiBJZiBpdCBpcyBvbWl0dGVkLCB0aGUgdGV4dCB3aWxsCiAgICAgICAgICAgICAgICAgICAgICAgIGJlIHBhY2tlZCB3aXRob3V0IGV4dHJhIHdoaXRlc3BhY2UuIElmIGl0IGlzIGEgbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICBpdCB3aWxsIHNwZWNpZnkgdGhlIG51bWJlciBvZiBzcGFjZXMgdG8gaW5kZW50IGF0IGVhY2gKICAgICAgICAgICAgICAgICAgICAgICAgbGV2ZWwuIElmIGl0IGlzIGEgc3RyaW5nIChzdWNoIGFzICdcdCcgb3IgJyZuYnNwOycpLAogICAgICAgICAgICAgICAgICAgICAgICBpdCBjb250YWlucyB0aGUgY2hhcmFjdGVycyB1c2VkIHRvIGluZGVudCBhdCBlYWNoIGxldmVsLgoKICAgICAgICAgICAgVGhpcyBtZXRob2QgcHJvZHVjZXMgYSBKU09OIHRleHQgZnJvbSBhIEphdmFTY3JpcHQgdmFsdWUuCgogICAgICAgICAgICBXaGVuIGFuIG9iamVjdCB2YWx1ZSBpcyBmb3VuZCwgaWYgdGhlIG9iamVjdCBjb250YWlucyBhIHRvSlNPTgogICAgICAgICAgICBtZXRob2QsIGl0cyB0b0pTT04gbWV0aG9kIHdpbGwgYmUgY2FsbGVkIGFuZCB0aGUgcmVzdWx0IHdpbGwgYmUKICAgICAgICAgICAgc3RyaW5naWZpZWQuIEEgdG9KU09OIG1ldGhvZCBkb2VzIG5vdCBzZXJpYWxpemU6IGl0IHJldHVybnMgdGhlCiAgICAgICAgICAgIHZhbHVlIHJlcHJlc2VudGVkIGJ5IHRoZSBuYW1lL3ZhbHVlIHBhaXIgdGhhdCBzaG91bGQgYmUgc2VyaWFsaXplZCwKICAgICAgICAgICAgb3IgdW5kZWZpbmVkIGlmIG5vdGhpbmcgc2hvdWxkIGJlIHNlcmlhbGl6ZWQuIFRoZSB0b0pTT04gbWV0aG9kCiAgICAgICAgICAgIHdpbGwgYmUgcGFzc2VkIHRoZSBrZXkgYXNzb2NpYXRlZCB3aXRoIHRoZSB2YWx1ZSwgYW5kIHRoaXMgd2lsbCBiZQogICAgICAgICAgICBib3VuZCB0byB0aGUgdmFsdWUKCiAgICAgICAgICAgIEZvciBleGFtcGxlLCB0aGlzIHdvdWxkIHNlcmlhbGl6ZSBEYXRlcyBhcyBJU08gc3RyaW5ncy4KCiAgICAgICAgICAgICAgICBEYXRlLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZihuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvcm1hdCBpbnRlZ2VycyB0byBoYXZlIGF0IGxlYXN0IHR3byBkaWdpdHMuCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuIDwgMTAgPyAnMCcgKyBuIDogbjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFVUQ0Z1bGxZZWFyKCkgICArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTW9udGgoKSArIDEpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENEYXRlKCkpICAgICAgKyAnVCcgKwogICAgICAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ0hvdXJzKCkpICAgICArICc6JyArCiAgICAgICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTWludXRlcygpKSAgICsgJzonICsKICAgICAgICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENTZWNvbmRzKCkpICAgKyAnWic7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgWW91IGNhbiBwcm92aWRlIGFuIG9wdGlvbmFsIHJlcGxhY2VyIG1ldGhvZC4gSXQgd2lsbCBiZSBwYXNzZWQgdGhlCiAgICAgICAgICAgIGtleSBhbmQgdmFsdWUgb2YgZWFjaCBtZW1iZXIsIHdpdGggdGhpcyBib3VuZCB0byB0aGUgY29udGFpbmluZwogICAgICAgICAgICBvYmplY3QuIFRoZSB2YWx1ZSB0aGF0IGlzIHJldHVybmVkIGZyb20geW91ciBtZXRob2Qgd2lsbCBiZQogICAgICAgICAgICBzZXJpYWxpemVkLiBJZiB5b3VyIG1ldGhvZCByZXR1cm5zIHVuZGVmaW5lZCwgdGhlbiB0aGUgbWVtYmVyIHdpbGwKICAgICAgICAgICAgYmUgZXhjbHVkZWQgZnJvbSB0aGUgc2VyaWFsaXphdGlvbi4KCiAgICAgICAgICAgIElmIHRoZSByZXBsYWNlciBwYXJhbWV0ZXIgaXMgYW4gYXJyYXkgb2Ygc3RyaW5ncywgdGhlbiBpdCB3aWxsIGJlCiAgICAgICAgICAgIHVzZWQgdG8gc2VsZWN0IHRoZSBtZW1iZXJzIHRvIGJlIHNlcmlhbGl6ZWQuIEl0IGZpbHRlcnMgdGhlIHJlc3VsdHMKICAgICAgICAgICAgc3VjaCB0aGF0IG9ubHkgbWVtYmVycyB3aXRoIGtleXMgbGlzdGVkIGluIHRoZSByZXBsYWNlciBhcnJheSBhcmUKICAgICAgICAgICAgc3RyaW5naWZpZWQuCgogICAgICAgICAgICBWYWx1ZXMgdGhhdCBkbyBub3QgaGF2ZSBKU09OIHJlcHJlc2VudGF0aW9ucywgc3VjaCBhcyB1bmRlZmluZWQgb3IKICAgICAgICAgICAgZnVuY3Rpb25zLCB3aWxsIG5vdCBiZSBzZXJpYWxpemVkLiBTdWNoIHZhbHVlcyBpbiBvYmplY3RzIHdpbGwgYmUKICAgICAgICAgICAgZHJvcHBlZDsgaW4gYXJyYXlzIHRoZXkgd2lsbCBiZSByZXBsYWNlZCB3aXRoIG51bGwuIFlvdSBjYW4gdXNlCiAgICAgICAgICAgIGEgcmVwbGFjZXIgZnVuY3Rpb24gdG8gcmVwbGFjZSB0aG9zZSB3aXRoIEpTT04gdmFsdWVzLgogICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh1bmRlZmluZWQpIHJldHVybnMgdW5kZWZpbmVkLgoKICAgICAgICAgICAgVGhlIG9wdGlvbmFsIHNwYWNlIHBhcmFtZXRlciBwcm9kdWNlcyBhIHN0cmluZ2lmaWNhdGlvbiBvZiB0aGUKICAgICAgICAgICAgdmFsdWUgdGhhdCBpcyBmaWxsZWQgd2l0aCBsaW5lIGJyZWFrcyBhbmQgaW5kZW50YXRpb24gdG8gbWFrZSBpdAogICAgICAgICAgICBlYXNpZXIgdG8gcmVhZC4KCiAgICAgICAgICAgIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBub24tZW1wdHkgc3RyaW5nLCB0aGVuIHRoYXQgc3RyaW5nIHdpbGwKICAgICAgICAgICAgYmUgdXNlZCBmb3IgaW5kZW50YXRpb24uIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIHRoZW4KICAgICAgICAgICAgdGhlIGluZGVudGF0aW9uIHdpbGwgYmUgdGhhdCBtYW55IHNwYWNlcy4KCiAgICAgICAgICAgIEV4YW1wbGU6CgogICAgICAgICAgICB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoWydlJywge3BsdXJpYnVzOiAndW51bSd9XSk7CiAgICAgICAgICAgIC8vIHRleHQgaXMgJ1siZSIseyJwbHVyaWJ1cyI6InVudW0ifV0nCgoKICAgICAgICAgICAgdGV4dCA9IEpTT04uc3RyaW5naWZ5KFsnZScsIHtwbHVyaWJ1czogJ3VudW0nfV0sIG51bGwsICdcdCcpOwogICAgICAgICAgICAvLyB0ZXh0IGlzICdbXG5cdCJlIixcblx0e1xuXHRcdCJwbHVyaWJ1cyI6ICJ1bnVtIlxuXHR9XG5dJwoKICAgICAgICAgICAgdGV4dCA9IEpTT04uc3RyaW5naWZ5KFtuZXcgRGF0ZSgpXSwgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2tleV0gaW5zdGFuY2VvZiBEYXRlID8KICAgICAgICAgICAgICAgICAgICAnRGF0ZSgnICsgdGhpc1trZXldICsgJyknIDogdmFsdWU7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyB0ZXh0IGlzICdbIkRhdGUoLS0tY3VycmVudCB0aW1lLS0tKSJdJwoKCiAgICAgICAgSlNPTi5wYXJzZSh0ZXh0LCByZXZpdmVyKQogICAgICAgICAgICBUaGlzIG1ldGhvZCBwYXJzZXMgYSBKU09OIHRleHQgdG8gcHJvZHVjZSBhbiBvYmplY3Qgb3IgYXJyYXkuCiAgICAgICAgICAgIEl0IGNhbiB0aHJvdyBhIFN5bnRheEVycm9yIGV4Y2VwdGlvbi4KCiAgICAgICAgICAgIFRoZSBvcHRpb25hbCByZXZpdmVyIHBhcmFtZXRlciBpcyBhIGZ1bmN0aW9uIHRoYXQgY2FuIGZpbHRlciBhbmQKICAgICAgICAgICAgdHJhbnNmb3JtIHRoZSByZXN1bHRzLiBJdCByZWNlaXZlcyBlYWNoIG9mIHRoZSBrZXlzIGFuZCB2YWx1ZXMsCiAgICAgICAgICAgIGFuZCBpdHMgcmV0dXJuIHZhbHVlIGlzIHVzZWQgaW5zdGVhZCBvZiB0aGUgb3JpZ2luYWwgdmFsdWUuCiAgICAgICAgICAgIElmIGl0IHJldHVybnMgd2hhdCBpdCByZWNlaXZlZCwgdGhlbiB0aGUgc3RydWN0dXJlIGlzIG5vdCBtb2RpZmllZC4KICAgICAgICAgICAgSWYgaXQgcmV0dXJucyB1bmRlZmluZWQgdGhlbiB0aGUgbWVtYmVyIGlzIGRlbGV0ZWQuCgogICAgICAgICAgICBFeGFtcGxlOgoKICAgICAgICAgICAgLy8gUGFyc2UgdGhlIHRleHQuIFZhbHVlcyB0aGF0IGxvb2sgbGlrZSBJU08gZGF0ZSBzdHJpbmdzIHdpbGwKICAgICAgICAgICAgLy8gYmUgY29udmVydGVkIHRvIERhdGUgb2JqZWN0cy4KCiAgICAgICAgICAgIG15RGF0YSA9IEpTT04ucGFyc2UodGV4dCwgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBhOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBhID0KL14oXGR7NH0pLShcZHsyfSktKFxkezJ9KVQoXGR7Mn0pOihcZHsyfSk6KFxkezJ9KD86XC5cZCopPylaJC8uZXhlYyh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKCthWzFdLCArYVsyXSAtIDEsICthWzNdLCArYVs0XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICthWzVdLCArYVs2XSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBteURhdGEgPSBKU09OLnBhcnNlKCdbIkRhdGUoMDkvMDkvMjAwMSkiXScsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgZDsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnNsaWNlKDAsIDUpID09PSAnRGF0ZSgnICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnNsaWNlKC0xKSA9PT0gJyknKSB7CiAgICAgICAgICAgICAgICAgICAgZCA9IG5ldyBEYXRlKHZhbHVlLnNsaWNlKDUsIC0xKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9KTsKCgogICAgVGhpcyBpcyBhIHJlZmVyZW5jZSBpbXBsZW1lbnRhdGlvbi4gWW91IGFyZSBmcmVlIHRvIGNvcHksIG1vZGlmeSwgb3IKICAgIHJlZGlzdHJpYnV0ZS4KKi8KCi8qanNsaW50IGV2aWw6IHRydWUsIHJlZ2V4cDogdHJ1ZSAqLwoKLyptZW1iZXJzICIiLCAiXGIiLCAiXHQiLCAiXG4iLCAiXGYiLCAiXHIiLCAiXCIiLCBKU09OLCAiXFwiLCBhcHBseSwKICAgIGNhbGwsIGNoYXJDb2RlQXQsIGdldFVUQ0RhdGUsIGdldFVUQ0Z1bGxZZWFyLCBnZXRVVENIb3VycywKICAgIGdldFVUQ01pbnV0ZXMsIGdldFVUQ01vbnRoLCBnZXRVVENTZWNvbmRzLCBoYXNPd25Qcm9wZXJ0eSwgam9pbiwKICAgIGxhc3RJbmRleCwgbGVuZ3RoLCBwYXJzZSwgcHJvdG90eXBlLCBwdXNoLCByZXBsYWNlLCBzbGljZSwgc3RyaW5naWZ5LAogICAgdGVzdCwgdG9KU09OLCB0b1N0cmluZywgdmFsdWVPZgoqLwoKCi8vIENyZWF0ZSBhIEpTT04gb2JqZWN0IG9ubHkgaWYgb25lIGRvZXMgbm90IGFscmVhZHkgZXhpc3QuIFdlIGNyZWF0ZSB0aGUKLy8gbWV0aG9kcyBpbiBhIGNsb3N1cmUgdG8gYXZvaWQgY3JlYXRpbmcgZ2xvYmFsIHZhcmlhYmxlcy4KCmlmICh0eXBlb2YgSlNPTiAhPT0gJ29iamVjdCcpIHsKICAgIEpTT04gPSB7fTsKfQoKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCdqc29uLWllNycsWydyZXF1aXJlJ10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgCgogICAgZnVuY3Rpb24gZihuKSB7CiAgICAgICAgLy8gRm9ybWF0IGludGVnZXJzIHRvIGhhdmUgYXQgbGVhc3QgdHdvIGRpZ2l0cy4KICAgICAgICByZXR1cm4gbiA8IDEwID8gJzAnICsgbiA6IG47CiAgICB9CgogICAgaWYgKHR5cGVvZiBEYXRlLnByb3RvdHlwZS50b0pTT04gIT09ICdmdW5jdGlvbicpIHsKCiAgICAgICAgRGF0ZS5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgcmV0dXJuIGlzRmluaXRlKHRoaXMudmFsdWVPZigpKQogICAgICAgICAgICAgICAgPyB0aGlzLmdldFVUQ0Z1bGxZZWFyKCkgICAgICsgJy0nICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTW9udGgoKSArIDEpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDRGF0ZSgpKSAgICAgICsgJ1QnICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDSG91cnMoKSkgICAgICsgJzonICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTWludXRlcygpKSAgICsgJzonICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDU2Vjb25kcygpKSAgICsgJ1onCiAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgfTsKCiAgICAgICAgU3RyaW5nLnByb3RvdHlwZS50b0pTT04gICAgICA9CiAgICAgICAgICAgIE51bWJlci5wcm90b3R5cGUudG9KU09OICA9CiAgICAgICAgICAgIEJvb2xlYW4ucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZhbHVlT2YoKTsKICAgICAgICAgICAgfTsKICAgIH0KCiAgICB2YXIgY3ggPSAvW1x1MDAwMFx1MDBhZFx1MDYwMC1cdTA2MDRcdTA3MGZcdTE3YjRcdTE3YjVcdTIwMGMtXHUyMDBmXHUyMDI4LVx1MjAyZlx1MjA2MC1cdTIwNmZcdWZlZmZcdWZmZjAtXHVmZmZmXS9nLAogICAgICAgIGVzY2FwYWJsZSA9IC9bXFxcIlx4MDAtXHgxZlx4N2YtXHg5Zlx1MDBhZFx1MDYwMC1cdTA2MDRcdTA3MGZcdTE3YjRcdTE3YjVcdTIwMGMtXHUyMDBmXHUyMDI4LVx1MjAyZlx1MjA2MC1cdTIwNmZcdWZlZmZcdWZmZjAtXHVmZmZmXS9nLAogICAgICAgIGdhcCwKICAgICAgICBpbmRlbnQsCiAgICAgICAgbWV0YSA9IHsgICAgLy8gdGFibGUgb2YgY2hhcmFjdGVyIHN1YnN0aXR1dGlvbnMKICAgICAgICAgICAgJ1xiJzogJ1xcYicsCiAgICAgICAgICAgICdcdCc6ICdcXHQnLAogICAgICAgICAgICAnXG4nOiAnXFxuJywKICAgICAgICAgICAgJ1xmJzogJ1xcZicsCiAgICAgICAgICAgICdccic6ICdcXHInLAogICAgICAgICAgICAnIicgOiAnXFwiJywKICAgICAgICAgICAgJ1xcJzogJ1xcXFwnCiAgICAgICAgfSwKICAgICAgICByZXA7CgoKICAgIGZ1bmN0aW9uIHF1b3RlKHN0cmluZykgewoKLy8gSWYgdGhlIHN0cmluZyBjb250YWlucyBubyBjb250cm9sIGNoYXJhY3RlcnMsIG5vIHF1b3RlIGNoYXJhY3RlcnMsIGFuZCBubwovLyBiYWNrc2xhc2ggY2hhcmFjdGVycywgdGhlbiB3ZSBjYW4gc2FmZWx5IHNsYXAgc29tZSBxdW90ZXMgYXJvdW5kIGl0LgovLyBPdGhlcndpc2Ugd2UgbXVzdCBhbHNvIHJlcGxhY2UgdGhlIG9mZmVuZGluZyBjaGFyYWN0ZXJzIHdpdGggc2FmZSBlc2NhcGUKLy8gc2VxdWVuY2VzLgoKICAgICAgICBlc2NhcGFibGUubGFzdEluZGV4ID0gMDsKICAgICAgICByZXR1cm4gZXNjYXBhYmxlLnRlc3Qoc3RyaW5nKSA/ICciJyArIHN0cmluZy5yZXBsYWNlKGVzY2FwYWJsZSwgZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgdmFyIGMgPSBtZXRhW2FdOwogICAgICAgICAgICByZXR1cm4gdHlwZW9mIGMgPT09ICdzdHJpbmcnCiAgICAgICAgICAgICAgICA/IGMKICAgICAgICAgICAgICAgIDogJ1xcdScgKyAoJzAwMDAnICsgYS5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTQpOwogICAgICAgIH0pICsgJyInIDogJyInICsgc3RyaW5nICsgJyInOwogICAgfQoKCiAgICBmdW5jdGlvbiBzdHIoa2V5LCBob2xkZXIpIHsKCi8vIFByb2R1Y2UgYSBzdHJpbmcgZnJvbSBob2xkZXJba2V5XS4KCiAgICAgICAgdmFyIGksICAgICAgICAgIC8vIFRoZSBsb29wIGNvdW50ZXIuCiAgICAgICAgICAgIGssICAgICAgICAgIC8vIFRoZSBtZW1iZXIga2V5LgogICAgICAgICAgICB2LCAgICAgICAgICAvLyBUaGUgbWVtYmVyIHZhbHVlLgogICAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICAgIG1pbmQgPSBnYXAsCiAgICAgICAgICAgIHBhcnRpYWwsCiAgICAgICAgICAgIHZhbHVlID0gaG9sZGVyW2tleV07CgovLyBJZiB0aGUgdmFsdWUgaGFzIGEgdG9KU09OIG1ldGhvZCwgY2FsbCBpdCB0byBvYnRhaW4gYSByZXBsYWNlbWVudCB2YWx1ZS4KCiAgICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYKICAgICAgICAgICAgICAgIHR5cGVvZiB2YWx1ZS50b0pTT04gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS50b0pTT04oa2V5KTsKICAgICAgICB9CgovLyBJZiB3ZSB3ZXJlIGNhbGxlZCB3aXRoIGEgcmVwbGFjZXIgZnVuY3Rpb24sIHRoZW4gY2FsbCB0aGUgcmVwbGFjZXIgdG8KLy8gb2J0YWluIGEgcmVwbGFjZW1lbnQgdmFsdWUuCgogICAgICAgIGlmICh0eXBlb2YgcmVwID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHZhbHVlID0gcmVwLmNhbGwoaG9sZGVyLCBrZXksIHZhbHVlKTsKICAgICAgICB9CgovLyBXaGF0IGhhcHBlbnMgbmV4dCBkZXBlbmRzIG9uIHRoZSB2YWx1ZSdzIHR5cGUuCgogICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgcmV0dXJuIHF1b3RlKHZhbHVlKTsKCiAgICAgICAgY2FzZSAnbnVtYmVyJzoKCi8vIEpTT04gbnVtYmVycyBtdXN0IGJlIGZpbml0ZS4gRW5jb2RlIG5vbi1maW5pdGUgbnVtYmVycyBhcyBudWxsLgoKICAgICAgICAgICAgcmV0dXJuIGlzRmluaXRlKHZhbHVlKSA/IFN0cmluZyh2YWx1ZSkgOiAnbnVsbCc7CgogICAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgIGNhc2UgJ251bGwnOgoKLy8gSWYgdGhlIHZhbHVlIGlzIGEgYm9vbGVhbiBvciBudWxsLCBjb252ZXJ0IGl0IHRvIGEgc3RyaW5nLiBOb3RlOgovLyB0eXBlb2YgbnVsbCBkb2VzIG5vdCBwcm9kdWNlICdudWxsJy4gVGhlIGNhc2UgaXMgaW5jbHVkZWQgaGVyZSBpbgovLyB0aGUgcmVtb3RlIGNoYW5jZSB0aGF0IHRoaXMgZ2V0cyBmaXhlZCBzb21lZGF5LgoKICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7CgovLyBJZiB0aGUgdHlwZSBpcyAnb2JqZWN0Jywgd2UgbWlnaHQgYmUgZGVhbGluZyB3aXRoIGFuIG9iamVjdCBvciBhbiBhcnJheSBvcgovLyBudWxsLgoKICAgICAgICBjYXNlICdvYmplY3QnOgoKLy8gRHVlIHRvIGEgc3BlY2lmaWNhdGlvbiBibHVuZGVyIGluIEVDTUFTY3JpcHQsIHR5cGVvZiBudWxsIGlzICdvYmplY3QnLAovLyBzbyB3YXRjaCBvdXQgZm9yIHRoYXQgY2FzZS4KCiAgICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAnbnVsbCc7CiAgICAgICAgICAgIH0KCi8vIE1ha2UgYW4gYXJyYXkgdG8gaG9sZCB0aGUgcGFydGlhbCByZXN1bHRzIG9mIHN0cmluZ2lmeWluZyB0aGlzIG9iamVjdCB2YWx1ZS4KCiAgICAgICAgICAgIGdhcCArPSBpbmRlbnQ7CiAgICAgICAgICAgIHBhcnRpYWwgPSBbXTsKCi8vIElzIHRoZSB2YWx1ZSBhbiBhcnJheT8KCiAgICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KHZhbHVlKSA9PT0gJ1tvYmplY3QgQXJyYXldJykgewoKLy8gVGhlIHZhbHVlIGlzIGFuIGFycmF5LiBTdHJpbmdpZnkgZXZlcnkgZWxlbWVudC4gVXNlIG51bGwgYXMgYSBwbGFjZWhvbGRlcgovLyBmb3Igbm9uLUpTT04gdmFsdWVzLgoKICAgICAgICAgICAgICAgIGxlbmd0aCA9IHZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgICAgIHBhcnRpYWxbaV0gPSBzdHIoaSwgdmFsdWUpIHx8ICdudWxsJzsKICAgICAgICAgICAgICAgIH0KCi8vIEpvaW4gYWxsIG9mIHRoZSBlbGVtZW50cyB0b2dldGhlciwgc2VwYXJhdGVkIHdpdGggY29tbWFzLCBhbmQgd3JhcCB0aGVtIGluCi8vIGJyYWNrZXRzLgoKICAgICAgICAgICAgICAgIHYgPSBwYXJ0aWFsLmxlbmd0aCA9PT0gMAogICAgICAgICAgICAgICAgICAgID8gJ1tdJwogICAgICAgICAgICAgICAgICAgIDogZ2FwCiAgICAgICAgICAgICAgICAgICAgPyAnW1xuJyArIGdhcCArIHBhcnRpYWwuam9pbignLFxuJyArIGdhcCkgKyAnXG4nICsgbWluZCArICddJwogICAgICAgICAgICAgICAgICAgIDogJ1snICsgcGFydGlhbC5qb2luKCcsJykgKyAnXSc7CiAgICAgICAgICAgICAgICBnYXAgPSBtaW5kOwogICAgICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgICAgIH0KCi8vIElmIHRoZSByZXBsYWNlciBpcyBhbiBhcnJheSwgdXNlIGl0IHRvIHNlbGVjdCB0aGUgbWVtYmVycyB0byBiZSBzdHJpbmdpZmllZC4KCiAgICAgICAgICAgIGlmIChyZXAgJiYgdHlwZW9mIHJlcCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIGxlbmd0aCA9IHJlcC5sZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlcFtpXSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgayA9IHJlcFtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHN0cihrLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0aWFsLnB1c2gocXVvdGUoaykgKyAoZ2FwID8gJzogJyA6ICc6JykgKyB2KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKCi8vIE90aGVyd2lzZSwgaXRlcmF0ZSB0aHJvdWdoIGFsbCBvZiB0aGUga2V5cyBpbiB0aGUgb2JqZWN0LgoKICAgICAgICAgICAgICAgIGZvciAoayBpbiB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGspKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHYgPSBzdHIoaywgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydGlhbC5wdXNoKHF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCi8vIEpvaW4gYWxsIG9mIHRoZSBtZW1iZXIgdGV4dHMgdG9nZXRoZXIsIHNlcGFyYXRlZCB3aXRoIGNvbW1hcywKLy8gYW5kIHdyYXAgdGhlbSBpbiBicmFjZXMuCgogICAgICAgICAgICB2ID0gcGFydGlhbC5sZW5ndGggPT09IDAKICAgICAgICAgICAgICAgID8gJ3t9JwogICAgICAgICAgICAgICAgOiBnYXAKICAgICAgICAgICAgICAgID8gJ3tcbicgKyBnYXAgKyBwYXJ0aWFsLmpvaW4oJyxcbicgKyBnYXApICsgJ1xuJyArIG1pbmQgKyAnfScKICAgICAgICAgICAgICAgIDogJ3snICsgcGFydGlhbC5qb2luKCcsJykgKyAnfSc7CiAgICAgICAgICAgIGdhcCA9IG1pbmQ7CiAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgIH0KICAgIH0KCi8vIElmIHRoZSBKU09OIG9iamVjdCBkb2VzIG5vdCB5ZXQgaGF2ZSBhIHN0cmluZ2lmeSBtZXRob2QsIGdpdmUgaXQgb25lLgoKICAgIGlmICh0eXBlb2YgSlNPTi5zdHJpbmdpZnkgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICBKU09OLnN0cmluZ2lmeSA9IGZ1bmN0aW9uICh2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKSB7CgovLyBUaGUgc3RyaW5naWZ5IG1ldGhvZCB0YWtlcyBhIHZhbHVlIGFuZCBhbiBvcHRpb25hbCByZXBsYWNlciwgYW5kIGFuIG9wdGlvbmFsCi8vIHNwYWNlIHBhcmFtZXRlciwgYW5kIHJldHVybnMgYSBKU09OIHRleHQuIFRoZSByZXBsYWNlciBjYW4gYmUgYSBmdW5jdGlvbgovLyB0aGF0IGNhbiByZXBsYWNlIHZhbHVlcywgb3IgYW4gYXJyYXkgb2Ygc3RyaW5ncyB0aGF0IHdpbGwgc2VsZWN0IHRoZSBrZXlzLgovLyBBIGRlZmF1bHQgcmVwbGFjZXIgbWV0aG9kIGNhbiBiZSBwcm92aWRlZC4gVXNlIG9mIHRoZSBzcGFjZSBwYXJhbWV0ZXIgY2FuCi8vIHByb2R1Y2UgdGV4dCB0aGF0IGlzIG1vcmUgZWFzaWx5IHJlYWRhYmxlLgoKICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgIGdhcCA9ICcnOwogICAgICAgICAgICBpbmRlbnQgPSAnJzsKCi8vIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIG1ha2UgYW4gaW5kZW50IHN0cmluZyBjb250YWluaW5nIHRoYXQKLy8gbWFueSBzcGFjZXMuCgogICAgICAgICAgICBpZiAodHlwZW9mIHNwYWNlID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNwYWNlOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICBpbmRlbnQgKz0gJyAnOwogICAgICAgICAgICAgICAgfQoKLy8gSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIHN0cmluZywgaXQgd2lsbCBiZSB1c2VkIGFzIHRoZSBpbmRlbnQgc3RyaW5nLgoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3BhY2UgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBpbmRlbnQgPSBzcGFjZTsKICAgICAgICAgICAgfQoKLy8gSWYgdGhlcmUgaXMgYSByZXBsYWNlciwgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIGFuIGFycmF5LgovLyBPdGhlcndpc2UsIHRocm93IGFuIGVycm9yLgoKICAgICAgICAgICAgcmVwID0gcmVwbGFjZXI7CiAgICAgICAgICAgIGlmIChyZXBsYWNlciAmJiB0eXBlb2YgcmVwbGFjZXIgIT09ICdmdW5jdGlvbicgJiYKICAgICAgICAgICAgICAgICAgICAodHlwZW9mIHJlcGxhY2VyICE9PSAnb2JqZWN0JyB8fAogICAgICAgICAgICAgICAgICAgIHR5cGVvZiByZXBsYWNlci5sZW5ndGggIT09ICdudW1iZXInKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdKU09OLnN0cmluZ2lmeScpOwogICAgICAgICAgICB9CgovLyBNYWtlIGEgZmFrZSByb290IG9iamVjdCBjb250YWluaW5nIG91ciB2YWx1ZSB1bmRlciB0aGUga2V5IG9mICcnLgovLyBSZXR1cm4gdGhlIHJlc3VsdCBvZiBzdHJpbmdpZnlpbmcgdGhlIHZhbHVlLgoKICAgICAgICAgICAgcmV0dXJuIHN0cignJywgeycnOiB2YWx1ZX0pOwogICAgICAgIH07CiAgICB9CgoKLy8gSWYgdGhlIEpTT04gb2JqZWN0IGRvZXMgbm90IHlldCBoYXZlIGEgcGFyc2UgbWV0aG9kLCBnaXZlIGl0IG9uZS4KCiAgICBpZiAodHlwZW9mIEpTT04ucGFyc2UgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICBKU09OLnBhcnNlID0gZnVuY3Rpb24gKHRleHQsIHJldml2ZXIpIHsKCi8vIFRoZSBwYXJzZSBtZXRob2QgdGFrZXMgYSB0ZXh0IGFuZCBhbiBvcHRpb25hbCByZXZpdmVyIGZ1bmN0aW9uLCBhbmQgcmV0dXJucwovLyBhIEphdmFTY3JpcHQgdmFsdWUgaWYgdGhlIHRleHQgaXMgYSB2YWxpZCBKU09OIHRleHQuCgogICAgICAgICAgICB2YXIgajsKCiAgICAgICAgICAgIGZ1bmN0aW9uIHdhbGsoaG9sZGVyLCBrZXkpIHsKCi8vIFRoZSB3YWxrIG1ldGhvZCBpcyB1c2VkIHRvIHJlY3Vyc2l2ZWx5IHdhbGsgdGhlIHJlc3VsdGluZyBzdHJ1Y3R1cmUgc28KLy8gdGhhdCBtb2RpZmljYXRpb25zIGNhbiBiZSBtYWRlLgoKICAgICAgICAgICAgICAgIHZhciBrLCB2LCB2YWx1ZSA9IGhvbGRlcltrZXldOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGsgaW4gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB3YWxrKHZhbHVlLCBrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZVtrXSA9IHY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB2YWx1ZVtrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXZpdmVyLmNhbGwoaG9sZGVyLCBrZXksIHZhbHVlKTsKICAgICAgICAgICAgfQoKCi8vIFBhcnNpbmcgaGFwcGVucyBpbiBmb3VyIHN0YWdlcy4gSW4gdGhlIGZpcnN0IHN0YWdlLCB3ZSByZXBsYWNlIGNlcnRhaW4KLy8gVW5pY29kZSBjaGFyYWN0ZXJzIHdpdGggZXNjYXBlIHNlcXVlbmNlcy4gSmF2YVNjcmlwdCBoYW5kbGVzIG1hbnkgY2hhcmFjdGVycwovLyBpbmNvcnJlY3RseSwgZWl0aGVyIHNpbGVudGx5IGRlbGV0aW5nIHRoZW0sIG9yIHRyZWF0aW5nIHRoZW0gYXMgbGluZSBlbmRpbmdzLgoKICAgICAgICAgICAgdGV4dCA9IFN0cmluZyh0ZXh0KTsKICAgICAgICAgICAgY3gubGFzdEluZGV4ID0gMDsKICAgICAgICAgICAgaWYgKGN4LnRlc3QodGV4dCkpIHsKICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoY3gsIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdcXHUnICsKICAgICAgICAgICAgICAgICAgICAgICAgKCcwMDAwJyArIGEuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC00KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgovLyBJbiB0aGUgc2Vjb25kIHN0YWdlLCB3ZSBydW4gdGhlIHRleHQgYWdhaW5zdCByZWd1bGFyIGV4cHJlc3Npb25zIHRoYXQgbG9vawovLyBmb3Igbm9uLUpTT04gcGF0dGVybnMuIFdlIGFyZSBlc3BlY2lhbGx5IGNvbmNlcm5lZCB3aXRoICcoKScgYW5kICduZXcnCi8vIGJlY2F1c2UgdGhleSBjYW4gY2F1c2UgaW52b2NhdGlvbiwgYW5kICc9JyBiZWNhdXNlIGl0IGNhbiBjYXVzZSBtdXRhdGlvbi4KLy8gQnV0IGp1c3QgdG8gYmUgc2FmZSwgd2Ugd2FudCB0byByZWplY3QgYWxsIHVuZXhwZWN0ZWQgZm9ybXMuCgovLyBXZSBzcGxpdCB0aGUgc2Vjb25kIHN0YWdlIGludG8gNCByZWdleHAgb3BlcmF0aW9ucyBpbiBvcmRlciB0byB3b3JrIGFyb3VuZAovLyBjcmlwcGxpbmcgaW5lZmZpY2llbmNpZXMgaW4gSUUncyBhbmQgU2FmYXJpJ3MgcmVnZXhwIGVuZ2luZXMuIEZpcnN0IHdlCi8vIHJlcGxhY2UgdGhlIEpTT04gYmFja3NsYXNoIHBhaXJzIHdpdGggJ0AnIChhIG5vbi1KU09OIGNoYXJhY3RlcikuIFNlY29uZCwgd2UKLy8gcmVwbGFjZSBhbGwgc2ltcGxlIHZhbHVlIHRva2VucyB3aXRoICddJyBjaGFyYWN0ZXJzLiBUaGlyZCwgd2UgZGVsZXRlIGFsbAovLyBvcGVuIGJyYWNrZXRzIHRoYXQgZm9sbG93IGEgY29sb24gb3IgY29tbWEgb3IgdGhhdCBiZWdpbiB0aGUgdGV4dC4gRmluYWxseSwKLy8gd2UgbG9vayB0byBzZWUgdGhhdCB0aGUgcmVtYWluaW5nIGNoYXJhY3RlcnMgYXJlIG9ubHkgd2hpdGVzcGFjZSBvciAnXScgb3IKLy8gJywnIG9yICc6JyBvciAneycgb3IgJ30nLiBJZiB0aGF0IGlzIHNvLCB0aGVuIHRoZSB0ZXh0IGlzIHNhZmUgZm9yIGV2YWwuCgogICAgICAgICAgICBpZiAoL15bXF0sOnt9XHNdKiQvCiAgICAgICAgICAgICAgICAgICAgLnRlc3QodGV4dC5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICdAJykKICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLyJbXiJcXFxuXHJdKiJ8dHJ1ZXxmYWxzZXxudWxsfC0/XGQrKD86XC5cZCopPyg/OltlRV1bK1wtXT9cZCspPy9nLCAnXScpCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICcnKSkpIHsKCi8vIEluIHRoZSB0aGlyZCBzdGFnZSB3ZSB1c2UgdGhlIGV2YWwgZnVuY3Rpb24gdG8gY29tcGlsZSB0aGUgdGV4dCBpbnRvIGEKLy8gSmF2YVNjcmlwdCBzdHJ1Y3R1cmUuIFRoZSAneycgb3BlcmF0b3IgaXMgc3ViamVjdCB0byBhIHN5bnRhY3RpYyBhbWJpZ3VpdHkKLy8gaW4gSmF2YVNjcmlwdDogaXQgY2FuIGJlZ2luIGEgYmxvY2sgb3IgYW4gb2JqZWN0IGxpdGVyYWwuIFdlIHdyYXAgdGhlIHRleHQKLy8gaW4gcGFyZW5zIHRvIGVsaW1pbmF0ZSB0aGUgYW1iaWd1aXR5LgoKICAgICAgICAgICAgICAgIGogPSBldmFsKCcoJyArIHRleHQgKyAnKScpOwoKLy8gSW4gdGhlIG9wdGlvbmFsIGZvdXJ0aCBzdGFnZSwgd2UgcmVjdXJzaXZlbHkgd2FsayB0aGUgbmV3IHN0cnVjdHVyZSwgcGFzc2luZwovLyBlYWNoIG5hbWUvdmFsdWUgcGFpciB0byBhIHJldml2ZXIgZnVuY3Rpb24gZm9yIHBvc3NpYmxlIHRyYW5zZm9ybWF0aW9uLgoKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgcmV2aXZlciA9PT0gJ2Z1bmN0aW9uJwogICAgICAgICAgICAgICAgICAgID8gd2Fsayh7Jyc6IGp9LCAnJykKICAgICAgICAgICAgICAgICAgICA6IGo7CiAgICAgICAgICAgIH0KCi8vIElmIHRoZSB0ZXh0IGlzIG5vdCBKU09OIHBhcnNlYWJsZSwgdGhlbiBhIFN5bnRheEVycm9yIGlzIHRocm93bi4KCiAgICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignSlNPTi5wYXJzZScpOwogICAgICAgIH07CiAgICB9Cn0pOwoKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCdjaGlyb3ByYWN0b3Ivdmlld3MvYmFzZScsWydyZXF1aXJlJywndW5kZXJzY29yZScsJ2pzb24taWU3JywnanF1ZXJ5JywnYmFja2JvbmUnLCdoYW5kbGViYXJzJ10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgCgogICAgdmFyIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyksCiAgICAgICAgSlNPTiA9IHJlcXVpcmUoJ2pzb24taWU3JyksCiAgICAgICAgJCA9IHJlcXVpcmUoJ2pxdWVyeScpLAogICAgICAgIEJhY2tib25lID0gcmVxdWlyZSgnYmFja2JvbmUnKSwKICAgICAgICBIYW5kbGViYXJzID0gcmVxdWlyZSgnaGFuZGxlYmFycycpLAogICAgICAgIHJlbW92ZUhhbmRsZXJUZXN0ID0gJCgnPHNwYW4+PC9zcGFuPicpLAogICAgICAgIHJlbW92ZUhhbmRsZXJFeGlzdHMgPSBmYWxzZSwKICAgICAgICBwbGFjZWhvbGRlcklkOwoKICAgIHJlbW92ZUhhbmRsZXJUZXN0Lm9uKCdyZW1vdmUnLCBmdW5jdGlvbigpIHsgcmVtb3ZlSGFuZGxlckV4aXN0cyA9IHRydWU7IH0pOwogICAgcmVtb3ZlSGFuZGxlclRlc3QucmVtb3ZlKCk7CgogICAgaWYgKCFyZW1vdmVIYW5kbGVyRXhpc3RzKSB7CiAgICAgICAgJC5ldmVudC5zcGVjaWFsLnJlbW92ZSA9IHsKICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBpZiAoZS5oYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyICRlbCA9ICQodGhpcyk7CiAgICAgICAgICAgICAgICAgICAgLy8gU2luY2UgdGhpcyBldmVudCBnZXRzIGZpcmVkIG9uIGNhbGxpbmcgJGVsLm9mZigncmVtb3ZlJykKICAgICAgICAgICAgICAgICAgICAvLyBhcyB3ZWxsIGFzIHdoZW4gdGhlICRlbC5yZW1vdmUoKSBnZXRzIGNhbGxlZCwgd2UgbmVlZCB0bwogICAgICAgICAgICAgICAgICAgIC8vIGFsbG93IHRoZSBCYWNrYm9uZSBWaWV3IHRvIHVucmVnaXN0ZXIgdGhpcyB3aXRob3V0CiAgICAgICAgICAgICAgICAgICAgLy8gZmlyaW5nIGl0LgogICAgICAgICAgICAgICAgICAgIGlmKCEkZWwuaGFzQ2xhc3MoJ3JlbW92ZWRFdmVudEZpcmVkJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGVsLmFkZENsYXNzKCdyZW1vdmVkRXZlbnRGaXJlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICBlLmhhbmRsZXIuY2FsbCh0aGlzLCBuZXcgJC5FdmVudCgncmVtb3ZlJywge3RhcmdldDogdGhpc30pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQoKICAgIHBsYWNlaG9sZGVySWQgPSBmdW5jdGlvbih2aWV3KSB7CiAgICAgICAgcmV0dXJuICdjaGlyb3ByYWN0b3JJZCcgKyB2aWV3LmNpZDsKICAgIH07CgogICAgcmV0dXJuIEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgICBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS5pbml0aWFsaXplLmNhbGwodGhpcywgb3B0aW9ucyk7CgogICAgICAgICAgICBfLmJpbmRBbGwodGhpcywgJ3JlbW92ZScpOwoKICAgICAgICAgICAgdGhpcy5fY2hpbGRWaWV3cyA9IFtdOwogICAgICAgICAgICB0aGlzLl9jb250ZXh0ID0gb3B0aW9ucy5jb250ZXh0IHx8IHt9OwoKICAgICAgICAgICAgdGhpcy4kZWwub24oJ3JlbW92ZScsIHRoaXMucmVtb3ZlKTsKICAgICAgICB9LAoKICAgICAgICBfYWRkQ2hpbGQ6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgdGhpcy5fY2hpbGRWaWV3cy5wdXNoKHZpZXcpOwogICAgICAgICAgICByZXR1cm4gJzwnICsgdmlldy5lbC50YWdOYW1lICsKICAgICAgICAgICAgICAgICcgaWQ9IicgKyBwbGFjZWhvbGRlcklkKHZpZXcpICsgJyI+PC9kaXY+JzsKICAgICAgICB9LAoKICAgICAgICBjb250ZXh0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIG1vZGVsOiB0aGlzLm1vZGVsLAogICAgICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5jb2xsZWN0aW9uCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdHlwZW9mKHRoaXMudGVtcGxhdGUpID09PSAnc3RyaW5nJyA/CiAgICAgICAgICAgICAgICAgICAgSGFuZGxlYmFycy5jb21waWxlKHRoaXMudGVtcGxhdGUpIDogdGhpcy50ZW1wbGF0ZSwKICAgICAgICAgICAgICAgIGNvbnRleHQgPSB0eXBlb2YodGhpcy5jb250ZXh0KSA9PT0gJ2Z1bmN0aW9uJyA/CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0KCkgOiB0aGlzLmNvbnRleHQ7CgogICAgICAgICAgICBjb250ZXh0LmRlY2xhcmluZ1ZpZXcgPSB0aGlzOwogICAgICAgICAgICBfLmRlZmF1bHRzKGNvbnRleHQsIHRoaXMuX2NvbnRleHQpOwoKICAgICAgICAgICAgaWYgKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKHRlbXBsYXRlKGNvbnRleHQpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgXyh0aGlzLl9jaGlsZFZpZXdzKS5lYWNoKGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgICAgIHRoaXMuJCgnIycgKyBwbGFjZWhvbGRlcklkKHZpZXcpKS5yZXBsYWNlV2l0aCh2aWV3LmVsKTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuJGVsLmFkZENsYXNzKCdyZW1vdmVkRXZlbnRGaXJlZCcpOwogICAgICAgICAgICB0aGlzLiRlbC5vZmYoJ3JlbW92ZScsIHRoaXMucmVtb3ZlKTsKICAgICAgICAgICAgXyh0aGlzLl9jaGlsZFZpZXdzKS5lYWNoKGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgICAgIHZpZXcucmVtb3ZlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9jaGlsZFZpZXdzID0gW107CiAgICAgICAgICAgIEJhY2tib25lLlZpZXcucHJvdG90eXBlLnJlbW92ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgIH0pOwp9KTsKCi8qZ2xvYmFsIGRlZmluZSovCmRlZmluZSgnY2hpcm9wcmFjdG9yL3ZpZXdzL2Zvcm0nLFsncmVxdWlyZScsJ3VuZGVyc2NvcmUnLCdqc29uLWllNycsJ2pxdWVyeScsJ2JhY2tib25lJywnLi9iYXNlJ10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgCgogICAgdmFyIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyksCiAgICAgICAgSlNPTiA9IHJlcXVpcmUoJ2pzb24taWU3JyksCiAgICAgICAgJCA9IHJlcXVpcmUoJ2pxdWVyeScpLAogICAgICAgIEJhY2tib25lID0gcmVxdWlyZSgnYmFja2JvbmUnKSwKICAgICAgICBCYXNlID0gcmVxdWlyZSgnLi9iYXNlJyk7CgogICAgcmV0dXJuIEJhc2UuZXh0ZW5kKHsKICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgQmFzZS5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLmxpc3RlbkZvckVycm9ycyh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgdGhpcy5saXN0ZW5Gb3JFcnJvcnModGhpcy5jb2xsZWN0aW9uKTsKICAgICAgICB9LAoKICAgICAgICBsaXN0ZW5Gb3JFcnJvcnM6IGZ1bmN0aW9uKG9iaikgewogICAgICAgICAgICBpZiAob2JqKSB7CiAgICAgICAgICAgICAgICBpZiAob2JqIGluc3RhbmNlb2YgQmFja2JvbmUuTW9kZWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3RlblRvKG9iaiwgJ2ludmFsaWQnLCB0aGlzLnJlbmRlckZvcm1FcnJvcnMpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuVG8ob2JqLCAnY2hhbmdlJywgdGhpcy5jbGVhckZvcm1FcnJvcnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAob2JqIGluc3RhbmNlb2YgQmFja2JvbmUuQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgIG9iai5lYWNoKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuVG8obW9kZWwsICdpbnZhbGlkJywgdGhpcy5yZW5kZXJGb3JtRXJyb3JzKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5Ubyhtb2RlbCwgJ2NoYW5nZScsIHRoaXMuY2xlYXJGb3JtRXJyb3JzKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBvYmplY3QgdG8gYXNzb2NpYXRlIGVycm9ycyB3aXRoLicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgY2xlYXJGb3JtRXJyb3JzOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAgICAgICBfKG1vZGVsLmNoYW5nZWQpLmVhY2goZnVuY3Rpb24odmFsdWUsIGZpZWxkKSB7CiAgICAgICAgICAgICAgICB0aGlzLiQoJyNjb250YWluZXItJyArIG1vZGVsLmZpZWxkSWQoZmllbGQpKQogICAgICAgICAgICAgICAgICAgIC5maW5kKCcuaGVscC1pbmxpbmUnKS5odG1sKCcnKTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgcmVuZGVyRm9ybUVycm9yczogZnVuY3Rpb24obW9kZWwsIGVycm9ycykgewogICAgICAgICAgICBfKGVycm9ycykuZWFjaChmdW5jdGlvbihlcnJvck1lc3NhZ2VzLCBmaWVsZCkgewogICAgICAgICAgICAgICAgdmFyIGhlbHA7CiAgICAgICAgICAgICAgICBlcnJvck1lc3NhZ2VzID0gdHlwZW9mKGVycm9yTWVzc2FnZXMpID09PSAnc3RyaW5nJyA/CiAgICAgICAgICAgICAgICAgICAgW2Vycm9yTWVzc2FnZXNdIDogZXJyb3JNZXNzYWdlczsKCiAgICAgICAgICAgICAgICBpZiAoZmllbGQgPT09ICdfX2FsbF9fJykgewogICAgICAgICAgICAgICAgICAgIGhlbHAgPSAkKCc8ZGl2IGNsYXNzPSJlcnJvcnMiPjwvZGl2PicpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLnByZXBlbmQoaGVscCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBoZWxwID0gdGhpcy4kKCcjY29udGFpbmVyLScgKyBtb2RlbC5maWVsZElkKGZpZWxkKSkKICAgICAgICAgICAgICAgICAgICAgICAgLmZpbmQoJy5oZWxwLWlubGluZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGhlbHAuaHRtbChlcnJvck1lc3NhZ2VzLmpvaW4oJywgJykpOwogICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICB9CiAgICB9KTsKfSk7CgoKLyogU1RBUlRfVEVNUExBVEUgKi8KZGVmaW5lKCdoYnMhY2hpcm9wcmFjdG9yL3ZpZXdzL3RlbXBsYXRlcy9maWVsZHMvbGFiZWwnLFsnaGJzJywnaGFuZGxlYmFycyddLCBmdW5jdGlvbiggaGJzLCBIYW5kbGViYXJzICl7IAp2YXIgdCA9IEhhbmRsZWJhcnMudGVtcGxhdGUoZnVuY3Rpb24gKEhhbmRsZWJhcnMsZGVwdGgwLGhlbHBlcnMscGFydGlhbHMsZGF0YSkgewogIGhlbHBlcnMgPSBoZWxwZXJzIHx8IEhhbmRsZWJhcnMuaGVscGVyczsKICB2YXIgc3RhY2sxLCBmb3VuZEhlbHBlciwgZnVuY3Rpb25UeXBlPSJmdW5jdGlvbiIsIGVzY2FwZUV4cHJlc3Npb249dGhpcy5lc2NhcGVFeHByZXNzaW9uOwoKCiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLnZhbHVlOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAudmFsdWU7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgcmV0dXJuIGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKTt9KTsKSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoJ2NoaXJvcHJhY3Rvcl92aWV3c190ZW1wbGF0ZXNfZmllbGRzX2xhYmVsJywgdCk7CnJldHVybiB0Owp9KTsKLyogRU5EX1RFTVBMQVRFICovCjsKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCdjaGlyb3ByYWN0b3Ivdmlld3MvZmllbGQnLFsncmVxdWlyZScsJ2pzb24taWU3JywnanF1ZXJ5JywndW5kZXJzY29yZScsJ2hhbmRsZWJhcnMnLCdoYnMhLi90ZW1wbGF0ZXMvZmllbGRzL2xhYmVsJ10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgCgogICAgdmFyIEpTT04gPSByZXF1aXJlKCdqc29uLWllNycpLAogICAgICAgICQgPSByZXF1aXJlKCdqcXVlcnknKSwKICAgICAgICBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpLAogICAgICAgIEhhbmRsZWJhcnMgPSByZXF1aXJlKCdoYW5kbGViYXJzJyksCiAgICAgICAgZmllbGRUZW1wbGF0ZXMgPSB7fSwKICAgICAgICBsYWJlbCA9IHJlcXVpcmUoJ2hicyEuL3RlbXBsYXRlcy9maWVsZHMvbGFiZWwnKTsKCiAgICAgICAgZmllbGRUZW1wbGF0ZXMgPSB7CiAgICAgICAgICAgICdkZWZhdWx0cyc6IGxhYmVsCiAgICAgICAgfTsKCiAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdmaWVsZCcsIGZ1bmN0aW9uKHR5cGUsIG1vZGVsLCBmaWVsZE5hbWUpIHsKICAgICAgICAgICAgLy8gdGVtcGxhdGUgaGVscGVyIGluIHRoZSBmb3JtIG9mOgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyAgICAgIHt7IGZpZWxkICd0ZXh0JyBtb2RlbCAnZmllbGRuYW1lJyBbYXR0ck5hbWU9ImF0dHJWYWx1ZSJdKn19CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGZpZWxkVGVtcGxhdGVzW3R5cGVdLAogICAgICAgICAgICAgICAgb3B0aW9ucyA9IGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoIC0gMV0sCiAgICAgICAgICAgICAgICBvcHRzID0gb3B0aW9ucy5oYXNoIHx8IHt9LAogICAgICAgICAgICAgICAgZmllbGQgPSBvcHRzLmZpZWxkLAogICAgICAgICAgICAgICAgaWQgPSAnJywKICAgICAgICAgICAgICAgIHZhbHVlID0gJyc7CgogICAgICAgICAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgIHRlbXBsYXRlID0gZmllbGRUZW1wbGF0ZXMuZGVmYXVsdHM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChtb2RlbCkgewogICAgICAgICAgICAgICAgaWQgPSBtb2RlbC5maWVsZElkKGZpZWxkTmFtZSk7CiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKG1vZGVsKTsKICAgICAgICAgICAgICAgIGlmIChmaWVsZCkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gbW9kZWwuZ2V0KGZpZWxkLmlkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgXy5kZWZhdWx0cyhvcHRzLCB7CiAgICAgICAgICAgICAgICBpZDogaWQsCiAgICAgICAgICAgICAgICBsYWJlbDogZmllbGROYW1lLAogICAgICAgICAgICAgICAgbmFtZTogZmllbGROYW1lLAogICAgICAgICAgICAgICAgb3B0aW9uczogW10sCiAgICAgICAgICAgICAgICBibGFuazogZmFsc2UsCiAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgICBoZWxwOiAnJywKICAgICAgICAgICAgICAgIG1vZGVsOiBtb2RlbAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcodGVtcGxhdGUob3B0cykpOwogICAgICAgIH0pOwoKICAgIHJldHVybiB7CiAgICAgICAgVGVtcGxhdGVzOiBmaWVsZFRlbXBsYXRlcywKICAgICAgICBhZGRUZW1wbGF0ZTogZnVuY3Rpb24obmFtZSx0ZW1wbGF0ZSkgewogICAgICAgICAgICBmaWVsZFRlbXBsYXRlc1tuYW1lXSA9IHRlbXBsYXRlOwogICAgICAgIH0KICAgIH07Cn0pOwoKCi8qIFNUQVJUX1RFTVBMQVRFICovCmRlZmluZSgnaGJzIWNoaXJvcHJhY3Rvci92aWV3cy90ZW1wbGF0ZXMvcm93L3JvdycsWydoYnMnLCdoYW5kbGViYXJzJ10sIGZ1bmN0aW9uKCBoYnMsIEhhbmRsZWJhcnMgKXsgCnZhciB0ID0gSGFuZGxlYmFycy50ZW1wbGF0ZShmdW5jdGlvbiAoSGFuZGxlYmFycyxkZXB0aDAsaGVscGVycyxwYXJ0aWFscyxkYXRhKSB7CiAgaGVscGVycyA9IGhlbHBlcnMgfHwgSGFuZGxlYmFycy5oZWxwZXJzOwogIHZhciBidWZmZXIgPSAiIiwgc3RhY2sxLCBmb3VuZEhlbHBlciwgaGVscGVyTWlzc2luZz1oZWxwZXJzLmhlbHBlck1pc3NpbmcsIGVzY2FwZUV4cHJlc3Npb249dGhpcy5lc2NhcGVFeHByZXNzaW9uLCBmdW5jdGlvblR5cGU9ImZ1bmN0aW9uIiwgc2VsZj10aGlzOwoKZnVuY3Rpb24gcHJvZ3JhbTEoZGVwdGgwLGRhdGEsZGVwdGgxKSB7CiAgCiAgdmFyIGJ1ZmZlciA9ICIiLCBzdGFjazEsIHN0YWNrMiwgc3RhY2szLCBmb3VuZEhlbHBlcjsKICBidWZmZXIgKz0gIlxyXG4gICAgPHRkPiI7CiAgc3RhY2sxID0gZGVwdGgxLm1vZGVsOwogIHN0YWNrMiA9IGRlcHRoMC5maWVsZHR5cGU7CiAgc3RhY2szID0ge307CiAgc3RhY2szWydmaWVsZCddID0gZGVwdGgwOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5maWVsZDsKICBzdGFjazEgPSBmb3VuZEhlbHBlciA/IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCBzdGFjazIsIHN0YWNrMSwge2hhc2g6c3RhY2szfSkgOiBoZWxwZXJNaXNzaW5nLmNhbGwoZGVwdGgwLCAiZmllbGQiLCBzdGFjazIsIHN0YWNrMSwge2hhc2g6c3RhY2szfSk7CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L3RkPlxyXG4gICI7CiAgcmV0dXJuIGJ1ZmZlcjt9CgogIGJ1ZmZlciArPSAiPHRyIGNsYXNzPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMucm93Y2xhc3M7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5yb3djbGFzczsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiPlxyXG4gICI7CiAgc3RhY2sxID0gZGVwdGgwLm9wdGlvbnM7CiAgc3RhY2sxID0gc3RhY2sxID09IG51bGwgfHwgc3RhY2sxID09PSBmYWxzZSA/IHN0YWNrMSA6IHN0YWNrMS5maWVsZHM7CiAgc3RhY2sxID0gaGVscGVycy5lYWNoLmNhbGwoZGVwdGgwLCBzdGFjazEsIHtoYXNoOnt9LGludmVyc2U6c2VsZi5ub29wLGZuOnNlbGYucHJvZ3JhbVdpdGhEZXB0aChwcm9ncmFtMSwgZGF0YSwgZGVwdGgwKX0pOwogIGlmKHN0YWNrMSB8fCBzdGFjazEgPT09IDApIHsgYnVmZmVyICs9IHN0YWNrMTsgfQogIGJ1ZmZlciArPSAiXHJcbjwvdHI+IjsKICByZXR1cm4gYnVmZmVyO30pOwpIYW5kbGViYXJzLnJlZ2lzdGVyUGFydGlhbCgnY2hpcm9wcmFjdG9yX3ZpZXdzX3RlbXBsYXRlc19yb3dfcm93JywgdCk7CnJldHVybiB0Owp9KTsKLyogRU5EX1RFTVBMQVRFICovCjsKCi8qIFNUQVJUX1RFTVBMQVRFICovCmRlZmluZSgnaGJzIWNoaXJvcHJhY3Rvci92aWV3cy90ZW1wbGF0ZXMvcm93L2Vycm9yX21lc3NhZ2Vib3gnLFsnaGJzJywnaGFuZGxlYmFycyddLCBmdW5jdGlvbiggaGJzLCBIYW5kbGViYXJzICl7IAp2YXIgdCA9IEhhbmRsZWJhcnMudGVtcGxhdGUoZnVuY3Rpb24gKEhhbmRsZWJhcnMsZGVwdGgwLGhlbHBlcnMscGFydGlhbHMsZGF0YSkgewogIGhlbHBlcnMgPSBoZWxwZXJzIHx8IEhhbmRsZWJhcnMuaGVscGVyczsKICB2YXIgYnVmZmVyID0gIiIsIHN0YWNrMSwgZnVuY3Rpb25UeXBlPSJmdW5jdGlvbiIsIGVzY2FwZUV4cHJlc3Npb249dGhpcy5lc2NhcGVFeHByZXNzaW9uOwoKCiAgYnVmZmVyICs9ICI8ZGl2IGlkPVwiY2hpcm9wcmFjdG9yLWVycm9yLWJveFwiIHN0eWxlPVwiY29sb3I6ICNhOTQ0NDI7YmFja2dyb3VuZC1jb2xvcjogI2YyZGVkZTtib3JkZXItY29sb3I6ICNlYmNjZDE7cGFkZGluZzogMTVweDtib3JkZXI6IDFweCBzb2xpZCB0cmFuc3BhcmVudDtib3JkZXItcmFkaXVzOiA0cHg7XCI+XHJcbjxkaXYgYXJpYS1oaWRkZW49XCJ0cnVlXCIgc3R5bGU9XCJmbG9hdDpyaWdodDtcIiBvbkNsaWNrPVwiamF2YXNjcmlwdDp2YXIgZWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGlyb3ByYWN0b3ItZXJyb3ItYm94Jyk7ZWxlbWVudC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsZW1lbnQpO1wiPiZ0aW1lczs8L2Rpdj5cclxuPGRpdiBzdHlsZT1cImZvbnQtd2VpZ2h0OmJvbGRcIj4iOwogIHN0YWNrMSA9IGRlcHRoMC5tb2RlbDsKICBzdGFjazEgPSBzdGFjazEgPT0gbnVsbCB8fCBzdGFjazEgPT09IGZhbHNlID8gc3RhY2sxIDogc3RhY2sxLmVycm9yTWVzc2FnZTsKICBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsKICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIjwvZGl2PlxyXG48ZGl2Pk1lc3NhZ2U6ICI7CiAgc3RhY2sxID0gZGVwdGgwLm1vZGVsOwogIHN0YWNrMSA9IHN0YWNrMSA9PSBudWxsIHx8IHN0YWNrMSA9PT0gZmFsc2UgPyBzdGFjazEgOiBzdGFjazEucmVzcG9uc2U7CiAgc3RhY2sxID0gc3RhY2sxID09IG51bGwgfHwgc3RhY2sxID09PSBmYWxzZSA/IHN0YWNrMSA6IHN0YWNrMS5yZXNwb25zZVRleHQ7CiAgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L2Rpdj5cclxuPGRpdj5TdGF0dXM6ICI7CiAgc3RhY2sxID0gZGVwdGgwLm1vZGVsOwogIHN0YWNrMSA9IHN0YWNrMSA9PSBudWxsIHx8IHN0YWNrMSA9PT0gZmFsc2UgPyBzdGFjazEgOiBzdGFjazEucmVzcG9uc2U7CiAgc3RhY2sxID0gc3RhY2sxID09IG51bGwgfHwgc3RhY2sxID09PSBmYWxzZSA/IHN0YWNrMSA6IHN0YWNrMS5zdGF0dXNUZXh0OwogIHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOwogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9kaXY+XHJcbjxkaXY+U3RhdHVzQ29kZTogIjsKICBzdGFjazEgPSBkZXB0aDAubW9kZWw7CiAgc3RhY2sxID0gc3RhY2sxID09IG51bGwgfHwgc3RhY2sxID09PSBmYWxzZSA/IHN0YWNrMSA6IHN0YWNrMS5yZXNwb25zZTsKICBzdGFjazEgPSBzdGFjazEgPT0gbnVsbCB8fCBzdGFjazEgPT09IGZhbHNlID8gc3RhY2sxIDogc3RhY2sxLnN0YXR1czsKICBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsKICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIjwvZGl2PlxyXG48ZGl2PlVybDogPGEgaHJlZj1cIiI7CiAgc3RhY2sxID0gZGVwdGgwLm1vZGVsOwogIHN0YWNrMSA9IHN0YWNrMSA9PSBudWxsIHx8IHN0YWNrMSA9PT0gZmFsc2UgPyBzdGFjazEgOiBzdGFjazEudXJsOwogIHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOwogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiXCI+IjsKICBzdGFjazEgPSBkZXB0aDAubW9kZWw7CiAgc3RhY2sxID0gc3RhY2sxID09IG51bGwgfHwgc3RhY2sxID09PSBmYWxzZSA/IHN0YWNrMSA6IHN0YWNrMS51cmw7CiAgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L2E+PC9kaXY+XHJcbjwvZGl2PiI7CiAgcmV0dXJuIGJ1ZmZlcjt9KTsKSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoJ2NoaXJvcHJhY3Rvcl92aWV3c190ZW1wbGF0ZXNfcm93X2Vycm9yX21lc3NhZ2Vib3gnLCB0KTsKcmV0dXJuIHQ7Cn0pOwovKiBFTkRfVEVNUExBVEUgKi8KOwovKmdsb2JhbCBkZWZpbmUqLwpkZWZpbmUoJ2NoaXJvcHJhY3Rvci92aWV3cy9yb3cnLFsncmVxdWlyZScsJ2pzb24taWU3JywnanF1ZXJ5JywndW5kZXJzY29yZScsJ2hhbmRsZWJhcnMnLCdoYnMhLi90ZW1wbGF0ZXMvcm93L3JvdycsJ2hicyEuL3RlbXBsYXRlcy9yb3cvZXJyb3JfbWVzc2FnZWJveCddLGZ1bmN0aW9uKHJlcXVpcmUpIHsKICAgIAoKICAgIHZhciBKU09OID0gcmVxdWlyZSgnanNvbi1pZTcnKSwKICAgICAgICAkID0gcmVxdWlyZSgnanF1ZXJ5JyksCiAgICAgICAgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKICAgICAgICBIYW5kbGViYXJzID0gcmVxdWlyZSgnaGFuZGxlYmFycycpLAogICAgICAgIFJvd1RlbXBsYXRlcyA9IHt9LAogICAgICAgIFJvdyA9IHJlcXVpcmUoJ2hicyEuL3RlbXBsYXRlcy9yb3cvcm93JyksCiAgICAgICAgRXJyb3JUZW1wbGF0ZSA9IHJlcXVpcmUoJ2hicyEuL3RlbXBsYXRlcy9yb3cvZXJyb3JfbWVzc2FnZWJveCcpOwoKICAgICAgICBSb3dUZW1wbGF0ZXMgPSB7CiAgICAgICAgICAgICdyb3cnOiBSb3csCiAgICAgICAgICAgICdlcnJvcic6IEVycm9yVGVtcGxhdGUKICAgICAgICB9OwoKICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3JvdycsIGZ1bmN0aW9uKHR5cGUsIG1vZGVsLCBmaWVsZE5hbWUpIHsKICAgICAgICAgICAgLy8gdGVtcGxhdGUgaGVscGVyIGluIHRoZSBmb3JtIG9mOgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyAgICAgIHt7IGZpZWxkICd0ZXh0JyBtb2RlbCAnZmllbGRuYW1lJyBbYXR0ck5hbWU9ImF0dHJWYWx1ZSJdKn19CiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gUm93VGVtcGxhdGVzW3R5cGVdLAogICAgICAgICAgICAgICAgb3B0aW9ucyA9IGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoIC0gMV0sCiAgICAgICAgICAgICAgICBvcHRzID0gb3B0aW9ucy5oYXNoIHx8IHt9LAogICAgICAgICAgICAgICAgaWQgPSAnJywKICAgICAgICAgICAgICAgIHZhbHVlID0gJyc7CgogICAgICAgICAgICBpZiAoIWN1cnJlbnQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWdpc3RlcmVkIGZpZWxkIHRlbXBsYXRlOiAnICsgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhvcHQpOwogICAgICAgICAgICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhjdXJyZW50KHsgbW9kZWw6IG1vZGVsLCBvcHRpb25zOiBvcHRzIH0pKTsKICAgICAgICB9KTsKCiAgICByZXR1cm4gewogICAgICAgIFRlbXBsYXRlczogUm93VGVtcGxhdGVzLAogICAgICAgIGFkZFRlbXBsYXRlOiBmdW5jdGlvbihuYW1lLHRlbXBsYXRlKSB7CiAgICAgICAgICAgIFJvd1RlbXBsYXRlc1tuYW1lXSA9IHRlbXBsYXRlOwogICAgICAgIH0KICAgIH07Cn0pOwoKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCdjaGlyb3ByYWN0b3IvaGJzL3ZpZXcnLFsncmVxdWlyZScsJ3VuZGVyc2NvcmUnLCdiYWNrYm9uZScsJ2hhbmRsZWJhcnMnXSxmdW5jdGlvbihyZXF1aXJlKSB7CiAgICAKCiAgICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKICAgICAgICBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyksCiAgICAgICAgSGFuZGxlYmFycyA9IHJlcXVpcmUoJ2hhbmRsZWJhcnMnKSwKICAgICAgICB2aWV3OwoKICAgIHZpZXcgPSBmdW5jdGlvbigpIHsKICAgICAgICAvLyB0ZW1wbGF0ZSBoZWxwZXIgaW4gdGhlIGZvcm0gb2Y6CiAgICAgICAgLy8KICAgICAgICAvLyAgICAgIHt7IHZpZXcgInBhdGgvdG8vcmVxdWlyZS9tb2R1bGVbfFZpZXdOYW1lXSIgW3ZpZXdPcHRpb25zXSBbY29udGV4dF0gW3ZpZXdPcHRpb24xPXZhbCB2aWV3T3B0aW9uMj12YWxdfX0KICAgICAgICB2YXIgVmlldywgdmlldywgb3B0aW9ucywgcmVxdWlyZVBhdGgsCiAgICAgICAgICAgIHZpZXdOYW1lLCBhdHRycywgcmVxdWlyZUJpdHMsIHBsYWNlaG9sZGVyLAogICAgICAgICAgICBjb250ZXh0ID0ge307CgogICAgICAgIG9wdGlvbnMgPSBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aCAtIDFdOwogICAgICAgIGF0dHJzID0gYXJndW1lbnRzWzFdIHx8IHt9OwogICAgICAgIF8uZGVmYXVsdHMoYXR0cnMsIG9wdGlvbnMuaGFzaCB8fCB7fSk7CgogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSA0KSB7CiAgICAgICAgICAgIGNvbnRleHQgPSBhcmd1bWVudHNbMl07CiAgICAgICAgfQogICAgICAgIF8uZGVmYXVsdHModGhpcywgY29udGV4dCk7CgogICAgICAgIGlmICh0eXBlb2YoYXJndW1lbnRzWzBdKSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgcmVxdWlyZUJpdHMgPSBhcmd1bWVudHNbMF0uc3BsaXQoJ3wnKTsKICAgICAgICAgICAgcmVxdWlyZVBhdGggPSByZXF1aXJlQml0c1swXTsKICAgICAgICAgICAgdmlld05hbWUgPSByZXF1aXJlQml0c1sxXTsKCiAgICAgICAgICAgIFZpZXcgPSByZXF1aXJlKHJlcXVpcmVQYXRoKTsKICAgICAgICAgICAgaWYgKHR5cGVvZih2aWV3TmFtZSkgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBWaWV3ID0gVmlld1t2aWV3TmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIFZpZXcgPSBhcmd1bWVudHNbMF07CiAgICAgICAgfQoKICAgICAgICBpZiAob3B0aW9ucy5mbikgewogICAgICAgICAgICBWaWV3ID0gVmlldy5leHRlbmQoewogICAgICAgICAgICAgICAgdGVtcGxhdGU6IG9wdGlvbnMuZm4KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICB2aWV3ID0gbmV3IFZpZXcoYXR0cnMpLnJlbmRlcigpOwoKICAgICAgICBwbGFjZWhvbGRlciA9IHRoaXMuZGVjbGFyaW5nVmlldy5fYWRkQ2hpbGQodmlldyk7CgogICAgICAgIC8vIFJldHVybiBhIHBsYWNlaG9sZGVyIHRoYXQgdGhlIENoaXJvcHJhY3Rvci5WaWV3IGNhbiByZXBsYWNlIHdpdGgKICAgICAgICAvLyB0aGUgY2hpbGQgdmlldyBhcHBlbmRlZCBhYm92ZS4KICAgICAgICAvLyBJZiB0aGlzIGlzIGNhbGxlZCBhcyBhIGJsb2NrIGhicyBoZWxwZXIsIHRoZW4gd2UgZG8gbm90IG5lZWQgdG8KICAgICAgICAvLyB1c2Ugc2FmZSBzdHJpbmcsIHdoaWxlIGFzIGEgaGJzIHN0YXRlbWVudCBpdCBuZWVkcyB0byBiZSBkZWNsYXJlZAogICAgICAgIC8vIHNhZmUuCiAgICAgICAgaWYgKG9wdGlvbnMuZm4pIHsKICAgICAgICAgICAgcmV0dXJuIHBsYWNlaG9sZGVyOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcocGxhY2Vob2xkZXIpOwogICAgICAgIH0KICAgIH07CgogICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndmlldycsIHZpZXcpOwoKICAgIHJldHVybiB2aWV3Owp9KTsKCgovKiBTVEFSVF9URU1QTEFURSAqLwpkZWZpbmUoJ2hicyFjaGlyb3ByYWN0b3Ivdmlld3MvdGVtcGxhdGVzL2Zvcm1maWVsZC90ZXh0JyxbJ2hicycsJ2hhbmRsZWJhcnMnXSwgZnVuY3Rpb24oIGhicywgSGFuZGxlYmFycyApeyAKdmFyIHQgPSBIYW5kbGViYXJzLnRlbXBsYXRlKGZ1bmN0aW9uIChIYW5kbGViYXJzLGRlcHRoMCxoZWxwZXJzLHBhcnRpYWxzLGRhdGEpIHsKICBoZWxwZXJzID0gaGVscGVycyB8fCBIYW5kbGViYXJzLmhlbHBlcnM7CiAgdmFyIGJ1ZmZlciA9ICIiLCBzdGFjazEsIGZvdW5kSGVscGVyLCBmdW5jdGlvblR5cGU9ImZ1bmN0aW9uIiwgZXNjYXBlRXhwcmVzc2lvbj10aGlzLmVzY2FwZUV4cHJlc3Npb247CgoKICBidWZmZXIgKz0gIjxkaXYgY2xhc3M9XCJjb250cm9sLWdyb3VwXCIgaWQ9XCJjb250YWluZXItIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiPlxyXG4gICAgPGxhYmVsIGNsYXNzPVwiY29udHJvbC1sYWJlbCAiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5sYWJlbGNsYXNzOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubGFiZWxjbGFzczsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIGZvcj1cIiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmlkOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaWQ7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5sYWJlbDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmxhYmVsOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9sYWJlbD5cclxuICAgIDxkaXYgY2xhc3M9XCJjb250cm9sc1wiPlxyXG4gICAgICAgIDxpbnB1dCB0eXBlPVwidGV4dFwiIHBsYWNlaG9sZGVyPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMucGxhY2Vob2xkZXI7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5wbGFjZWhvbGRlcjsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIGlkPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIG5hbWU9XCIiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5uYW1lOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubmFtZTsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIHZhbHVlPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMudmFsdWU7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC52YWx1ZTsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIGNsYXNzPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnNbJ2NsYXNzJ107CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMFsnY2xhc3MnXTsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIC8+XHJcbiAgICAgICAgPHNwYW4gY2xhc3M9XCJkZXNjcmlwdGlvblwiPiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmRlc2NyaXB0aW9uOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuZGVzY3JpcHRpb247IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L3NwYW4+XHJcbiAgICAgICAgPHNwYW4gY2xhc3M9XCJoZWxwLWlubGluZVwiPiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmhlbHA7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5oZWxwOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9zcGFuPlxyXG4gICAgPC9kaXY+XHJcbjwvZGl2PlxyXG4iOwogIHJldHVybiBidWZmZXI7fSk7CkhhbmRsZWJhcnMucmVnaXN0ZXJQYXJ0aWFsKCdjaGlyb3ByYWN0b3Jfdmlld3NfdGVtcGxhdGVzX2Zvcm1maWVsZF90ZXh0JywgdCk7CnJldHVybiB0Owp9KTsKLyogRU5EX1RFTVBMQVRFICovCjsKCi8qIFNUQVJUX1RFTVBMQVRFICovCmRlZmluZSgnaGJzIWNoaXJvcHJhY3Rvci92aWV3cy90ZW1wbGF0ZXMvZm9ybWZpZWxkL3RleHRhcmVhJyxbJ2hicycsJ2hhbmRsZWJhcnMnXSwgZnVuY3Rpb24oIGhicywgSGFuZGxlYmFycyApeyAKdmFyIHQgPSBIYW5kbGViYXJzLnRlbXBsYXRlKGZ1bmN0aW9uIChIYW5kbGViYXJzLGRlcHRoMCxoZWxwZXJzLHBhcnRpYWxzLGRhdGEpIHsKICBoZWxwZXJzID0gaGVscGVycyB8fCBIYW5kbGViYXJzLmhlbHBlcnM7CiAgdmFyIGJ1ZmZlciA9ICIiLCBzdGFjazEsIGZvdW5kSGVscGVyLCBmdW5jdGlvblR5cGU9ImZ1bmN0aW9uIiwgZXNjYXBlRXhwcmVzc2lvbj10aGlzLmVzY2FwZUV4cHJlc3Npb247CgoKICBidWZmZXIgKz0gIjxkaXYgY2xhc3M9XCJjb250cm9sLWdyb3VwXCIgaWQ9XCJjb250YWluZXItIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiPlxyXG4gICAgPGxhYmVsIGNsYXNzPVwiY29udHJvbC1sYWJlbFwiIGZvcj1cIiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmlkOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaWQ7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5sYWJlbDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmxhYmVsOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9sYWJlbD5cclxuICAgIDxkaXYgY2xhc3M9XCJjb250cm9sc1wiPlxyXG4gICAgICAgIDx0ZXh0YXJlYSBpZD1cIiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmlkOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaWQ7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIiBuYW1lPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMubmFtZTsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLm5hbWU7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy52YWx1ZTsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLnZhbHVlOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC90ZXh0YXJlYT5cclxuICAgICAgICA8c3BhbiBjbGFzcz1cImhlbHAtaW5saW5lXCI+IjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaGVscDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmhlbHA7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L3NwYW4+XHJcbiAgICA8L2Rpdj5cclxuPC9kaXY+XHJcbiI7CiAgcmV0dXJuIGJ1ZmZlcjt9KTsKSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoJ2NoaXJvcHJhY3Rvcl92aWV3c190ZW1wbGF0ZXNfZm9ybWZpZWxkX3RleHRhcmVhJywgdCk7CnJldHVybiB0Owp9KTsKLyogRU5EX1RFTVBMQVRFICovCjsKCi8qIFNUQVJUX1RFTVBMQVRFICovCmRlZmluZSgnaGJzIWNoaXJvcHJhY3Rvci92aWV3cy90ZW1wbGF0ZXMvZm9ybWZpZWxkL3NlbGVjdCcsWydoYnMnLCdoYW5kbGViYXJzJ10sIGZ1bmN0aW9uKCBoYnMsIEhhbmRsZWJhcnMgKXsgCnZhciB0ID0gSGFuZGxlYmFycy50ZW1wbGF0ZShmdW5jdGlvbiAoSGFuZGxlYmFycyxkZXB0aDAsaGVscGVycyxwYXJ0aWFscyxkYXRhKSB7CiAgaGVscGVycyA9IGhlbHBlcnMgfHwgSGFuZGxlYmFycy5oZWxwZXJzOwogIHZhciBidWZmZXIgPSAiIiwgc3RhY2sxLCBmb3VuZEhlbHBlciwgZnVuY3Rpb25UeXBlPSJmdW5jdGlvbiIsIGVzY2FwZUV4cHJlc3Npb249dGhpcy5lc2NhcGVFeHByZXNzaW9uLCBzZWxmPXRoaXMsIGhlbHBlck1pc3Npbmc9aGVscGVycy5oZWxwZXJNaXNzaW5nOwoKZnVuY3Rpb24gcHJvZ3JhbTEoZGVwdGgwLGRhdGEpIHsKICAKICB2YXIgYnVmZmVyID0gIiIsIHN0YWNrMSwgZm91bmRIZWxwZXI7CiAgYnVmZmVyICs9ICJcclxuICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9XCJcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5ibGFuazsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmJsYW5rOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9vcHRpb24+XHJcbiAgICAgICAgICAgICI7CiAgcmV0dXJuIGJ1ZmZlcjt9CgpmdW5jdGlvbiBwcm9ncmFtMyhkZXB0aDAsZGF0YSxkZXB0aDEpIHsKICAKICB2YXIgYnVmZmVyID0gIiIsIHN0YWNrMSwgc3RhY2syLCBmb3VuZEhlbHBlcjsKICBidWZmZXIgKz0gIlxyXG4gICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT1cIiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLnZhbHVlOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAudmFsdWU7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIiI7CiAgc3RhY2sxID0gZGVwdGgxLnZhbHVlOwogIHN0YWNrMiA9IGRlcHRoMC52YWx1ZTsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWZlcXVhbDsKICBzdGFjazEgPSBmb3VuZEhlbHBlciA/IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCBzdGFjazIsIHN0YWNrMSwge2hhc2g6e30saW52ZXJzZTpzZWxmLm5vb3AsZm46c2VsZi5wcm9ncmFtKDQsIHByb2dyYW00LCBkYXRhKX0pIDogaGVscGVyTWlzc2luZy5jYWxsKGRlcHRoMCwgImlmZXF1YWwiLCBzdGFjazIsIHN0YWNrMSwge2hhc2g6e30saW52ZXJzZTpzZWxmLm5vb3AsZm46c2VsZi5wcm9ncmFtKDQsIHByb2dyYW00LCBkYXRhKX0pOwogIGlmKHN0YWNrMSB8fCBzdGFjazEgPT09IDApIHsgYnVmZmVyICs9IHN0YWNrMTsgfQogIGJ1ZmZlciArPSAiPiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmxhYmVsOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubGFiZWw7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L29wdGlvbj5cclxuICAgICAgICAgICAgIjsKICByZXR1cm4gYnVmZmVyO30KZnVuY3Rpb24gcHJvZ3JhbTQoZGVwdGgwLGRhdGEpIHsKICAKICAKICByZXR1cm4gIiBzZWxlY3RlZD1cInNlbGVjdGVkXCIiO30KCiAgYnVmZmVyICs9ICI8ZGl2IGNsYXNzPVwiY29udHJvbC1ncm91cFwiIGlkPVwiY29udGFpbmVyLSI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmlkOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaWQ7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIj5cclxuICAgIDxsYWJlbCBjbGFzcz1cImNvbnRyb2wtbGFiZWwgIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMubGFiZWxjbGFzczsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmxhYmVsY2xhc3M7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIiBmb3I9XCIiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5pZDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmlkOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiXCI+IjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMubGFiZWw7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5sYWJlbDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIjwvbGFiZWw+XHJcbiAgICA8ZGl2IGNsYXNzPVwiY29udHJvbHNcIj5cclxuICAgICAgICA8c2VsZWN0IGlkPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIG5hbWU9XCIiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5uYW1lOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubmFtZTsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiPlxyXG4gICAgICAgICAgICAiOwogIHN0YWNrMSA9IGRlcHRoMC5ibGFuazsKICBzdGFjazEgPSBoZWxwZXJzWydpZiddLmNhbGwoZGVwdGgwLCBzdGFjazEsIHtoYXNoOnt9LGludmVyc2U6c2VsZi5ub29wLGZuOnNlbGYucHJvZ3JhbSgxLCBwcm9ncmFtMSwgZGF0YSl9KTsKICBpZihzdGFjazEgfHwgc3RhY2sxID09PSAwKSB7IGJ1ZmZlciArPSBzdGFjazE7IH0KICBidWZmZXIgKz0gIlxyXG4gICAgICAgICAgICAiOwogIHN0YWNrMSA9IGRlcHRoMC5vcHRpb25zOwogIHN0YWNrMSA9IGhlbHBlcnMuZWFjaC5jYWxsKGRlcHRoMCwgc3RhY2sxLCB7aGFzaDp7fSxpbnZlcnNlOnNlbGYubm9vcCxmbjpzZWxmLnByb2dyYW1XaXRoRGVwdGgocHJvZ3JhbTMsIGRhdGEsIGRlcHRoMCl9KTsKICBpZihzdGFjazEgfHwgc3RhY2sxID09PSAwKSB7IGJ1ZmZlciArPSBzdGFjazE7IH0KICBidWZmZXIgKz0gIlxyXG4gICAgICAgIDwvc2VsZWN0PlxyXG4gICAgICAgIDxzcGFuIGNsYXNzPVwiZGVzY3JpcHRpb25cIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5kZXNjcmlwdGlvbjsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmRlc2NyaXB0aW9uOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9zcGFuPlxyXG4gICAgICAgIDxzcGFuIGNsYXNzPVwiaGVscC1pbmxpbmVcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5oZWxwOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaGVscDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIjwvc3Bhbj5cclxuICAgIDwvZGl2PlxyXG48L2Rpdj5cclxuIjsKICByZXR1cm4gYnVmZmVyO30pOwpIYW5kbGViYXJzLnJlZ2lzdGVyUGFydGlhbCgnY2hpcm9wcmFjdG9yX3ZpZXdzX3RlbXBsYXRlc19mb3JtZmllbGRfc2VsZWN0JywgdCk7CnJldHVybiB0Owp9KTsKLyogRU5EX1RFTVBMQVRFICovCjsKCi8qIFNUQVJUX1RFTVBMQVRFICovCmRlZmluZSgnaGJzIWNoaXJvcHJhY3Rvci92aWV3cy90ZW1wbGF0ZXMvZm9ybWZpZWxkL2NoZWNrYm94JyxbJ2hicycsJ2hhbmRsZWJhcnMnXSwgZnVuY3Rpb24oIGhicywgSGFuZGxlYmFycyApeyAKdmFyIHQgPSBIYW5kbGViYXJzLnRlbXBsYXRlKGZ1bmN0aW9uIChIYW5kbGViYXJzLGRlcHRoMCxoZWxwZXJzLHBhcnRpYWxzLGRhdGEpIHsKICBoZWxwZXJzID0gaGVscGVycyB8fCBIYW5kbGViYXJzLmhlbHBlcnM7CiAgdmFyIGJ1ZmZlciA9ICIiLCBzdGFjazEsIGZvdW5kSGVscGVyLCBmdW5jdGlvblR5cGU9ImZ1bmN0aW9uIiwgZXNjYXBlRXhwcmVzc2lvbj10aGlzLmVzY2FwZUV4cHJlc3Npb24sIHNlbGY9dGhpczsKCmZ1bmN0aW9uIHByb2dyYW0xKGRlcHRoMCxkYXRhKSB7CiAgCiAgdmFyIGJ1ZmZlciA9ICIiLCBzdGFjazEsIGZvdW5kSGVscGVyOwogIGJ1ZmZlciArPSAiIFxyXG4gICAgICAgICAgICA8aW5wdXQgdHlwZT1cImNoZWNrYm94XCIgaWQ9XCIiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5pZDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmlkOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiXCIgbmFtZT1cIiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLm5hbWU7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5uYW1lOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiXCIgdmFsdWU9XCIiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy52YWx1ZTsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLnZhbHVlOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiXCIgLz4gIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMubGFiZWw7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5sYWJlbDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlxyXG4gICAgICAgICI7CiAgcmV0dXJuIGJ1ZmZlcjt9CgogIGJ1ZmZlciArPSAiPGRpdiBjbGFzcz1cImNvbnRyb2wtZ3JvdXBcIiBpZD1cImNvbnRhaW5lci0iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5pZDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmlkOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiXCI+XHJcbiAgICA8bGFiZWwgY2xhc3M9XCJjb250cm9sLWxhYmVsXCIgZm9yPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiPiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmxhYmVsOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubGFiZWw7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L2xhYmVsPlxyXG4gICAgPGRpdiBjbGFzcz1cImNvbnRyb2xzXCI+XHJcbiAgICAgICAgIjsKICBzdGFjazEgPSBkZXB0aDAub3B0aW9uczsKICBzdGFjazEgPSBoZWxwZXJzLmVhY2guY2FsbChkZXB0aDAsIHN0YWNrMSwge2hhc2g6e30saW52ZXJzZTpzZWxmLm5vb3AsZm46c2VsZi5wcm9ncmFtKDEsIHByb2dyYW0xLCBkYXRhKX0pOwogIGlmKHN0YWNrMSB8fCBzdGFjazEgPT09IDApIHsgYnVmZmVyICs9IHN0YWNrMTsgfQogIGJ1ZmZlciArPSAiXHJcbiAgICAgICAgPHNwYW4gY2xhc3M9XCJoZWxwLWlubGluZVwiPiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmhlbHA7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5oZWxwOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9zcGFuPlxyXG4gICAgPC9kaXY+XHJcbjwvZGl2PlxyXG4iOwogIHJldHVybiBidWZmZXI7fSk7CkhhbmRsZWJhcnMucmVnaXN0ZXJQYXJ0aWFsKCdjaGlyb3ByYWN0b3Jfdmlld3NfdGVtcGxhdGVzX2Zvcm1maWVsZF9jaGVja2JveCcsIHQpOwpyZXR1cm4gdDsKfSk7Ci8qIEVORF9URU1QTEFURSAqLwo7CgovKiBTVEFSVF9URU1QTEFURSAqLwpkZWZpbmUoJ2hicyFjaGlyb3ByYWN0b3Ivdmlld3MvdGVtcGxhdGVzL2Zvcm1maWVsZC9yYWRpbycsWydoYnMnLCdoYW5kbGViYXJzJ10sIGZ1bmN0aW9uKCBoYnMsIEhhbmRsZWJhcnMgKXsgCnZhciB0ID0gSGFuZGxlYmFycy50ZW1wbGF0ZShmdW5jdGlvbiAoSGFuZGxlYmFycyxkZXB0aDAsaGVscGVycyxwYXJ0aWFscyxkYXRhKSB7CiAgaGVscGVycyA9IGhlbHBlcnMgfHwgSGFuZGxlYmFycy5oZWxwZXJzOwogIHZhciBidWZmZXIgPSAiIiwgc3RhY2sxLCBmb3VuZEhlbHBlciwgZnVuY3Rpb25UeXBlPSJmdW5jdGlvbiIsIGVzY2FwZUV4cHJlc3Npb249dGhpcy5lc2NhcGVFeHByZXNzaW9uLCBzZWxmPXRoaXM7CgpmdW5jdGlvbiBwcm9ncmFtMShkZXB0aDAsZGF0YSkgewogIAogIHZhciBidWZmZXIgPSAiIiwgc3RhY2sxLCBmb3VuZEhlbHBlcjsKICBidWZmZXIgKz0gIiBcclxuICAgICAgICAgICAgPGlucHV0IHR5cGU9XCJyYWRpb1wiIGlkPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIG5hbWU9XCIiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5uYW1lOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubmFtZTsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIHZhbHVlPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMudmFsdWU7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC52YWx1ZTsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIC8+ICI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmxhYmVsOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubGFiZWw7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcclxuICAgICAgICAiOwogIHJldHVybiBidWZmZXI7fQoKICBidWZmZXIgKz0gIjxkaXYgY2xhc3M9XCJjb250cm9sLWdyb3VwXCIgaWQ9XCJjb250YWluZXItIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiPlxyXG4gICAgPGxhYmVsIGNsYXNzPVwiY29udHJvbC1sYWJlbFwiIGZvcj1cIiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmlkOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaWQ7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5sYWJlbDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmxhYmVsOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9sYWJlbD5cclxuICAgIDxkaXYgY2xhc3M9XCJjb250cm9sc1wiPlxyXG4gICAgICAgICI7CiAgc3RhY2sxID0gZGVwdGgwLm9wdGlvbnM7CiAgc3RhY2sxID0gaGVscGVycy5lYWNoLmNhbGwoZGVwdGgwLCBzdGFjazEsIHtoYXNoOnt9LGludmVyc2U6c2VsZi5ub29wLGZuOnNlbGYucHJvZ3JhbSgxLCBwcm9ncmFtMSwgZGF0YSl9KTsKICBpZihzdGFjazEgfHwgc3RhY2sxID09PSAwKSB7IGJ1ZmZlciArPSBzdGFjazE7IH0KICBidWZmZXIgKz0gIlxyXG4gICAgICAgIDxzcGFuIGNsYXNzPVwiaGVscC1pbmxpbmVcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5oZWxwOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaGVscDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIjwvc3Bhbj5cclxuICAgIDwvZGl2PlxyXG48L2Rpdj5cclxuIjsKICByZXR1cm4gYnVmZmVyO30pOwpIYW5kbGViYXJzLnJlZ2lzdGVyUGFydGlhbCgnY2hpcm9wcmFjdG9yX3ZpZXdzX3RlbXBsYXRlc19mb3JtZmllbGRfcmFkaW8nLCB0KTsKcmV0dXJuIHQ7Cn0pOwovKiBFTkRfVEVNUExBVEUgKi8KOwovKmdsb2JhbCBkZWZpbmUqLwpkZWZpbmUoJ2NoaXJvcHJhY3Rvci92aWV3cy9mb3JtZmllbGQnLFsncmVxdWlyZScsJ2pzb24taWU3JywnanF1ZXJ5JywndW5kZXJzY29yZScsJ2hhbmRsZWJhcnMnLCcuLi9oYnMvdmlldycsJy4vYmFzZScsJ2hicyEuL3RlbXBsYXRlcy9mb3JtZmllbGQvdGV4dCcsJ2hicyEuL3RlbXBsYXRlcy9mb3JtZmllbGQvdGV4dGFyZWEnLCdoYnMhLi90ZW1wbGF0ZXMvZm9ybWZpZWxkL3NlbGVjdCcsJ2hicyEuL3RlbXBsYXRlcy9mb3JtZmllbGQvY2hlY2tib3gnLCdoYnMhLi90ZW1wbGF0ZXMvZm9ybWZpZWxkL3JhZGlvJ10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgCgogICAgdmFyIEpTT04gPSByZXF1aXJlKCdqc29uLWllNycpLAogICAgICAgICQgPSByZXF1aXJlKCdqcXVlcnknKSwKICAgICAgICBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpLAogICAgICAgIEhhbmRsZWJhcnMgPSByZXF1aXJlKCdoYW5kbGViYXJzJyksCiAgICAgICAgdmlld0hlbHBlciA9IHJlcXVpcmUoJy4uL2hicy92aWV3JyksCiAgICAgICAgQmFzZSA9IHJlcXVpcmUoJy4vYmFzZScpLAogICAgICAgIGZpZWxkVGVtcGxhdGVzID0ge30sCiAgICAgICAgVmlldywgcmVnaXN0ZXI7CgogICAgVmlldyA9IEJhc2UuZXh0ZW5kKHsKICAgICAgICBldmVudHM6IHsKICAgICAgICAgICAgJ2NoYW5nZSBpbnB1dCc6ICdpbnB1dENoYW5nZWQnLAogICAgICAgICAgICAnYmx1ciBpbnB1dCc6ICdpbnB1dENoYW5nZWQnLAogICAgICAgICAgICAnY2hhbmdlIHNlbGVjdCc6ICdpbnB1dENoYW5nZWQnLAogICAgICAgICAgICAnYmx1ciBzZWxlY3QnOiAnaW5wdXRDaGFuZ2VkJywKICAgICAgICAgICAgJ2NoYW5nZSB0ZXh0YXJlYSc6ICdpbnB1dENoYW5nZWQnLAogICAgICAgICAgICAnYmx1ciB0ZXh0YXJlYSc6ICdpbnB1dENoYW5nZWQnCiAgICAgICAgfSwKCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICBCYXNlLnByb3RvdHlwZS5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gb3B0aW9ucy5jb250ZXh0OwogICAgICAgICAgICB0aGlzLmZpZWxkID0gb3B0aW9ucy5maWVsZDsKICAgICAgICB9LAogICAgICAgIGlucHV0Q2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB2YWwgPSB0aGlzLiQoJ1tuYW1lPScgKyB0aGlzLmZpZWxkICsgJ10nKS52YWwoKTsKICAgICAgICAgICAgdGhpcy5tb2RlbC5zZXQodGhpcy5maWVsZCwgdmFsLCB7dmFsaWRhdGU6IHRydWV9KTsKICAgICAgICAgICAgLy8gV2Ugd2FudCB0byBlbnN1cmUgdGhhdCB0aGUgbW9kZWwgdmFsdWUgaXMgcmVhbGx5IHVwZGF0ZWQgZXZlbgogICAgICAgICAgICAvLyBpZiB2YWxpZGF0aW9uIGZhaWxzIGluIHRoZSBwcmV2aW91cyBzdGVwLiBIb3dldmVyLCBpdCBzaG91bGQgYmUKICAgICAgICAgICAgLy8gc2lsZW50IGFuZCBub3QgdHJpZ2dlciBhbnkgY2hhbmdlIGV2ZW50cyBzaW5jZSB0aGUgcHJldmlvdXMgc3RlcAogICAgICAgICAgICAvLyB3aWxsIHRha2UgY2FyZSBvZiB0aGF0IGluIHRoZSBjYXNlIG9mIHN1Y2Nlc3MuCiAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KHRoaXMuZmllbGQsIHZhbCwge3NpbGVudDogdHJ1ZX0pOwogICAgICAgIH0KICAgIH0pOwoKICAgIFZpZXcucmVnaXN0ZXIgPSByZWdpc3RlciA9IGZ1bmN0aW9uKHR5cGUsIGRlZikgewogICAgICAgIHZhciBTdWJDbGFzcyA9IGZpZWxkVGVtcGxhdGVzW3R5cGVdID0gdGhpcy5leHRlbmQoZGVmKTsKICAgICAgICBTdWJDbGFzcy5yZWdpc3RlciA9IHJlZ2lzdGVyOwogICAgICAgIHJldHVybiBTdWJDbGFzczsKICAgIH07CgogICAgVmlldy51bnJlZ2lzdGVyID0gZnVuY3Rpb24odHlwZSkgewogICAgICAgIGlmIChmaWVsZFRlbXBsYXRlc1t0eXBlXSkgewogICAgICAgICAgICBkZWxldGUgZmllbGRUZW1wbGF0ZXNbdHlwZV07CiAgICAgICAgfQogICAgfTsKCiAgICBWaWV3LnJlZ2lzdGVyKCd0ZXh0JywgewogICAgICAgIHRlbXBsYXRlOiByZXF1aXJlKCdoYnMhLi90ZW1wbGF0ZXMvZm9ybWZpZWxkL3RleHQnKQogICAgfSk7CgogICAgVmlldy5yZWdpc3RlcigndGV4dGFyZWEnLCB7CiAgICAgICAgdGVtcGxhdGU6IHJlcXVpcmUoJ2hicyEuL3RlbXBsYXRlcy9mb3JtZmllbGQvdGV4dGFyZWEnKQogICAgfSk7CgogICAgVmlldy5yZWdpc3Rlcignc2VsZWN0JywgewogICAgICAgIHRlbXBsYXRlOiByZXF1aXJlKCdoYnMhLi90ZW1wbGF0ZXMvZm9ybWZpZWxkL3NlbGVjdCcpCiAgICB9KTsKCiAgICBWaWV3LnJlZ2lzdGVyKCdjaGVja2JveCcsIHsKICAgICAgICB0ZW1wbGF0ZTogcmVxdWlyZSgnaGJzIS4vdGVtcGxhdGVzL2Zvcm1maWVsZC9jaGVja2JveCcpCiAgICB9KTsKCiAgICBWaWV3LnJlZ2lzdGVyKCdyYWRpbycsIHsKICAgICAgICB0ZW1wbGF0ZTogcmVxdWlyZSgnaGJzIS4vdGVtcGxhdGVzL2Zvcm1maWVsZC9yYWRpbycpCiAgICB9KTsKCiAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdmb3JtZmllbGQnLCBmdW5jdGlvbih0eXBlLCBtb2RlbCwgZmllbGROYW1lKSB7CiAgICAgICAgLy8gdGVtcGxhdGUgaGVscGVyIGluIHRoZSBmb3JtIG9mOgogICAgICAgIC8vCiAgICAgICAgLy8gICAgICB7eyBmb3JtZmllbGQgJ3RleHQnIG1vZGVsICdmaWVsZG5hbWUnIFthdHRyTmFtZT0iYXR0clZhbHVlIl0qfX0KICAgICAgICB2YXIgRm9ybUZpZWxkID0gZmllbGRUZW1wbGF0ZXNbdHlwZV0sCiAgICAgICAgICAgIG9wdGlvbnMgPSBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aCAtIDFdLAogICAgICAgICAgICBvcHRzID0gb3B0aW9ucy5oYXNoIHx8IHt9OwoKICAgICAgICBpZiAoIUZvcm1GaWVsZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VucmVnaXN0ZXJlZCBmb3JtZmllbGQgdGVtcGxhdGU6ICcgKyB0eXBlKTsKICAgICAgICB9CgogICAgICAgIF8uZGVmYXVsdHMob3B0cywgewogICAgICAgICAgICBpZDogbW9kZWwuZmllbGRJZChmaWVsZE5hbWUpLAogICAgICAgICAgICBsYWJlbDogZmllbGROYW1lLAogICAgICAgICAgICBuYW1lOiBmaWVsZE5hbWUsCiAgICAgICAgICAgIG9wdGlvbnM6IFtdLAogICAgICAgICAgICBibGFuazogZmFsc2UsCiAgICAgICAgICAgIHZhbHVlOiBtb2RlbC5nZXQoZmllbGROYW1lKSB8fCAnJywKICAgICAgICAgICAgaGVscDogJycKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdmlld0hlbHBlci5jYWxsKHRoaXMsIEZvcm1GaWVsZCwgewogICAgICAgICAgICBmaWVsZDogZmllbGROYW1lLAogICAgICAgICAgICBtb2RlbDogbW9kZWwsCiAgICAgICAgICAgIGNvbnRleHQ6IG9wdHMKICAgICAgICB9LCBvcHRpb25zKTsKICAgIH0pOwoKICAgIHJldHVybiBWaWV3Owp9KTsKCi8qZ2xvYmFsIGRlZmluZSovCmRlZmluZSgnY2hpcm9wcmFjdG9yL3ZpZXdzJyxbJ3JlcXVpcmUnLCcuL3ZpZXdzL2Jhc2UnLCcuL3ZpZXdzL2Zvcm0nLCcuL3ZpZXdzL2ZpZWxkJywnLi92aWV3cy9yb3cnLCcuL3ZpZXdzL2Zvcm1maWVsZCddLGZ1bmN0aW9uKHJlcXVpcmUpIHsKICAgIAoKICAgIHZhciBCYXNlID0gcmVxdWlyZSgnLi92aWV3cy9iYXNlJyksCiAgICAgICAgRm9ybSA9IHJlcXVpcmUoJy4vdmlld3MvZm9ybScpLAogICAgICAgIEZpZWxkID0gcmVxdWlyZSgnLi92aWV3cy9maWVsZCcpLAogICAgICAgIFJvdyA9IHJlcXVpcmUoJy4vdmlld3Mvcm93JyksCiAgICAgICAgRm9ybUZpZWxkID0gcmVxdWlyZSgnLi92aWV3cy9mb3JtZmllbGQnKTsKCiAgICByZXR1cm4gewogICAgICAgIEJhc2U6IEJhc2UsCiAgICAgICAgRm9ybTogRm9ybSwKICAgICAgICBSb3c6IFJvdywKICAgICAgICBGaWVsZDogRmllbGQsCiAgICAgICAgRm9ybUZpZWxkOiBGb3JtRmllbGQKICAgIH07Cn0pOwoKLyoqCiAqIEBwcmVzZXJ2ZSBjb25zb2xlLXNoaW0gMS4wLjMKICogaHR0cHM6Ly9naXRodWIuY29tL2theWFoci9jb25zb2xlLXNoaW0KICogQ29weXJpZ2h0IChDKSAyMDExIEtsYXVzIFJlaW1lciA8a0BhaWxpcy5kZT4KICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqIChTZWUgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZSkKICovCiAKIAooZnVuY3Rpb24oKXsKCgovKioKICogUmV0dXJucyBhIGZ1bmN0aW9uIHdoaWNoIGNhbGxzIHRoZSBzcGVjaWZpZWQgZnVuY3Rpb24gaW4gdGhlIHNwZWNpZmllZAogKiBzY29wZS4KICoKICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYwogKiAgICAgICAgICAgIFRoZSBmdW5jdGlvbiB0byBjYWxsLgogKiBAcGFyYW0ge09iamVjdH0gc2NvcGUKICogICAgICAgICAgICBUaGUgc2NvcGUgdG8gY2FsbCB0aGUgZnVuY3Rpb24gaW4uCiAqIEBwYXJhbSB7Li4uKn0gYXJncwogKiAgICAgICAgICAgIEFkZGl0aW9uYWwgYXJndW1lbnRzIHRvIHBhc3MgdG8gdGhlIGJvdW5kIGZ1bmN0aW9uLgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oLi4uWypdKTogdW5kZWZpbmVkfQogKiAgICAgICAgICAgIFRoZSBib3VuZCBmdW5jdGlvbi4KICovCnZhciBiaW5kID0gZnVuY3Rpb24oZnVuYywgc2NvcGUsIGFyZ3MpCnsKICAgIHZhciBmaXhlZEFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB2YXIgYXJncyA9IGZpeGVkQXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSk7CiAgICAgICAgKC8qKiBAdHlwZSB7RnVuY3Rpb259ICovIGZ1bmMpLmFwcGx5KHNjb3BlLCBhcmdzKTsKICAgIH07Cn07CgovLyBDcmVhdGUgY29uc29sZSBpZiBub3QgcHJlc2VudAppZiAoIXdpbmRvd1siY29uc29sZSJdKSB3aW5kb3cuY29uc29sZSA9IC8qKiBAdHlwZSB7Q29uc29sZX0gKi8gKHt9KTsKdmFyIGNvbnNvbGUgPSAoLyoqIEB0eXBlIHtPYmplY3R9ICovIHdpbmRvdy5jb25zb2xlKTsKCi8vIEltcGxlbWVudCBjb25zb2xlIGxvZyBpZiBuZWVkZWQKaWYgKCFjb25zb2xlWyJsb2ciXSkKewogICAgLy8gVXNlIGxvZzRqYXZhc2NyaXB0IGlmIHByZXNlbnQKICAgIGlmICh3aW5kb3dbImxvZzRqYXZhc2NyaXB0Il0pCiAgICB7CiAgICAgICAgdmFyIGxvZyA9IGxvZzRqYXZhc2NyaXB0LmdldERlZmF1bHRMb2dnZXIoKTsKICAgICAgICBjb25zb2xlLmxvZyA9IGJpbmQobG9nLmluZm8sIGxvZyk7CiAgICAgICAgY29uc29sZS5kZWJ1ZyA9IGJpbmQobG9nLmRlYnVnLCBsb2cpOwogICAgICAgIGNvbnNvbGUuaW5mbyA9IGJpbmQobG9nLmluZm8sIGxvZyk7CiAgICAgICAgY29uc29sZS53YXJuID0gYmluZChsb2cud2FybiwgbG9nKTsKICAgICAgICBjb25zb2xlLmVycm9yID0gYmluZChsb2cuZXJyb3IsIGxvZyk7CiAgICB9CiAgICAKICAgIC8vIFVzZSBlbXB0eSBkdW1teSBpbXBsZW1lbnRhdGlvbiB0byBpZ25vcmUgbG9nZ2luZwogICAgZWxzZQogICAgewogICAgICAgIGNvbnNvbGUubG9nID0gKC8qKiBAcGFyYW0gey4uLip9IGFyZ3MgKi8gZnVuY3Rpb24oYXJncykge30pOwogICAgfQp9CgovLyBJbXBsZW1lbnQgb3RoZXIgbG9nIGxldmVscyB0byBjb25zb2xlLmxvZyBpZiBtaXNzaW5nCmlmICghY29uc29sZVsiZGVidWciXSkgY29uc29sZS5kZWJ1ZyA9IGNvbnNvbGUubG9nOwppZiAoIWNvbnNvbGVbImluZm8iXSkgY29uc29sZS5pbmZvID0gY29uc29sZS5sb2c7CmlmICghY29uc29sZVsid2FybiJdKSBjb25zb2xlLndhcm4gPSBjb25zb2xlLmxvZzsKaWYgKCFjb25zb2xlWyJlcnJvciJdKSBjb25zb2xlLmVycm9yID0gY29uc29sZS5sb2c7CgovLyBXcmFwIHRoZSBsb2cgbWV0aG9kcyBpbiBJRSAoPD05KSBiZWNhdXNlIHRoZWlyIGFyZ3VtZW50IGhhbmRsaW5nIGlzIHdyb25nCi8vIFRoaXMgd3JhcHBpbmcgaXMgYWxzbyBkb25lIGlmIHRoZSBfX2NvbnNvbGVTaGltVGVzdF9fIHN5bWJvbCBpcyBzZXQuIFRoaXMKLy8gaXMgbmVlZGVkIGZvciB1bml0IHRlc3RpbmcuCmlmICh3aW5kb3dbIl9fY29uc29sZVNoaW1UZXN0X18iXSAhPSBudWxsIHx8IAogICAgZXZhbCgiLypAY2Nfb24gQF9qc2NyaXB0X3ZlcnNpb24gPD0gOUAqLyIpKQp7CiAgICAvKioKICAgICAqIFdyYXBzIHRoZSBjYWxsIHRvIGEgcmVhbCBJRSBsb2dnaW5nIG1ldGhvZC4gTW9kaWZpZXMgdGhlIGFyZ3VtZW50cyBzbwogICAgICogcGFyYW1ldGVycyB3aGljaCBhcmUgbm90IHJlcHJlc2VudGVkIGJ5IGEgcGxhY2Vob2xkZXIgYXJlIHByb3Blcmx5CiAgICAgKiBwcmludGVkIHdpdGggYSBzcGFjZSBjaGFyYWN0ZXIgYXMgc2VwYXJhdG9yLgogICAgICoKICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncwogICAgICogICAgICAgICAgICBUaGUgZnVuY3Rpb24gYXJndW1lbnRzLiBGaXJzdCBhcmd1bWVudCBpcyB0aGUgbG9nIGZ1bmN0aW9uCiAgICAgKiAgICAgICAgICAgIHRvIGNhbGwsIHRoZSBvdGhlciBhcmd1bWVudHMgYXJlIHRoZSBsb2cgYXJndW1lbnRzLgogICAgICovCiAgICB2YXIgd3JhcCA9IGZ1bmN0aW9uKGFyZ3MpCiAgICB7CiAgICAgICAgdmFyIGksIG1heCwgbWF0Y2gsIGxvZzsKICAgICAgICAKICAgICAgICAvLyBDb252ZXJ0IGFyZ3VtZW50IGxpc3QgdG8gcmVhbCBhcnJheQogICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgICAgIAogICAgICAgIC8vIEZpcnN0IGFyZ3VtZW50IGlzIHRoZSBsb2cgbWV0aG9kIHRvIGNhbGwKICAgICAgICBsb2cgPSBhcmdzLnNoaWZ0KCk7CiAgICAgICAgCiAgICAgICAgbWF4ID0gYXJncy5sZW5ndGg7CiAgICAgICAgaWYgKG1heCA+IDEgJiYgd2luZG93WyJfX2NvbnNvbGVTaGltVGVzdF9fIl0gIT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgLy8gV2hlbiBmaXJzdCBwYXJhbWV0ZXIgaXMgbm90IGEgc3RyaW5nIHRoZW4gYWRkIGEgZm9ybWF0IHN0cmluZyB0bwogICAgICAgICAgICAvLyB0aGUgYXJndW1lbnQgbGlzdCBzbyB3ZSBhcmUgYWJsZSB0byBtb2RpZnkgaXQgaW4gdGhlIG5leHQgc3RvcAogICAgICAgICAgICBpZiAodHlwZW9mKGFyZ3NbMF0pICE9ICJzdHJpbmciKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBhcmdzLnVuc2hpZnQoIiVvIik7CiAgICAgICAgICAgICAgICBtYXggKz0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9yIGVhY2ggYWRkaXRpb25hbCBwYXJhbWV0ZXIgd2hpY2ggaGFzIG5vIHBsYWNlaG9sZGVyIGluIHRoZQogICAgICAgICAgICAvLyBmb3JtYXQgc3RyaW5nIHdlIGFkZCBhbm90aGVyIHBsYWNlaG9sZGVyIHNlcGFyYXRlZCB3aXRoIGEKICAgICAgICAgICAgLy8gc3BhY2UgY2hhcmFjdGVyLgogICAgICAgICAgICBtYXRjaCA9IGFyZ3NbMF0ubWF0Y2goLyVbYS16XS9nKTsKICAgICAgICAgICAgZm9yIChpID0gbWF0Y2ggPyBtYXRjaC5sZW5ndGggKyAxIDogMTsgaSA8IG1heDsgaSArPSAxKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBhcmdzWzBdICs9ICIgJW8iOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIEZ1bmN0aW9uLmFwcGx5LmNhbGwobG9nLCBjb25zb2xlLCBhcmdzKTsKICAgIH07CiAgICAKICAgIC8vIFdyYXAgdGhlIG5hdGl2ZSBsb2cgbWV0aG9kcyBvZiBJRSB0byBmaXggYXJndW1lbnQgb3V0cHV0IHByb2JsZW1zCiAgICBjb25zb2xlLmxvZyA9IGJpbmQod3JhcCwgd2luZG93LCBjb25zb2xlLmxvZyk7CiAgICBjb25zb2xlLmRlYnVnID0gYmluZCh3cmFwLCB3aW5kb3csIGNvbnNvbGUuZGVidWcpOwogICAgY29uc29sZS5pbmZvID0gYmluZCh3cmFwLCB3aW5kb3csIGNvbnNvbGUuaW5mbyk7CiAgICBjb25zb2xlLndhcm4gPSBiaW5kKHdyYXAsIHdpbmRvdywgY29uc29sZS53YXJuKTsKICAgIGNvbnNvbGUuZXJyb3IgPSBiaW5kKHdyYXAsIHdpbmRvdywgY29uc29sZS5lcnJvcik7Cn0KCi8vIEltcGxlbWVudCBjb25zb2xlLmFzc2VydCBpZiBtaXNzaW5nCmlmICghY29uc29sZVsiYXNzZXJ0Il0pCnsKICAgIGNvbnNvbGVbImFzc2VydCJdID0gZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICB2YXIgZXhwciA9IGFyZ3Muc2hpZnQoKTsKICAgICAgICBpZiAoIWV4cHIpCiAgICAgICAgewogICAgICAgICAgICBhcmdzWzBdID0gIkFzc2VydGlvbiBmYWlsZWQ6ICIgKyBhcmdzWzBdOwogICAgICAgICAgICBjb25zb2xlLmVycm9yLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgIH0KICAgIH07Cn0KCi8vIExpbmtpbmcgY29uc29sZS5kaXIgYW5kIGNvbnNvbGUuZGlyeG1sIHRvIHRoZSBjb25zb2xlLmxvZyBtZXRob2QgaWYKLy8gbWlzc2luZy4gSG9wZWZ1bGx5IHRoZSBicm93c2VyIGFscmVhZHkgbG9ncyBvYmplY3RzIGFuZCBET00gbm9kZXMgYXMgYQovLyB0cmVlLgppZiAoIWNvbnNvbGVbImRpciJdKSBjb25zb2xlWyJkaXIiXSA9IGNvbnNvbGUubG9nOwppZiAoIWNvbnNvbGVbImRpcnhtbCJdKSBjb25zb2xlWyJkaXJ4bWwiXSA9IGNvbnNvbGUubG9nOwoKLy8gTGlua2luZyBjb25zb2xlLmV4Y2VwdGlvbiB0byBjb25zb2xlLmVycm9yLiBUaGlzIGlzIG5vdCB0aGUgc2FtZSBidXQKLy8gYXQgbGVhc3Qgc29tZSBlcnJvciBtZXNzYWdlIGlzIGRpc3BsYXllZC4KaWYgKCFjb25zb2xlWyJleGNlcHRpb24iXSkgY29uc29sZVsiZXhjZXB0aW9uIl0gPSBjb25zb2xlLmVycm9yOwoKLy8gSW1wbGVtZW50IGNvbnNvbGUudGltZSBhbmQgY29uc29sZS50aW1lRW5kIGlmIG9uZSBvZiB0aGVtIGlzIG1pc3NpbmcKaWYgKCFjb25zb2xlWyJ0aW1lIl0gfHwgIWNvbnNvbGVbInRpbWVFbmQiXSkKewogICAgdmFyIHRpbWVycyA9IHt9OwogICAgY29uc29sZVsidGltZSJdID0gZnVuY3Rpb24oaWQpCiAgICB7CiAgICAgICAgdGltZXJzW2lkXSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgfTsKICAgIGNvbnNvbGVbInRpbWVFbmQiXSA9IGZ1bmN0aW9uKGlkKQogICAgewogICAgICAgIHZhciBzdGFydCA9IHRpbWVyc1tpZF07CiAgICAgICAgaWYgKHN0YXJ0KQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS5sb2coaWQgKyAiOiAiICsgKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gc3RhcnQpICsgIm1zIik7CiAgICAgICAgICAgIGRlbGV0ZSB0aW1lcnNbaWRdOwogICAgICAgIH0KICAgIH07Cn0KCi8vIEltcGxlbWVudCBjb25zb2xlLnRhYmxlIGlmIG1pc3NpbmcKaWYgKCFjb25zb2xlWyJ0YWJsZSJdKQp7CiAgICBjb25zb2xlWyJ0YWJsZSJdID0gZnVuY3Rpb24oZGF0YSwgY29sdW1ucykKICAgIHsKICAgICAgICB2YXIgaSwgaU1heCwgcm93LCBqLCBqTWF4LCBrOwogICAgICAgIAogICAgICAgIC8vIERvIG5vdGhpbmcgaWYgZGF0YSBoYXMgd3JvbmcgdHlwZSBvciBubyBkYXRhIHdhcyBzcGVjaWZpZWQKICAgICAgICBpZiAoIWRhdGEgfHwgIShkYXRhIGluc3RhbmNlb2YgQXJyYXkpIHx8ICFkYXRhLmxlbmd0aCkgcmV0dXJuOwogICAgICAgIAogICAgICAgIC8vIEF1dG8tY2FsY3VsYXRlIGNvbHVtbnMgYXJyYXkgaWYgbm90IHNldAogICAgICAgIGlmICghY29sdW1ucyB8fCAhKGNvbHVtbnMgaW5zdGFuY2VvZiBBcnJheSkpCiAgICAgICAgewogICAgICAgICAgICBjb2x1bW5zID0gW107CiAgICAgICAgICAgIGZvciAoayBpbiBkYXRhWzBdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWRhdGFbMF0uaGFzT3duUHJvcGVydHkoaykpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29sdW1ucy5wdXNoKGspOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZvciAoaSA9IDAsIGlNYXggPSBkYXRhLmxlbmd0aDsgaSA8IGlNYXg7IGkgKz0gMSkKICAgICAgICB7CiAgICAgICAgICAgIHJvdyA9IFtdOwogICAgICAgICAgICBmb3IgKGogPSAwLCBqTWF4ID0gY29sdW1ucy5sZW5ndGg7IGogPCBqTWF4OyBqICs9IDEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJvdy5wdXNoKGRhdGFbaV1bY29sdW1uc1tqXV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBGdW5jdGlvbi5hcHBseS5jYWxsKGNvbnNvbGUubG9nLCBjb25zb2xlLCByb3cpOwogICAgICAgIH0KICAgIH07Cn0KCi8vIER1bW15IGltcGxlbWVudGF0aW9ucyBvZiBvdGhlciBjb25zb2xlIGZlYXR1cmVzIHRvIHByZXZlbnQgZXJyb3IgbWVzc2FnZXMKLy8gaW4gYnJvd3NlcnMgbm90IHN1cHBvcnRpbmcgaXQuCmlmICghY29uc29sZVsiY2xlYXIiXSkgY29uc29sZVsiY2xlYXIiXSA9IGZ1bmN0aW9uKCkge307CmlmICghY29uc29sZVsidHJhY2UiXSkgY29uc29sZVsidHJhY2UiXSA9IGZ1bmN0aW9uKCkge307CmlmICghY29uc29sZVsiZ3JvdXAiXSkgY29uc29sZVsiZ3JvdXAiXSA9IGZ1bmN0aW9uKCkge307CmlmICghY29uc29sZVsiZ3JvdXBDb2xsYXBzZWQiXSkgY29uc29sZVsiZ3JvdXBDb2xsYXBzZWQiXSA9IGZ1bmN0aW9uKCkge307CmlmICghY29uc29sZVsiZ3JvdXBFbmQiXSkgY29uc29sZVsiZ3JvdXBFbmQiXSA9IGZ1bmN0aW9uKCkge307CmlmICghY29uc29sZVsidGltZVN0YW1wIl0pIGNvbnNvbGVbInRpbWVTdGFtcCJdID0gZnVuY3Rpb24oKSB7fTsKaWYgKCFjb25zb2xlWyJwcm9maWxlIl0pIGNvbnNvbGVbInByb2ZpbGUiXSA9IGZ1bmN0aW9uKCkge307CmlmICghY29uc29sZVsicHJvZmlsZUVuZCJdKSBjb25zb2xlWyJwcm9maWxlRW5kIl0gPSBmdW5jdGlvbigpIHt9OwppZiAoIWNvbnNvbGVbImNvdW50Il0pIGNvbnNvbGVbImNvdW50Il0gPSBmdW5jdGlvbigpIHt9OwoKfSkoKTsKCmRlZmluZSgiY29uc29sZS1zaGltIiwgKGZ1bmN0aW9uIChnbG9iYWwpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJldCwgZm47CiAgICAgICAgcmV0dXJuIHJldCB8fCBnbG9iYWwuY29uc29sZTsKICAgIH07Cn0odGhpcykpKTsKCi8qKgogKiBlYXN5WERNCiAqIGh0dHA6Ly9lYXN5eGRtLm5ldC8KICogQ29weXJpZ2h0KGMpIDIwMDktMjAxMSwgw5h5dmluZCBTZWFuIEtpbnNleSwgb3l2aW5kQGtpbnNleS5uby4KICoKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAqCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKgogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqLwpkZWZpbmUoJ2pxdWVyeS5jb3JzL2Vhc3l4ZG0vZWFzeXhkbScsWydyZXF1aXJlJywnanNvbjInXSxmdW5jdGlvbihyZXF1aXJlKSB7CiAgICAKICAgIHZhciBKU09OID0gcmVxdWlyZSgnanNvbjInKTsKICAgIHZhciBnbG9iYWwgPSB0aGlzOwogICAgdmFyIGNoYW5uZWxJZCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwMDAwKTsgLy8gcmFuZG9taXplIHRoZSBpbml0aWFsIGlkIGluIGNhc2Ugb2YgbXVsdGlwbGUgY2xvc3VyZXMgbG9hZGVkCiAgICB2YXIgZW1wdHlGbiA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKICAgIHZhciByZVVSSSA9IC9eKChodHRwLj86KVwvXC8oW146XC9cc10rKSg6XGQrKSopLzsgLy8gcmV0dXJucyBncm91cHMgZm9yIHByb3RvY29sICgyKSwgZG9tYWluICgzKSBhbmQgcG9ydCAoNCkKICAgIHZhciByZVBhcmVudCA9IC9bXC1cd10rXC9cLlwuXC8vOyAvLyBtYXRjaGVzIGEgZm9vLy4uLyBleHByZXNzaW9uCiAgICB2YXIgcmVEb3VibGVTbGFzaCA9IC8oW146XSlcL1wvL2c7IC8vIG1hdGNoZXMgLy8gYW55d2hlcmUgYnV0IGluIHRoZSBwcm90b2NvbAogICAgdmFyIG5hbWVzcGFjZSA9ICIiOyAvLyBzdG9yZXMgbmFtZXNwYWNlIHVuZGVyIHdoaWNoIGVhc3lYRE0gb2JqZWN0IGlzIHN0b3JlZCBvbiB0aGUgcGFnZSAoZW1wdHkgaWYgb2JqZWN0IGlzIGdsb2JhbCkKICAgIHZhciBlYXN5WERNID0ge307CiAgICB2YXIgX2Vhc3lYRE0gPSB3aW5kb3cuZWFzeVhETTsgLy8gbWFwIG92ZXIgZ2xvYmFsIGVhc3lYRE0gaW4gY2FzZSBvZiBvdmVyd3JpdGUKICAgIHZhciBJRlJBTUVfUFJFRklYID0gImVhc3lYRE1fIjsKICAgIHZhciBIQVNfTkFNRV9QUk9QRVJUWV9CVUc7CiAgICB2YXIgdXNlSGFzaCA9IGZhbHNlOyAvLyB3aGV0aGVyIHRvIHVzZSB0aGUgaGFzaCBvdmVyIHRoZSBxdWVyeQogICAgdmFyIGZsYXNoVmVyc2lvbjsgLy8gd2lsbCBiZSBzZXQgaWYgdXNpbmcgZmxhc2gKICAgIHZhciBIQVNfRkxBU0hfVEhST1RUTEVEX0JVRzsKCiAgICAvLyhmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCBsb2NhdGlvbiwgc2V0VGltZW91dCwgZGVjb2RlVVJJQ29tcG9uZW50LCBlbmNvZGVVUklDb21wb25lbnQpIHsKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIEpTT04sIFhNTEh0dHBSZXF1ZXN0LCB3aW5kb3csIGVzY2FwZSwgdW5lc2NhcGUsIEFjdGl2ZVhPYmplY3QgKi8KICAgICAgICAvLwogICAgICAgIC8vIGVhc3lYRE0KICAgICAgICAvLyBodHRwOi8vZWFzeXhkbS5uZXQvCiAgICAgICAgLy8gQ29weXJpZ2h0KGMpIDIwMDktMjAxMSwgw5h5dmluZCBTZWFuIEtpbnNleSwgb3l2aW5kQGtpbnNleS5uby4KICAgICAgICAvLwogICAgICAgIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICAgICAgICAvLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogICAgICAgIC8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICAgICAgICAvLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAgICAgICAgLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAgICAgICAgLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAgICAgICAvLwogICAgICAgIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAgICAgICAgLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgICAgICAgLy8KICAgICAgICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogICAgICAgIC8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogICAgICAgIC8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogICAgICAgIC8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICAgICAgICAvLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogICAgICAgIC8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICAgICAgICAvLyBUSEUgU09GVFdBUkUuCiAgICAgICAgLy8KCgoKCiAgICAgICAgLy8gaHR0cDovL3BldGVyLm1pY2hhdXguY2EvYXJ0aWNsZXMvZmVhdHVyZS1kZXRlY3Rpb24tc3RhdGUtb2YtdGhlLWFydC1icm93c2VyLXNjcmlwdGluZwogICAgICAgIGZ1bmN0aW9uIGlzSG9zdE1ldGhvZChvYmplY3QsIHByb3BlcnR5KSB7CiAgICAgICAgICAgIHZhciB0ID0gdHlwZW9mIG9iamVjdFtwcm9wZXJ0eV07CiAgICAgICAgICAgIHJldHVybiB0ID09ICdmdW5jdGlvbicgfHwKICAgICAgICAgICAgICAgICggISEgKHQgPT0gJ29iamVjdCcgJiYgb2JqZWN0W3Byb3BlcnR5XSkpIHx8CiAgICAgICAgICAgICAgICB0ID09ICd1bmtub3duJzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzSG9zdE9iamVjdChvYmplY3QsIHByb3BlcnR5KSB7CiAgICAgICAgICAgIHJldHVybiAhISh0eXBlb2Yob2JqZWN0W3Byb3BlcnR5XSkgPT0gJ29iamVjdCcgJiYgb2JqZWN0W3Byb3BlcnR5XSk7CiAgICAgICAgfQoKICAgICAgICAvLyBlbmQKCiAgICAgICAgLy8gaHR0cDovL3BlcmZlY3Rpb25raWxscy5jb20vaW5zdGFuY2VvZi1jb25zaWRlcmVkLWhhcm1mdWwtb3ItaG93LXRvLXdyaXRlLWEtcm9idXN0LWlzYXJyYXkvCiAgICAgICAgZnVuY3Rpb24gaXNBcnJheShvKSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobykgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgICAgICAgfQoKICAgICAgICAvLyBlbmQKICAgICAgICBmdW5jdGlvbiBoYXNGbGFzaCgpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSAiU2hvY2t3YXZlIEZsYXNoIiwKICAgICAgICAgICAgICAgIG1pbWVUeXBlID0gImFwcGxpY2F0aW9uL3gtc2hvY2t3YXZlLWZsYXNoIjsKCiAgICAgICAgICAgIGlmICghdW5kZWYobmF2aWdhdG9yLnBsdWdpbnMpICYmIHR5cGVvZiBuYXZpZ2F0b3IucGx1Z2luc1tuYW1lXSA9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgLy8gYWRhcHRlZCBmcm9tIHRoZSBzd2ZvYmplY3QgY29kZQogICAgICAgICAgICAgICAgdmFyIGRlc2NyaXB0aW9uID0gbmF2aWdhdG9yLnBsdWdpbnNbbmFtZV0uZGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICBpZiAoZGVzY3JpcHRpb24gJiYgIXVuZGVmKG5hdmlnYXRvci5taW1lVHlwZXMpICYmIG5hdmlnYXRvci5taW1lVHlwZXNbbWltZVR5cGVdICYmIG5hdmlnYXRvci5taW1lVHlwZXNbbWltZVR5cGVdLmVuYWJsZWRQbHVnaW4pIHsKICAgICAgICAgICAgICAgICAgICBmbGFzaFZlcnNpb24gPSBkZXNjcmlwdGlvbi5tYXRjaCgvXGQrL2cpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghZmxhc2hWZXJzaW9uKSB7CiAgICAgICAgICAgICAgICB2YXIgZmxhc2g7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGZsYXNoID0gbmV3IEFjdGl2ZVhPYmplY3QoIlNob2Nrd2F2ZUZsYXNoLlNob2Nrd2F2ZUZsYXNoIik7CiAgICAgICAgICAgICAgICAgICAgZmxhc2hWZXJzaW9uID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZmxhc2guR2V0VmFyaWFibGUoIiR2ZXJzaW9uIikubWF0Y2goLyhcZCspLChcZCspLChcZCspLChcZCspLyksIDEpOwogICAgICAgICAgICAgICAgICAgIGZsYXNoID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKG5vdFN1cHBvcnRlZEV4Y2VwdGlvbikge30KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWZsYXNoVmVyc2lvbikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtYWpvciA9IHBhcnNlSW50KGZsYXNoVmVyc2lvblswXSwgMTApLAogICAgICAgICAgICAgICAgbWlub3IgPSBwYXJzZUludChmbGFzaFZlcnNpb25bMV0sIDEwKTsKICAgICAgICAgICAgSEFTX0ZMQVNIX1RIUk9UVExFRF9CVUcgPSBtYWpvciA+IDkgJiYgbWlub3IgPiAwOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICogQ3Jvc3MgQnJvd3NlciBpbXBsZW1lbnRhdGlvbiBmb3IgYWRkaW5nIGFuZCByZW1vdmluZyBldmVudCBsaXN0ZW5lcnMuCiAgICAgICAgICovCiAgICAgICAgdmFyIG9uLCB1bjsKICAgICAgICBpZiAoaXNIb3N0TWV0aG9kKHdpbmRvdywgImFkZEV2ZW50TGlzdGVuZXIiKSkgewogICAgICAgICAgICBvbiA9IGZ1bmN0aW9uKHRhcmdldCwgdHlwZSwgbGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyLCBmYWxzZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVuID0gZnVuY3Rpb24odGFyZ2V0LCB0eXBlLCBsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIsIGZhbHNlKTsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKGlzSG9zdE1ldGhvZCh3aW5kb3csICJhdHRhY2hFdmVudCIpKSB7CiAgICAgICAgICAgIG9uID0gZnVuY3Rpb24ob2JqZWN0LCBzRXZlbnQsIGZwTm90aWZ5KSB7CiAgICAgICAgICAgICAgICBvYmplY3QuYXR0YWNoRXZlbnQoIm9uIiArIHNFdmVudCwgZnBOb3RpZnkpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB1biA9IGZ1bmN0aW9uKG9iamVjdCwgc0V2ZW50LCBmcE5vdGlmeSkgewogICAgICAgICAgICAgICAgb2JqZWN0LmRldGFjaEV2ZW50KCJvbiIgKyBzRXZlbnQsIGZwTm90aWZ5KTsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJyb3dzZXIgbm90IHN1cHBvcnRlZCIpOwogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiBDcm9zcyBCcm93c2VyIGltcGxlbWVudGF0aW9uIG9mIERPTUNvbnRlbnRMb2FkZWQuCiAgICAgICAgICovCiAgICAgICAgdmFyIGRvbUlzUmVhZHkgPSBmYWxzZSwKICAgICAgICAgICAgZG9tUmVhZHlRdWV1ZSA9IFtdLAogICAgICAgICAgICByZWFkeVN0YXRlOwogICAgICAgIGlmICgicmVhZHlTdGF0ZSIgaW4gZG9jdW1lbnQpIHsKICAgICAgICAgICAgLy8gSWYgYnJvd3NlciBpcyBXZWJLaXQtcG93ZXJlZCwgY2hlY2sgZm9yIGJvdGggJ2xvYWRlZCcgKGxlZ2FjeSBicm93c2VycykgYW5kCiAgICAgICAgICAgIC8vICdpbnRlcmFjdGl2ZScgKEhUTUw1IHNwZWNzLCByZWNlbnQgV2ViS2l0IGJ1aWxkcykgc3RhdGVzLgogICAgICAgICAgICAvLyBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NDUxMTkKICAgICAgICAgICAgcmVhZHlTdGF0ZSA9IGRvY3VtZW50LnJlYWR5U3RhdGU7CiAgICAgICAgICAgIGRvbUlzUmVhZHkgPSByZWFkeVN0YXRlID09ICJjb21wbGV0ZSIgfHwgKH5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoJ0FwcGxlV2ViS2l0LycpICYmIChyZWFkeVN0YXRlID09ICJsb2FkZWQiIHx8IHJlYWR5U3RhdGUgPT0gImludGVyYWN0aXZlIikpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIElmIHJlYWR5U3RhdGUgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgYnJvd3NlciwgdGhlbiBpbiBvcmRlciB0byBiZSBhYmxlIHRvIGZpcmUgd2hlblJlYWR5IGZ1bmN0aW9ucyBhcHJvcHJpYXRlbHkKICAgICAgICAgICAgLy8gd2hlbiBhZGRlZCBkeW5hbWljYWxseSBfYWZ0ZXJfIERPTSBsb2FkLCB3ZSBoYXZlIHRvIGRlZHVjZSB3ZXRoZXIgdGhlIERPTSBpcyByZWFkeSBvciBub3QuCiAgICAgICAgICAgIC8vIFdlIG9ubHkgbmVlZCBhIGJvZHkgdG8gYWRkIGVsZW1lbnRzIHRvLCBzbyB0aGUgZXhpc3RlbmNlIG9mIGRvY3VtZW50LmJvZHkgaXMgZW5vdWdoIGZvciB1cy4KICAgICAgICAgICAgZG9tSXNSZWFkeSA9ICEhIGRvY3VtZW50LmJvZHk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkb21fb25SZWFkeSgpIHsKICAgICAgICAgICAgaWYgKGRvbUlzUmVhZHkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkb21Jc1JlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkb21SZWFkeVF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBkb21SZWFkeVF1ZXVlW2ldKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9tUmVhZHlRdWV1ZS5sZW5ndGggPSAwOwogICAgICAgIH0KCgogICAgICAgIGlmICghZG9tSXNSZWFkeSkgewogICAgICAgICAgICBpZiAoaXNIb3N0TWV0aG9kKHdpbmRvdywgImFkZEV2ZW50TGlzdGVuZXIiKSkgewogICAgICAgICAgICAgICAgb24oZG9jdW1lbnQsICJET01Db250ZW50TG9hZGVkIiwgZG9tX29uUmVhZHkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgb24oZG9jdW1lbnQsICJyZWFkeXN0YXRlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT0gImNvbXBsZXRlIikgewogICAgICAgICAgICAgICAgICAgICAgICBkb21fb25SZWFkeSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCAmJiB3aW5kb3cgPT09IHRvcCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkb1Njcm9sbENoZWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb21Jc1JlYWR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCgibGVmdCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGRvU2Nyb2xsQ2hlY2ssIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRvbV9vblJlYWR5KCk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBkb1Njcm9sbENoZWNrKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCiAgICAgICAgICAgIG9uKHdpbmRvdywgImxvYWQiLCBkb21fb25SZWFkeSk7CiAgICAgICAgfQogICAgICAgIC8qKgogICAgICAgICAqIFRoaXMgd2lsbCBhZGQgYSBmdW5jdGlvbiB0byB0aGUgcXVldWUgb2YgZnVuY3Rpb25zIHRvIGJlIHJ1biBvbmNlIHRoZSBET00gcmVhY2hlcyBhIHJlYWR5IHN0YXRlLgogICAgICAgICAqIElmIGZ1bmN0aW9ucyBhcmUgYWRkZWQgYWZ0ZXIgdGhpcyBldmVudCB0aGVuIHRoZXkgd2lsbCBiZSBleGVjdXRlZCBpbW1lZGlhdGVseS4KICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gYWRkCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIEFuIG9wdGlvbmFsIHNjb3BlIGZvciB0aGUgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdpdGguCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gd2hlblJlYWR5KGZuLCBzY29wZSkgewogICAgICAgICAgICBpZiAoZG9tSXNSZWFkeSkgewogICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9tUmVhZHlRdWV1ZS5wdXNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBhbiBpbnN0YW5jZSBvZiBlYXN5WERNIGZyb20gdGhlIHBhcmVudCB3aW5kb3cgd2l0aAogICAgICAgICAqIHJlc3BlY3QgdG8gdGhlIG5hbWVzcGFjZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4gQW4gaW5zdGFuY2Ugb2YgZWFzeVhETSAoaW4gdGhlIHBhcmVudCB3aW5kb3cpCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50T2JqZWN0KCkgewogICAgICAgICAgICB2YXIgb2JqID0gcGFyZW50OwogICAgICAgICAgICBpZiAobmFtZXNwYWNlICE9PSAiIikgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gbmFtZXNwYWNlLnNwbGl0KCIuIik7IGkgPCBpaS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIG9iaiA9IG9ialtpaVtpXV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG9iai5lYXN5WERNOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogUmVtb3ZlcyBlYXN5WERNIHZhcmlhYmxlIGZyb20gdGhlIGdsb2JhbCBzY29wZS4gSXQgYWxzbyByZXR1cm5zIGNvbnRyb2wKICAgICAgICAgKiBvZiB0aGUgZWFzeVhETSB2YXJpYWJsZSB0byB3aGF0ZXZlciBjb2RlIHVzZWQgaXQgYmVmb3JlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG5zIEEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIGFuIG9iamVjdCB0aGF0IHdpbGwgaG9sZAogICAgICAgICAqICAgICAgICAgICAgICAgICAgICBhbiBpbnN0YW5jZSBvZiBlYXN5WERNLgogICAgICAgICAqIEByZXR1cm4gQW4gaW5zdGFuY2Ugb2YgZWFzeVhETQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIG5vQ29uZmxpY3QobnMpIHsKCiAgICAgICAgICAgIHdpbmRvdy5lYXN5WERNID0gX2Vhc3lYRE07CiAgICAgICAgICAgIG5hbWVzcGFjZSA9IG5zOwogICAgICAgICAgICBpZiAobmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICBJRlJBTUVfUFJFRklYID0gImVhc3lYRE1fIiArIG5hbWVzcGFjZS5yZXBsYWNlKCIuIiwgIl8iKSArICJfIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWFzeVhETTsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICogTWV0aG9kcyBmb3Igd29ya2luZyB3aXRoIFVSTHMKICAgICAgICAgKi8KICAgICAgICAvKioKICAgICAgICAgKiBHZXQgdGhlIGRvbWFpbiBuYW1lIGZyb20gYSB1cmwuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGV4dHJhY3QgdGhlIGRvbWFpbiBmcm9tLgogICAgICAgICAqIEByZXR1cm4gVGhlIGRvbWFpbiBwYXJ0IG9mIHRoZSB1cmwuCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBnZXREb21haW5OYW1lKHVybCkgewogICAgICAgICAgICByZXR1cm4gdXJsLm1hdGNoKHJlVVJJKVszXTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEdldCB0aGUgcG9ydCBmb3IgYSBnaXZlbiBVUkwsIG9yICIiIGlmIG5vbmUKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZXh0cmFjdCB0aGUgcG9ydCBmcm9tLgogICAgICAgICAqIEByZXR1cm4gVGhlIHBvcnQgcGFydCBvZiB0aGUgdXJsLgogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZ2V0UG9ydCh1cmwpIHsKICAgICAgICAgICAgcmV0dXJuIHVybC5tYXRjaChyZVVSSSlbNF0gfHwgIiI7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zICBhIHN0cmluZyBjb250YWluaW5nIHRoZSBzY2hlbWEsIGRvbWFpbiBhbmQgaWYgcHJlc2VudCB0aGUgcG9ydAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBleHRyYWN0IHRoZSBsb2NhdGlvbiBmcm9tCiAgICAgICAgICogQHJldHVybiB7U3RyaW5nfSBUaGUgbG9jYXRpb24gcGFydCBvZiB0aGUgdXJsCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZ2V0TG9jYXRpb24odXJsKSB7CiAgICAgICAgICAgIHZhciBtID0gdXJsLnRvTG93ZXJDYXNlKCkubWF0Y2gocmVVUkkpOwogICAgICAgICAgICB2YXIgcHJvdG8gPSBtWzJdLAogICAgICAgICAgICAgICAgZG9tYWluID0gbVszXSwKICAgICAgICAgICAgICAgIHBvcnQgPSBtWzRdIHx8ICIiOwogICAgICAgICAgICBpZiAoKHByb3RvID09ICJodHRwOiIgJiYgcG9ydCA9PSAiOjgwIikgfHwgKHByb3RvID09ICJodHRwczoiICYmIHBvcnQgPT0gIjo0NDMiKSkgewogICAgICAgICAgICAgICAgcG9ydCA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcm90byArICIvLyIgKyBkb21haW4gKyBwb3J0OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogUmVzb2x2ZXMgYSByZWxhdGl2ZSB1cmwgaW50byBhbiBhYnNvbHV0ZSBvbmUuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgcGF0aCB0byByZXNvbHZlLgogICAgICAgICAqIEByZXR1cm4ge1N0cmluZ30gVGhlIHJlc29sdmVkIHVybC4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiByZXNvbHZlVXJsKHVybCkgewoKICAgICAgICAgICAgLy8gcmVwbGFjZSBhbGwgLy8gZXhjZXB0IHRoZSBvbmUgaW4gcHJvdG8gd2l0aCAvCiAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKHJlRG91YmxlU2xhc2gsICIkMS8iKTsKCiAgICAgICAgICAgIC8vIElmIHRoZSB1cmwgaXMgYSB2YWxpZCB1cmwgd2UgZG8gbm90aGluZwogICAgICAgICAgICBpZiAoIXVybC5tYXRjaCgvXihodHRwfHxodHRwcyk6XC9cLy8pKSB7CiAgICAgICAgICAgICAgICAvLyBJZiB0aGlzIGlzIGEgcmVsYXRpdmUgcGF0aAogICAgICAgICAgICAgICAgdmFyIHBhdGggPSAodXJsLnN1YnN0cmluZygwLCAxKSA9PT0gIi8iKSA/ICIiIDogbG9jYXRpb24ucGF0aG5hbWU7CiAgICAgICAgICAgICAgICBpZiAocGF0aC5zdWJzdHJpbmcocGF0aC5sZW5ndGggLSAxKSAhPT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgcGF0aCA9IHBhdGguc3Vic3RyaW5nKDAsIHBhdGgubGFzdEluZGV4T2YoIi8iKSArIDEpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHVybCA9IGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArIGxvY2F0aW9uLmhvc3QgKyBwYXRoICsgdXJsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyByZWR1Y2UgYWxsICd4eXovLi4vJyB0byBqdXN0ICcnCiAgICAgICAgICAgIHdoaWxlIChyZVBhcmVudC50ZXN0KHVybCkpIHsKICAgICAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKHJlUGFyZW50LCAiIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBBcHBlbmRzIHRoZSBwYXJhbWV0ZXJzIHRvIHRoZSBnaXZlbiB1cmwuPGJyLz4KICAgICAgICAgKiBUaGUgYmFzZSB1cmwgY2FuIGNvbnRhaW4gZXhpc3RpbmcgcXVlcnkgcGFyYW1ldGVycy4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSBiYXNlIHVybC4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1ldGVycyBUaGUgcGFyYW1ldGVycyB0byBhZGQuCiAgICAgICAgICogQHJldHVybiB7U3RyaW5nfSBBIG5ldyB2YWxpZCB1cmwgd2l0aCB0aGUgcGFyYW1ldGVycyBhcHBlbmRlZC4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBhcHBlbmRRdWVyeVBhcmFtZXRlcnModXJsLCBwYXJhbWV0ZXJzKSB7CgogICAgICAgICAgICB2YXIgaGFzaCA9ICIiLAogICAgICAgICAgICAgICAgaW5kZXhPZiA9IHVybC5pbmRleE9mKCIjIik7CiAgICAgICAgICAgIGlmIChpbmRleE9mICE9PSAtMSkgewogICAgICAgICAgICAgICAgaGFzaCA9IHVybC5zdWJzdHJpbmcoaW5kZXhPZik7CiAgICAgICAgICAgICAgICB1cmwgPSB1cmwuc3Vic3RyaW5nKDAsIGluZGV4T2YpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBxID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwYXJhbWV0ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocGFyYW1ldGVycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgcS5wdXNoKGtleSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudChwYXJhbWV0ZXJzW2tleV0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdXJsICsgKHVzZUhhc2ggPyAiIyIgOiAodXJsLmluZGV4T2YoIj8iKSA9PSAtMSA/ICI/IiA6ICImIikpICsgcS5qb2luKCImIikgKyBoYXNoOwogICAgICAgIH0KCgogICAgICAgIC8vIGJ1aWxkIHRoZSBxdWVyeSBvYmplY3QgZWl0aGVyIGZyb20gbG9jYXRpb24ucXVlcnksIGlmIGl0IGNvbnRhaW5zIHRoZSB4ZG1fZSBhcmd1bWVudCwgb3IgZnJvbSBsb2NhdGlvbi5oYXNoCiAgICAgICAgdmFyIHF1ZXJ5ID0gKGZ1bmN0aW9uKGlucHV0KSB7CiAgICAgICAgICAgIGlucHV0ID0gaW5wdXQuc3Vic3RyaW5nKDEpLnNwbGl0KCImIik7CiAgICAgICAgICAgIHZhciBkYXRhID0ge30sIHBhaXIsIGkgPSBpbnB1dC5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIHBhaXIgPSBpbnB1dFtpXS5zcGxpdCgiPSIpOwogICAgICAgICAgICAgICAgZGF0YVtwYWlyWzBdXSA9IGRlY29kZVVSSUNvbXBvbmVudChwYWlyWzFdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICB9KC94ZG1fZT0vLnRlc3QobG9jYXRpb24uc2VhcmNoKSA/IGxvY2F0aW9uLnNlYXJjaCA6IGxvY2F0aW9uLmhhc2gpKTsKCiAgICAgICAgLyoKICAgICAgICAgKiBIZWxwZXIgbWV0aG9kcwogICAgICAgICAqLwogICAgICAgIC8qKgogICAgICAgICAqIEhlbHBlciBmb3IgY2hlY2tpbmcgaWYgYSB2YXJpYWJsZS9wcm9wZXJ0eSBpcyB1bmRlZmluZWQKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdiBUaGUgdmFyaWFibGUgdG8gdGVzdAogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IFRydWUgaWYgdGhlIHBhc3NlZCB2YXJpYWJsZSBpcyB1bmRlZmluZWQKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiB1bmRlZih2KSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdiA9PT0gInVuZGVmaW5lZCI7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBBIHNhZmUgaW1wbGVtZW50YXRpb24gb2YgSFRNTDUgSlNPTi4gRmVhdHVyZSB0ZXN0aW5nIGlzIHVzZWQgdG8gbWFrZSBzdXJlIHRoZSBpbXBsZW1lbnRhdGlvbiB3b3Jrcy4KICAgICAgICAgKiBAcmV0dXJuIHtKU09OfSBBIHZhbGlkIEpTT04gY29uZm9ybWluZyBvYmplY3QsIG9yIG51bGwgaWYgbm90IGZvdW5kLgogICAgICAgICAqLwogICAgICAgIHZhciBnZXRKU09OID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjYWNoZWQgPSB7fTsKICAgICAgICAgICAgdmFyIG9iaiA9IHsKICAgICAgICAgICAgICAgIGE6IFsxLCAyLCAzXQogICAgICAgICAgICB9LCBqc29uID0gIntcImFcIjpbMSwyLDNdfSI7CgogICAgICAgICAgICBpZiAodHlwZW9mIEpTT04gIT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIEpTT04uc3RyaW5naWZ5ID09PSAiZnVuY3Rpb24iICYmIEpTT04uc3RyaW5naWZ5KG9iaikucmVwbGFjZSgoL1xzL2cpLCAiIikgPT09IGpzb24pIHsKICAgICAgICAgICAgICAgIC8vIHRoaXMgaXMgYSB3b3JraW5nIEpTT04gaW5zdGFuY2UKICAgICAgICAgICAgICAgIHJldHVybiBKU09OOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChPYmplY3QudG9KU09OKSB7CiAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LnRvSlNPTihvYmopLnJlcGxhY2UoKC9ccy9nKSwgIiIpID09PSBqc29uKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBhIHdvcmtpbmcgc3RyaW5naWZ5IG1ldGhvZAogICAgICAgICAgICAgICAgICAgIGNhY2hlZC5zdHJpbmdpZnkgPSBPYmplY3QudG9KU09OOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mIFN0cmluZy5wcm90b3R5cGUuZXZhbEpTT04gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIG9iaiA9IGpzb24uZXZhbEpTT04oKTsKICAgICAgICAgICAgICAgIGlmIChvYmouYSAmJiBvYmouYS5sZW5ndGggPT09IDMgJiYgb2JqLmFbMl0gPT09IDMpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIGEgd29ya2luZyBwYXJzZSBtZXRob2QKICAgICAgICAgICAgICAgICAgICBjYWNoZWQucGFyc2UgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0ci5ldmFsSlNPTigpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjYWNoZWQuc3RyaW5naWZ5ICYmIGNhY2hlZC5wYXJzZSkgewogICAgICAgICAgICAgICAgLy8gT25seSBtZW1vaXplIHRoZSByZXN1bHQgaWYgd2UgaGF2ZSB2YWxpZCBpbnN0YW5jZQogICAgICAgICAgICAgICAgZ2V0SlNPTiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWQ7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBBcHBsaWVzIHByb3BlcnRpZXMgZnJvbSB0aGUgc291cmNlIG9iamVjdCB0byB0aGUgdGFyZ2V0IG9iamVjdC48YnIvPgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQgVGhlIHRhcmdldCBvZiB0aGUgcHJvcGVydGllcy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc291cmNlIFRoZSBzb3VyY2Ugb2YgdGhlIHByb3BlcnRpZXMuCiAgICAgICAgICogQHBhcmFtIHtCb29sZWFufSBub092ZXJ3cml0ZSBTZXQgdG8gVHJ1ZSB0byBvbmx5IHNldCBub24tZXhpc3RpbmcgcHJvcGVydGllcy4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBhcHBseShkZXN0aW5hdGlvbiwgc291cmNlLCBub092ZXJ3cml0ZSkgewogICAgICAgICAgICB2YXIgbWVtYmVyOwogICAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgaWYgKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChwcm9wIGluIGRlc3RpbmF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lbWJlciA9IHNvdXJjZVtwcm9wXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtZW1iZXIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBseShkZXN0aW5hdGlvbltwcm9wXSwgbWVtYmVyLCBub092ZXJ3cml0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIW5vT3ZlcndyaXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbltwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGVzdGluYXRpb247CiAgICAgICAgfQoKICAgICAgICAvLyBUaGlzIHRlc3RzIGZvciB0aGUgYnVnIGluIElFIHdoZXJlIHNldHRpbmcgdGhlIFtuYW1lXSBwcm9wZXJ0eSB1c2luZyBqYXZhc2NyaXB0IGNhdXNlcyB0aGUgdmFsdWUgdG8gYmUgcmVkaXJlY3RlZCBpbnRvIFtzdWJtaXROYW1lXS4KICAgICAgICBmdW5jdGlvbiB0ZXN0Rm9yTmFtZVByb3BlcnR5QnVnKCkgewogICAgICAgICAgICB2YXIgZm9ybSA9IGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZm9ybSIpKSwKICAgICAgICAgICAgICAgIGlucHV0ID0gZm9ybS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpKTsKICAgICAgICAgICAgaW5wdXQubmFtZSA9IElGUkFNRV9QUkVGSVggKyAiVEVTVCIgKyBjaGFubmVsSWQ7IC8vIGFwcGVuZCBjaGFubmVsSWQgaW4gb3JkZXIgdG8gYXZvaWQgY2FjaGluZyBpc3N1ZXMKICAgICAgICAgICAgSEFTX05BTUVfUFJPUEVSVFlfQlVHID0gaW5wdXQgIT09IGZvcm0uZWxlbWVudHNbaW5wdXQubmFtZV07CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZm9ybSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBDcmVhdGVzIGEgZnJhbWUgYW5kIGFwcGVuZHMgaXQgdG8gdGhlIERPTS4KICAgICAgICAgKiBAcGFyYW0gY29uZmlnIHtvYmplY3R9IFRoaXMgb2JqZWN0IGNhbiBoYXZlIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllcwogICAgICAgICAqIDx1bD4KICAgICAgICAgKiA8bGk+IHtvYmplY3R9IHByb3AgVGhlIHByb3BlcnRpZXMgdGhhdCBzaG91bGQgYmUgc2V0IG9uIHRoZSBmcmFtZS4gVGhpcyBzaG91bGQgaW5jbHVkZSB0aGUgJ3NyYycgcHJvcGVydHkuPC9saT4KICAgICAgICAgKiA8bGk+IHtvYmplY3R9IGF0dHIgVGhlIGF0dHJpYnV0ZXMgdGhhdCBzaG91bGQgYmUgc2V0IG9uIHRoZSBmcmFtZS48L2xpPgogICAgICAgICAqIDxsaT4ge0RPTUVsZW1lbnR9IGNvbnRhaW5lciBJdHMgcGFyZW50IGVsZW1lbnQgKE9wdGlvbmFsKS48L2xpPgogICAgICAgICAqIDxsaT4ge2Z1bmN0aW9ufSBvbkxvYWQgQSBtZXRob2QgdGhhdCBzaG91bGQgYmUgY2FsbGVkIHdpdGggdGhlIGZyYW1lcyBjb250ZW50V2luZG93IGFzIGFyZ3VtZW50IHdoZW4gdGhlIGZyYW1lIGlzIGZ1bGx5IGxvYWRlZC4gKE9wdGlvbmFsKTwvbGk+CiAgICAgICAgICogPC91bD4KICAgICAgICAgKiBAcmV0dXJuIFRoZSBmcmFtZXMgRE9NRWxlbWVudAogICAgICAgICAqIEB0eXBlIERPTUVsZW1lbnQKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGcmFtZShjb25maWcpIHsKICAgICAgICAgICAgaWYgKHVuZGVmKEhBU19OQU1FX1BST1BFUlRZX0JVRykpIHsKICAgICAgICAgICAgICAgIHRlc3RGb3JOYW1lUHJvcGVydHlCdWcoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZnJhbWU7CiAgICAgICAgICAgIC8vIFRoaXMgaXMgdG8gd29yayBhcm91bmQgdGhlIHByb2JsZW1zIGluIElFNi83IHdpdGggc2V0dGluZyB0aGUgbmFtZSBwcm9wZXJ0eS4KICAgICAgICAgICAgLy8gSW50ZXJuYWxseSB0aGlzIGlzIHNldCBhcyAnc3VibWl0TmFtZScgaW5zdGVhZCB3aGVuIHVzaW5nICdpZnJhbWUubmFtZSA9IC4uLicKICAgICAgICAgICAgLy8gVGhpcyBpcyBub3QgcmVxdWlyZWQgYnkgZWFzeVhETSBpdHNlbGYsIGJ1dCBpcyB0byBmYWNpbGl0YXRlIG90aGVyIHVzZSBjYXNlcwogICAgICAgICAgICBpZiAoSEFTX05BTUVfUFJPUEVSVFlfQlVHKSB7CiAgICAgICAgICAgICAgICBmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIjxpZnJhbWUgbmFtZT1cIiIgKyBjb25maWcucHJvcHMubmFtZSArICJcIi8+Iik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIklGUkFNRSIpOwogICAgICAgICAgICAgICAgZnJhbWUubmFtZSA9IGNvbmZpZy5wcm9wcy5uYW1lOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmcmFtZS5pZCA9IGZyYW1lLm5hbWUgPSBjb25maWcucHJvcHMubmFtZTsKICAgICAgICAgICAgZGVsZXRlIGNvbmZpZy5wcm9wcy5uYW1lOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBjb25maWcuY29udGFpbmVyID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBjb25maWcuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29uZmlnLmNvbnRhaW5lcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghY29uZmlnLmNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgLy8gVGhpcyBuZWVkcyB0byBiZSBoaWRkZW4gbGlrZSB0aGlzLCBzaW1wbHkgc2V0dGluZyBkaXNwbGF5Om5vbmUgYW5kIHRoZSBsaWtlIHdpbGwgY2F1c2UgZmFpbHVyZXMgaW4gc29tZSBicm93c2Vycy4KICAgICAgICAgICAgICAgIGFwcGx5KGZyYW1lLnN0eWxlLCB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgICAgICAgICAgICAgICAgdG9wOiAiLTIwMDBweCIsCiAgICAgICAgICAgICAgICAgICAgLy8gQXZvaWQgcG90ZW50aWFsIGhvcml6b250YWwgc2Nyb2xsYmFyCiAgICAgICAgICAgICAgICAgICAgbGVmdDogIjBweCIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgY29uZmlnLmNvbnRhaW5lciA9IGRvY3VtZW50LmJvZHk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhBQ0s6IElFIGNhbm5vdCBoYXZlIHRoZSBzcmMgYXR0cmlidXRlIHNldCB3aGVuIHRoZSBmcmFtZSBpcyBhcHBlbmRlZAogICAgICAgICAgICAvLyAgICAgICBpbnRvIHRoZSBjb250YWluZXIsIHNvIHdlIHNldCBpdCB0byAiamF2YXNjcmlwdDpmYWxzZSIgYXMgYQogICAgICAgICAgICAvLyAgICAgICBwbGFjZWhvbGRlciBmb3Igbm93LiAgSWYgd2UgbGVmdCB0aGUgc3JjIHVuZGVmaW5lZCwgaXQgd291bGQKICAgICAgICAgICAgLy8gICAgICAgaW5zdGVhZCBkZWZhdWx0IHRvICJhYm91dDpibGFuayIsIHdoaWNoIGNhdXNlcyBTU0wgbWl4ZWQtY29udGVudAogICAgICAgICAgICAvLyAgICAgICB3YXJuaW5ncyBpbiBJRTYgd2hlbiBvbiBhbiBTU0wgcGFyZW50IHBhZ2UuCiAgICAgICAgICAgIHZhciBzcmMgPSBjb25maWcucHJvcHMuc3JjOwogICAgICAgICAgICBjb25maWcucHJvcHMuc3JjID0gImphdmFzY3JpcHQ6ZmFsc2UiOwoKICAgICAgICAgICAgLy8gdHJhbnNmZXIgcHJvcGVydGllcyB0byB0aGUgZnJhbWUKICAgICAgICAgICAgYXBwbHkoZnJhbWUsIGNvbmZpZy5wcm9wcyk7CgogICAgICAgICAgICBmcmFtZS5ib3JkZXIgPSBmcmFtZS5mcmFtZUJvcmRlciA9IDA7CiAgICAgICAgICAgIGZyYW1lLmFsbG93VHJhbnNwYXJlbmN5ID0gdHJ1ZTsKICAgICAgICAgICAgY29uZmlnLmNvbnRhaW5lci5hcHBlbmRDaGlsZChmcmFtZSk7CgogICAgICAgICAgICBpZiAoY29uZmlnLm9uTG9hZCkgewogICAgICAgICAgICAgICAgb24oZnJhbWUsICJsb2FkIiwgY29uZmlnLm9uTG9hZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNldCB0aGUgZnJhbWUgVVJMIHRvIHRoZSBwcm9wZXIgdmFsdWUgKHdlIHByZXZpb3VzbHkgc2V0IGl0IHRvCiAgICAgICAgICAgIC8vICJqYXZhc2NyaXB0OmZhbHNlIiB0byB3b3JrIGFyb3VuZCB0aGUgSUUgaXNzdWUgbWVudGlvbmVkIGFib3ZlKQogICAgICAgICAgICBpZiAoY29uZmlnLnVzZVBvc3QpIHsKICAgICAgICAgICAgICAgIHZhciBmb3JtID0gY29uZmlnLmNvbnRhaW5lci5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdmb3JtJykpLAogICAgICAgICAgICAgICAgICAgIGlucHV0OwogICAgICAgICAgICAgICAgZm9ybS50YXJnZXQgPSBmcmFtZS5uYW1lOwogICAgICAgICAgICAgICAgZm9ybS5hY3Rpb24gPSBzcmM7CiAgICAgICAgICAgICAgICBmb3JtLm1ldGhvZCA9ICdQT1NUJzsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YoY29uZmlnLnVzZVBvc3QpID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gY29uZmlnLnVzZVBvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy51c2VQb3N0Lmhhc093blByb3BlcnR5KGkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoSEFTX05BTUVfUFJPUEVSVFlfQlVHKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCc8aW5wdXQgbmFtZT0iJyArIGkgKyAnIi8+Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiSU5QVVQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5uYW1lID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gY29uZmlnLnVzZVBvc3RbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLmFwcGVuZENoaWxkKGlucHV0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcm0uc3VibWl0KCk7CiAgICAgICAgICAgICAgICBmb3JtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZm9ybSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmcmFtZS5zcmMgPSBzcmM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uZmlnLnByb3BzLnNyYyA9IHNyYzsKCiAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIENoZWNrIHdoZXRoZXIgYSBkb21haW4gaXMgYWxsb3dlZCB1c2luZyBhbiBBY2Nlc3MgQ29udHJvbCBMaXN0LgogICAgICAgICAqIFRoZSBBQ0wgY2FuIGNvbnRhaW4gKiBhbmQgPyBhcyB3aWxkY2FyZHMsIG9yIGNhbiBiZSByZWd1bGFyIGV4cHJlc3Npb25zLgogICAgICAgICAqIElmIHJlZ3VsYXIgZXhwcmVzc2lvbnMgdGhleSBuZWVkIHRvIGJlZ2luIHdpdGggXiBhbmQgZW5kIHdpdGggJC4KICAgICAgICAgKiBAcGFyYW0ge0FycmF5L1N0cmluZ30gYWNsIFRoZSBsaXN0IG9mIGFsbG93ZWQgZG9tYWlucwogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBkb21haW4gVGhlIGRvbWFpbiB0byB0ZXN0LgogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IFRydWUgaWYgdGhlIGRvbWFpbiBpcyBhbGxvd2VkLCBmYWxzZSBpZiBub3QuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY2hlY2tBY2woYWNsLCBkb21haW4pIHsKICAgICAgICAgICAgLy8gbm9ybWFsaXplIGludG8gYW4gYXJyYXkKICAgICAgICAgICAgaWYgKHR5cGVvZiBhY2wgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGFjbCA9IFthY2xdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZSwgaSA9IGFjbC5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIHJlID0gYWNsW2ldOwogICAgICAgICAgICAgICAgcmUgPSBuZXcgUmVnRXhwKHJlLnN1YnN0cigwLCAxKSA9PSAiXiIgPyByZSA6ICgiXiIgKyByZS5yZXBsYWNlKC8oXCopL2csICIuJDEiKS5yZXBsYWNlKC9cPy9nLCAiLiIpICsgIiQiKSk7CiAgICAgICAgICAgICAgICBpZiAocmUudGVzdChkb21haW4pKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiBGdW5jdGlvbnMgcmVsYXRlZCB0byBzdGFja3MKICAgICAgICAgKi8KICAgICAgICAvKioKICAgICAgICAgKiBQcmVwYXJlcyBhbiBhcnJheSBvZiBzdGFjay1lbGVtZW50cyBzdWl0YWJsZSBmb3IgdGhlIGN1cnJlbnQgY29uZmlndXJhdGlvbgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIFRyYW5zcG9ydHMgY29uZmlndXJhdGlvbi4gU2VlIGVhc3lYRE0uU29ja2V0IGZvciBtb3JlLgogICAgICAgICAqIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBvZiBzdGFjay1lbGVtZW50cyB3aXRoIHRoZSBUcmFuc3BvcnRFbGVtZW50IGF0IGluZGV4IDAuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRyYW5zcG9ydFN0YWNrKGNvbmZpZykgewogICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSBjb25maWcucHJvdG9jb2wsCiAgICAgICAgICAgICAgICBzdGFja0VsczsKICAgICAgICAgICAgY29uZmlnLmlzSG9zdCA9IGNvbmZpZy5pc0hvc3QgfHwgdW5kZWYocXVlcnkueGRtX3ApOwogICAgICAgICAgICB1c2VIYXNoID0gY29uZmlnLmhhc2ggfHwgZmFsc2U7CgogICAgICAgICAgICBpZiAoIWNvbmZpZy5wcm9wcykgewogICAgICAgICAgICAgICAgY29uZmlnLnByb3BzID0ge307CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFjb25maWcuaXNIb3N0KSB7CiAgICAgICAgICAgICAgICBjb25maWcuY2hhbm5lbCA9IHF1ZXJ5LnhkbV9jLnJlcGxhY2UoL1siJzw+XFxdL2csICIiKTsKICAgICAgICAgICAgICAgIGNvbmZpZy5zZWNyZXQgPSBxdWVyeS54ZG1fczsKICAgICAgICAgICAgICAgIGNvbmZpZy5yZW1vdGUgPSBxdWVyeS54ZG1fZS5yZXBsYWNlKC9bIic8PlxcXS9nLCAiIik7OwogICAgICAgICAgICAgICAgcHJvdG9jb2wgPSBxdWVyeS54ZG1fcDsKICAgICAgICAgICAgICAgIGlmIChjb25maWcuYWNsICYmICFjaGVja0FjbChjb25maWcuYWNsLCBjb25maWcucmVtb3RlKSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQWNjZXNzIGRlbmllZCBmb3IgIiArIGNvbmZpZy5yZW1vdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uZmlnLnJlbW90ZSA9IHJlc29sdmVVcmwoY29uZmlnLnJlbW90ZSk7CiAgICAgICAgICAgICAgICBjb25maWcuY2hhbm5lbCA9IGNvbmZpZy5jaGFubmVsIHx8ICJkZWZhdWx0IiArIGNoYW5uZWxJZCsrOwogICAgICAgICAgICAgICAgY29uZmlnLnNlY3JldCA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygyKTsKICAgICAgICAgICAgICAgIGlmICh1bmRlZihwcm90b2NvbCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZ2V0TG9jYXRpb24obG9jYXRpb24uaHJlZikgPT0gZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAgICAgICAgICogQm90aCBkb2N1bWVudHMgaGFzIHRoZSBzYW1lIG9yaWdpbiwgbGV0cyB1c2UgZGlyZWN0IGFjY2Vzcy4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvY29sID0gIjQiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNIb3N0TWV0aG9kKHdpbmRvdywgInBvc3RNZXNzYWdlIikgfHwgaXNIb3N0TWV0aG9kKGRvY3VtZW50LCAicG9zdE1lc3NhZ2UiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBUaGlzIGlzIHN1cHBvcnRlZCBpbiBJRTgrLCBGaXJlZm94IDMrLCBPcGVyYSA5KywgQ2hyb21lIDIrIGFuZCBTYWZhcmkgNCsKICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvY29sID0gIjEiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29uZmlnLnN3ZiAmJiBpc0hvc3RNZXRob2Qod2luZG93LCAiQWN0aXZlWE9iamVjdCIpICYmIGhhc0ZsYXNoKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAgICAgICAgICogVGhlIEZsYXNoIHRyYW5zcG9ydCBzdXBlcnNlZWRlcyB0aGUgTml4VHJhbnNwb3J0IGFzIHRoZSBOaXhUcmFuc3BvcnQgaGFzIGJlZW4gYmxvY2tlZCBieSBNUwogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcHJvdG9jb2wgPSAiNiI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuYXZpZ2F0b3IucHJvZHVjdCA9PT0gIkdlY2tvIiAmJiAiZnJhbWVFbGVtZW50IiBpbiB3aW5kb3cgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdXZWJLaXQnKSA9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBUaGlzIGlzIHN1cHBvcnRlZCBpbiBHZWNrbyAoRmlyZWZveCAxKykKICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvY29sID0gIjUiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29uZmlnLnJlbW90ZUhlbHBlcikgewogICAgICAgICAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBUaGlzIGlzIHN1cHBvcnRlZCBpbiBhbGwgYnJvd3NlcnMgdGhhdCByZXRhaW5zIHRoZSB2YWx1ZSBvZiB3aW5kb3cubmFtZSB3aGVuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIG5hdmlnYXRpbmcgZnJvbSBvbmUgZG9tYWluIHRvIGFub3RoZXIsIGFuZCB3aGVyZSBwYXJlbnQuZnJhbWVzW2Zvb10gY2FuIGJlIHVzZWQKICAgICAgICAgICAgICAgICAgICAgICAgICogdG8gZ2V0IGFjY2VzcyB0byBhIGZyYW1lIGZyb20gdGhlIHNhbWUgZG9tYWluCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBwcm90b2NvbCA9ICIyIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBUaGlzIGlzIHN1cHBvcnRlZCBpbiBhbGwgYnJvd3NlcnMgd2hlcmUgW3dpbmRvd10ubG9jYXRpb24gaXMgd3JpdGFibGUgZm9yIGFsbAogICAgICAgICAgICAgICAgICAgICAgICAgKiBUaGUgcmVzaXplIGV2ZW50IHdpbGwgYmUgdXNlZCBpZiByZXNpemUgaXMgc3VwcG9ydGVkIGFuZCB0aGUgaWZyYW1lIGlzIG5vdCBwdXQKICAgICAgICAgICAgICAgICAgICAgICAgICogaW50byBhIGNvbnRhaW5lciwgZWxzZSBwb2xsaW5nIHdpbGwgYmUgdXNlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvY29sID0gIjAiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25maWcucHJvdG9jb2wgPSBwcm90b2NvbDsgLy8gZm9yIGNvbmRpdGlvbmFsIGJyYW5jaGluZwogICAgICAgICAgICBzd2l0Y2ggKHByb3RvY29sKSB7CiAgICAgICAgICAgICAgICBjYXNlICIwIjogLy8gMCA9IEhhc2hUcmFuc3BvcnQKICAgICAgICAgICAgICAgICAgICBhcHBseShjb25maWcsIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWw6IDEwMCwKICAgICAgICAgICAgICAgICAgICAgICAgZGVsYXk6IDIwMDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHVzZVJlc2l6ZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdXNlUGFyZW50OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgdXNlUG9sbGluZzogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLmlzSG9zdCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5sb2NhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgbm8gbG9jYWwgaXMgc2V0IHRoZW4gd2UgbmVlZCB0byBmaW5kIGFuIGltYWdlIGhvc3RlZCBvbiB0aGUgY3VycmVudCBkb21haW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkb21haW4gPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlcyA9IGRvY3VtZW50LmJvZHkuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImltZyIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSBpbWFnZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlID0gaW1hZ2VzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbWFnZS5zcmMuc3Vic3RyaW5nKDAsIGRvbWFpbi5sZW5ndGgpID09PSBkb21haW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmxvY2FsID0gaW1hZ2Uuc3JjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5sb2NhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIG5vIGxvY2FsIHdhcyBzZXQsIGFuZCB3ZSBhcmUgdW5hYmxlIHRvIGZpbmQgYSBzdWl0YWJsZSBmaWxlLCB0aGVuIHdlIHJlc29ydCB0byB1c2luZyB0aGUgY3VycmVudCB3aW5kb3cKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcubG9jYWwgPSB3aW5kb3c7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJhbWV0ZXJzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX2M6IGNvbmZpZy5jaGFubmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX3A6IDAKICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcubG9jYWwgPT09IHdpbmRvdykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgYXJlIHVzaW5nIHRoZSBjdXJyZW50IHdpbmRvdyB0byBsaXN0ZW4gdG8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy51c2VQb2xsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy51c2VQYXJlbnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmxvY2FsID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1ldGVycy54ZG1fZSA9IGNvbmZpZy5sb2NhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnMueGRtX3BhID0gMTsgLy8gdXNlIHBhcmVudAogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1ldGVycy54ZG1fZSA9IHJlc29sdmVVcmwoY29uZmlnLmxvY2FsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5jb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy51c2VSZXNpemUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnMueGRtX3BvID0gMTsgLy8gdXNlIHBvbGxpbmcKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjb25maWcucmVtb3RlID0gYXBwZW5kUXVlcnlQYXJhbWV0ZXJzKGNvbmZpZy5yZW1vdGUsIHBhcmFtZXRlcnMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5KGNvbmZpZywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbDogcXVlcnkueGRtX2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdGU6IHF1ZXJ5LnhkbV9lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlUGFyZW50OiAhdW5kZWYocXVlcnkueGRtX3BhKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZVBvbGxpbmc6ICF1bmRlZihxdWVyeS54ZG1fcG8pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlUmVzaXplOiBjb25maWcudXNlUGFyZW50ID8gZmFsc2UgOiBjb25maWcudXNlUmVzaXplCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdGFja0VscyA9IFtuZXcgZWFzeVhETS5zdGFjay5IYXNoVHJhbnNwb3J0KGNvbmZpZyksIG5ldyBlYXN5WERNLnN0YWNrLlJlbGlhYmxlQmVoYXZpb3Ioe30pLCBuZXcgZWFzeVhETS5zdGFjay5RdWV1ZUJlaGF2aW9yKHsKICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2RlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBtYXhMZW5ndGg6IDQwMDAgLSBjb25maWcucmVtb3RlLmxlbmd0aAogICAgICAgICAgICAgICAgICAgIH0pLCBuZXcgZWFzeVhETS5zdGFjay5WZXJpZnlCZWhhdmlvcih7CiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYXRlOiBjb25maWcuaXNIb3N0CiAgICAgICAgICAgICAgICAgICAgfSldOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiMSI6CiAgICAgICAgICAgICAgICAgICAgc3RhY2tFbHMgPSBbbmV3IGVhc3lYRE0uc3RhY2suUG9zdE1lc3NhZ2VUcmFuc3BvcnQoY29uZmlnKV07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICIyIjoKICAgICAgICAgICAgICAgICAgICBjb25maWcucmVtb3RlSGVscGVyID0gcmVzb2x2ZVVybChjb25maWcucmVtb3RlSGVscGVyKTsKICAgICAgICAgICAgICAgICAgICBzdGFja0VscyA9IFtuZXcgZWFzeVhETS5zdGFjay5OYW1lVHJhbnNwb3J0KGNvbmZpZyksIG5ldyBlYXN5WERNLnN0YWNrLlF1ZXVlQmVoYXZpb3IoKSwgbmV3IGVhc3lYRE0uc3RhY2suVmVyaWZ5QmVoYXZpb3IoewogICAgICAgICAgICAgICAgICAgICAgICBpbml0aWF0ZTogY29uZmlnLmlzSG9zdAogICAgICAgICAgICAgICAgICAgIH0pXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgIjMiOgogICAgICAgICAgICAgICAgICAgIHN0YWNrRWxzID0gW25ldyBlYXN5WERNLnN0YWNrLk5peFRyYW5zcG9ydChjb25maWcpXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgIjQiOgogICAgICAgICAgICAgICAgICAgIHN0YWNrRWxzID0gW25ldyBlYXN5WERNLnN0YWNrLlNhbWVPcmlnaW5UcmFuc3BvcnQoY29uZmlnKV07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICI1IjoKICAgICAgICAgICAgICAgICAgICBzdGFja0VscyA9IFtuZXcgZWFzeVhETS5zdGFjay5GcmFtZUVsZW1lbnRUcmFuc3BvcnQoY29uZmlnKV07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICI2IjoKICAgICAgICAgICAgICAgICAgICBpZiAoIWZsYXNoVmVyc2lvbikgewogICAgICAgICAgICAgICAgICAgICAgICBoYXNGbGFzaCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdGFja0VscyA9IFtuZXcgZWFzeVhETS5zdGFjay5GbGFzaFRyYW5zcG9ydChjb25maWcpXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB0aGlzIGJlaGF2aW9yIGlzIHJlc3BvbnNpYmxlIGZvciBidWZmZXJpbmcgb3V0Z29pbmcgbWVzc2FnZXMsIGFuZCBmb3IgcGVyZm9ybWluZyBsYXp5IGluaXRpYWxpemF0aW9uCiAgICAgICAgICAgIHN0YWNrRWxzLnB1c2gobmV3IGVhc3lYRE0uc3RhY2suUXVldWVCZWhhdmlvcih7CiAgICAgICAgICAgICAgICBsYXp5OiBjb25maWcubGF6eSwKICAgICAgICAgICAgICAgIHJlbW92ZTogdHJ1ZQogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIHJldHVybiBzdGFja0VsczsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIENoYWlucyBhbGwgdGhlIHNlcGFyYXRlIHN0YWNrIGVsZW1lbnRzIGludG8gYSBzaW5nbGUgdXNhYmxlIHN0YWNrLjxici8+CiAgICAgICAgICogSWYgYW4gZWxlbWVudCBpcyBtaXNzaW5nIGEgbmVjZXNzYXJ5IG1ldGhvZCB0aGVuIGl0IHdpbGwgaGF2ZSBhIHBhc3MtdGhyb3VnaCBtZXRob2QgYXBwbGllZC4KICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBzdGFja0VsZW1lbnRzIEFuIGFycmF5IG9mIHN0YWNrIGVsZW1lbnRzIHRvIGJlIGxpbmtlZC4KICAgICAgICAgKiBAcmV0dXJuIHtlYXN5WERNLnN0YWNrLlN0YWNrRWxlbWVudH0gVGhlIGxhc3QgZWxlbWVudCBpbiB0aGUgY2hhaW4uCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY2hhaW5TdGFjayhzdGFja0VsZW1lbnRzKSB7CiAgICAgICAgICAgIHZhciBzdGFja0VsLCBkZWZhdWx0cyA9IHsKICAgICAgICAgICAgICAgICAgICBpbmNvbWluZzogZnVuY3Rpb24obWVzc2FnZSwgb3JpZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXAuaW5jb21pbmcobWVzc2FnZSwgb3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIG91dGdvaW5nOiBmdW5jdGlvbihtZXNzYWdlLCByZWNpcGllbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3duLm91dGdvaW5nKG1lc3NhZ2UsIHJlY2lwaWVudCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24oc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwLmNhbGxiYWNrKHN1Y2Nlc3MpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZG93bi5pbml0KCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3duLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gc3RhY2tFbGVtZW50cy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgc3RhY2tFbCA9IHN0YWNrRWxlbWVudHNbaV07CiAgICAgICAgICAgICAgICBhcHBseShzdGFja0VsLCBkZWZhdWx0cywgdHJ1ZSk7CiAgICAgICAgICAgICAgICBpZiAoaSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIHN0YWNrRWwuZG93biA9IHN0YWNrRWxlbWVudHNbaSAtIDFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGkgIT09IGxlbiAtIDEpIHsKICAgICAgICAgICAgICAgICAgICBzdGFja0VsLnVwID0gc3RhY2tFbGVtZW50c1tpICsgMV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0YWNrRWw7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBUaGlzIHdpbGwgcmVtb3ZlIGEgc3RhY2tlbGVtZW50IGZyb20gaXRzIHN0YWNrIHdoaWxlIGxlYXZpbmcgdGhlIHN0YWNrIGZ1bmN0aW9uYWwuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGVsZW1lbnQgVGhlIGVsbWVudCB0byByZW1vdmUgZnJvbSB0aGUgc3RhY2suCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlRnJvbVN0YWNrKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudC51cC5kb3duID0gZWxlbWVudC5kb3duOwogICAgICAgICAgICBlbGVtZW50LmRvd24udXAgPSBlbGVtZW50LnVwOwogICAgICAgICAgICBlbGVtZW50LnVwID0gZWxlbWVudC5kb3duID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICogRXhwb3J0IHRoZSBtYWluIG9iamVjdCBhbmQgYW55IG90aGVyIG1ldGhvZHMgYXBwbGljYWJsZQogICAgICAgICAqLwogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNCiAgICAgICAgICogQSBqYXZhc2NyaXB0IGxpYnJhcnkgcHJvdmlkaW5nIGNyb3NzLWJyb3dzZXIsIGNyb3NzLWRvbWFpbiBtZXNzYWdpbmcvUlBDLgogICAgICAgICAqIEB2ZXJzaW9uIDIuNC4xNy4xCiAgICAgICAgICogQHNpbmdsZXRvbgogICAgICAgICAqLwogICAgICAgIGFwcGx5KGVhc3lYRE0sIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFRoZSB2ZXJzaW9uIG9mIHRoZSBsaWJyYXJ5CiAgICAgICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICAgICAqLwogICAgICAgICAgICB2ZXJzaW9uOiAiMi40LjE3LjEiLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogVGhpcyBpcyBhIG1hcCBjb250YWluaW5nIGFsbCB0aGUgcXVlcnkgcGFyYW1ldGVycyBwYXNzZWQgdG8gdGhlIGRvY3VtZW50LgogICAgICAgICAgICAgKiBBbGwgdGhlIHZhbHVlcyBoYXMgYmVlbiBkZWNvZGVkIHVzaW5nIGRlY29kZVVSSUNvbXBvbmVudC4KICAgICAgICAgICAgICogQHR5cGUge29iamVjdH0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHF1ZXJ5OiBxdWVyeSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBzdGFjazoge30sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBBcHBsaWVzIHByb3BlcnRpZXMgZnJvbSB0aGUgc291cmNlIG9iamVjdCB0byB0aGUgdGFyZ2V0IG9iamVjdC48YnIvPgogICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gdGFyZ2V0IFRoZSB0YXJnZXQgb2YgdGhlIHByb3BlcnRpZXMuCiAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzb3VyY2UgVGhlIHNvdXJjZSBvZiB0aGUgcHJvcGVydGllcy4KICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFufSBub092ZXJ3cml0ZSBTZXQgdG8gVHJ1ZSB0byBvbmx5IHNldCBub24tZXhpc3RpbmcgcHJvcGVydGllcy4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGFwcGx5OiBhcHBseSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBBIHNhZmUgaW1wbGVtZW50YXRpb24gb2YgSFRNTDUgSlNPTi4gRmVhdHVyZSB0ZXN0aW5nIGlzIHVzZWQgdG8gbWFrZSBzdXJlIHRoZSBpbXBsZW1lbnRhdGlvbiB3b3Jrcy4KICAgICAgICAgICAgICogQHJldHVybiB7SlNPTn0gQSB2YWxpZCBKU09OIGNvbmZvcm1pbmcgb2JqZWN0LCBvciBudWxsIGlmIG5vdCBmb3VuZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldEpTT05PYmplY3Q6IGdldEpTT04sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBUaGlzIHdpbGwgYWRkIGEgZnVuY3Rpb24gdG8gdGhlIHF1ZXVlIG9mIGZ1bmN0aW9ucyB0byBiZSBydW4gb25jZSB0aGUgRE9NIHJlYWNoZXMgYSByZWFkeSBzdGF0ZS4KICAgICAgICAgICAgICogSWYgZnVuY3Rpb25zIGFyZSBhZGRlZCBhZnRlciB0aGlzIGV2ZW50IHRoZW4gdGhleSB3aWxsIGJlIGV4ZWN1dGVkIGltbWVkaWF0ZWx5LgogICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gYWRkCiAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzY29wZSBBbiBvcHRpb25hbCBzY29wZSBmb3IgdGhlIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aXRoLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgd2hlblJlYWR5OiB3aGVuUmVhZHksCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBSZW1vdmVzIGVhc3lYRE0gdmFyaWFibGUgZnJvbSB0aGUgZ2xvYmFsIHNjb3BlLiBJdCBhbHNvIHJldHVybnMgY29udHJvbAogICAgICAgICAgICAgKiBvZiB0aGUgZWFzeVhETSB2YXJpYWJsZSB0byB3aGF0ZXZlciBjb2RlIHVzZWQgaXQgYmVmb3JlLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbnMgQSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgYW4gb2JqZWN0IHRoYXQgd2lsbCBob2xkCiAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICBhbiBpbnN0YW5jZSBvZiBlYXN5WERNLgogICAgICAgICAgICAgKiBAcmV0dXJuIEFuIGluc3RhbmNlIG9mIGVhc3lYRE0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIG5vQ29uZmxpY3Q6IG5vQ29uZmxpY3QKICAgICAgICB9KTsKCiAgICAgICAgLypqc2xpbnQgZXZpbDogdHJ1ZSwgYnJvd3NlcjogdHJ1ZSwgaW1tZWQ6IHRydWUsIHBhc3NmYWlsOiB0cnVlLCB1bmRlZjogdHJ1ZSwgbmV3Y2FwOiB0cnVlKi8KICAgICAgICAvKmdsb2JhbCBjb25zb2xlLCBfRmlyZWJ1Z0NvbW1hbmRMaW5lLCAgZWFzeVhETSwgd2luZG93LCBlc2NhcGUsIHVuZXNjYXBlLCBpc0hvc3RPYmplY3QsIHVuZGVmLCBfdHJhY2UsIGRvbUlzUmVhZHksIGVtcHR5Rm4sIG5hbWVzcGFjZSAqLwogICAgICAgIC8vCiAgICAgICAgLy8gZWFzeVhETQogICAgICAgIC8vIGh0dHA6Ly9lYXN5eGRtLm5ldC8KICAgICAgICAvLyBDb3B5cmlnaHQoYykgMjAwOS0yMDExLCDDmHl2aW5kIFNlYW4gS2luc2V5LCBveXZpbmRAa2luc2V5Lm5vLgogICAgICAgIC8vCiAgICAgICAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogICAgICAgIC8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAgICAgICAgLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogICAgICAgIC8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICAgICAgICAvLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICAgICAgICAvLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgogICAgICAgIC8vCiAgICAgICAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICAgICAgICAvLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAgICAgICAvLwogICAgICAgIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAgICAgICAgLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAgICAgICAgLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAgICAgICAgLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogICAgICAgIC8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAgICAgICAgLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogICAgICAgIC8vIFRIRSBTT0ZUV0FSRS4KICAgICAgICAvLwoKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIGVhc3lYRE0sIHdpbmRvdywgZXNjYXBlLCB1bmVzY2FwZSwgaXNIb3N0T2JqZWN0LCBpc0hvc3RNZXRob2QsIHVuLCBvbiwgY3JlYXRlRnJhbWUsIGRlYnVnICovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLkRvbUhlbHBlcgogICAgICAgICAqIENvbnRhaW5zIG1ldGhvZHMgZm9yIGRlYWxpbmcgd2l0aCB0aGUgRE9NCiAgICAgICAgICogQHNpbmdsZXRvbgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uRG9tSGVscGVyID0gewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUHJvdmlkZXMgYSBjb25zaXN0ZW50IGludGVyZmFjZSBmb3IgYWRkaW5nIGV2ZW50aGFuZGxlcnMKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUaGUgdGFyZ2V0IHRvIGFkZCB0aGUgZXZlbnQgdG8KICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIG5hbWUgb2YgdGhlIGV2ZW50CiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIFRoZSBsaXN0ZW5lcgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgb246IG9uLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUHJvdmlkZXMgYSBjb25zaXN0ZW50IGludGVyZmFjZSBmb3IgcmVtb3ZpbmcgZXZlbnRoYW5kbGVycwogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0IFRoZSB0YXJnZXQgdG8gcmVtb3ZlIHRoZSBldmVudCBmcm9tCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBuYW1lIG9mIHRoZSBldmVudAogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciBUaGUgbGlzdGVuZXIKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHVuOiB1biwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENoZWNrcyBmb3IgdGhlIHByZXNlbmNlIG9mIHRoZSBKU09OIG9iamVjdC4KICAgICAgICAgICAgICogSWYgaXQgaXMgbm90IHByZXNlbnQgaXQgd2lsbCB1c2UgdGhlIHN1cHBsaWVkIHBhdGggdG8gbG9hZCB0aGUgSlNPTjIgbGlicmFyeS4KICAgICAgICAgICAgICogVGhpcyBzaG91bGQgYmUgY2FsbGVkIGluIHRoZSBkb2N1bWVudHMgaGVhZCByaWdodCBhZnRlciB0aGUgZWFzeVhETSBzY3JpcHQgdGFnLgogICAgICAgICAgICAgKiBodHRwOi8vanNvbi5vcmcvanNvbjIuanMKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGggQSB2YWxpZCBwYXRoIHRvIGpzb24yLmpzCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZXF1aXJlc0pTT046IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICAgICAgICAgIGlmICghaXNIb3N0T2JqZWN0KHdpbmRvdywgIkpTT04iKSkgewogICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gZW5jb2RlIHRoZSA8IGluIG9yZGVyIHRvIGF2b2lkIGFuIGlsbGVnYWwgdG9rZW4gZXJyb3IKICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSBzY3JpcHQgaXMgaW5saW5lZCBpbiBhIGRvY3VtZW50LgogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LndyaXRlKCc8JyArICdzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0IiBzcmM9IicgKyBwYXRoICsgJyI+PCcgKyAnL3NjcmlwdD4nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgLypqc2xpbnQgZXZpbDogdHJ1ZSwgYnJvd3NlcjogdHJ1ZSwgaW1tZWQ6IHRydWUsIHBhc3NmYWlsOiB0cnVlLCB1bmRlZjogdHJ1ZSwgbmV3Y2FwOiB0cnVlKi8KICAgICAgICAvKmdsb2JhbCBlYXN5WERNLCB3aW5kb3csIGVzY2FwZSwgdW5lc2NhcGUsIGRlYnVnICovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gVGhlIG1hcCBjb250YWluaW5nIHRoZSBzdG9yZWQgZnVuY3Rpb25zCiAgICAgICAgICAgIHZhciBfbWFwID0ge307CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQGNsYXNzIGVhc3lYRE0uRm4KICAgICAgICAgICAgICogVGhpcyBjb250YWlucyBtZXRob2RzIHJlbGF0ZWQgdG8gZnVuY3Rpb24gaGFuZGxpbmcsIHN1Y2ggYXMgc3RvcmluZyBjYWxsYmFja3MuCiAgICAgICAgICAgICAqIEBzaW5nbGV0b24KICAgICAgICAgICAgICogQG5hbWVzcGFjZSBlYXN5WERNCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBlYXN5WERNLkZuID0gewogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBTdG9yZXMgYSBmdW5jdGlvbiB1c2luZyB0aGUgZ2l2ZW4gbmFtZSBmb3IgcmVmZXJlbmNlCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSB0aGF0IHRoZSBmdW5jdGlvbiBzaG91bGQgYmUgcmVmZXJyZWQgYnkKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBzdG9yZQogICAgICAgICAgICAgICAgICogQG5hbWVzcGFjZSBlYXN5WERNLmZuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmFtZSwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBfbWFwW25hbWVdID0gZm47CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBSZXRyaWV2ZXMgdGhlIGZ1bmN0aW9uIHJlZmVycmVkIHRvIGJ5IHRoZSBnaXZlbiBuYW1lCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgZnVuY3Rpb24gdG8gcmV0cmlldmUKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gZGVsIElmIHRoZSBmdW5jdGlvbiBzaG91bGQgYmUgZGVsZXRlZCBhZnRlciByZXRyaWV2YWwKICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSBUaGUgc3RvcmVkIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZXNwYWNlIGVhc3lYRE0uZm4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbihuYW1lLCBkZWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZm4gPSBfbWFwW25hbWVdOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZGVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBfbWFwW25hbWVdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgIH0oKSk7CiAgICAgICAgLypqc2xpbnQgZXZpbDogdHJ1ZSwgYnJvd3NlcjogdHJ1ZSwgaW1tZWQ6IHRydWUsIHBhc3NmYWlsOiB0cnVlLCB1bmRlZjogdHJ1ZSwgbmV3Y2FwOiB0cnVlKi8KICAgICAgICAvKmdsb2JhbCBlYXN5WERNLCB3aW5kb3csIGVzY2FwZSwgdW5lc2NhcGUsIGNoYWluU3RhY2ssIHByZXBhcmVUcmFuc3BvcnRTdGFjaywgZ2V0TG9jYXRpb24sIGRlYnVnICovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLlNvY2tldAogICAgICAgICAqIFRoaXMgY2xhc3MgY3JlYXRlcyBhIHRyYW5zcG9ydCBjaGFubmVsIGJldHdlZW4gdHdvIGRvbWFpbnMgdGhhdCBpcyB1c2FibGUgZm9yIHNlbmRpbmcgYW5kIHJlY2VpdmluZyBzdHJpbmctYmFzZWQgbWVzc2FnZXMuPGJyLz4KICAgICAgICAgKiBUaGUgY2hhbm5lbCBpcyByZWxpYWJsZSwgc3VwcG9ydHMgcXVldWVpbmcsIGFuZCBlbnN1cmVzIHRoYXQgdGhlIG1lc3NhZ2Ugb3JpZ2luYXRlcyBmcm9tIHRoZSBleHBlY3RlZCBkb21haW4uPGJyLz4KICAgICAgICAgKiBJbnRlcm5hbGx5IGRpZmZlcmVudCBzdGFja3Mgd2lsbCBiZSB1c2VkIGRlcGVuZGluZyBvbiB0aGUgYnJvd3NlcnMgZmVhdHVyZXMgYW5kIHRoZSBhdmFpbGFibGUgcGFyYW1ldGVycy4KICAgICAgICAgKiA8aDI+SG93IHRvIHNldCB1cDwvaDI+CiAgICAgICAgICogU2V0dGluZyB1cCB0aGUgcHJvdmlkZXI6CiAgICAgICAgICogPHByZT48Y29kZT4KICAgICAgICAgKiB2YXIgc29ja2V0ID0gbmV3IGVhc3lYRE0uU29ja2V0KHsKICAgICAgICAgKiAmbmJzcDsgbG9jYWw6ICJuYW1lLmh0bWwiLAogICAgICAgICAqICZuYnNwOyBvblJlYWR5OiBmdW5jdGlvbigpewogICAgICAgICAqICZuYnNwOyAmbmJzcDsgJiM0NzsmIzQ3OyB5b3UgbmVlZCB0byB3YWl0IGZvciB0aGUgb25SZWFkeSBjYWxsYmFjayBiZWZvcmUgdXNpbmcgdGhlIHNvY2tldAogICAgICAgICAqICZuYnNwOyAmbmJzcDsgc29ja2V0LnBvc3RNZXNzYWdlKCJmb28tbWVzc2FnZSIpOwogICAgICAgICAqICZuYnNwOyB9LAogICAgICAgICAqICZuYnNwOyBvbk1lc3NhZ2U6IGZ1bmN0aW9uKG1lc3NhZ2UsIG9yaWdpbikgewogICAgICAgICAqICZuYnNwOyZuYnNwOyBhbGVydCgicmVjZWl2ZWQgIiArIG1lc3NhZ2UgKyAiIGZyb20gIiArIG9yaWdpbik7CiAgICAgICAgICogJm5ic3A7IH0KICAgICAgICAgKiB9KTsKICAgICAgICAgKiA8L2NvZGU+PC9wcmU+CiAgICAgICAgICogU2V0dGluZyB1cCB0aGUgY29uc3VtZXI6CiAgICAgICAgICogPHByZT48Y29kZT4KICAgICAgICAgKiB2YXIgc29ja2V0ID0gbmV3IGVhc3lYRE0uU29ja2V0KHsKICAgICAgICAgKiAmbmJzcDsgcmVtb3RlOiAiaHR0cDomIzQ3OyYjNDc7cmVtb3RlZG9tYWluL3BhZ2UuaHRtbCIsCiAgICAgICAgICogJm5ic3A7IHJlbW90ZUhlbHBlcjogImh0dHA6JiM0NzsmIzQ3O3JlbW90ZWRvbWFpbi9uYW1lLmh0bWwiLAogICAgICAgICAqICZuYnNwOyBvblJlYWR5OiBmdW5jdGlvbigpewogICAgICAgICAqICZuYnNwOyAmbmJzcDsgJiM0NzsmIzQ3OyB5b3UgbmVlZCB0byB3YWl0IGZvciB0aGUgb25SZWFkeSBjYWxsYmFjayBiZWZvcmUgdXNpbmcgdGhlIHNvY2tldAogICAgICAgICAqICZuYnNwOyAmbmJzcDsgc29ja2V0LnBvc3RNZXNzYWdlKCJmb28tbWVzc2FnZSIpOwogICAgICAgICAqICZuYnNwOyB9LAogICAgICAgICAqICZuYnNwOyBvbk1lc3NhZ2U6IGZ1bmN0aW9uKG1lc3NhZ2UsIG9yaWdpbikgewogICAgICAgICAqICZuYnNwOyZuYnNwOyBhbGVydCgicmVjZWl2ZWQgIiArIG1lc3NhZ2UgKyAiIGZyb20gIiArIG9yaWdpbik7CiAgICAgICAgICogJm5ic3A7IH0KICAgICAgICAgKiB9KTsKICAgICAgICAgKiA8L2NvZGU+PC9wcmU+CiAgICAgICAgICogSWYgeW91IGFyZSB1bmFibGUgdG8gdXBsb2FkIHRoZSA8Y29kZT5uYW1lLmh0bWw8L2NvZGU+IGZpbGUgdG8gdGhlIGNvbnN1bWVycyBkb21haW4gdGhlbiByZW1vdmUgdGhlIDxjb2RlPnJlbW90ZUhlbHBlcjwvY29kZT4gcHJvcGVydHkKICAgICAgICAgKiBhbmQgZWFzeVhETSB3aWxsIGZhbGwgYmFjayB0byB1c2luZyB0aGUgSGFzaFRyYW5zcG9ydCBpbnN0ZWFkIG9mIHRoZSBOYW1lVHJhbnNwb3J0IHdoZW4gbm90IGFibGUgdG8gdXNlIGFueSBvZiB0aGUgcHJpbWFyeSB0cmFuc3BvcnRzLgogICAgICAgICAqIEBuYW1lc3BhY2UgZWFzeVhETQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBjZmcge1N0cmluZy9XaW5kb3d9IGxvY2FsIFRoZSB1cmwgdG8gdGhlIGxvY2FsIG5hbWUuaHRtbCBkb2N1bWVudCwgYSBsb2NhbCBzdGF0aWMgZmlsZSwgb3IgYSByZWZlcmVuY2UgdG8gdGhlIGxvY2FsIHdpbmRvdy4KICAgICAgICAgKiBAY2ZnIHtCb29sZWFufSBsYXp5IChDb25zdW1lciBvbmx5KSBTZXQgdGhpcyB0byB0cnVlIGlmIHlvdSB3YW50IGVhc3lYRE0gdG8gZGVmZXIgY3JlYXRpbmcgdGhlIHRyYW5zcG9ydCB1bnRpbCByZWFsbHkgbmVlZGVkLgogICAgICAgICAqIEBjZmcge1N0cmluZ30gcmVtb3RlIChDb25zdW1lciBvbmx5KSBUaGUgdXJsIHRvIHRoZSBwcm92aWRlcnMgZG9jdW1lbnQuCiAgICAgICAgICogQGNmZyB7U3RyaW5nfSByZW1vdGVIZWxwZXIgKENvbnN1bWVyIG9ubHkpIFRoZSB1cmwgdG8gdGhlIHJlbW90ZSBuYW1lLmh0bWwgZmlsZS4gVGhpcyBpcyB0byBzdXBwb3J0IE5hbWVUcmFuc3BvcnQgYXMgYSBmYWxsYmFjay4gT3B0aW9uYWwuCiAgICAgICAgICogQGNmZyB7TnVtYmVyfSBkZWxheSBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBlYXN5WERNIHNob3VsZCB0cnkgdG8gZ2V0IGEgcmVmZXJlbmNlIHRvIHRoZSBsb2NhbCB3aW5kb3cuICBPcHRpb25hbCwgZGVmYXVsdHMgdG8gMjAwMC4KICAgICAgICAgKiBAY2ZnIHtOdW1iZXJ9IGludGVydmFsIFRoZSBpbnRlcnZhbCB1c2VkIHdoZW4gcG9sbGluZyBmb3IgbWVzc2FnZXMuIE9wdGlvbmFsLCBkZWZhdWx0cyB0byAzMDAuCiAgICAgICAgICogQGNmZyB7U3RyaW5nfSBjaGFubmVsIChDb25zdW1lciBvbmx5KSBUaGUgbmFtZSBvZiB0aGUgY2hhbm5lbCB0byB1c2UuIENhbiBiZSB1c2VkIHRvIHNldCBjb25zaXN0ZW50IGlmcmFtZSBuYW1lcy4gTXVzdCBiZSB1bmlxdWUuIE9wdGlvbmFsLgogICAgICAgICAqIEBjZmcge0Z1bmN0aW9ufSBvbk1lc3NhZ2UgVGhlIG1ldGhvZCB0aGF0IHNob3VsZCBoYW5kbGUgaW5jb21pbmcgbWVzc2FnZXMuPGJyLz4gVGhpcyBtZXRob2Qgc2hvdWxkIGFjY2VwdCB0d28gYXJndW1lbnRzLCB0aGUgbWVzc2FnZSBhcyBhIHN0cmluZywgYW5kIHRoZSBvcmlnaW4gYXMgYSBzdHJpbmcuIE9wdGlvbmFsLgogICAgICAgICAqIEBjZmcge0Z1bmN0aW9ufSBvblJlYWR5IEEgbWV0aG9kIHRoYXQgc2hvdWxkIGJlIGNhbGxlZCB3aGVuIHRoZSB0cmFuc3BvcnQgaXMgcmVhZHkuIE9wdGlvbmFsLgogICAgICAgICAqIEBjZmcge0RPTUVsZW1lbnR8U3RyaW5nfSBjb250YWluZXIgKENvbnN1bWVyIG9ubHkpIFRoZSBlbGVtZW50LCBvciB0aGUgaWQgb2YgdGhlIGVsZW1lbnQgdGhhdCB0aGUgcHJpbWFyeSBpZnJhbWUgc2hvdWxkIGJlIGluc2VydGVkIGludG8uIElmIG5vdCBzZXQgdGhlbiB0aGUgaWZyYW1lIHdpbGwgYmUgcG9zaXRpb25lZCBvZmYtc2NyZWVuLiBPcHRpb25hbC4KICAgICAgICAgKiBAY2ZnIHtBcnJheS9TdHJpbmd9IGFjbCAoUHJvdmlkZXIgb25seSkgSGVyZSB5b3UgY2FuIHNwZWNpZnkgd2hpY2ggJ1twcm90b2NvbF06Ly9bZG9tYWluXScgcGF0dGVybnMgdGhhdCBzaG91bGQgYmUgYWxsb3dlZCB0byBhY3QgYXMgdGhlIGNvbnN1bWVyIHRvd2FyZHMgdGhpcyBwcm92aWRlci48YnIvPgogICAgICAgICAqIFRoaXMgY2FuIGNvbnRhaW4gdGhlIHdpbGRjYXJkcyA/IGFuZCAqLiAgRXhhbXBsZXMgYXJlICdodHRwOi8vZXhhbXBsZS5jb20nLCAnKi5mb28uY29tJyBhbmQgJypkb20/LmNvbScuIElmIHlvdSB3YW50IHRvIHVzZSByZXF1bGFyIGV4cHJlc3Npb25zIHRoZW4geW91IHBhdHRlcm4gbmVlZHMgdG8gc3RhcnQgd2l0aCBeIGFuZCBlbmQgd2l0aCAkLgogICAgICAgICAqIElmIG5vbmUgb2YgdGhlIHBhdHRlcm5zIG1hdGNoIGFuIEVycm9yIHdpbGwgYmUgdGhyb3duLgogICAgICAgICAqIEBjZmcge09iamVjdH0gcHJvcHMgKENvbnN1bWVyIG9ubHkpIEFkZGl0aW9uYWwgcHJvcGVydGllcyB0aGF0IHNob3VsZCBiZSBhcHBsaWVkIHRvIHRoZSBpZnJhbWUuIFRoaXMgY2FuIGFsc28gY29udGFpbiBuZXN0ZWQgb2JqZWN0cyBlLmc6IDxjb2RlPntzdHlsZTp7d2lkdGg6IjEwMHB4IiwgaGVpZ2h0OiIxMDBweCJ9fTwvY29kZT4uCiAgICAgICAgICogUHJvcGVydGllcyBzdWNoIGFzICduYW1lJyBhbmQgJ3NyYycgd2lsbCBiZSBvdmVycmlkZWQuIE9wdGlvbmFsLgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uU29ja2V0ID0gZnVuY3Rpb24oY29uZmlnKSB7CgogICAgICAgICAgICAvLyBjcmVhdGUgdGhlIHN0YWNrCiAgICAgICAgICAgIHZhciBzdGFjayA9IGNoYWluU3RhY2socHJlcGFyZVRyYW5zcG9ydFN0YWNrKGNvbmZpZykuY29uY2F0KFt7CiAgICAgICAgICAgICAgICBpbmNvbWluZzogZnVuY3Rpb24obWVzc2FnZSwgb3JpZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLm9uTWVzc2FnZShtZXNzYWdlLCBvcmlnaW4pOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5vblJlYWR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5vblJlYWR5KHN1Y2Nlc3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV0pKSwKICAgICAgICAgICAgICAgIHJlY2lwaWVudCA9IGdldExvY2F0aW9uKGNvbmZpZy5yZW1vdGUpOwoKICAgICAgICAgICAgLy8gc2V0IHRoZSBvcmlnaW4KICAgICAgICAgICAgdGhpcy5vcmlnaW4gPSBnZXRMb2NhdGlvbihjb25maWcucmVtb3RlKTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBJbml0aWF0ZXMgdGhlIGRlc3RydWN0aW9uIG9mIHRoZSBzdGFjay4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRoaXMuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc3RhY2suZGVzdHJveSgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFBvc3RzIGEgbWVzc2FnZSB0byB0aGUgcmVtb3RlIGVuZCBvZiB0aGUgY2hhbm5lbAogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgbWVzc2FnZSB0byBzZW5kCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB0aGlzLnBvc3RNZXNzYWdlID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICAgICAgc3RhY2sub3V0Z29pbmcobWVzc2FnZSwgcmVjaXBpZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHN0YWNrLmluaXQoKTsKICAgICAgICB9OwogICAgICAgIC8qanNsaW50IGV2aWw6IHRydWUsIGJyb3dzZXI6IHRydWUsIGltbWVkOiB0cnVlLCBwYXNzZmFpbDogdHJ1ZSwgdW5kZWY6IHRydWUsIG5ld2NhcDogdHJ1ZSovCiAgICAgICAgLypnbG9iYWwgZWFzeVhETSwgd2luZG93LCBlc2NhcGUsIHVuZXNjYXBlLCB1bmRlZiwsIGNoYWluU3RhY2ssIHByZXBhcmVUcmFuc3BvcnRTdGFjaywgZGVidWcsIGdldExvY2F0aW9uICovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLlJwYwogICAgICAgICAqIENyZWF0ZXMgYSBwcm94eSBvYmplY3QgdGhhdCBjYW4gYmUgdXNlZCB0byBjYWxsIG1ldGhvZHMgaW1wbGVtZW50ZWQgb24gdGhlIHJlbW90ZSBlbmQgb2YgdGhlIGNoYW5uZWwsIGFuZCBhbHNvIHRvIHByb3ZpZGUgdGhlIGltcGxlbWVudGF0aW9uCiAgICAgICAgICogb2YgbWV0aG9kcyB0byBiZSBjYWxsZWQgZnJvbSB0aGUgcmVtb3RlIGVuZC48YnIvPgogICAgICAgICAqIFRoZSBpbnN0YW50aWF0ZWQgb2JqZWN0IHdpbGwgaGF2ZSBtZXRob2RzIG1hdGNoaW5nIHRob3NlIHNwZWNpZmllZCBpbiA8Y29kZT5jb25maWcucmVtb3RlPC9jb2RlPi48YnIvPgogICAgICAgICAqIFRoaXMgcmVxdWlyZXMgdGhlIEpTT04gb2JqZWN0IHByZXNlbnQgaW4gdGhlIGRvY3VtZW50LCBlaXRoZXIgbmF0aXZlbHksIHVzaW5nIGpzb24ub3JnJ3MganNvbjIgb3IgYXMgYSB3cmFwcGVyIGFyb3VuZCBsaWJyYXJ5IHNwZXNpZmljIG1ldGhvZHMuCiAgICAgICAgICogPGgyPkhvdyB0byBzZXQgdXA8L2gyPgogICAgICAgICAqIDxwcmU+PGNvZGU+CiAgICAgICAgICogdmFyIHJwYyA9IG5ldyBlYXN5WERNLlJwYyh7CiAgICAgICAgICogJm5ic3A7ICYjNDc7JiM0NzsgdGhpcyBjb25maWd1cmF0aW9uIGlzIGVxdWFsIHRvIHRoYXQgdXNlZCBieSB0aGUgU29ja2V0LgogICAgICAgICAqICZuYnNwOyByZW1vdGU6ICJodHRwOiYjNDc7JiM0NztyZW1vdGVkb21haW4vLi4uIiwKICAgICAgICAgKiAmbmJzcDsgb25SZWFkeTogZnVuY3Rpb24oKXsKICAgICAgICAgKiAmbmJzcDsgJm5ic3A7ICYjNDc7JiM0NzsgeW91IG5lZWQgdG8gd2FpdCBmb3IgdGhlIG9uUmVhZHkgY2FsbGJhY2sgYmVmb3JlIHVzaW5nIHRoZSBwcm94eQogICAgICAgICAqICZuYnNwOyAmbmJzcDsgcnBjLmZvbyguLi4KICAgICAgICAgKiAmbmJzcDsgfQogICAgICAgICAqIH0sewogICAgICAgICAqICZuYnNwOyBsb2NhbDogey4ufSwKICAgICAgICAgKiAmbmJzcDsgcmVtb3RlOiB7Li59CiAgICAgICAgICogfSk7CiAgICAgICAgICogPC9jb2RlPjwvcHJlPgogICAgICAgICAqCiAgICAgICAgICogPGgyPkV4cG9zaW5nIGZ1bmN0aW9ucyAocHJvY2VkdXJlcyk8L2gyPgogICAgICAgICAqIDxwcmU+PGNvZGU+CiAgICAgICAgICogdmFyIHJwYyA9IG5ldyBlYXN5WERNLlJwYyh7CiAgICAgICAgICogJm5ic3A7IC4uLgogICAgICAgICAqIH0sewogICAgICAgICAqICZuYnNwOyBsb2NhbDogewogICAgICAgICAqICZuYnNwOyAmbmJzcDsgbmFtZU9mTWV0aG9kOiB7CiAgICAgICAgICogJm5ic3A7ICZuYnNwOyAmbmJzcDsgbWV0aG9kOiBmdW5jdGlvbihhcmcxLCBhcmcyLCBzdWNjZXNzLCBlcnJvcil7CiAgICAgICAgICogJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IC4uLgogICAgICAgICAqICZuYnNwOyAmbmJzcDsgJm5ic3A7IH0KICAgICAgICAgKiAmbmJzcDsgJm5ic3A7IH0sCiAgICAgICAgICogJm5ic3A7ICZuYnNwOyAmIzQ3OyYjNDc7IHdpdGggc2hvcnRoYW5kIG5vdGF0aW9uCiAgICAgICAgICogJm5ic3A7ICZuYnNwOyBuYW1lT2ZBbm90aGVyTWV0aG9kOiAgZnVuY3Rpb24oYXJnMSwgYXJnMiwgc3VjY2VzcywgZXJyb3IpewogICAgICAgICAqICZuYnNwOyAmbmJzcDsgfQogICAgICAgICAqICZuYnNwOyB9LAogICAgICAgICAqICZuYnNwOyByZW1vdGU6IHsuLi59CiAgICAgICAgICogfSk7CiAgICAgICAgICogPC9jb2RlPjwvcHJlPgoKICAgICAgICAgKiBUaGUgZnVuY3Rpb24gcmVmZXJlbmNlZCBieSAgW21ldGhvZF0gd2lsbCByZWNlaXZlIHRoZSBwYXNzZWQgYXJndW1lbnRzIGZvbGxvd2VkIGJ5IHRoZSBjYWxsYmFjayBmdW5jdGlvbnMgPGNvZGU+c3VjY2VzczwvY29kZT4gYW5kIDxjb2RlPmVycm9yPC9jb2RlPi48YnIvPgogICAgICAgICAqIFRvIHNlbmQgYSBzdWNjZXNzZnVsbCByZXN1bHQgYmFjayB5b3UgY2FuIHVzZQogICAgICAgICAqICAgICA8cHJlPjxjb2RlPgogICAgICAgICAqICAgICByZXR1cm4gZm9vOwogICAgICAgICAqICAgICA8L3ByZT48L2NvZGU+CiAgICAgICAgICogb3IKICAgICAgICAgKiAgICAgPHByZT48Y29kZT4KICAgICAgICAgKiAgICAgc3VjY2Vzcyhmb28pOwogICAgICAgICAqICAgICA8L3ByZT48L2NvZGU+CiAgICAgICAgICogIFRvIHJldHVybiBhbiBlcnJvciB5b3UgY2FuIHVzZQogICAgICAgICAqICAgICA8cHJlPjxjb2RlPgogICAgICAgICAqICAgICB0aHJvdyBuZXcgRXJyb3IoImZvbyBlcnJvciIpOwogICAgICAgICAqICAgICA8L2NvZGU+PC9wcmU+CiAgICAgICAgICogb3IKICAgICAgICAgKiAgICAgPHByZT48Y29kZT4KICAgICAgICAgKiAgICAgZXJyb3IoImZvbyBlcnJvciIpOwogICAgICAgICAqICAgICA8L2NvZGU+PC9wcmU+CiAgICAgICAgICoKICAgICAgICAgKiA8aDI+RGVmaW5pbmcgcmVtb3RlbHkgZXhwb3NlZCBtZXRob2RzIChwcm9jZWR1cmVzL25vdGlmaWNhdGlvbnMpPC9oMj4KICAgICAgICAgKiBUaGUgZGVmaW5pdGlvbiBvZiB0aGUgcmVtb3RlIGVuZCBpcyBxdWl0ZSBzaW1pbGFyOgogICAgICAgICAqIDxwcmU+PGNvZGU+CiAgICAgICAgICogdmFyIHJwYyA9IG5ldyBlYXN5WERNLlJwYyh7CiAgICAgICAgICogJm5ic3A7IC4uLgogICAgICAgICAqIH0sewogICAgICAgICAqICZuYnNwOyBsb2NhbDogey4uLn0sCiAgICAgICAgICogJm5ic3A7IHJlbW90ZTogewogICAgICAgICAqICZuYnNwOyAmbmJzcDsgbmFtZU9mTWV0aG9kOiB7fQogICAgICAgICAqICZuYnNwOyB9CiAgICAgICAgICogfSk7CiAgICAgICAgICogPC9jb2RlPjwvcHJlPgogICAgICAgICAqIFRvIGNhbGwgYSByZW1vdGUgbWV0aG9kIHVzZQogICAgICAgICAqIDxwcmU+PGNvZGU+CiAgICAgICAgICogcnBjLm5hbWVPZk1ldGhvZCgiYXJnMSIsICJhcmcyIiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgKiAmbmJzcDsgYWxlcnQoInN1Y2Nlc3M6ICIgKyB2YWx1ZSk7CiAgICAgICAgICogfSwgZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAqICZuYnNwOyBhbGVydCgiZXJyb3I6ICIgKyBtZXNzYWdlICsgKTsKICAgICAgICAgKiB9KTsKICAgICAgICAgKiA8L2NvZGU+PC9wcmU+CiAgICAgICAgICogQm90aCB0aGUgPGNvZGU+c3VjY2VzczwvY29kZT4gYW5kIDxjb2RlPmVycnJvcjwvY29kZT4gY2FsbGJhY2tzIGFyZSBvcHRpb25hbC48YnIvPgogICAgICAgICAqIFdoZW4gY2FsbGVkIHdpdGggbm8gY2FsbGJhY2sgYSBKU09OLVJQQyAyLjAgbm90aWZpY2F0aW9uIHdpbGwgYmUgZXhlY3V0ZWQuCiAgICAgICAgICogQmUgYXdhcmUgdGhhdCB5b3Ugd2lsbCBub3QgYmUgbm90aWZpZWQgb2YgYW55IGVycm9ycyB3aXRoIHRoaXMgbWV0aG9kLgogICAgICAgICAqIDxici8+CiAgICAgICAgICogPGgyPlNwZWNpZnlpbmcgYSBjdXN0b20gc2VyaWFsaXplcjwvaDI+CiAgICAgICAgICogSWYgeW91IGRvIG5vdCB3YW50IHRvIHVzZSB0aGUgSlNPTjIgbGlicmFyeSBmb3Igbm9uLW5hdGl2ZSBKU09OIHN1cHBvcnQsIGJ1dCBpbnN0ZWFkIGNhcGFiaWxpdGllcyBwcm92aWRlZCBieSBzb21lIG90aGVyIGxpYnJhcnkKICAgICAgICAgKiB0aGVuIHlvdSBjYW4gc3BlY2lmeSBhIGN1c3RvbSBzZXJpYWxpemVyIHVzaW5nIDxjb2RlPnNlcmlhbGl6ZXI6IGZvbzwvY29kZT4KICAgICAgICAgKiA8cHJlPjxjb2RlPgogICAgICAgICAqIHZhciBycGMgPSBuZXcgZWFzeVhETS5ScGMoewogICAgICAgICAqICZuYnNwOyAuLi4KICAgICAgICAgKiB9LHsKICAgICAgICAgKiAmbmJzcDsgbG9jYWw6IHsuLi59LAogICAgICAgICAqICZuYnNwOyByZW1vdGU6IHsuLi59LAogICAgICAgICAqICZuYnNwOyBzZXJpYWxpemVyIDogewogICAgICAgICAqICZuYnNwOyAmbmJzcDsgcGFyc2U6IGZ1bmN0aW9uKHN0cmluZyl7IC4uLiB9LAogICAgICAgICAqICZuYnNwOyAmbmJzcDsgc3RyaW5naWZ5OiBmdW5jdGlvbihvYmplY3QpIHsuLi59CiAgICAgICAgICogJm5ic3A7IH0KICAgICAgICAgKiB9KTsKICAgICAgICAgKiA8L2NvZGU+PC9wcmU+CiAgICAgICAgICogSWYgPGNvZGU+c2VyaWFsaXplcjwvY29kZT4gaXMgc2V0IHRoZW4gdGhlIGNsYXNzIHdpbGwgbm90IGF0dGVtcHQgdG8gdXNlIHRoZSBuYXRpdmUgaW1wbGVtZW50YXRpb24uCiAgICAgICAgICogQG5hbWVzcGFjZSBlYXN5WERNCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdW5kZXJseWluZyB0cmFuc3BvcnRzIGNvbmZpZ3VyYXRpb24uIFNlZSBlYXN5WERNLlNvY2tldCBmb3IgYXZhaWxhYmxlIHBhcmFtZXRlcnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGpzb25ScGNDb25maWcgVGhlIGRlc2NyaXB0aW9uIG9mIHRoZSBpbnRlcmZhY2UgdG8gaW1wbGVtZW50LgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uUnBjID0gZnVuY3Rpb24oY29uZmlnLCBqc29uUnBjQ29uZmlnKSB7CgogICAgICAgICAgICAvLyBleHBhbmQgc2hvcnRoYW5kIG5vdGF0aW9uCiAgICAgICAgICAgIGlmIChqc29uUnBjQ29uZmlnLmxvY2FsKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBtZXRob2QgaW4ganNvblJwY0NvbmZpZy5sb2NhbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChqc29uUnBjQ29uZmlnLmxvY2FsLmhhc093blByb3BlcnR5KG1ldGhvZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1lbWJlciA9IGpzb25ScGNDb25maWcubG9jYWxbbWV0aG9kXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtZW1iZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpzb25ScGNDb25maWcubG9jYWxbbWV0aG9kXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IG1lbWJlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY3JlYXRlIHRoZSBzdGFjawogICAgICAgICAgICB2YXIgc3RhY2sgPSBjaGFpblN0YWNrKHByZXBhcmVUcmFuc3BvcnRTdGFjayhjb25maWcpLmNvbmNhdChbbmV3IGVhc3lYRE0uc3RhY2suUnBjQmVoYXZpb3IodGhpcywganNvblJwY0NvbmZpZyksIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5vblJlYWR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5vblJlYWR5KHN1Y2Nlc3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV0pKTsKCiAgICAgICAgICAgIC8vIHNldCB0aGUgb3JpZ2luCiAgICAgICAgICAgIHRoaXMub3JpZ2luID0gZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSk7CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEluaXRpYXRlcyB0aGUgZGVzdHJ1Y3Rpb24gb2YgdGhlIHN0YWNrLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzdGFjay5kZXN0cm95KCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzdGFjay5pbml0KCk7CiAgICAgICAgfTsKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIGVhc3lYRE0sIHdpbmRvdywgZXNjYXBlLCB1bmVzY2FwZSwgZ2V0TG9jYXRpb24sIGFwcGVuZFF1ZXJ5UGFyYW1ldGVycywgY3JlYXRlRnJhbWUsIGRlYnVnLCB1biwgb24sIGFwcGx5LCB3aGVuUmVhZHksIGdldFBhcmVudE9iamVjdCwgSUZSQU1FX1BSRUZJWCovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLnN0YWNrLlNhbWVPcmlnaW5UcmFuc3BvcnQKICAgICAgICAgKiBTYW1lT3JpZ2luVHJhbnNwb3J0IGlzIGEgdHJhbnNwb3J0IGNsYXNzIHRoYXQgY2FuIGJlIHVzZWQgd2hlbiBib3RoIGRvbWFpbnMgaGF2ZSB0aGUgc2FtZSBvcmlnaW4uPGJyLz4KICAgICAgICAgKiBUaGlzIGNhbiBiZSB1c2VmdWwgZm9yIHRlc3RpbmcgYW5kIGZvciB3aGVuIHRoZSBtYWluIGFwcGxpY2F0aW9uIHN1cHBvcnRzIGJvdGggaW50ZXJuYWwgYW5kIGV4dGVybmFsIHNvdXJjZXMuCiAgICAgICAgICogQG5hbWVzcGFjZSBlYXN5WERNLnN0YWNrCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdHJhbnNwb3J0cyBjb25maWd1cmF0aW9uLgogICAgICAgICAqIEBjZmcge1N0cmluZ30gcmVtb3RlIFRoZSByZW1vdGUgZG9jdW1lbnQgdG8gY29tbXVuaWNhdGUgd2l0aC4KICAgICAgICAgKi8KICAgICAgICBlYXN5WERNLnN0YWNrLlNhbWVPcmlnaW5UcmFuc3BvcnQgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAgICAgdmFyIHB1YiwgZnJhbWUsIHNlbmQsIHRhcmdldE9yaWdpbjsKCiAgICAgICAgICAgIHJldHVybiAocHViID0gewogICAgICAgICAgICAgICAgb3V0Z29pbmc6IGZ1bmN0aW9uKG1lc3NhZ2UsIGRvbWFpbiwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBzZW5kKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIGlmIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChmcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb25ET01SZWFkeTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0T3JpZ2luID0gZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcuaXNIb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldCB1cCB0aGUgaWZyYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5KGNvbmZpZy5wcm9wcywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjOiBhcHBlbmRRdWVyeVBhcmFtZXRlcnMoY29uZmlnLnJlbW90ZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9lOiBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX2M6IGNvbmZpZy5jaGFubmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9wOiA0IC8vIDQgPSBTYW1lT3JpZ2luVHJhbnNwb3J0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IElGUkFNRV9QUkVGSVggKyBjb25maWcuY2hhbm5lbCArICJfcHJvdmlkZXIiCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBmcmFtZSA9IGNyZWF0ZUZyYW1lKGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE0uRm4uc2V0KGNvbmZpZy5jaGFubmVsLCBmdW5jdGlvbihzZW5kRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmQgPSBzZW5kRm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG1zZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5pbmNvbWluZyhtc2csIHRhcmdldE9yaWdpbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzZW5kID0gZ2V0UGFyZW50T2JqZWN0KCkuRm4uZ2V0KGNvbmZpZy5jaGFubmVsLCB0cnVlKShmdW5jdGlvbihtc2cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5pbmNvbWluZyhtc2csIHRhcmdldE9yaWdpbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgd2hlblJlYWR5KHB1Yi5vbkRPTVJlYWR5LCBwdWIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIC8qanNsaW50IGV2aWw6IHRydWUsIGJyb3dzZXI6IHRydWUsIGltbWVkOiB0cnVlLCBwYXNzZmFpbDogdHJ1ZSwgdW5kZWY6IHRydWUsIG5ld2NhcDogdHJ1ZSovCiAgICAgICAgLypnbG9iYWwgZ2xvYmFsLCBlYXN5WERNLCB3aW5kb3csIGdldExvY2F0aW9uLCBhcHBlbmRRdWVyeVBhcmFtZXRlcnMsIGNyZWF0ZUZyYW1lLCBkZWJ1ZywgYXBwbHksIHdoZW5SZWFkeSwgSUZSQU1FX1BSRUZJWCwgbmFtZXNwYWNlLCByZXNvbHZlVXJsLCBnZXREb21haW5OYW1lLCBIQVNfRkxBU0hfVEhST1RUTEVEX0JVRywgZ2V0UG9ydCwgcXVlcnkqLwogICAgICAgIC8vCiAgICAgICAgLy8gZWFzeVhETQogICAgICAgIC8vIGh0dHA6Ly9lYXN5eGRtLm5ldC8KICAgICAgICAvLyBDb3B5cmlnaHQoYykgMjAwOS0yMDExLCDDmHl2aW5kIFNlYW4gS2luc2V5LCBveXZpbmRAa2luc2V5Lm5vLgogICAgICAgIC8vCiAgICAgICAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogICAgICAgIC8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAgICAgICAgLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogICAgICAgIC8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICAgICAgICAvLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICAgICAgICAvLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgogICAgICAgIC8vCiAgICAgICAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICAgICAgICAvLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAgICAgICAvLwogICAgICAgIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAgICAgICAgLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAgICAgICAgLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAgICAgICAgLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogICAgICAgIC8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAgICAgICAgLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogICAgICAgIC8vIFRIRSBTT0ZUV0FSRS4KICAgICAgICAvLwoKICAgICAgICAvKioKICAgICAgICAgKiBAY2xhc3MgZWFzeVhETS5zdGFjay5GbGFzaFRyYW5zcG9ydAogICAgICAgICAqIEZsYXNoVHJhbnNwb3J0IGlzIGEgdHJhbnNwb3J0IGNsYXNzIHRoYXQgdXNlcyBhbiBTV0Ygd2l0aCBMb2NhbENvbm5lY3Rpb24gdG8gcGFzcyBtZXNzYWdlcyBiYWNrIGFuZCBmb3J0aC4KICAgICAgICAgKiBAbmFtZXNwYWNlIGVhc3lYRE0uc3RhY2sKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSB0cmFuc3BvcnRzIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICogQGNmZyB7U3RyaW5nfSByZW1vdGUgVGhlIHJlbW90ZSBkb21haW4gdG8gY29tbXVuaWNhdGUgd2l0aC4KICAgICAgICAgKiBAY2ZnIHtTdHJpbmd9IHNlY3JldCB0aGUgcHJlLXNoYXJlZCBzZWNyZXQgdXNlZCB0byBzZWN1cmUgdGhlIGNvbW11bmljYXRpb24uCiAgICAgICAgICogQGNmZyB7U3RyaW5nfSBzd2YgVGhlIHBhdGggdG8gdGhlIHN3ZiBmaWxlCiAgICAgICAgICogQGNmZyB7Qm9vbGVhbn0gc3dmTm9UaHJvdHRsZSBTZXQgdGhpcyB0byB0cnVlIGlmIHlvdSB3YW50IHRvIHRha2Ugc3RlcHMgdG8gYXZvaWQgYmVlaW5nIHRocm90dGxlZCB3aGVuIGhpZGRlbi4KICAgICAgICAgKiBAY2ZnIHtTdHJpbmcgfHwgRE9NRWxlbWVudH0gc3dmQ29udGFpbmVyIFNldCB0aGlzIGlmIHlvdSB3YW50IHRvIGNvbnRyb2wgd2hlcmUgdGhlIHN3ZiBpcyBwbGFjZWQKICAgICAgICAgKi8KICAgICAgICBlYXN5WERNLnN0YWNrLkZsYXNoVHJhbnNwb3J0ID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIHZhciBwdWIsIC8vIHRoZSBwdWJsaWMgaW50ZXJmYWNlCiAgICAgICAgICAgICAgICBmcmFtZSwgc2VuZCwgdGFyZ2V0T3JpZ2luLCBzd2YsIHN3ZkNvbnRhaW5lcjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIG9uTWVzc2FnZShtZXNzYWdlLCBvcmlnaW4pIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcHViLnVwLmluY29taW5nKG1lc3NhZ2UsIHRhcmdldE9yaWdpbik7CiAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFRoaXMgbWV0aG9kIGFkZHMgdGhlIFNXRiB0byB0aGUgRE9NIGFuZCBwcmVwYXJlcyB0aGUgaW5pdGlhbGl6YXRpb24gb2YgdGhlIGNoYW5uZWwKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGZ1bmN0aW9uIGFkZFN3Zihkb21haW4pIHsKICAgICAgICAgICAgICAgIC8vIHRoZSBkaWZmZXJlbnRpYXRpbmcgcXVlcnkgYXJndW1lbnQgaXMgbmVlZGVkIGluIEZsYXNoOSB0byBhdm9pZCBhIGNhY2hpbmcgaXNzdWUgd2hlcmUgTG9jYWxDb25uZWN0aW9uIHdvdWxkIHRocm93IGFuIGVycm9yLgogICAgICAgICAgICAgICAgdmFyIHVybCA9IGNvbmZpZy5zd2YgKyAiP2hvc3Q9IiArIGNvbmZpZy5pc0hvc3Q7CiAgICAgICAgICAgICAgICB2YXIgaWQgPSAiZWFzeVhETV9zd2ZfIiArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwMDAwKTsKCiAgICAgICAgICAgICAgICAvLyBwcmVwYXJlIHRoZSBpbml0IGZ1bmN0aW9uIHRoYXQgd2lsbCBmaXJlIG9uY2UgdGhlIHN3ZiBpcyByZWFkeQogICAgICAgICAgICAgICAgZWFzeVhETS5Gbi5zZXQoImZsYXNoX2xvYWRlZCIgKyBkb21haW4ucmVwbGFjZSgvW1wtLl0vZywgIl8iKSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZWFzeVhETS5zdGFjay5GbGFzaFRyYW5zcG9ydFtkb21haW5dLnN3ZiA9IHN3ZiA9IHN3ZkNvbnRhaW5lci5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgICAgIHZhciBxdWV1ZSA9IGVhc3lYRE0uc3RhY2suRmxhc2hUcmFuc3BvcnRbZG9tYWluXS5xdWV1ZTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXVlW2ldKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHF1ZXVlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBpZiAoY29uZmlnLnN3ZkNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHN3ZkNvbnRhaW5lciA9ICh0eXBlb2YgY29uZmlnLnN3ZkNvbnRhaW5lciA9PSAic3RyaW5nIikgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChjb25maWcuc3dmQ29udGFpbmVyKSA6IGNvbmZpZy5zd2ZDb250YWluZXI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUgY29udGFpbmVyIHRoYXQgd2lsbCBob2xkIHRoZSBzd2YKICAgICAgICAgICAgICAgICAgICBzd2ZDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gaHR0cDovL2J1Z3MuYWRvYmUuY29tL2ppcmEvYnJvd3NlL0ZQLTQ3OTYKICAgICAgICAgICAgICAgICAgICAvLyBodHRwOi8vdGVjaC5ncm91cHMueWFob28uY29tL2dyb3VwL2ZsZXhjb2RlcnMvbWVzc2FnZS8xNjIzNjUKICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL2dyb3Vwcy5nb29nbGUuY29tL2ZvcnVtLyMhdG9waWMvZWFzeXhkbS9tSlpKaFdhZ29MYwogICAgICAgICAgICAgICAgICAgIGFwcGx5KHN3ZkNvbnRhaW5lci5zdHlsZSwgSEFTX0ZMQVNIX1RIUk9UVExFRF9CVUcgJiYgY29uZmlnLnN3Zk5vVGhyb3R0bGUgPyB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogIjIwcHgiLAogICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogIjIwcHgiLAogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogImZpeGVkIiwKICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHQ6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogMAogICAgICAgICAgICAgICAgICAgIH0gOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogIjFweCIsCiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAiMXB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJmbG93OiAiaGlkZGVuIiwKICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHQ6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogMAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc3dmQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIG9iamVjdC9lbWJlZAogICAgICAgICAgICAgICAgdmFyIGZsYXNoVmFycyA9ICJjYWxsYmFjaz1mbGFzaF9sb2FkZWQiICsgZG9tYWluLnJlcGxhY2UoL1tcLS5dL2csICJfIikgKyAiJnByb3RvPSIgKyBnbG9iYWwubG9jYXRpb24ucHJvdG9jb2wgKyAiJmRvbWFpbj0iICsgZ2V0RG9tYWluTmFtZShnbG9iYWwubG9jYXRpb24uaHJlZikgKyAiJnBvcnQ9IiArIGdldFBvcnQoZ2xvYmFsLmxvY2F0aW9uLmhyZWYpICsgIiZucz0iICsgbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgc3dmQ29udGFpbmVyLmlubmVySFRNTCA9ICI8b2JqZWN0IGhlaWdodD0nMjAnIHdpZHRoPScyMCcgdHlwZT0nYXBwbGljYXRpb24veC1zaG9ja3dhdmUtZmxhc2gnIGlkPSciICsgaWQgKyAiJyBkYXRhPSciICsgdXJsICsgIic+IiArCiAgICAgICAgICAgICAgICAgICAgIjxwYXJhbSBuYW1lPSdhbGxvd1NjcmlwdEFjY2VzcycgdmFsdWU9J2Fsd2F5cyc+PC9wYXJhbT4iICsKICAgICAgICAgICAgICAgICAgICAiPHBhcmFtIG5hbWU9J3dtb2RlJyB2YWx1ZT0ndHJhbnNwYXJlbnQnPiIgKwogICAgICAgICAgICAgICAgICAgICI8cGFyYW0gbmFtZT0nbW92aWUnIHZhbHVlPSciICsKICAgICAgICAgICAgICAgICAgICB1cmwgKwogICAgICAgICAgICAgICAgICAgICInPjwvcGFyYW0+IiArCiAgICAgICAgICAgICAgICAgICAgIjxwYXJhbSBuYW1lPSdmbGFzaHZhcnMnIHZhbHVlPSciICsKICAgICAgICAgICAgICAgICAgICBmbGFzaFZhcnMgKwogICAgICAgICAgICAgICAgICAgICInPjwvcGFyYW0+IiArCiAgICAgICAgICAgICAgICAgICAgIjxlbWJlZCB0eXBlPSdhcHBsaWNhdGlvbi94LXNob2Nrd2F2ZS1mbGFzaCcgRmxhc2hWYXJzPSciICsKICAgICAgICAgICAgICAgICAgICBmbGFzaFZhcnMgKwogICAgICAgICAgICAgICAgICAgICInIGFsbG93U2NyaXB0QWNjZXNzPSdhbHdheXMnIHdtb2RlPSd0cmFuc3BhcmVudCcgc3JjPSciICsKICAgICAgICAgICAgICAgICAgICB1cmwgKwogICAgICAgICAgICAgICAgICAgICInIGhlaWdodD0nMScgd2lkdGg9JzEnPjwvZW1iZWQ+IiArCiAgICAgICAgICAgICAgICAgICAgIjwvb2JqZWN0PiI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAocHViID0gewogICAgICAgICAgICAgICAgb3V0Z29pbmc6IGZ1bmN0aW9uKG1lc3NhZ2UsIGRvbWFpbiwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBzd2YucG9zdE1lc3NhZ2UoY29uZmlnLmNoYW5uZWwsIG1lc3NhZ2UudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3Zi5kZXN0cm95Q2hhbm5lbChjb25maWcuY2hhbm5lbCk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgICAgICAgICBzd2YgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmIChmcmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBmcmFtZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBvbkRPTVJlYWR5OiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0T3JpZ2luID0gY29uZmlnLnJlbW90ZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gUHJlcGFyZSB0aGUgY29kZSB0aGF0IHdpbGwgYmUgcnVuIGFmdGVyIHRoZSBzd2YgaGFzIGJlZW4gaW50aWFsaXplZAogICAgICAgICAgICAgICAgICAgIGVhc3lYRE0uRm4uc2V0KCJmbGFzaF8iICsgY29uZmlnLmNoYW5uZWwgKyAiX2luaXQiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIHNldCB1cCB0aGUgb21NZXNzYWdlIGhhbmRsZXIKICAgICAgICAgICAgICAgICAgICBlYXN5WERNLkZuLnNldCgiZmxhc2hfIiArIGNvbmZpZy5jaGFubmVsICsgIl9vbk1lc3NhZ2UiLCBvbk1lc3NhZ2UpOwoKICAgICAgICAgICAgICAgICAgICBjb25maWcuc3dmID0gcmVzb2x2ZVVybChjb25maWcuc3dmKTsgLy8gcmVwb3J0cyBoYXZlIGJlZW4gbWFkZSBvZiByZXF1ZXN0cyBnb25lIHJvZ3VlIHdoZW4gdXNpbmcgcmVsYXRpdmUgcGF0aHMKICAgICAgICAgICAgICAgICAgICB2YXIgc3dmZG9tYWluID0gZ2V0RG9tYWluTmFtZShjb25maWcuc3dmKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZm4gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IGluaXQgdG8gdHJ1ZSBpbiBjYXNlIHRoZSBmbiB3YXMgY2FsbGVkIHdhcyBpbnZva2VkIGZyb20gYSBzZXBhcmF0ZSBpbnN0YW5jZQogICAgICAgICAgICAgICAgICAgICAgICBlYXN5WERNLnN0YWNrLkZsYXNoVHJhbnNwb3J0W3N3ZmRvbWFpbl0uaW5pdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3ZiA9IGVhc3lYRE0uc3RhY2suRmxhc2hUcmFuc3BvcnRbc3dmZG9tYWluXS5zd2Y7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUgY2hhbm5lbAogICAgICAgICAgICAgICAgICAgICAgICBzd2YuY3JlYXRlQ2hhbm5lbChjb25maWcuY2hhbm5lbCwgY29uZmlnLnNlY3JldCwgZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSksIGNvbmZpZy5pc0hvc3QpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5pc0hvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIEZsYXNoIGlzIGdvaW5nIHRvIGJlIHRocm90dGxlZCBhbmQgd2Ugd2FudCB0byBhdm9pZCB0aGlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoSEFTX0ZMQVNIX1RIUk9UVExFRF9CVUcgJiYgY29uZmlnLnN3Zk5vVGhyb3R0bGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBseShjb25maWcucHJvcHMsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJmaXhlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogIjIwcHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogIjIwcHgiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXQgdXAgdGhlIGlmcmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHkoY29uZmlnLnByb3BzLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjOiBhcHBlbmRRdWVyeVBhcmFtZXRlcnMoY29uZmlnLnJlbW90ZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ZG1fZTogZ2V0TG9jYXRpb24obG9jYXRpb24uaHJlZiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9jOiBjb25maWcuY2hhbm5lbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX3A6IDYsIC8vIDYgPSBGbGFzaFRyYW5zcG9ydAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ZG1fczogY29uZmlnLnNlY3JldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IElGUkFNRV9QUkVGSVggKyBjb25maWcuY2hhbm5lbCArICJfcHJvdmlkZXIiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lID0gY3JlYXRlRnJhbWUoY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGlmIChlYXN5WERNLnN0YWNrLkZsYXNoVHJhbnNwb3J0W3N3ZmRvbWFpbl0gJiYgZWFzeVhETS5zdGFjay5GbGFzaFRyYW5zcG9ydFtzd2Zkb21haW5dLmluaXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHN3ZiBpcyBpbiBwbGFjZSBhbmQgd2UgYXJlIHRoZSBjb25zdW1lcgogICAgICAgICAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBzd2YgZG9lcyBub3QgeWV0IGV4aXN0CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZWFzeVhETS5zdGFjay5GbGFzaFRyYW5zcG9ydFtzd2Zkb21haW5dKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGQgdGhlIHF1ZXVlIHRvIGhvbGQgdGhlIGluaXQgZm4ncwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWFzeVhETS5zdGFjay5GbGFzaFRyYW5zcG9ydFtzd2Zkb21haW5dID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXVlOiBbZm5dCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkU3dmKHN3ZmRvbWFpbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlYXN5WERNLnN0YWNrLkZsYXNoVHJhbnNwb3J0W3N3ZmRvbWFpbl0ucXVldWUucHVzaChmbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgd2hlblJlYWR5KHB1Yi5vbkRPTVJlYWR5LCBwdWIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIC8qanNsaW50IGV2aWw6IHRydWUsIGJyb3dzZXI6IHRydWUsIGltbWVkOiB0cnVlLCBwYXNzZmFpbDogdHJ1ZSwgdW5kZWY6IHRydWUsIG5ld2NhcDogdHJ1ZSovCiAgICAgICAgLypnbG9iYWwgZWFzeVhETSwgd2luZG93LCBlc2NhcGUsIHVuZXNjYXBlLCBnZXRMb2NhdGlvbiwgYXBwZW5kUXVlcnlQYXJhbWV0ZXJzLCBjcmVhdGVGcmFtZSwgZGVidWcsIHVuLCBvbiwgYXBwbHksIHdoZW5SZWFkeSwgSUZSQU1FX1BSRUZJWCovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLnN0YWNrLlBvc3RNZXNzYWdlVHJhbnNwb3J0CiAgICAgICAgICogUG9zdE1lc3NhZ2VUcmFuc3BvcnQgaXMgYSB0cmFuc3BvcnQgY2xhc3MgdGhhdCB1c2VzIEhUTUw1IHBvc3RNZXNzYWdlIGZvciBjb21tdW5pY2F0aW9uLjxici8+CiAgICAgICAgICogPGEgaHJlZj0iaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNjQ0OTQ0KFZTLjg1KS5hc3B4Ij5odHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM2NDQ5NDQoVlMuODUpLmFzcHg8L2E+PGJyLz4KICAgICAgICAgKiA8YSBocmVmPSJodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9ET00vd2luZG93LnBvc3RNZXNzYWdlIj5odHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9ET00vd2luZG93LnBvc3RNZXNzYWdlPC9hPgogICAgICAgICAqIEBuYW1lc3BhY2UgZWFzeVhETS5zdGFjawogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHRyYW5zcG9ydHMgY29uZmlndXJhdGlvbi4KICAgICAgICAgKiBAY2ZnIHtTdHJpbmd9IHJlbW90ZSBUaGUgcmVtb3RlIGRvbWFpbiB0byBjb21tdW5pY2F0ZSB3aXRoLgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uc3RhY2suUG9zdE1lc3NhZ2VUcmFuc3BvcnQgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAgICAgdmFyIHB1YiwgLy8gdGhlIHB1YmxpYyBpbnRlcmZhY2UKICAgICAgICAgICAgICAgIGZyYW1lLCAvLyB0aGUgcmVtb3RlIGZyYW1lLCBpZiBhbnkKICAgICAgICAgICAgICAgIGNhbGxlcldpbmRvdywgLy8gdGhlIHdpbmRvdyB0aGF0IHdlIHdpbGwgY2FsbCB3aXRoCiAgICAgICAgICAgICAgICB0YXJnZXRPcmlnaW47IC8vIHRoZSBkb21haW4gdG8gY29tbXVuaWNhdGUgd2l0aAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUmVzb2x2ZXMgdGhlIG9yaWdpbiBmcm9tIHRoZSBldmVudCBvYmplY3QKICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IFRoZSBtZXNzYWdlZXZlbnQKICAgICAgICAgICAgICogQHJldHVybiB7U3RyaW5nfSBUaGUgc2NoZW1lLCBob3N0IGFuZCBwb3J0IG9mIHRoZSBvcmlnaW4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGZ1bmN0aW9uIF9nZXRPcmlnaW4oZXZlbnQpIHsKICAgICAgICAgICAgICAgIGlmIChldmVudC5vcmlnaW4pIHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBIVE1MNSBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRMb2NhdGlvbihldmVudC5vcmlnaW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV2ZW50LnVyaSkgewogICAgICAgICAgICAgICAgICAgIC8vIEZyb20gZWFybGllciBpbXBsZW1lbnRhdGlvbnMKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0TG9jYXRpb24oZXZlbnQudXJpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChldmVudC5kb21haW4pIHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBsYXN0IG9wdGlvbiBhbmQgd2lsbCBmYWlsIGlmIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIG9yaWdpbiBpcyBub3QgdXNpbmcgdGhlIHNhbWUgc2NoZW1hIGFzIHdlIGFyZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBldmVudC5kb21haW47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aHJvdyAiVW5hYmxlIHRvIHJldHJpZXZlIHRoZSBvcmlnaW4gb2YgdGhlIGV2ZW50IjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFRoaXMgaXMgdGhlIG1haW4gaW1wbGVtZW50YXRpb24gZm9yIHRoZSBvbk1lc3NhZ2UgZXZlbnQuPGJyLz4KICAgICAgICAgICAgICogSXQgY2hlY2tzIHRoZSB2YWxpZGl0eSBvZiB0aGUgb3JpZ2luIGFuZCBwYXNzZXMgdGhlIG1lc3NhZ2Ugb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBUaGUgbWVzc2FnZWV2ZW50CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiBfd2luZG93X29uTWVzc2FnZShldmVudCkgewogICAgICAgICAgICAgICAgdmFyIG9yaWdpbiA9IF9nZXRPcmlnaW4oZXZlbnQpOwogICAgICAgICAgICAgICAgaWYgKG9yaWdpbiA9PSB0YXJnZXRPcmlnaW4gJiYgZXZlbnQuZGF0YS5zdWJzdHJpbmcoMCwgY29uZmlnLmNoYW5uZWwubGVuZ3RoICsgMSkgPT0gY29uZmlnLmNoYW5uZWwgKyAiICIpIHsKICAgICAgICAgICAgICAgICAgICBwdWIudXAuaW5jb21pbmcoZXZlbnQuZGF0YS5zdWJzdHJpbmcoY29uZmlnLmNoYW5uZWwubGVuZ3RoICsgMSksIG9yaWdpbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAocHViID0gewogICAgICAgICAgICAgICAgb3V0Z29pbmc6IGZ1bmN0aW9uKG1lc3NhZ2UsIGRvbWFpbiwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBjYWxsZXJXaW5kb3cucG9zdE1lc3NhZ2UoY29uZmlnLmNoYW5uZWwgKyAiICIgKyBtZXNzYWdlLCBkb21haW4gfHwgdGFyZ2V0T3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdW4od2luZG93LCAibWVzc2FnZSIsIF93aW5kb3dfb25NZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGVyV2luZG93ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChmcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb25ET01SZWFkeTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0T3JpZ2luID0gZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5pc0hvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWRkIHRoZSBldmVudCBoYW5kbGVyIGZvciBsaXN0ZW5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHdhaXRGb3JSZWFkeSA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuZGF0YSA9PSBjb25maWcuY2hhbm5lbCArICItcmVhZHkiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVwbGFjZSB0aGUgZXZlbnRsaXN0ZW5lcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxlcldpbmRvdyA9ICgicG9zdE1lc3NhZ2UiIGluIGZyYW1lLmNvbnRlbnRXaW5kb3cpID8gZnJhbWUuY29udGVudFdpbmRvdyA6IGZyYW1lLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW4od2luZG93LCAibWVzc2FnZSIsIHdhaXRGb3JSZWFkeSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb24od2luZG93LCAibWVzc2FnZSIsIF93aW5kb3dfb25NZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWIudXAuY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIG9uKHdpbmRvdywgIm1lc3NhZ2UiLCB3YWl0Rm9yUmVhZHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IHVwIHRoZSBpZnJhbWUKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHkoY29uZmlnLnByb3BzLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmM6IGFwcGVuZFF1ZXJ5UGFyYW1ldGVycyhjb25maWcucmVtb3RlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX2U6IGdldExvY2F0aW9uKGxvY2F0aW9uLmhyZWYpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9jOiBjb25maWcuY2hhbm5lbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ZG1fcDogMSAvLyAxID0gUG9zdE1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogSUZSQU1FX1BSRUZJWCArIGNvbmZpZy5jaGFubmVsICsgIl9wcm92aWRlciIKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lID0gY3JlYXRlRnJhbWUoY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGQgdGhlIGV2ZW50IGhhbmRsZXIgZm9yIGxpc3RlbmluZwogICAgICAgICAgICAgICAgICAgICAgICBvbih3aW5kb3csICJtZXNzYWdlIiwgX3dpbmRvd19vbk1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICBjYWxsZXJXaW5kb3cgPSAoInBvc3RNZXNzYWdlIiBpbiB3aW5kb3cucGFyZW50KSA/IHdpbmRvdy5wYXJlbnQgOiB3aW5kb3cucGFyZW50LmRvY3VtZW50OwogICAgICAgICAgICAgICAgICAgICAgICBjYWxsZXJXaW5kb3cucG9zdE1lc3NhZ2UoY29uZmlnLmNoYW5uZWwgKyAiLXJlYWR5IiwgdGFyZ2V0T3JpZ2luKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWIudXAuY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB3aGVuUmVhZHkocHViLm9uRE9NUmVhZHksIHB1Yik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgLypqc2xpbnQgZXZpbDogdHJ1ZSwgYnJvd3NlcjogdHJ1ZSwgaW1tZWQ6IHRydWUsIHBhc3NmYWlsOiB0cnVlLCB1bmRlZjogdHJ1ZSwgbmV3Y2FwOiB0cnVlKi8KICAgICAgICAvKmdsb2JhbCBlYXN5WERNLCB3aW5kb3csIGVzY2FwZSwgdW5lc2NhcGUsIGdldExvY2F0aW9uLCBhcHBlbmRRdWVyeVBhcmFtZXRlcnMsIGNyZWF0ZUZyYW1lLCBkZWJ1ZywgYXBwbHksIHF1ZXJ5LCB3aGVuUmVhZHksIElGUkFNRV9QUkVGSVgqLwogICAgICAgIC8vCiAgICAgICAgLy8gZWFzeVhETQogICAgICAgIC8vIGh0dHA6Ly9lYXN5eGRtLm5ldC8KICAgICAgICAvLyBDb3B5cmlnaHQoYykgMjAwOS0yMDExLCDDmHl2aW5kIFNlYW4gS2luc2V5LCBveXZpbmRAa2luc2V5Lm5vLgogICAgICAgIC8vCiAgICAgICAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogICAgICAgIC8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAgICAgICAgLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogICAgICAgIC8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICAgICAgICAvLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICAgICAgICAvLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgogICAgICAgIC8vCiAgICAgICAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICAgICAgICAvLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAgICAgICAvLwogICAgICAgIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAgICAgICAgLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAgICAgICAgLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAgICAgICAgLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogICAgICAgIC8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAgICAgICAgLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogICAgICAgIC8vIFRIRSBTT0ZUV0FSRS4KICAgICAgICAvLwoKICAgICAgICAvKioKICAgICAgICAgKiBAY2xhc3MgZWFzeVhETS5zdGFjay5GcmFtZUVsZW1lbnRUcmFuc3BvcnQKICAgICAgICAgKiBGcmFtZUVsZW1lbnRUcmFuc3BvcnQgaXMgYSB0cmFuc3BvcnQgY2xhc3MgdGhhdCBjYW4gYmUgdXNlZCB3aXRoIEdlY2tvLWJyb3dzZXIgYXMgdGhlc2UgYWxsb3cgcGFzc2luZyB2YXJpYWJsZXMgdXNpbmcgdGhlIGZyYW1lRWxlbWVudCBwcm9wZXJ0eS48YnIvPgogICAgICAgICAqIFNlY3VyaXR5IGlzIG1haW50YWluZWQgYXMgR2VjaG8gdXNlcyBMZXhpY2FsIEF1dGhvcml6YXRpb24gdG8gZGV0ZXJtaW5lIHVuZGVyIHdoaWNoIHNjb3BlIGEgZnVuY3Rpb24gaXMgcnVubmluZy4KICAgICAgICAgKiBAbmFtZXNwYWNlIGVhc3lYRE0uc3RhY2sKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSB0cmFuc3BvcnRzIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICogQGNmZyB7U3RyaW5nfSByZW1vdGUgVGhlIHJlbW90ZSBkb2N1bWVudCB0byBjb21tdW5pY2F0ZSB3aXRoLgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uc3RhY2suRnJhbWVFbGVtZW50VHJhbnNwb3J0ID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIHZhciBwdWIsIGZyYW1lLCBzZW5kLCB0YXJnZXRPcmlnaW47CgogICAgICAgICAgICByZXR1cm4gKHB1YiA9IHsKICAgICAgICAgICAgICAgIG91dGdvaW5nOiBmdW5jdGlvbihtZXNzYWdlLCBkb21haW4sIGZuKSB7CiAgICAgICAgICAgICAgICAgICAgc2VuZC5jYWxsKHRoaXMsIG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIGlmIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChmcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb25ET01SZWFkeTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0T3JpZ2luID0gZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcuaXNIb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldCB1cCB0aGUgaWZyYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5KGNvbmZpZy5wcm9wcywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjOiBhcHBlbmRRdWVyeVBhcmFtZXRlcnMoY29uZmlnLnJlbW90ZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9lOiBnZXRMb2NhdGlvbihsb2NhdGlvbi5ocmVmKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ZG1fYzogY29uZmlnLmNoYW5uZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX3A6IDUgLy8gNSA9IEZyYW1lRWxlbWVudFRyYW5zcG9ydAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBJRlJBTUVfUFJFRklYICsgY29uZmlnLmNoYW5uZWwgKyAiX3Byb3ZpZGVyIgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUgPSBjcmVhdGVGcmFtZShjb25maWcpOwogICAgICAgICAgICAgICAgICAgICAgICBmcmFtZS5mbiA9IGZ1bmN0aW9uKHNlbmRGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGZyYW1lLmZuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZCA9IHNlbmRGbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIGZ1bmN0aW9uIHNvIHRoYXQgaXQgY2Fubm90IGJlIHVzZWQgdG8gb3ZlcndyaXRlIHRoZSBzZW5kIGZ1bmN0aW9uIGxhdGVyIG9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24obXNnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmluY29taW5nKG1zZywgdGFyZ2V0T3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyB0byBtaXRpZ2F0ZSBvcmlnaW4tc3Bvb2ZpbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LnJlZmVycmVyICYmIGdldExvY2F0aW9uKGRvY3VtZW50LnJlZmVycmVyKSAhPSBxdWVyeS54ZG1fZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LnRvcC5sb2NhdGlvbiA9IHF1ZXJ5LnhkbV9lOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmQgPSB3aW5kb3cuZnJhbWVFbGVtZW50LmZuKGZ1bmN0aW9uKG1zZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmluY29taW5nKG1zZywgdGFyZ2V0T3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgd2hlblJlYWR5KHB1Yi5vbkRPTVJlYWR5LCBwdWIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIC8qanNsaW50IGV2aWw6IHRydWUsIGJyb3dzZXI6IHRydWUsIGltbWVkOiB0cnVlLCBwYXNzZmFpbDogdHJ1ZSwgdW5kZWY6IHRydWUsIG5ld2NhcDogdHJ1ZSovCiAgICAgICAgLypnbG9iYWwgZWFzeVhETSwgd2luZG93LCBlc2NhcGUsIHVuZXNjYXBlLCB1bmRlZiwgZ2V0TG9jYXRpb24sIGFwcGVuZFF1ZXJ5UGFyYW1ldGVycywgcmVzb2x2ZVVybCwgY3JlYXRlRnJhbWUsIGRlYnVnLCB1biwgYXBwbHksIHdoZW5SZWFkeSwgSUZSQU1FX1BSRUZJWCovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLnN0YWNrLk5hbWVUcmFuc3BvcnQKICAgICAgICAgKiBOYW1lVHJhbnNwb3J0IHVzZXMgdGhlIHdpbmRvdy5uYW1lIHByb3BlcnR5IHRvIHJlbGF5IGRhdGEuCiAgICAgICAgICogVGhlIDxjb2RlPmxvY2FsPC9jb2RlPiBwYXJhbWV0ZXIgbmVlZHMgdG8gYmUgc2V0IG9uIGJvdGggdGhlIGNvbnN1bWVyIGFuZCBwcm92aWRlciw8YnIvPgogICAgICAgICAqIGFuZCB0aGUgPGNvZGU+cmVtb3RlSGVscGVyPC9jb2RlPiBwYXJhbWV0ZXIgbmVlZHMgdG8gYmUgc2V0IG9uIHRoZSBjb25zdW1lci4KICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSB0cmFuc3BvcnRzIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICogQGNmZyB7U3RyaW5nfSByZW1vdGVIZWxwZXIgVGhlIHVybCB0byB0aGUgcmVtb3RlIGluc3RhbmNlIG9mIGhhc2guaHRtbCAtIHRoaXMgaXMgb25seSBuZWVkZWQgZm9yIHRoZSBob3N0LgogICAgICAgICAqIEBuYW1lc3BhY2UgZWFzeVhETS5zdGFjawogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uc3RhY2suTmFtZVRyYW5zcG9ydCA9IGZ1bmN0aW9uKGNvbmZpZykgewoKICAgICAgICAgICAgdmFyIHB1YjsgLy8gdGhlIHB1YmxpYyBpbnRlcmZhY2UKICAgICAgICAgICAgdmFyIGlzSG9zdCwgY2FsbGVyV2luZG93LCByZW1vdGVXaW5kb3csIHJlYWR5Q291bnQsIGNhbGxiYWNrLCByZW1vdGVPcmlnaW4sIHJlbW90ZVVybDsKCiAgICAgICAgICAgIGZ1bmN0aW9uIF9zZW5kTWVzc2FnZShtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICB2YXIgdXJsID0gY29uZmlnLnJlbW90ZUhlbHBlciArIChpc0hvc3QgPyAiI18zIiA6ICIjXzIiKSArIGNvbmZpZy5jaGFubmVsOwogICAgICAgICAgICAgICAgY2FsbGVyV2luZG93LmNvbnRlbnRXaW5kb3cuc2VuZE1lc3NhZ2UobWVzc2FnZSwgdXJsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gX29uUmVhZHkoKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNIb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCsrcmVhZHlDb3VudCA9PT0gMiB8fCAhaXNIb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9zZW5kTWVzc2FnZSgicmVhZHkiKTsKICAgICAgICAgICAgICAgICAgICBwdWIudXAuY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIF9vbk1lc3NhZ2UobWVzc2FnZSkgewogICAgICAgICAgICAgICAgcHViLnVwLmluY29taW5nKG1lc3NhZ2UsIHJlbW90ZU9yaWdpbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIF9vbkxvYWQoKSB7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIChwdWIgPSB7CiAgICAgICAgICAgICAgICBvdXRnb2luZzogZnVuY3Rpb24obWVzc2FnZSwgZG9tYWluLCBmbikgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZm47CiAgICAgICAgICAgICAgICAgICAgX3NlbmRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGNhbGxlcldpbmRvdy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGNhbGxlcldpbmRvdyk7CiAgICAgICAgICAgICAgICAgICAgY2FsbGVyV2luZG93ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNIb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW90ZVdpbmRvdy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJlbW90ZVdpbmRvdyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW90ZVdpbmRvdyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG9uRE9NUmVhZHk6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlzSG9zdCA9IGNvbmZpZy5pc0hvc3Q7CiAgICAgICAgICAgICAgICAgICAgcmVhZHlDb3VudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgcmVtb3RlT3JpZ2luID0gZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSk7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLmxvY2FsID0gcmVzb2x2ZVVybChjb25maWcubG9jYWwpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNIb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlZ2lzdGVyIHRoZSBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgICAgICBlYXN5WERNLkZuLnNldChjb25maWcuY2hhbm5lbCwgZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzSG9zdCAmJiBtZXNzYWdlID09PSAicmVhZHkiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVwbGFjZSB0aGUgaGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE0uRm4uc2V0KGNvbmZpZy5jaGFubmVsLCBfb25NZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb25SZWFkeSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB1cCB0aGUgZnJhbWUgdGhhdCBwb2ludHMgdG8gdGhlIHJlbW90ZSBpbnN0YW5jZQogICAgICAgICAgICAgICAgICAgICAgICByZW1vdGVVcmwgPSBhcHBlbmRRdWVyeVBhcmFtZXRlcnMoY29uZmlnLnJlbW90ZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX2U6IGNvbmZpZy5sb2NhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9jOiBjb25maWcuY2hhbm5lbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9wOiAyCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBhcHBseShjb25maWcucHJvcHMsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogcmVtb3RlVXJsICsgJyMnICsgY29uZmlnLmNoYW5uZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBJRlJBTUVfUFJFRklYICsgY29uZmlnLmNoYW5uZWwgKyAiX3Byb3ZpZGVyIgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3RlV2luZG93ID0gY3JlYXRlRnJhbWUoY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjb25maWcucmVtb3RlSGVscGVyID0gY29uZmlnLnJlbW90ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWFzeVhETS5Gbi5zZXQoY29uZmlnLmNoYW5uZWwsIF9vbk1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU2V0IHVwIHRoZSBpZnJhbWUgdGhhdCB3aWxsIGJlIHVzZWQgZm9yIHRoZSB0cmFuc3BvcnQKICAgICAgICAgICAgICAgICAgICB2YXIgb25Mb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgaGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdyA9IGNhbGxlcldpbmRvdyB8fCB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICB1bih3LCAibG9hZCIsIG9uTG9hZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE0uRm4uc2V0KGNvbmZpZy5jaGFubmVsICsgIl9sb2FkIiwgX29uTG9hZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiB0ZXN0KCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB3LmNvbnRlbnRXaW5kb3cuc2VuZE1lc3NhZ2UgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vblJlYWR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQodGVzdCwgNTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KCkpOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGNhbGxlcldpbmRvdyA9IGNyZWF0ZUZyYW1lKHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogY29uZmlnLmxvY2FsICsgIiNfNCIgKyBjb25maWcuY2hhbm5lbAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBvbkxvYWQ6IG9uTG9hZAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHdoZW5SZWFkeShwdWIub25ET01SZWFkeSwgcHViKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIGVhc3lYRE0sIHdpbmRvdywgZXNjYXBlLCB1bmVzY2FwZSwgZ2V0TG9jYXRpb24sIGNyZWF0ZUZyYW1lLCBkZWJ1ZywgdW4sIG9uLCBhcHBseSwgd2hlblJlYWR5LCBJRlJBTUVfUFJFRklYKi8KICAgICAgICAvLwogICAgICAgIC8vIGVhc3lYRE0KICAgICAgICAvLyBodHRwOi8vZWFzeXhkbS5uZXQvCiAgICAgICAgLy8gQ29weXJpZ2h0KGMpIDIwMDktMjAxMSwgw5h5dmluZCBTZWFuIEtpbnNleSwgb3l2aW5kQGtpbnNleS5uby4KICAgICAgICAvLwogICAgICAgIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICAgICAgICAvLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogICAgICAgIC8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICAgICAgICAvLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAgICAgICAgLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAgICAgICAgLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAgICAgICAvLwogICAgICAgIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAgICAgICAgLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgICAgICAgLy8KICAgICAgICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogICAgICAgIC8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogICAgICAgIC8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogICAgICAgIC8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICAgICAgICAvLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogICAgICAgIC8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICAgICAgICAvLyBUSEUgU09GVFdBUkUuCiAgICAgICAgLy8KCiAgICAgICAgLyoqCiAgICAgICAgICogQGNsYXNzIGVhc3lYRE0uc3RhY2suSGFzaFRyYW5zcG9ydAogICAgICAgICAqIEhhc2hUcmFuc3BvcnQgaXMgYSB0cmFuc3BvcnQgY2xhc3MgdGhhdCB1c2VzIHRoZSBJRnJhbWUgVVJMIFRlY2huaXF1ZSBmb3IgY29tbXVuaWNhdGlvbi48YnIvPgogICAgICAgICAqIDxhIGhyZWY9Imh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9iYjczNTMwNS5hc3B4Ij5odHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvYmI3MzUzMDUuYXNweDwvYT48YnIvPgogICAgICAgICAqIEBuYW1lc3BhY2UgZWFzeVhETS5zdGFjawogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHRyYW5zcG9ydHMgY29uZmlndXJhdGlvbi4KICAgICAgICAgKiBAY2ZnIHtTdHJpbmcvV2luZG93fSBsb2NhbCBUaGUgdXJsIHRvIHRoZSBsb2NhbCBmaWxlIHVzZWQgZm9yIHByb3h5aW5nIG1lc3NhZ2VzLCBvciB0aGUgbG9jYWwgd2luZG93LgogICAgICAgICAqIEBjZmcge051bWJlcn0gZGVsYXkgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgZWFzeVhETSBzaG91bGQgdHJ5IHRvIGdldCBhIHJlZmVyZW5jZSB0byB0aGUgbG9jYWwgd2luZG93LgogICAgICAgICAqIEBjZmcge051bWJlcn0gaW50ZXJ2YWwgVGhlIGludGVydmFsIHVzZWQgd2hlbiBwb2xsaW5nIGZvciBtZXNzYWdlcy4KICAgICAgICAgKi8KICAgICAgICBlYXN5WERNLnN0YWNrLkhhc2hUcmFuc3BvcnQgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAgICAgdmFyIHB1YjsKICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgICAgIGlzSG9zdCwgX3RpbWVyLCBwb2xsSW50ZXJ2YWwsIF9sYXN0TXNnLCBfbXNnTnIsIF9saXN0ZW5lcldpbmRvdywgX2NhbGxlcldpbmRvdzsKICAgICAgICAgICAgdmFyIHVzZVBhcmVudCwgX3JlbW90ZU9yaWdpbjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIF9zZW5kTWVzc2FnZShtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICBpZiAoIV9jYWxsZXJXaW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdXJsID0gY29uZmlnLnJlbW90ZSArICIjIiArIChfbXNnTnIrKykgKyAiXyIgKyBtZXNzYWdlOwogICAgICAgICAgICAgICAgKChpc0hvc3QgfHwgIXVzZVBhcmVudCkgPyBfY2FsbGVyV2luZG93LmNvbnRlbnRXaW5kb3cgOiBfY2FsbGVyV2luZG93KS5sb2NhdGlvbiA9IHVybDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gX2hhbmRsZUhhc2goaGFzaCkgewogICAgICAgICAgICAgICAgX2xhc3RNc2cgPSBoYXNoOwogICAgICAgICAgICAgICAgcHViLnVwLmluY29taW5nKF9sYXN0TXNnLnN1YnN0cmluZyhfbGFzdE1zZy5pbmRleE9mKCJfIikgKyAxKSwgX3JlbW90ZU9yaWdpbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDaGVja3MgbG9jYXRpb24uaGFzaCBmb3IgYSBuZXcgbWVzc2FnZSBhbmQgcmVsYXlzIHRoaXMgdG8gdGhlIHJlY2VpdmVyLgogICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gX3BvbGxIYXNoKCkgewogICAgICAgICAgICAgICAgaWYgKCFfbGlzdGVuZXJXaW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgaHJlZiA9IF9saXN0ZW5lcldpbmRvdy5sb2NhdGlvbi5ocmVmLAogICAgICAgICAgICAgICAgICAgIGhhc2ggPSAiIiwKICAgICAgICAgICAgICAgICAgICBpbmRleE9mID0gaHJlZi5pbmRleE9mKCIjIik7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXhPZiAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgIGhhc2ggPSBocmVmLnN1YnN0cmluZyhpbmRleE9mKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChoYXNoICYmIGhhc2ggIT0gX2xhc3RNc2cpIHsKICAgICAgICAgICAgICAgICAgICBfaGFuZGxlSGFzaChoYXNoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gX2F0dGFjaExpc3RlbmVycygpIHsKICAgICAgICAgICAgICAgIF90aW1lciA9IHNldEludGVydmFsKF9wb2xsSGFzaCwgcG9sbEludGVydmFsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIChwdWIgPSB7CiAgICAgICAgICAgICAgICBvdXRnb2luZzogZnVuY3Rpb24obWVzc2FnZSwgZG9tYWluKSB7CiAgICAgICAgICAgICAgICAgICAgX3NlbmRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhckludGVydmFsKF90aW1lcik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSG9zdCB8fCAhdXNlUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYWxsZXJXaW5kb3cucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChfY2FsbGVyV2luZG93KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgX2NhbGxlcldpbmRvdyA9IG51bGw7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb25ET01SZWFkeTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaXNIb3N0ID0gY29uZmlnLmlzSG9zdDsKICAgICAgICAgICAgICAgICAgICBwb2xsSW50ZXJ2YWwgPSBjb25maWcuaW50ZXJ2YWw7CiAgICAgICAgICAgICAgICAgICAgX2xhc3RNc2cgPSAiIyIgKyBjb25maWcuY2hhbm5lbDsKICAgICAgICAgICAgICAgICAgICBfbXNnTnIgPSAwOwogICAgICAgICAgICAgICAgICAgIHVzZVBhcmVudCA9IGNvbmZpZy51c2VQYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgX3JlbW90ZU9yaWdpbiA9IGdldExvY2F0aW9uKGNvbmZpZy5yZW1vdGUpOwogICAgICAgICAgICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHkoY29uZmlnLnByb3BzLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmM6IGNvbmZpZy5yZW1vdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBJRlJBTUVfUFJFRklYICsgY29uZmlnLmNoYW5uZWwgKyAiX3Byb3ZpZGVyIgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVzZVBhcmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLm9uTG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9saXN0ZW5lcldpbmRvdyA9IHdpbmRvdzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfYXR0YWNoTGlzdGVuZXJzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmllcyA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4ID0gY29uZmlnLmRlbGF5IC8gNTA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gZ2V0UmVmKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgrK3RyaWVzID4gbWF4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIHJlZmVyZW5jZSBsaXN0ZW5lcndpbmRvdyIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfbGlzdGVuZXJXaW5kb3cgPSBfY2FsbGVyV2luZG93LmNvbnRlbnRXaW5kb3cuZnJhbWVzW0lGUkFNRV9QUkVGSVggKyBjb25maWcuY2hhbm5lbCArICJfY29uc3VtZXIiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2xpc3RlbmVyV2luZG93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9hdHRhY2hMaXN0ZW5lcnMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZ2V0UmVmLCA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBfY2FsbGVyV2luZG93ID0gY3JlYXRlRnJhbWUoY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBfbGlzdGVuZXJXaW5kb3cgPSB3aW5kb3c7CiAgICAgICAgICAgICAgICAgICAgICAgIF9hdHRhY2hMaXN0ZW5lcnMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVzZVBhcmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NhbGxlcldpbmRvdyA9IHBhcmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5KGNvbmZpZywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogY29uZmlnLnJlbW90ZSArICIjIiArIGNvbmZpZy5jaGFubmVsICsgbmV3IERhdGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogSUZSQU1FX1BSRUZJWCArIGNvbmZpZy5jaGFubmVsICsgIl9jb25zdW1lciIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTG9hZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jYWxsZXJXaW5kb3cgPSBjcmVhdGVGcmFtZShjb25maWcpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHdoZW5SZWFkeShwdWIub25ET01SZWFkeSwgcHViKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIGVhc3lYRE0sIHdpbmRvdywgZXNjYXBlLCB1bmVzY2FwZSwgZGVidWcgKi8KICAgICAgICAvLwogICAgICAgIC8vIGVhc3lYRE0KICAgICAgICAvLyBodHRwOi8vZWFzeXhkbS5uZXQvCiAgICAgICAgLy8gQ29weXJpZ2h0KGMpIDIwMDktMjAxMSwgw5h5dmluZCBTZWFuIEtpbnNleSwgb3l2aW5kQGtpbnNleS5uby4KICAgICAgICAvLwogICAgICAgIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICAgICAgICAvLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogICAgICAgIC8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICAgICAgICAvLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAgICAgICAgLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAgICAgICAgLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAgICAgICAvLwogICAgICAgIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAgICAgICAgLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgICAgICAgLy8KICAgICAgICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogICAgICAgIC8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogICAgICAgIC8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogICAgICAgIC8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICAgICAgICAvLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogICAgICAgIC8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICAgICAgICAvLyBUSEUgU09GVFdBUkUuCiAgICAgICAgLy8KCiAgICAgICAgLyoqCiAgICAgICAgICogQGNsYXNzIGVhc3lYRE0uc3RhY2suUmVsaWFibGVCZWhhdmlvcgogICAgICAgICAqIFRoaXMgaXMgYSBiZWhhdmlvciB0aGF0IHRyaWVzIHRvIG1ha2UgdGhlIHVuZGVybHlpbmcgdHJhbnNwb3J0IHJlbGlhYmxlIGJ5IHVzaW5nIGFja25vd2xlZGdlbWVudHMuCiAgICAgICAgICogQG5hbWVzcGFjZSBlYXN5WERNLnN0YWNrCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgYmVoYXZpb3JzIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICovCiAgICAgICAgZWFzeVhETS5zdGFjay5SZWxpYWJsZUJlaGF2aW9yID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIHZhciBwdWIsIC8vIHRoZSBwdWJsaWMgaW50ZXJmYWNlCiAgICAgICAgICAgICAgICBjYWxsYmFjazsgLy8gdGhlIGNhbGxiYWNrIHRvIGV4ZWN1dGUgd2hlbiB3ZSBoYXZlIGEgY29uZmlybWVkIHN1Y2Nlc3MvZmFpbHVyZQogICAgICAgICAgICB2YXIgaWRPdXQgPSAwLAogICAgICAgICAgICAgICAgaWRJbiA9IDAsCiAgICAgICAgICAgICAgICBjdXJyZW50TWVzc2FnZSA9ICIiOwoKICAgICAgICAgICAgcmV0dXJuIChwdWIgPSB7CiAgICAgICAgICAgICAgICBpbmNvbWluZzogZnVuY3Rpb24obWVzc2FnZSwgb3JpZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4T2YgPSBtZXNzYWdlLmluZGV4T2YoIl8iKSwKICAgICAgICAgICAgICAgICAgICAgICAgYWNrID0gbWVzc2FnZS5zdWJzdHJpbmcoMCwgaW5kZXhPZikuc3BsaXQoIiwiKTsKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZS5zdWJzdHJpbmcoaW5kZXhPZiArIDEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYWNrWzBdID09IGlkT3V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRNZXNzYWdlID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBwdWIuZG93bi5vdXRnb2luZyhhY2tbMV0gKyAiLCIgKyBpZE91dCArICJfIiArIGN1cnJlbnRNZXNzYWdlLCBvcmlnaW4pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaWRJbiAhPSBhY2tbMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkSW4gPSBhY2tbMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWIudXAuaW5jb21pbmcobWVzc2FnZSwgb3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb3V0Z29pbmc6IGZ1bmN0aW9uKG1lc3NhZ2UsIG9yaWdpbiwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50TWVzc2FnZSA9IG1lc3NhZ2U7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmbjsKICAgICAgICAgICAgICAgICAgICBwdWIuZG93bi5vdXRnb2luZyhpZEluICsgIiwiICsgKCsraWRPdXQpICsgIl8iICsgbWVzc2FnZSwgb3JpZ2luKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIGVhc3lYRE0sIHdpbmRvdywgZXNjYXBlLCB1bmVzY2FwZSwgZGVidWcsIHVuZGVmLCByZW1vdmVGcm9tU3RhY2sqLwogICAgICAgIC8vCiAgICAgICAgLy8gZWFzeVhETQogICAgICAgIC8vIGh0dHA6Ly9lYXN5eGRtLm5ldC8KICAgICAgICAvLyBDb3B5cmlnaHQoYykgMjAwOS0yMDExLCDDmHl2aW5kIFNlYW4gS2luc2V5LCBveXZpbmRAa2luc2V5Lm5vLgogICAgICAgIC8vCiAgICAgICAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogICAgICAgIC8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAgICAgICAgLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogICAgICAgIC8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICAgICAgICAvLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICAgICAgICAvLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgogICAgICAgIC8vCiAgICAgICAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICAgICAgICAvLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAgICAgICAvLwogICAgICAgIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAgICAgICAgLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAgICAgICAgLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAgICAgICAgLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogICAgICAgIC8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAgICAgICAgLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogICAgICAgIC8vIFRIRSBTT0ZUV0FSRS4KICAgICAgICAvLwoKICAgICAgICAvKioKICAgICAgICAgKiBAY2xhc3MgZWFzeVhETS5zdGFjay5RdWV1ZUJlaGF2aW9yCiAgICAgICAgICogVGhpcyBpcyBhIGJlaGF2aW9yIHRoYXQgZW5hYmxlcyBxdWV1ZWluZyBvZiBtZXNzYWdlcy4gPGJyLz4KICAgICAgICAgKiBJdCB3aWxsIGJ1ZmZlciBpbmNvbWluZyBtZXNzYWdlcyBhbmQgZGlzcGFjaCB0aGVzZSBhcyBmYXN0IGFzIHRoZSB1bmRlcmx5aW5nIHRyYW5zcG9ydCBhbGxvd3MuCiAgICAgICAgICogVGhpcyB3aWxsIGFsc28gZnJhZ21lbnQvZGVmcmFnbWVudCBtZXNzYWdlcyBzbyB0aGF0IHRoZSBvdXRnb2luZyBtZXNzYWdlIGlzIG5ldmVyIGJpZ2dlciB0aGFuIHRoZQogICAgICAgICAqIHNldCBsZW5ndGguCiAgICAgICAgICogQG5hbWVzcGFjZSBlYXN5WERNLnN0YWNrCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgYmVoYXZpb3JzIGNvbmZpZ3VyYXRpb24uIE9wdGlvbmFsLgogICAgICAgICAqIEBjZmcge051bWJlcn0gbWF4TGVuZ3RoIFRoZSBtYXhpbXVtIGxlbmd0aCBvZiBlYWNoIG91dGdvaW5nIG1lc3NhZ2UuIFNldCB0aGlzIHRvIGVuYWJsZSBmcmFnbWVudGF0aW9uLgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uc3RhY2suUXVldWVCZWhhdmlvciA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICB2YXIgcHViLCBxdWV1ZSA9IFtdLAogICAgICAgICAgICAgICAgd2FpdGluZyA9IHRydWUsCiAgICAgICAgICAgICAgICBpbmNvbWluZyA9ICIiLAogICAgICAgICAgICAgICAgZGVzdHJveWluZywgbWF4TGVuZ3RoID0gMCwKICAgICAgICAgICAgICAgIGxhenkgPSBmYWxzZSwKICAgICAgICAgICAgICAgIGRvRnJhZ21lbnQgPSBmYWxzZTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoKCkgewogICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5yZW1vdmUgJiYgcXVldWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlRnJvbVN0YWNrKHB1Yik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdhaXRpbmcgfHwgcXVldWUubGVuZ3RoID09PSAwIHx8IGRlc3Ryb3lpbmcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3YWl0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0gcXVldWUuc2hpZnQoKTsKCiAgICAgICAgICAgICAgICBwdWIuZG93bi5vdXRnb2luZyhtZXNzYWdlLmRhdGEsIG1lc3NhZ2Uub3JpZ2luLCBmdW5jdGlvbihzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgd2FpdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmNhbGxiYWNrKHN1Y2Nlc3MpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAocHViID0gewogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVuZGVmKGNvbmZpZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnID0ge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcubWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1heExlbmd0aCA9IGNvbmZpZy5tYXhMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvRnJhZ21lbnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLmxhenkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGF6eSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHViLmRvd24uaW5pdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24oc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIHdhaXRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB2YXIgdXAgPSBwdWIudXA7IC8vIGluIGNhc2UgZGlzcGF0Y2ggY2FsbHMgcmVtb3ZlRnJvbVN0YWNrCiAgICAgICAgICAgICAgICAgICAgZGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgICAgICB1cC5jYWxsYmFjayhzdWNjZXNzKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbmNvbWluZzogZnVuY3Rpb24obWVzc2FnZSwgb3JpZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvRnJhZ21lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4T2YgPSBtZXNzYWdlLmluZGV4T2YoIl8iKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcSA9IHBhcnNlSW50KG1lc3NhZ2Uuc3Vic3RyaW5nKDAsIGluZGV4T2YpLCAxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluY29taW5nICs9IG1lc3NhZ2Uuc3Vic3RyaW5nKGluZGV4T2YgKyAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlcSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5lbmNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNvbWluZyA9IGRlY29kZVVSSUNvbXBvbmVudChpbmNvbWluZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWIudXAuaW5jb21pbmcoaW5jb21pbmcsIG9yaWdpbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNvbWluZyA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmluY29taW5nKG1lc3NhZ2UsIG9yaWdpbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG91dGdvaW5nOiBmdW5jdGlvbihtZXNzYWdlLCBvcmlnaW4sIGZuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5lbmNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IGVuY29kZVVSSUNvbXBvbmVudChtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIGZyYWdtZW50cyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBmcmFnbWVudDsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9GcmFnbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBmcmFnbWVudCBpbnRvIGNodW5rcwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobWVzc2FnZS5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gbWVzc2FnZS5zdWJzdHJpbmcoMCwgbWF4TGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlLnN1YnN0cmluZyhmcmFnbWVudC5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhZ21lbnRzLnB1c2goZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVucXVldWUgdGhlIGNodW5rcwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKGZyYWdtZW50ID0gZnJhZ21lbnRzLnNoaWZ0KCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBmcmFnbWVudHMubGVuZ3RoICsgIl8iICsgZnJhZ21lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luOiBvcmlnaW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IGZyYWdtZW50cy5sZW5ndGggPT09IDAgPyBmbiA6IG51bGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcXVldWUucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBtZXNzYWdlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luOiBvcmlnaW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogZm4KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChsYXp5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi5kb3duLmluaXQoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBkaXNwYXRjaCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0cm95aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBwdWIuZG93bi5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgLypqc2xpbnQgZXZpbDogdHJ1ZSwgYnJvd3NlcjogdHJ1ZSwgaW1tZWQ6IHRydWUsIHBhc3NmYWlsOiB0cnVlLCB1bmRlZjogdHJ1ZSwgbmV3Y2FwOiB0cnVlKi8KICAgICAgICAvKmdsb2JhbCBlYXN5WERNLCB3aW5kb3csIGVzY2FwZSwgdW5lc2NhcGUsIHVuZGVmLCBkZWJ1ZyAqLwogICAgICAgIC8vCiAgICAgICAgLy8gZWFzeVhETQogICAgICAgIC8vIGh0dHA6Ly9lYXN5eGRtLm5ldC8KICAgICAgICAvLyBDb3B5cmlnaHQoYykgMjAwOS0yMDExLCDDmHl2aW5kIFNlYW4gS2luc2V5LCBveXZpbmRAa2luc2V5Lm5vLgogICAgICAgIC8vCiAgICAgICAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogICAgICAgIC8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAgICAgICAgLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogICAgICAgIC8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICAgICAgICAvLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICAgICAgICAvLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgogICAgICAgIC8vCiAgICAgICAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICAgICAgICAvLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAgICAgICAvLwogICAgICAgIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAgICAgICAgLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAgICAgICAgLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAgICAgICAgLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogICAgICAgIC8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAgICAgICAgLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogICAgICAgIC8vIFRIRSBTT0ZUV0FSRS4KICAgICAgICAvLwoKICAgICAgICAvKioKICAgICAgICAgKiBAY2xhc3MgZWFzeVhETS5zdGFjay5WZXJpZnlCZWhhdmlvcgogICAgICAgICAqIFRoaXMgYmVoYXZpb3Igd2lsbCB2ZXJpZnkgdGhhdCBjb21tdW5pY2F0aW9uIHdpdGggdGhlIHJlbW90ZSBlbmQgaXMgcG9zc2libGUsIGFuZCB3aWxsIGFsc28gc2lnbiBhbGwgb3V0Z29pbmcsCiAgICAgICAgICogYW5kIHZlcmlmeSBhbGwgaW5jb21pbmcgbWVzc2FnZXMuIFRoaXMgcmVtb3ZlcyB0aGUgcmlzayBvZiBzb21lb25lIGhpamFja2luZyB0aGUgaWZyYW1lIHRvIHNlbmQgbWFsaWNpb3VzIG1lc3NhZ2VzLgogICAgICAgICAqIEBuYW1lc3BhY2UgZWFzeVhETS5zdGFjawogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGJlaGF2aW9ycyBjb25maWd1cmF0aW9uLgogICAgICAgICAqIEBjZmcge0Jvb2xlYW59IGluaXRpYXRlIElmIHRoZSB2ZXJpZmljYXRpb24gc2hvdWxkIGJlIGluaXRpYXRlZCBmcm9tIHRoaXMgZW5kLgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uc3RhY2suVmVyaWZ5QmVoYXZpb3IgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAgICAgdmFyIHB1YiwgbXlTZWNyZXQsIHRoZWlyU2VjcmV0LCB2ZXJpZmllZCA9IGZhbHNlOwoKICAgICAgICAgICAgZnVuY3Rpb24gc3RhcnRWZXJpZmljYXRpb24oKSB7CiAgICAgICAgICAgICAgICBteVNlY3JldCA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygyKTsKICAgICAgICAgICAgICAgIHB1Yi5kb3duLm91dGdvaW5nKG15U2VjcmV0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIChwdWIgPSB7CiAgICAgICAgICAgICAgICBpbmNvbWluZzogZnVuY3Rpb24obWVzc2FnZSwgb3JpZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4T2YgPSBtZXNzYWdlLmluZGV4T2YoIl8iKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXhPZiA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UgPT09IG15U2VjcmV0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWIudXAuY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoZWlyU2VjcmV0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVpclNlY3JldCA9IG1lc3NhZ2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5pbml0aWF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0VmVyaWZpY2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWIuZG93bi5vdXRnb2luZyhtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLnN1YnN0cmluZygwLCBpbmRleE9mKSA9PT0gdGhlaXJTZWNyZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5pbmNvbWluZyhtZXNzYWdlLnN1YnN0cmluZyhpbmRleE9mICsgMSksIG9yaWdpbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb3V0Z29pbmc6IGZ1bmN0aW9uKG1lc3NhZ2UsIG9yaWdpbiwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBwdWIuZG93bi5vdXRnb2luZyhteVNlY3JldCArICJfIiArIG1lc3NhZ2UsIG9yaWdpbiwgZm4pOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5pbml0aWF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydFZlcmlmaWNhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIGVhc3lYRE0sIHdpbmRvdywgZXNjYXBlLCB1bmVzY2FwZSwgdW5kZWYsIGdldEpTT04sIGRlYnVnLCBlbXB0eUZuLCBpc0FycmF5ICovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLnN0YWNrLlJwY0JlaGF2aW9yCiAgICAgICAgICogVGhpcyB1c2VzIEpTT04tUlBDIDIuMCB0byBleHBvc2UgbG9jYWwgbWV0aG9kcyBhbmQgdG8gaW52b2tlIHJlbW90ZSBtZXRob2RzIGFuZCBoYXZlIHJlc3BvbnNlcyByZXR1cm5lZCBvdmVyIHRoZSB0aGUgc3RyaW5nIGJhc2VkIHRyYW5zcG9ydCBzdGFjay48YnIvPgogICAgICAgICAqIEV4cG9zZWQgbWV0aG9kcyBjYW4gcmV0dXJuIHZhbHVlcyBzeW5jaHJvbm91cywgYXN5bmNyb25vdXMsIG9yIGJldCBzZXQgdXAgdG8gbm90IHJldHVybiBhbnl0aGluZy4KICAgICAgICAgKiBAbmFtZXNwYWNlIGVhc3lYRE0uc3RhY2sKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcHJveHkgVGhlIG9iamVjdCB0byBhcHBseSB0aGUgbWV0aG9kcyB0by4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBkZWZpbml0aW9uIG9mIHRoZSBsb2NhbCBhbmQgcmVtb3RlIGludGVyZmFjZSB0byBpbXBsZW1lbnQuCiAgICAgICAgICogQGNmZyB7T2JqZWN0fSBsb2NhbCBUaGUgbG9jYWwgaW50ZXJmYWNlIHRvIGV4cG9zZS4KICAgICAgICAgKiBAY2ZnIHtPYmplY3R9IHJlbW90ZSBUaGUgcmVtb3RlIG1ldGhvZHMgdG8gZXhwb3NlIHRocm91Z2ggdGhlIHByb3h5LgogICAgICAgICAqIEBjZmcge09iamVjdH0gc2VyaWFsaXplciBUaGUgc2VyaWFsaXplciB0byB1c2UgZm9yIHNlcmlhbGl6aW5nIGFuZCBkZXNlcmlhbGl6aW5nIHRoZSBKU09OLiBTaG91bGQgYmUgY29tcGF0aWJsZSB3aXRoIHRoZSBIVE1MNSBKU09OIG9iamVjdC4gT3B0aW9uYWwsIHdpbGwgZGVmYXVsdCB0byBKU09OLgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uc3RhY2suUnBjQmVoYXZpb3IgPSBmdW5jdGlvbihwcm94eSwgY29uZmlnKSB7CiAgICAgICAgICAgIHZhciBwdWIsIHNlcmlhbGl6ZXIgPSBjb25maWcuc2VyaWFsaXplciB8fCBnZXRKU09OKCk7CiAgICAgICAgICAgIHZhciBfY2FsbGJhY2tDb3VudGVyID0gMCwKICAgICAgICAgICAgICAgIF9jYWxsYmFja3MgPSB7fTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBTZXJpYWxpemVzIGFuZCBzZW5kcyB0aGUgbWVzc2FnZQogICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgSlNPTi1SUEMgbWVzc2FnZSB0byBiZSBzZW50LiBUaGUganNvbnJwYyBwcm9wZXJ0eSB3aWxsIGJlIGFkZGVkLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gX3NlbmQoZGF0YSkgewogICAgICAgICAgICAgICAgZGF0YS5qc29ucnBjID0gIjIuMCI7CiAgICAgICAgICAgICAgICBwdWIuZG93bi5vdXRnb2luZyhzZXJpYWxpemVyLnN0cmluZ2lmeShkYXRhKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGVzIGEgbWV0aG9kIHRoYXQgaW1wbGVtZW50cyB0aGUgZ2l2ZW4gZGVmaW5pdGlvbgogICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gVGhlIG1ldGhvZCBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgVGhlIG5hbWUgb2YgdGhlIG1ldGhvZAogICAgICAgICAgICAgKiBAcmV0dXJuIHtGdW5jdGlvbn0gQSBzdHViIGNhcGFibGUgb2YgcHJveHlpbmcgdGhlIHJlcXVlc3RlZCBtZXRob2QgY2FsbAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gX2NyZWF0ZU1ldGhvZChkZWZpbml0aW9uLCBtZXRob2QpIHsKICAgICAgICAgICAgICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGwgPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaywgbWVzc2FnZSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGlmIChsID4gMCAmJiB0eXBlb2YgYXJndW1lbnRzW2wgLSAxXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAvL3dpdGggY2FsbGJhY2ssIHByb2NlZHVyZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobCA+IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1tsIC0gMl0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHR3byBjYWxsYmFja3MsIHN1Y2Nlc3MgYW5kIGVycm9yCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBhcmd1bWVudHNbbCAtIDJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBhcmd1bWVudHNbbCAtIDFdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5wYXJhbXMgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMCwgbCAtIDIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2luZ2xlIGNhbGxiYWNrLCBzdWNjZXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBhcmd1bWVudHNbbCAtIDFdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5wYXJhbXMgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMCwgbCAtIDEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYWxsYmFja3NbIiIgKyAoKytfY2FsbGJhY2tDb3VudGVyKV0gPSBjYWxsYmFjazsKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5pZCA9IF9jYWxsYmFja0NvdW50ZXI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm8gY2FsbGJhY2tzLCBhIG5vdGlmaWNhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnBhcmFtcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlZmluaXRpb24ubmFtZWRQYXJhbXMgJiYgbWVzc2FnZS5wYXJhbXMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UucGFyYW1zID0gbWVzc2FnZS5wYXJhbXNbMF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIFNlbmQgdGhlIG1ldGhvZCByZXF1ZXN0CiAgICAgICAgICAgICAgICAgICAgX3NlbmQobWVzc2FnZSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRXhlY3V0ZXMgdGhlIGV4cG9zZWQgbWV0aG9kCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgVGhlIG5hbWUgb2YgdGhlIG1ldGhvZAogICAgICAgICAgICAgKiBAcGFyYW0ge051bWJlcn0gaWQgVGhlIGNhbGxiYWNrIGlkIHRvIHVzZQogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBtZXRob2QgVGhlIGV4cG9zZWQgaW1wbGVtZW50YXRpb24KICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheX0gcGFyYW1zIFRoZSBwYXJhbWV0ZXJzIHN1cHBsaWVkIGJ5IHRoZSByZW1vdGUgZW5kCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiBfZXhlY3V0ZU1ldGhvZChtZXRob2QsIGlkLCBmbiwgcGFyYW1zKSB7CiAgICAgICAgICAgICAgICBpZiAoIWZuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9zZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogLTMyNjAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICJQcm9jZWR1cmUgbm90IGZvdW5kLiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgc3VjY2VzcywgZXJyb3I7CiAgICAgICAgICAgICAgICBpZiAoaWQpIHsKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBlbXB0eUZuOwogICAgICAgICAgICAgICAgICAgICAgICBfc2VuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IHJlc3VsdAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGVycm9yID0gZnVuY3Rpb24obWVzc2FnZSwgZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvciA9IGVtcHR5Rm47CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IC0zMjA5OSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2cuZXJyb3IuZGF0YSA9IGRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgX3NlbmQobXNnKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gZXJyb3IgPSBlbXB0eUZuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gQ2FsbCBsb2NhbCBtZXRob2QKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShwYXJhbXMpKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyYW1zID0gW3BhcmFtc107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBmbi5tZXRob2QuYXBwbHkoZm4uc2NvcGUsIHBhcmFtcy5jb25jYXQoW3N1Y2Nlc3MsIGVycm9yXSkpOwogICAgICAgICAgICAgICAgICAgIGlmICghdW5kZWYocmVzdWx0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzKHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgxKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoZXgxLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gKHB1YiA9IHsKICAgICAgICAgICAgICAgIGluY29taW5nOiBmdW5jdGlvbihtZXNzYWdlLCBvcmlnaW4pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IHNlcmlhbGl6ZXIucGFyc2UobWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEubWV0aG9kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEEgbWV0aG9kIGNhbGwgZnJvbSB0aGUgcmVtb3RlIGVuZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLmhhbmRsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmhhbmRsZShkYXRhLCBfc2VuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZXhlY3V0ZU1ldGhvZChkYXRhLm1ldGhvZCwgZGF0YS5pZCwgY29uZmlnLmxvY2FsW2RhdGEubWV0aG9kXSwgZGF0YS5wYXJhbXMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQSBtZXRob2QgcmVzcG9uc2UgZnJvbSB0aGUgb3RoZXIgZW5kCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IF9jYWxsYmFja3NbZGF0YS5pZF07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLmVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2suZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5lcnJvcihkYXRhLmVycm9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjYWxsYmFjay5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5zdWNjZXNzKGRhdGEucmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgX2NhbGxiYWNrc1tkYXRhLmlkXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5yZW1vdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW1wbGVtZW50IHRoZSByZW1vdGUgc2lkZXMgZXhwb3NlZCBtZXRob2RzCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG1ldGhvZCBpbiBjb25maWcucmVtb3RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLnJlbW90ZS5oYXNPd25Qcm9wZXJ0eShtZXRob2QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJveHlbbWV0aG9kXSA9IF9jcmVhdGVNZXRob2QoY29uZmlnLnJlbW90ZVttZXRob2RdLCBtZXRob2QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHB1Yi5kb3duLmluaXQoKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBtZXRob2QgaW4gY29uZmlnLnJlbW90ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLnJlbW90ZS5oYXNPd25Qcm9wZXJ0eShtZXRob2QpICYmIHByb3h5Lmhhc093blByb3BlcnR5KG1ldGhvZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwcm94eVttZXRob2RdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHB1Yi5kb3duLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICB3aW5kb3cuZWFzeVhETSA9IGVhc3lYRE07CgogICAgICAgIC8vcmV0dXJuaW5nIHRoZSBtb2R1bGUgaW5zdGFuY2UKICAgICAgICByZXR1cm4gZWFzeVhETTsKCiAgICAvL30pKHdpbmRvdywgZG9jdW1lbnQsIGxvY2F0aW9uLCB3aW5kb3cuc2V0VGltZW91dCwgZGVjb2RlVVJJQ29tcG9uZW50LCBlbmNvZGVVUklDb21wb25lbnQpOwoKfSk7Ci8qKgogKiBqcXVlcnkuY29ycwogKgogKiBJbXBsZW1lbnRzIENPUlMgZnVuY3Rpb25hbGl0eSBmb3IgYnJvd3NlcnMgc3VwcG9ydGluZyBpdCBuYXRpdmVseSB3aXRoIGFuIGF1dG9tYXRpYwogKiBmYWxsYmFjayB0byBlYXN5WERNIHdoaWNoIGltcGxlbWVudHMgY29ycyB2aWEgYW4gZW1iZWRkZWQgaWZyYW1lIG9yIHN3Zi4gVG8gdXNlIGl0LAogKiB5b3UgbXVzdCBkbyB0d28gdGhpbmdzOgogKgogKiAxLiBJbmNsdWRlIHRoZSBqcXVlcnkgcGx1Z2luIGFuZCB1c2UganF1ZXJ5LmFqYXggY2FsbHMgYXMgdXN1YWwuCiAqIDIuIE1ha2UganF1ZXJ5LmNvcnMgYXZhaWxhYmxlIHZpYSByZXF1aXJlLmpzOgogKiBzaGltOiB7CiAqICAgJ2pxdWVyeS5jb3JzL2Vhc3l4ZG0vZWFzeXhkbSc6IHsgZXhwb3J0czogJ2Vhc3lYRE0nIH0sCiAqIH0KICogcGF0aHM6IHsKICogICAnanF1ZXJ5LmNvcnMnOiAgICAgICAgICAnbGliL2pxdWVyeS5jb3JzLzAuMScsICAgLy8gc2hpbSBhbGwgcGF0aHMKICogfQogKiAzLiBBZGp1c3QganF1ZXJ5X2NvcnNfcGF0aCB0byBtYXRjaCB0aGUgbG9jYXRpb24gd2hlcmUganF1ZXJ5LmVhc3l4ZG0ucHJvdmlkZXIuanMKICogNC4gQWRqdXN0IGpxdWVyeS5lYXN5eGRtLnByb3ZpZGVyLmpzIHRvIGFsbG93IGNhbGxzIGZyb20gdGhlIGRvbWFpbnMgbmVlZGluZyBDT1JTCiAqIDUuIEFkanVzdCBzZXJ2ZXIgdG8gYXBwbHkgQ09SUyBoZWFkZXJzIGZvciBkb21haW5zIHRoYXQgc2hvdWxkIGJlIGFibGUgdG8uIEZvcgogKiAgICBBbGxvdy1DcmVkZW50aWFscyB0byB3b3JrIHByb3Blcmx5LCB0aGUgc2VydmVyIG11c3QgZHluYW1pY2FsbHkgc2V0IHRoZSBBbGxvdy1PcmlnaW4KICogICAgdG8gbWF0Y2ggdGhlIE9yaWdpbjogZnJvbSB0aGUgcmVxdWVzdCwgeW91IGNhbm5vdCBzaW1wbHkgdXNlICoKICoKICogICAgQWNjZXNzLUNvbnRyb2wtQWxsb3ctQ3JlZGVudGlhbHM6IHRydWUKICogICAgQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luOiBodHRwczovL2xvY2FsaG9zdDoyNDQzCiAqICAgIEFjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHM6IEdFVCwgUE9TVCwgUFVULCBQQVRDSCwgREVMRVRFLCBPUFRJT05TCiAqICAgIEFjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnM6IHgtcmVxdWVzdGVkLXdpdGgsIGNvbnRlbnQtdHlwZSwgYWNjZXB0LCBvcmlnaW4sIGF1dGhvcml6YXRpb24KICoKICovCgpkZWZpbmUoJ2pxdWVyeS5jb3JzL2pxdWVyeS5jb3JzJyxbJ3JlcXVpcmUnLCd1bmRlcnNjb3JlJywnanF1ZXJ5JywnanNvbjInLCdjb25zb2xlLXNoaW0nLCdqcXVlcnkuY29ycy9lYXN5eGRtL2Vhc3l4ZG0nXSxmdW5jdGlvbiAocmVxdWlyZSkgewogICAgCiAgICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKICAgICAgICAkID0gcmVxdWlyZSgnanF1ZXJ5JyksCiAgICAgICAgSlNPTiA9IHJlcXVpcmUoJ2pzb24yJyksCiAgICAgICAgY29uc29sZSA9IHJlcXVpcmUoJ2NvbnNvbGUtc2hpbScpLAogICAgICAgIGVhc3lYRE0gPSByZXF1aXJlKCdqcXVlcnkuY29ycy9lYXN5eGRtL2Vhc3l4ZG0nKSwKICAgICAgICBqcXVlcnlfY29yc19wYXRoID0gJy9zdGF0aWMtb3B0aW1pemVkL2pzL2xpYi9qcXVlcnkuY29ycy8wLjEvJywKICAgICAgICBlYXN5WERNX3BhdGggPSBqcXVlcnlfY29yc19wYXRoICsgJy9lYXN5eGRtLycsCiAgICAgICAgZWFzeVhETV9jb25uZWN0aW9ucyA9IHt9LAogICAgICAgIGpxdWVyeV9jb3JzID0ge307CiAgICAgICAgLy8gJC5zdXBwb3J0LmNvcnMgPSBmYWxzZTsKCiAgICAvKioKICAgICAqIENvbmZpZ3VyZSBqUXVlcnkgZm9yIENyb3NzRG9tYWluIENPUlMgcmVxdWVzdHMKICAgICAqLwogICAgJC5hamF4U2V0dXAoewogICAgICAgIHhockZpZWxkczogewogICAgICAgICAgICB3aXRoQ3JlZGVudGlhbHM6IHRydWUKICAgICAgICB9CiAgICB9KTsKICAgIC8vY29uc29sZS5sb2coJ3VzaW5nIGpxdWVyeSBjb3JzJyk7CiAgICAvKioKICAgICAqIHJlZ2lzdGVyIGEgY3VzdG9tIGFqYXhUcmFuc3BvcnQsIHBlcgogICAgICogaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS5hamF4VHJhbnNwb3J0LwogICAgICovCiAgICAgJC5hamF4VHJhbnNwb3J0KCIrKiIsIGZ1bmN0aW9uIChvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSKSB7CgogICAgICAgIC8vIFVuY29tbWVudCB0aGVzZSB0d28gbGluZXMgaWYgd2FudCB0byB0ZXN0IGVhc3lYRE0KICAgICAgICAvLyAkLnN1cHBvcnQuY29ycyA9IGZhbHNlOwogICAgICAgIC8vIG9wdGlvbnMuY3Jvc3NEb21haW4gPSB0cnVlOwoKICAgICAgICBpZiAob3B0aW9ucy5jcm9zc0RvbWFpbiAmJiAhJC5zdXBwb3J0LmNvcnMpIHsKICAgICAgICAgICAgdmFyIHByb3ZpZGVyX2Jhc2VfdXJsID0gIiIsCiAgICAgICAgICAgICAgICByZWdleHBfcmVzdWx0cyA9IG9wdGlvbnMudXJsLm1hdGNoKC9eKGh0dHBzPzpcL1wvW15cL10qKVwvPy4qLyk7CiAgICAgICAgICAgIGlmIChyZWdleHBfcmVzdWx0cykgewogICAgICAgICAgICAgICAgcHJvdmlkZXJfYmFzZV91cmwgPSByZWdleHBfcmVzdWx0c1sxXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFlYXN5WERNX2Nvbm5lY3Rpb25zLmhhc093blByb3BlcnR5KHByb3ZpZGVyX2Jhc2VfdXJsKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2NyZWF0aW5nIGVhc3lYRE0gcG9vbCBlbnRyeSBmb3IgJyArIHByb3ZpZGVyX2Jhc2VfdXJsKTsKICAgICAgICAgICAgICAgIGVhc3lYRE1fY29ubmVjdGlvbnNbcHJvdmlkZXJfYmFzZV91cmxdID0gewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrUXVldWU6IFtdLAogICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb246IHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogdW5kZWZpbmVkLAogICAgICAgICAgICAgICAgICAgIHN0YXRlOiAiYmVmb3JlIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdqcXVlcnkuY29ycyBlYXN5WERNIHJlcXVlc3QgZm9yICcgKyBvcHRpb25zLnVybCArICcgdXNpbmcgJyArIHByb3ZpZGVyX2Jhc2VfdXJsKTsKCiAgICAgICAgICAgIHJldHVybiBwcm92aWRlcl9iYXNlX3VybCA9PT0gIiIgPyBudWxsIDogewogICAgICAgICAgICAgICAgc2VuZDogZnVuY3Rpb24gKGhlYWRlcnMsIGNvbXBsZXRlQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBqcXVlcnlfY29ycy5nZXRDb25uZWN0aW9uKHByb3ZpZGVyX2Jhc2VfdXJsLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogZnVuY3Rpb24gKGVhc3lYRE1fY29ubmVjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gY29udGludWF0aW9uX3Byb3h5KHJlc3VsdHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZWFzeVhETSBjb25uZWN0aW9uIGZvciAnICsgb3B0aW9ucy51cmwgKyAnIHZpYSAnICsgcHJvdmlkZXJfYmFzZV91cmwgKyAnIGNvbnRpbnVhdGlvbiBwcm94eSBleGNlY3V0aW5nJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZUNhbGxiYWNrKHJlc3VsdHMuc3RhdHVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnN0YXR1c1RleHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucmVzcG9uc2VzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLmhlYWRlcnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsT3B0aW9ucy5jb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE1fY29ubmVjdGlvbi5qcXVlcnlfcHJveHkob3JpZ2luYWxPcHRpb25zLCBjb250aW51YXRpb25fcHJveHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vhc3lYRE0gY29ubmVjdGlvbiBmb3IgJyArIG9wdGlvbnMudXJsICsgJyB2aWEgJyArIHByb3ZpZGVyX2Jhc2VfdXJsICsgJyBpbml0aWFsaXplZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICdlcnJvcic6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlYXN5WERNIGNvbm5lY3Rpb24gZm9yICcgKyBwcm92aWRlcl9iYXNlX3VybCArICcgZmFpbGVkIHRvIGluaXRpYWxpemUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICdhYm9ydCc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZWFzeVhETSBjb25uZWN0aW9uIGZvciAnICsgcHJvdmlkZXJfYmFzZV91cmwgKyAnIGFib3J0ZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KTsKCiAgICBqcXVlcnlfY29ycy5kb1JlcXVlc3RzID0gZnVuY3Rpb24gKHByb3ZpZGVyX2Jhc2VfdXJsLCBjYWxsYmFja3MpIHsKICAgICAgICB2YXIgc2NvcGVkX2Vhc3lYRE0gPSBlYXN5WERNLm5vQ29uZmxpY3QoImpxdWVyeV9lYXN5WERNIiArIHByb3ZpZGVyX2Jhc2VfdXJsKSwKICAgICAgICAgICAgcmVtb3RlX3VybCA9IHByb3ZpZGVyX2Jhc2VfdXJsICsganF1ZXJ5X2NvcnNfcGF0aCArICJqcXVlcnkuZWFzeXhkbS5wcm92aWRlci5odG1sIjsKCiAgICAgICAgY29uc29sZS5sb2coJ2RvUmVxdWVzdHMgZm9yICcgKyBwcm92aWRlcl9iYXNlX3VybCk7CgogICAgICAgIGpxdWVyeV9jb3JzLmVhc3lYRE0gPSBzY29wZWRfZWFzeVhETTsKICAgICAgICBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY29ubmVjdGlvbiddID0gbmV3IGpxdWVyeV9jb3JzLmVhc3lYRE0uUnBjKAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGFubmVsOiBwcm92aWRlcl9iYXNlX3VybCwKICAgICAgICAgICAgICAgIHJlbW90ZTogcmVtb3RlX3VybCwKICAgICAgICAgICAgICAgIHN3ZjogcHJvdmlkZXJfYmFzZV91cmwgKyBlYXN5WERNX3BhdGggKyAiZWFzeXhkbS5zd2YiLAogICAgICAgICAgICAgICAgb25SZWFkeTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGVhc3lYRE1fY29ubmVjdGlvbnNbcHJvdmlkZXJfYmFzZV91cmxdWydjb25uZWN0aW9uJ10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB7IHJlbW90ZTogeyBqcXVlcnlfcHJveHk6IGZ1bmN0aW9uKCkgeyBjb25zb2xlLmxvZygnanF1ZXJ5X3Byb3h5Jyk7IH19fQogICAgICAgICk7CiAgICB9OwoKICAgIGpxdWVyeV9jb3JzLmdldENvbm5lY3Rpb24gPSBmdW5jdGlvbiAocHJvdmlkZXJfYmFzZV91cmwsIGNhbGxiYWNrcykgewogICAgICAgIHZhciBpOwoKICAgICAgICBzd2l0Y2ggKGVhc3lYRE1fY29ubmVjdGlvbnNbcHJvdmlkZXJfYmFzZV91cmxdWydzdGF0ZSddKSB7CiAgICAgICAgICAgIGNhc2UgImJlZm9yZSI6CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnYmVmb3JlOiAnICsgcHJvdmlkZXJfYmFzZV91cmwpOwogICAgICAgICAgICAgICAgZWFzeVhETV9jb25uZWN0aW9uc1twcm92aWRlcl9iYXNlX3VybF1bJ3N0YXRlJ10gPSAid29ya2luZyI7CiAgICAgICAgICAgICAgICBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY2FsbGJhY2tRdWV1ZSddLnB1c2goY2FsbGJhY2tzKTsKICAgICAgICAgICAgICAgIGpxdWVyeV9jb3JzLmRvUmVxdWVzdHMocHJvdmlkZXJfYmFzZV91cmwsewogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogZnVuY3Rpb24gKHNpbmdsZXRvbkluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdkb1JlcXVlc3RzLnN1Y2Nlc3MgZm9yICcgKyBwcm92aWRlcl9iYXNlX3VybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE1fY29ubmVjdGlvbnNbcHJvdmlkZXJfYmFzZV91cmxdWydzdGF0ZSddID0gInN1Y2Nlc3MiOwogICAgICAgICAgICAgICAgICAgICAgICBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY29ubmVjdGlvbiddID0gc2luZ2xldG9uSW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY2FsbGJhY2tRdWV1ZSddLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY2FsbGJhY2tRdWV1ZSddW2ldLnN1Y2Nlc3MoZWFzeVhETV9jb25uZWN0aW9uc1twcm92aWRlcl9iYXNlX3VybF1bJ2Nvbm5lY3Rpb24nXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWFzeVhETV9jb25uZWN0aW9uc1twcm92aWRlcl9iYXNlX3VybF1bJ2NhbGxiYWNrUXVldWUnXSA9IFtdOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgJ2ZhaWx1cmUnOiBmdW5jdGlvbiAoZXJyb3JPYmopIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2RvUmVxdWVzdHMuZmFpbHVyZSBmb3IgJyArIHByb3ZpZGVyX2Jhc2VfdXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWFzeVhETV9jb25uZWN0aW9uc1twcm92aWRlcl9iYXNlX3VybF1bJ3N0YXRlJ10gPSAiZmFpbHVyZSI7CiAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE1fY29ubmVjdGlvbnNbcHJvdmlkZXJfYmFzZV91cmxdWydlcnJvciddID0gZXJyb3JPYmo7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY2FsbGJhY2tRdWV1ZSddLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY2FsbGJhY2tRdWV1ZSddW2ldLmZhaWx1cmUoZXJyb3JPYmopOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE1fY29ubmVjdGlvbnNbcHJvdmlkZXJfYmFzZV91cmxdWydjYWxsYmFja1F1ZXVlJ10gPSBbXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAid29ya2luZyI6CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCd3b3JraW5nOiAnICsgcHJvdmlkZXJfYmFzZV91cmwpOwogICAgICAgICAgICBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY2FsbGJhY2tRdWV1ZSddLnB1c2goY2FsbGJhY2tzKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAic3VjY2VzcyI6CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzdWNjZXNzOiAnICsgcHJvdmlkZXJfYmFzZV91cmwpOwogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY29ubmVjdGlvbiddKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiZmFpbHVyZSI6CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdmYWlsdXJlOiAnICsgcHJvdmlkZXJfYmFzZV91cmwpOwogICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnZXJyb3InXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdpbnZhbGlkIHN0YXRlOiAnICsgcHJvdmlkZXJfYmFzZV91cmwpOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgc3RhdGU6ICIgKyBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnc3RhdGUnXSk7CiAgICAgICAgfQogICAgfTsKICAgIHdpbmRvdy4kID0gJDsKICAgIHdpbmRvdy5qcXVlcnlfY29ycyA9IGpxdWVyeV9jb3JzOwogICAgcmV0dXJuIGpxdWVyeV9jb3JzOwp9KTsKLypnbG9iYWwgZGVmaW5lLHNldFRpbWVvdXQsY2xlYXJUaW1lb3V0Ki8KZGVmaW5lKCdjaGlyb3ByYWN0b3IvbW9kZWxzL2F1dGgnLFsncmVxdWlyZScsJ2JhY2tib25lJywnanF1ZXJ5JywnanNvbi1pZTcnLCd1bmRlcnNjb3JlJywnanF1ZXJ5LmNvb2tpZSddLGZ1bmN0aW9uKHJlcXVpcmUpIHsKICAgIAoKICAgIHZhciBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyksCiAgICAgICAgJCA9IHJlcXVpcmUoJ2pxdWVyeScpLAogICAgICAgIEpTT04gPSByZXF1aXJlKCdqc29uLWllNycpLAogICAgICAgIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyksCiAgICAgICAgdG9rZW5Db29raWUgPSAnd3R0b2tlbicsCiAgICAgICAgZXhwaXJhdGlvbldhcm5pbmdNaW51dGVzID0gMiwKICAgICAgICBleHBpcmF0aW9uV2FybmluZ0FjdGl2ZSA9IGZhbHNlLAogICAgICAgIGV4cGlyYXRpb25UaW1lb3V0SWQsIGV4cGlyYXRpb25XYXJuaW5nLAogICAgICAgIGFjdGl2ZVRva2VuLCBnZXRUb2tlbiwgc2V0VG9rZW4sIGNsZWFyVG9rZW47CgogICAgcmVxdWlyZSgnanF1ZXJ5LmNvb2tpZScpOwoKICAgIGV4cGlyYXRpb25XYXJuaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgQmFja2JvbmUuRXZlbnRzLnRyaWdnZXIoJ2F1dGhlbnRpY2F0aW9uOmV4cGlyYXRpb24nKTsKICAgICAgICBleHBpcmF0aW9uV2FybmluZ0FjdGl2ZSA9IHRydWU7CgogICAgICAgIGV4cGlyYXRpb25UaW1lb3V0SWQgPSBzZXRUaW1lb3V0KAogICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIEJhY2tib25lLkV2ZW50cy50cmlnZ2VyKCdhdXRoZW50aWNhdGlvbjpmYWlsdXJlJyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGV4cGlyYXRpb25XYXJuaW5nTWludXRlcyAqIDYwICogMTAwMAogICAgICAgICk7CiAgICB9OwoKICAgIGdldFRva2VuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHR5cGVvZihhY3RpdmVUb2tlbikgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIGFjdGl2ZVRva2VuID0gJC5jb29raWUodG9rZW5Db29raWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYWN0aXZlVG9rZW47CiAgICB9OwoKICAgIHNldFRva2VuID0gZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICB2YXIgdG9rZW5Db21wb25lbnRzID0gdG9rZW4uc3BsaXQoJzo6JyksCiAgICAgICAgICAgIHNlcnZlclRpbWUgPSB0b2tlbkNvbXBvbmVudHNbMV0sCiAgICAgICAgICAgIGV4cGlyZVRpbWUgPSB0b2tlbkNvbXBvbmVudHNbMl0sCiAgICAgICAgICAgIC8vIFdlIHdhbnQgYW4gZXhwaXJhdGlvbiBhbGVydCB0byBoYXBwZW4gdHdvIG1pbnV0ZXMgYmVmb3JlIHRoZQogICAgICAgICAgICAvLyB0b2tlbiBpcyBnb2luZyB0byBleHBpcmUuCiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lb3V0ID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgZXhwaXJlVGltZSAtIHNlcnZlclRpbWUgLSAoZXhwaXJhdGlvbldhcm5pbmdNaW51dGVzICogNjApCiAgICAgICAgICAgICkgKiAxMDAwOwoKICAgICAgICBhY3RpdmVUb2tlbiA9IHRva2VuOwogICAgICAgICQuY29va2llKHRva2VuQ29va2llLCB0b2tlbik7CgogICAgICAgIGlmIChleHBpcmF0aW9uVGltZW91dElkKSB7CiAgICAgICAgICAgIGNsZWFyVGltZW91dChleHBpcmF0aW9uVGltZW91dElkKTsKICAgICAgICB9CgogICAgICAgIGlmIChleHBpcmF0aW9uV2FybmluZ0FjdGl2ZSkgewogICAgICAgICAgICBCYWNrYm9uZS5FdmVudHMudHJpZ2dlcignYXV0aGVudGljYXRpb246cmVuZXdhbCcpOwogICAgICAgICAgICBleHBpcmF0aW9uV2FybmluZ0FjdGl2ZSA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZXhwaXJhdGlvblRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZXhwaXJhdGlvbldhcm5pbmcsIGV4cGlyYXRpb25UaW1lb3V0KTsKICAgIH07CgogICAgY2xlYXJUb2tlbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGFjdGl2ZVRva2VuID0gdW5kZWZpbmVkOwogICAgICAgICQucmVtb3ZlQ29va2llKHRva2VuQ29va2llKTsKCiAgICAgICAgaWYgKGV4cGlyYXRpb25UaW1lb3V0SWQpIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGV4cGlyYXRpb25UaW1lb3V0SWQpOwogICAgICAgIH0KICAgIH07CgogICAgQmFja2JvbmUuRXZlbnRzLm9uKAogICAgICAgICdhdXRoZW50aWNhdGlvbjpsb2dvdXQgYXV0aGVudGljYXRpb246ZmFpbHVyZScsCiAgICAgICAgY2xlYXJUb2tlbgogICAgKTsKCiAgICByZXR1cm4gewogICAgICAgIHN5bmM6IGZ1bmN0aW9uKG1ldGhvZCwgbW9kZWwsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGJlZm9yZVNlbmQgPSBvcHRpb25zLmJlZm9yZVNlbmQsCiAgICAgICAgICAgICAgICBvbkVycm9yID0gb3B0aW9ucy5lcnJvciwKICAgICAgICAgICAgICAgIG9uU3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzcywKICAgICAgICAgICAgICAgIHNlbGYgPSB0aGlzLAogICAgICAgICAgICAgICAgb3B0cyA9IF8ob3B0aW9ucykuY2xvbmUoKTsKCiAgICAgICAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKG1vZGVsLCBkYXRhLCB4aHIpIHsKICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHhoci5nZXRSZXNwb25zZUhlYWRlcignQXV0aG9yaXphdGlvbicpOwogICAgICAgICAgICAgICAgaWYgKHRva2VuKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0VG9rZW4odG9rZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9uU3VjY2Vzcy5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGhpcyBpcyBhIGpRdWVyeSBlcnJvciBoYW5kbGVyLgogICAgICAgICAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24oeGhyLCBzdGF0dXNUZXh0LCBlcnJvcikgewogICAgICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDQwMCkgewogICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IGFkZCBsb2dpYyB0byBvbmx5IHRyaWdnZXIgdW5hdXRoZW50aWNhdGVkIGlmIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGJhZCByZXF1ZXN0IGlzIGR1ZSB0byBtYWxmb3JtZWQgdG9rZW4KICAgICAgICAgICAgICAgICAgICBCYWNrYm9uZS5FdmVudHMudHJpZ2dlcignYXV0aGVudGljYXRpb246ZmFpbHVyZScsIHNlbGYsIHhocik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PT0gNDAxKSB7CiAgICAgICAgICAgICAgICAgICAgQmFja2JvbmUuRXZlbnRzLnRyaWdnZXIoJ2F1dGhlbnRpY2F0aW9uOmZhaWx1cmUnLCBzZWxmLCB4aHIpOwoKICAgICAgICAgICAgICAgICAgICBzZWxmLmxpc3RlblRvT25jZSgKICAgICAgICAgICAgICAgICAgICAgICAgQmFja2JvbmUuRXZlbnRzLAogICAgICAgICAgICAgICAgICAgICAgICAnYXV0aGVudGljYXRpb246c3VjY2VzcycsCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zeW5jKG1ldGhvZCwgbW9kZWwsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDYWxsIHRoZSBvcmlnaW5hbCBvbkVycm9yIGhhbmRsZXIuCiAgICAgICAgICAgICAgICBpZiAob25FcnJvcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvbkVycm9yLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBvcHRpb25zLmJlZm9yZVNlbmQgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IGdldFRva2VuKCk7CiAgICAgICAgICAgICAgICBpZiAoIXNlbGYuZGlzYWJsZUF1dGhUb2tlbiAmJiB0b2tlbikgewogICAgICAgICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKAogICAgICAgICAgICAgICAgICAgICAgICAnQXV0aG9yaXphdGlvbicsCiAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYmVmb3JlU2VuZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBiZWZvcmVTZW5kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBjbGVhbnVwOiBjbGVhclRva2VuCiAgICB9Owp9KTsKCi8qKgogKiBVbmRlcnNjb3JlIG1peGlucyBmb3IgZGVlcCBvYmplY3RzCiAqCiAqIEJhc2VkIG9uIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL2VjaG9uZy8zODYxOTYzCiAqLwovLyhmdW5jdGlvbigpIHsKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCd1bmRlcnNjb3JlLm1peGluLmRlZXBleHRlbmQnLFsncmVxdWlyZScsJ3VuZGVyc2NvcmUnXSxmdW5jdGlvbiAocmVxdWlyZSkgewogIAoKICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKICAgIGFycmF5cywgYmFzaWNPYmplY3RzLCBkZWVwQ2xvbmUsIGRlZXBFeHRlbmQsIGRlZXBFeHRlbmRDb3VwbGUsIGlzQmFzaWNPYmplY3QsCiAgICBfX3NsaWNlID0gW10uc2xpY2U7CgogIGRlZXBDbG9uZSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBmdW5jLCBpc0FycjsKICAgIGlmICghXy5pc09iamVjdChvYmopIHx8IF8uaXNGdW5jdGlvbihvYmopKSB7CiAgICAgIHJldHVybiBvYmo7CiAgICB9CiAgICBpZiAob2JqIGluc3RhbmNlb2YgQmFja2JvbmUuQ29sbGVjdGlvbiB8fCBvYmogaW5zdGFuY2VvZiBCYWNrYm9uZS5Nb2RlbCkgewogICAgICByZXR1cm4gb2JqOwogICAgfQogICAgaWYgKF8uaXNEYXRlKG9iaikpIHsKICAgICAgcmV0dXJuIG5ldyBEYXRlKG9iai5nZXRUaW1lKCkpOwogICAgfQogICAgaWYgKF8uaXNSZWdFeHAob2JqKSkgewogICAgICByZXR1cm4gbmV3IFJlZ0V4cChvYmouc291cmNlLCBvYmoudG9TdHJpbmcoKS5yZXBsYWNlKC8uKlwvLywgIiIpKTsKICAgIH0KICAgIGlzQXJyID0gXy5pc0FycmF5KG9iaiB8fCBfLmlzQXJndW1lbnRzKG9iaikpOwogICAgZnVuYyA9IGZ1bmN0aW9uIChtZW1vLCB2YWx1ZSwga2V5KSB7CiAgICAgIGlmIChpc0FycikgewogICAgICAgIG1lbW8ucHVzaChkZWVwQ2xvbmUodmFsdWUpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vW2tleV0gPSBkZWVwQ2xvbmUodmFsdWUpOwogICAgICB9CiAgICAgIHJldHVybiBtZW1vOwogICAgfTsKICAgIHJldHVybiBfLnJlZHVjZShvYmosIGZ1bmMsIGlzQXJyID8gW10gOiB7fSk7CiAgfTsKCiAgaXNCYXNpY09iamVjdCA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgIGlmIChvYmplY3QgPT09IG51bGwgfHwgb2JqZWN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIChvYmplY3QucHJvdG90eXBlID09PSB7fS5wcm90b3R5cGUgfHwgb2JqZWN0LnByb3RvdHlwZSA9PT0gT2JqZWN0LnByb3RvdHlwZSkgJiYgXy5pc09iamVjdChvYmplY3QpICYmICFfLmlzQXJyYXkob2JqZWN0KSAmJiAhXy5pc0Z1bmN0aW9uKG9iamVjdCkgJiYgIV8uaXNEYXRlKG9iamVjdCkgJiYgIV8uaXNSZWdFeHAob2JqZWN0KSAmJiAhXy5pc0FyZ3VtZW50cyhvYmplY3QpOwogIH07CgogIGJhc2ljT2JqZWN0cyA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgIHJldHVybiBfLmZpbHRlcihfLmtleXMob2JqZWN0KSwgZnVuY3Rpb24gKGtleSkgewogICAgICByZXR1cm4gaXNCYXNpY09iamVjdChvYmplY3Rba2V5XSk7CiAgICB9KTsKICB9OwoKICBhcnJheXMgPSBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoXy5rZXlzKG9iamVjdCksIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgcmV0dXJuIF8uaXNBcnJheShvYmplY3Rba2V5XSk7CiAgICB9KTsKICB9OwoKICBkZWVwRXh0ZW5kQ291cGxlID0gZnVuY3Rpb24gKGRlc3RpbmF0aW9uLCBzb3VyY2UsIG1heERlcHRoKSB7CiAgICB2YXIgY29tYmluZSwgcmVjdXJzZSwgc2hhcmVkQXJyYXlLZXksIHNoYXJlZEFycmF5S2V5cywgc2hhcmVkT2JqZWN0S2V5LCBzaGFyZWRPYmplY3RLZXlzLCBfaSwgX2osIF9sZW4sIF9sZW4xOwogICAgaWYgKG1heERlcHRoID09PSBudWxsKSB7CiAgICAgIG1heERlcHRoID0gMjA7CiAgICB9CiAgICBpZiAobWF4RGVwdGggPD0gMCkgewogICAgICBjb25zb2xlLndhcm4oJ18uZGVlcEV4dGVuZCgpOiBNYXhpbXVtIGRlcHRoIG9mIHJlY3Vyc2lvbiBoaXQuJyk7CiAgICAgIHJldHVybiBfLmV4dGVuZChkZXN0aW5hdGlvbiwgc291cmNlKTsKICAgIH0KICAgIHNoYXJlZE9iamVjdEtleXMgPSBfLmludGVyc2VjdGlvbihiYXNpY09iamVjdHMoZGVzdGluYXRpb24pLCBiYXNpY09iamVjdHMoc291cmNlKSk7CiAgICByZWN1cnNlID0gZnVuY3Rpb24gKGtleSkgewogICAgICBzb3VyY2Vba2V5XSA9IGRlZXBFeHRlbmRDb3VwbGUoZGVzdGluYXRpb25ba2V5XSwgc291cmNlW2tleV0sIG1heERlcHRoIC0gMSk7CiAgICAgIHJldHVybiBzb3VyY2Vba2V5XTsKICAgIH07CiAgICBmb3IgKF9pID0gMCwgX2xlbiA9IHNoYXJlZE9iamVjdEtleXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pICs9IDEpIHsKICAgICAgc2hhcmVkT2JqZWN0S2V5ID0gc2hhcmVkT2JqZWN0S2V5c1tfaV07CiAgICAgIHJlY3Vyc2Uoc2hhcmVkT2JqZWN0S2V5KTsKICAgIH0KICAgIHNoYXJlZEFycmF5S2V5cyA9IF8uaW50ZXJzZWN0aW9uKGFycmF5cyhkZXN0aW5hdGlvbiksIGFycmF5cyhzb3VyY2UpKTsKICAgIGNvbWJpbmUgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHNvdXJjZVtrZXldID0gXy51bmlvbihkZXN0aW5hdGlvbltrZXldLCBzb3VyY2Vba2V5XSk7CiAgICAgIHJldHVybiBzb3VyY2Vba2V5XTsKICAgIH07CiAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBzaGFyZWRBcnJheUtleXMubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaiArPSAxKSB7CiAgICAgIHNoYXJlZEFycmF5S2V5ID0gc2hhcmVkQXJyYXlLZXlzW19qXTsKICAgICAgY29tYmluZShzaGFyZWRBcnJheUtleSk7CiAgICB9CiAgICByZXR1cm4gXy5leHRlbmQoZGVzdGluYXRpb24sIHNvdXJjZSk7CiAgfTsKCiAgZGVlcEV4dGVuZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBmaW5hbE9iaiwgbWF4RGVwdGgsIG9iamVjdHMsIF9pOwogICAgb2JqZWN0cyA9IDIgPD0gYXJndW1lbnRzLmxlbmd0aCA/IF9fc2xpY2UuY2FsbChhcmd1bWVudHMsIDAsIF9pID0gYXJndW1lbnRzLmxlbmd0aCAtIDEpIDogKF9pID0gMCwgW10pLCBtYXhEZXB0aCA9IGFyZ3VtZW50c1tfaSsrXTsKICAgIGlmICghXy5pc051bWJlcihtYXhEZXB0aCkpIHsKICAgICAgb2JqZWN0cy5wdXNoKG1heERlcHRoKTsKICAgICAgbWF4RGVwdGggPSAyMDsKICAgIH0KICAgIGlmIChvYmplY3RzLmxlbmd0aCA8PSAxKSB7CiAgICAgIHJldHVybiBvYmplY3RzWzBdOwogICAgfQogICAgaWYgKG1heERlcHRoIDw9IDApIHsKICAgICAgcmV0dXJuIF8uZXh0ZW5kLmFwcGx5KHRoaXMsIG9iamVjdHMpOwogICAgfQogICAgZmluYWxPYmogPSBvYmplY3RzLnNoaWZ0KCk7CiAgICB3aGlsZSAob2JqZWN0cy5sZW5ndGggPiAwKSB7CiAgICAgIGZpbmFsT2JqID0gZGVlcEV4dGVuZENvdXBsZShmaW5hbE9iaiwgZGVlcENsb25lKG9iamVjdHMuc2hpZnQoKSksIG1heERlcHRoKTsKICAgIH0KICAgIHJldHVybiBmaW5hbE9iajsKICB9OwoKICBfLm1peGluKHsKICAgIGRlZXBDbG9uZTogZGVlcENsb25lLAogICAgaXNCYXNpY09iamVjdDogaXNCYXNpY09iamVjdCwKICAgIGJhc2ljT2JqZWN0czogYmFzaWNPYmplY3RzLAogICAgYXJyYXlzOiBhcnJheXMsCiAgICBkZWVwRXh0ZW5kOiBkZWVwRXh0ZW5kCiAgfSk7Cgp9KTsKLyoqCiAqIE1haW4gc291cmNlCiAqLwoKOyhmdW5jdGlvbihmYWN0b3J5KSB7CiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgLy8gQU1ECiAgICAgICAgZGVmaW5lKCdiYWNrYm9uZS5kZWVwLm1vZGVsJyxbJ3VuZGVyc2NvcmUnLCAnYmFja2JvbmUnXSwgZmFjdG9yeSk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIGdsb2JhbHMKICAgICAgICBmYWN0b3J5KF8sIEJhY2tib25lKTsKICAgIH0KfShmdW5jdGlvbihfLCBCYWNrYm9uZSkgewoKICAgIC8qKgogICAgICogVGFrZXMgYSBuZXN0ZWQgb2JqZWN0IGFuZCByZXR1cm5zIGEgc2hhbGxvdyBvYmplY3Qga2V5ZWQgd2l0aCB0aGUgcGF0aCBuYW1lcwogICAgICogZS5nLiB7ICJsZXZlbDEubGV2ZWwyIjogInZhbHVlIiB9CiAgICAgKgogICAgICogQHBhcmFtICB7T2JqZWN0fSAgICAgIE5lc3RlZCBvYmplY3QgZS5nLiB7IGxldmVsMTogeyBsZXZlbDI6ICd2YWx1ZScgfSB9CiAgICAgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgU2hhbGxvdyBvYmplY3Qgd2l0aCBwYXRoIG5hbWVzIGUuZy4geyAnbGV2ZWwxLmxldmVsMic6ICd2YWx1ZScgfQogICAgICovCiAgICBmdW5jdGlvbiBvYmpUb1BhdGhzKG9iaikgewogICAgICAgIHZhciByZXQgPSB7fSwKICAgICAgICAgICAgc2VwYXJhdG9yID0gRGVlcE1vZGVsLmtleVBhdGhTZXBhcmF0b3I7CgogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgdmFyIHZhbCA9IG9ialtrZXldOwoKICAgICAgICAgICAgaWYgKHZhbCAmJiB2YWwuY29uc3RydWN0b3IgPT09IE9iamVjdCAmJiAhXy5pc0VtcHR5KHZhbCkpIHsKICAgICAgICAgICAgICAgIC8vUmVjdXJzaW9uIGZvciBlbWJlZGRlZCBvYmplY3RzCiAgICAgICAgICAgICAgICB2YXIgb2JqMiA9IG9ialRvUGF0aHModmFsKTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkyIGluIG9iajIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsMiA9IG9iajJba2V5Ml07CgogICAgICAgICAgICAgICAgICAgIHJldFtrZXkgKyBzZXBhcmF0b3IgKyBrZXkyXSA9IHZhbDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXRba2V5XSA9IHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KCiAgICAvKioKICAgICAqIEBwYXJhbSB7T2JqZWN0fSAgT2JqZWN0IHRvIGZldGNoIGF0dHJpYnV0ZSBmcm9tCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gIE9iamVjdCBwYXRoIGUuZy4gJ3VzZXIubmFtZScKICAgICAqIEByZXR1cm4ge01peGVkfQogICAgICovCiAgICBmdW5jdGlvbiBnZXROZXN0ZWQob2JqLCBwYXRoLCByZXR1cm5fZXhpc3RzKSB7CiAgICAgICAgdmFyIHNlcGFyYXRvciA9IERlZXBNb2RlbC5rZXlQYXRoU2VwYXJhdG9yOwoKICAgICAgICB2YXIgZmllbGRzID0gcGF0aC5zcGxpdChzZXBhcmF0b3IpOwogICAgICAgIHZhciByZXN1bHQgPSBvYmo7CiAgICAgICAgcmV0dXJuX2V4aXN0cyB8fCAocmV0dXJuX2V4aXN0cyA9PT0gZmFsc2UpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gZmllbGRzLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICAgICAgICBpZiAocmV0dXJuX2V4aXN0cyAmJiAhXy5oYXMocmVzdWx0LCBmaWVsZHNbaV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ID0gcmVzdWx0W2ZpZWxkc1tpXV07CgogICAgICAgICAgICBpZiAocmVzdWx0ID09IG51bGwgJiYgaSA8IG4gLSAxKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSB7fTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICBpZiAocmV0dXJuX2V4aXN0cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJldHVybl9leGlzdHMpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmogICAgICAgICAgICAgICAgT2JqZWN0IHRvIGZldGNoIGF0dHJpYnV0ZSBmcm9tCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCAgICAgICAgICAgICAgIE9iamVjdCBwYXRoIGUuZy4gJ3VzZXIubmFtZScKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gICAgICAgICAgT3B0aW9ucwogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy51bnNldF0gICBXaGV0aGVyIHRvIGRlbGV0ZSB0aGUgdmFsdWUKICAgICAqIEBwYXJhbSB7TWl4ZWR9ICAgICAgICAgICAgICAgICAgICAgVmFsdWUgdG8gc2V0CiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldE5lc3RlZChvYmosIHBhdGgsIHZhbCwgb3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgICB2YXIgc2VwYXJhdG9yID0gRGVlcE1vZGVsLmtleVBhdGhTZXBhcmF0b3I7CgogICAgICAgIHZhciBmaWVsZHMgPSBwYXRoLnNwbGl0KHNlcGFyYXRvcik7CiAgICAgICAgdmFyIHJlc3VsdCA9IG9iajsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbiA9IGZpZWxkcy5sZW5ndGg7IGkgPCBuICYmIHJlc3VsdCAhPT0gdW5kZWZpbmVkIDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBmaWVsZCA9IGZpZWxkc1tpXTsKCiAgICAgICAgICAgIC8vSWYgdGhlIGxhc3QgaW4gdGhlIHBhdGgsIHNldCB0aGUgdmFsdWUKICAgICAgICAgICAgaWYgKGkgPT09IG4gLSAxKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLnVuc2V0ID8gZGVsZXRlIHJlc3VsdFtmaWVsZF0gOiByZXN1bHRbZmllbGRdID0gdmFsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy9DcmVhdGUgdGhlIGNoaWxkIG9iamVjdCBpZiBpdCBkb2Vzbid0IGV4aXN0LCBvciBpc24ndCBhbiBvYmplY3QKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVzdWx0W2ZpZWxkXSA9PT0gJ3VuZGVmaW5lZCcgfHwgISBfLmlzT2JqZWN0KHJlc3VsdFtmaWVsZF0pKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IHt9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vTW92ZSBvbnRvIHRoZSBuZXh0IHBhcnQgb2YgdGhlIHBhdGgKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdFtmaWVsZF07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZGVsZXRlTmVzdGVkKG9iaiwgcGF0aCkgewogICAgICBzZXROZXN0ZWQob2JqLCBwYXRoLCBudWxsLCB7IHVuc2V0OiB0cnVlIH0pOwogICAgfQoKICAgIHZhciBEZWVwTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewoKICAgICAgICAvLyBPdmVycmlkZSBjb25zdHJ1Y3RvcgogICAgICAgIC8vIFN1cHBvcnQgaGF2aW5nIG5lc3RlZCBkZWZhdWx0cyBieSB1c2luZyBfLmRlZXBFeHRlbmQgaW5zdGVhZCBvZiBfLmV4dGVuZAogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0czsKICAgICAgICAgICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgICAgICAgICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wYXJzZSkgYXR0cnMgPSB0aGlzLnBhcnNlKGF0dHJzLCBvcHRpb25zKSB8fCB7fTsKICAgICAgICAgICAgaWYgKGRlZmF1bHRzID0gXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpIHsKICAgICAgICAgICAgICAgIC8vPGN1c3RvbSBjb2RlPgogICAgICAgICAgICAgICAgLy8gUmVwbGFjZWQgdGhlIGNhbGwgdG8gXy5kZWZhdWx0cyB3aXRoIF8uZGVlcEV4dGVuZC4KICAgICAgICAgICAgICAgIGF0dHJzID0gXy5kZWVwRXh0ZW5kKHt9LCBkZWZhdWx0cywgYXR0cnMpOwogICAgICAgICAgICAgICAgLy88L2N1c3RvbSBjb2RlPgogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCgogICAgICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgICAgICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcywgdHJ1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gT3ZlcnJpZGUgZ2V0CiAgICAgICAgLy8gU3VwcG9ydHMgbmVzdGVkIGF0dHJpYnV0ZXMgdmlhIHRoZSBzeW50YXggJ29iai5hdHRyJyBlLmcuICdhdXRob3IudXNlci5uYW1lJwogICAgICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICAgICAgICByZXR1cm4gZ2V0TmVzdGVkKHRoaXMuYXR0cmlidXRlcywgYXR0cik7CiAgICAgICAgfSwKCiAgICAgICAgLy8gT3ZlcnJpZGUgc2V0CiAgICAgICAgLy8gU3VwcG9ydHMgbmVzdGVkIGF0dHJpYnV0ZXMgdmlhIHRoZSBzeW50YXggJ29iai5hdHRyJyBlLmcuICdhdXRob3IudXNlci5uYW1lJwogICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGF0dHIsIGF0dHJzLCB1bnNldCwgY2hhbmdlcywgc2lsZW50LCBjaGFuZ2luZywgcHJldiwgY3VycmVudDsKICAgICAgICAgICAgaWYgKGtleSA9PSBudWxsKSByZXR1cm4gdGhpczsKCiAgICAgICAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICAgICAgICBpZiAodHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICAgICAgICBvcHRpb25zID0gdmFsIHx8IHt9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoKICAgICAgICAgICAgLy8gUnVuIHZhbGlkYXRpb24uCiAgICAgICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAvLyBFeHRyYWN0IGF0dHJpYnV0ZXMgYW5kIG9wdGlvbnMuCiAgICAgICAgICAgIHVuc2V0ICAgICAgICAgICA9IG9wdGlvbnMudW5zZXQ7CiAgICAgICAgICAgIHNpbGVudCAgICAgICAgICA9IG9wdGlvbnMuc2lsZW50OwogICAgICAgICAgICBjaGFuZ2VzICAgICAgICAgPSBbXTsKICAgICAgICAgICAgY2hhbmdpbmcgICAgICAgID0gdGhpcy5fY2hhbmdpbmc7CiAgICAgICAgICAgIHRoaXMuX2NoYW5naW5nICA9IHRydWU7CgogICAgICAgICAgICBpZiAoIWNoYW5naW5nKSB7CiAgICAgICAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMsIHRydWUpOwogICAgICAgICAgICAgIHRoaXMuY2hhbmdlZCA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLmF0dHJpYnV0ZXMsIHByZXYgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CgogICAgICAgICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyBvZiBgaWRgLgogICAgICAgICAgICBpZiAodGhpcy5pZEF0dHJpYnV0ZSBpbiBhdHRycykgdGhpcy5pZCA9IGF0dHJzW3RoaXMuaWRBdHRyaWJ1dGVdOwoKICAgICAgICAgICAgLy88Y3VzdG9tIGNvZGU+CiAgICAgICAgICAgIGF0dHJzID0gb2JqVG9QYXRocyhhdHRycyk7CiAgICAgICAgICAgIC8vPC9jdXN0b20gY29kZT4KCiAgICAgICAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZSwgdXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAgICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CgogICAgICAgICAgICAgIC8vPGN1c3RvbSBjb2RlPjogVXNpbmcgZ2V0TmVzdGVkLCBzZXROZXN0ZWQgYW5kIGRlbGV0ZU5lc3RlZAogICAgICAgICAgICAgIGlmICghXy5pc0VxdWFsKGdldE5lc3RlZChjdXJyZW50LCBhdHRyKSwgdmFsKSkgY2hhbmdlcy5wdXNoKGF0dHIpOwogICAgICAgICAgICAgIGlmICghXy5pc0VxdWFsKGdldE5lc3RlZChwcmV2LCBhdHRyKSwgdmFsKSkgewogICAgICAgICAgICAgICAgc2V0TmVzdGVkKHRoaXMuY2hhbmdlZCwgYXR0ciwgdmFsKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlTmVzdGVkKHRoaXMuY2hhbmdlZCwgYXR0cik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVuc2V0ID8gZGVsZXRlTmVzdGVkKGN1cnJlbnQsIGF0dHIpIDogc2V0TmVzdGVkKGN1cnJlbnQsIGF0dHIsIHZhbCk7CiAgICAgICAgICAgICAgLy88L2N1c3RvbSBjb2RlPgogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSB0cnVlOwoKICAgICAgICAgICAgICAvLzxjdXN0b20gY29kZT4KICAgICAgICAgICAgICB2YXIgc2VwYXJhdG9yID0gRGVlcE1vZGVsLmtleVBhdGhTZXBhcmF0b3I7CiAgICAgICAgICAgICAgdmFyIGFscmVhZHlUcmlnZ2VyZWQgPSB7fTsgLy8gKiBAcmVzdG9yZXIKCiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGtleSA9IGNoYW5nZXNbaV07CgogICAgICAgICAgICAgICAgaWYgKCFhbHJlYWR5VHJpZ2dlcmVkLmhhc093blByb3BlcnR5KGtleSkgfHwgIWFscmVhZHlUcmlnZ2VyZWRba2V5XSkgeyAvLyAqIEByZXN0b3JlcgogICAgICAgICAgICAgICAgICBhbHJlYWR5VHJpZ2dlcmVkW2tleV0gPSB0cnVlOyAvLyAqIEByZXN0b3JlcgogICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsga2V5LCB0aGlzLCBnZXROZXN0ZWQoY3VycmVudCwga2V5KSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9IC8vICogQHJlc3RvcmVyCgogICAgICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtleS5zcGxpdChzZXBhcmF0b3IpOwoKICAgICAgICAgICAgICAgIC8vVHJpZ2dlciBjaGFuZ2UgZXZlbnRzIGZvciBwYXJlbnQga2V5cyB3aXRoIHdpbGRjYXJkICgqKSBub3RhdGlvbgogICAgICAgICAgICAgICAgZm9yKHZhciBuID0gZmllbGRzLmxlbmd0aCAtIDE7IG4gPiAwOyBuLS0pIHsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEtleSA9IF8uZmlyc3QoZmllbGRzLCBuKS5qb2luKHNlcGFyYXRvciksCiAgICAgICAgICAgICAgICAgICAgICB3aWxkY2FyZEtleSA9IHBhcmVudEtleSArIHNlcGFyYXRvciArICcqJzsKCiAgICAgICAgICAgICAgICAgIGlmICghYWxyZWFkeVRyaWdnZXJlZC5oYXNPd25Qcm9wZXJ0eSh3aWxkY2FyZEtleSkgfHwgIWFscmVhZHlUcmlnZ2VyZWRbd2lsZGNhcmRLZXldKSB7IC8vICogQHJlc3RvcmVyCiAgICAgICAgICAgICAgICAgICAgYWxyZWFkeVRyaWdnZXJlZFt3aWxkY2FyZEtleV0gPSB0cnVlOyAvLyAqIEByZXN0b3JlcgogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyB3aWxkY2FyZEtleSwgdGhpcywgZ2V0TmVzdGVkKGN1cnJlbnQsIHBhcmVudEtleSksIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICB9IC8vICogQHJlc3RvcmVyCgogICAgICAgICAgICAgICAgICAvLyArIEByZXN0b3JlcgogICAgICAgICAgICAgICAgICBpZiAoIWFscmVhZHlUcmlnZ2VyZWQuaGFzT3duUHJvcGVydHkocGFyZW50S2V5KSB8fCAhYWxyZWFkeVRyaWdnZXJlZFtwYXJlbnRLZXldKSB7CiAgICAgICAgICAgICAgICAgICAgYWxyZWFkeVRyaWdnZXJlZFtwYXJlbnRLZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgcGFyZW50S2V5LCB0aGlzLCBnZXROZXN0ZWQoY3VycmVudCwgcGFyZW50S2V5KSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gLSBAcmVzdG9yZXIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vPC9jdXN0b20gY29kZT4KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjaGFuZ2luZykgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIGlmICghc2lsZW50KSB7CiAgICAgICAgICAgICAgd2hpbGUgKHRoaXMuX3BlbmRpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQogICAgICAgIC8vIHRvIHNpbGVuY2UgaXQuCiAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgIHZhciBhdHRycyA9IHt9OwogICAgICAgICAgdmFyIHNoYWxsb3dBdHRyaWJ1dGVzID0gb2JqVG9QYXRocyh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHNoYWxsb3dBdHRyaWJ1dGVzKSBhdHRyc1trZXldID0gdm9pZCAwOwogICAgICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgICAgIH0sCgogICAgICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgICAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CiAgICAgICAgICByZXR1cm4gZ2V0TmVzdGVkKHRoaXMuY2hhbmdlZCwgYXR0cikgIT09IHVuZGVmaW5lZDsKICAgICAgICB9LAoKICAgICAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgogICAgICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCiAgICAgICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAgICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAgICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KICAgICAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24oZGlmZikgewogICAgICAgICAgLy88Y3VzdG9tIGNvZGU+OiBvYmpUb1BhdGhzCiAgICAgICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IG9ialRvUGF0aHModGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwogICAgICAgICAgLy88L2N1c3RvbSBjb2RlPgoKICAgICAgICAgIHZhciBvbGQgPSB0aGlzLl9jaGFuZ2luZyA/IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA6IHRoaXMuYXR0cmlidXRlczsKCiAgICAgICAgICAvLzxjdXN0b20gY29kZT4KICAgICAgICAgIGRpZmYgPSBvYmpUb1BhdGhzKGRpZmYpOwogICAgICAgICAgb2xkID0gb2JqVG9QYXRocyhvbGQpOwogICAgICAgICAgLy88L2N1c3RvbSBjb2RlPgoKICAgICAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7CiAgICAgICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgICAgIH0sCgogICAgICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgICAgIHByZXZpb3VzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwoKICAgICAgICAgIC8vPGN1c3RvbSBjb2RlPgogICAgICAgICAgcmV0dXJuIGdldE5lc3RlZCh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMsIGF0dHIpOwogICAgICAgICAgLy88L2N1c3RvbSBjb2RlPgogICAgICAgIH0sCgogICAgICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cwogICAgICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICAgICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vPGN1c3RvbSBjb2RlPgogICAgICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzLCB0cnVlKTsKICAgICAgICAgIC8vPC9jdXN0b20gY29kZT4KICAgICAgICB9CiAgICB9KTsKCgogICAgLy9Db25maWc7IG92ZXJyaWRlIGluIHlvdXIgYXBwIHRvIGN1c3RvbWlzZQogICAgRGVlcE1vZGVsLmtleVBhdGhTZXBhcmF0b3IgPSAnLic7CgoKICAgIC8vRXhwb3J0cwogICAgQmFja2JvbmUuRGVlcE1vZGVsID0gRGVlcE1vZGVsOwoKICAgIC8vRm9yIHVzZSBpbiBOb2RlSlMKICAgIGlmICh0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnKSBtb2R1bGUuZXhwb3J0cyA9IERlZXBNb2RlbDsKCiAgICByZXR1cm4gQmFja2JvbmU7Cgp9KSk7CgovLyBCYWNrYm9uZS5WYWxpZGF0aW9uIHYwLjguMgovLwovLyBDb3B5cmlnaHQgKGMpIDIwMTEtMjAxMyBUaG9tYXMgUGVkZXJzZW4KLy8gRGlzdHJpYnV0ZWQgdW5kZXIgTUlUIExpY2Vuc2UKLy8KLy8gRG9jdW1lbnRhdGlvbiBhbmQgZnVsbCBsaWNlbnNlIGF2YWlsYWJsZSBhdDoKLy8gaHR0cDovL3RoZWRlcnNlbi5jb20vcHJvamVjdHMvYmFja2JvbmUtdmFsaWRhdGlvbgooZnVuY3Rpb24gKGZhY3RvcnkpIHsKICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnYmFja2JvbmUnKSwgcmVxdWlyZSgndW5kZXJzY29yZScpKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgZGVmaW5lKCdiYWNrYm9uZS52YWxpZGF0aW9uJyxbJ2JhY2tib25lJywgJ3VuZGVyc2NvcmUnXSwgZmFjdG9yeSk7CiAgfQp9KGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogIEJhY2tib25lLlZhbGlkYXRpb24gPSAoZnVuY3Rpb24oXyl7CiAgICAKICAKICAgIC8vIERlZmF1bHQgb3B0aW9ucwogICAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgCiAgICB2YXIgZGVmYXVsdE9wdGlvbnMgPSB7CiAgICAgIGZvcmNlVXBkYXRlOiBmYWxzZSwKICAgICAgc2VsZWN0b3I6ICduYW1lJywKICAgICAgbGFiZWxGb3JtYXR0ZXI6ICdzZW50ZW5jZUNhc2UnLAogICAgICB2YWxpZDogRnVuY3Rpb24ucHJvdG90eXBlLAogICAgICBpbnZhbGlkOiBGdW5jdGlvbi5wcm90b3R5cGUKICAgIH07CiAgCiAgCiAgICAvLyBIZWxwZXIgZnVuY3Rpb25zCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tCiAgCiAgICAvLyBGb3JtYXR0aW5nIGZ1bmN0aW9ucyB1c2VkIGZvciBmb3JtYXR0aW5nIGVycm9yIG1lc3NhZ2VzCiAgICB2YXIgZm9ybWF0RnVuY3Rpb25zID0gewogICAgICAvLyBVc2VzIHRoZSBjb25maWd1cmVkIGxhYmVsIGZvcm1hdHRlciB0byBmb3JtYXQgdGhlIGF0dHJpYnV0ZSBuYW1lCiAgICAgIC8vIHRvIG1ha2UgaXQgbW9yZSByZWFkYWJsZSBmb3IgdGhlIHVzZXIKICAgICAgZm9ybWF0TGFiZWw6IGZ1bmN0aW9uKGF0dHJOYW1lLCBtb2RlbCkgewogICAgICAgIHJldHVybiBkZWZhdWx0TGFiZWxGb3JtYXR0ZXJzW2RlZmF1bHRPcHRpb25zLmxhYmVsRm9ybWF0dGVyXShhdHRyTmFtZSwgbW9kZWwpOwogICAgICB9LAogIAogICAgICAvLyBSZXBsYWNlcyBudW1tZXJpYyBwbGFjZWhvbGRlcnMgbGlrZSB7MH0gaW4gYSBzdHJpbmcgd2l0aCBhcmd1bWVudHMKICAgICAgLy8gcGFzc2VkIHRvIHRoZSBmdW5jdGlvbgogICAgICBmb3JtYXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSwKICAgICAgICAgICAgdGV4dCA9IGFyZ3Muc2hpZnQoKTsKICAgICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKC9ceyhcZCspXH0vZywgZnVuY3Rpb24obWF0Y2gsIG51bWJlcikgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiBhcmdzW251bWJlcl0gIT09ICd1bmRlZmluZWQnID8gYXJnc1tudW1iZXJdIDogbWF0Y2g7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgCiAgICAvLyBGbGF0dGVucyBhbiBvYmplY3QKICAgIC8vIGVnOgogICAgLy8KICAgIC8vICAgICB2YXIgbyA9IHsKICAgIC8vICAgICAgIGFkZHJlc3M6IHsKICAgIC8vICAgICAgICAgc3RyZWV0OiAnU3RyZWV0JywKICAgIC8vICAgICAgICAgemlwOiAxMjM0CiAgICAvLyAgICAgICB9CiAgICAvLyAgICAgfTsKICAgIC8vCiAgICAvLyBiZWNvbWVzOgogICAgLy8KICAgIC8vICAgICB2YXIgbyA9IHsKICAgIC8vICAgICAgICdhZGRyZXNzLnN0cmVldCc6ICdTdHJlZXQnLAogICAgLy8gICAgICAgJ2FkZHJlc3MuemlwJzogMTIzNAogICAgLy8gICAgIH07CiAgICB2YXIgZmxhdHRlbiA9IGZ1bmN0aW9uIChvYmosIGludG8sIHByZWZpeCkgewogICAgICBpbnRvID0gaW50byB8fCB7fTsKICAgICAgcHJlZml4ID0gcHJlZml4IHx8ICcnOwogIAogICAgICBfLmVhY2gob2JqLCBmdW5jdGlvbih2YWwsIGtleSkgewogICAgICAgIGlmKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICBpZiAodmFsICYmIHR5cGVvZiB2YWwgPT09ICdvYmplY3QnICYmICEoCiAgICAgICAgICAgIHZhbCBpbnN0YW5jZW9mIEFycmF5IHx8CiAgICAgICAgICAgIHZhbCBpbnN0YW5jZW9mIERhdGUgfHwKICAgICAgICAgICAgdmFsIGluc3RhbmNlb2YgUmVnRXhwIHx8CiAgICAgICAgICAgIHZhbCBpbnN0YW5jZW9mIEJhY2tib25lLk1vZGVsIHx8CiAgICAgICAgICAgIHZhbCBpbnN0YW5jZW9mIEJhY2tib25lLkNvbGxlY3Rpb24pCiAgICAgICAgICApIHsKICAgICAgICAgICAgZmxhdHRlbih2YWwsIGludG8sIHByZWZpeCArIGtleSArICcuJyk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgaW50b1twcmVmaXggKyBrZXldID0gdmFsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBpbnRvOwogICAgfTsKICAKICAgIC8vIFZhbGlkYXRpb24KICAgIC8vIC0tLS0tLS0tLS0KICAKICAgIHZhciBWYWxpZGF0aW9uID0gKGZ1bmN0aW9uKCl7CiAgCiAgICAgIC8vIFJldHVybnMgYW4gb2JqZWN0IHdpdGggdW5kZWZpbmVkIHByb3BlcnRpZXMgZm9yIGFsbAogICAgICAvLyBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCB0aGF0IGhhcyBkZWZpbmVkIG9uZSBvciBtb3JlCiAgICAgIC8vIHZhbGlkYXRpb24gcnVsZXMuCiAgICAgIHZhciBnZXRWYWxpZGF0ZWRBdHRycyA9IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIF8ucmVkdWNlKF8ua2V5cyhfLnJlc3VsdChtb2RlbCwgJ3ZhbGlkYXRpb24nKSB8fCB7fSksIGZ1bmN0aW9uKG1lbW8sIGtleSkgewogICAgICAgICAgbWVtb1trZXldID0gdm9pZCAwOwogICAgICAgICAgcmV0dXJuIG1lbW87CiAgICAgICAgfSwge30pOwogICAgICB9OwogIAogICAgICAvLyBMb29rcyBvbiB0aGUgbW9kZWwgZm9yIHZhbGlkYXRpb25zIGZvciBhIHNwZWNpZmllZAogICAgICAvLyBhdHRyaWJ1dGUuIFJldHVybnMgYW4gYXJyYXkgb2YgYW55IHZhbGlkYXRvcnMgZGVmaW5lZCwKICAgICAgLy8gb3IgYW4gZW1wdHkgYXJyYXkgaWYgbm9uZSBpcyBkZWZpbmVkLgogICAgICB2YXIgZ2V0VmFsaWRhdG9ycyA9IGZ1bmN0aW9uKG1vZGVsLCBhdHRyKSB7CiAgICAgICAgdmFyIGF0dHJWYWxpZGF0aW9uU2V0ID0gbW9kZWwudmFsaWRhdGlvbiA/IF8ucmVzdWx0KG1vZGVsLCAndmFsaWRhdGlvbicpW2F0dHJdIHx8IHt9IDoge307CiAgCiAgICAgICAgLy8gSWYgdGhlIHZhbGlkYXRvciBpcyBhIGZ1bmN0aW9uIG9yIGEgc3RyaW5nLCB3cmFwIGl0IGluIGEgZnVuY3Rpb24gdmFsaWRhdG9yCiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihhdHRyVmFsaWRhdGlvblNldCkgfHwgXy5pc1N0cmluZyhhdHRyVmFsaWRhdGlvblNldCkpIHsKICAgICAgICAgIGF0dHJWYWxpZGF0aW9uU2V0ID0gewogICAgICAgICAgICBmbjogYXR0clZhbGlkYXRpb25TZXQKICAgICAgICAgIH07CiAgICAgICAgfQogIAogICAgICAgIC8vIFN0aWNrIHRoZSB2YWxpZGF0b3Igb2JqZWN0IGludG8gYW4gYXJyYXkKICAgICAgICBpZighXy5pc0FycmF5KGF0dHJWYWxpZGF0aW9uU2V0KSkgewogICAgICAgICAgYXR0clZhbGlkYXRpb25TZXQgPSBbYXR0clZhbGlkYXRpb25TZXRdOwogICAgICAgIH0KICAKICAgICAgICAvLyBSZWR1Y2VzIHRoZSBhcnJheSBvZiB2YWxpZGF0b3JzIGludG8gYSBuZXcgYXJyYXkgd2l0aCBvYmplY3RzCiAgICAgICAgLy8gd2l0aCBhIHZhbGlkYXRpb24gbWV0aG9kIHRvIGNhbGwsIHRoZSB2YWx1ZSB0byB2YWxpZGF0ZSBhZ2FpbnN0CiAgICAgICAgLy8gYW5kIHRoZSBzcGVjaWZpZWQgZXJyb3IgbWVzc2FnZSwgaWYgYW55CiAgICAgICAgcmV0dXJuIF8ucmVkdWNlKGF0dHJWYWxpZGF0aW9uU2V0LCBmdW5jdGlvbihtZW1vLCBhdHRyVmFsaWRhdGlvbikgewogICAgICAgICAgXy5lYWNoKF8ud2l0aG91dChfLmtleXMoYXR0clZhbGlkYXRpb24pLCAnbXNnJyksIGZ1bmN0aW9uKHZhbGlkYXRvcikgewogICAgICAgICAgICBtZW1vLnB1c2goewogICAgICAgICAgICAgIGZuOiBkZWZhdWx0VmFsaWRhdG9yc1t2YWxpZGF0b3JdLAogICAgICAgICAgICAgIHZhbDogYXR0clZhbGlkYXRpb25bdmFsaWRhdG9yXSwKICAgICAgICAgICAgICBtc2c6IGF0dHJWYWxpZGF0aW9uLm1zZwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIG1lbW87CiAgICAgICAgfSwgW10pOwogICAgICB9OwogIAogICAgICAvLyBWYWxpZGF0ZXMgYW4gYXR0cmlidXRlIGFnYWluc3QgYWxsIHZhbGlkYXRvcnMgZGVmaW5lZAogICAgICAvLyBmb3IgdGhhdCBhdHRyaWJ1dGUuIElmIG9uZSBvciBtb3JlIGVycm9ycyBhcmUgZm91bmQsCiAgICAgIC8vIHRoZSBmaXJzdCBlcnJvciBtZXNzYWdlIGlzIHJldHVybmVkLgogICAgICAvLyBJZiB0aGUgYXR0cmlidXRlIGlzIHZhbGlkLCBhbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAgICAgIHZhciB2YWxpZGF0ZUF0dHIgPSBmdW5jdGlvbihtb2RlbCwgYXR0ciwgdmFsdWUsIGNvbXB1dGVkKSB7CiAgICAgICAgLy8gUmVkdWNlcyB0aGUgYXJyYXkgb2YgdmFsaWRhdG9ycyB0byBhbiBlcnJvciBtZXNzYWdlIGJ5CiAgICAgICAgLy8gYXBwbHlpbmcgYWxsIHRoZSB2YWxpZGF0b3JzIGFuZCByZXR1cm5pbmcgdGhlIGZpcnN0IGVycm9yCiAgICAgICAgLy8gbWVzc2FnZSwgaWYgYW55LgogICAgICAgIHJldHVybiBfLnJlZHVjZShnZXRWYWxpZGF0b3JzKG1vZGVsLCBhdHRyKSwgZnVuY3Rpb24obWVtbywgdmFsaWRhdG9yKXsKICAgICAgICAgIC8vIFBhc3MgdGhlIGZvcm1hdCBmdW5jdGlvbnMgcGx1cyB0aGUgZGVmYXVsdAogICAgICAgICAgLy8gdmFsaWRhdG9ycyBhcyB0aGUgY29udGV4dCB0byB0aGUgdmFsaWRhdG9yCiAgICAgICAgICB2YXIgY3R4ID0gXy5leHRlbmQoe30sIGZvcm1hdEZ1bmN0aW9ucywgZGVmYXVsdFZhbGlkYXRvcnMpLAogICAgICAgICAgICAgIHJlc3VsdCA9IHZhbGlkYXRvci5mbi5jYWxsKGN0eCwgdmFsdWUsIGF0dHIsIHZhbGlkYXRvci52YWwsIG1vZGVsLCBjb21wdXRlZCk7CiAgCiAgICAgICAgICBpZihyZXN1bHQgPT09IGZhbHNlIHx8IG1lbW8gPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZXN1bHQgJiYgIW1lbW8pIHsKICAgICAgICAgICAgcmV0dXJuIF8ucmVzdWx0KHZhbGlkYXRvciwgJ21zZycpIHx8IHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtZW1vOwogICAgICAgIH0sICcnKTsKICAgICAgfTsKICAKICAgICAgLy8gTG9vcHMgdGhyb3VnaCB0aGUgbW9kZWwncyBhdHRyaWJ1dGVzIGFuZCB2YWxpZGF0ZXMgdGhlbSBhbGwuCiAgICAgIC8vIFJldHVybnMgYW5kIG9iamVjdCBjb250YWluaW5nIG5hbWVzIG9mIGludmFsaWQgYXR0cmlidXRlcwogICAgICAvLyBhcyB3ZWxsIGFzIGVycm9yIG1lc3NhZ2VzLgogICAgICB2YXIgdmFsaWRhdGVNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsLCBhdHRycykgewogICAgICAgIHZhciBlcnJvciwKICAgICAgICAgICAgaW52YWxpZEF0dHJzID0ge30sCiAgICAgICAgICAgIGlzVmFsaWQgPSB0cnVlLAogICAgICAgICAgICBjb21wdXRlZCA9IF8uY2xvbmUoYXR0cnMpLAogICAgICAgICAgICBmbGF0dGVuZWQgPSBmbGF0dGVuKGF0dHJzKTsKICAKICAgICAgICBfLmVhY2goZmxhdHRlbmVkLCBmdW5jdGlvbih2YWwsIGF0dHIpIHsKICAgICAgICAgIGVycm9yID0gdmFsaWRhdGVBdHRyKG1vZGVsLCBhdHRyLCB2YWwsIGNvbXB1dGVkKTsKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICBpbnZhbGlkQXR0cnNbYXR0cl0gPSBlcnJvcjsKICAgICAgICAgICAgaXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0pOwogIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICBpbnZhbGlkQXR0cnM6IGludmFsaWRBdHRycywKICAgICAgICAgIGlzVmFsaWQ6IGlzVmFsaWQKICAgICAgICB9OwogICAgICB9OwogIAogICAgICAvLyBDb250YWlucyB0aGUgbWV0aG9kcyB0aGF0IGFyZSBtaXhlZCBpbiBvbiB0aGUgbW9kZWwgd2hlbiBiaW5kaW5nCiAgICAgIHZhciBtaXhpbiA9IGZ1bmN0aW9uKHZpZXcsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gewogIAogICAgICAgICAgLy8gQ2hlY2sgd2hldGhlciBvciBub3QgYSB2YWx1ZSwgb3IgYSBoYXNoIG9mIHZhbHVlcwogICAgICAgICAgLy8gcGFzc2VzIHZhbGlkYXRpb24gd2l0aG91dCB1cGRhdGluZyB0aGUgbW9kZWwKICAgICAgICAgIHByZVZhbGlkYXRlOiBmdW5jdGlvbihhdHRyLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgICAgICAgICByZXN1bHQgPSB7fSwKICAgICAgICAgICAgICAgIGVycm9yOwogIAogICAgICAgICAgICBpZihfLmlzT2JqZWN0KGF0dHIpKXsKICAgICAgICAgICAgICBfLmVhY2goYXR0ciwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgZXJyb3IgPSBzZWxmLnByZVZhbGlkYXRlKGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYoZXJyb3IpewogICAgICAgICAgICAgICAgICByZXN1bHRba2V5XSA9IGVycm9yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogIAogICAgICAgICAgICAgIHJldHVybiBfLmlzRW1wdHkocmVzdWx0KSA/IHVuZGVmaW5lZCA6IHJlc3VsdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gdmFsaWRhdGVBdHRyKHRoaXMsIGF0dHIsIHZhbHVlLCBfLmV4dGVuZCh7fSwgdGhpcy5hdHRyaWJ1dGVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgCiAgICAgICAgICAvLyBDaGVjayB0byBzZWUgaWYgYW4gYXR0cmlidXRlLCBhbiBhcnJheSBvZiBhdHRyaWJ1dGVzIG9yIHRoZQogICAgICAgICAgLy8gZW50aXJlIG1vZGVsIGlzIHZhbGlkLiBQYXNzaW5nIHRydWUgd2lsbCBmb3JjZSBhIHZhbGlkYXRpb24KICAgICAgICAgIC8vIG9mIHRoZSBtb2RlbC4KICAgICAgICAgIGlzVmFsaWQ6IGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgICAgICB2YXIgZmxhdHRlbmVkID0gZmxhdHRlbih0aGlzLmF0dHJpYnV0ZXMpOwogIAogICAgICAgICAgICBpZihfLmlzU3RyaW5nKG9wdGlvbikpewogICAgICAgICAgICAgIHJldHVybiAhdmFsaWRhdGVBdHRyKHRoaXMsIG9wdGlvbiwgZmxhdHRlbmVkW29wdGlvbl0sIF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihfLmlzQXJyYXkob3B0aW9uKSl7CiAgICAgICAgICAgICAgcmV0dXJuIF8ucmVkdWNlKG9wdGlvbiwgZnVuY3Rpb24obWVtbywgYXR0cikgewogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW8gJiYgIXZhbGlkYXRlQXR0cih0aGlzLCBhdHRyLCBmbGF0dGVuZWRbYXR0cl0sIF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMpKTsKICAgICAgICAgICAgICB9LCB0cnVlLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb24gPT09IHRydWUpIHsKICAgICAgICAgICAgICB0aGlzLnZhbGlkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGlvbiA/IHRoaXMuX2lzVmFsaWQgOiB0cnVlOwogICAgICAgICAgfSwKICAKICAgICAgICAgIC8vIFRoaXMgaXMgY2FsbGVkIGJ5IEJhY2tib25lIHdoZW4gaXQgbmVlZHMgdG8gcGVyZm9ybSB2YWxpZGF0aW9uLgogICAgICAgICAgLy8gWW91IGNhbiBjYWxsIGl0IG1hbnVhbGx5IHdpdGhvdXQgYW55IHBhcmFtZXRlcnMgdG8gdmFsaWRhdGUgdGhlCiAgICAgICAgICAvLyBlbnRpcmUgbW9kZWwuCiAgICAgICAgICB2YWxpZGF0ZTogZnVuY3Rpb24oYXR0cnMsIHNldE9wdGlvbnMpewogICAgICAgICAgICB2YXIgbW9kZWwgPSB0aGlzLAogICAgICAgICAgICAgICAgdmFsaWRhdGVBbGwgPSAhYXR0cnMsCiAgICAgICAgICAgICAgICBvcHQgPSBfLmV4dGVuZCh7fSwgb3B0aW9ucywgc2V0T3B0aW9ucyksCiAgICAgICAgICAgICAgICB2YWxpZGF0ZWRBdHRycyA9IGdldFZhbGlkYXRlZEF0dHJzKG1vZGVsKSwKICAgICAgICAgICAgICAgIGFsbEF0dHJzID0gXy5leHRlbmQoe30sIHZhbGlkYXRlZEF0dHJzLCBtb2RlbC5hdHRyaWJ1dGVzLCBhdHRycyksCiAgICAgICAgICAgICAgICBjaGFuZ2VkQXR0cnMgPSBmbGF0dGVuKGF0dHJzIHx8IGFsbEF0dHJzKSwKICAKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHZhbGlkYXRlTW9kZWwobW9kZWwsIGFsbEF0dHJzKTsKICAKICAgICAgICAgICAgbW9kZWwuX2lzVmFsaWQgPSByZXN1bHQuaXNWYWxpZDsKICAKICAgICAgICAgICAgLy8gQWZ0ZXIgdmFsaWRhdGlvbiBpcyBwZXJmb3JtZWQsIGxvb3AgdGhyb3VnaCBhbGwgY2hhbmdlZCBhdHRyaWJ1dGVzCiAgICAgICAgICAgIC8vIGFuZCBjYWxsIHRoZSB2YWxpZCBjYWxsYmFja3Mgc28gdGhlIHZpZXcgaXMgdXBkYXRlZC4KICAgICAgICAgICAgXy5lYWNoKHZhbGlkYXRlZEF0dHJzLCBmdW5jdGlvbih2YWwsIGF0dHIpewogICAgICAgICAgICAgIHZhciBpbnZhbGlkID0gcmVzdWx0LmludmFsaWRBdHRycy5oYXNPd25Qcm9wZXJ0eShhdHRyKTsKICAgICAgICAgICAgICBpZighaW52YWxpZCl7CiAgICAgICAgICAgICAgICBvcHQudmFsaWQodmlldywgYXR0ciwgb3B0LnNlbGVjdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogIAogICAgICAgICAgICAvLyBBZnRlciB2YWxpZGF0aW9uIGlzIHBlcmZvcm1lZCwgbG9vcCB0aHJvdWdoIGFsbCBjaGFuZ2VkIGF0dHJpYnV0ZXMKICAgICAgICAgICAgLy8gYW5kIGNhbGwgdGhlIGludmFsaWQgY2FsbGJhY2sgc28gdGhlIHZpZXcgaXMgdXBkYXRlZC4KICAgICAgICAgICAgXy5lYWNoKHZhbGlkYXRlZEF0dHJzLCBmdW5jdGlvbih2YWwsIGF0dHIpewogICAgICAgICAgICAgIHZhciBpbnZhbGlkID0gcmVzdWx0LmludmFsaWRBdHRycy5oYXNPd25Qcm9wZXJ0eShhdHRyKSwKICAgICAgICAgICAgICAgICAgY2hhbmdlZCA9IGNoYW5nZWRBdHRycy5oYXNPd25Qcm9wZXJ0eShhdHRyKTsKICAKICAgICAgICAgICAgICBpZihpbnZhbGlkICYmIChjaGFuZ2VkIHx8IHZhbGlkYXRlQWxsKSl7CiAgICAgICAgICAgICAgICBvcHQuaW52YWxpZCh2aWV3LCBhdHRyLCByZXN1bHQuaW52YWxpZEF0dHJzW2F0dHJdLCBvcHQuc2VsZWN0b3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgCiAgICAgICAgICAgIC8vIFRyaWdnZXIgdmFsaWRhdGVkIGV2ZW50cy4KICAgICAgICAgICAgLy8gTmVlZCB0byBkZWZlciB0aGlzIHNvIHRoZSBtb2RlbCBpcyBhY3R1YWxseSB1cGRhdGVkIGJlZm9yZQogICAgICAgICAgICAvLyB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkLgogICAgICAgICAgICBfLmRlZmVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3ZhbGlkYXRlZCcsIG1vZGVsLl9pc1ZhbGlkLCBtb2RlbCwgcmVzdWx0LmludmFsaWRBdHRycyk7CiAgICAgICAgICAgICAgbW9kZWwudHJpZ2dlcigndmFsaWRhdGVkOicgKyAobW9kZWwuX2lzVmFsaWQgPyAndmFsaWQnIDogJ2ludmFsaWQnKSwgbW9kZWwsIHJlc3VsdC5pbnZhbGlkQXR0cnMpOwogICAgICAgICAgICB9KTsKICAKICAgICAgICAgICAgLy8gUmV0dXJuIGFueSBlcnJvciBtZXNzYWdlcyB0byBCYWNrYm9uZSwgdW5sZXNzIHRoZSBmb3JjZVVwZGF0ZSBmbGFnIGlzIHNldC4KICAgICAgICAgICAgLy8gVGhlbiB3ZSBkbyBub3QgcmV0dXJuIGFueXRoaW5nIGFuZCBmb29scyBCYWNrYm9uZSB0byBiZWxpZXZlIHRoZSB2YWxpZGF0aW9uIHdhcwogICAgICAgICAgICAvLyBhIHN1Y2Nlc3MuIFRoYXQgd2F5IEJhY2tib25lIHdpbGwgdXBkYXRlIHRoZSBtb2RlbCByZWdhcmRsZXNzLgogICAgICAgICAgICBpZiAoIW9wdC5mb3JjZVVwZGF0ZSAmJiBfLmludGVyc2VjdGlvbihfLmtleXMocmVzdWx0LmludmFsaWRBdHRycyksIF8ua2V5cyhjaGFuZ2VkQXR0cnMpKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5pbnZhbGlkQXR0cnM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9OwogIAogICAgICAvLyBIZWxwZXIgdG8gbWl4IGluIHZhbGlkYXRpb24gb24gYSBtb2RlbAogICAgICB2YXIgYmluZE1vZGVsID0gZnVuY3Rpb24odmlldywgbW9kZWwsIG9wdGlvbnMpIHsKICAgICAgICBfLmV4dGVuZChtb2RlbCwgbWl4aW4odmlldywgb3B0aW9ucykpOwogICAgICB9OwogIAogICAgICAvLyBSZW1vdmVzIHRoZSBtZXRob2RzIGFkZGVkIHRvIGEgbW9kZWwKICAgICAgdmFyIHVuYmluZE1vZGVsID0gZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICBkZWxldGUgbW9kZWwudmFsaWRhdGU7CiAgICAgICAgZGVsZXRlIG1vZGVsLnByZVZhbGlkYXRlOwogICAgICAgIGRlbGV0ZSBtb2RlbC5pc1ZhbGlkOwogICAgICB9OwogIAogICAgICAvLyBNaXggaW4gdmFsaWRhdGlvbiBvbiBhIG1vZGVsIHdoZW5ldmVyIGEgbW9kZWwgaXMKICAgICAgLy8gYWRkZWQgdG8gYSBjb2xsZWN0aW9uCiAgICAgIHZhciBjb2xsZWN0aW9uQWRkID0gZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICBiaW5kTW9kZWwodGhpcy52aWV3LCBtb2RlbCwgdGhpcy5vcHRpb25zKTsKICAgICAgfTsKICAKICAgICAgLy8gUmVtb3ZlIHZhbGlkYXRpb24gZnJvbSBhIG1vZGVsIHdoZW5ldmVyIGEgbW9kZWwgaXMKICAgICAgLy8gcmVtb3ZlZCBmcm9tIGEgY29sbGVjdGlvbgogICAgICB2YXIgY29sbGVjdGlvblJlbW92ZSA9IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgdW5iaW5kTW9kZWwobW9kZWwpOwogICAgICB9OwogIAogICAgICAvLyBSZXR1cm5zIHRoZSBwdWJsaWMgbWV0aG9kcyBvbiBCYWNrYm9uZS5WYWxpZGF0aW9uCiAgICAgIHJldHVybiB7CiAgCiAgICAgICAgLy8gQ3VycmVudCB2ZXJzaW9uIG9mIHRoZSBsaWJyYXJ5CiAgICAgICAgdmVyc2lvbjogJzAuOC4yJywKICAKICAgICAgICAvLyBDYWxsZWQgdG8gY29uZmlndXJlIHRoZSBkZWZhdWx0IG9wdGlvbnMKICAgICAgICBjb25maWd1cmU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgIF8uZXh0ZW5kKGRlZmF1bHRPcHRpb25zLCBvcHRpb25zKTsKICAgICAgICB9LAogIAogICAgICAgIC8vIEhvb2tzIHVwIHZhbGlkYXRpb24gb24gYSB2aWV3IHdpdGggYSBtb2RlbAogICAgICAgIC8vIG9yIGNvbGxlY3Rpb24KICAgICAgICBiaW5kOiBmdW5jdGlvbih2aWV3LCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gXy5leHRlbmQoe30sIGRlZmF1bHRPcHRpb25zLCBkZWZhdWx0Q2FsbGJhY2tzLCBvcHRpb25zKTsKICAKICAgICAgICAgIHZhciBtb2RlbCA9IG9wdGlvbnMubW9kZWwgfHwgdmlldy5tb2RlbCwKICAgICAgICAgICAgICBjb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uIHx8IHZpZXcuY29sbGVjdGlvbjsKICAKICAgICAgICAgIGlmKHR5cGVvZiBtb2RlbCA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIGNvbGxlY3Rpb24gPT09ICd1bmRlZmluZWQnKXsKICAgICAgICAgICAgdGhyb3cgJ0JlZm9yZSB5b3UgZXhlY3V0ZSB0aGUgYmluZGluZyB5b3VyIHZpZXcgbXVzdCBoYXZlIGEgbW9kZWwgb3IgYSBjb2xsZWN0aW9uLlxuJyArCiAgICAgICAgICAgICAgICAgICdTZWUgaHR0cDovL3RoZWRlcnNlbi5jb20vcHJvamVjdHMvYmFja2JvbmUtdmFsaWRhdGlvbi8jdXNpbmctZm9ybS1tb2RlbC12YWxpZGF0aW9uIGZvciBtb3JlIGluZm9ybWF0aW9uLic7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpZihtb2RlbCkgewogICAgICAgICAgICBiaW5kTW9kZWwodmlldywgbW9kZWwsIG9wdGlvbnMpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZihjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgIGNvbGxlY3Rpb24uZWFjaChmdW5jdGlvbihtb2RlbCl7CiAgICAgICAgICAgICAgYmluZE1vZGVsKHZpZXcsIG1vZGVsLCBvcHRpb25zKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbGxlY3Rpb24uYmluZCgnYWRkJywgY29sbGVjdGlvbkFkZCwge3ZpZXc6IHZpZXcsIG9wdGlvbnM6IG9wdGlvbnN9KTsKICAgICAgICAgICAgY29sbGVjdGlvbi5iaW5kKCdyZW1vdmUnLCBjb2xsZWN0aW9uUmVtb3ZlKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIC8vIFJlbW92ZXMgdmFsaWRhdGlvbiBmcm9tIGEgdmlldyB3aXRoIGEgbW9kZWwKICAgICAgICAvLyBvciBjb2xsZWN0aW9uCiAgICAgICAgdW5iaW5kOiBmdW5jdGlvbih2aWV3LCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gXy5leHRlbmQoe30sIG9wdGlvbnMpOwogICAgICAgICAgdmFyIG1vZGVsID0gb3B0aW9ucy5tb2RlbCB8fCB2aWV3Lm1vZGVsLAogICAgICAgICAgICAgIGNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb24gfHwgdmlldy5jb2xsZWN0aW9uOwogIAogICAgICAgICAgaWYobW9kZWwpIHsKICAgICAgICAgICAgdW5iaW5kTW9kZWwobW9kZWwpOwogICAgICAgICAgfQogICAgICAgICAgaWYoY29sbGVjdGlvbikgewogICAgICAgICAgICBjb2xsZWN0aW9uLmVhY2goZnVuY3Rpb24obW9kZWwpewogICAgICAgICAgICAgIHVuYmluZE1vZGVsKG1vZGVsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbGxlY3Rpb24udW5iaW5kKCdhZGQnLCBjb2xsZWN0aW9uQWRkKTsKICAgICAgICAgICAgY29sbGVjdGlvbi51bmJpbmQoJ3JlbW92ZScsIGNvbGxlY3Rpb25SZW1vdmUpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgLy8gVXNlZCB0byBleHRlbmQgdGhlIEJhY2tib25lLk1vZGVsLnByb3RvdHlwZQogICAgICAgIC8vIHdpdGggdmFsaWRhdGlvbgogICAgICAgIG1peGluOiBtaXhpbihudWxsLCBkZWZhdWx0T3B0aW9ucykKICAgICAgfTsKICAgIH0oKSk7CiAgCiAgCiAgICAvLyBDYWxsYmFja3MKICAgIC8vIC0tLS0tLS0tLQogIAogICAgdmFyIGRlZmF1bHRDYWxsYmFja3MgPSBWYWxpZGF0aW9uLmNhbGxiYWNrcyA9IHsKICAKICAgICAgLy8gR2V0cyBjYWxsZWQgd2hlbiBhIHByZXZpb3VzbHkgaW52YWxpZCBmaWVsZCBpbiB0aGUKICAgICAgLy8gdmlldyBiZWNvbWVzIHZhbGlkLiBSZW1vdmVzIGFueSBlcnJvciBtZXNzYWdlLgogICAgICAvLyBTaG91bGQgYmUgb3ZlcnJpZGRlbiB3aXRoIGN1c3RvbSBmdW5jdGlvbmFsaXR5LgogICAgICB2YWxpZDogZnVuY3Rpb24odmlldywgYXR0ciwgc2VsZWN0b3IpIHsKICAgICAgICB2aWV3LiQoJ1snICsgc2VsZWN0b3IgKyAnfj0iJyArIGF0dHIgKyAnIl0nKQogICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ2ludmFsaWQnKQogICAgICAgICAgICAucmVtb3ZlQXR0cignZGF0YS1lcnJvcicpOwogICAgICB9LAogIAogICAgICAvLyBHZXRzIGNhbGxlZCB3aGVuIGEgZmllbGQgaW4gdGhlIHZpZXcgYmVjb21lcyBpbnZhbGlkLgogICAgICAvLyBBZGRzIGEgZXJyb3IgbWVzc2FnZS4KICAgICAgLy8gU2hvdWxkIGJlIG92ZXJyaWRkZW4gd2l0aCBjdXN0b20gZnVuY3Rpb25hbGl0eS4KICAgICAgaW52YWxpZDogZnVuY3Rpb24odmlldywgYXR0ciwgZXJyb3IsIHNlbGVjdG9yKSB7CiAgICAgICAgdmlldy4kKCdbJyArIHNlbGVjdG9yICsgJ349IicgKyBhdHRyICsgJyJdJykKICAgICAgICAgICAgLmFkZENsYXNzKCdpbnZhbGlkJykKICAgICAgICAgICAgLmF0dHIoJ2RhdGEtZXJyb3InLCBlcnJvcik7CiAgICAgIH0KICAgIH07CiAgCiAgCiAgICAvLyBQYXR0ZXJucwogICAgLy8gLS0tLS0tLS0KICAKICAgIHZhciBkZWZhdWx0UGF0dGVybnMgPSBWYWxpZGF0aW9uLnBhdHRlcm5zID0gewogICAgICAvLyBNYXRjaGVzIGFueSBkaWdpdChzKSAoaS5lLiAwLTkpCiAgICAgIGRpZ2l0czogL15cZCskLywKICAKICAgICAgLy8gTWF0Y2hlZCBhbnkgbnVtYmVyIChlLmcuIDEwMC4wMDApCiAgICAgIG51bWJlcjogL14tPyg/OlxkK3xcZHsxLDN9KD86LFxkezN9KSspKD86XC5cZCspPyQvLAogIAogICAgICAvLyBNYXRjaGVzIGEgdmFsaWQgZW1haWwgYWRkcmVzcyAoZS5nLiBtYWlsQGV4YW1wbGUuY29tKQogICAgICBlbWFpbDogL14oKChbYS16XXxcZHxbISNcJCUmJ1wqXCtcLVwvPVw/XF5fYHtcfH1+XXxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkrKFwuKFthLXpdfFxkfFshI1wkJSYnXCpcK1wtXC89XD9cXl9ge1x8fX5dfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSspKil8KChceDIyKSgoKChceDIwfFx4MDkpKihceDBkXHgwYSkpPyhceDIwfFx4MDkpKyk/KChbXHgwMS1ceDA4XHgwYlx4MGNceDBlLVx4MWZceDdmXXxceDIxfFtceDIzLVx4NWJdfFtceDVkLVx4N2VdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoXFwoW1x4MDEtXHgwOVx4MGJceDBjXHgwZC1ceDdmXXxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkpKSkqKCgoXHgyMHxceDA5KSooXHgwZFx4MGEpKT8oXHgyMHxceDA5KSspPyhceDIyKSkpQCgoKFthLXpdfFxkfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoKFthLXpdfFxkfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKShbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkqKFthLXpdfFxkfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSkpXC4pKygoW2Etel18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCgoW2Etel18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKFthLXpdfFxkfC18XC58X3x+fFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSooW2Etel18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKSkkL2ksCiAgCiAgICAgIC8vIE1hdGhlcyBhbnkgdmFsaWQgdXJsIChlLmcuIGh0dHA6Ly93d3cueGFtcGxlLmNvbSkKICAgICAgdXJsOiAvXihodHRwcz98ZnRwKTpcL1wvKCgoKFthLXpdfFxkfC18XC58X3x+fFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoJVtcZGEtZl17Mn0pfFshXCQmJ1woXClcKlwrLDs9XXw6KSpAKT8oKChcZHxbMS05XVxkfDFcZFxkfDJbMC00XVxkfDI1WzAtNV0pXC4oXGR8WzEtOV1cZHwxXGRcZHwyWzAtNF1cZHwyNVswLTVdKVwuKFxkfFsxLTldXGR8MVxkXGR8MlswLTRdXGR8MjVbMC01XSlcLihcZHxbMS05XVxkfDFcZFxkfDJbMC00XVxkfDI1WzAtNV0pKXwoKChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKihbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkpKVwuKSsoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKShbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkqKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSkpXC4/KSg6XGQqKT8pKFwvKCgoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCglW1xkYS1mXXsyfSl8WyFcJCYnXChcKVwqXCssOz1dfDp8QCkrKFwvKChbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KCVbXGRhLWZdezJ9KXxbIVwkJidcKFwpXCpcKyw7PV18OnxAKSopKik/KT8oXD8oKChbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KCVbXGRhLWZdezJ9KXxbIVwkJidcKFwpXCpcKyw7PV18OnxAKXxbXHVFMDAwLVx1RjhGRl18XC98XD8pKik/KFwjKCgoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCglW1xkYS1mXXsyfSl8WyFcJCYnXChcKVwqXCssOz1dfDp8QCl8XC98XD8pKik/JC9pCiAgICB9OwogIAogIAogICAgLy8gRXJyb3IgbWVzc2FnZXMKICAgIC8vIC0tLS0tLS0tLS0tLS0tCiAgCiAgICAvLyBFcnJvciBtZXNzYWdlIGZvciB0aGUgYnVpbGQgaW4gdmFsaWRhdG9ycy4KICAgIC8vIHt4fSBnZXRzIHN3YXBwZWQgb3V0IHdpdGggYXJndW1lbnRzIGZvcm0gdGhlIHZhbGlkYXRvci4KICAgIHZhciBkZWZhdWx0TWVzc2FnZXMgPSBWYWxpZGF0aW9uLm1lc3NhZ2VzID0gewogICAgICByZXF1aXJlZDogJ3swfSBpcyByZXF1aXJlZCcsCiAgICAgIGFjY2VwdGFuY2U6ICd7MH0gbXVzdCBiZSBhY2NlcHRlZCcsCiAgICAgIG1pbjogJ3swfSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byB7MX0nLAogICAgICBtYXg6ICd7MH0gbXVzdCBiZSBsZXNzIHRoYW4gb3IgZXF1YWwgdG8gezF9JywKICAgICAgcmFuZ2U6ICd7MH0gbXVzdCBiZSBiZXR3ZWVuIHsxfSBhbmQgezJ9JywKICAgICAgbGVuZ3RoOiAnezB9IG11c3QgYmUgezF9IGNoYXJhY3RlcnMnLAogICAgICBtaW5MZW5ndGg6ICd7MH0gbXVzdCBiZSBhdCBsZWFzdCB7MX0gY2hhcmFjdGVycycsCiAgICAgIG1heExlbmd0aDogJ3swfSBtdXN0IGJlIGF0IG1vc3QgezF9IGNoYXJhY3RlcnMnLAogICAgICByYW5nZUxlbmd0aDogJ3swfSBtdXN0IGJlIGJldHdlZW4gezF9IGFuZCB7Mn0gY2hhcmFjdGVycycsCiAgICAgIG9uZU9mOiAnezB9IG11c3QgYmUgb25lIG9mOiB7MX0nLAogICAgICBlcXVhbFRvOiAnezB9IG11c3QgYmUgdGhlIHNhbWUgYXMgezF9JywKICAgICAgcGF0dGVybjogJ3swfSBtdXN0IGJlIGEgdmFsaWQgezF9JwogICAgfTsKICAKICAgIC8vIExhYmVsIGZvcm1hdHRlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0KICAKICAgIC8vIExhYmVsIGZvcm1hdHRlcnMgYXJlIHVzZWQgdG8gY29udmVydCB0aGUgYXR0cmlidXRlIG5hbWUKICAgIC8vIHRvIGEgbW9yZSBodW1hbiBmcmllbmRseSBsYWJlbCB3aGVuIHVzaW5nIHRoZSBidWlsdCBpbgogICAgLy8gZXJyb3IgbWVzc2FnZXMuCiAgICAvLyBDb25maWd1cmUgd2hpY2ggb25lIHRvIHVzZSB3aXRoIGEgY2FsbCB0bwogICAgLy8KICAgIC8vICAgICBCYWNrYm9uZS5WYWxpZGF0aW9uLmNvbmZpZ3VyZSh7CiAgICAvLyAgICAgICBsYWJlbEZvcm1hdHRlcjogJ2xhYmVsJwogICAgLy8gICAgIH0pOwogICAgdmFyIGRlZmF1bHRMYWJlbEZvcm1hdHRlcnMgPSBWYWxpZGF0aW9uLmxhYmVsRm9ybWF0dGVycyA9IHsKICAKICAgICAgLy8gUmV0dXJucyB0aGUgYXR0cmlidXRlIG5hbWUgd2l0aCBhcHBseWluZyBhbnkgZm9ybWF0dGluZwogICAgICBub25lOiBmdW5jdGlvbihhdHRyTmFtZSkgewogICAgICAgIHJldHVybiBhdHRyTmFtZTsKICAgICAgfSwKICAKICAgICAgLy8gQ29udmVydHMgYXR0cmlidXRlTmFtZSBvciBhdHRyaWJ1dGVfbmFtZSB0byBBdHRyaWJ1dGUgbmFtZQogICAgICBzZW50ZW5jZUNhc2U6IGZ1bmN0aW9uKGF0dHJOYW1lKSB7CiAgICAgICAgcmV0dXJuIGF0dHJOYW1lLnJlcGxhY2UoLyg/Ol5cd3xbQS1aXXxcYlx3KS9nLCBmdW5jdGlvbihtYXRjaCwgaW5kZXgpIHsKICAgICAgICAgIHJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvVXBwZXJDYXNlKCkgOiAnICcgKyBtYXRjaC50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pLnJlcGxhY2UoL18vZywgJyAnKTsKICAgICAgfSwKICAKICAgICAgLy8gTG9va3MgZm9yIGEgbGFiZWwgY29uZmlndXJlZCBvbiB0aGUgbW9kZWwgYW5kIHJldHVybnMgaXQKICAgICAgLy8KICAgICAgLy8gICAgICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewogICAgICAvLyAgICAgICAgdmFsaWRhdGlvbjogewogICAgICAvLyAgICAgICAgICBzb21lQXR0cmlidXRlOiB7CiAgICAgIC8vICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgLy8gICAgICAgICAgfQogICAgICAvLyAgICAgICAgfSwKICAgICAgLy8KICAgICAgLy8gICAgICAgIGxhYmVsczogewogICAgICAvLyAgICAgICAgICBzb21lQXR0cmlidXRlOiAnQ3VzdG9tIGxhYmVsJwogICAgICAvLyAgICAgICAgfQogICAgICAvLyAgICAgIH0pOwogICAgICBsYWJlbDogZnVuY3Rpb24oYXR0ck5hbWUsIG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIChtb2RlbC5sYWJlbHMgJiYgbW9kZWwubGFiZWxzW2F0dHJOYW1lXSkgfHwgZGVmYXVsdExhYmVsRm9ybWF0dGVycy5zZW50ZW5jZUNhc2UoYXR0ck5hbWUsIG1vZGVsKTsKICAgICAgfQogICAgfTsKICAKICAKICAgIC8vIEJ1aWx0IGluIHZhbGlkYXRvcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KICAKICAgIHZhciBkZWZhdWx0VmFsaWRhdG9ycyA9IFZhbGlkYXRpb24udmFsaWRhdG9ycyA9IChmdW5jdGlvbigpewogICAgICAvLyBVc2UgbmF0aXZlIHRyaW0gd2hlbiBkZWZpbmVkCiAgICAgIHZhciB0cmltID0gU3RyaW5nLnByb3RvdHlwZS50cmltID8KICAgICAgICBmdW5jdGlvbih0ZXh0KSB7CiAgICAgICAgICByZXR1cm4gdGV4dCA9PT0gbnVsbCA/ICcnIDogU3RyaW5nLnByb3RvdHlwZS50cmltLmNhbGwodGV4dCk7CiAgICAgICAgfSA6CiAgICAgICAgZnVuY3Rpb24odGV4dCkgewogICAgICAgICAgdmFyIHRyaW1MZWZ0ID0gL15ccysvLAogICAgICAgICAgICAgIHRyaW1SaWdodCA9IC9ccyskLzsKICAKICAgICAgICAgIHJldHVybiB0ZXh0ID09PSBudWxsID8gJycgOiB0ZXh0LnRvU3RyaW5nKCkucmVwbGFjZSh0cmltTGVmdCwgJycpLnJlcGxhY2UodHJpbVJpZ2h0LCAnJyk7CiAgICAgICAgfTsKICAKICAgICAgLy8gRGV0ZXJtaW5lcyB3aGV0aGVyIG9yIG5vdCBhIHZhbHVlIGlzIGEgbnVtYmVyCiAgICAgIHZhciBpc051bWJlciA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICByZXR1cm4gXy5pc051bWJlcih2YWx1ZSkgfHwgKF8uaXNTdHJpbmcodmFsdWUpICYmIHZhbHVlLm1hdGNoKGRlZmF1bHRQYXR0ZXJucy5udW1iZXIpKTsKICAgICAgfTsKICAKICAgICAgLy8gRGV0ZXJtaW5lcyB3aGV0aGVyIG9yIG5vdCBhIHZhbHVlIGlzIGVtcHR5CiAgICAgIHZhciBoYXNWYWx1ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuICEoXy5pc051bGwodmFsdWUpIHx8IF8uaXNVbmRlZmluZWQodmFsdWUpIHx8IChfLmlzU3RyaW5nKHZhbHVlKSAmJiB0cmltKHZhbHVlKSA9PT0gJycpIHx8IChfLmlzQXJyYXkodmFsdWUpICYmIF8uaXNFbXB0eSh2YWx1ZSkpKTsKICAgICAgfTsKICAKICAgICAgcmV0dXJuIHsKICAgICAgICAvLyBGdW5jdGlvbiB2YWxpZGF0b3IKICAgICAgICAvLyBMZXRzIHlvdSBpbXBsZW1lbnQgYSBjdXN0b20gZnVuY3Rpb24gdXNlZCBmb3IgdmFsaWRhdGlvbgogICAgICAgIGZuOiBmdW5jdGlvbih2YWx1ZSwgYXR0ciwgZm4sIG1vZGVsLCBjb21wdXRlZCkgewogICAgICAgICAgaWYoXy5pc1N0cmluZyhmbikpewogICAgICAgICAgICBmbiA9IG1vZGVsW2ZuXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbi5jYWxsKG1vZGVsLCB2YWx1ZSwgYXR0ciwgY29tcHV0ZWQpOwogICAgICAgIH0sCiAgCiAgICAgICAgLy8gUmVxdWlyZWQgdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIGlmIHRoZSBhdHRyaWJ1dGUgaXMgcmVxdWlyZWQgb3Igbm90CiAgICAgICAgcmVxdWlyZWQ6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCByZXF1aXJlZCwgbW9kZWwsIGNvbXB1dGVkKSB7CiAgICAgICAgICB2YXIgaXNSZXF1aXJlZCA9IF8uaXNGdW5jdGlvbihyZXF1aXJlZCkgPyByZXF1aXJlZC5jYWxsKG1vZGVsLCB2YWx1ZSwgYXR0ciwgY29tcHV0ZWQpIDogcmVxdWlyZWQ7CiAgICAgICAgICBpZighaXNSZXF1aXJlZCAmJiAhaGFzVmFsdWUodmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gb3ZlcnJpZGVzIGFsbCBvdGhlciB2YWxpZGF0b3JzCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNSZXF1aXJlZCAmJiAhaGFzVmFsdWUodmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdChkZWZhdWx0TWVzc2FnZXMucmVxdWlyZWQsIHRoaXMuZm9ybWF0TGFiZWwoYXR0ciwgbW9kZWwpKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIC8vIEFjY2VwdGFuY2UgdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgc29tZXRoaW5nIGhhcyB0byBiZSBhY2NlcHRlZCwgZS5nLiB0ZXJtcyBvZiB1c2UKICAgICAgICAvLyBgdHJ1ZWAgb3IgJ3RydWUnIGFyZSB2YWxpZAogICAgICAgIGFjY2VwdGFuY2U6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCBhY2NlcHQsIG1vZGVsKSB7CiAgICAgICAgICBpZih2YWx1ZSAhPT0gJ3RydWUnICYmICghXy5pc0Jvb2xlYW4odmFsdWUpIHx8IHZhbHVlID09PSBmYWxzZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0KGRlZmF1bHRNZXNzYWdlcy5hY2NlcHRhbmNlLCB0aGlzLmZvcm1hdExhYmVsKGF0dHIsIG1vZGVsKSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICAvLyBNaW4gdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgdGhlIHZhbHVlIGhhcyB0byBiZSBhIG51bWJlciBhbmQgZXF1YWwgdG8gb3IgZ3JlYXRlciB0aGFuCiAgICAgICAgLy8gdGhlIG1pbiB2YWx1ZSBzcGVjaWZpZWQKICAgICAgICBtaW46IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCBtaW5WYWx1ZSwgbW9kZWwpIHsKICAgICAgICAgIGlmICghaXNOdW1iZXIodmFsdWUpIHx8IHZhbHVlIDwgbWluVmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0KGRlZmF1bHRNZXNzYWdlcy5taW4sIHRoaXMuZm9ybWF0TGFiZWwoYXR0ciwgbW9kZWwpLCBtaW5WYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICAvLyBNYXggdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgdGhlIHZhbHVlIGhhcyB0byBiZSBhIG51bWJlciBhbmQgZXF1YWwgdG8gb3IgbGVzcyB0aGFuCiAgICAgICAgLy8gdGhlIG1heCB2YWx1ZSBzcGVjaWZpZWQKICAgICAgICBtYXg6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCBtYXhWYWx1ZSwgbW9kZWwpIHsKICAgICAgICAgIGlmICghaXNOdW1iZXIodmFsdWUpIHx8IHZhbHVlID4gbWF4VmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0KGRlZmF1bHRNZXNzYWdlcy5tYXgsIHRoaXMuZm9ybWF0TGFiZWwoYXR0ciwgbW9kZWwpLCBtYXhWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICAvLyBSYW5nZSB2YWxpZGF0b3IKICAgICAgICAvLyBWYWxpZGF0ZXMgdGhhdCB0aGUgdmFsdWUgaGFzIHRvIGJlIGEgbnVtYmVyIGFuZCBlcXVhbCB0byBvciBiZXR3ZWVuCiAgICAgICAgLy8gdGhlIHR3byBudW1iZXJzIHNwZWNpZmllZAogICAgICAgIHJhbmdlOiBmdW5jdGlvbih2YWx1ZSwgYXR0ciwgcmFuZ2UsIG1vZGVsKSB7CiAgICAgICAgICBpZighaXNOdW1iZXIodmFsdWUpIHx8IHZhbHVlIDwgcmFuZ2VbMF0gfHwgdmFsdWUgPiByYW5nZVsxXSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXQoZGVmYXVsdE1lc3NhZ2VzLnJhbmdlLCB0aGlzLmZvcm1hdExhYmVsKGF0dHIsIG1vZGVsKSwgcmFuZ2VbMF0sIHJhbmdlWzFdKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIC8vIExlbmd0aCB2YWxpZGF0b3IKICAgICAgICAvLyBWYWxpZGF0ZXMgdGhhdCB0aGUgdmFsdWUgaGFzIHRvIGJlIGEgc3RyaW5nIHdpdGggbGVuZ3RoIGVxdWFsIHRvCiAgICAgICAgLy8gdGhlIGxlbmd0aCB2YWx1ZSBzcGVjaWZpZWQKICAgICAgICBsZW5ndGg6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCBsZW5ndGgsIG1vZGVsKSB7CiAgICAgICAgICBpZiAoIWhhc1ZhbHVlKHZhbHVlKSB8fCB0cmltKHZhbHVlKS5sZW5ndGggIT09IGxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXQoZGVmYXVsdE1lc3NhZ2VzLmxlbmd0aCwgdGhpcy5mb3JtYXRMYWJlbChhdHRyLCBtb2RlbCksIGxlbmd0aCk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICAvLyBNaW4gbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIC8vIFZhbGlkYXRlcyB0aGF0IHRoZSB2YWx1ZSBoYXMgdG8gYmUgYSBzdHJpbmcgd2l0aCBsZW5ndGggZXF1YWwgdG8gb3IgZ3JlYXRlciB0aGFuCiAgICAgICAgLy8gdGhlIG1pbiBsZW5ndGggdmFsdWUgc3BlY2lmaWVkCiAgICAgICAgbWluTGVuZ3RoOiBmdW5jdGlvbih2YWx1ZSwgYXR0ciwgbWluTGVuZ3RoLCBtb2RlbCkgewogICAgICAgICAgaWYgKCFoYXNWYWx1ZSh2YWx1ZSkgfHwgdHJpbSh2YWx1ZSkubGVuZ3RoIDwgbWluTGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdChkZWZhdWx0TWVzc2FnZXMubWluTGVuZ3RoLCB0aGlzLmZvcm1hdExhYmVsKGF0dHIsIG1vZGVsKSwgbWluTGVuZ3RoKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIC8vIE1heCBsZW5ndGggdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgdGhlIHZhbHVlIGhhcyB0byBiZSBhIHN0cmluZyB3aXRoIGxlbmd0aCBlcXVhbCB0byBvciBsZXNzIHRoYW4KICAgICAgICAvLyB0aGUgbWF4IGxlbmd0aCB2YWx1ZSBzcGVjaWZpZWQKICAgICAgICBtYXhMZW5ndGg6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCBtYXhMZW5ndGgsIG1vZGVsKSB7CiAgICAgICAgICBpZiAoIWhhc1ZhbHVlKHZhbHVlKSB8fCB0cmltKHZhbHVlKS5sZW5ndGggPiBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0KGRlZmF1bHRNZXNzYWdlcy5tYXhMZW5ndGgsIHRoaXMuZm9ybWF0TGFiZWwoYXR0ciwgbW9kZWwpLCBtYXhMZW5ndGgpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgLy8gUmFuZ2UgbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIC8vIFZhbGlkYXRlcyB0aGF0IHRoZSB2YWx1ZSBoYXMgdG8gYmUgYSBzdHJpbmcgYW5kIGVxdWFsIHRvIG9yIGJldHdlZW4KICAgICAgICAvLyB0aGUgdHdvIG51bWJlcnMgc3BlY2lmaWVkCiAgICAgICAgcmFuZ2VMZW5ndGg6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCByYW5nZSwgbW9kZWwpIHsKICAgICAgICAgIGlmKCFoYXNWYWx1ZSh2YWx1ZSkgfHwgdHJpbSh2YWx1ZSkubGVuZ3RoIDwgcmFuZ2VbMF0gfHwgdHJpbSh2YWx1ZSkubGVuZ3RoID4gcmFuZ2VbMV0pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0KGRlZmF1bHRNZXNzYWdlcy5yYW5nZUxlbmd0aCwgdGhpcy5mb3JtYXRMYWJlbChhdHRyLCBtb2RlbCksIHJhbmdlWzBdLCByYW5nZVsxXSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICAvLyBPbmUgb2YgdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgdGhlIHZhbHVlIGhhcyB0byBiZSBlcXVhbCB0byBvbmUgb2YgdGhlIGVsZW1lbnRzIGluCiAgICAgICAgLy8gdGhlIHNwZWNpZmllZCBhcnJheS4gQ2FzZSBzZW5zaXRpdmUgbWF0Y2hpbmcKICAgICAgICBvbmVPZjogZnVuY3Rpb24odmFsdWUsIGF0dHIsIHZhbHVlcywgbW9kZWwpIHsKICAgICAgICAgIGlmKCFfLmluY2x1ZGUodmFsdWVzLCB2YWx1ZSkpewogICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXQoZGVmYXVsdE1lc3NhZ2VzLm9uZU9mLCB0aGlzLmZvcm1hdExhYmVsKGF0dHIsIG1vZGVsKSwgdmFsdWVzLmpvaW4oJywgJykpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgLy8gRXF1YWwgdG8gdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgdGhlIHZhbHVlIGhhcyB0byBiZSBlcXVhbCB0byB0aGUgdmFsdWUgb2YgdGhlIGF0dHJpYnV0ZQogICAgICAgIC8vIHdpdGggdGhlIG5hbWUgc3BlY2lmaWVkCiAgICAgICAgZXF1YWxUbzogZnVuY3Rpb24odmFsdWUsIGF0dHIsIGVxdWFsVG8sIG1vZGVsLCBjb21wdXRlZCkgewogICAgICAgICAgaWYodmFsdWUgIT09IGNvbXB1dGVkW2VxdWFsVG9dKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdChkZWZhdWx0TWVzc2FnZXMuZXF1YWxUbywgdGhpcy5mb3JtYXRMYWJlbChhdHRyLCBtb2RlbCksIHRoaXMuZm9ybWF0TGFiZWwoZXF1YWxUbywgbW9kZWwpKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIC8vIFBhdHRlcm4gdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgdGhlIHZhbHVlIGhhcyB0byBtYXRjaCB0aGUgcGF0dGVybiBzcGVjaWZpZWQuCiAgICAgICAgLy8gQ2FuIGJlIGEgcmVndWxhciBleHByZXNzaW9uIG9yIHRoZSBuYW1lIG9mIG9uZSBvZiB0aGUgYnVpbHQgaW4gcGF0dGVybnMKICAgICAgICBwYXR0ZXJuOiBmdW5jdGlvbih2YWx1ZSwgYXR0ciwgcGF0dGVybiwgbW9kZWwpIHsKICAgICAgICAgIGlmICghaGFzVmFsdWUodmFsdWUpIHx8ICF2YWx1ZS50b1N0cmluZygpLm1hdGNoKGRlZmF1bHRQYXR0ZXJuc1twYXR0ZXJuXSB8fCBwYXR0ZXJuKSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXQoZGVmYXVsdE1lc3NhZ2VzLnBhdHRlcm4sIHRoaXMuZm9ybWF0TGFiZWwoYXR0ciwgbW9kZWwpLCBwYXR0ZXJuKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9KCkpOwogIAogICAgcmV0dXJuIFZhbGlkYXRpb247CiAgfShfKSk7CiAgcmV0dXJuIEJhY2tib25lLlZhbGlkYXRpb247Cn0pKTsKCi8qIFNUQVJUX1RFTVBMQVRFICovCmRlZmluZSgnaGJzIWNoaXJvcHJhY3Rvci92aWV3cy90ZW1wbGF0ZXMvZXJyb3IvbW9kZWxmZXRjaCcsWydoYnMnLCdoYW5kbGViYXJzJ10sIGZ1bmN0aW9uKCBoYnMsIEhhbmRsZWJhcnMgKXsgCnZhciB0ID0gSGFuZGxlYmFycy50ZW1wbGF0ZShmdW5jdGlvbiAoSGFuZGxlYmFycyxkZXB0aDAsaGVscGVycyxwYXJ0aWFscyxkYXRhKSB7CiAgaGVscGVycyA9IGhlbHBlcnMgfHwgSGFuZGxlYmFycy5oZWxwZXJzOwogIHZhciBzdGFjazEsIHN0YWNrMiwgZm91bmRIZWxwZXIsIGhlbHBlck1pc3Npbmc9aGVscGVycy5oZWxwZXJNaXNzaW5nLCBlc2NhcGVFeHByZXNzaW9uPXRoaXMuZXNjYXBlRXhwcmVzc2lvbjsKCgogIHN0YWNrMSA9IHt9OwogIHN0YWNrMiA9IGRlcHRoMC5yZXNwb25zZTsKICBzdGFjazFbJ3Jlc3BvbnNlJ10gPSBzdGFjazI7CiAgc3RhY2syID0gZGVwdGgwLnVybDsKICBzdGFjazFbJ3VybCddID0gc3RhY2syOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5yb3c7CiAgc3RhY2sxID0gZm91bmRIZWxwZXIgPyBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwgImVycm9yIiwgZGVwdGgwLCB7aGFzaDpzdGFjazF9KSA6IGhlbHBlck1pc3NpbmcuY2FsbChkZXB0aDAsICJyb3ciLCAiZXJyb3IiLCBkZXB0aDAsIHtoYXNoOnN0YWNrMX0pOwogIHJldHVybiBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSk7fSk7CkhhbmRsZWJhcnMucmVnaXN0ZXJQYXJ0aWFsKCdjaGlyb3ByYWN0b3Jfdmlld3NfdGVtcGxhdGVzX2Vycm9yX21vZGVsZmV0Y2gnLCB0KTsKcmV0dXJuIHQ7Cn0pOwovKiBFTkRfVEVNUExBVEUgKi8KOwovKmdsb2JhbCBkZWZpbmUsc2V0VGltZW91dCxjbGVhclRpbWVvdXQqLwpkZWZpbmUoJ2NoaXJvcHJhY3Rvci9tb2RlbHMnLFsncmVxdWlyZScsJ2pxdWVyeS5jb3JzL2pxdWVyeS5jb3JzJywnYmFja2JvbmUnLCd1bmRlcnNjb3JlJywnanNvbi1pZTcnLCdqcXVlcnknLCcuL21vZGVscy9hdXRoJywnYmFja2JvbmUuZGVlcC5tb2RlbCcsJ2JhY2tib25lLnZhbGlkYXRpb24nLCdoYnMhLi92aWV3cy90ZW1wbGF0ZXMvZXJyb3IvbW9kZWxmZXRjaCcsJ3VuZGVyc2NvcmUubWl4aW4uZGVlcGV4dGVuZCddLGZ1bmN0aW9uIChyZXF1aXJlKSB7CiAgCgogIHJlcXVpcmUoJ2pxdWVyeS5jb3JzL2pxdWVyeS5jb3JzJyk7CgoKICB2YXIgQmFja2JvbmUgPSByZXF1aXJlKCdiYWNrYm9uZScpLAogICAgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKICAgIEpTT04gPSByZXF1aXJlKCdqc29uLWllNycpLAogICAgJCA9IHJlcXVpcmUoJ2pxdWVyeScpLAogICAgYXV0aCA9IHJlcXVpcmUoJy4vbW9kZWxzL2F1dGgnKSwKICAgIEJhY2tib25lRGVlcE1vZGVsID0gcmVxdWlyZSgnYmFja2JvbmUuZGVlcC5tb2RlbCcpLAogICAgVmFsaWRhdGlvbiA9IHJlcXVpcmUoJ2JhY2tib25lLnZhbGlkYXRpb24nKSwKICAgIFRlbXBsYXRlRXJyb3IgPSByZXF1aXJlKCdoYnMhLi92aWV3cy90ZW1wbGF0ZXMvZXJyb3IvbW9kZWxmZXRjaCcpLAogICAgQmFzZSwKICAgIFJldmlzaW9uLAogICAgVXNlckFnZW50LAogICAgUmVnRXhwcmVzc2lvbiwKICAgIEFTU0VUU19CQVNFX1VSTDsKCiAgLy8gQWRkIFdpc2VyIHNwZWNpZmljIHNldHRpbmdzIElzc3VlICMzMQoKICBpZih3aW5kb3cgJiYgd2luZG93Lldpc2VyICYmIHdpbmRvdy5XaXNlci5BU1NFVFNfQkFTRV9VUkwpIHsKICAgIEFTU0VUU19CQVNFX1VSTCA9IHdpbmRvdy5XaXNlci5BU1NFVFNfQkFTRV9VUkw7CiAgfSBlbHNlIHsKICAgIEFTU0VUU19CQVNFX1VSTCA9ICcnOwogIH0KCiAgcmVxdWlyZSgndW5kZXJzY29yZS5taXhpbi5kZWVwZXh0ZW5kJyk7CgogIEJhc2UgPSBCYWNrYm9uZURlZXBNb2RlbC5EZWVwTW9kZWwuZXh0ZW5kKHsKICAgIGVycm9ySGFuZGxlcjogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgdmFyIGVycm9yTWVzc2FnZTsKICAgICAgc3dpdGNoKHJlc3BvbnNlLnN0YXR1cykgewogICAgICAgIGNhc2UgMDoKICAgICAgICAgIGVycm9yTWVzc2FnZSA9ICJUaGUgQVBJIHdhcyB1bnJlYWNoYWJsZSI7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDUwMzoKICAgICAgICAgIGVycm9yTWVzc2FnZSA9ICJUaGVyZSB3YXMgYW4gRXJyb3IgQ29tbXVuaWNhdGluZyB3aXRoIHRoZSBBUEkiOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICB9CiAgICAgICQoJ2JvZHknKS5iZWZvcmUoVGVtcGxhdGVFcnJvcih7IHVybDogdGhpcy51cmwgLCAgZXJyb3JNZXNzYWdlOiBlcnJvck1lc3NhZ2UsIHJlc3BvbnNlOiByZXNwb25zZSB9KSk7CiAgICB9LAogICAgc3VjY2Vzc0hhbmRsZXI6IGZ1bmN0aW9uKG1vZGVsLCByZXNwb25zZSwgb3B0aW9ucykgewogICAgfSwKICAgIHN5bmM6IGZ1bmN0aW9uIChtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIC8vIFNldHVwIHRoZSBhdXRoZW50aWNhdGlvbiBoYW5kbGVycyBmb3IgdGhlIEJhc2VNb2RlbAogICAgICAvLwoKICAgICAgYXV0aC5zeW5jLmNhbGwodGhpcywgbWV0aG9kLCBtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgIGNhc2UgJ3JlYWQnOgogICAgICAgIC8vRW1wdHkgdGhlIGVycm9yIG1lc3NhZ2UgYm94IGZvciBvdGhlciBmZXRjaGVzCiAgICAgICAgJCgnI2NoaXJvcHJhY3Rvci1lcnJvci1ib3gnKS5lbXB0eSgpOwogICAgICAgIGlmICh0aGlzLmVuYWJsZUVycm9ySGFuZGxlcikgewogICAgICAgICAgb3B0aW9ucy5lcnJvciA9IHRoaXMuZXJyb3JIYW5kbGVyOwogICAgICAgICAgLy8gVGltZW91dCBzZXQgdG8gMzAgc2Vjb25kcy4KICAgICAgICAgIG9wdGlvbnMudGltZW91dCA9IDMwMDAwOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAndXBkYXRlJzoKICAgICAgICAvLyBSZW1vdmUgV2lzZXIgc3BlY2lmaWMgc2V0dGluZ3MgSXNzdWUgIzMxCiAgICAgICAgbW9kZWwudW5zZXQoJ1dpc2VyJyk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgIH0KICAgICAgcmV0dXJuIEJhY2tib25lLk1vZGVsLnByb3RvdHlwZS5zeW5jLmNhbGwoCiAgICAgICAgdGhpcywgbWV0aG9kLCBtb2RlbCwgb3B0aW9ucwogICAgICApOwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbiAocmVzcCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgLy8gV2UgbmVlZCB0byB1bndyYXAgdGhlIG9sZCBXaXNlclRvZ2V0aGVyIEFQSSBlbnZlbG9wIGZvcm1hdC4KICAgICAgaWYgKHJlc3AuZGF0YSAmJiByZXNwLm1ldGEpIHsKICAgICAgICBpZiAocGFyc2VJbnQocmVzcC5tZXRhLnN0YXR1cywgMTApID49IDQwMCkgewogICAgICAgICAgb3B0aW9ucy5sZWdhY3lFcnJvciA9IHRydWU7CiAgICAgICAgICBpZiAocmVzcC5tZXRhLmVycm9ycyAmJiByZXNwLm1ldGEuZXJyb3JzLmZvcm0pIHsKICAgICAgICAgICAgdGhpcy52YWxpZGF0aW9uRXJyb3IgPSByZXNwLm1ldGEuZXJyb3JzLmZvcm07CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcigKICAgICAgICAgICAgICAnaW52YWxpZCcsCiAgICAgICAgICAgICAgdGhpcywKICAgICAgICAgICAgICB0aGlzLnZhbGlkYXRpb25FcnJvciwKICAgICAgICAgICAgICBfLmV4dGVuZChvcHRpb25zIHx8IHt9LCB7CiAgICAgICAgICAgICAgICB2YWxpZGF0aW9uRXJyb3I6IHRoaXMudmFsaWRhdGlvbkVycm9yCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCB0aGlzLCByZXNwLmRhdGEsIG9wdGlvbnMpOwoKICAgICAgICAgICAgaWYgKG9wdGlvbnMuZXJyb3IpIHsKICAgICAgICAgICAgICBvcHRpb25zLmVycm9yKHRoaXMsIHJlc3AuZGF0YSwgb3B0aW9ucyk7CgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBXZSBkbyBub3Qgd2FudCBhbiBlcnJvciByZXNwb25zZSB0byB1cGRhdGUgdGhlIG1vZGVsCiAgICAgICAgICAvLyBhdHRyaWJ1dGVzIChyZXR1cm5pbmcgYW4gZW1wdHkgb2JqZWN0IGxlYXZlcyB0aGUgbW9kZWwKICAgICAgICAgIC8vIHN0YXRlIGFzIGl0IHdhcwogICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgIH0KCiAgICAgICAgLy8gQWRkIFdpc2VyIHNwZWNpZmljIHNldHRpbmdzIElzc3VlICMzMQogICAgICAgIHJlc3AuV2lzZXIgPSB7fTsKICAgICAgICByZXNwLldpc2VyLkFTU0VUU19CQVNFX1VSTCA9IEFTU0VUU19CQVNFX1VSTDsKCiAgICAgICAgcmV0dXJuIHJlc3AuZGF0YTsKICAgICAgfQoKICAgICAgLy8gQWRkIFdpc2VyIHNwZWNpZmljIHNldHRpbmdzIElzc3VlICMzMQogICAgICByZXNwLldpc2VyID0ge307CiAgICAgIHJlc3AuV2lzZXIuQVNTRVRTX0JBU0VfVVJMID0gQVNTRVRTX0JBU0VfVVJMOwoKICAgICAgcmV0dXJuIEJhY2tib25lLk1vZGVsLnByb3RvdHlwZS5wYXJzZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICBmaWVsZElkOiBmdW5jdGlvbiAoZmllbGQsIHByZWZpeCkgewogICAgICBwcmVmaXggPSBwcmVmaXggfHwgJ2Zvcm1maWVsZCc7CiAgICAgIHJldHVybiBbcHJlZml4LCBmaWVsZCwgdGhpcy5jaWRdLmpvaW4oJy0nKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAoYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgLy8gV2UgbmVlZCB0byBhbGxvdyB0aGUgbGVnYWN5IGVycm9ycyB0byBzaG9ydCBjaXJjdWl0IHRoZSBCYWNrYm9uZQogICAgICAvLyBzdWNjZXNzIGhhbmRsZXIgaW4gdGhlIGNhc2Ugb2YgYSBsZWdhY3kgc2VydmVyIGVycm9yLgogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmxlZ2FjeUVycm9yKSB7CiAgICAgICAgZGVsZXRlIG9wdGlvbnMubGVnYWN5RXJyb3I7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiBCYWNrYm9uZURlZXBNb2RlbC5EZWVwTW9kZWwucHJvdG90eXBlLnNldC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0pOwoKICBfLmV4dGVuZChCYXNlLnByb3RvdHlwZSwgVmFsaWRhdGlvbi5taXhpbik7CgogIHJldHVybiB7CiAgICBCYXNlOiBCYXNlLAogICAgY2xlYW51cDogYXV0aC5jbGVhbnVwCiAgfTsKfSk7Ci8qZ2xvYmFsIGRlZmluZSovCmRlZmluZSgnY2hpcm9wcmFjdG9yL2NvbGxlY3Rpb25zJyxbJ3JlcXVpcmUnLCdqcXVlcnkuY29ycy9qcXVlcnkuY29ycycsJ2JhY2tib25lJywndW5kZXJzY29yZScsJ2pxdWVyeScsJ2hicyEuL3ZpZXdzL3RlbXBsYXRlcy9lcnJvci9tb2RlbGZldGNoJywndW5kZXJzY29yZS5taXhpbi5kZWVwZXh0ZW5kJ10sZnVuY3Rpb24gKHJlcXVpcmUpIHsKICAKCiAgcmVxdWlyZSgnanF1ZXJ5LmNvcnMvanF1ZXJ5LmNvcnMnKTsKCgogIHZhciBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyksCiAgICBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpLAogICAgQmFzZSwKICAgICQgPSByZXF1aXJlKCdqcXVlcnknKSwKICAgIFRlbXBsYXRlRXJyb3IgPSByZXF1aXJlKCdoYnMhLi92aWV3cy90ZW1wbGF0ZXMvZXJyb3IvbW9kZWxmZXRjaCcpLAogICAgQVNTRVRTX0JBU0VfVVJMOwoKICAvLyBBZGQgV2lzZXIgc3BlY2lmaWMgc2V0dGluZ3MgSXNzdWUgIzMxCgogIGlmKHdpbmRvdyAmJiB3aW5kb3cuV2lzZXIgJiYgd2luZG93Lldpc2VyLkFTU0VUU19CQVNFX1VSTCkgewogICAgQVNTRVRTX0JBU0VfVVJMID0gd2luZG93Lldpc2VyLkFTU0VUU19CQVNFX1VSTDsKICB9IGVsc2UgewogICAgQVNTRVRTX0JBU0VfVVJMID0gJyc7CiAgfQoKICByZXF1aXJlKCd1bmRlcnNjb3JlLm1peGluLmRlZXBleHRlbmQnKTsKCiAgQmFzZSA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICAgIGVycm9ySGFuZGxlcjogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIHZhciBlcnJvck1lc3NhZ2U7CiAgICAgIHN3aXRjaCAocmVzcG9uc2Uuc3RhdHVzKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICBlcnJvck1lc3NhZ2UgPSAiVGhlIEFQSSB3YXMgdW5yZWFjaGFibGUiOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDUwMzoKICAgICAgICBlcnJvck1lc3NhZ2UgPSAiVGhlcmUgd2FzIGFuIEVycm9yIENvbW11bmljYXRpbmcgd2l0aCB0aGUgQVBJIjsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgfQogICAgICAkKCdib2R5JykuYmVmb3JlKFRlbXBsYXRlRXJyb3IoewogICAgICAgIHVybDogdGhpcy51cmwsCiAgICAgICAgZXJyb3JNZXNzYWdlOiBlcnJvck1lc3NhZ2UsCiAgICAgICAgcmVzcG9uc2U6IHJlc3BvbnNlCiAgICAgIH0pKTsKICAgIH0sCiAgICBzeW5jOiBmdW5jdGlvbiAobWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgICBzd2l0Y2ggKG1ldGhvZCkgewogICAgICBjYXNlICdyZWFkJzoKICAgICAgICAvL0VtcHR5IHRoZSBlcnJvciBtZXNzYWdlIGJveCBmb3Igb3RoZXIgZmV0Y2hlcwogICAgICAgICQoJyNjaGlyb3ByYWN0b3ItZXJyb3ItYm94JykuZW1wdHkoKTsKICAgICAgICBpZiAodGhpcy5lbmFibGVFcnJvckhhbmRsZXIpIHsKICAgICAgICAgIG9wdGlvbnMuZXJyb3IgPSB0aGlzLmVycm9ySGFuZGxlcjsKICAgICAgICAgIC8vIFRpbWVvdXQgc2V0IHRvIDMwIHNlY29uZHMuCiAgICAgICAgICBvcHRpb25zLnRpbWVvdXQgPSAzMDAwMDsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3VwZGF0ZSc6CiAgICAgICAgLy8gUmVtb3ZlIFdpc2VyIHNwZWNpZmljIHNldHRpbmdzIElzc3VlICMzMQogICAgICAgIG1vZGVsLnVuc2V0KCdXaXNlcicpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICB9CiAgICAgIHJldHVybiBCYWNrYm9uZS5Db2xsZWN0aW9uLnByb3RvdHlwZS5zeW5jLmNhbGwoCiAgICAgICAgdGhpcywgbWV0aG9kLCBtb2RlbCwgb3B0aW9ucwogICAgICApOwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbiAocmVzcCwgb3B0aW9ucykgewogICAgICAvLyBBZGQgV2lzZXIgc3BlY2lmaWMgc2V0dGluZ3MgSXNzdWUgIzMxCiAgICAgIHJlc3AuV2lzZXIgPSB7fTsKICAgICAgcmVzcC5XaXNlci5BU1NFVFNfQkFTRV9VUkwgPSBBU1NFVFNfQkFTRV9VUkw7CiAgICAgIHJldHVybiBCYWNrYm9uZS5Db2xsZWN0aW9uLnByb3RvdHlwZS5wYXJzZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0pOwoKICByZXR1cm4gewogICAgQmFzZTogQmFzZQogIH07Cn0pOwovKmdsb2JhbCBkZWZpbmUqLwpkZWZpbmUoJ2NoaXJvcHJhY3Rvci9yb3V0ZXJzJyxbJ3JlcXVpcmUnLCdiYWNrYm9uZSddLGZ1bmN0aW9uKHJlcXVpcmUpIHsKICAgIAoKICAgIHZhciBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyksCiAgICAgICAgQmFzZTsKCiAgICBCYXNlID0gQmFja2JvbmUuUm91dGVyLmV4dGVuZCh7CiAgICB9KTsKCiAgICByZXR1cm4gewogICAgICAgIEJhc2U6IEJhc2UKICAgIH07Cn0pOwoKLypnbG9iYWwgZGVmaW5lKi8KKGZ1bmN0aW9uKHdpbmRvdykgewogICAgCgogICAgZGVmaW5lKCdjaGlyb3ByYWN0b3IvYnJvd3NlcicsWydyZXF1aXJlJ10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgICAgIHZhciBpZVZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBydiA9IC0xOyAvLyBSZXR1cm4gdmFsdWUgYXNzdW1lcyBmYWlsdXJlLgogICAgICAgICAgICBpZiAod2luZG93Lm5hdmlnYXRvci5hcHBOYW1lID09PSAnTWljcm9zb2Z0IEludGVybmV0IEV4cGxvcmVyJykgewogICAgICAgICAgICAgICAgdmFyIHVhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7CiAgICAgICAgICAgICAgICB2YXIgcmUgPSBuZXcgUmVnRXhwKCJNU0lFIChbMC05XXsxLH1bLjAtOV17MCx9KSIpOwogICAgICAgICAgICAgICAgaWYgKHJlLmV4ZWModWEpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcnYgPSBwYXJzZUZsb2F0KFJlZ0V4cC4kMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJ2OwogICAgICAgIH0oKSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaXNPbGRJRTogaWVWZXJzaW9uICE9PSAtMSAmJiBpZVZlcnNpb24gPCA5LAogICAgICAgICAgICB3aW5kb3c6IHdpbmRvdywKICAgICAgICAgICAgbmF2aWdhdG9yOiB3aW5kb3cubmF2aWdhdG9yLAogICAgICAgICAgICBkb2N1bWVudDogd2luZG93LmRvY3VtZW50CiAgICAgICAgfTsKICAgIH0pOwp9KHRoaXMpKTsKCi8qZ2xvYmFsIGRlZmluZSxhbGVydCovCmRlZmluZSgnY2hpcm9wcmFjdG9yL2RlYnVnJyxbJ3JlcXVpcmUnLCdleHBvcnRzJywnbW9kdWxlJywnY2hpcm9wcmFjdG9yL2Jyb3dzZXInXSxmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBtb2R1bGUpIHsKICAgIHZhciB3aW5kb3cgPSByZXF1aXJlKCdjaGlyb3ByYWN0b3IvYnJvd3NlcicpLndpbmRvdywKICAgICAgICBjb25zb2xlID0gd2luZG93LmNvbnNvbGU7CgogICAgaWYgKHJlcXVpcmUuc3BlY2lmaWVkKCdjb25zb2xlJykpIHsKICAgICAgICByZXF1aXJlKFsnY29uc29sZSddLCBmdW5jdGlvbihtb2QpIHsKICAgICAgICAgICAgY29uc29sZSA9IG1vZDsKICAgICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0luc3BlY3Rvck9wZW4oKSB7CiAgICAgICAgaWYgKGNvbnNvbGUuZmlyZWJ1ZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoY29uc29sZS5wcm9maWxlKSB7CiAgICAgICAgICAgIGNvbnNvbGUucHJvZmlsZSgpOwogICAgICAgICAgICBjb25zb2xlLnByb2ZpbGVFbmQoKTsKICAgICAgICAgICAgaWYgKGNvbnNvbGUuY2xlYXIpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuY2xlYXIoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNvbnNvbGUucHJvZmlsZXMgJiYgY29uc29sZS5wcm9maWxlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCh3aW5kb3cub3V0ZXJIZWlnaHQgLSB3aW5kb3cuaW5uZXJIZWlnaHQpID4gMTAwKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmIChtb2R1bGUuY29uZmlnKCkuZW5hYmxlZCkgewogICAgICAgIHdpbmRvdy5vbmVycm9yID0gZnVuY3Rpb24obWVzc2FnZSwgdXJsLCBsaW5lbnVtYmVyKSB7CiAgICAgICAgICAgIGFsZXJ0KCJKYXZhU2NyaXB0IGVycm9yOiAiICsgbWVzc2FnZSArICIgb24gbGluZSAiICsgbGluZW51bWJlciArICIgZm9yICIgKyB1cmwpOwogICAgICAgIH07CiAgICB9Cn0pOwoKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCdjaGlyb3ByYWN0b3IvaGJzL2lmZXF1YWwnLFsncmVxdWlyZScsJ2hhbmRsZWJhcnMnXSxmdW5jdGlvbihyZXF1aXJlKSB7CiAgICAKCiAgICB2YXIgSGFuZGxlYmFycyA9IHJlcXVpcmUoJ2hhbmRsZWJhcnMnKTsKCiAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZmVxdWFsJywgZnVuY3Rpb24odmFsMSwgdmFsMiwgb3B0aW9ucykgewogICAgICAgIGlmICh2YWwxID09PSB2YWwyKSB7CiAgICAgICAgICAgIHJldHVybiBvcHRpb25zLmZuKHRoaXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBvcHRpb25zLmludmVyc2UodGhpcyk7CiAgICAgICAgfQogICAgfSk7Cn0pOwoKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCdjaGlyb3ByYWN0b3IvaGJzL2xvZycsWydyZXF1aXJlJywnaGFuZGxlYmFycycsJ2pzb24taWU3J10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgCgogICAgdmFyIEhhbmRsZWJhcnMgPSByZXF1aXJlKCdoYW5kbGViYXJzJyksCiAgICBKU09OID0gcmVxdWlyZSgnanNvbi1pZTcnKTsKCiAgICBmdW5jdGlvbiBsb2coY29udGV4dCwgb3B0aW9ucykgewogICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGNvbnRleHQpKTsKICAgIH0KICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xvZycsIGxvZyk7CgogICAgcmV0dXJuIGxvZzsKfSk7Ci8qZ2xvYmFsIGRlZmluZSovCmRlZmluZSgnY2hpcm9wcmFjdG9yL2hicycsWydyZXF1aXJlJywnLi9oYnMvdmlldycsJy4vaGJzL2lmZXF1YWwnLCcuL2hicy9sb2cnXSxmdW5jdGlvbihyZXF1aXJlKSB7CiAgICAKCiAgICByZXF1aXJlKCcuL2hicy92aWV3Jyk7CiAgICByZXF1aXJlKCcuL2hicy9pZmVxdWFsJyk7CiAgICByZXF1aXJlKCcuL2hicy9sb2cnKTsKfSk7CgovKmdsb2JhbCBkZWZpbmUqLwpkZWZpbmUoJ2NoaXJvcHJhY3Rvci9tYWluJyxbJ3JlcXVpcmUnLCdiYWNrYm9uZScsJ3VuZGVyc2NvcmUnLCdiYWNrYm9uZS5zdWJyb3V0ZScsJy4vdmlld3MnLCcuL21vZGVscycsJy4vY29sbGVjdGlvbnMnLCcuL3JvdXRlcnMnLCcuL2RlYnVnJywnLi9oYnMnXSxmdW5jdGlvbihyZXF1aXJlKSB7CiAgICAKCiAgICB2YXIgQmFja2JvbmUgPSByZXF1aXJlKCdiYWNrYm9uZScpLAogICAgICAgIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyksCiAgICAgICAgU3ViUm91dGUgPSByZXF1aXJlKCdiYWNrYm9uZS5zdWJyb3V0ZScpLAogICAgICAgIFZpZXdzID0gcmVxdWlyZSgnLi92aWV3cycpLAogICAgICAgIE1vZGVscyA9IHJlcXVpcmUoJy4vbW9kZWxzJyksCiAgICAgICAgQ29sbGVjdGlvbnMgPSByZXF1aXJlKCcuL2NvbGxlY3Rpb25zJyksCiAgICAgICAgUm91dGVycyA9IHJlcXVpcmUoJy4vcm91dGVycycpLAogICAgICAgIENoYW5uZWxzID0ge30sCiAgICAgICAgU3Vic2NyaWJlLAogICAgICAgIFB1Ymxpc2g7CgogICAgcmVxdWlyZSgnLi9kZWJ1ZycpOwogICAgcmVxdWlyZSgnLi9oYnMnKTsKCiAgICBTdWJzY3JpYmUgPSBmdW5jdGlvbihjaGFubmVsLG9iamVjdCkgewogICAgICAvL1dlIHdhbnQgdG8gYmUgYWJsZSB0byBwdXNoIG5ldyBsaXN0ZW5lcnMgaW50byBDaGFubmVsc1tjaGFubmVsXQogICAgICBpZiAoIUNoYW5uZWxzW2NoYW5uZWxdKSB7CiAgICAgICAgQ2hhbm5lbHNbY2hhbm5lbF0gPSBbXTsKICAgICAgfQogICAgICBDaGFubmVsc1tjaGFubmVsXS5wdXNoKG9iamVjdCk7CiAgICB9OwogICAgUHVibGlzaCA9IGZ1bmN0aW9uKGNoYW5uZWwsb3B0aW9ucykgewogICAgICBpZiAoQ2hhbm5lbHNbY2hhbm5lbF0pIHsKICAgICAgICB2YXIgbGlzdGVuZXJzID0gQ2hhbm5lbHNbY2hhbm5lbF07CiAgICAgICAgXy5lYWNoKGxpc3RlbmVycywgZnVuY3Rpb24obGlzdGVuZXIpewogICAgICAgICAgbGlzdGVuZXIudHJpZ2dlcihjaGFubmVsLG9wdGlvbnMpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgICAgLy8gQ2hhbm5lbCBldmVudHMKICAgICAgICBTdWJzY3JpYmU6IFN1YnNjcmliZSwKICAgICAgICBQdWJsaXNoOiBQdWJsaXNoLAogICAgICAgIENoYW5uZWxzOiBDaGFubmVscywKICAgICAgICBDb2xsZWN0aW9uOiBDb2xsZWN0aW9ucy5CYXNlLAogICAgICAgIENvbGxlY3Rpb25zOiBDb2xsZWN0aW9ucywKICAgICAgICBFdmVudHM6IEJhY2tib25lLkV2ZW50cywKICAgICAgICBoaXN0b3J5OiBCYWNrYm9uZS5oaXN0b3J5LAogICAgICAgIE1vZGVsOiBNb2RlbHMuQmFzZSwKICAgICAgICBNb2RlbHM6IE1vZGVscywKICAgICAgICBSb3V0ZXI6IFJvdXRlcnMuQmFzZSwKICAgICAgICBTdWJSb3V0ZTogU3ViUm91dGUsCiAgICAgICAgVmlldzogVmlld3MuQmFzZSwKICAgICAgICBWaWV3czogVmlld3MKICAgIH07Cn0pOwoKZGVmaW5lKCdjaGlyb3ByYWN0b3InLCBbJ2NoaXJvcHJhY3Rvci9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCn0oKSk7",
                "body": "KGZ1bmN0aW9uICgpIHsvLyAgICAgQmFja2JvbmUuanMgMS4xLjAKCi8vICAgICAoYykgMjAxMC0yMDExIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBJbmMuCi8vICAgICAoYykgMjAxMS0yMDEzIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCi8vICAgICBCYWNrYm9uZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KLy8gICAgIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKLy8gICAgIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZwoKKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKICAvLyBTZXQgdXAgQmFja2JvbmUgYXBwcm9wcmlhdGVseSBmb3IgdGhlIGVudmlyb25tZW50LgogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIC8vIE5vZGUvQ29tbW9uSlMsIG5vIG5lZWQgZm9yIGpRdWVyeSBpbiB0aGF0IGNhc2UuCiAgICBmYWN0b3J5KHJvb3QsIGV4cG9ydHMsIHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIC8vIEFNRAogICAgZGVmaW5lKCdiYWNrYm9uZScsWyd1bmRlcnNjb3JlJywgJ2pxdWVyeScsICdleHBvcnRzJ10sIGZ1bmN0aW9uKF8sICQsIGV4cG9ydHMpIHsKICAgICAgLy8gRXhwb3J0IGdsb2JhbCBldmVuIGluIEFNRCBjYXNlIGluIGNhc2UgdGhpcyBzY3JpcHQgaXMgbG9hZGVkIHdpdGgKICAgICAgLy8gb3RoZXJzIHRoYXQgbWF5IHN0aWxsIGV4cGVjdCBhIGdsb2JhbCBCYWNrYm9uZS4KICAgICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXywgJCk7CiAgICB9KTsKICB9IGVsc2UgewogICAgLy8gQnJvd3NlciBnbG9iYWxzCiAgICByb290LkJhY2tib25lID0gZmFjdG9yeShyb290LCB7fSwgcm9vdC5fLCAocm9vdC5qUXVlcnkgfHwgcm9vdC5aZXB0byB8fCByb290LmVuZGVyIHx8IHJvb3QuJCkpOwogIH0KfSh0aGlzLCBmdW5jdGlvbihyb290LCBCYWNrYm9uZSwgXywgJCkgewoKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCiAgdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoKICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgogIHZhciBhcnJheSA9IFtdOwogIHZhciBwdXNoID0gYXJyYXkucHVzaDsKICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwoKICAvLyBDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLgogIEJhY2tib25lLlZFUlNJT04gPSAnMS4xLjAnOwoKICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgb3IgRW5kZXIgb3ducyB0aGUgYCRgIHZhcmlhYmxlLgogIEJhY2tib25lLiQgPSAkOwoKICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCiAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgLy8gd2lsbCBmYWtlIGAiUEFUQ0giYCwgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgogIC8vIEJhY2tib25lLkV2ZW50cwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCiAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawogIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCiAgLy8gc3VjY2Vzc2lvbi4KICAvLwogIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAvLwogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgogICAgLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CiAgICAgIGV2ZW50cy5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYub2ZmKG5hbWUsIG9uY2UpOwogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0pOwogICAgICBvbmNlLl9jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgIH0sCgogICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwogICAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhZXZlbnRzQXBpKHRoaXMsICdvZmYnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAoZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdKSB7CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSByZXRhaW4gPSBbXTsKICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CiAgICAgICAgICAgIGZvciAoaiA9IDAsIGsgPSBldmVudHMubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgICAgZXYgPSBldmVudHNbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjaykgfHwKICAgICAgICAgICAgICAgICAgKGNvbnRleHQgJiYgY29udGV4dCAhPT0gZXYuY29udGV4dCkpIHsKICAgICAgICAgICAgICAgIHJldGFpbi5wdXNoKGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKICAgICAgaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwogICAgICBpZiAoYWxsRXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGFsbEV2ZW50cywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvOwogICAgICBpZiAoIWxpc3RlbmluZ1RvKSByZXR1cm4gdGhpczsKICAgICAgdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgaWYgKG9iaikgKGxpc3RlbmluZ1RvID0ge30pW29iai5fbGlzdGVuSWRdID0gb2JqOwogICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5pbmdUbykgewogICAgICAgIG9iaiA9IGxpc3RlbmluZ1RvW2lkXTsKICAgICAgICBvYmoub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgICBpZiAocmVtb3ZlIHx8IF8uaXNFbXB0eShvYmouX2V2ZW50cykpIGRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogIH07CgogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwoKICAgIC8vIEhhbmRsZSBldmVudCBtYXBzLgogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBIYW5kbGUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50IG5hbWVzLgogICAgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewogICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgogIC8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKICAvLyBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHsKICAgICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7IHJldHVybjsKICAgICAgY2FzZSAxOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOyByZXR1cm47CiAgICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7IHJldHVybjsKICAgICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7IHJldHVybjsKICAgICAgZGVmYXVsdDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsKICAgIH0KICB9OwoKICB2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwoKICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwogIC8vIGxpc3RlbiB0byBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MKICAvLyBsaXN0ZW5pbmcgdG8uCiAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uKGltcGxlbWVudGF0aW9uLCBtZXRob2QpIHsKICAgIEV2ZW50c1ttZXRob2RdID0gZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbyB8fCAodGhpcy5fbGlzdGVuaW5nVG8gPSB7fSk7CiAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5pbmdUb1tpZF0gPSBvYmo7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CiAgICAgIG9ialtpbXBsZW1lbnRhdGlvbl0obmFtZSwgY2FsbGJhY2ssIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgfSk7CgogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CiAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgogIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCiAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CgogIC8vIEJhY2tib25lLk1vZGVsCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gQmFja2JvbmUgKipNb2RlbHMqKiBhcmUgdGhlIGJhc2ljIGRhdGEgb2JqZWN0IGluIHRoZSBmcmFtZXdvcmsgLS0KICAvLyBmcmVxdWVudGx5IHJlcHJlc2VudGluZyBhIHJvdyBpbiBhIHRhYmxlIGluIGEgZGF0YWJhc2Ugb24geW91ciBzZXJ2ZXIuCiAgLy8gQSBkaXNjcmV0ZSBjaHVuayBvZiBkYXRhIGFuZCBhIGJ1bmNoIG9mIHVzZWZ1bCwgcmVsYXRlZCBtZXRob2RzIGZvcgogIC8vIHBlcmZvcm1pbmcgY29tcHV0YXRpb25zIGFuZCB0cmFuc2Zvcm1hdGlvbnMgb24gdGhhdCBkYXRhLgoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCB0aGUgc3BlY2lmaWVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMsIG9wdGlvbnMpIHx8IHt9OwogICAgYXR0cnMgPSBfLmRlZmF1bHRzKHt9LCBhdHRycywgXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpOwogICAgdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgIGNoYW5nZWQ6IG51bGwsCgogICAgLy8gVGhlIHZhbHVlIHJldHVybmVkIGR1cmluZyB0aGUgbGFzdCBmYWlsZWQgdmFsaWRhdGlvbi4KICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAogICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgLiBUaGlzIGlzCiAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwogICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdW5zZXQgICAgICAgICAgID0gb3B0aW9ucy51bnNldDsKICAgICAgc2lsZW50ICAgICAgICAgID0gb3B0aW9ucy5zaWxlbnQ7CiAgICAgIGNoYW5nZXMgICAgICAgICA9IFtdOwogICAgICBjaGFuZ2luZyAgICAgICAgPSB0aGlzLl9jaGFuZ2luZzsKICAgICAgdGhpcy5fY2hhbmdpbmcgID0gdHJ1ZTsKCiAgICAgIGlmICghY2hhbmdpbmcpIHsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIH0KICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKCiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgewogICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwogICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpIGNoYW5nZXMucHVzaChhdHRyKTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChwcmV2W2F0dHJdLCB2YWwpKSB7CiAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CiAgICAgICAgfQogICAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwogICAgICB9CgogICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSB0cnVlOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KICAgICAgLy8gYmUgcmVjdXJzaXZlbHkgbmVzdGVkIHdpdGhpbiBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgICB0aGlzLl9jaGFuZ2luZyA9IGZhbHNlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuIGB1bnNldGAgaXMgYSBub29wCiAgICAvLyBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuCiAgICB1bnNldDogZnVuY3Rpb24oYXR0ciwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0ciwgdm9pZCAwLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBDbGVhciBhbGwgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLgogICAgY2xlYXI6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmF0dHJpYnV0ZXMpIGF0dHJzW2tleV0gPSB2b2lkIDA7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRycywgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50LgogICAgLy8gSWYgeW91IHNwZWNpZnkgYW4gYXR0cmlidXRlIG5hbWUsIGRldGVybWluZSBpZiB0aGF0IGF0dHJpYnV0ZSBoYXMgY2hhbmdlZC4KICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCkgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5jaGFuZ2VkKTsKICAgICAgcmV0dXJuIF8uaGFzKHRoaXMuY2hhbmdlZCwgYXR0cik7CiAgICB9LAoKICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yCiAgICAvLyBmYWxzZSBpZiB0aGVyZSBhcmUgbm8gY2hhbmdlZCBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIGRldGVybWluaW5nIHdoYXQKICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCiAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuCiAgICAvLyBZb3UgY2FuIGFsc28gcGFzcyBhbiBhdHRyaWJ1dGVzIG9iamVjdCB0byBkaWZmIGFnYWluc3QgdGhlIG1vZGVsLAogICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbihkaWZmKSB7CiAgICAgIGlmICghZGlmZikgcmV0dXJuIHRoaXMuaGFzQ2hhbmdlZCgpID8gXy5jbG9uZSh0aGlzLmNoYW5nZWQpIDogZmFsc2U7CiAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgdmFyIG9sZCA9IHRoaXMuX2NoYW5naW5nID8gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzIDogdGhpcy5hdHRyaWJ1dGVzOwogICAgICBmb3IgKHZhciBhdHRyIGluIGRpZmYpIHsKICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7CiAgICAgICAgKGNoYW5nZWQgfHwgKGNoYW5nZWQgPSB7fSkpW2F0dHJdID0gdmFsOwogICAgICB9CiAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHByZXZpb3VzIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZSwgcmVjb3JkZWQgYXQgdGhlIHRpbWUgdGhlIGxhc3QKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgcHJldmlvdXM6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgaWYgKGF0dHIgPT0gbnVsbCB8fCAhdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlc1thdHRyXTsKICAgIH0sCgogICAgLy8gR2V0IGFsbCBvZiB0aGUgYXR0cmlidXRlcyBvZiB0aGUgbW9kZWwgYXQgdGhlIHRpbWUgb2YgdGhlIHByZXZpb3VzCiAgICAvLyBgImNoYW5nZSJgIGV2ZW50LgogICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQogICAgLy8gbW9kZWwgZGlmZmVycyBmcm9tIGl0cyBjdXJyZW50IGF0dHJpYnV0ZXMsIHRoZXkgd2lsbCBiZSBvdmVycmlkZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyksIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLgogICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBtZXRob2QsIHhociwgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoa2V5ID09IG51bGwgfHwgdHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICB9CgogICAgICBvcHRpb25zID0gXy5leHRlbmQoe3ZhbGlkYXRlOiB0cnVlfSwgb3B0aW9ucyk7CgogICAgICAvLyBJZiB3ZSdyZSBub3Qgd2FpdGluZyBhbmQgYXR0cmlidXRlcyBleGlzdCwgc2F2ZSBhY3RzIGFzCiAgICAgIC8vIGBzZXQoYXR0cikuc2F2ZShudWxsLCBvcHRzKWAgd2l0aCB2YWxpZGF0aW9uLiBPdGhlcndpc2UsIGNoZWNrIGlmCiAgICAgIC8vIHRoZSBtb2RlbCB3aWxsIGJlIHZhbGlkIHdoZW4gdGhlIGF0dHJpYnV0ZXMsIGlmIGFueSwgYXJlIHNldC4KICAgICAgaWYgKGF0dHJzICYmICFvcHRpb25zLndhaXQpIHsKICAgICAgICBpZiAoIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIC8vIFNldCB0ZW1wb3JhcnkgYXR0cmlidXRlcyBpZiBge3dhaXQ6IHRydWV9YC4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgewogICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IF8uZXh0ZW5kKHt9LCBhdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgIH0KCiAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBzZXJ2ZXItc2lkZSBzYXZlLCB0aGUgY2xpZW50IGlzIChvcHRpb25hbGx5KQogICAgICAvLyB1cGRhdGVkIHdpdGggdGhlIHNlcnZlci1zaWRlIHN0YXRlLgogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICAvLyBFbnN1cmUgYXR0cmlidXRlcyBhcmUgcmVzdG9yZWQgZHVyaW5nIHN5bmNocm9ub3VzIHNhdmVzLgogICAgICAgIG1vZGVsLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwogICAgICAgIHZhciBzZXJ2ZXJBdHRycyA9IG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLndhaXQpIHNlcnZlckF0dHJzID0gXy5leHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsKICAgICAgICBpZiAoXy5pc09iamVjdChzZXJ2ZXJBdHRycykgJiYgIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCiAgICAgIG1ldGhvZCA9IHRoaXMuaXNOZXcoKSA/ICdjcmVhdGUnIDogKG9wdGlvbnMucGF0Y2ggPyAncGF0Y2gnIDogJ3VwZGF0ZScpOwogICAgICBpZiAobWV0aG9kID09PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7CiAgICAgIHhociA9IHRoaXMuc3luYyhtZXRob2QsIHRoaXMsIG9wdGlvbnMpOwoKICAgICAgLy8gUmVzdG9yZSBhdHRyaWJ1dGVzLgogICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwoKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVzdHJveSB0aGlzIG1vZGVsIG9uIHRoZSBzZXJ2ZXIgaWYgaXQgd2FzIGFscmVhZHkgcGVyc2lzdGVkLgogICAgLy8gT3B0aW1pc3RpY2FsbHkgcmVtb3ZlcyB0aGUgbW9kZWwgZnJvbSBpdHMgY29sbGVjdGlvbiwgaWYgaXQgaGFzIG9uZS4KICAgIC8vIElmIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIHdhaXRzIGZvciB0aGUgc2VydmVyIHRvIHJlc3BvbmQgYmVmb3JlIHJlbW92YWwuCiAgICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKCiAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbW9kZWwudHJpZ2dlcignZGVzdHJveScsIG1vZGVsLCBtb2RlbC5jb2xsZWN0aW9uLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAob3B0aW9ucy53YWl0IHx8IG1vZGVsLmlzTmV3KCkpIGRlc3Ryb3koKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKCFtb2RlbC5pc05ldygpKSBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgewogICAgICAgIG9wdGlvbnMuc3VjY2VzcygpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsKICAgICAgcmV0dXJuIHhocjsKICAgIH0sCgogICAgLy8gRGVmYXVsdCBVUkwgZm9yIHRoZSBtb2RlbCdzIHJlcHJlc2VudGF0aW9uIG9uIHRoZSBzZXJ2ZXIgLS0gaWYgeW91J3JlCiAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50CiAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgdXJsOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHJldHVybiBiYXNlOwogICAgICByZXR1cm4gYmFzZSArIChiYXNlLmNoYXJBdChiYXNlLmxlbmd0aCAtIDEpID09PSAnLycgPyAnJyA6ICcvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOwogICAgfSwKCiAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuCiAgICBpc1ZhbGlkOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CiAgICB9LAoKICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsCiAgICAvLyByZXR1cm5pbmcgYHRydWVgIGlmIGFsbCBpcyB3ZWxsLiBPdGhlcndpc2UsIGZpcmUgYW4gYCJpbnZhbGlkImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghb3B0aW9ucy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRpb25FcnJvciA9IHRoaXMudmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpIHx8IG51bGw7CiAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwogICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBlcnJvciwgXy5leHRlbmQob3B0aW9ucywge3ZhbGlkYXRpb25FcnJvcjogZXJyb3J9KSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBNb2RlbC4KICB2YXIgbW9kZWxNZXRob2RzID0gWydrZXlzJywgJ3ZhbHVlcycsICdwYWlycycsICdpbnZlcnQnLCAncGljaycsICdvbWl0J107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYE1vZGVsI2F0dHJpYnV0ZXNgLgogIF8uZWFjaChtb2RlbE1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgTW9kZWwucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSWYgbW9kZWxzIHRlbmQgdG8gcmVwcmVzZW50IGEgc2luZ2xlIHJvdyBvZiBkYXRhLCBhIEJhY2tib25lIENvbGxlY3Rpb24gaXMKICAvLyBtb3JlIGFuYWxhZ291cyB0byBhIHRhYmxlIGZ1bGwgb2YgZGF0YSAuLi4gb3IgYSBzbWFsbCBzbGljZSBvciBwYWdlIG9mIHRoYXQKICAvLyB0YWJsZSwgb3IgYSBjb2xsZWN0aW9uIG9mIHJvd3MgdGhhdCBiZWxvbmcgdG9nZXRoZXIgZm9yIGEgcGFydGljdWxhciByZWFzb24KICAvLyAtLSBhbGwgb2YgdGhlIG1lc3NhZ2VzIGluIHRoaXMgcGFydGljdWxhciBmb2xkZXIsIGFsbCBvZiB0aGUgZG9jdW1lbnRzCiAgLy8gYmVsb25naW5nIHRvIHRoaXMgcGFydGljdWxhciBhdXRob3IsIGFuZCBzbyBvbi4gQ29sbGVjdGlvbnMgbWFpbnRhaW4KICAvLyBpbmRleGVzIG9mIHRoZWlyIG1vZGVscywgYm90aCBpbiBvcmRlciwgYW5kIGZvciBsb29rdXAgYnkgYGlkYC4KCiAgLy8gQ3JlYXRlIGEgbmV3ICoqQ29sbGVjdGlvbioqLCBwZXJoYXBzIHRvIGNvbnRhaW4gYSBzcGVjaWZpYyB0eXBlIG9mIGBtb2RlbGAuCiAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fcmVzZXQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgfTsKCiAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgogIHZhciBzZXRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiB0cnVlLCBtZXJnZTogdHJ1ZX07CiAgdmFyIGFkZE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IGZhbHNlfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4KICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZXh0ZW5kKHttZXJnZTogZmFsc2V9LCBvcHRpb25zLCBhZGRPcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyBbbW9kZWxzXSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXSA9IHRoaXMuZ2V0KG1vZGVsc1tpXSk7CiAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmNpZF07CiAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwogICAgfSwKCiAgICAvLyBVcGRhdGUgYSBjb2xsZWN0aW9uIGJ5IGBzZXRgLWluZyBhIG5ldyBsaXN0IG9mIG1vZGVscywgYWRkaW5nIG5ldyBvbmVzLAogICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAogICAgLy8gYWxyZWFkeSBleGlzdCBpbiB0aGUgY29sbGVjdGlvbiwgYXMgbmVjZXNzYXJ5LiBTaW1pbGFyIHRvICoqTW9kZWwjc2V0KiosCiAgICAvLyB0aGUgY29yZSBvcGVyYXRpb24gZm9yIHVwZGF0aW5nIHRoZSBkYXRhIGNvbnRhaW5lZCBieSB0aGUgY29sbGVjdGlvbi4KICAgIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXRPcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzLCBvcHRpb25zKTsKICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwogICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IChtb2RlbHMgPyBbbW9kZWxzXSA6IFtdKSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgdmFyIGksIGwsIGlkLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBzb3J0OwogICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwogICAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwogICAgICB2YXIgc29ydGFibGUgPSB0aGlzLmNvbXBhcmF0b3IgJiYgKGF0ID09IG51bGwpICYmIG9wdGlvbnMuc29ydCAhPT0gZmFsc2U7CiAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CiAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CiAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBhdHRycyA9IG1vZGVsc1tpXTsKICAgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgICAgaWQgPSBtb2RlbCA9IGF0dHJzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZCA9IGF0dHJzW3RhcmdldE1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZV07CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nID0gdGhpcy5nZXQoaWQpKSB7CiAgICAgICAgICBpZiAocmVtb3ZlKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKICAgICAgICAgIGlmIChtZXJnZSkgewogICAgICAgICAgICBhdHRycyA9IGF0dHJzID09PSBtb2RlbCA/IG1vZGVsLmF0dHJpYnV0ZXMgOiBhdHRyczsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBleGlzdGluZy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoc29ydGFibGUgJiYgIXNvcnQgJiYgZXhpc3RpbmcuaGFzQ2hhbmdlZChzb3J0QXR0cikpIHNvcnQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgbW9kZWxzW2ldID0gZXhpc3Rpbmc7CgogICAgICAgIC8vIElmIHRoaXMgaXMgYSBuZXcsIHZhbGlkIG1vZGVsLCBwdXNoIGl0IHRvIHRoZSBgdG9BZGRgIGxpc3QuCiAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKICAgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgICAgdG9BZGQucHVzaChtb2RlbCk7CgogICAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAgIC8vIGBpZGAgYW5kIGJ5IGBjaWRgLgogICAgICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICAgIH0KICAgICAgICBpZiAob3JkZXIpIG9yZGVyLnB1c2goZXhpc3RpbmcgfHwgbW9kZWwpOwogICAgICB9CgogICAgICAvLyBSZW1vdmUgbm9uZXhpc3RlbnQgbW9kZWxzIGlmIGFwcHJvcHJpYXRlLgogICAgICBpZiAocmVtb3ZlKSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICBpZiAoIW1vZGVsTWFwWyhtb2RlbCA9IHRoaXMubW9kZWxzW2ldKS5jaWRdKSB0b1JlbW92ZS5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRvUmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUodG9SZW1vdmUsIG9wdGlvbnMpOwogICAgICB9CgogICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCiAgICAgIGlmICh0b0FkZC5sZW5ndGggfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHsKICAgICAgICBpZiAoc29ydGFibGUpIHNvcnQgPSB0cnVlOwogICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoYXQgKyBpLCAwLCB0b0FkZFtpXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChvcmRlcikgdGhpcy5tb2RlbHMubGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBvcmRlcmVkTW9kZWxzID0gb3JkZXIgfHwgdG9BZGQ7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gb3JkZXJlZE1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5tb2RlbHMucHVzaChvcmRlcmVkTW9kZWxzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChzb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoKICAgICAgLy8gVW5sZXNzIHNpbGVuY2VkLCBpdCdzIHRpbWUgdG8gZmlyZSBhbGwgYXBwcm9wcmlhdGUgYWRkL3NvcnQgZXZlbnRzLgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvcnQgfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIAogICAgICAvLyBSZXR1cm4gdGhlIGFkZGVkIChvciBtZXJnZWQpIG1vZGVsIChvciBtb2RlbHMpLgogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgLy8gVXNlZnVsIGZvciBidWxrIG9wZXJhdGlvbnMgYW5kIG9wdGltaXphdGlvbnMuCiAgICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldKTsKICAgICAgfQogICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHM7CiAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICAgIG1vZGVscyA9IHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdyZXNldCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWxzOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IHRoaXMubGVuZ3RofSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgogICAgc2xpY2U6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc2xpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KICAgIGdldDogZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuX2J5SWRbb2JqLmlkXSB8fCB0aGlzLl9ieUlkW29iai5jaWRdIHx8IHRoaXMuX2J5SWRbb2JqXTsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzW2luZGV4XTsKICAgIH0sCgogICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mCiAgICAvLyBgZmlsdGVyYC4KICAgIHdoZXJlOiBmdW5jdGlvbihhdHRycywgZmlyc3QpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBmaXJzdCA/IHZvaWQgMCA6IFtdOwogICAgICByZXR1cm4gdGhpc1tmaXJzdCA/ICdmaW5kJyA6ICdmaWx0ZXInXShmdW5jdGlvbihtb2RlbCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KTsKICAgIH0sCgogICAgLy8gUmV0dXJuIHRoZSBmaXJzdCBtb2RlbCB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzCiAgICAvLyBvZiBgZmluZGAuCiAgICBmaW5kV2hlcmU6IGZ1bmN0aW9uKGF0dHJzKSB7CiAgICAgIHJldHVybiB0aGlzLndoZXJlKGF0dHJzLCB0cnVlKTsKICAgIH0sCgogICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcgogICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQogICAgLy8gaXMgYWRkZWQuCiAgICBzb3J0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gc29ydCBiYXNlZCBvbiB0eXBlIG9mIGBjb21wYXJhdG9yYC4KICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOwogICAgICB9CgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFBsdWNrIGFuIGF0dHJpYnV0ZSBmcm9tIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICBwbHVjazogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCiAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKICAgIC8vIGRhdGEgd2lsbCBiZSBwYXNzZWQgdGhyb3VnaCB0aGUgYHJlc2V0YCBtZXRob2QgaW5zdGVhZCBvZiBgc2V0YC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBjb2xsZWN0aW9uLnRyaWdnZXIoJ3N5bmMnLCBjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgogICAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpKSkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFByaXZhdGUgbWV0aG9kIHRvIHJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24KICAgIC8vIGlzIGZpcnN0IGluaXRpYWxpemVkIG9yIHJlc2V0LgogICAgX3Jlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICB0aGlzLm1vZGVscyA9IFtdOwogICAgICB0aGlzLl9ieUlkICA9IHt9OwogICAgfSwKCiAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwogICAgLy8gY29sbGVjdGlvbi4KICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSB7CiAgICAgICAgaWYgKCFhdHRycy5jb2xsZWN0aW9uKSBhdHRycy5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgICByZXR1cm4gYXR0cnM7CiAgICAgIH0KICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC52YWxpZGF0aW9uRXJyb3IpIHJldHVybiBtb2RlbDsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgbW9kZWwudmFsaWRhdGlvbkVycm9yLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V2ZXIgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgogIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEJhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCiAgLy8gcmlnaHQgaGVyZToKICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdjb2xsZWN0JywgJ3JlZHVjZScsICdmb2xkbCcsCiAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAogICAgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsICdjb250YWlucycsICdpbnZva2UnLAogICAgJ21heCcsICdtaW4nLCAndG9BcnJheScsICdzaXplJywgJ2ZpcnN0JywgJ2hlYWQnLCAndGFrZScsICdpbml0aWFsJywgJ3Jlc3QnLAogICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnZGlmZmVyZW5jZScsICdpbmRleE9mJywgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknLCAnY2hhaW4nXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIEJhY2tib25lIFZpZXdzIGFyZSBhbG1vc3QgbW9yZSBjb252ZW50aW9uIHRoYW4gdGhleSBhcmUgYWN0dWFsIGNvZGUuIEEgVmlldwogIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCiAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCiAgLy8gZXZlbiB0aGUgc3Vycm91bmRpbmcgZnJhbWUgd2hpY2ggd3JhcHMgeW91ciB3aG9sZSBhcHAuIERlZmluaW5nIGEgY2h1bmsgb2YKICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CiAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCiAgLy8gcmVhY3QgdG8gc3BlY2lmaWMgY2hhbmdlcyBpbiB0aGUgc3RhdGUgb2YgeW91ciBtb2RlbHMuCgogIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAogIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCiAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwoKICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KICAgIHRhZ05hbWU6ICdkaXYnLAoKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICB9LAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgIC8vCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgLy8KICAgIC8vICAgICB7CiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScsCiAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9CiAgICAvLyAgICAgfQogICAgLy8KICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5LgogICAgLy8gVXNlcyBldmVudCBkZWxlZ2F0aW9uIGZvciBlZmZpY2llbmN5LgogICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuCiAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQKICAgIC8vIG5vdCBgY2hhbmdlYCwgYHN1Ym1pdGAsIGFuZCBgcmVzZXRgIGluIEludGVybmV0IEV4cGxvcmVyLgogICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm4gdGhpczsKICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpIGNvbnRpbnVlOwoKICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKICAgICAgICB2YXIgZXZlbnROYW1lID0gbWF0Y2hbMV0sIHNlbGVjdG9yID0gbWF0Y2hbMl07CiAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CiAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgaWYgKHNlbGVjdG9yID09PSAnJykgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIHNlbGVjdG9yLCBtZXRob2QpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBWaWV3IGhhcyBhIERPTSBlbGVtZW50IHRvIHJlbmRlciBpbnRvLgogICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CiAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCiAgICAvLyBhbiBlbGVtZW50IGZyb20gdGhlIGBpZGAsIGBjbGFzc05hbWVgIGFuZCBgdGFnTmFtZWAgcHJvcGVydGllcy4KICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgIGlmICh0aGlzLmlkKSBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CiAgICAgICAgdmFyICRlbCA9IEJhY2tib25lLiQoJzwnICsgXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSArICc+JykuYXR0cihhdHRycyk7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KCRlbCwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiBub1hoclBhdGNoKSB7CiAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgICAgIH07CiAgICB9CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CgogIHZhciBub1hoclBhdGNoID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgISF3aW5kb3cuQWN0aXZlWE9iamVjdCAmJiAhKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCAmJiAobmV3IFhNTEh0dHBSZXF1ZXN0KS5kaXNwYXRjaEV2ZW50KTsKCiAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uCiAgdmFyIG1ldGhvZE1hcCA9IHsKICAgICdjcmVhdGUnOiAnUE9TVCcsCiAgICAndXBkYXRlJzogJ1BVVCcsCiAgICAncGF0Y2gnOiAgJ1BBVENIJywKICAgICdkZWxldGUnOiAnREVMRVRFJywKICAgICdyZWFkJzogICAnR0VUJwogIH07CgogIC8vIFNldCB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBgQmFja2JvbmUuYWpheGAgdG8gcHJveHkgdGhyb3VnaCB0byBgJGAuCiAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBCYWNrYm9uZS4kLmFqYXguYXBwbHkoQmFja2JvbmUuJCwgYXJndW1lbnRzKTsKICB9OwoKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gICAgPSAvKFwoXD8pPzpcdysvZzsKICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwogIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKICAgIC8vCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAvLyAgICAgICAuLi4KICAgIC8vICAgICB9KTsKICAgIC8vCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgICBjYWxsYmFjayA9IG5hbWU7CiAgICAgICAgbmFtZSA9ICcnOwogICAgICB9CiAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgICAgdmFyIHJvdXRlciA9IHRoaXM7CiAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkocm91dGVyLCBhcmdzKTsKICAgICAgICByb3V0ZXIudHJpZ2dlci5hcHBseShyb3V0ZXIsIFsncm91dGU6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgcm91dGVyLnRyaWdnZXIoJ3JvdXRlJywgbmFtZSwgYXJncyk7CiAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHJvdXRlciwgbmFtZSwgYXJncyk7CiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQogICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAogICAgLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4KICAgIF9iaW5kUm91dGVzOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLnJvdXRlcykgcmV0dXJuOwogICAgICB0aGlzLnJvdXRlcyA9IF8ucmVzdWx0KHRoaXMsICdyb3V0ZXMnKTsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCkgewogICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uYWwgPyBtYXRjaCA6ICcoW15cL10rKSc7CiAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyguKj8pJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyQnKTsKICAgIH0sCgogICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgogICAgLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQogICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewogICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtKSB7CiAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CiAgICAgIH0pOwogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuSGlzdG9yeQogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCiAgLy8gW3B1c2hTdGF0ZV0oaHR0cDovL2RpdmVpbnRvaHRtbDUuaW5mby9oaXN0b3J5Lmh0bWwpIGFuZCByZWFsIFVSTHMsIG9yCiAgLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCiAgLy8gZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgdXJscyBvZiBoYXNoIGFuZCBxdWVyeS4KICB2YXIgcGF0aFN0cmlwcGVyID0gL1s/I10uKiQvOwoKICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CiAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgaW50ZXJ2YWwgdG8gcG9sbCBmb3IgaGFzaCBjaGFuZ2VzLCBpZiBuZWNlc3NhcnksIGlzCiAgICAvLyB0d2VudHkgdGltZXMgYSBzZWNvbmQuCiAgICBpbnRlcnZhbDogNTAsCgogICAgLy8gR2V0cyB0aGUgdHJ1ZSBoYXNoIHZhbHVlLiBDYW5ub3QgdXNlIGxvY2F0aW9uLmhhc2ggZGlyZWN0bHkgZHVlIHRvIGJ1ZwogICAgLy8gaW4gRmlyZWZveCB3aGVyZSBsb2NhdGlvbi5oYXNoIHdpbGwgYWx3YXlzIGJlIGRlY29kZWQuCiAgICBnZXRIYXNoOiBmdW5jdGlvbih3aW5kb3cpIHsKICAgICAgdmFyIG1hdGNoID0gKHdpbmRvdyB8fCB0aGlzKS5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLAogICAgLy8gdGhlIGhhc2gsIG9yIHRoZSBvdmVycmlkZS4KICAgIGdldEZyYWdtZW50OiBmdW5jdGlvbihmcmFnbWVudCwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgaWYgKGZyYWdtZW50ID09IG51bGwpIHsKICAgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlIHx8ICF0aGlzLl93YW50c0hhc2hDaGFuZ2UgfHwgZm9yY2VQdXNoU3RhdGUpIHsKICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5sb2NhdGlvbi5wYXRobmFtZTsKICAgICAgICAgIHZhciByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwogICAgICAgICAgaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnNsaWNlKHJvb3QubGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgfSwKCiAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCiAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CgogICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwogICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwogICAgICB0aGlzLm9wdGlvbnMgICAgICAgICAgPSBfLmV4dGVuZCh7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLmlmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CiAgICAgIHZhciBhdFJvb3QgPSBsb2MucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CgogICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQogICAgICAvLyByZXF1ZXN0ZWQuCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCiAgICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkCiAgICAgICAgLy8gYnJvd3NlciwgYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhYXRSb290KSB7CiAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChudWxsLCB0cnVlKTsKICAgICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICAgIH0gZWxzZSBpZiAodGhpcy5faGFzUHVzaFN0YXRlICYmIGF0Um9vdCAmJiBsb2MuaGFzaCkgewogICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQgKyBsb2Muc2VhcmNoKTsKICAgICAgICB9CgogICAgICB9CgogICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogICAgfSwKCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50KTsKICAgICAgcmV0dXJuIF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgIC8vCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiAhIW9wdGlvbnN9OwoKICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIChmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQgfHwgJycpKTsKCiAgICAgIC8vIFN0cmlwIHRoZSBmcmFnbWVudCBvZiB0aGUgcXVlcnkgYW5kIGhhc2ggZm9yIG1hdGNoaW5nLgogICAgICBmcmFnbWVudCA9IGZyYWdtZW50LnJlcGxhY2UocGF0aFN0cmlwcGVyLCAnJyk7CgogICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHJldHVybjsKICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwoKICAgICAgLy8gRG9uJ3QgaW5jbHVkZSBhIHRyYWlsaW5nIHNsYXNoIG9uIHRoZSByb290LgogICAgICBpZiAoZnJhZ21lbnQgPT09ICcnICYmIHVybCAhPT0gJy8nKSB1cmwgPSB1cmwuc2xpY2UoMCwgLTEpOwoKICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIHRoaXMuaGlzdG9yeVtvcHRpb25zLnJlcGxhY2UgPyAncmVwbGFjZVN0YXRlJyA6ICdwdXNoU3RhdGUnXSh7fSwgZG9jdW1lbnQudGl0bGUsIHVybCk7CgogICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaAogICAgICAvLyBmcmFnbWVudCB0byBzdG9yZSBoaXN0b3J5LgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgaWYgKHRoaXMuaWZyYW1lICYmIChmcmFnbWVudCAhPT0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKSkpIHsKICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQogICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QKICAgICAgICAgIC8vIHdhbnQgdGhpcy4KICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOwogICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7CiAgICAgICAgfQoKICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtCiAgICAgIC8vIGJhc2VkIGhpc3RvcnksIHRoZW4gYG5hdmlnYXRlYCBiZWNvbWVzIGEgcGFnZSByZWZyZXNoLgogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpIHJldHVybiB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwogICAgfSwKCiAgICAvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwogICAgLy8gYSBuZXcgb25lIHRvIHRoZSBicm93c2VyIGhpc3RvcnkuCiAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsKICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLgogICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKICAgICAgfQogICAgfQoKICB9KTsKCiAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCiAgQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5OwoKICAvLyBIZWxwZXJzCiAgLy8gLS0tLS0tLQoKICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpczsKICAgIHZhciBjaGlsZDsKCiAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CiAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewogICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CiAgICB9IGVsc2UgewogICAgICBjaGlsZCA9IGZ1bmN0aW9uKCl7IHJldHVybiBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKICAgIH0KCiAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KICAgIF8uZXh0ZW5kKGNoaWxkLCBwYXJlbnQsIHN0YXRpY1Byb3BzKTsKCiAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwogICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgIHZhciBTdXJyb2dhdGUgPSBmdW5jdGlvbigpeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH07CiAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGU7CgogICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCiAgICAvLyBpZiBzdXBwbGllZC4KICAgIGlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKICAgIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQKICAgIC8vIGxhdGVyLgogICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCiAgICByZXR1cm4gY2hpbGQ7CiAgfTsKCiAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciB0aGUgbW9kZWwsIGNvbGxlY3Rpb24sIHJvdXRlciwgdmlldyBhbmQgaGlzdG9yeS4KICBNb2RlbC5leHRlbmQgPSBDb2xsZWN0aW9uLmV4dGVuZCA9IFJvdXRlci5leHRlbmQgPSBWaWV3LmV4dGVuZCA9IEhpc3RvcnkuZXh0ZW5kID0gZXh0ZW5kOwoKICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuCiAgdmFyIHVybEVycm9yID0gZnVuY3Rpb24oKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0EgInVybCIgcHJvcGVydHkgb3IgZnVuY3Rpb24gbXVzdCBiZSBzcGVjaWZpZWQnKTsKICB9OwoKICAvLyBXcmFwIGFuIG9wdGlvbmFsIGVycm9yIGNhbGxiYWNrIHdpdGggYSBmYWxsYmFjayBlcnJvciBldmVudC4KICB2YXIgd3JhcEVycm9yID0gZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgIHZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7CiAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24ocmVzcCkgewogICAgICBpZiAoZXJyb3IpIGVycm9yKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICB9OwogIH07CgogIHJldHVybiBCYWNrYm9uZTsKfSkpOwoKLy8gYmFja2JvbmUtc3Vicm91dGUuanMgdjAuNC4yCi8vCi8vIENvcHlyaWdodCAoQykgMjAxMiBEYXZlIENhZHdhbGxhZGVyLCBNb2RlbCBOLCBJbmMuICAKLy8gRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlCi8vCi8vIERvY3VtZW50YXRpb24gYW5kIGZ1bGwgbGljZW5zZSBhdmFpbGFibGUgYXQ6Ci8vIGh0dHBzOi8vZ2l0aHViLmNvbS9Nb2RlbE4vYmFja2JvbmUuc3Vicm91dGUKCihmdW5jdGlvbihmYWN0b3J5KSB7CiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgLy8gUmVnaXN0ZXIgYXMgYW4gQU1EIG1vZHVsZSBpZiBhdmFpbGFibGUuLi4KICAgICAgICBkZWZpbmUoJ2JhY2tib25lLnN1YnJvdXRlJyxbJ3VuZGVyc2NvcmUnLCAnYmFja2JvbmUnXSwgZmFjdG9yeSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewogICAgICAgIC8vIE5leHQgZm9yIE5vZGUuanMsIENvbW1vbkpTLCBicm93c2VyaWZ5Li4uCiAgICAgICAgZmFjdG9yeShyZXF1aXJlKCd1bmRlcnNjb3JlJyksIHJlcXVpcmUoJ2JhY2tib25lJykpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBCcm93c2VyIGdsb2JhbHMgZm9yIHRoZSB1bmVubGlnaHRlbmVkLi4uCiAgICAgICAgZmFjdG9yeShfLCBCYWNrYm9uZSk7CiAgICB9Cn0oZnVuY3Rpb24oXywgQmFja2JvbmUpIHsKCiAgICBCYWNrYm9uZS5TdWJSb3V0ZSA9IEJhY2tib25lLlJvdXRlci5leHRlbmQoewogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihwcmVmaXgsIG9wdGlvbnMpIHsKCiAgICAgICAgICAgIC8vIGVhY2ggc3Vicm91dGUgaW5zdGFuY2Ugc2hvdWxkIGhhdmUgaXRzIG93biByb3V0ZXMgaGFzaAogICAgICAgICAgICB0aGlzLnJvdXRlcyA9IF8uY2xvbmUodGhpcy5yb3V0ZXMpIHx8IHt9OwoKICAgICAgICAgICAgLy8gUHJlZml4IGlzIG9wdGlvbmFsLCBzZXQgdG8gZW1wdHkgc3RyaW5nIGlmIG5vdCBwYXNzZWQKICAgICAgICAgICAgdGhpcy5wcmVmaXggPSBwcmVmaXggPSBwcmVmaXggfHwgIiI7CgogICAgICAgICAgICAvLyBTdWJSb3V0ZSBpbnN0YW5jZXMgbWF5IGJlIGluc3RhbnRpYXRlZCB1c2luZyBhIHByZWZpeCB3aXRoIG9yIHdpdGhvdXQgYSB0cmFpbGluZyBzbGFzaC4KICAgICAgICAgICAgLy8gSWYgdGhlIHByZWZpeCBkb2VzICpub3QqIGhhdmUgYSB0cmFpbGluZyBzbGFzaCwgd2UgbmVlZCB0byBpbnNlcnQgYSBzbGFzaCBhcyBhIHNlcGFyYXRvcgogICAgICAgICAgICAvLyBiZXR3ZWVuIHRoZSBwcmVmaXggYW5kIHRoZSBzdWItcm91dGUgcGF0aCBmb3IgZWFjaCByb3V0ZSB0aGF0IHdlIHJlZ2lzdGVyIHdpdGggQmFja2JvbmUuICAgICAgICAKICAgICAgICAgICAgdGhpcy5zZXBhcmF0b3IgPSAocHJlZml4LnNsaWNlKC0xKSA9PT0gIi8iKSA/ICIiIDogIi8iOwoKICAgICAgICAgICAgLy8gaWYgeW91IHdhbnQgdG8gbWF0Y2ggImJvb2tzIiBhbmQgImJvb2tzLyIgd2l0aG91dCBjcmVhdGluZyBzZXBhcmF0ZSByb3V0ZXMsIHNldCB0aGlzCiAgICAgICAgICAgIC8vIG9wdGlvbiB0byAidHJ1ZSIgYW5kIHRoZSBzdWItcm91dGVyIHdpbGwgYXV0b21hdGljYWxseSBjcmVhdGUgdGhvc2Ugcm91dGVzIGZvciB5b3UuCiAgICAgICAgICAgIHRoaXMuY3JlYXRlVHJhaWxpbmdTbGFzaFJvdXRlcyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5jcmVhdGVUcmFpbGluZ1NsYXNoUm91dGVzOwoKICAgICAgICAgICAgLy8gUmVxdWlyZWQgdG8gaGF2ZSBCYWNrYm9uZSBzZXQgdXAgcm91dGVzCiAgICAgICAgICAgIEJhY2tib25lLlJvdXRlci5wcm90b3R5cGUuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBvcHRpb25zKTsKCiAgICAgICAgICAgIC8vIGdyYWIgdGhlIGZ1bGwgVVJMCiAgICAgICAgICAgIHZhciBoYXNoOwogICAgICAgICAgICBpZiAoQmFja2JvbmUuaGlzdG9yeS5mcmFnbWVudCkgewogICAgICAgICAgICAgICAgaGFzaCA9IEJhY2tib25lLmhpc3RvcnkuZ2V0RnJhZ21lbnQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhhc2ggPSBCYWNrYm9uZS5oaXN0b3J5LmdldEhhc2goKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVHJpZ2dlciB0aGUgc3Vicm91dGUgaW1tZWRpYXRlbHkuICB0aGlzIHN1cHBvcnRzIHRoZSBjYXNlIHdoZXJlIAogICAgICAgICAgICAvLyBhIHVzZXIgZGlyZWN0bHkgbmF2aWdhdGVzIHRvIGEgVVJMIHdpdGggYSBzdWJyb3V0ZSBvbiB0aGUgZmlyc3QgcGFnZSBsb2FkLgogICAgICAgICAgICAvLyBDaGVjayBldmVyeSBlbGVtZW50LCBpZiBvbmUgbWF0Y2hlcywgYnJlYWsuIFByZXZlbnQgbXVsdGlwbGUgbWF0Y2hlcwogICAgICAgICAgICBfLmV2ZXJ5KHRoaXMucm91dGVzLCBmdW5jdGlvbihrZXksIHJvdXRlKSB7CiAgICAgICAgICAgICAgICAvLyBVc2UgdGhlIEJhY2tib25lIHBhcnNlciB0byB0dXJuIHJvdXRlIGludG8gcmVnZXggZm9yIG1hdGNoaW5nCiAgICAgICAgICAgICAgICBpZiAoaGFzaC5tYXRjaChCYWNrYm9uZS5Sb3V0ZXIucHJvdG90eXBlLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKSkpIHsKICAgICAgICAgICAgICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LmxvYWRVcmwoaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAgICAgaWYgKHRoaXMucG9zdEluaXRpYWxpemUpIHsKICAgICAgICAgICAgICAgIHRoaXMucG9zdEluaXRpYWxpemUob3B0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG5hdmlnYXRlOiBmdW5jdGlvbihyb3V0ZSwgb3B0aW9ucykgewogICAgICAgICAgICBpZiAocm91dGUuc3Vic3RyKDAsIDEpICE9ICcvJyAmJgogICAgICAgICAgICAgICAgcm91dGUuaW5kZXhPZih0aGlzLnByZWZpeC5zdWJzdHIoMCwgdGhpcy5wcmVmaXgubGVuZ3RoIC0gMSkpICE9PSAwKSB7CgogICAgICAgICAgICAgICAgcm91dGUgPSB0aGlzLnByZWZpeCArCiAgICAgICAgICAgICAgICAgICAgKHJvdXRlID8gdGhpcy5zZXBhcmF0b3IgOiAiIikgKwogICAgICAgICAgICAgICAgICAgIHJvdXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEJhY2tib25lLlJvdXRlci5wcm90b3R5cGUubmF2aWdhdGUuY2FsbCh0aGlzLCByb3V0ZSwgb3B0aW9ucyk7CiAgICAgICAgfSwKICAgICAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIC8vIHN0cmlwIG9mZiBhbnkgbGVhZGluZyBzbGFzaGVzIGluIHRoZSBzdWItcm91dGUgcGF0aCwgCiAgICAgICAgICAgIC8vIHNpbmNlIHdlIGFscmVhZHkgaGFuZGxlIGluc2VydGluZyB0aGVtIHdoZW4gbmVlZGVkLgogICAgICAgICAgICBpZiAocm91dGUuc3Vic3RyKDApID09PSAiLyIpIHsKICAgICAgICAgICAgICAgIHJvdXRlID0gcm91dGUuc3Vic3RyKDEsIHJvdXRlLmxlbmd0aCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBfcm91dGUgPSB0aGlzLnByZWZpeDsKICAgICAgICAgICAgaWYgKHJvdXRlICYmIHJvdXRlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByZWZpeC5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgIF9yb3V0ZSArPSB0aGlzLnNlcGFyYXRvcjsKCiAgICAgICAgICAgICAgICBfcm91dGUgKz0gcm91dGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmNyZWF0ZVRyYWlsaW5nU2xhc2hSb3V0ZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMucm91dGVzW19yb3V0ZSArICcvJ10gPSBuYW1lOwogICAgICAgICAgICAgICAgQmFja2JvbmUuUm91dGVyLnByb3RvdHlwZS5yb3V0ZS5jYWxsKHRoaXMsIF9yb3V0ZSArICcvJywgbmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyByZW1vdmUgdGhlIHVuLXByZWZpeGVkIHJvdXRlIGZyb20gb3VyIHJvdXRlcyBoYXNoCiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnJvdXRlc1tyb3V0ZV07CgogICAgICAgICAgICAvLyBhZGQgdGhlIHByZWZpeGVkLXJvdXRlLiAgbm90ZSB0aGF0IHRoaXMgcm91dGVzIGhhc2ggaXMganVzdCBwcm92aWRlZCAKICAgICAgICAgICAgLy8gZm9yIGluZm9ybWF0aW9uYWwgYW5kIGRlYnVnZ2luZyBwdXJwb3NlcyBhbmQgaXMgbm90IHVzZWQgYnkgdGhlIGFjdHVhbCByb3V0aW5nIGNvZGUuCiAgICAgICAgICAgIHRoaXMucm91dGVzW19yb3V0ZV0gPSBuYW1lOwoKICAgICAgICAgICAgLy8gZGVsZWdhdGUgdGhlIGNyZWF0aW9uIG9mIHRoZSBwcm9wZXJseS1wcmVmaXhlZCByb3V0ZSB0byBCYWNrYm9uZQogICAgICAgICAgICByZXR1cm4gQmFja2JvbmUuUm91dGVyLnByb3RvdHlwZS5yb3V0ZS5jYWxsKHRoaXMsIF9yb3V0ZSwgbmFtZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIEJhY2tib25lLlN1YlJvdXRlOwp9KSk7CgovKgogICAganNvbjIuanMKICAgIDIwMTMtMDUtMjYKCiAgICBQdWJsaWMgRG9tYWluLgoKICAgIE5PIFdBUlJBTlRZIEVYUFJFU1NFRCBPUiBJTVBMSUVELiBVU0UgQVQgWU9VUiBPV04gUklTSy4KCiAgICBTZWUgaHR0cDovL3d3dy5KU09OLm9yZy9qcy5odG1sCgoKICAgIFRoaXMgY29kZSBzaG91bGQgYmUgbWluaWZpZWQgYmVmb3JlIGRlcGxveW1lbnQuCiAgICBTZWUgaHR0cDovL2phdmFzY3JpcHQuY3JvY2tmb3JkLmNvbS9qc21pbi5odG1sCgogICAgVVNFIFlPVVIgT1dOIENPUFkuIElUIElTIEVYVFJFTUVMWSBVTldJU0UgVE8gTE9BRCBDT0RFIEZST00gU0VSVkVSUyBZT1UgRE8KICAgIE5PVCBDT05UUk9MLgoKCiAgICBUaGlzIGZpbGUgY3JlYXRlcyBhIGdsb2JhbCBKU09OIG9iamVjdCBjb250YWluaW5nIHR3byBtZXRob2RzOiBzdHJpbmdpZnkKICAgIGFuZCBwYXJzZS4KCiAgICAgICAgSlNPTi5zdHJpbmdpZnkodmFsdWUsIHJlcGxhY2VyLCBzcGFjZSkKICAgICAgICAgICAgdmFsdWUgICAgICAgYW55IEphdmFTY3JpcHQgdmFsdWUsIHVzdWFsbHkgYW4gb2JqZWN0IG9yIGFycmF5LgoKICAgICAgICAgICAgcmVwbGFjZXIgICAgYW4gb3B0aW9uYWwgcGFyYW1ldGVyIHRoYXQgZGV0ZXJtaW5lcyBob3cgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcyBhcmUgc3RyaW5naWZpZWQgZm9yIG9iamVjdHMuIEl0IGNhbiBiZSBhCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN0cmluZ3MuCgogICAgICAgICAgICBzcGFjZSAgICAgICBhbiBvcHRpb25hbCBwYXJhbWV0ZXIgdGhhdCBzcGVjaWZpZXMgdGhlIGluZGVudGF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIG9mIG5lc3RlZCBzdHJ1Y3R1cmVzLiBJZiBpdCBpcyBvbWl0dGVkLCB0aGUgdGV4dCB3aWxsCiAgICAgICAgICAgICAgICAgICAgICAgIGJlIHBhY2tlZCB3aXRob3V0IGV4dHJhIHdoaXRlc3BhY2UuIElmIGl0IGlzIGEgbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICBpdCB3aWxsIHNwZWNpZnkgdGhlIG51bWJlciBvZiBzcGFjZXMgdG8gaW5kZW50IGF0IGVhY2gKICAgICAgICAgICAgICAgICAgICAgICAgbGV2ZWwuIElmIGl0IGlzIGEgc3RyaW5nIChzdWNoIGFzICdcdCcgb3IgJyZuYnNwOycpLAogICAgICAgICAgICAgICAgICAgICAgICBpdCBjb250YWlucyB0aGUgY2hhcmFjdGVycyB1c2VkIHRvIGluZGVudCBhdCBlYWNoIGxldmVsLgoKICAgICAgICAgICAgVGhpcyBtZXRob2QgcHJvZHVjZXMgYSBKU09OIHRleHQgZnJvbSBhIEphdmFTY3JpcHQgdmFsdWUuCgogICAgICAgICAgICBXaGVuIGFuIG9iamVjdCB2YWx1ZSBpcyBmb3VuZCwgaWYgdGhlIG9iamVjdCBjb250YWlucyBhIHRvSlNPTgogICAgICAgICAgICBtZXRob2QsIGl0cyB0b0pTT04gbWV0aG9kIHdpbGwgYmUgY2FsbGVkIGFuZCB0aGUgcmVzdWx0IHdpbGwgYmUKICAgICAgICAgICAgc3RyaW5naWZpZWQuIEEgdG9KU09OIG1ldGhvZCBkb2VzIG5vdCBzZXJpYWxpemU6IGl0IHJldHVybnMgdGhlCiAgICAgICAgICAgIHZhbHVlIHJlcHJlc2VudGVkIGJ5IHRoZSBuYW1lL3ZhbHVlIHBhaXIgdGhhdCBzaG91bGQgYmUgc2VyaWFsaXplZCwKICAgICAgICAgICAgb3IgdW5kZWZpbmVkIGlmIG5vdGhpbmcgc2hvdWxkIGJlIHNlcmlhbGl6ZWQuIFRoZSB0b0pTT04gbWV0aG9kCiAgICAgICAgICAgIHdpbGwgYmUgcGFzc2VkIHRoZSBrZXkgYXNzb2NpYXRlZCB3aXRoIHRoZSB2YWx1ZSwgYW5kIHRoaXMgd2lsbCBiZQogICAgICAgICAgICBib3VuZCB0byB0aGUgdmFsdWUKCiAgICAgICAgICAgIEZvciBleGFtcGxlLCB0aGlzIHdvdWxkIHNlcmlhbGl6ZSBEYXRlcyBhcyBJU08gc3RyaW5ncy4KCiAgICAgICAgICAgICAgICBEYXRlLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZihuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZvcm1hdCBpbnRlZ2VycyB0byBoYXZlIGF0IGxlYXN0IHR3byBkaWdpdHMuCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuIDwgMTAgPyAnMCcgKyBuIDogbjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFVUQ0Z1bGxZZWFyKCkgICArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTW9udGgoKSArIDEpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENEYXRlKCkpICAgICAgKyAnVCcgKwogICAgICAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ0hvdXJzKCkpICAgICArICc6JyArCiAgICAgICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTWludXRlcygpKSAgICsgJzonICsKICAgICAgICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENTZWNvbmRzKCkpICAgKyAnWic7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgWW91IGNhbiBwcm92aWRlIGFuIG9wdGlvbmFsIHJlcGxhY2VyIG1ldGhvZC4gSXQgd2lsbCBiZSBwYXNzZWQgdGhlCiAgICAgICAgICAgIGtleSBhbmQgdmFsdWUgb2YgZWFjaCBtZW1iZXIsIHdpdGggdGhpcyBib3VuZCB0byB0aGUgY29udGFpbmluZwogICAgICAgICAgICBvYmplY3QuIFRoZSB2YWx1ZSB0aGF0IGlzIHJldHVybmVkIGZyb20geW91ciBtZXRob2Qgd2lsbCBiZQogICAgICAgICAgICBzZXJpYWxpemVkLiBJZiB5b3VyIG1ldGhvZCByZXR1cm5zIHVuZGVmaW5lZCwgdGhlbiB0aGUgbWVtYmVyIHdpbGwKICAgICAgICAgICAgYmUgZXhjbHVkZWQgZnJvbSB0aGUgc2VyaWFsaXphdGlvbi4KCiAgICAgICAgICAgIElmIHRoZSByZXBsYWNlciBwYXJhbWV0ZXIgaXMgYW4gYXJyYXkgb2Ygc3RyaW5ncywgdGhlbiBpdCB3aWxsIGJlCiAgICAgICAgICAgIHVzZWQgdG8gc2VsZWN0IHRoZSBtZW1iZXJzIHRvIGJlIHNlcmlhbGl6ZWQuIEl0IGZpbHRlcnMgdGhlIHJlc3VsdHMKICAgICAgICAgICAgc3VjaCB0aGF0IG9ubHkgbWVtYmVycyB3aXRoIGtleXMgbGlzdGVkIGluIHRoZSByZXBsYWNlciBhcnJheSBhcmUKICAgICAgICAgICAgc3RyaW5naWZpZWQuCgogICAgICAgICAgICBWYWx1ZXMgdGhhdCBkbyBub3QgaGF2ZSBKU09OIHJlcHJlc2VudGF0aW9ucywgc3VjaCBhcyB1bmRlZmluZWQgb3IKICAgICAgICAgICAgZnVuY3Rpb25zLCB3aWxsIG5vdCBiZSBzZXJpYWxpemVkLiBTdWNoIHZhbHVlcyBpbiBvYmplY3RzIHdpbGwgYmUKICAgICAgICAgICAgZHJvcHBlZDsgaW4gYXJyYXlzIHRoZXkgd2lsbCBiZSByZXBsYWNlZCB3aXRoIG51bGwuIFlvdSBjYW4gdXNlCiAgICAgICAgICAgIGEgcmVwbGFjZXIgZnVuY3Rpb24gdG8gcmVwbGFjZSB0aG9zZSB3aXRoIEpTT04gdmFsdWVzLgogICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh1bmRlZmluZWQpIHJldHVybnMgdW5kZWZpbmVkLgoKICAgICAgICAgICAgVGhlIG9wdGlvbmFsIHNwYWNlIHBhcmFtZXRlciBwcm9kdWNlcyBhIHN0cmluZ2lmaWNhdGlvbiBvZiB0aGUKICAgICAgICAgICAgdmFsdWUgdGhhdCBpcyBmaWxsZWQgd2l0aCBsaW5lIGJyZWFrcyBhbmQgaW5kZW50YXRpb24gdG8gbWFrZSBpdAogICAgICAgICAgICBlYXNpZXIgdG8gcmVhZC4KCiAgICAgICAgICAgIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBub24tZW1wdHkgc3RyaW5nLCB0aGVuIHRoYXQgc3RyaW5nIHdpbGwKICAgICAgICAgICAgYmUgdXNlZCBmb3IgaW5kZW50YXRpb24uIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIHRoZW4KICAgICAgICAgICAgdGhlIGluZGVudGF0aW9uIHdpbGwgYmUgdGhhdCBtYW55IHNwYWNlcy4KCiAgICAgICAgICAgIEV4YW1wbGU6CgogICAgICAgICAgICB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoWydlJywge3BsdXJpYnVzOiAndW51bSd9XSk7CiAgICAgICAgICAgIC8vIHRleHQgaXMgJ1siZSIseyJwbHVyaWJ1cyI6InVudW0ifV0nCgoKICAgICAgICAgICAgdGV4dCA9IEpTT04uc3RyaW5naWZ5KFsnZScsIHtwbHVyaWJ1czogJ3VudW0nfV0sIG51bGwsICdcdCcpOwogICAgICAgICAgICAvLyB0ZXh0IGlzICdbXG5cdCJlIixcblx0e1xuXHRcdCJwbHVyaWJ1cyI6ICJ1bnVtIlxuXHR9XG5dJwoKICAgICAgICAgICAgdGV4dCA9IEpTT04uc3RyaW5naWZ5KFtuZXcgRGF0ZSgpXSwgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2tleV0gaW5zdGFuY2VvZiBEYXRlID8KICAgICAgICAgICAgICAgICAgICAnRGF0ZSgnICsgdGhpc1trZXldICsgJyknIDogdmFsdWU7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyB0ZXh0IGlzICdbIkRhdGUoLS0tY3VycmVudCB0aW1lLS0tKSJdJwoKCiAgICAgICAgSlNPTi5wYXJzZSh0ZXh0LCByZXZpdmVyKQogICAgICAgICAgICBUaGlzIG1ldGhvZCBwYXJzZXMgYSBKU09OIHRleHQgdG8gcHJvZHVjZSBhbiBvYmplY3Qgb3IgYXJyYXkuCiAgICAgICAgICAgIEl0IGNhbiB0aHJvdyBhIFN5bnRheEVycm9yIGV4Y2VwdGlvbi4KCiAgICAgICAgICAgIFRoZSBvcHRpb25hbCByZXZpdmVyIHBhcmFtZXRlciBpcyBhIGZ1bmN0aW9uIHRoYXQgY2FuIGZpbHRlciBhbmQKICAgICAgICAgICAgdHJhbnNmb3JtIHRoZSByZXN1bHRzLiBJdCByZWNlaXZlcyBlYWNoIG9mIHRoZSBrZXlzIGFuZCB2YWx1ZXMsCiAgICAgICAgICAgIGFuZCBpdHMgcmV0dXJuIHZhbHVlIGlzIHVzZWQgaW5zdGVhZCBvZiB0aGUgb3JpZ2luYWwgdmFsdWUuCiAgICAgICAgICAgIElmIGl0IHJldHVybnMgd2hhdCBpdCByZWNlaXZlZCwgdGhlbiB0aGUgc3RydWN0dXJlIGlzIG5vdCBtb2RpZmllZC4KICAgICAgICAgICAgSWYgaXQgcmV0dXJucyB1bmRlZmluZWQgdGhlbiB0aGUgbWVtYmVyIGlzIGRlbGV0ZWQuCgogICAgICAgICAgICBFeGFtcGxlOgoKICAgICAgICAgICAgLy8gUGFyc2UgdGhlIHRleHQuIFZhbHVlcyB0aGF0IGxvb2sgbGlrZSBJU08gZGF0ZSBzdHJpbmdzIHdpbGwKICAgICAgICAgICAgLy8gYmUgY29udmVydGVkIHRvIERhdGUgb2JqZWN0cy4KCiAgICAgICAgICAgIG15RGF0YSA9IEpTT04ucGFyc2UodGV4dCwgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBhOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBhID0KL14oXGR7NH0pLShcZHsyfSktKFxkezJ9KVQoXGR7Mn0pOihcZHsyfSk6KFxkezJ9KD86XC5cZCopPylaJC8uZXhlYyh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKCthWzFdLCArYVsyXSAtIDEsICthWzNdLCArYVs0XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICthWzVdLCArYVs2XSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBteURhdGEgPSBKU09OLnBhcnNlKCdbIkRhdGUoMDkvMDkvMjAwMSkiXScsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgZDsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnNsaWNlKDAsIDUpID09PSAnRGF0ZSgnICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnNsaWNlKC0xKSA9PT0gJyknKSB7CiAgICAgICAgICAgICAgICAgICAgZCA9IG5ldyBEYXRlKHZhbHVlLnNsaWNlKDUsIC0xKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9KTsKCgogICAgVGhpcyBpcyBhIHJlZmVyZW5jZSBpbXBsZW1lbnRhdGlvbi4gWW91IGFyZSBmcmVlIHRvIGNvcHksIG1vZGlmeSwgb3IKICAgIHJlZGlzdHJpYnV0ZS4KKi8KCi8qanNsaW50IGV2aWw6IHRydWUsIHJlZ2V4cDogdHJ1ZSAqLwoKLyptZW1iZXJzICIiLCAiXGIiLCAiXHQiLCAiXG4iLCAiXGYiLCAiXHIiLCAiXCIiLCBKU09OLCAiXFwiLCBhcHBseSwKICAgIGNhbGwsIGNoYXJDb2RlQXQsIGdldFVUQ0RhdGUsIGdldFVUQ0Z1bGxZZWFyLCBnZXRVVENIb3VycywKICAgIGdldFVUQ01pbnV0ZXMsIGdldFVUQ01vbnRoLCBnZXRVVENTZWNvbmRzLCBoYXNPd25Qcm9wZXJ0eSwgam9pbiwKICAgIGxhc3RJbmRleCwgbGVuZ3RoLCBwYXJzZSwgcHJvdG90eXBlLCBwdXNoLCByZXBsYWNlLCBzbGljZSwgc3RyaW5naWZ5LAogICAgdGVzdCwgdG9KU09OLCB0b1N0cmluZywgdmFsdWVPZgoqLwoKCi8vIENyZWF0ZSBhIEpTT04gb2JqZWN0IG9ubHkgaWYgb25lIGRvZXMgbm90IGFscmVhZHkgZXhpc3QuIFdlIGNyZWF0ZSB0aGUKLy8gbWV0aG9kcyBpbiBhIGNsb3N1cmUgdG8gYXZvaWQgY3JlYXRpbmcgZ2xvYmFsIHZhcmlhYmxlcy4KCmlmICh0eXBlb2YgSlNPTiAhPT0gJ29iamVjdCcpIHsKICAgIEpTT04gPSB7fTsKfQoKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCdqc29uLWllNycsWydyZXF1aXJlJ10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgCgogICAgZnVuY3Rpb24gZihuKSB7CiAgICAgICAgLy8gRm9ybWF0IGludGVnZXJzIHRvIGhhdmUgYXQgbGVhc3QgdHdvIGRpZ2l0cy4KICAgICAgICByZXR1cm4gbiA8IDEwID8gJzAnICsgbiA6IG47CiAgICB9CgogICAgaWYgKHR5cGVvZiBEYXRlLnByb3RvdHlwZS50b0pTT04gIT09ICdmdW5jdGlvbicpIHsKCiAgICAgICAgRGF0ZS5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgcmV0dXJuIGlzRmluaXRlKHRoaXMudmFsdWVPZigpKQogICAgICAgICAgICAgICAgPyB0aGlzLmdldFVUQ0Z1bGxZZWFyKCkgICAgICsgJy0nICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTW9udGgoKSArIDEpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDRGF0ZSgpKSAgICAgICsgJ1QnICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDSG91cnMoKSkgICAgICsgJzonICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTWludXRlcygpKSAgICsgJzonICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDU2Vjb25kcygpKSAgICsgJ1onCiAgICAgICAgICAgICAgICA6IG51bGw7CiAgICAgICAgfTsKCiAgICAgICAgU3RyaW5nLnByb3RvdHlwZS50b0pTT04gICAgICA9CiAgICAgICAgICAgIE51bWJlci5wcm90b3R5cGUudG9KU09OICA9CiAgICAgICAgICAgIEJvb2xlYW4ucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZhbHVlT2YoKTsKICAgICAgICAgICAgfTsKICAgIH0KCiAgICB2YXIgY3ggPSAvW1x1MDAwMFx1MDBhZFx1MDYwMC1cdTA2MDRcdTA3MGZcdTE3YjRcdTE3YjVcdTIwMGMtXHUyMDBmXHUyMDI4LVx1MjAyZlx1MjA2MC1cdTIwNmZcdWZlZmZcdWZmZjAtXHVmZmZmXS9nLAogICAgICAgIGVzY2FwYWJsZSA9IC9bXFxcIlx4MDAtXHgxZlx4N2YtXHg5Zlx1MDBhZFx1MDYwMC1cdTA2MDRcdTA3MGZcdTE3YjRcdTE3YjVcdTIwMGMtXHUyMDBmXHUyMDI4LVx1MjAyZlx1MjA2MC1cdTIwNmZcdWZlZmZcdWZmZjAtXHVmZmZmXS9nLAogICAgICAgIGdhcCwKICAgICAgICBpbmRlbnQsCiAgICAgICAgbWV0YSA9IHsgICAgLy8gdGFibGUgb2YgY2hhcmFjdGVyIHN1YnN0aXR1dGlvbnMKICAgICAgICAgICAgJ1xiJzogJ1xcYicsCiAgICAgICAgICAgICdcdCc6ICdcXHQnLAogICAgICAgICAgICAnXG4nOiAnXFxuJywKICAgICAgICAgICAgJ1xmJzogJ1xcZicsCiAgICAgICAgICAgICdccic6ICdcXHInLAogICAgICAgICAgICAnIicgOiAnXFwiJywKICAgICAgICAgICAgJ1xcJzogJ1xcXFwnCiAgICAgICAgfSwKICAgICAgICByZXA7CgoKICAgIGZ1bmN0aW9uIHF1b3RlKHN0cmluZykgewoKLy8gSWYgdGhlIHN0cmluZyBjb250YWlucyBubyBjb250cm9sIGNoYXJhY3RlcnMsIG5vIHF1b3RlIGNoYXJhY3RlcnMsIGFuZCBubwovLyBiYWNrc2xhc2ggY2hhcmFjdGVycywgdGhlbiB3ZSBjYW4gc2FmZWx5IHNsYXAgc29tZSBxdW90ZXMgYXJvdW5kIGl0LgovLyBPdGhlcndpc2Ugd2UgbXVzdCBhbHNvIHJlcGxhY2UgdGhlIG9mZmVuZGluZyBjaGFyYWN0ZXJzIHdpdGggc2FmZSBlc2NhcGUKLy8gc2VxdWVuY2VzLgoKICAgICAgICBlc2NhcGFibGUubGFzdEluZGV4ID0gMDsKICAgICAgICByZXR1cm4gZXNjYXBhYmxlLnRlc3Qoc3RyaW5nKSA/ICciJyArIHN0cmluZy5yZXBsYWNlKGVzY2FwYWJsZSwgZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgdmFyIGMgPSBtZXRhW2FdOwogICAgICAgICAgICByZXR1cm4gdHlwZW9mIGMgPT09ICdzdHJpbmcnCiAgICAgICAgICAgICAgICA/IGMKICAgICAgICAgICAgICAgIDogJ1xcdScgKyAoJzAwMDAnICsgYS5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTQpOwogICAgICAgIH0pICsgJyInIDogJyInICsgc3RyaW5nICsgJyInOwogICAgfQoKCiAgICBmdW5jdGlvbiBzdHIoa2V5LCBob2xkZXIpIHsKCi8vIFByb2R1Y2UgYSBzdHJpbmcgZnJvbSBob2xkZXJba2V5XS4KCiAgICAgICAgdmFyIGksICAgICAgICAgIC8vIFRoZSBsb29wIGNvdW50ZXIuCiAgICAgICAgICAgIGssICAgICAgICAgIC8vIFRoZSBtZW1iZXIga2V5LgogICAgICAgICAgICB2LCAgICAgICAgICAvLyBUaGUgbWVtYmVyIHZhbHVlLgogICAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICAgIG1pbmQgPSBnYXAsCiAgICAgICAgICAgIHBhcnRpYWwsCiAgICAgICAgICAgIHZhbHVlID0gaG9sZGVyW2tleV07CgovLyBJZiB0aGUgdmFsdWUgaGFzIGEgdG9KU09OIG1ldGhvZCwgY2FsbCBpdCB0byBvYnRhaW4gYSByZXBsYWNlbWVudCB2YWx1ZS4KCiAgICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYKICAgICAgICAgICAgICAgIHR5cGVvZiB2YWx1ZS50b0pTT04gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS50b0pTT04oa2V5KTsKICAgICAgICB9CgovLyBJZiB3ZSB3ZXJlIGNhbGxlZCB3aXRoIGEgcmVwbGFjZXIgZnVuY3Rpb24sIHRoZW4gY2FsbCB0aGUgcmVwbGFjZXIgdG8KLy8gb2J0YWluIGEgcmVwbGFjZW1lbnQgdmFsdWUuCgogICAgICAgIGlmICh0eXBlb2YgcmVwID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHZhbHVlID0gcmVwLmNhbGwoaG9sZGVyLCBrZXksIHZhbHVlKTsKICAgICAgICB9CgovLyBXaGF0IGhhcHBlbnMgbmV4dCBkZXBlbmRzIG9uIHRoZSB2YWx1ZSdzIHR5cGUuCgogICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgcmV0dXJuIHF1b3RlKHZhbHVlKTsKCiAgICAgICAgY2FzZSAnbnVtYmVyJzoKCi8vIEpTT04gbnVtYmVycyBtdXN0IGJlIGZpbml0ZS4gRW5jb2RlIG5vbi1maW5pdGUgbnVtYmVycyBhcyBudWxsLgoKICAgICAgICAgICAgcmV0dXJuIGlzRmluaXRlKHZhbHVlKSA/IFN0cmluZyh2YWx1ZSkgOiAnbnVsbCc7CgogICAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgIGNhc2UgJ251bGwnOgoKLy8gSWYgdGhlIHZhbHVlIGlzIGEgYm9vbGVhbiBvciBudWxsLCBjb252ZXJ0IGl0IHRvIGEgc3RyaW5nLiBOb3RlOgovLyB0eXBlb2YgbnVsbCBkb2VzIG5vdCBwcm9kdWNlICdudWxsJy4gVGhlIGNhc2UgaXMgaW5jbHVkZWQgaGVyZSBpbgovLyB0aGUgcmVtb3RlIGNoYW5jZSB0aGF0IHRoaXMgZ2V0cyBmaXhlZCBzb21lZGF5LgoKICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7CgovLyBJZiB0aGUgdHlwZSBpcyAnb2JqZWN0Jywgd2UgbWlnaHQgYmUgZGVhbGluZyB3aXRoIGFuIG9iamVjdCBvciBhbiBhcnJheSBvcgovLyBudWxsLgoKICAgICAgICBjYXNlICdvYmplY3QnOgoKLy8gRHVlIHRvIGEgc3BlY2lmaWNhdGlvbiBibHVuZGVyIGluIEVDTUFTY3JpcHQsIHR5cGVvZiBudWxsIGlzICdvYmplY3QnLAovLyBzbyB3YXRjaCBvdXQgZm9yIHRoYXQgY2FzZS4KCiAgICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAnbnVsbCc7CiAgICAgICAgICAgIH0KCi8vIE1ha2UgYW4gYXJyYXkgdG8gaG9sZCB0aGUgcGFydGlhbCByZXN1bHRzIG9mIHN0cmluZ2lmeWluZyB0aGlzIG9iamVjdCB2YWx1ZS4KCiAgICAgICAgICAgIGdhcCArPSBpbmRlbnQ7CiAgICAgICAgICAgIHBhcnRpYWwgPSBbXTsKCi8vIElzIHRoZSB2YWx1ZSBhbiBhcnJheT8KCiAgICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KHZhbHVlKSA9PT0gJ1tvYmplY3QgQXJyYXldJykgewoKLy8gVGhlIHZhbHVlIGlzIGFuIGFycmF5LiBTdHJpbmdpZnkgZXZlcnkgZWxlbWVudC4gVXNlIG51bGwgYXMgYSBwbGFjZWhvbGRlcgovLyBmb3Igbm9uLUpTT04gdmFsdWVzLgoKICAgICAgICAgICAgICAgIGxlbmd0aCA9IHZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgICAgIHBhcnRpYWxbaV0gPSBzdHIoaSwgdmFsdWUpIHx8ICdudWxsJzsKICAgICAgICAgICAgICAgIH0KCi8vIEpvaW4gYWxsIG9mIHRoZSBlbGVtZW50cyB0b2dldGhlciwgc2VwYXJhdGVkIHdpdGggY29tbWFzLCBhbmQgd3JhcCB0aGVtIGluCi8vIGJyYWNrZXRzLgoKICAgICAgICAgICAgICAgIHYgPSBwYXJ0aWFsLmxlbmd0aCA9PT0gMAogICAgICAgICAgICAgICAgICAgID8gJ1tdJwogICAgICAgICAgICAgICAgICAgIDogZ2FwCiAgICAgICAgICAgICAgICAgICAgPyAnW1xuJyArIGdhcCArIHBhcnRpYWwuam9pbignLFxuJyArIGdhcCkgKyAnXG4nICsgbWluZCArICddJwogICAgICAgICAgICAgICAgICAgIDogJ1snICsgcGFydGlhbC5qb2luKCcsJykgKyAnXSc7CiAgICAgICAgICAgICAgICBnYXAgPSBtaW5kOwogICAgICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgICAgIH0KCi8vIElmIHRoZSByZXBsYWNlciBpcyBhbiBhcnJheSwgdXNlIGl0IHRvIHNlbGVjdCB0aGUgbWVtYmVycyB0byBiZSBzdHJpbmdpZmllZC4KCiAgICAgICAgICAgIGlmIChyZXAgJiYgdHlwZW9mIHJlcCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIGxlbmd0aCA9IHJlcC5sZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlcFtpXSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgayA9IHJlcFtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHN0cihrLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0aWFsLnB1c2gocXVvdGUoaykgKyAoZ2FwID8gJzogJyA6ICc6JykgKyB2KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKCi8vIE90aGVyd2lzZSwgaXRlcmF0ZSB0aHJvdWdoIGFsbCBvZiB0aGUga2V5cyBpbiB0aGUgb2JqZWN0LgoKICAgICAgICAgICAgICAgIGZvciAoayBpbiB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGspKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHYgPSBzdHIoaywgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydGlhbC5wdXNoKHF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCi8vIEpvaW4gYWxsIG9mIHRoZSBtZW1iZXIgdGV4dHMgdG9nZXRoZXIsIHNlcGFyYXRlZCB3aXRoIGNvbW1hcywKLy8gYW5kIHdyYXAgdGhlbSBpbiBicmFjZXMuCgogICAgICAgICAgICB2ID0gcGFydGlhbC5sZW5ndGggPT09IDAKICAgICAgICAgICAgICAgID8gJ3t9JwogICAgICAgICAgICAgICAgOiBnYXAKICAgICAgICAgICAgICAgID8gJ3tcbicgKyBnYXAgKyBwYXJ0aWFsLmpvaW4oJyxcbicgKyBnYXApICsgJ1xuJyArIG1pbmQgKyAnfScKICAgICAgICAgICAgICAgIDogJ3snICsgcGFydGlhbC5qb2luKCcsJykgKyAnfSc7CiAgICAgICAgICAgIGdhcCA9IG1pbmQ7CiAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgIH0KICAgIH0KCi8vIElmIHRoZSBKU09OIG9iamVjdCBkb2VzIG5vdCB5ZXQgaGF2ZSBhIHN0cmluZ2lmeSBtZXRob2QsIGdpdmUgaXQgb25lLgoKICAgIGlmICh0eXBlb2YgSlNPTi5zdHJpbmdpZnkgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICBKU09OLnN0cmluZ2lmeSA9IGZ1bmN0aW9uICh2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKSB7CgovLyBUaGUgc3RyaW5naWZ5IG1ldGhvZCB0YWtlcyBhIHZhbHVlIGFuZCBhbiBvcHRpb25hbCByZXBsYWNlciwgYW5kIGFuIG9wdGlvbmFsCi8vIHNwYWNlIHBhcmFtZXRlciwgYW5kIHJldHVybnMgYSBKU09OIHRleHQuIFRoZSByZXBsYWNlciBjYW4gYmUgYSBmdW5jdGlvbgovLyB0aGF0IGNhbiByZXBsYWNlIHZhbHVlcywgb3IgYW4gYXJyYXkgb2Ygc3RyaW5ncyB0aGF0IHdpbGwgc2VsZWN0IHRoZSBrZXlzLgovLyBBIGRlZmF1bHQgcmVwbGFjZXIgbWV0aG9kIGNhbiBiZSBwcm92aWRlZC4gVXNlIG9mIHRoZSBzcGFjZSBwYXJhbWV0ZXIgY2FuCi8vIHByb2R1Y2UgdGV4dCB0aGF0IGlzIG1vcmUgZWFzaWx5IHJlYWRhYmxlLgoKICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgIGdhcCA9ICcnOwogICAgICAgICAgICBpbmRlbnQgPSAnJzsKCi8vIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIG1ha2UgYW4gaW5kZW50IHN0cmluZyBjb250YWluaW5nIHRoYXQKLy8gbWFueSBzcGFjZXMuCgogICAgICAgICAgICBpZiAodHlwZW9mIHNwYWNlID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNwYWNlOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICBpbmRlbnQgKz0gJyAnOwogICAgICAgICAgICAgICAgfQoKLy8gSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIHN0cmluZywgaXQgd2lsbCBiZSB1c2VkIGFzIHRoZSBpbmRlbnQgc3RyaW5nLgoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3BhY2UgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBpbmRlbnQgPSBzcGFjZTsKICAgICAgICAgICAgfQoKLy8gSWYgdGhlcmUgaXMgYSByZXBsYWNlciwgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIGFuIGFycmF5LgovLyBPdGhlcndpc2UsIHRocm93IGFuIGVycm9yLgoKICAgICAgICAgICAgcmVwID0gcmVwbGFjZXI7CiAgICAgICAgICAgIGlmIChyZXBsYWNlciAmJiB0eXBlb2YgcmVwbGFjZXIgIT09ICdmdW5jdGlvbicgJiYKICAgICAgICAgICAgICAgICAgICAodHlwZW9mIHJlcGxhY2VyICE9PSAnb2JqZWN0JyB8fAogICAgICAgICAgICAgICAgICAgIHR5cGVvZiByZXBsYWNlci5sZW5ndGggIT09ICdudW1iZXInKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdKU09OLnN0cmluZ2lmeScpOwogICAgICAgICAgICB9CgovLyBNYWtlIGEgZmFrZSByb290IG9iamVjdCBjb250YWluaW5nIG91ciB2YWx1ZSB1bmRlciB0aGUga2V5IG9mICcnLgovLyBSZXR1cm4gdGhlIHJlc3VsdCBvZiBzdHJpbmdpZnlpbmcgdGhlIHZhbHVlLgoKICAgICAgICAgICAgcmV0dXJuIHN0cignJywgeycnOiB2YWx1ZX0pOwogICAgICAgIH07CiAgICB9CgoKLy8gSWYgdGhlIEpTT04gb2JqZWN0IGRvZXMgbm90IHlldCBoYXZlIGEgcGFyc2UgbWV0aG9kLCBnaXZlIGl0IG9uZS4KCiAgICBpZiAodHlwZW9mIEpTT04ucGFyc2UgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICBKU09OLnBhcnNlID0gZnVuY3Rpb24gKHRleHQsIHJldml2ZXIpIHsKCi8vIFRoZSBwYXJzZSBtZXRob2QgdGFrZXMgYSB0ZXh0IGFuZCBhbiBvcHRpb25hbCByZXZpdmVyIGZ1bmN0aW9uLCBhbmQgcmV0dXJucwovLyBhIEphdmFTY3JpcHQgdmFsdWUgaWYgdGhlIHRleHQgaXMgYSB2YWxpZCBKU09OIHRleHQuCgogICAgICAgICAgICB2YXIgajsKCiAgICAgICAgICAgIGZ1bmN0aW9uIHdhbGsoaG9sZGVyLCBrZXkpIHsKCi8vIFRoZSB3YWxrIG1ldGhvZCBpcyB1c2VkIHRvIHJlY3Vyc2l2ZWx5IHdhbGsgdGhlIHJlc3VsdGluZyBzdHJ1Y3R1cmUgc28KLy8gdGhhdCBtb2RpZmljYXRpb25zIGNhbiBiZSBtYWRlLgoKICAgICAgICAgICAgICAgIHZhciBrLCB2LCB2YWx1ZSA9IGhvbGRlcltrZXldOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGsgaW4gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSB3YWxrKHZhbHVlLCBrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZVtrXSA9IHY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB2YWx1ZVtrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXZpdmVyLmNhbGwoaG9sZGVyLCBrZXksIHZhbHVlKTsKICAgICAgICAgICAgfQoKCi8vIFBhcnNpbmcgaGFwcGVucyBpbiBmb3VyIHN0YWdlcy4gSW4gdGhlIGZpcnN0IHN0YWdlLCB3ZSByZXBsYWNlIGNlcnRhaW4KLy8gVW5pY29kZSBjaGFyYWN0ZXJzIHdpdGggZXNjYXBlIHNlcXVlbmNlcy4gSmF2YVNjcmlwdCBoYW5kbGVzIG1hbnkgY2hhcmFjdGVycwovLyBpbmNvcnJlY3RseSwgZWl0aGVyIHNpbGVudGx5IGRlbGV0aW5nIHRoZW0sIG9yIHRyZWF0aW5nIHRoZW0gYXMgbGluZSBlbmRpbmdzLgoKICAgICAgICAgICAgdGV4dCA9IFN0cmluZyh0ZXh0KTsKICAgICAgICAgICAgY3gubGFzdEluZGV4ID0gMDsKICAgICAgICAgICAgaWYgKGN4LnRlc3QodGV4dCkpIHsKICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoY3gsIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdcXHUnICsKICAgICAgICAgICAgICAgICAgICAgICAgKCcwMDAwJyArIGEuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC00KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgovLyBJbiB0aGUgc2Vjb25kIHN0YWdlLCB3ZSBydW4gdGhlIHRleHQgYWdhaW5zdCByZWd1bGFyIGV4cHJlc3Npb25zIHRoYXQgbG9vawovLyBmb3Igbm9uLUpTT04gcGF0dGVybnMuIFdlIGFyZSBlc3BlY2lhbGx5IGNvbmNlcm5lZCB3aXRoICcoKScgYW5kICduZXcnCi8vIGJlY2F1c2UgdGhleSBjYW4gY2F1c2UgaW52b2NhdGlvbiwgYW5kICc9JyBiZWNhdXNlIGl0IGNhbiBjYXVzZSBtdXRhdGlvbi4KLy8gQnV0IGp1c3QgdG8gYmUgc2FmZSwgd2Ugd2FudCB0byByZWplY3QgYWxsIHVuZXhwZWN0ZWQgZm9ybXMuCgovLyBXZSBzcGxpdCB0aGUgc2Vjb25kIHN0YWdlIGludG8gNCByZWdleHAgb3BlcmF0aW9ucyBpbiBvcmRlciB0byB3b3JrIGFyb3VuZAovLyBjcmlwcGxpbmcgaW5lZmZpY2llbmNpZXMgaW4gSUUncyBhbmQgU2FmYXJpJ3MgcmVnZXhwIGVuZ2luZXMuIEZpcnN0IHdlCi8vIHJlcGxhY2UgdGhlIEpTT04gYmFja3NsYXNoIHBhaXJzIHdpdGggJ0AnIChhIG5vbi1KU09OIGNoYXJhY3RlcikuIFNlY29uZCwgd2UKLy8gcmVwbGFjZSBhbGwgc2ltcGxlIHZhbHVlIHRva2VucyB3aXRoICddJyBjaGFyYWN0ZXJzLiBUaGlyZCwgd2UgZGVsZXRlIGFsbAovLyBvcGVuIGJyYWNrZXRzIHRoYXQgZm9sbG93IGEgY29sb24gb3IgY29tbWEgb3IgdGhhdCBiZWdpbiB0aGUgdGV4dC4gRmluYWxseSwKLy8gd2UgbG9vayB0byBzZWUgdGhhdCB0aGUgcmVtYWluaW5nIGNoYXJhY3RlcnMgYXJlIG9ubHkgd2hpdGVzcGFjZSBvciAnXScgb3IKLy8gJywnIG9yICc6JyBvciAneycgb3IgJ30nLiBJZiB0aGF0IGlzIHNvLCB0aGVuIHRoZSB0ZXh0IGlzIHNhZmUgZm9yIGV2YWwuCgogICAgICAgICAgICBpZiAoL15bXF0sOnt9XHNdKiQvCiAgICAgICAgICAgICAgICAgICAgLnRlc3QodGV4dC5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICdAJykKICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLyJbXiJcXFxuXHJdKiJ8dHJ1ZXxmYWxzZXxudWxsfC0/XGQrKD86XC5cZCopPyg/OltlRV1bK1wtXT9cZCspPy9nLCAnXScpCiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICcnKSkpIHsKCi8vIEluIHRoZSB0aGlyZCBzdGFnZSB3ZSB1c2UgdGhlIGV2YWwgZnVuY3Rpb24gdG8gY29tcGlsZSB0aGUgdGV4dCBpbnRvIGEKLy8gSmF2YVNjcmlwdCBzdHJ1Y3R1cmUuIFRoZSAneycgb3BlcmF0b3IgaXMgc3ViamVjdCB0byBhIHN5bnRhY3RpYyBhbWJpZ3VpdHkKLy8gaW4gSmF2YVNjcmlwdDogaXQgY2FuIGJlZ2luIGEgYmxvY2sgb3IgYW4gb2JqZWN0IGxpdGVyYWwuIFdlIHdyYXAgdGhlIHRleHQKLy8gaW4gcGFyZW5zIHRvIGVsaW1pbmF0ZSB0aGUgYW1iaWd1aXR5LgoKICAgICAgICAgICAgICAgIGogPSBldmFsKCcoJyArIHRleHQgKyAnKScpOwoKLy8gSW4gdGhlIG9wdGlvbmFsIGZvdXJ0aCBzdGFnZSwgd2UgcmVjdXJzaXZlbHkgd2FsayB0aGUgbmV3IHN0cnVjdHVyZSwgcGFzc2luZwovLyBlYWNoIG5hbWUvdmFsdWUgcGFpciB0byBhIHJldml2ZXIgZnVuY3Rpb24gZm9yIHBvc3NpYmxlIHRyYW5zZm9ybWF0aW9uLgoKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgcmV2aXZlciA9PT0gJ2Z1bmN0aW9uJwogICAgICAgICAgICAgICAgICAgID8gd2Fsayh7Jyc6IGp9LCAnJykKICAgICAgICAgICAgICAgICAgICA6IGo7CiAgICAgICAgICAgIH0KCi8vIElmIHRoZSB0ZXh0IGlzIG5vdCBKU09OIHBhcnNlYWJsZSwgdGhlbiBhIFN5bnRheEVycm9yIGlzIHRocm93bi4KCiAgICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignSlNPTi5wYXJzZScpOwogICAgICAgIH07CiAgICB9Cn0pOwoKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCdjaGlyb3ByYWN0b3Ivdmlld3MvYmFzZScsWydyZXF1aXJlJywndW5kZXJzY29yZScsJ2pzb24taWU3JywnanF1ZXJ5JywnYmFja2JvbmUnLCdoYW5kbGViYXJzJ10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgCgogICAgdmFyIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyksCiAgICAgICAgSlNPTiA9IHJlcXVpcmUoJ2pzb24taWU3JyksCiAgICAgICAgJCA9IHJlcXVpcmUoJ2pxdWVyeScpLAogICAgICAgIEJhY2tib25lID0gcmVxdWlyZSgnYmFja2JvbmUnKSwKICAgICAgICBIYW5kbGViYXJzID0gcmVxdWlyZSgnaGFuZGxlYmFycycpLAogICAgICAgIHJlbW92ZUhhbmRsZXJUZXN0ID0gJCgnPHNwYW4+PC9zcGFuPicpLAogICAgICAgIHJlbW92ZUhhbmRsZXJFeGlzdHMgPSBmYWxzZSwKICAgICAgICBwbGFjZWhvbGRlcklkOwoKICAgIHJlbW92ZUhhbmRsZXJUZXN0Lm9uKCdyZW1vdmUnLCBmdW5jdGlvbigpIHsgcmVtb3ZlSGFuZGxlckV4aXN0cyA9IHRydWU7IH0pOwogICAgcmVtb3ZlSGFuZGxlclRlc3QucmVtb3ZlKCk7CgogICAgaWYgKCFyZW1vdmVIYW5kbGVyRXhpc3RzKSB7CiAgICAgICAgJC5ldmVudC5zcGVjaWFsLnJlbW92ZSA9IHsKICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBpZiAoZS5oYW5kbGVyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyICRlbCA9ICQodGhpcyk7CiAgICAgICAgICAgICAgICAgICAgLy8gU2luY2UgdGhpcyBldmVudCBnZXRzIGZpcmVkIG9uIGNhbGxpbmcgJGVsLm9mZigncmVtb3ZlJykKICAgICAgICAgICAgICAgICAgICAvLyBhcyB3ZWxsIGFzIHdoZW4gdGhlICRlbC5yZW1vdmUoKSBnZXRzIGNhbGxlZCwgd2UgbmVlZCB0bwogICAgICAgICAgICAgICAgICAgIC8vIGFsbG93IHRoZSBCYWNrYm9uZSBWaWV3IHRvIHVucmVnaXN0ZXIgdGhpcyB3aXRob3V0CiAgICAgICAgICAgICAgICAgICAgLy8gZmlyaW5nIGl0LgogICAgICAgICAgICAgICAgICAgIGlmKCEkZWwuaGFzQ2xhc3MoJ3JlbW92ZWRFdmVudEZpcmVkJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGVsLmFkZENsYXNzKCdyZW1vdmVkRXZlbnRGaXJlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICBlLmhhbmRsZXIuY2FsbCh0aGlzLCBuZXcgJC5FdmVudCgncmVtb3ZlJywge3RhcmdldDogdGhpc30pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQoKICAgIHBsYWNlaG9sZGVySWQgPSBmdW5jdGlvbih2aWV3KSB7CiAgICAgICAgcmV0dXJuICdjaGlyb3ByYWN0b3JJZCcgKyB2aWV3LmNpZDsKICAgIH07CgogICAgcmV0dXJuIEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgICBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS5pbml0aWFsaXplLmNhbGwodGhpcywgb3B0aW9ucyk7CgogICAgICAgICAgICBfLmJpbmRBbGwodGhpcywgJ3JlbW92ZScpOwoKICAgICAgICAgICAgdGhpcy5fY2hpbGRWaWV3cyA9IFtdOwogICAgICAgICAgICB0aGlzLl9jb250ZXh0ID0gb3B0aW9ucy5jb250ZXh0IHx8IHt9OwoKICAgICAgICAgICAgdGhpcy4kZWwub24oJ3JlbW92ZScsIHRoaXMucmVtb3ZlKTsKICAgICAgICB9LAoKICAgICAgICBfYWRkQ2hpbGQ6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgdGhpcy5fY2hpbGRWaWV3cy5wdXNoKHZpZXcpOwogICAgICAgICAgICByZXR1cm4gJzwnICsgdmlldy5lbC50YWdOYW1lICsKICAgICAgICAgICAgICAgICcgaWQ9IicgKyBwbGFjZWhvbGRlcklkKHZpZXcpICsgJyI+PC9kaXY+JzsKICAgICAgICB9LAoKICAgICAgICBjb250ZXh0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIG1vZGVsOiB0aGlzLm1vZGVsLAogICAgICAgICAgICAgICAgY29sbGVjdGlvbjogdGhpcy5jb2xsZWN0aW9uCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdHlwZW9mKHRoaXMudGVtcGxhdGUpID09PSAnc3RyaW5nJyA/CiAgICAgICAgICAgICAgICAgICAgSGFuZGxlYmFycy5jb21waWxlKHRoaXMudGVtcGxhdGUpIDogdGhpcy50ZW1wbGF0ZSwKICAgICAgICAgICAgICAgIGNvbnRleHQgPSB0eXBlb2YodGhpcy5jb250ZXh0KSA9PT0gJ2Z1bmN0aW9uJyA/CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0KCkgOiB0aGlzLmNvbnRleHQ7CgogICAgICAgICAgICBjb250ZXh0LmRlY2xhcmluZ1ZpZXcgPSB0aGlzOwogICAgICAgICAgICBfLmRlZmF1bHRzKGNvbnRleHQsIHRoaXMuX2NvbnRleHQpOwoKICAgICAgICAgICAgaWYgKHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKHRlbXBsYXRlKGNvbnRleHQpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgXyh0aGlzLl9jaGlsZFZpZXdzKS5lYWNoKGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgICAgIHRoaXMuJCgnIycgKyBwbGFjZWhvbGRlcklkKHZpZXcpKS5yZXBsYWNlV2l0aCh2aWV3LmVsKTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuJGVsLmFkZENsYXNzKCdyZW1vdmVkRXZlbnRGaXJlZCcpOwogICAgICAgICAgICB0aGlzLiRlbC5vZmYoJ3JlbW92ZScsIHRoaXMucmVtb3ZlKTsKICAgICAgICAgICAgXyh0aGlzLl9jaGlsZFZpZXdzKS5lYWNoKGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgICAgIHZpZXcucmVtb3ZlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9jaGlsZFZpZXdzID0gW107CiAgICAgICAgICAgIEJhY2tib25lLlZpZXcucHJvdG90eXBlLnJlbW92ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgIH0pOwp9KTsKCi8qZ2xvYmFsIGRlZmluZSovCmRlZmluZSgnY2hpcm9wcmFjdG9yL3ZpZXdzL2Zvcm0nLFsncmVxdWlyZScsJ3VuZGVyc2NvcmUnLCdqc29uLWllNycsJ2pxdWVyeScsJ2JhY2tib25lJywnLi9iYXNlJ10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgCgogICAgdmFyIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyksCiAgICAgICAgSlNPTiA9IHJlcXVpcmUoJ2pzb24taWU3JyksCiAgICAgICAgJCA9IHJlcXVpcmUoJ2pxdWVyeScpLAogICAgICAgIEJhY2tib25lID0gcmVxdWlyZSgnYmFja2JvbmUnKSwKICAgICAgICBCYXNlID0gcmVxdWlyZSgnLi9iYXNlJyk7CgogICAgcmV0dXJuIEJhc2UuZXh0ZW5kKHsKICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgQmFzZS5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLmxpc3RlbkZvckVycm9ycyh0aGlzLm1vZGVsKTsKICAgICAgICAgICAgdGhpcy5saXN0ZW5Gb3JFcnJvcnModGhpcy5jb2xsZWN0aW9uKTsKICAgICAgICB9LAoKICAgICAgICBsaXN0ZW5Gb3JFcnJvcnM6IGZ1bmN0aW9uKG9iaikgewogICAgICAgICAgICBpZiAob2JqKSB7CiAgICAgICAgICAgICAgICBpZiAob2JqIGluc3RhbmNlb2YgQmFja2JvbmUuTW9kZWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3RlblRvKG9iaiwgJ2ludmFsaWQnLCB0aGlzLnJlbmRlckZvcm1FcnJvcnMpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuVG8ob2JqLCAnY2hhbmdlJywgdGhpcy5jbGVhckZvcm1FcnJvcnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAob2JqIGluc3RhbmNlb2YgQmFja2JvbmUuQ29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgIG9iai5lYWNoKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuVG8obW9kZWwsICdpbnZhbGlkJywgdGhpcy5yZW5kZXJGb3JtRXJyb3JzKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5Ubyhtb2RlbCwgJ2NoYW5nZScsIHRoaXMuY2xlYXJGb3JtRXJyb3JzKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBvYmplY3QgdG8gYXNzb2NpYXRlIGVycm9ycyB3aXRoLicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgY2xlYXJGb3JtRXJyb3JzOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAgICAgICBfKG1vZGVsLmNoYW5nZWQpLmVhY2goZnVuY3Rpb24odmFsdWUsIGZpZWxkKSB7CiAgICAgICAgICAgICAgICB0aGlzLiQoJyNjb250YWluZXItJyArIG1vZGVsLmZpZWxkSWQoZmllbGQpKQogICAgICAgICAgICAgICAgICAgIC5maW5kKCcuaGVscC1pbmxpbmUnKS5odG1sKCcnKTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfSwKCiAgICAgICAgcmVuZGVyRm9ybUVycm9yczogZnVuY3Rpb24obW9kZWwsIGVycm9ycykgewogICAgICAgICAgICBfKGVycm9ycykuZWFjaChmdW5jdGlvbihlcnJvck1lc3NhZ2VzLCBmaWVsZCkgewogICAgICAgICAgICAgICAgdmFyIGhlbHA7CiAgICAgICAgICAgICAgICBlcnJvck1lc3NhZ2VzID0gdHlwZW9mKGVycm9yTWVzc2FnZXMpID09PSAnc3RyaW5nJyA/CiAgICAgICAgICAgICAgICAgICAgW2Vycm9yTWVzc2FnZXNdIDogZXJyb3JNZXNzYWdlczsKCiAgICAgICAgICAgICAgICBpZiAoZmllbGQgPT09ICdfX2FsbF9fJykgewogICAgICAgICAgICAgICAgICAgIGhlbHAgPSAkKCc8ZGl2IGNsYXNzPSJlcnJvcnMiPjwvZGl2PicpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJGVsLnByZXBlbmQoaGVscCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBoZWxwID0gdGhpcy4kKCcjY29udGFpbmVyLScgKyBtb2RlbC5maWVsZElkKGZpZWxkKSkKICAgICAgICAgICAgICAgICAgICAgICAgLmZpbmQoJy5oZWxwLWlubGluZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGhlbHAuaHRtbChlcnJvck1lc3NhZ2VzLmpvaW4oJywgJykpOwogICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICB9CiAgICB9KTsKfSk7CgoKLyogU1RBUlRfVEVNUExBVEUgKi8KZGVmaW5lKCdoYnMhY2hpcm9wcmFjdG9yL3ZpZXdzL3RlbXBsYXRlcy9maWVsZHMvbGFiZWwnLFsnaGJzJywnaGFuZGxlYmFycyddLCBmdW5jdGlvbiggaGJzLCBIYW5kbGViYXJzICl7IAp2YXIgdCA9IEhhbmRsZWJhcnMudGVtcGxhdGUoZnVuY3Rpb24gKEhhbmRsZWJhcnMsZGVwdGgwLGhlbHBlcnMscGFydGlhbHMsZGF0YSkgewogIGhlbHBlcnMgPSBoZWxwZXJzIHx8IEhhbmRsZWJhcnMuaGVscGVyczsKICB2YXIgc3RhY2sxLCBmb3VuZEhlbHBlciwgZnVuY3Rpb25UeXBlPSJmdW5jdGlvbiIsIGVzY2FwZUV4cHJlc3Npb249dGhpcy5lc2NhcGVFeHByZXNzaW9uOwoKCiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLnZhbHVlOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAudmFsdWU7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgcmV0dXJuIGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKTt9KTsKSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoJ2NoaXJvcHJhY3Rvcl92aWV3c190ZW1wbGF0ZXNfZmllbGRzX2xhYmVsJywgdCk7CnJldHVybiB0Owp9KTsKLyogRU5EX1RFTVBMQVRFICovCjsKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCdjaGlyb3ByYWN0b3Ivdmlld3MvZmllbGQnLFsncmVxdWlyZScsJ2pzb24taWU3JywnanF1ZXJ5JywndW5kZXJzY29yZScsJ2hhbmRsZWJhcnMnLCdoYnMhLi90ZW1wbGF0ZXMvZmllbGRzL2xhYmVsJ10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgCgogICAgdmFyIEpTT04gPSByZXF1aXJlKCdqc29uLWllNycpLAogICAgICAgICQgPSByZXF1aXJlKCdqcXVlcnknKSwKICAgICAgICBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpLAogICAgICAgIEhhbmRsZWJhcnMgPSByZXF1aXJlKCdoYW5kbGViYXJzJyksCiAgICAgICAgZmllbGRUZW1wbGF0ZXMgPSB7fSwKICAgICAgICBsYWJlbCA9IHJlcXVpcmUoJ2hicyEuL3RlbXBsYXRlcy9maWVsZHMvbGFiZWwnKTsKCiAgICAgICAgZmllbGRUZW1wbGF0ZXMgPSB7CiAgICAgICAgICAgICdkZWZhdWx0cyc6IGxhYmVsCiAgICAgICAgfTsKCiAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdmaWVsZCcsIGZ1bmN0aW9uKHR5cGUsIG1vZGVsLCBmaWVsZE5hbWUpIHsKICAgICAgICAgICAgLy8gdGVtcGxhdGUgaGVscGVyIGluIHRoZSBmb3JtIG9mOgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyAgICAgIHt7IGZpZWxkICd0ZXh0JyBtb2RlbCAnZmllbGRuYW1lJyBbYXR0ck5hbWU9ImF0dHJWYWx1ZSJdKn19CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGZpZWxkVGVtcGxhdGVzW3R5cGVdLAogICAgICAgICAgICAgICAgb3B0aW9ucyA9IGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoIC0gMV0sCiAgICAgICAgICAgICAgICBvcHRzID0gb3B0aW9ucy5oYXNoIHx8IHt9LAogICAgICAgICAgICAgICAgZmllbGQgPSBvcHRzLmZpZWxkLAogICAgICAgICAgICAgICAgaWQgPSAnJywKICAgICAgICAgICAgICAgIHZhbHVlID0gJyc7CgogICAgICAgICAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgIHRlbXBsYXRlID0gZmllbGRUZW1wbGF0ZXMuZGVmYXVsdHM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChtb2RlbCkgewogICAgICAgICAgICAgICAgaWQgPSBtb2RlbC5maWVsZElkKGZpZWxkTmFtZSk7CiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKG1vZGVsKTsKICAgICAgICAgICAgICAgIGlmIChmaWVsZCkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gbW9kZWwuZ2V0KGZpZWxkLmlkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgXy5kZWZhdWx0cyhvcHRzLCB7CiAgICAgICAgICAgICAgICBpZDogaWQsCiAgICAgICAgICAgICAgICBsYWJlbDogZmllbGROYW1lLAogICAgICAgICAgICAgICAgbmFtZTogZmllbGROYW1lLAogICAgICAgICAgICAgICAgb3B0aW9uczogW10sCiAgICAgICAgICAgICAgICBibGFuazogZmFsc2UsCiAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgICBoZWxwOiAnJywKICAgICAgICAgICAgICAgIG1vZGVsOiBtb2RlbAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcodGVtcGxhdGUob3B0cykpOwogICAgICAgIH0pOwoKICAgIHJldHVybiB7CiAgICAgICAgVGVtcGxhdGVzOiBmaWVsZFRlbXBsYXRlcywKICAgICAgICBhZGRUZW1wbGF0ZTogZnVuY3Rpb24obmFtZSx0ZW1wbGF0ZSkgewogICAgICAgICAgICBmaWVsZFRlbXBsYXRlc1tuYW1lXSA9IHRlbXBsYXRlOwogICAgICAgIH0KICAgIH07Cn0pOwoKCi8qIFNUQVJUX1RFTVBMQVRFICovCmRlZmluZSgnaGJzIWNoaXJvcHJhY3Rvci92aWV3cy90ZW1wbGF0ZXMvcm93L3JvdycsWydoYnMnLCdoYW5kbGViYXJzJ10sIGZ1bmN0aW9uKCBoYnMsIEhhbmRsZWJhcnMgKXsgCnZhciB0ID0gSGFuZGxlYmFycy50ZW1wbGF0ZShmdW5jdGlvbiAoSGFuZGxlYmFycyxkZXB0aDAsaGVscGVycyxwYXJ0aWFscyxkYXRhKSB7CiAgaGVscGVycyA9IGhlbHBlcnMgfHwgSGFuZGxlYmFycy5oZWxwZXJzOwogIHZhciBidWZmZXIgPSAiIiwgc3RhY2sxLCBmb3VuZEhlbHBlciwgaGVscGVyTWlzc2luZz1oZWxwZXJzLmhlbHBlck1pc3NpbmcsIGVzY2FwZUV4cHJlc3Npb249dGhpcy5lc2NhcGVFeHByZXNzaW9uLCBmdW5jdGlvblR5cGU9ImZ1bmN0aW9uIiwgc2VsZj10aGlzOwoKZnVuY3Rpb24gcHJvZ3JhbTEoZGVwdGgwLGRhdGEsZGVwdGgxKSB7CiAgCiAgdmFyIGJ1ZmZlciA9ICIiLCBzdGFjazEsIHN0YWNrMiwgc3RhY2szLCBmb3VuZEhlbHBlcjsKICBidWZmZXIgKz0gIlxyXG4gICAgPHRkPiI7CiAgc3RhY2sxID0gZGVwdGgxLm1vZGVsOwogIHN0YWNrMiA9IGRlcHRoMC5maWVsZHR5cGU7CiAgc3RhY2szID0ge307CiAgc3RhY2szWydmaWVsZCddID0gZGVwdGgwOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5maWVsZDsKICBzdGFjazEgPSBmb3VuZEhlbHBlciA/IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCBzdGFjazIsIHN0YWNrMSwge2hhc2g6c3RhY2szfSkgOiBoZWxwZXJNaXNzaW5nLmNhbGwoZGVwdGgwLCAiZmllbGQiLCBzdGFjazIsIHN0YWNrMSwge2hhc2g6c3RhY2szfSk7CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L3RkPlxyXG4gICI7CiAgcmV0dXJuIGJ1ZmZlcjt9CgogIGJ1ZmZlciArPSAiPHRyIGNsYXNzPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMucm93Y2xhc3M7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5yb3djbGFzczsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiPlxyXG4gICI7CiAgc3RhY2sxID0gZGVwdGgwLm9wdGlvbnM7CiAgc3RhY2sxID0gc3RhY2sxID09IG51bGwgfHwgc3RhY2sxID09PSBmYWxzZSA/IHN0YWNrMSA6IHN0YWNrMS5maWVsZHM7CiAgc3RhY2sxID0gaGVscGVycy5lYWNoLmNhbGwoZGVwdGgwLCBzdGFjazEsIHtoYXNoOnt9LGludmVyc2U6c2VsZi5ub29wLGZuOnNlbGYucHJvZ3JhbVdpdGhEZXB0aChwcm9ncmFtMSwgZGF0YSwgZGVwdGgwKX0pOwogIGlmKHN0YWNrMSB8fCBzdGFjazEgPT09IDApIHsgYnVmZmVyICs9IHN0YWNrMTsgfQogIGJ1ZmZlciArPSAiXHJcbjwvdHI+IjsKICByZXR1cm4gYnVmZmVyO30pOwpIYW5kbGViYXJzLnJlZ2lzdGVyUGFydGlhbCgnY2hpcm9wcmFjdG9yX3ZpZXdzX3RlbXBsYXRlc19yb3dfcm93JywgdCk7CnJldHVybiB0Owp9KTsKLyogRU5EX1RFTVBMQVRFICovCjsKCi8qIFNUQVJUX1RFTVBMQVRFICovCmRlZmluZSgnaGJzIWNoaXJvcHJhY3Rvci92aWV3cy90ZW1wbGF0ZXMvcm93L2Vycm9yX21lc3NhZ2Vib3gnLFsnaGJzJywnaGFuZGxlYmFycyddLCBmdW5jdGlvbiggaGJzLCBIYW5kbGViYXJzICl7IAp2YXIgdCA9IEhhbmRsZWJhcnMudGVtcGxhdGUoZnVuY3Rpb24gKEhhbmRsZWJhcnMsZGVwdGgwLGhlbHBlcnMscGFydGlhbHMsZGF0YSkgewogIGhlbHBlcnMgPSBoZWxwZXJzIHx8IEhhbmRsZWJhcnMuaGVscGVyczsKICB2YXIgYnVmZmVyID0gIiIsIHN0YWNrMSwgZnVuY3Rpb25UeXBlPSJmdW5jdGlvbiIsIGVzY2FwZUV4cHJlc3Npb249dGhpcy5lc2NhcGVFeHByZXNzaW9uOwoKCiAgYnVmZmVyICs9ICI8ZGl2IGlkPVwiY2hpcm9wcmFjdG9yLWVycm9yLWJveFwiIHN0eWxlPVwiY29sb3I6ICNhOTQ0NDI7YmFja2dyb3VuZC1jb2xvcjogI2YyZGVkZTtib3JkZXItY29sb3I6ICNlYmNjZDE7cGFkZGluZzogMTVweDtib3JkZXI6IDFweCBzb2xpZCB0cmFuc3BhcmVudDtib3JkZXItcmFkaXVzOiA0cHg7XCI+XHJcbjxkaXYgYXJpYS1oaWRkZW49XCJ0cnVlXCIgc3R5bGU9XCJmbG9hdDpyaWdodDtcIiBvbkNsaWNrPVwiamF2YXNjcmlwdDp2YXIgZWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGlyb3ByYWN0b3ItZXJyb3ItYm94Jyk7ZWxlbWVudC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsZW1lbnQpO1wiPiZ0aW1lczs8L2Rpdj5cclxuPGRpdiBzdHlsZT1cImZvbnQtd2VpZ2h0OmJvbGRcIj4iOwogIHN0YWNrMSA9IGRlcHRoMC5tb2RlbDsKICBzdGFjazEgPSBzdGFjazEgPT0gbnVsbCB8fCBzdGFjazEgPT09IGZhbHNlID8gc3RhY2sxIDogc3RhY2sxLmVycm9yTWVzc2FnZTsKICBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsKICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIjwvZGl2PlxyXG48ZGl2Pk1lc3NhZ2U6ICI7CiAgc3RhY2sxID0gZGVwdGgwLm1vZGVsOwogIHN0YWNrMSA9IHN0YWNrMSA9PSBudWxsIHx8IHN0YWNrMSA9PT0gZmFsc2UgPyBzdGFjazEgOiBzdGFjazEucmVzcG9uc2U7CiAgc3RhY2sxID0gc3RhY2sxID09IG51bGwgfHwgc3RhY2sxID09PSBmYWxzZSA/IHN0YWNrMSA6IHN0YWNrMS5yZXNwb25zZVRleHQ7CiAgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L2Rpdj5cclxuPGRpdj5TdGF0dXM6ICI7CiAgc3RhY2sxID0gZGVwdGgwLm1vZGVsOwogIHN0YWNrMSA9IHN0YWNrMSA9PSBudWxsIHx8IHN0YWNrMSA9PT0gZmFsc2UgPyBzdGFjazEgOiBzdGFjazEucmVzcG9uc2U7CiAgc3RhY2sxID0gc3RhY2sxID09IG51bGwgfHwgc3RhY2sxID09PSBmYWxzZSA/IHN0YWNrMSA6IHN0YWNrMS5zdGF0dXNUZXh0OwogIHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOwogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9kaXY+XHJcbjxkaXY+U3RhdHVzQ29kZTogIjsKICBzdGFjazEgPSBkZXB0aDAubW9kZWw7CiAgc3RhY2sxID0gc3RhY2sxID09IG51bGwgfHwgc3RhY2sxID09PSBmYWxzZSA/IHN0YWNrMSA6IHN0YWNrMS5yZXNwb25zZTsKICBzdGFjazEgPSBzdGFjazEgPT0gbnVsbCB8fCBzdGFjazEgPT09IGZhbHNlID8gc3RhY2sxIDogc3RhY2sxLnN0YXR1czsKICBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsKICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIjwvZGl2PlxyXG48ZGl2PlVybDogPGEgaHJlZj1cIiI7CiAgc3RhY2sxID0gZGVwdGgwLm1vZGVsOwogIHN0YWNrMSA9IHN0YWNrMSA9PSBudWxsIHx8IHN0YWNrMSA9PT0gZmFsc2UgPyBzdGFjazEgOiBzdGFjazEudXJsOwogIHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOwogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiXCI+IjsKICBzdGFjazEgPSBkZXB0aDAubW9kZWw7CiAgc3RhY2sxID0gc3RhY2sxID09IG51bGwgfHwgc3RhY2sxID09PSBmYWxzZSA/IHN0YWNrMSA6IHN0YWNrMS51cmw7CiAgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L2E+PC9kaXY+XHJcbjwvZGl2PiI7CiAgcmV0dXJuIGJ1ZmZlcjt9KTsKSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoJ2NoaXJvcHJhY3Rvcl92aWV3c190ZW1wbGF0ZXNfcm93X2Vycm9yX21lc3NhZ2Vib3gnLCB0KTsKcmV0dXJuIHQ7Cn0pOwovKiBFTkRfVEVNUExBVEUgKi8KOwovKmdsb2JhbCBkZWZpbmUqLwpkZWZpbmUoJ2NoaXJvcHJhY3Rvci92aWV3cy9yb3cnLFsncmVxdWlyZScsJ2pzb24taWU3JywnanF1ZXJ5JywndW5kZXJzY29yZScsJ2hhbmRsZWJhcnMnLCdoYnMhLi90ZW1wbGF0ZXMvcm93L3JvdycsJ2hicyEuL3RlbXBsYXRlcy9yb3cvZXJyb3JfbWVzc2FnZWJveCddLGZ1bmN0aW9uKHJlcXVpcmUpIHsKICAgIAoKICAgIHZhciBKU09OID0gcmVxdWlyZSgnanNvbi1pZTcnKSwKICAgICAgICAkID0gcmVxdWlyZSgnanF1ZXJ5JyksCiAgICAgICAgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKICAgICAgICBIYW5kbGViYXJzID0gcmVxdWlyZSgnaGFuZGxlYmFycycpLAogICAgICAgIFJvd1RlbXBsYXRlcyA9IHt9LAogICAgICAgIFJvdyA9IHJlcXVpcmUoJ2hicyEuL3RlbXBsYXRlcy9yb3cvcm93JyksCiAgICAgICAgRXJyb3JUZW1wbGF0ZSA9IHJlcXVpcmUoJ2hicyEuL3RlbXBsYXRlcy9yb3cvZXJyb3JfbWVzc2FnZWJveCcpOwoKICAgICAgICBSb3dUZW1wbGF0ZXMgPSB7CiAgICAgICAgICAgICdyb3cnOiBSb3csCiAgICAgICAgICAgICdlcnJvcic6IEVycm9yVGVtcGxhdGUKICAgICAgICB9OwoKICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3JvdycsIGZ1bmN0aW9uKHR5cGUsIG1vZGVsLCBmaWVsZE5hbWUpIHsKICAgICAgICAgICAgLy8gdGVtcGxhdGUgaGVscGVyIGluIHRoZSBmb3JtIG9mOgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyAgICAgIHt7IGZpZWxkICd0ZXh0JyBtb2RlbCAnZmllbGRuYW1lJyBbYXR0ck5hbWU9ImF0dHJWYWx1ZSJdKn19CiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gUm93VGVtcGxhdGVzW3R5cGVdLAogICAgICAgICAgICAgICAgb3B0aW9ucyA9IGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoIC0gMV0sCiAgICAgICAgICAgICAgICBvcHRzID0gb3B0aW9ucy5oYXNoIHx8IHt9LAogICAgICAgICAgICAgICAgaWQgPSAnJywKICAgICAgICAgICAgICAgIHZhbHVlID0gJyc7CgogICAgICAgICAgICBpZiAoIWN1cnJlbnQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWdpc3RlcmVkIGZpZWxkIHRlbXBsYXRlOiAnICsgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhvcHQpOwogICAgICAgICAgICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhjdXJyZW50KHsgbW9kZWw6IG1vZGVsLCBvcHRpb25zOiBvcHRzIH0pKTsKICAgICAgICB9KTsKCiAgICByZXR1cm4gewogICAgICAgIFRlbXBsYXRlczogUm93VGVtcGxhdGVzLAogICAgICAgIGFkZFRlbXBsYXRlOiBmdW5jdGlvbihuYW1lLHRlbXBsYXRlKSB7CiAgICAgICAgICAgIFJvd1RlbXBsYXRlc1tuYW1lXSA9IHRlbXBsYXRlOwogICAgICAgIH0KICAgIH07Cn0pOwoKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCdjaGlyb3ByYWN0b3IvaGJzL3ZpZXcnLFsncmVxdWlyZScsJ3VuZGVyc2NvcmUnLCdiYWNrYm9uZScsJ2hhbmRsZWJhcnMnXSxmdW5jdGlvbihyZXF1aXJlKSB7CiAgICAKCiAgICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKICAgICAgICBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyksCiAgICAgICAgSGFuZGxlYmFycyA9IHJlcXVpcmUoJ2hhbmRsZWJhcnMnKSwKICAgICAgICB2aWV3OwoKICAgIHZpZXcgPSBmdW5jdGlvbigpIHsKICAgICAgICAvLyB0ZW1wbGF0ZSBoZWxwZXIgaW4gdGhlIGZvcm0gb2Y6CiAgICAgICAgLy8KICAgICAgICAvLyAgICAgIHt7IHZpZXcgInBhdGgvdG8vcmVxdWlyZS9tb2R1bGVbfFZpZXdOYW1lXSIgW3ZpZXdPcHRpb25zXSBbY29udGV4dF0gW3ZpZXdPcHRpb24xPXZhbCB2aWV3T3B0aW9uMj12YWxdfX0KICAgICAgICB2YXIgVmlldywgdmlldywgb3B0aW9ucywgcmVxdWlyZVBhdGgsCiAgICAgICAgICAgIHZpZXdOYW1lLCBhdHRycywgcmVxdWlyZUJpdHMsIHBsYWNlaG9sZGVyLAogICAgICAgICAgICBjb250ZXh0ID0ge307CgogICAgICAgIG9wdGlvbnMgPSBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aCAtIDFdOwogICAgICAgIGF0dHJzID0gYXJndW1lbnRzWzFdIHx8IHt9OwogICAgICAgIF8uZGVmYXVsdHMoYXR0cnMsIG9wdGlvbnMuaGFzaCB8fCB7fSk7CgogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSA0KSB7CiAgICAgICAgICAgIGNvbnRleHQgPSBhcmd1bWVudHNbMl07CiAgICAgICAgfQogICAgICAgIF8uZGVmYXVsdHModGhpcywgY29udGV4dCk7CgogICAgICAgIGlmICh0eXBlb2YoYXJndW1lbnRzWzBdKSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgcmVxdWlyZUJpdHMgPSBhcmd1bWVudHNbMF0uc3BsaXQoJ3wnKTsKICAgICAgICAgICAgcmVxdWlyZVBhdGggPSByZXF1aXJlQml0c1swXTsKICAgICAgICAgICAgdmlld05hbWUgPSByZXF1aXJlQml0c1sxXTsKCiAgICAgICAgICAgIFZpZXcgPSByZXF1aXJlKHJlcXVpcmVQYXRoKTsKICAgICAgICAgICAgaWYgKHR5cGVvZih2aWV3TmFtZSkgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBWaWV3ID0gVmlld1t2aWV3TmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIFZpZXcgPSBhcmd1bWVudHNbMF07CiAgICAgICAgfQoKICAgICAgICBpZiAob3B0aW9ucy5mbikgewogICAgICAgICAgICBWaWV3ID0gVmlldy5leHRlbmQoewogICAgICAgICAgICAgICAgdGVtcGxhdGU6IG9wdGlvbnMuZm4KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICB2aWV3ID0gbmV3IFZpZXcoYXR0cnMpLnJlbmRlcigpOwoKICAgICAgICBwbGFjZWhvbGRlciA9IHRoaXMuZGVjbGFyaW5nVmlldy5fYWRkQ2hpbGQodmlldyk7CgogICAgICAgIC8vIFJldHVybiBhIHBsYWNlaG9sZGVyIHRoYXQgdGhlIENoaXJvcHJhY3Rvci5WaWV3IGNhbiByZXBsYWNlIHdpdGgKICAgICAgICAvLyB0aGUgY2hpbGQgdmlldyBhcHBlbmRlZCBhYm92ZS4KICAgICAgICAvLyBJZiB0aGlzIGlzIGNhbGxlZCBhcyBhIGJsb2NrIGhicyBoZWxwZXIsIHRoZW4gd2UgZG8gbm90IG5lZWQgdG8KICAgICAgICAvLyB1c2Ugc2FmZSBzdHJpbmcsIHdoaWxlIGFzIGEgaGJzIHN0YXRlbWVudCBpdCBuZWVkcyB0byBiZSBkZWNsYXJlZAogICAgICAgIC8vIHNhZmUuCiAgICAgICAgaWYgKG9wdGlvbnMuZm4pIHsKICAgICAgICAgICAgcmV0dXJuIHBsYWNlaG9sZGVyOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcocGxhY2Vob2xkZXIpOwogICAgICAgIH0KICAgIH07CgogICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndmlldycsIHZpZXcpOwoKICAgIHJldHVybiB2aWV3Owp9KTsKCgovKiBTVEFSVF9URU1QTEFURSAqLwpkZWZpbmUoJ2hicyFjaGlyb3ByYWN0b3Ivdmlld3MvdGVtcGxhdGVzL2Zvcm1maWVsZC90ZXh0JyxbJ2hicycsJ2hhbmRsZWJhcnMnXSwgZnVuY3Rpb24oIGhicywgSGFuZGxlYmFycyApeyAKdmFyIHQgPSBIYW5kbGViYXJzLnRlbXBsYXRlKGZ1bmN0aW9uIChIYW5kbGViYXJzLGRlcHRoMCxoZWxwZXJzLHBhcnRpYWxzLGRhdGEpIHsKICBoZWxwZXJzID0gaGVscGVycyB8fCBIYW5kbGViYXJzLmhlbHBlcnM7CiAgdmFyIGJ1ZmZlciA9ICIiLCBzdGFjazEsIGZvdW5kSGVscGVyLCBmdW5jdGlvblR5cGU9ImZ1bmN0aW9uIiwgZXNjYXBlRXhwcmVzc2lvbj10aGlzLmVzY2FwZUV4cHJlc3Npb247CgoKICBidWZmZXIgKz0gIjxkaXYgY2xhc3M9XCJjb250cm9sLWdyb3VwXCIgaWQ9XCJjb250YWluZXItIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiPlxyXG4gICAgPGxhYmVsIGNsYXNzPVwiY29udHJvbC1sYWJlbCAiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5sYWJlbGNsYXNzOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubGFiZWxjbGFzczsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIGZvcj1cIiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmlkOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaWQ7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5sYWJlbDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmxhYmVsOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9sYWJlbD5cclxuICAgIDxkaXYgY2xhc3M9XCJjb250cm9sc1wiPlxyXG4gICAgICAgIDxpbnB1dCB0eXBlPVwidGV4dFwiIHBsYWNlaG9sZGVyPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMucGxhY2Vob2xkZXI7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5wbGFjZWhvbGRlcjsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIGlkPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIG5hbWU9XCIiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5uYW1lOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubmFtZTsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIHZhbHVlPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMudmFsdWU7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC52YWx1ZTsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIGNsYXNzPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnNbJ2NsYXNzJ107CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMFsnY2xhc3MnXTsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIC8+XHJcbiAgICAgICAgPHNwYW4gY2xhc3M9XCJkZXNjcmlwdGlvblwiPiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmRlc2NyaXB0aW9uOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuZGVzY3JpcHRpb247IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L3NwYW4+XHJcbiAgICAgICAgPHNwYW4gY2xhc3M9XCJoZWxwLWlubGluZVwiPiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmhlbHA7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5oZWxwOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9zcGFuPlxyXG4gICAgPC9kaXY+XHJcbjwvZGl2PlxyXG4iOwogIHJldHVybiBidWZmZXI7fSk7CkhhbmRsZWJhcnMucmVnaXN0ZXJQYXJ0aWFsKCdjaGlyb3ByYWN0b3Jfdmlld3NfdGVtcGxhdGVzX2Zvcm1maWVsZF90ZXh0JywgdCk7CnJldHVybiB0Owp9KTsKLyogRU5EX1RFTVBMQVRFICovCjsKCi8qIFNUQVJUX1RFTVBMQVRFICovCmRlZmluZSgnaGJzIWNoaXJvcHJhY3Rvci92aWV3cy90ZW1wbGF0ZXMvZm9ybWZpZWxkL3RleHRhcmVhJyxbJ2hicycsJ2hhbmRsZWJhcnMnXSwgZnVuY3Rpb24oIGhicywgSGFuZGxlYmFycyApeyAKdmFyIHQgPSBIYW5kbGViYXJzLnRlbXBsYXRlKGZ1bmN0aW9uIChIYW5kbGViYXJzLGRlcHRoMCxoZWxwZXJzLHBhcnRpYWxzLGRhdGEpIHsKICBoZWxwZXJzID0gaGVscGVycyB8fCBIYW5kbGViYXJzLmhlbHBlcnM7CiAgdmFyIGJ1ZmZlciA9ICIiLCBzdGFjazEsIGZvdW5kSGVscGVyLCBmdW5jdGlvblR5cGU9ImZ1bmN0aW9uIiwgZXNjYXBlRXhwcmVzc2lvbj10aGlzLmVzY2FwZUV4cHJlc3Npb247CgoKICBidWZmZXIgKz0gIjxkaXYgY2xhc3M9XCJjb250cm9sLWdyb3VwXCIgaWQ9XCJjb250YWluZXItIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiPlxyXG4gICAgPGxhYmVsIGNsYXNzPVwiY29udHJvbC1sYWJlbFwiIGZvcj1cIiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmlkOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaWQ7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5sYWJlbDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmxhYmVsOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9sYWJlbD5cclxuICAgIDxkaXYgY2xhc3M9XCJjb250cm9sc1wiPlxyXG4gICAgICAgIDx0ZXh0YXJlYSBpZD1cIiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmlkOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaWQ7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIiBuYW1lPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMubmFtZTsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLm5hbWU7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy52YWx1ZTsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLnZhbHVlOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC90ZXh0YXJlYT5cclxuICAgICAgICA8c3BhbiBjbGFzcz1cImhlbHAtaW5saW5lXCI+IjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaGVscDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmhlbHA7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L3NwYW4+XHJcbiAgICA8L2Rpdj5cclxuPC9kaXY+XHJcbiI7CiAgcmV0dXJuIGJ1ZmZlcjt9KTsKSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwoJ2NoaXJvcHJhY3Rvcl92aWV3c190ZW1wbGF0ZXNfZm9ybWZpZWxkX3RleHRhcmVhJywgdCk7CnJldHVybiB0Owp9KTsKLyogRU5EX1RFTVBMQVRFICovCjsKCi8qIFNUQVJUX1RFTVBMQVRFICovCmRlZmluZSgnaGJzIWNoaXJvcHJhY3Rvci92aWV3cy90ZW1wbGF0ZXMvZm9ybWZpZWxkL3NlbGVjdCcsWydoYnMnLCdoYW5kbGViYXJzJ10sIGZ1bmN0aW9uKCBoYnMsIEhhbmRsZWJhcnMgKXsgCnZhciB0ID0gSGFuZGxlYmFycy50ZW1wbGF0ZShmdW5jdGlvbiAoSGFuZGxlYmFycyxkZXB0aDAsaGVscGVycyxwYXJ0aWFscyxkYXRhKSB7CiAgaGVscGVycyA9IGhlbHBlcnMgfHwgSGFuZGxlYmFycy5oZWxwZXJzOwogIHZhciBidWZmZXIgPSAiIiwgc3RhY2sxLCBmb3VuZEhlbHBlciwgZnVuY3Rpb25UeXBlPSJmdW5jdGlvbiIsIGVzY2FwZUV4cHJlc3Npb249dGhpcy5lc2NhcGVFeHByZXNzaW9uLCBzZWxmPXRoaXMsIGhlbHBlck1pc3Npbmc9aGVscGVycy5oZWxwZXJNaXNzaW5nOwoKZnVuY3Rpb24gcHJvZ3JhbTEoZGVwdGgwLGRhdGEpIHsKICAKICB2YXIgYnVmZmVyID0gIiIsIHN0YWNrMSwgZm91bmRIZWxwZXI7CiAgYnVmZmVyICs9ICJcclxuICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9XCJcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5ibGFuazsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmJsYW5rOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9vcHRpb24+XHJcbiAgICAgICAgICAgICI7CiAgcmV0dXJuIGJ1ZmZlcjt9CgpmdW5jdGlvbiBwcm9ncmFtMyhkZXB0aDAsZGF0YSxkZXB0aDEpIHsKICAKICB2YXIgYnVmZmVyID0gIiIsIHN0YWNrMSwgc3RhY2syLCBmb3VuZEhlbHBlcjsKICBidWZmZXIgKz0gIlxyXG4gICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT1cIiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLnZhbHVlOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAudmFsdWU7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIiI7CiAgc3RhY2sxID0gZGVwdGgxLnZhbHVlOwogIHN0YWNrMiA9IGRlcHRoMC52YWx1ZTsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWZlcXVhbDsKICBzdGFjazEgPSBmb3VuZEhlbHBlciA/IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCBzdGFjazIsIHN0YWNrMSwge2hhc2g6e30saW52ZXJzZTpzZWxmLm5vb3AsZm46c2VsZi5wcm9ncmFtKDQsIHByb2dyYW00LCBkYXRhKX0pIDogaGVscGVyTWlzc2luZy5jYWxsKGRlcHRoMCwgImlmZXF1YWwiLCBzdGFjazIsIHN0YWNrMSwge2hhc2g6e30saW52ZXJzZTpzZWxmLm5vb3AsZm46c2VsZi5wcm9ncmFtKDQsIHByb2dyYW00LCBkYXRhKX0pOwogIGlmKHN0YWNrMSB8fCBzdGFjazEgPT09IDApIHsgYnVmZmVyICs9IHN0YWNrMTsgfQogIGJ1ZmZlciArPSAiPiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmxhYmVsOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubGFiZWw7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L29wdGlvbj5cclxuICAgICAgICAgICAgIjsKICByZXR1cm4gYnVmZmVyO30KZnVuY3Rpb24gcHJvZ3JhbTQoZGVwdGgwLGRhdGEpIHsKICAKICAKICByZXR1cm4gIiBzZWxlY3RlZD1cInNlbGVjdGVkXCIiO30KCiAgYnVmZmVyICs9ICI8ZGl2IGNsYXNzPVwiY29udHJvbC1ncm91cFwiIGlkPVwiY29udGFpbmVyLSI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmlkOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaWQ7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIj5cclxuICAgIDxsYWJlbCBjbGFzcz1cImNvbnRyb2wtbGFiZWwgIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMubGFiZWxjbGFzczsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmxhYmVsY2xhc3M7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIiBmb3I9XCIiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5pZDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmlkOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiXCI+IjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMubGFiZWw7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5sYWJlbDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIjwvbGFiZWw+XHJcbiAgICA8ZGl2IGNsYXNzPVwiY29udHJvbHNcIj5cclxuICAgICAgICA8c2VsZWN0IGlkPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIG5hbWU9XCIiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5uYW1lOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubmFtZTsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiPlxyXG4gICAgICAgICAgICAiOwogIHN0YWNrMSA9IGRlcHRoMC5ibGFuazsKICBzdGFjazEgPSBoZWxwZXJzWydpZiddLmNhbGwoZGVwdGgwLCBzdGFjazEsIHtoYXNoOnt9LGludmVyc2U6c2VsZi5ub29wLGZuOnNlbGYucHJvZ3JhbSgxLCBwcm9ncmFtMSwgZGF0YSl9KTsKICBpZihzdGFjazEgfHwgc3RhY2sxID09PSAwKSB7IGJ1ZmZlciArPSBzdGFjazE7IH0KICBidWZmZXIgKz0gIlxyXG4gICAgICAgICAgICAiOwogIHN0YWNrMSA9IGRlcHRoMC5vcHRpb25zOwogIHN0YWNrMSA9IGhlbHBlcnMuZWFjaC5jYWxsKGRlcHRoMCwgc3RhY2sxLCB7aGFzaDp7fSxpbnZlcnNlOnNlbGYubm9vcCxmbjpzZWxmLnByb2dyYW1XaXRoRGVwdGgocHJvZ3JhbTMsIGRhdGEsIGRlcHRoMCl9KTsKICBpZihzdGFjazEgfHwgc3RhY2sxID09PSAwKSB7IGJ1ZmZlciArPSBzdGFjazE7IH0KICBidWZmZXIgKz0gIlxyXG4gICAgICAgIDwvc2VsZWN0PlxyXG4gICAgICAgIDxzcGFuIGNsYXNzPVwiZGVzY3JpcHRpb25cIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5kZXNjcmlwdGlvbjsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmRlc2NyaXB0aW9uOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9zcGFuPlxyXG4gICAgICAgIDxzcGFuIGNsYXNzPVwiaGVscC1pbmxpbmVcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5oZWxwOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaGVscDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIjwvc3Bhbj5cclxuICAgIDwvZGl2PlxyXG48L2Rpdj5cclxuIjsKICByZXR1cm4gYnVmZmVyO30pOwpIYW5kbGViYXJzLnJlZ2lzdGVyUGFydGlhbCgnY2hpcm9wcmFjdG9yX3ZpZXdzX3RlbXBsYXRlc19mb3JtZmllbGRfc2VsZWN0JywgdCk7CnJldHVybiB0Owp9KTsKLyogRU5EX1RFTVBMQVRFICovCjsKCi8qIFNUQVJUX1RFTVBMQVRFICovCmRlZmluZSgnaGJzIWNoaXJvcHJhY3Rvci92aWV3cy90ZW1wbGF0ZXMvZm9ybWZpZWxkL2NoZWNrYm94JyxbJ2hicycsJ2hhbmRsZWJhcnMnXSwgZnVuY3Rpb24oIGhicywgSGFuZGxlYmFycyApeyAKdmFyIHQgPSBIYW5kbGViYXJzLnRlbXBsYXRlKGZ1bmN0aW9uIChIYW5kbGViYXJzLGRlcHRoMCxoZWxwZXJzLHBhcnRpYWxzLGRhdGEpIHsKICBoZWxwZXJzID0gaGVscGVycyB8fCBIYW5kbGViYXJzLmhlbHBlcnM7CiAgdmFyIGJ1ZmZlciA9ICIiLCBzdGFjazEsIGZvdW5kSGVscGVyLCBmdW5jdGlvblR5cGU9ImZ1bmN0aW9uIiwgZXNjYXBlRXhwcmVzc2lvbj10aGlzLmVzY2FwZUV4cHJlc3Npb24sIHNlbGY9dGhpczsKCmZ1bmN0aW9uIHByb2dyYW0xKGRlcHRoMCxkYXRhKSB7CiAgCiAgdmFyIGJ1ZmZlciA9ICIiLCBzdGFjazEsIGZvdW5kSGVscGVyOwogIGJ1ZmZlciArPSAiIFxyXG4gICAgICAgICAgICA8aW5wdXQgdHlwZT1cImNoZWNrYm94XCIgaWQ9XCIiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5pZDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmlkOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiXCIgbmFtZT1cIiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLm5hbWU7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5uYW1lOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiXCIgdmFsdWU9XCIiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy52YWx1ZTsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLnZhbHVlOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiXCIgLz4gIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMubGFiZWw7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5sYWJlbDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlxyXG4gICAgICAgICI7CiAgcmV0dXJuIGJ1ZmZlcjt9CgogIGJ1ZmZlciArPSAiPGRpdiBjbGFzcz1cImNvbnRyb2wtZ3JvdXBcIiBpZD1cImNvbnRhaW5lci0iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5pZDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmlkOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiXCI+XHJcbiAgICA8bGFiZWwgY2xhc3M9XCJjb250cm9sLWxhYmVsXCIgZm9yPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiPiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmxhYmVsOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubGFiZWw7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICI8L2xhYmVsPlxyXG4gICAgPGRpdiBjbGFzcz1cImNvbnRyb2xzXCI+XHJcbiAgICAgICAgIjsKICBzdGFjazEgPSBkZXB0aDAub3B0aW9uczsKICBzdGFjazEgPSBoZWxwZXJzLmVhY2guY2FsbChkZXB0aDAsIHN0YWNrMSwge2hhc2g6e30saW52ZXJzZTpzZWxmLm5vb3AsZm46c2VsZi5wcm9ncmFtKDEsIHByb2dyYW0xLCBkYXRhKX0pOwogIGlmKHN0YWNrMSB8fCBzdGFjazEgPT09IDApIHsgYnVmZmVyICs9IHN0YWNrMTsgfQogIGJ1ZmZlciArPSAiXHJcbiAgICAgICAgPHNwYW4gY2xhc3M9XCJoZWxwLWlubGluZVwiPiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmhlbHA7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5oZWxwOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9zcGFuPlxyXG4gICAgPC9kaXY+XHJcbjwvZGl2PlxyXG4iOwogIHJldHVybiBidWZmZXI7fSk7CkhhbmRsZWJhcnMucmVnaXN0ZXJQYXJ0aWFsKCdjaGlyb3ByYWN0b3Jfdmlld3NfdGVtcGxhdGVzX2Zvcm1maWVsZF9jaGVja2JveCcsIHQpOwpyZXR1cm4gdDsKfSk7Ci8qIEVORF9URU1QTEFURSAqLwo7CgovKiBTVEFSVF9URU1QTEFURSAqLwpkZWZpbmUoJ2hicyFjaGlyb3ByYWN0b3Ivdmlld3MvdGVtcGxhdGVzL2Zvcm1maWVsZC9yYWRpbycsWydoYnMnLCdoYW5kbGViYXJzJ10sIGZ1bmN0aW9uKCBoYnMsIEhhbmRsZWJhcnMgKXsgCnZhciB0ID0gSGFuZGxlYmFycy50ZW1wbGF0ZShmdW5jdGlvbiAoSGFuZGxlYmFycyxkZXB0aDAsaGVscGVycyxwYXJ0aWFscyxkYXRhKSB7CiAgaGVscGVycyA9IGhlbHBlcnMgfHwgSGFuZGxlYmFycy5oZWxwZXJzOwogIHZhciBidWZmZXIgPSAiIiwgc3RhY2sxLCBmb3VuZEhlbHBlciwgZnVuY3Rpb25UeXBlPSJmdW5jdGlvbiIsIGVzY2FwZUV4cHJlc3Npb249dGhpcy5lc2NhcGVFeHByZXNzaW9uLCBzZWxmPXRoaXM7CgpmdW5jdGlvbiBwcm9ncmFtMShkZXB0aDAsZGF0YSkgewogIAogIHZhciBidWZmZXIgPSAiIiwgc3RhY2sxLCBmb3VuZEhlbHBlcjsKICBidWZmZXIgKz0gIiBcclxuICAgICAgICAgICAgPGlucHV0IHR5cGU9XCJyYWRpb1wiIGlkPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIG5hbWU9XCIiOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5uYW1lOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubmFtZTsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIHZhbHVlPVwiIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMudmFsdWU7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC52YWx1ZTsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiIC8+ICI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmxhYmVsOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAubGFiZWw7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcclxuICAgICAgICAiOwogIHJldHVybiBidWZmZXI7fQoKICBidWZmZXIgKz0gIjxkaXYgY2xhc3M9XCJjb250cm9sLWdyb3VwXCIgaWQ9XCJjb250YWluZXItIjsKICBmb3VuZEhlbHBlciA9IGhlbHBlcnMuaWQ7CiAgaWYgKGZvdW5kSGVscGVyKSB7IHN0YWNrMSA9IGZvdW5kSGVscGVyLmNhbGwoZGVwdGgwLCB7aGFzaDp7fX0pOyB9CiAgZWxzZSB7IHN0YWNrMSA9IGRlcHRoMC5pZDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIlwiPlxyXG4gICAgPGxhYmVsIGNsYXNzPVwiY29udHJvbC1sYWJlbFwiIGZvcj1cIiI7CiAgZm91bmRIZWxwZXIgPSBoZWxwZXJzLmlkOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaWQ7IHN0YWNrMSA9IHR5cGVvZiBzdGFjazEgPT09IGZ1bmN0aW9uVHlwZSA/IHN0YWNrMSgpIDogc3RhY2sxOyB9CiAgYnVmZmVyICs9IGVzY2FwZUV4cHJlc3Npb24oc3RhY2sxKSArICJcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5sYWJlbDsKICBpZiAoZm91bmRIZWxwZXIpIHsgc3RhY2sxID0gZm91bmRIZWxwZXIuY2FsbChkZXB0aDAsIHtoYXNoOnt9fSk7IH0KICBlbHNlIHsgc3RhY2sxID0gZGVwdGgwLmxhYmVsOyBzdGFjazEgPSB0eXBlb2Ygc3RhY2sxID09PSBmdW5jdGlvblR5cGUgPyBzdGFjazEoKSA6IHN0YWNrMTsgfQogIGJ1ZmZlciArPSBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSkgKyAiPC9sYWJlbD5cclxuICAgIDxkaXYgY2xhc3M9XCJjb250cm9sc1wiPlxyXG4gICAgICAgICI7CiAgc3RhY2sxID0gZGVwdGgwLm9wdGlvbnM7CiAgc3RhY2sxID0gaGVscGVycy5lYWNoLmNhbGwoZGVwdGgwLCBzdGFjazEsIHtoYXNoOnt9LGludmVyc2U6c2VsZi5ub29wLGZuOnNlbGYucHJvZ3JhbSgxLCBwcm9ncmFtMSwgZGF0YSl9KTsKICBpZihzdGFjazEgfHwgc3RhY2sxID09PSAwKSB7IGJ1ZmZlciArPSBzdGFjazE7IH0KICBidWZmZXIgKz0gIlxyXG4gICAgICAgIDxzcGFuIGNsYXNzPVwiaGVscC1pbmxpbmVcIj4iOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5oZWxwOwogIGlmIChmb3VuZEhlbHBlcikgeyBzdGFjazEgPSBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwge2hhc2g6e319KTsgfQogIGVsc2UgeyBzdGFjazEgPSBkZXB0aDAuaGVscDsgc3RhY2sxID0gdHlwZW9mIHN0YWNrMSA9PT0gZnVuY3Rpb25UeXBlID8gc3RhY2sxKCkgOiBzdGFjazE7IH0KICBidWZmZXIgKz0gZXNjYXBlRXhwcmVzc2lvbihzdGFjazEpICsgIjwvc3Bhbj5cclxuICAgIDwvZGl2PlxyXG48L2Rpdj5cclxuIjsKICByZXR1cm4gYnVmZmVyO30pOwpIYW5kbGViYXJzLnJlZ2lzdGVyUGFydGlhbCgnY2hpcm9wcmFjdG9yX3ZpZXdzX3RlbXBsYXRlc19mb3JtZmllbGRfcmFkaW8nLCB0KTsKcmV0dXJuIHQ7Cn0pOwovKiBFTkRfVEVNUExBVEUgKi8KOwovKmdsb2JhbCBkZWZpbmUqLwpkZWZpbmUoJ2NoaXJvcHJhY3Rvci92aWV3cy9mb3JtZmllbGQnLFsncmVxdWlyZScsJ2pzb24taWU3JywnanF1ZXJ5JywndW5kZXJzY29yZScsJ2hhbmRsZWJhcnMnLCcuLi9oYnMvdmlldycsJy4vYmFzZScsJ2hicyEuL3RlbXBsYXRlcy9mb3JtZmllbGQvdGV4dCcsJ2hicyEuL3RlbXBsYXRlcy9mb3JtZmllbGQvdGV4dGFyZWEnLCdoYnMhLi90ZW1wbGF0ZXMvZm9ybWZpZWxkL3NlbGVjdCcsJ2hicyEuL3RlbXBsYXRlcy9mb3JtZmllbGQvY2hlY2tib3gnLCdoYnMhLi90ZW1wbGF0ZXMvZm9ybWZpZWxkL3JhZGlvJ10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgCgogICAgdmFyIEpTT04gPSByZXF1aXJlKCdqc29uLWllNycpLAogICAgICAgICQgPSByZXF1aXJlKCdqcXVlcnknKSwKICAgICAgICBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpLAogICAgICAgIEhhbmRsZWJhcnMgPSByZXF1aXJlKCdoYW5kbGViYXJzJyksCiAgICAgICAgdmlld0hlbHBlciA9IHJlcXVpcmUoJy4uL2hicy92aWV3JyksCiAgICAgICAgQmFzZSA9IHJlcXVpcmUoJy4vYmFzZScpLAogICAgICAgIGZpZWxkVGVtcGxhdGVzID0ge30sCiAgICAgICAgVmlldywgcmVnaXN0ZXI7CgogICAgVmlldyA9IEJhc2UuZXh0ZW5kKHsKICAgICAgICBldmVudHM6IHsKICAgICAgICAgICAgJ2NoYW5nZSBpbnB1dCc6ICdpbnB1dENoYW5nZWQnLAogICAgICAgICAgICAnYmx1ciBpbnB1dCc6ICdpbnB1dENoYW5nZWQnLAogICAgICAgICAgICAnY2hhbmdlIHNlbGVjdCc6ICdpbnB1dENoYW5nZWQnLAogICAgICAgICAgICAnYmx1ciBzZWxlY3QnOiAnaW5wdXRDaGFuZ2VkJywKICAgICAgICAgICAgJ2NoYW5nZSB0ZXh0YXJlYSc6ICdpbnB1dENoYW5nZWQnLAogICAgICAgICAgICAnYmx1ciB0ZXh0YXJlYSc6ICdpbnB1dENoYW5nZWQnCiAgICAgICAgfSwKCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICBCYXNlLnByb3RvdHlwZS5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gb3B0aW9ucy5jb250ZXh0OwogICAgICAgICAgICB0aGlzLmZpZWxkID0gb3B0aW9ucy5maWVsZDsKICAgICAgICB9LAogICAgICAgIGlucHV0Q2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB2YWwgPSB0aGlzLiQoJ1tuYW1lPScgKyB0aGlzLmZpZWxkICsgJ10nKS52YWwoKTsKICAgICAgICAgICAgdGhpcy5tb2RlbC5zZXQodGhpcy5maWVsZCwgdmFsLCB7dmFsaWRhdGU6IHRydWV9KTsKICAgICAgICAgICAgLy8gV2Ugd2FudCB0byBlbnN1cmUgdGhhdCB0aGUgbW9kZWwgdmFsdWUgaXMgcmVhbGx5IHVwZGF0ZWQgZXZlbgogICAgICAgICAgICAvLyBpZiB2YWxpZGF0aW9uIGZhaWxzIGluIHRoZSBwcmV2aW91cyBzdGVwLiBIb3dldmVyLCBpdCBzaG91bGQgYmUKICAgICAgICAgICAgLy8gc2lsZW50IGFuZCBub3QgdHJpZ2dlciBhbnkgY2hhbmdlIGV2ZW50cyBzaW5jZSB0aGUgcHJldmlvdXMgc3RlcAogICAgICAgICAgICAvLyB3aWxsIHRha2UgY2FyZSBvZiB0aGF0IGluIHRoZSBjYXNlIG9mIHN1Y2Nlc3MuCiAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KHRoaXMuZmllbGQsIHZhbCwge3NpbGVudDogdHJ1ZX0pOwogICAgICAgIH0KICAgIH0pOwoKICAgIFZpZXcucmVnaXN0ZXIgPSByZWdpc3RlciA9IGZ1bmN0aW9uKHR5cGUsIGRlZikgewogICAgICAgIHZhciBTdWJDbGFzcyA9IGZpZWxkVGVtcGxhdGVzW3R5cGVdID0gdGhpcy5leHRlbmQoZGVmKTsKICAgICAgICBTdWJDbGFzcy5yZWdpc3RlciA9IHJlZ2lzdGVyOwogICAgICAgIHJldHVybiBTdWJDbGFzczsKICAgIH07CgogICAgVmlldy51bnJlZ2lzdGVyID0gZnVuY3Rpb24odHlwZSkgewogICAgICAgIGlmIChmaWVsZFRlbXBsYXRlc1t0eXBlXSkgewogICAgICAgICAgICBkZWxldGUgZmllbGRUZW1wbGF0ZXNbdHlwZV07CiAgICAgICAgfQogICAgfTsKCiAgICBWaWV3LnJlZ2lzdGVyKCd0ZXh0JywgewogICAgICAgIHRlbXBsYXRlOiByZXF1aXJlKCdoYnMhLi90ZW1wbGF0ZXMvZm9ybWZpZWxkL3RleHQnKQogICAgfSk7CgogICAgVmlldy5yZWdpc3RlcigndGV4dGFyZWEnLCB7CiAgICAgICAgdGVtcGxhdGU6IHJlcXVpcmUoJ2hicyEuL3RlbXBsYXRlcy9mb3JtZmllbGQvdGV4dGFyZWEnKQogICAgfSk7CgogICAgVmlldy5yZWdpc3Rlcignc2VsZWN0JywgewogICAgICAgIHRlbXBsYXRlOiByZXF1aXJlKCdoYnMhLi90ZW1wbGF0ZXMvZm9ybWZpZWxkL3NlbGVjdCcpCiAgICB9KTsKCiAgICBWaWV3LnJlZ2lzdGVyKCdjaGVja2JveCcsIHsKICAgICAgICB0ZW1wbGF0ZTogcmVxdWlyZSgnaGJzIS4vdGVtcGxhdGVzL2Zvcm1maWVsZC9jaGVja2JveCcpCiAgICB9KTsKCiAgICBWaWV3LnJlZ2lzdGVyKCdyYWRpbycsIHsKICAgICAgICB0ZW1wbGF0ZTogcmVxdWlyZSgnaGJzIS4vdGVtcGxhdGVzL2Zvcm1maWVsZC9yYWRpbycpCiAgICB9KTsKCiAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdmb3JtZmllbGQnLCBmdW5jdGlvbih0eXBlLCBtb2RlbCwgZmllbGROYW1lKSB7CiAgICAgICAgLy8gdGVtcGxhdGUgaGVscGVyIGluIHRoZSBmb3JtIG9mOgogICAgICAgIC8vCiAgICAgICAgLy8gICAgICB7eyBmb3JtZmllbGQgJ3RleHQnIG1vZGVsICdmaWVsZG5hbWUnIFthdHRyTmFtZT0iYXR0clZhbHVlIl0qfX0KICAgICAgICB2YXIgRm9ybUZpZWxkID0gZmllbGRUZW1wbGF0ZXNbdHlwZV0sCiAgICAgICAgICAgIG9wdGlvbnMgPSBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aCAtIDFdLAogICAgICAgICAgICBvcHRzID0gb3B0aW9ucy5oYXNoIHx8IHt9OwoKICAgICAgICBpZiAoIUZvcm1GaWVsZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VucmVnaXN0ZXJlZCBmb3JtZmllbGQgdGVtcGxhdGU6ICcgKyB0eXBlKTsKICAgICAgICB9CgogICAgICAgIF8uZGVmYXVsdHMob3B0cywgewogICAgICAgICAgICBpZDogbW9kZWwuZmllbGRJZChmaWVsZE5hbWUpLAogICAgICAgICAgICBsYWJlbDogZmllbGROYW1lLAogICAgICAgICAgICBuYW1lOiBmaWVsZE5hbWUsCiAgICAgICAgICAgIG9wdGlvbnM6IFtdLAogICAgICAgICAgICBibGFuazogZmFsc2UsCiAgICAgICAgICAgIHZhbHVlOiBtb2RlbC5nZXQoZmllbGROYW1lKSB8fCAnJywKICAgICAgICAgICAgaGVscDogJycKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdmlld0hlbHBlci5jYWxsKHRoaXMsIEZvcm1GaWVsZCwgewogICAgICAgICAgICBmaWVsZDogZmllbGROYW1lLAogICAgICAgICAgICBtb2RlbDogbW9kZWwsCiAgICAgICAgICAgIGNvbnRleHQ6IG9wdHMKICAgICAgICB9LCBvcHRpb25zKTsKICAgIH0pOwoKICAgIHJldHVybiBWaWV3Owp9KTsKCi8qZ2xvYmFsIGRlZmluZSovCmRlZmluZSgnY2hpcm9wcmFjdG9yL3ZpZXdzJyxbJ3JlcXVpcmUnLCcuL3ZpZXdzL2Jhc2UnLCcuL3ZpZXdzL2Zvcm0nLCcuL3ZpZXdzL2ZpZWxkJywnLi92aWV3cy9yb3cnLCcuL3ZpZXdzL2Zvcm1maWVsZCddLGZ1bmN0aW9uKHJlcXVpcmUpIHsKICAgIAoKICAgIHZhciBCYXNlID0gcmVxdWlyZSgnLi92aWV3cy9iYXNlJyksCiAgICAgICAgRm9ybSA9IHJlcXVpcmUoJy4vdmlld3MvZm9ybScpLAogICAgICAgIEZpZWxkID0gcmVxdWlyZSgnLi92aWV3cy9maWVsZCcpLAogICAgICAgIFJvdyA9IHJlcXVpcmUoJy4vdmlld3Mvcm93JyksCiAgICAgICAgRm9ybUZpZWxkID0gcmVxdWlyZSgnLi92aWV3cy9mb3JtZmllbGQnKTsKCiAgICByZXR1cm4gewogICAgICAgIEJhc2U6IEJhc2UsCiAgICAgICAgRm9ybTogRm9ybSwKICAgICAgICBSb3c6IFJvdywKICAgICAgICBGaWVsZDogRmllbGQsCiAgICAgICAgRm9ybUZpZWxkOiBGb3JtRmllbGQKICAgIH07Cn0pOwoKLyoqCiAqIEBwcmVzZXJ2ZSBjb25zb2xlLXNoaW0gMS4wLjMKICogaHR0cHM6Ly9naXRodWIuY29tL2theWFoci9jb25zb2xlLXNoaW0KICogQ29weXJpZ2h0IChDKSAyMDExIEtsYXVzIFJlaW1lciA8a0BhaWxpcy5kZT4KICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqIChTZWUgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZSkKICovCiAKIAooZnVuY3Rpb24oKXsKCgovKioKICogUmV0dXJucyBhIGZ1bmN0aW9uIHdoaWNoIGNhbGxzIHRoZSBzcGVjaWZpZWQgZnVuY3Rpb24gaW4gdGhlIHNwZWNpZmllZAogKiBzY29wZS4KICoKICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYwogKiAgICAgICAgICAgIFRoZSBmdW5jdGlvbiB0byBjYWxsLgogKiBAcGFyYW0ge09iamVjdH0gc2NvcGUKICogICAgICAgICAgICBUaGUgc2NvcGUgdG8gY2FsbCB0aGUgZnVuY3Rpb24gaW4uCiAqIEBwYXJhbSB7Li4uKn0gYXJncwogKiAgICAgICAgICAgIEFkZGl0aW9uYWwgYXJndW1lbnRzIHRvIHBhc3MgdG8gdGhlIGJvdW5kIGZ1bmN0aW9uLgogKiBAcmV0dXJucyB7ZnVuY3Rpb24oLi4uWypdKTogdW5kZWZpbmVkfQogKiAgICAgICAgICAgIFRoZSBib3VuZCBmdW5jdGlvbi4KICovCnZhciBiaW5kID0gZnVuY3Rpb24oZnVuYywgc2NvcGUsIGFyZ3MpCnsKICAgIHZhciBmaXhlZEFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkKICAgIHsKICAgICAgICB2YXIgYXJncyA9IGZpeGVkQXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSk7CiAgICAgICAgKC8qKiBAdHlwZSB7RnVuY3Rpb259ICovIGZ1bmMpLmFwcGx5KHNjb3BlLCBhcmdzKTsKICAgIH07Cn07CgovLyBDcmVhdGUgY29uc29sZSBpZiBub3QgcHJlc2VudAppZiAoIXdpbmRvd1siY29uc29sZSJdKSB3aW5kb3cuY29uc29sZSA9IC8qKiBAdHlwZSB7Q29uc29sZX0gKi8gKHt9KTsKdmFyIGNvbnNvbGUgPSAoLyoqIEB0eXBlIHtPYmplY3R9ICovIHdpbmRvdy5jb25zb2xlKTsKCi8vIEltcGxlbWVudCBjb25zb2xlIGxvZyBpZiBuZWVkZWQKaWYgKCFjb25zb2xlWyJsb2ciXSkKewogICAgLy8gVXNlIGxvZzRqYXZhc2NyaXB0IGlmIHByZXNlbnQKICAgIGlmICh3aW5kb3dbImxvZzRqYXZhc2NyaXB0Il0pCiAgICB7CiAgICAgICAgdmFyIGxvZyA9IGxvZzRqYXZhc2NyaXB0LmdldERlZmF1bHRMb2dnZXIoKTsKICAgICAgICBjb25zb2xlLmxvZyA9IGJpbmQobG9nLmluZm8sIGxvZyk7CiAgICAgICAgY29uc29sZS5kZWJ1ZyA9IGJpbmQobG9nLmRlYnVnLCBsb2cpOwogICAgICAgIGNvbnNvbGUuaW5mbyA9IGJpbmQobG9nLmluZm8sIGxvZyk7CiAgICAgICAgY29uc29sZS53YXJuID0gYmluZChsb2cud2FybiwgbG9nKTsKICAgICAgICBjb25zb2xlLmVycm9yID0gYmluZChsb2cuZXJyb3IsIGxvZyk7CiAgICB9CiAgICAKICAgIC8vIFVzZSBlbXB0eSBkdW1teSBpbXBsZW1lbnRhdGlvbiB0byBpZ25vcmUgbG9nZ2luZwogICAgZWxzZQogICAgewogICAgICAgIGNvbnNvbGUubG9nID0gKC8qKiBAcGFyYW0gey4uLip9IGFyZ3MgKi8gZnVuY3Rpb24oYXJncykge30pOwogICAgfQp9CgovLyBJbXBsZW1lbnQgb3RoZXIgbG9nIGxldmVscyB0byBjb25zb2xlLmxvZyBpZiBtaXNzaW5nCmlmICghY29uc29sZVsiZGVidWciXSkgY29uc29sZS5kZWJ1ZyA9IGNvbnNvbGUubG9nOwppZiAoIWNvbnNvbGVbImluZm8iXSkgY29uc29sZS5pbmZvID0gY29uc29sZS5sb2c7CmlmICghY29uc29sZVsid2FybiJdKSBjb25zb2xlLndhcm4gPSBjb25zb2xlLmxvZzsKaWYgKCFjb25zb2xlWyJlcnJvciJdKSBjb25zb2xlLmVycm9yID0gY29uc29sZS5sb2c7CgovLyBXcmFwIHRoZSBsb2cgbWV0aG9kcyBpbiBJRSAoPD05KSBiZWNhdXNlIHRoZWlyIGFyZ3VtZW50IGhhbmRsaW5nIGlzIHdyb25nCi8vIFRoaXMgd3JhcHBpbmcgaXMgYWxzbyBkb25lIGlmIHRoZSBfX2NvbnNvbGVTaGltVGVzdF9fIHN5bWJvbCBpcyBzZXQuIFRoaXMKLy8gaXMgbmVlZGVkIGZvciB1bml0IHRlc3RpbmcuCmlmICh3aW5kb3dbIl9fY29uc29sZVNoaW1UZXN0X18iXSAhPSBudWxsIHx8IAogICAgZXZhbCgiLypAY2Nfb24gQF9qc2NyaXB0X3ZlcnNpb24gPD0gOUAqLyIpKQp7CiAgICAvKioKICAgICAqIFdyYXBzIHRoZSBjYWxsIHRvIGEgcmVhbCBJRSBsb2dnaW5nIG1ldGhvZC4gTW9kaWZpZXMgdGhlIGFyZ3VtZW50cyBzbwogICAgICogcGFyYW1ldGVycyB3aGljaCBhcmUgbm90IHJlcHJlc2VudGVkIGJ5IGEgcGxhY2Vob2xkZXIgYXJlIHByb3Blcmx5CiAgICAgKiBwcmludGVkIHdpdGggYSBzcGFjZSBjaGFyYWN0ZXIgYXMgc2VwYXJhdG9yLgogICAgICoKICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncwogICAgICogICAgICAgICAgICBUaGUgZnVuY3Rpb24gYXJndW1lbnRzLiBGaXJzdCBhcmd1bWVudCBpcyB0aGUgbG9nIGZ1bmN0aW9uCiAgICAgKiAgICAgICAgICAgIHRvIGNhbGwsIHRoZSBvdGhlciBhcmd1bWVudHMgYXJlIHRoZSBsb2cgYXJndW1lbnRzLgogICAgICovCiAgICB2YXIgd3JhcCA9IGZ1bmN0aW9uKGFyZ3MpCiAgICB7CiAgICAgICAgdmFyIGksIG1heCwgbWF0Y2gsIGxvZzsKICAgICAgICAKICAgICAgICAvLyBDb252ZXJ0IGFyZ3VtZW50IGxpc3QgdG8gcmVhbCBhcnJheQogICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgICAgIAogICAgICAgIC8vIEZpcnN0IGFyZ3VtZW50IGlzIHRoZSBsb2cgbWV0aG9kIHRvIGNhbGwKICAgICAgICBsb2cgPSBhcmdzLnNoaWZ0KCk7CiAgICAgICAgCiAgICAgICAgbWF4ID0gYXJncy5sZW5ndGg7CiAgICAgICAgaWYgKG1heCA+IDEgJiYgd2luZG93WyJfX2NvbnNvbGVTaGltVGVzdF9fIl0gIT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgLy8gV2hlbiBmaXJzdCBwYXJhbWV0ZXIgaXMgbm90IGEgc3RyaW5nIHRoZW4gYWRkIGEgZm9ybWF0IHN0cmluZyB0bwogICAgICAgICAgICAvLyB0aGUgYXJndW1lbnQgbGlzdCBzbyB3ZSBhcmUgYWJsZSB0byBtb2RpZnkgaXQgaW4gdGhlIG5leHQgc3RvcAogICAgICAgICAgICBpZiAodHlwZW9mKGFyZ3NbMF0pICE9ICJzdHJpbmciKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBhcmdzLnVuc2hpZnQoIiVvIik7CiAgICAgICAgICAgICAgICBtYXggKz0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRm9yIGVhY2ggYWRkaXRpb25hbCBwYXJhbWV0ZXIgd2hpY2ggaGFzIG5vIHBsYWNlaG9sZGVyIGluIHRoZQogICAgICAgICAgICAvLyBmb3JtYXQgc3RyaW5nIHdlIGFkZCBhbm90aGVyIHBsYWNlaG9sZGVyIHNlcGFyYXRlZCB3aXRoIGEKICAgICAgICAgICAgLy8gc3BhY2UgY2hhcmFjdGVyLgogICAgICAgICAgICBtYXRjaCA9IGFyZ3NbMF0ubWF0Y2goLyVbYS16XS9nKTsKICAgICAgICAgICAgZm9yIChpID0gbWF0Y2ggPyBtYXRjaC5sZW5ndGggKyAxIDogMTsgaSA8IG1heDsgaSArPSAxKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBhcmdzWzBdICs9ICIgJW8iOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIEZ1bmN0aW9uLmFwcGx5LmNhbGwobG9nLCBjb25zb2xlLCBhcmdzKTsKICAgIH07CiAgICAKICAgIC8vIFdyYXAgdGhlIG5hdGl2ZSBsb2cgbWV0aG9kcyBvZiBJRSB0byBmaXggYXJndW1lbnQgb3V0cHV0IHByb2JsZW1zCiAgICBjb25zb2xlLmxvZyA9IGJpbmQod3JhcCwgd2luZG93LCBjb25zb2xlLmxvZyk7CiAgICBjb25zb2xlLmRlYnVnID0gYmluZCh3cmFwLCB3aW5kb3csIGNvbnNvbGUuZGVidWcpOwogICAgY29uc29sZS5pbmZvID0gYmluZCh3cmFwLCB3aW5kb3csIGNvbnNvbGUuaW5mbyk7CiAgICBjb25zb2xlLndhcm4gPSBiaW5kKHdyYXAsIHdpbmRvdywgY29uc29sZS53YXJuKTsKICAgIGNvbnNvbGUuZXJyb3IgPSBiaW5kKHdyYXAsIHdpbmRvdywgY29uc29sZS5lcnJvcik7Cn0KCi8vIEltcGxlbWVudCBjb25zb2xlLmFzc2VydCBpZiBtaXNzaW5nCmlmICghY29uc29sZVsiYXNzZXJ0Il0pCnsKICAgIGNvbnNvbGVbImFzc2VydCJdID0gZnVuY3Rpb24oKQogICAgewogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICB2YXIgZXhwciA9IGFyZ3Muc2hpZnQoKTsKICAgICAgICBpZiAoIWV4cHIpCiAgICAgICAgewogICAgICAgICAgICBhcmdzWzBdID0gIkFzc2VydGlvbiBmYWlsZWQ6ICIgKyBhcmdzWzBdOwogICAgICAgICAgICBjb25zb2xlLmVycm9yLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgIH0KICAgIH07Cn0KCi8vIExpbmtpbmcgY29uc29sZS5kaXIgYW5kIGNvbnNvbGUuZGlyeG1sIHRvIHRoZSBjb25zb2xlLmxvZyBtZXRob2QgaWYKLy8gbWlzc2luZy4gSG9wZWZ1bGx5IHRoZSBicm93c2VyIGFscmVhZHkgbG9ncyBvYmplY3RzIGFuZCBET00gbm9kZXMgYXMgYQovLyB0cmVlLgppZiAoIWNvbnNvbGVbImRpciJdKSBjb25zb2xlWyJkaXIiXSA9IGNvbnNvbGUubG9nOwppZiAoIWNvbnNvbGVbImRpcnhtbCJdKSBjb25zb2xlWyJkaXJ4bWwiXSA9IGNvbnNvbGUubG9nOwoKLy8gTGlua2luZyBjb25zb2xlLmV4Y2VwdGlvbiB0byBjb25zb2xlLmVycm9yLiBUaGlzIGlzIG5vdCB0aGUgc2FtZSBidXQKLy8gYXQgbGVhc3Qgc29tZSBlcnJvciBtZXNzYWdlIGlzIGRpc3BsYXllZC4KaWYgKCFjb25zb2xlWyJleGNlcHRpb24iXSkgY29uc29sZVsiZXhjZXB0aW9uIl0gPSBjb25zb2xlLmVycm9yOwoKLy8gSW1wbGVtZW50IGNvbnNvbGUudGltZSBhbmQgY29uc29sZS50aW1lRW5kIGlmIG9uZSBvZiB0aGVtIGlzIG1pc3NpbmcKaWYgKCFjb25zb2xlWyJ0aW1lIl0gfHwgIWNvbnNvbGVbInRpbWVFbmQiXSkKewogICAgdmFyIHRpbWVycyA9IHt9OwogICAgY29uc29sZVsidGltZSJdID0gZnVuY3Rpb24oaWQpCiAgICB7CiAgICAgICAgdGltZXJzW2lkXSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgfTsKICAgIGNvbnNvbGVbInRpbWVFbmQiXSA9IGZ1bmN0aW9uKGlkKQogICAgewogICAgICAgIHZhciBzdGFydCA9IHRpbWVyc1tpZF07CiAgICAgICAgaWYgKHN0YXJ0KQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS5sb2coaWQgKyAiOiAiICsgKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gc3RhcnQpICsgIm1zIik7CiAgICAgICAgICAgIGRlbGV0ZSB0aW1lcnNbaWRdOwogICAgICAgIH0KICAgIH07Cn0KCi8vIEltcGxlbWVudCBjb25zb2xlLnRhYmxlIGlmIG1pc3NpbmcKaWYgKCFjb25zb2xlWyJ0YWJsZSJdKQp7CiAgICBjb25zb2xlWyJ0YWJsZSJdID0gZnVuY3Rpb24oZGF0YSwgY29sdW1ucykKICAgIHsKICAgICAgICB2YXIgaSwgaU1heCwgcm93LCBqLCBqTWF4LCBrOwogICAgICAgIAogICAgICAgIC8vIERvIG5vdGhpbmcgaWYgZGF0YSBoYXMgd3JvbmcgdHlwZSBvciBubyBkYXRhIHdhcyBzcGVjaWZpZWQKICAgICAgICBpZiAoIWRhdGEgfHwgIShkYXRhIGluc3RhbmNlb2YgQXJyYXkpIHx8ICFkYXRhLmxlbmd0aCkgcmV0dXJuOwogICAgICAgIAogICAgICAgIC8vIEF1dG8tY2FsY3VsYXRlIGNvbHVtbnMgYXJyYXkgaWYgbm90IHNldAogICAgICAgIGlmICghY29sdW1ucyB8fCAhKGNvbHVtbnMgaW5zdGFuY2VvZiBBcnJheSkpCiAgICAgICAgewogICAgICAgICAgICBjb2x1bW5zID0gW107CiAgICAgICAgICAgIGZvciAoayBpbiBkYXRhWzBdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWRhdGFbMF0uaGFzT3duUHJvcGVydHkoaykpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgY29sdW1ucy5wdXNoKGspOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZvciAoaSA9IDAsIGlNYXggPSBkYXRhLmxlbmd0aDsgaSA8IGlNYXg7IGkgKz0gMSkKICAgICAgICB7CiAgICAgICAgICAgIHJvdyA9IFtdOwogICAgICAgICAgICBmb3IgKGogPSAwLCBqTWF4ID0gY29sdW1ucy5sZW5ndGg7IGogPCBqTWF4OyBqICs9IDEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJvdy5wdXNoKGRhdGFbaV1bY29sdW1uc1tqXV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBGdW5jdGlvbi5hcHBseS5jYWxsKGNvbnNvbGUubG9nLCBjb25zb2xlLCByb3cpOwogICAgICAgIH0KICAgIH07Cn0KCi8vIER1bW15IGltcGxlbWVudGF0aW9ucyBvZiBvdGhlciBjb25zb2xlIGZlYXR1cmVzIHRvIHByZXZlbnQgZXJyb3IgbWVzc2FnZXMKLy8gaW4gYnJvd3NlcnMgbm90IHN1cHBvcnRpbmcgaXQuCmlmICghY29uc29sZVsiY2xlYXIiXSkgY29uc29sZVsiY2xlYXIiXSA9IGZ1bmN0aW9uKCkge307CmlmICghY29uc29sZVsidHJhY2UiXSkgY29uc29sZVsidHJhY2UiXSA9IGZ1bmN0aW9uKCkge307CmlmICghY29uc29sZVsiZ3JvdXAiXSkgY29uc29sZVsiZ3JvdXAiXSA9IGZ1bmN0aW9uKCkge307CmlmICghY29uc29sZVsiZ3JvdXBDb2xsYXBzZWQiXSkgY29uc29sZVsiZ3JvdXBDb2xsYXBzZWQiXSA9IGZ1bmN0aW9uKCkge307CmlmICghY29uc29sZVsiZ3JvdXBFbmQiXSkgY29uc29sZVsiZ3JvdXBFbmQiXSA9IGZ1bmN0aW9uKCkge307CmlmICghY29uc29sZVsidGltZVN0YW1wIl0pIGNvbnNvbGVbInRpbWVTdGFtcCJdID0gZnVuY3Rpb24oKSB7fTsKaWYgKCFjb25zb2xlWyJwcm9maWxlIl0pIGNvbnNvbGVbInByb2ZpbGUiXSA9IGZ1bmN0aW9uKCkge307CmlmICghY29uc29sZVsicHJvZmlsZUVuZCJdKSBjb25zb2xlWyJwcm9maWxlRW5kIl0gPSBmdW5jdGlvbigpIHt9OwppZiAoIWNvbnNvbGVbImNvdW50Il0pIGNvbnNvbGVbImNvdW50Il0gPSBmdW5jdGlvbigpIHt9OwoKfSkoKTsKCmRlZmluZSgiY29uc29sZS1zaGltIiwgKGZ1bmN0aW9uIChnbG9iYWwpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHJldCwgZm47CiAgICAgICAgcmV0dXJuIHJldCB8fCBnbG9iYWwuY29uc29sZTsKICAgIH07Cn0odGhpcykpKTsKCi8qKgogKiBlYXN5WERNCiAqIGh0dHA6Ly9lYXN5eGRtLm5ldC8KICogQ29weXJpZ2h0KGMpIDIwMDktMjAxMSwgw5h5dmluZCBTZWFuIEtpbnNleSwgb3l2aW5kQGtpbnNleS5uby4KICoKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAqCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKgogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqLwpkZWZpbmUoJ2pxdWVyeS5jb3JzL2Vhc3l4ZG0vZWFzeXhkbScsWydyZXF1aXJlJywnanNvbjInXSxmdW5jdGlvbihyZXF1aXJlKSB7CiAgICAKICAgIHZhciBKU09OID0gcmVxdWlyZSgnanNvbjInKTsKICAgIHZhciBnbG9iYWwgPSB0aGlzOwogICAgdmFyIGNoYW5uZWxJZCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwMDAwKTsgLy8gcmFuZG9taXplIHRoZSBpbml0aWFsIGlkIGluIGNhc2Ugb2YgbXVsdGlwbGUgY2xvc3VyZXMgbG9hZGVkCiAgICB2YXIgZW1wdHlGbiA9IEZ1bmN0aW9uLnByb3RvdHlwZTsKICAgIHZhciByZVVSSSA9IC9eKChodHRwLj86KVwvXC8oW146XC9cc10rKSg6XGQrKSopLzsgLy8gcmV0dXJucyBncm91cHMgZm9yIHByb3RvY29sICgyKSwgZG9tYWluICgzKSBhbmQgcG9ydCAoNCkKICAgIHZhciByZVBhcmVudCA9IC9bXC1cd10rXC9cLlwuXC8vOyAvLyBtYXRjaGVzIGEgZm9vLy4uLyBleHByZXNzaW9uCiAgICB2YXIgcmVEb3VibGVTbGFzaCA9IC8oW146XSlcL1wvL2c7IC8vIG1hdGNoZXMgLy8gYW55d2hlcmUgYnV0IGluIHRoZSBwcm90b2NvbAogICAgdmFyIG5hbWVzcGFjZSA9ICIiOyAvLyBzdG9yZXMgbmFtZXNwYWNlIHVuZGVyIHdoaWNoIGVhc3lYRE0gb2JqZWN0IGlzIHN0b3JlZCBvbiB0aGUgcGFnZSAoZW1wdHkgaWYgb2JqZWN0IGlzIGdsb2JhbCkKICAgIHZhciBlYXN5WERNID0ge307CiAgICB2YXIgX2Vhc3lYRE0gPSB3aW5kb3cuZWFzeVhETTsgLy8gbWFwIG92ZXIgZ2xvYmFsIGVhc3lYRE0gaW4gY2FzZSBvZiBvdmVyd3JpdGUKICAgIHZhciBJRlJBTUVfUFJFRklYID0gImVhc3lYRE1fIjsKICAgIHZhciBIQVNfTkFNRV9QUk9QRVJUWV9CVUc7CiAgICB2YXIgdXNlSGFzaCA9IGZhbHNlOyAvLyB3aGV0aGVyIHRvIHVzZSB0aGUgaGFzaCBvdmVyIHRoZSBxdWVyeQogICAgdmFyIGZsYXNoVmVyc2lvbjsgLy8gd2lsbCBiZSBzZXQgaWYgdXNpbmcgZmxhc2gKICAgIHZhciBIQVNfRkxBU0hfVEhST1RUTEVEX0JVRzsKCiAgICAvLyhmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCBsb2NhdGlvbiwgc2V0VGltZW91dCwgZGVjb2RlVVJJQ29tcG9uZW50LCBlbmNvZGVVUklDb21wb25lbnQpIHsKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIEpTT04sIFhNTEh0dHBSZXF1ZXN0LCB3aW5kb3csIGVzY2FwZSwgdW5lc2NhcGUsIEFjdGl2ZVhPYmplY3QgKi8KICAgICAgICAvLwogICAgICAgIC8vIGVhc3lYRE0KICAgICAgICAvLyBodHRwOi8vZWFzeXhkbS5uZXQvCiAgICAgICAgLy8gQ29weXJpZ2h0KGMpIDIwMDktMjAxMSwgw5h5dmluZCBTZWFuIEtpbnNleSwgb3l2aW5kQGtpbnNleS5uby4KICAgICAgICAvLwogICAgICAgIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICAgICAgICAvLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogICAgICAgIC8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICAgICAgICAvLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAgICAgICAgLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAgICAgICAgLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAgICAgICAvLwogICAgICAgIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAgICAgICAgLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgICAgICAgLy8KICAgICAgICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogICAgICAgIC8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogICAgICAgIC8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogICAgICAgIC8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICAgICAgICAvLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogICAgICAgIC8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICAgICAgICAvLyBUSEUgU09GVFdBUkUuCiAgICAgICAgLy8KCgoKCiAgICAgICAgLy8gaHR0cDovL3BldGVyLm1pY2hhdXguY2EvYXJ0aWNsZXMvZmVhdHVyZS1kZXRlY3Rpb24tc3RhdGUtb2YtdGhlLWFydC1icm93c2VyLXNjcmlwdGluZwogICAgICAgIGZ1bmN0aW9uIGlzSG9zdE1ldGhvZChvYmplY3QsIHByb3BlcnR5KSB7CiAgICAgICAgICAgIHZhciB0ID0gdHlwZW9mIG9iamVjdFtwcm9wZXJ0eV07CiAgICAgICAgICAgIHJldHVybiB0ID09ICdmdW5jdGlvbicgfHwKICAgICAgICAgICAgICAgICggISEgKHQgPT0gJ29iamVjdCcgJiYgb2JqZWN0W3Byb3BlcnR5XSkpIHx8CiAgICAgICAgICAgICAgICB0ID09ICd1bmtub3duJzsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzSG9zdE9iamVjdChvYmplY3QsIHByb3BlcnR5KSB7CiAgICAgICAgICAgIHJldHVybiAhISh0eXBlb2Yob2JqZWN0W3Byb3BlcnR5XSkgPT0gJ29iamVjdCcgJiYgb2JqZWN0W3Byb3BlcnR5XSk7CiAgICAgICAgfQoKICAgICAgICAvLyBlbmQKCiAgICAgICAgLy8gaHR0cDovL3BlcmZlY3Rpb25raWxscy5jb20vaW5zdGFuY2VvZi1jb25zaWRlcmVkLWhhcm1mdWwtb3ItaG93LXRvLXdyaXRlLWEtcm9idXN0LWlzYXJyYXkvCiAgICAgICAgZnVuY3Rpb24gaXNBcnJheShvKSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobykgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgICAgICAgfQoKICAgICAgICAvLyBlbmQKICAgICAgICBmdW5jdGlvbiBoYXNGbGFzaCgpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSAiU2hvY2t3YXZlIEZsYXNoIiwKICAgICAgICAgICAgICAgIG1pbWVUeXBlID0gImFwcGxpY2F0aW9uL3gtc2hvY2t3YXZlLWZsYXNoIjsKCiAgICAgICAgICAgIGlmICghdW5kZWYobmF2aWdhdG9yLnBsdWdpbnMpICYmIHR5cGVvZiBuYXZpZ2F0b3IucGx1Z2luc1tuYW1lXSA9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgLy8gYWRhcHRlZCBmcm9tIHRoZSBzd2ZvYmplY3QgY29kZQogICAgICAgICAgICAgICAgdmFyIGRlc2NyaXB0aW9uID0gbmF2aWdhdG9yLnBsdWdpbnNbbmFtZV0uZGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICBpZiAoZGVzY3JpcHRpb24gJiYgIXVuZGVmKG5hdmlnYXRvci5taW1lVHlwZXMpICYmIG5hdmlnYXRvci5taW1lVHlwZXNbbWltZVR5cGVdICYmIG5hdmlnYXRvci5taW1lVHlwZXNbbWltZVR5cGVdLmVuYWJsZWRQbHVnaW4pIHsKICAgICAgICAgICAgICAgICAgICBmbGFzaFZlcnNpb24gPSBkZXNjcmlwdGlvbi5tYXRjaCgvXGQrL2cpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghZmxhc2hWZXJzaW9uKSB7CiAgICAgICAgICAgICAgICB2YXIgZmxhc2g7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGZsYXNoID0gbmV3IEFjdGl2ZVhPYmplY3QoIlNob2Nrd2F2ZUZsYXNoLlNob2Nrd2F2ZUZsYXNoIik7CiAgICAgICAgICAgICAgICAgICAgZmxhc2hWZXJzaW9uID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZmxhc2guR2V0VmFyaWFibGUoIiR2ZXJzaW9uIikubWF0Y2goLyhcZCspLChcZCspLChcZCspLChcZCspLyksIDEpOwogICAgICAgICAgICAgICAgICAgIGZsYXNoID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKG5vdFN1cHBvcnRlZEV4Y2VwdGlvbikge30KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWZsYXNoVmVyc2lvbikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtYWpvciA9IHBhcnNlSW50KGZsYXNoVmVyc2lvblswXSwgMTApLAogICAgICAgICAgICAgICAgbWlub3IgPSBwYXJzZUludChmbGFzaFZlcnNpb25bMV0sIDEwKTsKICAgICAgICAgICAgSEFTX0ZMQVNIX1RIUk9UVExFRF9CVUcgPSBtYWpvciA+IDkgJiYgbWlub3IgPiAwOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICogQ3Jvc3MgQnJvd3NlciBpbXBsZW1lbnRhdGlvbiBmb3IgYWRkaW5nIGFuZCByZW1vdmluZyBldmVudCBsaXN0ZW5lcnMuCiAgICAgICAgICovCiAgICAgICAgdmFyIG9uLCB1bjsKICAgICAgICBpZiAoaXNIb3N0TWV0aG9kKHdpbmRvdywgImFkZEV2ZW50TGlzdGVuZXIiKSkgewogICAgICAgICAgICBvbiA9IGZ1bmN0aW9uKHRhcmdldCwgdHlwZSwgbGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyLCBmYWxzZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVuID0gZnVuY3Rpb24odGFyZ2V0LCB0eXBlLCBsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIsIGZhbHNlKTsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKGlzSG9zdE1ldGhvZCh3aW5kb3csICJhdHRhY2hFdmVudCIpKSB7CiAgICAgICAgICAgIG9uID0gZnVuY3Rpb24ob2JqZWN0LCBzRXZlbnQsIGZwTm90aWZ5KSB7CiAgICAgICAgICAgICAgICBvYmplY3QuYXR0YWNoRXZlbnQoIm9uIiArIHNFdmVudCwgZnBOb3RpZnkpOwogICAgICAgICAgICB9OwogICAgICAgICAgICB1biA9IGZ1bmN0aW9uKG9iamVjdCwgc0V2ZW50LCBmcE5vdGlmeSkgewogICAgICAgICAgICAgICAgb2JqZWN0LmRldGFjaEV2ZW50KCJvbiIgKyBzRXZlbnQsIGZwTm90aWZ5KTsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJyb3dzZXIgbm90IHN1cHBvcnRlZCIpOwogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiBDcm9zcyBCcm93c2VyIGltcGxlbWVudGF0aW9uIG9mIERPTUNvbnRlbnRMb2FkZWQuCiAgICAgICAgICovCiAgICAgICAgdmFyIGRvbUlzUmVhZHkgPSBmYWxzZSwKICAgICAgICAgICAgZG9tUmVhZHlRdWV1ZSA9IFtdLAogICAgICAgICAgICByZWFkeVN0YXRlOwogICAgICAgIGlmICgicmVhZHlTdGF0ZSIgaW4gZG9jdW1lbnQpIHsKICAgICAgICAgICAgLy8gSWYgYnJvd3NlciBpcyBXZWJLaXQtcG93ZXJlZCwgY2hlY2sgZm9yIGJvdGggJ2xvYWRlZCcgKGxlZ2FjeSBicm93c2VycykgYW5kCiAgICAgICAgICAgIC8vICdpbnRlcmFjdGl2ZScgKEhUTUw1IHNwZWNzLCByZWNlbnQgV2ViS2l0IGJ1aWxkcykgc3RhdGVzLgogICAgICAgICAgICAvLyBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NDUxMTkKICAgICAgICAgICAgcmVhZHlTdGF0ZSA9IGRvY3VtZW50LnJlYWR5U3RhdGU7CiAgICAgICAgICAgIGRvbUlzUmVhZHkgPSByZWFkeVN0YXRlID09ICJjb21wbGV0ZSIgfHwgKH5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoJ0FwcGxlV2ViS2l0LycpICYmIChyZWFkeVN0YXRlID09ICJsb2FkZWQiIHx8IHJlYWR5U3RhdGUgPT0gImludGVyYWN0aXZlIikpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIElmIHJlYWR5U3RhdGUgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgYnJvd3NlciwgdGhlbiBpbiBvcmRlciB0byBiZSBhYmxlIHRvIGZpcmUgd2hlblJlYWR5IGZ1bmN0aW9ucyBhcHJvcHJpYXRlbHkKICAgICAgICAgICAgLy8gd2hlbiBhZGRlZCBkeW5hbWljYWxseSBfYWZ0ZXJfIERPTSBsb2FkLCB3ZSBoYXZlIHRvIGRlZHVjZSB3ZXRoZXIgdGhlIERPTSBpcyByZWFkeSBvciBub3QuCiAgICAgICAgICAgIC8vIFdlIG9ubHkgbmVlZCBhIGJvZHkgdG8gYWRkIGVsZW1lbnRzIHRvLCBzbyB0aGUgZXhpc3RlbmNlIG9mIGRvY3VtZW50LmJvZHkgaXMgZW5vdWdoIGZvciB1cy4KICAgICAgICAgICAgZG9tSXNSZWFkeSA9ICEhIGRvY3VtZW50LmJvZHk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkb21fb25SZWFkeSgpIHsKICAgICAgICAgICAgaWYgKGRvbUlzUmVhZHkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkb21Jc1JlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkb21SZWFkeVF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBkb21SZWFkeVF1ZXVlW2ldKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9tUmVhZHlRdWV1ZS5sZW5ndGggPSAwOwogICAgICAgIH0KCgogICAgICAgIGlmICghZG9tSXNSZWFkeSkgewogICAgICAgICAgICBpZiAoaXNIb3N0TWV0aG9kKHdpbmRvdywgImFkZEV2ZW50TGlzdGVuZXIiKSkgewogICAgICAgICAgICAgICAgb24oZG9jdW1lbnQsICJET01Db250ZW50TG9hZGVkIiwgZG9tX29uUmVhZHkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgb24oZG9jdW1lbnQsICJyZWFkeXN0YXRlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT0gImNvbXBsZXRlIikgewogICAgICAgICAgICAgICAgICAgICAgICBkb21fb25SZWFkeSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCAmJiB3aW5kb3cgPT09IHRvcCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkb1Njcm9sbENoZWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb21Jc1JlYWR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCgibGVmdCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGRvU2Nyb2xsQ2hlY2ssIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRvbV9vblJlYWR5KCk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBkb1Njcm9sbENoZWNrKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCiAgICAgICAgICAgIG9uKHdpbmRvdywgImxvYWQiLCBkb21fb25SZWFkeSk7CiAgICAgICAgfQogICAgICAgIC8qKgogICAgICAgICAqIFRoaXMgd2lsbCBhZGQgYSBmdW5jdGlvbiB0byB0aGUgcXVldWUgb2YgZnVuY3Rpb25zIHRvIGJlIHJ1biBvbmNlIHRoZSBET00gcmVhY2hlcyBhIHJlYWR5IHN0YXRlLgogICAgICAgICAqIElmIGZ1bmN0aW9ucyBhcmUgYWRkZWQgYWZ0ZXIgdGhpcyBldmVudCB0aGVuIHRoZXkgd2lsbCBiZSBleGVjdXRlZCBpbW1lZGlhdGVseS4KICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gYWRkCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIEFuIG9wdGlvbmFsIHNjb3BlIGZvciB0aGUgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdpdGguCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gd2hlblJlYWR5KGZuLCBzY29wZSkgewogICAgICAgICAgICBpZiAoZG9tSXNSZWFkeSkgewogICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9tUmVhZHlRdWV1ZS5wdXNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBhbiBpbnN0YW5jZSBvZiBlYXN5WERNIGZyb20gdGhlIHBhcmVudCB3aW5kb3cgd2l0aAogICAgICAgICAqIHJlc3BlY3QgdG8gdGhlIG5hbWVzcGFjZS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4gQW4gaW5zdGFuY2Ugb2YgZWFzeVhETSAoaW4gdGhlIHBhcmVudCB3aW5kb3cpCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50T2JqZWN0KCkgewogICAgICAgICAgICB2YXIgb2JqID0gcGFyZW50OwogICAgICAgICAgICBpZiAobmFtZXNwYWNlICE9PSAiIikgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gbmFtZXNwYWNlLnNwbGl0KCIuIik7IGkgPCBpaS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIG9iaiA9IG9ialtpaVtpXV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG9iai5lYXN5WERNOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogUmVtb3ZlcyBlYXN5WERNIHZhcmlhYmxlIGZyb20gdGhlIGdsb2JhbCBzY29wZS4gSXQgYWxzbyByZXR1cm5zIGNvbnRyb2wKICAgICAgICAgKiBvZiB0aGUgZWFzeVhETSB2YXJpYWJsZSB0byB3aGF0ZXZlciBjb2RlIHVzZWQgaXQgYmVmb3JlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG5zIEEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIGFuIG9iamVjdCB0aGF0IHdpbGwgaG9sZAogICAgICAgICAqICAgICAgICAgICAgICAgICAgICBhbiBpbnN0YW5jZSBvZiBlYXN5WERNLgogICAgICAgICAqIEByZXR1cm4gQW4gaW5zdGFuY2Ugb2YgZWFzeVhETQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIG5vQ29uZmxpY3QobnMpIHsKCiAgICAgICAgICAgIHdpbmRvdy5lYXN5WERNID0gX2Vhc3lYRE07CiAgICAgICAgICAgIG5hbWVzcGFjZSA9IG5zOwogICAgICAgICAgICBpZiAobmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICBJRlJBTUVfUFJFRklYID0gImVhc3lYRE1fIiArIG5hbWVzcGFjZS5yZXBsYWNlKCIuIiwgIl8iKSArICJfIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWFzeVhETTsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICogTWV0aG9kcyBmb3Igd29ya2luZyB3aXRoIFVSTHMKICAgICAgICAgKi8KICAgICAgICAvKioKICAgICAgICAgKiBHZXQgdGhlIGRvbWFpbiBuYW1lIGZyb20gYSB1cmwuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGV4dHJhY3QgdGhlIGRvbWFpbiBmcm9tLgogICAgICAgICAqIEByZXR1cm4gVGhlIGRvbWFpbiBwYXJ0IG9mIHRoZSB1cmwuCiAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBnZXREb21haW5OYW1lKHVybCkgewogICAgICAgICAgICByZXR1cm4gdXJsLm1hdGNoKHJlVVJJKVszXTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEdldCB0aGUgcG9ydCBmb3IgYSBnaXZlbiBVUkwsIG9yICIiIGlmIG5vbmUKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gZXh0cmFjdCB0aGUgcG9ydCBmcm9tLgogICAgICAgICAqIEByZXR1cm4gVGhlIHBvcnQgcGFydCBvZiB0aGUgdXJsLgogICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZ2V0UG9ydCh1cmwpIHsKICAgICAgICAgICAgcmV0dXJuIHVybC5tYXRjaChyZVVSSSlbNF0gfHwgIiI7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zICBhIHN0cmluZyBjb250YWluaW5nIHRoZSBzY2hlbWEsIGRvbWFpbiBhbmQgaWYgcHJlc2VudCB0aGUgcG9ydAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBleHRyYWN0IHRoZSBsb2NhdGlvbiBmcm9tCiAgICAgICAgICogQHJldHVybiB7U3RyaW5nfSBUaGUgbG9jYXRpb24gcGFydCBvZiB0aGUgdXJsCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZ2V0TG9jYXRpb24odXJsKSB7CiAgICAgICAgICAgIHZhciBtID0gdXJsLnRvTG93ZXJDYXNlKCkubWF0Y2gocmVVUkkpOwogICAgICAgICAgICB2YXIgcHJvdG8gPSBtWzJdLAogICAgICAgICAgICAgICAgZG9tYWluID0gbVszXSwKICAgICAgICAgICAgICAgIHBvcnQgPSBtWzRdIHx8ICIiOwogICAgICAgICAgICBpZiAoKHByb3RvID09ICJodHRwOiIgJiYgcG9ydCA9PSAiOjgwIikgfHwgKHByb3RvID09ICJodHRwczoiICYmIHBvcnQgPT0gIjo0NDMiKSkgewogICAgICAgICAgICAgICAgcG9ydCA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcm90byArICIvLyIgKyBkb21haW4gKyBwb3J0OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogUmVzb2x2ZXMgYSByZWxhdGl2ZSB1cmwgaW50byBhbiBhYnNvbHV0ZSBvbmUuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgcGF0aCB0byByZXNvbHZlLgogICAgICAgICAqIEByZXR1cm4ge1N0cmluZ30gVGhlIHJlc29sdmVkIHVybC4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiByZXNvbHZlVXJsKHVybCkgewoKICAgICAgICAgICAgLy8gcmVwbGFjZSBhbGwgLy8gZXhjZXB0IHRoZSBvbmUgaW4gcHJvdG8gd2l0aCAvCiAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKHJlRG91YmxlU2xhc2gsICIkMS8iKTsKCiAgICAgICAgICAgIC8vIElmIHRoZSB1cmwgaXMgYSB2YWxpZCB1cmwgd2UgZG8gbm90aGluZwogICAgICAgICAgICBpZiAoIXVybC5tYXRjaCgvXihodHRwfHxodHRwcyk6XC9cLy8pKSB7CiAgICAgICAgICAgICAgICAvLyBJZiB0aGlzIGlzIGEgcmVsYXRpdmUgcGF0aAogICAgICAgICAgICAgICAgdmFyIHBhdGggPSAodXJsLnN1YnN0cmluZygwLCAxKSA9PT0gIi8iKSA/ICIiIDogbG9jYXRpb24ucGF0aG5hbWU7CiAgICAgICAgICAgICAgICBpZiAocGF0aC5zdWJzdHJpbmcocGF0aC5sZW5ndGggLSAxKSAhPT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgcGF0aCA9IHBhdGguc3Vic3RyaW5nKDAsIHBhdGgubGFzdEluZGV4T2YoIi8iKSArIDEpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHVybCA9IGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArIGxvY2F0aW9uLmhvc3QgKyBwYXRoICsgdXJsOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyByZWR1Y2UgYWxsICd4eXovLi4vJyB0byBqdXN0ICcnCiAgICAgICAgICAgIHdoaWxlIChyZVBhcmVudC50ZXN0KHVybCkpIHsKICAgICAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKHJlUGFyZW50LCAiIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBBcHBlbmRzIHRoZSBwYXJhbWV0ZXJzIHRvIHRoZSBnaXZlbiB1cmwuPGJyLz4KICAgICAgICAgKiBUaGUgYmFzZSB1cmwgY2FuIGNvbnRhaW4gZXhpc3RpbmcgcXVlcnkgcGFyYW1ldGVycy4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSBiYXNlIHVybC4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1ldGVycyBUaGUgcGFyYW1ldGVycyB0byBhZGQuCiAgICAgICAgICogQHJldHVybiB7U3RyaW5nfSBBIG5ldyB2YWxpZCB1cmwgd2l0aCB0aGUgcGFyYW1ldGVycyBhcHBlbmRlZC4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBhcHBlbmRRdWVyeVBhcmFtZXRlcnModXJsLCBwYXJhbWV0ZXJzKSB7CgogICAgICAgICAgICB2YXIgaGFzaCA9ICIiLAogICAgICAgICAgICAgICAgaW5kZXhPZiA9IHVybC5pbmRleE9mKCIjIik7CiAgICAgICAgICAgIGlmIChpbmRleE9mICE9PSAtMSkgewogICAgICAgICAgICAgICAgaGFzaCA9IHVybC5zdWJzdHJpbmcoaW5kZXhPZik7CiAgICAgICAgICAgICAgICB1cmwgPSB1cmwuc3Vic3RyaW5nKDAsIGluZGV4T2YpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBxID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwYXJhbWV0ZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAocGFyYW1ldGVycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgcS5wdXNoKGtleSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudChwYXJhbWV0ZXJzW2tleV0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdXJsICsgKHVzZUhhc2ggPyAiIyIgOiAodXJsLmluZGV4T2YoIj8iKSA9PSAtMSA/ICI/IiA6ICImIikpICsgcS5qb2luKCImIikgKyBoYXNoOwogICAgICAgIH0KCgogICAgICAgIC8vIGJ1aWxkIHRoZSBxdWVyeSBvYmplY3QgZWl0aGVyIGZyb20gbG9jYXRpb24ucXVlcnksIGlmIGl0IGNvbnRhaW5zIHRoZSB4ZG1fZSBhcmd1bWVudCwgb3IgZnJvbSBsb2NhdGlvbi5oYXNoCiAgICAgICAgdmFyIHF1ZXJ5ID0gKGZ1bmN0aW9uKGlucHV0KSB7CiAgICAgICAgICAgIGlucHV0ID0gaW5wdXQuc3Vic3RyaW5nKDEpLnNwbGl0KCImIik7CiAgICAgICAgICAgIHZhciBkYXRhID0ge30sIHBhaXIsIGkgPSBpbnB1dC5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIHBhaXIgPSBpbnB1dFtpXS5zcGxpdCgiPSIpOwogICAgICAgICAgICAgICAgZGF0YVtwYWlyWzBdXSA9IGRlY29kZVVSSUNvbXBvbmVudChwYWlyWzFdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICB9KC94ZG1fZT0vLnRlc3QobG9jYXRpb24uc2VhcmNoKSA/IGxvY2F0aW9uLnNlYXJjaCA6IGxvY2F0aW9uLmhhc2gpKTsKCiAgICAgICAgLyoKICAgICAgICAgKiBIZWxwZXIgbWV0aG9kcwogICAgICAgICAqLwogICAgICAgIC8qKgogICAgICAgICAqIEhlbHBlciBmb3IgY2hlY2tpbmcgaWYgYSB2YXJpYWJsZS9wcm9wZXJ0eSBpcyB1bmRlZmluZWQKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdiBUaGUgdmFyaWFibGUgdG8gdGVzdAogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IFRydWUgaWYgdGhlIHBhc3NlZCB2YXJpYWJsZSBpcyB1bmRlZmluZWQKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiB1bmRlZih2KSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdiA9PT0gInVuZGVmaW5lZCI7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBBIHNhZmUgaW1wbGVtZW50YXRpb24gb2YgSFRNTDUgSlNPTi4gRmVhdHVyZSB0ZXN0aW5nIGlzIHVzZWQgdG8gbWFrZSBzdXJlIHRoZSBpbXBsZW1lbnRhdGlvbiB3b3Jrcy4KICAgICAgICAgKiBAcmV0dXJuIHtKU09OfSBBIHZhbGlkIEpTT04gY29uZm9ybWluZyBvYmplY3QsIG9yIG51bGwgaWYgbm90IGZvdW5kLgogICAgICAgICAqLwogICAgICAgIHZhciBnZXRKU09OID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjYWNoZWQgPSB7fTsKICAgICAgICAgICAgdmFyIG9iaiA9IHsKICAgICAgICAgICAgICAgIGE6IFsxLCAyLCAzXQogICAgICAgICAgICB9LCBqc29uID0gIntcImFcIjpbMSwyLDNdfSI7CgogICAgICAgICAgICBpZiAodHlwZW9mIEpTT04gIT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIEpTT04uc3RyaW5naWZ5ID09PSAiZnVuY3Rpb24iICYmIEpTT04uc3RyaW5naWZ5KG9iaikucmVwbGFjZSgoL1xzL2cpLCAiIikgPT09IGpzb24pIHsKICAgICAgICAgICAgICAgIC8vIHRoaXMgaXMgYSB3b3JraW5nIEpTT04gaW5zdGFuY2UKICAgICAgICAgICAgICAgIHJldHVybiBKU09OOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChPYmplY3QudG9KU09OKSB7CiAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LnRvSlNPTihvYmopLnJlcGxhY2UoKC9ccy9nKSwgIiIpID09PSBqc29uKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBhIHdvcmtpbmcgc3RyaW5naWZ5IG1ldGhvZAogICAgICAgICAgICAgICAgICAgIGNhY2hlZC5zdHJpbmdpZnkgPSBPYmplY3QudG9KU09OOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mIFN0cmluZy5wcm90b3R5cGUuZXZhbEpTT04gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIG9iaiA9IGpzb24uZXZhbEpTT04oKTsKICAgICAgICAgICAgICAgIGlmIChvYmouYSAmJiBvYmouYS5sZW5ndGggPT09IDMgJiYgb2JqLmFbMl0gPT09IDMpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIGEgd29ya2luZyBwYXJzZSBtZXRob2QKICAgICAgICAgICAgICAgICAgICBjYWNoZWQucGFyc2UgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0ci5ldmFsSlNPTigpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjYWNoZWQuc3RyaW5naWZ5ICYmIGNhY2hlZC5wYXJzZSkgewogICAgICAgICAgICAgICAgLy8gT25seSBtZW1vaXplIHRoZSByZXN1bHQgaWYgd2UgaGF2ZSB2YWxpZCBpbnN0YW5jZQogICAgICAgICAgICAgICAgZ2V0SlNPTiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWQ7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBBcHBsaWVzIHByb3BlcnRpZXMgZnJvbSB0aGUgc291cmNlIG9iamVjdCB0byB0aGUgdGFyZ2V0IG9iamVjdC48YnIvPgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQgVGhlIHRhcmdldCBvZiB0aGUgcHJvcGVydGllcy4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc291cmNlIFRoZSBzb3VyY2Ugb2YgdGhlIHByb3BlcnRpZXMuCiAgICAgICAgICogQHBhcmFtIHtCb29sZWFufSBub092ZXJ3cml0ZSBTZXQgdG8gVHJ1ZSB0byBvbmx5IHNldCBub24tZXhpc3RpbmcgcHJvcGVydGllcy4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBhcHBseShkZXN0aW5hdGlvbiwgc291cmNlLCBub092ZXJ3cml0ZSkgewogICAgICAgICAgICB2YXIgbWVtYmVyOwogICAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgICAgICAgICAgaWYgKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChwcm9wIGluIGRlc3RpbmF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lbWJlciA9IHNvdXJjZVtwcm9wXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtZW1iZXIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBseShkZXN0aW5hdGlvbltwcm9wXSwgbWVtYmVyLCBub092ZXJ3cml0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIW5vT3ZlcndyaXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbltwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGVzdGluYXRpb247CiAgICAgICAgfQoKICAgICAgICAvLyBUaGlzIHRlc3RzIGZvciB0aGUgYnVnIGluIElFIHdoZXJlIHNldHRpbmcgdGhlIFtuYW1lXSBwcm9wZXJ0eSB1c2luZyBqYXZhc2NyaXB0IGNhdXNlcyB0aGUgdmFsdWUgdG8gYmUgcmVkaXJlY3RlZCBpbnRvIFtzdWJtaXROYW1lXS4KICAgICAgICBmdW5jdGlvbiB0ZXN0Rm9yTmFtZVByb3BlcnR5QnVnKCkgewogICAgICAgICAgICB2YXIgZm9ybSA9IGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZm9ybSIpKSwKICAgICAgICAgICAgICAgIGlucHV0ID0gZm9ybS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpKTsKICAgICAgICAgICAgaW5wdXQubmFtZSA9IElGUkFNRV9QUkVGSVggKyAiVEVTVCIgKyBjaGFubmVsSWQ7IC8vIGFwcGVuZCBjaGFubmVsSWQgaW4gb3JkZXIgdG8gYXZvaWQgY2FjaGluZyBpc3N1ZXMKICAgICAgICAgICAgSEFTX05BTUVfUFJPUEVSVFlfQlVHID0gaW5wdXQgIT09IGZvcm0uZWxlbWVudHNbaW5wdXQubmFtZV07CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZm9ybSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBDcmVhdGVzIGEgZnJhbWUgYW5kIGFwcGVuZHMgaXQgdG8gdGhlIERPTS4KICAgICAgICAgKiBAcGFyYW0gY29uZmlnIHtvYmplY3R9IFRoaXMgb2JqZWN0IGNhbiBoYXZlIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllcwogICAgICAgICAqIDx1bD4KICAgICAgICAgKiA8bGk+IHtvYmplY3R9IHByb3AgVGhlIHByb3BlcnRpZXMgdGhhdCBzaG91bGQgYmUgc2V0IG9uIHRoZSBmcmFtZS4gVGhpcyBzaG91bGQgaW5jbHVkZSB0aGUgJ3NyYycgcHJvcGVydHkuPC9saT4KICAgICAgICAgKiA8bGk+IHtvYmplY3R9IGF0dHIgVGhlIGF0dHJpYnV0ZXMgdGhhdCBzaG91bGQgYmUgc2V0IG9uIHRoZSBmcmFtZS48L2xpPgogICAgICAgICAqIDxsaT4ge0RPTUVsZW1lbnR9IGNvbnRhaW5lciBJdHMgcGFyZW50IGVsZW1lbnQgKE9wdGlvbmFsKS48L2xpPgogICAgICAgICAqIDxsaT4ge2Z1bmN0aW9ufSBvbkxvYWQgQSBtZXRob2QgdGhhdCBzaG91bGQgYmUgY2FsbGVkIHdpdGggdGhlIGZyYW1lcyBjb250ZW50V2luZG93IGFzIGFyZ3VtZW50IHdoZW4gdGhlIGZyYW1lIGlzIGZ1bGx5IGxvYWRlZC4gKE9wdGlvbmFsKTwvbGk+CiAgICAgICAgICogPC91bD4KICAgICAgICAgKiBAcmV0dXJuIFRoZSBmcmFtZXMgRE9NRWxlbWVudAogICAgICAgICAqIEB0eXBlIERPTUVsZW1lbnQKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGcmFtZShjb25maWcpIHsKICAgICAgICAgICAgaWYgKHVuZGVmKEhBU19OQU1FX1BST1BFUlRZX0JVRykpIHsKICAgICAgICAgICAgICAgIHRlc3RGb3JOYW1lUHJvcGVydHlCdWcoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZnJhbWU7CiAgICAgICAgICAgIC8vIFRoaXMgaXMgdG8gd29yayBhcm91bmQgdGhlIHByb2JsZW1zIGluIElFNi83IHdpdGggc2V0dGluZyB0aGUgbmFtZSBwcm9wZXJ0eS4KICAgICAgICAgICAgLy8gSW50ZXJuYWxseSB0aGlzIGlzIHNldCBhcyAnc3VibWl0TmFtZScgaW5zdGVhZCB3aGVuIHVzaW5nICdpZnJhbWUubmFtZSA9IC4uLicKICAgICAgICAgICAgLy8gVGhpcyBpcyBub3QgcmVxdWlyZWQgYnkgZWFzeVhETSBpdHNlbGYsIGJ1dCBpcyB0byBmYWNpbGl0YXRlIG90aGVyIHVzZSBjYXNlcwogICAgICAgICAgICBpZiAoSEFTX05BTUVfUFJPUEVSVFlfQlVHKSB7CiAgICAgICAgICAgICAgICBmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIjxpZnJhbWUgbmFtZT1cIiIgKyBjb25maWcucHJvcHMubmFtZSArICJcIi8+Iik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIklGUkFNRSIpOwogICAgICAgICAgICAgICAgZnJhbWUubmFtZSA9IGNvbmZpZy5wcm9wcy5uYW1lOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmcmFtZS5pZCA9IGZyYW1lLm5hbWUgPSBjb25maWcucHJvcHMubmFtZTsKICAgICAgICAgICAgZGVsZXRlIGNvbmZpZy5wcm9wcy5uYW1lOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBjb25maWcuY29udGFpbmVyID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBjb25maWcuY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29uZmlnLmNvbnRhaW5lcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghY29uZmlnLmNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgLy8gVGhpcyBuZWVkcyB0byBiZSBoaWRkZW4gbGlrZSB0aGlzLCBzaW1wbHkgc2V0dGluZyBkaXNwbGF5Om5vbmUgYW5kIHRoZSBsaWtlIHdpbGwgY2F1c2UgZmFpbHVyZXMgaW4gc29tZSBicm93c2Vycy4KICAgICAgICAgICAgICAgIGFwcGx5KGZyYW1lLnN0eWxlLCB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgICAgICAgICAgICAgICAgdG9wOiAiLTIwMDBweCIsCiAgICAgICAgICAgICAgICAgICAgLy8gQXZvaWQgcG90ZW50aWFsIGhvcml6b250YWwgc2Nyb2xsYmFyCiAgICAgICAgICAgICAgICAgICAgbGVmdDogIjBweCIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgY29uZmlnLmNvbnRhaW5lciA9IGRvY3VtZW50LmJvZHk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhBQ0s6IElFIGNhbm5vdCBoYXZlIHRoZSBzcmMgYXR0cmlidXRlIHNldCB3aGVuIHRoZSBmcmFtZSBpcyBhcHBlbmRlZAogICAgICAgICAgICAvLyAgICAgICBpbnRvIHRoZSBjb250YWluZXIsIHNvIHdlIHNldCBpdCB0byAiamF2YXNjcmlwdDpmYWxzZSIgYXMgYQogICAgICAgICAgICAvLyAgICAgICBwbGFjZWhvbGRlciBmb3Igbm93LiAgSWYgd2UgbGVmdCB0aGUgc3JjIHVuZGVmaW5lZCwgaXQgd291bGQKICAgICAgICAgICAgLy8gICAgICAgaW5zdGVhZCBkZWZhdWx0IHRvICJhYm91dDpibGFuayIsIHdoaWNoIGNhdXNlcyBTU0wgbWl4ZWQtY29udGVudAogICAgICAgICAgICAvLyAgICAgICB3YXJuaW5ncyBpbiBJRTYgd2hlbiBvbiBhbiBTU0wgcGFyZW50IHBhZ2UuCiAgICAgICAgICAgIHZhciBzcmMgPSBjb25maWcucHJvcHMuc3JjOwogICAgICAgICAgICBjb25maWcucHJvcHMuc3JjID0gImphdmFzY3JpcHQ6ZmFsc2UiOwoKICAgICAgICAgICAgLy8gdHJhbnNmZXIgcHJvcGVydGllcyB0byB0aGUgZnJhbWUKICAgICAgICAgICAgYXBwbHkoZnJhbWUsIGNvbmZpZy5wcm9wcyk7CgogICAgICAgICAgICBmcmFtZS5ib3JkZXIgPSBmcmFtZS5mcmFtZUJvcmRlciA9IDA7CiAgICAgICAgICAgIGZyYW1lLmFsbG93VHJhbnNwYXJlbmN5ID0gdHJ1ZTsKICAgICAgICAgICAgY29uZmlnLmNvbnRhaW5lci5hcHBlbmRDaGlsZChmcmFtZSk7CgogICAgICAgICAgICBpZiAoY29uZmlnLm9uTG9hZCkgewogICAgICAgICAgICAgICAgb24oZnJhbWUsICJsb2FkIiwgY29uZmlnLm9uTG9hZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNldCB0aGUgZnJhbWUgVVJMIHRvIHRoZSBwcm9wZXIgdmFsdWUgKHdlIHByZXZpb3VzbHkgc2V0IGl0IHRvCiAgICAgICAgICAgIC8vICJqYXZhc2NyaXB0OmZhbHNlIiB0byB3b3JrIGFyb3VuZCB0aGUgSUUgaXNzdWUgbWVudGlvbmVkIGFib3ZlKQogICAgICAgICAgICBpZiAoY29uZmlnLnVzZVBvc3QpIHsKICAgICAgICAgICAgICAgIHZhciBmb3JtID0gY29uZmlnLmNvbnRhaW5lci5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdmb3JtJykpLAogICAgICAgICAgICAgICAgICAgIGlucHV0OwogICAgICAgICAgICAgICAgZm9ybS50YXJnZXQgPSBmcmFtZS5uYW1lOwogICAgICAgICAgICAgICAgZm9ybS5hY3Rpb24gPSBzcmM7CiAgICAgICAgICAgICAgICBmb3JtLm1ldGhvZCA9ICdQT1NUJzsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YoY29uZmlnLnVzZVBvc3QpID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gY29uZmlnLnVzZVBvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy51c2VQb3N0Lmhhc093blByb3BlcnR5KGkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoSEFTX05BTUVfUFJPUEVSVFlfQlVHKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCc8aW5wdXQgbmFtZT0iJyArIGkgKyAnIi8+Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiSU5QVVQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5uYW1lID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gY29uZmlnLnVzZVBvc3RbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLmFwcGVuZENoaWxkKGlucHV0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcm0uc3VibWl0KCk7CiAgICAgICAgICAgICAgICBmb3JtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZm9ybSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmcmFtZS5zcmMgPSBzcmM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uZmlnLnByb3BzLnNyYyA9IHNyYzsKCiAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIENoZWNrIHdoZXRoZXIgYSBkb21haW4gaXMgYWxsb3dlZCB1c2luZyBhbiBBY2Nlc3MgQ29udHJvbCBMaXN0LgogICAgICAgICAqIFRoZSBBQ0wgY2FuIGNvbnRhaW4gKiBhbmQgPyBhcyB3aWxkY2FyZHMsIG9yIGNhbiBiZSByZWd1bGFyIGV4cHJlc3Npb25zLgogICAgICAgICAqIElmIHJlZ3VsYXIgZXhwcmVzc2lvbnMgdGhleSBuZWVkIHRvIGJlZ2luIHdpdGggXiBhbmQgZW5kIHdpdGggJC4KICAgICAgICAgKiBAcGFyYW0ge0FycmF5L1N0cmluZ30gYWNsIFRoZSBsaXN0IG9mIGFsbG93ZWQgZG9tYWlucwogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBkb21haW4gVGhlIGRvbWFpbiB0byB0ZXN0LgogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IFRydWUgaWYgdGhlIGRvbWFpbiBpcyBhbGxvd2VkLCBmYWxzZSBpZiBub3QuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY2hlY2tBY2woYWNsLCBkb21haW4pIHsKICAgICAgICAgICAgLy8gbm9ybWFsaXplIGludG8gYW4gYXJyYXkKICAgICAgICAgICAgaWYgKHR5cGVvZiBhY2wgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGFjbCA9IFthY2xdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZSwgaSA9IGFjbC5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIHJlID0gYWNsW2ldOwogICAgICAgICAgICAgICAgcmUgPSBuZXcgUmVnRXhwKHJlLnN1YnN0cigwLCAxKSA9PSAiXiIgPyByZSA6ICgiXiIgKyByZS5yZXBsYWNlKC8oXCopL2csICIuJDEiKS5yZXBsYWNlKC9cPy9nLCAiLiIpICsgIiQiKSk7CiAgICAgICAgICAgICAgICBpZiAocmUudGVzdChkb21haW4pKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgLyoKICAgICAgICAgKiBGdW5jdGlvbnMgcmVsYXRlZCB0byBzdGFja3MKICAgICAgICAgKi8KICAgICAgICAvKioKICAgICAgICAgKiBQcmVwYXJlcyBhbiBhcnJheSBvZiBzdGFjay1lbGVtZW50cyBzdWl0YWJsZSBmb3IgdGhlIGN1cnJlbnQgY29uZmlndXJhdGlvbgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIFRyYW5zcG9ydHMgY29uZmlndXJhdGlvbi4gU2VlIGVhc3lYRE0uU29ja2V0IGZvciBtb3JlLgogICAgICAgICAqIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBvZiBzdGFjay1lbGVtZW50cyB3aXRoIHRoZSBUcmFuc3BvcnRFbGVtZW50IGF0IGluZGV4IDAuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRyYW5zcG9ydFN0YWNrKGNvbmZpZykgewogICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSBjb25maWcucHJvdG9jb2wsCiAgICAgICAgICAgICAgICBzdGFja0VsczsKICAgICAgICAgICAgY29uZmlnLmlzSG9zdCA9IGNvbmZpZy5pc0hvc3QgfHwgdW5kZWYocXVlcnkueGRtX3ApOwogICAgICAgICAgICB1c2VIYXNoID0gY29uZmlnLmhhc2ggfHwgZmFsc2U7CgogICAgICAgICAgICBpZiAoIWNvbmZpZy5wcm9wcykgewogICAgICAgICAgICAgICAgY29uZmlnLnByb3BzID0ge307CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFjb25maWcuaXNIb3N0KSB7CiAgICAgICAgICAgICAgICBjb25maWcuY2hhbm5lbCA9IHF1ZXJ5LnhkbV9jLnJlcGxhY2UoL1siJzw+XFxdL2csICIiKTsKICAgICAgICAgICAgICAgIGNvbmZpZy5zZWNyZXQgPSBxdWVyeS54ZG1fczsKICAgICAgICAgICAgICAgIGNvbmZpZy5yZW1vdGUgPSBxdWVyeS54ZG1fZS5yZXBsYWNlKC9bIic8PlxcXS9nLCAiIik7OwogICAgICAgICAgICAgICAgcHJvdG9jb2wgPSBxdWVyeS54ZG1fcDsKICAgICAgICAgICAgICAgIGlmIChjb25maWcuYWNsICYmICFjaGVja0FjbChjb25maWcuYWNsLCBjb25maWcucmVtb3RlKSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQWNjZXNzIGRlbmllZCBmb3IgIiArIGNvbmZpZy5yZW1vdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uZmlnLnJlbW90ZSA9IHJlc29sdmVVcmwoY29uZmlnLnJlbW90ZSk7CiAgICAgICAgICAgICAgICBjb25maWcuY2hhbm5lbCA9IGNvbmZpZy5jaGFubmVsIHx8ICJkZWZhdWx0IiArIGNoYW5uZWxJZCsrOwogICAgICAgICAgICAgICAgY29uZmlnLnNlY3JldCA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygyKTsKICAgICAgICAgICAgICAgIGlmICh1bmRlZihwcm90b2NvbCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZ2V0TG9jYXRpb24obG9jYXRpb24uaHJlZikgPT0gZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAgICAgICAgICogQm90aCBkb2N1bWVudHMgaGFzIHRoZSBzYW1lIG9yaWdpbiwgbGV0cyB1c2UgZGlyZWN0IGFjY2Vzcy4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvY29sID0gIjQiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNIb3N0TWV0aG9kKHdpbmRvdywgInBvc3RNZXNzYWdlIikgfHwgaXNIb3N0TWV0aG9kKGRvY3VtZW50LCAicG9zdE1lc3NhZ2UiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBUaGlzIGlzIHN1cHBvcnRlZCBpbiBJRTgrLCBGaXJlZm94IDMrLCBPcGVyYSA5KywgQ2hyb21lIDIrIGFuZCBTYWZhcmkgNCsKICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvY29sID0gIjEiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29uZmlnLnN3ZiAmJiBpc0hvc3RNZXRob2Qod2luZG93LCAiQWN0aXZlWE9iamVjdCIpICYmIGhhc0ZsYXNoKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAgICAgICAgICogVGhlIEZsYXNoIHRyYW5zcG9ydCBzdXBlcnNlZWRlcyB0aGUgTml4VHJhbnNwb3J0IGFzIHRoZSBOaXhUcmFuc3BvcnQgaGFzIGJlZW4gYmxvY2tlZCBieSBNUwogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICAgICAgcHJvdG9jb2wgPSAiNiI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuYXZpZ2F0b3IucHJvZHVjdCA9PT0gIkdlY2tvIiAmJiAiZnJhbWVFbGVtZW50IiBpbiB3aW5kb3cgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdXZWJLaXQnKSA9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBUaGlzIGlzIHN1cHBvcnRlZCBpbiBHZWNrbyAoRmlyZWZveCAxKykKICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvY29sID0gIjUiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29uZmlnLnJlbW90ZUhlbHBlcikgewogICAgICAgICAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBUaGlzIGlzIHN1cHBvcnRlZCBpbiBhbGwgYnJvd3NlcnMgdGhhdCByZXRhaW5zIHRoZSB2YWx1ZSBvZiB3aW5kb3cubmFtZSB3aGVuCiAgICAgICAgICAgICAgICAgICAgICAgICAqIG5hdmlnYXRpbmcgZnJvbSBvbmUgZG9tYWluIHRvIGFub3RoZXIsIGFuZCB3aGVyZSBwYXJlbnQuZnJhbWVzW2Zvb10gY2FuIGJlIHVzZWQKICAgICAgICAgICAgICAgICAgICAgICAgICogdG8gZ2V0IGFjY2VzcyB0byBhIGZyYW1lIGZyb20gdGhlIHNhbWUgZG9tYWluCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBwcm90b2NvbCA9ICIyIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAgICAgKiBUaGlzIGlzIHN1cHBvcnRlZCBpbiBhbGwgYnJvd3NlcnMgd2hlcmUgW3dpbmRvd10ubG9jYXRpb24gaXMgd3JpdGFibGUgZm9yIGFsbAogICAgICAgICAgICAgICAgICAgICAgICAgKiBUaGUgcmVzaXplIGV2ZW50IHdpbGwgYmUgdXNlZCBpZiByZXNpemUgaXMgc3VwcG9ydGVkIGFuZCB0aGUgaWZyYW1lIGlzIG5vdCBwdXQKICAgICAgICAgICAgICAgICAgICAgICAgICogaW50byBhIGNvbnRhaW5lciwgZWxzZSBwb2xsaW5nIHdpbGwgYmUgdXNlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvY29sID0gIjAiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25maWcucHJvdG9jb2wgPSBwcm90b2NvbDsgLy8gZm9yIGNvbmRpdGlvbmFsIGJyYW5jaGluZwogICAgICAgICAgICBzd2l0Y2ggKHByb3RvY29sKSB7CiAgICAgICAgICAgICAgICBjYXNlICIwIjogLy8gMCA9IEhhc2hUcmFuc3BvcnQKICAgICAgICAgICAgICAgICAgICBhcHBseShjb25maWcsIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWw6IDEwMCwKICAgICAgICAgICAgICAgICAgICAgICAgZGVsYXk6IDIwMDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHVzZVJlc2l6ZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdXNlUGFyZW50OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgdXNlUG9sbGluZzogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLmlzSG9zdCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5sb2NhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgbm8gbG9jYWwgaXMgc2V0IHRoZW4gd2UgbmVlZCB0byBmaW5kIGFuIGltYWdlIGhvc3RlZCBvbiB0aGUgY3VycmVudCBkb21haW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkb21haW4gPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlcyA9IGRvY3VtZW50LmJvZHkuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImltZyIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSBpbWFnZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlID0gaW1hZ2VzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbWFnZS5zcmMuc3Vic3RyaW5nKDAsIGRvbWFpbi5sZW5ndGgpID09PSBkb21haW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmxvY2FsID0gaW1hZ2Uuc3JjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5sb2NhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIG5vIGxvY2FsIHdhcyBzZXQsIGFuZCB3ZSBhcmUgdW5hYmxlIHRvIGZpbmQgYSBzdWl0YWJsZSBmaWxlLCB0aGVuIHdlIHJlc29ydCB0byB1c2luZyB0aGUgY3VycmVudCB3aW5kb3cKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcubG9jYWwgPSB3aW5kb3c7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJhbWV0ZXJzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX2M6IGNvbmZpZy5jaGFubmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX3A6IDAKICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcubG9jYWwgPT09IHdpbmRvdykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2UgYXJlIHVzaW5nIHRoZSBjdXJyZW50IHdpbmRvdyB0byBsaXN0ZW4gdG8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy51c2VQb2xsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy51c2VQYXJlbnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmxvY2FsID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1ldGVycy54ZG1fZSA9IGNvbmZpZy5sb2NhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnMueGRtX3BhID0gMTsgLy8gdXNlIHBhcmVudAogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1ldGVycy54ZG1fZSA9IHJlc29sdmVVcmwoY29uZmlnLmxvY2FsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5jb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy51c2VSZXNpemUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnMueGRtX3BvID0gMTsgLy8gdXNlIHBvbGxpbmcKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjb25maWcucmVtb3RlID0gYXBwZW5kUXVlcnlQYXJhbWV0ZXJzKGNvbmZpZy5yZW1vdGUsIHBhcmFtZXRlcnMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5KGNvbmZpZywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbDogcXVlcnkueGRtX2MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdGU6IHF1ZXJ5LnhkbV9lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlUGFyZW50OiAhdW5kZWYocXVlcnkueGRtX3BhKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZVBvbGxpbmc6ICF1bmRlZihxdWVyeS54ZG1fcG8pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlUmVzaXplOiBjb25maWcudXNlUGFyZW50ID8gZmFsc2UgOiBjb25maWcudXNlUmVzaXplCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdGFja0VscyA9IFtuZXcgZWFzeVhETS5zdGFjay5IYXNoVHJhbnNwb3J0KGNvbmZpZyksIG5ldyBlYXN5WERNLnN0YWNrLlJlbGlhYmxlQmVoYXZpb3Ioe30pLCBuZXcgZWFzeVhETS5zdGFjay5RdWV1ZUJlaGF2aW9yKHsKICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2RlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBtYXhMZW5ndGg6IDQwMDAgLSBjb25maWcucmVtb3RlLmxlbmd0aAogICAgICAgICAgICAgICAgICAgIH0pLCBuZXcgZWFzeVhETS5zdGFjay5WZXJpZnlCZWhhdmlvcih7CiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYXRlOiBjb25maWcuaXNIb3N0CiAgICAgICAgICAgICAgICAgICAgfSldOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiMSI6CiAgICAgICAgICAgICAgICAgICAgc3RhY2tFbHMgPSBbbmV3IGVhc3lYRE0uc3RhY2suUG9zdE1lc3NhZ2VUcmFuc3BvcnQoY29uZmlnKV07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICIyIjoKICAgICAgICAgICAgICAgICAgICBjb25maWcucmVtb3RlSGVscGVyID0gcmVzb2x2ZVVybChjb25maWcucmVtb3RlSGVscGVyKTsKICAgICAgICAgICAgICAgICAgICBzdGFja0VscyA9IFtuZXcgZWFzeVhETS5zdGFjay5OYW1lVHJhbnNwb3J0KGNvbmZpZyksIG5ldyBlYXN5WERNLnN0YWNrLlF1ZXVlQmVoYXZpb3IoKSwgbmV3IGVhc3lYRE0uc3RhY2suVmVyaWZ5QmVoYXZpb3IoewogICAgICAgICAgICAgICAgICAgICAgICBpbml0aWF0ZTogY29uZmlnLmlzSG9zdAogICAgICAgICAgICAgICAgICAgIH0pXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgIjMiOgogICAgICAgICAgICAgICAgICAgIHN0YWNrRWxzID0gW25ldyBlYXN5WERNLnN0YWNrLk5peFRyYW5zcG9ydChjb25maWcpXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgIjQiOgogICAgICAgICAgICAgICAgICAgIHN0YWNrRWxzID0gW25ldyBlYXN5WERNLnN0YWNrLlNhbWVPcmlnaW5UcmFuc3BvcnQoY29uZmlnKV07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICI1IjoKICAgICAgICAgICAgICAgICAgICBzdGFja0VscyA9IFtuZXcgZWFzeVhETS5zdGFjay5GcmFtZUVsZW1lbnRUcmFuc3BvcnQoY29uZmlnKV07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICI2IjoKICAgICAgICAgICAgICAgICAgICBpZiAoIWZsYXNoVmVyc2lvbikgewogICAgICAgICAgICAgICAgICAgICAgICBoYXNGbGFzaCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdGFja0VscyA9IFtuZXcgZWFzeVhETS5zdGFjay5GbGFzaFRyYW5zcG9ydChjb25maWcpXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB0aGlzIGJlaGF2aW9yIGlzIHJlc3BvbnNpYmxlIGZvciBidWZmZXJpbmcgb3V0Z29pbmcgbWVzc2FnZXMsIGFuZCBmb3IgcGVyZm9ybWluZyBsYXp5IGluaXRpYWxpemF0aW9uCiAgICAgICAgICAgIHN0YWNrRWxzLnB1c2gobmV3IGVhc3lYRE0uc3RhY2suUXVldWVCZWhhdmlvcih7CiAgICAgICAgICAgICAgICBsYXp5OiBjb25maWcubGF6eSwKICAgICAgICAgICAgICAgIHJlbW92ZTogdHJ1ZQogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIHJldHVybiBzdGFja0VsczsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIENoYWlucyBhbGwgdGhlIHNlcGFyYXRlIHN0YWNrIGVsZW1lbnRzIGludG8gYSBzaW5nbGUgdXNhYmxlIHN0YWNrLjxici8+CiAgICAgICAgICogSWYgYW4gZWxlbWVudCBpcyBtaXNzaW5nIGEgbmVjZXNzYXJ5IG1ldGhvZCB0aGVuIGl0IHdpbGwgaGF2ZSBhIHBhc3MtdGhyb3VnaCBtZXRob2QgYXBwbGllZC4KICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBzdGFja0VsZW1lbnRzIEFuIGFycmF5IG9mIHN0YWNrIGVsZW1lbnRzIHRvIGJlIGxpbmtlZC4KICAgICAgICAgKiBAcmV0dXJuIHtlYXN5WERNLnN0YWNrLlN0YWNrRWxlbWVudH0gVGhlIGxhc3QgZWxlbWVudCBpbiB0aGUgY2hhaW4uCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY2hhaW5TdGFjayhzdGFja0VsZW1lbnRzKSB7CiAgICAgICAgICAgIHZhciBzdGFja0VsLCBkZWZhdWx0cyA9IHsKICAgICAgICAgICAgICAgICAgICBpbmNvbWluZzogZnVuY3Rpb24obWVzc2FnZSwgb3JpZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXAuaW5jb21pbmcobWVzc2FnZSwgb3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIG91dGdvaW5nOiBmdW5jdGlvbihtZXNzYWdlLCByZWNpcGllbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3duLm91dGdvaW5nKG1lc3NhZ2UsIHJlY2lwaWVudCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24oc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwLmNhbGxiYWNrKHN1Y2Nlc3MpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZG93bi5pbml0KCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb3duLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gc3RhY2tFbGVtZW50cy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgc3RhY2tFbCA9IHN0YWNrRWxlbWVudHNbaV07CiAgICAgICAgICAgICAgICBhcHBseShzdGFja0VsLCBkZWZhdWx0cywgdHJ1ZSk7CiAgICAgICAgICAgICAgICBpZiAoaSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIHN0YWNrRWwuZG93biA9IHN0YWNrRWxlbWVudHNbaSAtIDFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGkgIT09IGxlbiAtIDEpIHsKICAgICAgICAgICAgICAgICAgICBzdGFja0VsLnVwID0gc3RhY2tFbGVtZW50c1tpICsgMV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0YWNrRWw7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBUaGlzIHdpbGwgcmVtb3ZlIGEgc3RhY2tlbGVtZW50IGZyb20gaXRzIHN0YWNrIHdoaWxlIGxlYXZpbmcgdGhlIHN0YWNrIGZ1bmN0aW9uYWwuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGVsZW1lbnQgVGhlIGVsbWVudCB0byByZW1vdmUgZnJvbSB0aGUgc3RhY2suCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlRnJvbVN0YWNrKGVsZW1lbnQpIHsKICAgICAgICAgICAgZWxlbWVudC51cC5kb3duID0gZWxlbWVudC5kb3duOwogICAgICAgICAgICBlbGVtZW50LmRvd24udXAgPSBlbGVtZW50LnVwOwogICAgICAgICAgICBlbGVtZW50LnVwID0gZWxlbWVudC5kb3duID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICogRXhwb3J0IHRoZSBtYWluIG9iamVjdCBhbmQgYW55IG90aGVyIG1ldGhvZHMgYXBwbGljYWJsZQogICAgICAgICAqLwogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNCiAgICAgICAgICogQSBqYXZhc2NyaXB0IGxpYnJhcnkgcHJvdmlkaW5nIGNyb3NzLWJyb3dzZXIsIGNyb3NzLWRvbWFpbiBtZXNzYWdpbmcvUlBDLgogICAgICAgICAqIEB2ZXJzaW9uIDIuNC4xNy4xCiAgICAgICAgICogQHNpbmdsZXRvbgogICAgICAgICAqLwogICAgICAgIGFwcGx5KGVhc3lYRE0sIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFRoZSB2ZXJzaW9uIG9mIHRoZSBsaWJyYXJ5CiAgICAgICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICAgICAqLwogICAgICAgICAgICB2ZXJzaW9uOiAiMi40LjE3LjEiLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogVGhpcyBpcyBhIG1hcCBjb250YWluaW5nIGFsbCB0aGUgcXVlcnkgcGFyYW1ldGVycyBwYXNzZWQgdG8gdGhlIGRvY3VtZW50LgogICAgICAgICAgICAgKiBBbGwgdGhlIHZhbHVlcyBoYXMgYmVlbiBkZWNvZGVkIHVzaW5nIGRlY29kZVVSSUNvbXBvbmVudC4KICAgICAgICAgICAgICogQHR5cGUge29iamVjdH0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHF1ZXJ5OiBxdWVyeSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBzdGFjazoge30sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBBcHBsaWVzIHByb3BlcnRpZXMgZnJvbSB0aGUgc291cmNlIG9iamVjdCB0byB0aGUgdGFyZ2V0IG9iamVjdC48YnIvPgogICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gdGFyZ2V0IFRoZSB0YXJnZXQgb2YgdGhlIHByb3BlcnRpZXMuCiAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzb3VyY2UgVGhlIHNvdXJjZSBvZiB0aGUgcHJvcGVydGllcy4KICAgICAgICAgICAgICogQHBhcmFtIHtib29sZWFufSBub092ZXJ3cml0ZSBTZXQgdG8gVHJ1ZSB0byBvbmx5IHNldCBub24tZXhpc3RpbmcgcHJvcGVydGllcy4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGFwcGx5OiBhcHBseSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBBIHNhZmUgaW1wbGVtZW50YXRpb24gb2YgSFRNTDUgSlNPTi4gRmVhdHVyZSB0ZXN0aW5nIGlzIHVzZWQgdG8gbWFrZSBzdXJlIHRoZSBpbXBsZW1lbnRhdGlvbiB3b3Jrcy4KICAgICAgICAgICAgICogQHJldHVybiB7SlNPTn0gQSB2YWxpZCBKU09OIGNvbmZvcm1pbmcgb2JqZWN0LCBvciBudWxsIGlmIG5vdCBmb3VuZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldEpTT05PYmplY3Q6IGdldEpTT04sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBUaGlzIHdpbGwgYWRkIGEgZnVuY3Rpb24gdG8gdGhlIHF1ZXVlIG9mIGZ1bmN0aW9ucyB0byBiZSBydW4gb25jZSB0aGUgRE9NIHJlYWNoZXMgYSByZWFkeSBzdGF0ZS4KICAgICAgICAgICAgICogSWYgZnVuY3Rpb25zIGFyZSBhZGRlZCBhZnRlciB0aGlzIGV2ZW50IHRoZW4gdGhleSB3aWxsIGJlIGV4ZWN1dGVkIGltbWVkaWF0ZWx5LgogICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gYWRkCiAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzY29wZSBBbiBvcHRpb25hbCBzY29wZSBmb3IgdGhlIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aXRoLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgd2hlblJlYWR5OiB3aGVuUmVhZHksCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBSZW1vdmVzIGVhc3lYRE0gdmFyaWFibGUgZnJvbSB0aGUgZ2xvYmFsIHNjb3BlLiBJdCBhbHNvIHJldHVybnMgY29udHJvbAogICAgICAgICAgICAgKiBvZiB0aGUgZWFzeVhETSB2YXJpYWJsZSB0byB3aGF0ZXZlciBjb2RlIHVzZWQgaXQgYmVmb3JlLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbnMgQSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgYW4gb2JqZWN0IHRoYXQgd2lsbCBob2xkCiAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICBhbiBpbnN0YW5jZSBvZiBlYXN5WERNLgogICAgICAgICAgICAgKiBAcmV0dXJuIEFuIGluc3RhbmNlIG9mIGVhc3lYRE0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIG5vQ29uZmxpY3Q6IG5vQ29uZmxpY3QKICAgICAgICB9KTsKCiAgICAgICAgLypqc2xpbnQgZXZpbDogdHJ1ZSwgYnJvd3NlcjogdHJ1ZSwgaW1tZWQ6IHRydWUsIHBhc3NmYWlsOiB0cnVlLCB1bmRlZjogdHJ1ZSwgbmV3Y2FwOiB0cnVlKi8KICAgICAgICAvKmdsb2JhbCBjb25zb2xlLCBfRmlyZWJ1Z0NvbW1hbmRMaW5lLCAgZWFzeVhETSwgd2luZG93LCBlc2NhcGUsIHVuZXNjYXBlLCBpc0hvc3RPYmplY3QsIHVuZGVmLCBfdHJhY2UsIGRvbUlzUmVhZHksIGVtcHR5Rm4sIG5hbWVzcGFjZSAqLwogICAgICAgIC8vCiAgICAgICAgLy8gZWFzeVhETQogICAgICAgIC8vIGh0dHA6Ly9lYXN5eGRtLm5ldC8KICAgICAgICAvLyBDb3B5cmlnaHQoYykgMjAwOS0yMDExLCDDmHl2aW5kIFNlYW4gS2luc2V5LCBveXZpbmRAa2luc2V5Lm5vLgogICAgICAgIC8vCiAgICAgICAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogICAgICAgIC8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAgICAgICAgLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogICAgICAgIC8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICAgICAgICAvLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICAgICAgICAvLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgogICAgICAgIC8vCiAgICAgICAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICAgICAgICAvLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAgICAgICAvLwogICAgICAgIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAgICAgICAgLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAgICAgICAgLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAgICAgICAgLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogICAgICAgIC8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAgICAgICAgLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogICAgICAgIC8vIFRIRSBTT0ZUV0FSRS4KICAgICAgICAvLwoKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIGVhc3lYRE0sIHdpbmRvdywgZXNjYXBlLCB1bmVzY2FwZSwgaXNIb3N0T2JqZWN0LCBpc0hvc3RNZXRob2QsIHVuLCBvbiwgY3JlYXRlRnJhbWUsIGRlYnVnICovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLkRvbUhlbHBlcgogICAgICAgICAqIENvbnRhaW5zIG1ldGhvZHMgZm9yIGRlYWxpbmcgd2l0aCB0aGUgRE9NCiAgICAgICAgICogQHNpbmdsZXRvbgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uRG9tSGVscGVyID0gewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUHJvdmlkZXMgYSBjb25zaXN0ZW50IGludGVyZmFjZSBmb3IgYWRkaW5nIGV2ZW50aGFuZGxlcnMKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUaGUgdGFyZ2V0IHRvIGFkZCB0aGUgZXZlbnQgdG8KICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIG5hbWUgb2YgdGhlIGV2ZW50CiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIFRoZSBsaXN0ZW5lcgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgb246IG9uLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUHJvdmlkZXMgYSBjb25zaXN0ZW50IGludGVyZmFjZSBmb3IgcmVtb3ZpbmcgZXZlbnRoYW5kbGVycwogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0IFRoZSB0YXJnZXQgdG8gcmVtb3ZlIHRoZSBldmVudCBmcm9tCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBuYW1lIG9mIHRoZSBldmVudAogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciBUaGUgbGlzdGVuZXIKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHVuOiB1biwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENoZWNrcyBmb3IgdGhlIHByZXNlbmNlIG9mIHRoZSBKU09OIG9iamVjdC4KICAgICAgICAgICAgICogSWYgaXQgaXMgbm90IHByZXNlbnQgaXQgd2lsbCB1c2UgdGhlIHN1cHBsaWVkIHBhdGggdG8gbG9hZCB0aGUgSlNPTjIgbGlicmFyeS4KICAgICAgICAgICAgICogVGhpcyBzaG91bGQgYmUgY2FsbGVkIGluIHRoZSBkb2N1bWVudHMgaGVhZCByaWdodCBhZnRlciB0aGUgZWFzeVhETSBzY3JpcHQgdGFnLgogICAgICAgICAgICAgKiBodHRwOi8vanNvbi5vcmcvanNvbjIuanMKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGggQSB2YWxpZCBwYXRoIHRvIGpzb24yLmpzCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZXF1aXJlc0pTT046IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICAgICAgICAgIGlmICghaXNIb3N0T2JqZWN0KHdpbmRvdywgIkpTT04iKSkgewogICAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gZW5jb2RlIHRoZSA8IGluIG9yZGVyIHRvIGF2b2lkIGFuIGlsbGVnYWwgdG9rZW4gZXJyb3IKICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSBzY3JpcHQgaXMgaW5saW5lZCBpbiBhIGRvY3VtZW50LgogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LndyaXRlKCc8JyArICdzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0IiBzcmM9IicgKyBwYXRoICsgJyI+PCcgKyAnL3NjcmlwdD4nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgLypqc2xpbnQgZXZpbDogdHJ1ZSwgYnJvd3NlcjogdHJ1ZSwgaW1tZWQ6IHRydWUsIHBhc3NmYWlsOiB0cnVlLCB1bmRlZjogdHJ1ZSwgbmV3Y2FwOiB0cnVlKi8KICAgICAgICAvKmdsb2JhbCBlYXN5WERNLCB3aW5kb3csIGVzY2FwZSwgdW5lc2NhcGUsIGRlYnVnICovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gVGhlIG1hcCBjb250YWluaW5nIHRoZSBzdG9yZWQgZnVuY3Rpb25zCiAgICAgICAgICAgIHZhciBfbWFwID0ge307CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQGNsYXNzIGVhc3lYRE0uRm4KICAgICAgICAgICAgICogVGhpcyBjb250YWlucyBtZXRob2RzIHJlbGF0ZWQgdG8gZnVuY3Rpb24gaGFuZGxpbmcsIHN1Y2ggYXMgc3RvcmluZyBjYWxsYmFja3MuCiAgICAgICAgICAgICAqIEBzaW5nbGV0b24KICAgICAgICAgICAgICogQG5hbWVzcGFjZSBlYXN5WERNCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBlYXN5WERNLkZuID0gewogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBTdG9yZXMgYSBmdW5jdGlvbiB1c2luZyB0aGUgZ2l2ZW4gbmFtZSBmb3IgcmVmZXJlbmNlCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSB0aGF0IHRoZSBmdW5jdGlvbiBzaG91bGQgYmUgcmVmZXJyZWQgYnkKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBzdG9yZQogICAgICAgICAgICAgICAgICogQG5hbWVzcGFjZSBlYXN5WERNLmZuCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmFtZSwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBfbWFwW25hbWVdID0gZm47CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBSZXRyaWV2ZXMgdGhlIGZ1bmN0aW9uIHJlZmVycmVkIHRvIGJ5IHRoZSBnaXZlbiBuYW1lCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgZnVuY3Rpb24gdG8gcmV0cmlldmUKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gZGVsIElmIHRoZSBmdW5jdGlvbiBzaG91bGQgYmUgZGVsZXRlZCBhZnRlciByZXRyaWV2YWwKICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSBUaGUgc3RvcmVkIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgKiBAbmFtZXNwYWNlIGVhc3lYRE0uZm4KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbihuYW1lLCBkZWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZm4gPSBfbWFwW25hbWVdOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZGVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBfbWFwW25hbWVdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgIH0oKSk7CiAgICAgICAgLypqc2xpbnQgZXZpbDogdHJ1ZSwgYnJvd3NlcjogdHJ1ZSwgaW1tZWQ6IHRydWUsIHBhc3NmYWlsOiB0cnVlLCB1bmRlZjogdHJ1ZSwgbmV3Y2FwOiB0cnVlKi8KICAgICAgICAvKmdsb2JhbCBlYXN5WERNLCB3aW5kb3csIGVzY2FwZSwgdW5lc2NhcGUsIGNoYWluU3RhY2ssIHByZXBhcmVUcmFuc3BvcnRTdGFjaywgZ2V0TG9jYXRpb24sIGRlYnVnICovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLlNvY2tldAogICAgICAgICAqIFRoaXMgY2xhc3MgY3JlYXRlcyBhIHRyYW5zcG9ydCBjaGFubmVsIGJldHdlZW4gdHdvIGRvbWFpbnMgdGhhdCBpcyB1c2FibGUgZm9yIHNlbmRpbmcgYW5kIHJlY2VpdmluZyBzdHJpbmctYmFzZWQgbWVzc2FnZXMuPGJyLz4KICAgICAgICAgKiBUaGUgY2hhbm5lbCBpcyByZWxpYWJsZSwgc3VwcG9ydHMgcXVldWVpbmcsIGFuZCBlbnN1cmVzIHRoYXQgdGhlIG1lc3NhZ2Ugb3JpZ2luYXRlcyBmcm9tIHRoZSBleHBlY3RlZCBkb21haW4uPGJyLz4KICAgICAgICAgKiBJbnRlcm5hbGx5IGRpZmZlcmVudCBzdGFja3Mgd2lsbCBiZSB1c2VkIGRlcGVuZGluZyBvbiB0aGUgYnJvd3NlcnMgZmVhdHVyZXMgYW5kIHRoZSBhdmFpbGFibGUgcGFyYW1ldGVycy4KICAgICAgICAgKiA8aDI+SG93IHRvIHNldCB1cDwvaDI+CiAgICAgICAgICogU2V0dGluZyB1cCB0aGUgcHJvdmlkZXI6CiAgICAgICAgICogPHByZT48Y29kZT4KICAgICAgICAgKiB2YXIgc29ja2V0ID0gbmV3IGVhc3lYRE0uU29ja2V0KHsKICAgICAgICAgKiAmbmJzcDsgbG9jYWw6ICJuYW1lLmh0bWwiLAogICAgICAgICAqICZuYnNwOyBvblJlYWR5OiBmdW5jdGlvbigpewogICAgICAgICAqICZuYnNwOyAmbmJzcDsgJiM0NzsmIzQ3OyB5b3UgbmVlZCB0byB3YWl0IGZvciB0aGUgb25SZWFkeSBjYWxsYmFjayBiZWZvcmUgdXNpbmcgdGhlIHNvY2tldAogICAgICAgICAqICZuYnNwOyAmbmJzcDsgc29ja2V0LnBvc3RNZXNzYWdlKCJmb28tbWVzc2FnZSIpOwogICAgICAgICAqICZuYnNwOyB9LAogICAgICAgICAqICZuYnNwOyBvbk1lc3NhZ2U6IGZ1bmN0aW9uKG1lc3NhZ2UsIG9yaWdpbikgewogICAgICAgICAqICZuYnNwOyZuYnNwOyBhbGVydCgicmVjZWl2ZWQgIiArIG1lc3NhZ2UgKyAiIGZyb20gIiArIG9yaWdpbik7CiAgICAgICAgICogJm5ic3A7IH0KICAgICAgICAgKiB9KTsKICAgICAgICAgKiA8L2NvZGU+PC9wcmU+CiAgICAgICAgICogU2V0dGluZyB1cCB0aGUgY29uc3VtZXI6CiAgICAgICAgICogPHByZT48Y29kZT4KICAgICAgICAgKiB2YXIgc29ja2V0ID0gbmV3IGVhc3lYRE0uU29ja2V0KHsKICAgICAgICAgKiAmbmJzcDsgcmVtb3RlOiAiaHR0cDomIzQ3OyYjNDc7cmVtb3RlZG9tYWluL3BhZ2UuaHRtbCIsCiAgICAgICAgICogJm5ic3A7IHJlbW90ZUhlbHBlcjogImh0dHA6JiM0NzsmIzQ3O3JlbW90ZWRvbWFpbi9uYW1lLmh0bWwiLAogICAgICAgICAqICZuYnNwOyBvblJlYWR5OiBmdW5jdGlvbigpewogICAgICAgICAqICZuYnNwOyAmbmJzcDsgJiM0NzsmIzQ3OyB5b3UgbmVlZCB0byB3YWl0IGZvciB0aGUgb25SZWFkeSBjYWxsYmFjayBiZWZvcmUgdXNpbmcgdGhlIHNvY2tldAogICAgICAgICAqICZuYnNwOyAmbmJzcDsgc29ja2V0LnBvc3RNZXNzYWdlKCJmb28tbWVzc2FnZSIpOwogICAgICAgICAqICZuYnNwOyB9LAogICAgICAgICAqICZuYnNwOyBvbk1lc3NhZ2U6IGZ1bmN0aW9uKG1lc3NhZ2UsIG9yaWdpbikgewogICAgICAgICAqICZuYnNwOyZuYnNwOyBhbGVydCgicmVjZWl2ZWQgIiArIG1lc3NhZ2UgKyAiIGZyb20gIiArIG9yaWdpbik7CiAgICAgICAgICogJm5ic3A7IH0KICAgICAgICAgKiB9KTsKICAgICAgICAgKiA8L2NvZGU+PC9wcmU+CiAgICAgICAgICogSWYgeW91IGFyZSB1bmFibGUgdG8gdXBsb2FkIHRoZSA8Y29kZT5uYW1lLmh0bWw8L2NvZGU+IGZpbGUgdG8gdGhlIGNvbnN1bWVycyBkb21haW4gdGhlbiByZW1vdmUgdGhlIDxjb2RlPnJlbW90ZUhlbHBlcjwvY29kZT4gcHJvcGVydHkKICAgICAgICAgKiBhbmQgZWFzeVhETSB3aWxsIGZhbGwgYmFjayB0byB1c2luZyB0aGUgSGFzaFRyYW5zcG9ydCBpbnN0ZWFkIG9mIHRoZSBOYW1lVHJhbnNwb3J0IHdoZW4gbm90IGFibGUgdG8gdXNlIGFueSBvZiB0aGUgcHJpbWFyeSB0cmFuc3BvcnRzLgogICAgICAgICAqIEBuYW1lc3BhY2UgZWFzeVhETQogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBjZmcge1N0cmluZy9XaW5kb3d9IGxvY2FsIFRoZSB1cmwgdG8gdGhlIGxvY2FsIG5hbWUuaHRtbCBkb2N1bWVudCwgYSBsb2NhbCBzdGF0aWMgZmlsZSwgb3IgYSByZWZlcmVuY2UgdG8gdGhlIGxvY2FsIHdpbmRvdy4KICAgICAgICAgKiBAY2ZnIHtCb29sZWFufSBsYXp5IChDb25zdW1lciBvbmx5KSBTZXQgdGhpcyB0byB0cnVlIGlmIHlvdSB3YW50IGVhc3lYRE0gdG8gZGVmZXIgY3JlYXRpbmcgdGhlIHRyYW5zcG9ydCB1bnRpbCByZWFsbHkgbmVlZGVkLgogICAgICAgICAqIEBjZmcge1N0cmluZ30gcmVtb3RlIChDb25zdW1lciBvbmx5KSBUaGUgdXJsIHRvIHRoZSBwcm92aWRlcnMgZG9jdW1lbnQuCiAgICAgICAgICogQGNmZyB7U3RyaW5nfSByZW1vdGVIZWxwZXIgKENvbnN1bWVyIG9ubHkpIFRoZSB1cmwgdG8gdGhlIHJlbW90ZSBuYW1lLmh0bWwgZmlsZS4gVGhpcyBpcyB0byBzdXBwb3J0IE5hbWVUcmFuc3BvcnQgYXMgYSBmYWxsYmFjay4gT3B0aW9uYWwuCiAgICAgICAgICogQGNmZyB7TnVtYmVyfSBkZWxheSBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBlYXN5WERNIHNob3VsZCB0cnkgdG8gZ2V0IGEgcmVmZXJlbmNlIHRvIHRoZSBsb2NhbCB3aW5kb3cuICBPcHRpb25hbCwgZGVmYXVsdHMgdG8gMjAwMC4KICAgICAgICAgKiBAY2ZnIHtOdW1iZXJ9IGludGVydmFsIFRoZSBpbnRlcnZhbCB1c2VkIHdoZW4gcG9sbGluZyBmb3IgbWVzc2FnZXMuIE9wdGlvbmFsLCBkZWZhdWx0cyB0byAzMDAuCiAgICAgICAgICogQGNmZyB7U3RyaW5nfSBjaGFubmVsIChDb25zdW1lciBvbmx5KSBUaGUgbmFtZSBvZiB0aGUgY2hhbm5lbCB0byB1c2UuIENhbiBiZSB1c2VkIHRvIHNldCBjb25zaXN0ZW50IGlmcmFtZSBuYW1lcy4gTXVzdCBiZSB1bmlxdWUuIE9wdGlvbmFsLgogICAgICAgICAqIEBjZmcge0Z1bmN0aW9ufSBvbk1lc3NhZ2UgVGhlIG1ldGhvZCB0aGF0IHNob3VsZCBoYW5kbGUgaW5jb21pbmcgbWVzc2FnZXMuPGJyLz4gVGhpcyBtZXRob2Qgc2hvdWxkIGFjY2VwdCB0d28gYXJndW1lbnRzLCB0aGUgbWVzc2FnZSBhcyBhIHN0cmluZywgYW5kIHRoZSBvcmlnaW4gYXMgYSBzdHJpbmcuIE9wdGlvbmFsLgogICAgICAgICAqIEBjZmcge0Z1bmN0aW9ufSBvblJlYWR5IEEgbWV0aG9kIHRoYXQgc2hvdWxkIGJlIGNhbGxlZCB3aGVuIHRoZSB0cmFuc3BvcnQgaXMgcmVhZHkuIE9wdGlvbmFsLgogICAgICAgICAqIEBjZmcge0RPTUVsZW1lbnR8U3RyaW5nfSBjb250YWluZXIgKENvbnN1bWVyIG9ubHkpIFRoZSBlbGVtZW50LCBvciB0aGUgaWQgb2YgdGhlIGVsZW1lbnQgdGhhdCB0aGUgcHJpbWFyeSBpZnJhbWUgc2hvdWxkIGJlIGluc2VydGVkIGludG8uIElmIG5vdCBzZXQgdGhlbiB0aGUgaWZyYW1lIHdpbGwgYmUgcG9zaXRpb25lZCBvZmYtc2NyZWVuLiBPcHRpb25hbC4KICAgICAgICAgKiBAY2ZnIHtBcnJheS9TdHJpbmd9IGFjbCAoUHJvdmlkZXIgb25seSkgSGVyZSB5b3UgY2FuIHNwZWNpZnkgd2hpY2ggJ1twcm90b2NvbF06Ly9bZG9tYWluXScgcGF0dGVybnMgdGhhdCBzaG91bGQgYmUgYWxsb3dlZCB0byBhY3QgYXMgdGhlIGNvbnN1bWVyIHRvd2FyZHMgdGhpcyBwcm92aWRlci48YnIvPgogICAgICAgICAqIFRoaXMgY2FuIGNvbnRhaW4gdGhlIHdpbGRjYXJkcyA/IGFuZCAqLiAgRXhhbXBsZXMgYXJlICdodHRwOi8vZXhhbXBsZS5jb20nLCAnKi5mb28uY29tJyBhbmQgJypkb20/LmNvbScuIElmIHlvdSB3YW50IHRvIHVzZSByZXF1bGFyIGV4cHJlc3Npb25zIHRoZW4geW91IHBhdHRlcm4gbmVlZHMgdG8gc3RhcnQgd2l0aCBeIGFuZCBlbmQgd2l0aCAkLgogICAgICAgICAqIElmIG5vbmUgb2YgdGhlIHBhdHRlcm5zIG1hdGNoIGFuIEVycm9yIHdpbGwgYmUgdGhyb3duLgogICAgICAgICAqIEBjZmcge09iamVjdH0gcHJvcHMgKENvbnN1bWVyIG9ubHkpIEFkZGl0aW9uYWwgcHJvcGVydGllcyB0aGF0IHNob3VsZCBiZSBhcHBsaWVkIHRvIHRoZSBpZnJhbWUuIFRoaXMgY2FuIGFsc28gY29udGFpbiBuZXN0ZWQgb2JqZWN0cyBlLmc6IDxjb2RlPntzdHlsZTp7d2lkdGg6IjEwMHB4IiwgaGVpZ2h0OiIxMDBweCJ9fTwvY29kZT4uCiAgICAgICAgICogUHJvcGVydGllcyBzdWNoIGFzICduYW1lJyBhbmQgJ3NyYycgd2lsbCBiZSBvdmVycmlkZWQuIE9wdGlvbmFsLgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uU29ja2V0ID0gZnVuY3Rpb24oY29uZmlnKSB7CgogICAgICAgICAgICAvLyBjcmVhdGUgdGhlIHN0YWNrCiAgICAgICAgICAgIHZhciBzdGFjayA9IGNoYWluU3RhY2socHJlcGFyZVRyYW5zcG9ydFN0YWNrKGNvbmZpZykuY29uY2F0KFt7CiAgICAgICAgICAgICAgICBpbmNvbWluZzogZnVuY3Rpb24obWVzc2FnZSwgb3JpZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLm9uTWVzc2FnZShtZXNzYWdlLCBvcmlnaW4pOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5vblJlYWR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5vblJlYWR5KHN1Y2Nlc3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV0pKSwKICAgICAgICAgICAgICAgIHJlY2lwaWVudCA9IGdldExvY2F0aW9uKGNvbmZpZy5yZW1vdGUpOwoKICAgICAgICAgICAgLy8gc2V0IHRoZSBvcmlnaW4KICAgICAgICAgICAgdGhpcy5vcmlnaW4gPSBnZXRMb2NhdGlvbihjb25maWcucmVtb3RlKTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBJbml0aWF0ZXMgdGhlIGRlc3RydWN0aW9uIG9mIHRoZSBzdGFjay4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRoaXMuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc3RhY2suZGVzdHJveSgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFBvc3RzIGEgbWVzc2FnZSB0byB0aGUgcmVtb3RlIGVuZCBvZiB0aGUgY2hhbm5lbAogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgbWVzc2FnZSB0byBzZW5kCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB0aGlzLnBvc3RNZXNzYWdlID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICAgICAgc3RhY2sub3V0Z29pbmcobWVzc2FnZSwgcmVjaXBpZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHN0YWNrLmluaXQoKTsKICAgICAgICB9OwogICAgICAgIC8qanNsaW50IGV2aWw6IHRydWUsIGJyb3dzZXI6IHRydWUsIGltbWVkOiB0cnVlLCBwYXNzZmFpbDogdHJ1ZSwgdW5kZWY6IHRydWUsIG5ld2NhcDogdHJ1ZSovCiAgICAgICAgLypnbG9iYWwgZWFzeVhETSwgd2luZG93LCBlc2NhcGUsIHVuZXNjYXBlLCB1bmRlZiwsIGNoYWluU3RhY2ssIHByZXBhcmVUcmFuc3BvcnRTdGFjaywgZGVidWcsIGdldExvY2F0aW9uICovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLlJwYwogICAgICAgICAqIENyZWF0ZXMgYSBwcm94eSBvYmplY3QgdGhhdCBjYW4gYmUgdXNlZCB0byBjYWxsIG1ldGhvZHMgaW1wbGVtZW50ZWQgb24gdGhlIHJlbW90ZSBlbmQgb2YgdGhlIGNoYW5uZWwsIGFuZCBhbHNvIHRvIHByb3ZpZGUgdGhlIGltcGxlbWVudGF0aW9uCiAgICAgICAgICogb2YgbWV0aG9kcyB0byBiZSBjYWxsZWQgZnJvbSB0aGUgcmVtb3RlIGVuZC48YnIvPgogICAgICAgICAqIFRoZSBpbnN0YW50aWF0ZWQgb2JqZWN0IHdpbGwgaGF2ZSBtZXRob2RzIG1hdGNoaW5nIHRob3NlIHNwZWNpZmllZCBpbiA8Y29kZT5jb25maWcucmVtb3RlPC9jb2RlPi48YnIvPgogICAgICAgICAqIFRoaXMgcmVxdWlyZXMgdGhlIEpTT04gb2JqZWN0IHByZXNlbnQgaW4gdGhlIGRvY3VtZW50LCBlaXRoZXIgbmF0aXZlbHksIHVzaW5nIGpzb24ub3JnJ3MganNvbjIgb3IgYXMgYSB3cmFwcGVyIGFyb3VuZCBsaWJyYXJ5IHNwZXNpZmljIG1ldGhvZHMuCiAgICAgICAgICogPGgyPkhvdyB0byBzZXQgdXA8L2gyPgogICAgICAgICAqIDxwcmU+PGNvZGU+CiAgICAgICAgICogdmFyIHJwYyA9IG5ldyBlYXN5WERNLlJwYyh7CiAgICAgICAgICogJm5ic3A7ICYjNDc7JiM0NzsgdGhpcyBjb25maWd1cmF0aW9uIGlzIGVxdWFsIHRvIHRoYXQgdXNlZCBieSB0aGUgU29ja2V0LgogICAgICAgICAqICZuYnNwOyByZW1vdGU6ICJodHRwOiYjNDc7JiM0NztyZW1vdGVkb21haW4vLi4uIiwKICAgICAgICAgKiAmbmJzcDsgb25SZWFkeTogZnVuY3Rpb24oKXsKICAgICAgICAgKiAmbmJzcDsgJm5ic3A7ICYjNDc7JiM0NzsgeW91IG5lZWQgdG8gd2FpdCBmb3IgdGhlIG9uUmVhZHkgY2FsbGJhY2sgYmVmb3JlIHVzaW5nIHRoZSBwcm94eQogICAgICAgICAqICZuYnNwOyAmbmJzcDsgcnBjLmZvbyguLi4KICAgICAgICAgKiAmbmJzcDsgfQogICAgICAgICAqIH0sewogICAgICAgICAqICZuYnNwOyBsb2NhbDogey4ufSwKICAgICAgICAgKiAmbmJzcDsgcmVtb3RlOiB7Li59CiAgICAgICAgICogfSk7CiAgICAgICAgICogPC9jb2RlPjwvcHJlPgogICAgICAgICAqCiAgICAgICAgICogPGgyPkV4cG9zaW5nIGZ1bmN0aW9ucyAocHJvY2VkdXJlcyk8L2gyPgogICAgICAgICAqIDxwcmU+PGNvZGU+CiAgICAgICAgICogdmFyIHJwYyA9IG5ldyBlYXN5WERNLlJwYyh7CiAgICAgICAgICogJm5ic3A7IC4uLgogICAgICAgICAqIH0sewogICAgICAgICAqICZuYnNwOyBsb2NhbDogewogICAgICAgICAqICZuYnNwOyAmbmJzcDsgbmFtZU9mTWV0aG9kOiB7CiAgICAgICAgICogJm5ic3A7ICZuYnNwOyAmbmJzcDsgbWV0aG9kOiBmdW5jdGlvbihhcmcxLCBhcmcyLCBzdWNjZXNzLCBlcnJvcil7CiAgICAgICAgICogJm5ic3A7ICZuYnNwOyAmbmJzcDsgJm5ic3A7IC4uLgogICAgICAgICAqICZuYnNwOyAmbmJzcDsgJm5ic3A7IH0KICAgICAgICAgKiAmbmJzcDsgJm5ic3A7IH0sCiAgICAgICAgICogJm5ic3A7ICZuYnNwOyAmIzQ3OyYjNDc7IHdpdGggc2hvcnRoYW5kIG5vdGF0aW9uCiAgICAgICAgICogJm5ic3A7ICZuYnNwOyBuYW1lT2ZBbm90aGVyTWV0aG9kOiAgZnVuY3Rpb24oYXJnMSwgYXJnMiwgc3VjY2VzcywgZXJyb3IpewogICAgICAgICAqICZuYnNwOyAmbmJzcDsgfQogICAgICAgICAqICZuYnNwOyB9LAogICAgICAgICAqICZuYnNwOyByZW1vdGU6IHsuLi59CiAgICAgICAgICogfSk7CiAgICAgICAgICogPC9jb2RlPjwvcHJlPgoKICAgICAgICAgKiBUaGUgZnVuY3Rpb24gcmVmZXJlbmNlZCBieSAgW21ldGhvZF0gd2lsbCByZWNlaXZlIHRoZSBwYXNzZWQgYXJndW1lbnRzIGZvbGxvd2VkIGJ5IHRoZSBjYWxsYmFjayBmdW5jdGlvbnMgPGNvZGU+c3VjY2VzczwvY29kZT4gYW5kIDxjb2RlPmVycm9yPC9jb2RlPi48YnIvPgogICAgICAgICAqIFRvIHNlbmQgYSBzdWNjZXNzZnVsbCByZXN1bHQgYmFjayB5b3UgY2FuIHVzZQogICAgICAgICAqICAgICA8cHJlPjxjb2RlPgogICAgICAgICAqICAgICByZXR1cm4gZm9vOwogICAgICAgICAqICAgICA8L3ByZT48L2NvZGU+CiAgICAgICAgICogb3IKICAgICAgICAgKiAgICAgPHByZT48Y29kZT4KICAgICAgICAgKiAgICAgc3VjY2Vzcyhmb28pOwogICAgICAgICAqICAgICA8L3ByZT48L2NvZGU+CiAgICAgICAgICogIFRvIHJldHVybiBhbiBlcnJvciB5b3UgY2FuIHVzZQogICAgICAgICAqICAgICA8cHJlPjxjb2RlPgogICAgICAgICAqICAgICB0aHJvdyBuZXcgRXJyb3IoImZvbyBlcnJvciIpOwogICAgICAgICAqICAgICA8L2NvZGU+PC9wcmU+CiAgICAgICAgICogb3IKICAgICAgICAgKiAgICAgPHByZT48Y29kZT4KICAgICAgICAgKiAgICAgZXJyb3IoImZvbyBlcnJvciIpOwogICAgICAgICAqICAgICA8L2NvZGU+PC9wcmU+CiAgICAgICAgICoKICAgICAgICAgKiA8aDI+RGVmaW5pbmcgcmVtb3RlbHkgZXhwb3NlZCBtZXRob2RzIChwcm9jZWR1cmVzL25vdGlmaWNhdGlvbnMpPC9oMj4KICAgICAgICAgKiBUaGUgZGVmaW5pdGlvbiBvZiB0aGUgcmVtb3RlIGVuZCBpcyBxdWl0ZSBzaW1pbGFyOgogICAgICAgICAqIDxwcmU+PGNvZGU+CiAgICAgICAgICogdmFyIHJwYyA9IG5ldyBlYXN5WERNLlJwYyh7CiAgICAgICAgICogJm5ic3A7IC4uLgogICAgICAgICAqIH0sewogICAgICAgICAqICZuYnNwOyBsb2NhbDogey4uLn0sCiAgICAgICAgICogJm5ic3A7IHJlbW90ZTogewogICAgICAgICAqICZuYnNwOyAmbmJzcDsgbmFtZU9mTWV0aG9kOiB7fQogICAgICAgICAqICZuYnNwOyB9CiAgICAgICAgICogfSk7CiAgICAgICAgICogPC9jb2RlPjwvcHJlPgogICAgICAgICAqIFRvIGNhbGwgYSByZW1vdGUgbWV0aG9kIHVzZQogICAgICAgICAqIDxwcmU+PGNvZGU+CiAgICAgICAgICogcnBjLm5hbWVPZk1ldGhvZCgiYXJnMSIsICJhcmcyIiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgKiAmbmJzcDsgYWxlcnQoInN1Y2Nlc3M6ICIgKyB2YWx1ZSk7CiAgICAgICAgICogfSwgZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAqICZuYnNwOyBhbGVydCgiZXJyb3I6ICIgKyBtZXNzYWdlICsgKTsKICAgICAgICAgKiB9KTsKICAgICAgICAgKiA8L2NvZGU+PC9wcmU+CiAgICAgICAgICogQm90aCB0aGUgPGNvZGU+c3VjY2VzczwvY29kZT4gYW5kIDxjb2RlPmVycnJvcjwvY29kZT4gY2FsbGJhY2tzIGFyZSBvcHRpb25hbC48YnIvPgogICAgICAgICAqIFdoZW4gY2FsbGVkIHdpdGggbm8gY2FsbGJhY2sgYSBKU09OLVJQQyAyLjAgbm90aWZpY2F0aW9uIHdpbGwgYmUgZXhlY3V0ZWQuCiAgICAgICAgICogQmUgYXdhcmUgdGhhdCB5b3Ugd2lsbCBub3QgYmUgbm90aWZpZWQgb2YgYW55IGVycm9ycyB3aXRoIHRoaXMgbWV0aG9kLgogICAgICAgICAqIDxici8+CiAgICAgICAgICogPGgyPlNwZWNpZnlpbmcgYSBjdXN0b20gc2VyaWFsaXplcjwvaDI+CiAgICAgICAgICogSWYgeW91IGRvIG5vdCB3YW50IHRvIHVzZSB0aGUgSlNPTjIgbGlicmFyeSBmb3Igbm9uLW5hdGl2ZSBKU09OIHN1cHBvcnQsIGJ1dCBpbnN0ZWFkIGNhcGFiaWxpdGllcyBwcm92aWRlZCBieSBzb21lIG90aGVyIGxpYnJhcnkKICAgICAgICAgKiB0aGVuIHlvdSBjYW4gc3BlY2lmeSBhIGN1c3RvbSBzZXJpYWxpemVyIHVzaW5nIDxjb2RlPnNlcmlhbGl6ZXI6IGZvbzwvY29kZT4KICAgICAgICAgKiA8cHJlPjxjb2RlPgogICAgICAgICAqIHZhciBycGMgPSBuZXcgZWFzeVhETS5ScGMoewogICAgICAgICAqICZuYnNwOyAuLi4KICAgICAgICAgKiB9LHsKICAgICAgICAgKiAmbmJzcDsgbG9jYWw6IHsuLi59LAogICAgICAgICAqICZuYnNwOyByZW1vdGU6IHsuLi59LAogICAgICAgICAqICZuYnNwOyBzZXJpYWxpemVyIDogewogICAgICAgICAqICZuYnNwOyAmbmJzcDsgcGFyc2U6IGZ1bmN0aW9uKHN0cmluZyl7IC4uLiB9LAogICAgICAgICAqICZuYnNwOyAmbmJzcDsgc3RyaW5naWZ5OiBmdW5jdGlvbihvYmplY3QpIHsuLi59CiAgICAgICAgICogJm5ic3A7IH0KICAgICAgICAgKiB9KTsKICAgICAgICAgKiA8L2NvZGU+PC9wcmU+CiAgICAgICAgICogSWYgPGNvZGU+c2VyaWFsaXplcjwvY29kZT4gaXMgc2V0IHRoZW4gdGhlIGNsYXNzIHdpbGwgbm90IGF0dGVtcHQgdG8gdXNlIHRoZSBuYXRpdmUgaW1wbGVtZW50YXRpb24uCiAgICAgICAgICogQG5hbWVzcGFjZSBlYXN5WERNCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdW5kZXJseWluZyB0cmFuc3BvcnRzIGNvbmZpZ3VyYXRpb24uIFNlZSBlYXN5WERNLlNvY2tldCBmb3IgYXZhaWxhYmxlIHBhcmFtZXRlcnMuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGpzb25ScGNDb25maWcgVGhlIGRlc2NyaXB0aW9uIG9mIHRoZSBpbnRlcmZhY2UgdG8gaW1wbGVtZW50LgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uUnBjID0gZnVuY3Rpb24oY29uZmlnLCBqc29uUnBjQ29uZmlnKSB7CgogICAgICAgICAgICAvLyBleHBhbmQgc2hvcnRoYW5kIG5vdGF0aW9uCiAgICAgICAgICAgIGlmIChqc29uUnBjQ29uZmlnLmxvY2FsKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBtZXRob2QgaW4ganNvblJwY0NvbmZpZy5sb2NhbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChqc29uUnBjQ29uZmlnLmxvY2FsLmhhc093blByb3BlcnR5KG1ldGhvZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1lbWJlciA9IGpzb25ScGNDb25maWcubG9jYWxbbWV0aG9kXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtZW1iZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpzb25ScGNDb25maWcubG9jYWxbbWV0aG9kXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IG1lbWJlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY3JlYXRlIHRoZSBzdGFjawogICAgICAgICAgICB2YXIgc3RhY2sgPSBjaGFpblN0YWNrKHByZXBhcmVUcmFuc3BvcnRTdGFjayhjb25maWcpLmNvbmNhdChbbmV3IGVhc3lYRE0uc3RhY2suUnBjQmVoYXZpb3IodGhpcywganNvblJwY0NvbmZpZyksIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5vblJlYWR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5vblJlYWR5KHN1Y2Nlc3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV0pKTsKCiAgICAgICAgICAgIC8vIHNldCB0aGUgb3JpZ2luCiAgICAgICAgICAgIHRoaXMub3JpZ2luID0gZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSk7CgoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEluaXRpYXRlcyB0aGUgZGVzdHJ1Y3Rpb24gb2YgdGhlIHN0YWNrLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzdGFjay5kZXN0cm95KCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzdGFjay5pbml0KCk7CiAgICAgICAgfTsKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIGVhc3lYRE0sIHdpbmRvdywgZXNjYXBlLCB1bmVzY2FwZSwgZ2V0TG9jYXRpb24sIGFwcGVuZFF1ZXJ5UGFyYW1ldGVycywgY3JlYXRlRnJhbWUsIGRlYnVnLCB1biwgb24sIGFwcGx5LCB3aGVuUmVhZHksIGdldFBhcmVudE9iamVjdCwgSUZSQU1FX1BSRUZJWCovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLnN0YWNrLlNhbWVPcmlnaW5UcmFuc3BvcnQKICAgICAgICAgKiBTYW1lT3JpZ2luVHJhbnNwb3J0IGlzIGEgdHJhbnNwb3J0IGNsYXNzIHRoYXQgY2FuIGJlIHVzZWQgd2hlbiBib3RoIGRvbWFpbnMgaGF2ZSB0aGUgc2FtZSBvcmlnaW4uPGJyLz4KICAgICAgICAgKiBUaGlzIGNhbiBiZSB1c2VmdWwgZm9yIHRlc3RpbmcgYW5kIGZvciB3aGVuIHRoZSBtYWluIGFwcGxpY2F0aW9uIHN1cHBvcnRzIGJvdGggaW50ZXJuYWwgYW5kIGV4dGVybmFsIHNvdXJjZXMuCiAgICAgICAgICogQG5hbWVzcGFjZSBlYXN5WERNLnN0YWNrCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgdHJhbnNwb3J0cyBjb25maWd1cmF0aW9uLgogICAgICAgICAqIEBjZmcge1N0cmluZ30gcmVtb3RlIFRoZSByZW1vdGUgZG9jdW1lbnQgdG8gY29tbXVuaWNhdGUgd2l0aC4KICAgICAgICAgKi8KICAgICAgICBlYXN5WERNLnN0YWNrLlNhbWVPcmlnaW5UcmFuc3BvcnQgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAgICAgdmFyIHB1YiwgZnJhbWUsIHNlbmQsIHRhcmdldE9yaWdpbjsKCiAgICAgICAgICAgIHJldHVybiAocHViID0gewogICAgICAgICAgICAgICAgb3V0Z29pbmc6IGZ1bmN0aW9uKG1lc3NhZ2UsIGRvbWFpbiwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBzZW5kKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIGlmIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChmcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb25ET01SZWFkeTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0T3JpZ2luID0gZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcuaXNIb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldCB1cCB0aGUgaWZyYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5KGNvbmZpZy5wcm9wcywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjOiBhcHBlbmRRdWVyeVBhcmFtZXRlcnMoY29uZmlnLnJlbW90ZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9lOiBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0ICsgbG9jYXRpb24ucGF0aG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX2M6IGNvbmZpZy5jaGFubmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9wOiA0IC8vIDQgPSBTYW1lT3JpZ2luVHJhbnNwb3J0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IElGUkFNRV9QUkVGSVggKyBjb25maWcuY2hhbm5lbCArICJfcHJvdmlkZXIiCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBmcmFtZSA9IGNyZWF0ZUZyYW1lKGNvbmZpZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE0uRm4uc2V0KGNvbmZpZy5jaGFubmVsLCBmdW5jdGlvbihzZW5kRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmQgPSBzZW5kRm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG1zZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5pbmNvbWluZyhtc2csIHRhcmdldE9yaWdpbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzZW5kID0gZ2V0UGFyZW50T2JqZWN0KCkuRm4uZ2V0KGNvbmZpZy5jaGFubmVsLCB0cnVlKShmdW5jdGlvbihtc2cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5pbmNvbWluZyhtc2csIHRhcmdldE9yaWdpbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgd2hlblJlYWR5KHB1Yi5vbkRPTVJlYWR5LCBwdWIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIC8qanNsaW50IGV2aWw6IHRydWUsIGJyb3dzZXI6IHRydWUsIGltbWVkOiB0cnVlLCBwYXNzZmFpbDogdHJ1ZSwgdW5kZWY6IHRydWUsIG5ld2NhcDogdHJ1ZSovCiAgICAgICAgLypnbG9iYWwgZ2xvYmFsLCBlYXN5WERNLCB3aW5kb3csIGdldExvY2F0aW9uLCBhcHBlbmRRdWVyeVBhcmFtZXRlcnMsIGNyZWF0ZUZyYW1lLCBkZWJ1ZywgYXBwbHksIHdoZW5SZWFkeSwgSUZSQU1FX1BSRUZJWCwgbmFtZXNwYWNlLCByZXNvbHZlVXJsLCBnZXREb21haW5OYW1lLCBIQVNfRkxBU0hfVEhST1RUTEVEX0JVRywgZ2V0UG9ydCwgcXVlcnkqLwogICAgICAgIC8vCiAgICAgICAgLy8gZWFzeVhETQogICAgICAgIC8vIGh0dHA6Ly9lYXN5eGRtLm5ldC8KICAgICAgICAvLyBDb3B5cmlnaHQoYykgMjAwOS0yMDExLCDDmHl2aW5kIFNlYW4gS2luc2V5LCBveXZpbmRAa2luc2V5Lm5vLgogICAgICAgIC8vCiAgICAgICAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogICAgICAgIC8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAgICAgICAgLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogICAgICAgIC8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICAgICAgICAvLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICAgICAgICAvLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgogICAgICAgIC8vCiAgICAgICAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICAgICAgICAvLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAgICAgICAvLwogICAgICAgIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAgICAgICAgLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAgICAgICAgLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAgICAgICAgLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogICAgICAgIC8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAgICAgICAgLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogICAgICAgIC8vIFRIRSBTT0ZUV0FSRS4KICAgICAgICAvLwoKICAgICAgICAvKioKICAgICAgICAgKiBAY2xhc3MgZWFzeVhETS5zdGFjay5GbGFzaFRyYW5zcG9ydAogICAgICAgICAqIEZsYXNoVHJhbnNwb3J0IGlzIGEgdHJhbnNwb3J0IGNsYXNzIHRoYXQgdXNlcyBhbiBTV0Ygd2l0aCBMb2NhbENvbm5lY3Rpb24gdG8gcGFzcyBtZXNzYWdlcyBiYWNrIGFuZCBmb3J0aC4KICAgICAgICAgKiBAbmFtZXNwYWNlIGVhc3lYRE0uc3RhY2sKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSB0cmFuc3BvcnRzIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICogQGNmZyB7U3RyaW5nfSByZW1vdGUgVGhlIHJlbW90ZSBkb21haW4gdG8gY29tbXVuaWNhdGUgd2l0aC4KICAgICAgICAgKiBAY2ZnIHtTdHJpbmd9IHNlY3JldCB0aGUgcHJlLXNoYXJlZCBzZWNyZXQgdXNlZCB0byBzZWN1cmUgdGhlIGNvbW11bmljYXRpb24uCiAgICAgICAgICogQGNmZyB7U3RyaW5nfSBzd2YgVGhlIHBhdGggdG8gdGhlIHN3ZiBmaWxlCiAgICAgICAgICogQGNmZyB7Qm9vbGVhbn0gc3dmTm9UaHJvdHRsZSBTZXQgdGhpcyB0byB0cnVlIGlmIHlvdSB3YW50IHRvIHRha2Ugc3RlcHMgdG8gYXZvaWQgYmVlaW5nIHRocm90dGxlZCB3aGVuIGhpZGRlbi4KICAgICAgICAgKiBAY2ZnIHtTdHJpbmcgfHwgRE9NRWxlbWVudH0gc3dmQ29udGFpbmVyIFNldCB0aGlzIGlmIHlvdSB3YW50IHRvIGNvbnRyb2wgd2hlcmUgdGhlIHN3ZiBpcyBwbGFjZWQKICAgICAgICAgKi8KICAgICAgICBlYXN5WERNLnN0YWNrLkZsYXNoVHJhbnNwb3J0ID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIHZhciBwdWIsIC8vIHRoZSBwdWJsaWMgaW50ZXJmYWNlCiAgICAgICAgICAgICAgICBmcmFtZSwgc2VuZCwgdGFyZ2V0T3JpZ2luLCBzd2YsIHN3ZkNvbnRhaW5lcjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIG9uTWVzc2FnZShtZXNzYWdlLCBvcmlnaW4pIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcHViLnVwLmluY29taW5nKG1lc3NhZ2UsIHRhcmdldE9yaWdpbik7CiAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFRoaXMgbWV0aG9kIGFkZHMgdGhlIFNXRiB0byB0aGUgRE9NIGFuZCBwcmVwYXJlcyB0aGUgaW5pdGlhbGl6YXRpb24gb2YgdGhlIGNoYW5uZWwKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGZ1bmN0aW9uIGFkZFN3Zihkb21haW4pIHsKICAgICAgICAgICAgICAgIC8vIHRoZSBkaWZmZXJlbnRpYXRpbmcgcXVlcnkgYXJndW1lbnQgaXMgbmVlZGVkIGluIEZsYXNoOSB0byBhdm9pZCBhIGNhY2hpbmcgaXNzdWUgd2hlcmUgTG9jYWxDb25uZWN0aW9uIHdvdWxkIHRocm93IGFuIGVycm9yLgogICAgICAgICAgICAgICAgdmFyIHVybCA9IGNvbmZpZy5zd2YgKyAiP2hvc3Q9IiArIGNvbmZpZy5pc0hvc3Q7CiAgICAgICAgICAgICAgICB2YXIgaWQgPSAiZWFzeVhETV9zd2ZfIiArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwMDAwKTsKCiAgICAgICAgICAgICAgICAvLyBwcmVwYXJlIHRoZSBpbml0IGZ1bmN0aW9uIHRoYXQgd2lsbCBmaXJlIG9uY2UgdGhlIHN3ZiBpcyByZWFkeQogICAgICAgICAgICAgICAgZWFzeVhETS5Gbi5zZXQoImZsYXNoX2xvYWRlZCIgKyBkb21haW4ucmVwbGFjZSgvW1wtLl0vZywgIl8iKSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZWFzeVhETS5zdGFjay5GbGFzaFRyYW5zcG9ydFtkb21haW5dLnN3ZiA9IHN3ZiA9IHN3ZkNvbnRhaW5lci5maXJzdENoaWxkOwogICAgICAgICAgICAgICAgICAgIHZhciBxdWV1ZSA9IGVhc3lYRE0uc3RhY2suRmxhc2hUcmFuc3BvcnRbZG9tYWluXS5xdWV1ZTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXVlW2ldKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHF1ZXVlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBpZiAoY29uZmlnLnN3ZkNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHN3ZkNvbnRhaW5lciA9ICh0eXBlb2YgY29uZmlnLnN3ZkNvbnRhaW5lciA9PSAic3RyaW5nIikgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChjb25maWcuc3dmQ29udGFpbmVyKSA6IGNvbmZpZy5zd2ZDb250YWluZXI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUgY29udGFpbmVyIHRoYXQgd2lsbCBob2xkIHRoZSBzd2YKICAgICAgICAgICAgICAgICAgICBzd2ZDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gaHR0cDovL2J1Z3MuYWRvYmUuY29tL2ppcmEvYnJvd3NlL0ZQLTQ3OTYKICAgICAgICAgICAgICAgICAgICAvLyBodHRwOi8vdGVjaC5ncm91cHMueWFob28uY29tL2dyb3VwL2ZsZXhjb2RlcnMvbWVzc2FnZS8xNjIzNjUKICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL2dyb3Vwcy5nb29nbGUuY29tL2ZvcnVtLyMhdG9waWMvZWFzeXhkbS9tSlpKaFdhZ29MYwogICAgICAgICAgICAgICAgICAgIGFwcGx5KHN3ZkNvbnRhaW5lci5zdHlsZSwgSEFTX0ZMQVNIX1RIUk9UVExFRF9CVUcgJiYgY29uZmlnLnN3Zk5vVGhyb3R0bGUgPyB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogIjIwcHgiLAogICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogIjIwcHgiLAogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogImZpeGVkIiwKICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHQ6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogMAogICAgICAgICAgICAgICAgICAgIH0gOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogIjFweCIsCiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAiMXB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJmbG93OiAiaGlkZGVuIiwKICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHQ6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogMAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc3dmQ29udGFpbmVyKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIG9iamVjdC9lbWJlZAogICAgICAgICAgICAgICAgdmFyIGZsYXNoVmFycyA9ICJjYWxsYmFjaz1mbGFzaF9sb2FkZWQiICsgZG9tYWluLnJlcGxhY2UoL1tcLS5dL2csICJfIikgKyAiJnByb3RvPSIgKyBnbG9iYWwubG9jYXRpb24ucHJvdG9jb2wgKyAiJmRvbWFpbj0iICsgZ2V0RG9tYWluTmFtZShnbG9iYWwubG9jYXRpb24uaHJlZikgKyAiJnBvcnQ9IiArIGdldFBvcnQoZ2xvYmFsLmxvY2F0aW9uLmhyZWYpICsgIiZucz0iICsgbmFtZXNwYWNlOwogICAgICAgICAgICAgICAgc3dmQ29udGFpbmVyLmlubmVySFRNTCA9ICI8b2JqZWN0IGhlaWdodD0nMjAnIHdpZHRoPScyMCcgdHlwZT0nYXBwbGljYXRpb24veC1zaG9ja3dhdmUtZmxhc2gnIGlkPSciICsgaWQgKyAiJyBkYXRhPSciICsgdXJsICsgIic+IiArCiAgICAgICAgICAgICAgICAgICAgIjxwYXJhbSBuYW1lPSdhbGxvd1NjcmlwdEFjY2VzcycgdmFsdWU9J2Fsd2F5cyc+PC9wYXJhbT4iICsKICAgICAgICAgICAgICAgICAgICAiPHBhcmFtIG5hbWU9J3dtb2RlJyB2YWx1ZT0ndHJhbnNwYXJlbnQnPiIgKwogICAgICAgICAgICAgICAgICAgICI8cGFyYW0gbmFtZT0nbW92aWUnIHZhbHVlPSciICsKICAgICAgICAgICAgICAgICAgICB1cmwgKwogICAgICAgICAgICAgICAgICAgICInPjwvcGFyYW0+IiArCiAgICAgICAgICAgICAgICAgICAgIjxwYXJhbSBuYW1lPSdmbGFzaHZhcnMnIHZhbHVlPSciICsKICAgICAgICAgICAgICAgICAgICBmbGFzaFZhcnMgKwogICAgICAgICAgICAgICAgICAgICInPjwvcGFyYW0+IiArCiAgICAgICAgICAgICAgICAgICAgIjxlbWJlZCB0eXBlPSdhcHBsaWNhdGlvbi94LXNob2Nrd2F2ZS1mbGFzaCcgRmxhc2hWYXJzPSciICsKICAgICAgICAgICAgICAgICAgICBmbGFzaFZhcnMgKwogICAgICAgICAgICAgICAgICAgICInIGFsbG93U2NyaXB0QWNjZXNzPSdhbHdheXMnIHdtb2RlPSd0cmFuc3BhcmVudCcgc3JjPSciICsKICAgICAgICAgICAgICAgICAgICB1cmwgKwogICAgICAgICAgICAgICAgICAgICInIGhlaWdodD0nMScgd2lkdGg9JzEnPjwvZW1iZWQ+IiArCiAgICAgICAgICAgICAgICAgICAgIjwvb2JqZWN0PiI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAocHViID0gewogICAgICAgICAgICAgICAgb3V0Z29pbmc6IGZ1bmN0aW9uKG1lc3NhZ2UsIGRvbWFpbiwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBzd2YucG9zdE1lc3NhZ2UoY29uZmlnLmNoYW5uZWwsIG1lc3NhZ2UudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3Zi5kZXN0cm95Q2hhbm5lbChjb25maWcuY2hhbm5lbCk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgICAgICAgICBzd2YgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmIChmcmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBmcmFtZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBvbkRPTVJlYWR5OiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0T3JpZ2luID0gY29uZmlnLnJlbW90ZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gUHJlcGFyZSB0aGUgY29kZSB0aGF0IHdpbGwgYmUgcnVuIGFmdGVyIHRoZSBzd2YgaGFzIGJlZW4gaW50aWFsaXplZAogICAgICAgICAgICAgICAgICAgIGVhc3lYRE0uRm4uc2V0KCJmbGFzaF8iICsgY29uZmlnLmNoYW5uZWwgKyAiX2luaXQiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIHNldCB1cCB0aGUgb21NZXNzYWdlIGhhbmRsZXIKICAgICAgICAgICAgICAgICAgICBlYXN5WERNLkZuLnNldCgiZmxhc2hfIiArIGNvbmZpZy5jaGFubmVsICsgIl9vbk1lc3NhZ2UiLCBvbk1lc3NhZ2UpOwoKICAgICAgICAgICAgICAgICAgICBjb25maWcuc3dmID0gcmVzb2x2ZVVybChjb25maWcuc3dmKTsgLy8gcmVwb3J0cyBoYXZlIGJlZW4gbWFkZSBvZiByZXF1ZXN0cyBnb25lIHJvZ3VlIHdoZW4gdXNpbmcgcmVsYXRpdmUgcGF0aHMKICAgICAgICAgICAgICAgICAgICB2YXIgc3dmZG9tYWluID0gZ2V0RG9tYWluTmFtZShjb25maWcuc3dmKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZm4gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IGluaXQgdG8gdHJ1ZSBpbiBjYXNlIHRoZSBmbiB3YXMgY2FsbGVkIHdhcyBpbnZva2VkIGZyb20gYSBzZXBhcmF0ZSBpbnN0YW5jZQogICAgICAgICAgICAgICAgICAgICAgICBlYXN5WERNLnN0YWNrLkZsYXNoVHJhbnNwb3J0W3N3ZmRvbWFpbl0uaW5pdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3ZiA9IGVhc3lYRE0uc3RhY2suRmxhc2hUcmFuc3BvcnRbc3dmZG9tYWluXS5zd2Y7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUgY2hhbm5lbAogICAgICAgICAgICAgICAgICAgICAgICBzd2YuY3JlYXRlQ2hhbm5lbChjb25maWcuY2hhbm5lbCwgY29uZmlnLnNlY3JldCwgZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSksIGNvbmZpZy5pc0hvc3QpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5pc0hvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIEZsYXNoIGlzIGdvaW5nIHRvIGJlIHRocm90dGxlZCBhbmQgd2Ugd2FudCB0byBhdm9pZCB0aGlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoSEFTX0ZMQVNIX1RIUk9UVExFRF9CVUcgJiYgY29uZmlnLnN3Zk5vVGhyb3R0bGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBseShjb25maWcucHJvcHMsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJmaXhlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogIjIwcHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogIjIwcHgiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXQgdXAgdGhlIGlmcmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHkoY29uZmlnLnByb3BzLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjOiBhcHBlbmRRdWVyeVBhcmFtZXRlcnMoY29uZmlnLnJlbW90ZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ZG1fZTogZ2V0TG9jYXRpb24obG9jYXRpb24uaHJlZiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9jOiBjb25maWcuY2hhbm5lbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX3A6IDYsIC8vIDYgPSBGbGFzaFRyYW5zcG9ydAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ZG1fczogY29uZmlnLnNlY3JldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IElGUkFNRV9QUkVGSVggKyBjb25maWcuY2hhbm5lbCArICJfcHJvdmlkZXIiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lID0gY3JlYXRlRnJhbWUoY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGlmIChlYXN5WERNLnN0YWNrLkZsYXNoVHJhbnNwb3J0W3N3ZmRvbWFpbl0gJiYgZWFzeVhETS5zdGFjay5GbGFzaFRyYW5zcG9ydFtzd2Zkb21haW5dLmluaXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHN3ZiBpcyBpbiBwbGFjZSBhbmQgd2UgYXJlIHRoZSBjb25zdW1lcgogICAgICAgICAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBzd2YgZG9lcyBub3QgeWV0IGV4aXN0CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZWFzeVhETS5zdGFjay5GbGFzaFRyYW5zcG9ydFtzd2Zkb21haW5dKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGQgdGhlIHF1ZXVlIHRvIGhvbGQgdGhlIGluaXQgZm4ncwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWFzeVhETS5zdGFjay5GbGFzaFRyYW5zcG9ydFtzd2Zkb21haW5dID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXVlOiBbZm5dCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkU3dmKHN3ZmRvbWFpbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlYXN5WERNLnN0YWNrLkZsYXNoVHJhbnNwb3J0W3N3ZmRvbWFpbl0ucXVldWUucHVzaChmbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgd2hlblJlYWR5KHB1Yi5vbkRPTVJlYWR5LCBwdWIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIC8qanNsaW50IGV2aWw6IHRydWUsIGJyb3dzZXI6IHRydWUsIGltbWVkOiB0cnVlLCBwYXNzZmFpbDogdHJ1ZSwgdW5kZWY6IHRydWUsIG5ld2NhcDogdHJ1ZSovCiAgICAgICAgLypnbG9iYWwgZWFzeVhETSwgd2luZG93LCBlc2NhcGUsIHVuZXNjYXBlLCBnZXRMb2NhdGlvbiwgYXBwZW5kUXVlcnlQYXJhbWV0ZXJzLCBjcmVhdGVGcmFtZSwgZGVidWcsIHVuLCBvbiwgYXBwbHksIHdoZW5SZWFkeSwgSUZSQU1FX1BSRUZJWCovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLnN0YWNrLlBvc3RNZXNzYWdlVHJhbnNwb3J0CiAgICAgICAgICogUG9zdE1lc3NhZ2VUcmFuc3BvcnQgaXMgYSB0cmFuc3BvcnQgY2xhc3MgdGhhdCB1c2VzIEhUTUw1IHBvc3RNZXNzYWdlIGZvciBjb21tdW5pY2F0aW9uLjxici8+CiAgICAgICAgICogPGEgaHJlZj0iaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNjQ0OTQ0KFZTLjg1KS5hc3B4Ij5odHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM2NDQ5NDQoVlMuODUpLmFzcHg8L2E+PGJyLz4KICAgICAgICAgKiA8YSBocmVmPSJodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9ET00vd2luZG93LnBvc3RNZXNzYWdlIj5odHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9ET00vd2luZG93LnBvc3RNZXNzYWdlPC9hPgogICAgICAgICAqIEBuYW1lc3BhY2UgZWFzeVhETS5zdGFjawogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHRyYW5zcG9ydHMgY29uZmlndXJhdGlvbi4KICAgICAgICAgKiBAY2ZnIHtTdHJpbmd9IHJlbW90ZSBUaGUgcmVtb3RlIGRvbWFpbiB0byBjb21tdW5pY2F0ZSB3aXRoLgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uc3RhY2suUG9zdE1lc3NhZ2VUcmFuc3BvcnQgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAgICAgdmFyIHB1YiwgLy8gdGhlIHB1YmxpYyBpbnRlcmZhY2UKICAgICAgICAgICAgICAgIGZyYW1lLCAvLyB0aGUgcmVtb3RlIGZyYW1lLCBpZiBhbnkKICAgICAgICAgICAgICAgIGNhbGxlcldpbmRvdywgLy8gdGhlIHdpbmRvdyB0aGF0IHdlIHdpbGwgY2FsbCB3aXRoCiAgICAgICAgICAgICAgICB0YXJnZXRPcmlnaW47IC8vIHRoZSBkb21haW4gdG8gY29tbXVuaWNhdGUgd2l0aAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUmVzb2x2ZXMgdGhlIG9yaWdpbiBmcm9tIHRoZSBldmVudCBvYmplY3QKICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IFRoZSBtZXNzYWdlZXZlbnQKICAgICAgICAgICAgICogQHJldHVybiB7U3RyaW5nfSBUaGUgc2NoZW1lLCBob3N0IGFuZCBwb3J0IG9mIHRoZSBvcmlnaW4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGZ1bmN0aW9uIF9nZXRPcmlnaW4oZXZlbnQpIHsKICAgICAgICAgICAgICAgIGlmIChldmVudC5vcmlnaW4pIHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBIVE1MNSBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRMb2NhdGlvbihldmVudC5vcmlnaW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV2ZW50LnVyaSkgewogICAgICAgICAgICAgICAgICAgIC8vIEZyb20gZWFybGllciBpbXBsZW1lbnRhdGlvbnMKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0TG9jYXRpb24oZXZlbnQudXJpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChldmVudC5kb21haW4pIHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBsYXN0IG9wdGlvbiBhbmQgd2lsbCBmYWlsIGlmIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIG9yaWdpbiBpcyBub3QgdXNpbmcgdGhlIHNhbWUgc2NoZW1hIGFzIHdlIGFyZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBldmVudC5kb21haW47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aHJvdyAiVW5hYmxlIHRvIHJldHJpZXZlIHRoZSBvcmlnaW4gb2YgdGhlIGV2ZW50IjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFRoaXMgaXMgdGhlIG1haW4gaW1wbGVtZW50YXRpb24gZm9yIHRoZSBvbk1lc3NhZ2UgZXZlbnQuPGJyLz4KICAgICAgICAgICAgICogSXQgY2hlY2tzIHRoZSB2YWxpZGl0eSBvZiB0aGUgb3JpZ2luIGFuZCBwYXNzZXMgdGhlIG1lc3NhZ2Ugb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBUaGUgbWVzc2FnZWV2ZW50CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiBfd2luZG93X29uTWVzc2FnZShldmVudCkgewogICAgICAgICAgICAgICAgdmFyIG9yaWdpbiA9IF9nZXRPcmlnaW4oZXZlbnQpOwogICAgICAgICAgICAgICAgaWYgKG9yaWdpbiA9PSB0YXJnZXRPcmlnaW4gJiYgZXZlbnQuZGF0YS5zdWJzdHJpbmcoMCwgY29uZmlnLmNoYW5uZWwubGVuZ3RoICsgMSkgPT0gY29uZmlnLmNoYW5uZWwgKyAiICIpIHsKICAgICAgICAgICAgICAgICAgICBwdWIudXAuaW5jb21pbmcoZXZlbnQuZGF0YS5zdWJzdHJpbmcoY29uZmlnLmNoYW5uZWwubGVuZ3RoICsgMSksIG9yaWdpbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAocHViID0gewogICAgICAgICAgICAgICAgb3V0Z29pbmc6IGZ1bmN0aW9uKG1lc3NhZ2UsIGRvbWFpbiwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBjYWxsZXJXaW5kb3cucG9zdE1lc3NhZ2UoY29uZmlnLmNoYW5uZWwgKyAiICIgKyBtZXNzYWdlLCBkb21haW4gfHwgdGFyZ2V0T3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdW4od2luZG93LCAibWVzc2FnZSIsIF93aW5kb3dfb25NZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGVyV2luZG93ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChmcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb25ET01SZWFkeTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0T3JpZ2luID0gZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5pc0hvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWRkIHRoZSBldmVudCBoYW5kbGVyIGZvciBsaXN0ZW5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHdhaXRGb3JSZWFkeSA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuZGF0YSA9PSBjb25maWcuY2hhbm5lbCArICItcmVhZHkiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVwbGFjZSB0aGUgZXZlbnRsaXN0ZW5lcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxlcldpbmRvdyA9ICgicG9zdE1lc3NhZ2UiIGluIGZyYW1lLmNvbnRlbnRXaW5kb3cpID8gZnJhbWUuY29udGVudFdpbmRvdyA6IGZyYW1lLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW4od2luZG93LCAibWVzc2FnZSIsIHdhaXRGb3JSZWFkeSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb24od2luZG93LCAibWVzc2FnZSIsIF93aW5kb3dfb25NZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWIudXAuY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIG9uKHdpbmRvdywgIm1lc3NhZ2UiLCB3YWl0Rm9yUmVhZHkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IHVwIHRoZSBpZnJhbWUKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHkoY29uZmlnLnByb3BzLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmM6IGFwcGVuZFF1ZXJ5UGFyYW1ldGVycyhjb25maWcucmVtb3RlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX2U6IGdldExvY2F0aW9uKGxvY2F0aW9uLmhyZWYpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9jOiBjb25maWcuY2hhbm5lbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ZG1fcDogMSAvLyAxID0gUG9zdE1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogSUZSQU1FX1BSRUZJWCArIGNvbmZpZy5jaGFubmVsICsgIl9wcm92aWRlciIKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lID0gY3JlYXRlRnJhbWUoY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGQgdGhlIGV2ZW50IGhhbmRsZXIgZm9yIGxpc3RlbmluZwogICAgICAgICAgICAgICAgICAgICAgICBvbih3aW5kb3csICJtZXNzYWdlIiwgX3dpbmRvd19vbk1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICBjYWxsZXJXaW5kb3cgPSAoInBvc3RNZXNzYWdlIiBpbiB3aW5kb3cucGFyZW50KSA/IHdpbmRvdy5wYXJlbnQgOiB3aW5kb3cucGFyZW50LmRvY3VtZW50OwogICAgICAgICAgICAgICAgICAgICAgICBjYWxsZXJXaW5kb3cucG9zdE1lc3NhZ2UoY29uZmlnLmNoYW5uZWwgKyAiLXJlYWR5IiwgdGFyZ2V0T3JpZ2luKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWIudXAuY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB3aGVuUmVhZHkocHViLm9uRE9NUmVhZHksIHB1Yik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgLypqc2xpbnQgZXZpbDogdHJ1ZSwgYnJvd3NlcjogdHJ1ZSwgaW1tZWQ6IHRydWUsIHBhc3NmYWlsOiB0cnVlLCB1bmRlZjogdHJ1ZSwgbmV3Y2FwOiB0cnVlKi8KICAgICAgICAvKmdsb2JhbCBlYXN5WERNLCB3aW5kb3csIGVzY2FwZSwgdW5lc2NhcGUsIGdldExvY2F0aW9uLCBhcHBlbmRRdWVyeVBhcmFtZXRlcnMsIGNyZWF0ZUZyYW1lLCBkZWJ1ZywgYXBwbHksIHF1ZXJ5LCB3aGVuUmVhZHksIElGUkFNRV9QUkVGSVgqLwogICAgICAgIC8vCiAgICAgICAgLy8gZWFzeVhETQogICAgICAgIC8vIGh0dHA6Ly9lYXN5eGRtLm5ldC8KICAgICAgICAvLyBDb3B5cmlnaHQoYykgMjAwOS0yMDExLCDDmHl2aW5kIFNlYW4gS2luc2V5LCBveXZpbmRAa2luc2V5Lm5vLgogICAgICAgIC8vCiAgICAgICAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogICAgICAgIC8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAgICAgICAgLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogICAgICAgIC8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICAgICAgICAvLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICAgICAgICAvLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgogICAgICAgIC8vCiAgICAgICAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICAgICAgICAvLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAgICAgICAvLwogICAgICAgIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAgICAgICAgLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAgICAgICAgLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAgICAgICAgLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogICAgICAgIC8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAgICAgICAgLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogICAgICAgIC8vIFRIRSBTT0ZUV0FSRS4KICAgICAgICAvLwoKICAgICAgICAvKioKICAgICAgICAgKiBAY2xhc3MgZWFzeVhETS5zdGFjay5GcmFtZUVsZW1lbnRUcmFuc3BvcnQKICAgICAgICAgKiBGcmFtZUVsZW1lbnRUcmFuc3BvcnQgaXMgYSB0cmFuc3BvcnQgY2xhc3MgdGhhdCBjYW4gYmUgdXNlZCB3aXRoIEdlY2tvLWJyb3dzZXIgYXMgdGhlc2UgYWxsb3cgcGFzc2luZyB2YXJpYWJsZXMgdXNpbmcgdGhlIGZyYW1lRWxlbWVudCBwcm9wZXJ0eS48YnIvPgogICAgICAgICAqIFNlY3VyaXR5IGlzIG1haW50YWluZWQgYXMgR2VjaG8gdXNlcyBMZXhpY2FsIEF1dGhvcml6YXRpb24gdG8gZGV0ZXJtaW5lIHVuZGVyIHdoaWNoIHNjb3BlIGEgZnVuY3Rpb24gaXMgcnVubmluZy4KICAgICAgICAgKiBAbmFtZXNwYWNlIGVhc3lYRE0uc3RhY2sKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSB0cmFuc3BvcnRzIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICogQGNmZyB7U3RyaW5nfSByZW1vdGUgVGhlIHJlbW90ZSBkb2N1bWVudCB0byBjb21tdW5pY2F0ZSB3aXRoLgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uc3RhY2suRnJhbWVFbGVtZW50VHJhbnNwb3J0ID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIHZhciBwdWIsIGZyYW1lLCBzZW5kLCB0YXJnZXRPcmlnaW47CgogICAgICAgICAgICByZXR1cm4gKHB1YiA9IHsKICAgICAgICAgICAgICAgIG91dGdvaW5nOiBmdW5jdGlvbihtZXNzYWdlLCBkb21haW4sIGZuKSB7CiAgICAgICAgICAgICAgICAgICAgc2VuZC5jYWxsKHRoaXMsIG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIGlmIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChmcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb25ET01SZWFkeTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0T3JpZ2luID0gZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcuaXNIb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldCB1cCB0aGUgaWZyYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5KGNvbmZpZy5wcm9wcywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjOiBhcHBlbmRRdWVyeVBhcmFtZXRlcnMoY29uZmlnLnJlbW90ZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9lOiBnZXRMb2NhdGlvbihsb2NhdGlvbi5ocmVmKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ZG1fYzogY29uZmlnLmNoYW5uZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX3A6IDUgLy8gNSA9IEZyYW1lRWxlbWVudFRyYW5zcG9ydAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBJRlJBTUVfUFJFRklYICsgY29uZmlnLmNoYW5uZWwgKyAiX3Byb3ZpZGVyIgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUgPSBjcmVhdGVGcmFtZShjb25maWcpOwogICAgICAgICAgICAgICAgICAgICAgICBmcmFtZS5mbiA9IGZ1bmN0aW9uKHNlbmRGbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGZyYW1lLmZuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZCA9IHNlbmRGbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIGZ1bmN0aW9uIHNvIHRoYXQgaXQgY2Fubm90IGJlIHVzZWQgdG8gb3ZlcndyaXRlIHRoZSBzZW5kIGZ1bmN0aW9uIGxhdGVyIG9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24obXNnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmluY29taW5nKG1zZywgdGFyZ2V0T3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyB0byBtaXRpZ2F0ZSBvcmlnaW4tc3Bvb2ZpbmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LnJlZmVycmVyICYmIGdldExvY2F0aW9uKGRvY3VtZW50LnJlZmVycmVyKSAhPSBxdWVyeS54ZG1fZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LnRvcC5sb2NhdGlvbiA9IHF1ZXJ5LnhkbV9lOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmQgPSB3aW5kb3cuZnJhbWVFbGVtZW50LmZuKGZ1bmN0aW9uKG1zZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmluY29taW5nKG1zZywgdGFyZ2V0T3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgd2hlblJlYWR5KHB1Yi5vbkRPTVJlYWR5LCBwdWIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIC8qanNsaW50IGV2aWw6IHRydWUsIGJyb3dzZXI6IHRydWUsIGltbWVkOiB0cnVlLCBwYXNzZmFpbDogdHJ1ZSwgdW5kZWY6IHRydWUsIG5ld2NhcDogdHJ1ZSovCiAgICAgICAgLypnbG9iYWwgZWFzeVhETSwgd2luZG93LCBlc2NhcGUsIHVuZXNjYXBlLCB1bmRlZiwgZ2V0TG9jYXRpb24sIGFwcGVuZFF1ZXJ5UGFyYW1ldGVycywgcmVzb2x2ZVVybCwgY3JlYXRlRnJhbWUsIGRlYnVnLCB1biwgYXBwbHksIHdoZW5SZWFkeSwgSUZSQU1FX1BSRUZJWCovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLnN0YWNrLk5hbWVUcmFuc3BvcnQKICAgICAgICAgKiBOYW1lVHJhbnNwb3J0IHVzZXMgdGhlIHdpbmRvdy5uYW1lIHByb3BlcnR5IHRvIHJlbGF5IGRhdGEuCiAgICAgICAgICogVGhlIDxjb2RlPmxvY2FsPC9jb2RlPiBwYXJhbWV0ZXIgbmVlZHMgdG8gYmUgc2V0IG9uIGJvdGggdGhlIGNvbnN1bWVyIGFuZCBwcm92aWRlciw8YnIvPgogICAgICAgICAqIGFuZCB0aGUgPGNvZGU+cmVtb3RlSGVscGVyPC9jb2RlPiBwYXJhbWV0ZXIgbmVlZHMgdG8gYmUgc2V0IG9uIHRoZSBjb25zdW1lci4KICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSB0cmFuc3BvcnRzIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICogQGNmZyB7U3RyaW5nfSByZW1vdGVIZWxwZXIgVGhlIHVybCB0byB0aGUgcmVtb3RlIGluc3RhbmNlIG9mIGhhc2guaHRtbCAtIHRoaXMgaXMgb25seSBuZWVkZWQgZm9yIHRoZSBob3N0LgogICAgICAgICAqIEBuYW1lc3BhY2UgZWFzeVhETS5zdGFjawogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uc3RhY2suTmFtZVRyYW5zcG9ydCA9IGZ1bmN0aW9uKGNvbmZpZykgewoKICAgICAgICAgICAgdmFyIHB1YjsgLy8gdGhlIHB1YmxpYyBpbnRlcmZhY2UKICAgICAgICAgICAgdmFyIGlzSG9zdCwgY2FsbGVyV2luZG93LCByZW1vdGVXaW5kb3csIHJlYWR5Q291bnQsIGNhbGxiYWNrLCByZW1vdGVPcmlnaW4sIHJlbW90ZVVybDsKCiAgICAgICAgICAgIGZ1bmN0aW9uIF9zZW5kTWVzc2FnZShtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICB2YXIgdXJsID0gY29uZmlnLnJlbW90ZUhlbHBlciArIChpc0hvc3QgPyAiI18zIiA6ICIjXzIiKSArIGNvbmZpZy5jaGFubmVsOwogICAgICAgICAgICAgICAgY2FsbGVyV2luZG93LmNvbnRlbnRXaW5kb3cuc2VuZE1lc3NhZ2UobWVzc2FnZSwgdXJsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gX29uUmVhZHkoKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNIb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCsrcmVhZHlDb3VudCA9PT0gMiB8fCAhaXNIb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9zZW5kTWVzc2FnZSgicmVhZHkiKTsKICAgICAgICAgICAgICAgICAgICBwdWIudXAuY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIF9vbk1lc3NhZ2UobWVzc2FnZSkgewogICAgICAgICAgICAgICAgcHViLnVwLmluY29taW5nKG1lc3NhZ2UsIHJlbW90ZU9yaWdpbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIF9vbkxvYWQoKSB7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIChwdWIgPSB7CiAgICAgICAgICAgICAgICBvdXRnb2luZzogZnVuY3Rpb24obWVzc2FnZSwgZG9tYWluLCBmbikgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZm47CiAgICAgICAgICAgICAgICAgICAgX3NlbmRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGNhbGxlcldpbmRvdy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGNhbGxlcldpbmRvdyk7CiAgICAgICAgICAgICAgICAgICAgY2FsbGVyV2luZG93ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNIb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW90ZVdpbmRvdy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJlbW90ZVdpbmRvdyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW90ZVdpbmRvdyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG9uRE9NUmVhZHk6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlzSG9zdCA9IGNvbmZpZy5pc0hvc3Q7CiAgICAgICAgICAgICAgICAgICAgcmVhZHlDb3VudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgcmVtb3RlT3JpZ2luID0gZ2V0TG9jYXRpb24oY29uZmlnLnJlbW90ZSk7CiAgICAgICAgICAgICAgICAgICAgY29uZmlnLmxvY2FsID0gcmVzb2x2ZVVybChjb25maWcubG9jYWwpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNIb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlZ2lzdGVyIHRoZSBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgICAgICBlYXN5WERNLkZuLnNldChjb25maWcuY2hhbm5lbCwgZnVuY3Rpb24obWVzc2FnZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzSG9zdCAmJiBtZXNzYWdlID09PSAicmVhZHkiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVwbGFjZSB0aGUgaGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE0uRm4uc2V0KGNvbmZpZy5jaGFubmVsLCBfb25NZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfb25SZWFkeSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB1cCB0aGUgZnJhbWUgdGhhdCBwb2ludHMgdG8gdGhlIHJlbW90ZSBpbnN0YW5jZQogICAgICAgICAgICAgICAgICAgICAgICByZW1vdGVVcmwgPSBhcHBlbmRRdWVyeVBhcmFtZXRlcnMoY29uZmlnLnJlbW90ZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeGRtX2U6IGNvbmZpZy5sb2NhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9jOiBjb25maWcuY2hhbm5lbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhkbV9wOiAyCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBhcHBseShjb25maWcucHJvcHMsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogcmVtb3RlVXJsICsgJyMnICsgY29uZmlnLmNoYW5uZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBJRlJBTUVfUFJFRklYICsgY29uZmlnLmNoYW5uZWwgKyAiX3Byb3ZpZGVyIgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3RlV2luZG93ID0gY3JlYXRlRnJhbWUoY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjb25maWcucmVtb3RlSGVscGVyID0gY29uZmlnLnJlbW90ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZWFzeVhETS5Gbi5zZXQoY29uZmlnLmNoYW5uZWwsIF9vbk1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU2V0IHVwIHRoZSBpZnJhbWUgdGhhdCB3aWxsIGJlIHVzZWQgZm9yIHRoZSB0cmFuc3BvcnQKICAgICAgICAgICAgICAgICAgICB2YXIgb25Mb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgaGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdyA9IGNhbGxlcldpbmRvdyB8fCB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICB1bih3LCAibG9hZCIsIG9uTG9hZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE0uRm4uc2V0KGNvbmZpZy5jaGFubmVsICsgIl9sb2FkIiwgX29uTG9hZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiB0ZXN0KCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB3LmNvbnRlbnRXaW5kb3cuc2VuZE1lc3NhZ2UgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9vblJlYWR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQodGVzdCwgNTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KCkpOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGNhbGxlcldpbmRvdyA9IGNyZWF0ZUZyYW1lKHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogY29uZmlnLmxvY2FsICsgIiNfNCIgKyBjb25maWcuY2hhbm5lbAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBvbkxvYWQ6IG9uTG9hZAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHdoZW5SZWFkeShwdWIub25ET01SZWFkeSwgcHViKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIGVhc3lYRE0sIHdpbmRvdywgZXNjYXBlLCB1bmVzY2FwZSwgZ2V0TG9jYXRpb24sIGNyZWF0ZUZyYW1lLCBkZWJ1ZywgdW4sIG9uLCBhcHBseSwgd2hlblJlYWR5LCBJRlJBTUVfUFJFRklYKi8KICAgICAgICAvLwogICAgICAgIC8vIGVhc3lYRE0KICAgICAgICAvLyBodHRwOi8vZWFzeXhkbS5uZXQvCiAgICAgICAgLy8gQ29weXJpZ2h0KGMpIDIwMDktMjAxMSwgw5h5dmluZCBTZWFuIEtpbnNleSwgb3l2aW5kQGtpbnNleS5uby4KICAgICAgICAvLwogICAgICAgIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICAgICAgICAvLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogICAgICAgIC8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICAgICAgICAvLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAgICAgICAgLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAgICAgICAgLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAgICAgICAvLwogICAgICAgIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAgICAgICAgLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgICAgICAgLy8KICAgICAgICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogICAgICAgIC8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogICAgICAgIC8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogICAgICAgIC8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICAgICAgICAvLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogICAgICAgIC8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICAgICAgICAvLyBUSEUgU09GVFdBUkUuCiAgICAgICAgLy8KCiAgICAgICAgLyoqCiAgICAgICAgICogQGNsYXNzIGVhc3lYRE0uc3RhY2suSGFzaFRyYW5zcG9ydAogICAgICAgICAqIEhhc2hUcmFuc3BvcnQgaXMgYSB0cmFuc3BvcnQgY2xhc3MgdGhhdCB1c2VzIHRoZSBJRnJhbWUgVVJMIFRlY2huaXF1ZSBmb3IgY29tbXVuaWNhdGlvbi48YnIvPgogICAgICAgICAqIDxhIGhyZWY9Imh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9iYjczNTMwNS5hc3B4Ij5odHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvYmI3MzUzMDUuYXNweDwvYT48YnIvPgogICAgICAgICAqIEBuYW1lc3BhY2UgZWFzeVhETS5zdGFjawogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHRyYW5zcG9ydHMgY29uZmlndXJhdGlvbi4KICAgICAgICAgKiBAY2ZnIHtTdHJpbmcvV2luZG93fSBsb2NhbCBUaGUgdXJsIHRvIHRoZSBsb2NhbCBmaWxlIHVzZWQgZm9yIHByb3h5aW5nIG1lc3NhZ2VzLCBvciB0aGUgbG9jYWwgd2luZG93LgogICAgICAgICAqIEBjZmcge051bWJlcn0gZGVsYXkgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgZWFzeVhETSBzaG91bGQgdHJ5IHRvIGdldCBhIHJlZmVyZW5jZSB0byB0aGUgbG9jYWwgd2luZG93LgogICAgICAgICAqIEBjZmcge051bWJlcn0gaW50ZXJ2YWwgVGhlIGludGVydmFsIHVzZWQgd2hlbiBwb2xsaW5nIGZvciBtZXNzYWdlcy4KICAgICAgICAgKi8KICAgICAgICBlYXN5WERNLnN0YWNrLkhhc2hUcmFuc3BvcnQgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAgICAgdmFyIHB1YjsKICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgICAgIGlzSG9zdCwgX3RpbWVyLCBwb2xsSW50ZXJ2YWwsIF9sYXN0TXNnLCBfbXNnTnIsIF9saXN0ZW5lcldpbmRvdywgX2NhbGxlcldpbmRvdzsKICAgICAgICAgICAgdmFyIHVzZVBhcmVudCwgX3JlbW90ZU9yaWdpbjsKCiAgICAgICAgICAgIGZ1bmN0aW9uIF9zZW5kTWVzc2FnZShtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICBpZiAoIV9jYWxsZXJXaW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdXJsID0gY29uZmlnLnJlbW90ZSArICIjIiArIChfbXNnTnIrKykgKyAiXyIgKyBtZXNzYWdlOwogICAgICAgICAgICAgICAgKChpc0hvc3QgfHwgIXVzZVBhcmVudCkgPyBfY2FsbGVyV2luZG93LmNvbnRlbnRXaW5kb3cgOiBfY2FsbGVyV2luZG93KS5sb2NhdGlvbiA9IHVybDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gX2hhbmRsZUhhc2goaGFzaCkgewogICAgICAgICAgICAgICAgX2xhc3RNc2cgPSBoYXNoOwogICAgICAgICAgICAgICAgcHViLnVwLmluY29taW5nKF9sYXN0TXNnLnN1YnN0cmluZyhfbGFzdE1zZy5pbmRleE9mKCJfIikgKyAxKSwgX3JlbW90ZU9yaWdpbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDaGVja3MgbG9jYXRpb24uaGFzaCBmb3IgYSBuZXcgbWVzc2FnZSBhbmQgcmVsYXlzIHRoaXMgdG8gdGhlIHJlY2VpdmVyLgogICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gX3BvbGxIYXNoKCkgewogICAgICAgICAgICAgICAgaWYgKCFfbGlzdGVuZXJXaW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgaHJlZiA9IF9saXN0ZW5lcldpbmRvdy5sb2NhdGlvbi5ocmVmLAogICAgICAgICAgICAgICAgICAgIGhhc2ggPSAiIiwKICAgICAgICAgICAgICAgICAgICBpbmRleE9mID0gaHJlZi5pbmRleE9mKCIjIik7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXhPZiAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgIGhhc2ggPSBocmVmLnN1YnN0cmluZyhpbmRleE9mKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChoYXNoICYmIGhhc2ggIT0gX2xhc3RNc2cpIHsKICAgICAgICAgICAgICAgICAgICBfaGFuZGxlSGFzaChoYXNoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gX2F0dGFjaExpc3RlbmVycygpIHsKICAgICAgICAgICAgICAgIF90aW1lciA9IHNldEludGVydmFsKF9wb2xsSGFzaCwgcG9sbEludGVydmFsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIChwdWIgPSB7CiAgICAgICAgICAgICAgICBvdXRnb2luZzogZnVuY3Rpb24obWVzc2FnZSwgZG9tYWluKSB7CiAgICAgICAgICAgICAgICAgICAgX3NlbmRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhckludGVydmFsKF90aW1lcik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSG9zdCB8fCAhdXNlUGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYWxsZXJXaW5kb3cucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChfY2FsbGVyV2luZG93KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgX2NhbGxlcldpbmRvdyA9IG51bGw7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb25ET01SZWFkeTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaXNIb3N0ID0gY29uZmlnLmlzSG9zdDsKICAgICAgICAgICAgICAgICAgICBwb2xsSW50ZXJ2YWwgPSBjb25maWcuaW50ZXJ2YWw7CiAgICAgICAgICAgICAgICAgICAgX2xhc3RNc2cgPSAiIyIgKyBjb25maWcuY2hhbm5lbDsKICAgICAgICAgICAgICAgICAgICBfbXNnTnIgPSAwOwogICAgICAgICAgICAgICAgICAgIHVzZVBhcmVudCA9IGNvbmZpZy51c2VQYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgX3JlbW90ZU9yaWdpbiA9IGdldExvY2F0aW9uKGNvbmZpZy5yZW1vdGUpOwogICAgICAgICAgICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwbHkoY29uZmlnLnByb3BzLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmM6IGNvbmZpZy5yZW1vdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBJRlJBTUVfUFJFRklYICsgY29uZmlnLmNoYW5uZWwgKyAiX3Byb3ZpZGVyIgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVzZVBhcmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLm9uTG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9saXN0ZW5lcldpbmRvdyA9IHdpbmRvdzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfYXR0YWNoTGlzdGVuZXJzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmllcyA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4ID0gY29uZmlnLmRlbGF5IC8gNTA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gZ2V0UmVmKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgrK3RyaWVzID4gbWF4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIHJlZmVyZW5jZSBsaXN0ZW5lcndpbmRvdyIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfbGlzdGVuZXJXaW5kb3cgPSBfY2FsbGVyV2luZG93LmNvbnRlbnRXaW5kb3cuZnJhbWVzW0lGUkFNRV9QUkVGSVggKyBjb25maWcuY2hhbm5lbCArICJfY29uc3VtZXIiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2xpc3RlbmVyV2luZG93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9hdHRhY2hMaXN0ZW5lcnMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZ2V0UmVmLCA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBfY2FsbGVyV2luZG93ID0gY3JlYXRlRnJhbWUoY29uZmlnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBfbGlzdGVuZXJXaW5kb3cgPSB3aW5kb3c7CiAgICAgICAgICAgICAgICAgICAgICAgIF9hdHRhY2hMaXN0ZW5lcnMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVzZVBhcmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NhbGxlcldpbmRvdyA9IHBhcmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGx5KGNvbmZpZywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogY29uZmlnLnJlbW90ZSArICIjIiArIGNvbmZpZy5jaGFubmVsICsgbmV3IERhdGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogSUZSQU1FX1BSRUZJWCArIGNvbmZpZy5jaGFubmVsICsgIl9jb25zdW1lciIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTG9hZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5jYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jYWxsZXJXaW5kb3cgPSBjcmVhdGVGcmFtZShjb25maWcpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHdoZW5SZWFkeShwdWIub25ET01SZWFkeSwgcHViKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIGVhc3lYRE0sIHdpbmRvdywgZXNjYXBlLCB1bmVzY2FwZSwgZGVidWcgKi8KICAgICAgICAvLwogICAgICAgIC8vIGVhc3lYRE0KICAgICAgICAvLyBodHRwOi8vZWFzeXhkbS5uZXQvCiAgICAgICAgLy8gQ29weXJpZ2h0KGMpIDIwMDktMjAxMSwgw5h5dmluZCBTZWFuIEtpbnNleSwgb3l2aW5kQGtpbnNleS5uby4KICAgICAgICAvLwogICAgICAgIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICAgICAgICAvLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogICAgICAgIC8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICAgICAgICAvLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAgICAgICAgLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAgICAgICAgLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAgICAgICAvLwogICAgICAgIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAgICAgICAgLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgICAgICAgLy8KICAgICAgICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogICAgICAgIC8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogICAgICAgIC8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogICAgICAgIC8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICAgICAgICAvLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogICAgICAgIC8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICAgICAgICAvLyBUSEUgU09GVFdBUkUuCiAgICAgICAgLy8KCiAgICAgICAgLyoqCiAgICAgICAgICogQGNsYXNzIGVhc3lYRE0uc3RhY2suUmVsaWFibGVCZWhhdmlvcgogICAgICAgICAqIFRoaXMgaXMgYSBiZWhhdmlvciB0aGF0IHRyaWVzIHRvIG1ha2UgdGhlIHVuZGVybHlpbmcgdHJhbnNwb3J0IHJlbGlhYmxlIGJ5IHVzaW5nIGFja25vd2xlZGdlbWVudHMuCiAgICAgICAgICogQG5hbWVzcGFjZSBlYXN5WERNLnN0YWNrCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgYmVoYXZpb3JzIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICovCiAgICAgICAgZWFzeVhETS5zdGFjay5SZWxpYWJsZUJlaGF2aW9yID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIHZhciBwdWIsIC8vIHRoZSBwdWJsaWMgaW50ZXJmYWNlCiAgICAgICAgICAgICAgICBjYWxsYmFjazsgLy8gdGhlIGNhbGxiYWNrIHRvIGV4ZWN1dGUgd2hlbiB3ZSBoYXZlIGEgY29uZmlybWVkIHN1Y2Nlc3MvZmFpbHVyZQogICAgICAgICAgICB2YXIgaWRPdXQgPSAwLAogICAgICAgICAgICAgICAgaWRJbiA9IDAsCiAgICAgICAgICAgICAgICBjdXJyZW50TWVzc2FnZSA9ICIiOwoKICAgICAgICAgICAgcmV0dXJuIChwdWIgPSB7CiAgICAgICAgICAgICAgICBpbmNvbWluZzogZnVuY3Rpb24obWVzc2FnZSwgb3JpZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4T2YgPSBtZXNzYWdlLmluZGV4T2YoIl8iKSwKICAgICAgICAgICAgICAgICAgICAgICAgYWNrID0gbWVzc2FnZS5zdWJzdHJpbmcoMCwgaW5kZXhPZikuc3BsaXQoIiwiKTsKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZS5zdWJzdHJpbmcoaW5kZXhPZiArIDEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYWNrWzBdID09IGlkT3V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRNZXNzYWdlID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBwdWIuZG93bi5vdXRnb2luZyhhY2tbMV0gKyAiLCIgKyBpZE91dCArICJfIiArIGN1cnJlbnRNZXNzYWdlLCBvcmlnaW4pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaWRJbiAhPSBhY2tbMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkSW4gPSBhY2tbMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWIudXAuaW5jb21pbmcobWVzc2FnZSwgb3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb3V0Z29pbmc6IGZ1bmN0aW9uKG1lc3NhZ2UsIG9yaWdpbiwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50TWVzc2FnZSA9IG1lc3NhZ2U7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmbjsKICAgICAgICAgICAgICAgICAgICBwdWIuZG93bi5vdXRnb2luZyhpZEluICsgIiwiICsgKCsraWRPdXQpICsgIl8iICsgbWVzc2FnZSwgb3JpZ2luKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIGVhc3lYRE0sIHdpbmRvdywgZXNjYXBlLCB1bmVzY2FwZSwgZGVidWcsIHVuZGVmLCByZW1vdmVGcm9tU3RhY2sqLwogICAgICAgIC8vCiAgICAgICAgLy8gZWFzeVhETQogICAgICAgIC8vIGh0dHA6Ly9lYXN5eGRtLm5ldC8KICAgICAgICAvLyBDb3B5cmlnaHQoYykgMjAwOS0yMDExLCDDmHl2aW5kIFNlYW4gS2luc2V5LCBveXZpbmRAa2luc2V5Lm5vLgogICAgICAgIC8vCiAgICAgICAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogICAgICAgIC8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAgICAgICAgLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogICAgICAgIC8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICAgICAgICAvLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICAgICAgICAvLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgogICAgICAgIC8vCiAgICAgICAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICAgICAgICAvLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAgICAgICAvLwogICAgICAgIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAgICAgICAgLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAgICAgICAgLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAgICAgICAgLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogICAgICAgIC8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAgICAgICAgLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogICAgICAgIC8vIFRIRSBTT0ZUV0FSRS4KICAgICAgICAvLwoKICAgICAgICAvKioKICAgICAgICAgKiBAY2xhc3MgZWFzeVhETS5zdGFjay5RdWV1ZUJlaGF2aW9yCiAgICAgICAgICogVGhpcyBpcyBhIGJlaGF2aW9yIHRoYXQgZW5hYmxlcyBxdWV1ZWluZyBvZiBtZXNzYWdlcy4gPGJyLz4KICAgICAgICAgKiBJdCB3aWxsIGJ1ZmZlciBpbmNvbWluZyBtZXNzYWdlcyBhbmQgZGlzcGFjaCB0aGVzZSBhcyBmYXN0IGFzIHRoZSB1bmRlcmx5aW5nIHRyYW5zcG9ydCBhbGxvd3MuCiAgICAgICAgICogVGhpcyB3aWxsIGFsc28gZnJhZ21lbnQvZGVmcmFnbWVudCBtZXNzYWdlcyBzbyB0aGF0IHRoZSBvdXRnb2luZyBtZXNzYWdlIGlzIG5ldmVyIGJpZ2dlciB0aGFuIHRoZQogICAgICAgICAqIHNldCBsZW5ndGguCiAgICAgICAgICogQG5hbWVzcGFjZSBlYXN5WERNLnN0YWNrCiAgICAgICAgICogQGNvbnN0cnVjdG9yCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgYmVoYXZpb3JzIGNvbmZpZ3VyYXRpb24uIE9wdGlvbmFsLgogICAgICAgICAqIEBjZmcge051bWJlcn0gbWF4TGVuZ3RoIFRoZSBtYXhpbXVtIGxlbmd0aCBvZiBlYWNoIG91dGdvaW5nIG1lc3NhZ2UuIFNldCB0aGlzIHRvIGVuYWJsZSBmcmFnbWVudGF0aW9uLgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uc3RhY2suUXVldWVCZWhhdmlvciA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICB2YXIgcHViLCBxdWV1ZSA9IFtdLAogICAgICAgICAgICAgICAgd2FpdGluZyA9IHRydWUsCiAgICAgICAgICAgICAgICBpbmNvbWluZyA9ICIiLAogICAgICAgICAgICAgICAgZGVzdHJveWluZywgbWF4TGVuZ3RoID0gMCwKICAgICAgICAgICAgICAgIGxhenkgPSBmYWxzZSwKICAgICAgICAgICAgICAgIGRvRnJhZ21lbnQgPSBmYWxzZTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoKCkgewogICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5yZW1vdmUgJiYgcXVldWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlRnJvbVN0YWNrKHB1Yik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdhaXRpbmcgfHwgcXVldWUubGVuZ3RoID09PSAwIHx8IGRlc3Ryb3lpbmcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3YWl0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0gcXVldWUuc2hpZnQoKTsKCiAgICAgICAgICAgICAgICBwdWIuZG93bi5vdXRnb2luZyhtZXNzYWdlLmRhdGEsIG1lc3NhZ2Uub3JpZ2luLCBmdW5jdGlvbihzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgd2FpdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmNhbGxiYWNrKHN1Y2Nlc3MpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAocHViID0gewogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVuZGVmKGNvbmZpZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnID0ge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcubWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1heExlbmd0aCA9IGNvbmZpZy5tYXhMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvRnJhZ21lbnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLmxhenkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGF6eSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHViLmRvd24uaW5pdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24oc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIHdhaXRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB2YXIgdXAgPSBwdWIudXA7IC8vIGluIGNhc2UgZGlzcGF0Y2ggY2FsbHMgcmVtb3ZlRnJvbVN0YWNrCiAgICAgICAgICAgICAgICAgICAgZGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgICAgICB1cC5jYWxsYmFjayhzdWNjZXNzKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbmNvbWluZzogZnVuY3Rpb24obWVzc2FnZSwgb3JpZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvRnJhZ21lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4T2YgPSBtZXNzYWdlLmluZGV4T2YoIl8iKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcSA9IHBhcnNlSW50KG1lc3NhZ2Uuc3Vic3RyaW5nKDAsIGluZGV4T2YpLCAxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluY29taW5nICs9IG1lc3NhZ2Uuc3Vic3RyaW5nKGluZGV4T2YgKyAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlcSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5lbmNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNvbWluZyA9IGRlY29kZVVSSUNvbXBvbmVudChpbmNvbWluZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWIudXAuaW5jb21pbmcoaW5jb21pbmcsIG9yaWdpbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNvbWluZyA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHViLnVwLmluY29taW5nKG1lc3NhZ2UsIG9yaWdpbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG91dGdvaW5nOiBmdW5jdGlvbihtZXNzYWdlLCBvcmlnaW4sIGZuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5lbmNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IGVuY29kZVVSSUNvbXBvbmVudChtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIGZyYWdtZW50cyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBmcmFnbWVudDsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9GcmFnbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBmcmFnbWVudCBpbnRvIGNodW5rcwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobWVzc2FnZS5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gbWVzc2FnZS5zdWJzdHJpbmcoMCwgbWF4TGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlLnN1YnN0cmluZyhmcmFnbWVudC5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhZ21lbnRzLnB1c2goZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVucXVldWUgdGhlIGNodW5rcwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKGZyYWdtZW50ID0gZnJhZ21lbnRzLnNoaWZ0KCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBmcmFnbWVudHMubGVuZ3RoICsgIl8iICsgZnJhZ21lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luOiBvcmlnaW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IGZyYWdtZW50cy5sZW5ndGggPT09IDAgPyBmbiA6IG51bGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcXVldWUucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBtZXNzYWdlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luOiBvcmlnaW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogZm4KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChsYXp5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi5kb3duLmluaXQoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBkaXNwYXRjaCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0cm95aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBwdWIuZG93bi5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgLypqc2xpbnQgZXZpbDogdHJ1ZSwgYnJvd3NlcjogdHJ1ZSwgaW1tZWQ6IHRydWUsIHBhc3NmYWlsOiB0cnVlLCB1bmRlZjogdHJ1ZSwgbmV3Y2FwOiB0cnVlKi8KICAgICAgICAvKmdsb2JhbCBlYXN5WERNLCB3aW5kb3csIGVzY2FwZSwgdW5lc2NhcGUsIHVuZGVmLCBkZWJ1ZyAqLwogICAgICAgIC8vCiAgICAgICAgLy8gZWFzeVhETQogICAgICAgIC8vIGh0dHA6Ly9lYXN5eGRtLm5ldC8KICAgICAgICAvLyBDb3B5cmlnaHQoYykgMjAwOS0yMDExLCDDmHl2aW5kIFNlYW4gS2luc2V5LCBveXZpbmRAa2luc2V5Lm5vLgogICAgICAgIC8vCiAgICAgICAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogICAgICAgIC8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAgICAgICAgLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogICAgICAgIC8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICAgICAgICAvLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICAgICAgICAvLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgogICAgICAgIC8vCiAgICAgICAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICAgICAgICAvLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAgICAgICAvLwogICAgICAgIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAgICAgICAgLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAgICAgICAgLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAgICAgICAgLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogICAgICAgIC8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAgICAgICAgLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogICAgICAgIC8vIFRIRSBTT0ZUV0FSRS4KICAgICAgICAvLwoKICAgICAgICAvKioKICAgICAgICAgKiBAY2xhc3MgZWFzeVhETS5zdGFjay5WZXJpZnlCZWhhdmlvcgogICAgICAgICAqIFRoaXMgYmVoYXZpb3Igd2lsbCB2ZXJpZnkgdGhhdCBjb21tdW5pY2F0aW9uIHdpdGggdGhlIHJlbW90ZSBlbmQgaXMgcG9zc2libGUsIGFuZCB3aWxsIGFsc28gc2lnbiBhbGwgb3V0Z29pbmcsCiAgICAgICAgICogYW5kIHZlcmlmeSBhbGwgaW5jb21pbmcgbWVzc2FnZXMuIFRoaXMgcmVtb3ZlcyB0aGUgcmlzayBvZiBzb21lb25lIGhpamFja2luZyB0aGUgaWZyYW1lIHRvIHNlbmQgbWFsaWNpb3VzIG1lc3NhZ2VzLgogICAgICAgICAqIEBuYW1lc3BhY2UgZWFzeVhETS5zdGFjawogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIGJlaGF2aW9ycyBjb25maWd1cmF0aW9uLgogICAgICAgICAqIEBjZmcge0Jvb2xlYW59IGluaXRpYXRlIElmIHRoZSB2ZXJpZmljYXRpb24gc2hvdWxkIGJlIGluaXRpYXRlZCBmcm9tIHRoaXMgZW5kLgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uc3RhY2suVmVyaWZ5QmVoYXZpb3IgPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICAgICAgdmFyIHB1YiwgbXlTZWNyZXQsIHRoZWlyU2VjcmV0LCB2ZXJpZmllZCA9IGZhbHNlOwoKICAgICAgICAgICAgZnVuY3Rpb24gc3RhcnRWZXJpZmljYXRpb24oKSB7CiAgICAgICAgICAgICAgICBteVNlY3JldCA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygyKTsKICAgICAgICAgICAgICAgIHB1Yi5kb3duLm91dGdvaW5nKG15U2VjcmV0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIChwdWIgPSB7CiAgICAgICAgICAgICAgICBpbmNvbWluZzogZnVuY3Rpb24obWVzc2FnZSwgb3JpZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4T2YgPSBtZXNzYWdlLmluZGV4T2YoIl8iKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXhPZiA9PT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UgPT09IG15U2VjcmV0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWIudXAuY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoZWlyU2VjcmV0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVpclNlY3JldCA9IG1lc3NhZ2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5pbml0aWF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0VmVyaWZpY2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdWIuZG93bi5vdXRnb2luZyhtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLnN1YnN0cmluZygwLCBpbmRleE9mKSA9PT0gdGhlaXJTZWNyZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1Yi51cC5pbmNvbWluZyhtZXNzYWdlLnN1YnN0cmluZyhpbmRleE9mICsgMSksIG9yaWdpbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgb3V0Z29pbmc6IGZ1bmN0aW9uKG1lc3NhZ2UsIG9yaWdpbiwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBwdWIuZG93bi5vdXRnb2luZyhteVNlY3JldCArICJfIiArIG1lc3NhZ2UsIG9yaWdpbiwgZm4pOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5pbml0aWF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydFZlcmlmaWNhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICAvKmpzbGludCBldmlsOiB0cnVlLCBicm93c2VyOiB0cnVlLCBpbW1lZDogdHJ1ZSwgcGFzc2ZhaWw6IHRydWUsIHVuZGVmOiB0cnVlLCBuZXdjYXA6IHRydWUqLwogICAgICAgIC8qZ2xvYmFsIGVhc3lYRE0sIHdpbmRvdywgZXNjYXBlLCB1bmVzY2FwZSwgdW5kZWYsIGdldEpTT04sIGRlYnVnLCBlbXB0eUZuLCBpc0FycmF5ICovCiAgICAgICAgLy8KICAgICAgICAvLyBlYXN5WERNCiAgICAgICAgLy8gaHR0cDovL2Vhc3l4ZG0ubmV0LwogICAgICAgIC8vIENvcHlyaWdodChjKSAyMDA5LTIwMTEsIMOYeXZpbmQgU2VhbiBLaW5zZXksIG95dmluZEBraW5zZXkubm8uCiAgICAgICAgLy8KICAgICAgICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAgICAgICAgLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICAgICAgICAvLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAgICAgICAgLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgICAgIC8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogICAgICAgIC8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgICAgICAgLy8KICAgICAgICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogICAgICAgIC8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogICAgICAgIC8vCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgICAgICAvLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICAgICAgICAvLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICAgICAgICAvLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICAgICAgLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICAgICAgICAvLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAgICAgICAgLy8gVEhFIFNPRlRXQVJFLgogICAgICAgIC8vCgogICAgICAgIC8qKgogICAgICAgICAqIEBjbGFzcyBlYXN5WERNLnN0YWNrLlJwY0JlaGF2aW9yCiAgICAgICAgICogVGhpcyB1c2VzIEpTT04tUlBDIDIuMCB0byBleHBvc2UgbG9jYWwgbWV0aG9kcyBhbmQgdG8gaW52b2tlIHJlbW90ZSBtZXRob2RzIGFuZCBoYXZlIHJlc3BvbnNlcyByZXR1cm5lZCBvdmVyIHRoZSB0aGUgc3RyaW5nIGJhc2VkIHRyYW5zcG9ydCBzdGFjay48YnIvPgogICAgICAgICAqIEV4cG9zZWQgbWV0aG9kcyBjYW4gcmV0dXJuIHZhbHVlcyBzeW5jaHJvbm91cywgYXN5bmNyb25vdXMsIG9yIGJldCBzZXQgdXAgdG8gbm90IHJldHVybiBhbnl0aGluZy4KICAgICAgICAgKiBAbmFtZXNwYWNlIGVhc3lYRE0uc3RhY2sKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcHJveHkgVGhlIG9iamVjdCB0byBhcHBseSB0aGUgbWV0aG9kcyB0by4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIFRoZSBkZWZpbml0aW9uIG9mIHRoZSBsb2NhbCBhbmQgcmVtb3RlIGludGVyZmFjZSB0byBpbXBsZW1lbnQuCiAgICAgICAgICogQGNmZyB7T2JqZWN0fSBsb2NhbCBUaGUgbG9jYWwgaW50ZXJmYWNlIHRvIGV4cG9zZS4KICAgICAgICAgKiBAY2ZnIHtPYmplY3R9IHJlbW90ZSBUaGUgcmVtb3RlIG1ldGhvZHMgdG8gZXhwb3NlIHRocm91Z2ggdGhlIHByb3h5LgogICAgICAgICAqIEBjZmcge09iamVjdH0gc2VyaWFsaXplciBUaGUgc2VyaWFsaXplciB0byB1c2UgZm9yIHNlcmlhbGl6aW5nIGFuZCBkZXNlcmlhbGl6aW5nIHRoZSBKU09OLiBTaG91bGQgYmUgY29tcGF0aWJsZSB3aXRoIHRoZSBIVE1MNSBKU09OIG9iamVjdC4gT3B0aW9uYWwsIHdpbGwgZGVmYXVsdCB0byBKU09OLgogICAgICAgICAqLwogICAgICAgIGVhc3lYRE0uc3RhY2suUnBjQmVoYXZpb3IgPSBmdW5jdGlvbihwcm94eSwgY29uZmlnKSB7CiAgICAgICAgICAgIHZhciBwdWIsIHNlcmlhbGl6ZXIgPSBjb25maWcuc2VyaWFsaXplciB8fCBnZXRKU09OKCk7CiAgICAgICAgICAgIHZhciBfY2FsbGJhY2tDb3VudGVyID0gMCwKICAgICAgICAgICAgICAgIF9jYWxsYmFja3MgPSB7fTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBTZXJpYWxpemVzIGFuZCBzZW5kcyB0aGUgbWVzc2FnZQogICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgSlNPTi1SUEMgbWVzc2FnZSB0byBiZSBzZW50LiBUaGUganNvbnJwYyBwcm9wZXJ0eSB3aWxsIGJlIGFkZGVkLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gX3NlbmQoZGF0YSkgewogICAgICAgICAgICAgICAgZGF0YS5qc29ucnBjID0gIjIuMCI7CiAgICAgICAgICAgICAgICBwdWIuZG93bi5vdXRnb2luZyhzZXJpYWxpemVyLnN0cmluZ2lmeShkYXRhKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGVzIGEgbWV0aG9kIHRoYXQgaW1wbGVtZW50cyB0aGUgZ2l2ZW4gZGVmaW5pdGlvbgogICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gVGhlIG1ldGhvZCBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgVGhlIG5hbWUgb2YgdGhlIG1ldGhvZAogICAgICAgICAgICAgKiBAcmV0dXJuIHtGdW5jdGlvbn0gQSBzdHViIGNhcGFibGUgb2YgcHJveHlpbmcgdGhlIHJlcXVlc3RlZCBtZXRob2QgY2FsbAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZnVuY3Rpb24gX2NyZWF0ZU1ldGhvZChkZWZpbml0aW9uLCBtZXRob2QpIHsKICAgICAgICAgICAgICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGwgPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaywgbWVzc2FnZSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGlmIChsID4gMCAmJiB0eXBlb2YgYXJndW1lbnRzW2wgLSAxXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAvL3dpdGggY2FsbGJhY2ssIHByb2NlZHVyZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobCA+IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1tsIC0gMl0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHR3byBjYWxsYmFja3MsIHN1Y2Nlc3MgYW5kIGVycm9yCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBhcmd1bWVudHNbbCAtIDJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBhcmd1bWVudHNbbCAtIDFdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5wYXJhbXMgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMCwgbCAtIDIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2luZ2xlIGNhbGxiYWNrLCBzdWNjZXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBhcmd1bWVudHNbbCAtIDFdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5wYXJhbXMgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMCwgbCAtIDEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIF9jYWxsYmFja3NbIiIgKyAoKytfY2FsbGJhY2tDb3VudGVyKV0gPSBjYWxsYmFjazsKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5pZCA9IF9jYWxsYmFja0NvdW50ZXI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm8gY2FsbGJhY2tzLCBhIG5vdGlmaWNhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnBhcmFtcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlZmluaXRpb24ubmFtZWRQYXJhbXMgJiYgbWVzc2FnZS5wYXJhbXMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UucGFyYW1zID0gbWVzc2FnZS5wYXJhbXNbMF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIFNlbmQgdGhlIG1ldGhvZCByZXF1ZXN0CiAgICAgICAgICAgICAgICAgICAgX3NlbmQobWVzc2FnZSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRXhlY3V0ZXMgdGhlIGV4cG9zZWQgbWV0aG9kCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgVGhlIG5hbWUgb2YgdGhlIG1ldGhvZAogICAgICAgICAgICAgKiBAcGFyYW0ge051bWJlcn0gaWQgVGhlIGNhbGxiYWNrIGlkIHRvIHVzZQogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBtZXRob2QgVGhlIGV4cG9zZWQgaW1wbGVtZW50YXRpb24KICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheX0gcGFyYW1zIFRoZSBwYXJhbWV0ZXJzIHN1cHBsaWVkIGJ5IHRoZSByZW1vdGUgZW5kCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmdW5jdGlvbiBfZXhlY3V0ZU1ldGhvZChtZXRob2QsIGlkLCBmbiwgcGFyYW1zKSB7CiAgICAgICAgICAgICAgICBpZiAoIWZuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9zZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogLTMyNjAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICJQcm9jZWR1cmUgbm90IGZvdW5kLiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgc3VjY2VzcywgZXJyb3I7CiAgICAgICAgICAgICAgICBpZiAoaWQpIHsKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBlbXB0eUZuOwogICAgICAgICAgICAgICAgICAgICAgICBfc2VuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IHJlc3VsdAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGVycm9yID0gZnVuY3Rpb24obWVzc2FnZSwgZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvciA9IGVtcHR5Rm47CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IC0zMjA5OSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2cuZXJyb3IuZGF0YSA9IGRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgX3NlbmQobXNnKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gZXJyb3IgPSBlbXB0eUZuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gQ2FsbCBsb2NhbCBtZXRob2QKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShwYXJhbXMpKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyYW1zID0gW3BhcmFtc107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBmbi5tZXRob2QuYXBwbHkoZm4uc2NvcGUsIHBhcmFtcy5jb25jYXQoW3N1Y2Nlc3MsIGVycm9yXSkpOwogICAgICAgICAgICAgICAgICAgIGlmICghdW5kZWYocmVzdWx0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzKHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgxKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoZXgxLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gKHB1YiA9IHsKICAgICAgICAgICAgICAgIGluY29taW5nOiBmdW5jdGlvbihtZXNzYWdlLCBvcmlnaW4pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IHNlcmlhbGl6ZXIucGFyc2UobWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEubWV0aG9kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEEgbWV0aG9kIGNhbGwgZnJvbSB0aGUgcmVtb3RlIGVuZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLmhhbmRsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmhhbmRsZShkYXRhLCBfc2VuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZXhlY3V0ZU1ldGhvZChkYXRhLm1ldGhvZCwgZGF0YS5pZCwgY29uZmlnLmxvY2FsW2RhdGEubWV0aG9kXSwgZGF0YS5wYXJhbXMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQSBtZXRob2QgcmVzcG9uc2UgZnJvbSB0aGUgb3RoZXIgZW5kCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IF9jYWxsYmFja3NbZGF0YS5pZF07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLmVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2suZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5lcnJvcihkYXRhLmVycm9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjYWxsYmFjay5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5zdWNjZXNzKGRhdGEucmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgX2NhbGxiYWNrc1tkYXRhLmlkXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZy5yZW1vdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW1wbGVtZW50IHRoZSByZW1vdGUgc2lkZXMgZXhwb3NlZCBtZXRob2RzCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG1ldGhvZCBpbiBjb25maWcucmVtb3RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLnJlbW90ZS5oYXNPd25Qcm9wZXJ0eShtZXRob2QpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJveHlbbWV0aG9kXSA9IF9jcmVhdGVNZXRob2QoY29uZmlnLnJlbW90ZVttZXRob2RdLCBtZXRob2QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHB1Yi5kb3duLmluaXQoKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBtZXRob2QgaW4gY29uZmlnLnJlbW90ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLnJlbW90ZS5oYXNPd25Qcm9wZXJ0eShtZXRob2QpICYmIHByb3h5Lmhhc093blByb3BlcnR5KG1ldGhvZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwcm94eVttZXRob2RdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHB1Yi5kb3duLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICB3aW5kb3cuZWFzeVhETSA9IGVhc3lYRE07CgogICAgICAgIC8vcmV0dXJuaW5nIHRoZSBtb2R1bGUgaW5zdGFuY2UKICAgICAgICByZXR1cm4gZWFzeVhETTsKCiAgICAvL30pKHdpbmRvdywgZG9jdW1lbnQsIGxvY2F0aW9uLCB3aW5kb3cuc2V0VGltZW91dCwgZGVjb2RlVVJJQ29tcG9uZW50LCBlbmNvZGVVUklDb21wb25lbnQpOwoKfSk7Ci8qKgogKiBqcXVlcnkuY29ycwogKgogKiBJbXBsZW1lbnRzIENPUlMgZnVuY3Rpb25hbGl0eSBmb3IgYnJvd3NlcnMgc3VwcG9ydGluZyBpdCBuYXRpdmVseSB3aXRoIGFuIGF1dG9tYXRpYwogKiBmYWxsYmFjayB0byBlYXN5WERNIHdoaWNoIGltcGxlbWVudHMgY29ycyB2aWEgYW4gZW1iZWRkZWQgaWZyYW1lIG9yIHN3Zi4gVG8gdXNlIGl0LAogKiB5b3UgbXVzdCBkbyB0d28gdGhpbmdzOgogKgogKiAxLiBJbmNsdWRlIHRoZSBqcXVlcnkgcGx1Z2luIGFuZCB1c2UganF1ZXJ5LmFqYXggY2FsbHMgYXMgdXN1YWwuCiAqIDIuIE1ha2UganF1ZXJ5LmNvcnMgYXZhaWxhYmxlIHZpYSByZXF1aXJlLmpzOgogKiBzaGltOiB7CiAqICAgJ2pxdWVyeS5jb3JzL2Vhc3l4ZG0vZWFzeXhkbSc6IHsgZXhwb3J0czogJ2Vhc3lYRE0nIH0sCiAqIH0KICogcGF0aHM6IHsKICogICAnanF1ZXJ5LmNvcnMnOiAgICAgICAgICAnbGliL2pxdWVyeS5jb3JzLzAuMScsICAgLy8gc2hpbSBhbGwgcGF0aHMKICogfQogKiAzLiBBZGp1c3QganF1ZXJ5X2NvcnNfcGF0aCB0byBtYXRjaCB0aGUgbG9jYXRpb24gd2hlcmUganF1ZXJ5LmVhc3l4ZG0ucHJvdmlkZXIuanMKICogNC4gQWRqdXN0IGpxdWVyeS5lYXN5eGRtLnByb3ZpZGVyLmpzIHRvIGFsbG93IGNhbGxzIGZyb20gdGhlIGRvbWFpbnMgbmVlZGluZyBDT1JTCiAqIDUuIEFkanVzdCBzZXJ2ZXIgdG8gYXBwbHkgQ09SUyBoZWFkZXJzIGZvciBkb21haW5zIHRoYXQgc2hvdWxkIGJlIGFibGUgdG8uIEZvcgogKiAgICBBbGxvdy1DcmVkZW50aWFscyB0byB3b3JrIHByb3Blcmx5LCB0aGUgc2VydmVyIG11c3QgZHluYW1pY2FsbHkgc2V0IHRoZSBBbGxvdy1PcmlnaW4KICogICAgdG8gbWF0Y2ggdGhlIE9yaWdpbjogZnJvbSB0aGUgcmVxdWVzdCwgeW91IGNhbm5vdCBzaW1wbHkgdXNlICoKICoKICogICAgQWNjZXNzLUNvbnRyb2wtQWxsb3ctQ3JlZGVudGlhbHM6IHRydWUKICogICAgQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luOiBodHRwczovL2xvY2FsaG9zdDoyNDQzCiAqICAgIEFjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHM6IEdFVCwgUE9TVCwgUFVULCBQQVRDSCwgREVMRVRFLCBPUFRJT05TCiAqICAgIEFjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnM6IHgtcmVxdWVzdGVkLXdpdGgsIGNvbnRlbnQtdHlwZSwgYWNjZXB0LCBvcmlnaW4sIGF1dGhvcml6YXRpb24KICoKICovCgpkZWZpbmUoJ2pxdWVyeS5jb3JzL2pxdWVyeS5jb3JzJyxbJ3JlcXVpcmUnLCd1bmRlcnNjb3JlJywnanF1ZXJ5JywnanNvbjInLCdjb25zb2xlLXNoaW0nLCdqcXVlcnkuY29ycy9lYXN5eGRtL2Vhc3l4ZG0nXSxmdW5jdGlvbiAocmVxdWlyZSkgewogICAgCiAgICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKICAgICAgICAkID0gcmVxdWlyZSgnanF1ZXJ5JyksCiAgICAgICAgSlNPTiA9IHJlcXVpcmUoJ2pzb24yJyksCiAgICAgICAgY29uc29sZSA9IHJlcXVpcmUoJ2NvbnNvbGUtc2hpbScpLAogICAgICAgIGVhc3lYRE0gPSByZXF1aXJlKCdqcXVlcnkuY29ycy9lYXN5eGRtL2Vhc3l4ZG0nKSwKICAgICAgICBqcXVlcnlfY29yc19wYXRoID0gJy9zdGF0aWMtb3B0aW1pemVkL2pzL2xpYi9qcXVlcnkuY29ycy8wLjEvJywKICAgICAgICBlYXN5WERNX3BhdGggPSBqcXVlcnlfY29yc19wYXRoICsgJy9lYXN5eGRtLycsCiAgICAgICAgZWFzeVhETV9jb25uZWN0aW9ucyA9IHt9LAogICAgICAgIGpxdWVyeV9jb3JzID0ge307CiAgICAgICAgLy8gJC5zdXBwb3J0LmNvcnMgPSBmYWxzZTsKCiAgICAvKioKICAgICAqIENvbmZpZ3VyZSBqUXVlcnkgZm9yIENyb3NzRG9tYWluIENPUlMgcmVxdWVzdHMKICAgICAqLwogICAgJC5hamF4U2V0dXAoewogICAgICAgIHhockZpZWxkczogewogICAgICAgICAgICB3aXRoQ3JlZGVudGlhbHM6IHRydWUKICAgICAgICB9CiAgICB9KTsKICAgIC8vY29uc29sZS5sb2coJ3VzaW5nIGpxdWVyeSBjb3JzJyk7CiAgICAvKioKICAgICAqIHJlZ2lzdGVyIGEgY3VzdG9tIGFqYXhUcmFuc3BvcnQsIHBlcgogICAgICogaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS5hamF4VHJhbnNwb3J0LwogICAgICovCiAgICAgJC5hamF4VHJhbnNwb3J0KCIrKiIsIGZ1bmN0aW9uIChvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSKSB7CgogICAgICAgIC8vIFVuY29tbWVudCB0aGVzZSB0d28gbGluZXMgaWYgd2FudCB0byB0ZXN0IGVhc3lYRE0KICAgICAgICAvLyAkLnN1cHBvcnQuY29ycyA9IGZhbHNlOwogICAgICAgIC8vIG9wdGlvbnMuY3Jvc3NEb21haW4gPSB0cnVlOwoKICAgICAgICBpZiAob3B0aW9ucy5jcm9zc0RvbWFpbiAmJiAhJC5zdXBwb3J0LmNvcnMpIHsKICAgICAgICAgICAgdmFyIHByb3ZpZGVyX2Jhc2VfdXJsID0gIiIsCiAgICAgICAgICAgICAgICByZWdleHBfcmVzdWx0cyA9IG9wdGlvbnMudXJsLm1hdGNoKC9eKGh0dHBzPzpcL1wvW15cL10qKVwvPy4qLyk7CiAgICAgICAgICAgIGlmIChyZWdleHBfcmVzdWx0cykgewogICAgICAgICAgICAgICAgcHJvdmlkZXJfYmFzZV91cmwgPSByZWdleHBfcmVzdWx0c1sxXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFlYXN5WERNX2Nvbm5lY3Rpb25zLmhhc093blByb3BlcnR5KHByb3ZpZGVyX2Jhc2VfdXJsKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2NyZWF0aW5nIGVhc3lYRE0gcG9vbCBlbnRyeSBmb3IgJyArIHByb3ZpZGVyX2Jhc2VfdXJsKTsKICAgICAgICAgICAgICAgIGVhc3lYRE1fY29ubmVjdGlvbnNbcHJvdmlkZXJfYmFzZV91cmxdID0gewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrUXVldWU6IFtdLAogICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb246IHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogdW5kZWZpbmVkLAogICAgICAgICAgICAgICAgICAgIHN0YXRlOiAiYmVmb3JlIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdqcXVlcnkuY29ycyBlYXN5WERNIHJlcXVlc3QgZm9yICcgKyBvcHRpb25zLnVybCArICcgdXNpbmcgJyArIHByb3ZpZGVyX2Jhc2VfdXJsKTsKCiAgICAgICAgICAgIHJldHVybiBwcm92aWRlcl9iYXNlX3VybCA9PT0gIiIgPyBudWxsIDogewogICAgICAgICAgICAgICAgc2VuZDogZnVuY3Rpb24gKGhlYWRlcnMsIGNvbXBsZXRlQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBqcXVlcnlfY29ycy5nZXRDb25uZWN0aW9uKHByb3ZpZGVyX2Jhc2VfdXJsLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogZnVuY3Rpb24gKGVhc3lYRE1fY29ubmVjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gY29udGludWF0aW9uX3Byb3h5KHJlc3VsdHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZWFzeVhETSBjb25uZWN0aW9uIGZvciAnICsgb3B0aW9ucy51cmwgKyAnIHZpYSAnICsgcHJvdmlkZXJfYmFzZV91cmwgKyAnIGNvbnRpbnVhdGlvbiBwcm94eSBleGNlY3V0aW5nJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZUNhbGxiYWNrKHJlc3VsdHMuc3RhdHVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnN0YXR1c1RleHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucmVzcG9uc2VzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLmhlYWRlcnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsT3B0aW9ucy5jb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE1fY29ubmVjdGlvbi5qcXVlcnlfcHJveHkob3JpZ2luYWxPcHRpb25zLCBjb250aW51YXRpb25fcHJveHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vhc3lYRE0gY29ubmVjdGlvbiBmb3IgJyArIG9wdGlvbnMudXJsICsgJyB2aWEgJyArIHByb3ZpZGVyX2Jhc2VfdXJsICsgJyBpbml0aWFsaXplZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICdlcnJvcic6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlYXN5WERNIGNvbm5lY3Rpb24gZm9yICcgKyBwcm92aWRlcl9iYXNlX3VybCArICcgZmFpbGVkIHRvIGluaXRpYWxpemUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICdhYm9ydCc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZWFzeVhETSBjb25uZWN0aW9uIGZvciAnICsgcHJvdmlkZXJfYmFzZV91cmwgKyAnIGFib3J0ZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KTsKCiAgICBqcXVlcnlfY29ycy5kb1JlcXVlc3RzID0gZnVuY3Rpb24gKHByb3ZpZGVyX2Jhc2VfdXJsLCBjYWxsYmFja3MpIHsKICAgICAgICB2YXIgc2NvcGVkX2Vhc3lYRE0gPSBlYXN5WERNLm5vQ29uZmxpY3QoImpxdWVyeV9lYXN5WERNIiArIHByb3ZpZGVyX2Jhc2VfdXJsKSwKICAgICAgICAgICAgcmVtb3RlX3VybCA9IHByb3ZpZGVyX2Jhc2VfdXJsICsganF1ZXJ5X2NvcnNfcGF0aCArICJqcXVlcnkuZWFzeXhkbS5wcm92aWRlci5odG1sIjsKCiAgICAgICAgY29uc29sZS5sb2coJ2RvUmVxdWVzdHMgZm9yICcgKyBwcm92aWRlcl9iYXNlX3VybCk7CgogICAgICAgIGpxdWVyeV9jb3JzLmVhc3lYRE0gPSBzY29wZWRfZWFzeVhETTsKICAgICAgICBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY29ubmVjdGlvbiddID0gbmV3IGpxdWVyeV9jb3JzLmVhc3lYRE0uUnBjKAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGFubmVsOiBwcm92aWRlcl9iYXNlX3VybCwKICAgICAgICAgICAgICAgIHJlbW90ZTogcmVtb3RlX3VybCwKICAgICAgICAgICAgICAgIHN3ZjogcHJvdmlkZXJfYmFzZV91cmwgKyBlYXN5WERNX3BhdGggKyAiZWFzeXhkbS5zd2YiLAogICAgICAgICAgICAgICAgb25SZWFkeTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGVhc3lYRE1fY29ubmVjdGlvbnNbcHJvdmlkZXJfYmFzZV91cmxdWydjb25uZWN0aW9uJ10pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB7IHJlbW90ZTogeyBqcXVlcnlfcHJveHk6IGZ1bmN0aW9uKCkgeyBjb25zb2xlLmxvZygnanF1ZXJ5X3Byb3h5Jyk7IH19fQogICAgICAgICk7CiAgICB9OwoKICAgIGpxdWVyeV9jb3JzLmdldENvbm5lY3Rpb24gPSBmdW5jdGlvbiAocHJvdmlkZXJfYmFzZV91cmwsIGNhbGxiYWNrcykgewogICAgICAgIHZhciBpOwoKICAgICAgICBzd2l0Y2ggKGVhc3lYRE1fY29ubmVjdGlvbnNbcHJvdmlkZXJfYmFzZV91cmxdWydzdGF0ZSddKSB7CiAgICAgICAgICAgIGNhc2UgImJlZm9yZSI6CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnYmVmb3JlOiAnICsgcHJvdmlkZXJfYmFzZV91cmwpOwogICAgICAgICAgICAgICAgZWFzeVhETV9jb25uZWN0aW9uc1twcm92aWRlcl9iYXNlX3VybF1bJ3N0YXRlJ10gPSAid29ya2luZyI7CiAgICAgICAgICAgICAgICBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY2FsbGJhY2tRdWV1ZSddLnB1c2goY2FsbGJhY2tzKTsKICAgICAgICAgICAgICAgIGpxdWVyeV9jb3JzLmRvUmVxdWVzdHMocHJvdmlkZXJfYmFzZV91cmwsewogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogZnVuY3Rpb24gKHNpbmdsZXRvbkluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdkb1JlcXVlc3RzLnN1Y2Nlc3MgZm9yICcgKyBwcm92aWRlcl9iYXNlX3VybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE1fY29ubmVjdGlvbnNbcHJvdmlkZXJfYmFzZV91cmxdWydzdGF0ZSddID0gInN1Y2Nlc3MiOwogICAgICAgICAgICAgICAgICAgICAgICBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY29ubmVjdGlvbiddID0gc2luZ2xldG9uSW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY2FsbGJhY2tRdWV1ZSddLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY2FsbGJhY2tRdWV1ZSddW2ldLnN1Y2Nlc3MoZWFzeVhETV9jb25uZWN0aW9uc1twcm92aWRlcl9iYXNlX3VybF1bJ2Nvbm5lY3Rpb24nXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWFzeVhETV9jb25uZWN0aW9uc1twcm92aWRlcl9iYXNlX3VybF1bJ2NhbGxiYWNrUXVldWUnXSA9IFtdOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgJ2ZhaWx1cmUnOiBmdW5jdGlvbiAoZXJyb3JPYmopIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2RvUmVxdWVzdHMuZmFpbHVyZSBmb3IgJyArIHByb3ZpZGVyX2Jhc2VfdXJsKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWFzeVhETV9jb25uZWN0aW9uc1twcm92aWRlcl9iYXNlX3VybF1bJ3N0YXRlJ10gPSAiZmFpbHVyZSI7CiAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE1fY29ubmVjdGlvbnNbcHJvdmlkZXJfYmFzZV91cmxdWydlcnJvciddID0gZXJyb3JPYmo7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY2FsbGJhY2tRdWV1ZSddLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY2FsbGJhY2tRdWV1ZSddW2ldLmZhaWx1cmUoZXJyb3JPYmopOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVhc3lYRE1fY29ubmVjdGlvbnNbcHJvdmlkZXJfYmFzZV91cmxdWydjYWxsYmFja1F1ZXVlJ10gPSBbXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAid29ya2luZyI6CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCd3b3JraW5nOiAnICsgcHJvdmlkZXJfYmFzZV91cmwpOwogICAgICAgICAgICBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY2FsbGJhY2tRdWV1ZSddLnB1c2goY2FsbGJhY2tzKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAic3VjY2VzcyI6CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzdWNjZXNzOiAnICsgcHJvdmlkZXJfYmFzZV91cmwpOwogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnY29ubmVjdGlvbiddKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiZmFpbHVyZSI6CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdmYWlsdXJlOiAnICsgcHJvdmlkZXJfYmFzZV91cmwpOwogICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnZXJyb3InXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdpbnZhbGlkIHN0YXRlOiAnICsgcHJvdmlkZXJfYmFzZV91cmwpOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgc3RhdGU6ICIgKyBlYXN5WERNX2Nvbm5lY3Rpb25zW3Byb3ZpZGVyX2Jhc2VfdXJsXVsnc3RhdGUnXSk7CiAgICAgICAgfQogICAgfTsKICAgIHdpbmRvdy4kID0gJDsKICAgIHdpbmRvdy5qcXVlcnlfY29ycyA9IGpxdWVyeV9jb3JzOwogICAgcmV0dXJuIGpxdWVyeV9jb3JzOwp9KTsKLypnbG9iYWwgZGVmaW5lLHNldFRpbWVvdXQsY2xlYXJUaW1lb3V0Ki8KZGVmaW5lKCdjaGlyb3ByYWN0b3IvbW9kZWxzL2F1dGgnLFsncmVxdWlyZScsJ2JhY2tib25lJywnanF1ZXJ5JywnanNvbi1pZTcnLCd1bmRlcnNjb3JlJywnanF1ZXJ5LmNvb2tpZSddLGZ1bmN0aW9uKHJlcXVpcmUpIHsKICAgIAoKICAgIHZhciBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyksCiAgICAgICAgJCA9IHJlcXVpcmUoJ2pxdWVyeScpLAogICAgICAgIEpTT04gPSByZXF1aXJlKCdqc29uLWllNycpLAogICAgICAgIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyksCiAgICAgICAgdG9rZW5Db29raWUgPSAnd3R0b2tlbicsCiAgICAgICAgZXhwaXJhdGlvbldhcm5pbmdNaW51dGVzID0gMiwKICAgICAgICBleHBpcmF0aW9uV2FybmluZ0FjdGl2ZSA9IGZhbHNlLAogICAgICAgIGV4cGlyYXRpb25UaW1lb3V0SWQsIGV4cGlyYXRpb25XYXJuaW5nLAogICAgICAgIGFjdGl2ZVRva2VuLCBnZXRUb2tlbiwgc2V0VG9rZW4sIGNsZWFyVG9rZW47CgogICAgcmVxdWlyZSgnanF1ZXJ5LmNvb2tpZScpOwoKICAgIGV4cGlyYXRpb25XYXJuaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgQmFja2JvbmUuRXZlbnRzLnRyaWdnZXIoJ2F1dGhlbnRpY2F0aW9uOmV4cGlyYXRpb24nKTsKICAgICAgICBleHBpcmF0aW9uV2FybmluZ0FjdGl2ZSA9IHRydWU7CgogICAgICAgIGV4cGlyYXRpb25UaW1lb3V0SWQgPSBzZXRUaW1lb3V0KAogICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIEJhY2tib25lLkV2ZW50cy50cmlnZ2VyKCdhdXRoZW50aWNhdGlvbjpmYWlsdXJlJyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGV4cGlyYXRpb25XYXJuaW5nTWludXRlcyAqIDYwICogMTAwMAogICAgICAgICk7CiAgICB9OwoKICAgIGdldFRva2VuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHR5cGVvZihhY3RpdmVUb2tlbikgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIGFjdGl2ZVRva2VuID0gJC5jb29raWUodG9rZW5Db29raWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYWN0aXZlVG9rZW47CiAgICB9OwoKICAgIHNldFRva2VuID0gZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICB2YXIgdG9rZW5Db21wb25lbnRzID0gdG9rZW4uc3BsaXQoJzo6JyksCiAgICAgICAgICAgIHNlcnZlclRpbWUgPSB0b2tlbkNvbXBvbmVudHNbMV0sCiAgICAgICAgICAgIGV4cGlyZVRpbWUgPSB0b2tlbkNvbXBvbmVudHNbMl0sCiAgICAgICAgICAgIC8vIFdlIHdhbnQgYW4gZXhwaXJhdGlvbiBhbGVydCB0byBoYXBwZW4gdHdvIG1pbnV0ZXMgYmVmb3JlIHRoZQogICAgICAgICAgICAvLyB0b2tlbiBpcyBnb2luZyB0byBleHBpcmUuCiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lb3V0ID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgZXhwaXJlVGltZSAtIHNlcnZlclRpbWUgLSAoZXhwaXJhdGlvbldhcm5pbmdNaW51dGVzICogNjApCiAgICAgICAgICAgICkgKiAxMDAwOwoKICAgICAgICBhY3RpdmVUb2tlbiA9IHRva2VuOwogICAgICAgICQuY29va2llKHRva2VuQ29va2llLCB0b2tlbik7CgogICAgICAgIGlmIChleHBpcmF0aW9uVGltZW91dElkKSB7CiAgICAgICAgICAgIGNsZWFyVGltZW91dChleHBpcmF0aW9uVGltZW91dElkKTsKICAgICAgICB9CgogICAgICAgIGlmIChleHBpcmF0aW9uV2FybmluZ0FjdGl2ZSkgewogICAgICAgICAgICBCYWNrYm9uZS5FdmVudHMudHJpZ2dlcignYXV0aGVudGljYXRpb246cmVuZXdhbCcpOwogICAgICAgICAgICBleHBpcmF0aW9uV2FybmluZ0FjdGl2ZSA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZXhwaXJhdGlvblRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZXhwaXJhdGlvbldhcm5pbmcsIGV4cGlyYXRpb25UaW1lb3V0KTsKICAgIH07CgogICAgY2xlYXJUb2tlbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGFjdGl2ZVRva2VuID0gdW5kZWZpbmVkOwogICAgICAgICQucmVtb3ZlQ29va2llKHRva2VuQ29va2llKTsKCiAgICAgICAgaWYgKGV4cGlyYXRpb25UaW1lb3V0SWQpIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGV4cGlyYXRpb25UaW1lb3V0SWQpOwogICAgICAgIH0KICAgIH07CgogICAgQmFja2JvbmUuRXZlbnRzLm9uKAogICAgICAgICdhdXRoZW50aWNhdGlvbjpsb2dvdXQgYXV0aGVudGljYXRpb246ZmFpbHVyZScsCiAgICAgICAgY2xlYXJUb2tlbgogICAgKTsKCiAgICByZXR1cm4gewogICAgICAgIHN5bmM6IGZ1bmN0aW9uKG1ldGhvZCwgbW9kZWwsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGJlZm9yZVNlbmQgPSBvcHRpb25zLmJlZm9yZVNlbmQsCiAgICAgICAgICAgICAgICBvbkVycm9yID0gb3B0aW9ucy5lcnJvciwKICAgICAgICAgICAgICAgIG9uU3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzcywKICAgICAgICAgICAgICAgIHNlbGYgPSB0aGlzLAogICAgICAgICAgICAgICAgb3B0cyA9IF8ob3B0aW9ucykuY2xvbmUoKTsKCiAgICAgICAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKG1vZGVsLCBkYXRhLCB4aHIpIHsKICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHhoci5nZXRSZXNwb25zZUhlYWRlcignQXV0aG9yaXphdGlvbicpOwogICAgICAgICAgICAgICAgaWYgKHRva2VuKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0VG9rZW4odG9rZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG9uU3VjY2Vzcy5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gVGhpcyBpcyBhIGpRdWVyeSBlcnJvciBoYW5kbGVyLgogICAgICAgICAgICBvcHRpb25zLmVycm9yID0gZnVuY3Rpb24oeGhyLCBzdGF0dXNUZXh0LCBlcnJvcikgewogICAgICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDQwMCkgewogICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IGFkZCBsb2dpYyB0byBvbmx5IHRyaWdnZXIgdW5hdXRoZW50aWNhdGVkIGlmIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGJhZCByZXF1ZXN0IGlzIGR1ZSB0byBtYWxmb3JtZWQgdG9rZW4KICAgICAgICAgICAgICAgICAgICBCYWNrYm9uZS5FdmVudHMudHJpZ2dlcignYXV0aGVudGljYXRpb246ZmFpbHVyZScsIHNlbGYsIHhocik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PT0gNDAxKSB7CiAgICAgICAgICAgICAgICAgICAgQmFja2JvbmUuRXZlbnRzLnRyaWdnZXIoJ2F1dGhlbnRpY2F0aW9uOmZhaWx1cmUnLCBzZWxmLCB4aHIpOwoKICAgICAgICAgICAgICAgICAgICBzZWxmLmxpc3RlblRvT25jZSgKICAgICAgICAgICAgICAgICAgICAgICAgQmFja2JvbmUuRXZlbnRzLAogICAgICAgICAgICAgICAgICAgICAgICAnYXV0aGVudGljYXRpb246c3VjY2VzcycsCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zeW5jKG1ldGhvZCwgbW9kZWwsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDYWxsIHRoZSBvcmlnaW5hbCBvbkVycm9yIGhhbmRsZXIuCiAgICAgICAgICAgICAgICBpZiAob25FcnJvcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvbkVycm9yLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBvcHRpb25zLmJlZm9yZVNlbmQgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IGdldFRva2VuKCk7CiAgICAgICAgICAgICAgICBpZiAoIXNlbGYuZGlzYWJsZUF1dGhUb2tlbiAmJiB0b2tlbikgewogICAgICAgICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKAogICAgICAgICAgICAgICAgICAgICAgICAnQXV0aG9yaXphdGlvbicsCiAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYmVmb3JlU2VuZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBiZWZvcmVTZW5kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBjbGVhbnVwOiBjbGVhclRva2VuCiAgICB9Owp9KTsKCi8qKgogKiBVbmRlcnNjb3JlIG1peGlucyBmb3IgZGVlcCBvYmplY3RzCiAqCiAqIEJhc2VkIG9uIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL2VjaG9uZy8zODYxOTYzCiAqLwovLyhmdW5jdGlvbigpIHsKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCd1bmRlcnNjb3JlLm1peGluLmRlZXBleHRlbmQnLFsncmVxdWlyZScsJ3VuZGVyc2NvcmUnXSxmdW5jdGlvbiAocmVxdWlyZSkgewogIAoKICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKICAgIGFycmF5cywgYmFzaWNPYmplY3RzLCBkZWVwQ2xvbmUsIGRlZXBFeHRlbmQsIGRlZXBFeHRlbmRDb3VwbGUsIGlzQmFzaWNPYmplY3QsCiAgICBfX3NsaWNlID0gW10uc2xpY2U7CgogIGRlZXBDbG9uZSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBmdW5jLCBpc0FycjsKICAgIGlmICghXy5pc09iamVjdChvYmopIHx8IF8uaXNGdW5jdGlvbihvYmopKSB7CiAgICAgIHJldHVybiBvYmo7CiAgICB9CiAgICBpZiAob2JqIGluc3RhbmNlb2YgQmFja2JvbmUuQ29sbGVjdGlvbiB8fCBvYmogaW5zdGFuY2VvZiBCYWNrYm9uZS5Nb2RlbCkgewogICAgICByZXR1cm4gb2JqOwogICAgfQogICAgaWYgKF8uaXNEYXRlKG9iaikpIHsKICAgICAgcmV0dXJuIG5ldyBEYXRlKG9iai5nZXRUaW1lKCkpOwogICAgfQogICAgaWYgKF8uaXNSZWdFeHAob2JqKSkgewogICAgICByZXR1cm4gbmV3IFJlZ0V4cChvYmouc291cmNlLCBvYmoudG9TdHJpbmcoKS5yZXBsYWNlKC8uKlwvLywgIiIpKTsKICAgIH0KICAgIGlzQXJyID0gXy5pc0FycmF5KG9iaiB8fCBfLmlzQXJndW1lbnRzKG9iaikpOwogICAgZnVuYyA9IGZ1bmN0aW9uIChtZW1vLCB2YWx1ZSwga2V5KSB7CiAgICAgIGlmIChpc0FycikgewogICAgICAgIG1lbW8ucHVzaChkZWVwQ2xvbmUodmFsdWUpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vW2tleV0gPSBkZWVwQ2xvbmUodmFsdWUpOwogICAgICB9CiAgICAgIHJldHVybiBtZW1vOwogICAgfTsKICAgIHJldHVybiBfLnJlZHVjZShvYmosIGZ1bmMsIGlzQXJyID8gW10gOiB7fSk7CiAgfTsKCiAgaXNCYXNpY09iamVjdCA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgIGlmIChvYmplY3QgPT09IG51bGwgfHwgb2JqZWN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIChvYmplY3QucHJvdG90eXBlID09PSB7fS5wcm90b3R5cGUgfHwgb2JqZWN0LnByb3RvdHlwZSA9PT0gT2JqZWN0LnByb3RvdHlwZSkgJiYgXy5pc09iamVjdChvYmplY3QpICYmICFfLmlzQXJyYXkob2JqZWN0KSAmJiAhXy5pc0Z1bmN0aW9uKG9iamVjdCkgJiYgIV8uaXNEYXRlKG9iamVjdCkgJiYgIV8uaXNSZWdFeHAob2JqZWN0KSAmJiAhXy5pc0FyZ3VtZW50cyhvYmplY3QpOwogIH07CgogIGJhc2ljT2JqZWN0cyA9IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgIHJldHVybiBfLmZpbHRlcihfLmtleXMob2JqZWN0KSwgZnVuY3Rpb24gKGtleSkgewogICAgICByZXR1cm4gaXNCYXNpY09iamVjdChvYmplY3Rba2V5XSk7CiAgICB9KTsKICB9OwoKICBhcnJheXMgPSBmdW5jdGlvbiAob2JqZWN0KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoXy5rZXlzKG9iamVjdCksIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgcmV0dXJuIF8uaXNBcnJheShvYmplY3Rba2V5XSk7CiAgICB9KTsKICB9OwoKICBkZWVwRXh0ZW5kQ291cGxlID0gZnVuY3Rpb24gKGRlc3RpbmF0aW9uLCBzb3VyY2UsIG1heERlcHRoKSB7CiAgICB2YXIgY29tYmluZSwgcmVjdXJzZSwgc2hhcmVkQXJyYXlLZXksIHNoYXJlZEFycmF5S2V5cywgc2hhcmVkT2JqZWN0S2V5LCBzaGFyZWRPYmplY3RLZXlzLCBfaSwgX2osIF9sZW4sIF9sZW4xOwogICAgaWYgKG1heERlcHRoID09PSBudWxsKSB7CiAgICAgIG1heERlcHRoID0gMjA7CiAgICB9CiAgICBpZiAobWF4RGVwdGggPD0gMCkgewogICAgICBjb25zb2xlLndhcm4oJ18uZGVlcEV4dGVuZCgpOiBNYXhpbXVtIGRlcHRoIG9mIHJlY3Vyc2lvbiBoaXQuJyk7CiAgICAgIHJldHVybiBfLmV4dGVuZChkZXN0aW5hdGlvbiwgc291cmNlKTsKICAgIH0KICAgIHNoYXJlZE9iamVjdEtleXMgPSBfLmludGVyc2VjdGlvbihiYXNpY09iamVjdHMoZGVzdGluYXRpb24pLCBiYXNpY09iamVjdHMoc291cmNlKSk7CiAgICByZWN1cnNlID0gZnVuY3Rpb24gKGtleSkgewogICAgICBzb3VyY2Vba2V5XSA9IGRlZXBFeHRlbmRDb3VwbGUoZGVzdGluYXRpb25ba2V5XSwgc291cmNlW2tleV0sIG1heERlcHRoIC0gMSk7CiAgICAgIHJldHVybiBzb3VyY2Vba2V5XTsKICAgIH07CiAgICBmb3IgKF9pID0gMCwgX2xlbiA9IHNoYXJlZE9iamVjdEtleXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pICs9IDEpIHsKICAgICAgc2hhcmVkT2JqZWN0S2V5ID0gc2hhcmVkT2JqZWN0S2V5c1tfaV07CiAgICAgIHJlY3Vyc2Uoc2hhcmVkT2JqZWN0S2V5KTsKICAgIH0KICAgIHNoYXJlZEFycmF5S2V5cyA9IF8uaW50ZXJzZWN0aW9uKGFycmF5cyhkZXN0aW5hdGlvbiksIGFycmF5cyhzb3VyY2UpKTsKICAgIGNvbWJpbmUgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHNvdXJjZVtrZXldID0gXy51bmlvbihkZXN0aW5hdGlvbltrZXldLCBzb3VyY2Vba2V5XSk7CiAgICAgIHJldHVybiBzb3VyY2Vba2V5XTsKICAgIH07CiAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBzaGFyZWRBcnJheUtleXMubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaiArPSAxKSB7CiAgICAgIHNoYXJlZEFycmF5S2V5ID0gc2hhcmVkQXJyYXlLZXlzW19qXTsKICAgICAgY29tYmluZShzaGFyZWRBcnJheUtleSk7CiAgICB9CiAgICByZXR1cm4gXy5leHRlbmQoZGVzdGluYXRpb24sIHNvdXJjZSk7CiAgfTsKCiAgZGVlcEV4dGVuZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBmaW5hbE9iaiwgbWF4RGVwdGgsIG9iamVjdHMsIF9pOwogICAgb2JqZWN0cyA9IDIgPD0gYXJndW1lbnRzLmxlbmd0aCA/IF9fc2xpY2UuY2FsbChhcmd1bWVudHMsIDAsIF9pID0gYXJndW1lbnRzLmxlbmd0aCAtIDEpIDogKF9pID0gMCwgW10pLCBtYXhEZXB0aCA9IGFyZ3VtZW50c1tfaSsrXTsKICAgIGlmICghXy5pc051bWJlcihtYXhEZXB0aCkpIHsKICAgICAgb2JqZWN0cy5wdXNoKG1heERlcHRoKTsKICAgICAgbWF4RGVwdGggPSAyMDsKICAgIH0KICAgIGlmIChvYmplY3RzLmxlbmd0aCA8PSAxKSB7CiAgICAgIHJldHVybiBvYmplY3RzWzBdOwogICAgfQogICAgaWYgKG1heERlcHRoIDw9IDApIHsKICAgICAgcmV0dXJuIF8uZXh0ZW5kLmFwcGx5KHRoaXMsIG9iamVjdHMpOwogICAgfQogICAgZmluYWxPYmogPSBvYmplY3RzLnNoaWZ0KCk7CiAgICB3aGlsZSAob2JqZWN0cy5sZW5ndGggPiAwKSB7CiAgICAgIGZpbmFsT2JqID0gZGVlcEV4dGVuZENvdXBsZShmaW5hbE9iaiwgZGVlcENsb25lKG9iamVjdHMuc2hpZnQoKSksIG1heERlcHRoKTsKICAgIH0KICAgIHJldHVybiBmaW5hbE9iajsKICB9OwoKICBfLm1peGluKHsKICAgIGRlZXBDbG9uZTogZGVlcENsb25lLAogICAgaXNCYXNpY09iamVjdDogaXNCYXNpY09iamVjdCwKICAgIGJhc2ljT2JqZWN0czogYmFzaWNPYmplY3RzLAogICAgYXJyYXlzOiBhcnJheXMsCiAgICBkZWVwRXh0ZW5kOiBkZWVwRXh0ZW5kCiAgfSk7Cgp9KTsKLyoqCiAqIE1haW4gc291cmNlCiAqLwoKOyhmdW5jdGlvbihmYWN0b3J5KSB7CiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgLy8gQU1ECiAgICAgICAgZGVmaW5lKCdiYWNrYm9uZS5kZWVwLm1vZGVsJyxbJ3VuZGVyc2NvcmUnLCAnYmFja2JvbmUnXSwgZmFjdG9yeSk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIGdsb2JhbHMKICAgICAgICBmYWN0b3J5KF8sIEJhY2tib25lKTsKICAgIH0KfShmdW5jdGlvbihfLCBCYWNrYm9uZSkgewoKICAgIC8qKgogICAgICogVGFrZXMgYSBuZXN0ZWQgb2JqZWN0IGFuZCByZXR1cm5zIGEgc2hhbGxvdyBvYmplY3Qga2V5ZWQgd2l0aCB0aGUgcGF0aCBuYW1lcwogICAgICogZS5nLiB7ICJsZXZlbDEubGV2ZWwyIjogInZhbHVlIiB9CiAgICAgKgogICAgICogQHBhcmFtICB7T2JqZWN0fSAgICAgIE5lc3RlZCBvYmplY3QgZS5nLiB7IGxldmVsMTogeyBsZXZlbDI6ICd2YWx1ZScgfSB9CiAgICAgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgU2hhbGxvdyBvYmplY3Qgd2l0aCBwYXRoIG5hbWVzIGUuZy4geyAnbGV2ZWwxLmxldmVsMic6ICd2YWx1ZScgfQogICAgICovCiAgICBmdW5jdGlvbiBvYmpUb1BhdGhzKG9iaikgewogICAgICAgIHZhciByZXQgPSB7fSwKICAgICAgICAgICAgc2VwYXJhdG9yID0gRGVlcE1vZGVsLmtleVBhdGhTZXBhcmF0b3I7CgogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgdmFyIHZhbCA9IG9ialtrZXldOwoKICAgICAgICAgICAgaWYgKHZhbCAmJiB2YWwuY29uc3RydWN0b3IgPT09IE9iamVjdCAmJiAhXy5pc0VtcHR5KHZhbCkpIHsKICAgICAgICAgICAgICAgIC8vUmVjdXJzaW9uIGZvciBlbWJlZGRlZCBvYmplY3RzCiAgICAgICAgICAgICAgICB2YXIgb2JqMiA9IG9ialRvUGF0aHModmFsKTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkyIGluIG9iajIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsMiA9IG9iajJba2V5Ml07CgogICAgICAgICAgICAgICAgICAgIHJldFtrZXkgKyBzZXBhcmF0b3IgKyBrZXkyXSA9IHZhbDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXRba2V5XSA9IHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KCiAgICAvKioKICAgICAqIEBwYXJhbSB7T2JqZWN0fSAgT2JqZWN0IHRvIGZldGNoIGF0dHJpYnV0ZSBmcm9tCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gIE9iamVjdCBwYXRoIGUuZy4gJ3VzZXIubmFtZScKICAgICAqIEByZXR1cm4ge01peGVkfQogICAgICovCiAgICBmdW5jdGlvbiBnZXROZXN0ZWQob2JqLCBwYXRoLCByZXR1cm5fZXhpc3RzKSB7CiAgICAgICAgdmFyIHNlcGFyYXRvciA9IERlZXBNb2RlbC5rZXlQYXRoU2VwYXJhdG9yOwoKICAgICAgICB2YXIgZmllbGRzID0gcGF0aC5zcGxpdChzZXBhcmF0b3IpOwogICAgICAgIHZhciByZXN1bHQgPSBvYmo7CiAgICAgICAgcmV0dXJuX2V4aXN0cyB8fCAocmV0dXJuX2V4aXN0cyA9PT0gZmFsc2UpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBuID0gZmllbGRzLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICAgICAgICBpZiAocmV0dXJuX2V4aXN0cyAmJiAhXy5oYXMocmVzdWx0LCBmaWVsZHNbaV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ID0gcmVzdWx0W2ZpZWxkc1tpXV07CgogICAgICAgICAgICBpZiAocmVzdWx0ID09IG51bGwgJiYgaSA8IG4gLSAxKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSB7fTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICBpZiAocmV0dXJuX2V4aXN0cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJldHVybl9leGlzdHMpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmogICAgICAgICAgICAgICAgT2JqZWN0IHRvIGZldGNoIGF0dHJpYnV0ZSBmcm9tCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCAgICAgICAgICAgICAgIE9iamVjdCBwYXRoIGUuZy4gJ3VzZXIubmFtZScKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gICAgICAgICAgT3B0aW9ucwogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy51bnNldF0gICBXaGV0aGVyIHRvIGRlbGV0ZSB0aGUgdmFsdWUKICAgICAqIEBwYXJhbSB7TWl4ZWR9ICAgICAgICAgICAgICAgICAgICAgVmFsdWUgdG8gc2V0CiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldE5lc3RlZChvYmosIHBhdGgsIHZhbCwgb3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgICB2YXIgc2VwYXJhdG9yID0gRGVlcE1vZGVsLmtleVBhdGhTZXBhcmF0b3I7CgogICAgICAgIHZhciBmaWVsZHMgPSBwYXRoLnNwbGl0KHNlcGFyYXRvcik7CiAgICAgICAgdmFyIHJlc3VsdCA9IG9iajsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbiA9IGZpZWxkcy5sZW5ndGg7IGkgPCBuICYmIHJlc3VsdCAhPT0gdW5kZWZpbmVkIDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBmaWVsZCA9IGZpZWxkc1tpXTsKCiAgICAgICAgICAgIC8vSWYgdGhlIGxhc3QgaW4gdGhlIHBhdGgsIHNldCB0aGUgdmFsdWUKICAgICAgICAgICAgaWYgKGkgPT09IG4gLSAxKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLnVuc2V0ID8gZGVsZXRlIHJlc3VsdFtmaWVsZF0gOiByZXN1bHRbZmllbGRdID0gdmFsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy9DcmVhdGUgdGhlIGNoaWxkIG9iamVjdCBpZiBpdCBkb2Vzbid0IGV4aXN0LCBvciBpc24ndCBhbiBvYmplY3QKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVzdWx0W2ZpZWxkXSA9PT0gJ3VuZGVmaW5lZCcgfHwgISBfLmlzT2JqZWN0KHJlc3VsdFtmaWVsZF0pKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2ZpZWxkXSA9IHt9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vTW92ZSBvbnRvIHRoZSBuZXh0IHBhcnQgb2YgdGhlIHBhdGgKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdFtmaWVsZF07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZGVsZXRlTmVzdGVkKG9iaiwgcGF0aCkgewogICAgICBzZXROZXN0ZWQob2JqLCBwYXRoLCBudWxsLCB7IHVuc2V0OiB0cnVlIH0pOwogICAgfQoKICAgIHZhciBEZWVwTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewoKICAgICAgICAvLyBPdmVycmlkZSBjb25zdHJ1Y3RvcgogICAgICAgIC8vIFN1cHBvcnQgaGF2aW5nIG5lc3RlZCBkZWZhdWx0cyBieSB1c2luZyBfLmRlZXBFeHRlbmQgaW5zdGVhZCBvZiBfLmV4dGVuZAogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0czsKICAgICAgICAgICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgICAgICAgICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wYXJzZSkgYXR0cnMgPSB0aGlzLnBhcnNlKGF0dHJzLCBvcHRpb25zKSB8fCB7fTsKICAgICAgICAgICAgaWYgKGRlZmF1bHRzID0gXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpIHsKICAgICAgICAgICAgICAgIC8vPGN1c3RvbSBjb2RlPgogICAgICAgICAgICAgICAgLy8gUmVwbGFjZWQgdGhlIGNhbGwgdG8gXy5kZWZhdWx0cyB3aXRoIF8uZGVlcEV4dGVuZC4KICAgICAgICAgICAgICAgIGF0dHJzID0gXy5kZWVwRXh0ZW5kKHt9LCBkZWZhdWx0cywgYXR0cnMpOwogICAgICAgICAgICAgICAgLy88L2N1c3RvbSBjb2RlPgogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0KGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCgogICAgICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgICAgICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcywgdHJ1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gT3ZlcnJpZGUgZ2V0CiAgICAgICAgLy8gU3VwcG9ydHMgbmVzdGVkIGF0dHJpYnV0ZXMgdmlhIHRoZSBzeW50YXggJ29iai5hdHRyJyBlLmcuICdhdXRob3IudXNlci5uYW1lJwogICAgICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICAgICAgICByZXR1cm4gZ2V0TmVzdGVkKHRoaXMuYXR0cmlidXRlcywgYXR0cik7CiAgICAgICAgfSwKCiAgICAgICAgLy8gT3ZlcnJpZGUgc2V0CiAgICAgICAgLy8gU3VwcG9ydHMgbmVzdGVkIGF0dHJpYnV0ZXMgdmlhIHRoZSBzeW50YXggJ29iai5hdHRyJyBlLmcuICdhdXRob3IudXNlci5uYW1lJwogICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGF0dHIsIGF0dHJzLCB1bnNldCwgY2hhbmdlcywgc2lsZW50LCBjaGFuZ2luZywgcHJldiwgY3VycmVudDsKICAgICAgICAgICAgaWYgKGtleSA9PSBudWxsKSByZXR1cm4gdGhpczsKCiAgICAgICAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICAgICAgICBpZiAodHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICAgICAgICBvcHRpb25zID0gdmFsIHx8IHt9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwoKICAgICAgICAgICAgLy8gUnVuIHZhbGlkYXRpb24uCiAgICAgICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAvLyBFeHRyYWN0IGF0dHJpYnV0ZXMgYW5kIG9wdGlvbnMuCiAgICAgICAgICAgIHVuc2V0ICAgICAgICAgICA9IG9wdGlvbnMudW5zZXQ7CiAgICAgICAgICAgIHNpbGVudCAgICAgICAgICA9IG9wdGlvbnMuc2lsZW50OwogICAgICAgICAgICBjaGFuZ2VzICAgICAgICAgPSBbXTsKICAgICAgICAgICAgY2hhbmdpbmcgICAgICAgID0gdGhpcy5fY2hhbmdpbmc7CiAgICAgICAgICAgIHRoaXMuX2NoYW5naW5nICA9IHRydWU7CgogICAgICAgICAgICBpZiAoIWNoYW5naW5nKSB7CiAgICAgICAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMsIHRydWUpOwogICAgICAgICAgICAgIHRoaXMuY2hhbmdlZCA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLmF0dHJpYnV0ZXMsIHByZXYgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CgogICAgICAgICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyBvZiBgaWRgLgogICAgICAgICAgICBpZiAodGhpcy5pZEF0dHJpYnV0ZSBpbiBhdHRycykgdGhpcy5pZCA9IGF0dHJzW3RoaXMuaWRBdHRyaWJ1dGVdOwoKICAgICAgICAgICAgLy88Y3VzdG9tIGNvZGU+CiAgICAgICAgICAgIGF0dHJzID0gb2JqVG9QYXRocyhhdHRycyk7CiAgICAgICAgICAgIC8vPC9jdXN0b20gY29kZT4KCiAgICAgICAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZSwgdXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAgICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CgogICAgICAgICAgICAgIC8vPGN1c3RvbSBjb2RlPjogVXNpbmcgZ2V0TmVzdGVkLCBzZXROZXN0ZWQgYW5kIGRlbGV0ZU5lc3RlZAogICAgICAgICAgICAgIGlmICghXy5pc0VxdWFsKGdldE5lc3RlZChjdXJyZW50LCBhdHRyKSwgdmFsKSkgY2hhbmdlcy5wdXNoKGF0dHIpOwogICAgICAgICAgICAgIGlmICghXy5pc0VxdWFsKGdldE5lc3RlZChwcmV2LCBhdHRyKSwgdmFsKSkgewogICAgICAgICAgICAgICAgc2V0TmVzdGVkKHRoaXMuY2hhbmdlZCwgYXR0ciwgdmFsKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlTmVzdGVkKHRoaXMuY2hhbmdlZCwgYXR0cik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVuc2V0ID8gZGVsZXRlTmVzdGVkKGN1cnJlbnQsIGF0dHIpIDogc2V0TmVzdGVkKGN1cnJlbnQsIGF0dHIsIHZhbCk7CiAgICAgICAgICAgICAgLy88L2N1c3RvbSBjb2RlPgogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSB0cnVlOwoKICAgICAgICAgICAgICAvLzxjdXN0b20gY29kZT4KICAgICAgICAgICAgICB2YXIgc2VwYXJhdG9yID0gRGVlcE1vZGVsLmtleVBhdGhTZXBhcmF0b3I7CiAgICAgICAgICAgICAgdmFyIGFscmVhZHlUcmlnZ2VyZWQgPSB7fTsgLy8gKiBAcmVzdG9yZXIKCiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGtleSA9IGNoYW5nZXNbaV07CgogICAgICAgICAgICAgICAgaWYgKCFhbHJlYWR5VHJpZ2dlcmVkLmhhc093blByb3BlcnR5KGtleSkgfHwgIWFscmVhZHlUcmlnZ2VyZWRba2V5XSkgeyAvLyAqIEByZXN0b3JlcgogICAgICAgICAgICAgICAgICBhbHJlYWR5VHJpZ2dlcmVkW2tleV0gPSB0cnVlOyAvLyAqIEByZXN0b3JlcgogICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsga2V5LCB0aGlzLCBnZXROZXN0ZWQoY3VycmVudCwga2V5KSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9IC8vICogQHJlc3RvcmVyCgogICAgICAgICAgICAgICAgdmFyIGZpZWxkcyA9IGtleS5zcGxpdChzZXBhcmF0b3IpOwoKICAgICAgICAgICAgICAgIC8vVHJpZ2dlciBjaGFuZ2UgZXZlbnRzIGZvciBwYXJlbnQga2V5cyB3aXRoIHdpbGRjYXJkICgqKSBub3RhdGlvbgogICAgICAgICAgICAgICAgZm9yKHZhciBuID0gZmllbGRzLmxlbmd0aCAtIDE7IG4gPiAwOyBuLS0pIHsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEtleSA9IF8uZmlyc3QoZmllbGRzLCBuKS5qb2luKHNlcGFyYXRvciksCiAgICAgICAgICAgICAgICAgICAgICB3aWxkY2FyZEtleSA9IHBhcmVudEtleSArIHNlcGFyYXRvciArICcqJzsKCiAgICAgICAgICAgICAgICAgIGlmICghYWxyZWFkeVRyaWdnZXJlZC5oYXNPd25Qcm9wZXJ0eSh3aWxkY2FyZEtleSkgfHwgIWFscmVhZHlUcmlnZ2VyZWRbd2lsZGNhcmRLZXldKSB7IC8vICogQHJlc3RvcmVyCiAgICAgICAgICAgICAgICAgICAgYWxyZWFkeVRyaWdnZXJlZFt3aWxkY2FyZEtleV0gPSB0cnVlOyAvLyAqIEByZXN0b3JlcgogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyB3aWxkY2FyZEtleSwgdGhpcywgZ2V0TmVzdGVkKGN1cnJlbnQsIHBhcmVudEtleSksIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICB9IC8vICogQHJlc3RvcmVyCgogICAgICAgICAgICAgICAgICAvLyArIEByZXN0b3JlcgogICAgICAgICAgICAgICAgICBpZiAoIWFscmVhZHlUcmlnZ2VyZWQuaGFzT3duUHJvcGVydHkocGFyZW50S2V5KSB8fCAhYWxyZWFkeVRyaWdnZXJlZFtwYXJlbnRLZXldKSB7CiAgICAgICAgICAgICAgICAgICAgYWxyZWFkeVRyaWdnZXJlZFtwYXJlbnRLZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgcGFyZW50S2V5LCB0aGlzLCBnZXROZXN0ZWQoY3VycmVudCwgcGFyZW50S2V5KSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gLSBAcmVzdG9yZXIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vPC9jdXN0b20gY29kZT4KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjaGFuZ2luZykgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIGlmICghc2lsZW50KSB7CiAgICAgICAgICAgICAgd2hpbGUgKHRoaXMuX3BlbmRpbmcpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQogICAgICAgIC8vIHRvIHNpbGVuY2UgaXQuCiAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgIHZhciBhdHRycyA9IHt9OwogICAgICAgICAgdmFyIHNoYWxsb3dBdHRyaWJ1dGVzID0gb2JqVG9QYXRocyh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHNoYWxsb3dBdHRyaWJ1dGVzKSBhdHRyc1trZXldID0gdm9pZCAwOwogICAgICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgICAgIH0sCgogICAgICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgICAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CiAgICAgICAgICByZXR1cm4gZ2V0TmVzdGVkKHRoaXMuY2hhbmdlZCwgYXR0cikgIT09IHVuZGVmaW5lZDsKICAgICAgICB9LAoKICAgICAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgogICAgICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgICAgIC8vIHBhcnRzIG9mIGEgdmlldyBuZWVkIHRvIGJlIHVwZGF0ZWQgYW5kL29yIHdoYXQgYXR0cmlidXRlcyBuZWVkIHRvIGJlCiAgICAgICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAgICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAgICAgLy8gZGV0ZXJtaW5pbmcgaWYgdGhlcmUgKndvdWxkIGJlKiBhIGNoYW5nZS4KICAgICAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24oZGlmZikgewogICAgICAgICAgLy88Y3VzdG9tIGNvZGU+OiBvYmpUb1BhdGhzCiAgICAgICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IG9ialRvUGF0aHModGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwogICAgICAgICAgLy88L2N1c3RvbSBjb2RlPgoKICAgICAgICAgIHZhciBvbGQgPSB0aGlzLl9jaGFuZ2luZyA/IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA6IHRoaXMuYXR0cmlidXRlczsKCiAgICAgICAgICAvLzxjdXN0b20gY29kZT4KICAgICAgICAgIGRpZmYgPSBvYmpUb1BhdGhzKGRpZmYpOwogICAgICAgICAgb2xkID0gb2JqVG9QYXRocyhvbGQpOwogICAgICAgICAgLy88L2N1c3RvbSBjb2RlPgoKICAgICAgICAgIHZhciB2YWwsIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7CiAgICAgICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgICAgIH0sCgogICAgICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgICAgIC8vIGAiY2hhbmdlImAgZXZlbnQgd2FzIGZpcmVkLgogICAgICAgIHByZXZpb3VzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwoKICAgICAgICAgIC8vPGN1c3RvbSBjb2RlPgogICAgICAgICAgcmV0dXJuIGdldE5lc3RlZCh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMsIGF0dHIpOwogICAgICAgICAgLy88L2N1c3RvbSBjb2RlPgogICAgICAgIH0sCgogICAgICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cwogICAgICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICAgICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vPGN1c3RvbSBjb2RlPgogICAgICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzLCB0cnVlKTsKICAgICAgICAgIC8vPC9jdXN0b20gY29kZT4KICAgICAgICB9CiAgICB9KTsKCgogICAgLy9Db25maWc7IG92ZXJyaWRlIGluIHlvdXIgYXBwIHRvIGN1c3RvbWlzZQogICAgRGVlcE1vZGVsLmtleVBhdGhTZXBhcmF0b3IgPSAnLic7CgoKICAgIC8vRXhwb3J0cwogICAgQmFja2JvbmUuRGVlcE1vZGVsID0gRGVlcE1vZGVsOwoKICAgIC8vRm9yIHVzZSBpbiBOb2RlSlMKICAgIGlmICh0eXBlb2YgbW9kdWxlICE9ICd1bmRlZmluZWQnKSBtb2R1bGUuZXhwb3J0cyA9IERlZXBNb2RlbDsKCiAgICByZXR1cm4gQmFja2JvbmU7Cgp9KSk7CgovLyBCYWNrYm9uZS5WYWxpZGF0aW9uIHYwLjguMgovLwovLyBDb3B5cmlnaHQgKGMpIDIwMTEtMjAxMyBUaG9tYXMgUGVkZXJzZW4KLy8gRGlzdHJpYnV0ZWQgdW5kZXIgTUlUIExpY2Vuc2UKLy8KLy8gRG9jdW1lbnRhdGlvbiBhbmQgZnVsbCBsaWNlbnNlIGF2YWlsYWJsZSBhdDoKLy8gaHR0cDovL3RoZWRlcnNlbi5jb20vcHJvamVjdHMvYmFja2JvbmUtdmFsaWRhdGlvbgooZnVuY3Rpb24gKGZhY3RvcnkpIHsKICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkocmVxdWlyZSgnYmFja2JvbmUnKSwgcmVxdWlyZSgndW5kZXJzY29yZScpKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgZGVmaW5lKCdiYWNrYm9uZS52YWxpZGF0aW9uJyxbJ2JhY2tib25lJywgJ3VuZGVyc2NvcmUnXSwgZmFjdG9yeSk7CiAgfQp9KGZ1bmN0aW9uIChCYWNrYm9uZSwgXykgewogIEJhY2tib25lLlZhbGlkYXRpb24gPSAoZnVuY3Rpb24oXyl7CiAgICAKICAKICAgIC8vIERlZmF1bHQgb3B0aW9ucwogICAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgCiAgICB2YXIgZGVmYXVsdE9wdGlvbnMgPSB7CiAgICAgIGZvcmNlVXBkYXRlOiBmYWxzZSwKICAgICAgc2VsZWN0b3I6ICduYW1lJywKICAgICAgbGFiZWxGb3JtYXR0ZXI6ICdzZW50ZW5jZUNhc2UnLAogICAgICB2YWxpZDogRnVuY3Rpb24ucHJvdG90eXBlLAogICAgICBpbnZhbGlkOiBGdW5jdGlvbi5wcm90b3R5cGUKICAgIH07CiAgCiAgCiAgICAvLyBIZWxwZXIgZnVuY3Rpb25zCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tCiAgCiAgICAvLyBGb3JtYXR0aW5nIGZ1bmN0aW9ucyB1c2VkIGZvciBmb3JtYXR0aW5nIGVycm9yIG1lc3NhZ2VzCiAgICB2YXIgZm9ybWF0RnVuY3Rpb25zID0gewogICAgICAvLyBVc2VzIHRoZSBjb25maWd1cmVkIGxhYmVsIGZvcm1hdHRlciB0byBmb3JtYXQgdGhlIGF0dHJpYnV0ZSBuYW1lCiAgICAgIC8vIHRvIG1ha2UgaXQgbW9yZSByZWFkYWJsZSBmb3IgdGhlIHVzZXIKICAgICAgZm9ybWF0TGFiZWw6IGZ1bmN0aW9uKGF0dHJOYW1lLCBtb2RlbCkgewogICAgICAgIHJldHVybiBkZWZhdWx0TGFiZWxGb3JtYXR0ZXJzW2RlZmF1bHRPcHRpb25zLmxhYmVsRm9ybWF0dGVyXShhdHRyTmFtZSwgbW9kZWwpOwogICAgICB9LAogIAogICAgICAvLyBSZXBsYWNlcyBudW1tZXJpYyBwbGFjZWhvbGRlcnMgbGlrZSB7MH0gaW4gYSBzdHJpbmcgd2l0aCBhcmd1bWVudHMKICAgICAgLy8gcGFzc2VkIHRvIHRoZSBmdW5jdGlvbgogICAgICBmb3JtYXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSwKICAgICAgICAgICAgdGV4dCA9IGFyZ3Muc2hpZnQoKTsKICAgICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKC9ceyhcZCspXH0vZywgZnVuY3Rpb24obWF0Y2gsIG51bWJlcikgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiBhcmdzW251bWJlcl0gIT09ICd1bmRlZmluZWQnID8gYXJnc1tudW1iZXJdIDogbWF0Y2g7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgCiAgICAvLyBGbGF0dGVucyBhbiBvYmplY3QKICAgIC8vIGVnOgogICAgLy8KICAgIC8vICAgICB2YXIgbyA9IHsKICAgIC8vICAgICAgIGFkZHJlc3M6IHsKICAgIC8vICAgICAgICAgc3RyZWV0OiAnU3RyZWV0JywKICAgIC8vICAgICAgICAgemlwOiAxMjM0CiAgICAvLyAgICAgICB9CiAgICAvLyAgICAgfTsKICAgIC8vCiAgICAvLyBiZWNvbWVzOgogICAgLy8KICAgIC8vICAgICB2YXIgbyA9IHsKICAgIC8vICAgICAgICdhZGRyZXNzLnN0cmVldCc6ICdTdHJlZXQnLAogICAgLy8gICAgICAgJ2FkZHJlc3MuemlwJzogMTIzNAogICAgLy8gICAgIH07CiAgICB2YXIgZmxhdHRlbiA9IGZ1bmN0aW9uIChvYmosIGludG8sIHByZWZpeCkgewogICAgICBpbnRvID0gaW50byB8fCB7fTsKICAgICAgcHJlZml4ID0gcHJlZml4IHx8ICcnOwogIAogICAgICBfLmVhY2gob2JqLCBmdW5jdGlvbih2YWwsIGtleSkgewogICAgICAgIGlmKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICBpZiAodmFsICYmIHR5cGVvZiB2YWwgPT09ICdvYmplY3QnICYmICEoCiAgICAgICAgICAgIHZhbCBpbnN0YW5jZW9mIEFycmF5IHx8CiAgICAgICAgICAgIHZhbCBpbnN0YW5jZW9mIERhdGUgfHwKICAgICAgICAgICAgdmFsIGluc3RhbmNlb2YgUmVnRXhwIHx8CiAgICAgICAgICAgIHZhbCBpbnN0YW5jZW9mIEJhY2tib25lLk1vZGVsIHx8CiAgICAgICAgICAgIHZhbCBpbnN0YW5jZW9mIEJhY2tib25lLkNvbGxlY3Rpb24pCiAgICAgICAgICApIHsKICAgICAgICAgICAgZmxhdHRlbih2YWwsIGludG8sIHByZWZpeCArIGtleSArICcuJyk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgaW50b1twcmVmaXggKyBrZXldID0gdmFsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBpbnRvOwogICAgfTsKICAKICAgIC8vIFZhbGlkYXRpb24KICAgIC8vIC0tLS0tLS0tLS0KICAKICAgIHZhciBWYWxpZGF0aW9uID0gKGZ1bmN0aW9uKCl7CiAgCiAgICAgIC8vIFJldHVybnMgYW4gb2JqZWN0IHdpdGggdW5kZWZpbmVkIHByb3BlcnRpZXMgZm9yIGFsbAogICAgICAvLyBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCB0aGF0IGhhcyBkZWZpbmVkIG9uZSBvciBtb3JlCiAgICAgIC8vIHZhbGlkYXRpb24gcnVsZXMuCiAgICAgIHZhciBnZXRWYWxpZGF0ZWRBdHRycyA9IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIF8ucmVkdWNlKF8ua2V5cyhfLnJlc3VsdChtb2RlbCwgJ3ZhbGlkYXRpb24nKSB8fCB7fSksIGZ1bmN0aW9uKG1lbW8sIGtleSkgewogICAgICAgICAgbWVtb1trZXldID0gdm9pZCAwOwogICAgICAgICAgcmV0dXJuIG1lbW87CiAgICAgICAgfSwge30pOwogICAgICB9OwogIAogICAgICAvLyBMb29rcyBvbiB0aGUgbW9kZWwgZm9yIHZhbGlkYXRpb25zIGZvciBhIHNwZWNpZmllZAogICAgICAvLyBhdHRyaWJ1dGUuIFJldHVybnMgYW4gYXJyYXkgb2YgYW55IHZhbGlkYXRvcnMgZGVmaW5lZCwKICAgICAgLy8gb3IgYW4gZW1wdHkgYXJyYXkgaWYgbm9uZSBpcyBkZWZpbmVkLgogICAgICB2YXIgZ2V0VmFsaWRhdG9ycyA9IGZ1bmN0aW9uKG1vZGVsLCBhdHRyKSB7CiAgICAgICAgdmFyIGF0dHJWYWxpZGF0aW9uU2V0ID0gbW9kZWwudmFsaWRhdGlvbiA/IF8ucmVzdWx0KG1vZGVsLCAndmFsaWRhdGlvbicpW2F0dHJdIHx8IHt9IDoge307CiAgCiAgICAgICAgLy8gSWYgdGhlIHZhbGlkYXRvciBpcyBhIGZ1bmN0aW9uIG9yIGEgc3RyaW5nLCB3cmFwIGl0IGluIGEgZnVuY3Rpb24gdmFsaWRhdG9yCiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihhdHRyVmFsaWRhdGlvblNldCkgfHwgXy5pc1N0cmluZyhhdHRyVmFsaWRhdGlvblNldCkpIHsKICAgICAgICAgIGF0dHJWYWxpZGF0aW9uU2V0ID0gewogICAgICAgICAgICBmbjogYXR0clZhbGlkYXRpb25TZXQKICAgICAgICAgIH07CiAgICAgICAgfQogIAogICAgICAgIC8vIFN0aWNrIHRoZSB2YWxpZGF0b3Igb2JqZWN0IGludG8gYW4gYXJyYXkKICAgICAgICBpZighXy5pc0FycmF5KGF0dHJWYWxpZGF0aW9uU2V0KSkgewogICAgICAgICAgYXR0clZhbGlkYXRpb25TZXQgPSBbYXR0clZhbGlkYXRpb25TZXRdOwogICAgICAgIH0KICAKICAgICAgICAvLyBSZWR1Y2VzIHRoZSBhcnJheSBvZiB2YWxpZGF0b3JzIGludG8gYSBuZXcgYXJyYXkgd2l0aCBvYmplY3RzCiAgICAgICAgLy8gd2l0aCBhIHZhbGlkYXRpb24gbWV0aG9kIHRvIGNhbGwsIHRoZSB2YWx1ZSB0byB2YWxpZGF0ZSBhZ2FpbnN0CiAgICAgICAgLy8gYW5kIHRoZSBzcGVjaWZpZWQgZXJyb3IgbWVzc2FnZSwgaWYgYW55CiAgICAgICAgcmV0dXJuIF8ucmVkdWNlKGF0dHJWYWxpZGF0aW9uU2V0LCBmdW5jdGlvbihtZW1vLCBhdHRyVmFsaWRhdGlvbikgewogICAgICAgICAgXy5lYWNoKF8ud2l0aG91dChfLmtleXMoYXR0clZhbGlkYXRpb24pLCAnbXNnJyksIGZ1bmN0aW9uKHZhbGlkYXRvcikgewogICAgICAgICAgICBtZW1vLnB1c2goewogICAgICAgICAgICAgIGZuOiBkZWZhdWx0VmFsaWRhdG9yc1t2YWxpZGF0b3JdLAogICAgICAgICAgICAgIHZhbDogYXR0clZhbGlkYXRpb25bdmFsaWRhdG9yXSwKICAgICAgICAgICAgICBtc2c6IGF0dHJWYWxpZGF0aW9uLm1zZwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIG1lbW87CiAgICAgICAgfSwgW10pOwogICAgICB9OwogIAogICAgICAvLyBWYWxpZGF0ZXMgYW4gYXR0cmlidXRlIGFnYWluc3QgYWxsIHZhbGlkYXRvcnMgZGVmaW5lZAogICAgICAvLyBmb3IgdGhhdCBhdHRyaWJ1dGUuIElmIG9uZSBvciBtb3JlIGVycm9ycyBhcmUgZm91bmQsCiAgICAgIC8vIHRoZSBmaXJzdCBlcnJvciBtZXNzYWdlIGlzIHJldHVybmVkLgogICAgICAvLyBJZiB0aGUgYXR0cmlidXRlIGlzIHZhbGlkLCBhbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAgICAgIHZhciB2YWxpZGF0ZUF0dHIgPSBmdW5jdGlvbihtb2RlbCwgYXR0ciwgdmFsdWUsIGNvbXB1dGVkKSB7CiAgICAgICAgLy8gUmVkdWNlcyB0aGUgYXJyYXkgb2YgdmFsaWRhdG9ycyB0byBhbiBlcnJvciBtZXNzYWdlIGJ5CiAgICAgICAgLy8gYXBwbHlpbmcgYWxsIHRoZSB2YWxpZGF0b3JzIGFuZCByZXR1cm5pbmcgdGhlIGZpcnN0IGVycm9yCiAgICAgICAgLy8gbWVzc2FnZSwgaWYgYW55LgogICAgICAgIHJldHVybiBfLnJlZHVjZShnZXRWYWxpZGF0b3JzKG1vZGVsLCBhdHRyKSwgZnVuY3Rpb24obWVtbywgdmFsaWRhdG9yKXsKICAgICAgICAgIC8vIFBhc3MgdGhlIGZvcm1hdCBmdW5jdGlvbnMgcGx1cyB0aGUgZGVmYXVsdAogICAgICAgICAgLy8gdmFsaWRhdG9ycyBhcyB0aGUgY29udGV4dCB0byB0aGUgdmFsaWRhdG9yCiAgICAgICAgICB2YXIgY3R4ID0gXy5leHRlbmQoe30sIGZvcm1hdEZ1bmN0aW9ucywgZGVmYXVsdFZhbGlkYXRvcnMpLAogICAgICAgICAgICAgIHJlc3VsdCA9IHZhbGlkYXRvci5mbi5jYWxsKGN0eCwgdmFsdWUsIGF0dHIsIHZhbGlkYXRvci52YWwsIG1vZGVsLCBjb21wdXRlZCk7CiAgCiAgICAgICAgICBpZihyZXN1bHQgPT09IGZhbHNlIHx8IG1lbW8gPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZXN1bHQgJiYgIW1lbW8pIHsKICAgICAgICAgICAgcmV0dXJuIF8ucmVzdWx0KHZhbGlkYXRvciwgJ21zZycpIHx8IHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtZW1vOwogICAgICAgIH0sICcnKTsKICAgICAgfTsKICAKICAgICAgLy8gTG9vcHMgdGhyb3VnaCB0aGUgbW9kZWwncyBhdHRyaWJ1dGVzIGFuZCB2YWxpZGF0ZXMgdGhlbSBhbGwuCiAgICAgIC8vIFJldHVybnMgYW5kIG9iamVjdCBjb250YWluaW5nIG5hbWVzIG9mIGludmFsaWQgYXR0cmlidXRlcwogICAgICAvLyBhcyB3ZWxsIGFzIGVycm9yIG1lc3NhZ2VzLgogICAgICB2YXIgdmFsaWRhdGVNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsLCBhdHRycykgewogICAgICAgIHZhciBlcnJvciwKICAgICAgICAgICAgaW52YWxpZEF0dHJzID0ge30sCiAgICAgICAgICAgIGlzVmFsaWQgPSB0cnVlLAogICAgICAgICAgICBjb21wdXRlZCA9IF8uY2xvbmUoYXR0cnMpLAogICAgICAgICAgICBmbGF0dGVuZWQgPSBmbGF0dGVuKGF0dHJzKTsKICAKICAgICAgICBfLmVhY2goZmxhdHRlbmVkLCBmdW5jdGlvbih2YWwsIGF0dHIpIHsKICAgICAgICAgIGVycm9yID0gdmFsaWRhdGVBdHRyKG1vZGVsLCBhdHRyLCB2YWwsIGNvbXB1dGVkKTsKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICBpbnZhbGlkQXR0cnNbYXR0cl0gPSBlcnJvcjsKICAgICAgICAgICAgaXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0pOwogIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICBpbnZhbGlkQXR0cnM6IGludmFsaWRBdHRycywKICAgICAgICAgIGlzVmFsaWQ6IGlzVmFsaWQKICAgICAgICB9OwogICAgICB9OwogIAogICAgICAvLyBDb250YWlucyB0aGUgbWV0aG9kcyB0aGF0IGFyZSBtaXhlZCBpbiBvbiB0aGUgbW9kZWwgd2hlbiBiaW5kaW5nCiAgICAgIHZhciBtaXhpbiA9IGZ1bmN0aW9uKHZpZXcsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gewogIAogICAgICAgICAgLy8gQ2hlY2sgd2hldGhlciBvciBub3QgYSB2YWx1ZSwgb3IgYSBoYXNoIG9mIHZhbHVlcwogICAgICAgICAgLy8gcGFzc2VzIHZhbGlkYXRpb24gd2l0aG91dCB1cGRhdGluZyB0aGUgbW9kZWwKICAgICAgICAgIHByZVZhbGlkYXRlOiBmdW5jdGlvbihhdHRyLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgICAgICAgICByZXN1bHQgPSB7fSwKICAgICAgICAgICAgICAgIGVycm9yOwogIAogICAgICAgICAgICBpZihfLmlzT2JqZWN0KGF0dHIpKXsKICAgICAgICAgICAgICBfLmVhY2goYXR0ciwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgZXJyb3IgPSBzZWxmLnByZVZhbGlkYXRlKGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYoZXJyb3IpewogICAgICAgICAgICAgICAgICByZXN1bHRba2V5XSA9IGVycm9yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogIAogICAgICAgICAgICAgIHJldHVybiBfLmlzRW1wdHkocmVzdWx0KSA/IHVuZGVmaW5lZCA6IHJlc3VsdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gdmFsaWRhdGVBdHRyKHRoaXMsIGF0dHIsIHZhbHVlLCBfLmV4dGVuZCh7fSwgdGhpcy5hdHRyaWJ1dGVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgCiAgICAgICAgICAvLyBDaGVjayB0byBzZWUgaWYgYW4gYXR0cmlidXRlLCBhbiBhcnJheSBvZiBhdHRyaWJ1dGVzIG9yIHRoZQogICAgICAgICAgLy8gZW50aXJlIG1vZGVsIGlzIHZhbGlkLiBQYXNzaW5nIHRydWUgd2lsbCBmb3JjZSBhIHZhbGlkYXRpb24KICAgICAgICAgIC8vIG9mIHRoZSBtb2RlbC4KICAgICAgICAgIGlzVmFsaWQ6IGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgICAgICB2YXIgZmxhdHRlbmVkID0gZmxhdHRlbih0aGlzLmF0dHJpYnV0ZXMpOwogIAogICAgICAgICAgICBpZihfLmlzU3RyaW5nKG9wdGlvbikpewogICAgICAgICAgICAgIHJldHVybiAhdmFsaWRhdGVBdHRyKHRoaXMsIG9wdGlvbiwgZmxhdHRlbmVkW29wdGlvbl0sIF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihfLmlzQXJyYXkob3B0aW9uKSl7CiAgICAgICAgICAgICAgcmV0dXJuIF8ucmVkdWNlKG9wdGlvbiwgZnVuY3Rpb24obWVtbywgYXR0cikgewogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW8gJiYgIXZhbGlkYXRlQXR0cih0aGlzLCBhdHRyLCBmbGF0dGVuZWRbYXR0cl0sIF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMpKTsKICAgICAgICAgICAgICB9LCB0cnVlLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb24gPT09IHRydWUpIHsKICAgICAgICAgICAgICB0aGlzLnZhbGlkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGlvbiA/IHRoaXMuX2lzVmFsaWQgOiB0cnVlOwogICAgICAgICAgfSwKICAKICAgICAgICAgIC8vIFRoaXMgaXMgY2FsbGVkIGJ5IEJhY2tib25lIHdoZW4gaXQgbmVlZHMgdG8gcGVyZm9ybSB2YWxpZGF0aW9uLgogICAgICAgICAgLy8gWW91IGNhbiBjYWxsIGl0IG1hbnVhbGx5IHdpdGhvdXQgYW55IHBhcmFtZXRlcnMgdG8gdmFsaWRhdGUgdGhlCiAgICAgICAgICAvLyBlbnRpcmUgbW9kZWwuCiAgICAgICAgICB2YWxpZGF0ZTogZnVuY3Rpb24oYXR0cnMsIHNldE9wdGlvbnMpewogICAgICAgICAgICB2YXIgbW9kZWwgPSB0aGlzLAogICAgICAgICAgICAgICAgdmFsaWRhdGVBbGwgPSAhYXR0cnMsCiAgICAgICAgICAgICAgICBvcHQgPSBfLmV4dGVuZCh7fSwgb3B0aW9ucywgc2V0T3B0aW9ucyksCiAgICAgICAgICAgICAgICB2YWxpZGF0ZWRBdHRycyA9IGdldFZhbGlkYXRlZEF0dHJzKG1vZGVsKSwKICAgICAgICAgICAgICAgIGFsbEF0dHJzID0gXy5leHRlbmQoe30sIHZhbGlkYXRlZEF0dHJzLCBtb2RlbC5hdHRyaWJ1dGVzLCBhdHRycyksCiAgICAgICAgICAgICAgICBjaGFuZ2VkQXR0cnMgPSBmbGF0dGVuKGF0dHJzIHx8IGFsbEF0dHJzKSwKICAKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHZhbGlkYXRlTW9kZWwobW9kZWwsIGFsbEF0dHJzKTsKICAKICAgICAgICAgICAgbW9kZWwuX2lzVmFsaWQgPSByZXN1bHQuaXNWYWxpZDsKICAKICAgICAgICAgICAgLy8gQWZ0ZXIgdmFsaWRhdGlvbiBpcyBwZXJmb3JtZWQsIGxvb3AgdGhyb3VnaCBhbGwgY2hhbmdlZCBhdHRyaWJ1dGVzCiAgICAgICAgICAgIC8vIGFuZCBjYWxsIHRoZSB2YWxpZCBjYWxsYmFja3Mgc28gdGhlIHZpZXcgaXMgdXBkYXRlZC4KICAgICAgICAgICAgXy5lYWNoKHZhbGlkYXRlZEF0dHJzLCBmdW5jdGlvbih2YWwsIGF0dHIpewogICAgICAgICAgICAgIHZhciBpbnZhbGlkID0gcmVzdWx0LmludmFsaWRBdHRycy5oYXNPd25Qcm9wZXJ0eShhdHRyKTsKICAgICAgICAgICAgICBpZighaW52YWxpZCl7CiAgICAgICAgICAgICAgICBvcHQudmFsaWQodmlldywgYXR0ciwgb3B0LnNlbGVjdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogIAogICAgICAgICAgICAvLyBBZnRlciB2YWxpZGF0aW9uIGlzIHBlcmZvcm1lZCwgbG9vcCB0aHJvdWdoIGFsbCBjaGFuZ2VkIGF0dHJpYnV0ZXMKICAgICAgICAgICAgLy8gYW5kIGNhbGwgdGhlIGludmFsaWQgY2FsbGJhY2sgc28gdGhlIHZpZXcgaXMgdXBkYXRlZC4KICAgICAgICAgICAgXy5lYWNoKHZhbGlkYXRlZEF0dHJzLCBmdW5jdGlvbih2YWwsIGF0dHIpewogICAgICAgICAgICAgIHZhciBpbnZhbGlkID0gcmVzdWx0LmludmFsaWRBdHRycy5oYXNPd25Qcm9wZXJ0eShhdHRyKSwKICAgICAgICAgICAgICAgICAgY2hhbmdlZCA9IGNoYW5nZWRBdHRycy5oYXNPd25Qcm9wZXJ0eShhdHRyKTsKICAKICAgICAgICAgICAgICBpZihpbnZhbGlkICYmIChjaGFuZ2VkIHx8IHZhbGlkYXRlQWxsKSl7CiAgICAgICAgICAgICAgICBvcHQuaW52YWxpZCh2aWV3LCBhdHRyLCByZXN1bHQuaW52YWxpZEF0dHJzW2F0dHJdLCBvcHQuc2VsZWN0b3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgCiAgICAgICAgICAgIC8vIFRyaWdnZXIgdmFsaWRhdGVkIGV2ZW50cy4KICAgICAgICAgICAgLy8gTmVlZCB0byBkZWZlciB0aGlzIHNvIHRoZSBtb2RlbCBpcyBhY3R1YWxseSB1cGRhdGVkIGJlZm9yZQogICAgICAgICAgICAvLyB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkLgogICAgICAgICAgICBfLmRlZmVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3ZhbGlkYXRlZCcsIG1vZGVsLl9pc1ZhbGlkLCBtb2RlbCwgcmVzdWx0LmludmFsaWRBdHRycyk7CiAgICAgICAgICAgICAgbW9kZWwudHJpZ2dlcigndmFsaWRhdGVkOicgKyAobW9kZWwuX2lzVmFsaWQgPyAndmFsaWQnIDogJ2ludmFsaWQnKSwgbW9kZWwsIHJlc3VsdC5pbnZhbGlkQXR0cnMpOwogICAgICAgICAgICB9KTsKICAKICAgICAgICAgICAgLy8gUmV0dXJuIGFueSBlcnJvciBtZXNzYWdlcyB0byBCYWNrYm9uZSwgdW5sZXNzIHRoZSBmb3JjZVVwZGF0ZSBmbGFnIGlzIHNldC4KICAgICAgICAgICAgLy8gVGhlbiB3ZSBkbyBub3QgcmV0dXJuIGFueXRoaW5nIGFuZCBmb29scyBCYWNrYm9uZSB0byBiZWxpZXZlIHRoZSB2YWxpZGF0aW9uIHdhcwogICAgICAgICAgICAvLyBhIHN1Y2Nlc3MuIFRoYXQgd2F5IEJhY2tib25lIHdpbGwgdXBkYXRlIHRoZSBtb2RlbCByZWdhcmRsZXNzLgogICAgICAgICAgICBpZiAoIW9wdC5mb3JjZVVwZGF0ZSAmJiBfLmludGVyc2VjdGlvbihfLmtleXMocmVzdWx0LmludmFsaWRBdHRycyksIF8ua2V5cyhjaGFuZ2VkQXR0cnMpKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5pbnZhbGlkQXR0cnM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9OwogIAogICAgICAvLyBIZWxwZXIgdG8gbWl4IGluIHZhbGlkYXRpb24gb24gYSBtb2RlbAogICAgICB2YXIgYmluZE1vZGVsID0gZnVuY3Rpb24odmlldywgbW9kZWwsIG9wdGlvbnMpIHsKICAgICAgICBfLmV4dGVuZChtb2RlbCwgbWl4aW4odmlldywgb3B0aW9ucykpOwogICAgICB9OwogIAogICAgICAvLyBSZW1vdmVzIHRoZSBtZXRob2RzIGFkZGVkIHRvIGEgbW9kZWwKICAgICAgdmFyIHVuYmluZE1vZGVsID0gZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICBkZWxldGUgbW9kZWwudmFsaWRhdGU7CiAgICAgICAgZGVsZXRlIG1vZGVsLnByZVZhbGlkYXRlOwogICAgICAgIGRlbGV0ZSBtb2RlbC5pc1ZhbGlkOwogICAgICB9OwogIAogICAgICAvLyBNaXggaW4gdmFsaWRhdGlvbiBvbiBhIG1vZGVsIHdoZW5ldmVyIGEgbW9kZWwgaXMKICAgICAgLy8gYWRkZWQgdG8gYSBjb2xsZWN0aW9uCiAgICAgIHZhciBjb2xsZWN0aW9uQWRkID0gZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICBiaW5kTW9kZWwodGhpcy52aWV3LCBtb2RlbCwgdGhpcy5vcHRpb25zKTsKICAgICAgfTsKICAKICAgICAgLy8gUmVtb3ZlIHZhbGlkYXRpb24gZnJvbSBhIG1vZGVsIHdoZW5ldmVyIGEgbW9kZWwgaXMKICAgICAgLy8gcmVtb3ZlZCBmcm9tIGEgY29sbGVjdGlvbgogICAgICB2YXIgY29sbGVjdGlvblJlbW92ZSA9IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgdW5iaW5kTW9kZWwobW9kZWwpOwogICAgICB9OwogIAogICAgICAvLyBSZXR1cm5zIHRoZSBwdWJsaWMgbWV0aG9kcyBvbiBCYWNrYm9uZS5WYWxpZGF0aW9uCiAgICAgIHJldHVybiB7CiAgCiAgICAgICAgLy8gQ3VycmVudCB2ZXJzaW9uIG9mIHRoZSBsaWJyYXJ5CiAgICAgICAgdmVyc2lvbjogJzAuOC4yJywKICAKICAgICAgICAvLyBDYWxsZWQgdG8gY29uZmlndXJlIHRoZSBkZWZhdWx0IG9wdGlvbnMKICAgICAgICBjb25maWd1cmU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgIF8uZXh0ZW5kKGRlZmF1bHRPcHRpb25zLCBvcHRpb25zKTsKICAgICAgICB9LAogIAogICAgICAgIC8vIEhvb2tzIHVwIHZhbGlkYXRpb24gb24gYSB2aWV3IHdpdGggYSBtb2RlbAogICAgICAgIC8vIG9yIGNvbGxlY3Rpb24KICAgICAgICBiaW5kOiBmdW5jdGlvbih2aWV3LCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gXy5leHRlbmQoe30sIGRlZmF1bHRPcHRpb25zLCBkZWZhdWx0Q2FsbGJhY2tzLCBvcHRpb25zKTsKICAKICAgICAgICAgIHZhciBtb2RlbCA9IG9wdGlvbnMubW9kZWwgfHwgdmlldy5tb2RlbCwKICAgICAgICAgICAgICBjb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uIHx8IHZpZXcuY29sbGVjdGlvbjsKICAKICAgICAgICAgIGlmKHR5cGVvZiBtb2RlbCA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIGNvbGxlY3Rpb24gPT09ICd1bmRlZmluZWQnKXsKICAgICAgICAgICAgdGhyb3cgJ0JlZm9yZSB5b3UgZXhlY3V0ZSB0aGUgYmluZGluZyB5b3VyIHZpZXcgbXVzdCBoYXZlIGEgbW9kZWwgb3IgYSBjb2xsZWN0aW9uLlxuJyArCiAgICAgICAgICAgICAgICAgICdTZWUgaHR0cDovL3RoZWRlcnNlbi5jb20vcHJvamVjdHMvYmFja2JvbmUtdmFsaWRhdGlvbi8jdXNpbmctZm9ybS1tb2RlbC12YWxpZGF0aW9uIGZvciBtb3JlIGluZm9ybWF0aW9uLic7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpZihtb2RlbCkgewogICAgICAgICAgICBiaW5kTW9kZWwodmlldywgbW9kZWwsIG9wdGlvbnMpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZihjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgIGNvbGxlY3Rpb24uZWFjaChmdW5jdGlvbihtb2RlbCl7CiAgICAgICAgICAgICAgYmluZE1vZGVsKHZpZXcsIG1vZGVsLCBvcHRpb25zKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbGxlY3Rpb24uYmluZCgnYWRkJywgY29sbGVjdGlvbkFkZCwge3ZpZXc6IHZpZXcsIG9wdGlvbnM6IG9wdGlvbnN9KTsKICAgICAgICAgICAgY29sbGVjdGlvbi5iaW5kKCdyZW1vdmUnLCBjb2xsZWN0aW9uUmVtb3ZlKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIC8vIFJlbW92ZXMgdmFsaWRhdGlvbiBmcm9tIGEgdmlldyB3aXRoIGEgbW9kZWwKICAgICAgICAvLyBvciBjb2xsZWN0aW9uCiAgICAgICAgdW5iaW5kOiBmdW5jdGlvbih2aWV3LCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gXy5leHRlbmQoe30sIG9wdGlvbnMpOwogICAgICAgICAgdmFyIG1vZGVsID0gb3B0aW9ucy5tb2RlbCB8fCB2aWV3Lm1vZGVsLAogICAgICAgICAgICAgIGNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb24gfHwgdmlldy5jb2xsZWN0aW9uOwogIAogICAgICAgICAgaWYobW9kZWwpIHsKICAgICAgICAgICAgdW5iaW5kTW9kZWwobW9kZWwpOwogICAgICAgICAgfQogICAgICAgICAgaWYoY29sbGVjdGlvbikgewogICAgICAgICAgICBjb2xsZWN0aW9uLmVhY2goZnVuY3Rpb24obW9kZWwpewogICAgICAgICAgICAgIHVuYmluZE1vZGVsKG1vZGVsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbGxlY3Rpb24udW5iaW5kKCdhZGQnLCBjb2xsZWN0aW9uQWRkKTsKICAgICAgICAgICAgY29sbGVjdGlvbi51bmJpbmQoJ3JlbW92ZScsIGNvbGxlY3Rpb25SZW1vdmUpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgLy8gVXNlZCB0byBleHRlbmQgdGhlIEJhY2tib25lLk1vZGVsLnByb3RvdHlwZQogICAgICAgIC8vIHdpdGggdmFsaWRhdGlvbgogICAgICAgIG1peGluOiBtaXhpbihudWxsLCBkZWZhdWx0T3B0aW9ucykKICAgICAgfTsKICAgIH0oKSk7CiAgCiAgCiAgICAvLyBDYWxsYmFja3MKICAgIC8vIC0tLS0tLS0tLQogIAogICAgdmFyIGRlZmF1bHRDYWxsYmFja3MgPSBWYWxpZGF0aW9uLmNhbGxiYWNrcyA9IHsKICAKICAgICAgLy8gR2V0cyBjYWxsZWQgd2hlbiBhIHByZXZpb3VzbHkgaW52YWxpZCBmaWVsZCBpbiB0aGUKICAgICAgLy8gdmlldyBiZWNvbWVzIHZhbGlkLiBSZW1vdmVzIGFueSBlcnJvciBtZXNzYWdlLgogICAgICAvLyBTaG91bGQgYmUgb3ZlcnJpZGRlbiB3aXRoIGN1c3RvbSBmdW5jdGlvbmFsaXR5LgogICAgICB2YWxpZDogZnVuY3Rpb24odmlldywgYXR0ciwgc2VsZWN0b3IpIHsKICAgICAgICB2aWV3LiQoJ1snICsgc2VsZWN0b3IgKyAnfj0iJyArIGF0dHIgKyAnIl0nKQogICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ2ludmFsaWQnKQogICAgICAgICAgICAucmVtb3ZlQXR0cignZGF0YS1lcnJvcicpOwogICAgICB9LAogIAogICAgICAvLyBHZXRzIGNhbGxlZCB3aGVuIGEgZmllbGQgaW4gdGhlIHZpZXcgYmVjb21lcyBpbnZhbGlkLgogICAgICAvLyBBZGRzIGEgZXJyb3IgbWVzc2FnZS4KICAgICAgLy8gU2hvdWxkIGJlIG92ZXJyaWRkZW4gd2l0aCBjdXN0b20gZnVuY3Rpb25hbGl0eS4KICAgICAgaW52YWxpZDogZnVuY3Rpb24odmlldywgYXR0ciwgZXJyb3IsIHNlbGVjdG9yKSB7CiAgICAgICAgdmlldy4kKCdbJyArIHNlbGVjdG9yICsgJ349IicgKyBhdHRyICsgJyJdJykKICAgICAgICAgICAgLmFkZENsYXNzKCdpbnZhbGlkJykKICAgICAgICAgICAgLmF0dHIoJ2RhdGEtZXJyb3InLCBlcnJvcik7CiAgICAgIH0KICAgIH07CiAgCiAgCiAgICAvLyBQYXR0ZXJucwogICAgLy8gLS0tLS0tLS0KICAKICAgIHZhciBkZWZhdWx0UGF0dGVybnMgPSBWYWxpZGF0aW9uLnBhdHRlcm5zID0gewogICAgICAvLyBNYXRjaGVzIGFueSBkaWdpdChzKSAoaS5lLiAwLTkpCiAgICAgIGRpZ2l0czogL15cZCskLywKICAKICAgICAgLy8gTWF0Y2hlZCBhbnkgbnVtYmVyIChlLmcuIDEwMC4wMDApCiAgICAgIG51bWJlcjogL14tPyg/OlxkK3xcZHsxLDN9KD86LFxkezN9KSspKD86XC5cZCspPyQvLAogIAogICAgICAvLyBNYXRjaGVzIGEgdmFsaWQgZW1haWwgYWRkcmVzcyAoZS5nLiBtYWlsQGV4YW1wbGUuY29tKQogICAgICBlbWFpbDogL14oKChbYS16XXxcZHxbISNcJCUmJ1wqXCtcLVwvPVw/XF5fYHtcfH1+XXxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkrKFwuKFthLXpdfFxkfFshI1wkJSYnXCpcK1wtXC89XD9cXl9ge1x8fX5dfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSspKil8KChceDIyKSgoKChceDIwfFx4MDkpKihceDBkXHgwYSkpPyhceDIwfFx4MDkpKyk/KChbXHgwMS1ceDA4XHgwYlx4MGNceDBlLVx4MWZceDdmXXxceDIxfFtceDIzLVx4NWJdfFtceDVkLVx4N2VdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoXFwoW1x4MDEtXHgwOVx4MGJceDBjXHgwZC1ceDdmXXxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkpKSkqKCgoXHgyMHxceDA5KSooXHgwZFx4MGEpKT8oXHgyMHxceDA5KSspPyhceDIyKSkpQCgoKFthLXpdfFxkfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoKFthLXpdfFxkfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKShbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkqKFthLXpdfFxkfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSkpXC4pKygoW2Etel18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCgoW2Etel18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKFthLXpdfFxkfC18XC58X3x+fFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSooW2Etel18W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKSkkL2ksCiAgCiAgICAgIC8vIE1hdGhlcyBhbnkgdmFsaWQgdXJsIChlLmcuIGh0dHA6Ly93d3cueGFtcGxlLmNvbSkKICAgICAgdXJsOiAvXihodHRwcz98ZnRwKTpcL1wvKCgoKFthLXpdfFxkfC18XC58X3x+fFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoJVtcZGEtZl17Mn0pfFshXCQmJ1woXClcKlwrLDs9XXw6KSpAKT8oKChcZHxbMS05XVxkfDFcZFxkfDJbMC00XVxkfDI1WzAtNV0pXC4oXGR8WzEtOV1cZHwxXGRcZHwyWzAtNF1cZHwyNVswLTVdKVwuKFxkfFsxLTldXGR8MVxkXGR8MlswLTRdXGR8MjVbMC01XSlcLihcZHxbMS05XVxkfDFcZFxkfDJbMC00XVxkfDI1WzAtNV0pKXwoKChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KChbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pKihbYS16XXxcZHxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkpKVwuKSsoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKXwoKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKShbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSkqKFthLXpdfFtcdTAwQTAtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRUZdKSkpXC4/KSg6XGQqKT8pKFwvKCgoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCglW1xkYS1mXXsyfSl8WyFcJCYnXChcKVwqXCssOz1dfDp8QCkrKFwvKChbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KCVbXGRhLWZdezJ9KXxbIVwkJidcKFwpXCpcKyw7PV18OnxAKSopKik/KT8oXD8oKChbYS16XXxcZHwtfFwufF98fnxbXHUwMEEwLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkVGXSl8KCVbXGRhLWZdezJ9KXxbIVwkJidcKFwpXCpcKyw7PV18OnxAKXxbXHVFMDAwLVx1RjhGRl18XC98XD8pKik/KFwjKCgoW2Etel18XGR8LXxcLnxffH58W1x1MDBBMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZFRl0pfCglW1xkYS1mXXsyfSl8WyFcJCYnXChcKVwqXCssOz1dfDp8QCl8XC98XD8pKik/JC9pCiAgICB9OwogIAogIAogICAgLy8gRXJyb3IgbWVzc2FnZXMKICAgIC8vIC0tLS0tLS0tLS0tLS0tCiAgCiAgICAvLyBFcnJvciBtZXNzYWdlIGZvciB0aGUgYnVpbGQgaW4gdmFsaWRhdG9ycy4KICAgIC8vIHt4fSBnZXRzIHN3YXBwZWQgb3V0IHdpdGggYXJndW1lbnRzIGZvcm0gdGhlIHZhbGlkYXRvci4KICAgIHZhciBkZWZhdWx0TWVzc2FnZXMgPSBWYWxpZGF0aW9uLm1lc3NhZ2VzID0gewogICAgICByZXF1aXJlZDogJ3swfSBpcyByZXF1aXJlZCcsCiAgICAgIGFjY2VwdGFuY2U6ICd7MH0gbXVzdCBiZSBhY2NlcHRlZCcsCiAgICAgIG1pbjogJ3swfSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byB7MX0nLAogICAgICBtYXg6ICd7MH0gbXVzdCBiZSBsZXNzIHRoYW4gb3IgZXF1YWwgdG8gezF9JywKICAgICAgcmFuZ2U6ICd7MH0gbXVzdCBiZSBiZXR3ZWVuIHsxfSBhbmQgezJ9JywKICAgICAgbGVuZ3RoOiAnezB9IG11c3QgYmUgezF9IGNoYXJhY3RlcnMnLAogICAgICBtaW5MZW5ndGg6ICd7MH0gbXVzdCBiZSBhdCBsZWFzdCB7MX0gY2hhcmFjdGVycycsCiAgICAgIG1heExlbmd0aDogJ3swfSBtdXN0IGJlIGF0IG1vc3QgezF9IGNoYXJhY3RlcnMnLAogICAgICByYW5nZUxlbmd0aDogJ3swfSBtdXN0IGJlIGJldHdlZW4gezF9IGFuZCB7Mn0gY2hhcmFjdGVycycsCiAgICAgIG9uZU9mOiAnezB9IG11c3QgYmUgb25lIG9mOiB7MX0nLAogICAgICBlcXVhbFRvOiAnezB9IG11c3QgYmUgdGhlIHNhbWUgYXMgezF9JywKICAgICAgcGF0dGVybjogJ3swfSBtdXN0IGJlIGEgdmFsaWQgezF9JwogICAgfTsKICAKICAgIC8vIExhYmVsIGZvcm1hdHRlcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0KICAKICAgIC8vIExhYmVsIGZvcm1hdHRlcnMgYXJlIHVzZWQgdG8gY29udmVydCB0aGUgYXR0cmlidXRlIG5hbWUKICAgIC8vIHRvIGEgbW9yZSBodW1hbiBmcmllbmRseSBsYWJlbCB3aGVuIHVzaW5nIHRoZSBidWlsdCBpbgogICAgLy8gZXJyb3IgbWVzc2FnZXMuCiAgICAvLyBDb25maWd1cmUgd2hpY2ggb25lIHRvIHVzZSB3aXRoIGEgY2FsbCB0bwogICAgLy8KICAgIC8vICAgICBCYWNrYm9uZS5WYWxpZGF0aW9uLmNvbmZpZ3VyZSh7CiAgICAvLyAgICAgICBsYWJlbEZvcm1hdHRlcjogJ2xhYmVsJwogICAgLy8gICAgIH0pOwogICAgdmFyIGRlZmF1bHRMYWJlbEZvcm1hdHRlcnMgPSBWYWxpZGF0aW9uLmxhYmVsRm9ybWF0dGVycyA9IHsKICAKICAgICAgLy8gUmV0dXJucyB0aGUgYXR0cmlidXRlIG5hbWUgd2l0aCBhcHBseWluZyBhbnkgZm9ybWF0dGluZwogICAgICBub25lOiBmdW5jdGlvbihhdHRyTmFtZSkgewogICAgICAgIHJldHVybiBhdHRyTmFtZTsKICAgICAgfSwKICAKICAgICAgLy8gQ29udmVydHMgYXR0cmlidXRlTmFtZSBvciBhdHRyaWJ1dGVfbmFtZSB0byBBdHRyaWJ1dGUgbmFtZQogICAgICBzZW50ZW5jZUNhc2U6IGZ1bmN0aW9uKGF0dHJOYW1lKSB7CiAgICAgICAgcmV0dXJuIGF0dHJOYW1lLnJlcGxhY2UoLyg/Ol5cd3xbQS1aXXxcYlx3KS9nLCBmdW5jdGlvbihtYXRjaCwgaW5kZXgpIHsKICAgICAgICAgIHJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvVXBwZXJDYXNlKCkgOiAnICcgKyBtYXRjaC50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pLnJlcGxhY2UoL18vZywgJyAnKTsKICAgICAgfSwKICAKICAgICAgLy8gTG9va3MgZm9yIGEgbGFiZWwgY29uZmlndXJlZCBvbiB0aGUgbW9kZWwgYW5kIHJldHVybnMgaXQKICAgICAgLy8KICAgICAgLy8gICAgICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewogICAgICAvLyAgICAgICAgdmFsaWRhdGlvbjogewogICAgICAvLyAgICAgICAgICBzb21lQXR0cmlidXRlOiB7CiAgICAgIC8vICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgLy8gICAgICAgICAgfQogICAgICAvLyAgICAgICAgfSwKICAgICAgLy8KICAgICAgLy8gICAgICAgIGxhYmVsczogewogICAgICAvLyAgICAgICAgICBzb21lQXR0cmlidXRlOiAnQ3VzdG9tIGxhYmVsJwogICAgICAvLyAgICAgICAgfQogICAgICAvLyAgICAgIH0pOwogICAgICBsYWJlbDogZnVuY3Rpb24oYXR0ck5hbWUsIG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIChtb2RlbC5sYWJlbHMgJiYgbW9kZWwubGFiZWxzW2F0dHJOYW1lXSkgfHwgZGVmYXVsdExhYmVsRm9ybWF0dGVycy5zZW50ZW5jZUNhc2UoYXR0ck5hbWUsIG1vZGVsKTsKICAgICAgfQogICAgfTsKICAKICAKICAgIC8vIEJ1aWx0IGluIHZhbGlkYXRvcnMKICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KICAKICAgIHZhciBkZWZhdWx0VmFsaWRhdG9ycyA9IFZhbGlkYXRpb24udmFsaWRhdG9ycyA9IChmdW5jdGlvbigpewogICAgICAvLyBVc2UgbmF0aXZlIHRyaW0gd2hlbiBkZWZpbmVkCiAgICAgIHZhciB0cmltID0gU3RyaW5nLnByb3RvdHlwZS50cmltID8KICAgICAgICBmdW5jdGlvbih0ZXh0KSB7CiAgICAgICAgICByZXR1cm4gdGV4dCA9PT0gbnVsbCA/ICcnIDogU3RyaW5nLnByb3RvdHlwZS50cmltLmNhbGwodGV4dCk7CiAgICAgICAgfSA6CiAgICAgICAgZnVuY3Rpb24odGV4dCkgewogICAgICAgICAgdmFyIHRyaW1MZWZ0ID0gL15ccysvLAogICAgICAgICAgICAgIHRyaW1SaWdodCA9IC9ccyskLzsKICAKICAgICAgICAgIHJldHVybiB0ZXh0ID09PSBudWxsID8gJycgOiB0ZXh0LnRvU3RyaW5nKCkucmVwbGFjZSh0cmltTGVmdCwgJycpLnJlcGxhY2UodHJpbVJpZ2h0LCAnJyk7CiAgICAgICAgfTsKICAKICAgICAgLy8gRGV0ZXJtaW5lcyB3aGV0aGVyIG9yIG5vdCBhIHZhbHVlIGlzIGEgbnVtYmVyCiAgICAgIHZhciBpc051bWJlciA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICByZXR1cm4gXy5pc051bWJlcih2YWx1ZSkgfHwgKF8uaXNTdHJpbmcodmFsdWUpICYmIHZhbHVlLm1hdGNoKGRlZmF1bHRQYXR0ZXJucy5udW1iZXIpKTsKICAgICAgfTsKICAKICAgICAgLy8gRGV0ZXJtaW5lcyB3aGV0aGVyIG9yIG5vdCBhIHZhbHVlIGlzIGVtcHR5CiAgICAgIHZhciBoYXNWYWx1ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuICEoXy5pc051bGwodmFsdWUpIHx8IF8uaXNVbmRlZmluZWQodmFsdWUpIHx8IChfLmlzU3RyaW5nKHZhbHVlKSAmJiB0cmltKHZhbHVlKSA9PT0gJycpIHx8IChfLmlzQXJyYXkodmFsdWUpICYmIF8uaXNFbXB0eSh2YWx1ZSkpKTsKICAgICAgfTsKICAKICAgICAgcmV0dXJuIHsKICAgICAgICAvLyBGdW5jdGlvbiB2YWxpZGF0b3IKICAgICAgICAvLyBMZXRzIHlvdSBpbXBsZW1lbnQgYSBjdXN0b20gZnVuY3Rpb24gdXNlZCBmb3IgdmFsaWRhdGlvbgogICAgICAgIGZuOiBmdW5jdGlvbih2YWx1ZSwgYXR0ciwgZm4sIG1vZGVsLCBjb21wdXRlZCkgewogICAgICAgICAgaWYoXy5pc1N0cmluZyhmbikpewogICAgICAgICAgICBmbiA9IG1vZGVsW2ZuXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbi5jYWxsKG1vZGVsLCB2YWx1ZSwgYXR0ciwgY29tcHV0ZWQpOwogICAgICAgIH0sCiAgCiAgICAgICAgLy8gUmVxdWlyZWQgdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIGlmIHRoZSBhdHRyaWJ1dGUgaXMgcmVxdWlyZWQgb3Igbm90CiAgICAgICAgcmVxdWlyZWQ6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCByZXF1aXJlZCwgbW9kZWwsIGNvbXB1dGVkKSB7CiAgICAgICAgICB2YXIgaXNSZXF1aXJlZCA9IF8uaXNGdW5jdGlvbihyZXF1aXJlZCkgPyByZXF1aXJlZC5jYWxsKG1vZGVsLCB2YWx1ZSwgYXR0ciwgY29tcHV0ZWQpIDogcmVxdWlyZWQ7CiAgICAgICAgICBpZighaXNSZXF1aXJlZCAmJiAhaGFzVmFsdWUodmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gb3ZlcnJpZGVzIGFsbCBvdGhlciB2YWxpZGF0b3JzCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNSZXF1aXJlZCAmJiAhaGFzVmFsdWUodmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdChkZWZhdWx0TWVzc2FnZXMucmVxdWlyZWQsIHRoaXMuZm9ybWF0TGFiZWwoYXR0ciwgbW9kZWwpKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIC8vIEFjY2VwdGFuY2UgdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgc29tZXRoaW5nIGhhcyB0byBiZSBhY2NlcHRlZCwgZS5nLiB0ZXJtcyBvZiB1c2UKICAgICAgICAvLyBgdHJ1ZWAgb3IgJ3RydWUnIGFyZSB2YWxpZAogICAgICAgIGFjY2VwdGFuY2U6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCBhY2NlcHQsIG1vZGVsKSB7CiAgICAgICAgICBpZih2YWx1ZSAhPT0gJ3RydWUnICYmICghXy5pc0Jvb2xlYW4odmFsdWUpIHx8IHZhbHVlID09PSBmYWxzZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0KGRlZmF1bHRNZXNzYWdlcy5hY2NlcHRhbmNlLCB0aGlzLmZvcm1hdExhYmVsKGF0dHIsIG1vZGVsKSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICAvLyBNaW4gdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgdGhlIHZhbHVlIGhhcyB0byBiZSBhIG51bWJlciBhbmQgZXF1YWwgdG8gb3IgZ3JlYXRlciB0aGFuCiAgICAgICAgLy8gdGhlIG1pbiB2YWx1ZSBzcGVjaWZpZWQKICAgICAgICBtaW46IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCBtaW5WYWx1ZSwgbW9kZWwpIHsKICAgICAgICAgIGlmICghaXNOdW1iZXIodmFsdWUpIHx8IHZhbHVlIDwgbWluVmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0KGRlZmF1bHRNZXNzYWdlcy5taW4sIHRoaXMuZm9ybWF0TGFiZWwoYXR0ciwgbW9kZWwpLCBtaW5WYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICAvLyBNYXggdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgdGhlIHZhbHVlIGhhcyB0byBiZSBhIG51bWJlciBhbmQgZXF1YWwgdG8gb3IgbGVzcyB0aGFuCiAgICAgICAgLy8gdGhlIG1heCB2YWx1ZSBzcGVjaWZpZWQKICAgICAgICBtYXg6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCBtYXhWYWx1ZSwgbW9kZWwpIHsKICAgICAgICAgIGlmICghaXNOdW1iZXIodmFsdWUpIHx8IHZhbHVlID4gbWF4VmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0KGRlZmF1bHRNZXNzYWdlcy5tYXgsIHRoaXMuZm9ybWF0TGFiZWwoYXR0ciwgbW9kZWwpLCBtYXhWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICAvLyBSYW5nZSB2YWxpZGF0b3IKICAgICAgICAvLyBWYWxpZGF0ZXMgdGhhdCB0aGUgdmFsdWUgaGFzIHRvIGJlIGEgbnVtYmVyIGFuZCBlcXVhbCB0byBvciBiZXR3ZWVuCiAgICAgICAgLy8gdGhlIHR3byBudW1iZXJzIHNwZWNpZmllZAogICAgICAgIHJhbmdlOiBmdW5jdGlvbih2YWx1ZSwgYXR0ciwgcmFuZ2UsIG1vZGVsKSB7CiAgICAgICAgICBpZighaXNOdW1iZXIodmFsdWUpIHx8IHZhbHVlIDwgcmFuZ2VbMF0gfHwgdmFsdWUgPiByYW5nZVsxXSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXQoZGVmYXVsdE1lc3NhZ2VzLnJhbmdlLCB0aGlzLmZvcm1hdExhYmVsKGF0dHIsIG1vZGVsKSwgcmFuZ2VbMF0sIHJhbmdlWzFdKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIC8vIExlbmd0aCB2YWxpZGF0b3IKICAgICAgICAvLyBWYWxpZGF0ZXMgdGhhdCB0aGUgdmFsdWUgaGFzIHRvIGJlIGEgc3RyaW5nIHdpdGggbGVuZ3RoIGVxdWFsIHRvCiAgICAgICAgLy8gdGhlIGxlbmd0aCB2YWx1ZSBzcGVjaWZpZWQKICAgICAgICBsZW5ndGg6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCBsZW5ndGgsIG1vZGVsKSB7CiAgICAgICAgICBpZiAoIWhhc1ZhbHVlKHZhbHVlKSB8fCB0cmltKHZhbHVlKS5sZW5ndGggIT09IGxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXQoZGVmYXVsdE1lc3NhZ2VzLmxlbmd0aCwgdGhpcy5mb3JtYXRMYWJlbChhdHRyLCBtb2RlbCksIGxlbmd0aCk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICAvLyBNaW4gbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIC8vIFZhbGlkYXRlcyB0aGF0IHRoZSB2YWx1ZSBoYXMgdG8gYmUgYSBzdHJpbmcgd2l0aCBsZW5ndGggZXF1YWwgdG8gb3IgZ3JlYXRlciB0aGFuCiAgICAgICAgLy8gdGhlIG1pbiBsZW5ndGggdmFsdWUgc3BlY2lmaWVkCiAgICAgICAgbWluTGVuZ3RoOiBmdW5jdGlvbih2YWx1ZSwgYXR0ciwgbWluTGVuZ3RoLCBtb2RlbCkgewogICAgICAgICAgaWYgKCFoYXNWYWx1ZSh2YWx1ZSkgfHwgdHJpbSh2YWx1ZSkubGVuZ3RoIDwgbWluTGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdChkZWZhdWx0TWVzc2FnZXMubWluTGVuZ3RoLCB0aGlzLmZvcm1hdExhYmVsKGF0dHIsIG1vZGVsKSwgbWluTGVuZ3RoKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIC8vIE1heCBsZW5ndGggdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgdGhlIHZhbHVlIGhhcyB0byBiZSBhIHN0cmluZyB3aXRoIGxlbmd0aCBlcXVhbCB0byBvciBsZXNzIHRoYW4KICAgICAgICAvLyB0aGUgbWF4IGxlbmd0aCB2YWx1ZSBzcGVjaWZpZWQKICAgICAgICBtYXhMZW5ndGg6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCBtYXhMZW5ndGgsIG1vZGVsKSB7CiAgICAgICAgICBpZiAoIWhhc1ZhbHVlKHZhbHVlKSB8fCB0cmltKHZhbHVlKS5sZW5ndGggPiBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0KGRlZmF1bHRNZXNzYWdlcy5tYXhMZW5ndGgsIHRoaXMuZm9ybWF0TGFiZWwoYXR0ciwgbW9kZWwpLCBtYXhMZW5ndGgpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgLy8gUmFuZ2UgbGVuZ3RoIHZhbGlkYXRvcgogICAgICAgIC8vIFZhbGlkYXRlcyB0aGF0IHRoZSB2YWx1ZSBoYXMgdG8gYmUgYSBzdHJpbmcgYW5kIGVxdWFsIHRvIG9yIGJldHdlZW4KICAgICAgICAvLyB0aGUgdHdvIG51bWJlcnMgc3BlY2lmaWVkCiAgICAgICAgcmFuZ2VMZW5ndGg6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCByYW5nZSwgbW9kZWwpIHsKICAgICAgICAgIGlmKCFoYXNWYWx1ZSh2YWx1ZSkgfHwgdHJpbSh2YWx1ZSkubGVuZ3RoIDwgcmFuZ2VbMF0gfHwgdHJpbSh2YWx1ZSkubGVuZ3RoID4gcmFuZ2VbMV0pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0KGRlZmF1bHRNZXNzYWdlcy5yYW5nZUxlbmd0aCwgdGhpcy5mb3JtYXRMYWJlbChhdHRyLCBtb2RlbCksIHJhbmdlWzBdLCByYW5nZVsxXSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICAvLyBPbmUgb2YgdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgdGhlIHZhbHVlIGhhcyB0byBiZSBlcXVhbCB0byBvbmUgb2YgdGhlIGVsZW1lbnRzIGluCiAgICAgICAgLy8gdGhlIHNwZWNpZmllZCBhcnJheS4gQ2FzZSBzZW5zaXRpdmUgbWF0Y2hpbmcKICAgICAgICBvbmVPZjogZnVuY3Rpb24odmFsdWUsIGF0dHIsIHZhbHVlcywgbW9kZWwpIHsKICAgICAgICAgIGlmKCFfLmluY2x1ZGUodmFsdWVzLCB2YWx1ZSkpewogICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXQoZGVmYXVsdE1lc3NhZ2VzLm9uZU9mLCB0aGlzLmZvcm1hdExhYmVsKGF0dHIsIG1vZGVsKSwgdmFsdWVzLmpvaW4oJywgJykpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgLy8gRXF1YWwgdG8gdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgdGhlIHZhbHVlIGhhcyB0byBiZSBlcXVhbCB0byB0aGUgdmFsdWUgb2YgdGhlIGF0dHJpYnV0ZQogICAgICAgIC8vIHdpdGggdGhlIG5hbWUgc3BlY2lmaWVkCiAgICAgICAgZXF1YWxUbzogZnVuY3Rpb24odmFsdWUsIGF0dHIsIGVxdWFsVG8sIG1vZGVsLCBjb21wdXRlZCkgewogICAgICAgICAgaWYodmFsdWUgIT09IGNvbXB1dGVkW2VxdWFsVG9dKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdChkZWZhdWx0TWVzc2FnZXMuZXF1YWxUbywgdGhpcy5mb3JtYXRMYWJlbChhdHRyLCBtb2RlbCksIHRoaXMuZm9ybWF0TGFiZWwoZXF1YWxUbywgbW9kZWwpKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIC8vIFBhdHRlcm4gdmFsaWRhdG9yCiAgICAgICAgLy8gVmFsaWRhdGVzIHRoYXQgdGhlIHZhbHVlIGhhcyB0byBtYXRjaCB0aGUgcGF0dGVybiBzcGVjaWZpZWQuCiAgICAgICAgLy8gQ2FuIGJlIGEgcmVndWxhciBleHByZXNzaW9uIG9yIHRoZSBuYW1lIG9mIG9uZSBvZiB0aGUgYnVpbHQgaW4gcGF0dGVybnMKICAgICAgICBwYXR0ZXJuOiBmdW5jdGlvbih2YWx1ZSwgYXR0ciwgcGF0dGVybiwgbW9kZWwpIHsKICAgICAgICAgIGlmICghaGFzVmFsdWUodmFsdWUpIHx8ICF2YWx1ZS50b1N0cmluZygpLm1hdGNoKGRlZmF1bHRQYXR0ZXJuc1twYXR0ZXJuXSB8fCBwYXR0ZXJuKSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXQoZGVmYXVsdE1lc3NhZ2VzLnBhdHRlcm4sIHRoaXMuZm9ybWF0TGFiZWwoYXR0ciwgbW9kZWwpLCBwYXR0ZXJuKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9KCkpOwogIAogICAgcmV0dXJuIFZhbGlkYXRpb247CiAgfShfKSk7CiAgcmV0dXJuIEJhY2tib25lLlZhbGlkYXRpb247Cn0pKTsKCi8qIFNUQVJUX1RFTVBMQVRFICovCmRlZmluZSgnaGJzIWNoaXJvcHJhY3Rvci92aWV3cy90ZW1wbGF0ZXMvZXJyb3IvbW9kZWxmZXRjaCcsWydoYnMnLCdoYW5kbGViYXJzJ10sIGZ1bmN0aW9uKCBoYnMsIEhhbmRsZWJhcnMgKXsgCnZhciB0ID0gSGFuZGxlYmFycy50ZW1wbGF0ZShmdW5jdGlvbiAoSGFuZGxlYmFycyxkZXB0aDAsaGVscGVycyxwYXJ0aWFscyxkYXRhKSB7CiAgaGVscGVycyA9IGhlbHBlcnMgfHwgSGFuZGxlYmFycy5oZWxwZXJzOwogIHZhciBzdGFjazEsIHN0YWNrMiwgZm91bmRIZWxwZXIsIGhlbHBlck1pc3Npbmc9aGVscGVycy5oZWxwZXJNaXNzaW5nLCBlc2NhcGVFeHByZXNzaW9uPXRoaXMuZXNjYXBlRXhwcmVzc2lvbjsKCgogIHN0YWNrMSA9IHt9OwogIHN0YWNrMiA9IGRlcHRoMC5yZXNwb25zZTsKICBzdGFjazFbJ3Jlc3BvbnNlJ10gPSBzdGFjazI7CiAgc3RhY2syID0gZGVwdGgwLnVybDsKICBzdGFjazFbJ3VybCddID0gc3RhY2syOwogIGZvdW5kSGVscGVyID0gaGVscGVycy5yb3c7CiAgc3RhY2sxID0gZm91bmRIZWxwZXIgPyBmb3VuZEhlbHBlci5jYWxsKGRlcHRoMCwgImVycm9yIiwgZGVwdGgwLCB7aGFzaDpzdGFjazF9KSA6IGhlbHBlck1pc3NpbmcuY2FsbChkZXB0aDAsICJyb3ciLCAiZXJyb3IiLCBkZXB0aDAsIHtoYXNoOnN0YWNrMX0pOwogIHJldHVybiBlc2NhcGVFeHByZXNzaW9uKHN0YWNrMSk7fSk7CkhhbmRsZWJhcnMucmVnaXN0ZXJQYXJ0aWFsKCdjaGlyb3ByYWN0b3Jfdmlld3NfdGVtcGxhdGVzX2Vycm9yX21vZGVsZmV0Y2gnLCB0KTsKcmV0dXJuIHQ7Cn0pOwovKiBFTkRfVEVNUExBVEUgKi8KOwovKmdsb2JhbCBkZWZpbmUsc2V0VGltZW91dCxjbGVhclRpbWVvdXQqLwpkZWZpbmUoJ2NoaXJvcHJhY3Rvci9tb2RlbHMnLFsncmVxdWlyZScsJ2pxdWVyeS5jb3JzL2pxdWVyeS5jb3JzJywnYmFja2JvbmUnLCd1bmRlcnNjb3JlJywnanNvbi1pZTcnLCdqcXVlcnknLCcuL21vZGVscy9hdXRoJywnYmFja2JvbmUuZGVlcC5tb2RlbCcsJ2JhY2tib25lLnZhbGlkYXRpb24nLCdoYnMhLi92aWV3cy90ZW1wbGF0ZXMvZXJyb3IvbW9kZWxmZXRjaCcsJ3VuZGVyc2NvcmUubWl4aW4uZGVlcGV4dGVuZCddLGZ1bmN0aW9uIChyZXF1aXJlKSB7CiAgCgogIHJlcXVpcmUoJ2pxdWVyeS5jb3JzL2pxdWVyeS5jb3JzJyk7CgoKICB2YXIgQmFja2JvbmUgPSByZXF1aXJlKCdiYWNrYm9uZScpLAogICAgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKSwKICAgIEpTT04gPSByZXF1aXJlKCdqc29uLWllNycpLAogICAgJCA9IHJlcXVpcmUoJ2pxdWVyeScpLAogICAgYXV0aCA9IHJlcXVpcmUoJy4vbW9kZWxzL2F1dGgnKSwKICAgIEJhY2tib25lRGVlcE1vZGVsID0gcmVxdWlyZSgnYmFja2JvbmUuZGVlcC5tb2RlbCcpLAogICAgVmFsaWRhdGlvbiA9IHJlcXVpcmUoJ2JhY2tib25lLnZhbGlkYXRpb24nKSwKICAgIFRlbXBsYXRlRXJyb3IgPSByZXF1aXJlKCdoYnMhLi92aWV3cy90ZW1wbGF0ZXMvZXJyb3IvbW9kZWxmZXRjaCcpLAogICAgQmFzZSwKICAgIFJldmlzaW9uLAogICAgVXNlckFnZW50LAogICAgUmVnRXhwcmVzc2lvbiwKICAgIEFTU0VUU19CQVNFX1VSTDsKCiAgLy8gQWRkIFdpc2VyIHNwZWNpZmljIHNldHRpbmdzIElzc3VlICMzMQoKICBpZih3aW5kb3cgJiYgd2luZG93Lldpc2VyICYmIHdpbmRvdy5XaXNlci5BU1NFVFNfQkFTRV9VUkwpIHsKICAgIEFTU0VUU19CQVNFX1VSTCA9IHdpbmRvdy5XaXNlci5BU1NFVFNfQkFTRV9VUkw7CiAgfSBlbHNlIHsKICAgIEFTU0VUU19CQVNFX1VSTCA9ICcnOwogIH0KCiAgcmVxdWlyZSgndW5kZXJzY29yZS5taXhpbi5kZWVwZXh0ZW5kJyk7CgogIEJhc2UgPSBCYWNrYm9uZURlZXBNb2RlbC5EZWVwTW9kZWwuZXh0ZW5kKHsKICAgIGVycm9ySGFuZGxlcjogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgdmFyIGVycm9yTWVzc2FnZTsKICAgICAgc3dpdGNoKHJlc3BvbnNlLnN0YXR1cykgewogICAgICAgIGNhc2UgMDoKICAgICAgICAgIGVycm9yTWVzc2FnZSA9ICJUaGUgQVBJIHdhcyB1bnJlYWNoYWJsZSI7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDUwMzoKICAgICAgICAgIGVycm9yTWVzc2FnZSA9ICJUaGVyZSB3YXMgYW4gRXJyb3IgQ29tbXVuaWNhdGluZyB3aXRoIHRoZSBBUEkiOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICB9CiAgICAgICQoJ2JvZHknKS5iZWZvcmUoVGVtcGxhdGVFcnJvcih7IHVybDogdGhpcy51cmwgLCAgZXJyb3JNZXNzYWdlOiBlcnJvck1lc3NhZ2UsIHJlc3BvbnNlOiByZXNwb25zZSB9KSk7CiAgICB9LAogICAgc3VjY2Vzc0hhbmRsZXI6IGZ1bmN0aW9uKG1vZGVsLCByZXNwb25zZSwgb3B0aW9ucykgewogICAgfSwKICAgIHN5bmM6IGZ1bmN0aW9uIChtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIC8vIFNldHVwIHRoZSBhdXRoZW50aWNhdGlvbiBoYW5kbGVycyBmb3IgdGhlIEJhc2VNb2RlbAogICAgICAvLwoKICAgICAgYXV0aC5zeW5jLmNhbGwodGhpcywgbWV0aG9kLCBtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgIGNhc2UgJ3JlYWQnOgogICAgICAgIC8vRW1wdHkgdGhlIGVycm9yIG1lc3NhZ2UgYm94IGZvciBvdGhlciBmZXRjaGVzCiAgICAgICAgJCgnI2NoaXJvcHJhY3Rvci1lcnJvci1ib3gnKS5lbXB0eSgpOwogICAgICAgIGlmICh0aGlzLmVuYWJsZUVycm9ySGFuZGxlcikgewogICAgICAgICAgb3B0aW9ucy5lcnJvciA9IHRoaXMuZXJyb3JIYW5kbGVyOwogICAgICAgICAgLy8gVGltZW91dCBzZXQgdG8gMzAgc2Vjb25kcy4KICAgICAgICAgIG9wdGlvbnMudGltZW91dCA9IDMwMDAwOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAndXBkYXRlJzoKICAgICAgICAvLyBSZW1vdmUgV2lzZXIgc3BlY2lmaWMgc2V0dGluZ3MgSXNzdWUgIzMxCiAgICAgICAgbW9kZWwudW5zZXQoJ1dpc2VyJyk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgIH0KICAgICAgcmV0dXJuIEJhY2tib25lLk1vZGVsLnByb3RvdHlwZS5zeW5jLmNhbGwoCiAgICAgICAgdGhpcywgbWV0aG9kLCBtb2RlbCwgb3B0aW9ucwogICAgICApOwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbiAocmVzcCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgLy8gV2UgbmVlZCB0byB1bndyYXAgdGhlIG9sZCBXaXNlclRvZ2V0aGVyIEFQSSBlbnZlbG9wIGZvcm1hdC4KICAgICAgaWYgKHJlc3AuZGF0YSAmJiByZXNwLm1ldGEpIHsKICAgICAgICBpZiAocGFyc2VJbnQocmVzcC5tZXRhLnN0YXR1cywgMTApID49IDQwMCkgewogICAgICAgICAgb3B0aW9ucy5sZWdhY3lFcnJvciA9IHRydWU7CiAgICAgICAgICBpZiAocmVzcC5tZXRhLmVycm9ycyAmJiByZXNwLm1ldGEuZXJyb3JzLmZvcm0pIHsKICAgICAgICAgICAgdGhpcy52YWxpZGF0aW9uRXJyb3IgPSByZXNwLm1ldGEuZXJyb3JzLmZvcm07CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcigKICAgICAgICAgICAgICAnaW52YWxpZCcsCiAgICAgICAgICAgICAgdGhpcywKICAgICAgICAgICAgICB0aGlzLnZhbGlkYXRpb25FcnJvciwKICAgICAgICAgICAgICBfLmV4dGVuZChvcHRpb25zIHx8IHt9LCB7CiAgICAgICAgICAgICAgICB2YWxpZGF0aW9uRXJyb3I6IHRoaXMudmFsaWRhdGlvbkVycm9yCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCB0aGlzLCByZXNwLmRhdGEsIG9wdGlvbnMpOwoKICAgICAgICAgICAgaWYgKG9wdGlvbnMuZXJyb3IpIHsKICAgICAgICAgICAgICBvcHRpb25zLmVycm9yKHRoaXMsIHJlc3AuZGF0YSwgb3B0aW9ucyk7CgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBXZSBkbyBub3Qgd2FudCBhbiBlcnJvciByZXNwb25zZSB0byB1cGRhdGUgdGhlIG1vZGVsCiAgICAgICAgICAvLyBhdHRyaWJ1dGVzIChyZXR1cm5pbmcgYW4gZW1wdHkgb2JqZWN0IGxlYXZlcyB0aGUgbW9kZWwKICAgICAgICAgIC8vIHN0YXRlIGFzIGl0IHdhcwogICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgIH0KCiAgICAgICAgLy8gQWRkIFdpc2VyIHNwZWNpZmljIHNldHRpbmdzIElzc3VlICMzMQogICAgICAgIHJlc3AuV2lzZXIgPSB7fTsKICAgICAgICByZXNwLldpc2VyLkFTU0VUU19CQVNFX1VSTCA9IEFTU0VUU19CQVNFX1VSTDsKCiAgICAgICAgcmV0dXJuIHJlc3AuZGF0YTsKICAgICAgfQoKICAgICAgLy8gQWRkIFdpc2VyIHNwZWNpZmljIHNldHRpbmdzIElzc3VlICMzMQogICAgICByZXNwLldpc2VyID0ge307CiAgICAgIHJlc3AuV2lzZXIuQVNTRVRTX0JBU0VfVVJMID0gQVNTRVRTX0JBU0VfVVJMOwoKICAgICAgcmV0dXJuIEJhY2tib25lLk1vZGVsLnByb3RvdHlwZS5wYXJzZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICBmaWVsZElkOiBmdW5jdGlvbiAoZmllbGQsIHByZWZpeCkgewogICAgICBwcmVmaXggPSBwcmVmaXggfHwgJ2Zvcm1maWVsZCc7CiAgICAgIHJldHVybiBbcHJlZml4LCBmaWVsZCwgdGhpcy5jaWRdLmpvaW4oJy0nKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAoYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgLy8gV2UgbmVlZCB0byBhbGxvdyB0aGUgbGVnYWN5IGVycm9ycyB0byBzaG9ydCBjaXJjdWl0IHRoZSBCYWNrYm9uZQogICAgICAvLyBzdWNjZXNzIGhhbmRsZXIgaW4gdGhlIGNhc2Ugb2YgYSBsZWdhY3kgc2VydmVyIGVycm9yLgogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmxlZ2FjeUVycm9yKSB7CiAgICAgICAgZGVsZXRlIG9wdGlvbnMubGVnYWN5RXJyb3I7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiBCYWNrYm9uZURlZXBNb2RlbC5EZWVwTW9kZWwucHJvdG90eXBlLnNldC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0pOwoKICBfLmV4dGVuZChCYXNlLnByb3RvdHlwZSwgVmFsaWRhdGlvbi5taXhpbik7CgogIHJldHVybiB7CiAgICBCYXNlOiBCYXNlLAogICAgY2xlYW51cDogYXV0aC5jbGVhbnVwCiAgfTsKfSk7Ci8qZ2xvYmFsIGRlZmluZSovCmRlZmluZSgnY2hpcm9wcmFjdG9yL2NvbGxlY3Rpb25zJyxbJ3JlcXVpcmUnLCdqcXVlcnkuY29ycy9qcXVlcnkuY29ycycsJ2JhY2tib25lJywndW5kZXJzY29yZScsJ2pxdWVyeScsJ2hicyEuL3ZpZXdzL3RlbXBsYXRlcy9lcnJvci9tb2RlbGZldGNoJywndW5kZXJzY29yZS5taXhpbi5kZWVwZXh0ZW5kJ10sZnVuY3Rpb24gKHJlcXVpcmUpIHsKICAKCiAgcmVxdWlyZSgnanF1ZXJ5LmNvcnMvanF1ZXJ5LmNvcnMnKTsKCgogIHZhciBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyksCiAgICBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpLAogICAgQmFzZSwKICAgICQgPSByZXF1aXJlKCdqcXVlcnknKSwKICAgIFRlbXBsYXRlRXJyb3IgPSByZXF1aXJlKCdoYnMhLi92aWV3cy90ZW1wbGF0ZXMvZXJyb3IvbW9kZWxmZXRjaCcpLAogICAgQVNTRVRTX0JBU0VfVVJMOwoKICAvLyBBZGQgV2lzZXIgc3BlY2lmaWMgc2V0dGluZ3MgSXNzdWUgIzMxCgogIGlmKHdpbmRvdyAmJiB3aW5kb3cuV2lzZXIgJiYgd2luZG93Lldpc2VyLkFTU0VUU19CQVNFX1VSTCkgewogICAgQVNTRVRTX0JBU0VfVVJMID0gd2luZG93Lldpc2VyLkFTU0VUU19CQVNFX1VSTDsKICB9IGVsc2UgewogICAgQVNTRVRTX0JBU0VfVVJMID0gJyc7CiAgfQoKICByZXF1aXJlKCd1bmRlcnNjb3JlLm1peGluLmRlZXBleHRlbmQnKTsKCiAgQmFzZSA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICAgIGVycm9ySGFuZGxlcjogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIHZhciBlcnJvck1lc3NhZ2U7CiAgICAgIHN3aXRjaCAocmVzcG9uc2Uuc3RhdHVzKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICBlcnJvck1lc3NhZ2UgPSAiVGhlIEFQSSB3YXMgdW5yZWFjaGFibGUiOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDUwMzoKICAgICAgICBlcnJvck1lc3NhZ2UgPSAiVGhlcmUgd2FzIGFuIEVycm9yIENvbW11bmljYXRpbmcgd2l0aCB0aGUgQVBJIjsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgfQogICAgICAkKCdib2R5JykuYmVmb3JlKFRlbXBsYXRlRXJyb3IoewogICAgICAgIHVybDogdGhpcy51cmwsCiAgICAgICAgZXJyb3JNZXNzYWdlOiBlcnJvck1lc3NhZ2UsCiAgICAgICAgcmVzcG9uc2U6IHJlc3BvbnNlCiAgICAgIH0pKTsKICAgIH0sCiAgICBzeW5jOiBmdW5jdGlvbiAobWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgICBzd2l0Y2ggKG1ldGhvZCkgewogICAgICBjYXNlICdyZWFkJzoKICAgICAgICAvL0VtcHR5IHRoZSBlcnJvciBtZXNzYWdlIGJveCBmb3Igb3RoZXIgZmV0Y2hlcwogICAgICAgICQoJyNjaGlyb3ByYWN0b3ItZXJyb3ItYm94JykuZW1wdHkoKTsKICAgICAgICBpZiAodGhpcy5lbmFibGVFcnJvckhhbmRsZXIpIHsKICAgICAgICAgIG9wdGlvbnMuZXJyb3IgPSB0aGlzLmVycm9ySGFuZGxlcjsKICAgICAgICAgIC8vIFRpbWVvdXQgc2V0IHRvIDMwIHNlY29uZHMuCiAgICAgICAgICBvcHRpb25zLnRpbWVvdXQgPSAzMDAwMDsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3VwZGF0ZSc6CiAgICAgICAgLy8gUmVtb3ZlIFdpc2VyIHNwZWNpZmljIHNldHRpbmdzIElzc3VlICMzMQogICAgICAgIG1vZGVsLnVuc2V0KCdXaXNlcicpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICB9CiAgICAgIHJldHVybiBCYWNrYm9uZS5Db2xsZWN0aW9uLnByb3RvdHlwZS5zeW5jLmNhbGwoCiAgICAgICAgdGhpcywgbWV0aG9kLCBtb2RlbCwgb3B0aW9ucwogICAgICApOwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbiAocmVzcCwgb3B0aW9ucykgewogICAgICAvLyBBZGQgV2lzZXIgc3BlY2lmaWMgc2V0dGluZ3MgSXNzdWUgIzMxCiAgICAgIHJlc3AuV2lzZXIgPSB7fTsKICAgICAgcmVzcC5XaXNlci5BU1NFVFNfQkFTRV9VUkwgPSBBU1NFVFNfQkFTRV9VUkw7CiAgICAgIHJldHVybiBCYWNrYm9uZS5Db2xsZWN0aW9uLnByb3RvdHlwZS5wYXJzZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0pOwoKICByZXR1cm4gewogICAgQmFzZTogQmFzZQogIH07Cn0pOwovKmdsb2JhbCBkZWZpbmUqLwpkZWZpbmUoJ2NoaXJvcHJhY3Rvci9yb3V0ZXJzJyxbJ3JlcXVpcmUnLCdiYWNrYm9uZSddLGZ1bmN0aW9uKHJlcXVpcmUpIHsKICAgIAoKICAgIHZhciBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyksCiAgICAgICAgQmFzZTsKCiAgICBCYXNlID0gQmFja2JvbmUuUm91dGVyLmV4dGVuZCh7CiAgICB9KTsKCiAgICByZXR1cm4gewogICAgICAgIEJhc2U6IEJhc2UKICAgIH07Cn0pOwoKLypnbG9iYWwgZGVmaW5lKi8KKGZ1bmN0aW9uKHdpbmRvdykgewogICAgCgogICAgZGVmaW5lKCdjaGlyb3ByYWN0b3IvYnJvd3NlcicsWydyZXF1aXJlJ10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgICAgIHZhciBpZVZlcnNpb24gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBydiA9IC0xOyAvLyBSZXR1cm4gdmFsdWUgYXNzdW1lcyBmYWlsdXJlLgogICAgICAgICAgICBpZiAod2luZG93Lm5hdmlnYXRvci5hcHBOYW1lID09PSAnTWljcm9zb2Z0IEludGVybmV0IEV4cGxvcmVyJykgewogICAgICAgICAgICAgICAgdmFyIHVhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7CiAgICAgICAgICAgICAgICB2YXIgcmUgPSBuZXcgUmVnRXhwKCJNU0lFIChbMC05XXsxLH1bLjAtOV17MCx9KSIpOwogICAgICAgICAgICAgICAgaWYgKHJlLmV4ZWModWEpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcnYgPSBwYXJzZUZsb2F0KFJlZ0V4cC4kMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJ2OwogICAgICAgIH0oKSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaXNPbGRJRTogaWVWZXJzaW9uICE9PSAtMSAmJiBpZVZlcnNpb24gPCA5LAogICAgICAgICAgICB3aW5kb3c6IHdpbmRvdywKICAgICAgICAgICAgbmF2aWdhdG9yOiB3aW5kb3cubmF2aWdhdG9yLAogICAgICAgICAgICBkb2N1bWVudDogd2luZG93LmRvY3VtZW50CiAgICAgICAgfTsKICAgIH0pOwp9KHRoaXMpKTsKCi8qZ2xvYmFsIGRlZmluZSxhbGVydCovCmRlZmluZSgnY2hpcm9wcmFjdG9yL2RlYnVnJyxbJ3JlcXVpcmUnLCdleHBvcnRzJywnbW9kdWxlJywnY2hpcm9wcmFjdG9yL2Jyb3dzZXInXSxmdW5jdGlvbihyZXF1aXJlLCBleHBvcnRzLCBtb2R1bGUpIHsKICAgIHZhciB3aW5kb3cgPSByZXF1aXJlKCdjaGlyb3ByYWN0b3IvYnJvd3NlcicpLndpbmRvdywKICAgICAgICBjb25zb2xlID0gd2luZG93LmNvbnNvbGU7CgogICAgaWYgKHJlcXVpcmUuc3BlY2lmaWVkKCdjb25zb2xlJykpIHsKICAgICAgICByZXF1aXJlKFsnY29uc29sZSddLCBmdW5jdGlvbihtb2QpIHsKICAgICAgICAgICAgY29uc29sZSA9IG1vZDsKICAgICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0luc3BlY3Rvck9wZW4oKSB7CiAgICAgICAgaWYgKGNvbnNvbGUuZmlyZWJ1ZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoY29uc29sZS5wcm9maWxlKSB7CiAgICAgICAgICAgIGNvbnNvbGUucHJvZmlsZSgpOwogICAgICAgICAgICBjb25zb2xlLnByb2ZpbGVFbmQoKTsKICAgICAgICAgICAgaWYgKGNvbnNvbGUuY2xlYXIpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuY2xlYXIoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNvbnNvbGUucHJvZmlsZXMgJiYgY29uc29sZS5wcm9maWxlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCh3aW5kb3cub3V0ZXJIZWlnaHQgLSB3aW5kb3cuaW5uZXJIZWlnaHQpID4gMTAwKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmIChtb2R1bGUuY29uZmlnKCkuZW5hYmxlZCkgewogICAgICAgIHdpbmRvdy5vbmVycm9yID0gZnVuY3Rpb24obWVzc2FnZSwgdXJsLCBsaW5lbnVtYmVyKSB7CiAgICAgICAgICAgIGFsZXJ0KCJKYXZhU2NyaXB0IGVycm9yOiAiICsgbWVzc2FnZSArICIgb24gbGluZSAiICsgbGluZW51bWJlciArICIgZm9yICIgKyB1cmwpOwogICAgICAgIH07CiAgICB9Cn0pOwoKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCdjaGlyb3ByYWN0b3IvaGJzL2lmZXF1YWwnLFsncmVxdWlyZScsJ2hhbmRsZWJhcnMnXSxmdW5jdGlvbihyZXF1aXJlKSB7CiAgICAKCiAgICB2YXIgSGFuZGxlYmFycyA9IHJlcXVpcmUoJ2hhbmRsZWJhcnMnKTsKCiAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZmVxdWFsJywgZnVuY3Rpb24odmFsMSwgdmFsMiwgb3B0aW9ucykgewogICAgICAgIGlmICh2YWwxID09PSB2YWwyKSB7CiAgICAgICAgICAgIHJldHVybiBvcHRpb25zLmZuKHRoaXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBvcHRpb25zLmludmVyc2UodGhpcyk7CiAgICAgICAgfQogICAgfSk7Cn0pOwoKLypnbG9iYWwgZGVmaW5lKi8KZGVmaW5lKCdjaGlyb3ByYWN0b3IvaGJzL2xvZycsWydyZXF1aXJlJywnaGFuZGxlYmFycycsJ2pzb24taWU3J10sZnVuY3Rpb24ocmVxdWlyZSkgewogICAgCgogICAgdmFyIEhhbmRsZWJhcnMgPSByZXF1aXJlKCdoYW5kbGViYXJzJyksCiAgICBKU09OID0gcmVxdWlyZSgnanNvbi1pZTcnKTsKCiAgICBmdW5jdGlvbiBsb2coY29udGV4dCwgb3B0aW9ucykgewogICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGNvbnRleHQpKTsKICAgIH0KICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xvZycsIGxvZyk7CgogICAgcmV0dXJuIGxvZzsKfSk7Ci8qZ2xvYmFsIGRlZmluZSovCmRlZmluZSgnY2hpcm9wcmFjdG9yL2hicycsWydyZXF1aXJlJywnLi9oYnMvdmlldycsJy4vaGJzL2lmZXF1YWwnLCcuL2hicy9sb2cnXSxmdW5jdGlvbihyZXF1aXJlKSB7CiAgICAKCiAgICByZXF1aXJlKCcuL2hicy92aWV3Jyk7CiAgICByZXF1aXJlKCcuL2hicy9pZmVxdWFsJyk7CiAgICByZXF1aXJlKCcuL2hicy9sb2cnKTsKfSk7CgovKmdsb2JhbCBkZWZpbmUqLwpkZWZpbmUoJ2NoaXJvcHJhY3Rvci9tYWluJyxbJ3JlcXVpcmUnLCdiYWNrYm9uZScsJ3VuZGVyc2NvcmUnLCdiYWNrYm9uZS5zdWJyb3V0ZScsJy4vdmlld3MnLCcuL21vZGVscycsJy4vY29sbGVjdGlvbnMnLCcuL3JvdXRlcnMnLCcuL2RlYnVnJywnLi9oYnMnXSxmdW5jdGlvbihyZXF1aXJlKSB7CiAgICAKCiAgICB2YXIgQmFja2JvbmUgPSByZXF1aXJlKCdiYWNrYm9uZScpLAogICAgICAgIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyksCiAgICAgICAgU3ViUm91dGUgPSByZXF1aXJlKCdiYWNrYm9uZS5zdWJyb3V0ZScpLAogICAgICAgIFZpZXdzID0gcmVxdWlyZSgnLi92aWV3cycpLAogICAgICAgIE1vZGVscyA9IHJlcXVpcmUoJy4vbW9kZWxzJyksCiAgICAgICAgQ29sbGVjdGlvbnMgPSByZXF1aXJlKCcuL2NvbGxlY3Rpb25zJyksCiAgICAgICAgUm91dGVycyA9IHJlcXVpcmUoJy4vcm91dGVycycpLAogICAgICAgIENoYW5uZWxzID0ge30sCiAgICAgICAgU3Vic2NyaWJlLAogICAgICAgIFB1Ymxpc2g7CgogICAgcmVxdWlyZSgnLi9kZWJ1ZycpOwogICAgcmVxdWlyZSgnLi9oYnMnKTsKCiAgICBTdWJzY3JpYmUgPSBmdW5jdGlvbihjaGFubmVsLG9iamVjdCkgewogICAgICAvL1dlIHdhbnQgdG8gYmUgYWJsZSB0byBwdXNoIG5ldyBsaXN0ZW5lcnMgaW50byBDaGFubmVsc1tjaGFubmVsXQogICAgICBpZiAoIUNoYW5uZWxzW2NoYW5uZWxdKSB7CiAgICAgICAgQ2hhbm5lbHNbY2hhbm5lbF0gPSBbXTsKICAgICAgfQogICAgICBDaGFubmVsc1tjaGFubmVsXS5wdXNoKG9iamVjdCk7CiAgICB9OwogICAgUHVibGlzaCA9IGZ1bmN0aW9uKGNoYW5uZWwsb3B0aW9ucykgewogICAgICBpZiAoQ2hhbm5lbHNbY2hhbm5lbF0pIHsKICAgICAgICB2YXIgbGlzdGVuZXJzID0gQ2hhbm5lbHNbY2hhbm5lbF07CiAgICAgICAgXy5lYWNoKGxpc3RlbmVycywgZnVuY3Rpb24obGlzdGVuZXIpewogICAgICAgICAgbGlzdGVuZXIudHJpZ2dlcihjaGFubmVsLG9wdGlvbnMpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgICAgLy8gQ2hhbm5lbCBldmVudHMKICAgICAgICBTdWJzY3JpYmU6IFN1YnNjcmliZSwKICAgICAgICBQdWJsaXNoOiBQdWJsaXNoLAogICAgICAgIENoYW5uZWxzOiBDaGFubmVscywKICAgICAgICBDb2xsZWN0aW9uOiBDb2xsZWN0aW9ucy5CYXNlLAogICAgICAgIENvbGxlY3Rpb25zOiBDb2xsZWN0aW9ucywKICAgICAgICBFdmVudHM6IEJhY2tib25lLkV2ZW50cywKICAgICAgICBoaXN0b3J5OiBCYWNrYm9uZS5oaXN0b3J5LAogICAgICAgIE1vZGVsOiBNb2RlbHMuQmFzZSwKICAgICAgICBNb2RlbHM6IE1vZGVscywKICAgICAgICBSb3V0ZXI6IFJvdXRlcnMuQmFzZSwKICAgICAgICBTdWJSb3V0ZTogU3ViUm91dGUsCiAgICAgICAgVmlldzogVmlld3MuQmFzZSwKICAgICAgICBWaWV3czogVmlld3MKICAgIH07Cn0pOwoKZGVmaW5lKCdjaGlyb3ByYWN0b3InLCBbJ2NoaXJvcHJhY3Rvci9tYWluJ10sIGZ1bmN0aW9uIChtYWluKSB7IHJldHVybiBtYWluOyB9KTsKCn0oKSk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 15:07:35 GMT",
                    "Content-Length": "309876",
                    "Date": "Thu, 06 Nov 2014 15:07:37 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}