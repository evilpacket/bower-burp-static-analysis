{
    "url": "http://localhost:9999/jcd-as/nadion/sample/lib/phaser.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.href</b> and written to <b>window.location.href</b> via the following statements:<ul><li>url = window.location.href;</li><li>var hash = url.split('#');</li><li>url += '#' + hash[1];</li><li>output = url;</li><li>window.location.href = output;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/jcd-as/nadion/sample/lib/phaser.js",
                "path": "/jcd-as/nadion/sample/lib/phaser.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9qY2QtYXMvbmFkaW9uL3NhbXBsZS9saWIvcGhhc2VyLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTM3OTA1Mw0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vamF2YXNjcmlwdA0KRGF0ZTogRnJpLCAwNyBOb3YgMjAxNCAxODo0MDo0OCBHTVQNCkxhc3QtTW9kaWZpZWQ6IEZyaSwgMDcgTm92IDIwMTQgMTg6NDA6NDYgR01UDQoNCiFmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgZGVmaW5lKGZhY3RvcnkpOwogIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICJvYmplY3QiKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOwogIH0gZWxzZSB7CiAgICByb290LlBoYXNlciA9IGZhY3RvcnkoKTsKICB9Cn0odGhpcywgZnVuY3Rpb24oKSB7Ci8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEBvdmVydmlldwoqCiogUGhhc2VyIC0gaHR0cDovL3d3dy5waGFzZXIuaW8KKgoqIHYxLjEuNSAtIEJ1aWx0IGF0OiBXZWQgRmViIDEyIDIwMTQgMDk6NDc6NTYKKgoqIEJ5IFJpY2hhcmQgRGF2ZXkgaHR0cDovL3d3dy5waG90b25zdG9ybS5jb20gQHBob3RvbnN0b3JtCioKKiBBIGZlYXR1cmUtcGFja2VkIDJEIEhUTUw1IGdhbWUgZnJhbWV3b3JrIGJvcm4gZnJvbSB0aGUgc21vdWxkZXJpbmcgcGl0cyBvZiBGbGl4ZWwgYW5kCiogY29uc3RydWN0ZWQgdmlhIHBsZW50eSBvZiBibG9vZCwgc3dlYXQsIHRlYXJzIGFuZCBjb2ZmZWUgYnkgUmljaGFyZCBEYXZleSAoQHBob3RvbnN0b3JtKS4KKgoqIFBoYXNlciB1c2VzIFBpeGkuanMgZm9yIHJlbmRlcmluZywgY3JlYXRlZCBieSBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzLgoqCiogRm9sbG93IFBoYXNlciBkZXZlbG9wbWVudCBwcm9ncmVzcyBhdCBodHRwOi8vd3d3LnBob3RvbnN0b3JtLmNvbQoqCiogTWFueSB0aGFua3MgdG8gQWRhbSBTYWx0c21hbiAoQEFEQU1BVE9NSUMpIGZvciByZWxlYXNpbmcgRmxpeGVsLCBmcm9tIHdoaWNoIGJvdGggUGhhc2VyCiogYW5kIG15IGxvdmUgb2YgZ2FtZSBkZXZlbG9wbWVudCBvcmlnaW5hdGUuCioKKiAiSWYgeW91IHdhbnQgeW91ciBjaGlsZHJlbiB0byBiZSBpbnRlbGxpZ2VudCwgIHJlYWQgdGhlbSBmYWlyeSB0YWxlcy4iCiogIklmIHlvdSB3YW50IHRoZW0gdG8gYmUgbW9yZSBpbnRlbGxpZ2VudCwgcmVhZCB0aGVtIG1vcmUgZmFpcnkgdGFsZXMuIgoqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtLSBBbGJlcnQgRWluc3RlaW4KKi8KCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogQG1vZHVsZSBQSVhJCiAqLwp2YXIgUElYSSA9IFBJWEkgfHwge307CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBAbmFtZXNwYWNlIFBoYXNlcgoqLwp2YXIgUGhhc2VyID0gUGhhc2VyIHx8IHsKCglWRVJTSU9OOiAnMS4xLjUnLAoJREVWX1ZFUlNJT046ICcxLjEuNScsCglHQU1FUzogW10sCgoJQVVUTzogMCwKCUNBTlZBUzogMSwKCVdFQkdMOiAyLAoJSEVBRExFU1M6IDMsCgoJU1BSSVRFOiAwLAoJQlVUVE9OOiAxLAoJQlVMTEVUOiAyLAoJR1JBUEhJQ1M6IDMsCglURVhUOiA0LAoJVElMRVNQUklURTogNSwKCUJJVE1BUFRFWFQ6IDYsCglHUk9VUDogNywKCVJFTkRFUlRFWFRVUkU6IDgsCglUSUxFTUFQOiA5LAoJVElMRU1BUExBWUVSOiAxMCwKCUVNSVRURVI6IDExLAoJUE9MWUdPTjogMTIsCglCSVRNQVBEQVRBOiAxMywKCUNBTlZBU19GSUxURVI6IDE0LAoJV0VCR0xfRklMVEVSOiAxNSwKCglOT05FOiAwLAoJTEVGVDogMSwKCVJJR0hUOiAyLAoJVVA6IDMsCglET1dOOiA0LAoKCUNBTlZBU19QWF9ST1VORDogZmFsc2UsCglDQU5WQVNfQ0xFQVJfUkVDVDogdHJ1ZQoKIH07CgpQSVhJLkludGVyYWN0aW9uTWFuYWdlciA9IGZ1bmN0aW9uIChkdW1teSkgewoJLy8JV2UgZG9uJ3QgbmVlZCB0aGlzIGluIFBpeGksIHNvIHdlJ3ZlIHJlbW92ZWQgaXQgdG8gc2F2ZSBzcGFjZQoJLy8JaG93ZXZlciB0aGUgU3RhZ2Ugb2JqZWN0IGV4cGVjdHMgYSByZWZlcmVuY2UgdG8gaXQsIHNvIGhlcmUgaXMgYSBkdW1teSBlbnRyeS4KfTsKCi8qIGpzaGludCBzdXBlcm5ldzogdHJ1ZSAqLwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQGNsYXNzIFBoYXNlci5VdGlscwoqIEBzdGF0aWMKKi8KUGhhc2VyLlV0aWxzID0gewogICAgCiAgICAvKioKICAgICogQSBzdGFuZGFyZCBGaXNoZXItWWF0ZXMgQXJyYXkgc2h1ZmZsZSBpbXBsZW1lbnRhdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuc2h1ZmZsZQogICAgKiBAcGFyYW0ge2FycmF5fSBhcnJheSAtIFRoZSBhcnJheSB0byBzaHVmZmxlLgogICAgKiBAcmV0dXJuIHthcnJheX0gVGhlIHNodWZmbGVkIGFycmF5LgogICAgKi8KICAgIHNodWZmbGU6IGZ1bmN0aW9uIChhcnJheSkgewoKICAgICAgICBmb3IgKHZhciBpID0gYXJyYXkubGVuZ3RoIC0gMTsgaSA+IDA7IGktLSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBqID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKGkgKyAxKSk7CiAgICAgICAgICAgIHZhciB0ZW1wID0gYXJyYXlbaV07CiAgICAgICAgICAgIGFycmF5W2ldID0gYXJyYXlbal07CiAgICAgICAgICAgIGFycmF5W2pdID0gdGVtcDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIEphdmFzY3JpcHQgc3RyaW5nIHBhZCBodHRwOi8vd3d3LndlYnRvb2xraXQuaW5mby8uCiAgICAqIHBhZCA9IHRoZSBzdHJpbmcgdG8gcGFkIGl0IG91dCB3aXRoIChkZWZhdWx0cyB0byBhIHNwYWNlKQogICAgKiBkaXIgPSAxIChsZWZ0KSwgMiAocmlnaHQpLCAzIChib3RoKQogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5wYWQKICAgICogQHBhcmFtIHtzdHJpbmd9IHN0ciAtIFRoZSB0YXJnZXQgc3RyaW5nLiAKICAgICogQHBhcmFtIHtudW1iZXJ9IGxlbiAtIFRoZSBudW1iZXIgb2YgY2hhcmFjdGVycyB0byBiZSBhZGRlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHBhZCAtIFRoZSBzdHJpbmcgdG8gcGFkIGl0IG91dCB3aXRoIChkZWZhdWx0cyB0byBhIHNwYWNlKS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtkaXI9M10gVGhlIGRpcmVjdGlvbiBkaXIgPSAxIChsZWZ0KSwgMiAocmlnaHQpLCAzIChib3RoKS4KICAgICogQHJldHVybiB7c3RyaW5nfSBUaGUgcGFkZGVkIHN0cmluZwogICAgKi8KICAgIHBhZDogZnVuY3Rpb24gKHN0ciwgbGVuLCBwYWQsIGRpcikgewoKICAgICAgICBpZiAodHlwZW9mKGxlbikgPT0gInVuZGVmaW5lZCIpIHsgdmFyIGxlbiA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mKHBhZCkgPT0gInVuZGVmaW5lZCIpIHsgdmFyIHBhZCA9ICcgJzsgfQogICAgICAgIGlmICh0eXBlb2YoZGlyKSA9PSAidW5kZWZpbmVkIikgeyB2YXIgZGlyID0gMzsgfQoKICAgICAgICB2YXIgcGFkbGVuID0gMDsKCiAgICAgICAgaWYgKGxlbiArIDEgPj0gc3RyLmxlbmd0aCkKICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoZGlyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgc3RyID0gQXJyYXkobGVuICsgMSAtIHN0ci5sZW5ndGgpLmpvaW4ocGFkKSArIHN0cjsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgICAgdmFyIHJpZ2h0ID0gTWF0aC5jZWlsKChwYWRsZW4gPSBsZW4gLSBzdHIubGVuZ3RoKSAvIDIpOwogICAgICAgICAgICAgICAgICAgIHZhciBsZWZ0ID0gcGFkbGVuIC0gcmlnaHQ7CiAgICAgICAgICAgICAgICAgICAgc3RyID0gQXJyYXkobGVmdCsxKS5qb2luKHBhZCkgKyBzdHIgKyBBcnJheShyaWdodCsxKS5qb2luKHBhZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHIgKyBBcnJheShsZW4gKyAxIC0gc3RyLmxlbmd0aCkuam9pbihwYWQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc3RyOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoaXMgaXMgYSBzbGlnaHRseSBtb2RpZmllZCB2ZXJzaW9uIG9mIGpRdWVyeS5pc1BsYWluT2JqZWN0LiBBIHBsYWluIG9iamVjdCBpcyBhbiBvYmplY3Qgd2hvc2UgaW50ZXJuYWwgY2xhc3MgcHJvcGVydHkgaXMgW29iamVjdCBPYmplY3RdLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5pc1BsYWluT2JqZWN0CiAgICAqIEBwYXJhbSB7b2JqZWN0fSBvYmogLSBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IC0gdHJ1ZSBpZiB0aGUgb2JqZWN0IGlzIHBsYWluLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgaXNQbGFpbk9iamVjdDogZnVuY3Rpb24gKG9iaikgewoKICAgICAgICAvLyBOb3QgcGxhaW4gb2JqZWN0czoKICAgICAgICAvLyAtIEFueSBvYmplY3Qgb3IgdmFsdWUgd2hvc2UgaW50ZXJuYWwgW1tDbGFzc11dIHByb3BlcnR5IGlzIG5vdCAiW29iamVjdCBPYmplY3RdIgogICAgICAgIC8vIC0gRE9NIG5vZGVzCiAgICAgICAgLy8gLSB3aW5kb3cKICAgICAgICBpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiIHx8IG9iai5ub2RlVHlwZSB8fCBvYmogPT09IG9iai53aW5kb3cpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDwyMAogICAgICAgIC8vIFRoZSB0cnkvY2F0Y2ggc3VwcHJlc3NlcyBleGNlcHRpb25zIHRocm93biB3aGVuIGF0dGVtcHRpbmcgdG8gYWNjZXNzCiAgICAgICAgLy8gdGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgb2YgY2VydGFpbiBob3N0IG9iamVjdHMsIGllLiB8d2luZG93LmxvY2F0aW9ufAogICAgICAgIC8vIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTgxNDYyMgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChvYmouY29uc3RydWN0b3IgJiYgIWhhc093bi5jYWxsKG9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsICJpc1Byb3RvdHlwZU9mIikpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhlIGZ1bmN0aW9uIGhhc24ndCByZXR1cm5lZCBhbHJlYWR5LCB3ZSdyZSBjb25maWRlbnQgdGhhdAogICAgICAgIC8vIHxvYmp8IGlzIGEgcGxhaW4gb2JqZWN0LCBjcmVhdGVkIGJ5IHt9IG9yIGNvbnN0cnVjdGVkIHdpdGggbmV3IE9iamVjdAogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCgogICAgLy8gIGRlZXAsIHRhcmdldCwgb2JqZWN0cyB0byBjb3B5IHRvIHRoZSB0YXJnZXQgb2JqZWN0CiAgICAvLyAgVGhpcyBpcyBhIHNsaWdodGx5IG1vZGlmaWVkIHZlcnNpb24gb2Yge0BsaW5rIGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9qUXVlcnkuZXh0ZW5kL3xqUXVlcnkuZXh0ZW5kfQogICAgLy8gIGRlZXAgKGJvb2xlYW4pCiAgICAvLyAgdGFyZ2V0IChvYmplY3QgdG8gYWRkIHRvKQogICAgLy8gIG9iamVjdHMgLi4uIChvYmplY3RzIHRvIHJlY3Vyc2UgYW5kIGNvcHkgZnJvbSkKCiAgICAvKioKICAgICogVGhpcyBpcyBhIHNsaWdodGx5IG1vZGlmaWVkIHZlcnNpb24gb2YgaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS5leHRlbmQvCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLmV4dGVuZAogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGRlZXAgLSBQZXJmb3JtIGEgZGVlcCBjb3B5PwogICAgKiBAcGFyYW0ge29iamVjdH0gdGFyZ2V0IC0gVGhlIHRhcmdldCBvYmplY3QgdG8gY29weSB0by4KICAgICogQHJldHVybiB7b2JqZWN0fSBUaGUgZXh0ZW5kZWQgb2JqZWN0LgogICAgKi8KICAgIGV4dGVuZDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgb3B0aW9ucywgbmFtZSwgc3JjLCBjb3B5LCBjb3B5SXNBcnJheSwgY2xvbmUsCiAgICAgICAgICAgIHRhcmdldCA9IGFyZ3VtZW50c1swXSB8fCB7fSwKICAgICAgICAgICAgaSA9IDEsCiAgICAgICAgICAgIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsCiAgICAgICAgICAgIGRlZXAgPSBmYWxzZTsKCiAgICAgICAgLy8gSGFuZGxlIGEgZGVlcCBjb3B5IHNpdHVhdGlvbgogICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiIpCiAgICAgICAgewogICAgICAgICAgICBkZWVwID0gdGFyZ2V0OwogICAgICAgICAgICB0YXJnZXQgPSBhcmd1bWVudHNbMV0gfHwge307CiAgICAgICAgICAgIC8vIHNraXAgdGhlIGJvb2xlYW4gYW5kIHRoZSB0YXJnZXQKICAgICAgICAgICAgaSA9IDI7CiAgICAgICAgfQoKICAgICAgICAvLyBleHRlbmQgUGhhc2VyIGlmIG9ubHkgb25lIGFyZ3VtZW50IGlzIHBhc3NlZAogICAgICAgIGlmIChsZW5ndGggPT09IGkpCiAgICAgICAgewogICAgICAgICAgICB0YXJnZXQgPSB0aGlzOwogICAgICAgICAgICAtLWk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApCiAgICAgICAgewogICAgICAgICAgICAvLyBPbmx5IGRlYWwgd2l0aCBub24tbnVsbC91bmRlZmluZWQgdmFsdWVzCiAgICAgICAgICAgIGlmICgob3B0aW9ucyA9IGFyZ3VtZW50c1tpXSkgIT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gRXh0ZW5kIHRoZSBiYXNlIG9iamVjdAogICAgICAgICAgICAgICAgZm9yIChuYW1lIGluIG9wdGlvbnMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc3JjID0gdGFyZ2V0W25hbWVdOwogICAgICAgICAgICAgICAgICAgIGNvcHkgPSBvcHRpb25zW25hbWVdOwoKICAgICAgICAgICAgICAgICAgICAvLyBQcmV2ZW50IG5ldmVyLWVuZGluZyBsb29wCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldCA9PT0gY29weSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gUmVjdXJzZSBpZiB3ZSdyZSBtZXJnaW5nIHBsYWluIG9iamVjdHMgb3IgYXJyYXlzCiAgICAgICAgICAgICAgICAgICAgaWYgKGRlZXAgJiYgY29weSAmJiAoUGhhc2VyLlV0aWxzLmlzUGxhaW5PYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0gQXJyYXkuaXNBcnJheShjb3B5KSkpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvcHlJc0FycmF5KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3B5SXNBcnJheSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xvbmUgPSBzcmMgJiYgQXJyYXkuaXNBcnJheShzcmMpID8gc3JjIDogW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbG9uZSA9IHNyYyAmJiBQaGFzZXIuVXRpbHMuaXNQbGFpbk9iamVjdChzcmMpID8gc3JjIDoge307CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRbbmFtZV0gPSBQaGFzZXIuVXRpbHMuZXh0ZW5kKGRlZXAsIGNsb25lLCBjb3B5KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgYnJpbmcgaW4gdW5kZWZpbmVkIHZhbHVlcwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChjb3B5ICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRbbmFtZV0gPSBjb3B5OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gUmV0dXJuIHRoZSBtb2RpZmllZCBvYmplY3QKICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQoKfTsKCmZ1bmN0aW9uIEhFWHRvUkdCKGhleCkgewogICAgcmV0dXJuIFsoaGV4ID4+IDE2ICYgMHhGRikgLyAyNTUsICggaGV4ID4+IDggJiAweEZGKSAvIDI1NSwgKGhleCAmIDB4RkYpLyAyNTVdOwp9CgpQSVhJLmhleDJyZ2IgPSBmdW5jdGlvbiBoZXgycmdiKGhleCkgewogICAgcmV0dXJuIFsoaGV4ID4+IDE2ICYgMHhGRikgLyAyNTUsICggaGV4ID4+IDggJiAweEZGKSAvIDI1NSwgKGhleCAmIDB4RkYpLyAyNTVdOwp9OwoKLyoqCiogQSBwb2x5ZmlsbCBmb3IgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQKKi8KaWYgKHR5cGVvZiBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCAhPSAnZnVuY3Rpb24nKSB7CgogICAgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgPSAoZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAodGhpc0FyZykgewoKICAgICAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMsIGJvdW5kQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKIAogICAgICAgICAgICBpZiAodHlwZW9mIHRhcmdldCAhPSAnZnVuY3Rpb24nKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgICAgICAgICAgIH0KIAogICAgICAgICAgICBmdW5jdGlvbiBib3VuZCgpIHsKICAgICAgICAgICAgICAgIHZhciBhcmdzID0gYm91bmRBcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpOwogICAgICAgICAgICAgICAgdGFyZ2V0LmFwcGx5KHRoaXMgaW5zdGFuY2VvZiBib3VuZCA/IHRoaXMgOiB0aGlzQXJnLCBhcmdzKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGJvdW5kLnByb3RvdHlwZSA9IChmdW5jdGlvbiBGKHByb3RvKSB7CiAgICAgICAgICAgICAgICBwcm90byAmJiAoRi5wcm90b3R5cGUgPSBwcm90byk7CgogICAgICAgICAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIEYpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkodGFyZ2V0LnByb3RvdHlwZSk7CiAKICAgICAgICAgICAgcmV0dXJuIGJvdW5kOwogICAgICAgIH07CiAgICB9KSgpOwp9CgovKioKKiBBIHBvbHlmaWxsIGZvciBBcnJheS5pc0FycmF5CiovCmlmICghQXJyYXkuaXNBcnJheSkgewogIEFycmF5LmlzQXJyYXkgPSBmdW5jdGlvbiAoYXJnKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGFyZykgPT0gJ1tvYmplY3QgQXJyYXldJzsKICB9Owp9CgoKCgovKgogKiBBIGxpZ2h0ZXIgdmVyc2lvbiBvZiB0aGUgcmFkIGdsLW1hdHJpeCBjcmVhdGVkIGJ5IEJyYW5kb24gSm9uZXMsIENvbGluIE1hY0tlbnppZSBJVgogKiB5b3UgYm90aCByb2NrIQogKi8KCmZ1bmN0aW9uIGRldGVybWluZU1hdHJpeEFycmF5VHlwZSgpIHsKICAgIFBJWEkuTWF0cml4ID0gKHR5cGVvZiBGbG9hdDMyQXJyYXkgIT09ICd1bmRlZmluZWQnKSA/IEZsb2F0MzJBcnJheSA6IEFycmF5OwogICAgcmV0dXJuIFBJWEkuTWF0cml4Owp9CgpkZXRlcm1pbmVNYXRyaXhBcnJheVR5cGUoKTsKClBJWEkubWF0MyA9IHt9OwoKUElYSS5tYXQzLmNyZWF0ZSA9IGZ1bmN0aW9uKCkKewogICAgdmFyIG1hdHJpeCA9IG5ldyBQSVhJLk1hdHJpeCg5KTsKCiAgICBtYXRyaXhbMF0gPSAxOwogICAgbWF0cml4WzFdID0gMDsKICAgIG1hdHJpeFsyXSA9IDA7CiAgICBtYXRyaXhbM10gPSAwOwogICAgbWF0cml4WzRdID0gMTsKICAgIG1hdHJpeFs1XSA9IDA7CiAgICBtYXRyaXhbNl0gPSAwOwogICAgbWF0cml4WzddID0gMDsKICAgIG1hdHJpeFs4XSA9IDE7CgogICAgcmV0dXJuIG1hdHJpeDsKfTsKCgpQSVhJLm1hdDMuaWRlbnRpdHkgPSBmdW5jdGlvbihtYXRyaXgpCnsKICAgIG1hdHJpeFswXSA9IDE7CiAgICBtYXRyaXhbMV0gPSAwOwogICAgbWF0cml4WzJdID0gMDsKICAgIG1hdHJpeFszXSA9IDA7CiAgICBtYXRyaXhbNF0gPSAxOwogICAgbWF0cml4WzVdID0gMDsKICAgIG1hdHJpeFs2XSA9IDA7CiAgICBtYXRyaXhbN10gPSAwOwogICAgbWF0cml4WzhdID0gMTsKCiAgICByZXR1cm4gbWF0cml4Owp9OwoKClBJWEkubWF0NCA9IHt9OwoKUElYSS5tYXQ0LmNyZWF0ZSA9IGZ1bmN0aW9uKCkKewogICAgdmFyIG1hdHJpeCA9IG5ldyBQSVhJLk1hdHJpeCgxNik7CgogICAgbWF0cml4WzBdID0gMTsKICAgIG1hdHJpeFsxXSA9IDA7CiAgICBtYXRyaXhbMl0gPSAwOwogICAgbWF0cml4WzNdID0gMDsKICAgIG1hdHJpeFs0XSA9IDA7CiAgICBtYXRyaXhbNV0gPSAxOwogICAgbWF0cml4WzZdID0gMDsKICAgIG1hdHJpeFs3XSA9IDA7CiAgICBtYXRyaXhbOF0gPSAwOwogICAgbWF0cml4WzldID0gMDsKICAgIG1hdHJpeFsxMF0gPSAxOwogICAgbWF0cml4WzExXSA9IDA7CiAgICBtYXRyaXhbMTJdID0gMDsKICAgIG1hdHJpeFsxM10gPSAwOwogICAgbWF0cml4WzE0XSA9IDA7CiAgICBtYXRyaXhbMTVdID0gMTsKCiAgICByZXR1cm4gbWF0cml4Owp9OwoKUElYSS5tYXQzLm11bHRpcGx5ID0gZnVuY3Rpb24gKG1hdCwgbWF0MiwgZGVzdCkKewogICAgaWYgKCFkZXN0KSB7IGRlc3QgPSBtYXQ7IH0KCiAgICAvLyBDYWNoZSB0aGUgbWF0cml4IHZhbHVlcyAobWFrZXMgZm9yIGh1Z2Ugc3BlZWQgaW5jcmVhc2VzISkKICAgIHZhciBhMDAgPSBtYXRbMF0sIGEwMSA9IG1hdFsxXSwgYTAyID0gbWF0WzJdLAogICAgICAgIGExMCA9IG1hdFszXSwgYTExID0gbWF0WzRdLCBhMTIgPSBtYXRbNV0sCiAgICAgICAgYTIwID0gbWF0WzZdLCBhMjEgPSBtYXRbN10sIGEyMiA9IG1hdFs4XSwKCiAgICAgICAgYjAwID0gbWF0MlswXSwgYjAxID0gbWF0MlsxXSwgYjAyID0gbWF0MlsyXSwKICAgICAgICBiMTAgPSBtYXQyWzNdLCBiMTEgPSBtYXQyWzRdLCBiMTIgPSBtYXQyWzVdLAogICAgICAgIGIyMCA9IG1hdDJbNl0sIGIyMSA9IG1hdDJbN10sIGIyMiA9IG1hdDJbOF07CgogICAgZGVzdFswXSA9IGIwMCAqIGEwMCArIGIwMSAqIGExMCArIGIwMiAqIGEyMDsKICAgIGRlc3RbMV0gPSBiMDAgKiBhMDEgKyBiMDEgKiBhMTEgKyBiMDIgKiBhMjE7CiAgICBkZXN0WzJdID0gYjAwICogYTAyICsgYjAxICogYTEyICsgYjAyICogYTIyOwoKICAgIGRlc3RbM10gPSBiMTAgKiBhMDAgKyBiMTEgKiBhMTAgKyBiMTIgKiBhMjA7CiAgICBkZXN0WzRdID0gYjEwICogYTAxICsgYjExICogYTExICsgYjEyICogYTIxOwogICAgZGVzdFs1XSA9IGIxMCAqIGEwMiArIGIxMSAqIGExMiArIGIxMiAqIGEyMjsKCiAgICBkZXN0WzZdID0gYjIwICogYTAwICsgYjIxICogYTEwICsgYjIyICogYTIwOwogICAgZGVzdFs3XSA9IGIyMCAqIGEwMSArIGIyMSAqIGExMSArIGIyMiAqIGEyMTsKICAgIGRlc3RbOF0gPSBiMjAgKiBhMDIgKyBiMjEgKiBhMTIgKyBiMjIgKiBhMjI7CgogICAgcmV0dXJuIGRlc3Q7Cn07CgpQSVhJLm1hdDMuY2xvbmUgPSBmdW5jdGlvbihtYXQpCnsKICAgIHZhciBtYXRyaXggPSBuZXcgUElYSS5NYXRyaXgoOSk7CgogICAgbWF0cml4WzBdID0gbWF0WzBdOwogICAgbWF0cml4WzFdID0gbWF0WzFdOwogICAgbWF0cml4WzJdID0gbWF0WzJdOwogICAgbWF0cml4WzNdID0gbWF0WzNdOwogICAgbWF0cml4WzRdID0gbWF0WzRdOwogICAgbWF0cml4WzVdID0gbWF0WzVdOwogICAgbWF0cml4WzZdID0gbWF0WzZdOwogICAgbWF0cml4WzddID0gbWF0WzddOwogICAgbWF0cml4WzhdID0gbWF0WzhdOwoKICAgIHJldHVybiBtYXRyaXg7Cn07CgpQSVhJLm1hdDMudHJhbnNwb3NlID0gZnVuY3Rpb24gKG1hdCwgZGVzdCkKewogICAgLy8gSWYgd2UgYXJlIHRyYW5zcG9zaW5nIG91cnNlbHZlcyB3ZSBjYW4gc2tpcCBhIGZldyBzdGVwcyBidXQgaGF2ZSB0byBjYWNoZSBzb21lIHZhbHVlcwogICAgaWYgKCFkZXN0IHx8IG1hdCA9PT0gZGVzdCkgewogICAgICAgIHZhciBhMDEgPSBtYXRbMV0sIGEwMiA9IG1hdFsyXSwKICAgICAgICAgICAgYTEyID0gbWF0WzVdOwoKICAgICAgICBtYXRbMV0gPSBtYXRbM107CiAgICAgICAgbWF0WzJdID0gbWF0WzZdOwogICAgICAgIG1hdFszXSA9IGEwMTsKICAgICAgICBtYXRbNV0gPSBtYXRbN107CiAgICAgICAgbWF0WzZdID0gYTAyOwogICAgICAgIG1hdFs3XSA9IGExMjsKICAgICAgICByZXR1cm4gbWF0OwogICAgfQoKICAgIGRlc3RbMF0gPSBtYXRbMF07CiAgICBkZXN0WzFdID0gbWF0WzNdOwogICAgZGVzdFsyXSA9IG1hdFs2XTsKICAgIGRlc3RbM10gPSBtYXRbMV07CiAgICBkZXN0WzRdID0gbWF0WzRdOwogICAgZGVzdFs1XSA9IG1hdFs3XTsKICAgIGRlc3RbNl0gPSBtYXRbMl07CiAgICBkZXN0WzddID0gbWF0WzVdOwogICAgZGVzdFs4XSA9IG1hdFs4XTsKICAgIHJldHVybiBkZXN0Owp9OwoKUElYSS5tYXQzLnRvTWF0NCA9IGZ1bmN0aW9uIChtYXQsIGRlc3QpCnsKICAgIGlmICghZGVzdCkgeyBkZXN0ID0gUElYSS5tYXQ0LmNyZWF0ZSgpOyB9CgogICAgZGVzdFsxNV0gPSAxOwogICAgZGVzdFsxNF0gPSAwOwogICAgZGVzdFsxM10gPSAwOwogICAgZGVzdFsxMl0gPSAwOwoKICAgIGRlc3RbMTFdID0gMDsKICAgIGRlc3RbMTBdID0gbWF0WzhdOwogICAgZGVzdFs5XSA9IG1hdFs3XTsKICAgIGRlc3RbOF0gPSBtYXRbNl07CgogICAgZGVzdFs3XSA9IDA7CiAgICBkZXN0WzZdID0gbWF0WzVdOwogICAgZGVzdFs1XSA9IG1hdFs0XTsKICAgIGRlc3RbNF0gPSBtYXRbM107CgogICAgZGVzdFszXSA9IDA7CiAgICBkZXN0WzJdID0gbWF0WzJdOwogICAgZGVzdFsxXSA9IG1hdFsxXTsKICAgIGRlc3RbMF0gPSBtYXRbMF07CgogICAgcmV0dXJuIGRlc3Q7Cn07CgoKLy8vLy8KCgpQSVhJLm1hdDQuY3JlYXRlID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgbWF0cml4ID0gbmV3IFBJWEkuTWF0cml4KDE2KTsKCiAgICBtYXRyaXhbMF0gPSAxOwogICAgbWF0cml4WzFdID0gMDsKICAgIG1hdHJpeFsyXSA9IDA7CiAgICBtYXRyaXhbM10gPSAwOwogICAgbWF0cml4WzRdID0gMDsKICAgIG1hdHJpeFs1XSA9IDE7CiAgICBtYXRyaXhbNl0gPSAwOwogICAgbWF0cml4WzddID0gMDsKICAgIG1hdHJpeFs4XSA9IDA7CiAgICBtYXRyaXhbOV0gPSAwOwogICAgbWF0cml4WzEwXSA9IDE7CiAgICBtYXRyaXhbMTFdID0gMDsKICAgIG1hdHJpeFsxMl0gPSAwOwogICAgbWF0cml4WzEzXSA9IDA7CiAgICBtYXRyaXhbMTRdID0gMDsKICAgIG1hdHJpeFsxNV0gPSAxOwoKICAgIHJldHVybiBtYXRyaXg7Cn07CgpQSVhJLm1hdDQudHJhbnNwb3NlID0gZnVuY3Rpb24gKG1hdCwgZGVzdCkKewogICAgLy8gSWYgd2UgYXJlIHRyYW5zcG9zaW5nIG91cnNlbHZlcyB3ZSBjYW4gc2tpcCBhIGZldyBzdGVwcyBidXQgaGF2ZSB0byBjYWNoZSBzb21lIHZhbHVlcwogICAgaWYgKCFkZXN0IHx8IG1hdCA9PT0gZGVzdCkKICAgIHsKICAgICAgICB2YXIgYTAxID0gbWF0WzFdLCBhMDIgPSBtYXRbMl0sIGEwMyA9IG1hdFszXSwKICAgICAgICAgICAgYTEyID0gbWF0WzZdLCBhMTMgPSBtYXRbN10sCiAgICAgICAgICAgIGEyMyA9IG1hdFsxMV07CgogICAgICAgIG1hdFsxXSA9IG1hdFs0XTsKICAgICAgICBtYXRbMl0gPSBtYXRbOF07CiAgICAgICAgbWF0WzNdID0gbWF0WzEyXTsKICAgICAgICBtYXRbNF0gPSBhMDE7CiAgICAgICAgbWF0WzZdID0gbWF0WzldOwogICAgICAgIG1hdFs3XSA9IG1hdFsxM107CiAgICAgICAgbWF0WzhdID0gYTAyOwogICAgICAgIG1hdFs5XSA9IGExMjsKICAgICAgICBtYXRbMTFdID0gbWF0WzE0XTsKICAgICAgICBtYXRbMTJdID0gYTAzOwogICAgICAgIG1hdFsxM10gPSBhMTM7CiAgICAgICAgbWF0WzE0XSA9IGEyMzsKICAgICAgICByZXR1cm4gbWF0OwogICAgfQoKICAgIGRlc3RbMF0gPSBtYXRbMF07CiAgICBkZXN0WzFdID0gbWF0WzRdOwogICAgZGVzdFsyXSA9IG1hdFs4XTsKICAgIGRlc3RbM10gPSBtYXRbMTJdOwogICAgZGVzdFs0XSA9IG1hdFsxXTsKICAgIGRlc3RbNV0gPSBtYXRbNV07CiAgICBkZXN0WzZdID0gbWF0WzldOwogICAgZGVzdFs3XSA9IG1hdFsxM107CiAgICBkZXN0WzhdID0gbWF0WzJdOwogICAgZGVzdFs5XSA9IG1hdFs2XTsKICAgIGRlc3RbMTBdID0gbWF0WzEwXTsKICAgIGRlc3RbMTFdID0gbWF0WzE0XTsKICAgIGRlc3RbMTJdID0gbWF0WzNdOwogICAgZGVzdFsxM10gPSBtYXRbN107CiAgICBkZXN0WzE0XSA9IG1hdFsxMV07CiAgICBkZXN0WzE1XSA9IG1hdFsxNV07CiAgICByZXR1cm4gZGVzdDsKfTsKClBJWEkubWF0NC5tdWx0aXBseSA9IGZ1bmN0aW9uIChtYXQsIG1hdDIsIGRlc3QpCnsKICAgIGlmICghZGVzdCkgeyBkZXN0ID0gbWF0OyB9CgogICAgLy8gQ2FjaGUgdGhlIG1hdHJpeCB2YWx1ZXMgKG1ha2VzIGZvciBodWdlIHNwZWVkIGluY3JlYXNlcyEpCiAgICB2YXIgYTAwID0gbWF0WyAwXSwgYTAxID0gbWF0WyAxXSwgYTAyID0gbWF0WyAyXSwgYTAzID0gbWF0WzNdOwogICAgdmFyIGExMCA9IG1hdFsgNF0sIGExMSA9IG1hdFsgNV0sIGExMiA9IG1hdFsgNl0sIGExMyA9IG1hdFs3XTsKICAgIHZhciBhMjAgPSBtYXRbIDhdLCBhMjEgPSBtYXRbIDldLCBhMjIgPSBtYXRbMTBdLCBhMjMgPSBtYXRbMTFdOwogICAgdmFyIGEzMCA9IG1hdFsxMl0sIGEzMSA9IG1hdFsxM10sIGEzMiA9IG1hdFsxNF0sIGEzMyA9IG1hdFsxNV07CgogICAgLy8gQ2FjaGUgb25seSB0aGUgY3VycmVudCBsaW5lIG9mIHRoZSBzZWNvbmQgbWF0cml4CiAgICB2YXIgYjAgID0gbWF0MlswXSwgYjEgPSBtYXQyWzFdLCBiMiA9IG1hdDJbMl0sIGIzID0gbWF0MlszXTsKICAgIGRlc3RbMF0gPSBiMCphMDAgKyBiMSphMTAgKyBiMiphMjAgKyBiMyphMzA7CiAgICBkZXN0WzFdID0gYjAqYTAxICsgYjEqYTExICsgYjIqYTIxICsgYjMqYTMxOwogICAgZGVzdFsyXSA9IGIwKmEwMiArIGIxKmExMiArIGIyKmEyMiArIGIzKmEzMjsKICAgIGRlc3RbM10gPSBiMCphMDMgKyBiMSphMTMgKyBiMiphMjMgKyBiMyphMzM7CgogICAgYjAgPSBtYXQyWzRdOwogICAgYjEgPSBtYXQyWzVdOwogICAgYjIgPSBtYXQyWzZdOwogICAgYjMgPSBtYXQyWzddOwogICAgZGVzdFs0XSA9IGIwKmEwMCArIGIxKmExMCArIGIyKmEyMCArIGIzKmEzMDsKICAgIGRlc3RbNV0gPSBiMCphMDEgKyBiMSphMTEgKyBiMiphMjEgKyBiMyphMzE7CiAgICBkZXN0WzZdID0gYjAqYTAyICsgYjEqYTEyICsgYjIqYTIyICsgYjMqYTMyOwogICAgZGVzdFs3XSA9IGIwKmEwMyArIGIxKmExMyArIGIyKmEyMyArIGIzKmEzMzsKCiAgICBiMCA9IG1hdDJbOF07CiAgICBiMSA9IG1hdDJbOV07CiAgICBiMiA9IG1hdDJbMTBdOwogICAgYjMgPSBtYXQyWzExXTsKICAgIGRlc3RbOF0gPSBiMCphMDAgKyBiMSphMTAgKyBiMiphMjAgKyBiMyphMzA7CiAgICBkZXN0WzldID0gYjAqYTAxICsgYjEqYTExICsgYjIqYTIxICsgYjMqYTMxOwogICAgZGVzdFsxMF0gPSBiMCphMDIgKyBiMSphMTIgKyBiMiphMjIgKyBiMyphMzI7CiAgICBkZXN0WzExXSA9IGIwKmEwMyArIGIxKmExMyArIGIyKmEyMyArIGIzKmEzMzsKCiAgICBiMCA9IG1hdDJbMTJdOwogICAgYjEgPSBtYXQyWzEzXTsKICAgIGIyID0gbWF0MlsxNF07CiAgICBiMyA9IG1hdDJbMTVdOwogICAgZGVzdFsxMl0gPSBiMCphMDAgKyBiMSphMTAgKyBiMiphMjAgKyBiMyphMzA7CiAgICBkZXN0WzEzXSA9IGIwKmEwMSArIGIxKmExMSArIGIyKmEyMSArIGIzKmEzMTsKICAgIGRlc3RbMTRdID0gYjAqYTAyICsgYjEqYTEyICsgYjIqYTIyICsgYjMqYTMyOwogICAgZGVzdFsxNV0gPSBiMCphMDMgKyBiMSphMTMgKyBiMiphMjMgKyBiMyphMzM7CgogICAgcmV0dXJuIGRlc3Q7Cn07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIFRoZSBQb2ludCBvYmplY3QgcmVwcmVzZW50cyBhIGxvY2F0aW9uIGluIGEgdHdvLWRpbWVuc2lvbmFsIGNvb3JkaW5hdGUgc3lzdGVtLCB3aGVyZSB4IHJlcHJlc2VudHMgdGhlIGhvcml6b250YWwgYXhpcyBhbmQgeSByZXByZXNlbnRzIHRoZSB2ZXJ0aWNhbCBheGlzLgogKgogKiBAY2xhc3MgUG9pbnQKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IHBvc2l0aW9uIG9mIHRoZSBwb2ludAogKiBAcGFyYW0geSB7TnVtYmVyfSBwb3NpdGlvbiBvZiB0aGUgcG9pbnQKICovClBJWEkuUG9pbnQgPSBmdW5jdGlvbih4LCB5KQp7CiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB4CiAgICAgKiBAdHlwZSBOdW1iZXIKICAgICAqIEBkZWZhdWx0IDAKICAgICAqLwogICAgdGhpcy54ID0geCB8fCAwOwoKICAgIC8qKgogICAgICogQHByb3BlcnR5IHkKICAgICAqIEB0eXBlIE51bWJlcgogICAgICogQGRlZmF1bHQgMAogICAgICovCiAgICB0aGlzLnkgPSB5IHx8IDA7Cn07CgovKioKICogQ3JlYXRlcyBhIGNsb25lIG9mIHRoaXMgcG9pbnQKICoKICogQG1ldGhvZCBjbG9uZQogKiBAcmV0dXJuIHtQb2ludH0gYSBjb3B5IG9mIHRoZSBwb2ludAogKi8KUElYSS5Qb2ludC5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbigpCnsKICAgIHJldHVybiBuZXcgUElYSS5Qb2ludCh0aGlzLngsIHRoaXMueSk7Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlBvaW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuUG9pbnQ7CgoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8KICovCgovKioKICogdGhlIFJlY3RhbmdsZSBvYmplY3QgaXMgYW4gYXJlYSBkZWZpbmVkIGJ5IGl0cyBwb3NpdGlvbiwgYXMgaW5kaWNhdGVkIGJ5IGl0cyB0b3AtbGVmdCBjb3JuZXIgcG9pbnQgKHgsIHkpIGFuZCBieSBpdHMgd2lkdGggYW5kIGl0cyBoZWlnaHQuCiAqCiAqIEBjbGFzcyBSZWN0YW5nbGUKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IFRoZSBYIGNvb3JkIG9mIHRoZSB1cHBlci1sZWZ0IGNvcm5lciBvZiB0aGUgcmVjdGFuZ2xlCiAqIEBwYXJhbSB5IHtOdW1iZXJ9IFRoZSBZIGNvb3JkIG9mIHRoZSB1cHBlci1sZWZ0IGNvcm5lciBvZiB0aGUgcmVjdGFuZ2xlCiAqIEBwYXJhbSB3aWR0aCB7TnVtYmVyfSBUaGUgb3ZlcmFsbCB3aWR0aCBvZiB0aGlzIHJlY3RhbmdsZQogKiBAcGFyYW0gaGVpZ2h0IHtOdW1iZXJ9IFRoZSBvdmVyYWxsIGhlaWdodCBvZiB0aGlzIHJlY3RhbmdsZQogKi8KUElYSS5SZWN0YW5nbGUgPSBmdW5jdGlvbih4LCB5LCB3aWR0aCwgaGVpZ2h0KQp7CiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB4CiAgICAgKiBAdHlwZSBOdW1iZXIKICAgICAqIEBkZWZhdWx0IDAKICAgICAqLwogICAgdGhpcy54ID0geCB8fCAwOwoKICAgIC8qKgogICAgICogQHByb3BlcnR5IHkKICAgICAqIEB0eXBlIE51bWJlcgogICAgICogQGRlZmF1bHQgMAogICAgICovCiAgICB0aGlzLnkgPSB5IHx8IDA7CgogICAgLyoqCiAgICAgKiBAcHJvcGVydHkgd2lkdGgKICAgICAqIEB0eXBlIE51bWJlcgogICAgICogQGRlZmF1bHQgMAogICAgICovCiAgICB0aGlzLndpZHRoID0gd2lkdGggfHwgMDsKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSBoZWlnaHQKICAgICAqIEB0eXBlIE51bWJlcgogICAgICogQGRlZmF1bHQgMAogICAgICovCiAgICB0aGlzLmhlaWdodCA9IGhlaWdodCB8fCAwOwp9OwoKLyoqCiAqIENyZWF0ZXMgYSBjbG9uZSBvZiB0aGlzIFJlY3RhbmdsZQogKgogKiBAbWV0aG9kIGNsb25lCiAqIEByZXR1cm4ge1JlY3RhbmdsZX0gYSBjb3B5IG9mIHRoZSByZWN0YW5nbGUKICovClBJWEkuUmVjdGFuZ2xlLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkKewogICAgcmV0dXJuIG5ldyBQSVhJLlJlY3RhbmdsZSh0aGlzLngsIHRoaXMueSwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwp9OwoKLyoqCiAqIENoZWNrcyBpZiB0aGUgeCwgYW5kIHkgY29vcmRzIHBhc3NlZCB0byB0aGlzIGZ1bmN0aW9uIGFyZSBjb250YWluZWQgd2l0aGluIHRoaXMgUmVjdGFuZ2xlCiAqCiAqIEBtZXRob2QgY29udGFpbnMKICogQHBhcmFtIHgge051bWJlcn0gVGhlIFggY29vcmQgb2YgdGhlIHBvaW50IHRvIHRlc3QKICogQHBhcmFtIHkge051bWJlcn0gVGhlIFkgY29vcmQgb2YgdGhlIHBvaW50IHRvIHRlc3QKICogQHJldHVybiB7Qm9vbGVhbn0gaWYgdGhlIHgveSBjb29yZHMgYXJlIHdpdGhpbiB0aGlzIFJlY3RhbmdsZQogKi8KUElYSS5SZWN0YW5nbGUucHJvdG90eXBlLmNvbnRhaW5zID0gZnVuY3Rpb24oeCwgeSkKewogICAgaWYodGhpcy53aWR0aCA8PSAwIHx8IHRoaXMuaGVpZ2h0IDw9IDApCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIHZhciB4MSA9IHRoaXMueDsKICAgIGlmKHggPj0geDEgJiYgeCA8PSB4MSArIHRoaXMud2lkdGgpCiAgICB7CiAgICAgICAgdmFyIHkxID0gdGhpcy55OwoKICAgICAgICBpZih5ID49IHkxICYmIHkgPD0geTEgKyB0aGlzLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2U7Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlJlY3RhbmdsZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlJlY3RhbmdsZTsKCgovKioKICogQGF1dGhvciBBZHJpZW4gQnJhdWx0IDxhZHJpZW4uYnJhdWx0QGdtYWlsLmNvbT4KICovCgovKioKICogQGNsYXNzIFBvbHlnb24KICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSBwb2ludHMqIHtBcnJheTxQb2ludD58QXJyYXk8TnVtYmVyPnxQb2ludC4uLnxOdW1iZXIuLi59IFRoaXMgY2FuIGJlIGFuIGFycmF5IG9mIFBvaW50cyB0aGF0IGZvcm0gdGhlIHBvbHlnb24sCiAqICAgICAgYSBmbGF0IGFycmF5IG9mIG51bWJlcnMgdGhhdCB3aWxsIGJlIGludGVycHJldGVkIGFzIFt4LHksIHgseSwgLi4uXSwgb3IgdGhlIGFyZ3VtZW50cyBwYXNzZWQgY2FuIGJlCiAqICAgICAgYWxsIHRoZSBwb2ludHMgb2YgdGhlIHBvbHlnb24gZS5nLiBgbmV3IFBJWEkuUG9seWdvbihuZXcgUElYSS5Qb2ludCgpLCBuZXcgUElYSS5Qb2ludCgpLCAuLi4pYCwgb3IgdGhlCiAqICAgICAgYXJndW1lbnRzIHBhc3NlZCBjYW4gYmUgZmxhdCB4LHkgdmFsdWVzIGUuZy4gYG5ldyBQSVhJLlBvbHlnb24oeCx5LCB4LHksIHgseSwgLi4uKWAgd2hlcmUgYHhgIGFuZCBgeWAgYXJlCiAqICAgICAgTnVtYmVycy4KICovClBJWEkuUG9seWdvbiA9IGZ1bmN0aW9uKHBvaW50cykKewogICAgLy9pZiBwb2ludHMgaXNuJ3QgYW4gYXJyYXksIHVzZSBhcmd1bWVudHMgYXMgdGhlIGFycmF5CiAgICBpZighKHBvaW50cyBpbnN0YW5jZW9mIEFycmF5KSkKICAgICAgICBwb2ludHMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwoKICAgIC8vaWYgdGhpcyBpcyBhIGZsYXQgYXJyYXkgb2YgbnVtYmVycywgY29udmVydCBpdCB0byBwb2ludHMKICAgIGlmKHR5cGVvZiBwb2ludHNbMF0gPT09ICdudW1iZXInKSB7CiAgICAgICAgdmFyIHAgPSBbXTsKICAgICAgICBmb3IodmFyIGkgPSAwLCBpbCA9IHBvaW50cy5sZW5ndGg7IGkgPCBpbDsgaSs9MikgewogICAgICAgICAgICBwLnB1c2goCiAgICAgICAgICAgICAgICBuZXcgUElYSS5Qb2ludChwb2ludHNbaV0sIHBvaW50c1tpICsgMV0pCiAgICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICBwb2ludHMgPSBwOwogICAgfQoKICAgIHRoaXMucG9pbnRzID0gcG9pbnRzOwp9OwoKLyoqCiAqIENyZWF0ZXMgYSBjbG9uZSBvZiB0aGlzIHBvbHlnb24KICoKICogQG1ldGhvZCBjbG9uZQogKiBAcmV0dXJuIHtQb2x5Z29ufSBhIGNvcHkgb2YgdGhlIHBvbHlnb24KICovClBJWEkuUG9seWdvbi5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbigpCnsKICAgIHZhciBwb2ludHMgPSBbXTsKICAgIGZvciAodmFyIGk9MDsgaTx0aGlzLnBvaW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIHBvaW50cy5wdXNoKHRoaXMucG9pbnRzW2ldLmNsb25lKCkpOwogICAgfQoKICAgIHJldHVybiBuZXcgUElYSS5Qb2x5Z29uKHBvaW50cyk7Cn07CgovKioKICogQ2hlY2tzIGlmIHRoZSB4LCBhbmQgeSBjb29yZHMgcGFzc2VkIHRvIHRoaXMgZnVuY3Rpb24gYXJlIGNvbnRhaW5lZCB3aXRoaW4gdGhpcyBwb2x5Z29uCiAqCiAqIEBtZXRob2QgY29udGFpbnMKICogQHBhcmFtIHgge051bWJlcn0gVGhlIFggY29vcmQgb2YgdGhlIHBvaW50IHRvIHRlc3QKICogQHBhcmFtIHkge051bWJlcn0gVGhlIFkgY29vcmQgb2YgdGhlIHBvaW50IHRvIHRlc3QKICogQHJldHVybiB7Qm9vbGVhbn0gaWYgdGhlIHgveSBjb29yZHMgYXJlIHdpdGhpbiB0aGlzIHBvbHlnb24KICovClBJWEkuUG9seWdvbi5wcm90b3R5cGUuY29udGFpbnMgPSBmdW5jdGlvbih4LCB5KQp7CiAgICB2YXIgaW5zaWRlID0gZmFsc2U7CgogICAgLy8gdXNlIHNvbWUgcmF5Y2FzdGluZyB0byB0ZXN0IGhpdHMKICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9zdWJzdGFjay9wb2ludC1pbi1wb2x5Z29uL2Jsb2IvbWFzdGVyL2luZGV4LmpzCiAgICBmb3IodmFyIGkgPSAwLCBqID0gdGhpcy5wb2ludHMubGVuZ3RoIC0gMTsgaSA8IHRoaXMucG9pbnRzLmxlbmd0aDsgaiA9IGkrKykgewogICAgICAgIHZhciB4aSA9IHRoaXMucG9pbnRzW2ldLngsIHlpID0gdGhpcy5wb2ludHNbaV0ueSwKICAgICAgICAgICAgeGogPSB0aGlzLnBvaW50c1tqXS54LCB5aiA9IHRoaXMucG9pbnRzW2pdLnksCiAgICAgICAgICAgIGludGVyc2VjdCA9ICgoeWkgPiB5KSAhPT0gKHlqID4geSkpICYmICh4IDwgKHhqIC0geGkpICogKHkgLSB5aSkgLyAoeWogLSB5aSkgKyB4aSk7CgogICAgICAgIGlmKGludGVyc2VjdCkgaW5zaWRlID0gIWluc2lkZTsKICAgIH0KCiAgICByZXR1cm4gaW5zaWRlOwp9OwoKLy8gY29uc3RydWN0b3IKUElYSS5Qb2x5Z29uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuUG9seWdvbjsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogVGhlIGJhc2UgY2xhc3MgZm9yIGFsbCBvYmplY3RzIHRoYXQgYXJlIHJlbmRlcmVkIG9uIHRoZSBzY3JlZW4uCiAqCiAqIEBjbGFzcyBEaXNwbGF5T2JqZWN0CiAqIEBjb25zdHJ1Y3RvcgogKi8KUElYSS5EaXNwbGF5T2JqZWN0ID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLmxhc3QgPSB0aGlzOwogICAgdGhpcy5maXJzdCA9IHRoaXM7CiAgICAvKioKICAgICAqIFRoZSBjb29yZGluYXRlIG9mIHRoZSBvYmplY3QgcmVsYXRpdmUgdG8gdGhlIGxvY2FsIGNvb3JkaW5hdGVzIG9mIHRoZSBwYXJlbnQuCiAgICAgKgogICAgICogQHByb3BlcnR5IHBvc2l0aW9uCiAgICAgKiBAdHlwZSBQb2ludAogICAgICovCiAgICB0aGlzLnBvc2l0aW9uID0gbmV3IFBJWEkuUG9pbnQoKTsKCiAgICAvKioKICAgICAqIFRoZSBzY2FsZSBmYWN0b3Igb2YgdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAcHJvcGVydHkgc2NhbGUKICAgICAqIEB0eXBlIFBvaW50CiAgICAgKi8KICAgIHRoaXMuc2NhbGUgPSBuZXcgUElYSS5Qb2ludCgxLDEpOy8ve3g6MSwgeToxfTsKCiAgICAvKioKICAgICAqIFRoZSBwaXZvdCBwb2ludCBvZiB0aGUgZGlzcGxheU9iamVjdCB0aGF0IGl0IHJvdGF0ZXMgYXJvdW5kCiAgICAgKgogICAgICogQHByb3BlcnR5IHBpdm90CiAgICAgKiBAdHlwZSBQb2ludAogICAgICovCiAgICB0aGlzLnBpdm90ID0gbmV3IFBJWEkuUG9pbnQoMCwwKTsKCiAgICAvKioKICAgICAqIFRoZSByb3RhdGlvbiBvZiB0aGUgb2JqZWN0IGluIHJhZGlhbnMuCiAgICAgKgogICAgICogQHByb3BlcnR5IHJvdGF0aW9uCiAgICAgKiBAdHlwZSBOdW1iZXIKICAgICAqLwogICAgdGhpcy5yb3RhdGlvbiA9IDA7CgogICAgLyoqCiAgICAgKiBUaGUgb3BhY2l0eSBvZiB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBhbHBoYQogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKi8KICAgIHRoaXMuYWxwaGEgPSAxOwoKICAgIC8qKgogICAgICogVGhlIHZpc2liaWxpdHkgb2YgdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAcHJvcGVydHkgdmlzaWJsZQogICAgICogQHR5cGUgQm9vbGVhbgogICAgICovCiAgICB0aGlzLnZpc2libGUgPSB0cnVlOwoKICAgIC8qKgogICAgICogVGhpcyBpcyB0aGUgZGVmaW5lZCBhcmVhIHRoYXQgd2lsbCBwaWNrIHVwIG1vdXNlIC8gdG91Y2ggZXZlbnRzLiBJdCBpcyBudWxsIGJ5IGRlZmF1bHQuCiAgICAgKiBTZXR0aW5nIGl0IGlzIGEgbmVhdCB3YXkgb2Ygb3B0aW1pc2luZyB0aGUgaGl0VGVzdCBmdW5jdGlvbiB0aGF0IHRoZSBpbnRlcmFjdGlvbk1hbmFnZXIgd2lsbCB1c2UgKGFzIGl0IHdpbGwgbm90IG5lZWQgdG8gaGl0IHRlc3QgYWxsIHRoZSBjaGlsZHJlbikKICAgICAqCiAgICAgKiBAcHJvcGVydHkgaGl0QXJlYQogICAgICogQHR5cGUgUmVjdGFuZ2xlfENpcmNsZXxFbGxpcHNlfFBvbHlnb24KICAgICAqLwogICAgdGhpcy5oaXRBcmVhID0gbnVsbDsKCiAgICAvKioKICAgICAqIFRoaXMgaXMgdXNlZCB0byBpbmRpY2F0ZSBpZiB0aGUgZGlzcGxheU9iamVjdCBzaG91bGQgZGlzcGxheSBhIG1vdXNlIGhhbmQgY3Vyc29yIG9uIHJvbGxvdmVyCiAgICAgKgogICAgICogQHByb3BlcnR5IGJ1dHRvbk1vZGUKICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAqLwogICAgdGhpcy5idXR0b25Nb2RlID0gZmFsc2U7CgogICAgLyoqCiAgICAgKiBDYW4gdGhpcyBvYmplY3QgYmUgcmVuZGVyZWQKICAgICAqCiAgICAgKiBAcHJvcGVydHkgcmVuZGVyYWJsZQogICAgICogQHR5cGUgQm9vbGVhbgogICAgICovCiAgICB0aGlzLnJlbmRlcmFibGUgPSBmYWxzZTsKCiAgICAvKioKICAgICAqIFtyZWFkLW9ubHldIFRoZSBkaXNwbGF5IG9iamVjdCBjb250YWluZXIgdGhhdCBjb250YWlucyB0aGlzIGRpc3BsYXkgb2JqZWN0LgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBwYXJlbnQKICAgICAqIEB0eXBlIERpc3BsYXlPYmplY3RDb250YWluZXIKICAgICAqIEByZWFkT25seQogICAgICovCiAgICB0aGlzLnBhcmVudCA9IG51bGw7CgogICAgLyoqCiAgICAgKiBbcmVhZC1vbmx5XSBUaGUgc3RhZ2UgdGhlIGRpc3BsYXkgb2JqZWN0IGlzIGNvbm5lY3RlZCB0bywgb3IgdW5kZWZpbmVkIGlmIGl0IGlzIG5vdCBjb25uZWN0ZWQgdG8gdGhlIHN0YWdlLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBzdGFnZQogICAgICogQHR5cGUgU3RhZ2UKICAgICAqIEByZWFkT25seQogICAgICovCiAgICB0aGlzLnN0YWdlID0gbnVsbDsKCiAgICAvKioKICAgICAqIFtyZWFkLW9ubHldIFRoZSBtdWx0aXBsaWVkIGFscGhhIG9mIHRoZSBkaXNwbGF5b2JqZWN0CiAgICAgKgogICAgICogQHByb3BlcnR5IHdvcmxkQWxwaGEKICAgICAqIEB0eXBlIE51bWJlcgogICAgICogQHJlYWRPbmx5CiAgICAgKi8KICAgIHRoaXMud29ybGRBbHBoYSA9IDE7CgogICAgLyoqCiAgICAgKiBbcmVhZC1vbmx5XSBXaGV0aGVyIG9yIG5vdCB0aGUgb2JqZWN0IGlzIGludGVyYWN0aXZlLCBkbyBub3QgdG9nZ2xlIGRpcmVjdGx5ISB1c2UgdGhlIGBpbnRlcmFjdGl2ZWAgcHJvcGVydHkKICAgICAqCiAgICAgKiBAcHJvcGVydHkgX2ludGVyYWN0aXZlCiAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgKiBAcmVhZE9ubHkKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHRoaXMuX2ludGVyYWN0aXZlID0gZmFsc2U7CgogICAgdGhpcy5kZWZhdWx0Q3Vyc29yID0gJ3BvaW50ZXInOwoKICAgIC8qKgogICAgICogW3JlYWQtb25seV0gQ3VycmVudCB0cmFuc2Zvcm0gb2YgdGhlIG9iamVjdCBiYXNlZCBvbiB3b3JsZCAocGFyZW50KSBmYWN0b3JzCiAgICAgKgogICAgICogQHByb3BlcnR5IHdvcmxkVHJhbnNmb3JtCiAgICAgKiBAdHlwZSBNYXQzCiAgICAgKiBAcmVhZE9ubHkKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHRoaXMud29ybGRUcmFuc2Zvcm0gPSBQSVhJLm1hdDMuY3JlYXRlKCk7IC8vbWF0My5pZGVudGl0eSgpOwoKICAgIC8qKgogICAgICogW3JlYWQtb25seV0gQ3VycmVudCB0cmFuc2Zvcm0gb2YgdGhlIG9iamVjdCBsb2NhbGx5CiAgICAgKgogICAgICogQHByb3BlcnR5IGxvY2FsVHJhbnNmb3JtCiAgICAgKiBAdHlwZSBNYXQzCiAgICAgKiBAcmVhZE9ubHkKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHRoaXMubG9jYWxUcmFuc2Zvcm0gPSBQSVhJLm1hdDMuY3JlYXRlKCk7IC8vbWF0My5pZGVudGl0eSgpOwoKICAgIC8qKgogICAgICogW05ZSV0gVW5rb3duCiAgICAgKgogICAgICogQHByb3BlcnR5IGNvbG9yCiAgICAgKiBAdHlwZSBBcnJheTw+CiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICB0aGlzLmNvbG9yID0gW107CgogICAgLyoqCiAgICAgKiBbTllJXSBIb2xkcyB3aGV0aGVyIG9yIG5vdCB0aGlzIG9iamVjdCBpcyBkeW5hbWljLCBmb3IgcmVuZGVyaW5nIG9wdGltaXphdGlvbgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBkeW5hbWljCiAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICB0aGlzLmR5bmFtaWMgPSB0cnVlOwoKICAgIC8vIGNoYWNoIHRoYXQgcHVwcHkhCiAgICB0aGlzLl9zciA9IDA7CiAgICB0aGlzLl9jciA9IDE7CgoKICAgIHRoaXMuZmlsdGVyQXJlYSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLDAsMSwxKTsKCiAgICAvKgogICAgICogTU9VU0UgQ2FsbGJhY2tzCiAgICAgKi8KCiAgICAvKioKICAgICAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXJzIGNsaWNrcyBvbiB0aGUgZGlzcGxheU9iamVjdCB3aXRoIHRoZWlyIG1vdXNlCiAgICAgKiBAbWV0aG9kIGNsaWNrCiAgICAgKiBAcGFyYW0gaW50ZXJhY3Rpb25EYXRhIHtJbnRlcmFjdGlvbkRhdGF9CiAgICAgKi8KCiAgICAvKioKICAgICAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXIgY2xpY2tzIHRoZSBtb3VzZSBkb3duIG92ZXIgdGhlIHNwcml0ZQogICAgICogQG1ldGhvZCBtb3VzZWRvd24KICAgICAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KICAgICAqLwoKICAgIC8qKgogICAgICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlciByZWxlYXNlcyB0aGUgbW91c2UgdGhhdCB3YXMgb3ZlciB0aGUgZGlzcGxheU9iamVjdAogICAgICogZm9yIHRoaXMgY2FsbGJhY2sgdG8gYmUgZmlyZWQgdGhlIG1vdXNlIG11c3QgaGF2ZSBiZWVuIHByZXNzZWQgZG93biBvdmVyIHRoZSBkaXNwbGF5T2JqZWN0CiAgICAgKiBAbWV0aG9kIG1vdXNldXAKICAgICAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KICAgICAqLwoKICAgIC8qKgogICAgICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlciByZWxlYXNlcyB0aGUgbW91c2UgdGhhdCB3YXMgb3ZlciB0aGUgZGlzcGxheU9iamVjdCBidXQgaXMgbm8gbG9uZ2VyIG92ZXIgdGhlIGRpc3BsYXlPYmplY3QKICAgICAqIGZvciB0aGlzIGNhbGxiYWNrIHRvIGJlIGZpcmVkLCBUaGUgdG91Y2ggbXVzdCBoYXZlIHN0YXJ0ZWQgb3ZlciB0aGUgZGlzcGxheU9iamVjdAogICAgICogQG1ldGhvZCBtb3VzZXVwb3V0c2lkZQogICAgICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQogICAgICovCgogICAgLyoqCiAgICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VycyBtb3VzZSByb2xscyBvdmVyIHRoZSBkaXNwbGF5T2JqZWN0CiAgICAgKiBAbWV0aG9kIG1vdXNlb3ZlcgogICAgICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQogICAgICovCgogICAgLyoqCiAgICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VycyBtb3VzZSBsZWF2ZXMgdGhlIGRpc3BsYXlPYmplY3QKICAgICAqIEBtZXRob2QgbW91c2VvdXQKICAgICAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KICAgICAqLwoKCiAgICAvKgogICAgICogVE9VQ0ggQ2FsbGJhY2tzCiAgICAgKi8KCiAgICAvKioKICAgICAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXJzIHRhcHMgb24gdGhlIHNwcml0ZSB3aXRoIHRoZWlyIGZpbmdlcgogICAgICogYmFzaWNhbGx5IGEgdG91Y2ggdmVyc2lvbiBvZiBjbGljawogICAgICogQG1ldGhvZCB0YXAKICAgICAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KICAgICAqLwoKICAgIC8qKgogICAgICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlciB0b3VjaCdzIG92ZXIgdGhlIGRpc3BsYXlPYmplY3QKICAgICAqIEBtZXRob2QgdG91Y2hzdGFydAogICAgICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQogICAgICovCgogICAgLyoqCiAgICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VyIHJlbGVhc2VzIGEgdG91Y2ggb3ZlciB0aGUgZGlzcGxheU9iamVjdAogICAgICogQG1ldGhvZCB0b3VjaGVuZAogICAgICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQogICAgICovCgogICAgLyoqCiAgICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VyIHJlbGVhc2VzIHRoZSB0b3VjaCB0aGF0IHdhcyBvdmVyIHRoZSBkaXNwbGF5T2JqZWN0CiAgICAgKiBmb3IgdGhpcyBjYWxsYmFjayB0byBiZSBmaXJlZCwgVGhlIHRvdWNoIG11c3QgaGF2ZSBzdGFydGVkIG92ZXIgdGhlIHNwcml0ZQogICAgICogQG1ldGhvZCB0b3VjaGVuZG91dHNpZGUKICAgICAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KICAgICAqLwp9OwoKLy8gY29uc3RydWN0b3IKUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuRGlzcGxheU9iamVjdDsKCi8qKgogKiBbRGVwcmVjYXRlZF0gSW5kaWNhdGVzIGlmIHRoZSBzcHJpdGUgd2lsbCBoYXZlIHRvdWNoIGFuZCBtb3VzZSBpbnRlcmFjdGl2aXR5LiBJdCBpcyBmYWxzZSBieSBkZWZhdWx0CiAqIEluc3RlYWQgb2YgdXNpbmcgdGhpcyBmdW5jdGlvbiB5b3UgY2FuIG5vdyBzaW1wbHkgc2V0IHRoZSBpbnRlcmFjdGl2ZSBwcm9wZXJ0eSB0byB0cnVlIG9yIGZhbHNlCiAqCiAqIEBtZXRob2Qgc2V0SW50ZXJhY3RpdmUKICogQHBhcmFtIGludGVyYWN0aXZlIHtCb29sZWFufQogKiBAZGVwcmVjYXRlZCBTaW1wbHkgc2V0IHRoZSBgaW50ZXJhY3RpdmVgIHByb3BlcnR5IGRpcmVjdGx5CiAqLwpQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlLnNldEludGVyYWN0aXZlID0gZnVuY3Rpb24oaW50ZXJhY3RpdmUpCnsKICAgIHRoaXMuaW50ZXJhY3RpdmUgPSBpbnRlcmFjdGl2ZTsKfTsKCi8qKgogKiBJbmRpY2F0ZXMgaWYgdGhlIHNwcml0ZSB3aWxsIGhhdmUgdG91Y2ggYW5kIG1vdXNlIGludGVyYWN0aXZpdHkuIEl0IGlzIGZhbHNlIGJ5IGRlZmF1bHQKICoKICogQHByb3BlcnR5IGludGVyYWN0aXZlCiAqIEB0eXBlIEJvb2xlYW4KICogQGRlZmF1bHQgZmFsc2UKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlLCAnaW50ZXJhY3RpdmUnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLl9pbnRlcmFjdGl2ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5faW50ZXJhY3RpdmUgPSB2YWx1ZTsKCiAgICAgICAgLy8gVE9ETyBtb3JlIHRvIGJlIGRvbmUgaGVyZS4uCiAgICAgICAgLy8gbmVlZCB0byBzb3J0IG91dCBhIHJlLWNyYXdsIQogICAgICAgIGlmKHRoaXMuc3RhZ2UpdGhpcy5zdGFnZS5kaXJ0eSA9IHRydWU7CiAgICB9Cn0pOwoKLyoqCiAqIFNldHMgYSBtYXNrIGZvciB0aGUgZGlzcGxheU9iamVjdC4gQSBtYXNrIGlzIGFuIG9iamVjdCB0aGF0IGxpbWl0cyB0aGUgdmlzaWJpbGl0eSBvZiBhbiBvYmplY3QgdG8gdGhlIHNoYXBlIG9mIHRoZSBtYXNrIGFwcGxpZWQgdG8gaXQuCiAqIEluIFBJWEkgYSByZWd1bGFyIG1hc2sgbXVzdCBiZSBhIFBJWEkuR2dyYXBoaWNzIG9iamVjdC4gVGhpcyBhbGxvd3MgZm9yIG11Y2ggZmFzdGVyIG1hc2tpbmcgaW4gY2FudmFzIGFzIGl0IHV0aWxpc2VzIHNoYXBlIGNsaXBwaW5nLgogKiBUbyByZW1vdmUgYSBtYXNrLCBzZXQgdGhpcyBwcm9wZXJ0eSB0byBudWxsLgogKgogKiBAcHJvcGVydHkgbWFzawogKiBAdHlwZSBHcmFwaGljcwogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUsICdtYXNrJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbWFzazsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CgoKICAgICAgICBpZih2YWx1ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmKHRoaXMuX21hc2spCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhbHVlLnN0YXJ0ID0gdGhpcy5fbWFzay5zdGFydDsKICAgICAgICAgICAgICAgIHZhbHVlLmVuZCA9IHRoaXMuX21hc2suZW5kOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5hZGRGaWx0ZXIodmFsdWUpOwogICAgICAgICAgICAgICAgdmFsdWUucmVuZGVyYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlRmlsdGVyKHRoaXMuX21hc2spOwogICAgICAgICAgICB0aGlzLl9tYXNrLnJlbmRlcmFibGUgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fbWFzayA9IHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiBTZXRzIHRoZSBmaWx0ZXJzIGZvciB0aGUgZGlzcGxheU9iamVjdC4KICogKiBJTVBPUlRBTlQ6IFRoaXMgaXMgYSB3ZWJHTCBvbmx5IGZlYXR1cmUgYW5kIHdpbGwgYmUgaWdub3JlZCBieSB0aGUgY2FudmFzIHJlbmRlcmVyLgogKiBUbyByZW1vdmUgZmlsdGVycyBzaW1wbHkgc2V0IHRoaXMgcHJvcGVydHkgdG8gJ251bGwnCiAqIEBwcm9wZXJ0eSBmaWx0ZXJzCiAqIEB0eXBlIEFycmF5IEFuIGFycmF5IG9mIGZpbHRlcnMKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlLCAnZmlsdGVycycsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbHRlcnM7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoKICAgICAgICBpZih2YWx1ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmKHRoaXMuX2ZpbHRlcnMpdGhpcy5yZW1vdmVGaWx0ZXIodGhpcy5fZmlsdGVycyk7CiAgICAgICAgICAgIHRoaXMuYWRkRmlsdGVyKHZhbHVlKTsKCiAgICAgICAgICAgIC8vIG5vdyBwdXQgYWxsIHRoZSBwYXNzZXMgaW4gb25lIHBsYWNlLi4KICAgICAgICAgICAgdmFyIHBhc3NlcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZmlsdGVyUGFzc2VzID0gdmFsdWVbaV0ucGFzc2VzOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBmaWx0ZXJQYXNzZXMubGVuZ3RoOyBqKyspCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcGFzc2VzLnB1c2goZmlsdGVyUGFzc2VzW2pdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFsdWUuc3RhcnQuZmlsdGVyUGFzc2VzID0gcGFzc2VzOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZih0aGlzLl9maWx0ZXJzKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUZpbHRlcih0aGlzLl9maWx0ZXJzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5fZmlsdGVycyA9IHZhbHVlOwogICAgfQp9KTsKCi8qCiAqIEFkZHMgYSBmaWx0ZXIgdG8gdGhpcyBkaXNwbGF5T2JqZWN0CiAqCiAqIEBtZXRob2QgYWRkRmlsdGVyCiAqIEBwYXJhbSBtYXNrIHtHcmFwaGljc30gdGhlIGdyYXBoaWNzIG9iamVjdCB0byB1c2UgYXMgYSBmaWx0ZXIKICogQHByaXZhdGUKICovClBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUuYWRkRmlsdGVyID0gZnVuY3Rpb24oZGF0YSkKewogICAgLy9pZih0aGlzLmZpbHRlcilyZXR1cm47CiAgICAvL3RoaXMuZmlsdGVyID0gdHJ1ZTsKLy8gIGRhdGFbMF0udGFyZ2V0ID0gdGhpczsKCgogICAgLy8gaW5zZXJ0IGEgZmlsdGVyIGJsb2NrLi4KICAgIC8vIFRPRE8gT25qZWN0IHBvb2wgdGhlYXNlIGJhZCBib3lzLi4KICAgIHZhciBzdGFydCA9IG5ldyBQSVhJLkZpbHRlckJsb2NrKCk7CiAgICB2YXIgZW5kID0gbmV3IFBJWEkuRmlsdGVyQmxvY2soKTsKCiAgICBkYXRhLnN0YXJ0ID0gc3RhcnQ7CiAgICBkYXRhLmVuZCA9IGVuZDsKCiAgICBzdGFydC5kYXRhID0gZGF0YTsKICAgIGVuZC5kYXRhID0gZGF0YTsKCiAgICBzdGFydC5maXJzdCA9IHN0YXJ0Lmxhc3QgPSAgdGhpczsKICAgIGVuZC5maXJzdCA9IGVuZC5sYXN0ID0gdGhpczsKCiAgICBzdGFydC5vcGVuID0gdHJ1ZTsKCiAgICBzdGFydC50YXJnZXQgPSB0aGlzOwoKICAgIC8qCiAgICAgKiBpbnNlcnQgc3RhcnQKICAgICAqLwoKICAgIHZhciBjaGlsZEZpcnN0ID0gc3RhcnQ7CiAgICB2YXIgY2hpbGRMYXN0ID0gc3RhcnQ7CiAgICB2YXIgbmV4dE9iamVjdDsKICAgIHZhciBwcmV2aW91c09iamVjdDsKCiAgICBwcmV2aW91c09iamVjdCA9IHRoaXMuZmlyc3QuX2lQcmV2OwoKICAgIGlmKHByZXZpb3VzT2JqZWN0KQogICAgewogICAgICAgIG5leHRPYmplY3QgPSBwcmV2aW91c09iamVjdC5faU5leHQ7CiAgICAgICAgY2hpbGRGaXJzdC5faVByZXYgPSBwcmV2aW91c09iamVjdDsKICAgICAgICBwcmV2aW91c09iamVjdC5faU5leHQgPSBjaGlsZEZpcnN0OwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG5leHRPYmplY3QgPSB0aGlzOwogICAgfQoKICAgIGlmKG5leHRPYmplY3QpCiAgICB7CiAgICAgICAgbmV4dE9iamVjdC5faVByZXYgPSBjaGlsZExhc3Q7CiAgICAgICAgY2hpbGRMYXN0Ll9pTmV4dCA9IG5leHRPYmplY3Q7CiAgICB9CgogICAgLy8gbm93IGluc2VydCB0aGUgZW5kIGZpbHRlciBibG9jay4uCgogICAgLyoKICAgICAqIGluc2VydCBlbmQgZmlsdGVyCiAgICAgKi8KICAgIGNoaWxkRmlyc3QgPSBlbmQ7CiAgICBjaGlsZExhc3QgPSBlbmQ7CiAgICBuZXh0T2JqZWN0ID0gbnVsbDsKICAgIHByZXZpb3VzT2JqZWN0ID0gbnVsbDsKCiAgICBwcmV2aW91c09iamVjdCA9IHRoaXMubGFzdDsKICAgIG5leHRPYmplY3QgPSBwcmV2aW91c09iamVjdC5faU5leHQ7CgogICAgaWYobmV4dE9iamVjdCkKICAgIHsKICAgICAgICBuZXh0T2JqZWN0Ll9pUHJldiA9IGNoaWxkTGFzdDsKICAgICAgICBjaGlsZExhc3QuX2lOZXh0ID0gbmV4dE9iamVjdDsKICAgIH0KCiAgICBjaGlsZEZpcnN0Ll9pUHJldiA9IHByZXZpb3VzT2JqZWN0OwogICAgcHJldmlvdXNPYmplY3QuX2lOZXh0ID0gY2hpbGRGaXJzdDsKCiAgICB2YXIgdXBkYXRlTGFzdCA9IHRoaXM7CgogICAgdmFyIHByZXZMYXN0ID0gdGhpcy5sYXN0OwogICAgd2hpbGUodXBkYXRlTGFzdCkKICAgIHsKICAgICAgICBpZih1cGRhdGVMYXN0Lmxhc3QgPT09IHByZXZMYXN0KQogICAgICAgIHsKICAgICAgICAgICAgdXBkYXRlTGFzdC5sYXN0ID0gZW5kOwogICAgICAgIH0KICAgICAgICB1cGRhdGVMYXN0ID0gdXBkYXRlTGFzdC5wYXJlbnQ7CiAgICB9CgogICAgdGhpcy5maXJzdCA9IHN0YXJ0OwoKICAgIC8vIGlmIHdlYkdMLi4uCiAgICBpZih0aGlzLl9fcmVuZGVyR3JvdXApCiAgICB7CiAgICAgICAgdGhpcy5fX3JlbmRlckdyb3VwLmFkZEZpbHRlckJsb2NrcyhzdGFydCwgZW5kKTsKICAgIH0KfTsKCi8qCiAqIFJlbW92ZXMgdGhlIGZpbHRlciB0byB0aGlzIGRpc3BsYXlPYmplY3QKICoKICogQG1ldGhvZCByZW1vdmVGaWx0ZXIKICogQHByaXZhdGUKICovClBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUucmVtb3ZlRmlsdGVyID0gZnVuY3Rpb24oZGF0YSkKewogICAgLy9pZighdGhpcy5maWx0ZXIpcmV0dXJuOwogICAgLy90aGlzLmZpbHRlciA9IGZhbHNlOwogICAgLy8gY29uc29sZS5sb2coJ1lVT0lPJykKICAgIC8vIG1vZGlmeSB0aGUgbGlzdC4uCiAgICB2YXIgc3RhcnRCbG9jayA9IGRhdGEuc3RhcnQ7CgoKICAgIHZhciBuZXh0T2JqZWN0ID0gc3RhcnRCbG9jay5faU5leHQ7CiAgICB2YXIgcHJldmlvdXNPYmplY3QgPSBzdGFydEJsb2NrLl9pUHJldjsKCiAgICBpZihuZXh0T2JqZWN0KW5leHRPYmplY3QuX2lQcmV2ID0gcHJldmlvdXNPYmplY3Q7CiAgICBpZihwcmV2aW91c09iamVjdClwcmV2aW91c09iamVjdC5faU5leHQgPSBuZXh0T2JqZWN0OwoKICAgIHRoaXMuZmlyc3QgPSBzdGFydEJsb2NrLl9pTmV4dDsKCiAgICAvLyByZW1vdmUgdGhlIGVuZCBmaWx0ZXIKICAgIHZhciBsYXN0QmxvY2sgPSBkYXRhLmVuZDsKCiAgICBuZXh0T2JqZWN0ID0gbGFzdEJsb2NrLl9pTmV4dDsKICAgIHByZXZpb3VzT2JqZWN0ID0gbGFzdEJsb2NrLl9pUHJldjsKCiAgICBpZihuZXh0T2JqZWN0KW5leHRPYmplY3QuX2lQcmV2ID0gcHJldmlvdXNPYmplY3Q7CiAgICBwcmV2aW91c09iamVjdC5faU5leHQgPSBuZXh0T2JqZWN0OwoKICAgIC8vIHRoaXMgaXMgYWx3YXlzIHRydWUgdG9vIQogICAgdmFyIHRlbXBMYXN0ID0gIGxhc3RCbG9jay5faVByZXY7CiAgICAvLyBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFyZW50cyBsYXN0IGlzIHVwZGF0ZWQgdG9vCiAgICB2YXIgdXBkYXRlTGFzdCA9IHRoaXM7CiAgICB3aGlsZSh1cGRhdGVMYXN0Lmxhc3QgPT09IGxhc3RCbG9jaykKICAgIHsKICAgICAgICB1cGRhdGVMYXN0Lmxhc3QgPSB0ZW1wTGFzdDsKICAgICAgICB1cGRhdGVMYXN0ID0gdXBkYXRlTGFzdC5wYXJlbnQ7CiAgICAgICAgaWYoIXVwZGF0ZUxhc3QpYnJlYWs7CiAgICB9CgogICAgLy8gaWYgd2ViR0wuLi4KICAgIGlmKHRoaXMuX19yZW5kZXJHcm91cCkKICAgIHsKICAgICAgICB0aGlzLl9fcmVuZGVyR3JvdXAucmVtb3ZlRmlsdGVyQmxvY2tzKHN0YXJ0QmxvY2ssIGxhc3RCbG9jayk7CiAgICB9Cn07CgovKgogKiBVcGRhdGVzIHRoZSBvYmplY3QgdHJhbnNmb3JtIGZvciByZW5kZXJpbmcKICoKICogQG1ldGhvZCB1cGRhdGVUcmFuc2Zvcm0KICogQHByaXZhdGUKICovClBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtID0gZnVuY3Rpb24oKQp7CiAgICAvLyBUT0RPIE9QVElNSVpFIFRISVMhISB3aXRoIGRpcnR5CiAgICBpZih0aGlzLnJvdGF0aW9uICE9PSB0aGlzLnJvdGF0aW9uQ2FjaGUpCiAgICB7CiAgICAgICAgdGhpcy5yb3RhdGlvbkNhY2hlID0gdGhpcy5yb3RhdGlvbjsKICAgICAgICB0aGlzLl9zciA9ICBNYXRoLnNpbih0aGlzLnJvdGF0aW9uKTsKICAgICAgICB0aGlzLl9jciA9ICBNYXRoLmNvcyh0aGlzLnJvdGF0aW9uKTsKICAgIH0KCiAgICB2YXIgbG9jYWxUcmFuc2Zvcm0gPSB0aGlzLmxvY2FsVHJhbnNmb3JtOwogICAgdmFyIHBhcmVudFRyYW5zZm9ybSA9IHRoaXMucGFyZW50LndvcmxkVHJhbnNmb3JtOwogICAgdmFyIHdvcmxkVHJhbnNmb3JtID0gdGhpcy53b3JsZFRyYW5zZm9ybTsKICAgIC8vY29uc29sZS5sb2cobG9jYWxUcmFuc2Zvcm0pCiAgICBsb2NhbFRyYW5zZm9ybVswXSA9IHRoaXMuX2NyICogdGhpcy5zY2FsZS54OwogICAgbG9jYWxUcmFuc2Zvcm1bMV0gPSAtdGhpcy5fc3IgKiB0aGlzLnNjYWxlLnk7CiAgICBsb2NhbFRyYW5zZm9ybVszXSA9IHRoaXMuX3NyICogdGhpcy5zY2FsZS54OwogICAgbG9jYWxUcmFuc2Zvcm1bNF0gPSB0aGlzLl9jciAqIHRoaXMuc2NhbGUueTsKCiAgICAvLyBUT0RPIC0tPiBkbyB3ZSBldmVuIG5lZWQgYSBsb2NhbCBtYXRyaXg/Pz8KCiAgICB2YXIgcHggPSB0aGlzLnBpdm90Lng7CiAgICB2YXIgcHkgPSB0aGlzLnBpdm90Lnk7CgogICAgLy8gQ2FjaGUgdGhlIG1hdHJpeCB2YWx1ZXMgKG1ha2VzIGZvciBodWdlIHNwZWVkIGluY3JlYXNlcyEpCiAgICB2YXIgYTAwID0gbG9jYWxUcmFuc2Zvcm1bMF0sIGEwMSA9IGxvY2FsVHJhbnNmb3JtWzFdLCBhMDIgPSB0aGlzLnBvc2l0aW9uLnggLSBsb2NhbFRyYW5zZm9ybVswXSAqIHB4IC0gcHkgKiBsb2NhbFRyYW5zZm9ybVsxXSwKICAgICAgICBhMTAgPSBsb2NhbFRyYW5zZm9ybVszXSwgYTExID0gbG9jYWxUcmFuc2Zvcm1bNF0sIGExMiA9IHRoaXMucG9zaXRpb24ueSAtIGxvY2FsVHJhbnNmb3JtWzRdICogcHkgLSBweCAqIGxvY2FsVHJhbnNmb3JtWzNdLAoKICAgICAgICBiMDAgPSBwYXJlbnRUcmFuc2Zvcm1bMF0sIGIwMSA9IHBhcmVudFRyYW5zZm9ybVsxXSwgYjAyID0gcGFyZW50VHJhbnNmb3JtWzJdLAogICAgICAgIGIxMCA9IHBhcmVudFRyYW5zZm9ybVszXSwgYjExID0gcGFyZW50VHJhbnNmb3JtWzRdLCBiMTIgPSBwYXJlbnRUcmFuc2Zvcm1bNV07CgogICAgbG9jYWxUcmFuc2Zvcm1bMl0gPSBhMDI7CiAgICBsb2NhbFRyYW5zZm9ybVs1XSA9IGExMjsKCiAgICB3b3JsZFRyYW5zZm9ybVswXSA9IGIwMCAqIGEwMCArIGIwMSAqIGExMDsKICAgIHdvcmxkVHJhbnNmb3JtWzFdID0gYjAwICogYTAxICsgYjAxICogYTExOwogICAgd29ybGRUcmFuc2Zvcm1bMl0gPSBiMDAgKiBhMDIgKyBiMDEgKiBhMTIgKyBiMDI7CgogICAgd29ybGRUcmFuc2Zvcm1bM10gPSBiMTAgKiBhMDAgKyBiMTEgKiBhMTA7CiAgICB3b3JsZFRyYW5zZm9ybVs0XSA9IGIxMCAqIGEwMSArIGIxMSAqIGExMTsKICAgIHdvcmxkVHJhbnNmb3JtWzVdID0gYjEwICogYTAyICsgYjExICogYTEyICsgYjEyOwoKICAgIC8vIGJlY2F1c2Ugd2UgYXJlIHVzaW5nIGFmZmluZSB0cmFuc2Zvcm1hdGlvbiwgd2UgY2FuIG9wdGltaXNlIHRoZSBtYXRyaXggY29uY2F0ZW5hdGlvbiBwcm9jZXNzLi4gd29vbyEKICAgIC8vIG1hdDMubXVsdGlwbHkodGhpcy5sb2NhbFRyYW5zZm9ybSwgdGhpcy5wYXJlbnQud29ybGRUcmFuc2Zvcm0sIHRoaXMud29ybGRUcmFuc2Zvcm0pOwogICAgdGhpcy53b3JsZEFscGhhID0gdGhpcy5hbHBoYSAqIHRoaXMucGFyZW50LndvcmxkQWxwaGE7CgogICAgdGhpcy52Y291bnQgPSBQSVhJLnZpc2libGVDb3VudDsKfTsKClBJWEkudmlzaWJsZUNvdW50ID0gMDsKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgovKioKICogQSBEaXNwbGF5T2JqZWN0Q29udGFpbmVyIHJlcHJlc2VudHMgYSBjb2xsZWN0aW9uIG9mIGRpc3BsYXkgb2JqZWN0cy4KICogSXQgaXMgdGhlIGJhc2UgY2xhc3Mgb2YgYWxsIGRpc3BsYXkgb2JqZWN0cyB0aGF0IGFjdCBhcyBhIGNvbnRhaW5lciBmb3Igb3RoZXIgb2JqZWN0cy4KICoKICogQGNsYXNzIERpc3BsYXlPYmplY3RDb250YWluZXIKICogQGV4dGVuZHMgRGlzcGxheU9iamVjdAogKiBAY29uc3RydWN0b3IKICovClBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lciA9IGZ1bmN0aW9uKCkKewogICAgUElYSS5EaXNwbGF5T2JqZWN0LmNhbGwoIHRoaXMgKTsKCiAgICAvKioKICAgICAqIFtyZWFkLW9ubHldIFRoZSBvZiBjaGlsZHJlbiBvZiB0aGlzIGNvbnRhaW5lci4KICAgICAqCiAgICAgKiBAcHJvcGVydHkgY2hpbGRyZW4KICAgICAqIEB0eXBlIEFycmF5PERpc3BsYXlPYmplY3Q+CiAgICAgKiBAcmVhZE9ubHkKICAgICAqLwogICAgdGhpcy5jaGlsZHJlbiA9IFtdOwp9OwoKLy8gY29uc3RydWN0b3IKUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUgKTsKUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lcjsKCi8qKgogKiBBZGRzIGEgY2hpbGQgdG8gdGhlIGNvbnRhaW5lci4KICoKICogQG1ldGhvZCBhZGRDaGlsZAogKiBAcGFyYW0gY2hpbGQge0Rpc3BsYXlPYmplY3R9IFRoZSBEaXNwbGF5T2JqZWN0IHRvIGFkZCB0byB0aGUgY29udGFpbmVyCiAqLwpQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLmFkZENoaWxkID0gZnVuY3Rpb24oY2hpbGQpCnsKICAgIGlmKGNoaWxkLnBhcmVudCAmJiBjaGlsZC5wYXJlbnQgIT09IHRoaXMpCiAgICB7CiAgICAgICAgLy8vLyBDT1VMRCBCRSBUSElTPz8/CiAgICAgICAgY2hpbGQucGFyZW50LnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgIC8vICByZXR1cm47CiAgICB9CgogICAgY2hpbGQucGFyZW50ID0gdGhpczsKCiAgICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQpOwoKICAgIC8vIHVwZGF0ZSB0aGUgc3RhZ2UgcmVmZmVyZW5jZS4uCgogICAgaWYodGhpcy5zdGFnZSkKICAgIHsKICAgICAgICB2YXIgdG1wQ2hpbGQgPSBjaGlsZDsKICAgICAgICBkbwogICAgICAgIHsKICAgICAgICAgICAgaWYodG1wQ2hpbGQuaW50ZXJhY3RpdmUpdGhpcy5zdGFnZS5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIHRtcENoaWxkLnN0YWdlID0gdGhpcy5zdGFnZTsKICAgICAgICAgICAgdG1wQ2hpbGQgPSB0bXBDaGlsZC5faU5leHQ7CiAgICAgICAgfQogICAgICAgIHdoaWxlKHRtcENoaWxkKTsKICAgIH0KCiAgICAvLyBMSU5LRUQgTElTVCAvLwoKICAgIC8vIG1vZGlmeSB0aGUgbGlzdC4uCiAgICB2YXIgY2hpbGRGaXJzdCA9IGNoaWxkLmZpcnN0OwogICAgdmFyIGNoaWxkTGFzdCA9IGNoaWxkLmxhc3Q7CiAgICB2YXIgbmV4dE9iamVjdDsKICAgIHZhciBwcmV2aW91c09iamVjdDsKCiAgICAvLyB0aGlzIGNvdWxkIGJlIHdyb25nIGlmIHRoZXJlIGlzIGEgZmlsdGVyPz8KICAgIGlmKHRoaXMuX2ZpbHRlcnMgfHwgdGhpcy5fbWFzaykKICAgIHsKICAgICAgICBwcmV2aW91c09iamVjdCA9ICB0aGlzLmxhc3QuX2lQcmV2OwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHByZXZpb3VzT2JqZWN0ID0gdGhpcy5sYXN0OwogICAgfQoKICAgIG5leHRPYmplY3QgPSBwcmV2aW91c09iamVjdC5faU5leHQ7CgogICAgLy8gYWx3YXlzIHRydWUgaW4gdGhpcyBjYXNlCiAgICAvLyBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFyZW50cyBsYXN0IGlzIHVwZGF0ZWQgdG9vCiAgICB2YXIgdXBkYXRlTGFzdCA9IHRoaXM7CiAgICB2YXIgcHJldkxhc3QgPSBwcmV2aW91c09iamVjdDsKCiAgICB3aGlsZSh1cGRhdGVMYXN0KQogICAgewogICAgICAgIGlmKHVwZGF0ZUxhc3QubGFzdCA9PT0gcHJldkxhc3QpCiAgICAgICAgewogICAgICAgICAgICB1cGRhdGVMYXN0Lmxhc3QgPSBjaGlsZC5sYXN0OwogICAgICAgIH0KICAgICAgICB1cGRhdGVMYXN0ID0gdXBkYXRlTGFzdC5wYXJlbnQ7CiAgICB9CgogICAgaWYobmV4dE9iamVjdCkKICAgIHsKICAgICAgICBuZXh0T2JqZWN0Ll9pUHJldiA9IGNoaWxkTGFzdDsKICAgICAgICBjaGlsZExhc3QuX2lOZXh0ID0gbmV4dE9iamVjdDsKICAgIH0KCiAgICBjaGlsZEZpcnN0Ll9pUHJldiA9IHByZXZpb3VzT2JqZWN0OwogICAgcHJldmlvdXNPYmplY3QuX2lOZXh0ID0gY2hpbGRGaXJzdDsKCiAgICAvLyBuZWVkIHRvIHJlbW92ZSBhbnkgcmVuZGVyIGdyb3Vwcy4uCiAgICBpZih0aGlzLl9fcmVuZGVyR3JvdXApCiAgICB7CiAgICAgICAgLy8gYmVpbmcgdXNlZCBieSBhIHJlbmRlclRleHR1cmUuLiBpZiBpdCBleGlzdHMgdGhlbiBpdCBtdXN0IGJlIGZyb20gYSByZW5kZXIgdGV4dHVyZTsKICAgICAgICBpZihjaGlsZC5fX3JlbmRlckdyb3VwKWNoaWxkLl9fcmVuZGVyR3JvdXAucmVtb3ZlRGlzcGxheU9iamVjdEFuZENoaWxkcmVuKGNoaWxkKTsKICAgICAgICAvLyBhZGQgdGhlbSB0byB0aGUgbmV3IHJlbmRlciBncm91cC4uCiAgICAgICAgdGhpcy5fX3JlbmRlckdyb3VwLmFkZERpc3BsYXlPYmplY3RBbmRDaGlsZHJlbihjaGlsZCk7CiAgICB9Cn07CgovKioKICogQWRkcyBhIGNoaWxkIHRvIHRoZSBjb250YWluZXIgYXQgYSBzcGVjaWZpZWQgaW5kZXguIElmIHRoZSBpbmRleCBpcyBvdXQgb2YgYm91bmRzIGFuIGVycm9yIHdpbGwgYmUgdGhyb3duCiAqCiAqIEBtZXRob2QgYWRkQ2hpbGRBdAogKiBAcGFyYW0gY2hpbGQge0Rpc3BsYXlPYmplY3R9IFRoZSBjaGlsZCB0byBhZGQKICogQHBhcmFtIGluZGV4IHtOdW1iZXJ9IFRoZSBpbmRleCB0byBwbGFjZSB0aGUgY2hpbGQgaW4KICovClBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUuYWRkQ2hpbGRBdCA9IGZ1bmN0aW9uKGNoaWxkLCBpbmRleCkKewogICAgaWYoaW5kZXggPj0gMCAmJiBpbmRleCA8PSB0aGlzLmNoaWxkcmVuLmxlbmd0aCkKICAgIHsKICAgICAgICBpZihjaGlsZC5wYXJlbnQgIT09IHVuZGVmaW5lZCkKICAgICAgICB7CiAgICAgICAgICAgIGNoaWxkLnBhcmVudC5yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgICAgfQoKICAgICAgICBjaGlsZC5wYXJlbnQgPSB0aGlzOwoKICAgICAgICBpZih0aGlzLnN0YWdlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRtcENoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgIGRvCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmKHRtcENoaWxkLmludGVyYWN0aXZlKXRoaXMuc3RhZ2UuZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgdG1wQ2hpbGQuc3RhZ2UgPSB0aGlzLnN0YWdlOwogICAgICAgICAgICAgICAgdG1wQ2hpbGQgPSB0bXBDaGlsZC5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUodG1wQ2hpbGQpOwogICAgICAgIH0KCiAgICAgICAgLy8gbW9kaWZ5IHRoZSBsaXN0Li4KICAgICAgICB2YXIgY2hpbGRGaXJzdCA9IGNoaWxkLmZpcnN0OwogICAgICAgIHZhciBjaGlsZExhc3QgPSBjaGlsZC5sYXN0OwogICAgICAgIHZhciBuZXh0T2JqZWN0OwogICAgICAgIHZhciBwcmV2aW91c09iamVjdDsKCiAgICAgICAgaWYoaW5kZXggPT09IHRoaXMuY2hpbGRyZW4ubGVuZ3RoKQogICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNPYmplY3QgPSAgdGhpcy5sYXN0OwogICAgICAgICAgICB2YXIgdXBkYXRlTGFzdCA9IHRoaXM7CiAgICAgICAgICAgIHZhciBwcmV2TGFzdCA9IHRoaXMubGFzdDsKICAgICAgICAgICAgd2hpbGUodXBkYXRlTGFzdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYodXBkYXRlTGFzdC5sYXN0ID09PSBwcmV2TGFzdCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB1cGRhdGVMYXN0Lmxhc3QgPSBjaGlsZC5sYXN0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdXBkYXRlTGFzdCA9IHVwZGF0ZUxhc3QucGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoaW5kZXggPT09IDApCiAgICAgICAgewogICAgICAgICAgICBwcmV2aW91c09iamVjdCA9IHRoaXM7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzT2JqZWN0ID0gdGhpcy5jaGlsZHJlbltpbmRleC0xXS5sYXN0OwogICAgICAgIH0KCiAgICAgICAgbmV4dE9iamVjdCA9IHByZXZpb3VzT2JqZWN0Ll9pTmV4dDsKCiAgICAgICAgLy8gYWx3YXlzIHRydWUgaW4gdGhpcyBjYXNlCiAgICAgICAgaWYobmV4dE9iamVjdCkKICAgICAgICB7CiAgICAgICAgICAgIG5leHRPYmplY3QuX2lQcmV2ID0gY2hpbGRMYXN0OwogICAgICAgICAgICBjaGlsZExhc3QuX2lOZXh0ID0gbmV4dE9iamVjdDsKICAgICAgICB9CgogICAgICAgIGNoaWxkRmlyc3QuX2lQcmV2ID0gcHJldmlvdXNPYmplY3Q7CiAgICAgICAgcHJldmlvdXNPYmplY3QuX2lOZXh0ID0gY2hpbGRGaXJzdDsKCiAgICAgICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDAsIGNoaWxkKTsKICAgICAgICAvLyBuZWVkIHRvIHJlbW92ZSBhbnkgcmVuZGVyIGdyb3Vwcy4uCiAgICAgICAgaWYodGhpcy5fX3JlbmRlckdyb3VwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gYmVpbmcgdXNlZCBieSBhIHJlbmRlclRleHR1cmUuLiBpZiBpdCBleGlzdHMgdGhlbiBpdCBtdXN0IGJlIGZyb20gYSByZW5kZXIgdGV4dHVyZTsKICAgICAgICAgICAgaWYoY2hpbGQuX19yZW5kZXJHcm91cCljaGlsZC5fX3JlbmRlckdyb3VwLnJlbW92ZURpc3BsYXlPYmplY3RBbmRDaGlsZHJlbihjaGlsZCk7CiAgICAgICAgICAgIC8vIGFkZCB0aGVtIHRvIHRoZSBuZXcgcmVuZGVyIGdyb3VwLi4KICAgICAgICAgICAgdGhpcy5fX3JlbmRlckdyb3VwLmFkZERpc3BsYXlPYmplY3RBbmRDaGlsZHJlbihjaGlsZCk7CiAgICAgICAgfQoKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoY2hpbGQgKyAnIFRoZSBpbmRleCAnKyBpbmRleCArJyBzdXBwbGllZCBpcyBvdXQgb2YgYm91bmRzICcgKyB0aGlzLmNoaWxkcmVuLmxlbmd0aCk7CiAgICB9Cn07CgovKioKICogW05ZSV0gU3dhcHMgdGhlIGRlcHRoIG9mIDIgZGlzcGxheU9iamVjdHMKICoKICogQG1ldGhvZCBzd2FwQ2hpbGRyZW4KICogQHBhcmFtIGNoaWxkIHtEaXNwbGF5T2JqZWN0fQogKiBAcGFyYW0gY2hpbGQyIHtEaXNwbGF5T2JqZWN0fQogKiBAcHJpdmF0ZQogKi8KUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZS5zd2FwQ2hpbGRyZW4gPSBmdW5jdGlvbihjaGlsZCwgY2hpbGQyKQp7CiAgICBpZihjaGlsZCA9PT0gY2hpbGQyKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBpbmRleDEgPSB0aGlzLmNoaWxkcmVuLmluZGV4T2YoY2hpbGQpOwogICAgdmFyIGluZGV4MiA9IHRoaXMuY2hpbGRyZW4uaW5kZXhPZihjaGlsZDIpOwoKICAgIGlmKGluZGV4MSA8IDAgfHwgaW5kZXgyIDwgMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignc3dhcENoaWxkcmVuOiBCb3RoIHRoZSBzdXBwbGllZCBEaXNwbGF5T2JqZWN0cyBtdXN0IGJlIGEgY2hpbGQgb2YgdGhlIGNhbGxlci4nKTsKICAgIH0KCiAgICB0aGlzLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgIHRoaXMucmVtb3ZlQ2hpbGQoY2hpbGQyKTsKCiAgICBpZihpbmRleDEgPCBpbmRleDIpCiAgICB7CiAgICAgICAgdGhpcy5hZGRDaGlsZEF0KGNoaWxkMiwgaW5kZXgxKTsKICAgICAgICB0aGlzLmFkZENoaWxkQXQoY2hpbGQsIGluZGV4Mik7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5hZGRDaGlsZEF0KGNoaWxkLCBpbmRleDIpOwogICAgICAgIHRoaXMuYWRkQ2hpbGRBdChjaGlsZDIsIGluZGV4MSk7CiAgICB9Cn07CgovKioKICogUmV0dXJucyB0aGUgQ2hpbGQgYXQgdGhlIHNwZWNpZmllZCBpbmRleAogKgogKiBAbWV0aG9kIGdldENoaWxkQXQKICogQHBhcmFtIGluZGV4IHtOdW1iZXJ9IFRoZSBpbmRleCB0byBnZXQgdGhlIGNoaWxkIGZyb20KICovClBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUuZ2V0Q2hpbGRBdCA9IGZ1bmN0aW9uKGluZGV4KQp7CiAgICBpZihpbmRleCA+PSAwICYmIGluZGV4IDwgdGhpcy5jaGlsZHJlbi5sZW5ndGgpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMuY2hpbGRyZW5baW5kZXhdOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQm90aCB0aGUgc3VwcGxpZWQgRGlzcGxheU9iamVjdHMgbXVzdCBiZSBhIGNoaWxkIG9mIHRoZSBjYWxsZXIgJyArIHRoaXMpOwogICAgfQp9OwoKLyoqCiAqIFJlbW92ZXMgYSBjaGlsZCBmcm9tIHRoZSBjb250YWluZXIuCiAqCiAqIEBtZXRob2QgcmVtb3ZlQ2hpbGQKICogQHBhcmFtIGNoaWxkIHtEaXNwbGF5T2JqZWN0fSBUaGUgRGlzcGxheU9iamVjdCB0byByZW1vdmUKICovClBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUucmVtb3ZlQ2hpbGQgPSBmdW5jdGlvbihjaGlsZCkKewogICAgdmFyIGluZGV4ID0gdGhpcy5jaGlsZHJlbi5pbmRleE9mKCBjaGlsZCApOwogICAgaWYgKCBpbmRleCAhPT0gLTEgKQogICAgewogICAgICAgIC8vIHVubGluayAvLwogICAgICAgIC8vIG1vZGlmeSB0aGUgbGlzdC4uCiAgICAgICAgdmFyIGNoaWxkRmlyc3QgPSBjaGlsZC5maXJzdDsKICAgICAgICB2YXIgY2hpbGRMYXN0ID0gY2hpbGQubGFzdDsKCiAgICAgICAgdmFyIG5leHRPYmplY3QgPSBjaGlsZExhc3QuX2lOZXh0OwogICAgICAgIHZhciBwcmV2aW91c09iamVjdCA9IGNoaWxkRmlyc3QuX2lQcmV2OwoKICAgICAgICBpZihuZXh0T2JqZWN0KW5leHRPYmplY3QuX2lQcmV2ID0gcHJldmlvdXNPYmplY3Q7CiAgICAgICAgcHJldmlvdXNPYmplY3QuX2lOZXh0ID0gbmV4dE9iamVjdDsKCiAgICAgICAgaWYodGhpcy5sYXN0ID09PSBjaGlsZExhc3QpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdGVtcExhc3QgPSBjaGlsZEZpcnN0Ll9pUHJldjsKICAgICAgICAgICAgLy8gbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhcmVudHMgbGFzdCBpcyB1cGRhdGVkIHRvbwogICAgICAgICAgICB2YXIgdXBkYXRlTGFzdCA9IHRoaXM7CgogICAgICAgICAgICB3aGlsZSh1cGRhdGVMYXN0Lmxhc3QgPT09IGNoaWxkTGFzdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdXBkYXRlTGFzdC5sYXN0ID0gdGVtcExhc3Q7CiAgICAgICAgICAgICAgICB1cGRhdGVMYXN0ID0gdXBkYXRlTGFzdC5wYXJlbnQ7CiAgICAgICAgICAgICAgICBpZighdXBkYXRlTGFzdClicmVhazsKCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNoaWxkTGFzdC5faU5leHQgPSBudWxsOwogICAgICAgIGNoaWxkRmlyc3QuX2lQcmV2ID0gbnVsbDsKCiAgICAgICAgLy8gdXBkYXRlIHRoZSBzdGFnZSByZWZlcmVuY2UuLgogICAgICAgIGlmKHRoaXMuc3RhZ2UpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdG1wQ2hpbGQgPSBjaGlsZDsKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYodG1wQ2hpbGQuaW50ZXJhY3RpdmUpdGhpcy5zdGFnZS5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgICAgICB0bXBDaGlsZC5zdGFnZSA9IG51bGw7CiAgICAgICAgICAgICAgICB0bXBDaGlsZCA9IHRtcENoaWxkLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSh0bXBDaGlsZCk7CiAgICAgICAgfQoKICAgICAgICAvLyB3ZWJHTCB0cmltCiAgICAgICAgaWYoY2hpbGQuX19yZW5kZXJHcm91cCkKICAgICAgICB7CiAgICAgICAgICAgIGNoaWxkLl9fcmVuZGVyR3JvdXAucmVtb3ZlRGlzcGxheU9iamVjdEFuZENoaWxkcmVuKGNoaWxkKTsKICAgICAgICB9CgogICAgICAgIGNoaWxkLnBhcmVudCA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLmNoaWxkcmVuLnNwbGljZSggaW5kZXgsIDEgKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoY2hpbGQgKyAnIFRoZSBzdXBwbGllZCBEaXNwbGF5T2JqZWN0IG11c3QgYmUgYSBjaGlsZCBvZiB0aGUgY2FsbGVyICcgKyB0aGlzKTsKICAgIH0KfTsKCi8qCiAqIFVwZGF0ZXMgdGhlIGNvbnRhaW5lcidzIGNoaWxkcmVuJ3MgdHJhbnNmb3JtIGZvciByZW5kZXJpbmcKICoKICogQG1ldGhvZCB1cGRhdGVUcmFuc2Zvcm0KICogQHByaXZhdGUKICovClBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtID0gZnVuY3Rpb24oKQp7CiAgICBpZighdGhpcy52aXNpYmxlKXJldHVybjsKCiAgICBQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybS5jYWxsKCB0aGlzICk7CgogICAgZm9yKHZhciBpPTAsaj10aGlzLmNoaWxkcmVuLmxlbmd0aDsgaTxqOyBpKyspCiAgICB7CiAgICAgICAgdGhpcy5jaGlsZHJlbltpXS51cGRhdGVUcmFuc2Zvcm0oKTsKICAgIH0KfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgpQSVhJLmJsZW5kTW9kZXMgPSB7fTsKUElYSS5ibGVuZE1vZGVzLk5PUk1BTCA9IDA7ClBJWEkuYmxlbmRNb2Rlcy5TQ1JFRU4gPSAxOwoKCi8qKgogKiBUaGUgU1ByaXRlIG9iamVjdCBpcyB0aGUgYmFzZSBmb3IgYWxsIHRleHR1cmVkIG9iamVjdHMgdGhhdCBhcmUgcmVuZGVyZWQgdG8gdGhlIHNjcmVlbgogKgogKiBAY2xhc3MgU3ByaXRlCiAqIEBleHRlbmRzIERpc3BsYXlPYmplY3RDb250YWluZXIKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB0ZXh0dXJlIHtUZXh0dXJlfSBUaGUgdGV4dHVyZSBmb3IgdGhpcyBzcHJpdGUKICogQHR5cGUgU3RyaW5nCiAqLwpQSVhJLlNwcml0ZSA9IGZ1bmN0aW9uKHRleHR1cmUpCnsKICAgIFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5jYWxsKCB0aGlzICk7CgogICAgLyoqCiAgICAgKiBUaGUgYW5jaG9yIHNldHMgdGhlIG9yaWdpbiBwb2ludCBvZiB0aGUgdGV4dHVyZS4KICAgICAqIFRoZSBkZWZhdWx0IGlzIDAsMCB0aGlzIG1lYW5zIHRoZSB0ZXh0dXJlcyBvcmlnaW4gaXMgdGhlIHRvcCBsZWZ0CiAgICAgKiBTZXR0aW5nIHRoYW4gYW5jaG9yIHRvIDAuNSwwLjUgbWVhbnMgdGhlIHRleHR1cmVzIG9yaWdpbiBpcyBjZW50ZXJlZAogICAgICogU2V0dGluZyB0aGUgYW5jaG9yIHRvIDEsMSB3b3VsZCBtZWFuIHRoZSB0ZXh0dXJlcyBvcmlnaW4gcG9pbnRzIHdpbGwgYmUgdGhlIGJvdHRvbSByaWdodAogICAgICoKICAgICAqIEBwcm9wZXJ0eSBhbmNob3IKICAgICAqIEB0eXBlIFBvaW50CiAgICAgKi8KICAgIHRoaXMuYW5jaG9yID0gbmV3IFBJWEkuUG9pbnQoKTsKCiAgICAvKioKICAgICAqIFRoZSB0ZXh0dXJlIHRoYXQgdGhlIHNwcml0ZSBpcyB1c2luZwogICAgICoKICAgICAqIEBwcm9wZXJ0eSB0ZXh0dXJlCiAgICAgKiBAdHlwZSBUZXh0dXJlCiAgICAgKi8KICAgIHRoaXMudGV4dHVyZSA9IHRleHR1cmU7CgogICAgLyoqCiAgICAgKiBUaGUgYmxlbmQgbW9kZSBvZiBzcHJpdGUuCiAgICAgKiBjdXJyZW50bHkgc3VwcG9ydHMgUElYSS5ibGVuZE1vZGVzLk5PUk1BTCBhbmQgUElYSS5ibGVuZE1vZGVzLlNDUkVFTgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBibGVuZE1vZGUKICAgICAqIEB0eXBlIE51bWJlcgogICAgICovCiAgICB0aGlzLmJsZW5kTW9kZSA9IFBJWEkuYmxlbmRNb2Rlcy5OT1JNQUw7CgogICAgLyoqCiAgICAgKiBUaGUgd2lkdGggb2YgdGhlIHNwcml0ZSAodGhpcyBpcyBpbml0aWFsbHkgc2V0IGJ5IHRoZSB0ZXh0dXJlKQogICAgICoKICAgICAqIEBwcm9wZXJ0eSBfd2lkdGgKICAgICAqIEB0eXBlIE51bWJlcgogICAgICogQHByaXZhdGUKICAgICAqLwogICAgdGhpcy5fd2lkdGggPSAwOwoKICAgIC8qKgogICAgICogVGhlIGhlaWdodCBvZiB0aGUgc3ByaXRlICh0aGlzIGlzIGluaXRpYWxseSBzZXQgYnkgdGhlIHRleHR1cmUpCiAgICAgKgogICAgICogQHByb3BlcnR5IF9oZWlnaHQKICAgICAqIEB0eXBlIE51bWJlcgogICAgICogQHByaXZhdGUKICAgICAqLwogICAgdGhpcy5faGVpZ2h0ID0gMDsKCiAgICBpZih0ZXh0dXJlLmJhc2VUZXh0dXJlLmhhc0xvYWRlZCkKICAgIHsKICAgICAgICB0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLm9uVGV4dHVyZVVwZGF0ZUJpbmQgPSB0aGlzLm9uVGV4dHVyZVVwZGF0ZS5iaW5kKHRoaXMpOwogICAgICAgIHRoaXMudGV4dHVyZS5hZGRFdmVudExpc3RlbmVyKCAndXBkYXRlJywgdGhpcy5vblRleHR1cmVVcGRhdGVCaW5kICk7CiAgICB9CgogICAgdGhpcy5yZW5kZXJhYmxlID0gdHJ1ZTsKfTsKCi8vIGNvbnN0cnVjdG9yClBJWEkuU3ByaXRlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUgKTsKUElYSS5TcHJpdGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5TcHJpdGU7CgovKioKICogVGhlIHdpZHRoIG9mIHRoZSBzcHJpdGUsIHNldHRpbmcgdGhpcyB3aWxsIGFjdHVhbGx5IG1vZGlmeSB0aGUgc2NhbGUgdG8gYWNoZWl2ZSB0aGUgdmFsdWUgc2V0CiAqCiAqIEBwcm9wZXJ0eSB3aWR0aAogKiBAdHlwZSBOdW1iZXIKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLlNwcml0ZS5wcm90b3R5cGUsICd3aWR0aCcsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUueCAqIHRoaXMudGV4dHVyZS5mcmFtZS53aWR0aDsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5zY2FsZS54ID0gdmFsdWUgLyB0aGlzLnRleHR1cmUuZnJhbWUud2lkdGg7CiAgICAgICAgdGhpcy5fd2lkdGggPSB2YWx1ZTsKICAgIH0KfSk7CgovKioKICogVGhlIGhlaWdodCBvZiB0aGUgc3ByaXRlLCBzZXR0aW5nIHRoaXMgd2lsbCBhY3R1YWxseSBtb2RpZnkgdGhlIHNjYWxlIHRvIGFjaGVpdmUgdGhlIHZhbHVlIHNldAogKgogKiBAcHJvcGVydHkgaGVpZ2h0CiAqIEB0eXBlIE51bWJlcgogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuU3ByaXRlLnByb3RvdHlwZSwgJ2hlaWdodCcsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICB0aGlzLnNjYWxlLnkgKiB0aGlzLnRleHR1cmUuZnJhbWUuaGVpZ2h0OwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnNjYWxlLnkgPSB2YWx1ZSAvIHRoaXMudGV4dHVyZS5mcmFtZS5oZWlnaHQ7CiAgICAgICAgdGhpcy5faGVpZ2h0ID0gdmFsdWU7CiAgICB9Cn0pOwoKLyoqCiAqIFNldHMgdGhlIHRleHR1cmUgb2YgdGhlIHNwcml0ZQogKgogKiBAbWV0aG9kIHNldFRleHR1cmUKICogQHBhcmFtIHRleHR1cmUge1RleHR1cmV9IFRoZSBQSVhJIHRleHR1cmUgdGhhdCBpcyBkaXNwbGF5ZWQgYnkgdGhlIHNwcml0ZQogKi8KUElYSS5TcHJpdGUucHJvdG90eXBlLnNldFRleHR1cmUgPSBmdW5jdGlvbih0ZXh0dXJlKQp7CiAgICAvLyBzdG9wIGN1cnJlbnQgdGV4dHVyZTsKICAgIGlmKHRoaXMudGV4dHVyZS5iYXNlVGV4dHVyZSAhPT0gdGV4dHVyZS5iYXNlVGV4dHVyZSkKICAgIHsKICAgICAgICB0aGlzLnRleHR1cmVDaGFuZ2UgPSB0cnVlOwogICAgICAgIHRoaXMudGV4dHVyZSA9IHRleHR1cmU7CgogICAgICAgIGlmKHRoaXMuX19yZW5kZXJHcm91cCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX19yZW5kZXJHcm91cC51cGRhdGVUZXh0dXJlKHRoaXMpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwogICAgfQoKICAgIHRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwp9OwoKLyoqCiAqIFdoZW4gdGhlIHRleHR1cmUgaXMgdXBkYXRlZCwgdGhpcyBldmVudCB3aWxsIGZpcmUgdG8gdXBkYXRlIHRoZSBzY2FsZSBhbmQgZnJhbWUKICoKICogQG1ldGhvZCBvblRleHR1cmVVcGRhdGUKICogQHBhcmFtIGV2ZW50CiAqIEBwcml2YXRlCiAqLwpQSVhJLlNwcml0ZS5wcm90b3R5cGUub25UZXh0dXJlVXBkYXRlID0gZnVuY3Rpb24oKQp7CiAgICAvL3RoaXMudGV4dHVyZS5yZW1vdmVFdmVudExpc3RlbmVyKCAndXBkYXRlJywgdGhpcy5vblRleHR1cmVVcGRhdGVCaW5kICk7CgogICAgLy8gc28gaWYgX3dpZHRoIGlzIDAgdGhlbiB3aWR0aCB3YXMgbm90IHNldC4uCiAgICBpZih0aGlzLl93aWR0aCl0aGlzLnNjYWxlLnggPSB0aGlzLl93aWR0aCAvIHRoaXMudGV4dHVyZS5mcmFtZS53aWR0aDsKICAgIGlmKHRoaXMuX2hlaWdodCl0aGlzLnNjYWxlLnkgPSB0aGlzLl9oZWlnaHQgLyB0aGlzLnRleHR1cmUuZnJhbWUuaGVpZ2h0OwoKICAgIHRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwp9OwoKLy8gc29tZSBoZWxwZXIgZnVuY3Rpb25zLi4KCi8qKgogKgogKiBIZWxwZXIgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgc3ByaXRlIHRoYXQgd2lsbCBjb250YWluIGEgdGV4dHVyZSBmcm9tIHRoZSBUZXh0dXJlQ2FjaGUgYmFzZWQgb24gdGhlIGZyYW1lSWQKICogVGhlIGZyYW1lIGlkcyBhcmUgY3JlYXRlZCB3aGVuIGEgVGV4dHVyZSBwYWNrZXIgZmlsZSBoYXMgYmVlbiBsb2FkZWQKICoKICogQG1ldGhvZCBmcm9tRnJhbWUKICogQHN0YXRpYwogKiBAcGFyYW0gZnJhbWVJZCB7U3RyaW5nfSBUaGUgZnJhbWUgSWQgb2YgdGhlIHRleHR1cmUgaW4gdGhlIGNhY2hlCiAqIEByZXR1cm4ge1Nwcml0ZX0gQSBuZXcgU3ByaXRlIHVzaW5nIGEgdGV4dHVyZSBmcm9tIHRoZSB0ZXh0dXJlIGNhY2hlIG1hdGNoaW5nIHRoZSBmcmFtZUlkCiAqLwpQSVhJLlNwcml0ZS5mcm9tRnJhbWUgPSBmdW5jdGlvbihmcmFtZUlkKQp7CiAgICB2YXIgdGV4dHVyZSA9IFBJWEkuVGV4dHVyZUNhY2hlW2ZyYW1lSWRdOwogICAgaWYoIXRleHR1cmUpIHRocm93IG5ldyBFcnJvcignVGhlIGZyYW1lSWQgIicgKyBmcmFtZUlkICsgJyIgZG9lcyBub3QgZXhpc3QgaW4gdGhlIHRleHR1cmUgY2FjaGUnICsgdGhpcyk7CiAgICByZXR1cm4gbmV3IFBJWEkuU3ByaXRlKHRleHR1cmUpOwp9OwoKLyoqCiAqCiAqIEhlbHBlciBmdW5jdGlvbiB0aGF0IGNyZWF0ZXMgYSBzcHJpdGUgdGhhdCB3aWxsIGNvbnRhaW4gYSB0ZXh0dXJlIGJhc2VkIG9uIGFuIGltYWdlIHVybAogKiBJZiB0aGUgaW1hZ2UgaXMgbm90IGluIHRoZSB0ZXh0dXJlIGNhY2hlIGl0IHdpbGwgYmUgbG9hZGVkCiAqCiAqIEBtZXRob2QgZnJvbUltYWdlCiAqIEBzdGF0aWMKICogQHBhcmFtIGltYWdlSWQge1N0cmluZ30gVGhlIGltYWdlIHVybCBvZiB0aGUgdGV4dHVyZQogKiBAcmV0dXJuIHtTcHJpdGV9IEEgbmV3IFNwcml0ZSB1c2luZyBhIHRleHR1cmUgZnJvbSB0aGUgdGV4dHVyZSBjYWNoZSBtYXRjaGluZyB0aGUgaW1hZ2UgaWQKICovClBJWEkuU3ByaXRlLmZyb21JbWFnZSA9IGZ1bmN0aW9uKGltYWdlSWQpCnsKICAgIHZhciB0ZXh0dXJlID0gUElYSS5UZXh0dXJlLmZyb21JbWFnZShpbWFnZUlkKTsKICAgIHJldHVybiBuZXcgUElYSS5TcHJpdGUodGV4dHVyZSk7Cn07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIEEgU3RhZ2UgcmVwcmVzZW50cyB0aGUgcm9vdCBvZiB0aGUgZGlzcGxheSB0cmVlLiBFdmVyeXRoaW5nIGNvbm5lY3RlZCB0byB0aGUgc3RhZ2UgaXMgcmVuZGVyZWQKICoKICogQGNsYXNzIFN0YWdlCiAqIEBleHRlbmRzIERpc3BsYXlPYmplY3RDb250YWluZXIKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSBiYWNrZ3JvdW5kQ29sb3Ige051bWJlcn0gdGhlIGJhY2tncm91bmQgY29sb3Igb2YgdGhlIHN0YWdlLCBlYXNpZXN0IHdheSB0byBwYXNzIHRoaXMgaW4gaXMgaW4gaGV4IGZvcm1hdAogKiAgICAgIGxpa2U6IDB4RkZGRkZGIGZvciB3aGl0ZQogKi8KUElYSS5TdGFnZSA9IGZ1bmN0aW9uKGJhY2tncm91bmRDb2xvcikKewogICAgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwoIHRoaXMgKTsKCiAgICAvKioKICAgICAqIFtyZWFkLW9ubHldIEN1cnJlbnQgdHJhbnNmb3JtIG9mIHRoZSBvYmplY3QgYmFzZWQgb24gd29ybGQgKHBhcmVudCkgZmFjdG9ycwogICAgICoKICAgICAqIEBwcm9wZXJ0eSB3b3JsZFRyYW5zZm9ybQogICAgICogQHR5cGUgTWF0MwogICAgICogQHJlYWRPbmx5CiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICB0aGlzLndvcmxkVHJhbnNmb3JtID0gUElYSS5tYXQzLmNyZWF0ZSgpOwoKICAgIC8qKgogICAgICogV2hldGhlciBvciBub3QgdGhlIHN0YWdlIGlzIGludGVyYWN0aXZlCiAgICAgKgogICAgICogQHByb3BlcnR5IGludGVyYWN0aXZlCiAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgKi8KICAgIHRoaXMuaW50ZXJhY3RpdmUgPSB0cnVlOwoKICAgIC8qKgogICAgICogVGhlIGludGVyYWN0aW9uIG1hbmFnZSBmb3IgdGhpcyBzdGFnZSwgbWFuYWdlcyBhbGwgaW50ZXJhY3RpdmUgYWN0aXZpdHkgb24gdGhlIHN0YWdlCiAgICAgKgogICAgICogQHByb3BlcnR5IGludGVyYWN0aXZlCiAgICAgKiBAdHlwZSBJbnRlcmFjdGlvbk1hbmFnZXIKICAgICAqLwogICAgdGhpcy5pbnRlcmFjdGlvbk1hbmFnZXIgPSBuZXcgUElYSS5JbnRlcmFjdGlvbk1hbmFnZXIodGhpcyk7CgogICAgLyoqCiAgICAgKiBXaGV0aGVyIHRoZSBzdGFnZSBpcyBkaXJ0eSBhbmQgbmVlZHMgdG8gaGF2ZSBpbnRlcmFjdGlvbnMgdXBkYXRlZAogICAgICoKICAgICAqIEBwcm9wZXJ0eSBkaXJ0eQogICAgICogQHR5cGUgQm9vbGVhbgogICAgICogQHByaXZhdGUKICAgICAqLwogICAgdGhpcy5kaXJ0eSA9IHRydWU7CgogICAgdGhpcy5fX2NoaWxkcmVuQWRkZWQgPSBbXTsKICAgIHRoaXMuX19jaGlsZHJlblJlbW92ZWQgPSBbXTsKCiAgICAvL3RoZSBzdGFnZSBpcyBpdCdzIG93biBzdGFnZQogICAgdGhpcy5zdGFnZSA9IHRoaXM7CgogICAgLy9vcHRpbWl6ZSBoaXQgZGV0ZWN0aW9uIGEgYml0CiAgICB0aGlzLnN0YWdlLmhpdEFyZWEgPSBuZXcgUElYSS5SZWN0YW5nbGUoMCwwLDEwMDAwMCwgMTAwMDAwKTsKCiAgICB0aGlzLnNldEJhY2tncm91bmRDb2xvcihiYWNrZ3JvdW5kQ29sb3IpOwogICAgdGhpcy53b3JsZFZpc2libGUgPSB0cnVlOwp9OwoKLy8gY29uc3RydWN0b3IKUElYSS5TdGFnZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlICk7ClBJWEkuU3RhZ2UucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5TdGFnZTsKCi8qKgogKiBTZXRzIGFub3RoZXIgRE9NIGVsZW1lbnQgd2hpY2ggY2FuIHJlY2VpdmUgbW91c2UvdG91Y2ggaW50ZXJhY3Rpb25zIGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgQ2FudmFzIGVsZW1lbnQuCiAqIFRoaXMgaXMgdXNlZnVsIGZvciB3aGVuIHlvdSBoYXZlIG90aGVyIERPTSBlbGVtZW50cyBvbnRvcCBvZiB0aGUgQ2FudmFzIGVsZW1lbnQuCiAqCiAqIEBtZXRob2Qgc2V0SW50ZXJhY3Rpb25EZWxlZ2F0ZQogKiBAcGFyYW0gZG9tRWxlbWVudCB7RE9NRWxlbWVudH0gVGhpcyBuZXcgZG9tRWxlbWVudCB3aGljaCB3aWxsIHJlY2VpdmUgbW91c2UvdG91Y2ggZXZlbnRzCiAqLwpQSVhJLlN0YWdlLnByb3RvdHlwZS5zZXRJbnRlcmFjdGlvbkRlbGVnYXRlID0gZnVuY3Rpb24oZG9tRWxlbWVudCkKewogICAgdGhpcy5pbnRlcmFjdGlvbk1hbmFnZXIuc2V0VGFyZ2V0RG9tRWxlbWVudCggZG9tRWxlbWVudCApOwp9OwoKLyoKICogVXBkYXRlcyB0aGUgb2JqZWN0IHRyYW5zZm9ybSBmb3IgcmVuZGVyaW5nCiAqCiAqIEBtZXRob2QgdXBkYXRlVHJhbnNmb3JtCiAqIEBwcml2YXRlCiAqLwpQSVhJLlN0YWdlLnByb3RvdHlwZS51cGRhdGVUcmFuc2Zvcm0gPSBmdW5jdGlvbigpCnsKICAgIHRoaXMud29ybGRBbHBoYSA9IDE7CiAgICB0aGlzLnZjb3VudCA9IFBJWEkudmlzaWJsZUNvdW50OwoKICAgIGZvcih2YXIgaT0wLGo9dGhpcy5jaGlsZHJlbi5sZW5ndGg7IGk8ajsgaSsrKQogICAgewogICAgICAgIHRoaXMuY2hpbGRyZW5baV0udXBkYXRlVHJhbnNmb3JtKCk7CiAgICB9CgogICAgaWYodGhpcy5kaXJ0eSkKICAgIHsKICAgICAgICB0aGlzLmRpcnR5ID0gZmFsc2U7CiAgICAgICAgLy8gdXBkYXRlIGludGVyYWN0aXZlIQogICAgICAgIHRoaXMuaW50ZXJhY3Rpb25NYW5hZ2VyLmRpcnR5ID0gdHJ1ZTsKICAgIH0KCgogICAgaWYodGhpcy5pbnRlcmFjdGl2ZSl0aGlzLmludGVyYWN0aW9uTWFuYWdlci51cGRhdGUoKTsKfTsKCi8qKgogKiBTZXRzIHRoZSBiYWNrZ3JvdW5kIGNvbG9yIGZvciB0aGUgc3RhZ2UKICoKICogQG1ldGhvZCBzZXRCYWNrZ3JvdW5kQ29sb3IKICogQHBhcmFtIGJhY2tncm91bmRDb2xvciB7TnVtYmVyfSB0aGUgY29sb3Igb2YgdGhlIGJhY2tncm91bmQsIGVhc2llc3Qgd2F5IHRvIHBhc3MgdGhpcyBpbiBpcyBpbiBoZXggZm9ybWF0CiAqICAgICAgbGlrZTogMHhGRkZGRkYgZm9yIHdoaXRlCiAqLwpQSVhJLlN0YWdlLnByb3RvdHlwZS5zZXRCYWNrZ3JvdW5kQ29sb3IgPSBmdW5jdGlvbihiYWNrZ3JvdW5kQ29sb3IpCnsKICAgIHRoaXMuYmFja2dyb3VuZENvbG9yID0gYmFja2dyb3VuZENvbG9yIHx8IDB4MDAwMDAwOwogICAgdGhpcy5iYWNrZ3JvdW5kQ29sb3JTcGxpdCA9IFBJWEkuaGV4MnJnYih0aGlzLmJhY2tncm91bmRDb2xvcik7CiAgICB2YXIgaGV4ID0gdGhpcy5iYWNrZ3JvdW5kQ29sb3IudG9TdHJpbmcoMTYpOwogICAgaGV4ID0gJzAwMDAwMCcuc3Vic3RyKDAsIDYgLSBoZXgubGVuZ3RoKSArIGhleDsKICAgIHRoaXMuYmFja2dyb3VuZENvbG9yU3RyaW5nID0gJyMnICsgaGV4Owp9OwoKLyoqCiAqIFRoaXMgd2lsbCByZXR1cm4gdGhlIHBvaW50IGNvbnRhaW5pbmcgZ2xvYmFsIGNvb3JkcyBvZiB0aGUgbW91c2UuCiAqCiAqIEBtZXRob2QgZ2V0TW91c2VQb3NpdGlvbgogKiBAcmV0dXJuIHtQb2ludH0gVGhlIHBvaW50IGNvbnRhaW5pbmcgdGhlIGNvb3JkcyBvZiB0aGUgZ2xvYmFsIEludGVyYWN0aW9uRGF0YSBwb3NpdGlvbi4KICovClBJWEkuU3RhZ2UucHJvdG90eXBlLmdldE1vdXNlUG9zaXRpb24gPSBmdW5jdGlvbigpCnsKICAgIHJldHVybiB0aGlzLmludGVyYWN0aW9uTWFuYWdlci5tb3VzZS5nbG9iYWw7Cn07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKCi8qKgogKiBUaGlzIG9iamVjdCBpcyBvbmUgdGhhdCB3aWxsIGFsbG93IHlvdSB0byBzcGVjaWZ5IGN1c3RvbSByZW5kZXJpbmcgZnVuY3Rpb25zIGJhc2VkIG9uIHJlbmRlciB0eXBlCiAqCiAqIEBjbGFzcyBDdXN0b21SZW5kZXJhYmxlCiAqIEBleHRlbmRzIERpc3BsYXlPYmplY3QKICogQGNvbnN0cnVjdG9yCiAqLwpQSVhJLkN1c3RvbVJlbmRlcmFibGUgPSBmdW5jdGlvbigpCnsKICAgIFBJWEkuRGlzcGxheU9iamVjdC5jYWxsKCB0aGlzICk7CgogICAgdGhpcy5yZW5kZXJhYmxlID0gdHJ1ZTsKfTsKCi8vIGNvbnN0cnVjdG9yClBJWEkuQ3VzdG9tUmVuZGVyYWJsZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlICk7ClBJWEkuQ3VzdG9tUmVuZGVyYWJsZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLkN1c3RvbVJlbmRlcmFibGU7CgovKioKICogSWYgdGhpcyBvYmplY3QgaXMgYmVpbmcgcmVuZGVyZWQgYnkgYSBDYW52YXNSZW5kZXJlciBpdCB3aWxsIGNhbGwgdGhpcyBjYWxsYmFjawogKgogKiBAbWV0aG9kIHJlbmRlckNhbnZhcwogKiBAcGFyYW0gcmVuZGVyZXIge0NhbnZhc1JlbmRlcmVyfSBUaGUgcmVuZGVyZXIgaW5zdGFuY2UKICovClBJWEkuQ3VzdG9tUmVuZGVyYWJsZS5wcm90b3R5cGUucmVuZGVyQ2FudmFzID0gZnVuY3Rpb24oKQp7CiAgICAvLyBvdmVycmlkZSEKfTsKCi8qKgogKiBJZiB0aGlzIG9iamVjdCBpcyBiZWluZyByZW5kZXJlZCBieSBhIFdlYkdMUmVuZGVyZXIgaXQgd2lsbCBjYWxsIHRoaXMgY2FsbGJhY2sgdG8gaW5pdGlhbGl6ZQogKgogKiBAbWV0aG9kIGluaXRXZWJHTAogKiBAcGFyYW0gcmVuZGVyZXIge1dlYkdMUmVuZGVyZXJ9IFRoZSByZW5kZXJlciBpbnN0YW5jZQogKi8KUElYSS5DdXN0b21SZW5kZXJhYmxlLnByb3RvdHlwZS5pbml0V2ViR0wgPSBmdW5jdGlvbigpCnsKICAgIC8vIG92ZXJyaWRlIQp9OwoKLyoqCiAqIElmIHRoaXMgb2JqZWN0IGlzIGJlaW5nIHJlbmRlcmVkIGJ5IGEgV2ViR0xSZW5kZXJlciBpdCB3aWxsIGNhbGwgdGhpcyBjYWxsYmFjawogKgogKiBAbWV0aG9kIHJlbmRlcldlYkdMCiAqIEBwYXJhbSByZW5kZXJlckdyb3VwIHtXZWJHTFJlbmRlckdyb3VwfSBUaGUgcmVuZGVyZXIgZ3JvdXAgaW5zdGFuY2UKICogQHBhcmFtIHByb2plY3Rpb25NYXRyaXgge01hdHJpeH0gVGhlIG9iamVjdCdzIHByb2plY3Rpb24gbWF0cml4CiAqLwpQSVhJLkN1c3RvbVJlbmRlcmFibGUucHJvdG90eXBlLnJlbmRlcldlYkdMID0gZnVuY3Rpb24oKQp7CiAgICAvLyBub3Qgc3VyZSBpZiBib3RoIG5lZWRlZD8gYnV0IHlhIGhhdmUgZm9yIG5vdyEKICAgIC8vIG92ZXJyaWRlIQp9OwoKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vCiAqLwoKUElYSS5TdHJpcCA9IGZ1bmN0aW9uKHRleHR1cmUsIHdpZHRoLCBoZWlnaHQpCnsKICAgIFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5jYWxsKCB0aGlzICk7CiAgICB0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwogICAgdGhpcy5ibGVuZE1vZGUgPSBQSVhJLmJsZW5kTW9kZXMuTk9STUFMOwoKICAgIHRyeQogICAgewogICAgICAgIHRoaXMudXZzID0gbmV3IEZsb2F0MzJBcnJheShbMCwgMSwKICAgICAgICAgICAgICAgIDEsIDEsCiAgICAgICAgICAgICAgICAxLCAwLCAwLDFdKTsKCiAgICAgICAgdGhpcy52ZXJ0aWNpZXMgPSBuZXcgRmxvYXQzMkFycmF5KFswLCAwLAogICAgICAgICAgICAgICAgICAgICAgICAgIDAsMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAwLDAsIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgMCwgMF0pOwoKICAgICAgICB0aGlzLmNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkoWzEsIDEsIDEsIDFdKTsKCiAgICAgICAgdGhpcy5pbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KFswLCAxLCAyLCAzXSk7CiAgICB9CiAgICBjYXRjaChlcnJvcikKICAgIHsKICAgICAgICB0aGlzLnV2cyA9IFswLCAxLAogICAgICAgICAgICAgICAgMSwgMSwKICAgICAgICAgICAgICAgIDEsIDAsIDAsMV07CgogICAgICAgIHRoaXMudmVydGljaWVzID0gWzAsIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgMCwwLAogICAgICAgICAgICAgICAgICAgICAgICAgIDAsMCwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAwLCAwXTsKCiAgICAgICAgdGhpcy5jb2xvcnMgPSBbMSwgMSwgMSwgMV07CgogICAgICAgIHRoaXMuaW5kaWNlcyA9IFswLCAxLCAyLCAzXTsKICAgIH0KCgogICAgLyoKICAgIHRoaXMudXZzID0gbmV3IEZsb2F0MzJBcnJheSgpCiAgICB0aGlzLnZlcnRpY2llcyA9IG5ldyBGbG9hdDMyQXJyYXkoKQogICAgdGhpcy5jb2xvcnMgPSBuZXcgRmxvYXQzMkFycmF5KCkKICAgIHRoaXMuaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheSgpCiAgICAqLwogICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgLy8gbG9hZCB0aGUgdGV4dHVyZSEKICAgIGlmKHRleHR1cmUuYmFzZVRleHR1cmUuaGFzTG9hZGVkKQogICAgewogICAgICAgIHRoaXMud2lkdGggICA9IHRoaXMudGV4dHVyZS5mcmFtZS53aWR0aDsKICAgICAgICB0aGlzLmhlaWdodCAgPSB0aGlzLnRleHR1cmUuZnJhbWUuaGVpZ2h0OwogICAgICAgIHRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMub25UZXh0dXJlVXBkYXRlQmluZCA9IHRoaXMub25UZXh0dXJlVXBkYXRlLmJpbmQodGhpcyk7CiAgICAgICAgdGhpcy50ZXh0dXJlLmFkZEV2ZW50TGlzdGVuZXIoICd1cGRhdGUnLCB0aGlzLm9uVGV4dHVyZVVwZGF0ZUJpbmQgKTsKICAgIH0KCiAgICB0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwp9OwoKLy8gY29uc3RydWN0b3IKUElYSS5TdHJpcC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlICk7ClBJWEkuU3RyaXAucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5TdHJpcDsKClBJWEkuU3RyaXAucHJvdG90eXBlLnNldFRleHR1cmUgPSBmdW5jdGlvbih0ZXh0dXJlKQp7CiAgICAvL1RPRE8gU0VUIFRIRSBURVhUVVJFUwogICAgLy9UT0RPIFZJU0lCSUxJVFkKCiAgICAvLyBzdG9wIGN1cnJlbnQgdGV4dHVyZQogICAgdGhpcy50ZXh0dXJlID0gdGV4dHVyZTsKICAgIHRoaXMud2lkdGggICA9IHRleHR1cmUuZnJhbWUud2lkdGg7CiAgICB0aGlzLmhlaWdodCAgPSB0ZXh0dXJlLmZyYW1lLmhlaWdodDsKICAgIHRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwp9OwoKUElYSS5TdHJpcC5wcm90b3R5cGUub25UZXh0dXJlVXBkYXRlID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKfTsKLy8gc29tZSBoZWxwZXIgZnVuY3Rpb25zLi4KCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vCiAqLwoKUElYSS5Sb3BlID0gZnVuY3Rpb24odGV4dHVyZSwgcG9pbnRzKQp7CiAgICBQSVhJLlN0cmlwLmNhbGwoIHRoaXMsIHRleHR1cmUgKTsKICAgIHRoaXMucG9pbnRzID0gcG9pbnRzOwoKICAgIHRyeQogICAgewogICAgICAgIHRoaXMudmVydGljaWVzID0gbmV3IEZsb2F0MzJBcnJheShwb2ludHMubGVuZ3RoICogNCk7CiAgICAgICAgdGhpcy51dnMgPSBuZXcgRmxvYXQzMkFycmF5KHBvaW50cy5sZW5ndGggKiA0KTsKICAgICAgICB0aGlzLmNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkocG9pbnRzLmxlbmd0aCAqIDIpOwogICAgICAgIHRoaXMuaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheShwb2ludHMubGVuZ3RoICogMik7CiAgICB9CiAgICBjYXRjaChlcnJvcikKICAgIHsKICAgICAgICB0aGlzLnZlcnRpY2llcyA9IG5ldyBBcnJheShwb2ludHMubGVuZ3RoICogNCk7CiAgICAgICAgdGhpcy51dnMgPSBuZXcgQXJyYXkocG9pbnRzLmxlbmd0aCAqIDQpOwogICAgICAgIHRoaXMuY29sb3JzID0gbmV3IEFycmF5KHBvaW50cy5sZW5ndGggKiAyKTsKICAgICAgICB0aGlzLmluZGljZXMgPSBuZXcgQXJyYXkocG9pbnRzLmxlbmd0aCAqIDIpOwogICAgfQoKICAgIHRoaXMucmVmcmVzaCgpOwp9OwoKCi8vIGNvbnN0cnVjdG9yClBJWEkuUm9wZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLlN0cmlwLnByb3RvdHlwZSApOwpQSVhJLlJvcGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5Sb3BlOwoKUElYSS5Sb3BlLnByb3RvdHlwZS5yZWZyZXNoID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgcG9pbnRzID0gdGhpcy5wb2ludHM7CiAgICBpZihwb2ludHMubGVuZ3RoIDwgMSkgcmV0dXJuOwoKICAgIHZhciB1dnMgPSB0aGlzLnV2czsKCiAgICB2YXIgbGFzdFBvaW50ID0gcG9pbnRzWzBdOwogICAgdmFyIGluZGljZXMgPSB0aGlzLmluZGljZXM7CiAgICB2YXIgY29sb3JzID0gdGhpcy5jb2xvcnM7CgogICAgdGhpcy5jb3VudC09MC4yOwoKCiAgICB1dnNbMF0gPSAwOwogICAgdXZzWzFdID0gMTsKICAgIHV2c1syXSA9IDA7CiAgICB1dnNbM10gPSAxOwoKICAgIGNvbG9yc1swXSA9IDE7CiAgICBjb2xvcnNbMV0gPSAxOwoKICAgIGluZGljZXNbMF0gPSAwOwogICAgaW5kaWNlc1sxXSA9IDE7CgogICAgdmFyIHRvdGFsID0gcG9pbnRzLmxlbmd0aCwKICAgICAgICBwb2ludCwgaW5kZXgsIGFtb3VudDsKCiAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRvdGFsOyBpKyspCiAgICB7CgogICAgICAgIHBvaW50ID0gcG9pbnRzW2ldOwogICAgICAgIGluZGV4ID0gaSAqIDQ7CiAgICAgICAgLy8gdGltZSB0byBkbyBzb21lIHNtYXJ0IGRyYXdpbmchCiAgICAgICAgYW1vdW50ID0gaSAvICh0b3RhbC0xKTsKCiAgICAgICAgaWYoaSUyKQogICAgICAgIHsKICAgICAgICAgICAgdXZzW2luZGV4XSA9IGFtb3VudDsKICAgICAgICAgICAgdXZzW2luZGV4KzFdID0gMDsKCiAgICAgICAgICAgIHV2c1tpbmRleCsyXSA9IGFtb3VudDsKICAgICAgICAgICAgdXZzW2luZGV4KzNdID0gMTsKCiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHV2c1tpbmRleF0gPSBhbW91bnQ7CiAgICAgICAgICAgIHV2c1tpbmRleCsxXSA9IDA7CgogICAgICAgICAgICB1dnNbaW5kZXgrMl0gPSBhbW91bnQ7CiAgICAgICAgICAgIHV2c1tpbmRleCszXSA9IDE7CiAgICAgICAgfQoKICAgICAgICBpbmRleCA9IGkgKiAyOwogICAgICAgIGNvbG9yc1tpbmRleF0gPSAxOwogICAgICAgIGNvbG9yc1tpbmRleCsxXSA9IDE7CgogICAgICAgIGluZGV4ID0gaSAqIDI7CiAgICAgICAgaW5kaWNlc1tpbmRleF0gPSBpbmRleDsKICAgICAgICBpbmRpY2VzW2luZGV4ICsgMV0gPSBpbmRleCArIDE7CgogICAgICAgIGxhc3RQb2ludCA9IHBvaW50OwogICAgfQp9OwoKUElYSS5Sb3BlLnByb3RvdHlwZS51cGRhdGVUcmFuc2Zvcm0gPSBmdW5jdGlvbigpCnsKCiAgICB2YXIgcG9pbnRzID0gdGhpcy5wb2ludHM7CiAgICBpZihwb2ludHMubGVuZ3RoIDwgMSlyZXR1cm47CgogICAgdmFyIGxhc3RQb2ludCA9IHBvaW50c1swXTsKICAgIHZhciBuZXh0UG9pbnQ7CiAgICB2YXIgcGVycCA9IHt4OjAsIHk6MH07CgogICAgdGhpcy5jb3VudC09MC4yOwoKICAgIHZhciB2ZXJ0aWNpZXMgPSB0aGlzLnZlcnRpY2llczsKICAgIHZlcnRpY2llc1swXSA9IGxhc3RQb2ludC54ICsgcGVycC54OwogICAgdmVydGljaWVzWzFdID0gbGFzdFBvaW50LnkgKyBwZXJwLnk7IC8vKyAyMDAKICAgIHZlcnRpY2llc1syXSA9IGxhc3RQb2ludC54IC0gcGVycC54OwogICAgdmVydGljaWVzWzNdID0gbGFzdFBvaW50LnkgLSBwZXJwLnk7Ly8rMjAwCiAgICAvLyB0aW1lIHRvIGRvIHNvbWUgc21hcnQgZHJhd2luZyEKCiAgICB2YXIgdG90YWwgPSBwb2ludHMubGVuZ3RoLAogICAgICAgIHBvaW50LCBpbmRleCwgcmF0aW8sIHBlcnBMZW5ndGgsIG51bTsKCiAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRvdGFsOyBpKyspCiAgICB7CiAgICAgICAgcG9pbnQgPSBwb2ludHNbaV07CiAgICAgICAgaW5kZXggPSBpICogNDsKCiAgICAgICAgaWYoaSA8IHBvaW50cy5sZW5ndGgtMSkKICAgICAgICB7CiAgICAgICAgICAgIG5leHRQb2ludCA9IHBvaW50c1tpKzFdOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBuZXh0UG9pbnQgPSBwb2ludDsKICAgICAgICB9CgogICAgICAgIHBlcnAueSA9IC0obmV4dFBvaW50LnggLSBsYXN0UG9pbnQueCk7CiAgICAgICAgcGVycC54ID0gbmV4dFBvaW50LnkgLSBsYXN0UG9pbnQueTsKCiAgICAgICAgcmF0aW8gPSAoMSAtIChpIC8gKHRvdGFsLTEpKSkgKiAxMDsKCiAgICAgICAgaWYocmF0aW8gPiAxKSByYXRpbyA9IDE7CgogICAgICAgIHBlcnBMZW5ndGggPSBNYXRoLnNxcnQocGVycC54ICogcGVycC54ICsgcGVycC55ICogcGVycC55KTsKICAgICAgICBudW0gPSB0aGlzLnRleHR1cmUuaGVpZ2h0IC8gMjsgLy8oMjAgKyBNYXRoLmFicyhNYXRoLnNpbigoaSArIHRoaXMuY291bnQpICogMC4zKSAqIDUwKSApKiByYXRpbzsKICAgICAgICBwZXJwLnggLz0gcGVycExlbmd0aDsKICAgICAgICBwZXJwLnkgLz0gcGVycExlbmd0aDsKCiAgICAgICAgcGVycC54ICo9IG51bTsKICAgICAgICBwZXJwLnkgKj0gbnVtOwoKICAgICAgICB2ZXJ0aWNpZXNbaW5kZXhdID0gcG9pbnQueCArIHBlcnAueDsKICAgICAgICB2ZXJ0aWNpZXNbaW5kZXgrMV0gPSBwb2ludC55ICsgcGVycC55OwogICAgICAgIHZlcnRpY2llc1tpbmRleCsyXSA9IHBvaW50LnggLSBwZXJwLng7CiAgICAgICAgdmVydGljaWVzW2luZGV4KzNdID0gcG9pbnQueSAtIHBlcnAueTsKCiAgICAgICAgbGFzdFBvaW50ID0gcG9pbnQ7CiAgICB9CgogICAgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZS51cGRhdGVUcmFuc2Zvcm0uY2FsbCggdGhpcyApOwp9OwoKUElYSS5Sb3BlLnByb3RvdHlwZS5zZXRUZXh0dXJlID0gZnVuY3Rpb24odGV4dHVyZSkKewogICAgLy8gc3RvcCBjdXJyZW50IHRleHR1cmUKICAgIHRoaXMudGV4dHVyZSA9IHRleHR1cmU7CiAgICB0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vCiAqLwoKLyoqCiAqIEEgdGlsaW5nIHNwcml0ZSBpcyBhIGZhc3Qgd2F5IG9mIHJlbmRlcmluZyBhIHRpbGluZyBpbWFnZQogKgogKiBAY2xhc3MgVGlsaW5nU3ByaXRlCiAqIEBleHRlbmRzIERpc3BsYXlPYmplY3RDb250YWluZXIKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB0ZXh0dXJlIHtUZXh0dXJlfSB0aGUgdGV4dHVyZSBvZiB0aGUgdGlsaW5nIHNwcml0ZQogKiBAcGFyYW0gd2lkdGgge051bWJlcn0gIHRoZSB3aWR0aCBvZiB0aGUgdGlsaW5nIHNwcml0ZQogKiBAcGFyYW0gaGVpZ2h0IHtOdW1iZXJ9IHRoZSBoZWlnaHQgb2YgdGhlIHRpbGluZyBzcHJpdGUKICovClBJWEkuVGlsaW5nU3ByaXRlID0gZnVuY3Rpb24odGV4dHVyZSwgd2lkdGgsIGhlaWdodCkKewogICAgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwoIHRoaXMgKTsKCiAgICAvKioKICAgICAqIFRoZSB0ZXh0dXJlIHRoYXQgdGhlIHNwcml0ZSBpcyB1c2luZwogICAgICoKICAgICAqIEBwcm9wZXJ0eSB0ZXh0dXJlCiAgICAgKiBAdHlwZSBUZXh0dXJlCiAgICAgKi8KICAgIHRoaXMudGV4dHVyZSA9IHRleHR1cmU7CgogICAgLyoqCiAgICAgKiBUaGUgd2lkdGggb2YgdGhlIHRpbGluZyBzcHJpdGUKICAgICAqCiAgICAgKiBAcHJvcGVydHkgd2lkdGgKICAgICAqIEB0eXBlIE51bWJlcgogICAgICovCiAgICB0aGlzLndpZHRoID0gd2lkdGg7CgogICAgLyoqCiAgICAgKiBUaGUgaGVpZ2h0IG9mIHRoZSB0aWxpbmcgc3ByaXRlCiAgICAgKgogICAgICogQHByb3BlcnR5IGhlaWdodAogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKi8KICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgIC8qKgogICAgICogVGhlIHNjYWxpbmcgb2YgdGhlIGltYWdlIHRoYXQgaXMgYmVpbmcgdGlsZWQKICAgICAqCiAgICAgKiBAcHJvcGVydHkgdGlsZVNjYWxlCiAgICAgKiBAdHlwZSBQb2ludAogICAgICovCiAgICB0aGlzLnRpbGVTY2FsZSA9IG5ldyBQSVhJLlBvaW50KDEsMSk7CgogICAgLyoqCiAgICAgKiBUaGUgb2Zmc2V0IHBvc2l0aW9uIG9mIHRoZSBpbWFnZSB0aGF0IGlzIGJlaW5nIHRpbGVkCiAgICAgKgogICAgICogQHByb3BlcnR5IHRpbGVQb3NpdGlvbgogICAgICogQHR5cGUgUG9pbnQKICAgICAqLwogICAgdGhpcy50aWxlUG9zaXRpb24gPSBuZXcgUElYSS5Qb2ludCgwLDApOwoKICAgIHRoaXMucmVuZGVyYWJsZSA9IHRydWU7CgogICAgdGhpcy5ibGVuZE1vZGUgPSBQSVhJLmJsZW5kTW9kZXMuTk9STUFMOwp9OwoKLy8gY29uc3RydWN0b3IKUElYSS5UaWxpbmdTcHJpdGUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZSApOwpQSVhJLlRpbGluZ1Nwcml0ZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlRpbGluZ1Nwcml0ZTsKCi8qKgogKiBTZXRzIHRoZSB0ZXh0dXJlIG9mIHRoZSB0aWxpbmcgc3ByaXRlCiAqCiAqIEBtZXRob2Qgc2V0VGV4dHVyZQogKiBAcGFyYW0gdGV4dHVyZSB7VGV4dHVyZX0gVGhlIFBJWEkgdGV4dHVyZSB0aGF0IGlzIGRpc3BsYXllZCBieSB0aGUgc3ByaXRlCiAqLwpQSVhJLlRpbGluZ1Nwcml0ZS5wcm90b3R5cGUuc2V0VGV4dHVyZSA9IGZ1bmN0aW9uKHRleHR1cmUpCnsKICAgIC8vVE9ETyBTRVQgVEhFIFRFWFRVUkVTCiAgICAvL1RPRE8gVklTSUJJTElUWQoKICAgIC8vIHN0b3AgY3VycmVudCB0ZXh0dXJlCiAgICB0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwogICAgdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cn07CgovKioKICogV2hlbiB0aGUgdGV4dHVyZSBpcyB1cGRhdGVkLCB0aGlzIGV2ZW50IHdpbGwgZmlyZSB0byB1cGRhdGUgdGhlIGZyYW1lCiAqCiAqIEBtZXRob2Qgb25UZXh0dXJlVXBkYXRlCiAqIEBwYXJhbSBldmVudAogKiBAcHJpdmF0ZQogKi8KUElYSS5UaWxpbmdTcHJpdGUucHJvdG90eXBlLm9uVGV4dHVyZVVwZGF0ZSA9IGZ1bmN0aW9uKCkKewogICAgdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cn07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIFRoaXMgaXMgdGhlIGJhc2UgY2xhc3MgZm9yICBjcmVhdGluZyBhIHBpeGkuanMgZmlsdGVyLiBDdXJyZW50bHkgb25seSB3ZWJHTCBzdXBwb3J0cyBmaWx0ZXJzLgogKiBJZiB5b3Ugd2FudCB0byBtYWtlIGEgY3VzdG9tIGZpbHRlciB0aGlzIHNob3VsZCBiZSB5b3VyIGJhc2UgY2xhc3MuCiAqIEBjbGFzcyBBYnN0cmFjdEZpbHRlcgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIGZyYWdtZW50U3JjCiAqIEBwYXJhbSB1bmlmb3JtcwogKi8KUElYSS5BYnN0cmFjdEZpbHRlciA9IGZ1bmN0aW9uKGZyYWdtZW50U3JjLCB1bmlmb3JtcykKewogICAgLyoqCiAgICAqIEFuIGFycmF5IG9mIHBhc3NlcyAtIHNvbWUgZmlsdGVycyBjb250YWluIGEgZmV3IHN0ZXBzIHRoaXMgYXJyYXkgc2ltcGx5IHN0b3JlcyB0aGUgc3RlcHMgaW4gYSBsaW5pZWFyIGZhc2hpb24uCiAgICAqIEZvciBleGFtcGxlIHRoZSBibHVyIGZpbHRlciBoYXMgdHdvIHBhc3NlcyBibHVyWCBhbmQgYmx1clkuCiAgICAqIEBwcm9wZXJ0eSBwYXNzZXMKICAgICogQHR5cGUgQXJyYXkgYW4gYXJyYXkgb2YgZmlsdGVyIG9iamVjdHMKICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLnBhc3NlcyA9IFt0aGlzXTsKCgogICAgdGhpcy5kaXJ0eSA9IHRydWU7CiAgICB0aGlzLnBhZGRpbmcgPSAwOwoKICAgIC8qKgogICAgQHByb3BlcnR5IHVuaWZvcm1zCiAgICBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMudW5pZm9ybXMgPSB1bmlmb3JtcyB8fCB7fTsKCiAgICB0aGlzLmZyYWdtZW50U3JjID0gZnJhZ21lbnRTcmMgfHwgW107Cn07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKCgpQSVhJLkZpbHRlckJsb2NrID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLnZpc2libGUgPSB0cnVlOwogICAgdGhpcy5yZW5kZXJhYmxlID0gdHJ1ZTsKfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKLyoqCiAqIFRoZSBHcmFwaGljcyBjbGFzcyBjb250YWlucyBhIHNldCBvZiBtZXRob2RzIHRoYXQgeW91IGNhbiB1c2UgdG8gY3JlYXRlIHByaW1pdGl2ZSBzaGFwZXMgYW5kIGxpbmVzLgogKiBJdCBpcyBpbXBvcnRhbnQgdG8ga25vdyB0aGF0IHdpdGggdGhlIHdlYkdMIHJlbmRlcmVyIG9ubHkgc2ltcGxlIHBvbHlzIGNhbiBiZSBmaWxsZWQgYXQgdGhpcyBzdGFnZQogKiBDb21wbGV4IHBvbHlzIHdpbGwgbm90IGJlIGZpbGxlZC4gSGVyZXMgYW4gZXhhbXBsZSBvZiBhIGNvbXBsZXggcG9seTogaHR0cDovL3d3dy5nb29kYm95ZGlnaXRhbC5jb20vd3AtY29udGVudC91cGxvYWRzLzIwMTMvMDYvY29tcGxleFBvbHlnb24ucG5nCiAqCiAqIEBjbGFzcyBHcmFwaGljcwogKiBAZXh0ZW5kcyBEaXNwbGF5T2JqZWN0Q29udGFpbmVyCiAqIEBjb25zdHJ1Y3RvcgogKi8KUElYSS5HcmFwaGljcyA9IGZ1bmN0aW9uKCkKewogICAgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwoIHRoaXMgKTsKCiAgICB0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwoKICAgIC8qKgogICAgICogVGhlIGFscGhhIG9mIHRoZSBmaWxsIG9mIHRoaXMgZ3JhcGhpY3Mgb2JqZWN0CiAgICAgKgogICAgICogQHByb3BlcnR5IGZpbGxBbHBoYQogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKi8KICAgIHRoaXMuZmlsbEFscGhhID0gMTsKCiAgICAvKioKICAgICAqIFRoZSB3aWR0aCBvZiBhbnkgbGluZXMgZHJhd24KICAgICAqCiAgICAgKiBAcHJvcGVydHkgbGluZVdpZHRoCiAgICAgKiBAdHlwZSBOdW1iZXIKICAgICAqLwogICAgdGhpcy5saW5lV2lkdGggPSAwOwoKICAgIC8qKgogICAgICogVGhlIGNvbG9yIG9mIGFueSBsaW5lcyBkcmF3bgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBsaW5lQ29sb3IKICAgICAqIEB0eXBlIFN0cmluZwogICAgICovCiAgICB0aGlzLmxpbmVDb2xvciA9ICJibGFjayI7CgogICAgLyoqCiAgICAgKiBHcmFwaGljcyBkYXRhCiAgICAgKgogICAgICogQHByb3BlcnR5IGdyYXBoaWNzRGF0YQogICAgICogQHR5cGUgQXJyYXkKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHRoaXMuZ3JhcGhpY3NEYXRhID0gW107CgogICAgLyoqCiAgICAgKiBDdXJyZW50IHBhdGgKICAgICAqCiAgICAgKiBAcHJvcGVydHkgY3VycmVudFBhdGgKICAgICAqIEB0eXBlIE9iamVjdAogICAgICogQHByaXZhdGUKICAgICAqLwogICAgdGhpcy5jdXJyZW50UGF0aCA9IHtwb2ludHM6W119Owp9OwoKLy8gY29uc3RydWN0b3IKUElYSS5HcmFwaGljcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlICk7ClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5HcmFwaGljczsKCi8qKgogKiBTcGVjaWZpZXMgYSBsaW5lIHN0eWxlIHVzZWQgZm9yIHN1YnNlcXVlbnQgY2FsbHMgdG8gR3JhcGhpY3MgbWV0aG9kcyBzdWNoIGFzIHRoZSBsaW5lVG8oKSBtZXRob2Qgb3IgdGhlIGRyYXdDaXJjbGUoKSBtZXRob2QuCiAqCiAqIEBtZXRob2QgbGluZVN0eWxlCiAqIEBwYXJhbSBsaW5lV2lkdGgge051bWJlcn0gd2lkdGggb2YgdGhlIGxpbmUgdG8gZHJhdywgd2lsbCB1cGRhdGUgdGhlIG9iamVjdCdzIHN0b3JlZCBzdHlsZQogKiBAcGFyYW0gY29sb3Ige051bWJlcn0gY29sb3Igb2YgdGhlIGxpbmUgdG8gZHJhdywgd2lsbCB1cGRhdGUgdGhlIG9iamVjdCdzIHN0b3JlZCBzdHlsZQogKiBAcGFyYW0gYWxwaGEge051bWJlcn0gYWxwaGEgb2YgdGhlIGxpbmUgdG8gZHJhdywgd2lsbCB1cGRhdGUgdGhlIG9iamVjdCdzIHN0b3JlZCBzdHlsZQogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUubGluZVN0eWxlID0gZnVuY3Rpb24obGluZVdpZHRoLCBjb2xvciwgYWxwaGEpCnsKICAgIGlmICghdGhpcy5jdXJyZW50UGF0aC5wb2ludHMubGVuZ3RoKSB0aGlzLmdyYXBoaWNzRGF0YS5wb3AoKTsKCiAgICB0aGlzLmxpbmVXaWR0aCA9IGxpbmVXaWR0aCB8fCAwOwogICAgdGhpcy5saW5lQ29sb3IgPSBjb2xvciB8fCAwOwogICAgdGhpcy5saW5lQWxwaGEgPSAoYXJndW1lbnRzLmxlbmd0aCA8IDMpID8gMSA6IGFscGhhOwoKICAgIHRoaXMuY3VycmVudFBhdGggPSB7bGluZVdpZHRoOnRoaXMubGluZVdpZHRoLCBsaW5lQ29sb3I6dGhpcy5saW5lQ29sb3IsIGxpbmVBbHBoYTp0aGlzLmxpbmVBbHBoYSwKICAgICAgICAgICAgICAgICAgICAgICAgZmlsbENvbG9yOnRoaXMuZmlsbENvbG9yLCBmaWxsQWxwaGE6dGhpcy5maWxsQWxwaGEsIGZpbGw6dGhpcy5maWxsaW5nLCBwb2ludHM6W10sIHR5cGU6UElYSS5HcmFwaGljcy5QT0xZfTsKCiAgICB0aGlzLmdyYXBoaWNzRGF0YS5wdXNoKHRoaXMuY3VycmVudFBhdGgpOwp9OwoKLyoqCiAqIE1vdmVzIHRoZSBjdXJyZW50IGRyYXdpbmcgcG9zaXRpb24gdG8gKHgsIHkpLgogKgogKiBAbWV0aG9kIG1vdmVUbwogKiBAcGFyYW0geCB7TnVtYmVyfSB0aGUgWCBjb29yZCB0byBtb3ZlIHRvCiAqIEBwYXJhbSB5IHtOdW1iZXJ9IHRoZSBZIGNvb3JkIHRvIG1vdmUgdG8KICovClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLm1vdmVUbyA9IGZ1bmN0aW9uKHgsIHkpCnsKICAgIGlmICghdGhpcy5jdXJyZW50UGF0aC5wb2ludHMubGVuZ3RoKSB0aGlzLmdyYXBoaWNzRGF0YS5wb3AoKTsKCiAgICB0aGlzLmN1cnJlbnRQYXRoID0gdGhpcy5jdXJyZW50UGF0aCA9IHtsaW5lV2lkdGg6dGhpcy5saW5lV2lkdGgsIGxpbmVDb2xvcjp0aGlzLmxpbmVDb2xvciwgbGluZUFscGhhOnRoaXMubGluZUFscGhhLAogICAgICAgICAgICAgICAgICAgICAgICBmaWxsQ29sb3I6dGhpcy5maWxsQ29sb3IsIGZpbGxBbHBoYTp0aGlzLmZpbGxBbHBoYSwgZmlsbDp0aGlzLmZpbGxpbmcsIHBvaW50czpbXSwgdHlwZTpQSVhJLkdyYXBoaWNzLlBPTFl9OwoKICAgIHRoaXMuY3VycmVudFBhdGgucG9pbnRzLnB1c2goeCwgeSk7CgogICAgdGhpcy5ncmFwaGljc0RhdGEucHVzaCh0aGlzLmN1cnJlbnRQYXRoKTsKfTsKCi8qKgogKiBEcmF3cyBhIGxpbmUgdXNpbmcgdGhlIGN1cnJlbnQgbGluZSBzdHlsZSBmcm9tIHRoZSBjdXJyZW50IGRyYXdpbmcgcG9zaXRpb24gdG8gKHgsIHkpOwogKiB0aGUgY3VycmVudCBkcmF3aW5nIHBvc2l0aW9uIGlzIHRoZW4gc2V0IHRvICh4LCB5KS4KICoKICogQG1ldGhvZCBsaW5lVG8KICogQHBhcmFtIHgge051bWJlcn0gdGhlIFggY29vcmQgdG8gZHJhdyB0bwogKiBAcGFyYW0geSB7TnVtYmVyfSB0aGUgWSBjb29yZCB0byBkcmF3IHRvCiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5saW5lVG8gPSBmdW5jdGlvbih4LCB5KQp7CiAgICB0aGlzLmN1cnJlbnRQYXRoLnBvaW50cy5wdXNoKHgsIHkpOwogICAgdGhpcy5kaXJ0eSA9IHRydWU7Cn07CgovKioKICogU3BlY2lmaWVzIGEgc2ltcGxlIG9uZS1jb2xvciBmaWxsIHRoYXQgc3Vic2VxdWVudCBjYWxscyB0byBvdGhlciBHcmFwaGljcyBtZXRob2RzCiAqIChzdWNoIGFzIGxpbmVUbygpIG9yIGRyYXdDaXJjbGUoKSkgdXNlIHdoZW4gZHJhd2luZy4KICoKICogQG1ldGhvZCBiZWdpbkZpbGwKICogQHBhcmFtIGNvbG9yIHt1aW50fSB0aGUgY29sb3Igb2YgdGhlIGZpbGwKICogQHBhcmFtIGFscGhhIHtOdW1iZXJ9IHRoZSBhbHBoYQogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUuYmVnaW5GaWxsID0gZnVuY3Rpb24oY29sb3IsIGFscGhhKQp7CiAgICB0aGlzLmZpbGxpbmcgPSB0cnVlOwogICAgdGhpcy5maWxsQ29sb3IgPSBjb2xvciB8fCAwOwogICAgdGhpcy5maWxsQWxwaGEgPSAoYXJndW1lbnRzLmxlbmd0aCA8IDIpID8gMSA6IGFscGhhOwp9OwoKLyoqCiAqIEFwcGxpZXMgYSBmaWxsIHRvIHRoZSBsaW5lcyBhbmQgc2hhcGVzIHRoYXQgd2VyZSBhZGRlZCBzaW5jZSB0aGUgbGFzdCBjYWxsIHRvIHRoZSBiZWdpbkZpbGwoKSBtZXRob2QuCiAqCiAqIEBtZXRob2QgZW5kRmlsbAogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUuZW5kRmlsbCA9IGZ1bmN0aW9uKCkKewogICAgdGhpcy5maWxsaW5nID0gZmFsc2U7CiAgICB0aGlzLmZpbGxDb2xvciA9IG51bGw7CiAgICB0aGlzLmZpbGxBbHBoYSA9IDE7Cn07CgovKioKICogQG1ldGhvZCBkcmF3UmVjdAogKgogKiBAcGFyYW0geCB7TnVtYmVyfSBUaGUgWCBjb29yZCBvZiB0aGUgdG9wLWxlZnQgb2YgdGhlIHJlY3RhbmdsZQogKiBAcGFyYW0geSB7TnVtYmVyfSBUaGUgWSBjb29yZCBvZiB0aGUgdG9wLWxlZnQgb2YgdGhlIHJlY3RhbmdsZQogKiBAcGFyYW0gd2lkdGgge051bWJlcn0gVGhlIHdpZHRoIG9mIHRoZSByZWN0YW5nbGUKICogQHBhcmFtIGhlaWdodCB7TnVtYmVyfSBUaGUgaGVpZ2h0IG9mIHRoZSByZWN0YW5nbGUKICovClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLmRyYXdSZWN0ID0gZnVuY3Rpb24oIHgsIHksIHdpZHRoLCBoZWlnaHQgKQp7CiAgICBpZiAoIXRoaXMuY3VycmVudFBhdGgucG9pbnRzLmxlbmd0aCkgdGhpcy5ncmFwaGljc0RhdGEucG9wKCk7CgogICAgdGhpcy5jdXJyZW50UGF0aCA9IHtsaW5lV2lkdGg6dGhpcy5saW5lV2lkdGgsIGxpbmVDb2xvcjp0aGlzLmxpbmVDb2xvciwgbGluZUFscGhhOnRoaXMubGluZUFscGhhLAogICAgICAgICAgICAgICAgICAgICAgICBmaWxsQ29sb3I6dGhpcy5maWxsQ29sb3IsIGZpbGxBbHBoYTp0aGlzLmZpbGxBbHBoYSwgZmlsbDp0aGlzLmZpbGxpbmcsCiAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50czpbeCwgeSwgd2lkdGgsIGhlaWdodF0sIHR5cGU6UElYSS5HcmFwaGljcy5SRUNUfTsKCiAgICB0aGlzLmdyYXBoaWNzRGF0YS5wdXNoKHRoaXMuY3VycmVudFBhdGgpOwogICAgdGhpcy5kaXJ0eSA9IHRydWU7Cn07CgovKioKICogRHJhd3MgYSBjaXJjbGUuCiAqCiAqIEBtZXRob2QgZHJhd0NpcmNsZQogKiBAcGFyYW0geCB7TnVtYmVyfSBUaGUgWCBjb29yZCBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUKICogQHBhcmFtIHkge051bWJlcn0gVGhlIFkgY29vcmQgb2YgdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlCiAqIEBwYXJhbSByYWRpdXMge051bWJlcn0gVGhlIHJhZGl1cyBvZiB0aGUgY2lyY2xlCiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5kcmF3Q2lyY2xlID0gZnVuY3Rpb24oIHgsIHksIHJhZGl1cykKewogICAgaWYgKCF0aGlzLmN1cnJlbnRQYXRoLnBvaW50cy5sZW5ndGgpIHRoaXMuZ3JhcGhpY3NEYXRhLnBvcCgpOwoKICAgIHRoaXMuY3VycmVudFBhdGggPSB7bGluZVdpZHRoOnRoaXMubGluZVdpZHRoLCBsaW5lQ29sb3I6dGhpcy5saW5lQ29sb3IsIGxpbmVBbHBoYTp0aGlzLmxpbmVBbHBoYSwKICAgICAgICAgICAgICAgICAgICAgICAgZmlsbENvbG9yOnRoaXMuZmlsbENvbG9yLCBmaWxsQWxwaGE6dGhpcy5maWxsQWxwaGEsIGZpbGw6dGhpcy5maWxsaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBwb2ludHM6W3gsIHksIHJhZGl1cywgcmFkaXVzXSwgdHlwZTpQSVhJLkdyYXBoaWNzLkNJUkN9OwoKICAgIHRoaXMuZ3JhcGhpY3NEYXRhLnB1c2godGhpcy5jdXJyZW50UGF0aCk7CiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKfTsKCi8qKgogKiBEcmF3cyBhbiBlbGxpcHNlLgogKgogKiBAbWV0aG9kIGRyYXdFbGxpcHNlCiAqIEBwYXJhbSB4IHtOdW1iZXJ9CiAqIEBwYXJhbSB5IHtOdW1iZXJ9CiAqIEBwYXJhbSB3aWR0aCB7TnVtYmVyfQogKiBAcGFyYW0gaGVpZ2h0IHtOdW1iZXJ9CiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5kcmF3RWxsaXBzZSA9IGZ1bmN0aW9uKCB4LCB5LCB3aWR0aCwgaGVpZ2h0KQp7CiAgICBpZiAoIXRoaXMuY3VycmVudFBhdGgucG9pbnRzLmxlbmd0aCkgdGhpcy5ncmFwaGljc0RhdGEucG9wKCk7CgogICAgdGhpcy5jdXJyZW50UGF0aCA9IHtsaW5lV2lkdGg6dGhpcy5saW5lV2lkdGgsIGxpbmVDb2xvcjp0aGlzLmxpbmVDb2xvciwgbGluZUFscGhhOnRoaXMubGluZUFscGhhLAogICAgICAgICAgICAgICAgICAgICAgICBmaWxsQ29sb3I6dGhpcy5maWxsQ29sb3IsIGZpbGxBbHBoYTp0aGlzLmZpbGxBbHBoYSwgZmlsbDp0aGlzLmZpbGxpbmcsCiAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50czpbeCwgeSwgd2lkdGgsIGhlaWdodF0sIHR5cGU6UElYSS5HcmFwaGljcy5FTElQfTsKCiAgICB0aGlzLmdyYXBoaWNzRGF0YS5wdXNoKHRoaXMuY3VycmVudFBhdGgpOwogICAgdGhpcy5kaXJ0eSA9IHRydWU7Cn07CgovKioKICogQ2xlYXJzIHRoZSBncmFwaGljcyB0aGF0IHdlcmUgZHJhd24gdG8gdGhpcyBHcmFwaGljcyBvYmplY3QsIGFuZCByZXNldHMgZmlsbCBhbmQgbGluZSBzdHlsZSBzZXR0aW5ncy4KICoKICogQG1ldGhvZCBjbGVhcgogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbigpCnsKICAgIHRoaXMubGluZVdpZHRoID0gMDsKICAgIHRoaXMuZmlsbGluZyA9IGZhbHNlOwoKICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgdGhpcy5jbGVhckRpcnR5ID0gdHJ1ZTsKICAgIHRoaXMuZ3JhcGhpY3NEYXRhID0gW107CgogICAgdGhpcy5ib3VuZHMgPSBudWxsOyAvL25ldyBQSVhJLlJlY3RhbmdsZSgpOwp9OwoKClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLnVwZGF0ZUZpbHRlckJvdW5kcyA9IGZ1bmN0aW9uKCkKewogICAgaWYoIXRoaXMuYm91bmRzKQogICAgewogICAgICAgIHZhciBtaW5YID0gSW5maW5pdHk7CiAgICAgICAgdmFyIG1heFggPSAtSW5maW5pdHk7CgogICAgICAgIHZhciBtaW5ZID0gSW5maW5pdHk7CiAgICAgICAgdmFyIG1heFkgPSAtSW5maW5pdHk7CgogICAgICAgIHZhciBwb2ludHMsIHgsIHk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5ncmFwaGljc0RhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmdyYXBoaWNzRGF0YVtpXTsKICAgICAgICAgICAgdmFyIHR5cGUgPSBkYXRhLnR5cGU7CiAgICAgICAgICAgIHZhciBsaW5lV2lkdGggPSBkYXRhLmxpbmVXaWR0aDsKCiAgICAgICAgICAgIHBvaW50cyA9IGRhdGEucG9pbnRzOwoKICAgICAgICAgICAgaWYodHlwZSA9PT0gUElYSS5HcmFwaGljcy5SRUNUKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB4ID0gcG9pbnRzLnggLSBsaW5lV2lkdGgvMjsKICAgICAgICAgICAgICAgIHkgPSBwb2ludHMueSAtIGxpbmVXaWR0aC8yOwogICAgICAgICAgICAgICAgdmFyIHdpZHRoID0gcG9pbnRzLndpZHRoICsgbGluZVdpZHRoOwogICAgICAgICAgICAgICAgdmFyIGhlaWdodCA9IHBvaW50cy5oZWlnaHQgKyBsaW5lV2lkdGg7CgogICAgICAgICAgICAgICAgbWluWCA9IHggPCBtaW5YID8geCA6IG1pblg7CiAgICAgICAgICAgICAgICBtYXhYID0geCArIHdpZHRoID4gbWF4WCA/IHggKyB3aWR0aCA6IG1heFg7CgogICAgICAgICAgICAgICAgbWluWSA9IHkgPCBtaW5ZID8geCA6IG1pblk7CiAgICAgICAgICAgICAgICBtYXhZID0geSArIGhlaWdodCA+IG1heFkgPyB5ICsgaGVpZ2h0IDogbWF4WTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmKHR5cGUgPT09IFBJWEkuR3JhcGhpY3MuQ0lSQyB8fCB0eXBlID09PSBQSVhJLkdyYXBoaWNzLkVMSVApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHggPSBwb2ludHMueDsKICAgICAgICAgICAgICAgIHkgPSBwb2ludHMueTsKICAgICAgICAgICAgICAgIHZhciByYWRpdXMgPSBwb2ludHMucmFkaXVzICsgbGluZVdpZHRoLzI7CgogICAgICAgICAgICAgICAgbWluWCA9IHggLSByYWRpdXMgPCBtaW5YID8geCAtIHJhZGl1cyA6IG1pblg7CiAgICAgICAgICAgICAgICBtYXhYID0geCArIHJhZGl1cyA+IG1heFggPyB4ICsgcmFkaXVzIDogbWF4WDsKCiAgICAgICAgICAgICAgICBtaW5ZID0geSAtIHJhZGl1cyA8IG1pblkgPyB5IC0gcmFkaXVzIDogbWluWTsKICAgICAgICAgICAgICAgIG1heFkgPSB5ICsgcmFkaXVzID4gbWF4WSA/IHkgKyByYWRpdXMgOiBtYXhZOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gUE9MWQogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBwb2ludHMubGVuZ3RoOyBqKz0yKQogICAgICAgICAgICAgICAgewoKICAgICAgICAgICAgICAgICAgICB4ID0gcG9pbnRzW2pdOwogICAgICAgICAgICAgICAgICAgIHkgPSBwb2ludHNbaisxXTsKCiAgICAgICAgICAgICAgICAgICAgbWluWCA9IHgtbGluZVdpZHRoIDwgbWluWCA/IHgtbGluZVdpZHRoIDogbWluWDsKICAgICAgICAgICAgICAgICAgICBtYXhYID0geCtsaW5lV2lkdGggPiBtYXhYID8geCtsaW5lV2lkdGggOiBtYXhYOwoKICAgICAgICAgICAgICAgICAgICBtaW5ZID0geS1saW5lV2lkdGggPCBtaW5ZID8geS1saW5lV2lkdGggOiBtaW5ZOwogICAgICAgICAgICAgICAgICAgIG1heFkgPSB5K2xpbmVXaWR0aCA+IG1heFkgPyB5K2xpbmVXaWR0aCA6IG1heFk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuYm91bmRzID0gbmV3IFBJWEkuUmVjdGFuZ2xlKG1pblgsIG1pblksIG1heFggLSBtaW5YLCBtYXhZIC0gbWluWSk7CiAgICB9Ci8vICBjb25zb2xlLmxvZyh0aGlzLmJvdW5kcyk7Cn07CgovLyBTT01FIFRZUEVTOgpQSVhJLkdyYXBoaWNzLlBPTFkgPSAwOwpQSVhJLkdyYXBoaWNzLlJFQ1QgPSAxOwpQSVhJLkdyYXBoaWNzLkNJUkMgPSAyOwpQSVhJLkdyYXBoaWNzLkVMSVAgPSAzOwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgovKioKICogQSBzZXQgb2YgZnVuY3Rpb25zIHVzZWQgYnkgdGhlIGNhbnZhcyByZW5kZXJlciB0byBkcmF3IHRoZSBwcmltaXRpdmUgZ3JhcGhpY3MgZGF0YQogKgogKiBAY2xhc3MgQ2FudmFzR3JhcGhpY3MKICovClBJWEkuQ2FudmFzR3JhcGhpY3MgPSBmdW5jdGlvbigpCnsKCn07CgoKLyoKICogUmVuZGVycyB0aGUgZ3JhcGhpY3Mgb2JqZWN0CiAqCiAqIEBzdGF0aWMKICogQHByaXZhdGUKICogQG1ldGhvZCByZW5kZXJHcmFwaGljcwogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKiBAcGFyYW0gY29udGV4dCB7Q29udGV4dDJEfQogKi8KUElYSS5DYW52YXNHcmFwaGljcy5yZW5kZXJHcmFwaGljcyA9IGZ1bmN0aW9uKGdyYXBoaWNzLCBjb250ZXh0KQp7CiAgICB2YXIgd29ybGRBbHBoYSA9IGdyYXBoaWNzLndvcmxkQWxwaGE7CiAgICB2YXIgY29sb3IgPSAnJzsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGdyYXBoaWNzLmdyYXBoaWNzRGF0YS5sZW5ndGg7IGkrKykKICAgIHsKICAgICAgICB2YXIgZGF0YSA9IGdyYXBoaWNzLmdyYXBoaWNzRGF0YVtpXTsKICAgICAgICB2YXIgcG9pbnRzID0gZGF0YS5wb2ludHM7CgogICAgICAgIGNvbnRleHQuc3Ryb2tlU3R5bGUgPSBjb2xvciA9ICcjJyArICgnMDAwMDAnICsgKCBkYXRhLmxpbmVDb2xvciB8IDApLnRvU3RyaW5nKDE2KSkuc3Vic3RyKC02KTsKCiAgICAgICAgY29udGV4dC5saW5lV2lkdGggPSBkYXRhLmxpbmVXaWR0aDsKCiAgICAgICAgaWYoZGF0YS50eXBlID09PSBQSVhJLkdyYXBoaWNzLlBPTFkpCiAgICAgICAgewogICAgICAgICAgICBjb250ZXh0LmJlZ2luUGF0aCgpOwoKICAgICAgICAgICAgY29udGV4dC5tb3ZlVG8ocG9pbnRzWzBdLCBwb2ludHNbMV0pOwoKICAgICAgICAgICAgZm9yICh2YXIgaj0xOyBqIDwgcG9pbnRzLmxlbmd0aC8yOyBqKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQubGluZVRvKHBvaW50c1tqICogMl0sIHBvaW50c1tqICogMiArIDFdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgdGhlIGZpcnN0IGFuZCBsYXN0IHBvaW50IGFyZSB0aGUgc2FtZSBjbG9zZSB0aGUgcGF0aCAtIG11Y2ggbmVhdGVyIDopCiAgICAgICAgICAgIGlmKHBvaW50c1swXSA9PT0gcG9pbnRzW3BvaW50cy5sZW5ndGgtMl0gJiYgcG9pbnRzWzFdID09PSBwb2ludHNbcG9pbnRzLmxlbmd0aC0xXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoZGF0YS5maWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb250ZXh0Lmdsb2JhbEFscGhhID0gZGF0YS5maWxsQWxwaGEgKiB3b3JsZEFscGhhOwogICAgICAgICAgICAgICAgY29udGV4dC5maWxsU3R5bGUgPSBjb2xvciA9ICcjJyArICgnMDAwMDAnICsgKCBkYXRhLmZpbGxDb2xvciB8IDApLnRvU3RyaW5nKDE2KSkuc3Vic3RyKC02KTsKICAgICAgICAgICAgICAgIGNvbnRleHQuZmlsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGRhdGEubGluZVdpZHRoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb250ZXh0Lmdsb2JhbEFscGhhID0gZGF0YS5saW5lQWxwaGEgKiB3b3JsZEFscGhhOwogICAgICAgICAgICAgICAgY29udGV4dC5zdHJva2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmKGRhdGEudHlwZSA9PT0gUElYSS5HcmFwaGljcy5SRUNUKQogICAgICAgIHsKCiAgICAgICAgICAgIGlmKGRhdGEuZmlsbENvbG9yIHx8IGRhdGEuZmlsbENvbG9yID09PSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb250ZXh0Lmdsb2JhbEFscGhhID0gZGF0YS5maWxsQWxwaGEgKiB3b3JsZEFscGhhOwogICAgICAgICAgICAgICAgY29udGV4dC5maWxsU3R5bGUgPSBjb2xvciA9ICcjJyArICgnMDAwMDAnICsgKCBkYXRhLmZpbGxDb2xvciB8IDApLnRvU3RyaW5nKDE2KSkuc3Vic3RyKC02KTsKICAgICAgICAgICAgICAgIGNvbnRleHQuZmlsbFJlY3QocG9pbnRzWzBdLCBwb2ludHNbMV0sIHBvaW50c1syXSwgcG9pbnRzWzNdKTsKCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZGF0YS5saW5lV2lkdGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkYXRhLmxpbmVBbHBoYSAqIHdvcmxkQWxwaGE7CiAgICAgICAgICAgICAgICBjb250ZXh0LnN0cm9rZVJlY3QocG9pbnRzWzBdLCBwb2ludHNbMV0sIHBvaW50c1syXSwgcG9pbnRzWzNdKTsKICAgICAgICAgICAgfQoKICAgICAgICB9CiAgICAgICAgZWxzZSBpZihkYXRhLnR5cGUgPT09IFBJWEkuR3JhcGhpY3MuQ0lSQykKICAgICAgICB7CiAgICAgICAgICAgIC8vIFRPRE8gLSBuZWVkIHRvIGJlIFVuZGVmaW5lZCEKICAgICAgICAgICAgY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY29udGV4dC5hcmMocG9pbnRzWzBdLCBwb2ludHNbMV0sIHBvaW50c1syXSwwLDIqTWF0aC5QSSk7CiAgICAgICAgICAgIGNvbnRleHQuY2xvc2VQYXRoKCk7CgogICAgICAgICAgICBpZihkYXRhLmZpbGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkYXRhLmZpbGxBbHBoYSAqIHdvcmxkQWxwaGE7CiAgICAgICAgICAgICAgICBjb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yID0gJyMnICsgKCcwMDAwMCcgKyAoIGRhdGEuZmlsbENvbG9yIHwgMCkudG9TdHJpbmcoMTYpKS5zdWJzdHIoLTYpOwogICAgICAgICAgICAgICAgY29udGV4dC5maWxsKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZGF0YS5saW5lV2lkdGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkYXRhLmxpbmVBbHBoYSAqIHdvcmxkQWxwaGE7CiAgICAgICAgICAgICAgICBjb250ZXh0LnN0cm9rZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoZGF0YS50eXBlID09PSBQSVhJLkdyYXBoaWNzLkVMSVApCiAgICAgICAgewoKICAgICAgICAgICAgLy8gZWxsaXBzZSBjb2RlIHRha2VuIGZyb206IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMjE3Mjc5OC9ob3ctdG8tZHJhdy1hbi1vdmFsLWluLWh0bWw1LWNhbnZhcwoKICAgICAgICAgICAgdmFyIGVsbGlwc2VEYXRhID0gIGRhdGEucG9pbnRzOwoKICAgICAgICAgICAgdmFyIHcgPSBlbGxpcHNlRGF0YVsyXSAqIDI7CiAgICAgICAgICAgIHZhciBoID0gZWxsaXBzZURhdGFbM10gKiAyOwoKICAgICAgICAgICAgdmFyIHggPSBlbGxpcHNlRGF0YVswXSAtIHcvMjsKICAgICAgICAgICAgdmFyIHkgPSBlbGxpcHNlRGF0YVsxXSAtIGgvMjsKCiAgICAgICAgICAgIGNvbnRleHQuYmVnaW5QYXRoKCk7CgogICAgICAgICAgICB2YXIga2FwcGEgPSAwLjU1MjI4NDgsCiAgICAgICAgICAgICAgICBveCA9ICh3IC8gMikgKiBrYXBwYSwgLy8gY29udHJvbCBwb2ludCBvZmZzZXQgaG9yaXpvbnRhbAogICAgICAgICAgICAgICAgb3kgPSAoaCAvIDIpICoga2FwcGEsIC8vIGNvbnRyb2wgcG9pbnQgb2Zmc2V0IHZlcnRpY2FsCiAgICAgICAgICAgICAgICB4ZSA9IHggKyB3LCAgICAgICAgICAgLy8geC1lbmQKICAgICAgICAgICAgICAgIHllID0geSArIGgsICAgICAgICAgICAvLyB5LWVuZAogICAgICAgICAgICAgICAgeG0gPSB4ICsgdyAvIDIsICAgICAgIC8vIHgtbWlkZGxlCiAgICAgICAgICAgICAgICB5bSA9IHkgKyBoIC8gMjsgICAgICAgLy8geS1taWRkbGUKCiAgICAgICAgICAgIGNvbnRleHQubW92ZVRvKHgsIHltKTsKICAgICAgICAgICAgY29udGV4dC5iZXppZXJDdXJ2ZVRvKHgsIHltIC0gb3ksIHhtIC0gb3gsIHksIHhtLCB5KTsKICAgICAgICAgICAgY29udGV4dC5iZXppZXJDdXJ2ZVRvKHhtICsgb3gsIHksIHhlLCB5bSAtIG95LCB4ZSwgeW0pOwogICAgICAgICAgICBjb250ZXh0LmJlemllckN1cnZlVG8oeGUsIHltICsgb3ksIHhtICsgb3gsIHllLCB4bSwgeWUpOwogICAgICAgICAgICBjb250ZXh0LmJlemllckN1cnZlVG8oeG0gLSBveCwgeWUsIHgsIHltICsgb3ksIHgsIHltKTsKCiAgICAgICAgICAgIGNvbnRleHQuY2xvc2VQYXRoKCk7CgogICAgICAgICAgICBpZihkYXRhLmZpbGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkYXRhLmZpbGxBbHBoYSAqIHdvcmxkQWxwaGE7CiAgICAgICAgICAgICAgICBjb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yID0gJyMnICsgKCcwMDAwMCcgKyAoIGRhdGEuZmlsbENvbG9yIHwgMCkudG9TdHJpbmcoMTYpKS5zdWJzdHIoLTYpOwogICAgICAgICAgICAgICAgY29udGV4dC5maWxsKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZGF0YS5saW5lV2lkdGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkYXRhLmxpbmVBbHBoYSAqIHdvcmxkQWxwaGE7CiAgICAgICAgICAgICAgICBjb250ZXh0LnN0cm9rZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9OwoKLyoKICogUmVuZGVycyBhIGdyYXBoaWNzIG1hc2sKICoKICogQHN0YXRpYwogKiBAcHJpdmF0ZQogKiBAbWV0aG9kIHJlbmRlckdyYXBoaWNzTWFzawogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKiBAcGFyYW0gY29udGV4dCB7Q29udGV4dDJEfQogKi8KUElYSS5DYW52YXNHcmFwaGljcy5yZW5kZXJHcmFwaGljc01hc2sgPSBmdW5jdGlvbihncmFwaGljcywgY29udGV4dCkKewogICAgdmFyIGxlbiA9IGdyYXBoaWNzLmdyYXBoaWNzRGF0YS5sZW5ndGg7CgogICAgaWYobGVuID09PSAwKSByZXR1cm47CgogICAgaWYobGVuID4gMSkKICAgIHsKICAgICAgICBsZW4gPSAxOwogICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnUGl4aS5qcyB3YXJuaW5nOiBtYXNrcyBpbiBjYW52YXMgY2FuIG9ubHkgbWFzayB1c2luZyB0aGUgZmlyc3QgcGF0aCBpbiB0aGUgZ3JhcGhpY3Mgb2JqZWN0Jyk7CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCAxOyBpKyspCiAgICB7CiAgICAgICAgdmFyIGRhdGEgPSBncmFwaGljcy5ncmFwaGljc0RhdGFbaV07CiAgICAgICAgdmFyIHBvaW50cyA9IGRhdGEucG9pbnRzOwoKICAgICAgICBpZihkYXRhLnR5cGUgPT09IFBJWEkuR3JhcGhpY3MuUE9MWSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGNvbnRleHQubW92ZVRvKHBvaW50c1swXSwgcG9pbnRzWzFdKTsKCiAgICAgICAgICAgIGZvciAodmFyIGo9MTsgaiA8IHBvaW50cy5sZW5ndGgvMjsgaisrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb250ZXh0LmxpbmVUbyhwb2ludHNbaiAqIDJdLCBwb2ludHNbaiAqIDIgKyAxXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGlmIHRoZSBmaXJzdCBhbmQgbGFzdCBwb2ludCBhcmUgdGhlIHNhbWUgY2xvc2UgdGhlIHBhdGggLSBtdWNoIG5lYXRlciA6KQogICAgICAgICAgICBpZihwb2ludHNbMF0gPT09IHBvaW50c1twb2ludHMubGVuZ3RoLTJdICYmIHBvaW50c1sxXSA9PT0gcG9pbnRzW3BvaW50cy5sZW5ndGgtMV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQuY2xvc2VQYXRoKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoZGF0YS50eXBlID09PSBQSVhJLkdyYXBoaWNzLlJFQ1QpCiAgICAgICAgewogICAgICAgICAgICBjb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjb250ZXh0LnJlY3QocG9pbnRzWzBdLCBwb2ludHNbMV0sIHBvaW50c1syXSwgcG9pbnRzWzNdKTsKICAgICAgICAgICAgY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZihkYXRhLnR5cGUgPT09IFBJWEkuR3JhcGhpY3MuQ0lSQykKICAgICAgICB7CiAgICAgICAgICAgIC8vIFRPRE8gLSBuZWVkIHRvIGJlIFVuZGVmaW5lZCEKICAgICAgICAgICAgY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY29udGV4dC5hcmMocG9pbnRzWzBdLCBwb2ludHNbMV0sIHBvaW50c1syXSwwLDIqTWF0aC5QSSk7CiAgICAgICAgICAgIGNvbnRleHQuY2xvc2VQYXRoKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoZGF0YS50eXBlID09PSBQSVhJLkdyYXBoaWNzLkVMSVApCiAgICAgICAgewoKICAgICAgICAgICAgLy8gZWxsaXBzZSBjb2RlIHRha2VuIGZyb206IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMjE3Mjc5OC9ob3ctdG8tZHJhdy1hbi1vdmFsLWluLWh0bWw1LWNhbnZhcwogICAgICAgICAgICB2YXIgZWxsaXBzZURhdGEgPSAgZGF0YS5wb2ludHM7CgogICAgICAgICAgICB2YXIgdyA9IGVsbGlwc2VEYXRhWzJdICogMjsKICAgICAgICAgICAgdmFyIGggPSBlbGxpcHNlRGF0YVszXSAqIDI7CgogICAgICAgICAgICB2YXIgeCA9IGVsbGlwc2VEYXRhWzBdIC0gdy8yOwogICAgICAgICAgICB2YXIgeSA9IGVsbGlwc2VEYXRhWzFdIC0gaC8yOwoKICAgICAgICAgICAgY29udGV4dC5iZWdpblBhdGgoKTsKCiAgICAgICAgICAgIHZhciBrYXBwYSA9IDAuNTUyMjg0OCwKICAgICAgICAgICAgICAgIG94ID0gKHcgLyAyKSAqIGthcHBhLCAvLyBjb250cm9sIHBvaW50IG9mZnNldCBob3Jpem9udGFsCiAgICAgICAgICAgICAgICBveSA9IChoIC8gMikgKiBrYXBwYSwgLy8gY29udHJvbCBwb2ludCBvZmZzZXQgdmVydGljYWwKICAgICAgICAgICAgICAgIHhlID0geCArIHcsICAgICAgICAgICAvLyB4LWVuZAogICAgICAgICAgICAgICAgeWUgPSB5ICsgaCwgICAgICAgICAgIC8vIHktZW5kCiAgICAgICAgICAgICAgICB4bSA9IHggKyB3IC8gMiwgICAgICAgLy8geC1taWRkbGUKICAgICAgICAgICAgICAgIHltID0geSArIGggLyAyOyAgICAgICAvLyB5LW1pZGRsZQoKICAgICAgICAgICAgY29udGV4dC5tb3ZlVG8oeCwgeW0pOwogICAgICAgICAgICBjb250ZXh0LmJlemllckN1cnZlVG8oeCwgeW0gLSBveSwgeG0gLSBveCwgeSwgeG0sIHkpOwogICAgICAgICAgICBjb250ZXh0LmJlemllckN1cnZlVG8oeG0gKyBveCwgeSwgeGUsIHltIC0gb3ksIHhlLCB5bSk7CiAgICAgICAgICAgIGNvbnRleHQuYmV6aWVyQ3VydmVUbyh4ZSwgeW0gKyBveSwgeG0gKyBveCwgeWUsIHhtLCB5ZSk7CiAgICAgICAgICAgIGNvbnRleHQuYmV6aWVyQ3VydmVUbyh4bSAtIG94LCB5ZSwgeCwgeW0gKyBveSwgeCwgeW0pOwogICAgICAgICAgICBjb250ZXh0LmNsb3NlUGF0aCgpOwogICAgICAgIH0KICAgIH0KfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogdGhlIENhbnZhc1JlbmRlcmVyIGRyYXdzIHRoZSBzdGFnZSBhbmQgYWxsIGl0cyBjb250ZW50IG9udG8gYSAyZCBjYW52YXMuIFRoaXMgcmVuZGVyZXIgc2hvdWxkIGJlIHVzZWQgZm9yIGJyb3dzZXJzIHRoYXQgZG8gbm90IHN1cHBvcnQgd2ViR0wuCiAqIERvbnQgZm9yZ2V0IHRvIGFkZCB0aGUgdmlldyB0byB5b3VyIERPTSBvciB5b3Ugd2lsbCBub3Qgc2VlIGFueXRoaW5nIDopCiAqCiAqIEBjbGFzcyBDYW52YXNSZW5kZXJlcgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHdpZHRoPTAge051bWJlcn0gdGhlIHdpZHRoIG9mIHRoZSBjYW52YXMgdmlldwogKiBAcGFyYW0gaGVpZ2h0PTAge051bWJlcn0gdGhlIGhlaWdodCBvZiB0aGUgY2FudmFzIHZpZXcKICogQHBhcmFtIHZpZXcge0NhbnZhc30gdGhlIGNhbnZhcyB0byB1c2UgYXMgYSB2aWV3LCBvcHRpb25hbAogKiBAcGFyYW0gdHJhbnNwYXJlbnQ9ZmFsc2Uge0Jvb2xlYW59IHRoZSB0cmFuc3BhcmVuY3kgb2YgdGhlIHJlbmRlciB2aWV3LCBkZWZhdWx0IGZhbHNlCiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCwgdmlldywgdHJhbnNwYXJlbnQpCnsKICAgIHRoaXMudHJhbnNwYXJlbnQgPSB0cmFuc3BhcmVudDsKCiAgICAvKioKICAgICAqIFRoZSB3aWR0aCBvZiB0aGUgY2FudmFzIHZpZXcKICAgICAqCiAgICAgKiBAcHJvcGVydHkgd2lkdGgKICAgICAqIEB0eXBlIE51bWJlcgogICAgICogQGRlZmF1bHQgODAwCiAgICAgKi8KICAgIHRoaXMud2lkdGggPSB3aWR0aCB8fCA4MDA7CgogICAgLyoqCiAgICAgKiBUaGUgaGVpZ2h0IG9mIHRoZSBjYW52YXMgdmlldwogICAgICoKICAgICAqIEBwcm9wZXJ0eSBoZWlnaHQKICAgICAqIEB0eXBlIE51bWJlcgogICAgICogQGRlZmF1bHQgNjAwCiAgICAgKi8KICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IDYwMDsKCiAgICAvKioKICAgICAqIFRoZSBjYW52YXMgZWxlbWVudCB0aGF0IHRoZSBldmVyeXRoaW5nIGlzIGRyYXduIHRvCiAgICAgKgogICAgICogQHByb3BlcnR5IHZpZXcKICAgICAqIEB0eXBlIENhbnZhcwogICAgICovCiAgICB0aGlzLnZpZXcgPSB2aWV3IHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdjYW52YXMnICk7CgogICAgLyoqCiAgICAgKiBUaGUgY2FudmFzIGNvbnRleHQgdGhhdCB0aGUgZXZlcnl0aGluZyBpcyBkcmF3biB0bwogICAgICogQHByb3BlcnR5IGNvbnRleHQKICAgICAqIEB0eXBlIENhbnZhcyAyZCBDb250ZXh0CiAgICAgKi8KICAgIHRoaXMuY29udGV4dCA9IHRoaXMudmlldy5nZXRDb250ZXh0KCAnMmQnICk7CgogICAgLy9zb21lIGZpbHRlciB2YXJpYWJsZXMKICAgIHRoaXMuc21vb3RoUHJvcGVydHkgPSBudWxsOwoKICAgIGlmKCdpbWFnZVNtb290aGluZ0VuYWJsZWQnIGluIHRoaXMuY29udGV4dCkKICAgICAgICB0aGlzLnNtb290aFByb3BlcnR5ID0gJ2ltYWdlU21vb3RoaW5nRW5hYmxlZCc7CiAgICBlbHNlIGlmKCd3ZWJraXRJbWFnZVNtb290aGluZ0VuYWJsZWQnIGluIHRoaXMuY29udGV4dCkKICAgICAgICB0aGlzLnNtb290aFByb3BlcnR5ID0gJ3dlYmtpdEltYWdlU21vb3RoaW5nRW5hYmxlZCc7CiAgICBlbHNlIGlmKCdtb3pJbWFnZVNtb290aGluZ0VuYWJsZWQnIGluIHRoaXMuY29udGV4dCkKICAgICAgICB0aGlzLnNtb290aFByb3BlcnR5ID0gJ21vekltYWdlU21vb3RoaW5nRW5hYmxlZCc7CiAgICBlbHNlIGlmKCdvSW1hZ2VTbW9vdGhpbmdFbmFibGVkJyBpbiB0aGlzLmNvbnRleHQpCiAgICAgICAgdGhpcy5zbW9vdGhQcm9wZXJ0eSA9ICdvSW1hZ2VTbW9vdGhpbmdFbmFibGVkJzsKCiAgICB0aGlzLnNjYWxlTW9kZSA9IG51bGw7CgogICAgdGhpcy5yZWZyZXNoID0gdHJ1ZTsKICAgIC8vIGhhY2sgdG8gZW5hYmxlIHNvbWUgaGFyZHdhcmUgYWNjZWxlcmF0aW9uIQogICAgLy90aGlzLnZpZXcuc3R5bGVbInRyYW5zZm9ybSJdID0gInRyYW5zbGF0ZXooMCkiOwoKICAgIHRoaXMudmlldy53aWR0aCA9IHRoaXMud2lkdGg7CiAgICB0aGlzLnZpZXcuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CiAgICB0aGlzLmNvdW50ID0gMDsKfTsKCi8vIGNvbnN0cnVjdG9yClBJWEkuQ2FudmFzUmVuZGVyZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5DYW52YXNSZW5kZXJlcjsKCi8qKgogKiBSZW5kZXJzIHRoZSBzdGFnZSB0byBpdHMgY2FudmFzIHZpZXcKICoKICogQG1ldGhvZCByZW5kZXIKICogQHBhcmFtIHN0YWdlIHtTdGFnZX0gdGhlIFN0YWdlIGVsZW1lbnQgdG8gYmUgcmVuZGVyZWQKICovClBJWEkuQ2FudmFzUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKHN0YWdlKQp7CiAgICAvL3N0YWdlLl9fY2hpbGRyZW5BZGRlZCA9IFtdOwogICAgLy9zdGFnZS5fX2NoaWxkcmVuUmVtb3ZlZCA9IFtdOwoKICAgIC8vIHVwZGF0ZSB0ZXh0dXJlcyBpZiBuZWVkIGJlCiAgICBQSVhJLnRleHR1cmVzVG9VcGRhdGUgPSBbXTsKICAgIFBJWEkudGV4dHVyZXNUb0Rlc3Ryb3kgPSBbXTsKCiAgICBQSVhJLnZpc2libGVDb3VudCsrOwogICAgc3RhZ2UudXBkYXRlVHJhbnNmb3JtKCk7CgogICAgLy8gdXBkYXRlIHRoZSBiYWNrZ3JvdW5kIGNvbG9yCiAgICBpZih0aGlzLnZpZXcuc3R5bGUuYmFja2dyb3VuZENvbG9yICE9PSBzdGFnZS5iYWNrZ3JvdW5kQ29sb3JTdHJpbmcgJiYgIXRoaXMudHJhbnNwYXJlbnQpCiAgICAgICAgdGhpcy52aWV3LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IHN0YWdlLmJhY2tncm91bmRDb2xvclN0cmluZzsKCiAgICB0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKDEsMCwwLDEsMCwwKTsKICAgIHRoaXMuY29udGV4dC5jbGVhclJlY3QoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwogICAgdGhpcy5yZW5kZXJEaXNwbGF5T2JqZWN0KHN0YWdlKTsKICAgIC8vYXMKCiAgICAvLyBydW4gaW50ZXJhY3Rpb24hCiAgICBpZihzdGFnZS5pbnRlcmFjdGl2ZSkKICAgIHsKICAgICAgICAvL25lZWQgdG8gYWRkIHNvbWUgZXZlbnRzIQogICAgICAgIGlmKCFzdGFnZS5faW50ZXJhY3RpdmVFdmVudHNBZGRlZCkKICAgICAgICB7CiAgICAgICAgICAgIHN0YWdlLl9pbnRlcmFjdGl2ZUV2ZW50c0FkZGVkID0gdHJ1ZTsKICAgICAgICAgICAgc3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyLnNldFRhcmdldCh0aGlzKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gcmVtb3ZlIGZyYW1lIHVwZGF0ZXMuLgogICAgaWYoUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcy5sZW5ndGggPiAwKQogICAgewogICAgICAgIFBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMgPSBbXTsKICAgIH0KfTsKCi8qKgogKiByZXNpemVzIHRoZSBjYW52YXMgdmlldyB0byB0aGUgc3BlY2lmaWVkIHdpZHRoIGFuZCBoZWlnaHQKICoKICogQG1ldGhvZCByZXNpemUKICogQHBhcmFtIHdpZHRoIHtOdW1iZXJ9IHRoZSBuZXcgd2lkdGggb2YgdGhlIGNhbnZhcyB2aWV3CiAqIEBwYXJhbSBoZWlnaHQge051bWJlcn0gdGhlIG5ldyBoZWlnaHQgb2YgdGhlIGNhbnZhcyB2aWV3CiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KQp7CiAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKCiAgICB0aGlzLnZpZXcud2lkdGggPSB3aWR0aDsKICAgIHRoaXMudmlldy5oZWlnaHQgPSBoZWlnaHQ7Cn07CgovKioKICogUmVuZGVycyBhIGRpc3BsYXkgb2JqZWN0CiAqCiAqIEBtZXRob2QgcmVuZGVyRGlzcGxheU9iamVjdAogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0gVGhlIGRpc3BsYXlPYmplY3QgdG8gcmVuZGVyCiAqIEBwcml2YXRlCiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJEaXNwbGF5T2JqZWN0ID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCkKewogICAgLy8gbm8gbG9nZXIgcmVjdXJyc2l2ZSEKICAgIHZhciB0cmFuc2Zvcm07CiAgICB2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dDsKCiAgICBjb250ZXh0Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9ICdzb3VyY2Utb3Zlcic7CgogICAgLy8gb25lIHRoZSBkaXNwbGF5IG9iamVjdCBoaXRzIHRoaXMuIHdlIGNhbiBicmVhayB0aGUgbG9vcAogICAgdmFyIHRlc3RPYmplY3QgPSBkaXNwbGF5T2JqZWN0Lmxhc3QuX2lOZXh0OwogICAgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuZmlyc3Q7CgogICAgZG8KICAgIHsKICAgICAgICB0cmFuc2Zvcm0gPSBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtOwoKICAgICAgICBpZighZGlzcGxheU9iamVjdC52aXNpYmxlKQogICAgICAgIHsKICAgICAgICAgICAgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QubGFzdC5faU5leHQ7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgaWYoIWRpc3BsYXlPYmplY3QucmVuZGVyYWJsZSkKICAgICAgICB7CiAgICAgICAgICAgIGRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCiAgICAgICAgewoKICAgICAgICAgICAgdmFyIGZyYW1lID0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lOwoKICAgICAgICAgICAgLy9pZ25vcmUgbnVsbCBzb3VyY2VzCiAgICAgICAgICAgIGlmKGZyYW1lICYmIGZyYW1lLndpZHRoICYmIGZyYW1lLmhlaWdodCAmJiBkaXNwbGF5T2JqZWN0LnRleHR1cmUuYmFzZVRleHR1cmUuc291cmNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb250ZXh0Lmdsb2JhbEFscGhhID0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhOwoKICAgICAgICAgICAgICAgIGNvbnRleHQuc2V0VHJhbnNmb3JtKHRyYW5zZm9ybVswXSwgdHJhbnNmb3JtWzNdLCB0cmFuc2Zvcm1bMV0sIHRyYW5zZm9ybVs0XSwgdHJhbnNmb3JtWzJdLCB0cmFuc2Zvcm1bNV0pOwoKICAgICAgICAgICAgICAgIC8vaWYgc21vb3RoaW5nRW5hYmxlZCBpcyBzdXBwb3J0ZWQgYW5kIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBzbW9vdGhpbmcgcHJvcGVydHkgZm9yIHRoaXMgdGV4dHVyZQogICAgICAgICAgICAgICAgaWYodGhpcy5zbW9vdGhQcm9wZXJ0eSAmJiB0aGlzLnNjYWxlTW9kZSAhPT0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmJhc2VUZXh0dXJlLnNjYWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2NhbGVNb2RlID0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmJhc2VUZXh0dXJlLnNjYWxlTW9kZTsKICAgICAgICAgICAgICAgICAgICBjb250ZXh0W3RoaXMuc21vb3RoUHJvcGVydHldID0gKHRoaXMuc2NhbGVNb2RlID09PSBQSVhJLkJhc2VUZXh0dXJlLlNDQUxFX01PREUuTElORUFSKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb250ZXh0LmRyYXdJbWFnZShkaXNwbGF5T2JqZWN0LnRleHR1cmUuYmFzZVRleHR1cmUuc291cmNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lLngsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUueSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFtZS53aWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFtZS5oZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGRpc3BsYXlPYmplY3QuYW5jaG9yLngpICogLWZyYW1lLndpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChkaXNwbGF5T2JqZWN0LmFuY2hvci55KSAqIC1mcmFtZS5oZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUuaGVpZ2h0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlN0cmlwKQogICAgICAgIHsKICAgICAgICAgICAgY29udGV4dC5zZXRUcmFuc2Zvcm0odHJhbnNmb3JtWzBdLCB0cmFuc2Zvcm1bM10sIHRyYW5zZm9ybVsxXSwgdHJhbnNmb3JtWzRdLCB0cmFuc2Zvcm1bMl0sIHRyYW5zZm9ybVs1XSk7CiAgICAgICAgICAgIHRoaXMucmVuZGVyU3RyaXAoZGlzcGxheU9iamVjdCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuVGlsaW5nU3ByaXRlKQogICAgICAgIHsKICAgICAgICAgICAgY29udGV4dC5zZXRUcmFuc2Zvcm0odHJhbnNmb3JtWzBdLCB0cmFuc2Zvcm1bM10sIHRyYW5zZm9ybVsxXSwgdHJhbnNmb3JtWzRdLCB0cmFuc2Zvcm1bMl0sIHRyYW5zZm9ybVs1XSk7CiAgICAgICAgICAgIHRoaXMucmVuZGVyVGlsaW5nU3ByaXRlKGRpc3BsYXlPYmplY3QpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLkN1c3RvbVJlbmRlcmFibGUpCiAgICAgICAgewogICAgICAgICAgICBjb250ZXh0LnNldFRyYW5zZm9ybSh0cmFuc2Zvcm1bMF0sIHRyYW5zZm9ybVszXSwgdHJhbnNmb3JtWzFdLCB0cmFuc2Zvcm1bNF0sIHRyYW5zZm9ybVsyXSwgdHJhbnNmb3JtWzVdKTsKICAgICAgICAgICAgZGlzcGxheU9iamVjdC5yZW5kZXJDYW52YXModGhpcyk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuR3JhcGhpY3MpCiAgICAgICAgewogICAgICAgICAgICBjb250ZXh0LnNldFRyYW5zZm9ybSh0cmFuc2Zvcm1bMF0sIHRyYW5zZm9ybVszXSwgdHJhbnNmb3JtWzFdLCB0cmFuc2Zvcm1bNF0sIHRyYW5zZm9ybVsyXSwgdHJhbnNmb3JtWzVdKTsKICAgICAgICAgICAgUElYSS5DYW52YXNHcmFwaGljcy5yZW5kZXJHcmFwaGljcyhkaXNwbGF5T2JqZWN0LCBjb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5GaWx0ZXJCbG9jaykKICAgICAgICB7CiAgICAgICAgICAgIGlmKGRpc3BsYXlPYmplY3QuZGF0YSBpbnN0YW5jZW9mIFBJWEkuR3JhcGhpY3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBtYXNrID0gZGlzcGxheU9iamVjdC5kYXRhOwoKICAgICAgICAgICAgICAgIGlmKGRpc3BsYXlPYmplY3Qub3BlbikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjb250ZXh0LnNhdmUoKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGNhY2hlQWxwaGEgPSBtYXNrLmFscGhhOwogICAgICAgICAgICAgICAgICAgIHZhciBtYXNrVHJhbnNmb3JtID0gbWFzay53b3JsZFRyYW5zZm9ybTsKCiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5zZXRUcmFuc2Zvcm0obWFza1RyYW5zZm9ybVswXSwgbWFza1RyYW5zZm9ybVszXSwgbWFza1RyYW5zZm9ybVsxXSwgbWFza1RyYW5zZm9ybVs0XSwgbWFza1RyYW5zZm9ybVsyXSwgbWFza1RyYW5zZm9ybVs1XSk7CgogICAgICAgICAgICAgICAgICAgIG1hc2sud29ybGRBbHBoYSA9IDAuNTsKCiAgICAgICAgICAgICAgICAgICAgY29udGV4dC53b3JsZEFscGhhID0gMDsKCiAgICAgICAgICAgICAgICAgICAgUElYSS5DYW52YXNHcmFwaGljcy5yZW5kZXJHcmFwaGljc01hc2sobWFzaywgY29udGV4dCk7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5jbGlwKCk7CgogICAgICAgICAgICAgICAgICAgIG1hc2sud29ybGRBbHBoYSA9IGNhY2hlQWxwaGE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5yZXN0b3JlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy9jb3VudCsrCiAgICAgICAgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuX2lOZXh0OwogICAgfQogICAgd2hpbGUoZGlzcGxheU9iamVjdCAhPT0gdGVzdE9iamVjdCk7Cn07CgovKioKICogUmVuZGVycyBhIGZsYXQgc3RyaXAKICoKICogQG1ldGhvZCByZW5kZXJTdHJpcEZsYXQKICogQHBhcmFtIHN0cmlwIHtTdHJpcH0gVGhlIFN0cmlwIHRvIHJlbmRlcgogKiBAcHJpdmF0ZQogKi8KUElYSS5DYW52YXNSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyU3RyaXBGbGF0ID0gZnVuY3Rpb24oc3RyaXApCnsKICAgIHZhciBjb250ZXh0ID0gdGhpcy5jb250ZXh0OwogICAgdmFyIHZlcnRpY2llcyA9IHN0cmlwLnZlcnRpY2llczsKCiAgICB2YXIgbGVuZ3RoID0gdmVydGljaWVzLmxlbmd0aC8yOwogICAgdGhpcy5jb3VudCsrOwoKICAgIGNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICBmb3IgKHZhciBpPTE7IGkgPCBsZW5ndGgtMjsgaSsrKQogICAgewogICAgICAgIC8vIGRyYXcgc29tZSB0cmlhbmdsZXMhCiAgICAgICAgdmFyIGluZGV4ID0gaSoyOwoKICAgICAgICB2YXIgeDAgPSB2ZXJ0aWNpZXNbaW5kZXhdLCAgIHgxID0gdmVydGljaWVzW2luZGV4KzJdLCB4MiA9IHZlcnRpY2llc1tpbmRleCs0XTsKICAgICAgICB2YXIgeTAgPSB2ZXJ0aWNpZXNbaW5kZXgrMV0sIHkxID0gdmVydGljaWVzW2luZGV4KzNdLCB5MiA9IHZlcnRpY2llc1tpbmRleCs1XTsKCiAgICAgICAgY29udGV4dC5tb3ZlVG8oeDAsIHkwKTsKICAgICAgICBjb250ZXh0LmxpbmVUbyh4MSwgeTEpOwogICAgICAgIGNvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICB9CgogICAgY29udGV4dC5maWxsU3R5bGUgPSAnI0ZGMDAwMCc7CiAgICBjb250ZXh0LmZpbGwoKTsKICAgIGNvbnRleHQuY2xvc2VQYXRoKCk7Cn07CgovKioKICogUmVuZGVycyBhIHRpbGluZyBzcHJpdGUKICoKICogQG1ldGhvZCByZW5kZXJUaWxpbmdTcHJpdGUKICogQHBhcmFtIHNwcml0ZSB7VGlsaW5nU3ByaXRlfSBUaGUgdGlsaW5nc3ByaXRlIHRvIHJlbmRlcgogKiBAcHJpdmF0ZQogKi8KUElYSS5DYW52YXNSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyVGlsaW5nU3ByaXRlID0gZnVuY3Rpb24oc3ByaXRlKQp7CiAgICB2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dDsKCiAgICBjb250ZXh0Lmdsb2JhbEFscGhhID0gc3ByaXRlLndvcmxkQWxwaGE7CgogICAgaWYoIXNwcml0ZS5fX3RpbGVQYXR0ZXJuKQogICAgICAgIHNwcml0ZS5fX3RpbGVQYXR0ZXJuID0gY29udGV4dC5jcmVhdGVQYXR0ZXJuKHNwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLnNvdXJjZSwgJ3JlcGVhdCcpOwoKICAgIGNvbnRleHQuYmVnaW5QYXRoKCk7CgogICAgdmFyIHRpbGVQb3NpdGlvbiA9IHNwcml0ZS50aWxlUG9zaXRpb247CiAgICB2YXIgdGlsZVNjYWxlID0gc3ByaXRlLnRpbGVTY2FsZTsKCiAgICAvLyBvZmZzZXQKICAgIGNvbnRleHQuc2NhbGUodGlsZVNjYWxlLngsdGlsZVNjYWxlLnkpOwogICAgY29udGV4dC50cmFuc2xhdGUodGlsZVBvc2l0aW9uLngsIHRpbGVQb3NpdGlvbi55KTsKCiAgICBjb250ZXh0LmZpbGxTdHlsZSA9IHNwcml0ZS5fX3RpbGVQYXR0ZXJuOwogICAgY29udGV4dC5maWxsUmVjdCgtdGlsZVBvc2l0aW9uLngsLXRpbGVQb3NpdGlvbi55LHNwcml0ZS53aWR0aCAvIHRpbGVTY2FsZS54LCBzcHJpdGUuaGVpZ2h0IC8gdGlsZVNjYWxlLnkpOwoKICAgIGNvbnRleHQuc2NhbGUoMS90aWxlU2NhbGUueCwgMS90aWxlU2NhbGUueSk7CiAgICBjb250ZXh0LnRyYW5zbGF0ZSgtdGlsZVBvc2l0aW9uLngsIC10aWxlUG9zaXRpb24ueSk7CgogICAgY29udGV4dC5jbG9zZVBhdGgoKTsKfTsKCi8qKgogKiBSZW5kZXJzIGEgc3RyaXAKICoKICogQG1ldGhvZCByZW5kZXJTdHJpcAogKiBAcGFyYW0gc3RyaXAge1N0cmlwfSBUaGUgU3RyaXAgdG8gcmVuZGVyCiAqIEBwcml2YXRlCiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJTdHJpcCA9IGZ1bmN0aW9uKHN0cmlwKQp7CiAgICB2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dDsKCiAgICAvLyBkcmF3IHRyaWFuZ2xlcyEhCiAgICB2YXIgdmVydGljaWVzID0gc3RyaXAudmVydGljaWVzOwogICAgdmFyIHV2cyA9IHN0cmlwLnV2czsKCiAgICB2YXIgbGVuZ3RoID0gdmVydGljaWVzLmxlbmd0aC8yOwogICAgdGhpcy5jb3VudCsrOwoKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgbGVuZ3RoLTI7IGkrKykKICAgIHsKICAgICAgICAvLyBkcmF3IHNvbWUgdHJpYW5nbGVzIQogICAgICAgIHZhciBpbmRleCA9IGkqMjsKCiAgICAgICAgdmFyIHgwID0gdmVydGljaWVzW2luZGV4XSwgICB4MSA9IHZlcnRpY2llc1tpbmRleCsyXSwgeDIgPSB2ZXJ0aWNpZXNbaW5kZXgrNF07CiAgICAgICAgdmFyIHkwID0gdmVydGljaWVzW2luZGV4KzFdLCB5MSA9IHZlcnRpY2llc1tpbmRleCszXSwgeTIgPSB2ZXJ0aWNpZXNbaW5kZXgrNV07CgogICAgICAgIHZhciB1MCA9IHV2c1tpbmRleF0gKiBzdHJpcC50ZXh0dXJlLndpZHRoLCAgIHUxID0gdXZzW2luZGV4KzJdICogc3RyaXAudGV4dHVyZS53aWR0aCwgdTIgPSB1dnNbaW5kZXgrNF0qIHN0cmlwLnRleHR1cmUud2lkdGg7CiAgICAgICAgdmFyIHYwID0gdXZzW2luZGV4KzFdKiBzdHJpcC50ZXh0dXJlLmhlaWdodCwgdjEgPSB1dnNbaW5kZXgrM10gKiBzdHJpcC50ZXh0dXJlLmhlaWdodCwgdjIgPSB1dnNbaW5kZXgrNV0qIHN0cmlwLnRleHR1cmUuaGVpZ2h0OwoKICAgICAgICBjb250ZXh0LnNhdmUoKTsKICAgICAgICBjb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgIGNvbnRleHQubW92ZVRvKHgwLCB5MCk7CiAgICAgICAgY29udGV4dC5saW5lVG8oeDEsIHkxKTsKICAgICAgICBjb250ZXh0LmxpbmVUbyh4MiwgeTIpOwogICAgICAgIGNvbnRleHQuY2xvc2VQYXRoKCk7CgogICAgICAgIGNvbnRleHQuY2xpcCgpOwoKICAgICAgICAvLyBDb21wdXRlIG1hdHJpeCB0cmFuc2Zvcm0KICAgICAgICB2YXIgZGVsdGEgPSB1MCp2MSArIHYwKnUyICsgdTEqdjIgLSB2MSp1MiAtIHYwKnUxIC0gdTAqdjI7CiAgICAgICAgdmFyIGRlbHRhQSA9IHgwKnYxICsgdjAqeDIgKyB4MSp2MiAtIHYxKngyIC0gdjAqeDEgLSB4MCp2MjsKICAgICAgICB2YXIgZGVsdGFCID0gdTAqeDEgKyB4MCp1MiArIHUxKngyIC0geDEqdTIgLSB4MCp1MSAtIHUwKngyOwogICAgICAgIHZhciBkZWx0YUMgPSB1MCp2MSp4MiArIHYwKngxKnUyICsgeDAqdTEqdjIgLSB4MCp2MSp1MiAtIHYwKnUxKngyIC0gdTAqeDEqdjI7CiAgICAgICAgdmFyIGRlbHRhRCA9IHkwKnYxICsgdjAqeTIgKyB5MSp2MiAtIHYxKnkyIC0gdjAqeTEgLSB5MCp2MjsKICAgICAgICB2YXIgZGVsdGFFID0gdTAqeTEgKyB5MCp1MiArIHUxKnkyIC0geTEqdTIgLSB5MCp1MSAtIHUwKnkyOwogICAgICAgIHZhciBkZWx0YUYgPSB1MCp2MSp5MiArIHYwKnkxKnUyICsgeTAqdTEqdjIgLSB5MCp2MSp1MiAtIHYwKnUxKnkyIC0gdTAqeTEqdjI7CgogICAgICAgIGNvbnRleHQudHJhbnNmb3JtKGRlbHRhQSAvIGRlbHRhLCBkZWx0YUQgLyBkZWx0YSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhQiAvIGRlbHRhLCBkZWx0YUUgLyBkZWx0YSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhQyAvIGRlbHRhLCBkZWx0YUYgLyBkZWx0YSk7CgogICAgICAgIGNvbnRleHQuZHJhd0ltYWdlKHN0cmlwLnRleHR1cmUuYmFzZVRleHR1cmUuc291cmNlLCAwLCAwKTsKICAgICAgICBjb250ZXh0LnJlc3RvcmUoKTsKICAgIH0KfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICogQGF1dGhvciBSaWNoYXJkIERhdmV5IGh0dHA6Ly93d3cucGhvdG9uc3Rvcm0uY29tIEBwaG90b25zdG9ybQogKi8KCi8qKgoqIEBjbGFzcyBQSVhJLlBpeGlTaGFkZXIKKiBAY29uc3RydWN0b3IKKi8KUElYSS5QaXhpU2hhZGVyID0gZnVuY3Rpb24oKQp7CiAgICAvKioKICAgICogQHByb3BlcnR5IHthbnl9IHByb2dyYW0gLSBUaGUgV2ViR0wgcHJvZ3JhbS4KICAgICovCiAgICB0aGlzLnByb2dyYW0gPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBmcmFnbWVudFNyYyAtIFRoZSBmcmFnbWVudCBzaGFkZXIuCiAgICAqLwogICAgdGhpcy5mcmFnbWVudFNyYyA9IFsKICAgICAgICAncHJlY2lzaW9uIGxvd3AgZmxvYXQ7JywKICAgICAgICAndmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7JywKICAgICAgICAndmFyeWluZyBmbG9hdCB2Q29sb3I7JywKICAgICAgICAndW5pZm9ybSBzYW1wbGVyMkQgdVNhbXBsZXI7JywKICAgICAgICAndm9pZCBtYWluKHZvaWQpIHsnLAogICAgICAgICcgICBnbF9GcmFnQ29sb3IgPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZUZXh0dXJlQ29vcmQpICogdkNvbG9yOycsCiAgICAgICAgJ30nCiAgICBdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdGV4dHVyZUNvdW50IC0gQSBsb2NhbCB0ZXh0dXJlIGNvdW50ZXIgZm9yIG11bHRpLXRleHR1cmUgc2hhZGVycy4KICAgICovCiAgICB0aGlzLnRleHR1cmVDb3VudCA9IDA7Cn07CgovKioKKiBAbWV0aG9kIFBJWEkuUGl4aVNoYWRlciNpbml0CiovClBJWEkuUGl4aVNoYWRlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKCkKewogICAgdmFyIHByb2dyYW0gPSBQSVhJLmNvbXBpbGVQcm9ncmFtKHRoaXMudmVydGV4U3JjIHx8IFBJWEkuUGl4aVNoYWRlci5kZWZhdWx0VmVydGV4U3JjLCB0aGlzLmZyYWdtZW50U3JjKTsKCiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIGdsLnVzZVByb2dyYW0ocHJvZ3JhbSk7CgogICAgLy8gZ2V0IGFuZCBzdG9yZSB0aGUgdW5pZm9ybXMgZm9yIHRoZSBzaGFkZXIKICAgIHRoaXMudVNhbXBsZXIgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ3VTYW1wbGVyJyk7CiAgICB0aGlzLnByb2plY3Rpb25WZWN0b3IgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ3Byb2plY3Rpb25WZWN0b3InKTsKICAgIHRoaXMub2Zmc2V0VmVjdG9yID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICdvZmZzZXRWZWN0b3InKTsKICAgIHRoaXMuZGltZW5zaW9ucyA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAnZGltZW5zaW9ucycpOwoKICAgIC8vIGdldCBhbmQgc3RvcmUgdGhlIGF0dHJpYnV0ZXMKICAgIHRoaXMuYVZlcnRleFBvc2l0aW9uID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgJ2FWZXJ0ZXhQb3NpdGlvbicpOwogICAgdGhpcy5jb2xvckF0dHJpYnV0ZSA9IGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sICdhQ29sb3InKTsKICAgIHRoaXMuYVRleHR1cmVDb29yZCA9IGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sICdhVGV4dHVyZUNvb3JkJyk7CgogICAgLy8gYWRkIHRob3NlIGN1c3RvbSBzaGFkZXJzIQogICAgZm9yICh2YXIga2V5IGluIHRoaXMudW5pZm9ybXMpCiAgICB7CiAgICAgICAgLy8gZ2V0IHRoZSB1bmlmb3JtIGxvY2F0aW9ucy4uCiAgICAgICAgdGhpcy51bmlmb3Jtc1trZXldLnVuaWZvcm1Mb2NhdGlvbiA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCBrZXkpOwogICAgfQoKICAgIHRoaXMuaW5pdFVuaWZvcm1zKCk7CgogICAgdGhpcy5wcm9ncmFtID0gcHJvZ3JhbTsKfTsKCi8qKgoqIEluaXRpYWxpc2VzIHRoZSBzaGFkZXIgdW5pZm9ybSB2YWx1ZXMuCiogVW5pZm9ybXMgYXJlIHNwZWNpZmllZCBpbiB0aGUgR0xTTF9FUyBTcGVjaWZpY2F0aW9uOiBodHRwOi8vd3d3Lmtocm9ub3Mub3JnL3JlZ2lzdHJ5L3dlYmdsL3NwZWNzL2xhdGVzdC8xLjAvCiogaHR0cDovL3d3dy5raHJvbm9zLm9yZy9yZWdpc3RyeS9nbGVzL3NwZWNzLzIuMC9HTFNMX0VTX1NwZWNpZmljYXRpb25fMS4wLjE3LnBkZgoqCiogQG1ldGhvZCBQSVhJLlBpeGlTaGFkZXIjaW5pdFVuaWZvcm1zCiovClBJWEkuUGl4aVNoYWRlci5wcm90b3R5cGUuaW5pdFVuaWZvcm1zID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLnRleHR1cmVDb3VudCA9IDE7CgogICAgdmFyIHVuaWZvcm07CgogICAgZm9yICh2YXIga2V5IGluIHRoaXMudW5pZm9ybXMpCiAgICB7CiAgICAgICAgdW5pZm9ybSA9IHRoaXMudW5pZm9ybXNba2V5XTsKCiAgICAgICAgdmFyIHR5cGUgPSB1bmlmb3JtLnR5cGU7CgogICAgICAgIGlmICh0eXBlID09PSAnc2FtcGxlcjJEJykKICAgICAgICB7CiAgICAgICAgICAgIHVuaWZvcm0uX2luaXQgPSBmYWxzZTsKCiAgICAgICAgICAgIGlmICh1bmlmb3JtLnZhbHVlICE9PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmluaXRTYW1wbGVyMkQodW5pZm9ybSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ21hdDInIHx8IHR5cGUgPT09ICdtYXQzJyB8fCB0eXBlID09PSAnbWF0NCcpCiAgICAgICAgewogICAgICAgICAgICAvLyAgVGhlc2UgcmVxdWlyZSBzcGVjaWFsIGhhbmRsaW5nCiAgICAgICAgICAgIHVuaWZvcm0uZ2xNYXRyaXggPSB0cnVlOwogICAgICAgICAgICB1bmlmb3JtLmdsVmFsdWVMZW5ndGggPSAxOwoKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdtYXQyJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdW5pZm9ybS5nbEZ1bmMgPSBQSVhJLmdsLnVuaWZvcm1NYXRyaXgyZnY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ21hdDMnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB1bmlmb3JtLmdsRnVuYyA9IFBJWEkuZ2wudW5pZm9ybU1hdHJpeDNmdjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnbWF0NCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHVuaWZvcm0uZ2xGdW5jID0gUElYSS5nbC51bmlmb3JtTWF0cml4NGZ2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBHTCBmdW5jdGlvbiByZWZlcmVuY2UKICAgICAgICAgICAgdW5pZm9ybS5nbEZ1bmMgPSBQSVhJLmdsWyd1bmlmb3JtJyArIHR5cGVdOwoKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICcyZicgfHwgdHlwZSA9PT0gJzJpJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdW5pZm9ybS5nbFZhbHVlTGVuZ3RoID0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnM2YnIHx8IHR5cGUgPT09ICczaScpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHVuaWZvcm0uZ2xWYWx1ZUxlbmd0aCA9IDM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJzRmJyB8fCB0eXBlID09PSAnNGknKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB1bmlmb3JtLmdsVmFsdWVMZW5ndGggPSA0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdW5pZm9ybS5nbFZhbHVlTGVuZ3RoID0gMTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCn07CgovKioKKiBJbml0aWFsaXNlcyBhIFNhbXBsZXIyRCB1bmlmb3JtICh3aGljaCBtYXkgb25seSBiZSBhdmFpbGFibGUgbGF0ZXIgb24gYWZ0ZXIgaW5pdFVuaWZvcm1zIG9uY2UgdGhlIHRleHR1cmUgaXMgaGFzIGxvYWRlZCkKKgoqIEBtZXRob2QgUElYSS5QaXhpU2hhZGVyI2luaXRTYW1wbGVyMkQKKi8KUElYSS5QaXhpU2hhZGVyLnByb3RvdHlwZS5pbml0U2FtcGxlcjJEID0gZnVuY3Rpb24odW5pZm9ybSkKewogICAgaWYgKCF1bmlmb3JtLnZhbHVlIHx8ICF1bmlmb3JtLnZhbHVlLmJhc2VUZXh0dXJlIHx8ICF1bmlmb3JtLnZhbHVlLmJhc2VUZXh0dXJlLmhhc0xvYWRlZCkKICAgIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgUElYSS5nbC5hY3RpdmVUZXh0dXJlKFBJWEkuZ2xbJ1RFWFRVUkUnICsgdGhpcy50ZXh0dXJlQ291bnRdKTsKICAgIFBJWEkuZ2wuYmluZFRleHR1cmUoUElYSS5nbC5URVhUVVJFXzJELCB1bmlmb3JtLnZhbHVlLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpOwoKICAgIC8vICBFeHRlbmRlZCB0ZXh0dXJlIGRhdGEKICAgIGlmICh1bmlmb3JtLnRleHR1cmVEYXRhKQogICAgewogICAgICAgIHZhciBkYXRhID0gdW5pZm9ybS50ZXh0dXJlRGF0YTsKCiAgICAgICAgLy8gR0xUZXh0dXJlID0gbWFnIGxpbmVhciwgbWluIGxpbmVhcl9taXBtYXBfbGluZWFyLCB3cmFwIHJlcGVhdCArIGdsLmdlbmVyYXRlTWlwbWFwKGdsLlRFWFRVUkVfMkQpOwogICAgICAgIC8vIEdMVGV4dHVyZUxpbmVhciA9IG1hZy9taW4gbGluZWFyLCB3cmFwIGNsYW1wCiAgICAgICAgLy8gR0xUZXh0dXJlTmVhcmVzdFJlcGVhdCA9IG1hZy9taW4gTkVBUkVTVCwgd3JhcCByZXBlYXQKICAgICAgICAvLyBHTFRleHR1cmVOZWFyZXN0ID0gbWFnL21pbiBuZWFyZXN0LCB3cmFwIGNsYW1wCiAgICAgICAgLy8gQXVkaW9UZXh0dXJlID0gd2hhdGV2ZXIgKyBsdW1pbmFuY2UgKyB3aWR0aCA1MTIsIGhlaWdodCAyLCBib3JkZXIgMAogICAgICAgIC8vIEtleVRleHR1cmUgPSB3aGF0ZXZlciArIGx1bWluYW5jZSArIHdpZHRoIDI1NiwgaGVpZ2h0IDIsIGJvcmRlciAwCgogICAgICAgIC8vICBtYWdGaWx0ZXIgY2FuIGJlOiBnbC5MSU5FQVIsIGdsLkxJTkVBUl9NSVBNQVBfTElORUFSIG9yIGdsLk5FQVJFU1QKICAgICAgICAvLyAgd3JhcFMvVCBjYW4gYmU6IGdsLkNMQU1QX1RPX0VER0Ugb3IgZ2wuUkVQRUFUCgogICAgICAgIHZhciBtYWdGaWx0ZXIgPSAoZGF0YS5tYWdGaWx0ZXIpID8gZGF0YS5tYWdGaWx0ZXIgOiBQSVhJLmdsLkxJTkVBUjsKICAgICAgICB2YXIgbWluRmlsdGVyID0gKGRhdGEubWluRmlsdGVyKSA/IGRhdGEubWluRmlsdGVyIDogUElYSS5nbC5MSU5FQVI7CiAgICAgICAgdmFyIHdyYXBTID0gKGRhdGEud3JhcFMpID8gZGF0YS53cmFwUyA6IFBJWEkuZ2wuQ0xBTVBfVE9fRURHRTsKICAgICAgICB2YXIgd3JhcFQgPSAoZGF0YS53cmFwVCkgPyBkYXRhLndyYXBUIDogUElYSS5nbC5DTEFNUF9UT19FREdFOwogICAgICAgIHZhciBmb3JtYXQgPSAoZGF0YS5sdW1pbmFuY2UpID8gUElYSS5nbC5MVU1JTkFOQ0UgOiBQSVhJLmdsLlJHQkE7CgogICAgICAgIGlmIChkYXRhLnJlcGVhdCkKICAgICAgICB7CiAgICAgICAgICAgIHdyYXBTID0gUElYSS5nbC5SRVBFQVQ7CiAgICAgICAgICAgIHdyYXBUID0gUElYSS5nbC5SRVBFQVQ7CiAgICAgICAgfQoKICAgICAgICBQSVhJLmdsLnBpeGVsU3RvcmVpKFBJWEkuZ2wuVU5QQUNLX0ZMSVBfWV9XRUJHTCwgZmFsc2UpOwoKICAgICAgICBpZiAoZGF0YS53aWR0aCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB3aWR0aCA9IChkYXRhLndpZHRoKSA/IGRhdGEud2lkdGggOiA1MTI7CiAgICAgICAgICAgIHZhciBoZWlnaHQgPSAoZGF0YS5oZWlnaHQpID8gZGF0YS5oZWlnaHQgOiAyOwogICAgICAgICAgICB2YXIgYm9yZGVyID0gKGRhdGEuYm9yZGVyKSA/IGRhdGEuYm9yZGVyIDogMDsKCiAgICAgICAgICAgIC8vIHZvaWQgdGV4SW1hZ2UyRChHTGVudW0gdGFyZ2V0LCBHTGludCBsZXZlbCwgR0xlbnVtIGludGVybmFsZm9ybWF0LCBHTHNpemVpIHdpZHRoLCBHTHNpemVpIGhlaWdodCwgR0xpbnQgYm9yZGVyLCBHTGVudW0gZm9ybWF0LCBHTGVudW0gdHlwZSwgQXJyYXlCdWZmZXJWaWV3PyBwaXhlbHMpOwogICAgICAgICAgICBQSVhJLmdsLnRleEltYWdlMkQoUElYSS5nbC5URVhUVVJFXzJELCAwLCBmb3JtYXQsIHdpZHRoLCBoZWlnaHQsIGJvcmRlciwgZm9ybWF0LCBQSVhJLmdsLlVOU0lHTkVEX0JZVEUsIG51bGwpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgdm9pZCB0ZXhJbWFnZTJEKEdMZW51bSB0YXJnZXQsIEdMaW50IGxldmVsLCBHTGVudW0gaW50ZXJuYWxmb3JtYXQsIEdMZW51bSBmb3JtYXQsIEdMZW51bSB0eXBlLCBJbWFnZURhdGE/IHBpeGVscyk7CiAgICAgICAgICAgIFBJWEkuZ2wudGV4SW1hZ2UyRChQSVhJLmdsLlRFWFRVUkVfMkQsIDAsIGZvcm1hdCwgUElYSS5nbC5SR0JBLCBQSVhJLmdsLlVOU0lHTkVEX0JZVEUsIHVuaWZvcm0udmFsdWUuYmFzZVRleHR1cmUuc291cmNlKTsKICAgICAgICB9CgogICAgICAgIFBJWEkuZ2wudGV4UGFyYW1ldGVyaShQSVhJLmdsLlRFWFRVUkVfMkQsIFBJWEkuZ2wuVEVYVFVSRV9NQUdfRklMVEVSLCBtYWdGaWx0ZXIpOwogICAgICAgIFBJWEkuZ2wudGV4UGFyYW1ldGVyaShQSVhJLmdsLlRFWFRVUkVfMkQsIFBJWEkuZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBtaW5GaWx0ZXIpOwogICAgICAgIFBJWEkuZ2wudGV4UGFyYW1ldGVyaShQSVhJLmdsLlRFWFRVUkVfMkQsIFBJWEkuZ2wuVEVYVFVSRV9XUkFQX1MsIHdyYXBTKTsKICAgICAgICBQSVhJLmdsLnRleFBhcmFtZXRlcmkoUElYSS5nbC5URVhUVVJFXzJELCBQSVhJLmdsLlRFWFRVUkVfV1JBUF9ULCB3cmFwVCk7CiAgICB9CgogICAgUElYSS5nbC51bmlmb3JtMWkodW5pZm9ybS51bmlmb3JtTG9jYXRpb24sIHRoaXMudGV4dHVyZUNvdW50KTsKCiAgICB1bmlmb3JtLl9pbml0ID0gdHJ1ZTsKCiAgICB0aGlzLnRleHR1cmVDb3VudCsrOwoKfTsKCi8qKgoqIFVwZGF0ZXMgdGhlIHNoYWRlciB1bmlmb3JtIHZhbHVlcy4KKgoqIEBtZXRob2QgUElYSS5QaXhpU2hhZGVyI3N5bmNVbmlmb3JtcwoqLwpQSVhJLlBpeGlTaGFkZXIucHJvdG90eXBlLnN5bmNVbmlmb3JtcyA9IGZ1bmN0aW9uKCkKewogICAgdGhpcy50ZXh0dXJlQ291bnQgPSAxOwogICAgdmFyIHVuaWZvcm07CgogICAgLy8gIFRoaXMgd291bGQgcHJvYmFibHkgYmUgZmFzdGVyIGluIGFuIGFycmF5IGFuZCBpdCB3b3VsZCBndWFyYW50ZWUga2V5IG9yZGVyCiAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy51bmlmb3JtcykKICAgIHsKCiAgICAgICAgdW5pZm9ybSA9IHRoaXMudW5pZm9ybXNba2V5XTsKCiAgICAgICAgaWYgKHVuaWZvcm0uZ2xWYWx1ZUxlbmd0aCA9PT0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh1bmlmb3JtLmdsTWF0cml4ID09PSB0cnVlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB1bmlmb3JtLmdsRnVuYy5jYWxsKFBJWEkuZ2wsIHVuaWZvcm0udW5pZm9ybUxvY2F0aW9uLCB1bmlmb3JtLnRyYW5zcG9zZSwgdW5pZm9ybS52YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB1bmlmb3JtLmdsRnVuYy5jYWxsKFBJWEkuZ2wsIHVuaWZvcm0udW5pZm9ybUxvY2F0aW9uLCB1bmlmb3JtLnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh1bmlmb3JtLmdsVmFsdWVMZW5ndGggPT09IDIpCiAgICAgICAgewogICAgICAgICAgICB1bmlmb3JtLmdsRnVuYy5jYWxsKFBJWEkuZ2wsIHVuaWZvcm0udW5pZm9ybUxvY2F0aW9uLCB1bmlmb3JtLnZhbHVlLngsIHVuaWZvcm0udmFsdWUueSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHVuaWZvcm0uZ2xWYWx1ZUxlbmd0aCA9PT0gMykKICAgICAgICB7CiAgICAgICAgICAgIHVuaWZvcm0uZ2xGdW5jLmNhbGwoUElYSS5nbCwgdW5pZm9ybS51bmlmb3JtTG9jYXRpb24sIHVuaWZvcm0udmFsdWUueCwgdW5pZm9ybS52YWx1ZS55LCB1bmlmb3JtLnZhbHVlLnopOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh1bmlmb3JtLmdsVmFsdWVMZW5ndGggPT09IDQpCiAgICAgICAgewogICAgICAgICAgICB1bmlmb3JtLmdsRnVuYy5jYWxsKFBJWEkuZ2wsIHVuaWZvcm0udW5pZm9ybUxvY2F0aW9uLCB1bmlmb3JtLnZhbHVlLngsIHVuaWZvcm0udmFsdWUueSwgdW5pZm9ybS52YWx1ZS56LCB1bmlmb3JtLnZhbHVlLncpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh1bmlmb3JtLnR5cGUgPT09ICdzYW1wbGVyMkQnKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHVuaWZvcm0uX2luaXQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIFBJWEkuZ2wuYWN0aXZlVGV4dHVyZShQSVhJLmdsWydURVhUVVJFJyArIHRoaXMudGV4dHVyZUNvdW50XSk7CiAgICAgICAgICAgICAgICBQSVhJLmdsLmJpbmRUZXh0dXJlKFBJWEkuZ2wuVEVYVFVSRV8yRCwgdW5pZm9ybS52YWx1ZS5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlKTsKICAgICAgICAgICAgICAgIFBJWEkuZ2wudW5pZm9ybTFpKHVuaWZvcm0udW5pZm9ybUxvY2F0aW9uLCB0aGlzLnRleHR1cmVDb3VudCk7CiAgICAgICAgICAgICAgICB0aGlzLnRleHR1cmVDb3VudCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5pbml0U2FtcGxlcjJEKHVuaWZvcm0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKfTsKClBJWEkuUGl4aVNoYWRlci5kZWZhdWx0VmVydGV4U3JjID0gWwogICAgJ2F0dHJpYnV0ZSB2ZWMyIGFWZXJ0ZXhQb3NpdGlvbjsnLAogICAgJ2F0dHJpYnV0ZSB2ZWMyIGFUZXh0dXJlQ29vcmQ7JywKICAgICdhdHRyaWJ1dGUgZmxvYXQgYUNvbG9yOycsCgogICAgJ3VuaWZvcm0gdmVjMiBwcm9qZWN0aW9uVmVjdG9yOycsCiAgICAndW5pZm9ybSB2ZWMyIG9mZnNldFZlY3RvcjsnLAogICAgJ3ZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOycsCgogICAgJ3ZhcnlpbmcgZmxvYXQgdkNvbG9yOycsCgogICAgJ2NvbnN0IHZlYzIgY2VudGVyID0gdmVjMigtMS4wLCAxLjApOycsCgogICAgJ3ZvaWQgbWFpbih2b2lkKSB7JywKICAgICcgICBnbF9Qb3NpdGlvbiA9IHZlYzQoICgoYVZlcnRleFBvc2l0aW9uICsgb2Zmc2V0VmVjdG9yKSAvIHByb2plY3Rpb25WZWN0b3IpICsgY2VudGVyICwgMC4wLCAxLjApOycsCiAgICAnICAgdlRleHR1cmVDb29yZCA9IGFUZXh0dXJlQ29vcmQ7JywKICAgICcgICB2Q29sb3IgPSBhQ29sb3I7JywKICAgICd9JwpdOwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgpQSVhJLlByaW1pdGl2ZVNoYWRlciA9IGZ1bmN0aW9uKCkKewogICAgLy8gdGhlIHdlYkdMIHByb2dyYW0uLgogICAgdGhpcy5wcm9ncmFtID0gbnVsbDsKCiAgICB0aGlzLmZyYWdtZW50U3JjID0gWwogICAgICAgICdwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsnLAogICAgICAgICd2YXJ5aW5nIHZlYzQgdkNvbG9yOycsCgogICAgICAgICd2b2lkIG1haW4odm9pZCkgeycsCiAgICAgICAgJyAgIGdsX0ZyYWdDb2xvciA9IHZDb2xvcjsnLAogICAgICAgICd9JwogICAgXTsKCiAgICB0aGlzLnZlcnRleFNyYyAgPSBbCiAgICAgICAgJ2F0dHJpYnV0ZSB2ZWMyIGFWZXJ0ZXhQb3NpdGlvbjsnLAogICAgICAgICdhdHRyaWJ1dGUgdmVjNCBhQ29sb3I7JywKICAgICAgICAndW5pZm9ybSBtYXQzIHRyYW5zbGF0aW9uTWF0cml4OycsCiAgICAgICAgJ3VuaWZvcm0gdmVjMiBwcm9qZWN0aW9uVmVjdG9yOycsCiAgICAgICAgJ3VuaWZvcm0gdmVjMiBvZmZzZXRWZWN0b3I7JywKICAgICAgICAndW5pZm9ybSBmbG9hdCBhbHBoYTsnLAogICAgICAgICd2YXJ5aW5nIHZlYzQgdkNvbG9yOycsCgogICAgICAgICd2b2lkIG1haW4odm9pZCkgeycsCiAgICAgICAgJyAgIHZlYzMgdiA9IHRyYW5zbGF0aW9uTWF0cml4ICogdmVjMyhhVmVydGV4UG9zaXRpb24gLCAxLjApOycsCiAgICAgICAgJyAgIHYgLT0gb2Zmc2V0VmVjdG9yLnh5eDsnLAogICAgICAgICcgICBnbF9Qb3NpdGlvbiA9IHZlYzQoIHYueCAvIHByb2plY3Rpb25WZWN0b3IueCAtMS4wLCB2LnkgLyAtcHJvamVjdGlvblZlY3Rvci55ICsgMS4wICwgMC4wLCAxLjApOycsCiAgICAgICAgJyAgIHZDb2xvciA9IGFDb2xvciAgKiBhbHBoYTsnLAogICAgICAgICd9JwogICAgXTsKfTsKClBJWEkuUHJpbWl0aXZlU2hhZGVyLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgcHJvZ3JhbSA9IFBJWEkuY29tcGlsZVByb2dyYW0odGhpcy52ZXJ0ZXhTcmMsIHRoaXMuZnJhZ21lbnRTcmMpOwoKICAgIHZhciBnbCA9IFBJWEkuZ2w7CgogICAgZ2wudXNlUHJvZ3JhbShwcm9ncmFtKTsKCiAgICAvLyBnZXQgYW5kIHN0b3JlIHRoZSB1bmlmb3JtcyBmb3IgdGhlIHNoYWRlcgogICAgdGhpcy5wcm9qZWN0aW9uVmVjdG9yID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICdwcm9qZWN0aW9uVmVjdG9yJyk7CiAgICB0aGlzLm9mZnNldFZlY3RvciA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAnb2Zmc2V0VmVjdG9yJyk7CgogICAgLy8gZ2V0IGFuZCBzdG9yZSB0aGUgYXR0cmlidXRlcwogICAgdGhpcy5hVmVydGV4UG9zaXRpb24gPSBnbC5nZXRBdHRyaWJMb2NhdGlvbihwcm9ncmFtLCAnYVZlcnRleFBvc2l0aW9uJyk7CiAgICB0aGlzLmNvbG9yQXR0cmlidXRlID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgJ2FDb2xvcicpOwoKICAgIHRoaXMudHJhbnNsYXRpb25NYXRyaXggPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ3RyYW5zbGF0aW9uTWF0cml4Jyk7CiAgICB0aGlzLmFscGhhID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICdhbHBoYScpOwoKICAgIHRoaXMucHJvZ3JhbSA9IHByb2dyYW07Cn07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKClBJWEkuU3RyaXBTaGFkZXIgPSBmdW5jdGlvbigpCnsKICAgIC8vIHRoZSB3ZWJHTCBwcm9ncmFtLi4KICAgIHRoaXMucHJvZ3JhbSA9IG51bGw7CgogICAgdGhpcy5mcmFnbWVudFNyYyA9IFsKICAgICAgICAncHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7JywKICAgICAgICAndmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7JywKICAgICAgICAndmFyeWluZyBmbG9hdCB2Q29sb3I7JywKICAgICAgICAndW5pZm9ybSBmbG9hdCBhbHBoYTsnLAogICAgICAgICd1bmlmb3JtIHNhbXBsZXIyRCB1U2FtcGxlcjsnLAoKICAgICAgICAndm9pZCBtYWluKHZvaWQpIHsnLAogICAgICAgICcgICBnbF9GcmFnQ29sb3IgPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54LCB2VGV4dHVyZUNvb3JkLnkpKTsnLAogICAgICAgICcgICBnbF9GcmFnQ29sb3IgPSBnbF9GcmFnQ29sb3IgKiBhbHBoYTsnLAogICAgICAgICd9JwogICAgXTsKCiAgICB0aGlzLnZlcnRleFNyYyA9IFsKICAgICAgICAnYXR0cmlidXRlIHZlYzIgYVZlcnRleFBvc2l0aW9uOycsCiAgICAgICAgJ2F0dHJpYnV0ZSB2ZWMyIGFUZXh0dXJlQ29vcmQ7JywKICAgICAgICAnYXR0cmlidXRlIGZsb2F0IGFDb2xvcjsnLAogICAgICAgICd1bmlmb3JtIG1hdDMgdHJhbnNsYXRpb25NYXRyaXg7JywKICAgICAgICAndW5pZm9ybSB2ZWMyIHByb2plY3Rpb25WZWN0b3I7JywKICAgICAgICAndW5pZm9ybSB2ZWMyIG9mZnNldFZlY3RvcjsnLAogICAgICAgICd2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsnLAogICAgICAgICd2YXJ5aW5nIGZsb2F0IHZDb2xvcjsnLAoKICAgICAgICAndm9pZCBtYWluKHZvaWQpIHsnLAogICAgICAgICcgICB2ZWMzIHYgPSB0cmFuc2xhdGlvbk1hdHJpeCAqIHZlYzMoYVZlcnRleFBvc2l0aW9uLCAxLjApOycsCiAgICAgICAgJyAgIHYgLT0gb2Zmc2V0VmVjdG9yLnh5eDsnLAogICAgICAgICcgICBnbF9Qb3NpdGlvbiA9IHZlYzQoIHYueCAvIHByb2plY3Rpb25WZWN0b3IueCAtMS4wLCB2LnkgLyBwcm9qZWN0aW9uVmVjdG9yLnkgKyAxLjAgLCAwLjAsIDEuMCk7JywKICAgICAgICAnICAgdlRleHR1cmVDb29yZCA9IGFUZXh0dXJlQ29vcmQ7JywKICAgICAgICAnICAgdkNvbG9yID0gYUNvbG9yOycsCiAgICAgICAgJ30nCiAgICBdOwp9OwoKUElYSS5TdHJpcFNoYWRlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKCkKewogICAgdmFyIHByb2dyYW0gPSBQSVhJLmNvbXBpbGVQcm9ncmFtKHRoaXMudmVydGV4U3JjLCB0aGlzLmZyYWdtZW50U3JjKTsKCiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIGdsLnVzZVByb2dyYW0ocHJvZ3JhbSk7CgogICAgLy8gZ2V0IGFuZCBzdG9yZSB0aGUgdW5pZm9ybXMgZm9yIHRoZSBzaGFkZXIKICAgIHRoaXMudVNhbXBsZXIgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ3VTYW1wbGVyJyk7CiAgICB0aGlzLnByb2plY3Rpb25WZWN0b3IgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ3Byb2plY3Rpb25WZWN0b3InKTsKICAgIHRoaXMub2Zmc2V0VmVjdG9yID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICdvZmZzZXRWZWN0b3InKTsKICAgIHRoaXMuY29sb3JBdHRyaWJ1dGUgPSBnbC5nZXRBdHRyaWJMb2NhdGlvbihwcm9ncmFtLCAnYUNvbG9yJyk7CiAgICAvL3RoaXMuZGltZW5zaW9ucyA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbih0aGlzLnByb2dyYW0sICdkaW1lbnNpb25zJyk7CgogICAgLy8gZ2V0IGFuZCBzdG9yZSB0aGUgYXR0cmlidXRlcwogICAgdGhpcy5hVmVydGV4UG9zaXRpb24gPSBnbC5nZXRBdHRyaWJMb2NhdGlvbihwcm9ncmFtLCAnYVZlcnRleFBvc2l0aW9uJyk7CiAgICB0aGlzLmFUZXh0dXJlQ29vcmQgPSBnbC5nZXRBdHRyaWJMb2NhdGlvbihwcm9ncmFtLCAnYVRleHR1cmVDb29yZCcpOwoKICAgIHRoaXMudHJhbnNsYXRpb25NYXRyaXggPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ3RyYW5zbGF0aW9uTWF0cml4Jyk7CiAgICB0aGlzLmFscGhhID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICdhbHBoYScpOwoKICAgIHRoaXMucHJvZ3JhbSA9IHByb2dyYW07Cn07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKUElYSS5fYmF0Y2hzID0gW107CgovKioKICogQHByaXZhdGUKICovClBJWEkuX2dldEJhdGNoID0gZnVuY3Rpb24oZ2wpCnsKICAgIGlmKFBJWEkuX2JhdGNocy5sZW5ndGggPT09IDApCiAgICB7CiAgICAgICAgcmV0dXJuIG5ldyBQSVhJLldlYkdMQmF0Y2goZ2wpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHJldHVybiBQSVhJLl9iYXRjaHMucG9wKCk7CiAgICB9Cn07CgovKioKICogQHByaXZhdGUKICovClBJWEkuX3JldHVybkJhdGNoID0gZnVuY3Rpb24oYmF0Y2gpCnsKICAgIGJhdGNoLmNsZWFuKCk7CiAgICBQSVhJLl9iYXRjaHMucHVzaChiYXRjaCk7Cn07CgovKioKICogQHByaXZhdGUKICovClBJWEkuX3Jlc3RvcmVCYXRjaHMgPSBmdW5jdGlvbihnbCkKewogICAgZm9yICh2YXIgaT0wOyBpIDwgUElYSS5fYmF0Y2hzLmxlbmd0aDsgaSsrKQogICAgewogICAgICAgIFBJWEkuX2JhdGNoc1tpXS5yZXN0b3JlTG9zdENvbnRleHQoZ2wpOwogICAgfQp9OwoKLyoqCiAqIEEgV2ViR0xCYXRjaCBFbmFibGVzIGEgZ3JvdXAgb2Ygc3ByaXRlcyB0byBiZSBkcmF3biB1c2luZyB0aGUgc2FtZSBzZXR0aW5ncy4KICogaWYgYSBncm91cCBvZiBzcHJpdGVzIGFsbCBoYXZlIHRoZSBzYW1lIGJhc2VUZXh0dXJlIGFuZCBibGVuZE1vZGUgdGhlbiB0aGV5IGNhbiBiZSBncm91cGVkIGludG8gYSBiYXRjaC4KICogQWxsIHRoZSBzcHJpdGVzIGluIGEgYmF0Y2ggY2FuIHRoZW4gYmUgZHJhd24gaW4gb25lIGdvIGJ5IHRoZSBHUFUgd2hpY2ggaXMgaHVnZWx5IGVmZmljaWVudC4gQUxMIHNwcml0ZXMKICogaW4gdGhlIHdlYkdMIHJlbmRlcmVyIGFyZSBhZGRlZCB0byBhIGJhdGNoIGV2ZW4gaWYgdGhlIGJhdGNoIG9ubHkgY29udGFpbnMgb25lIHNwcml0ZS4gQmF0Y2hpbmcgaXMgaGFuZGxlZAogKiBhdXRvbWF0aWNhbGx5IGJ5IHRoZSB3ZWJHTCByZW5kZXJlci4gQSBnb29kIHRpcCBpczogdGhlIHNtYWxsZXIgdGhlIG51bWJlciBvZiBiYXRjaHMgdGhlcmUgYXJlLCB0aGUgZmFzdGVyCiAqIHRoZSB3ZWJHTCByZW5kZXJlciB3aWxsIHJ1bi4KICoKICogQGNsYXNzIFdlYkdMQmF0Y2gKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSBnbCB7V2ViR0xDb250ZXh0fSBhbiBpbnN0YW5jZSBvZiB0aGUgd2ViR0wgY29udGV4dAogKi8KUElYSS5XZWJHTEJhdGNoID0gZnVuY3Rpb24oZ2wpCnsKICAgIHRoaXMuZ2wgPSBnbDsKCiAgICB0aGlzLnNpemUgPSAwOwoKICAgIHRoaXMudmVydGV4QnVmZmVyID0gIGdsLmNyZWF0ZUJ1ZmZlcigpOwogICAgdGhpcy5pbmRleEJ1ZmZlciA9ICBnbC5jcmVhdGVCdWZmZXIoKTsKICAgIHRoaXMudXZCdWZmZXIgPSAgZ2wuY3JlYXRlQnVmZmVyKCk7CiAgICB0aGlzLmNvbG9yQnVmZmVyID0gIGdsLmNyZWF0ZUJ1ZmZlcigpOwogICAgdGhpcy5ibGVuZE1vZGUgPSBQSVhJLmJsZW5kTW9kZXMuTk9STUFMOwogICAgdGhpcy5keW5hbWljU2l6ZSA9IDE7Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5XZWJHTEJhdGNoOwoKLyoqCiAqIENsZWFucyB0aGUgYmF0Y2ggc28gdGhhdCBpcyBjYW4gYmUgcmV0dXJuZWQgdG8gYW4gb2JqZWN0IHBvb2wgYW5kIHJldXNlZAogKgogKiBAbWV0aG9kIGNsZWFuCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLmNsZWFuID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLnZlcnRpY2llcyA9IFtdOwogICAgdGhpcy51dnMgPSBbXTsKICAgIHRoaXMuaW5kaWNlcyA9IFtdOwogICAgdGhpcy5jb2xvcnMgPSBbXTsKICAgIHRoaXMuZHluYW1pY1NpemUgPSAxOwogICAgdGhpcy50ZXh0dXJlID0gbnVsbDsKICAgIHRoaXMubGFzdCA9IG51bGw7CiAgICB0aGlzLnNpemUgPSAwOwogICAgdGhpcy5oZWFkID0gbnVsbDsKICAgIHRoaXMudGFpbCA9IG51bGw7Cn07CgovKioKICogUmVjcmVhdGVzIHRoZSBidWZmZXJzIGluIHRoZSBldmVudCBvZiBhIGNvbnRleHQgbG9zcwogKgogKiBAbWV0aG9kIHJlc3RvcmVMb3N0Q29udGV4dAogKiBAcGFyYW0gZ2wge1dlYkdMQ29udGV4dH0KICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUucmVzdG9yZUxvc3RDb250ZXh0ID0gZnVuY3Rpb24oZ2wpCnsKICAgIHRoaXMuZ2wgPSBnbDsKICAgIHRoaXMudmVydGV4QnVmZmVyID0gIGdsLmNyZWF0ZUJ1ZmZlcigpOwogICAgdGhpcy5pbmRleEJ1ZmZlciA9ICBnbC5jcmVhdGVCdWZmZXIoKTsKICAgIHRoaXMudXZCdWZmZXIgPSAgZ2wuY3JlYXRlQnVmZmVyKCk7CiAgICB0aGlzLmNvbG9yQnVmZmVyID0gIGdsLmNyZWF0ZUJ1ZmZlcigpOwp9OwoKLyoqCiAqIGluaXRzIHRoZSBiYXRjaCdzIHRleHR1cmUgYW5kIGJsZW5kIG1vZGUgYmFzZWQgaWYgdGhlIHN1cHBsaWVkIHNwcml0ZQogKgogKiBAbWV0aG9kIGluaXQKICogQHBhcmFtIHNwcml0ZSB7U3ByaXRlfSB0aGUgZmlyc3Qgc3ByaXRlIHRvIGJlIGFkZGVkIHRvIHRoZSBiYXRjaC4gT25seSBzcHJpdGVzIHdpdGgKICogICAgICB0aGUgc2FtZSBiYXNlIHRleHR1cmUgYW5kIGJsZW5kIG1vZGUgd2lsbCBiZSBhbGxvd2VkIHRvIGJlIGFkZGVkIHRvIHRoaXMgYmF0Y2gKICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKHNwcml0ZSkKewogICAgc3ByaXRlLmJhdGNoID0gdGhpczsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgdGhpcy5ibGVuZE1vZGUgPSBzcHJpdGUuYmxlbmRNb2RlOwogICAgdGhpcy50ZXh0dXJlID0gc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmU7CiAgICB0aGlzLmhlYWQgPSBzcHJpdGU7CiAgICB0aGlzLnRhaWwgPSBzcHJpdGU7CiAgICB0aGlzLnNpemUgPSAxOwoKICAgIHRoaXMuZ3Jvd0JhdGNoKCk7Cn07CgovKioKICogaW5zZXJ0cyBhIHNwcml0ZSBiZWZvcmUgdGhlIHNwZWNpZmllZCBzcHJpdGUKICoKICogQG1ldGhvZCBpbnNlcnRCZWZvcmUKICogQHBhcmFtIHNwcml0ZSB7U3ByaXRlfSB0aGUgc3ByaXRlIHRvIGJlIGFkZGVkCiAqIEBwYXJhbSBuZXh0U3ByaXRlIHtuZXh0U3ByaXRlfSB0aGUgZmlyc3Qgc3ByaXRlIHdpbGwgYmUgaW5zZXJ0ZWQgYmVmb3JlIHRoaXMgc3ByaXRlCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLmluc2VydEJlZm9yZSA9IGZ1bmN0aW9uKHNwcml0ZSwgbmV4dFNwcml0ZSkKewogICAgdGhpcy5zaXplKys7CgogICAgc3ByaXRlLmJhdGNoID0gdGhpczsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgdmFyIHRlbXBQcmV2ID0gbmV4dFNwcml0ZS5fX3ByZXY7CiAgICBuZXh0U3ByaXRlLl9fcHJldiA9IHNwcml0ZTsKICAgIHNwcml0ZS5fX25leHQgPSBuZXh0U3ByaXRlOwoKICAgIGlmKHRlbXBQcmV2KQogICAgewogICAgICAgIHNwcml0ZS5fX3ByZXYgPSB0ZW1wUHJldjsKICAgICAgICB0ZW1wUHJldi5fX25leHQgPSBzcHJpdGU7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5oZWFkID0gc3ByaXRlOwogICAgfQp9OwoKLyoqCiAqIGluc2VydHMgYSBzcHJpdGUgYWZ0ZXIgdGhlIHNwZWNpZmllZCBzcHJpdGUKICoKICogQG1ldGhvZCBpbnNlcnRBZnRlcgogKiBAcGFyYW0gc3ByaXRlIHtTcHJpdGV9IHRoZSBzcHJpdGUgdG8gYmUgYWRkZWQKICogQHBhcmFtICBwcmV2aW91c1Nwcml0ZSB7U3ByaXRlfSB0aGUgZmlyc3Qgc3ByaXRlIHdpbGwgYmUgaW5zZXJ0ZWQgYWZ0ZXIgdGhpcyBzcHJpdGUKICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUuaW5zZXJ0QWZ0ZXIgPSBmdW5jdGlvbihzcHJpdGUsIHByZXZpb3VzU3ByaXRlKQp7CiAgICB0aGlzLnNpemUrKzsKCiAgICBzcHJpdGUuYmF0Y2ggPSB0aGlzOwogICAgdGhpcy5kaXJ0eSA9IHRydWU7CgogICAgdmFyIHRlbXBOZXh0ID0gcHJldmlvdXNTcHJpdGUuX19uZXh0OwogICAgcHJldmlvdXNTcHJpdGUuX19uZXh0ID0gc3ByaXRlOwogICAgc3ByaXRlLl9fcHJldiA9IHByZXZpb3VzU3ByaXRlOwoKICAgIGlmKHRlbXBOZXh0KQogICAgewogICAgICAgIHNwcml0ZS5fX25leHQgPSB0ZW1wTmV4dDsKICAgICAgICB0ZW1wTmV4dC5fX3ByZXYgPSBzcHJpdGU7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy50YWlsID0gc3ByaXRlOwogICAgfQp9OwoKLyoqCiAqIHJlbW92ZXMgYSBzcHJpdGUgZnJvbSB0aGUgYmF0Y2gKICoKICogQG1ldGhvZCByZW1vdmUKICogQHBhcmFtIHNwcml0ZSB7U3ByaXRlfSB0aGUgc3ByaXRlIHRvIGJlIHJlbW92ZWQKICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24oc3ByaXRlKQp7CiAgICB0aGlzLnNpemUtLTsKCiAgICBpZih0aGlzLnNpemUgPT09IDApCiAgICB7CiAgICAgICAgc3ByaXRlLmJhdGNoID0gbnVsbDsKICAgICAgICBzcHJpdGUuX19wcmV2ID0gbnVsbDsKICAgICAgICBzcHJpdGUuX19uZXh0ID0gbnVsbDsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgaWYoc3ByaXRlLl9fcHJldikKICAgIHsKICAgICAgICBzcHJpdGUuX19wcmV2Ll9fbmV4dCA9IHNwcml0ZS5fX25leHQ7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5oZWFkID0gc3ByaXRlLl9fbmV4dDsKICAgICAgICB0aGlzLmhlYWQuX19wcmV2ID0gbnVsbDsKICAgIH0KCiAgICBpZihzcHJpdGUuX19uZXh0KQogICAgewogICAgICAgIHNwcml0ZS5fX25leHQuX19wcmV2ID0gc3ByaXRlLl9fcHJldjsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLnRhaWwgPSBzcHJpdGUuX19wcmV2OwogICAgICAgIHRoaXMudGFpbC5fX25leHQgPSBudWxsOwogICAgfQoKICAgIHNwcml0ZS5iYXRjaCA9IG51bGw7CiAgICBzcHJpdGUuX19uZXh0ID0gbnVsbDsKICAgIHNwcml0ZS5fX3ByZXYgPSBudWxsOwogICAgdGhpcy5kaXJ0eSA9IHRydWU7Cn07CgovKioKICogU3BsaXRzIHRoZSBiYXRjaCBpbnRvIHR3byB3aXRoIHRoZSBzcGVjaWZpZWQgc3ByaXRlIGJlaW5nIHRoZSBzdGFydCBvZiB0aGUgbmV3IGJhdGNoLgogKgogKiBAbWV0aG9kIHNwbGl0CiAqIEBwYXJhbSBzcHJpdGUge1Nwcml0ZX0gdGhlIHNwcml0ZSB0aGF0IGluZGljYXRlcyB3aGVyZSB0aGUgYmF0Y2ggc2hvdWxkIGJlIHNwbGl0CiAqIEByZXR1cm4ge1dlYkdMQmF0Y2h9IHRoZSBuZXcgYmF0Y2gKICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUuc3BsaXQgPSBmdW5jdGlvbihzcHJpdGUpCnsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwoKICAgIHZhciBiYXRjaCA9IG5ldyBQSVhJLldlYkdMQmF0Y2godGhpcy5nbCk7CiAgICBiYXRjaC5pbml0KHNwcml0ZSk7CiAgICBiYXRjaC50ZXh0dXJlID0gdGhpcy50ZXh0dXJlOwogICAgYmF0Y2gudGFpbCA9IHRoaXMudGFpbDsKCiAgICB0aGlzLnRhaWwgPSBzcHJpdGUuX19wcmV2OwogICAgdGhpcy50YWlsLl9fbmV4dCA9IG51bGw7CgogICAgc3ByaXRlLl9fcHJldiA9IG51bGw7CiAgICAvLyByZXR1cm4gYSBzcGxpdGUgYmF0Y2ghCgogICAgLy8gVE9ETyB0aGlzIHNpemUgaXMgd3JvbmchCiAgICAvLyBuZWVkIHRvIHJlY2FsY3VsYXRlIDovIHByb2JsZW0gd2l0aCBhIGxpbmtlZCBsaXN0IQogICAgLy8gdW5sZXNzIGl0IGdldHMgY2FsY3VsYXRlZCBpbiB0aGUgImNsZWFuIj8KCiAgICAvLyBuZWVkIHRvIGxvb3AgdGhyb3VnaCBpdGVtcyBhcyB0aGVyZSBpcyBubyB3YXkgdG8ga25vdyB0aGUgbGVuZ3RoIG9uIGEgbGlua2VkIGxpc3QgOi8KICAgIHZhciB0ZW1wU2l6ZSA9IDA7CiAgICB3aGlsZShzcHJpdGUpCiAgICB7CiAgICAgICAgdGVtcFNpemUrKzsKICAgICAgICBzcHJpdGUuYmF0Y2ggPSBiYXRjaDsKICAgICAgICBzcHJpdGUgPSBzcHJpdGUuX19uZXh0OwogICAgfQoKICAgIGJhdGNoLnNpemUgPSB0ZW1wU2l6ZTsKICAgIHRoaXMuc2l6ZSAtPSB0ZW1wU2l6ZTsKCiAgICByZXR1cm4gYmF0Y2g7Cn07CgovKioKICogTWVyZ2VzIHR3byBiYXRjaHMgdG9nZXRoZXIKICoKICogQG1ldGhvZCBtZXJnZQogKiBAcGFyYW0gYmF0Y2gge1dlYkdMQmF0Y2h9IHRoZSBiYXRjaCB0aGF0IHdpbGwgYmUgbWVyZ2VkCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLm1lcmdlID0gZnVuY3Rpb24oYmF0Y2gpCnsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwoKICAgIHRoaXMudGFpbC5fX25leHQgPSBiYXRjaC5oZWFkOwogICAgYmF0Y2guaGVhZC5fX3ByZXYgPSB0aGlzLnRhaWw7CgogICAgdGhpcy5zaXplICs9IGJhdGNoLnNpemU7CgogICAgdGhpcy50YWlsID0gYmF0Y2gudGFpbDsKCiAgICB2YXIgc3ByaXRlID0gYmF0Y2guaGVhZDsKICAgIHdoaWxlKHNwcml0ZSkKICAgIHsKICAgICAgICBzcHJpdGUuYmF0Y2ggPSB0aGlzOwogICAgICAgIHNwcml0ZSA9IHNwcml0ZS5fX25leHQ7CiAgICB9Cn07CgovKioKICogR3Jvd3MgdGhlIHNpemUgb2YgdGhlIGJhdGNoLiBBcyB0aGUgZWxlbWVudHMgaW4gdGhlIGJhdGNoIGNhbm5vdCBoYXZlIGEgZHluYW1pYyBzaXplIHRoaXMKICogZnVuY3Rpb24gaXMgdXNlZCB0byBpbmNyZWFzZSB0aGUgc2l6ZSBvZiB0aGUgYmF0Y2guIEl0IGFsc28gY3JlYXRlcyBhIGxpdHRsZSBleHRyYSByb29tIHNvCiAqIHRoYXQgdGhlIGJhdGNoIGRvZXMgbm90IG5lZWQgdG8gYmUgcmVzaXplZCBldmVyeSB0aW1lIGEgc3ByaXRlIGlzIGFkZGVkCiAqCiAqIEBtZXRob2QgZ3Jvd0JhdGNoCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLmdyb3dCYXRjaCA9IGZ1bmN0aW9uKCkKewogICAgdmFyIGdsID0gdGhpcy5nbDsKICAgIGlmKCB0aGlzLnNpemUgPT09IDEpCiAgICB7CiAgICAgICAgdGhpcy5keW5hbWljU2l6ZSA9IDE7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5keW5hbWljU2l6ZSA9IHRoaXMuc2l6ZSAqIDEuNTsKICAgIH0KCiAgICAvLyBncm93IHZlcnRzCiAgICB0aGlzLnZlcnRpY2llcyA9IG5ldyBGbG9hdDMyQXJyYXkodGhpcy5keW5hbWljU2l6ZSAqIDgpOwoKICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlcik7CiAgICBnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUix0aGlzLnZlcnRpY2llcyAsIGdsLkRZTkFNSUNfRFJBVyk7CgogICAgdGhpcy51dnMgID0gbmV3IEZsb2F0MzJBcnJheSggdGhpcy5keW5hbWljU2l6ZSAqIDggKTsKICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnV2QnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnV2cyAsIGdsLkRZTkFNSUNfRFJBVyk7CgogICAgdGhpcy5kaXJ0eVVWUyA9IHRydWU7CgogICAgdGhpcy5jb2xvcnMgID0gbmV3IEZsb2F0MzJBcnJheSggdGhpcy5keW5hbWljU2l6ZSAqIDQgKTsKICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLmNvbG9yQnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLmNvbG9ycyAsIGdsLkRZTkFNSUNfRFJBVyk7CgogICAgdGhpcy5kaXJ0eUNvbG9ycyA9IHRydWU7CgogICAgdGhpcy5pbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KHRoaXMuZHluYW1pY1NpemUgKiA2KTsKICAgIHZhciBsZW5ndGggPSB0aGlzLmluZGljZXMubGVuZ3RoLzY7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykKICAgIHsKICAgICAgICB2YXIgaW5kZXgyID0gaSAqIDY7CiAgICAgICAgdmFyIGluZGV4MyA9IGkgKiA0OwogICAgICAgIHRoaXMuaW5kaWNlc1tpbmRleDIgKyAwXSA9IGluZGV4MyArIDA7CiAgICAgICAgdGhpcy5pbmRpY2VzW2luZGV4MiArIDFdID0gaW5kZXgzICsgMTsKICAgICAgICB0aGlzLmluZGljZXNbaW5kZXgyICsgMl0gPSBpbmRleDMgKyAyOwogICAgICAgIHRoaXMuaW5kaWNlc1tpbmRleDIgKyAzXSA9IGluZGV4MyArIDA7CiAgICAgICAgdGhpcy5pbmRpY2VzW2luZGV4MiArIDRdID0gaW5kZXgzICsgMjsKICAgICAgICB0aGlzLmluZGljZXNbaW5kZXgyICsgNV0gPSBpbmRleDMgKyAzOwogICAgfQoKICAgIGdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHRoaXMuaW5kZXhCdWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YShnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgdGhpcy5pbmRpY2VzLCBnbC5TVEFUSUNfRFJBVyk7Cn07CgovKioKICogUmVmcmVzaCdzIGFsbCB0aGUgZGF0YSBpbiB0aGUgYmF0Y2ggYW5kIHN5bmMncyBpdCB3aXRoIHRoZSB3ZWJHTCBidWZmZXJzCiAqCiAqIEBtZXRob2QgcmVmcmVzaAogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5yZWZyZXNoID0gZnVuY3Rpb24oKQp7CiAgICBpZiAodGhpcy5keW5hbWljU2l6ZSA8IHRoaXMuc2l6ZSkKICAgIHsKICAgICAgICB0aGlzLmdyb3dCYXRjaCgpOwogICAgfQoKICAgIHZhciBpbmRleFJ1biA9IDA7CiAgICB2YXIgaW5kZXgsIGNvbG9ySW5kZXg7CgogICAgdmFyIGRpc3BsYXlPYmplY3QgPSB0aGlzLmhlYWQ7CgogICAgd2hpbGUoZGlzcGxheU9iamVjdCkKICAgIHsKICAgICAgICBpbmRleCA9IGluZGV4UnVuICogODsKCiAgICAgICAgdmFyIHRleHR1cmUgPSBkaXNwbGF5T2JqZWN0LnRleHR1cmU7CgogICAgICAgIHZhciBmcmFtZSA9IHRleHR1cmUuZnJhbWU7CiAgICAgICAgdmFyIHR3ID0gdGV4dHVyZS5iYXNlVGV4dHVyZS53aWR0aDsKICAgICAgICB2YXIgdGggPSB0ZXh0dXJlLmJhc2VUZXh0dXJlLmhlaWdodDsKCiAgICAgICAgdGhpcy51dnNbaW5kZXggKyAwXSA9IGZyYW1lLnggLyB0dzsKICAgICAgICB0aGlzLnV2c1tpbmRleCArMV0gPSBmcmFtZS55IC8gdGg7CgogICAgICAgIHRoaXMudXZzW2luZGV4ICsyXSA9IChmcmFtZS54ICsgZnJhbWUud2lkdGgpIC8gdHc7CiAgICAgICAgdGhpcy51dnNbaW5kZXggKzNdID0gZnJhbWUueSAvIHRoOwoKICAgICAgICB0aGlzLnV2c1tpbmRleCArNF0gPSAoZnJhbWUueCArIGZyYW1lLndpZHRoKSAvIHR3OwogICAgICAgIHRoaXMudXZzW2luZGV4ICs1XSA9IChmcmFtZS55ICsgZnJhbWUuaGVpZ2h0KSAvIHRoOwoKICAgICAgICB0aGlzLnV2c1tpbmRleCArNl0gPSBmcmFtZS54IC8gdHc7CiAgICAgICAgdGhpcy51dnNbaW5kZXggKzddID0gKGZyYW1lLnkgKyBmcmFtZS5oZWlnaHQpIC8gdGg7CgogICAgICAgIGRpc3BsYXlPYmplY3QudXBkYXRlRnJhbWUgPSBmYWxzZTsKCiAgICAgICAgY29sb3JJbmRleCA9IGluZGV4UnVuICogNDsKICAgICAgICB0aGlzLmNvbG9yc1tjb2xvckluZGV4XSA9IHRoaXMuY29sb3JzW2NvbG9ySW5kZXggKyAxXSA9IHRoaXMuY29sb3JzW2NvbG9ySW5kZXggKyAyXSA9IHRoaXMuY29sb3JzW2NvbG9ySW5kZXggKyAzXSA9IGRpc3BsYXlPYmplY3Qud29ybGRBbHBoYTsKCiAgICAgICAgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuX19uZXh0OwoKICAgICAgICBpbmRleFJ1bisrOwogICAgfQoKICAgIHRoaXMuZGlydHlVVlMgPSB0cnVlOwogICAgdGhpcy5kaXJ0eUNvbG9ycyA9IHRydWU7Cn07CgovKioKICogVXBkYXRlcyBhbGwgdGhlIHJlbGV2YW50IGdlb21ldHJ5IGFuZCB1cGxvYWRzIHRoZSBkYXRhIHRvIHRoZSBHUFUKICoKICogQG1ldGhvZCB1cGRhdGUKICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgd29ybGRUcmFuc2Zvcm0sIHdpZHRoLCBoZWlnaHQsIGFYLCBhWSwgdzAsIHcxLCBoMCwgaDEsIGluZGV4OwoKICAgIHZhciBhLCBiLCBjLCBkLCB0eCwgdHk7CgogICAgdmFyIGluZGV4UnVuID0gMDsKCiAgICB2YXIgZGlzcGxheU9iamVjdCA9IHRoaXMuaGVhZDsKICAgIHZhciB2ZXJ0aWNpZXMgPSB0aGlzLnZlcnRpY2llczsKICAgIHZhciB1dnMgPSB0aGlzLnV2czsKICAgIHZhciBjb2xvcnMgPSB0aGlzLmNvbG9yczsKCiAgICB3aGlsZShkaXNwbGF5T2JqZWN0KQogICAgewogICAgICAgIGlmKGRpc3BsYXlPYmplY3QudmNvdW50ID09PSBQSVhJLnZpc2libGVDb3VudCkKICAgICAgICB7CiAgICAgICAgICAgIHdpZHRoID0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLndpZHRoOwogICAgICAgICAgICBoZWlnaHQgPSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUuaGVpZ2h0OwoKICAgICAgICAgICAgLy8gVE9ETyB0cmltPz8KICAgICAgICAgICAgYVggPSBkaXNwbGF5T2JqZWN0LmFuY2hvci54Oy8vIC0gZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueAogICAgICAgICAgICBhWSA9IGRpc3BsYXlPYmplY3QuYW5jaG9yLnk7IC8vLSBkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbS55CiAgICAgICAgICAgIHcwID0gd2lkdGggKiAoMS1hWCk7CiAgICAgICAgICAgIHcxID0gd2lkdGggKiAtYVg7CgogICAgICAgICAgICBoMCA9IGhlaWdodCAqICgxLWFZKTsKICAgICAgICAgICAgaDEgPSBoZWlnaHQgKiAtYVk7CgogICAgICAgICAgICBpbmRleCA9IGluZGV4UnVuICogODsKCiAgICAgICAgICAgIHdvcmxkVHJhbnNmb3JtID0gZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybTsKCiAgICAgICAgICAgIGEgPSB3b3JsZFRyYW5zZm9ybVswXTsKICAgICAgICAgICAgYiA9IHdvcmxkVHJhbnNmb3JtWzNdOwogICAgICAgICAgICBjID0gd29ybGRUcmFuc2Zvcm1bMV07CiAgICAgICAgICAgIGQgPSB3b3JsZFRyYW5zZm9ybVs0XTsKICAgICAgICAgICAgdHggPSB3b3JsZFRyYW5zZm9ybVsyXTsKICAgICAgICAgICAgdHkgPSB3b3JsZFRyYW5zZm9ybVs1XTsKCiAgICAgICAgICAgIHZlcnRpY2llc1tpbmRleCArIDAgXSA9IGEgKiB3MSArIGMgKiBoMSArIHR4OwogICAgICAgICAgICB2ZXJ0aWNpZXNbaW5kZXggKyAxIF0gPSBkICogaDEgKyBiICogdzEgKyB0eTsKCiAgICAgICAgICAgIHZlcnRpY2llc1tpbmRleCArIDIgXSA9IGEgKiB3MCArIGMgKiBoMSArIHR4OwogICAgICAgICAgICB2ZXJ0aWNpZXNbaW5kZXggKyAzIF0gPSBkICogaDEgKyBiICogdzAgKyB0eTsKCiAgICAgICAgICAgIHZlcnRpY2llc1tpbmRleCArIDQgXSA9IGEgKiB3MCArIGMgKiBoMCArIHR4OwogICAgICAgICAgICB2ZXJ0aWNpZXNbaW5kZXggKyA1IF0gPSBkICogaDAgKyBiICogdzAgKyB0eTsKCiAgICAgICAgICAgIHZlcnRpY2llc1tpbmRleCArIDZdID0gIGEgKiB3MSArIGMgKiBoMCArIHR4OwogICAgICAgICAgICB2ZXJ0aWNpZXNbaW5kZXggKyA3XSA9ICBkICogaDAgKyBiICogdzEgKyB0eTsKCiAgICAgICAgICAgIGlmKGRpc3BsYXlPYmplY3QudXBkYXRlRnJhbWUgfHwgZGlzcGxheU9iamVjdC50ZXh0dXJlLnVwZGF0ZUZyYW1lKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmRpcnR5VVZTID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICB2YXIgdGV4dHVyZSA9IGRpc3BsYXlPYmplY3QudGV4dHVyZTsKCiAgICAgICAgICAgICAgICB2YXIgZnJhbWUgPSB0ZXh0dXJlLmZyYW1lOwogICAgICAgICAgICAgICAgdmFyIHR3ID0gdGV4dHVyZS5iYXNlVGV4dHVyZS53aWR0aDsKICAgICAgICAgICAgICAgIHZhciB0aCA9IHRleHR1cmUuYmFzZVRleHR1cmUuaGVpZ2h0OwoKICAgICAgICAgICAgICAgIHV2c1tpbmRleCArIDBdID0gZnJhbWUueCAvIHR3OwogICAgICAgICAgICAgICAgdXZzW2luZGV4ICsxXSA9IGZyYW1lLnkgLyB0aDsKCiAgICAgICAgICAgICAgICB1dnNbaW5kZXggKzJdID0gKGZyYW1lLnggKyBmcmFtZS53aWR0aCkgLyB0dzsKICAgICAgICAgICAgICAgIHV2c1tpbmRleCArM10gPSBmcmFtZS55IC8gdGg7CgogICAgICAgICAgICAgICAgdXZzW2luZGV4ICs0XSA9IChmcmFtZS54ICsgZnJhbWUud2lkdGgpIC8gdHc7CiAgICAgICAgICAgICAgICB1dnNbaW5kZXggKzVdID0gKGZyYW1lLnkgKyBmcmFtZS5oZWlnaHQpIC8gdGg7CgogICAgICAgICAgICAgICAgdXZzW2luZGV4ICs2XSA9IGZyYW1lLnggLyB0dzsKICAgICAgICAgICAgICAgIHV2c1tpbmRleCArN10gPSAoZnJhbWUueSArIGZyYW1lLmhlaWdodCkgLyB0aDsKCiAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LnVwZGF0ZUZyYW1lID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRPRE8gdGhpcyBwcm9iYWJseSBjb3VsZCBkbyB3aXRoIHNvbWUgb3B0aW1pc2F0aW9uLi4uLgogICAgICAgICAgICBpZihkaXNwbGF5T2JqZWN0LmNhY2hlQWxwaGEgIT09IGRpc3BsYXlPYmplY3Qud29ybGRBbHBoYSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC5jYWNoZUFscGhhID0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhOwoKICAgICAgICAgICAgICAgIHZhciBjb2xvckluZGV4ID0gaW5kZXhSdW4gKiA0OwogICAgICAgICAgICAgICAgY29sb3JzW2NvbG9ySW5kZXhdID0gY29sb3JzW2NvbG9ySW5kZXggKyAxXSA9IGNvbG9yc1tjb2xvckluZGV4ICsgMl0gPSBjb2xvcnNbY29sb3JJbmRleCArIDNdID0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhOwogICAgICAgICAgICAgICAgdGhpcy5kaXJ0eUNvbG9ycyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaW5kZXggPSBpbmRleFJ1biAqIDg7CgogICAgICAgICAgICB2ZXJ0aWNpZXNbaW5kZXggKyAwIF0gPSB2ZXJ0aWNpZXNbaW5kZXggKyAxIF0gPSB2ZXJ0aWNpZXNbaW5kZXggKyAyIF0gPSB2ZXJ0aWNpZXNbaW5kZXggKyAzIF0gPSB2ZXJ0aWNpZXNbaW5kZXggKyA0IF0gPSB2ZXJ0aWNpZXNbaW5kZXggKyA1IF0gPSB2ZXJ0aWNpZXNbaW5kZXggKyA2XSA9ICB2ZXJ0aWNpZXNbaW5kZXggKyA3XSA9IDA7CiAgICAgICAgfQoKICAgICAgICBpbmRleFJ1bisrOwogICAgICAgIGRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9fbmV4dDsKICAgIH0KfTsKCi8qKgogKiBEcmF3cyB0aGUgYmF0Y2ggdG8gdGhlIGZyYW1lIGJ1ZmZlcgogKgogKiBAbWV0aG9kIHJlbmRlcgogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihzdGFydCwgZW5kKQp7CiAgICBzdGFydCA9IHN0YXJ0IHx8IDA7CgogICAgaWYoZW5kID09PSB1bmRlZmluZWQpCiAgICAgICAgZW5kID0gdGhpcy5zaXplOwoKICAgIGlmKHRoaXMuZGlydHkpCiAgICB7CiAgICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgfQoKICAgIGlmICh0aGlzLnNpemUgPT09IDApcmV0dXJuOwoKICAgIHRoaXMudXBkYXRlKCk7CiAgICB2YXIgZ2wgPSB0aGlzLmdsOwoKICAgIC8vVE9ETyBvcHRpbWl6ZSB0aGlzIQoKICAgIHZhciBzaGFkZXJQcm9ncmFtID0gUElYSS5kZWZhdWx0U2hhZGVyOwoKICAgIC8vZ2wudXNlUHJvZ3JhbShzaGFkZXJQcm9ncmFtKTsKCiAgICAvLyB1cGRhdGUgdGhlIHZlcnRzLi4KICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlcik7CiAgICAvLyBvay4uCiAgICBnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgMCwgdGhpcy52ZXJ0aWNpZXMpOwogICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXJQcm9ncmFtLmFWZXJ0ZXhQb3NpdGlvbiwgMiwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKICAgIC8vIHVwZGF0ZSB0aGUgdXZzCiAgICAvL3ZhciBpc0RlZmF1bHQgPSAoc2hhZGVyUHJvZ3JhbSA9PSBQSVhJLnNoYWRlclByb2dyYW0pCgogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudXZCdWZmZXIpOwoKICAgIGlmKHRoaXMuZGlydHlVVlMpCiAgICB7CiAgICAgICAgdGhpcy5kaXJ0eVVWUyA9IGZhbHNlOwogICAgICAgIGdsLmJ1ZmZlclN1YkRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAgMCwgdGhpcy51dnMpOwogICAgfQoKICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyUHJvZ3JhbS5hVGV4dHVyZUNvb3JkLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwoKICAgIGdsLmFjdGl2ZVRleHR1cmUoZ2wuVEVYVFVSRTApOwogICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgdGhpcy50ZXh0dXJlLl9nbFRleHR1cmUpOwoKICAgIC8vIHVwZGF0ZSBjb2xvciEKICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLmNvbG9yQnVmZmVyKTsKCiAgICBpZih0aGlzLmRpcnR5Q29sb3JzKQogICAgewogICAgICAgIHRoaXMuZGlydHlDb2xvcnMgPSBmYWxzZTsKICAgICAgICBnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgMCwgdGhpcy5jb2xvcnMpOwogICAgfQoKICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyUHJvZ3JhbS5jb2xvckF0dHJpYnV0ZSwgMSwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKICAgIC8vIGRvbnQgbmVlZCB0byB1cGxvYWQhCiAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCB0aGlzLmluZGV4QnVmZmVyKTsKCiAgICB2YXIgbGVuID0gZW5kIC0gc3RhcnQ7CgogICAgLy8gRFJBVyBUSEFUIHRoaXMhCiAgICBnbC5kcmF3RWxlbWVudHMoZ2wuVFJJQU5HTEVTLCBsZW4gKiA2LCBnbC5VTlNJR05FRF9TSE9SVCwgc3RhcnQgKiAyICogNiApOwp9OwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgpQSVhJLldlYkdMRmlsdGVyTWFuYWdlciA9IGZ1bmN0aW9uKHRyYW5zcGFyZW50KQp7CiAgICB0aGlzLnRyYW5zcGFyZW50ID0gdHJhbnNwYXJlbnQ7CgogICAgdGhpcy5maWx0ZXJTdGFjayA9IFtdOwogICAgdGhpcy50ZXh0dXJlUG9vbCA9IFtdOwoKICAgIHRoaXMub2Zmc2V0WCA9IDA7CiAgICB0aGlzLm9mZnNldFkgPSAwOwoKICAgIHRoaXMuaW5pdFNoYWRlckJ1ZmZlcnMoKTsKfTsKCi8vIEFQSQoKUElYSS5XZWJHTEZpbHRlck1hbmFnZXIucHJvdG90eXBlLmJlZ2luID0gZnVuY3Rpb24ocHJvamVjdGlvbiwgYnVmZmVyKQp7CiAgICB0aGlzLndpZHRoID0gcHJvamVjdGlvbi54ICogMjsKICAgIHRoaXMuaGVpZ2h0ID0gLXByb2plY3Rpb24ueSAqIDI7CiAgICB0aGlzLmJ1ZmZlciA9IGJ1ZmZlcjsKfTsKClBJWEkuV2ViR0xGaWx0ZXJNYW5hZ2VyLnByb3RvdHlwZS5wdXNoRmlsdGVyID0gZnVuY3Rpb24oZmlsdGVyQmxvY2spCnsKICAgIHZhciBnbCA9IFBJWEkuZ2w7CgogICAgLy8gZmlsdGVyIHByb2dyYW0KICAgIC8vIE9QVElNSVNBVElPTiAtIHRoZSBmaXJzdCBmaWx0ZXIgaXMgZnJlZSBpZiBpdHMgYSBzaW1wbGUgY29sb3IgY2hhbmdlPwogICAgdGhpcy5maWx0ZXJTdGFjay5wdXNoKGZpbHRlckJsb2NrKTsKCiAgICB2YXIgZmlsdGVyID0gZmlsdGVyQmxvY2suZmlsdGVyUGFzc2VzWzBdOwoKICAgIHRoaXMub2Zmc2V0WCArPSBmaWx0ZXJCbG9jay50YXJnZXQuZmlsdGVyQXJlYS54OwogICAgdGhpcy5vZmZzZXRZICs9IGZpbHRlckJsb2NrLnRhcmdldC5maWx0ZXJBcmVhLnk7CgogICAgdmFyIHRleHR1cmUgPSB0aGlzLnRleHR1cmVQb29sLnBvcCgpOwogICAgaWYoIXRleHR1cmUpCiAgICB7CiAgICAgICAgdGV4dHVyZSA9IG5ldyBQSVhJLkZpbHRlclRleHR1cmUodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRleHR1cmUucmVzaXplKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKICAgIH0KCiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCAgdGV4dHVyZS50ZXh0dXJlKTsKCiAgICB0aGlzLmdldEJvdW5kcyhmaWx0ZXJCbG9jay50YXJnZXQpOwoKICAgIHZhciBmaWx0ZXJBcmVhID0gZmlsdGVyQmxvY2sudGFyZ2V0LmZpbHRlckFyZWE7CgogICAgdmFyIHBhZGlkbmcgPSBmaWx0ZXIucGFkZGluZzsKICAgIGZpbHRlckFyZWEueCAtPSBwYWRpZG5nOwogICAgZmlsdGVyQXJlYS55IC09IHBhZGlkbmc7CiAgICBmaWx0ZXJBcmVhLndpZHRoICs9IHBhZGlkbmcgKiAyOwogICAgZmlsdGVyQXJlYS5oZWlnaHQgKz0gcGFkaWRuZyAqIDI7CgogICAgLy8gY2FwIGZpbHRlciB0byBzY3JlZW4gc2l6ZS4uCiAgICBpZihmaWx0ZXJBcmVhLnggPCAwKWZpbHRlckFyZWEueCA9IDA7CiAgICBpZihmaWx0ZXJBcmVhLndpZHRoID4gdGhpcy53aWR0aClmaWx0ZXJBcmVhLndpZHRoID0gdGhpcy53aWR0aDsKICAgIGlmKGZpbHRlckFyZWEueSA8IDApZmlsdGVyQXJlYS55ID0gMDsKICAgIGlmKGZpbHRlckFyZWEuaGVpZ2h0ID4gdGhpcy5oZWlnaHQpZmlsdGVyQXJlYS5oZWlnaHQgPSB0aGlzLmhlaWdodDsKCiAgICAvL2dsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgIGZpbHRlckFyZWEud2lkdGgsIGZpbHRlckFyZWEuaGVpZ2h0LCAwLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKTsKICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGV4dHVyZS5mcmFtZUJ1ZmZlcik7CgogICAgLy8gc2V0IHZpZXcgcG9ydAogICAgZ2wudmlld3BvcnQoMCwgMCwgZmlsdGVyQXJlYS53aWR0aCwgZmlsdGVyQXJlYS5oZWlnaHQpOwoKICAgIFBJWEkucHJvamVjdGlvbi54ID0gZmlsdGVyQXJlYS53aWR0aC8yOwogICAgUElYSS5wcm9qZWN0aW9uLnkgPSAtZmlsdGVyQXJlYS5oZWlnaHQvMjsKCiAgICBQSVhJLm9mZnNldC54ID0gLWZpbHRlckFyZWEueDsKICAgIFBJWEkub2Zmc2V0LnkgPSAtZmlsdGVyQXJlYS55OwoKICAgIC8vIHVwZGF0ZSBwcm9qZWN0aW9uCiAgICBnbC51bmlmb3JtMmYoUElYSS5kZWZhdWx0U2hhZGVyLnByb2plY3Rpb25WZWN0b3IsIGZpbHRlckFyZWEud2lkdGgvMiwgLWZpbHRlckFyZWEuaGVpZ2h0LzIpOwogICAgZ2wudW5pZm9ybTJmKFBJWEkuZGVmYXVsdFNoYWRlci5vZmZzZXRWZWN0b3IsIC1maWx0ZXJBcmVhLngsIC1maWx0ZXJBcmVhLnkpOwogICAgLy9QSVhJLnByaW1pdGl2ZVByb2dyYW0KCiAgICBnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7CiAgICBnbC5jbGVhckNvbG9yKDAsMCwwLCAwKTsKICAgIGdsLmNsZWFyKGdsLkNPTE9SX0JVRkZFUl9CSVQpOwoKICAgIGZpbHRlckJsb2NrLl9nbEZpbHRlclRleHR1cmUgPSB0ZXh0dXJlOwp9OwoKClBJWEkuV2ViR0xGaWx0ZXJNYW5hZ2VyLnByb3RvdHlwZS5wb3BGaWx0ZXIgPSBmdW5jdGlvbigpCnsKICAgIHZhciBnbCA9IFBJWEkuZ2w7CiAgICB2YXIgZmlsdGVyQmxvY2sgPSB0aGlzLmZpbHRlclN0YWNrLnBvcCgpOwogICAgdmFyIGZpbHRlckFyZWEgPSBmaWx0ZXJCbG9jay50YXJnZXQuZmlsdGVyQXJlYTsKICAgIHZhciB0ZXh0dXJlID0gZmlsdGVyQmxvY2suX2dsRmlsdGVyVGV4dHVyZTsKCiAgICBpZihmaWx0ZXJCbG9jay5maWx0ZXJQYXNzZXMubGVuZ3RoID4gMSkKICAgIHsKICAgICAgICBnbC52aWV3cG9ydCgwLCAwLCBmaWx0ZXJBcmVhLndpZHRoLCBmaWx0ZXJBcmVhLmhlaWdodCk7CgogICAgICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlcik7CgogICAgICAgIHRoaXMudmVydGV4QXJyYXlbMF0gPSAwOwogICAgICAgIHRoaXMudmVydGV4QXJyYXlbMV0gPSBmaWx0ZXJBcmVhLmhlaWdodDsKCiAgICAgICAgdGhpcy52ZXJ0ZXhBcnJheVsyXSA9IGZpbHRlckFyZWEud2lkdGg7CiAgICAgICAgdGhpcy52ZXJ0ZXhBcnJheVszXSA9IGZpbHRlckFyZWEuaGVpZ2h0OwoKICAgICAgICB0aGlzLnZlcnRleEFycmF5WzRdID0gMDsKICAgICAgICB0aGlzLnZlcnRleEFycmF5WzVdID0gMDsKCiAgICAgICAgdGhpcy52ZXJ0ZXhBcnJheVs2XSA9IGZpbHRlckFyZWEud2lkdGg7CiAgICAgICAgdGhpcy52ZXJ0ZXhBcnJheVs3XSA9IDA7CgogICAgICAgIGdsLmJ1ZmZlclN1YkRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAwLCB0aGlzLnZlcnRleEFycmF5KTsKCiAgICAgICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudXZCdWZmZXIpOwogICAgICAgIC8vIG5ub3cgc2V0IHRoZSB1dnMuLgogICAgICAgIHRoaXMudXZBcnJheVsyXSA9IGZpbHRlckFyZWEud2lkdGgvdGhpcy53aWR0aDsKICAgICAgICB0aGlzLnV2QXJyYXlbNV0gPSBmaWx0ZXJBcmVhLmhlaWdodC90aGlzLmhlaWdodDsKICAgICAgICB0aGlzLnV2QXJyYXlbNl0gPSBmaWx0ZXJBcmVhLndpZHRoL3RoaXMud2lkdGg7CiAgICAgICAgdGhpcy51dkFycmF5WzddID0gZmlsdGVyQXJlYS5oZWlnaHQvdGhpcy5oZWlnaHQ7CgogICAgICAgIGdsLmJ1ZmZlclN1YkRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAwLCB0aGlzLnV2QXJyYXkpOwoKICAgICAgICB2YXIgaW5wdXRUZXh0dXJlID0gdGV4dHVyZTsKICAgICAgICB2YXIgb3V0cHV0VGV4dHVyZSA9IHRoaXMudGV4dHVyZVBvb2wucG9wKCk7CiAgICAgICAgaWYoIW91dHB1dFRleHR1cmUpb3V0cHV0VGV4dHVyZSA9IG5ldyBQSVhJLkZpbHRlclRleHR1cmUodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoKICAgICAgICAvLyBuZWVkIHRvIGNsZWFyIHRoaXMgRkJPIGFzIGl0IG1heSBoYXZlIHNvbWUgbGVmdCBvdmVyIGVsZW1lbnRzIGZyb20gYSBwcnZpb3VzIGZpbHRlci4KICAgICAgICBnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIG91dHB1dFRleHR1cmUuZnJhbWVCdWZmZXIgKTsKICAgICAgICBnbC5jbGVhcihnbC5DT0xPUl9CVUZGRVJfQklUKTsKCiAgICAgICAgZ2wuZGlzYWJsZShnbC5CTEVORCk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmlsdGVyQmxvY2suZmlsdGVyUGFzc2VzLmxlbmd0aC0xOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB2YXIgZmlsdGVyUGFzcyA9IGZpbHRlckJsb2NrLmZpbHRlclBhc3Nlc1tpXTsKCiAgICAgICAgICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgb3V0cHV0VGV4dHVyZS5mcmFtZUJ1ZmZlciApOwoKICAgICAgICAgICAgLy8gc2V0IHRleHR1cmUKICAgICAgICAgICAgZ2wuYWN0aXZlVGV4dHVyZShnbC5URVhUVVJFMCk7CiAgICAgICAgICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIGlucHV0VGV4dHVyZS50ZXh0dXJlKTsKCiAgICAgICAgICAgIC8vIGRyYXcgdGV4dHVyZS4uCiAgICAgICAgICAgIC8vZmlsdGVyUGFzcy5hcHBseUZpbHRlclBhc3MoZmlsdGVyQXJlYS53aWR0aCwgZmlsdGVyQXJlYS5oZWlnaHQpOwogICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyUGFzcyhmaWx0ZXJQYXNzLCBmaWx0ZXJBcmVhLCBmaWx0ZXJBcmVhLndpZHRoLCBmaWx0ZXJBcmVhLmhlaWdodCk7CgogICAgICAgICAgICAvLyBzd2FwIHRoZSB0ZXh0dXJlcy4uCiAgICAgICAgICAgIHZhciB0ZW1wID0gaW5wdXRUZXh0dXJlOwogICAgICAgICAgICBpbnB1dFRleHR1cmUgPSBvdXRwdXRUZXh0dXJlOwogICAgICAgICAgICBvdXRwdXRUZXh0dXJlID0gdGVtcDsKICAgICAgICB9CgogICAgICAgIGdsLmVuYWJsZShnbC5CTEVORCk7CgogICAgICAgIHRleHR1cmUgPSBpbnB1dFRleHR1cmU7CiAgICAgICAgdGhpcy50ZXh0dXJlUG9vbC5wdXNoKG91dHB1dFRleHR1cmUpOwogICAgfQoKICAgIHZhciBmaWx0ZXIgPSBmaWx0ZXJCbG9jay5maWx0ZXJQYXNzZXNbZmlsdGVyQmxvY2suZmlsdGVyUGFzc2VzLmxlbmd0aC0xXTsKCiAgICB0aGlzLm9mZnNldFggLT0gZmlsdGVyQXJlYS54OwogICAgdGhpcy5vZmZzZXRZIC09IGZpbHRlckFyZWEueTsKCgogICAgdmFyIHNpemVYID0gdGhpcy53aWR0aDsKICAgIHZhciBzaXplWSA9IHRoaXMuaGVpZ2h0OwoKICAgIHZhciBvZmZzZXRYID0gMDsKICAgIHZhciBvZmZzZXRZID0gMDsKCiAgICB2YXIgYnVmZmVyID0gdGhpcy5idWZmZXI7CgogICAgLy8gdGltZSB0byByZW5kZXIgdGhlIGZpbHRlcnMgdGV4dHVyZSB0byB0aGUgcHJldmlvdXMgc2NlbmUKICAgIGlmKHRoaXMuZmlsdGVyU3RhY2subGVuZ3RoID09PSAwKQogICAgewogICAgICAgIGdsLmNvbG9yTWFzayh0cnVlLCB0cnVlLCB0cnVlLCB0aGlzLnRyYW5zcGFyZW50KTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB2YXIgY3VycmVudEZpbHRlciA9IHRoaXMuZmlsdGVyU3RhY2tbdGhpcy5maWx0ZXJTdGFjay5sZW5ndGgtMV07CiAgICAgICAgZmlsdGVyQXJlYSA9IGN1cnJlbnRGaWx0ZXIudGFyZ2V0LmZpbHRlckFyZWE7CgogICAgICAgIHNpemVYID0gZmlsdGVyQXJlYS53aWR0aDsKICAgICAgICBzaXplWSA9IGZpbHRlckFyZWEuaGVpZ2h0OwoKICAgICAgICBvZmZzZXRYID0gZmlsdGVyQXJlYS54OwogICAgICAgIG9mZnNldFkgPSBmaWx0ZXJBcmVhLnk7CgogICAgICAgIGJ1ZmZlciA9ICBjdXJyZW50RmlsdGVyLl9nbEZpbHRlclRleHR1cmUuZnJhbWVCdWZmZXI7CiAgICB9CgoKCiAgICAvLyBUT0RPIG5lZWQgdG9yZW1vdmUgdGhlYXNlIGdsb2JhbCBlbGVtZW50cy4uCiAgICBQSVhJLnByb2plY3Rpb24ueCA9IHNpemVYLzI7CiAgICBQSVhJLnByb2plY3Rpb24ueSA9IC1zaXplWS8yOwoKICAgIFBJWEkub2Zmc2V0LnggPSBvZmZzZXRYOwogICAgUElYSS5vZmZzZXQueSA9IG9mZnNldFk7CgogICAgZmlsdGVyQXJlYSA9IGZpbHRlckJsb2NrLnRhcmdldC5maWx0ZXJBcmVhOwoKICAgIHZhciB4ID0gZmlsdGVyQXJlYS54LW9mZnNldFg7CiAgICB2YXIgeSA9IGZpbHRlckFyZWEueS1vZmZzZXRZOwoKICAgIC8vIHVwZGF0ZSB0aGUgYnVmZmVycy4uCiAgICAvLyBtYWtlIHN1cmUgdG8gZmxpcCB0aGUgeSEKICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlcik7CgogICAgdGhpcy52ZXJ0ZXhBcnJheVswXSA9IHg7CiAgICB0aGlzLnZlcnRleEFycmF5WzFdID0geSArIGZpbHRlckFyZWEuaGVpZ2h0OwoKICAgIHRoaXMudmVydGV4QXJyYXlbMl0gPSB4ICsgZmlsdGVyQXJlYS53aWR0aDsKICAgIHRoaXMudmVydGV4QXJyYXlbM10gPSB5ICsgZmlsdGVyQXJlYS5oZWlnaHQ7CgogICAgdGhpcy52ZXJ0ZXhBcnJheVs0XSA9IHg7CiAgICB0aGlzLnZlcnRleEFycmF5WzVdID0geTsKCiAgICB0aGlzLnZlcnRleEFycmF5WzZdID0geCArIGZpbHRlckFyZWEud2lkdGg7CiAgICB0aGlzLnZlcnRleEFycmF5WzddID0geTsKCiAgICBnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgMCwgdGhpcy52ZXJ0ZXhBcnJheSk7CgogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudXZCdWZmZXIpOwoKICAgIHRoaXMudXZBcnJheVsyXSA9IGZpbHRlckFyZWEud2lkdGgvdGhpcy53aWR0aDsKICAgIHRoaXMudXZBcnJheVs1XSA9IGZpbHRlckFyZWEuaGVpZ2h0L3RoaXMuaGVpZ2h0OwogICAgdGhpcy51dkFycmF5WzZdID0gZmlsdGVyQXJlYS53aWR0aC90aGlzLndpZHRoOwogICAgdGhpcy51dkFycmF5WzddID0gZmlsdGVyQXJlYS5oZWlnaHQvdGhpcy5oZWlnaHQ7CgogICAgZ2wuYnVmZmVyU3ViRGF0YShnbC5BUlJBWV9CVUZGRVIsIDAsIHRoaXMudXZBcnJheSk7CgogICAgZ2wudmlld3BvcnQoMCwgMCwgc2l6ZVgsIHNpemVZKTsKICAgIC8vIGJpbmQgdGhlIGJ1ZmZlcgogICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCBidWZmZXIgKTsKCiAgICAvLyBzZXQgdGV4dHVyZQogICAgZ2wuYWN0aXZlVGV4dHVyZShnbC5URVhUVVJFMCk7CiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0ZXh0dXJlLnRleHR1cmUpOwoKICAgIC8vIGFwcGx5IQogICAgLy9maWx0ZXIuYXBwbHlGaWx0ZXJQYXNzKHNpemVYLCBzaXplWSk7CiAgICB0aGlzLmFwcGx5RmlsdGVyUGFzcyhmaWx0ZXIsIGZpbHRlckFyZWEsIHNpemVYLCBzaXplWSk7CgogICAgLy8gbm93IHJlc3RvcmUgdGhlIHJlZ3VsYXIgc2hhZGVyLi4KICAgIGdsLnVzZVByb2dyYW0oUElYSS5kZWZhdWx0U2hhZGVyLnByb2dyYW0pOwogICAgZ2wudW5pZm9ybTJmKFBJWEkuZGVmYXVsdFNoYWRlci5wcm9qZWN0aW9uVmVjdG9yLCBzaXplWC8yLCAtc2l6ZVkvMik7CiAgICBnbC51bmlmb3JtMmYoUElYSS5kZWZhdWx0U2hhZGVyLm9mZnNldFZlY3RvciwgLW9mZnNldFgsIC1vZmZzZXRZKTsKCiAgICAvLyByZXR1cm4gdGhlIHRleHR1cmUgdG8gdGhlIHBvb2wKICAgIHRoaXMudGV4dHVyZVBvb2wucHVzaCh0ZXh0dXJlKTsKICAgIGZpbHRlckJsb2NrLl9nbEZpbHRlclRleHR1cmUgPSBudWxsOwp9OwoKUElYSS5XZWJHTEZpbHRlck1hbmFnZXIucHJvdG90eXBlLmFwcGx5RmlsdGVyUGFzcyA9IGZ1bmN0aW9uKGZpbHRlciwgZmlsdGVyQXJlYSwgd2lkdGgsIGhlaWdodCkKewogICAgLy8gdXNlIHByb2dyYW0KICAgIHZhciBnbCA9IFBJWEkuZ2w7CiAgICB2YXIgc2hhZGVyID0gZmlsdGVyLnNoYWRlcjsKCiAgICBpZighc2hhZGVyKQogICAgewogICAgICAgIHNoYWRlciA9IG5ldyBQSVhJLlBpeGlTaGFkZXIoKTsKCiAgICAgICAgc2hhZGVyLmZyYWdtZW50U3JjID0gZmlsdGVyLmZyYWdtZW50U3JjOwogICAgICAgIHNoYWRlci51bmlmb3JtcyA9IGZpbHRlci51bmlmb3JtczsKICAgICAgICBzaGFkZXIuaW5pdCgpOwoKICAgICAgICBmaWx0ZXIuc2hhZGVyID0gc2hhZGVyOwogICAgfQoKICAgIC8vIHNldCB0aGUgc2hhZGVyCiAgICBnbC51c2VQcm9ncmFtKHNoYWRlci5wcm9ncmFtKTsKCiAgICBnbC51bmlmb3JtMmYoc2hhZGVyLnByb2plY3Rpb25WZWN0b3IsIHdpZHRoLzIsIC1oZWlnaHQvMik7CiAgICBnbC51bmlmb3JtMmYoc2hhZGVyLm9mZnNldFZlY3RvciwgMCwwKTsKCiAgICBpZihmaWx0ZXIudW5pZm9ybXMuZGltZW5zaW9ucykKICAgIHsKICAgICAgICBmaWx0ZXIudW5pZm9ybXMuZGltZW5zaW9ucy52YWx1ZVswXSA9IHRoaXMud2lkdGg7Ly93aWR0aDsKICAgICAgICBmaWx0ZXIudW5pZm9ybXMuZGltZW5zaW9ucy52YWx1ZVsxXSA9IHRoaXMuaGVpZ2h0Oy8vaGVpZ2h0OwogICAgICAgIGZpbHRlci51bmlmb3Jtcy5kaW1lbnNpb25zLnZhbHVlWzJdID0gdGhpcy52ZXJ0ZXhBcnJheVswXTsKICAgICAgICBmaWx0ZXIudW5pZm9ybXMuZGltZW5zaW9ucy52YWx1ZVszXSA9IHRoaXMudmVydGV4QXJyYXlbNV07Ly9maWx0ZXJBcmVhLmhlaWdodDsKICAgIH0KCiAgICBzaGFkZXIuc3luY1VuaWZvcm1zKCk7CgogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudmVydGV4QnVmZmVyKTsKICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbiwgMiwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKCiAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy51dkJ1ZmZlcik7CiAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlci5hVGV4dHVyZUNvb3JkLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwoKICAgIGdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHRoaXMuaW5kZXhCdWZmZXIpOwoKICAgIC8vIGRyYXcgdGhlIGZpbHRlci4uLgogICAgZ2wuZHJhd0VsZW1lbnRzKGdsLlRSSUFOR0xFUywgNiwgZ2wuVU5TSUdORURfU0hPUlQsIDAgKTsKfTsKClBJWEkuV2ViR0xGaWx0ZXJNYW5hZ2VyLnByb3RvdHlwZS5pbml0U2hhZGVyQnVmZmVycyA9IGZ1bmN0aW9uKCkKewogICAgdmFyIGdsID0gUElYSS5nbDsKCiAgICAvLyBjcmVhdGUgc29tZSBidWZmZXJzCiAgICB0aGlzLnZlcnRleEJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwogICAgdGhpcy51dkJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwogICAgdGhpcy5pbmRleEJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwoKICAgIC8vIGJpbmQgYW5kIHVwbG9hZCB0aGUgdmVydGV4cy4uCiAgICAvLyBrZWVwIGEgcmVmZmVyYW5jZSB0byB0aGUgdmVydGV4RmxvYXREYXRhLi4KICAgIHRoaXMudmVydGV4QXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KFswLjAsIDAuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxLjAsIDAuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwLjAsIDEuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxLjAsIDEuMF0pOwoKICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlcik7CiAgICBnbC5idWZmZXJEYXRhKAogICAgZ2wuQVJSQVlfQlVGRkVSLAogICAgdGhpcy52ZXJ0ZXhBcnJheSwKICAgIGdsLlNUQVRJQ19EUkFXKTsKCgogICAgLy8gYmluZCBhbmQgdXBsb2FkIHRoZSB1diBidWZmZXIKICAgIHRoaXMudXZBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoWzAuMCwgMC4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMS4wLCAwLjAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwLjAsIDEuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEuMCwgMS4wXSk7CgogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudXZCdWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YSgKICAgIGdsLkFSUkFZX0JVRkZFUiwKICAgIHRoaXMudXZBcnJheSwKICAgIGdsLlNUQVRJQ19EUkFXKTsKCiAgICAvLyBiaW5kIGFuZCB1cGxvYWQgdGhlIGluZGV4CiAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCB0aGlzLmluZGV4QnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoCiAgICBnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwKICAgIG5ldyBVaW50MTZBcnJheShbMCwgMSwgMiwgMSwgMywgMl0pLAogICAgZ2wuU1RBVElDX0RSQVcpOwp9OwoKUElYSS5XZWJHTEZpbHRlck1hbmFnZXIucHJvdG90eXBlLmdldEJvdW5kcyA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QpCnsKICAgIC8vIHRpbWUgdG8gZ2V0IHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIHRoZSBvYmplY3QhCiAgICB2YXIgd29ybGRUcmFuc2Zvcm0sIHdpZHRoLCBoZWlnaHQsIGFYLCBhWSwgdzAsIHcxLCBoMCwgaDEsIGRvVGVzdDsKICAgIHZhciBhLCBiLCBjLCBkLCB0eCwgdHksIHgxLCB4MiwgeDMsIHg0LCB5MSwgeTIsIHkzLCB5NDsKCiAgICB2YXIgdGVtcE9iamVjdCA9IGRpc3BsYXlPYmplY3QuZmlyc3Q7CiAgICB2YXIgdGVzdE9iamVjdCA9IGRpc3BsYXlPYmplY3QubGFzdC5faU5leHQ7CgogICAgdmFyIG1heFggPSAtSW5maW5pdHk7CiAgICB2YXIgbWF4WSA9IC1JbmZpbml0eTsKCiAgICB2YXIgbWluWCA9IEluZmluaXR5OwogICAgdmFyIG1pblkgPSBJbmZpbml0eTsKCiAgICBkbwogICAgewogICAgICAgIC8vIFRPRE8gY2FuIGJlIG9wdGltaXplZCEgLSB3aGF0IGlmIHRoZXJlIGlzIG5vIHNjYWxlIC8gcm90YXRpb24/CgogICAgICAgIGlmKHRlbXBPYmplY3QudmlzaWJsZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmKHRlbXBPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2lkdGggPSB0ZW1wT2JqZWN0LnRleHR1cmUuZnJhbWUud2lkdGg7CiAgICAgICAgICAgICAgICBoZWlnaHQgPSB0ZW1wT2JqZWN0LnRleHR1cmUuZnJhbWUuaGVpZ2h0OwoKICAgICAgICAgICAgICAgIC8vIFRPRE8gdHJpbT8/CiAgICAgICAgICAgICAgICBhWCA9IHRlbXBPYmplY3QuYW5jaG9yLng7CiAgICAgICAgICAgICAgICBhWSA9IHRlbXBPYmplY3QuYW5jaG9yLnk7CiAgICAgICAgICAgICAgICB3MCA9IHdpZHRoICogKDEtYVgpOwogICAgICAgICAgICAgICAgdzEgPSB3aWR0aCAqIC1hWDsKCiAgICAgICAgICAgICAgICBoMCA9IGhlaWdodCAqICgxLWFZKTsKICAgICAgICAgICAgICAgIGgxID0gaGVpZ2h0ICogLWFZOwoKICAgICAgICAgICAgICAgIGRvVGVzdCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZih0ZW1wT2JqZWN0IGluc3RhbmNlb2YgUElYSS5HcmFwaGljcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGVtcE9iamVjdC51cGRhdGVGaWx0ZXJCb3VuZHMoKTsKCiAgICAgICAgICAgICAgICB2YXIgYm91bmRzID0gdGVtcE9iamVjdC5ib3VuZHM7CgogICAgICAgICAgICAgICAgd2lkdGggPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICBoZWlnaHQgPSBib3VuZHMuaGVpZ2h0OwoKICAgICAgICAgICAgICAgIHcwID0gYm91bmRzLng7CiAgICAgICAgICAgICAgICB3MSA9IGJvdW5kcy54ICsgYm91bmRzLndpZHRoOwoKICAgICAgICAgICAgICAgIGgwID0gYm91bmRzLnk7CiAgICAgICAgICAgICAgICBoMSA9IGJvdW5kcy55ICsgYm91bmRzLmhlaWdodDsKCiAgICAgICAgICAgICAgICBkb1Rlc3QgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZihkb1Rlc3QpCiAgICAgICAgewogICAgICAgICAgICB3b3JsZFRyYW5zZm9ybSA9IHRlbXBPYmplY3Qud29ybGRUcmFuc2Zvcm07CgogICAgICAgICAgICBhID0gd29ybGRUcmFuc2Zvcm1bMF07CiAgICAgICAgICAgIGIgPSB3b3JsZFRyYW5zZm9ybVszXTsKICAgICAgICAgICAgYyA9IHdvcmxkVHJhbnNmb3JtWzFdOwogICAgICAgICAgICBkID0gd29ybGRUcmFuc2Zvcm1bNF07CiAgICAgICAgICAgIHR4ID0gd29ybGRUcmFuc2Zvcm1bMl07CiAgICAgICAgICAgIHR5ID0gd29ybGRUcmFuc2Zvcm1bNV07CgogICAgICAgICAgICB4MSA9IGEgKiB3MSArIGMgKiBoMSArIHR4OwogICAgICAgICAgICB5MSA9IGQgKiBoMSArIGIgKiB3MSArIHR5OwoKICAgICAgICAgICAgeDIgPSBhICogdzAgKyBjICogaDEgKyB0eDsKICAgICAgICAgICAgeTIgPSBkICogaDEgKyBiICogdzAgKyB0eTsKCiAgICAgICAgICAgIHgzID0gYSAqIHcwICsgYyAqIGgwICsgdHg7CiAgICAgICAgICAgIHkzID0gZCAqIGgwICsgYiAqIHcwICsgdHk7CgogICAgICAgICAgICB4NCA9ICBhICogdzEgKyBjICogaDAgKyB0eDsKICAgICAgICAgICAgeTQgPSAgZCAqIGgwICsgYiAqIHcxICsgdHk7CgogICAgICAgICAgICBtaW5YID0geDEgPCBtaW5YID8geDEgOiBtaW5YOwogICAgICAgICAgICBtaW5YID0geDIgPCBtaW5YID8geDIgOiBtaW5YOwogICAgICAgICAgICBtaW5YID0geDMgPCBtaW5YID8geDMgOiBtaW5YOwogICAgICAgICAgICBtaW5YID0geDQgPCBtaW5YID8geDQgOiBtaW5YOwoKICAgICAgICAgICAgbWluWSA9IHkxIDwgbWluWSA/IHkxIDogbWluWTsKICAgICAgICAgICAgbWluWSA9IHkyIDwgbWluWSA/IHkyIDogbWluWTsKICAgICAgICAgICAgbWluWSA9IHkzIDwgbWluWSA/IHkzIDogbWluWTsKICAgICAgICAgICAgbWluWSA9IHk0IDwgbWluWSA/IHk0IDogbWluWTsKCiAgICAgICAgICAgIG1heFggPSB4MSA+IG1heFggPyB4MSA6IG1heFg7CiAgICAgICAgICAgIG1heFggPSB4MiA+IG1heFggPyB4MiA6IG1heFg7CiAgICAgICAgICAgIG1heFggPSB4MyA+IG1heFggPyB4MyA6IG1heFg7CiAgICAgICAgICAgIG1heFggPSB4NCA+IG1heFggPyB4NCA6IG1heFg7CgogICAgICAgICAgICBtYXhZID0geTEgPiBtYXhZID8geTEgOiBtYXhZOwogICAgICAgICAgICBtYXhZID0geTIgPiBtYXhZID8geTIgOiBtYXhZOwogICAgICAgICAgICBtYXhZID0geTMgPiBtYXhZID8geTMgOiBtYXhZOwogICAgICAgICAgICBtYXhZID0geTQgPiBtYXhZID8geTQgOiBtYXhZOwogICAgICAgIH0KCiAgICAgICAgZG9UZXN0ID0gZmFsc2U7CiAgICAgICAgdGVtcE9iamVjdCA9IHRlbXBPYmplY3QuX2lOZXh0OwoKICAgIH0KICAgIHdoaWxlKHRlbXBPYmplY3QgIT09IHRlc3RPYmplY3QpOwoKICAgIGRpc3BsYXlPYmplY3QuZmlsdGVyQXJlYS54ID0gbWluWDsKICAgIGRpc3BsYXlPYmplY3QuZmlsdGVyQXJlYS55ID0gbWluWTsKCiAgICBkaXNwbGF5T2JqZWN0LmZpbHRlckFyZWEud2lkdGggPSBtYXhYIC0gbWluWDsKICAgIGRpc3BsYXlPYmplY3QuZmlsdGVyQXJlYS5oZWlnaHQgPSBtYXhZIC0gbWluWTsKfTsKClBJWEkuRmlsdGVyVGV4dHVyZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCnsKICAgIHZhciBnbCA9IFBJWEkuZ2w7CgogICAgLy8gbmV4dCB0aW1lIHRvIGNyZWF0ZSBhIGZyYW1lIGJ1ZmZlciBhbmQgdGV4dHVyZQogICAgdGhpcy5mcmFtZUJ1ZmZlciA9IGdsLmNyZWF0ZUZyYW1lYnVmZmVyKCk7CiAgICB0aGlzLnRleHR1cmUgPSBnbC5jcmVhdGVUZXh0dXJlKCk7CgogICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgIHRoaXMudGV4dHVyZSk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUFHX0ZJTFRFUiwgZ2wuTElORUFSKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBnbC5MSU5FQVIpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5DTEFNUF9UT19FREdFKTsKICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGhpcy5mcmFtZWJ1ZmZlciApOwoKICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGhpcy5mcmFtZUJ1ZmZlciApOwogICAgZ2wuZnJhbWVidWZmZXJUZXh0dXJlMkQoZ2wuRlJBTUVCVUZGRVIsIGdsLkNPTE9SX0FUVEFDSE1FTlQwLCBnbC5URVhUVVJFXzJELCB0aGlzLnRleHR1cmUsIDApOwoKICAgIHRoaXMucmVzaXplKHdpZHRoLCBoZWlnaHQpOwp9OwoKUElYSS5GaWx0ZXJUZXh0dXJlLnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KQp7CiAgICBpZih0aGlzLndpZHRoID09PSB3aWR0aCAmJiB0aGlzLmhlaWdodCA9PT0gaGVpZ2h0KSByZXR1cm47CgogICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgdmFyIGdsID0gUElYSS5nbDsKCiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCAgdGhpcy50ZXh0dXJlKTsKICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgIHdpZHRoLCBoZWlnaHQsIDAsIGdsLlJHQkEsIGdsLlVOU0lHTkVEX0JZVEUsIG51bGwpOwoKfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogQSBzZXQgb2YgZnVuY3Rpb25zIHVzZWQgYnkgdGhlIHdlYkdMIHJlbmRlcmVyIHRvIGRyYXcgdGhlIHByaW1pdGl2ZSBncmFwaGljcyBkYXRhCiAqCiAqIEBjbGFzcyBDYW52YXNHcmFwaGljcwogKi8KUElYSS5XZWJHTEdyYXBoaWNzID0gZnVuY3Rpb24oKQp7Cgp9OwoKLyoqCiAqIFJlbmRlcnMgdGhlIGdyYXBoaWNzIG9iamVjdAogKgogKiBAc3RhdGljCiAqIEBwcml2YXRlCiAqIEBtZXRob2QgcmVuZGVyR3JhcGhpY3MKICogQHBhcmFtIGdyYXBoaWNzIHtHcmFwaGljc30KICogQHBhcmFtIHByb2plY3Rpb24ge09iamVjdH0KICovClBJWEkuV2ViR0xHcmFwaGljcy5yZW5kZXJHcmFwaGljcyA9IGZ1bmN0aW9uKGdyYXBoaWNzLCBwcm9qZWN0aW9uKQp7CiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIGlmKCFncmFwaGljcy5fd2ViR0wpZ3JhcGhpY3MuX3dlYkdMID0ge3BvaW50czpbXSwgaW5kaWNlczpbXSwgbGFzdEluZGV4OjAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWZmZXI6Z2wuY3JlYXRlQnVmZmVyKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleEJ1ZmZlcjpnbC5jcmVhdGVCdWZmZXIoKX07CgogICAgaWYoZ3JhcGhpY3MuZGlydHkpCiAgICB7CiAgICAgICAgZ3JhcGhpY3MuZGlydHkgPSBmYWxzZTsKCiAgICAgICAgaWYoZ3JhcGhpY3MuY2xlYXJEaXJ0eSkKICAgICAgICB7CiAgICAgICAgICAgIGdyYXBoaWNzLmNsZWFyRGlydHkgPSBmYWxzZTsKCiAgICAgICAgICAgIGdyYXBoaWNzLl93ZWJHTC5sYXN0SW5kZXggPSAwOwogICAgICAgICAgICBncmFwaGljcy5fd2ViR0wucG9pbnRzID0gW107CiAgICAgICAgICAgIGdyYXBoaWNzLl93ZWJHTC5pbmRpY2VzID0gW107CgogICAgICAgIH0KCiAgICAgICAgUElYSS5XZWJHTEdyYXBoaWNzLnVwZGF0ZUdyYXBoaWNzKGdyYXBoaWNzKTsKICAgIH0KCiAgICBQSVhJLmFjdGl2YXRlUHJpbWl0aXZlU2hhZGVyKCk7CgogICAgLy8gVGhpcyAgY291bGQgYmUgc3BlZWRlZCB1cCBmbyBzdXJlIQogICAgdmFyIG0gPSBQSVhJLm1hdDMuY2xvbmUoZ3JhcGhpY3Mud29ybGRUcmFuc2Zvcm0pOwoKICAgIFBJWEkubWF0My50cmFuc3Bvc2UobSk7CgogICAgLy8gc2V0IHRoZSBtYXRyaXggdHJhbnNmb3JtIGZvciB0aGUKICAgIGdsLmJsZW5kRnVuYyhnbC5PTkUsIGdsLk9ORV9NSU5VU19TUkNfQUxQSEEpOwoKICAgIGdsLnVuaWZvcm1NYXRyaXgzZnYoUElYSS5wcmltaXRpdmVTaGFkZXIudHJhbnNsYXRpb25NYXRyaXgsIGZhbHNlLCBtKTsKCiAgICBnbC51bmlmb3JtMmYoUElYSS5wcmltaXRpdmVTaGFkZXIucHJvamVjdGlvblZlY3RvciwgcHJvamVjdGlvbi54LCAtcHJvamVjdGlvbi55KTsKICAgIGdsLnVuaWZvcm0yZihQSVhJLnByaW1pdGl2ZVNoYWRlci5vZmZzZXRWZWN0b3IsIC1QSVhJLm9mZnNldC54LCAtUElYSS5vZmZzZXQueSk7CgogICAgZ2wudW5pZm9ybTFmKFBJWEkucHJpbWl0aXZlU2hhZGVyLmFscGhhLCBncmFwaGljcy53b3JsZEFscGhhKTsKICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBncmFwaGljcy5fd2ViR0wuYnVmZmVyKTsKCiAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKFBJWEkucHJpbWl0aXZlU2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbiwgMiwgZ2wuRkxPQVQsIGZhbHNlLCA0ICogNiwgMCk7CiAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKFBJWEkucHJpbWl0aXZlU2hhZGVyLmNvbG9yQXR0cmlidXRlLCA0LCBnbC5GTE9BVCwgZmFsc2UsNCAqIDYsIDIgKiA0KTsKCiAgICAvLyBzZXQgdGhlIGluZGV4IGJ1ZmZlciEKICAgIGdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIGdyYXBoaWNzLl93ZWJHTC5pbmRleEJ1ZmZlcik7CgoKICAgIGdsLmRyYXdFbGVtZW50cyhnbC5UUklBTkdMRV9TVFJJUCwgIGdyYXBoaWNzLl93ZWJHTC5pbmRpY2VzLmxlbmd0aCwgZ2wuVU5TSUdORURfU0hPUlQsIDAgKTsKCiAgICBQSVhJLmRlYWN0aXZhdGVQcmltaXRpdmVTaGFkZXIoKTsKCiAgICAvLyByZXR1cm4gdG8gZGVmYXVsdCBzaGFkZXIuLi4KLy8gIFBJWEkuYWN0aXZhdGVTaGFkZXIoUElYSS5kZWZhdWx0U2hhZGVyKTsKfTsKCi8qKgogKiBVcGRhdGVzIHRoZSBncmFwaGljcyBvYmplY3QKICoKICogQHN0YXRpYwogKiBAcHJpdmF0ZQogKiBAbWV0aG9kIHVwZGF0ZUdyYXBoaWNzCiAqIEBwYXJhbSBncmFwaGljcyB7R3JhcGhpY3N9CiAqLwpQSVhJLldlYkdMR3JhcGhpY3MudXBkYXRlR3JhcGhpY3MgPSBmdW5jdGlvbihncmFwaGljcykKewogICAgZm9yICh2YXIgaSA9IGdyYXBoaWNzLl93ZWJHTC5sYXN0SW5kZXg7IGkgPCBncmFwaGljcy5ncmFwaGljc0RhdGEubGVuZ3RoOyBpKyspCiAgICB7CiAgICAgICAgdmFyIGRhdGEgPSBncmFwaGljcy5ncmFwaGljc0RhdGFbaV07CgogICAgICAgIGlmKGRhdGEudHlwZSA9PT0gUElYSS5HcmFwaGljcy5QT0xZKQogICAgICAgIHsKICAgICAgICAgICAgaWYoZGF0YS5maWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZihkYXRhLnBvaW50cy5sZW5ndGg+MykKICAgICAgICAgICAgICAgICAgICBQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRQb2x5KGRhdGEsIGdyYXBoaWNzLl93ZWJHTCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKGRhdGEubGluZVdpZHRoID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgUElYSS5XZWJHTEdyYXBoaWNzLmJ1aWxkTGluZShkYXRhLCBncmFwaGljcy5fd2ViR0wpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoZGF0YS50eXBlID09PSBQSVhJLkdyYXBoaWNzLlJFQ1QpCiAgICAgICAgewogICAgICAgICAgICBQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRSZWN0YW5nbGUoZGF0YSwgZ3JhcGhpY3MuX3dlYkdMKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZihkYXRhLnR5cGUgPT09IFBJWEkuR3JhcGhpY3MuQ0lSQyB8fCBkYXRhLnR5cGUgPT09IFBJWEkuR3JhcGhpY3MuRUxJUCkKICAgICAgICB7CiAgICAgICAgICAgIFBJWEkuV2ViR0xHcmFwaGljcy5idWlsZENpcmNsZShkYXRhLCBncmFwaGljcy5fd2ViR0wpOwogICAgICAgIH0KICAgIH0KCiAgICBncmFwaGljcy5fd2ViR0wubGFzdEluZGV4ID0gZ3JhcGhpY3MuZ3JhcGhpY3NEYXRhLmxlbmd0aDsKCiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIGdyYXBoaWNzLl93ZWJHTC5nbFBvaW50cyA9IG5ldyBGbG9hdDMyQXJyYXkoZ3JhcGhpY3MuX3dlYkdMLnBvaW50cyk7CgogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIGdyYXBoaWNzLl93ZWJHTC5idWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIGdyYXBoaWNzLl93ZWJHTC5nbFBvaW50cywgZ2wuU1RBVElDX0RSQVcpOwoKICAgIGdyYXBoaWNzLl93ZWJHTC5nbEluZGljaWVzID0gbmV3IFVpbnQxNkFycmF5KGdyYXBoaWNzLl93ZWJHTC5pbmRpY2VzKTsKCiAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBncmFwaGljcy5fd2ViR0wuaW5kZXhCdWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YShnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgZ3JhcGhpY3MuX3dlYkdMLmdsSW5kaWNpZXMsIGdsLlNUQVRJQ19EUkFXKTsKfTsKCi8qKgogKiBCdWlsZHMgYSByZWN0YW5nbGUgdG8gZHJhdwogKgogKiBAc3RhdGljCiAqIEBwcml2YXRlCiAqIEBtZXRob2QgYnVpbGRSZWN0YW5nbGUKICogQHBhcmFtIGdyYXBoaWNzIHtHcmFwaGljc30KICogQHBhcmFtIHdlYkdMRGF0YSB7T2JqZWN0fQogKi8KUElYSS5XZWJHTEdyYXBoaWNzLmJ1aWxkUmVjdGFuZ2xlID0gZnVuY3Rpb24oZ3JhcGhpY3NEYXRhLCB3ZWJHTERhdGEpCnsKICAgIC8vIC0tLSAvLwogICAgLy8gbmVlZCB0byBjb252ZXJ0IHBvaW50cyB0byBhIG5pY2UgcmVndWxhciBkYXRhCiAgICAvLwogICAgdmFyIHJlY3REYXRhID0gZ3JhcGhpY3NEYXRhLnBvaW50czsKICAgIHZhciB4ID0gcmVjdERhdGFbMF07CiAgICB2YXIgeSA9IHJlY3REYXRhWzFdOwogICAgdmFyIHdpZHRoID0gcmVjdERhdGFbMl07CiAgICB2YXIgaGVpZ2h0ID0gcmVjdERhdGFbM107CgoKICAgIGlmKGdyYXBoaWNzRGF0YS5maWxsKQogICAgewogICAgICAgIHZhciBjb2xvciA9IFBJWEkuaGV4MnJnYihncmFwaGljc0RhdGEuZmlsbENvbG9yKTsKICAgICAgICB2YXIgYWxwaGEgPSBncmFwaGljc0RhdGEuZmlsbEFscGhhOwoKICAgICAgICB2YXIgciA9IGNvbG9yWzBdICogYWxwaGE7CiAgICAgICAgdmFyIGcgPSBjb2xvclsxXSAqIGFscGhhOwogICAgICAgIHZhciBiID0gY29sb3JbMl0gKiBhbHBoYTsKCiAgICAgICAgdmFyIHZlcnRzID0gd2ViR0xEYXRhLnBvaW50czsKICAgICAgICB2YXIgaW5kaWNlcyA9IHdlYkdMRGF0YS5pbmRpY2VzOwoKICAgICAgICB2YXIgdmVydFBvcyA9IHZlcnRzLmxlbmd0aC82OwoKICAgICAgICAvLyBzdGFydAogICAgICAgIHZlcnRzLnB1c2goeCwgeSk7CiAgICAgICAgdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgogICAgICAgIHZlcnRzLnB1c2goeCArIHdpZHRoLCB5KTsKICAgICAgICB2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCiAgICAgICAgdmVydHMucHVzaCh4ICwgeSArIGhlaWdodCk7CiAgICAgICAgdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgogICAgICAgIHZlcnRzLnB1c2goeCArIHdpZHRoLCB5ICsgaGVpZ2h0KTsKICAgICAgICB2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCiAgICAgICAgLy8gaW5zZXJ0IDIgZGVhZCB0cmlhbmdsZXMuLgogICAgICAgIGluZGljZXMucHVzaCh2ZXJ0UG9zLCB2ZXJ0UG9zLCB2ZXJ0UG9zKzEsIHZlcnRQb3MrMiwgdmVydFBvcyszLCB2ZXJ0UG9zKzMpOwogICAgfQoKICAgIGlmKGdyYXBoaWNzRGF0YS5saW5lV2lkdGgpCiAgICB7CiAgICAgICAgZ3JhcGhpY3NEYXRhLnBvaW50cyA9IFt4LCB5LAogICAgICAgICAgICAgICAgICB4ICsgd2lkdGgsIHksCiAgICAgICAgICAgICAgICAgIHggKyB3aWR0aCwgeSArIGhlaWdodCwKICAgICAgICAgICAgICAgICAgeCwgeSArIGhlaWdodCwKICAgICAgICAgICAgICAgICAgeCwgeV07CgogICAgICAgIFBJWEkuV2ViR0xHcmFwaGljcy5idWlsZExpbmUoZ3JhcGhpY3NEYXRhLCB3ZWJHTERhdGEpOwogICAgfQp9OwoKLyoqCiAqIEJ1aWxkcyBhIGNpcmNsZSB0byBkcmF3CiAqCiAqIEBzdGF0aWMKICogQHByaXZhdGUKICogQG1ldGhvZCBidWlsZENpcmNsZQogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKiBAcGFyYW0gd2ViR0xEYXRhIHtPYmplY3R9CiAqLwpQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRDaXJjbGUgPSBmdW5jdGlvbihncmFwaGljc0RhdGEsIHdlYkdMRGF0YSkKewogICAgLy8gLS0tIC8vCiAgICAvLyBuZWVkIHRvIGNvbnZlcnQgcG9pbnRzIHRvIGEgbmljZSByZWd1bGFyIGRhdGEKICAgIC8vCiAgICB2YXIgcmVjdERhdGEgPSBncmFwaGljc0RhdGEucG9pbnRzOwogICAgdmFyIHggPSByZWN0RGF0YVswXTsKICAgIHZhciB5ID0gcmVjdERhdGFbMV07CiAgICB2YXIgd2lkdGggPSByZWN0RGF0YVsyXTsKICAgIHZhciBoZWlnaHQgPSByZWN0RGF0YVszXTsKCiAgICB2YXIgdG90YWxTZWdzID0gNDA7CiAgICB2YXIgc2VnID0gKE1hdGguUEkgKiAyKSAvIHRvdGFsU2VncyA7CgogICAgdmFyIGkgPSAwOwoKICAgIGlmKGdyYXBoaWNzRGF0YS5maWxsKQogICAgewogICAgICAgIHZhciBjb2xvciA9IFBJWEkuaGV4MnJnYihncmFwaGljc0RhdGEuZmlsbENvbG9yKTsKICAgICAgICB2YXIgYWxwaGEgPSBncmFwaGljc0RhdGEuZmlsbEFscGhhOwoKICAgICAgICB2YXIgciA9IGNvbG9yWzBdICogYWxwaGE7CiAgICAgICAgdmFyIGcgPSBjb2xvclsxXSAqIGFscGhhOwogICAgICAgIHZhciBiID0gY29sb3JbMl0gKiBhbHBoYTsKCiAgICAgICAgdmFyIHZlcnRzID0gd2ViR0xEYXRhLnBvaW50czsKICAgICAgICB2YXIgaW5kaWNlcyA9IHdlYkdMRGF0YS5pbmRpY2VzOwoKICAgICAgICB2YXIgdmVjUG9zID0gdmVydHMubGVuZ3RoLzY7CgogICAgICAgIGluZGljZXMucHVzaCh2ZWNQb3MpOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdG90YWxTZWdzICsgMSA7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZlcnRzLnB1c2goeCx5LCByLCBnLCBiLCBhbHBoYSk7CgogICAgICAgICAgICB2ZXJ0cy5wdXNoKHggKyBNYXRoLnNpbihzZWcgKiBpKSAqIHdpZHRoLAogICAgICAgICAgICAgICAgICAgICAgIHkgKyBNYXRoLmNvcyhzZWcgKiBpKSAqIGhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICByLCBnLCBiLCBhbHBoYSk7CgogICAgICAgICAgICBpbmRpY2VzLnB1c2godmVjUG9zKyssIHZlY1BvcysrKTsKICAgICAgICB9CgogICAgICAgIGluZGljZXMucHVzaCh2ZWNQb3MtMSk7CiAgICB9CgogICAgaWYoZ3JhcGhpY3NEYXRhLmxpbmVXaWR0aCkKICAgIHsKICAgICAgICBncmFwaGljc0RhdGEucG9pbnRzID0gW107CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCB0b3RhbFNlZ3MgKyAxOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBncmFwaGljc0RhdGEucG9pbnRzLnB1c2goeCArIE1hdGguc2luKHNlZyAqIGkpICogd2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5ICsgTWF0aC5jb3Moc2VnICogaSkgKiBoZWlnaHQpOwogICAgICAgIH0KCiAgICAgICAgUElYSS5XZWJHTEdyYXBoaWNzLmJ1aWxkTGluZShncmFwaGljc0RhdGEsIHdlYkdMRGF0YSk7CiAgICB9Cn07CgovKioKICogQnVpbGRzIGEgbGluZSB0byBkcmF3CiAqCiAqIEBzdGF0aWMKICogQHByaXZhdGUKICogQG1ldGhvZCBidWlsZExpbmUKICogQHBhcmFtIGdyYXBoaWNzIHtHcmFwaGljc30KICogQHBhcmFtIHdlYkdMRGF0YSB7T2JqZWN0fQogKi8KUElYSS5XZWJHTEdyYXBoaWNzLmJ1aWxkTGluZSA9IGZ1bmN0aW9uKGdyYXBoaWNzRGF0YSwgd2ViR0xEYXRhKQp7CiAgICAvLyBUT0RPIE9QVElNSVNFIQogICAgdmFyIGkgPSAwOwoKICAgIHZhciBwb2ludHMgPSBncmFwaGljc0RhdGEucG9pbnRzOwogICAgaWYocG9pbnRzLmxlbmd0aCA9PT0gMClyZXR1cm47CgogICAgLy8gaWYgdGhlIGxpbmUgd2lkdGggaXMgYW4gb2RkIG51bWJlciBhZGQgMC41IHRvIGFsaWduIHRvIGEgd2hvbGUgcGl4ZWwKICAgIGlmKGdyYXBoaWNzRGF0YS5saW5lV2lkdGglMikKICAgIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHBvaW50c1tpXSArPSAwLjU7CiAgICAgICAgfQogICAgfQoKICAgIC8vIGdldCBmaXJzdCBhbmQgbGFzdCBwb2ludC4uIGZpZ3VyZSBvdXQgdGhlIG1pZGRsZSEKICAgIHZhciBmaXJzdFBvaW50ID0gbmV3IFBJWEkuUG9pbnQoIHBvaW50c1swXSwgcG9pbnRzWzFdICk7CiAgICB2YXIgbGFzdFBvaW50ID0gbmV3IFBJWEkuUG9pbnQoIHBvaW50c1twb2ludHMubGVuZ3RoIC0gMl0sIHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV0gKTsKCiAgICAvLyBpZiB0aGUgZmlyc3QgcG9pbnQgaXMgdGhlIGxhc3QgcG9pbnQgLSBnb29uYSBoYXZlIGlzc3VlcyA6KQogICAgaWYoZmlyc3RQb2ludC54ID09PSBsYXN0UG9pbnQueCAmJiBmaXJzdFBvaW50LnkgPT09IGxhc3RQb2ludC55KQogICAgewogICAgICAgIHBvaW50cy5wb3AoKTsKICAgICAgICBwb2ludHMucG9wKCk7CgogICAgICAgIGxhc3RQb2ludCA9IG5ldyBQSVhJLlBvaW50KCBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDJdLCBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdICk7CgogICAgICAgIHZhciBtaWRQb2ludFggPSBsYXN0UG9pbnQueCArIChmaXJzdFBvaW50LnggLSBsYXN0UG9pbnQueCkgKjAuNTsKICAgICAgICB2YXIgbWlkUG9pbnRZID0gbGFzdFBvaW50LnkgKyAoZmlyc3RQb2ludC55IC0gbGFzdFBvaW50LnkpICowLjU7CgogICAgICAgIHBvaW50cy51bnNoaWZ0KG1pZFBvaW50WCwgbWlkUG9pbnRZKTsKICAgICAgICBwb2ludHMucHVzaChtaWRQb2ludFgsIG1pZFBvaW50WSk7CiAgICB9CgogICAgdmFyIHZlcnRzID0gd2ViR0xEYXRhLnBvaW50czsKICAgIHZhciBpbmRpY2VzID0gd2ViR0xEYXRhLmluZGljZXM7CiAgICB2YXIgbGVuZ3RoID0gcG9pbnRzLmxlbmd0aCAvIDI7CiAgICB2YXIgaW5kZXhDb3VudCA9IHBvaW50cy5sZW5ndGg7CiAgICB2YXIgaW5kZXhTdGFydCA9IHZlcnRzLmxlbmd0aC82OwoKICAgIC8vIERSQVcgdGhlIExpbmUKICAgIHZhciB3aWR0aCA9IGdyYXBoaWNzRGF0YS5saW5lV2lkdGggLyAyOwoKICAgIC8vIHNvcnQgY29sb3IKICAgIHZhciBjb2xvciA9IFBJWEkuaGV4MnJnYihncmFwaGljc0RhdGEubGluZUNvbG9yKTsKICAgIHZhciBhbHBoYSA9IGdyYXBoaWNzRGF0YS5saW5lQWxwaGE7CiAgICB2YXIgciA9IGNvbG9yWzBdICogYWxwaGE7CiAgICB2YXIgZyA9IGNvbG9yWzFdICogYWxwaGE7CiAgICB2YXIgYiA9IGNvbG9yWzJdICogYWxwaGE7CgogICAgdmFyIHB4LCBweSwgcDF4LCBwMXksIHAyeCwgcDJ5LCBwM3gsIHAzeTsKICAgIHZhciBwZXJweCwgcGVycHksIHBlcnAyeCwgcGVycDJ5LCBwZXJwM3gsIHBlcnAzeTsKICAgIHZhciBhMSwgYjEsIGMxLCBhMiwgYjIsIGMyOwogICAgdmFyIGRlbm9tLCBwZGlzdCwgZGlzdDsKCiAgICBwMXggPSBwb2ludHNbMF07CiAgICBwMXkgPSBwb2ludHNbMV07CgogICAgcDJ4ID0gcG9pbnRzWzJdOwogICAgcDJ5ID0gcG9pbnRzWzNdOwoKICAgIHBlcnB4ID0gLShwMXkgLSBwMnkpOwogICAgcGVycHkgPSAgcDF4IC0gcDJ4OwoKICAgIGRpc3QgPSBNYXRoLnNxcnQocGVycHgqcGVycHggKyBwZXJweSpwZXJweSk7CgogICAgcGVycHggLz0gZGlzdDsKICAgIHBlcnB5IC89IGRpc3Q7CiAgICBwZXJweCAqPSB3aWR0aDsKICAgIHBlcnB5ICo9IHdpZHRoOwoKICAgIC8vIHN0YXJ0CiAgICB2ZXJ0cy5wdXNoKHAxeCAtIHBlcnB4ICwgcDF5IC0gcGVycHksCiAgICAgICAgICAgICAgICByLCBnLCBiLCBhbHBoYSk7CgogICAgdmVydHMucHVzaChwMXggKyBwZXJweCAsIHAxeSArIHBlcnB5LAogICAgICAgICAgICAgICAgciwgZywgYiwgYWxwaGEpOwoKICAgIGZvciAoaSA9IDE7IGkgPCBsZW5ndGgtMTsgaSsrKQogICAgewogICAgICAgIHAxeCA9IHBvaW50c1soaS0xKSoyXTsKICAgICAgICBwMXkgPSBwb2ludHNbKGktMSkqMiArIDFdOwoKICAgICAgICBwMnggPSBwb2ludHNbKGkpKjJdOwogICAgICAgIHAyeSA9IHBvaW50c1soaSkqMiArIDFdOwoKICAgICAgICBwM3ggPSBwb2ludHNbKGkrMSkqMl07CiAgICAgICAgcDN5ID0gcG9pbnRzWyhpKzEpKjIgKyAxXTsKCiAgICAgICAgcGVycHggPSAtKHAxeSAtIHAyeSk7CiAgICAgICAgcGVycHkgPSBwMXggLSBwMng7CgogICAgICAgIGRpc3QgPSBNYXRoLnNxcnQocGVycHgqcGVycHggKyBwZXJweSpwZXJweSk7CiAgICAgICAgcGVycHggLz0gZGlzdDsKICAgICAgICBwZXJweSAvPSBkaXN0OwogICAgICAgIHBlcnB4ICo9IHdpZHRoOwogICAgICAgIHBlcnB5ICo9IHdpZHRoOwoKICAgICAgICBwZXJwMnggPSAtKHAyeSAtIHAzeSk7CiAgICAgICAgcGVycDJ5ID0gcDJ4IC0gcDN4OwoKICAgICAgICBkaXN0ID0gTWF0aC5zcXJ0KHBlcnAyeCpwZXJwMnggKyBwZXJwMnkqcGVycDJ5KTsKICAgICAgICBwZXJwMnggLz0gZGlzdDsKICAgICAgICBwZXJwMnkgLz0gZGlzdDsKICAgICAgICBwZXJwMnggKj0gd2lkdGg7CiAgICAgICAgcGVycDJ5ICo9IHdpZHRoOwoKICAgICAgICBhMSA9ICgtcGVycHkgKyBwMXkpIC0gKC1wZXJweSArIHAyeSk7CiAgICAgICAgYjEgPSAoLXBlcnB4ICsgcDJ4KSAtICgtcGVycHggKyBwMXgpOwogICAgICAgIGMxID0gKC1wZXJweCArIHAxeCkgKiAoLXBlcnB5ICsgcDJ5KSAtICgtcGVycHggKyBwMngpICogKC1wZXJweSArIHAxeSk7CiAgICAgICAgYTIgPSAoLXBlcnAyeSArIHAzeSkgLSAoLXBlcnAyeSArIHAyeSk7CiAgICAgICAgYjIgPSAoLXBlcnAyeCArIHAyeCkgLSAoLXBlcnAyeCArIHAzeCk7CiAgICAgICAgYzIgPSAoLXBlcnAyeCArIHAzeCkgKiAoLXBlcnAyeSArIHAyeSkgLSAoLXBlcnAyeCArIHAyeCkgKiAoLXBlcnAyeSArIHAzeSk7CgogICAgICAgIGRlbm9tID0gYTEqYjIgLSBhMipiMTsKCiAgICAgICAgaWYoTWF0aC5hYnMoZGVub20pIDwgMC4xICkKICAgICAgICB7CgogICAgICAgICAgICBkZW5vbSs9MTAuMTsKICAgICAgICAgICAgdmVydHMucHVzaChwMnggLSBwZXJweCAsIHAyeSAtIHBlcnB5LAogICAgICAgICAgICAgICAgciwgZywgYiwgYWxwaGEpOwoKICAgICAgICAgICAgdmVydHMucHVzaChwMnggKyBwZXJweCAsIHAyeSArIHBlcnB5LAogICAgICAgICAgICAgICAgciwgZywgYiwgYWxwaGEpOwoKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBweCA9IChiMSpjMiAtIGIyKmMxKS9kZW5vbTsKICAgICAgICBweSA9IChhMipjMSAtIGExKmMyKS9kZW5vbTsKCgogICAgICAgIHBkaXN0ID0gKHB4IC1wMngpICogKHB4IC1wMngpICsgKHB5IC1wMnkpICsgKHB5IC1wMnkpOwoKCiAgICAgICAgaWYocGRpc3QgPiAxNDAgKiAxNDApCiAgICAgICAgewogICAgICAgICAgICBwZXJwM3ggPSBwZXJweCAtIHBlcnAyeDsKICAgICAgICAgICAgcGVycDN5ID0gcGVycHkgLSBwZXJwMnk7CgogICAgICAgICAgICBkaXN0ID0gTWF0aC5zcXJ0KHBlcnAzeCpwZXJwM3ggKyBwZXJwM3kqcGVycDN5KTsKICAgICAgICAgICAgcGVycDN4IC89IGRpc3Q7CiAgICAgICAgICAgIHBlcnAzeSAvPSBkaXN0OwogICAgICAgICAgICBwZXJwM3ggKj0gd2lkdGg7CiAgICAgICAgICAgIHBlcnAzeSAqPSB3aWR0aDsKCiAgICAgICAgICAgIHZlcnRzLnB1c2gocDJ4IC0gcGVycDN4LCBwMnkgLXBlcnAzeSk7CiAgICAgICAgICAgIHZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoKICAgICAgICAgICAgdmVydHMucHVzaChwMnggKyBwZXJwM3gsIHAyeSArcGVycDN5KTsKICAgICAgICAgICAgdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgogICAgICAgICAgICB2ZXJ0cy5wdXNoKHAyeCAtIHBlcnAzeCwgcDJ5IC1wZXJwM3kpOwogICAgICAgICAgICB2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCiAgICAgICAgICAgIGluZGV4Q291bnQrKzsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKCiAgICAgICAgICAgIHZlcnRzLnB1c2gocHggLCBweSk7CiAgICAgICAgICAgIHZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoKICAgICAgICAgICAgdmVydHMucHVzaChwMnggLSAocHgtcDJ4KSwgcDJ5IC0gKHB5IC0gcDJ5KSk7CiAgICAgICAgICAgIHZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwogICAgICAgIH0KICAgIH0KCiAgICBwMXggPSBwb2ludHNbKGxlbmd0aC0yKSoyXTsKICAgIHAxeSA9IHBvaW50c1sobGVuZ3RoLTIpKjIgKyAxXTsKCiAgICBwMnggPSBwb2ludHNbKGxlbmd0aC0xKSoyXTsKICAgIHAyeSA9IHBvaW50c1sobGVuZ3RoLTEpKjIgKyAxXTsKCiAgICBwZXJweCA9IC0ocDF5IC0gcDJ5KTsKICAgIHBlcnB5ID0gcDF4IC0gcDJ4OwoKICAgIGRpc3QgPSBNYXRoLnNxcnQocGVycHgqcGVycHggKyBwZXJweSpwZXJweSk7CiAgICBwZXJweCAvPSBkaXN0OwogICAgcGVycHkgLz0gZGlzdDsKICAgIHBlcnB4ICo9IHdpZHRoOwogICAgcGVycHkgKj0gd2lkdGg7CgogICAgdmVydHMucHVzaChwMnggLSBwZXJweCAsIHAyeSAtIHBlcnB5KTsKICAgIHZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoKICAgIHZlcnRzLnB1c2gocDJ4ICsgcGVycHggLCBwMnkgKyBwZXJweSk7CiAgICB2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCiAgICBpbmRpY2VzLnB1c2goaW5kZXhTdGFydCk7CgogICAgZm9yIChpID0gMDsgaSA8IGluZGV4Q291bnQ7IGkrKykKICAgIHsKICAgICAgICBpbmRpY2VzLnB1c2goaW5kZXhTdGFydCsrKTsKICAgIH0KCiAgICBpbmRpY2VzLnB1c2goaW5kZXhTdGFydC0xKTsKfTsKCi8qKgogKiBCdWlsZHMgYSBwb2x5Z29uIHRvIGRyYXcKICoKICogQHN0YXRpYwogKiBAcHJpdmF0ZQogKiBAbWV0aG9kIGJ1aWxkUG9seQogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKiBAcGFyYW0gd2ViR0xEYXRhIHtPYmplY3R9CiAqLwpQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRQb2x5ID0gZnVuY3Rpb24oZ3JhcGhpY3NEYXRhLCB3ZWJHTERhdGEpCnsKICAgIHZhciBwb2ludHMgPSBncmFwaGljc0RhdGEucG9pbnRzOwogICAgaWYocG9pbnRzLmxlbmd0aCA8IDYpcmV0dXJuOwoKICAgIC8vIGdldCBmaXJzdCBhbmQgbGFzdCBwb2ludC4uIGZpZ3VyZSBvdXQgdGhlIG1pZGRsZSEKICAgIHZhciB2ZXJ0cyA9IHdlYkdMRGF0YS5wb2ludHM7CiAgICB2YXIgaW5kaWNlcyA9IHdlYkdMRGF0YS5pbmRpY2VzOwoKICAgIHZhciBsZW5ndGggPSBwb2ludHMubGVuZ3RoIC8gMjsKCiAgICAvLyBzb3J0IGNvbG9yCiAgICB2YXIgY29sb3IgPSBQSVhJLmhleDJyZ2IoZ3JhcGhpY3NEYXRhLmZpbGxDb2xvcik7CiAgICB2YXIgYWxwaGEgPSBncmFwaGljc0RhdGEuZmlsbEFscGhhOwogICAgdmFyIHIgPSBjb2xvclswXSAqIGFscGhhOwogICAgdmFyIGcgPSBjb2xvclsxXSAqIGFscGhhOwogICAgdmFyIGIgPSBjb2xvclsyXSAqIGFscGhhOwoKICAgIHZhciB0cmlhbmdsZXMgPSBQSVhJLlBvbHlLLlRyaWFuZ3VsYXRlKHBvaW50cyk7CgogICAgdmFyIHZlcnRQb3MgPSB2ZXJ0cy5sZW5ndGggLyA2OwoKICAgIHZhciBpID0gMDsKCiAgICBmb3IgKGkgPSAwOyBpIDwgdHJpYW5nbGVzLmxlbmd0aDsgaSs9MykKICAgIHsKICAgICAgICBpbmRpY2VzLnB1c2godHJpYW5nbGVzW2ldICsgdmVydFBvcyk7CiAgICAgICAgaW5kaWNlcy5wdXNoKHRyaWFuZ2xlc1tpXSArIHZlcnRQb3MpOwogICAgICAgIGluZGljZXMucHVzaCh0cmlhbmdsZXNbaSsxXSArIHZlcnRQb3MpOwogICAgICAgIGluZGljZXMucHVzaCh0cmlhbmdsZXNbaSsyXSArdmVydFBvcyk7CiAgICAgICAgaW5kaWNlcy5wdXNoKHRyaWFuZ2xlc1tpKzJdICsgdmVydFBvcyk7CiAgICB9CgogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKQogICAgewogICAgICAgIHZlcnRzLnB1c2gocG9pbnRzW2kgKiAyXSwgcG9pbnRzW2kgKiAyICsgMV0sCiAgICAgICAgICAgICAgICAgICByLCBnLCBiLCBhbHBoYSk7CiAgICB9Cn07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKUElYSS5fZGVmYXVsdEZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsMCwxLDEpOwoKLy8gYW4gaW5zdGFuY2Ugb2YgdGhlIGdsIGNvbnRleHQuLgovLyBvbmx5IG9uZSBhdCB0aGUgbW9tZW50IDovClBJWEkuZ2wgPSBudWxsOwoKLyoqCiAqIHRoZSBXZWJHTFJlbmRlcmVyIGlzIGRyYXdzIHRoZSBzdGFnZSBhbmQgYWxsIGl0cyBjb250ZW50IG9udG8gYSB3ZWJHTCBlbmFibGVkIGNhbnZhcy4gVGhpcyByZW5kZXJlcgogKiBzaG91bGQgYmUgdXNlZCBmb3IgYnJvd3NlcnMgc3VwcG9ydCB3ZWJHTC4gVGhpcyBSZW5kZXIgd29ya3MgYnkgYXV0b21hdGljYWxseSBtYW5hZ2luZyB3ZWJHTEJhdGNocy4KICogU28gbm8gbmVlZCBmb3IgU3ByaXRlIEJhdGNoJ3Mgb3IgU3ByaXRlIENsb3VkJ3MKICogRG9udCBmb3JnZXQgdG8gYWRkIHRoZSB2aWV3IHRvIHlvdXIgRE9NIG9yIHlvdSB3aWxsIG5vdCBzZWUgYW55dGhpbmcgOikKICoKICogQGNsYXNzIFdlYkdMUmVuZGVyZXIKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB3aWR0aD0wIHtOdW1iZXJ9IHRoZSB3aWR0aCBvZiB0aGUgY2FudmFzIHZpZXcKICogQHBhcmFtIGhlaWdodD0wIHtOdW1iZXJ9IHRoZSBoZWlnaHQgb2YgdGhlIGNhbnZhcyB2aWV3CiAqIEBwYXJhbSB2aWV3IHtDYW52YXN9IHRoZSBjYW52YXMgdG8gdXNlIGFzIGEgdmlldywgb3B0aW9uYWwKICogQHBhcmFtIHRyYW5zcGFyZW50PWZhbHNlIHtCb29sZWFufSB0aGUgdHJhbnNwYXJlbmN5IG9mIHRoZSByZW5kZXIgdmlldywgZGVmYXVsdCBmYWxzZQogKiBAcGFyYW0gYW50aWFsaWFzPWZhbHNlIHtCb29sZWFufSBzZXRzIGFudGlhbGlhcyAob25seSBhcHBsaWNhYmxlIGluIGNocm9tZSBhdCB0aGUgbW9tZW50KQogKgogKi8KUElYSS5XZWJHTFJlbmRlcmVyID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCwgdmlldywgdHJhbnNwYXJlbnQsIGFudGlhbGlhcykKewogICAgLy8gZG8gYSBjYXRjaC4uIG9ubHkgMSB3ZWJHTCByZW5kZXJlci4uCgogICAgdGhpcy50cmFuc3BhcmVudCA9ICEhdHJhbnNwYXJlbnQ7CgogICAgdGhpcy53aWR0aCA9IHdpZHRoIHx8IDgwMDsKICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IDYwMDsKCiAgICB0aGlzLnZpZXcgPSB2aWV3IHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdjYW52YXMnICk7CiAgICB0aGlzLnZpZXcud2lkdGggPSB0aGlzLndpZHRoOwogICAgdGhpcy52aWV3LmhlaWdodCA9IHRoaXMuaGVpZ2h0OwoKICAgIC8vIGRlYWwgd2l0aCBsb3NpbmcgY29udGV4dC4uCiAgICB2YXIgc2NvcGUgPSB0aGlzOwogICAgdGhpcy52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmdsY29udGV4dGxvc3QnLCBmdW5jdGlvbihldmVudCkgeyBzY29wZS5oYW5kbGVDb250ZXh0TG9zdChldmVudCk7IH0sIGZhbHNlKTsKICAgIHRoaXMudmlldy5hZGRFdmVudExpc3RlbmVyKCd3ZWJnbGNvbnRleHRyZXN0b3JlZCcsIGZ1bmN0aW9uKGV2ZW50KSB7IHNjb3BlLmhhbmRsZUNvbnRleHRSZXN0b3JlZChldmVudCk7IH0sIGZhbHNlKTsKCiAgICB0aGlzLmJhdGNocyA9IFtdOwoKICAgIHZhciBvcHRpb25zID0gewogICAgICAgIGFscGhhOiB0aGlzLnRyYW5zcGFyZW50LAogICAgICAgIGFudGlhbGlhczohIWFudGlhbGlhcywgLy8gU1BFRUQgVVA/PwogICAgICAgIHByZW11bHRpcGxpZWRBbHBoYTpmYWxzZSwKICAgICAgICBzdGVuY2lsOnRydWUKICAgIH07CgogICAgLy90cnkgJ2V4cGVyaW1lbnRhbC13ZWJnbCcKICAgIHRyeSB7CiAgICAgICAgUElYSS5nbCA9IHRoaXMuZ2wgPSB0aGlzLnZpZXcuZ2V0Q29udGV4dCgnZXhwZXJpbWVudGFsLXdlYmdsJywgIG9wdGlvbnMpOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vdHJ5ICd3ZWJnbCcKICAgICAgICB0cnkgewogICAgICAgICAgICBQSVhJLmdsID0gdGhpcy5nbCA9IHRoaXMudmlldy5nZXRDb250ZXh0KCd3ZWJnbCcsICBvcHRpb25zKTsKICAgICAgICB9IGNhdGNoIChlMikgewogICAgICAgICAgICAvLyBmYWlsLCBub3QgYWJsZSB0byBnZXQgYSBjb250ZXh0CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignIFRoaXMgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IHdlYkdMLiBUcnkgdXNpbmcgdGhlIGNhbnZhcyByZW5kZXJlcicgKyB0aGlzKTsKICAgICAgICB9CiAgICB9CgogICAgUElYSS5pbml0RGVmYXVsdFNoYWRlcnMoKTsKCgoKCiAgIC8vIFBJWEkuYWN0aXZhdGVEZWZhdWx0U2hhZGVyKCk7CgogICAgdmFyIGdsID0gdGhpcy5nbDsKCiAgICBnbC51c2VQcm9ncmFtKFBJWEkuZGVmYXVsdFNoYWRlci5wcm9ncmFtKTsKCgogICAgUElYSS5XZWJHTFJlbmRlcmVyLmdsID0gZ2w7CgogICAgdGhpcy5iYXRjaCA9IG5ldyBQSVhJLldlYkdMQmF0Y2goZ2wpOwogICAgZ2wuZGlzYWJsZShnbC5ERVBUSF9URVNUKTsKICAgIGdsLmRpc2FibGUoZ2wuQ1VMTF9GQUNFKTsKCiAgICBnbC5lbmFibGUoZ2wuQkxFTkQpOwogICAgZ2wuY29sb3JNYXNrKHRydWUsIHRydWUsIHRydWUsIHRoaXMudHJhbnNwYXJlbnQpOwoKICAgIFBJWEkucHJvamVjdGlvbiA9IG5ldyBQSVhJLlBvaW50KDQwMCwgMzAwKTsKICAgIFBJWEkub2Zmc2V0ID0gbmV3IFBJWEkuUG9pbnQoMCwgMCk7CgogICAgLy8gVE9ETyByZW1vdmUgdGhlYXNlIGdsb2JhbHMuLgoKICAgIHRoaXMucmVzaXplKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKICAgIHRoaXMuY29udGV4dExvc3QgPSBmYWxzZTsKCiAgICAvL1BJWEkucHVzaFNoYWRlcihQSVhJLmRlZmF1bHRTaGFkZXIpOwoKICAgIHRoaXMuc3RhZ2VSZW5kZXJHcm91cCA9IG5ldyBQSVhJLldlYkdMUmVuZGVyR3JvdXAodGhpcy5nbCwgdGhpcy50cmFuc3BhcmVudCk7CiAgLy8gIHRoaXMuc3RhZ2VSZW5kZXJHcm91cC4gPSB0aGlzLnRyYW5zcGFyZW50Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLldlYkdMUmVuZGVyZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5XZWJHTFJlbmRlcmVyOwoKLyoqCiAqIEdldHMgYSBuZXcgV2ViR0xCYXRjaCBmcm9tIHRoZSBwb29sCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCBnZXRCYXRjaAogKiBAcmV0dXJuIHtXZWJHTEJhdGNofQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlcmVyLmdldEJhdGNoID0gZnVuY3Rpb24oKQp7CiAgICBpZihQSVhJLl9iYXRjaHMubGVuZ3RoID09PSAwKQogICAgewogICAgICAgIHJldHVybiBuZXcgUElYSS5XZWJHTEJhdGNoKFBJWEkuV2ViR0xSZW5kZXJlci5nbCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgcmV0dXJuIFBJWEkuX2JhdGNocy5wb3AoKTsKICAgIH0KfTsKCi8qKgogKiBQdXRzIGEgYmF0Y2ggYmFjayBpbnRvIHRoZSBwb29sCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCByZXR1cm5CYXRjaAogKiBAcGFyYW0gYmF0Y2gge1dlYkdMQmF0Y2h9IFRoZSBiYXRjaCB0byByZXR1cm4KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJlci5yZXR1cm5CYXRjaCA9IGZ1bmN0aW9uKGJhdGNoKQp7CiAgICBiYXRjaC5jbGVhbigpOwogICAgUElYSS5fYmF0Y2hzLnB1c2goYmF0Y2gpOwp9OwoKLyoqCiAqIFJlbmRlcnMgdGhlIHN0YWdlIHRvIGl0cyB3ZWJHTCB2aWV3CiAqCiAqIEBtZXRob2QgcmVuZGVyCiAqIEBwYXJhbSBzdGFnZSB7U3RhZ2V9IHRoZSBTdGFnZSBlbGVtZW50IHRvIGJlIHJlbmRlcmVkCiAqLwpQSVhJLldlYkdMUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKHN0YWdlKQp7CiAgICBpZih0aGlzLmNvbnRleHRMb3N0KXJldHVybjsKCgogICAgLy8gaWYgcmVuZGVyaW5nIGEgbmV3IHN0YWdlIGNsZWFyIHRoZSBiYXRjaHMuLgogICAgaWYodGhpcy5fX3N0YWdlICE9PSBzdGFnZSkKICAgIHsKICAgICAgICAvLyBUT0RPIG1ha2UgdGhpcyB3b3JrCiAgICAgICAgLy8gZG9udCB0aGluayB0aGlzIGlzIG5lZWRlZCBhbnkgbW9yZT8KICAgICAgICB0aGlzLl9fc3RhZ2UgPSBzdGFnZTsKICAgICAgICB0aGlzLnN0YWdlUmVuZGVyR3JvdXAuc2V0UmVuZGVyYWJsZShzdGFnZSk7CiAgICB9CgogICAgLy8gdXBkYXRlIGFueSB0ZXh0dXJlcwogICAgUElYSS5XZWJHTFJlbmRlcmVyLnVwZGF0ZVRleHR1cmVzKCk7CgogICAgLy8gdXBkYXRlIHRoZSBzY2VuZSBncmFwaAogICAgUElYSS52aXNpYmxlQ291bnQrKzsKICAgIHN0YWdlLnVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgIHZhciBnbCA9IHRoaXMuZ2w7CgogICAgLy8gLS0gRG9lcyB0aGlzIG5lZWQgdG8gYmUgc2V0IGV2ZXJ5IGZyYW1lPyAtLSAvLwogICAgZ2wuY29sb3JNYXNrKHRydWUsIHRydWUsIHRydWUsIHRoaXMudHJhbnNwYXJlbnQpOwogICAgZ2wudmlld3BvcnQoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoKICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgbnVsbCk7CgogICAgZ2wuY2xlYXJDb2xvcihzdGFnZS5iYWNrZ3JvdW5kQ29sb3JTcGxpdFswXSxzdGFnZS5iYWNrZ3JvdW5kQ29sb3JTcGxpdFsxXSxzdGFnZS5iYWNrZ3JvdW5kQ29sb3JTcGxpdFsyXSwgIXRoaXMudHJhbnNwYXJlbnQpOwogICAgZ2wuY2xlYXIoZ2wuQ09MT1JfQlVGRkVSX0JJVCk7CgogICAgLy8gSEFDSyBUTyBURVNUCgogICAgdGhpcy5zdGFnZVJlbmRlckdyb3VwLmJhY2tncm91bmRDb2xvciA9IHN0YWdlLmJhY2tncm91bmRDb2xvclNwbGl0OwoKICAgIFBJWEkucHJvamVjdGlvbi54ID0gIHRoaXMud2lkdGgvMjsKICAgIFBJWEkucHJvamVjdGlvbi55ID0gIC10aGlzLmhlaWdodC8yOwoKICAgIHRoaXMuc3RhZ2VSZW5kZXJHcm91cC5yZW5kZXIoUElYSS5wcm9qZWN0aW9uKTsKCiAgICAvLyBpbnRlcmFjdGlvbgogICAgLy8gcnVuIGludGVyYWN0aW9uIQogICAgaWYoc3RhZ2UuaW50ZXJhY3RpdmUpCiAgICB7CiAgICAgICAgLy9uZWVkIHRvIGFkZCBzb21lIGV2ZW50cyEKICAgICAgICBpZighc3RhZ2UuX2ludGVyYWN0aXZlRXZlbnRzQWRkZWQpCiAgICAgICAgewogICAgICAgICAgICBzdGFnZS5faW50ZXJhY3RpdmVFdmVudHNBZGRlZCA9IHRydWU7CiAgICAgICAgICAgIHN0YWdlLmludGVyYWN0aW9uTWFuYWdlci5zZXRUYXJnZXQodGhpcyk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIGFmdGVyIHJlbmRlcmluZyBsZXRzIGNvbmZpcm0gYWxsIGZyYW1lcyB0aGF0IGhhdmUgYmVlbiB1b2RhdGVkLi4KICAgIGlmKFBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMubGVuZ3RoID4gMCkKICAgIHsKICAgICAgICBmb3IgKHZhciBpPTA7IGkgPCBQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlc1tpXS51cGRhdGVGcmFtZSA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcyA9IFtdOwogICAgfQp9OwoKLyoqCiAqIFVwZGF0ZXMgdGhlIHRleHR1cmVzIGxvYWRlZCBpbnRvIHRoaXMgd2ViZ2wgcmVuZGVyZXIKICoKICogQHN0YXRpYwogKiBAbWV0aG9kIHVwZGF0ZVRleHR1cmVzCiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyZXIudXBkYXRlVGV4dHVyZXMgPSBmdW5jdGlvbigpCnsKICAgIHZhciBpID0gMDsKCiAgICAvL1RPRE8gYnJlYWsgdGhpcyBvdXQgaW50byBhIHRleHR1cmUgbWFuYWdlci4uLgogICAgZm9yIChpID0gMDsgaSA8IFBJWEkudGV4dHVyZXNUb1VwZGF0ZS5sZW5ndGg7IGkrKykKICAgICAgICBQSVhJLldlYkdMUmVuZGVyZXIudXBkYXRlVGV4dHVyZShQSVhJLnRleHR1cmVzVG9VcGRhdGVbaV0pOwoKICAgIGZvciAoaSA9IDA7IGkgPCBQSVhJLnRleHR1cmVzVG9EZXN0cm95Lmxlbmd0aDsgaSsrKQogICAgICAgIFBJWEkuV2ViR0xSZW5kZXJlci5kZXN0cm95VGV4dHVyZShQSVhJLnRleHR1cmVzVG9EZXN0cm95W2ldKTsKCiAgICBQSVhJLnRleHR1cmVzVG9VcGRhdGUgPSBbXTsKICAgIFBJWEkudGV4dHVyZXNUb0Rlc3Ryb3kgPSBbXTsKfTsKCi8qKgogKiBVcGRhdGVzIGEgbG9hZGVkIHdlYmdsIHRleHR1cmUKICoKICogQHN0YXRpYwogKiBAbWV0aG9kIHVwZGF0ZVRleHR1cmUKICogQHBhcmFtIHRleHR1cmUge1RleHR1cmV9IFRoZSB0ZXh0dXJlIHRvIHVwZGF0ZQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlcmVyLnVwZGF0ZVRleHR1cmUgPSBmdW5jdGlvbih0ZXh0dXJlKQp7CiAgICAvL1RPRE8gYnJlYWsgdGhpcyBvdXQgaW50byBhIHRleHR1cmUgbWFuYWdlci4uLgogICAgdmFyIGdsID0gUElYSS5nbDsKCiAgICBpZighdGV4dHVyZS5fZ2xUZXh0dXJlKQogICAgewogICAgICAgIHRleHR1cmUuX2dsVGV4dHVyZSA9IGdsLmNyZWF0ZVRleHR1cmUoKTsKICAgIH0KCiAgICBpZih0ZXh0dXJlLmhhc0xvYWRlZCkKICAgIHsKICAgICAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0ZXh0dXJlLl9nbFRleHR1cmUpOwogICAgICAgIGdsLnBpeGVsU3RvcmVpKGdsLlVOUEFDS19QUkVNVUxUSVBMWV9BTFBIQV9XRUJHTCwgdHJ1ZSk7CgogICAgICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgdGV4dHVyZS5zb3VyY2UpOwogICAgICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NQUdfRklMVEVSLCB0ZXh0dXJlLnNjYWxlTW9kZSA9PT0gUElYSS5CYXNlVGV4dHVyZS5TQ0FMRV9NT0RFLkxJTkVBUiA/IGdsLkxJTkVBUiA6IGdsLk5FQVJFU1QpOwogICAgICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCB0ZXh0dXJlLnNjYWxlTW9kZSA9PT0gUElYSS5CYXNlVGV4dHVyZS5TQ0FMRV9NT0RFLkxJTkVBUiA/IGdsLkxJTkVBUiA6IGdsLk5FQVJFU1QpOwoKICAgICAgICAvLyByZWd1bGVyLi4uCgogICAgICAgIGlmKCF0ZXh0dXJlLl9wb3dlck9mMikKICAgICAgICB7CiAgICAgICAgICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1MsIGdsLkNMQU1QX1RPX0VER0UpOwogICAgICAgICAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5DTEFNUF9UT19FREdFKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuUkVQRUFUKTsKICAgICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuUkVQRUFUKTsKICAgICAgICB9CgogICAgICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIG51bGwpOwogICAgfQp9OwoKLyoqCiAqIERlc3Ryb3lzIGEgbG9hZGVkIHdlYmdsIHRleHR1cmUKICoKICogQG1ldGhvZCBkZXN0cm95VGV4dHVyZQogKiBAcGFyYW0gdGV4dHVyZSB7VGV4dHVyZX0gVGhlIHRleHR1cmUgdG8gdXBkYXRlCiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyZXIuZGVzdHJveVRleHR1cmUgPSBmdW5jdGlvbih0ZXh0dXJlKQp7CiAgICAvL1RPRE8gYnJlYWsgdGhpcyBvdXQgaW50byBhIHRleHR1cmUgbWFuYWdlci4uLgogICAgdmFyIGdsID0gUElYSS5nbDsKCiAgICBpZih0ZXh0dXJlLl9nbFRleHR1cmUpCiAgICB7CiAgICAgICAgdGV4dHVyZS5fZ2xUZXh0dXJlID0gZ2wuY3JlYXRlVGV4dHVyZSgpOwogICAgICAgIGdsLmRlbGV0ZVRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgdGV4dHVyZS5fZ2xUZXh0dXJlKTsKICAgIH0KfTsKCi8qKgogKiByZXNpemVzIHRoZSB3ZWJHTCB2aWV3IHRvIHRoZSBzcGVjaWZpZWQgd2lkdGggYW5kIGhlaWdodAogKgogKiBAbWV0aG9kIHJlc2l6ZQogKiBAcGFyYW0gd2lkdGgge051bWJlcn0gdGhlIG5ldyB3aWR0aCBvZiB0aGUgd2ViR0wgdmlldwogKiBAcGFyYW0gaGVpZ2h0IHtOdW1iZXJ9IHRoZSBuZXcgaGVpZ2h0IG9mIHRoZSB3ZWJHTCB2aWV3CiAqLwpQSVhJLldlYkdMUmVuZGVyZXIucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCnsKICAgIHRoaXMud2lkdGggPSB3aWR0aDsKICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgIHRoaXMudmlldy53aWR0aCA9IHdpZHRoOwogICAgdGhpcy52aWV3LmhlaWdodCA9IGhlaWdodDsKCiAgICB0aGlzLmdsLnZpZXdwb3J0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCiAgICAvL3ZhciBwcm9qZWN0aW9uTWF0cml4ID0gdGhpcy5wcm9qZWN0aW9uTWF0cml4OwoKICAgIFBJWEkucHJvamVjdGlvbi54ID0gIHRoaXMud2lkdGgvMjsKICAgIFBJWEkucHJvamVjdGlvbi55ID0gIC10aGlzLmhlaWdodC8yOwoKICAgIC8vUElYSS5zaXplLnggPSAgdGhpcy53aWR0aC8yOwogICAgLy9QSVhJLnNpemUueSA9ICAtdGhpcy5oZWlnaHQvMjsKCi8vICBwcm9qZWN0aW9uTWF0cml4WzBdID0gMi90aGlzLndpZHRoOwovLyAgcHJvamVjdGlvbk1hdHJpeFs1XSA9IC0yL3RoaXMuaGVpZ2h0OwovLyAgcHJvamVjdGlvbk1hdHJpeFsxMl0gPSAtMTsKLy8gIHByb2plY3Rpb25NYXRyaXhbMTNdID0gMTsKfTsKCi8qKgogKiBIYW5kbGVzIGEgbG9zdCB3ZWJnbCBjb250ZXh0CiAqCiAqIEBtZXRob2QgaGFuZGxlQ29udGV4dExvc3QKICogQHBhcmFtIGV2ZW50IHtFdmVudH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJlci5wcm90b3R5cGUuaGFuZGxlQ29udGV4dExvc3QgPSBmdW5jdGlvbihldmVudCkKewogICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgIHRoaXMuY29udGV4dExvc3QgPSB0cnVlOwp9OwoKLyoqCiAqIEhhbmRsZXMgYSByZXN0b3JlZCB3ZWJnbCBjb250ZXh0CiAqCiAqIEBtZXRob2QgaGFuZGxlQ29udGV4dFJlc3RvcmVkCiAqIEBwYXJhbSBldmVudCB7RXZlbnR9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyZXIucHJvdG90eXBlLmhhbmRsZUNvbnRleHRSZXN0b3JlZCA9IGZ1bmN0aW9uKCkKewogICAgdGhpcy5nbCA9IHRoaXMudmlldy5nZXRDb250ZXh0KCdleHBlcmltZW50YWwtd2ViZ2wnLCAgewogICAgICAgIGFscGhhOiB0cnVlCiAgICB9KTsKCiAgICB0aGlzLmluaXRTaGFkZXJzKCk7CgogICAgZm9yKHZhciBrZXkgaW4gUElYSS5UZXh0dXJlQ2FjaGUpCiAgICB7CiAgICAgICAgdmFyIHRleHR1cmUgPSBQSVhJLlRleHR1cmVDYWNoZVtrZXldLmJhc2VUZXh0dXJlOwogICAgICAgIHRleHR1cmUuX2dsVGV4dHVyZSA9IG51bGw7CiAgICAgICAgUElYSS5XZWJHTFJlbmRlcmVyLnVwZGF0ZVRleHR1cmUodGV4dHVyZSk7CiAgICB9CgogICAgZm9yICh2YXIgaT0wOyBpIDwgIHRoaXMuYmF0Y2hzLmxlbmd0aDsgaSsrKQogICAgewogICAgICAgIHRoaXMuYmF0Y2hzW2ldLnJlc3RvcmVMb3N0Q29udGV4dCh0aGlzLmdsKTsKICAgICAgICB0aGlzLmJhdGNoc1tpXS5kaXJ0eSA9IHRydWU7CiAgICB9CgogICAgUElYSS5fcmVzdG9yZUJhdGNocyh0aGlzLmdsKTsKCiAgICB0aGlzLmNvbnRleHRMb3N0ID0gZmFsc2U7Cn07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIEEgV2ViR0xCYXRjaCBFbmFibGVzIGEgZ3JvdXAgb2Ygc3ByaXRlcyB0byBiZSBkcmF3biB1c2luZyB0aGUgc2FtZSBzZXR0aW5ncy4KICogaWYgYSBncm91cCBvZiBzcHJpdGVzIGFsbCBoYXZlIHRoZSBzYW1lIGJhc2VUZXh0dXJlIGFuZCBibGVuZE1vZGUgdGhlbiB0aGV5IGNhbiBiZQogKiBncm91cGVkIGludG8gYSBiYXRjaC4gQWxsIHRoZSBzcHJpdGVzIGluIGEgYmF0Y2ggY2FuIHRoZW4gYmUgZHJhd24gaW4gb25lIGdvIGJ5IHRoZQogKiBHUFUgd2hpY2ggaXMgaHVnZWx5IGVmZmljaWVudC4gQUxMIHNwcml0ZXMgaW4gdGhlIHdlYkdMIHJlbmRlcmVyIGFyZSBhZGRlZCB0byBhIGJhdGNoCiAqIGV2ZW4gaWYgdGhlIGJhdGNoIG9ubHkgY29udGFpbnMgb25lIHNwcml0ZS4gQmF0Y2hpbmcgaXMgaGFuZGxlZCBhdXRvbWF0aWNhbGx5IGJ5IHRoZQogKiB3ZWJHTCByZW5kZXJlci4gQSBnb29kIHRpcCBpczogdGhlIHNtYWxsZXIgdGhlIG51bWJlciBvZiBiYXRjaHMgdGhlcmUgYXJlLCB0aGUgZmFzdGVyCiAqIHRoZSB3ZWJHTCByZW5kZXJlciB3aWxsIHJ1bi4KICoKICogQGNsYXNzIFdlYkdMQmF0Y2gKICogQGNvbnRydWN0b3IKICogQHBhcmFtIGdsIHtXZWJHTENvbnRleHR9IEFuIGluc3RhbmNlIG9mIHRoZSB3ZWJHTCBjb250ZXh0CiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAgPSBmdW5jdGlvbihnbCwgdHJhbnNwYXJlbnQpCnsKCXRoaXMuZ2wgPSBnbDsKCXRoaXMucm9vdDsKCQoJdGhpcy5iYWNrZ3JvdW5kQ29sb3I7Cgl0aGlzLnRyYW5zcGFyZW50ID0gdHJhbnNwYXJlbnQgPT0gdW5kZWZpbmVkID8gdHJ1ZSA6IHRyYW5zcGFyZW50OwoJCgl0aGlzLmJhdGNocyA9IFtdOwoJdGhpcy50b1JlbW92ZSA9IFtdOwoJLy8gY29uc29sZS5sb2codGhpcy50cmFuc3BhcmVudCkKCXRoaXMuZmlsdGVyTWFuYWdlciA9IG5ldyBQSVhJLldlYkdMRmlsdGVyTWFuYWdlcih0aGlzLnRyYW5zcGFyZW50KTsKfQoKLy8gY29uc3RydWN0b3IKUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuV2ViR0xSZW5kZXJHcm91cDsKCi8qKgogKiBBZGQgYSBkaXNwbGF5IG9iamVjdCB0byB0aGUgd2ViZ2wgcmVuZGVyZXIKICoKICogQG1ldGhvZCBzZXRSZW5kZXJhYmxlCiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fQogKiBAcHJpdmF0ZSAKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUuc2V0UmVuZGVyYWJsZSA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QpCnsKCS8vIGhhcyB0aGlzIGNoYW5nZWQ/PwoJaWYodGhpcy5yb290KXRoaXMucmVtb3ZlRGlzcGxheU9iamVjdEFuZENoaWxkcmVuKHRoaXMucm9vdCk7CgkKCWRpc3BsYXlPYmplY3Qud29ybGRWaXNpYmxlID0gZGlzcGxheU9iamVjdC52aXNpYmxlOwoJCgkvLyBzb29vb29vIC8vCgkvLyB0byBjaGVjayBpZiBhbnkgYmF0Y2hzIGV4aXN0IGFscmVhZHk/PwoJCgkvLyBUT0RPIHdoYXQgaWYgaXRzIGFscmVhZHkgaGFzIGFuIG9iamVjdD8gc2hvdWxkIHJlbW92ZSBpdAoJdGhpcy5yb290ID0gZGlzcGxheU9iamVjdDsKCXRoaXMuYWRkRGlzcGxheU9iamVjdEFuZENoaWxkcmVuKGRpc3BsYXlPYmplY3QpOwp9CgovKioKICogUmVuZGVycyB0aGUgc3RhZ2UgdG8gaXRzIHdlYmdsIHZpZXcKICoKICogQG1ldGhvZCByZW5kZXIKICogQHBhcmFtIHByb2plY3Rpb24ge09iamVjdH0KICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24ocHJvamVjdGlvbiwgYnVmZmVyKQp7CglQSVhJLldlYkdMUmVuZGVyZXIudXBkYXRlVGV4dHVyZXMoKTsKCQoJdmFyIGdsID0gdGhpcy5nbDsKCWdsLnVuaWZvcm0yZihQSVhJLmRlZmF1bHRTaGFkZXIucHJvamVjdGlvblZlY3RvciwgcHJvamVjdGlvbi54LCBwcm9qZWN0aW9uLnkpOwoKCXRoaXMuZmlsdGVyTWFuYWdlci5iZWdpbihwcm9qZWN0aW9uLCBidWZmZXIpOwoKCQoJZ2wuYmxlbmRGdW5jKGdsLk9ORSwgZ2wuT05FX01JTlVTX1NSQ19BTFBIQSk7CgkvLyB3aWxsIHJlbmRlciBhbGwgdGhlIGVsZW1lbnRzIGluIHRoZSBncm91cAoJdmFyIHJlbmRlcmFibGU7CgoJZm9yICh2YXIgaT0wOyBpIDwgdGhpcy5iYXRjaHMubGVuZ3RoOyBpKyspIAoJewoJCQoJCXJlbmRlcmFibGUgPSB0aGlzLmJhdGNoc1tpXTsKCQlpZihyZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoKQoJCXsKCQkJdGhpcy5iYXRjaHNbaV0ucmVuZGVyKCk7CgkJCWNvbnRpbnVlOwoJCX0KCQkKCQkvLyByZW5kZXIgc3BlY2lhbAoJCXRoaXMucmVuZGVyU3BlY2lhbChyZW5kZXJhYmxlLCBwcm9qZWN0aW9uKTsKCX0KCQp9CgovKioKICogUmVuZGVycyBhIHNwZWNpZmljIGRpc3BsYXlPYmplY3QKICoKICogQG1ldGhvZCByZW5kZXJTcGVjaWZpYwogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0KICogQHBhcmFtIHByb2plY3Rpb24ge09iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVuZGVyU3BlY2lmaWMgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0LCBwcm9qZWN0aW9uLCBidWZmZXIpCnsKCVBJWEkuV2ViR0xSZW5kZXJlci51cGRhdGVUZXh0dXJlcygpOwoJdmFyIGdsID0gdGhpcy5nbDsKCglnbC51bmlmb3JtMmYoUElYSS5kZWZhdWx0U2hhZGVyLnByb2plY3Rpb25WZWN0b3IsIHByb2plY3Rpb24ueCwgcHJvamVjdGlvbi55KTsKCgl0aGlzLmZpbHRlck1hbmFnZXIuYmVnaW4ocHJvamVjdGlvbiwgYnVmZmVyKTsKCgkvLyB0byBkbyEKCS8vIHJlbmRlciBwYXJ0IG9mIHRoZSBzY2VuZS4uLgoJCgl2YXIgc3RhcnRJbmRleDsKCXZhciBzdGFydEJhdGNoSW5kZXg7CgkKCXZhciBlbmRJbmRleDsKCXZhciBlbmRCYXRjaEluZGV4OwoJCgkvKgoJICogIExPT0sgRk9SIFRIRSBORVhUIFNQUklURQoJICogIFRoaXMgcGFydCBsb29rcyBmb3IgdGhlIGNsb3Nlc3QgbmV4dCBzcHJpdGUgdGhhdCBjYW4gZ28gaW50byBhIGJhdGNoCgkgKiAgaXQga2VlcHMgbG9va2luZyB1bnRpbCBpdCBmaW5kcyBhIHNwcml0ZSBvciBnZXRzIHRvIHRoZSBlbmQgb2YgdGhlIGRpc3BsYXkKCSAqICBzY2VuZSBncmFwaAoJICovCgl2YXIgbmV4dFJlbmRlcmFibGUgPSBkaXNwbGF5T2JqZWN0LmZpcnN0OwoJd2hpbGUobmV4dFJlbmRlcmFibGUuX2lOZXh0KQoJewoJCWlmKG5leHRSZW5kZXJhYmxlLnJlbmRlcmFibGUgJiYgbmV4dFJlbmRlcmFibGUuX19yZW5kZXJHcm91cClicmVhazsKCQluZXh0UmVuZGVyYWJsZSA9IG5leHRSZW5kZXJhYmxlLl9pTmV4dDsKCX0KCXZhciBzdGFydEJhdGNoID0gbmV4dFJlbmRlcmFibGUuYmF0Y2g7CgkvL2NvbnNvbGUubG9nKG5leHRSZW5kZXJhYmxlKTsKCQoJLy9jb25zb2xlLmxvZyhyZW5kZXJhYmxlKQoJaWYobmV4dFJlbmRlcmFibGUgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKCXsKCQlzdGFydEJhdGNoID0gbmV4dFJlbmRlcmFibGUuYmF0Y2g7CgkJCgkJdmFyIGhlYWQgPSBzdGFydEJhdGNoLmhlYWQ7CgkJdmFyIG5leHQgPSBoZWFkOwoJCQoJCS8vIG9rIG5vdyB3ZSBoYXZlIHRoZSBiYXRjaC4uIG5lZWQgdG8gZmluZCB0aGUgc3RhcnQgaW5kZXghCgkJaWYoaGVhZCA9PSBuZXh0UmVuZGVyYWJsZSkKCQl7CgkJCXN0YXJ0SW5kZXggPSAwOwoJCX0KCQllbHNlCgkJewoJCQlzdGFydEluZGV4ID0gMTsKCQkJCgkJCXdoaWxlKGhlYWQuX19uZXh0ICE9IG5leHRSZW5kZXJhYmxlKQoJCQl7CgkJCQlzdGFydEluZGV4Kys7CgkJCQloZWFkID0gaGVhZC5fX25leHQ7CgkJCX0KCQl9Cgl9CgllbHNlCgl7CgkJc3RhcnRCYXRjaCA9IG5leHRSZW5kZXJhYmxlOwoJfQoJCgkvLyBHZXQgdGhlIExBU1QgcmVuZGVyYWJsZSBvYmplY3QKCXZhciBsYXN0UmVuZGVyYWJsZSA9IGRpc3BsYXlPYmplY3QubGFzdDsKCXdoaWxlKGxhc3RSZW5kZXJhYmxlLl9pUHJldikKCXsKCQlpZihsYXN0UmVuZGVyYWJsZS5yZW5kZXJhYmxlICYmIGxhc3RSZW5kZXJhYmxlLl9fcmVuZGVyR3JvdXApYnJlYWs7CgkJbGFzdFJlbmRlcmFibGUgPSBsYXN0UmVuZGVyYWJsZS5faU5leHQ7Cgl9CgkKCWlmKGxhc3RSZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgl7CgkJZW5kQmF0Y2ggPSBsYXN0UmVuZGVyYWJsZS5iYXRjaDsKCQkKCQl2YXIgaGVhZCA9IGVuZEJhdGNoLmhlYWQ7CgkJCgkJaWYoaGVhZCA9PSBsYXN0UmVuZGVyYWJsZSkKCQl7CgkJCWVuZEluZGV4ID0gMDsKCQl9CgkJZWxzZQoJCXsKCQkJZW5kSW5kZXggPSAxOwoJCQkKCQkJd2hpbGUoaGVhZC5fX25leHQgIT0gbGFzdFJlbmRlcmFibGUpCgkJCXsKCQkJCWVuZEluZGV4Kys7CgkJCQloZWFkID0gaGVhZC5fX25leHQ7CgkJCX0KCQl9Cgl9CgllbHNlCgl7CgkJZW5kQmF0Y2ggPSBsYXN0UmVuZGVyYWJsZTsKCX0KCQoJaWYoc3RhcnRCYXRjaCA9PSBlbmRCYXRjaCkKCXsKCQlpZihzdGFydEJhdGNoIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoKQoJCXsKCQkJc3RhcnRCYXRjaC5yZW5kZXIoc3RhcnRJbmRleCwgZW5kSW5kZXgrMSk7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMucmVuZGVyU3BlY2lhbChzdGFydEJhdGNoLCBwcm9qZWN0aW9uKTsKCQl9CgkJcmV0dXJuOwoJfQoJCgkvLyBub3cgd2UgaGF2ZSBmaXJzdCBhbmQgbGFzdCEKCXN0YXJ0QmF0Y2hJbmRleCA9IHRoaXMuYmF0Y2hzLmluZGV4T2Yoc3RhcnRCYXRjaCk7CgllbmRCYXRjaEluZGV4ID0gdGhpcy5iYXRjaHMuaW5kZXhPZihlbmRCYXRjaCk7CgkKCS8vIERPIHRoZSBmaXJzdCBiYXRjaAoJaWYoc3RhcnRCYXRjaCBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaCkKCXsKCQlzdGFydEJhdGNoLnJlbmRlcihzdGFydEluZGV4KTsKCX0KCWVsc2UKCXsKCQl0aGlzLnJlbmRlclNwZWNpYWwoc3RhcnRCYXRjaCwgcHJvamVjdGlvbik7Cgl9CgkKCS8vIERPIHRoZSBtaWRkbGUgYmF0Y2hzLi4KCWZvciAodmFyIGk9c3RhcnRCYXRjaEluZGV4KzE7IGkgPCBlbmRCYXRjaEluZGV4OyBpKyspIAoJewoJCXJlbmRlcmFibGUgPSB0aGlzLmJhdGNoc1tpXTsKCQoJCWlmKHJlbmRlcmFibGUgaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2gpCgkJewoJCQl0aGlzLmJhdGNoc1tpXS5yZW5kZXIoKTsKCQl9CgkJZWxzZQoJCXsKCQkJdGhpcy5yZW5kZXJTcGVjaWFsKHJlbmRlcmFibGUsIHByb2plY3Rpb24pOwoJCX0KCX0KCQoJLy8gRE8gdGhlIGxhc3QgYmF0Y2guLgoJaWYoZW5kQmF0Y2ggaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2gpCgl7CgkJZW5kQmF0Y2gucmVuZGVyKDAsIGVuZEluZGV4KzEpOwoJfQoJZWxzZQoJewoJCXRoaXMucmVuZGVyU3BlY2lhbChlbmRCYXRjaCwgcHJvamVjdGlvbik7Cgl9Cn0KCi8qKgogKiBSZW5kZXJzIGEgc3BlY2lmaWMgcmVuZGVyYWJsZQogKgogKiBAbWV0aG9kIHJlbmRlclNwZWNpYWwKICogQHBhcmFtIHJlbmRlcmFibGUge0Rpc3BsYXlPYmplY3R9CiAqIEBwYXJhbSBwcm9qZWN0aW9uIHtPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnJlbmRlclNwZWNpYWwgPSBmdW5jdGlvbihyZW5kZXJhYmxlLCBwcm9qZWN0aW9uKQp7CgkKCXZhciB3b3JsZFZpc2libGUgPSByZW5kZXJhYmxlLnZjb3VudCA9PT0gUElYSS52aXNpYmxlQ291bnQKCgoJaWYocmVuZGVyYWJsZSBpbnN0YW5jZW9mIFBJWEkuVGlsaW5nU3ByaXRlKQoJewoJCWlmKHdvcmxkVmlzaWJsZSl0aGlzLnJlbmRlclRpbGluZ1Nwcml0ZShyZW5kZXJhYmxlLCBwcm9qZWN0aW9uKTsKCX0KCWVsc2UgaWYocmVuZGVyYWJsZSBpbnN0YW5jZW9mIFBJWEkuU3RyaXApCgl7CgkJaWYod29ybGRWaXNpYmxlKXRoaXMucmVuZGVyU3RyaXAocmVuZGVyYWJsZSwgcHJvamVjdGlvbik7Cgl9CgllbHNlIGlmKHJlbmRlcmFibGUgaW5zdGFuY2VvZiBQSVhJLkN1c3RvbVJlbmRlcmFibGUpCgl7CgkJaWYod29ybGRWaXNpYmxlKSByZW5kZXJhYmxlLnJlbmRlcldlYkdMKHRoaXMsIHByb2plY3Rpb24pOwoJfQoJZWxzZSBpZihyZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5HcmFwaGljcykKCXsKCQlpZih3b3JsZFZpc2libGUgJiYgcmVuZGVyYWJsZS5yZW5kZXJhYmxlKSBQSVhJLldlYkdMR3JhcGhpY3MucmVuZGVyR3JhcGhpY3MocmVuZGVyYWJsZSwgcHJvamVjdGlvbik7Cgl9CgllbHNlIGlmKHJlbmRlcmFibGUgaW5zdGFuY2VvZiBQSVhJLkZpbHRlckJsb2NrKQoJewoJCXRoaXMuaGFuZGxlRmlsdGVyQmxvY2socmVuZGVyYWJsZSwgcHJvamVjdGlvbik7Cgl9Cn0KCmZsaXAgPSBmYWxzZTsKdmFyIG1hc2tTdGFjayA9IFtdOwp2YXIgbWFza1Bvc2l0aW9uID0gMDsKCi8vdmFyIHVzZWRNYXNrU3RhY2sgPSBbXTsKClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUuaGFuZGxlRmlsdGVyQmxvY2sgPSBmdW5jdGlvbihmaWx0ZXJCbG9jaywgcHJvamVjdGlvbikKewoJLyoKCSAqIGZvciBub3cgb25seSBtYXNrcyBhcmUgc3VwcG9ydGVkLi4KCSAqLwoJdmFyIGdsID0gUElYSS5nbDsKCQoJaWYoZmlsdGVyQmxvY2sub3BlbikKCXsKCQlpZihmaWx0ZXJCbG9jay5kYXRhIGluc3RhbmNlb2YgQXJyYXkpCgkJewoJCQl0aGlzLmZpbHRlck1hbmFnZXIucHVzaEZpbHRlcihmaWx0ZXJCbG9jayk7CgkJCS8vIG9rIHNvLi4KCQkJCgkJfQoJCWVsc2UKCQl7CQoJCQltYXNrUG9zaXRpb24rKzsKCgkJCW1hc2tTdGFjay5wdXNoKGZpbHRlckJsb2NrKQoJCgkJCWdsLmVuYWJsZShnbC5TVEVOQ0lMX1RFU1QpOwoJCQkKCQkJZ2wuY29sb3JNYXNrKGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlKTsKCQkJCgkJCWdsLnN0ZW5jaWxGdW5jKGdsLkFMV0FZUywxLDEpOwoJCQlnbC5zdGVuY2lsT3AoZ2wuS0VFUCxnbC5LRUVQLGdsLklOQ1IpOwoJCgkJCVBJWEkuV2ViR0xHcmFwaGljcy5yZW5kZXJHcmFwaGljcyhmaWx0ZXJCbG9jay5kYXRhLCBwcm9qZWN0aW9uKTsKCQkJCgkJCWdsLmNvbG9yTWFzayh0cnVlLCB0cnVlLCB0cnVlLCB0cnVlKTsKCQkJZ2wuc3RlbmNpbEZ1bmMoZ2wuTk9URVFVQUwsMCxtYXNrU3RhY2subGVuZ3RoKTsKCQkJZ2wuc3RlbmNpbE9wKGdsLktFRVAsZ2wuS0VFUCxnbC5LRUVQKTsKCQl9Cgl9CgllbHNlCgl7CgkJaWYoZmlsdGVyQmxvY2suZGF0YSBpbnN0YW5jZW9mIEFycmF5KQoJCXsKCQkJdGhpcy5maWx0ZXJNYW5hZ2VyLnBvcEZpbHRlcigpOwoJCX0KCQllbHNlCgkJewoJCQl2YXIgbWFza0RhdGEgPSBtYXNrU3RhY2sucG9wKGZpbHRlckJsb2NrKQoKCgkJCWlmKG1hc2tEYXRhKQoJCQl7CgkJCQlnbC5jb2xvck1hc2soZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UpOwoJCQkKCQkJCWdsLnN0ZW5jaWxGdW5jKGdsLkFMV0FZUywxLDEpOwoJCQkJZ2wuc3RlbmNpbE9wKGdsLktFRVAsZ2wuS0VFUCxnbC5ERUNSKTsKCgkJCQlQSVhJLldlYkdMR3JhcGhpY3MucmVuZGVyR3JhcGhpY3MobWFza0RhdGEuZGF0YSwgcHJvamVjdGlvbik7CgkJCQoJCQkJZ2wuY29sb3JNYXNrKHRydWUsIHRydWUsIHRydWUsIHRydWUpOwoJCQkJZ2wuc3RlbmNpbEZ1bmMoZ2wuTk9URVFVQUwsMCxtYXNrU3RhY2subGVuZ3RoKTsKCQkJCWdsLnN0ZW5jaWxPcChnbC5LRUVQLGdsLktFRVAsZ2wuS0VFUCk7CgkJCX07CgoJCQlnbC5kaXNhYmxlKGdsLlNURU5DSUxfVEVTVCk7CgkJfQoJfQp9CgovKioKICogVXBkYXRlcyBhIHdlYmdsIHRleHR1cmUKICoKICogQG1ldGhvZCB1cGRhdGVUZXh0dXJlCiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS51cGRhdGVUZXh0dXJlID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCkKewoJCgkvLyBUT0RPIGRlZmluaXRlbHkgY2FuIG9wdGltc2UgdGhpcyBmdW5jdGlvbi4uCgkKCXRoaXMucmVtb3ZlT2JqZWN0KGRpc3BsYXlPYmplY3QpOwoJCgkvKgoJICogIExPT0sgRk9SIFRIRSBQUkVWSU9VUyBSRU5ERVJBQkxFCgkgKiAgVGhpcyBwYXJ0IGxvb2tzIGZvciB0aGUgY2xvc2VzdCBwcmV2aW91cyBzcHJpdGUgdGhhdCBjYW4gZ28gaW50byBhIGJhdGNoCgkgKiAgSXQga2VlcHMgZ29pbmcgYmFjayB1bnRpbCBpdCBmaW5kcyBhIHNwcml0ZSBvciB0aGUgc3RhZ2UKCSAqLwoJdmFyIHByZXZpb3VzUmVuZGVyYWJsZSA9IGRpc3BsYXlPYmplY3QuZmlyc3Q7Cgl3aGlsZShwcmV2aW91c1JlbmRlcmFibGUgIT0gdGhpcy5yb290KQoJewoJCXByZXZpb3VzUmVuZGVyYWJsZSA9IHByZXZpb3VzUmVuZGVyYWJsZS5faVByZXY7CgkJaWYocHJldmlvdXNSZW5kZXJhYmxlLnJlbmRlcmFibGUgJiYgcHJldmlvdXNSZW5kZXJhYmxlLl9fcmVuZGVyR3JvdXApYnJlYWs7Cgl9CgkKCS8qCgkgKiAgTE9PSyBGT1IgVEhFIE5FWFQgU1BSSVRFCgkgKiAgVGhpcyBwYXJ0IGxvb2tzIGZvciB0aGUgY2xvc2VzdCBuZXh0IHNwcml0ZSB0aGF0IGNhbiBnbyBpbnRvIGEgYmF0Y2gKCSAqICBpdCBrZWVwcyBsb29raW5nIHVudGlsIGl0IGZpbmRzIGEgc3ByaXRlIG9yIGdldHMgdG8gdGhlIGVuZCBvZiB0aGUgZGlzcGxheQoJICogIHNjZW5lIGdyYXBoCgkgKi8KCXZhciBuZXh0UmVuZGVyYWJsZSA9IGRpc3BsYXlPYmplY3QubGFzdDsKCXdoaWxlKG5leHRSZW5kZXJhYmxlLl9pTmV4dCkKCXsKCQluZXh0UmVuZGVyYWJsZSA9IG5leHRSZW5kZXJhYmxlLl9pTmV4dDsKCQlpZihuZXh0UmVuZGVyYWJsZS5yZW5kZXJhYmxlICYmIG5leHRSZW5kZXJhYmxlLl9fcmVuZGVyR3JvdXApYnJlYWs7Cgl9CgkKCXRoaXMuaW5zZXJ0T2JqZWN0KGRpc3BsYXlPYmplY3QsIHByZXZpb3VzUmVuZGVyYWJsZSwgbmV4dFJlbmRlcmFibGUpOwp9CgovKioKICogQWRkcyBmaWx0ZXIgYmxvY2tzCiAqCiAqIEBtZXRob2QgYWRkRmlsdGVyQmxvY2tzCiAqIEBwYXJhbSBzdGFydCB7RmlsdGVyQmxvY2t9CiAqIEBwYXJhbSBlbmQge0ZpbHRlckJsb2NrfQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5hZGRGaWx0ZXJCbG9ja3MgPSBmdW5jdGlvbihzdGFydCwgZW5kKQp7CglzdGFydC5fX3JlbmRlckdyb3VwID0gdGhpczsKCWVuZC5fX3JlbmRlckdyb3VwID0gdGhpczsKCS8qCgkgKiAgTE9PSyBGT1IgVEhFIFBSRVZJT1VTIFJFTkRFUkFCTEUKCSAqICBUaGlzIHBhcnQgbG9va3MgZm9yIHRoZSBjbG9zZXN0IHByZXZpb3VzIHNwcml0ZSB0aGF0IGNhbiBnbyBpbnRvIGEgYmF0Y2gKCSAqICBJdCBrZWVwcyBnb2luZyBiYWNrIHVudGlsIGl0IGZpbmRzIGEgc3ByaXRlIG9yIHRoZSBzdGFnZQoJICovCgl2YXIgcHJldmlvdXNSZW5kZXJhYmxlID0gc3RhcnQ7Cgl3aGlsZShwcmV2aW91c1JlbmRlcmFibGUgIT0gdGhpcy5yb290LmZpcnN0KQoJewoJCXByZXZpb3VzUmVuZGVyYWJsZSA9IHByZXZpb3VzUmVuZGVyYWJsZS5faVByZXY7CgkJaWYocHJldmlvdXNSZW5kZXJhYmxlLnJlbmRlcmFibGUgJiYgcHJldmlvdXNSZW5kZXJhYmxlLl9fcmVuZGVyR3JvdXApYnJlYWs7Cgl9Cgl0aGlzLmluc2VydEFmdGVyKHN0YXJ0LCBwcmV2aW91c1JlbmRlcmFibGUpOwoJCQoJLyoKCSAqICBMT09LIEZPUiBUSEUgTkVYVCBTUFJJVEUKCSAqICBUaGlzIHBhcnQgbG9va3MgZm9yIHRoZSBjbG9zZXN0IG5leHQgc3ByaXRlIHRoYXQgY2FuIGdvIGludG8gYSBiYXRjaAoJICogIGl0IGtlZXBzIGxvb2tpbmcgdW50aWwgaXQgZmluZHMgYSBzcHJpdGUgb3IgZ2V0cyB0byB0aGUgZW5kIG9mIHRoZSBkaXNwbGF5CgkgKiAgc2NlbmUgZ3JhcGgKCSAqLwoJdmFyIHByZXZpb3VzUmVuZGVyYWJsZTIgPSBlbmQ7Cgl3aGlsZShwcmV2aW91c1JlbmRlcmFibGUyICE9IHRoaXMucm9vdC5maXJzdCkKCXsKCQlwcmV2aW91c1JlbmRlcmFibGUyID0gcHJldmlvdXNSZW5kZXJhYmxlMi5faVByZXY7CgkJaWYocHJldmlvdXNSZW5kZXJhYmxlMi5yZW5kZXJhYmxlICYmIHByZXZpb3VzUmVuZGVyYWJsZTIuX19yZW5kZXJHcm91cClicmVhazsKCX0KCXRoaXMuaW5zZXJ0QWZ0ZXIoZW5kLCBwcmV2aW91c1JlbmRlcmFibGUyKTsKfQoKLyoqCiAqIFJlbW92ZSBmaWx0ZXIgYmxvY2tzCiAqCiAqIEBtZXRob2QgcmVtb3ZlRmlsdGVyQmxvY2tzCiAqIEBwYXJhbSBzdGFydCB7RmlsdGVyQmxvY2t9CiAqIEBwYXJhbSBlbmQge0ZpbHRlckJsb2NrfQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5yZW1vdmVGaWx0ZXJCbG9ja3MgPSBmdW5jdGlvbihzdGFydCwgZW5kKQp7Cgl0aGlzLnJlbW92ZU9iamVjdChzdGFydCk7Cgl0aGlzLnJlbW92ZU9iamVjdChlbmQpOwp9CgovKioKICogQWRkcyBhIGRpc3BsYXkgb2JqZWN0IGFuZCBjaGlsZHJlbiB0byB0aGUgd2ViZ2wgY29udGV4dAogKgogKiBAbWV0aG9kIGFkZERpc3BsYXlPYmplY3RBbmRDaGlsZHJlbgogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUuYWRkRGlzcGxheU9iamVjdEFuZENoaWxkcmVuID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCkKewoJaWYoZGlzcGxheU9iamVjdC5fX3JlbmRlckdyb3VwKWRpc3BsYXlPYmplY3QuX19yZW5kZXJHcm91cC5yZW1vdmVEaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4oZGlzcGxheU9iamVjdCk7CgkKCS8qCgkgKiAgTE9PSyBGT1IgVEhFIFBSRVZJT1VTIFJFTkRFUkFCTEUKCSAqICBUaGlzIHBhcnQgbG9va3MgZm9yIHRoZSBjbG9zZXN0IHByZXZpb3VzIHNwcml0ZSB0aGF0IGNhbiBnbyBpbnRvIGEgYmF0Y2gKCSAqICBJdCBrZWVwcyBnb2luZyBiYWNrIHVudGlsIGl0IGZpbmRzIGEgc3ByaXRlIG9yIHRoZSBzdGFnZQoJICovCgkKCXZhciBwcmV2aW91c1JlbmRlcmFibGUgPSBkaXNwbGF5T2JqZWN0LmZpcnN0OwoJd2hpbGUocHJldmlvdXNSZW5kZXJhYmxlICE9IHRoaXMucm9vdC5maXJzdCkKCXsKCQlwcmV2aW91c1JlbmRlcmFibGUgPSBwcmV2aW91c1JlbmRlcmFibGUuX2lQcmV2OwoJCWlmKHByZXZpb3VzUmVuZGVyYWJsZS5yZW5kZXJhYmxlICYmIHByZXZpb3VzUmVuZGVyYWJsZS5fX3JlbmRlckdyb3VwKWJyZWFrOwoJfQoJCgkvKgoJICogIExPT0sgRk9SIFRIRSBORVhUIFNQUklURQoJICogIFRoaXMgcGFydCBsb29rcyBmb3IgdGhlIGNsb3Nlc3QgbmV4dCBzcHJpdGUgdGhhdCBjYW4gZ28gaW50byBhIGJhdGNoCgkgKiAgaXQga2VlcHMgbG9va2luZyB1bnRpbCBpdCBmaW5kcyBhIHNwcml0ZSBvciBnZXRzIHRvIHRoZSBlbmQgb2YgdGhlIGRpc3BsYXkKCSAqICBzY2VuZSBncmFwaAoJICovCgl2YXIgbmV4dFJlbmRlcmFibGUgPSBkaXNwbGF5T2JqZWN0Lmxhc3Q7Cgl3aGlsZShuZXh0UmVuZGVyYWJsZS5faU5leHQpCgl7CgkJbmV4dFJlbmRlcmFibGUgPSBuZXh0UmVuZGVyYWJsZS5faU5leHQ7CgkJaWYobmV4dFJlbmRlcmFibGUucmVuZGVyYWJsZSAmJiBuZXh0UmVuZGVyYWJsZS5fX3JlbmRlckdyb3VwKWJyZWFrOwoJfQoJCgkvLyBvbmUgdGhlIGRpc3BsYXkgb2JqZWN0IGhpdHMgdGhpcy4gd2UgY2FuIGJyZWFrIHRoZSBsb29wCQoJCgl2YXIgdGVtcE9iamVjdCA9IGRpc3BsYXlPYmplY3QuZmlyc3Q7Cgl2YXIgdGVzdE9iamVjdCA9IGRpc3BsYXlPYmplY3QubGFzdC5faU5leHQ7CglkbwkKCXsKCQl0ZW1wT2JqZWN0Ll9fcmVuZGVyR3JvdXAgPSB0aGlzOwoJCQoJCWlmKHRlbXBPYmplY3QucmVuZGVyYWJsZSkKCQl7CgkJCgkJCXRoaXMuaW5zZXJ0T2JqZWN0KHRlbXBPYmplY3QsIHByZXZpb3VzUmVuZGVyYWJsZSwgbmV4dFJlbmRlcmFibGUpOwoJCQlwcmV2aW91c1JlbmRlcmFibGUgPSB0ZW1wT2JqZWN0OwoJCX0KCQkKCQl0ZW1wT2JqZWN0ID0gdGVtcE9iamVjdC5faU5leHQ7Cgl9Cgl3aGlsZSh0ZW1wT2JqZWN0ICE9IHRlc3RPYmplY3QpCn0KCi8qKgogKiBSZW1vdmVzIGEgZGlzcGxheSBvYmplY3QgYW5kIGNoaWxkcmVuIHRvIHRoZSB3ZWJnbCBjb250ZXh0CiAqCiAqIEBtZXRob2QgcmVtb3ZlRGlzcGxheU9iamVjdEFuZENoaWxkcmVuCiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5yZW1vdmVEaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4gPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0KQp7CglpZihkaXNwbGF5T2JqZWN0Ll9fcmVuZGVyR3JvdXAgIT0gdGhpcylyZXR1cm47CgkKLy8JdmFyIGRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0LmZpcnN0OwoJdmFyIGxhc3RPYmplY3QgPSBkaXNwbGF5T2JqZWN0Lmxhc3Q7CglkbwkKCXsKCQlkaXNwbGF5T2JqZWN0Ll9fcmVuZGVyR3JvdXAgPSBudWxsOwoJCWlmKGRpc3BsYXlPYmplY3QucmVuZGVyYWJsZSl0aGlzLnJlbW92ZU9iamVjdChkaXNwbGF5T2JqZWN0KTsKCQlkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5faU5leHQ7Cgl9Cgl3aGlsZShkaXNwbGF5T2JqZWN0KQp9CgovKioKICogSW5zZXJ0cyBhIGRpc3BsYXlPYmplY3QgaW50byB0aGUgbGlua2VkIGxpc3QKICoKICogQG1ldGhvZCBpbnNlcnRPYmplY3QKICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9CiAqIEBwYXJhbSBwcmV2aW91c09iamVjdCB7RGlzcGxheU9iamVjdH0KICogQHBhcmFtIG5leHRPYmplY3Qge0Rpc3BsYXlPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLmluc2VydE9iamVjdCA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QsIHByZXZpb3VzT2JqZWN0LCBuZXh0T2JqZWN0KQp7CgkvLyB3aGlsZSBsb29waW5nIGJlbG93IFRIRSBPQkpFQ1QgTUFZIE5PVCBIQVZFIEJFRU4gQURERUQKCXZhciBwcmV2aW91c1Nwcml0ZSA9IHByZXZpb3VzT2JqZWN0OwoJdmFyIG5leHRTcHJpdGUgPSBuZXh0T2JqZWN0OwoJCgkvKgoJICogc28gbm93IHdlIGhhdmUgdGhlIG5leHQgcmVuZGVyYWJsZSBhbmQgdGhlIHByZXZpb3VzIHJlbmRlcmFibGUKCSAqIAoJICovCglpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgl7CgkJdmFyIHByZXZpb3VzQmF0Y2gKCQl2YXIgbmV4dEJhdGNoCgkJCgkJaWYocHJldmlvdXNTcHJpdGUgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKCQl7CgkJCXByZXZpb3VzQmF0Y2ggPSBwcmV2aW91c1Nwcml0ZS5iYXRjaDsKCQkJaWYocHJldmlvdXNCYXRjaCkKCQkJewoJCQkJaWYocHJldmlvdXNCYXRjaC50ZXh0dXJlID09IGRpc3BsYXlPYmplY3QudGV4dHVyZS5iYXNlVGV4dHVyZSAmJiBwcmV2aW91c0JhdGNoLmJsZW5kTW9kZSA9PSBkaXNwbGF5T2JqZWN0LmJsZW5kTW9kZSkKCQkJCXsKCQkJCQlwcmV2aW91c0JhdGNoLmluc2VydEFmdGVyKGRpc3BsYXlPYmplY3QsIHByZXZpb3VzU3ByaXRlKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCQl9CgkJZWxzZQoJCXsKCQkJLy8gVE9ETyByZXdvcmQhCgkJCXByZXZpb3VzQmF0Y2ggPSBwcmV2aW91c1Nwcml0ZTsKCQl9CgkKCQlpZihuZXh0U3ByaXRlKQoJCXsKCQkJaWYobmV4dFNwcml0ZSBpbnN0YW5jZW9mIFBJWEkuU3ByaXRlKQoJCQl7CgkJCQluZXh0QmF0Y2ggPSBuZXh0U3ByaXRlLmJhdGNoOwoJCQkKCQkJCS8vYmF0Y2ggbWF5IG5vdCBleGlzdCBpZiBpdGVtIHdhcyBhZGRlZCB0byB0aGUgZGlzcGxheSBsaXN0IGJ1dCBub3QgdG8gdGhlIHdlYkdMCgkJCQlpZihuZXh0QmF0Y2gpCgkJCQl7CgkJCQkJaWYobmV4dEJhdGNoLnRleHR1cmUgPT0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmJhc2VUZXh0dXJlICYmIG5leHRCYXRjaC5ibGVuZE1vZGUgPT0gZGlzcGxheU9iamVjdC5ibGVuZE1vZGUpCgkJCQkJewoJCQkJCQluZXh0QmF0Y2guaW5zZXJ0QmVmb3JlKGRpc3BsYXlPYmplY3QsIG5leHRTcHJpdGUpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJCWVsc2UKCQkJCQl7CgkJCQkJCWlmKG5leHRCYXRjaCA9PSBwcmV2aW91c0JhdGNoKQoJCQkJCQl7CgkJCQkJCQkvLyBUSEVSRSBJUyBBIFNQTElUIElOIFRISVMgQkFUQ0ghIC8vCgkJCQkJCQl2YXIgc3BsaXRCYXRjaCA9IHByZXZpb3VzQmF0Y2guc3BsaXQobmV4dFNwcml0ZSk7CgkJCQkJCQkvLyBDT09MIQoJCQkJCQkJLy8gYWRkIGl0IGJhY2sgaW50byB0aGUgYXJyYXkJCgkJCQkJCQkvKgoJCQkJCQkJICogT09QUyEKCQkJCQkJCSAqIHNlZW1zIHRoZSBuZXcgc3ByaXRlIGlzIGluIHRoZSBtaWRkbGUgb2YgYSBiYXRjaAoJCQkJCQkJICogbGV0cyBzcGxpdCBpdC4uIAoJCQkJCQkJICovCgkJCQkJCQl2YXIgYmF0Y2ggPSBQSVhJLldlYkdMUmVuZGVyZXIuZ2V0QmF0Y2goKTsKCgkJCQkJCQl2YXIgaW5kZXggPSB0aGlzLmJhdGNocy5pbmRleE9mKCBwcmV2aW91c0JhdGNoICk7CgkJCQkJCQliYXRjaC5pbml0KGRpc3BsYXlPYmplY3QpOwoJCQkJCQkJdGhpcy5iYXRjaHMuc3BsaWNlKGluZGV4KzEsIDAsIGJhdGNoLCBzcGxpdEJhdGNoKTsKCQkJCQkJCQoJCQkJCQkJcmV0dXJuOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJCWVsc2UKCQkJewoJCQkJLy8gVE9ETyByZS13b3JkIQoJCQkJCgkJCQluZXh0QmF0Y2ggPSBuZXh0U3ByaXRlOwoJCQl9CgkJfQoJCQoJCS8qCgkJICogbG9va3MgbGlrZSBpdCBkb2VzIG5vdCBiZWxvbmcgdG8gYW55IGJhdGNoIQoJCSAqIGJ1dCBpcyBhbHNvIG5vdCBpbnRlcnNlY3Rpbmcgb25lLi4KCQkgKiB0aW1lIHRvIGNyZWF0ZSBhbmV3IG9uZSEKCQkgKi8KCQkKCQl2YXIgYmF0Y2ggPSAgUElYSS5XZWJHTFJlbmRlcmVyLmdldEJhdGNoKCk7CgkJYmF0Y2guaW5pdChkaXNwbGF5T2JqZWN0KTsKCgkJaWYocHJldmlvdXNCYXRjaCkgLy8gaWYgdGhpcyBpcyBpbnZhbGlkIGl0IG1lYW5zIAoJCXsKCQkJdmFyIGluZGV4ID0gdGhpcy5iYXRjaHMuaW5kZXhPZiggcHJldmlvdXNCYXRjaCApOwoJCQl0aGlzLmJhdGNocy5zcGxpY2UoaW5kZXgrMSwgMCwgYmF0Y2gpOwoJCX0KCQllbHNlCgkJewoJCQl0aGlzLmJhdGNocy5wdXNoKGJhdGNoKTsKCQl9CgkJCgkJcmV0dXJuOwoJfQoJZWxzZSBpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5UaWxpbmdTcHJpdGUpCgl7CgkJCgkJLy8gYWRkIHRvIGEgYmF0Y2ghIQoJCXRoaXMuaW5pdFRpbGluZ1Nwcml0ZShkaXNwbGF5T2JqZWN0KTsKCS8vCXRoaXMuYmF0Y2hzLnB1c2goZGlzcGxheU9iamVjdCk7CgkJCgl9CgllbHNlIGlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlN0cmlwKQoJewoJCS8vIGFkZCB0byBhIGJhdGNoISEKCQl0aGlzLmluaXRTdHJpcChkaXNwbGF5T2JqZWN0KTsKCS8vCXRoaXMuYmF0Y2hzLnB1c2goZGlzcGxheU9iamVjdCk7Cgl9CgllbHNlIGlmKGRpc3BsYXlPYmplY3QpLy8gaW5zdGFuY2VvZiBQSVhJLkdyYXBoaWNzKQoJewoJCS8vZGlzcGxheU9iamVjdC5pbml0V2ViR0wodGhpcyk7CgkJCgkJLy8gYWRkIHRvIGEgYmF0Y2ghIQoJCS8vdGhpcy5pbml0U3RyaXAoZGlzcGxheU9iamVjdCk7CgkJLy90aGlzLmJhdGNocy5wdXNoKGRpc3BsYXlPYmplY3QpOwoJfQoJCgl0aGlzLmluc2VydEFmdGVyKGRpc3BsYXlPYmplY3QsIHByZXZpb3VzU3ByaXRlKTsKCQkJCgkvLyBpbnNlcnQgYW5kIFNQTElUIQoKfQoKLyoqCiAqIEluc2VydHMgYSBkaXNwbGF5T2JqZWN0IGludG8gdGhlIGxpbmtlZCBsaXN0CiAqCiAqIEBtZXRob2QgaW5zZXJ0QWZ0ZXIKICogQHBhcmFtIGl0ZW0ge0Rpc3BsYXlPYmplY3R9CiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fSBUaGUgb2JqZWN0IHRvIGluc2VydAogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5pbnNlcnRBZnRlciA9IGZ1bmN0aW9uKGl0ZW0sIGRpc3BsYXlPYmplY3QpCnsKCWlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKCXsKCQl2YXIgcHJldmlvdXNCYXRjaCA9IGRpc3BsYXlPYmplY3QuYmF0Y2g7CgkJCgkJaWYocHJldmlvdXNCYXRjaCkKCQl7CgkJCS8vIHNvIHRoaXMgb2JqZWN0IGlzIGluIGEgYmF0Y2ghCgkJCQoJCQkvLyBpcyBpdCBub3Q/IG5lZWQgdG8gc3BsaXQgdGhlIGJhdGNoCgkJCWlmKHByZXZpb3VzQmF0Y2gudGFpbCA9PSBkaXNwbGF5T2JqZWN0KQoJCQl7CgkJCQkvLyBpcyBpdCB0YWlsPyBpbnNlcnQgaW4gdG8gYmF0Y2hzCQoJCQkJdmFyIGluZGV4ID0gdGhpcy5iYXRjaHMuaW5kZXhPZiggcHJldmlvdXNCYXRjaCApOwoJCQkJdGhpcy5iYXRjaHMuc3BsaWNlKGluZGV4KzEsIDAsIGl0ZW0pOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJLy8gVE9ETyBNT0RJRlkgQUREIC8gUkVNT1ZFIENISUxEIFRPIEFDQ09VTlQgRk9SIEZJTFRFUlMgKGFsc28gZ2V0IHByZXYgYW5kIG5leHQpIC8vCgkJCQkKCQkJCS8vIFRIRVJFIElTIEEgU1BMSVQgSU4gVEhJUyBCQVRDSCEgLy8KCQkJCXZhciBzcGxpdEJhdGNoID0gcHJldmlvdXNCYXRjaC5zcGxpdChkaXNwbGF5T2JqZWN0Ll9fbmV4dCk7CgkJCQkKCQkJCS8vIENPT0whCgkJCQkvLyBhZGQgaXQgYmFjayBpbnRvIHRoZSBhcnJheQkKCQkJCS8qCgkJCQkgKiBPT1BTIQoJCQkJICogc2VlbXMgdGhlIG5ldyBzcHJpdGUgaXMgaW4gdGhlIG1pZGRsZSBvZiBhIGJhdGNoCgkJCQkgKiBsZXRzIHNwbGl0IGl0Li4gCgkJCQkgKi8KCQkJCXZhciBpbmRleCA9IHRoaXMuYmF0Y2hzLmluZGV4T2YoIHByZXZpb3VzQmF0Y2ggKTsKCQkJCXRoaXMuYmF0Y2hzLnNwbGljZShpbmRleCsxLCAwLCBpdGVtLCBzcGxpdEJhdGNoKTsKCQkJfQoJCX0KCQllbHNlCgkJewoJCQl0aGlzLmJhdGNocy5wdXNoKGl0ZW0pOwoJCX0KCX0KCWVsc2UKCXsKCQl2YXIgaW5kZXggPSB0aGlzLmJhdGNocy5pbmRleE9mKCBkaXNwbGF5T2JqZWN0ICk7CgkJdGhpcy5iYXRjaHMuc3BsaWNlKGluZGV4KzEsIDAsIGl0ZW0pOwoJfQp9CgovKioKICogUmVtb3ZlcyBhIGRpc3BsYXlPYmplY3QgZnJvbSB0aGUgbGlua2VkIGxpc3QKICoKICogQG1ldGhvZCByZW1vdmVPYmplY3QKICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9IFRoZSBvYmplY3QgdG8gcmVtb3ZlCiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnJlbW92ZU9iamVjdCA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QpCnsKCS8vIGxvb3AgdGhyb3VnaCBjaGlsZHJlbi4uCgkvLyBkaXNwbGF5IG9iamVjdCAvLwoJCgkvLyBhZGQgYSBjaGlsZCBmcm9tIHRoZSByZW5kZXIgZ3JvdXAuLgoJLy8gcmVtb3ZlIGl0IGFuZCBhbGwgaXRzIGNoaWxkcmVuIQoJLy9kaXNwbGF5T2JqZWN0LmNhY2hlVmlzaWJsZSA9IGZhbHNlOy8vZGlzcGxheU9iamVjdC52aXNpYmxlOwoKCS8qCgkgKiByZW1vdmluZyBpcyBhIGxvdCBxdWlja2VyLi4KCSAqIAoJICovCgl2YXIgYmF0Y2hUb1JlbW92ZTsKCQoJaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuU3ByaXRlKQoJewoJCS8vIHNob3VsZCBhbHdheXMgaGF2ZSBhIGJhdGNoIQoJCXZhciBiYXRjaCA9IGRpc3BsYXlPYmplY3QuYmF0Y2g7CgkJaWYoIWJhdGNoKXJldHVybjsgLy8gdGhpcyBtZWFucyB0aGUgZGlzcGxheSBsaXN0IGhhcyBiZWVuIGFsdGVyZWQgYmVmcmUgcmVuZGVyaW5nCgkJCgkJYmF0Y2gucmVtb3ZlKGRpc3BsYXlPYmplY3QpOwoJCQoJCWlmKGJhdGNoLnNpemU9PTApCgkJewoJCQliYXRjaFRvUmVtb3ZlID0gYmF0Y2g7CgkJfQoJfQoJZWxzZQoJewoJCWJhdGNoVG9SZW1vdmUgPSBkaXNwbGF5T2JqZWN0OwoJfQoJCgkvKgoJICogTG9va3MgbGlrZSB0aGVyZSBpcyBzb210aGluZyB0aGF0IG5lZWRzIHJlbW92aW5nIQoJICovCglpZihiYXRjaFRvUmVtb3ZlKQkKCXsKCQl2YXIgaW5kZXggPSB0aGlzLmJhdGNocy5pbmRleE9mKCBiYXRjaFRvUmVtb3ZlICk7CgkJaWYoaW5kZXggPT0gLTEpcmV0dXJuOy8vIHRoaXMgbWVhbnMgaXQgd2FzIGFkZGVkIHRoZW4gcmVtb3ZlZCBiZWZvcmUgcmVuZGVyZWQKCQkKCQkvLyBvayBzby4uIGNoZWNrIHRvIHNlZSBpZiB5b3UgYWRqYWNlbnQgYmF0Y2hzIHNob3VsZCBiZSBqb2luZWQuCgkJLy8gVE9ETyBtYXkgb3B0aW1pc2U/CgkJaWYoaW5kZXggPT0gMCB8fCBpbmRleCA9PSB0aGlzLmJhdGNocy5sZW5ndGgtMSkKCQl7CgkJCS8vIHdoYSAtIGV2YSEganVzdCBnZXQgb2YgdGhlIGVtcHR5IGJhdGNoIQoJCQl0aGlzLmJhdGNocy5zcGxpY2UoaW5kZXgsIDEpOwoJCQlpZihiYXRjaFRvUmVtb3ZlIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoKVBJWEkuV2ViR0xSZW5kZXJlci5yZXR1cm5CYXRjaChiYXRjaFRvUmVtb3ZlKTsKCQkKCQkJcmV0dXJuOwoJCX0KCQkKCQlpZih0aGlzLmJhdGNoc1tpbmRleC0xXSBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaCAmJiB0aGlzLmJhdGNoc1tpbmRleCsxXSBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaCkKCQl7CgkJCWlmKHRoaXMuYmF0Y2hzW2luZGV4LTFdLnRleHR1cmUgPT0gdGhpcy5iYXRjaHNbaW5kZXgrMV0udGV4dHVyZSAmJiB0aGlzLmJhdGNoc1tpbmRleC0xXS5ibGVuZE1vZGUgPT0gdGhpcy5iYXRjaHNbaW5kZXgrMV0uYmxlbmRNb2RlKQoJCQl7CgkJCQkvL2NvbnNvbGUubG9nKCJNRVJHRSIpCgkJCQl0aGlzLmJhdGNoc1tpbmRleC0xXS5tZXJnZSh0aGlzLmJhdGNoc1tpbmRleCsxXSk7CgkJCQkKCQkJCWlmKGJhdGNoVG9SZW1vdmUgaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2gpUElYSS5XZWJHTFJlbmRlcmVyLnJldHVybkJhdGNoKGJhdGNoVG9SZW1vdmUpOwoJCQkJUElYSS5XZWJHTFJlbmRlcmVyLnJldHVybkJhdGNoKHRoaXMuYmF0Y2hzW2luZGV4KzFdKTsKCQkJCXRoaXMuYmF0Y2hzLnNwbGljZShpbmRleCwgMik7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJCgkJdGhpcy5iYXRjaHMuc3BsaWNlKGluZGV4LCAxKTsKCQlpZihiYXRjaFRvUmVtb3ZlIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoKVBJWEkuV2ViR0xSZW5kZXJlci5yZXR1cm5CYXRjaChiYXRjaFRvUmVtb3ZlKTsKCX0KfQoKCi8qKgogKiBJbml0aWFsaXplcyBhIHRpbGluZyBzcHJpdGUKICoKICogQG1ldGhvZCBpbml0VGlsaW5nU3ByaXRlCiAqIEBwYXJhbSBzcHJpdGUge1RpbGluZ1Nwcml0ZX0gVGhlIHRpbGluZyBzcHJpdGUgdG8gaW5pdGlhbGl6ZQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5pbml0VGlsaW5nU3ByaXRlID0gZnVuY3Rpb24oc3ByaXRlKQp7Cgl2YXIgZ2wgPSB0aGlzLmdsOwoKCS8vIG1ha2UgdGhlIHRleHR1cmUgdGlsYWJsZS4uCgkJCQoJc3ByaXRlLnZlcnRpY2llcyA9IG5ldyBGbG9hdDMyQXJyYXkoWzAsIDAsCgkJCQkJCQkJCQkgIHNwcml0ZS53aWR0aCwgMCwKCQkJCQkJCQkJCSAgc3ByaXRlLndpZHRoLCAgc3ByaXRlLmhlaWdodCwKCQkJCQkJCQkJCSAwLCAgc3ByaXRlLmhlaWdodF0pOwoJCQkJCQoJc3ByaXRlLnV2cyA9IG5ldyBGbG9hdDMyQXJyYXkoWzAsIDAsCgkJCQkJCQkJCTEsIDAsCgkJCQkJCQkJCTEsIDEsCgkJCQkJCQkJCTAsIDFdKTsKCQkJCQoJc3ByaXRlLmNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkoWzEsMSwxLDFdKTsKCQoJc3ByaXRlLmluZGljZXMgPSAgbmV3IFVpbnQxNkFycmF5KFswLCAxLCAzLDJdKS8vLCAyXSk7CgkKCXNwcml0ZS5fdmVydGV4QnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CglzcHJpdGUuX2luZGV4QnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CglzcHJpdGUuX3V2QnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CglzcHJpdGUuX2NvbG9yQnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CgkJCQkJCQoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHNwcml0ZS5fdmVydGV4QnVmZmVyKTsKCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBzcHJpdGUudmVydGljaWVzLCBnbC5TVEFUSUNfRFJBVyk7CgoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHNwcml0ZS5fdXZCdWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsICBzcHJpdGUudXZzLCBnbC5EWU5BTUlDX0RSQVcpOwoKICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzcHJpdGUuX2NvbG9yQnVmZmVyKTsKCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBzcHJpdGUuY29sb3JzLCBnbC5TVEFUSUNfRFJBVyk7CgogICAgZ2wuYmluZEJ1ZmZlcihnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgc3ByaXRlLl9pbmRleEJ1ZmZlcik7CiAgICBnbC5idWZmZXJEYXRhKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBzcHJpdGUuaW5kaWNlcywgZ2wuU1RBVElDX0RSQVcpOwogICAgCi8vICAgIHJldHVybiAoICh4ID4gMCkgJiYgKCh4ICYgKHggLSAxKSkgPT0gMCkgKTsKCglpZihzcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlKQoJewogICAgCWdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHNwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpOwogICAgCWdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1MsIGdsLlJFUEVBVCk7CgkJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuUkVQRUFUKTsKCQlzcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS5fcG93ZXJPZjIgPSB0cnVlOwoJfQoJZWxzZQoJewoJCXNwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLl9wb3dlck9mMiA9IHRydWU7Cgl9Cn0KCi8qKgogKiBSZW5kZXJzIGEgU3RyaXAKICoKICogQG1ldGhvZCByZW5kZXJTdHJpcAogKiBAcGFyYW0gc3RyaXAge1N0cmlwfSBUaGUgc3RyaXAgdG8gcmVuZGVyCiAqIEBwYXJhbSBwcm9qZWN0aW9uIHtPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnJlbmRlclN0cmlwID0gZnVuY3Rpb24oc3RyaXAsIHByb2plY3Rpb24pCnsKCXZhciBnbCA9IHRoaXMuZ2w7CgoJUElYSS5hY3RpdmF0ZVN0cmlwU2hhZGVyKCk7CgoJdmFyIHNoYWRlciA9IFBJWEkuc3RyaXBTaGFkZXI7CgoJdmFyIHByb2dyYW0gPSBzaGFkZXIucHJvZ3JhbTsKCQoJdmFyIG0gPSBQSVhJLm1hdDMuY2xvbmUoc3RyaXAud29ybGRUcmFuc2Zvcm0pOwoJCglQSVhJLm1hdDMudHJhbnNwb3NlKG0pOwoJCi8vCWNvbnNvbGUubG9nKHByb2plY3Rpb24pCgkvLyBzZXQgdGhlIG1hdHJpeCB0cmFuc2Zvcm0gZm9yIHRoZSAKIAlnbC51bmlmb3JtTWF0cml4M2Z2KHNoYWRlci50cmFuc2xhdGlvbk1hdHJpeCwgZmFsc2UsIG0pOwoJZ2wudW5pZm9ybTJmKHNoYWRlci5wcm9qZWN0aW9uVmVjdG9yLCBwcm9qZWN0aW9uLngsIHByb2plY3Rpb24ueSk7CglnbC51bmlmb3JtMmYoc2hhZGVyLm9mZnNldFZlY3RvciwgLVBJWEkub2Zmc2V0LngsIC1QSVhJLm9mZnNldC55KTsKCQoJZ2wudW5pZm9ybTFmKHNoYWRlci5hbHBoYSwgc3RyaXAud29ybGRBbHBoYSk7CgoJLyoKCWlmKHN0cmlwLmJsZW5kTW9kZSA9PSBQSVhJLmJsZW5kTW9kZXMuTk9STUFMKQoJewoJCWdsLmJsZW5kRnVuYyhnbC5PTkUsIGdsLk9ORV9NSU5VU19TUkNfQUxQSEEpOwoJfQoJZWxzZQoJewoJCWdsLmJsZW5kRnVuYyhnbC5PTkUsIGdsLk9ORV9NSU5VU19TUkNfQ09MT1IpOwoJfQoJKi8KCQoJLy9jb25zb2xlLmxvZygiISEiKQoJaWYoIXN0cmlwLmRpcnR5KQoJewkKCQlnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAuX3ZlcnRleEJ1ZmZlcik7CgkJZ2wuYnVmZmVyU3ViRGF0YShnbC5BUlJBWV9CVUZGRVIsIDAsIHN0cmlwLnZlcnRpY2llcykKCSAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlci5hVmVydGV4UG9zaXRpb24sIDIsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgkJCgkJLy8gdXBkYXRlIHRoZSB1dnMKCSAgIAlnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAuX3V2QnVmZmVyKTsKCSAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlci5hVGV4dHVyZUNvb3JkLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwoJCQkKCSAgICBnbC5hY3RpdmVUZXh0dXJlKGdsLlRFWFRVUkUwKTsKCSAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCBzdHJpcC50ZXh0dXJlLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpOwoJCQoJCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fY29sb3JCdWZmZXIpOwoJICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmNvbG9yQXR0cmlidXRlLCAxLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwoJCQoJCS8vIGRvbnQgbmVlZCB0byB1cGxvYWQhCgkgICAgZ2wuYmluZEJ1ZmZlcihnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgc3RyaXAuX2luZGV4QnVmZmVyKTsKCX0KCWVsc2UKCXsKCQlzdHJpcC5kaXJ0eSA9IGZhbHNlOwoJCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fdmVydGV4QnVmZmVyKTsKCQlnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAudmVydGljaWVzLCBnbC5TVEFUSUNfRFJBVykKCSAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlci5hVmVydGV4UG9zaXRpb24sIDIsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgkJCgkJLy8gdXBkYXRlIHRoZSB1dnMKCSAgIAlnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAuX3V2QnVmZmVyKTsKCSAgIAlnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAudXZzLCBnbC5TVEFUSUNfRFJBVykKCSAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlci5hVGV4dHVyZUNvb3JkLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwoJCQkKCSAgICBnbC5hY3RpdmVUZXh0dXJlKGdsLlRFWFRVUkUwKTsKCSAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCBzdHJpcC50ZXh0dXJlLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpOwoJLy8JY29uc29sZS5sb2coc3RyaXAudGV4dHVyZS5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlKQoJCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fY29sb3JCdWZmZXIpOwoJCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5jb2xvcnMsIGdsLlNUQVRJQ19EUkFXKQoJICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmNvbG9yQXR0cmlidXRlLCAxLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwoJCQoJCS8vIGRvbnQgbmVlZCB0byB1cGxvYWQhCgkgICAgZ2wuYmluZEJ1ZmZlcihnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgc3RyaXAuX2luZGV4QnVmZmVyKTsKCSAgICBnbC5idWZmZXJEYXRhKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBzdHJpcC5pbmRpY2VzLCBnbC5TVEFUSUNfRFJBVyk7CgkgICAgCgl9CgkKCWdsLmRyYXdFbGVtZW50cyhnbC5UUklBTkdMRV9TVFJJUCwgc3RyaXAuaW5kaWNlcy5sZW5ndGgsIGdsLlVOU0lHTkVEX1NIT1JULCAwKTsKICAgIAogICAgUElYSS5kZWFjdGl2YXRlU3RyaXBTaGFkZXIoKTsKICAJLy9nbC51c2VQcm9ncmFtKFBJWEkuY3VycmVudFByb2dyYW0pOwp9CgovKioKICogUmVuZGVycyBhIFRpbGluZ1Nwcml0ZQogKgogKiBAbWV0aG9kIHJlbmRlclRpbGluZ1Nwcml0ZQogKiBAcGFyYW0gc3ByaXRlIHtUaWxpbmdTcHJpdGV9IFRoZSB0aWxpbmcgc3ByaXRlIHRvIHJlbmRlcgogKiBAcGFyYW0gcHJvamVjdGlvbk1hdHJpeCB7T2JqZWN0fQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5yZW5kZXJUaWxpbmdTcHJpdGUgPSBmdW5jdGlvbihzcHJpdGUsIHByb2plY3Rpb25NYXRyaXgpCnsKCXZhciBnbCA9IHRoaXMuZ2w7CgoKCXZhciBzaGFkZXJQcm9ncmFtID0gUElYSS5zaGFkZXJQcm9ncmFtOwoJCgl2YXIgdGlsZVBvc2l0aW9uID0gc3ByaXRlLnRpbGVQb3NpdGlvbjsKCXZhciB0aWxlU2NhbGUgPSBzcHJpdGUudGlsZVNjYWxlOwoJCgl2YXIgb2Zmc2V0WCA9ICB0aWxlUG9zaXRpb24ueC9zcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS53aWR0aDsKCXZhciBvZmZzZXRZID0gIHRpbGVQb3NpdGlvbi55L3Nwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLmhlaWdodDsKCQoJdmFyIHNjYWxlWCA9ICAoc3ByaXRlLndpZHRoIC8gc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUud2lkdGgpICAvIHRpbGVTY2FsZS54OwoJdmFyIHNjYWxlWSA9ICAoc3ByaXRlLmhlaWdodCAvIHNwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLmhlaWdodCkgLyB0aWxlU2NhbGUueTsKCglzcHJpdGUudXZzWzBdID0gMCAtIG9mZnNldFg7CglzcHJpdGUudXZzWzFdID0gMCAtIG9mZnNldFk7CgkKCXNwcml0ZS51dnNbMl0gPSAoMSAqIHNjYWxlWCkgIC1vZmZzZXRYOwoJc3ByaXRlLnV2c1szXSA9IDAgLSBvZmZzZXRZOwoJCglzcHJpdGUudXZzWzRdID0gKDEgKnNjYWxlWCkgLSBvZmZzZXRYOwoJc3ByaXRlLnV2c1s1XSA9ICgxICpzY2FsZVkpIC0gb2Zmc2V0WTsKCQoJc3ByaXRlLnV2c1s2XSA9IDAgLSBvZmZzZXRYOwoJc3ByaXRlLnV2c1s3XSA9ICgxICpzY2FsZVkpIC0gb2Zmc2V0WTsKCQoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHNwcml0ZS5fdXZCdWZmZXIpOwoJZ2wuYnVmZmVyU3ViRGF0YShnbC5BUlJBWV9CVUZGRVIsIDAsIHNwcml0ZS51dnMpCgkKCXRoaXMucmVuZGVyU3RyaXAoc3ByaXRlLCBwcm9qZWN0aW9uTWF0cml4KTsKfQoKLyoqCiAqIEluaXRpYWxpemVzIGEgc3RyaXAgdG8gYmUgcmVuZGVyZWQKICoKICogQG1ldGhvZCBpbml0U3RyaXAKICogQHBhcmFtIHN0cmlwIHtTdHJpcH0gVGhlIHN0cmlwIHRvIGluaXRpYWxpemUKICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUuaW5pdFN0cmlwID0gZnVuY3Rpb24oc3RyaXApCnsKCS8vIGJ1aWxkIHRoZSBzdHJpcCEKCXZhciBnbCA9IHRoaXMuZ2w7Cgl2YXIgc2hhZGVyUHJvZ3JhbSA9IHRoaXMuc2hhZGVyUHJvZ3JhbTsKCQoJc3RyaXAuX3ZlcnRleEJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwoJc3RyaXAuX2luZGV4QnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CglzdHJpcC5fdXZCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCXN0cmlwLl9jb2xvckJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwoJCglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAuX3ZlcnRleEJ1ZmZlcik7CglnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAudmVydGljaWVzLCBnbC5EWU5BTUlDX0RSQVcpOwoKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fdXZCdWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsICBzdHJpcC51dnMsIGdsLlNUQVRJQ19EUkFXKTsKCiAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAuX2NvbG9yQnVmZmVyKTsKCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5jb2xvcnMsIGdsLlNUQVRJQ19EUkFXKTsKCgkKICAgIGdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHN0cmlwLl9pbmRleEJ1ZmZlcik7CiAgICBnbC5idWZmZXJEYXRhKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBzdHJpcC5pbmRpY2VzLCBnbC5TVEFUSUNfRFJBVyk7Cn0KCgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKUElYSS5pbml0RGVmYXVsdFNoYWRlcnMgPSBmdW5jdGlvbigpCnsKICAgIFBJWEkucHJpbWl0aXZlU2hhZGVyID0gbmV3IFBJWEkuUHJpbWl0aXZlU2hhZGVyKCk7CiAgICBQSVhJLnByaW1pdGl2ZVNoYWRlci5pbml0KCk7CgogICAgUElYSS5zdHJpcFNoYWRlciA9IG5ldyBQSVhJLlN0cmlwU2hhZGVyKCk7CiAgICBQSVhJLnN0cmlwU2hhZGVyLmluaXQoKTsKCiAgICBQSVhJLmRlZmF1bHRTaGFkZXIgPSBuZXcgUElYSS5QaXhpU2hhZGVyKCk7CiAgICBQSVhJLmRlZmF1bHRTaGFkZXIuaW5pdCgpOwoKICAgIHZhciBnbCA9IFBJWEkuZ2w7CiAgICB2YXIgc2hhZGVyUHJvZ3JhbSA9IFBJWEkuZGVmYXVsdFNoYWRlci5wcm9ncmFtOwoKICAgIGdsLnVzZVByb2dyYW0oc2hhZGVyUHJvZ3JhbSk7CgogICAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbik7CiAgICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuY29sb3JBdHRyaWJ1dGUpOwogICAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmFUZXh0dXJlQ29vcmQpOwp9OwoKUElYSS5hY3RpdmF0ZVByaW1pdGl2ZVNoYWRlciA9IGZ1bmN0aW9uKCkKewogICAgdmFyIGdsID0gUElYSS5nbDsKCiAgICBnbC51c2VQcm9ncmFtKFBJWEkucHJpbWl0aXZlU2hhZGVyLnByb2dyYW0pOwoKICAgIGdsLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuYVZlcnRleFBvc2l0aW9uKTsKICAgIGdsLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuY29sb3JBdHRyaWJ1dGUpOwogICAgZ2wuZGlzYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5hVGV4dHVyZUNvb3JkKTsKCiAgICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLnByaW1pdGl2ZVNoYWRlci5hVmVydGV4UG9zaXRpb24pOwogICAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5wcmltaXRpdmVTaGFkZXIuY29sb3JBdHRyaWJ1dGUpOwp9OwoKUElYSS5kZWFjdGl2YXRlUHJpbWl0aXZlU2hhZGVyID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIGdsLnVzZVByb2dyYW0oUElYSS5kZWZhdWx0U2hhZGVyLnByb2dyYW0pOwoKICAgIGdsLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLnByaW1pdGl2ZVNoYWRlci5hVmVydGV4UG9zaXRpb24pOwogICAgZ2wuZGlzYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkucHJpbWl0aXZlU2hhZGVyLmNvbG9yQXR0cmlidXRlKTsKCiAgICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuYVZlcnRleFBvc2l0aW9uKTsKICAgIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5jb2xvckF0dHJpYnV0ZSk7CiAgICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuYVRleHR1cmVDb29yZCk7Cn07CgpQSVhJLmFjdGl2YXRlU3RyaXBTaGFkZXIgPSBmdW5jdGlvbigpCnsKICAgIHZhciBnbCA9IFBJWEkuZ2w7CgogICAgZ2wudXNlUHJvZ3JhbShQSVhJLnN0cmlwU2hhZGVyLnByb2dyYW0pOwogLy8gZ2wuZGlzYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5hVGV4dHVyZUNvb3JkKTsKfTsKClBJWEkuZGVhY3RpdmF0ZVN0cmlwU2hhZGVyID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIGdsLnVzZVByb2dyYW0oUElYSS5kZWZhdWx0U2hhZGVyLnByb2dyYW0pOwogICAgLy9nbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuYVRleHR1cmVDb29yZCk7Cn07CgovKgoKU0hBREVSIENPTVBJTEVSIEhFTFBFUlMKKi8KClBJWEkuQ29tcGlsZVZlcnRleFNoYWRlciA9IGZ1bmN0aW9uKGdsLCBzaGFkZXJTcmMpCnsKICAgIHJldHVybiBQSVhJLl9Db21waWxlU2hhZGVyKGdsLCBzaGFkZXJTcmMsIGdsLlZFUlRFWF9TSEFERVIpOwp9OwoKUElYSS5Db21waWxlRnJhZ21lbnRTaGFkZXIgPSBmdW5jdGlvbihnbCwgc2hhZGVyU3JjKQp7CiAgICByZXR1cm4gUElYSS5fQ29tcGlsZVNoYWRlcihnbCwgc2hhZGVyU3JjLCBnbC5GUkFHTUVOVF9TSEFERVIpOwp9OwoKUElYSS5fQ29tcGlsZVNoYWRlciA9IGZ1bmN0aW9uKGdsLCBzaGFkZXJTcmMsIHNoYWRlclR5cGUpCnsKICAgIHZhciBzcmMgPSBzaGFkZXJTcmMuam9pbigiXG4iKTsKICAgIHZhciBzaGFkZXIgPSBnbC5jcmVhdGVTaGFkZXIoc2hhZGVyVHlwZSk7CiAgICBnbC5zaGFkZXJTb3VyY2Uoc2hhZGVyLCBzcmMpOwogICAgZ2wuY29tcGlsZVNoYWRlcihzaGFkZXIpOwoKICAgIGlmICghZ2wuZ2V0U2hhZGVyUGFyYW1ldGVyKHNoYWRlciwgZ2wuQ09NUElMRV9TVEFUVVMpKSB7CiAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKGdsLmdldFNoYWRlckluZm9Mb2coc2hhZGVyKSk7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgcmV0dXJuIHNoYWRlcjsKfTsKClBJWEkuY29tcGlsZVByb2dyYW0gPSBmdW5jdGlvbih2ZXJ0ZXhTcmMsIGZyYWdtZW50U3JjKQp7CiAgICB2YXIgZ2wgPSBQSVhJLmdsOwogICAgdmFyIGZyYWdtZW50U2hhZGVyID0gUElYSS5Db21waWxlRnJhZ21lbnRTaGFkZXIoZ2wsIGZyYWdtZW50U3JjKTsKICAgIHZhciB2ZXJ0ZXhTaGFkZXIgPSBQSVhJLkNvbXBpbGVWZXJ0ZXhTaGFkZXIoZ2wsIHZlcnRleFNyYyk7CgogICAgdmFyIHNoYWRlclByb2dyYW0gPSBnbC5jcmVhdGVQcm9ncmFtKCk7CgogICAgZ2wuYXR0YWNoU2hhZGVyKHNoYWRlclByb2dyYW0sIHZlcnRleFNoYWRlcik7CiAgICBnbC5hdHRhY2hTaGFkZXIoc2hhZGVyUHJvZ3JhbSwgZnJhZ21lbnRTaGFkZXIpOwogICAgZ2wubGlua1Byb2dyYW0oc2hhZGVyUHJvZ3JhbSk7CgogICAgaWYgKCFnbC5nZXRQcm9ncmFtUGFyYW1ldGVyKHNoYWRlclByb2dyYW0sIGdsLkxJTktfU1RBVFVTKSkgewogICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygiQ291bGQgbm90IGluaXRpYWxpc2Ugc2hhZGVycyIpOwogICAgfQoKICAgIHJldHVybiBzaGFkZXJQcm9ncmFtOwp9OwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiBBIFRleHQgT2JqZWN0IHdpbGwgY3JlYXRlIGEgbGluZShzKSBvZiB0ZXh0IHVzaW5nIGJpdG1hcCBmb250LiBUbyBzcGxpdCBhIGxpbmUgeW91IGNhbiB1c2UgJ1xuJywgJ1xyJyBvciAnXHJcbicKICogWW91IGNhbiBnZW5lcmF0ZSB0aGUgZm50IGZpbGVzIHVzaW5nCiAqIGh0dHA6Ly93d3cuYW5nZWxjb2RlLmNvbS9wcm9kdWN0cy9ibWZvbnQvIGZvciB3aW5kb3dzIG9yCiAqIGh0dHA6Ly93d3cuYm1nbHlwaC5jb20vIGZvciBtYWMuCiAqCiAqIEBjbGFzcyBCaXRtYXBUZXh0CiAqIEBleHRlbmRzIERpc3BsYXlPYmplY3RDb250YWluZXIKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB0ZXh0IHtTdHJpbmd9IFRoZSBjb3B5IHRoYXQgeW91IHdvdWxkIGxpa2UgdGhlIHRleHQgdG8gZGlzcGxheQogKiBAcGFyYW0gc3R5bGUge09iamVjdH0gVGhlIHN0eWxlIHBhcmFtZXRlcnMKICogQHBhcmFtIHN0eWxlLmZvbnQge1N0cmluZ30gVGhlIHNpemUgKG9wdGlvbmFsKSBhbmQgYml0bWFwIGZvbnQgaWQgKHJlcXVpcmVkKSBlcSAnQXJpYWwnIG9yICcyMHB4IEFyaWFsJyAobXVzdCBoYXZlIGxvYWRlZCBwcmV2aW91c2x5KQogKiBAcGFyYW0gW3N0eWxlLmFsaWduPSdsZWZ0J10ge1N0cmluZ30gQW4gYWxpZ25tZW50IG9mIHRoZSBtdWx0aWxpbmUgdGV4dCAoJ2xlZnQnLCAnY2VudGVyJyBvciAncmlnaHQnKQogKi8KUElYSS5CaXRtYXBUZXh0ID0gZnVuY3Rpb24odGV4dCwgc3R5bGUpCnsKICAgIFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5jYWxsKHRoaXMpOwoKICAgIHRoaXMuc2V0VGV4dCh0ZXh0KTsKICAgIHRoaXMuc2V0U3R5bGUoc3R5bGUpOwogICAgdGhpcy51cGRhdGVUZXh0KCk7CiAgICB0aGlzLmRpcnR5ID0gZmFsc2U7Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLkJpdG1hcFRleHQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlKTsKUElYSS5CaXRtYXBUZXh0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuQml0bWFwVGV4dDsKCi8qKgogKiBTZXQgdGhlIGNvcHkgZm9yIHRoZSB0ZXh0IG9iamVjdAogKgogKiBAbWV0aG9kIHNldFRleHQKICogQHBhcmFtIHRleHQge1N0cmluZ30gVGhlIGNvcHkgdGhhdCB5b3Ugd291bGQgbGlrZSB0aGUgdGV4dCB0byBkaXNwbGF5CiAqLwpQSVhJLkJpdG1hcFRleHQucHJvdG90eXBlLnNldFRleHQgPSBmdW5jdGlvbih0ZXh0KQp7CiAgICB0aGlzLnRleHQgPSB0ZXh0IHx8ICcgJzsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwp9OwoKLyoqCiAqIFNldCB0aGUgc3R5bGUgb2YgdGhlIHRleHQKICoKICogQG1ldGhvZCBzZXRTdHlsZQogKiBAcGFyYW0gc3R5bGUge09iamVjdH0gVGhlIHN0eWxlIHBhcmFtZXRlcnMKICogQHBhcmFtIHN0eWxlLmZvbnQge1N0cmluZ30gVGhlIHNpemUgKG9wdGlvbmFsKSBhbmQgYml0bWFwIGZvbnQgaWQgKHJlcXVpcmVkKSBlcSAnQXJpYWwnIG9yICcyMHB4IEFyaWFsJyAobXVzdCBoYXZlIGxvYWRlZCBwcmV2aW91c2x5KQogKiBAcGFyYW0gW3N0eWxlLmFsaWduPSdsZWZ0J10ge1N0cmluZ30gQW4gYWxpZ25tZW50IG9mIHRoZSBtdWx0aWxpbmUgdGV4dCAoJ2xlZnQnLCAnY2VudGVyJyBvciAncmlnaHQnKQogKi8KUElYSS5CaXRtYXBUZXh0LnByb3RvdHlwZS5zZXRTdHlsZSA9IGZ1bmN0aW9uKHN0eWxlKQp7CiAgICBzdHlsZSA9IHN0eWxlIHx8IHt9OwogICAgc3R5bGUuYWxpZ24gPSBzdHlsZS5hbGlnbiB8fCAnbGVmdCc7CiAgICB0aGlzLnN0eWxlID0gc3R5bGU7CgogICAgdmFyIGZvbnQgPSBzdHlsZS5mb250LnNwbGl0KCcgJyk7CiAgICB0aGlzLmZvbnROYW1lID0gZm9udFtmb250Lmxlbmd0aCAtIDFdOwogICAgdGhpcy5mb250U2l6ZSA9IGZvbnQubGVuZ3RoID49IDIgPyBwYXJzZUludChmb250W2ZvbnQubGVuZ3RoIC0gMl0sIDEwKSA6IFBJWEkuQml0bWFwVGV4dC5mb250c1t0aGlzLmZvbnROYW1lXS5zaXplOwoKICAgIHRoaXMuZGlydHkgPSB0cnVlOwp9OwoKLyoqCiAqIFJlbmRlcnMgdGV4dAogKgogKiBAbWV0aG9kIHVwZGF0ZVRleHQKICogQHByaXZhdGUKICovClBJWEkuQml0bWFwVGV4dC5wcm90b3R5cGUudXBkYXRlVGV4dCA9IGZ1bmN0aW9uKCkKewogICAgdmFyIGRhdGEgPSBQSVhJLkJpdG1hcFRleHQuZm9udHNbdGhpcy5mb250TmFtZV07CiAgICB2YXIgcG9zID0gbmV3IFBJWEkuUG9pbnQoKTsKICAgIHZhciBwcmV2Q2hhckNvZGUgPSBudWxsOwogICAgdmFyIGNoYXJzID0gW107CiAgICB2YXIgbWF4TGluZVdpZHRoID0gMDsKICAgIHZhciBsaW5lV2lkdGhzID0gW107CiAgICB2YXIgbGluZSA9IDA7CiAgICB2YXIgc2NhbGUgPSB0aGlzLmZvbnRTaXplIC8gZGF0YS5zaXplOwogICAgZm9yKHZhciBpID0gMDsgaSA8IHRoaXMudGV4dC5sZW5ndGg7IGkrKykKICAgIHsKICAgICAgICB2YXIgY2hhckNvZGUgPSB0aGlzLnRleHQuY2hhckNvZGVBdChpKTsKICAgICAgICBpZigvKD86XHJcbnxccnxcbikvLnRlc3QodGhpcy50ZXh0LmNoYXJBdChpKSkpCiAgICAgICAgewogICAgICAgICAgICBsaW5lV2lkdGhzLnB1c2gocG9zLngpOwogICAgICAgICAgICBtYXhMaW5lV2lkdGggPSBNYXRoLm1heChtYXhMaW5lV2lkdGgsIHBvcy54KTsKICAgICAgICAgICAgbGluZSsrOwoKICAgICAgICAgICAgcG9zLnggPSAwOwogICAgICAgICAgICBwb3MueSArPSBkYXRhLmxpbmVIZWlnaHQ7CiAgICAgICAgICAgIHByZXZDaGFyQ29kZSA9IG51bGw7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgdmFyIGNoYXJEYXRhID0gZGF0YS5jaGFyc1tjaGFyQ29kZV07CiAgICAgICAgaWYoIWNoYXJEYXRhKSBjb250aW51ZTsKCiAgICAgICAgaWYocHJldkNoYXJDb2RlICYmIGNoYXJEYXRhW3ByZXZDaGFyQ29kZV0pCiAgICAgICAgewogICAgICAgICAgICBwb3MueCArPSBjaGFyRGF0YS5rZXJuaW5nW3ByZXZDaGFyQ29kZV07CiAgICAgICAgfQogICAgICAgIGNoYXJzLnB1c2goe3RleHR1cmU6Y2hhckRhdGEudGV4dHVyZSwgbGluZTogbGluZSwgY2hhckNvZGU6IGNoYXJDb2RlLCBwb3NpdGlvbjogbmV3IFBJWEkuUG9pbnQocG9zLnggKyBjaGFyRGF0YS54T2Zmc2V0LCBwb3MueSArIGNoYXJEYXRhLnlPZmZzZXQpfSk7CiAgICAgICAgcG9zLnggKz0gY2hhckRhdGEueEFkdmFuY2U7CgogICAgICAgIHByZXZDaGFyQ29kZSA9IGNoYXJDb2RlOwogICAgfQoKICAgIGxpbmVXaWR0aHMucHVzaChwb3MueCk7CiAgICBtYXhMaW5lV2lkdGggPSBNYXRoLm1heChtYXhMaW5lV2lkdGgsIHBvcy54KTsKCiAgICB2YXIgbGluZUFsaWduT2Zmc2V0cyA9IFtdOwogICAgZm9yKGkgPSAwOyBpIDw9IGxpbmU7IGkrKykKICAgIHsKICAgICAgICB2YXIgYWxpZ25PZmZzZXQgPSAwOwogICAgICAgIGlmKHRoaXMuc3R5bGUuYWxpZ24gPT09ICdyaWdodCcpCiAgICAgICAgewogICAgICAgICAgICBhbGlnbk9mZnNldCA9IG1heExpbmVXaWR0aCAtIGxpbmVXaWR0aHNbaV07CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYodGhpcy5zdHlsZS5hbGlnbiA9PT0gJ2NlbnRlcicpCiAgICAgICAgewogICAgICAgICAgICBhbGlnbk9mZnNldCA9IChtYXhMaW5lV2lkdGggLSBsaW5lV2lkdGhzW2ldKSAvIDI7CiAgICAgICAgfQogICAgICAgIGxpbmVBbGlnbk9mZnNldHMucHVzaChhbGlnbk9mZnNldCk7CiAgICB9CgogICAgZm9yKGkgPSAwOyBpIDwgY2hhcnMubGVuZ3RoOyBpKyspCiAgICB7CiAgICAgICAgdmFyIGMgPSBuZXcgUElYSS5TcHJpdGUoY2hhcnNbaV0udGV4dHVyZSk7IC8vUElYSS5TcHJpdGUuZnJvbUZyYW1lKGNoYXJzW2ldLmNoYXJDb2RlKTsKICAgICAgICBjLnBvc2l0aW9uLnggPSAoY2hhcnNbaV0ucG9zaXRpb24ueCArIGxpbmVBbGlnbk9mZnNldHNbY2hhcnNbaV0ubGluZV0pICogc2NhbGU7CiAgICAgICAgYy5wb3NpdGlvbi55ID0gY2hhcnNbaV0ucG9zaXRpb24ueSAqIHNjYWxlOwogICAgICAgIGMuc2NhbGUueCA9IGMuc2NhbGUueSA9IHNjYWxlOwogICAgICAgIHRoaXMuYWRkQ2hpbGQoYyk7CiAgICB9CgogICAgdGhpcy53aWR0aCA9IG1heExpbmVXaWR0aCAqIHNjYWxlOwogICAgdGhpcy5oZWlnaHQgPSAocG9zLnkgKyBkYXRhLmxpbmVIZWlnaHQpICogc2NhbGU7Cn07CgovKioKICogVXBkYXRlcyB0aGUgdHJhbnNmb3Igb2YgdGhpcyBvYmplY3QKICoKICogQG1ldGhvZCB1cGRhdGVUcmFuc2Zvcm0KICogQHByaXZhdGUKICovClBJWEkuQml0bWFwVGV4dC5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtID0gZnVuY3Rpb24oKQp7CiAgICBpZih0aGlzLmRpcnR5KQogICAgewogICAgICAgIHdoaWxlKHRoaXMuY2hpbGRyZW4ubGVuZ3RoID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlQ2hpbGQodGhpcy5nZXRDaGlsZEF0KDApKTsKICAgICAgICB9CiAgICAgICAgdGhpcy51cGRhdGVUZXh0KCk7CgogICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgIH0KCiAgICBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybS5jYWxsKHRoaXMpOwp9OwoKUElYSS5CaXRtYXBUZXh0LmZvbnRzID0ge307CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIEEgVGV4dCBPYmplY3Qgd2lsbCBjcmVhdGUgYSBsaW5lKHMpIG9mIHRleHQgdG8gc3BsaXQgYSBsaW5lIHlvdSBjYW4gdXNlICdcbicKICoKICogQGNsYXNzIFRleHQKICogQGV4dGVuZHMgU3ByaXRlCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gdGV4dCB7U3RyaW5nfSBUaGUgY29weSB0aGF0IHlvdSB3b3VsZCBsaWtlIHRoZSB0ZXh0IHRvIGRpc3BsYXkKICogQHBhcmFtIFtzdHlsZV0ge09iamVjdH0gVGhlIHN0eWxlIHBhcmFtZXRlcnMKICogQHBhcmFtIFtzdHlsZS5mb250XSB7U3RyaW5nfSBkZWZhdWx0ICdib2xkIDIwcHQgQXJpYWwnIFRoZSBzdHlsZSBhbmQgc2l6ZSBvZiB0aGUgZm9udAogKiBAcGFyYW0gW3N0eWxlLmZpbGw9J2JsYWNrJ10ge09iamVjdH0gQSBjYW52YXMgZmlsbHN0eWxlIHRoYXQgd2lsbCBiZSB1c2VkIG9uIHRoZSB0ZXh0IGVnICdyZWQnLCAnIzAwRkYwMCcKICogQHBhcmFtIFtzdHlsZS5hbGlnbj0nbGVmdCddIHtTdHJpbmd9IEFuIGFsaWdubWVudCBvZiB0aGUgbXVsdGlsaW5lIHRleHQgKCdsZWZ0JywgJ2NlbnRlcicgb3IgJ3JpZ2h0JykKICogQHBhcmFtIFtzdHlsZS5zdHJva2VdIHtTdHJpbmd9IEEgY2FudmFzIGZpbGxzdHlsZSB0aGF0IHdpbGwgYmUgdXNlZCBvbiB0aGUgdGV4dCBzdHJva2UgZWcgJ2JsdWUnLCAnI0ZDRkYwMCcKICogQHBhcmFtIFtzdHlsZS5zdHJva2VUaGlja25lc3M9MF0ge051bWJlcn0gQSBudW1iZXIgdGhhdCByZXByZXNlbnRzIHRoZSB0aGlja25lc3Mgb2YgdGhlIHN0cm9rZS4gRGVmYXVsdCBpcyAwIChubyBzdHJva2UpCiAqIEBwYXJhbSBbc3R5bGUud29yZFdyYXA9ZmFsc2VdIHtCb29sZWFufSBJbmRpY2F0ZXMgaWYgd29yZCB3cmFwIHNob3VsZCBiZSB1c2VkCiAqIEBwYXJhbSBbc3R5bGUud29yZFdyYXBXaWR0aD0xMDBdIHtOdW1iZXJ9IFRoZSB3aWR0aCBhdCB3aGljaCB0ZXh0IHdpbGwgd3JhcAogKi8KUElYSS5UZXh0ID0gZnVuY3Rpb24odGV4dCwgc3R5bGUpCnsKICAgIHRoaXMuY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICB0aGlzLmNvbnRleHQgPSB0aGlzLmNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwogICAgUElYSS5TcHJpdGUuY2FsbCh0aGlzLCBQSVhJLlRleHR1cmUuZnJvbUNhbnZhcyh0aGlzLmNhbnZhcykpOwoKICAgIHRoaXMuc2V0VGV4dCh0ZXh0KTsKICAgIHRoaXMuc2V0U3R5bGUoc3R5bGUpOwoKICAgIHRoaXMudXBkYXRlVGV4dCgpOwogICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwp9OwoKLy8gY29uc3RydWN0b3IKUElYSS5UZXh0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5TcHJpdGUucHJvdG90eXBlKTsKUElYSS5UZXh0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuVGV4dDsKCi8qKgogKiBTZXQgdGhlIHN0eWxlIG9mIHRoZSB0ZXh0CiAqCiAqIEBtZXRob2Qgc2V0U3R5bGUKICogQHBhcmFtIFtzdHlsZV0ge09iamVjdH0gVGhlIHN0eWxlIHBhcmFtZXRlcnMKICogQHBhcmFtIFtzdHlsZS5mb250PSdib2xkIDIwcHQgQXJpYWwnXSB7U3RyaW5nfSBUaGUgc3R5bGUgYW5kIHNpemUgb2YgdGhlIGZvbnQKICogQHBhcmFtIFtzdHlsZS5maWxsPSdibGFjayddIHtPYmplY3R9IEEgY2FudmFzIGZpbGxzdHlsZSB0aGF0IHdpbGwgYmUgdXNlZCBvbiB0aGUgdGV4dCBlZyAncmVkJywgJyMwMEZGMDAnCiAqIEBwYXJhbSBbc3R5bGUuYWxpZ249J2xlZnQnXSB7U3RyaW5nfSBBbiBhbGlnbm1lbnQgb2YgdGhlIG11bHRpbGluZSB0ZXh0ICgnbGVmdCcsICdjZW50ZXInIG9yICdyaWdodCcpCiAqIEBwYXJhbSBbc3R5bGUuc3Ryb2tlPSdibGFjayddIHtTdHJpbmd9IEEgY2FudmFzIGZpbGxzdHlsZSB0aGF0IHdpbGwgYmUgdXNlZCBvbiB0aGUgdGV4dCBzdHJva2UgZWcgJ2JsdWUnLCAnI0ZDRkYwMCcKICogQHBhcmFtIFtzdHlsZS5zdHJva2VUaGlja25lc3M9MF0ge051bWJlcn0gQSBudW1iZXIgdGhhdCByZXByZXNlbnRzIHRoZSB0aGlja25lc3Mgb2YgdGhlIHN0cm9rZS4gRGVmYXVsdCBpcyAwIChubyBzdHJva2UpCiAqIEBwYXJhbSBbc3R5bGUud29yZFdyYXA9ZmFsc2VdIHtCb29sZWFufSBJbmRpY2F0ZXMgaWYgd29yZCB3cmFwIHNob3VsZCBiZSB1c2VkCiAqIEBwYXJhbSBbc3R5bGUud29yZFdyYXBXaWR0aD0xMDBdIHtOdW1iZXJ9IFRoZSB3aWR0aCBhdCB3aGljaCB0ZXh0IHdpbGwgd3JhcAogKi8KUElYSS5UZXh0LnByb3RvdHlwZS5zZXRTdHlsZSA9IGZ1bmN0aW9uKHN0eWxlKQp7CiAgICBzdHlsZSA9IHN0eWxlIHx8IHt9OwogICAgc3R5bGUuZm9udCA9IHN0eWxlLmZvbnQgfHwgJ2JvbGQgMjBwdCBBcmlhbCc7CiAgICBzdHlsZS5maWxsID0gc3R5bGUuZmlsbCB8fCAnYmxhY2snOwogICAgc3R5bGUuYWxpZ24gPSBzdHlsZS5hbGlnbiB8fCAnbGVmdCc7CiAgICBzdHlsZS5zdHJva2UgPSBzdHlsZS5zdHJva2UgfHwgJ2JsYWNrJzsgLy9wcm92aWRlIGEgZGVmYXVsdCwgc2VlOiBodHRwczovL2dpdGh1Yi5jb20vR29vZEJveURpZ2l0YWwvcGl4aS5qcy9pc3N1ZXMvMTM2CiAgICBzdHlsZS5zdHJva2VUaGlja25lc3MgPSBzdHlsZS5zdHJva2VUaGlja25lc3MgfHwgMDsKICAgIHN0eWxlLndvcmRXcmFwID0gc3R5bGUud29yZFdyYXAgfHwgZmFsc2U7CiAgICBzdHlsZS53b3JkV3JhcFdpZHRoID0gc3R5bGUud29yZFdyYXBXaWR0aCB8fCAxMDA7CiAgICB0aGlzLnN0eWxlID0gc3R5bGU7CiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKfTsKCi8qKgogKiBTZXQgdGhlIGNvcHkgZm9yIHRoZSB0ZXh0IG9iamVjdC4gVG8gc3BsaXQgYSBsaW5lIHlvdSBjYW4gdXNlICdcbicKICoKICogQG1ldGhvZCBzZXRUZXh0CiAqIEBwYXJhbSB7U3RyaW5nfSB0ZXh0IFRoZSBjb3B5IHRoYXQgeW91IHdvdWxkIGxpa2UgdGhlIHRleHQgdG8gZGlzcGxheQogKi8KUElYSS5UZXh0LnByb3RvdHlwZS5zZXRUZXh0ID0gZnVuY3Rpb24odGV4dCkKewogICAgdGhpcy50ZXh0ID0gdGV4dC50b1N0cmluZygpIHx8ICcgJzsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwp9OwoKLyoqCiAqIFJlbmRlcnMgdGV4dAogKgogKiBAbWV0aG9kIHVwZGF0ZVRleHQKICogQHByaXZhdGUKICovClBJWEkuVGV4dC5wcm90b3R5cGUudXBkYXRlVGV4dCA9IGZ1bmN0aW9uKCkKewogICAgdGhpcy5jb250ZXh0LmZvbnQgPSB0aGlzLnN0eWxlLmZvbnQ7CgogICAgdmFyIG91dHB1dFRleHQgPSB0aGlzLnRleHQ7CgogICAgLy8gd29yZCB3cmFwCiAgICAvLyBwcmVzZXJ2ZSBvcmlnaW5hbCB0ZXh0CiAgICBpZih0aGlzLnN0eWxlLndvcmRXcmFwKW91dHB1dFRleHQgPSB0aGlzLndvcmRXcmFwKHRoaXMudGV4dCk7CgogICAgLy9zcGxpdCB0ZXh0IGludG8gbGluZXMKICAgIHZhciBsaW5lcyA9IG91dHB1dFRleHQuc3BsaXQoLyg/OlxyXG58XHJ8XG4pLyk7CgogICAgLy9jYWxjdWxhdGUgdGV4dCB3aWR0aAogICAgdmFyIGxpbmVXaWR0aHMgPSBbXTsKICAgIHZhciBtYXhMaW5lV2lkdGggPSAwOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykKICAgIHsKICAgICAgICB2YXIgbGluZVdpZHRoID0gdGhpcy5jb250ZXh0Lm1lYXN1cmVUZXh0KGxpbmVzW2ldKS53aWR0aDsKICAgICAgICBsaW5lV2lkdGhzW2ldID0gbGluZVdpZHRoOwogICAgICAgIG1heExpbmVXaWR0aCA9IE1hdGgubWF4KG1heExpbmVXaWR0aCwgbGluZVdpZHRoKTsKICAgIH0KICAgIHRoaXMuY2FudmFzLndpZHRoID0gbWF4TGluZVdpZHRoICsgdGhpcy5zdHlsZS5zdHJva2VUaGlja25lc3M7CgogICAgLy9jYWxjdWxhdGUgdGV4dCBoZWlnaHQKICAgIHZhciBsaW5lSGVpZ2h0ID0gdGhpcy5kZXRlcm1pbmVGb250SGVpZ2h0KCdmb250OiAnICsgdGhpcy5zdHlsZS5mb250ICArICc7JykgKyB0aGlzLnN0eWxlLnN0cm9rZVRoaWNrbmVzczsKICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IGxpbmVIZWlnaHQgKiBsaW5lcy5sZW5ndGg7CgogICAgLy9zZXQgY2FudmFzIHRleHQgc3R5bGVzCiAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gdGhpcy5zdHlsZS5maWxsOwogICAgdGhpcy5jb250ZXh0LmZvbnQgPSB0aGlzLnN0eWxlLmZvbnQ7CgogICAgdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gdGhpcy5zdHlsZS5zdHJva2U7CiAgICB0aGlzLmNvbnRleHQubGluZVdpZHRoID0gdGhpcy5zdHlsZS5zdHJva2VUaGlja25lc3M7CgogICAgdGhpcy5jb250ZXh0LnRleHRCYXNlbGluZSA9ICd0b3AnOwoKICAgIC8vZHJhdyBsaW5lcyBsaW5lIGJ5IGxpbmUKICAgIGZvciAoaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykKICAgIHsKICAgICAgICB2YXIgbGluZVBvc2l0aW9uID0gbmV3IFBJWEkuUG9pbnQodGhpcy5zdHlsZS5zdHJva2VUaGlja25lc3MgLyAyLCB0aGlzLnN0eWxlLnN0cm9rZVRoaWNrbmVzcyAvIDIgKyBpICogbGluZUhlaWdodCk7CgogICAgICAgIGlmKHRoaXMuc3R5bGUuYWxpZ24gPT09ICdyaWdodCcpCiAgICAgICAgewogICAgICAgICAgICBsaW5lUG9zaXRpb24ueCArPSBtYXhMaW5lV2lkdGggLSBsaW5lV2lkdGhzW2ldOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmKHRoaXMuc3R5bGUuYWxpZ24gPT09ICdjZW50ZXInKQogICAgICAgIHsKICAgICAgICAgICAgbGluZVBvc2l0aW9uLnggKz0gKG1heExpbmVXaWR0aCAtIGxpbmVXaWR0aHNbaV0pIC8gMjsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMuc3R5bGUuc3Ryb2tlICYmIHRoaXMuc3R5bGUuc3Ryb2tlVGhpY2tuZXNzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVRleHQobGluZXNbaV0sIGxpbmVQb3NpdGlvbi54LCBsaW5lUG9zaXRpb24ueSk7CiAgICAgICAgfQoKICAgICAgICBpZih0aGlzLnN0eWxlLmZpbGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFRleHQobGluZXNbaV0sIGxpbmVQb3NpdGlvbi54LCBsaW5lUG9zaXRpb24ueSk7CiAgICAgICAgfQogICAgfQoKICAgIHRoaXMudXBkYXRlVGV4dHVyZSgpOwp9OwoKLyoqCiAqIFVwZGF0ZXMgdGV4dHVyZSBzaXplIGJhc2VkIG9uIGNhbnZhcyBzaXplCiAqCiAqIEBtZXRob2QgdXBkYXRlVGV4dHVyZQogKiBAcHJpdmF0ZQogKi8KUElYSS5UZXh0LnByb3RvdHlwZS51cGRhdGVUZXh0dXJlID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLnRleHR1cmUuYmFzZVRleHR1cmUud2lkdGggPSB0aGlzLmNhbnZhcy53aWR0aDsKICAgIHRoaXMudGV4dHVyZS5iYXNlVGV4dHVyZS5oZWlnaHQgPSB0aGlzLmNhbnZhcy5oZWlnaHQ7CiAgICB0aGlzLnRleHR1cmUuZnJhbWUud2lkdGggPSB0aGlzLmNhbnZhcy53aWR0aDsKICAgIHRoaXMudGV4dHVyZS5mcmFtZS5oZWlnaHQgPSB0aGlzLmNhbnZhcy5oZWlnaHQ7CgogICAgdGhpcy5fd2lkdGggPSB0aGlzLmNhbnZhcy53aWR0aDsKICAgIHRoaXMuX2hlaWdodCA9IHRoaXMuY2FudmFzLmhlaWdodDsKCiAgICBQSVhJLnRleHR1cmVzVG9VcGRhdGUucHVzaCh0aGlzLnRleHR1cmUuYmFzZVRleHR1cmUpOwp9OwoKLyoqCiAqIFVwZGF0ZXMgdGhlIHRyYW5zZm9yIG9mIHRoaXMgb2JqZWN0CiAqCiAqIEBtZXRob2QgdXBkYXRlVHJhbnNmb3JtCiAqIEBwcml2YXRlCiAqLwpQSVhJLlRleHQucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybSA9IGZ1bmN0aW9uKCkKewogICAgaWYodGhpcy5kaXJ0eSkKICAgIHsKICAgICAgICB0aGlzLnVwZGF0ZVRleHQoKTsKICAgICAgICB0aGlzLmRpcnR5ID0gZmFsc2U7CiAgICB9CgogICAgUElYSS5TcHJpdGUucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybS5jYWxsKHRoaXMpOwp9OwoKLyoKICogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3VzZXJzLzM0NDQxL2VsbGlzYmJlbgogKiBncmVhdCBzb2x1dGlvbiB0byB0aGUgcHJvYmxlbSEKICoKICogQG1ldGhvZCBkZXRlcm1pbmVGb250SGVpZ2h0CiAqIEBwYXJhbSBmb250U3R5bGUge09iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuVGV4dC5wcm90b3R5cGUuZGV0ZXJtaW5lRm9udEhlaWdodCA9IGZ1bmN0aW9uKGZvbnRTdHlsZSkKewogICAgLy8gYnVpbGQgYSBsaXR0bGUgcmVmZXJlbmNlIGRpY3Rpb25hcnkgc28gaWYgdGhlIGZvbnQgc3R5bGUgaGFzIGJlZW4gdXNlZCByZXR1cm4gYQogICAgLy8gY2FjaGVkIHZlcnNpb24uLi4KICAgIHZhciByZXN1bHQgPSBQSVhJLlRleHQuaGVpZ2h0Q2FjaGVbZm9udFN0eWxlXTsKCiAgICBpZighcmVzdWx0KQogICAgewogICAgICAgIHZhciBib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2JvZHknKVswXTsKICAgICAgICB2YXIgZHVtbXkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICB2YXIgZHVtbXlUZXh0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJ00nKTsKICAgICAgICBkdW1teS5hcHBlbmRDaGlsZChkdW1teVRleHQpOwogICAgICAgIGR1bW15LnNldEF0dHJpYnV0ZSgnc3R5bGUnLCBmb250U3R5bGUgKyAnO3Bvc2l0aW9uOmFic29sdXRlO3RvcDowO2xlZnQ6MCcpOwogICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQoZHVtbXkpOwoKICAgICAgICByZXN1bHQgPSBkdW1teS5vZmZzZXRIZWlnaHQ7CiAgICAgICAgUElYSS5UZXh0LmhlaWdodENhY2hlW2ZvbnRTdHlsZV0gPSByZXN1bHQ7CgogICAgICAgIGJvZHkucmVtb3ZlQ2hpbGQoZHVtbXkpOwogICAgfQoKICAgIHJldHVybiByZXN1bHQ7Cn07CgovKioKICogQXBwbGllcyBuZXdsaW5lcyB0byBhIHN0cmluZyB0byBoYXZlIGl0IG9wdGltYWxseSBmaXQgaW50byB0aGUgaG9yaXpvbnRhbAogKiBib3VuZHMgc2V0IGJ5IHRoZSBUZXh0IG9iamVjdCdzIHdvcmRXcmFwV2lkdGggcHJvcGVydHkuCiAqCiAqIEBtZXRob2Qgd29yZFdyYXAKICogQHBhcmFtIHRleHQge1N0cmluZ30KICogQHByaXZhdGUKICovClBJWEkuVGV4dC5wcm90b3R5cGUud29yZFdyYXAgPSBmdW5jdGlvbih0ZXh0KQp7CiAgICAvLyBHcmVlZHkgd3JhcHBpbmcgYWxnb3JpdGhtIHRoYXQgd2lsbCB3cmFwIHdvcmRzIGFzIHRoZSBsaW5lIGdyb3dzIGxvbmdlcgogICAgLy8gdGhhbiBpdHMgaG9yaXpvbnRhbCBib3VuZHMuCiAgICB2YXIgcmVzdWx0ID0gJyc7CiAgICB2YXIgbGluZXMgPSB0ZXh0LnNwbGl0KCdcbicpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykKICAgIHsKICAgICAgICB2YXIgc3BhY2VMZWZ0ID0gdGhpcy5zdHlsZS53b3JkV3JhcFdpZHRoOwogICAgICAgIHZhciB3b3JkcyA9IGxpbmVzW2ldLnNwbGl0KCcgJyk7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB3b3Jkcy5sZW5ndGg7IGorKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB3b3JkV2lkdGggPSB0aGlzLmNvbnRleHQubWVhc3VyZVRleHQod29yZHNbal0pLndpZHRoOwogICAgICAgICAgICB2YXIgd29yZFdpZHRoV2l0aFNwYWNlID0gd29yZFdpZHRoICsgdGhpcy5jb250ZXh0Lm1lYXN1cmVUZXh0KCcgJykud2lkdGg7CiAgICAgICAgICAgIGlmKHdvcmRXaWR0aFdpdGhTcGFjZSA+IHNwYWNlTGVmdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gU2tpcCBwcmludGluZyB0aGUgbmV3bGluZSBpZiBpdCdzIHRoZSBmaXJzdCB3b3JkIG9mIHRoZSBsaW5lIHRoYXQgaXMKICAgICAgICAgICAgICAgIC8vIGdyZWF0ZXIgdGhhbiB0aGUgd29yZCB3cmFwIHdpZHRoLgogICAgICAgICAgICAgICAgaWYoaiA+IDApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9ICdcbic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXN1bHQgKz0gd29yZHNbal0gKyAnICc7CiAgICAgICAgICAgICAgICBzcGFjZUxlZnQgPSB0aGlzLnN0eWxlLndvcmRXcmFwV2lkdGggLSB3b3JkV2lkdGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzcGFjZUxlZnQgLT0gd29yZFdpZHRoV2l0aFNwYWNlOwogICAgICAgICAgICAgICAgcmVzdWx0ICs9IHdvcmRzW2pdICsgJyAnOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdCArPSAnXG4nOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKfTsKCi8qKgogKiBEZXN0cm95cyB0aGlzIHRleHQgb2JqZWN0CiAqCiAqIEBtZXRob2QgZGVzdHJveQogKiBAcGFyYW0gZGVzdHJveVRleHR1cmUge0Jvb2xlYW59CiAqLwpQSVhJLlRleHQucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbihkZXN0cm95VGV4dHVyZSkKewogICAgaWYoZGVzdHJveVRleHR1cmUpCiAgICB7CiAgICAgICAgdGhpcy50ZXh0dXJlLmRlc3Ryb3koKTsKICAgIH0KCn07CgpQSVhJLlRleHQuaGVpZ2h0Q2FjaGUgPSB7fTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgpQSVhJLkJhc2VUZXh0dXJlQ2FjaGUgPSB7fTsKUElYSS50ZXh0dXJlc1RvVXBkYXRlID0gW107ClBJWEkudGV4dHVyZXNUb0Rlc3Ryb3kgPSBbXTsKCi8qKgogKiBBIHRleHR1cmUgc3RvcmVzIHRoZSBpbmZvcm1hdGlvbiB0aGF0IHJlcHJlc2VudHMgYW4gaW1hZ2UuIEFsbCB0ZXh0dXJlcyBoYXZlIGEgYmFzZSB0ZXh0dXJlCiAqCiAqIEBjbGFzcyBCYXNlVGV4dHVyZQogKiBAdXNlcyBFdmVudFRhcmdldAogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHNvdXJjZSB7U3RyaW5nfSB0aGUgc291cmNlIG9iamVjdCAoaW1hZ2Ugb3IgY2FudmFzKQogKi8KUElYSS5CYXNlVGV4dHVyZSA9IGZ1bmN0aW9uKHNvdXJjZSwgc2NhbGVNb2RlKQp7CiAgICBQSVhJLkV2ZW50VGFyZ2V0LmNhbGwoIHRoaXMgKTsKCiAgICAvKioKICAgICAqIFtyZWFkLW9ubHldIFRoZSB3aWR0aCBvZiB0aGUgYmFzZSB0ZXh0dXJlIHNldCB3aGVuIHRoZSBpbWFnZSBoYXMgbG9hZGVkCiAgICAgKgogICAgICogQHByb3BlcnR5IHdpZHRoCiAgICAgKiBAdHlwZSBOdW1iZXIKICAgICAqIEByZWFkT25seQogICAgICovCiAgICB0aGlzLndpZHRoID0gMTAwOwoKICAgIC8qKgogICAgICogW3JlYWQtb25seV0gVGhlIGhlaWdodCBvZiB0aGUgYmFzZSB0ZXh0dXJlIHNldCB3aGVuIHRoZSBpbWFnZSBoYXMgbG9hZGVkCiAgICAgKgogICAgICogQHByb3BlcnR5IGhlaWdodAogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKiBAcmVhZE9ubHkKICAgICAqLwogICAgdGhpcy5oZWlnaHQgPSAxMDA7CgogICAgLyoqCiAgICAgKiBUaGUgc2NhbGUgbW9kZSB0byBhcHBseSB3aGVuIHNjYWxpbmcgdGhpcyB0ZXh0dXJlCiAgICAgKiBAcHJvcGVydHkgc2NhbGVNb2RlCiAgICAgKiBAdHlwZSBQSVhJLkJhc2VUZXh0dXJlLlNDQUxFX01PREUKICAgICAqIEBkZWZhdWx0IFBJWEkuQmFzZVRleHR1cmUuU0NBTEVfTU9ERS5MSU5FQVIKICAgICAqLwogICAgdGhpcy5zY2FsZU1vZGUgPSBzY2FsZU1vZGUgfHwgUElYSS5CYXNlVGV4dHVyZS5TQ0FMRV9NT0RFLkRFRkFVTFQ7CgogICAgLyoqCiAgICAgKiBbcmVhZC1vbmx5XSBEZXNjcmliZXMgaWYgdGhlIGJhc2UgdGV4dHVyZSBoYXMgbG9hZGVkIG9yIG5vdAogICAgICoKICAgICAqIEBwcm9wZXJ0eSBoYXNMb2FkZWQKICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAqIEByZWFkT25seQogICAgICovCiAgICB0aGlzLmhhc0xvYWRlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgICogVGhlIHNvdXJjZSB0aGF0IGlzIGxvYWRlZCB0byBjcmVhdGUgdGhlIHRleHR1cmUKICAgICAqCiAgICAgKiBAcHJvcGVydHkgc291cmNlCiAgICAgKiBAdHlwZSBJbWFnZQogICAgICovCiAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZTsKCiAgICBpZighc291cmNlKXJldHVybjsKCiAgICBpZih0aGlzLnNvdXJjZSBpbnN0YW5jZW9mIEltYWdlIHx8IHRoaXMuc291cmNlIGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudCkKICAgIHsKICAgICAgICBpZih0aGlzLnNvdXJjZS5jb21wbGV0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuaGFzTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMuc291cmNlLndpZHRoOwogICAgICAgICAgICB0aGlzLmhlaWdodCA9IHRoaXMuc291cmNlLmhlaWdodDsKCiAgICAgICAgICAgIFBJWEkudGV4dHVyZXNUb1VwZGF0ZS5wdXNoKHRoaXMpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewoKICAgICAgICAgICAgdmFyIHNjb3BlID0gdGhpczsKICAgICAgICAgICAgdGhpcy5zb3VyY2Uub25sb2FkID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgc2NvcGUuaGFzTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHNjb3BlLndpZHRoID0gc2NvcGUuc291cmNlLndpZHRoOwogICAgICAgICAgICAgICAgc2NvcGUuaGVpZ2h0ID0gc2NvcGUuc291cmNlLmhlaWdodDsKCiAgICAgICAgICAgICAgICAvLyBhZGQgaXQgdG8gc29tZXdoZXJlLi4uCiAgICAgICAgICAgICAgICBQSVhJLnRleHR1cmVzVG9VcGRhdGUucHVzaChzY29wZSk7CiAgICAgICAgICAgICAgICBzY29wZS5kaXNwYXRjaEV2ZW50KCB7IHR5cGU6ICdsb2FkZWQnLCBjb250ZW50OiBzY29wZSB9ICk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vdGhpcy5pbWFnZS5zcmMgPSBpbWFnZVVybDsKICAgICAgICB9CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5oYXNMb2FkZWQgPSB0cnVlOwogICAgICAgIHRoaXMud2lkdGggPSB0aGlzLnNvdXJjZS53aWR0aDsKICAgICAgICB0aGlzLmhlaWdodCA9IHRoaXMuc291cmNlLmhlaWdodDsKCiAgICAgICAgUElYSS50ZXh0dXJlc1RvVXBkYXRlLnB1c2godGhpcyk7CiAgICB9CgogICAgdGhpcy5pbWFnZVVybCA9IG51bGw7CiAgICB0aGlzLl9wb3dlck9mMiA9IGZhbHNlOwp9OwoKUElYSS5CYXNlVGV4dHVyZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLkJhc2VUZXh0dXJlOwoKLyoqCiAqIERlc3Ryb3lzIHRoaXMgYmFzZSB0ZXh0dXJlCiAqCiAqIEBtZXRob2QgZGVzdHJveQogKi8KUElYSS5CYXNlVGV4dHVyZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkKewogICAgaWYodGhpcy5zb3VyY2UgaW5zdGFuY2VvZiBJbWFnZSkKICAgIHsKICAgICAgICBpZiAodGhpcy5pbWFnZVVybCBpbiBQSVhJLkJhc2VUZXh0dXJlQ2FjaGUpCiAgICAgICAgICAgIGRlbGV0ZSBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbdGhpcy5pbWFnZVVybF07CiAgICAgICAgdGhpcy5pbWFnZVVybCA9IG51bGw7CiAgICAgICAgdGhpcy5zb3VyY2Uuc3JjID0gbnVsbDsKICAgIH0KICAgIHRoaXMuc291cmNlID0gbnVsbDsKICAgIFBJWEkudGV4dHVyZXNUb0Rlc3Ryb3kucHVzaCh0aGlzKTsKfTsKCi8qKgogKgogKgogKiBAbWV0aG9kIGRlc3Ryb3kKICovCgpQSVhJLkJhc2VUZXh0dXJlLnByb3RvdHlwZS51cGRhdGVTb3VyY2VJbWFnZSA9IGZ1bmN0aW9uKG5ld1NyYykKewogICAgdGhpcy5oYXNMb2FkZWQgPSBmYWxzZTsKICAgIHRoaXMuc291cmNlLnNyYyA9IG51bGw7CiAgICB0aGlzLnNvdXJjZS5zcmMgPSBuZXdTcmM7Cn07CgovKioKICogSGVscGVyIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIGJhc2UgdGV4dHVyZSBiYXNlZCBvbiBhbiBpbWFnZSB1cmwKICogSWYgdGhlIGltYWdlIGlzIG5vdCBpbiB0aGUgYmFzZSB0ZXh0dXJlIGNhY2hlIGl0IHdpbGwgYmUgIGNyZWF0ZWQgYW5kIGxvYWRlZAogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgZnJvbUltYWdlCiAqIEBwYXJhbSBpbWFnZVVybCB7U3RyaW5nfSBUaGUgaW1hZ2UgdXJsIG9mIHRoZSB0ZXh0dXJlCiAqIEByZXR1cm4gQmFzZVRleHR1cmUKICovClBJWEkuQmFzZVRleHR1cmUuZnJvbUltYWdlID0gZnVuY3Rpb24oaW1hZ2VVcmwsIGNyb3Nzb3JpZ2luLCBzY2FsZU1vZGUpCnsKICAgIHZhciBiYXNlVGV4dHVyZSA9IFBJWEkuQmFzZVRleHR1cmVDYWNoZVtpbWFnZVVybF07CiAgICBpZighYmFzZVRleHR1cmUpCiAgICB7CiAgICAgICAgLy8gbmV3IEltYWdlKCkgYnJlYWtzIHRleCBsb2FkaW5nIGluIHNvbWUgdmVyc2lvbnMgb2YgQ2hyb21lLgogICAgICAgIC8vIFNlZSBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9MjM4MDcxCiAgICAgICAgdmFyIGltYWdlID0gbmV3IEltYWdlKCk7Ly9kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTsKICAgICAgICBpZiAoY3Jvc3NvcmlnaW4pCiAgICAgICAgewogICAgICAgICAgICBpbWFnZS5jcm9zc09yaWdpbiA9ICcnOwogICAgICAgIH0KICAgICAgICBpbWFnZS5zcmMgPSBpbWFnZVVybDsKICAgICAgICBiYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKGltYWdlLCBzY2FsZU1vZGUpOwogICAgICAgIGJhc2VUZXh0dXJlLmltYWdlVXJsID0gaW1hZ2VVcmw7CiAgICAgICAgUElYSS5CYXNlVGV4dHVyZUNhY2hlW2ltYWdlVXJsXSA9IGJhc2VUZXh0dXJlOwogICAgfQoKICAgIHJldHVybiBiYXNlVGV4dHVyZTsKfTsKClBJWEkuQmFzZVRleHR1cmUuU0NBTEVfTU9ERSA9IHsKICAgIERFRkFVTFQ6IDAsIC8vZGVmYXVsdCB0byBMSU5FQVIKICAgIExJTkVBUjogMCwKICAgIE5FQVJFU1Q6IDEKfTsKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KClBJWEkuVGV4dHVyZUNhY2hlID0ge307ClBJWEkuRnJhbWVDYWNoZSA9IHt9OwoKLyoqCiAqIEEgdGV4dHVyZSBzdG9yZXMgdGhlIGluZm9ybWF0aW9uIHRoYXQgcmVwcmVzZW50cyBhbiBpbWFnZSBvciBwYXJ0IG9mIGFuIGltYWdlLiBJdCBjYW5ub3QgYmUgYWRkZWQKICogdG8gdGhlIGRpc3BsYXkgbGlzdCBkaXJlY3RseS4gVG8gZG8gdGhpcyB1c2UgUElYSS5TcHJpdGUuIElmIG5vIGZyYW1lIGlzIHByb3ZpZGVkIHRoZW4gdGhlIHdob2xlIGltYWdlIGlzIHVzZWQKICoKICogQGNsYXNzIFRleHR1cmUKICogQHVzZXMgRXZlbnRUYXJnZXQKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSBiYXNlVGV4dHVyZSB7QmFzZVRleHR1cmV9IFRoZSBiYXNlIHRleHR1cmUgc291cmNlIHRvIGNyZWF0ZSB0aGUgdGV4dHVyZSBmcm9tCiAqIEBwYXJhbSBmcmFtZSB7UmVjdGFuZ2xlfSBUaGUgcmVjdGFuZ2xlIGZyYW1lIG9mIHRoZSB0ZXh0dXJlIHRvIHNob3cKICovClBJWEkuVGV4dHVyZSA9IGZ1bmN0aW9uKGJhc2VUZXh0dXJlLCBmcmFtZSkKewogICAgUElYSS5FdmVudFRhcmdldC5jYWxsKCB0aGlzICk7CgogICAgaWYoIWZyYW1lKQogICAgewogICAgICAgIHRoaXMubm9GcmFtZSA9IHRydWU7CiAgICAgICAgZnJhbWUgPSBuZXcgUElYSS5SZWN0YW5nbGUoMCwwLDEsMSk7CiAgICB9CgogICAgaWYoYmFzZVRleHR1cmUgaW5zdGFuY2VvZiBQSVhJLlRleHR1cmUpCiAgICAgICAgYmFzZVRleHR1cmUgPSBiYXNlVGV4dHVyZS5iYXNlVGV4dHVyZTsKCiAgICAvKioKICAgICAqIFRoZSBiYXNlIHRleHR1cmUgb2YgdGhpcyB0ZXh0dXJlCiAgICAgKgogICAgICogQHByb3BlcnR5IGJhc2VUZXh0dXJlCiAgICAgKiBAdHlwZSBCYXNlVGV4dHVyZQogICAgICovCiAgICB0aGlzLmJhc2VUZXh0dXJlID0gYmFzZVRleHR1cmU7CgogICAgLyoqCiAgICAgKiBUaGUgZnJhbWUgc3BlY2lmaWVzIHRoZSByZWdpb24gb2YgdGhlIGJhc2UgdGV4dHVyZSB0aGF0IHRoaXMgdGV4dHVyZSB1c2VzCiAgICAgKgogICAgICogQHByb3BlcnR5IGZyYW1lCiAgICAgKiBAdHlwZSBSZWN0YW5nbGUKICAgICAqLwogICAgdGhpcy5mcmFtZSA9IGZyYW1lOwoKICAgIC8qKgogICAgICogVGhlIHRyaW0gcG9pbnQKICAgICAqCiAgICAgKiBAcHJvcGVydHkgdHJpbQogICAgICogQHR5cGUgUG9pbnQKICAgICAqLwogICAgdGhpcy50cmltID0gbmV3IFBJWEkuUG9pbnQoKTsKCiAgICB0aGlzLnNjb3BlID0gdGhpczsKCiAgICBpZihiYXNlVGV4dHVyZS5oYXNMb2FkZWQpCiAgICB7CiAgICAgICAgaWYodGhpcy5ub0ZyYW1lKWZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsMCwgYmFzZVRleHR1cmUud2lkdGgsIGJhc2VUZXh0dXJlLmhlaWdodCk7CiAgICAgICAgLy9jb25zb2xlLmxvZyhmcmFtZSkKCiAgICAgICAgdGhpcy5zZXRGcmFtZShmcmFtZSk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdmFyIHNjb3BlID0gdGhpczsKICAgICAgICBiYXNlVGV4dHVyZS5hZGRFdmVudExpc3RlbmVyKCdsb2FkZWQnLCBmdW5jdGlvbigpeyBzY29wZS5vbkJhc2VUZXh0dXJlTG9hZGVkKCk7IH0pOwogICAgfQp9OwoKUElYSS5UZXh0dXJlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuVGV4dHVyZTsKCi8qKgogKiBDYWxsZWQgd2hlbiB0aGUgYmFzZSB0ZXh0dXJlIGlzIGxvYWRlZAogKgogKiBAbWV0aG9kIG9uQmFzZVRleHR1cmVMb2FkZWQKICogQHBhcmFtIGV2ZW50CiAqIEBwcml2YXRlCiAqLwpQSVhJLlRleHR1cmUucHJvdG90eXBlLm9uQmFzZVRleHR1cmVMb2FkZWQgPSBmdW5jdGlvbigpCnsKICAgIHZhciBiYXNlVGV4dHVyZSA9IHRoaXMuYmFzZVRleHR1cmU7CiAgICBiYXNlVGV4dHVyZS5yZW1vdmVFdmVudExpc3RlbmVyKCAnbG9hZGVkJywgdGhpcy5vbkxvYWRlZCApOwoKICAgIGlmKHRoaXMubm9GcmFtZSl0aGlzLmZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsMCwgYmFzZVRleHR1cmUud2lkdGgsIGJhc2VUZXh0dXJlLmhlaWdodCk7CiAgICB0aGlzLm5vRnJhbWUgPSBmYWxzZTsKICAgIHRoaXMud2lkdGggPSB0aGlzLmZyYW1lLndpZHRoOwogICAgdGhpcy5oZWlnaHQgPSB0aGlzLmZyYW1lLmhlaWdodDsKCiAgICB0aGlzLnNjb3BlLmRpc3BhdGNoRXZlbnQoIHsgdHlwZTogJ3VwZGF0ZScsIGNvbnRlbnQ6IHRoaXMgfSApOwp9OwoKLyoqCiAqIERlc3Ryb3lzIHRoaXMgdGV4dHVyZQogKgogKiBAbWV0aG9kIGRlc3Ryb3kKICogQHBhcmFtIGRlc3Ryb3lCYXNlIHtCb29sZWFufSBXaGV0aGVyIHRvIGRlc3Ryb3kgdGhlIGJhc2UgdGV4dHVyZSBhcyB3ZWxsCiAqLwpQSVhJLlRleHR1cmUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbihkZXN0cm95QmFzZSkKewogICAgaWYoZGVzdHJveUJhc2UpIHRoaXMuYmFzZVRleHR1cmUuZGVzdHJveSgpOwp9OwoKLyoqCiAqIFNwZWNpZmllcyB0aGUgcmVjdGFuZ2xlIHJlZ2lvbiBvZiB0aGUgYmFzZVRleHR1cmUKICoKICogQG1ldGhvZCBzZXRGcmFtZQogKiBAcGFyYW0gZnJhbWUge1JlY3RhbmdsZX0gVGhlIGZyYW1lIG9mIHRoZSB0ZXh0dXJlIHRvIHNldCBpdCB0bwogKi8KUElYSS5UZXh0dXJlLnByb3RvdHlwZS5zZXRGcmFtZSA9IGZ1bmN0aW9uKGZyYW1lKQp7CiAgICB0aGlzLmZyYW1lID0gZnJhbWU7CiAgICB0aGlzLndpZHRoID0gZnJhbWUud2lkdGg7CiAgICB0aGlzLmhlaWdodCA9IGZyYW1lLmhlaWdodDsKCiAgICBpZihmcmFtZS54ICsgZnJhbWUud2lkdGggPiB0aGlzLmJhc2VUZXh0dXJlLndpZHRoIHx8IGZyYW1lLnkgKyBmcmFtZS5oZWlnaHQgPiB0aGlzLmJhc2VUZXh0dXJlLmhlaWdodCkKICAgIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RleHR1cmUgRXJyb3I6IGZyYW1lIGRvZXMgbm90IGZpdCBpbnNpZGUgdGhlIGJhc2UgVGV4dHVyZSBkaW1lbnNpb25zICcgKyB0aGlzKTsKICAgIH0KCiAgICB0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKCiAgICBQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzLnB1c2godGhpcyk7CiAgICAvL3RoaXMuZGlzcGF0Y2hFdmVudCggeyB0eXBlOiAndXBkYXRlJywgY29udGVudDogdGhpcyB9ICk7Cn07CgovKioKICogSGVscGVyIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIHRleHR1cmUgYmFzZWQgb24gYW4gaW1hZ2UgdXJsCiAqIElmIHRoZSBpbWFnZSBpcyBub3QgaW4gdGhlIHRleHR1cmUgY2FjaGUgaXQgd2lsbCBiZSAgY3JlYXRlZCBhbmQgbG9hZGVkCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCBmcm9tSW1hZ2UKICogQHBhcmFtIGltYWdlVXJsIHtTdHJpbmd9IFRoZSBpbWFnZSB1cmwgb2YgdGhlIHRleHR1cmUKICogQHBhcmFtIGNyb3Nzb3JpZ2luIHtCb29sZWFufSBXaGV0aGVyIHJlcXVlc3RzIHNob3VsZCBiZSB0cmVhdGVkIGFzIGNyb3Nzb3JpZ2luCiAqIEByZXR1cm4gVGV4dHVyZQogKi8KUElYSS5UZXh0dXJlLmZyb21JbWFnZSA9IGZ1bmN0aW9uKGltYWdlVXJsLCBjcm9zc29yaWdpbiwgc2NhbGVNb2RlKQp7CiAgICB2YXIgdGV4dHVyZSA9IFBJWEkuVGV4dHVyZUNhY2hlW2ltYWdlVXJsXTsKCiAgICBpZighdGV4dHVyZSkKICAgIHsKICAgICAgICB0ZXh0dXJlID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlLmZyb21JbWFnZShpbWFnZVVybCwgY3Jvc3NvcmlnaW4sIHNjYWxlTW9kZSkpOwogICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW2ltYWdlVXJsXSA9IHRleHR1cmU7CiAgICB9CgogICAgcmV0dXJuIHRleHR1cmU7Cn07CgovKioKICogSGVscGVyIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIHRleHR1cmUgYmFzZWQgb24gYSBmcmFtZSBpZAogKiBJZiB0aGUgZnJhbWUgaWQgaXMgbm90IGluIHRoZSB0ZXh0dXJlIGNhY2hlIGFuIGVycm9yIHdpbGwgYmUgdGhyb3duCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCBmcm9tRnJhbWUKICogQHBhcmFtIGZyYW1lSWQge1N0cmluZ30gVGhlIGZyYW1lIGlkIG9mIHRoZSB0ZXh0dXJlCiAqIEByZXR1cm4gVGV4dHVyZQogKi8KUElYSS5UZXh0dXJlLmZyb21GcmFtZSA9IGZ1bmN0aW9uKGZyYW1lSWQpCnsKICAgIHZhciB0ZXh0dXJlID0gUElYSS5UZXh0dXJlQ2FjaGVbZnJhbWVJZF07CiAgICBpZighdGV4dHVyZSkgdGhyb3cgbmV3IEVycm9yKCdUaGUgZnJhbWVJZCAiJyArIGZyYW1lSWQgKyAnIiBkb2VzIG5vdCBleGlzdCBpbiB0aGUgdGV4dHVyZSBjYWNoZSAnICsgdGhpcyk7CiAgICByZXR1cm4gdGV4dHVyZTsKfTsKCi8qKgogKiBIZWxwZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgdGV4dHVyZSBiYXNlZCBvbiBhIGNhbnZhcyBlbGVtZW50CiAqIElmIHRoZSBjYW52YXMgaXMgbm90IGluIHRoZSB0ZXh0dXJlIGNhY2hlIGl0IHdpbGwgYmUgIGNyZWF0ZWQgYW5kIGxvYWRlZAogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgZnJvbUNhbnZhcwogKiBAcGFyYW0gY2FudmFzIHtDYW52YXN9IFRoZSBjYW52YXMgZWxlbWVudCBzb3VyY2Ugb2YgdGhlIHRleHR1cmUKICogQHJldHVybiBUZXh0dXJlCiAqLwpQSVhJLlRleHR1cmUuZnJvbUNhbnZhcyA9IGZ1bmN0aW9uKGNhbnZhcywgc2NhbGVNb2RlKQp7CiAgICB2YXIgYmFzZVRleHR1cmUgPSBuZXcgUElYSS5CYXNlVGV4dHVyZShjYW52YXMsIHNjYWxlTW9kZSk7CiAgICByZXR1cm4gbmV3IFBJWEkuVGV4dHVyZShiYXNlVGV4dHVyZSk7Cn07CgoKLyoqCiAqIEFkZHMgYSB0ZXh0dXJlIHRvIHRoZSB0ZXh0dXJlQ2FjaGUuCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCBhZGRUZXh0dXJlVG9DYWNoZQogKiBAcGFyYW0gdGV4dHVyZSB7VGV4dHVyZX0KICogQHBhcmFtIGlkIHtTdHJpbmd9IHRoZSBpZCB0aGF0IHRoZSB0ZXh0dXJlIHdpbGwgYmUgc3RvcmVkIGFnYWluc3QuCiAqLwpQSVhJLlRleHR1cmUuYWRkVGV4dHVyZVRvQ2FjaGUgPSBmdW5jdGlvbih0ZXh0dXJlLCBpZCkKewogICAgUElYSS5UZXh0dXJlQ2FjaGVbaWRdID0gdGV4dHVyZTsKfTsKCi8qKgogKiBSZW1vdmUgYSB0ZXh0dXJlIGZyb20gdGhlIHRleHR1cmVDYWNoZS4KICoKICogQHN0YXRpYwogKiBAbWV0aG9kIHJlbW92ZVRleHR1cmVGcm9tQ2FjaGUKICogQHBhcmFtIGlkIHtTdHJpbmd9IHRoZSBpZCBvZiB0aGUgdGV4dHVyZSB0byBiZSByZW1vdmVkCiAqIEByZXR1cm4ge1RleHR1cmV9IHRoZSB0ZXh0dXJlIHRoYXQgd2FzIHJlbW92ZWQKICovClBJWEkuVGV4dHVyZS5yZW1vdmVUZXh0dXJlRnJvbUNhY2hlID0gZnVuY3Rpb24oaWQpCnsKICAgIHZhciB0ZXh0dXJlID0gUElYSS5UZXh0dXJlQ2FjaGVbaWRdOwogICAgUElYSS5UZXh0dXJlQ2FjaGVbaWRdID0gbnVsbDsKICAgIHJldHVybiB0ZXh0dXJlOwp9OwoKLy8gdGhpcyBpcyBtb3JlIGZvciB3ZWJHTC4uIGl0IGNvbnRhaW5zIHVwZGF0ZWQgZnJhbWVzLi4KUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcyA9IFtdOwoKUElYSS5UZXh0dXJlLlNDQUxFX01PREUgPSBQSVhJLkJhc2VUZXh0dXJlLlNDQUxFX01PREU7CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiBBIFJlbmRlclRleHR1cmUgaXMgYSBzcGVjaWFsIHRleHR1cmUgdGhhdCBhbGxvd3MgYW55IHBpeGkgZGlzcGxheU9iamVjdCB0byBiZSByZW5kZXJlZCB0byBpdC4KCiBfX0hpbnRfXzogQWxsIERpc3BsYXlPYmplY3RzIChleG1wbC4gU3ByaXRlcykgdGhhdCByZW5kZXJzIG9uIFJlbmRlclRleHR1cmUgc2hvdWxkIGJlIHByZWxvYWRlZC4KIE90aGVyd2lzZSBibGFjayByZWN0YW5nbGVzIHdpbGwgYmUgZHJhd24gaW5zdGVhZC4KCiBSZW5kZXJUZXh0dXJlIHRha2VzIHNuYXBzaG90IG9mIERpc3BsYXlPYmplY3QgcGFzc2VkIHRvIHJlbmRlciBtZXRob2QuIElmIERpc3BsYXlPYmplY3QgaXMgcGFzc2VkIHRvIHJlbmRlciBtZXRob2QsIHBvc2l0aW9uIGFuZCByb3RhdGlvbiBvZiBpdCB3aWxsIGJlIGlnbm9yZWQuIEZvciBleGFtcGxlOgoKICAgIHZhciByZW5kZXJUZXh0dXJlID0gbmV3IFBJWEkuUmVuZGVyVGV4dHVyZSg4MDAsIDYwMCk7CiAgICB2YXIgc3ByaXRlID0gUElYSS5TcHJpdGUuZnJvbUltYWdlKCJzcGluT2JqXzAxLnBuZyIpOwogICAgc3ByaXRlLnBvc2l0aW9uLnggPSA4MDAvMjsKICAgIHNwcml0ZS5wb3NpdGlvbi55ID0gNjAwLzI7CiAgICBzcHJpdGUuYW5jaG9yLnggPSAwLjU7CiAgICBzcHJpdGUuYW5jaG9yLnkgPSAwLjU7CiAgICByZW5kZXJUZXh0dXJlLnJlbmRlcihzcHJpdGUpOwoKIFNwcml0ZSBpbiB0aGlzIGNhc2Ugd2lsbCBiZSByZW5kZXJlZCB0byAwLDAgcG9zaXRpb24uIFRvIHJlbmRlciB0aGlzIHNwcml0ZSBhdCBjZW50ZXIgRGlzcGxheU9iamVjdENvbnRhaW5lciBzaG91bGQgYmUgdXNlZDoKCiAgICB2YXIgZG9jID0gbmV3IFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lcigpOwogICAgZG9jLmFkZENoaWxkKHNwcml0ZSk7CiAgICByZW5kZXJUZXh0dXJlLnJlbmRlcihkb2MpOyAgLy8gUmVuZGVycyB0byBjZW50ZXIgb2YgcmVuZGVyVGV4dHVyZQoKIEBjbGFzcyBSZW5kZXJUZXh0dXJlCiBAZXh0ZW5kcyBUZXh0dXJlCiBAY29uc3RydWN0b3IKIEBwYXJhbSB3aWR0aCB7TnVtYmVyfSBUaGUgd2lkdGggb2YgdGhlIHJlbmRlciB0ZXh0dXJlCiBAcGFyYW0gaGVpZ2h0IHtOdW1iZXJ9IFRoZSBoZWlnaHQgb2YgdGhlIHJlbmRlciB0ZXh0dXJlCiAqLwpQSVhJLlJlbmRlclRleHR1cmUgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KQp7CiAgICBQSVhJLkV2ZW50VGFyZ2V0LmNhbGwoIHRoaXMgKTsKCiAgICB0aGlzLndpZHRoID0gd2lkdGggfHwgMTAwOwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQgfHwgMTAwOwoKICAgIHRoaXMuaW5kZXRpdHlNYXRyaXggPSBQSVhJLm1hdDMuY3JlYXRlKCk7CgogICAgdGhpcy5mcmFtZSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgogICAgaWYoUElYSS5nbCkKICAgIHsKICAgICAgICB0aGlzLmluaXRXZWJHTCgpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMuaW5pdENhbnZhcygpOwogICAgfQp9OwoKUElYSS5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuVGV4dHVyZS5wcm90b3R5cGUgKTsKUElYSS5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuUmVuZGVyVGV4dHVyZTsKCi8qKgogKiBJbml0aWFsaXplcyB0aGUgd2ViZ2wgZGF0YSBmb3IgdGhpcyB0ZXh0dXJlCiAqCiAqIEBtZXRob2QgaW5pdFdlYkdMCiAqIEBwcml2YXRlCiAqLwpQSVhJLlJlbmRlclRleHR1cmUucHJvdG90eXBlLmluaXRXZWJHTCA9IGZ1bmN0aW9uKCkKewogICAgdmFyIGdsID0gUElYSS5nbDsKICAgIHRoaXMuZ2xGcmFtZWJ1ZmZlciA9IGdsLmNyZWF0ZUZyYW1lYnVmZmVyKCk7CgogICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0aGlzLmdsRnJhbWVidWZmZXIgKTsKCiAgICB0aGlzLmdsRnJhbWVidWZmZXIud2lkdGggPSB0aGlzLndpZHRoOwogICAgdGhpcy5nbEZyYW1lYnVmZmVyLmhlaWdodCA9IHRoaXMuaGVpZ2h0OwoKICAgIHRoaXMuYmFzZVRleHR1cmUgPSBuZXcgUElYSS5CYXNlVGV4dHVyZSgpOwoKICAgIHRoaXMuYmFzZVRleHR1cmUud2lkdGggPSB0aGlzLndpZHRoOwogICAgdGhpcy5iYXNlVGV4dHVyZS5oZWlnaHQgPSB0aGlzLmhlaWdodDsKCiAgICB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUgPSBnbC5jcmVhdGVUZXh0dXJlKCk7CiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpOwoKICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgIHRoaXMud2lkdGgsICB0aGlzLmhlaWdodCwgMCwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgbnVsbCk7CgogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01BR19GSUxURVIsIGdsLkxJTkVBUik7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUlOX0ZJTFRFUiwgZ2wuTElORUFSKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1MsIGdsLkNMQU1QX1RPX0VER0UpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuQ0xBTVBfVE9fRURHRSk7CgogICAgdGhpcy5iYXNlVGV4dHVyZS5pc1JlbmRlciA9IHRydWU7CgogICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0aGlzLmdsRnJhbWVidWZmZXIgKTsKICAgIGdsLmZyYW1lYnVmZmVyVGV4dHVyZTJEKGdsLkZSQU1FQlVGRkVSLCBnbC5DT0xPUl9BVFRBQ0hNRU5UMCwgZ2wuVEVYVFVSRV8yRCwgdGhpcy5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlLCAwKTsKCiAgICAvLyBjcmVhdGUgYSBwcm9qZWN0aW9uIG1hdHJpeC4uCiAgICB0aGlzLnByb2plY3Rpb24gPSBuZXcgUElYSS5Qb2ludCh0aGlzLndpZHRoLzIgLCAtdGhpcy5oZWlnaHQvMik7CgogICAgLy8gc2V0IHRoZSBjb3JyZWN0IHJlbmRlciBmdW5jdGlvbi4uCiAgICB0aGlzLnJlbmRlciA9IHRoaXMucmVuZGVyV2ViR0w7Cn07CgoKUElYSS5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KQp7CgogICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgaWYoUElYSS5nbCkKICAgIHsKICAgICAgICB0aGlzLnByb2plY3Rpb24ueCA9IHRoaXMud2lkdGggLyAyOwogICAgICAgIHRoaXMucHJvamVjdGlvbi55ID0gLXRoaXMuaGVpZ2h0IC8gMjsKCiAgICAgICAgdmFyIGdsID0gUElYSS5nbDsKICAgICAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpOwogICAgICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgIHRoaXMud2lkdGgsICB0aGlzLmhlaWdodCwgMCwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgbnVsbCk7CiAgICB9CiAgICBlbHNlCiAgICB7CgogICAgICAgIHRoaXMuZnJhbWUud2lkdGggPSB0aGlzLndpZHRoOwogICAgICAgIHRoaXMuZnJhbWUuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CiAgICAgICAgdGhpcy5yZW5kZXJlci5yZXNpemUodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwogICAgfQp9OwoKLyoqCiAqIEluaXRpYWxpemVzIHRoZSBjYW52YXMgZGF0YSBmb3IgdGhpcyB0ZXh0dXJlCiAqCiAqIEBtZXRob2QgaW5pdENhbnZhcwogKiBAcHJpdmF0ZQogKi8KUElYSS5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5pbml0Q2FudmFzID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLnJlbmRlcmVyID0gbmV3IFBJWEkuQ2FudmFzUmVuZGVyZXIodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQsIG51bGwsIDApOwoKICAgIHRoaXMuYmFzZVRleHR1cmUgPSBuZXcgUElYSS5CYXNlVGV4dHVyZSh0aGlzLnJlbmRlcmVyLnZpZXcpOwogICAgdGhpcy5mcmFtZSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgogICAgdGhpcy5yZW5kZXIgPSB0aGlzLnJlbmRlckNhbnZhczsKfTsKCi8qKgogKiBUaGlzIGZ1bmN0aW9uIHdpbGwgZHJhdyB0aGUgZGlzcGxheSBvYmplY3QgdG8gdGhlIHRleHR1cmUuCiAqCiAqIEBtZXRob2QgcmVuZGVyV2ViR0wKICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9IFRoZSBkaXNwbGF5IG9iamVjdCB0byByZW5kZXIgdGhpcyB0ZXh0dXJlIG9uCiAqIEBwYXJhbSBjbGVhciB7Qm9vbGVhbn0gSWYgdHJ1ZSB0aGUgdGV4dHVyZSB3aWxsIGJlIGNsZWFyZWQgYmVmb3JlIHRoZSBkaXNwbGF5T2JqZWN0IGlzIGRyYXduCiAqIEBwcml2YXRlCiAqLwpQSVhJLlJlbmRlclRleHR1cmUucHJvdG90eXBlLnJlbmRlcldlYkdMID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcG9zaXRpb24sIGNsZWFyKQp7CiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIC8vIGVuYWJsZSB0aGUgYWxwaGEgY29sb3IgbWFzay4uCiAgICBnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7CgogICAgZ2wudmlld3BvcnQoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoKICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGhpcy5nbEZyYW1lYnVmZmVyICk7CgogICAgaWYoY2xlYXIpCiAgICB7CiAgICAgICAgZ2wuY2xlYXJDb2xvcigwLDAsMCwgMCk7CiAgICAgICAgZ2wuY2xlYXIoZ2wuQ09MT1JfQlVGRkVSX0JJVCk7CiAgICB9CgogICAgLy8gVEhJUyBXSUxMIE1FU1MgV0lUSCBISVQgVEVTVElORyEKICAgIHZhciBjaGlsZHJlbiA9IGRpc3BsYXlPYmplY3QuY2hpbGRyZW47CgogICAgLy9UT0RPIC0/IGNyZWF0ZSBhIG5ldyBvbmU/Pz8gZG9udCB0aGluayBzbyEKICAgIHZhciBvcmlnaW5hbFdvcmxkVHJhbnNmb3JtID0gZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybTsKICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm0gPSBQSVhJLm1hdDMuY3JlYXRlKCk7Ly9zdGhpcy5pbmRldGl0eU1hdHJpeDsKICAgIC8vIG1vZGlmeSB0byBmbGlwLi4uCiAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzRdID0gLTE7CiAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdID0gdGhpcy5wcm9qZWN0aW9uLnkgKiAtMjsKCiAgICBpZihwb3NpdGlvbikKICAgIHsKICAgICAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzJdID0gcG9zaXRpb24ueDsKICAgICAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdIC09IHBvc2l0aW9uLnk7CiAgICB9CgogICAgUElYSS52aXNpYmxlQ291bnQrKzsKICAgIGRpc3BsYXlPYmplY3QudmNvdW50ID0gUElYSS52aXNpYmxlQ291bnQ7CgogICAgZm9yKHZhciBpPTAsaj1jaGlsZHJlbi5sZW5ndGg7IGk8ajsgaSsrKQogICAgewogICAgICAgIGNoaWxkcmVuW2ldLnVwZGF0ZVRyYW5zZm9ybSgpOwogICAgfQoKICAgIHZhciByZW5kZXJHcm91cCA9IGRpc3BsYXlPYmplY3QuX19yZW5kZXJHcm91cDsKCiAgICBpZihyZW5kZXJHcm91cCkKICAgIHsKICAgICAgICBpZihkaXNwbGF5T2JqZWN0ID09PSByZW5kZXJHcm91cC5yb290KQogICAgICAgIHsKICAgICAgICAgICAgcmVuZGVyR3JvdXAucmVuZGVyKHRoaXMucHJvamVjdGlvbiwgdGhpcy5nbEZyYW1lYnVmZmVyKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmVuZGVyR3JvdXAucmVuZGVyU3BlY2lmaWMoZGlzcGxheU9iamVjdCwgdGhpcy5wcm9qZWN0aW9uLCB0aGlzLmdsRnJhbWVidWZmZXIpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBpZighdGhpcy5yZW5kZXJHcm91cCl0aGlzLnJlbmRlckdyb3VwID0gbmV3IFBJWEkuV2ViR0xSZW5kZXJHcm91cChnbCk7CiAgICAgICAgdGhpcy5yZW5kZXJHcm91cC5zZXRSZW5kZXJhYmxlKGRpc3BsYXlPYmplY3QpOwogICAgICAgIHRoaXMucmVuZGVyR3JvdXAucmVuZGVyKHRoaXMucHJvamVjdGlvbiwgdGhpcy5nbEZyYW1lYnVmZmVyKTsKICAgIH0KCiAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtID0gb3JpZ2luYWxXb3JsZFRyYW5zZm9ybTsKfTsKCgovKioKICogVGhpcyBmdW5jdGlvbiB3aWxsIGRyYXcgdGhlIGRpc3BsYXkgb2JqZWN0IHRvIHRoZSB0ZXh0dXJlLgogKgogKiBAbWV0aG9kIHJlbmRlckNhbnZhcwogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIHJlbmRlciB0aGlzIHRleHR1cmUgb24KICogQHBhcmFtIGNsZWFyIHtCb29sZWFufSBJZiB0cnVlIHRoZSB0ZXh0dXJlIHdpbGwgYmUgY2xlYXJlZCBiZWZvcmUgdGhlIGRpc3BsYXlPYmplY3QgaXMgZHJhd24KICogQHByaXZhdGUKICovClBJWEkuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUucmVuZGVyQ2FudmFzID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcG9zaXRpb24sIGNsZWFyKQp7CiAgICB2YXIgY2hpbGRyZW4gPSBkaXNwbGF5T2JqZWN0LmNoaWxkcmVuOwoKICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm0gPSBQSVhJLm1hdDMuY3JlYXRlKCk7CgogICAgaWYocG9zaXRpb24pCiAgICB7CiAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsyXSA9IHBvc2l0aW9uLng7CiAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSA9IHBvc2l0aW9uLnk7CiAgICB9CgoKICAgIGZvcih2YXIgaSA9IDAsIGogPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICB7CiAgICAgICAgY2hpbGRyZW5baV0udXBkYXRlVHJhbnNmb3JtKCk7CiAgICB9CgogICAgaWYoY2xlYXIpIHRoaXMucmVuZGVyZXIuY29udGV4dC5jbGVhclJlY3QoMCwwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgogICAgdGhpcy5yZW5kZXJlci5yZW5kZXJEaXNwbGF5T2JqZWN0KGRpc3BsYXlPYmplY3QpOwoKICAgIHRoaXMucmVuZGVyZXIuY29udGV4dC5zZXRUcmFuc2Zvcm0oMSwwLDAsMSwwLDApOwoKICAgIC8vUElYSS50ZXh0dXJlc1RvVXBkYXRlLnB1c2godGhpcy5iYXNlVGV4dHVyZSk7Cn07CgovKioKICogaHR0cHM6Ly9naXRodWIuY29tL21yZG9vYi9ldmVudHRhcmdldC5qcy8KICogVEhhbmtTIG1yIERPb2IhCiAqLwoKLyoqCiAqIEFkZHMgZXZlbnQgZW1pdHRlciBmdW5jdGlvbmFsaXR5IHRvIGEgY2xhc3MKICoKICogQGNsYXNzIEV2ZW50VGFyZ2V0CiAqIEBleGFtcGxlCiAqICAgICAgZnVuY3Rpb24gTXlFbWl0dGVyKCkgewogKiAgICAgICAgICBQSVhJLkV2ZW50VGFyZ2V0LmNhbGwodGhpcyk7IC8vbWl4ZXMgaW4gZXZlbnQgdGFyZ2V0IHN0dWZmCiAqICAgICAgfQogKgogKiAgICAgIHZhciBlbSA9IG5ldyBNeUVtaXR0ZXIoKTsKICogICAgICBlbS5lbWl0KHsgdHlwZTogJ2V2ZW50TmFtZScsIGRhdGE6ICdzb21lIGRhdGEnIH0pOwogKi8KUElYSS5FdmVudFRhcmdldCA9IGZ1bmN0aW9uICgpIHsKCiAgICB2YXIgbGlzdGVuZXJzID0ge307CgogICAgdGhpcy5hZGRFdmVudExpc3RlbmVyID0gdGhpcy5vbiA9IGZ1bmN0aW9uICggdHlwZSwgbGlzdGVuZXIgKSB7CgoKICAgICAgICBpZiAoIGxpc3RlbmVyc1sgdHlwZSBdID09PSB1bmRlZmluZWQgKSB7CgogICAgICAgICAgICBsaXN0ZW5lcnNbIHR5cGUgXSA9IFtdOwoKICAgICAgICB9CgogICAgICAgIGlmICggbGlzdGVuZXJzWyB0eXBlIF0uaW5kZXhPZiggbGlzdGVuZXIgKSA9PT0gLSAxICkgewoKICAgICAgICAgICAgbGlzdGVuZXJzWyB0eXBlIF0ucHVzaCggbGlzdGVuZXIgKTsKICAgICAgICB9CgogICAgfTsKCiAgICB0aGlzLmRpc3BhdGNoRXZlbnQgPSB0aGlzLmVtaXQgPSBmdW5jdGlvbiAoIGV2ZW50ICkgewoKICAgICAgICBpZiAoICFsaXN0ZW5lcnNbIGV2ZW50LnR5cGUgXSB8fCAhbGlzdGVuZXJzWyBldmVudC50eXBlIF0ubGVuZ3RoICkgewoKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICB9CgogICAgICAgIGZvcih2YXIgaSA9IDAsIGwgPSBsaXN0ZW5lcnNbIGV2ZW50LnR5cGUgXS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCiAgICAgICAgICAgIGxpc3RlbmVyc1sgZXZlbnQudHlwZSBdWyBpIF0oIGV2ZW50ICk7CgogICAgICAgIH0KCiAgICB9OwoKICAgIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IHRoaXMub2ZmID0gZnVuY3Rpb24gKCB0eXBlLCBsaXN0ZW5lciApIHsKCiAgICAgICAgdmFyIGluZGV4ID0gbGlzdGVuZXJzWyB0eXBlIF0uaW5kZXhPZiggbGlzdGVuZXIgKTsKCiAgICAgICAgaWYgKCBpbmRleCAhPT0gLSAxICkgewoKICAgICAgICAgICAgbGlzdGVuZXJzWyB0eXBlIF0uc3BsaWNlKCBpbmRleCwgMSApOwoKICAgICAgICB9CgogICAgfTsKCgl0aGlzLnJlbW92ZUFsbEV2ZW50TGlzdGVuZXJzID0gZnVuY3Rpb24oIHR5cGUgKSB7CgkJdmFyIGEgPSBsaXN0ZW5lcnNbdHlwZV07CgkJaWYgKGEpCgkJCWEubGVuZ3RoID0gMDsKCX07Cn07CgovKgogICAgUG9seUsgbGlicmFyeQogICAgdXJsOiBodHRwOi8vcG9seWsuaXZhbmsubmV0CiAgICBSZWxlYXNlZCB1bmRlciBNSVQgbGljZW5jZS4KCiAgICBDb3B5cmlnaHQgKGMpIDIwMTIgSXZhbiBLdWNraXIKCiAgICBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbgogICAgb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24KICAgIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQKICAgIHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLAogICAgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICAgIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZQogICAgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcKICAgIGNvbmRpdGlvbnM6CgogICAgVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUKICAgIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoKICAgIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELAogICAgRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTCiAgICBPRiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORAogICAgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQKICAgIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLAogICAgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HCiAgICBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SCiAgICBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgogICAgVGhpcyBpcyBhbiBhbWF6aW5nIGxpYiEKCiAgICBzbGlnaHRseSBtb2RpZmllZCBieSBtYXQgZ3JvdmVzIChtYXRncm92ZXMuY29tKTsKKi8KClBJWEkuUG9seUsgPSB7fTsKCi8qKgogKiBUcmlhbmd1bGF0ZXMgc2hhcGVzIGZvciB3ZWJHTCBncmFwaGljIGZpbGxzCiAqCiAqIEBtZXRob2QgVHJpYW5ndWxhdGUKICogQG5hbWVzcGFjZSBQb2x5SwogKiBAY29uc3RydWN0b3IKICovClBJWEkuUG9seUsuVHJpYW5ndWxhdGUgPSBmdW5jdGlvbihwKQp7CiAgICB2YXIgc2lnbiA9IHRydWU7CgogICAgdmFyIG4gPSBwLmxlbmd0aCA+PiAxOwogICAgaWYobiA8IDMpIHJldHVybiBbXTsKCiAgICB2YXIgdGdzID0gW107CiAgICB2YXIgYXZsID0gW107CiAgICBmb3IodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSBhdmwucHVzaChpKTsKCiAgICBpID0gMDsKICAgIHZhciBhbCA9IG47CiAgICB3aGlsZShhbCA+IDMpCiAgICB7CiAgICAgICAgdmFyIGkwID0gYXZsWyhpKzApJWFsXTsKICAgICAgICB2YXIgaTEgPSBhdmxbKGkrMSklYWxdOwogICAgICAgIHZhciBpMiA9IGF2bFsoaSsyKSVhbF07CgogICAgICAgIHZhciBheCA9IHBbMippMF0sICBheSA9IHBbMippMCsxXTsKICAgICAgICB2YXIgYnggPSBwWzIqaTFdLCAgYnkgPSBwWzIqaTErMV07CiAgICAgICAgdmFyIGN4ID0gcFsyKmkyXSwgIGN5ID0gcFsyKmkyKzFdOwoKICAgICAgICB2YXIgZWFyRm91bmQgPSBmYWxzZTsKICAgICAgICBpZihQSVhJLlBvbHlLLl9jb252ZXgoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgc2lnbikpCiAgICAgICAgewogICAgICAgICAgICBlYXJGb3VuZCA9IHRydWU7CiAgICAgICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCBhbDsgaisrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdmkgPSBhdmxbal07CiAgICAgICAgICAgICAgICBpZih2aSA9PT0gaTAgfHwgdmkgPT09IGkxIHx8IHZpID09PSBpMikgY29udGludWU7CgogICAgICAgICAgICAgICAgaWYoUElYSS5Qb2x5Sy5fUG9pbnRJblRyaWFuZ2xlKHBbMip2aV0sIHBbMip2aSsxXSwgYXgsIGF5LCBieCwgYnksIGN4LCBjeSkpIHsKICAgICAgICAgICAgICAgICAgICBlYXJGb3VuZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZihlYXJGb3VuZCkKICAgICAgICB7CiAgICAgICAgICAgIHRncy5wdXNoKGkwLCBpMSwgaTIpOwogICAgICAgICAgICBhdmwuc3BsaWNlKChpKzEpJWFsLCAxKTsKICAgICAgICAgICAgYWwtLTsKICAgICAgICAgICAgaSA9IDA7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoaSsrID4gMyphbCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIG5lZWQgdG8gZmxpcCBmbGlwIHJldmVyc2UgaXQhCiAgICAgICAgICAgIC8vIHJlc2V0IQogICAgICAgICAgICBpZihzaWduKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0Z3MgPSBbXTsKICAgICAgICAgICAgICAgIGF2bCA9IFtdOwogICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbjsgaSsrKSBhdmwucHVzaChpKTsKCiAgICAgICAgICAgICAgICBpID0gMDsKICAgICAgICAgICAgICAgIGFsID0gbjsKCiAgICAgICAgICAgICAgICBzaWduID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coIlBJWEkgV2FybmluZzogc2hhcGUgdG9vIGNvbXBsZXggdG8gZmlsbCIpOwogICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHRncy5wdXNoKGF2bFswXSwgYXZsWzFdLCBhdmxbMl0pOwogICAgcmV0dXJuIHRnczsKfTsKCi8qKgogKiBDaGVja3MgaWYgYSBwb2ludCBpcyB3aXRoaW4gYSB0cmlhbmdsZQogKgogKiBAY2xhc3MgX1BvaW50SW5UcmlhbmdsZQogKiBAbmFtZXNwYWNlIFBvbHlLCiAqIEBwcml2YXRlCiAqLwpQSVhJLlBvbHlLLl9Qb2ludEluVHJpYW5nbGUgPSBmdW5jdGlvbihweCwgcHksIGF4LCBheSwgYngsIGJ5LCBjeCwgY3kpCnsKICAgIHZhciB2MHggPSBjeC1heDsKICAgIHZhciB2MHkgPSBjeS1heTsKICAgIHZhciB2MXggPSBieC1heDsKICAgIHZhciB2MXkgPSBieS1heTsKICAgIHZhciB2MnggPSBweC1heDsKICAgIHZhciB2MnkgPSBweS1heTsKCiAgICB2YXIgZG90MDAgPSB2MHgqdjB4K3YweSp2MHk7CiAgICB2YXIgZG90MDEgPSB2MHgqdjF4K3YweSp2MXk7CiAgICB2YXIgZG90MDIgPSB2MHgqdjJ4K3YweSp2Mnk7CiAgICB2YXIgZG90MTEgPSB2MXgqdjF4K3YxeSp2MXk7CiAgICB2YXIgZG90MTIgPSB2MXgqdjJ4K3YxeSp2Mnk7CgogICAgdmFyIGludkRlbm9tID0gMSAvIChkb3QwMCAqIGRvdDExIC0gZG90MDEgKiBkb3QwMSk7CiAgICB2YXIgdSA9IChkb3QxMSAqIGRvdDAyIC0gZG90MDEgKiBkb3QxMikgKiBpbnZEZW5vbTsKICAgIHZhciB2ID0gKGRvdDAwICogZG90MTIgLSBkb3QwMSAqIGRvdDAyKSAqIGludkRlbm9tOwoKICAgIC8vIENoZWNrIGlmIHBvaW50IGlzIGluIHRyaWFuZ2xlCiAgICByZXR1cm4gKHUgPj0gMCkgJiYgKHYgPj0gMCkgJiYgKHUgKyB2IDwgMSk7Cn07CgovKioKICogQ2hlY2tzIGlmIGEgc2hhcGUgaXMgY29udmV4CiAqCiAqIEBjbGFzcyBfY29udmV4CiAqIEBuYW1lc3BhY2UgUG9seUsKICogQHByaXZhdGUKICovClBJWEkuUG9seUsuX2NvbnZleCA9IGZ1bmN0aW9uKGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHNpZ24pCnsKICAgIHJldHVybiAoKGF5LWJ5KSooY3gtYngpICsgKGJ4LWF4KSooY3ktYnkpID49IDApID09PSBzaWduOwp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQSBDYW1lcmEgaXMgeW91ciB2aWV3IGludG8gdGhlIGdhbWUgd29ybGQuIEl0IGhhcyBhIHBvc2l0aW9uIGFuZCBzaXplIGFuZCByZW5kZXJzIG9ubHkgdGhvc2Ugb2JqZWN0cyB3aXRoaW4gaXRzIGZpZWxkIG9mIHZpZXcuCiogVGhlIGdhbWUgYXV0b21hdGljYWxseSBjcmVhdGVzIGEgc2luZ2xlIFN0YWdlIHNpemVkIGNhbWVyYSBvbiBib290LiBNb3ZlIHRoZSBjYW1lcmEgYXJvdW5kIHRoZSB3b3JsZCB3aXRoIFBoYXNlci5DYW1lcmEueC95CioKKiBAY2xhc3MgUGhhc2VyLkNhbWVyYQoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBHYW1lIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge251bWJlcn0gaWQgLSBOb3QgYmVpbmcgdXNlZCBhdCB0aGUgbW9tZW50LCB3aWxsIGJlIHdoZW4gUGhhc2VyIHN1cHBvcnRzIG11bHRpcGxlIGNhbWVyYQoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gUG9zaXRpb24gb2YgdGhlIGNhbWVyYSBvbiB0aGUgWCBheGlzCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBQb3NpdGlvbiBvZiB0aGUgY2FtZXJhIG9uIHRoZSBZIGF4aXMKKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIHZpZXcgcmVjdGFuZ2xlCiogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIHZpZXcgcmVjdGFuZ2xlCiovClBoYXNlci5DYW1lcmEgPSBmdW5jdGlvbiAoZ2FtZSwgaWQsIHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Xb3JsZH0gd29ybGQgLSBBIHJlZmVyZW5jZSB0byB0aGUgZ2FtZSB3b3JsZC4KICAgICovCiAgICB0aGlzLndvcmxkID0gZ2FtZS53b3JsZDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGlkIC0gUmVzZXJ2ZWQgZm9yIGZ1dHVyZSBtdWx0aXBsZSBjYW1lcmEgc2V0LXVwcy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlkID0gMDsKCiAgICAvKioKICAgICogQ2FtZXJhIHZpZXcuIAogICAgKiBUaGUgdmlldyBpbnRvIHRoZSB3b3JsZCB3ZSB3aXNoIHRvIHJlbmRlciAoYnkgZGVmYXVsdCB0aGUgZ2FtZSBkaW1lbnNpb25zKS4KICAgICogVGhlIHgveSB2YWx1ZXMgYXJlIGluIHdvcmxkIGNvb3JkaW5hdGVzLCBub3Qgc2NyZWVuIGNvb3JkaW5hdGVzLCB0aGUgd2lkdGgvaGVpZ2h0IGlzIGhvdyBtYW55IHBpeGVscyB0byByZW5kZXIuCiAgICAqIE9iamVjdHMgb3V0c2lkZSBvZiB0aGlzIHZpZXcgYXJlIG5vdCByZW5kZXJlZCBpZiBzZXQgdG8gY2FtZXJhIGN1bGwuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gdmlldwogICAgKi8KICAgIHRoaXMudmlldyA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKHgsIHksIHdpZHRoLCBoZWlnaHQpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IHNjcmVlblZpZXcgLSBVc2VkIGJ5IFNwcml0ZXMgdG8gd29yayBvdXQgQ2FtZXJhIGN1bGxpbmcuCiAgICAqLwogICAgdGhpcy5zY3JlZW5WaWV3ID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoeCwgeSwgd2lkdGgsIGhlaWdodCk7CgogICAgLyoqCiAgICAqIFRoZSBDYW1lcmEgaXMgYm91bmQgdG8gdGhpcyBSZWN0YW5nbGUgYW5kIGNhbm5vdCBtb3ZlIG91dHNpZGUgb2YgaXQuIEJ5IGRlZmF1bHQgaXQgaXMgZW5hYmxlZCBhbmQgc2V0IHRvIHRoZSBzaXplIG9mIHRoZSBXb3JsZC4KICAgICogVGhlIFJlY3RhbmdsZSBjYW4gYmUgbG9jYXRlZCBhbnl3aGVyZSBpbiB0aGUgd29ybGQgYW5kIHVwZGF0ZWQgYXMgb2Z0ZW4gYXMgeW91IGxpa2UuIElmIHlvdSBkb24ndCB3aXNoIHRoZSBDYW1lcmEgdG8gYmUgYm91bmQKICAgICogYXQgYWxsIHRoZW4gc2V0IHRoaXMgdG8gbnVsbC4gVGhlIHZhbHVlcyBjYW4gYmUgYW55dGhpbmcgYW5kIGFyZSBpbiBXb3JsZCBjb29yZGluYXRlcywgd2l0aCAwLDAgYmVpbmcgdGhlIGNlbnRlciBvZiB0aGUgd29ybGQuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gYm91bmRzIC0gVGhlIFJlY3RhbmdsZSBpbiB3aGljaCB0aGUgQ2FtZXJhIGlzIGJvdW5kZWQuIFNldCB0byBudWxsIHRvIGFsbG93IGZvciBtb3ZlbWVudCBhbnl3aGVyZS4KICAgICovCiAgICB0aGlzLmJvdW5kcyA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKHgsIHksIHdpZHRoLCBoZWlnaHQpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IGRlYWR6b25lIC0gTW92aW5nIGluc2lkZSB0aGlzIFJlY3RhbmdsZSB3aWxsIG5vdCBjYXVzZSBjYW1lcmEgbW92aW5nLgogICAgKi8KICAgIHRoaXMuZGVhZHpvbmUgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHZpc2libGUgLSBXaGV0aGVyIHRoaXMgY2FtZXJhIGlzIHZpc2libGUgb3Igbm90LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudmlzaWJsZSA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYXRMaW1pdCAtIFdoZXRoZXIgdGhpcyBjYW1lcmEgaXMgZmx1c2ggd2l0aCB0aGUgV29ybGQgQm91bmRzIG9yIG5vdC4KICAgICovCiAgICB0aGlzLmF0TGltaXQgPSB7IHg6IGZhbHNlLCB5OiBmYWxzZSB9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TcHJpdGV9IHRhcmdldCAtIElmIHRoZSBjYW1lcmEgaXMgdHJhY2tpbmcgYSBTcHJpdGUsIHRoaXMgaXMgYSByZWZlcmVuY2UgdG8gaXQsIG90aGVyd2lzZSBudWxsLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGFyZ2V0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGVkZ2UgLSBFZGdlIHByb3BlcnR5LgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX2VkZ2UgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BJWEkuRGlzcGxheU9iamVjdH0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byB3aGljaCBhbGwgZ2FtZSBvYmplY3RzIGFyZSBhZGRlZC4gU2V0IGJ5IFdvcmxkLmJvb3QKICAgICovCiAgICB0aGlzLmRpc3BsYXlPYmplY3QgPSBudWxsOwogICAgCn07CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuQ2FtZXJhLkZPTExPV19MT0NLT04gPSAwOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkNhbWVyYS5GT0xMT1dfUExBVEZPUk1FUiA9IDE7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuQ2FtZXJhLkZPTExPV19UT1BET1dOID0gMjsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5DYW1lcmEuRk9MTE9XX1RPUERPV05fVElHSFQgPSAzOwoKUGhhc2VyLkNhbWVyYS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFRlbGxzIHRoaXMgY2FtZXJhIHdoaWNoIHNwcml0ZSB0byBmb2xsb3cuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbWVyYSNmb2xsb3cKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSB0YXJnZXQgLSBUaGUgb2JqZWN0IHlvdSB3YW50IHRoZSBjYW1lcmEgdG8gdHJhY2suIFNldCB0byBudWxsIHRvIG5vdCBmb2xsb3cgYW55dGhpbmcuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3R5bGVdIExldmVyYWdlIG9uZSBvZiB0aGUgZXhpc3RpbmcgImRlYWR6b25lIiBwcmVzZXRzLiBJZiB5b3UgdXNlIGEgY3VzdG9tIGRlYWR6b25lLCBpZ25vcmUgdGhpcyBwYXJhbWV0ZXIgYW5kIG1hbnVhbGx5IHNwZWNpZnkgdGhlIGRlYWR6b25lIGFmdGVyIGNhbGxpbmcgZm9sbG93KCkuCiAgICAqLwogICAgZm9sbG93OiBmdW5jdGlvbiAodGFyZ2V0LCBzdHlsZSkgewoKICAgICAgICBpZiAodHlwZW9mIHN0eWxlID09PSAidW5kZWZpbmVkIikgeyBzdHlsZSA9IFBoYXNlci5DYW1lcmEuRk9MTE9XX0xPQ0tPTjsgfQoKICAgICAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKCiAgICAgICAgdmFyIGhlbHBlcjsKCiAgICAgICAgc3dpdGNoIChzdHlsZSkgewoKICAgICAgICAgICAgY2FzZSBQaGFzZXIuQ2FtZXJhLkZPTExPV19QTEFURk9STUVSOgogICAgICAgICAgICAgICAgdmFyIHcgPSB0aGlzLndpZHRoIC8gODsKICAgICAgICAgICAgICAgIHZhciBoID0gdGhpcy5oZWlnaHQgLyAzOwogICAgICAgICAgICAgICAgdGhpcy5kZWFkem9uZSA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKCh0aGlzLndpZHRoIC0gdykgLyAyLCAodGhpcy5oZWlnaHQgLSBoKSAvIDIgLSBoICogMC4yNSwgdywgaCk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgUGhhc2VyLkNhbWVyYS5GT0xMT1dfVE9QRE9XTjoKICAgICAgICAgICAgICAgIGhlbHBlciA9IE1hdGgubWF4KHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KSAvIDQ7CiAgICAgICAgICAgICAgICB0aGlzLmRlYWR6b25lID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoKHRoaXMud2lkdGggLSBoZWxwZXIpIC8gMiwgKHRoaXMuaGVpZ2h0IC0gaGVscGVyKSAvIDIsIGhlbHBlciwgaGVscGVyKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSBQaGFzZXIuQ2FtZXJhLkZPTExPV19UT1BET1dOX1RJR0hUOgogICAgICAgICAgICAgICAgaGVscGVyID0gTWF0aC5tYXgodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpIC8gODsKICAgICAgICAgICAgICAgIHRoaXMuZGVhZHpvbmUgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgodGhpcy53aWR0aCAtIGhlbHBlcikgLyAyLCAodGhpcy5oZWlnaHQgLSBoZWxwZXIpIC8gMiwgaGVscGVyLCBoZWxwZXIpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIFBoYXNlci5DYW1lcmEuRk9MTE9XX0xPQ0tPTjoKICAgICAgICAgICAgICAgIHRoaXMuZGVhZHpvbmUgPSBudWxsOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhpcy5kZWFkem9uZSA9IG51bGw7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogTW92ZSB0aGUgY2FtZXJhIGZvY3VzIG9uIGEgZGlzcGxheSBvYmplY3QgaW5zdGFudGx5LgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjZm9jdXNPbgogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byBmb2N1cyB0aGUgY2FtZXJhIG9uLiBNdXN0IGhhdmUgdmlzaWJsZSB4L3kgcHJvcGVydGllcy4KICAgICovCiAgICBmb2N1c09uOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCkgewoKICAgICAgICB0aGlzLnNldFBvc2l0aW9uKE1hdGgucm91bmQoZGlzcGxheU9iamVjdC54IC0gdGhpcy52aWV3LmhhbGZXaWR0aCksIE1hdGgucm91bmQoZGlzcGxheU9iamVjdC55IC0gdGhpcy52aWV3LmhhbGZIZWlnaHQpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNb3ZlIHRoZSBjYW1lcmEgZm9jdXMgb24gYSBsb2NhdGlvbiBpbnN0YW50bHkuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbWVyYSNmb2N1c09uWFkKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24uCiAgICAqLwogICAgZm9jdXNPblhZOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnNldFBvc2l0aW9uKE1hdGgucm91bmQoeCAtIHRoaXMudmlldy5oYWxmV2lkdGgpLCBNYXRoLnJvdW5kKHkgLSB0aGlzLnZpZXcuaGFsZkhlaWdodCkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZSBmb2N1c2luZyBhbmQgc2Nyb2xsaW5nLgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjdXBkYXRlCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnRhcmdldCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVGFyZ2V0KCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5ib3VuZHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNoZWNrQm91bmRzKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmRpc3BsYXlPYmplY3QucG9zaXRpb24ueCA9IC10aGlzLnZpZXcueDsKICAgICAgICB0aGlzLmRpc3BsYXlPYmplY3QucG9zaXRpb24ueSA9IC10aGlzLnZpZXcueTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FtZXJhI3VwZGF0ZVRhcmdldAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHVwZGF0ZVRhcmdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5kZWFkem9uZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2VkZ2UgPSB0aGlzLnRhcmdldC54IC0gdGhpcy5kZWFkem9uZS54OwoKICAgICAgICAgICAgaWYgKHRoaXMudmlldy54ID4gdGhpcy5fZWRnZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy52aWV3LnggPSB0aGlzLl9lZGdlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9lZGdlID0gdGhpcy50YXJnZXQueCArIHRoaXMudGFyZ2V0LndpZHRoIC0gdGhpcy5kZWFkem9uZS54IC0gdGhpcy5kZWFkem9uZS53aWR0aDsKCiAgICAgICAgICAgIGlmICh0aGlzLnZpZXcueCA8IHRoaXMuX2VkZ2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlldy54ID0gdGhpcy5fZWRnZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fZWRnZSA9IHRoaXMudGFyZ2V0LnkgLSB0aGlzLmRlYWR6b25lLnk7CgogICAgICAgICAgICBpZiAodGhpcy52aWV3LnkgPiB0aGlzLl9lZGdlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnZpZXcueSA9IHRoaXMuX2VkZ2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2VkZ2UgPSB0aGlzLnRhcmdldC55ICsgdGhpcy50YXJnZXQuaGVpZ2h0IC0gdGhpcy5kZWFkem9uZS55IC0gdGhpcy5kZWFkem9uZS5oZWlnaHQ7CgogICAgICAgICAgICBpZiAodGhpcy52aWV3LnkgPCB0aGlzLl9lZGdlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnZpZXcueSA9IHRoaXMuX2VkZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mb2N1c09uWFkodGhpcy50YXJnZXQueCwgdGhpcy50YXJnZXQueSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZSB0aGUgQ2FtZXJhIGJvdW5kcyB0byBtYXRjaCB0aGUgZ2FtZSB3b3JsZC4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FtZXJhI3NldEJvdW5kc1RvV29ybGQKICAgICovCiAgICBzZXRCb3VuZHNUb1dvcmxkOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuYm91bmRzLnNldFRvKHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMueCwgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy55LCB0aGlzLmdhbWUud29ybGQuYm91bmRzLndpZHRoLCB0aGlzLmdhbWUud29ybGQuYm91bmRzLmhlaWdodCk7CgogICAgfSwKCiAgICAvKioKICAgICogTWV0aG9kIGNhbGxlZCB0byBlbnN1cmUgdGhlIGNhbWVyYSBkb2Vzbid0IHZlbnR1cmUgb3V0c2lkZSBvZiB0aGUgZ2FtZSB3b3JsZC4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FtZXJhI2NoZWNrV29ybGRCb3VuZHMKICAgICovCiAgICBjaGVja0JvdW5kczogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmF0TGltaXQueCA9IGZhbHNlOwogICAgICAgIHRoaXMuYXRMaW1pdC55ID0gZmFsc2U7CgogICAgICAgIC8vICBNYWtlIHN1cmUgd2UgZGlkbid0IGdvIG91dHNpZGUgdGhlIGNhbWVyYXMgYm91bmRzCiAgICAgICAgaWYgKHRoaXMudmlldy54IDwgdGhpcy5ib3VuZHMueCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYXRMaW1pdC54ID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy52aWV3LnggPSB0aGlzLmJvdW5kcy54OwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudmlldy5yaWdodCA+IHRoaXMuYm91bmRzLnJpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hdExpbWl0LnggPSB0cnVlOwogICAgICAgICAgICB0aGlzLnZpZXcueCA9IHRoaXMuYm91bmRzLnJpZ2h0IC0gdGhpcy53aWR0aDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnZpZXcueSA8IHRoaXMuYm91bmRzLnRvcCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYXRMaW1pdC55ID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy52aWV3LnkgPSB0aGlzLmJvdW5kcy50b3A7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy52aWV3LmJvdHRvbSA+IHRoaXMuYm91bmRzLmJvdHRvbSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYXRMaW1pdC55ID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy52aWV3LnkgPSB0aGlzLmJvdW5kcy5ib3R0b20gLSB0aGlzLmhlaWdodDsKICAgICAgICB9CgogICAgICAgIHRoaXMudmlldy5mbG9vcigpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEEgaGVscGVyIGZ1bmN0aW9uIHRvIHNldCBib3RoIHRoZSBYIGFuZCBZIHByb3BlcnRpZXMgb2YgdGhlIGNhbWVyYSBhdCBvbmNlCiAgICAqIHdpdGhvdXQgaGF2aW5nIHRvIHVzZSBnYW1lLmNhbWVyYS54IGFuZCBnYW1lLmNhbWVyYS55LgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FtZXJhI3NldFBvc2l0aW9uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uLgogICAgKi8KICAgIHNldFBvc2l0aW9uOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnZpZXcueCA9IHg7CiAgICAgICAgdGhpcy52aWV3LnkgPSB5OwoKICAgICAgICBpZiAodGhpcy5ib3VuZHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNoZWNrQm91bmRzKCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIHNpemUgb2YgdGhlIHZpZXcgcmVjdGFuZ2xlIGdpdmVuIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IGluIHBhcmFtZXRlcnMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjc2V0U2l6ZQogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgZGVzaXJlZCB3aWR0aC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBkZXNpcmVkIGhlaWdodC4KICAgICovCiAgICBzZXRTaXplOiBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewoKICAgICAgICB0aGlzLnZpZXcud2lkdGggPSB3aWR0aDsKICAgICAgICB0aGlzLnZpZXcuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgIH0KCn07CgpQaGFzZXIuQ2FtZXJhLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5DYW1lcmE7CgovKioKKiBUaGUgQ2FtZXJhcyB4IGNvb3JkaW5hdGUuIFRoaXMgdmFsdWUgaXMgYXV0b21hdGljYWxseSBjbGFtcGVkIGlmIGl0IGZhbGxzIG91dHNpZGUgb2YgdGhlIFdvcmxkIGJvdW5kcy4KKiBAbmFtZSBQaGFzZXIuQ2FtZXJhI3gKKiBAcHJvcGVydHkge251bWJlcn0geCAtIEdldHMgb3Igc2V0cyB0aGUgY2FtZXJhcyB4IHBvc2l0aW9uLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNhbWVyYS5wcm90b3R5cGUsICJ4IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnZpZXcueDsKICAgIH0sCiAKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHRoaXMudmlldy54ID0gdmFsdWU7CgogICAgICAgIGlmICh0aGlzLmJvdW5kcykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tCb3VuZHMoKTsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBDYW1lcmFzIHkgY29vcmRpbmF0ZS4gVGhpcyB2YWx1ZSBpcyBhdXRvbWF0aWNhbGx5IGNsYW1wZWQgaWYgaXQgZmFsbHMgb3V0c2lkZSBvZiB0aGUgV29ybGQgYm91bmRzLgoqIEBuYW1lIFBoYXNlci5DYW1lcmEjeQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gR2V0cyBvciBzZXRzIHRoZSBjYW1lcmFzIHkgcG9zaXRpb24uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2FtZXJhLnByb3RvdHlwZSwgInkiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnZpZXcueTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdGhpcy52aWV3LnkgPSB2YWx1ZTsKCiAgICAgICAgaWYgKHRoaXMuYm91bmRzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jaGVja0JvdW5kcygpOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIENhbWVyYXMgd2lkdGguIEJ5IGRlZmF1bHQgdGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgR2FtZSBzaXplIGFuZCBzaG91bGQgbm90IGJlIGFkanVzdGVkIGZvciBub3cuCiogQG5hbWUgUGhhc2VyLkNhbWVyYSN3aWR0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIEdldHMgb3Igc2V0cyB0aGUgY2FtZXJhcyB3aWR0aC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DYW1lcmEucHJvdG90eXBlLCAid2lkdGgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmlldy53aWR0aDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLnZpZXcud2lkdGggPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIENhbWVyYXMgaGVpZ2h0LiBCeSBkZWZhdWx0IHRoaXMgaXMgdGhlIHNhbWUgYXMgdGhlIEdhbWUgc2l6ZSBhbmQgc2hvdWxkIG5vdCBiZSBhZGp1c3RlZCBmb3Igbm93LgoqIEBuYW1lIFBoYXNlci5DYW1lcmEjaGVpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIEdldHMgb3Igc2V0cyB0aGUgY2FtZXJhcyBoZWlnaHQuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2FtZXJhLnByb3RvdHlwZSwgImhlaWdodCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy52aWV3LmhlaWdodDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLnZpZXcuaGVpZ2h0ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoaXMgaXMgYSBiYXNlIFN0YXRlIGNsYXNzIHdoaWNoIGNhbiBiZSBleHRlbmRlZCBpZiB5b3UgYXJlIGNyZWF0aW5nIHlvdXIgb3duIGdhbWUuCiogSXQgcHJvdmlkZXMgcXVpY2sgYWNjZXNzIHRvIGNvbW1vbiBmdW5jdGlvbnMgc3VjaCBhcyB0aGUgY2FtZXJhLCBjYWNoZSwgaW5wdXQsIG1hdGNoLCBzb3VuZCBhbmQgbW9yZS4KKgoqIEBjbGFzcyBQaGFzZXIuU3RhdGUKKiBAY29uc3RydWN0b3IKKi8KClBoYXNlci5TdGF0ZSA9IGZ1bmN0aW9uICgpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lT2JqZWN0RmFjdG9yeX0gYWRkIC0gUmVmZXJlbmNlIHRvIHRoZSBHYW1lT2JqZWN0RmFjdG9yeS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFkZCA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5DYW1lcmF9IGNhbWVyYSAtIEEgaGFuZHkgcmVmZXJlbmNlIHRvIHdvcmxkLmNhbWVyYS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNhbWVyYSA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5DYWNoZX0gY2FjaGUgLSBSZWZlcmVuY2UgdG8gdGhlIGFzc2V0cyBjYWNoZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNhY2hlID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLklucHV0fSBpbnB1dCAtIFJlZmVyZW5jZSB0byB0aGUgaW5wdXQgbWFuYWdlcgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaW5wdXQgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuTG9hZGVyfSBsb2FkIC0gUmVmZXJlbmNlIHRvIHRoZSBhc3NldHMgbG9hZGVyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubG9hZCA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5NYXRofSBtYXRoIC0gUmVmZXJlbmNlIHRvIHRoZSBtYXRoIGhlbHBlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1hdGggPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU291bmRNYW5hZ2VyfSBzb3VuZCAtIFJlZmVyZW5jZSB0byB0aGUgc291bmQgbWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNvdW5kID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlN0YWdlfSBzdGFnZSAtIFJlZmVyZW5jZSB0byB0aGUgc3RhZ2UuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zdGFnZSA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5UaW1lTWFuYWdlcn0gdGltZSAtIFJlZmVyZW5jZSB0byBnYW1lIGNsb2NrLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGltZSA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Ud2Vlbk1hbmFnZXJ9IHR3ZWVucyAtIFJlZmVyZW5jZSB0byB0aGUgdHdlZW4gbWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnR3ZWVucyA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Xb3JsZH0gd29ybGQgLSBSZWZlcmVuY2UgdG8gdGhlIHdvcmxkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMud29ybGQgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUGFydGljbGVzfSBwYXJ0aWNsZXMgLSBUaGUgUGFydGljbGUgTWFuYWdlciBmb3IgdGhlIGdhbWUuIEl0IGlzIGNhbGxlZCBkdXJpbmcgdGhlIGdhbWUgdXBkYXRlIGxvb3AgYW5kIGluIHR1cm4gdXBkYXRlcyBhbnkgRW1pdHRlcnMgYXR0YWNoZWQgdG8gaXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYXJ0aWNsZXMgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUGh5c2ljcy5QaHlzaWNzTWFuYWdlcn0gcGh5c2ljcyAtIFJlZmVyZW5jZSB0byB0aGUgcGh5c2ljcyBtYW5hZ2VyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGh5c2ljcyA9IG51bGw7Cgp9OwoKUGhhc2VyLlN0YXRlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogT3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gYWRkIHNvbWUgbG9hZCBvcGVyYXRpb25zLgogICAgKiBJZiB5b3UgbmVlZCB0byB1c2UgdGhlIGxvYWRlciwgeW91IG1heSBuZWVkIHRvIHVzZSB0aGVtIGhlcmUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZSNwcmVsb2FkCiAgICAqLwogICAgcHJlbG9hZDogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogUHV0IHVwZGF0ZSBsb2dpYyBoZXJlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGUjbG9hZFVwZGF0ZQogICAgKi8KICAgIGxvYWRVcGRhdGU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFB1dCByZW5kZXIgb3BlcmF0aW9ucyBoZXJlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGUjbG9hZFJlbmRlcgogICAgKi8KICAgIGxvYWRSZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBhZnRlciB0aGUgZ2FtZSBlbmdpbmUgc3VjY2Vzc2Z1bGx5IHN3aXRjaGVzIHN0YXRlcy4KICAgICogRmVlbCBmcmVlIHRvIGFkZCBhbnkgc2V0dXAgY29kZSBoZXJlIChkbyBub3QgbG9hZCBhbnl0aGluZyBoZXJlLCBvdmVycmlkZSBwcmVsb2FkKCkgaW5zdGVhZCkuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZSNjcmVhdGUKICAgICovCiAgICBjcmVhdGU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFB1dCB1cGRhdGUgbG9naWMgaGVyZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlI3VwZGF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogUHV0IHJlbmRlciBvcGVyYXRpb25zIGhlcmUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZSNyZW5kZXIKICAgICovCiAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFRoaXMgbWV0aG9kIHdpbGwgYmUgY2FsbGVkIHdoZW4gZ2FtZSBwYXVzZWQuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZSNwYXVzZWQKICAgICovCiAgICBwYXVzZWQ6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFRoaXMgbWV0aG9kIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIHN0YXRlIGlzIGRlc3Ryb3llZC4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGUjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgIH0KCn07CgpQaGFzZXIuU3RhdGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlN0YXRlOwoKLyoganNoaW50IG5ld2NhcDogZmFsc2UgKi8KCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBTdGF0ZSBNYW5hZ2VyIGlzIHJlc3BvbnNpYmxlIGZvciBsb2FkaW5nLCBzZXR0aW5nIHVwIGFuZCBzd2l0Y2hpbmcgZ2FtZSBzdGF0ZXMuCiogCiogQGNsYXNzIFBoYXNlci5TdGF0ZU1hbmFnZXIKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtQaGFzZXIuU3RhdGV8T2JqZWN0fSBbcGVuZGluZ1N0YXRlPW51bGxdIC0gQSBTdGF0ZSBvYmplY3QgdG8gc2VlZCB0aGUgbWFuYWdlciB3aXRoLgoqLwpQaGFzZXIuU3RhdGVNYW5hZ2VyID0gZnVuY3Rpb24gKGdhbWUsIHBlbmRpbmdTdGF0ZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtPYmplY3R9IHN0YXRlcyAtIFRoZSBvYmplY3QgY29udGFpbmluZyBQaGFzZXIuU3RhdGVzLgogICAgKi8KICAgIHRoaXMuc3RhdGVzID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlN0YXRlfSBfcGVuZGluZ1N0YXRlIC0gVGhlIHN0YXRlIHRvIGJlIHN3aXRjaGVkIHRvIGluIHRoZSBuZXh0IGZyYW1lLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3BlbmRpbmdTdGF0ZSA9IG51bGw7CgogICAgaWYgKHR5cGVvZiBwZW5kaW5nU3RhdGUgIT09ICd1bmRlZmluZWQnICYmIHBlbmRpbmdTdGF0ZSAhPT0gbnVsbCkKICAgIHsKICAgICAgICB0aGlzLl9wZW5kaW5nU3RhdGUgPSBwZW5kaW5nU3RhdGU7CiAgICB9CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX2NyZWF0ZWQgLSBGbGFnIHRoYXQgc2V0cyBpZiB0aGUgU3RhdGUgaGFzIGJlZW4gY3JlYXRlZCBvciBub3QuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fY3JlYXRlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gY3VycmVudCAtIFRoZSBjdXJyZW50IGFjdGl2ZSBTdGF0ZSBvYmplY3QgKGRlZmF1bHRzIHRvIG51bGwpLgogICAgKi8KICAgIHRoaXMuY3VycmVudCA9ICcnOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvbkluaXRDYWxsYmFjayAtIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgc3RhdGUgaXMgc3RhcnRlZCAoaS5lLiBzZXQgYXMgdGhlIGN1cnJlbnQgYWN0aXZlIHN0YXRlKS4KICAgICovCiAgICB0aGlzLm9uSW5pdENhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25QcmVsb2FkQ2FsbGJhY2sgLSBUaGlzIHdpbGwgYmUgY2FsbGVkIHdoZW4gaW5pdCBzdGF0ZXMgKGxvYWRpbmcgYXNzZXRzLi4uKS4KICAgICovCiAgICB0aGlzLm9uUHJlbG9hZENhbGxiYWNrID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uQ3JlYXRlQ2FsbGJhY2sgLSBUaGlzIHdpbGwgYmUgY2FsbGVkIHdoZW4gY3JlYXRlIHN0YXRlcyAoc2V0dXAgc3RhdGVzLi4uKS4KICAgICovCiAgICB0aGlzLm9uQ3JlYXRlQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvblVwZGF0ZUNhbGxiYWNrIC0gVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuIFN0YXRlIGlzIHVwZGF0ZWQsIHRoaXMgZG9lc24ndCBoYXBwZW4gZHVyaW5nIGxvYWQgKEBzZWUgb25Mb2FkVXBkYXRlQ2FsbGJhY2spLgogICAgKi8KICAgIHRoaXMub25VcGRhdGVDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uUmVuZGVyQ2FsbGJhY2sgLSBUaGlzIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIFN0YXRlIGlzIHJlbmRlcmVkLCB0aGlzIGRvZXNuJ3QgaGFwcGVuIGR1cmluZyBsb2FkIChzZWUgb25Mb2FkUmVuZGVyQ2FsbGJhY2spLgogICAgKi8KICAgIHRoaXMub25SZW5kZXJDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uUHJlUmVuZGVyQ2FsbGJhY2sgLSBUaGlzIHdpbGwgYmUgY2FsbGVkIGJlZm9yZSB0aGUgU3RhdGUgaXMgcmVuZGVyZWQgYW5kIGJlZm9yZSB0aGUgc3RhZ2UgaXMgY2xlYXJlZC4KICAgICovCiAgICB0aGlzLm9uUHJlUmVuZGVyQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvbkxvYWRVcGRhdGVDYWxsYmFjayAtIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgU3RhdGUgaXMgdXBkYXRlZCBidXQgb25seSBkdXJpbmcgdGhlIGxvYWQgcHJvY2Vzcy4KICAgICovCiAgICB0aGlzLm9uTG9hZFVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25Mb2FkUmVuZGVyQ2FsbGJhY2sgLSBUaGlzIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIFN0YXRlIGlzIHJlbmRlcmVkIGJ1dCBvbmx5IGR1cmluZyB0aGUgbG9hZCBwcm9jZXNzLgogICAgKi8KICAgIHRoaXMub25Mb2FkUmVuZGVyQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvblBhdXNlZENhbGxiYWNrIC0gVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBzdGF0ZSBpcyBwYXVzZWQuCiAgICAqLwogICAgdGhpcy5vblBhdXNlZENhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25TaHV0RG93bkNhbGxiYWNrIC0gVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBzdGF0ZSBpcyBzaHV0IGRvd24gKGkuZS4gc3dhcHBlZCB0byBhbm90aGVyIHN0YXRlKS4KICAgICovCiAgICB0aGlzLm9uU2h1dERvd25DYWxsYmFjayA9IG51bGw7CgoKfTsKClBoYXNlci5TdGF0ZU1hbmFnZXIucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBUaGUgQm9vdCBoYW5kbGVyIGlzIGNhbGxlZCBieSBQaGFzZXIuR2FtZSB3aGVuIGl0IGZpcnN0IHN0YXJ0cyB1cC4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI2Jvb3QKICAgICogQHByaXZhdGUKICAgICovCiAgICBib290OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuZ2FtZS5vblBhdXNlLmFkZCh0aGlzLnBhdXNlLCB0aGlzKTsKICAgICAgICB0aGlzLmdhbWUub25SZXN1bWUuYWRkKHRoaXMucmVzdW1lLCB0aGlzKTsKCiAgICAgICAgaWYgKHRoaXMuX3BlbmRpbmdTdGF0ZSAhPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5fcGVuZGluZ1N0YXRlID09PSAnc3RyaW5nJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFN0YXRlIHdhcyBhbHJlYWR5IGFkZGVkLCBzbyBqdXN0IHN0YXJ0IGl0CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0KHRoaXMuX3BlbmRpbmdTdGF0ZSwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuYWRkKCdkZWZhdWx0JywgdGhpcy5fcGVuZGluZ1N0YXRlLCB0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IFN0YXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjYWRkCiAgICAqIEBwYXJhbSBrZXkge3N0cmluZ30gLSBBIHVuaXF1ZSBrZXkgeW91IHVzZSB0byByZWZlcmVuY2UgdGhpcyBzdGF0ZSwgaS5lLiAiTWFpbk1lbnUiLCAiTGV2ZWwxIi4KICAgICogQHBhcmFtIHN0YXRlIHtTdGF0ZX0gLSBUaGUgc3RhdGUgeW91IHdhbnQgdG8gc3dpdGNoIHRvLgogICAgKiBAcGFyYW0gYXV0b1N0YXJ0IHtib29sZWFufSAtIFN0YXJ0IHRoZSBzdGF0ZSBpbW1lZGlhdGVseSBhZnRlciBjcmVhdGluZyBpdD8gKGRlZmF1bHQgdHJ1ZSkKICAgICovCiAgICBhZGQ6IGZ1bmN0aW9uIChrZXksIHN0YXRlLCBhdXRvU3RhcnQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBhdXRvU3RhcnQgPT09ICJ1bmRlZmluZWQiKSB7IGF1dG9TdGFydCA9IGZhbHNlOyB9CgogICAgICAgIHZhciBuZXdTdGF0ZTsKCiAgICAgICAgaWYgKHN0YXRlIGluc3RhbmNlb2YgUGhhc2VyLlN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgbmV3U3RhdGUgPSBzdGF0ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZW9mIHN0YXRlID09PSAnb2JqZWN0JykKICAgICAgICB7CiAgICAgICAgICAgIG5ld1N0YXRlID0gc3RhdGU7CiAgICAgICAgICAgIG5ld1N0YXRlLmdhbWUgPSB0aGlzLmdhbWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGVvZiBzdGF0ZSA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICB7CiAgICAgICAgICAgIG5ld1N0YXRlID0gbmV3IHN0YXRlKHRoaXMuZ2FtZSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0YXRlc1trZXldID0gbmV3U3RhdGU7CgogICAgICAgIGlmIChhdXRvU3RhcnQpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmlzQm9vdGVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0KGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9wZW5kaW5nU3RhdGUgPSBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBuZXdTdGF0ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBEZWxldGUgdGhlIGdpdmVuIHN0YXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjcmVtb3ZlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBIHVuaXF1ZSBrZXkgeW91IHVzZSB0byByZWZlcmVuY2UgdGhpcyBzdGF0ZSwgaS5lLiAiTWFpbk1lbnUiLCAiTGV2ZWwxIi4KICAgICovCiAgICByZW1vdmU6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuY3VycmVudCA9PSBrZXkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNhbGxiYWNrQ29udGV4dCA9IG51bGw7CgogICAgICAgICAgICB0aGlzLm9uSW5pdENhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5vblNodXREb3duQ2FsbGJhY2sgPSBudWxsOwoKICAgICAgICAgICAgdGhpcy5vblByZWxvYWRDYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgIHRoaXMub25Mb2FkUmVuZGVyQ2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICB0aGlzLm9uTG9hZFVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5vbkNyZWF0ZUNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5vblVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5vblJlbmRlckNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5vblBhdXNlZENhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5vbkRlc3Ryb3lDYWxsYmFjayA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgdGhpcy5zdGF0ZXNba2V5XTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdGFydCB0aGUgZ2l2ZW4gc3RhdGUKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI3N0YXJ0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUga2V5IG9mIHRoZSBzdGF0ZSB5b3Ugd2FudCB0byBzdGFydC4KICAgICogQHBhcmFtIHtib29sZWFufSBbY2xlYXJXb3JsZF0gLSBjbGVhciBldmVyeXRoaW5nIGluIHRoZSB3b3JsZD8gKERlZmF1bHQgdG8gdHJ1ZSkKICAgICogQHBhcmFtIHtib29sZWFufSBbY2xlYXJDYWNoZV0gLSBjbGVhciBhc3NldCBjYWNoZT8gKERlZmF1bHQgdG8gZmFsc2UgYW5kIE9OTFkgYXZhaWxhYmxlIHdoZW4gY2xlYXJXb3JsZD10cnVlKQogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoa2V5LCBjbGVhcldvcmxkLCBjbGVhckNhY2hlKSB7CgogICAgICAgIGlmICh0eXBlb2YgY2xlYXJXb3JsZCA9PT0gInVuZGVmaW5lZCIpIHsgY2xlYXJXb3JsZCA9IHRydWU7IH0KICAgICAgICBpZiAodHlwZW9mIGNsZWFyQ2FjaGUgPT09ICJ1bmRlZmluZWQiKSB7IGNsZWFyQ2FjaGUgPSBmYWxzZTsgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmlzQm9vdGVkID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BlbmRpbmdTdGF0ZSA9IGtleTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY2hlY2tTdGF0ZShrZXkpID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIEFscmVhZHkgZ290IGEgc3RhdGUgcnVubmluZz8KICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5vblNodXREb3duQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5nYW1lKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNsZWFyV29ybGQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS50d2VlbnMucmVtb3ZlQWxsKCk7CgogICAgICAgICAgICAgICAgdGhpcy5nYW1lLndvcmxkLmRlc3Ryb3koKTsKCiAgICAgICAgICAgICAgICBpZiAoY2xlYXJDYWNoZSA9PT0gdHJ1ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnNldEN1cnJlbnRTdGF0ZShrZXkpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMub25QcmVsb2FkQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUubG9hZC5yZXNldCgpOwogICAgICAgICAgICB0aGlzLm9uUHJlbG9hZENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CgogICAgICAgICAgICAvLyAgSXMgdGhlIGxvYWRlciBlbXB0eT8KICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5sb2FkLnRvdGFsUXVldWVkRmlsZXMoKSA9PT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmxvYWRDb21wbGV0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFN0YXJ0IHRoZSBsb2FkZXIgZ29pbmcgYXMgd2UgaGF2ZSBzb21ldGhpbmcgaW4gdGhlIHF1ZXVlCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUubG9hZC5zdGFydCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBObyBpbml0PyBUaGVuIHRoZXJlIHdhcyBub3RoaW5nIHRvIGxvYWQgZWl0aGVyCiAgICAgICAgICAgIHRoaXMuZ2FtZS5sb2FkQ29tcGxldGUoKTsKICAgICAgICB9CgogICAgfSwKICAgIAogICAgLyoqCiAgICAqIFVzZWQgYnkgb25Jbml0IGFuZCBvblNodXRkb3duIHdoZW4gdGhvc2UgZnVuY3Rpb25zIGRvbid0IGV4aXN0IG9uIHRoZSBzdGF0ZQogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjZHVtbXkKICAgICogQHByaXZhdGUKICAgICovCiAgICBkdW1teTogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGkgYSBnaXZlbiBwaGFzZXIgc3RhdGUgaXMgdmFsaWQuCiAgICAqIFN0YXRlIG11c3QgZXhpc3QgYW5kIGhhdmUgYXQgbGVhc3Qgb25lIGNhbGxiYWNrIGZ1bmN0aW9uIHJlZ2lzdGVyZWQuLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjY2hlY2tTdGF0ZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIGtleSBvZiB0aGUgc3RhdGUgeW91IHdhbnQgdG8gY2hlY2suCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IERlc2NyaXB0aW9uLgogICAgKi8KICAgIGNoZWNrU3RhdGU6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuc3RhdGVzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICB2YXIgdmFsaWQgPSBmYWxzZTsKCiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlc1trZXldWydwcmVsb2FkJ10pIHsgdmFsaWQgPSB0cnVlOyB9CgogICAgICAgICAgICBpZiAodmFsaWQgPT09IGZhbHNlICYmIHRoaXMuc3RhdGVzW2tleV1bJ2xvYWRSZW5kZXInXSkgeyB2YWxpZCA9IHRydWU7IH0KICAgICAgICAgICAgaWYgKHZhbGlkID09PSBmYWxzZSAmJiB0aGlzLnN0YXRlc1trZXldWydsb2FkVXBkYXRlJ10pIHsgdmFsaWQgPSB0cnVlOyB9CiAgICAgICAgICAgIGlmICh2YWxpZCA9PT0gZmFsc2UgJiYgdGhpcy5zdGF0ZXNba2V5XVsnY3JlYXRlJ10pIHsgdmFsaWQgPSB0cnVlOyB9CiAgICAgICAgICAgIGlmICh2YWxpZCA9PT0gZmFsc2UgJiYgdGhpcy5zdGF0ZXNba2V5XVsndXBkYXRlJ10pIHsgdmFsaWQgPSB0cnVlOyB9CiAgICAgICAgICAgIGlmICh2YWxpZCA9PT0gZmFsc2UgJiYgdGhpcy5zdGF0ZXNba2V5XVsncHJlUmVuZGVyJ10pIHsgdmFsaWQgPSB0cnVlOyB9CiAgICAgICAgICAgIGlmICh2YWxpZCA9PT0gZmFsc2UgJiYgdGhpcy5zdGF0ZXNba2V5XVsncmVuZGVyJ10pIHsgdmFsaWQgPSB0cnVlOyB9CiAgICAgICAgICAgIGlmICh2YWxpZCA9PT0gZmFsc2UgJiYgdGhpcy5zdGF0ZXNba2V5XVsncGF1c2VkJ10pIHsgdmFsaWQgPSB0cnVlOyB9CgogICAgICAgICAgICBpZiAodmFsaWQgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkludmFsaWQgUGhhc2VyIFN0YXRlIG9iamVjdCBnaXZlbi4gTXVzdCBjb250YWluIGF0IGxlYXN0IGEgb25lIG9mIHRoZSByZXF1aXJlZCBmdW5jdGlvbnMuIik7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5TdGF0ZU1hbmFnZXIgLSBObyBzdGF0ZSBmb3VuZCB3aXRoIHRoZSBrZXk6ICIgKyBrZXkpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIExpbmtzIGdhbWUgcHJvcGVydGllcyB0byB0aGUgU3RhdGUgZ2l2ZW4gYnkgdGhlIGtleS4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI2xpbmsKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFN0YXRlIGtleS4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGxpbms6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5nYW1lID0gdGhpcy5nYW1lOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0uYWRkID0gdGhpcy5nYW1lLmFkZDsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLmNhbWVyYSA9IHRoaXMuZ2FtZS5jYW1lcmE7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5jYWNoZSA9IHRoaXMuZ2FtZS5jYWNoZTsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLmlucHV0ID0gdGhpcy5nYW1lLmlucHV0OwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0ubG9hZCA9IHRoaXMuZ2FtZS5sb2FkOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0ubWF0aCA9IHRoaXMuZ2FtZS5tYXRoOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0uc291bmQgPSB0aGlzLmdhbWUuc291bmQ7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5zdGFnZSA9IHRoaXMuZ2FtZS5zdGFnZTsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLnRpbWUgPSB0aGlzLmdhbWUudGltZTsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLnR3ZWVucyA9IHRoaXMuZ2FtZS50d2VlbnM7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS53b3JsZCA9IHRoaXMuZ2FtZS53b3JsZDsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLnBhcnRpY2xlcyA9IHRoaXMuZ2FtZS5wYXJ0aWNsZXM7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5waHlzaWNzID0gdGhpcy5nYW1lLnBoeXNpY3M7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5ybmQgPSB0aGlzLmdhbWUucm5kOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGN1cnJlbnQgU3RhdGUuIFNob3VsZCBub3QgYmUgY2FsbGVkIGRpcmVjdGx5ICh1c2UgU3RhdGVNYW5hZ2VyLnN0YXJ0KQogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjc2V0Q3VycmVudFN0YXRlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBTdGF0ZSBrZXkuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgc2V0Q3VycmVudFN0YXRlOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gdGhpcy5zdGF0ZXNba2V5XTsKCiAgICAgICAgdGhpcy5saW5rKGtleSk7CgogICAgICAgIC8vICBVc2VkIHdoZW4gdGhlIHN0YXRlIGlzIHNldCBhcyBiZWluZyB0aGUgY3VycmVudCBhY3RpdmUgc3RhdGUKICAgICAgICB0aGlzLm9uSW5pdENhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsnaW5pdCddIHx8IHRoaXMuZHVtbXk7CgogICAgICAgIHRoaXMub25QcmVsb2FkQ2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWydwcmVsb2FkJ10gfHwgbnVsbDsKICAgICAgICB0aGlzLm9uTG9hZFJlbmRlckNhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsnbG9hZFJlbmRlciddIHx8IG51bGw7CiAgICAgICAgdGhpcy5vbkxvYWRVcGRhdGVDYWxsYmFjayA9IHRoaXMuc3RhdGVzW2tleV1bJ2xvYWRVcGRhdGUnXSB8fCBudWxsOwogICAgICAgIHRoaXMub25DcmVhdGVDYWxsYmFjayA9IHRoaXMuc3RhdGVzW2tleV1bJ2NyZWF0ZSddIHx8IG51bGw7CiAgICAgICAgdGhpcy5vblVwZGF0ZUNhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsndXBkYXRlJ10gfHwgbnVsbDsKICAgICAgICB0aGlzLm9uUHJlUmVuZGVyQ2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWydwcmVSZW5kZXInXSB8fCBudWxsOwogICAgICAgIHRoaXMub25SZW5kZXJDYWxsYmFjayA9IHRoaXMuc3RhdGVzW2tleV1bJ3JlbmRlciddIHx8IG51bGw7CiAgICAgICAgdGhpcy5vblBhdXNlZENhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsncGF1c2VkJ10gfHwgbnVsbDsKCiAgICAgICAgLy8gIFVzZWQgd2hlbiB0aGUgc3RhdGUgaXMgbm8gbG9uZ2VyIHRoZSBjdXJyZW50IGFjdGl2ZSBzdGF0ZQogICAgICAgIHRoaXMub25TaHV0RG93bkNhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsnc2h1dGRvd24nXSB8fCB0aGlzLmR1bW15OwoKICAgICAgICB0aGlzLmN1cnJlbnQgPSBrZXk7CiAgICAgICAgdGhpcy5fY3JlYXRlZCA9IGZhbHNlOwoKICAgICAgICB0aGlzLm9uSW5pdENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CgogICAgfSwKCiAgICAvKioKICAgICAqIEdldHMgdGhlIGN1cnJlbnQgU3RhdGUuCiAgICAgKgogICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI2dldEN1cnJlbnRTdGF0ZQogICAgICogQHJldHVybiBQaGFzZXIuU3RhdGUKICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgZ2V0Q3VycmVudFN0YXRlOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZXNbdGhpcy5jdXJyZW50XTsKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNsb2FkQ29tcGxldGUKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGxvYWRDb21wbGV0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fY3JlYXRlZCA9PT0gZmFsc2UgJiYgdGhpcy5vbkNyZWF0ZUNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fY3JlYXRlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMub25DcmVhdGVDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCB0aGlzLmdhbWUpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9jcmVhdGVkID0gdHJ1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI3BhdXNlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwYXVzZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fY3JlYXRlZCAmJiB0aGlzLm9uUGF1c2VkQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uUGF1c2VkQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5nYW1lLCB0cnVlKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI3Jlc3VtZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcmVzdW1lOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9jcmVhdGVkICYmIHRoaXMub25yZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25QYXVzZWRDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCB0aGlzLmdhbWUsIGZhbHNlKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI3VwZGF0ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9jcmVhdGVkICYmIHRoaXMub25VcGRhdGVDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25VcGRhdGVDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCB0aGlzLmdhbWUpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5vbkxvYWRVcGRhdGVDYWxsYmFjaykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5vbkxvYWRVcGRhdGVDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCB0aGlzLmdhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNwcmVSZW5kZXIKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHByZVJlbmRlcjogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5vblByZVJlbmRlckNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vblByZVJlbmRlckNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNyZW5kZXIKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fY3JlYXRlZCAmJiB0aGlzLm9uUmVuZGVyQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnJlbmRlclR5cGUgPT09IFBoYXNlci5DQU5WQVMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jb250ZXh0LnNhdmUoKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jb250ZXh0LnNldFRyYW5zZm9ybSgxLCAwLCAwLCAxLCAwLCAwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5vblJlbmRlckNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnJlbmRlclR5cGUgPT09IFBoYXNlci5DQU5WQVMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jb250ZXh0LnJlc3RvcmUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5vbkxvYWRSZW5kZXJDYWxsYmFjaykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5vbkxvYWRSZW5kZXJDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCB0aGlzLmdhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIE51a2UgdGhlIGVudGlyZSBnYW1lIGZyb20gb3JiaXQKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gbnVsbDsKCiAgICAgICAgdGhpcy5vbkluaXRDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5vblNodXREb3duQ2FsbGJhY2sgPSBudWxsOwoKICAgICAgICB0aGlzLm9uUHJlbG9hZENhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLm9uTG9hZFJlbmRlckNhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLm9uTG9hZFVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLm9uQ3JlYXRlQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMub25VcGRhdGVDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5vblJlbmRlckNhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLm9uUGF1c2VkQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMub25EZXN0cm95Q2FsbGJhY2sgPSBudWxsOwoKICAgICAgICB0aGlzLmdhbWUgPSBudWxsOwogICAgICAgIHRoaXMuc3RhdGVzID0ge307CiAgICAgICAgdGhpcy5fcGVuZGluZ1N0YXRlID0gbnVsbDsKCiAgICB9Cgp9OwoKUGhhc2VyLlN0YXRlTWFuYWdlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuU3RhdGVNYW5hZ2VyOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQSBiYXNpYyBsaW5rZWQgbGlzdCBkYXRhIHN0cnVjdHVyZS4KKgoqIEBjbGFzcyBQaGFzZXIuTGlua2VkTGlzdAoqIEBjb25zdHJ1Y3RvcgoqLwpQaGFzZXIuTGlua2VkTGlzdCA9IGZ1bmN0aW9uICgpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IG5leHQgLSBOZXh0IGVsZW1lbnQgaW4gdGhlIGxpc3QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5uZXh0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IHByZXYgLSBQcmV2aW91cyBlbGVtZW50IGluIHRoZSBsaXN0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucHJldiA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBmaXJzdCAtIEZpcnN0IGVsZW1lbnQgaW4gdGhlIGxpc3QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5maXJzdCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBsYXN0IC0gTGFzdCBlbGVtZW50IGluIHRoZSBsaXN0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubGFzdCA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gZ2FtZSAtIE51bWJlciBvZiBlbGVtZW50cyBpbiB0aGUgbGlzdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRvdGFsID0gMDsKCn07CgpQaGFzZXIuTGlua2VkTGlzdC5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEFkZHMgYSBuZXcgZWxlbWVudCB0byB0aGlzIGxpbmtlZCBsaXN0LgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTGlua2VkTGlzdCNhZGQKICAgICogQHBhcmFtIHtvYmplY3R9IGNoaWxkIC0gVGhlIGVsZW1lbnQgdG8gYWRkIHRvIHRoaXMgbGlzdC4gQ2FuIGJlIGEgUGhhc2VyLlNwcml0ZSBvciBhbnkgb3RoZXIgb2JqZWN0IHlvdSBuZWVkIHRvIHF1aWNrbHkgaXRlcmF0ZSB0aHJvdWdoLgogICAgKiBAcmV0dXJuIHtvYmplY3R9IFRoZSBjaGlsZCB0aGF0IHdhcyBhZGRlZC4KICAgICovCiAgICBhZGQ6IGZ1bmN0aW9uIChjaGlsZCkgewoKICAgICAgICAvLyAgSWYgdGhlIGxpc3QgaXMgZW1wdHkKICAgICAgICBpZiAodGhpcy50b3RhbCA9PT0gMCAmJiB0aGlzLmZpcnN0ID09IG51bGwgJiYgdGhpcy5sYXN0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZpcnN0ID0gY2hpbGQ7CiAgICAgICAgICAgIHRoaXMubGFzdCA9IGNoaWxkOwogICAgICAgICAgICB0aGlzLm5leHQgPSBjaGlsZDsKICAgICAgICAgICAgY2hpbGQucHJldiA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMudG90YWwrKzsKICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgIH0KCiAgICAgICAgLy8gIEdldCBnZXRzIGFwcGVuZGVkIHRvIHRoZSBlbmQgb2YgdGhlIGxpc3QsIHJlZ2FyZGxlc3Mgb2YgYW55dGhpbmcsIGFuZCBpdCB3b24ndCBoYXZlIGFueSBjaGlsZHJlbiBvZiBpdHMgb3duIChub24tbmVzdGVkIGxpc3QpCiAgICAgICAgdGhpcy5sYXN0Lm5leHQgPSBjaGlsZDsKCiAgICAgICAgY2hpbGQucHJldiA9IHRoaXMubGFzdDsKCiAgICAgICAgdGhpcy5sYXN0ID0gY2hpbGQ7CgogICAgICAgIHRoaXMudG90YWwrKzsKCiAgICAgICAgcmV0dXJuIGNoaWxkOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgdGhlIGdpdmVuIGVsZW1lbnQgZnJvbSB0aGlzIGxpbmtlZCBsaXN0IGlmIGl0IGV4aXN0cy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkxpbmtlZExpc3QjcmVtb3ZlCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjaGlsZCAtIFRoZSBjaGlsZCB0byBiZSByZW1vdmVkIGZyb20gdGhlIGxpc3QuCiAgICAqLwogICAgcmVtb3ZlOiBmdW5jdGlvbiAoY2hpbGQpIHsKCiAgICAgICAgaWYgKGNoaWxkID09IHRoaXMuZmlyc3QpCiAgICAgICAgewogICAgICAgICAgICAvLyBJdCB3YXMgJ2ZpcnN0JywgbWFrZSAnZmlyc3QnIHBvaW50IHRvIGZpcnN0Lm5leHQKICAgICAgICAgICAgdGhpcy5maXJzdCA9IHRoaXMuZmlyc3QubmV4dDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoY2hpbGQgPT0gdGhpcy5sYXN0KQogICAgICAgIHsKICAgICAgICAgICAgLy8gSXQgd2FzICdsYXN0JywgbWFrZSAnbGFzdCcgcG9pbnQgdG8gbGFzdC5wcmV2CiAgICAgICAgICAgIHRoaXMubGFzdCA9IHRoaXMubGFzdC5wcmV2OwogICAgICAgIH0KCiAgICAgICAgaWYgKGNoaWxkLnByZXYpCiAgICAgICAgewogICAgICAgICAgICAvLyBtYWtlIGNoaWxkLnByZXYubmV4dCBwb2ludCB0byBjaGlsZHMubmV4dCBpbnN0ZWFkIG9mIGNoaWxkCiAgICAgICAgICAgIGNoaWxkLnByZXYubmV4dCA9IGNoaWxkLm5leHQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoY2hpbGQubmV4dCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIG1ha2UgY2hpbGQubmV4dC5wcmV2IHBvaW50IHRvIGNoaWxkLnByZXYgaW5zdGVhZCBvZiBjaGlsZAogICAgICAgICAgICBjaGlsZC5uZXh0LnByZXYgPSBjaGlsZC5wcmV2OwogICAgICAgIH0KCiAgICAgICAgY2hpbGQubmV4dCA9IGNoaWxkLnByZXYgPSBudWxsOwoKICAgICAgICBpZiAodGhpcy5maXJzdCA9PSBudWxsICkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubGFzdCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnRvdGFsLS07CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbHMgYSBmdW5jdGlvbiBvbiBhbGwgbWVtYmVycyBvZiB0aGlzIGxpc3QsIHVzaW5nIHRoZSBtZW1iZXIgYXMgdGhlIGNvbnRleHQgZm9yIHRoZSBjYWxsYmFjay4KICAgICogVGhlIGZ1bmN0aW9uIG11c3QgZXhpc3Qgb24gdGhlIG1lbWJlci4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkxpbmtlZExpc3QjY2FsbEFsbAogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBmdW5jdGlvbiB0byBjYWxsLgogICAgKi8KICAgIGNhbGxBbGw6IGZ1bmN0aW9uIChjYWxsYmFjaykgewoKICAgICAgICBpZiAoIXRoaXMuZmlyc3QgfHwgIXRoaXMubGFzdCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBlbnRpdHkgPSB0aGlzLmZpcnN0OwogICAgICAgIAogICAgICAgIGRvCiAgICAgICAgewogICAgICAgICAgICBpZiAoZW50aXR5ICYmIGVudGl0eVtjYWxsYmFja10pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVudGl0eVtjYWxsYmFja10uY2FsbChlbnRpdHkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBlbnRpdHkgPSBlbnRpdHkubmV4dDsKCiAgICAgICAgfQogICAgICAgIHdoaWxlKGVudGl0eSAhPSB0aGlzLmxhc3QubmV4dCkKCiAgICB9Cgp9OwoKUGhhc2VyLkxpbmtlZExpc3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkxpbmtlZExpc3Q7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBAY2xhc3MgUGhhc2VyLlNpZ25hbAoqIEBjbGFzc2Rlc2MgQSBTaWduYWwgaXMgdXNlZCBmb3Igb2JqZWN0IGNvbW11bmljYXRpb24gdmlhIGEgY3VzdG9tIGJyb2FkY2FzdGVyIGluc3RlYWQgb2YgRXZlbnRzLgoqIEBhdXRob3IgTWlsbGVyIE1lZGVpcm9zIGh0dHA6Ly9taWxsZXJtZWRlaXJvcy5naXRodWIuY29tL2pzLXNpZ25hbHMvCiogQGNvbnN0cnVjdG9yCiovClBoYXNlci5TaWduYWwgPSBmdW5jdGlvbiAoKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPFBoYXNlci5TaWduYWxCaW5kaW5nPn0gX2JpbmRpbmdzIC0gSW50ZXJuYWwgdmFyaWFibGUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fYmluZGluZ3MgPSBbXTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YW55fSBfcHJldlBhcmFtcyAtIEludGVybmFsIHZhcmlhYmxlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3ByZXZQYXJhbXMgPSBudWxsOwoKICAgIC8vIGVuZm9yY2UgZGlzcGF0Y2ggdG8gYXdheXMgd29yayBvbiBzYW1lIGNvbnRleHQgKCM0NykKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gZGlzcGF0Y2ggLSBUaGUgZGlzcGF0Y2ggZnVuY3Rpb24gaXMgd2hhdCBzZW5kcyB0aGUgU2lnbmFsIG91dC4KICAgICovCiAgICB0aGlzLmRpc3BhdGNoID0gZnVuY3Rpb24oKXsKICAgICAgICBQaGFzZXIuU2lnbmFsLnByb3RvdHlwZS5kaXNwYXRjaC5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgfTsKCn07CgpQaGFzZXIuU2lnbmFsLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogSWYgU2lnbmFsIHNob3VsZCBrZWVwIHJlY29yZCBvZiBwcmV2aW91c2x5IGRpc3BhdGNoZWQgcGFyYW1ldGVycyBhbmQKICAgICogYXV0b21hdGljYWxseSBleGVjdXRlIGxpc3RlbmVyIGR1cmluZyBgYWRkKClgL2BhZGRPbmNlKClgIGlmIFNpZ25hbCB3YXMKICAgICogYWxyZWFkeSBkaXNwYXRjaGVkIGJlZm9yZS4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBtZW1vcml6ZQogICAgKi8KICAgIG1lbW9yaXplOiBmYWxzZSwKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfc2hvdWxkUHJvcGFnYXRlIAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIF9zaG91bGRQcm9wYWdhdGU6IHRydWUsCgogICAgLyoqCiAgICAqIElmIFNpZ25hbCBpcyBhY3RpdmUgYW5kIHNob3VsZCBicm9hZGNhc3QgZXZlbnRzLgogICAgKiA8cD48c3Ryb25nPklNUE9SVEFOVDo8L3N0cm9uZz4gU2V0dGluZyB0aGlzIHByb3BlcnR5IGR1cmluZyBhIGRpc3BhdGNoIHdpbGwgb25seSBhZmZlY3QgdGhlIG5leHQgZGlzcGF0Y2gsIGlmIHlvdSB3YW50IHRvIHN0b3AgdGhlIHByb3BhZ2F0aW9uIG9mIGEgc2lnbmFsIHVzZSBgaGFsdCgpYCBpbnN0ZWFkLjwvcD4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBhY3RpdmUKICAgICogQGRlZmF1bHQKICAgICovCiAgICBhY3RpdmU6IHRydWUsCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCN2YWxpZGF0ZUxpc3RlbmVyCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGxpc3RlbmVyIC0gU2lnbmFsIGhhbmRsZXIgZnVuY3Rpb24uCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBmbk5hbWUgLSBGdW5jdGlvbiBuYW1lLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHZhbGlkYXRlTGlzdGVuZXI6IGZ1bmN0aW9uIChsaXN0ZW5lciwgZm5OYW1lKSB7CiAgICAgICAgaWYgKHR5cGVvZiBsaXN0ZW5lciAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoICdsaXN0ZW5lciBpcyBhIHJlcXVpcmVkIHBhcmFtIG9mIHtmbn0oKSBhbmQgc2hvdWxkIGJlIGEgRnVuY3Rpb24uJy5yZXBsYWNlKCd7Zm59JywgZm5OYW1lKSApOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNfcmVnaXN0ZXJMaXN0ZW5lcgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBsaXN0ZW5lciAtIFNpZ25hbCBoYW5kbGVyIGZ1bmN0aW9uLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzT25jZSAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge29iamVjdH0gW2xpc3RlbmVyQ29udGV4dF0gLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtwcmlvcml0eV0gLSBUaGUgcHJpb3JpdHkgbGV2ZWwgb2YgdGhlIGV2ZW50IGxpc3RlbmVyLiBMaXN0ZW5lcnMgd2l0aCBoaWdoZXIgcHJpb3JpdHkgd2lsbCBiZSBleGVjdXRlZCBiZWZvcmUgbGlzdGVuZXJzIHdpdGggbG93ZXIgcHJpb3JpdHkuIExpc3RlbmVycyB3aXRoIHNhbWUgcHJpb3JpdHkgbGV2ZWwgd2lsbCBiZSBleGVjdXRlZCBhdCB0aGUgc2FtZSBvcmRlciBhcyB0aGV5IHdlcmUgYWRkZWQuIChkZWZhdWx0ID0gMCkuCiAgICAqIEByZXR1cm4ge1BoYXNlci5TaWduYWxCaW5kaW5nfSBBbiBPYmplY3QgcmVwcmVzZW50aW5nIHRoZSBiaW5kaW5nIGJldHdlZW4gdGhlIFNpZ25hbCBhbmQgbGlzdGVuZXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX3JlZ2lzdGVyTGlzdGVuZXI6IGZ1bmN0aW9uIChsaXN0ZW5lciwgaXNPbmNlLCBsaXN0ZW5lckNvbnRleHQsIHByaW9yaXR5KSB7CgogICAgICAgIHZhciBwcmV2SW5kZXggPSB0aGlzLl9pbmRleE9mTGlzdGVuZXIobGlzdGVuZXIsIGxpc3RlbmVyQ29udGV4dCksCiAgICAgICAgICAgIGJpbmRpbmc7CgogICAgICAgIGlmIChwcmV2SW5kZXggIT09IC0xKSB7CiAgICAgICAgICAgIGJpbmRpbmcgPSB0aGlzLl9iaW5kaW5nc1twcmV2SW5kZXhdOwogICAgICAgICAgICBpZiAoYmluZGluZy5pc09uY2UoKSAhPT0gaXNPbmNlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBjYW5ub3QgYWRkJysgKGlzT25jZT8gJycgOiAnT25jZScpICsnKCkgdGhlbiBhZGQnKyAoIWlzT25jZT8gJycgOiAnT25jZScpICsnKCkgdGhlIHNhbWUgbGlzdGVuZXIgd2l0aG91dCByZW1vdmluZyB0aGUgcmVsYXRpb25zaGlwIGZpcnN0LicpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYmluZGluZyA9IG5ldyBQaGFzZXIuU2lnbmFsQmluZGluZyh0aGlzLCBsaXN0ZW5lciwgaXNPbmNlLCBsaXN0ZW5lckNvbnRleHQsIHByaW9yaXR5KTsKICAgICAgICAgICAgdGhpcy5fYWRkQmluZGluZyhiaW5kaW5nKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm1lbW9yaXplICYmIHRoaXMuX3ByZXZQYXJhbXMpewogICAgICAgICAgICBiaW5kaW5nLmV4ZWN1dGUodGhpcy5fcHJldlBhcmFtcyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYmluZGluZzsKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNfYWRkQmluZGluZyAKICAgICogQHBhcmFtIHtQaGFzZXIuU2lnbmFsQmluZGluZ30gYmluZGluZyAtIEFuIE9iamVjdCByZXByZXNlbnRpbmcgdGhlIGJpbmRpbmcgYmV0d2VlbiB0aGUgU2lnbmFsIGFuZCBsaXN0ZW5lci4KICAgICogQHByaXZhdGUKICAgICovCiAgICBfYWRkQmluZGluZzogZnVuY3Rpb24gKGJpbmRpbmcpIHsKICAgICAgICAvL3NpbXBsaWZpZWQgaW5zZXJ0aW9uIHNvcnQKICAgICAgICB2YXIgbiA9IHRoaXMuX2JpbmRpbmdzLmxlbmd0aDsKICAgICAgICBkbyB7IC0tbjsgfSB3aGlsZSAodGhpcy5fYmluZGluZ3Nbbl0gJiYgYmluZGluZy5fcHJpb3JpdHkgPD0gdGhpcy5fYmluZGluZ3Nbbl0uX3ByaW9yaXR5KTsKICAgICAgICB0aGlzLl9iaW5kaW5ncy5zcGxpY2UobiArIDEsIDAsIGJpbmRpbmcpOwogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI19pbmRleE9mTGlzdGVuZXIKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgLSBTaWduYWwgaGFuZGxlciBmdW5jdGlvbi4KICAgICogQHJldHVybiB7bnVtYmVyfSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICovCiAgICBfaW5kZXhPZkxpc3RlbmVyOiBmdW5jdGlvbiAobGlzdGVuZXIsIGNvbnRleHQpIHsKICAgICAgICB2YXIgbiA9IHRoaXMuX2JpbmRpbmdzLmxlbmd0aCwKICAgICAgICAgICAgY3VyOwogICAgICAgIHdoaWxlIChuLS0pIHsKICAgICAgICAgICAgY3VyID0gdGhpcy5fYmluZGluZ3Nbbl07CiAgICAgICAgICAgIGlmIChjdXIuX2xpc3RlbmVyID09PSBsaXN0ZW5lciAmJiBjdXIuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIC0xOwogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgaWYgbGlzdGVuZXIgd2FzIGF0dGFjaGVkIHRvIFNpZ25hbC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNoYXMKICAgICogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXIgLSBTaWduYWwgaGFuZGxlciBmdW5jdGlvbi4KICAgICogQHBhcmFtIHtPYmplY3R9IFtjb250ZXh0XSAtIENvbnRleHQgb24gd2hpY2ggbGlzdGVuZXIgd2lsbCBiZSBleGVjdXRlZCAob2JqZWN0IHRoYXQgc2hvdWxkIHJlcHJlc2VudCB0aGUgYHRoaXNgIHZhcmlhYmxlIGluc2lkZSBsaXN0ZW5lciBmdW5jdGlvbikuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IElmIFNpZ25hbCBoYXMgdGhlIHNwZWNpZmllZCBsaXN0ZW5lci4KICAgICovCiAgICBoYXM6IGZ1bmN0aW9uIChsaXN0ZW5lciwgY29udGV4dCkgewogICAgICAgIHJldHVybiB0aGlzLl9pbmRleE9mTGlzdGVuZXIobGlzdGVuZXIsIGNvbnRleHQpICE9PSAtMTsKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIGxpc3RlbmVyIHRvIHRoZSBzaWduYWwuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjYWRkCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGxpc3RlbmVyIC0gU2lnbmFsIGhhbmRsZXIgZnVuY3Rpb24uCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBbbGlzdGVuZXJDb250ZXh0XSBDb250ZXh0IG9uIHdoaWNoIGxpc3RlbmVyIHdpbGwgYmUgZXhlY3V0ZWQgKG9iamVjdCB0aGF0IHNob3VsZCByZXByZXNlbnQgdGhlIGB0aGlzYCB2YXJpYWJsZSBpbnNpZGUgbGlzdGVuZXIgZnVuY3Rpb24pLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ByaW9yaXR5XSBUaGUgcHJpb3JpdHkgbGV2ZWwgb2YgdGhlIGV2ZW50IGxpc3RlbmVyLiBMaXN0ZW5lcnMgd2l0aCBoaWdoZXIgcHJpb3JpdHkgd2lsbCBiZSBleGVjdXRlZCBiZWZvcmUgbGlzdGVuZXJzIHdpdGggbG93ZXIgcHJpb3JpdHkuIExpc3RlbmVycyB3aXRoIHNhbWUgcHJpb3JpdHkgbGV2ZWwgd2lsbCBiZSBleGVjdXRlZCBhdCB0aGUgc2FtZSBvcmRlciBhcyB0aGV5IHdlcmUgYWRkZWQuIChkZWZhdWx0ID0gMCkuCiAgICAqIEByZXR1cm4ge1BoYXNlci5TaWduYWxCaW5kaW5nfSBBbiBPYmplY3QgcmVwcmVzZW50aW5nIHRoZSBiaW5kaW5nIGJldHdlZW4gdGhlIFNpZ25hbCBhbmQgbGlzdGVuZXIuCiAgICAqLwogICAgYWRkOiBmdW5jdGlvbiAobGlzdGVuZXIsIGxpc3RlbmVyQ29udGV4dCwgcHJpb3JpdHkpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlTGlzdGVuZXIobGlzdGVuZXIsICdhZGQnKTsKICAgICAgICByZXR1cm4gdGhpcy5fcmVnaXN0ZXJMaXN0ZW5lcihsaXN0ZW5lciwgZmFsc2UsIGxpc3RlbmVyQ29udGV4dCwgcHJpb3JpdHkpOwogICAgfSwKCiAgICAvKioKICAgICogQWRkIGxpc3RlbmVyIHRvIHRoZSBzaWduYWwgdGhhdCBzaG91bGQgYmUgcmVtb3ZlZCBhZnRlciBmaXJzdCBleGVjdXRpb24gKHdpbGwgYmUgZXhlY3V0ZWQgb25seSBvbmNlKS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI2FkZE9uY2UKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgU2lnbmFsIGhhbmRsZXIgZnVuY3Rpb24uCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBbbGlzdGVuZXJDb250ZXh0XSBDb250ZXh0IG9uIHdoaWNoIGxpc3RlbmVyIHdpbGwgYmUgZXhlY3V0ZWQgKG9iamVjdCB0aGF0IHNob3VsZCByZXByZXNlbnQgdGhlIGB0aGlzYCB2YXJpYWJsZSBpbnNpZGUgbGlzdGVuZXIgZnVuY3Rpb24pLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ByaW9yaXR5XSBUaGUgcHJpb3JpdHkgbGV2ZWwgb2YgdGhlIGV2ZW50IGxpc3RlbmVyLiBMaXN0ZW5lcnMgd2l0aCBoaWdoZXIgcHJpb3JpdHkgd2lsbCBiZSBleGVjdXRlZCBiZWZvcmUgbGlzdGVuZXJzIHdpdGggbG93ZXIgcHJpb3JpdHkuIExpc3RlbmVycyB3aXRoIHNhbWUgcHJpb3JpdHkgbGV2ZWwgd2lsbCBiZSBleGVjdXRlZCBhdCB0aGUgc2FtZSBvcmRlciBhcyB0aGV5IHdlcmUgYWRkZWQuIChkZWZhdWx0ID0gMCkKICAgICogQHJldHVybiB7UGhhc2VyLlNpZ25hbEJpbmRpbmd9IEFuIE9iamVjdCByZXByZXNlbnRpbmcgdGhlIGJpbmRpbmcgYmV0d2VlbiB0aGUgU2lnbmFsIGFuZCBsaXN0ZW5lci4KICAgICovCiAgICBhZGRPbmNlOiBmdW5jdGlvbiAobGlzdGVuZXIsIGxpc3RlbmVyQ29udGV4dCwgcHJpb3JpdHkpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlTGlzdGVuZXIobGlzdGVuZXIsICdhZGRPbmNlJyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lzdGVyTGlzdGVuZXIobGlzdGVuZXIsIHRydWUsIGxpc3RlbmVyQ29udGV4dCwgcHJpb3JpdHkpOwogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlIGEgc2luZ2xlIGxpc3RlbmVyIGZyb20gdGhlIGRpc3BhdGNoIHF1ZXVlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjcmVtb3ZlCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGxpc3RlbmVyIEhhbmRsZXIgZnVuY3Rpb24gdGhhdCBzaG91bGQgYmUgcmVtb3ZlZC4KICAgICogQHBhcmFtIHtvYmplY3R9IFtjb250ZXh0XSBFeGVjdXRpb24gY29udGV4dCAoc2luY2UgeW91IGNhbiBhZGQgdGhlIHNhbWUgaGFuZGxlciBtdWx0aXBsZSB0aW1lcyBpZiBleGVjdXRpbmcgaW4gYSBkaWZmZXJlbnQgY29udGV4dCkuCiAgICAqIEByZXR1cm4ge2Z1bmN0aW9ufSBMaXN0ZW5lciBoYW5kbGVyIGZ1bmN0aW9uLgogICAgKi8KICAgIHJlbW92ZTogZnVuY3Rpb24gKGxpc3RlbmVyLCBjb250ZXh0KSB7CgogICAgICAgIHRoaXMudmFsaWRhdGVMaXN0ZW5lcihsaXN0ZW5lciwgJ3JlbW92ZScpOwoKICAgICAgICB2YXIgaSA9IHRoaXMuX2luZGV4T2ZMaXN0ZW5lcihsaXN0ZW5lciwgY29udGV4dCk7CgogICAgICAgIGlmIChpICE9PSAtMSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2JpbmRpbmdzW2ldLl9kZXN0cm95KCk7IC8vbm8gcmVhc29uIHRvIGEgUGhhc2VyLlNpZ25hbEJpbmRpbmcgZXhpc3QgaWYgaXQgaXNuJ3QgYXR0YWNoZWQgdG8gYSBzaWduYWwKICAgICAgICAgICAgdGhpcy5fYmluZGluZ3Muc3BsaWNlKGksIDEpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGxpc3RlbmVyOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZSBhbGwgbGlzdGVuZXJzIGZyb20gdGhlIFNpZ25hbC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI3JlbW92ZUFsbAogICAgKi8KICAgIHJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBuID0gdGhpcy5fYmluZGluZ3MubGVuZ3RoOwogICAgICAgIHdoaWxlIChuLS0pIHsKICAgICAgICAgICAgdGhpcy5fYmluZGluZ3Nbbl0uX2Rlc3Ryb3koKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fYmluZGluZ3MubGVuZ3RoID0gMDsKICAgIH0sCgogICAgLyoqCiAgICAqIEdldHMgdGhlIHRvdGFsIG51bWJlciBvZiBsaXN0ZW5lcmVzIGF0dGFjaGVkIHRvIHRocyBTaWduYWwuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNnZXROdW1MaXN0ZW5lcnMKICAgICogQHJldHVybiB7bnVtYmVyfSBOdW1iZXIgb2YgbGlzdGVuZXJzIGF0dGFjaGVkIHRvIHRoZSBTaWduYWwuCiAgICAqLwogICAgZ2V0TnVtTGlzdGVuZXJzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2JpbmRpbmdzLmxlbmd0aDsKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3AgcHJvcGFnYXRpb24gb2YgdGhlIGV2ZW50LCBibG9ja2luZyB0aGUgZGlzcGF0Y2ggdG8gbmV4dCBsaXN0ZW5lcnMgb24gdGhlIHF1ZXVlLgogICAgKiBJTVBPUlRBTlQ6IHNob3VsZCBiZSBjYWxsZWQgb25seSBkdXJpbmcgc2lnbmFsIGRpc3BhdGNoLCBjYWxsaW5nIGl0IGJlZm9yZS9hZnRlciBkaXNwYXRjaCB3b24ndCBhZmZlY3Qgc2lnbmFsIGJyb2FkY2FzdC4KICAgICogQHNlZSBTaWduYWwucHJvdG90eXBlLmRpc2FibGUKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI2hhbHQKICAgICovCiAgICBoYWx0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fc2hvdWxkUHJvcGFnYXRlID0gZmFsc2U7CiAgICB9LAoKICAgIC8qKgogICAgKiBEaXNwYXRjaC9Ccm9hZGNhc3QgU2lnbmFsIHRvIGFsbCBsaXN0ZW5lcnMgYWRkZWQgdG8gdGhlIHF1ZXVlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjZGlzcGF0Y2gKICAgICogQHBhcmFtIHthbnl9IFtwYXJhbXNdIC0gUGFyYW1ldGVycyB0aGF0IHNob3VsZCBiZSBwYXNzZWQgdG8gZWFjaCBoYW5kbGVyLgogICAgKi8KICAgIGRpc3BhdGNoOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICghdGhpcy5hY3RpdmUpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgcGFyYW1zQXJyID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICB2YXIgbiA9IHRoaXMuX2JpbmRpbmdzLmxlbmd0aDsKICAgICAgICB2YXIgYmluZGluZ3M7CgogICAgICAgIGlmICh0aGlzLm1lbW9yaXplKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcHJldlBhcmFtcyA9IHBhcmFtc0FycjsKICAgICAgICB9CgogICAgICAgIGlmICghbikKICAgICAgICB7CiAgICAgICAgICAgIC8vICBTaG91bGQgY29tZSBhZnRlciBtZW1vcml6ZQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBiaW5kaW5ncyA9IHRoaXMuX2JpbmRpbmdzLnNsaWNlKCk7IC8vY2xvbmUgYXJyYXkgaW4gY2FzZSBhZGQvcmVtb3ZlIGl0ZW1zIGR1cmluZyBkaXNwYXRjaAogICAgICAgIHRoaXMuX3Nob3VsZFByb3BhZ2F0ZSA9IHRydWU7IC8vaW4gY2FzZSBgaGFsdGAgd2FzIGNhbGxlZCBiZWZvcmUgZGlzcGF0Y2ggb3IgZHVyaW5nIHRoZSBwcmV2aW91cyBkaXNwYXRjaC4KCiAgICAgICAgLy9leGVjdXRlIGFsbCBjYWxsYmFja3MgdW50aWwgZW5kIG9mIHRoZSBsaXN0IG9yIHVudGlsIGEgY2FsbGJhY2sgcmV0dXJucyBgZmFsc2VgIG9yIHN0b3BzIHByb3BhZ2F0aW9uCiAgICAgICAgLy9yZXZlcnNlIGxvb3Agc2luY2UgbGlzdGVuZXJzIHdpdGggaGlnaGVyIHByaW9yaXR5IHdpbGwgYmUgYWRkZWQgYXQgdGhlIGVuZCBvZiB0aGUgbGlzdAogICAgICAgIGRvIHsgbi0tOyB9IHdoaWxlIChiaW5kaW5nc1tuXSAmJiB0aGlzLl9zaG91bGRQcm9wYWdhdGUgJiYgYmluZGluZ3Nbbl0uZXhlY3V0ZShwYXJhbXNBcnIpICE9PSBmYWxzZSk7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBGb3JnZXQgbWVtb3JpemVkIGFyZ3VtZW50cy4KICAgICogQHNlZSBTaWduYWwubWVtb3JpemUKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI2ZvcmdldAogICAgKi8KICAgIGZvcmdldDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLl9wcmV2UGFyYW1zID0gbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZSBhbGwgYmluZGluZ3MgZnJvbSBzaWduYWwgYW5kIGRlc3Ryb3kgYW55IHJlZmVyZW5jZSB0byBleHRlcm5hbCBvYmplY3RzIChkZXN0cm95IFNpZ25hbCBvYmplY3QpLgogICAgKiBJTVBPUlRBTlQ6IGNhbGxpbmcgYW55IG1ldGhvZCBvbiB0aGUgc2lnbmFsIGluc3RhbmNlIGFmdGVyIGNhbGxpbmcgZGlzcG9zZSB3aWxsIHRocm93IGVycm9ycy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI2Rpc3Bvc2UKICAgICovCiAgICBkaXNwb3NlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5yZW1vdmVBbGwoKTsKICAgICAgICBkZWxldGUgdGhpcy5fYmluZGluZ3M7CiAgICAgICAgZGVsZXRlIHRoaXMuX3ByZXZQYXJhbXM7CiAgICB9LAoKICAgIC8qKgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjdG9TdHJpbmcKICAgICogQHJldHVybiB7c3RyaW5nfSBTdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIG9iamVjdC4KICAgICovCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAnW1BoYXNlci5TaWduYWwgYWN0aXZlOicrIHRoaXMuYWN0aXZlICsnIG51bUxpc3RlbmVyczonKyB0aGlzLmdldE51bUxpc3RlbmVycygpICsnXSc7CiAgICB9Cgp9OwoKUGhhc2VyLlNpZ25hbC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuU2lnbmFsOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLlNpZ25hbEJpbmRpbmcKKgoqIE9iamVjdCB0aGF0IHJlcHJlc2VudHMgYSBiaW5kaW5nIGJldHdlZW4gYSBTaWduYWwgYW5kIGEgbGlzdGVuZXIgZnVuY3Rpb24uCiogVGhpcyBpcyBhbiBpbnRlcm5hbCBjb25zdHJ1Y3RvciBhbmQgc2hvdWxkbid0IGJlIGNhbGxlZCBieSByZWd1bGFyIHVzZXJzLgoqIEluc3BpcmVkIGJ5IEpvYSBFYmVydCBBUzMgU2lnbmFsQmluZGluZyBhbmQgUm9iZXJ0IFBlbm5lcidzIFNsb3QgY2xhc3Nlcy4KKgoqIEBjbGFzcyBQaGFzZXIuU2lnbmFsQmluZGluZwoqIEBuYW1lIFNpZ25hbEJpbmRpbmcKKiBAYXV0aG9yIE1pbGxlciBNZWRlaXJvcyBodHRwOi8vbWlsbGVybWVkZWlyb3MuZ2l0aHViLmNvbS9qcy1zaWduYWxzLwoqIEBjb25zdHJ1Y3RvcgoqIEBpbm5lcgoqIEBwYXJhbSB7UGhhc2VyLlNpZ25hbH0gc2lnbmFsIC0gUmVmZXJlbmNlIHRvIFNpZ25hbCBvYmplY3QgdGhhdCBsaXN0ZW5lciBpcyBjdXJyZW50bHkgYm91bmQgdG8uCiogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgLSBIYW5kbGVyIGZ1bmN0aW9uIGJvdW5kIHRvIHRoZSBzaWduYWwuCiogQHBhcmFtIHtib29sZWFufSBpc09uY2UgLSBJZiBiaW5kaW5nIHNob3VsZCBiZSBleGVjdXRlZCBqdXN0IG9uY2UuCiogQHBhcmFtIHtvYmplY3R9IFtsaXN0ZW5lckNvbnRleHRdIC0gQ29udGV4dCBvbiB3aGljaCBsaXN0ZW5lciB3aWxsIGJlIGV4ZWN1dGVkIChvYmplY3QgdGhhdCBzaG91bGQgcmVwcmVzZW50IHRoZSBgdGhpc2AgdmFyaWFibGUgaW5zaWRlIGxpc3RlbmVyIGZ1bmN0aW9uKS4KKiBAcGFyYW0ge251bWJlcn0gW3ByaW9yaXR5XSAtIFRoZSBwcmlvcml0eSBsZXZlbCBvZiB0aGUgZXZlbnQgbGlzdGVuZXIuIChkZWZhdWx0ID0gMCkuCiovClBoYXNlci5TaWduYWxCaW5kaW5nID0gZnVuY3Rpb24gKHNpZ25hbCwgbGlzdGVuZXIsIGlzT25jZSwgbGlzdGVuZXJDb250ZXh0LCBwcmlvcml0eSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBfbGlzdGVuZXIgLSBIYW5kbGVyIGZ1bmN0aW9uIGJvdW5kIHRvIHRoZSBzaWduYWwuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fbGlzdGVuZXIgPSBsaXN0ZW5lcjsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfaXNPbmNlIC0gSWYgYmluZGluZyBzaG91bGQgYmUgZXhlY3V0ZWQganVzdCBvbmNlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2lzT25jZSA9IGlzT25jZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R8dW5kZWZpbmVkfG51bGx9IGNvbnRleHQgLSBDb250ZXh0IG9uIHdoaWNoIGxpc3RlbmVyIHdpbGwgYmUgZXhlY3V0ZWQgKG9iamVjdCB0aGF0IHNob3VsZCByZXByZXNlbnQgdGhlIGB0aGlzYCB2YXJpYWJsZSBpbnNpZGUgbGlzdGVuZXIgZnVuY3Rpb24pLgogICAgKiBAbWVtYmVyb2YgU2lnbmFsQmluZGluZy5wcm90b3R5cGUKICAgICovCiAgICB0aGlzLmNvbnRleHQgPSBsaXN0ZW5lckNvbnRleHQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gX3NpZ25hbCAtIFJlZmVyZW5jZSB0byBTaWduYWwgb2JqZWN0IHRoYXQgbGlzdGVuZXIgaXMgY3VycmVudGx5IGJvdW5kIHRvLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3NpZ25hbCA9IHNpZ25hbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9wcmlvcml0eSAtIExpc3RlbmVyIHByaW9yaXR5LgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3ByaW9yaXR5ID0gcHJpb3JpdHkgfHwgMDsKCn07CgpQaGFzZXIuU2lnbmFsQmluZGluZy5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIElmIGJpbmRpbmcgaXMgYWN0aXZlIGFuZCBzaG91bGQgYmUgZXhlY3V0ZWQuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWN0aXZlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgYWN0aXZlOiB0cnVlLAoKICAgIC8qKgogICAgKiBEZWZhdWx0IHBhcmFtZXRlcnMgcGFzc2VkIHRvIGxpc3RlbmVyIGR1cmluZyBgU2lnbmFsLmRpc3BhdGNoYCBhbmQgYFNpZ25hbEJpbmRpbmcuZXhlY3V0ZWAgKGN1cnJpZWQgcGFyYW1ldGVycykuCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl8bnVsbH0gcGFyYW1zIAogICAgKiBAZGVmYXVsdCAKICAgICovCiAgICBwYXJhbXM6IG51bGwsCgogICAgLyoqCiAgICAqIENhbGwgbGlzdGVuZXIgcGFzc2luZyBhcmJpdHJhcnkgcGFyYW1ldGVycy4KICAgICogSWYgYmluZGluZyB3YXMgYWRkZWQgdXNpbmcgYFNpZ25hbC5hZGRPbmNlKClgIGl0IHdpbGwgYmUgYXV0b21hdGljYWxseSByZW1vdmVkIGZyb20gc2lnbmFsIGRpc3BhdGNoIHF1ZXVlLCB0aGlzIG1ldGhvZCBpcyB1c2VkIGludGVybmFsbHkgZm9yIHRoZSBzaWduYWwgZGlzcGF0Y2guCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbEJpbmRpbmcjZXhlY3V0ZQogICAgKiBAcGFyYW0ge2FycmF5fSBbcGFyYW1zQXJyXSAtIEFycmF5IG9mIHBhcmFtZXRlcnMgdGhhdCBzaG91bGQgYmUgcGFzc2VkIHRvIHRoZSBsaXN0ZW5lci4KICAgICogQHJldHVybiB7YW55fSBWYWx1ZSByZXR1cm5lZCBieSB0aGUgbGlzdGVuZXIuCiAgICAqLwogICAgZXhlY3V0ZTogZnVuY3Rpb24gKHBhcmFtc0FycikgewoKICAgICAgICB2YXIgaGFuZGxlclJldHVybiwgcGFyYW1zOwoKICAgICAgICBpZiAodGhpcy5hY3RpdmUgJiYgISF0aGlzLl9saXN0ZW5lcikKICAgICAgICB7CiAgICAgICAgICAgIHBhcmFtcyA9IHRoaXMucGFyYW1zPyB0aGlzLnBhcmFtcy5jb25jYXQocGFyYW1zQXJyKSA6IHBhcmFtc0FycjsKICAgICAgICAgICAgaGFuZGxlclJldHVybiA9IHRoaXMuX2xpc3RlbmVyLmFwcGx5KHRoaXMuY29udGV4dCwgcGFyYW1zKTsKCiAgICAgICAgICAgIGlmICh0aGlzLl9pc09uY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZGV0YWNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBoYW5kbGVyUmV0dXJuOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERldGFjaCBiaW5kaW5nIGZyb20gc2lnbmFsLgogICAgKiBhbGlhcyB0bzogQHNlZSBteVNpZ25hbC5yZW1vdmUobXlCaW5kaW5nLmdldExpc3RlbmVyKCkpOwogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI2RldGFjaAogICAgKiBAcmV0dXJuIHtmdW5jdGlvbnxudWxsfSBIYW5kbGVyIGZ1bmN0aW9uIGJvdW5kIHRvIHRoZSBzaWduYWwgb3IgYG51bGxgIGlmIGJpbmRpbmcgd2FzIHByZXZpb3VzbHkgZGV0YWNoZWQuCiAgICAqLwogICAgZGV0YWNoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaXNCb3VuZCgpID8gdGhpcy5fc2lnbmFsLnJlbW92ZSh0aGlzLl9saXN0ZW5lciwgdGhpcy5jb250ZXh0KSA6IG51bGw7CiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI2lzQm91bmQKICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBiaW5kaW5nIGlzIHN0aWxsIGJvdW5kIHRvIHRoZSBzaWduYWwgYW5kIGhhcyBhIGxpc3RlbmVyLgogICAgKi8KICAgIGlzQm91bmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKCEhdGhpcy5fc2lnbmFsICYmICEhdGhpcy5fbGlzdGVuZXIpOwogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsQmluZGluZyNpc09uY2UKICAgICogQHJldHVybiB7Ym9vbGVhbn0gSWYgU2lnbmFsQmluZGluZyB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgb25jZS4KICAgICovCiAgICBpc09uY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5faXNPbmNlOwogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsQmluZGluZyNnZXRMaXN0ZW5lcgogICAgKiBAcmV0dXJuIHtGdW5jdGlvbn0gSGFuZGxlciBmdW5jdGlvbiBib3VuZCB0byB0aGUgc2lnbmFsLgogICAgKi8KICAgIGdldExpc3RlbmVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2xpc3RlbmVyOwogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsQmluZGluZyNnZXRTaWduYWwKICAgICogQHJldHVybiB7U2lnbmFsfSBTaWduYWwgdGhhdCBsaXN0ZW5lciBpcyBjdXJyZW50bHkgYm91bmQgdG8uCiAgICAqLwogICAgZ2V0U2lnbmFsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3NpZ25hbDsKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbEJpbmRpbmcjX2Rlc3Ryb3kKICAgICogRGVsZXRlIGluc3RhbmNlIHByb3BlcnRpZXMKICAgICogQHByaXZhdGUKICAgICovCiAgICBfZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9zaWduYWw7CiAgICAgICAgZGVsZXRlIHRoaXMuX2xpc3RlbmVyOwogICAgICAgIGRlbGV0ZSB0aGlzLmNvbnRleHQ7CiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI3RvU3RyaW5nCiAgICAqIEByZXR1cm4ge3N0cmluZ30gU3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBvYmplY3QuCiAgICAqLwogICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gJ1tQaGFzZXIuU2lnbmFsQmluZGluZyBpc09uY2U6JyArIHRoaXMuX2lzT25jZSArJywgaXNCb3VuZDonKyB0aGlzLmlzQm91bmQoKSArJywgYWN0aXZlOicgKyB0aGlzLmFjdGl2ZSArICddJzsKICAgIH0KCn07CgpQaGFzZXIuU2lnbmFsQmluZGluZy5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuU2lnbmFsQmluZGluZzsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKiAKKiBUaGlzIGlzIGEgYmFzZSBGaWx0ZXIgdGVtcGxhdGUgdG8gdXNlIGZvciBhbnkgUGhhc2VyIGZpbHRlciBkZXZlbG9wbWVudC4KKiAKKiBAY2xhc3MgUGhhc2VyLkZpbHRlcgoqIEBjbGFzc2Rlc2MgUGhhc2VyIC0gRmlsdGVyCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7T2JqZWN0fSB1bmlmb3JtcyAtIFVuaWZvcm0gbWFwcGluZ3Mgb2JqZWN0CiogQHBhcmFtIHtBcnJheX0gZnJhZ21lbnRTcmMgLSBUaGUgZnJhZ21lbnQgc2hhZGVyIGNvZGUuCiovClBoYXNlci5GaWx0ZXIgPSBmdW5jdGlvbiAoZ2FtZSwgdW5pZm9ybXMsIGZyYWdtZW50U3JjKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIFRoZSBjb25zdCB0eXBlIG9mIHRoaXMgb2JqZWN0LCBlaXRoZXIgUGhhc2VyLldFQkdMX0ZJTFRFUiBvciBQaGFzZXIuQ0FOVkFTX0ZJTFRFUi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnR5cGUgPSAgUGhhc2VyLldFQkdMX0ZJTFRFUjsKICAgIAogICAgLyoqCiAgICAqIEFuIGFycmF5IG9mIHBhc3NlcyAtIHNvbWUgZmlsdGVycyBjb250YWluIGEgZmV3IHN0ZXBzIHRoaXMgYXJyYXkgc2ltcGx5IHN0b3JlcyB0aGUgc3RlcHMgaW4gYSBsaW5lYXIgZmFzaGlvbi4KICAgICogRm9yIGV4YW1wbGUgdGhlIGJsdXIgZmlsdGVyIGhhcyB0d28gcGFzc2VzIGJsdXJYIGFuZCBibHVyWS4KICAgICogQHByb3BlcnR5IHthcnJheX0gcGFzc2VzIC0gQW4gYXJyYXkgb2YgZmlsdGVyIG9iamVjdHMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5wYXNzZXMgPSBbdGhpc107CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRpcnR5IC0gSW50ZXJuYWwgUElYSSB2YXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kaXJ0eSA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwYWRkaW5nIC0gSW50ZXJuYWwgUElYSSB2YXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYWRkaW5nID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IHVuaWZvcm1zIC0gRGVmYXVsdCB1bmlmb3JtIG1hcHBpbmdzLgogICAgKi8KICAgIHRoaXMudW5pZm9ybXMgPSB7CgogICAgICAgIHRpbWU6IHsgdHlwZTogJzFmJywgdmFsdWU6IDAgfSwKICAgICAgICByZXNvbHV0aW9uOiB7IHR5cGU6ICcyZicsIHZhbHVlOiB7IHg6IDI1NiwgeTogMjU2IH19LAogICAgICAgIG1vdXNlOiB7IHR5cGU6ICcyZicsIHZhbHVlOiB7IHg6IDAuMCwgeTogMC4wIH19CgogICAgfTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGZyYWdtZW50U3JjIC0gVGhlIGZyYWdtZW50IHNoYWRlciBjb2RlLgogICAgKi8KICAgIHRoaXMuZnJhZ21lbnRTcmMgPSBmcmFnbWVudFNyYyB8fCBbXTsKCn07CgpQaGFzZXIuRmlsdGVyLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogU2hvdWxkIGJlIG92ZXItcmlkZGVuLgogICAgKiBAbWV0aG9kIFBoYXNlci5GaWx0ZXIjaW5pdAogICAgKi8KICAgIGluaXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyAgVGhpcyBzaG91bGQgYmUgb3Zlci1yaWRkZW4uIFdpbGwgcmVjZWl2ZSBhIHZhcmlhYmxlIG51bWJlciBvZiBhcmd1bWVudHMuCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXQgdGhlIHJlc29sdXRpb24gdW5pZm9ybXMgb24gdGhlIGZpbHRlci4KICAgICogQG1ldGhvZCBQaGFzZXIuRmlsdGVyI3NldFJlc29sdXRpb24KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBkaXNwbGF5LgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgZGlzcGxheS4KICAgICovCiAgICBzZXRSZXNvbHV0aW9uOiBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewoKICAgICAgICB0aGlzLnVuaWZvcm1zLnJlc29sdXRpb24udmFsdWUueCA9IHdpZHRoOwogICAgICAgIHRoaXMudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZS55ID0gaGVpZ2h0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZXMgdGhlIGZpbHRlci4KICAgICogQG1ldGhvZCBQaGFzZXIuRmlsdGVyI3VwZGF0ZQogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBbcG9pbnRlcl0gLSBBIFBvaW50ZXIgb2JqZWN0IHRvIHVzZSBmb3IgdGhlIGZpbHRlci4gVGhlIGNvb3JkaW5hdGVzIGFyZSBtYXBwZWQgdG8gdGhlIG1vdXNlIHVuaWZvcm0uCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBpZiAodHlwZW9mIHBvaW50ZXIgIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHBvaW50ZXIueCA+IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudW5pZm9ybXMubW91c2UueCA9IHBvaW50ZXIueC50b0ZpeGVkKDIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocG9pbnRlci55ID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy5tb3VzZS55ID0gcG9pbnRlci55LnRvRml4ZWQoMik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMudW5pZm9ybXMudGltZS52YWx1ZSA9IHRoaXMuZ2FtZS50aW1lLnRvdGFsRWxhcHNlZFNlY29uZHMoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGVhciBkb3duIHRoaXMgRmlsdGVyIGFuZCBudWxsIG91dCByZWZlcmVuY2VzCiAgICAqIEBtZXRob2QgUGhhc2VyLkZpbHRlciNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmdhbWUgPSBudWxsOwogICAgICAgIAogICAgfQoKfTsKClBoYXNlci5GaWx0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkZpbHRlcjsKCi8qKgoqIEBuYW1lIFBoYXNlci5GaWx0ZXIjd2lkdGgKKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggKHJlc29sdXRpb24gdW5pZm9ybSkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5GaWx0ZXIucHJvdG90eXBlLCAnd2lkdGgnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5yZXNvbHV0aW9uLnZhbHVlLng7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnVuaWZvcm1zLnJlc29sdXRpb24udmFsdWUueCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuRmlsdGVyI2hlaWdodAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IChyZXNvbHV0aW9uIHVuaWZvcm0pCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuRmlsdGVyLnByb3RvdHlwZSwgJ2hlaWdodCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLnJlc29sdXRpb24udmFsdWUueTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZS55ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKiAKKiBUaGlzIGlzIGEgYmFzZSBQbHVnaW4gdGVtcGxhdGUgdG8gdXNlIGZvciBhbnkgUGhhc2VyIHBsdWdpbiBkZXZlbG9wbWVudC4KKiAKKiBAY2xhc3MgUGhhc2VyLlBsdWdpbgoqIEBjbGFzc2Rlc2MgUGhhc2VyIC0gUGx1Z2luCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7QW55fSBwYXJlbnQgLSBUaGUgb2JqZWN0IHRoYXQgb3ducyB0aGlzIHBsdWdpbiwgdXN1YWxseSBQaGFzZXIuUGx1Z2luTWFuYWdlci4KKi8KUGhhc2VyLlBsdWdpbiA9IGZ1bmN0aW9uIChnYW1lLCBwYXJlbnQpIHsKCiAgICBpZiAodHlwZW9mIHBhcmVudCA9PT0gJ3VuZGVmaW5lZCcpIHsgcGFyZW50ID0gbnVsbDsgfQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7QW55fSBwYXJlbnQgLSBUaGUgcGFyZW50IG9mIHRoaXMgcGx1Z2luLiBJZiBhZGRlZCB0byB0aGUgUGx1Z2luTWFuYWdlciB0aGUgcGFyZW50IHdpbGwgYmUgc2V0IHRvIHRoYXQsIG90aGVyd2lzZSBpdCB3aWxsIGJlIG51bGwuCiAgICAqLwogICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFjdGl2ZSAtIEEgUGx1Z2luIHdpdGggYWN0aXZlPXRydWUgaGFzIGl0cyBwcmVVcGRhdGUgYW5kIHVwZGF0ZSBtZXRob2RzIGNhbGxlZCBieSB0aGUgcGFyZW50LCBvdGhlcndpc2UgdGhleSBhcmUgc2tpcHBlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB2aXNpYmxlIC0gQSBQbHVnaW4gd2l0aCB2aXNpYmxlPXRydWUgaGFzIGl0cyByZW5kZXIgYW5kIHBvc3RSZW5kZXIgbWV0aG9kcyBjYWxsZWQgYnkgdGhlIHBhcmVudCwgb3RoZXJ3aXNlIHRoZXkgYXJlIHNraXBwZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy52aXNpYmxlID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc1ByZVVwZGF0ZSAtIEEgZmxhZyB0byBpbmRpY2F0ZSBpZiB0aGlzIHBsdWdpbiBoYXMgYSBwcmVVcGRhdGUgbWV0aG9kLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaGFzUHJlVXBkYXRlID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc1VwZGF0ZSAtIEEgZmxhZyB0byBpbmRpY2F0ZSBpZiB0aGlzIHBsdWdpbiBoYXMgYW4gdXBkYXRlIG1ldGhvZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmhhc1VwZGF0ZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc1Bvc3RVcGRhdGUgLSBBIGZsYWcgdG8gaW5kaWNhdGUgaWYgdGhpcyBwbHVnaW4gaGFzIGEgcG9zdFVwZGF0ZSBtZXRob2QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5oYXNQb3N0VXBkYXRlID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc1JlbmRlciAtIEEgZmxhZyB0byBpbmRpY2F0ZSBpZiB0aGlzIHBsdWdpbiBoYXMgYSByZW5kZXIgbWV0aG9kLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaGFzUmVuZGVyID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc1Bvc3RSZW5kZXIgLSBBIGZsYWcgdG8gaW5kaWNhdGUgaWYgdGhpcyBwbHVnaW4gaGFzIGEgcG9zdFJlbmRlciBtZXRob2QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5oYXNQb3N0UmVuZGVyID0gZmFsc2U7Cgp9OwoKUGhhc2VyLlBsdWdpbi5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFByZS11cGRhdGUgaXMgY2FsbGVkIGF0IHRoZSB2ZXJ5IHN0YXJ0IG9mIHRoZSB1cGRhdGUgY3ljbGUsIGJlZm9yZSBhbnkgb3RoZXIgc3Vic3lzdGVtcyBoYXZlIGJlZW4gdXBkYXRlZCAoaW5jbHVkaW5nIFBoeXNpY3MpLgogICAgKiBJdCBpcyBvbmx5IGNhbGxlZCBpZiBhY3RpdmUgaXMgc2V0IHRvIHRydWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbiNwcmVVcGRhdGUKICAgICovCiAgICBwcmVVcGRhdGU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZSBpcyBjYWxsZWQgYWZ0ZXIgYWxsIHRoZSBjb3JlIHN1YnN5c3RlbXMgKElucHV0LCBUd2VlbnMsIFNvdW5kLCBldGMpIGFuZCB0aGUgU3RhdGUgaGF2ZSB1cGRhdGVkLCBidXQgYmVmb3JlIHRoZSByZW5kZXIuCiAgICAqIEl0IGlzIG9ubHkgY2FsbGVkIGlmIGFjdGl2ZSBpcyBzZXQgdG8gdHJ1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luI3VwZGF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVyIGlzIGNhbGxlZCByaWdodCBhZnRlciB0aGUgR2FtZSBSZW5kZXJlciBjb21wbGV0ZXMsIGJ1dCBiZWZvcmUgdGhlIFN0YXRlLnJlbmRlci4KICAgICogSXQgaXMgb25seSBjYWxsZWQgaWYgdmlzaWJsZSBpcyBzZXQgdG8gdHJ1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luI3JlbmRlcgogICAgKi8KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogUG9zdC1yZW5kZXIgaXMgY2FsbGVkIGFmdGVyIHRoZSBHYW1lIFJlbmRlcmVyIGFuZCBTdGF0ZS5yZW5kZXIgaGF2ZSBydW4uCiAgICAqIEl0IGlzIG9ubHkgY2FsbGVkIGlmIHZpc2libGUgaXMgc2V0IHRvIHRydWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbiNwb3N0UmVuZGVyCiAgICAqLwogICAgcG9zdFJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogQ2xlYXIgZG93biB0aGlzIFBsdWdpbiBhbmQgbnVsbCBvdXQgcmVmZXJlbmNlcwogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW4jZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5nYW1lID0gbnVsbDsKICAgICAgICB0aGlzLnBhcmVudCA9IG51bGw7CiAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICB0aGlzLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAKICAgIH0KCn07CgpQaGFzZXIuUGx1Z2luLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5QbHVnaW47CgovKiBqc2hpbnQgbmV3Y2FwOiBmYWxzZSAqLwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqIAoqIFRoZSBQbHVnaW4gTWFuYWdlciBpcyByZXNwb25zaWJsZSBmb3IgdGhlIGxvYWRpbmcsIHJ1bm5pbmcgYW5kIHVubG9hZGluZyBvZiBQaGFzZXIgUGx1Z2lucy4KKiAKKiBAY2xhc3MgUGhhc2VyLlBsdWdpbk1hbmFnZXIKKiBAY2xhc3NkZXNjIFBoYXNlciAtIFBsdWdpbk1hbmFnZXIKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtEZXNjcmlwdGlvbn0gcGFyZW50IC0gRGVzY3JpcHRpb24uCiovClBoYXNlci5QbHVnaW5NYW5hZ2VyID0gZnVuY3Rpb24oZ2FtZSwgcGFyZW50KSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX3BhcmVudCAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3BhcmVudCA9IHBhcmVudDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IHBsdWdpbnMgLSBEZXNjcmlwdGlvbi4KICAgICovCiAgICB0aGlzLnBsdWdpbnMgPSBbXTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IF9wbHVnaW5zTGVuZ3RoIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fcGx1Z2luc0xlbmd0aCA9IDA7Cgp9OwoKUGhhc2VyLlBsdWdpbk1hbmFnZXIucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgUGx1Z2luIHRvIHRoZSBQbHVnaW5NYW5hZ2VyLgogICAgKiBUaGUgcGx1Z2luJ3MgZ2FtZSBhbmQgcGFyZW50IHJlZmVyZW5jZSBhcmUgc2V0IHRvIHRoaXMgZ2FtZSBhbmQgcGx1Z2lubWFuYWdlciBwYXJlbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbk1hbmFnZXIjYWRkCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBsdWdpbn0gcGx1Z2luIC0gRGVzY3JpcHRpb24uCiAgICAqIEByZXR1cm4ge1BoYXNlci5QbHVnaW59IERlc2NyaXB0aW9uLgogICAgKi8KICAgIGFkZDogZnVuY3Rpb24gKHBsdWdpbikgewoKICAgICAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CgogICAgICAgIC8vICBQcm90b3R5cGU/CiAgICAgICAgaWYgKHR5cGVvZiBwbHVnaW4gPT09ICdmdW5jdGlvbicpCiAgICAgICAgewogICAgICAgICAgICBwbHVnaW4gPSBuZXcgcGx1Z2luKHRoaXMuZ2FtZSwgdGhpcy5fcGFyZW50KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcGx1Z2luLmdhbWUgPSB0aGlzLmdhbWU7CiAgICAgICAgICAgIHBsdWdpbi5wYXJlbnQgPSB0aGlzLl9wYXJlbnQ7CiAgICAgICAgfQoKICAgICAgICAvLyAgQ2hlY2sgZm9yIG1ldGhvZHMgbm93IHRvIGF2b2lkIGhhdmluZyB0byBkbyB0aGlzIGV2ZXJ5IGxvb3AKICAgICAgICBpZiAodHlwZW9mIHBsdWdpblsncHJlVXBkYXRlJ10gPT09ICdmdW5jdGlvbicpCiAgICAgICAgewogICAgICAgICAgICBwbHVnaW4uaGFzUHJlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgcmVzdWx0ID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgcGx1Z2luWyd1cGRhdGUnXSA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICB7CiAgICAgICAgICAgIHBsdWdpbi5oYXNVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICByZXN1bHQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBwbHVnaW5bJ3Bvc3RVcGRhdGUnXSA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICB7CiAgICAgICAgICAgIHBsdWdpbi5oYXNQb3N0VXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgcmVzdWx0ID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgcGx1Z2luWydyZW5kZXInXSA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICB7CiAgICAgICAgICAgIHBsdWdpbi5oYXNSZW5kZXIgPSB0cnVlOwogICAgICAgICAgICByZXN1bHQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBwbHVnaW5bJ3Bvc3RSZW5kZXInXSA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICB7CiAgICAgICAgICAgIHBsdWdpbi5oYXNQb3N0UmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgcmVzdWx0ID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIC8vICBUaGUgcGx1Z2luIG11c3QgaGF2ZSBhdCBsZWFzdCBvbmUgb2YgdGhlIGFib3ZlIGZ1bmN0aW9ucyB0byBiZSBhZGRlZCB0byB0aGUgUGx1Z2luTWFuYWdlci4KICAgICAgICBpZiAocmVzdWx0KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHBsdWdpbi5oYXNQcmVVcGRhdGUgfHwgcGx1Z2luLmhhc1VwZGF0ZSB8fCBwbHVnaW4uaGFzUG9zdFVwZGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcGx1Z2luLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChwbHVnaW4uaGFzUmVuZGVyIHx8IHBsdWdpbi5oYXNQb3N0UmVuZGVyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwbHVnaW4udmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3BsdWdpbnNMZW5ndGggPSB0aGlzLnBsdWdpbnMucHVzaChwbHVnaW4pOwoKICAgICAgICAgICAgLy8gQWxsb3dzIHBsdWdpbnMgdG8gcnVuIHBvdGVudGlhbGx5IGRlc3RydWN0aXZlIGNvZGUgb3V0c2lkZSBvZiB0aGUgY29uc3RydWN0b3IsIGFuZCBvbmx5IGlmIGJlaW5nIGFkZGVkIHRvIHRoZSBQbHVnaW5NYW5hZ2VyCiAgICAgICAgICAgIGlmICh0eXBlb2YgcGx1Z2luWydpbml0J10gPT09ICdmdW5jdGlvbicpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHBsdWdpbi5pbml0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBwbHVnaW47CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZSBhIFBsdWdpbiBmcm9tIHRoZSBQbHVnaW5NYW5hZ2VyLgogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI3JlbW92ZQogICAgKiBAcGFyYW0ge1BoYXNlci5QbHVnaW59IHBsdWdpbiAtIFRoZSBwbHVnaW4gdG8gYmUgcmVtb3ZlZC4KICAgICovCiAgICByZW1vdmU6IGZ1bmN0aW9uIChwbHVnaW4pIHsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5fcGx1Z2luc0xlbmd0aCA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodGhpcy5fcCA9IDA7IHRoaXMuX3AgPCB0aGlzLl9wbHVnaW5zTGVuZ3RoOyB0aGlzLl9wKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5wbHVnaW5zW3RoaXMuX3BdID09PSBwbHVnaW4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHBsdWdpbi5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbnMuc3BsaWNlKHRoaXMuX3AsIDEpOwogICAgICAgICAgICAgICAgdGhpcy5fcGx1Z2luc0xlbmd0aC0tOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlcyBhbGwgUGx1Z2lucyBmcm9tIHRoZSBQbHVnaW5NYW5hZ2VyLgogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI3JlbW92ZUFsbAogICAgKi8KICAgIHJlbW92ZUFsbDogZnVuY3Rpb24oKSB7CiAgICAgICAgCiAgICAgICAgZm9yICh0aGlzLl9wID0gMDsgdGhpcy5fcCA8IHRoaXMuX3BsdWdpbnNMZW5ndGg7IHRoaXMuX3ArKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5kZXN0cm95KCk7CiAgICAgICAgfQogICAgICAgIHRoaXMucGx1Z2lucy5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuX3BsdWdpbnNMZW5ndGggPSAwOwogICAgfSwKCiAgICAvKioKICAgICogUHJlLXVwZGF0ZSBpcyBjYWxsZWQgYXQgdGhlIHZlcnkgc3RhcnQgb2YgdGhlIHVwZGF0ZSBjeWNsZSwgYmVmb3JlIGFueSBvdGhlciBzdWJzeXN0ZW1zIGhhdmUgYmVlbiB1cGRhdGVkIChpbmNsdWRpbmcgUGh5c2ljcykuCiAgICAqIEl0IG9ubHkgY2FsbHMgcGx1Z2lucyB3aG8gaGF2ZSBhY3RpdmU9dHJ1ZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbk1hbmFnZXIjcHJlVXBkYXRlCiAgICAqLwogICAgcHJlVXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9wbHVnaW5zTGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh0aGlzLl9wID0gMDsgdGhpcy5fcCA8IHRoaXMuX3BsdWdpbnNMZW5ndGg7IHRoaXMuX3ArKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnBsdWdpbnNbdGhpcy5fcF0uYWN0aXZlICYmIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5oYXNQcmVVcGRhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5wcmVVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGUgaXMgY2FsbGVkIGFmdGVyIGFsbCB0aGUgY29yZSBzdWJzeXN0ZW1zIChJbnB1dCwgVHdlZW5zLCBTb3VuZCwgZXRjKSBhbmQgdGhlIFN0YXRlIGhhdmUgdXBkYXRlZCwgYnV0IGJlZm9yZSB0aGUgcmVuZGVyLgogICAgKiBJdCBvbmx5IGNhbGxzIHBsdWdpbnMgd2hvIGhhdmUgYWN0aXZlPXRydWUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI3VwZGF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewogICAgICAgIAogICAgICAgIGlmICh0aGlzLl9wbHVnaW5zTGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh0aGlzLl9wID0gMDsgdGhpcy5fcCA8IHRoaXMuX3BsdWdpbnNMZW5ndGg7IHRoaXMuX3ArKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnBsdWdpbnNbdGhpcy5fcF0uYWN0aXZlICYmIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5oYXNVcGRhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucGx1Z2luc1t0aGlzLl9wXS51cGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBQb3N0VXBkYXRlIGlzIHRoZSBsYXN0IHRoaW5nIHRvIGJlIGNhbGxlZCBiZWZvcmUgdGhlIHdvcmxkIHJlbmRlci4KICAgICogSW4gcGFydGljdWxhciwgaXQgaXMgY2FsbGVkIGFmdGVyIHRoZSB3b3JsZCBwb3N0VXBkYXRlLCB3aGljaCBtZWFucyB0aGUgY2FtZXJhIGhhcyBiZWVuIGFkanVzdGVkLgogICAgKiBJdCBvbmx5IGNhbGxzIHBsdWdpbnMgd2hvIGhhdmUgYWN0aXZlPXRydWUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI3Bvc3RVcGRhdGUKICAgICovCiAgICBwb3N0VXBkYXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuX3BsdWdpbnNMZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKHRoaXMuX3AgPSAwOyB0aGlzLl9wIDwgdGhpcy5fcGx1Z2luc0xlbmd0aDsgdGhpcy5fcCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMucGx1Z2luc1t0aGlzLl9wXS5hY3RpdmUgJiYgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLmhhc1Bvc3RVcGRhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5wb3N0VXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVyIGlzIGNhbGxlZCByaWdodCBhZnRlciB0aGUgR2FtZSBSZW5kZXJlciBjb21wbGV0ZXMsIGJ1dCBiZWZvcmUgdGhlIFN0YXRlLnJlbmRlci4KICAgICogSXQgb25seSBjYWxscyBwbHVnaW5zIHdobyBoYXZlIHZpc2libGU9dHJ1ZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbk1hbmFnZXIjcmVuZGVyCiAgICAqLwogICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9wbHVnaW5zTGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh0aGlzLl9wID0gMDsgdGhpcy5fcCA8IHRoaXMuX3BsdWdpbnNMZW5ndGg7IHRoaXMuX3ArKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnBsdWdpbnNbdGhpcy5fcF0udmlzaWJsZSAmJiB0aGlzLnBsdWdpbnNbdGhpcy5fcF0uaGFzUmVuZGVyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbnNbdGhpcy5fcF0ucmVuZGVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUG9zdC1yZW5kZXIgaXMgY2FsbGVkIGFmdGVyIHRoZSBHYW1lIFJlbmRlcmVyIGFuZCBTdGF0ZS5yZW5kZXIgaGF2ZSBydW4uCiAgICAqIEl0IG9ubHkgY2FsbHMgcGx1Z2lucyB3aG8gaGF2ZSB2aXNpYmxlPXRydWUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI3Bvc3RSZW5kZXIKICAgICovCiAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9wbHVnaW5zTGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh0aGlzLl9wID0gMDsgdGhpcy5fcCA8IHRoaXMuX3BsdWdpbnNMZW5ndGg7IHRoaXMuX3ArKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnBsdWdpbnNbdGhpcy5fcF0udmlzaWJsZSAmJiB0aGlzLnBsdWdpbnNbdGhpcy5fcF0uaGFzUG9zdFJlbmRlcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLnBvc3RSZW5kZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGVhciBkb3duIHRoaXMgUGx1Z2luTWFuYWdlciBhbmQgbnVsbCBvdXQgcmVmZXJlbmNlcwogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luTWFuYWdlciNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnBsdWdpbnMubGVuZ3RoID0gMDsKICAgICAgICB0aGlzLl9wbHVnaW5zTGVuZ3RoID0gMDsKICAgICAgICB0aGlzLmdhbWUgPSBudWxsOwogICAgICAgIHRoaXMuX3BhcmVudCA9IG51bGw7CgogICAgfQoKfTsKClBoYXNlci5QbHVnaW5NYW5hZ2VyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5QbHVnaW5NYW5hZ2VyOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIFN0YWdlIGNvbnRyb2xzIHRoZSBjYW52YXMgb24gd2hpY2ggZXZlcnl0aGluZyBpcyBkaXNwbGF5ZWQuIEl0IGhhbmRsZXMgZGlzcGxheSB3aXRoaW4gdGhlIGJyb3dzZXIsCiogZm9jdXMgaGFuZGxpbmcsIGdhbWUgcmVzaXppbmcsIHNjYWxpbmcgYW5kIHRoZSBwYXVzZSwgYm9vdCBhbmQgb3JpZW50YXRpb24gc2NyZWVucy4KKgoqIEBjbGFzcyBQaGFzZXIuU3RhZ2UKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gR2FtZSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gV2lkdGggb2YgdGhlIGNhbnZhcyBlbGVtZW50LgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBIZWlnaHQgb2YgdGhlIGNhbnZhcyBlbGVtZW50LgogKi8KUGhhc2VyLlN0YWdlID0gZnVuY3Rpb24gKGdhbWUsIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBnYW1lIC0gQmFja2dyb3VuZCBjb2xvciBvZiB0aGUgc3RhZ2UgKGRlZmF1bHRzIHRvIGJsYWNrKS4gU2V0IHZpYSB0aGUgcHVibGljIGJhY2tncm91bmRDb2xvciBwcm9wZXJ0eS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9iYWNrZ3JvdW5kQ29sb3IgPSAncmdiKDAsMCwwKSc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBvZmZzZXQgLSBHZXQgdGhlIG9mZnNldCB2YWx1ZXMgKGZvciBpbnB1dCBhbmQgb3RoZXIgdGhpbmdzKS4KICAgICovCiAgICB0aGlzLm9mZnNldCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIFJlZmVyZW5jZSB0byB0aGUgbmV3bHkgY3JlYXRlZCBgY2FudmFzYCBlbGVtZW50LgogICAgKi8KICAgIHRoaXMuY2FudmFzID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UElYSS5TdGFnZX0gX3N0YWdlIC0gVGhlIFBpeGkgU3RhZ2Ugd2hpY2ggaXMgaG9va2VkIHRvIHRoZSByZW5kZXJlci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9zdGFnZSA9IG5ldyBQSVhJLlN0YWdlKDB4MDAwMDAwLCBmYWxzZSk7CiAgICB0aGlzLl9zdGFnZS5uYW1lID0gJ19zdGFnZV9yb290JzsKICAgIHRoaXMuX3N0YWdlLmludGVyYWN0aXZlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UElYSS5TdGFnZX0gZGlzcGxheSAtIFRoZSBQaXhpIFN0YWdlIHdoaWNoIGlzIGhvb2tlZCB0byB0aGUgcmVuZGVyZXIuCiAgICAqLwogICAgdGhpcy5kaXNwbGF5ID0gdGhpcy5fc3RhZ2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzY2FsZU1vZGUgLSBUaGUgY3VycmVudCBzY2FsZU1vZGUuCiAgICAqLwogICAgdGhpcy5zY2FsZU1vZGUgPSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuTk9fU0NBTEU7CgogICAgLyoKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGZ1bGxTY3JlZW5TY2FsZU1vZGUgLSBTY2FsZSBtb2RlIHRvIGJlIHVzZWQgaW4gZnVsbFNjcmVlbgogICAgICovCiAgICB0aGlzLmZ1bGxTY3JlZW5TY2FsZU1vZGUgPSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuTk9fU0NBTEU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlN0YWdlU2NhbGVNb2RlfSBzY2FsZSAtIFRoZSBzY2FsZSBvZiB0aGUgY3VycmVudCBydW5uaW5nIGdhbWUuCiAgICAqLwogICAgdGhpcy5zY2FsZSA9IG5ldyBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUodGhpcy5nYW1lLCB3aWR0aCwgaGVpZ2h0KTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGFzcGVjdFJhdGlvIC0gQXNwZWN0IHJhdGlvLgogICAgKi8KICAgIHRoaXMuYXNwZWN0UmF0aW8gPSB3aWR0aCAvIGhlaWdodDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBkaXNhYmxlVmlzaWJpbGl0eUNoYW5nZSAtIEJ5IGRlZmF1bHQgaWYgdGhlIGJyb3dzZXIgdGFiIGxvc2VzIGZvY3VzIHRoZSBnYW1lIHdpbGwgcGF1c2UuIFlvdSBjYW4gc3RvcCB0aGF0IGJlaGF2aW91ciBieSBzZXR0aW5nIHRoaXMgcHJvcGVydHkgdG8gdHJ1ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmRpc2FibGVWaXNpYmlsaXR5Q2hhbmdlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfbmV4dE9mZnNldENoZWNrIC0gVGhlIHRpbWUgdG8gcnVuIHRoZSBuZXh0IG9mZnNldCBjaGVjay4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9uZXh0T2Zmc2V0Q2hlY2sgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcnxmYWxzZX0gY2hlY2tPZmZzZXRJbnRlcnZhbCAtIFRoZSB0aW1lIChpbiBtcykgYmV0d2VlbiB3aGljaCB0aGUgc3RhZ2Ugc2hvdWxkIGNoZWNrIHRvIHNlZSBpZiBpdCBoYXMgbW92ZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jaGVja09mZnNldEludGVydmFsID0gMjUwMDsKCiAgICBpZiAoZ2FtZS5jb25maWcpCiAgICB7CiAgICAgICAgdGhpcy5wYXJzZUNvbmZpZyhnYW1lLmNvbmZpZyk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5jYW52YXMgPSBQaGFzZXIuQ2FudmFzLmNyZWF0ZSh3aWR0aCwgaGVpZ2h0KTsKICAgICAgICB0aGlzLmNhbnZhcy5zdHlsZVsnLXdlYmtpdC1mdWxsLXNjcmVlbiddID0gJ3dpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCUnOwogICAgfQoKfTsKClBoYXNlci5TdGFnZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFBhcnNlcyBhIEdhbWUgY29uZmlndXJhdGlvbiBvYmplY3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlI3BhcnNlQ29uZmlnCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwYXJzZUNvbmZpZzogZnVuY3Rpb24gKGNvbmZpZykgewoKICAgICAgICBpZiAoY29uZmlnWydjYW52YXNJRCddKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jYW52YXMgPSBQaGFzZXIuQ2FudmFzLmNyZWF0ZSh0aGlzLmdhbWUud2lkdGgsIHRoaXMuZ2FtZS5oZWlnaHQsIGNvbmZpZ1snY2FudmFzSUQnXSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2FudmFzID0gUGhhc2VyLkNhbnZhcy5jcmVhdGUodGhpcy5nYW1lLndpZHRoLCB0aGlzLmdhbWUuaGVpZ2h0KTsKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWdbJ2NhbnZhc1N0eWxlJ10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNhbnZhcy5zdGx5ZSA9IGNvbmZpZ1snY2FudmFzU3R5bGUnXTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jYW52YXMuc3R5bGVbJy13ZWJraXQtZnVsbC1zY3JlZW4nXSA9ICd3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlJzsKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWdbJ2NoZWNrT2Zmc2V0SW50ZXJ2YWwnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tPZmZzZXRJbnRlcnZhbCA9IGNvbmZpZ1snY2hlY2tPZmZzZXRJbnRlcnZhbCddOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZ1snZGlzYWJsZVZpc2liaWxpdHlDaGFuZ2UnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZGlzYWJsZVZpc2liaWxpdHlDaGFuZ2UgPSBjb25maWdbJ2Rpc2FibGVWaXNpYmlsaXR5Q2hhbmdlJ107CiAgICAgICAgfQoKICAgICAgICBpZiAoY29uZmlnWydmdWxsU2NyZWVuU2NhbGVNb2RlJ10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZ1bGxTY3JlZW5TY2FsZU1vZGUgPSBjb25maWdbJ2Z1bGxTY3JlZW5TY2FsZU1vZGUnXTsKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWdbJ3NjYWxlTW9kZSddKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zY2FsZU1vZGUgPSBjb25maWdbJ3NjYWxlTW9kZSddOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZ1snYmFja2dyb3VuZENvbG9yJ10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJhY2tncm91bmRDb2xvciA9IGNvbmZpZ1snYmFja2dyb3VuZENvbG9yJ107CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEluaXRpYWxpc2VzIHRoZSBzdGFnZSBhbmQgYWRkcyB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZSNib290CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgYm9vdDogZnVuY3Rpb24gKCkgewoKICAgICAgICBQaGFzZXIuQ2FudmFzLmdldE9mZnNldCh0aGlzLmNhbnZhcywgdGhpcy5vZmZzZXQpOwoKICAgICAgICB0aGlzLmJvdW5kcyA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKHRoaXMub2Zmc2V0LngsIHRoaXMub2Zmc2V0LnksIHRoaXMuZ2FtZS53aWR0aCwgdGhpcy5nYW1lLmhlaWdodCk7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHRoaXMuX29uQ2hhbmdlID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBfdGhpcy52aXNpYmlsaXR5Q2hhbmdlKGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIFBoYXNlci5DYW52YXMuc2V0VXNlclNlbGVjdCh0aGlzLmNhbnZhcywgJ25vbmUnKTsKICAgICAgICBQaGFzZXIuQ2FudmFzLnNldFRvdWNoQWN0aW9uKHRoaXMuY2FudmFzLCAnbm9uZScpOwoKICAgICAgICB0aGlzLmJhY2tncm91bmRDb2xvciA9ICcjMDAwJzsKCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndmlzaWJpbGl0eWNoYW5nZScsIHRoaXMuX29uQ2hhbmdlLCBmYWxzZSk7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignd2Via2l0dmlzaWJpbGl0eWNoYW5nZScsIHRoaXMuX29uQ2hhbmdlLCBmYWxzZSk7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigncGFnZWhpZGUnLCB0aGlzLl9vbkNoYW5nZSwgZmFsc2UpOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3BhZ2VzaG93JywgdGhpcy5fb25DaGFuZ2UsIGZhbHNlKTsKCiAgICAgICAgd2luZG93Lm9uYmx1ciA9IHRoaXMuX29uQ2hhbmdlOwogICAgICAgIHdpbmRvdy5vbmZvY3VzID0gdGhpcy5fb25DaGFuZ2U7CgogICAgfSwKCiAgICAvKioKICAgICogUnVucyBTdGFnZSBwcm9jZXNzZXMgdGhhdCBuZWVkIHBlcmlvZGljIHVwZGF0ZXMsIHN1Y2ggYXMgdGhlIG9mZnNldCBjaGVja3MuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlI3VwZGF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5jaGVja09mZnNldEludGVydmFsICE9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGltZS5ub3cgPiB0aGlzLl9uZXh0T2Zmc2V0Q2hlY2spCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIFBoYXNlci5DYW52YXMuZ2V0T2Zmc2V0KHRoaXMuY2FudmFzLCB0aGlzLm9mZnNldCk7CiAgICAgICAgICAgICAgICB0aGlzLl9uZXh0T2Zmc2V0Q2hlY2sgPSB0aGlzLmdhbWUudGltZS5ub3cgKyB0aGlzLmNoZWNrT2Zmc2V0SW50ZXJ2YWw7CiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCB3aGVuIHRoZSBkb2N1bWVudCB2aXNpYmlsaXR5IGlzIGNoYW5nZWQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlI3Zpc2liaWxpdHlDaGFuZ2UKICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgLSBJdHMgdHlwZSB3aWxsIGJlIHVzZWQgdG8gZGVjaWRlIHdoZXRoZXIgdGhlIGdhbWUgc2hvdWxkIGJlIHBhdXNlZCBvciBub3QuCiAgICAqLwogICAgdmlzaWJpbGl0eUNoYW5nZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLmRpc2FibGVWaXNpYmlsaXR5Q2hhbmdlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXVzZWQgPT09IGZhbHNlICYmIChldmVudC50eXBlID09ICdwYWdlaGlkZScgfHwgZXZlbnQudHlwZSA9PSAnYmx1cicgfHwgZG9jdW1lbnRbJ2hpZGRlbiddID09PSB0cnVlIHx8IGRvY3VtZW50Wyd3ZWJraXRIaWRkZW4nXSA9PT0gdHJ1ZSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUucGF1c2VkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLnBhdXNlZCA9IGZhbHNlOwogICAgICAgIH0KCiAgICB9Cgp9OwoKUGhhc2VyLlN0YWdlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5TdGFnZTsKCi8qKgoqIEBuYW1lIFBoYXNlci5TdGFnZSNiYWNrZ3JvdW5kQ29sb3IKKiBAcHJvcGVydHkge251bWJlcnxzdHJpbmd9IGJhY2tncm91bmRDb2xvciAtIEdldHMgYW5kIHNldHMgdGhlIGJhY2tncm91bmQgY29sb3Igb2YgdGhlIHN0YWdlLiBUaGUgY29sb3IgY2FuIGJlIGdpdmVuIGFzIGEgbnVtYmVyOiAweGZmMDAwMCBvciBhIGhleCBzdHJpbmc6ICcjZmYwMDAwJwoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlN0YWdlLnByb3RvdHlwZSwgImJhY2tncm91bmRDb2xvciIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYmFja2dyb3VuZENvbG9yOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uIChjb2xvcikgewoKICAgICAgICB0aGlzLl9iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvcjsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS50cmFuc3BhcmVudCA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnJlbmRlclR5cGUgPT0gUGhhc2VyLkNBTlZBUykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFNldCBpdCBkaXJlY3RseSwgdGhpcyBhbGxvd3MgdXMgdG8gdXNlIHJnYiBhbHBoYSB2YWx1ZXMgaW4gQ2FudmFzIG1vZGUuCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb2xvciA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSBQaGFzZXIuQ29sb3IuaGV4VG9SR0IoY29sb3IpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuX3N0YWdlLnNldEJhY2tncm91bmRDb2xvcihjb2xvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyIEdyb3VwIGNvbnN0cnVjdG9yLgoqIEBjbGFzcyBQaGFzZXIuR3JvdXAKKiBAY2xhc3NkZXNjIEEgR3JvdXAgaXMgYSBjb250YWluZXIgZm9yIGRpc3BsYXkgb2JqZWN0cyB0aGF0IGFsbG93cyBmb3IgZmFzdCBwb29saW5nLCByZWN5Y2xpbmcgYW5kIGNvbGxpc2lvbiBjaGVja3MuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7Kn0gcGFyZW50IC0gVGhlIHBhcmVudCBHcm91cCBvciBEaXNwbGF5T2JqZWN0Q29udGFpbmVyIHRoYXQgd2lsbCBob2xkIHRoaXMgZ3JvdXAsIGlmIGFueS4gSWYgdW5kZWZpbmVkIGl0IHdpbGwgdXNlIGdhbWUud29ybGQuCiogQHBhcmFtIHtzdHJpbmd9IFtuYW1lPWdyb3VwXSAtIEEgbmFtZSBmb3IgdGhpcyBHcm91cC4gTm90IHVzZWQgaW50ZXJuYWxseSBidXQgdXNlZnVsIGZvciBkZWJ1Z2dpbmcuCiogQHBhcmFtIHtib29sZWFufSBbdXNlU3RhZ2U9ZmFsc2VdIC0gU2hvdWxkIHRoZSBEaXNwbGF5T2JqZWN0Q29udGFpbmVyIHRoaXMgR3JvdXAgY3JlYXRlcyBiZSBhZGRlZCB0byB0aGUgV29ybGQgKGRlZmF1bHQsIGZhbHNlKSBvciBkaXJlY3QgdG8gdGhlIFN0YWdlICh0cnVlKS4KKi8KUGhhc2VyLkdyb3VwID0gZnVuY3Rpb24gKGdhbWUsIHBhcmVudCwgbmFtZSwgdXNlU3RhZ2UpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgaWYgKHR5cGVvZiBwYXJlbnQgPT09ICd1bmRlZmluZWQnKQogICAgewogICAgICAgIHBhcmVudCA9IGdhbWUud29ybGQ7CiAgICB9CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gQSBuYW1lIGZvciB0aGlzIEdyb3VwLiBOb3QgdXNlZCBpbnRlcm5hbGx5IGJ1dCB1c2VmdWwgZm9yIGRlYnVnZ2luZy4KICAgICovCiAgICB0aGlzLm5hbWUgPSBuYW1lIHx8ICdncm91cCc7CgogICAgaWYgKHR5cGVvZiB1c2VTdGFnZSA9PT0gJ3VuZGVmaW5lZCcpCiAgICB7CiAgICAgICAgdXNlU3RhZ2UgPSBmYWxzZTsKICAgIH0KCiAgICBpZiAodXNlU3RhZ2UpCiAgICB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyID0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLl9jb250YWluZXIgPSBuZXcgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyKCk7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLm5hbWUgPSB0aGlzLm5hbWU7CgogICAgICAgIGlmIChwYXJlbnQpCiAgICAgICAgewogICAgICAgICAgICBpZiAocGFyZW50IGluc3RhbmNlb2YgUGhhc2VyLkdyb3VwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwYXJlbnQuX2NvbnRhaW5lci5hZGRDaGlsZCh0aGlzLl9jb250YWluZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcGFyZW50LmFkZENoaWxkKHRoaXMuX2NvbnRhaW5lcik7CiAgICAgICAgICAgICAgICBwYXJlbnQudXBkYXRlVHJhbnNmb3JtKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5hZGRDaGlsZCh0aGlzLl9jb250YWluZXIpOwogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLnVwZGF0ZVRyYW5zZm9ybSgpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBJbnRlcm5hbCBQaGFzZXIgVHlwZSB2YWx1ZS4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHRoaXMudHlwZSA9IFBoYXNlci5HUk9VUDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhbGl2ZSAtIFRoZSBhbGl2ZSBwcm9wZXJ0eSBpcyB1c2VmdWwgZm9yIEdyb3VwcyB0aGF0IGFyZSBjaGlsZHJlbiBvZiBvdGhlciBHcm91cHMgYW5kIG5lZWQgdG8gYmUgaW5jbHVkZWQvZXhjbHVkZWQgaW4gY2hlY2tzIGxpa2UgZm9yRWFjaEFsaXZlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYWxpdmUgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGV4aXN0cyAtIElmIGV4aXN0cyBpcyB0cnVlIHRoZSB0aGUgR3JvdXAgaXMgdXBkYXRlZCwgb3RoZXJ3aXNlIGl0IGlzIHNraXBwZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Hcm91cH0gZ3JvdXAgLSBUaGUgcGFyZW50IEdyb3VwIG9mIHRoaXMgR3JvdXAsIGlmIGEgY2hpbGQgb2YgYW5vdGhlci4KICAgICovCiAgICB0aGlzLmdyb3VwID0gbnVsbDsKCiAgICAvLyAgUmVwbGFjZXMgdGhlIFBJWEkuUG9pbnQgd2l0aCBhIHNsaWdodGx5IG1vcmUgZmxleGlibGUgb25lLgogICAgdGhpcy5fY29udGFpbmVyLnNjYWxlID0gbmV3IFBoYXNlci5Qb2ludCgxLCAxKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHNjYWxlIC0gVGhlIHNjYW5lIG9mIHRoZSBHcm91cCBjb250YWluZXIuCiAgICAqLwogICAgdGhpcy5zY2FsZSA9IHRoaXMuX2NvbnRhaW5lci5zY2FsZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHBpdm90IC0gVGhlIHBpdm90IHBvaW50IG9mIHRoZSBHcm91cCBjb250YWluZXIuCiAgICAqLwogICAgdGhpcy5waXZvdCA9IHRoaXMuX2NvbnRhaW5lci5waXZvdDsKCiAgICAvKioKICAgICogVGhlIGN1cnNvciBpcyBhIHNpbXBsZSB3YXkgdG8gaXRlcmF0ZSB0aHJvdWdoIHRoZSBvYmplY3RzIGluIGEgR3JvdXAgdXNpbmcgdGhlIEdyb3VwLm5leHQgYW5kIEdyb3VwLnByZXZpb3VzIGZ1bmN0aW9ucy4KICAgICogVGhlIGN1cnNvciBpcyBzZXQgdG8gdGhlIGZpcnN0IGNoaWxkIGFkZGVkIHRvIHRoZSBHcm91cCBhbmQgZG9lc24ndCBjaGFuZ2UgdW5sZXNzIHlvdSBjYWxsIG5leHQsIHByZXZpb3VzIG9yIHNldCBpdCBkaXJlY3RseSB3aXRoIEdyb3VwLmN1cnNvci4KICAgICogQHByb3BlcnR5IHthbnl9IGN1cnNvciAtIFRoZSBjdXJyZW50IGRpc3BsYXkgb2JqZWN0IHRoYXQgdGhlIEdyb3VwIGN1cnNvciBpcyBwb2ludGluZyB0by4KICAgICovCiAgICB0aGlzLmN1cnNvciA9IG51bGw7Cgp9OwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkdyb3VwLlJFVFVSTl9OT05FID0gMDsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwgPSAxOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkdyb3VwLlJFVFVSTl9DSElMRCA9IDI7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuR3JvdXAuU09SVF9BU0NFTkRJTkcgPSAtMTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Hcm91cC5TT1JUX0RFU0NFTkRJTkcgPSAxOwoKUGhhc2VyLkdyb3VwLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkcyBhbiBleGlzdGluZyBvYmplY3QgdG8gdGhpcyBHcm91cC4gVGhlIG9iamVjdCBjYW4gYmUgYW4gaW5zdGFuY2Ugb2YgUGhhc2VyLlNwcml0ZSwgUGhhc2VyLkJ1dHRvbiBvciBhbnkgb3RoZXIgZGlzcGxheSBvYmplY3QuCiAgICAqIFRoZSBjaGlsZCBpcyBhdXRvbWF0aWNhbGx5IGFkZGVkIHRvIHRoZSB0b3Agb2YgdGhlIEdyb3VwLCBzbyByZW5kZXJzIG9uLXRvcCBvZiBldmVyeXRoaW5nIGVsc2Ugd2l0aGluIHRoZSBHcm91cC4gSWYgeW91IG5lZWQgdG8gY29udHJvbAogICAgKiB0aGF0IHRoZW4gc2VlIHRoZSBhZGRBdCBtZXRob2QuCiAgICAqCiAgICAqIEBzZWUgUGhhc2VyLkdyb3VwI2NyZWF0ZQogICAgKiBAc2VlIFBoYXNlci5Hcm91cCNhZGRBdAogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNhZGQKICAgICogQHBhcmFtIHsqfSBjaGlsZCAtIEFuIGluc3RhbmNlIG9mIFBoYXNlci5TcHJpdGUsIFBoYXNlci5CdXR0b24gb3IgYW55IG90aGVyIGRpc3BsYXkgb2JqZWN0Li4KICAgICogQHJldHVybiB7Kn0gVGhlIGNoaWxkIHRoYXQgd2FzIGFkZGVkIHRvIHRoZSBHcm91cC4KICAgICovCiAgICBhZGQ6IGZ1bmN0aW9uIChjaGlsZCkgewoKICAgICAgICBpZiAoY2hpbGQuZ3JvdXAgIT09IHRoaXMpCiAgICAgICAgewogICAgICAgICAgICBpZiAoY2hpbGQudHlwZSAmJiBjaGlsZC50eXBlID09PSBQaGFzZXIuR1JPVVApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoaWxkLmdyb3VwID0gdGhpczsKCiAgICAgICAgICAgICAgICB0aGlzLl9jb250YWluZXIuYWRkQ2hpbGQoY2hpbGQuX2NvbnRhaW5lcik7CgogICAgICAgICAgICAgICAgY2hpbGQuX2NvbnRhaW5lci51cGRhdGVUcmFuc2Zvcm0oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoaWxkLmdyb3VwID0gdGhpczsKCiAgICAgICAgICAgICAgICB0aGlzLl9jb250YWluZXIuYWRkQ2hpbGQoY2hpbGQpOwoKICAgICAgICAgICAgICAgIGNoaWxkLnVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgICAgIGlmIChjaGlsZC5ldmVudHMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY2hpbGQuZXZlbnRzLm9uQWRkZWRUb0dyb3VwLmRpc3BhdGNoKGNoaWxkLCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuY3Vyc29yID09PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnNvciA9IGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY2hpbGQ7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyBhbiBleGlzdGluZyBvYmplY3QgdG8gdGhpcyBHcm91cC4gVGhlIG9iamVjdCBjYW4gYmUgYW4gaW5zdGFuY2Ugb2YgUGhhc2VyLlNwcml0ZSwgUGhhc2VyLkJ1dHRvbiBvciBhbnkgb3RoZXIgZGlzcGxheSBvYmplY3QuCiAgICAqIFRoZSBjaGlsZCBpcyBhZGRlZCB0byB0aGUgR3JvdXAgYXQgdGhlIGxvY2F0aW9uIHNwZWNpZmllZCBieSB0aGUgaW5kZXggdmFsdWUsIHRoaXMgYWxsb3dzIHlvdSB0byBjb250cm9sIGNoaWxkIG9yZGVyaW5nLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNhZGRBdAogICAgKiBAcGFyYW0geyp9IGNoaWxkIC0gQW4gaW5zdGFuY2Ugb2YgUGhhc2VyLlNwcml0ZSwgUGhhc2VyLkJ1dHRvbiBvciBhbnkgb3RoZXIgZGlzcGxheSBvYmplY3QuLgogICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggd2l0aGluIHRoZSBHcm91cCB0byBpbnNlcnQgdGhlIGNoaWxkIHRvLgogICAgKiBAcmV0dXJuIHsqfSBUaGUgY2hpbGQgdGhhdCB3YXMgYWRkZWQgdG8gdGhlIEdyb3VwLgogICAgKi8KICAgIGFkZEF0OiBmdW5jdGlvbiAoY2hpbGQsIGluZGV4KSB7CgogICAgICAgIGlmIChjaGlsZC5ncm91cCAhPT0gdGhpcykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChjaGlsZC50eXBlICYmIGNoaWxkLnR5cGUgPT09IFBoYXNlci5HUk9VUCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hpbGQuZ3JvdXAgPSB0aGlzOwoKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5hZGRDaGlsZEF0KGNoaWxkLl9jb250YWluZXIsIGluZGV4KTsKCiAgICAgICAgICAgICAgICBjaGlsZC5fY29udGFpbmVyLnVwZGF0ZVRyYW5zZm9ybSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hpbGQuZ3JvdXAgPSB0aGlzOwoKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5hZGRDaGlsZEF0KGNoaWxkLCBpbmRleCk7CgogICAgICAgICAgICAgICAgY2hpbGQudXBkYXRlVHJhbnNmb3JtKCk7CgogICAgICAgICAgICAgICAgaWYgKGNoaWxkLmV2ZW50cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjaGlsZC5ldmVudHMub25BZGRlZFRvR3JvdXAuZGlzcGF0Y2goY2hpbGQsIHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5jdXJzb3IgPT09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3Vyc29yID0gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBjaGlsZDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBjaGlsZCBmb3VuZCBhdCB0aGUgZ2l2ZW4gaW5kZXggd2l0aGluIHRoaXMgR3JvdXAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2dldEF0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCB0byByZXR1cm4gdGhlIGNoaWxkIGZyb20uCiAgICAqIEByZXR1cm4geyp9IFRoZSBjaGlsZCB0aGF0IHdhcyBmb3VuZCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICAqLwogICAgZ2V0QXQ6IGZ1bmN0aW9uIChpbmRleCkgewoKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLmdldENoaWxkQXQoaW5kZXgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEF1dG9tYXRpY2FsbHkgY3JlYXRlcyBhIG5ldyBQaGFzZXIuU3ByaXRlIG9iamVjdCBhbmQgYWRkcyBpdCB0byB0aGUgdG9wIG9mIHRoaXMgR3JvdXAuCiAgICAqIFVzZWZ1bCBpZiB5b3UgZG9uJ3QgbmVlZCB0byBjcmVhdGUgdGhlIFNwcml0ZSBpbnN0YW5jZXMgYmVmb3JlLWhhbmQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NyZWF0ZQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgdG8gZGlzcGxheSB0aGUgbmV3bHkgY3JlYXRlZCBTcHJpdGUgYXQuIFRoZSB2YWx1ZSBpcyBpbiByZWxhdGlvbiB0byB0aGUgR3JvdXAueCBwb2ludC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIHRvIGRpc3BsYXkgdGhlIG5ld2x5IGNyZWF0ZWQgU3ByaXRlIGF0LiBUaGUgdmFsdWUgaXMgaW4gcmVsYXRpb24gdG8gdGhlIEdyb3VwLnkgcG9pbnQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgR2FtZS5jYWNoZSBrZXkgb2YgdGhlIGltYWdlIHRoYXQgdGhpcyBTcHJpdGUgd2lsbCB1c2UuCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ30gW2ZyYW1lXSAtIElmIHRoZSBTcHJpdGUgaW1hZ2UgY29udGFpbnMgbXVsdGlwbGUgZnJhbWVzIHlvdSBjYW4gc3BlY2lmeSB3aGljaCBvbmUgdG8gdXNlIGhlcmUuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2V4aXN0cz10cnVlXSAtIFRoZSBkZWZhdWx0IGV4aXN0cyBzdGF0ZSBvZiB0aGUgU3ByaXRlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuU3ByaXRlfSBUaGUgY2hpbGQgdGhhdCB3YXMgY3JlYXRlZC4KICAgICovCiAgICBjcmVhdGU6IGZ1bmN0aW9uICh4LCB5LCBrZXksIGZyYW1lLCBleGlzdHMpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBleGlzdHMgPT09ICd1bmRlZmluZWQnKSB7IGV4aXN0cyA9IHRydWU7IH0KCiAgICAgICAgdmFyIGNoaWxkID0gbmV3IFBoYXNlci5TcHJpdGUodGhpcy5nYW1lLCB4LCB5LCBrZXksIGZyYW1lKTsKCiAgICAgICAgY2hpbGQuZ3JvdXAgPSB0aGlzOwogICAgICAgIGNoaWxkLmV4aXN0cyA9IGV4aXN0czsKICAgICAgICBjaGlsZC52aXNpYmxlID0gZXhpc3RzOwogICAgICAgIGNoaWxkLmFsaXZlID0gZXhpc3RzOwoKICAgICAgICB0aGlzLl9jb250YWluZXIuYWRkQ2hpbGQoY2hpbGQpOwogICAgICAgICAgICAKICAgICAgICBjaGlsZC51cGRhdGVUcmFuc2Zvcm0oKTsKCiAgICAgICAgaWYgKGNoaWxkLmV2ZW50cykKICAgICAgICB7CiAgICAgICAgICAgIGNoaWxkLmV2ZW50cy5vbkFkZGVkVG9Hcm91cC5kaXNwYXRjaChjaGlsZCwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jdXJzb3IgPT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnNvciA9IGNoaWxkOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGNoaWxkOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEF1dG9tYXRpY2FsbHkgY3JlYXRlcyBtdWx0aXBsZSBQaGFzZXIuU3ByaXRlIG9iamVjdHMgYW5kIGFkZHMgdGhlbSB0byB0aGUgdG9wIG9mIHRoaXMgR3JvdXAuCiAgICAqIFVzZWZ1bCBpZiB5b3UgbmVlZCB0byBxdWlja2x5IGdlbmVyYXRlIGEgcG9vbCBvZiBpZGVudGljYWwgc3ByaXRlcywgc3VjaCBhcyBidWxsZXRzLiBCeSBkZWZhdWx0IHRoZSBzcHJpdGVzIHdpbGwgYmUgc2V0IHRvIG5vdCBleGlzdAogICAgKiBhbmQgd2lsbCBiZSBwb3NpdGlvbmVkIGF0IDAsIDAgKHJlbGF0aXZlIHRvIHRoZSBHcm91cC54L3kpCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NyZWF0ZU11bHRpcGxlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBxdWFudGl0eSAtIFRoZSBudW1iZXIgb2YgU3ByaXRlcyB0byBjcmVhdGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgR2FtZS5jYWNoZSBrZXkgb2YgdGhlIGltYWdlIHRoYXQgdGhpcyBTcHJpdGUgd2lsbCB1c2UuCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ30gW2ZyYW1lXSAtIElmIHRoZSBTcHJpdGUgaW1hZ2UgY29udGFpbnMgbXVsdGlwbGUgZnJhbWVzIHlvdSBjYW4gc3BlY2lmeSB3aGljaCBvbmUgdG8gdXNlIGhlcmUuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2V4aXN0cz1mYWxzZV0gLSBUaGUgZGVmYXVsdCBleGlzdHMgc3RhdGUgb2YgdGhlIFNwcml0ZS4KICAgICovCiAgICBjcmVhdGVNdWx0aXBsZTogZnVuY3Rpb24gKHF1YW50aXR5LCBrZXksIGZyYW1lLCBleGlzdHMpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBleGlzdHMgPT09ICd1bmRlZmluZWQnKSB7IGV4aXN0cyA9IGZhbHNlOyB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVhbnRpdHk7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IG5ldyBQaGFzZXIuU3ByaXRlKHRoaXMuZ2FtZSwgMCwgMCwga2V5LCBmcmFtZSk7CgogICAgICAgICAgICBjaGlsZC5ncm91cCA9IHRoaXM7CiAgICAgICAgICAgIGNoaWxkLmV4aXN0cyA9IGV4aXN0czsKICAgICAgICAgICAgY2hpbGQudmlzaWJsZSA9IGV4aXN0czsKICAgICAgICAgICAgY2hpbGQuYWxpdmUgPSBleGlzdHM7CgogICAgICAgICAgICB0aGlzLl9jb250YWluZXIuYWRkQ2hpbGQoY2hpbGQpOwoKICAgICAgICAgICAgY2hpbGQudXBkYXRlVHJhbnNmb3JtKCk7CgogICAgICAgICAgICBpZiAoY2hpbGQuZXZlbnRzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGlsZC5ldmVudHMub25BZGRlZFRvR3JvdXAuZGlzcGF0Y2goY2hpbGQsIHRoaXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5jdXJzb3IgPT09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3Vyc29yID0gY2hpbGQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkdmFuY2VzIHRoZSBHcm91cCBjdXJzb3IgdG8gdGhlIG5leHQgb2JqZWN0IGluIHRoZSBHcm91cC4gSWYgaXQncyBhdCB0aGUgZW5kIG9mIHRoZSBHcm91cCBpdCB3cmFwcyBhcm91bmQgdG8gdGhlIGZpcnN0IG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjbmV4dAogICAgKi8KICAgIG5leHQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuY3Vyc29yKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFdyYXAgdGhlIGN1cnNvcj8KICAgICAgICAgICAgaWYgKHRoaXMuY3Vyc29yID09IHRoaXMuX2NvbnRhaW5lci5sYXN0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnNvciA9IHRoaXMuX2NvbnRhaW5lci5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnNvciA9IHRoaXMuY3Vyc29yLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBNb3ZlcyB0aGUgR3JvdXAgY3Vyc29yIHRvIHRoZSBwcmV2aW91cyBvYmplY3QgaW4gdGhlIEdyb3VwLiBJZiBpdCdzIGF0IHRoZSBzdGFydCBvZiB0aGUgR3JvdXAgaXQgd3JhcHMgYXJvdW5kIHRvIHRoZSBsYXN0IG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjcHJldmlvdXMKICAgICovCiAgICBwcmV2aW91czogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5jdXJzb3IpCiAgICAgICAgewogICAgICAgICAgICAvLyAgV3JhcCB0aGUgY3Vyc29yPwogICAgICAgICAgICBpZiAodGhpcy5jdXJzb3IgPT0gdGhpcy5fY29udGFpbmVyLl9pTmV4dCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jdXJzb3IgPSB0aGlzLl9jb250YWluZXIubGFzdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3Vyc29yID0gdGhpcy5jdXJzb3IuX2lQcmV2OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIHRlc3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NoaWxkVGVzdAogICAgKi8KICAgIGNoaWxkVGVzdDogZnVuY3Rpb24gKHByZWZpeCwgY2hpbGQpIHsKCiAgICAgICAgdmFyIHMgPSBwcmVmaXggKyAnIG5leHQ6ICc7CgogICAgICAgIGlmIChjaGlsZC5faU5leHQpCiAgICAgICAgewogICAgICAgICAgICBzID0gcyArIGNoaWxkLl9pTmV4dC5uYW1lOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBzID0gcyArICctbnVsbC0nOwogICAgICAgIH0KCiAgICAgICAgcyA9IHMgKyAnICcgKyBwcmVmaXggKyAnIHByZXY6ICc7CgogICAgICAgIGlmIChjaGlsZC5faVByZXYpCiAgICAgICAgewogICAgICAgICAgICBzID0gcyArIGNoaWxkLl9pUHJldi5uYW1lOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBzID0gcyArICctbnVsbC0nOwogICAgICAgIH0KCiAgICAgICAgY29uc29sZS5sb2cocyk7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgdGVzdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjc3dhcEluZGV4CiAgICAqLwogICAgc3dhcEluZGV4OiBmdW5jdGlvbiAoaW5kZXgxLCBpbmRleDIpIHsKCiAgICAgICAgdmFyIGNoaWxkMSA9IHRoaXMuZ2V0QXQoaW5kZXgxKTsKICAgICAgICB2YXIgY2hpbGQyID0gdGhpcy5nZXRBdChpbmRleDIpOwoKICAgICAgICB0aGlzLnN3YXAoY2hpbGQxLCBjaGlsZDIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN3YXBzIHRoZSBwb3NpdGlvbiBvZiB0d28gY2hpbGRyZW4gaW4gdGhpcyBHcm91cC4gQm90aCBjaGlsZHJlbiBtdXN0IGJlIGluIHRoaXMgR3JvdXAuCiAgICAqIFlvdSBjYW5ub3Qgc3dhcCBhIGNoaWxkIHdpdGggaXRzZWxmLCBvciBzd2FwIHVuLXBhcmVudGVkIGNoaWxkcmVuLCBkb2luZyBzbyB3aWxsIHJldHVybiBmYWxzZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjc3dhcAogICAgKiBAcGFyYW0geyp9IGNoaWxkMSAtIFRoZSBmaXJzdCBjaGlsZCB0byBzd2FwLgogICAgKiBAcGFyYW0geyp9IGNoaWxkMiAtIFRoZSBzZWNvbmQgY2hpbGQgdG8gc3dhcC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgc3dhcCB3YXMgc3VjY2Vzc2Z1bCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIHN3YXA6IGZ1bmN0aW9uIChjaGlsZDEsIGNoaWxkMikgewoKICAgICAgICBpZiAoY2hpbGQxID09PSBjaGlsZDIgfHwgIWNoaWxkMS5wYXJlbnQgfHwgIWNoaWxkMi5wYXJlbnQgfHwgY2hpbGQxLmdyb3VwICE9PSB0aGlzIHx8IGNoaWxkMi5ncm91cCAhPT0gdGhpcykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIC8vICBDYWNoZSB0aGUgdmFsdWVzCiAgICAgICAgdmFyIGNoaWxkMVByZXYgPSBjaGlsZDEuX2lQcmV2OwogICAgICAgIHZhciBjaGlsZDFOZXh0ID0gY2hpbGQxLl9pTmV4dDsKICAgICAgICB2YXIgY2hpbGQyUHJldiA9IGNoaWxkMi5faVByZXY7CiAgICAgICAgdmFyIGNoaWxkMk5leHQgPSBjaGlsZDIuX2lOZXh0OwoKICAgICAgICB2YXIgZW5kTm9kZSA9IHRoaXMuX2NvbnRhaW5lci5sYXN0Ll9pTmV4dDsKICAgICAgICB2YXIgY3VycmVudE5vZGUgPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlOwogICAgICAgICAgICAKICAgICAgICBkbwogICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlICE9PSBjaGlsZDEgJiYgY3VycmVudE5vZGUgIT09IGNoaWxkMikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmZpcnN0ID09PSBjaGlsZDEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuZmlyc3QgPSBjaGlsZDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChjdXJyZW50Tm9kZS5maXJzdCA9PT0gY2hpbGQyKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmZpcnN0ID0gY2hpbGQxOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5sYXN0ID09PSBjaGlsZDEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUubGFzdCA9IGNoaWxkMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGN1cnJlbnROb2RlLmxhc3QgPT09IGNoaWxkMikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5sYXN0ID0gY2hpbGQxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKGN1cnJlbnROb2RlICE9IGVuZE5vZGUpCgogICAgICAgIGlmIChjaGlsZDEuX2lOZXh0ID09IGNoaWxkMikKICAgICAgICB7CiAgICAgICAgICAgIC8vICBUaGlzIGlzIGEgZG93bndhcmQgKEEgdG8gQikgbmVpZ2hib3VyIHN3YXAKICAgICAgICAgICAgY2hpbGQxLl9pTmV4dCA9IGNoaWxkMk5leHQ7CiAgICAgICAgICAgIGNoaWxkMS5faVByZXYgPSBjaGlsZDI7CiAgICAgICAgICAgIGNoaWxkMi5faU5leHQgPSBjaGlsZDE7CiAgICAgICAgICAgIGNoaWxkMi5faVByZXYgPSBjaGlsZDFQcmV2OwoKICAgICAgICAgICAgaWYgKGNoaWxkMVByZXYpIHsgY2hpbGQxUHJldi5faU5leHQgPSBjaGlsZDI7IH0KICAgICAgICAgICAgaWYgKGNoaWxkMk5leHQpIHsgY2hpbGQyTmV4dC5faVByZXYgPSBjaGlsZDE7IH0KCiAgICAgICAgICAgIGlmIChjaGlsZDEuX19yZW5kZXJHcm91cCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hpbGQxLl9fcmVuZGVyR3JvdXAudXBkYXRlVGV4dHVyZShjaGlsZDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY2hpbGQyLl9fcmVuZGVyR3JvdXApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoaWxkMi5fX3JlbmRlckdyb3VwLnVwZGF0ZVRleHR1cmUoY2hpbGQyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGNoaWxkMi5faU5leHQgPT0gY2hpbGQxKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFRoaXMgaXMgYW4gdXB3YXJkIChCIHRvIEEpIG5laWdoYm91ciBzd2FwCiAgICAgICAgICAgIGNoaWxkMS5faU5leHQgPSBjaGlsZDI7CiAgICAgICAgICAgIGNoaWxkMS5faVByZXYgPSBjaGlsZDJQcmV2OwogICAgICAgICAgICBjaGlsZDIuX2lOZXh0ID0gY2hpbGQxTmV4dDsKICAgICAgICAgICAgY2hpbGQyLl9pUHJldiA9IGNoaWxkMTsKCiAgICAgICAgICAgIGlmIChjaGlsZDJQcmV2KSB7IGNoaWxkMlByZXYuX2lOZXh0ID0gY2hpbGQxOyB9CiAgICAgICAgICAgIGlmIChjaGlsZDFOZXh0KSB7IGNoaWxkMU5leHQuX2lQcmV2ID0gY2hpbGQyOyB9CgogICAgICAgICAgICBpZiAoY2hpbGQxLl9fcmVuZGVyR3JvdXApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoaWxkMS5fX3JlbmRlckdyb3VwLnVwZGF0ZVRleHR1cmUoY2hpbGQxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNoaWxkMi5fX3JlbmRlckdyb3VwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGlsZDIuX19yZW5kZXJHcm91cC51cGRhdGVUZXh0dXJlKGNoaWxkMik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgQ2hpbGRyZW4gYXJlIGZhciBhcGFydAogICAgICAgICAgICBjaGlsZDEuX2lOZXh0ID0gY2hpbGQyTmV4dDsKICAgICAgICAgICAgY2hpbGQxLl9pUHJldiA9IGNoaWxkMlByZXY7CiAgICAgICAgICAgIGNoaWxkMi5faU5leHQgPSBjaGlsZDFOZXh0OwogICAgICAgICAgICBjaGlsZDIuX2lQcmV2ID0gY2hpbGQxUHJldjsKCiAgICAgICAgICAgIGlmIChjaGlsZDFQcmV2KSB7IGNoaWxkMVByZXYuX2lOZXh0ID0gY2hpbGQyOyB9CiAgICAgICAgICAgIGlmIChjaGlsZDFOZXh0KSB7IGNoaWxkMU5leHQuX2lQcmV2ID0gY2hpbGQyOyB9CiAgICAgICAgICAgIGlmIChjaGlsZDJQcmV2KSB7IGNoaWxkMlByZXYuX2lOZXh0ID0gY2hpbGQxOyB9CiAgICAgICAgICAgIGlmIChjaGlsZDJOZXh0KSB7IGNoaWxkMk5leHQuX2lQcmV2ID0gY2hpbGQxOyB9CgogICAgICAgICAgICBpZiAoY2hpbGQxLl9fcmVuZGVyR3JvdXApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoaWxkMS5fX3JlbmRlckdyb3VwLnVwZGF0ZVRleHR1cmUoY2hpbGQxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNoaWxkMi5fX3JlbmRlckdyb3VwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGlsZDIuX19yZW5kZXJHcm91cC51cGRhdGVUZXh0dXJlKGNoaWxkMik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogQnJpbmdzIHRoZSBnaXZlbiBjaGlsZCB0byB0aGUgdG9wIG9mIHRoaXMgR3JvdXAgc28gaXQgcmVuZGVycyBhYm92ZSBhbGwgb3RoZXIgY2hpbGRyZW4uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2JyaW5nVG9Ub3AKICAgICogQHBhcmFtIHsqfSBjaGlsZCAtIFRoZSBjaGlsZCB0byBicmluZyB0byB0aGUgdG9wIG9mIHRoaXMgR3JvdXAuCiAgICAqIEByZXR1cm4geyp9IFRoZSBjaGlsZCB0aGF0IHdhcyBtb3ZlZC4KICAgICovCiAgICBicmluZ1RvVG9wOiBmdW5jdGlvbiAoY2hpbGQpIHsKCiAgICAgICAgaWYgKGNoaWxkLmdyb3VwID09PSB0aGlzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmUoY2hpbGQpOwogICAgICAgICAgICB0aGlzLmFkZChjaGlsZCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY2hpbGQ7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IHRoZSBpbmRleCBwb3NpdGlvbiBvZiB0aGUgZ2l2ZW4gY2hpbGQgaW4gdGhpcyBHcm91cC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZ2V0SW5kZXgKICAgICogQHBhcmFtIHsqfSBjaGlsZCAtIFRoZSBjaGlsZCB0byBnZXQgdGhlIGluZGV4IGZvci4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgaW5kZXggb2YgdGhlIGNoaWxkIG9yIC0xIGlmIGl0J3Mgbm90IGEgbWVtYmVyIG9mIHRoaXMgR3JvdXAuCiAgICAqLwogICAgZ2V0SW5kZXg6IGZ1bmN0aW9uIChjaGlsZCkgewoKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmluZGV4T2YoY2hpbGQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlcGxhY2VzIGEgY2hpbGQgb2YgdGhpcyBHcm91cCB3aXRoIHRoZSBnaXZlbiBuZXdDaGlsZC4gVGhlIG5ld0NoaWxkIGNhbm5vdCBiZSBhIG1lbWJlciBvZiB0aGlzIEdyb3VwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNyZXBsYWNlCiAgICAqIEBwYXJhbSB7Kn0gb2xkQ2hpbGQgLSBUaGUgY2hpbGQgaW4gdGhpcyBHcm91cCB0aGF0IHdpbGwgYmUgcmVwbGFjZWQuCiAgICAqIEBwYXJhbSB7Kn0gbmV3Q2hpbGQgLSBUaGUgY2hpbGQgdG8gYmUgaW5zZXJ0ZWQgaW50byB0aGlzIGdyb3VwLgogICAgKi8KICAgIHJlcGxhY2U6IGZ1bmN0aW9uIChvbGRDaGlsZCwgbmV3Q2hpbGQpIHsKCiAgICAgICAgaWYgKCF0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5nZXRJbmRleChvbGRDaGlsZCk7CiAgICAgICAgCiAgICAgICAgaWYgKGluZGV4ICE9IC0xKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKG5ld0NoaWxkLnBhcmVudCAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZC5ldmVudHMub25SZW1vdmVkRnJvbUdyb3VwLmRpc3BhdGNoKG5ld0NoaWxkLCB0aGlzKTsKICAgICAgICAgICAgICAgIG5ld0NoaWxkLnBhcmVudC5yZW1vdmVDaGlsZChuZXdDaGlsZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5yZW1vdmVDaGlsZChvbGRDaGlsZCk7CiAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5hZGRDaGlsZEF0KG5ld0NoaWxkLCBpbmRleCk7CgogICAgICAgICAgICBuZXdDaGlsZC5ldmVudHMub25BZGRlZFRvR3JvdXAuZGlzcGF0Y2gobmV3Q2hpbGQsIHRoaXMpOwogICAgICAgICAgICBuZXdDaGlsZC51cGRhdGVUcmFuc2Zvcm0oKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnNvciA9PSBvbGRDaGlsZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jdXJzb3IgPSB0aGlzLl9jb250YWluZXIuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGdpdmVuIHByb3BlcnR5IHRvIHRoZSBnaXZlbiB2YWx1ZSBvbiB0aGUgY2hpbGQuIFRoZSBvcGVyYXRpb24gY29udHJvbHMgdGhlIGFzc2lnbm1lbnQgb2YgdGhlIHZhbHVlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNzZXRQcm9wZXJ0eQogICAgKiBAcGFyYW0geyp9IGNoaWxkIC0gVGhlIGNoaWxkIHRvIHNldCB0aGUgcHJvcGVydHkgdmFsdWUgb24uCiAgICAqIEBwYXJhbSB7YXJyYXl9IGtleSAtIEFuIGFycmF5IG9mIHN0cmluZ3MgdGhhdCBtYWtlIHVwIHRoZSBwcm9wZXJ0eSB0aGF0IHdpbGwgYmUgc2V0LgogICAgKiBAcGFyYW0geyp9IHZhbHVlIC0gVGhlIHZhbHVlIHRoYXQgd2lsbCBiZSBzZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb3BlcmF0aW9uPTBdIC0gQ29udHJvbHMgaG93IHRoZSB2YWx1ZSBpcyBhc3NpZ25lZC4gQSB2YWx1ZSBvZiAwIHJlcGxhY2VzIHRoZSB2YWx1ZSB3aXRoIHRoZSBuZXcgb25lLiBBIHZhbHVlIG9mIDEgYWRkcyBpdCwgMiBzdWJ0cmFjdHMgaXQsIDMgbXVsdGlwbGllcyBpdCBhbmQgNCBkaXZpZGVzIGl0LgogICAgKi8KICAgIHNldFByb3BlcnR5OiBmdW5jdGlvbiAoY2hpbGQsIGtleSwgdmFsdWUsIG9wZXJhdGlvbikgewoKICAgICAgICBvcGVyYXRpb24gPSBvcGVyYXRpb24gfHwgMDsKCiAgICAgICAgLy8gIEFzIHVnbHkgYXMgdGhpcyBhcHByb2FjaCBsb29rcywgYW5kIGFsdGhvdWdoIGl0J3MgbGltaXRlZCB0byBhIGRlcHRoIG9mIG9ubHkgNCwgaXQncyBleHRyZW1lbHkgZmFzdC4KICAgICAgICAvLyAgTXVjaCBmYXN0ZXIgdGhhbiBhIGZvciBsb29wIG9yIG9iamVjdCBpdGVyYXRpb24uIFRoZXJlIGFyZSBubyBjaGVja3MsIHNvIGlmIHRoZSBrZXkgaXNuJ3QgdmFsaWQgdGhlbiBpdCdsbCBmYWlsCiAgICAgICAgLy8gIGJ1dCBhcyB5b3UgYXJlIGxpa2VseSB0byBjYWxsIHRoaXMgZnJvbSBpbm5lciBsb29wcyB0aGF0IGhhdmUgdG8gcGVyZm9ybSB3ZWxsLCBJJ2xsIHRha2UgdGhhdCB0cmFkZSBvZmYuCgogICAgICAgIC8vICAwID0gRXF1YWxzCiAgICAgICAgLy8gIDEgPSBBZGQKICAgICAgICAvLyAgMiA9IFN1YnRyYWN0CiAgICAgICAgLy8gIDMgPSBNdWx0aXBseQogICAgICAgIC8vICA0ID0gRGl2aWRlCgogICAgICAgIHZhciBsZW4gPSBrZXkubGVuZ3RoOwoKICAgICAgICBpZiAobGVuID09IDEpCiAgICAgICAgewogICAgICAgICAgICBpZiAob3BlcmF0aW9uID09PSAwKSB7IGNoaWxkW2tleVswXV0gPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gMSkgeyBjaGlsZFtrZXlbMF1dICs9IHZhbHVlOyB9CiAgICAgICAgICAgIGVsc2UgaWYgKG9wZXJhdGlvbiA9PSAyKSB7IGNoaWxkW2tleVswXV0gLT0gdmFsdWU7IH0KICAgICAgICAgICAgZWxzZSBpZiAob3BlcmF0aW9uID09IDMpIHsgY2hpbGRba2V5WzBdXSAqPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gNCkgeyBjaGlsZFtrZXlbMF1dIC89IHZhbHVlOyB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGxlbiA9PSAyKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKG9wZXJhdGlvbiA9PT0gMCkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV0gPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gMSkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV0gKz0gdmFsdWU7IH0KICAgICAgICAgICAgZWxzZSBpZiAob3BlcmF0aW9uID09IDIpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dIC09IHZhbHVlOyB9CiAgICAgICAgICAgIGVsc2UgaWYgKG9wZXJhdGlvbiA9PSAzKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXSAqPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gNCkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV0gLz0gdmFsdWU7IH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAobGVuID09IDMpCiAgICAgICAgewogICAgICAgICAgICBpZiAob3BlcmF0aW9uID09PSAwKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXVtrZXlbMl1dID0gdmFsdWU7IH0KICAgICAgICAgICAgZWxzZSBpZiAob3BlcmF0aW9uID09IDEpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dW2tleVsyXV0gKz0gdmFsdWU7IH0KICAgICAgICAgICAgZWxzZSBpZiAob3BlcmF0aW9uID09IDIpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dW2tleVsyXV0gLT0gdmFsdWU7IH0KICAgICAgICAgICAgZWxzZSBpZiAob3BlcmF0aW9uID09IDMpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dW2tleVsyXV0gKj0gdmFsdWU7IH0KICAgICAgICAgICAgZWxzZSBpZiAob3BlcmF0aW9uID09IDQpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dW2tleVsyXV0gLz0gdmFsdWU7IH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAobGVuID09IDQpCiAgICAgICAgewogICAgICAgICAgICBpZiAob3BlcmF0aW9uID09PSAwKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXVtrZXlbMl1dW2tleVszXV0gPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gMSkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXVtrZXlbM11dICs9IHZhbHVlOyB9CiAgICAgICAgICAgIGVsc2UgaWYgKG9wZXJhdGlvbiA9PSAyKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXVtrZXlbMl1dW2tleVszXV0gLT0gdmFsdWU7IH0KICAgICAgICAgICAgZWxzZSBpZiAob3BlcmF0aW9uID09IDMpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dW2tleVsyXV1ba2V5WzNdXSAqPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gNCkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXVtrZXlbM11dIC89IHZhbHVlOyB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vICBUT0RPIC0gRGVlcCBwcm9wZXJ0eSBzY2FuZQoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoaXMgZnVuY3Rpb24gYWxsb3dzIHlvdSB0byBxdWlja2x5IHNldCBhIHByb3BlcnR5IG9uIGEgc2luZ2xlIGNoaWxkIG9mIHRoaXMgR3JvdXAgdG8gYSBuZXcgdmFsdWUuCiAgICAqIFRoZSBvcGVyYXRpb24gcGFyYW1ldGVyIGNvbnRyb2xzIGhvdyB0aGUgbmV3IHZhbHVlIGlzIGFzc2lnbmVkIHRvIHRoZSBwcm9wZXJ0eSwgZnJvbSBzaW1wbGUgcmVwbGFjZW1lbnQgdG8gYWRkaXRpb24gYW5kIG11bHRpcGxpY2F0aW9uLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNzZXQKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBjaGlsZCAtIFRoZSBjaGlsZCB0byBzZXQgdGhlIHByb3BlcnR5IG9uLgogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHByb3BlcnR5LCBhcyBhIHN0cmluZywgdG8gYmUgc2V0LiBGb3IgZXhhbXBsZTogJ2JvZHkudmVsb2NpdHkueCcKICAgICogQHBhcmFtIHsqfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0aGF0IHdpbGwgYmUgc2V0LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjaGVja0FsaXZlPWZhbHNlXSAtIElmIHNldCB0aGVuIHRoZSBjaGlsZCB3aWxsIG9ubHkgYmUgdXBkYXRlZCBpZiBhbGl2ZT10cnVlLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjaGVja1Zpc2libGU9ZmFsc2VdIC0gSWYgc2V0IHRoZW4gdGhlIGNoaWxkIHdpbGwgb25seSBiZSB1cGRhdGVkIGlmIHZpc2libGU9dHJ1ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcGVyYXRpb249MF0gLSBDb250cm9scyBob3cgdGhlIHZhbHVlIGlzIGFzc2lnbmVkLiBBIHZhbHVlIG9mIDAgcmVwbGFjZXMgdGhlIHZhbHVlIHdpdGggdGhlIG5ldyBvbmUuIEEgdmFsdWUgb2YgMSBhZGRzIGl0LCAyIHN1YnRyYWN0cyBpdCwgMyBtdWx0aXBsaWVzIGl0IGFuZCA0IGRpdmlkZXMgaXQuCiAgICAqLwogICAgc2V0OiBmdW5jdGlvbiAoY2hpbGQsIGtleSwgdmFsdWUsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSwgb3BlcmF0aW9uKSB7CgogICAgICAgIGtleSA9IGtleS5zcGxpdCgnLicpOwoKICAgICAgICBpZiAodHlwZW9mIGNoZWNrQWxpdmUgPT09ICd1bmRlZmluZWQnKSB7IGNoZWNrQWxpdmUgPSBmYWxzZTsgfQogICAgICAgIGlmICh0eXBlb2YgY2hlY2tWaXNpYmxlID09PSAndW5kZWZpbmVkJykgeyBjaGVja1Zpc2libGUgPSBmYWxzZTsgfQoKICAgICAgICBpZiAoKGNoZWNrQWxpdmUgPT09IGZhbHNlIHx8IChjaGVja0FsaXZlICYmIGNoaWxkLmFsaXZlKSkgJiYgKGNoZWNrVmlzaWJsZSA9PT0gZmFsc2UgfHwgKGNoZWNrVmlzaWJsZSAmJiBjaGlsZC52aXNpYmxlKSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNldFByb3BlcnR5KGNoaWxkLCBrZXksIHZhbHVlLCBvcGVyYXRpb24pOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGlzIGZ1bmN0aW9uIGFsbG93cyB5b3UgdG8gcXVpY2tseSBzZXQgdGhlIHNhbWUgcHJvcGVydHkgYWNyb3NzIGFsbCBjaGlsZHJlbiBvZiB0aGlzIEdyb3VwIHRvIGEgbmV3IHZhbHVlLgogICAgKiBUaGUgb3BlcmF0aW9uIHBhcmFtZXRlciBjb250cm9scyBob3cgdGhlIG5ldyB2YWx1ZSBpcyBhc3NpZ25lZCB0byB0aGUgcHJvcGVydHksIGZyb20gc2ltcGxlIHJlcGxhY2VtZW50IHRvIGFkZGl0aW9uIGFuZCBtdWx0aXBsaWNhdGlvbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjc2V0QWxsCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgcHJvcGVydHksIGFzIGEgc3RyaW5nLCB0byBiZSBzZXQuIEZvciBleGFtcGxlOiAnYm9keS52ZWxvY2l0eS54JwogICAgKiBAcGFyYW0geyp9IHZhbHVlIC0gVGhlIHZhbHVlIHRoYXQgd2lsbCBiZSBzZXQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2NoZWNrQWxpdmU9ZmFsc2VdIC0gSWYgc2V0IHRoZW4gb25seSBjaGlsZHJlbiB3aXRoIGFsaXZlPXRydWUgd2lsbCBiZSB1cGRhdGVkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjaGVja1Zpc2libGU9ZmFsc2VdIC0gSWYgc2V0IHRoZW4gb25seSBjaGlsZHJlbiB3aXRoIHZpc2libGU9dHJ1ZSB3aWxsIGJlIHVwZGF0ZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb3BlcmF0aW9uPTBdIC0gQ29udHJvbHMgaG93IHRoZSB2YWx1ZSBpcyBhc3NpZ25lZC4gQSB2YWx1ZSBvZiAwIHJlcGxhY2VzIHRoZSB2YWx1ZSB3aXRoIHRoZSBuZXcgb25lLiBBIHZhbHVlIG9mIDEgYWRkcyBpdCwgMiBzdWJ0cmFjdHMgaXQsIDMgbXVsdGlwbGllcyBpdCBhbmQgNCBkaXZpZGVzIGl0LgogICAgKi8KICAgIHNldEFsbDogZnVuY3Rpb24gKGtleSwgdmFsdWUsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSwgb3BlcmF0aW9uKSB7CgogICAgICAgIGtleSA9IGtleS5zcGxpdCgnLicpOwoKICAgICAgICBpZiAodHlwZW9mIGNoZWNrQWxpdmUgPT09ICd1bmRlZmluZWQnKSB7IGNoZWNrQWxpdmUgPSBmYWxzZTsgfQogICAgICAgIGlmICh0eXBlb2YgY2hlY2tWaXNpYmxlID09PSAndW5kZWZpbmVkJykgeyBjaGVja1Zpc2libGUgPSBmYWxzZTsgfQoKICAgICAgICBvcGVyYXRpb24gPSBvcGVyYXRpb24gfHwgMDsKCiAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPiAwICYmIHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgY3VycmVudE5vZGUgPSB0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGRvCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgoY2hlY2tBbGl2ZSA9PT0gZmFsc2UgfHwgKGNoZWNrQWxpdmUgJiYgY3VycmVudE5vZGUuYWxpdmUpKSAmJiAoY2hlY2tWaXNpYmxlID09PSBmYWxzZSB8fCAoY2hlY2tWaXNpYmxlICYmIGN1cnJlbnROb2RlLnZpc2libGUpKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFByb3BlcnR5KGN1cnJlbnROb2RlLCBrZXksIHZhbHVlLCBvcGVyYXRpb24pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSAhPSB0aGlzLl9jb250YWluZXIubGFzdC5faU5leHQpCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgdGhlIGFtb3VudCB0byB0aGUgZ2l2ZW4gcHJvcGVydHkgb24gYWxsIGNoaWxkcmVuIGluIHRoaXMgR3JvdXAuCiAgICAqIEdyb3VwLmFkZEFsbCgneCcsIDEwKSB3aWxsIGFkZCAxMCB0byB0aGUgY2hpbGQueCB2YWx1ZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjYWRkQWxsCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSAtIFRoZSBwcm9wZXJ0eSB0byBpbmNyZW1lbnQsIGZvciBleGFtcGxlICdib2R5LnZlbG9jaXR5LngnIG9yICdhbmdsZScuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgLSBUaGUgYW1vdW50IHRvIGluY3JlbWVudCB0aGUgcHJvcGVydHkgYnkuIElmIGNoaWxkLnggPSAxMCB0aGVuIGFkZEFsbCgneCcsIDQwKSB3b3VsZCBtYWtlIGNoaWxkLnggPSA1MC4KICAgICogQHBhcmFtIHtib29sZWFufSBjaGVja0FsaXZlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIGFsaXZlLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoZWNrVmlzaWJsZSAtIElmIHRydWUgdGhlIHByb3BlcnR5IHdpbGwgb25seSBiZSBjaGFuZ2VkIGlmIHRoZSBjaGlsZCBpcyB2aXNpYmxlLgogICAgKi8KICAgIGFkZEFsbDogZnVuY3Rpb24gKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSkgewoKICAgICAgICB0aGlzLnNldEFsbChwcm9wZXJ0eSwgYW1vdW50LCBjaGVja0FsaXZlLCBjaGVja1Zpc2libGUsIDEpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN1YnRyYWN0cyB0aGUgYW1vdW50IGZyb20gdGhlIGdpdmVuIHByb3BlcnR5IG9uIGFsbCBjaGlsZHJlbiBpbiB0aGlzIEdyb3VwLgogICAgKiBHcm91cC5zdWJBbGwoJ3gnLCAxMCkgd2lsbCBtaW51cyAxMCBmcm9tIHRoZSBjaGlsZC54IHZhbHVlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNzdWJBbGwKICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3BlcnR5IC0gVGhlIHByb3BlcnR5IHRvIGRlY3JlbWVudCwgZm9yIGV4YW1wbGUgJ2JvZHkudmVsb2NpdHkueCcgb3IgJ2FuZ2xlJy4KICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gc3VidHJhY3QgZnJvbSB0aGUgcHJvcGVydHkuIElmIGNoaWxkLnggPSA1MCB0aGVuIHN1YkFsbCgneCcsIDQwKSB3b3VsZCBtYWtlIGNoaWxkLnggPSAxMC4KICAgICogQHBhcmFtIHtib29sZWFufSBjaGVja0FsaXZlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIGFsaXZlLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoZWNrVmlzaWJsZSAtIElmIHRydWUgdGhlIHByb3BlcnR5IHdpbGwgb25seSBiZSBjaGFuZ2VkIGlmIHRoZSBjaGlsZCBpcyB2aXNpYmxlLgogICAgKi8KICAgIHN1YkFsbDogZnVuY3Rpb24gKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSkgewoKICAgICAgICB0aGlzLnNldEFsbChwcm9wZXJ0eSwgYW1vdW50LCBjaGVja0FsaXZlLCBjaGVja1Zpc2libGUsIDIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIE11bHRpcGxpZXMgdGhlIGdpdmVuIHByb3BlcnR5IGJ5IHRoZSBhbW91bnQgb24gYWxsIGNoaWxkcmVuIGluIHRoaXMgR3JvdXAuCiAgICAqIEdyb3VwLm11bHRpcGx5QWxsKCd4JywgMikgd2lsbCB4MiB0aGUgY2hpbGQueCB2YWx1ZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjbXVsdGlwbHlBbGwKICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3BlcnR5IC0gVGhlIHByb3BlcnR5IHRvIG11bHRpcGx5LCBmb3IgZXhhbXBsZSAnYm9keS52ZWxvY2l0eS54JyBvciAnYW5nbGUnLgogICAgKiBAcGFyYW0ge251bWJlcn0gYW1vdW50IC0gVGhlIGFtb3VudCB0byBtdWx0aXBseSB0aGUgcHJvcGVydHkgYnkuIElmIGNoaWxkLnggPSAxMCB0aGVuIG11bHRpcGx5QWxsKCd4JywgMikgd291bGQgbWFrZSBjaGlsZC54ID0gMjAuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tBbGl2ZSAtIElmIHRydWUgdGhlIHByb3BlcnR5IHdpbGwgb25seSBiZSBjaGFuZ2VkIGlmIHRoZSBjaGlsZCBpcyBhbGl2ZS4KICAgICogQHBhcmFtIHtib29sZWFufSBjaGVja1Zpc2libGUgLSBJZiB0cnVlIHRoZSBwcm9wZXJ0eSB3aWxsIG9ubHkgYmUgY2hhbmdlZCBpZiB0aGUgY2hpbGQgaXMgdmlzaWJsZS4KICAgICovCiAgICBtdWx0aXBseUFsbDogZnVuY3Rpb24gKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSkgewoKICAgICAgICB0aGlzLnNldEFsbChwcm9wZXJ0eSwgYW1vdW50LCBjaGVja0FsaXZlLCBjaGVja1Zpc2libGUsIDMpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERpdmlkZXMgdGhlIGdpdmVuIHByb3BlcnR5IGJ5IHRoZSBhbW91bnQgb24gYWxsIGNoaWxkcmVuIGluIHRoaXMgR3JvdXAuCiAgICAqIEdyb3VwLmRpdmlkZUFsbCgneCcsIDIpIHdpbGwgaGFsZiB0aGUgY2hpbGQueCB2YWx1ZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZGl2aWRlQWxsCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSAtIFRoZSBwcm9wZXJ0eSB0byBkaXZpZGUsIGZvciBleGFtcGxlICdib2R5LnZlbG9jaXR5LngnIG9yICdhbmdsZScuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgLSBUaGUgYW1vdW50IHRvIGRpdmlkZSB0aGUgcHJvcGVydHkgYnkuIElmIGNoaWxkLnggPSAxMDAgdGhlbiBkaXZpZGVBbGwoJ3gnLCAyKSB3b3VsZCBtYWtlIGNoaWxkLnggPSA1MC4KICAgICogQHBhcmFtIHtib29sZWFufSBjaGVja0FsaXZlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIGFsaXZlLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoZWNrVmlzaWJsZSAtIElmIHRydWUgdGhlIHByb3BlcnR5IHdpbGwgb25seSBiZSBjaGFuZ2VkIGlmIHRoZSBjaGlsZCBpcyB2aXNpYmxlLgogICAgKi8KICAgIGRpdmlkZUFsbDogZnVuY3Rpb24gKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSkgewoKICAgICAgICB0aGlzLnNldEFsbChwcm9wZXJ0eSwgYW1vdW50LCBjaGVja0FsaXZlLCBjaGVja1Zpc2libGUsIDQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxzIGEgZnVuY3Rpb24gb24gYWxsIG9mIHRoZSBjaGlsZHJlbiB0aGF0IGhhdmUgZXhpc3RzPXRydWUgaW4gdGhpcyBHcm91cC4KICAgICogQWZ0ZXIgdGhlIGV4aXN0c1ZhbHVlIHBhcmFtZXRlciB5b3UgY2FuIGFkZCBhcyBtYW55IHBhcmFtZXRlcnMgYXMgeW91IGxpa2UsIHdoaWNoIHdpbGwgYWxsIGJlIHBhc3NlZCB0byB0aGUgY2hpbGQgY2FsbGJhY2suCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNjYWxsQWxsRXhpc3RzCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGZ1bmN0aW9uIHRoYXQgZXhpc3RzIG9uIHRoZSBjaGlsZHJlbiB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGV4aXN0c1ZhbHVlIC0gT25seSBjaGlsZHJlbiB3aXRoIGV4aXN0cz1leGlzdHNWYWx1ZSB3aWxsIGJlIGNhbGxlZC4KICAgICogQHBhcmFtIHsuLi4qfSBwYXJhbWV0ZXIgLSBBZGRpdGlvbmFsIHBhcmFtZXRlcnMgdGhhdCB3aWxsIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2suCiAgICAqLwogICAgY2FsbEFsbEV4aXN0czogZnVuY3Rpb24gKGNhbGxiYWNrLCBleGlzdHNWYWx1ZSkgewoKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoKICAgICAgICBpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCA+IDAgJiYgdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmV4aXN0cyA9PSBleGlzdHNWYWx1ZSAmJiBjdXJyZW50Tm9kZVtjYWxsYmFja10pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGVbY2FsbGJhY2tdLmFwcGx5KGN1cnJlbnROb2RlLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gdGhpcy5fY29udGFpbmVyLmxhc3QuX2lOZXh0KQoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHJlZmVyZW5jZSB0byBhIGZ1bmN0aW9uIHRoYXQgZXhpc3RzIG9uIGEgY2hpbGQgb2YgdGhlIEdyb3VwIGJhc2VkIG9uIHRoZSBnaXZlbiBjYWxsYmFjayBhcnJheS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NhbGxiYWNrRnJvbUFycmF5CiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjaGlsZCAtIFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgICogQHBhcmFtIHthcnJheX0gY2FsbGJhY2sgLSBUaGUgYXJyYXkgb2YgZnVuY3Rpb24gbmFtZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBsZW5ndGggLSBUaGUgc2l6ZSBvZiB0aGUgYXJyYXkgKHByZS1jYWxjdWxhdGVkIGluIGNhbGxBbGwpLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgY2FsbGJhY2tGcm9tQXJyYXk6IGZ1bmN0aW9uIChjaGlsZCwgY2FsbGJhY2ssIGxlbmd0aCkgewoKICAgICAgICAvLyAgS2luZGEgbG9va3MgbGlrZSBhIENocmlzdG1hcyB0cmVlCgogICAgICAgIGlmIChsZW5ndGggPT0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChjaGlsZFtjYWxsYmFja1swXV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZFtjYWxsYmFja1swXV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAobGVuZ3RoID09IDIpCiAgICAgICAgewogICAgICAgICAgICBpZiAoY2hpbGRbY2FsbGJhY2tbMF1dW2NhbGxiYWNrWzFdXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkW2NhbGxiYWNrWzBdXVtjYWxsYmFja1sxXV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAobGVuZ3RoID09IDMpCiAgICAgICAgewogICAgICAgICAgICBpZiAoY2hpbGRbY2FsbGJhY2tbMF1dW2NhbGxiYWNrWzFdXVtjYWxsYmFja1syXV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZFtjYWxsYmFja1swXV1bY2FsbGJhY2tbMV1dW2NhbGxiYWNrWzJdXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChsZW5ndGggPT0gNCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChjaGlsZFtjYWxsYmFja1swXV1bY2FsbGJhY2tbMV1dW2NhbGxiYWNrWzJdXVtjYWxsYmFja1szXV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZFtjYWxsYmFja1swXV1bY2FsbGJhY2tbMV1dW2NhbGxiYWNrWzJdXVtjYWxsYmFja1szXV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGNoaWxkW2NhbGxiYWNrXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkW2NhbGxiYWNrXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxzIGEgZnVuY3Rpb24gb24gYWxsIG9mIHRoZSBjaGlsZHJlbiByZWdhcmRsZXNzIGlmIHRoZXkgYXJlIGRlYWQgb3IgYWxpdmUgKHNlZSBjYWxsQWxsRXhpc3RzIGlmIHlvdSBuZWVkIGNvbnRyb2wgb3ZlciB0aGF0KQogICAgKiBBZnRlciB0aGUgbWV0aG9kIHBhcmFtZXRlciBhbmQgY29udGV4dCB5b3UgY2FuIGFkZCBhcyBtYW55IGV4dHJhIHBhcmFtZXRlcnMgYXMgeW91IGxpa2UsIHdoaWNoIHdpbGwgYWxsIGJlIHBhc3NlZCB0byB0aGUgY2hpbGQuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNjYWxsQWxsCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2QgLSBBIHN0cmluZyBjb250YWluaW5nIHRoZSBuYW1lIG9mIHRoZSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkLiBUaGUgZnVuY3Rpb24gbXVzdCBleGlzdCBvbiB0aGUgY2hpbGQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29udGV4dD1udWxsXSAtIEEgc3RyaW5nIGNvbnRhaW5pbmcgdGhlIGNvbnRleHQgdW5kZXIgd2hpY2ggdGhlIG1ldGhvZCB3aWxsIGJlIGV4ZWN1dGVkLiBTZXQgdG8gbnVsbCB0byBkZWZhdWx0IHRvIHRoZSBjaGlsZC4KICAgICogQHBhcmFtIHsuLi4qfSBwYXJhbWV0ZXIgLSBBZGRpdGlvbmFsIHBhcmFtZXRlcnMgdGhhdCB3aWxsIGJlIHBhc3NlZCB0byB0aGUgbWV0aG9kLgogICAgKi8KICAgIGNhbGxBbGw6IGZ1bmN0aW9uIChtZXRob2QsIGNvbnRleHQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBtZXRob2QgPT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gIEV4dHJhY3QgdGhlIG1ldGhvZCBpbnRvIGFuIGFycmF5CiAgICAgICAgbWV0aG9kID0gbWV0aG9kLnNwbGl0KCcuJyk7CgogICAgICAgIHZhciBtZXRob2RMZW5ndGggPSBtZXRob2QubGVuZ3RoOwoKICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQgPT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgY29udGV4dCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBFeHRyYWN0IHRoZSBjb250ZXh0IGludG8gYW4gYXJyYXkKICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0ID09PSAnc3RyaW5nJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQuc3BsaXQoJy4nKTsKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0TGVuZ3RoID0gY29udGV4dC5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgICAgdmFyIGNhbGxiYWNrID0gbnVsbDsKICAgICAgICB2YXIgY2FsbGJhY2tDb250ZXh0ID0gbnVsbDsKCiAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPiAwICYmIHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGQgPSB0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGRvCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gdGhpcy5jYWxsYmFja0Zyb21BcnJheShjaGlsZCwgbWV0aG9kLCBtZXRob2RMZW5ndGgpOwoKICAgICAgICAgICAgICAgIGlmIChjb250ZXh0ICYmIGNhbGxiYWNrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrQ29udGV4dCA9IHRoaXMuY2FsbGJhY2tGcm9tQXJyYXkoY2hpbGQsIGNvbnRleHQsIGNvbnRleHRMZW5ndGgpOwogICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkoY2FsbGJhY2tDb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChjYWxsYmFjaykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShjaGlsZCwgYXJncyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9IHRoaXMuX2NvbnRhaW5lci5sYXN0Ll9pTmV4dCkKCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEFsbG93cyB5b3UgdG8gY2FsbCB5b3VyIG93biBmdW5jdGlvbiBvbiBlYWNoIG1lbWJlciBvZiB0aGlzIEdyb3VwLiBZb3UgbXVzdCBwYXNzIHRoZSBjYWxsYmFjayBhbmQgY29udGV4dCBpbiB3aGljaCBpdCB3aWxsIHJ1bi4KICAgICogQWZ0ZXIgdGhlIGNoZWNrRXhpc3RzIHBhcmFtZXRlciB5b3UgY2FuIGFkZCBhcyBtYW55IHBhcmFtZXRlcnMgYXMgeW91IGxpa2UsIHdoaWNoIHdpbGwgYWxsIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2sgYWxvbmcgd2l0aCB0aGUgY2hpbGQuCiAgICAqIEZvciBleGFtcGxlOiBHcm91cC5mb3JFYWNoKGF3YXJkQm9udXNHb2xkLCB0aGlzLCB0cnVlLCAxMDAsIDUwMCkKICAgICogTm90ZTogQ3VycmVudGx5IHRoaXMgd2lsbCBza2lwIGFueSBjaGlsZHJlbiB3aGljaCBhcmUgR3JvdXBzIHRoZW1zZWx2ZXMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNmb3JFYWNoCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQuIEVhY2ggY2hpbGQgb2YgdGhlIEdyb3VwIHdpbGwgYmUgcGFzc2VkIHRvIGl0IGFzIGl0cyBmaXJzdCBwYXJhbWV0ZXIuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCAodXN1YWxseSAndGhpcycpLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoZWNrRXhpc3RzIC0gSWYgc2V0IG9ubHkgY2hpbGRyZW4gd2l0aCBleGlzdHM9dHJ1ZSB3aWxsIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2ssIG90aGVyd2lzZSBhbGwgY2hpbGRyZW4gd2lsbCBiZSBwYXNzZWQuCiAgICAqLwogICAgZm9yRWFjaDogZnVuY3Rpb24gKGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIGNoZWNrRXhpc3RzKSB7CgogICAgICAgIGlmICh0eXBlb2YgY2hlY2tFeGlzdHMgPT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgY2hlY2tFeGlzdHMgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CiAgICAgICAgYXJncy51bnNoaWZ0KG51bGwpOwoKICAgICAgICBpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCA+IDAgJiYgdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGNoZWNrRXhpc3RzID09PSBmYWxzZSB8fCAoY2hlY2tFeGlzdHMgJiYgY3VycmVudE5vZGUuZXhpc3RzKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBhcmdzWzBdID0gY3VycmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkoY2FsbGJhY2tDb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gdGhpcy5fY29udGFpbmVyLmxhc3QuX2lOZXh0KTsKCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEFsbG93cyB5b3UgdG8gY2FsbCB5b3VyIG93biBmdW5jdGlvbiBvbiBlYWNoIGFsaXZlIG1lbWJlciBvZiB0aGlzIEdyb3VwICh3aGVyZSBjaGlsZC5hbGl2ZT10cnVlKS4gWW91IG11c3QgcGFzcyB0aGUgY2FsbGJhY2sgYW5kIGNvbnRleHQgaW4gd2hpY2ggaXQgd2lsbCBydW4uCiAgICAqIFlvdSBjYW4gYWRkIGFzIG1hbnkgcGFyYW1ldGVycyBhcyB5b3UgbGlrZSwgd2hpY2ggd2lsbCBhbGwgYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjayBhbG9uZyB3aXRoIHRoZSBjaGlsZC4KICAgICogRm9yIGV4YW1wbGU6IEdyb3VwLmZvckVhY2hBbGl2ZShjYXVzZURhbWFnZSwgdGhpcywgNTAwKQogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZm9yRWFjaEFsaXZlCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQuIEVhY2ggY2hpbGQgb2YgdGhlIEdyb3VwIHdpbGwgYmUgcGFzc2VkIHRvIGl0IGFzIGl0cyBmaXJzdCBwYXJhbWV0ZXIuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCAodXN1YWxseSAndGhpcycpLgogICAgKi8KICAgIGZvckVhY2hFeGlzdHM6IGZ1bmN0aW9uIChjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgICAgYXJncy51bnNoaWZ0KG51bGwpOwoKICAgICAgICB0aGlzLml0ZXJhdGUoJ2V4aXN0cycsIHRydWUsIFBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwsIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIGFyZ3MpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFsbG93cyB5b3UgdG8gY2FsbCB5b3VyIG93biBmdW5jdGlvbiBvbiBlYWNoIGFsaXZlIG1lbWJlciBvZiB0aGlzIEdyb3VwICh3aGVyZSBjaGlsZC5hbGl2ZT10cnVlKS4gWW91IG11c3QgcGFzcyB0aGUgY2FsbGJhY2sgYW5kIGNvbnRleHQgaW4gd2hpY2ggaXQgd2lsbCBydW4uCiAgICAqIFlvdSBjYW4gYWRkIGFzIG1hbnkgcGFyYW1ldGVycyBhcyB5b3UgbGlrZSwgd2hpY2ggd2lsbCBhbGwgYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjayBhbG9uZyB3aXRoIHRoZSBjaGlsZC4KICAgICogRm9yIGV4YW1wbGU6IEdyb3VwLmZvckVhY2hBbGl2ZShjYXVzZURhbWFnZSwgdGhpcywgNTAwKQogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZm9yRWFjaEFsaXZlCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQuIEVhY2ggY2hpbGQgb2YgdGhlIEdyb3VwIHdpbGwgYmUgcGFzc2VkIHRvIGl0IGFzIGl0cyBmaXJzdCBwYXJhbWV0ZXIuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCAodXN1YWxseSAndGhpcycpLgogICAgKi8KICAgIGZvckVhY2hBbGl2ZTogZnVuY3Rpb24gKGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgICBhcmdzLnVuc2hpZnQobnVsbCk7CgogICAgICAgIHRoaXMuaXRlcmF0ZSgnYWxpdmUnLCB0cnVlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMLCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBhcmdzKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBbGxvd3MgeW91IHRvIGNhbGwgeW91ciBvd24gZnVuY3Rpb24gb24gZWFjaCBkZWFkIG1lbWJlciBvZiB0aGlzIEdyb3VwICh3aGVyZSBhbGl2ZT1mYWxzZSkuIFlvdSBtdXN0IHBhc3MgdGhlIGNhbGxiYWNrIGFuZCBjb250ZXh0IGluIHdoaWNoIGl0IHdpbGwgcnVuLgogICAgKiBZb3UgY2FuIGFkZCBhcyBtYW55IHBhcmFtZXRlcnMgYXMgeW91IGxpa2UsIHdoaWNoIHdpbGwgYWxsIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2sgYWxvbmcgd2l0aCB0aGUgY2hpbGQuCiAgICAqIEZvciBleGFtcGxlOiBHcm91cC5mb3JFYWNoRGVhZChicmluZ1RvTGlmZSwgdGhpcykKICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2ZvckVhY2hEZWFkCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQuIEVhY2ggY2hpbGQgb2YgdGhlIEdyb3VwIHdpbGwgYmUgcGFzc2VkIHRvIGl0IGFzIGl0cyBmaXJzdCBwYXJhbWV0ZXIuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCAodXN1YWxseSAndGhpcycpLgogICAgKi8KICAgIGZvckVhY2hEZWFkOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgICAgIGFyZ3MudW5zaGlmdChudWxsKTsKCiAgICAgICAgdGhpcy5pdGVyYXRlKCdhbGl2ZScsIGZhbHNlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMLCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBhcmdzKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gc29ydCB0aGUgZ3JvdXAgYWNjb3JkaW5nIHRvIGEgcGFydGljdWxhciB2YWx1ZSBhbmQgb3JkZXIuCiAgICAqIEZvciBleGFtcGxlIHRvIGRlcHRoIHNvcnQgU3ByaXRlcyBmb3IgWmVsZGEtc3R5bGUgZ2FtZSB5b3UgbWlnaHQgY2FsbCBgZ3JvdXAuc29ydCgneScsIFBoYXNlci5Hcm91cC5TT1JUX0FTQ0VORElORylgIGF0IHRoZSBib3R0b20gb2YgeW91ciBgU3RhdGUudXBkYXRlKClgLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNzb3J0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbaW5kZXg9J3knXSAtIFRoZSBgc3RyaW5nYCBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB5b3Ugd2FudCB0byBzb3J0IG9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gW29yZGVyPVBoYXNlci5Hcm91cC5TT1JUX0FTQ0VORElOR10gLSBUaGUgYEdyb3VwYCBjb25zdGFudCB0aGF0IGRlZmluZXMgdGhlIHNvcnQgb3JkZXIuIFBvc3NpYmxlIHZhbHVlcyBhcmUgUGhhc2VyLkdyb3VwLlNPUlRfQVNDRU5ESU5HIGFuZCBQaGFzZXIuR3JvdXAuU09SVF9ERVNDRU5ESU5HLgogICAgKi8KICAgIHNvcnQ6IGZ1bmN0aW9uIChpbmRleCwgb3JkZXIpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PT0gJ3VuZGVmaW5lZCcpIHsgaW5kZXggPSAneSc7IH0KICAgICAgICBpZiAodHlwZW9mIG9yZGVyID09PSAndW5kZWZpbmVkJykgeyBvcmRlciA9IFBoYXNlci5Hcm91cC5TT1JUX0FTQ0VORElORzsgfQoKICAgICAgICB2YXIgc3dhcHBlZDsKICAgICAgICB2YXIgdGVtcDsKCiAgICAgICAgZG8gewoKICAgICAgICAgICAgc3dhcHBlZCA9IGZhbHNlOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggLSAxOyBpIDwgbGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChvcmRlciA9PSBQaGFzZXIuR3JvdXAuU09SVF9BU0NFTkRJTkcpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpXVtpbmRleF0gPiB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baSArIDFdW2luZGV4XSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3dhcCh0aGlzLmdldEF0KGkpLCB0aGlzLmdldEF0KGkgKyAxKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXAgPSB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpXSA9IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpICsgMV07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpICsgMV0gPSB0ZW1wOwogICAgICAgICAgICAgICAgICAgICAgICBzd2FwcGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpXVtpbmRleF0gPCB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baSArIDFdW2luZGV4XSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3dhcCh0aGlzLmdldEF0KGkpLCB0aGlzLmdldEF0KGkgKyAxKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXAgPSB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpXSA9IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpICsgMV07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpICsgMV0gPSB0ZW1wOwogICAgICAgICAgICAgICAgICAgICAgICBzd2FwcGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IHdoaWxlIChzd2FwcGVkKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJdGVyYXRlcyBvdmVyIHRoZSBjaGlsZHJlbiBvZiB0aGUgR3JvdXAuIFdoZW4gYSBjaGlsZCBoYXMgYSBwcm9wZXJ0eSBtYXRjaGluZyBrZXkgdGhhdCBlcXVhbHMgdGhlIGdpdmVuIHZhbHVlLCBpdCBpcyBjb25zaWRlcmVkIGFzIGEgbWF0Y2guCiAgICAqIE1hdGNoZWQgY2hpbGRyZW4gY2FuIGJlIHNlbnQgdG8gdGhlIG9wdGlvbmFsIGNhbGxiYWNrLCBvciBzaW1wbHkgcmV0dXJuZWQgb3IgY291bnRlZC4KICAgICogWW91IGNhbiBhZGQgYXMgbWFueSBjYWxsYmFjayBwYXJhbWV0ZXJzIGFzIHlvdSBsaWtlLCB3aGljaCB3aWxsIGFsbCBiZSBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrIGFsb25nIHdpdGggdGhlIGNoaWxkLCBhZnRlciB0aGUgY2FsbGJhY2tDb250ZXh0IHBhcmFtZXRlci4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2l0ZXJhdGUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBjaGlsZCBwcm9wZXJ0eSB0byBjaGVjaywgaS5lLiAnZXhpc3RzJywgJ2FsaXZlJywgJ2hlYWx0aCcKICAgICogQHBhcmFtIHthbnl9IHZhbHVlIC0gSWYgY2hpbGQua2V5ID09PSB0aGlzIHZhbHVlIGl0IHdpbGwgYmUgY29uc2lkZXJlZCBhIG1hdGNoLiBOb3RlIHRoYXQgYSBzdHJpY3QgY29tcGFyaXNvbiBpcyB1c2VkLgogICAgKiBAcGFyYW0ge251bWJlcn0gcmV0dXJuVHlwZSAtIEhvdyB0byByZXR1cm4gdGhlIGRhdGEgZnJvbSB0aGlzIG1ldGhvZC4gRWl0aGVyIFBoYXNlci5Hcm91cC5SRVRVUk5fTk9ORSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCBvciBQaGFzZXIuR3JvdXAuUkVUVVJOX0NISUxELgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbY2FsbGJhY2s9bnVsbF0gLSBPcHRpb25hbCBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uIGVhY2ggbWF0Y2hpbmcgY2hpbGQuIEVhY2ggY2hpbGQgb2YgdGhlIEdyb3VwIHdpbGwgYmUgcGFzc2VkIHRvIGl0IGFzIGl0cyBmaXJzdCBwYXJhbWV0ZXIuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBbY2FsbGJhY2tDb250ZXh0XSAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRoZSBmdW5jdGlvbiBzaG91bGQgYmUgY2FsbGVkICh1c3VhbGx5ICd0aGlzJykuCiAgICAqIEByZXR1cm4ge2FueX0gUmV0dXJucyBlaXRoZXIgYSBudW1lcmljIHRvdGFsIChpZiBSRVRVUk5fVE9UQUwgd2FzIHNwZWNpZmllZCkgb3IgdGhlIGNoaWxkIG9iamVjdC4KICAgICovCiAgICBpdGVyYXRlOiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgcmV0dXJuVHlwZSwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgYXJncykgewoKICAgICAgICBpZiAocmV0dXJuVHlwZSA9PT0gUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCAmJiB0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIGNhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB2YXIgdG90YWwgPSAwOwoKICAgICAgICBpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCA+IDAgJiYgdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlW2tleV0gPT09IHZhbHVlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRvdGFsKys7CgogICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3NbMF0gPSBjdXJyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkoY2FsbGJhY2tDb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChyZXR1cm5UeXBlID09PSBQaGFzZXIuR3JvdXAuUkVUVVJOX0NISUxEKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gdGhpcy5fY29udGFpbmVyLmxhc3QuX2lOZXh0KTsKICAgICAgICB9CgogICAgICAgIGlmIChyZXR1cm5UeXBlID09PSBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRvdGFsOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChyZXR1cm5UeXBlID09PSBQaGFzZXIuR3JvdXAuUkVUVVJOX0NISUxEKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGwgdGhpcyBmdW5jdGlvbiB0byByZXRyaWV2ZSB0aGUgZmlyc3Qgb2JqZWN0IHdpdGggZXhpc3RzID09ICh0aGUgZ2l2ZW4gc3RhdGUpIGluIHRoZSBHcm91cC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZ2V0Rmlyc3RFeGlzdHMKICAgICogQHBhcmFtIHtib29sZWFufSBzdGF0ZSAtIFRydWUgb3IgZmFsc2UuCiAgICAqIEByZXR1cm4ge0FueX0gVGhlIGZpcnN0IGNoaWxkLCBvciBudWxsIGlmIG5vbmUgZm91bmQuCiAgICAqLwogICAgZ2V0Rmlyc3RFeGlzdHM6IGZ1bmN0aW9uIChzdGF0ZSkgewoKICAgICAgICBpZiAodHlwZW9mIHN0YXRlICE9PSAnYm9vbGVhbicpCiAgICAgICAgewogICAgICAgICAgICBzdGF0ZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5pdGVyYXRlKCdleGlzdHMnLCBzdGF0ZSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9DSElMRCk7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIHJldHJpZXZlIHRoZSBmaXJzdCBvYmplY3Qgd2l0aCBhbGl2ZSA9PT0gdHJ1ZSBpbiB0aGUgZ3JvdXAuCiAgICAqIFRoaXMgaXMgaGFuZHkgZm9yIGNoZWNraW5nIGlmIGV2ZXJ5dGhpbmcgaGFzIGJlZW4gd2lwZWQgb3V0LCBvciBjaG9vc2luZyBhIHNxdWFkIGxlYWRlciwgZXRjLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNnZXRGaXJzdEFsaXZlCiAgICAqIEByZXR1cm4ge0FueX0gVGhlIGZpcnN0IGFsaXZlIGNoaWxkLCBvciBudWxsIGlmIG5vbmUgZm91bmQuCiAgICAqLwogICAgZ2V0Rmlyc3RBbGl2ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4gdGhpcy5pdGVyYXRlKCdhbGl2ZScsIHRydWUsIFBoYXNlci5Hcm91cC5SRVRVUk5fQ0hJTEQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGwgdGhpcyBmdW5jdGlvbiB0byByZXRyaWV2ZSB0aGUgZmlyc3Qgb2JqZWN0IHdpdGggYWxpdmUgPT09IGZhbHNlIGluIHRoZSBncm91cC4KICAgICogVGhpcyBpcyBoYW5keSBmb3IgY2hlY2tpbmcgaWYgZXZlcnl0aGluZyBoYXMgYmVlbiB3aXBlZCBvdXQsIG9yIGNob29zaW5nIGEgc3F1YWQgbGVhZGVyLCBldGMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2dldEZpcnN0RGVhZAogICAgKiBAcmV0dXJuIHtBbnl9IFRoZSBmaXJzdCBkZWFkIGNoaWxkLCBvciBudWxsIGlmIG5vbmUgZm91bmQuCiAgICAqLwogICAgZ2V0Rmlyc3REZWFkOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiB0aGlzLml0ZXJhdGUoJ2FsaXZlJywgZmFsc2UsIFBoYXNlci5Hcm91cC5SRVRVUk5fQ0hJTEQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGwgdGhpcyBmdW5jdGlvbiB0byBmaW5kIG91dCBob3cgbWFueSBtZW1iZXJzIG9mIHRoZSBncm91cCBhcmUgYWxpdmUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NvdW50TGl2aW5nCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG51bWJlciBvZiBjaGlsZHJlbiBmbGFnZ2VkIGFzIGFsaXZlLgogICAgKi8KICAgIGNvdW50TGl2aW5nOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiB0aGlzLml0ZXJhdGUoJ2FsaXZlJywgdHJ1ZSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCk7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIGZpbmQgb3V0IGhvdyBtYW55IG1lbWJlcnMgb2YgdGhlIGdyb3VwIGFyZSBkZWFkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNjb3VudERlYWQKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbnVtYmVyIG9mIGNoaWxkcmVuIGZsYWdnZWQgYXMgZGVhZC4KICAgICovCiAgICBjb3VudERlYWQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuaXRlcmF0ZSgnYWxpdmUnLCBmYWxzZSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIG1lbWJlciBhdCByYW5kb20gZnJvbSB0aGUgZ3JvdXAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2dldFJhbmRvbQogICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnRJbmRleCAtIE9wdGlvbmFsIG9mZnNldCBvZmYgdGhlIGZyb250IG9mIHRoZSBhcnJheS4gRGVmYXVsdCB2YWx1ZSBpcyAwLCBvciB0aGUgYmVnaW5uaW5nIG9mIHRoZSBhcnJheS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGxlbmd0aCAtIE9wdGlvbmFsIHJlc3RyaWN0aW9uIG9uIHRoZSBudW1iZXIgb2YgdmFsdWVzIHlvdSB3YW50IHRvIHJhbmRvbWx5IHNlbGVjdCBmcm9tLgogICAgKiBAcmV0dXJuIHtBbnl9IEEgcmFuZG9tIGNoaWxkIG9mIHRoaXMgR3JvdXAuCiAgICAqLwogICAgZ2V0UmFuZG9tOiBmdW5jdGlvbiAoc3RhcnRJbmRleCwgbGVuZ3RoKSB7CgogICAgICAgIGlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBzdGFydEluZGV4ID0gc3RhcnRJbmRleCB8fCAwOwogICAgICAgIGxlbmd0aCA9IGxlbmd0aCB8fCB0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoOwoKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLm1hdGguZ2V0UmFuZG9tKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbiwgc3RhcnRJbmRleCwgbGVuZ3RoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIHRoZSBnaXZlbiBjaGlsZCBmcm9tIHRoaXMgR3JvdXAgYW5kIHNldHMgaXRzIGdyb3VwIHByb3BlcnR5IHRvIG51bGwuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI3JlbW92ZQogICAgKiBAcGFyYW0ge0FueX0gY2hpbGQgLSBUaGUgY2hpbGQgdG8gcmVtb3ZlLgogICAgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHRoZSBjaGlsZCB3YXMgcmVtb3ZlZCBmcm9tIHRoaXMgR3JvdXAsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICByZW1vdmU6IGZ1bmN0aW9uIChjaGlsZCkgewoKICAgICAgICBpZiAoY2hpbGQuZ3JvdXAgIT09IHRoaXMpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoY2hpbGQuZXZlbnRzKQogICAgICAgIHsKICAgICAgICAgICAgY2hpbGQuZXZlbnRzLm9uUmVtb3ZlZEZyb21Hcm91cC5kaXNwYXRjaChjaGlsZCwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICAvLyAgQ2hlY2sgaXQncyBhY3R1YWxseSBpbiB0aGUgY29udGFpbmVyCiAgICAgICAgaWYgKGNoaWxkLnBhcmVudCA9PT0gdGhpcy5fY29udGFpbmVyKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fY29udGFpbmVyLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmN1cnNvciA9PSBjaGlsZCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9jb250YWluZXIuX2lOZXh0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnNvciA9IHRoaXMuX2NvbnRhaW5lci5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnNvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNoaWxkLmdyb3VwID0gbnVsbDsKCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlcyBhbGwgY2hpbGRyZW4gZnJvbSB0aGlzIEdyb3VwLCBzZXR0aW5nIGFsbCBncm91cCBwcm9wZXJ0aWVzIHRvIG51bGwuCiAgICAqIFRoZSBHcm91cCBjb250YWluZXIgcmVtYWlucyBvbiB0aGUgZGlzcGxheSBsaXN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNyZW1vdmVBbGwKICAgICovCiAgICByZW1vdmVBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBkbwogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlblswXS5ldmVudHMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlblswXS5ldmVudHMub25SZW1vdmVkRnJvbUdyb3VwLmRpc3BhdGNoKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlblswXSwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlblswXSk7CiAgICAgICAgfQogICAgICAgIHdoaWxlICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID4gMCk7CgogICAgICAgIHRoaXMuY3Vyc29yID0gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGFsbCBjaGlsZHJlbiBmcm9tIHRoaXMgR3JvdXAgd2hvcyBpbmRleCBmYWxscyBiZXRlZW4gdGhlIGdpdmVuIHN0YXJ0SW5kZXggYW5kIGVuZEluZGV4IHZhbHVlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjcmVtb3ZlQmV0d2VlbgogICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnRJbmRleCAtIFRoZSBpbmRleCB0byBzdGFydCByZW1vdmluZyBjaGlsZHJlbiBmcm9tLgogICAgKiBAcGFyYW0ge251bWJlcn0gZW5kSW5kZXggLSBUaGUgaW5kZXggdG8gc3RvcCByZW1vdmluZyBjaGlsZHJlbiBmcm9tLiBNdXN0IGJlIGhpZ2hlciB0aGFuIHN0YXJ0SW5kZXggYW5kIGxlc3MgdGhhbiB0aGUgbGVuZ3RoIG9mIHRoZSBHcm91cC4KICAgICovCiAgICByZW1vdmVCZXR3ZWVuOiBmdW5jdGlvbiAoc3RhcnRJbmRleCwgZW5kSW5kZXgpIHsKCiAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoc3RhcnRJbmRleCA+IGVuZEluZGV4IHx8IHN0YXJ0SW5kZXggPCAwIHx8IGVuZEluZGV4ID4gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSBzdGFydEluZGV4OyBpIDwgZW5kSW5kZXg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpXTsKICAgICAgICAgICAgY2hpbGQuZXZlbnRzLm9uUmVtb3ZlZEZyb21Hcm91cC5kaXNwYXRjaChjaGlsZCwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAKICAgICAgICAgICAgaWYgKHRoaXMuY3Vyc29yID09IGNoaWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fY29udGFpbmVyLl9pTmV4dCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnNvciA9IHRoaXMuX2NvbnRhaW5lci5faU5leHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJzb3IgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIERlc3Ryb3lzIHRoaXMgR3JvdXAuIFJlbW92ZXMgYWxsIGNoaWxkcmVuLCB0aGVuIHJlbW92ZXMgdGhlIGNvbnRhaW5lciBmcm9tIHRoZSBkaXNwbGF5IGxpc3QgYW5kIG51bGxzIHJlZmVyZW5jZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2Rlc3Ryb3kKICAgICogQHBhcmFtIHtib29sZWFufSBbZGVzdHJveUNoaWxkcmVuPWZhbHNlXSAtIFNob3VsZCBldmVyeSBjaGlsZCBvZiB0aGlzIEdyb3VwIGhhdmUgaXRzIGRlc3Ryb3kgbWV0aG9kIGNhbGxlZD8KICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoZGVzdHJveUNoaWxkcmVuKSB7CgogICAgICAgIGlmICh0eXBlb2YgZGVzdHJveUNoaWxkcmVuID09PSAndW5kZWZpbmVkJykgeyBkZXN0cm95Q2hpbGRyZW4gPSBmYWxzZTsgfQoKICAgICAgICBpZiAoZGVzdHJveUNoaWxkcmVuKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkbwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW5bMF0uZ3JvdXApCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5bMF0uZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdoaWxlICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID4gMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmVBbGwoKTsKICAgICAgICB9CiAgICAKICAgICAgICB0aGlzLl9jb250YWluZXIucGFyZW50LnJlbW92ZUNoaWxkKHRoaXMuX2NvbnRhaW5lcik7CgogICAgICAgIHRoaXMuX2NvbnRhaW5lciA9IG51bGw7CgogICAgICAgIHRoaXMuZ2FtZSA9IG51bGw7CgogICAgICAgIHRoaXMuZXhpc3RzID0gZmFsc2U7CgogICAgICAgIHRoaXMuY3Vyc29yID0gbnVsbDsKCiAgICB9LAoKICAgIHZhbGlkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciB0ZXN0T2JqZWN0ID0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5sYXN0Ll9pTmV4dDsKICAgICAgICB2YXIgZGlzcGxheU9iamVjdCA9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2U7CiAgICAgICAgdmFyIG5leHRPYmplY3QgPSBudWxsOwogICAgICAgIHZhciBwcmV2T2JqZWN0ID0gbnVsbDsKICAgICAgICB2YXIgY291bnQgPSAwOwoKICAgICAgICBkbwogICAgICAgIHsKICAgICAgICAgICAgaWYgKGNvdW50ID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIGNoZWNrIG5leHQKICAgICAgICAgICAgICAgIGlmIChkaXNwbGF5T2JqZWN0ICE9PSBuZXh0T2JqZWN0KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdjaGVjayBuZXh0IGZhaWwnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gIGNoZWNrIHByZXZpb3VzCiAgICAgICAgICAgICAgICBpZiAoZGlzcGxheU9iamVjdC5faVByZXYgIT09IHByZXZPYmplY3QpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2NoZWNrIHByZXZpb3VzIGZhaWwnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBTZXQgdGhlIG5leHQgb2JqZWN0CiAgICAgICAgICAgIG5leHRPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKICAgICAgICAgICAgcHJldk9iamVjdCA9IGRpc3BsYXlPYmplY3Q7CgogICAgICAgICAgICBkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5faU5leHQ7CgogICAgICAgICAgICBjb3VudCsrOwoKICAgICAgICB9CiAgICAgICAgd2hpbGUoZGlzcGxheU9iamVjdCAhPSB0ZXN0T2JqZWN0KQoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9Cgp9OwoKUGhhc2VyLkdyb3VwLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5Hcm91cDsKCi8qKgoqIEBuYW1lIFBoYXNlci5Hcm91cCN0b3RhbAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3RhbCAtIFRoZSB0b3RhbCBudW1iZXIgb2YgY2hpbGRyZW4gaW4gdGhpcyBHcm91cCB3aG8gaGF2ZSBhIHN0YXRlIG9mIGV4aXN0cyA9IHRydWUuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JvdXAucHJvdG90eXBlLCAidG90YWwiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9jb250YWluZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5pdGVyYXRlKCdleGlzdHMnLCB0cnVlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkdyb3VwI2xlbmd0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsZW5ndGggLSBUaGUgdG90YWwgbnVtYmVyIG9mIGNoaWxkcmVuIGluIHRoaXMgR3JvdXAsIHJlZ2FyZGxlc3Mgb2YgdGhlaXIgZXhpc3RzL2FsaXZlIHN0YXR1cy4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJsZW5ndGgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9jb250YWluZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgR3JvdXAgY29udGFpbmVyLiBZb3UgY2FuIGFkanVzdCB0aGUgR3JvdXAgY29udGFpbmVyIGl0c2VsZiBieSBtb2RpZnlpbmcgaXRzIGNvb3JkaW5hdGVzLgoqIFRoaXMgd2lsbCBoYXZlIG5vIGltcGFjdCBvbiB0aGUgeC95IGNvb3JkaW5hdGVzIG9mIGl0cyBjaGlsZHJlbiwgYnV0IGl0IHdpbGwgdXBkYXRlIHRoZWlyIHdvcmxkVHJhbnNmb3JtIGFuZCBvbi1zY3JlZW4gcG9zaXRpb24uCiogQG5hbWUgUGhhc2VyLkdyb3VwI3gKKiBAcHJvcGVydHkge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIEdyb3VwIGNvbnRhaW5lci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJ4IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jb250YWluZXIucG9zaXRpb24ueDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLl9jb250YWluZXIucG9zaXRpb24ueCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBHcm91cCBjb250YWluZXIuIFlvdSBjYW4gYWRqdXN0IHRoZSBHcm91cCBjb250YWluZXIgaXRzZWxmIGJ5IG1vZGlmeWluZyBpdHMgY29vcmRpbmF0ZXMuCiogVGhpcyB3aWxsIGhhdmUgbm8gaW1wYWN0IG9uIHRoZSB4L3kgY29vcmRpbmF0ZXMgb2YgaXRzIGNoaWxkcmVuLCBidXQgaXQgd2lsbCB1cGRhdGUgdGhlaXIgd29ybGRUcmFuc2Zvcm0gYW5kIG9uLXNjcmVlbiBwb3NpdGlvbi4KKiBAbmFtZSBQaGFzZXIuR3JvdXAjeQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgR3JvdXAgY29udGFpbmVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyb3VwLnByb3RvdHlwZSwgInkiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnRhaW5lci5wb3NpdGlvbi55OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci5wb3NpdGlvbi55ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBhbmdsZSBvZiByb3RhdGlvbiBvZiB0aGUgR3JvdXAgY29udGFpbmVyLiBUaGlzIHdpbGwgYWRqdXN0IHRoZSBHcm91cCBjb250YWluZXIgaXRzZWxmIGJ5IG1vZGlmeWluZyBpdHMgcm90YXRpb24uCiogVGhpcyB3aWxsIGhhdmUgbm8gaW1wYWN0IG9uIHRoZSByb3RhdGlvbiB2YWx1ZSBvZiBpdHMgY2hpbGRyZW4sIGJ1dCBpdCB3aWxsIHVwZGF0ZSB0aGVpciB3b3JsZFRyYW5zZm9ybSBhbmQgb24tc2NyZWVuIHBvc2l0aW9uLgoqIEBuYW1lIFBoYXNlci5Hcm91cCNhbmdsZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBvZiByb3RhdGlvbiBnaXZlbiBpbiBkZWdyZWVzLCB3aGVyZSAwIGRlZ3JlZXMgPSB0byB0aGUgcmlnaHQuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JvdXAucHJvdG90eXBlLCAiYW5nbGUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGgucmFkVG9EZWcodGhpcy5fY29udGFpbmVyLnJvdGF0aW9uKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci5yb3RhdGlvbiA9IFBoYXNlci5NYXRoLmRlZ1RvUmFkKHZhbHVlKTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIGFuZ2xlIG9mIHJvdGF0aW9uIG9mIHRoZSBHcm91cCBjb250YWluZXIuIFRoaXMgd2lsbCBhZGp1c3QgdGhlIEdyb3VwIGNvbnRhaW5lciBpdHNlbGYgYnkgbW9kaWZ5aW5nIGl0cyByb3RhdGlvbi4KKiBUaGlzIHdpbGwgaGF2ZSBubyBpbXBhY3Qgb24gdGhlIHJvdGF0aW9uIHZhbHVlIG9mIGl0cyBjaGlsZHJlbiwgYnV0IGl0IHdpbGwgdXBkYXRlIHRoZWlyIHdvcmxkVHJhbnNmb3JtIGFuZCBvbi1zY3JlZW4gcG9zaXRpb24uCiogQG5hbWUgUGhhc2VyLkdyb3VwI3JvdGF0aW9uCiogQHByb3BlcnR5IHtudW1iZXJ9IHJvdGF0aW9uIC0gVGhlIGFuZ2xlIG9mIHJvdGF0aW9uIGdpdmVuIGluIHJhZGlhbnMuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JvdXAucHJvdG90eXBlLCAicm90YXRpb24iLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnRhaW5lci5yb3RhdGlvbjsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLl9jb250YWluZXIucm90YXRpb24gPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkdyb3VwI3Zpc2libGUKKiBAcHJvcGVydHkge2Jvb2xlYW59IHZpc2libGUgLSBUaGUgdmlzaWJsZSBzdGF0ZSBvZiB0aGUgR3JvdXAuIE5vbi12aXNpYmxlIEdyb3VwcyBhbmQgYWxsIG9mIHRoZWlyIGNoaWxkcmVuIGFyZSBub3QgcmVuZGVyZWQuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JvdXAucHJvdG90eXBlLCAidmlzaWJsZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLnZpc2libGU7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLnZpc2libGUgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkdyb3VwI2FscGhhCiogQHByb3BlcnR5IHtudW1iZXJ9IGFscGhhIC0gVGhlIGFscGhhIHZhbHVlIG9mIHRoZSBHcm91cCBjb250YWluZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JvdXAucHJvdG90eXBlLCAiYWxwaGEiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnRhaW5lci5hbHBoYTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLl9jb250YWluZXIuYWxwaGEgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogIlRoaXMgd29ybGQgaXMgYnV0IGEgY2FudmFzIHRvIG91ciBpbWFnaW5hdGlvbi4iIC0gSGVucnkgRGF2aWQgVGhvcmVhdQoqCiogQSBnYW1lIGhhcyBvbmx5IG9uZSB3b3JsZC4gVGhlIHdvcmxkIGlzIGFuIGFic3RyYWN0IHBsYWNlIGluIHdoaWNoIGFsbCBnYW1lIG9iamVjdHMgbGl2ZS4gSXQgaXMgbm90IGJvdW5kCiogYnkgc3RhZ2UgbGltaXRzIGFuZCBjYW4gYmUgYW55IHNpemUuIFlvdSBsb29rIGludG8gdGhlIHdvcmxkIHZpYSBjYW1lcmFzLiBBbGwgZ2FtZSBvYmplY3RzIGxpdmUgd2l0aGluCiogdGhlIHdvcmxkIGF0IHdvcmxkLWJhc2VkIGNvb3JkaW5hdGVzLiBCeSBkZWZhdWx0IGEgd29ybGQgaXMgY3JlYXRlZCB0aGUgc2FtZSBzaXplIGFzIHlvdXIgU3RhZ2UuCioKKiBAY2xhc3MgUGhhc2VyLldvcmxkCiogQGV4dGVuZHMgUGhhc2VyLkdyb3VwCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIFJlZmVyZW5jZSB0byB0aGUgY3VycmVudCBnYW1lIGluc3RhbmNlLgoqLwpQaGFzZXIuV29ybGQgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIFBoYXNlci5Hcm91cC5jYWxsKHRoaXMsIGdhbWUsIG51bGwsICdfX3dvcmxkJywgZmFsc2UpOwoKICAgIC8qKgogICAgKiBUaGUgV29ybGQgaGFzIG5vIGZpeGVkIHNpemUsIGJ1dCBpdCBkb2VzIGhhdmUgYSBib3VuZHMgb3V0c2lkZSBvZiB3aGljaCBvYmplY3RzIGFyZSBubyBsb25nZXIgY29uc2lkZXJlZCBhcyBiZWluZyAiaW4gd29ybGQiIGFuZCB5b3Ugc2hvdWxkIHVzZSB0aGlzIHRvIGNsZWFuLXVwIHRoZSBkaXNwbGF5IGxpc3QgYW5kIHB1cmdlIGRlYWQgb2JqZWN0cy4KICAgICogQnkgZGVmYXVsdCB3ZSBzZXQgdGhlIEJvdW5kcyB0byBiZSBmcm9tIDAsMCB0byBHYW1lLndpZHRoLEdhbWUuaGVpZ2h0LiBJLmUuIGl0IHdpbGwgbWF0Y2ggdGhlIHNpemUgZ2l2ZW4gdG8gdGhlIGdhbWUgY29uc3RydWN0b3Igd2l0aCAwLDAgcmVwcmVzZW50aW5nIHRoZSB0b3AtbGVmdCBvZiB0aGUgZGlzcGxheS4KICAgICogSG93ZXZlciAwLDAgaXMgYWN0dWFsbHkgdGhlIGNlbnRlciBvZiB0aGUgd29ybGQsIGFuZCBpZiB5b3Ugcm90YXRlIG9yIHNjYWxlIHRoZSB3b3JsZCBhbGwgb2YgdGhhdCB3aWxsIGhhcHBlbiBmcm9tIDAsMC4KICAgICogU28gaWYgeW91IHdhbnQgdG8gbWFrZSBhIGdhbWUgaW4gd2hpY2ggdGhlIHdvcmxkIGl0c2VsZiB3aWxsIHJvdGF0ZSB5b3Ugc2hvdWxkIGFkanVzdCB0aGUgYm91bmRzIHNvIHRoYXQgMCwwIGlzIHRoZSBjZW50ZXIgcG9pbnQsIGkuZS4gc2V0IHRoZW0gdG8gLTEwMDAsLTEwMDAsMjAwMCwyMDAwIGZvciBhIDIwMDB4MjAwMCBzaXplZCB3b3JsZCBjZW50ZXJlZCBhcm91bmQgMCwwLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IGJvdW5kcyAtIEJvdW5kIG9mIHRoaXMgd29ybGQgdGhhdCBvYmplY3RzIGNhbiBub3QgZXNjYXBlIGZyb20uCiAgICAqLwogICAgdGhpcy5ib3VuZHMgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgwLCAwLCBnYW1lLndpZHRoLCBnYW1lLmhlaWdodCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkNhbWVyYX0gY2FtZXJhIC0gQ2FtZXJhIGluc3RhbmNlLgogICAgKi8KICAgIHRoaXMuY2FtZXJhID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGN1cnJlbnRSZW5kZXJPcmRlcklEIC0gUmVzZXQgZWFjaCBmcmFtZSwga2VlcHMgYSBjb3VudCBvZiB0aGUgdG90YWwgbnVtYmVyIG9mIG9iamVjdHMgdXBkYXRlZC4KICAgICovCiAgICB0aGlzLmN1cnJlbnRSZW5kZXJPcmRlcklEID0gMDsKICAgIAp9OwoKUGhhc2VyLldvcmxkLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUGhhc2VyLkdyb3VwLnByb3RvdHlwZSk7ClBoYXNlci5Xb3JsZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuV29ybGQ7CgovKioKKiBJbml0aWFsaXNlcyB0aGUgZ2FtZSB3b3JsZC4KKgoqIEBtZXRob2QgUGhhc2VyLldvcmxkI2Jvb3QKKiBAcHJvdGVjdGVkCiovClBoYXNlci5Xb3JsZC5wcm90b3R5cGUuYm9vdCA9IGZ1bmN0aW9uICgpIHsKCiAgICB0aGlzLmNhbWVyYSA9IG5ldyBQaGFzZXIuQ2FtZXJhKHRoaXMuZ2FtZSwgMCwgMCwgMCwgdGhpcy5nYW1lLndpZHRoLCB0aGlzLmdhbWUuaGVpZ2h0KTsKCiAgICB0aGlzLmNhbWVyYS5kaXNwbGF5T2JqZWN0ID0gdGhpcy5fY29udGFpbmVyOwoKICAgIHRoaXMuZ2FtZS5jYW1lcmEgPSB0aGlzLmNhbWVyYTsKCn0KCi8qKgoqIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgYWZ0ZXIgdGhlIHBsdWdpbnMgcHJlVXBkYXRlIGFuZCBiZWZvcmUgdGhlIFN0YXRlLnVwZGF0ZS4KKiBNb3N0IG9iamVjdHMgaGF2ZSBwcmVVcGRhdGUgbWV0aG9kcyBhbmQgaXQncyB3aGVyZSBpbml0aWFsIG1vdmVtZW50LCBkcmF3aW5nIGFuZCBjYWxjdWxhdGlvbnMgYXJlIGRvbmUuCiogCiogQG1ldGhvZCBQaGFzZXIuV29ybGQjdXBkYXRlCiovClBoYXNlci5Xb3JsZC5wcm90b3R5cGUucHJlVXBkYXRlID0gZnVuY3Rpb24gKCkgewogICAgCiAgICBpZiAodGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5maXJzdC5faU5leHQpCiAgICB7CiAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5maXJzdC5faU5leHQ7CiAgICAgICAgCiAgICAgICAgZG8KICAgICAgICB7CiAgICAgICAgICAgIC8vIElmIHByZVVwZGF0ZSBleGlzdHMsIGFuZCBpdCByZXR1cm5zIGZhbHNlLCBza2lwIFBJWEkgY2hpbGQgb2JqZWN0cwogICAgICAgICAgICBpZiAoY3VycmVudE5vZGVbJ3ByZVVwZGF0ZSddICYmICFjdXJyZW50Tm9kZS5wcmVVcGRhdGUoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5sYXN0Ll9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIH0KICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5sYXN0Ll9pTmV4dCkKICAgIH0KCn0KCi8qKgoqIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgYWZ0ZXIgdGhlIFN0YXRlLnVwZGF0ZSwgYnV0IGJlZm9yZSBwYXJ0aWNsZXMgb3IgcGx1Z2lucyB1cGRhdGUuCiogTW9zdCBvYmplY3RzIHdvbid0IGhhdmUgYW4gdXBkYXRlIG1ldGhvZCBzZXQgdW5sZXNzIGV4cGxpY2l0bHkgZ2l2ZW4gb25lLgoqIAoqIEBtZXRob2QgUGhhc2VyLldvcmxkI3VwZGF0ZQoqLwpQaGFzZXIuV29ybGQucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uICgpIHsKCiAgICB0aGlzLmN1cnJlbnRSZW5kZXJPcmRlcklEID0gMDsKICAgIAogICAgaWYgKHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UuZmlyc3QuX2lOZXh0KQogICAgewogICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UuZmlyc3QuX2lOZXh0OwogICAgICAgIAogICAgICAgIGRvCiAgICAgICAgewogICAgICAgICAgICAvLyBJZiB1cGRhdGUgZXhpc3RzLCBhbmQgaXQgcmV0dXJucyBmYWxzZSwgc2tpcCBQSVhJIGNoaWxkIG9iamVjdHMKICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlWyd1cGRhdGUnXSAmJiAhY3VycmVudE5vZGUudXBkYXRlKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUubGFzdC5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICB9CiAgICAgICAgd2hpbGUgKGN1cnJlbnROb2RlICE9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UubGFzdC5faU5leHQpCiAgICB9Cgp9CgovKioKKiBUaGlzIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGJlZm9yZSB0aGUgcmVuZGVyZXIgcnVucyBhbmQgYWZ0ZXIgdGhlIHBsdWdpbnMgaGF2ZSB1cGRhdGVkLgoqIEluIHBvc3RVcGRhdGUgdGhpcyBpcyB3aGVyZSBhbGwgdGhlIGZpbmFsIHBoeXNpY3MgY2FsY3VsYXRhdGlvbnMgYW5kIG9iamVjdCBwb3NpdGlvbmluZyBoYXBwZW5zLgoqIFRoZSBvYmplY3RzIGFyZSBwcm9jZXNzZWQgaW4gdGhlIG9yZGVyIG9mIHRoZSBkaXNwbGF5IGxpc3QuCiogVGhlIG9ubHkgZXhjZXB0aW9uIHRvIHRoaXMgaXMgaWYgdGhlIGNhbWVyYSBpcyBmb2xsb3dpbmcgYW4gb2JqZWN0LCBpbiB3aGljaCBjYXNlIHRoYXQgaXMgdXBkYXRlZCBmaXJzdC4KKiAKKiBAbWV0aG9kIFBoYXNlci5Xb3JsZCNwb3N0VXBkYXRlCiovClBoYXNlci5Xb3JsZC5wcm90b3R5cGUucG9zdFVwZGF0ZSA9IGZ1bmN0aW9uICgpIHsKCiAgICBpZiAodGhpcy5jYW1lcmEudGFyZ2V0ICYmIHRoaXMuY2FtZXJhLnRhcmdldFsncG9zdFVwZGF0ZSddKQogICAgewogICAgICAgIHRoaXMuY2FtZXJhLnRhcmdldC5wb3N0VXBkYXRlKCk7CgogICAgICAgIHRoaXMuY2FtZXJhLnVwZGF0ZSgpOwoKICAgICAgICBpZiAodGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5maXJzdC5faU5leHQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgY3VycmVudE5vZGUgPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmZpcnN0Ll9pTmV4dDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRvCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZVsncG9zdFVwZGF0ZSddICYmIGN1cnJlbnROb2RlICE9PSB0aGlzLmNhbWVyYS50YXJnZXQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUucG9zdFVwZGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5sYXN0Ll9pTmV4dCkKICAgICAgICB9CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5jYW1lcmEudXBkYXRlKCk7CgogICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmZpcnN0Ll9pTmV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UuZmlyc3QuX2lOZXh0OwogICAgICAgICAgICAKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlWydwb3N0VXBkYXRlJ10pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUucG9zdFVwZGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5sYXN0Ll9pTmV4dCkKICAgICAgICB9CiAgICB9Cgp9CgovKioKKiBVcGRhdGVzIHRoZSBzaXplIG9mIHRoaXMgd29ybGQuIE5vdGUgdGhhdCB0aGlzIGRvZXNuJ3QgbW9kaWZ5IHRoZSB3b3JsZCB4L3kgY29vcmRpbmF0ZXMsIGp1c3QgdGhlIHdpZHRoIGFuZCBoZWlnaHQuCioKKiBAbWV0aG9kIFBoYXNlci5Xb3JsZCNzZXRCb3VuZHMKKiBAcGFyYW0ge251bWJlcn0geCAtIFRvcCBsZWZ0IG1vc3QgY29ybmVyIG9mIHRoZSB3b3JsZC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRvcCBsZWZ0IG1vc3QgY29ybmVyIG9mIHRoZSB3b3JsZC4KKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBOZXcgd2lkdGggb2YgdGhlIHdvcmxkLiBDYW4gbmV2ZXIgYmUgc21hbGxlciB0aGFuIHRoZSBHYW1lLndpZHRoLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBOZXcgaGVpZ2h0IG9mIHRoZSB3b3JsZC4gQ2FuIG5ldmVyIGJlIHNtYWxsZXIgdGhhbiB0aGUgR2FtZS5oZWlnaHQuCiovClBoYXNlci5Xb3JsZC5wcm90b3R5cGUuc2V0Qm91bmRzID0gZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCiAgICBpZiAod2lkdGggPCB0aGlzLmdhbWUud2lkdGgpCiAgICB7CiAgICAgICAgd2lkdGggPSB0aGlzLmdhbWUud2lkdGg7CiAgICB9CgogICAgaWYgKGhlaWdodCA8IHRoaXMuZ2FtZS5oZWlnaHQpCiAgICB7CiAgICAgICAgaGVpZ2h0ID0gdGhpcy5nYW1lLmhlaWdodDsKICAgIH0KCiAgICB0aGlzLmJvdW5kcy5zZXRUbyh4LCB5LCB3aWR0aCwgaGVpZ2h0KTsKCiAgICBpZiAodGhpcy5jYW1lcmEuYm91bmRzKQogICAgewogICAgICAgIC8vICBUaGUgQ2FtZXJhIGNhbiBuZXZlciBiZSBzbWFsbGVyIHRoYW4gdGhlIGdhbWUgc2l6ZQogICAgICAgIHRoaXMuY2FtZXJhLmJvdW5kcy5zZXRUbyh4LCB5LCB3aWR0aCwgaGVpZ2h0KTsKICAgIH0KCiAgICB0aGlzLmdhbWUucGh5c2ljcy5zZXRCb3VuZHNUb1dvcmxkKCk7Cgp9CgovKioKKiBEZXN0cm95ZXIgb2Ygd29ybGRzLgoqIEBtZXRob2QgUGhhc2VyLldvcmxkI2Rlc3Ryb3kKKi8KUGhhc2VyLldvcmxkLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuY2FtZXJhLnggPSAwOwogICAgdGhpcy5jYW1lcmEueSA9IDA7CgogICAgdGhpcy5nYW1lLmlucHV0LnJlc2V0KHRydWUpOwoKICAgIHRoaXMucmVtb3ZlQWxsKCk7Cgp9CgovKioKKiBAbmFtZSBQaGFzZXIuV29ybGQjd2lkdGgKKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBHZXRzIG9yIHNldHMgdGhlIGN1cnJlbnQgd2lkdGggb2YgdGhlIGdhbWUgd29ybGQuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuV29ybGQucHJvdG90eXBlLCAid2lkdGgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYm91bmRzLndpZHRoOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuYm91bmRzLndpZHRoID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Xb3JsZCNoZWlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gR2V0cyBvciBzZXRzIHRoZSBjdXJyZW50IGhlaWdodCBvZiB0aGUgZ2FtZSB3b3JsZC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Xb3JsZC5wcm90b3R5cGUsICJoZWlnaHQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYm91bmRzLmhlaWdodDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLmJvdW5kcy5oZWlnaHQgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLldvcmxkI2NlbnRlclgKKiBAcHJvcGVydHkge251bWJlcn0gY2VudGVyWCAtIEdldHMgdGhlIFggcG9zaXRpb24gY29ycmVzcG9uZGluZyB0byB0aGUgY2VudGVyIHBvaW50IG9mIHRoZSB3b3JsZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Xb3JsZC5wcm90b3R5cGUsICJjZW50ZXJYIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmJvdW5kcy5oYWxmV2lkdGg7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Xb3JsZCNjZW50ZXJZCiogQHByb3BlcnR5IHtudW1iZXJ9IGNlbnRlclkgLSBHZXRzIHRoZSBZIHBvc2l0aW9uIGNvcnJlc3BvbmRpbmcgdG8gdGhlIGNlbnRlciBwb2ludCBvZiB0aGUgd29ybGQuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuV29ybGQucHJvdG90eXBlLCAiY2VudGVyWSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5ib3VuZHMuaGFsZkhlaWdodDsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLldvcmxkI3JhbmRvbVgKKiBAcHJvcGVydHkge251bWJlcn0gcmFuZG9tWCAtIEdldHMgYSByYW5kb20gaW50ZWdlciB3aGljaCBpcyBsZXNzZXIgdGhhbiBvciBlcXVhbCB0byB0aGUgY3VycmVudCB3aWR0aCBvZiB0aGUgZ2FtZSB3b3JsZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Xb3JsZC5wcm90b3R5cGUsICJyYW5kb21YIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5ib3VuZHMueCA8IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnJuZC5pbnRlZ2VySW5SYW5nZSh0aGlzLmJvdW5kcy54LCAodGhpcy5ib3VuZHMud2lkdGggLSBNYXRoLmFicyh0aGlzLmJvdW5kcy54KSkpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnJuZC5pbnRlZ2VySW5SYW5nZSh0aGlzLmJvdW5kcy54LCB0aGlzLmJvdW5kcy53aWR0aCk7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLldvcmxkI3JhbmRvbVkKKiBAcHJvcGVydHkge251bWJlcn0gcmFuZG9tWSAtIEdldHMgYSByYW5kb20gaW50ZWdlciB3aGljaCBpcyBsZXNzZXIgdGhhbiBvciBlcXVhbCB0byB0aGUgY3VycmVudCBoZWlnaHQgb2YgdGhlIGdhbWUgd29ybGQuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuV29ybGQucHJvdG90eXBlLCAicmFuZG9tWSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuYm91bmRzLnkgPCAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5ybmQuaW50ZWdlckluUmFuZ2UodGhpcy5ib3VuZHMueSwgKHRoaXMuYm91bmRzLmhlaWdodCAtIE1hdGguYWJzKHRoaXMuYm91bmRzLnkpKSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMuYm91bmRzLnksIHRoaXMuYm91bmRzLmhlaWdodCk7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLldvcmxkI3Zpc2libGUKKiBAcHJvcGVydHkge2Jvb2xlYW59IHZpc2libGUgLSBHZXRzIG9yIHNldHMgdGhlIHZpc2libGUgc3RhdGUgb2YgdGhlIFdvcmxkLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLldvcmxkLnByb3RvdHlwZSwgInZpc2libGUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnRhaW5lci52aXNpYmxlOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci52aXNpYmxlID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEdhbWUgY29uc3RydWN0b3IKKgoqIEluc3RhbnRpYXRlIGEgbmV3IDxjb2RlPlBoYXNlci5HYW1lPC9jb2RlPiBvYmplY3QuCiogQGNsYXNzIFBoYXNlci5HYW1lCiogQGNsYXNzZGVzYyBUaGlzIGlzIHdoZXJlIHRoZSBtYWdpYyBoYXBwZW5zLiBUaGUgR2FtZSBvYmplY3QgaXMgdGhlIGhlYXJ0IG9mIHlvdXIgZ2FtZSwKKiBwcm92aWRpbmcgcXVpY2sgYWNjZXNzIHRvIGNvbW1vbiBmdW5jdGlvbnMgYW5kIGhhbmRsaW5nIHRoZSBib290IHByb2Nlc3MuCiogIkhlbGwsIHRoZXJlIGFyZSBubyBydWxlcyBoZXJlIC0gd2UncmUgdHJ5aW5nIHRvIGFjY29tcGxpc2ggc29tZXRoaW5nLiIKKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaG9tYXMgQS4gRWRpc29uCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aD04MDBdIC0gVGhlIHdpZHRoIG9mIHlvdXIgZ2FtZSBpbiBnYW1lIHBpeGVscy4KKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodD02MDBdIC0gVGhlIGhlaWdodCBvZiB5b3VyIGdhbWUgaW4gZ2FtZSBwaXhlbHMuCiogQHBhcmFtIHtudW1iZXJ9IFtyZW5kZXJlcj1QaGFzZXIuQVVUT10gLSBXaGljaCByZW5kZXJlciB0byB1c2U6IFBoYXNlci5BVVRPIHdpbGwgYXV0by1kZXRlY3QsIFBoYXNlci5XRUJHTCwgUGhhc2VyLkNBTlZBUyBvciBQaGFzZXIuSEVBRExFU1MgKG5vIHJlbmRlcmluZyBhdCBhbGwpLgoqIEBwYXJhbSB7c3RyaW5nfEhUTUxFbGVtZW50fSBbcGFyZW50PScnXSAtIFRoZSBET00gZWxlbWVudCBpbnRvIHdoaWNoIHRoaXMgZ2FtZXMgY2FudmFzIHdpbGwgYmUgaW5qZWN0ZWQuIEVpdGhlciBhIERPTSBJRCAoc3RyaW5nKSBvciB0aGUgZWxlbWVudCBpdHNlbGYuCiogQHBhcmFtIHtvYmplY3R9IFtzdGF0ZT1udWxsXSAtIFRoZSBkZWZhdWx0IHN0YXRlIG9iamVjdC4gQSBvYmplY3QgY29uc2lzdGluZyBvZiBQaGFzZXIuU3RhdGUgZnVuY3Rpb25zIChwcmVsb2FkLCBjcmVhdGUsIHVwZGF0ZSwgcmVuZGVyKSBvciBudWxsLgoqIEBwYXJhbSB7Ym9vbGVhbn0gW3RyYW5zcGFyZW50PWZhbHNlXSAtIFVzZSBhIHRyYW5zcGFyZW50IGNhbnZhcyBiYWNrZ3JvdW5kIG9yIG5vdC4KKiBAcGFyYW0gIHtib29sZWFufSBbYW50aWFsaWFzPXRydWVdIC0gQW50aS1hbGlhcyBncmFwaGljcy4KKi8KUGhhc2VyLkdhbWUgPSBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCwgcmVuZGVyZXIsIHBhcmVudCwgc3RhdGUsIHRyYW5zcGFyZW50LCBhbnRpYWxpYXMpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGlkIC0gUGhhc2VyIEdhbWUgSUQgKGZvciB3aGVuIFBpeGkgc3VwcG9ydHMgbXVsdGlwbGUgaW5zdGFuY2VzKS4KICAgICovCiAgICB0aGlzLmlkID0gUGhhc2VyLkdBTUVTLnB1c2godGhpcykgLSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gY29uZmlnIC0gVGhlIFBoYXNlci5HYW1lIGNvbmZpZ3VyYXRpb24gb2JqZWN0LgogICAgKi8KICAgIHRoaXMuY29uZmlnID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtIVE1MRWxlbWVudH0gcGFyZW50IC0gVGhlIEdhbWVzIERPTSBwYXJlbnQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYXJlbnQgPSAnJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gVGhlIEdhbWUgd2lkdGggKGluIHBpeGVscykuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy53aWR0aCA9IDgwMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIFRoZSBHYW1lIGhlaWdodCAoaW4gcGl4ZWxzKS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmhlaWdodCA9IDYwMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB0cmFuc3BhcmVudCAtIFVzZSBhIHRyYW5zcGFyZW50IGNhbnZhcyBiYWNrZ3JvdW5kIG9yIG5vdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRyYW5zcGFyZW50ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYW50aWFsaWFzIC0gQW50aS1hbGlhcyBncmFwaGljcyAoaW4gV2ViR0wgdGhpcyBoZWxwcyB3aXRoIGVkZ2VzLCBpbiBDYW52YXMyRCBpdCByZXRhaW5zIHBpeGVsLWFydCBxdWFsaXR5KS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFudGlhbGlhcyA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZW5kZXJlciAtIFRoZSBQaXhpIFJlbmRlcmVyCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5yZW5kZXJlciA9IFBoYXNlci5BVVRPOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcmVuZGVyVHlwZSAtIFRoZSBSZW5kZXJlciB0aGlzIFBoYXNlci5HYW1lIHdpbGwgdXNlLiBFaXRoZXIgUGhhc2VyLlJFTkRFUkVSX0FVVE8sIFBoYXNlci5SRU5ERVJFUl9DQU5WQVMgb3IgUGhhc2VyLlJFTkRFUkVSX1dFQkdMLgogICAgKi8KICAgIHRoaXMucmVuZGVyVHlwZSA9IFBoYXNlci5BVVRPOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc3RhdGUgLSBUaGUgU3RhdGVNYW5hZ2VyLgogICAgKi8KICAgIHRoaXMuc3RhdGUgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9wYXVzZWQgLSBJcyBnYW1lIHBhdXNlZD8KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9wYXVzZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfbG9hZENvbXBsZXRlIC0gV2hldGhlciBsb2FkIGNvbXBsZXRlIGxvYWRpbmcgb3Igbm90LgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX2xvYWRDb21wbGV0ZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzQm9vdGVkIC0gV2hldGhlciB0aGUgZ2FtZSBlbmdpbmUgaXMgYm9vdGVkLCBha2EgYXZhaWxhYmxlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNCb290ZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpZCAtSXMgZ2FtZSBydW5uaW5nIG9yIHBhdXNlZD8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWV9IHJhZiAtIEF1dG9tYXRpY2FsbHkgaGFuZGxlcyB0aGUgY29yZSBnYW1lIGxvb3AgdmlhIHJlcXVlc3RBbmltYXRpb25GcmFtZSBvciBzZXRUaW1lb3V0CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5yYWYgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lT2JqZWN0RmFjdG9yeX0gYWRkIC0gUmVmZXJlbmNlIHRvIHRoZSBHYW1lT2JqZWN0IEZhY3RvcnkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hZGQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5DYWNoZX0gY2FjaGUgLSBSZWZlcmVuY2UgdG8gdGhlIGFzc2V0cyBjYWNoZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNhY2hlID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuSW5wdXR9IGlucHV0IC0gUmVmZXJlbmNlIHRvIHRoZSBpbnB1dCBtYW5hZ2VyCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pbnB1dCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkxvYWRlcn0gbG9hZCAtIFJlZmVyZW5jZSB0byB0aGUgYXNzZXRzIGxvYWRlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmxvYWQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5NYXRofSBtYXRoIC0gUmVmZXJlbmNlIHRvIHRoZSBtYXRoIGhlbHBlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1hdGggPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5OZXR9IG5ldCAtIFJlZmVyZW5jZSB0byB0aGUgbmV0d29yayBjbGFzcy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm5ldCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNvdW5kTWFuYWdlcn0gc291bmQgLSBSZWZlcmVuY2UgdG8gdGhlIHNvdW5kIG1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zb3VuZCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlN0YWdlfSBzdGFnZSAtIFJlZmVyZW5jZSB0byB0aGUgc3RhZ2UuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zdGFnZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlRpbWVNYW5hZ2VyfSB0aW1lIC0gUmVmZXJlbmNlIHRvIGdhbWUgY2xvY2suCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50aW1lID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuVHdlZW5NYW5hZ2VyfSB0d2VlbnMgLSBSZWZlcmVuY2UgdG8gdGhlIHR3ZWVuIG1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50d2VlbnMgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Xb3JsZH0gd29ybGQgLSBSZWZlcmVuY2UgdG8gdGhlIHdvcmxkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMud29ybGQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5QaHlzaWNzLlBoeXNpY3NNYW5hZ2VyfSBwaHlzaWNzIC0gUmVmZXJlbmNlIHRvIHRoZSBwaHlzaWNzIG1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5waHlzaWNzID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvcn0gcm5kIC0gSW5zdGFuY2Ugb2YgcmVwZWF0YWJsZSByYW5kb20gZGF0YSBnZW5lcmF0b3IgaGVscGVyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucm5kID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuRGV2aWNlfSBkZXZpY2UgLSBDb250YWlucyBkZXZpY2UgaW5mb3JtYXRpb24gYW5kIGNhcGFiaWxpdGllcy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmRldmljZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBoeXNpY3MuUGh5c2ljc01hbmFnZXJ9IGNhbWVyYSAtIEEgaGFuZHkgcmVmZXJlbmNlIHRvIHdvcmxkLmNhbWVyYS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNhbWVyYSA9IG51bGw7CgogICAgICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIEEgaGFuZHkgcmVmZXJlbmNlIHRvIHJlbmRlcmVyLnZpZXcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jYW52YXMgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0NvbnRleHR9IGNvbnRleHQgLSBBIGhhbmR5IHJlZmVyZW5jZSB0byByZW5kZXJlci5jb250ZXh0IChvbmx5IHNldCBmb3IgQ0FOVkFTIGdhbWVzKQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29udGV4dCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlV0aWxzLkRlYnVnfSBkZWJ1ZyAtIEEgc2V0IG9mIHVzZWZ1bCBkZWJ1ZyB1dGlsaXRpZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmRlYnVnID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUGFydGljbGVzfSBwYXJ0aWNsZXMgLSBUaGUgUGFydGljbGUgTWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhcnRpY2xlcyA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gc3RlcHBpbmcgLSBFbmFibGUgY29yZSBsb29wIHN0ZXBwaW5nIHdpdGggR2FtZS5lbmFibGVTdGVwKCkuCiAgICAqIEBkZWZhdWx0CiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMuc3RlcHBpbmcgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBzdGVwcGluZyAtIEFuIGludGVybmFsIHByb3BlcnR5IHVzZWQgYnkgZW5hYmxlU3RlcCwgYnV0IGFsc28gdXNlZnVsIHRvIHF1ZXJ5IGZyb20geW91ciBvd24gZ2FtZSBvYmplY3RzLgogICAgKiBAZGVmYXVsdAogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnBlbmRpbmdTdGVwID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzdGVwQ291bnQgLSBXaGVuIHN0ZXBwaW5nIGlzIGVuYWJsZWQgdGhpcyBjb250YWlucyB0aGUgY3VycmVudCBzdGVwIGN5Y2xlLgogICAgKiBAZGVmYXVsdAogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnN0ZXBDb3VudCA9IDA7CgogICAgLy8gIFBhcnNlIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCAoaWYgYW55KQogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gJ29iamVjdCcpCiAgICB7CiAgICAgICAgdGhpcy5wYXJzZUNvbmZpZyhhcmd1bWVudHNbMF0pOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGlmICh0eXBlb2Ygd2lkdGggIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBoZWlnaHQgIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHJlbmRlcmVyICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjsKICAgICAgICAgICAgdGhpcy5yZW5kZXJUeXBlID0gcmVuZGVyZXI7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHBhcmVudCAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgdHJhbnNwYXJlbnQgIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50cmFuc3BhcmVudCA9IHRyYW5zcGFyZW50OwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBhbnRpYWxpYXMgIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hbnRpYWxpYXMgPSBhbnRpYWxpYXM7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0YXRlID0gbmV3IFBoYXNlci5TdGF0ZU1hbmFnZXIodGhpcywgc3RhdGUpOwogICAgfQoKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgdGhpcy5fb25Cb290ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBfdGhpcy5ib290KCk7CiAgICB9CgogICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2ludGVyYWN0aXZlJykKICAgIHsKICAgICAgICB3aW5kb3cuc2V0VGltZW91dCh0aGlzLl9vbkJvb3QsIDApOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCB0aGlzLl9vbkJvb3QsIGZhbHNlKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIHRoaXMuX29uQm9vdCwgZmFsc2UpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwoKfTsKClBoYXNlci5HYW1lLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogUGFyc2VzIGEgR2FtZSBjb25maWd1cmF0aW9uIG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZSNwYXJzZUNvbmZpZwogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcGFyc2VDb25maWc6IGZ1bmN0aW9uIChjb25maWcpIHsKCiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7CgogICAgICAgIGlmIChjb25maWdbJ3dpZHRoJ10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5wYXJzZURpbWVuc2lvbihjb25maWdbJ3dpZHRoJ10sIDApOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZ1snaGVpZ2h0J10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmhlaWdodCA9IHRoaXMucGFyc2VEaW1lbnNpb24oY29uZmlnWydoZWlnaHQnXSwgMSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoY29uZmlnWydyZW5kZXJlciddKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IGNvbmZpZ1sncmVuZGVyZXInXTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJUeXBlID0gY29uZmlnWydyZW5kZXJlciddOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZ1sncGFyZW50J10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnBhcmVudCA9IGNvbmZpZ1sncGFyZW50J107CiAgICAgICAgfQoKICAgICAgICBpZiAoY29uZmlnWyd0cmFuc3BhcmVudCddKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50cmFuc3BhcmVudCA9IGNvbmZpZ1sndHJhbnNwYXJlbnQnXTsKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWdbJ2FudGlhbGlhcyddKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hbnRpYWxpYXMgPSBjb25maWdbJ2FudGlhbGlhcyddOwogICAgICAgIH0KCiAgICAgICAgdmFyIHN0YXRlID0gbnVsbDsKCiAgICAgICAgaWYgKGNvbmZpZ1snc3RhdGUnXSkKICAgICAgICB7CiAgICAgICAgICAgIHN0YXRlID0gY29uZmlnWydzdGF0ZSddOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdGF0ZSA9IG5ldyBQaGFzZXIuU3RhdGVNYW5hZ2VyKHRoaXMsIHN0YXRlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgZGltZW5zaW9uLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI3BhcnNlRGltZW5zaW9uCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwYXJzZURpbWVuc2lvbjogZnVuY3Rpb24gKHNpemUsIGRpbWVuc2lvbikgewoKICAgICAgICB2YXIgZiA9IDA7CiAgICAgICAgdmFyIHB4ID0gMDsKCiAgICAgICAgaWYgKHR5cGVvZiBzaXplID09PSAnc3RyaW5nJykKICAgICAgICB7CiAgICAgICAgICAgIC8vICAlPwogICAgICAgICAgICBpZiAoc2l6ZS5zdWJzdHIoLTEpID09PSAnJScpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGYgPSBwYXJzZUludChzaXplLCAxMCkgLyAxMDA7CgogICAgICAgICAgICAgICAgaWYgKGRpbWVuc2lvbiA9PT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBweCA9IHdpbmRvdy5pbm5lcldpZHRoICogZjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBweCA9IHdpbmRvdy5pbm5lckhlaWdodCAqIGY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBweCA9IHBhcnNlSW50KHNpemUsIDEwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBweCA9IHNpemU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcHg7CgogICAgfSwKCiAgICAvKioKICAgICogSW5pdGlhbGl6ZSBlbmdpbmUgc3ViIG1vZHVsZXMgYW5kIHN0YXJ0IHRoZSBnYW1lLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI2Jvb3QKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGJvb3Q6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuaXNCb290ZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoIWRvY3VtZW50LmJvZHkpCiAgICAgICAgewogICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dCh0aGlzLl9vbkJvb3QsIDIwKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIHRoaXMuX29uQm9vdCk7CiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdsb2FkJywgdGhpcy5fb25Cb290KTsKCiAgICAgICAgICAgIHRoaXMub25QYXVzZSA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgICAgIHRoaXMub25SZXN1bWUgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgICAgICAgICAgdGhpcy5pc0Jvb3RlZCA9IHRydWU7CgogICAgICAgICAgICB0aGlzLmRldmljZSA9IG5ldyBQaGFzZXIuRGV2aWNlKCk7CiAgICAgICAgICAgIHRoaXMubWF0aCA9IFBoYXNlci5NYXRoOwogICAgICAgICAgICB0aGlzLnJuZCA9IG5ldyBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvcihbKERhdGUubm93KCkgKiBNYXRoLnJhbmRvbSgpKS50b1N0cmluZygpXSk7CgogICAgICAgICAgICB0aGlzLnN0YWdlID0gbmV3IFBoYXNlci5TdGFnZSh0aGlzLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgogICAgICAgICAgICB0aGlzLnNldFVwUmVuZGVyZXIoKTsKCiAgICAgICAgICAgIHRoaXMud29ybGQgPSBuZXcgUGhhc2VyLldvcmxkKHRoaXMpOwogICAgICAgICAgICB0aGlzLmFkZCA9IG5ldyBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkodGhpcyk7CiAgICAgICAgICAgIHRoaXMuY2FjaGUgPSBuZXcgUGhhc2VyLkNhY2hlKHRoaXMpOwogICAgICAgICAgICB0aGlzLmxvYWQgPSBuZXcgUGhhc2VyLkxvYWRlcih0aGlzKTsKICAgICAgICAgICAgdGhpcy50aW1lID0gbmV3IFBoYXNlci5UaW1lKHRoaXMpOwogICAgICAgICAgICB0aGlzLnR3ZWVucyA9IG5ldyBQaGFzZXIuVHdlZW5NYW5hZ2VyKHRoaXMpOwogICAgICAgICAgICB0aGlzLmlucHV0ID0gbmV3IFBoYXNlci5JbnB1dCh0aGlzKTsKICAgICAgICAgICAgdGhpcy5zb3VuZCA9IG5ldyBQaGFzZXIuU291bmRNYW5hZ2VyKHRoaXMpOwogICAgICAgICAgICB0aGlzLnBoeXNpY3MgPSBuZXcgUGhhc2VyLlBoeXNpY3MuQXJjYWRlKHRoaXMpOwogICAgICAgICAgICB0aGlzLnBhcnRpY2xlcyA9IG5ldyBQaGFzZXIuUGFydGljbGVzKHRoaXMpOwogICAgICAgICAgICB0aGlzLnBsdWdpbnMgPSBuZXcgUGhhc2VyLlBsdWdpbk1hbmFnZXIodGhpcywgdGhpcyk7CiAgICAgICAgICAgIHRoaXMubmV0ID0gbmV3IFBoYXNlci5OZXQodGhpcyk7CiAgICAgICAgICAgIHRoaXMuZGVidWcgPSBuZXcgUGhhc2VyLlV0aWxzLkRlYnVnKHRoaXMpOwoKICAgICAgICAgICAgdGhpcy50aW1lLmJvb3QoKTsKICAgICAgICAgICAgdGhpcy5zdGFnZS5ib290KCk7CiAgICAgICAgICAgIHRoaXMud29ybGQuYm9vdCgpOwogICAgICAgICAgICB0aGlzLmlucHV0LmJvb3QoKTsKICAgICAgICAgICAgdGhpcy5zb3VuZC5ib290KCk7CiAgICAgICAgICAgIHRoaXMuc3RhdGUuYm9vdCgpOwoKICAgICAgICAgICAgdGhpcy5sb2FkLm9uTG9hZENvbXBsZXRlLmFkZCh0aGlzLmxvYWRDb21wbGV0ZSwgdGhpcyk7CgogICAgICAgICAgICB0aGlzLnNob3dEZWJ1Z0hlYWRlcigpOwoKICAgICAgICAgICAgdGhpcy5pc1J1bm5pbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9sb2FkQ29tcGxldGUgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMucmFmID0gbmV3IFBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcyk7CiAgICAgICAgICAgIHRoaXMucmFmLnN0YXJ0KCk7CgogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBEaXNwbGF5cyBhIFBoYXNlciB2ZXJzaW9uIGRlYnVnIGhlYWRlciBpbiB0aGUgY29uc29sZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZSNzaG93RGVidWdIZWFkZXIKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHNob3dEZWJ1Z0hlYWRlcjogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgdiA9IFBoYXNlci5ERVZfVkVSU0lPTjsKICAgICAgICB2YXIgciA9ICdDYW52YXMnOwogICAgICAgIHZhciBhID0gJ0hUTUwgQXVkaW8nOwoKICAgICAgICBpZiAodGhpcy5yZW5kZXJUeXBlID09IFBoYXNlci5XRUJHTCkKICAgICAgICB7CiAgICAgICAgICAgIHIgPSAnV2ViR0wnOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnJlbmRlclR5cGUgPT0gUGhhc2VyLkhFQURMRVNTKQogICAgICAgIHsKICAgICAgICAgICAgciA9ICdIZWFkbGVzcyc7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5kZXZpY2Uud2ViQXVkaW8pCiAgICAgICAgewogICAgICAgICAgICBhID0gJ1dlYkF1ZGlvJzsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmRldmljZS5jaHJvbWUpCiAgICAgICAgewogICAgICAgICAgICB2YXIgYXJncyA9IFsKICAgICAgICAgICAgICAgICclYyAlYyAlYyAgUGhhc2VyIHYnICsgdiArICcgLSBSZW5kZXJlcjogJyArIHIgKyAnIC0gQXVkaW86ICcgKyBhICsgJyAgJWMgJWMgJywKICAgICAgICAgICAgICAgICdiYWNrZ3JvdW5kOiAjMDBiZmYzJywKICAgICAgICAgICAgICAgICdiYWNrZ3JvdW5kOiAjMDA3MmJjJywKICAgICAgICAgICAgICAgICdjb2xvcjogI2ZmZmZmZjsgYmFja2dyb3VuZDogIzAwMzQ3MScsCiAgICAgICAgICAgICAgICAnYmFja2dyb3VuZDogIzAwNzJiYycsCiAgICAgICAgICAgICAgICAnYmFja2dyb3VuZDogIzAwYmZmMycKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIGNvbnNvbGUubG9nLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLmxvZygnUGhhc2VyIHYnICsgdiArICcgLSBSZW5kZXJlcjogJyArIHIgKyAnIC0gQXVkaW86ICcgKyBhKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGlmIHRoZSBkZXZpY2UgaXMgY2FwYWJsZSBvZiB1c2luZyB0aGUgcmVxdWVzdGVkIHJlbmRlcmVyIGFuZCBzZXRzIGl0IHVwIG9yIGFuIGFsdGVybmF0aXZlIGlmIG5vdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZSNzZXRVcFJlbmRlcmVyCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBzZXRVcFJlbmRlcmVyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8qCiAgICAgICAgaWYgKHRoaXMuZGV2aWNlLnRyaWRlbnQpCiAgICAgICAgewogICAgICAgICAgICAvLyAgUGl4aSBXZWJHTCByZW5kZXJlciBvbiBJRTExIGRvZXNuJ3Qgd29yayBjb3JyZWN0bHkgd2l0aCBtYXNrcywgaWYgeW91IG5lZWQgdGhlbSB5b3UgbWF5IHdhbnQgdG8gY29tbWVudCB0aGlzIGJsb2NrIG91dAogICAgICAgICAgICB0aGlzLnJlbmRlclR5cGUgPSBQaGFzZXIuQ0FOVkFTOwogICAgICAgIH0KICAgICAgICAqLwoKICAgICAgICBpZiAodGhpcy5yZW5kZXJUeXBlID09PSBQaGFzZXIuSEVBRExFU1MgfHwgdGhpcy5yZW5kZXJUeXBlID09PSBQaGFzZXIuQ0FOVkFTIHx8ICh0aGlzLnJlbmRlclR5cGUgPT09IFBoYXNlci5BVVRPICYmIHRoaXMuZGV2aWNlLndlYkdMID09PSBmYWxzZSkpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5kZXZpY2UuY2FudmFzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5yZW5kZXJUeXBlID09PSBQaGFzZXIuQVVUTykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclR5cGUgPSBQaGFzZXIuQ0FOVkFTOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSBuZXcgUElYSS5DYW52YXNSZW5kZXJlcih0aGlzLndpZHRoLCB0aGlzLmhlaWdodCwgdGhpcy5zdGFnZS5jYW52YXMsIHRoaXMudHJhbnNwYXJlbnQpOwogICAgICAgICAgICAgICAgUGhhc2VyLkNhbnZhcy5zZXRTbW9vdGhpbmdFbmFibGVkKHRoaXMucmVuZGVyZXIuY29udGV4dCwgdGhpcy5hbnRpYWxpYXMpOwogICAgICAgICAgICAgICAgdGhpcy5jYW52YXMgPSB0aGlzLnJlbmRlcmVyLnZpZXc7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQgPSB0aGlzLnJlbmRlcmVyLmNvbnRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BoYXNlci5HYW1lIC0gY2Fubm90IGNyZWF0ZSBDYW52YXMgb3IgV2ViR0wgY29udGV4dCwgYWJvcnRpbmcuJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFRoZXkgcmVxdWVzdGVkIFdlYkdMLCBhbmQgdGhlaXIgYnJvd3NlciBzdXBwb3J0cyBpdAogICAgICAgICAgICB0aGlzLnJlbmRlclR5cGUgPSBQaGFzZXIuV0VCR0w7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSBuZXcgUElYSS5XZWJHTFJlbmRlcmVyKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0LCB0aGlzLnN0YWdlLmNhbnZhcywgdGhpcy50cmFuc3BhcmVudCwgdGhpcy5hbnRpYWxpYXMpOwogICAgICAgICAgICB0aGlzLmNhbnZhcyA9IHRoaXMucmVuZGVyZXIudmlldzsKICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIFBoYXNlci5DYW52YXMuYWRkVG9ET00odGhpcy5yZW5kZXJlci52aWV3LCB0aGlzLnBhcmVudCwgdHJ1ZSk7CiAgICAgICAgUGhhc2VyLkNhbnZhcy5zZXRUb3VjaEFjdGlvbih0aGlzLnJlbmRlcmVyLnZpZXcpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCB3aGVuIHRoZSBsb2FkIGhhcyBmaW5pc2hlZCwgYWZ0ZXIgcHJlbG9hZCB3YXMgcnVuLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI2xvYWRDb21wbGV0ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgbG9hZENvbXBsZXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuX2xvYWRDb21wbGV0ZSA9IHRydWU7CgogICAgICAgIHRoaXMuc3RhdGUubG9hZENvbXBsZXRlKCk7CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIGNvcmUgZ2FtZSBsb29wLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI3VwZGF0ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lIC0gVGhlIGN1cnJlbnQgdGltZSBhcyBwcm92aWRlZCBieSBSZXF1ZXN0QW5pbWF0aW9uRnJhbWUuCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAodGltZSkgewoKICAgICAgICB0aGlzLnRpbWUudXBkYXRlKHRpbWUpOwoKICAgICAgICBpZiAodGhpcy5fcGF1c2VkKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5yZW5kZXIodGhpcy5zdGFnZS5fc3RhZ2UpOwogICAgICAgICAgICB0aGlzLnBsdWdpbnMucmVuZGVyKCk7CiAgICAgICAgICAgIHRoaXMuc3RhdGUucmVuZGVyKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICghdGhpcy5wZW5kaW5nU3RlcCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RlcHBpbmcpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nU3RlcCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zLnByZVVwZGF0ZSgpOwogICAgICAgICAgICAgICAgdGhpcy53b3JsZC5wcmVVcGRhdGUoKTsKCiAgICAgICAgICAgICAgICB0aGlzLnN0YWdlLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgdGhpcy50d2VlbnMudXBkYXRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNvdW5kLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC51cGRhdGUoKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudXBkYXRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLndvcmxkLnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXMudXBkYXRlKCk7ICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbnMudXBkYXRlKCk7CgogICAgICAgICAgICAgICAgdGhpcy53b3JsZC5wb3N0VXBkYXRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbnMucG9zdFVwZGF0ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5yZW5kZXJUeXBlICE9PSBQaGFzZXIuSEVBRExFU1MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc3RhZ2UuX3N0YWdlKTsKICAgICAgICAgICAgICAgIHRoaXMucGx1Z2lucy5yZW5kZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUucmVuZGVyKCk7CgogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zLnBvc3RSZW5kZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBFbmFibGUgY29yZSBnYW1lIGxvb3Agc3RlcHBpbmcuIFdoZW4gZW5hYmxlZCB5b3UgbXVzdCBjYWxsIGdhbWUuc3RlcCgpIGRpcmVjdGx5IChwZXJoYXBzIHZpYSBhIERPTSBidXR0b24/KQogICAgKiBDYWxsaW5nIHN0ZXAgd2lsbCBhZHZhbmNlIHRoZSBnYW1lIGxvb3AgYnkgb25lIGZyYW1lLiBUaGlzIGlzIGV4dHJlbWVseSB1c2VmdWwgdG8gaGFyZCB0byB0cmFjayBkb3duIGVycm9ycyEKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZSNlbmFibGVTdGVwCiAgICAqLwogICAgZW5hYmxlU3RlcDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnN0ZXBwaW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLnBlbmRpbmdTdGVwID0gZmFsc2U7CiAgICAgICAgdGhpcy5zdGVwQ291bnQgPSAwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERpc2FibGVzIGNvcmUgZ2FtZSBsb29wIHN0ZXBwaW5nLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI2Rpc2FibGVTdGVwCiAgICAqLwogICAgZGlzYWJsZVN0ZXA6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5zdGVwcGluZyA9IGZhbHNlOwogICAgICAgIHRoaXMucGVuZGluZ1N0ZXAgPSBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBXaGVuIHN0ZXBwaW5nIGlzIGVuYWJsZWQgeW91IG11c3QgY2FsbCB0aGlzIGZ1bmN0aW9uIGRpcmVjdGx5IChwZXJoYXBzIHZpYSBhIERPTSBidXR0b24/KSB0byBhZHZhbmNlIHRoZSBnYW1lIGxvb3AgYnkgb25lIGZyYW1lLgogICAgKiBUaGlzIGlzIGV4dHJlbWVseSB1c2VmdWwgdG8gaGFyZCB0byB0cmFjayBkb3duIGVycm9ycyEgVXNlIHRoZSBpbnRlcm5hbCBzdGVwQ291bnQgcHJvcGVydHkgdG8gbW9uaXRvciBwcm9ncmVzcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZSNzdGVwCiAgICAqLwogICAgc3RlcDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnBlbmRpbmdTdGVwID0gZmFsc2U7CiAgICAgICAgdGhpcy5zdGVwQ291bnQrKzsKCiAgICB9LAoKICAgIC8qKgogICAgKiBOdWtlIHRoZSBlbnRpcmUgZ2FtZSBmcm9tIG9yYml0CiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWUjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5yYWYuc3RvcCgpOwoKICAgICAgICB0aGlzLmlucHV0LmRlc3Ryb3koKTsKCiAgICAgICAgdGhpcy5zdGF0ZS5kZXN0cm95KCk7CgogICAgICAgIHRoaXMuc3RhdGUgPSBudWxsOwogICAgICAgIHRoaXMuY2FjaGUgPSBudWxsOwogICAgICAgIHRoaXMuaW5wdXQgPSBudWxsOwogICAgICAgIHRoaXMubG9hZCA9IG51bGw7CiAgICAgICAgdGhpcy5zb3VuZCA9IG51bGw7CiAgICAgICAgdGhpcy5zdGFnZSA9IG51bGw7CiAgICAgICAgdGhpcy50aW1lID0gbnVsbDsKICAgICAgICB0aGlzLndvcmxkID0gbnVsbDsKICAgICAgICB0aGlzLmlzQm9vdGVkID0gZmFsc2U7CgogICAgfQoKfTsKClBoYXNlci5HYW1lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5HYW1lOwoKLyoqCiogVGhlIHBhdXNlZCBzdGF0ZSBvZiB0aGUgR2FtZS4gQSBwYXVzZWQgZ2FtZSBkb2Vzbid0IHVwZGF0ZSBhbnkgb2YgaXRzIHN1YnN5c3RlbXMuCiogV2hlbiBhIGdhbWUgaXMgcGF1c2VkIHRoZSBvblBhdXNlIGV2ZW50IGlzIGRpc3BhdGNoZWQuIFdoZW4gaXQgaXMgcmVzdW1lZCB0aGUgb25SZXN1bWUgZXZlbnQgaXMgZGlzcGF0Y2hlZC4KKiBAbmFtZSBQaGFzZXIuR2FtZSNwYXVzZWQKKiBAcHJvcGVydHkge2Jvb2xlYW59IHBhdXNlZCAtIEdldHMgYW5kIHNldHMgdGhlIHBhdXNlZCBzdGF0ZSBvZiB0aGUgR2FtZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5HYW1lLnByb3RvdHlwZSwgInBhdXNlZCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcGF1c2VkOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodmFsdWUgPT09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fcGF1c2VkID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fcGF1c2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMub25QYXVzZS5kaXNwYXRjaCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fcGF1c2VkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXVzZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMub25SZXN1bWUuZGlzcGF0Y2godGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiAiRGVsZXRlZCBjb2RlIGlzIGRlYnVnZ2VkIGNvZGUuIiAtIEplZmYgU2lja2VsCiovCgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIuSW5wdXQgaXMgdGhlIElucHV0IE1hbmFnZXIgZm9yIGFsbCB0eXBlcyBvZiBJbnB1dCBhY3Jvc3MgUGhhc2VyLCBpbmNsdWRpbmcgbW91c2UsIGtleWJvYXJkLCB0b3VjaCBhbmQgTVNQb2ludGVyLgoqIFRoZSBJbnB1dCBtYW5hZ2VyIGlzIHVwZGF0ZWQgYXV0b21hdGljYWxseSBieSB0aGUgY29yZSBnYW1lIGxvb3AuCioKKiBAY2xhc3MgUGhhc2VyLklucHV0CiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKi8KUGhhc2VyLklucHV0ID0gZnVuY3Rpb24gKGdhbWUpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLiAKICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0hUTUxDYW52YXNFbGVtZW50fSBoaXRDYW52YXMgLSBUaGUgY2FudmFzIHRvIHdoaWNoIHNpbmdsZSBwaXhlbHMgYXJlIGRyYXduIGluIG9yZGVyIHRvIHBlcmZvcm0gcGl4ZWwtcGVyZmVjdCBoaXQgZGV0ZWN0aW9uLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaGl0Q2FudmFzID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBoaXRDb250ZXh0IC0gVGhlIGNvbnRleHQgb2YgdGhlIHBpeGVsIHBlcmZlY3QgaGl0IGNhbnZhcy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmhpdENvbnRleHQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBtb3ZlQ2FsbGJhY2sgLSBBbiBvcHRpb25hbCBjYWxsYmFjayB0aGF0IHdpbGwgYmUgZmlyZWQgZXZlcnkgdGltZSB0aGUgYWN0aXZlUG9pbnRlciByZWNlaXZlcyBhIG1vdmUgZXZlbnQgZnJvbSB0aGUgRE9NLiBTZXQgdG8gbnVsbCB0byBkaXNhYmxlLgogICAgKi8KICAgIHRoaXMubW92ZUNhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IG1vdmVDYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgbW92ZUNhbGxiYWNrIHdpbGwgYmUgc2VudC4gRGVmYXVsdHMgdG8gUGhhc2VyLklucHV0IGJ1dCBjYW4gYmUgc2V0IHRvIGFueSB2YWxpZCBKUyBvYmplY3QuCiAgICAqLwogICAgdGhpcy5tb3ZlQ2FsbGJhY2tDb250ZXh0ID0gdGhpczsKICAgIAp9OwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLklucHV0Lk1PVVNFX09WRVJSSURFU19UT1VDSCA9IDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuSW5wdXQuVE9VQ0hfT1ZFUlJJREVTX01PVVNFID0gMTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5JbnB1dC5NT1VTRV9UT1VDSF9DT01CSU5FID0gMjsKClBoYXNlci5JbnB1dC5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEhvdyBvZnRlbiBzaG91bGQgdGhlIGlucHV0IHBvaW50ZXJzIGJlIGNoZWNrZWQgZm9yIHVwZGF0ZXM/CiAgICAqIEEgdmFsdWUgb2YgMCBtZWFucyBldmVyeSBzaW5nbGUgZnJhbWUgKDYwZnBzKSwgYSB2YWx1ZSBvZiAxIG1lYW5zIGV2ZXJ5IG90aGVyIGZyYW1lICgzMGZwcykgYW5kIHNvIG9uLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcG9sbFJhdGUgCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgcG9sbFJhdGU6IDAsCiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3BvbGxDb3VudGVyIC0gSW50ZXJuYWwgdmFyIGhvbGRpbmcgdGhlIGN1cnJlbnQgcG9sbCBjb3VudGVyLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIF9wb2xsQ291bnRlcjogMCwKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IF9vbGRQb3NpdGlvbiAtIEEgcG9pbnQgb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcHJldmlvdXMgcG9zaXRpb24gb2YgdGhlIFBvaW50ZXIuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0IAogICAgKi8KICAgIF9vbGRQb3NpdGlvbjogbnVsbCwKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF94IC0geCBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudCBQb2ludGVyIGV2ZW50CiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgX3g6IDAsCgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfeSAtIFkgY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnQgUG9pbnRlciBldmVudAogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIF95OiAwLAoKICAgIC8qKgogICAgKiBZb3UgY2FuIGRpc2FibGUgYWxsIElucHV0IGJ5IHNldHRpbmcgSW5wdXQuZGlzYWJsZWQ6IHRydWUuIFdoaWxlIHNldCBhbGwgbmV3IGlucHV0IHJlbGF0ZWQgZXZlbnRzIHdpbGwgYmUgaWdub3JlZC4KICAgICogSWYgeW91IG5lZWQgdG8gZGlzYWJsZSBqdXN0IG9uZSB0eXBlIG9mIGlucHV0LCBmb3IgZXhhbXBsZSBtb3VzZSwgdXNlIElucHV0Lm1vdXNlLmRpc2FibGVkOiB0cnVlIGluc3RlYWQKICAgICogQHByb3BlcnR5IHtib29sZWFufSBkaXNhYmxlZAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIGRpc2FibGVkOiBmYWxzZSwKCiAgICAvKioKICAgICogQ29udHJvbHMgdGhlIGV4cGVjdGVkIGJlaGF2aW91ciB3aGVuIHVzaW5nIGEgbW91c2UgYW5kIHRvdWNoIHRvZ2V0aGVyIG9uIGEgbXVsdGktaW5wdXQgZGV2aWNlLgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBtdWx0aUlucHV0T3ZlcnJpZGUKICAgICovCiAgICBtdWx0aUlucHV0T3ZlcnJpZGU6IFBoYXNlci5JbnB1dC5NT1VTRV9UT1VDSF9DT01CSU5FLAoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gcG9zaXRpb24gLSBBIHBvaW50IG9iamVjdCByZXByZXNlbnRpbmcgdGhlIGN1cnJlbnQgcG9zaXRpb24gb2YgdGhlIFBvaW50ZXIuCiAgICAqIEBkZWZhdWx0IAogICAgKi8KICAgIHBvc2l0aW9uOiBudWxsLAoKICAgIC8qKgogICAgKiBBIHBvaW50IG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHNwZWVkIG9mIHRoZSBQb2ludGVyLiBPbmx5IHJlYWxseSB1c2VmdWwgaW4gc2luZ2xlIFBvaW50ZXIgZ2FtZXMsIG90aGVyd2lzZSBzZWUgdGhlIFBvaW50ZXIgb2JqZWN0cyBkaXJlY3RseS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHNwZWVkCiAgICAqLwogICAgc3BlZWQ6IG51bGwsCgogICAgLyoqCiAgICAqIEEgQ2lyY2xlIG9iamVjdCBjZW50ZXJlZCBvbiB0aGUgeC95IHNjcmVlbiBjb29yZGluYXRlcyBvZiB0aGUgSW5wdXQuCiAgICAqIERlZmF1bHQgc2l6ZSBvZiA0NHB4IChBcHBsZXMgcmVjb21tZW5kZWQgImZpbmdlciB0aXAiIHNpemUpIGJ1dCBjYW4gYmUgY2hhbmdlZCB0byBhbnl0aGluZy4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuQ2lyY2xlfSBjaXJjbGUKICAgICovCiAgICBjaXJjbGU6IG51bGwsCgogICAgLyoqCiAgICAqIFRoZSBzY2FsZSBieSB3aGljaCBhbGwgaW5wdXQgY29vcmRpbmF0ZXMgYXJlIG11bHRpcGxpZWQsIGNhbGN1bGF0ZWQgYnkgdGhlIFN0YWdlU2NhbGVNb2RlLgogICAgKiBJbiBhbiB1bi1zY2FsZWQgZ2FtZSB0aGUgdmFsdWVzIHdpbGwgYmUgeDogMSBhbmQgeTogMS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHNjYWxlCiAgICAqLwogICAgc2NhbGU6IG51bGwsCgogICAgLyoqCiAgICAqIFRoZSBtYXhpbXVtIG51bWJlciBvZiBQb2ludGVycyBhbGxvd2VkIHRvIGJlIGFjdGl2ZSBhdCBhbnkgb25lIHRpbWUuCiAgICAqIEZvciBsb3RzIG9mIGdhbWVzIGl0J3MgdXNlZnVsIHRvIHNldCB0aGlzIHRvIDEuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYXhQb2ludGVycwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIG1heFBvaW50ZXJzOiAxMCwKCiAgICAvKioKICAgICogVGhlIGN1cnJlbnQgbnVtYmVyIG9mIGFjdGl2ZSBQb2ludGVycy4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGN1cnJlbnRQb2ludGVycwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIGN1cnJlbnRQb2ludGVyczogMCwKCiAgICAvKioKICAgICogVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdGhhdCB0aGUgUG9pbnRlciBoYXMgdG8gYmUgcHJlc3NlZCBkb3duIGFuZCB0aGVuIHJlbGVhc2VkIHRvIGJlIGNvbnNpZGVyZWQgYSB0YXAgb3IgY2xpY2tlCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0YXBSYXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGFwUmF0ZTogMjAwLAoKICAgIC8qKgogICAgKiBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBiZXR3ZWVuIHRhcHMgb2YgdGhlIHNhbWUgUG9pbnRlciBmb3IgaXQgdG8gYmUgY29uc2lkZXJlZCBhIGRvdWJsZSB0YXAgLyBjbGljawogICAgKiBAcHJvcGVydHkge251bWJlcn0gZG91YmxlVGFwUmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIGRvdWJsZVRhcFJhdGU6IDMwMCwKCiAgICAvKioKICAgICogVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdGhhdCB0aGUgUG9pbnRlciBoYXMgdG8gYmUgcHJlc3NlZCBkb3duIGZvciBpdCB0byBmaXJlIGEgb25Ib2xkIGV2ZW50CiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBob2xkUmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIGhvbGRSYXRlOiAyMDAwLAoKICAgIC8qKgogICAgKiBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBiZWxvdyB3aGljaCB0aGUgUG9pbnRlciBpcyBjb25zaWRlcmVkIGp1c3RQcmVzc2VkCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBqdXN0UHJlc3NlZFJhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICBqdXN0UHJlc3NlZFJhdGU6IDIwMCwKCiAgICAvKioKICAgICogVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgYmVsb3cgd2hpY2ggdGhlIFBvaW50ZXIgaXMgY29uc2lkZXJlZCBqdXN0UmVsZWFzZWQgCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBqdXN0UmVsZWFzZWRSYXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAganVzdFJlbGVhc2VkUmF0ZTogMjAwLAoKICAgIC8qKgogICAgKiBTZXRzIGlmIHRoZSBQb2ludGVyIG9iamVjdHMgc2hvdWxkIHJlY29yZCBhIGhpc3Rvcnkgb2YgeC95IGNvb3JkaW5hdGVzIHRoZXkgaGF2ZSBwYXNzZWQgdGhyb3VnaC4KICAgICogVGhlIGhpc3RvcnkgaXMgY2xlYXJlZCBlYWNoIHRpbWUgdGhlIFBvaW50ZXIgaXMgcHJlc3NlZCBkb3duLgogICAgKiBUaGUgaGlzdG9yeSBpcyB1cGRhdGVkIGF0IHRoZSByYXRlIHNwZWNpZmllZCBpbiBJbnB1dC5wb2xsUmF0ZQogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHJlY29yZFBvaW50ZXJIaXN0b3J5CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgcmVjb3JkUG9pbnRlckhpc3Rvcnk6IGZhbHNlLAoKICAgIC8qKgogICAgKiBUaGUgcmF0ZSBpbiBtaWxsaXNlY29uZHMgYXQgd2hpY2ggdGhlIFBvaW50ZXIgb2JqZWN0cyBzaG91bGQgdXBkYXRlIHRoZWlyIHRyYWNraW5nIGhpc3RvcnkKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHJlY29yZFJhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICByZWNvcmRSYXRlOiAxMDAsCgogICAgLyoqCiAgICAqIFRoZSB0b3RhbCBudW1iZXIgb2YgZW50cmllcyB0aGF0IGNhbiBiZSByZWNvcmRlZCBpbnRvIHRoZSBQb2ludGVyIG9iamVjdHMgdHJhY2tpbmcgaGlzdG9yeS4KICAgICogSWYgdGhlIFBvaW50ZXIgaXMgdHJhY2tpbmcgb25lIGV2ZW50IGV2ZXJ5IDEwMG1zLCB0aGVuIGEgdHJhY2tMaW1pdCBvZiAxMDAgd291bGQgc3RvcmUgdGhlIGxhc3QgMTAgc2Vjb25kcyB3b3J0aCBvZiBoaXN0b3J5LgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcmVjb3JkTGltaXQKICAgICogQGRlZmF1bHQKICAgICovCiAgICByZWNvcmRMaW1pdDogMTAwLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0CiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIxCiAgICAqLwogICAgcG9pbnRlcjE6IG51bGwsCgogICAgLyoqCiAgICAqIEEgUG9pbnRlciBvYmplY3QKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjIKICAgICovCiAgICBwb2ludGVyMjogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdCAgCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIzCiAgICAqLwogICAgcG9pbnRlcjM6IG51bGwsCgogICAgLyoqCiAgICAqIEEgUG9pbnRlciBvYmplY3QKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjQKICAgICovCiAgICBwb2ludGVyNDogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyNQogICAgKi8KICAgIHBvaW50ZXI1OiBudWxsLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0CiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXI2CiAgICAqLwogICAgcG9pbnRlcjY6IG51bGwsCgogICAgLyoqCiAgICAqIEEgUG9pbnRlciBvYmplY3QgIAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyNwogICAgKi8KICAgIHBvaW50ZXI3OiBudWxsLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0CiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXI4CiAgICAqLwogICAgcG9pbnRlcjg6IG51bGwsCgogICAgLyoqCiAgICAqIEEgUG9pbnRlciBvYmplY3QKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjkKICAgICovCiAgICBwb2ludGVyOTogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdC4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjEwCiAgICAqLwogICAgcG9pbnRlcjEwOiBudWxsLAoKICAgIC8qKgogICAgKiBUaGUgbW9zdCByZWNlbnRseSBhY3RpdmUgUG9pbnRlciBvYmplY3QuCiAgICAqIFdoZW4geW91J3ZlIGxpbWl0ZWQgbWF4IHBvaW50ZXJzIHRvIDEgdGhpcyB3aWxsIGFjY3VyYXRlbHkgYmUgZWl0aGVyIHRoZSBmaXJzdCBmaW5nZXIgdG91Y2hlZCBvciBtb3VzZS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gYWN0aXZlUG9pbnRlcgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIGFjdGl2ZVBvaW50ZXI6IG51bGwsCgogICAgLyoqCiAgICAqIFRoZSBtb3VzZSBoYXMgaXRzIG93biB1bmlxdWUgUGhhc2VyLlBvaW50ZXIgb2JqZWN0IHdoaWNoIHlvdSBjYW4gdXNlIGlmIG1ha2luZyBhIGRlc2t0b3Agc3BlY2lmaWMgZ2FtZS4KICAgICogQHByb3BlcnR5IHtQb2ludGVyfSBtb3VzZVBvaW50ZXIKICAgICogQGRlZmF1bHQKICAgICovCiAgICBtb3VzZVBvaW50ZXI6IG51bGwsCiAgICAKICAgIC8qKgogICAgKiBUaGUgTW91c2UgSW5wdXQgbWFuYWdlci4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuTW91c2V9IG1vdXNlIC0gVGhlIE1vdXNlIElucHV0IG1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgbW91c2U6IG51bGwsCiAgICAKICAgIC8qKgogICAgKiBUaGUgS2V5Ym9hcmQgSW5wdXQgbWFuYWdlci4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuS2V5Ym9hcmR9IGtleWJvYXJkIC0gVGhlIEtleWJvYXJkIElucHV0IG1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAga2V5Ym9hcmQ6IG51bGwsCiAgICAKICAgIC8qKgogICAgKiBUaGUgVG91Y2ggSW5wdXQgbWFuYWdlci4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuVG91Y2h9IHRvdWNoIC0gdGhlIFRvdWNoIElucHV0IG1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdG91Y2g6IG51bGwsCiAgICAKICAgIC8qKgogICAgKiBUaGUgTVNQb2ludGVyIElucHV0IG1hbmFnZXIuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLk1TUG9pbnRlcn0gbXNwb2ludGVyIC0gVGhlIE1TUG9pbnRlciBJbnB1dCBtYW5hZ2VyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIG1zcG9pbnRlcjogbnVsbCwKCiAgICAvKioKICAgICAqIFRoZSBHYW1lcGFkIElucHV0IG1hbmFnZXIuCiAgICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lcGFkfSBnYW1lcGFkIC0gVGhlIEdhbWVwYWQgSW5wdXQgbWFuYWdlci4KICAgICAqIEBkZWZhdWx0CiAgICAgKi8KICAgIGdhbWVwYWQ6IG51bGwsCgogICAgLyoqCiAgICAqIEEgU2lnbmFsIHRoYXQgaXMgZGlzcGF0Y2hlZCBlYWNoIHRpbWUgYSBwb2ludGVyIGlzIHByZXNzZWQgZG93bi4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkRvd24KICAgICogQGRlZmF1bHQKICAgICovCiAgICBvbkRvd246IG51bGwsCiAgICAKICAgIC8qKgogICAgKiBBIFNpZ25hbCB0aGF0IGlzIGRpc3BhdGNoZWQgZWFjaCB0aW1lIGEgcG9pbnRlciBpcyByZWxlYXNlZC4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvblVwCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgb25VcDogbnVsbCwKICAgIAogICAgLyoqCiAgICAqIEEgU2lnbmFsIHRoYXQgaXMgZGlzcGF0Y2hlZCBlYWNoIHRpbWUgYSBwb2ludGVyIGlzIHRhcHBlZC4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvblRhcAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIG9uVGFwOiBudWxsLAogICAgCiAgICAvKioKICAgICogQSBTaWduYWwgdGhhdCBpcyBkaXNwYXRjaGVkIGVhY2ggdGltZSBhIHBvaW50ZXIgaXMgaGVsZCBkb3duLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uSG9sZAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIG9uSG9sZDogbnVsbCwKCiAgICAvKioKICAgICogQSBsaW5rZWQgbGlzdCBvZiBpbnRlcmFjdGl2ZSBvYmplY3RzLCB0aGUgSW5wdXRIYW5kbGVyIGNvbXBvbmVudHMgKGJlbG9uZ2luZyB0byBTcHJpdGVzKSByZWdpc3RlciB0aGVtc2VsdmVzIHdpdGggdGhpcy4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuTGlua2VkTGlzdH0gaW50ZXJhY3RpdmVJdGVtcwogICAgKi8KICAgIGludGVyYWN0aXZlSXRlbXM6IG5ldyBQaGFzZXIuTGlua2VkTGlzdCgpLAoKICAgIC8qKgogICAgKiBTdGFydHMgdGhlIElucHV0IE1hbmFnZXIgcnVubmluZy4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjYm9vdAogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgYm9vdDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLm1vdXNlUG9pbnRlciA9IG5ldyBQaGFzZXIuUG9pbnRlcih0aGlzLmdhbWUsIDApOwogICAgICAgIHRoaXMucG9pbnRlcjEgPSBuZXcgUGhhc2VyLlBvaW50ZXIodGhpcy5nYW1lLCAxKTsKICAgICAgICB0aGlzLnBvaW50ZXIyID0gbmV3IFBoYXNlci5Qb2ludGVyKHRoaXMuZ2FtZSwgMik7CgogICAgICAgIHRoaXMubW91c2UgPSBuZXcgUGhhc2VyLk1vdXNlKHRoaXMuZ2FtZSk7CiAgICAgICAgdGhpcy5rZXlib2FyZCA9IG5ldyBQaGFzZXIuS2V5Ym9hcmQodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLnRvdWNoID0gbmV3IFBoYXNlci5Ub3VjaCh0aGlzLmdhbWUpOwogICAgICAgIHRoaXMubXNwb2ludGVyID0gbmV3IFBoYXNlci5NU1BvaW50ZXIodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmdhbWVwYWQgPSBuZXcgUGhhc2VyLkdhbWVwYWQodGhpcy5nYW1lKTsKCiAgICAgICAgdGhpcy5vbkRvd24gPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgICAgIHRoaXMub25VcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgdGhpcy5vblRhcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgdGhpcy5vbkhvbGQgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgICAgICB0aGlzLnNjYWxlID0gbmV3IFBoYXNlci5Qb2ludCgxLCAxKTsKICAgICAgICB0aGlzLnNwZWVkID0gbmV3IFBoYXNlci5Qb2ludCgpOwogICAgICAgIHRoaXMucG9zaXRpb24gPSBuZXcgUGhhc2VyLlBvaW50KCk7CiAgICAgICAgdGhpcy5fb2xkUG9zaXRpb24gPSBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgICAgIHRoaXMuY2lyY2xlID0gbmV3IFBoYXNlci5DaXJjbGUoMCwgMCwgNDQpOwoKICAgICAgICB0aGlzLmFjdGl2ZVBvaW50ZXIgPSB0aGlzLm1vdXNlUG9pbnRlcjsKICAgICAgICB0aGlzLmN1cnJlbnRQb2ludGVycyA9IDA7CgogICAgICAgIHRoaXMuaGl0Q2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgdGhpcy5oaXRDYW52YXMud2lkdGggPSAxOwogICAgICAgIHRoaXMuaGl0Q2FudmFzLmhlaWdodCA9IDE7CiAgICAgICAgdGhpcy5oaXRDb250ZXh0ID0gdGhpcy5oaXRDYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKCiAgICAgICAgdGhpcy5tb3VzZS5zdGFydCgpOwogICAgICAgIHRoaXMua2V5Ym9hcmQuc3RhcnQoKTsKICAgICAgICB0aGlzLnRvdWNoLnN0YXJ0KCk7CiAgICAgICAgdGhpcy5tc3BvaW50ZXIuc3RhcnQoKTsKICAgICAgICB0aGlzLm1vdXNlUG9pbnRlci5hY3RpdmUgPSB0cnVlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3BzIGFsbCBvZiB0aGUgSW5wdXQgTWFuYWdlcnMgZnJvbSBydW5uaW5nLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLm1vdXNlLnN0b3AoKTsKICAgICAgICB0aGlzLmtleWJvYXJkLnN0b3AoKTsKICAgICAgICB0aGlzLnRvdWNoLnN0b3AoKTsKICAgICAgICB0aGlzLm1zcG9pbnRlci5zdG9wKCk7CiAgICAgICAgdGhpcy5nYW1lcGFkLnN0b3AoKTsKCiAgICAgICAgdGhpcy5tb3ZlQ2FsbGJhY2sgPSBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgYSBjYWxsYmFjayB0aGF0IGlzIGZpcmVkIGV2ZXJ5IHRpbWUgdGhlIGFjdGl2ZVBvaW50ZXIgcmVjZWl2ZXMgYSBET00gbW92ZSBldmVudCBzdWNoIGFzIGEgbW91c2Vtb3ZlIG9yIHRvdWNobW92ZS4KICAgICogSXQgd2lsbCBiZSBjYWxsZWQgZXZlcnkgdGltZSB0aGUgYWN0aXZlUG9pbnRlciBtb3Zlcywgd2hpY2ggaW4gYSBtdWx0aS10b3VjaCBnYW1lIGNhbiBiZSBhIGxvdCBvZiB0aW1lcywgc28gdGhpcyBpcyBiZXN0CiAgICAqIHRvIG9ubHkgdXNlIGlmIHlvdSd2ZSBsaW1pdGVkIGlucHV0IHRvIGEgc2luZ2xlIHBvaW50ZXIgKGkuZS4gbW91c2Ugb3IgdG91Y2gpCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I3NldE1vdmVDYWxsYmFjawogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBjYWxsYmFjayB0aGF0IHdpbGwgYmUgY2FsbGVkIGVhY2ggdGltZSB0aGUgYWN0aXZlUG9pbnRlciByZWNlaXZlcyBhIERPTSBtb3ZlIGV2ZW50LgogICAgKiBAcGFyYW0ge29iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkLgogICAgKi8KICAgIHNldE1vdmVDYWxsYmFjazogZnVuY3Rpb24gKGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCiAgICAgICAgdGhpcy5tb3ZlQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICB0aGlzLm1vdmVDYWxsYmFja0NvbnRleHQgPSBjYWxsYmFja0NvbnRleHQ7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IFBvaW50ZXIgb2JqZWN0IHRvIHRoZSBJbnB1dCBNYW5hZ2VyLiBCeSBkZWZhdWx0IElucHV0IGNyZWF0ZXMgMyBwb2ludGVyIG9iamVjdHM6IG1vdXNlUG9pbnRlciwgcG9pbnRlcjEgYW5kIHBvaW50ZXIyLgogICAgKiBJZiB5b3UgbmVlZCBtb3JlIHRoZW4gdXNlIHRoaXMgdG8gY3JlYXRlIGEgbmV3IG9uZSwgdXAgdG8gYSBtYXhpbXVtIG9mIDEwLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCNhZGRQb2ludGVyCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludGVyfSBBIHJlZmVyZW5jZSB0byB0aGUgbmV3IFBvaW50ZXIgb2JqZWN0IHRoYXQgd2FzIGNyZWF0ZWQuCiAgICAqLwogICAgYWRkUG9pbnRlcjogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgbmV4dCA9IDA7CgogICAgICAgIGZvciAodmFyIGkgPSAxMDsgaSA+IDA7IGktLSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzWydwb2ludGVyJyArIGldID09PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuZXh0ID0gaTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKG5leHQgPT09IDApCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIllvdSBjYW4gb25seSBoYXZlIDEwIFBvaW50ZXIgb2JqZWN0cyIpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpc1sncG9pbnRlcicgKyBuZXh0XSA9IG5ldyBQaGFzZXIuUG9pbnRlcih0aGlzLmdhbWUsIG5leHQpOwogICAgICAgICAgICByZXR1cm4gdGhpc1sncG9pbnRlcicgKyBuZXh0XTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlcyB0aGUgSW5wdXQgTWFuYWdlci4gQ2FsbGVkIGJ5IHRoZSBjb3JlIEdhbWUgbG9vcC4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjdXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMucG9sbFJhdGUgPiAwICYmIHRoaXMuX3BvbGxDb3VudGVyIDwgdGhpcy5wb2xsUmF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BvbGxDb3VudGVyKys7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3BlZWQueCA9IHRoaXMucG9zaXRpb24ueCAtIHRoaXMuX29sZFBvc2l0aW9uLng7CiAgICAgICAgdGhpcy5zcGVlZC55ID0gdGhpcy5wb3NpdGlvbi55IC0gdGhpcy5fb2xkUG9zaXRpb24ueTsKCiAgICAgICAgdGhpcy5fb2xkUG9zaXRpb24uY29weUZyb20odGhpcy5wb3NpdGlvbik7CiAgICAgICAgdGhpcy5tb3VzZVBvaW50ZXIudXBkYXRlKCk7CgogICAgICAgIGlmICh0aGlzLmdhbWVwYWQuYWN0aXZlKSB7IHRoaXMuZ2FtZXBhZC51cGRhdGUoKTsgfQoKICAgICAgICB0aGlzLnBvaW50ZXIxLnVwZGF0ZSgpOwogICAgICAgIHRoaXMucG9pbnRlcjIudXBkYXRlKCk7CgogICAgICAgIGlmICh0aGlzLnBvaW50ZXIzKSB7IHRoaXMucG9pbnRlcjMudXBkYXRlKCk7IH0KICAgICAgICBpZiAodGhpcy5wb2ludGVyNCkgeyB0aGlzLnBvaW50ZXI0LnVwZGF0ZSgpOyB9CiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjUpIHsgdGhpcy5wb2ludGVyNS51cGRhdGUoKTsgfQogICAgICAgIGlmICh0aGlzLnBvaW50ZXI2KSB7IHRoaXMucG9pbnRlcjYudXBkYXRlKCk7IH0KICAgICAgICBpZiAodGhpcy5wb2ludGVyNykgeyB0aGlzLnBvaW50ZXI3LnVwZGF0ZSgpOyB9CiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjgpIHsgdGhpcy5wb2ludGVyOC51cGRhdGUoKTsgfQogICAgICAgIGlmICh0aGlzLnBvaW50ZXI5KSB7IHRoaXMucG9pbnRlcjkudXBkYXRlKCk7IH0KICAgICAgICBpZiAodGhpcy5wb2ludGVyMTApIHsgdGhpcy5wb2ludGVyMTAudXBkYXRlKCk7IH0KCiAgICAgICAgdGhpcy5fcG9sbENvdW50ZXIgPSAwOwogICAgfSwKCiAgICAvKioKICAgICogUmVzZXQgYWxsIG9mIHRoZSBQb2ludGVycyBhbmQgSW5wdXQgc3RhdGVzCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I3Jlc2V0CiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gaGFyZCAtIEEgc29mdCByZXNldCAoaGFyZCA9IGZhbHNlKSB3b24ndCByZXNldCBhbnkgU2lnbmFscyB0aGF0IG1pZ2h0IGJlIGJvdW5kLiBBIGhhcmQgcmVzZXQgd2lsbC4KICAgICovCiAgICByZXNldDogZnVuY3Rpb24gKGhhcmQpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pc0Jvb3RlZCA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGhhcmQgPT0gJ3VuZGVmaW5lZCcpIHsgaGFyZCA9IGZhbHNlOyB9CgogICAgICAgIHRoaXMua2V5Ym9hcmQucmVzZXQoKTsKICAgICAgICB0aGlzLm1vdXNlUG9pbnRlci5yZXNldCgpOwogICAgICAgIHRoaXMuZ2FtZXBhZC5yZXNldCgpOwoKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8PSAxMDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXNbJ3BvaW50ZXInICsgaV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXNbJ3BvaW50ZXInICsgaV0ucmVzZXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5jdXJyZW50UG9pbnRlcnMgPSAwOwoKICAgICAgICBpZiAodGhpcy5nYW1lLmNhbnZhcy5zdHlsZS5jdXJzb3IgIT09ICdub25lJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW52YXMuc3R5bGUuY3Vyc29yID0gJ2RlZmF1bHQnOwogICAgICAgIH0KCiAgICAgICAgaWYgKGhhcmQgPT09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uRG93bi5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25VcC5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25UYXAuZGlzcG9zZSgpOwogICAgICAgICAgICB0aGlzLm9uSG9sZC5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25Eb3duID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICAgICAgdGhpcy5vblVwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICAgICAgdGhpcy5vblRhcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgICAgIHRoaXMub25Ib2xkID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAgICAgICAgIHRoaXMuaW50ZXJhY3RpdmVJdGVtcy5jYWxsQWxsKCdyZXNldCcpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fcG9sbENvdW50ZXIgPSAwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlc2V0cyB0aGUgc3BlZWQgYW5kIG9sZCBwb3NpdGlvbiBwcm9wZXJ0aWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCNyZXNldFNwZWVkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gU2V0cyB0aGUgb2xkUG9zaXRpb24ueCB2YWx1ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBTZXRzIHRoZSBvbGRQb3NpdGlvbi55IHZhbHVlLgogICAgKi8KICAgIHJlc2V0U3BlZWQ6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMuX29sZFBvc2l0aW9uLnNldFRvKHgsIHkpOwogICAgICAgIHRoaXMuc3BlZWQuc2V0VG8oMCwgMCk7CgogICAgfSwKCiAgICAvKioKICAgICogRmluZCB0aGUgZmlyc3QgZnJlZSBQb2ludGVyIG9iamVjdCBhbmQgc3RhcnQgaXQsIHBhc3NpbmcgaW4gdGhlIGV2ZW50IGRhdGEuIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgUGhhc2VyLlRvdWNoIGFuZCBQaGFzZXIuTVNQb2ludGVyLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCNzdGFydFBvaW50ZXIKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50IC0gVGhlIGV2ZW50IGRhdGEgZnJvbSB0aGUgVG91Y2ggZXZlbnQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludGVyfSBUaGUgUG9pbnRlciBvYmplY3QgdGhhdCB3YXMgc3RhcnRlZCBvciBudWxsIGlmIG5vIFBvaW50ZXIgb2JqZWN0IGlzIGF2YWlsYWJsZS4KICAgICovCiAgICBzdGFydFBvaW50ZXI6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5tYXhQb2ludGVycyA8IDEwICYmIHRoaXMudG90YWxBY3RpdmVQb2ludGVycyA9PSB0aGlzLm1heFBvaW50ZXJzKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wb2ludGVyMS5hY3RpdmUgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjEuc3RhcnQoZXZlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnBvaW50ZXIyLmFjdGl2ZSA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVyMi5zdGFydChldmVudCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAzOyBpIDw9IDEwOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzWydwb2ludGVyJyArIGldICYmIHRoaXNbJ3BvaW50ZXInICsgaV0uYWN0aXZlID09PSBmYWxzZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1sncG9pbnRlcicgKyBpXS5zdGFydChldmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZXMgdGhlIG1hdGNoaW5nIFBvaW50ZXIgb2JqZWN0LCBwYXNzaW5nIGluIHRoZSBldmVudCBkYXRhLiBUaGlzIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGFuZCBzaG91bGQgbm90IG5vcm1hbGx5IG5lZWQgdG8gYmUgaW52b2tlZC4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjdXBkYXRlUG9pbnRlcgogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQgLSBUaGUgZXZlbnQgZGF0YSBmcm9tIHRoZSBUb3VjaCBldmVudC4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50ZXJ9IFRoZSBQb2ludGVyIG9iamVjdCB0aGF0IHdhcyB1cGRhdGVkIG9yIG51bGwgaWYgbm8gUG9pbnRlciBvYmplY3QgaXMgYXZhaWxhYmxlLgogICAgKi8KICAgIHVwZGF0ZVBvaW50ZXI6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5wb2ludGVyMS5hY3RpdmUgJiYgdGhpcy5wb2ludGVyMS5pZGVudGlmaWVyID09IGV2ZW50LmlkZW50aWZpZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVyMS5tb3ZlKGV2ZW50KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5wb2ludGVyMi5hY3RpdmUgJiYgdGhpcy5wb2ludGVyMi5pZGVudGlmaWVyID09IGV2ZW50LmlkZW50aWZpZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVyMi5tb3ZlKGV2ZW50KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDM7IGkgPD0gMTA7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXNbJ3BvaW50ZXInICsgaV0gJiYgdGhpc1sncG9pbnRlcicgKyBpXS5hY3RpdmUgJiYgdGhpc1sncG9pbnRlcicgKyBpXS5pZGVudGlmaWVyID09IGV2ZW50LmlkZW50aWZpZXIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ3BvaW50ZXInICsgaV0ubW92ZShldmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3BzIHRoZSBtYXRjaGluZyBQb2ludGVyIG9iamVjdCwgcGFzc2luZyBpbiB0aGUgZXZlbnQgZGF0YS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjc3RvcFBvaW50ZXIKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50IC0gVGhlIGV2ZW50IGRhdGEgZnJvbSB0aGUgVG91Y2ggZXZlbnQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludGVyfSBUaGUgUG9pbnRlciBvYmplY3QgdGhhdCB3YXMgc3RvcHBlZCBvciBudWxsIGlmIG5vIFBvaW50ZXIgb2JqZWN0IGlzIGF2YWlsYWJsZS4KICAgICovCiAgICBzdG9wUG9pbnRlcjogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLnBvaW50ZXIxLmFjdGl2ZSAmJiB0aGlzLnBvaW50ZXIxLmlkZW50aWZpZXIgPT0gZXZlbnQuaWRlbnRpZmllcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIxLnN0b3AoZXZlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnBvaW50ZXIyLmFjdGl2ZSAmJiB0aGlzLnBvaW50ZXIyLmlkZW50aWZpZXIgPT0gZXZlbnQuaWRlbnRpZmllcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIyLnN0b3AoZXZlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMzsgaSA8PSAxMDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpc1sncG9pbnRlcicgKyBpXSAmJiB0aGlzWydwb2ludGVyJyArIGldLmFjdGl2ZSAmJiB0aGlzWydwb2ludGVyJyArIGldLmlkZW50aWZpZXIgPT0gZXZlbnQuaWRlbnRpZmllcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1sncG9pbnRlcicgKyBpXS5zdG9wKGV2ZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IHRoZSBuZXh0IFBvaW50ZXIgb2JqZWN0IHdob3MgYWN0aXZlIHByb3BlcnR5IG1hdGNoZXMgdGhlIGdpdmVuIHN0YXRlCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I2dldFBvaW50ZXIKICAgICogQHBhcmFtIHtib29sZWFufSBzdGF0ZSAtIFRoZSBzdGF0ZSB0aGUgUG9pbnRlciBzaG91bGQgYmUgaW4gKGZhbHNlIGZvciBpbmFjdGl2ZSwgdHJ1ZSBmb3IgYWN0aXZlKS4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50ZXJ9IEEgUG9pbnRlciBvYmplY3Qgb3IgbnVsbCBpZiBubyBQb2ludGVyIG9iamVjdCBtYXRjaGVzIHRoZSByZXF1ZXN0ZWQgc3RhdGUuCiAgICAqLwogICAgZ2V0UG9pbnRlcjogZnVuY3Rpb24gKHN0YXRlKSB7CgogICAgICAgIHN0YXRlID0gc3RhdGUgfHwgZmFsc2U7CgogICAgICAgIGlmICh0aGlzLnBvaW50ZXIxLmFjdGl2ZSA9PSBzdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIxOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnBvaW50ZXIyLmFjdGl2ZSA9PSBzdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIyOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMzsgaSA8PSAxMDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpc1sncG9pbnRlcicgKyBpXSAmJiB0aGlzWydwb2ludGVyJyArIGldLmFjdGl2ZSA9PSBzdGF0ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1sncG9pbnRlcicgKyBpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IHRoZSBQb2ludGVyIG9iamVjdCB3aG9zIGlkZW50aWZpZWQgcHJvcGVydHkgbWF0Y2hlcyB0aGUgZ2l2ZW4gaWRlbnRpZmllciB2YWx1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjZ2V0UG9pbnRlckZyb21JZGVudGlmaWVyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpZGVudGlmaWVyIC0gVGhlIFBvaW50ZXIuaWRlbnRpZmllciB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnRlcn0gQSBQb2ludGVyIG9iamVjdCBvciBudWxsIGlmIG5vIFBvaW50ZXIgb2JqZWN0IG1hdGNoZXMgdGhlIHJlcXVlc3RlZCBpZGVudGlmaWVyLgogICAgKi8KICAgIGdldFBvaW50ZXJGcm9tSWRlbnRpZmllcjogZnVuY3Rpb24gKGlkZW50aWZpZXIpIHsKCiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjEuaWRlbnRpZmllciA9PSBpZGVudGlmaWVyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjE7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMucG9pbnRlcjIuaWRlbnRpZmllciA9PSBpZGVudGlmaWVyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjI7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAzOyBpIDw9IDEwOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzWydwb2ludGVyJyArIGldICYmIHRoaXNbJ3BvaW50ZXInICsgaV0uaWRlbnRpZmllciA9PSBpZGVudGlmaWVyKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWydwb2ludGVyJyArIGldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9Cgp9OwoKUGhhc2VyLklucHV0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5JbnB1dDsKCi8qKgoqIFRoZSBYIGNvb3JkaW5hdGUgb2YgdGhlIG1vc3QgcmVjZW50bHkgYWN0aXZlIHBvaW50ZXIuIFRoaXMgdmFsdWUgdGFrZXMgZ2FtZSBzY2FsaW5nIGludG8gYWNjb3VudCBhdXRvbWF0aWNhbGx5LiBTZWUgUG9pbnRlci5zY3JlZW5YL2NsaWVudFggZm9yIHNvdXJjZSB2YWx1ZXMuCiogQG5hbWUgUGhhc2VyLklucHV0I3gKKiBAcHJvcGVydHkge251bWJlcn0geCAtIFRoZSBYIGNvb3JkaW5hdGUgb2YgdGhlIG1vc3QgcmVjZW50bHkgYWN0aXZlIHBvaW50ZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuSW5wdXQucHJvdG90eXBlLCAieCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5feDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLl94ID0gTWF0aC5mbG9vcih2YWx1ZSk7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBZIGNvb3JkaW5hdGUgb2YgdGhlIG1vc3QgcmVjZW50bHkgYWN0aXZlIHBvaW50ZXIuIFRoaXMgdmFsdWUgdGFrZXMgZ2FtZSBzY2FsaW5nIGludG8gYWNjb3VudCBhdXRvbWF0aWNhbGx5LiBTZWUgUG9pbnRlci5zY3JlZW5ZL2NsaWVudFkgZm9yIHNvdXJjZSB2YWx1ZXMuCiogQG5hbWUgUGhhc2VyLklucHV0I3kKKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSBZIGNvb3JkaW5hdGUgb2YgdGhlIG1vc3QgcmVjZW50bHkgYWN0aXZlIHBvaW50ZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuSW5wdXQucHJvdG90eXBlLCAieSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3k7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5feSA9IE1hdGguZmxvb3IodmFsdWUpOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuSW5wdXQjcG9sbExvY2tlZAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcG9sbExvY2tlZCAtIFRydWUgaWYgdGhlIElucHV0IGlzIGN1cnJlbnRseSBwb2xsIHJhdGUgbG9ja2VkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLklucHV0LnByb3RvdHlwZSwgInBvbGxMb2NrZWQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLnBvbGxSYXRlID4gMCAmJiB0aGlzLl9wb2xsQ291bnRlciA8IHRoaXMucG9sbFJhdGUpOwogICAgfQoKfSk7CgovKioKKiBUaGUgdG90YWwgbnVtYmVyIG9mIGluYWN0aXZlIFBvaW50ZXJzCiogQG5hbWUgUGhhc2VyLklucHV0I3RvdGFsSW5hY3RpdmVQb2ludGVycwoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3RhbEluYWN0aXZlUG9pbnRlcnMgLSBUaGUgdG90YWwgbnVtYmVyIG9mIGluYWN0aXZlIFBvaW50ZXJzLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLklucHV0LnByb3RvdHlwZSwgInRvdGFsSW5hY3RpdmVQb2ludGVycyIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gMTAgLSB0aGlzLmN1cnJlbnRQb2ludGVyczsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHRvdGFsIG51bWJlciBvZiBhY3RpdmUgUG9pbnRlcnMKKiBAbmFtZSBQaGFzZXIuSW5wdXQjdG90YWxBY3RpdmVQb2ludGVycwoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3RhbEFjdGl2ZVBvaW50ZXJzIC0gVGhlIHRvdGFsIG51bWJlciBvZiBhY3RpdmUgUG9pbnRlcnMuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuSW5wdXQucHJvdG90eXBlLCAidG90YWxBY3RpdmVQb2ludGVycyIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuY3VycmVudFBvaW50ZXJzID0gMDsKCiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPD0gMTA7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzWydwb2ludGVyJyArIGldICYmIHRoaXNbJ3BvaW50ZXInICsgaV0uYWN0aXZlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRQb2ludGVycysrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50UG9pbnRlcnM7CgogICAgfQoKfSk7CgovKioKKiBUaGUgd29ybGQgWCBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudGx5IGFjdGl2ZSBwb2ludGVyLgoqIEBuYW1lIFBoYXNlci5JbnB1dCN3b3JsZFgKKiBAcHJvcGVydHkge251bWJlcn0gd29ybGRYIC0gVGhlIHdvcmxkIFggY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnRseSBhY3RpdmUgcG9pbnRlci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5JbnB1dC5wcm90b3R5cGUsICJ3b3JsZFgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5jYW1lcmEudmlldy54ICsgdGhpcy54OwogICAgfQoKfSk7CgovKioKKiBUaGUgd29ybGQgWSBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudGx5IGFjdGl2ZSBwb2ludGVyLgoqIEBuYW1lIFBoYXNlci5JbnB1dCN3b3JsZFkKKiBAcHJvcGVydHkge251bWJlcn0gd29ybGRZIC0gVGhlIHdvcmxkIFkgY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnRseSBhY3RpdmUgcG9pbnRlci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5JbnB1dC5wcm90b3R5cGUsICJ3b3JsZFkiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5jYW1lcmEudmlldy55ICsgdGhpcy55OwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBAY2xhc3MgUGhhc2VyLktleQoqIEBjbGFzc2Rlc2MgSWYgeW91IG5lZWQgbW9yZSBmaW5lLWdyYWluZWQgY29udHJvbCBvdmVyIHRoZSBoYW5kbGluZyBvZiBzcGVjaWZpYyBrZXlzIHlvdSBjYW4gY3JlYXRlIGFuZCB1c2UgUGhhc2VyLktleSBvYmplY3RzLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBDdXJyZW50IGdhbWUgaW5zdGFuY2UuCiogQHBhcmFtIHtudW1iZXJ9IGtleWNvZGUgLSBUaGUga2V5IGNvZGUgdGhpcyBLZXkgaXMgcmVzcG9uc2libGUgZm9yLgoqLwpQaGFzZXIuS2V5ID0gZnVuY3Rpb24gKGdhbWUsIGtleWNvZGUpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLiAKICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzRG93biAtIFRoZSAiZG93biIgc3RhdGUgb2YgdGhlIGtleS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzRG93biA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzVXAgLSBUaGUgInVwIiBzdGF0ZSBvZiB0aGUga2V5LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNVcCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsdEtleSAtIFRoZSBkb3duIHN0YXRlIG9mIHRoZSBBTFQga2V5LCBpZiBwcmVzc2VkIGF0IHRoZSBzYW1lIHRpbWUgYXMgdGhpcyBrZXkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbHRLZXkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjdHJsS2V5IC0gVGhlIGRvd24gc3RhdGUgb2YgdGhlIENUUkwga2V5LCBpZiBwcmVzc2VkIGF0IHRoZSBzYW1lIHRpbWUgYXMgdGhpcyBrZXkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jdHJsS2V5ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gc2hpZnRLZXkgLSBUaGUgZG93biBzdGF0ZSBvZiB0aGUgU0hJRlQga2V5LCBpZiBwcmVzc2VkIGF0IHRoZSBzYW1lIHRpbWUgYXMgdGhpcyBrZXkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zaGlmdEtleSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdGltZURvd24gLSBUaGUgdGltZXN0YW1wIHdoZW4gdGhlIGtleSB3YXMgbGFzdCBwcmVzc2VkIGRvd24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50aW1lRG93biA9IDA7CgogICAgLyoqCiAgICAqIElmIHRoZSBrZXkgaXMgZG93biB0aGlzIHZhbHVlIGhvbGRzIHRoZSBkdXJhdGlvbiBvZiB0aGF0IGtleSBwcmVzcyBhbmQgaXMgY29uc3RhbnRseSB1cGRhdGVkLgogICAgKiBJZiB0aGUga2V5IGlzIHVwIGl0IGhvbGRzIHRoZSBkdXJhdGlvbiBvZiB0aGUgcHJldmlvdXMgZG93biBzZXNzaW9uLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZHVyYXRpb24gLSBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0aGlzIGtleSBoYXMgYmVlbiBoZWxkIGRvd24gZm9yLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZHVyYXRpb24gPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdGltZVVwIC0gVGhlIHRpbWVzdGFtcCB3aGVuIHRoZSBrZXkgd2FzIGxhc3QgcmVsZWFzZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50aW1lVXAgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcmVwZWF0cyAtIElmIGEga2V5IGlzIGhlbGQgZG93biB0aGlzIGhvbGRzIGRvd24gdGhlIG51bWJlciBvZiB0aW1lcyB0aGUga2V5IGhhcyAncmVwZWF0ZWQnLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucmVwZWF0cyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBrZXlDb2RlIC0gVGhlIGtleWNvZGUgb2YgdGhpcyBrZXkuCiAgICAqLwogICAgdGhpcy5rZXlDb2RlID0ga2V5Y29kZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkRvd24gLSBUaGlzIFNpZ25hbCBpcyBkaXNwYXRjaGVkIGV2ZXJ5IHRpbWUgdGhpcyBLZXkgaXMgcHJlc3NlZCBkb3duLiBJdCBpcyBvbmx5IGRpc3BhdGNoZWQgb25jZSAodW50aWwgdGhlIGtleSBpcyByZWxlYXNlZCBhZ2FpbikuCiAgICAqLwogICAgdGhpcy5vbkRvd24gPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uVXAgLSBUaGlzIFNpZ25hbCBpcyBkaXNwYXRjaGVkIGV2ZXJ5IHRpbWUgdGhpcyBLZXkgaXMgcHJlc3NlZCBkb3duLiBJdCBpcyBvbmx5IGRpc3BhdGNoZWQgb25jZSAodW50aWwgdGhlIGtleSBpcyByZWxlYXNlZCBhZ2FpbikuCiAgICAqLwogICAgdGhpcy5vblVwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIAp9OwoKUGhhc2VyLktleS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IFBoYXNlci5LZXlib2FyZC4KICAgICogQG1ldGhvZCBQaGFzZXIuS2V5I3Byb2Nlc3NLZXlEb3duCiAgICAqIEBwYXJhbSB7S2V5Ym9hcmRFdmVudH0gZXZlbnQuCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwcm9jZXNzS2V5RG93bjogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuYWx0S2V5ID0gZXZlbnQuYWx0S2V5OwogICAgICAgIHRoaXMuY3RybEtleSA9IGV2ZW50LmN0cmxLZXk7CiAgICAgICAgdGhpcy5zaGlmdEtleSA9IGV2ZW50LnNoaWZ0S2V5OwoKICAgICAgICBpZiAodGhpcy5pc0Rvd24pCiAgICAgICAgewogICAgICAgICAgICAvLyAgS2V5IHdhcyBhbHJlYWR5IGhlbGQgZG93biwgdGhpcyBtdXN0IGJlIGEgcmVwZWF0IHJhdGUgYmFzZWQgZXZlbnQKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IGV2ZW50LnRpbWVTdGFtcCAtIHRoaXMudGltZURvd247CiAgICAgICAgICAgIHRoaXMucmVwZWF0cysrOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmlzRG93biA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuaXNVcCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRpbWVEb3duID0gZXZlbnQudGltZVN0YW1wOwogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5yZXBlYXRzID0gMDsKCiAgICAgICAgICAgIHRoaXMub25Eb3duLmRpc3BhdGNoKHRoaXMpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgYXV0b21hdGljYWxseSBieSBQaGFzZXIuS2V5Ym9hcmQuCiAgICAqIEBtZXRob2QgUGhhc2VyLktleSNwcm9jZXNzS2V5VXAKICAgICogQHBhcmFtIHtLZXlib2FyZEV2ZW50fSBldmVudC4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHByb2Nlc3NLZXlVcDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuaXNEb3duID0gZmFsc2U7CiAgICAgICAgdGhpcy5pc1VwID0gdHJ1ZTsKICAgICAgICB0aGlzLnRpbWVVcCA9IGV2ZW50LnRpbWVTdGFtcDsKCiAgICAgICAgdGhpcy5vblVwLmRpc3BhdGNoKHRoaXMpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlICJqdXN0IHByZXNzZWQiIHN0YXRlIG9mIHRoZSBLZXkuIEp1c3QgcHJlc3NlZCBpcyBjb25zaWRlcmVkIHRydWUgaWYgdGhlIGtleSB3YXMgcHJlc3NlZCBkb3duIHdpdGhpbiB0aGUgZHVyYXRpb24gZ2l2ZW4gKGRlZmF1bHQgMjUwbXMpCiAgICAqIEBtZXRob2QgUGhhc2VyLktleSNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge251bWJlcn0gW2R1cmF0aW9uPTI1MF0gLSBUaGUgZHVyYXRpb24gYmVsb3cgd2hpY2ggdGhlIGtleSBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIGp1c3QgcHJlc3NlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUga2V5IGlzIGp1c3QgcHJlc3NlZCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAganVzdFByZXNzZWQ6IGZ1bmN0aW9uIChkdXJhdGlvbikgewoKICAgICAgICBpZiAodHlwZW9mIGR1cmF0aW9uID09PSAidW5kZWZpbmVkIikgeyBkdXJhdGlvbiA9IDI1MDsgfQoKICAgICAgICByZXR1cm4gKHRoaXMuaXNEb3duICYmIHRoaXMuZHVyYXRpb24gPCBkdXJhdGlvbik7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgImp1c3QgcmVsZWFzZWQiIHN0YXRlIG9mIHRoZSBLZXkuIEp1c3QgcmVsZWFzZWQgaXMgY29uc2lkZXJlZCBhcyBiZWluZyB0cnVlIGlmIHRoZSBrZXkgd2FzIHJlbGVhc2VkIHdpdGhpbiB0aGUgZHVyYXRpb24gZ2l2ZW4gKGRlZmF1bHQgMjUwbXMpCiAgICAqIEBtZXRob2QgUGhhc2VyLktleSNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge251bWJlcn0gW2R1cmF0aW9uPTI1MF0gLSBUaGUgZHVyYXRpb24gYmVsb3cgd2hpY2ggdGhlIGtleSBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIGp1c3QgcmVsZWFzZWQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGtleSBpcyBqdXN0IHJlbGVhc2VkIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBqdXN0UmVsZWFzZWQ6IGZ1bmN0aW9uIChkdXJhdGlvbikgewoKICAgICAgICBpZiAodHlwZW9mIGR1cmF0aW9uID09PSAidW5kZWZpbmVkIikgeyBkdXJhdGlvbiA9IDI1MDsgfQoKICAgICAgICByZXR1cm4gKHRoaXMuaXNEb3duID09PSBmYWxzZSAmJiAodGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy50aW1lVXAgPCBkdXJhdGlvbikpOwoKICAgIH0KCn07CgpQaGFzZXIuS2V5LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5LZXk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBUaGUgS2V5Ym9hcmQgY2xhc3MgaGFuZGxlcyBsb29raW5nIGFmdGVyIGtleWJvYXJkIGlucHV0IGZvciB5b3VyIGdhbWUuIEl0IHdpbGwgcmVjb2duaXNlIGFuZCByZXNwb25kIHRvIGtleSBwcmVzc2VzIGFuZCBkaXNwYXRjaCB0aGUgcmVxdWlyZWQgZXZlbnRzLgoqCiogQGNsYXNzIFBoYXNlci5LZXlib2FyZAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLktleWJvYXJkID0gZnVuY3Rpb24gKGdhbWUpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX2tleXMgLSBUaGUgb2JqZWN0IHRoZSBrZXkgdmFsdWVzIGFyZSBzdG9yZWQgaW4uCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fa2V5cyA9IHt9OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF9ob3RrZXlzIC0gVGhlIG9iamVjdCB0aGUgaG90IGtleXMgYXJlIHN0b3JlZCBpbi4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9ob3RrZXlzID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfY2FwdHVyZSAtIFRoZSBvYmplY3QgdGhlIGtleSBjYXB0dXJlIHZhbHVlcyBhcmUgc3RvcmVkIGluLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2NhcHR1cmUgPSB7fTsKCiAgICAvKioKICAgICogWW91IGNhbiBkaXNhYmxlIGFsbCBLZXlib2FyZCBJbnB1dCBieSBzZXR0aW5nIGRpc2FibGVkIHRvIHRydWUuIFdoaWxlIHRydWUgYWxsIG5ldyBpbnB1dCByZWxhdGVkIGV2ZW50cyB3aWxsIGJlIGlnbm9yZWQuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZGlzYWJsZWQgLSBUaGUgZGlzYWJsZWQgc3RhdGUgb2YgdGhlIEtleWJvYXJkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uS2V5RG93bgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uS2V5RG93biA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25LZXlVcAogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uS2V5VXAgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge09iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgdW5kZXIgd2hpY2ggdGhlIGNhbGxiYWNrcyBhcmUgcnVuLgogICAgKi8KICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gdGhpczsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25Eb3duQ2FsbGJhY2sgLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhIGtleSBpcyBwcmVzc2VkIGRvd24uCiAgICAqLwogICAgdGhpcy5vbkRvd25DYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uVXBDYWxsYmFjayAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIGEga2V5IGlzIHJlbGVhc2VkLgogICAgKi8KICAgIHRoaXMub25VcENhbGxiYWNrID0gbnVsbDsKICAgIAp9OwoKUGhhc2VyLktleWJvYXJkLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkIGNhbGxiYWNrcyB0byB0aGUgS2V5Ym9hcmQgaGFuZGxlciBzbyB0aGF0IGVhY2ggdGltZSBhIGtleSBpcyBwcmVzc2VkIGRvd24gb3IgcmVsZWFzZXMgdGhlIGNhbGxiYWNrcyBhcmUgYWN0aXZhdGVkLgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNhZGRDYWxsYmFja3MKICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgLSBUaGUgY29udGV4dCB1bmRlciB3aGljaCB0aGUgY2FsbGJhY2tzIGFyZSBydW4uCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IG9uRG93biAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIGEga2V5IGlzIHByZXNzZWQgZG93bi4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gW29uVXA9bnVsbF0gLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhIGtleSBpcyByZWxlYXNlZC4KICAgICovCiAgICBhZGRDYWxsYmFja3M6IGZ1bmN0aW9uIChjb250ZXh0LCBvbkRvd24sIG9uVXApIHsKCiAgICAgICAgdGhpcy5jYWxsYmFja0NvbnRleHQgPSBjb250ZXh0OwogICAgICAgIHRoaXMub25Eb3duQ2FsbGJhY2sgPSBvbkRvd247CgogICAgICAgIGlmICh0eXBlb2Ygb25VcCAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uVXBDYWxsYmFjayA9IG9uVXA7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIElmIHlvdSBuZWVkIG1vcmUgZmluZS1ncmFpbmVkIGNvbnRyb2wgb3ZlciBhIEtleSB5b3UgY2FuIGNyZWF0ZSBhIG5ldyBQaGFzZXIuS2V5IG9iamVjdCB2aWEgdGhpcyBtZXRob2QuCiAgICAqIFRoZSBLZXkgb2JqZWN0IGNhbiB0aGVuIGJlIHBvbGxlZCwgaGF2ZSBldmVudHMgYXR0YWNoZWQgdG8gaXQsIGV0Yy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjYWRkS2V5CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBrZXljb2RlIC0gVGhlIGtleWNvZGUgb2YgdGhlIGtleSwgaS5lLiBQaGFzZXIuS2V5Ym9hcmQuVVAgb3IgUGhhc2VyLktleWJvYXJkLlNQQUNFQkFSCiAgICAqIEByZXR1cm4ge1BoYXNlci5LZXl9IFRoZSBLZXkgb2JqZWN0IHdoaWNoIHlvdSBjYW4gc3RvcmUgbG9jYWxseSBhbmQgcmVmZXJlbmNlIGRpcmVjdGx5LgogICAgKi8KICAgIGFkZEtleTogZnVuY3Rpb24gKGtleWNvZGUpIHsKCiAgICAgICAgdGhpcy5faG90a2V5c1trZXljb2RlXSA9IG5ldyBQaGFzZXIuS2V5KHRoaXMuZ2FtZSwga2V5Y29kZSk7CgogICAgICAgIHRoaXMuYWRkS2V5Q2FwdHVyZShrZXljb2RlKTsKCiAgICAgICAgcmV0dXJuIHRoaXMuX2hvdGtleXNba2V5Y29kZV07CgogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlcyBhIEtleSBvYmplY3QgZnJvbSB0aGUgS2V5Ym9hcmQgbWFuYWdlci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjcmVtb3ZlS2V5CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBrZXljb2RlIC0gVGhlIGtleWNvZGUgb2YgdGhlIGtleSB0byByZW1vdmUsIGkuZS4gUGhhc2VyLktleWJvYXJkLlVQIG9yIFBoYXNlci5LZXlib2FyZC5TUEFDRUJBUgogICAgKi8KICAgIHJlbW92ZUtleTogZnVuY3Rpb24gKGtleWNvZGUpIHsKCiAgICAgICAgZGVsZXRlICh0aGlzLl9ob3RrZXlzW2tleWNvZGVdKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGFuZCByZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIDQgaG90a2V5cyBmb3IgVXAsIERvd24sIExlZnQgYW5kIFJpZ2h0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNjcmVhdGVDdXJzb3JLZXlzCiAgICAqIEByZXR1cm4ge29iamVjdH0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgcHJvcGVydGllczogdXAsIGRvd24sIGxlZnQgYW5kIHJpZ2h0LiBXaGljaCBjYW4gYmUgcG9sbGVkIGxpa2UgYW55IG90aGVyIFBoYXNlci5LZXkgb2JqZWN0LgogICAgKi8KICAgIGNyZWF0ZUN1cnNvcktleXM6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdXA6IHRoaXMuYWRkS2V5KFBoYXNlci5LZXlib2FyZC5VUCksCiAgICAgICAgICAgIGRvd246IHRoaXMuYWRkS2V5KFBoYXNlci5LZXlib2FyZC5ET1dOKSwKICAgICAgICAgICAgbGVmdDogdGhpcy5hZGRLZXkoUGhhc2VyLktleWJvYXJkLkxFRlQpLAogICAgICAgICAgICByaWdodDogdGhpcy5hZGRLZXkoUGhhc2VyLktleWJvYXJkLlJJR0hUKQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTdGFydHMgdGhlIEtleWJvYXJkIGV2ZW50IGxpc3RlbmVycyBydW5uaW5nIChrZXlkb3duIGFuZCBrZXl1cCkuIFRoZXkgYXJlIGF0dGFjaGVkIHRvIHRoZSBkb2N1bWVudC5ib2R5LgogICAgKiBUaGlzIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IFBoYXNlci5JbnB1dCBhbmQgc2hvdWxkIG5vdCBub3JtYWxseSBiZSBpbnZva2VkIGRpcmVjdGx5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNzdGFydAogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHRoaXMuX29uS2V5RG93biA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMucHJvY2Vzc0tleURvd24oZXZlbnQpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuX29uS2V5VXAgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLnByb2Nlc3NLZXlVcChldmVudCk7CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLl9vbktleURvd24sIGZhbHNlKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCB0aGlzLl9vbktleVVwLCBmYWxzZSk7CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgdGhlIEtleWJvYXJkIGV2ZW50IGxpc3RlbmVycyBmcm9tIHJ1bm5pbmcgKGtleWRvd24gYW5kIGtleXVwKS4gVGhleSBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBkb2N1bWVudC5ib2R5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNzdG9wCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMuX29uS2V5RG93bik7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleXVwJywgdGhpcy5fb25LZXlVcCk7CgogICAgfSwKCiAgICAvKioKICAgICogQnkgZGVmYXVsdCB3aGVuIGEga2V5IGlzIHByZXNzZWQgUGhhc2VyIHdpbGwgbm90IHN0b3AgdGhlIGV2ZW50IGZyb20gcHJvcGFnYXRpbmcgdXAgdG8gdGhlIGJyb3dzZXIuCiAgICAqIFRoZXJlIGFyZSBzb21lIGtleXMgdGhpcyBjYW4gYmUgYW5ub3lpbmcgZm9yLCBsaWtlIHRoZSBhcnJvdyBrZXlzIG9yIHNwYWNlIGJhciwgd2hpY2ggbWFrZSB0aGUgYnJvd3NlciB3aW5kb3cgc2Nyb2xsLgogICAgKiBZb3UgY2FuIHVzZSBhZGRLZXlDYXB0dXJlIHRvIGNvbnN1bWUgdGhlIGtleWJvYXJkIGV2ZW50IGZvciBzcGVjaWZpYyBrZXlzIHNvIGl0IGRvZXNuJ3QgYnViYmxlIHVwIHRvIHRoZSB0aGUgYnJvd3Nlci4KICAgICogUGFzcyBpbiBlaXRoZXIgYSBzaW5nbGUga2V5Y29kZSBvciBhbiBhcnJheS9oYXNoIG9mIGtleWNvZGVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNhZGRLZXlDYXB0dXJlCiAgICAqIEBwYXJhbSB7QW55fSBrZXljb2RlCiAgICAqLwogICAgYWRkS2V5Q2FwdHVyZTogZnVuY3Rpb24gKGtleWNvZGUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBrZXljb2RlID09PSAnb2JqZWN0JykKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBrZXljb2RlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9jYXB0dXJlW2tleWNvZGVba2V5XV0gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2NhcHR1cmVba2V5Y29kZV0gPSB0cnVlOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgYW4gZXhpc3Rpbmcga2V5IGNhcHR1cmUuCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI3JlbW92ZUtleUNhcHR1cmUKICAgICogQHBhcmFtIHtudW1iZXJ9IGtleWNvZGUKICAgICovCiAgICByZW1vdmVLZXlDYXB0dXJlOiBmdW5jdGlvbiAoa2V5Y29kZSkgewoKICAgICAgICBkZWxldGUgdGhpcy5fY2FwdHVyZVtrZXljb2RlXTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGVhciBhbGwgc2V0IGtleSBjYXB0dXJlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjY2xlYXJDYXB0dXJlcwogICAgKi8KICAgIGNsZWFyQ2FwdHVyZXM6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fY2FwdHVyZSA9IHt9OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFByb2Nlc3MgdGhlIGtleWRvd24gZXZlbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI3Byb2Nlc3NLZXlEb3duCiAgICAqIEBwYXJhbSB7S2V5Ym9hcmRFdmVudH0gZXZlbnQKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHByb2Nlc3NLZXlEb3duOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2NhcHR1cmVbZXZlbnQua2V5Q29kZV0pCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMub25Eb3duQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uRG93bkNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdICYmIHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0uaXNEb3duKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIEtleSBhbHJlYWR5IGRvd24gYW5kIHN0aWxsIGRvd24sIHNvIHVwZGF0ZQogICAgICAgICAgICB0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdLmR1cmF0aW9uID0gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXS50aW1lRG93bjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgTm90IHVzZWQgdGhpcyBrZXkgYmVmb3JlLCBzbyByZWdpc3RlciBpdAogICAgICAgICAgICAgICAgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXSA9IHsKICAgICAgICAgICAgICAgICAgICBpc0Rvd246IHRydWUsCiAgICAgICAgICAgICAgICAgICAgdGltZURvd246IHRoaXMuZ2FtZS50aW1lLm5vdywKICAgICAgICAgICAgICAgICAgICB0aW1lVXA6IDAsCiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDAKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgS2V5IHVzZWQgYmVmb3JlIGJ1dCBmcmVzaGx5IGRvd24KICAgICAgICAgICAgICAgIHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0uaXNEb3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0udGltZURvd24gPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgICAgICB0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdLmR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2hvdGtleXNbZXZlbnQua2V5Q29kZV0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9ob3RrZXlzW2V2ZW50LmtleUNvZGVdLnByb2Nlc3NLZXlEb3duKGV2ZW50KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUHJvY2VzcyB0aGUga2V5dXAgZXZlbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI3Byb2Nlc3NLZXlVcAogICAgKiBAcGFyYW0ge0tleWJvYXJkRXZlbnR9IGV2ZW50CiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwcm9jZXNzS2V5VXA6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fY2FwdHVyZVtldmVudC5rZXlDb2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5vblVwQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uVXBDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5faG90a2V5c1tldmVudC5rZXlDb2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2hvdGtleXNbZXZlbnQua2V5Q29kZV0ucHJvY2Vzc0tleVVwKGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXS5pc0Rvd24gPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXS50aW1lVXAgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBOb3QgdXNlZCB0aGlzIGtleSBiZWZvcmUsIHNvIHJlZ2lzdGVyIGl0CiAgICAgICAgICAgIHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0gPSB7CiAgICAgICAgICAgICAgICBpc0Rvd246IGZhbHNlLAogICAgICAgICAgICAgICAgdGltZURvd246IHRoaXMuZ2FtZS50aW1lLm5vdywKICAgICAgICAgICAgICAgIHRpbWVVcDogdGhpcy5nYW1lLnRpbWUubm93LAogICAgICAgICAgICAgICAgZHVyYXRpb246IDAKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUmVzZXQgdGhlICJpc0Rvd24iIHN0YXRlIG9mIGFsbCBrZXlzLgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNyZXNldAogICAgKi8KICAgIHJlc2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLl9rZXlzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fa2V5c1trZXldLmlzRG93biA9IGZhbHNlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSAianVzdCBwcmVzc2VkIiBzdGF0ZSBvZiB0aGUga2V5LiBKdXN0IHByZXNzZWQgaXMgY29uc2lkZXJlZCB0cnVlIGlmIHRoZSBrZXkgd2FzIHByZXNzZWQgZG93biB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuIChkZWZhdWx0IDI1MG1zKQogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge251bWJlcn0ga2V5Y29kZSAtIFRoZSBrZXljb2RlIG9mIHRoZSBrZXkgdG8gcmVtb3ZlLCBpLmUuIFBoYXNlci5LZXlib2FyZC5VUCBvciBQaGFzZXIuS2V5Ym9hcmQuU1BBQ0VCQVIKICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbj0yNTBdIC0gVGhlIGR1cmF0aW9uIGJlbG93IHdoaWNoIHRoZSBrZXkgaXMgY29uc2lkZXJlZCBhcyBiZWluZyBqdXN0IHByZXNzZWQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGtleSBpcyBqdXN0IHByZXNzZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGp1c3RQcmVzc2VkOiBmdW5jdGlvbiAoa2V5Y29kZSwgZHVyYXRpb24pIHsKCiAgICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gInVuZGVmaW5lZCIpIHsgZHVyYXRpb24gPSAyNTA7IH0KCiAgICAgICAgaWYgKHRoaXMuX2tleXNba2V5Y29kZV0gJiYgdGhpcy5fa2V5c1trZXljb2RlXS5pc0Rvd24gJiYgdGhpcy5fa2V5c1trZXljb2RlXS5kdXJhdGlvbiA8IGR1cmF0aW9uKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgImp1c3QgcmVsZWFzZWQiIHN0YXRlIG9mIHRoZSBLZXkuIEp1c3QgcmVsZWFzZWQgaXMgY29uc2lkZXJlZCBhcyBiZWluZyB0cnVlIGlmIHRoZSBrZXkgd2FzIHJlbGVhc2VkIHdpdGhpbiB0aGUgZHVyYXRpb24gZ2l2ZW4gKGRlZmF1bHQgMjUwbXMpCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI2p1c3RSZWxlYXNlZAogICAgKiBAcGFyYW0ge251bWJlcn0ga2V5Y29kZSAtIFRoZSBrZXljb2RlIG9mIHRoZSBrZXkgdG8gcmVtb3ZlLCBpLmUuIFBoYXNlci5LZXlib2FyZC5VUCBvciBQaGFzZXIuS2V5Ym9hcmQuU1BBQ0VCQVIKICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbj0yNTBdIC0gVGhlIGR1cmF0aW9uIGJlbG93IHdoaWNoIHRoZSBrZXkgaXMgY29uc2lkZXJlZCBhcyBiZWluZyBqdXN0IHJlbGVhc2VkLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBrZXkgaXMganVzdCByZWxlYXNlZCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAganVzdFJlbGVhc2VkOiBmdW5jdGlvbiAoa2V5Y29kZSwgZHVyYXRpb24pIHsKCiAgICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gInVuZGVmaW5lZCIpIHsgZHVyYXRpb24gPSAyNTA7IH0KCiAgICAgICAgaWYgKHRoaXMuX2tleXNba2V5Y29kZV0gJiYgdGhpcy5fa2V5c1trZXljb2RlXS5pc0Rvd24gPT09IGZhbHNlICYmICh0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9rZXlzW2tleWNvZGVdLnRpbWVVcCA8IGR1cmF0aW9uKSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdHJ1ZSBvZiB0aGUga2V5IGlzIGN1cnJlbnRseSBwcmVzc2VkIGRvd24uIE5vdGUgdGhhdCBpdCBjYW4gb25seSBkZXRlY3Qga2V5IHByZXNzZXMgb24gdGhlIHdlYiBicm93c2VyLgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNpc0Rvd24KICAgICogQHBhcmFtIHtudW1iZXJ9IGtleWNvZGUgLSBUaGUga2V5Y29kZSBvZiB0aGUga2V5IHRvIHJlbW92ZSwgaS5lLiBQaGFzZXIuS2V5Ym9hcmQuVVAgb3IgUGhhc2VyLktleWJvYXJkLlNQQUNFQkFSCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGtleSBpcyBjdXJyZW50bHkgZG93bi4KICAgICovCiAgICBpc0Rvd246IGZ1bmN0aW9uIChrZXljb2RlKSB7CgogICAgICAgIGlmICh0aGlzLl9rZXlzW2tleWNvZGVdKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2tleXNba2V5Y29kZV0uaXNEb3duOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0KCn07CgpQaGFzZXIuS2V5Ym9hcmQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLktleWJvYXJkOwoKUGhhc2VyLktleWJvYXJkLkEgPSAiQSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkIgPSAiQiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkMgPSAiQyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkQgPSAiRCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkUgPSAiRSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkYgPSAiRiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkcgPSAiRyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkggPSAiSCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkkgPSAiSSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkogPSAiSiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLksgPSAiSyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkwgPSAiTCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLk0gPSAiTSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLk4gPSAiTiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLk8gPSAiTyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlAgPSAiUCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlEgPSAiUSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlIgPSAiUiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlMgPSAiUyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlQgPSAiVCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlUgPSAiVSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlYgPSAiViIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlcgPSAiVyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlggPSAiWCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlkgPSAiWSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlogPSAiWiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlpFUk8gPSAiMCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLk9ORSA9ICIxIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuVFdPID0gIjIiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5USFJFRSA9ICIzIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuRk9VUiA9ICI0Ii5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuRklWRSA9ICI1Ii5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuU0lYID0gIjYiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5TRVZFTiA9ICI3Ii5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuRUlHSFQgPSAiOCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLk5JTkUgPSAiOSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF8wID0gOTY7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfMSA9IDk3OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzIgPSA5ODsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF8zID0gOTk7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfNCA9IDEwMDsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF81ID0gMTAxOwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzYgPSAxMDI7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfNyA9IDEwMzsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF84ID0gMTA0OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzkgPSAxMDU7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfTVVMVElQTFkgPSAxMDY7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfQUREID0gMTA3OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEX0VOVEVSID0gMTA4OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEX1NVQlRSQUNUID0gMTA5OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEX0RFQ0lNQUwgPSAxMTA7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfRElWSURFID0gMTExOwpQaGFzZXIuS2V5Ym9hcmQuRjEgPSAxMTI7ClBoYXNlci5LZXlib2FyZC5GMiA9IDExMzsKUGhhc2VyLktleWJvYXJkLkYzID0gMTE0OwpQaGFzZXIuS2V5Ym9hcmQuRjQgPSAxMTU7ClBoYXNlci5LZXlib2FyZC5GNSA9IDExNjsKUGhhc2VyLktleWJvYXJkLkY2ID0gMTE3OwpQaGFzZXIuS2V5Ym9hcmQuRjcgPSAxMTg7ClBoYXNlci5LZXlib2FyZC5GOCA9IDExOTsKUGhhc2VyLktleWJvYXJkLkY5ID0gMTIwOwpQaGFzZXIuS2V5Ym9hcmQuRjEwID0gMTIxOwpQaGFzZXIuS2V5Ym9hcmQuRjExID0gMTIyOwpQaGFzZXIuS2V5Ym9hcmQuRjEyID0gMTIzOwpQaGFzZXIuS2V5Ym9hcmQuRjEzID0gMTI0OwpQaGFzZXIuS2V5Ym9hcmQuRjE0ID0gMTI1OwpQaGFzZXIuS2V5Ym9hcmQuRjE1ID0gMTI2OwpQaGFzZXIuS2V5Ym9hcmQuQ09MT04gPSAxODY7ClBoYXNlci5LZXlib2FyZC5FUVVBTFMgPSAxODc7ClBoYXNlci5LZXlib2FyZC5VTkRFUlNDT1JFID0gMTg5OwpQaGFzZXIuS2V5Ym9hcmQuUVVFU1RJT05fTUFSSyA9IDE5MTsKUGhhc2VyLktleWJvYXJkLlRJTERFID0gMTkyOwpQaGFzZXIuS2V5Ym9hcmQuT1BFTl9CUkFDS0VUID0gMjE5OwpQaGFzZXIuS2V5Ym9hcmQuQkFDS1dBUkRfU0xBU0ggPSAyMjA7ClBoYXNlci5LZXlib2FyZC5DTE9TRURfQlJBQ0tFVCA9IDIyMTsKUGhhc2VyLktleWJvYXJkLlFVT1RFUyA9IDIyMjsKUGhhc2VyLktleWJvYXJkLkJBQ0tTUEFDRSA9IDg7ClBoYXNlci5LZXlib2FyZC5UQUIgPSA5OwpQaGFzZXIuS2V5Ym9hcmQuQ0xFQVIgPSAxMjsKUGhhc2VyLktleWJvYXJkLkVOVEVSID0gMTM7ClBoYXNlci5LZXlib2FyZC5TSElGVCA9IDE2OwpQaGFzZXIuS2V5Ym9hcmQuQ09OVFJPTCA9IDE3OwpQaGFzZXIuS2V5Ym9hcmQuQUxUID0gMTg7ClBoYXNlci5LZXlib2FyZC5DQVBTX0xPQ0sgPSAyMDsKUGhhc2VyLktleWJvYXJkLkVTQyA9IDI3OwpQaGFzZXIuS2V5Ym9hcmQuU1BBQ0VCQVIgPSAzMjsKUGhhc2VyLktleWJvYXJkLlBBR0VfVVAgPSAzMzsKUGhhc2VyLktleWJvYXJkLlBBR0VfRE9XTiA9IDM0OwpQaGFzZXIuS2V5Ym9hcmQuRU5EID0gMzU7ClBoYXNlci5LZXlib2FyZC5IT01FID0gMzY7ClBoYXNlci5LZXlib2FyZC5MRUZUID0gMzc7ClBoYXNlci5LZXlib2FyZC5VUCA9IDM4OwpQaGFzZXIuS2V5Ym9hcmQuUklHSFQgPSAzOTsKUGhhc2VyLktleWJvYXJkLkRPV04gPSA0MDsKUGhhc2VyLktleWJvYXJkLklOU0VSVCA9IDQ1OwpQaGFzZXIuS2V5Ym9hcmQuREVMRVRFID0gNDY7ClBoYXNlci5LZXlib2FyZC5IRUxQID0gNDc7ClBoYXNlci5LZXlib2FyZC5OVU1fTE9DSyA9IDE0NDsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlci5Nb3VzZSBpcyByZXNwb25zaWJsZSBmb3IgaGFuZGxpbmcgYWxsIGFzcGVjdHMgb2YgbW91c2UgaW50ZXJhY3Rpb24gd2l0aCB0aGUgYnJvd3Nlci4gSXQgY2FwdHVyZXMgYW5kIHByb2Nlc3NlcyBtb3VzZSBldmVudHMuCioKKiBAY2xhc3MgUGhhc2VyLk1vdXNlCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuTW91c2UgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCB1bmRlciB3aGljaCBjYWxsYmFja3MgYXJlIGNhbGxlZC4KICAgICovCiAgICB0aGlzLmNhbGxiYWNrQ29udGV4dCA9IHRoaXMuZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gbW91c2VEb3duQ2FsbGJhY2sgLSBBIGNhbGxiYWNrIHRoYXQgY2FuIGJlIGZpcmVkIHdoZW4gdGhlIG1vdXNlIGlzIHByZXNzZWQgZG93bi4KICAgICovCiAgICB0aGlzLm1vdXNlRG93bkNhbGxiYWNrID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG1vdXNlTW92ZUNhbGxiYWNrIC0gQSBjYWxsYmFjayB0aGF0IGNhbiBiZSBmaXJlZCB3aGVuIHRoZSBtb3VzZSBpcyBtb3ZlZCB3aGlsZSBwcmVzc2VkIGRvd24uCiAgICAqLwogICAgdGhpcy5tb3VzZU1vdmVDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBtb3VzZVVwQ2FsbGJhY2sgLSBBIGNhbGxiYWNrIHRoYXQgY2FuIGJlIGZpcmVkIHdoZW4gdGhlIG1vdXNlIGlzIHJlbGVhc2VkIGZyb20gYSBwcmVzc2VkIGRvd24gc3RhdGUuCiAgICAqLwogICAgdGhpcy5tb3VzZVVwQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNhcHR1cmUgLSBJZiB0cnVlIHRoZSBET00gbW91c2UgZXZlbnRzIHdpbGwgaGF2ZSBldmVudC5wcmV2ZW50RGVmYXVsdCBhcHBsaWVkIHRvIHRoZW0sIGlmIGZhbHNlIHRoZXkgd2lsbCBwcm9wb2dhdGUgZnVsbHkuCiAgICAqLwogICAgdGhpcy5jYXB0dXJlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBidXR0b24tIFRoZSB0eXBlIG9mIGNsaWNrLCBlaXRoZXI6IFBoYXNlci5Nb3VzZS5OT19CVVRUT04sIFBoYXNlci5Nb3VzZS5MRUZUX0JVVFRPTiwgUGhhc2VyLk1vdXNlLk1JRERMRV9CVVRUT04gb3IgUGhhc2VyLk1vdXNlLlJJR0hUX0JVVFRPTi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmJ1dHRvbiA9IC0xOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRpc2FibGVkIC0gWW91IGNhbiBkaXNhYmxlIGFsbCBJbnB1dCBieSBzZXR0aW5nIGRpc2FibGVkID0gdHJ1ZS4gV2hpbGUgc2V0IGFsbCBuZXcgaW5wdXQgcmVsYXRlZCBldmVudHMgd2lsbCBiZSBpZ25vcmVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBsb2NrZWQgLSBJZiB0aGUgbW91c2UgaGFzIGJlZW4gUG9pbnRlciBMb2NrZWQgc3VjY2Vzc2Z1bGx5IHRoaXMgd2lsbCBiZSBzZXQgdG8gdHJ1ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmxvY2tlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IHBvaW50ZXJMb2NrIC0gVGhpcyBldmVudCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhlIGJyb3dzZXIgZW50ZXJzIG9yIGxlYXZlcyBwb2ludGVyIGxvY2sgc3RhdGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wb2ludGVyTG9jayA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7TW91c2VFdmVudH0gZXZlbnQgLSBUaGUgYnJvd3NlciBtb3VzZSBET00gZXZlbnQuIFdpbGwgYmUgc2V0IHRvIG51bGwgaWYgbm8gbW91c2UgZXZlbnQgaGFzIGV2ZXIgYmVlbiByZWNlaXZlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmV2ZW50ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uTW91c2VEb3duIC0gSW50ZXJuYWwgZXZlbnQgaGFuZGxlciByZWZlcmVuY2UuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fb25Nb3VzZURvd24gPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25Nb3VzZU1vdmUgLSBJbnRlcm5hbCBldmVudCBoYW5kbGVyIHJlZmVyZW5jZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vbk1vdXNlTW92ZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vbk1vdXNlVXAgLSBJbnRlcm5hbCBldmVudCBoYW5kbGVyIHJlZmVyZW5jZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vbk1vdXNlVXAgPSBudWxsOwoKfTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Nb3VzZS5OT19CVVRUT04gPSAtMTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Nb3VzZS5MRUZUX0JVVFRPTiA9IDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuTW91c2UuTUlERExFX0JVVFRPTiA9IDE7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuTW91c2UuUklHSFRfQlVUVE9OID0gMjsKClBoYXNlci5Nb3VzZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFN0YXJ0cyB0aGUgZXZlbnQgbGlzdGVuZXJzIHJ1bm5pbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1vdXNlI3N0YXJ0CiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UuYW5kcm9pZCAmJiB0aGlzLmdhbWUuZGV2aWNlLmNocm9tZSA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICAvLyAgQW5kcm9pZCBzdG9jayBicm93c2VyIGZpcmVzIG1vdXNlIGV2ZW50cyBldmVuIGlmIHlvdSBwcmV2ZW50RGVmYXVsdCBvbiB0aGUgdG91Y2hTdGFydCwgc28gLi4uCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX29uTW91c2VEb3duID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBfdGhpcy5vbk1vdXNlRG93bihldmVudCk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5fb25Nb3VzZU1vdmUgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uTW91c2VNb3ZlKGV2ZW50KTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLl9vbk1vdXNlVXAgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uTW91c2VVcChldmVudCk7CiAgICAgICAgfTsKCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgdGhpcy5fb25Nb3VzZURvd24sIHRydWUpOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuX29uTW91c2VNb3ZlLCB0cnVlKTsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5fb25Nb3VzZVVwLCB0cnVlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgaW50ZXJuYWwgbWV0aG9kIHRoYXQgaGFuZGxlcyB0aGUgbW91c2UgZG93biBldmVudCBmcm9tIHRoZSBicm93c2VyLgogICAgKiBAbWV0aG9kIFBoYXNlci5Nb3VzZSNvbk1vdXNlRG93bgogICAgKiBAcGFyYW0ge01vdXNlRXZlbnR9IGV2ZW50IC0gVGhlIG5hdGl2ZSBldmVudCBmcm9tIHRoZSBicm93c2VyLiBUaGlzIGdldHMgc3RvcmVkIGluIE1vdXNlLmV2ZW50LgogICAgKi8KICAgIG9uTW91c2VEb3duOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5ldmVudCA9IGV2ZW50OwoKICAgICAgICBpZiAodGhpcy5jYXB0dXJlKQogICAgICAgIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuYnV0dG9uID0gZXZlbnQud2hpY2g7CgogICAgICAgIGlmICh0aGlzLm1vdXNlRG93bkNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb3VzZURvd25DYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBldmVudFsnaWRlbnRpZmllciddID0gMDsKCiAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm1vdXNlUG9pbnRlci5zdGFydChldmVudCk7CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIGludGVybmFsIG1ldGhvZCB0aGF0IGhhbmRsZXMgdGhlIG1vdXNlIG1vdmUgZXZlbnQgZnJvbSB0aGUgYnJvd3Nlci4KICAgICogQG1ldGhvZCBQaGFzZXIuTW91c2Ujb25Nb3VzZU1vdmUKICAgICogQHBhcmFtIHtNb3VzZUV2ZW50fSBldmVudCAtIFRoZSBuYXRpdmUgZXZlbnQgZnJvbSB0aGUgYnJvd3Nlci4gVGhpcyBnZXRzIHN0b3JlZCBpbiBNb3VzZS5ldmVudC4KICAgICovCiAgICBvbk1vdXNlTW92ZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuZXZlbnQgPSBldmVudDsKCiAgICAgICAgaWYgKHRoaXMuY2FwdHVyZSkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5tb3VzZU1vdmVDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubW91c2VNb3ZlQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZXZlbnRbJ2lkZW50aWZpZXInXSA9IDA7CgogICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5tb3VzZVBvaW50ZXIubW92ZShldmVudCk7CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIGludGVybmFsIG1ldGhvZCB0aGF0IGhhbmRsZXMgdGhlIG1vdXNlIHVwIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1vdXNlI29uTW91c2VVcAogICAgKiBAcGFyYW0ge01vdXNlRXZlbnR9IGV2ZW50IC0gVGhlIG5hdGl2ZSBldmVudCBmcm9tIHRoZSBicm93c2VyLiBUaGlzIGdldHMgc3RvcmVkIGluIE1vdXNlLmV2ZW50LgogICAgKi8KICAgIG9uTW91c2VVcDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuZXZlbnQgPSBldmVudDsKCiAgICAgICAgaWYgKHRoaXMuY2FwdHVyZSkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmJ1dHRvbiA9IFBoYXNlci5Nb3VzZS5OT19CVVRUT047CgogICAgICAgIGlmICh0aGlzLm1vdXNlVXBDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubW91c2VVcENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGV2ZW50WydpZGVudGlmaWVyJ10gPSAwOwoKICAgICAgICB0aGlzLmdhbWUuaW5wdXQubW91c2VQb2ludGVyLnN0b3AoZXZlbnQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIElmIHRoZSBicm93c2VyIHN1cHBvcnRzIGl0IHlvdSBjYW4gcmVxdWVzdCB0aGF0IHRoZSBwb2ludGVyIGJlIGxvY2tlZCB0byB0aGUgYnJvd3NlciB3aW5kb3cuCiAgICAqIFRoaXMgaXMgY2xhc3NpY2FsbHkga25vd24gYXMgJ0ZQUyBjb250cm9scycsIHdoZXJlIHRoZSBwb2ludGVyIGNhbid0IGxlYXZlIHRoZSBicm93c2VyIHVudGlsIHRoZSB1c2VyIHByZXNzZXMgYW4gZXhpdCBrZXkuCiAgICAqIElmIHRoZSBicm93c2VyIHN1Y2Nlc3NmdWxseSBlbnRlcnMgYSBsb2NrZWQgc3RhdGUgdGhlIGV2ZW50IFBoYXNlci5Nb3VzZS5wb2ludGVyTG9jayB3aWxsIGJlIGRpc3BhdGNoZWQgYW5kIHRoZSBmaXJzdCBwYXJhbWV0ZXIgd2lsbCBiZSAndHJ1ZScuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1vdXNlI3JlcXVlc3RQb2ludGVyTG9jawogICAgKi8KICAgIHJlcXVlc3RQb2ludGVyTG9jazogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS5wb2ludGVyTG9jaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5nYW1lLnN0YWdlLmNhbnZhczsKCiAgICAgICAgICAgIGVsZW1lbnQucmVxdWVzdFBvaW50ZXJMb2NrID0gZWxlbWVudC5yZXF1ZXN0UG9pbnRlckxvY2sgfHwgZWxlbWVudC5tb3pSZXF1ZXN0UG9pbnRlckxvY2sgfHwgZWxlbWVudC53ZWJraXRSZXF1ZXN0UG9pbnRlckxvY2s7CgogICAgICAgICAgICBlbGVtZW50LnJlcXVlc3RQb2ludGVyTG9jaygpOwoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJMb2NrQ2hhbmdlID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMucG9pbnRlckxvY2tDaGFuZ2UoZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcmxvY2tjaGFuZ2UnLCB0aGlzLl9wb2ludGVyTG9ja0NoYW5nZSwgdHJ1ZSk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21venBvaW50ZXJsb2NrY2hhbmdlJywgdGhpcy5fcG9pbnRlckxvY2tDaGFuZ2UsIHRydWUpOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRwb2ludGVybG9ja2NoYW5nZScsIHRoaXMuX3BvaW50ZXJMb2NrQ2hhbmdlLCB0cnVlKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgcG9pbnRlckxvY2tDaGFuZ2UgaGFuZGxlci4KICAgICogQG1ldGhvZCBQaGFzZXIuTW91c2UjcG9pbnRlckxvY2tDaGFuZ2UKICAgICogQHBhcmFtIHtwb2ludGVybG9ja2NoYW5nZX0gZXZlbnQgLSBUaGUgbmF0aXZlIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuIFRoaXMgZ2V0cyBzdG9yZWQgaW4gTW91c2UuZXZlbnQuCiAgICAqLwogICAgcG9pbnRlckxvY2tDaGFuZ2U6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZ2FtZS5zdGFnZS5jYW52YXM7CgogICAgICAgIGlmIChkb2N1bWVudC5wb2ludGVyTG9ja0VsZW1lbnQgPT09IGVsZW1lbnQgfHwgZG9jdW1lbnQubW96UG9pbnRlckxvY2tFbGVtZW50ID09PSBlbGVtZW50IHx8IGRvY3VtZW50LndlYmtpdFBvaW50ZXJMb2NrRWxlbWVudCA9PT0gZWxlbWVudCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBQb2ludGVyIHdhcyBzdWNjZXNzZnVsbHkgbG9ja2VkCiAgICAgICAgICAgIHRoaXMubG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5wb2ludGVyTG9jay5kaXNwYXRjaCh0cnVlLCBldmVudCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBQb2ludGVyIHdhcyB1bmxvY2tlZAogICAgICAgICAgICB0aGlzLmxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnBvaW50ZXJMb2NrLmRpc3BhdGNoKGZhbHNlLCBldmVudCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIHJlbGVhc2UgcG9pbnRlciBsb2NrIGhhbmRsZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1vdXNlI3JlbGVhc2VQb2ludGVyTG9jawogICAgKi8KICAgIHJlbGVhc2VQb2ludGVyTG9jazogZnVuY3Rpb24gKCkgewoKICAgICAgICBkb2N1bWVudC5leGl0UG9pbnRlckxvY2sgPSBkb2N1bWVudC5leGl0UG9pbnRlckxvY2sgfHwgZG9jdW1lbnQubW96RXhpdFBvaW50ZXJMb2NrIHx8IGRvY3VtZW50LndlYmtpdEV4aXRQb2ludGVyTG9jazsKCiAgICAgICAgZG9jdW1lbnQuZXhpdFBvaW50ZXJMb2NrKCk7CgogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJsb2NrY2hhbmdlJywgdGhpcy5fcG9pbnRlckxvY2tDaGFuZ2UsIHRydWUpOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21venBvaW50ZXJsb2NrY2hhbmdlJywgdGhpcy5fcG9pbnRlckxvY2tDaGFuZ2UsIHRydWUpOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3dlYmtpdHBvaW50ZXJsb2NrY2hhbmdlJywgdGhpcy5fcG9pbnRlckxvY2tDaGFuZ2UsIHRydWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3AgdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICogQG1ldGhvZCBQaGFzZXIuTW91c2Ujc3RvcAogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgdGhpcy5fb25Nb3VzZURvd24sIHRydWUpOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuX29uTW91c2VNb3ZlLCB0cnVlKTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5fb25Nb3VzZVVwLCB0cnVlKTsKCiAgICB9Cgp9OwoKUGhhc2VyLk1vdXNlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5Nb3VzZTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlciAtIE1TUG9pbnRlciBjb25zdHJ1Y3Rvci4KKgoqIEBjbGFzcyBQaGFzZXIuTVNQb2ludGVyCiogQGNsYXNzZGVzYyBUaGUgTVNQb2ludGVyIGNsYXNzIGhhbmRsZXMgdG91Y2ggaW50ZXJhY3Rpb25zIHdpdGggdGhlIGdhbWUgYW5kIHRoZSByZXN1bHRpbmcgUG9pbnRlciBvYmplY3RzLgoqIEl0IHdpbGwgd29yayBvbmx5IGluIEludGVybmV0IEV4cGxvcmVyIDEwIGFuZCBXaW5kb3dzIFN0b3JlIG9yIFdpbmRvd3MgUGhvbmUgOCBhcHBzIHVzaW5nIEphdmFTY3JpcHQuCiogaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2llL2hoNjczNTU3KHY9dnMuODUpLmFzcHgKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5NU1BvaW50ZXIgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCB1bmRlciB3aGljaCBjYWxsYmFja3MgYXJlIGNhbGxlZCAoZGVmYXVsdHMgdG8gZ2FtZSkuCiAgICAqLwogICAgdGhpcy5jYWxsYmFja0NvbnRleHQgPSB0aGlzLmdhbWU7CgogICAgLyoqCiAgICAqIFlvdSBjYW4gZGlzYWJsZSBhbGwgSW5wdXQgYnkgc2V0dGluZyBkaXNhYmxlZCA9IHRydWUuIFdoaWxlIHNldCBhbGwgbmV3IGlucHV0IHJlbGF0ZWQgZXZlbnRzIHdpbGwgYmUgaWdub3JlZC4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBkaXNhYmxlZAogICAgKi8KICAgIHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uTVNQb2ludGVyRG93biAtIEludGVybmFsIGZ1bmN0aW9uIHRvIGhhbmRsZSBNU1BvaW50ZXIgZXZlbnRzLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uTVNQb2ludGVyRG93biA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25NU1BvaW50ZXJNb3ZlIC0gSW50ZXJuYWwgZnVuY3Rpb24gdG8gaGFuZGxlIE1TUG9pbnRlciBldmVudHMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fb25NU1BvaW50ZXJNb3ZlID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vbk1TUG9pbnRlclVwIC0gSW50ZXJuYWwgZnVuY3Rpb24gdG8gaGFuZGxlIE1TUG9pbnRlciBldmVudHMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fb25NU1BvaW50ZXJVcCA9IG51bGw7Cgp9OwoKUGhhc2VyLk1TUG9pbnRlci5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFN0YXJ0cyB0aGUgZXZlbnQgbGlzdGVuZXJzIHJ1bm5pbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1TUG9pbnRlciNzdGFydAogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLm1zcG9pbnRlciA9PT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uTVNQb2ludGVyRG93biA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uUG9pbnRlckRvd24oZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5fb25NU1BvaW50ZXJNb3ZlID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMub25Qb2ludGVyTW92ZShldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9vbk1TUG9pbnRlclVwID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMub25Qb2ludGVyVXAoZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcignTVNQb2ludGVyRG93bicsIHRoaXMuX29uTVNQb2ludGVyRG93biwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJNb3ZlJywgdGhpcy5fb25NU1BvaW50ZXJNb3ZlLCBmYWxzZSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ01TUG9pbnRlclVwJywgdGhpcy5fb25NU1BvaW50ZXJVcCwgZmFsc2UpOwoKICAgICAgICAgICAgLy8gIElFMTErIHVzZXMgbm9uLXByZWZpeCBldmVudHMKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlckRvd24nLCB0aGlzLl9vbk1TUG9pbnRlckRvd24sIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlck1vdmUnLCB0aGlzLl9vbk1TUG9pbnRlck1vdmUsIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlclVwJywgdGhpcy5fb25NU1BvaW50ZXJVcCwgZmFsc2UpOwoKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuc3R5bGVbJy1tcy1jb250ZW50LXpvb21pbmcnXSA9ICdub25lJzsKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuc3R5bGVbJy1tcy10b3VjaC1hY3Rpb24nXSA9ICdub25lJzsKCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBmdW5jdGlvbiB0aGF0IGhhbmRsZXMgdGhlIFBvaW50ZXJEb3duIGV2ZW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5NU1BvaW50ZXIjb25Qb2ludGVyRG93bgogICAgKiBAcGFyYW0ge1BvaW50ZXJFdmVudH0gZXZlbnQKICAgICovCiAgICBvblBvaW50ZXJEb3duOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICBldmVudC5pZGVudGlmaWVyID0gZXZlbnQucG9pbnRlcklkOwoKICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc3RhcnRQb2ludGVyKGV2ZW50KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIHRoZSBQb2ludGVyTW92ZSBldmVudC4KICAgICogQG1ldGhvZCBQaGFzZXIuTVNQb2ludGVyI29uUG9pbnRlck1vdmUKICAgICogQHBhcmFtIHtQb2ludGVyRXZlbnQgfSBldmVudAogICAgKi8KICAgIG9uUG9pbnRlck1vdmU6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGV2ZW50LmlkZW50aWZpZXIgPSBldmVudC5wb2ludGVySWQ7CgogICAgICAgIHRoaXMuZ2FtZS5pbnB1dC51cGRhdGVQb2ludGVyKGV2ZW50KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIHRoZSBQb2ludGVyVXAgZXZlbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1TUG9pbnRlciNvblBvaW50ZXJVcAogICAgKiBAcGFyYW0ge1BvaW50ZXJFdmVudH0gZXZlbnQKICAgICovCiAgICBvblBvaW50ZXJVcDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgZXZlbnQuaWRlbnRpZmllciA9IGV2ZW50LnBvaW50ZXJJZDsKCiAgICAgICAgdGhpcy5nYW1lLmlucHV0LnN0b3BQb2ludGVyKGV2ZW50KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wIHRoZSBldmVudCBsaXN0ZW5lcnMuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1TUG9pbnRlciNzdG9wCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ01TUG9pbnRlckRvd24nLCB0aGlzLl9vbk1TUG9pbnRlckRvd24pOwogICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignTVNQb2ludGVyTW92ZScsIHRoaXMuX29uTVNQb2ludGVyTW92ZSk7CiAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJVcCcsIHRoaXMuX29uTVNQb2ludGVyVXApOwoKICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJEb3duJywgdGhpcy5fb25NU1BvaW50ZXJEb3duKTsKICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJNb3ZlJywgdGhpcy5fb25NU1BvaW50ZXJNb3ZlKTsKICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJVcCcsIHRoaXMuX29uTVNQb2ludGVyVXApOwoKICAgIH0KCn07CgpQaGFzZXIuTVNQb2ludGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5NU1BvaW50ZXI7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIgLSBQb2ludGVyIGNvbnN0cnVjdG9yLgoqCiogQGNsYXNzIFBoYXNlci5Qb2ludGVyCiogQGNsYXNzZGVzYyBBIFBvaW50ZXIgb2JqZWN0IGlzIHVzZWQgYnkgdGhlIE1vdXNlLCBUb3VjaCBhbmQgTVNQb2ludCBtYW5hZ2VycyBhbmQgcmVwcmVzZW50cyBhIHNpbmdsZSBmaW5nZXIgb24gdGhlIHRvdWNoIHNjcmVlbi4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtudW1iZXJ9IGlkIC0gVGhlIElEIG9mIHRoZSBQb2ludGVyIG9iamVjdCB3aXRoaW4gdGhlIGdhbWUuIEVhY2ggZ2FtZSBjYW4gaGF2ZSB1cCB0byAxMCBhY3RpdmUgcG9pbnRlcnMuCiovClBoYXNlci5Qb2ludGVyID0gZnVuY3Rpb24gKGdhbWUsIGlkKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaWQgLSBUaGUgSUQgb2YgdGhlIFBvaW50ZXIgb2JqZWN0IHdpdGhpbiB0aGUgZ2FtZS4gRWFjaCBnYW1lIGNhbiBoYXZlIHVwIHRvIDEwIGFjdGl2ZSBwb2ludGVycy4KICAgICovCiAgICB0aGlzLmlkID0gaWQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX2hvbGRTZW50IC0gTG9jYWwgcHJpdmF0ZSB2YXJpYWJsZSB0byBzdG9yZSB0aGUgc3RhdHVzIG9mIGRpc3BhdGNoaW5nIGEgaG9sZCBldmVudC4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9ob2xkU2VudCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBfaGlzdG9yeSAtIExvY2FsIHByaXZhdGUgdmFyaWFibGUgc3RvcmluZyB0aGUgc2hvcnQtdGVybSBoaXN0b3J5IG9mIHBvaW50ZXIgbW92ZW1lbnRzLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2hpc3RvcnkgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9sYXN0RHJvcCAtIExvY2FsIHByaXZhdGUgdmFyaWFibGUgc3RvcmluZyB0aGUgdGltZSBhdCB3aGljaCB0aGUgbmV4dCBoaXN0b3J5IGRyb3Agc2hvdWxkIG9jY3VyLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX25leHREcm9wID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfc3RhdGVSZXNldCAtIE1vbml0b3IgZXZlbnRzIG91dHNpZGUgb2YgYSBzdGF0ZSByZXNldCBsb29wLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3N0YXRlUmVzZXQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB3aXRoaW5HYW1lIC0gdHJ1ZSBpZiB0aGUgUG9pbnRlciBpcyB3aXRoaW4gdGhlIGdhbWUgYXJlYSwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIHRoaXMud2l0aGluR2FtZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY2xpZW50WCAtIFRoZSBob3Jpem9udGFsIGNvb3JkaW5hdGUgb2YgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIHZpZXdwb3J0IGluIHBpeGVscywgZXhjbHVkaW5nIGFueSBzY3JvbGwgb2Zmc2V0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2xpZW50WCA9IC0xOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY2xpZW50WSAtIFRoZSB2ZXJ0aWNhbCBjb29yZGluYXRlIG9mIHBvaW50IHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydCBpbiBwaXhlbHMsIGV4Y2x1ZGluZyBhbnkgc2Nyb2xsIG9mZnNldC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNsaWVudFkgPSAtMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBhZ2VYIC0gVGhlIGhvcml6b250YWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQgaW4gcGl4ZWxzLCBpbmNsdWRpbmcgYW55IHNjcm9sbCBvZmZzZXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYWdlWCA9IC0xOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGFnZVkgLSBUaGUgdmVydGljYWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQgaW4gcGl4ZWxzLCBpbmNsdWRpbmcgYW55IHNjcm9sbCBvZmZzZXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYWdlWSA9IC0xOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc2NyZWVuWCAtIFRoZSBob3Jpem9udGFsIGNvb3JkaW5hdGUgb2YgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIHNjcmVlbiBpbiBwaXhlbHMuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zY3JlZW5YID0gLTE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzY3JlZW5ZIC0gVGhlIHZlcnRpY2FsIGNvb3JkaW5hdGUgb2YgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIHNjcmVlbiBpbiBwaXhlbHMuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zY3JlZW5ZID0gLTE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIGhvcml6b250YWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgZ2FtZSBlbGVtZW50LiBUaGlzIHZhbHVlIGlzIGF1dG9tYXRpY2FsbHkgc2NhbGVkIGJhc2VkIG9uIGdhbWUgc2l6ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnggPSAtMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBUaGUgdmVydGljYWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgZ2FtZSBlbGVtZW50LiBUaGlzIHZhbHVlIGlzIGF1dG9tYXRpY2FsbHkgc2NhbGVkIGJhc2VkIG9uIGdhbWUgc2l6ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnkgPSAtMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc01vdXNlIC0gSWYgdGhlIFBvaW50ZXIgaXMgYSBtb3VzZSB0aGlzIGlzIHRydWUsIG90aGVyd2lzZSBmYWxzZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzTW91c2UgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc0Rvd24gLSBJZiB0aGUgUG9pbnRlciBpcyB0b3VjaGluZyB0aGUgdG91Y2hzY3JlZW4sIG9yIHRoZSBtb3VzZSBidXR0b24gaXMgaGVsZCBkb3duLCBpc0Rvd24gaXMgc2V0IHRvIHRydWUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc0Rvd24gPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc1VwIC0gSWYgdGhlIFBvaW50ZXIgaXMgbm90IHRvdWNoaW5nIHRoZSB0b3VjaHNjcmVlbiwgb3IgdGhlIG1vdXNlIGJ1dHRvbiBpcyB1cCwgaXNVcCBpcyBzZXQgdG8gdHJ1ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzVXAgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdGltZURvd24gLSBBIHRpbWVzdGFtcCByZXByZXNlbnRpbmcgd2hlbiB0aGUgUG9pbnRlciBmaXJzdCB0b3VjaGVkIHRoZSB0b3VjaHNjcmVlbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRpbWVEb3duID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVVcCAtIEEgdGltZXN0YW1wIHJlcHJlc2VudGluZyB3aGVuIHRoZSBQb2ludGVyIGxlZnQgdGhlIHRvdWNoc2NyZWVuLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGltZVVwID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHByZXZpb3VzVGFwVGltZSAtIEEgdGltZXN0YW1wIHJlcHJlc2VudGluZyB3aGVuIHRoZSBQb2ludGVyIHdhcyBsYXN0IHRhcHBlZCBvciBjbGlja2VkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucHJldmlvdXNUYXBUaW1lID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsVG91Y2hlcyAtIFRoZSB0b3RhbCBudW1iZXIgb2YgdGltZXMgdGhpcyBQb2ludGVyIGhhcyBiZWVuIHRvdWNoZWQgdG8gdGhlIHRvdWNoc2NyZWVuLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudG90YWxUb3VjaGVzID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1zU2luY2VMYXN0Q2xpY2sgLSBUaGUgbnVtYmVyIG9mIG1pbGlzZWNvbmRzIHNpbmNlIHRoZSBsYXN0IGNsaWNrLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubXNTaW5jZUxhc3RDbGljayA9IE51bWJlci5NQVhfVkFMVUU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YW55fSB0YXJnZXRPYmplY3QgLSBUaGUgR2FtZSBPYmplY3QgdGhpcyBQb2ludGVyIGlzIGN1cnJlbnRseSBvdmVyIC8gdG91Y2hpbmcgLyBkcmFnZ2luZy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRhcmdldE9iamVjdCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWN0aXZlIC0gQW4gYWN0aXZlIHBvaW50ZXIgaXMgb25lIHRoYXQgaXMgY3VycmVudGx5IHByZXNzZWQgZG93biBvbiB0aGUgZGlzcGxheS4gQSBNb3VzZSBpcyBhbHdheXMgYWN0aXZlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBwb3NpdGlvbiAtIEEgUGhhc2VyLlBvaW50IG9iamVjdCBjb250YWluaW5nIHRoZSBjdXJyZW50IHgveSB2YWx1ZXMgb2YgdGhlIHBvaW50ZXIgb24gdGhlIGRpc3BsYXkuCiAgICAqLwogICAgdGhpcy5wb3NpdGlvbiA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBwb3NpdGlvbkRvd24gLSBBIFBoYXNlci5Qb2ludCBvYmplY3QgY29udGFpbmluZyB0aGUgeC95IHZhbHVlcyBvZiB0aGUgcG9pbnRlciB3aGVuIGl0IHdhcyBsYXN0IGluIGEgZG93biBzdGF0ZSBvbiB0aGUgZGlzcGxheS4KICAgICovCiAgICB0aGlzLnBvc2l0aW9uRG93biA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAvKioKICAgICogQSBQaGFzZXIuQ2lyY2xlIHRoYXQgaXMgY2VudGVyZWQgb24gdGhlIHgveSBjb29yZGluYXRlcyBvZiB0aGlzIHBvaW50ZXIsIHVzZWZ1bCBmb3IgaGl0IGRldGVjdGlvbi4KICAgICogVGhlIENpcmNsZSBzaXplIGlzIDQ0cHggKEFwcGxlcyByZWNvbW1lbmRlZCAiZmluZ2VyIHRpcCIgc2l6ZSkuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkNpcmNsZX0gY2lyY2xlCiAgICAqLwogICAgdGhpcy5jaXJjbGUgPSBuZXcgUGhhc2VyLkNpcmNsZSgwLCAwLCA0NCk7CgogICAgaWYgKGlkID09PSAwKQogICAgewogICAgICAgIHRoaXMuaXNNb3VzZSA9IHRydWU7CiAgICB9Cgp9OwoKUGhhc2VyLlBvaW50ZXIucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBDYWxsZWQgd2hlbiB0aGUgUG9pbnRlciBpcyBwcmVzc2VkIG9udG8gdGhlIHRvdWNoc2NyZWVuLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludGVyI3N0YXJ0CiAgICAqIEBwYXJhbSB7QW55fSBldmVudAogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5pZGVudGlmaWVyID0gZXZlbnQuaWRlbnRpZmllcjsKICAgICAgICB0aGlzLnRhcmdldCA9IGV2ZW50LnRhcmdldDsKCiAgICAgICAgaWYgKHR5cGVvZiBldmVudC5idXR0b24gIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5idXR0b24gPSBldmVudC5idXR0b247CiAgICAgICAgfQoKICAgICAgICAvLyAgRml4IHRvIHN0b3Agcm9ndWUgYnJvd3NlciBwbHVnaW5zIGZyb20gYmxvY2tpbmcgdGhlIHZpc2liaWxpdHkgc3RhdGUgZXZlbnQKICAgICAgICBpZiAodGhpcy5nYW1lLnN0YWdlLmRpc2FibGVWaXNpYmlsaXR5Q2hhbmdlID09PSBmYWxzZSAmJiB0aGlzLmdhbWUucGF1c2VkICYmIHRoaXMuZ2FtZS5zdGFnZS5zY2FsZS5pbmNvcnJlY3RPcmllbnRhdGlvbiA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUucGF1c2VkID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5faGlzdG9yeS5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICAgICAgICB0aGlzLndpdGhpbkdhbWUgPSB0cnVlOwogICAgICAgIHRoaXMuaXNEb3duID0gdHJ1ZTsKICAgICAgICB0aGlzLmlzVXAgPSBmYWxzZTsKCiAgICAgICAgLy8gIFdvcmsgb3V0IGhvdyBsb25nIGl0IGhhcyBiZWVuIHNpbmNlIHRoZSBsYXN0IGNsaWNrCiAgICAgICAgdGhpcy5tc1NpbmNlTGFzdENsaWNrID0gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy50aW1lRG93bjsKICAgICAgICB0aGlzLnRpbWVEb3duID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgIHRoaXMuX2hvbGRTZW50ID0gZmFsc2U7CgogICAgICAgIC8vICBUaGlzIHNldHMgdGhlIHgveSBhbmQgb3RoZXIgbG9jYWwgdmFsdWVzCiAgICAgICAgdGhpcy5tb3ZlKGV2ZW50KTsKCiAgICAgICAgLy8geCBhbmQgeSBhcmUgdGhlIG9sZCB2YWx1ZXMgaGVyZT8KICAgICAgICB0aGlzLnBvc2l0aW9uRG93bi5zZXRUbyh0aGlzLngsIHRoaXMueSk7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9PVkVSUklERVNfVE9VQ0ggfHwgdGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuTU9VU0VfVE9VQ0hfQ09NQklORSB8fCAodGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuVE9VQ0hfT1ZFUlJJREVTX01PVVNFICYmIHRoaXMuZ2FtZS5pbnB1dC5jdXJyZW50UG9pbnRlcnMgPT09IDApKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnggPSB0aGlzLng7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC55ID0gdGhpcy55OwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQucG9zaXRpb24uc2V0VG8odGhpcy54LCB0aGlzLnkpOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQub25Eb3duLmRpc3BhdGNoKHRoaXMsIGV2ZW50KTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnJlc2V0U3BlZWQodGhpcy54LCB0aGlzLnkpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fc3RhdGVSZXNldCA9IGZhbHNlOwogICAgICAgIHRoaXMudG90YWxUb3VjaGVzKys7CgogICAgICAgIGlmICh0aGlzLmlzTW91c2UgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LmN1cnJlbnRQb2ludGVycysrOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudGFyZ2V0T2JqZWN0ICE9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QuX3RvdWNoZWRIYW5kbGVyKHRoaXMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIGJ5IHRoZSBJbnB1dCBNYW5hZ2VyLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludGVyI3VwZGF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5hY3RpdmUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5faG9sZFNlbnQgPT09IGZhbHNlICYmIHRoaXMuZHVyYXRpb24gPj0gdGhpcy5nYW1lLmlucHV0LmhvbGRSYXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuTU9VU0VfT1ZFUlJJREVTX1RPVUNIIHx8IHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0Lk1PVVNFX1RPVUNIX0NPTUJJTkUgfHwgKHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0LlRPVUNIX09WRVJSSURFU19NT1VTRSAmJiB0aGlzLmdhbWUuaW5wdXQuY3VycmVudFBvaW50ZXJzID09PSAwKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQub25Ib2xkLmRpc3BhdGNoKHRoaXMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuX2hvbGRTZW50ID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIFVwZGF0ZSB0aGUgZHJvcHBpbmdzIGhpc3RvcnkKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5yZWNvcmRQb2ludGVySGlzdG9yeSAmJiB0aGlzLmdhbWUudGltZS5ub3cgPj0gdGhpcy5fbmV4dERyb3ApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX25leHREcm9wID0gdGhpcy5nYW1lLnRpbWUubm93ICsgdGhpcy5nYW1lLmlucHV0LnJlY29yZFJhdGU7CgogICAgICAgICAgICAgICAgdGhpcy5faGlzdG9yeS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICB4OiB0aGlzLnBvc2l0aW9uLngsCiAgICAgICAgICAgICAgICAgICAgeTogdGhpcy5wb3NpdGlvbi55CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5faGlzdG9yeS5sZW5ndGggPiB0aGlzLmdhbWUuaW5wdXQucmVjb3JkTGltaXQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlzdG9yeS5zaGlmdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCB3aGVuIHRoZSBQb2ludGVyIGlzIG1vdmVkLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludGVyI21vdmUKICAgICogQHBhcmFtIHtNb3VzZUV2ZW50fFBvaW50ZXJFdmVudHxUb3VjaEV2ZW50fSBldmVudCAtIFRoZSBldmVudCBwYXNzZWQgdXAgZnJvbSB0aGUgaW5wdXQgaGFuZGxlci4KICAgICovCiAgICBtb3ZlOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5wb2xsTG9ja2VkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBldmVudC5idXR0b24gIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5idXR0b24gPSBldmVudC5idXR0b247CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNsaWVudFggPSBldmVudC5jbGllbnRYOwogICAgICAgIHRoaXMuY2xpZW50WSA9IGV2ZW50LmNsaWVudFk7CgogICAgICAgIHRoaXMucGFnZVggPSBldmVudC5wYWdlWDsKICAgICAgICB0aGlzLnBhZ2VZID0gZXZlbnQucGFnZVk7CgogICAgICAgIHRoaXMuc2NyZWVuWCA9IGV2ZW50LnNjcmVlblg7CiAgICAgICAgdGhpcy5zY3JlZW5ZID0gZXZlbnQuc2NyZWVuWTsKCiAgICAgICAgdGhpcy54ID0gKHRoaXMucGFnZVggLSB0aGlzLmdhbWUuc3RhZ2Uub2Zmc2V0LngpICogdGhpcy5nYW1lLmlucHV0LnNjYWxlLng7CiAgICAgICAgdGhpcy55ID0gKHRoaXMucGFnZVkgLSB0aGlzLmdhbWUuc3RhZ2Uub2Zmc2V0LnkpICogdGhpcy5nYW1lLmlucHV0LnNjYWxlLnk7CgogICAgICAgIHRoaXMucG9zaXRpb24uc2V0VG8odGhpcy54LCB0aGlzLnkpOwogICAgICAgIHRoaXMuY2lyY2xlLnggPSB0aGlzLng7CiAgICAgICAgdGhpcy5jaXJjbGUueSA9IHRoaXMueTsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0Lk1PVVNFX09WRVJSSURFU19UT1VDSCB8fCB0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9UT1VDSF9DT01CSU5FIHx8ICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5UT1VDSF9PVkVSUklERVNfTU9VU0UgJiYgdGhpcy5nYW1lLmlucHV0LmN1cnJlbnRQb2ludGVycyA9PT0gMCkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuYWN0aXZlUG9pbnRlciA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC54ID0gdGhpcy54OwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQueSA9IHRoaXMueTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnBvc2l0aW9uLnNldFRvKHRoaXMuZ2FtZS5pbnB1dC54LCB0aGlzLmdhbWUuaW5wdXQueSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5jaXJjbGUueCA9IHRoaXMuZ2FtZS5pbnB1dC54OwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuY2lyY2xlLnkgPSB0aGlzLmdhbWUuaW5wdXQueTsKICAgICAgICB9CgogICAgICAgIC8vICBJZiB0aGUgZ2FtZSBpcyBwYXVzZWQgd2UgZG9uJ3QgcHJvY2VzcyBhbnkgdGFyZ2V0IG9iamVjdHMgb3IgY2FsbGJhY2tzCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXVzZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQubW92ZUNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm1vdmVDYWxsYmFjay5jYWxsKHRoaXMuZ2FtZS5pbnB1dC5tb3ZlQ2FsbGJhY2tDb250ZXh0LCB0aGlzLCB0aGlzLngsIHRoaXMueSk7CiAgICAgICAgfQoKICAgICAgICAvLyAgRWFzeSBvdXQgaWYgd2UncmUgZHJhZ2dpbmcgc29tZXRoaW5nIGFuZCBpdCBzdGlsbCBleGlzdHMKICAgICAgICBpZiAodGhpcy50YXJnZXRPYmplY3QgIT09IG51bGwgJiYgdGhpcy50YXJnZXRPYmplY3QuaXNEcmFnZ2VkID09PSB0cnVlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0T2JqZWN0LnVwZGF0ZSh0aGlzKSA9PT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0ID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQoKICAgICAgICAvLyAgV29yayBvdXQgd2hpY2ggb2JqZWN0IGlzIG9uIHRoZSB0b3AKICAgICAgICB0aGlzLl9oaWdoZXN0UmVuZGVyT3JkZXJJRCA9IC0xOwogICAgICAgIHRoaXMuX2hpZ2hlc3RSZW5kZXJPYmplY3QgPSBudWxsOwogICAgICAgIHRoaXMuX2hpZ2hlc3RJbnB1dFByaW9yaXR5SUQgPSAtMTsKCiAgICAgICAgLy8gIEp1c3QgcnVuIHRocm91Z2ggdGhlIGxpbmtlZCBsaXN0CiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5pbnRlcmFjdGl2ZUl0ZW1zLnRvdGFsID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuZ2FtZS5pbnB1dC5pbnRlcmFjdGl2ZUl0ZW1zLm5leHQ7CgogICAgICAgICAgICBkbwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgSWYgdGhlIG9iamVjdCBpcyB1c2luZyBwaXhlbFBlcmZlY3QgY2hlY2tzLCBvciBoYXMgYSBoaWdoZXIgSW5wdXRNYW5hZ2VyLlByaW9yaXR5SUQgT1IgaWYgdGhlIHByaW9yaXR5IElEIGlzIHRoZSBzYW1lIGFzIHRoZSBjdXJyZW50IGhpZ2hlc3QgQU5EIGl0IGhhcyBhIGhpZ2hlciByZW5kZXJPcmRlcklELCB0aGVuIHNldCBpdCB0byB0aGUgdG9wCiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUucGl4ZWxQZXJmZWN0IHx8IGN1cnJlbnROb2RlLnByaW9yaXR5SUQgPiB0aGlzLl9oaWdoZXN0SW5wdXRQcmlvcml0eUlEIHx8IChjdXJyZW50Tm9kZS5wcmlvcml0eUlEID09IHRoaXMuX2hpZ2hlc3RJbnB1dFByaW9yaXR5SUQgJiYgY3VycmVudE5vZGUuc3ByaXRlLnJlbmRlck9yZGVySUQgPiB0aGlzLl9oaWdoZXN0UmVuZGVyT3JkZXJJRCkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmNoZWNrUG9pbnRlck92ZXIodGhpcykpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnSFJPIHNldCcsIGN1cnJlbnROb2RlLnNwcml0ZS5uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlnaGVzdFJlbmRlck9yZGVySUQgPSBjdXJyZW50Tm9kZS5zcHJpdGUucmVuZGVyT3JkZXJJRDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlnaGVzdElucHV0UHJpb3JpdHlJRCA9IGN1cnJlbnROb2RlLnByaW9yaXR5SUQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZ2hlc3RSZW5kZXJPYmplY3QgPSBjdXJyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLm5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnROb2RlICE9IG51bGwpCiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5faGlnaGVzdFJlbmRlck9iamVjdCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFRoZSBwb2ludGVyIGlzbid0IGN1cnJlbnRseSBvdmVyIGFueXRoaW5nLCBjaGVjayBpZiB3ZSd2ZSBnb3QgYSBsaW5nZXJpbmcgcHJldmlvdXMgdGFyZ2V0CiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldE9iamVjdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coIlRoZSBwb2ludGVyIGlzbid0IGN1cnJlbnRseSBvdmVyIGFueXRoaW5nLCBjaGVjayBpZiB3ZSd2ZSBnb3QgYSBsaW5nZXJpbmcgcHJldmlvdXMgdGFyZ2V0Iik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdC5fcG9pbnRlck91dEhhbmRsZXIodGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0T2JqZWN0ID09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBBbmQgbm93IHNldCB0aGUgbmV3IG9uZQogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ0FuZCBub3cgc2V0IHRoZSBuZXcgb25lJyk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdCA9IHRoaXMuX2hpZ2hlc3RSZW5kZXJPYmplY3Q7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWdoZXN0UmVuZGVyT2JqZWN0Ll9wb2ludGVyT3ZlckhhbmRsZXIodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgV2UndmUgZ290IGEgdGFyZ2V0IGZyb20gdGhlIGxhc3QgdXBkYXRlCiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiV2UndmUgZ290IGEgdGFyZ2V0IGZyb20gdGhlIGxhc3QgdXBkYXRlIik7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50YXJnZXRPYmplY3QgPT0gdGhpcy5faGlnaGVzdFJlbmRlck9iamVjdCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyAgU2FtZSB0YXJnZXQgYXMgYmVmb3JlLCBzbyB1cGRhdGUgaXQKICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiU2FtZSB0YXJnZXQgYXMgYmVmb3JlLCBzbyB1cGRhdGUgaXQiKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5faGlnaGVzdFJlbmRlck9iamVjdC51cGRhdGUodGhpcykgPT09IGZhbHNlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyAgVGhlIHRhcmdldCBoYXMgY2hhbmdlZCwgc28gdGVsbCB0aGUgb2xkIG9uZSB3ZSd2ZSBsZWZ0IGl0CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coIlRoZSB0YXJnZXQgaGFzIGNoYW5nZWQsIHNvIHRlbGwgdGhlIG9sZCBvbmUgd2UndmUgbGVmdCBpdCIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0Ll9wb2ludGVyT3V0SGFuZGxlcih0aGlzKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gIEFuZCBub3cgc2V0IHRoZSBuZXcgb25lCiAgICAgICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QgPSB0aGlzLl9oaWdoZXN0UmVuZGVyT2JqZWN0OwogICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0Ll9wb2ludGVyT3ZlckhhbmRsZXIodGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCB3aGVuIHRoZSBQb2ludGVyIGxlYXZlcyB0aGUgdGFyZ2V0IGFyZWEuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50ZXIjbGVhdmUKICAgICogQHBhcmFtIHtNb3VzZUV2ZW50fFBvaW50ZXJFdmVudHxUb3VjaEV2ZW50fSBldmVudCAtIFRoZSBldmVudCBwYXNzZWQgdXAgZnJvbSB0aGUgaW5wdXQgaGFuZGxlci4KICAgICovCiAgICBsZWF2ZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMud2l0aGluR2FtZSA9IGZhbHNlOwogICAgICAgIHRoaXMubW92ZShldmVudCk7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIHdoZW4gdGhlIFBvaW50ZXIgbGVhdmVzIHRoZSB0b3VjaHNjcmVlbi4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnRlciNzdG9wCiAgICAqIEBwYXJhbSB7TW91c2VFdmVudHxQb2ludGVyRXZlbnR8VG91Y2hFdmVudH0gZXZlbnQgLSBUaGUgZXZlbnQgcGFzc2VkIHVwIGZyb20gdGhlIGlucHV0IGhhbmRsZXIuCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLl9zdGF0ZVJlc2V0KQogICAgICAgIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy50aW1lVXAgPSB0aGlzLmdhbWUudGltZS5ub3c7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9PVkVSUklERVNfVE9VQ0ggfHwgdGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuTU9VU0VfVE9VQ0hfQ09NQklORSB8fCAodGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuVE9VQ0hfT1ZFUlJJREVTX01PVVNFICYmIHRoaXMuZ2FtZS5pbnB1dC5jdXJyZW50UG9pbnRlcnMgPT09IDApKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm9uVXAuZGlzcGF0Y2godGhpcywgZXZlbnQpOwoKICAgICAgICAgICAgLy8gIFdhcyBpdCBhIHRhcD8KICAgICAgICAgICAgaWYgKHRoaXMuZHVyYXRpb24gPj0gMCAmJiB0aGlzLmR1cmF0aW9uIDw9IHRoaXMuZ2FtZS5pbnB1dC50YXBSYXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgV2FzIGl0IGEgZG91YmxlLXRhcD8KICAgICAgICAgICAgICAgIGlmICh0aGlzLnRpbWVVcCAtIHRoaXMucHJldmlvdXNUYXBUaW1lIDwgdGhpcy5nYW1lLmlucHV0LmRvdWJsZVRhcFJhdGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gIFllcywgbGV0J3MgZGlzcGF0Y2ggdGhlIHNpZ25hbCB0aGVuIHdpdGggdGhlIDJuZCBwYXJhbWV0ZXIgc2V0IHRvIHRydWUKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQub25UYXAuZGlzcGF0Y2godGhpcywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gIFdhc24ndCBhIGRvdWJsZS10YXAsIHNvIGRpc3BhdGNoIGEgc2luZ2xlIHRhcCBzaWduYWwKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQub25UYXAuZGlzcGF0Y2godGhpcywgZmFsc2UpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMucHJldmlvdXNUYXBUaW1lID0gdGhpcy50aW1lVXA7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vICBNb3VzZSBpcyBhbHdheXMgYWN0aXZlCiAgICAgICAgaWYgKHRoaXMuaWQgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMud2l0aGluR2FtZSA9IGZhbHNlOwogICAgICAgIHRoaXMuaXNEb3duID0gZmFsc2U7CiAgICAgICAgdGhpcy5pc1VwID0gdHJ1ZTsKCiAgICAgICAgaWYgKHRoaXMuaXNNb3VzZSA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuY3VycmVudFBvaW50ZXJzLS07CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmludGVyYWN0aXZlSXRlbXMudG90YWwgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5nYW1lLmlucHV0LmludGVyYWN0aXZlSXRlbXMubmV4dDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRvCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5fcmVsZWFzZWRIYW5kbGVyKHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLm5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnROb2RlICE9IG51bGwpCiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy50YXJnZXRPYmplY3QpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdC5fcmVsZWFzZWRIYW5kbGVyKHRoaXMpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy50YXJnZXRPYmplY3QgPSBudWxsOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBQb2ludGVyIGlzIGNvbnNpZGVyZWQganVzdFByZXNzZWQgaWYgdGhlIHRpbWUgaXQgd2FzIHByZXNzZWQgb250byB0aGUgdG91Y2hzY3JlZW4gb3IgY2xpY2tlZCBpcyBsZXNzIHRoYW4ganVzdFByZXNzZWRSYXRlLgogICAgKiBOb3RlIHRoYXQgY2FsbGluZyBqdXN0UHJlc3NlZCBkb2Vzbid0IHJlc2V0IHRoZSBwcmVzc2VkIHN0YXR1cyBvZiB0aGUgUG9pbnRlciwgaXQgd2lsbCByZXR1cm4gYHRydWVgIGZvciBhcyBsb25nIGFzIHRoZSBkdXJhdGlvbiBpcyB2YWxpZC4KICAgICogSWYgeW91IHdpc2ggdG8gY2hlY2sgaWYgdGhlIFBvaW50ZXIgd2FzIHByZXNzZWQgZG93biBqdXN0IG9uY2UgdGhlbiBzZWUgdGhlIFNwcml0ZS5ldmVudHMub25JbnB1dERvd24gZXZlbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50ZXIjanVzdFByZXNzZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbl0gLSBUaGUgdGltZSB0byBjaGVjayBhZ2FpbnN0LiBJZiBub25lIGdpdmVuIGl0IHdpbGwgdXNlIElucHV0TWFuYWdlci5qdXN0UHJlc3NlZFJhdGUuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWYgdGhlIFBvaW50ZXIgd2FzIHByZXNzZWQgZG93biB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuLgogICAgKi8KICAgIGp1c3RQcmVzc2VkOiBmdW5jdGlvbiAoZHVyYXRpb24pIHsKCiAgICAgICAgZHVyYXRpb24gPSBkdXJhdGlvbiB8fCB0aGlzLmdhbWUuaW5wdXQuanVzdFByZXNzZWRSYXRlOwoKICAgICAgICByZXR1cm4gKHRoaXMuaXNEb3duID09PSB0cnVlICYmICh0aGlzLnRpbWVEb3duICsgZHVyYXRpb24pID4gdGhpcy5nYW1lLnRpbWUubm93KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgUG9pbnRlciBpcyBjb25zaWRlcmVkIGp1c3RSZWxlYXNlZCBpZiB0aGUgdGltZSBpdCBsZWZ0IHRoZSB0b3VjaHNjcmVlbiBpcyBsZXNzIHRoYW4ganVzdFJlbGVhc2VkUmF0ZS4KICAgICogTm90ZSB0aGF0IGNhbGxpbmcganVzdFJlbGVhc2VkIGRvZXNuJ3QgcmVzZXQgdGhlIHByZXNzZWQgc3RhdHVzIG9mIHRoZSBQb2ludGVyLCBpdCB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGFzIGxvbmcgYXMgdGhlIGR1cmF0aW9uIGlzIHZhbGlkLgogICAgKiBJZiB5b3Ugd2lzaCB0byBjaGVjayBpZiB0aGUgUG9pbnRlciB3YXMgcmVsZWFzZWQganVzdCBvbmNlIHRoZW4gc2VlIHRoZSBTcHJpdGUuZXZlbnRzLm9uSW5wdXRVcCBldmVudC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnRlciNqdXN0UmVsZWFzZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbl0gLSBUaGUgdGltZSB0byBjaGVjayBhZ2FpbnN0LiBJZiBub25lIGdpdmVuIGl0IHdpbGwgdXNlIElucHV0TWFuYWdlci5qdXN0UmVsZWFzZWRSYXRlLgogICAgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHRoZSBQb2ludGVyIHdhcyByZWxlYXNlZCB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuLgogICAgKi8KICAgIGp1c3RSZWxlYXNlZDogZnVuY3Rpb24gKGR1cmF0aW9uKSB7CgogICAgICAgIGR1cmF0aW9uID0gZHVyYXRpb24gfHwgdGhpcy5nYW1lLmlucHV0Lmp1c3RSZWxlYXNlZFJhdGU7CgogICAgICAgIHJldHVybiAodGhpcy5pc1VwID09PSB0cnVlICYmICh0aGlzLnRpbWVVcCArIGR1cmF0aW9uKSA+IHRoaXMuZ2FtZS50aW1lLm5vdyk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVzZXRzIHRoZSBQb2ludGVyIHByb3BlcnRpZXMuIENhbGxlZCBieSBJbnB1dE1hbmFnZXIucmVzZXQgd2hlbiB5b3UgcGVyZm9ybSBhIFN0YXRlIGNoYW5nZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnRlciNyZXNldAogICAgKi8KICAgIHJlc2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmlzTW91c2UgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuaWRlbnRpZmllciA9IG51bGw7CiAgICAgICAgdGhpcy5pc0Rvd24gPSBmYWxzZTsKICAgICAgICB0aGlzLmlzVXAgPSB0cnVlOwogICAgICAgIHRoaXMudG90YWxUb3VjaGVzID0gMDsKICAgICAgICB0aGlzLl9ob2xkU2VudCA9IGZhbHNlOwogICAgICAgIHRoaXMuX2hpc3RvcnkubGVuZ3RoID0gMDsKICAgICAgICB0aGlzLl9zdGF0ZVJlc2V0ID0gdHJ1ZTsKCiAgICAgICAgaWYgKHRoaXMudGFyZ2V0T2JqZWN0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QuX3JlbGVhc2VkSGFuZGxlcih0aGlzKTsKICAgICAgICB9CgogICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0ID0gbnVsbDsKCiAgICB9Cgp9OwoKUGhhc2VyLlBvaW50ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlBvaW50ZXI7CgovKioKKiBIb3cgbG9uZyB0aGUgUG9pbnRlciBoYXMgYmVlbiBkZXByZXNzZWQgb24gdGhlIHRvdWNoc2NyZWVuLiBJZiBub3QgY3VycmVudGx5IGRvd24gaXQgcmV0dXJucyAtMS4KKiBAbmFtZSBQaGFzZXIuUG9pbnRlciNkdXJhdGlvbgoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkdXJhdGlvbiAtIEhvdyBsb25nIHRoZSBQb2ludGVyIGhhcyBiZWVuIGRlcHJlc3NlZCBvbiB0aGUgdG91Y2hzY3JlZW4uIElmIG5vdCBjdXJyZW50bHkgZG93biBpdCByZXR1cm5zIC0xLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBvaW50ZXIucHJvdG90eXBlLCAiZHVyYXRpb24iLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmlzVXApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy50aW1lRG93bjsKCiAgICB9Cgp9KTsKCi8qKgoqIEdldHMgdGhlIFggdmFsdWUgb2YgdGhpcyBQb2ludGVyIGluIHdvcmxkIGNvb3JkaW5hdGVzIGJhc2VkIG9uIHRoZSB3b3JsZCBjYW1lcmEuCiogQG5hbWUgUGhhc2VyLlBvaW50ZXIjd29ybGRYCiogQHByb3BlcnR5IHtudW1iZXJ9IGR1cmF0aW9uIC0gVGhlIFggdmFsdWUgb2YgdGhpcyBQb2ludGVyIGluIHdvcmxkIGNvb3JkaW5hdGVzIGJhc2VkIG9uIHRoZSB3b3JsZCBjYW1lcmEuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUG9pbnRlci5wcm90b3R5cGUsICJ3b3JsZFgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiB0aGlzLmdhbWUud29ybGQuY2FtZXJhLnggKyB0aGlzLng7CgogICAgfQoKfSk7CgovKioKKiBHZXRzIHRoZSBZIHZhbHVlIG9mIHRoaXMgUG9pbnRlciBpbiB3b3JsZCBjb29yZGluYXRlcyBiYXNlZCBvbiB0aGUgd29ybGQgY2FtZXJhLgoqIEBuYW1lIFBoYXNlci5Qb2ludGVyI3dvcmxkWQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkdXJhdGlvbiAtIFRoZSBZIHZhbHVlIG9mIHRoaXMgUG9pbnRlciBpbiB3b3JsZCBjb29yZGluYXRlcyBiYXNlZCBvbiB0aGUgd29ybGQgY2FtZXJhLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBvaW50ZXIucHJvdG90eXBlLCAid29ybGRZIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLndvcmxkLmNhbWVyYS55ICsgdGhpcy55OwoKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLlRvdWNoIGhhbmRsZXMgdG91Y2ggZXZlbnRzIHdpdGggeW91ciBnYW1lLiBOb3RlOiBBbmRyb2lkIDIueCBvbmx5IHN1cHBvcnRzIDEgdG91Y2ggZXZlbnQgYXQgb25jZSwgbm8gbXVsdGktdG91Y2guCioKKiBAY2xhc3MgUGhhc2VyLlRvdWNoCiogQGNsYXNzZGVzYyBUaGUgVG91Y2ggY2xhc3MgaGFuZGxlcyB0b3VjaCBpbnRlcmFjdGlvbnMgd2l0aCB0aGUgZ2FtZSBhbmQgdGhlIHJlc3VsdGluZyBQb2ludGVyIG9iamVjdHMuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuVG91Y2ggPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZGlzYWJsZWQgLSBZb3UgY2FuIGRpc2FibGUgYWxsIFRvdWNoIGV2ZW50cyBieSBzZXR0aW5nIGRpc2FibGVkID0gdHJ1ZS4gV2hpbGUgc2V0IGFsbCBuZXcgdG91Y2ggZXZlbnRzIHdpbGwgYmUgaWdub3JlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICB0aGlzLmRpc2FibGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCB1bmRlciB3aGljaCBjYWxsYmFja3MgYXJlIGNhbGxlZC4KICAgICovCiAgICB0aGlzLmNhbGxiYWNrQ29udGV4dCA9IHRoaXMuZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gdG91Y2hTdGFydENhbGxiYWNrIC0gQSBjYWxsYmFjayB0aGF0IGNhbiBiZSBmaXJlZCBvbiBhIHRvdWNoU3RhcnQgZXZlbnQuCiAgICAqLwogICAgdGhpcy50b3VjaFN0YXJ0Q2FsbGJhY2sgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gdG91Y2hNb3ZlQ2FsbGJhY2sgLSBBIGNhbGxiYWNrIHRoYXQgY2FuIGJlIGZpcmVkIG9uIGEgdG91Y2hNb3ZlIGV2ZW50LgogICAgKi8KICAgIHRoaXMudG91Y2hNb3ZlQ2FsbGJhY2sgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gdG91Y2hFbmRDYWxsYmFjayAtIEEgY2FsbGJhY2sgdGhhdCBjYW4gYmUgZmlyZWQgb24gYSB0b3VjaEVuZCBldmVudC4KICAgICovCiAgICB0aGlzLnRvdWNoRW5kQ2FsbGJhY2sgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gdG91Y2hFbnRlckNhbGxiYWNrIC0gQSBjYWxsYmFjayB0aGF0IGNhbiBiZSBmaXJlZCBvbiBhIHRvdWNoRW50ZXIgZXZlbnQuCiAgICAqLwogICAgdGhpcy50b3VjaEVudGVyQ2FsbGJhY2sgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gdG91Y2hMZWF2ZUNhbGxiYWNrIC0gQSBjYWxsYmFjayB0aGF0IGNhbiBiZSBmaXJlZCBvbiBhIHRvdWNoTGVhdmUgZXZlbnQuCiAgICAqLwogICAgdGhpcy50b3VjaExlYXZlQ2FsbGJhY2sgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gdG91Y2hDYW5jZWxDYWxsYmFjayAtIEEgY2FsbGJhY2sgdGhhdCBjYW4gYmUgZmlyZWQgb24gYSB0b3VjaENhbmNlbCBldmVudC4KICAgICovCiAgICB0aGlzLnRvdWNoQ2FuY2VsQ2FsbGJhY2sgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBwcmV2ZW50RGVmYXVsdCAtIElmIHRydWUgdGhlIFRvdWNoRXZlbnQgd2lsbCBoYXZlIHByZXZlbnQuZGVmYXVsdCBjYWxsZWQgb24gaXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wcmV2ZW50RGVmYXVsdCA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7VG91Y2hFdmVudH0gZXZlbnQgLSBUaGUgYnJvd3NlciB0b3VjaCBET00gZXZlbnQuIFdpbGwgYmUgc2V0IHRvIG51bGwgaWYgbm8gdG91Y2ggZXZlbnQgaGFzIGV2ZXIgYmVlbiByZWNlaXZlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmV2ZW50ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uVG91Y2hTdGFydCAtIEludGVybmFsIGV2ZW50IGhhbmRsZXIgcmVmZXJlbmNlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uVG91Y2hTdGFydCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vblRvdWNoTW92ZSAtIEludGVybmFsIGV2ZW50IGhhbmRsZXIgcmVmZXJlbmNlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uVG91Y2hNb3ZlID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uVG91Y2hFbmQgLSBJbnRlcm5hbCBldmVudCBoYW5kbGVyIHJlZmVyZW5jZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vblRvdWNoRW5kID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uVG91Y2hFbnRlciAtIEludGVybmFsIGV2ZW50IGhhbmRsZXIgcmVmZXJlbmNlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uVG91Y2hFbnRlciA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vblRvdWNoTGVhdmUgLSBJbnRlcm5hbCBldmVudCBoYW5kbGVyIHJlZmVyZW5jZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vblRvdWNoTGVhdmUgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25Ub3VjaENhbmNlbCAtIEludGVybmFsIGV2ZW50IGhhbmRsZXIgcmVmZXJlbmNlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uVG91Y2hDYW5jZWwgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25Ub3VjaE1vdmUgLSBJbnRlcm5hbCBldmVudCBoYW5kbGVyIHJlZmVyZW5jZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vblRvdWNoTW92ZSA9IG51bGw7Cgp9OwoKUGhhc2VyLlRvdWNoLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogU3RhcnRzIHRoZSBldmVudCBsaXN0ZW5lcnMgcnVubmluZy4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjc3RhcnQKICAgICovCiAgICBzdGFydDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS50b3VjaCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uVG91Y2hTdGFydCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uVG91Y2hTdGFydChldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9vblRvdWNoTW92ZSA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uVG91Y2hNb3ZlKGV2ZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuX29uVG91Y2hFbmQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblRvdWNoRW5kKGV2ZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuX29uVG91Y2hFbnRlciA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uVG91Y2hFbnRlcihldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9vblRvdWNoTGVhdmUgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblRvdWNoTGVhdmUoZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5fb25Ub3VjaENhbmNlbCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uVG91Y2hDYW5jZWwoZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHRoaXMuX29uVG91Y2hTdGFydCwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLl9vblRvdWNoTW92ZSwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRoaXMuX29uVG91Y2hFbmQsIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbnRlcicsIHRoaXMuX29uVG91Y2hFbnRlciwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGxlYXZlJywgdGhpcy5fb25Ub3VjaExlYXZlLCBmYWxzZSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgdGhpcy5fb25Ub3VjaENhbmNlbCwgZmFsc2UpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDb25zdW1lcyBhbGwgdG91Y2htb3ZlIGV2ZW50cyBvbiB0aGUgZG9jdW1lbnQgKG9ubHkgZW5hYmxlIHRoaXMgaWYgeW91IGtub3cgeW91IG5lZWQgaXQhKS4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjY29uc3VtZVRvdWNoTW92ZQogICAgKi8KICAgIGNvbnN1bWVEb2N1bWVudFRvdWNoZXM6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fZG9jdW1lbnRUb3VjaE1vdmUgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9OwoKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLl9kb2N1bWVudFRvdWNoTW92ZSwgZmFsc2UpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBpbnRlcm5hbCBtZXRob2QgdGhhdCBoYW5kbGVzIHRoZSB0b3VjaHN0YXJ0IGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRvdWNoI29uVG91Y2hTdGFydAogICAgKiBAcGFyYW0ge1RvdWNoRXZlbnR9IGV2ZW50IC0gVGhlIG5hdGl2ZSBldmVudCBmcm9tIHRoZSBicm93c2VyLiBUaGlzIGdldHMgc3RvcmVkIGluIFRvdWNoLmV2ZW50LgogICAgKi8KICAgIG9uVG91Y2hTdGFydDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuZXZlbnQgPSBldmVudDsKCiAgICAgICAgaWYgKHRoaXMudG91Y2hTdGFydENhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50b3VjaFN0YXJ0Q2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucHJldmVudERlZmF1bHQpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgLy8gIGV2ZW50LnRhcmdldFRvdWNoZXMgPSBsaXN0IG9mIGFsbCB0b3VjaGVzIG9uIHRoZSBUQVJHRVQgRUxFTUVOVCAoaS5lLiBnYW1lIGRvbSBlbGVtZW50KQogICAgICAgIC8vICBldmVudC50b3VjaGVzID0gbGlzdCBvZiBhbGwgdG91Y2hlcyBvbiB0aGUgRU5USVJFIERPQ1VNRU5ULCBub3QganVzdCB0aGUgdGFyZ2V0IGVsZW1lbnQKICAgICAgICAvLyAgZXZlbnQuY2hhbmdlZFRvdWNoZXMgPSB0aGUgdG91Y2hlcyB0aGF0IENIQU5HRUQgaW4gdGhpcyBldmVudCwgbm90IHRoZSB0b3RhbCBudW1iZXIgb2YgdGhlbQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc3RhcnRQb2ludGVyKGV2ZW50LmNoYW5nZWRUb3VjaGVzW2ldKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVG91Y2ggY2FuY2VsIC0gdG91Y2hlcyB0aGF0IHdlcmUgZGlzcnVwdGVkIChwZXJoYXBzIGJ5IG1vdmluZyBpbnRvIGEgcGx1Z2luIG9yIGJyb3dzZXIgY2hyb21lKS4KICAgICogT2NjdXJzIGZvciBleGFtcGxlIG9uIGlPUyB3aGVuIHlvdSBwdXQgZG93biA0IGZpbmdlcnMgYW5kIHRoZSBhcHAgc2VsZWN0b3IgVUkgYXBwZWFycy4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjb25Ub3VjaENhbmNlbAogICAgKiBAcGFyYW0ge1RvdWNoRXZlbnR9IGV2ZW50IC0gVGhlIG5hdGl2ZSBldmVudCBmcm9tIHRoZSBicm93c2VyLiBUaGlzIGdldHMgc3RvcmVkIGluIFRvdWNoLmV2ZW50LgogICAgKi8KICAgIG9uVG91Y2hDYW5jZWw6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7CgogICAgICAgIGlmICh0aGlzLnRvdWNoQ2FuY2VsQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRvdWNoQ2FuY2VsQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucHJldmVudERlZmF1bHQpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgLy8gIFRvdWNoIGNhbmNlbCAtIHRvdWNoZXMgdGhhdCB3ZXJlIGRpc3J1cHRlZCAocGVyaGFwcyBieSBtb3ZpbmcgaW50byBhIHBsdWdpbiBvciBicm93c2VyIGNocm9tZSkKICAgICAgICAvLyAgaHR0cDovL3d3dy53My5vcmcvVFIvdG91Y2gtZXZlbnRzLyNkZm4tdG91Y2hjYW5jZWwKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50LmNoYW5nZWRUb3VjaGVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnN0b3BQb2ludGVyKGV2ZW50LmNoYW5nZWRUb3VjaGVzW2ldKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogRm9yIHRvdWNoIGVudGVyIGFuZCBsZWF2ZSBpdHMgYSBsaXN0IG9mIHRoZSB0b3VjaCBwb2ludHMgdGhhdCBoYXZlIGVudGVyZWQgb3IgbGVmdCB0aGUgdGFyZ2V0LgogICAgKiBEb2Vzbid0IGFwcGVhciB0byBiZSBzdXBwb3J0ZWQgYnkgbW9zdCBicm93c2VycyBvbiBhIGNhbnZhcyBlbGVtZW50IHlldC4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjb25Ub3VjaEVudGVyCiAgICAqIEBwYXJhbSB7VG91Y2hFdmVudH0gZXZlbnQgLSBUaGUgbmF0aXZlIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuIFRoaXMgZ2V0cyBzdG9yZWQgaW4gVG91Y2guZXZlbnQuCiAgICAqLwogICAgb25Ub3VjaEVudGVyOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5ldmVudCA9IGV2ZW50OwoKICAgICAgICBpZiAodGhpcy50b3VjaEVudGVyQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRvdWNoRW50ZXJDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wcmV2ZW50RGVmYXVsdCkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEZvciB0b3VjaCBlbnRlciBhbmQgbGVhdmUgaXRzIGEgbGlzdCBvZiB0aGUgdG91Y2ggcG9pbnRzIHRoYXQgaGF2ZSBlbnRlcmVkIG9yIGxlZnQgdGhlIHRhcmdldC4KICAgICogRG9lc24ndCBhcHBlYXIgdG8gYmUgc3VwcG9ydGVkIGJ5IG1vc3QgYnJvd3NlcnMgb24gYSBjYW52YXMgZWxlbWVudCB5ZXQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRvdWNoI29uVG91Y2hMZWF2ZQogICAgKiBAcGFyYW0ge1RvdWNoRXZlbnR9IGV2ZW50IC0gVGhlIG5hdGl2ZSBldmVudCBmcm9tIHRoZSBicm93c2VyLiBUaGlzIGdldHMgc3RvcmVkIGluIFRvdWNoLmV2ZW50LgogICAgKi8KICAgIG9uVG91Y2hMZWF2ZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuZXZlbnQgPSBldmVudDsKCiAgICAgICAgaWYgKHRoaXMudG91Y2hMZWF2ZUNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50b3VjaExlYXZlQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucHJldmVudERlZmF1bHQpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgaGFuZGxlciBmb3IgdGhlIHRvdWNobW92ZSBldmVudHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRvdWNoI29uVG91Y2hNb3ZlCiAgICAqIEBwYXJhbSB7VG91Y2hFdmVudH0gZXZlbnQgLSBUaGUgbmF0aXZlIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuIFRoaXMgZ2V0cyBzdG9yZWQgaW4gVG91Y2guZXZlbnQuCiAgICAqLwogICAgb25Ub3VjaE1vdmU6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7CgogICAgICAgIGlmICh0aGlzLnRvdWNoTW92ZUNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50b3VjaE1vdmVDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wcmV2ZW50RGVmYXVsdCkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50LmNoYW5nZWRUb3VjaGVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnVwZGF0ZVBvaW50ZXIoZXZlbnQuY2hhbmdlZFRvdWNoZXNbaV0pOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgaGFuZGxlciBmb3IgdGhlIHRvdWNoZW5kIGV2ZW50cy4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjb25Ub3VjaEVuZAogICAgKiBAcGFyYW0ge1RvdWNoRXZlbnR9IGV2ZW50IC0gVGhlIG5hdGl2ZSBldmVudCBmcm9tIHRoZSBicm93c2VyLiBUaGlzIGdldHMgc3RvcmVkIGluIFRvdWNoLmV2ZW50LgogICAgKi8KICAgIG9uVG91Y2hFbmQ6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7CgogICAgICAgIGlmICh0aGlzLnRvdWNoRW5kQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRvdWNoRW5kQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucHJldmVudERlZmF1bHQpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgLy8gIEZvciB0b3VjaCBlbmQgaXRzIGEgbGlzdCBvZiB0aGUgdG91Y2ggcG9pbnRzIHRoYXQgaGF2ZSBiZWVuIHJlbW92ZWQgZnJvbSB0aGUgc3VyZmFjZQogICAgICAgIC8vICBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS9Ub3VjaExpc3QKICAgICAgICAvLyAgZXZlbnQuY2hhbmdlZFRvdWNoZXMgPSB0aGUgdG91Y2hlcyB0aGF0IENIQU5HRUQgaW4gdGhpcyBldmVudCwgbm90IHRoZSB0b3RhbCBudW1iZXIgb2YgdGhlbQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc3RvcFBvaW50ZXIoZXZlbnQuY2hhbmdlZFRvdWNoZXNbaV0pOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wIHRoZSBldmVudCBsaXN0ZW5lcnMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRvdWNoI3N0b3AKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLnRvdWNoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgdGhpcy5fb25Ub3VjaFN0YXJ0KTsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLl9vblRvdWNoTW92ZSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLl9vblRvdWNoRW5kKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVudGVyJywgdGhpcy5fb25Ub3VjaEVudGVyKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGxlYXZlJywgdGhpcy5fb25Ub3VjaExlYXZlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIHRoaXMuX29uVG91Y2hDYW5jZWwpOwogICAgICAgIH0KCiAgICB9Cgp9OwoKUGhhc2VyLlRvdWNoLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5Ub3VjaDsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBJbnB1dCBIYW5kbGVyIGlzIGJvdW5kIHRvIGEgc3BlY2lmaWMgU3ByaXRlIGFuZCBpcyByZXNwb25zaWJsZSBmb3IgbWFuYWdpbmcgYWxsIElucHV0IGV2ZW50cyBvbiB0aGF0IFNwcml0ZS4KKiBAY2xhc3MgUGhhc2VyLklucHV0SGFuZGxlcgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gVGhlIFNwcml0ZSBvYmplY3QgdG8gd2hpY2ggdGhpcyBJbnB1dCBIYW5kbGVyIGJlbG9uZ3MuCiovClBoYXNlci5JbnB1dEhhbmRsZXIgPSBmdW5jdGlvbiAoc3ByaXRlKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gVGhlIFNwcml0ZSBvYmplY3QgdG8gd2hpY2ggdGhpcyBJbnB1dCBIYW5kbGVyIGJlbG9uZ3MuCiAgICAqLwogICAgdGhpcy5zcHJpdGUgPSBzcHJpdGU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4gCiAgICAqLwogICAgdGhpcy5nYW1lID0gc3ByaXRlLmdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZW5hYmxlZCAtIElmIGVuYWJsZWQgdGhlIElucHV0IEhhbmRsZXIgd2lsbCBwcm9jZXNzIGlucHV0IHJlcXVlc3RzIGFuZCBtb25pdG9yIHBvaW50ZXIgYWN0aXZpdHkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5lbmFibGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwcmlvcml0eUlEIC0gVGhlIFByaW9yaXR5SUQgY29udHJvbHMgd2hpY2ggU3ByaXRlIHJlY2VpdmVzIGFuIElucHV0IGV2ZW50IGZpcnN0IGlmIHRoZXkgc2hvdWxkIG92ZXJsYXAuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wcmlvcml0eUlEID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdXNlSGFuZEN1cnNvciAtIE9uIGEgZGVza3RvcCBicm93c2VyIHlvdSBjYW4gc2V0IHRoZSAnaGFuZCcgY3Vyc29yIHRvIGFwcGVhciB3aGVuIG1vdmluZyBvdmVyIHRoZSBTcHJpdGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy51c2VIYW5kQ3Vyc29yID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzRHJhZ2dlZCAtIHRydWUgaWYgdGhlIFNwcml0ZSBpcyBiZWluZyBjdXJyZW50bHkgZHJhZ2dlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzRHJhZ2dlZCA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhbGxvd0hvcml6b250YWxEcmFnIC0gQ29udHJvbHMgaWYgdGhlIFNwcml0ZSBpcyBhbGxvd2VkIHRvIGJlIGRyYWdnZWQgaG9yaXpvbnRhbGx5LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYWxsb3dIb3Jpem9udGFsRHJhZyA9IHRydWU7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsbG93VmVydGljYWxEcmFnIC0gQ29udHJvbHMgaWYgdGhlIFNwcml0ZSBpcyBhbGxvd2VkIHRvIGJlIGRyYWdnZWQgdmVydGljYWxseS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFsbG93VmVydGljYWxEcmFnID0gdHJ1ZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYnJpbmdUb1RvcCAtIElmIHRydWUgd2hlbiB0aGlzIFNwcml0ZSBpcyBjbGlja2VkIG9yIGRyYWdnZWQgaXQgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIGJvdWdodCB0byB0aGUgdG9wIG9mIHRoZSBHcm91cCBpdCBpcyB3aXRoaW4uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5icmluZ1RvVG9wID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBzbmFwT2Zmc2V0IC0gQSBQb2ludCBvYmplY3QgdGhhdCBjb250YWlucyBieSBob3cgZmFyIHRoZSBTcHJpdGUgc25hcCBpcyBvZmZzZXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zbmFwT2Zmc2V0ID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gc25hcE9uRHJhZyAtIFdoZW4gdGhlIFNwcml0ZSBpcyBkcmFnZ2VkIHRoaXMgY29udHJvbHMgaWYgdGhlIGNlbnRlciBvZiB0aGUgU3ByaXRlIHdpbGwgc25hcCB0byB0aGUgcG9pbnRlciBvbiBkcmFnIG9yIG5vdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNuYXBPbkRyYWcgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gc25hcE9uUmVsZWFzZSAtIFdoZW4gdGhlIFNwcml0ZSBpcyBkcmFnZ2VkIHRoaXMgY29udHJvbHMgaWYgdGhlIFNwcml0ZSB3aWxsIGJlIHNuYXBwZWQgb24gcmVsZWFzZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNuYXBPblJlbGVhc2UgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzbmFwWCAtIFdoZW4gYSBTcHJpdGUgaGFzIHNuYXBwaW5nIGVuYWJsZWQgdGhpcyBob2xkcyB0aGUgd2lkdGggb2YgdGhlIHNuYXAgZ3JpZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNuYXBYID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzbmFwWSAtIFdoZW4gYSBTcHJpdGUgaGFzIHNuYXBwaW5nIGVuYWJsZWQgdGhpcyBob2xkcyB0aGUgaGVpZ2h0IG9mIHRoZSBzbmFwIGdyaWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zbmFwWSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzbmFwT2Zmc2V0WCAtIFRoaXMgZGVmaW5lcyB0aGUgdG9wLWxlZnQgWCBjb29yZGluYXRlIG9mIHRoZSBzbmFwIGdyaWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zbmFwT2Zmc2V0WCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc25hcE9mZnNldFkgLSBUaGlzIGRlZmluZXMgdGhlIHRvcC1sZWZ0IFkgY29vcmRpbmF0ZSBvZiB0aGUgc25hcCBncmlkLi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNuYXBPZmZzZXRZID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBpeGVsUGVyZmVjdCAtIFNob3VsZCB3ZSB1c2UgcGl4ZWwgcGVyZmVjdCBoaXQgZGV0ZWN0aW9uPyBXYXJuaW5nOiBleHBlbnNpdmUuIE9ubHkgZW5hYmxlIGlmIHlvdSByZWFsbHkgbmVlZCBpdCEKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBpeGVsUGVyZmVjdCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGl4ZWxQZXJmZWN0QWxwaGEgLSBUaGUgYWxwaGEgdG9sZXJhbmNlIHRocmVzaG9sZC4gSWYgdGhlIGFscGhhIHZhbHVlIG9mIHRoZSBwaXhlbCBtYXRjaGVzIG9yIGlzIGFib3ZlIHRoaXMgdmFsdWUsIGl0J3MgY29uc2lkZXJlZCBhIGhpdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBpeGVsUGVyZmVjdEFscGhhID0gMjU1OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRyYWdnYWJsZSAtIElzIHRoaXMgc3ByaXRlIGFsbG93ZWQgdG8gYmUgZHJhZ2dlZCBieSB0aGUgbW91c2U/IHRydWUgPSB5ZXMsIGZhbHNlID0gbm8KICAgICogQGRlZmF1bHQgCiAgICAqLwogICAgdGhpcy5kcmFnZ2FibGUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSBib3VuZHNSZWN0IC0gQSByZWdpb24gb2YgdGhlIGdhbWUgd29ybGQgd2l0aGluIHdoaWNoIHRoZSBzcHJpdGUgaXMgcmVzdHJpY3RlZCBkdXJpbmcgZHJhZy4KICAgICogQGRlZmF1bHQgCiAgICAqLwogICAgdGhpcy5ib3VuZHNSZWN0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU3ByaXRlfSBib3VuZHNTcHJpdGUgLSBBIFNwcml0ZSB0aGUgYm91bmRzIG9mIHdoaWNoIHRoaXMgc3ByaXRlIGlzIHJlc3RyaWN0ZWQgZHVyaW5nIGRyYWcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5ib3VuZHNTcHJpdGUgPSBudWxsOwoKICAgIC8qKgogICAgKiBJZiB0aGlzIG9iamVjdCBpcyBzZXQgdG8gY29uc3VtZSB0aGUgcG9pbnRlciBldmVudCB0aGVuIGl0IHdpbGwgc3RvcCBhbGwgcHJvcG9nYXRpb24gZnJvbSB0aGlzIG9iamVjdCBvbi4KICAgICogRm9yIGV4YW1wbGUgaWYgeW91IGhhZCBhIHN0YWNrIG9mIDYgc3ByaXRlcyB3aXRoIHRoZSBzYW1lIHByaW9yaXR5IElEcyBhbmQgb25lIGNvbnN1bWVkIHRoZSBldmVudCwgbm9uZSBvZiB0aGUgb3RoZXJzIHdvdWxkIHJlY2VpdmUgaXQuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29uc3VtZVBvaW50ZXJFdmVudAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29uc3VtZVBvaW50ZXJFdmVudCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gX3RlbXBQb2ludCAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3RlbXBQb2ludCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICB0aGlzLl9wb2ludGVyRGF0YSA9IFtdOwoKICAgIHRoaXMuX3BvaW50ZXJEYXRhLnB1c2goewogICAgICAgIGlkOiAwLAogICAgICAgIHg6IDAsCiAgICAgICAgeTogMCwKICAgICAgICBpc0Rvd246IGZhbHNlLAogICAgICAgIGlzVXA6IGZhbHNlLAogICAgICAgIGlzT3ZlcjogZmFsc2UsCiAgICAgICAgaXNPdXQ6IGZhbHNlLAogICAgICAgIHRpbWVPdmVyOiAwLAogICAgICAgIHRpbWVPdXQ6IDAsCiAgICAgICAgdGltZURvd246IDAsCiAgICAgICAgdGltZVVwOiAwLAogICAgICAgIGRvd25EdXJhdGlvbjogMCwKICAgICAgICBpc0RyYWdnZWQ6IGZhbHNlCiAgICB9KTsKCn07CgpQaGFzZXIuSW5wdXRIYW5kbGVyLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogU3RhcnRzIHRoZSBJbnB1dCBIYW5kbGVyIHJ1bm5pbmcuIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgd2hlbiB5b3UgZW5hYmxlIGlucHV0IG9uIGEgU3ByaXRlLCBvciBjYW4gYmUgY2FsbGVkIGRpcmVjdGx5IGlmIHlvdSBuZWVkIHRvIHNldCBhIHNwZWNpZmljIHByaW9yaXR5LgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjc3RhcnQKICAgICogQHBhcmFtIHtudW1iZXJ9IHByaW9yaXR5IC0gSGlnaGVyIHByaW9yaXR5IHNwcml0ZXMgdGFrZSBjbGljayBwcmlvcml0eSBvdmVyIGxvdy1wcmlvcml0eSBzcHJpdGVzIHdoZW4gdGhleSBhcmUgc3RhY2tlZCBvbi10b3Agb2YgZWFjaCBvdGhlci4KICAgICogQHBhcmFtIHtib29sZWFufSB1c2VIYW5kQ3Vyc29yIC0gSWYgdHJ1ZSB0aGUgU3ByaXRlIHdpbGwgc2hvdyB0aGUgaGFuZCBjdXJzb3Igb24gbW91c2Utb3ZlciAoZG9lc24ndCBhcHBseSB0byBtb2JpbGUgYnJvd3NlcnMpCiAgICAqIEByZXR1cm4ge1BoYXNlci5TcHJpdGV9IFRoZSBTcHJpdGUgb2JqZWN0IHRvIHdoaWNoIHRoZSBJbnB1dCBIYW5kbGVyIGlzIGJvdW5kLgogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAocHJpb3JpdHksIHVzZUhhbmRDdXJzb3IpIHsKCiAgICAgICAgcHJpb3JpdHkgPSBwcmlvcml0eSB8fCAwOwogICAgICAgIGlmICh0eXBlb2YgdXNlSGFuZEN1cnNvciA9PSAndW5kZWZpbmVkJykgeyB1c2VIYW5kQ3Vyc29yID0gZmFsc2U7IH0KCiAgICAgICAgLy8gIFR1cm5pbmcgb24KICAgICAgICBpZiAodGhpcy5lbmFibGVkID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBSZWdpc3RlciwgZXRjCiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5pbnRlcmFjdGl2ZUl0ZW1zLmFkZCh0aGlzKTsKICAgICAgICAgICAgdGhpcy51c2VIYW5kQ3Vyc29yID0gdXNlSGFuZEN1cnNvcjsKICAgICAgICAgICAgdGhpcy5wcmlvcml0eUlEID0gcHJpb3JpdHk7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDEwOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW2ldID0gewogICAgICAgICAgICAgICAgICAgIGlkOiBpLAogICAgICAgICAgICAgICAgICAgIHg6IDAsCiAgICAgICAgICAgICAgICAgICAgeTogMCwKICAgICAgICAgICAgICAgICAgICBpc0Rvd246IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGlzVXA6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGlzT3ZlcjogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgaXNPdXQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIHRpbWVPdmVyOiAwLAogICAgICAgICAgICAgICAgICAgIHRpbWVPdXQ6IDAsCiAgICAgICAgICAgICAgICAgICAgdGltZURvd246IDAsCiAgICAgICAgICAgICAgICAgICAgdGltZVVwOiAwLAogICAgICAgICAgICAgICAgICAgIGRvd25EdXJhdGlvbjogMCwKICAgICAgICAgICAgICAgICAgICBpc0RyYWdnZWQ6IGZhbHNlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnNuYXBPZmZzZXQgPSBuZXcgUGhhc2VyLlBvaW50KCk7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IHRydWU7CgogICAgICAgICAgICAvLyAgQ3JlYXRlIHRoZSBzaWduYWxzIHRoZSBJbnB1dCBjb21wb25lbnQgd2lsbCBlbWl0CiAgICAgICAgICAgIGlmICh0aGlzLnNwcml0ZS5ldmVudHMgJiYgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXRPdmVyID09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0T3ZlciA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dE91dCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dERvd24gPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXRVcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25EcmFnU3RhcnQgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uRHJhZ1N0b3AgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5zcHJpdGU7CgogICAgfSwKCiAgICAvKioKICAgICogUmVzZXRzIHRoZSBJbnB1dCBIYW5kbGVyIGFuZCBkaXNhYmxlcyBpdC4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3Jlc2V0CiAgICAqLwogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5lbmFibGVkID0gZmFsc2U7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTA7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW2ldID0gewogICAgICAgICAgICAgICAgaWQ6IGksCiAgICAgICAgICAgICAgICB4OiAwLAogICAgICAgICAgICAgICAgeTogMCwKICAgICAgICAgICAgICAgIGlzRG93bjogZmFsc2UsCiAgICAgICAgICAgICAgICBpc1VwOiBmYWxzZSwKICAgICAgICAgICAgICAgIGlzT3ZlcjogZmFsc2UsCiAgICAgICAgICAgICAgICBpc091dDogZmFsc2UsCiAgICAgICAgICAgICAgICB0aW1lT3ZlcjogMCwKICAgICAgICAgICAgICAgIHRpbWVPdXQ6IDAsCiAgICAgICAgICAgICAgICB0aW1lRG93bjogMCwKICAgICAgICAgICAgICAgIHRpbWVVcDogMCwKICAgICAgICAgICAgICAgIGRvd25EdXJhdGlvbjogMCwKICAgICAgICAgICAgICAgIGlzRHJhZ2dlZDogZmFsc2UKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wcyB0aGUgSW5wdXQgSGFuZGxlciBmcm9tIHJ1bm5pbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNzdG9wCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICAvLyAgVHVybmluZyBvZmYKICAgICAgICBpZiAodGhpcy5lbmFibGVkID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIERlLXJlZ2lzdGVyLCBldGMKICAgICAgICAgICAgdGhpcy5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5pbnRlcmFjdGl2ZUl0ZW1zLnJlbW92ZSh0aGlzKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2xlYW4gdXAgbWVtb3J5LgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuZW5hYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwoKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LmludGVyYWN0aXZlSXRlbXMucmVtb3ZlKHRoaXMpOwoKICAgICAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgICAgICAgICB0aGlzLnNwcml0ZSA9IG51bGw7CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgSW5wdXQgcG9pbnRlciwgcmVsYXRpdmUgdG8gdGhlIHRvcC1sZWZ0IG9mIHRoZSBwYXJlbnQgU3ByaXRlLgogICAgKiBUaGlzIHZhbHVlIGlzIG9ubHkgc2V0IHdoZW4gdGhlIHBvaW50ZXIgaXMgb3ZlciB0aGlzIFNwcml0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJYCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBJbnB1dCBwb2ludGVyLgogICAgKi8KICAgIHBvaW50ZXJYOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0ueDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBJbnB1dCBwb2ludGVyLCByZWxhdGl2ZSB0byB0aGUgdG9wLWxlZnQgb2YgdGhlIHBhcmVudCBTcHJpdGUKICAgICogVGhpcyB2YWx1ZSBpcyBvbmx5IHNldCB3aGVuIHRoZSBwb2ludGVyIGlzIG92ZXIgdGhpcyBTcHJpdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyWQogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgSW5wdXQgcG9pbnRlci4KICAgICovCiAgICBwb2ludGVyWTogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLnk7CgogICAgfSwKCiAgICAvKioKICAgICogSWYgdGhlIFBvaW50ZXIgaXMgdG91Y2hpbmcgdGhlIHRvdWNoc2NyZWVuLCBvciB0aGUgbW91c2UgYnV0dG9uIGlzIGhlbGQgZG93biwgaXNEb3duIGlzIHNldCB0byB0cnVlLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlckRvd24KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIHBvaW50ZXJEb3duOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0uaXNEb3duOwoKICAgIH0sCgogICAgLyoqCiAgICAqIElmIHRoZSBQb2ludGVyIGlzIG5vdCB0b3VjaGluZyB0aGUgdG91Y2hzY3JlZW4sIG9yIHRoZSBtb3VzZSBidXR0b24gaXMgdXAsIGlzVXAgaXMgc2V0IHRvIHRydWUKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJVcAogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAgcG9pbnRlclVwOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0uaXNVcDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIHRpbWVzdGFtcCByZXByZXNlbnRpbmcgd2hlbiB0aGUgUG9pbnRlciBmaXJzdCB0b3VjaGVkIHRoZSB0b3VjaHNjcmVlbi4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJUaW1lRG93bgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBwb2ludGVyVGltZURvd246IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lRG93bjsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIHRpbWVzdGFtcCByZXByZXNlbnRpbmcgd2hlbiB0aGUgUG9pbnRlciBsZWZ0IHRoZSB0b3VjaHNjcmVlbi4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJUaW1lVXAKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgcG9pbnRlclRpbWVVcDogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLnRpbWVVcDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJcyB0aGUgUG9pbnRlciBvdmVyIHRoaXMgU3ByaXRlPwogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlck92ZXIKICAgICogQHBhcmFtIHtudW1iZXJ9IFtpbmRleF0gLSBUaGUgSUQgbnVtYmVyIG9mIGEgUG9pbnRlciB0byBjaGVjay4gSWYgeW91IGRvbid0IHByb3ZpZGUgYSBudW1iZXIgaXQgd2lsbCBjaGVjayBhbGwgUG9pbnRlcnMuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIHBvaW50ZXIgKGlmIGEgaW5kZXggd2FzIGdpdmVuLCBvciBhbnkgcG9pbnRlciBpZiBub3QpIGlzIG92ZXIgdGhpcyBvYmplY3QuCiAgICAqLwogICAgcG9pbnRlck92ZXI6IGZ1bmN0aW9uIChpbmRleCkgewoKICAgICAgICBpZiAodGhpcy5lbmFibGVkKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTA7IGkrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fcG9pbnRlckRhdGFbaV0uaXNPdmVyKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BvaW50ZXJEYXRhW2luZGV4XS5pc092ZXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJcyB0aGUgUG9pbnRlciBvdXRzaWRlIG9mIHRoaXMgU3ByaXRlPwogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlck91dAogICAgKiBAcGFyYW0ge251bWJlcn0gW2luZGV4XSAtIFRoZSBJRCBudW1iZXIgb2YgYSBQb2ludGVyIHRvIGNoZWNrLiBJZiB5b3UgZG9uJ3QgcHJvdmlkZSBhIG51bWJlciBpdCB3aWxsIGNoZWNrIGFsbCBQb2ludGVycy4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gcG9pbnRlciAoaWYgYSBpbmRleCB3YXMgZ2l2ZW4sIG9yIGFueSBwb2ludGVyIGlmIG5vdCkgaXMgb3V0IG9mIHRoaXMgb2JqZWN0LgogICAgKi8KICAgIHBvaW50ZXJPdXQ6IGZ1bmN0aW9uIChpbmRleCkgewoKICAgICAgICBpZiAodGhpcy5lbmFibGVkKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTA7IGkrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fcG9pbnRlckRhdGFbaV0uaXNPdXQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbaW5kZXhdLmlzT3V0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogQSB0aW1lc3RhbXAgcmVwcmVzZW50aW5nIHdoZW4gdGhlIFBvaW50ZXIgZmlyc3QgdG91Y2hlZCB0aGUgdG91Y2hzY3JlZW4uCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyVGltZU92ZXIKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgcG9pbnRlclRpbWVPdmVyOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZU92ZXI7CgogICAgfSwKCiAgICAvKioKICAgICogQSB0aW1lc3RhbXAgcmVwcmVzZW50aW5nIHdoZW4gdGhlIFBvaW50ZXIgbGVmdCB0aGUgdG91Y2hzY3JlZW4uCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyVGltZU91dAogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBwb2ludGVyVGltZU91dDogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLnRpbWVPdXQ7CgogICAgfSwKCiAgICAvKioKICAgICogSXMgdGhpcyBzcHJpdGUgYmVpbmcgZHJhZ2dlZCBieSB0aGUgbW91c2Ugb3Igbm90PwogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlclRpbWVPdXQKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgcG9pbnRlckRyYWdnZWQ6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc0RyYWdnZWQ7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGlmIHRoZSBnaXZlbiBwb2ludGVyIGlzIG92ZXIgdGhpcyBTcHJpdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNjaGVja1BvaW50ZXJPdmVyCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICBjaGVja1BvaW50ZXJPdmVyOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBpZiAodGhpcy5lbmFibGVkID09PSBmYWxzZSB8fCB0aGlzLnNwcml0ZS52aXNpYmxlID09PSBmYWxzZSB8fCAodGhpcy5zcHJpdGUuZ3JvdXAgJiYgdGhpcy5zcHJpdGUuZ3JvdXAudmlzaWJsZSA9PT0gZmFsc2UpKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zcHJpdGUuZ2V0TG9jYWxVbm1vZGlmaWVkUG9zaXRpb24odGhpcy5fdGVtcFBvaW50LCBwb2ludGVyLngsIHBvaW50ZXIueSk7CgogICAgICAgIGlmICh0aGlzLl90ZW1wUG9pbnQueCA+PSAwICYmIHRoaXMuX3RlbXBQb2ludC54IDw9IHRoaXMuc3ByaXRlLmN1cnJlbnRGcmFtZS53aWR0aCAmJiB0aGlzLl90ZW1wUG9pbnQueSA+PSAwICYmIHRoaXMuX3RlbXBQb2ludC55IDw9IHRoaXMuc3ByaXRlLmN1cnJlbnRGcmFtZS5oZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5waXhlbFBlcmZlY3QpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNoZWNrUGl4ZWwodGhpcy5fdGVtcFBvaW50LngsIHRoaXMuX3RlbXBQb2ludC55KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJ1bnMgYSBwaXhlbCBwZXJmZWN0IGNoZWNrIGFnYWluc3QgdGhlIGdpdmVuIHgveSBjb29yZGluYXRlcyBvZiB0aGUgU3ByaXRlIHRoaXMgSW5wdXRIYW5kbGVyIGlzIGJvdW5kIHRvLgogICAgKiBJdCBjb21wYXJlcyB0aGUgYWxwaGEgdmFsdWUgb2YgdGhlIHBpeGVsIGFuZCBpZiA+PSBJbnB1dEhhbmRsZXIucGl4ZWxQZXJmZWN0QWxwaGEgaXQgcmV0dXJucyB0cnVlLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjY2hlY2tQaXhlbAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgdG8gY2hlY2suCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSB0byBjaGVjay4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiB0aGVyZSBpcyB0aGUgYWxwaGEgb2YgdGhlIHBpeGVsIGlzID49IElucHV0SGFuZGxlci5waXhlbFBlcmZlY3RBbHBoYQogICAgKi8KICAgIGNoZWNrUGl4ZWw6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIC8vICBHcmFiIGEgcGl4ZWwgZnJvbSBvdXIgaW1hZ2UgaW50byB0aGUgaGl0Q2FudmFzIGFuZCB0aGVuIHRlc3QgaXQKICAgICAgICBpZiAodGhpcy5zcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS5zb3VyY2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuaGl0Q29udGV4dC5jbGVhclJlY3QoMCwgMCwgMSwgMSk7CgogICAgICAgICAgICB4ICs9IHRoaXMuc3ByaXRlLnRleHR1cmUuZnJhbWUueDsKICAgICAgICAgICAgeSArPSB0aGlzLnNwcml0ZS50ZXh0dXJlLmZyYW1lLnk7CgogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuaGl0Q29udGV4dC5kcmF3SW1hZ2UodGhpcy5zcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS5zb3VyY2UsIHgsIHksIDEsIDEsIDAsIDAsIDEsIDEpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHJnYiA9IHRoaXMuZ2FtZS5pbnB1dC5oaXRDb250ZXh0LmdldEltYWdlRGF0YSgwLCAwLCAxLCAxKTsKCiAgICAgICAgICAgIGlmIChyZ2IuZGF0YVszXSA+PSB0aGlzLnBpeGVsUGVyZmVjdEFscGhhKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3VwZGF0ZQogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBpZiAodGhpcy5lbmFibGVkID09PSBmYWxzZSB8fCB0aGlzLnNwcml0ZS52aXNpYmxlID09PSBmYWxzZSB8fCAodGhpcy5zcHJpdGUuZ3JvdXAgJiYgdGhpcy5zcHJpdGUuZ3JvdXAudmlzaWJsZSA9PT0gZmFsc2UpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlck91dEhhbmRsZXIocG9pbnRlcik7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmRyYWdnYWJsZSAmJiB0aGlzLl9kcmFnZ2VkUG9pbnRlcklEID09IHBvaW50ZXIuaWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVEcmFnKHBvaW50ZXIpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc092ZXIgPT09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5jaGVja1BvaW50ZXJPdmVyKHBvaW50ZXIpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS54ID0gcG9pbnRlci54IC0gdGhpcy5zcHJpdGUueDsKICAgICAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnkgPSBwb2ludGVyLnkgLSB0aGlzLnNwcml0ZS55OwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9wb2ludGVyT3V0SGFuZGxlcihwb2ludGVyKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZCBoYW5kbGluZyB0aGUgcG9pbnRlciBvdmVyIGV2ZW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjX3BvaW50ZXJPdmVySGFuZGxlcgogICAgKiBAcHJpdmF0ZQogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqLwogICAgX3BvaW50ZXJPdmVySGFuZGxlcjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgaWYgKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3ZlciA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc092ZXIgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc091dCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS50aW1lT3ZlciA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0ueCA9IHBvaW50ZXIueCAtIHRoaXMuc3ByaXRlLng7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnkgPSBwb2ludGVyLnkgLSB0aGlzLnNwcml0ZS55OwoKICAgICAgICAgICAgaWYgKHRoaXMudXNlSGFuZEN1cnNvciAmJiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc0RyYWdnZWQgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXRPdmVyLmRpc3BhdGNoKHRoaXMuc3ByaXRlLCBwb2ludGVyKTsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QgaGFuZGxpbmcgdGhlIHBvaW50ZXIgb3V0IGV2ZW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjX3BvaW50ZXJPdXRIYW5kbGVyCiAgICAqIEBwcml2YXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICovCiAgICBfcG9pbnRlck91dEhhbmRsZXI6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3ZlciA9IGZhbHNlOwogICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3V0ID0gdHJ1ZTsKICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS50aW1lT3V0ID0gdGhpcy5nYW1lLnRpbWUubm93OwoKICAgICAgICBpZiAodGhpcy51c2VIYW5kQ3Vyc29yICYmIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzRHJhZ2dlZCA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLmN1cnNvciA9ICJkZWZhdWx0IjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnNwcml0ZSAmJiB0aGlzLnNwcml0ZS5ldmVudHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dE91dC5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlcik7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZCBoYW5kbGluZyB0aGUgdG91Y2hlZCBldmVudC4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI190b3VjaGVkSGFuZGxlcgogICAgKiBAcHJpdmF0ZQogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqLwogICAgX3RvdWNoZWRIYW5kbGVyOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBpZiAodGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNEb3duID09PSBmYWxzZSAmJiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc092ZXIgPT09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc0Rvd24gPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc1VwID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnRpbWVEb3duID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dERvd24uZGlzcGF0Y2godGhpcy5zcHJpdGUsIHBvaW50ZXIpOwoKICAgICAgICAgICAgLy8gIFN0YXJ0IGRyYWcKICAgICAgICAgICAgaWYgKHRoaXMuZHJhZ2dhYmxlICYmIHRoaXMuaXNEcmFnZ2VkID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zdGFydERyYWcocG9pbnRlcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmJyaW5nVG9Ub3ApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmJyaW5nVG9Ub3AoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gIENvbnN1bWUgdGhlIGV2ZW50PwogICAgICAgIHJldHVybiB0aGlzLmNvbnN1bWVQb2ludGVyRXZlbnQ7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kIGhhbmRsaW5nIHRoZSBwb2ludGVyIHJlbGVhc2VkIGV2ZW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjX3JlbGVhc2VkSGFuZGxlcgogICAgKiBAcHJpdmF0ZQogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqLwogICAgX3JlbGVhc2VkSGFuZGxlcjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgLy8gIElmIHdhcyBwcmV2aW91c2x5IHRvdWNoZWQgYnkgdGhpcyBQb2ludGVyLCBjaGVjayBpZiBzdGlsbCBpcyBBTkQgc3RpbGwgb3ZlciB0aGlzIGl0ZW0KICAgICAgICBpZiAodGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNEb3duICYmIHBvaW50ZXIuaXNVcCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzRG93biA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc1VwID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0udGltZVVwID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5kb3duRHVyYXRpb24gPSB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS50aW1lVXAgLSB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS50aW1lRG93bjsKCiAgICAgICAgICAgIC8vICBPbmx5IHJlbGVhc2UgdGhlIElucHV0VXAgc2lnbmFsIGlmIHRoZSBwb2ludGVyIGlzIHN0aWxsIG92ZXIgdGhpcyBzcHJpdGUKICAgICAgICAgICAgaWYgKHRoaXMuY2hlY2tQb2ludGVyT3Zlcihwb2ludGVyKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFJlbGVhc2UgdGhlIGlucHV0VXAgc2lnbmFsIGFuZCBwcm92aWRlIG9wdGlvbmFsIHBhcmFtZXRlciBpZiBwb2ludGVyIGlzIHN0aWxsIG92ZXIgdGhlIHNwcml0ZSBvciBub3QKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0VXAuZGlzcGF0Y2godGhpcy5zcHJpdGUsIHBvaW50ZXIsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFJlbGVhc2UgdGhlIGlucHV0VXAgc2lnbmFsIGFuZCBwcm92aWRlIG9wdGlvbmFsIHBhcmFtZXRlciBpZiBwb2ludGVyIGlzIHN0aWxsIG92ZXIgdGhlIHNwcml0ZSBvciBub3QKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0VXAuZGlzcGF0Y2godGhpcy5zcHJpdGUsIHBvaW50ZXIsIGZhbHNlKTsKCiAgICAgICAgICAgICAgICAvLyAgUG9pbnRlciBvdXRzaWRlIHRoZSBzcHJpdGU/IFJlc2V0IHRoZSBjdXJzb3IKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVzZUhhbmRDdXJzb3IpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhbnZhcy5zdHlsZS5jdXJzb3IgPSAiZGVmYXVsdCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBTdG9wIGRyYWcKICAgICAgICAgICAgaWYgKHRoaXMuZHJhZ2dhYmxlICYmIHRoaXMuaXNEcmFnZ2VkICYmIHRoaXMuX2RyYWdnZWRQb2ludGVySUQgPT0gcG9pbnRlci5pZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zdG9wRHJhZyhwb2ludGVyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGVzIHRoZSBQb2ludGVyIGRyYWcgb24gdGhpcyBTcHJpdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciN1cGRhdGVEcmFnCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICB1cGRhdGVEcmFnOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBpZiAocG9pbnRlci5pc1VwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zdG9wRHJhZyhwb2ludGVyKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuc3ByaXRlLmZpeGVkVG9DYW1lcmEpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5hbGxvd0hvcml6b250YWxEcmFnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueCA9IHBvaW50ZXIueCArIHRoaXMuX2RyYWdQb2ludC54ICsgdGhpcy5kcmFnT2Zmc2V0Lng7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmFsbG93VmVydGljYWxEcmFnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueSA9IHBvaW50ZXIueSArIHRoaXMuX2RyYWdQb2ludC55ICsgdGhpcy5kcmFnT2Zmc2V0Lnk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmJvdW5kc1JlY3QpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tCb3VuZHNSZWN0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmJvdW5kc1Nwcml0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jaGVja0JvdW5kc1Nwcml0ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zbmFwT25EcmFnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueCA9IE1hdGgucm91bmQoKHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC54IC0gKHRoaXMuc25hcE9mZnNldFggJSB0aGlzLnNuYXBYKSkgLyB0aGlzLnNuYXBYKSAqIHRoaXMuc25hcFggKyAodGhpcy5zbmFwT2Zmc2V0WCAlIHRoaXMuc25hcFgpOwogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnkgPSBNYXRoLnJvdW5kKCh0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueSAtICh0aGlzLnNuYXBPZmZzZXRZICUgdGhpcy5zbmFwWSkpIC8gdGhpcy5zbmFwWSkgKiB0aGlzLnNuYXBZICsgKHRoaXMuc25hcE9mZnNldFkgJSB0aGlzLnNuYXBZKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5hbGxvd0hvcml6b250YWxEcmFnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS54ID0gcG9pbnRlci54ICsgdGhpcy5fZHJhZ1BvaW50LnggKyB0aGlzLmRyYWdPZmZzZXQueDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuYWxsb3dWZXJ0aWNhbERyYWcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgPSBwb2ludGVyLnkgKyB0aGlzLl9kcmFnUG9pbnQueSArIHRoaXMuZHJhZ09mZnNldC55OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5ib3VuZHNSZWN0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrQm91bmRzUmVjdCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5ib3VuZHNTcHJpdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tCb3VuZHNTcHJpdGUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc25hcE9uRHJhZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUueCA9IE1hdGgucm91bmQoKHRoaXMuc3ByaXRlLnggLSAodGhpcy5zbmFwT2Zmc2V0WCAlIHRoaXMuc25hcFgpKSAvIHRoaXMuc25hcFgpICogdGhpcy5zbmFwWCArICh0aGlzLnNuYXBPZmZzZXRYICUgdGhpcy5zbmFwWCk7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS55ID0gTWF0aC5yb3VuZCgodGhpcy5zcHJpdGUueSAtICh0aGlzLnNuYXBPZmZzZXRZICUgdGhpcy5zbmFwWSkpIC8gdGhpcy5zbmFwWSkgKiB0aGlzLnNuYXBZICsgKHRoaXMuc25hcE9mZnNldFkgJSB0aGlzLnNuYXBZKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwb2ludGVyIGhhcyBlbnRlcmVkIHRoZSBTcHJpdGUgd2l0aGluIHRoZSBzcGVjaWZpZWQgZGVsYXkgdGltZSAoZGVmYXVsdHMgdG8gNTAwbXMsIGhhbGYgYSBzZWNvbmQpCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNqdXN0T3ZlcgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkZWxheSAtIFRoZSB0aW1lIGJlbG93IHdoaWNoIHRoZSBwb2ludGVyIGlzIGNvbnNpZGVyZWQgYXMganVzdCBvdmVyLgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGp1c3RPdmVyOiBmdW5jdGlvbiAocG9pbnRlciwgZGVsYXkpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKICAgICAgICBkZWxheSA9IGRlbGF5IHx8IDUwMDsKCiAgICAgICAgcmV0dXJuICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc092ZXIgJiYgdGhpcy5vdmVyRHVyYXRpb24ocG9pbnRlcikgPCBkZWxheSk7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwb2ludGVyIGhhcyBsZWZ0IHRoZSBTcHJpdGUgd2l0aGluIHRoZSBzcGVjaWZpZWQgZGVsYXkgdGltZSAoZGVmYXVsdHMgdG8gNTAwbXMsIGhhbGYgYSBzZWNvbmQpCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNqdXN0T3V0CiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIHRpbWUgYmVsb3cgd2hpY2ggdGhlIHBvaW50ZXIgaXMgY29uc2lkZXJlZCBhcyBqdXN0IG91dC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICBqdXN0T3V0OiBmdW5jdGlvbiAocG9pbnRlciwgZGVsYXkpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKICAgICAgICBkZWxheSA9IGRlbGF5IHx8IDUwMDsKCiAgICAgICAgcmV0dXJuICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc091dCAmJiAodGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZU91dCA8IGRlbGF5KSk7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwb2ludGVyIGhhcyBlbnRlcmVkIHRoZSBTcHJpdGUgd2l0aGluIHRoZSBzcGVjaWZpZWQgZGVsYXkgdGltZSAoZGVmYXVsdHMgdG8gNTAwbXMsIGhhbGYgYSBzZWNvbmQpCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkZWxheSAtIFRoZSB0aW1lIGJlbG93IHdoaWNoIHRoZSBwb2ludGVyIGlzIGNvbnNpZGVyZWQgYXMganVzdCBvdmVyLgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGp1c3RQcmVzc2VkOiBmdW5jdGlvbiAocG9pbnRlciwgZGVsYXkpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKICAgICAgICBkZWxheSA9IGRlbGF5IHx8IDUwMDsKCiAgICAgICAgcmV0dXJuICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc0Rvd24gJiYgdGhpcy5kb3duRHVyYXRpb24ocG9pbnRlcikgPCBkZWxheSk7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwb2ludGVyIGhhcyBsZWZ0IHRoZSBTcHJpdGUgd2l0aGluIHRoZSBzcGVjaWZpZWQgZGVsYXkgdGltZSAoZGVmYXVsdHMgdG8gNTAwbXMsIGhhbGYgYSBzZWNvbmQpCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNqdXN0UmVsZWFzZWQKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgLSBUaGUgdGltZSBiZWxvdyB3aGljaCB0aGUgcG9pbnRlciBpcyBjb25zaWRlcmVkIGFzIGp1c3Qgb3V0LgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGp1c3RSZWxlYXNlZDogZnVuY3Rpb24gKHBvaW50ZXIsIGRlbGF5KSB7CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CiAgICAgICAgZGVsYXkgPSBkZWxheSB8fCA1MDA7CgogICAgICAgIHJldHVybiAodGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0uaXNVcCAmJiAodGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZVVwIDwgZGVsYXkpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJZiB0aGUgcG9pbnRlciBpcyBjdXJyZW50bHkgb3ZlciB0aGlzIFNwcml0ZSB0aGlzIHJldHVybnMgaG93IGxvbmcgaXQgaGFzIGJlZW4gdGhlcmUgZm9yIGluIG1pbGxpc2Vjb25kcy4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI292ZXJEdXJhdGlvbgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdGhlIHBvaW50ZXIgaGFzIGJlZW4gb3ZlciB0aGUgU3ByaXRlLCBvciAtMSBpZiBub3Qgb3Zlci4KICAgICovCiAgICBvdmVyRHVyYXRpb246IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIGlmICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc092ZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZU92ZXI7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gLTE7CgogICAgfSwKCiAgICAvKioKICAgICogSWYgdGhlIHBvaW50ZXIgaXMgY3VycmVudGx5IG92ZXIgdGhpcyBTcHJpdGUgdGhpcyByZXR1cm5zIGhvdyBsb25nIGl0IGhhcyBiZWVuIHRoZXJlIGZvciBpbiBtaWxsaXNlY29uZHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNkb3duRHVyYXRpb24KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRoZSBwb2ludGVyIGhhcyBiZWVuIHByZXNzZWQgZG93biBvbiB0aGUgU3ByaXRlLCBvciAtMSBpZiBub3Qgb3Zlci4KICAgICovCiAgICBkb3duRHVyYXRpb246IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIGlmICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc0Rvd24pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZURvd247CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gLTE7CgogICAgfSwKCiAgICAvKioKICAgICogTWFrZSB0aGlzIFNwcml0ZSBkcmFnZ2FibGUgYnkgdGhlIG1vdXNlLiBZb3UgY2FuIGFsc28gb3B0aW9uYWxseSBzZXQgbW91c2VTdGFydERyYWdDYWxsYmFjayBhbmQgbW91c2VTdG9wRHJhZ0NhbGxiYWNrCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNlbmFibGVEcmFnCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvY2tDZW50ZXI9ZmFsc2VdIC0gSWYgZmFsc2UgdGhlIFNwcml0ZSB3aWxsIGRyYWcgZnJvbSB3aGVyZSB5b3UgY2xpY2sgaXQgbWludXMgdGhlIGRyYWdPZmZzZXQuIElmIHRydWUgaXQgd2lsbCBjZW50ZXIgaXRzZWxmIHRvIHRoZSB0aXAgb2YgdGhlIG1vdXNlIHBvaW50ZXIuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2JyaW5nVG9Ub3A9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgU3ByaXRlIHdpbGwgYmUgYm91Z2h0IHRvIHRoZSB0b3Agb2YgdGhlIHJlbmRlcmluZyBsaXN0IGluIGl0cyBjdXJyZW50IEdyb3VwLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtwaXhlbFBlcmZlY3Q9ZmFsc2VdIC0gSWYgdHJ1ZSBpdCB3aWxsIHVzZSBhIHBpeGVsIHBlcmZlY3QgdGVzdCB0byBzZWUgaWYgeW91IGNsaWNrZWQgdGhlIFNwcml0ZS4gRmFsc2UgdXNlcyB0aGUgYm91bmRpbmcgYm94LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFthbHBoYVRocmVzaG9sZD0yNTVdIC0gSWYgdXNpbmcgcGl4ZWwgcGVyZmVjdCBjb2xsaXNpb24gdGhpcyBzcGVjaWZpZXMgdGhlIGFscGhhIGxldmVsIGZyb20gMCB0byAyNTUgYWJvdmUgd2hpY2ggYSBjb2xsaXNpb24gaXMgcHJvY2Vzc2VkLgogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IFtib3VuZHNSZWN0PW51bGxdIC0gSWYgeW91IHdhbnQgdG8gcmVzdHJpY3QgdGhlIGRyYWcgb2YgdGhpcyBzcHJpdGUgdG8gYSBzcGVjaWZpYyBSZWN0YW5nbGUsIHBhc3MgdGhlIFBoYXNlci5SZWN0YW5nbGUgaGVyZSwgb3RoZXJ3aXNlIGl0J3MgZnJlZSB0byBkcmFnIGFueXdoZXJlLgogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IFtib3VuZHNTcHJpdGU9bnVsbF0gLSBJZiB5b3Ugd2FudCB0byByZXN0cmljdCB0aGUgZHJhZyBvZiB0aGlzIHNwcml0ZSB0byB3aXRoaW4gdGhlIGJvdW5kaW5nIGJveCBvZiBhbm90aGVyIHNwcml0ZSwgcGFzcyBpdCBoZXJlLgogICAgKi8KICAgIGVuYWJsZURyYWc6IGZ1bmN0aW9uIChsb2NrQ2VudGVyLCBicmluZ1RvVG9wLCBwaXhlbFBlcmZlY3QsIGFscGhhVGhyZXNob2xkLCBib3VuZHNSZWN0LCBib3VuZHNTcHJpdGUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBsb2NrQ2VudGVyID09ICd1bmRlZmluZWQnKSB7IGxvY2tDZW50ZXIgPSBmYWxzZTsgfQogICAgICAgIGlmICh0eXBlb2YgYnJpbmdUb1RvcCA9PSAndW5kZWZpbmVkJykgeyBicmluZ1RvVG9wID0gZmFsc2U7IH0KICAgICAgICBpZiAodHlwZW9mIHBpeGVsUGVyZmVjdCA9PSAndW5kZWZpbmVkJykgeyBwaXhlbFBlcmZlY3QgPSBmYWxzZTsgfQogICAgICAgIGlmICh0eXBlb2YgYWxwaGFUaHJlc2hvbGQgPT0gJ3VuZGVmaW5lZCcpIHsgYWxwaGFUaHJlc2hvbGQgPSAyNTU7IH0KICAgICAgICBpZiAodHlwZW9mIGJvdW5kc1JlY3QgPT0gJ3VuZGVmaW5lZCcpIHsgYm91bmRzUmVjdCA9IG51bGw7IH0KICAgICAgICBpZiAodHlwZW9mIGJvdW5kc1Nwcml0ZSA9PSAndW5kZWZpbmVkJykgeyBib3VuZHNTcHJpdGUgPSBudWxsOyB9CgogICAgICAgIHRoaXMuX2RyYWdQb2ludCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKICAgICAgICB0aGlzLmRyYWdnYWJsZSA9IHRydWU7CiAgICAgICAgdGhpcy5icmluZ1RvVG9wID0gYnJpbmdUb1RvcDsKICAgICAgICB0aGlzLmRyYWdPZmZzZXQgPSBuZXcgUGhhc2VyLlBvaW50KCk7CiAgICAgICAgdGhpcy5kcmFnRnJvbUNlbnRlciA9IGxvY2tDZW50ZXI7CgogICAgICAgIHRoaXMucGl4ZWxQZXJmZWN0ID0gcGl4ZWxQZXJmZWN0OwogICAgICAgIHRoaXMucGl4ZWxQZXJmZWN0QWxwaGEgPSBhbHBoYVRocmVzaG9sZDsKCiAgICAgICAgaWYgKGJvdW5kc1JlY3QpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJvdW5kc1JlY3QgPSBib3VuZHNSZWN0OwogICAgICAgIH0KCiAgICAgICAgaWYgKGJvdW5kc1Nwcml0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYm91bmRzU3ByaXRlID0gYm91bmRzU3ByaXRlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wcyB0aGlzIHNwcml0ZSBmcm9tIGJlaW5nIGFibGUgdG8gYmUgZHJhZ2dlZC4gSWYgaXQgaXMgY3VycmVudGx5IHRoZSB0YXJnZXQgb2YgYW4gYWN0aXZlIGRyYWcgaXQgd2lsbCBiZSBzdG9wcGVkIGltbWVkaWF0ZWx5LiBBbHNvIGRpc2FibGVzIGFueSBzZXQgY2FsbGJhY2tzLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjZGlzYWJsZURyYWcKICAgICovCiAgICBkaXNhYmxlRHJhZzogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fcG9pbnRlckRhdGEpCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDEwOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW2ldLmlzRHJhZ2dlZCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLmRyYWdnYWJsZSA9IGZhbHNlOwogICAgICAgIHRoaXMuaXNEcmFnZ2VkID0gZmFsc2U7CiAgICAgICAgdGhpcy5fZHJhZ2dlZFBvaW50ZXJJRCA9IC0xOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCBieSBQb2ludGVyIHdoZW4gZHJhZyBzdGFydHMgb24gdGhpcyBTcHJpdGUuIFNob3VsZCBub3QgdXN1YWxseSBiZSBjYWxsZWQgZGlyZWN0bHkuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNzdGFydERyYWcKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKi8KICAgIHN0YXJ0RHJhZzogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgdGhpcy5pc0RyYWdnZWQgPSB0cnVlOwogICAgICAgIHRoaXMuX2RyYWdnZWRQb2ludGVySUQgPSBwb2ludGVyLmlkOwogICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzRHJhZ2dlZCA9IHRydWU7CgogICAgICAgIGlmICh0aGlzLnNwcml0ZS5maXhlZFRvQ2FtZXJhKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJhZ0Zyb21DZW50ZXIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNlbnRlck9uKHBvaW50ZXIueCwgcG9pbnRlci55KTsKICAgICAgICAgICAgICAgIHRoaXMuX2RyYWdQb2ludC5zZXRUbyh0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueCAtIHBvaW50ZXIueCwgdGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnkgLSBwb2ludGVyLnkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fZHJhZ1BvaW50LnNldFRvKHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC54IC0gcG9pbnRlci54LCB0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueSAtIHBvaW50ZXIueSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuZHJhZ0Zyb21DZW50ZXIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNlbnRlck9uKHBvaW50ZXIueCwgcG9pbnRlci55KTsKICAgICAgICAgICAgICAgIHRoaXMuX2RyYWdQb2ludC5zZXRUbyh0aGlzLnNwcml0ZS54IC0gcG9pbnRlci54LCB0aGlzLnNwcml0ZS55IC0gcG9pbnRlci55KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX2RyYWdQb2ludC5zZXRUbyh0aGlzLnNwcml0ZS54IC0gcG9pbnRlci54LCB0aGlzLnNwcml0ZS55IC0gcG9pbnRlci55KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy51cGRhdGVEcmFnKHBvaW50ZXIpOwogICAgICAgIAogICAgICAgIGlmICh0aGlzLmJyaW5nVG9Ub3ApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS5icmluZ1RvVG9wKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25EcmFnU3RhcnQuZGlzcGF0Y2godGhpcy5zcHJpdGUsIHBvaW50ZXIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCBieSBQb2ludGVyIHdoZW4gZHJhZyBpcyBzdG9wcGVkIG9uIHRoaXMgU3ByaXRlLiBTaG91bGQgbm90IHVzdWFsbHkgYmUgY2FsbGVkIGRpcmVjdGx5LgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjc3RvcERyYWcKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKi8KICAgIHN0b3BEcmFnOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICB0aGlzLmlzRHJhZ2dlZCA9IGZhbHNlOwogICAgICAgIHRoaXMuX2RyYWdnZWRQb2ludGVySUQgPSAtMTsKICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc0RyYWdnZWQgPSBmYWxzZTsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5zbmFwT25SZWxlYXNlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3ByaXRlLmZpeGVkVG9DYW1lcmEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC54ID0gTWF0aC5yb3VuZCgodGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnggLSAodGhpcy5zbmFwT2Zmc2V0WCAlIHRoaXMuc25hcFgpKSAvIHRoaXMuc25hcFgpICogdGhpcy5zbmFwWCArICh0aGlzLnNuYXBPZmZzZXRYICUgdGhpcy5zbmFwWCk7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueSA9IE1hdGgucm91bmQoKHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC55IC0gKHRoaXMuc25hcE9mZnNldFkgJSB0aGlzLnNuYXBZKSkgLyB0aGlzLnNuYXBZKSAqIHRoaXMuc25hcFkgKyAodGhpcy5zbmFwT2Zmc2V0WSAlIHRoaXMuc25hcFkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUueCA9IE1hdGgucm91bmQoKHRoaXMuc3ByaXRlLnggLSAodGhpcy5zbmFwT2Zmc2V0WCAlIHRoaXMuc25hcFgpKSAvIHRoaXMuc25hcFgpICogdGhpcy5zbmFwWCArICh0aGlzLnNuYXBPZmZzZXRYICUgdGhpcy5zbmFwWCk7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS55ID0gTWF0aC5yb3VuZCgodGhpcy5zcHJpdGUueSAtICh0aGlzLnNuYXBPZmZzZXRZICUgdGhpcy5zbmFwWSkpIC8gdGhpcy5zbmFwWSkgKiB0aGlzLnNuYXBZICsgKHRoaXMuc25hcE9mZnNldFkgJSB0aGlzLnNuYXBZKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uRHJhZ1N0b3AuZGlzcGF0Y2godGhpcy5zcHJpdGUsIHBvaW50ZXIpOwogICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0VXAuZGlzcGF0Y2godGhpcy5zcHJpdGUsIHBvaW50ZXIpOwoKICAgICAgICBpZiAodGhpcy5jaGVja1BvaW50ZXJPdmVyKHBvaW50ZXIpID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJPdXRIYW5kbGVyKHBvaW50ZXIpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXN0cmljdHMgdGhpcyBzcHJpdGUgdG8gZHJhZyBtb3ZlbWVudCBvbmx5IG9uIHRoZSBnaXZlbiBheGlzLiBOb3RlOiBJZiBib3RoIGFyZSBzZXQgdG8gZmFsc2UgdGhlIHNwcml0ZSB3aWxsIG5ldmVyIG1vdmUhCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNzZXREcmFnTG9jawogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFthbGxvd0hvcml6b250YWw9dHJ1ZV0gLSBUbyBlbmFibGUgdGhlIHNwcml0ZSB0byBiZSBkcmFnZ2VkIGhvcml6b250YWxseSBzZXQgdG8gdHJ1ZSwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFthbGxvd1ZlcnRpY2FsPXRydWVdIC0gVG8gZW5hYmxlIHRoZSBzcHJpdGUgdG8gYmUgZHJhZ2dlZCB2ZXJ0aWNhbGx5IHNldCB0byB0cnVlLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgc2V0RHJhZ0xvY2s6IGZ1bmN0aW9uIChhbGxvd0hvcml6b250YWwsIGFsbG93VmVydGljYWwpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBhbGxvd0hvcml6b250YWwgPT0gJ3VuZGVmaW5lZCcpIHsgYWxsb3dIb3Jpem9udGFsID0gdHJ1ZTsgfQogICAgICAgIGlmICh0eXBlb2YgYWxsb3dWZXJ0aWNhbCA9PSAndW5kZWZpbmVkJykgeyBhbGxvd1ZlcnRpY2FsID0gdHJ1ZTsgfQoKICAgICAgICB0aGlzLmFsbG93SG9yaXpvbnRhbERyYWcgPSBhbGxvd0hvcml6b250YWw7CiAgICAgICAgdGhpcy5hbGxvd1ZlcnRpY2FsRHJhZyA9IGFsbG93VmVydGljYWw7CgogICAgfSwKCiAgICAvKioKICAgICogTWFrZSB0aGlzIFNwcml0ZSBzbmFwIHRvIHRoZSBnaXZlbiBncmlkIGVpdGhlciBkdXJpbmcgZHJhZyBvciB3aGVuIGl0J3MgcmVsZWFzZWQuCiAgICAqIEZvciBleGFtcGxlIDE2eDE2IGFzIHRoZSBzbmFwWCBhbmQgc25hcFkgd291bGQgbWFrZSB0aGUgc3ByaXRlIHNuYXAgdG8gZXZlcnkgMTYgcGl4ZWxzLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjZW5hYmxlU25hcAogICAgKiBAcGFyYW0ge251bWJlcn0gc25hcFggLSBUaGUgd2lkdGggb2YgdGhlIGdyaWQgY2VsbCB0byBzbmFwIHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0gc25hcFkgLSBUaGUgaGVpZ2h0IG9mIHRoZSBncmlkIGNlbGwgdG8gc25hcCB0by4KICAgICogQHBhcmFtIHtib29sZWFufSBbb25EcmFnPXRydWVdIC0gSWYgdHJ1ZSB0aGUgc3ByaXRlIHdpbGwgc25hcCB0byB0aGUgZ3JpZCB3aGlsZSBiZWluZyBkcmFnZ2VkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvblJlbGVhc2U9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgc3ByaXRlIHdpbGwgc25hcCB0byB0aGUgZ3JpZCB3aGVuIHJlbGVhc2VkLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NuYXBPZmZzZXRYPTBdIC0gVXNlZCB0byBvZmZzZXQgdGhlIHRvcC1sZWZ0IHN0YXJ0aW5nIHBvaW50IG9mIHRoZSBzbmFwIGdyaWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc25hcE9mZnNldFg9MF0gLSBVc2VkIHRvIG9mZnNldCB0aGUgdG9wLWxlZnQgc3RhcnRpbmcgcG9pbnQgb2YgdGhlIHNuYXAgZ3JpZC4KICAgICovCiAgICBlbmFibGVTbmFwOiBmdW5jdGlvbiAoc25hcFgsIHNuYXBZLCBvbkRyYWcsIG9uUmVsZWFzZSwgc25hcHBPZmZzZXRYLCBzbmFwcE9mZnNldFkpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBvbkRyYWcgPT0gJ3VuZGVmaW5lZCcpIHsgb25EcmFnID0gdHJ1ZTsgfQogICAgICAgIGlmICh0eXBlb2Ygb25SZWxlYXNlID09ICd1bmRlZmluZWQnKSB7IG9uUmVsZWFzZSA9IGZhbHNlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBzbmFwT2Zmc2V0WCA9PSAndW5kZWZpbmVkJykgeyBzbmFwT2Zmc2V0WCA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIHNuYXBPZmZzZXRZID09ICd1bmRlZmluZWQnKSB7IHNuYXBPZmZzZXRZID0gMDsgfQoKICAgICAgICB0aGlzLnNuYXBYID0gc25hcFg7CiAgICAgICAgdGhpcy5zbmFwWSA9IHNuYXBZOwogICAgICAgIHRoaXMuc25hcE9mZnNldFggPSBzbmFwT2Zmc2V0WDsKICAgICAgICB0aGlzLnNuYXBPZmZzZXRZID0gc25hcE9mZnNldFk7CiAgICAgICAgdGhpcy5zbmFwT25EcmFnID0gb25EcmFnOwogICAgICAgIHRoaXMuc25hcE9uUmVsZWFzZSA9IG9uUmVsZWFzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wcyB0aGUgc3ByaXRlIGZyb20gc25hcHBpbmcgdG8gYSBncmlkIGR1cmluZyBkcmFnIG9yIHJlbGVhc2UuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNkaXNhYmxlU25hcAogICAgKi8KICAgIGRpc2FibGVTbmFwOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuc25hcE9uRHJhZyA9IGZhbHNlOwogICAgICAgIHRoaXMuc25hcE9uUmVsZWFzZSA9IGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEJvdW5kcyBSZWN0IGNoZWNrIGZvciB0aGUgc3ByaXRlIGRyYWcKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2NoZWNrQm91bmRzUmVjdAogICAgKi8KICAgIGNoZWNrQm91bmRzUmVjdDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5zcHJpdGUuZml4ZWRUb0NhbWVyYSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueCA8IHRoaXMuYm91bmRzUmVjdC5sZWZ0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueCA9IHRoaXMuYm91bmRzUmVjdC5jYW1lcmFPZmZzZXQueDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICgodGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnggKyB0aGlzLnNwcml0ZS53aWR0aCkgPiB0aGlzLmJvdW5kc1JlY3QucmlnaHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC54ID0gdGhpcy5ib3VuZHNSZWN0LnJpZ2h0IC0gdGhpcy5zcHJpdGUud2lkdGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueSA8IHRoaXMuYm91bmRzUmVjdC50b3ApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC55ID0gdGhpcy5ib3VuZHNSZWN0LnRvcDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICgodGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnkgKyB0aGlzLnNwcml0ZS5oZWlnaHQpID4gdGhpcy5ib3VuZHNSZWN0LmJvdHRvbSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnkgPSB0aGlzLmJvdW5kc1JlY3QuYm90dG9tIC0gdGhpcy5zcHJpdGUuaGVpZ2h0OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnNwcml0ZS54IDwgdGhpcy5ib3VuZHNSZWN0LmxlZnQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLnggPSB0aGlzLmJvdW5kc1JlY3QueDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICgodGhpcy5zcHJpdGUueCArIHRoaXMuc3ByaXRlLndpZHRoKSA+IHRoaXMuYm91bmRzUmVjdC5yaWdodCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUueCA9IHRoaXMuYm91bmRzUmVjdC5yaWdodCAtIHRoaXMuc3ByaXRlLndpZHRoOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zcHJpdGUueSA8IHRoaXMuYm91bmRzUmVjdC50b3ApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgPSB0aGlzLmJvdW5kc1JlY3QudG9wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKCh0aGlzLnNwcml0ZS55ICsgdGhpcy5zcHJpdGUuaGVpZ2h0KSA+IHRoaXMuYm91bmRzUmVjdC5ib3R0b20pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgPSB0aGlzLmJvdW5kc1JlY3QuYm90dG9tIC0gdGhpcy5zcHJpdGUuaGVpZ2h0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFBhcmVudCBTcHJpdGUgQm91bmRzIGNoZWNrIGZvciB0aGUgc3ByaXRlIGRyYWcuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNjaGVja0JvdW5kc1Nwcml0ZQogICAgKi8KICAgIGNoZWNrQm91bmRzU3ByaXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnNwcml0ZS5maXhlZFRvQ2FtZXJhICYmIHRoaXMuYm91bmRzU3ByaXRlLmZpeGVkVG9DYW1lcmEpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnggPCB0aGlzLmJvdW5kc1Nwcml0ZS5jYW1lck9mZnNldC54KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueCA9IHRoaXMuYm91bmRzU3ByaXRlLmNhbWVyT2Zmc2V0Lng7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoKHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC54ICsgdGhpcy5zcHJpdGUud2lkdGgpID4gKHRoaXMuYm91bmRzU3ByaXRlLmNhbWVyT2Zmc2V0LnggKyB0aGlzLmJvdW5kc1Nwcml0ZS53aWR0aCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC54ID0gKHRoaXMuYm91bmRzU3ByaXRlLmNhbWVyT2Zmc2V0LnggKyB0aGlzLmJvdW5kc1Nwcml0ZS53aWR0aCkgLSB0aGlzLnNwcml0ZS53aWR0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC55IDwgdGhpcy5ib3VuZHNTcHJpdGUuY2FtZXJPZmZzZXQueSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnkgPSB0aGlzLmJvdW5kc1Nwcml0ZS5jYW1lck9mZnNldC55OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKCh0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueSArIHRoaXMuc3ByaXRlLmhlaWdodCkgPiAodGhpcy5ib3VuZHNTcHJpdGUuY2FtZXJPZmZzZXQueSArIHRoaXMuYm91bmRzU3ByaXRlLmhlaWdodCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC55ID0gKHRoaXMuYm91bmRzU3ByaXRlLmNhbWVyT2Zmc2V0LnkgKyB0aGlzLmJvdW5kc1Nwcml0ZS5oZWlnaHQpIC0gdGhpcy5zcHJpdGUuaGVpZ2h0OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnNwcml0ZS54IDwgdGhpcy5ib3VuZHNTcHJpdGUueCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUueCA9IHRoaXMuYm91bmRzU3ByaXRlLng7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoKHRoaXMuc3ByaXRlLnggKyB0aGlzLnNwcml0ZS53aWR0aCkgPiAodGhpcy5ib3VuZHNTcHJpdGUueCArIHRoaXMuYm91bmRzU3ByaXRlLndpZHRoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUueCA9ICh0aGlzLmJvdW5kc1Nwcml0ZS54ICsgdGhpcy5ib3VuZHNTcHJpdGUud2lkdGgpIC0gdGhpcy5zcHJpdGUud2lkdGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnNwcml0ZS55IDwgdGhpcy5ib3VuZHNTcHJpdGUueSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUueSA9IHRoaXMuYm91bmRzU3ByaXRlLnk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoKHRoaXMuc3ByaXRlLnkgKyB0aGlzLnNwcml0ZS5oZWlnaHQpID4gKHRoaXMuYm91bmRzU3ByaXRlLnkgKyB0aGlzLmJvdW5kc1Nwcml0ZS5oZWlnaHQpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS55ID0gKHRoaXMuYm91bmRzU3ByaXRlLnkgKyB0aGlzLmJvdW5kc1Nwcml0ZS5oZWlnaHQpIC0gdGhpcy5zcHJpdGUuaGVpZ2h0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0KCn07CgpQaGFzZXIuSW5wdXRIYW5kbGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5JbnB1dEhhbmRsZXI7CgovKioKKiBAYXV0aG9yICAgICAgIEBrYXJsbWFja2xpbiA8dGFja2xlbWNjbGVhbkBnbWFpbC5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBHYW1lcGFkIGNsYXNzIGhhbmRsZXMgbG9va2luZyBhZnRlciBnYW1lcGFkIGlucHV0IGZvciB5b3VyIGdhbWUuCiogUmVtZW1iZXIgdG8gY2FsbCBnYW1lcGFkLnN0YXJ0KCk7IGV4cGVjdGluZyBpbnB1dCEKKgoqIEhUTUw1IEdBTUVQQUQgQVBJIFNVUFBPUlQgSVMgQVQgQU4gRVhQRVJJTUVOVEFMIFNUQUdFIQoqIEF0IG1vbWVudCBvZiB3cml0aW5nIHRoaXMgKGVuZCBvZiAyMDEzKSBvbmx5IENocm9tZSBzdXBwb3J0cyBwYXJ0cyBvZiBpdCBvdXQgb2YgdGhlIGJveC4gRmlyZWZveCBzdXBwb3J0cyBpdAoqIHZpYSBwcmVmcyBmbGFncyAoYWJvdXQ6Y29uZmlnLCBzZWFyY2ggZ2FtZXBhZCkuIFRoZSBicm93c2VycyBtYXAgdGhlIHNhbWUgY29udHJvbGxlcnMgZGlmZmVyZW50bHkuCiogVGhpcyBjbGFzcyBoYXMgY29uc3RhbnMgZm9yIFdpbmRvd3MgNyBDaHJvbWUgbWFwcGluZyBvZgoqIFhCT1ggMzYwIGNvbnRyb2xsZXIuCioKKiBAY2xhc3MgUGhhc2VyLkdhbWVwYWQKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5HYW1lcGFkID0gZnVuY3Rpb24gKGdhbWUpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7QXJyYXk8UGhhc2VyLlNpbmdsZVBhZD59IF9nYW1lcGFkcyAtIFRoZSBmb3VyIFBoYXNlciBHYW1lcGFkcy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9nYW1lcGFkcyA9IFsKICAgICAgICBuZXcgUGhhc2VyLlNpbmdsZVBhZChnYW1lLCB0aGlzKSwKICAgICAgICBuZXcgUGhhc2VyLlNpbmdsZVBhZChnYW1lLCB0aGlzKSwKICAgICAgICBuZXcgUGhhc2VyLlNpbmdsZVBhZChnYW1lLCB0aGlzKSwKICAgICAgICBuZXcgUGhhc2VyLlNpbmdsZVBhZChnYW1lLCB0aGlzKQogICAgXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtPYmplY3R9IF9nYW1lcGFkSW5kZXhNYXAgLSBNYXBzIHRoZSBicm93c2VycyBnYW1lcGFkIGluZGljZXMgdG8gb3VyIFBoYXNlciBHYW1lcGFkcwogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2dhbWVwYWRJbmRleE1hcCA9IHt9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0FycmF5fSBfcmF3UGFkcyAtIFRoZSByYXcgc3RhdGUgb2YgdGhlIGdhbWVwYWRzIGZyb20gdGhlIGJyb3dzZXIKICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9yYXdQYWRzID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX2FjdGl2ZSAtIFByaXZhdGUgZmxhZyBmb3Igd2hldGhlciBvciBub3QgdGhlIEFQSSBpcyBwb2xsZWQKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9hY3RpdmUgPSBmYWxzZTsKCiAgICAvKioKICAgICogWW91IGNhbiBkaXNhYmxlIGFsbCBHYW1lcGFkIElucHV0IGJ5IHNldHRpbmcgZGlzYWJsZWQgdG8gdHJ1ZS4gV2hpbGUgdHJ1ZSBhbGwgbmV3IGlucHV0IHJlbGF0ZWQgZXZlbnRzIHdpbGwgYmUgaWdub3JlZC4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBkaXNhYmxlZCAtIFRoZSBkaXNhYmxlZCBzdGF0ZSBvZiB0aGUgR2FtZXBhZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmRpc2FibGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIFdoZXRoZXIgb3Igbm90IGdhbWVwYWRzIGFyZSBzdXBwb3J0ZWQgaW4gdGhlIGN1cnJlbnQgYnJvd3Nlci4gTm90ZSB0aGF0IGFzIG9mIERlYy4gMjAxMyB0aGlzIGNoZWNrIGlzIGFjdHVhbGx5IG5vdCBhY2N1cmF0ZSBhdCBhbGwgZHVlIHRvIHBvb3IgaW1wbGVtZW50YXRpb24uCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX2dhbWVwYWRTdXBwb3J0QXZhaWxhYmxlIC0gQXJlIGdhbWVwYWRzIHN1cHBvcnRlZCBpbiB0aGlzIGJyb3dzZXIgb3Igbm90PwogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2dhbWVwYWRTdXBwb3J0QXZhaWxhYmxlID0gISFuYXZpZ2F0b3Iud2Via2l0R2V0R2FtZXBhZHMgfHwgISFuYXZpZ2F0b3Iud2Via2l0R2FtZXBhZHMgfHwgKG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignRmlyZWZveC8nKSAhPSAtMSk7CgogICAgLyoqCiAgICAqIFVzZWQgdG8gY2hlY2sgZm9yIGRpZmZlcmVuY2VzIGJldHdlZW4gZWFybGllciBwb2xscyBhbmQgY3VycmVudCBzdGF0ZSBvZiBnYW1lcGFkcy4KICAgICogQHByb3BlcnR5IHtBcnJheX0gX3ByZXZSYXdHYW1lcGFkVHlwZXMKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9wcmV2UmF3R2FtZXBhZFR5cGVzID0gW107CgogICAgLyoqCiAgICAqIFVzZWQgdG8gY2hlY2sgZm9yIGRpZmZlcmVuY2VzIGJldHdlZW4gZWFybGllciBwb2xscyBhbmQgY3VycmVudCBzdGF0ZSBvZiBnYW1lcGFkcy4KICAgICogQHByb3BlcnR5IHtBcnJheX0gX3ByZXZUaW1lc3RhbXBzCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fcHJldlRpbWVzdGFtcHMgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtPYmplY3R9IGNhbGxiYWNrQ29udGV4dCAtIFRoZSBjb250ZXh0IHVuZGVyIHdoaWNoIHRoZSBjYWxsYmFja3MgYXJlIHJ1bi4KICAgICovCiAgICB0aGlzLmNhbGxiYWNrQ29udGV4dCA9IHRoaXM7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uQ29ubmVjdENhbGxiYWNrIC0gVGhpcyBjYWxsYmFjayBpcyBpbnZva2VkIGV2ZXJ5IHRpbWUgYW55IGdhbWVwYWQgaXMgY29ubmVjdGVkCiAgICAqLwogICAgdGhpcy5vbkNvbm5lY3RDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uRGlzY29ubmVjdENhbGxiYWNrIC0gVGhpcyBjYWxsYmFjayBpcyBpbnZva2VkIGV2ZXJ5IHRpbWUgYW55IGdhbWVwYWQgaXMgZGlzY29ubmVjdGVkCiAgICAqLwogICAgdGhpcy5vbkRpc2Nvbm5lY3RDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uRG93bkNhbGxiYWNrIC0gVGhpcyBjYWxsYmFjayBpcyBpbnZva2VkIGV2ZXJ5IHRpbWUgYW55IGdhbWVwYWQgYnV0dG9uIGlzIHByZXNzZWQgZG93bi4KICAgICovCiAgICB0aGlzLm9uRG93bkNhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25VcENhbGxiYWNrIC0gVGhpcyBjYWxsYmFjayBpcyBpbnZva2VkIGV2ZXJ5IHRpbWUgYW55IGdhbWVwYWQgYnV0dG9uIGlzIHJlbGVhc2VkLgogICAgKi8KICAgIHRoaXMub25VcENhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25BeGlzQ2FsbGJhY2sgLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhbnkgZ2FtZXBhZCBheGlzIGlzIGNoYW5nZWQuCiAgICAqLwogICAgdGhpcy5vbkF4aXNDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uRmxvYXRDYWxsYmFjayAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIGFueSBnYW1lcGFkIGJ1dHRvbiBpcyBjaGFuZ2VkIHRvIGEgdmFsdWUgd2hlcmUgdmFsdWUgPiAwIGFuZCB2YWx1ZSA8IDEuCiAgICAqLwogICAgdGhpcy5vbkZsb2F0Q2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25nYW1lcGFkY29ubmVjdGVkIC0gUHJpdmF0ZSBjYWxsYmFjayBmb3IgRmlyZWZveCBnYW1lcGFkIGNvbm5lY3Rpb24gaGFuZGxpbmcKICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vbmdhbWVwYWRjb25uZWN0ZWQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfZ2FtZXBhZGRpc2Nvbm5lY3RlZCAtIFByaXZhdGUgY2FsbGJhY2sgZm9yIEZpcmVmb3ggZ2FtZXBhZCBjb25uZWN0aW9uIGhhbmRsaW5nCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZ2FtZXBhZGRpc2Nvbm5lY3RlZCA9IG51bGw7Cn07CgpQaGFzZXIuR2FtZXBhZC5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEFkZCBjYWxsYmFja3MgdG8gdGhlIG1haW4gR2FtZXBhZCBoYW5kbGVyIHRvIGhhbmRsZSBjb25uZWN0L2Rpc2Nvbm5lY3QvYnV0dG9uIGRvd24vYnV0dG9uIHVwL2F4aXMgY2hhbmdlL2Zsb2F0IHZhbHVlIGJ1dHRvbnMKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZCNhZGRDYWxsYmFja3MKICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgLSBUaGUgY29udGV4dCB1bmRlciB3aGljaCB0aGUgY2FsbGJhY2tzIGFyZSBydW4uCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBjYWxsYmFja3MgLSBPYmplY3QgdGhhdCB0YWtlcyBzaXggZGlmZmVyZW50IGNhbGxiYWNrIG1ldGhvZHM6CiAgICAqIG9uQ29ubmVjdENhbGxiYWNrLCBvbkRpc2Nvbm5lY3RDYWxsYmFjaywgb25Eb3duQ2FsbGJhY2ssIG9uVXBDYWxsYmFjaywgb25BeGlzQ2FsbGJhY2ssIG9uRmxvYXRDYWxsYmFjawogICAgKi8KICAgIGFkZENhbGxiYWNrczogZnVuY3Rpb24gKGNvbnRleHQsIGNhbGxiYWNrcykgewoKICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrcyAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uQ29ubmVjdENhbGxiYWNrID0gKHR5cGVvZiBjYWxsYmFja3Mub25Db25uZWN0ID09PSAnZnVuY3Rpb24nKSA/IGNhbGxiYWNrcy5vbkNvbm5lY3QgOiB0aGlzLm9uQ29ubmVjdENhbGxiYWNrOwogICAgICAgICAgICB0aGlzLm9uRGlzY29ubmVjdENhbGxiYWNrID0gKHR5cGVvZiBjYWxsYmFja3Mub25EaXNjb25uZWN0ID09PSAnZnVuY3Rpb24nKSA/IGNhbGxiYWNrcy5vbkRpc2Nvbm5lY3QgOiB0aGlzLm9uRGlzY29ubmVjdENhbGxiYWNrOwogICAgICAgICAgICB0aGlzLm9uRG93bkNhbGxiYWNrID0gKHR5cGVvZiBjYWxsYmFja3Mub25Eb3duID09PSAnZnVuY3Rpb24nKSA/IGNhbGxiYWNrcy5vbkRvd24gOiB0aGlzLm9uRG93bkNhbGxiYWNrOwogICAgICAgICAgICB0aGlzLm9uVXBDYWxsYmFjayA9ICh0eXBlb2YgY2FsbGJhY2tzLm9uVXAgPT09ICdmdW5jdGlvbicpID8gY2FsbGJhY2tzLm9uVXAgOiB0aGlzLm9uVXBDYWxsYmFjazsKICAgICAgICAgICAgdGhpcy5vbkF4aXNDYWxsYmFjayA9ICh0eXBlb2YgY2FsbGJhY2tzLm9uQXhpcyA9PT0gJ2Z1bmN0aW9uJykgPyBjYWxsYmFja3Mub25BeGlzIDogdGhpcy5vbkF4aXNDYWxsYmFjazsKICAgICAgICAgICAgdGhpcy5vbkZsb2F0Q2FsbGJhY2sgPSAodHlwZW9mIGNhbGxiYWNrcy5vbkZsb2F0ID09PSAnZnVuY3Rpb24nKSA/IGNhbGxiYWNrcy5vbkZsb2F0IDogdGhpcy5vbkZsb2F0Q2FsbGJhY2s7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0YXJ0cyB0aGUgR2FtZXBhZCBldmVudCBoYW5kbGluZy4KICAgICogVGhpcyBNVVNUIGJlIGNhbGxlZCBtYW51YWxseSBiZWZvcmUgUGhhc2VyIHdpbGwgc3RhcnQgcG9sbGluZyB0aGUgR2FtZXBhZCBBUEkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVwYWQjc3RhcnQKICAgICovCiAgICBzdGFydDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9hY3RpdmUgPSB0cnVlOwogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHRoaXMuX29uZ2FtZXBhZGNvbm5lY3RlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBuZXdQYWQgPSBldmVudC5nYW1lcGFkOwogICAgICAgICAgICBfdGhpcy5fcmF3UGFkcy5wdXNoKG5ld1BhZCk7CiAgICAgICAgICAgIF90aGlzLl9nYW1lcGFkc1tuZXdQYWQuaW5kZXhdLmNvbm5lY3QobmV3UGFkKTsKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZ2FtZXBhZGNvbm5lY3RlZCcsIHRoaXMuX29uZ2FtZXBhZGNvbm5lY3RlZCwgZmFsc2UpOwoKICAgICAgICB0aGlzLl9vbmdhbWVwYWRkaXNjb25uZWN0ZWQgPSBmdW5jdGlvbihldmVudCkgewoKICAgICAgICAgICAgdmFyIHJlbW92ZWRQYWQgPSBldmVudC5nYW1lcGFkOwoKICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBfdGhpcy5fcmF3UGFkcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKF90aGlzLl9yYXdQYWRzW2ldLmluZGV4ID09PSByZW1vdmVkUGFkLmluZGV4KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIF90aGlzLl9yYXdQYWRzLnNwbGljZShpLDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIF90aGlzLl9nYW1lcGFkc1tyZW1vdmVkUGFkLmluZGV4XS5kaXNjb25uZWN0KCk7CiAgICAgICAgfTsKCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2dhbWVwYWRkaXNjb25uZWN0ZWQnLCB0aGlzLl9vbmdhbWVwYWRkaXNjb25uZWN0ZWQsIGZhbHNlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNYWluIGdhbWVwYWQgdXBkYXRlIGxvb3AuIFNob3VsZCBub3QgYmUgY2FsbGVkIG1hbnVhbGx5LgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lcGFkI3VwZGF0ZQogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9wb2xsR2FtZXBhZHMoKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9nYW1lcGFkcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9nYW1lcGFkc1tpXS5fY29ubmVjdGVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9nYW1lcGFkc1tpXS5wb2xsU3RhdHVzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRpbmcgY29ubmVjdGVkIGdhbWVwYWRzIChmb3IgR29vZ2xlIENocm9tZSkuCiAgICAqIFNob3VsZCBub3QgYmUgY2FsbGVkIG1hbnVhbGx5LgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lcGFkI19wb2xsR2FtZXBhZHMKICAgICogQHByaXZhdGUKICAgICovCiAgICBfcG9sbEdhbWVwYWRzOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciByYXdHYW1lcGFkcyA9IChuYXZpZ2F0b3Iud2Via2l0R2V0R2FtZXBhZHMgJiYgbmF2aWdhdG9yLndlYmtpdEdldEdhbWVwYWRzKCkpIHx8IG5hdmlnYXRvci53ZWJraXRHYW1lcGFkczsKCiAgICAgICAgaWYgKHJhd0dhbWVwYWRzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcmF3UGFkcyA9IFtdOwoKICAgICAgICAgICAgdmFyIGdhbWVwYWRzQ2hhbmdlZCA9IGZhbHNlOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByYXdHYW1lcGFkcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByYXdHYW1lcGFkc1tpXSAhPT0gdGhpcy5fcHJldlJhd0dhbWVwYWRUeXBlc1tpXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBnYW1lcGFkc0NoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3ByZXZSYXdHYW1lcGFkVHlwZXNbaV0gPSB0eXBlb2YgcmF3R2FtZXBhZHNbaV07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHJhd0dhbWVwYWRzW2ldKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jhd1BhZHMucHVzaChyYXdHYW1lcGFkc1tpXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU3VwcG9ydCBtYXggNCBwYWRzIGF0IHRoZSBtb21lbnQKICAgICAgICAgICAgICAgIGlmIChpID09PSAzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZ2FtZXBhZHNDaGFuZ2VkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdmFsaWRDb25uZWN0aW9ucyA9IHsgcmF3SW5kaWNlczoge30sIHBhZEluZGljZXM6IHt9IH07CiAgICAgICAgICAgICAgICB2YXIgc2luZ2xlUGFkOwoKICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdGhpcy5fZ2FtZXBhZHMubGVuZ3RoOyBqKyspCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc2luZ2xlUGFkID0gdGhpcy5fZ2FtZXBhZHNbal07CgogICAgICAgICAgICAgICAgICAgIGlmIChzaW5nbGVQYWQuY29ubmVjdGVkKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCB0aGlzLl9yYXdQYWRzLmxlbmd0aDsgaysrKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fcmF3UGFkc1trXS5pbmRleCA9PT0gc2luZ2xlUGFkLmluZGV4KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQ29ubmVjdGlvbnMucmF3SW5kaWNlc1tzaW5nbGVQYWQuaW5kZXhdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZENvbm5lY3Rpb25zLnBhZEluZGljZXNbal0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvciAodmFyIGwgPSAwOyBsIDwgdGhpcy5fZ2FtZXBhZHMubGVuZ3RoOyBsKyspCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc2luZ2xlUGFkID0gdGhpcy5fZ2FtZXBhZHNbbF07CgogICAgICAgICAgICAgICAgICAgIGlmICh2YWxpZENvbm5lY3Rpb25zLnBhZEluZGljZXNbbF0pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yYXdQYWRzLmxlbmd0aCA8IDEpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBzaW5nbGVQYWQuZGlzY29ubmVjdCgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbSA9IDA7IG0gPCB0aGlzLl9yYXdQYWRzLmxlbmd0aDsgbSsrKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbGlkQ29ubmVjdGlvbnMucGFkSW5kaWNlc1tsXSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByYXdQYWQgPSB0aGlzLl9yYXdQYWRzW21dOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJhd1BhZCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbGlkQ29ubmVjdGlvbnMucmF3SW5kaWNlc1tyYXdQYWQuaW5kZXhdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpbmdsZVBhZC5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2luZ2xlUGFkLmNvbm5lY3QocmF3UGFkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZENvbm5lY3Rpb25zLnJhd0luZGljZXNbcmF3UGFkLmluZGV4XSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRDb25uZWN0aW9ucy5wYWRJbmRpY2VzW2xdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpbmdsZVBhZC5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBkZWFkWm9uZSB2YXJpYWJsZSBmb3IgYWxsIGZvdXIgZ2FtZXBhZHMKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZCNzZXREZWFkWm9uZXMKICAgICovCiAgICBzZXREZWFkWm9uZXM6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2dhbWVwYWRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZ2FtZXBhZHNbaV0uZGVhZFpvbmUgPSB2YWx1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgdGhlIEdhbWVwYWQgZXZlbnQgaGFuZGxpbmcuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVwYWQjc3RvcAogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fYWN0aXZlID0gZmFsc2U7CgogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdnYW1lcGFkY29ubmVjdGVkJywgdGhpcy5fb25nYW1lcGFkY29ubmVjdGVkKTsKICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignZ2FtZXBhZGRpc2Nvbm5lY3RlZCcsIHRoaXMuX29uZ2FtZXBhZGRpc2Nvbm5lY3RlZCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVzZXQgYWxsIGJ1dHRvbnMvYXhlcyBvZiBhbGwgZ2FtZXBhZHMKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZCNyZXNldAogICAgKi8KICAgIHJlc2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMudXBkYXRlKCk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fZ2FtZXBhZHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9nYW1lcGFkc1tpXS5yZXNldCgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSAianVzdCBwcmVzc2VkIiBzdGF0ZSBvZiBhIGJ1dHRvbiBmcm9tIEFOWSBnYW1lcGFkIGNvbm5lY3RlZC4gSnVzdCBwcmVzc2VkIGlzIGNvbnNpZGVyZWQgdHJ1ZSBpZiB0aGUgYnV0dG9uIHdhcyBwcmVzc2VkIGRvd24gd2l0aGluIHRoZSBkdXJhdGlvbiBnaXZlbiAoZGVmYXVsdCAyNTBtcykuCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVwYWQjanVzdFByZXNzZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IGJ1dHRvbkNvZGUgLSBUaGUgYnV0dG9uQ29kZSBvZiB0aGUgYnV0dG9uIHRvIGNoZWNrIGZvci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbj0yNTBdIC0gVGhlIGR1cmF0aW9uIGJlbG93IHdoaWNoIHRoZSBidXR0b24gaXMgY29uc2lkZXJlZCBhcyBiZWluZyBqdXN0IHByZXNzZWQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGJ1dHRvbiBpcyBqdXN0IHByZXNzZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGp1c3RQcmVzc2VkOiBmdW5jdGlvbiAoYnV0dG9uQ29kZSwgZHVyYXRpb24pIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9nYW1lcGFkcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9nYW1lcGFkc1tpXS5qdXN0UHJlc3NlZChidXR0b25Db2RlLCBkdXJhdGlvbikgPT09IHRydWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgImp1c3QgcmVsZWFzZWQiIHN0YXRlIG9mIGEgYnV0dG9uIGZyb20gQU5ZIGdhbWVwYWQgY29ubmVjdGVkLiBKdXN0IHJlbGVhc2VkIGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcgdHJ1ZSBpZiB0aGUgYnV0dG9uIHdhcyByZWxlYXNlZCB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuIChkZWZhdWx0IDI1MG1zKS4KICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZCNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge251bWJlcn0gYnV0dG9uQ29kZSAtIFRoZSBidXR0b25Db2RlIG9mIHRoZSBidXR0b24gdG8gY2hlY2sgZm9yLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2R1cmF0aW9uPTI1MF0gLSBUaGUgZHVyYXRpb24gYmVsb3cgd2hpY2ggdGhlIGJ1dHRvbiBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIGp1c3QgcmVsZWFzZWQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGJ1dHRvbiBpcyBqdXN0IHJlbGVhc2VkIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBqdXN0UmVsZWFzZWQ6IGZ1bmN0aW9uIChidXR0b25Db2RlLCBkdXJhdGlvbikgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2dhbWVwYWRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2dhbWVwYWRzW2ldLmp1c3RSZWxlYXNlZChidXR0b25Db2RlLCBkdXJhdGlvbikgPT09IHRydWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBidXR0b24gaXMgY3VycmVudGx5IHByZXNzZWQgZG93biwgb24gQU5ZIGdhbWVwYWQuCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVwYWQjaXNEb3duCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBidXR0b25Db2RlIC0gVGhlIGJ1dHRvbkNvZGUgb2YgdGhlIGJ1dHRvbiB0byBjaGVjayBmb3IuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgYSBidXR0b24gaXMgY3VycmVudGx5IGRvd24uCiAgICAqLwogICAgaXNEb3duOiBmdW5jdGlvbiAoYnV0dG9uQ29kZSkgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2dhbWVwYWRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2dhbWVwYWRzW2ldLmlzRG93bihidXR0b25Db2RlKSA9PT0gdHJ1ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCn07CgpQaGFzZXIuR2FtZXBhZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuR2FtZXBhZDsKCi8qKgoqIElmIHRoZSBnYW1lcGFkIGlucHV0IGlzIGFjdGl2ZSBvciBub3QgLSBpZiBub3QgYWN0aXZlIGl0IHNob3VsZCBub3QgYmUgdXBkYXRlZCBmcm9tIElucHV0LmpzCiogQG5hbWUgUGhhc2VyLkdhbWVwYWQjYWN0aXZlCiogQHByb3BlcnR5IHtib29sZWFufSBhY3RpdmUgLSBJZiB0aGUgZ2FtZXBhZCBpbnB1dCBpcyBhY3RpdmUgb3Igbm90LgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdhbWVwYWQucHJvdG90eXBlLCAiYWN0aXZlIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9hY3RpdmU7CiAgICB9Cgp9KTsKCi8qKgoqIFdoZXRoZXIgb3Igbm90IGdhbWVwYWRzIGFyZSBzdXBwb3J0ZWQgaW4gY3VycmVudCBicm93c2VyLgoqIEBuYW1lIFBoYXNlci5HYW1lcGFkI3N1cHBvcnRlZAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gc3VwcG9ydGVkIC0gV2hldGhlciBvciBub3QgZ2FtZXBhZHMgYXJlIHN1cHBvcnRlZCBpbiBjdXJyZW50IGJyb3dzZXIuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR2FtZXBhZC5wcm90b3R5cGUsICJzdXBwb3J0ZWQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2dhbWVwYWRTdXBwb3J0QXZhaWxhYmxlOwogICAgfQoKfSk7CgovKioKKiBIb3cgbWFueSBsaXZlIGdhbWVwYWRzIGFyZSBjdXJyZW50bHkgY29ubmVjdGVkLgoqIEBuYW1lIFBoYXNlci5HYW1lcGFkI3BhZHNDb25uZWN0ZWQKKiBAcHJvcGVydHkge2Jvb2xlYW59IHBhZHNDb25uZWN0ZWQgLSBIb3cgbWFueSBsaXZlIGdhbWVwYWRzIGFyZSBjdXJyZW50bHkgY29ubmVjdGVkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdhbWVwYWQucHJvdG90eXBlLCAicGFkc0Nvbm5lY3RlZCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmF3UGFkcy5sZW5ndGg7CiAgICB9Cgp9KTsKCi8qKgoqIEdhbWVwYWQgIzEKKiBAbmFtZSBQaGFzZXIuR2FtZXBhZCNwYWQxCiogQHByb3BlcnR5IHtib29sZWFufSBwYWQxIC0gR2FtZXBhZCAjMTsKKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5HYW1lcGFkLnByb3RvdHlwZSwgInBhZDEiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2dhbWVwYWRzWzBdOwogICAgfQoKfSk7CgovKioKKiBHYW1lcGFkICMyCiogQG5hbWUgUGhhc2VyLkdhbWVwYWQjcGFkMgoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGFkMiAtIEdhbWVwYWQgIzIKKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5HYW1lcGFkLnByb3RvdHlwZSwgInBhZDIiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2dhbWVwYWRzWzFdOwogICAgfQoKfSk7CgovKioKKiBHYW1lcGFkICMzCiogQG5hbWUgUGhhc2VyLkdhbWVwYWQjcGFkMwoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGFkMyAtIEdhbWVwYWQgIzMKKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5HYW1lcGFkLnByb3RvdHlwZSwgInBhZDMiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2dhbWVwYWRzWzJdOwogICAgfQoKfSk7CgovKioKKiBHYW1lcGFkICM0CiogQG5hbWUgUGhhc2VyLkdhbWVwYWQjcGFkNAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGFkNCAtIEdhbWVwYWQgIzQKKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5HYW1lcGFkLnByb3RvdHlwZSwgInBhZDQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2dhbWVwYWRzWzNdOwogICAgfQoKfSk7CgpQaGFzZXIuR2FtZXBhZC5CVVRUT05fMCA9IDA7ClBoYXNlci5HYW1lcGFkLkJVVFRPTl8xID0gMTsKUGhhc2VyLkdhbWVwYWQuQlVUVE9OXzIgPSAyOwpQaGFzZXIuR2FtZXBhZC5CVVRUT05fMyA9IDM7ClBoYXNlci5HYW1lcGFkLkJVVFRPTl80ID0gNDsKUGhhc2VyLkdhbWVwYWQuQlVUVE9OXzUgPSA1OwpQaGFzZXIuR2FtZXBhZC5CVVRUT05fNiA9IDY7ClBoYXNlci5HYW1lcGFkLkJVVFRPTl83ID0gNzsKUGhhc2VyLkdhbWVwYWQuQlVUVE9OXzggPSA4OwpQaGFzZXIuR2FtZXBhZC5CVVRUT05fOSA9IDk7ClBoYXNlci5HYW1lcGFkLkJVVFRPTl8xMCA9IDEwOwpQaGFzZXIuR2FtZXBhZC5CVVRUT05fMTEgPSAxMTsKUGhhc2VyLkdhbWVwYWQuQlVUVE9OXzEyID0gMTI7ClBoYXNlci5HYW1lcGFkLkJVVFRPTl8xMyA9IDEzOwpQaGFzZXIuR2FtZXBhZC5CVVRUT05fMTQgPSAxNDsKUGhhc2VyLkdhbWVwYWQuQlVUVE9OXzE1ID0gMTU7CgpQaGFzZXIuR2FtZXBhZC5BWElTXzAgPSAwOwpQaGFzZXIuR2FtZXBhZC5BWElTXzEgPSAxOwpQaGFzZXIuR2FtZXBhZC5BWElTXzIgPSAyOwpQaGFzZXIuR2FtZXBhZC5BWElTXzMgPSAzOwpQaGFzZXIuR2FtZXBhZC5BWElTXzQgPSA0OwpQaGFzZXIuR2FtZXBhZC5BWElTXzUgPSA1OwpQaGFzZXIuR2FtZXBhZC5BWElTXzYgPSA2OwpQaGFzZXIuR2FtZXBhZC5BWElTXzcgPSA3OwpQaGFzZXIuR2FtZXBhZC5BWElTXzggPSA4OwpQaGFzZXIuR2FtZXBhZC5BWElTXzkgPSA5OwoKLy8gQmVsb3cgbWFwcGluZyBhcHBsaWVzIHRvIFhCT1ggMzYwIFdpcmVkIGFuZCBXaXJlbGVzcyBjb250cm9sbGVyIG9uIEdvb2dsZSBDaHJvbWUgKHRlc3RlZCBvbiBXaW5kb3dzIDcpLgovLyAtIEZpcmVmb3ggdXNlcyBkaWZmZXJlbnQgbWFwISBTZXBhcmF0ZSBhbW91bnQgb2YgYnV0dG9ucyBhbmQgYXhlcy4gRFBBRCA9IGF4aXMgYW5kIG5vdCBhIGJ1dHRvbi4KLy8gSW4gb3RoZXIgd29yZHMgLSBkaXNjcmVwYW5jaWVzIHdoZW4gdXNpbmcgZ2FtZXBhZHMuCgpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX0EgPSAwOwpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX0IgPSAxOwpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX1ggPSAyOwpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX1kgPSAzOwpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX0xFRlRfQlVNUEVSID0gNDsKUGhhc2VyLkdhbWVwYWQuWEJPWDM2MF9SSUdIVF9CVU1QRVIgPSA1OwpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX0xFRlRfVFJJR0dFUiA9IDY7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfUklHSFRfVFJJR0dFUiA9IDc7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfQkFDSyA9IDg7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfU1RBUlQgPSA5OwpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX1NUSUNLX0xFRlRfQlVUVE9OID0gMTA7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfU1RJQ0tfUklHSFRfQlVUVE9OID0gMTE7CgpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX0RQQURfTEVGVCA9IDE0OwpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX0RQQURfUklHSFQgPSAxNTsKUGhhc2VyLkdhbWVwYWQuWEJPWDM2MF9EUEFEX1VQID0gMTI7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfRFBBRF9ET1dOID0gMTM7CgpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX1NUSUNLX0xFRlRfWCA9IDA7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfU1RJQ0tfTEVGVF9ZID0gMTsKUGhhc2VyLkdhbWVwYWQuWEJPWDM2MF9TVElDS19SSUdIVF9YID0gMjsKUGhhc2VyLkdhbWVwYWQuWEJPWDM2MF9TVElDS19SSUdIVF9ZID0gMzsKCi8qKgoqIEBhdXRob3IgICAgICAgQGthcmxtYWNrbGluIDx0YWNrbGVtY2NsZWFuQGdtYWlsLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQGNsYXNzIFBoYXNlci5TaW5nbGVQYWQKKiBAY2xhc3NkZXNjIEEgc2luZ2xlIFBoYXNlciBHYW1lcGFkCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKiBAcGFyYW0ge09iamVjdH0gcGFkUGFyZW50IC0gVGhlIHBhcmVudCBQaGFzZXIuR2FtZXBhZCBvYmplY3QgKGFsbCBnYW1lcGFkcyByZXNpZGUgdW5kZXIgdGhpcykKKi8KUGhhc2VyLlNpbmdsZVBhZCA9IGZ1bmN0aW9uIChnYW1lLCBwYWRQYXJlbnQpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWVwYWR9IHBhZFBhcmVudCAtIE1haW4gUGhhc2VyIEdhbWVwYWQgb2JqZWN0CiAgICAqLwogICAgdGhpcy5fcGFkUGFyZW50ID0gcGFkUGFyZW50OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaW5kZXggLSBUaGUgZ2FtZXBhZCBpbmRleCBhcyBwZXIgYnJvd3NlcnMgZGF0YQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX2luZGV4ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtPYmplY3R9IF9yYXdQYWQgLSBUaGUgJ3JhdycgZ2FtZXBhZCBkYXRhLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3Jhd1BhZCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX2Nvbm5lY3RlZCAtIElzIHRoaXMgcGFkIGNvbm5lY3RlZCBvciBub3QuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fY29ubmVjdGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfcHJldlRpbWVzdGFtcCAtIFVzZWQgdG8gY2hlY2sgZm9yIGRpZmZlcmVuY2VzIGJldHdlZW4gZWFybGllciBwb2xscyBhbmQgY3VycmVudCBzdGF0ZSBvZiBnYW1lcGFkcy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9wcmV2VGltZXN0YW1wID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBcnJheX0gX3Jhd0J1dHRvbnMgLSBUaGUgJ3JhdycgYnV0dG9uIHN0YXRlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3Jhd0J1dHRvbnMgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBcnJheX0gX2J1dHRvbnMgLSBDdXJyZW50IFBoYXNlciBzdGF0ZSBvZiB0aGUgYnV0dG9ucy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9idXR0b25zID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7QXJyYXl9IF9heGVzIC0gQ3VycmVudCBheGVzIHN0YXRlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2F4ZXMgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBcnJheX0gX2hvdGtleXMgLSBIb3RrZXkgYnV0dG9ucy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9ob3RrZXlzID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCB1bmRlciB3aGljaCB0aGUgY2FsbGJhY2tzIGFyZSBydW4uCiAgICAqLwogICAgdGhpcy5jYWxsYmFja0NvbnRleHQgPSB0aGlzOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvbkNvbm5lY3RDYWxsYmFjayAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIHRoaXMgZ2FtZXBhZCBpcyBjb25uZWN0ZWQKICAgICovCiAgICB0aGlzLm9uQ29ubmVjdENhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25EaXNjb25uZWN0Q2FsbGJhY2sgLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSB0aGlzIGdhbWVwYWQgaXMgZGlzY29ubmVjdGVkCiAgICAqLwogICAgdGhpcy5vbkRpc2Nvbm5lY3RDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uRG93bkNhbGxiYWNrIC0gVGhpcyBjYWxsYmFjayBpcyBpbnZva2VkIGV2ZXJ5IHRpbWUgYSBidXR0b24gaXMgcHJlc3NlZCBkb3duLgogICAgKi8KICAgIHRoaXMub25Eb3duQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvblVwQ2FsbGJhY2sgLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhIGdhbWVwYWQgYnV0dG9uIGlzIHJlbGVhc2VkLgogICAgKi8KICAgIHRoaXMub25VcENhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25BeGlzQ2FsbGJhY2sgLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhbiBheGlzIGlzIGNoYW5nZWQuCiAgICAqLwogICAgdGhpcy5vbkF4aXNDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uRmxvYXRDYWxsYmFjayAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIGEgYnV0dG9uIGlzIGNoYW5nZWQgdG8gYSB2YWx1ZSB3aGVyZSB2YWx1ZSA+IDAgYW5kIHZhbHVlIDwgMS4KICAgICovCiAgICB0aGlzLm9uRmxvYXRDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkZWFkWm9uZSAtIERlYWQgem9uZSBmb3IgYXhpcyBmZWVkYmFjayAtIHdpdGhpbiB0aGlzIHZhbHVlIHlvdSB3b24ndCB0cmlnZ2VyIHVwZGF0ZXMuCiAgICAqLwogICAgdGhpcy5kZWFkWm9uZSA9IDAuMjY7Cgp9OwoKUGhhc2VyLlNpbmdsZVBhZC5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEFkZCBjYWxsYmFja3MgdG8gdGhlIHRoaXMgR2FtZXBhZCB0byBoYW5kbGUgY29ubmVjdC9kaXNjb25uZWN0L2J1dHRvbiBkb3duL2J1dHRvbiB1cC9heGlzIGNoYW5nZS9mbG9hdCB2YWx1ZSBidXR0b25zCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVwYWQjYWRkQ2FsbGJhY2tzCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IC0gVGhlIGNvbnRleHQgdW5kZXIgd2hpY2ggdGhlIGNhbGxiYWNrcyBhcmUgcnVuLgogICAgKiBAcGFyYW0ge09iamVjdH0gY2FsbGJhY2tzIC0gT2JqZWN0IHRoYXQgdGFrZXMgc2l4IGRpZmZlcmVudCBjYWxsYmFrIG1ldGhvZHM6CiAgICAqIG9uQ29ubmVjdENhbGxiYWNrLCBvbkRpc2Nvbm5lY3RDYWxsYmFjaywgb25Eb3duQ2FsbGJhY2ssIG9uVXBDYWxsYmFjaywgb25BeGlzQ2FsbGJhY2ssIG9uRmxvYXRDYWxsYmFjawogICAgKi8KICAgIGFkZENhbGxiYWNrczogZnVuY3Rpb24gKGNvbnRleHQsIGNhbGxiYWNrcykgewoKICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrcyAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uQ29ubmVjdENhbGxiYWNrID0gKHR5cGVvZiBjYWxsYmFja3Mub25Db25uZWN0ID09PSAnZnVuY3Rpb24nKSA/IGNhbGxiYWNrcy5vbkNvbm5lY3QgOiB0aGlzLm9uQ29ubmVjdENhbGxiYWNrOwogICAgICAgICAgICB0aGlzLm9uRGlzY29ubmVjdENhbGxiYWNrID0gKHR5cGVvZiBjYWxsYmFja3Mub25EaXNjb25uZWN0ID09PSAnZnVuY3Rpb24nKSA/IGNhbGxiYWNrcy5vbkRpc2Nvbm5lY3QgOiB0aGlzLm9uRGlzY29ubmVjdENhbGxiYWNrOwogICAgICAgICAgICB0aGlzLm9uRG93bkNhbGxiYWNrID0gKHR5cGVvZiBjYWxsYmFja3Mub25Eb3duID09PSAnZnVuY3Rpb24nKSA/IGNhbGxiYWNrcy5vbkRvd24gOiB0aGlzLm9uRG93bkNhbGxiYWNrOwogICAgICAgICAgICB0aGlzLm9uVXBDYWxsYmFjayA9ICh0eXBlb2YgY2FsbGJhY2tzLm9uVXAgPT09ICdmdW5jdGlvbicpID8gY2FsbGJhY2tzLm9uVXAgOiB0aGlzLm9uVXBDYWxsYmFjazsKICAgICAgICAgICAgdGhpcy5vbkF4aXNDYWxsYmFjayA9ICh0eXBlb2YgY2FsbGJhY2tzLm9uQXhpcyA9PT0gJ2Z1bmN0aW9uJykgPyBjYWxsYmFja3Mub25BeGlzIDogdGhpcy5vbkF4aXNDYWxsYmFjazsKICAgICAgICAgICAgdGhpcy5vbkZsb2F0Q2FsbGJhY2sgPSAodHlwZW9mIGNhbGxiYWNrcy5vbkZsb2F0ID09PSAnZnVuY3Rpb24nKSA/IGNhbGxiYWNrcy5vbkZsb2F0IDogdGhpcy5vbkZsb2F0Q2FsbGJhY2s7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIElmIHlvdSBuZWVkIG1vcmUgZmluZS1ncmFpbmVkIGNvbnRyb2wgb3ZlciBhIEtleSB5b3UgY2FuIGNyZWF0ZSBhIG5ldyBQaGFzZXIuS2V5IG9iamVjdCB2aWEgdGhpcyBtZXRob2QuCiAgICAqIFRoZSBLZXkgb2JqZWN0IGNhbiB0aGVuIGJlIHBvbGxlZCwgaGF2ZSBldmVudHMgYXR0YWNoZWQgdG8gaXQsIGV0Yy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuU2luZ2xlUGFkI2FkZEJ1dHRvbgogICAgKiBAcGFyYW0ge251bWJlcn0gYnV0dG9uQ29kZSAtIFRoZSBidXR0b25Db2RlIG9mIHRoZSBidXR0b24sIGkuZS4gUGhhc2VyLkdhbWVwYWQuQlVUVE9OXzAgb3IgUGhhc2VyLkdhbWVwYWQuQlVUVE9OXzEKICAgICogQHJldHVybiB7UGhhc2VyLkdhbWVwYWRCdXR0b259IFRoZSBHYW1lcGFkQnV0dG9uIG9iamVjdCB3aGljaCB5b3UgY2FuIHN0b3JlIGxvY2FsbHkgYW5kIHJlZmVyZW5jZSBkaXJlY3RseS4KICAgICovCiAgICBhZGRCdXR0b246IGZ1bmN0aW9uIChidXR0b25Db2RlKSB7CgogICAgICAgIHRoaXMuX2hvdGtleXNbYnV0dG9uQ29kZV0gPSBuZXcgUGhhc2VyLkdhbWVwYWRCdXR0b24odGhpcy5nYW1lLCBidXR0b25Db2RlKTsKICAgICAgICByZXR1cm4gdGhpcy5faG90a2V5c1tidXR0b25Db2RlXTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNYWluIHVwZGF0ZSBmdW5jdGlvbiwgc2hvdWxkIGJlIGNhbGxlZCBieSBQaGFzZXIuR2FtZXBhZAogICAgKiBAbWV0aG9kIFBoYXNlci5TaW5nbGVQYWQjcG9sbFN0YXR1cwogICAgKi8KICAgIHBvbGxTdGF0dXM6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX3Jhd1BhZC50aW1lc3RhbXAgJiYgKHRoaXMuX3Jhd1BhZC50aW1lc3RhbXAgPT0gdGhpcy5fcHJldlRpbWVzdGFtcCkpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3Jhd1BhZC5idXR0b25zLmxlbmd0aDsgaSArPSAxKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGJ1dHRvblZhbHVlID0gdGhpcy5fcmF3UGFkLmJ1dHRvbnNbaV07CgogICAgICAgICAgICBpZiAodGhpcy5fcmF3QnV0dG9uc1tpXSAhPT0gYnV0dG9uVmFsdWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChidXR0b25WYWx1ZSA9PT0gMSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NCdXR0b25Eb3duKGksIGJ1dHRvblZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGJ1dHRvblZhbHVlID09PSAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc0J1dHRvblVwKGksIGJ1dHRvblZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NCdXR0b25GbG9hdChpLCBidXR0b25WYWx1ZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fcmF3QnV0dG9uc1tpXSA9IGJ1dHRvblZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgYXhlcyA9IHRoaXMuX3Jhd1BhZC5heGVzOwoKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGF4ZXMubGVuZ3RoOyBqICs9IDEpCiAgICAgICAgewogICAgICAgICAgICB2YXIgYXhpcyA9IGF4ZXNbal07CgogICAgICAgICAgICBpZiAoYXhpcyA+IDAgJiYgYXhpcyA+IHRoaXMuZGVhZFpvbmUgfHwgYXhpcyA8IDAgJiYgYXhpcyA8IC10aGlzLmRlYWRab25lKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NBeGlzQ2hhbmdlKHtheGlzOiBqLCB2YWx1ZTogYXhpc30pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzQXhpc0NoYW5nZSh7YXhpczogaiwgdmFsdWU6IDB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5fcHJldlRpbWVzdGFtcCA9IHRoaXMuX3Jhd1BhZC50aW1lc3RhbXA7CgogICAgfSwKCiAgICAvKioKICAgICogR2FtZXBhZCBjb25uZWN0IGZ1bmN0aW9uLCBzaG91bGQgYmUgY2FsbGVkIGJ5IFBoYXNlci5HYW1lcGFkCiAgICAqIEBwYXJhbSB7T2JqZWN0fSByYXdQYWQgLSBUaGUgcmF3IGdhbWVwYWQgb2JqZWN0CiAgICAqIEBtZXRob2QgUGhhc2VyLlNpbmdsZVBhZCNjb25uZWN0CiAgICAqLwogICAgY29ubmVjdDogZnVuY3Rpb24gKHJhd1BhZCkgewoKICAgICAgICB2YXIgdHJpZ2dlckNhbGxiYWNrID0gIXRoaXMuX2Nvbm5lY3RlZDsKCiAgICAgICAgdGhpcy5faW5kZXggPSByYXdQYWQuaW5kZXg7CiAgICAgICAgdGhpcy5fY29ubmVjdGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLl9yYXdQYWQgPSByYXdQYWQ7CiAgICAgICAgdGhpcy5fcmF3QnV0dG9ucyA9IHJhd1BhZC5idXR0b25zOwogICAgICAgIHRoaXMuX2F4ZXMgPSByYXdQYWQuYXhlczsKCiAgICAgICAgaWYgKHRyaWdnZXJDYWxsYmFjayAmJiB0aGlzLl9wYWRQYXJlbnQub25Db25uZWN0Q2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wYWRQYXJlbnQub25Db25uZWN0Q2FsbGJhY2suY2FsbCh0aGlzLl9wYWRQYXJlbnQuY2FsbGJhY2tDb250ZXh0LCB0aGlzLl9pbmRleCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodHJpZ2dlckNhbGxiYWNrICYmIHRoaXMub25Db25uZWN0Q2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uQ29ubmVjdENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBHYW1lcGFkIGRpc2Nvbm5lY3QgZnVuY3Rpb24sIHNob3VsZCBiZSBjYWxsZWQgYnkgUGhhc2VyLkdhbWVwYWQKICAgICogQG1ldGhvZCBQaGFzZXIuU2luZ2xlUGFkI2Rpc2Nvbm5lY3QKICAgICovCiAgICBkaXNjb25uZWN0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciB0cmlnZ2VyQ2FsbGJhY2sgPSB0aGlzLl9jb25uZWN0ZWQ7CiAgICAgICAgdGhpcy5fY29ubmVjdGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5fcmF3UGFkID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMuX3Jhd0J1dHRvbnMgPSBbXTsKICAgICAgICB0aGlzLl9idXR0b25zID0gW107CiAgICAgICAgdmFyIGRpc2Nvbm5lY3RpbmdJbmRleCA9IHRoaXMuX2luZGV4OwogICAgICAgIHRoaXMuX2luZGV4ID0gbnVsbDsKCiAgICAgICAgaWYgKHRyaWdnZXJDYWxsYmFjayAmJiB0aGlzLl9wYWRQYXJlbnQub25EaXNjb25uZWN0Q2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wYWRQYXJlbnQub25EaXNjb25uZWN0Q2FsbGJhY2suY2FsbCh0aGlzLl9wYWRQYXJlbnQuY2FsbGJhY2tDb250ZXh0LCBkaXNjb25uZWN0aW5nSW5kZXgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRyaWdnZXJDYWxsYmFjayAmJiB0aGlzLm9uRGlzY29ubmVjdENhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vbkRpc2Nvbm5lY3RDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSGFuZGxlcyBjaGFuZ2VzIGluIGF4aXMKICAgICogQHBhcmFtIHtPYmplY3R9IGF4aXNTdGF0ZSAtIFN0YXRlIG9mIHRoZSByZWxldmFudCBheGlzCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpbmdsZVBhZCNwcm9jZXNzQXhpc0NoYW5nZQogICAgKi8KICAgIHByb2Nlc3NBeGlzQ2hhbmdlOiBmdW5jdGlvbiAoYXhpc1N0YXRlKSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5nYW1lLmlucHV0LmdhbWVwYWQuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fYXhlc1theGlzU3RhdGUuYXhpc10gPT09IGF4aXNTdGF0ZS52YWx1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2F4ZXNbYXhpc1N0YXRlLmF4aXNdID0gYXhpc1N0YXRlLnZhbHVlOwogICAgICAgIAogICAgICAgIGlmICh0aGlzLl9wYWRQYXJlbnQub25BeGlzQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wYWRQYXJlbnQub25BeGlzQ2FsbGJhY2suY2FsbCh0aGlzLl9wYWRQYXJlbnQuY2FsbGJhY2tDb250ZXh0LCBheGlzU3RhdGUsIHRoaXMuX2luZGV4KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm9uQXhpc0NhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vbkF4aXNDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBheGlzU3RhdGUpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBIYW5kbGVzIGJ1dHRvbiBkb3duIHByZXNzCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBidXR0b25Db2RlIC0gV2hpY2ggYnV0dG9uQ29kZSBvZiB0aGlzIGJ1dHRvbgogICAgKiBAcGFyYW0ge09iamVjdH0gdmFsdWUgLSBCdXR0b24gdmFsdWUKICAgICogQG1ldGhvZCBQaGFzZXIuU2luZ2xlUGFkI3Byb2Nlc3NCdXR0b25Eb3duCiAgICAqLwogICAgcHJvY2Vzc0J1dHRvbkRvd246IGZ1bmN0aW9uIChidXR0b25Db2RlLCB2YWx1ZSkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZ2FtZS5pbnB1dC5nYW1lcGFkLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX3BhZFBhcmVudC5vbkRvd25DYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BhZFBhcmVudC5vbkRvd25DYWxsYmFjay5jYWxsKHRoaXMuX3BhZFBhcmVudC5jYWxsYmFja0NvbnRleHQsIGJ1dHRvbkNvZGUsIHZhbHVlLCB0aGlzLl9pbmRleCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5vbkRvd25DYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25Eb3duQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgYnV0dG9uQ29kZSwgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0gJiYgdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXS5pc0Rvd24pCiAgICAgICAgewogICAgICAgICAgICAvLyAgS2V5IGFscmVhZHkgZG93biBhbmQgc3RpbGwgZG93biwgc28gdXBkYXRlCiAgICAgICAgICAgIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0uZHVyYXRpb24gPSB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdLnRpbWVEb3duOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoIXRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBOb3QgdXNlZCB0aGlzIGJ1dHRvbiBiZWZvcmUsIHNvIHJlZ2lzdGVyIGl0CiAgICAgICAgICAgICAgICB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdID0gewogICAgICAgICAgICAgICAgICAgIGlzRG93bjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICB0aW1lRG93bjogdGhpcy5nYW1lLnRpbWUubm93LAogICAgICAgICAgICAgICAgICAgIHRpbWVVcDogMCwKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMCwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgQnV0dG9uIHVzZWQgYmVmb3JlIGJ1dCBmcmVzaGx5IGRvd24KICAgICAgICAgICAgICAgIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0uaXNEb3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0udGltZURvd24gPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgICAgICB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdLmR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0udmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2hvdGtleXNbYnV0dG9uQ29kZV0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9ob3RrZXlzW2J1dHRvbkNvZGVdLnByb2Nlc3NCdXR0b25Eb3duKHZhbHVlKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSGFuZGxlcyBidXR0b24gcmVsZWFzZQogICAgKiBAcGFyYW0ge251bWJlcn0gYnV0dG9uQ29kZSAtIFdoaWNoIGJ1dHRvbkNvZGUgb2YgdGhpcyBidXR0b24KICAgICogQHBhcmFtIHtPYmplY3R9IHZhbHVlIC0gQnV0dG9uIHZhbHVlCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpbmdsZVBhZCNwcm9jZXNzQnV0dG9uVXAKICAgICovCiAgICBwcm9jZXNzQnV0dG9uVXA6IGZ1bmN0aW9uIChidXR0b25Db2RlLCB2YWx1ZSkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZ2FtZS5pbnB1dC5nYW1lcGFkLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX3BhZFBhcmVudC5vblVwQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wYWRQYXJlbnQub25VcENhbGxiYWNrLmNhbGwodGhpcy5fcGFkUGFyZW50LmNhbGxiYWNrQ29udGV4dCwgYnV0dG9uQ29kZSwgdmFsdWUsIHRoaXMuX2luZGV4KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm9uVXBDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25VcENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGJ1dHRvbkNvZGUsIHZhbHVlKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9ob3RrZXlzW2J1dHRvbkNvZGVdKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faG90a2V5c1tidXR0b25Db2RlXS5wcm9jZXNzQnV0dG9uVXAodmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdLmlzRG93biA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdLnRpbWVVcCA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXS52YWx1ZSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgTm90IHVzZWQgdGhpcyBidXR0b24gYmVmb3JlLCBzbyByZWdpc3RlciBpdAogICAgICAgICAgICB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdID0gewogICAgICAgICAgICAgICAgaXNEb3duOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVEb3duOiB0aGlzLmdhbWUudGltZS5ub3csCiAgICAgICAgICAgICAgICB0aW1lVXA6IHRoaXMuZ2FtZS50aW1lLm5vdywKICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAwLAogICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlCiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEhhbmRsZXMgYnV0dG9ucyB3aXRoIGZsb2F0aW5nIHZhbHVlcyAobGlrZSBhbmFsb2cgYnV0dG9ucyB0aGF0IGFjdHMgYWxtb3N0IGxpa2UgYW4gYXhpcyBidXQgc3RpbGwgcmVnaXN0ZXJzIGxpa2UgYSBidXR0b24pCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBidXR0b25Db2RlIC0gV2hpY2ggYnV0dG9uQ29kZSBvZiB0aGlzIGJ1dHRvbgogICAgKiBAcGFyYW0ge09iamVjdH0gdmFsdWUgLSBCdXR0b24gdmFsdWUgKHdpbGwgcmFuZ2Ugc29tZXdoZXJlIGJldHdlZW4gMCBhbmQgMSwgYnV0IG5vdCBzcGVjaWZpY2FsbHkgMCBvciAxLgogICAgKiBAbWV0aG9kIFBoYXNlci5TaW5nbGVQYWQjcHJvY2Vzc0J1dHRvbkZsb2F0CiAgICAqLwogICAgcHJvY2Vzc0J1dHRvbkZsb2F0OiBmdW5jdGlvbiAoYnV0dG9uQ29kZSwgdmFsdWUpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmdhbWUuaW5wdXQuZ2FtZXBhZC5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9wYWRQYXJlbnQub25GbG9hdENhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcGFkUGFyZW50Lm9uRmxvYXRDYWxsYmFjay5jYWxsKHRoaXMuX3BhZFBhcmVudC5jYWxsYmFja0NvbnRleHQsIGJ1dHRvbkNvZGUsIHZhbHVlLCB0aGlzLl9pbmRleCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5vbkZsb2F0Q2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uRmxvYXRDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBidXR0b25Db2RlLCB2YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0pCiAgICAgICAgewogICAgICAgICAgICAvLyAgTm90IHVzZWQgdGhpcyBidXR0b24gYmVmb3JlLCBzbyByZWdpc3RlciBpdAogICAgICAgICAgICB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdID0geyB2YWx1ZTogdmFsdWUgfTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIEJ1dHRvbiB1c2VkIGJlZm9yZSBidXQgZnJlc2hseSBkb3duCiAgICAgICAgICAgIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0udmFsdWUgPSB2YWx1ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9ob3RrZXlzW2J1dHRvbkNvZGVdKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faG90a2V5c1tidXR0b25Db2RlXS5wcm9jZXNzQnV0dG9uRmxvYXQodmFsdWUpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHZhbHVlIG9mIHJlcXVlc3RlZCBheGlzCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpbmdsZVBhZCNpc0Rvd24KICAgICogQHBhcmFtIHtudW1iZXJ9IGF4aXNDb2RlIC0gVGhlIGluZGV4IG9mIHRoZSBheGlzIHRvIGNoZWNrCiAgICAqIEByZXR1cm4ge251bWJlcn0gQXhpcyB2YWx1ZSBpZiBhdmFpbGFibGUgb3RoZXJ3aXNlIGZhbHNlCiAgICAqLwogICAgYXhpczogZnVuY3Rpb24gKGF4aXNDb2RlKSB7CgogICAgICAgIGlmICh0aGlzLl9heGVzW2F4aXNDb2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9heGVzW2F4aXNDb2RlXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGJ1dHRvbiBpcyBjdXJyZW50bHkgcHJlc3NlZCBkb3duLgogICAgKiBAbWV0aG9kIFBoYXNlci5TaW5nbGVQYWQjaXNEb3duCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBidXR0b25Db2RlIC0gVGhlIGJ1dHRvbkNvZGUgb2YgdGhlIGtleSB0byBjaGVjay4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUga2V5IGlzIGN1cnJlbnRseSBkb3duLgogICAgKi8KICAgIGlzRG93bjogZnVuY3Rpb24gKGJ1dHRvbkNvZGUpIHsKCiAgICAgICAgaWYgKHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXS5pc0Rvd247CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgImp1c3QgcmVsZWFzZWQiIHN0YXRlIG9mIGEgYnV0dG9uIGZyb20gdGhpcyBnYW1lcGFkLiBKdXN0IHJlbGVhc2VkIGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcgdHJ1ZSBpZiB0aGUgYnV0dG9uIHdhcyByZWxlYXNlZCB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuIChkZWZhdWx0IDI1MG1zKS4KICAgICogQG1ldGhvZCBQaGFzZXIuU2luZ2xlUGFkI2p1c3RQcmVzc2VkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBidXR0b25Db2RlIC0gVGhlIGJ1dHRvbkNvZGUgb2YgdGhlIGJ1dHRvbiB0byBjaGVjayBmb3IuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZHVyYXRpb249MjUwXSAtIFRoZSBkdXJhdGlvbiBiZWxvdyB3aGljaCB0aGUgYnV0dG9uIGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcganVzdCByZWxlYXNlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgYnV0dG9uIGlzIGp1c3QgcmVsZWFzZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGp1c3RSZWxlYXNlZDogZnVuY3Rpb24gKGJ1dHRvbkNvZGUsIGR1cmF0aW9uKSB7CgogICAgICAgIGlmICh0eXBlb2YgZHVyYXRpb24gPT09ICJ1bmRlZmluZWQiKSB7IGR1cmF0aW9uID0gMjUwOyB9CgogICAgICAgIHJldHVybiAodGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXSAmJiB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdLmlzRG93biA9PT0gZmFsc2UgJiYgKHRoaXMuZ2FtZS50aW1lLm5vdyAtIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0udGltZVVwIDwgZHVyYXRpb24pKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSAianVzdCBwcmVzc2VkIiBzdGF0ZSBvZiBhIGJ1dHRvbiBmcm9tIHRoaXMgZ2FtZXBhZC4gSnVzdCBwcmVzc2VkIGlzIGNvbnNpZGVyZWQgdHJ1ZSBpZiB0aGUgYnV0dG9uIHdhcyBwcmVzc2VkIGRvd24gd2l0aGluIHRoZSBkdXJhdGlvbiBnaXZlbiAoZGVmYXVsdCAyNTBtcykuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpbmdsZVBhZCNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge251bWJlcn0gYnV0dG9uQ29kZSAtIFRoZSBidXR0b25Db2RlIG9mIHRoZSBidXR0b24gdG8gY2hlY2sgZm9yLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2R1cmF0aW9uPTI1MF0gLSBUaGUgZHVyYXRpb24gYmVsb3cgd2hpY2ggdGhlIGJ1dHRvbiBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIGp1c3QgcHJlc3NlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgYnV0dG9uIGlzIGp1c3QgcHJlc3NlZCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAganVzdFByZXNzZWQ6IGZ1bmN0aW9uIChidXR0b25Db2RlLCBkdXJhdGlvbikgewoKICAgICAgICBpZiAodHlwZW9mIGR1cmF0aW9uID09PSAidW5kZWZpbmVkIikgeyBkdXJhdGlvbiA9IDI1MDsgfQoKICAgICAgICByZXR1cm4gKHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0gJiYgdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXS5pc0Rvd24gJiYgdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXS5kdXJhdGlvbiA8IGR1cmF0aW9uKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiBhIGdhbWVwYWQgYnV0dG9uLiBJbnRlbmRlZCBtYWlubHkgZm9yIGNhc2VzIHdoZW4geW91IGhhdmUgZmxvYXRpbmcgYnV0dG9uIHZhbHVlcywgZm9yIGV4YW1wbGUKICAgICogYW5hbG9nIHRyaWdnZXIgYnV0dG9ucyBvbiB0aGUgWEJPWCAzNjAgY29udHJvbGxlcgogICAgKiBAbWV0aG9kIFBoYXNlci5TaW5nbGVQYWQjYnV0dG9uVmFsdWUKICAgICogQHBhcmFtIHtudW1iZXJ9IGJ1dHRvbkNvZGUgLSBUaGUgYnV0dG9uQ29kZSBvZiB0aGUgYnV0dG9uIHRvIGNoZWNrLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBCdXR0b24gdmFsdWUgaWYgYXZhaWxhYmxlIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBidXR0b25WYWx1ZTogZnVuY3Rpb24gKGJ1dHRvbkNvZGUpIHsKCiAgICAgICAgaWYgKHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXS52YWx1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXNldCBhbGwgYnV0dG9ucy9heGVzIG9mIHRoaXMgZ2FtZXBhZAogICAgKiBAbWV0aG9kIFBoYXNlci5TaW5nbGVQYWQjcmVzZXQKICAgICovCiAgICByZXNldDogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2J1dHRvbnMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9idXR0b25zW2ldID0gMDsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdGhpcy5fYXhlcy5sZW5ndGg7IGorKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2F4ZXNbal0gPSAwOwogICAgICAgIH0KCiAgICB9Cgp9OwoKUGhhc2VyLlNpbmdsZVBhZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuU2luZ2xlUGFkOwoKLyoqCiAqIFdoZXRoZXIgb3Igbm90IHRoaXMgcGFydGljdWxhciBnYW1lcGFkIGlzIGNvbm5lY3RlZCBvciBub3QuCiAqIEBuYW1lIFBoYXNlci5TaW5nbGVQYWQjY29ubmVjdGVkCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29ubmVjdGVkIC0gV2hldGhlciBvciBub3QgdGhpcyBwYXJ0aWN1bGFyIGdhbWVwYWQgaXMgY29ubmVjdGVkIG9yIG5vdC4KICogQHJlYWRvbmx5CiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNpbmdsZVBhZC5wcm90b3R5cGUsICJjb25uZWN0ZWQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3RlZDsKICAgIH0KCn0pOwoKLyoqCiAqIEdhbWVwYWQgaW5kZXggYXMgcGVyIGJyb3dzZXIgZGF0YQogKiBAbmFtZSBQaGFzZXIuU2luZ2xlUGFkI2luZGV4CiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpbmRleCAtIFRoZSBnYW1lcGFkIGluZGV4LCB1c2VkIHRvIGlkZW50aWZ5IHNwZWNpZmljIGdhbWVwYWRzIGluIHRoZSBicm93c2VyCiAqIEByZWFkb25seQogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TaW5nbGVQYWQucHJvdG90eXBlLCAiaW5kZXgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2luZGV4OwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIEBrYXJsbWFja2xpbiA8dGFja2xlbWNjbGVhbkBnbWFpbC5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEBjbGFzcyBQaGFzZXIuR2FtZXBhZEJ1dHRvbgoqIEBjbGFzc2Rlc2MgSWYgeW91IG5lZWQgbW9yZSBmaW5lLWdyYWluZWQgY29udHJvbCBvdmVyIHRoZSBoYW5kbGluZyBvZiBzcGVjaWZpYyBidXR0b25zIHlvdSBjYW4gY3JlYXRlIGFuZCB1c2UgUGhhc2VyLkdhbWVwYWRCdXR0b24gb2JqZWN0cy4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7bnVtYmVyfSBidXR0b25jb2RlIC0gVGhlIGJ1dHRvbiBjb2RlIHRoaXMgR2FtZXBhZEJ1dHRvbiBpcyByZXNwb25zaWJsZSBmb3IuCiovClBoYXNlci5HYW1lcGFkQnV0dG9uID0gZnVuY3Rpb24gKGdhbWUsIGJ1dHRvbmNvZGUpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNEb3duIC0gVGhlICJkb3duIiBzdGF0ZSBvZiB0aGUgYnV0dG9uLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNEb3duID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNVcCAtIFRoZSAidXAiIHN0YXRlIG9mIHRoZSBidXR0b24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc1VwID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lRG93biAtIFRoZSB0aW1lc3RhbXAgd2hlbiB0aGUgYnV0dG9uIHdhcyBsYXN0IHByZXNzZWQgZG93bi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRpbWVEb3duID0gMDsKCiAgICAvKioKICAgICogSWYgdGhlIGJ1dHRvbiBpcyBkb3duIHRoaXMgdmFsdWUgaG9sZHMgdGhlIGR1cmF0aW9uIG9mIHRoYXQgYnV0dG9uIHByZXNzIGFuZCBpcyBjb25zdGFudGx5IHVwZGF0ZWQuCiAgICAqIElmIHRoZSBidXR0b24gaXMgdXAgaXQgaG9sZHMgdGhlIGR1cmF0aW9uIG9mIHRoZSBwcmV2aW91cyBkb3duIHNlc3Npb24uCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkdXJhdGlvbiAtIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRoaXMgYnV0dG9uIGhhcyBiZWVuIGhlbGQgZG93biBmb3IuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kdXJhdGlvbiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lVXAgLSBUaGUgdGltZXN0YW1wIHdoZW4gdGhlIGJ1dHRvbiB3YXMgbGFzdCByZWxlYXNlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRpbWVVcCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZXBlYXRzIC0gSWYgYSBidXR0b24gaXMgaGVsZCBkb3duIHRoaXMgaG9sZHMgZG93biB0aGUgbnVtYmVyIG9mIHRpbWVzIHRoZSBidXR0b24gaGFzICdyZXBlYXRlZCcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5yZXBlYXRzID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHZhbHVlIC0gQnV0dG9uIHZhbHVlLiBNYWlubHkgdXNlZnVsIGZvciBjaGVja2luZyBhbmFsb2cgYnV0dG9ucyAobGlrZSBzaG91bGRlciB0cmlnZ2VycykKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnZhbHVlID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGJ1dHRvbkNvZGUgLSBUaGUgYnV0dG9uY29kZSBvZiB0aGlzIGJ1dHRvbi4KICAgICovCiAgICB0aGlzLmJ1dHRvbkNvZGUgPSBidXR0b25jb2RlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uRG93biAtIFRoaXMgU2lnbmFsIGlzIGRpc3BhdGNoZWQgZXZlcnkgdGltZSB0aGlzIEdhbWVwYWRCdXR0b24gaXMgcHJlc3NlZCBkb3duLiBJdCBpcyBvbmx5IGRpc3BhdGNoZWQgb25jZSAodW50aWwgdGhlIGJ1dHRvbiBpcyByZWxlYXNlZCBhZ2FpbikuCiAgICAqLwogICAgdGhpcy5vbkRvd24gPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uVXAgLSBUaGlzIFNpZ25hbCBpcyBkaXNwYXRjaGVkIGV2ZXJ5IHRpbWUgdGhpcyBHYW1lcGFkQnV0dG9uIGlzIHByZXNzZWQgZG93bi4gSXQgaXMgb25seSBkaXNwYXRjaGVkIG9uY2UgKHVudGlsIHRoZSBidXR0b24gaXMgcmVsZWFzZWQgYWdhaW4pLgogICAgKi8KICAgIHRoaXMub25VcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25GbG9hdCAtIFRoaXMgU2lnbmFsIGlzIGRpc3BhdGNoZWQgZXZlcnkgdGltZSB0aGlzIEdhbWVwYWRCdXR0b24gY2hhbmdlcyBmbG9hdGluZyB2YWx1ZSAoYmV0d2VlbiAoYnV0IG5vdCBleGFjdGx5KSAwIGFuZCAxKQogICAgKi8KICAgIHRoaXMub25GbG9hdCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7Cgp9OwoKUGhhc2VyLkdhbWVwYWRCdXR0b24ucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBDYWxsZWQgYXV0b21hdGljYWxseSBieSBQaGFzZXIuU2luZ2xlUGFkLgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lcGFkQnV0dG9uI3Byb2Nlc3NCdXR0b25Eb3duCiAgICAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZSAtIEJ1dHRvbiB2YWx1ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcHJvY2Vzc0J1dHRvbkRvd246IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodGhpcy5pc0Rvd24pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy50aW1lRG93bjsKICAgICAgICAgICAgdGhpcy5yZXBlYXRzKys7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuaXNEb3duID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pc1VwID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMudGltZURvd24gPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgIHRoaXMuZHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLnJlcGVhdHMgPSAwOwogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CgogICAgICAgICAgICB0aGlzLm9uRG93bi5kaXNwYXRjaCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IFBoYXNlci5TaW5nbGVQYWQuCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVwYWRCdXR0b24jcHJvY2Vzc0J1dHRvblVwCiAgICAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZSAtIEJ1dHRvbiB2YWx1ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcHJvY2Vzc0J1dHRvblVwOiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdGhpcy5pc0Rvd24gPSBmYWxzZTsKICAgICAgICB0aGlzLmlzVXAgPSB0cnVlOwogICAgICAgIHRoaXMudGltZVVwID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKCiAgICAgICAgdGhpcy5vblVwLmRpc3BhdGNoKHRoaXMsIHZhbHVlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgYXV0b21hdGljYWxseSBieSBQaGFzZXIuR2FtZXBhZC4KICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZEJ1dHRvbiNwcm9jZXNzQnV0dG9uRmxvYXQKICAgICogQHBhcmFtIHtPYmplY3R9IHZhbHVlIC0gQnV0dG9uIHZhbHVlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwcm9jZXNzQnV0dG9uRmxvYXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgdGhpcy5vbkZsb2F0LmRpc3BhdGNoKHRoaXMsIHZhbHVlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSAianVzdCBwcmVzc2VkIiBzdGF0ZSBvZiB0aGlzIGJ1dHRvbi4gSnVzdCBwcmVzc2VkIGlzIGNvbnNpZGVyZWQgdHJ1ZSBpZiB0aGUgYnV0dG9uIHdhcyBwcmVzc2VkIGRvd24gd2l0aGluIHRoZSBkdXJhdGlvbiBnaXZlbiAoZGVmYXVsdCAyNTBtcykuCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVwYWRCdXR0b24janVzdFByZXNzZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbj0yNTBdIC0gVGhlIGR1cmF0aW9uIGJlbG93IHdoaWNoIHRoZSBidXR0b24gaXMgY29uc2lkZXJlZCBhcyBiZWluZyBqdXN0IHByZXNzZWQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGJ1dHRvbiBpcyBqdXN0IHByZXNzZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGp1c3RQcmVzc2VkOiBmdW5jdGlvbiAoZHVyYXRpb24pIHsKCiAgICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gInVuZGVmaW5lZCIpIHsgZHVyYXRpb24gPSAyNTA7IH0KCiAgICAgICAgcmV0dXJuICh0aGlzLmlzRG93biAmJiB0aGlzLmR1cmF0aW9uIDwgZHVyYXRpb24pOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlICJqdXN0IHJlbGVhc2VkIiBzdGF0ZSBvZiB0aGlzIGJ1dHRvbi4gSnVzdCByZWxlYXNlZCBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIHRydWUgaWYgdGhlIGJ1dHRvbiB3YXMgcmVsZWFzZWQgd2l0aGluIHRoZSBkdXJhdGlvbiBnaXZlbiAoZGVmYXVsdCAyNTBtcykuCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVwYWRCdXR0b24janVzdFByZXNzZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbj0yNTBdIC0gVGhlIGR1cmF0aW9uIGJlbG93IHdoaWNoIHRoZSBidXR0b24gaXMgY29uc2lkZXJlZCBhcyBiZWluZyBqdXN0IHJlbGVhc2VkLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBidXR0b24gaXMganVzdCBwcmVzc2VkIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBqdXN0UmVsZWFzZWQ6IGZ1bmN0aW9uIChkdXJhdGlvbikgewoKICAgICAgICBpZiAodHlwZW9mIGR1cmF0aW9uID09PSAidW5kZWZpbmVkIikgeyBkdXJhdGlvbiA9IDI1MDsgfQoKICAgICAgICByZXR1cm4gKHRoaXMuaXNEb3duID09PSBmYWxzZSAmJiAodGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy50aW1lVXAgPCBkdXJhdGlvbikpOwogICAgfQoKfTsKClBoYXNlci5HYW1lcGFkQnV0dG9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5HYW1lcGFkQnV0dG9uOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQGNsYXNzIFBoYXNlci5FdmVudHMKKgoqIEBjbGFzc2Rlc2MgVGhlIEV2ZW50cyBjb21wb25lbnQgaXMgYSBjb2xsZWN0aW9uIG9mIGV2ZW50cyBmaXJlZCBieSB0aGUgcGFyZW50IGdhbWUgb2JqZWN0LgoqCiogRm9yIGV4YW1wbGUgdG8gdGVsbCB3aGVuIGEgU3ByaXRlIGhhcyBiZWVuIGFkZGVkIHRvIGEgbmV3IGdyb3VwOgoqCiogYGBgc3ByaXRlLmV2ZW50cy5vbkFkZGVkVG9Hcm91cC5hZGQoeW91ckZ1bmN0aW9uLCB0aGlzKTtgYGAKKgoqIFdoZXJlIGB5b3VyRnVuY3Rpb25gIGlzIHRoZSBmdW5jdGlvbiB5b3Ugd2FudCBjYWxsZWQgd2hlbiB0aGlzIGV2ZW50IG9jY3Vycy4KKgoqIE5vdGUgdGhhdCB0aGUgSW5wdXQgcmVsYXRlZCBldmVudHMgb25seSBleGlzdCBpZiB0aGUgU3ByaXRlIGhhcyBoYWQgYGlucHV0RW5hYmxlZGAgc2V0IHRvIGB0cnVlYC4KKgoqIEBjb25zdHJ1Y3RvcgoqCiogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBBIHJlZmVyZW5jZSB0byBEZXNjcmlwdGlvbi4KKi8KUGhhc2VyLkV2ZW50cyA9IGZ1bmN0aW9uIChzcHJpdGUpIHsKICAgIAogICAgdGhpcy5wYXJlbnQgPSBzcHJpdGU7CgogICAgdGhpcy5vbkFkZGVkVG9Hcm91cCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICB0aGlzLm9uUmVtb3ZlZEZyb21Hcm91cCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICB0aGlzLm9uS2lsbGVkID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIHRoaXMub25SZXZpdmVkID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIHRoaXMub25PdXRPZkJvdW5kcyA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgdGhpcy5vbklucHV0T3ZlciA9IG51bGw7CiAgICB0aGlzLm9uSW5wdXRPdXQgPSBudWxsOwogICAgdGhpcy5vbklucHV0RG93biA9IG51bGw7CiAgICB0aGlzLm9uSW5wdXRVcCA9IG51bGw7CiAgICB0aGlzLm9uRHJhZ1N0YXJ0ID0gbnVsbDsKICAgIHRoaXMub25EcmFnU3RvcCA9IG51bGw7CgogICAgdGhpcy5vbkFuaW1hdGlvblN0YXJ0ID0gbnVsbDsKICAgIHRoaXMub25BbmltYXRpb25Db21wbGV0ZSA9IG51bGw7CiAgICB0aGlzLm9uQW5pbWF0aW9uTG9vcCA9IG51bGw7CgogICAgdGhpcy5vbkJlZ2luQ29udGFjdCA9IG51bGw7CiAgICB0aGlzLm9uRW5kQ29udGFjdCA9IG51bGw7Cgp9OwoKUGhhc2VyLkV2ZW50cy5wcm90b3R5cGUgPSB7CgogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnBhcmVudCA9IG51bGw7CiAgICAgICAgdGhpcy5vbkFkZGVkVG9Hcm91cC5kaXNwb3NlKCk7CiAgICAgICAgdGhpcy5vblJlbW92ZWRGcm9tR3JvdXAuZGlzcG9zZSgpOwogICAgICAgIHRoaXMub25LaWxsZWQuZGlzcG9zZSgpOwogICAgICAgIHRoaXMub25SZXZpdmVkLmRpc3Bvc2UoKTsKICAgICAgICB0aGlzLm9uT3V0T2ZCb3VuZHMuZGlzcG9zZSgpOwoKICAgICAgICBpZiAodGhpcy5vbklucHV0T3ZlcikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25JbnB1dE92ZXIuZGlzcG9zZSgpOwogICAgICAgICAgICB0aGlzLm9uSW5wdXRPdXQuZGlzcG9zZSgpOwogICAgICAgICAgICB0aGlzLm9uSW5wdXREb3duLmRpc3Bvc2UoKTsKICAgICAgICAgICAgdGhpcy5vbklucHV0VXAuZGlzcG9zZSgpOwogICAgICAgICAgICB0aGlzLm9uRHJhZ1N0YXJ0LmRpc3Bvc2UoKTsKICAgICAgICAgICAgdGhpcy5vbkRyYWdTdG9wLmRpc3Bvc2UoKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm9uQW5pbWF0aW9uU3RhcnQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uQW5pbWF0aW9uU3RhcnQuZGlzcG9zZSgpOwogICAgICAgICAgICB0aGlzLm9uQW5pbWF0aW9uQ29tcGxldGUuZGlzcG9zZSgpOwogICAgICAgICAgICB0aGlzLm9uQW5pbWF0aW9uTG9vcC5kaXNwb3NlKCk7CiAgICAgICAgfQoKICAgIH0KCn07CgpQaGFzZXIuRXZlbnRzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5FdmVudHM7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBUaGUgR2FtZSBPYmplY3QgRmFjdG9yeSBpcyBhIHF1aWNrIHdheSB0byBjcmVhdGUgYWxsIG9mIHRoZSBkaWZmZXJlbnQgc29ydHMgb2YgY29yZSBvYmplY3RzIHRoYXQgUGhhc2VyIHVzZXMuCioKKiBAY2xhc3MgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5CiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLldvcmxkfSB3b3JsZCAtIEEgcmVmZXJlbmNlIHRvIHRoZSBnYW1lIHdvcmxkLgogICAgKi8KICAgIHRoaXMud29ybGQgPSB0aGlzLmdhbWUud29ybGQ7Cgp9OwoKUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5LnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkcyBhbiBleGlzdGluZyBvYmplY3QgdG8gdGhlIGdhbWUgd29ybGQuCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2V4aXN0aW5nCiAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IC0gQW4gaW5zdGFuY2Ugb2YgUGhhc2VyLlNwcml0ZSwgUGhhc2VyLkJ1dHRvbiBvciBhbnkgb3RoZXIgZGlzcGxheSBvYmplY3QuLgogICAgKiBAcmV0dXJuIHsqfSBUaGUgY2hpbGQgdGhhdCB3YXMgYWRkZWQgdG8gdGhlIEdyb3VwLgogICAgKi8KICAgIGV4aXN0aW5nOiBmdW5jdGlvbiAob2JqZWN0KSB7CgogICAgICAgIHJldHVybiB0aGlzLndvcmxkLmFkZChvYmplY3QpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZSBhIG5ldyBTcHJpdGUgd2l0aCBzcGVjaWZpYyBwb3NpdGlvbiBhbmQgc3ByaXRlIHNoZWV0IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3Rvcnkjc3ByaXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IHNwcml0ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgc3ByaXRlLgogICAgKiBAcGFyYW0ge3N0cmluZ3xQaGFzZXIuUmVuZGVyVGV4dHVyZXxQSVhJLlRleHR1cmV9IGtleSAtIFRoaXMgaXMgdGhlIGltYWdlIG9yIHRleHR1cmUgdXNlZCBieSB0aGUgU3ByaXRlIGR1cmluZyByZW5kZXJpbmcuIEl0IGNhbiBiZSBhIHN0cmluZyB3aGljaCBpcyBhIHJlZmVyZW5jZSB0byB0aGUgQ2FjaGUgZW50cnksIG9yIGFuIGluc3RhbmNlIG9mIGEgUmVuZGVyVGV4dHVyZSBvciBQSVhJLlRleHR1cmUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW2ZyYW1lXSAtIElmIHRoZSBzcHJpdGUgdXNlcyBhbiBpbWFnZSBmcm9tIGEgdGV4dHVyZSBhdGxhcyBvciBzcHJpdGUgc2hlZXQgeW91IGNhbiBwYXNzIHRoZSBmcmFtZSBoZXJlLiBFaXRoZXIgYSBudW1iZXIgZm9yIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KICAgICogQHBhcmFtIHtQaGFzZXIuR3JvdXB9IFtncm91cF0gLSBPcHRpb25hbCBHcm91cCB0byBhZGQgdGhlIG9iamVjdCB0by4gSWYgbm90IHNwZWNpZmllZCBpdCB3aWxsIGJlIGFkZGVkIHRvIHRoZSBXb3JsZCBncm91cC4KICAgICogQHJldHVybnMge1BoYXNlci5TcHJpdGV9IHRoZSBuZXdseSBjcmVhdGVkIHNwcml0ZSBvYmplY3QuCiAgICAqLwogICAgc3ByaXRlOiBmdW5jdGlvbiAoeCwgeSwga2V5LCBmcmFtZSwgZ3JvdXApIHsKCiAgICAgICAgaWYgKHR5cGVvZiBncm91cCA9PT0gJ3VuZGVmaW5lZCcpIHsgZ3JvdXAgPSB0aGlzLndvcmxkOyB9CgogICAgICAgIHJldHVybiBncm91cC5jcmVhdGUoeCwgeSwga2V5LCBmcmFtZSk7CgogICAgfSwKCiAgICAvKioKICAgICogREVQUkVDQVRFRCAtIHdpbGwgYmUgcmVtb3ZlZCBpbiBQaGFzZXIgMS4yCiAgICAqIENyZWF0ZSBhIG5ldyBTcHJpdGUgd2l0aCBzcGVjaWZpYyBwb3NpdGlvbiBhbmQgc3ByaXRlIHNoZWV0IGtleSB0aGF0IHdpbGwgYXV0b21hdGljYWxseSBiZSBhZGRlZCBhcyBhIGNoaWxkIG9mIHRoZSBnaXZlbiBwYXJlbnQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2NoaWxkCiAgICAqIEBwYXJhbSB7UGhhc2VyLkdyb3VwfSBncm91cCAtIFRoZSBHcm91cCB0byBhZGQgdGhpcyBjaGlsZCB0by4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgc3ByaXRlLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyBzcHJpdGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfFJlbmRlclRleHR1cmV9IFtrZXldIC0gVGhlIGltYWdlIGtleSBhcyBkZWZpbmVkIGluIHRoZSBHYW1lLkNhY2hlIHRvIHVzZSBhcyB0aGUgdGV4dHVyZSBmb3IgdGhpcyBzcHJpdGUgT1IgYSBSZW5kZXJUZXh0dXJlLgogICAgKiBAcGFyYW0gIHtzdHJpbmd8bnVtYmVyfSBbZnJhbWVdIC0gSWYgdGhlIHNwcml0ZSB1c2VzIGFuIGltYWdlIGZyb20gYSB0ZXh0dXJlIGF0bGFzIG9yIHNwcml0ZSBzaGVldCB5b3UgY2FuIHBhc3MgdGhlIGZyYW1lIGhlcmUuIEVpdGhlciBhIG51bWJlciBmb3IgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgogICAgKiBAcmV0dXJucyB7UGhhc2VyLlNwcml0ZX0gdGhlIG5ld2x5IGNyZWF0ZWQgc3ByaXRlIG9iamVjdC4KICAgICovCiAgICBjaGlsZDogZnVuY3Rpb24gKGdyb3VwLCB4LCB5LCBrZXksIGZyYW1lKSB7CgogICAgICAgIHJldHVybiBncm91cC5jcmVhdGUoeCwgeSwga2V5LCBmcmFtZSk7CgogICAgfSwKCiAgICAvKioKICAgICogQ3JlYXRlIGEgdHdlZW4gb2JqZWN0IGZvciBhIHNwZWNpZmljIG9iamVjdC4gVGhlIG9iamVjdCBjYW4gYmUgYW55IEphdmFTY3JpcHQgb2JqZWN0IG9yIFBoYXNlciBvYmplY3Qgc3VjaCBhcyBTcHJpdGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I3R3ZWVuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBvYmogLSBPYmplY3QgdGhlIHR3ZWVuIHdpbGwgYmUgcnVuIG9uLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IERlc2NyaXB0aW9uLgogICAgKi8KICAgIHR3ZWVuOiBmdW5jdGlvbiAob2JqKSB7CgogICAgICAgIHJldHVybiB0aGlzLmdhbWUudHdlZW5zLmNyZWF0ZShvYmopOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEEgR3JvdXAgaXMgYSBjb250YWluZXIgZm9yIGRpc3BsYXkgb2JqZWN0cyB0aGF0IGFsbG93cyBmb3IgZmFzdCBwb29saW5nLCByZWN5Y2xpbmcgYW5kIGNvbGxpc2lvbiBjaGVja3MuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2dyb3VwCiAgICAqIEBwYXJhbSB7YW55fSBwYXJlbnQgLSBUaGUgcGFyZW50IEdyb3VwIG9yIERpc3BsYXlPYmplY3RDb250YWluZXIgdGhhdCB3aWxsIGhvbGQgdGhpcyBncm91cCwgaWYgYW55LgogICAgKiBAcGFyYW0ge3N0cmluZ30gW25hbWU9J2dyb3VwJ10gLSBBIG5hbWUgZm9yIHRoaXMgR3JvdXAuIE5vdCB1c2VkIGludGVybmFsbHkgYnV0IHVzZWZ1bCBmb3IgZGVidWdnaW5nLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuR3JvdXB9IFRoZSBuZXdseSBjcmVhdGVkIGdyb3VwLgogICAgKi8KICAgIGdyb3VwOiBmdW5jdGlvbiAocGFyZW50LCBuYW1lKSB7CgogICAgICAgIHJldHVybiBuZXcgUGhhc2VyLkdyb3VwKHRoaXMuZ2FtZSwgcGFyZW50LCBuYW1lKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IFNvdW5kIG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjYXVkaW8KICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBHYW1lLmNhY2hlIGtleSBvZiB0aGUgc291bmQgdGhhdCB0aGlzIG9iamVjdCB3aWxsIHVzZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt2b2x1bWU9MV0gLSBUaGUgdm9sdW1lIGF0IHdoaWNoIHRoZSBzb3VuZCB3aWxsIGJlIHBsYXllZC4KICAgICogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBXaGV0aGVyIG9yIG5vdCB0aGUgc291bmQgd2lsbCBsb29wLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjb25uZWN0PXRydWVdIC0gQ29udHJvbHMgaWYgdGhlIGNyZWF0ZWQgU291bmQgb2JqZWN0IHdpbGwgY29ubmVjdCB0byB0aGUgbWFzdGVyIGdhaW5Ob2RlIG9mIHRoZSBTb3VuZE1hbmFnZXIgd2hlbiBydW5uaW5nIHVuZGVyIFdlYkF1ZGlvLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuU291bmR9IFRoZSBuZXdseSBjcmVhdGVkIHRleHQgb2JqZWN0LgogICAgKi8KICAgIGF1ZGlvOiBmdW5jdGlvbiAoa2V5LCB2b2x1bWUsIGxvb3AsIGNvbm5lY3QpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5zb3VuZC5hZGQoa2V5LCB2b2x1bWUsIGxvb3AsIGNvbm5lY3QpOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogQ3JlYXRlcyBhIG5ldyBTb3VuZCBvYmplY3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I3NvdW5kCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgR2FtZS5jYWNoZSBrZXkgb2YgdGhlIHNvdW5kIHRoYXQgdGhpcyBvYmplY3Qgd2lsbCB1c2UuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdm9sdW1lPTFdIC0gVGhlIHZvbHVtZSBhdCB3aGljaCB0aGUgc291bmQgd2lsbCBiZSBwbGF5ZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gV2hldGhlciBvciBub3QgdGhlIHNvdW5kIHdpbGwgbG9vcC4KICAgICogQHBhcmFtIHtib29sZWFufSBbY29ubmVjdD10cnVlXSAtIENvbnRyb2xzIGlmIHRoZSBjcmVhdGVkIFNvdW5kIG9iamVjdCB3aWxsIGNvbm5lY3QgdG8gdGhlIG1hc3RlciBnYWluTm9kZSBvZiB0aGUgU291bmRNYW5hZ2VyIHdoZW4gcnVubmluZyB1bmRlciBXZWJBdWRpby4KICAgICogQHJldHVybiB7UGhhc2VyLlNvdW5kfSBUaGUgbmV3bHkgY3JlYXRlZCB0ZXh0IG9iamVjdC4KICAgICovCiAgICBzb3VuZDogZnVuY3Rpb24gKGtleSwgdm9sdW1lLCBsb29wLCBjb25uZWN0KSB7CgogICAgICAgIHJldHVybiB0aGlzLmdhbWUuc291bmQuYWRkKGtleSwgdm9sdW1lLCBsb29wLCBjb25uZWN0KTsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBuZXcgVGlsZVNwcml0ZSBvYmplY3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I3RpbGVTcHJpdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgdGlsZVNwcml0ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgdGlsZVNwcml0ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gdGhlIHdpZHRoIG9mIHRoZSB0aWxlc3ByaXRlLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gdGhlIGhlaWdodCBvZiB0aGUgdGlsZXNwcml0ZS4KICAgICogQHBhcmFtIHtzdHJpbmd8UGhhc2VyLlJlbmRlclRleHR1cmV8UElYSS5UZXh0dXJlfSBrZXkgLSBUaGlzIGlzIHRoZSBpbWFnZSBvciB0ZXh0dXJlIHVzZWQgYnkgdGhlIFNwcml0ZSBkdXJpbmcgcmVuZGVyaW5nLiBJdCBjYW4gYmUgYSBzdHJpbmcgd2hpY2ggaXMgYSByZWZlcmVuY2UgdG8gdGhlIENhY2hlIGVudHJ5LCBvciBhbiBpbnN0YW5jZSBvZiBhIFJlbmRlclRleHR1cmUgb3IgUElYSS5UZXh0dXJlLgogICAgKiBAcGFyYW0ge1BoYXNlci5Hcm91cH0gW2dyb3VwXSAtIE9wdGlvbmFsIEdyb3VwIHRvIGFkZCB0aGUgb2JqZWN0IHRvLiBJZiBub3Qgc3BlY2lmaWVkIGl0IHdpbGwgYmUgYWRkZWQgdG8gdGhlIFdvcmxkIGdyb3VwLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGlsZVNwcml0ZX0gVGhlIG5ld2x5IGNyZWF0ZWQgdGlsZVNwcml0ZSBvYmplY3QuCiAgICAqLwogICAgdGlsZVNwcml0ZTogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQsIGtleSwgZ3JvdXApIHsKCiAgICAgICAgaWYgKHR5cGVvZiBncm91cCA9PT0gJ3VuZGVmaW5lZCcpIHsgZ3JvdXAgPSB0aGlzLndvcmxkOyB9CgogICAgICAgIHJldHVybiBncm91cC5hZGQobmV3IFBoYXNlci5UaWxlU3ByaXRlKHRoaXMuZ2FtZSwgeCwgeSwgd2lkdGgsIGhlaWdodCwga2V5KSk7CgogICAgfSwKCiAgICAvKioKICAgICogQ3JlYXRlcyBhIG5ldyBUZXh0IG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjdGV4dAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyB0ZXh0IG9iamVjdC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgdGV4dCBvYmplY3QuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIGFjdHVhbCB0ZXh0IHRoYXQgd2lsbCBiZSB3cml0dGVuLgogICAgKiBAcGFyYW0ge29iamVjdH0gc3R5bGUgLSBUaGUgc3R5bGUgb2JqZWN0IGNvbnRhaW5pbmcgc3R5bGUgYXR0cmlidXRlcyBsaWtlIGZvbnQsIGZvbnQgc2l6ZSAsIGV0Yy4KICAgICogQHBhcmFtIHtQaGFzZXIuR3JvdXB9IFtncm91cF0gLSBPcHRpb25hbCBHcm91cCB0byBhZGQgdGhlIG9iamVjdCB0by4gSWYgbm90IHNwZWNpZmllZCBpdCB3aWxsIGJlIGFkZGVkIHRvIHRoZSBXb3JsZCBncm91cC4KICAgICogQHJldHVybiB7UGhhc2VyLlRleHR9IFRoZSBuZXdseSBjcmVhdGVkIHRleHQgb2JqZWN0LgogICAgKi8KICAgIHRleHQ6IGZ1bmN0aW9uICh4LCB5LCB0ZXh0LCBzdHlsZSwgZ3JvdXApIHsKCiAgICAgICAgaWYgKHR5cGVvZiBncm91cCA9PT0gJ3VuZGVmaW5lZCcpIHsgZ3JvdXAgPSB0aGlzLndvcmxkOyB9CgogICAgICAgIHJldHVybiBncm91cC5hZGQobmV3IFBoYXNlci5UZXh0KHRoaXMuZ2FtZSwgeCwgeSwgdGV4dCwgc3R5bGUpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IEJ1dHRvbiBvYmplY3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2J1dHRvbgogICAgKiBAcGFyYW0ge251bWJlcn0gW3hdIFggcG9zaXRpb24gb2YgdGhlIG5ldyBidXR0b24gb2JqZWN0LgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ldIFkgcG9zaXRpb24gb2YgdGhlIG5ldyBidXR0b24gb2JqZWN0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2tleV0gVGhlIGltYWdlIGtleSBhcyBkZWZpbmVkIGluIHRoZSBHYW1lLkNhY2hlIHRvIHVzZSBhcyB0aGUgdGV4dHVyZSBmb3IgdGhpcyBidXR0b24uCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGlzIGJ1dHRvbiBpcyBwcmVzc2VkCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBbY2FsbGJhY2tDb250ZXh0XSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgKHVzdWFsbHkgJ3RoaXMnKQogICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtvdmVyRnJhbWVdIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYW4gb3ZlciBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KICAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbb3V0RnJhbWVdIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYW4gb3V0IHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgogICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtkb3duRnJhbWVdIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYSBkb3duIHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgogICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFt1cEZyYW1lXSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGFuIHVwIHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgogICAgKiBAcGFyYW0ge1BoYXNlci5Hcm91cH0gW2dyb3VwXSAtIE9wdGlvbmFsIEdyb3VwIHRvIGFkZCB0aGUgb2JqZWN0IHRvLiBJZiBub3Qgc3BlY2lmaWVkIGl0IHdpbGwgYmUgYWRkZWQgdG8gdGhlIFdvcmxkIGdyb3VwLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQnV0dG9ufSBUaGUgbmV3bHkgY3JlYXRlZCBidXR0b24gb2JqZWN0LgogICAgKi8KICAgIGJ1dHRvbjogZnVuY3Rpb24gKHgsIHksIGtleSwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlckZyYW1lLCBvdXRGcmFtZSwgZG93bkZyYW1lLCB1cEZyYW1lLCBncm91cCkgewoKICAgICAgICBpZiAodHlwZW9mIGdyb3VwID09PSAndW5kZWZpbmVkJykgeyBncm91cCA9IHRoaXMud29ybGQ7IH0KCiAgICAgICAgcmV0dXJuIGdyb3VwLmFkZChuZXcgUGhhc2VyLkJ1dHRvbih0aGlzLmdhbWUsIHgsIHksIGtleSwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlckZyYW1lLCBvdXRGcmFtZSwgZG93bkZyYW1lLCB1cEZyYW1lKSk7CgogICAgfSwKCiAgICAvKioKICAgICogQ3JlYXRlcyBhIG5ldyBHcmFwaGljcyBvYmplY3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2dyYXBoaWNzCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IGdyYXBoaWNzIG9iamVjdC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgZ3JhcGhpY3Mgb2JqZWN0LgogICAgKiBAcGFyYW0ge1BoYXNlci5Hcm91cH0gW2dyb3VwXSAtIE9wdGlvbmFsIEdyb3VwIHRvIGFkZCB0aGUgb2JqZWN0IHRvLiBJZiBub3Qgc3BlY2lmaWVkIGl0IHdpbGwgYmUgYWRkZWQgdG8gdGhlIFdvcmxkIGdyb3VwLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuR3JhcGhpY3N9IFRoZSBuZXdseSBjcmVhdGVkIGdyYXBoaWNzIG9iamVjdC4KICAgICovCiAgICBncmFwaGljczogZnVuY3Rpb24gKHgsIHksIGdyb3VwKSB7CgogICAgICAgIGlmICh0eXBlb2YgZ3JvdXAgPT09ICd1bmRlZmluZWQnKSB7IGdyb3VwID0gdGhpcy53b3JsZDsgfQoKICAgICAgICByZXR1cm4gZ3JvdXAuYWRkKG5ldyBQaGFzZXIuR3JhcGhpY3ModGhpcy5nYW1lLCB4LCB5KSk7CgogICAgfSwKCiAgICAvKioKICAgICogRW1pdHRlciBpcyBhIGxpZ2h0d2VpZ2h0IHBhcnRpY2xlIGVtaXR0ZXIuIEl0IGNhbiBiZSB1c2VkIGZvciBvbmUtdGltZSBleHBsb3Npb25zIG9yIGZvcgogICAgKiBjb250aW51b3VzIGVmZmVjdHMgbGlrZSByYWluIGFuZCBmaXJlLiBBbGwgaXQgcmVhbGx5IGRvZXMgaXMgbGF1bmNoIFBhcnRpY2xlIG9iamVjdHMgb3V0CiAgICAqIGF0IHNldCBpbnRlcnZhbHMsIGFuZCBmaXhlcyB0aGVpciBwb3NpdGlvbnMgYW5kIHZlbG9jaXRpZXMgYWNjb3JpbmRnbHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2VtaXR0ZXIKICAgICogQHBhcmFtIHtudW1iZXJ9IFt4PTBdIC0gVGhlIHggY29vcmRpbmF0ZSB3aXRoaW4gdGhlIEVtaXR0ZXIgdGhhdCB0aGUgcGFydGljbGVzIGFyZSBlbWl0dGVkIGZyb20uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeT0wXSAtIFRoZSB5IGNvb3JkaW5hdGUgd2l0aGluIHRoZSBFbWl0dGVyIHRoYXQgdGhlIHBhcnRpY2xlcyBhcmUgZW1pdHRlZCBmcm9tLgogICAgKiBAcGFyYW0ge251bWJlcn0gW21heFBhcnRpY2xlcz01MF0gLSBUaGUgdG90YWwgbnVtYmVyIG9mIHBhcnRpY2xlcyBpbiB0aGlzIGVtaXR0ZXIuCiAgICAqIEByZXR1cm4ge1BoYXNlci5FbWl0dGVyfSBUaGUgbmV3bHkgY3JlYXRlZCBlbWl0dGVyIG9iamVjdC4KICAgICovCiAgICBlbWl0dGVyOiBmdW5jdGlvbiAoeCwgeSwgbWF4UGFydGljbGVzKSB7CgogICAgICAgIHJldHVybiB0aGlzLmdhbWUucGFydGljbGVzLmFkZChuZXcgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlcih0aGlzLmdhbWUsIHgsIHksIG1heFBhcnRpY2xlcykpOwoKICAgIH0sCgogICAgLyoqCiAgICAqICogQ3JlYXRlIGEgbmV3IEJpdG1hcFRleHQgb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNiaXRtYXBUZXh0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IGJpdG1hcFRleHQgb2JqZWN0LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyBiaXRtYXBUZXh0IG9iamVjdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgLSBUaGUgYWN0dWFsIHRleHQgdGhhdCB3aWxsIGJlIHdyaXR0ZW4uCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBzdHlsZSAtIFRoZSBzdHlsZSBvYmplY3QgY29udGFpbmluZyBzdHlsZSBhdHRyaWJ1dGVzIGxpa2UgZm9udCwgZm9udCBzaXplICwgZXRjLgogICAgKiBAcGFyYW0ge1BoYXNlci5Hcm91cH0gW2dyb3VwXSAtIE9wdGlvbmFsIEdyb3VwIHRvIGFkZCB0aGUgb2JqZWN0IHRvLiBJZiBub3Qgc3BlY2lmaWVkIGl0IHdpbGwgYmUgYWRkZWQgdG8gdGhlIFdvcmxkIGdyb3VwLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwVGV4dH0gVGhlIG5ld2x5IGNyZWF0ZWQgYml0bWFwVGV4dCBvYmplY3QuCiAgICAqLwogICAgYml0bWFwVGV4dDogZnVuY3Rpb24gKHgsIHksIHRleHQsIHN0eWxlLCBncm91cCkgewoKICAgICAgICBpZiAodHlwZW9mIGdyb3VwID09PSAndW5kZWZpbmVkJykgeyBncm91cCA9IHRoaXMud29ybGQ7IH0KCiAgICAgICAgcmV0dXJuIHRoaXMud29ybGQuYWRkKG5ldyBQaGFzZXIuQml0bWFwVGV4dCh0aGlzLmdhbWUsIHgsIHksIHRleHQsIHN0eWxlKSk7CgogICAgfSwKCiAgICAvKioKICAgICogQ3JlYXRlcyBhIG5ldyBUaWxlbWFwIG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjdGlsZW1hcAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgSlNPTiBvciBDU1YgbWFwIGRhdGEgaW4gdGhlIGNhY2hlLgogICAgKiBAcGFyYW0ge29iamVjdHxzdHJpbmd9IHRpbGVzZXRzIC0gQW4gb2JqZWN0IG1hcHBpbmcgQ2FjaGUudGlsZXNldCBrZXlzIHdpdGggdGhlIHRpbGVzZXQgbmFtZXMgaW4gdGhlIEpTT04gZmlsZS4gSWYgYSBzdHJpbmcgaXMgcHJvdmlkZWQgdGhhdCB3aWxsIGJlIHVzZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5UaWxlbWFwfSBUaGUgbmV3bHkgY3JlYXRlZCB0aWxlbWFwIG9iamVjdC4KICAgICovCiAgICB0aWxlbWFwOiBmdW5jdGlvbiAoa2V5LCB0aWxlc2V0cykgewoKICAgICAgICByZXR1cm4gbmV3IFBoYXNlci5UaWxlbWFwKHRoaXMuZ2FtZSwga2V5LCB0aWxlc2V0cyk7CgogICAgfSwKCiAgICAvKioKICAgICogQSBkeW5hbWljIGluaXRpYWxseSBibGFuayBjYW52YXMgdG8gd2hpY2ggaW1hZ2VzIGNhbiBiZSBkcmF3bi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjcmVuZGVyVGV4dHVyZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgcmVuZGVyIHRleHR1cmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIHRoZSB3aWR0aCBvZiB0aGUgcmVuZGVyIHRleHR1cmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSB0aGUgaGVpZ2h0IG9mIHRoZSByZW5kZXIgdGV4dHVyZS4KICAgICogQHJldHVybiB7UGhhc2VyLlJlbmRlclRleHR1cmV9IFRoZSBuZXdseSBjcmVhdGVkIHJlbmRlclRleHR1cmUgb2JqZWN0LgogICAgKi8KICAgIHJlbmRlclRleHR1cmU6IGZ1bmN0aW9uIChrZXksIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgdmFyIHRleHR1cmUgPSBuZXcgUGhhc2VyLlJlbmRlclRleHR1cmUodGhpcy5nYW1lLCBrZXksIHdpZHRoLCBoZWlnaHQpOwoKICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkUmVuZGVyVGV4dHVyZShrZXksIHRleHR1cmUpOwoKICAgICAgICByZXR1cm4gdGV4dHVyZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBFeHBlcmltZW50YWw6IEEgQml0bWFwRGF0YSBvYmplY3Qgd2hpY2ggY2FuIGJlIG1hbmlwdWxhdGVkIGFuZCBkcmF3biB0byBsaWtlIGEgdHJhZGl0aW9uYWwgQ2FudmFzIG9iamVjdCBhbmQgdXNlZCB0byB0ZXh0dXJlIFNwcml0ZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2JpdG1hcERhdGEKICAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aD0yNTZdIC0gVGhlIHdpZHRoIG9mIHRoZSBCaXRtYXBEYXRhIGluIHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHQ9MjU2XSAtIFRoZSBoZWlnaHQgb2YgdGhlIEJpdG1hcERhdGEgaW4gcGl4ZWxzLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIG5ld2x5IGNyZWF0ZWQgQml0bWFwRGF0YSBvYmplY3QuCiAgICAqLwogICAgYml0bWFwRGF0YTogZnVuY3Rpb24gKHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgcmV0dXJuIG5ldyBQaGFzZXIuQml0bWFwRGF0YSh0aGlzLmdhbWUsIHdpZHRoLCBoZWlnaHQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEEgV2ViR0wgc2hhZGVyL2ZpbHRlciB0aGF0IGNhbiBiZSBhcHBsaWVkIHRvIFNwcml0ZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2ZpbHRlcgogICAgKiBAcGFyYW0ge3N0cmluZ30gZmlsdGVyIC0gVGhlIG5hbWUgb2YgdGhlIGZpbHRlciB5b3Ugd2lzaCB0byBjcmVhdGUsIGZvciBleGFtcGxlIEh1ZVJvdGF0ZSBvciBTaW5lV2F2ZS4KICAgICogQHBhcmFtIHthbnl9IC0gV2hhdGV2ZXIgcGFyYW1ldGVycyBhcmUgbmVlZGVkIHRvIGJlIHBhc3NlZCB0byB0aGUgZmlsdGVyIGluaXQgZnVuY3Rpb24uCiAgICAqIEByZXR1cm4ge1BoYXNlci5GaWx0ZXJ9IFRoZSBuZXdseSBjcmVhdGVkIFBoYXNlci5GaWx0ZXIgb2JqZWN0LgogICAgKi8KICAgIGZpbHRlcjogZnVuY3Rpb24gKGZpbHRlcikgewoKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoKICAgICAgICB2YXIgZmlsdGVyID0gbmV3IFBoYXNlci5GaWx0ZXJbZmlsdGVyXSh0aGlzLmdhbWUpOwoKICAgICAgICBmaWx0ZXIuaW5pdC5hcHBseShmaWx0ZXIsIGFyZ3MpOwoKICAgICAgICByZXR1cm4gZmlsdGVyOwoKICAgIH0KCn07CgpQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyBCaXRtYXBEYXRhIG9iamVjdC4KKgoqIEBjbGFzcyBQaGFzZXIuQml0bWFwRGF0YQoqCiogQGNsYXNzZGVzYyBOb3RlOiBUaGlzIG9iamVjdCBpcyBzdGlsbCBleHBlcmltZW50YWwgYW5kIGxpa2VseSB0byBjaGFuZ2UuCioKKiBBIEJpdG1hcERhdGEgb2JqZWN0IGNhbiBiZSB0aG91Z2h0IG9mIGFzIGEgYmxhbmsgY2FudmFzIG9udG8gd2hpY2ggeW91IGNhbiBwZXJmb3JtIGdyYXBoaWNzIG9wZXJhdGlvbnMgYXMgeW91IHdvdWxkIG9uIGEgbm9ybWFsIGNhbnZhcywgCiogc3VjaCBhcyBkcmF3aW5nIGxpbmVzLCBjaXJjbGVzLCBhcmNzLCBmaWxscyBhbmQgY29weWluZyBhbmQgc2V0dGluZyBibG9ja3Mgb2YgcGl4ZWwgZGF0YS4gQSBzaW5nbGUgQml0bWFwRGF0YSBjYW4gYmUgdXNlZCBhcyB0aGUgdGV4dHVyZSAKKiBmb3IgbXVsdGlwbGUgU3ByaXRlcy4gU28gaWYgeW91IG5lZWQgdG8gZHluYW1pY2FsbHkgY3JlYXRlIGEgU3ByaXRlIHRleHR1cmUgdGhlbiB0aGV5IGFyZSBhIGdvb2QgY2hvaWNlLiBJdCBzdXBwb3J0cyB0aGUgRWFzZWxKUyBUaW55IEFQSS4KKgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoPTI1Nl0gLSBUaGUgd2lkdGggb2YgdGhlIEJpdG1hcERhdGEgaW4gcGl4ZWxzLgoqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0PTI1Nl0gLSBUaGUgaGVpZ2h0IG9mIHRoZSBCaXRtYXBEYXRhIGluIHBpeGVscy4KKi8KUGhhc2VyLkJpdG1hcERhdGEgPSBmdW5jdGlvbiAoZ2FtZSwgd2lkdGgsIGhlaWdodCkgewoKICAgIGlmICh0eXBlb2Ygd2lkdGggPT09ICd1bmRlZmluZWQnKSB7IHdpZHRoID0gMjU2OyB9CiAgICBpZiAodHlwZW9mIGhlaWdodCA9PT0gJ3VuZGVmaW5lZCcpIHsgaGVpZ2h0ID0gMjU2OyB9CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4gCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgQml0bWFwRGF0YS4KICAgICovCiAgICB0aGlzLm5hbWUgPSAnJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBCaXRtYXBEYXRhIGluIHBpeGVscy4KICAgICovCiAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgQml0bWFwRGF0YSBpbiBwaXhlbHMuCiAgICAqLwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIFRoZSBjYW52YXMgdG8gd2hpY2ggdGhpcyBCaXRtYXBEYXRhIGRyYXdzLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2FudmFzID0gUGhhc2VyLkNhbnZhcy5jcmVhdGUod2lkdGgsIGhlaWdodCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gY29udGV4dCAtIFRoZSAyZCBjb250ZXh0IG9mIHRoZSBjYW52YXMuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb250ZXh0ID0gdGhpcy5jYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gaW1hZ2VEYXRhIC0gVGhlIGNhbnZhcyBpbWFnZSBkYXRhLgogICAgKi8KICAgIHRoaXMuaW1hZ2VEYXRhID0gdGhpcy5jb250ZXh0LmdldEltYWdlRGF0YSgwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtVSW50OENsYW1wZWR9IHBpeGVscyAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjb250ZXh0IGltYWdlRGF0YSBidWZmZXIuCiAgICAqLwogICAgaWYgKHRoaXMuaW1hZ2VEYXRhLmRhdGEuYnVmZmVyKQogICAgewogICAgICAgIHRoaXMucGl4ZWxzID0gdGhpcy5pbWFnZURhdGEuZGF0YS5idWZmZXI7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5waXhlbHMgPSB0aGlzLmltYWdlRGF0YS5kYXRhOwogICAgfQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BJWEkuQmFzZVRleHR1cmV9IGJhc2VUZXh0dXJlIC0gVGhlIFBJWEkuQmFzZVRleHR1cmUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5iYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKHRoaXMuY2FudmFzKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UElYSS5UZXh0dXJlfSB0ZXh0dXJlIC0gVGhlIFBJWEkuVGV4dHVyZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRleHR1cmUgPSBuZXcgUElYSS5UZXh0dXJlKHRoaXMuYmFzZVRleHR1cmUpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuRnJhbWV9IHRleHR1cmVGcmFtZSAtIFRoZSBGcmFtZSB0aGlzIEJpdG1hcERhdGEgdXNlcyBmb3IgcmVuZGVyaW5nLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGV4dHVyZUZyYW1lID0gbmV3IFBoYXNlci5GcmFtZSgwLCAwLCAwLCB3aWR0aCwgaGVpZ2h0LCAnYml0bWFwRGF0YScsIGdhbWUucm5kLnV1aWQoKSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0eXBlIC0gVGhlIGNvbnN0IHR5cGUgb2YgdGhpcyBvYmplY3QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLkJJVE1BUERBVEE7CgogICAgdGhpcy5fZGlydHkgPSBmYWxzZTsKCn0KClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogVXBkYXRlcyB0aGUgZ2l2ZW4gU3ByaXRlIHNvIHRoYXQgaXQgdXNlcyB0aGlzIEJpdG1hcERhdGEgYXMgaXRzIHRleHR1cmUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjYWRkCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gVGhlIHNwcml0ZSB0byBhcHBseSB0aGlzIHRleHR1cmUgdG8uCiAgICAqLwogICAgYWRkOiBmdW5jdGlvbiAoc3ByaXRlKSB7CgogICAgICAgIHNwcml0ZS5sb2FkVGV4dHVyZSh0aGlzKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiBhbiBhcnJheSBvZiBTcHJpdGVzIGl0IHdpbGwgdXBkYXRlIGVhY2ggb2YgdGhlbSBzbyB0aGF0IHRoZWlyIFRleHR1cmVzIHJlZmVyZW5jZSB0aGlzIEJpdG1hcERhdGEuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjYWRkVG8KICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlW119IHNwcml0ZXMgLSBBbiBhcnJheSBvZiBTcHJpdGVzIHRvIGFwcGx5IHRoaXMgdGV4dHVyZSB0by4KICAgICovCiAgICBhZGRUbzogZnVuY3Rpb24gKHNwcml0ZXMpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcHJpdGVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHNwcml0ZXNbaV0udGV4dHVyZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3ByaXRlc1tpXS5sb2FkVGV4dHVyZSh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGVhcnMgdGhlIEJpdG1hcERhdGEuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjY2xlYXIKICAgICovCiAgICBjbGVhcjogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKICAgIAogICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKCiAgICB9LAoKICAgIHJlZnJlc2hCdWZmZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5pbWFnZURhdGEgPSB0aGlzLmNvbnRleHQuZ2V0SW1hZ2VEYXRhKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKICAgICAgICB0aGlzLnBpeGVscyA9IG5ldyBJbnQzMkFycmF5KHRoaXMuaW1hZ2VEYXRhLmRhdGEuYnVmZmVyKTsKCiAgICAgICAgLy8gdGhpcy5kYXRhOCA9IG5ldyBVaW50OENsYW1wZWRBcnJheSh0aGlzLmltYWdlRGF0YS5idWZmZXIpOwogICAgICAgIC8vIHRoaXMuZGF0YTMyID0gbmV3IFVpbnQzMkFycmF5KHRoaXMuaW1hZ2VEYXRhLmJ1ZmZlcik7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgY29sb3Igb2YgdGhlIGdpdmVuIHBpeGVsIHRvIHRoZSBzcGVjaWZpZWQgcmVkLCBncmVlbiwgYmx1ZSBhbmQgYWxwaGEgdmFsdWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI3NldFBpeGVsMzIKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgWCBjb29yZGluYXRlIG9mIHRoZSBwaXhlbCB0byBiZSBzZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIFkgY29vcmRpbmF0ZSBvZiB0aGUgcGl4ZWwgdG8gYmUgc2V0LgogICAgKiBAcGFyYW0ge251bWJlcn0gcmVkIC0gVGhlIHJlZCBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gZ3JlZW4gLSBUaGUgZ3JlZW4gY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGJsdWUgLSBUaGUgYmx1ZSBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gYWxwaGEgLSBUaGUgYWxwaGEgY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICovCiAgICBzZXRQaXhlbDMyOiBmdW5jdGlvbiAoeCwgeSwgcmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEpIHsKCiAgICAgICAgaWYgKHggPj0gMCAmJiB4IDw9IHRoaXMud2lkdGggJiYgeSA+PSAwICYmIHkgPD0gdGhpcy5oZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnBpeGVsc1t5ICogdGhpcy53aWR0aCArIHhdID0gKGFscGhhIDw8IDI0KSB8IChibHVlIDw8IDE2KSB8IChncmVlbiA8PCA4KSB8IHJlZDsKCiAgICAgICAgICAgIC8qCiAgICAgICAgICAgIGlmICh0aGlzLmlzTGl0dGxlRW5kaWFuKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmRhdGEzMlt5ICogdGhpcy53aWR0aCArIHhdID0gKGFscGhhIDw8IDI0KSB8IChibHVlIDw8IDE2KSB8IChncmVlbiA8PCA4KSB8IHJlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZGF0YTMyW3kgKiB0aGlzLndpZHRoICsgeF0gPSAocmVkIDw8IDI0KSB8IChncmVlbiA8PCAxNikgfCAoYmx1ZSA8PCA4KSB8IGFscGhhOwogICAgICAgICAgICB9CiAgICAgICAgICAgKi8KCiAgICAgICAgICAgIC8vIHRoaXMuaW1hZ2VEYXRhLmRhdGEuc2V0KHRoaXMuZGF0YTgpOwoKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnB1dEltYWdlRGF0YSh0aGlzLmltYWdlRGF0YSwgMCwgMCk7CgogICAgICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGNvbG9yIG9mIHRoZSBnaXZlbiBwaXhlbCB0byB0aGUgc3BlY2lmaWVkIHJlZCwgZ3JlZW4gYW5kIGJsdWUgdmFsdWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI3NldFBpeGVsCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIFggY29vcmRpbmF0ZSBvZiB0aGUgcGl4ZWwgdG8gYmUgc2V0LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBZIGNvb3JkaW5hdGUgb2YgdGhlIHBpeGVsIHRvIGJlIHNldC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHJlZCAtIFRoZSByZWQgY29sb3IgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KQogICAgKiBAcGFyYW0ge251bWJlcn0gZ3JlZW4gLSBUaGUgZ3JlZW4gY29sb3IgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KQogICAgKiBAcGFyYW0ge251bWJlcn0gYmx1ZSAtIFRoZSBibHVlIGNvbG9yIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkKICAgICovCiAgICBzZXRQaXhlbDogZnVuY3Rpb24gKHgsIHksIHJlZCwgZ3JlZW4sIGJsdWUpIHsKCiAgICAgICAgdGhpcy5zZXRQaXhlbDMyKHgsIHksIHJlZCwgZ3JlZW4sIGJsdWUsIDI1NSk7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgY29sb3Igb2YgYSBzcGVjaWZpYyBwaXhlbC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgWCBjb29yZGluYXRlIG9mIHRoZSBwaXhlbCB0byBnZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIFkgY29vcmRpbmF0ZSBvZiB0aGUgcGl4ZWwgdG8gZ2V0LgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IEEgbmF0aXZlIGNvbG9yIHZhbHVlIGludGVnZXIgKGZvcm1hdDogMHhSUkdHQkIpCiAgICAqLwogICAgZ2V0UGl4ZWw6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIGlmICh4ID49IDAgJiYgeCA8PSB0aGlzLndpZHRoICYmIHkgPj0gMCAmJiB5IDw9IHRoaXMuaGVpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YTMyW3kgKiB0aGlzLndpZHRoICsgeF07CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBhIGNvbG9yIG9mIGEgc3BlY2lmaWMgcGl4ZWwgKGluY2x1ZGluZyBhbHBoYSB2YWx1ZSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIFggY29vcmRpbmF0ZSBvZiB0aGUgcGl4ZWwgdG8gZ2V0LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBZIGNvb3JkaW5hdGUgb2YgdGhlIHBpeGVsIHRvIGdldC4KICAgICogQHJldHVybiB7bnVtYmVyfSBBIG5hdGl2ZSBjb2xvciB2YWx1ZSBpbnRlZ2VyIChmb3JtYXQ6IDB4QUFSUkdHQkIpCiAgICAqLwogICAgZ2V0UGl4ZWwzMjogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgaWYgKHggPj0gMCAmJiB4IDw9IHRoaXMud2lkdGggJiYgeSA+PSAwICYmIHkgPD0gdGhpcy5oZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhMzJbeSAqIHRoaXMud2lkdGggKyB4XTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IHBpeGVscyBpbiBhcnJheSBpbiBhIHNwZWNpZmljIFJlY3RhbmdsZS4KICAgICogQHBhcmFtIHJlY3Qge1JlY3RhbmdsZX0gVGhlIHNwZWNpZmljIFJlY3RhbmdsZS4KICAgICogQHJldHVybiB7YXJyYXl9IENhbnZhc1BpeGVsQXJyYXkuCiAgICAqLwogICAgZ2V0UGl4ZWxzOiBmdW5jdGlvbiAocmVjdCkgewoKICAgICAgICByZXR1cm4gdGhpcy5jb250ZXh0LmdldEltYWdlRGF0YShyZWN0LngsIHJlY3QueSwgcmVjdC53aWR0aCwgcmVjdC5oZWlnaHQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgYW4gYXJjIHRvIHRoZSBwYXRoIHdoaWNoIGlzIGNlbnRlcmVkIGF0ICh4LCB5KSBwb3NpdGlvbiB3aXRoIHJhZGl1cyByIHN0YXJ0aW5nIGF0IHN0YXJ0QW5nbGUgYW5kIGVuZGluZyBhdCBlbmRBbmdsZSAKICAgICogZ29pbmcgaW4gdGhlIGdpdmVuIGRpcmVjdGlvbiBieSBhbnRpY2xvY2t3aXNlIChkZWZhdWx0aW5nIHRvIGNsb2Nrd2lzZSkuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjYXJjCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIGFyYydzIGNlbnRlcgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSBhcmMncyBjZW50ZXIKICAgICogQHBhcmFtIHtudW1iZXJ9IHJhZGl1cyAtIFRoZSBhcmMncyByYWRpdXMKICAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0QW5nbGUgLSBUaGUgc3RhcnRpbmcgcG9pbnQsIG1lYXN1cmVkIGZyb20gdGhlIHggYXhpcywgZnJvbSB3aGljaCBpdCB3aWxsIGJlIGRyYXduLCBleHByZXNzZWQgaW4gcmFkaWFucy4KICAgICogQHBhcmFtIHtudW1iZXJ9IGVuZEFuZ2xlIC0gVGhlIGVuZCBhcmMncyBhbmdsZSB0byB3aGljaCBpdCB3aWxsIGJlIGRyYXduLCBleHByZXNzZWQgaW4gcmFkaWFucy4KICAgICogQHBhcmFtIHtib29sZWFufSBbYW50aWNsb2Nrd2lzZT10cnVlXSAtIHRydWUgZHJhd3MgdGhlIGFyYyBhbnRpY2xvY2t3aXNlLCBvdGhlcndpc2UgaW4gYSBjbG9ja3dpc2UgZGlyZWN0aW9uLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBhcmM6IGZ1bmN0aW9uICh4LCB5LCByYWRpdXMsIHN0YXJ0QW5nbGUsIGVuZEFuZ2xlLCBhbnRpY2xvY2t3aXNlKSB7CgogICAgICAgIGlmICh0eXBlb2YgYW50aWNsb2Nrd2lzZSA9PT0gJ3VuZGVmaW5lZCcpIHsgYW50aWNsb2Nrd2lzZSA9IGZhbHNlOyB9CgogICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNvbnRleHQuYXJjKHgsIHksIHJhZGl1cywgc3RhcnRBbmdsZSwgZW5kQW5nbGUsIGFudGljbG9ja3dpc2UpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgYW4gYXJjIHdpdGggdGhlIGdpdmVuIGNvbnRyb2wgcG9pbnRzIGFuZCByYWRpdXMsIGNvbm5lY3RlZCB0byB0aGUgcHJldmlvdXMgcG9pbnQgYnkgYSBzdHJhaWdodCBsaW5lLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2FyY1RvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MQogICAgKiBAcGFyYW0ge251bWJlcn0geTEKICAgICogQHBhcmFtIHtudW1iZXJ9IHgyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MgogICAgKiBAcGFyYW0ge251bWJlcn0gcmFkaXVzCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGFyY1RvOiBmdW5jdGlvbiAoeDEsIHkxLCB4MiwgeTIsIHJhZGl1cykgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LmFyY1RvKHgxLCB5MSwgeDIsIHkyLCByYWRpdXMpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEJlZ2lucyBhIGZpbGwgd2l0aCB0aGUgc3BlY2lmaWVkIGNvbG9yLiBUaGlzIGVuZHMgdGhlIGN1cnJlbnQgc3ViLXBhdGguCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjYmVnaW5GaWxsCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBjb2xvciAtIEEgQ1NTIGNvbXBhdGlibGUgY29sb3IgdmFsdWUgKGV4LiAicmVkIiwgIiNGRjAwMDAiLCBvciAicmdiYSgyNTUsMCwwLDAuNSkiKS4gU2V0dGluZyB0byBudWxsIHdpbGwgcmVzdWx0IGluIG5vIGZpbGwuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGJlZ2luRmlsbDogZnVuY3Rpb24gKGNvbG9yKSB7CgogICAgICAgIHRoaXMuZmlsbFN0eWxlKGNvbG9yKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQmVnaW5zIGEgbGluZWFyIGdyYWRpZW50IGZpbGwgZGVmaW5lZCBieSB0aGUgbGluZSAoeDAsIHkwKSB0byAoeDEsIHkxKS4gVGhpcyBlbmRzIHRoZSBjdXJyZW50IHN1Yi1wYXRoLiBGb3IKICAgICogZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBjb2RlIGRlZmluZXMgYSBibGFjayB0byB3aGl0ZSB2ZXJ0aWNhbCBncmFkaWVudCByYW5naW5nIGZyb20gMjBweCB0byAxMjBweCwgYW5kIGRyYXdzIGEgc3F1YXJlIHRvIGRpc3BsYXkgaXQ6CiAgICAqCiAgICAqICAgICAgYGBgbXlHcmFwaGljcy5iZWdpbkxpbmVhckdyYWRpZW50RmlsbChbIiMwMDAiLCIjRkZGIl0sIFswLCAxXSwgMCwgMjAsIDAsIDEyMCkucmVjdCgyMCwgMjAsIDEyMCwgMTIwKTtgYGAKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNiZWdpbkxpbmVhckdyYWRpZW50RmlsbAogICAgKiBAcGFyYW0ge0FycmF5fSBjb2xvcnMgLSBBbiBhcnJheSBvZiBDU1MgY29tcGF0aWJsZSBjb2xvciB2YWx1ZXMuIEZvciBleGFtcGxlLCBbIiNGMDAiLCIjMDBGIl0gd291bGQgZGVmaW5lIGEgZ3JhZGllbnQgZHJhd2luZyBmcm9tIHJlZCB0byBibHVlLgogICAgKiBAcGFyYW0ge0FycmF5fSByYXRpb3MgLSBBbiBhcnJheSBvZiBncmFkaWVudCBwb3NpdGlvbnMgd2hpY2ggY29ycmVzcG9uZCB0byB0aGUgY29sb3JzLiBGb3IgZXhhbXBsZSwgWzAuMSwgMC45XSB3b3VsZCBkcmF3IHRoZSBmaXJzdCBjb2xvciB0byAxMCUgdGhlbiBpbnRlcnBvbGF0aW5nIHRvIHRoZSBzZWNvbmQgY29sb3IgYXQgOTAlLgogICAgKiBAcGFyYW0ge251bWJlcn0geDAgLSBUaGUgcG9zaXRpb24gb2YgdGhlIGZpcnN0IHBvaW50IGRlZmluaW5nIHRoZSBsaW5lIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQgZGlyZWN0aW9uIGFuZCBzaXplLgogICAgKiBAcGFyYW0ge251bWJlcn0geTAgLSBUaGUgcG9zaXRpb24gb2YgdGhlIGZpcnN0IHBvaW50IGRlZmluaW5nIHRoZSBsaW5lIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQgZGlyZWN0aW9uIGFuZCBzaXplLgogICAgKiBAcGFyYW0ge251bWJlcn0geDEgLSBUaGUgcG9zaXRpb24gb2YgdGhlIHNlY29uZCBwb2ludCBkZWZpbmluZyB0aGUgbGluZSB0aGF0IGRlZmluZXMgdGhlIGdyYWRpZW50IGRpcmVjdGlvbiBhbmQgc2l6ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkxIC0gVGhlIHBvc2l0aW9uIG9mIHRoZSBzZWNvbmQgcG9pbnQgZGVmaW5pbmcgdGhlIGxpbmUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudCBkaXJlY3Rpb24gYW5kIHNpemUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGJlZ2luTGluZWFyR3JhZGllbnRGaWxsOiBmdW5jdGlvbiAoY29sb3JzLCByYXRpb3MsIHgwLCB5MCwgeDEsIHkxKSB7CgogICAgICAgIHZhciBncmFkaWVudCA9IHRoaXMuY3JlYXRlTGluZWFyR3JhZGllbnQoeDAsIHkwLCB4MSwgeTEpOwoKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gY29sb3JzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKHJhdGlvc1tpXSwgY29sb3JzW2ldKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZmlsbFN0eWxlKGdyYWRpZW50KTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQmVnaW5zIGEgbGluZWFyIGdyYWRpZW50IHN0cm9rZSBkZWZpbmVkIGJ5IHRoZSBsaW5lICh4MCwgeTApIHRvICh4MSwgeTEpLiBUaGlzIGVuZHMgdGhlIGN1cnJlbnQgc3ViLXBhdGguIEZvcgogICAgKiBleGFtcGxlLCB0aGUgZm9sbG93aW5nIGNvZGUgZGVmaW5lcyBhIGJsYWNrIHRvIHdoaXRlIHZlcnRpY2FsIGdyYWRpZW50IHJhbmdpbmcgZnJvbSAyMHB4IHRvIDEyMHB4LCBhbmQgZHJhd3MgYQogICAgKiBzcXVhcmUgdG8gZGlzcGxheSBpdDoKICAgICoKICAgICogICAgICBgYGBteUdyYXBoaWNzLnNldFN0cm9rZVN0eWxlKDEwKS5iZWdpbkxpbmVhckdyYWRpZW50U3Ryb2tlKFsiIzAwMCIsIiNGRkYiXSwgWzAsIDFdLCAwLCAyMCwgMCwgMTIwKS5kcmF3UmVjdCgyMCwgMjAsIDEyMCwgMTIwKTtgYGAKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNiZWdpbkxpbmVhckdyYWRpZW50U3Ryb2tlCiAgICAqIEBwYXJhbSB7QXJyYXl9IGNvbG9ycyAtIEFuIGFycmF5IG9mIENTUyBjb21wYXRpYmxlIGNvbG9yIHZhbHVlcy4gRm9yIGV4YW1wbGUsIFsiI0YwMCIsIiMwMEYiXSB3b3VsZCBkZWZpbmUgYSBncmFkaWVudCBkcmF3aW5nIGZyb20gcmVkIHRvIGJsdWUuCiAgICAqIEBwYXJhbSB7QXJyYXl9IHJhdGlvcyAtIEFuIGFycmF5IG9mIGdyYWRpZW50IHBvc2l0aW9ucyB3aGljaCBjb3JyZXNwb25kIHRvIHRoZSBjb2xvcnMuIEZvciBleGFtcGxlLCBbMC4xLCAwLjldIHdvdWxkIGRyYXcgdGhlIGZpcnN0IGNvbG9yIHRvIDEwJSB0aGVuIGludGVycG9sYXRpbmcgdG8gdGhlIHNlY29uZCBjb2xvciBhdCA5MCUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MCAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgcG9pbnQgZGVmaW5pbmcgdGhlIGxpbmUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudCBkaXJlY3Rpb24gYW5kIHNpemUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MCAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgcG9pbnQgZGVmaW5pbmcgdGhlIGxpbmUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudCBkaXJlY3Rpb24gYW5kIHNpemUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MSAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgc2Vjb25kIHBvaW50IGRlZmluaW5nIHRoZSBsaW5lIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQgZGlyZWN0aW9uIGFuZCBzaXplLgogICAgKiBAcGFyYW0ge251bWJlcn0geTEgLSBUaGUgcG9zaXRpb24gb2YgdGhlIHNlY29uZCBwb2ludCBkZWZpbmluZyB0aGUgbGluZSB0aGF0IGRlZmluZXMgdGhlIGdyYWRpZW50IGRpcmVjdGlvbiBhbmQgc2l6ZS4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgYmVnaW5MaW5lYXJHcmFkaWVudFN0cm9rZTogZnVuY3Rpb24gKGNvbG9ycywgcmF0aW9zLCB4MCwgeTAsIHgxLCB5MSkgewoKICAgICAgICB2YXIgZ3JhZGllbnQgPSB0aGlzLmNyZWF0ZUxpbmVhckdyYWRpZW50KHgwLCB5MCwgeDEsIHkxKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGNvbG9ycy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcChyYXRpb3NbaV0sIGNvbG9yc1tpXSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0cm9rZVN0eWxlKGdyYWRpZW50KTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQmVnaW5zIGEgcmFkaWFsIGdyYWRpZW50IHN0cm9rZS4gVGhpcyBlbmRzIHRoZSBjdXJyZW50IHN1Yi1wYXRoLiBGb3IgZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBjb2RlIGRlZmluZXMgYSByZWQgdG8KICAgICogYmx1ZSByYWRpYWwgZ3JhZGllbnQgY2VudGVyZWQgYXQgKDEwMCwgMTAwKSwgd2l0aCBhIHJhZGl1cyBvZiA1MCwgYW5kIGRyYXdzIGEgcmVjdGFuZ2xlIHRvIGRpc3BsYXkgaXQ6CiAgICAqCiAgICAqICAgICAgbXlHcmFwaGljcy5zZXRTdHJva2VTdHlsZSgxMCkKICAgICogICAgICAgICAgLmJlZ2luUmFkaWFsR3JhZGllbnRTdHJva2UoWyIjRjAwIiwiIzAwRiJdLCBbMCwgMV0sIDEwMCwgMTAwLCAwLCAxMDAsIDEwMCwgNTApCiAgICAqICAgICAgICAgIC5kcmF3UmVjdCg1MCwgOTAsIDE1MCwgMTEwKTsKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNiZWdpblJhZGlhbEdyYWRpZW50U3Ryb2tlCiAgICAqIEBwYXJhbSB7QXJyYXl9IGNvbG9ycyAtIEFuIGFycmF5IG9mIENTUyBjb21wYXRpYmxlIGNvbG9yIHZhbHVlcy4gRm9yIGV4YW1wbGUsIFsiI0YwMCIsIiMwMEYiXSB3b3VsZCBkZWZpbmUgYSBncmFkaWVudCBkcmF3aW5nIGZyb20gcmVkIHRvIGJsdWUuCiAgICAqIEBwYXJhbSB7QXJyYXl9IHJhdGlvcyAtIEFuIGFycmF5IG9mIGdyYWRpZW50IHBvc2l0aW9ucyB3aGljaCBjb3JyZXNwb25kIHRvIHRoZSBjb2xvcnMuIEZvciBleGFtcGxlLCBbMC4xLCAwLjldIHdvdWxkIGRyYXcgdGhlIGZpcnN0IGNvbG9yIHRvIDEwJSB0aGVuIGludGVycG9sYXRpbmcgdG8gdGhlIHNlY29uZCBjb2xvciBhdCA5MCUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MCAtIENlbnRlciBwb3NpdGlvbiBvZiB0aGUgaW5uZXIgY2lyY2xlIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MCAtIENlbnRlciBwb3NpdGlvbiBvZiB0aGUgaW5uZXIgY2lyY2xlIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByMCAtIFJhZGl1cyBvZiB0aGUgaW5uZXIgY2lyY2xlIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MSAtIENlbnRlciBwb3NpdGlvbiBvZiB0aGUgb3V0ZXIgY2lyY2xlIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MSAtIENlbnRlciBwb3NpdGlvbiBvZiB0aGUgb3V0ZXIgY2lyY2xlIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByMSAtIFJhZGl1cyBvZiB0aGUgb3V0ZXIgY2lyY2xlIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGJlZ2luUmFkaWFsR3JhZGllbnRTdHJva2U6IGZ1bmN0aW9uIChjb2xvcnMsIHJhdGlvcywgeDAsIHkwLCByMCwgeDEsIHkxLCByMSkgewoKICAgICAgICB2YXIgZ3JhZGllbnQgPSB0aGlzLmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgwLCB5MCwgcjAsIHgxLCB5MSwgcjEpOwoKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gY29sb3JzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKHJhdGlvc1tpXSwgY29sb3JzW2ldKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3Ryb2tlU3R5bGUoZ3JhZGllbnQpOwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdGFydHMgYSBuZXcgcGF0aCBieSByZXNldHRpbmcgdGhlIGxpc3Qgb2Ygc3ViLXBhdGhzLiBDYWxsIHRoaXMgbWV0aG9kIHdoZW4geW91IHdhbnQgdG8gY3JlYXRlIGEgbmV3IHBhdGguCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjYmVnaW5QYXRoCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGJlZ2luUGF0aDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQmVnaW5zIGEgc3Ryb2tlIHdpdGggdGhlIHNwZWNpZmllZCBjb2xvci4gVGhpcyBlbmRzIHRoZSBjdXJyZW50IHN1Yi1wYXRoLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2JlZ2luU3Ryb2tlCiAgICAqIEBwYXJhbSB7U3RyaW5nfSBjb2xvciBBIENTUyBjb21wYXRpYmxlIGNvbG9yIHZhbHVlIChleC4gIiNGRjAwMDAiLCAicmVkIiwgb3IgInJnYmEoMjU1LDAsMCwwLjUpIikuIFNldHRpbmcgdG8gbnVsbCB3aWxsIHJlc3VsdCBpbiBubyBzdHJva2UuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGJlZ2luU3Ryb2tlOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdGhpcy5zdHJva2VTdHlsZShjb2xvcik7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyBhIGJlemllciBjdXJ2ZSBmcm9tIHRoZSBjdXJyZW50IGNvbnRleHQgcG9pbnQgdG8gKHgsIHkpIHVzaW5nIHRoZSBjb250cm9sIHBvaW50cyAoY3AxeCwgY3AxeSkgYW5kIChjcDJ4LCBjcDJ5KS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNiZXppZXJDdXJ2ZVRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjcDF4IC0gVGhlIHggYXhpcyBvZiBjb250cm9sIHBvaW50IDEuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjcDF5IC0gVGhlIHkgYXhpcyBvZiBjb250cm9sIHBvaW50IDEuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjcDJ4IC0gVGhlIHggYXhpcyBvZiBjb250cm9sIHBvaW50IDIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjcDJ5IC0gVGhlIHkgYXhpcyBvZiBjb250cm9sIHBvaW50IDIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggYXhpcyBvZiB0aGUgZW5kaW5nIHBvaW50LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGVuZGluZyBwb2ludC4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgYmV6aWVyQ3VydmVUbzogZnVuY3Rpb24gKGNwMXgsIGNwMXksIGNwMngsIGNwMnksIHgsIHkpIHsKCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY29udGV4dC5iZXppZXJDdXJ2ZVRvKGNwMXgsIGNwMXksIGNwMngsIGNwMnksIHgsIHkpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERyYXdzIGEgY2lyY2xlIHdpdGggdGhlIHNwZWNpZmllZCByYWRpdXMgYXQgKHgsIHkpLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2NpcmNsZQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIHggY29vcmRpbmF0ZSBjZW50ZXIgcG9pbnQgb2YgY2lyY2xlLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIHkgY29vcmRpbmF0ZSBjZW50ZXIgcG9pbnQgb2YgY2lyY2xlLgogICAgKiBAcGFyYW0ge251bWJlcn0gcmFkaXVzIC0gUmFkaXVzIG9mIGNpcmNsZSBpbiByYWRpYW5zLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBjaXJjbGU6IGZ1bmN0aW9uICh4LCB5LCByYWRpdXMpIHsKCiAgICAgICAgdGhpcy5hcmMoeCwgeSwgcmFkaXVzLCAwLCBNYXRoLlBJKjIpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgYWxsIHBpeGVscyBpbiB0aGUgcmVjdGFuZ2xlIGRlZmluZWQgYnkgc3RhcnRpbmcgcG9pbnQgKHgsIHkpIGFuZCBzaXplICh3aWR0aCwgaGVpZ2h0KSB0byB0cmFuc3BhcmVudCBibGFjay4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNjbGVhclJlY3QKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgcmVjdGFuZ2xlIHN0YXJ0aW5nIHBvaW50LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSByZWN0YW5nbGUgc3RhcnRpbmcgcG9pbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSByZWN0YW5nbGVzIHdpZHRoLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIHJlY3RhbmdsZXMgaGVpZ2h0LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBjbGVhclJlY3Q6IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNvbnRleHQuY2xlYXJSZWN0KHgsIHksIHdpZHRoLCBoZWlnaHQpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBjbGlwcGluZyBwYXRoIGZyb20gdGhlIGN1cnJlbnQgc3ViLXBhdGhzLiBFdmVyeXRoaW5nIGRyYXduIGFmdGVyIGNsaXAoKSBpcyBjYWxsZWQgYXBwZWFycyBpbnNpZGUgdGhlIGNsaXBwaW5nIHBhdGggb25seS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNjbGlwCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGNsaXA6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY29udGV4dC5jbGlwKCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogVHJpZXMgdG8gZHJhdyBhIHN0cmFpZ2h0IGxpbmUgZnJvbSB0aGUgY3VycmVudCBwb2ludCB0byB0aGUgc3RhcnQuIElmIHRoZSBzaGFwZSBoYXMgYWxyZWFkeSBiZWVuIGNsb3NlZCBvciBoYXMgb25seSBvbmUgcG9pbnQsIHRoaXMgZnVuY3Rpb24gZG9lcyBub3RoaW5nLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2Nsb3NlUGF0aAogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBjbG9zZVBhdGg6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbGluZWFyIGdyYWRpZW50IHdpdGggZGVmaW5lZCBieSBhbiBpbWFnaW5hcnkgbGluZSB3aGljaCBpbXBsaWVzIHRoZSBkaXJlY3Rpb24gb2YgdGhlIGdyYWRpZW50LgogICAgKiBPbmNlIHRoZSBncmFkaWVudCBpcyBjcmVhdGVkIGNvbG9ycyBjYW4gYmUgaW5zZXJ0ZWQgdXNpbmcgdGhlIGFkZENvbG9yU3RvcCBtZXRob2QuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjY3JlYXRlTGluZWFyR3JhZGllbnQKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgZ3JhZGllbnRzIHN0YXJ0aW5nIHBvaW50LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSBncmFkaWVudHMgc3RhcnRpbmcgcG9pbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgZ3JhZGllbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBncmFkaWVudC4KICAgICogQHJldHVybiB7Q2FudmFzR3JhZGllbnR9IFRoZSBMaW5lYXIgR3JhZGllbnQuCiAgICAqLwogICAgY3JlYXRlTGluZWFyR3JhZGllbnQ6IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHJldHVybiB0aGlzLmNvbnRleHQuY3JlYXRlTGluZWFyR3JhZGllbnQoeCwgeSwgd2lkdGgsIGhlaWdodCk7CgogICAgfSwKCiAgICAvLyAgY3JlYXRlUGF0dGVybgoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgcmFkaWFsIGdyYWRpZW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2NyZWF0ZVJhZGlhbEdyYWRpZW50CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MAogICAgKiBAcGFyYW0ge251bWJlcn0geTAKICAgICogQHBhcmFtIHtudW1iZXJ9IHIwCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MQogICAgKiBAcGFyYW0ge251bWJlcn0geTEKICAgICogQHBhcmFtIHtudW1iZXJ9IHIxCiAgICAqIEByZXR1cm4ge0NhbnZhc0dyYWRpZW50fSBUaGUgUmFkaWFsIEdyYWRpZW50LgogICAgKi8KICAgIGNyZWF0ZVJhZGlhbEdyYWRpZW50OiBmdW5jdGlvbiAoeDAsIHkwLCByMCwgeDEsIHkxLCByMSkgewoKICAgICAgICByZXR1cm4gdGhpcy5jb250ZXh0LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgwLCB5MCwgcjAsIHgxLCB5MSwgcjEpOwoKICAgIH0sCgogICAgLy8gIGRyYXdJbWFnZQogICAgLy8gIGRyYXdTeXN0ZW1Gb2N1c1JpbmcgKD8pCgogICAgLyoqCiAgICAqIERyYXdzIGFuIGVsbGlwc2UgKG92YWwpIHdpdGggYSBzcGVjaWZpZWQgd2lkdGggKHcpIGFuZCBoZWlnaHQgKGgpLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2VsbGlwc2UKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSB4IGNvb3JkaW5hdGUgY2VudGVyIHBvaW50IG9mIGVsbGlwc2UuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0geSBjb29yZGluYXRlIGNlbnRlciBwb2ludCBvZiBlbGxpcHNlLgogICAgKiBAcGFyYW0ge251bWJlcn0gdyAtIGhlaWdodCAoaG9yaXpvbnRhbCBkaWFtZXRlcikgb2YgZWxsaXBzZS4gVGhlIGhvcml6b250YWwgcmFkaXVzIHdpbGwgYmUgaGFsZiBvZiB0aGlzIG51bWJlci4KICAgICogQHBhcmFtIHtudW1iZXJ9IGggLSB3aWR0aCAodmVydGljYWwgZGlhbWV0ZXIpIG9mIGVsbGlwc2UuIFRoZSB2ZXJ0aWNhbCByYWRpdXMgd2lsbCBiZSBoYWxmIG9mIHRoaXMgbnVtYmVyLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBlbGxpcHNlOiBmdW5jdGlvbiAoeCwgeSwgdywgaCkgewoKICAgICAgICB2YXIgayA9IDAuNTUyMjg0ODsKICAgICAgICB2YXIgb3ggPSAodyAvIDIpICogazsKICAgICAgICB2YXIgb3kgPSAoaCAvIDIpICogazsKICAgICAgICB2YXIgeGUgPSB4ICsgdzsKICAgICAgICB2YXIgeWUgPSB5ICsgaDsKICAgICAgICB2YXIgeG0gPSB4ICsgdyAvIDI7CiAgICAgICAgdmFyIHltID0geSArIGggLyAyOwogICAgICAgICAgICAKICAgICAgICB0aGlzLm1vdmVUbyh4LCB5bSk7CiAgICAgICAgdGhpcy5iZXppZXJDdXJ2ZVRvKHgsIHltIC0gb3ksIHhtIC0gb3gsIHksIHhtLCB5KTsKICAgICAgICB0aGlzLmJlemllckN1cnZlVG8oeG0gKyBveCwgeSwgeGUsIHltIC0gb3ksIHhlLCB5bSk7CiAgICAgICAgdGhpcy5iZXppZXJDdXJ2ZVRvKHhlLCB5bSArIG95LCB4bSArIG94LCB5ZSwgeG0sIHllKTsKICAgICAgICB0aGlzLmJlemllckN1cnZlVG8oeG0gLSBveCwgeWUsIHgsIHltICsgb3ksIHgsIHltKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogRmlsbHMgdGhlIHN1YnBhdGhzIHdpdGggdGhlIGN1cnJlbnQgZmlsbCBzdHlsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNmaWxsCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGZpbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsKCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogRHJhd3MgYSBmaWxsZWQgcmVjdGFuZ2xlIGF0ICh4LCB5KSBwb3NpdGlvbiB3aG9zZSBzaXplIGlzIGRldGVybWluZWQgYnkgd2lkdGggYW5kIGhlaWdodC4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNmaWxsUmVjdAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSByZWN0YW5nbGUgc3RhcnRpbmcgcG9pbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIHJlY3RhbmdsZSBzdGFydGluZyBwb2ludC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHJlY3RhbmdsZXMgd2lkdGguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgcmVjdGFuZ2xlcyBoZWlnaHQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGZpbGxSZWN0OiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHgsIHksIHdpZHRoLCBoZWlnaHQpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGZpbGwgc3R5bGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjZmlsbFN0eWxlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBjb2xvciAtIFRoZSBmaWxsIGNvbG9yIHZhbHVlIGluIENTUyBmb3JtYXQ6ICNSUkdHQkIgb3IgcmdiYShyLGcsYixhKQogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBmaWxsU3R5bGU6IGZ1bmN0aW9uIChjb2xvcikgewoKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvLyAgZmlsbFRleHQKCiAgICAvKioKICAgICogU2V0cyB0aGUgZm9udC4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNmb250CiAgICAqIEBwYXJhbSB7RE9NU3RyaW5nfSBmb250IC0gVGhlIGZvbnQgdG8gYmUgdXNlZCBmb3IgYW55IHRleHQgcmVuZGVyaW5nLiBEZWZhdWx0IHZhbHVlIDEwcHggc2Fucy1zZXJpZi4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgZm9udDogZnVuY3Rpb24gKGZvbnQpIHsKCiAgICAgICAgdGhpcy5jb250ZXh0LmZvbnQgPSBmb250OwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFscGhhIHZhbHVlIHRoYXQgaXMgYXBwbGllZCB0byBzaGFwZXMgYW5kIGltYWdlcyBiZWZvcmUgdGhleSBhcmUgY29tcG9zaXRlZCBvbnRvIHRoZSBjYW52YXMuIERlZmF1bHQgMS4wIChvcGFxdWUpLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2dsb2JhbEFscGhhCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIEFscGhhIHZhbHVlIHRoYXQgaXMgYXBwbGllZCB0byBzaGFwZXMgYW5kIGltYWdlcyBiZWZvcmUgdGhleSBhcmUgY29tcG9zaXRlZCBvbnRvIHRoZSBjYW52YXMuIERlZmF1bHQgMS4wIChvcGFxdWUpLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBnbG9iYWxBbHBoYTogZnVuY3Rpb24gKGFscGhhKSB7CgogICAgICAgIHRoaXMuY29udGV4dC5nbG9iYWxBbHBoYSA9IGFscGhhOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFdpdGggZ2xvYmFsQWxwaGEgYXBwbGllZCB0aGlzIHNldHMgaG93IHNoYXBlcyBhbmQgaW1hZ2VzIGFyZSBkcmF3biBvbnRvIHRoZSBleGlzdGluZyBiaXRtYXAuIFBvc3NpYmxlIHZhbHVlczogc291cmNlLWF0b3AsIHNvdXJjZS1pbiwgc291cmNlLW91dCwKICAgICogc291cmNlLW92ZXIgKGRlZmF1bHQpLCBkZXN0aW5hdGlvbi1hdG9wLCBkZXN0aW5hdGlvbi1pbiwgZGVzdGluYXRpb24tb3V0LCBkZXN0aW5hdGlvbi1vdmVyLCBsaWdodGVyLCBkYXJrZXIsIGNvcHkgYW5kIHhvci4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNnbG9iYWxDb21wb3NpdGVPcGVyYXRpb24KICAgICogQHBhcmFtIHtET01TdHJpbmd9IG9wZXJhdGlvbiAtIFRoZSBjb21wb3NpdGUgb3BlcmF0aW9uIHRvIGFwcGx5LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBnbG9iYWxDb21wb3NpdGVPcGVyYXRpb246IGZ1bmN0aW9uIChvcGVyYXRpb24pIHsKCiAgICAgICAgdGhpcy5jb250ZXh0Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9IG9wZXJhdGlvbjsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUeXBlIG9mIGVuZGluZ3Mgb24gdGhlIGVuZCBvZiBsaW5lcy4gUG9zc2libGUgdmFsdWVzOiBidXR0IChkZWZhdWx0KSwgcm91bmQsIHNxdWFyZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNsaW5lQ2FwCiAgICAqIEBwYXJhbSB7RE9NU3RyaW5nfSBzdHlsZSAtIFBvc3NpYmxlIHZhbHVlczogYnV0dCAoZGVmYXVsdCksIHJvdW5kLCBzcXVhcmUKICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgbGluZUNhcDogZnVuY3Rpb24gKHN0eWxlKSB7CgogICAgICAgIHRoaXMuY29udGV4dC5saW5lQ2FwID0gc3R5bGU7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogU3BlY2lmaWVzIHdoZXJlIHRvIHN0YXJ0IGEgZGFzaGFycmF5IG9uIGEgbGluZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNsaW5lRGFzaE9mZnNldAogICAgKiBAcGFyYW0ge251bWJlcn0gb2Zmc2V0IC0gU3BlY2lmaWVzIHdoZXJlIHRvIHN0YXJ0IGEgZGFzaGFycmF5IG9uIGEgbGluZS4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgbGluZURhc2hPZmZzZXQ6IGZ1bmN0aW9uIChvZmZzZXQpIHsKCiAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVEYXNoT2Zmc2V0ID0gb2Zmc2V0OwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERlZmluZXMgdGhlIHR5cGUgb2YgY29ybmVycyB3aGVyZSB0d28gbGluZXMgbWVldC4gUG9zc2libGUgdmFsdWVzOiByb3VuZCwgYmV2ZWwsIG1pdGVyIChkZWZhdWx0KQogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2xpbmVKb2luCiAgICAqIEBwYXJhbSB7RE9NU3RyaW5nfSBqb2luIC0gUG9zc2libGUgdmFsdWVzOiByb3VuZCwgYmV2ZWwsIG1pdGVyIChkZWZhdWx0KQogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBsaW5lSm9pbjogZnVuY3Rpb24gKGpvaW4pIHsKCiAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVKb2luID0gam9pbjsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBXaWR0aCBvZiBsaW5lcy4gRGVmYXVsdCAxLjAKICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNsaW5lV2lkdGgKICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gV2lkdGggb2YgbGluZXMuIERlZmF1bHQgMS4wCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGxpbmVXaWR0aDogZnVuY3Rpb24gKHdpZHRoKSB7CgogICAgICAgIHRoaXMuY29udGV4dC5saW5lV2lkdGggPSB3aWR0aDsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBEZWZhdWx0IDEwLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI21pdGVyTGltaXQKICAgICogQHBhcmFtIHtudW1iZXJ9IGxpbWl0IC0gRGVmYXVsdCAxMC4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgbWl0ZXJMaW1pdDogZnVuY3Rpb24gKGxpbWl0KSB7CgogICAgICAgIHRoaXMuY29udGV4dC5taXRlckxpbWl0ID0gbGltaXQ7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvLyAgZ2V0SW1hZ2VEYXRhCiAgICAvLyAgZ2V0TGluZURhc2gKICAgIC8vICBpc1BvaW50SW5QYXRoCiAgICAvLyAgaXNQb2ludEluU3Ryb2tlCgogICAgLyoqCiAgICAqIENvbm5lY3RzIHRoZSBsYXN0IHBvaW50IGluIHRoZSBzdWJwYXRoIHRvIHRoZSB4LCB5IGNvb3JkaW5hdGVzIHdpdGggYSBzdHJhaWdodCBsaW5lLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2xpbmVUbwogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSBlbmQgb2YgdGhlIGxpbmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIGVuZCBvZiB0aGUgbGluZS4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgbGluZVRvOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVUbyh4LCB5KTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8vICBtZWFzdXJlVGV4dAoKICAgIC8qKgogICAgKiBNb3ZlcyB0aGUgc3RhcnRpbmcgcG9pbnQgb2YgYSBuZXcgc3VicGF0aCB0byB0aGUgKHgsIHkpIGNvb3JkaW5hdGVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI21vdmVUbwogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGF4aXMgb2YgdGhlIHBvaW50LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIHBvaW50LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBtb3ZlVG86IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMuY29udGV4dC5tb3ZlVG8oeCwgeSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvLyAgcHV0SW1hZ2VEYXRhCgogICAgLyoqCiAgICAqIERyYXdzIGEgcXVhZHJhdGljIGN1cnZlIGZyb20gdGhlIGN1cnJlbnQgZHJhd2luZyBwb2ludCB0byAoeCwgeSkgdXNpbmcgdGhlIGNvbnRyb2wgcG9pbnQgKGNweCwgY3B5KS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNxdWFkcmF0aWNDdXJ2ZVRvCiAgICAqIEBwYXJhbSB7TnVtYmVyfSBjcHggLSBUaGUgeCBheGlzIG9mIHRoZSBjb250cm9sIHBvaW50LgogICAgKiBAcGFyYW0ge051bWJlcn0gY3B5IC0gVGhlIHkgYXhpcyBvZiB0aGUgY29udHJvbCBwb2ludC4KICAgICogQHBhcmFtIHtOdW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBlbmRpbmcgcG9pbnQuCiAgICAqIEBwYXJhbSB7TnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgZW5kaW5nIHBvaW50LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBxdWFkcmF0aWNDdXJ2ZVRvOiBmdW5jdGlvbihjcHgsIGNweSwgeCwgeSkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LnF1YWRyYXRpY0N1cnZlVG8oY3B4LCBjcHksIHgsIHkpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERyYXdzIGEgcmVjdGFuZ2xlIGF0ICh4LCB5KSBwb3NpdGlvbiB3aG9zZSBzaXplIGlzIGRldGVybWluZWQgYnkgd2lkdGggYW5kIGhlaWdodC4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNyZWN0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIHJlY3RhbmdsZSBzdGFydGluZyBwb2ludC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgcmVjdGFuZ2xlIHN0YXJ0aW5nIHBvaW50LgogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgcmVjdGFuZ2xlcyB3aWR0aC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSByZWN0YW5nbGVzIGhlaWdodC4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgcmVjdDogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY29udGV4dC5yZWN0KHgsIHksIHdpZHRoLCBoZWlnaHQpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCiAgICAKICAgIC8qKgogICAgKiBSZXN0b3JlcyB0aGUgZHJhd2luZyBzdHlsZSBzdGF0ZSB0byB0aGUgbGFzdCBlbGVtZW50IG9uIHRoZSAnc3RhdGUgc3RhY2snIHNhdmVkIGJ5IHNhdmUoKS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNyZXN0b3JlCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIHJlc3RvcmU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY29udGV4dC5yZXN0b3JlKCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogUm90YXRlcyB0aGUgZHJhd2luZyBjb250ZXh0IHZhbHVlcyBieSByIHJhZGlhbnMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjcm90YXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBvZiByb3RhdGlvbiBnaXZlbiBpbiByYWRpYW5zLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICByb3RhdGU6IGZ1bmN0aW9uIChhbmdsZSkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LnJvdGF0ZShhbmdsZSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgc3Ryb2tlIHN0eWxlIGZvciB0aGUgY3VycmVudCBzdWItcGF0aC4gTGlrZSBhbGwgZHJhd2luZyBtZXRob2RzLCB0aGlzIGNhbiBiZSBjaGFpbmVkLCBzbyB5b3UgY2FuIGRlZmluZQogICAgKiB0aGUgc3Ryb2tlIHN0eWxlIGFuZCBjb2xvciBpbiBhIHNpbmdsZSBsaW5lIG9mIGNvZGUgbGlrZSBzbzoKICAgICoKICAgICogICAgICBgYGBteUdyYXBoaWNzLnNldFN0cm9rZVN0eWxlKDgsInJvdW5kIikuYmVnaW5TdHJva2UoIiNGMDAiKTtgYGAKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNzZXRTdHJva2VTdHlsZQogICAgKiBAcGFyYW0ge251bWJlcn0gdGhpY2tuZXNzIC0gVGhlIHdpZHRoIG9mIHRoZSBzdHJva2UuCiAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW2NhcHM9MF0gLSBJbmRpY2F0ZXMgdGhlIHR5cGUgb2YgY2FwcyB0byB1c2UgYXQgdGhlIGVuZCBvZiBsaW5lcy4gT25lIG9mIGJ1dHQsIHJvdW5kLCBvciBzcXVhcmUuIERlZmF1bHRzIHRvICJidXR0Ii4gQWxzbyBhY2NlcHRzIHRoZSB2YWx1ZXMgMCAoYnV0dCksIDEgKHJvdW5kKSwgYW5kIDIgKHNxdWFyZSkgZm9yIHVzZSB3aXRoIGhlIHRpbnkgQVBJLgogICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtqb2ludHM9MF0gU3BlY2lmaWVzIHRoZSB0eXBlIG9mIGpvaW50cyB0aGF0IHNob3VsZCBiZSB1c2VkIHdoZXJlIHR3byBsaW5lcyBtZWV0LiBPbmUgb2YgYmV2ZWwsIHJvdW5kLCBvciBtaXRlci4gRGVmYXVsdHMgdG8gIm1pdGVyIi4gQWxzbyBhY2NlcHRzIHRoZSB2YWx1ZXMgMCAobWl0ZXIpLCAxIChyb3VuZCksIGFuZCAyIChiZXZlbCkgZm9yIHVzZSB3aXRoIHRoZSB0aW55IEFQSS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFttaXRlckxpbWl0PTEwXSAtIElmIGpvaW50cyBpcyBzZXQgdG8gIm1pdGVyIiwgdGhlbiB5b3UgY2FuIHNwZWNpZnkgYSBtaXRlciBsaW1pdCByYXRpbyB3aGljaCBjb250cm9scyBhdCB3aGF0IHBvaW50IGEgbWl0ZXJlZCBqb2ludCB3aWxsIGJlIGNsaXBwZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2lnbm9yZVNjYWxlPWZhbHNlXSAtIElmIHRydWUsIHRoZSBzdHJva2Ugd2lsbCBiZSBkcmF3biBhdCB0aGUgc3BlY2lmaWVkIHRoaWNrbmVzcyByZWdhcmRsZXNzIG9mIGFjdGl2ZSB0cmFuc2Zvcm1hdGlvbnMuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIHNldFN0cm9rZVN0eWxlOiBmdW5jdGlvbiAodGhpY2tuZXNzLCBjYXBzLCBqb2ludHMsIG1pdGVyTGltaXQsIGlnbm9yZVNjYWxlKSB7CgogICAgICAgIGlmICh0eXBlb2YgdGhpY2tuZXNzID09PSAndW5kZWZpbmVkJykgeyB0aGlja25lc3MgPSAxOyB9CiAgICAgICAgaWYgKHR5cGVvZiBjYXBzID09PSAndW5kZWZpbmVkJykgeyBjYXBzID0gJ2J1dHQnOyB9CiAgICAgICAgaWYgKHR5cGVvZiBqb2ludHMgPT09ICd1bmRlZmluZWQnKSB7IGpvaW50cyA9ICdtaXRlcic7IH0KICAgICAgICBpZiAodHlwZW9mIG1pdGVyTGltaXQgPT09ICd1bmRlZmluZWQnKSB7IG1pdGVyTGltaXQgPSAxMDsgfQoKICAgICAgICAvLyAgVE9ETwogICAgICAgIGlnbm9yZVNjYWxlID0gZmFsc2U7CgogICAgICAgIHRoaXMubGluZVdpZHRoKHRoaWNrbmVzcyk7CiAgICAgICAgdGhpcy5saW5lQ2FwKGNhcHMpOwogICAgICAgIHRoaXMubGluZUpvaW4oam9pbnRzKTsKICAgICAgICB0aGlzLm1pdGVyTGltaXQobWl0ZXJMaW1pdCk7CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNhdmVzIHRoZSBjdXJyZW50IGRyYXdpbmcgc3R5bGUgc3RhdGUgdXNpbmcgYSBzdGFjayBzbyB5b3UgY2FuIHJldmVydCBhbnkgY2hhbmdlIHlvdSBtYWtlIHRvIGl0IHVzaW5nIHJlc3RvcmUoKS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNzYXZlCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIHNhdmU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY29udGV4dC5zYXZlKCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2NhbGVzIHRoZSBjdXJyZW50IGRyYXdpbmcgY29udGV4dC4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNzY2FsZQogICAgKiBAcGFyYW0ge251bWJlcn0geAogICAgKiBAcGFyYW0ge251bWJlcn0geQogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBzY2FsZTogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY29udGV4dC5zY2FsZSh4LCB5KTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNzY3JvbGxQYXRoSW50b1ZpZXcKICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgc2Nyb2xsUGF0aEludG9WaWV3OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNvbnRleHQuc2Nyb2xsUGF0aEludG9WaWV3KCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvLyAgc2V0TGluZURhc2gKICAgIC8vICBzZXRUcmFuc2Zvcm0KCiAgICAvKioKICAgICogU3Ryb2tlcyB0aGUgc3VicGF0aHMgd2l0aCB0aGUgY3VycmVudCBzdHJva2Ugc3R5bGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjc3Ryb2tlCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIHN0cm9rZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZSgpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFBhaW50cyBhIHJlY3RhbmdsZSB3aGljaCBoYXMgYSBzdGFydGluZyBwb2ludCBhdCAoeCwgeSkgYW5kIGhhcyBhIHcgd2lkdGggYW5kIGFuIGggaGVpZ2h0IG9udG8gdGhlIGNhbnZhcywgdXNpbmcgdGhlIGN1cnJlbnQgc3Ryb2tlIHN0eWxlLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI3N0cm9rZVJlY3QKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIGZvciB0aGUgc3RhcnRpbmcgcG9pbnQgb2YgdGhlIHJlY3RhbmdsZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBheGlzIGZvciB0aGUgc3RhcnRpbmcgcG9pbnQgb2YgdGhlIHJlY3RhbmdsZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHJlY3RhbmdsZXMgd2lkdGguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgcmVjdGFuZ2xlcyBoZWlnaHQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIHN0cm9rZVJlY3Q6IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlUmVjdCh4LCB5LCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDb2xvciBvciBzdHlsZSB0byB1c2UgZm9yIHRoZSBsaW5lcyBhcm91bmQgc2hhcGVzLiBEZWZhdWx0ICMwMDAgKGJsYWNrKS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNzdHJva2VTdHlsZQogICAgKiBAcGFyYW0ge3N0cmluZ30gc3R5bGUgLSBDb2xvciBvciBzdHlsZSB0byB1c2UgZm9yIHRoZSBsaW5lcyBhcm91bmQgc2hhcGVzLiBEZWZhdWx0ICMwMDAgKGJsYWNrKS4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgc3Ryb2tlU3R5bGU6IGZ1bmN0aW9uIChzdHlsZSkgewoKICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSBzdHlsZTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8vICBzdHJva2VUZXh0CiAgICAvLyAgdHJhbnNmb3JtCiAgICAvLyAgdHJhbnNsYXRlCgogICAgLyoqCiAgICAqIElmIHRoZSBnYW1lIGlzIHJ1bm5pbmcgaW4gV2ViR0wgdGhpcyB3aWxsIHB1c2ggdGhlIHRleHR1cmUgdXAgdG8gdGhlIEdQVSBpZiBpdCdzIGRpcnR5LgogICAgKiBUaGlzIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGlmIHRoZSBCaXRtYXBEYXRhIGlzIGJlaW5nIHVzZWQgYnkgYSBTcHJpdGUsIG90aGVyd2lzZSB5b3UgbmVlZCB0byByZW1lbWJlciB0byBjYWxsIGl0IGluIHlvdXIgcmVuZGVyIGZ1bmN0aW9uLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI3JlbmRlcgogICAgKi8KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fZGlydHkpCiAgICAgICAgewogICAgICAgICAgICAvLyAgT25seSBuZWVkZWQgaWYgcnVubmluZyBpbiBXZWJHTCwgb3RoZXJ3aXNlIHRoaXMgYXJyYXkgd2lsbCBuZXZlciBnZXQgY2xlYXJlZCBkb3duCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyVHlwZSA9PSBQaGFzZXIuV0VCR0wpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIFBJWEkudGV4dHVyZXNUb1VwZGF0ZS5wdXNoKHRoaXMuYmFzZVRleHR1cmUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9kaXJ0eSA9IGZhbHNlOwogICAgICAgIH0KCiAgICB9Cgp9OwoKUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkJpdG1hcERhdGE7CgovLyAgRWFzZWxKUyBUaW55IEFQSSBlbXVsYXRpb24KCi8qKgoqIFNob3J0Y3V0IHRvIG1vdmVUby4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5tdAoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUubXQgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUubW92ZVRvOwoKLyoqCiogU2hvcnRjdXQgdG8gbGluZVRvLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLm10CiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5sdCA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5saW5lVG87CgovKioKKiBTaG9ydGN1dCB0byBhcmNUby4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5hdAoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYXQgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYXJjVG87CgovKioKKiBTaG9ydGN1dCB0byBiZXppZXJDdXJ2ZVRvLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJ0CiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5idCA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5iZXppZXJDdXJ2ZVRvOwogICAgCi8qKgoqIFNob3J0Y3V0IHRvIHF1YWRyYXRpY0N1cnZlVG8uCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucXQKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnF0ID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnF1YWRyYXRpY0N1cnZlVG87CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gYXJjLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmEKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmEgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYXJjOwoKLyoqCiogU2hvcnRjdXQgdG8gcmVjdC4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnJlY3Q7CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gY2xvc2VQYXRoLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmNwCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5jcCA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5jbG9zZVBhdGg7CgovKioKKiBTaG9ydGN1dCB0byBjbGVhci4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5jCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5jID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmNsZWFyOwogICAgCi8qKgoqIFNob3J0Y3V0IHRvIGJlZ2luRmlsbC4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5mCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5mID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJlZ2luRmlsbDsKCi8qKgoqIFNob3J0Y3V0IHRvIGJlZ2luTGluZWFyR3JhZGllbnRGaWxsLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmxmCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5sZiA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5iZWdpbkxpbmVhckdyYWRpZW50RmlsbDsKICAgIAovKioKKiBTaG9ydGN1dCB0byBiZWdpblJhZGlhbEdyYWRpZW50RmlsbC4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yZgoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucmYgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5SYWRpYWxHcmFkaWVudEZpbGw7CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5CaXRtYXBGaWxsLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJmCiovCi8vUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJmID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJlZ2luQml0bWFwRmlsbDsKICAgIAovKioKKiBTaG9ydGN1dCB0byBlbmRGaWxsLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmVmCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5lZiA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5lbmRGaWxsOwoKLyoqCiogU2hvcnRjdXQgdG8gc2V0U3Ryb2tlU3R5bGUuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuc3MKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnNzID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnNldFN0cm9rZVN0eWxlOwogICAgCi8qKgoqIFNob3J0Y3V0IHRvIGJlZ2luU3Ryb2tlLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnMKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5TdHJva2U7CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5MaW5lYXJHcmFkaWVudFN0cm9rZS4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5scwoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUubHMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5MaW5lYXJHcmFkaWVudFN0cm9rZTsKCi8qKgoqIFNob3J0Y3V0IHRvIGJlZ2luUmFkaWFsR3JhZGllbnRTdHJva2UuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucnMKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnJzID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJlZ2luUmFkaWFsR3JhZGllbnRTdHJva2U7CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5CaXRtYXBTdHJva2UuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYnMKKi8KLy8gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJzID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJlZ2luQml0bWFwU3Ryb2tlOwogICAgCi8qKgoqIFNob3J0Y3V0IHRvIGVuZFN0cm9rZS4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5lcwoqLwovLyBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZXMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZW5kU3Ryb2tlOwogICAgCi8qKgoqIFNob3J0Y3V0IHRvIHJlY3QuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZHIKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRyID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnJlY3Q7CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gZHJhd1JvdW5kUmVjdC4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5ycgoqLwovLyBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucnIgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZHJhd1JvdW5kUmVjdDsKICAgIAovKioKKiBTaG9ydGN1dCB0byBkcmF3Um91bmRSZWN0Q29tcGxleC4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yYwoqLwovLyBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucmMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZHJhd1JvdW5kUmVjdENvbXBsZXg7CgovKioKKiBTaG9ydGN1dCB0byBkcmF3Q2lyY2xlLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRjCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kYyA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5jaXJjbGU7CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gZHJhd0VsbGlwc2UuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZGUKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRlID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmVsbGlwc2U7CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gZHJhd1BvbHlTdGFyLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRwCiovCi8vIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kcCA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kcmF3UG9seVN0YXI7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBAY2xhc3MgUGhhc2VyLlNwcml0ZQoqCiogQGNsYXNzZGVzYyBDcmVhdGUgYSBuZXcgYFNwcml0ZWAgb2JqZWN0LiBTcHJpdGVzIGFyZSB0aGUgbGlmZWJsb29kIG9mIHlvdXIgZ2FtZSwgdXNlZCBmb3IgbmVhcmx5IGV2ZXJ5dGhpbmcgdmlzdWFsLgoqCiogQXQgaXRzIG1vc3QgYmFzaWMgYSBTcHJpdGUgY29uc2lzdHMgb2YgYSBzZXQgb2YgY29vcmRpbmF0ZXMgYW5kIGEgdGV4dHVyZSB0aGF0IGlzIHJlbmRlcmVkIHRvIHRoZSBjYW52YXMuCiogVGhleSBhbHNvIGNvbnRhaW4gYWRkaXRpb25hbCBwcm9wZXJ0aWVzIGFsbG93aW5nIGZvciBwaHlzaWNzIG1vdGlvbiAodmlhIFNwcml0ZS5ib2R5KSwgaW5wdXQgaGFuZGxpbmcgKHZpYSBTcHJpdGUuaW5wdXQpLAoqIGV2ZW50cyAodmlhIFNwcml0ZS5ldmVudHMpLCBhbmltYXRpb24gKHZpYSBTcHJpdGUuYW5pbWF0aW9ucyksIGNhbWVyYSBjdWxsaW5nIGFuZCBtb3JlLiBQbGVhc2Ugc2VlIHRoZSBFeGFtcGxlcyBmb3IgdXNlIGNhc2VzLgoqCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSAoaW4gd29ybGQgc3BhY2UpIHRvIHBvc2l0aW9uIHRoZSBTcHJpdGUgYXQuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIChpbiB3b3JsZCBzcGFjZSkgdG8gcG9zaXRpb24gdGhlIFNwcml0ZSBhdC4KKiBAcGFyYW0ge3N0cmluZ3xQaGFzZXIuUmVuZGVyVGV4dHVyZXxQaGFzZXIuQml0bWFwRGF0YXxQSVhJLlRleHR1cmV9IGtleSAtIFRoaXMgaXMgdGhlIGltYWdlIG9yIHRleHR1cmUgdXNlZCBieSB0aGUgU3ByaXRlIGR1cmluZyByZW5kZXJpbmcuIEl0IGNhbiBiZSBhIHN0cmluZyB3aGljaCBpcyBhIHJlZmVyZW5jZSB0byB0aGUgQ2FjaGUgZW50cnksIG9yIGFuIGluc3RhbmNlIG9mIGEgUmVuZGVyVGV4dHVyZSBvciBQSVhJLlRleHR1cmUuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBmcmFtZSAtIElmIHRoaXMgU3ByaXRlIGlzIHVzaW5nIHBhcnQgb2YgYSBzcHJpdGUgc2hlZXQgb3IgdGV4dHVyZSBhdGxhcyB5b3UgY2FuIHNwZWNpZnkgdGhlIGV4YWN0IGZyYW1lIHRvIHVzZSBieSBnaXZpbmcgYSBzdHJpbmcgb3IgbnVtZXJpYyBpbmRleC4KKi8KUGhhc2VyLlNwcml0ZSA9IGZ1bmN0aW9uIChnYW1lLCB4LCB5LCBrZXksIGZyYW1lKSB7CgogICAgeCA9IHggfHwgMDsKICAgIHkgPSB5IHx8IDA7CiAgICBrZXkgPSBrZXkgfHwgbnVsbDsKICAgIGZyYW1lID0gZnJhbWUgfHwgbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwogCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBleGlzdHMgLSBJZiBleGlzdHMgPSBmYWxzZSB0aGVuIHRoZSBTcHJpdGUgaXNuJ3QgdXBkYXRlZCBieSB0aGUgY29yZSBnYW1lIGxvb3Agb3IgcGh5c2ljcyBzdWJzeXN0ZW0gYXQgYWxsLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZXhpc3RzID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhbGl2ZSAtIFRoaXMgaXMgYSBoYW5keSBsaXR0bGUgdmFyIHlvdXIgZ2FtZSBjYW4gdXNlIHRvIGRldGVybWluZSBpZiBhIHNwcml0ZSBpcyBhbGl2ZSBvciBub3QsIGl0IGRvZXNuJ3QgZWZmZWN0IHJlbmRlcmluZy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFsaXZlID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR3JvdXB9IGdyb3VwIC0gVGhlIHBhcmVudCBHcm91cCBvZiB0aGlzIFNwcml0ZS4gVGhpcyBpcyB1c3VhbGx5IHNldCBhZnRlciBTcHJpdGUgaW5zdGFudGlhdGlvbiBieSB0aGUgcGFyZW50LgogICAgKi8KICAgIHRoaXMuZ3JvdXAgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIFRoZSB1c2VyIGRlZmluZWQgbmFtZSBnaXZlbiB0byB0aGlzIFNwcml0ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm5hbWUgPSAnJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBUaGUgY29uc3QgdHlwZSBvZiB0aGlzIG9iamVjdC4KICAgICogQHJlYWRvbmx5CiAgICAqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLlNQUklURTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHJlbmRlck9yZGVySUQgLSBVc2VkIGJ5IHRoZSBSZW5kZXJlciBhbmQgSW5wdXQgTWFuYWdlciB0byBjb250cm9sIHBpY2tpbmcgb3JkZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5yZW5kZXJPcmRlcklEID0gLTE7CgogICAgLyoqCiAgICAqIElmIHlvdSB3b3VsZCBsaWtlIHRoZSBTcHJpdGUgdG8gaGF2ZSBhIGxpZmVzcGFuIG9uY2UgJ2Jvcm4nIHlvdSBjYW4gc2V0IHRoaXMgdG8gYSBwb3NpdGl2ZSB2YWx1ZS4gSGFuZHkgZm9yIHBhcnRpY2xlcywgYnVsbGV0cywgZXRjLgogICAgKiBUaGUgbGlmZXNwYW4gaXMgZGVjcmVtZW50ZWQgYnkgZ2FtZS50aW1lLmVsYXBzZWQgZWFjaCB1cGRhdGUsIG9uY2UgaXQgcmVhY2hlcyB6ZXJvIHRoZSBraWxsKCkgZnVuY3Rpb24gaXMgY2FsbGVkLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbGlmZXNwYW4gLSBUaGUgbGlmZXNwYW4gb2YgdGhlIFNwcml0ZSAoaW4gbXMpIGJlZm9yZSBpdCB3aWxsIGJlIGtpbGxlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmxpZmVzcGFuID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuRXZlbnRzfSBldmVudHMgLSBUaGUgRXZlbnRzIHlvdSBjYW4gc3Vic2NyaWJlIHRvIHRoYXQgYXJlIGRpc3BhdGNoZWQgd2hlbiBjZXJ0YWluIHRoaW5ncyBoYXBwZW4gb24gdGhpcyBTcHJpdGUgb3IgaXRzIGNvbXBvbmVudHMuCiAgICAqLwogICAgdGhpcy5ldmVudHMgPSBuZXcgUGhhc2VyLkV2ZW50cyh0aGlzKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuQW5pbWF0aW9uTWFuYWdlcn0gYW5pbWF0aW9ucyAtIFRoaXMgbWFuYWdlcyBhbmltYXRpb25zIG9mIHRoZSBzcHJpdGUuIFlvdSBjYW4gbW9kaWZ5IGFuaW1hdGlvbnMgdGhyb3VnaCBpdCAoc2VlIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyKQogICAgKi8KICAgIHRoaXMuYW5pbWF0aW9ucyA9IG5ldyBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlcih0aGlzKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuSW5wdXRIYW5kbGVyfSBpbnB1dCAtIFRoZSBJbnB1dCBIYW5kbGVyIENvbXBvbmVudC4KICAgICovCiAgICB0aGlzLmlucHV0ID0gbmV3IFBoYXNlci5JbnB1dEhhbmRsZXIodGhpcyk7CgogICAgLyoqCiAgICAqICBAcHJvcGVydHkge3N0cmluZ3xQaGFzZXIuUmVuZGVyVGV4dHVyZXxQaGFzZXIuQml0bWFwRGF0YXxQSVhJLlRleHR1cmV9IGtleSAtIFRoaXMgaXMgdGhlIGltYWdlIG9yIHRleHR1cmUgdXNlZCBieSB0aGUgU3ByaXRlIGR1cmluZyByZW5kZXJpbmcuIEl0IGNhbiBiZSBhIHN0cmluZyB3aGljaCBpcyBhIHJlZmVyZW5jZSB0byB0aGUgQ2FjaGUgZW50cnksIG9yIGFuIGluc3RhbmNlIG9mIGEgUmVuZGVyVGV4dHVyZSwgQml0bWFwRGF0YSBvciBQSVhJLlRleHR1cmUuCiAgICAqLwogICAgdGhpcy5rZXkgPSBrZXk7CgogICAgLyoqCiAgICAqICBAcHJvcGVydHkge1BoYXNlci5GcmFtZX0gY3VycmVudEZyYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBkaXNwbGF5ZWQgZnJhbWUuCiAgICAqLwogICAgdGhpcy5jdXJyZW50RnJhbWUgPSBudWxsOwoKICAgIGlmIChrZXkgaW5zdGFuY2VvZiBQaGFzZXIuUmVuZGVyVGV4dHVyZSkKICAgIHsKICAgICAgICBQSVhJLlNwcml0ZS5jYWxsKHRoaXMsIGtleSk7CgogICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5nYW1lLmNhY2hlLmdldFRleHR1cmVGcmFtZShrZXkubmFtZSk7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgaW5zdGFuY2VvZiBQaGFzZXIuQml0bWFwRGF0YSkKICAgIHsKICAgICAgICBQSVhJLlNwcml0ZS5jYWxsKHRoaXMsIGtleS50ZXh0dXJlLCBrZXkudGV4dHVyZUZyYW1lKTsKCiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSBrZXkudGV4dHVyZUZyYW1lOwogICAgfQogICAgZWxzZSBpZiAoa2V5IGluc3RhbmNlb2YgUElYSS5UZXh0dXJlKQogICAgewogICAgICAgIFBJWEkuU3ByaXRlLmNhbGwodGhpcywga2V5KTsKCiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSBmcmFtZTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBpZiAoa2V5ID09PSBudWxsIHx8IHR5cGVvZiBrZXkgPT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAga2V5ID0gJ19fZGVmYXVsdCc7CiAgICAgICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiB0aGlzLmdhbWUuY2FjaGUuY2hlY2tJbWFnZUtleShrZXkpID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIGtleSA9ICdfX21pc3NpbmcnOwogICAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICB9CgogICAgICAgIFBJWEkuU3ByaXRlLmNhbGwodGhpcywgUElYSS5UZXh0dXJlQ2FjaGVba2V5XSk7CgogICAgICAgIGlmICh0aGlzLmdhbWUuY2FjaGUuaXNTcHJpdGVTaGVldChrZXkpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRpb25zLmxvYWRGcmFtZURhdGEodGhpcy5nYW1lLmNhY2hlLmdldEZyYW1lRGF0YShrZXkpKTsKCiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmcmFtZSA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSBmcmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZyYW1lID0gZnJhbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0RnJhbWUoa2V5KTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAqIFRoZSByZWN0YW5ndWxhciBhcmVhIGZyb20gdGhlIHRleHR1cmUgdGhhdCB3aWxsIGJlIHJlbmRlcmVkLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IHRleHR1cmVSZWdpb24KICAgICovCiAgICB0aGlzLnRleHR1cmVSZWdpb24gPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSh0aGlzLnRleHR1cmUuZnJhbWUueCwgdGhpcy50ZXh0dXJlLmZyYW1lLnksIHRoaXMudGV4dHVyZS5mcmFtZS53aWR0aCwgdGhpcy50ZXh0dXJlLmZyYW1lLmhlaWdodCk7CgogICAgLyoqCiAgICAqIFRoZSBhbmNob3Igc2V0cyB0aGUgb3JpZ2luIHBvaW50IG9mIHRoZSB0ZXh0dXJlLgogICAgKiBUaGUgZGVmYXVsdCBpcyAwLDAgdGhpcyBtZWFucyB0aGUgdGV4dHVyZXMgb3JpZ2luIGlzIHRoZSB0b3AgbGVmdCAKICAgICogU2V0dGluZyB0aGFuIGFuY2hvciB0byAwLjUsMC41IG1lYW5zIHRoZSB0ZXh0dXJlcyBvcmlnaW4gaXMgY2VudGVyZWQKICAgICogU2V0dGluZyB0aGUgYW5jaG9yIHRvIDEsMSB3b3VsZCBtZWFuIHRoZSB0ZXh0dXJlcyBvcmlnaW4gcG9pbnRzIHdpbGwgYmUgdGhlIGJvdHRvbSByaWdodAogICAgKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYW5jaG9yIC0gVGhlIGFuY2hvciBhcm91bmQgd2hpY2ggcm90YXRpb24gYW5kIHNjYWxpbmcgdGFrZXMgcGxhY2UuCiAgICAqLwogICAgdGhpcy5hbmNob3IgPSBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBpbiB3b3JsZCBzcGFjZSBvZiB0aGlzIFNwcml0ZS4KICAgICovCiAgICB0aGlzLnggPSB4OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIGluIHdvcmxkIHNwYWNlIG9mIHRoaXMgU3ByaXRlLgogICAgKi8KICAgIHRoaXMueSA9IHk7CgogICAgdGhpcy5wb3NpdGlvbi54ID0geDsKICAgIHRoaXMucG9zaXRpb24ueSA9IHk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSB3b3JsZCAtIFRoZSB3b3JsZCBjb29yZGluYXRlcyBvZiB0aGlzIFNwcml0ZS4gVGhpcyBkaWZmZXJzIGZyb20gdGhlIHgveSBjb29yZGluYXRlcyB3aGljaCBhcmUgcmVsYXRpdmUgdG8gdGhlIFNwcml0ZXMgY29udGFpbmVyLgogICAgKi8KICAgIHRoaXMud29ybGQgPSBuZXcgUGhhc2VyLlBvaW50KHgsIHkpOwoKICAgIC8qKgogICAgKiBTaG91bGQgdGhpcyBTcHJpdGUgYmUgYXV0b21hdGljYWxseSBjdWxsZWQgaWYgb3V0IG9mIHJhbmdlIG9mIHRoZSBjYW1lcmE/CiAgICAqIEEgY3VsbGVkIHNwcml0ZSBoYXMgaXRzIHJlbmRlcmFibGUgcHJvcGVydHkgc2V0IHRvICdmYWxzZScuCiAgICAqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYXV0b0N1bGwgLSBBIGZsYWcgaW5kaWNhdGluZyBpZiB0aGUgU3ByaXRlIHNob3VsZCBiZSBhdXRvbWF0aWNhbGx5IGNhbWVyYSBjdWxsZWQgb3Igbm90LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYXV0b0N1bGwgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHNjYWxlIC0gVGhlIHNjYWxlIG9mIHRoZSBTcHJpdGUgd2hlbiByZW5kZXJlZC4gQnkgZGVmYXVsdCBpdCdzIHNldCB0byAxIChubyBzY2FsZSkuIFlvdSBjYW4gbW9kaWZ5IGl0IHZpYSBzY2FsZS54IG9yIHNjYWxlLnkgb3Igc2NhbGUuc2V0VG8oeCwgeSkuIEEgdmFsdWUgb2YgMSBtZWFucyBubyBjaGFuZ2UgdG8gdGhlIHNjYWxlLCAwLjUgbWVhbnMgImhhbGYgdGhlIHNpemUiLCAyIG1lYW5zICJ0d2ljZSB0aGUgc2l6ZSIsIGV0Yy4KICAgICovCiAgICB0aGlzLnNjYWxlID0gbmV3IFBoYXNlci5Qb2ludCgxLCAxKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF9jYWNoZSAtIEEgbWluaSBjYWNoZSBmb3Igc3RvcmluZyBhbGwgb2YgdGhlIGNhbGN1bGF0ZWQgdmFsdWVzLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2NhY2hlID0gewoKICAgICAgICBmcmVzaDogdHJ1ZSwKICAgICAgICBkaXJ0eTogZmFsc2UsCgogICAgICAgIC8vICBUcmFuc2Zvcm0gY2FjaGUKICAgICAgICBhMDA6IC0xLAogICAgICAgIGEwMTogLTEsCiAgICAgICAgYTAyOiAtMSwKICAgICAgICBhMTA6IC0xLAogICAgICAgIGExMTogLTEsCiAgICAgICAgYTEyOiAtMSwKICAgICAgICBpZDogLTEsCgogICAgICAgIC8vICBJbnB1dCBzcGVjaWZpYyB0cmFuc2Zvcm0gY2FjaGUKICAgICAgICBpMDE6IC0xLAogICAgICAgIGkxMDogLTEsCiAgICAgICAgaWRpOiAtMSwKCiAgICAgICAgLy8gIEJvdW5kcyBjaGVjawogICAgICAgIGxlZnQ6IG51bGwsCiAgICAgICAgcmlnaHQ6IG51bGwsCiAgICAgICAgdG9wOiBudWxsLAogICAgICAgIGJvdHRvbTogbnVsbCwKCiAgICAgICAgLy8gIGRlbHRhIGNhY2hlCiAgICAgICAgcHJldlg6IHgsCiAgICAgICAgcHJldlk6IHksCgogICAgICAgIC8vICBUaGUgcHJldmlvdXMgY2FsY3VsYXRlZCBwb3NpdGlvbgogICAgICAgIHg6IC0xLAogICAgICAgIHk6IC0xLAoKICAgICAgICAvLyAgVGhlIGFjdHVhbCBzY2FsZSB2YWx1ZXMgYmFzZWQgb24gdGhlIHdvcmxkVHJhbnNmb3JtCiAgICAgICAgc2NhbGVYOiAxLAogICAgICAgIHNjYWxlWTogMSwKCiAgICAgICAgLy8gIFRoZSB3aWR0aC9oZWlnaHQgb2YgdGhlIGltYWdlLCBiYXNlZCBvbiB0aGUgdW4tbW9kaWZpZWQgZnJhbWUgc2l6ZSBtdWx0aXBsaWVkIGJ5IHRoZSBmaW5hbCBjYWxjdWxhdGVkIHNjYWxlIHNpemUKICAgICAgICB3aWR0aDogdGhpcy5jdXJyZW50RnJhbWUuc291cmNlU2l6ZVcsCiAgICAgICAgaGVpZ2h0OiB0aGlzLmN1cnJlbnRGcmFtZS5zb3VyY2VTaXplSCwKCiAgICAgICAgLy8gIFRoZSBhY3R1YWwgd2lkdGgvaGVpZ2h0IG9mIHRoZSBpbWFnZSBpZiBmcm9tIGEgdHJpbW1lZCBhdGxhcywgbXVsdGlwbGllZCBieSB0aGUgZmluYWwgY2FsY3VsYXRlZCBzY2FsZSBzaXplCiAgICAgICAgaGFsZldpZHRoOiBNYXRoLmZsb29yKHRoaXMuY3VycmVudEZyYW1lLnNvdXJjZVNpemVXIC8gMiksCiAgICAgICAgaGFsZkhlaWdodDogTWF0aC5mbG9vcih0aGlzLmN1cnJlbnRGcmFtZS5zb3VyY2VTaXplSCAvIDIpLAoKICAgICAgICAvLyAgVGhlIHdpZHRoL2hlaWdodCBvZiB0aGUgaW1hZ2UsIGJhc2VkIG9uIHRoZSB1bi1tb2RpZmllZCBmcmFtZSBzaXplIG11bHRpcGxpZWQgYnkgdGhlIGZpbmFsIGNhbGN1bGF0ZWQgc2NhbGUgc2l6ZQogICAgICAgIGNhbGNXaWR0aDogLTEsCiAgICAgICAgY2FsY0hlaWdodDogLTEsCgogICAgICAgIC8vICBUaGUgY3VycmVudCBmcmFtZSBkZXRhaWxzCiAgICAgICAgLy8gZnJhbWVJRDogdGhpcy5jdXJyZW50RnJhbWUudXVpZCwgZnJhbWVXaWR0aDogdGhpcy5jdXJyZW50RnJhbWUud2lkdGgsIGZyYW1lSGVpZ2h0OiB0aGlzLmN1cnJlbnRGcmFtZS5oZWlnaHQsCiAgICAgICAgZnJhbWVJRDogLTEsCiAgICAgICAgZnJhbWVXaWR0aDogdGhpcy5jdXJyZW50RnJhbWUud2lkdGgsCiAgICAgICAgZnJhbWVIZWlnaHQ6IHRoaXMuY3VycmVudEZyYW1lLmhlaWdodCwKCiAgICAgICAgLy8gIElmIHRoaXMgc3ByaXRlIHZpc2libGUgdG8gdGhlIGNhbWVyYSAocmVnYXJkbGVzcyBvZiBiZWluZyBzZXQgdG8gdmlzaWJsZSBvciBub3QpCiAgICAgICAgY2FtZXJhVmlzaWJsZTogdHJ1ZSwKCiAgICAgICAgLy8gIENyb3AgY2FjaGUKICAgICAgICBjcm9wWDogMCwKICAgICAgICBjcm9wWTogMCwKICAgICAgICBjcm9wV2lkdGg6IHRoaXMuY3VycmVudEZyYW1lLnNvdXJjZVNpemVXLAogICAgICAgIGNyb3BIZWlnaHQ6IHRoaXMuY3VycmVudEZyYW1lLnNvdXJjZVNpemVICgogICAgfTsKICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gb2Zmc2V0IC0gQ29ybmVyIHBvaW50IGRlZmF1bHRzLiBTaG91bGQgbm90IHR5cGljYWxseSBiZSBtb2RpZmllZC4KICAgICovCiAgICB0aGlzLm9mZnNldCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBjZW50ZXIgLSBBIFBvaW50IGNvbnRhaW5pbmcgdGhlIGNlbnRlciBjb29yZGluYXRlIG9mIHRoZSBTcHJpdGUuIFRha2VzIHJvdGF0aW9uIGFuZCBzY2FsZSBpbnRvIGFjY291bnQuCiAgICAqLwogICAgdGhpcy5jZW50ZXIgPSBuZXcgUGhhc2VyLlBvaW50KHggKyBNYXRoLmZsb29yKHRoaXMuX2NhY2hlLndpZHRoIC8gMiksIHkgKyBNYXRoLmZsb29yKHRoaXMuX2NhY2hlLmhlaWdodCAvIDIpKTsKICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHRvcExlZnQgLSBBIFBvaW50IGNvbnRhaW5pbmcgdGhlIHRvcCBsZWZ0IGNvb3JkaW5hdGUgb2YgdGhlIFNwcml0ZS4gVGFrZXMgcm90YXRpb24gYW5kIHNjYWxlIGludG8gYWNjb3VudC4KICAgICovCiAgICB0aGlzLnRvcExlZnQgPSBuZXcgUGhhc2VyLlBvaW50KHgsIHkpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHRvcFJpZ2h0IC0gQSBQb2ludCBjb250YWluaW5nIHRoZSB0b3AgcmlnaHQgY29vcmRpbmF0ZSBvZiB0aGUgU3ByaXRlLiBUYWtlcyByb3RhdGlvbiBhbmQgc2NhbGUgaW50byBhY2NvdW50LgogICAgKi8KICAgIHRoaXMudG9wUmlnaHQgPSBuZXcgUGhhc2VyLlBvaW50KHggKyB0aGlzLl9jYWNoZS53aWR0aCwgeSk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYm90dG9tUmlnaHQgLSBBIFBvaW50IGNvbnRhaW5pbmcgdGhlIGJvdHRvbSByaWdodCBjb29yZGluYXRlIG9mIHRoZSBTcHJpdGUuIFRha2VzIHJvdGF0aW9uIGFuZCBzY2FsZSBpbnRvIGFjY291bnQuCiAgICAqLwogICAgdGhpcy5ib3R0b21SaWdodCA9IG5ldyBQaGFzZXIuUG9pbnQoeCArIHRoaXMuX2NhY2hlLndpZHRoLCB5ICsgdGhpcy5fY2FjaGUuaGVpZ2h0KTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBib3R0b21MZWZ0IC0gQSBQb2ludCBjb250YWluaW5nIHRoZSBib3R0b20gbGVmdCBjb29yZGluYXRlIG9mIHRoZSBTcHJpdGUuIFRha2VzIHJvdGF0aW9uIGFuZCBzY2FsZSBpbnRvIGFjY291bnQuCiAgICAqLwogICAgdGhpcy5ib3R0b21MZWZ0ID0gbmV3IFBoYXNlci5Qb2ludCh4LCB5ICsgdGhpcy5fY2FjaGUuaGVpZ2h0KTsKICAgIAogICAgLyoqCiAgICAqIFRoaXMgUmVjdGFuZ2xlIG9iamVjdCBmdWxseSBlbmNvbXBhc3NlcyB0aGUgU3ByaXRlIGFuZCBpcyB1cGRhdGVkIGluIHJlYWwtdGltZS4KICAgICogVGhlIGJvdW5kcyBpcyB0aGUgZnVsbCBib3VuZGluZyBhcmVhIGFmdGVyIHJvdGF0aW9uIGFuZCBzY2FsZSBoYXZlIGJlZW4gdGFrZW4gaW50byBhY2NvdW50LiBJdCBzaG91bGQgbm90IGJlIG1vZGlmaWVkIGRpcmVjdGx5LgogICAgKiBJdCdzIHVzZWQgZm9yIENhbWVyYSBjdWxsaW5nIGFuZCBwaHlzaWNzIGJvZHkgYWxpZ25tZW50LgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IGJvdW5kcwogICAgKi8KICAgIHRoaXMuYm91bmRzID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoeCwgeSwgdGhpcy5fY2FjaGUud2lkdGgsIHRoaXMuX2NhY2hlLmhlaWdodCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gQnkgZGVmYXVsdCBTcHJpdGVzIGhhdmUgYSBQaGFzZXIuUGh5c2ljcyBCb2R5IGF0dGFjaGVkIHRvIHRoZW0uIFlvdSBjYW4gb3BlcmF0ZSBwaHlzaWNzIGFjdGlvbnMgdmlhIHRoaXMgcHJvcGVydHksIG9yIG51bGwgaXQgdG8gc2tpcCBhbGwgcGh5c2ljcyB1cGRhdGVzLgogICAgKi8KICAgIHRoaXMuYm9keSA9IG5ldyBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSh0aGlzKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlYWx0aCAtIEhlYWx0aCB2YWx1ZS4gVXNlZCBpbiBjb21iaW5hdGlvbiB3aXRoIGRhbWFnZSgpIHRvIGFsbG93IGZvciBxdWljayBraWxsaW5nIG9mIFNwcml0ZXMuCiAgICAqLwogICAgdGhpcy5oZWFsdGggPSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGluV29ybGQgLSBUaGlzIHZhbHVlIGlzIHNldCB0byB0cnVlIGlmIHRoZSBTcHJpdGUgaXMgcG9zaXRpb25lZCB3aXRoaW4gdGhlIFdvcmxkLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgdGhpcy5pbldvcmxkID0gUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzKHRoaXMuYm91bmRzLCB0aGlzLmdhbWUud29ybGQuYm91bmRzKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpbldvcmxkVGhyZXNob2xkIC0gQSB0aHJlc2hvbGQgdmFsdWUgYXBwbGllZCB0byB0aGUgaW5Xb3JsZCBjaGVjay4gSWYgeW91IGRvbid0IHdhbnQgYSBTcHJpdGUgdG8gYmUgY29uc2lkZXJlZCAib3V0IG9mIHRoZSB3b3JsZCIgdW50aWwgYXQgbGVhc3QgMTAwcHggYXdheSBmb3IgZXhhbXBsZSB0aGVuIHNldCBpdCB0byAxMDAuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pbldvcmxkVGhyZXNob2xkID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBvdXRPZkJvdW5kc0tpbGwgLSBJZiB0cnVlIHRoZSBTcHJpdGUgaXMga2lsbGVkIGFzIHNvb24gYXMgU3ByaXRlLmluV29ybGQgaXMgZmFsc2UuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vdXRPZkJvdW5kc0tpbGwgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX291dE9mQm91bmRzRmlyZWQgLSBJbnRlcm5hbCBmbGFnLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX291dE9mQm91bmRzRmlyZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQSBTcHJpdGUgdGhhdCBpcyBmaXhlZCB0byB0aGUgY2FtZXJhIGlnbm9yZXMgdGhlIHBvc2l0aW9uIG9mIGFueSBhbmNlc3RvcnMgaW4gdGhlIGRpc3BsYXkgbGlzdCBhbmQgdXNlcyBpdHMgeC95IGNvb3JkaW5hdGVzIGFzIG9mZnNldHMgZnJvbSB0aGUgdG9wIGxlZnQgb2YgdGhlIGNhbWVyYS4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBmaXhlZFRvQ2FtZXJhIC0gRml4ZXMgdGhpcyBTcHJpdGUgdG8gdGhlIENhbWVyYS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZpeGVkVG9DYW1lcmEgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGNhbWVyYU9mZnNldCAtIElmIHRoaXMgU3ByaXRlIGlzIGZpeGVkIHRvIHRoZSBjYW1lcmEgdGhlbiB1c2UgdGhpcyBQb2ludCB0byBzcGVjaWZ5IGhvdyBmYXIgYXdheSBmcm9tIHRoZSBDYW1lcmEgeC95IGl0J3MgcmVuZGVyZWQuCiAgICAqLwogICAgdGhpcy5jYW1lcmFPZmZzZXQgPSBuZXcgUGhhc2VyLlBvaW50KHgsIHkpOwoKICAgIC8qKgogICAgKiBZb3UgY2FuIGNyb3AgdGhlIFNwcml0ZXMgdGV4dHVyZSBieSBtb2RpZnlpbmcgdGhlIGNyb3AgcHJvcGVydGllcy4gRm9yIGV4YW1wbGUgY3JvcC53aWR0aCA9IDUwIHdvdWxkIHNldCB0aGUgU3ByaXRlIHRvIG9ubHkgcmVuZGVyIDUwcHggd2lkZS4KICAgICogVGhlIGNyb3AgaXMgb25seSBhcHBsaWVkIGlmIHlvdSBoYXZlIHNldCBTcHJpdGUuY3JvcEVuYWJsZWQgdG8gdHJ1ZS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSBjcm9wIC0gVGhlIGNyb3AgUmVjdGFuZ2xlIGFwcGxpZWQgdG8gdGhlIFNwcml0ZSB0ZXh0dXJlIGJlZm9yZSByZW5kZXJpbmcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jcm9wID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoMCwgMCwgdGhpcy5fY2FjaGUud2lkdGgsIHRoaXMuX2NhY2hlLmhlaWdodCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY3JvcEVuYWJsZWQgLSBJZiB0cnVlIHRoZSBTcHJpdGUuY3JvcCBwcm9wZXJ0eSBpcyB1c2VkIHRvIGNyb3AgdGhlIHRleHR1cmUgYmVmb3JlIHJlbmRlci4gU2V0IHRvIGZhbHNlIHRvIGRpc2FibGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jcm9wRW5hYmxlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRlYnVnIC0gSGFuZHkgZmxhZyB0byB1c2Ugd2l0aCBHYW1lLmVuYWJsZVN0ZXAKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmRlYnVnID0gZmFsc2U7CgogICAgdGhpcy51cGRhdGVDYWNoZSgpOwogICAgdGhpcy51cGRhdGVCb3VuZHMoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQSVhJLlBvaW50fSBwaXZvdCAtIFRoZSBwaXZvdCBwb2ludCBvZiB0aGUgZGlzcGxheU9iamVjdCB0aGF0IGl0IHJvdGF0ZXMgYXJvdW5kLgogICAgKi8KCn07CgovLyAgTmVlZGVkIHRvIGtlZXAgdGhlIFBJWEkuU3ByaXRlIGNvbnN0cnVjdG9yIGluIHRoZSBwcm90b3R5cGUgY2hhaW4gKGFzIHRoZSBjb3JlIHBpeGkgcmVuZGVyZXIgdXNlcyBhbiBpbnN0YW5jZW9mIGNoZWNrIHNhZGx5KQpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5TcHJpdGUucHJvdG90eXBlKTsKUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuU3ByaXRlOwoKLyoqCiogQXV0b21hdGljYWxseSBjYWxsZWQgYnkgV29ybGQucHJlVXBkYXRlLiBIYW5kbGVzIGNhY2hlIHVwZGF0ZXMsIGxpZmVzcGFuIGNoZWNrcywgYW5pbWF0aW9uIHVwZGF0ZXMgYW5kIHBoeXNpY3MgdXBkYXRlcy4KKgoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNwcmVVcGRhdGUKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5wcmVVcGRhdGUgPSBmdW5jdGlvbigpIHsKCiAgICBpZiAodGhpcy5fY2FjaGUuZnJlc2gpCiAgICB7CiAgICAgICAgdGhpcy53b3JsZC5zZXRUbyh0aGlzLnBhcmVudC5wb3NpdGlvbi54ICsgdGhpcy54LCB0aGlzLnBhcmVudC5wb3NpdGlvbi55ICsgdGhpcy55KTsKICAgICAgICB0aGlzLndvcmxkVHJhbnNmb3JtWzJdID0gdGhpcy53b3JsZC54OwogICAgICAgIHRoaXMud29ybGRUcmFuc2Zvcm1bNV0gPSB0aGlzLndvcmxkLnk7CiAgICAgICAgdGhpcy5fY2FjaGUuZnJlc2ggPSBmYWxzZTsKCiAgICAgICAgaWYgKHRoaXMuYm9keSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYm9keS54ID0gKHRoaXMud29ybGQueCAtICh0aGlzLmFuY2hvci54ICogdGhpcy53aWR0aCkpICsgdGhpcy5ib2R5Lm9mZnNldC54OwogICAgICAgICAgICB0aGlzLmJvZHkueSA9ICh0aGlzLndvcmxkLnkgLSAodGhpcy5hbmNob3IueSAqIHRoaXMuaGVpZ2h0KSkgKyB0aGlzLmJvZHkub2Zmc2V0Lnk7CiAgICAgICAgICAgIHRoaXMuYm9keS5wcmVYID0gdGhpcy5ib2R5Lng7CiAgICAgICAgICAgIHRoaXMuYm9keS5wcmVZID0gdGhpcy5ib2R5Lnk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKCF0aGlzLmV4aXN0cyB8fCAodGhpcy5ncm91cCAmJiAhdGhpcy5ncm91cC5leGlzdHMpKQogICAgewogICAgICAgIHRoaXMucmVuZGVyT3JkZXJJRCA9IC0xOwogICAgICAgIAogICAgICAgIC8vIFNraXAgY2hpbGRyZW4gaWYgbm90IGV4aXN0cwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBpZiAodGhpcy5saWZlc3BhbiA+IDApCiAgICB7CiAgICAgICAgdGhpcy5saWZlc3BhbiAtPSB0aGlzLmdhbWUudGltZS5lbGFwc2VkOwoKICAgICAgICBpZiAodGhpcy5saWZlc3BhbiA8PSAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5raWxsKCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgdGhpcy5fY2FjaGUuZGlydHkgPSBmYWxzZTsKCiAgICBpZiAodGhpcy52aXNpYmxlKQogICAgewogICAgICAgIHRoaXMucmVuZGVyT3JkZXJJRCA9IHRoaXMuZ2FtZS53b3JsZC5jdXJyZW50UmVuZGVyT3JkZXJJRCsrOwogICAgfQoKICAgIHRoaXMudXBkYXRlQ2FjaGUoKTsKCiAgICB0aGlzLnVwZGF0ZUFuaW1hdGlvbigpOwoKICAgIHRoaXMudXBkYXRlQ3JvcCgpOwoKICAgIC8vICBSZS1ydW4gdGhlIGNhbWVyYSB2aXNpYmlsaXR5IGNoZWNrCiAgICBpZiAodGhpcy5fY2FjaGUuZGlydHkgfHwgdGhpcy53b3JsZC54ICE9PSB0aGlzLl9jYWNoZS5wcmV2WCB8fCB0aGlzLndvcmxkLnkgIT09IHRoaXMuX2NhY2hlLnByZXZZKQogICAgewogICAgICAgIHRoaXMudXBkYXRlQm91bmRzKCk7CiAgICB9CgogICAgaWYgKHRoaXMuYm9keSkKICAgIHsKICAgICAgICB0aGlzLmJvZHkucHJlVXBkYXRlKCk7CiAgICB9CgogICAgcmV0dXJuIHRydWU7Cgp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gY2FsbGVkIGJ5IHByZVVwZGF0ZS4KKgoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSN1cGRhdGVDYWNoZQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLnVwZGF0ZUNhY2hlID0gZnVuY3Rpb24oKSB7CgogICAgdGhpcy5fY2FjaGUucHJldlggPSB0aGlzLndvcmxkLng7CiAgICB0aGlzLl9jYWNoZS5wcmV2WSA9IHRoaXMud29ybGQueTsKCiAgICBpZiAodGhpcy5maXhlZFRvQ2FtZXJhKQogICAgewogICAgICAgIHRoaXMueCA9IHRoaXMuZ2FtZS5jYW1lcmEudmlldy54ICsgdGhpcy5jYW1lcmFPZmZzZXQueDsKICAgICAgICB0aGlzLnkgPSB0aGlzLmdhbWUuY2FtZXJhLnZpZXcueSArIHRoaXMuY2FtZXJhT2Zmc2V0Lnk7CiAgICB9CgogICAgdGhpcy53b3JsZC5zZXRUbyh0aGlzLmdhbWUuY2FtZXJhLnggKyB0aGlzLndvcmxkVHJhbnNmb3JtWzJdLCB0aGlzLmdhbWUuY2FtZXJhLnkgKyB0aGlzLndvcmxkVHJhbnNmb3JtWzVdKTsKCiAgICBpZiAodGhpcy53b3JsZFRyYW5zZm9ybVsxXSAhPSB0aGlzLl9jYWNoZS5pMDEgfHwgdGhpcy53b3JsZFRyYW5zZm9ybVszXSAhPSB0aGlzLl9jYWNoZS5pMTAgfHwgdGhpcy53b3JsZFRyYW5zZm9ybVswXSAhPSB0aGlzLl9jYWNoZS5hMDAgfHwgdGhpcy53b3JsZFRyYW5zZm9ybVs0MV0gIT0gdGhpcy5fY2FjaGUuYTExKQogICAgewogICAgICAgIHRoaXMuX2NhY2hlLmEwMCA9IHRoaXMud29ybGRUcmFuc2Zvcm1bMF07ICAvLyAgc2NhbGVYICAgICAgICAgYSAgICAgfGEgYyB0eHwKICAgICAgICB0aGlzLl9jYWNoZS5hMDEgPSB0aGlzLndvcmxkVHJhbnNmb3JtWzFdOyAgLy8gIHNrZXdZICAgICAgICAgIGMgICAgIHxiIGQgdHl8CiAgICAgICAgdGhpcy5fY2FjaGUuYTEwID0gdGhpcy53b3JsZFRyYW5zZm9ybVszXTsgIC8vICBza2V3WCAgICAgICAgICBiICAgICB8MCAwICAxfAogICAgICAgIHRoaXMuX2NhY2hlLmExMSA9IHRoaXMud29ybGRUcmFuc2Zvcm1bNF07ICAvLyAgc2NhbGVZICAgICAgICAgZAoKICAgICAgICB0aGlzLl9jYWNoZS5pMDEgPSB0aGlzLndvcmxkVHJhbnNmb3JtWzFdOyAgLy8gIHNrZXdZICAgICAgICAgIGMgKHJlbWFpbnMgbm9uLW1vZGlmaWVkIGZvciBpbnB1dCBjaGVja3MpCiAgICAgICAgdGhpcy5fY2FjaGUuaTEwID0gdGhpcy53b3JsZFRyYW5zZm9ybVszXTsgIC8vICBza2V3WCAgICAgICAgICBiIChyZW1haW5zIG5vbi1tb2RpZmllZCBmb3IgaW5wdXQgY2hlY2tzKQoKICAgICAgICB0aGlzLl9jYWNoZS5zY2FsZVggPSBNYXRoLnNxcnQoKHRoaXMuX2NhY2hlLmEwMCAqIHRoaXMuX2NhY2hlLmEwMCkgKyAodGhpcy5fY2FjaGUuYTAxICogdGhpcy5fY2FjaGUuYTAxKSk7IC8vIHJvdW5kIHRoaXMgb2ZmIGEgYml0PwogICAgICAgIHRoaXMuX2NhY2hlLnNjYWxlWSA9IE1hdGguc3FydCgodGhpcy5fY2FjaGUuYTEwICogdGhpcy5fY2FjaGUuYTEwKSArICh0aGlzLl9jYWNoZS5hMTEgKiB0aGlzLl9jYWNoZS5hMTEpKTsgLy8gcm91bmQgdGhpcyBvZmYgYSBiaXQ/CgogICAgICAgIHRoaXMuX2NhY2hlLmEwMSAqPSAtMTsKICAgICAgICB0aGlzLl9jYWNoZS5hMTAgKj0gLTE7CgogICAgICAgIHRoaXMuX2NhY2hlLmlkID0gMSAvICh0aGlzLl9jYWNoZS5hMDAgKiB0aGlzLl9jYWNoZS5hMTEgKyB0aGlzLl9jYWNoZS5hMDEgKiAtdGhpcy5fY2FjaGUuYTEwKTsKICAgICAgICB0aGlzLl9jYWNoZS5pZGkgPSAxIC8gKHRoaXMuX2NhY2hlLmEwMCAqIHRoaXMuX2NhY2hlLmExMSArIHRoaXMuX2NhY2hlLmkwMSAqIC10aGlzLl9jYWNoZS5pMTApOwoKICAgICAgICB0aGlzLl9jYWNoZS5kaXJ0eSA9IHRydWU7CiAgICB9CgogICAgdGhpcy5fY2FjaGUuYTAyID0gdGhpcy53b3JsZFRyYW5zZm9ybVsyXTsgIC8vICB0cmFuc2xhdGVYICAgICB0eAogICAgdGhpcy5fY2FjaGUuYTEyID0gdGhpcy53b3JsZFRyYW5zZm9ybVs1XTsgIC8vICB0cmFuc2xhdGVZICAgICB0eQoKfTsKCi8qKgoqIEludGVybmFsIGZ1bmN0aW9uIGNhbGxlZCBieSBwcmVVcGRhdGUuCioKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjdXBkYXRlQW5pbWF0aW9uCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUudXBkYXRlQW5pbWF0aW9uID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKHRoaXMuYW5pbWF0aW9ucy51cGRhdGUoKSB8fCAodGhpcy5jdXJyZW50RnJhbWUgJiYgdGhpcy5jdXJyZW50RnJhbWUudXVpZCAhPSB0aGlzLl9jYWNoZS5mcmFtZUlEKSkKICAgIHsKICAgICAgICB0aGlzLl9jYWNoZS5mcmFtZUlEID0gdGhpcy5jdXJyZW50RnJhbWUudXVpZDsKCiAgICAgICAgdGhpcy5fY2FjaGUuZnJhbWVXaWR0aCA9IHRoaXMudGV4dHVyZS5mcmFtZS53aWR0aDsKICAgICAgICB0aGlzLl9jYWNoZS5mcmFtZUhlaWdodCA9IHRoaXMudGV4dHVyZS5mcmFtZS5oZWlnaHQ7CgogICAgICAgIHRoaXMuX2NhY2hlLndpZHRoID0gdGhpcy5jdXJyZW50RnJhbWUud2lkdGg7CiAgICAgICAgdGhpcy5fY2FjaGUuaGVpZ2h0ID0gdGhpcy5jdXJyZW50RnJhbWUuaGVpZ2h0OwoKICAgICAgICB0aGlzLl9jYWNoZS5oYWxmV2lkdGggPSBNYXRoLmZsb29yKHRoaXMuX2NhY2hlLndpZHRoIC8gMik7CiAgICAgICAgdGhpcy5fY2FjaGUuaGFsZkhlaWdodCA9IE1hdGguZmxvb3IodGhpcy5fY2FjaGUuaGVpZ2h0IC8gMik7CgogICAgICAgIHRoaXMuX2NhY2hlLmRpcnR5ID0gdHJ1ZTsKICAgIH0KCn07CgovKioKKiBJbnRlcm5hbCBmdW5jdGlvbiBjYWxsZWQgYnkgcHJlVXBkYXRlLgoqCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3VwZGF0ZUNyb3AKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS51cGRhdGVDcm9wID0gZnVuY3Rpb24oKSB7CgogICAgLy8gIFRoaXMgb25seSBydW5zIGlmIGNyb3AgaXMgZW5hYmxlZAogICAgaWYgKHRoaXMuY3JvcEVuYWJsZWQgJiYgKHRoaXMuY3JvcC53aWR0aCAhPSB0aGlzLl9jYWNoZS5jcm9wV2lkdGggfHwgdGhpcy5jcm9wLmhlaWdodCAhPSB0aGlzLl9jYWNoZS5jcm9wSGVpZ2h0IHx8IHRoaXMuY3JvcC54ICE9IHRoaXMuX2NhY2hlLmNyb3BYIHx8IHRoaXMuY3JvcC55ICE9IHRoaXMuX2NhY2hlLmNyb3BZKSkKICAgIHsKICAgICAgICB0aGlzLmNyb3AuZmxvb3JBbGwoKTsKCiAgICAgICAgdGhpcy5fY2FjaGUuY3JvcFggPSB0aGlzLmNyb3AueDsKICAgICAgICB0aGlzLl9jYWNoZS5jcm9wWSA9IHRoaXMuY3JvcC55OwogICAgICAgIHRoaXMuX2NhY2hlLmNyb3BXaWR0aCA9IHRoaXMuY3JvcC53aWR0aDsKICAgICAgICB0aGlzLl9jYWNoZS5jcm9wSGVpZ2h0ID0gdGhpcy5jcm9wLmhlaWdodDsKCiAgICAgICAgdGhpcy50ZXh0dXJlLmZyYW1lID0gdGhpcy5jcm9wOwogICAgICAgIHRoaXMudGV4dHVyZS53aWR0aCA9IHRoaXMuY3JvcC53aWR0aDsKICAgICAgICB0aGlzLnRleHR1cmUuaGVpZ2h0ID0gdGhpcy5jcm9wLmhlaWdodDsKCiAgICAgICAgdGhpcy50ZXh0dXJlLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKCiAgICAgICAgUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcy5wdXNoKHRoaXMudGV4dHVyZSk7CiAgICB9Cgp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gY2FsbGVkIGJ5IHByZVVwZGF0ZS4KKgoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSN1cGRhdGVCb3VuZHMKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS51cGRhdGVCb3VuZHMgPSBmdW5jdGlvbigpIHsKCiAgICB0aGlzLm9mZnNldC5zZXRUbyh0aGlzLl9jYWNoZS5hMDIgLSAodGhpcy5hbmNob3IueCAqIHRoaXMud2lkdGgpLCB0aGlzLl9jYWNoZS5hMTIgLSAodGhpcy5hbmNob3IueSAqIHRoaXMuaGVpZ2h0KSk7CgogICAgdGhpcy5nZXRMb2NhbFBvc2l0aW9uKHRoaXMuY2VudGVyLCB0aGlzLm9mZnNldC54ICsgKHRoaXMud2lkdGggLyAyKSwgdGhpcy5vZmZzZXQueSArICh0aGlzLmhlaWdodCAvIDIpKTsKICAgIHRoaXMuZ2V0TG9jYWxQb3NpdGlvbih0aGlzLnRvcExlZnQsIHRoaXMub2Zmc2V0LngsIHRoaXMub2Zmc2V0LnkpOwogICAgdGhpcy5nZXRMb2NhbFBvc2l0aW9uKHRoaXMudG9wUmlnaHQsIHRoaXMub2Zmc2V0LnggKyB0aGlzLndpZHRoLCB0aGlzLm9mZnNldC55KTsKICAgIHRoaXMuZ2V0TG9jYWxQb3NpdGlvbih0aGlzLmJvdHRvbUxlZnQsIHRoaXMub2Zmc2V0LngsIHRoaXMub2Zmc2V0LnkgKyB0aGlzLmhlaWdodCk7CiAgICB0aGlzLmdldExvY2FsUG9zaXRpb24odGhpcy5ib3R0b21SaWdodCwgdGhpcy5vZmZzZXQueCArIHRoaXMud2lkdGgsIHRoaXMub2Zmc2V0LnkgKyB0aGlzLmhlaWdodCk7CgogICAgdGhpcy5fY2FjaGUubGVmdCA9IFBoYXNlci5NYXRoLm1pbih0aGlzLnRvcExlZnQueCwgdGhpcy50b3BSaWdodC54LCB0aGlzLmJvdHRvbUxlZnQueCwgdGhpcy5ib3R0b21SaWdodC54KTsKICAgIHRoaXMuX2NhY2hlLnJpZ2h0ID0gUGhhc2VyLk1hdGgubWF4KHRoaXMudG9wTGVmdC54LCB0aGlzLnRvcFJpZ2h0LngsIHRoaXMuYm90dG9tTGVmdC54LCB0aGlzLmJvdHRvbVJpZ2h0LngpOwogICAgdGhpcy5fY2FjaGUudG9wID0gUGhhc2VyLk1hdGgubWluKHRoaXMudG9wTGVmdC55LCB0aGlzLnRvcFJpZ2h0LnksIHRoaXMuYm90dG9tTGVmdC55LCB0aGlzLmJvdHRvbVJpZ2h0LnkpOwogICAgdGhpcy5fY2FjaGUuYm90dG9tID0gUGhhc2VyLk1hdGgubWF4KHRoaXMudG9wTGVmdC55LCB0aGlzLnRvcFJpZ2h0LnksIHRoaXMuYm90dG9tTGVmdC55LCB0aGlzLmJvdHRvbVJpZ2h0LnkpOwoKICAgIHRoaXMuYm91bmRzLnNldFRvKHRoaXMuX2NhY2hlLmxlZnQsIHRoaXMuX2NhY2hlLnRvcCwgdGhpcy5fY2FjaGUucmlnaHQgLSB0aGlzLl9jYWNoZS5sZWZ0LCB0aGlzLl9jYWNoZS5ib3R0b20gLSB0aGlzLl9jYWNoZS50b3ApOwoKICAgIHRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwoKICAgIGlmICh0aGlzLmluV29ybGQgPT09IGZhbHNlKQogICAgewogICAgICAgIC8vICBTcHJpdGUgV0FTIG91dCBvZiB0aGUgc2NyZWVuLCBpcyBpdCBzdGlsbD8KICAgICAgICB0aGlzLmluV29ybGQgPSBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHModGhpcy5ib3VuZHMsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMsIHRoaXMuaW5Xb3JsZFRocmVzaG9sZCk7CgogICAgICAgIGlmICh0aGlzLmluV29ybGQpCiAgICAgICAgewogICAgICAgICAgICAvLyAgSXQncyBiYWNrIGFnYWluLCByZXNldCB0aGUgT09CIGNoZWNrCiAgICAgICAgICAgIHRoaXMuX291dE9mQm91bmRzRmlyZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgLy8gICBTcHJpdGUgV0FTIGluIHRoZSBzY3JlZW4sIGhhcyBpdCBub3cgbGVmdD8KICAgICAgICB0aGlzLmluV29ybGQgPSBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHModGhpcy5ib3VuZHMsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMsIHRoaXMuaW5Xb3JsZFRocmVzaG9sZCk7CgogICAgICAgIGlmICh0aGlzLmluV29ybGQgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5ldmVudHMub25PdXRPZkJvdW5kcy5kaXNwYXRjaCh0aGlzKTsKICAgICAgICAgICAgdGhpcy5fb3V0T2ZCb3VuZHNGaXJlZCA9IHRydWU7CgogICAgICAgICAgICBpZiAodGhpcy5vdXRPZkJvdW5kc0tpbGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMua2lsbCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHRoaXMuX2NhY2hlLmNhbWVyYVZpc2libGUgPSBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHModGhpcy5nYW1lLndvcmxkLmNhbWVyYS5zY3JlZW5WaWV3LCB0aGlzLmJvdW5kcywgMCk7CgogICAgaWYgKHRoaXMuYXV0b0N1bGwpCiAgICB7CiAgICAgICAgLy8gIFdvbid0IGdldCByZW5kZXJlZCBidXQgd2lsbCBzdGlsbCBnZXQgaXRzIHRyYW5zZm9ybSB1cGRhdGVkCiAgICAgICAgdGhpcy5yZW5kZXJhYmxlID0gdGhpcy5fY2FjaGUuY2FtZXJhVmlzaWJsZTsKICAgIH0KCn07CgovKioKKiBHZXRzIHRoZSBsb2NhbCBwb3NpdGlvbiBvZiBhIGNvb3JkaW5hdGUgcmVsYXRpdmUgdG8gdGhlIFNwcml0ZSwgZmFjdG9yaW5nIGluIHJvdGF0aW9uIGFuZCBzY2FsZS4KKiBNb3N0bHkgb25seSB1c2VkIGludGVybmFsbHkuCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI2dldExvY2FsUG9zaXRpb24KKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBwIC0gVGhlIFBvaW50IG9iamVjdCB0byBzdG9yZSB0aGUgcmVzdWx0cyBpbi4KKiBAcGFyYW0ge251bWJlcn0geCAtIHggY29vcmRpbmF0ZSB3aXRoaW4gdGhlIFNwcml0ZSB0byB0cmFuc2xhdGUuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSB5IGNvb3JkaW5hdGUgd2l0aGluIHRoZSBTcHJpdGUgdG8gdHJhbnNsYXRlLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIHRyYW5zbGF0ZWQgcG9pbnQuCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLmdldExvY2FsUG9zaXRpb24gPSBmdW5jdGlvbihwLCB4LCB5KSB7CgogICAgcC54ID0gKCh0aGlzLl9jYWNoZS5hMTEgKiB0aGlzLl9jYWNoZS5pZCAqIHggKyAtdGhpcy5fY2FjaGUuYTAxICogdGhpcy5fY2FjaGUuaWQgKiB5ICsgKHRoaXMuX2NhY2hlLmExMiAqIHRoaXMuX2NhY2hlLmEwMSAtIHRoaXMuX2NhY2hlLmEwMiAqIHRoaXMuX2NhY2hlLmExMSkgKiB0aGlzLl9jYWNoZS5pZCkgKiB0aGlzLnNjYWxlLngpICsgdGhpcy5fY2FjaGUuYTAyOwogICAgcC55ID0gKCh0aGlzLl9jYWNoZS5hMDAgKiB0aGlzLl9jYWNoZS5pZCAqIHkgKyAtdGhpcy5fY2FjaGUuYTEwICogdGhpcy5fY2FjaGUuaWQgKiB4ICsgKC10aGlzLl9jYWNoZS5hMTIgKiB0aGlzLl9jYWNoZS5hMDAgKyB0aGlzLl9jYWNoZS5hMDIgKiB0aGlzLl9jYWNoZS5hMTApICogdGhpcy5fY2FjaGUuaWQpICogdGhpcy5zY2FsZS55KSArIHRoaXMuX2NhY2hlLmExMjsKCiAgICByZXR1cm4gcDsKCn07CgovKioKKiBHZXRzIHRoZSBsb2NhbCB1bm1vZGlmaWVkIHBvc2l0aW9uIG9mIGEgY29vcmRpbmF0ZSByZWxhdGl2ZSB0byB0aGUgU3ByaXRlLCBmYWN0b3JpbmcgaW4gcm90YXRpb24gYW5kIHNjYWxlLgoqIE1vc3RseSBvbmx5IHVzZWQgaW50ZXJuYWxseSBieSB0aGUgSW5wdXQgTWFuYWdlciwgYnV0IGFsc28gdXNlZnVsIGZvciBjdXN0b20gaGl0IGRldGVjdGlvbi4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjZ2V0TG9jYWxVbm1vZGlmaWVkUG9zaXRpb24KKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBwIC0gVGhlIFBvaW50IG9iamVjdCB0byBzdG9yZSB0aGUgcmVzdWx0cyBpbi4KKiBAcGFyYW0ge251bWJlcn0gZ3ggLSB4IGNvb3JkaW5hdGUgd2l0aGluIHRoZSBTcHJpdGUgdG8gdHJhbnNsYXRlLgoqIEBwYXJhbSB7bnVtYmVyfSBneSAtIHkgY29vcmRpbmF0ZSB3aXRoaW4gdGhlIFNwcml0ZSB0byB0cmFuc2xhdGUuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgdHJhbnNsYXRlZCBwb2ludC4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUuZ2V0TG9jYWxVbm1vZGlmaWVkUG9zaXRpb24gPSBmdW5jdGlvbihwLCBneCwgZ3kpIHsKCiAgICBwLnggPSAodGhpcy5fY2FjaGUuYTExICogdGhpcy5fY2FjaGUuaWRpICogZ3ggKyAtdGhpcy5fY2FjaGUuaTAxICogdGhpcy5fY2FjaGUuaWRpICogZ3kgKyAodGhpcy5fY2FjaGUuYTEyICogdGhpcy5fY2FjaGUuaTAxIC0gdGhpcy5fY2FjaGUuYTAyICogdGhpcy5fY2FjaGUuYTExKSAqIHRoaXMuX2NhY2hlLmlkaSkgKyAodGhpcy5hbmNob3IueCAqIHRoaXMuX2NhY2hlLndpZHRoKTsKICAgIHAueSA9ICh0aGlzLl9jYWNoZS5hMDAgKiB0aGlzLl9jYWNoZS5pZGkgKiBneSArIC10aGlzLl9jYWNoZS5pMTAgKiB0aGlzLl9jYWNoZS5pZGkgKiBneCArICgtdGhpcy5fY2FjaGUuYTEyICogdGhpcy5fY2FjaGUuYTAwICsgdGhpcy5fY2FjaGUuYTAyICogdGhpcy5fY2FjaGUuaTEwKSAqIHRoaXMuX2NhY2hlLmlkaSkgKyAodGhpcy5hbmNob3IueSAqIHRoaXMuX2NhY2hlLmhlaWdodCk7CgogICAgcmV0dXJuIHA7Cgp9OwoKLyoqCiogUmVzZXRzIHRoZSBTcHJpdGUuY3JvcCB2YWx1ZSBiYWNrIHRvIHRoZSBmcmFtZSBkaW1lbnNpb25zLgoqCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3Jlc2V0Q3JvcAoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLnJlc2V0Q3JvcCA9IGZ1bmN0aW9uKCkgewoKICAgIHRoaXMuY3JvcCA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKDAsIDAsIHRoaXMuX2NhY2hlLndpZHRoLCB0aGlzLl9jYWNoZS5oZWlnaHQpOwogICAgdGhpcy50ZXh0dXJlLnNldEZyYW1lKHRoaXMuY3JvcCk7CiAgICB0aGlzLmNyb3BFbmFibGVkID0gZmFsc2U7Cgp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gY2FsbGVkIGJ5IHRoZSBXb3JsZCBwb3N0VXBkYXRlIGN5Y2xlLgoqCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3Bvc3RVcGRhdGUKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5wb3N0VXBkYXRlID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKHRoaXMua2V5IGluc3RhbmNlb2YgUGhhc2VyLkJpdG1hcERhdGEgJiYgdGhpcy5rZXkuX2RpcnR5KQogICAgewogICAgICAgIHRoaXMua2V5LnJlbmRlcigpOwogICAgfQoKICAgIGlmICh0aGlzLmV4aXN0cykKICAgIHsKICAgICAgICBpZiAodGhpcy5ib2R5KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5ib2R5LnBvc3RVcGRhdGUoKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmZpeGVkVG9DYW1lcmEpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9jYWNoZS54ID0gdGhpcy5nYW1lLmNhbWVyYS52aWV3LnggKyB0aGlzLmNhbWVyYU9mZnNldC54OwogICAgICAgICAgICB0aGlzLl9jYWNoZS55ID0gdGhpcy5nYW1lLmNhbWVyYS52aWV3LnkgKyB0aGlzLmNhbWVyYU9mZnNldC55OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9jYWNoZS54ID0gdGhpcy54OwogICAgICAgICAgICB0aGlzLl9jYWNoZS55ID0gdGhpcy55OwogICAgICAgIH0KCiAgICAgICAgdGhpcy5wb3NpdGlvbi54ID0gdGhpcy5fY2FjaGUueDsKICAgICAgICB0aGlzLnBvc2l0aW9uLnkgPSB0aGlzLl9jYWNoZS55OwogICAgfQoKfTsKCi8qKgoqIENoYW5nZXMgdGhlIFRleHR1cmUgdGhlIFNwcml0ZSBpcyB1c2luZyBlbnRpcmVseS4gVGhlIG9sZCB0ZXh0dXJlIGlzIHJlbW92ZWQgYW5kIHRoZSBuZXcgb25lIGlzIHJlZmVyZW5jZWQgb3IgZmV0Y2hlZCBmcm9tIHRoZSBDYWNoZS4KKiBUaGlzIGNhdXNlcyBhIFdlYkdMIHRleHR1cmUgdXBkYXRlLCBzbyB1c2Ugc3BhcmluZ2x5IG9yIGluIGxvdy1pbnRlbnNpdHkgcG9ydGlvbnMgb2YgeW91ciBnYW1lLgoqCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI2xvYWRUZXh0dXJlCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcGFyYW0ge3N0cmluZ3xQaGFzZXIuUmVuZGVyVGV4dHVyZXxQaGFzZXIuQml0bWFwRGF0YXxQSVhJLlRleHR1cmV9IGtleSAtIFRoaXMgaXMgdGhlIGltYWdlIG9yIHRleHR1cmUgdXNlZCBieSB0aGUgU3ByaXRlIGR1cmluZyByZW5kZXJpbmcuIEl0IGNhbiBiZSBhIHN0cmluZyB3aGljaCBpcyBhIHJlZmVyZW5jZSB0byB0aGUgQ2FjaGUgZW50cnksIG9yIGFuIGluc3RhbmNlIG9mIGEgUmVuZGVyVGV4dHVyZSwgQml0bWFwRGF0YSBvciBQSVhJLlRleHR1cmUuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBmcmFtZSAtIElmIHRoaXMgU3ByaXRlIGlzIHVzaW5nIHBhcnQgb2YgYSBzcHJpdGUgc2hlZXQgb3IgdGV4dHVyZSBhdGxhcyB5b3UgY2FuIHNwZWNpZnkgdGhlIGV4YWN0IGZyYW1lIHRvIHVzZSBieSBnaXZpbmcgYSBzdHJpbmcgb3IgbnVtZXJpYyBpbmRleC4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUubG9hZFRleHR1cmUgPSBmdW5jdGlvbiAoa2V5LCBmcmFtZSkgewoKICAgIHRoaXMua2V5ID0ga2V5OwoKICAgIGlmIChrZXkgaW5zdGFuY2VvZiBQaGFzZXIuUmVuZGVyVGV4dHVyZSkKICAgIHsKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRUZXh0dXJlRnJhbWUoa2V5Lm5hbWUpOwogICAgfQogICAgZWxzZSBpZiAoa2V5IGluc3RhbmNlb2YgUGhhc2VyLkJpdG1hcERhdGEpCiAgICB7CiAgICAgICAgdGhpcy5zZXRUZXh0dXJlKGtleS50ZXh0dXJlKTsKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IGtleS50ZXh0dXJlRnJhbWU7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgaW5zdGFuY2VvZiBQSVhJLlRleHR1cmUpCiAgICB7CiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSBmcmFtZTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3VuZGVmaW5lZCcgfHwgdGhpcy5nYW1lLmNhY2hlLmNoZWNrSW1hZ2VLZXkoa2V5KSA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICBrZXkgPSAnX19kZWZhdWx0JzsKICAgICAgICAgICAgdGhpcy5rZXkgPSBrZXk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmNhY2hlLmlzU3ByaXRlU2hlZXQoa2V5KSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0aW9ucy5sb2FkRnJhbWVEYXRhKHRoaXMuZ2FtZS5jYWNoZS5nZXRGcmFtZURhdGEoa2V5KSk7CgogICAgICAgICAgICBpZiAodHlwZW9mIGZyYW1lICE9PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmcmFtZSA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSBmcmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZyYW1lID0gZnJhbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0RnJhbWUoa2V5KTsKICAgICAgICAgICAgdGhpcy5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW2tleV0pOwogICAgICAgIH0KICAgIH0KCn07CgovKioKKiBNb3ZlcyB0aGUgc3ByaXRlIHNvIGl0cyBjZW50ZXIgaXMgbG9jYXRlZCBvbiB0aGUgZ2l2ZW4geCBhbmQgeSBjb29yZGluYXRlcy4KKiBEb2Vzbid0IGNoYW5nZSB0aGUgYW5jaG9yIHBvaW50IG9mIHRoZSBzcHJpdGUuCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI2NlbnRlck9uCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgKGluIHdvcmxkIHNwYWNlKSB0byBwb3NpdGlvbiB0aGUgU3ByaXRlIGF0LgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSAoaW4gd29ybGQgc3BhY2UpIHRvIHBvc2l0aW9uIHRoZSBTcHJpdGUgYXQuCiogQHJldHVybiAoUGhhc2VyLlNwcml0ZSkgVGhpcyBpbnN0YW5jZS4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUuY2VudGVyT24gPSBmdW5jdGlvbih4LCB5KSB7CgogICAgaWYgKHRoaXMuZml4ZWRUb0NhbWVyYSkKICAgIHsKICAgICAgICB0aGlzLmNhbWVyYU9mZnNldC54ID0geCArICh0aGlzLmNhbWVyYU9mZnNldC54IC0gdGhpcy5jZW50ZXIueCk7CiAgICAgICAgdGhpcy5jYW1lcmFPZmZzZXQueSA9IHkgKyAodGhpcy5jYW1lcmFPZmZzZXQueSAtIHRoaXMuY2VudGVyLnkpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMueCA9IHggKyAodGhpcy54IC0gdGhpcy5jZW50ZXIueCk7CiAgICAgICAgdGhpcy55ID0geSArICh0aGlzLnkgLSB0aGlzLmNlbnRlci55KTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKCn07CgovKioKKiBCcmluZ3MgYSAnZGVhZCcgU3ByaXRlIGJhY2sgdG8gbGlmZSwgb3B0aW9uYWxseSBnaXZpbmcgaXQgdGhlIGhlYWx0aCB2YWx1ZSBzcGVjaWZpZWQuCiogQSByZXN1cnJlY3RlZCBTcHJpdGUgaGFzIGl0cyBhbGl2ZSwgZXhpc3RzIGFuZCB2aXNpYmxlIHByb3BlcnRpZXMgYWxsIHNldCB0byB0cnVlLgoqIEl0IHdpbGwgZGlzcGF0Y2ggdGhlIG9uUmV2aXZlZCBldmVudCwgeW91IGNhbiBsaXN0ZW4gdG8gU3ByaXRlLmV2ZW50cy5vblJldml2ZWQgZm9yIHRoZSBzaWduYWwuCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3Jldml2ZQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtudW1iZXJ9IFtoZWFsdGg9MV0gLSBUaGUgaGVhbHRoIHRvIGdpdmUgdGhlIFNwcml0ZS4KKiBAcmV0dXJuIChQaGFzZXIuU3ByaXRlKSBUaGlzIGluc3RhbmNlLgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5yZXZpdmUgPSBmdW5jdGlvbihoZWFsdGgpIHsKCiAgICBpZiAodHlwZW9mIGhlYWx0aCA9PT0gJ3VuZGVmaW5lZCcpIHsgaGVhbHRoID0gMTsgfQoKICAgIHRoaXMuYWxpdmUgPSB0cnVlOwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwogICAgdGhpcy52aXNpYmxlID0gdHJ1ZTsKICAgIHRoaXMuaGVhbHRoID0gaGVhbHRoOwoKICAgIGlmICh0aGlzLmV2ZW50cykKICAgIHsKICAgICAgICB0aGlzLmV2ZW50cy5vblJldml2ZWQuZGlzcGF0Y2godGhpcyk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cgp9OwoKLyoqCiogS2lsbHMgYSBTcHJpdGUuIEEga2lsbGVkIFNwcml0ZSBoYXMgaXRzIGFsaXZlLCBleGlzdHMgYW5kIHZpc2libGUgcHJvcGVydGllcyBhbGwgc2V0IHRvIGZhbHNlLgoqIEl0IHdpbGwgZGlzcGF0Y2ggdGhlIG9uS2lsbGVkIGV2ZW50LCB5b3UgY2FuIGxpc3RlbiB0byBTcHJpdGUuZXZlbnRzLm9uS2lsbGVkIGZvciB0aGUgc2lnbmFsLgoqIE5vdGUgdGhhdCBraWxsaW5nIGEgU3ByaXRlIGlzIGEgd2F5IGZvciB5b3UgdG8gcXVpY2tseSByZWN5Y2xlIGl0IGluIGEgU3ByaXRlIHBvb2wsIGl0IGRvZXNuJ3QgZnJlZSBpdCB1cCBmcm9tIG1lbW9yeS4KKiBJZiB5b3UgZG9uJ3QgbmVlZCB0aGlzIFNwcml0ZSBhbnkgbW9yZSB5b3Ugc2hvdWxkIGNhbGwgU3ByaXRlLmRlc3Ryb3kgaW5zdGVhZC4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUja2lsbAoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHJldHVybiAoUGhhc2VyLlNwcml0ZSkgVGhpcyBpbnN0YW5jZS4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUua2lsbCA9IGZ1bmN0aW9uKCkgewoKICAgIHRoaXMuYWxpdmUgPSBmYWxzZTsKICAgIHRoaXMuZXhpc3RzID0gZmFsc2U7CiAgICB0aGlzLnZpc2libGUgPSBmYWxzZTsKCiAgICBpZiAodGhpcy5ldmVudHMpCiAgICB7CiAgICAgICAgdGhpcy5ldmVudHMub25LaWxsZWQuZGlzcGF0Y2godGhpcyk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cgp9OwoKLyoqCiogRGVzdHJveXMgdGhlIFNwcml0ZS4gVGhpcyByZW1vdmVzIGl0IGZyb20gaXRzIHBhcmVudCBncm91cCwgZGVzdHJveXMgdGhlIGlucHV0LCBldmVudCBhbmQgYW5pbWF0aW9uIGhhbmRsZXJzIGlmIHByZXNlbnQKKiBhbmQgbnVsbHMgaXRzIHJlZmVyZW5jZSB0byBnYW1lLCBmcmVlaW5nIGl0IHVwIGZvciBnYXJiYWdlIGNvbGxlY3Rpb24uCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI2Rlc3Ryb3kKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKHRoaXMuZmlsdGVycykKICAgIHsKICAgICAgICB0aGlzLmZpbHRlcnMgPSBudWxsOwogICAgfQoKICAgIGlmICh0aGlzLmdyb3VwKQogICAgewogICAgICAgIHRoaXMuZ3JvdXAucmVtb3ZlKHRoaXMpOwogICAgfQoKICAgIGlmICh0aGlzLmlucHV0KQogICAgewogICAgICAgIHRoaXMuaW5wdXQuZGVzdHJveSgpOwogICAgfQoKICAgIGlmICh0aGlzLmV2ZW50cykKICAgIHsKICAgICAgICB0aGlzLmV2ZW50cy5kZXN0cm95KCk7CiAgICB9CgogICAgaWYgKHRoaXMuYW5pbWF0aW9ucykKICAgIHsKICAgICAgICB0aGlzLmFuaW1hdGlvbnMuZGVzdHJveSgpOwogICAgfQoKICAgIGlmICh0aGlzLmJvZHkpCiAgICB7CiAgICAgICAgdGhpcy5ib2R5LmRlc3Ryb3koKTsKICAgIH0KCiAgICB0aGlzLmFsaXZlID0gZmFsc2U7CiAgICB0aGlzLmV4aXN0cyA9IGZhbHNlOwogICAgdGhpcy52aXNpYmxlID0gZmFsc2U7CgogICAgdGhpcy5nYW1lID0gbnVsbDsKCn07CgovKioKKiBEYW1hZ2VzIHRoZSBTcHJpdGUsIHRoaXMgcmVtb3ZlcyB0aGUgZ2l2ZW4gYW1vdW50IGZyb20gdGhlIFNwcml0ZXMgaGVhbHRoIHByb3BlcnR5LgoqIElmIGhlYWx0aCBpcyB0aGVuIHRha2VuIGJlbG93IHplcm8gU3ByaXRlLmtpbGwgaXMgY2FsbGVkLgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNkYW1hZ2UKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgLSBUaGUgYW1vdW50IHRvIHN1YnRyYWN0IGZyb20gdGhlIFNwcml0ZS5oZWFsdGggdmFsdWUuCiogQHJldHVybiAoUGhhc2VyLlNwcml0ZSkgVGhpcyBpbnN0YW5jZS4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUuZGFtYWdlID0gZnVuY3Rpb24oYW1vdW50KSB7CgogICAgaWYgKHRoaXMuYWxpdmUpCiAgICB7CiAgICAgICAgdGhpcy5oZWFsdGggLT0gYW1vdW50OwoKICAgICAgICBpZiAodGhpcy5oZWFsdGggPCAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5raWxsKCk7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzOwoKfTsKCi8qKgoqIFJlc2V0cyB0aGUgU3ByaXRlLiBUaGlzIHBsYWNlcyB0aGUgU3ByaXRlIGF0IHRoZSBnaXZlbiB4L3kgd29ybGQgY29vcmRpbmF0ZXMgYW5kIHRoZW4KKiBzZXRzIGFsaXZlLCBleGlzdHMsIHZpc2libGUgYW5kIHJlbmRlcmFibGUgYWxsIHRvIHRydWUuIEFsc28gcmVzZXRzIHRoZSBvdXRPZkJvdW5kcyBzdGF0ZSBhbmQgaGVhbHRoIHZhbHVlcy4KKiBJZiB0aGUgU3ByaXRlIGhhcyBhIHBoeXNpY3MgYm9keSB0aGF0IHRvbyBpcyByZXNldC4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjcmVzZXQKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSAoaW4gd29ybGQgc3BhY2UpIHRvIHBvc2l0aW9uIHRoZSBTcHJpdGUgYXQuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIChpbiB3b3JsZCBzcGFjZSkgdG8gcG9zaXRpb24gdGhlIFNwcml0ZSBhdC4KKiBAcGFyYW0ge251bWJlcn0gW2hlYWx0aD0xXSAtIFRoZSBoZWFsdGggdG8gZ2l2ZSB0aGUgU3ByaXRlLgoqIEByZXR1cm4gKFBoYXNlci5TcHJpdGUpIFRoaXMgaW5zdGFuY2UuCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24oeCwgeSwgaGVhbHRoKSB7CgogICAgaWYgKHR5cGVvZiBoZWFsdGggPT09ICd1bmRlZmluZWQnKSB7IGhlYWx0aCA9IDE7IH0KCiAgICB0aGlzLnggPSB4OwogICAgdGhpcy55ID0geTsKICAgIHRoaXMud29ybGQuc2V0VG8oeCwgeSk7CiAgICB0aGlzLnBvc2l0aW9uLnggPSB0aGlzLng7CiAgICB0aGlzLnBvc2l0aW9uLnkgPSB0aGlzLnk7CiAgICB0aGlzLmFsaXZlID0gdHJ1ZTsKICAgIHRoaXMuZXhpc3RzID0gdHJ1ZTsKICAgIHRoaXMudmlzaWJsZSA9IHRydWU7CiAgICB0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwogICAgdGhpcy5fb3V0T2ZCb3VuZHNGaXJlZCA9IGZhbHNlOwoKICAgIHRoaXMuaGVhbHRoID0gaGVhbHRoOwoKICAgIGlmICh0aGlzLmJvZHkpCiAgICB7CiAgICAgICAgdGhpcy5ib2R5LnJlc2V0KGZhbHNlKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKICAgIAp9OwoKLyoqCiogQnJpbmdzIHRoZSBTcHJpdGUgdG8gdGhlIHRvcCBvZiB0aGUgZGlzcGxheSBsaXN0IGl0IGlzIGEgY2hpbGQgb2YuIFNwcml0ZXMgdGhhdCBhcmUgbWVtYmVycyBvZiBhIFBoYXNlci5Hcm91cCBhcmUgb25seQoqIGJvdWdodCB0byB0aGUgdG9wIG9mIHRoYXQgR3JvdXAsIG5vdCB0aGUgZW50aXJlIGRpc3BsYXkgbGlzdC4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjYnJpbmdUb1RvcAoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHJldHVybiAoUGhhc2VyLlNwcml0ZSkgVGhpcyBpbnN0YW5jZS4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUuYnJpbmdUb1RvcCA9IGZ1bmN0aW9uKCkgewoKICAgIGlmICh0aGlzLmdyb3VwKQogICAgewogICAgICAgIHRoaXMuZ3JvdXAuYnJpbmdUb1RvcCh0aGlzKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLmdhbWUud29ybGQuYnJpbmdUb1RvcCh0aGlzKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKCn07CgovKioKKiBQbGF5IGFuIGFuaW1hdGlvbiBiYXNlZCBvbiB0aGUgZ2l2ZW4ga2V5LiBUaGUgYW5pbWF0aW9uIHNob3VsZCBwcmV2aW91c2x5IGhhdmUgYmVlbiBhZGRlZCB2aWEgc3ByaXRlLmFuaW1hdGlvbnMuYWRkKCkKKiBJZiB0aGUgcmVxdWVzdGVkIGFuaW1hdGlvbiBpcyBhbHJlYWR5IHBsYXlpbmcgdGhpcyByZXF1ZXN0IHdpbGwgYmUgaWdub3JlZC4gSWYgeW91IG5lZWQgdG8gcmVzZXQgYW4gYWxyZWFkeSBydW5uaW5nIGFuaW1hdGlvbiBkbyBzbyBkaXJlY3RseSBvbiB0aGUgQW5pbWF0aW9uIG9iamVjdCBpdHNlbGYuCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3BsYXkKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGFuaW1hdGlvbiB0byBiZSBwbGF5ZWQsIGUuZy4gImZpcmUiLCAid2FsayIsICJqdW1wIi4KKiBAcGFyYW0ge251bWJlcn0gW2ZyYW1lUmF0ZT1udWxsXSAtIFRoZSBmcmFtZXJhdGUgdG8gcGxheSB0aGUgYW5pbWF0aW9uIGF0LiBUaGUgc3BlZWQgaXMgZ2l2ZW4gaW4gZnJhbWVzIHBlciBzZWNvbmQuIElmIG5vdCBwcm92aWRlZCB0aGUgcHJldmlvdXNseSBzZXQgZnJhbWVSYXRlIG9mIHRoZSBBbmltYXRpb24gaXMgdXNlZC4KKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIFNob3VsZCB0aGUgYW5pbWF0aW9uIGJlIGxvb3BlZCBhZnRlciBwbGF5YmFjay4gSWYgbm90IHByb3ZpZGVkIHRoZSBwcmV2aW91c2x5IHNldCBsb29wIHZhbHVlIG9mIHRoZSBBbmltYXRpb24gaXMgdXNlZC4KKiBAcGFyYW0ge2Jvb2xlYW59IFtraWxsT25Db21wbGV0ZT1mYWxzZV0gLSBJZiBzZXQgdG8gdHJ1ZSB3aGVuIHRoZSBhbmltYXRpb24gY29tcGxldGVzIChvbmx5IGhhcHBlbnMgaWYgbG9vcD1mYWxzZSkgdGhlIHBhcmVudCBTcHJpdGUgd2lsbCBiZSBraWxsZWQuCiogQHJldHVybiB7UGhhc2VyLkFuaW1hdGlvbn0gQSByZWZlcmVuY2UgdG8gcGxheWluZyBBbmltYXRpb24gaW5zdGFuY2UuCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLnBsYXkgPSBmdW5jdGlvbiAobmFtZSwgZnJhbWVSYXRlLCBsb29wLCBraWxsT25Db21wbGV0ZSkgewoKICAgIGlmICh0aGlzLmFuaW1hdGlvbnMpCiAgICB7CiAgICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0aW9ucy5wbGF5KG5hbWUsIGZyYW1lUmF0ZSwgbG9vcCwga2lsbE9uQ29tcGxldGUpOwogICAgfQoKfTsKCi8qKgoqIFJldHVybnMgdGhlIGRlbHRhIHggdmFsdWUuIFRoZSBkaWZmZXJlbmNlIGJldHdlZW4gU3ByaXRlLnggbm93IGFuZCBpbiB0aGUgcHJldmlvdXMgc3RlcC4KKiBAbmFtZSBQaGFzZXIuU3ByaXRlI2RlbHRhWAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkZWx0YVggLSBUaGUgZGVsdGEgdmFsdWUuIFBvc2l0aXZlIGlmIHRoZSBtb3Rpb24gd2FzIHRvIHRoZSByaWdodCwgbmVnYXRpdmUgaWYgdG8gdGhlIGxlZnQuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgJ2RlbHRhWCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLndvcmxkLnggLSB0aGlzLl9jYWNoZS5wcmV2WDsKICAgIH0KCn0pOwoKLyoqCiogUmV0dXJucyB0aGUgZGVsdGEgeCB2YWx1ZS4gVGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBTcHJpdGUueSBub3cgYW5kIGluIHRoZSBwcmV2aW91cyBzdGVwLgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjZGVsdGFZCiogQHByb3BlcnR5IHtudW1iZXJ9IGRlbHRhWSAtIFRoZSBkZWx0YSB2YWx1ZS4gUG9zaXRpdmUgaWYgdGhlIG1vdGlvbiB3YXMgZG93bndhcmRzLCBuZWdhdGl2ZSBpZiB1cHdhcmRzLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsICdkZWx0YVknLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy53b3JsZC55IC0gdGhpcy5fY2FjaGUucHJldlk7CiAgICB9Cgp9KTsKCi8qKgoqIEluZGljYXRlcyB0aGUgcm90YXRpb24gb2YgdGhlIFNwcml0ZSwgaW4gZGVncmVlcywgZnJvbSBpdHMgb3JpZ2luYWwgb3JpZW50YXRpb24uIFZhbHVlcyBmcm9tIDAgdG8gMTgwIHJlcHJlc2VudCBjbG9ja3dpc2Ugcm90YXRpb247IHZhbHVlcyBmcm9tIDAgdG8gLTE4MCByZXByZXNlbnQgY291bnRlcmNsb2Nrd2lzZSByb3RhdGlvbi4KKiBWYWx1ZXMgb3V0c2lkZSB0aGlzIHJhbmdlIGFyZSBhZGRlZCB0byBvciBzdWJ0cmFjdGVkIGZyb20gMzYwIHRvIG9idGFpbiBhIHZhbHVlIHdpdGhpbiB0aGUgcmFuZ2UuIEZvciBleGFtcGxlLCB0aGUgc3RhdGVtZW50IHBsYXllci5hbmdsZSA9IDQ1MCBpcyB0aGUgc2FtZSBhcyBwbGF5ZXIuYW5nbGUgPSA5MC4KKiBJZiB5b3Ugd2lzaCB0byB3b3JrIGluIHJhZGlhbnMgaW5zdGVhZCBvZiBkZWdyZWVzIHVzZSB0aGUgcHJvcGVydHkgU3ByaXRlLnJvdGF0aW9uIGluc3RlYWQuCiogQG5hbWUgUGhhc2VyLlNwcml0ZSNhbmdsZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmdsZSAtIEdldHMgb3Igc2V0cyB0aGUgU3ByaXRlcyBhbmdsZSBvZiByb3RhdGlvbiBpbiBkZWdyZWVzLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsICdhbmdsZScsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBQaGFzZXIuTWF0aC53cmFwQW5nbGUoUGhhc2VyLk1hdGgucmFkVG9EZWcodGhpcy5yb3RhdGlvbikpOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5yb3RhdGlvbiA9IFBoYXNlci5NYXRoLmRlZ1RvUmFkKFBoYXNlci5NYXRoLndyYXBBbmdsZSh2YWx1ZSkpOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuU3ByaXRlI2ZyYW1lCiogQHByb3BlcnR5IHtudW1iZXJ9IGZyYW1lIC0gR2V0cyBvciBzZXRzIHRoZSBjdXJyZW50IGZyYW1lIGluZGV4IGFuZCB1cGRhdGVzIHRoZSBUZXh0dXJlIENhY2hlIGZvciBkaXNwbGF5LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsICJmcmFtZSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0aW9ucy5mcmFtZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLmFuaW1hdGlvbnMuZnJhbWUgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNwcml0ZSNmcmFtZU5hbWUKKiBAcHJvcGVydHkge3N0cmluZ30gZnJhbWVOYW1lIC0gR2V0cyBvciBzZXRzIHRoZSBjdXJyZW50IGZyYW1lIG5hbWUgYW5kIHVwZGF0ZXMgdGhlIFRleHR1cmUgQ2FjaGUgZm9yIGRpc3BsYXkuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgImZyYW1lTmFtZSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0aW9ucy5mcmFtZU5hbWU7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5hbmltYXRpb25zLmZyYW1lTmFtZSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuU3ByaXRlI2luQ2FtZXJhCiogQHByb3BlcnR5IHtib29sZWFufSBpbkNhbWVyYSAtIElzIHRoaXMgc3ByaXRlIHZpc2libGUgdG8gdGhlIGNhbWVyYSBvciBub3Q/CiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgImluQ2FtZXJhIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY2FjaGUuY2FtZXJhVmlzaWJsZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNwcml0ZSN3b3JsZENlbnRlclgKKiBAcHJvcGVydHkge251bWJlcn0gd29ybGRDZW50ZXJYIC0gVGhlIGNlbnRlciBvZiB0aGUgU3ByaXRlIGluIHdvcmxkIGNvb3JkaW5hdGVzLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsICJ3b3JsZENlbnRlclgiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmdhbWUuY2FtZXJhLnggKyB0aGlzLmNlbnRlci54OwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuU3ByaXRlI3dvcmxkQ2VudGVyWQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3b3JsZENlbnRlclkgLSBUaGUgY2VudGVyIG9mIHRoZSBTcHJpdGUgaW4gd29ybGQgY29vcmRpbmF0ZXMuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgIndvcmxkQ2VudGVyWSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5jYW1lcmEueSArIHRoaXMuY2VudGVyLnk7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB3aWR0aCBvZiB0aGUgc3ByaXRlIGluIHBpeGVscywgc2V0dGluZyB0aGlzIHdpbGwgYWN0dWFsbHkgbW9kaWZ5IHRoZSBzY2FsZSB0byBhY2hlaXZlIHRoZSB2YWx1ZSBkZXNpcmVkLgoqIElmIHlvdSB3aXNoIHRvIGNyb3AgdGhlIFNwcml0ZSBpbnN0ZWFkIHNlZSB0aGUgU3ByaXRlLmNyb3AgdmFsdWUuCioKKiBAbmFtZSBQaGFzZXIuU3ByaXRlI3dpZHRoCiogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBTcHJpdGUgaW4gcGl4ZWxzLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsICd3aWR0aCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnNjYWxlLnggKiB0aGlzLmN1cnJlbnRGcmFtZS53aWR0aDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoKICAgICAgICB0aGlzLnNjYWxlLnggPSB2YWx1ZSAvIHRoaXMuY3VycmVudEZyYW1lLndpZHRoOwogICAgICAgIHRoaXMuX2NhY2hlLnNjYWxlWCA9IHZhbHVlIC8gdGhpcy5jdXJyZW50RnJhbWUud2lkdGg7CiAgICAgICAgdGhpcy5fd2lkdGggPSB2YWx1ZTsKCiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBoZWlnaHQgb2YgdGhlIHNwcml0ZSBpbiBwaXhlbHMsIHNldHRpbmcgdGhpcyB3aWxsIGFjdHVhbGx5IG1vZGlmeSB0aGUgc2NhbGUgdG8gYWNoZWl2ZSB0aGUgdmFsdWUgZGVzaXJlZC4KKiBJZiB5b3Ugd2lzaCB0byBjcm9wIHRoZSBTcHJpdGUgaW5zdGVhZCBzZWUgdGhlIFNwcml0ZS5jcm9wIHZhbHVlLgoqCiogQG5hbWUgUGhhc2VyLlNwcml0ZSNoZWlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgU3ByaXRlIGluIHBpeGVscy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCAnaGVpZ2h0JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUueSAqIHRoaXMuY3VycmVudEZyYW1lLmhlaWdodDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoKICAgICAgICB0aGlzLnNjYWxlLnkgPSB2YWx1ZSAvIHRoaXMuY3VycmVudEZyYW1lLmhlaWdodDsKICAgICAgICB0aGlzLl9jYWNoZS5zY2FsZVkgPSB2YWx1ZSAvIHRoaXMuY3VycmVudEZyYW1lLmhlaWdodDsKICAgICAgICB0aGlzLl9oZWlnaHQgPSB2YWx1ZTsKCiAgICB9Cgp9KTsKCi8qKgoqIEJ5IGRlZmF1bHQgYSBTcHJpdGUgd29uJ3QgcHJvY2VzcyBhbnkgaW5wdXQgZXZlbnRzIGF0IGFsbC4gQnkgc2V0dGluZyBpbnB1dEVuYWJsZWQgdG8gdHJ1ZSB0aGUgUGhhc2VyLklucHV0SGFuZGxlciBpcwoqIGFjdGl2YXRlZCBmb3IgdGhpcyBTcHJpdGUgaW5zdGFuY2UgYW5kIGl0IHdpbGwgdGhlbiBzdGFydCB0byBwcm9jZXNzIGNsaWNrL3RvdWNoIGV2ZW50cyBhbmQgbW9yZS4KKgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjaW5wdXRFbmFibGVkCiogQHByb3BlcnR5IHtib29sZWFufSBpbnB1dEVuYWJsZWQgLSBTZXQgdG8gdHJ1ZSB0byBhbGxvdyB0aGlzIFNwcml0ZSB0byByZWNlaXZlIGlucHV0IGV2ZW50cywgb3RoZXJ3aXNlIGZhbHNlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsICJpbnB1dEVuYWJsZWQiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4gKHRoaXMuaW5wdXQuZW5hYmxlZCk7CgogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodmFsdWUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5lbmFibGVkID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zdGFydCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LmVuYWJsZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQSBUaWxlU3ByaXRlIGlzIGEgU3ByaXRlIHdob3MgdGV4dHVyZSBpcyBzZXQgdG8gcmVwZWF0IGFuZCBjYW4gYmUgc2Nyb2xsZWQuIEFzIGl0IHNjcm9sbHMgdGhlIHRleHR1cmUgcmVwZWF0cyAod3JhcHMpIG9uIHRoZSBlZGdlcy4KKiBAY2xhc3MgUGhhc2VyLlRpbGVtYXAKKiBAZXh0ZW5kcyBQaGFzZXIuU3ByaXRlCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyB0aWxlU3ByaXRlLgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IHRpbGVTcHJpdGUuCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gdGhlIHdpZHRoIG9mIHRoZSB0aWxlc3ByaXRlLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSB0aGUgaGVpZ2h0IG9mIHRoZSB0aWxlc3ByaXRlLgoqIEBwYXJhbSB7c3RyaW5nfFBoYXNlci5SZW5kZXJUZXh0dXJlfFBJWEkuVGV4dHVyZX0ga2V5IC0gVGhpcyBpcyB0aGUgaW1hZ2Ugb3IgdGV4dHVyZSB1c2VkIGJ5IHRoZSBTcHJpdGUgZHVyaW5nIHJlbmRlcmluZy4gSXQgY2FuIGJlIGEgc3RyaW5nIHdoaWNoIGlzIGEgcmVmZXJlbmNlIHRvIHRoZSBDYWNoZSBlbnRyeSwgb3IgYW4gaW5zdGFuY2Ugb2YgYSBSZW5kZXJUZXh0dXJlIG9yIFBJWEkuVGV4dHVyZS4KKi8KUGhhc2VyLlRpbGVTcHJpdGUgPSBmdW5jdGlvbiAoZ2FtZSwgeCwgeSwgd2lkdGgsIGhlaWdodCwga2V5KSB7CgogICAgeCA9IHggfHwgMDsKICAgIHkgPSB5IHx8IDA7CiAgICB3aWR0aCA9IHdpZHRoIHx8IDI1NjsKICAgIGhlaWdodCA9IGhlaWdodCB8fCAyNTY7CiAgICBrZXkgPSBrZXkgfHwgbnVsbDsKCiAgICBQaGFzZXIuU3ByaXRlLmNhbGwodGhpcywgZ2FtZSwgeCwgeSwga2V5KTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQSVhJLlRleHR1cmV9IHRleHR1cmUgLSBUaGUgdGV4dHVyZSB0aGF0IHRoZSBzcHJpdGUgcmVuZGVycyB3aXRoLgogICAgKi8KICAgIHRoaXMudGV4dHVyZSA9IFBJWEkuVGV4dHVyZUNhY2hlW2tleV07CgogICAgUElYSS5UaWxpbmdTcHJpdGUuY2FsbCh0aGlzLCB0aGlzLnRleHR1cmUsIHdpZHRoLCBoZWlnaHQpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIFRoZSBjb25zdCB0eXBlIG9mIHRoaXMgb2JqZWN0LgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuVElMRVNQUklURTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHRpbGVTY2FsZSAtIFRoZSBzY2FsaW5nIG9mIHRoZSBpbWFnZSB0aGF0IGlzIGJlaW5nIHRpbGVkLgogICAgKi8KICAgIHRoaXMudGlsZVNjYWxlID0gbmV3IFBoYXNlci5Qb2ludCgxLCAxKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHRpbGVQb3NpdGlvbiAtIFRoZSBvZmZzZXQgcG9zaXRpb24gb2YgdGhlIGltYWdlIHRoYXQgaXMgYmVpbmcgdGlsZWQuCiAgICAqLwogICAgdGhpcy50aWxlUG9zaXRpb24gPSBuZXcgUGhhc2VyLlBvaW50KDAsIDApOwoKICAgIHRoaXMuYm9keS53aWR0aCA9IHdpZHRoOwogICAgdGhpcy5ib2R5LmhlaWdodCA9IGhlaWdodDsKCn07CgpQaGFzZXIuVGlsZVNwcml0ZS5wcm90b3R5cGUgPSBQaGFzZXIuVXRpbHMuZXh0ZW5kKHRydWUsIFBJWEkuVGlsaW5nU3ByaXRlLnByb3RvdHlwZSwgUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUpOwpQaGFzZXIuVGlsZVNwcml0ZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuVGlsZVNwcml0ZTsKCi8qKgoqIEluZGljYXRlcyB0aGUgcm90YXRpb24gb2YgdGhlIFNwcml0ZSwgaW4gZGVncmVlcywgZnJvbSBpdHMgb3JpZ2luYWwgb3JpZW50YXRpb24uIFZhbHVlcyBmcm9tIDAgdG8gMTgwIHJlcHJlc2VudCBjbG9ja3dpc2Ugcm90YXRpb247IHZhbHVlcyBmcm9tIDAgdG8gLTE4MCByZXByZXNlbnQgY291bnRlcmNsb2Nrd2lzZSByb3RhdGlvbi4KKiBWYWx1ZXMgb3V0c2lkZSB0aGlzIHJhbmdlIGFyZSBhZGRlZCB0byBvciBzdWJ0cmFjdGVkIGZyb20gMzYwIHRvIG9idGFpbiBhIHZhbHVlIHdpdGhpbiB0aGUgcmFuZ2UuIEZvciBleGFtcGxlLCB0aGUgc3RhdGVtZW50IHBsYXllci5hbmdsZSA9IDQ1MCBpcyB0aGUgc2FtZSBhcyBwbGF5ZXIuYW5nbGUgPSA5MC4KKiBJZiB5b3Ugd2lzaCB0byB3b3JrIGluIHJhZGlhbnMgaW5zdGVhZCBvZiBkZWdyZWVzIHVzZSB0aGUgcHJvcGVydHkgU3ByaXRlLnJvdGF0aW9uIGluc3RlYWQuCiogQG5hbWUgUGhhc2VyLlRpbGVTcHJpdGUjYW5nbGUKKiBAcHJvcGVydHkge251bWJlcn0gYW5nbGUgLSBHZXRzIG9yIHNldHMgdGhlIFNwcml0ZXMgYW5nbGUgb2Ygcm90YXRpb24gaW4gZGVncmVlcy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaWxlU3ByaXRlLnByb3RvdHlwZSwgJ2FuZ2xlJywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLndyYXBBbmdsZShQaGFzZXIuTWF0aC5yYWRUb0RlZyh0aGlzLnJvdGF0aW9uKSk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnJvdGF0aW9uID0gUGhhc2VyLk1hdGguZGVnVG9SYWQoUGhhc2VyLk1hdGgud3JhcEFuZ2xlKHZhbHVlKSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5UaWxlU3ByaXRlI2ZyYW1lCiogQHByb3BlcnR5IHtudW1iZXJ9IGZyYW1lIC0gR2V0cyBvciBzZXRzIHRoZSBjdXJyZW50IGZyYW1lIGluZGV4IGFuZCB1cGRhdGVzIHRoZSBUZXh0dXJlIENhY2hlIGZvciBkaXNwbGF5LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGVTcHJpdGUucHJvdG90eXBlLCAiZnJhbWUiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmFuaW1hdGlvbnMuZnJhbWU7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5hbmltYXRpb25zLmZyYW1lID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5UaWxlU3ByaXRlI2ZyYW1lTmFtZQoqIEBwcm9wZXJ0eSB7c3RyaW5nfSBmcmFtZU5hbWUgLSBHZXRzIG9yIHNldHMgdGhlIGN1cnJlbnQgZnJhbWUgbmFtZSBhbmQgdXBkYXRlcyB0aGUgVGV4dHVyZSBDYWNoZSBmb3IgZGlzcGxheS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaWxlU3ByaXRlLnByb3RvdHlwZSwgImZyYW1lTmFtZSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0aW9ucy5mcmFtZU5hbWU7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5hbmltYXRpb25zLmZyYW1lTmFtZSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuVGlsZVNwcml0ZSNpbkNhbWVyYQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaW5DYW1lcmEgLSBJcyB0aGlzIHNwcml0ZSB2aXNpYmxlIHRvIHRoZSBjYW1lcmEgb3Igbm90PwoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGVTcHJpdGUucHJvdG90eXBlLCAiaW5DYW1lcmEiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jYWNoZS5jYW1lcmFWaXNpYmxlOwogICAgfQoKfSk7CgovKioKKiBCeSBkZWZhdWx0IGEgU3ByaXRlIHdvbid0IHByb2Nlc3MgYW55IGlucHV0IGV2ZW50cyBhdCBhbGwuIEJ5IHNldHRpbmcgaW5wdXRFbmFibGVkIHRvIHRydWUgdGhlIFBoYXNlci5JbnB1dEhhbmRsZXIgaXMKKiBhY3RpdmF0ZWQgZm9yIHRoaXMgU3ByaXRlIGluc3RhbmNlIGFuZCBpdCB3aWxsIHRoZW4gc3RhcnQgdG8gcHJvY2VzcyBjbGljay90b3VjaCBldmVudHMgYW5kIG1vcmUuCioKKiBAbmFtZSBQaGFzZXIuVGlsZVNwcml0ZSNpbnB1dEVuYWJsZWQKKiBAcHJvcGVydHkge2Jvb2xlYW59IGlucHV0RW5hYmxlZCAtIFNldCB0byB0cnVlIHRvIGFsbG93IHRoaXMgU3ByaXRlIHRvIHJlY2VpdmUgaW5wdXQgZXZlbnRzLCBvdGhlcndpc2UgZmFsc2UuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZVNwcml0ZS5wcm90b3R5cGUsICJpbnB1dEVuYWJsZWQiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4gKHRoaXMuaW5wdXQuZW5hYmxlZCk7CgogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodmFsdWUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5lbmFibGVkID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zdGFydCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LmVuYWJsZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlIGEgbmV3IGBUZXh0YCBvYmplY3QuCiogQGNsYXNzIFBoYXNlci5UZXh0CiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyB0ZXh0IG9iamVjdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyB0ZXh0IG9iamVjdC4KKiBAcGFyYW0ge3N0cmluZ30gdGV4dCAtIFRoZSBhY3R1YWwgdGV4dCB0aGF0IHdpbGwgYmUgd3JpdHRlbi4KKiBAcGFyYW0ge29iamVjdH0gc3R5bGUgLSBUaGUgc3R5bGUgb2JqZWN0IGNvbnRhaW5pbmcgc3R5bGUgYXR0cmlidXRlcyBsaWtlIGZvbnQsIGZvbnQgc2l6ZSAsCiovClBoYXNlci5UZXh0ID0gZnVuY3Rpb24gKGdhbWUsIHgsIHksIHRleHQsIHN0eWxlKSB7CgogICAgeCA9IHggfHwgMDsKICAgIHkgPSB5IHx8IDA7CiAgICB0ZXh0ID0gdGV4dCB8fCAnJzsKICAgIHN0eWxlID0gc3R5bGUgfHwgJyc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwogCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBleGlzdHMgLSBJZiBleGlzdHMgPSBmYWxzZSB0aGVuIHRoZSBUZXh0IGlzbid0IHVwZGF0ZWQgYnkgdGhlIGNvcmUgZ2FtZSBsb29wLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZXhpc3RzID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhbGl2ZSAtIFRoaXMgaXMgYSBoYW5keSBsaXR0bGUgdmFyIHlvdXIgZ2FtZSBjYW4gdXNlIHRvIGRldGVybWluZSBpZiBhbiBvYmplY3QgaXMgYWxpdmUgb3Igbm90LCBpdCBkb2Vzbid0IGVmZmVjdCByZW5kZXJpbmcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbGl2ZSA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdyb3VwfSBncm91cCAtIFRoZSBwYXJlbnQgR3JvdXAgb2YgdGhpcyBUZXh0IG9iamVjdC4KICAgICovCiAgICB0aGlzLmdyb3VwID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBUaGUgdXNlciBkZWZpbmVkIG5hbWUgZ2l2ZW4gdG8gdGhpcyBvYmplY3QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5uYW1lID0gJyc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0eXBlIC0gVGhlIGNvbnN0IHR5cGUgb2YgdGhpcyBvYmplY3QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLlRFWFQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBfdGV4dCAtIEludGVybmFsIHZhbHVlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3RleHQgPSB0ZXh0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gX3N0eWxlIC0gSW50ZXJuYWwgdmFsdWUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fc3R5bGUgPSBzdHlsZTsKCiAgICBQSVhJLlRleHQuY2FsbCh0aGlzLCB0ZXh0LCBzdHlsZSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBwb3NpdGlvbiAtIFRoZSBwb3NpdGlvbiBvZiB0aGlzIFRleHQgb2JqZWN0IGluIHdvcmxkIHNwYWNlLgogICAgKi8KICAgIHRoaXMucG9zaXRpb24ueCA9IHRoaXMueCA9IHg7CiAgICB0aGlzLnBvc2l0aW9uLnkgPSB0aGlzLnkgPSB5OwoKICAgIC8qKgogICAgKiBUaGUgYW5jaG9yIHNldHMgdGhlIG9yaWdpbiBwb2ludCBvZiB0aGUgdGV4dHVyZS4KICAgICogVGhlIGRlZmF1bHQgaXMgMCwwIHRoaXMgbWVhbnMgdGhlIHRleHR1cmVzIG9yaWdpbiBpcyB0aGUgdG9wIGxlZnQgCiAgICAqIFNldHRpbmcgdGhhbiBhbmNob3IgdG8gMC41LDAuNSBtZWFucyB0aGUgdGV4dHVyZXMgb3JpZ2luIGlzIGNlbnRlcmVkCiAgICAqIFNldHRpbmcgdGhlIGFuY2hvciB0byAxLDEgd291bGQgbWVhbiB0aGUgdGV4dHVyZXMgb3JpZ2luIHBvaW50cyB3aWxsIGJlIHRoZSBib3R0b20gcmlnaHQKICAgICoKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGFuY2hvciAtIFRoZSBhbmNob3IgYXJvdW5kIHdoaWNoIHJvdGF0aW9uIGFuZCBzY2FsaW5nIHRha2VzIHBsYWNlLgogICAgKi8KICAgIHRoaXMuYW5jaG9yID0gbmV3IFBoYXNlci5Qb2ludCgpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHNjYWxlIC0gVGhlIHNjYWxlIG9mIHRoZSBvYmplY3Qgd2hlbiByZW5kZXJlZC4gQnkgZGVmYXVsdCBpdCdzIHNldCB0byAxIChubyBzY2FsZSkuIFlvdSBjYW4gbW9kaWZ5IGl0IHZpYSBzY2FsZS54IG9yIHNjYWxlLnkgb3Igc2NhbGUuc2V0VG8oeCwgeSkuIEEgdmFsdWUgb2YgMSBtZWFucyBubyBjaGFuZ2UgdG8gdGhlIHNjYWxlLCAwLjUgbWVhbnMgImhhbGYgdGhlIHNpemUiLCAyIG1lYW5zICJ0d2ljZSB0aGUgc2l6ZSIsIGV0Yy4KICAgICovCiAgICB0aGlzLnNjYWxlID0gbmV3IFBoYXNlci5Qb2ludCgxLCAxKTsKCiAgICAvKioKICAgICogQW4gb2JqZWN0IHRoYXQgaXMgZml4ZWQgdG8gdGhlIGNhbWVyYSBpZ25vcmVzIHRoZSBwb3NpdGlvbiBvZiBhbnkgYW5jZXN0b3JzIGluIHRoZSBkaXNwbGF5IGxpc3QgYW5kIHVzZXMgaXRzIHgveSBjb29yZGluYXRlcyBhcyBvZmZzZXRzIGZyb20gdGhlIHRvcCBsZWZ0IG9mIHRoZSBjYW1lcmEuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZml4ZWRUb0NhbWVyYSAtIEZpeGVzIHRoaXMgb2JqZWN0IHRvIHRoZSBDYW1lcmEuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5maXhlZFRvQ2FtZXJhID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBjYW1lcmFPZmZzZXQgLSBJZiB0aGlzIG9iamVjdCBpcyBmaXhlZCB0byB0aGUgY2FtZXJhIHRoZW4gdXNlIHRoaXMgUG9pbnQgdG8gc3BlY2lmeSBob3cgZmFyIGF3YXkgZnJvbSB0aGUgQ2FtZXJhIHgveSBpdCdzIHJlbmRlcmVkLgogICAgKi8KICAgIHRoaXMuY2FtZXJhT2Zmc2V0ID0gbmV3IFBoYXNlci5Qb2ludCh4LCB5KTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF9jYWNoZSAtIEEgbWluaSBjYWNoZSBmb3Igc3RvcmluZyBhbGwgb2YgdGhlIGNhbGN1bGF0ZWQgdmFsdWVzLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2NhY2hlID0gewoKICAgICAgICBkaXJ0eTogZmFsc2UsCgogICAgICAgIC8vICBUcmFuc2Zvcm0gY2FjaGUKICAgICAgICBhMDA6IDEsCiAgICAgICAgYTAxOiAwLAogICAgICAgIGEwMjogeCwKICAgICAgICBhMTA6IDAsCiAgICAgICAgYTExOiAxLAogICAgICAgIGExMjogeSwKICAgICAgICBpZDogMSwKCiAgICAgICAgLy8gIFRoZSBwcmV2aW91cyBjYWxjdWxhdGVkIHBvc2l0aW9uCiAgICAgICAgeDogLTEsCiAgICAgICAgeTogLTEsCgogICAgICAgIC8vICBUaGUgYWN0dWFsIHNjYWxlIHZhbHVlcyBiYXNlZCBvbiB0aGUgd29ybGRUcmFuc2Zvcm0KICAgICAgICBzY2FsZVg6IDEsCiAgICAgICAgc2NhbGVZOiAxCgogICAgfTsKCiAgICB0aGlzLl9jYWNoZS54ID0gdGhpcy54OwogICAgdGhpcy5fY2FjaGUueSA9IHRoaXMueTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSByZW5kZXJhYmxlIC0gQSByZW5kZXJhYmxlIG9iamVjdCB3aWxsIGJlIHJlbmRlcmVkIHRvIHRoZSBjb250ZXh0IGVhY2ggZnJhbWUuCiAgICAqLwogICAgdGhpcy5yZW5kZXJhYmxlID0gdHJ1ZTsKCn07CgpQaGFzZXIuVGV4dC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuVGV4dC5wcm90b3R5cGUpOwpQaGFzZXIuVGV4dC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuVGV4dDsKCi8qKgoqIEF1dG9tYXRpY2FsbHkgY2FsbGVkIGJ5IFdvcmxkLnVwZGF0ZS4KKiBAbWV0aG9kIFBoYXNlci5UZXh0LnByb3RvdHlwZS51cGRhdGUKKi8KUGhhc2VyLlRleHQucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKCkgewoKICAgIGlmICghdGhpcy5leGlzdHMpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh0aGlzLmZpeGVkVG9DYW1lcmEpCiAgICB7CiAgICAgICAgdGhpcy54ID0gdGhpcy5nYW1lLmNhbWVyYS52aWV3LnggKyB0aGlzLmNhbWVyYU9mZnNldC54OwogICAgICAgIHRoaXMueSA9IHRoaXMuZ2FtZS5jYW1lcmEudmlldy55ICsgdGhpcy5jYW1lcmFPZmZzZXQueTsKICAgIH0KCiAgICB0aGlzLl9jYWNoZS5kaXJ0eSA9IGZhbHNlOwoKICAgIHRoaXMuX2NhY2hlLnggPSB0aGlzLng7CiAgICB0aGlzLl9jYWNoZS55ID0gdGhpcy55OwoKICAgIGlmICh0aGlzLnBvc2l0aW9uLnggIT0gdGhpcy5fY2FjaGUueCB8fCB0aGlzLnBvc2l0aW9uLnkgIT0gdGhpcy5fY2FjaGUueSkKICAgIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLnggPSB0aGlzLl9jYWNoZS54OwogICAgICAgIHRoaXMucG9zaXRpb24ueSA9IHRoaXMuX2NhY2hlLnk7CiAgICAgICAgdGhpcy5fY2FjaGUuZGlydHkgPSB0cnVlOwogICAgfQoKfQoKLyoqCiogQG1ldGhvZCBQaGFzZXIuVGV4dC5wcm90b3R5cGUuZGVzdHJveQoqLwpQaGFzZXIuVGV4dC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoKICAgIGlmICh0aGlzLmdyb3VwKQogICAgewogICAgICAgIHRoaXMuZ3JvdXAucmVtb3ZlKHRoaXMpOwogICAgfQoKICAgIGlmICh0aGlzLmNhbnZhcy5wYXJlbnROb2RlKQogICAgewogICAgICAgIHRoaXMuY2FudmFzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcy5jYW52YXMpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMuY2FudmFzID0gbnVsbDsKICAgICAgICB0aGlzLmNvbnRleHQgPSBudWxsOwogICAgfQoKICAgIHRoaXMuZXhpc3RzID0gZmFsc2U7CgogICAgdGhpcy5ncm91cCA9IG51bGw7Cgp9CgovKioKKiBJbmRpY2F0ZXMgdGhlIHJvdGF0aW9uIG9mIHRoZSBUZXh0LCBpbiBkZWdyZWVzLCBmcm9tIGl0cyBvcmlnaW5hbCBvcmllbnRhdGlvbi4gVmFsdWVzIGZyb20gMCB0byAxODAgcmVwcmVzZW50IGNsb2Nrd2lzZSByb3RhdGlvbjsgdmFsdWVzIGZyb20gMCB0byAtMTgwIHJlcHJlc2VudCBjb3VudGVyY2xvY2t3aXNlIHJvdGF0aW9uLgoqIFZhbHVlcyBvdXRzaWRlIHRoaXMgcmFuZ2UgYXJlIGFkZGVkIHRvIG9yIHN1YnRyYWN0ZWQgZnJvbSAzNjAgdG8gb2J0YWluIGEgdmFsdWUgd2l0aGluIHRoZSByYW5nZS4gRm9yIGV4YW1wbGUsIHRoZSBzdGF0ZW1lbnQgcGxheWVyLmFuZ2xlID0gNDUwIGlzIHRoZSBzYW1lIGFzIHBsYXllci5hbmdsZSA9IDkwLgoqIElmIHlvdSB3aXNoIHRvIHdvcmsgaW4gcmFkaWFucyBpbnN0ZWFkIG9mIGRlZ3JlZXMgdXNlIHRoZSBwcm9wZXJ0eSBTcHJpdGUucm90YXRpb24gaW5zdGVhZC4KKiBAbmFtZSBQaGFzZXIuVGV4dCNhbmdsZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmdsZSAtIEdldHMgb3Igc2V0cyB0aGUgYW5nbGUgb2Ygcm90YXRpb24gaW4gZGVncmVlcy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UZXh0LnByb3RvdHlwZSwgJ2FuZ2xlJywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLnJhZFRvRGVnKHRoaXMucm90YXRpb24pOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5yb3RhdGlvbiA9IFBoYXNlci5NYXRoLmRlZ1RvUmFkKHZhbHVlKTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHggY29vcmRpbmF0ZSBvZiB0aGlzIG9iamVjdCBpbiB3b3JsZCBzcGFjZS4KKiBAbmFtZSBQaGFzZXIuVGV4dCN4CiogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoaXMgb2JqZWN0IGluIHdvcmxkIHNwYWNlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRleHQucHJvdG90eXBlLCAneCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLng7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLnggPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGlzIG9iamVjdCBpbiB3b3JsZCBzcGFjZS4KKiBAbmFtZSBQaGFzZXIuVGV4dCN5CiogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoaXMgb2JqZWN0IGluIHdvcmxkIHNwYWNlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRleHQucHJvdG90eXBlLCAneScsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLnk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLnkgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHN0cmluZyB0byBiZSByZW5kZXJlZCBieSB0aGlzIFRleHQgb2JqZWN0LgoqIEBuYW1lIFBoYXNlci5UZXh0I2NvbnRlbnQKKiBAcHJvcGVydHkge3N0cmluZ30gY29udGVudCAtIFRoZSBzdHJpbmcgdG8gYmUgcmVuZGVyZWQgYnkgdGhpcyBUZXh0IG9iamVjdC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UZXh0LnByb3RvdHlwZSwgJ2NvbnRlbnQnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdGV4dDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoKICAgICAgICAvLyAgTGV0J3Mgbm90IHVwZGF0ZSB1bmxlc3MgbmVlZGVkLCB0aGlzIHdheSB3ZSBjYW4gc2FmZWx5IHVwZGF0ZSB0aGUgdGV4dCBpbiBhIGNvcmUgbG9vcCB3aXRob3V0IGNvbnN0YW50IHJlLWRyYXdzCiAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLl90ZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fdGV4dCA9IHZhbHVlOwogICAgICAgICAgICB0aGlzLnNldFRleHQodmFsdWUpOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBmb250IHRoZSB0ZXh0IHdpbGwgYmUgcmVuZGVyZWQgaW4uCiogQG5hbWUgUGhhc2VyLlRleHQjZm9udAoqIEBwcm9wZXJ0eSB7c3RyaW5nfSBmb250IC0gVGhlIGZvbnQgdGhlIHRleHQgd2lsbCBiZSByZW5kZXJlZCBpbi4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UZXh0LnByb3RvdHlwZSwgJ2ZvbnQnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc3R5bGU7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKCiAgICAgICAgLy8gIExldCdzIG5vdCB1cGRhdGUgdW5sZXNzIG5lZWRlZCwgdGhpcyB3YXkgd2UgY2FuIHNhZmVseSB1cGRhdGUgdGhlIHRleHQgaW4gYSBjb3JlIGxvb3Agd2l0aG91dCBjb25zdGFudCByZS1kcmF3cwogICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy5fc3R5bGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9zdHlsZSA9IHZhbHVlOwogICAgICAgICAgICB0aGlzLnNldFN0eWxlKHZhbHVlKTsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGVzIGEgbmV3IEJpdG1hcFRleHQgb2JqZWN0LgoqCiogQGNsYXNzIFBoYXNlci5CaXRtYXBUZXh0CioKKiBAY2xhc3NkZXNjIEJpdG1hcFRleHQgb2JqZWN0cyB3b3JrIGJ5IHRha2luZyBhIHRleHR1cmUgZmlsZSBhbmQgYW4gWE1MIGZpbGUgdGhhdCBkZXNjcmliZXMgdGhlIGZvbnQgbGF5b3V0LgoqCiogT24gV2luZG93cyB5b3UgY2FuIHVzZSB0aGUgZnJlZSBhcHAgQk1Gb250OiBodHRwOi8vd3d3LmFuZ2VsY29kZS5jb20vcHJvZHVjdHMvYm1mb250LwoqCiogT24gT1MgWCB3ZSByZWNvbW1lbmQgR2x5cGggRGVzaWduZXI6IGh0dHA6Ly93d3cuNzFzcXVhcmVkLmNvbS9lbi9nbHlwaGRlc2lnbmVyCioKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgYml0bWFwVGV4dCBvYmplY3QuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgYml0bWFwVGV4dCBvYmplY3QuCiogQHBhcmFtIHtzdHJpbmd9IHRleHQgLSBUaGUgYWN0dWFsIHRleHQgdGhhdCB3aWxsIGJlIHdyaXR0ZW4uCiogQHBhcmFtIHtvYmplY3R9IHN0eWxlIC0gVGhlIHN0eWxlIG9iamVjdCBjb250YWluaW5nIHN0eWxlIGF0dHJpYnV0ZXMgbGlrZSBmb250LCBmb250IHNpemUgLCBldGMuCiovClBoYXNlci5CaXRtYXBUZXh0ID0gZnVuY3Rpb24gKGdhbWUsIHgsIHksIHRleHQsIHN0eWxlKSB7CgogICAgeCA9IHggfHwgMDsKICAgIHkgPSB5IHx8IDA7CiAgICB0ZXh0ID0gdGV4dCB8fCAnJzsKICAgIHN0eWxlID0gc3R5bGUgfHwgJyc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtib29sZWFufSBleGlzdHMgLSBJZiBleGlzdHMgPSBmYWxzZSB0aGVuIHRoZSBTcHJpdGUgaXNuJ3QgdXBkYXRlZCBieSB0aGUgY29yZSBnYW1lIGxvb3Agb3IgcGh5c2ljcyBzdWJzeXN0ZW0gYXQgYWxsLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZXhpc3RzID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhbGl2ZSAtIFRoaXMgaXMgYSBoYW5keSBsaXR0bGUgdmFyIHlvdXIgZ2FtZSBjYW4gdXNlIHRvIGRldGVybWluZSBpZiBhIHNwcml0ZSBpcyBhbGl2ZSBvciBub3QsIGl0IGRvZXNuJ3QgZWZmZWN0IHJlbmRlcmluZy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFsaXZlID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR3JvdXB9IGdyb3VwIC0gVGhlIHBhcmVudCBHcm91cCBvZiB0aGlzIEJpdG1hcFRleHQuCiAgICAqLwogICAgdGhpcy5ncm91cCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gVGhlIHVzZXIgZGVmaW5lZCBuYW1lIGdpdmVuIHRvIHRoaXMgQml0bWFwVGV4dC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm5hbWUgPSAnJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBUaGUgY29uc3QgdHlwZSBvZiB0aGlzIG9iamVjdC4KICAgICogQHJlYWRvbmx5CiAgICAqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLkJJVE1BUFRFWFQ7CgogICAgUElYSS5CaXRtYXBUZXh0LmNhbGwodGhpcywgdGV4dCwgc3R5bGUpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcG9zaXRpb24ueCAtIFRoZSB4IHBvc2l0aW9uIG9mIHRoaXMgb2JqZWN0LgogICAgKi8KICAgIHRoaXMucG9zaXRpb24ueCA9IHg7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcG9zaXRpb24ueSAtIFRoZSB5IHBvc2l0aW9uIG9mIHRoaXMgb2JqZWN0LgogICAgKi8KICAgIHRoaXMucG9zaXRpb24ueSA9IHk7CgogICAgLyoqCiAgICAqIFRoZSBhbmNob3Igc2V0cyB0aGUgb3JpZ2luIHBvaW50IG9mIHRoZSB0ZXh0dXJlLgogICAgKiBUaGUgZGVmYXVsdCBpcyAwLDAgdGhpcyBtZWFucyB0aGUgdGV4dHVyZXMgb3JpZ2luIGlzIHRoZSB0b3AgbGVmdCAKICAgICogU2V0dGluZyB0aGFuIGFuY2hvciB0byAwLjUsMC41IG1lYW5zIHRoZSB0ZXh0dXJlcyBvcmlnaW4gaXMgY2VudGVyZWQKICAgICogU2V0dGluZyB0aGUgYW5jaG9yIHRvIDEsMSB3b3VsZCBtZWFuIHRoZSB0ZXh0dXJlcyBvcmlnaW4gcG9pbnRzIHdpbGwgYmUgdGhlIGJvdHRvbSByaWdodAogICAgKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYW5jaG9yIC0gVGhlIGFuY2hvciBhcm91bmQgd2hpY2ggcm90YXRpb24gYW5kIHNjYWxpbmcgdGFrZXMgcGxhY2UuCiAgICAqLwogICAgdGhpcy5hbmNob3IgPSBuZXcgUGhhc2VyLlBvaW50KCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc2NhbGUgLSBUaGUgc2NhbGUgb2YgdGhlIG9iamVjdCB3aGVuIHJlbmRlcmVkLiBCeSBkZWZhdWx0IGl0J3Mgc2V0IHRvIDEgKG5vIHNjYWxlKS4gWW91IGNhbiBtb2RpZnkgaXQgdmlhIHNjYWxlLnggb3Igc2NhbGUueSBvciBzY2FsZS5zZXRUbyh4LCB5KS4gQSB2YWx1ZSBvZiAxIG1lYW5zIG5vIGNoYW5nZSB0byB0aGUgc2NhbGUsIDAuNSBtZWFucyAiaGFsZiB0aGUgc2l6ZSIsIDIgbWVhbnMgInR3aWNlIHRoZSBzaXplIiwgZXRjLgogICAgKi8KICAgIHRoaXMuc2NhbGUgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX2NhY2hlIC0gQSBtaW5pIGNhY2hlIGZvciBzdG9yaW5nIGFsbCBvZiB0aGUgY2FsY3VsYXRlZCB2YWx1ZXMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fY2FjaGUgPSB7CgogICAgICAgIGRpcnR5OiBmYWxzZSwKCiAgICAgICAgLy8gIFRyYW5zZm9ybSBjYWNoZQogICAgICAgIGEwMDogMSwKICAgICAgICBhMDE6IDAsCiAgICAgICAgYTAyOiB4LAogICAgICAgIGExMDogMCwKICAgICAgICBhMTE6IDEsCiAgICAgICAgYTEyOiB5LAogICAgICAgIGlkOiAxLAoKICAgICAgICAvLyAgVGhlIHByZXZpb3VzIGNhbGN1bGF0ZWQgcG9zaXRpb24KICAgICAgICB4OiAtMSwKICAgICAgICB5OiAtMSwKCiAgICAgICAgLy8gIFRoZSBhY3R1YWwgc2NhbGUgdmFsdWVzIGJhc2VkIG9uIHRoZSB3b3JsZFRyYW5zZm9ybQogICAgICAgIHNjYWxlWDogMSwKICAgICAgICBzY2FsZVk6IDEKCiAgICB9OwoKICAgIHRoaXMuX2NhY2hlLnggPSB0aGlzLng7CiAgICB0aGlzLl9jYWNoZS55ID0gdGhpcy55OwoKfTsKClBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5CaXRtYXBUZXh0LnByb3RvdHlwZSk7ClBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5CaXRtYXBUZXh0OwoKLyoqCiogQXV0b21hdGljYWxseSBjYWxsZWQgYnkgV29ybGQudXBkYXRlCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwVGV4dC5wcm90b3R5cGUudXBkYXRlCiovClBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbigpIHsKCiAgICBpZiAoIXRoaXMuZXhpc3RzKQogICAgewogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLl9jYWNoZS5kaXJ0eSA9IGZhbHNlOwoKICAgIHRoaXMuX2NhY2hlLnggPSB0aGlzLng7CiAgICB0aGlzLl9jYWNoZS55ID0gdGhpcy55OwoKICAgIGlmICh0aGlzLnBvc2l0aW9uLnggIT0gdGhpcy5fY2FjaGUueCB8fCB0aGlzLnBvc2l0aW9uLnkgIT0gdGhpcy5fY2FjaGUueSkKICAgIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLnggPSB0aGlzLl9jYWNoZS54OwogICAgICAgIHRoaXMucG9zaXRpb24ueSA9IHRoaXMuX2NhY2hlLnk7CiAgICAgICAgdGhpcy5fY2FjaGUuZGlydHkgPSB0cnVlOwogICAgfQoKICAgIHRoaXMucGl2b3QueCA9IHRoaXMuYW5jaG9yLnggKiB0aGlzLndpZHRoOwogICAgdGhpcy5waXZvdC55ID0gdGhpcy5hbmNob3IueSAqIHRoaXMuaGVpZ2h0OwoKfQoKLyoqCiogQG1ldGhvZCBQaGFzZXIuVGV4dC5wcm90b3R5cGUuZGVzdHJveQoqLwpQaGFzZXIuQml0bWFwVGV4dC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoKICAgIGlmICh0aGlzLmdyb3VwKQogICAgewogICAgICAgIHRoaXMuZ3JvdXAucmVtb3ZlKHRoaXMpOwogICAgfQoKICAgIGlmICh0aGlzLmNhbnZhcyAmJiB0aGlzLmNhbnZhcy5wYXJlbnROb2RlKQogICAgewogICAgICAgIHRoaXMuY2FudmFzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcy5jYW52YXMpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMuY2FudmFzID0gbnVsbDsKICAgICAgICB0aGlzLmNvbnRleHQgPSBudWxsOwogICAgfQoKICAgIHRoaXMuZXhpc3RzID0gZmFsc2U7CgogICAgdGhpcy5ncm91cCA9IG51bGw7Cgp9CgovKioKKiBJbmRpY2F0ZXMgdGhlIHJvdGF0aW9uIG9mIHRoZSBCaXRtYXBUZXh0LCBpbiBkZWdyZWVzLCBmcm9tIGl0cyBvcmlnaW5hbCBvcmllbnRhdGlvbi4gVmFsdWVzIGZyb20gMCB0byAxODAgcmVwcmVzZW50IGNsb2Nrd2lzZSByb3RhdGlvbjsgdmFsdWVzIGZyb20gMCB0byAtMTgwIHJlcHJlc2VudCBjb3VudGVyY2xvY2t3aXNlIHJvdGF0aW9uLgoqIFZhbHVlcyBvdXRzaWRlIHRoaXMgcmFuZ2UgYXJlIGFkZGVkIHRvIG9yIHN1YnRyYWN0ZWQgZnJvbSAzNjAgdG8gb2J0YWluIGEgdmFsdWUgd2l0aGluIHRoZSByYW5nZS4gRm9yIGV4YW1wbGUsIHRoZSBzdGF0ZW1lbnQgcGxheWVyLmFuZ2xlID0gNDUwIGlzIHRoZSBzYW1lIGFzIHBsYXllci5hbmdsZSA9IDkwLgoqIElmIHlvdSB3aXNoIHRvIHdvcmsgaW4gcmFkaWFucyBpbnN0ZWFkIG9mIGRlZ3JlZXMgdXNlIHRoZSBwcm9wZXJ0eSBTcHJpdGUucm90YXRpb24gaW5zdGVhZC4KKiBAbmFtZSBQaGFzZXIuQml0bWFwVGV4dCNhbmdsZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmdsZSAtIEdldHMgb3Igc2V0cyB0aGUgYW5nbGUgb2Ygcm90YXRpb24gaW4gZGVncmVlcy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZSwgJ2FuZ2xlJywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLnJhZFRvRGVnKHRoaXMucm90YXRpb24pOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5yb3RhdGlvbiA9IFBoYXNlci5NYXRoLmRlZ1RvUmFkKHZhbHVlKTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHggY29vcmRpbmF0ZSBvZiB0aGlzIG9iamVjdCBpbiB3b3JsZCBzcGFjZS4KKiBAbmFtZSBQaGFzZXIuQml0bWFwVGV4dCN4CiogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoaXMgb2JqZWN0IGluIHdvcmxkIHNwYWNlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkJpdG1hcFRleHQucHJvdG90eXBlLCAneCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLng7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLnggPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGlzIG9iamVjdCBpbiB3b3JsZCBzcGFjZS4KKiBAbmFtZSBQaGFzZXIuQml0bWFwVGV4dCN5CiogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoaXMgb2JqZWN0IGluIHdvcmxkIHNwYWNlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkJpdG1hcFRleHQucHJvdG90eXBlLCAneScsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLnk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLnkgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQGNsYXNzIFBoYXNlci5CdXR0b24KKgoqIEBjbGFzc2Rlc2MgQ3JlYXRlIGEgbmV3IGBCdXR0b25gIG9iamVjdC4gQSBCdXR0b24gaXMgYSBzcGVjaWFsIHR5cGUgb2YgU3ByaXRlIHRoYXQgaXMgc2V0LXVwIHRvIGhhbmRsZSBQb2ludGVyIGV2ZW50cyBhdXRvbWF0aWNhbGx5LiBUaGUgZm91ciBzdGF0ZXMgYSBCdXR0b24gcmVzcG9uZHMgdG8gYXJlOgoqCiogKiAnT3ZlcicgLSB3aGVuIHRoZSBQb2ludGVyIG1vdmVzIG92ZXIgdGhlIEJ1dHRvbi4gVGhpcyBpcyBhbHNvIGNvbW1vbmx5IGtub3duIGFzICdob3ZlcicuCiogKiAnT3V0JyAtIHdoZW4gdGhlIFBvaW50ZXIgdGhhdCB3YXMgcHJldmlvdXNseSBvdmVyIHRoZSBCdXR0b24gbW92ZXMgb3V0IG9mIGl0LgoqICogJ0Rvd24nIC0gd2hlbiB0aGUgUG9pbnRlciBpcyBwcmVzc2VkIGRvd24gb24gdGhlIEJ1dHRvbi4gSS5lLiB0b3VjaGVkIG9uIGEgdG91Y2ggZW5hYmxlZCBkZXZpY2Ugb3IgY2xpY2tlZCB3aXRoIHRoZSBtb3VzZS4KKiAqICdVcCcgLSB3aGVuIHRoZSBQb2ludGVyIHRoYXQgd2FzIHByZXNzZWQgZG93biBvbiB0aGUgQnV0dG9uIGlzIHJlbGVhc2VkIGFnYWluLgoqCiogWW91IGNhbiBzZXQgYSB1bmlxdWUgdGV4dHVyZSBmcmFtZSBhbmQgU291bmQgZm9yIGFueSBvZiB0aGVzZSBzdGF0ZXMuCioKKiBAY29uc3RydWN0b3IKKgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7bnVtYmVyfSBbeD0wXSAtIFggcG9zaXRpb24gb2YgdGhlIEJ1dHRvbi4KKiBAcGFyYW0ge251bWJlcn0gW3k9MF0gLSBZIHBvc2l0aW9uIG9mIHRoZSBCdXR0b24uCiogQHBhcmFtIHtzdHJpbmd9IFtrZXldIC0gVGhlIGltYWdlIGtleSBhcyBkZWZpbmVkIGluIHRoZSBHYW1lLkNhY2hlIHRvIHVzZSBhcyB0aGUgdGV4dHVyZSBmb3IgdGhpcyBCdXR0b24uCiogQHBhcmFtIHtmdW5jdGlvbn0gW2NhbGxiYWNrXSAtIFRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhpcyBCdXR0b24gaXMgcHJlc3NlZC4KKiBAcGFyYW0ge29iamVjdH0gW2NhbGxiYWNrQ29udGV4dF0gLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgKHVzdWFsbHkgJ3RoaXMnKS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtvdmVyRnJhbWVdIC0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhbiBvdmVyIHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgoqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW291dEZyYW1lXSAtIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYW4gb3V0IHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgoqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW2Rvd25GcmFtZV0gLSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGEgZG93biBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFt1cEZyYW1lXSAtIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYW4gdXAgc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiovClBoYXNlci5CdXR0b24gPSBmdW5jdGlvbiAoZ2FtZSwgeCwgeSwga2V5LCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVyRnJhbWUsIG91dEZyYW1lLCBkb3duRnJhbWUsIHVwRnJhbWUpIHsKCiAgICB4ID0geCB8fCAwOwogICAgeSA9IHkgfHwgMDsKICAgIGtleSA9IGtleSB8fCBudWxsOwogICAgY2FsbGJhY2sgPSBjYWxsYmFjayB8fCBudWxsOwogICAgY2FsbGJhY2tDb250ZXh0ID0gY2FsbGJhY2tDb250ZXh0IHx8IHRoaXM7CgogICAgUGhhc2VyLlNwcml0ZS5jYWxsKHRoaXMsIGdhbWUsIHgsIHksIGtleSwgb3V0RnJhbWUpOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBUaGUgUGhhc2VyIE9iamVjdCBUeXBlLgogICAgKi8KICAgIHRoaXMudHlwZSA9IFBoYXNlci5CVVRUT047CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge3N0cmluZ30gX29uT3ZlckZyYW1lTmFtZSAtIEludGVybmFsIHZhcmlhYmxlLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uT3ZlckZyYW1lTmFtZSA9IG51bGw7CiAgICAKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IF9vbk91dEZyYW1lTmFtZSAtIEludGVybmFsIHZhcmlhYmxlLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uT3V0RnJhbWVOYW1lID0gbnVsbDsKICAgIAogICAgLyoqIAogICAgKiBAcHJvcGVydHkge3N0cmluZ30gX29uRG93bkZyYW1lTmFtZSAtIEludGVybmFsIHZhcmlhYmxlLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uRG93bkZyYW1lTmFtZSA9IG51bGw7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge3N0cmluZ30gX29uVXBGcmFtZU5hbWUgLSBJbnRlcm5hbCB2YXJpYWJsZS4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9vblVwRnJhbWVOYW1lID0gbnVsbDsKICAgIAogICAgLyoqIAogICAgKiBAcHJvcGVydHkge251bWJlcn0gX29uT3ZlckZyYW1lSUQgLSBJbnRlcm5hbCB2YXJpYWJsZS4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9vbk92ZXJGcmFtZUlEID0gbnVsbDsKICAgIAogICAgLyoqIAogICAgKiBAcHJvcGVydHkge251bWJlcn0gX29uT3V0RnJhbWVJRCAtIEludGVybmFsIHZhcmlhYmxlLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uT3V0RnJhbWVJRCA9IG51bGw7CiAgICAKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9vbkRvd25GcmFtZUlEIC0gSW50ZXJuYWwgdmFyaWFibGUuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb25Eb3duRnJhbWVJRCA9IG51bGw7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge251bWJlcn0gX29uVXBGcmFtZUlEIC0gSW50ZXJuYWwgdmFyaWFibGUuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb25VcEZyYW1lSUQgPSBudWxsOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU291bmR9IG9uT3ZlclNvdW5kIC0gVGhlIFNvdW5kIHRvIGJlIHBsYXllZCB3aGVuIHRoaXMgQnV0dG9ucyBPdmVyIHN0YXRlIGlzIGFjdGl2YXRlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9uT3ZlclNvdW5kID0gbnVsbDsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNvdW5kfSBvbk91dFNvdW5kIC0gVGhlIFNvdW5kIHRvIGJlIHBsYXllZCB3aGVuIHRoaXMgQnV0dG9ucyBPdXQgc3RhdGUgaXMgYWN0aXZhdGVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub25PdXRTb3VuZCA9IG51bGw7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Tb3VuZH0gb25Eb3duU291bmQgLSBUaGUgU291bmQgdG8gYmUgcGxheWVkIHdoZW4gdGhpcyBCdXR0b25zIERvd24gc3RhdGUgaXMgYWN0aXZhdGVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub25Eb3duU291bmQgPSBudWxsOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU291bmR9IG9uVXBTb3VuZCAtIFRoZSBTb3VuZCB0byBiZSBwbGF5ZWQgd2hlbiB0aGlzIEJ1dHRvbnMgVXAgc3RhdGUgaXMgYWN0aXZhdGVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub25VcFNvdW5kID0gbnVsbDsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBvbk92ZXJTb3VuZE1hcmtlciAtIFRoZSBTb3VuZCBNYXJrZXIgdXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHRoZSBvbk92ZXJTb3VuZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9uT3ZlclNvdW5kTWFya2VyID0gJyc7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge3N0cmluZ30gb25PdXRTb3VuZE1hcmtlciAtIFRoZSBTb3VuZCBNYXJrZXIgdXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHRoZSBvbk91dFNvdW5kLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub25PdXRTb3VuZE1hcmtlciA9ICcnOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG9uRG93blNvdW5kTWFya2VyIC0gVGhlIFNvdW5kIE1hcmtlciB1c2VkIGluIGNvbmp1bmN0aW9uIHdpdGggdGhlIG9uRG93blNvdW5kLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub25Eb3duU291bmRNYXJrZXIgPSAnJzsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBvblVwU291bmRNYXJrZXIgLSBUaGUgU291bmQgTWFya2VyIHVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB0aGUgb25VcFNvdW5kLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub25VcFNvdW5kTWFya2VyID0gJyc7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uSW5wdXRPdmVyIC0gVGhlIFNpZ25hbCAob3IgZXZlbnQpIGRpc3BhdGNoZWQgd2hlbiB0aGlzIEJ1dHRvbiBpcyBpbiBhbiBPdmVyIHN0YXRlLgogICAgKi8KICAgIHRoaXMub25JbnB1dE92ZXIgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25JbnB1dE91dCAtIFRoZSBTaWduYWwgKG9yIGV2ZW50KSBkaXNwYXRjaGVkIHdoZW4gdGhpcyBCdXR0b24gaXMgaW4gYW4gT3V0IHN0YXRlLgogICAgKi8KICAgIHRoaXMub25JbnB1dE91dCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbklucHV0RG93biAtIFRoZSBTaWduYWwgKG9yIGV2ZW50KSBkaXNwYXRjaGVkIHdoZW4gdGhpcyBCdXR0b24gaXMgaW4gYW4gRG93biBzdGF0ZS4KICAgICovCiAgICB0aGlzLm9uSW5wdXREb3duID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIAogICAgLyoqIAogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uSW5wdXRVcCAtIFRoZSBTaWduYWwgKG9yIGV2ZW50KSBkaXNwYXRjaGVkIHdoZW4gdGhpcyBCdXR0b24gaXMgaW4gYW4gVXAgc3RhdGUuCiAgICAqLwogICAgdGhpcy5vbklucHV0VXAgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtib29sZWFufSBmcmVlemVGcmFtZXMgLSBXaGVuIHRydWUgdGhlIEJ1dHRvbiB3aWxsIGNlYXNlIHRvIGNoYW5nZSB0ZXh0dXJlIGZyYW1lIG9uIGFsbCBldmVudHMgKG92ZXIsIG91dCwgdXAsIGRvd24pLgogICAgKi8KICAgIHRoaXMuZnJlZXplRnJhbWVzID0gZmFsc2U7CgogICAgLyoqCiAgICAqIFdoZW4gdGhlIEJ1dHRvbiBpcyB0b3VjaGVkIC8gY2xpY2tlZCBhbmQgdGhlbiByZWxlYXNlZCB5b3UgY2FuIGZvcmNlIGl0IHRvIGVudGVyIGEgc3RhdGUgb2YgIm91dCIgaW5zdGVhZCBvZiAidXAiLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZvcmNlT3V0CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5mb3JjZU91dCA9IGZhbHNlOwoKICAgIHRoaXMuc2V0RnJhbWVzKG92ZXJGcmFtZSwgb3V0RnJhbWUsIGRvd25GcmFtZSwgdXBGcmFtZSk7CgogICAgaWYgKGNhbGxiYWNrICE9PSBudWxsKQogICAgewogICAgICAgIHRoaXMub25JbnB1dFVwLmFkZChjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgIH0KCiAgICB0aGlzLmlucHV0LnN0YXJ0KDAsIHRydWUpOwoKICAgIC8vICBSZWRpcmVjdCB0aGUgaW5wdXQgZXZlbnRzIHRvIGhlcmUgc28gd2UgY2FuIGhhbmRsZSBhbmltYXRpb24gdXBkYXRlcywgZXRjCiAgICB0aGlzLmV2ZW50cy5vbklucHV0T3Zlci5hZGQodGhpcy5vbklucHV0T3ZlckhhbmRsZXIsIHRoaXMpOwogICAgdGhpcy5ldmVudHMub25JbnB1dE91dC5hZGQodGhpcy5vbklucHV0T3V0SGFuZGxlciwgdGhpcyk7CiAgICB0aGlzLmV2ZW50cy5vbklucHV0RG93bi5hZGQodGhpcy5vbklucHV0RG93bkhhbmRsZXIsIHRoaXMpOwogICAgdGhpcy5ldmVudHMub25JbnB1dFVwLmFkZCh0aGlzLm9uSW5wdXRVcEhhbmRsZXIsIHRoaXMpOwoKfTsKClBoYXNlci5CdXR0b24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSk7ClBoYXNlci5CdXR0b24ucHJvdG90eXBlID0gUGhhc2VyLlV0aWxzLmV4dGVuZCh0cnVlLCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZSwgUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsIFBJWEkuU3ByaXRlLnByb3RvdHlwZSk7ClBoYXNlci5CdXR0b24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkJ1dHRvbjsKCi8qKgoqIENsZWFycyBhbGwgb2YgdGhlIGZyYW1lcyBzZXQgb24gdGhpcyBCdXR0b24uCioKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLmNsZWFyRnJhbWVzCiovClBoYXNlci5CdXR0b24ucHJvdG90eXBlLmNsZWFyRnJhbWVzID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuX29uT3ZlckZyYW1lTmFtZSA9IG51bGw7CiAgICB0aGlzLl9vbk92ZXJGcmFtZUlEID0gbnVsbDsKCiAgICB0aGlzLl9vbk91dEZyYW1lTmFtZSA9IG51bGw7CiAgICB0aGlzLl9vbk91dEZyYW1lSUQgPSBudWxsOwoKICAgIHRoaXMuX29uRG93bkZyYW1lTmFtZSA9IG51bGw7CiAgICB0aGlzLl9vbkRvd25GcmFtZUlEID0gbnVsbDsKCiAgICB0aGlzLl9vblVwRnJhbWVOYW1lID0gbnVsbDsKICAgIHRoaXMuX29uVXBGcmFtZUlEID0gbnVsbDsKCn0KCi8qKgoqIFVzZWQgdG8gbWFudWFsbHkgc2V0IHRoZSBmcmFtZXMgdGhhdCB3aWxsIGJlIHVzZWQgZm9yIHRoZSBkaWZmZXJlbnQgc3RhdGVzIG9mIHRoZSBCdXR0b24uCioKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldEZyYW1lcwoqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW292ZXJGcmFtZV0gLSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGFuIG92ZXIgc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbb3V0RnJhbWVdIC0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhbiBvdXQgc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbZG93bkZyYW1lXSAtIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYSBkb3duIHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgoqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW3VwRnJhbWVdIC0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhbiB1cCBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0RnJhbWVzID0gZnVuY3Rpb24gKG92ZXJGcmFtZSwgb3V0RnJhbWUsIGRvd25GcmFtZSwgdXBGcmFtZSkgewoKICAgIHRoaXMuY2xlYXJGcmFtZXMoKTsKCiAgICBpZiAob3ZlckZyYW1lICE9PSBudWxsKQogICAgewogICAgICAgIGlmICh0eXBlb2Ygb3ZlckZyYW1lID09PSAnc3RyaW5nJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uT3ZlckZyYW1lTmFtZSA9IG92ZXJGcmFtZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LnBvaW50ZXJPdmVyKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZnJhbWVOYW1lID0gb3ZlckZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uT3ZlckZyYW1lSUQgPSBvdmVyRnJhbWU7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5wb2ludGVyT3ZlcigpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lID0gb3ZlckZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGlmIChvdXRGcmFtZSAhPT0gbnVsbCkKICAgIHsKICAgICAgICBpZiAodHlwZW9mIG91dEZyYW1lID09PSAnc3RyaW5nJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uT3V0RnJhbWVOYW1lID0gb3V0RnJhbWU7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5wb2ludGVyT3ZlcigpID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSBvdXRGcmFtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9vbk91dEZyYW1lSUQgPSBvdXRGcmFtZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LnBvaW50ZXJPdmVyKCkgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lID0gb3V0RnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaWYgKGRvd25GcmFtZSAhPT0gbnVsbCkKICAgIHsKICAgICAgICBpZiAodHlwZW9mIGRvd25GcmFtZSA9PT0gJ3N0cmluZycpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9vbkRvd25GcmFtZU5hbWUgPSBkb3duRnJhbWU7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5wb2ludGVyRG93bigpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IGRvd25GcmFtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9vbkRvd25GcmFtZUlEID0gZG93bkZyYW1lOwoKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQucG9pbnRlckRvd24oKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5mcmFtZSA9IGRvd25GcmFtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpZiAodXBGcmFtZSAhPT0gbnVsbCkKICAgIHsKICAgICAgICBpZiAodHlwZW9mIHVwRnJhbWUgPT09ICdzdHJpbmcnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fb25VcEZyYW1lTmFtZSA9IHVwRnJhbWU7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5wb2ludGVyVXAoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSB1cEZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uVXBGcmFtZUlEID0gdXBGcmFtZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LnBvaW50ZXJVcCgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lID0gdXBGcmFtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCn07CgovKioKKiBTZXRzIHRoZSBzb3VuZHMgdG8gYmUgcGxheWVkIHdoZW5ldmVyIHRoaXMgQnV0dG9uIGlzIGludGVyYWN0ZWQgd2l0aC4gU291bmRzIGNhbiBiZSBlaXRoZXIgZnVsbCBTb3VuZCBvYmplY3RzLCBvciBtYXJrZXJzIHBvaW50aW5nIHRvIGEgc2VjdGlvbiBvZiBhIFNvdW5kIG9iamVjdC4KKiBUaGUgbW9zdCBjb21tb24gZm9ybXMgb2Ygc291bmRzIGFyZSAnaG92ZXInIGVmZmVjdHMgYW5kICdjbGljaycgZWZmZWN0cywgd2hpY2ggaXMgd2h5IHRoZSBvcmRlciBvZiB0aGUgcGFyYW1ldGVycyBpcyBvdmVyU291bmQgdGhlbiBkb3duU291bmQuCiogQ2FsbCB0aGlzIGZ1bmN0aW9uIHdpdGggbm8gcGFyYW1ldGVycyBhdCBhbGwgdG8gcmVzZXQgYWxsIHNvdW5kcyBvbiB0aGlzIEJ1dHRvbi4KKgoqIEBtZXRob2QgUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0U291bmRzCiogQHBhcmFtIHtQaGFzZXIuU291bmR9IFtvdmVyU291bmRdIC0gT3ZlciBCdXR0b24gU291bmQuCiogQHBhcmFtIHtzdHJpbmd9IFtvdmVyTWFya2VyXSAtIE92ZXIgQnV0dG9uIFNvdW5kIE1hcmtlci4KKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gW2Rvd25Tb3VuZF0gLSBEb3duIEJ1dHRvbiBTb3VuZC4KKiBAcGFyYW0ge3N0cmluZ30gW2Rvd25NYXJrZXJdIC0gRG93biBCdXR0b24gU291bmQgTWFya2VyLgoqIEBwYXJhbSB7UGhhc2VyLlNvdW5kfSBbb3V0U291bmRdIC0gT3V0IEJ1dHRvbiBTb3VuZC4KKiBAcGFyYW0ge3N0cmluZ30gW291dE1hcmtlcl0gLSBPdXQgQnV0dG9uIFNvdW5kIE1hcmtlci4KKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gW3VwU291bmRdIC0gVXAgQnV0dG9uIFNvdW5kLgoqIEBwYXJhbSB7c3RyaW5nfSBbdXBNYXJrZXJdIC0gVXAgQnV0dG9uIFNvdW5kIE1hcmtlci4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0U291bmRzID0gZnVuY3Rpb24gKG92ZXJTb3VuZCwgb3Zlck1hcmtlciwgZG93blNvdW5kLCBkb3duTWFya2VyLCBvdXRTb3VuZCwgb3V0TWFya2VyLCB1cFNvdW5kLCB1cE1hcmtlcikgewoKICAgIHRoaXMuc2V0T3ZlclNvdW5kKG92ZXJTb3VuZCwgb3Zlck1hcmtlcik7CiAgICB0aGlzLnNldE91dFNvdW5kKG91dFNvdW5kLCBvdXRNYXJrZXIpOwogICAgdGhpcy5zZXREb3duU291bmQoZG93blNvdW5kLCBkb3duTWFya2VyKTsKICAgIHRoaXMuc2V0VXBTb3VuZCh1cFNvdW5kLCB1cE1hcmtlcik7Cgp9CgovKioKKiBUaGUgU291bmQgdG8gYmUgcGxheWVkIHdoZW4gYSBQb2ludGVyIG1vdmVzIG92ZXIgdGhpcyBCdXR0b24uCioKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldE92ZXJTb3VuZAoqIEBwYXJhbSB7UGhhc2VyLlNvdW5kfSBzb3VuZCAtIFRoZSBTb3VuZCB0aGF0IHdpbGwgYmUgcGxheWVkLgoqIEBwYXJhbSB7c3RyaW5nfSBbbWFya2VyXSAtIEEgU291bmQgTWFya2VyIHRoYXQgd2lsbCBiZSB1c2VkIGluIHRoZSBwbGF5YmFjay4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0T3ZlclNvdW5kID0gZnVuY3Rpb24gKHNvdW5kLCBtYXJrZXIpIHsKCiAgICB0aGlzLm9uT3ZlclNvdW5kID0gbnVsbDsKICAgIHRoaXMub25PdmVyU291bmRNYXJrZXIgPSAnJzsKCiAgICBpZiAoc291bmQgaW5zdGFuY2VvZiBQaGFzZXIuU291bmQpCiAgICB7CiAgICAgICAgdGhpcy5vbk92ZXJTb3VuZCA9IHNvdW5kOwogICAgfQoKICAgIGlmICh0eXBlb2YgbWFya2VyID09PSAnc3RyaW5nJykKICAgIHsKICAgICAgICB0aGlzLm9uT3ZlclNvdW5kTWFya2VyID0gbWFya2VyOwogICAgfQoKfQoKLyoqCiogVGhlIFNvdW5kIHRvIGJlIHBsYXllZCB3aGVuIGEgUG9pbnRlciBtb3ZlcyBvdXQgb2YgdGhpcyBCdXR0b24uCioKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldE91dFNvdW5kCiogQHBhcmFtIHtQaGFzZXIuU291bmR9IHNvdW5kIC0gVGhlIFNvdW5kIHRoYXQgd2lsbCBiZSBwbGF5ZWQuCiogQHBhcmFtIHtzdHJpbmd9IFttYXJrZXJdIC0gQSBTb3VuZCBNYXJrZXIgdGhhdCB3aWxsIGJlIHVzZWQgaW4gdGhlIHBsYXliYWNrLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRPdXRTb3VuZCA9IGZ1bmN0aW9uIChzb3VuZCwgbWFya2VyKSB7CgogICAgdGhpcy5vbk91dFNvdW5kID0gbnVsbDsKICAgIHRoaXMub25PdXRTb3VuZE1hcmtlciA9ICcnOwoKICAgIGlmIChzb3VuZCBpbnN0YW5jZW9mIFBoYXNlci5Tb3VuZCkKICAgIHsKICAgICAgICB0aGlzLm9uT3V0U291bmQgPSBzb3VuZDsKICAgIH0KCiAgICBpZiAodHlwZW9mIG1hcmtlciA9PT0gJ3N0cmluZycpCiAgICB7CiAgICAgICAgdGhpcy5vbk91dFNvdW5kTWFya2VyID0gbWFya2VyOwogICAgfQoKfQoKLyoqCiogVGhlIFNvdW5kIHRvIGJlIHBsYXllZCB3aGVuIGEgUG9pbnRlciBwcmVzc2VzIGRvd24gb24gdGhpcyBCdXR0b24uCioKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldERvd25Tb3VuZAoqIEBwYXJhbSB7UGhhc2VyLlNvdW5kfSBzb3VuZCAtIFRoZSBTb3VuZCB0aGF0IHdpbGwgYmUgcGxheWVkLgoqIEBwYXJhbSB7c3RyaW5nfSBbbWFya2VyXSAtIEEgU291bmQgTWFya2VyIHRoYXQgd2lsbCBiZSB1c2VkIGluIHRoZSBwbGF5YmFjay4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0RG93blNvdW5kID0gZnVuY3Rpb24gKHNvdW5kLCBtYXJrZXIpIHsKCiAgICB0aGlzLm9uRG93blNvdW5kID0gbnVsbDsKICAgIHRoaXMub25Eb3duU291bmRNYXJrZXIgPSAnJzsKCiAgICBpZiAoc291bmQgaW5zdGFuY2VvZiBQaGFzZXIuU291bmQpCiAgICB7CiAgICAgICAgdGhpcy5vbkRvd25Tb3VuZCA9IHNvdW5kOwogICAgfQoKICAgIGlmICh0eXBlb2YgbWFya2VyID09PSAnc3RyaW5nJykKICAgIHsKICAgICAgICB0aGlzLm9uRG93blNvdW5kTWFya2VyID0gbWFya2VyOwogICAgfQoKfQoKLyoqCiogVGhlIFNvdW5kIHRvIGJlIHBsYXllZCB3aGVuIGEgUG9pbnRlciBoYXMgcHJlc3NlZCBkb3duIGFuZCBpcyByZWxlYXNlZCBmcm9tIHRoaXMgQnV0dG9uLgoqCiogQG1ldGhvZCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRVcFNvdW5kCiogQHBhcmFtIHtQaGFzZXIuU291bmR9IHNvdW5kIC0gVGhlIFNvdW5kIHRoYXQgd2lsbCBiZSBwbGF5ZWQuCiogQHBhcmFtIHtzdHJpbmd9IFttYXJrZXJdIC0gQSBTb3VuZCBNYXJrZXIgdGhhdCB3aWxsIGJlIHVzZWQgaW4gdGhlIHBsYXliYWNrLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRVcFNvdW5kID0gZnVuY3Rpb24gKHNvdW5kLCBtYXJrZXIpIHsKCiAgICB0aGlzLm9uVXBTb3VuZCA9IG51bGw7CiAgICB0aGlzLm9uVXBTb3VuZE1hcmtlciA9ICcnOwoKICAgIGlmIChzb3VuZCBpbnN0YW5jZW9mIFBoYXNlci5Tb3VuZCkKICAgIHsKICAgICAgICB0aGlzLm9uVXBTb3VuZCA9IHNvdW5kOwogICAgfQoKICAgIGlmICh0eXBlb2YgbWFya2VyID09PSAnc3RyaW5nJykKICAgIHsKICAgICAgICB0aGlzLm9uVXBTb3VuZE1hcmtlciA9IG1hcmtlcjsKICAgIH0KCn0KCi8qKgoqIEludGVybmFsIGZ1bmN0aW9uIHRoYXQgaGFuZGxlcyBpbnB1dCBldmVudHMuCioKKiBAcHJvdGVjdGVkCiogQG1ldGhvZCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0T3ZlckhhbmRsZXIKKiBAcGFyYW0ge1BoYXNlci5CdXR0b259IHNwcml0ZSAtIFRoZSBCdXR0b24gdGhhdCB0aGUgZXZlbnQgb2NjdXJlZCBvbi4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyIC0gVGhlIFBvaW50ZXIgdGhhdCBhY3RpdmF0ZWQgdGhlIEJ1dHRvbi4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUub25JbnB1dE92ZXJIYW5kbGVyID0gZnVuY3Rpb24gKHNwcml0ZSwgcG9pbnRlcikgewoKICAgIGlmICh0aGlzLmZyZWV6ZUZyYW1lcyA9PT0gZmFsc2UpCiAgICB7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSgxKTsKICAgIH0KCiAgICBpZiAodGhpcy5vbk92ZXJTb3VuZCkKICAgIHsKICAgICAgICB0aGlzLm9uT3ZlclNvdW5kLnBsYXkodGhpcy5vbk92ZXJTb3VuZE1hcmtlcik7CiAgICB9CgogICAgaWYgKHRoaXMub25JbnB1dE92ZXIpCiAgICB7CiAgICAgICAgdGhpcy5vbklucHV0T3Zlci5kaXNwYXRjaCh0aGlzLCBwb2ludGVyKTsKICAgIH0KfTsKCi8qKgoqIEludGVybmFsIGZ1bmN0aW9uIHRoYXQgaGFuZGxlcyBpbnB1dCBldmVudHMuCioKKiBAcHJvdGVjdGVkCiogQG1ldGhvZCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0T3ZlckhhbmRsZXIKKiBAcGFyYW0ge1BoYXNlci5CdXR0b259IHNwcml0ZSAtIFRoZSBCdXR0b24gdGhhdCB0aGUgZXZlbnQgb2NjdXJlZCBvbi4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyIC0gVGhlIFBvaW50ZXIgdGhhdCBhY3RpdmF0ZWQgdGhlIEJ1dHRvbi4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUub25JbnB1dE91dEhhbmRsZXIgPSBmdW5jdGlvbiAoc3ByaXRlLCBwb2ludGVyKSB7CgogICAgaWYgKHRoaXMuZnJlZXplRnJhbWVzID09PSBmYWxzZSkKICAgIHsKICAgICAgICB0aGlzLnNldFN0YXRlKDIpOwogICAgfQoKICAgIGlmICh0aGlzLm9uT3V0U291bmQpCiAgICB7CiAgICAgICAgdGhpcy5vbk91dFNvdW5kLnBsYXkodGhpcy5vbk91dFNvdW5kTWFya2VyKTsKICAgIH0KCiAgICBpZiAodGhpcy5vbklucHV0T3V0KQogICAgewogICAgICAgIHRoaXMub25JbnB1dE91dC5kaXNwYXRjaCh0aGlzLCBwb2ludGVyKTsKICAgIH0KfTsKCi8qKgoqIEludGVybmFsIGZ1bmN0aW9uIHRoYXQgaGFuZGxlcyBpbnB1dCBldmVudHMuCioKKiBAcHJvdGVjdGVkCiogQG1ldGhvZCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0T3ZlckhhbmRsZXIKKiBAcGFyYW0ge1BoYXNlci5CdXR0b259IHNwcml0ZSAtIFRoZSBCdXR0b24gdGhhdCB0aGUgZXZlbnQgb2NjdXJlZCBvbi4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyIC0gVGhlIFBvaW50ZXIgdGhhdCBhY3RpdmF0ZWQgdGhlIEJ1dHRvbi4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUub25JbnB1dERvd25IYW5kbGVyID0gZnVuY3Rpb24gKHNwcml0ZSwgcG9pbnRlcikgewoKICAgIGlmICh0aGlzLmZyZWV6ZUZyYW1lcyA9PT0gZmFsc2UpCiAgICB7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSgzKTsKICAgIH0KCiAgICBpZiAodGhpcy5vbkRvd25Tb3VuZCkKICAgIHsKICAgICAgICB0aGlzLm9uRG93blNvdW5kLnBsYXkodGhpcy5vbkRvd25Tb3VuZE1hcmtlcik7CiAgICB9CgogICAgaWYgKHRoaXMub25JbnB1dERvd24pCiAgICB7CiAgICAgICAgdGhpcy5vbklucHV0RG93bi5kaXNwYXRjaCh0aGlzLCBwb2ludGVyKTsKICAgIH0KfTsKCi8qKgoqIEludGVybmFsIGZ1bmN0aW9uIHRoYXQgaGFuZGxlcyBpbnB1dCBldmVudHMuCioKKiBAcHJvdGVjdGVkCiogQG1ldGhvZCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0T3ZlckhhbmRsZXIKKiBAcGFyYW0ge1BoYXNlci5CdXR0b259IHNwcml0ZSAtIFRoZSBCdXR0b24gdGhhdCB0aGUgZXZlbnQgb2NjdXJlZCBvbi4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyIC0gVGhlIFBvaW50ZXIgdGhhdCBhY3RpdmF0ZWQgdGhlIEJ1dHRvbi4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUub25JbnB1dFVwSGFuZGxlciA9IGZ1bmN0aW9uIChzcHJpdGUsIHBvaW50ZXIsIGlzT3ZlcikgewoKICAgIGlmICh0aGlzLm9uVXBTb3VuZCkKICAgIHsKICAgICAgICB0aGlzLm9uVXBTb3VuZC5wbGF5KHRoaXMub25VcFNvdW5kTWFya2VyKTsKICAgIH0KCiAgICBpZiAodGhpcy5vbklucHV0VXApCiAgICB7CiAgICAgICAgdGhpcy5vbklucHV0VXAuZGlzcGF0Y2godGhpcywgcG9pbnRlciwgaXNPdmVyKTsKICAgIH0KCiAgICBpZiAodGhpcy5mcmVlemVGcmFtZXMpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh0aGlzLmZvcmNlT3V0KQogICAgewogICAgICAgIC8vICBCdXR0b24gc2hvdWxkIGJlIGZvcmNlZCB0byB0aGUgT3V0IGZyYW1lIHdoZW4gcmVsZWFzZWQuCiAgICAgICAgdGhpcy5zZXRTdGF0ZSgyKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBpZiAodGhpcy5fb25VcEZyYW1lTmFtZSB8fCB0aGlzLl9vblVwRnJhbWVJRCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoNCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc092ZXIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKDIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKfTsKCi8qKgoqIEludGVybmFsIGZ1bmN0aW9uIHRoYXQgaGFuZGxlcyBCdXR0b24gc3RhdGUgY2hhbmdlcy4KKgoqIEBwcm90ZWN0ZWQKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldFN0YXRlCiogQHBhcmFtIHtudW1iZXJ9IG5ld1N0YXRlIC0gVGhlIG5ldyBTdGF0ZSBvZiB0aGUgQnV0dG9uLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uIChuZXdTdGF0ZSkgewoKICAgIGlmIChuZXdTdGF0ZSA9PT0gMSkKICAgIHsKICAgICAgICAvLyAgT3ZlcgogICAgICAgIGlmICh0aGlzLl9vbk92ZXJGcmFtZU5hbWUgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWVOYW1lID0gdGhpcy5fb25PdmVyRnJhbWVOYW1lOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLl9vbk92ZXJGcmFtZUlEICE9IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZyYW1lID0gdGhpcy5fb25PdmVyRnJhbWVJRDsKICAgICAgICB9CiAgICB9CiAgICBlbHNlIGlmIChuZXdTdGF0ZSA9PT0gMikKICAgIHsKICAgICAgICAvLyAgT3V0CiAgICAgICAgaWYgKHRoaXMuX29uT3V0RnJhbWVOYW1lICE9IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IHRoaXMuX29uT3V0RnJhbWVOYW1lOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLl9vbk91dEZyYW1lSUQgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWUgPSB0aGlzLl9vbk91dEZyYW1lSUQ7CiAgICAgICAgfQogICAgfQogICAgZWxzZSBpZiAobmV3U3RhdGUgPT09IDMpCiAgICB7CiAgICAgICAgLy8gIERvd24KICAgICAgICBpZiAodGhpcy5fb25Eb3duRnJhbWVOYW1lICE9IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IHRoaXMuX29uRG93bkZyYW1lTmFtZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5fb25Eb3duRnJhbWVJRCAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZSA9IHRoaXMuX29uRG93bkZyYW1lSUQ7CiAgICAgICAgfQogICAgfQogICAgZWxzZSBpZiAobmV3U3RhdGUgPT09IDQpCiAgICB7CiAgICAgICAgLy8gIFVwCiAgICAgICAgaWYgKHRoaXMuX29uVXBGcmFtZU5hbWUgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWVOYW1lID0gdGhpcy5fb25VcEZyYW1lTmFtZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5fb25VcEZyYW1lSUQgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWUgPSB0aGlzLl9vblVwRnJhbWVJRDsKICAgICAgICB9CiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyBgR3JhcGhpY3NgIG9iamVjdC4KKiAKKiBAY2xhc3MgUGhhc2VyLkdyYXBoaWNzCiogQGNvbnN0cnVjdG9yCioKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyBncmFwaGljcyBvYmplY3QuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgZ3JhcGhpY3Mgb2JqZWN0LgoqLwpQaGFzZXIuR3JhcGhpY3MgPSBmdW5jdGlvbiAoZ2FtZSwgeCwgeSkgewoKICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgUElYSS5HcmFwaGljcy5jYWxsKHRoaXMpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIFRoZSBQaGFzZXIgT2JqZWN0IFR5cGUuCgkqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLkdSQVBISUNTOwoKICAgIHRoaXMucG9zaXRpb24ueCA9IHg7CiAgICB0aGlzLnBvc2l0aW9uLnkgPSB5OwoKfTsKClBoYXNlci5HcmFwaGljcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuR3JhcGhpY3MucHJvdG90eXBlKTsKUGhhc2VyLkdyYXBoaWNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5HcmFwaGljczsKCi8qKgoqIERlc3Ryb3kgdGhpcyBHcmFwaGljcyBpbnN0YW5jZS4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUucHJvdG90eXBlLmRlc3Ryb3kKKi8KUGhhc2VyLkdyYXBoaWNzLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgogICAgdGhpcy5jbGVhcigpOwoKICAgIGlmICh0aGlzLmdyb3VwKQogICAgewogICAgICAgIHRoaXMuZ3JvdXAucmVtb3ZlKHRoaXMpOwogICAgfQoKICAgIHRoaXMuZ2FtZSA9IG51bGw7Cgp9CgovKgoqIERyYXdzIGEge1BoYXNlci5Qb2x5Z29ufSBvciBhIHtQSVhJLlBvbHlnb259IGZpbGxlZAoqLwpQaGFzZXIuR3JhcGhpY3MucHJvdG90eXBlLmRyYXdQb2x5Z29uID0gZnVuY3Rpb24gKHBvbHkpIHsKCiAgICB0aGlzLm1vdmVUbyhwb2x5LnBvaW50c1swXS54LCBwb2x5LnBvaW50c1swXS55KTsKCiAgICBmb3IgKHZhciBpID0gMTsgaSA8IHBvbHkucG9pbnRzLmxlbmd0aDsgaSArPSAxKQogICAgewogICAgICAgIHRoaXMubGluZVRvKHBvbHkucG9pbnRzW2ldLngsIHBvbHkucG9pbnRzW2ldLnkpOwogICAgfQoKICAgIHRoaXMubGluZVRvKHBvbHkucG9pbnRzWzBdLngsIHBvbHkucG9pbnRzWzBdLnkpOwogICAgCn0KCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JhcGhpY3MucHJvdG90eXBlLCAnYW5nbGUnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGgud3JhcEFuZ2xlKFBoYXNlci5NYXRoLnJhZFRvRGVnKHRoaXMucm90YXRpb24pKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucm90YXRpb24gPSBQaGFzZXIuTWF0aC5kZWdUb1JhZChQaGFzZXIuTWF0aC53cmFwQW5nbGUodmFsdWUpKTsKICAgIH0KCn0pOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5HcmFwaGljcy5wcm90b3R5cGUsICd4JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb24ueDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucG9zaXRpb24ueCA9IHZhbHVlOwogICAgfQoKfSk7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyYXBoaWNzLnByb3RvdHlwZSwgJ3knLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5wb3NpdGlvbi55OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5wb3NpdGlvbi55ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgUmVuZGVyVGV4dHVyZSBpcyBhIHNwZWNpYWwgdGV4dHVyZSB0aGF0IGFsbG93cyBhbnkgZGlzcGxheU9iamVjdCB0byBiZSByZW5kZXJlZCB0byBpdC4KKiBAY2xhc3MgUGhhc2VyLlJlbmRlclRleHR1cmUKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSByZW5kZXIgdGV4dHVyZS4KKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSB0aGUgd2lkdGggb2YgdGhlIHJlbmRlciB0ZXh0dXJlLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSB0aGUgaGVpZ2h0IG9mIHRoZSByZW5kZXIgdGV4dHVyZS4KKi8KUGhhc2VyLlJlbmRlclRleHR1cmUgPSBmdW5jdGlvbiAoZ2FtZSwga2V5LCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4gCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgb2JqZWN0LiAKICAgICovCiAgICB0aGlzLm5hbWUgPSBrZXk7CgogICAgUElYSS5FdmVudFRhcmdldC5jYWxsKHRoaXMpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSB0aGUgd2lkdGguIAogICAgKi8KICAgIHRoaXMud2lkdGggPSB3aWR0aCB8fCAxMDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gdGhlIGhlaWdodC4gCiAgICAqLwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQgfHwgMTAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BJWEkubWF0M30gaW5kZXRpdHlNYXRyaXggLSBNYXRyaXggb2JqZWN0LiAKICAgICovCiAgICB0aGlzLmluZGV0aXR5TWF0cml4ID0gUElYSS5tYXQzLmNyZWF0ZSgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BJWEkuUmVjdGFuZ2xlfSBmcmFtZSAtIFRoZSBmcmFtZSBmb3IgdGhpcyB0ZXh0dXJlLiAKICAgICovCiAgICB0aGlzLmZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBCYXNlIFBoYXNlciBvYmplY3QgdHlwZS4gCiAgICAqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLlJFTkRFUlRFWFRVUkU7CgogICAgdGhpcy5fdGVtcFBvaW50ID0geyB4OiAwLCB5OiAwIH07CgogICAgaWYgKFBJWEkuZ2wpCiAgICB7CiAgICAgICAgdGhpcy5pbml0V2ViR0woKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLmluaXRDYW52YXMoKTsKICAgIH0KICAgIAp9OwoKUGhhc2VyLlJlbmRlclRleHR1cmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLlRleHR1cmUucHJvdG90eXBlKTsKUGhhc2VyLlJlbmRlclRleHR1cmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5SZW5kZXJUZXh0dXJlOwoKLyoqCiogVGhpcyBmdW5jdGlvbiB3aWxsIGRyYXcgdGhlIGRpc3BsYXkgb2JqZWN0IHRvIHRoZSB0ZXh0dXJlLiBJZiB0aGUgZGlzcGxheSBvYmplY3QgaXMgYSBHcm91cCBvciBoYXMgY2hpbGRyZW4gaXQgd2lsbAoqIGRyYXcgYWxsIGNoaWxkcmVuIGFzIHdlbGwuCiogCiogQG1ldGhvZCBQaGFzZXIuUmVuZGVyVGV4dHVyZSNyZW5kZXIKKiBAbWVtYmVyb2YgUGhhc2VyLlJlbmRlclRleHR1cmUKKiBAcGFyYW0ge0Rpc3BsYXlPYmplY3R9IGRpc3BsYXlPYmplY3QgLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gcmVuZGVyIHRoaXMgdGV4dHVyZSBvbi4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW3Bvc2l0aW9uXSAtIFdoZXJlIHRvIGRyYXcgdGhlIGRpc3BsYXkgb2JqZWN0LgoqIEBwYXJhbSB7Ym9vbGVhbn0gW2NsZWFyPWZhbHNlXSAtIElmIHRydWUgdGhlIHRleHR1cmUgd2lsbCBiZSBjbGVhcmVkIGJlZm9yZSB0aGUgZGlzcGxheU9iamVjdCBpcyBkcmF3bi4KKiBAcGFyYW0ge2Jvb2xlYW59IFtyZW5kZXJIaWRkZW49ZmFsc2VdIC0gSWYgdHJ1ZSBkaXNwbGF5T2JqZWN0cyB0aGF0IGhhdmUgdGhlaXIgdmlzaWJsZSBwcm9wZXJ0eSBzZXQgdG8gZmFsc2Ugd2lsbCBzdGlsbCBiZSByZW5kZXJlZC4KKi8KUGhhc2VyLlJlbmRlclRleHR1cmUucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QsIHBvc2l0aW9uLCBjbGVhciwgcmVuZGVySGlkZGVuKSB7CgogICAgaWYgKHR5cGVvZiBwb3NpdGlvbiA9PT0gJ3VuZGVmaW5lZCcpIHsgcG9zaXRpb24gPSBmYWxzZTsgfQogICAgaWYgKHR5cGVvZiBjbGVhciA9PT0gJ3VuZGVmaW5lZCcpIHsgY2xlYXIgPSBmYWxzZTsgfQogICAgaWYgKHR5cGVvZiByZW5kZXJIaWRkZW4gPT09ICd1bmRlZmluZWQnKSB7IHJlbmRlckhpZGRlbiA9IGZhbHNlOyB9CgogICAgaWYgKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQaGFzZXIuR3JvdXApCiAgICB7CiAgICAgICAgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuX2NvbnRhaW5lcjsKICAgIH0KCiAgICBpZiAoUElYSS5nbCkKICAgIHsKICAgICAgICB0aGlzLnJlbmRlcldlYkdMKGRpc3BsYXlPYmplY3QsIHBvc2l0aW9uLCBjbGVhciwgcmVuZGVySGlkZGVuKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLnJlbmRlckNhbnZhcyhkaXNwbGF5T2JqZWN0LCBwb3NpdGlvbiwgY2xlYXIsIHJlbmRlckhpZGRlbik7CiAgICB9Cgp9CgovKioKKiBUaGlzIGZ1bmN0aW9uIHdpbGwgZHJhdyB0aGUgZGlzcGxheSBvYmplY3QgdG8gdGhlIHRleHR1cmUgYXQgdGhlIGdpdmVuIHgveSBjb29yZGluYXRlcy4KKiBJZiB0aGUgZGlzcGxheSBvYmplY3QgaXMgYSBHcm91cCBvciBoYXMgY2hpbGRyZW4gaXQgd2lsbCBkcmF3IGFsbCBjaGlsZHJlbiBhcyB3ZWxsLgoqCiogQG1ldGhvZCBQaGFzZXIuUmVuZGVyVGV4dHVyZSNyZW5kZXJYWQoqIEBtZW1iZXJvZiBQaGFzZXIuUmVuZGVyVGV4dHVyZQoqIEBwYXJhbSB7RGlzcGxheU9iamVjdH0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byByZW5kZXIgdGhpcyB0ZXh0dXJlIG9uLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSB0byBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdCBhdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgdG8gZHJhdyB0aGUgZGlzcGxheSBvYmplY3QgYXQuCiogQHBhcmFtIHtib29sZWFufSBbY2xlYXI9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgdGV4dHVyZSB3aWxsIGJlIGNsZWFyZWQgYmVmb3JlIHRoZSBkaXNwbGF5T2JqZWN0IGlzIGRyYXduLgoqIEBwYXJhbSB7Ym9vbGVhbn0gW3JlbmRlckhpZGRlbj1mYWxzZV0gLSBJZiB0cnVlIGRpc3BsYXlPYmplY3RzIHRoYXQgaGF2ZSB0aGVpciB2aXNpYmxlIHByb3BlcnR5IHNldCB0byBmYWxzZSB3aWxsIHN0aWxsIGJlIHJlbmRlcmVkLgoqLwpQaGFzZXIuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUucmVuZGVyWFkgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0LCB4LCB5LCBjbGVhciwgcmVuZGVySGlkZGVuKSB7CgogICAgdGhpcy5fdGVtcFBvaW50LnggPSB4OwogICAgdGhpcy5fdGVtcFBvaW50LnkgPSB5OwoKICAgIHRoaXMucmVuZGVyKGRpc3BsYXlPYmplY3QsIHRoaXMuX3RlbXBQb2ludCwgY2xlYXIsIHJlbmRlckhpZGRlbik7Cgp9CgovKioKKiBJbml0aWFsaXplcyB0aGUgd2ViZ2wgZGF0YSBmb3IgdGhpcyB0ZXh0dXJlCioKKiBAbWV0aG9kIFBoYXNlci5SZW5kZXJUZXh0dXJlI2luaXRXZWJHTAoqIEBtZW1iZXJvZiBQaGFzZXIuUmVuZGVyVGV4dHVyZQoqIEBwcml2YXRlCiovClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5pbml0V2ViR0wgPSBmdW5jdGlvbigpIHsKCiAgICB2YXIgZ2wgPSBQSVhJLmdsOwogICAgdGhpcy5nbEZyYW1lYnVmZmVyID0gZ2wuY3JlYXRlRnJhbWVidWZmZXIoKTsKCiAgICBnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHRoaXMuZ2xGcmFtZWJ1ZmZlciApOwoKICAgIHRoaXMuZ2xGcmFtZWJ1ZmZlci53aWR0aCA9IHRoaXMud2lkdGg7CiAgICB0aGlzLmdsRnJhbWVidWZmZXIuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CgogICAgdGhpcy5iYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKCk7CgogICAgdGhpcy5iYXNlVGV4dHVyZS53aWR0aCA9IHRoaXMud2lkdGg7CiAgICB0aGlzLmJhc2VUZXh0dXJlLmhlaWdodCA9IHRoaXMuaGVpZ2h0OwoKICAgIHRoaXMuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSA9IGdsLmNyZWF0ZVRleHR1cmUoKTsKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRoaXMuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CgogICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCAgdGhpcy53aWR0aCwgIHRoaXMuaGVpZ2h0LCAwLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKTsKCiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUFHX0ZJTFRFUiwgZ2wuTElORUFSKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBnbC5MSU5FQVIpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5DTEFNUF9UT19FREdFKTsKCiAgICB0aGlzLmJhc2VUZXh0dXJlLmlzUmVuZGVyID0gdHJ1ZTsKCiAgICBnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHRoaXMuZ2xGcmFtZWJ1ZmZlciApOwogICAgZ2wuZnJhbWVidWZmZXJUZXh0dXJlMkQoZ2wuRlJBTUVCVUZGRVIsIGdsLkNPTE9SX0FUVEFDSE1FTlQwLCBnbC5URVhUVVJFXzJELCB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUsIDApOwoKICAgIC8vIGNyZWF0ZSBhIHByb2plY3Rpb24gbWF0cml4Li4KICAgIHRoaXMucHJvamVjdGlvbiA9IG5ldyBQSVhJLlBvaW50KHRoaXMud2lkdGgvMiAsIC10aGlzLmhlaWdodC8yKTsKCiAgICAvLyBzZXQgdGhlIGNvcnJlY3QgcmVuZGVyIGZ1bmN0aW9uLi4KICAgIC8vIHRoaXMucmVuZGVyID0gdGhpcy5yZW5kZXJXZWJHTDsKfQoKLyoqCiogUmVzaXplcyB0aGUgUmVuZGVyVGV4dHVyZS4KKgoqIEBtZXRob2QgUGhhc2VyLlJlbmRlclRleHR1cmUjcmVzaXplCiogQG1lbWJlcm9mIFBoYXNlci5SZW5kZXJUZXh0dXJlCiovClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KQp7CgogICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAKICAgIGlmKFBJWEkuZ2wpCiAgICB7CiAgICAgICAgdGhpcy5wcm9qZWN0aW9uLnggPSB0aGlzLndpZHRoLzIKICAgICAgICB0aGlzLnByb2plY3Rpb24ueSA9IC10aGlzLmhlaWdodC8yOwogICAgCiAgICAgICAgdmFyIGdsID0gUElYSS5nbDsKICAgICAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpOwogICAgICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgIHRoaXMud2lkdGgsICB0aGlzLmhlaWdodCwgMCwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgbnVsbCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgCiAgICAgICAgdGhpcy5mcmFtZS53aWR0aCA9IHRoaXMud2lkdGgKICAgICAgICB0aGlzLmZyYW1lLmhlaWdodCA9IHRoaXMuaGVpZ2h0OwogICAgICAgIHRoaXMucmVuZGVyZXIucmVzaXplKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKICAgIH0KfQoKLyoqCiogSW5pdGlhbGl6ZXMgdGhlIGNhbnZhcyBkYXRhIGZvciB0aGlzIHRleHR1cmUKKgoqIEBtZXRob2QgUGhhc2VyLlJlbmRlclRleHR1cmUjaW5pdENhbnZhcwoqIEBtZW1iZXJvZiBQaGFzZXIuUmVuZGVyVGV4dHVyZQoqIEBwcml2YXRlCiovClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5pbml0Q2FudmFzID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLnJlbmRlcmVyID0gbmV3IFBJWEkuQ2FudmFzUmVuZGVyZXIodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQsIG51bGwsIDApOwoKICAgIHRoaXMuYmFzZVRleHR1cmUgPSBuZXcgUElYSS5CYXNlVGV4dHVyZSh0aGlzLnJlbmRlcmVyLnZpZXcpOwogICAgdGhpcy5mcmFtZSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgogICAgLy8gdGhpcy5yZW5kZXIgPSB0aGlzLnJlbmRlckNhbnZhczsKfQoKLyoqCiogVGhpcyBmdW5jdGlvbiB3aWxsIGRyYXcgdGhlIGRpc3BsYXkgb2JqZWN0IHRvIHRoZSB0ZXh0dXJlLgoqCiogQG1ldGhvZCBQaGFzZXIuUmVuZGVyVGV4dHVyZSNyZW5kZXJXZWJHTAoqIEBtZW1iZXJvZiBQaGFzZXIuUmVuZGVyVGV4dHVyZQoqIEBwcml2YXRlCiogQHBhcmFtIHtEaXNwbGF5T2JqZWN0fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIHJlbmRlciB0aGlzIHRleHR1cmUgb24uCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtwb3NpdGlvbl0gLSBXaGVyZSB0byBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdC4KKiBAcGFyYW0ge2Jvb2xlYW59IFtjbGVhcj1mYWxzZV0gLSBJZiB0cnVlIHRoZSB0ZXh0dXJlIHdpbGwgYmUgY2xlYXJlZCBiZWZvcmUgdGhlIGRpc3BsYXlPYmplY3QgaXMgZHJhd24uCiogQHBhcmFtIHtib29sZWFufSBbcmVuZGVySGlkZGVuPWZhbHNlXSAtIElmIHRydWUgZGlzcGxheU9iamVjdHMgdGhhdCBoYXZlIHRoZWlyIHZpc2libGUgcHJvcGVydHkgc2V0IHRvIGZhbHNlIHdpbGwgc3RpbGwgYmUgcmVuZGVyZWQuCiovClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5yZW5kZXJXZWJHTCA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QsIHBvc2l0aW9uLCBjbGVhciwgcmVuZGVySGlkZGVuKQp7CiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIC8vIGVuYWJsZSB0aGUgYWxwaGEgY29sb3IgbWFzay4uCiAgICBnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7CgogICAgZ2wudmlld3BvcnQoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoKICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGhpcy5nbEZyYW1lYnVmZmVyICk7CgogICAgaWYgKGNsZWFyKQogICAgewogICAgICAgIGdsLmNsZWFyQ29sb3IoMCwwLDAsIDApOwogICAgICAgIGdsLmNsZWFyKGdsLkNPTE9SX0JVRkZFUl9CSVQpOwogICAgfQoKICAgIC8vIFRISVMgV0lMTCBNRVNTIFdJVEggSElUIFRFU1RJTkchCiAgICB2YXIgY2hpbGRyZW4gPSBkaXNwbGF5T2JqZWN0LmNoaWxkcmVuOwoKICAgIC8vVE9ETyAtPyBjcmVhdGUgYSBuZXcgb25lPz8/IGRvbnQgdGhpbmsgc28hCiAgICB2YXIgb3JpZ2luYWxXb3JsZFRyYW5zZm9ybSA9IGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm07CiAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtID0gUElYSS5tYXQzLmNyZWF0ZSgpOy8vc3RoaXMuaW5kZXRpdHlNYXRyaXg7CiAgICAvLyBtb2RpZnkgdG8gZmxpcC4uLgogICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs0XSA9IC0xOwogICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSA9IHRoaXMucHJvamVjdGlvbi55ICogLTI7CgogICAgaWYgKHBvc2l0aW9uKQogICAgewogICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0gPSBwb3NpdGlvbi54OwogICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0gLT0gcG9zaXRpb24ueTsKICAgIH0KICAgIAogICAgUElYSS52aXNpYmxlQ291bnQrKzsKICAgIGRpc3BsYXlPYmplY3QudmNvdW50ID0gUElYSS52aXNpYmxlQ291bnQ7CiAgICAKICAgIGZvciAodmFyIGkgPSAwLCBqID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgewogICAgICAgIGNoaWxkcmVuW2ldLnVwZGF0ZVRyYW5zZm9ybSgpOwogICAgfQoKICAgIHZhciByZW5kZXJHcm91cCA9IGRpc3BsYXlPYmplY3QuX19yZW5kZXJHcm91cDsKCiAgICBpZiAocmVuZGVyR3JvdXApCiAgICB7CiAgICAgICAgaWYgKGRpc3BsYXlPYmplY3QgPT0gcmVuZGVyR3JvdXAucm9vdCkKICAgICAgICB7CiAgICAgICAgICAgIHJlbmRlckdyb3VwLnJlbmRlcih0aGlzLnByb2plY3Rpb24sIHRoaXMuZ2xGcmFtZWJ1ZmZlcik7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJlbmRlckdyb3VwLnJlbmRlclNwZWNpZmljKGRpc3BsYXlPYmplY3QsIHRoaXMucHJvamVjdGlvbiwgdGhpcy5nbEZyYW1lYnVmZmVyKTsKICAgICAgICB9CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgaWYgKCF0aGlzLnJlbmRlckdyb3VwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJHcm91cCA9IG5ldyBQSVhJLldlYkdMUmVuZGVyR3JvdXAoZ2wpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5yZW5kZXJHcm91cC5zZXRSZW5kZXJhYmxlKGRpc3BsYXlPYmplY3QpOwogICAgICAgIHRoaXMucmVuZGVyR3JvdXAucmVuZGVyKHRoaXMucHJvamVjdGlvbiwgdGhpcy5nbEZyYW1lYnVmZmVyKTsKICAgIH0KICAgIAogICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybSA9IG9yaWdpbmFsV29ybGRUcmFuc2Zvcm07Cn0KCi8qKgogKiBUaGlzIGZ1bmN0aW9uIHdpbGwgZHJhdyB0aGUgZGlzcGxheSBvYmplY3QgdG8gdGhlIHRleHR1cmUuCiAqCiogQG1ldGhvZCBQaGFzZXIuUmVuZGVyVGV4dHVyZSNyZW5kZXJDYW52YXMKKiBAbWVtYmVyb2YgUGhhc2VyLlJlbmRlclRleHR1cmUKKiBAcHJpdmF0ZQoqIEBwYXJhbSB7RGlzcGxheU9iamVjdH0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byByZW5kZXIgdGhpcyB0ZXh0dXJlIG9uLgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbcG9zaXRpb25dIC0gV2hlcmUgdG8gZHJhdyB0aGUgZGlzcGxheSBvYmplY3QuCiogQHBhcmFtIHtib29sZWFufSBbY2xlYXI9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgdGV4dHVyZSB3aWxsIGJlIGNsZWFyZWQgYmVmb3JlIHRoZSBkaXNwbGF5T2JqZWN0IGlzIGRyYXduLgoqIEBwYXJhbSB7Ym9vbGVhbn0gW3JlbmRlckhpZGRlbj1mYWxzZV0gLSBJZiB0cnVlIGRpc3BsYXlPYmplY3RzIHRoYXQgaGF2ZSB0aGVpciB2aXNpYmxlIHByb3BlcnR5IHNldCB0byBmYWxzZSB3aWxsIHN0aWxsIGJlIHJlbmRlcmVkLgoqLwpQaGFzZXIuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUucmVuZGVyQ2FudmFzID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcG9zaXRpb24sIGNsZWFyLCByZW5kZXJIaWRkZW4pCnsKICAgIHZhciBjaGlsZHJlbiA9IGRpc3BsYXlPYmplY3QuY2hpbGRyZW47CgogICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybSA9IFBJWEkubWF0My5jcmVhdGUoKTsKICAgIAogICAgaWYgKHBvc2l0aW9uKQogICAgewogICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0gPSBwb3NpdGlvbi54OwogICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0gPSBwb3NpdGlvbi55OwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwLCBqID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgajsgaSsrKQogICAgewogICAgICAgIGNoaWxkcmVuW2ldLnVwZGF0ZVRyYW5zZm9ybSgpOwogICAgfQoKICAgIGlmIChjbGVhcikKICAgIHsKICAgICAgICB0aGlzLnJlbmRlcmVyLmNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKICAgIH0KCiAgICB0aGlzLnJlbmRlcmVyLnJlbmRlckRpc3BsYXlPYmplY3QoZGlzcGxheU9iamVjdCwgcmVuZGVySGlkZGVuKTsKICAgIAogICAgdGhpcy5yZW5kZXJlci5jb250ZXh0LnNldFRyYW5zZm9ybSgxLCAwLCAwLCAxLCAwLCAwKTsKCn0KCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBDYW52YXMgY2xhc3MgaGFuZGxlcyBldmVyeXRoaW5nIHJlbGF0ZWQgdG8gY3JlYXRpbmcgdGhlIGBjYW52YXNgIERPTSB0YWcgdGhhdCBQaGFzZXIgd2lsbCB1c2UsIGluY2x1ZGluZyBzdHlsZXMsIG9mZnNldCBhbmQgYXNwZWN0IHJhdGlvLgoqCiogQGNsYXNzIFBoYXNlci5DYW52YXMKKiBAc3RhdGljCiovClBoYXNlci5DYW52YXMgPSB7CgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBgY2FudmFzYCBET00gZWxlbWVudC4gVGhlIGVsZW1lbnQgaXMgbm90IGF1dG9tYXRpY2FsbHkgYWRkZWQgdG8gdGhlIGRvY3VtZW50LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW52YXMuY3JlYXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGg9MjU2XSAtIFRoZSB3aWR0aCBvZiB0aGUgY2FudmFzIGVsZW1lbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0PTI1Nl0gLSBUaGUgaGVpZ2h0IG9mIHRoZSBjYW52YXMgZWxlbWVudC4uCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbaWQ9JyddIC0gSWYgZ2l2ZW4gdGhpcyB3aWxsIGJlIHNldCBhcyB0aGUgSUQgb2YgdGhlIGNhbnZhcyBlbGVtZW50LCBvdGhlcndpc2Ugbm8gSUQgd2lsbCBiZSBzZXQuCiAgICAqIEByZXR1cm4ge0hUTUxDYW52YXNFbGVtZW50fSBUaGUgbmV3bHkgY3JlYXRlZCBjYW52YXMgZWxlbWVudC4KICAgICovCiAgICBjcmVhdGU6IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0LCBpZCkgewoKICAgICAgICB3aWR0aCA9IHdpZHRoIHx8IDI1NjsKICAgICAgICBoZWlnaHQgPSBoZWlnaHQgfHwgMjU2OwoKICAgICAgICB2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CgogICAgICAgIGlmICh0eXBlb2YgaWQgPT09ICdzdHJpbmcnKQogICAgICAgIHsKICAgICAgICAgICAgY2FudmFzLmlkID0gaWQ7CiAgICAgICAgfQoKICAgICAgICBjYW52YXMud2lkdGggPSB3aWR0aDsKICAgICAgICBjYW52YXMuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgICAgICBjYW52YXMuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CgogICAgICAgIHJldHVybiBjYW52YXM7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IHRoZSBET00gb2Zmc2V0IHZhbHVlcyBvZiBhbnkgZ2l2ZW4gZWxlbWVudAogICAgKiBAbWV0aG9kIFBoYXNlci5DYW52YXMuZ2V0T2Zmc2V0CiAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGVsZW1lbnQgLSBUaGUgdGFyZ2V0ZWQgZWxlbWVudCB0aGF0IHdlIHdhbnQgdG8gcmV0cmlldmUgdGhlIG9mZnNldC4KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtwb2ludF0gLSBUaGUgcG9pbnQgd2Ugd2FudCB0byB0YWtlIHRoZSB4L3kgdmFsdWVzIG9mIHRoZSBvZmZzZXQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gLSBBIHBvaW50IG9iamV0IHdpdGggdGhlIG9mZnNldFggYW5kIFkgYXMgaXRzIHByb3BlcnRpZXMuCiAgICAqLwogICAgZ2V0T2Zmc2V0OiBmdW5jdGlvbiAoZWxlbWVudCwgcG9pbnQpIHsKCiAgICAgICAgcG9pbnQgPSBwb2ludCB8fCBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgICAgIHZhciBib3ggPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIHZhciBjbGllbnRUb3AgPSBlbGVtZW50LmNsaWVudFRvcCB8fCBkb2N1bWVudC5ib2R5LmNsaWVudFRvcCB8fCAwOwogICAgICAgIHZhciBjbGllbnRMZWZ0ID0gZWxlbWVudC5jbGllbnRMZWZ0IHx8IGRvY3VtZW50LmJvZHkuY2xpZW50TGVmdCB8fCAwOwoKICAgICAgICAvLyAgV2l0aG91dCB0aGlzIGNoZWNrIENocm9tZSBpcyBub3cgdGhyb3dpbmcgY29uc29sZSB3YXJuaW5ncyBhYm91dCBzdHJpY3QgdnMuIHF1aXJrcyA6KAoKICAgICAgICB2YXIgc2Nyb2xsVG9wID0gMDsKICAgICAgICB2YXIgc2Nyb2xsTGVmdCA9IDA7CgogICAgICAgIGlmIChkb2N1bWVudC5jb21wYXRNb2RlID09PSAnQ1NTMUNvbXBhdCcpCiAgICAgICAgewogICAgICAgICAgICBzY3JvbGxUb3AgPSB3aW5kb3cucGFnZVlPZmZzZXQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCB8fCBlbGVtZW50LnNjcm9sbFRvcCB8fCAwOwogICAgICAgICAgICBzY3JvbGxMZWZ0ID0gd2luZG93LnBhZ2VYT2Zmc2V0IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0IHx8IGVsZW1lbnQuc2Nyb2xsTGVmdCB8fCAwOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBzY3JvbGxUb3AgPSB3aW5kb3cucGFnZVlPZmZzZXQgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgfHwgZWxlbWVudC5zY3JvbGxUb3AgfHwgMDsKICAgICAgICAgICAgc2Nyb2xsTGVmdCA9IHdpbmRvdy5wYWdlWE9mZnNldCB8fCBkb2N1bWVudC5ib2R5LnNjcm9sbExlZnQgfHwgZWxlbWVudC5zY3JvbGxMZWZ0IHx8IDA7CiAgICAgICAgfQoKICAgICAgICBwb2ludC54ID0gYm94LmxlZnQgKyBzY3JvbGxMZWZ0IC0gY2xpZW50TGVmdDsKICAgICAgICBwb2ludC55ID0gYm94LnRvcCArIHNjcm9sbFRvcCAtIGNsaWVudFRvcDsKCiAgICAgICAgcmV0dXJuIHBvaW50OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIGFzcGVjdCByYXRpbyBvZiB0aGUgZ2l2ZW4gY2FudmFzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW52YXMuZ2V0QXNwZWN0UmF0aW8KICAgICogQHBhcmFtIHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gVGhlIGNhbnZhcyB0byBnZXQgdGhlIGFzcGVjdCByYXRpbyBmcm9tLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSByYXRpbyBiZXR3ZWVuIGNhbnZhcycgd2lkdGggYW5kIGhlaWdodC4KICAgICovCiAgICBnZXRBc3BlY3RSYXRpbzogZnVuY3Rpb24gKGNhbnZhcykgewogICAgICAgIHJldHVybiBjYW52YXMud2lkdGggLyBjYW52YXMuaGVpZ2h0OwogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgYmFja2dyb3VuZCBjb2xvciBiZWhpbmQgdGhlIGNhbnZhcy4gVGhpcyBjaGFuZ2VzIHRoZSBjYW52YXMgc3R5bGUgcHJvcGVydHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5zZXRCYWNrZ3JvdW5kQ29sb3IKICAgICogQHBhcmFtIHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gVGhlIGNhbnZhcyB0byBzZXQgdGhlIGJhY2tncm91bmQgY29sb3Igb24uCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JdIC0gVGhlIGNvbG9yIHRvIHNldC4gQ2FuIGJlIGluIHRoZSBmb3JtYXQgJ3JnYihyLGcsYiknLCBvciAnI1JSR0dCQicgb3IgYW55IHZhbGlkIENTUyBjb2xvci4KICAgICogQHJldHVybiB7SFRNTENhbnZhc0VsZW1lbnR9IFJldHVybnMgdGhlIHNvdXJjZSBjYW52YXMuCiAgICAqLwogICAgc2V0QmFja2dyb3VuZENvbG9yOiBmdW5jdGlvbiAoY2FudmFzLCBjb2xvcikgewoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMCwwLDApJzsKCiAgICAgICAgY2FudmFzLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yOwogICAgICAgIAogICAgICAgIHJldHVybiBjYW52YXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgdG91Y2gtYWN0aW9uIHByb3BlcnR5IG9uIHRoZSBjYW52YXMgc3R5bGUuIENhbiBiZSB1c2VkIHRvIGRpc2FibGUgZGVmYXVsdCBicm93c2VyIHRvdWNoIGFjdGlvbnMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5zZXRUb3VjaEFjdGlvbgogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgY2FudmFzIHRvIHNldCB0aGUgdG91Y2ggYWN0aW9uIG9uLgogICAgKiBAcGFyYW0ge1N0cmluZ30gW3ZhbHVlXSAtIFRoZSB0b3VjaCBhY3Rpb24gdG8gc2V0LiBEZWZhdWx0cyB0byAnbm9uZScuCiAgICAqIEByZXR1cm4ge0hUTUxDYW52YXNFbGVtZW50fSBUaGUgc291cmNlIGNhbnZhcy4KICAgICovCiAgICBzZXRUb3VjaEFjdGlvbjogZnVuY3Rpb24gKGNhbnZhcywgdmFsdWUpIHsKCiAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCAnbm9uZSc7CgogICAgICAgIGNhbnZhcy5zdHlsZS5tc1RvdWNoQWN0aW9uID0gdmFsdWU7CiAgICAgICAgY2FudmFzLnN0eWxlWydtcy10b3VjaC1hY3Rpb24nXSA9IHZhbHVlOwogICAgICAgIGNhbnZhcy5zdHlsZVsndG91Y2gtYWN0aW9uJ10gPSB2YWx1ZTsKCiAgICAgICAgcmV0dXJuIGNhbnZhczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSB1c2VyLXNlbGVjdCBwcm9wZXJ0eSBvbiB0aGUgY2FudmFzIHN0eWxlLiBDYW4gYmUgdXNlZCB0byBkaXNhYmxlIGRlZmF1bHQgYnJvd3NlciBzZWxlY3Rpb24gYWN0aW9ucy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLnNldFVzZXJTZWxlY3QKICAgICogQHBhcmFtIHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gVGhlIGNhbnZhcyB0byBzZXQgdGhlIHRvdWNoIGFjdGlvbiBvbi4KICAgICogQHBhcmFtIHtTdHJpbmd9IFt2YWx1ZV0gLSBUaGUgdG91Y2ggYWN0aW9uIHRvIHNldC4gRGVmYXVsdHMgdG8gJ25vbmUnLgogICAgKiBAcmV0dXJuIHtIVE1MQ2FudmFzRWxlbWVudH0gVGhlIHNvdXJjZSBjYW52YXMuCiAgICAqLwogICAgc2V0VXNlclNlbGVjdDogZnVuY3Rpb24gKGNhbnZhcywgdmFsdWUpIHsKCiAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCAnbm9uZSc7CgogICAgICAgIGNhbnZhcy5zdHlsZVsnLXdlYmtpdC10b3VjaC1jYWxsb3V0J10gPSB2YWx1ZTsKICAgICAgICBjYW52YXMuc3R5bGVbJy13ZWJraXQtdXNlci1zZWxlY3QnXSA9IHZhbHVlOwogICAgICAgIGNhbnZhcy5zdHlsZVsnLWtodG1sLXVzZXItc2VsZWN0J10gPSB2YWx1ZTsKICAgICAgICBjYW52YXMuc3R5bGVbJy1tb3otdXNlci1zZWxlY3QnXSA9IHZhbHVlOwogICAgICAgIGNhbnZhcy5zdHlsZVsnLW1zLXVzZXItc2VsZWN0J10gPSB2YWx1ZTsKICAgICAgICBjYW52YXMuc3R5bGVbJ3VzZXItc2VsZWN0J10gPSB2YWx1ZTsKICAgICAgICBjYW52YXMuc3R5bGVbJy13ZWJraXQtdGFwLWhpZ2hsaWdodC1jb2xvciddID0gJ3JnYmEoMCwgMCwgMCwgMCknOwoKICAgICAgICByZXR1cm4gY2FudmFzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgdGhlIGdpdmVuIGNhbnZhcyBlbGVtZW50IHRvIHRoZSBET00uIFRoZSBjYW52YXMgd2lsbCBiZSBhZGRlZCBhcyBhIGNoaWxkIG9mIHRoZSBnaXZlbiBwYXJlbnQuCiAgICAqIElmIG5vIHBhcmVudCBpcyBnaXZlbiBpdCB3aWxsIGJlIGFkZGVkIGFzIGEgY2hpbGQgb2YgdGhlIGRvY3VtZW50LmJvZHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5hZGRUb0RPTQogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgY2FudmFzIHRvIHNldCB0aGUgdG91Y2ggYWN0aW9uIG9uLgogICAgKiBAcGFyYW0ge3N0cmluZ3xIVE1MRWxlbWVudH0gcGFyZW50IC0gVGhlIERPTSBlbGVtZW50IHRvIGFkZCB0aGUgY2FudmFzIHRvLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvdmVyZmxvd0hpZGRlbj10cnVlXSAtIElmIHNldCB0byB0cnVlIGl0IHdpbGwgYWRkIHRoZSBvdmVyZmxvdz0naGlkZGVuJyBzdHlsZSB0byB0aGUgcGFyZW50IERPTSBlbGVtZW50LgogICAgKiBAcmV0dXJuIHtIVE1MQ2FudmFzRWxlbWVudH0gUmV0dXJucyB0aGUgc291cmNlIGNhbnZhcy4KICAgICovCiAgICBhZGRUb0RPTTogZnVuY3Rpb24gKGNhbnZhcywgcGFyZW50LCBvdmVyZmxvd0hpZGRlbikgewoKICAgICAgICB2YXIgdGFyZ2V0OwoKICAgICAgICBpZiAodHlwZW9mIG92ZXJmbG93SGlkZGVuID09PSAndW5kZWZpbmVkJykgeyBvdmVyZmxvd0hpZGRlbiA9IHRydWU7IH0KCiAgICAgICAgaWYgKHBhcmVudCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyZW50ID09PSAnc3RyaW5nJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gaG9wZWZ1bGx5IGFuIGVsZW1lbnQgSUQKICAgICAgICAgICAgICAgIHRhcmdldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHBhcmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIHBhcmVudCA9PT0gJ29iamVjdCcgJiYgcGFyZW50Lm5vZGVUeXBlID09PSAxKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBxdWljayB0ZXN0IGZvciBhIEhUTUxlbGVtZW50CiAgICAgICAgICAgICAgICB0YXJnZXQgPSBwYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZhbGxiYWNrLCBjb3ZlcnMgYW4gaW52YWxpZCBJRCBhbmQgYSBub24gSFRNTGVsZW1lbnQgb2JqZWN0CiAgICAgICAgaWYgKCF0YXJnZXQpCiAgICAgICAgewogICAgICAgICAgICB0YXJnZXQgPSBkb2N1bWVudC5ib2R5OwogICAgICAgIH0KCiAgICAgICAgaWYgKG92ZXJmbG93SGlkZGVuICYmIHRhcmdldC5zdHlsZSkKICAgICAgICB7CiAgICAgICAgICAgIHRhcmdldC5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nOwogICAgICAgIH0KCiAgICAgICAgdGFyZ2V0LmFwcGVuZENoaWxkKGNhbnZhcyk7CgogICAgICAgIHJldHVybiBjYW52YXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgdHJhbnNmb3JtIG9mIHRoZSBnaXZlbiBjYW52YXMgdG8gdGhlIG1hdHJpeCB2YWx1ZXMgcHJvdmlkZWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5zZXRUcmFuc2Zvcm0KICAgICogQHBhcmFtIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHQgLSBUaGUgY29udGV4dCB0byBzZXQgdGhlIHRyYW5zZm9ybSBvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHRyYW5zbGF0ZVggLSBUaGUgdmFsdWUgdG8gdHJhbnNsYXRlIGhvcml6b250YWxseSBieS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHRyYW5zbGF0ZVkgLSBUaGUgdmFsdWUgdG8gdHJhbnNsYXRlIHZlcnRpY2FsbHkgYnkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzY2FsZVggLSBUaGUgdmFsdWUgdG8gc2NhbGUgaG9yaXpvbnRhbGx5IGJ5LgogICAgKiBAcGFyYW0ge251bWJlcn0gc2NhbGVZIC0gVGhlIHZhbHVlIHRvIHNjYWxlIHZlcnRpY2FsbHkgYnkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBza2V3WCAtIFRoZSB2YWx1ZSB0byBza2V3IGhvcml6b250YWx5IGJ5LgogICAgKiBAcGFyYW0ge251bWJlcn0gc2tld1kgLSBUaGUgdmFsdWUgdG8gc2tldyB2ZXJ0aWNhbGx5IGJ5LgogICAgKiBAcmV0dXJuIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IFJldHVybnMgdGhlIHNvdXJjZSBjb250ZXh0LgogICAgKi8KICAgIHNldFRyYW5zZm9ybTogZnVuY3Rpb24gKGNvbnRleHQsIHRyYW5zbGF0ZVgsIHRyYW5zbGF0ZVksIHNjYWxlWCwgc2NhbGVZLCBza2V3WCwgc2tld1kpIHsKCiAgICAgICAgY29udGV4dC5zZXRUcmFuc2Zvcm0oc2NhbGVYLCBza2V3WCwgc2tld1ksIHNjYWxlWSwgdHJhbnNsYXRlWCwgdHJhbnNsYXRlWSk7CgogICAgICAgIHJldHVybiBjb250ZXh0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIEltYWdlIFNtb290aGluZyBwcm9wZXJ0eSBvbiB0aGUgZ2l2ZW4gY29udGV4dC4gU2V0IHRvIGZhbHNlIHRvIGRpc2FibGUgaW1hZ2Ugc21vb3RoaW5nLgogICAgKiBCeSBkZWZhdWx0IGJyb3dzZXJzIGhhdmUgaW1hZ2Ugc21vb3RoaW5nIGVuYWJsZWQsIHdoaWNoIGlzbid0IGFsd2F5cyB3aGF0IHlvdSB2aXN1YWxseSB3YW50LCBlc3BlY2lhbGx5CiAgICAqIHdoZW4gdXNpbmcgcGl4ZWwgYXJ0IGluIGEgZ2FtZS4gTm90ZSB0aGF0IHRoaXMgc2V0cyB0aGUgcHJvcGVydHkgb24gdGhlIGNvbnRleHQgaXRzZWxmLCBzbyB0aGF0IGFueSBpbWFnZQogICAgKiBkcmF3biB0byB0aGUgY29udGV4dCB3aWxsIGJlIGFmZmVjdGVkLiBUaGlzIHNldHMgdGhlIHByb3BlcnR5IGFjcm9zcyBhbGwgY3VycmVudCBicm93c2VycyBidXQgc3VwcG9ydCBpcwogICAgKiBwYXRjaHkgb24gZWFybGllciBicm93c2VycywgZXNwZWNpYWxseSBvbiBtb2JpbGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5zZXRTbW9vdGhpbmdFbmFibGVkCiAgICAqIEBwYXJhbSB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBjb250ZXh0IC0gVGhlIGNvbnRleHQgdG8gZW5hYmxlIG9yIGRpc2FibGUgdGhlIGltYWdlIHNtb290aGluZyBvbi4KICAgICogQHBhcmFtIHtib29sZWFufSB2YWx1ZSAtIElmIHNldCB0byB0cnVlIGl0IHdpbGwgZW5hYmxlIGltYWdlIHNtb290aGluZywgZmFsc2Ugd2lsbCBkaXNhYmxlIGl0LgogICAgKiBAcmV0dXJuIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IFJldHVybnMgdGhlIHNvdXJjZSBjb250ZXh0LgogICAgKi8KICAgIHNldFNtb290aGluZ0VuYWJsZWQ6IGZ1bmN0aW9uIChjb250ZXh0LCB2YWx1ZSkgewoKICAgICAgICBjb250ZXh0WydpbWFnZVNtb290aGluZ0VuYWJsZWQnXSA9IHZhbHVlOwogICAgICAgIGNvbnRleHRbJ21vekltYWdlU21vb3RoaW5nRW5hYmxlZCddID0gdmFsdWU7CiAgICAgICAgY29udGV4dFsnb0ltYWdlU21vb3RoaW5nRW5hYmxlZCddID0gdmFsdWU7CiAgICAgICAgY29udGV4dFsnd2Via2l0SW1hZ2VTbW9vdGhpbmdFbmFibGVkJ10gPSB2YWx1ZTsKICAgICAgICBjb250ZXh0Wydtc0ltYWdlU21vb3RoaW5nRW5hYmxlZCddID0gdmFsdWU7CgogICAgICAgIHJldHVybiBjb250ZXh0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIENTUyBpbWFnZS1yZW5kZXJpbmcgcHJvcGVydHkgb24gdGhlIGdpdmVuIGNhbnZhcyB0byBiZSAnY3Jpc3AnIChha2EgJ29wdGltaXplIGNvbnRyYXN0IG9uIHdlYmtpdCcpLgogICAgKiBOb3RlIHRoYXQgaWYgdGhpcyBkb2Vzbid0IGdpdmVuIHRoZSBkZXNpcmVkIHJlc3VsdCB0aGVuIHNlZSB0aGUgc2V0U21vb3RoaW5nRW5hYmxlZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLnNldEltYWdlUmVuZGVyaW5nQ3Jpc3AKICAgICogQHBhcmFtIHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gVGhlIGNhbnZhcyB0byBzZXQgaW1hZ2UtcmVuZGVyaW5nIGNyaXNwIG9uLgogICAgKiBAcmV0dXJuIHtIVE1MQ2FudmFzRWxlbWVudH0gUmV0dXJucyB0aGUgc291cmNlIGNhbnZhcy4KICAgICovCiAgICBzZXRJbWFnZVJlbmRlcmluZ0NyaXNwOiBmdW5jdGlvbiAoY2FudmFzKSB7CgogICAgICAgIGNhbnZhcy5zdHlsZVsnaW1hZ2UtcmVuZGVyaW5nJ10gPSAnb3B0aW1pemVTcGVlZCc7CiAgICAgICAgY2FudmFzLnN0eWxlWydpbWFnZS1yZW5kZXJpbmcnXSA9ICdjcmlzcC1lZGdlcyc7CiAgICAgICAgY2FudmFzLnN0eWxlWydpbWFnZS1yZW5kZXJpbmcnXSA9ICctbW96LWNyaXNwLWVkZ2VzJzsKICAgICAgICBjYW52YXMuc3R5bGVbJ2ltYWdlLXJlbmRlcmluZyddID0gJy13ZWJraXQtb3B0aW1pemUtY29udHJhc3QnOwogICAgICAgIGNhbnZhcy5zdHlsZVsnaW1hZ2UtcmVuZGVyaW5nJ10gPSAnb3B0aW1pemUtY29udHJhc3QnOwogICAgICAgIGNhbnZhcy5zdHlsZS5tc0ludGVycG9sYXRpb25Nb2RlID0gJ25lYXJlc3QtbmVpZ2hib3InOwoKICAgICAgICByZXR1cm4gY2FudmFzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIENTUyBpbWFnZS1yZW5kZXJpbmcgcHJvcGVydHkgb24gdGhlIGdpdmVuIGNhbnZhcyB0byBiZSAnYmljdWJpYycgKGFrYSAnYXV0bycpLgogICAgKiBOb3RlIHRoYXQgaWYgdGhpcyBkb2Vzbid0IGdpdmVuIHRoZSBkZXNpcmVkIHJlc3VsdCB0aGVuIHNlZSB0aGUgQ2FudmFzVXRpbHMuc2V0U21vb3RoaW5nRW5hYmxlZCBtZXRob2QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5zZXRJbWFnZVJlbmRlcmluZ0JpY3ViaWMKICAgICogQHBhcmFtIHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIFRoZSBjYW52YXMgdG8gc2V0IGltYWdlLXJlbmRlcmluZyBiaWN1YmljIG9uLgogICAgKiBAcmV0dXJuIHtIVE1MQ2FudmFzRWxlbWVudH0gUmV0dXJucyB0aGUgc291cmNlIGNhbnZhcy4KICAgICovCiAgICBzZXRJbWFnZVJlbmRlcmluZ0JpY3ViaWM6IGZ1bmN0aW9uIChjYW52YXMpIHsKCiAgICAgICAgY2FudmFzLnN0eWxlWydpbWFnZS1yZW5kZXJpbmcnXSA9ICdhdXRvJzsKICAgICAgICBjYW52YXMuc3R5bGUubXNJbnRlcnBvbGF0aW9uTW9kZSA9ICdiaWN1YmljJzsKCiAgICAgICAgcmV0dXJuIGNhbnZhczsKCiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIFN0YWdlU2NhbGVNb2RlIG9iamVjdCBpcyByZXNwb25zaWJsZSBmb3IgaGVscGluZyB5b3UgbWFuYWdlIHRoZSBzY2FsaW5nLCByZXNpemluZyBhbmQgYWxpZ25tZW50IG9mIHlvdXIgZ2FtZSB3aXRoaW4gdGhlIGJyb3dzZXIuCioKKiBAY2xhc3MgUGhhc2VyLlN0YWdlU2NhbGVNb2RlIAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgbmF0aXZlIHdpZHRoIG9mIHRoZSBnYW1lLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgbmF0aXZlIGhlaWdodCBvZiB0aGUgZ2FtZS4KKi8KUGhhc2VyLlN0YWdlU2NhbGVNb2RlID0gZnVuY3Rpb24gKGdhbWUsIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIFdpZHRoIG9mIHRoZSBzdGFnZSBhZnRlciBjYWxjdWxhdGlvbi4KICAgICovCiAgICB0aGlzLndpZHRoID0gd2lkdGg7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBIZWlnaHQgb2YgdGhlIHN0YWdlIGFmdGVyIGNhbGN1bGF0aW9uLgogICAgKi8KICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWluV2lkdGggLSBNaW5pbXVtIHdpZHRoIHRoZSBjYW52YXMgc2hvdWxkIGJlIHNjYWxlZCB0byAoaW4gcGl4ZWxzKS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1pbldpZHRoID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heFdpZHRoIC0gTWF4aW11bSB3aWR0aCB0aGUgY2FudmFzIHNob3VsZCBiZSBzY2FsZWQgdG8gKGluIHBpeGVscykuCiAgICAqIElmIG51bGwgaXQgd2lsbCBzY2FsZSB0byB3aGF0ZXZlciB3aWR0aCB0aGUgYnJvd3NlciBjYW4gaGFuZGxlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWF4V2lkdGggPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWluSGVpZ2h0IC0gTWluaW11bSBoZWlnaHQgdGhlIGNhbnZhcyBzaG91bGQgYmUgc2NhbGVkIHRvIChpbiBwaXhlbHMpLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWluSGVpZ2h0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heEhlaWdodCAtIE1heGltdW0gaGVpZ2h0IHRoZSBjYW52YXMgc2hvdWxkIGJlIHNjYWxlZCB0byAoaW4gcGl4ZWxzKS4KICAgICogSWYgbnVsbCBpdCB3aWxsIHNjYWxlIHRvIHdoYXRldmVyIGhlaWdodCB0aGUgYnJvd3NlciBjYW4gaGFuZGxlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWF4SGVpZ2h0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9zdGFydEhlaWdodCAtIFN0YWdlIGhlaWdodCB3aGVuIHN0YXJ0aW5nIHRoZSBnYW1lLgogICAgKiBAZGVmYXVsdAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3N0YXJ0SGVpZ2h0ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBmb3JjZUxhbmRzY2FwZSAtIElmIHRoZSBnYW1lIHNob3VsZCBiZSBmb3JjZWQgdG8gdXNlIExhbmRzY2FwZSBtb2RlLCB0aGlzIGlzIHNldCB0byB0cnVlIGJ5IEdhbWUuU3RhZ2UKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZvcmNlTGFuZHNjYXBlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZm9yY2VQb3J0cmFpdCAtIElmIHRoZSBnYW1lIHNob3VsZCBiZSBmb3JjZWQgdG8gdXNlIFBvcnRyYWl0IG1vZGUsIHRoaXMgaXMgc2V0IHRvIHRydWUgYnkgR2FtZS5TdGFnZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZm9yY2VQb3J0cmFpdCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGluY29ycmVjdE9yaWVudGF0aW9uIC0gSWYgdGhlIGdhbWUgc2hvdWxkIGJlIGZvcmNlZCB0byB1c2UgYSBzcGVjaWZpYyBvcmllbnRhdGlvbiBhbmQgdGhlIGRldmljZSBjdXJyZW50bHkgaXNuJ3QgaW4gdGhhdCBvcmllbnRhdGlvbiB0aGlzIGlzIHNldCB0byB0cnVlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24gPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBwYWdlQWxpZ25Ib3Jpem9udGFsbHkgLSBJZiB5b3Ugd2lzaCB0byBhbGlnbiB5b3VyIGdhbWUgaW4gdGhlIG1pZGRsZSBvZiB0aGUgcGFnZSB0aGVuIHlvdSBjYW4gc2V0IHRoaXMgdmFsdWUgdG8gdHJ1ZS4KICAgICogSXQgd2lsbCBwbGFjZSBhIHJlLWNhbGN1bGF0ZWQgbWFyZ2luLWxlZnQgcGl4ZWwgdmFsdWUgb250byB0aGUgY2FudmFzIGVsZW1lbnQgd2hpY2ggaXMgdXBkYXRlZCBvbiBvcmllbnRhdGlvbi9yZXNpemluZy4KICAgICogSXQgZG9lc24ndCBjYXJlIGFib3V0IGFueSBvdGhlciBET00gZWxlbWVudCB0aGF0IG1heSBiZSBvbiB0aGUgcGFnZSwgaXQgbGl0ZXJhbGx5IGp1c3Qgc2V0cyB0aGUgbWFyZ2luLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGFnZUFsaWduSG9yaXpvbnRhbGx5ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGFnZUFsaWduVmVydGljYWxseSAtIElmIHlvdSB3aXNoIHRvIGFsaWduIHlvdXIgZ2FtZSBpbiB0aGUgbWlkZGxlIG9mIHRoZSBwYWdlIHRoZW4geW91IGNhbiBzZXQgdGhpcyB2YWx1ZSB0byB0cnVlLgogICAgKiBJdCB3aWxsIHBsYWNlIGEgcmUtY2FsY3VsYXRlZCBtYXJnaW4tbGVmdCBwaXhlbCB2YWx1ZSBvbnRvIHRoZSBjYW52YXMgZWxlbWVudCB3aGljaCBpcyB1cGRhdGVkIG9uIG9yaWVudGF0aW9uL3Jlc2l6aW5nLgogICAgKiBJdCBkb2Vzbid0IGNhcmUgYWJvdXQgYW55IG90aGVyIERPTSBlbGVtZW50IHRoYXQgbWF5IGJlIG9uIHRoZSBwYWdlLCBpdCBsaXRlcmFsbHkganVzdCBzZXRzIHRoZSBtYXJnaW4uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYWdlQWxpZ25WZXJ0aWNhbGx5ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfd2lkdGggLSBDYWNoZWQgc3RhZ2Ugd2lkdGggZm9yIGZ1bGwgc2NyZWVuIG1vZGUuCiAgICAqIEBkZWZhdWx0CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fd2lkdGggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2hlaWdodCAtIENhY2hlZCBzdGFnZSBoZWlnaHQgZm9yIGZ1bGwgc2NyZWVuIG1vZGUuCiAgICAqIEBkZWZhdWx0CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5faGVpZ2h0ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heEl0ZXJhdGlvbnMgLSBUaGUgbWF4aW11bSBudW1iZXIgb2YgdGltZXMgaXQgd2lsbCB0cnkgdG8gcmVzaXplIHRoZSBjYW52YXMgdG8gZmlsbCB0aGUgYnJvd3Nlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1heEl0ZXJhdGlvbnMgPSA1OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BJWEkuU3ByaXRlfSBvcmllbnRhdGlvblNwcml0ZSAtIFRoZSBTcHJpdGUgdGhhdCBpcyBvcHRpb25hbGx5IGRpc3BsYXllZCBpZiB0aGUgYnJvd3NlciBlbnRlcnMgYW4gdW5zdXBwb3J0ZWQgb3JpZW50YXRpb24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gZW50ZXJMYW5kc2NhcGUgLSBUaGUgZXZlbnQgdGhhdCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhlIGJyb3dzZXIgZW50ZXJzIGxhbmRzY2FwZSBvcmllbnRhdGlvbi4KICAgICovCiAgICB0aGlzLmVudGVyTGFuZHNjYXBlID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBlbnRlclBvcnRyYWl0IC0gVGhlIGV2ZW50IHRoYXQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoZSBicm93c2VyIGVudGVycyBob3Jpem9udGFsIG9yaWVudGF0aW9uLgogICAgKi8KICAgIHRoaXMuZW50ZXJQb3J0cmFpdCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gZW50ZXJJbmNvcnJlY3RPcmllbnRhdGlvbiAtIFRoZSBldmVudCB0aGF0IGlzIGRpc3BhdGNoZWQgd2hlbiB0aGUgYnJvd3NlciBlbnRlcnMgYW4gaW5jb3JyZWN0IG9yaWVudGF0aW9uLCBhcyBkZWZpbmVkIGJ5IGZvcmNlT3JpZW50YXRpb24uCiAgICAqLwogICAgdGhpcy5lbnRlckluY29ycmVjdE9yaWVudGF0aW9uID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBsZWF2ZUluY29ycmVjdE9yaWVudGF0aW9uIC0gVGhlIGV2ZW50IHRoYXQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoZSBicm93c2VyIGxlYXZlcyBhbiBpbmNvcnJlY3Qgb3JpZW50YXRpb24sIGFzIGRlZmluZWQgYnkgZm9yY2VPcmllbnRhdGlvbi4KICAgICovCiAgICB0aGlzLmxlYXZlSW5jb3JyZWN0T3JpZW50YXRpb24gPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IGhhc1Jlc2l6ZWQgLSBUaGUgZXZlbnQgdGhhdCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhlIGdhbWUgc2NhbGUgY2hhbmdlcy4KICAgICovCiAgICB0aGlzLmhhc1Jlc2l6ZWQgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgIGlmICh3aW5kb3dbJ29yaWVudGF0aW9uJ10pCiAgICB7CiAgICAgICAgdGhpcy5vcmllbnRhdGlvbiA9IHdpbmRvd1snb3JpZW50YXRpb24nXTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBpZiAod2luZG93Lm91dGVyV2lkdGggPiB3aW5kb3cub3V0ZXJIZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uID0gOTA7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb24gPSAwOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHNjYWxlRmFjdG9yIC0gVGhlIHNjYWxlIGZhY3RvciBiYXNlZCBvbiB0aGUgZ2FtZSBkaW1lbnNpb25zIHZzLiB0aGUgc2NhbGVkIGRpbWVuc2lvbnMuCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMuc2NhbGVGYWN0b3IgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc2NhbGVGYWN0b3JJbnZlcnNlZCAtIFRoZSBpbnZlcnNlZCBzY2FsZSBmYWN0b3IuIFRoZSBkaXNwbGF5ZWQgZGltZW5zaW9ucyBkaXZpZGVkIGJ5IHRoZSBnYW1lIGRpbWVuc2lvbnMuCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMuc2NhbGVGYWN0b3JJbnZlcnNlZCA9IG5ldyBQaGFzZXIuUG9pbnQoMSwgMSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBtYXJnaW4gLSBJZiB0aGUgZ2FtZSBjYW52YXMgaXMgc2V0byB0byBhbGlnbiBieSBhZGp1c3RpbmcgdGhlIG1hcmdpbiwgdGhlIG1hcmdpbiBjYWxjdWxhdGlvbiB2YWx1ZXMgYXJlIHN0b3JlZCBpbiB0aGlzIFBvaW50LgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLm1hcmdpbiA9IG5ldyBQaGFzZXIuUG9pbnQoMCwgMCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhc3BlY3RSYXRpbyAtIEFzcGVjdCByYXRpby4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFzcGVjdFJhdGlvID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthbnl9IGV2ZW50LSBUaGUgbmF0aXZlIGJyb3dzZXIgZXZlbnRzIGZyb20gZnVsbCBzY3JlZW4gQVBJIGNoYW5nZXMuCiAgICAqLwogICAgdGhpcy5ldmVudCA9IG51bGw7CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb3JpZW50YXRpb25jaGFuZ2UnLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICByZXR1cm4gX3RoaXMuY2hlY2tPcmllbnRhdGlvbihldmVudCk7CiAgICB9LCBmYWxzZSk7CgogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHJldHVybiBfdGhpcy5jaGVja1Jlc2l6ZShldmVudCk7CiAgICB9LCBmYWxzZSk7CgogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignd2Via2l0ZnVsbHNjcmVlbmNoYW5nZScsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHJldHVybiBfdGhpcy5mdWxsU2NyZWVuQ2hhbmdlKGV2ZW50KTsKICAgIH0sIGZhbHNlKTsKCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3pmdWxsc2NyZWVuY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIF90aGlzLmZ1bGxTY3JlZW5DaGFuZ2UoZXZlbnQpOwogICAgfSwgZmFsc2UpOwoKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2Z1bGxzY3JlZW5jaGFuZ2UnLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICByZXR1cm4gX3RoaXMuZnVsbFNjcmVlbkNoYW5nZShldmVudCk7CiAgICB9LCBmYWxzZSk7CiAgICAKfTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5TdGFnZVNjYWxlTW9kZS5FWEFDVF9GSVQgPSAwOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLlN0YWdlU2NhbGVNb2RlLk5PX1NDQUxFID0gMTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5TdGFnZVNjYWxlTW9kZS5TSE9XX0FMTCA9IDI7CgpQaGFzZXIuU3RhZ2VTY2FsZU1vZGUucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBUcmllcyB0byBlbnRlciB0aGUgYnJvd3NlciBpbnRvIGZ1bGwgc2NyZWVuIG1vZGUuCiAgICAqIFBsZWFzZSBub3RlIHRoYXQgdGhpcyBuZWVkcyB0byBiZSBzdXBwb3J0ZWQgYnkgdGhlIHdlYiBicm93c2VyIGFuZCBpc24ndCB0aGUgc2FtZSB0aGluZyBhcyBzZXR0aW5nIHlvdXIgZ2FtZSB0byBmaWxsIHRoZSBicm93c2VyLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNzdGFydEZ1bGxTY3JlZW4KICAgICogQHBhcmFtIHtib29sZWFufSBhbnRpYWxpYXMgLSBZb3UgY2FuIHRvZ2dsZSB0aGUgYW50aS1hbGlhcyBmZWF0dXJlIG9mIHRoZSBjYW52YXMgYmVmb3JlIGp1bXBpbmcgaW4gdG8gZnVsbCBzY3JlZW4gKGZhbHNlID0gcmV0YWluIHBpeGVsIGFydCwgdHJ1ZSA9IHNtb290aCBhcnQpCiAgICAqLwogICAgc3RhcnRGdWxsU2NyZWVuOiBmdW5jdGlvbiAoYW50aWFsaWFzKSB7CgogICAgICAgIGlmICh0aGlzLmlzRnVsbFNjcmVlbikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgYW50aWFsaWFzICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIFBoYXNlci5DYW52YXMuc2V0U21vb3RoaW5nRW5hYmxlZCh0aGlzLmdhbWUuY29udGV4dCwgYW50aWFsaWFzKTsKICAgICAgICB9CgogICAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5nYW1lLmNhbnZhczsKICAgICAgICAKICAgICAgICB0aGlzLl93aWR0aCA9IHRoaXMud2lkdGg7CiAgICAgICAgdGhpcy5faGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CgogICAgICAgIC8vICBUaGlzIG5lZWRzIHVwZGF0aW5nIHRvIG1hdGNoIHRoZSBmaW5hbCBzcGVjOgogICAgICAgIC8vICBodHRwOi8vZ2VuZXJhdGVkY29udGVudC5vcmcvcG9zdC83MDM0NzU3MzI5NC9pcy15b3VyLWZ1bGxzY3JlZW4tYXBpLWNvZGUtdXAtdG8tZGF0ZS1maW5kLW91dC1ob3ctdG8KCiAgICAgICAgaWYgKGVsZW1lbnRbJ3JlcXVlc3RGdWxsU2NyZWVuJ10pCiAgICAgICAgewogICAgICAgICAgICBlbGVtZW50WydyZXF1ZXN0RnVsbFNjcmVlbiddKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGVsZW1lbnRbJ21velJlcXVlc3RGdWxsU2NyZWVuJ10pCiAgICAgICAgewogICAgICAgICAgICBlbGVtZW50LnBhcmVudE5vZGVbJ21velJlcXVlc3RGdWxsU2NyZWVuJ10oKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZWxlbWVudFsnd2Via2l0UmVxdWVzdEZ1bGxTY3JlZW4nXSkKICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnRbJ3dlYmtpdFJlcXVlc3RGdWxsU2NyZWVuJ10oRWxlbWVudC5BTExPV19LRVlCT0FSRF9JTlBVVCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3BzIGZ1bGwgc2NyZWVuIG1vZGUgaWYgdGhlIGJyb3dzZXIgaXMgaW4gaXQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI3N0b3BGdWxsU2NyZWVuCiAgICAqLwogICAgc3RvcEZ1bGxTY3JlZW46IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKGRvY3VtZW50WydjYW5jZWxGdWxsU2NyZWVuJ10pCiAgICAgICAgewogICAgICAgICAgICBkb2N1bWVudFsnY2FuY2VsRnVsbFNjcmVlbiddKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGRvY3VtZW50Wydtb3pDYW5jZWxGdWxsU2NyZWVuJ10pCiAgICAgICAgewogICAgICAgICAgICBkb2N1bWVudFsnbW96Q2FuY2VsRnVsbFNjcmVlbiddKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGRvY3VtZW50Wyd3ZWJraXRDYW5jZWxGdWxsU2NyZWVuJ10pCiAgICAgICAgewogICAgICAgICAgICBkb2N1bWVudFsnd2Via2l0Q2FuY2VsRnVsbFNjcmVlbiddKCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCBhdXRvbWF0aWNhbGx5IHdoZW4gdGhlIGJyb3dzZXIgZW50ZXJzIG9mIGxlYXZlcyBmdWxsIHNjcmVlbiBtb2RlLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNmdWxsU2NyZWVuQ2hhbmdlCiAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IC0gVGhlIGZ1bGxzY3JlZW5jaGFuZ2UgZXZlbnQKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGZ1bGxTY3JlZW5DaGFuZ2U6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7CgogICAgICAgIGlmICh0aGlzLmlzRnVsbFNjcmVlbikKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZ2UuZnVsbFNjcmVlblNjYWxlTW9kZSA9PT0gUGhhc2VyLlN0YWdlU2NhbGVNb2RlLkVYQUNUX0ZJVCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5zdHlsZVsnd2lkdGgnXSA9ICcxMDAlJzsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMuc3R5bGVbJ2hlaWdodCddID0gJzEwMCUnOwoKICAgICAgICAgICAgICAgIHRoaXMuc2V0TWF4aW11bSgpOwoKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5zY2FsZS5zZXRUbyh0aGlzLmdhbWUud2lkdGggLyB0aGlzLndpZHRoLCB0aGlzLmdhbWUuaGVpZ2h0IC8gdGhpcy5oZWlnaHQpOwoKICAgICAgICAgICAgICAgIHRoaXMuYXNwZWN0UmF0aW8gPSB0aGlzLndpZHRoIC8gdGhpcy5oZWlnaHQ7CiAgICAgICAgICAgICAgICB0aGlzLnNjYWxlRmFjdG9yLnggPSB0aGlzLmdhbWUud2lkdGggLyB0aGlzLndpZHRoOwogICAgICAgICAgICAgICAgdGhpcy5zY2FsZUZhY3Rvci55ID0gdGhpcy5nYW1lLmhlaWdodCAvIHRoaXMuaGVpZ2h0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZ2FtZS5zdGFnZS5mdWxsU2NyZWVuU2NhbGVNb2RlID09PSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuU0hPV19BTEwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5zY2FsZS5zZXRTaG93QWxsKCk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2Uuc2NhbGUucmVmcmVzaCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMuc3R5bGVbJ3dpZHRoJ10gPSB0aGlzLmdhbWUud2lkdGggKyAncHgnOwogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnN0eWxlWydoZWlnaHQnXSA9IHRoaXMuZ2FtZS5oZWlnaHQgKyAncHgnOwoKICAgICAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMuX3dpZHRoOwogICAgICAgICAgICB0aGlzLmhlaWdodCA9IHRoaXMuX2hlaWdodDsKCiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5zY2FsZS5zZXRUbyh0aGlzLmdhbWUud2lkdGggLyB0aGlzLndpZHRoLCB0aGlzLmdhbWUuaGVpZ2h0IC8gdGhpcy5oZWlnaHQpOwoKICAgICAgICAgICAgdGhpcy5hc3BlY3RSYXRpbyA9IHRoaXMud2lkdGggLyB0aGlzLmhlaWdodDsKICAgICAgICAgICAgdGhpcy5zY2FsZUZhY3Rvci54ID0gdGhpcy5nYW1lLndpZHRoIC8gdGhpcy53aWR0aDsKICAgICAgICAgICAgdGhpcy5zY2FsZUZhY3Rvci55ID0gdGhpcy5nYW1lLmhlaWdodCAvIHRoaXMuaGVpZ2h0OwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBJZiB5b3UgbmVlZCB5b3VyIGdhbWUgdG8gcnVuIGluIG9ubHkgb25lIG9yaWVudGF0aW9uIHlvdSBjYW4gZm9yY2UgdGhhdCB0byBoYXBwZW4uCiAgICAqIFRoZSBvcHRpb25hbCBvcmllbnRhdGlvbkltYWdlIGlzIGRpc3BsYXllZCB3aGVuIHRoZSBnYW1lIGlzIGluIHRoZSBpbmNvcnJlY3Qgb3JpZW50YXRpb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2ZvcmNlT3JpZW50YXRpb24KICAgICogQHBhcmFtIHtib29sZWFufSBmb3JjZUxhbmRzY2FwZSAtIHRydWUgaWYgdGhlIGdhbWUgc2hvdWxkIHJ1biBpbiBsYW5kc2NhcGUgbW9kZSBvbmx5LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmb3JjZVBvcnRyYWl0PWZhbHNlXSAtIHRydWUgaWYgdGhlIGdhbWUgc2hvdWxkIHJ1biBpbiBwb3J0cmFpdCBtb2RlIG9ubHkuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbb3JpZW50YXRpb25JbWFnZT0nJ10gLSBUaGUgc3RyaW5nIG9mIGFuIGltYWdlIGluIHRoZSBQaGFzZXIuQ2FjaGUgdG8gZGlzcGxheSB3aGVuIHRoaXMgZ2FtZSBpcyBpbiB0aGUgaW5jb3JyZWN0IG9yaWVudGF0aW9uLgogICAgKi8KICAgIGZvcmNlT3JpZW50YXRpb246IGZ1bmN0aW9uIChmb3JjZUxhbmRzY2FwZSwgZm9yY2VQb3J0cmFpdCwgb3JpZW50YXRpb25JbWFnZSkgewoKICAgICAgICBpZiAodHlwZW9mIGZvcmNlUG9ydHJhaXQgPT09ICd1bmRlZmluZWQnKSB7IGZvcmNlUG9ydHJhaXQgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLmZvcmNlTGFuZHNjYXBlID0gZm9yY2VMYW5kc2NhcGU7CiAgICAgICAgdGhpcy5mb3JjZVBvcnRyYWl0ID0gZm9yY2VQb3J0cmFpdDsKCiAgICAgICAgaWYgKHR5cGVvZiBvcmllbnRhdGlvbkltYWdlICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChvcmllbnRhdGlvbkltYWdlID09IG51bGwgfHwgdGhpcy5nYW1lLmNhY2hlLmNoZWNrSW1hZ2VLZXkob3JpZW50YXRpb25JbWFnZSkgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvcmllbnRhdGlvbkltYWdlID0gJ19fZGVmYXVsdCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUgPSBuZXcgUElYSS5TcHJpdGUoUElYSS5UZXh0dXJlQ2FjaGVbb3JpZW50YXRpb25JbWFnZV0pOwogICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlLmFuY2hvci54ID0gMC41OwogICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlLmFuY2hvci55ID0gMC41OwogICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlLnBvc2l0aW9uLnggPSB0aGlzLmdhbWUud2lkdGggLyAyOwogICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlLnBvc2l0aW9uLnkgPSB0aGlzLmdhbWUuaGVpZ2h0IC8gMjsKCiAgICAgICAgICAgIHRoaXMuY2hlY2tPcmllbnRhdGlvblN0YXRlKCk7CgogICAgICAgICAgICBpZiAodGhpcy5pbmNvcnJlY3RPcmllbnRhdGlvbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS53b3JsZC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS53b3JsZC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5hZGRDaGlsZCh0aGlzLm9yaWVudGF0aW9uU3ByaXRlKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGlmIHRoZSBicm93c2VyIGlzIGluIHRoZSBjb3JyZWN0IG9yaWVudGF0aW9uIGZvciB5b3VyIGdhbWUgKGlmIGZvcmNlTGFuZHNjYXBlIG9yIGZvcmNlUG9ydHJhaXQgaGF2ZSBiZWVuIHNldCkKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjY2hlY2tPcmllbnRhdGlvblN0YXRlCiAgICAqLwogICAgY2hlY2tPcmllbnRhdGlvblN0YXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vICBUaGV5IGFyZSBpbiB0aGUgd3Jvbmcgb3JpZW50YXRpb24KICAgICAgICBpZiAodGhpcy5pbmNvcnJlY3RPcmllbnRhdGlvbikKICAgICAgICB7CiAgICAgICAgICAgIGlmICgodGhpcy5mb3JjZUxhbmRzY2FwZSAmJiB3aW5kb3cuaW5uZXJXaWR0aCA+IHdpbmRvdy5pbm5lckhlaWdodCkgfHwgKHRoaXMuZm9yY2VQb3J0cmFpdCAmJiB3aW5kb3cuaW5uZXJIZWlnaHQgPiB3aW5kb3cuaW5uZXJXaWR0aCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBCYWNrIHRvIG5vcm1hbAogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhdXNlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5pbmNvcnJlY3RPcmllbnRhdGlvbiA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5sZWF2ZUluY29ycmVjdE9yaWVudGF0aW9uLmRpc3BhdGNoKCk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMub3JpZW50YXRpb25TcHJpdGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLndvcmxkLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICgodGhpcy5mb3JjZUxhbmRzY2FwZSAmJiB3aW5kb3cuaW5uZXJXaWR0aCA8IHdpbmRvdy5pbm5lckhlaWdodCkgfHwgKHRoaXMuZm9yY2VQb3J0cmFpdCAmJiB3aW5kb3cuaW5uZXJIZWlnaHQgPCB3aW5kb3cuaW5uZXJXaWR0aCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBTaG93IG9yaWVudGF0aW9uIHNjcmVlbgogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnBhdXNlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZW50ZXJJbmNvcnJlY3RPcmllbnRhdGlvbi5kaXNwYXRjaCgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9yaWVudGF0aW9uU3ByaXRlICYmIHRoaXMub3JpZW50YXRpb25TcHJpdGUudmlzaWJsZSA9PT0gZmFsc2UpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUud29ybGQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogSGFuZGxlIHdpbmRvdy5vcmllbnRhdGlvbmNoYW5nZSBldmVudHMKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjY2hlY2tPcmllbnRhdGlvbgogICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAtIFRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkYXRhLgogICAgKi8KICAgIGNoZWNrT3JpZW50YXRpb246IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7CgogICAgICAgIHRoaXMub3JpZW50YXRpb24gPSB3aW5kb3dbJ29yaWVudGF0aW9uJ107CgogICAgICAgIGlmICh0aGlzLmlzTGFuZHNjYXBlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lbnRlckxhbmRzY2FwZS5kaXNwYXRjaCh0aGlzLm9yaWVudGF0aW9uLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZW50ZXJQb3J0cmFpdC5kaXNwYXRjaCh0aGlzLm9yaWVudGF0aW9uLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLnN0YWdlLnNjYWxlTW9kZSAhPT0gUGhhc2VyLlN0YWdlU2NhbGVNb2RlLk5PX1NDQUxFKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEhhbmRsZSB3aW5kb3cucmVzaXplIGV2ZW50cwogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNjaGVja1Jlc2l6ZQogICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAtIFRoZSByZXNpemUgZXZlbnQgZGF0YS4KICAgICovCiAgICBjaGVja1Jlc2l6ZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuZXZlbnQgPSBldmVudDsKCiAgICAgICAgaWYgKHdpbmRvdy5vdXRlcldpZHRoID4gd2luZG93Lm91dGVySGVpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvbiA9IDkwOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uID0gMDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmlzTGFuZHNjYXBlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lbnRlckxhbmRzY2FwZS5kaXNwYXRjaCh0aGlzLm9yaWVudGF0aW9uLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZW50ZXJQb3J0cmFpdC5kaXNwYXRjaCh0aGlzLm9yaWVudGF0aW9uLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLnN0YWdlLnNjYWxlTW9kZSAhPT0gUGhhc2VyLlN0YWdlU2NhbGVNb2RlLk5PX1NDQUxFKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNoZWNrT3JpZW50YXRpb25TdGF0ZSgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlLWNhbGN1bGF0ZSBzY2FsZSBtb2RlIGFuZCB1cGRhdGUgc2NyZWVuIHNpemUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI3JlZnJlc2gKICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vICBXZSBjYW4ndCBkbyBhbnl0aGluZyBhYm91dCB0aGUgc3RhdHVzIGJhcnMgaW4gaVBhZHMsIHdlYiBhcHBzIG9yIGRlc2t0b3BzCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UuaVBhZCA9PT0gZmFsc2UgJiYgdGhpcy5nYW1lLmRldmljZS53ZWJBcHAgPT09IGZhbHNlICYmIHRoaXMuZ2FtZS5kZXZpY2UuZGVza3RvcCA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS5hbmRyb2lkICYmIHRoaXMuZ2FtZS5kZXZpY2UuY2hyb21lID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2luZG93LnNjcm9sbFRvKDAsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2luZG93LnNjcm9sbFRvKDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fY2hlY2sgPT0gbnVsbCAmJiB0aGlzLm1heEl0ZXJhdGlvbnMgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faXRlcmF0aW9ucyA9IHRoaXMubWF4SXRlcmF0aW9uczsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLl9jaGVjayA9IHdpbmRvdy5zZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuc2V0U2NyZWVuU2l6ZSgpOwogICAgICAgICAgICB9LCAxMCk7CgogICAgICAgICAgICB0aGlzLnNldFNjcmVlblNpemUoKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU2V0IHNjcmVlbiBzaXplIGF1dG9tYXRpY2FsbHkgYmFzZWQgb24gdGhlIHNjYWxlTW9kZS4KICAgICogQHBhcmFtIHtib29sZWFufSBmb3JjZSAtIElmIGZvcmNlIGlzIHRydWUgaXQgd2lsbCB0cnkgdG8gcmVzaXplIHRoZSBnYW1lIHJlZ2FyZGxlc3Mgb2YgdGhlIGRvY3VtZW50IGRpbWVuc2lvbnMuCiAgICAqLwogICAgc2V0U2NyZWVuU2l6ZTogZnVuY3Rpb24gKGZvcmNlKSB7CgogICAgICAgIGlmICh0eXBlb2YgZm9yY2UgPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICBmb3JjZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS5pUGFkID09PSBmYWxzZSAmJiB0aGlzLmdhbWUuZGV2aWNlLndlYkFwcCA9PT0gZmFsc2UgJiYgdGhpcy5nYW1lLmRldmljZS5kZXNrdG9wID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLmFuZHJvaWQgJiYgdGhpcy5nYW1lLmRldmljZS5jaHJvbWUgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuX2l0ZXJhdGlvbnMtLTsKCiAgICAgICAgaWYgKGZvcmNlIHx8IHdpbmRvdy5pbm5lckhlaWdodCA+IHRoaXMuX3N0YXJ0SGVpZ2h0IHx8IHRoaXMuX2l0ZXJhdGlvbnMgPCAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gU2V0IG1pbmltdW0gaGVpZ2h0IG9mIGNvbnRlbnQgdG8gbmV3IHdpbmRvdyBoZWlnaHQKICAgICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WydzdHlsZSddLm1pbkhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCArICdweCc7CiAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uID09PSB0cnVlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1heGltdW0oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICghdGhpcy5pc0Z1bGxTY3JlZW4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZ2Uuc2NhbGVNb2RlID09IFBoYXNlci5TdGFnZVNjYWxlTW9kZS5FWEFDVF9GSVQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRFeGFjdEZpdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5nYW1lLnN0YWdlLnNjYWxlTW9kZSA9PSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuU0hPV19BTEwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTaG93QWxsKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnN0YWdlLmZ1bGxTY3JlZW5TY2FsZU1vZGUgPT0gUGhhc2VyLlN0YWdlU2NhbGVNb2RlLkVYQUNUX0ZJVCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEV4YWN0Rml0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmdhbWUuc3RhZ2UuZnVsbFNjcmVlblNjYWxlTW9kZSA9PSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuU0hPV19BTEwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTaG93QWxsKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc2V0U2l6ZSgpOwogICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrKTsKICAgICAgICAgICAgdGhpcy5fY2hlY2sgPSBudWxsOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBjYW52YXMgc3R5bGUgd2lkdGggYW5kIGhlaWdodCB2YWx1ZXMgYmFzZWQgb24gbWluV2lkdGgvSGVpZ2h0IGFuZCBtYXhXaWR0aC9IZWlnaHQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI3NldFNpemUKICAgICovCiAgICBzZXRTaXplOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLm1heFdpZHRoICYmIHRoaXMud2lkdGggPiB0aGlzLm1heFdpZHRoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5tYXhXaWR0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWF4SGVpZ2h0ICYmIHRoaXMuaGVpZ2h0ID4gdGhpcy5tYXhIZWlnaHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy5tYXhIZWlnaHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLm1pbldpZHRoICYmIHRoaXMud2lkdGggPCB0aGlzLm1pbldpZHRoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5taW5XaWR0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWluSGVpZ2h0ICYmIHRoaXMuaGVpZ2h0IDwgdGhpcy5taW5IZWlnaHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy5taW5IZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuZ2FtZS5jYW52YXMuc3R5bGUud2lkdGggPSB0aGlzLndpZHRoICsgJ3B4JzsKICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLmhlaWdodCA9IHRoaXMuaGVpZ2h0ICsgJ3B4JzsKICAgICAgICAKICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc2NhbGUuc2V0VG8odGhpcy5nYW1lLndpZHRoIC8gdGhpcy53aWR0aCwgdGhpcy5nYW1lLmhlaWdodCAvIHRoaXMuaGVpZ2h0KTsKCiAgICAgICAgaWYgKHRoaXMucGFnZUFsaWduSG9yaXpvbnRhbGx5KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMud2lkdGggPCB3aW5kb3cuaW5uZXJXaWR0aCAmJiB0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5tYXJnaW4ueCA9IE1hdGgucm91bmQoKHdpbmRvdy5pbm5lcldpZHRoIC0gdGhpcy53aWR0aCkgLyAyKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW52YXMuc3R5bGUubWFyZ2luTGVmdCA9IHRoaXMubWFyZ2luLnggKyAncHgnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5tYXJnaW4ueCA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLm1hcmdpbkxlZnQgPSAnMHB4JzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucGFnZUFsaWduVmVydGljYWxseSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmhlaWdodCA8IHdpbmRvdy5pbm5lckhlaWdodCAmJiB0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5tYXJnaW4ueSA9IE1hdGgucm91bmQoKHdpbmRvdy5pbm5lckhlaWdodCAtIHRoaXMuaGVpZ2h0KSAvIDIpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhbnZhcy5zdHlsZS5tYXJnaW5Ub3AgPSB0aGlzLm1hcmdpbi55ICsgJ3B4JzsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMubWFyZ2luLnkgPSAwOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhbnZhcy5zdHlsZS5tYXJnaW5Ub3AgPSAnMHB4JzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgUGhhc2VyLkNhbnZhcy5nZXRPZmZzZXQodGhpcy5nYW1lLmNhbnZhcywgdGhpcy5nYW1lLnN0YWdlLm9mZnNldCk7CiAgICAgICAgCiAgICAgICAgdGhpcy5hc3BlY3RSYXRpbyA9IHRoaXMud2lkdGggLyB0aGlzLmhlaWdodDsKICAgICAgICAKICAgICAgICB0aGlzLnNjYWxlRmFjdG9yLnggPSB0aGlzLmdhbWUud2lkdGggLyB0aGlzLndpZHRoOwogICAgICAgIHRoaXMuc2NhbGVGYWN0b3IueSA9IHRoaXMuZ2FtZS5oZWlnaHQgLyB0aGlzLmhlaWdodDsKCiAgICAgICAgdGhpcy5zY2FsZUZhY3RvckludmVyc2VkLnggPSB0aGlzLndpZHRoIC8gdGhpcy5nYW1lLndpZHRoOwogICAgICAgIHRoaXMuc2NhbGVGYWN0b3JJbnZlcnNlZC55ID0gdGhpcy5oZWlnaHQgLyB0aGlzLmdhbWUuaGVpZ2h0OwoKICAgICAgICB0aGlzLmhhc1Jlc2l6ZWQuZGlzcGF0Y2godGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoKICAgICAgICB0aGlzLmNoZWNrT3JpZW50YXRpb25TdGF0ZSgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhpcy53aWR0aCBlcXVhbCB0byB3aW5kb3cuaW5uZXJXaWR0aCBhbmQgdGhpcy5oZWlnaHQgZXF1YWwgdG8gd2luZG93LmlubmVySGVpZ2h0CiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI3NldE1heGltdW0KICAgICovCiAgICBzZXRNYXhpbXVtOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMud2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICB0aGlzLmhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxjdWxhdGVzIHRoZSBtdWx0aXBsaWVyIG5lZWRlZCB0byBzY2FsZSB0aGUgZ2FtZSBwcm9wb3J0aW9uYWxseS4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjc2V0U2hvd0FsbAogICAgKi8KICAgIHNldFNob3dBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIG11bHRpcGxpZXIgPSBNYXRoLm1pbigod2luZG93LmlubmVySGVpZ2h0IC8gdGhpcy5nYW1lLmhlaWdodCksICh3aW5kb3cuaW5uZXJXaWR0aCAvIHRoaXMuZ2FtZS53aWR0aCkpOwoKICAgICAgICB0aGlzLndpZHRoID0gTWF0aC5yb3VuZCh0aGlzLmdhbWUud2lkdGggKiBtdWx0aXBsaWVyKTsKICAgICAgICB0aGlzLmhlaWdodCA9IE1hdGgucm91bmQodGhpcy5nYW1lLmhlaWdodCAqIG11bHRpcGxpZXIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIHdpZHRoIGFuZCBoZWlnaHQgdmFsdWVzIG9mIHRoZSBjYW52YXMsIG5vIGxhcmdlciB0aGFuIHRoZSBtYXhXaWR0aC9IZWlnaHQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI3NldEV4YWN0Rml0CiAgICAqLwogICAgc2V0RXhhY3RGaXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIGF2YWlsYWJsZVdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgdmFyIGF2YWlsYWJsZUhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDsKCiAgICAgICAgaWYgKHRoaXMubWF4V2lkdGggJiYgYXZhaWxhYmxlV2lkdGggPiB0aGlzLm1heFdpZHRoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMubWF4V2lkdGg7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSBhdmFpbGFibGVXaWR0aDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm1heEhlaWdodCAmJiBhdmFpbGFibGVIZWlnaHQgPiB0aGlzLm1heEhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy5tYXhIZWlnaHQ7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gYXZhaWxhYmxlSGVpZ2h0OwogICAgICAgIH0KCiAgICB9Cgp9OwoKUGhhc2VyLlN0YWdlU2NhbGVNb2RlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5TdGFnZVNjYWxlTW9kZTsKCi8qKgoqIEBuYW1lIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNpc0Z1bGxTY3JlZW4KKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzRnVsbFNjcmVlbiAtIFJldHVybnMgdHJ1ZSBpZiB0aGUgYnJvd3NlciBpcyBpbiBmdWxsIHNjcmVlbiBtb2RlLCBvdGhlcndpc2UgZmFsc2UuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3RhZ2VTY2FsZU1vZGUucHJvdG90eXBlLCAiaXNGdWxsU2NyZWVuIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4gKGRvY3VtZW50WydmdWxsc2NyZWVuRWxlbWVudCddIHx8IGRvY3VtZW50Wydtb3pGdWxsU2NyZWVuRWxlbWVudCddIHx8IGRvY3VtZW50Wyd3ZWJraXRGdWxsc2NyZWVuRWxlbWVudCddKQoKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2lzUG9ydHJhaXQKKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzUG9ydHJhaXQgLSBSZXR1cm5zIHRydWUgaWYgdGhlIGJyb3dzZXIgZGltZW5zaW9ucyBtYXRjaCBhIHBvcnRyYWl0IGRpc3BsYXkuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3RhZ2VTY2FsZU1vZGUucHJvdG90eXBlLCAiaXNQb3J0cmFpdCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5vcmllbnRhdGlvbiA9PT0gMCB8fCB0aGlzLm9yaWVudGF0aW9uID09IDE4MDsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2lzTGFuZHNjYXBlCiogQHByb3BlcnR5IHtib29sZWFufSBpc0xhbmRzY2FwZSAtIFJldHVybnMgdHJ1ZSBpZiB0aGUgYnJvd3NlciBkaW1lbnNpb25zIG1hdGNoIGEgbGFuZHNjYXBlIGRpc3BsYXkuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3RhZ2VTY2FsZU1vZGUucHJvdG90eXBlLCAiaXNMYW5kc2NhcGUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMub3JpZW50YXRpb24gPT09IDkwIHx8IHRoaXMub3JpZW50YXRpb24gPT09IC05MDsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogRGV0ZWN0cyBkZXZpY2Ugc3VwcG9ydCBjYXBhYmlsaXRpZXMuIFVzaW5nIHNvbWUgZWxlbWVudHMgZnJvbSBTeXN0ZW0uanMgYnkgTXJEb29iIGFuZCBNb2Rlcm5penIKKgoqIEBjbGFzcyBQaGFzZXIuRGV2aWNlCiogQGNvbnN0cnVjdG9yCiovCgpQaGFzZXIuRGV2aWNlID0gZnVuY3Rpb24gKCkgewoKICAgIC8qKgogICAgKiBBbiBvcHRpb25hbCAnZml4JyBmb3IgdGhlIGhvcnJlbmRvdXMgQW5kcm9pZCBzdG9jayBicm93c2VyIGJ1ZyBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2FuZHJvaWQvaXNzdWVzL2RldGFpbD9pZD0zOTI0NwogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHBhdGNoQW5kcm9pZENsZWFyUmVjdEJ1ZyAtIERlc2NyaXB0aW9uLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGF0Y2hBbmRyb2lkQ2xlYXJSZWN0QnVnID0gZmFsc2U7CgogICAgLy8gIE9wZXJhdGluZyBTeXN0ZW0KCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBkZXNrdG9wIC0gSXMgcnVubmluZyBkZXNrdG9wPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGVza3RvcCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlPUyAtIElzIHJ1bm5pbmcgb24gaU9TPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaU9TID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29jb29uSlMgLSBJcyB0aGUgZ2FtZSBydW5uaW5nIHVuZGVyIENvY29vbkpTPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29jb29uSlMgPSBmYWxzZTsKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZWplY3RhIC0gSXMgdGhlIGdhbWUgcnVubmluZyB1bmRlciBFamVjdGE/CiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLmVqZWN0YSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFuZHJvaWQgLSBJcyBydW5uaW5nIG9uIGFuZHJvaWQ/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbmRyb2lkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY2hyb21lT1MgLSBJcyBydW5uaW5nIG9uIGNocm9tZU9TPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2hyb21lT1MgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBsaW51eCAtIElzIHJ1bm5pbmcgb24gbGludXg/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5saW51eCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG1hY09TIC0gSXMgcnVubmluZyBvbiBtYWNPUz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1hY09TID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gd2luZG93cyAtIElzIHJ1bm5pbmcgb24gd2luZG93cz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndpbmRvd3MgPSBmYWxzZTsKCiAgICAvLyAgRmVhdHVyZXMKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjYW52YXMgLSBJcyBjYW52YXMgYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2FudmFzID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZmlsZSAtIElzIGZpbGUgYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZmlsZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZpbGVTeXN0ZW0gLSBJcyBmaWxlU3lzdGVtIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZpbGVTeXN0ZW0gPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBsb2NhbFN0b3JhZ2UgLSBJcyBsb2NhbFN0b3JhZ2UgYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubG9jYWxTdG9yYWdlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gd2ViR0wgLSBJcyB3ZWJHTCBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy53ZWJHTCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHdvcmtlciAtIElzIHdvcmtlciBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy53b3JrZXIgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB0b3VjaCAtIElzIHRvdWNoIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRvdWNoID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbXNwb2ludGVyIC0gSXMgbXNwb2ludGVyIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1zcG9pbnRlciA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNzczNEIC0gSXMgY3NzM0QgYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY3NzM0QgPSBmYWxzZTsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcG9pbnRlckxvY2sgLSBJcyBQb2ludGVyIExvY2sgYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucG9pbnRlckxvY2sgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB0eXBlZEFycmF5IC0gRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IFR5cGVkQXJyYXlzPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudHlwZWRBcnJheSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHZpYnJhdGlvbiAtIERvZXMgdGhlIGRldmljZSBzdXBwb3J0IHRoZSBWaWJyYXRpb24gQVBJPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudmlicmF0aW9uID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcXVpcmtzTW9kZSAtIElzIHRoZSBicm93c2VyIHJ1bm5pbmcgaW4gc3RyaWN0IG1vZGUgKGZhbHNlKSBvciBxdWlya3MgbW9kZT8gKHRydWUpCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5xdWlya3NNb2RlID0gZmFsc2U7CgogICAgLy8gIEJyb3dzZXIKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhcm9yYSAtIFNldCB0byB0cnVlIGlmIHJ1bm5pbmcgaW4gQXJvcmEuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hcm9yYSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNocm9tZSAtIFNldCB0byB0cnVlIGlmIHJ1bm5pbmcgaW4gQ2hyb21lLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2hyb21lID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZXBpcGhhbnkgLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGluIEVwaXBoYW55LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZXBpcGhhbnkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBmaXJlZm94IC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBGaXJlZm94LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZmlyZWZveCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGllIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBJbnRlcm5ldCBFeHBsb3Jlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmllID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpZVZlcnNpb24gLSBJZiBydW5uaW5nIGluIEludGVybmV0IEV4cGxvcmVyIHRoaXMgd2lsbCBjb250YWluIHRoZSBtYWpvciB2ZXJzaW9uIG51bWJlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmllVmVyc2lvbiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdHJpZGVudCAtIFNldCB0byB0cnVlIGlmIHJ1bm5pbmcgYSBUcmlkZW50IHZlcnNpb24gb2YgSW50ZXJuZXQgRXhwbG9yZXIgKElFMTErKQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudHJpZGVudCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdHJpZGVudFZlcnNpb24gLSBJZiBydW5uaW5nIGluIEludGVybmV0IEV4cGxvcmVyIDExIHRoaXMgd2lsbCBjb250YWluIHRoZSBtYWpvciB2ZXJzaW9uIG51bWJlci4gU2VlIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9tczUzNzUwMyh2PXZzLjg1KS5hc3B4CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50cmlkZW50VmVyc2lvbiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbW9iaWxlU2FmYXJpIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBNb2JpbGUgU2FmYXJpLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubW9iaWxlU2FmYXJpID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbWlkb3JpIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBNaWRvcmkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5taWRvcmkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBvcGVyYSAtIFNldCB0byB0cnVlIGlmIHJ1bm5pbmcgaW4gT3BlcmEuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vcGVyYSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHNhZmFyaSAtIFNldCB0byB0cnVlIGlmIHJ1bm5pbmcgaW4gU2FmYXJpLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc2FmYXJpID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gd2ViQXBwIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBhcyBhIFdlYkFwcCwgaS5lLiB3aXRoaW4gYSBXZWJWaWV3CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy53ZWJBcHAgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBzaWxrIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiB0aGUgU2lsayBicm93c2VyIChhcyB1c2VkIG9uIHRoZSBBbWF6b24gS2luZGxlKQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc2lsayA9IGZhbHNlOwoKICAgIC8vICBBdWRpbwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGF1ZGlvRGF0YSAtIEFyZSBBdWRpbyB0YWdzIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmF1ZGlvRGF0YSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHdlYkF1ZGlvIC0gSXMgdGhlIFdlYkF1ZGlvIEFQSSBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy53ZWJBdWRpbyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG9nZyAtIENhbiB0aGlzIGRldmljZSBwbGF5IG9nZyBmaWxlcz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9nZyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG9wdXMgLSBDYW4gdGhpcyBkZXZpY2UgcGxheSBvcHVzIGZpbGVzPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub3B1cyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG1wMyAtIENhbiB0aGlzIGRldmljZSBwbGF5IG1wMyBmaWxlcz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1wMyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHdhdiAtIENhbiB0aGlzIGRldmljZSBwbGF5IHdhdiBmaWxlcz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndhdiA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBDYW4gdGhpcyBkZXZpY2UgcGxheSBtNGEgZmlsZXM/CiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbTRhIC0gVHJ1ZSBpZiB0aGlzIGRldmljZSBjYW4gcGxheSBtNGEgZmlsZXMuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tNGEgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB3ZWJtIC0gQ2FuIHRoaXMgZGV2aWNlIHBsYXkgd2VibSBmaWxlcz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndlYm0gPSBmYWxzZTsKCiAgICAvLyAgRGV2aWNlCgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaVBob25lIC0gSXMgcnVubmluZyBvbiBpUGhvbmU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pUGhvbmUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpUGhvbmU0IC0gSXMgcnVubmluZyBvbiBpUGhvbmU0PwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaVBob25lNCA9IGZhbHNlOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpUGFkIC0gSXMgcnVubmluZyBvbiBpUGFkPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaVBhZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGl4ZWxSYXRpbyAtIFBpeGVsUmF0aW8gb2YgdGhlIGhvc3QgZGV2aWNlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGl4ZWxSYXRpbyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbGl0dGxlRW5kaWFuIC0gSXMgdGhlIGRldmljZSBiaWcgb3IgbGl0dGxlIGVuZGlhbj8gKG9ubHkgZGV0ZWN0ZWQgaWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgVHlwZWRBcnJheXMpCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5saXR0bGVFbmRpYW4gPSBmYWxzZTsKCiAgICAvLyAgUnVuIHRoZSBjaGVja3MKICAgIHRoaXMuX2NoZWNrQXVkaW8oKTsKICAgIHRoaXMuX2NoZWNrQnJvd3NlcigpOwogICAgdGhpcy5fY2hlY2tDU1MzRCgpOwogICAgdGhpcy5fY2hlY2tEZXZpY2UoKTsKICAgIHRoaXMuX2NoZWNrRmVhdHVyZXMoKTsKICAgIHRoaXMuX2NoZWNrT1MoKTsKICAgIAp9OwoKUGhhc2VyLkRldmljZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIENoZWNrIHdoaWNoIE9TIGlzIGdhbWUgcnVubmluZyBvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI19jaGVja09TCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX2NoZWNrT1M6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKCiAgICAgICAgaWYgKC9BbmRyb2lkLy50ZXN0KHVhKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYW5kcm9pZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9Dck9TLy50ZXN0KHVhKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2hyb21lT1MgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgvaVBbYW9dZHxpUGhvbmUvaS50ZXN0KHVhKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuaU9TID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoL0xpbnV4Ly50ZXN0KHVhKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubGludXggPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgvTWFjIE9TLy50ZXN0KHVhKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubWFjT1MgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgvV2luZG93cy8udGVzdCh1YSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndpbmRvd3MgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMud2luZG93cyB8fCB0aGlzLm1hY09TIHx8ICh0aGlzLmxpbnV4ICYmIHRoaXMuc2lsayA9PT0gZmFsc2UpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5kZXNrdG9wID0gdHJ1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgSFRNTDUgZmVhdHVyZXMgb2YgdGhlIGhvc3QgZW52aXJvbm1lbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLkRldmljZSNfY2hlY2tGZWF0dXJlcwogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIF9jaGVja0ZlYXR1cmVzOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuY2FudmFzID0gISF3aW5kb3dbJ0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCddOwoKICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZSA9ICEhbG9jYWxTdG9yYWdlLmdldEl0ZW07CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgdGhpcy5sb2NhbFN0b3JhZ2UgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZmlsZSA9ICEhd2luZG93WydGaWxlJ10gJiYgISF3aW5kb3dbJ0ZpbGVSZWFkZXInXSAmJiAhIXdpbmRvd1snRmlsZUxpc3QnXSAmJiAhIXdpbmRvd1snQmxvYiddOwogICAgICAgIHRoaXMuZmlsZVN5c3RlbSA9ICEhd2luZG93WydyZXF1ZXN0RmlsZVN5c3RlbSddOwogICAgICAgIHRoaXMud2ViR0wgPSAoIGZ1bmN0aW9uICgpIHsgdHJ5IHsgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdjYW52YXMnICk7IHJldHVybiAhISB3aW5kb3cuV2ViR0xSZW5kZXJpbmdDb250ZXh0ICYmICggY2FudmFzLmdldENvbnRleHQoICd3ZWJnbCcgKSB8fCBjYW52YXMuZ2V0Q29udGV4dCggJ2V4cGVyaW1lbnRhbC13ZWJnbCcgKSApOyB9IGNhdGNoKCBlICkgeyByZXR1cm4gZmFsc2U7IH0gfSApKCk7CgogICAgICAgIGlmICh0aGlzLndlYkdMID09PSBudWxsIHx8IHRoaXMud2ViR0wgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy53ZWJHTCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndlYkdMID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHRoaXMud29ya2VyID0gISF3aW5kb3dbJ1dvcmtlciddOwogICAgICAgIAogICAgICAgIGlmICgnb250b3VjaHN0YXJ0JyBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgfHwgKHdpbmRvdy5uYXZpZ2F0b3IubWF4VG91Y2hQb2ludHMgJiYgd2luZG93Lm5hdmlnYXRvci5tYXhUb3VjaFBvaW50cyA+IDEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50b3VjaCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAod2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkIHx8IHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm1zcG9pbnRlciA9IHRydWU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMucG9pbnRlckxvY2sgPSAncG9pbnRlckxvY2tFbGVtZW50JyBpbiBkb2N1bWVudCB8fCAnbW96UG9pbnRlckxvY2tFbGVtZW50JyBpbiBkb2N1bWVudCB8fCAnd2Via2l0UG9pbnRlckxvY2tFbGVtZW50JyBpbiBkb2N1bWVudDsKCiAgICAgICAgdGhpcy5xdWlya3NNb2RlID0gKGRvY3VtZW50LmNvbXBhdE1vZGUgPT09ICdDU1MxQ29tcGF0JykgPyBmYWxzZSA6IHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgd2hhdCBicm93c2VyIGlzIGdhbWUgcnVubmluZyBpbi4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI19jaGVja0Jyb3dzZXIKICAgICogQHByaXZhdGUKICAgICovCiAgICBfY2hlY2tCcm93c2VyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CgogICAgICAgIGlmICgvQXJvcmEvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hcm9yYSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9DaHJvbWUvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jaHJvbWUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgvRXBpcGhhbnkvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lcGlwaGFueSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9GaXJlZm94Ly50ZXN0KHVhKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZmlyZWZveCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9Nb2JpbGUgU2FmYXJpLy50ZXN0KHVhKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubW9iaWxlU2FmYXJpID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoL01TSUUgKFxkK1wuXGQrKTsvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5pZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuaWVWZXJzaW9uID0gcGFyc2VJbnQoUmVnRXhwLiQxLCAxMCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9NaWRvcmkvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5taWRvcmkgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgvT3BlcmEvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vcGVyYSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9TYWZhcmkvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zYWZhcmkgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgvU2lsay8udGVzdCh1YSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNpbGsgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgvVHJpZGVudFwvKFxkK1wuXGQrKTsvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5pZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudHJpZGVudCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudHJpZGVudFZlcnNpb24gPSBwYXJzZUludChSZWdFeHAuJDEsIDEwKTsKICAgICAgICB9CgogICAgICAgIC8vIFdlYkFwcCBtb2RlIGluIGlPUwogICAgICAgIGlmIChuYXZpZ2F0b3JbJ3N0YW5kYWxvbmUnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud2ViQXBwID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmIChuYXZpZ2F0b3JbJ2lzQ29jb29uSlMnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29jb29uSlMgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cuZWplY3RhICE9PSAidW5kZWZpbmVkIikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZWplY3RhID0gdHJ1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgYXVkaW8gc3VwcG9ydC4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI19jaGVja0F1ZGlvCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX2NoZWNrQXVkaW86IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5hdWRpb0RhdGEgPSAhISh3aW5kb3dbJ0F1ZGlvJ10pOwogICAgICAgIHRoaXMud2ViQXVkaW8gPSAhISh3aW5kb3dbJ3dlYmtpdEF1ZGlvQ29udGV4dCddIHx8IHdpbmRvd1snQXVkaW9Db250ZXh0J10pOwogICAgICAgIHZhciBhdWRpb0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhdWRpbycpOwogICAgICAgIHZhciByZXN1bHQgPSBmYWxzZTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKHJlc3VsdCA9ICEhYXVkaW9FbGVtZW50LmNhblBsYXlUeXBlKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUoJ2F1ZGlvL29nZzsgY29kZWNzPSJ2b3JiaXMiJykucmVwbGFjZSgvXm5vJC8sICcnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub2dnID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYXVkaW9FbGVtZW50LmNhblBsYXlUeXBlKCdhdWRpby9vZ2c7IGNvZGVjcz0ib3B1cyInKS5yZXBsYWNlKC9ebm8kLywgJycpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYXVkaW9FbGVtZW50LmNhblBsYXlUeXBlKCdhdWRpby9tcGVnOycpLnJlcGxhY2UoL15ubyQvLCAnJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1wMyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTWltZXR5cGVzIGFjY2VwdGVkOgogICAgICAgICAgICAgICAgLy8gICBkZXZlbG9wZXIubW96aWxsYS5vcmcvRW4vTWVkaWFfZm9ybWF0c19zdXBwb3J0ZWRfYnlfdGhlX2F1ZGlvX2FuZF92aWRlb19lbGVtZW50cwogICAgICAgICAgICAgICAgLy8gICBiaXQubHkvaXBob25lb3Njb2RlY3MKICAgICAgICAgICAgICAgIGlmIChhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUoJ2F1ZGlvL3dhdjsgY29kZWNzPSIxIicpLnJlcGxhY2UoL15ubyQvLCAnJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLndhdiA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGF1ZGlvRWxlbWVudC5jYW5QbGF5VHlwZSgnYXVkaW8veC1tNGE7JykgfHwgYXVkaW9FbGVtZW50LmNhblBsYXlUeXBlKCdhdWRpby9hYWM7JykucmVwbGFjZSgvXm5vJC8sICcnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubTRhID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYXVkaW9FbGVtZW50LmNhblBsYXlUeXBlKCdhdWRpby93ZWJtOyBjb2RlY3M9InZvcmJpcyInKS5yZXBsYWNlKC9ebm8kLywgJycpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy53ZWJtID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgUGl4ZWxSYXRpbyBvZiBkZXZpY2VzLgogICAgKiBAbWV0aG9kIFBoYXNlci5EZXZpY2UjX2NoZWNrRGV2aWNlCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX2NoZWNrRGV2aWNlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMucGl4ZWxSYXRpbyA9IHdpbmRvd1snZGV2aWNlUGl4ZWxSYXRpbyddIHx8IDE7CiAgICAgICAgdGhpcy5pUGhvbmUgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZignaXBob25lJykgIT0gLTE7CiAgICAgICAgdGhpcy5pUGhvbmU0ID0gKHRoaXMucGl4ZWxSYXRpbyA9PSAyICYmIHRoaXMuaVBob25lKTsKICAgICAgICB0aGlzLmlQYWQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZignaXBhZCcpICE9IC0xOwoKICAgICAgICBpZiAodHlwZW9mIEludDhBcnJheSAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxpdHRsZUVuZGlhbiA9IG5ldyBJbnQ4QXJyYXkobmV3IEludDE2QXJyYXkoWzFdKS5idWZmZXIpWzBdID4gMDsKICAgICAgICAgICAgdGhpcy50eXBlZEFycmF5ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5saXR0bGVFbmRpYW4gPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy50eXBlZEFycmF5ID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBuYXZpZ2F0b3IudmlicmF0ZSA9IG5hdmlnYXRvci52aWJyYXRlIHx8IG5hdmlnYXRvci53ZWJraXRWaWJyYXRlIHx8IG5hdmlnYXRvci5tb3pWaWJyYXRlIHx8IG5hdmlnYXRvci5tc1ZpYnJhdGU7CiAgICAgICAgIAogICAgICAgIGlmIChuYXZpZ2F0b3IudmlicmF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudmlicmF0aW9uID0gdHJ1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgd2hldGhlciB0aGUgaG9zdCBlbnZpcm9ubWVudCBzdXBwb3J0IDNEIENTUy4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI19jaGVja0NTUzNECiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX2NoZWNrQ1NTM0Q6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpOwogICAgICAgIHZhciBoYXMzZDsKICAgICAgICB2YXIgdHJhbnNmb3JtcyA9IHsKICAgICAgICAgICAgJ3dlYmtpdFRyYW5zZm9ybSc6ICctd2Via2l0LXRyYW5zZm9ybScsCiAgICAgICAgICAgICdPVHJhbnNmb3JtJzogJy1vLXRyYW5zZm9ybScsCiAgICAgICAgICAgICdtc1RyYW5zZm9ybSc6ICctbXMtdHJhbnNmb3JtJywKICAgICAgICAgICAgJ01velRyYW5zZm9ybSc6ICctbW96LXRyYW5zZm9ybScsCiAgICAgICAgICAgICd0cmFuc2Zvcm0nOiAndHJhbnNmb3JtJwogICAgICAgIH07CgogICAgICAgIC8vIEFkZCBpdCB0byB0aGUgYm9keSB0byBnZXQgdGhlIGNvbXB1dGVkIHN0eWxlLgogICAgICAgIGRvY3VtZW50LmJvZHkuaW5zZXJ0QmVmb3JlKGVsLCBudWxsKTsKCiAgICAgICAgZm9yICh2YXIgdCBpbiB0cmFuc2Zvcm1zKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsLnN0eWxlW3RdICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVsLnN0eWxlW3RdID0gInRyYW5zbGF0ZTNkKDFweCwxcHgsMXB4KSI7CiAgICAgICAgICAgICAgICBoYXMzZCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKS5nZXRQcm9wZXJ0eVZhbHVlKHRyYW5zZm9ybXNbdF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZWwpOwogICAgICAgIHRoaXMuY3NzM0QgPSAoaGFzM2QgIT09IHVuZGVmaW5lZCAmJiBoYXMzZC5sZW5ndGggPiAwICYmIGhhczNkICE9PSAibm9uZSIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrIHdoZXRoZXIgdGhlIGhvc3QgZW52aXJvbm1lbnQgY2FuIHBsYXkgYXVkaW8uCiAgICAqIEBtZXRob2QgUGhhc2VyLkRldmljZSNjYW5QbGF5QXVkaW8KICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgLSBPbmUgb2YgJ21wMywgJ29nZycsICdtNGEnLCAnd2F2JywgJ3dlYm0nLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBnaXZlbiBmaWxlIHR5cGUgaXMgc3VwcG9ydGVkIGJ5IHRoZSBicm93c2VyLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgY2FuUGxheUF1ZGlvOiBmdW5jdGlvbiAodHlwZSkgewoKICAgICAgICBpZiAodHlwZSA9PSAnbXAzJyAmJiB0aGlzLm1wMykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICdvZ2cnICYmICh0aGlzLm9nZyB8fCB0aGlzLm9wdXMpKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gJ200YScgJiYgdGhpcy5tNGEpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAnd2F2JyAmJiB0aGlzLndhdikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICd3ZWJtJyAmJiB0aGlzLndlYm0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayB3aGV0aGVyIHRoZSBjb25zb2xlIGlzIG9wZW4uCiAgICAqIEBtZXRob2QgUGhhc2VyLkRldmljZSNpc0NvbnNvbGVPcGVuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGJyb3dzZXIgZGV2IGNvbnNvbGUgaXMgb3Blbi4KICAgICovCiAgICBpc0NvbnNvbGVPcGVuOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh3aW5kb3cuY29uc29sZSAmJiB3aW5kb3cuY29uc29sZVsnZmlyZWJ1ZyddKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAod2luZG93LmNvbnNvbGUpCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLnByb2ZpbGUoKTsKICAgICAgICAgICAgY29uc29sZS5wcm9maWxlRW5kKCk7CgogICAgICAgICAgICBpZiAoY29uc29sZS5jbGVhcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29uc29sZS5jbGVhcigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gY29uc29sZVsncHJvZmlsZXMnXS5sZW5ndGggPiAwOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0KCn07CgpQaGFzZXIuRGV2aWNlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5EZXZpY2U7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBYnN0cmFjdHMgYXdheSB0aGUgdXNlIG9mIFJBRiBvciBzZXRUaW1lT3V0IGZvciB0aGUgY29yZSBnYW1lIHVwZGF0ZSBsb29wLgoqCiogQGNsYXNzIFBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUgCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gZnVuY3Rpb24oZ2FtZSkgewogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIFRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNSdW5uaW5nIC0gdHJ1ZSBpZiBSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgaXMgcnVubmluZywgb3RoZXJ3aXNlIGZhbHNlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNSdW5uaW5nID0gZmFsc2U7CgogICAgdmFyIHZlbmRvcnMgPSBbCiAgICAgICAgJ21zJywKICAgICAgICAnbW96JywKICAgICAgICAnd2Via2l0JywKICAgICAgICAnbycKICAgIF07CgogICAgZm9yICh2YXIgeCA9IDA7IHggPCB2ZW5kb3JzLmxlbmd0aCAmJiAhd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZTsgeCsrKQogICAgewogICAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSB3aW5kb3dbdmVuZG9yc1t4XSArICdSZXF1ZXN0QW5pbWF0aW9uRnJhbWUnXTsKICAgICAgICB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSB3aW5kb3dbdmVuZG9yc1t4XSArICdDYW5jZWxBbmltYXRpb25GcmFtZSddOwogICAgfQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9pc1NldFRpbWVPdXQgIC0gdHJ1ZSBpZiB0aGUgYnJvd3NlciBpcyB1c2luZyBzZXRUaW1lb3V0IGluc3RlYWQgb2YgcmFmLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2lzU2V0VGltZU91dCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25Mb29wIC0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBieSB0aGUgdXBkYXRlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uTG9vcCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdGltZU91dElEIC0gVGhlIGNhbGxiYWNrIElEIHVzZWQgd2hlbiBjYWxsaW5nIGNhbmNlbC4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90aW1lT3V0SUQgPSBudWxsOwoKfTsKClBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBTdGFydHMgdGhlIHJlcXVlc3RBbmltYXRpb25GcmFtZSBydW5uaW5nIG9yIHNldFRpbWVvdXQgaWYgdW5hdmFpbGFibGUgaW4gYnJvd3NlcgogICAgKiBAbWV0aG9kIFBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUjc3RhcnQKICAgICovCiAgICBzdGFydDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmlzUnVubmluZyA9IHRydWU7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIGlmICghd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2lzU2V0VGltZU91dCA9IHRydWU7CgogICAgICAgICAgICB0aGlzLl9vbkxvb3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlU2V0VGltZW91dCgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5fdGltZU91dElEID0gd2luZG93LnNldFRpbWVvdXQodGhpcy5fb25Mb29wLCAwKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faXNTZXRUaW1lT3V0ID0gZmFsc2U7CgogICAgICAgICAgICB0aGlzLl9vbkxvb3AgPSBmdW5jdGlvbiAodGltZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnVwZGF0ZVJBRih0aW1lKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuX3RpbWVPdXRJRCA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5fb25Mb29wKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIHVwZGF0ZSBtZXRob2QgZm9yIHRoZSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUKICAgICogQG1ldGhvZCBQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lI3VwZGF0ZVJBRiAgICAKICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbWUgLSBBIHRpbWVzdGFtcCwgZWl0aGVyIGZyb20gUkFGIG9yIHNldFRpbWVPdXQKICAgICovCiAgICB1cGRhdGVSQUY6IGZ1bmN0aW9uICh0aW1lKSB7CgogICAgICAgIHRoaXMuZ2FtZS51cGRhdGUodGltZSk7CgogICAgICAgIHRoaXMuX3RpbWVPdXRJRCA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5fb25Mb29wKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgdXBkYXRlIG1ldGhvZCBmb3IgdGhlIHNldFRpbWVvdXQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSN1cGRhdGVTZXRUaW1lb3V0CiAgICAqLwogICAgdXBkYXRlU2V0VGltZW91dDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmdhbWUudXBkYXRlKERhdGUubm93KCkpOwoKICAgICAgICB0aGlzLl90aW1lT3V0SUQgPSB3aW5kb3cuc2V0VGltZW91dCh0aGlzLl9vbkxvb3AsIHRoaXMuZ2FtZS50aW1lLnRpbWVUb0NhbGwpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3BzIHRoZSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgZnJvbSBydW5uaW5nLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUjc3RvcAogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX2lzU2V0VGltZU91dCkKICAgICAgICB7CiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lT3V0SUQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5fdGltZU91dElEKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuaXNSdW5uaW5nID0gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogSXMgdGhlIGJyb3dzZXIgdXNpbmcgc2V0VGltZW91dD8KICAgICogQG1ldGhvZCBQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lI2lzU2V0VGltZU91dAogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGlzU2V0VGltZU91dDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9pc1NldFRpbWVPdXQ7CiAgICB9LAoKICAgIC8qKgogICAgKiBJcyB0aGUgYnJvd3NlciB1c2luZyByZXF1ZXN0QW5pbWF0aW9uRnJhbWU/CiAgICAqIEBtZXRob2QgUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSNpc1JBRgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGlzUkFGOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLl9pc1NldFRpbWVPdXQgPT09IGZhbHNlKTsKICAgIH0KCn07CgpQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CgovKiBqc2hpbnQgbm9lbXB0eTogZmFsc2UgKi8KCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yIGNvbnN0cnVjdG9yLgoqIAoqIEBjbGFzcyBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvcgoqIEBjbGFzc2Rlc2MgQW4gZXh0cmVtZWx5IHVzZWZ1bCByZXBlYXRhYmxlIHJhbmRvbSBkYXRhIGdlbmVyYXRvci4gQWNjZXNzIGl0IHZpYSBQaGFzZXIuR2FtZS5ybmQKKiBCYXNlZCBvbiBOb25zZW5zZSBieSBKb3NoIEZhdWwgaHR0cHM6Ly9naXRodWIuY29tL2pvY2FmYS9Ob25zZW5zZS4KKiBSYW5kb20gbnVtYmVyIGdlbmVyYXRvciBmcm9tIGh0dHA6Ly9iYWFnb2Uub3JnL2VuL3dpa2kvQmV0dGVyX3JhbmRvbV9udW1iZXJzX2Zvcl9qYXZhc2NyaXB0CiogCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHthcnJheX0gc2VlZHMKKi8KUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IgPSBmdW5jdGlvbiAoc2VlZHMpIHsKICAgIAogICAgaWYgKHR5cGVvZiBzZWVkcyA9PT0gInVuZGVmaW5lZCIpIHsgc2VlZHMgPSBbXTsgfQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gYyAtIEludGVybmFsIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLmMgPSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gczAgLSBJbnRlcm5hbCB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5zMCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzMSAtIEludGVybmFsIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLnMxID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHMyIC0gSW50ZXJuYWwgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuczIgPSAwOwoKICAgIHRoaXMuc293KHNlZWRzKTsKCn07CgpQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvci5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFByaXZhdGUgcmFuZG9tIGhlbHBlci4KICAgICogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNybmQKICAgICogQHByaXZhdGUKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHJuZDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgdCA9IDIwOTE2MzkgKiB0aGlzLnMwICsgdGhpcy5jICogMi4zMjgzMDY0MzY1Mzg2OTYzZS0xMDsgLy8gMl4tMzIKCiAgICAgICAgdGhpcy5jID0gdCB8IDA7CiAgICAgICAgdGhpcy5zMCA9IHRoaXMuczE7CiAgICAgICAgdGhpcy5zMSA9IHRoaXMuczI7CiAgICAgICAgdGhpcy5zMiA9IHQgLSB0aGlzLmM7CgogICAgICAgIHJldHVybiB0aGlzLnMyOwogICAgfSwKCiAgICAvKioKICAgICogUmVzZXQgdGhlIHNlZWQgb2YgdGhlIHJhbmRvbSBkYXRhIGdlbmVyYXRvci4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3Ijc293CiAgICAqIEBwYXJhbSB7YXJyYXl9IHNlZWRzCiAgICAqLwogICAgc293OiBmdW5jdGlvbiAoc2VlZHMpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzZWVkcyA9PT0gInVuZGVmaW5lZCIpIHsgc2VlZHMgPSBbXTsgfQoKICAgICAgICB0aGlzLnMwID0gdGhpcy5oYXNoKCcgJyk7CiAgICAgICAgdGhpcy5zMSA9IHRoaXMuaGFzaCh0aGlzLnMwKTsKICAgICAgICB0aGlzLnMyID0gdGhpcy5oYXNoKHRoaXMuczEpOwogICAgICAgIHRoaXMuYyA9IDE7CgogICAgICAgIHZhciBzZWVkOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgc2VlZCA9IHNlZWRzW2krK107ICkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuczAgLT0gdGhpcy5oYXNoKHNlZWQpOwogICAgICAgICAgICB0aGlzLnMwICs9IH5+KHRoaXMuczAgPCAwKTsKICAgICAgICAgICAgdGhpcy5zMSAtPSB0aGlzLmhhc2goc2VlZCk7CiAgICAgICAgICAgIHRoaXMuczEgKz0gfn4odGhpcy5zMSA8IDApOwogICAgICAgICAgICB0aGlzLnMyIC09IHRoaXMuaGFzaChzZWVkKTsKICAgICAgICAgICAgdGhpcy5zMiArPSB+fih0aGlzLnMyIDwgMCk7CiAgICAgICAgfQogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kIHRoYXQgY3JlYXRlcyBhIHNlZWQgaGFzaC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNoYXNoCiAgICAqIEBwYXJhbSB7QW55fSBkYXRhCiAgICAqIEBwcml2YXRlCiAgICAqIEByZXR1cm4ge251bWJlcn0gaGFzaGVkIHZhbHVlLgogICAgKi8KICAgIGhhc2g6IGZ1bmN0aW9uIChkYXRhKSB7CgogICAgICAgIHZhciBoLCBpLCBuOwogICAgICAgIG4gPSAweGVmYzgyNDlkOwogICAgICAgIGRhdGEgPSBkYXRhLnRvU3RyaW5nKCk7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIG4gKz0gZGF0YS5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICBoID0gMC4wMjUxOTYwMzI4MjQxNjkzOCAqIG47CiAgICAgICAgICAgIG4gPSBoID4+PiAwOwogICAgICAgICAgICBoIC09IG47CiAgICAgICAgICAgIGggKj0gbjsKICAgICAgICAgICAgbiA9IGggPj4+IDA7CiAgICAgICAgICAgIGggLT0gbjsKICAgICAgICAgICAgbiArPSBoICogMHgxMDAwMDAwMDA7Ly8gMl4zMgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIChuID4+PiAwKSAqIDIuMzI4MzA2NDM2NTM4Njk2M2UtMTA7Ly8gMl4tMzIKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiAwIGFuZCAyXjMyLgogICAgKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI2ludGVnZXIKICAgICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSBpbnRlZ2VyIGJldHdlZW4gMCBhbmQgMl4zMi4KICAgICovCiAgICBpbnRlZ2VyOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5ybmQuYXBwbHkodGhpcykgKiAweDEwMDAwMDAwMDsvLyAyXjMyCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgcmFuZG9tIHJlYWwgbnVtYmVyIGJldHdlZW4gMCBhbmQgMS4KICAgICogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNmcmFjCiAgICAqIEByZXR1cm4ge251bWJlcn0gQSByYW5kb20gcmVhbCBudW1iZXIgYmV0d2VlbiAwIGFuZCAxLgogICAgKi8KICAgIGZyYWM6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnJuZC5hcHBseSh0aGlzKSArICh0aGlzLnJuZC5hcHBseSh0aGlzKSAqIDB4MjAwMDAwIHwgMCkgKiAxLjExMDIyMzAyNDYyNTE1NjVlLTE2Oy8vIDJeLTUzCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgcmFuZG9tIHJlYWwgbnVtYmVyIGJldHdlZW4gMCBhbmQgMl4zMi4KICAgICogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNyZWFsCiAgICAqIEByZXR1cm4ge251bWJlcn0gQSByYW5kb20gcmVhbCBudW1iZXIgYmV0d2VlbiAwIGFuZCAyXjMyLgogICAgKi8KICAgIHJlYWw6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmludGVnZXIoKSArIHRoaXMuZnJhYygpOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHJhbmRvbSBpbnRlZ2VyIGJldHdlZW4gbWluIGFuZCBtYXguCiAgICAqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IjaW50ZWdlckluUmFuZ2UKICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIHZhbHVlIGluIHRoZSByYW5nZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIGluIHRoZSByYW5nZS4KICAgICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSBudW1iZXIgYmV0d2VlbiBtaW4gYW5kIG1heC4KICAgICovCiAgICBpbnRlZ2VySW5SYW5nZTogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodGhpcy5yZWFsSW5SYW5nZShtaW4sIG1heCkpOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHJhbmRvbSByZWFsIG51bWJlciBiZXR3ZWVuIG1pbiBhbmQgbWF4LgogICAgKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI3JlYWxJblJhbmdlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSBpbiB0aGUgcmFuZ2UuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYXggLSBUaGUgbWF4aW11bSB2YWx1ZSBpbiB0aGUgcmFuZ2UuCiAgICAqIEByZXR1cm4ge251bWJlcn0gQSByYW5kb20gbnVtYmVyIGJldHdlZW4gbWluIGFuZCBtYXguCiAgICAqLwogICAgcmVhbEluUmFuZ2U6IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKICAgICAgICByZXR1cm4gdGhpcy5mcmFjKCkgKiAobWF4IC0gbWluKSArIG1pbjsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgcmFuZG9tIHJlYWwgbnVtYmVyIGJldHdlZW4gLTEgYW5kIDEuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3Ijbm9ybWFsCiAgICAqIEByZXR1cm4ge251bWJlcn0gQSByYW5kb20gcmVhbCBudW1iZXIgYmV0d2VlbiAtMSBhbmQgMS4KICAgICovCiAgICBub3JtYWw6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gMSAtIDIgKiB0aGlzLmZyYWMoKTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSB2YWxpZCBSRkM0MTIyIHZlcnNpb240IElEIGhleCBzdHJpbmcgZnJvbSBodHRwczovL2dpc3QuZ2l0aHViLmNvbS8xMzA4MzY4CiAgICAqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IjdXVpZAogICAgKiBAcmV0dXJuIHtzdHJpbmd9IEEgdmFsaWQgUkZDNDEyMiB2ZXJzaW9uNCBJRCBoZXggc3RyaW5nCiAgICAqLwogICAgdXVpZDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgYSA9ICcnOwogICAgICAgIHZhciBiID0gJyc7CgogICAgICAgIGZvciAoYiA9IGEgPSAnJzsgYSsrIDwgMzY7IGIgKz1+YSAlIDUgfCBhICogMyY0ID8gKGFeMTUgPyA4XnRoaXMuZnJhYygpICogKGFeMjAgPyAxNiA6IDQpIDogNCkudG9TdHJpbmcoMTYpIDogJy0nKQogICAgICAgIHsKICAgICAgICB9CgogICAgICAgIHJldHVybiBiOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSByYW5kb20gbWVtYmVyIG9mIGBhcnJheWAuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IjcGljawogICAgKiBAcGFyYW0ge0FycmF5fSBhcnkgLSBBbiBBcnJheSB0byBwaWNrIGEgcmFuZG9tIG1lbWJlciBvZi4KICAgICogQHJldHVybiB7YW55fSBBIHJhbmRvbSBtZW1iZXIgb2YgdGhlIGFycmF5LgogICAgKi8KICAgIHBpY2s6IGZ1bmN0aW9uIChhcnkpIHsKICAgICAgICByZXR1cm4gYXJ5W3RoaXMuaW50ZWdlckluUmFuZ2UoMCwgYXJ5Lmxlbmd0aCldOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHJhbmRvbSBtZW1iZXIgb2YgYGFycmF5YCwgZmF2b3JpbmcgdGhlIGVhcmxpZXIgZW50cmllcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciN3ZWlnaHRlZFBpY2sKICAgICogQHBhcmFtIHtBcnJheX0gYXJ5IC0gQW4gQXJyYXkgdG8gcGljayBhIHJhbmRvbSBtZW1iZXIgb2YuCiAgICAqIEByZXR1cm4ge2FueX0gQSByYW5kb20gbWVtYmVyIG9mIHRoZSBhcnJheS4KICAgICovCiAgICB3ZWlnaHRlZFBpY2s6IGZ1bmN0aW9uIChhcnkpIHsKICAgICAgICByZXR1cm4gYXJ5W35+KE1hdGgucG93KHRoaXMuZnJhYygpLCAyKSAqIGFyeS5sZW5ndGgpXTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSByYW5kb20gdGltZXN0YW1wIGJldHdlZW4gbWluIGFuZCBtYXgsIG9yIGJldHdlZW4gdGhlIGJlZ2lubmluZyBvZiAyMDAwIGFuZCB0aGUgZW5kIG9mIDIwMjAgaWYgbWluIGFuZCBtYXggYXJlbid0IHNwZWNpZmllZC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciN0aW1lc3RhbXAKICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIHZhbHVlIGluIHRoZSByYW5nZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIGluIHRoZSByYW5nZS4KICAgICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSB0aW1lc3RhbXAgYmV0d2VlbiBtaW4gYW5kIG1heC4KICAgICovCiAgICB0aW1lc3RhbXA6IGZ1bmN0aW9uIChtaW4sIG1heCkgewogICAgICAgIHJldHVybiB0aGlzLnJlYWxJblJhbmdlKG1pbiB8fCA5NDY2ODQ4MDAwMDAsIG1heCB8fCAxNTc3ODYyMDAwMDAwKTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSByYW5kb20gYW5nbGUgYmV0d2VlbiAtMTgwIGFuZCAxODAuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IjYW5nbGUKICAgICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSBudW1iZXIgYmV0d2VlbiAtMTgwIGFuZCAxODAuCiAgICAqLwogICAgYW5nbGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmludGVnZXJJblJhbmdlKC0xODAsIDE4MCk7CiAgICB9Cgp9OwoKUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3I7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIGNvbGxlY3Rpb24gb2YgbWF0aGVtYXRpY2FsIG1ldGhvZHMuCioKKiBAY2xhc3MgUGhhc2VyLk1hdGgKKi8KUGhhc2VyLk1hdGggPSB7CgogICAgLyoqCiAgICAqID0gMiAmcGk7CiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjUEkyCiAgICAqLwogICAgUEkyOiBNYXRoLlBJICogMiwKCiAgICAvKioKICAgICogVHdvIG51bWJlciBhcmUgZnV6enlFcXVhbCBpZiB0aGVpciBkaWZmZXJlbmNlIGlzIGxlc3MgdGhhbiAmZXBzaWxvbjsuIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2Z1enp5RXF1YWwKICAgICogQHBhcmFtIHtudW1iZXJ9IGEKICAgICogQHBhcmFtIHtudW1iZXJ9IGIKICAgICogQHBhcmFtIHtudW1iZXJ9IGVwc2lsb24gCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgfGEtYnw8JmVwc2lsb247CiAgICAqLwogICAgZnV6enlFcXVhbDogZnVuY3Rpb24gKGEsIGIsIGVwc2lsb24pIHsKICAgICAgICBpZiAodHlwZW9mIGVwc2lsb24gPT09ICJ1bmRlZmluZWQiKSB7IGVwc2lsb24gPSAwLjAwMDE7IH0KICAgICAgICByZXR1cm4gTWF0aC5hYnMoYSAtIGIpIDwgZXBzaWxvbjsKICAgIH0sCgogICAgLyoqCiAgICAqIGEgaXMgZnV6enlMZXNzVGhhbiBiIGlmIGl0IGlzIGxlc3MgdGhhbiBiICsgJmVwc2lsb247LiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNmdXp6eUVxdWFsCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBiCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBlcHNpbG9uIAogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGE8YismZXBzaWxvbjsKICAgICovCiAgICBmdXp6eUxlc3NUaGFuOiBmdW5jdGlvbiAoYSwgYiwgZXBzaWxvbikgewogICAgICAgIGlmICh0eXBlb2YgZXBzaWxvbiA9PT0gInVuZGVmaW5lZCIpIHsgZXBzaWxvbiA9IDAuMDAwMTsgfQogICAgICAgIHJldHVybiBhIDwgYiArIGVwc2lsb247CiAgICB9LAoKICAgIC8qKgogICAgKiBhIGlzIGZ1enp5R3JlYXRlclRoYW4gYiBpZiBpdCBpcyBtb3JlIHRoYW4gYiAtICZlcHNpbG9uOy4gIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2Z1enp5R3JlYXRlclRoYW4KICAgICogQHBhcmFtIHtudW1iZXJ9IGEKICAgICogQHBhcmFtIHtudW1iZXJ9IGIKICAgICogQHBhcmFtIHtudW1iZXJ9IGVwc2lsb24gCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgYT5iKyZlcHNpbG9uOwogICAgKi8KICAgIGZ1enp5R3JlYXRlclRoYW46IGZ1bmN0aW9uIChhLCBiLCBlcHNpbG9uKSB7CiAgICAgICAgaWYgKHR5cGVvZiBlcHNpbG9uID09PSAidW5kZWZpbmVkIikgeyBlcHNpbG9uID0gMC4wMDAxOyB9CiAgICAgICAgcmV0dXJuIGEgPiBiIC0gZXBzaWxvbjsKICAgIH0sCgogICAgLyoqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2Z1enp5Q2VpbAogICAgKiBAcGFyYW0ge251bWJlcn0gdmFsCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBlcHNpbG9uIAogICAgKiBAcmV0dXJuIHtib29sZWFufSBjZWlsaW5nKHZhbC0mZXBzaWxvbjspCiAgICAqLwogICAgZnV6enlDZWlsOiBmdW5jdGlvbiAodmFsLCBlcHNpbG9uKSB7CiAgICAgICAgaWYgKHR5cGVvZiBlcHNpbG9uID09PSAidW5kZWZpbmVkIikgeyBlcHNpbG9uID0gMC4wMDAxOyB9CiAgICAgICAgcmV0dXJuIE1hdGguY2VpbCh2YWwgLSBlcHNpbG9uKTsKICAgIH0sCgogICAgLyoqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2Z1enp5Rmxvb3IKICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbAogICAgKiBAcGFyYW0ge251bWJlcn0gZXBzaWxvbiAKICAgICogQHJldHVybiB7Ym9vbGVhbn0gZmxvb3IodmFsLSZlcHNpbG9uOykKICAgICovCiAgICBmdXp6eUZsb29yOiBmdW5jdGlvbiAodmFsLCBlcHNpbG9uKSB7CiAgICAgICAgaWYgKHR5cGVvZiBlcHNpbG9uID09PSAidW5kZWZpbmVkIikgeyBlcHNpbG9uID0gMC4wMDAxOyB9CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodmFsICsgZXBzaWxvbik7CiAgICB9LAoKICAgIC8qKiAKICAgICogQXZlcmFnZXMgYWxsIHZhbHVlcyBwYXNzZWQgdG8gdGhlIGZ1bmN0aW9uIGFuZCByZXR1cm5zIHRoZSByZXN1bHQuIFlvdSBjYW4gcGFzcyBhcyBtYW55IHBhcmFtZXRlcnMgYXMgeW91IGxpa2UuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjYXZlcmFnZQogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhdmVyYWdlIG9mIGFsbCBnaXZlbiB2YWx1ZXMuCiAgICAqLwogICAgYXZlcmFnZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgYXJncyA9IFtdOwoKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgIH0KCiAgICAgICAgdmFyIGF2ZyA9IDA7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhdmcgKz0gYXJnc1tpXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhdmcgLyBhcmdzLmxlbmd0aDsKCiAgICB9LAoKICAgIC8qKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCN0cnVuY2F0ZQogICAgKiBAcGFyYW0ge251bWJlcn0gbgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgdHJ1bmNhdGU6IGZ1bmN0aW9uIChuKSB7CiAgICAgICAgcmV0dXJuIChuID4gMCkgPyBNYXRoLmZsb29yKG4pIDogTWF0aC5jZWlsKG4pOwogICAgfSwKCiAgICAvKiogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc2hlYXIKICAgICogQHBhcmFtIHtudW1iZXJ9IG4KICAgICogQHJldHVybiB7bnVtYmVyfSBuIG1vZCAxCiAgICAqLwogICAgc2hlYXI6IGZ1bmN0aW9uIChuKSB7CiAgICAgICAgcmV0dXJuIG4gJSAxOwogICAgfSwKCiAgICAvKioKICAgICogU25hcCBhIHZhbHVlIHRvIG5lYXJlc3QgZ3JpZCBzbGljZSwgdXNpbmcgcm91bmRpbmcuCiAgICAqCiAgICAqIEV4YW1wbGU6IGlmIHlvdSBoYXZlIGFuIGludGVydmFsIGdhcCBvZiA1IGFuZCBhIHBvc2l0aW9uIG9mIDEyLi4uIHlvdSB3aWxsIHNuYXAgdG8gMTAgd2hlcmVhcyAxNCB3aWxsIHNuYXAgdG8gMTUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc25hcFRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbnB1dCAtIFRoZSB2YWx1ZSB0byBzbmFwLgogICAgKiBAcGFyYW0ge251bWJlcn0gZ2FwIC0gVGhlIGludGVydmFsIGdhcCBvZiB0aGUgZ3JpZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzdGFydF0gLSBPcHRpb25hbCBzdGFydGluZyBvZmZzZXQgZm9yIGdhcC4KICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHNuYXBUbzogZnVuY3Rpb24gKGlucHV0LCBnYXAsIHN0YXJ0KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3RhcnQgPT09ICJ1bmRlZmluZWQiKSB7IHN0YXJ0ID0gMDsgfQoKICAgICAgICBpZiAoZ2FwID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBpbnB1dDsKICAgICAgICB9CgogICAgICAgIGlucHV0IC09IHN0YXJ0OwogICAgICAgIGlucHV0ID0gZ2FwICogTWF0aC5yb3VuZChpbnB1dCAvIGdhcCk7CgogICAgICAgIHJldHVybiBzdGFydCArIGlucHV0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNuYXAgYSB2YWx1ZSB0byBuZWFyZXN0IGdyaWQgc2xpY2UsIHVzaW5nIGZsb29yLgogICAgKgogICAgKiBFeGFtcGxlOiBpZiB5b3UgaGF2ZSBhbiBpbnRlcnZhbCBnYXAgb2YgNSBhbmQgYSBwb3NpdGlvbiBvZiAxMi4uLiB5b3Ugd2lsbCBzbmFwIHRvIDEwLiBBcyB3aWxsIDE0IHNuYXAgdG8gMTAuLi4gYnV0IDE2IHdpbGwgc25hcCB0byAxNQogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3NuYXBUb0Zsb29yCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbnB1dCAtIFRoZSB2YWx1ZSB0byBzbmFwLgogICAgKiBAcGFyYW0ge251bWJlcn0gZ2FwIC0gVGhlIGludGVydmFsIGdhcCBvZiB0aGUgZ3JpZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzdGFydF0gLSBPcHRpb25hbCBzdGFydGluZyBvZmZzZXQgZm9yIGdhcC4KICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHNuYXBUb0Zsb29yOiBmdW5jdGlvbiAoaW5wdXQsIGdhcCwgc3RhcnQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzdGFydCA9PT0gInVuZGVmaW5lZCIpIHsgc3RhcnQgPSAwOyB9CgogICAgICAgIGlmIChnYXAgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIGlucHV0OwogICAgICAgIH0KCiAgICAgICAgaW5wdXQgLT0gc3RhcnQ7CiAgICAgICAgaW5wdXQgPSBnYXAgKiBNYXRoLmZsb29yKGlucHV0IC8gZ2FwKTsKCiAgICAgICAgcmV0dXJuIHN0YXJ0ICsgaW5wdXQ7CgogICAgfSwKCiAgICAvKioKICAgICogU25hcCBhIHZhbHVlIHRvIG5lYXJlc3QgZ3JpZCBzbGljZSwgdXNpbmcgY2VpbC4KICAgICoKICAgICogRXhhbXBsZTogaWYgeW91IGhhdmUgYW4gaW50ZXJ2YWwgZ2FwIG9mIDUgYW5kIGEgcG9zaXRpb24gb2YgMTIuLi4geW91IHdpbGwgc25hcCB0byAxNS4gQXMgd2lsbCAxNCB3aWxsIHNuYXAgdG8gMTUuLi4gYnV0IDE2IHdpbGwgc25hcCB0byAyMC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNzbmFwVG9DZWlsCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbnB1dCAtIFRoZSB2YWx1ZSB0byBzbmFwLgogICAgKiBAcGFyYW0ge251bWJlcn0gZ2FwIC0gVGhlIGludGVydmFsIGdhcCBvZiB0aGUgZ3JpZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzdGFydF0gLSBPcHRpb25hbCBzdGFydGluZyBvZmZzZXQgZm9yIGdhcC4KICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHNuYXBUb0NlaWw6IGZ1bmN0aW9uIChpbnB1dCwgZ2FwLCBzdGFydCkgewoKICAgICAgICBpZiAodHlwZW9mIHN0YXJ0ID09PSAidW5kZWZpbmVkIikgeyBzdGFydCA9IDA7IH0KCiAgICAgICAgaWYgKGdhcCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gaW5wdXQ7CiAgICAgICAgfQoKICAgICAgICBpbnB1dCAtPSBzdGFydDsKICAgICAgICBpbnB1dCA9IGdhcCAqIE1hdGguY2VpbChpbnB1dCAvIGdhcCk7CgogICAgICAgIHJldHVybiBzdGFydCArIGlucHV0OwoKICAgIH0sCgoKICAgIC8qKgogICAgKiBTbmFwcyBhIHZhbHVlIHRvIHRoZSBuZWFyZXN0IHZhbHVlIGluIGFuIGFycmF5LgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3NuYXBUb0luQXJyYXkKICAgICogQHBhcmFtIHtudW1iZXJ9IGlucHV0CiAgICAqIEBwYXJhbSB7YXJyYXl9IGFyciAKICAgICogQHBhcmFtIHtib29sZWFufSBzb3J0IC0gVHJ1ZSBpZiB0aGUgYXJyYXkgbmVlZHMgdG8gYmUgc29ydGVkLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgc25hcFRvSW5BcnJheTogZnVuY3Rpb24gKGlucHV0LCBhcnIsIHNvcnQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzb3J0ID09PSAidW5kZWZpbmVkIikgeyBzb3J0ID0gdHJ1ZTsgfQoKICAgICAgICBpZiAoc29ydCkgewogICAgICAgICAgICBhcnIuc29ydCgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlucHV0IDwgYXJyWzBdKSB7CiAgICAgICAgICAgIHJldHVybiBhcnJbMF07CiAgICAgICAgfQoKICAgICAgICB2YXIgaSA9IDE7CiAgICAgICAgCiAgICAgICAgd2hpbGUgKGFycltpXSA8IGlucHV0KSB7CiAgICAgICAgICAgIGkrKzsKICAgICAgICB9CgogICAgICAgIHZhciBsb3cgPSBhcnJbaSAtIDFdOwogICAgICAgIHZhciBoaWdoID0gKGkgPCBhcnIubGVuZ3RoKSA/IGFycltpXSA6IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICAKICAgICAgICByZXR1cm4gKChoaWdoIC0gaW5wdXQpIDw9IChpbnB1dCAtIGxvdykpID8gaGlnaCA6IGxvdzsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSb3VuZCB0byBzb21lIHBsYWNlIGNvbXBhcmF0aXZlIHRvIGEgJ2Jhc2UnLCBkZWZhdWx0IGlzIDEwIGZvciBkZWNpbWFsIHBsYWNlLgogICAgKgogICAgKiAncGxhY2UnIGlzIHJlcHJlc2VudGVkIGJ5IHRoZSBwb3dlciBhcHBsaWVkIHRvICdiYXNlJyB0byBnZXQgdGhhdCBwbGFjZQogICAgKiBlLmcuCiAgICAqIDIwMDAvNyB+PSAyODUuNzE0Mjg1NzE0Mjg1NzE0Mjg1NzE0IH49IChiaW4pMTAwMDExMTAxLjEwMTEwMTEwMTEwMTEwMTEKICAgICoKICAgICogcm91bmRUbygyMDAwLzcsMykgPT09IDAKICAgICogcm91bmRUbygyMDAwLzcsMikgPT0gMzAwCiAgICAqIHJvdW5kVG8oMjAwMC83LDEpID09IDI5MAogICAgKiByb3VuZFRvKDIwMDAvNywwKSA9PSAyODYKICAgICogcm91bmRUbygyMDAwLzcsLTEpID09IDI4NS43CiAgICAqIHJvdW5kVG8oMjAwMC83LC0yKSA9PSAyODUuNzEKICAgICogcm91bmRUbygyMDAwLzcsLTMpID09IDI4NS43MTQKICAgICogcm91bmRUbygyMDAwLzcsLTQpID09IDI4NS43MTQzCiAgICAqIHJvdW5kVG8oMjAwMC83LC01KSA9PSAyODUuNzE0MjkKICAgICoKICAgICogcm91bmRUbygyMDAwLzcsMywyKSAgPT0gMjg4ICAgICAgIC0tIDEwMDEwMDAwMAogICAgKiByb3VuZFRvKDIwMDAvNywyLDIpICA9PSAyODQgICAgICAgLS0gMTAwMDExMTAwCiAgICAqIHJvdW5kVG8oMjAwMC83LDEsMikgID09IDI4NiAgICAgICAtLSAxMDAwMTExMTAKICAgICogcm91bmRUbygyMDAwLzcsMCwyKSAgPT0gMjg2ICAgICAgIC0tIDEwMDAxMTExMAogICAgKiByb3VuZFRvKDIwMDAvNywtMSwyKSA9PSAyODUuNSAgICAgLS0gMTAwMDExMTAxLjEKICAgICogcm91bmRUbygyMDAwLzcsLTIsMikgPT0gMjg1Ljc1ICAgIC0tIDEwMDAxMTEwMS4xMQogICAgKiByb3VuZFRvKDIwMDAvNywtMywyKSA9PSAyODUuNzUgICAgLS0gMTAwMDExMTAxLjExCiAgICAqIHJvdW5kVG8oMjAwMC83LC00LDIpID09IDI4NS42ODc1ICAtLSAxMDAwMTExMDEuMTAxMQogICAgKiByb3VuZFRvKDIwMDAvNywtNSwyKSA9PSAyODUuNzE4NzUgLS0gMTAwMDExMTAxLjEwMTExCiAgICAqCiAgICAqIE5vdGUgd2hhdCBvY2N1cnMgd2hlbiB3ZSByb3VuZCB0byB0aGUgM3JkIHNwYWNlICg4dGhzIHBsYWNlKSwgMTAwMTAwMDAwLCB0aGlzIGlzIHRvIGJlIGFzc3VtZWQKICAgICogYmVjYXVzZSB3ZSBhcmUgcm91bmRpbmcgMTAwMDExLjEwMTEwMTEwMTEwMTEwMTEgd2hpY2ggcm91bmRzIHVwLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNyb3VuZFRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byByb3VuZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHBsYWNlIC0gVGhlIHBsYWNlIHRvIHJvdW5kIHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0gYmFzZSAtIFRoZSBiYXNlIHRvIHJvdW5kIGluLi4uIGRlZmF1bHQgaXMgMTAgZm9yIGRlY2ltYWwuCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICByb3VuZFRvOiBmdW5jdGlvbiAodmFsdWUsIHBsYWNlLCBiYXNlKSB7CgogICAgICAgIGlmICh0eXBlb2YgcGxhY2UgPT09ICJ1bmRlZmluZWQiKSB7IHBsYWNlID0gMDsgfQogICAgICAgIGlmICh0eXBlb2YgYmFzZSA9PT0gInVuZGVmaW5lZCIpIHsgYmFzZSA9IDEwOyB9CiAgICAgICAgCiAgICAgICAgdmFyIHAgPSBNYXRoLnBvdyhiYXNlLCAtcGxhY2UpOwogICAgICAgIAogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbHVlICogcCkgLyBwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZmxvb3JUbwogICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gcm91bmQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBwbGFjZSAtIFRoZSBwbGFjZSB0byByb3VuZCB0by4KICAgICogQHBhcmFtIHtudW1iZXJ9IGJhc2UgLSBUaGUgYmFzZSB0byByb3VuZCBpbi4uLiBkZWZhdWx0IGlzIDEwIGZvciBkZWNpbWFsLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgZmxvb3JUbzogZnVuY3Rpb24gKHZhbHVlLCBwbGFjZSwgYmFzZSkgewoKICAgICAgICBpZiAodHlwZW9mIHBsYWNlID09PSAidW5kZWZpbmVkIikgeyBwbGFjZSA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIGJhc2UgPT09ICJ1bmRlZmluZWQiKSB7IGJhc2UgPSAxMDsgfQoKICAgICAgICB2YXIgcCA9IE1hdGgucG93KGJhc2UsIC1wbGFjZSk7CgogICAgICAgIHJldHVybiBNYXRoLmZsb29yKHZhbHVlICogcCkgLyBwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjY2VpbFRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byByb3VuZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHBsYWNlIC0gVGhlIHBsYWNlIHRvIHJvdW5kIHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0gYmFzZSAtIFRoZSBiYXNlIHRvIHJvdW5kIGluLi4uIGRlZmF1bHQgaXMgMTAgZm9yIGRlY2ltYWwuCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBjZWlsVG86IGZ1bmN0aW9uICh2YWx1ZSwgcGxhY2UsIGJhc2UpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBwbGFjZSA9PT0gInVuZGVmaW5lZCIpIHsgcGxhY2UgPSAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiBiYXNlID09PSAidW5kZWZpbmVkIikgeyBiYXNlID0gMTA7IH0KCiAgICAgICAgdmFyIHAgPSBNYXRoLnBvdyhiYXNlLCAtcGxhY2UpOwoKICAgICAgICByZXR1cm4gTWF0aC5jZWlsKHZhbHVlICogcCkgLyBwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEEgb25lIGRpbWVuc2lvbmFsIGxpbmVhciBpbnRlcnBvbGF0aW9uIG9mIGEgdmFsdWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjaW50ZXJwb2xhdGVGbG9hdAogICAgKiBAcGFyYW0ge251bWJlcn0gYQogICAgKiBAcGFyYW0ge251bWJlcn0gYgogICAgKiBAcGFyYW0ge251bWJlcn0gd2VpZ2h0IAogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgaW50ZXJwb2xhdGVGbG9hdDogZnVuY3Rpb24gKGEsIGIsIHdlaWdodCkgewogICAgICAgIHJldHVybiAoYiAtIGEpICogd2VpZ2h0ICsgYTsKICAgIH0sCgogICAgLyoqCiAgICAqIEZpbmQgdGhlIGFuZ2xlIG9mIGEgc2VnbWVudCBmcm9tICh4MSwgeTEpIC0+ICh4MiwgeTIpLgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2FuZ2xlQmV0d2VlbgogICAgKiBAcGFyYW0ge251bWJlcn0geDEKICAgICogQHBhcmFtIHtudW1iZXJ9IHkxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MgogICAgKiBAcGFyYW0ge251bWJlcn0geTIKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIGFuZ2xlQmV0d2VlbjogZnVuY3Rpb24gKHgxLCB5MSwgeDIsIHkyKSB7CiAgICAgICAgcmV0dXJuIE1hdGguYXRhbjIoeTIgLSB5MSwgeDIgLSB4MSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXZlcnNlcyBhbiBhbmdsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNyZXZlcnNlQW5nbGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlUmFkIC0gVGhlIGFuZ2xlIHRvIHJldmVyc2UsIGluIHJhZGlhbnMuCiAgICAqIEByZXR1cm4ge251bWJlcn0gUmV0dXJucyB0aGUgcmV2ZXJzZSBhbmdsZSwgaW4gcmFkaWFucy4KICAgICovCiAgICByZXZlcnNlQW5nbGU6IGZ1bmN0aW9uIChhbmdsZVJhZCkgewogICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZUFuZ2xlKGFuZ2xlUmFkICsgTWF0aC5QSSwgdHJ1ZSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBOb3JtYWxpemVzIGFuIGFuZ2xlIHRvIHRoZSBbMCwycGkpIHJhbmdlLgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI25vcm1hbGl6ZUFuZ2xlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZVJhZCAtIFRoZSBhbmdsZSB0byBub3JtYWxpemUsIGluIHJhZGlhbnMuCiAgICAqIEByZXR1cm4ge251bWJlcn0gUmV0dXJucyB0aGUgYW5nbGUsIGZpdCB3aXRoaW4gdGhlIFswLDJwaV0gcmFuZ2UsIGluIHJhZGlhbnMuCiAgICAqLwogICAgbm9ybWFsaXplQW5nbGU6IGZ1bmN0aW9uIChhbmdsZVJhZCkgewoKICAgICAgICBhbmdsZVJhZCA9IGFuZ2xlUmFkICUgKDIgKiBNYXRoLlBJKTsKICAgICAgICByZXR1cm4gYW5nbGVSYWQgPj0gMCA/IGFuZ2xlUmFkIDogYW5nbGVSYWQgKyAyICogTWF0aC5QSTsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIE5vcm1hbGl6ZXMgYSBsYXRpdHVkZSB0byB0aGUgWy05MCw5MF0gcmFuZ2UuIExhdGl0dWRlcyBhYm92ZSA5MCBvciBiZWxvdyAtOTAgYXJlIGNhcHBlZCwgbm90IHdyYXBwZWQuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjbm9ybWFsaXplTGF0aXR1ZGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGxhdCAtIFRoZSBsYXRpdHVkZSB0byBub3JtYWxpemUsIGluIGRlZ3JlZXMuCiAgICAqIEByZXR1cm4ge251bWJlcn0gUmV0dXJucyB0aGUgbGF0aXR1ZGUsIGZpdCB3aXRoaW4gdGhlIFstOTAsOTBdIHJhbmdlLgogICAgKi8KICAgIG5vcm1hbGl6ZUxhdGl0dWRlOiBmdW5jdGlvbiAobGF0KSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KC05MCwgTWF0aC5taW4oOTAsIGxhdCkpOwogICAgfSwKCiAgICAvKioKICAgICogTm9ybWFsaXplcyBhIGxvbmdpdHVkZSB0byB0aGUgWy0xODAsMTgwXSByYW5nZS4gTG9uZ2l0dWRlcyBhYm92ZSAxODAgb3IgYmVsb3cgLTE4MCBhcmUgd3JhcHBlZC4KICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNub3JtYWxpemVMb25naXR1ZGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGxuZyAtIFRoZSBsb25naXR1ZGUgdG8gbm9ybWFsaXplLCBpbiBkZWdyZWVzLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFJldHVybnMgdGhlIGxvbmdpdHVkZSwgZml0IHdpdGhpbiB0aGUgWy0xODAsMTgwXSByYW5nZS4KICAgICovCiAgICBub3JtYWxpemVMb25naXR1ZGU6IGZ1bmN0aW9uIChsbmcpIHsKCiAgICAgICAgaWYgKGxuZyAlIDM2MCA9PSAxODApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gMTgwOwogICAgICAgIH0KCiAgICAgICAgbG5nID0gbG5nICUgMzYwOwogICAgICAgIHJldHVybiBsbmcgPCAtMTgwID8gbG5nICsgMzYwIDogbG5nID4gMTgwID8gbG5nIC0gMzYwIDogbG5nOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENsb3Nlc3QgYW5nbGUgYmV0d2VlbiB0d28gYW5nbGVzIGZyb20gYTEgdG8gYTIgYWJzb2x1dGUgdmFsdWUgdGhlIHJldHVybiBmb3IgZXhhY3QgYW5nbGUKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNuZWFyZXN0QW5nbGVCZXR3ZWVuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhMQogICAgKiBAcGFyYW0ge251bWJlcn0gYTIKICAgICogQHBhcmFtIHtib29sZWFufSByYWRpYW5zIC0gVHJ1ZSBpZiBhbmdsZSBzaXplcyBhcmUgZXhwcmVzc2VkIGluIHJhZGlhbnMuCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBuZWFyZXN0QW5nbGVCZXR3ZWVuOiBmdW5jdGlvbiAoYTEsIGEyLCByYWRpYW5zKSB7CgogICAgICAgIGlmICh0eXBlb2YgcmFkaWFucyA9PT0gInVuZGVmaW5lZCIpIHsgcmFkaWFucyA9IHRydWU7IH0KCiAgICAgICAgdmFyIHJkID0gKHJhZGlhbnMpID8gTWF0aC5QSSA6IDE4MDsKICAgICAgICBhMSA9IHRoaXMubm9ybWFsaXplQW5nbGUoYTEsIHJhZGlhbnMpOwogICAgICAgIGEyID0gdGhpcy5ub3JtYWxpemVBbmdsZShhMiwgcmFkaWFucyk7CiAgICAgICAgCiAgICAgICAgaWYgKGExIDwgLXJkIC8gMiAmJiBhMiA+IHJkIC8gMikKICAgICAgICB7CiAgICAgICAgICAgIGExICs9IHJkICogMjsKICAgICAgICB9CgogICAgICAgIGlmIChhMiA8IC1yZCAvIDIgJiYgYTEgPiByZCAvIDIpCiAgICAgICAgewogICAgICAgICAgICBhMiArPSByZCAqIDI7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYTIgLSBhMTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcnBvbGF0ZSBhY3Jvc3MgdGhlIHNob3J0ZXN0IGFyYyBiZXR3ZWVuIHR3byBhbmdsZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjaW50ZXJwb2xhdGVBbmdsZXMKICAgICogQHBhcmFtIHtudW1iZXJ9IGExIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhMiAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gd2VpZ2h0IC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gcmFkaWFucyAtIFRydWUgaWYgYW5nbGUgc2l6ZXMgYXJlIGV4cHJlc3NlZCBpbiByYWRpYW5zLgogICAgKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBlYXNlIC0gRGVzY3JpcHRpb24uCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBpbnRlcnBvbGF0ZUFuZ2xlczogZnVuY3Rpb24gKGExLCBhMiwgd2VpZ2h0LCByYWRpYW5zLCBlYXNlKSB7CgogICAgICAgIGlmICh0eXBlb2YgcmFkaWFucyA9PT0gInVuZGVmaW5lZCIpIHsgcmFkaWFucyA9IHRydWU7IH0KICAgICAgICBpZiAodHlwZW9mIGVhc2UgPT09ICJ1bmRlZmluZWQiKSB7IGVhc2UgPSBudWxsOyB9CgogICAgICAgIGExID0gdGhpcy5ub3JtYWxpemVBbmdsZShhMSwgcmFkaWFucyk7CiAgICAgICAgYTIgPSB0aGlzLm5vcm1hbGl6ZUFuZ2xlVG9Bbm90aGVyKGEyLCBhMSwgcmFkaWFucyk7CgogICAgICAgIHJldHVybiAodHlwZW9mIGVhc2UgPT09ICdmdW5jdGlvbicpID8gZWFzZSh3ZWlnaHQsIGExLCBhMiAtIGExLCAxKSA6IHRoaXMuaW50ZXJwb2xhdGVGbG9hdChhMSwgYTIsIHdlaWdodCk7CgogICAgfSwKCiAgICAvKioKICAgICogR2VuZXJhdGUgYSByYW5kb20gYm9vbCByZXN1bHQgYmFzZWQgb24gdGhlIGNoYW5jZSB2YWx1ZS4KICAgICogPHA+CiAgICAqIFJldHVybnMgdHJ1ZSBvciBmYWxzZSBiYXNlZCBvbiB0aGUgY2hhbmNlIHZhbHVlIChkZWZhdWx0IDUwJSkuIEZvciBleGFtcGxlIGlmIHlvdSB3YW50ZWQgYSBwbGF5ZXIgdG8gaGF2ZSBhIDMwJSBjaGFuY2UKICAgICogb2YgZ2V0dGluZyBhIGJvbnVzLCBjYWxsIGNoYW5jZVJvbGwoMzApIC0gdHJ1ZSBtZWFucyB0aGUgY2hhbmNlIHBhc3NlZCwgZmFsc2UgbWVhbnMgaXQgZmFpbGVkLgogICAgKiA8L3A+CiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjY2hhbmNlUm9sbAogICAgKiBAcGFyYW0ge251bWJlcn0gY2hhbmNlIC0gVGhlIGNoYW5jZSBvZiByZWNlaXZpbmcgdGhlIHZhbHVlLiBBIG51bWJlciBiZXR3ZWVuIDAgYW5kIDEwMCAoZWZmZWN0aXZlbHkgMCUgdG8gMTAwJSkuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIHJvbGwgcGFzc2VkLCBvciBmYWxzZSBvdGhlcndpc2UuCiAgICAqLwogICAgY2hhbmNlUm9sbDogZnVuY3Rpb24gKGNoYW5jZSkgewoKICAgICAgICBpZiAodHlwZW9mIGNoYW5jZSA9PT0gInVuZGVmaW5lZCIpIHsgY2hhbmNlID0gNTA7IH0KICAgICAgICAKICAgICAgICBpZiAoY2hhbmNlIDw9IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGNoYW5jZSA+PSAxMDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgKiAxMDAgPj0gY2hhbmNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGFuIEFycmF5IGNvbnRhaW5pbmcgdGhlIG51bWJlcnMgZnJvbSBtaW4gdG8gbWF4IChpbmNsdXNpdmUpLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI251bWJlckFycmF5CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSB0aGUgYXJyYXkgc3RhcnRzIHdpdGguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYXggLSBUaGUgbWF4aW11bSB2YWx1ZSB0aGUgYXJyYXkgY29udGFpbnMuCiAgICAqIEByZXR1cm4ge2FycmF5fSBUaGUgYXJyYXkgb2YgbnVtYmVyIHZhbHVlcy4KICAgICovCiAgICBudW1iZXJBcnJheTogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgogICAgICAgIHZhciByZXN1bHQgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgaSA9IG1pbjsgaSA8PSBtYXg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIHRoZSBnaXZlbiBhbW91bnQgdG8gdGhlIHZhbHVlLCBidXQgbmV2ZXIgbGV0cyB0aGUgdmFsdWUgZ28gb3ZlciB0aGUgc3BlY2lmaWVkIG1heGltdW0uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjbWF4QWRkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBhZGQgdGhlIGFtb3VudCB0by4KICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gYWRkIHRvIHRoZSB2YWx1ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heC0gVGhlIG1heGltdW0gdGhlIHZhbHVlIGlzIGFsbG93ZWQgdG8gYmUuCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBtYXhBZGQ6IGZ1bmN0aW9uICh2YWx1ZSwgYW1vdW50LCBtYXgpIHsKCiAgICAgICAgdmFsdWUgKz0gYW1vdW50OwoKICAgICAgICBpZiAodmFsdWUgPiBtYXgpCiAgICAgICAgewogICAgICAgICAgICB2YWx1ZSA9IG1heDsKICAgICAgICB9CgogICAgICAgIHJldHVybiB2YWx1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdWJ0cmFjdHMgdGhlIGdpdmVuIGFtb3VudCBmcm9tIHRoZSB2YWx1ZSwgYnV0IG5ldmVyIGxldHMgdGhlIHZhbHVlIGdvIGJlbG93IHRoZSBzcGVjaWZpZWQgbWluaW11bS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNtaW5TdWIKICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIGJhc2UgdmFsdWUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgLSBUaGUgYW1vdW50IHRvIHN1YnRyYWN0IGZyb20gdGhlIGJhc2UgdmFsdWUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB0aGUgdmFsdWUgaXMgYWxsb3dlZCB0byBiZS4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbmV3IHZhbHVlLgogICAgKi8KICAgIG1pblN1YjogZnVuY3Rpb24gKHZhbHVlLCBhbW91bnQsIG1pbikgewoKICAgICAgICB2YWx1ZSAtPSBhbW91bnQ7CiAgICAgICAgCiAgICAgICAgaWYgKHZhbHVlIDwgbWluKQogICAgICAgIHsKICAgICAgICAgICAgdmFsdWUgPSBtaW47CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsdWU7CgogICAgfSwKCiAgICAvKioKICAgICogRW5zdXJlcyB0aGF0IHRoZSB2YWx1ZSBhbHdheXMgc3RheXMgYmV0d2VlbiBtaW4gYW5kIG1heCwgYnkgd3JhcHBpbmcgdGhlIHZhbHVlIGFyb3VuZC4KICAgICogbWF4IHNob3VsZCBiZSBsYXJnZXIgdGhhbiBtaW4sIG9yIHRoZSBmdW5jdGlvbiB3aWxsIHJldHVybiAwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3dyYXAKICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIHdyYXAuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB0aGUgdmFsdWUgaXMgYWxsb3dlZCB0byBiZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHRoZSB2YWx1ZSBpcyBhbGxvd2VkIHRvIGJlLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSB3cmFwcGVkIHZhbHVlLgogICAgKi8KICAgIHdyYXA6IGZ1bmN0aW9uICh2YWx1ZSwgbWluLCBtYXgpIHsKCiAgICAgICAgdmFyIHJhbmdlID0gbWF4IC0gbWluOwoKICAgICAgICBpZiAocmFuZ2UgPD0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgdmFyIHJlc3VsdCA9ICh2YWx1ZSAtIG1pbikgJSByYW5nZTsKCiAgICAgICAgaWYgKHJlc3VsdCA8IDApCiAgICAgICAgewogICAgICAgICAgICByZXN1bHQgKz0gcmFuZ2U7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiByZXN1bHQgKyBtaW47CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyB2YWx1ZSB0byBhbW91bnQgYW5kIGVuc3VyZXMgdGhhdCB0aGUgcmVzdWx0IGFsd2F5cyBzdGF5cyBiZXR3ZWVuIDAgYW5kIG1heCwgYnkgd3JhcHBpbmcgdGhlIHZhbHVlIGFyb3VuZC4KICAgICogPHA+VmFsdWVzIG11c3QgYmUgcG9zaXRpdmUgaW50ZWdlcnMsIGFuZCBhcmUgcGFzc2VkIHRocm91Z2ggTWF0aC5hYnM8L3A+CiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjd3JhcFZhbHVlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBhZGQgdGhlIGFtb3VudCB0by4KICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gYWRkIHRvIHRoZSB2YWx1ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHRoZSB2YWx1ZSBpcyBhbGxvd2VkIHRvIGJlLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSB3cmFwcGVkIHZhbHVlLgogICAgKi8KICAgIHdyYXBWYWx1ZTogZnVuY3Rpb24gKHZhbHVlLCBhbW91bnQsIG1heCkgewoKICAgICAgICB2YXIgZGlmZjsKICAgICAgICB2YWx1ZSA9IE1hdGguYWJzKHZhbHVlKTsKICAgICAgICBhbW91bnQgPSBNYXRoLmFicyhhbW91bnQpOwogICAgICAgIG1heCA9IE1hdGguYWJzKG1heCk7CiAgICAgICAgZGlmZiA9ICh2YWx1ZSArIGFtb3VudCkgJSBtYXg7CgogICAgICAgIHJldHVybiBkaWZmOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJhbmRvbWx5IHJldHVybnMgZWl0aGVyIGEgMSBvciAtMS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNyYW5kb21TaWduCiAgICAqIEByZXR1cm4ge251bWJlcn0gIDEgb3IgLTEKICAgICovCiAgICByYW5kb21TaWduOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIChNYXRoLnJhbmRvbSgpID4gMC41KSA/IDEgOiAtMTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgbnVtYmVyIGdpdmVuIGlzIG9kZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNpc09kZAogICAgKiBAcGFyYW0ge251bWJlcn0gbiAtIFRoZSBudW1iZXIgdG8gY2hlY2suCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIG51bWJlciBpcyBvZGQuIEZhbHNlIGlmIHRoZSBnaXZlbiBudW1iZXIgaXMgZXZlbi4KICAgICovCiAgICBpc09kZDogZnVuY3Rpb24gKG4pIHsKCiAgICAgICAgcmV0dXJuIChuICYgMSk7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBudW1iZXIgZ2l2ZW4gaXMgZXZlbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNpc0V2ZW4KICAgICogQHBhcmFtIHtudW1iZXJ9IG4gLSBUaGUgbnVtYmVyIHRvIGNoZWNrLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBnaXZlbiBudW1iZXIgaXMgZXZlbi4gRmFsc2UgaWYgdGhlIGdpdmVuIG51bWJlciBpcyBvZGQuCiAgICAqLwogICAgaXNFdmVuOiBmdW5jdGlvbiAobikgewoKICAgICAgICBpZiAobiAmIDEpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTaWduaWZpY2FudGx5IGZhc3RlciB2ZXJzaW9uIG9mIE1hdGgubWF4CiAgICAqIFNlZSBodHRwOi8vanNwZXJmLmNvbS9tYXRoLXMtbWluLW1heC12cy1ob21lbWFkZS81CiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjbWF4CiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGhpZ2hlc3QgdmFsdWUgZnJvbSB0aG9zZSBnaXZlbi4KICAgICovCiAgICBtYXg6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IDEsIG1heCA9IDAsIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChhcmd1bWVudHNbbWF4XSA8IGFyZ3VtZW50c1tpXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWF4ID0gaTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gYXJndW1lbnRzW21heF07CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlZCB2ZXJzaW9uIG9mIE1hdGgubWluIHRoYXQgY2FuIGJlIHBhc3NlZCBlaXRoZXIgYW4gYXJyYXkgb2YgbnVtYmVycyBvciB0aGUgbnVtYmVycyBhcyBwYXJhbWV0ZXJzLgogICAgKiBTZWUgaHR0cDovL2pzcGVyZi5jb20vbWF0aC1zLW1pbi1tYXgtdnMtaG9tZW1hZGUvNQogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI21pbgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsb3dlc3QgdmFsdWUgZnJvbSB0aG9zZSBnaXZlbi4KICAgICovCiAgICBtaW46IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gJ29iamVjdCcpCiAgICAgICAgewogICAgICAgICAgICB2YXIgZGF0YSA9IGFyZ3VtZW50c1swXTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGRhdGEgPSBhcmd1bWVudHM7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMSwgbWluID0gMCwgbGVuID0gZGF0YS5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChkYXRhW2ldIDwgZGF0YVttaW5dKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtaW4gPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZGF0YVttaW5dOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZWQgdmVyc2lvbiBvZiBNYXRoLm1heCB0aGF0IGNhbiBiZSBwYXNzZWQgZWl0aGVyIGFuIGFycmF5IG9mIG51bWJlcnMgb3IgdGhlIG51bWJlcnMgYXMgcGFyYW1ldGVycy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNtYXgKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbGFyZ2VzdCB2YWx1ZSBmcm9tIHRob3NlIGdpdmVuLgogICAgKi8KICAgIG1heDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzBdID09PSAnb2JqZWN0JykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkYXRhID0gYXJndW1lbnRzWzBdOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB2YXIgZGF0YSA9IGFyZ3VtZW50czsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAxLCBtYXggPSAwLCBsZW4gPSBkYXRhLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGRhdGFbaV0gPiBkYXRhW21heF0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1heCA9IGk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBkYXRhW21heF07CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlZCB2ZXJzaW9uIG9mIE1hdGgubWluIHRoYXQgY2FuIGJlIHBhc3NlZCBhIHByb3BlcnR5IGFuZCBlaXRoZXIgYW4gYXJyYXkgb2Ygb2JqZWN0cyBvciB0aGUgb2JqZWN0cyBhcyBwYXJhbWV0ZXJzLgogICAgKiBJdCB3aWxsIGZpbmQgdGhlIGxvd2VzdCBtYXRjaGluZyBwcm9wZXJ0eSB2YWx1ZSBmcm9tIHRoZSBnaXZlbiBvYmplY3RzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI21pblByb3BlcnR5CiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxvd2VzdCB2YWx1ZSBmcm9tIHRob3NlIGdpdmVuLgogICAgKi8KICAgIG1pblByb3BlcnR5OiBmdW5jdGlvbiAocHJvcGVydHkpIHsKCiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgdHlwZW9mIGFyZ3VtZW50c1sxXSA9PT0gJ29iamVjdCcpCiAgICAgICAgewogICAgICAgICAgICB2YXIgZGF0YSA9IGFyZ3VtZW50c1sxXTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGRhdGEgPSBhcmd1bWVudHMuc2xpY2UoMSk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMSwgbWluID0gMCwgbGVuID0gZGF0YS5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChkYXRhW2ldW3Byb3BlcnR5XSA8IGRhdGFbbWluXVtwcm9wZXJ0eV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1pbiA9IGk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBkYXRhW21pbl1bcHJvcGVydHldOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZWQgdmVyc2lvbiBvZiBNYXRoLm1heCB0aGF0IGNhbiBiZSBwYXNzZWQgYSBwcm9wZXJ0eSBhbmQgZWl0aGVyIGFuIGFycmF5IG9mIG9iamVjdHMgb3IgdGhlIG9iamVjdHMgYXMgcGFyYW1ldGVycy4KICAgICogSXQgd2lsbCBmaW5kIHRoZSBsYXJnZXN0IG1hdGNoaW5nIHByb3BlcnR5IHZhbHVlIGZyb20gdGhlIGdpdmVuIG9iamVjdHMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjbWF4UHJvcGVydHkKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbGFyZ2VzdCB2YWx1ZSBmcm9tIHRob3NlIGdpdmVuLgogICAgKi8KICAgIG1heFByb3BlcnR5OiBmdW5jdGlvbiAocHJvcGVydHkpIHsKCiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgdHlwZW9mIGFyZ3VtZW50c1sxXSA9PT0gJ29iamVjdCcpCiAgICAgICAgewogICAgICAgICAgICB2YXIgZGF0YSA9IGFyZ3VtZW50c1sxXTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGRhdGEgPSBhcmd1bWVudHMuc2xpY2UoMSk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMSwgbWF4ID0gMCwgbGVuID0gZGF0YS5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChkYXRhW2ldW3Byb3BlcnR5XSA+IGRhdGFbbWF4XVtwcm9wZXJ0eV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1heCA9IGk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBkYXRhW21heF1bcHJvcGVydHldOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEtlZXBzIGFuIGFuZ2xlIHZhbHVlIGJldHdlZW4gLTE4MCBhbmQgKzE4MDxicj4KICAgICogU2hvdWxkIGJlIGNhbGxlZCB3aGVuZXZlciB0aGUgYW5nbGUgaXMgdXBkYXRlZCBvbiB0aGUgU3ByaXRlIHRvIHN0b3AgaXQgZnJvbSBnb2luZyBpbnNhbmUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjd3JhcEFuZ2xlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSB2YWx1ZSB0byBjaGVjawogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBuZXcgYW5nbGUgdmFsdWUsIHJldHVybnMgdGhlIHNhbWUgYXMgdGhlIGlucHV0IGFuZ2xlIGlmIGl0IHdhcyB3aXRoaW4gYm91bmRzLgogICAgKi8KICAgIHdyYXBBbmdsZTogZnVuY3Rpb24gKGFuZ2xlKSB7CgogICAgICAgIHJldHVybiB0aGlzLndyYXAoYW5nbGUsIC0xODAsIDE4MCk7CgogICAgfSwKCiAgICAvKioKICAgICogS2VlcHMgYW4gYW5nbGUgdmFsdWUgYmV0d2VlbiB0aGUgZ2l2ZW4gbWluIGFuZCBtYXggdmFsdWVzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2FuZ2xlTGltaXQKICAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIHZhbHVlIHRvIGNoZWNrLiBNdXN0IGJlIGJldHdlZW4gLTE4MCBhbmQgKzE4MC4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIGFuZ2xlIHRoYXQgaXMgYWxsb3dlZCAobXVzdCBiZSAtMTgwIG9yIGdyZWF0ZXIpLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gYW5nbGUgdGhhdCBpcyBhbGxvd2VkIChtdXN0IGJlIDE4MCBvciBsZXNzKS4KICAgICoKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbmV3IGFuZ2xlIHZhbHVlLCByZXR1cm5zIHRoZSBzYW1lIGFzIHRoZSBpbnB1dCBhbmdsZSBpZiBpdCB3YXMgd2l0aGluIGJvdW5kcwogICAgKi8KICAgIGFuZ2xlTGltaXQ6IGZ1bmN0aW9uIChhbmdsZSwgbWluLCBtYXgpIHsKCiAgICAgICAgdmFyIHJlc3VsdCA9IGFuZ2xlOwoKICAgICAgICBpZiAoYW5nbGUgPiBtYXgpCiAgICAgICAgewogICAgICAgICAgICByZXN1bHQgPSBtYXg7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGFuZ2xlIDwgbWluKQogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0ID0gbWluOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIExpbmVhciBJbnRlcnBvbGF0aW9uIE1ldGhvZCwgbW9zdGx5IHVzZWQgYnkgUGhhc2VyLlR3ZWVuLgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2xpbmVhckludGVycG9sYXRpb24KICAgICogQHBhcmFtIHtudW1iZXJ9IHYKICAgICogQHBhcmFtIHtudW1iZXJ9IGsKICAgICogQHJldHVybiB7bnVtYmVyfSAKICAgICovCiAgICBsaW5lYXJJbnRlcnBvbGF0aW9uOiBmdW5jdGlvbiAodiwgaykgewoKICAgICAgICB2YXIgbSA9IHYubGVuZ3RoIC0gMTsKICAgICAgICB2YXIgZiA9IG0gKiBrOwogICAgICAgIHZhciBpID0gTWF0aC5mbG9vcihmKTsKCiAgICAgICAgaWYgKGsgPCAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGluZWFyKHZbMF0sIHZbMV0sIGYpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGsgPiAxKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGluZWFyKHZbbV0sIHZbbSAtIDFdLCBtIC0gZik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5saW5lYXIodltpXSwgdltpICsgMSA+IG0gPyBtIDogaSArIDFdLCBmIC0gaSk7CgogICAgfSwKCiAgICAvKioKICAgICogQSBCZXppZXIgSW50ZXJwb2xhdGlvbiBNZXRob2QsIG1vc3RseSB1c2VkIGJ5IFBoYXNlci5Ud2Vlbi4KICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNiZXppZXJJbnRlcnBvbGF0aW9uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB2CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBrCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBiZXppZXJJbnRlcnBvbGF0aW9uOiBmdW5jdGlvbiAodiwgaykgewoKICAgICAgICB2YXIgYiA9IDA7CiAgICAgICAgdmFyIG4gPSB2Lmxlbmd0aCAtIDE7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IG47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGIgKz0gTWF0aC5wb3coMSAtIGssIG4gLSBpKSAqIE1hdGgucG93KGssIGkpICogdltpXSAqIHRoaXMuYmVybnN0ZWluKG4sIGkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGI7CgogICAgfSwKCiAgICAvKioKICAgICogQSBDYXRtdWxsIFJvbSBJbnRlcnBvbGF0aW9uIE1ldGhvZCwgbW9zdGx5IHVzZWQgYnkgUGhhc2VyLlR3ZWVuLgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2NhdG11bGxSb21JbnRlcnBvbGF0aW9uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB2CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBrCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBjYXRtdWxsUm9tSW50ZXJwb2xhdGlvbjogZnVuY3Rpb24gKHYsIGspIHsKCiAgICAgICAgdmFyIG0gPSB2Lmxlbmd0aCAtIDE7CiAgICAgICAgdmFyIGYgPSBtICogazsKICAgICAgICB2YXIgaSA9IE1hdGguZmxvb3IoZik7CgogICAgICAgIGlmICh2WzBdID09PSB2W21dKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGsgPCAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpID0gTWF0aC5mbG9vcihmID0gbSAqICgxICsgaykpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRtdWxsUm9tKHZbKGkgLSAxICsgbSkgJSBtXSwgdltpXSwgdlsoaSArIDEpICUgbV0sIHZbKGkgKyAyKSAlIG1dLCBmIC0gaSk7CgogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoayA8IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB2WzBdIC0gKHRoaXMuY2F0bXVsbFJvbSh2WzBdLCB2WzBdLCB2WzFdLCB2WzFdLCAtZikgLSB2WzBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGsgPiAxKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdlttXSAtICh0aGlzLmNhdG11bGxSb20odlttXSwgdlttXSwgdlttIC0gMV0sIHZbbSAtIDFdLCBmIC0gbSkgLSB2W21dKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2F0bXVsbFJvbSh2W2kgPyBpIC0gMSA6IDBdLCB2W2ldLCB2W20gPCBpICsgMSA/IG0gOiBpICsgMV0sIHZbbSA8IGkgKyAyID8gbSA6IGkgKyAyXSwgZiAtIGkpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNMaW5lYXIKICAgICogQHBhcmFtIHtudW1iZXJ9IHAwCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBwMQogICAgKiBAcGFyYW0ge251bWJlcn0gdAogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgbGluZWFyOiBmdW5jdGlvbiAocDAsIHAxLCB0KSB7CiAgICAgICAgcmV0dXJuIChwMSAtIHAwKSAqIHQgKyBwMDsKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjYmVybnN0ZWluCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBiZXJuc3RlaW46IGZ1bmN0aW9uIChuLCBpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZmFjdG9yaWFsKG4pIC8gdGhpcy5mYWN0b3JpYWwoaSkgLyB0aGlzLmZhY3RvcmlhbChuIC0gaSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNjYXRtdWxsUm9tCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBwMAogICAgKiBAcGFyYW0ge251bWJlcn0gcDEKICAgICogQHBhcmFtIHtudW1iZXJ9IHAyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBwMwogICAgKiBAcGFyYW0ge251bWJlcn0gdAogICAgKiBAcmV0dXJuIHtudW1iZXJ9IAogICAgKi8KICAgIGNhdG11bGxSb206IGZ1bmN0aW9uIChwMCwgcDEsIHAyLCBwMywgdCkgewoKICAgICAgICB2YXIgdjAgPSAocDIgLSBwMCkgKiAwLjUsIHYxID0gKHAzIC0gcDEpICogMC41LCB0MiA9IHQgKiB0LCB0MyA9IHQgKiB0MjsKCiAgICAgICAgcmV0dXJuICgyICogcDEgLSAyICogcDIgKyB2MCArIHYxKSAqIHQzICsgKC0zICogcDEgKyAzICogcDIgLSAyICogdjAgLSB2MSkgKiB0MiArIHYwICogdCArIHAxOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZGlmZmVyZW5jZQogICAgKiBAcGFyYW0ge251bWJlcn0gYQogICAgKiBAcGFyYW0ge251bWJlcn0gYgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgZGlmZmVyZW5jZTogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gTWF0aC5hYnMoYSAtIGIpOwogICAgfSwKCiAgICAvKioKICAgICogRmV0Y2ggYSByYW5kb20gZW50cnkgZnJvbSB0aGUgZ2l2ZW4gYXJyYXkuCiAgICAqIFdpbGwgcmV0dXJuIG51bGwgaWYgcmFuZG9tIHNlbGVjdGlvbiBpcyBtaXNzaW5nLCBvciBhcnJheSBoYXMgbm8gZW50cmllcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNnZXRSYW5kb20KICAgICogQHBhcmFtIHthcnJheX0gb2JqZWN0cyAtIEFuIGFycmF5IG9mIG9iamVjdHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydEluZGV4IC0gT3B0aW9uYWwgb2Zmc2V0IG9mZiB0aGUgZnJvbnQgb2YgdGhlIGFycmF5LiBEZWZhdWx0IHZhbHVlIGlzIDAsIG9yIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5LgogICAgKiBAcGFyYW0ge251bWJlcn0gbGVuZ3RoIC0gT3B0aW9uYWwgcmVzdHJpY3Rpb24gb24gdGhlIG51bWJlciBvZiB2YWx1ZXMgeW91IHdhbnQgdG8gcmFuZG9tbHkgc2VsZWN0IGZyb20uCiAgICAqIEByZXR1cm4ge29iamVjdH0gVGhlIHJhbmRvbSBvYmplY3QgdGhhdCB3YXMgc2VsZWN0ZWQuCiAgICAqLwogICAgZ2V0UmFuZG9tOiBmdW5jdGlvbiAob2JqZWN0cywgc3RhcnRJbmRleCwgbGVuZ3RoKSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3RhcnRJbmRleCA9PT0gInVuZGVmaW5lZCIpIHsgc3RhcnRJbmRleCA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PT0gInVuZGVmaW5lZCIpIHsgbGVuZ3RoID0gMDsgfQogICAgICAgIAogICAgICAgIGlmIChvYmplY3RzICE9IG51bGwpIHsKCiAgICAgICAgICAgIHZhciBsID0gbGVuZ3RoOwoKICAgICAgICAgICAgaWYgKChsID09PSAwKSB8fCAobCA+IG9iamVjdHMubGVuZ3RoIC0gc3RhcnRJbmRleCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGwgPSBvYmplY3RzLmxlbmd0aCAtIHN0YXJ0SW5kZXg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChsID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdHNbc3RhcnRJbmRleCArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGwpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogUm91bmQgZG93biB0byB0aGUgbmV4dCB3aG9sZSBudW1iZXIuIEUuZy4gZmxvb3IoMS43KSA9PSAxLCBhbmQgZmxvb3IoLTIuNykgPT0gLTIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZmxvb3IKICAgICogQHBhcmFtIHtudW1iZXJ9IFZhbHVlIEFueSBudW1iZXIuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHJvdW5kZWQgdmFsdWUgb2YgdGhhdCBudW1iZXIuCiAgICAqLwogICAgZmxvb3I6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICB2YXIgbiA9IHZhbHVlIHwgMDsKCiAgICAgICAgcmV0dXJuICh2YWx1ZSA+IDApID8gKG4pIDogKChuICE9IHZhbHVlKSA/IChuIC0gMSkgOiAobikpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJvdW5kIHVwIHRvIHRoZSBuZXh0IHdob2xlIG51bWJlci4gIEUuZy4gY2VpbCgxLjMpID09IDIsIGFuZCBjZWlsKC0yLjMpID09IC0zLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2NlaWwKICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gQW55IG51bWJlci4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgcm91bmRlZCB2YWx1ZSBvZiB0aGF0IG51bWJlci4KICAgICovCiAgICBjZWlsOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB2YXIgbiA9IHZhbHVlIHwgMDsKICAgICAgICByZXR1cm4gKHZhbHVlID4gMCkgPyAoKG4gIT0gdmFsdWUpID8gKG4gKyAxKSA6IChuKSkgOiAobik7CiAgICB9LAoKICAgIC8qKgogICAgKiBHZW5lcmF0ZSBhIHNpbmUgYW5kIGNvc2luZSB0YWJsZSBzaW11bHRhbmVvdXNseSBhbmQgZXh0cmVtZWx5IHF1aWNrbHkuIEJhc2VkIG9uIHJlc2VhcmNoIGJ5IEZyYW5reSBvZiBzY2VuZS5hdAogICAgKiA8cD4KICAgICogVGhlIHBhcmFtZXRlcnMgYWxsb3cgeW91IHRvIHNwZWNpZnkgdGhlIGxlbmd0aCwgYW1wbGl0dWRlIGFuZCBmcmVxdWVuY3kgb2YgdGhlIHdhdmUuIE9uY2UgeW91IGhhdmUgY2FsbGVkIHRoaXMgZnVuY3Rpb24KICAgICogeW91IHNob3VsZCBnZXQgdGhlIHJlc3VsdHMgdmlhIGdldFNpblRhYmxlKCkgYW5kIGdldENvc1RhYmxlKCkuIFRoaXMgZ2VuZXJhdG9yIGlzIGZhc3QgZW5vdWdoIHRvIGJlIHVzZWQgaW4gcmVhbC10aW1lLgogICAgKiA8L3A+CiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc2luQ29zR2VuZXJhdG9yCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBsZW5ndGggLSBUaGUgbGVuZ3RoIG9mIHRoZSB3YXZlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzaW5BbXBsaXR1ZGUgLSBUaGUgYW1wbGl0dWRlIHRvIGFwcGx5IHRvIHRoZSBzaW5lIHRhYmxlIChkZWZhdWx0IDEuMCkgaWYgeW91IG5lZWQgdmFsdWVzIGJldHdlZW4gc2F5IC0rIDEyNSB0aGVuIGdpdmUgMTI1IGFzIHRoZSB2YWx1ZQogICAgKiBAcGFyYW0ge251bWJlcn0gY29zQW1wbGl0dWRlIC0gVGhlIGFtcGxpdHVkZSB0byBhcHBseSB0byB0aGUgY29zaW5lIHRhYmxlIChkZWZhdWx0IDEuMCkgaWYgeW91IG5lZWQgdmFsdWVzIGJldHdlZW4gc2F5IC0rIDEyNSB0aGVuIGdpdmUgMTI1IGFzIHRoZSB2YWx1ZQogICAgKiBAcGFyYW0ge251bWJlcn0gZnJlcXVlbmN5ICAtIFRoZSBmcmVxdWVuY3kgb2YgdGhlIHNpbmUgYW5kIGNvc2luZSB0YWJsZSBkYXRhCiAgICAqIEByZXR1cm4ge0FycmF5fSBSZXR1cm5zIHRoZSBzaW5lIHRhYmxlCiAgICAqLwogICAgc2luQ29zR2VuZXJhdG9yOiBmdW5jdGlvbiAobGVuZ3RoLCBzaW5BbXBsaXR1ZGUsIGNvc0FtcGxpdHVkZSwgZnJlcXVlbmN5KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc2luQW1wbGl0dWRlID09PSAidW5kZWZpbmVkIikgeyBzaW5BbXBsaXR1ZGUgPSAxLjA7IH0KICAgICAgICBpZiAodHlwZW9mIGNvc0FtcGxpdHVkZSA9PT0gInVuZGVmaW5lZCIpIHsgY29zQW1wbGl0dWRlID0gMS4wOyB9CiAgICAgICAgaWYgKHR5cGVvZiBmcmVxdWVuY3kgPT09ICJ1bmRlZmluZWQiKSB7IGZyZXF1ZW5jeSA9IDEuMDsgfQogICAgICAgIAogICAgICAgIHZhciBzaW4gPSBzaW5BbXBsaXR1ZGU7CiAgICAgICAgdmFyIGNvcyA9IGNvc0FtcGxpdHVkZTsKICAgICAgICB2YXIgZnJxID0gZnJlcXVlbmN5ICogTWF0aC5QSSAvIGxlbmd0aDsKICAgICAgICAKICAgICAgICB2YXIgY29zVGFibGUgPSBbXTsKICAgICAgICB2YXIgc2luVGFibGUgPSBbXTsKICAgICAgICAKICAgICAgICBmb3IgKHZhciBjID0gMDsgYyA8IGxlbmd0aDsgYysrKSB7CgogICAgICAgICAgICBjb3MgLT0gc2luICogZnJxOwogICAgICAgICAgICBzaW4gKz0gY29zICogZnJxOwoKICAgICAgICAgICAgY29zVGFibGVbY10gPSBjb3M7CiAgICAgICAgICAgIHNpblRhYmxlW2NdID0gc2luOwoKICAgICAgICB9CgogICAgICAgIHJldHVybiB7IHNpbjogc2luVGFibGUsIGNvczogY29zVGFibGUsIGxlbmd0aDogbGVuZ3RoIH07CgogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlcyB0aGUgdG9wIGVsZW1lbnQgZnJvbSB0aGUgc3RhY2sgYW5kIHJlLWluc2VydHMgaXQgb250byB0aGUgYm90dG9tLCB0aGVuIHJldHVybnMgaXQuCiAgICAqIFRoZSBvcmlnaW5hbCBzdGFjayBpcyBtb2RpZmllZCBpbiB0aGUgcHJvY2Vzcy4gVGhpcyBlZmZlY3RpdmVseSBtb3ZlcyB0aGUgcG9zaXRpb24gb2YgdGhlIGRhdGEgZnJvbSB0aGUgc3RhcnQgdG8gdGhlIGVuZCBvZiB0aGUgdGFibGUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3NoaWZ0CiAgICAqIEBwYXJhbSB7YXJyYXl9IHN0YWNrIC0gVGhlIGFycmF5IHRvIHNoaWZ0LgogICAgKiBAcmV0dXJuIHthbnl9IFRoZSBzaGlmdGVkIHZhbHVlLgogICAgKi8KICAgIHNoaWZ0OiBmdW5jdGlvbiAoc3RhY2spIHsKCiAgICAgICAgdmFyIHMgPSBzdGFjay5zaGlmdCgpOwogICAgICAgIHN0YWNrLnB1c2gocyk7CgogICAgICAgIHJldHVybiBzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNodWZmbGVzIHRoZSBkYXRhIGluIHRoZSBnaXZlbiBhcnJheSBpbnRvIGEgbmV3IG9yZGVyCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc2h1ZmZsZUFycmF5CiAgICAqIEBwYXJhbSB7YXJyYXl9IGFycmF5IC0gVGhlIGFycmF5IHRvIHNodWZmbGUKICAgICogQHJldHVybiB7YXJyYXl9IFRoZSBhcnJheQogICAgKi8KICAgIHNodWZmbGVBcnJheTogZnVuY3Rpb24gKGFycmF5KSB7CgogICAgICAgIGZvciAodmFyIGkgPSBhcnJheS5sZW5ndGggLSAxOyBpID4gMDsgaS0tKSB7CgogICAgICAgICAgICB2YXIgaiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChpICsgMSkpOwogICAgICAgICAgICB2YXIgdGVtcCA9IGFycmF5W2ldOwogICAgICAgICAgICBhcnJheVtpXSA9IGFycmF5W2pdOwogICAgICAgICAgICBhcnJheVtqXSA9IHRlbXA7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYXJyYXk7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgdHdvIGdpdmVuIHNldCBvZiBjb29yZGluYXRlcy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZGlzdGFuY2UKICAgICogQHBhcmFtIHtudW1iZXJ9IHgxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MQogICAgKiBAcGFyYW0ge251bWJlcn0geDIKICAgICogQHBhcmFtIHtudW1iZXJ9IHkyCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhlIHR3byBzZXRzIG9mIGNvb3JkaW5hdGVzLgogICAgKi8KICAgIGRpc3RhbmNlOiBmdW5jdGlvbiAoeDEsIHkxLCB4MiwgeTIpIHsKCiAgICAgICAgdmFyIGR4ID0geDEgLSB4MjsKICAgICAgICB2YXIgZHkgPSB5MSAtIHkyOwoKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KGR4ICogZHggKyBkeSAqIGR5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSB0d28gZ2l2ZW4gc2V0IG9mIGNvb3JkaW5hdGVzIGF0IHRoZSBwb3dlciBnaXZlbi4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZGlzdGFuY2VQb3cKICAgICogQHBhcmFtIHtudW1iZXJ9IHgxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MQogICAgKiBAcGFyYW0ge251bWJlcn0geDIKICAgICogQHBhcmFtIHtudW1iZXJ9IHkyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcG93PTJdCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhlIHR3byBzZXRzIG9mIGNvb3JkaW5hdGVzLgogICAgKi8KICAgIGRpc3RhbmNlUG93OiBmdW5jdGlvbiAoeDEsIHkxLCB4MiwgeTIsIHBvdykgewoKICAgICAgICBpZiAodHlwZW9mIHBvdyA9PT0gJ3VuZGVmaW5lZCcpIHsgcG93ID0gMjsgfQoKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KE1hdGgucG93KHgyIC0geDEsIHBvdykgKyBNYXRoLnBvdyh5MiAtIHkxLCBwb3cpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSByb3VuZGVkIGRpc3RhbmNlIGJldHdlZW4gdGhlIHR3byBnaXZlbiBzZXQgb2YgY29vcmRpbmF0ZXMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2Rpc3RhbmNlUm91bmRlZAogICAgKiBAcGFyYW0ge251bWJlcn0geDEKICAgICogQHBhcmFtIHtudW1iZXJ9IHkxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MgogICAgKiBAcGFyYW0ge251bWJlcn0geTIKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGlzIFBvaW50IG9iamVjdCBhbmQgdGhlIGRlc3RpbmF0aW9uIFBvaW50IG9iamVjdC4KICAgICovCiAgICBkaXN0YW5jZVJvdW5kZWQ6IGZ1bmN0aW9uICh4MSwgeTEsIHgyLCB5MikgewoKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChQaGFzZXIuTWF0aC5kaXN0YW5jZSh4MSwgeTEsIHgyLCB5MikpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEZvcmNlIGEgdmFsdWUgd2l0aGluIHRoZSBib3VuZGFyaWVzIG9mIHR3byB2YWx1ZXMuCiAgICAqIENsYW1wIHZhbHVlIHRvIHJhbmdlIDxhLCBiPgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNjbGFtcAogICAgKiBAcGFyYW0ge251bWJlcn0geAogICAgKiBAcGFyYW0ge251bWJlcn0gYQogICAgKiBAcGFyYW0ge251bWJlcn0gYgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgY2xhbXA6IGZ1bmN0aW9uICggeCwgYSwgYiApIHsKCiAgICAgICAgcmV0dXJuICggeCA8IGEgKSA/IGEgOiAoICggeCA+IGIgKSA/IGIgOiB4ICk7CgogICAgfSwKIAogICAgLyoqCiAgICAqIENsYW1wIHZhbHVlIHRvIHJhbmdlIDxhLCBpbmYpLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNjbGFtcEJvdHRvbQogICAgKiBAcGFyYW0ge251bWJlcn0geAogICAgKiBAcGFyYW0ge251bWJlcn0gYQogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgY2xhbXBCb3R0b206IGZ1bmN0aW9uICggeCwgYSApIHsKCiAgICAgICAgcmV0dXJuIHggPCBhID8gYSA6IHg7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGlmIHR3byB2YWx1ZXMgYXJlIHdpdGhpbiB0aGUgZ2l2ZW4gdG9sZXJhbmNlIG9mIGVhY2ggb3RoZXIuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3dpdGhpbgogICAgKiBAcGFyYW0ge251bWJlcn0gYSAtIFRoZSBmaXJzdCBudW1iZXIgdG8gY2hlY2sKICAgICogQHBhcmFtIHtudW1iZXJ9IGIgLSBUaGUgc2Vjb25kIG51bWJlciB0byBjaGVjawogICAgKiBAcGFyYW0ge251bWJlcn0gdG9sZXJhbmNlIC0gVGhlIHRvbGVyYW5jZS4gQW55dGhpbmcgZXF1YWwgdG8gb3IgbGVzcyB0aGFuIHRoaXMgaXMgY29uc2lkZXJlZCB3aXRoaW4gdGhlIHJhbmdlLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGEgaXMgPD0gdG9sZXJhbmNlIG9mIGIuCiAgICAqLwogICAgd2l0aGluOiBmdW5jdGlvbiAoIGEsIGIsIHRvbGVyYW5jZSApIHsKCiAgICAgICAgcmV0dXJuIChNYXRoLmFicyhhIC0gYikgPD0gdG9sZXJhbmNlKTsKCiAgICB9LAogCiAgICAvKioKICAgICogTGluZWFyIG1hcHBpbmcgZnJvbSByYW5nZSA8YTEsIGEyPiB0byByYW5nZSA8YjEsIGIyPgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNtYXBMaW5lYXIKICAgICogQHBhcmFtIHtudW1iZXJ9IHgKICAgICogQHBhcmFtIHtudW1iZXJ9IGExCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhMQogICAgKiBAcGFyYW0ge251bWJlcn0gYTIKICAgICogQHBhcmFtIHtudW1iZXJ9IGIxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBiMgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgbWFwTGluZWFyOiBmdW5jdGlvbiAoIHgsIGExLCBhMiwgYjEsIGIyICkgewoKICAgICAgICByZXR1cm4gYjEgKyAoIHggLSBhMSApICogKCBiMiAtIGIxICkgLyAoIGEyIC0gYTEgKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTbW9vdGhzdGVwIGZ1bmN0aW9uIGFzIGRldGFpbGVkIGF0IGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU21vb3Roc3RlcAogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNzbW9vdGhzdGVwCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heAogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgc21vb3Roc3RlcDogZnVuY3Rpb24gKCB4LCBtaW4sIG1heCApIHsKCiAgICAgICAgaWYgKHggPD0gbWluKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgICAgICBpZiAoeCA+PSBtYXgpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CgogICAgICAgIHggPSAoeCAtIG1pbikgLyAobWF4IC0gbWluKTsKCiAgICAgICAgcmV0dXJuIHggKiB4ICogKDMgLSAyICogeCk7CgogICAgfSwKCiAgICAvKioKICAgICogU21vb3RoZXJzdGVwIGZ1bmN0aW9uIGFzIGRldGFpbGVkIGF0IGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU21vb3Roc3RlcAogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNzbW9vdGhlcnN0ZXAKICAgICogQHBhcmFtIHtudW1iZXJ9IHgKICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4CiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBzbW9vdGhlcnN0ZXA6IGZ1bmN0aW9uICggeCwgbWluLCBtYXggKSB7CgogICAgICAgIGlmICh4IDw9IG1pbikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKHggPj0gbWF4KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQoKICAgICAgICB4ID0gKHggLSBtaW4pIC8gKG1heCAtIG1pbik7CgogICAgICAgIHJldHVybiB4ICogeCAqIHggKiAoeCAqICh4ICogNiAtIDE1KSArIDEwKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIHZhbHVlIHJlcHJlc2VudGluZyB0aGUgc2lnbiBvZiB0aGUgdmFsdWUuCiAgICAqIC0xIGZvciBuZWdhdGl2ZSwgKzEgZm9yIHBvc2l0aXZlLCAwIGlmIHZhbHVlIGlzIDAKICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc2lnbgogICAgKiBAcGFyYW0ge251bWJlcn0geAogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgc2lnbjogZnVuY3Rpb24gKCB4ICkgewoKICAgICAgICByZXR1cm4gKCB4IDwgMCApID8gLTEgOiAoICggeCA+IDAgKSA/IDEgOiAwICk7CgogICAgfSwKCiAgICAvKioKICAgICogQ29udmVydCBkZWdyZWVzIHRvIHJhZGlhbnMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2RlZ1RvUmFkCiAgICAqIEByZXR1cm4ge2Z1bmN0aW9ufQogICAgKi8KICAgIGRlZ1RvUmFkOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIGRlZ3JlZVRvUmFkaWFuc0ZhY3RvciA9IE1hdGguUEkgLyAxODA7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoIGRlZ3JlZXMgKSB7CgogICAgICAgICAgICByZXR1cm4gZGVncmVlcyAqIGRlZ3JlZVRvUmFkaWFuc0ZhY3RvcjsKCiAgICAgICAgfTsKCiAgICB9KCksCgogICAgLyoqCiAgICAqIENvbnZlcnQgZGVncmVlcyB0byByYWRpYW5zLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNyYWRUb0RlZwogICAgKiBAcmV0dXJuIHtmdW5jdGlvbn0KICAgICovCiAgICByYWRUb0RlZzogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciByYWRpYW5Ub0RlZ3JlZXNGYWN0b3IgPSAxODAgLyBNYXRoLlBJOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCByYWRpYW5zICkgewoKICAgICAgICAgICAgcmV0dXJuIHJhZGlhbnMgKiByYWRpYW5Ub0RlZ3JlZXNGYWN0b3I7CgogICAgICAgIH07CgogICAgfSgpCgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogSmF2YXNjcmlwdCBRdWFkVHJlZSAKKiBAdmVyc2lvbiAxLjAKKiBAYXV0aG9yIFRpbW8gSGF1c21hbm4KKgoqIEB2ZXJzaW9uIDEuMiwgU2VwdGVtYmVyIDR0aCAyMDEzCiogQGF1dGhvciBSaWNoYXJkIERhdmV5CiogVGhlIG9yaWdpbmFsIGNvZGUgd2FzIGEgY29udmVyc2lvbiBvZiB0aGUgSmF2YSBjb2RlIHBvc3RlZCB0byBHYW1lRGV2VHV0cy4gSG93ZXZlciBJJ3ZlIHR3ZWFrZWQKKiBpdCBtYXNzaXZlbHkgdG8gYWRkIG5vZGUgaW5kZXhpbmcsIHJlbW92ZWQgbG90cyBvZiB0ZW1wLiB2YXIgY3JlYXRpb24gYW5kIHNpZ25pZmljYW50bHkKKiBpbmNyZWFzZWQgcGVyZm9ybWFuY2UgYXMgYSByZXN1bHQuCioKKiBPcmlnaW5hbCB2ZXJzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS90aW1vaGF1c21hbm4vcXVhZHRyZWUtanMvCiovCiAKLyoqCiogQGNvcHlyaWdodCDCqSAyMDEyIFRpbW8gSGF1c21hbm4KKgoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZwoqIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQoqICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKKiB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiogZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvCiogcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvCiogdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoqCiogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUKKiBpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KKgoqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELAoqIEVYUFJFU1MgT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgoqIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5ECiogTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRQoqIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04KKiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04KKiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KKi8KCi8qKgoqIFF1YWRUcmVlIENvbnN0cnVjdG9yCiogCiogQGNsYXNzIFBoYXNlci5RdWFkVHJlZQoqIEBjbGFzc2Rlc2MgQSBRdWFkVHJlZSBpbXBsZW1lbnRhdGlvbi4gVGhlIG9yaWdpbmFsIGNvZGUgd2FzIGEgY29udmVyc2lvbiBvZiB0aGUgSmF2YSBjb2RlIHBvc3RlZCB0byBHYW1lRGV2VHV0cy4gCiogSG93ZXZlciBJJ3ZlIHR3ZWFrZWQgaXQgbWFzc2l2ZWx5IHRvIGFkZCBub2RlIGluZGV4aW5nLCByZW1vdmVkIGxvdHMgb2YgdGVtcC4gdmFyIGNyZWF0aW9uIGFuZCBzaWduaWZpY2FudGx5IGluY3JlYXNlZCBwZXJmb3JtYW5jZSBhcyBhIHJlc3VsdC4gCiogT3JpZ2luYWwgdmVyc2lvbiBhdCBodHRwczovL2dpdGh1Yi5jb20vdGltb2hhdXNtYW5uL3F1YWR0cmVlLWpzLwoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHRvcCBsZWZ0IGNvb3JkaW5hdGUgb2YgdGhlIHF1YWR0cmVlLgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHRvcCBsZWZ0IGNvb3JkaW5hdGUgb2YgdGhlIHF1YWR0cmVlLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgcXVhZHRyZWUgaW4gcGl4ZWxzLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBxdWFkdHJlZSBpbiBwaXhlbHMuCiogQHBhcmFtIHtudW1iZXJ9IFttYXhPYmplY3RzPTEwXSAtIFRoZSBtYXhpbXVtIG51bWJlciBvZiBvYmplY3RzIHBlciBub2RlLgoqIEBwYXJhbSB7bnVtYmVyfSBbbWF4TGV2ZWxzPTRdIC0gVGhlIG1heGltdW0gbnVtYmVyIG9mIGxldmVscyB0byBpdGVyYXRlIHRvLgoqIEBwYXJhbSB7bnVtYmVyfSBbbGV2ZWw9MF0gLSBXaGljaCBsZXZlbCBpcyB0aGlzPwoqLwpQaGFzZXIuUXVhZFRyZWUgPSBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCwgbWF4T2JqZWN0cywgbWF4TGV2ZWxzLCBsZXZlbCkgewogICAgICAgIAogICAgdGhpcy5tYXhPYmplY3RzID0gbWF4T2JqZWN0cyB8fCAxMDsKICAgIHRoaXMubWF4TGV2ZWxzID0gbWF4TGV2ZWxzIHx8IDQ7CiAgICB0aGlzLmxldmVsID0gbGV2ZWwgfHwgMDsKCiAgICB0aGlzLmJvdW5kcyA9IHsKICAgICAgICB4OiBNYXRoLnJvdW5kKHgpLAogICAgICAgIHk6IE1hdGgucm91bmQoeSksCiAgICAgICAgd2lkdGg6IHdpZHRoLAogICAgICAgIGhlaWdodDogaGVpZ2h0LAogICAgICAgIHN1YldpZHRoOiBNYXRoLmZsb29yKHdpZHRoIC8gMiksCiAgICAgICAgc3ViSGVpZ2h0OiBNYXRoLmZsb29yKGhlaWdodCAvIDIpLAogICAgICAgIHJpZ2h0OiBNYXRoLnJvdW5kKHgpICsgTWF0aC5mbG9vcih3aWR0aCAvIDIpLAogICAgICAgIGJvdHRvbTogTWF0aC5yb3VuZCh5KSArIE1hdGguZmxvb3IoaGVpZ2h0IC8gMikKICAgIH07CiAgICAKICAgIHRoaXMub2JqZWN0cyA9IFtdOwogICAgdGhpcy5ub2RlcyA9IFtdOwoKfTsKClBoYXNlci5RdWFkVHJlZS5wcm90b3R5cGUgPSB7CgogICAgLyoKICAgICogUG9wdWxhdGVzIHRoaXMgcXVhZHRyZWUgd2l0aCB0aGUgbWVtYmVycyBvZiB0aGUgZ2l2ZW4gR3JvdXAuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5RdWFkVHJlZSNwb3B1bGF0ZQogICAgKiBAcGFyYW0ge1BoYXNlci5Hcm91cH0gZ3JvdXAgLSBUaGUgR3JvdXAgdG8gYWRkIHRvIHRoZSBxdWFkdHJlZS4KICAgICovCiAgICBwb3B1bGF0ZTogZnVuY3Rpb24gKGdyb3VwKSB7CgogICAgICAgIGdyb3VwLmZvckVhY2godGhpcy5wb3B1bGF0ZUhhbmRsZXIsIHRoaXMsIHRydWUpOwoKICAgIH0sCgogICAgLyoKICAgICogSGFuZGxlciBmb3IgdGhlIHBvcHVsYXRlIG1ldGhvZC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlF1YWRUcmVlI3BvcHVsYXRlSGFuZGxlcgogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFRoZSBTcHJpdGUgdG8gY2hlY2suCiAgICAqLwogICAgcG9wdWxhdGVIYW5kbGVyOiBmdW5jdGlvbiAoc3ByaXRlKSB7CgogICAgICAgIGlmIChzcHJpdGUuYm9keSAmJiBzcHJpdGUuYm9keS5jaGVja0NvbGxpc2lvbi5ub25lID09PSBmYWxzZSAmJiBzcHJpdGUuYWxpdmUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmluc2VydChzcHJpdGUuYm9keSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoKICAgICogU3BsaXQgdGhlIG5vZGUgaW50byA0IHN1Ym5vZGVzCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5RdWFkVHJlZSNzcGxpdAogICAgKi8KICAgIHNwbGl0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMubGV2ZWwrKzsKICAgICAgICAKICAgICAgICAvLyAgdG9wIHJpZ2h0IG5vZGUKICAgICAgICB0aGlzLm5vZGVzWzBdID0gbmV3IFBoYXNlci5RdWFkVHJlZSh0aGlzLmJvdW5kcy5yaWdodCwgdGhpcy5ib3VuZHMueSwgdGhpcy5ib3VuZHMuc3ViV2lkdGgsIHRoaXMuYm91bmRzLnN1YkhlaWdodCwgdGhpcy5tYXhPYmplY3RzLCB0aGlzLm1heExldmVscywgdGhpcy5sZXZlbCk7CiAgICAgICAgCiAgICAgICAgLy8gIHRvcCBsZWZ0IG5vZGUKICAgICAgICB0aGlzLm5vZGVzWzFdID0gbmV3IFBoYXNlci5RdWFkVHJlZSh0aGlzLmJvdW5kcy54LCB0aGlzLmJvdW5kcy55LCB0aGlzLmJvdW5kcy5zdWJXaWR0aCwgdGhpcy5ib3VuZHMuc3ViSGVpZ2h0LCB0aGlzLm1heE9iamVjdHMsIHRoaXMubWF4TGV2ZWxzLCB0aGlzLmxldmVsKTsKICAgICAgICAKICAgICAgICAvLyAgYm90dG9tIGxlZnQgbm9kZQogICAgICAgIHRoaXMubm9kZXNbMl0gPSBuZXcgUGhhc2VyLlF1YWRUcmVlKHRoaXMuYm91bmRzLngsIHRoaXMuYm91bmRzLmJvdHRvbSwgdGhpcy5ib3VuZHMuc3ViV2lkdGgsIHRoaXMuYm91bmRzLnN1YkhlaWdodCwgdGhpcy5tYXhPYmplY3RzLCB0aGlzLm1heExldmVscywgdGhpcy5sZXZlbCk7CiAgICAgICAgCiAgICAgICAgLy8gIGJvdHRvbSByaWdodCBub2RlCiAgICAgICAgdGhpcy5ub2Rlc1szXSA9IG5ldyBQaGFzZXIuUXVhZFRyZWUodGhpcy5ib3VuZHMucmlnaHQsIHRoaXMuYm91bmRzLmJvdHRvbSwgdGhpcy5ib3VuZHMuc3ViV2lkdGgsIHRoaXMuYm91bmRzLnN1YkhlaWdodCwgdGhpcy5tYXhPYmplY3RzLCB0aGlzLm1heExldmVscywgdGhpcy5sZXZlbCk7CgogICAgfSwKCiAgICAvKgogICAgKiBJbnNlcnQgdGhlIG9iamVjdCBpbnRvIHRoZSBub2RlLiBJZiB0aGUgbm9kZSBleGNlZWRzIHRoZSBjYXBhY2l0eSwgaXQgd2lsbCBzcGxpdCBhbmQgYWRkIGFsbCBvYmplY3RzIHRvIHRoZWlyIGNvcnJlc3BvbmRpbmcgc3Vibm9kZXMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5RdWFkVHJlZSNpbnNlcnQKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keXxvYmplY3R9IGJvZHkgLSBUaGUgQm9keSBvYmplY3QgdG8gaW5zZXJ0IGludG8gdGhlIHF1YWR0cmVlLgogICAgKi8KICAgIGluc2VydDogZnVuY3Rpb24gKGJvZHkpIHsKICAgICAgICAKICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgdmFyIGluZGV4OwogICAgICAgIAogICAgICAgIC8vICBpZiB3ZSBoYXZlIHN1Ym5vZGVzIC4uLgogICAgICAgIGlmICh0aGlzLm5vZGVzWzBdICE9IG51bGwpCiAgICAgICAgewogICAgICAgICAgICBpbmRleCA9IHRoaXMuZ2V0SW5kZXgoYm9keSk7CiAgICAgCiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMubm9kZXNbaW5kZXhdLmluc2VydChib2R5KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAKICAgICAgICB0aGlzLm9iamVjdHMucHVzaChib2R5KTsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5vYmplY3RzLmxlbmd0aCA+IHRoaXMubWF4T2JqZWN0cyAmJiB0aGlzLmxldmVsIDwgdGhpcy5tYXhMZXZlbHMpCiAgICAgICAgewogICAgICAgICAgICAvLyAgU3BsaXQgaWYgd2UgZG9uJ3QgYWxyZWFkeSBoYXZlIHN1Ym5vZGVzCiAgICAgICAgICAgIGlmICh0aGlzLm5vZGVzWzBdID09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3BsaXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gIEFkZCBvYmplY3RzIHRvIHN1Ym5vZGVzCiAgICAgICAgICAgIHdoaWxlIChpIDwgdGhpcy5vYmplY3RzLmxlbmd0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaW5kZXggPSB0aGlzLmdldEluZGV4KHRoaXMub2JqZWN0c1tpXSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gIHRoaXMgaXMgZXhwZW5zaXZlIC0gc2VlIHdoYXQgd2UgY2FuIGRvIGFib3V0IGl0CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub2Rlc1tpbmRleF0uaW5zZXJ0KHRoaXMub2JqZWN0cy5zcGxpY2UoaSwgMSlbMF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAogICAgIAogICAgLyoKICAgICogRGV0ZXJtaW5lIHdoaWNoIG5vZGUgdGhlIG9iamVjdCBiZWxvbmdzIHRvLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUXVhZFRyZWUjZ2V0SW5kZXgKICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfG9iamVjdH0gcmVjdCAtIFRoZSBib3VuZHMgaW4gd2hpY2ggdG8gY2hlY2suCiAgICAqIEByZXR1cm4ge251bWJlcn0gaW5kZXggLSBJbmRleCBvZiB0aGUgc3Vibm9kZSAoMC0zKSwgb3IgLTEgaWYgcmVjdCBjYW5ub3QgY29tcGxldGVseSBmaXQgd2l0aGluIGEgc3Vibm9kZSBhbmQgaXMgcGFydCBvZiB0aGUgcGFyZW50IG5vZGUuCiAgICAqLwogICAgZ2V0SW5kZXg6IGZ1bmN0aW9uIChyZWN0KSB7CiAgICAgICAgCiAgICAgICAgLy8gIGRlZmF1bHQgaXMgdGhhdCByZWN0IGRvZXNuJ3QgZml0LCBpLmUuIGl0IHN0cmFkZGxlcyB0aGUgaW50ZXJuYWwgcXVhZHJhbnRzCiAgICAgICAgdmFyIGluZGV4ID0gLTE7CgogICAgICAgIGlmIChyZWN0LnggPCB0aGlzLmJvdW5kcy5yaWdodCAmJiByZWN0LnJpZ2h0IDwgdGhpcy5ib3VuZHMucmlnaHQpCiAgICAgICAgewogICAgICAgICAgICBpZiAoKHJlY3QueSA8IHRoaXMuYm91bmRzLmJvdHRvbSAmJiByZWN0LmJvdHRvbSA8IHRoaXMuYm91bmRzLmJvdHRvbSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICByZWN0IGZpdHMgd2l0aGluIHRoZSB0b3AtbGVmdCBxdWFkcmFudCBvZiB0aGlzIHF1YWR0cmVlCiAgICAgICAgICAgICAgICBpbmRleCA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoKHJlY3QueSA+IHRoaXMuYm91bmRzLmJvdHRvbSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICByZWN0IGZpdHMgd2l0aGluIHRoZSBib3R0b20tbGVmdCBxdWFkcmFudCBvZiB0aGlzIHF1YWR0cmVlCiAgICAgICAgICAgICAgICBpbmRleCA9IDI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocmVjdC54ID4gdGhpcy5ib3VuZHMucmlnaHQpCiAgICAgICAgewogICAgICAgICAgICAvLyAgcmVjdCBjYW4gY29tcGxldGVseSBmaXQgd2l0aGluIHRoZSByaWdodCBxdWFkcmFudHMKICAgICAgICAgICAgaWYgKChyZWN0LnkgPCB0aGlzLmJvdW5kcy5ib3R0b20gJiYgcmVjdC5ib3R0b20gPCB0aGlzLmJvdW5kcy5ib3R0b20pKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgcmVjdCBmaXRzIHdpdGhpbiB0aGUgdG9wLXJpZ2h0IHF1YWRyYW50IG9mIHRoaXMgcXVhZHRyZWUKICAgICAgICAgICAgICAgIGluZGV4ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICgocmVjdC55ID4gdGhpcy5ib3VuZHMuYm90dG9tKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIHJlY3QgZml0cyB3aXRoaW4gdGhlIGJvdHRvbS1yaWdodCBxdWFkcmFudCBvZiB0aGlzIHF1YWR0cmVlCiAgICAgICAgICAgICAgICBpbmRleCA9IDM7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgCiAgICAgICAgcmV0dXJuIGluZGV4OwoKICAgIH0sCgogICAgLyoKICAgICogUmV0dXJuIGFsbCBvYmplY3RzIHRoYXQgY291bGQgY29sbGlkZSB3aXRoIHRoZSBnaXZlbiBTcHJpdGUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5RdWFkVHJlZSNyZXRyaWV2ZQogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFRoZSBzcHJpdGUgdG8gY2hlY2sgYWdhaW5zdC4KICAgICogQHJldHVybiB7YXJyYXl9IC0gQXJyYXkgd2l0aCBhbGwgZGV0ZWN0ZWQgb2JqZWN0cy4KICAgICovCiAgICByZXRyaWV2ZTogZnVuY3Rpb24gKHNwcml0ZSkgewogICAgICAgIAogICAgICAgIHZhciByZXR1cm5PYmplY3RzID0gdGhpcy5vYmplY3RzOwoKICAgICAgICBzcHJpdGUuYm9keS5xdWFkVHJlZUluZGV4ID0gdGhpcy5nZXRJbmRleChzcHJpdGUuYm9keSk7CgogICAgICAgIC8vICBUZW1wIHN0b3JlIGZvciB0aGUgbm9kZSBJRHMgdGhpcyBzcHJpdGUgaXMgaW4sIHdlIGNhbiB1c2UgdGhpcyBmb3IgZmFzdCBlbGltaW5hdGlvbiBsYXRlcgogICAgICAgIC8vIHNwcml0ZS5ib2R5LnF1YWRUcmVlSURzLnB1c2godGhpcy5JRCk7CgogICAgICAgIGlmICh0aGlzLm5vZGVzWzBdKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIGlmIHJlY3QgZml0cyBpbnRvIGEgc3Vibm9kZSAuLgogICAgICAgICAgICBpZiAoc3ByaXRlLmJvZHkucXVhZFRyZWVJbmRleCAhPT0gLTEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybk9iamVjdHMgPSByZXR1cm5PYmplY3RzLmNvbmNhdCh0aGlzLm5vZGVzW3Nwcml0ZS5ib2R5LnF1YWRUcmVlSW5kZXhdLnJldHJpZXZlKHNwcml0ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIGlmIHJlY3QgZG9lcyBub3QgZml0IGludG8gYSBzdWJub2RlLCBjaGVjayBpdCBhZ2FpbnN0IGFsbCBzdWJub2RlcyAodW5yb2xsZWQgZm9yIHNwZWVkKQogICAgICAgICAgICAgICAgcmV0dXJuT2JqZWN0cyA9IHJldHVybk9iamVjdHMuY29uY2F0KHRoaXMubm9kZXNbMF0ucmV0cmlldmUoc3ByaXRlKSk7CiAgICAgICAgICAgICAgICByZXR1cm5PYmplY3RzID0gcmV0dXJuT2JqZWN0cy5jb25jYXQodGhpcy5ub2Rlc1sxXS5yZXRyaWV2ZShzcHJpdGUpKTsKICAgICAgICAgICAgICAgIHJldHVybk9iamVjdHMgPSByZXR1cm5PYmplY3RzLmNvbmNhdCh0aGlzLm5vZGVzWzJdLnJldHJpZXZlKHNwcml0ZSkpOwogICAgICAgICAgICAgICAgcmV0dXJuT2JqZWN0cyA9IHJldHVybk9iamVjdHMuY29uY2F0KHRoaXMubm9kZXNbM10ucmV0cmlldmUoc3ByaXRlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgCiAgICAgICAgcmV0dXJuIHJldHVybk9iamVjdHM7CgogICAgfSwKCiAgICAvKgogICAgKiBDbGVhciB0aGUgcXVhZHRyZWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlF1YWRUcmVlI2NsZWFyCiAgICAqLwogICAgY2xlYXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAKICAgICAgICB0aGlzLm9iamVjdHMgPSBbXTsKICAgICAKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5ub2Rlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLm5vZGVzW2ldKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm5vZGVzW2ldLmNsZWFyKCk7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5ub2Rlc1tpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCn07CgpQaGFzZXIuUXVhZFRyZWUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlF1YWRUcmVlOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyBDaXJjbGUgb2JqZWN0IHdpdGggdGhlIGNlbnRlciBjb29yZGluYXRlIHNwZWNpZmllZCBieSB0aGUgeCBhbmQgeSBwYXJhbWV0ZXJzIGFuZCB0aGUgZGlhbWV0ZXIgc3BlY2lmaWVkIGJ5IHRoZSBkaWFtZXRlciBwYXJhbWV0ZXIuIElmIHlvdSBjYWxsIHRoaXMgZnVuY3Rpb24gd2l0aG91dCBwYXJhbWV0ZXJzLCBhIGNpcmNsZSB3aXRoIHgsIHksIGRpYW1ldGVyIGFuZCByYWRpdXMgcHJvcGVydGllcyBzZXQgdG8gMCBpcyBjcmVhdGVkLgoqIEBjbGFzcyBDaXJjbGUKKiBAY2xhc3NkZXNjIFBoYXNlciAtIENpcmNsZQoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7bnVtYmVyfSBbeD0wXSAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlLgoqIEBwYXJhbSB7bnVtYmVyfSBbeT0wXSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlLgoqIEBwYXJhbSB7bnVtYmVyfSBbZGlhbWV0ZXI9MF0gLSBUaGUgZGlhbWV0ZXIgb2YgdGhlIGNpcmNsZS4KKiBAcmV0dXJuIHtQaGFzZXIuQ2lyY2xlfSBUaGlzIGNpcmNsZSBvYmplY3QKKi8KUGhhc2VyLkNpcmNsZSA9IGZ1bmN0aW9uICh4LCB5LCBkaWFtZXRlcikgewoKICAgIHggPSB4IHx8IDA7CiAgICB5ID0geSB8fCAwOwogICAgZGlhbWV0ZXIgPSBkaWFtZXRlciB8fCAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlLgogICAgKi8KICAgIHRoaXMueCA9IHg7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUuCiAgICAqLwogICAgdGhpcy55ID0geTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9kaWFtZXRlciAtIFRoZSBkaWFtZXRlciBvZiB0aGUgY2lyY2xlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2RpYW1ldGVyID0gZGlhbWV0ZXI7CgogICAgaWYgKGRpYW1ldGVyID4gMCkKICAgIHsKICAgICAgICAvKioKICAgICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9yYWRpdXMgLSBUaGUgcmFkaXVzIG9mIHRoZSBjaXJjbGUuCiAgICAgICAqIEBwcml2YXRlCiAgICAgICAqLwogICAgICAgIHRoaXMuX3JhZGl1cyA9IGRpYW1ldGVyICogMC41OwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMuX3JhZGl1cyA9IDA7CiAgICB9Cgp9OwoKUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFRoZSBjaXJjdW1mZXJlbmNlIG9mIHRoZSBjaXJjbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNjaXJjdW1mZXJlbmNlCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBjaXJjdW1mZXJlbmNlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIDIgKiAoTWF0aC5QSSAqIHRoaXMuX3JhZGl1cyk7CiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBtZW1iZXJzIG9mIENpcmNsZSB0byB0aGUgc3BlY2lmaWVkIHZhbHVlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI3NldFRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkaWFtZXRlciAtIFRoZSBkaWFtZXRlciBvZiB0aGUgY2lyY2xlIGluIHBpeGVscy4KICAgICogQHJldHVybiB7Q2lyY2xlfSBUaGlzIGNpcmNsZSBvYmplY3QuCiAgICAqLwogICAgc2V0VG86IGZ1bmN0aW9uICh4LCB5LCBkaWFtZXRlcikgewogICAgICAgIHRoaXMueCA9IHg7CiAgICAgICAgdGhpcy55ID0geTsKICAgICAgICB0aGlzLl9kaWFtZXRlciA9IGRpYW1ldGVyOwogICAgICAgIHRoaXMuX3JhZGl1cyA9IGRpYW1ldGVyICogMC41OwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKioKICAgICogQ29waWVzIHRoZSB4LCB5IGFuZCBkaWFtZXRlciBwcm9wZXJ0aWVzIGZyb20gYW55IGdpdmVuIG9iamVjdCB0byB0aGlzIENpcmNsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI2NvcHlGcm9tCiAgICAqIEBwYXJhbSB7YW55fSBzb3VyY2UgLSBUaGUgb2JqZWN0IHRvIGNvcHkgZnJvbS4KICAgICogQHJldHVybiB7Q2lyY2xlfSBUaGlzIENpcmNsZSBvYmplY3QuCiAgICAqLwogICAgY29weUZyb206IGZ1bmN0aW9uIChzb3VyY2UpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRUbyhzb3VyY2UueCwgc291cmNlLnksIHNvdXJjZS5kaWFtZXRlcik7CiAgICB9LAoKICAgIC8qKgogICAgKiBDb3BpZXMgdGhlIHgsIHkgYW5kIGRpYW1ldGVyIHByb3BlcnRpZXMgZnJvbSB0aGlzIENpcmNsZSB0byBhbnkgZ2l2ZW4gb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjY29weVRvCiAgICAqIEBwYXJhbSB7YW55fSBkZXN0IC0gVGhlIG9iamVjdCB0byBjb3B5IHRvLgogICAgKiBAcmV0dXJuIHtPYmplY3R9IFRoaXMgZGVzdCBvYmplY3QuCiAgICAqLwogICAgY29weVRvOiBmdW5jdGlvbihkZXN0KSB7CiAgICAgICAgZGVzdC54ID0gdGhpcy54OwogICAgICAgIGRlc3QueSA9IHRoaXMueTsKICAgICAgICBkZXN0LmRpYW1ldGVyID0gdGhpcy5fZGlhbWV0ZXI7CiAgICAgICAgcmV0dXJuIGRlc3Q7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBkaXN0YW5jZSBmcm9tIHRoZSBjZW50ZXIgb2YgdGhlIENpcmNsZSBvYmplY3QgdG8gdGhlIGdpdmVuIG9iamVjdAogICAgKiAoY2FuIGJlIENpcmNsZSwgUG9pbnQgb3IgYW55dGhpbmcgd2l0aCB4L3kgcHJvcGVydGllcykKICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI2Rpc3RhbmNlCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBkZXN0IC0gVGhlIHRhcmdldCBvYmplY3QuIE11c3QgaGF2ZSB2aXNpYmxlIHggYW5kIHkgcHJvcGVydGllcyB0aGF0IHJlcHJlc2VudCB0aGUgY2VudGVyIG9mIHRoZSBvYmplY3QuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3JvdW5kXSAtIFJvdW5kIHRoZSBkaXN0YW5jZSB0byB0aGUgbmVhcmVzdCBpbnRlZ2VyIChkZWZhdWx0IGZhbHNlKS4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGlzIFBvaW50IG9iamVjdCBhbmQgdGhlIGRlc3RpbmF0aW9uIFBvaW50IG9iamVjdC4KICAgICovCiAgICBkaXN0YW5jZTogZnVuY3Rpb24gKGRlc3QsIHJvdW5kKSB7CgogICAgICAgIGlmICh0eXBlb2Ygcm91bmQgPT09ICJ1bmRlZmluZWQiKSB7IHJvdW5kID0gZmFsc2UgfQoKICAgICAgICBpZiAocm91bmQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGguZGlzdGFuY2VSb3VuZCh0aGlzLngsIHRoaXMueSwgZGVzdC54LCBkZXN0LnkpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGguZGlzdGFuY2UodGhpcy54LCB0aGlzLnksIGRlc3QueCwgZGVzdC55KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIG5ldyBDaXJjbGUgb2JqZWN0IHdpdGggdGhlIHNhbWUgdmFsdWVzIGZvciB0aGUgeCwgeSwgd2lkdGgsIGFuZCBoZWlnaHQgcHJvcGVydGllcyBhcyB0aGlzIENpcmNsZSBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNjbG9uZQogICAgKiBAcGFyYW0ge1BoYXNlci5DaXJjbGV9IG91dCAtIE9wdGlvbmFsIENpcmNsZSBvYmplY3QuIElmIGdpdmVuIHRoZSB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGUgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgQ2lyY2xlIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQ2lyY2xlfSBUaGUgY2xvbmVkIENpcmNsZSBvYmplY3QuCiAgICAqLwogICAgY2xvbmU6IGZ1bmN0aW9uKG91dCkgewoKICAgICAgICBpZiAodHlwZW9mIG91dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0ID0gbmV3IFBoYXNlci5DaXJjbGUoKTsgfQoKICAgICAgICByZXR1cm4gb3V0LnNldFRvKHRoaXMueCwgdGhpcy55LCB0aGlzLmRpYW1ldGVyKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm4gdHJ1ZSBpZiB0aGUgZ2l2ZW4geC95IGNvb3JkaW5hdGVzIGFyZSB3aXRoaW4gdGhpcyBDaXJjbGUgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjY29udGFpbnMKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgWCB2YWx1ZSBvZiB0aGUgY29vcmRpbmF0ZSB0byB0ZXN0LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBZIHZhbHVlIG9mIHRoZSBjb29yZGluYXRlIHRvIHRlc3QuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGNvb3JkaW5hdGVzIGFyZSB3aXRoaW4gdGhpcyBjaXJjbGUsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBjb250YWluczogZnVuY3Rpb24gKHgsIHkpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLkNpcmNsZS5jb250YWlucyh0aGlzLCB4LCB5KTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSBQb2ludCBvYmplY3QgY29udGFpbmluZyB0aGUgY29vcmRpbmF0ZXMgb2YgYSBwb2ludCBvbiB0aGUgY2lyY3VtZmVyZW5jZSBvZiB0aGUgQ2lyY2xlIGJhc2VkIG9uIHRoZSBnaXZlbiBhbmdsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI2NpcmN1bWZlcmVuY2VQb2ludAogICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgaW4gcmFkaWFucyAodW5sZXNzIGFzRGVncmVlcyBpcyB0cnVlKSB0byByZXR1cm4gdGhlIHBvaW50IGZyb20uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gYXNEZWdyZWVzIC0gSXMgdGhlIGdpdmVuIGFuZ2xlIGluIHJhZGlhbnMgKGZhbHNlKSBvciBkZWdyZWVzICh0cnVlKT8KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRdIC0gQW4gb3B0aW9uYWwgUG9pbnQgb2JqZWN0IHRvIHB1dCB0aGUgcmVzdWx0IGluIHRvLiBJZiBub25lIHNwZWNpZmllZCBhIG5ldyBQb2ludCBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBQb2ludCBvYmplY3QgaG9sZGluZyB0aGUgcmVzdWx0LgogICAgKi8KICAgIGNpcmN1bWZlcmVuY2VQb2ludDogZnVuY3Rpb24gKGFuZ2xlLCBhc0RlZ3JlZXMsIG91dCkgewogICAgICAgIHJldHVybiBQaGFzZXIuQ2lyY2xlLmNpcmN1bWZlcmVuY2VQb2ludCh0aGlzLCBhbmdsZSwgYXNEZWdyZWVzLCBvdXQpOwogICAgfSwKCiAgICAvKioKICAgICogQWRqdXN0cyB0aGUgbG9jYXRpb24gb2YgdGhlIENpcmNsZSBvYmplY3QsIGFzIGRldGVybWluZWQgYnkgaXRzIGNlbnRlciBjb29yZGluYXRlLCBieSB0aGUgc3BlY2lmaWVkIGFtb3VudHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNvZmZzZXQKICAgICogQHBhcmFtIHtudW1iZXJ9IGR4IC0gTW92ZXMgdGhlIHggdmFsdWUgb2YgdGhlIENpcmNsZSBvYmplY3QgYnkgdGhpcyBhbW91bnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkeSAtIE1vdmVzIHRoZSB5IHZhbHVlIG9mIHRoZSBDaXJjbGUgb2JqZWN0IGJ5IHRoaXMgYW1vdW50LgogICAgKiBAcmV0dXJuIHtDaXJjbGV9IFRoaXMgQ2lyY2xlIG9iamVjdC4KICAgICovCiAgICBvZmZzZXQ6IGZ1bmN0aW9uIChkeCwgZHkpIHsKICAgICAgICB0aGlzLnggKz0gZHg7CiAgICAgICAgdGhpcy55ICs9IGR5OwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKioKICAgICogQWRqdXN0cyB0aGUgbG9jYXRpb24gb2YgdGhlIENpcmNsZSBvYmplY3QgdXNpbmcgYSBQb2ludCBvYmplY3QgYXMgYSBwYXJhbWV0ZXIuIFRoaXMgbWV0aG9kIGlzIHNpbWlsYXIgdG8gdGhlIENpcmNsZS5vZmZzZXQoKSBtZXRob2QsIGV4Y2VwdCB0aGF0IGl0IHRha2VzIGEgUG9pbnQgb2JqZWN0IGFzIGEgcGFyYW1ldGVyLgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjb2Zmc2V0UG9pbnQKICAgICogQHBhcmFtIHtQb2ludH0gcG9pbnQgQSBQb2ludCBvYmplY3QgdG8gdXNlIHRvIG9mZnNldCB0aGlzIENpcmNsZSBvYmplY3QgKG9yIGFueSB2YWxpZCBvYmplY3Qgd2l0aCBleHBvc2VkIHggYW5kIHkgcHJvcGVydGllcykuCiAgICAqIEByZXR1cm4ge0NpcmNsZX0gVGhpcyBDaXJjbGUgb2JqZWN0LgogICAgKi8KICAgIG9mZnNldFBvaW50OiBmdW5jdGlvbiAocG9pbnQpIHsKICAgICAgICByZXR1cm4gdGhpcy5vZmZzZXQocG9pbnQueCwgcG9pbnQueSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjdG9TdHJpbmcKICAgICogQHJldHVybiB7c3RyaW5nfSBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgaW5zdGFuY2UuCiAgICAqLwogICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gIlt7UGhhc2VyLkNpcmNsZSAoeD0iICsgdGhpcy54ICsgIiB5PSIgKyB0aGlzLnkgKyAiIGRpYW1ldGVyPSIgKyB0aGlzLmRpYW1ldGVyICsgIiByYWRpdXM9IiArIHRoaXMucmFkaXVzICsgIil9XSI7CiAgICB9Cgp9OwoKUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuQ2lyY2xlOwoKLyoqCiogVGhlIGxhcmdlc3QgZGlzdGFuY2UgYmV0d2VlbiBhbnkgdHdvIHBvaW50cyBvbiB0aGUgY2lyY2xlLiBUaGUgc2FtZSBhcyB0aGUgcmFkaXVzICogMi4KKiBAbmFtZSBQaGFzZXIuQ2lyY2xlI2RpYW1ldGVyCiogQHByb3BlcnR5IHtudW1iZXJ9IGRpYW1ldGVyIC0gR2V0cyBvciBzZXRzIHRoZSBkaWFtZXRlciBvZiB0aGUgY2lyY2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUsICJkaWFtZXRlciIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZGlhbWV0ZXI7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID4gMCkgewogICAgICAgICAgICB0aGlzLl9kaWFtZXRlciA9IHZhbHVlOwogICAgICAgICAgICB0aGlzLl9yYWRpdXMgPSB2YWx1ZSAqIDAuNTsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBsZW5ndGggb2YgYSBsaW5lIGV4dGVuZGluZyBmcm9tIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZSB0byBhbnkgcG9pbnQgb24gdGhlIGNpcmNsZSBpdHNlbGYuIFRoZSBzYW1lIGFzIGhhbGYgdGhlIGRpYW1ldGVyLgoqIEBuYW1lIFBoYXNlci5DaXJjbGUjcmFkaXVzCiogQHByb3BlcnR5IHtudW1iZXJ9IHJhZGl1cyAtIEdldHMgb3Igc2V0cyB0aGUgcmFkaXVzIG9mIHRoZSBjaXJjbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZSwgInJhZGl1cyIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JhZGl1czsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuX3JhZGl1cyA9IHZhbHVlOwogICAgICAgICAgICB0aGlzLl9kaWFtZXRlciA9IHZhbHVlICogMjsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGxlZnRtb3N0IHBvaW50IG9mIHRoZSBjaXJjbGUuIENoYW5naW5nIHRoZSBsZWZ0IHByb3BlcnR5IG9mIGEgQ2lyY2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMuIEhvd2V2ZXIgaXQgZG9lcyBhZmZlY3QgdGhlIGRpYW1ldGVyLCB3aGVyZWFzIGNoYW5naW5nIHRoZSB4IHZhbHVlIGRvZXMgbm90IGFmZmVjdCB0aGUgZGlhbWV0ZXIgcHJvcGVydHkuCiogQG5hbWUgUGhhc2VyLkNpcmNsZSNsZWZ0CiogQHByb3BldHkge251bWJlcn0gbGVmdCAtIEdldHMgb3Igc2V0cyB0aGUgdmFsdWUgb2YgdGhlIGxlZnRtb3N0IHBvaW50IG9mIHRoZSBjaXJjbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZSwgImxlZnQiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnggLSB0aGlzLl9yYWRpdXM7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID4gdGhpcy54KSB7CiAgICAgICAgICAgIHRoaXMuX3JhZGl1cyA9IDA7CiAgICAgICAgICAgIHRoaXMuX2RpYW1ldGVyID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnJhZGl1cyA9IHRoaXMueCAtIHZhbHVlOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgcmlnaHRtb3N0IHBvaW50IG9mIHRoZSBjaXJjbGUuIENoYW5naW5nIHRoZSByaWdodCBwcm9wZXJ0eSBvZiBhIENpcmNsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCBhbmQgeSBwcm9wZXJ0aWVzLiBIb3dldmVyIGl0IGRvZXMgYWZmZWN0IHRoZSBkaWFtZXRlciwgd2hlcmVhcyBjaGFuZ2luZyB0aGUgeCB2YWx1ZSBkb2VzIG5vdCBhZmZlY3QgdGhlIGRpYW1ldGVyIHByb3BlcnR5LgoqIEBuYW1lIFBoYXNlci5DaXJjbGUjcmlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gcmlnaHQgLSBHZXRzIG9yIHNldHMgdGhlIHZhbHVlIG9mIHRoZSByaWdodG1vc3QgcG9pbnQgb2YgdGhlIGNpcmNsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DaXJjbGUucHJvdG90eXBlLCAicmlnaHQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueCArIHRoaXMuX3JhZGl1czsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPCB0aGlzLngpIHsKICAgICAgICAgICAgdGhpcy5fcmFkaXVzID0gMDsKICAgICAgICAgICAgdGhpcy5fZGlhbWV0ZXIgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMucmFkaXVzID0gdmFsdWUgLSB0aGlzLng7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgc3VtIG9mIHRoZSB5IG1pbnVzIHRoZSByYWRpdXMgcHJvcGVydHkuIENoYW5naW5nIHRoZSB0b3AgcHJvcGVydHkgb2YgYSBDaXJjbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHggYW5kIHkgcHJvcGVydGllcywgYnV0IGRvZXMgY2hhbmdlIHRoZSBkaWFtZXRlci4KKiBAbmFtZSBQaGFzZXIuQ2lyY2xlI3RvcAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3AgLSBHZXRzIG9yIHNldHMgdGhlIHRvcCBvZiB0aGUgY2lyY2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUsICJ0b3AiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueSAtIHRoaXMuX3JhZGl1czsKICAgIH0sCiAgICAKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID4gdGhpcy55KSB7CiAgICAgICAgICAgIHRoaXMuX3JhZGl1cyA9IDA7CiAgICAgICAgICAgIHRoaXMuX2RpYW1ldGVyID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnJhZGl1cyA9IHRoaXMueSAtIHZhbHVlOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIHN1bSBvZiB0aGUgeSBhbmQgcmFkaXVzIHByb3BlcnRpZXMuIENoYW5naW5nIHRoZSBib3R0b20gcHJvcGVydHkgb2YgYSBDaXJjbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHggYW5kIHkgcHJvcGVydGllcywgYnV0IGRvZXMgY2hhbmdlIHRoZSBkaWFtZXRlci4KKiBAbmFtZSBQaGFzZXIuQ2lyY2xlI2JvdHRvbQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBib3R0b20gLSBHZXRzIG9yIHNldHMgdGhlIGJvdHRvbSBvZiB0aGUgY2lyY2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUsICJib3R0b20iLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueSArIHRoaXMuX3JhZGl1czsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHZhbHVlIDwgdGhpcy55KSB7CiAgICAgICAgICAgIHRoaXMuX3JhZGl1cyA9IDA7CiAgICAgICAgICAgIHRoaXMuX2RpYW1ldGVyID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnJhZGl1cyA9IHZhbHVlIC0gdGhpcy55OwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIGFyZWEgb2YgdGhpcyBDaXJjbGUuCiogQG5hbWUgUGhhc2VyLkNpcmNsZSNhcmVhCiogQHByb3BlcnR5IHtudW1iZXJ9IGFyZWEgLSBUaGUgYXJlYSBvZiB0aGlzIGNpcmNsZS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DaXJjbGUucHJvdG90eXBlLCAiYXJlYSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAodGhpcy5fcmFkaXVzID4gMCkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5QSSAqIHRoaXMuX3JhZGl1cyAqIHRoaXMuX3JhZGl1czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIERldGVybWluZXMgd2hldGhlciBvciBub3QgdGhpcyBDaXJjbGUgb2JqZWN0IGlzIGVtcHR5LiBXaWxsIHJldHVybiBhIHZhbHVlIG9mIHRydWUgaWYgdGhlIENpcmNsZSBvYmplY3RzIGRpYW1ldGVyIGlzIGxlc3MgdGhhbiBvciBlcXVhbCB0byAwOyBvdGhlcndpc2UgZmFsc2UuCiogSWYgc2V0IHRvIHRydWUgaXQgd2lsbCByZXNldCBhbGwgb2YgdGhlIENpcmNsZSBvYmplY3RzIHByb3BlcnRpZXMgdG8gMC4gQSBDaXJjbGUgb2JqZWN0IGlzIGVtcHR5IGlmIGl0cyBkaWFtZXRlciBpcyBsZXNzIHRoYW4gb3IgZXF1YWwgdG8gMC4KKiBAbmFtZSBQaGFzZXIuQ2lyY2xlI2VtcHR5CiogQHByb3BlcnR5IHtib29sZWFufSBlbXB0eSAtIEdldHMgb3Igc2V0cyB0aGUgZW1wdHkgc3RhdGUgb2YgdGhlIGNpcmNsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DaXJjbGUucHJvdG90eXBlLCAiZW1wdHkiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLl9kaWFtZXRlciA9PT0gMCk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh2YWx1ZSA9PT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc2V0VG8oMCwgMCwgMCk7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogUmV0dXJuIHRydWUgaWYgdGhlIGdpdmVuIHgveSBjb29yZGluYXRlcyBhcmUgd2l0aGluIHRoZSBDaXJjbGUgb2JqZWN0LgoqIEBtZXRob2QgUGhhc2VyLkNpcmNsZS5jb250YWlucwoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYSAtIFRoZSBDaXJjbGUgdG8gYmUgY2hlY2tlZC4KKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBYIHZhbHVlIG9mIHRoZSBjb29yZGluYXRlIHRvIHRlc3QuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgWSB2YWx1ZSBvZiB0aGUgY29vcmRpbmF0ZSB0byB0ZXN0LgoqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGNvb3JkaW5hdGVzIGFyZSB3aXRoaW4gdGhpcyBjaXJjbGUsIG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLkNpcmNsZS5jb250YWlucyA9IGZ1bmN0aW9uIChhLCB4LCB5KSB7CgogICAgLy8gIENoZWNrIGlmIHgveSBhcmUgd2l0aGluIHRoZSBib3VuZHMgZmlyc3QKICAgIGlmICh4ID49IGEubGVmdCAmJiB4IDw9IGEucmlnaHQgJiYgeSA+PSBhLnRvcCAmJiB5IDw9IGEuYm90dG9tKSB7CgogICAgICAgIHZhciBkeCA9IChhLnggLSB4KSAqIChhLnggLSB4KTsKICAgICAgICB2YXIgZHkgPSAoYS55IC0geSkgKiAoYS55IC0geSk7CgogICAgICAgIHJldHVybiAoZHggKyBkeSkgPD0gKGEucmFkaXVzICogYS5yYWRpdXMpOwoKICAgIH0KCiAgICByZXR1cm4gZmFsc2U7Cgp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSB0d28gQ2lyY2xlIG9iamVjdHMgbWF0Y2guIFRoaXMgbWV0aG9kIGNvbXBhcmVzIHRoZSB4LCB5IGFuZCBkaWFtZXRlciBwcm9wZXJ0aWVzLgoqIEBtZXRob2QgUGhhc2VyLkNpcmNsZS5lcXVhbHMKKiBAcGFyYW0ge1BoYXNlci5DaXJjbGV9IGEgLSBUaGUgZmlyc3QgQ2lyY2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5DaXJjbGV9IGIgLSBUaGUgc2Vjb25kIENpcmNsZSBvYmplY3QuCiogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBvYmplY3QgaGFzIGV4YWN0bHkgdGhlIHNhbWUgdmFsdWVzIGZvciB0aGUgeCwgeSBhbmQgZGlhbWV0ZXIgcHJvcGVydGllcyBhcyB0aGlzIENpcmNsZSBvYmplY3Q7IG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLkNpcmNsZS5lcXVhbHMgPSBmdW5jdGlvbiAoYSwgYikgewogICAgcmV0dXJuIChhLnggPT0gYi54ICYmIGEueSA9PSBiLnkgJiYgYS5kaWFtZXRlciA9PSBiLmRpYW1ldGVyKTsKfTsKCi8qKgoqIERldGVybWluZXMgd2hldGhlciB0aGUgdHdvIENpcmNsZSBvYmplY3RzIGludGVyc2VjdC4KKiBUaGlzIG1ldGhvZCBjaGVja3MgdGhlIHJhZGl1cyBkaXN0YW5jZXMgYmV0d2VlbiB0aGUgdHdvIENpcmNsZSBvYmplY3RzIHRvIHNlZSBpZiB0aGV5IGludGVyc2VjdC4KKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUuaW50ZXJzZWN0cwoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYSAtIFRoZSBmaXJzdCBDaXJjbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYiAtIFRoZSBzZWNvbmQgQ2lyY2xlIG9iamVjdC4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIHNwZWNpZmllZCBvYmplY3QgaW50ZXJzZWN0cyB3aXRoIHRoaXMgQ2lyY2xlIG9iamVjdDsgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuQ2lyY2xlLmludGVyc2VjdHMgPSBmdW5jdGlvbiAoYSwgYikgewogICAgcmV0dXJuIChQaGFzZXIuTWF0aC5kaXN0YW5jZShhLngsIGEueSwgYi54LCBiLnkpIDw9IChhLnJhZGl1cyArIGIucmFkaXVzKSk7Cn07CgovKioKKiBSZXR1cm5zIGEgUG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGNvb3JkaW5hdGVzIG9mIGEgcG9pbnQgb24gdGhlIGNpcmN1bWZlcmVuY2Ugb2YgdGhlIENpcmNsZSBiYXNlZCBvbiB0aGUgZ2l2ZW4gYW5nbGUuCiogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlLmNpcmN1bWZlcmVuY2VQb2ludAoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYSAtIFRoZSBmaXJzdCBDaXJjbGUgb2JqZWN0LgoqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBpbiByYWRpYW5zICh1bmxlc3MgYXNEZWdyZWVzIGlzIHRydWUpIHRvIHJldHVybiB0aGUgcG9pbnQgZnJvbS4KKiBAcGFyYW0ge2Jvb2xlYW59IGFzRGVncmVlcyAtIElzIHRoZSBnaXZlbiBhbmdsZSBpbiByYWRpYW5zIChmYWxzZSkgb3IgZGVncmVlcyAodHJ1ZSk/CiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRdIC0gQW4gb3B0aW9uYWwgUG9pbnQgb2JqZWN0IHRvIHB1dCB0aGUgcmVzdWx0IGluIHRvLiBJZiBub25lIHNwZWNpZmllZCBhIG5ldyBQb2ludCBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIFBvaW50IG9iamVjdCBob2xkaW5nIHRoZSByZXN1bHQuCiovClBoYXNlci5DaXJjbGUuY2lyY3VtZmVyZW5jZVBvaW50ID0gZnVuY3Rpb24gKGEsIGFuZ2xlLCBhc0RlZ3JlZXMsIG91dCkgewoKICAgIGlmICh0eXBlb2YgYXNEZWdyZWVzID09PSAidW5kZWZpbmVkIikgeyBhc0RlZ3JlZXMgPSBmYWxzZTsgfQogICAgaWYgKHR5cGVvZiBvdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsgfQoKICAgIGlmIChhc0RlZ3JlZXMgPT09IHRydWUpIHsKICAgICAgICBhbmdsZSA9IFBoYXNlci5NYXRoLnJhZFRvRGVnKGFuZ2xlKTsKICAgIH0KCiAgICBvdXQueCA9IGEueCArIGEucmFkaXVzICogTWF0aC5jb3MoYW5nbGUpOwogICAgb3V0LnkgPSBhLnkgKyBhLnJhZGl1cyAqIE1hdGguc2luKGFuZ2xlKTsKCiAgICByZXR1cm4gb3V0OwoKfTsKCi8qKgoqIENoZWNrcyBpZiB0aGUgZ2l2ZW4gQ2lyY2xlIGFuZCBSZWN0YW5nbGUgb2JqZWN0cyBpbnRlcnNlY3QuCiogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlLmludGVyc2VjdHNSZWN0YW5nbGUKKiBAcGFyYW0ge1BoYXNlci5DaXJjbGV9IGMgLSBUaGUgQ2lyY2xlIG9iamVjdCB0byB0ZXN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gciAtIFRoZSBSZWN0YW5nbGUgb2JqZWN0IHRvIHRlc3QuCiogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgdHdvIG9iamVjdHMgaW50ZXJzZWN0LCBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5DaXJjbGUuaW50ZXJzZWN0c1JlY3RhbmdsZSA9IGZ1bmN0aW9uIChjLCByKSB7CgogICAgdmFyIGN4ID0gTWF0aC5hYnMoYy54IC0gci54IC0gci5oYWxmV2lkdGgpOwogICAgdmFyIHhEaXN0ID0gci5oYWxmV2lkdGggKyBjLnJhZGl1czsKCiAgICBpZiAoY3ggPiB4RGlzdCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICB2YXIgY3kgPSBNYXRoLmFicyhjLnkgLSByLnkgLSByLmhhbGZIZWlnaHQpOwogICAgdmFyIHlEaXN0ID0gci5oYWxmSGVpZ2h0ICsgYy5yYWRpdXM7CgogICAgaWYgKGN5ID4geURpc3QpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKGN4IDw9IHIuaGFsZldpZHRoIHx8IGN5IDw9IHIuaGFsZkhlaWdodCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHZhciB4Q29ybmVyRGlzdCA9IGN4IC0gci5oYWxmV2lkdGg7CiAgICB2YXIgeUNvcm5lckRpc3QgPSBjeSAtIHIuaGFsZkhlaWdodDsKICAgIHZhciB4Q29ybmVyRGlzdFNxID0geENvcm5lckRpc3QgKiB4Q29ybmVyRGlzdDsKICAgIHZhciB5Q29ybmVyRGlzdFNxID0geUNvcm5lckRpc3QgKiB5Q29ybmVyRGlzdDsKICAgIHZhciBtYXhDb3JuZXJEaXN0U3EgPSBjLnJhZGl1cyAqIGMucmFkaXVzOwoKICAgIHJldHVybiB4Q29ybmVyRGlzdFNxICsgeUNvcm5lckRpc3RTcSA8PSBtYXhDb3JuZXJEaXN0U3E7Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyBQb2ludC4gSWYgeW91IHBhc3Mgbm8gcGFyYW1ldGVycyBhIFBvaW50IGlzIGNyZWF0ZWQgc2V0IHRvICgwLDApLgoqIEBjbGFzcyBQaGFzZXIuUG9pbnQKKiBAY2xhc3NkZXNjIFRoZSBQb2ludCBvYmplY3QgcmVwcmVzZW50cyBhIGxvY2F0aW9uIGluIGEgdHdvLWRpbWVuc2lvbmFsIGNvb3JkaW5hdGUgc3lzdGVtLCB3aGVyZSB4IHJlcHJlc2VudHMgdGhlIGhvcml6b250YWwgYXhpcyBhbmQgeSByZXByZXNlbnRzIHRoZSB2ZXJ0aWNhbCBheGlzLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7bnVtYmVyfSB4IFRoZSBob3Jpem9udGFsIHBvc2l0aW9uIG9mIHRoaXMgUG9pbnQgKGRlZmF1bHQgMCkKKiBAcGFyYW0ge251bWJlcn0geSBUaGUgdmVydGljYWwgcG9zaXRpb24gb2YgdGhpcyBQb2ludCAoZGVmYXVsdCAwKQoqLwpQaGFzZXIuUG9pbnQgPSBmdW5jdGlvbiAoeCwgeSkgewoKICAgIHggPSB4IHx8IDA7CiAgICB5ID0geSB8fCAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHBvaW50LgogICAgKi8KICAgIHRoaXMueCA9IHg7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHBvaW50LgogICAgKi8KICAgIHRoaXMueSA9IHk7Cgp9OwoKUGhhc2VyLlBvaW50LnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQ29waWVzIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMgZnJvbSBhbnkgZ2l2ZW4gb2JqZWN0IHRvIHRoaXMgUG9pbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2NvcHlGcm9tCiAgICAqIEBwYXJhbSB7YW55fSBzb3VyY2UgLSBUaGUgb2JqZWN0IHRvIGNvcHkgZnJvbS4KICAgICogQHJldHVybiB7UG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LgogICAgKi8KICAgIGNvcHlGcm9tOiBmdW5jdGlvbiAoc291cmNlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0VG8oc291cmNlLngsIHNvdXJjZS55KTsKICAgIH0sCgogICAgLyoqCiAgICAqIEludmVydHMgdGhlIHggYW5kIHkgdmFsdWVzIG9mIHRoaXMgUG9pbnQKICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjaW52ZXJ0CiAgICAqIEByZXR1cm4ge1BvaW50fSBUaGlzIFBvaW50IG9iamVjdC4KICAgICovCiAgICBpbnZlcnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRUbyh0aGlzLnksIHRoaXMueCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSB4IGFuZCB5IHZhbHVlcyBvZiB0aGlzIFBvaW50IG9iamVjdCB0byB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I3NldFRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIGhvcml6b250YWwgcG9zaXRpb24gb2YgdGhpcyBwb2ludC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgdmVydGljYWwgcG9zaXRpb24gb2YgdGhpcyBwb2ludC4KICAgICogQHJldHVybiB7UG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LiBVc2VmdWwgZm9yIGNoYWluaW5nIG1ldGhvZCBjYWxscy4KICAgICovCiAgICBzZXRUbzogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgdGhpcy54ID0geDsKICAgICAgICB0aGlzLnkgPSB5OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogQWRkcyB0aGUgZ2l2ZW4geCBhbmQgeSB2YWx1ZXMgdG8gdGhpcyBQb2ludC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjYWRkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHZhbHVlIHRvIGFkZCB0byBQb2ludC54LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSB0byBhZGQgdG8gUG9pbnQueS4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGlzIFBvaW50IG9iamVjdC4gVXNlZnVsIGZvciBjaGFpbmluZyBtZXRob2QgY2FsbHMuCiAgICAqLwogICAgYWRkOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnggKz0geDsKICAgICAgICB0aGlzLnkgKz0geTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdWJ0cmFjdHMgdGhlIGdpdmVuIHggYW5kIHkgdmFsdWVzIGZyb20gdGhpcyBQb2ludC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjc3VidHJhY3QKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgdG8gc3VidHJhY3QgZnJvbSBQb2ludC54LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSB0byBzdWJ0cmFjdCBmcm9tIFBvaW50LnkuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhpcyBQb2ludCBvYmplY3QuIFVzZWZ1bCBmb3IgY2hhaW5pbmcgbWV0aG9kIGNhbGxzLgogICAgKi8KICAgIHN1YnRyYWN0OiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnggLT0geDsKICAgICAgICB0aGlzLnkgLT0geTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNdWx0aXBsaWVzIFBvaW50LnggYW5kIFBvaW50LnkgYnkgdGhlIGdpdmVuIHggYW5kIHkgdmFsdWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNtdWx0aXBseQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB2YWx1ZSB0byBtdWx0aXBseSBQb2ludC54IGJ5LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSB0byBtdWx0aXBseSBQb2ludC54IGJ5LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LiBVc2VmdWwgZm9yIGNoYWluaW5nIG1ldGhvZCBjYWxscy4KICAgICovCiAgICBtdWx0aXBseTogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgdGhpcy54ICo9IHg7CiAgICAgICAgdGhpcy55ICo9IHk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogRGl2aWRlcyBQb2ludC54IGFuZCBQb2ludC55IGJ5IHRoZSBnaXZlbiB4IGFuZCB5IHZhbHVlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjZGl2aWRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHZhbHVlIHRvIGRpdmlkZSBQb2ludC54IGJ5LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSB0byBkaXZpZGUgUG9pbnQueCBieS4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGlzIFBvaW50IG9iamVjdC4gVXNlZnVsIGZvciBjaGFpbmluZyBtZXRob2QgY2FsbHMuCiAgICAqLwogICAgZGl2aWRlOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnggLz0geDsKICAgICAgICB0aGlzLnkgLz0geTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGFtcHMgdGhlIHggdmFsdWUgb2YgdGhpcyBQb2ludCB0byBiZSBiZXR3ZWVuIHRoZSBnaXZlbiBtaW4gYW5kIG1heC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjY2xhbXBYCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSB0byBjbGFtcCB0aGlzIFBvaW50IHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gdmFsdWUgdG8gY2xhbXAgdGhpcyBQb2ludCB0by4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGlzIFBvaW50IG9iamVjdC4KICAgICovCiAgICBjbGFtcFg6IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKICAgICAgICB0aGlzLnggPSBQaGFzZXIuTWF0aC5jbGFtcCh0aGlzLngsIG1pbiwgbWF4KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIENsYW1wcyB0aGUgeSB2YWx1ZSBvZiB0aGlzIFBvaW50IHRvIGJlIGJldHdlZW4gdGhlIGdpdmVuIG1pbiBhbmQgbWF4CiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2NsYW1wWQogICAgKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gdmFsdWUgdG8gY2xhbXAgdGhpcyBQb2ludCB0by4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIHRvIGNsYW1wIHRoaXMgUG9pbnQgdG8uCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhpcyBQb2ludCBvYmplY3QuCiAgICAqLwogICAgY2xhbXBZOiBmdW5jdGlvbiAobWluLCBtYXgpIHsKCiAgICAgICAgdGhpcy55ID0gUGhhc2VyLk1hdGguY2xhbXAodGhpcy55LCBtaW4sIG1heCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGFtcHMgdGhpcyBQb2ludCBvYmplY3QgdmFsdWVzIHRvIGJlIGJldHdlZW4gdGhlIGdpdmVuIG1pbiBhbmQgbWF4LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNjbGFtcAogICAgKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gdmFsdWUgdG8gY2xhbXAgdGhpcyBQb2ludCB0by4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIHRvIGNsYW1wIHRoaXMgUG9pbnQgdG8uCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhpcyBQb2ludCBvYmplY3QuCiAgICAqLwogICAgY2xhbXA6IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKICAgICAgICB0aGlzLnggPSBQaGFzZXIuTWF0aC5jbGFtcCh0aGlzLngsIG1pbiwgbWF4KTsKICAgICAgICB0aGlzLnkgPSBQaGFzZXIuTWF0aC5jbGFtcCh0aGlzLnksIG1pbiwgbWF4KTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgY29weSBvZiB0aGUgZ2l2ZW4gUG9pbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2Nsb25lCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbb3V0cHV0XSBPcHRpb25hbCBQb2ludCBvYmplY3QuIElmIGdpdmVuIHRoZSB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGlzIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBuZXcgUG9pbnQgb2JqZWN0LgogICAgKi8KICAgIGNsb25lOiBmdW5jdGlvbiAob3V0cHV0KSB7CgogICAgICAgIGlmICh0eXBlb2Ygb3V0cHV0ID09PSAidW5kZWZpbmVkIikgeyBvdXRwdXQgPSBuZXcgUGhhc2VyLlBvaW50KCk7IH0KCiAgICAgICAgcmV0dXJuIG91dHB1dC5zZXRUbyh0aGlzLngsIHRoaXMueSk7CgogICAgfSwKCiAgICAvKioKICAgICogQ29waWVzIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMgZnJvbSB0aGlzIFBvaW50IHRvIGFueSBnaXZlbiBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2NvcHlUbwogICAgKiBAcGFyYW0ge2FueX0gZGVzdCAtIFRoZSBvYmplY3QgdG8gY29weSB0by4KICAgICogQHJldHVybiB7T2JqZWN0fSBUaGUgZGVzdCBvYmplY3QuCiAgICAqLwogICAgY29weVRvOiBmdW5jdGlvbihkZXN0KSB7CgogICAgICAgIGRlc3QueCA9IHRoaXMueDsKICAgICAgICBkZXN0LnkgPSB0aGlzLnk7CgogICAgICAgIHJldHVybiBkZXN0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIGRpc3RhbmNlIG9mIHRoaXMgUG9pbnQgb2JqZWN0IHRvIHRoZSBnaXZlbiBvYmplY3QgKGNhbiBiZSBhIENpcmNsZSwgUG9pbnQgb3IgYW55dGhpbmcgd2l0aCB4L3kgcHJvcGVydGllcykKICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjZGlzdGFuY2UKICAgICogQHBhcmFtIHtvYmplY3R9IGRlc3QgLSBUaGUgdGFyZ2V0IG9iamVjdC4gTXVzdCBoYXZlIHZpc2libGUgeCBhbmQgeSBwcm9wZXJ0aWVzIHRoYXQgcmVwcmVzZW50IHRoZSBjZW50ZXIgb2YgdGhlIG9iamVjdC4KICAgICogQHBhcmFtIHtib29sZWFufSBbcm91bmRdIC0gUm91bmQgdGhlIGRpc3RhbmNlIHRvIHRoZSBuZWFyZXN0IGludGVnZXIgKGRlZmF1bHQgZmFsc2UpLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoaXMgUG9pbnQgb2JqZWN0IGFuZCB0aGUgZGVzdGluYXRpb24gUG9pbnQgb2JqZWN0LgogICAgKi8KICAgIGRpc3RhbmNlOiBmdW5jdGlvbiAoZGVzdCwgcm91bmQpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlBvaW50LmRpc3RhbmNlKHRoaXMsIGRlc3QsIHJvdW5kKTsKICAgIH0sCgogICAgLyoqCiAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgZ2l2ZW4gb2JqZWN0cyB4L3kgdmFsdWVzIGFyZSBlcXVhbCB0byB0aGlzIFBvaW50IG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjZXF1YWxzCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBhIC0gVGhlIGZpcnN0IG9iamVjdCB0byBjb21wYXJlLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIFBvaW50cyBhcmUgZXF1YWwsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBlcXVhbHM6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgcmV0dXJuIChhLnggPT0gdGhpcy54ICYmIGEueSA9PSB0aGlzLnkpOwogICAgfSwKCiAgICAvKioKICAgICogUm90YXRlcyB0aGlzIFBvaW50IGFyb3VuZCB0aGUgeC95IGNvb3JkaW5hdGVzIGdpdmVuIHRvIHRoZSBkZXNpcmVkIGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNyb3RhdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBhbmNob3IgcG9pbnQKICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBhbmNob3IgcG9pbnQKICAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMgKHVubGVzcyBhc0RlZ3JlZXMgaXMgdHJ1ZSkgdG8gcm90YXRlIHRoZSBQb2ludCB0by4KICAgICogQHBhcmFtIHtib29sZWFufSBhc0RlZ3JlZXMgLSBJcyB0aGUgZ2l2ZW4gcm90YXRpb24gaW4gcmFkaWFucyAoZmFsc2UpIG9yIGRlZ3JlZXMgKHRydWUpPwogICAgKiBAcGFyYW0ge251bWJlcn0gW2Rpc3RhbmNlXSAtIEFuIG9wdGlvbmFsIGRpc3RhbmNlIGNvbnN0cmFpbnQgYmV0d2VlbiB0aGUgUG9pbnQgYW5kIHRoZSBhbmNob3IuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIG1vZGlmaWVkIHBvaW50IG9iamVjdC4KICAgICovCiAgICByb3RhdGU6IGZ1bmN0aW9uICh4LCB5LCBhbmdsZSwgYXNEZWdyZWVzLCBkaXN0YW5jZSkgewogICAgICAgIHJldHVybiBQaGFzZXIuUG9pbnQucm90YXRlKHRoaXMsIHgsIHksIGFuZ2xlLCBhc0RlZ3JlZXMsIGRpc3RhbmNlKTsKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGN1bGF0ZXMgdGhlIGxlbmd0aCBvZiB0aGUgdmVjdG9yCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2dldE1hZ25pdHVkZQogICAgKiBAcmV0dXJuIHtudW1iZXJ9IHRoZSBsZW5ndGggb2YgdGhlIHZlY3RvcgogICAgKi8KICAgIGdldE1hZ25pdHVkZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIE1hdGguc3FydCgodGhpcy54ICogdGhpcy54KSArICh0aGlzLnkgKiB0aGlzLnkpKTsKICAgIH0sCgogICAgLyoqCiAgICAqIEFsdGVycyB0aGUgbGVuZ3RoIG9mIHRoZSB2ZWN0b3Igd2l0aG91dCBjaGFuZ2luZyB0aGUgZGlyZWN0aW9uCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2dldE1hZ25pdHVkZQogICAgKiBAcGFyYW0ge251bWJlcn0gbWFnbml0dWRlIHRoZSBkZXNpcmVkIG1hZ25pdHVkZSBvZiB0aGUgcmVzdWx0aW5nIHZlY3RvcgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IHRoZSBtb2RpZmllZCBvcmlnaW5hbCB2ZWN0b3IKICAgICovCiAgICBzZXRNYWduaXR1ZGU6IGZ1bmN0aW9uKG1hZ25pdHVkZSkgewogICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZSgpLm11bHRpcGx5KG1hZ25pdHVkZSwgbWFnbml0dWRlKTsKICAgIH0sCgogICAgLyoqCiAgICAqIEFsdGVycyB0aGUgdmVjdG9yIHNvIHRoYXQgaXRzIGxlbmd0aCBpcyAxLCBidXQgaXQgcmV0YWlucyB0aGUgc2FtZSBkaXJlY3Rpb24KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjbm9ybWFsaXplCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gdGhlIG1vZGlmaWVkIG9yaWdpbmFsIHZlY3RvcgogICAgKi8KICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIGlmKCF0aGlzLmlzWmVybygpKSB7CiAgICAgICAgICAgIHZhciBtID0gdGhpcy5nZXRNYWduaXR1ZGUoKTsKICAgICAgICAgICAgdGhpcy54IC89IG07CiAgICAgICAgICAgIHRoaXMueSAvPSBtOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogRGV0ZXJtaW5lIGlmIHRoaXMgcG9pbnQgaXMgYXQgMCwwCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2lzWmVybwogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoaXMgUG9pbnQgaXMgMCwwLCBvdGhlcndpc2UgZmFsc2UKICAgICovCiAgICBpc1plcm86IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAodGhpcy54ID09PSAwICYmIHRoaXMueSA9PT0gMCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCN0b1N0cmluZwogICAgKiBAcmV0dXJuIHtzdHJpbmd9IEEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBpbnN0YW5jZS4KICAgICovCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAnW3tQb2ludCAoeD0nICsgdGhpcy54ICsgJyB5PScgKyB0aGlzLnkgKyAnKX1dJzsKICAgIH0KCn07CgpQaGFzZXIuUG9pbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlBvaW50OwoKLyoqCiogQWRkcyB0aGUgY29vcmRpbmF0ZXMgb2YgdHdvIHBvaW50cyB0b2dldGhlciB0byBjcmVhdGUgYSBuZXcgcG9pbnQuCiogQG1ldGhvZCBQaGFzZXIuUG9pbnQuYWRkCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGEgLSBUaGUgZmlyc3QgUG9pbnQgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBiIC0gVGhlIHNlY29uZCBQb2ludCBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRdIC0gT3B0aW9uYWwgUG9pbnQgdG8gc3RvcmUgdGhlIHZhbHVlIGluLCBpZiBub3Qgc3VwcGxpZWQgYSBuZXcgUG9pbnQgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZC4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBuZXcgUG9pbnQgb2JqZWN0LgoqLwpQaGFzZXIuUG9pbnQuYWRkID0gZnVuY3Rpb24gKGEsIGIsIG91dCkgewoKICAgIGlmICh0eXBlb2Ygb3V0ID09PSAidW5kZWZpbmVkIikgeyBvdXQgPSBuZXcgUGhhc2VyLlBvaW50KCk7IH0KCiAgICBvdXQueCA9IGEueCArIGIueDsKICAgIG91dC55ID0gYS55ICsgYi55OwoKICAgIHJldHVybiBvdXQ7Cgp9OwoKLyoqCiogU3VidHJhY3RzIHRoZSBjb29yZGluYXRlcyBvZiB0d28gcG9pbnRzIHRvIGNyZWF0ZSBhIG5ldyBwb2ludC4KKiBAbWV0aG9kIFBoYXNlci5Qb2ludC5zdWJ0cmFjdAoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBhIC0gVGhlIGZpcnN0IFBvaW50IG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYiAtIFRoZSBzZWNvbmQgUG9pbnQgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbb3V0XSAtIE9wdGlvbmFsIFBvaW50IHRvIHN0b3JlIHRoZSB2YWx1ZSBpbiwgaWYgbm90IHN1cHBsaWVkIGEgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgbmV3IFBvaW50IG9iamVjdC4KKi8KUGhhc2VyLlBvaW50LnN1YnRyYWN0ID0gZnVuY3Rpb24gKGEsIGIsIG91dCkgewoKICAgIGlmICh0eXBlb2Ygb3V0ID09PSAidW5kZWZpbmVkIikgeyBvdXQgPSBuZXcgUGhhc2VyLlBvaW50KCk7IH0KCiAgICBvdXQueCA9IGEueCAtIGIueDsKICAgIG91dC55ID0gYS55IC0gYi55OwoKICAgIHJldHVybiBvdXQ7Cgp9OwoKLyoqCiogTXVsdGlwbGllcyB0aGUgY29vcmRpbmF0ZXMgb2YgdHdvIHBvaW50cyB0byBjcmVhdGUgYSBuZXcgcG9pbnQuCiogQG1ldGhvZCBQaGFzZXIuUG9pbnQubXVsdGlwbHkKKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYSAtIFRoZSBmaXJzdCBQb2ludCBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGIgLSBUaGUgc2Vjb25kIFBvaW50IG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW291dF0gLSBPcHRpb25hbCBQb2ludCB0byBzdG9yZSB0aGUgdmFsdWUgaW4sIGlmIG5vdCBzdXBwbGllZCBhIG5ldyBQb2ludCBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIG5ldyBQb2ludCBvYmplY3QuCiovClBoYXNlci5Qb2ludC5tdWx0aXBseSA9IGZ1bmN0aW9uIChhLCBiLCBvdXQpIHsKCiAgICBpZiAodHlwZW9mIG91dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0ID0gbmV3IFBoYXNlci5Qb2ludCgpOyB9CgogICAgb3V0LnggPSBhLnggKiBiLng7CiAgICBvdXQueSA9IGEueSAqIGIueTsKCiAgICByZXR1cm4gb3V0OwoKfTsKCi8qKgoqIERpdmlkZXMgdGhlIGNvb3JkaW5hdGVzIG9mIHR3byBwb2ludHMgdG8gY3JlYXRlIGEgbmV3IHBvaW50LgoqIEBtZXRob2QgUGhhc2VyLlBvaW50LmRpdmlkZQoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBhIC0gVGhlIGZpcnN0IFBvaW50IG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYiAtIFRoZSBzZWNvbmQgUG9pbnQgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbb3V0XSAtIE9wdGlvbmFsIFBvaW50IHRvIHN0b3JlIHRoZSB2YWx1ZSBpbiwgaWYgbm90IHN1cHBsaWVkIGEgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgbmV3IFBvaW50IG9iamVjdC4KKi8KUGhhc2VyLlBvaW50LmRpdmlkZSA9IGZ1bmN0aW9uIChhLCBiLCBvdXQpIHsKCiAgICBpZiAodHlwZW9mIG91dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0ID0gbmV3IFBoYXNlci5Qb2ludCgpOyB9CgogICAgb3V0LnggPSBhLnggLyBiLng7CiAgICBvdXQueSA9IGEueSAvIGIueTsKCiAgICByZXR1cm4gb3V0OwoKfTsKCi8qKgoqIERldGVybWluZXMgd2hldGhlciB0aGUgdHdvIGdpdmVuIFBvaW50IG9iamVjdHMgYXJlIGVxdWFsLiBUaGV5IGFyZSBjb25zaWRlcmVkIGVxdWFsIGlmIHRoZXkgaGF2ZSB0aGUgc2FtZSB4IGFuZCB5IHZhbHVlcy4KKiBAbWV0aG9kIFBoYXNlci5Qb2ludC5lcXVhbHMKKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYSAtIFRoZSBmaXJzdCBQb2ludCBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGIgLSBUaGUgc2Vjb25kIFBvaW50IG9iamVjdC4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIFBvaW50cyBhcmUgZXF1YWwsIG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLlBvaW50LmVxdWFscyA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICByZXR1cm4gKGEueCA9PSBiLnggJiYgYS55ID09IGIueSk7Cn07CgovKioKKiBSZXR1cm5zIHRoZSBkaXN0YW5jZSBvZiB0aGlzIFBvaW50IG9iamVjdCB0byB0aGUgZ2l2ZW4gb2JqZWN0IChjYW4gYmUgYSBDaXJjbGUsIFBvaW50IG9yIGFueXRoaW5nIHdpdGggeC95IHByb3BlcnRpZXMpLgoqIEBtZXRob2QgUGhhc2VyLlBvaW50LmRpc3RhbmNlCiogQHBhcmFtIHtvYmplY3R9IGEgLSBUaGUgdGFyZ2V0IG9iamVjdC4gTXVzdCBoYXZlIHZpc2libGUgeCBhbmQgeSBwcm9wZXJ0aWVzIHRoYXQgcmVwcmVzZW50IHRoZSBjZW50ZXIgb2YgdGhlIG9iamVjdC4KKiBAcGFyYW0ge29iamVjdH0gYiAtIFRoZSB0YXJnZXQgb2JqZWN0LiBNdXN0IGhhdmUgdmlzaWJsZSB4IGFuZCB5IHByb3BlcnRpZXMgdGhhdCByZXByZXNlbnQgdGhlIGNlbnRlciBvZiB0aGUgb2JqZWN0LgoqIEBwYXJhbSB7Ym9vbGVhbn0gW3JvdW5kXSAtIFJvdW5kIHRoZSBkaXN0YW5jZSB0byB0aGUgbmVhcmVzdCBpbnRlZ2VyIChkZWZhdWx0IGZhbHNlKS4KKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoaXMgUG9pbnQgb2JqZWN0IGFuZCB0aGUgZGVzdGluYXRpb24gUG9pbnQgb2JqZWN0LgoqLwpQaGFzZXIuUG9pbnQuZGlzdGFuY2UgPSBmdW5jdGlvbiAoYSwgYiwgcm91bmQpIHsKCiAgICBpZiAodHlwZW9mIHJvdW5kID09PSAidW5kZWZpbmVkIikgeyByb3VuZCA9IGZhbHNlIH0KCiAgICBpZiAocm91bmQpCiAgICB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLmRpc3RhbmNlUm91bmQoYS54LCBhLnksIGIueCwgYi55KTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGguZGlzdGFuY2UoYS54LCBhLnksIGIueCwgYi55KTsKICAgIH0KCn07CgovKioKKiBSb3RhdGVzIGEgUG9pbnQgYXJvdW5kIHRoZSB4L3kgY29vcmRpbmF0ZXMgZ2l2ZW4gdG8gdGhlIGRlc2lyZWQgYW5nbGUuCiogQG1ldGhvZCBQaGFzZXIuUG9pbnQucm90YXRlCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGEgLSBUaGUgUG9pbnQgb2JqZWN0IHRvIHJvdGF0ZS4KKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGFuY2hvciBwb2ludAoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgYW5jaG9yIHBvaW50CiogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMgKHVubGVzcyBhc0RlZ3JlZXMgaXMgdHJ1ZSkgdG8gcm90YXRlIHRoZSBQb2ludCB0by4KKiBAcGFyYW0ge2Jvb2xlYW59IGFzRGVncmVlcyAtIElzIHRoZSBnaXZlbiByb3RhdGlvbiBpbiByYWRpYW5zIChmYWxzZSkgb3IgZGVncmVlcyAodHJ1ZSk/CiogQHBhcmFtIHtudW1iZXJ9IGRpc3RhbmNlIC0gQW4gb3B0aW9uYWwgZGlzdGFuY2UgY29uc3RyYWludCBiZXR3ZWVuIHRoZSBQb2ludCBhbmQgdGhlIGFuY2hvci4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBtb2RpZmllZCBwb2ludCBvYmplY3QuCiovClBoYXNlci5Qb2ludC5yb3RhdGUgPSBmdW5jdGlvbiAoYSwgeCwgeSwgYW5nbGUsIGFzRGVncmVlcywgZGlzdGFuY2UpIHsKCiAgICBhc0RlZ3JlZXMgPSBhc0RlZ3JlZXMgfHwgZmFsc2U7CiAgICBkaXN0YW5jZSA9IGRpc3RhbmNlIHx8IG51bGw7CgogICAgaWYgKGFzRGVncmVlcykKICAgIHsKICAgICAgICBhbmdsZSA9IFBoYXNlci5NYXRoLmRlZ1RvUmFkKGFuZ2xlKTsKICAgIH0KCiAgICAvLyAgR2V0IGRpc3RhbmNlIGZyb20gb3JpZ2luIChjeC9jeSkgdG8gdGhpcyBwb2ludAogICAgaWYgKGRpc3RhbmNlID09PSBudWxsKQogICAgewogICAgICAgIGRpc3RhbmNlID0gTWF0aC5zcXJ0KCgoeCAtIGEueCkgKiAoeCAtIGEueCkpICsgKCh5IC0gYS55KSAqICh5IC0gYS55KSkpOwogICAgfQoKICAgIHJldHVybiBhLnNldFRvKHggKyBkaXN0YW5jZSAqIE1hdGguY29zKGFuZ2xlKSwgeSArIGRpc3RhbmNlICogTWF0aC5zaW4oYW5nbGUpKTsKCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGVzIGEgbmV3IFJlY3RhbmdsZSBvYmplY3Qgd2l0aCB0aGUgdG9wLWxlZnQgY29ybmVyIHNwZWNpZmllZCBieSB0aGUgeCBhbmQgeSBwYXJhbWV0ZXJzIGFuZCB3aXRoIHRoZSBzcGVjaWZpZWQgd2lkdGggYW5kIGhlaWdodCBwYXJhbWV0ZXJzLiBJZiB5b3UgY2FsbCB0aGlzIGZ1bmN0aW9uIHdpdGhvdXQgcGFyYW1ldGVycywgYSBSZWN0YW5nbGUgd2l0aCB4LCB5LCB3aWR0aCwgYW5kIGhlaWdodCBwcm9wZXJ0aWVzIHNldCB0byAwIGlzIGNyZWF0ZWQuCioKKiBAY2xhc3MgUGhhc2VyLlJlY3RhbmdsZQoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgdG9wLWxlZnQgY29ybmVyIG9mIHRoZSBSZWN0YW5nbGUuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSB0b3AtbGVmdCBjb3JuZXIgb2YgdGhlIFJlY3RhbmdsZS4KKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIFJlY3RhbmdsZS4KKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgUmVjdGFuZ2xlLgoqIEByZXR1cm4ge1JlY3RhbmdsZX0gVGhpcyBSZWN0YW5nbGUgb2JqZWN0LgoqLwpQaGFzZXIuUmVjdGFuZ2xlID0gZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCiAgICB4ID0geCB8fCAwOwogICAgeSA9IHkgfHwgMDsKICAgIHdpZHRoID0gd2lkdGggfHwgMDsKICAgIGhlaWdodCA9IGhlaWdodCB8fCAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgUmVjdGFuZ2xlLgogICAgKi8KICAgIHRoaXMueCA9IHg7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgUmVjdGFuZ2xlLgogICAgKi8KICAgIHRoaXMueSA9IHk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIFJlY3RhbmdsZS4KICAgICovCiAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgUmVjdGFuZ2xlLgogICAgKi8KICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKfTsKClBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBBZGp1c3RzIHRoZSBsb2NhdGlvbiBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCwgYXMgZGV0ZXJtaW5lZCBieSBpdHMgdG9wLWxlZnQgY29ybmVyLCBieSB0aGUgc3BlY2lmaWVkIGFtb3VudHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNvZmZzZXQKICAgICogQHBhcmFtIHtudW1iZXJ9IGR4IC0gTW92ZXMgdGhlIHggdmFsdWUgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QgYnkgdGhpcyBhbW91bnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkeSAtIE1vdmVzIHRoZSB5IHZhbHVlIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0IGJ5IHRoaXMgYW1vdW50LgogICAgKiBAcmV0dXJuIHtSZWN0YW5nbGV9IFRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KICAgICovCiAgICBvZmZzZXQ6IGZ1bmN0aW9uIChkeCwgZHkpIHsKCiAgICAgICAgdGhpcy54ICs9IGR4OwogICAgICAgIHRoaXMueSArPSBkeTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKIAogICAgLyoqCiAgICAqIEFkanVzdHMgdGhlIGxvY2F0aW9uIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0IHVzaW5nIGEgUG9pbnQgb2JqZWN0IGFzIGEgcGFyYW1ldGVyLiBUaGlzIG1ldGhvZCBpcyBzaW1pbGFyIHRvIHRoZSBSZWN0YW5nbGUub2Zmc2V0KCkgbWV0aG9kLCBleGNlcHQgdGhhdCBpdCB0YWtlcyBhIFBvaW50IG9iamVjdCBhcyBhIHBhcmFtZXRlci4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI29mZnNldFBvaW50CiAgICAqIEBwYXJhbSB7UG9pbnR9IHBvaW50IC0gQSBQb2ludCBvYmplY3QgdG8gdXNlIHRvIG9mZnNldCB0aGlzIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEByZXR1cm4ge1JlY3RhbmdsZX0gVGhpcyBSZWN0YW5nbGUgb2JqZWN0LgogICAgKi8KICAgIG9mZnNldFBvaW50OiBmdW5jdGlvbiAocG9pbnQpIHsKICAgICAgICByZXR1cm4gdGhpcy5vZmZzZXQocG9pbnQueCwgcG9pbnQueSk7CiAgICB9LAogCiAgICAvKioKICAgICogU2V0cyB0aGUgbWVtYmVycyBvZiBSZWN0YW5nbGUgdG8gdGhlIHNwZWNpZmllZCB2YWx1ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNzZXRUbwogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgUmVjdGFuZ2xlLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgUmVjdGFuZ2xlLgogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIFJlY3RhbmdsZSBpbiBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBSZWN0YW5nbGUgaW4gcGl4ZWxzLgogICAgKiBAcmV0dXJuIHtSZWN0YW5nbGV9IFRoaXMgUmVjdGFuZ2xlIG9iamVjdAogICAgKi8KICAgIHNldFRvOiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKICAgICAgICB0aGlzLnggPSB4OwogICAgICAgIHRoaXMueSA9IHk7CiAgICAgICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAogCiAgICAvKioKICAgICogUnVucyBNYXRoLmZsb29yKCkgb24gYm90aCB0aGUgeCBhbmQgeSB2YWx1ZXMgb2YgdGhpcyBSZWN0YW5nbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNmbG9vcgogICAgKi8KICAgIGZsb29yOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMueCA9IE1hdGguZmxvb3IodGhpcy54KTsKICAgICAgICB0aGlzLnkgPSBNYXRoLmZsb29yKHRoaXMueSk7CgogICAgfSwKIAogICAgLyoqCiAgICAqIFJ1bnMgTWF0aC5mbG9vcigpIG9uIHRoZSB4LCB5LCB3aWR0aCBhbmQgaGVpZ2h0IHZhbHVlcyBvZiB0aGlzIFJlY3RhbmdsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2Zsb29yQWxsCiAgICAqLwogICAgZmxvb3JBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy54ID0gTWF0aC5mbG9vcih0aGlzLngpOwogICAgICAgIHRoaXMueSA9IE1hdGguZmxvb3IodGhpcy55KTsKICAgICAgICB0aGlzLndpZHRoID0gTWF0aC5mbG9vcih0aGlzLndpZHRoKTsKICAgICAgICB0aGlzLmhlaWdodCA9IE1hdGguZmxvb3IodGhpcy5oZWlnaHQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENvcGllcyB0aGUgeCwgeSwgd2lkdGggYW5kIGhlaWdodCBwcm9wZXJ0aWVzIGZyb20gYW55IGdpdmVuIG9iamVjdCB0byB0aGlzIFJlY3RhbmdsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2NvcHlGcm9tCiAgICAqIEBwYXJhbSB7YW55fSBzb3VyY2UgLSBUaGUgb2JqZWN0IHRvIGNvcHkgZnJvbS4KICAgICogQHJldHVybiB7UmVjdGFuZ2xlfSBUaGlzIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqLwogICAgY29weUZyb206IGZ1bmN0aW9uIChzb3VyY2UpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRUbyhzb3VyY2UueCwgc291cmNlLnksIHNvdXJjZS53aWR0aCwgc291cmNlLmhlaWdodCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBDb3BpZXMgdGhlIHgsIHksIHdpZHRoIGFuZCBoZWlnaHQgcHJvcGVydGllcyBmcm9tIHRoaXMgUmVjdGFuZ2xlIHRvIGFueSBnaXZlbiBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNjb3B5VG8KICAgICogQHBhcmFtIHthbnl9IHNvdXJjZSAtIFRoZSBvYmplY3QgdG8gY29weSB0by4KICAgICogQHJldHVybiB7b2JqZWN0fSBUaGlzIG9iamVjdC4KICAgICovCiAgICBjb3B5VG86IGZ1bmN0aW9uIChkZXN0KSB7CgogICAgICAgIGRlc3QueCA9IHRoaXMueDsKICAgICAgICBkZXN0LnkgPSB0aGlzLnk7CiAgICAgICAgZGVzdC53aWR0aCA9IHRoaXMud2lkdGg7CiAgICAgICAgZGVzdC5oZWlnaHQgPSB0aGlzLmhlaWdodDsKCiAgICAgICAgcmV0dXJuIGRlc3Q7CgogICAgfSwKCiAgICAvKioKICAgICogSW5jcmVhc2VzIHRoZSBzaXplIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0IGJ5IHRoZSBzcGVjaWZpZWQgYW1vdW50cy4gVGhlIGNlbnRlciBwb2ludCBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBzdGF5cyB0aGUgc2FtZSwgYW5kIGl0cyBzaXplIGluY3JlYXNlcyB0byB0aGUgbGVmdCBhbmQgcmlnaHQgYnkgdGhlIGR4IHZhbHVlLCBhbmQgdG8gdGhlIHRvcCBhbmQgdGhlIGJvdHRvbSBieSB0aGUgZHkgdmFsdWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNpbmZsYXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkeCAtIFRoZSBhbW91bnQgdG8gYmUgYWRkZWQgdG8gdGhlIGxlZnQgc2lkZSBvZiB0aGUgUmVjdGFuZ2xlLgogICAgKiBAcGFyYW0ge251bWJlcn0gZHkgLSBUaGUgYW1vdW50IHRvIGJlIGFkZGVkIHRvIHRoZSBib3R0b20gc2lkZSBvZiB0aGUgUmVjdGFuZ2xlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfSBUaGlzIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqLwogICAgaW5mbGF0ZTogZnVuY3Rpb24gKGR4LCBkeSkgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmluZmxhdGUodGhpcywgZHgsIGR5KTsKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBzaXplIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0LCBleHByZXNzZWQgYXMgYSBQb2ludCBvYmplY3Qgd2l0aCB0aGUgdmFsdWVzIG9mIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNzaXplCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbb3V0cHV0XSAtIE9wdGlvbmFsIFBvaW50IG9iamVjdC4gSWYgZ2l2ZW4gdGhlIHZhbHVlcyB3aWxsIGJlIHNldCBpbnRvIHRoZSBvYmplY3QsIG90aGVyd2lzZSBhIGJyYW5kIG5ldyBQb2ludCBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkIGFuZCByZXR1cm5lZC4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgc2l6ZSBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdC4KICAgICovCiAgICBzaXplOiBmdW5jdGlvbiAob3V0cHV0KSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuc2l6ZSh0aGlzLCBvdXRwdXQpOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIG5ldyBSZWN0YW5nbGUgb2JqZWN0IHdpdGggdGhlIHNhbWUgdmFsdWVzIGZvciB0aGUgeCwgeSwgd2lkdGgsIGFuZCBoZWlnaHQgcHJvcGVydGllcyBhcyB0aGUgb3JpZ2luYWwgUmVjdGFuZ2xlIG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2Nsb25lCiAgICAqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gW291dHB1dF0gLSBPcHRpb25hbCBSZWN0YW5nbGUgb2JqZWN0LiBJZiBnaXZlbiB0aGUgdmFsdWVzIHdpbGwgYmUgc2V0IGludG8gdGhlIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFJlY3RhbmdsZSBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkIGFuZCByZXR1cm5lZC4KICAgICogQHJldHVybiB7UGhhc2VyLlJlY3RhbmdsZX0gCiAgICAqLwogICAgY2xvbmU6IGZ1bmN0aW9uIChvdXRwdXQpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5jbG9uZSh0aGlzLCBvdXRwdXQpOwogICAgfSwKCiAgICAvKioKICAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBzcGVjaWZpZWQgY29vcmRpbmF0ZXMgYXJlIGNvbnRhaW5lZCB3aXRoaW4gdGhlIHJlZ2lvbiBkZWZpbmVkIGJ5IHRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2NvbnRhaW5zCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgcG9pbnQgdG8gdGVzdC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBwb2ludCB0byB0ZXN0LgogICAgKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIFJlY3RhbmdsZSBvYmplY3QgY29udGFpbnMgdGhlIHNwZWNpZmllZCBwb2ludDsgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGNvbnRhaW5zOiBmdW5jdGlvbiAoeCwgeSkgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zKHRoaXMsIHgsIHkpOwogICAgfSwKCiAgICAvKioKICAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBmaXJzdCBSZWN0YW5nbGUgb2JqZWN0IGlzIGZ1bGx5IGNvbnRhaW5lZCB3aXRoaW4gdGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgogICAgKiBBIFJlY3RhbmdsZSBvYmplY3QgaXMgc2FpZCB0byBjb250YWluIGFub3RoZXIgaWYgdGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0IGZhbGxzIGVudGlyZWx5IHdpdGhpbiB0aGUgYm91bmRhcmllcyBvZiB0aGUgZmlyc3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNjb250YWluc1JlY3QKICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBiIC0gVGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgogICAgKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIFJlY3RhbmdsZSBvYmplY3QgY29udGFpbnMgdGhlIHNwZWNpZmllZCBwb2ludDsgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGNvbnRhaW5zUmVjdDogZnVuY3Rpb24gKGIpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5jb250YWluc1JlY3QodGhpcywgYik7CiAgICB9LAoKICAgIC8qKgogICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHR3byBSZWN0YW5nbGVzIGFyZSBlcXVhbC4KICAgICogVGhpcyBtZXRob2QgY29tcGFyZXMgdGhlIHgsIHksIHdpZHRoIGFuZCBoZWlnaHQgcHJvcGVydGllcyBvZiBlYWNoIFJlY3RhbmdsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2VxdWFscwogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgdHdvIFJlY3RhbmdsZXMgaGF2ZSBleGFjdGx5IHRoZSBzYW1lIHZhbHVlcyBmb3IgdGhlIHgsIHksIHdpZHRoIGFuZCBoZWlnaHQgcHJvcGVydGllczsgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGVxdWFsczogZnVuY3Rpb24gKGIpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5lcXVhbHModGhpcywgYik7CiAgICB9LAoKICAgIC8qKgogICAgKiBJZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBzcGVjaWZpZWQgaW4gdGhlIHRvSW50ZXJzZWN0IHBhcmFtZXRlciBpbnRlcnNlY3RzIHdpdGggdGhpcyBSZWN0YW5nbGUgb2JqZWN0LCByZXR1cm5zIHRoZSBhcmVhIG9mIGludGVyc2VjdGlvbiBhcyBhIFJlY3RhbmdsZSBvYmplY3QuIElmIHRoZSBSZWN0YW5nbGVzIGRvIG5vdCBpbnRlcnNlY3QsIHRoaXMgbWV0aG9kIHJldHVybnMgYW4gZW1wdHkgUmVjdGFuZ2xlIG9iamVjdCB3aXRoIGl0cyBwcm9wZXJ0aWVzIHNldCB0byAwLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjaW50ZXJzZWN0aW9uCiAgICAqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBvdXQgLSBPcHRpb25hbCBSZWN0YW5nbGUgb2JqZWN0LiBJZiBnaXZlbiB0aGUgaW50ZXJzZWN0aW9uIHZhbHVlcyB3aWxsIGJlIHNldCBpbnRvIHRoaXMgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfSBBIFJlY3RhbmdsZSBvYmplY3QgdGhhdCBlcXVhbHMgdGhlIGFyZWEgb2YgaW50ZXJzZWN0aW9uLiBJZiB0aGUgUmVjdGFuZ2xlcyBkbyBub3QgaW50ZXJzZWN0LCB0aGlzIG1ldGhvZCByZXR1cm5zIGFuIGVtcHR5IFJlY3RhbmdsZSBvYmplY3Q7IHRoYXQgaXMsIGEgUmVjdGFuZ2xlIHdpdGggaXRzIHgsIHksIHdpZHRoLCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgc2V0IHRvIDAuCiAgICAqLwogICAgaW50ZXJzZWN0aW9uOiBmdW5jdGlvbiAoYiwgb3V0KSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0aW9uKHRoaXMsIGIsIG91dCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHR3byBSZWN0YW5nbGVzIGludGVyc2VjdCB3aXRoIGVhY2ggb3RoZXIuCiAgICAqIFRoaXMgbWV0aG9kIGNoZWNrcyB0aGUgeCwgeSwgd2lkdGgsIGFuZCBoZWlnaHQgcHJvcGVydGllcyBvZiB0aGUgUmVjdGFuZ2xlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2ludGVyc2VjdHMKICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBiIC0gVGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgogICAgKiBAcGFyYW0ge251bWJlcn0gdG9sZXJhbmNlIC0gQSB0b2xlcmFuY2UgdmFsdWUgdG8gYWxsb3cgZm9yIGFuIGludGVyc2VjdGlvbiB0ZXN0IHdpdGggcGFkZGluZywgZGVmYXVsdCB0byAwLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIHNwZWNpZmllZCBvYmplY3QgaW50ZXJzZWN0cyB3aXRoIHRoaXMgUmVjdGFuZ2xlIG9iamVjdDsgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGludGVyc2VjdHM6IGZ1bmN0aW9uIChiLCB0b2xlcmFuY2UpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzKHRoaXMsIGIsIHRvbGVyYW5jZSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIG9iamVjdCBzcGVjaWZpZWQgaW50ZXJzZWN0cyAob3ZlcmxhcHMpIHdpdGggdGhlIGdpdmVuIHZhbHVlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2ludGVyc2VjdHNSYXcKICAgICogQHBhcmFtIHtudW1iZXJ9IGxlZnQgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHJpZ2h0IC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0b3AgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IGJvdHRvbXQgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHRvbGVyYW5jZSAtIEEgdG9sZXJhbmNlIHZhbHVlIHRvIGFsbG93IGZvciBhbiBpbnRlcnNlY3Rpb24gdGVzdCB3aXRoIHBhZGRpbmcsIGRlZmF1bHQgdG8gMAogICAgKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIHNwZWNpZmllZCBvYmplY3QgaW50ZXJzZWN0cyB3aXRoIHRoZSBSZWN0YW5nbGU7IG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBpbnRlcnNlY3RzUmF3OiBmdW5jdGlvbiAobGVmdCwgcmlnaHQsIHRvcCwgYm90dG9tLCB0b2xlcmFuY2UpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzUmF3KHRoaXMsIGxlZnQsIHJpZ2h0LCB0b3AsIGJvdHRvbSwgdG9sZXJhbmNlKTsKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgdHdvIFJlY3RhbmdsZXMgdG9nZXRoZXIgdG8gY3JlYXRlIGEgbmV3IFJlY3RhbmdsZSBvYmplY3QsIGJ5IGZpbGxpbmcgaW4gdGhlIGhvcml6b250YWwgYW5kIHZlcnRpY2FsIHNwYWNlIGJldHdlZW4gdGhlIHR3byBSZWN0YW5nbGVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjdW5pb24KICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBiIC0gVGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IFtvdXRdIC0gT3B0aW9uYWwgUmVjdGFuZ2xlIG9iamVjdC4gSWYgZ2l2ZW4gdGhlIG5ldyB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGlzIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFJlY3RhbmdsZSBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkIGFuZCByZXR1cm5lZC4KICAgICogQHJldHVybiB7UGhhc2VyLlJlY3RhbmdsZX0gQSBSZWN0YW5nbGUgb2JqZWN0IHRoYXQgaXMgdGhlIHVuaW9uIG9mIHRoZSB0d28gUmVjdGFuZ2xlcy4KICAgICovCiAgICB1bmlvbjogZnVuY3Rpb24gKGIsIG91dCkgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLnVuaW9uKHRoaXMsIGIsIG91dCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjdG9TdHJpbmcKICAgICogQHJldHVybiB7c3RyaW5nfSBBIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgaW5zdGFuY2UuCiAgICAqLwogICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gIlt7UmVjdGFuZ2xlICh4PSIgKyB0aGlzLnggKyAiIHk9IiArIHRoaXMueSArICIgd2lkdGg9IiArIHRoaXMud2lkdGggKyAiIGhlaWdodD0iICsgdGhpcy5oZWlnaHQgKyAiIGVtcHR5PSIgKyB0aGlzLmVtcHR5ICsgIil9XSI7CiAgICB9Cgp9OwoKUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuUmVjdGFuZ2xlOwoKLyoqCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNoYWxmV2lkdGgKKiBAcHJvcGVydHkge251bWJlcn0gaGFsZldpZHRoIC0gSGFsZiBvZiB0aGUgd2lkdGggb2YgdGhlIFJlY3RhbmdsZS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAiaGFsZldpZHRoIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHRoaXMud2lkdGggLyAyKTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNoYWxmSGVpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IGhhbGZIZWlnaHQgLSBIYWxmIG9mIHRoZSBoZWlnaHQgb2YgdGhlIFJlY3RhbmdsZS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAiaGFsZkhlaWdodCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZCh0aGlzLmhlaWdodCAvIDIpOwogICAgfQoKfSk7CgovKioKKiBUaGUgc3VtIG9mIHRoZSB5IGFuZCBoZWlnaHQgcHJvcGVydGllcy4gQ2hhbmdpbmcgdGhlIGJvdHRvbSBwcm9wZXJ0eSBvZiBhIFJlY3RhbmdsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCwgeSBhbmQgd2lkdGggcHJvcGVydGllcywgYnV0IGRvZXMgY2hhbmdlIHRoZSBoZWlnaHQgcHJvcGVydHkuCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNib3R0b20KKiBAcHJvcGVydHkge251bWJlcn0gYm90dG9tIC0gVGhlIHN1bSBvZiB0aGUgeSBhbmQgaGVpZ2h0IHByb3BlcnRpZXMuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSwgImJvdHRvbSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueSArIHRoaXMuaGVpZ2h0OwogICAgfSwKICAKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlIDw9IHRoaXMueSkgewogICAgICAgICAgICB0aGlzLmhlaWdodCA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAodGhpcy55IC0gdmFsdWUpOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIGxvY2F0aW9uIG9mIHRoZSBSZWN0YW5nbGVzIGJvdHRvbSByaWdodCBjb3JuZXIgYXMgYSBQb2ludCBvYmplY3QuCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNib3R0b20KKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYm90dG9tUmlnaHQgLSBHZXRzIG9yIHNldHMgdGhlIGxvY2F0aW9uIG9mIHRoZSBSZWN0YW5nbGVzIGJvdHRvbSByaWdodCBjb3JuZXIgYXMgYSBQb2ludCBvYmplY3QuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSwgImJvdHRvbVJpZ2h0IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gbmV3IFBoYXNlci5Qb2ludCh0aGlzLnJpZ2h0LCB0aGlzLmJvdHRvbSk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5yaWdodCA9IHZhbHVlLng7CiAgICAgICAgdGhpcy5ib3R0b20gPSB2YWx1ZS55OwogICAgfQoKfSk7CgovKioKKiBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBsZWZ0IG9mIHRoZSBSZWN0YW5nbGUuIENoYW5naW5nIHRoZSBsZWZ0IHByb3BlcnR5IG9mIGEgUmVjdGFuZ2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB5IGFuZCBoZWlnaHQgcHJvcGVydGllcy4gSG93ZXZlciBpdCBkb2VzIGFmZmVjdCB0aGUgd2lkdGggcHJvcGVydHksIHdoZXJlYXMgY2hhbmdpbmcgdGhlIHggdmFsdWUgZG9lcyBub3QgYWZmZWN0IHRoZSB3aWR0aCBwcm9wZXJ0eS4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2xlZnQKKiBAcHJvcGVydHkge251bWJlcn0gbGVmdCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGxlZnQgb2YgdGhlIFJlY3RhbmdsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAibGVmdCIsIHsKICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy54OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA+PSB0aGlzLnJpZ2h0KSB7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSB0aGlzLnJpZ2h0IC0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMueCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBUaGUgc3VtIG9mIHRoZSB4IGFuZCB3aWR0aCBwcm9wZXJ0aWVzLiBDaGFuZ2luZyB0aGUgcmlnaHQgcHJvcGVydHkgb2YgYSBSZWN0YW5nbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHgsIHkgYW5kIGhlaWdodCBwcm9wZXJ0aWVzLCBob3dldmVyIGl0IGRvZXMgYWZmZWN0IHRoZSB3aWR0aCBwcm9wZXJ0eS4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI3JpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IHJpZ2h0IC0gVGhlIHN1bSBvZiB0aGUgeCBhbmQgd2lkdGggcHJvcGVydGllcy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAicmlnaHQiLCB7CiAgICAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnggKyB0aGlzLndpZHRoOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA8PSB0aGlzLngpIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMueCArIHZhbHVlOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIHZvbHVtZSBvZiB0aGUgUmVjdGFuZ2xlIGRlcml2ZWQgZnJvbSB3aWR0aCAqIGhlaWdodC4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI3ZvbHVtZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB2b2x1bWUgLSBUaGUgdm9sdW1lIG9mIHRoZSBSZWN0YW5nbGUgZGVyaXZlZCBmcm9tIHdpZHRoICogaGVpZ2h0LgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJ2b2x1bWUiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLndpZHRoICogdGhpcy5oZWlnaHQ7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBwZXJpbWV0ZXIgc2l6ZSBvZiB0aGUgUmVjdGFuZ2xlLiBUaGlzIGlzIHRoZSBzdW0gb2YgYWxsIDQgc2lkZXMuCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNwZXJpbWV0ZXIKKiBAcHJvcGVydHkge251bWJlcn0gcGVyaW1ldGVyIC0gVGhlIHBlcmltZXRlciBzaXplIG9mIHRoZSBSZWN0YW5nbGUuIFRoaXMgaXMgdGhlIHN1bSBvZiBhbGwgNCBzaWRlcy4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAicGVyaW1ldGVyIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKHRoaXMud2lkdGggKiAyKSArICh0aGlzLmhlaWdodCAqIDIpOwogICAgfQoKfSk7CgovKioKKiBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIFJlY3RhbmdsZS4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2NlbnRlclgKKiBAcHJvcGVydHkge251bWJlcn0gY2VudGVyWCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgUmVjdGFuZ2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJjZW50ZXJYIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy54ICsgdGhpcy5oYWxmV2lkdGg7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy54ID0gdmFsdWUgLSB0aGlzLmhhbGZXaWR0aDsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBSZWN0YW5nbGUuCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNjZW50ZXJZCiogQHByb3BlcnR5IHtudW1iZXJ9IGNlbnRlclkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIFJlY3RhbmdsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAiY2VudGVyWSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueSArIHRoaXMuaGFsZkhlaWdodDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLnkgPSB2YWx1ZSAtIHRoaXMuaGFsZkhlaWdodDsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgdG9wIG9mIHRoZSBSZWN0YW5nbGUuIENoYW5naW5nIHRoZSB0b3AgcHJvcGVydHkgb2YgYSBSZWN0YW5nbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHggYW5kIHdpZHRoIHByb3BlcnRpZXMuCiogSG93ZXZlciBpdCBkb2VzIGFmZmVjdCB0aGUgaGVpZ2h0IHByb3BlcnR5LCB3aGVyZWFzIGNoYW5naW5nIHRoZSB5IHZhbHVlIGRvZXMgbm90IGFmZmVjdCB0aGUgaGVpZ2h0IHByb3BlcnR5LgoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjdG9wCiogQHByb3BlcnR5IHtudW1iZXJ9IHRvcCAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHRvcCBvZiB0aGUgUmVjdGFuZ2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJ0b3AiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID49IHRoaXMuYm90dG9tKSB7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gMDsKICAgICAgICAgICAgdGhpcy55ID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAodGhpcy5ib3R0b20gLSB2YWx1ZSk7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgbG9jYXRpb24gb2YgdGhlIFJlY3RhbmdsZXMgdG9wIGxlZnQgY29ybmVyIGFzIGEgUG9pbnQgb2JqZWN0LgoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjdG9wTGVmdAoqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSB0b3BMZWZ0IC0gVGhlIGxvY2F0aW9uIG9mIHRoZSBSZWN0YW5nbGVzIHRvcCBsZWZ0IGNvcm5lciBhcyBhIFBvaW50IG9iamVjdC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAidG9wTGVmdCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gbmV3IFBoYXNlci5Qb2ludCh0aGlzLngsIHRoaXMueSk7CiAgICB9LAogICAgCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMueCA9IHZhbHVlLng7CiAgICAgICAgdGhpcy55ID0gdmFsdWUueTsKICAgIH0KCn0pOwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIG9yIG5vdCB0aGlzIFJlY3RhbmdsZSBvYmplY3QgaXMgZW1wdHkuIEEgUmVjdGFuZ2xlIG9iamVjdCBpcyBlbXB0eSBpZiBpdHMgd2lkdGggb3IgaGVpZ2h0IGlzIGxlc3MgdGhhbiBvciBlcXVhbCB0byAwLgoqIElmIHNldCB0byB0cnVlIHRoZW4gYWxsIG9mIHRoZSBSZWN0YW5nbGUgcHJvcGVydGllcyBhcmUgc2V0IHRvIDAuIAoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjZW1wdHkKKiBAcHJvcGVydHkge2Jvb2xlYW59IGVtcHR5IC0gR2V0cyBvciBzZXRzIHRoZSBSZWN0YW5nbGVzIGVtcHR5IHN0YXRlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJlbXB0eSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICghdGhpcy53aWR0aCB8fCAhdGhpcy5oZWlnaHQpOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodmFsdWUgPT09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNldFRvKDAsIDAsIDAsIDApOwogICAgICAgIH0KICAgICAgICAKICAgIH0KCn0pOwoKLyoqCiogSW5jcmVhc2VzIHRoZSBzaXplIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0IGJ5IHRoZSBzcGVjaWZpZWQgYW1vdW50cy4gVGhlIGNlbnRlciBwb2ludCBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBzdGF5cyB0aGUgc2FtZSwgYW5kIGl0cyBzaXplIGluY3JlYXNlcyB0byB0aGUgbGVmdCBhbmQgcmlnaHQgYnkgdGhlIGR4IHZhbHVlLCBhbmQgdG8gdGhlIHRvcCBhbmQgdGhlIGJvdHRvbSBieSB0aGUgZHkgdmFsdWUuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmluZmxhdGUKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge251bWJlcn0gZHggLSBUaGUgYW1vdW50IHRvIGJlIGFkZGVkIHRvIHRoZSBsZWZ0IHNpZGUgb2YgdGhlIFJlY3RhbmdsZS4KKiBAcGFyYW0ge251bWJlcn0gZHkgLSBUaGUgYW1vdW50IHRvIGJlIGFkZGVkIHRvIHRoZSBib3R0b20gc2lkZSBvZiB0aGUgUmVjdGFuZ2xlLgoqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9IFRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KKi8KUGhhc2VyLlJlY3RhbmdsZS5pbmZsYXRlID0gZnVuY3Rpb24gKGEsIGR4LCBkeSkgewogICAgYS54IC09IGR4OwogICAgYS53aWR0aCArPSAyICogZHg7CiAgICBhLnkgLT0gZHk7CiAgICBhLmhlaWdodCArPSAyICogZHk7CiAgICByZXR1cm4gYTsKfTsKCi8qKgoqIEluY3JlYXNlcyB0aGUgc2l6ZSBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdC4gVGhpcyBtZXRob2QgaXMgc2ltaWxhciB0byB0aGUgUmVjdGFuZ2xlLmluZmxhdGUoKSBtZXRob2QgZXhjZXB0IGl0IHRha2VzIGEgUG9pbnQgb2JqZWN0IGFzIGEgcGFyYW1ldGVyLgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS5pbmZsYXRlUG9pbnQKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gcG9pbnQgLSBUaGUgeCBwcm9wZXJ0eSBvZiB0aGlzIFBvaW50IG9iamVjdCBpcyB1c2VkIHRvIGluY3JlYXNlIHRoZSBob3Jpem9udGFsIGRpbWVuc2lvbiBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdC4gVGhlIHkgcHJvcGVydHkgaXMgdXNlZCB0byBpbmNyZWFzZSB0aGUgdmVydGljYWwgZGltZW5zaW9uIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0LgoqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9IFRoZSBSZWN0YW5nbGUgb2JqZWN0LgoqLwpQaGFzZXIuUmVjdGFuZ2xlLmluZmxhdGVQb2ludCA9IGZ1bmN0aW9uIChhLCBwb2ludCkgewogICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuaW5mbGF0ZShhLCBwb2ludC54LCBwb2ludC55KTsKfTsKCi8qKgoqIFRoZSBzaXplIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0LCBleHByZXNzZWQgYXMgYSBQb2ludCBvYmplY3Qgd2l0aCB0aGUgdmFsdWVzIG9mIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLnNpemUKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW291dHB1dF0gLSBPcHRpb25hbCBQb2ludCBvYmplY3QuIElmIGdpdmVuIHRoZSB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGUgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUG9pbnQgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgc2l6ZSBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdAoqLwpQaGFzZXIuUmVjdGFuZ2xlLnNpemUgPSBmdW5jdGlvbiAoYSwgb3V0cHV0KSB7CiAgICBpZiAodHlwZW9mIG91dHB1dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0cHV0ID0gbmV3IFBoYXNlci5Qb2ludCgpOyB9CiAgICByZXR1cm4gb3V0cHV0LnNldFRvKGEud2lkdGgsIGEuaGVpZ2h0KTsKfTsKCi8qKgoqIFJldHVybnMgYSBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aXRoIHRoZSBzYW1lIHZhbHVlcyBmb3IgdGhlIHgsIHksIHdpZHRoLCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgYXMgdGhlIG9yaWdpbmFsIFJlY3RhbmdsZSBvYmplY3QuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmNsb25lCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBbb3V0cHV0XSAtIE9wdGlvbmFsIFJlY3RhbmdsZSBvYmplY3QuIElmIGdpdmVuIHRoZSB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGUgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgoqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9CiovClBoYXNlci5SZWN0YW5nbGUuY2xvbmUgPSBmdW5jdGlvbiAoYSwgb3V0cHV0KSB7CiAgICBpZiAodHlwZW9mIG91dHB1dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0cHV0ID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoKTsgfQogICAgcmV0dXJuIG91dHB1dC5zZXRUbyhhLngsIGEueSwgYS53aWR0aCwgYS5oZWlnaHQpOwp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBzcGVjaWZpZWQgY29vcmRpbmF0ZXMgYXJlIGNvbnRhaW5lZCB3aXRoaW4gdGhlIHJlZ2lvbiBkZWZpbmVkIGJ5IHRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuY29udGFpbnMKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHBvaW50IHRvIHRlc3QuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBwb2ludCB0byB0ZXN0LgoqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBjb250YWlucyB0aGUgc3BlY2lmaWVkIHBvaW50OyBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5SZWN0YW5nbGUuY29udGFpbnMgPSBmdW5jdGlvbiAoYSwgeCwgeSkgewogICAgcmV0dXJuICh4ID49IGEueCAmJiB4IDw9IGEucmlnaHQgJiYgeSA+PSBhLnkgJiYgeSA8PSBhLmJvdHRvbSk7Cn07CgpQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zUmF3ID0gZnVuY3Rpb24gKHJ4LCByeSwgcncsIHJoLCB4LCB5KSB7CiAgICByZXR1cm4gKHggPj0gcnggJiYgeCA8PSAocnggKyBydykgJiYgeSA+PSByeSAmJiB5IDw9IChyeSArIHJoKSk7Cn07CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHNwZWNpZmllZCBwb2ludCBpcyBjb250YWluZWQgd2l0aGluIHRoZSByZWN0YW5ndWxhciByZWdpb24gZGVmaW5lZCBieSB0aGlzIFJlY3RhbmdsZSBvYmplY3QuIFRoaXMgbWV0aG9kIGlzIHNpbWlsYXIgdG8gdGhlIFJlY3RhbmdsZS5jb250YWlucygpIG1ldGhvZCwgZXhjZXB0IHRoYXQgaXQgdGFrZXMgYSBQb2ludCBvYmplY3QgYXMgYSBwYXJhbWV0ZXIuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zUG9pbnQKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gcG9pbnQgLSBUaGUgcG9pbnQgb2JqZWN0IGJlaW5nIGNoZWNrZWQuIENhbiBiZSBQb2ludCBvciBhbnkgb2JqZWN0IHdpdGggLnggYW5kIC55IHZhbHVlcy4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIFJlY3RhbmdsZSBvYmplY3QgY29udGFpbnMgdGhlIHNwZWNpZmllZCBwb2ludDsgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zUG9pbnQgPSBmdW5jdGlvbiAoYSwgcG9pbnQpIHsKICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zKGEsIHBvaW50LngsIHBvaW50LnkpOwp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBmaXJzdCBSZWN0YW5nbGUgb2JqZWN0IGlzIGZ1bGx5IGNvbnRhaW5lZCB3aXRoaW4gdGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgoqIEEgUmVjdGFuZ2xlIG9iamVjdCBpcyBzYWlkIHRvIGNvbnRhaW4gYW5vdGhlciBpZiB0aGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QgZmFsbHMgZW50aXJlbHkgd2l0aGluIHRoZSBib3VuZGFyaWVzIG9mIHRoZSBmaXJzdC4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuY29udGFpbnNSZWN0CiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIGZpcnN0IFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBiIC0gVGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgoqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBjb250YWlucyB0aGUgc3BlY2lmaWVkIHBvaW50OyBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5SZWN0YW5nbGUuY29udGFpbnNSZWN0ID0gZnVuY3Rpb24gKGEsIGIpIHsKCiAgICAvLyAgSWYgdGhlIGdpdmVuIHJlY3QgaGFzIGEgbGFyZ2VyIHZvbHVtZSB0aGFuIHRoaXMgb25lIHRoZW4gaXQgY2FuIG5ldmVyIGNvbnRhaW4gaXQKICAgIGlmIChhLnZvbHVtZSA+IGIudm9sdW1lKQogICAgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gKGEueCA+PSBiLnggJiYgYS55ID49IGIueSAmJiBhLnJpZ2h0IDw9IGIucmlnaHQgJiYgYS5ib3R0b20gPD0gYi5ib3R0b20pOwoKfTsKCi8qKgoqIERldGVybWluZXMgd2hldGhlciB0aGUgdHdvIFJlY3RhbmdsZXMgYXJlIGVxdWFsLgoqIFRoaXMgbWV0aG9kIGNvbXBhcmVzIHRoZSB4LCB5LCB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgb2YgZWFjaCBSZWN0YW5nbGUuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmVxdWFscwoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBmaXJzdCBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIHR3byBSZWN0YW5nbGVzIGhhdmUgZXhhY3RseSB0aGUgc2FtZSB2YWx1ZXMgZm9yIHRoZSB4LCB5LCB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXM7IG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLlJlY3RhbmdsZS5lcXVhbHMgPSBmdW5jdGlvbiAoYSwgYikgewogICAgcmV0dXJuIChhLnggPT0gYi54ICYmIGEueSA9PSBiLnkgJiYgYS53aWR0aCA9PSBiLndpZHRoICYmIGEuaGVpZ2h0ID09IGIuaGVpZ2h0KTsKfTsKCi8qKgoqIElmIHRoZSBSZWN0YW5nbGUgb2JqZWN0IHNwZWNpZmllZCBpbiB0aGUgdG9JbnRlcnNlY3QgcGFyYW1ldGVyIGludGVyc2VjdHMgd2l0aCB0aGlzIFJlY3RhbmdsZSBvYmplY3QsIHJldHVybnMgdGhlIGFyZWEgb2YgaW50ZXJzZWN0aW9uIGFzIGEgUmVjdGFuZ2xlIG9iamVjdC4gSWYgdGhlIFJlY3RhbmdsZXMgZG8gbm90IGludGVyc2VjdCwgdGhpcyBtZXRob2QgcmV0dXJucyBhbiBlbXB0eSBSZWN0YW5nbGUgb2JqZWN0IHdpdGggaXRzIHByb3BlcnRpZXMgc2V0IHRvIDAuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdGlvbgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBmaXJzdCBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IFtvdXRdIC0gT3B0aW9uYWwgUmVjdGFuZ2xlIG9iamVjdC4gSWYgZ2l2ZW4gdGhlIGludGVyc2VjdGlvbiB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGlzIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFJlY3RhbmdsZSBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkIGFuZCByZXR1cm5lZC4KKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfSBBIFJlY3RhbmdsZSBvYmplY3QgdGhhdCBlcXVhbHMgdGhlIGFyZWEgb2YgaW50ZXJzZWN0aW9uLiBJZiB0aGUgUmVjdGFuZ2xlcyBkbyBub3QgaW50ZXJzZWN0LCB0aGlzIG1ldGhvZCByZXR1cm5zIGFuIGVtcHR5IFJlY3RhbmdsZSBvYmplY3Q7IHRoYXQgaXMsIGEgUmVjdGFuZ2xlIHdpdGggaXRzIHgsIHksIHdpZHRoLCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgc2V0IHRvIDAuCiovClBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24gKGEsIGIsIG91dCkgewoKICAgIG91dCAgPSBvdXQgfHwgbmV3IFBoYXNlci5SZWN0YW5nbGUoKTsKCiAgICBpZiAoUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzKGEsIGIpKQogICAgewogICAgICAgIG91dC54ID0gTWF0aC5tYXgoYS54LCBiLngpOwogICAgICAgIG91dC55ID0gTWF0aC5tYXgoYS55LCBiLnkpOwogICAgICAgIG91dC53aWR0aCA9IE1hdGgubWluKGEucmlnaHQsIGIucmlnaHQpIC0gb3V0Lng7CiAgICAgICAgb3V0LmhlaWdodCA9IE1hdGgubWluKGEuYm90dG9tLCBiLmJvdHRvbSkgLSBvdXQueTsKICAgIH0KCiAgICByZXR1cm4gb3V0OwoKfTsKCi8qKgoqIERldGVybWluZXMgd2hldGhlciB0aGUgdHdvIFJlY3RhbmdsZXMgaW50ZXJzZWN0IHdpdGggZWFjaCBvdGhlci4KKiBUaGlzIG1ldGhvZCBjaGVja3MgdGhlIHgsIHksIHdpZHRoLCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgb2YgdGhlIFJlY3RhbmdsZXMuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHMKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgZmlyc3QgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBzcGVjaWZpZWQgb2JqZWN0IGludGVyc2VjdHMgd2l0aCB0aGlzIFJlY3RhbmdsZSBvYmplY3Q7IG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzID0gZnVuY3Rpb24gKGEsIGIpIHsKCiAgICBpZiAoYS53aWR0aCA8PSAwIHx8IGEuaGVpZ2h0IDw9IDAgfHwgYi53aWR0aCA8PSAwIHx8IGIuaGVpZ2h0IDw9IDApCiAgICB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHJldHVybiAhKGEucmlnaHQgPCBiLnggfHwgYS5ib3R0b20gPCBiLnkgfHwgYS54ID4gYi5yaWdodCB8fCBhLnkgPiBiLmJvdHRvbSk7Cgp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBvYmplY3Qgc3BlY2lmaWVkIGludGVyc2VjdHMgKG92ZXJsYXBzKSB3aXRoIHRoZSBnaXZlbiB2YWx1ZXMuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHNSYXcKKiBAcGFyYW0ge251bWJlcn0gbGVmdCAtIERlc2NyaXB0aW9uLgoqIEBwYXJhbSB7bnVtYmVyfSByaWdodCAtIERlc2NyaXB0aW9uLgoqIEBwYXJhbSB7bnVtYmVyfSB0b3AgLSBEZXNjcmlwdGlvbi4KKiBAcGFyYW0ge251bWJlcn0gYm90dG9tIC0gRGVzY3JpcHRpb24uCiogQHBhcmFtIHtudW1iZXJ9IHRvbGVyYW5jZSAtIEEgdG9sZXJhbmNlIHZhbHVlIHRvIGFsbG93IGZvciBhbiBpbnRlcnNlY3Rpb24gdGVzdCB3aXRoIHBhZGRpbmcsIGRlZmF1bHQgdG8gMAoqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBpbnRlcnNlY3RzIHdpdGggdGhlIFJlY3RhbmdsZTsgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHNSYXcgPSBmdW5jdGlvbiAoYSwgbGVmdCwgcmlnaHQsIHRvcCwgYm90dG9tLCB0b2xlcmFuY2UpIHsKCiAgICBpZiAodHlwZW9mIHRvbGVyYW5jZSA9PT0gInVuZGVmaW5lZCIpIHsgdG9sZXJhbmNlID0gMDsgfQoKICAgIHJldHVybiAhKGxlZnQgPiBhLnJpZ2h0ICsgdG9sZXJhbmNlIHx8IHJpZ2h0IDwgYS5sZWZ0IC0gdG9sZXJhbmNlIHx8IHRvcCA+IGEuYm90dG9tICsgdG9sZXJhbmNlIHx8IGJvdHRvbSA8IGEudG9wIC0gdG9sZXJhbmNlKTsKCn07CgovKioKKiBBZGRzIHR3byBSZWN0YW5nbGVzIHRvZ2V0aGVyIHRvIGNyZWF0ZSBhIG5ldyBSZWN0YW5nbGUgb2JqZWN0LCBieSBmaWxsaW5nIGluIHRoZSBob3Jpem9udGFsIGFuZCB2ZXJ0aWNhbCBzcGFjZSBiZXR3ZWVuIHRoZSB0d28gUmVjdGFuZ2xlcy4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUudW5pb24KKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgZmlyc3QgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBbb3V0XSAtIE9wdGlvbmFsIFJlY3RhbmdsZSBvYmplY3QuIElmIGdpdmVuIHRoZSBuZXcgdmFsdWVzIHdpbGwgYmUgc2V0IGludG8gdGhpcyBvYmplY3QsIG90aGVyd2lzZSBhIGJyYW5kIG5ldyBSZWN0YW5nbGUgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiogQHJldHVybiB7UGhhc2VyLlJlY3RhbmdsZX0gQSBSZWN0YW5nbGUgb2JqZWN0IHRoYXQgaXMgdGhlIHVuaW9uIG9mIHRoZSB0d28gUmVjdGFuZ2xlcy4KKi8KUGhhc2VyLlJlY3RhbmdsZS51bmlvbiA9IGZ1bmN0aW9uIChhLCBiLCBvdXQpIHsKCiAgICBpZiAodHlwZW9mIG91dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0ID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoKTsgfQoKICAgIHJldHVybiBvdXQuc2V0VG8oTWF0aC5taW4oYS54LCBiLngpLCBNYXRoLm1pbihhLnksIGIueSksIE1hdGgubWF4KGEucmlnaHQsIGIucmlnaHQpIC0gTWF0aC5taW4oYS5sZWZ0LCBiLmxlZnQpLCBNYXRoLm1heChhLmJvdHRvbSwgYi5ib3R0b20pIC0gTWF0aC5taW4oYS50b3AsIGIudG9wKSk7CiAgICAKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIENyZWF0ZXMgYSBuZXcgUG9seWdvbi4gWW91IGhhdmUgdG8gcHJvdmlkZSBhIGxpc3Qgb2YgcG9pbnRzLgoqIFRoaXMgY2FuIGJlIGFuIGFycmF5IG9mIFBvaW50cyB0aGF0IGZvcm0gdGhlIHBvbHlnb24sIGEgZmxhdCBhcnJheSBvZiBudW1iZXJzIHRoYXQgd2lsbCBiZSBpbnRlcnByZXRlZCBhcyBbeCx5LCB4LHksIC4uLl0sIAoqIG9yIHRoZSBhcmd1bWVudHMgcGFzc2VkIGNhbiBiZSBhbGwgdGhlIHBvaW50cyBvZiB0aGUgcG9seWdvbiBlLmcuIGBuZXcgUElYSS5Qb2x5Z29uKG5ldyBQSVhJLlBvaW50KCksIG5ldyBQSVhJLlBvaW50KCksIC4uLilgLCBvciB0aGUKKiBhcmd1bWVudHMgcGFzc2VkIGNhbiBiZSBmbGF0IHgseSB2YWx1ZXMgZS5nLiBgbmV3IFBJWEkuUG9seWdvbih4LHksIHgseSwgeCx5LCAuLi4pYCB3aGVyZSBgeGAgYW5kIGB5YCBhcmUgbnVtYmVycy4KKgoqIEBjbGFzcyBQaGFzZXIuUG9seWdvbgoqIEBjbGFzc2Rlc2MgVGhlIHBvbHlnb24gcmVwcmVzZW50cyBhIGxpc3Qgb2Ygb3JkZXJkZWQgcG9pbnRzIGluIHNwYWNlCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtBcnJheTxQaGFzZXIuUG9pbnQ+fEFycmF5PG51bWJlcj59IHBvaW50cyAtIFRoZSBhcnJheSBvZiBQb2ludHMuCiovClBoYXNlci5Qb2x5Z29uID0gZnVuY3Rpb24gKHBvaW50cykgewoKICAgIFBJWEkuUG9seWdvbi5jYWxsKHRoaXMsIHBvaW50cyk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0eXBlIC0gVGhlIGJhc2Ugb2JqZWN0IHR5cGUuCiAgICAqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLlBPTFlHT047Cgp9OwoKUGhhc2VyLlBvbHlnb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLlBvbHlnb24ucHJvdG90eXBlKTsKUGhhc2VyLlBvbHlnb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlBvbHlnb247Ci8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIENyZWF0ZXMgYSBuZXcgTGluZSBvYmplY3Qgd2l0aCBhIHN0YXJ0IGFuZCBhbiBlbmQgcG9pbnQuCiogQGNsYXNzIExpbmUKKiBAY2xhc3NkZXNjIFBoYXNlciAtIExpbmUKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge251bWJlcn0gW3gxPTBdIC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgc3RhcnQgb2YgdGhlIGxpbmUuCiogQHBhcmFtIHtudW1iZXJ9IFt5MT0wXSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHN0YXJ0IG9mIHRoZSBsaW5lLgoqIEBwYXJhbSB7bnVtYmVyfSBbeDI9MF0gLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBlbmQgb2YgdGhlIGxpbmUuCiogQHBhcmFtIHtudW1iZXJ9IFt5Mj0wXSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIGVuZCBvZiB0aGUgbGluZS4KKiBAcmV0dXJuIHtQaGFzZXIuTGluZX0gVGhpcyBsaW5lIG9iamVjdAoqLwpQaGFzZXIuTGluZSA9IGZ1bmN0aW9uICh4MSwgeTEsIHgyLCB5MikgewoKICAgIHgxID0geDEgfHwgMDsKICAgIHkxID0geTEgfHwgMDsKICAgIHgyID0geDIgfHwgMDsKICAgIHkyID0geTIgfHwgMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHN0YXJ0IC0gVGhlIHN0YXJ0IHBvaW50IG9mIHRoZSBsaW5lLgogICAgKi8KICAgIHRoaXMuc3RhcnQgPSBuZXcgUGhhc2VyLlBvaW50KHgxLCB5MSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBlbmQgLSBUaGUgZW5kIHBvaW50IG9mIHRoZSBsaW5lLgogICAgKi8KICAgIHRoaXMuZW5kID0gbmV3IFBoYXNlci5Qb2ludCh4MiwgeTIpOwoKfTsKClBoYXNlci5MaW5lLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogU2V0cyB0aGUgY29tcG9uZW50cyBvZiB0aGUgTGluZSB0byB0aGUgc3BlY2lmaWVkIHZhbHVlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuTGluZSNzZXRUbwogICAgKiBAcGFyYW0ge251bWJlcn0gW3gxPTBdIC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgc3RhcnQgb2YgdGhlIGxpbmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeTE9MF0gLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBzdGFydCBvZiB0aGUgbGluZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt4Mj0wXSAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGVuZCBvZiB0aGUgbGluZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5Mj0wXSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIGVuZCBvZiB0aGUgbGluZS4KICAgICogQHJldHVybiB7UGhhc2VyLkxpbmV9IFRoaXMgbGluZSBvYmplY3QKICAgICovCiAgICBzZXRUbzogZnVuY3Rpb24gKHgxLCB5MSwgeDIsIHkyKSB7CgogICAgICAgIHRoaXMuc3RhcnQuc2V0VG8oeDEsIHkxKTsKICAgICAgICB0aGlzLmVuZC5zZXRUbyh4MiwgeTIpOwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBsaW5lIHRvIG1hdGNoIHRoZSB4L3kgY29vcmRpbmF0ZXMgb2YgdGhlIHR3byBnaXZlbiBzcHJpdGVzLgogICAgKiBDYW4gb3B0aW9uYWxseSBiZSBjYWxjdWxhdGVkIGZyb20gdGhlaXIgY2VudGVyIGNvb3JkaW5hdGVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5MaW5lI2Zyb21TcHJpdGUKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzdGFydFNwcml0ZSAtIFRoZSBjb29yZGluYXRlcyBvZiB0aGlzIFNwcml0ZSB3aWxsIGJlIHNldCB0byB0aGUgTGluZS5zdGFydCBwb2ludC4KICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBlbmRTcHJpdGUgLSBUaGUgY29vcmRpbmF0ZXMgb2YgdGhpcyBTcHJpdGUgd2lsbCBiZSBzZXQgdG8gdGhlIExpbmUuc3RhcnQgcG9pbnQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3VzZUNlbnRlcj10cnVlXSAtIElmIHRydWUgaXQgd2lsbCB1c2Ugc3RhcnRTcHJpdGUuY2VudGVyLngsIGlmIGZhbHNlIHN0YXJ0U3ByaXRlLnguCiAgICAqIEByZXR1cm4ge1BoYXNlci5MaW5lfSBUaGlzIGxpbmUgb2JqZWN0CiAgICAqLwogICAgZnJvbVNwcml0ZTogZnVuY3Rpb24gKHN0YXJ0U3ByaXRlLCBlbmRTcHJpdGUsIHVzZUNlbnRlcikgewoKICAgICAgICBpZiAodHlwZW9mIHVzZUNlbnRlciA9PT0gJ3VuZGVmaW5lZCcpIHsgdXNlQ2VudGVyID0gdHJ1ZTsgfQoKICAgICAgICBpZiAodXNlQ2VudGVyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0VG8oc3RhcnRTcHJpdGUuY2VudGVyLngsIHN0YXJ0U3ByaXRlLmNlbnRlci55LCBlbmRTcHJpdGUuY2VudGVyLngsIGVuZFNwcml0ZS5jZW50ZXIueSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldFRvKHN0YXJ0U3ByaXRlLngsIHN0YXJ0U3ByaXRlLnksIGVuZFNwcml0ZS54LCBlbmRTcHJpdGUueSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrcyBmb3IgaW50ZXJzZWN0aW9uIGJldHdlZW4gdGhpcyBsaW5lIGFuZCBhbm90aGVyIExpbmUuCiAgICAqIElmIGFzU2VnbWVudCBpcyB0cnVlIGl0IHdpbGwgY2hlY2sgZm9yIHNlZ21lbnQgaW50ZXJzZWN0aW9uLiBJZiBhc1NlZ21lbnQgaXMgZmFsc2UgaXQgd2lsbCBjaGVjayBmb3IgbGluZSBpbnRlcnNlY3Rpb24uCiAgICAqIFJldHVybnMgdGhlIGludGVyc2VjdGlvbiBzZWdtZW50IG9mIEFCIGFuZCBFRiBhcyBhIFBvaW50LCBvciBudWxsIGlmIHRoZXJlIGlzIG5vIGludGVyc2VjdGlvbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTGluZSNpbnRlcnNlY3RzCiAgICAqIEBwYXJhbSB7UGhhc2VyLkxpbmV9IGxpbmUgLSBUaGUgbGluZSB0byBjaGVjayBhZ2FpbnN0IHRoaXMgb25lLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFthc1NlZ21lbnQ9dHJ1ZV0gLSBJZiB0cnVlIGl0IHdpbGwgY2hlY2sgZm9yIHNlZ21lbnQgaW50ZXJzZWN0aW9uLCBvdGhlcndpc2UgZnVsbCBsaW5lIGludGVyc2VjdGlvbi4KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtyZXN1bHRdIC0gQSBQb2ludCBvYmplY3QgdG8gc3RvcmUgdGhlIHJlc3VsdCBpbiwgaWYgbm90IGdpdmVuIGEgbmV3IG9uZSB3aWxsIGJlIGNyZWF0ZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIGludGVyc2VjdGlvbiBzZWdtZW50IG9mIHRoZSB0d28gbGluZXMgYXMgYSBQb2ludCwgb3IgbnVsbCBpZiB0aGVyZSBpcyBubyBpbnRlcnNlY3Rpb24uCiAgICAqLwogICAgaW50ZXJzZWN0czogZnVuY3Rpb24gKGxpbmUsIGFzU2VnbWVudCwgcmVzdWx0KSB7CgogICAgICAgIHJldHVybiBQaGFzZXIuTGluZS5pbnRlcnNlY3RzUG9pbnRzKHRoaXMuc3RhcnQsIHRoaXMuZW5kLCBsaW5lLnN0YXJ0LCBsaW5lLmVuZCwgYXNTZWdtZW50LCByZXN1bHQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRlc3RzIGlmIHRoZSBnaXZlbiBjb29yZGluYXRlcyBmYWxsIG9uIHRoaXMgbGluZS4gU2VlIHBvaW50T25TZWdtZW50IHRvIHRlc3QgYWdhaW5zdCBqdXN0IHRoZSBsaW5lIHNlZ21lbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLkxpbmUjcG9pbnRPbkxpbmUKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgbGluZSB0byBjaGVjayBhZ2FpbnN0IHRoaXMgb25lLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBsaW5lIHRvIGNoZWNrIGFnYWluc3QgdGhpcyBvbmUuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIHBvaW50IGlzIG9uIHRoZSBsaW5lLCBmYWxzZSBpZiBub3QuCiAgICAqLwogICAgcG9pbnRPbkxpbmU6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHJldHVybiAoKHggLSB0aGlzLnN0YXJ0LngpICogKHRoaXMuZW5kLnkgLSB0aGlzLmVuZC55KSA9PT0gKHRoaXMuZW5kLnggLSB0aGlzLnN0YXJ0LngpICogKHkgLSB0aGlzLmVuZC55KSk7CgogICAgfSwKCiAgICAvKioKICAgICogVGVzdHMgaWYgdGhlIGdpdmVuIGNvb3JkaW5hdGVzIGZhbGwgb24gdGhpcyBsaW5lIGFuZCB3aXRoaW4gdGhlIHNlZ21lbnQuIFNlZSBwb2ludE9uTGluZSB0byB0ZXN0IGFnYWluc3QganVzdCB0aGUgbGluZS4KICAgICogQG1ldGhvZCBQaGFzZXIuTGluZSNwb2ludE9uU2VnbWVudAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBsaW5lIHRvIGNoZWNrIGFnYWluc3QgdGhpcyBvbmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIGxpbmUgdG8gY2hlY2sgYWdhaW5zdCB0aGlzIG9uZS4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgcG9pbnQgaXMgb24gdGhlIGxpbmUgYW5kIHNlZ21lbnQsIGZhbHNlIGlmIG5vdC4KICAgICovCiAgICBwb2ludE9uU2VnbWVudDogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgdmFyIHhNaW4gPSBNYXRoLm1pbih0aGlzLnN0YXJ0LngsIHRoaXMuZW5kLngpOwogICAgICAgIHZhciB4TWF4ID0gTWF0aC5tYXgodGhpcy5zdGFydC54LCB0aGlzLmVuZC54KTsKICAgICAgICB2YXIgeU1pbiA9IE1hdGgubWluKHRoaXMuc3RhcnQueSwgdGhpcy5lbmQueSk7CiAgICAgICAgdmFyIHlNYXggPSBNYXRoLm1heCh0aGlzLnN0YXJ0LnksIHRoaXMuZW5kLnkpOwoKICAgICAgICByZXR1cm4gKHRoaXMucG9pbnRPbkxpbmUoeCwgeSkgJiYgKHggPj0geE1pbiAmJiB4IDw9IHhNYXgpICYmICh5ID49IHlNaW4gJiYgeSA8PSB5TWF4KSk7CgogICAgfQoKfTsKCi8qKgoqIEBuYW1lIFBoYXNlci5MaW5lI2xlbmd0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsZW5ndGggLSBHZXRzIHRoZSBsZW5ndGggb2YgdGhlIGxpbmUgc2VnbWVudC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5MaW5lLnByb3RvdHlwZSwgImxlbmd0aCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KCh0aGlzLmVuZC54IC0gdGhpcy5zdGFydC54KSAqICh0aGlzLmVuZC54IC0gdGhpcy5zdGFydC54KSArICh0aGlzLmVuZC55IC0gdGhpcy5zdGFydC55KSAqICh0aGlzLmVuZC55IC0gdGhpcy5zdGFydC55KSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5MaW5lI2FuZ2xlCiogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ2xlIC0gR2V0cyB0aGUgYW5nbGUgb2YgdGhlIGxpbmUuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuTGluZS5wcm90b3R5cGUsICJhbmdsZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gTWF0aC5hdGFuMih0aGlzLmVuZC54IC0gdGhpcy5zdGFydC54LCB0aGlzLmVuZC55IC0gdGhpcy5zdGFydC55KTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkxpbmUjc2xvcGUKKiBAcHJvcGVydHkge251bWJlcn0gc2xvcGUgLSBHZXRzIHRoZSBzbG9wZSBvZiB0aGUgbGluZSAoeS94KS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5MaW5lLnByb3RvdHlwZSwgInNsb3BlIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAodGhpcy5lbmQueSAtIHRoaXMuc3RhcnQueSkgLyAodGhpcy5lbmQueCAtIHRoaXMuc3RhcnQueCk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5MaW5lI3BlcnBTbG9wZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwZXJwU2xvcGUgLSBHZXRzIHRoZSBwZXJwZW5kaWN1bGFyIHNsb3BlIG9mIHRoZSBsaW5lICh4L3kpLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkxpbmUucHJvdG90eXBlLCAicGVycFNsb3BlIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAtKCh0aGlzLmVuZC54IC0gdGhpcy5zdGFydC54KSAvICh0aGlzLmVuZC55IC0gdGhpcy5zdGFydC55KSk7CiAgICB9Cgp9KTsKCi8qKgoqIENoZWNrcyBmb3IgaW50ZXJzZWN0aW9uIGJldHdlZW4gdHdvIGxpbmVzIGFzIGRlZmluZWQgYnkgdGhlIGdpdmVuIHN0YXJ0IGFuZCBlbmQgcG9pbnRzLgoqIElmIGFzU2VnbWVudCBpcyB0cnVlIGl0IHdpbGwgY2hlY2sgZm9yIGxpbmUgc2VnbWVudCBpbnRlcnNlY3Rpb24uIElmIGFzU2VnbWVudCBpcyBmYWxzZSBpdCB3aWxsIGNoZWNrIGZvciBsaW5lIGludGVyc2VjdGlvbi4KKiBSZXR1cm5zIHRoZSBpbnRlcnNlY3Rpb24gc2VnbWVudCBvZiBBQiBhbmQgRUYgYXMgYSBQb2ludCwgb3IgbnVsbCBpZiB0aGVyZSBpcyBubyBpbnRlcnNlY3Rpb24uCiogQWRhcHRlZCBmcm9tIGNvZGUgYnkgS2VpdGggSGFpcgoqCiogQG1ldGhvZCBQaGFzZXIuTGluZS5pbnRlcnNlY3RzCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGEgLSBUaGUgc3RhcnQgb2YgdGhlIGZpcnN0IExpbmUgdG8gYmUgY2hlY2tlZC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYiAtIFRoZSBlbmQgb2YgdGhlIGZpcnN0IGxpbmUgdG8gYmUgY2hlY2tlZC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gZSAtIFRoZSBzdGFydCBvZiB0aGUgc2Vjb25kIExpbmUgdG8gYmUgY2hlY2tlZC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gZiAtIFRoZSBlbmQgb2YgdGhlIHNlY29uZCBsaW5lIHRvIGJlIGNoZWNrZWQuCiogQHBhcmFtIHtib29sZWFufSBbYXNTZWdtZW50PXRydWVdIC0gSWYgdHJ1ZSBpdCB3aWxsIGNoZWNrIGZvciBzZWdtZW50IGludGVyc2VjdGlvbiwgb3RoZXJ3aXNlIGZ1bGwgbGluZSBpbnRlcnNlY3Rpb24uCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtyZXN1bHRdIC0gQSBQb2ludCBvYmplY3QgdG8gc3RvcmUgdGhlIHJlc3VsdCBpbiwgaWYgbm90IGdpdmVuIGEgbmV3IG9uZSB3aWxsIGJlIGNyZWF0ZWQuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgaW50ZXJzZWN0aW9uIHNlZ21lbnQgb2YgdGhlIHR3byBsaW5lcyBhcyBhIFBvaW50LCBvciBudWxsIGlmIHRoZXJlIGlzIG5vIGludGVyc2VjdGlvbi4KKi8KUGhhc2VyLkxpbmUuaW50ZXJzZWN0c1BvaW50cyA9IGZ1bmN0aW9uIChhLCBiLCBlLCBmLCBhc1NlZ21lbnQsIHJlc3VsdCkgewoKICAgIGlmICh0eXBlb2YgYXNTZWdtZW50ID09PSAndW5kZWZpbmVkJykgeyBhc1NlZ21lbnQgPSB0cnVlOyB9CiAgICBpZiAodHlwZW9mIHJlc3VsdCA9PT0gJ3VuZGVmaW5lZCcpIHsgcmVzdWx0ID0gbmV3IFBoYXNlci5Qb2ludCgpOyB9CgogICAgdmFyIGExID0gYi55IC0gYS55OwogICAgdmFyIGEyID0gZi55IC0gZS55OwogICAgdmFyIGIxID0gYS54IC0gYi54OwogICAgdmFyIGIyID0gZS54IC0gZi54OwogICAgdmFyIGMxID0gKGIueCAqIGEueSkgLSAoYS54ICogYi55KTsKICAgIHZhciBjMiA9IChmLnggKiBlLnkpIC0gKGUueCAqIGYueSk7CiAgICB2YXIgZGVub20gPSAoYTEgKiBiMikgLSAoYTIgKiBiMSk7CgogICAgaWYgKGRlbm9tID09PSAwKQogICAgewogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIHJlc3VsdC54ID0gKChiMSAqIGMyKSAtIChiMiAqIGMxKSkgLyBkZW5vbTsKICAgIHJlc3VsdC55ID0gKChhMiAqIGMxKSAtIChhMSAqIGMyKSkgLyBkZW5vbTsKIAogICAgaWYgKGFzU2VnbWVudCkKICAgIHsKICAgICAgICBpZiAoTWF0aC5wb3coKHJlc3VsdC54IC0gYi54KSArIChyZXN1bHQueSAtIGIueSksIDIpID4gTWF0aC5wb3coKGEueCAtIGIueCkgKyAoYS55IC0gYi55KSwgMikpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChNYXRoLnBvdygocmVzdWx0LnggLSBhLngpICsgKHJlc3VsdC55IC0gYS55KSwgMikgPiBNYXRoLnBvdygoYS54IC0gYi54KSArIChhLnkgLSBiLnkpLCAyKSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKE1hdGgucG93KChyZXN1bHQueCAtIGYueCkgKyAocmVzdWx0LnkgLSBmLnkpLCAyKSA+IE1hdGgucG93KChlLnggLSBmLngpICsgKGUueSAtIGYueSksIDIpKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAoTWF0aC5wb3coKHJlc3VsdC54IC0gZS54KSArIChyZXN1bHQueSAtIGUueSksIDIpID4gTWF0aC5wb3coKGUueCAtIGYueCkgKyAoZS55IC0gZi55KSwgMikpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKCn07CgovKioKKiBDaGVja3MgZm9yIGludGVyc2VjdGlvbiBiZXR3ZWVuIHR3byBsaW5lcy4KKiBJZiBhc1NlZ21lbnQgaXMgdHJ1ZSBpdCB3aWxsIGNoZWNrIGZvciBzZWdtZW50IGludGVyc2VjdGlvbi4KKiBJZiBhc1NlZ21lbnQgaXMgZmFsc2UgaXQgd2lsbCBjaGVjayBmb3IgbGluZSBpbnRlcnNlY3Rpb24uCiogUmV0dXJucyB0aGUgaW50ZXJzZWN0aW9uIHNlZ21lbnQgb2YgQUIgYW5kIEVGIGFzIGEgUG9pbnQsIG9yIG51bGwgaWYgdGhlcmUgaXMgbm8gaW50ZXJzZWN0aW9uLgoqIEFkYXB0ZWQgZnJvbSBjb2RlIGJ5IEtlaXRoIEhhaXIKKgoqIEBtZXRob2QgUGhhc2VyLkxpbmUuaW50ZXJzZWN0cwoqIEBwYXJhbSB7UGhhc2VyLkxpbmV9IGEgLSBUaGUgZmlyc3QgTGluZSB0byBiZSBjaGVja2VkLgoqIEBwYXJhbSB7UGhhc2VyLkxpbmV9IGIgLSBUaGUgc2Vjb25kIExpbmUgdG8gYmUgY2hlY2tlZC4KKiBAcGFyYW0ge2Jvb2xlYW59IFthc1NlZ21lbnQ9dHJ1ZV0gLSBJZiB0cnVlIGl0IHdpbGwgY2hlY2sgZm9yIHNlZ21lbnQgaW50ZXJzZWN0aW9uLCBvdGhlcndpc2UgZnVsbCBsaW5lIGludGVyc2VjdGlvbi4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW3Jlc3VsdF0gLSBBIFBvaW50IG9iamVjdCB0byBzdG9yZSB0aGUgcmVzdWx0IGluLCBpZiBub3QgZ2l2ZW4gYSBuZXcgb25lIHdpbGwgYmUgY3JlYXRlZC4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBpbnRlcnNlY3Rpb24gc2VnbWVudCBvZiB0aGUgdHdvIGxpbmVzIGFzIGEgUG9pbnQsIG9yIG51bGwgaWYgdGhlcmUgaXMgbm8gaW50ZXJzZWN0aW9uLgoqLwpQaGFzZXIuTGluZS5pbnRlcnNlY3RzID0gZnVuY3Rpb24gKGEsIGIsIGFzU2VnbWVudCwgcmVzdWx0KSB7CgogICAgcmV0dXJuIFBoYXNlci5MaW5lLmludGVyc2VjdHNQb2ludHMoYS5zdGFydCwgYS5lbmQsIGIuc3RhcnQsIGIuZW5kLCBhc1NlZ21lbnQsIHJlc3VsdCk7Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLk5ldCBoYW5kbGVzIGJyb3dzZXIgVVJMIHJlbGF0ZWQgdGFza3Mgc3VjaCBhcyBjaGVja2luZyBob3N0IG5hbWVzLCBkb21haW4gbmFtZXMgYW5kIHF1ZXJ5IHN0cmluZyBtYW5pcHVsYXRpb24uCioKKiBAY2xhc3MgUGhhc2VyLk5ldAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLk5ldCA9IGZ1bmN0aW9uIChnYW1lKSB7CiAgICAKICAgIHRoaXMuZ2FtZSA9IGdhbWU7Cgp9OwoKUGhhc2VyLk5ldC5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIGhvc3RuYW1lIGdpdmVuIGJ5IHRoZSBicm93c2VyLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTmV0I2dldEhvc3ROYW1lCiAgICAqIEByZXR1cm4ge3N0cmluZ30KICAgICovCiAgICBnZXRIb3N0TmFtZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAod2luZG93LmxvY2F0aW9uICYmIHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZSkgewogICAgICAgICAgICByZXR1cm4gd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogQ29tcGFyZXMgdGhlIGdpdmVuIGRvbWFpbiBuYW1lIGFnYWluc3QgdGhlIGhvc3RuYW1lIG9mIHRoZSBicm93c2VyIGNvbnRhaW5pbmcgdGhlIGdhbWUuCiAgICAqIElmIHRoZSBkb21haW4gbmFtZSBpcyBmb3VuZCBpdCByZXR1cm5zIHRydWUuCiAgICAqIFlvdSBjYW4gc3BlY2lmeSBhIHBhcnQgb2YgYSBkb21haW4sIGZvciBleGFtcGxlICdnb29nbGUnIHdvdWxkIG1hdGNoICdnb29nbGUuY29tJywgJ2dvb2dsZS5jby51aycsIGV0Yy4KICAgICogRG8gbm90IGluY2x1ZGUgJ2h0dHA6Ly8nIGF0IHRoZSBzdGFydC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk5ldCNjaGVja0RvbWFpbk5hbWUKICAgICogQHBhcmFtIHtzdHJpbmd9IGRvbWFpbgogICAgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHRoZSBnaXZlbiBkb21haW4gZnJhZ21lbnQgY2FuIGJlIGZvdW5kIGluIHRoZSB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWUKICAgICovCiAgICBjaGVja0RvbWFpbk5hbWU6IGZ1bmN0aW9uIChkb21haW4pIHsKICAgICAgICByZXR1cm4gd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lLmluZGV4T2YoZG9tYWluKSAhPT0gLTE7CiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGVzIGEgdmFsdWUgb24gdGhlIFF1ZXJ5IFN0cmluZyBhbmQgcmV0dXJucyBpdCBpbiBmdWxsLgogICAgKiBJZiB0aGUgdmFsdWUgZG9lc24ndCBhbHJlYWR5IGV4aXN0IGl0IGlzIHNldC4KICAgICogSWYgdGhlIHZhbHVlIGV4aXN0cyBpdCBpcyByZXBsYWNlZCB3aXRoIHRoZSBuZXcgdmFsdWUgZ2l2ZW4uIElmIHlvdSBkb24ndCBwcm92aWRlIGEgbmV3IHZhbHVlIGl0IGlzIHJlbW92ZWQgZnJvbSB0aGUgcXVlcnkgc3RyaW5nLgogICAgKiBPcHRpb25hbGx5IHlvdSBjYW4gcmVkaXJlY3QgdG8gdGhlIG5ldyB1cmwsIG9yIGp1c3QgcmV0dXJuIGl0IGFzIGEgc3RyaW5nLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTmV0I3VwZGF0ZVF1ZXJ5U3RyaW5nCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgcXVlcnlzdHJpbmcga2V5IHRvIHVwZGF0ZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIC0gVGhlIG5ldyB2YWx1ZSB0byBiZSBzZXQuIElmIGl0IGFscmVhZHkgZXhpc3RzIGl0IHdpbGwgYmUgcmVwbGFjZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gcmVkaXJlY3QgLSBJZiB0cnVlIHRoZSBicm93c2VyIHdpbGwgaXNzdWUgYSByZWRpcmVjdCB0byB0aGUgdXJsIHdpdGggdGhlIG5ldyBxdWVyeXN0cmluZy4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFRoZSBVUkwgdG8gbW9kaWZ5LiBJZiBub25lIGlzIGdpdmVuIGl0IHVzZXMgd2luZG93LmxvY2F0aW9uLmhyZWYuCiAgICAqIEByZXR1cm4ge3N0cmluZ30gSWYgcmVkaXJlY3QgaXMgZmFsc2UgdGhlbiB0aGUgbW9kaWZpZWQgdXJsIGFuZCBxdWVyeSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAgICAqLwogICAgdXBkYXRlUXVlcnlTdHJpbmc6IGZ1bmN0aW9uIChrZXksIHZhbHVlLCByZWRpcmVjdCwgdXJsKSB7CgogICAgICAgIGlmICh0eXBlb2YgcmVkaXJlY3QgPT09ICJ1bmRlZmluZWQiKSB7IHJlZGlyZWN0ID0gZmFsc2U7IH0KICAgICAgICBpZiAodHlwZW9mIHVybCA9PT0gInVuZGVmaW5lZCIgfHwgdXJsID09PSAnJykgeyB1cmwgPSB3aW5kb3cubG9jYXRpb24uaHJlZjsgfQoKICAgICAgICB2YXIgb3V0cHV0ID0gJyc7CiAgICAgICAgdmFyIHJlID0gbmV3IFJlZ0V4cCgiKFs/fCZdKSIgKyBrZXkgKyAiPS4qPygmfCN8JCkoLiopIiwgImdpIik7CiAgICAgICAgCiAgICAgICAgaWYgKHJlLnRlc3QodXJsKSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnICYmIHZhbHVlICE9PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvdXRwdXQgPSB1cmwucmVwbGFjZShyZSwgJyQxJyArIGtleSArICI9IiArIHZhbHVlICsgJyQyJDMnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG91dHB1dCA9IHVybC5yZXBsYWNlKHJlLCAnJDEkMycpLnJlcGxhY2UoLygmfFw/KSQvLCAnJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgIT09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBzZXBhcmF0b3IgPSB1cmwuaW5kZXhPZignPycpICE9PSAtMSA/ICcmJyA6ICc/JzsKICAgICAgICAgICAgICAgIHZhciBoYXNoID0gdXJsLnNwbGl0KCcjJyk7CiAgICAgICAgICAgICAgICB1cmwgPSBoYXNoWzBdICsgc2VwYXJhdG9yICsga2V5ICsgJz0nICsgdmFsdWU7CgogICAgICAgICAgICAgICAgaWYgKGhhc2hbMV0pIHsKICAgICAgICAgICAgICAgICAgICB1cmwgKz0gJyMnICsgaGFzaFsxXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBvdXRwdXQgPSB1cmw7CgogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3V0cHV0ID0gdXJsOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAocmVkaXJlY3QpCiAgICAgICAgewogICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IG91dHB1dDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgUXVlcnkgU3RyaW5nIGFzIGFuIG9iamVjdC4KICAgICogSWYgeW91IHNwZWNpZnkgYSBwYXJhbWV0ZXIgaXQgd2lsbCByZXR1cm4ganVzdCB0aGUgdmFsdWUgb2YgdGhhdCBwYXJhbWV0ZXIsIHNob3VsZCBpdCBleGlzdC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk5ldCNnZXRRdWVyeVN0cmluZwogICAgKiBAcGFyYW0ge3N0cmluZ30gW3BhcmFtZXRlcj0nJ10gLSBJZiBzcGVjaWZpZWQgdGhpcyB3aWxsIHJldHVybiBqdXN0IHRoZSB2YWx1ZSBmb3IgdGhhdCBrZXkuCiAgICAqIEByZXR1cm4ge3N0cmluZ3xvYmplY3R9IEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBrZXkgdmFsdWUgcGFpcnMgZm91bmQgaW4gdGhlIHF1ZXJ5IHN0cmluZyBvciBqdXN0IHRoZSB2YWx1ZSBpZiBhIHBhcmFtZXRlciB3YXMgZ2l2ZW4uCiAgICAqLwogICAgZ2V0UXVlcnlTdHJpbmc6IGZ1bmN0aW9uIChwYXJhbWV0ZXIpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBwYXJhbWV0ZXIgPT09ICJ1bmRlZmluZWQiKSB7IHBhcmFtZXRlciA9ICcnOyB9CgogICAgICAgIHZhciBvdXRwdXQgPSB7fTsKICAgICAgICB2YXIga2V5VmFsdWVzID0gbG9jYXRpb24uc2VhcmNoLnN1YnN0cmluZygxKS5zcGxpdCgnJicpOwoKICAgICAgICBmb3IgKHZhciBpIGluIGtleVZhbHVlcykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBrZXkgPSBrZXlWYWx1ZXNbaV0uc3BsaXQoJz0nKTsKCiAgICAgICAgICAgIGlmIChrZXkubGVuZ3RoID4gMSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHBhcmFtZXRlciAmJiBwYXJhbWV0ZXIgPT0gdGhpcy5kZWNvZGVVUkkoa2V5WzBdKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kZWNvZGVVUkkoa2V5WzFdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBvdXRwdXRbdGhpcy5kZWNvZGVVUkkoa2V5WzBdKV0gPSB0aGlzLmRlY29kZVVSSShrZXlbMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gb3V0cHV0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIFF1ZXJ5IFN0cmluZyBhcyBhbiBvYmplY3QuCiAgICAqIElmIHlvdSBzcGVjaWZ5IGEgcGFyYW1ldGVyIGl0IHdpbGwgcmV0dXJuIGp1c3QgdGhlIHZhbHVlIG9mIHRoYXQgcGFyYW1ldGVyLCBzaG91bGQgaXQgZXhpc3QuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5OZXQjZGVjb2RlVVJJCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSAtIFRoZSBVUkkgY29tcG9uZW50IHRvIGJlIGRlY29kZWQuCiAgICAqIEByZXR1cm4ge3N0cmluZ30gVGhlIGRlY29kZWQgdmFsdWUuCiAgICAqLwogICAgZGVjb2RlVVJJOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlLnJlcGxhY2UoL1wrL2csICIgIikpOwogICAgfQoKfTsKClBoYXNlci5OZXQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLk5ldDsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlciAtIFR3ZWVuTWFuYWdlcgoqIAoqIEBjbGFzcyBQaGFzZXIuVHdlZW5NYW5hZ2VyCiogQGNsYXNzZGVzYyAKKiBQaGFzZXIuR2FtZSBoYXMgYSBzaW5nbGUgaW5zdGFuY2Ugb2YgdGhlIFR3ZWVuTWFuYWdlciB0aHJvdWdoIHdoaWNoIGFsbCBUd2VlbiBvYmplY3RzIGFyZSBjcmVhdGVkIGFuZCB1cGRhdGVkLgoqIFR3ZWVucyBhcmUgaG9va2VkIGludG8gdGhlIGdhbWUgY2xvY2sgYW5kIHBhdXNlIHN5c3RlbSwgYWRqdXN0aW5nIGJhc2VkIG9uIHRoZSBnYW1lIHN0YXRlLgoqCiogVHdlZW5NYW5hZ2VyIGlzIGJhc2VkIGhlYXZpbHkgb24gdHdlZW4uanMgYnkgaHR0cDovL3NvbGVkYWRwZW5hZGVzLmNvbS4KKiBUaGUgZGlmZmVyZW5jZSBiZWluZyB0aGF0IHR3ZWVucyBiZWxvbmcgdG8gYSBnYW1lcyBpbnN0YW5jZSBvZiBUd2Vlbk1hbmFnZXIsIHJhdGhlciB0aGFuIHRvIGEgZ2xvYmFsIFRXRUVOIG9iamVjdC4KKiBJdCBhbHNvIGhhcyBjYWxsYmFja3Mgc3dhcHBlZCBmb3IgU2lnbmFscyBhbmQgYSBmZXcgaXNzdWVzIHBhdGNoZWQgd2l0aCByZWdhcmQgdG8gcHJvcGVydGllcyBhbmQgY29tcGxldGlvbiBlcnJvcnMuCiogUGxlYXNlIHNlZSBodHRwczovL2dpdGh1Yi5jb20vc29sZS90d2Vlbi5qcyBmb3IgYSBmdWxsIGxpc3Qgb2YgY29udHJpYnV0b3JzLgoqIEBjb25zdHJ1Y3RvcgoqCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuVHdlZW5NYW5hZ2VyID0gZnVuY3Rpb24gKGdhbWUpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5PFBoYXNlci5Ud2Vlbj59IF90d2VlbnMgLSBBbGwgb2YgdGhlIGN1cnJlbnRseSBydW5uaW5nIHR3ZWVucy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90d2VlbnMgPSBbXTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXk8UGhhc2VyLlR3ZWVuPn0gX2FkZCAtIEFsbCBvZiB0aGUgdHdlZW5zIHF1ZXVlZCB0byBiZSBhZGRlZCBpbiB0aGUgbmV4dCB1cGRhdGUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fYWRkID0gW107CgogICAgdGhpcy5nYW1lLm9uUGF1c2UuYWRkKHRoaXMucGF1c2VBbGwsIHRoaXMpOwogICAgdGhpcy5nYW1lLm9uUmVzdW1lLmFkZCh0aGlzLnJlc3VtZUFsbCwgdGhpcyk7Cgp9OwoKUGhhc2VyLlR3ZWVuTWFuYWdlci5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEdldCBhbGwgdGhlIHR3ZWVuIG9iamVjdHMgaW4gYW4gYXJyYXkuCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciNnZXRBbGwKICAgICogQHJldHVybnMge1BoYXNlci5Ud2VlbltdfSBBcnJheSB3aXRoIGFsbCB0d2VlbiBvYmplY3RzLgogICAgKi8KICAgIGdldEFsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4gdGhpcy5fdHdlZW5zOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZSBhbGwgdHdlZW5zIHJ1bm5pbmcgYW5kIGluIHRoZSBxdWV1ZS4gRG9lc24ndCBjYWxsIGFueSBvZiB0aGUgdHdlZW4gb25Db21wbGV0ZSBldmVudHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciNyZW1vdmVBbGwKICAgICovCiAgICByZW1vdmVBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl90d2VlbnMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl90d2VlbnNbaV0ucGVuZGluZ0RlbGV0ZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9hZGQgPSBbXTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgdHdlZW4gaW50byB0aGUgVHdlZW5NYW5hZ2VyLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Ud2Vlbk1hbmFnZXIjYWRkCiAgICAqIEBwYXJhbSB7UGhhc2VyLlR3ZWVufSB0d2VlbiAtIFRoZSB0d2VlbiBvYmplY3QgeW91IHdhbnQgdG8gYWRkLgogICAgKiBAcmV0dXJucyB7UGhhc2VyLlR3ZWVufSBUaGUgdHdlZW4gb2JqZWN0IHlvdSBhZGRlZCB0byB0aGUgbWFuYWdlci4KICAgICovCiAgICBhZGQ6IGZ1bmN0aW9uICh0d2VlbikgewoKICAgICAgICB0aGlzLl9hZGQucHVzaCh0d2Vlbik7CgogICAgfSwKCiAgICAvKioKICAgICogQ3JlYXRlIGEgdHdlZW4gb2JqZWN0IGZvciBhIHNwZWNpZmljIG9iamVjdC4gVGhlIG9iamVjdCBjYW4gYmUgYW55IEphdmFTY3JpcHQgb2JqZWN0IG9yIFBoYXNlciBvYmplY3Qgc3VjaCBhcyBTcHJpdGUuIAogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Ud2Vlbk1hbmFnZXIjY3JlYXRlCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgLSBPYmplY3QgdGhlIHR3ZWVuIHdpbGwgYmUgcnVuIG9uLgogICAgKiBAcmV0dXJucyB7UGhhc2VyLlR3ZWVufSBUaGUgbmV3bHkgY3JlYXRlZCB0d2VlbiBvYmplY3QuCiAgICAqLwogICAgY3JlYXRlOiBmdW5jdGlvbiAob2JqZWN0KSB7CgogICAgICAgIHJldHVybiBuZXcgUGhhc2VyLlR3ZWVuKG9iamVjdCwgdGhpcy5nYW1lKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmUgYSB0d2VlbiBmcm9tIHRoaXMgbWFuYWdlci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW5NYW5hZ2VyI3JlbW92ZQogICAgKiBAcGFyYW0ge1BoYXNlci5Ud2Vlbn0gdHdlZW4gLSBUaGUgdHdlZW4gb2JqZWN0IHlvdSB3YW50IHRvIHJlbW92ZS4KICAgICovCiAgICByZW1vdmU6IGZ1bmN0aW9uICh0d2VlbikgewoKICAgICAgICB2YXIgaSA9IHRoaXMuX3R3ZWVucy5pbmRleE9mKHR3ZWVuKTsKCiAgICAgICAgaWYgKGkgIT09IC0xKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fdHdlZW5zW2ldLnBlbmRpbmdEZWxldGUgPSB0cnVlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGUgYWxsIHRoZSB0d2VlbiBvYmplY3RzIHlvdSBhZGRlZCB0byB0aGlzIG1hbmFnZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciN1cGRhdGUKICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybiBmYWxzZSBpZiB0aGVyZSdzIG5vIHR3ZWVuIHRvIHVwZGF0ZSwgb3RoZXJ3aXNlIHJldHVybiB0cnVlLgogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fdHdlZW5zLmxlbmd0aCA9PT0gMCAmJiB0aGlzLl9hZGQubGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdmFyIGkgPSAwOwogICAgICAgIHZhciBudW1Ud2VlbnMgPSB0aGlzLl90d2VlbnMubGVuZ3RoOwoKICAgICAgICB3aGlsZSAoaSA8IG51bVR3ZWVucykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl90d2VlbnNbaV0udXBkYXRlKHRoaXMuZ2FtZS50aW1lLm5vdykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3R3ZWVucy5zcGxpY2UoaSwgMSk7CgogICAgICAgICAgICAgICAgbnVtVHdlZW5zLS07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vICBJZiB0aGVyZSBhcmUgYW55IG5ldyB0d2VlbnMgdG8gYmUgYWRkZWQsIGRvIHNvIG5vdyAtIG90aGVyd2lzZSB0aGV5IGNhbiBiZSBzcGxpY2VkIG91dCBvZiB0aGUgYXJyYXkgYmVmb3JlIGV2ZXIgcnVubmluZwogICAgICAgIGlmICh0aGlzLl9hZGQubGVuZ3RoID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3R3ZWVucyA9IHRoaXMuX3R3ZWVucy5jb25jYXQodGhpcy5fYWRkKTsKICAgICAgICAgICAgdGhpcy5fYWRkLmxlbmd0aCA9IDA7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgdG8gc2VlIGlmIGEgcGFydGljdWxhciBTcHJpdGUgaXMgY3VycmVudGx5IGJlaW5nIHR3ZWVuZWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciNpc1R3ZWVuaW5nCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBvYmplY3QgLSBUaGUgb2JqZWN0IHRvIGNoZWNrIGZvciB0d2VlbnMgYWdhaW5zdC4KICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB0aGUgb2JqZWN0IGlzIGN1cnJlbnRseSBiZWluZyB0d2VlbmVkLCBmYWxzZSBpZiBub3QuCiAgICAqLwogICAgaXNUd2VlbmluZzogZnVuY3Rpb24ob2JqZWN0KSB7CgogICAgICAgIHJldHVybiB0aGlzLl90d2VlbnMuc29tZShmdW5jdGlvbih0d2VlbikgewogICAgICAgICAgICByZXR1cm4gdHdlZW4uX29iamVjdCA9PT0gb2JqZWN0OwogICAgICAgIH0pOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFBhdXNlcyBhbGwgY3VycmVudGx5IHJ1bm5pbmcgdHdlZW5zLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Ud2Vlbk1hbmFnZXIjdXBkYXRlCiAgICAqLwogICAgcGF1c2VBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuX3R3ZWVucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3R3ZWVuc1tpXS5wYXVzZSgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXVzZXMgYWxsIGN1cnJlbnRseSBwYXVzZWQgdHdlZW5zLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Ud2Vlbk1hbmFnZXIjcmVzdW1lQWxsCiAgICAqLwogICAgcmVzdW1lQWxsOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLl90d2VlbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl90d2VlbnNbaV0ucmVzdW1lKCk7CiAgICAgICAgfQoKICAgIH0KCn07CgpQaGFzZXIuVHdlZW5NYW5hZ2VyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5Ud2Vlbk1hbmFnZXI7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBUd2VlbiBjb25zdHJ1Y3RvcgoqIENyZWF0ZSBhIG5ldyA8Y29kZT5Ud2VlbjwvY29kZT4uCioKKiBAY2xhc3MgUGhhc2VyLlR3ZWVuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtvYmplY3R9IG9iamVjdCAtIFRhcmdldCBvYmplY3Qgd2lsbCBiZSBhZmZlY3RlZCBieSB0aGlzIHR3ZWVuLgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBDdXJyZW50IGdhbWUgaW5zdGFuY2UuCiovClBoYXNlci5Ud2VlbiA9IGZ1bmN0aW9uIChvYmplY3QsIGdhbWUpIHsKCiAgICAvKioKICAgICogUmVmZXJlbmNlIHRvIHRoZSB0YXJnZXQgb2JqZWN0LgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX29iamVjdAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29iamVjdCA9IG9iamVjdDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlR3ZWVuTWFuYWdlcn0gX21hbmFnZXIgLSBSZWZlcmVuY2UgdG8gdGhlIFR3ZWVuTWFuYWdlci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9tYW5hZ2VyID0gdGhpcy5nYW1lLnR3ZWVuczsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF92YWx1ZXNTdGFydCAtIFByaXZhdGUgdmFsdWUgb2JqZWN0LgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3ZhbHVlc1N0YXJ0ID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfdmFsdWVzRW5kIC0gUHJpdmF0ZSB2YWx1ZSBvYmplY3QuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdmFsdWVzRW5kID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfdmFsdWVzU3RhcnRSZXBlYXQgLSBQcml2YXRlIHZhbHVlIG9iamVjdC4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl92YWx1ZXNTdGFydFJlcGVhdCA9IHt9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R1cmF0aW9uIC0gUHJpdmF0ZSBkdXJhdGlvbiBjb3VudGVyLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX2R1cmF0aW9uID0gMTAwMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9yZXBlYXQgLSBQcml2YXRlIHJlcGVhdCBjb3VudGVyLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3JlcGVhdCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX3lveW8gLSBQcml2YXRlIHlveW8gZmxhZy4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl95b3lvID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX3JldmVyc2VkIC0gUHJpdmF0ZSByZXZlcnNlZCBmbGFnLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3JldmVyc2VkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZGVsYXlUaW1lIC0gUHJpdmF0ZSBkZWxheSBjb3VudGVyLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX2RlbGF5VGltZSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfc3RhcnRUaW1lIC0gUHJpdmF0ZSBzdGFydCB0aW1lIGNvdW50ZXIuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0IG51bGwKICAgICovCiAgICB0aGlzLl9zdGFydFRpbWUgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfZWFzaW5nRnVuY3Rpb24gLSBUaGUgZWFzaW5nIGZ1bmN0aW9uIHVzZWQgZm9yIHRoZSB0d2Vlbi4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9lYXNpbmdGdW5jdGlvbiA9IFBoYXNlci5FYXNpbmcuTGluZWFyLk5vbmU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9pbnRlcnBvbGF0aW9uRnVuY3Rpb24gLSBUaGUgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbiB1c2VkIGZvciB0aGUgdHdlZW4uCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5faW50ZXJwb2xhdGlvbkZ1bmN0aW9uID0gUGhhc2VyLk1hdGgubGluZWFySW50ZXJwb2xhdGlvbjsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gX2NoYWluZWRUd2VlbnMgLSBBIHByaXZhdGUgYXJyYXkgb2YgY2hhaW5lZCB0d2VlbnMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fY2hhaW5lZFR3ZWVucyA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9vblN0YXJ0Q2FsbGJhY2tGaXJlZCAtIFByaXZhdGUgZmxhZy4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9vblN0YXJ0Q2FsbGJhY2tGaXJlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25VcGRhdGVDYWxsYmFjayAtIEFuIG9uVXBkYXRlIGNhbGxiYWNrLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdCBudWxsCiAgICAqLwogICAgdGhpcy5fb25VcGRhdGVDYWxsYmFjayA9IG51bGw7CiAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfb25VcGRhdGVDYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0byBjYWxsIHRoZSBvblVwZGF0ZSBjYWxsYmFjay4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQgbnVsbAogICAgKi8KICAgIHRoaXMuX29uVXBkYXRlQ2FsbGJhY2tDb250ZXh0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9wYXVzZWRUaW1lIC0gUHJpdmF0ZSBwYXVzZSB0aW1lci4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9wYXVzZWRUaW1lID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBwZW5kaW5nRGVsZXRlIC0gSWYgdGhpcyB0d2VlbiBpcyByZWFkeSB0byBiZSBkZWxldGVkIGJ5IHRoZSBUd2Vlbk1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wZW5kaW5nRGVsZXRlID0gZmFsc2U7CgogICAgLy8gU2V0IGFsbCBzdGFydGluZyB2YWx1ZXMgcHJlc2VudCBvbiB0aGUgdGFyZ2V0IG9iamVjdAogICAgZm9yICh2YXIgZmllbGQgaW4gb2JqZWN0KQogICAgewogICAgICAgIHRoaXMuX3ZhbHVlc1N0YXJ0W2ZpZWxkXSA9IHBhcnNlRmxvYXQob2JqZWN0W2ZpZWxkXSwgMTApOwogICAgfQogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvblN0YXJ0IC0gVGhlIG9uU3RhcnQgZXZlbnQgaXMgZmlyZWQgd2hlbiB0aGUgVHdlZW4gYmVnaW5zLgogICAgKi8KICAgIHRoaXMub25TdGFydCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Mb29wIC0gVGhlIG9uTG9vcCBldmVudCBpcyBmaXJlZCBpZiB0aGUgVHdlZW4gbG9vcHMuCiAgICAqLwogICAgdGhpcy5vbkxvb3AgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uQ29tcGxldGUgLSBUaGUgb25Db21wbGV0ZSBldmVudCBpcyBmaXJlZCB3aGVuIHRoZSBUd2VlbiBjb21wbGV0ZXMuIERvZXMgbm90IGZpcmUgaWYgdGhlIFR3ZWVuIGlzIHNldCB0byBsb29wLgogICAgKi8KICAgIHRoaXMub25Db21wbGV0ZSA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNSdW5uaW5nIC0gSWYgdGhlIHR3ZWVuIGlzIHJ1bm5pbmcgdGhpcyBpcyBzZXQgdG8gdHJ1ZSwgb3RoZXJ3aXNlIGZhbHNlLiBUd2VlbnMgdGhhdCBhcmUgaW4gYSBkZWxheWVkIHN0YXRlLCB3YWl0aW5nIHRvIHN0YXJ0LCBhcmUgY29uc2lkZXJlZCBhcyBiZWluZyBydW5uaW5nLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNSdW5uaW5nID0gZmFsc2U7Cgp9OwoKUGhhc2VyLlR3ZWVuLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQ29uZmlndXJlIHRoZSBUd2VlbgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiN0bwogICAgKiBAcGFyYW0ge29iamVjdH0gcHJvcGVydGllcyAtIFByb3BlcnRpZXMgeW91IHdhbnQgdG8gdHdlZW4uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZHVyYXRpb249MTAwMF0gLSBEdXJhdGlvbiBvZiB0aGlzIHR3ZWVuIGluIG1zLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbZWFzZT1udWxsXSAtIEVhc2luZyBmdW5jdGlvbi4gSWYgbm90IHNldCBpdCB3aWxsIGRlZmF1bHQgdG8gUGhhc2VyLkVhc2luZy5MaW5lYXIuTm9uZS4KICAgICogQHBhcmFtIHtib29sZWFufSBbYXV0b1N0YXJ0PWZhbHNlXSAtIFdoZXRoZXIgdGhpcyB0d2VlbiB3aWxsIHN0YXJ0IGF1dG9tYXRpY2FsbHkgb3Igbm90LgogICAgKiBAcGFyYW0ge251bWJlcn0gW2RlbGF5PTBdIC0gRGVsYXkgYmVmb3JlIHRoaXMgdHdlZW4gd2lsbCBzdGFydCwgZGVmYXVsdHMgdG8gMCAobm8gZGVsYXkpLiBWYWx1ZSBnaXZlbiBpcyBpbiBtcy4KICAgICogQHBhcmFtIHtib29sZWFufSBbcmVwZWF0PTBdIC0gU2hvdWxkIHRoZSB0d2VlbiBhdXRvbWF0aWNhbGx5IHJlc3RhcnQgb25jZSBjb21wbGV0ZT8gKGlnbm9yZXMgYW55IGNoYWluZWQgdHdlZW5zKS4KICAgICogQHBhcmFtIHtib29sZWFufSBbeW95bz1mYWxzZV0gLSBBIHR3ZWVuIHRoYXQgeW95b3Mgd2lsbCByZXZlcnNlIGl0c2VsZiB3aGVuIGl0IGNvbXBsZXRlcy4KICAgICogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBUaGlzIFR3ZWVuIG9iamVjdC4KICAgICovCiAgICB0bzogZnVuY3Rpb24gKHByb3BlcnRpZXMsIGR1cmF0aW9uLCBlYXNlLCBhdXRvU3RhcnQsIGRlbGF5LCByZXBlYXQsIHlveW8pIHsKCiAgICAgICAgZHVyYXRpb24gPSBkdXJhdGlvbiB8fCAxMDAwOwogICAgICAgIGVhc2UgPSBlYXNlIHx8IG51bGw7CiAgICAgICAgYXV0b1N0YXJ0ID0gYXV0b1N0YXJ0IHx8IGZhbHNlOwogICAgICAgIGRlbGF5ID0gZGVsYXkgfHwgMDsKICAgICAgICByZXBlYXQgPSByZXBlYXQgfHwgMDsKICAgICAgICB5b3lvID0geW95byB8fCBmYWxzZTsKCiAgICAgICAgdmFyIHNlbGY7CgogICAgICAgIGlmICh0aGlzLl9wYXJlbnQpCiAgICAgICAgewogICAgICAgICAgICBzZWxmID0gdGhpcy5fbWFuYWdlci5jcmVhdGUodGhpcy5fb2JqZWN0KTsKICAgICAgICAgICAgdGhpcy5fbGFzdENoaWxkLmNoYWluKHNlbGYpOwogICAgICAgICAgICB0aGlzLl9sYXN0Q2hpbGQgPSBzZWxmOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBzZWxmID0gdGhpczsKICAgICAgICAgICAgdGhpcy5fcGFyZW50ID0gdGhpczsKICAgICAgICAgICAgdGhpcy5fbGFzdENoaWxkID0gdGhpczsKICAgICAgICB9CgogICAgICAgIHNlbGYuX3JlcGVhdCA9IHJlcGVhdDsKICAgICAgICBzZWxmLl9kdXJhdGlvbiA9IGR1cmF0aW9uOwogICAgICAgIHNlbGYuX3ZhbHVlc0VuZCA9IHByb3BlcnRpZXM7CgogICAgICAgIGlmIChlYXNlICE9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgc2VsZi5fZWFzaW5nRnVuY3Rpb24gPSBlYXNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRlbGF5ID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHNlbGYuX2RlbGF5VGltZSA9IGRlbGF5OwogICAgICAgIH0KCiAgICAgICAgc2VsZi5feW95byA9IHlveW87CgogICAgICAgIGlmIChhdXRvU3RhcnQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zdGFydCgpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU3RhcnRzIHRoZSB0d2VlbiBydW5uaW5nLiBDYW4gYWxzbyBiZSBjYWxsZWQgYnkgdGhlIGF1dG9TdGFydCBwYXJhbWV0ZXIgb2YgVHdlZW4udG8uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI3N0YXJ0CiAgICAqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUgPT09IG51bGwgfHwgdGhpcy5fb2JqZWN0ID09PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fbWFuYWdlci5hZGQodGhpcyk7CgogICAgICAgIHRoaXMuaXNSdW5uaW5nID0gdHJ1ZTsKCiAgICAgICAgdGhpcy5fb25TdGFydENhbGxiYWNrRmlyZWQgPSBmYWxzZTsKCiAgICAgICAgdGhpcy5fc3RhcnRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93ICsgdGhpcy5fZGVsYXlUaW1lOwoKICAgICAgICBmb3IgKHZhciBwcm9wZXJ0eSBpbiB0aGlzLl92YWx1ZXNFbmQpCiAgICAgICAgewogICAgICAgICAgICAvLyBjaGVjayBpZiBhbiBBcnJheSB3YXMgcHJvdmlkZWQgYXMgcHJvcGVydHkgdmFsdWUKICAgICAgICAgICAgaWYgKHRoaXMuX3ZhbHVlc0VuZFtwcm9wZXJ0eV0gaW5zdGFuY2VvZiBBcnJheSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3ZhbHVlc0VuZFtwcm9wZXJ0eV0ubGVuZ3RoID09PSAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBhIGxvY2FsIGNvcHkgb2YgdGhlIEFycmF5IHdpdGggdGhlIHN0YXJ0IHZhbHVlIGF0IHRoZSBmcm9udAogICAgICAgICAgICAgICAgdGhpcy5fdmFsdWVzRW5kW3Byb3BlcnR5XSA9IFt0aGlzLl9vYmplY3RbcHJvcGVydHldXS5jb25jYXQodGhpcy5fdmFsdWVzRW5kW3Byb3BlcnR5XSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3ZhbHVlc1N0YXJ0W3Byb3BlcnR5XSA9IHRoaXMuX29iamVjdFtwcm9wZXJ0eV07CgogICAgICAgICAgICBpZiAoKHRoaXMuX3ZhbHVlc1N0YXJ0W3Byb3BlcnR5XSBpbnN0YW5jZW9mIEFycmF5KSA9PT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3ZhbHVlc1N0YXJ0W3Byb3BlcnR5XSAqPSAxLjA7IC8vIEVuc3VyZXMgd2UncmUgdXNpbmcgbnVtYmVycywgbm90IHN0cmluZ3MKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdmFsdWVzU3RhcnRSZXBlYXRbcHJvcGVydHldID0gdGhpcy5fdmFsdWVzU3RhcnRbcHJvcGVydHldIHx8IDA7CgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgdGhlIHR3ZWVuIGlmIHJ1bm5pbmcgYW5kIHJlbW92ZXMgaXQgZnJvbSB0aGUgVHdlZW5NYW5hZ2VyLiBJZiB0aGVyZSBhcmUgYW55IG9uQ29tcGxldGUgY2FsbGJhY2tzIG9yIGV2ZW50cyB0aGV5IGFyZSBub3QgZGlzcGF0Y2hlZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW4jc3RvcAogICAgKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuaXNSdW5uaW5nID0gZmFsc2U7CgogICAgICAgIHRoaXMuX29uVXBkYXRlQ2FsbGJhY2sgPSBudWxsOwoKICAgICAgICB0aGlzLl9tYW5hZ2VyLnJlbW92ZSh0aGlzKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyBhIGRlbGF5IHRpbWUgYmVmb3JlIHRoaXMgdHdlZW4gd2lsbCBzdGFydC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW4jZGVsYXkKICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgb2YgdGhlIGRlbGF5IGluIG1zLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KICAgICovCiAgICBkZWxheTogZnVuY3Rpb24gKGFtb3VudCkgewoKICAgICAgICB0aGlzLl9kZWxheVRpbWUgPSBhbW91bnQ7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgbnVtYmVyIG9mIHRpbWVzIHRoaXMgdHdlZW4gd2lsbCByZXBlYXQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI3JlcGVhdAogICAgKiBAcGFyYW0ge251bWJlcn0gdGltZXMgLSBIb3cgbWFueSB0aW1lcyB0byByZXBlYXQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgogICAgKi8KICAgIHJlcGVhdDogZnVuY3Rpb24gKHRpbWVzKSB7CgogICAgICAgIHRoaXMuX3JlcGVhdCA9IHRpbWVzOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEEgdHdlZW4gdGhhdCBoYXMgeW95byBzZXQgdG8gdHJ1ZSB3aWxsIHJ1biB0aHJvdWdoIGZyb20gc3RhcnQgdG8gZmluaXNoLCB0aGVuIHJldmVyc2UgZnJvbSBmaW5pc2ggdG8gc3RhcnQuCiAgICAqIFVzZWQgaW4gY29tYmluYXRpb24gd2l0aCByZXBlYXQgeW91IGNhbiBjcmVhdGUgZW5kbGVzcyBsb29wcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW4jeW95bwogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHlveW8gLSBTZXQgdG8gdHJ1ZSB0byB5b3lvIHRoaXMgdHdlZW4uCiAgICAqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgogICAgKi8KICAgIHlveW86IGZ1bmN0aW9uKHlveW8pIHsKCiAgICAgICAgdGhpcy5feW95byA9IHlveW87CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0IGVhc2luZyBmdW5jdGlvbiB0aGlzIHR3ZWVuIHdpbGwgdXNlLCBpLmUuIFBoYXNlci5FYXNpbmcuTGluZWFyLk5vbmUuIAogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNlYXNpbmcKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gZWFzaW5nIC0gVGhlIGVhc2luZyBmdW5jdGlvbiB0aGlzIHR3ZWVuIHdpbGwgdXNlLCBpLmUuIFBoYXNlci5FYXNpbmcuTGluZWFyLk5vbmUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgogICAgKi8KICAgIGVhc2luZzogZnVuY3Rpb24gKGVhc2luZykgewoKICAgICAgICB0aGlzLl9lYXNpbmdGdW5jdGlvbiA9IGVhc2luZzsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXQgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbiB0aGUgdHdlZW4gd2lsbCB1c2UsIGJ5IGRlZmF1bHQgaXQgdXNlcyBQaGFzZXIuTWF0aC5saW5lYXJJbnRlcnBvbGF0aW9uLgogICAgKiBBbHNvIGF2YWlsYWJsZTogUGhhc2VyLk1hdGguYmV6aWVySW50ZXJwb2xhdGlvbiBhbmQgUGhhc2VyLk1hdGguY2F0bXVsbFJvbUludGVycG9sYXRpb24uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI2ludGVycG9sYXRpb24KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gaW50ZXJwb2xhdGlvbiAtIFRoZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uIHRvIHVzZSAoUGhhc2VyLk1hdGgubGluZWFySW50ZXJwb2xhdGlvbiBieSBkZWZhdWx0KQogICAgKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KICAgICovCiAgICBpbnRlcnBvbGF0aW9uOiBmdW5jdGlvbiAoaW50ZXJwb2xhdGlvbikgewoKICAgICAgICB0aGlzLl9pbnRlcnBvbGF0aW9uRnVuY3Rpb24gPSBpbnRlcnBvbGF0aW9uOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFlvdSBjYW4gY2hhaW4gdHdlZW5zIHRvZ2V0aGVyIGJ5IHBhc3NpbmcgYSByZWZlcmVuY2UgdG8gdGhlIGNoYWluIGZ1bmN0aW9uLiBUaGlzIGVuYWJsZXMgb25lIHR3ZWVuIHRvIGNhbGwgYW5vdGhlciBvbiBjb21wbGV0aW9uLgogICAgKiBZb3UgY2FuIHBhc3MgYXMgbWFueSB0d2VlbnMgYXMgeW91IGxpa2UgdG8gdGhpcyBmdW5jdGlvbiwgdGhleSB3aWxsIGVhY2ggYmUgY2hhaW5lZCBpbiBzZXF1ZW5jZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW4jY2hhaW4KICAgICogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCiAgICAqLwogICAgY2hhaW46IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fY2hhaW5lZFR3ZWVucyA9IGFyZ3VtZW50czsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBMb29wIGEgY2hhaW4gb2YgdHdlZW5zCiAgICAqIAogICAgKiBVc2FnZToKICAgICogZ2FtZS5hZGQudHdlZW4ocCkudG8oeyB4OiA3MDAgfSwgMTAwMCwgUGhhc2VyLkVhc2luZy5MaW5lYXIuTm9uZSwgdHJ1ZSkKICAgICogLnRvKHsgeTogMzAwIH0sIDEwMDAsIFBoYXNlci5FYXNpbmcuTGluZWFyLk5vbmUpCiAgICAqIC50byh7IHg6IDAgfSwgMTAwMCwgUGhhc2VyLkVhc2luZy5MaW5lYXIuTm9uZSkKICAgICogLnRvKHsgeTogMCB9LCAxMDAwLCBQaGFzZXIuRWFzaW5nLkxpbmVhci5Ob25lKQogICAgKiAubG9vcCgpOwogICAgKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNsb29wCiAgICAqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgogICAgKi8KICAgIGxvb3A6IGZ1bmN0aW9uKCkgewoKICAgICAgICB0aGlzLl9sYXN0Q2hpbGQuY2hhaW4odGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyBhIGNhbGxiYWNrIHRvIGJlIGZpcmVkIGVhY2ggdGltZSB0aGlzIHR3ZWVuIHVwZGF0ZXMuIE5vdGU6IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGluIHRoZSBjb250ZXh0IG9mIHRoZSBnbG9iYWwgc2NvcGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI29uVXBkYXRlQ2FsbGJhY2sKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdG8gaW52b2tlIGVhY2ggdGltZSB0aGlzIHR3ZWVuIGlzIHVwZGF0ZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgogICAgKi8KICAgIG9uVXBkYXRlQ2FsbGJhY2s6IGZ1bmN0aW9uIChjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIHRoaXMuX29uVXBkYXRlQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICB0aGlzLl9vblVwZGF0ZUNhbGxiYWNrQ29udGV4dCA9IGNhbGxiYWNrQ29udGV4dDsKCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogUGF1c2VzIHRoZSB0d2Vlbi4gCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI3BhdXNlCiAgICAqLwogICAgcGF1c2U6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fcGF1c2VkID0gdHJ1ZTsKICAgICAgICB0aGlzLl9wYXVzZWRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlc3VtZXMgYSBwYXVzZWQgdHdlZW4uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI3Jlc3VtZQogICAgKi8KICAgIHJlc3VtZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9wYXVzZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLl9zdGFydFRpbWUgKz0gKHRoaXMuZ2FtZS50aW1lLm5vdyAtIHRoaXMuX3BhdXNlZFRpbWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENvcmUgdHdlZW4gdXBkYXRlIGZ1bmN0aW9uIGNhbGxlZCBieSB0aGUgVHdlZW5NYW5hZ2VyLiBEb2VzIG5vdCBuZWVkIHRvIGJlIGludm9rZWQgZGlyZWN0bHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI3VwZGF0ZQogICAgKiBAcGFyYW0ge251bWJlcn0gdGltZSAtIEEgdGltZXN0YW1wIHBhc3NlZCBpbiBieSB0aGUgVHdlZW5NYW5hZ2VyLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBmYWxzZSBpZiB0aGUgdHdlZW4gaGFzIGNvbXBsZXRlZCBhbmQgc2hvdWxkIGJlIGRlbGV0ZWQgZnJvbSB0aGUgbWFuYWdlciwgb3RoZXJ3aXNlIHRydWUgKHN0aWxsIGFjdGl2ZSkuCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAodGltZSkgewoKICAgICAgICBpZiAodGhpcy5wZW5kaW5nRGVsZXRlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX3BhdXNlZCB8fCB0aW1lIDwgdGhpcy5fc3RhcnRUaW1lKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgcHJvcGVydHk7CgogICAgICAgIGlmICh0aW1lIDwgdGhpcy5fc3RhcnRUaW1lKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fb25TdGFydENhbGxiYWNrRmlyZWQgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vblN0YXJ0LmRpc3BhdGNoKHRoaXMuX29iamVjdCk7CiAgICAgICAgICAgIHRoaXMuX29uU3RhcnRDYWxsYmFja0ZpcmVkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHZhciBlbGFwc2VkID0gKHRpbWUgLSB0aGlzLl9zdGFydFRpbWUpIC8gdGhpcy5fZHVyYXRpb247CiAgICAgICAgZWxhcHNlZCA9IGVsYXBzZWQgPiAxID8gMSA6IGVsYXBzZWQ7CgogICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuX2Vhc2luZ0Z1bmN0aW9uKGVsYXBzZWQpOwoKICAgICAgICBmb3IgKHByb3BlcnR5IGluIHRoaXMuX3ZhbHVlc0VuZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX3ZhbHVlc1N0YXJ0W3Byb3BlcnR5XSB8fCAwOwogICAgICAgICAgICB2YXIgZW5kID0gdGhpcy5fdmFsdWVzRW5kW3Byb3BlcnR5XTsKCiAgICAgICAgICAgIGlmIChlbmQgaW5zdGFuY2VvZiBBcnJheSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fb2JqZWN0W3Byb3BlcnR5XSA9IHRoaXMuX2ludGVycG9sYXRpb25GdW5jdGlvbihlbmQsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIFBhcnNlcyByZWxhdGl2ZSBlbmQgdmFsdWVzIHdpdGggc3RhcnQgYXMgYmFzZSAoZS5nLjogKzEwLCAtMykKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YoZW5kKSA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZW5kID0gc3RhcnQgKyBwYXJzZUZsb2F0KGVuZCwgMTApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHByb3RlY3QgYWdhaW5zdCBub24gbnVtZXJpYyBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZihlbmQpID09PSAnbnVtYmVyJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9vYmplY3RbcHJvcGVydHldID0gc3RhcnQgKyAoIGVuZCAtIHN0YXJ0ICkgKiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX29uVXBkYXRlQ2FsbGJhY2sgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9vblVwZGF0ZUNhbGxiYWNrLmNhbGwodGhpcy5fb25VcGRhdGVDYWxsYmFja0NvbnRleHQsIHRoaXMsIHZhbHVlKTsKICAgICAgICB9CgogICAgICAgIGlmIChlbGFwc2VkID09IDEpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fcmVwZWF0ID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGlzRmluaXRlKHRoaXMuX3JlcGVhdCkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVwZWF0LS07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gcmVhc3NpZ24gc3RhcnRpbmcgdmFsdWVzLCByZXN0YXJ0IGJ5IG1ha2luZyBzdGFydFRpbWUgPSBub3cKICAgICAgICAgICAgICAgIGZvciAocHJvcGVydHkgaW4gdGhpcy5fdmFsdWVzU3RhcnRSZXBlYXQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZih0aGlzLl92YWx1ZXNFbmRbcHJvcGVydHldKSA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl92YWx1ZXNTdGFydFJlcGVhdFtwcm9wZXJ0eV0gPSB0aGlzLl92YWx1ZXNTdGFydFJlcGVhdFtwcm9wZXJ0eV0gKyBwYXJzZUZsb2F0KHRoaXMuX3ZhbHVlc0VuZFtwcm9wZXJ0eV0sIDEwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl95b3lvKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRtcCA9IHRoaXMuX3ZhbHVlc1N0YXJ0UmVwZWF0W3Byb3BlcnR5XTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdmFsdWVzU3RhcnRSZXBlYXRbcHJvcGVydHldID0gdGhpcy5fdmFsdWVzRW5kW3Byb3BlcnR5XTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdmFsdWVzRW5kW3Byb3BlcnR5XSA9IHRtcDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmV2ZXJzZWQgPSAhdGhpcy5fcmV2ZXJzZWQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0aGlzLl92YWx1ZXNTdGFydFtwcm9wZXJ0eV0gPSB0aGlzLl92YWx1ZXNTdGFydFJlcGVhdFtwcm9wZXJ0eV07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fc3RhcnRUaW1lID0gdGltZSArIHRoaXMuX2RlbGF5VGltZTsKCiAgICAgICAgICAgICAgICB0aGlzLm9uTG9vcC5kaXNwYXRjaCh0aGlzLl9vYmplY3QpOwoKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNSdW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm9uQ29tcGxldGUuZGlzcGF0Y2godGhpcy5fb2JqZWN0KTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbnVtQ2hhaW5lZFR3ZWVucyA9IHRoaXMuX2NoYWluZWRUd2VlbnMubGVuZ3RoOyBpIDwgbnVtQ2hhaW5lZFR3ZWVuczsgaSArKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGFpbmVkVHdlZW5zW2ldLnN0YXJ0KHRpbWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwoKICAgIH0KICAgIAp9OwoKUGhhc2VyLlR3ZWVuLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5Ud2VlbjsKCi8qIGpzaGludCBjdXJseTogZmFsc2UgKi8KCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgY29sbGVjdGlvbiBvZiBlYXNpbmcgbWV0aG9kcyBkZWZpbmluZyBlYXNlLWluIGVhc2Utb3V0IGN1cnZlcy4KKgoqIEBjbGFzcyBQaGFzZXIuRWFzaW5nCiovClBoYXNlci5FYXNpbmcgPSB7CgogICAgLyoqCiAgICAqIExpbmVhciBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLkxpbmVhcgogICAgKi8KICAgIExpbmVhcjogewoKICAgICAgICAvKioKICAgICAgICAqIEVhc2UtaW4uCiAgICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkxpbmVhciNJbiAKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBrXjIuCiAgICAgICAgKi8KICAgICAgICBOb25lOiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gazsKCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFF1YWRyYXRpYyBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLlF1YWRyYXRpYwogICAgKi8KICAgIFF1YWRyYXRpYzogewoKICAgICAgICAvKioKICAgICAgICAqIEVhc2UtaW4uCiAgICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlF1YWRyYXRpYyNJbiAKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0ga14yLgogICAgICAgICovCiAgICAgICAgSW46IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHJldHVybiBrICogazsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBFYXNlLW91dC4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuUXVhZHJhdGljI091dCAKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gayogKDItaykuCiAgICAgICAgKi8KICAgICAgICBPdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHJldHVybiBrICogKCAyIC0gayApOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIEVhc2UtaW4vb3V0LgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5RdWFkcmF0aWMjSW5PdXQKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KICAgICAgICBJbk91dDogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgaWYgKCAoIGsgKj0gMiApIDwgMSApIHJldHVybiAwLjUgKiBrICogazsKICAgICAgICAgICAgcmV0dXJuIC0gMC41ICogKCAtLWsgKiAoIGsgLSAyICkgLSAxICk7CgogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDdWJpYyBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLkN1YmljCiAgICAqLwogICAgQ3ViaWM6IHsKCiAgICAgICAgLyoqCiAgICAgICAgKiBDdWJpYyBlYXNlLWluLgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5DdWJpYyNJbiAKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KICAgICAgICBJbjogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgcmV0dXJuIGsgKiBrICogazsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBDdWJpYyBlYXNlLW91dC4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQ3ViaWMjT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCiAgICAgICAgT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gLS1rICogayAqIGsgKyAxOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIEN1YmljIGVhc2UtaW4vb3V0LgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5DdWJpYyNJbk91dAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwogICAgICAgIEluT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICBpZiAoICggayAqPSAyICkgPCAxICkgcmV0dXJuIDAuNSAqIGsgKiBrICogazsKICAgICAgICAgICAgcmV0dXJuIDAuNSAqICggKCBrIC09IDIgKSAqIGsgKiBrICsgMiApOwoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUXVhcnRpYyBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLlF1YXJ0aWMKICAgICovCiAgICBRdWFydGljOiB7CgogICAgICAgIC8qKgogICAgICAgICogUXVhcnRpYyBlYXNlLWluLgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5RdWFydGljI0luIAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwogICAgICAgIEluOiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gayAqIGsgKiBrICogazsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBRdWFydGljIGVhc2Utb3V0LgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5RdWFydGljI091dAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwogICAgICAgIE91dDogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgcmV0dXJuIDEgLSAoIC0tayAqIGsgKiBrICogayApOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIFF1YXJ0aWMgZWFzZS1pbi9vdXQuCiAgICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlF1YXJ0aWMjSW5PdXQKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KICAgICAgICBJbk91dDogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgaWYgKCAoIGsgKj0gMiApIDwgMSkgcmV0dXJuIDAuNSAqIGsgKiBrICogayAqIGs7CiAgICAgICAgICAgIHJldHVybiAtIDAuNSAqICggKCBrIC09IDIgKSAqIGsgKiBrICogayAtIDIgKTsKCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFF1aW50aWMgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5RdWludGljCiAgICAqLwogICAgUXVpbnRpYzogewoKICAgICAgICAvKioKICAgICAgICAqIFF1aW50aWMgZWFzZS1pbi4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuUXVpbnRpYyNJbiAKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KICAgICAgICBJbjogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgcmV0dXJuIGsgKiBrICogayAqIGsgKiBrOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIFF1aW50aWMgZWFzZS1vdXQuCiAgICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlF1aW50aWMjT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCiAgICAgICAgT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gLS1rICogayAqIGsgKiBrICogayArIDE7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICogUXVpbnRpYyBlYXNlLWluL291dC4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuUXVpbnRpYyNJbk91dAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwogICAgICAgIEluT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICBpZiAoICggayAqPSAyICkgPCAxICkgcmV0dXJuIDAuNSAqIGsgKiBrICogayAqIGsgKiBrOwogICAgICAgICAgICByZXR1cm4gMC41ICogKCAoIGsgLT0gMiApICogayAqIGsgKiBrICogayArIDIgKTsKCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNpbnVzb2lkYWwgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5TaW51c29pZGFsCiAgICAqLwogICAgU2ludXNvaWRhbDogewoKICAgICAgICAvKioKICAgICAgICAqIFNpbnVzb2lkYWwgZWFzZS1pbi4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuU2ludXNvaWRhbCNJbiAKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KICAgICAgICBJbjogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgcmV0dXJuIDEgLSBNYXRoLmNvcyggayAqIE1hdGguUEkgLyAyICk7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICogU2ludXNvaWRhbCBlYXNlLW91dC4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuU2ludXNvaWRhbCNPdXQKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KICAgICAgICBPdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHJldHVybiBNYXRoLnNpbiggayAqIE1hdGguUEkgLyAyICk7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICogU2ludXNvaWRhbCBlYXNlLWluL291dC4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuU2ludXNvaWRhbCNJbk91dAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwogICAgICAgIEluT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gMC41ICogKCAxIC0gTWF0aC5jb3MoIE1hdGguUEkgKiBrICkgKTsKCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEV4cG9uZW50aWFsIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuRXhwb25lbnRpYWwKICAgICovCiAgICBFeHBvbmVudGlhbDogewoKICAgICAgICAvKioKICAgICAgICAqIEV4cG9uZW50aWFsIGVhc2UtaW4uCiAgICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkV4cG9uZW50aWFsI0luIAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwogICAgICAgIEluOiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gayA9PT0gMCA/IDAgOiBNYXRoLnBvdyggMTAyNCwgayAtIDEgKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBFeHBvbmVudGlhbCBlYXNlLW91dC4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuRXhwb25lbnRpYWwjT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCiAgICAgICAgT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gayA9PT0gMSA/IDEgOiAxIC0gTWF0aC5wb3coIDIsIC0gMTAgKiBrICk7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICogRXhwb25lbnRpYWwgZWFzZS1pbi9vdXQuCiAgICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkV4cG9uZW50aWFsI0luT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCiAgICAgICAgSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIGlmICggayA9PT0gMCApIHJldHVybiAwOwogICAgICAgICAgICBpZiAoIGsgPT09IDEgKSByZXR1cm4gMTsKICAgICAgICAgICAgaWYgKCAoIGsgKj0gMiApIDwgMSApIHJldHVybiAwLjUgKiBNYXRoLnBvdyggMTAyNCwgayAtIDEgKTsKICAgICAgICAgICAgcmV0dXJuIDAuNSAqICggLSBNYXRoLnBvdyggMiwgLSAxMCAqICggayAtIDEgKSApICsgMiApOwoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2lyY3VsYXIgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5DaXJjdWxhcgogICAgKi8KICAgIENpcmN1bGFyOiB7CgogICAgICAgIC8qKgogICAgICAgICogQ2lyY3VsYXIgZWFzZS1pbi4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQ2lyY3VsYXIjSW4gCiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCiAgICAgICAgSW46IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHJldHVybiAxIC0gTWF0aC5zcXJ0KCAxIC0gayAqIGsgKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBDaXJjdWxhciBlYXNlLW91dC4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQ2lyY3VsYXIjT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCiAgICAgICAgT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KCAxIC0gKCAtLWsgKiBrICkgKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBDaXJjdWxhciBlYXNlLWluL291dC4KICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5DaXJjdWxhciNJbk91dAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICovCiAgICAgICAgSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIGlmICggKCBrICo9IDIgKSA8IDEpIHJldHVybiAtIDAuNSAqICggTWF0aC5zcXJ0KCAxIC0gayAqIGspIC0gMSk7CiAgICAgICAgICAgIHJldHVybiAwLjUgKiAoIE1hdGguc3FydCggMSAtICggayAtPSAyKSAqIGspICsgMSk7CgogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBFbGFzdGljIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuRWxhc3RpYwogICAgKi8KICAgIEVsYXN0aWM6IHsKCiAgICAgICAgLyoqCiAgICAgICAgKiBFbGFzdGljIGVhc2UtaW4uCiAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuRWxhc3RpYyNJbiAKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAqLwogICAgICAgIEluOiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICB2YXIgcywgYSA9IDAuMSwgcCA9IDAuNDsKICAgICAgICAgICAgaWYgKCBrID09PSAwICkgcmV0dXJuIDA7CiAgICAgICAgICAgIGlmICggayA9PT0gMSApIHJldHVybiAxOwogICAgICAgICAgICBpZiAoICFhIHx8IGEgPCAxICkgeyBhID0gMTsgcyA9IHAgLyA0OyB9CiAgICAgICAgICAgIGVsc2UgcyA9IHAgKiBNYXRoLmFzaW4oIDEgLyBhICkgLyAoIDIgKiBNYXRoLlBJICk7CiAgICAgICAgICAgIHJldHVybiAtICggYSAqIE1hdGgucG93KCAyLCAxMCAqICggayAtPSAxICkgKSAqIE1hdGguc2luKCAoIGsgLSBzICkgKiAoIDIgKiBNYXRoLlBJICkgLyBwICkgKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBFbGFzdGljIGVhc2Utb3V0LgogICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkVsYXN0aWMjT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgKi8KICAgICAgICBPdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHZhciBzLCBhID0gMC4xLCBwID0gMC40OwogICAgICAgICAgICBpZiAoIGsgPT09IDAgKSByZXR1cm4gMDsKICAgICAgICAgICAgaWYgKCBrID09PSAxICkgcmV0dXJuIDE7CiAgICAgICAgICAgIGlmICggIWEgfHwgYSA8IDEgKSB7IGEgPSAxOyBzID0gcCAvIDQ7IH0KICAgICAgICAgICAgZWxzZSBzID0gcCAqIE1hdGguYXNpbiggMSAvIGEgKSAvICggMiAqIE1hdGguUEkgKTsKICAgICAgICAgICAgcmV0dXJuICggYSAqIE1hdGgucG93KCAyLCAtIDEwICogaykgKiBNYXRoLnNpbiggKCBrIC0gcyApICogKCAyICogTWF0aC5QSSApIC8gcCApICsgMSApOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIEVsYXN0aWMgZWFzZS1pbi9vdXQuCiAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuRWxhc3RpYyNJbk91dAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICovCiAgICAgICAgSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHZhciBzLCBhID0gMC4xLCBwID0gMC40OwogICAgICAgICAgICBpZiAoIGsgPT09IDAgKSByZXR1cm4gMDsKICAgICAgICAgICAgaWYgKCBrID09PSAxICkgcmV0dXJuIDE7CiAgICAgICAgICAgIGlmICggIWEgfHwgYSA8IDEgKSB7IGEgPSAxOyBzID0gcCAvIDQ7IH0KICAgICAgICAgICAgZWxzZSBzID0gcCAqIE1hdGguYXNpbiggMSAvIGEgKSAvICggMiAqIE1hdGguUEkgKTsKICAgICAgICAgICAgaWYgKCAoIGsgKj0gMiApIDwgMSApIHJldHVybiAtIDAuNSAqICggYSAqIE1hdGgucG93KCAyLCAxMCAqICggayAtPSAxICkgKSAqIE1hdGguc2luKCAoIGsgLSBzICkgKiAoIDIgKiBNYXRoLlBJICkgLyBwICkgKTsKICAgICAgICAgICAgcmV0dXJuIGEgKiBNYXRoLnBvdyggMiwgLTEwICogKCBrIC09IDEgKSApICogTWF0aC5zaW4oICggayAtIHMgKSAqICggMiAqIE1hdGguUEkgKSAvIHAgKSAqIDAuNSArIDE7CgogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBCYWNrIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuQmFjawogICAgKi8KICAgIEJhY2s6IHsKCiAgICAgICAgLyoqCiAgICAgICAgKiBCYWNrIGVhc2UtaW4uCiAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQmFjayNJbiAKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAqLwogICAgICAgIEluOiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICB2YXIgcyA9IDEuNzAxNTg7CiAgICAgICAgICAgIHJldHVybiBrICogayAqICggKCBzICsgMSApICogayAtIHMgKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBCYWNrIGVhc2Utb3V0LgogICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkJhY2sjT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgKi8KICAgICAgICBPdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHZhciBzID0gMS43MDE1ODsKICAgICAgICAgICAgcmV0dXJuIC0tayAqIGsgKiAoICggcyArIDEgKSAqIGsgKyBzICkgKyAxOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIEJhY2sgZWFzZS1pbi9vdXQuCiAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQmFjayNJbk91dAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICovCiAgICAgICAgSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHZhciBzID0gMS43MDE1OCAqIDEuNTI1OwogICAgICAgICAgICBpZiAoICggayAqPSAyICkgPCAxICkgcmV0dXJuIDAuNSAqICggayAqIGsgKiAoICggcyArIDEgKSAqIGsgLSBzICkgKTsKICAgICAgICAgICAgcmV0dXJuIDAuNSAqICggKCBrIC09IDIgKSAqIGsgKiAoICggcyArIDEgKSAqIGsgKyBzICkgKyAyICk7CgogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBCb3VuY2UgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5Cb3VuY2UKICAgICovCiAgICBCb3VuY2U6IHsKCiAgICAgICAgLyoqCiAgICAgICAgKiBCb3VuY2UgZWFzZS1pbi4KICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5Cb3VuY2UjSW4gCiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgKi8KICAgICAgICBJbjogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgcmV0dXJuIDEgLSBQaGFzZXIuRWFzaW5nLkJvdW5jZS5PdXQoIDEgLSBrICk7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICogQm91bmNlIGVhc2Utb3V0LgogICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkJvdW5jZSNPdXQKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAqLwogICAgICAgIE91dDogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgaWYgKCBrIDwgKCAxIC8gMi43NSApICkgewoKICAgICAgICAgICAgICAgIHJldHVybiA3LjU2MjUgKiBrICogazsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoIGsgPCAoIDIgLyAyLjc1ICkgKSB7CgogICAgICAgICAgICAgICAgcmV0dXJuIDcuNTYyNSAqICggayAtPSAoIDEuNSAvIDIuNzUgKSApICogayArIDAuNzU7CgogICAgICAgICAgICB9IGVsc2UgaWYgKCBrIDwgKCAyLjUgLyAyLjc1ICkgKSB7CgogICAgICAgICAgICAgICAgcmV0dXJuIDcuNTYyNSAqICggayAtPSAoIDIuMjUgLyAyLjc1ICkgKSAqIGsgKyAwLjkzNzU7CgogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHJldHVybiA3LjU2MjUgKiAoIGsgLT0gKCAyLjYyNSAvIDIuNzUgKSApICogayArIDAuOTg0Mzc1OwoKICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIEJvdW5jZSBlYXNlLWluL291dC4KICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5Cb3VuY2UjSW5PdXQKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAqLwogICAgICAgIEluT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICBpZiAoIGsgPCAwLjUgKSByZXR1cm4gUGhhc2VyLkVhc2luZy5Cb3VuY2UuSW4oIGsgKiAyICkgKiAwLjU7CiAgICAgICAgICAgIHJldHVybiBQaGFzZXIuRWFzaW5nLkJvdW5jZS5PdXQoIGsgKiAyIC0gMSApICogMC41ICsgMC41OwoKICAgICAgICB9CgogICAgfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRpbWUgY29uc3RydWN0b3IuCioKKiBAY2xhc3MgUGhhc2VyLlRpbWUKKiBAY2xhc3NkZXNjIFRoaXMgaXMgdGhlIGNvcmUgaW50ZXJuYWwgZ2FtZSBjbG9jay4gSXQgbWFuYWdlcyB0aGUgZWxhcHNlZCB0aW1lIGFuZCBjYWxjdWxhdGlvbiBvZiBlbGFwc2VkIHZhbHVlcywgdXNlZCBmb3IgZ2FtZSBvYmplY3QgbW90aW9uIGFuZCB0d2VlbnMuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLlRpbWUgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWUgLSBHYW1lIHRpbWUgY291bnRlci4gSWYgeW91IG5lZWQgYSB2YWx1ZSBmb3IgaW4tZ2FtZSBjYWxjdWxhdGlvbiBwbGVhc2UgdXNlIFBoYXNlci5UaW1lLm5vdyBpbnN0ZWFkLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdGhpcy50aW1lID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG5vdyAtIFRoZSB0aW1lIHJpZ2h0IG5vdy4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHRoaXMubm93ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGVsYXBzZWQgLSBFbGFwc2VkIHRpbWUgc2luY2UgdGhlIGxhc3QgZnJhbWUgKGluIG1zKS4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHRoaXMuZWxhcHNlZCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwYXVzZWRUaW1lIC0gUmVjb3JkcyBob3cgbG9uZyB0aGUgZ2FtZSBoYXMgYmVlbiBwYXVzZWQgZm9yLiBJcyByZXNldCBlYWNoIHRpbWUgdGhlIGdhbWUgcGF1c2VzLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdGhpcy5wYXVzZWRUaW1lID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGZwcyAtIEZyYW1lcyBwZXIgc2Vjb25kLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdGhpcy5mcHMgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZnBzTWluIC0gVGhlIGxvd2VzdCByYXRlIHRoZSBmcHMgaGFzIGRyb3BwZWQgdG8uCiAgICAqLwogICAgdGhpcy5mcHNNaW4gPSAxMDAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZnBzTWF4IC0gVGhlIGhpZ2hlc3QgcmF0ZSB0aGUgZnBzIGhhcyByZWFjaGVkICh1c3VhbGx5IG5vIGhpZ2hlciB0aGFuIDYwZnBzKS4KICAgICovCiAgICB0aGlzLmZwc01heCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtc01pbiAtIFRoZSBtaW5pbXVtIGFtb3VudCBvZiB0aW1lIHRoZSBnYW1lIGhhcyB0YWtlbiBiZXR3ZWVuIHR3byBmcmFtZXMuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tc01pbiA9IDEwMDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtc01heCAtIFRoZSBtYXhpbXVtIGFtb3VudCBvZiB0aW1lIHRoZSBnYW1lIGhhcyB0YWtlbiBiZXR3ZWVuIHR3byBmcmFtZXMuCiAgICAqLwogICAgdGhpcy5tc01heCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwaHlzaWNzRWxhcHNlZCAtIFRoZSBlbGFwc2VkIHRpbWUgY2FsY3VsYXRlZCBmb3IgdGhlIHBoeXNpY3MgbW90aW9uIHVwZGF0ZXMuCiAgICAqLwogICAgdGhpcy5waHlzaWNzRWxhcHNlZCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcmFtZXMgLSBUaGUgbnVtYmVyIG9mIGZyYW1lcyByZWNvcmQgaW4gdGhlIGxhc3Qgc2Vjb25kLgogICAgKi8KICAgIHRoaXMuZnJhbWVzID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBhdXNlRHVyYXRpb24gLSBSZWNvcmRzIGhvdyBsb25nIHRoZSBnYW1lIHdhcyBwYXVzZWQgZm9yIGluIG1pbGlzZWNvbmRzLgogICAgKi8KICAgIHRoaXMucGF1c2VEdXJhdGlvbiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lVG9DYWxsIC0gVGhlIHZhbHVlIHRoYXQgc2V0VGltZW91dCBuZWVkcyB0byB3b3JrIG91dCB3aGVuIHRvIG5leHQgdXBkYXRlCiAgICAqLwogICAgdGhpcy50aW1lVG9DYWxsID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGxhc3RUaW1lIC0gSW50ZXJuYWwgdmFsdWUgdXNlZCBieSB0aW1lVG9DYWxsIGFzIHBhcnQgb2YgdGhlIHNldFRpbWVvdXQgbG9vcAogICAgKi8KICAgIHRoaXMubGFzdFRpbWUgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5UaW1lcn0gZXZlbnRzIC0gVGhpcyBpcyBhIFBoYXNlci5UaW1lciBvYmplY3QgYm91bmQgdG8gdGhlIG1hc3RlciBjbG9jayB0byB3aGljaCB5b3UgY2FuIGFkZCB0aW1lZCBldmVudHMuCiAgICAqLwogICAgdGhpcy5ldmVudHMgPSBuZXcgUGhhc2VyLlRpbWVyKHRoaXMuZ2FtZSwgZmFsc2UpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3N0YXJ0ZWQgLSBUaGUgdGltZSBhdCB3aGljaCB0aGUgR2FtZSBpbnN0YW5jZSBzdGFydGVkLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3N0YXJ0ZWQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3RpbWVMYXN0U2Vjb25kIC0gVGhlIHRpbWUgKGluIG1zKSB0aGF0IHRoZSBsYXN0IHNlY29uZCBjb3VudGVyIHRpY2tlZCBvdmVyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3RpbWVMYXN0U2Vjb25kID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9wYXVzZVN0YXJ0ZWQgLSBUaGUgdGltZSB0aGUgZ2FtZSBzdGFydGVkIGJlaW5nIHBhdXNlZC4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9wYXVzZVN0YXJ0ZWQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9qdXN0UmVzdW1lZCAtIEludGVybmFsIHZhbHVlIHVzZWQgdG8gcmVjb3ZlciBmcm9tIHRoZSBnYW1lIHBhdXNlIHN0YXRlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2p1c3RSZXN1bWVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IF90aW1lcnMgLSBJbnRlcm5hbCBzdG9yZSBvZiBQaGFzZXIuVGltZXIgb2JqZWN0cy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90aW1lcnMgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9sZW4gLSBUZW1wLiBhcnJheSBsZW5ndGggdmFyaWFibGUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fbGVuID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9pIC0gVGVtcC4gYXJyYXkgY291bnRlciB2YXJpYWJsZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9pID0gMDsKCiAgICAvLyAgTGlzdGVuIGZvciBnYW1lIHBhdXNlL3Jlc3VtZSBldmVudHMKICAgIHRoaXMuZ2FtZS5vblBhdXNlLmFkZCh0aGlzLmdhbWVQYXVzZWQsIHRoaXMpOwogICAgdGhpcy5nYW1lLm9uUmVzdW1lLmFkZCh0aGlzLmdhbWVSZXN1bWVkLCB0aGlzKTsKCn07CgpQaGFzZXIuVGltZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWUjYm9vdAogICAgKi8KICAgIGJvb3Q6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5ldmVudHMuc3RhcnQoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IHN0YW5kLWFsb25lIFBoYXNlci5UaW1lciBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWUjY3JlYXRlCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2F1dG9EZXN0cm95PXRydWVdIC0gQSBUaW1lciB0aGF0IGlzIHNldCB0byBhdXRvbWF0aWNhbGx5IGRlc3Ryb3kgaXRzZWxmIHdpbGwgZG8gc28gYWZ0ZXIgYWxsIG9mIGl0cyBldmVudHMgaGF2ZSBiZWVuIGRpc3BhdGNoZWQgKGFzc3VtaW5nIG5vIGxvb3BpbmcgZXZlbnRzKS4KICAgICogQHJldHVybiB7UGhhc2VyLlRpbWVyfSBUaGUgVGltZXIgb2JqZWN0IHRoYXQgd2FzIGNyZWF0ZWQuCiAgICAqLwogICAgY3JlYXRlOiBmdW5jdGlvbiAoYXV0b0Rlc3Ryb3kpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBhdXRvRGVzdHJveSA9PT0gJ3VuZGVmaW5lZCcpIHsgYXV0b0Rlc3Ryb3kgPSB0cnVlOyB9CgogICAgICAgIHZhciB0aW1lciA9IG5ldyBQaGFzZXIuVGltZXIodGhpcy5nYW1lLCBhdXRvRGVzdHJveSk7CgogICAgICAgIHRoaXMuX3RpbWVycy5wdXNoKHRpbWVyKTsKCiAgICAgICAgcmV0dXJuIHRpbWVyOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZSBhbGwgVGltZXIgb2JqZWN0cywgcmVnYXJkbGVzcyBvZiB0aGVpciBzdGF0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZSNyZW1vdmVBbGwKICAgICovCiAgICByZW1vdmVBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl90aW1lcnMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl90aW1lcnNbaV0uZGVzdHJveSgpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fdGltZXJzID0gW107CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlcyB0aGUgZ2FtZSBjbG9jayBhbmQgY2FsY3VsYXRlIHRoZSBmcHMuIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgUGhhc2VyLkdhbWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWUjdXBkYXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lIC0gVGhlIGN1cnJlbnQgdGltZXN0YW1wLCBlaXRoZXIgcGVyZm9ybWFuY2Uubm93IG9yIERhdGUubm93IGRlcGVuZGluZyBvbiB0aGUgYnJvd3Nlci4KICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICh0aW1lKSB7CgogICAgICAgIHRoaXMubm93ID0gdGltZTsKCiAgICAgICAgaWYgKHRoaXMuX2p1c3RSZXN1bWVkKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50aW1lID0gdGhpcy5ub3c7CiAgICAgICAgICAgIHRoaXMuX2p1c3RSZXN1bWVkID0gZmFsc2U7CiAgICAKICAgICAgICAgICAgdGhpcy5ldmVudHMucmVzdW1lKCk7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3RpbWVycy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fdGltZXJzW2ldLnJlc3VtZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnRpbWVUb0NhbGwgPSB0aGlzLmdhbWUubWF0aC5tYXgoMCwgMTYgLSAodGltZSAtIHRoaXMubGFzdFRpbWUpKTsKCiAgICAgICAgdGhpcy5lbGFwc2VkID0gdGhpcy5ub3cgLSB0aGlzLnRpbWU7CgogICAgICAgIHRoaXMubXNNaW4gPSB0aGlzLmdhbWUubWF0aC5taW4odGhpcy5tc01pbiwgdGhpcy5lbGFwc2VkKTsKICAgICAgICB0aGlzLm1zTWF4ID0gdGhpcy5nYW1lLm1hdGgubWF4KHRoaXMubXNNYXgsIHRoaXMuZWxhcHNlZCk7CgogICAgICAgIHRoaXMuZnJhbWVzKys7CgogICAgICAgIGlmICh0aGlzLm5vdyA+IHRoaXMuX3RpbWVMYXN0U2Vjb25kICsgMTAwMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnBzID0gTWF0aC5yb3VuZCgodGhpcy5mcmFtZXMgKiAxMDAwKSAvICh0aGlzLm5vdyAtIHRoaXMuX3RpbWVMYXN0U2Vjb25kKSk7CiAgICAgICAgICAgIHRoaXMuZnBzTWluID0gdGhpcy5nYW1lLm1hdGgubWluKHRoaXMuZnBzTWluLCB0aGlzLmZwcyk7CiAgICAgICAgICAgIHRoaXMuZnBzTWF4ID0gdGhpcy5nYW1lLm1hdGgubWF4KHRoaXMuZnBzTWF4LCB0aGlzLmZwcyk7CiAgICAgICAgICAgIHRoaXMuX3RpbWVMYXN0U2Vjb25kID0gdGhpcy5ub3c7CiAgICAgICAgICAgIHRoaXMuZnJhbWVzID0gMDsKICAgICAgICB9CgogICAgICAgIHRoaXMudGltZSA9IHRoaXMubm93OwogICAgICAgIHRoaXMubGFzdFRpbWUgPSB0aW1lICsgdGhpcy50aW1lVG9DYWxsOwogICAgICAgIHRoaXMucGh5c2ljc0VsYXBzZWQgPSAxLjAgKiAodGhpcy5lbGFwc2VkIC8gMTAwMCk7CgogICAgICAgIC8vICBDbGFtcCB0aGUgZGVsdGEKICAgICAgICBpZiAodGhpcy5waHlzaWNzRWxhcHNlZCA+IDAuMDUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnBoeXNpY3NFbGFwc2VkID0gMC4wNTsKICAgICAgICB9CgogICAgICAgIC8vICBQYXVzZWQ/CiAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXVzZWQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnBhdXNlZFRpbWUgPSB0aGlzLm5vdyAtIHRoaXMuX3BhdXNlU3RhcnRlZDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIE91ciBpbnRlcm5hbCBQaGFzZXIuVGltZXIKICAgICAgICAgICAgdGhpcy5ldmVudHMudXBkYXRlKHRoaXMubm93KTsKCiAgICAgICAgICAgIC8vICBBbnkgZ2FtZSBsZXZlbCB0aW1lcnMKICAgICAgICAgICAgdGhpcy5faSA9IDA7CiAgICAgICAgICAgIHRoaXMuX2xlbiA9IHRoaXMuX3RpbWVycy5sZW5ndGg7CgogICAgICAgICAgICB3aGlsZSAodGhpcy5faSA8IHRoaXMuX2xlbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3RpbWVyc1t0aGlzLl9pXS51cGRhdGUodGhpcy5ub3cpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2krKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl90aW1lcnMuc3BsaWNlKHRoaXMuX2ksIDEpOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLl9sZW4tLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgd2hlbiB0aGUgZ2FtZSBlbnRlcnMgYSBwYXVzZWQgc3RhdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWUjZ2FtZVBhdXNlZAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIGdhbWVQYXVzZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAKICAgICAgICB0aGlzLl9wYXVzZVN0YXJ0ZWQgPSB0aGlzLm5vdzsKCiAgICAgICAgdGhpcy5ldmVudHMucGF1c2UoKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl90aW1lcnMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl90aW1lcnNbaV0ucGF1c2UoKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIHdoZW4gdGhlIGdhbWUgcmVzdW1lcyBmcm9tIGEgcGF1c2VkIHN0YXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lI2dhbWVSZXN1bWVkCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgZ2FtZVJlc3VtZWQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy8gIExldmVsIG91dCB0aGUgZWxhcHNlZCB0aW1lciB0byBhdm9pZCBzcGlrZXMKICAgICAgICB0aGlzLnRpbWUgPSBEYXRlLm5vdygpOwogICAgICAgIHRoaXMucGF1c2VEdXJhdGlvbiA9IHRoaXMucGF1c2VkVGltZTsKICAgICAgICB0aGlzLl9qdXN0UmVzdW1lZCA9IHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIG51bWJlciBvZiBzZWNvbmRzIHRoYXQgaGF2ZSBlbGFwc2VkIHNpbmNlIHRoZSBnYW1lIHdhcyBzdGFydGVkLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lI3RvdGFsRWxhcHNlZFNlY29uZHMKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHRvdGFsRWxhcHNlZFNlY29uZHM6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAodGhpcy5ub3cgLSB0aGlzLl9zdGFydGVkKSAqIDAuMDAxOwogICAgfSwKCiAgICAvKioKICAgICogSG93IGxvbmcgaGFzIHBhc3NlZCBzaW5jZSB0aGUgZ2l2ZW4gdGltZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZSNlbGFwc2VkU2luY2UKICAgICogQHBhcmFtIHtudW1iZXJ9IHNpbmNlIC0gVGhlIHRpbWUgeW91IHdhbnQgdG8gbWVhc3VyZSBhZ2FpbnN0LgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaWZmZXJlbmNlIGJldHdlZW4gdGhlIGdpdmVuIHRpbWUgYW5kIG5vdy4KICAgICovCiAgICBlbGFwc2VkU2luY2U6IGZ1bmN0aW9uIChzaW5jZSkgewogICAgICAgIHJldHVybiB0aGlzLm5vdyAtIHNpbmNlOwogICAgfSwKCiAgICAvKioKICAgICogSG93IGxvbmcgaGFzIHBhc3NlZCBzaW5jZSB0aGUgZ2l2ZW4gdGltZSAoaW4gc2Vjb25kcykuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWUjZWxhcHNlZFNlY29uZHNTaW5jZQogICAgKiBAcGFyYW0ge251bWJlcn0gc2luY2UgLSBUaGUgdGltZSB5b3Ugd2FudCB0byBtZWFzdXJlIChpbiBzZWNvbmRzKS4KICAgICogQHJldHVybiB7bnVtYmVyfSBEdXJhdGlvbiBiZXR3ZWVuIGdpdmVuIHRpbWUgYW5kIG5vdyAoaW4gc2Vjb25kcykuCiAgICAqLwogICAgZWxhcHNlZFNlY29uZHNTaW5jZTogZnVuY3Rpb24gKHNpbmNlKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLm5vdyAtIHNpbmNlKSAqIDAuMDAxOwogICAgfSwKCiAgICAvKioKICAgICogUmVzZXRzIHRoZSBwcml2YXRlIF9zdGFydGVkIHZhbHVlIHRvIG5vdy4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZSNyZXNldAogICAgKi8KICAgIHJlc2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fc3RhcnRlZCA9IHRoaXMubm93OwogICAgfQoKfTsKClBoYXNlci5UaW1lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5UaW1lOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQSBUaW1lciBpcyBhIHdheSB0byBjcmVhdGUgc21hbGwgcmUtdXNhYmxlIG9yIGRpc3Bvc2FibGUgb2JqZWN0cyB0aGF0IGRvIG5vdGhpbmcgYnV0IHdhaXQgZm9yIGEgc3BlY2lmaWMgbW9tZW50IGluIHRpbWUsIGFuZCB0aGVuIGRpc3BhdGNoIGFuIGV2ZW50LgoqIFlvdSBjYW4gYWRkIGFzIG1hbnkgZXZlbnRzIHRvIGEgVGltZXIgYXMgeW91IGxpa2UsIGVhY2ggd2l0aCB0aGVpciBvd24gZGVsYXlzLiBBIFRpbWVyIHVzZXMgbWlsbGlzZWNvbmRzIGFzIGl0cyB1bml0IG9mIHRpbWUuIFRoZXJlIGFyZSAxMDAwIG1zIGluIDEgc2Vjb25kLgoqIFNvIGlmIHlvdSB3YW50IHRvIGZpcmUgYW4gZXZlbnQgZXZlcnkgcXVhcnRlciBvZiBhIHNlY29uZCB5b3UnZCBuZWVkIHRvIHNldCB0aGUgZGVsYXkgdG8gMjUwLgoqCiogQGNsYXNzIFBoYXNlci5UaW1lcgoqIEBjbGFzc2Rlc2MgQSBUaW1lciBpcyBhIHdheSB0byBjcmVhdGUgc21hbGwgcmUtdXNhYmxlIG9yIGRpc3Bvc2FibGUgb2JqZWN0cyB0aGF0IGRvIG5vdGhpbmcgYnV0IHdhaXQgZm9yIGEgc3BlY2lmaWMgbW9tZW50IGluIHRpbWUsIGFuZCB0aGVuIGRpc3BhdGNoIGFuIGV2ZW50LgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtib29sZWFufSBbYXV0b0Rlc3Ryb3k9dHJ1ZV0gLSBBIFRpbWVyIHRoYXQgaXMgc2V0IHRvIGF1dG9tYXRpY2FsbHkgZGVzdHJveSBpdHNlbGYgd2lsbCBkbyBzbyBhZnRlciBhbGwgb2YgaXRzIGV2ZW50cyBoYXZlIGJlZW4gZGlzcGF0Y2hlZCAoYXNzdW1pbmcgbm8gbG9vcGluZyBldmVudHMpLgoqLwpQaGFzZXIuVGltZXIgPSBmdW5jdGlvbiAoZ2FtZSwgYXV0b0Rlc3Ryb3kpIHsKCiAgICBpZiAodHlwZW9mIGF1dG9EZXN0cm95ID09PSAndW5kZWZpbmVkJykgeyBhdXRvRGVzdHJveSA9IHRydWU7IH0KCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcnVubmluZyAtIFRydWUgaWYgdGhlIFRpbWVyIGlzIGFjdGl2ZWx5IHJ1bm5pbmcuIERvIG5vdCBzd2l0Y2ggdGhpcyBib29sZWFuLCBpZiB5b3Ugd2lzaCB0byBwYXVzZSB0aGUgdGltZXIgdGhlbiB1c2UgVGltZXIucGF1c2UoKSBpbnN0ZWFkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucnVubmluZyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGF1dG9EZXN0cm95IC0gQSBUaW1lciB0aGF0IGlzIHNldCB0byBhdXRvbWF0aWNhbGx5IGRlc3Ryb3kgaXRzZWxmIHdpbGwgZG8gc28gYWZ0ZXIgYWxsIG9mIGl0cyBldmVudHMgaGF2ZSBiZWVuIGRpc3BhdGNoZWQgKGFzc3VtaW5nIG5vIGxvb3BpbmcgZXZlbnRzKS4KICAgICovCiAgICB0aGlzLmF1dG9EZXN0cm95ID0gYXV0b0Rlc3Ryb3k7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZXhwaXJlZCAtIEFuIGV4cGlyZWQgVGltZXIgaXMgb25lIGluIHdoaWNoIGFsbCBvZiBpdHMgZXZlbnRzIGhhdmUgYmVlbiBkaXNwYXRjaGVkIGFuZCBub25lIGFyZSBwZW5kaW5nLgogICAgKiBAcmVhZG9ubHkKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmV4cGlyZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheTxQaGFzZXIuVGltZXJFdmVudD59IGV2ZW50cyAtIEFuIGFycmF5IGhvbGRpbmcgYWxsIG9mIHRoaXMgdGltZXJzIFBoYXNlci5UaW1lckV2ZW50IG9iamVjdHMuIFVzZSB0aGUgbWV0aG9kcyBhZGQsIHJlcGVhdCBhbmQgbG9vcCB0byBwb3B1bGF0ZSBpdC4KICAgICovCiAgICB0aGlzLmV2ZW50cyA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uQ29tcGxldGUgLSBUaGlzIHNpZ25hbCB3aWxsIGJlIGRpc3BhdGNoZWQgd2hlbiB0aGlzIFRpbWVyIGhhcyBjb21wbGV0ZWQsIG1lYW5pbmcgdGhlcmUgYXJlIG5vIG1vcmUgZXZlbnRzIGluIHRoZSBxdWV1ZS4KICAgICovCiAgICB0aGlzLm9uQ29tcGxldGUgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbmV4dFRpY2sgLSBUaGUgdGltZSB0aGUgbmV4dCB0aWNrIHdpbGwgb2NjdXIuCiAgICAqIEByZWFkb25seQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdGhpcy5uZXh0VGljayA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGF1c2VkIC0gVGhlIHBhdXNlZCBzdGF0ZSBvZiB0aGUgVGltZXIuIFlvdSBjYW4gcGF1c2UgdGhlIHRpbWVyIGJ5IGNhbGxpbmcgVGltZXIucGF1c2UoKSBhbmQgVGltZXIucmVzdW1lKCkgb3IgYnkgdGhlIGdhbWUgcGF1c2luZy4KICAgICogQHJlYWRvbmx5CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYXVzZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9zdGFydGVkIC0gVGhlIHRpbWUgYXQgd2hpY2ggdGhpcyBUaW1lciBpbnN0YW5jZSBzdGFydGVkIHJ1bm5pbmcuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fc3RhcnRlZCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfcGF1c2VTdGFydGVkIC0gVGhlIHRpbWUgdGhlIGdhbWUgc3RhcnRlZCBiZWluZyBwYXVzZWQuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fcGF1c2VTdGFydGVkID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9ub3cgLSBUaGUgY3VycmVudCBzdGFydC10aW1lIGFkanVzdGVkIHRpbWUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fbm93ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9sZW4gLSBUZW1wLiBhcnJheSBsZW5ndGggdmFyaWFibGUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fbGVuID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9pIC0gVGVtcC4gYXJyYXkgY291bnRlciB2YXJpYWJsZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9pID0gMDsKCn07CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuVGltZXIuTUlOVVRFID0gNjAwMDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuVGltZXIuU0VDT05EID0gMTAwMDsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5UaW1lci5IQUxGID0gNTAwOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLlRpbWVyLlFVQVJURVIgPSAyNTA7CgpQaGFzZXIuVGltZXIucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IFRpbWVyRXZlbnQgb24gdGhpcyBUaW1lci4gVXNlIHRoZSBtZXRob2RzIGFkZCwgcmVwZWF0IG9yIGxvb3AgaW5zdGVhZCBvZiB0aGlzLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lciNjcmVhdGUKICAgICogQHByaXZhdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdGhhdCBzaG91bGQgZWxhcHNlIGJlZm9yZSB0aGUgVGltZXIgd2lsbCBjYWxsIHRoZSBnaXZlbiBjYWxsYmFjay4KICAgICogQHBhcmFtIHtib29sZWFufSBsb29wIC0gU2hvdWxkIHRoZSBldmVudCBsb29wIG9yIG5vdD8KICAgICogQHBhcmFtIHtudW1iZXJ9IHJlcGVhdENvdW50IC0gVGhlIG51bWJlciBvZiB0aW1lcyB0aGUgZXZlbnQgd2lsbCByZXBlYXQuCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGNhbGxiYWNrIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgVGltZXIgZXZlbnQgb2NjdXJzLgogICAgKiBAcGFyYW0ge29iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkLgogICAgKiBAcGFyYW0ge2FycmF5fSBhcmd1bWVudHMgLSBUaGUgdmFsdWVzIHRvIGJlIHNlbnQgdG8geW91ciBjYWxsYmFjayBmdW5jdGlvbiB3aGVuIGl0IGlzIGNhbGxlZC4KICAgICogQHJldHVybiB7UGhhc2VyLlRpbWVyRXZlbnR9IFRoZSBQaGFzZXIuVGltZXJFdmVudCBvYmplY3QgdGhhdCB3YXMgY3JlYXRlZC4KICAgICovCiAgICBjcmVhdGU6IGZ1bmN0aW9uIChkZWxheSwgbG9vcCwgcmVwZWF0Q291bnQsIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIGFyZ3MpIHsKCiAgICAgICAgdmFyIHRpY2sgPSBkZWxheTsKCiAgICAgICAgaWYgKHRoaXMucnVubmluZykKICAgICAgICB7CiAgICAgICAgICAgIHRpY2sgKz0gdGhpcy5fbm93OwogICAgICAgIH0KCiAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFBoYXNlci5UaW1lckV2ZW50KHRoaXMsIGRlbGF5LCB0aWNrLCByZXBlYXRDb3VudCwgbG9vcCwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgYXJncyk7CgogICAgICAgIHRoaXMuZXZlbnRzLnB1c2goZXZlbnQpOwoKICAgICAgICB0aGlzLm9yZGVyKCk7CgogICAgICAgIHRoaXMuZXhwaXJlZCA9IGZhbHNlOwoKICAgICAgICByZXR1cm4gZXZlbnQ7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyBhIG5ldyBFdmVudCB0byB0aGlzIFRpbWVyLiBUaGUgZXZlbnQgd2lsbCBmaXJlIGFmdGVyIHRoZSBnaXZlbiBhbW91bnQgb2YgJ2RlbGF5JyBpbiBtaWxsaXNlY29uZHMgaGFzIHBhc3NlZCwgb25jZSB0aGUgVGltZXIgaGFzIHN0YXJ0ZWQgcnVubmluZy4KICAgICogQ2FsbCBUaW1lci5zdGFydCgpIG9uY2UgeW91IGhhdmUgYWRkZWQgYWxsIG9mIHRoZSBFdmVudHMgeW91IHJlcXVpcmUgZm9yIHRoaXMgVGltZXIuIFRoZSBkZWxheSBpcyBpbiByZWxhdGlvbiB0byB3aGVuIHRoZSBUaW1lciBzdGFydHMsIG5vdCB0aGUgdGltZSBpdCB3YXMgYWRkZWQuCiAgICAqIElmIHRoZSBUaW1lciBpcyBhbHJlYWR5IHJ1bm5pbmcgdGhlIGRlbGF5IHdpbGwgYmUgY2FsY3VsYXRlZCBiYXNlZCBvbiB0aGUgdGltZXJzIGN1cnJlbnQgdGltZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZXIjYWRkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkZWxheSAtIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRoYXQgc2hvdWxkIGVsYXBzZSBiZWZvcmUgdGhlIFRpbWVyIHdpbGwgY2FsbCB0aGUgZ2l2ZW4gY2FsbGJhY2suCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGNhbGxiYWNrIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgVGltZXIgZXZlbnQgb2NjdXJzLgogICAgKiBAcGFyYW0ge29iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkLgogICAgKiBAcGFyYW0gey4uLip9IGFyZ3VtZW50cyAtIFRoZSB2YWx1ZXMgdG8gYmUgc2VudCB0byB5b3VyIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gaXQgaXMgY2FsbGVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGltZXJFdmVudH0gVGhlIFBoYXNlci5UaW1lckV2ZW50IG9iamVjdCB0aGF0IHdhcyBjcmVhdGVkLgogICAgKi8KICAgIGFkZDogZnVuY3Rpb24gKGRlbGF5LCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZShkZWxheSwgZmFsc2UsIDAsIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDMpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIGEgbmV3IEV2ZW50IHRvIHRoaXMgVGltZXIgdGhhdCB3aWxsIHJlcGVhdCBmb3IgdGhlIGdpdmVuIG51bWJlciBvZiBpdGVyYXRpb25zLgogICAgKiBUaGUgZXZlbnQgd2lsbCBmaXJlIGFmdGVyIHRoZSBnaXZlbiBhbW91bnQgb2YgJ2RlbGF5JyBtaWxsaXNlY29uZHMgaGFzIHBhc3NlZCBvbmNlIHRoZSBUaW1lciBoYXMgc3RhcnRlZCBydW5uaW5nLgogICAgKiBDYWxsIFRpbWVyLnN0YXJ0KCkgb25jZSB5b3UgaGF2ZSBhZGRlZCBhbGwgb2YgdGhlIEV2ZW50cyB5b3UgcmVxdWlyZSBmb3IgdGhpcyBUaW1lci4gVGhlIGRlbGF5IGlzIGluIHJlbGF0aW9uIHRvIHdoZW4gdGhlIFRpbWVyIHN0YXJ0cywgbm90IHRoZSB0aW1lIGl0IHdhcyBhZGRlZC4KICAgICogSWYgdGhlIFRpbWVyIGlzIGFscmVhZHkgcnVubmluZyB0aGUgZGVsYXkgd2lsbCBiZSBjYWxjdWxhdGVkIGJhc2VkIG9uIHRoZSB0aW1lcnMgY3VycmVudCB0aW1lLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lciNyZXBlYXQKICAgICogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdGhhdCBzaG91bGQgZWxhcHNlIGJlZm9yZSB0aGUgVGltZXIgd2lsbCBjYWxsIHRoZSBnaXZlbiBjYWxsYmFjay4KICAgICogQHBhcmFtIHtudW1iZXJ9IHJlcGVhdENvdW50IC0gVGhlIG51bWJlciBvZiB0aW1lcyB0aGUgZXZlbnQgd2lsbCByZXBlYXQuCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGNhbGxiYWNrIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgVGltZXIgZXZlbnQgb2NjdXJzLgogICAgKiBAcGFyYW0ge29iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkLgogICAgKiBAcGFyYW0gey4uLip9IGFyZ3VtZW50cyAtIFRoZSB2YWx1ZXMgdG8gYmUgc2VudCB0byB5b3VyIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gaXQgaXMgY2FsbGVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGltZXJFdmVudH0gVGhlIFBoYXNlci5UaW1lckV2ZW50IG9iamVjdCB0aGF0IHdhcyBjcmVhdGVkLgogICAgKi8KICAgIHJlcGVhdDogZnVuY3Rpb24gKGRlbGF5LCByZXBlYXRDb3VudCwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGUoZGVsYXksIGZhbHNlLCByZXBlYXRDb3VudCwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgNCkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgYSBuZXcgbG9vcGVkIEV2ZW50IHRvIHRoaXMgVGltZXIgdGhhdCB3aWxsIHJlcGVhdCBmb3JldmVyIG9yIHVudGlsIHRoZSBUaW1lciBpcyBzdG9wcGVkLgogICAgKiBUaGUgZXZlbnQgd2lsbCBmaXJlIGFmdGVyIHRoZSBnaXZlbiBhbW91bnQgb2YgJ2RlbGF5JyBtaWxsaXNlY29uZHMgaGFzIHBhc3NlZCBvbmNlIHRoZSBUaW1lciBoYXMgc3RhcnRlZCBydW5uaW5nLgogICAgKiBDYWxsIFRpbWVyLnN0YXJ0KCkgb25jZSB5b3UgaGF2ZSBhZGRlZCBhbGwgb2YgdGhlIEV2ZW50cyB5b3UgcmVxdWlyZSBmb3IgdGhpcyBUaW1lci4gVGhlIGRlbGF5IGlzIGluIHJlbGF0aW9uIHRvIHdoZW4gdGhlIFRpbWVyIHN0YXJ0cywgbm90IHRoZSB0aW1lIGl0IHdhcyBhZGRlZC4KICAgICogSWYgdGhlIFRpbWVyIGlzIGFscmVhZHkgcnVubmluZyB0aGUgZGVsYXkgd2lsbCBiZSBjYWxjdWxhdGVkIGJhc2VkIG9uIHRoZSB0aW1lcnMgY3VycmVudCB0aW1lLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lciNsb29wCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkZWxheSAtIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRoYXQgc2hvdWxkIGVsYXBzZSBiZWZvcmUgdGhlIFRpbWVyIHdpbGwgY2FsbCB0aGUgZ2l2ZW4gY2FsbGJhY2suCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGNhbGxiYWNrIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgVGltZXIgZXZlbnQgb2NjdXJzLgogICAgKiBAcGFyYW0ge29iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkLgogICAgKiBAcGFyYW0gey4uLip9IGFyZ3VtZW50cyAtIFRoZSB2YWx1ZXMgdG8gYmUgc2VudCB0byB5b3VyIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gaXQgaXMgY2FsbGVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGltZXJFdmVudH0gVGhlIFBoYXNlci5UaW1lckV2ZW50IG9iamVjdCB0aGF0IHdhcyBjcmVhdGVkLgogICAgKi8KICAgIGxvb3A6IGZ1bmN0aW9uIChkZWxheSwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGUoZGVsYXksIHRydWUsIDAsIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDMpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdGFydHMgdGhpcyBUaW1lciBydW5uaW5nLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lciNzdGFydAogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbigpIHsKCiAgICAgICAgdGhpcy5fc3RhcnRlZCA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICB0aGlzLnJ1bm5pbmcgPSB0cnVlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3BzIHRoaXMgVGltZXIgZnJvbSBydW5uaW5nLiBEb2VzIG5vdCBjYXVzZSBpdCB0byBiZSBkZXN0cm95ZWQgaWYgYXV0b0Rlc3Ryb3kgaXMgc2V0IHRvIHRydWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWVyI3N0b3AKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5ldmVudHMubGVuZ3RoID0gMDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGEgcGVuZGluZyBUaW1lckV2ZW50IGZyb20gdGhlIHF1ZXVlLgogICAgKiBAcGFyYW0ge1BoYXNlci5UaW1lckV2ZW50fSBldmVudCAtIFRoZSBldmVudCB0byByZW1vdmUgZnJvbSB0aGUgcXVldWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWVyI3JlbW92ZQogICAgKi8KICAgIHJlbW92ZTogZnVuY3Rpb24oZXZlbnQpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmV2ZW50cy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmV2ZW50c1tpXSA9PT0gZXZlbnQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzW2ldLnBlbmRpbmdEZWxldGUgPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBPcmRlcnMgdGhlIGV2ZW50cyBvbiB0aGlzIFRpbWVyIHNvIHRoZXkgYXJlIGluIHRpY2sgb3JkZXIuIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgd2hlbiBuZXcgZXZlbnRzIGFyZSBjcmVhdGVkLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lciNvcmRlcgogICAgKi8KICAgIG9yZGVyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmV2ZW50cy5sZW5ndGggPiAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFNvcnQgdGhlIGV2ZW50cyBzbyB0aGUgb25lIHdpdGggdGhlIGxvd2VzdCB0aWNrIGlzIGZpcnN0CiAgICAgICAgICAgIHRoaXMuZXZlbnRzLnNvcnQodGhpcy5zb3J0SGFuZGxlcik7CgogICAgICAgICAgICB0aGlzLm5leHRUaWNrID0gdGhpcy5ldmVudHNbMF0udGljazsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU29ydCBoYW5kbGVyIHVzZWQgYnkgUGhhc2VyLlRpbWVyLm9yZGVyLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lciNzb3J0SGFuZGxlcgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgc29ydEhhbmRsZXI6IGZ1bmN0aW9uIChhLCBiKSB7CgogICAgICAgIGlmIChhLnRpY2sgPCBiLnRpY2spCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGEudGljayA+IGIudGljaykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIDA7CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIG1haW4gVGltZXIgdXBkYXRlIGV2ZW50LCBjYWxsZWQgYXV0b21hdGljYWxseSBieSB0aGUgR2FtZSBjbG9jay4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZXIjdXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbWUgLSBUaGUgdGltZSBmcm9tIHRoZSBjb3JlIGdhbWUgY2xvY2suCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlcmUgYXJlIHN0aWxsIGV2ZW50cyB3YWl0aW5nIHRvIGJlIGRpc3BhdGNoZWQsIG90aGVyd2lzZSBmYWxzZSBpZiB0aGlzIFRpbWVyIGNhbiBiZSBkZXN0cm95ZWQuCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbih0aW1lKSB7CgogICAgICAgIGlmICh0aGlzLnBhdXNlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fbm93ID0gdGltZSAtIHRoaXMuX3N0YXJ0ZWQ7CgogICAgICAgIHRoaXMuX2xlbiA9IHRoaXMuZXZlbnRzLmxlbmd0aDsKCiAgICAgICAgdGhpcy5faSA9IDA7CgogICAgICAgIHdoaWxlICh0aGlzLl9pIDwgdGhpcy5fbGVuKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuZXZlbnRzW3RoaXMuX2ldLnBlbmRpbmdEZWxldGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzLnNwbGljZSh0aGlzLl9pLCAxKTsKICAgICAgICAgICAgICAgIHRoaXMuX2xlbi0tOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9pKys7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9sZW4gPSB0aGlzLmV2ZW50cy5sZW5ndGg7CgogICAgICAgIGlmICh0aGlzLnJ1bm5pbmcgJiYgdGhpcy5fbm93ID49IHRoaXMubmV4dFRpY2sgJiYgdGhpcy5fbGVuID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2kgPSAwOwoKICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2kgPCB0aGlzLl9sZW4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9ub3cgPj0gdGhpcy5ldmVudHNbdGhpcy5faV0udGljaykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5ldmVudHNbdGhpcy5faV0ubG9vcCA9PT0gdHJ1ZSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzW3RoaXMuX2ldLnRpY2sgKz0gdGhpcy5ldmVudHNbdGhpcy5faV0uZGVsYXkgLSAodGhpcy5fbm93IC0gdGhpcy5ldmVudHNbdGhpcy5faV0udGljayk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzW3RoaXMuX2ldLmNhbGxiYWNrLmFwcGx5KHRoaXMuZXZlbnRzW3RoaXMuX2ldLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5ldmVudHNbdGhpcy5faV0uYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZXZlbnRzW3RoaXMuX2ldLnJlcGVhdENvdW50ID4gMCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzW3RoaXMuX2ldLnJlcGVhdENvdW50LS07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzW3RoaXMuX2ldLnRpY2sgKz0gdGhpcy5ldmVudHNbdGhpcy5faV0uZGVsYXkgLSAodGhpcy5fbm93IC0gdGhpcy5ldmVudHNbdGhpcy5faV0udGljayk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzW3RoaXMuX2ldLmNhbGxiYWNrLmFwcGx5KHRoaXMuZXZlbnRzW3RoaXMuX2ldLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5ldmVudHNbdGhpcy5faV0uYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzW3RoaXMuX2ldLmNhbGxiYWNrLmFwcGx5KHRoaXMuZXZlbnRzW3RoaXMuX2ldLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5ldmVudHNbdGhpcy5faV0uYXJncyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzLnNwbGljZSh0aGlzLl9pLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbGVuLS07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0aGlzLl9pKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBBcmUgdGhlcmUgYW55IGV2ZW50cyBsZWZ0PwogICAgICAgICAgICBpZiAodGhpcy5ldmVudHMubGVuZ3RoID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5vcmRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMub25Db21wbGV0ZS5kaXNwYXRjaCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZXhwaXJlZCAmJiB0aGlzLmF1dG9EZXN0cm95KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUGF1c2VzIHRoZSBUaW1lciBhbmQgYWxsIGV2ZW50cyBpbiB0aGUgcXVldWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWVyI3BhdXNlCiAgICAqLwogICAgcGF1c2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5ydW5uaW5nICYmICF0aGlzLmV4cGlyZWQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wYXVzZVN0YXJ0ZWQgPSB0aGlzLmdhbWUudGltZS5ub3c7CgogICAgICAgICAgICB0aGlzLnBhdXNlZCA9IHRydWU7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlc3VtZXMgdGhlIFRpbWVyIGFuZCB1cGRhdGVzIGFsbCBwZW5kaW5nIGV2ZW50cy4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZXIjcmVzdW1lCiAgICAqLwogICAgcmVzdW1lOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnJ1bm5pbmcgJiYgIXRoaXMuZXhwaXJlZCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXVzZUR1cmF0aW9uID0gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fcGF1c2VTdGFydGVkOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmV2ZW50cy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5ldmVudHNbaV0udGljayArPSBwYXVzZUR1cmF0aW9uOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm5leHRUaWNrICs9IHBhdXNlRHVyYXRpb247CgogICAgICAgICAgICB0aGlzLnBhdXNlZCA9IGZhbHNlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBEZXN0cm95cyB0aGlzIFRpbWVyLiBFdmVudHMgYXJlIG5vdCBkaXNwYXRjaGVkLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lciNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CgogICAgICAgIHRoaXMub25Db21wbGV0ZS5yZW1vdmVBbGwoKTsKICAgICAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLmV2ZW50cyA9IFtdOwogICAgICAgIHRoaXMuX2kgPSB0aGlzLl9sZW47CgogICAgfQoKfTsKCi8qKgoqIEBuYW1lIFBoYXNlci5UaW1lciNuZXh0CiogQHByb3BlcnR5IHtudW1iZXJ9IG5leHQgLSBUaGUgdGltZSBhdCB3aGljaCB0aGUgbmV4dCBldmVudCB3aWxsIG9jY3VyLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbWVyLnByb3RvdHlwZSwgIm5leHQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubmV4dFRpY2s7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5UaW1lciNkdXJhdGlvbgoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkdXJhdGlvbiAtIFRoZSBkdXJhdGlvbiBpbiBtcyByZW1haW5pbmcgdW50aWwgdGhlIG5leHQgZXZlbnQgd2lsbCBvY2N1ci4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaW1lci5wcm90b3R5cGUsICJkdXJhdGlvbiIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5ydW5uaW5nICYmIHRoaXMubmV4dFRpY2sgPiB0aGlzLl9ub3cpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5uZXh0VGljayAtIHRoaXMuX25vdzsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbWVyI2xlbmd0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsZW5ndGggLSBUaGUgbnVtYmVyIG9mIHBlbmRpbmcgZXZlbnRzIGluIHRoZSBxdWV1ZS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaW1lci5wcm90b3R5cGUsICJsZW5ndGgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRzLmxlbmd0aDsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbWVyI21zCiogQHByb3BlcnR5IHtudW1iZXJ9IG1zIC0gVGhlIGR1cmF0aW9uIGluIG1pbGxpc2Vjb25kcyB0aGF0IHRoaXMgVGltZXIgaGFzIGJlZW4gcnVubmluZyBmb3IuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGltZXIucHJvdG90eXBlLCAibXMiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX25vdzsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbWVyI3NlY29uZHMKKiBAcHJvcGVydHkge251bWJlcn0gc2Vjb25kcyAtIFRoZSBkdXJhdGlvbiBpbiBzZWNvbmRzIHRoYXQgdGhpcyBUaW1lciBoYXMgYmVlbiBydW5uaW5nIGZvci4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaW1lci5wcm90b3R5cGUsICJzZWNvbmRzIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9ub3cgKiAwLjAwMTsKICAgIH0KCn0pOwoKUGhhc2VyLlRpbWVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5UaW1lcjsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgVGltZXJFdmVudCBpcyBhIHNpbmdsZSBldmVudCB0aGF0IGlzIHByb2Nlc3NlZCBieSBhIFBoYXNlci5UaW1lci4gSXQgY29uc2lzdHMgb2YgYSBkZWxheSwgd2hpY2ggaXMgYSB2YWx1ZSBpbiBtaWxsaXNlY29uZHMgYWZ0ZXIgd2hpY2ggdGhlIGV2ZW50IHdpbGwgZmlyZS4KKiBJdCBjYW4gY2FsbCBhIHNwZWNpZmljIGNhbGxiYWNrLCBwYXNzaW5nIGluIG9wdGlvbmFsIHBhcmFtZXRlcnMuCioKKiBAY2xhc3MgUGhhc2VyLlRpbWVyRXZlbnQKKiBAY2xhc3NkZXNjIEEgVGltZXJFdmVudCBpcyBhIHNpbmdsZSBldmVudCB0aGF0IGlzIHByb2Nlc3NlZCBieSBhIFBoYXNlci5UaW1lci4gSXQgY29uc2lzdHMgb2YgYSBkZWxheSwgd2hpY2ggaXMgYSB2YWx1ZSBpbiBtaWxsaXNlY29uZHMgYWZ0ZXIgd2hpY2ggdGhlIGV2ZW50IHdpbGwgZmlyZS4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5UaW1lcn0gdGltZXIgLSBUaGUgVGltZXIgb2JqZWN0IHRoYXQgdGhpcyBUaW1lckV2ZW50IGJlbG9uZ3MgdG8uCiogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIGRlbGF5IGluIG1zIGF0IHdoaWNoIHRoaXMgVGltZXJFdmVudCBmaXJlcy4KKiBAcGFyYW0ge251bWJlcn0gdGljayAtIFRoZSB0aWNrIGlzIHRoZSBuZXh0IGdhbWUgY2xvY2sgdGltZSB0aGF0IHRoaXMgZXZlbnQgd2lsbCBmaXJlIGF0LgoqIEBwYXJhbSB7bnVtYmVyfSByZXBlYXRDb3VudCAtIElmIHRoaXMgVGltZXJFdmVudCByZXBlYXRzIGl0IHdpbGwgZG8gc28gdGhpcyBtYW55IHRpbWVzLgoqIEBwYXJhbSB7Ym9vbGVhbn0gbG9vcCAtIFRydWUgaWYgdGhpcyBUaW1lckV2ZW50IGxvb3BzLCBvdGhlcndpc2UgZmFsc2UuCiogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBUaW1lckV2ZW50IG9jY3Vycy4KKiBAcGFyYW0ge29iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkLgoqIEBwYXJhbSB7YXJyYXl9IGFyZ3VtZW50cyAtIFRoZSB2YWx1ZXMgdG8gYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjay4KKi8KUGhhc2VyLlRpbWVyRXZlbnQgPSBmdW5jdGlvbiAodGltZXIsIGRlbGF5LCB0aWNrLCByZXBlYXRDb3VudCwgbG9vcCwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgYXJncykgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5UaW1lcn0gdGltZXIgLSBUaGUgVGltZXIgb2JqZWN0IHRoYXQgdGhpcyBUaW1lckV2ZW50IGJlbG9uZ3MgdG8uCiAgICAqLwoJdGhpcy50aW1lciA9IHRpbWVyOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZGVsYXkgLSBUaGUgZGVsYXkgaW4gbXMgYXQgd2hpY2ggdGhpcyBUaW1lckV2ZW50IGZpcmVzLgogICAgKi8KCXRoaXMuZGVsYXkgPSBkZWxheTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRpY2sgLSBUaGUgdGljayBpcyB0aGUgbmV4dCBnYW1lIGNsb2NrIHRpbWUgdGhhdCB0aGlzIGV2ZW50IHdpbGwgZmlyZSBhdC4KICAgICovCgl0aGlzLnRpY2sgPSB0aWNrOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcmVwZWF0Q291bnQgLSBJZiB0aGlzIFRpbWVyRXZlbnQgcmVwZWF0cyBpdCB3aWxsIGRvIHNvIHRoaXMgbWFueSB0aW1lcy4KICAgICovCgl0aGlzLnJlcGVhdENvdW50ID0gcmVwZWF0Q291bnQgLSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGxvb3AgLSBUcnVlIGlmIHRoaXMgVGltZXJFdmVudCBsb29wcywgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KCXRoaXMubG9vcCA9IGxvb3A7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGNhbGxiYWNrIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgVGltZXJFdmVudCBvY2N1cnMuCiAgICAqLwoJdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkLgogICAgKi8KCXRoaXMuY2FsbGJhY2tDb250ZXh0ID0gY2FsbGJhY2tDb250ZXh0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBhcmd1bWVudHMgLSBUaGUgdmFsdWVzIHRvIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2suCiAgICAqLwoJdGhpcy5hcmdzID0gYXJnczsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBwZW5kaW5nRGVsZXRlIC0gQSBmbGFnIHRoYXQgY29udHJvbHMgaWYgdGhlIFRpbWVyRXZlbnQgaXMgcGVuZGluZyBkZWxldGlvbi4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHRoaXMucGVuZGluZ0RlbGV0ZSA9IGZhbHNlOwoKfTsKClBoYXNlci5UaW1lckV2ZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5UaW1lckV2ZW50OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIEFuaW1hdGlvbiBNYW5hZ2VyIGlzIHVzZWQgdG8gYWRkLCBwbGF5IGFuZCB1cGRhdGUgUGhhc2VyIEFuaW1hdGlvbnMuCiogQW55IEdhbWUgT2JqZWN0IHN1Y2ggYXMgUGhhc2VyLlNwcml0ZSB0aGF0IHN1cHBvcnRzIGFuaW1hdGlvbiBjb250YWlucyBhIHNpbmdsZSBBbmltYXRpb25NYW5hZ2VyIGluc3RhbmNlLgoqCiogQGNsYXNzIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBBIHJlZmVyZW5jZSB0byB0aGUgR2FtZSBPYmplY3QgdGhhdCBvd25zIHRoaXMgQW5pbWF0aW9uTWFuYWdlci4KKi8KUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIgPSBmdW5jdGlvbiAoc3ByaXRlKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gQSByZWZlcmVuY2UgdG8gdGhlIHBhcmVudCBTcHJpdGUgdGhhdCBvd25zIHRoaXMgQW5pbWF0aW9uTWFuYWdlci4KICAgICovCiAgICB0aGlzLnNwcml0ZSA9IHNwcml0ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IHNwcml0ZS5nYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5GcmFtZX0gY3VycmVudEZyYW1lIC0gVGhlIGN1cnJlbnRseSBkaXNwbGF5ZWQgRnJhbWUgb2YgYW5pbWF0aW9uLCBpZiBhbnkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jdXJyZW50RnJhbWUgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB1cGRhdGVJZlZpc2libGUgLSBTaG91bGQgdGhlIGFuaW1hdGlvbiBkYXRhIGNvbnRpbnVlIHRvIHVwZGF0ZSBldmVuIGlmIHRoZSBTcHJpdGUudmlzaWJsZSBpcyBzZXQgdG8gZmFsc2UuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy51cGRhdGVJZlZpc2libGUgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzTG9hZGVkIC0gU2V0IHRvIHRydWUgb25jZSBhbmltYXRpb24gZGF0YSBoYXMgYmVlbiBsb2FkZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc0xvYWRlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5GcmFtZURhdGF9IF9mcmFtZURhdGEgLSBBIHRlbXAuIHZhciBmb3IgaG9sZGluZyB0aGUgY3VycmVudGx5IHBsYXlpbmcgQW5pbWF0aW9ucyBGcmFtZURhdGEuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fZnJhbWVEYXRhID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF9hbmltcyAtIEFuIGludGVybmFsIG9iamVjdCB0aGF0IHN0b3JlcyBhbGwgb2YgdGhlIEFuaW1hdGlvbiBpbnN0YW5jZXMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fYW5pbXMgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF9vdXRwdXRGcmFtZXMgLSBBbiBpbnRlcm5hbCBvYmplY3QgdG8gaGVscCBhdm9pZCBnYy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vdXRwdXRGcmFtZXMgPSBbXTsKCn07CgpQaGFzZXIuQW5pbWF0aW9uTWFuYWdlci5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIExvYWRzIEZyYW1lRGF0YSBpbnRvIHRoZSBpbnRlcm5hbCB0ZW1wb3JhcnkgdmFycyBhbmQgcmVzZXRzIHRoZSBmcmFtZSBpbmRleCB0byB6ZXJvLgogICAgKiBUaGlzIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5IHdoZW4gYSBuZXcgU3ByaXRlIGlzIGNyZWF0ZWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjbG9hZEZyYW1lRGF0YQogICAgKiBAcHJpdmF0ZQogICAgKiBAcGFyYW0ge1BoYXNlci5GcmFtZURhdGF9IGZyYW1lRGF0YSAtIFRoZSBGcmFtZURhdGEgc2V0IHRvIGxvYWQuCiAgICAqLwogICAgbG9hZEZyYW1lRGF0YTogZnVuY3Rpb24gKGZyYW1lRGF0YSkgewoKICAgICAgICB0aGlzLl9mcmFtZURhdGEgPSBmcmFtZURhdGE7CiAgICAgICAgdGhpcy5mcmFtZSA9IDA7CiAgICAgICAgdGhpcy5pc0xvYWRlZCA9IHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyBhIG5ldyBhbmltYXRpb24gdW5kZXIgdGhlIGdpdmVuIGtleS4gT3B0aW9uYWxseSBzZXQgdGhlIGZyYW1lcywgZnJhbWUgcmF0ZSBhbmQgbG9vcC4KICAgICogQW5pbWF0aW9ucyBhZGRlZCBpbiB0aGlzIHdheSBhcmUgcGxheWVkIGJhY2sgd2l0aCB0aGUgcGxheSBmdW5jdGlvbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNhZGQKICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgdW5pcXVlICh3aXRoaW4gdGhpcyBTcHJpdGUpIG5hbWUgZm9yIHRoZSBhbmltYXRpb24sIGkuZS4gInJ1biIsICJmaXJlIiwgIndhbGsiLgogICAgKiBAcGFyYW0ge0FycmF5fSBbZnJhbWVzPW51bGxdIC0gQW4gYXJyYXkgb2YgbnVtYmVycy9zdHJpbmdzIHRoYXQgY29ycmVzcG9uZCB0byB0aGUgZnJhbWVzIHRvIGFkZCB0byB0aGlzIGFuaW1hdGlvbiBhbmQgaW4gd2hpY2ggb3JkZXIuIGUuZy4gWzEsIDIsIDNdIG9yIFsncnVuMCcsICdydW4xJywgcnVuMl0pLiBJZiBudWxsIHRoZW4gYWxsIGZyYW1lcyB3aWxsIGJlIHVzZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJhbWVSYXRlPTYwXSAtIFRoZSBzcGVlZCBhdCB3aGljaCB0aGUgYW5pbWF0aW9uIHNob3VsZCBwbGF5LiBUaGUgc3BlZWQgaXMgZ2l2ZW4gaW4gZnJhbWVzIHBlciBzZWNvbmQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gV2hldGhlciBvciBub3QgdGhlIGFuaW1hdGlvbiBpcyBsb29wZWQgb3IganVzdCBwbGF5cyBvbmNlLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt1c2VOdW1lcmljSW5kZXg9dHJ1ZV0gLSBBcmUgdGhlIGdpdmVuIGZyYW1lcyB1c2luZyBudW1lcmljIGluZGV4ZXMgKGRlZmF1bHQpIG9yIHN0cmluZ3M/CiAgICAqIEByZXR1cm4ge1BoYXNlci5BbmltYXRpb259IFRoZSBBbmltYXRpb24gb2JqZWN0IHRoYXQgd2FzIGNyZWF0ZWQuCiAgICAqLwogICAgYWRkOiBmdW5jdGlvbiAobmFtZSwgZnJhbWVzLCBmcmFtZVJhdGUsIGxvb3AsIHVzZU51bWVyaWNJbmRleCkgewoKICAgICAgICBpZiAodGhpcy5fZnJhbWVEYXRhID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ05vIEZyYW1lRGF0YSBhdmFpbGFibGUgZm9yIFBoYXNlci5BbmltYXRpb24gJyArIG5hbWUpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmcmFtZVJhdGUgPSBmcmFtZVJhdGUgfHwgNjA7CgogICAgICAgIGlmICh0eXBlb2YgbG9vcCA9PT0gJ3VuZGVmaW5lZCcpIHsgbG9vcCA9IGZhbHNlOyB9CgogICAgICAgIC8vICBJZiB0aGV5IGRpZG4ndCBzZXQgdGhlIHVzZU51bWVyaWNJbmRleCB0aGVuIGxldCdzIGF0IGxlYXN0IHRyeSBhbmQgZ3Vlc3MgaXQKICAgICAgICBpZiAodHlwZW9mIHVzZU51bWVyaWNJbmRleCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZnJhbWVzICYmIHR5cGVvZiBmcmFtZXNbMF0gPT09ICdudW1iZXInKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB1c2VOdW1lcmljSW5kZXggPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdXNlTnVtZXJpY0luZGV4ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vICBDcmVhdGUgdGhlIHNpZ25hbHMgdGhlIEFuaW1hdGlvbk1hbmFnZXIgd2lsbCBlbWl0CiAgICAgICAgaWYgKHRoaXMuc3ByaXRlLmV2ZW50cy5vbkFuaW1hdGlvblN0YXJ0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25BbmltYXRpb25TdGFydCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbkFuaW1hdGlvbkNvbXBsZXRlID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uQW5pbWF0aW9uTG9vcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9vdXRwdXRGcmFtZXMubGVuZ3RoID0gMDsKCiAgICAgICAgdGhpcy5fZnJhbWVEYXRhLmdldEZyYW1lSW5kZXhlcyhmcmFtZXMsIHVzZU51bWVyaWNJbmRleCwgdGhpcy5fb3V0cHV0RnJhbWVzKTsKCiAgICAgICAgdGhpcy5fYW5pbXNbbmFtZV0gPSBuZXcgUGhhc2VyLkFuaW1hdGlvbih0aGlzLmdhbWUsIHRoaXMuc3ByaXRlLCBuYW1lLCB0aGlzLl9mcmFtZURhdGEsIHRoaXMuX291dHB1dEZyYW1lcywgZnJhbWVSYXRlLCBsb29wKTsKICAgICAgICB0aGlzLmN1cnJlbnRBbmltID0gdGhpcy5fYW5pbXNbbmFtZV07CiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLmN1cnJlbnRBbmltLmN1cnJlbnRGcmFtZTsKICAgICAgICB0aGlzLnNwcml0ZS5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKCiAgICAgICAgcmV0dXJuIHRoaXMuX2FuaW1zW25hbWVdOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrIHdoZXRoZXIgdGhlIGZyYW1lcyBpbiB0aGUgZ2l2ZW4gYXJyYXkgYXJlIHZhbGlkIGFuZCBleGlzdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciN2YWxpZGF0ZUZyYW1lcwogICAgKiBAcGFyYW0ge0FycmF5fSBmcmFtZXMgLSBBbiBhcnJheSBvZiBmcmFtZXMgdG8gYmUgdmFsaWRhdGVkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt1c2VOdW1lcmljSW5kZXg9dHJ1ZV0gLSBWYWxpZGF0ZSB0aGUgZnJhbWVzIGJhc2VkIG9uIHRoZWlyIG51bWVyaWMgaW5kZXggKHRydWUpIG9yIHN0cmluZyBpbmRleCAoZmFsc2UpCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgYWxsIGdpdmVuIEZyYW1lcyBhcmUgdmFsaWQsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICB2YWxpZGF0ZUZyYW1lczogZnVuY3Rpb24gKGZyYW1lcywgdXNlTnVtZXJpY0luZGV4KSB7CgogICAgICAgIGlmICh0eXBlb2YgdXNlTnVtZXJpY0luZGV4ID09ICd1bmRlZmluZWQnKSB7IHVzZU51bWVyaWNJbmRleCA9IHRydWU7IH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmcmFtZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodXNlTnVtZXJpY0luZGV4ID09PSB0cnVlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZnJhbWVzW2ldID4gdGhpcy5fZnJhbWVEYXRhLnRvdGFsKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9mcmFtZURhdGEuY2hlY2tGcmFtZU5hbWUoZnJhbWVzW2ldKSA9PT0gZmFsc2UpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQbGF5IGFuIGFuaW1hdGlvbiBiYXNlZCBvbiB0aGUgZ2l2ZW4ga2V5LiBUaGUgYW5pbWF0aW9uIHNob3VsZCBwcmV2aW91c2x5IGhhdmUgYmVlbiBhZGRlZCB2aWEgc3ByaXRlLmFuaW1hdGlvbnMuYWRkKCkKICAgICogSWYgdGhlIHJlcXVlc3RlZCBhbmltYXRpb24gaXMgYWxyZWFkeSBwbGF5aW5nIHRoaXMgcmVxdWVzdCB3aWxsIGJlIGlnbm9yZWQuIElmIHlvdSBuZWVkIHRvIHJlc2V0IGFuIGFscmVhZHkgcnVubmluZyBhbmltYXRpb24gZG8gc28gZGlyZWN0bHkgb24gdGhlIEFuaW1hdGlvbiBvYmplY3QgaXRzZWxmLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNwbGF5CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGFuaW1hdGlvbiB0byBiZSBwbGF5ZWQsIGUuZy4gImZpcmUiLCAid2FsayIsICJqdW1wIi4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcmFtZVJhdGU9bnVsbF0gLSBUaGUgZnJhbWVyYXRlIHRvIHBsYXkgdGhlIGFuaW1hdGlvbiBhdC4gVGhlIHNwZWVkIGlzIGdpdmVuIGluIGZyYW1lcyBwZXIgc2Vjb25kLiBJZiBub3QgcHJvdmlkZWQgdGhlIHByZXZpb3VzbHkgc2V0IGZyYW1lUmF0ZSBvZiB0aGUgQW5pbWF0aW9uIGlzIHVzZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gU2hvdWxkIHRoZSBhbmltYXRpb24gYmUgbG9vcGVkIGFmdGVyIHBsYXliYWNrLiBJZiBub3QgcHJvdmlkZWQgdGhlIHByZXZpb3VzbHkgc2V0IGxvb3AgdmFsdWUgb2YgdGhlIEFuaW1hdGlvbiBpcyB1c2VkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtraWxsT25Db21wbGV0ZT1mYWxzZV0gLSBJZiBzZXQgdG8gdHJ1ZSB3aGVuIHRoZSBhbmltYXRpb24gY29tcGxldGVzIChvbmx5IGhhcHBlbnMgaWYgbG9vcD1mYWxzZSkgdGhlIHBhcmVudCBTcHJpdGUgd2lsbCBiZSBraWxsZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5BbmltYXRpb259IEEgcmVmZXJlbmNlIHRvIHBsYXlpbmcgQW5pbWF0aW9uIGluc3RhbmNlLgogICAgKi8KICAgIHBsYXk6IGZ1bmN0aW9uIChuYW1lLCBmcmFtZVJhdGUsIGxvb3AsIGtpbGxPbkNvbXBsZXRlKSB7CgogICAgICAgIGlmICh0aGlzLl9hbmltc1tuYW1lXSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRBbmltID09IHRoaXMuX2FuaW1zW25hbWVdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50QW5pbS5pc1BsYXlpbmcgPT09IGZhbHNlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEFuaW0ucGF1c2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEFuaW0ucGxheShmcmFtZVJhdGUsIGxvb3AsIGtpbGxPbkNvbXBsZXRlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEFuaW0gPSB0aGlzLl9hbmltc1tuYW1lXTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEFuaW0ucGF1c2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50QW5pbS5wbGF5KGZyYW1lUmF0ZSwgbG9vcCwga2lsbE9uQ29tcGxldGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3AgcGxheWJhY2sgb2YgYW4gYW5pbWF0aW9uLiBJZiBhIG5hbWUgaXMgZ2l2ZW4gdGhhdCBzcGVjaWZpYyBhbmltYXRpb24gaXMgc3RvcHBlZCwgb3RoZXJ3aXNlIHRoZSBjdXJyZW50IGFuaW1hdGlvbiBpcyBzdG9wcGVkLgogICAgKiBUaGUgY3VycmVudEFuaW0gcHJvcGVydHkgb2YgdGhlIEFuaW1hdGlvbk1hbmFnZXIgaXMgYXV0b21hdGljYWxseSBzZXQgdG8gdGhlIGFuaW1hdGlvbiBnaXZlbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNzdG9wCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbbmFtZT1udWxsXSAtIFRoZSBuYW1lIG9mIHRoZSBhbmltYXRpb24gdG8gYmUgc3RvcHBlZCwgZS5nLiAiZmlyZSIuIElmIG5vbmUgaXMgZ2l2ZW4gdGhlIGN1cnJlbnRseSBydW5uaW5nIGFuaW1hdGlvbiBpcyBzdG9wcGVkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXNldEZyYW1lPWZhbHNlXSAtIFdoZW4gdGhlIGFuaW1hdGlvbiBpcyBzdG9wcGVkIHNob3VsZCB0aGUgY3VycmVudEZyYW1lIGJlIHNldCB0byB0aGUgZmlyc3QgZnJhbWUgb2YgdGhlIGFuaW1hdGlvbiAodHJ1ZSkgb3IgcGF1c2VkIG9uIHRoZSBsYXN0IGZyYW1lIGRpc3BsYXllZCAoZmFsc2UpCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKG5hbWUsIHJlc2V0RnJhbWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiByZXNldEZyYW1lID09ICd1bmRlZmluZWQnKSB7IHJlc2V0RnJhbWUgPSBmYWxzZTsgfQoKICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fYW5pbXNbbmFtZV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEFuaW0gPSB0aGlzLl9hbmltc1tuYW1lXTsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEFuaW0uc3RvcChyZXNldEZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50QW5pbSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50QW5pbS5zdG9wKHJlc2V0RnJhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBtYWluIHVwZGF0ZSBmdW5jdGlvbiBpcyBjYWxsZWQgYnkgdGhlIFNwcml0ZXMgdXBkYXRlIGxvb3AuIEl0J3MgcmVzcG9uc2libGUgZm9yIHVwZGF0aW5nIGFuaW1hdGlvbiBmcmFtZXMgYW5kIGZpcmluZyByZWxhdGVkIGV2ZW50cy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjdXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBhIG5ldyBhbmltYXRpb24gZnJhbWUgaGFzIGJlZW4gc2V0LCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnVwZGF0ZUlmVmlzaWJsZSAmJiB0aGlzLnNwcml0ZS52aXNpYmxlID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmN1cnJlbnRBbmltICYmIHRoaXMuY3VycmVudEFuaW0udXBkYXRlKCkgPT09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuY3VycmVudEFuaW0uY3VycmVudEZyYW1lOwogICAgICAgICAgICB0aGlzLnNwcml0ZS5jdXJyZW50RnJhbWUgPSB0aGlzLmN1cnJlbnRGcmFtZTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhbiBhbmltYXRpb24gdGhhdCB3YXMgcHJldmlvdXNseSBhZGRlZCBieSBuYW1lLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2dldEFuaW1hdGlvbgogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBhbmltYXRpb24gdG8gYmUgcmV0dXJuZWQsIGUuZy4gImZpcmUiLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQW5pbWF0aW9ufSBUaGUgQW5pbWF0aW9uIGluc3RhbmNlLCBpZiBmb3VuZCwgb3RoZXJ3aXNlIG51bGwuCiAgICAqLwogICAgZ2V0QW5pbWF0aW9uOiBmdW5jdGlvbiAobmFtZSkgewoKICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fYW5pbXNbbmFtZV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9hbmltc1tuYW1lXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogUmVmcmVzaGVzIHRoZSBjdXJyZW50IGZyYW1lIGRhdGEgYmFjayB0byB0aGUgcGFyZW50IFNwcml0ZSBhbmQgYWxzbyByZXNldHMgdGhlIHRleHR1cmUgZGF0YS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNyZWZyZXNoRnJhbWUKICAgICovCiAgICByZWZyZXNoRnJhbWU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5zcHJpdGUuY3VycmVudEZyYW1lID0gdGhpcy5jdXJyZW50RnJhbWU7CiAgICAgICAgdGhpcy5zcHJpdGUuc2V0VGV4dHVyZShQSVhJLlRleHR1cmVDYWNoZVt0aGlzLmN1cnJlbnRGcmFtZS51dWlkXSk7CgogICAgfSwKCiAgICAvKioKICAgICogRGVzdHJveXMgYWxsIHJlZmVyZW5jZXMgdGhpcyBBbmltYXRpb25NYW5hZ2VyIGNvbnRhaW5zLiBTZXRzIHRoZSBfYW5pbXMgdG8gYSBuZXcgb2JqZWN0IGFuZCBudWxscyB0aGUgY3VycmVudCBhbmltYXRpb24uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fYW5pbXMgPSB7fTsKICAgICAgICB0aGlzLl9mcmFtZURhdGEgPSBudWxsOwogICAgICAgIHRoaXMuX2ZyYW1lSW5kZXggPSAwOwogICAgICAgIHRoaXMuY3VycmVudEFuaW0gPSBudWxsOwogICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gbnVsbDsKCiAgICB9Cgp9OwoKUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXI7CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNmcmFtZURhdGEKKiBAcHJvcGVydHkge1BoYXNlci5GcmFtZURhdGF9IGZyYW1lRGF0YSAtIFRoZSBjdXJyZW50IGFuaW1hdGlvbnMgRnJhbWVEYXRhLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIucHJvdG90eXBlLCAnZnJhbWVEYXRhJywgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9mcmFtZURhdGE7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2ZyYW1lVG90YWwKKiBAcHJvcGVydHkge251bWJlcn0gZnJhbWVUb3RhbCAtIFRoZSB0b3RhbCBudW1iZXIgb2YgZnJhbWVzIGluIHRoZSBjdXJyZW50bHkgbG9hZGVkIEZyYW1lRGF0YSwgb3IgLTEgaWYgbm8gRnJhbWVEYXRhIGlzIGxvYWRlZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5BbmltYXRpb25NYW5hZ2VyLnByb3RvdHlwZSwgJ2ZyYW1lVG90YWwnLCB7CiAKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fZnJhbWVEYXRhKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZyYW1lRGF0YS50b3RhbDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjcGF1c2VkCiogQHByb3BlcnR5IHtib29sZWFufSBwYXVzZWQgLSBHZXRzIGFuZCBzZXRzIHRoZSBwYXVzZWQgc3RhdGUgb2YgdGhlIGN1cnJlbnQgYW5pbWF0aW9uLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIucHJvdG90eXBlLCAncGF1c2VkJywgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50QW5pbS5pc1BhdXNlZDsKCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHRoaXMuY3VycmVudEFuaW0ucGF1c2VkID0gdmFsdWU7CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNmcmFtZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcmFtZSAtIEdldHMgb3Igc2V0cyB0aGUgY3VycmVudCBmcmFtZSBpbmRleCBhbmQgdXBkYXRlcyB0aGUgVGV4dHVyZSBDYWNoZSBmb3IgZGlzcGxheS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5BbmltYXRpb25NYW5hZ2VyLnByb3RvdHlwZSwgJ2ZyYW1lJywgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5jdXJyZW50RnJhbWUpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZnJhbWVJbmRleDsKICAgICAgICB9CiAgICAgICAgCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInICYmIHRoaXMuX2ZyYW1lRGF0YSAmJiB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodmFsdWUpICE9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodmFsdWUpOwogICAgICAgICAgICB0aGlzLl9mcmFtZUluZGV4ID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmN1cnJlbnRGcmFtZSA9IHRoaXMuY3VycmVudEZyYW1lOwogICAgICAgICAgICB0aGlzLnNwcml0ZS5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNmcmFtZU5hbWUKKiBAcHJvcGVydHkge3N0cmluZ30gZnJhbWVOYW1lIC0gR2V0cyBvciBzZXRzIHRoZSBjdXJyZW50IGZyYW1lIG5hbWUgYW5kIHVwZGF0ZXMgdGhlIFRleHR1cmUgQ2FjaGUgZm9yIGRpc3BsYXkuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQW5pbWF0aW9uTWFuYWdlci5wcm90b3R5cGUsICdmcmFtZU5hbWUnLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmN1cnJlbnRGcmFtZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRGcmFtZS5uYW1lOwogICAgICAgIH0KCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmIHRoaXMuX2ZyYW1lRGF0YSAmJiB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWVCeU5hbWUodmFsdWUpICE9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWVCeU5hbWUodmFsdWUpOwogICAgICAgICAgICB0aGlzLl9mcmFtZUluZGV4ID0gdGhpcy5jdXJyZW50RnJhbWUuaW5kZXg7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmN1cnJlbnRGcmFtZSA9IHRoaXMuY3VycmVudEZyYW1lOwogICAgICAgICAgICB0aGlzLnNwcml0ZS5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdDYW5ub3Qgc2V0IGZyYW1lTmFtZTogJyArIHZhbHVlKTsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEFuIEFuaW1hdGlvbiBpbnN0YW5jZSBjb250YWlucyBhIHNpbmdsZSBhbmltYXRpb24gYW5kIHRoZSBjb250cm9scyB0byBwbGF5IGl0LgoqIEl0IGlzIGNyZWF0ZWQgYnkgdGhlIEFuaW1hdGlvbk1hbmFnZXIsIGNvbnNpc3RzIG9mIEFuaW1hdGlvbi5GcmFtZSBvYmplY3RzIGFuZCBiZWxvbmdzIHRvIGEgc2luZ2xlIEdhbWUgT2JqZWN0IHN1Y2ggYXMgYSBTcHJpdGUuCioKKiBAY2xhc3MgUGhhc2VyLkFuaW1hdGlvbgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHBhcmVudCAtIEEgcmVmZXJlbmNlIHRvIHRoZSBvd25lciBvZiB0aGlzIEFuaW1hdGlvbi4KKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSB1bmlxdWUgbmFtZSBmb3IgdGhpcyBhbmltYXRpb24sIHVzZWQgaW4gcGxheWJhY2sgY29tbWFuZHMuCiogQHBhcmFtIHtQaGFzZXIuRnJhbWVEYXRhfSBmcmFtZURhdGEgLSBUaGUgRnJhbWVEYXRhIG9iamVjdCB0aGF0IGNvbnRhaW5zIGFsbCBmcmFtZXMgdXNlZCBieSB0aGlzIEFuaW1hdGlvbi4KKiBAcGFyYW0geyhBcnJheS48bnVtYmVyPnxBcnJheS48c3RyaW5nPil9IGZyYW1lcyAtIEFuIGFycmF5IG9mIG51bWJlcnMgb3Igc3RyaW5ncyBpbmRpY2F0aW5nIHdoaWNoIGZyYW1lcyB0byBwbGF5IGluIHdoaWNoIG9yZGVyLgoqIEBwYXJhbSB7bnVtYmVyfSBkZWxheSAtIFRoZSB0aW1lIGJldHdlZW4gZWFjaCBmcmFtZSBvZiB0aGUgYW5pbWF0aW9uLCBnaXZlbiBpbiBtcy4KKiBAcGFyYW0ge2Jvb2xlYW59IGxvb3BlZCAtIFNob3VsZCB0aGlzIGFuaW1hdGlvbiBsb29wIG9yIHBsYXkgdGhyb3VnaCBvbmNlLgoqLwpQaGFzZXIuQW5pbWF0aW9uID0gZnVuY3Rpb24gKGdhbWUsIHBhcmVudCwgbmFtZSwgZnJhbWVEYXRhLCBmcmFtZXMsIGRlbGF5LCBsb29wZWQpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNwcml0ZX0gX3BhcmVudCAtIEEgcmVmZXJlbmNlIHRvIHRoZSBwYXJlbnQgU3ByaXRlIHRoYXQgb3ducyB0aGlzIEFuaW1hdGlvbi4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9wYXJlbnQgPSBwYXJlbnQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkZyYW1lRGF0YX0gX2ZyYW1lRGF0YSAtIFRoZSBGcmFtZURhdGEgdGhlIEFuaW1hdGlvbiB1c2VzLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2ZyYW1lRGF0YSA9IGZyYW1lRGF0YTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBUaGUgdXNlciBkZWZpbmVkIG5hbWUgZ2l2ZW4gdG8gdGhpcyBBbmltYXRpb24uCiAgICAqLwogICAgdGhpcy5uYW1lID0gbmFtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gX2ZyYW1lcwogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2ZyYW1lcyA9IFtdOwogICAgdGhpcy5fZnJhbWVzID0gdGhpcy5fZnJhbWVzLmNvbmNhdChmcmFtZXMpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZGVsYXkgLSBUaGUgZGVsYXkgaW4gbXMgYmV0d2VlbiBlYWNoIGZyYW1lIG9mIHRoZSBBbmltYXRpb24uCiAgICAqLwogICAgdGhpcy5kZWxheSA9IDEwMDAgLyBkZWxheTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBsb29wZWQgLSBUaGUgbG9vcCBzdGF0ZSBvZiB0aGUgQW5pbWF0aW9uLgogICAgKi8KICAgIHRoaXMubG9vcGVkID0gbG9vcGVkOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGtpbGxPbkNvbXBsZXRlIC0gU2hvdWxkIHRoZSBwYXJlbnQgb2YgdGhpcyBBbmltYXRpb24gYmUga2lsbGVkIHdoZW4gdGhlIGFuaW1hdGlvbiBjb21wbGV0ZXM/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5raWxsT25Db21wbGV0ZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzRmluaXNoZWQgLSBUaGUgZmluaXNoZWQgc3RhdGUgb2YgdGhlIEFuaW1hdGlvbi4gU2V0IHRvIHRydWUgb25jZSBwbGF5YmFjayBjb21wbGV0ZXMsIGZhbHNlIGR1cmluZyBwbGF5YmFjay4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzRmluaXNoZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc1BsYXlpbmcgLSBUaGUgcGxheWluZyBzdGF0ZSBvZiB0aGUgQW5pbWF0aW9uLiBTZXQgdG8gZmFsc2Ugb25jZSBwbGF5YmFjayBjb21wbGV0ZXMsIHRydWUgZHVyaW5nIHBsYXliYWNrLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNQYXVzZWQgLSBUaGUgcGF1c2VkIHN0YXRlIG9mIHRoZSBBbmltYXRpb24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc1BhdXNlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9wYXVzZVN0YXJ0VGltZSAtIFRoZSB0aW1lIHRoZSBhbmltYXRpb24gcGF1c2VkLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3BhdXNlU3RhcnRUaW1lID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9mcmFtZUluZGV4CiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fZnJhbWVJbmRleCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZnJhbWVEaWZmCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fZnJhbWVEaWZmID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9mcmFtZVNraXAKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9mcmFtZVNraXAgPSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5GcmFtZX0gY3VycmVudEZyYW1lIC0gVGhlIGN1cnJlbnRseSBkaXNwbGF5ZWQgZnJhbWUgb2YgdGhlIEFuaW1hdGlvbi4KICAgICovCiAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZSh0aGlzLl9mcmFtZXNbdGhpcy5fZnJhbWVJbmRleF0pOwogICAgCn07CgpQaGFzZXIuQW5pbWF0aW9uLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogUGxheXMgdGhpcyBhbmltYXRpb24uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbiNwbGF5CiAgICAqIEBtZW1iZXJvZiBQaGFzZXIuQW5pbWF0aW9uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJhbWVSYXRlPW51bGxdIC0gVGhlIGZyYW1lcmF0ZSB0byBwbGF5IHRoZSBhbmltYXRpb24gYXQuIFRoZSBzcGVlZCBpcyBnaXZlbiBpbiBmcmFtZXMgcGVyIHNlY29uZC4gSWYgbm90IHByb3ZpZGVkIHRoZSBwcmV2aW91c2x5IHNldCBmcmFtZVJhdGUgb2YgdGhlIEFuaW1hdGlvbiBpcyB1c2VkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIFNob3VsZCB0aGUgYW5pbWF0aW9uIGJlIGxvb3BlZCBhZnRlciBwbGF5YmFjay4gSWYgbm90IHByb3ZpZGVkIHRoZSBwcmV2aW91c2x5IHNldCBsb29wIHZhbHVlIG9mIHRoZSBBbmltYXRpb24gaXMgdXNlZC4KICAgICogQHBhcmFtIHtib29sZWFufSBba2lsbE9uQ29tcGxldGU9ZmFsc2VdIC0gSWYgc2V0IHRvIHRydWUgd2hlbiB0aGUgYW5pbWF0aW9uIGNvbXBsZXRlcyAob25seSBoYXBwZW5zIGlmIGxvb3A9ZmFsc2UpIHRoZSBwYXJlbnQgU3ByaXRlIHdpbGwgYmUga2lsbGVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQW5pbWF0aW9ufSAtIEEgcmVmZXJlbmNlIHRvIHRoaXMgQW5pbWF0aW9uIGluc3RhbmNlLgogICAgKi8KICAgIHBsYXk6IGZ1bmN0aW9uIChmcmFtZVJhdGUsIGxvb3AsIGtpbGxPbkNvbXBsZXRlKSB7CgogICAgICAgIGlmICh0eXBlb2YgZnJhbWVSYXRlID09PSAnbnVtYmVyJykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBJZiB0aGV5IHNldCBhIG5ldyBmcmFtZSByYXRlIHRoZW4gdXNlIGl0LCBvdGhlcndpc2UgdXNlIHRoZSBvbmUgc2V0IG9uIGNyZWF0aW9uCiAgICAgICAgICAgIHRoaXMuZGVsYXkgPSAxMDAwIC8gZnJhbWVSYXRlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBsb29wID09PSAnYm9vbGVhbicpCiAgICAgICAgewogICAgICAgICAgICAvLyAgSWYgdGhleSBzZXQgYSBuZXcgbG9vcCB2YWx1ZSB0aGVuIHVzZSBpdCwgb3RoZXJ3aXNlIHVzZSB0aGUgb25lIHNldCBvbiBjcmVhdGlvbgogICAgICAgICAgICB0aGlzLmxvb3BlZCA9IGxvb3A7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGtpbGxPbkNvbXBsZXRlICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBSZW1vdmUgdGhlIHBhcmVudCBzcHJpdGUgb25jZSB0aGUgYW5pbWF0aW9uIGhhcyBmaW5pc2hlZD8KICAgICAgICAgICAgdGhpcy5raWxsT25Db21wbGV0ZSA9IGtpbGxPbkNvbXBsZXRlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSB0cnVlOwogICAgICAgIHRoaXMuaXNGaW5pc2hlZCA9IGZhbHNlOwogICAgICAgIHRoaXMucGF1c2VkID0gZmFsc2U7CgogICAgICAgIHRoaXMuX3RpbWVMYXN0RnJhbWUgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgdGhpcy5fdGltZU5leHRGcmFtZSA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIHRoaXMuZGVsYXk7CgogICAgICAgIHRoaXMuX2ZyYW1lSW5kZXggPSAwOwoKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZSh0aGlzLl9mcmFtZXNbdGhpcy5fZnJhbWVJbmRleF0pOwogICAgICAgIHRoaXMuX3BhcmVudC5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKCiAgICAgICAgaWYgKHRoaXMuX3BhcmVudC5ldmVudHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wYXJlbnQuZXZlbnRzLm9uQW5pbWF0aW9uU3RhcnQuZGlzcGF0Y2godGhpcy5fcGFyZW50LCB0aGlzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhpcyBhbmltYXRpb24gYmFjayB0byB0aGUgZmlyc3QgZnJhbWUgYW5kIHJlc3RhcnRzIHRoZSBhbmltYXRpb24uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbiNyZXN0YXJ0CiAgICAqIEBtZW1iZXJvZiBQaGFzZXIuQW5pbWF0aW9uCiAgICAqLwogICAgcmVzdGFydDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmlzUGxheWluZyA9IHRydWU7CiAgICAgICAgdGhpcy5pc0ZpbmlzaGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTsKCiAgICAgICAgdGhpcy5fdGltZUxhc3RGcmFtZSA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICB0aGlzLl90aW1lTmV4dEZyYW1lID0gdGhpcy5nYW1lLnRpbWUubm93ICsgdGhpcy5kZWxheTsKCiAgICAgICAgdGhpcy5fZnJhbWVJbmRleCA9IDA7CgogICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5fZnJhbWVEYXRhLmdldEZyYW1lKHRoaXMuX2ZyYW1lc1t0aGlzLl9mcmFtZUluZGV4XSk7CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgcGxheWJhY2sgb2YgdGhpcyBhbmltYXRpb24gYW5kIHNldCBpdCB0byBhIGZpbmlzaGVkIHN0YXRlLiBJZiBhIHJlc2V0RnJhbWUgaXMgcHJvdmlkZWQgaXQgd2lsbCBzdG9wIHBsYXliYWNrIGFuZCBzZXQgZnJhbWUgdG8gdGhlIGZpcnN0IGluIHRoZSBhbmltYXRpb24uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbiNzdG9wCiAgICAqIEBtZW1iZXJvZiBQaGFzZXIuQW5pbWF0aW9uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Jlc2V0RnJhbWU9ZmFsc2VdIC0gSWYgdHJ1ZSBhZnRlciB0aGUgYW5pbWF0aW9uIHN0b3BzIHRoZSBjdXJyZW50RnJhbWUgdmFsdWUgd2lsbCBiZSBzZXQgdG8gdGhlIGZpcnN0IGZyYW1lIGluIHRoaXMgYW5pbWF0aW9uLgogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uIChyZXNldEZyYW1lKSB7CgogICAgICAgIGlmICh0eXBlb2YgcmVzZXRGcmFtZSA9PT0gJ3VuZGVmaW5lZCcpIHsgcmVzZXRGcmFtZSA9IGZhbHNlOyB9CgogICAgICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5pc0ZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLnBhdXNlZCA9IGZhbHNlOwoKICAgICAgICBpZiAocmVzZXRGcmFtZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5fZnJhbWVEYXRhLmdldEZyYW1lKHRoaXMuX2ZyYW1lc1swXSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZXMgdGhpcyBhbmltYXRpb24uIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IHRoZSBBbmltYXRpb25NYW5hZ2VyLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb24jdXBkYXRlCiAgICAqIEBtZW1iZXJvZiBQaGFzZXIuQW5pbWF0aW9uCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmlzUGF1c2VkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuaXNQbGF5aW5nID09PSB0cnVlICYmIHRoaXMuZ2FtZS50aW1lLm5vdyA+PSB0aGlzLl90aW1lTmV4dEZyYW1lKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZnJhbWVTa2lwID0gMTsKCiAgICAgICAgICAgIC8vICBMYWdnaW5nPwogICAgICAgICAgICB0aGlzLl9mcmFtZURpZmYgPSB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl90aW1lTmV4dEZyYW1lOwoKICAgICAgICAgICAgdGhpcy5fdGltZUxhc3RGcmFtZSA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKCiAgICAgICAgICAgIGlmICh0aGlzLl9mcmFtZURpZmYgPiB0aGlzLmRlbGF5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgV2UgbmVlZCB0byBza2lwIGEgZnJhbWUsIHdvcmsgb3V0IGhvdyBtYW55CiAgICAgICAgICAgICAgICB0aGlzLl9mcmFtZVNraXAgPSBNYXRoLmZsb29yKHRoaXMuX2ZyYW1lRGlmZiAvIHRoaXMuZGVsYXkpOwoKICAgICAgICAgICAgICAgIHRoaXMuX2ZyYW1lRGlmZiAtPSAodGhpcy5fZnJhbWVTa2lwICogdGhpcy5kZWxheSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBBbmQgd2hhdCdzIGxlZnQgbm93PwogICAgICAgICAgICB0aGlzLl90aW1lTmV4dEZyYW1lID0gdGhpcy5nYW1lLnRpbWUubm93ICsgKHRoaXMuZGVsYXkgLSB0aGlzLl9mcmFtZURpZmYpOwoKICAgICAgICAgICAgdGhpcy5fZnJhbWVJbmRleCArPSB0aGlzLl9mcmFtZVNraXA7CgogICAgICAgICAgICBpZiAodGhpcy5fZnJhbWVJbmRleCA+PSB0aGlzLl9mcmFtZXMubGVuZ3RoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29wZWQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZnJhbWVJbmRleCAlPSB0aGlzLl9mcmFtZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5fZnJhbWVEYXRhLmdldEZyYW1lKHRoaXMuX2ZyYW1lc1t0aGlzLl9mcmFtZUluZGV4XSk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRGcmFtZSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcmVudC5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFyZW50LmV2ZW50cy5vbkFuaW1hdGlvbkxvb3AuZGlzcGF0Y2godGhpcy5fcGFyZW50LCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9uQ29tcGxldGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5fZnJhbWVEYXRhLmdldEZyYW1lKHRoaXMuX2ZyYW1lc1t0aGlzLl9mcmFtZUluZGV4XSk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEZyYW1lKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcmVudC5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogQ2xlYW5zIHVwIHRoaXMgYW5pbWF0aW9uIHJlYWR5IGZvciBkZWxldGlvbi4gTnVsbHMgYWxsIHZhbHVlcyBhbmQgcmVmZXJlbmNlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uI2Rlc3Ryb3kKICAgICogQG1lbWJlcm9mIFBoYXNlci5BbmltYXRpb24KICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuZ2FtZSA9IG51bGw7CiAgICAgICAgdGhpcy5fcGFyZW50ID0gbnVsbDsKICAgICAgICB0aGlzLl9mcmFtZXMgPSBudWxsOwogICAgICAgIHRoaXMuX2ZyYW1lRGF0YSA9IG51bGw7CiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSBudWxsOwogICAgICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIGludGVybmFsbHkgd2hlbiB0aGUgYW5pbWF0aW9uIGZpbmlzaGVzIHBsYXliYWNrLiBTZXRzIHRoZSBpc1BsYXlpbmcgYW5kIGlzRmluaXNoZWQgc3RhdGVzIGFuZCBkaXNwYXRjaGVzIHRoZSBvbkFuaW1hdGlvbkNvbXBsZXRlIGV2ZW50IGlmIGl0IGV4aXN0cyBvbiB0aGUgcGFyZW50LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb24jb25Db21wbGV0ZQogICAgKiBAbWVtYmVyb2YgUGhhc2VyLkFuaW1hdGlvbgogICAgKi8KICAgIG9uQ29tcGxldGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLmlzRmluaXNoZWQgPSB0cnVlOwogICAgICAgIHRoaXMucGF1c2VkID0gZmFsc2U7CgogICAgICAgIGlmICh0aGlzLl9wYXJlbnQuZXZlbnRzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcGFyZW50LmV2ZW50cy5vbkFuaW1hdGlvbkNvbXBsZXRlLmRpc3BhdGNoKHRoaXMuX3BhcmVudCwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5raWxsT25Db21wbGV0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BhcmVudC5raWxsKCk7CiAgICAgICAgfQoKICAgIH0KCn07CgpQaGFzZXIuQW5pbWF0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5BbmltYXRpb247CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uI3BhdXNlZAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGF1c2VkIC0gR2V0cyBhbmQgc2V0cyB0aGUgcGF1c2VkIHN0YXRlIG9mIHRoaXMgQW5pbWF0aW9uLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbi5wcm90b3R5cGUsICdwYXVzZWQnLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiB0aGlzLmlzUGF1c2VkOwoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdGhpcy5pc1BhdXNlZCA9IHZhbHVlOwoKICAgICAgICBpZiAodmFsdWUpCiAgICAgICAgewogICAgICAgICAgICAvLyAgUGF1c2VkCiAgICAgICAgICAgIHRoaXMuX3BhdXNlU3RhcnRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgVW4tcGF1c2VkCiAgICAgICAgICAgIGlmICh0aGlzLmlzUGxheWluZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fdGltZU5leHRGcmFtZSA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIHRoaXMuZGVsYXk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uI2ZyYW1lVG90YWwKKiBAcHJvcGVydHkge251bWJlcn0gZnJhbWVUb3RhbCAtIFRoZSB0b3RhbCBudW1iZXIgb2YgZnJhbWVzIGluIHRoZSBjdXJyZW50bHkgbG9hZGVkIEZyYW1lRGF0YSwgb3IgLTEgaWYgbm8gRnJhbWVEYXRhIGlzIGxvYWRlZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5BbmltYXRpb24ucHJvdG90eXBlLCAnZnJhbWVUb3RhbCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZnJhbWVzLmxlbmd0aDsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkFuaW1hdGlvbiNmcmFtZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcmFtZSAtIEdldHMgb3Igc2V0cyB0aGUgY3VycmVudCBmcmFtZSBpbmRleCBhbmQgdXBkYXRlcyB0aGUgVGV4dHVyZSBDYWNoZSBmb3IgZGlzcGxheS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5BbmltYXRpb24ucHJvdG90eXBlLCAnZnJhbWUnLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmN1cnJlbnRGcmFtZSAhPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRGcmFtZS5pbmRleDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZyYW1lSW5kZXg7CiAgICAgICAgfQoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodmFsdWUpOwoKICAgICAgICBpZiAodGhpcy5jdXJyZW50RnJhbWUgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9mcmFtZUluZGV4ID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuX3BhcmVudC5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBSZWFsbHkgaGFuZHkgZnVuY3Rpb24gZm9yIHdoZW4geW91IGFyZSBjcmVhdGluZyBhcnJheXMgb2YgYW5pbWF0aW9uIGRhdGEgYnV0IGl0J3MgdXNpbmcgZnJhbWUgbmFtZXMgYW5kIG5vdCBudW1iZXJzLgoqIEZvciBleGFtcGxlIGltYWdpbmUgeW91J3ZlIGdvdCAzMCBmcmFtZXMgbmFtZWQ6ICdleHBsb3Npb25fMDAwMS1sYXJnZScgdG8gJ2V4cGxvc2lvbl8wMDMwLWxhcmdlJwoqIFlvdSBjb3VsZCB1c2UgdGhpcyBmdW5jdGlvbiB0byBnZW5lcmF0ZSB0aG9zZSBieSBkb2luZzogUGhhc2VyLkFuaW1hdGlvbi5nZW5lcmF0ZUZyYW1lTmFtZXMoJ2V4cGxvc2lvbl8nLCAxLCAzMCwgJy1sYXJnZScsIDQpOwoqCiogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uLmdlbmVyYXRlRnJhbWVOYW1lcwoqIEBwYXJhbSB7c3RyaW5nfSBwcmVmaXggLSBUaGUgc3RhcnQgb2YgdGhlIGZpbGVuYW1lLiBJZiB0aGUgZmlsZW5hbWUgd2FzICdleHBsb3Npb25fMDAwMS1sYXJnZScgdGhlIHByZWZpeCB3b3VsZCBiZSAnZXhwbG9zaW9uXycuCiogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0IC0gVGhlIG51bWJlciB0byBzdGFydCBzZXF1ZW50aWFsbHkgY291bnRpbmcgZnJvbS4gSWYgeW91ciBmcmFtZXMgYXJlIG5hbWVkICdleHBsb3Npb25fMDAwMScgdG8gJ2V4cGxvc2lvbl8wMDM0JyB0aGUgc3RhcnQgaXMgMS4KKiBAcGFyYW0ge251bWJlcn0gc3RvcCAtIFRoZSBudW1iZXIgdG8gY291bnQgdG8uIElmIHlvdXIgZnJhbWVzIGFyZSBuYW1lZCAnZXhwbG9zaW9uXzAwMDEnIHRvICdleHBsb3Npb25fMDAzNCcgdGhlIHN0b3AgdmFsdWUgaXMgMzQuCiogQHBhcmFtIHtzdHJpbmd9IFtzdWZmaXg9JyddIC0gVGhlIGVuZCBvZiB0aGUgZmlsZW5hbWUuIElmIHRoZSBmaWxlbmFtZSB3YXMgJ2V4cGxvc2lvbl8wMDAxLWxhcmdlJyB0aGUgcHJlZml4IHdvdWxkIGJlICctbGFyZ2UnLgoqIEBwYXJhbSB7bnVtYmVyfSBbemVyb1BhZD0wXSAtIFRoZSBudW1iZXIgb2YgemVyb2VzIHRvIHBhZCB0aGUgbWluIGFuZCBtYXggdmFsdWVzIHdpdGguIElmIHlvdXIgZnJhbWVzIGFyZSBuYW1lZCAnZXhwbG9zaW9uXzAwMDEnIHRvICdleHBsb3Npb25fMDAzNCcgdGhlbiB0aGUgemVyb1BhZCBpcyA0LgoqLwpQaGFzZXIuQW5pbWF0aW9uLmdlbmVyYXRlRnJhbWVOYW1lcyA9IGZ1bmN0aW9uIChwcmVmaXgsIHN0YXJ0LCBzdG9wLCBzdWZmaXgsIHplcm9QYWQpIHsKCiAgICBpZiAodHlwZW9mIHN1ZmZpeCA9PSAndW5kZWZpbmVkJykgeyBzdWZmaXggPSAnJzsgfQoKICAgIHZhciBvdXRwdXQgPSBbXTsKICAgIHZhciBmcmFtZSA9ICcnOwoKICAgIGlmIChzdGFydCA8IHN0b3ApCiAgICB7CiAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDw9IHN0b3A7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgemVyb1BhZCA9PSAnbnVtYmVyJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIHN0ciwgbGVuLCBwYWQsIGRpcgogICAgICAgICAgICAgICAgZnJhbWUgPSBQaGFzZXIuVXRpbHMucGFkKGkudG9TdHJpbmcoKSwgemVyb1BhZCwgJzAnLCAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZyYW1lID0gaS50b1N0cmluZygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmcmFtZSA9IHByZWZpeCArIGZyYW1lICsgc3VmZml4OwoKICAgICAgICAgICAgb3V0cHV0LnB1c2goZnJhbWUpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPj0gc3RvcDsgaS0tKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB6ZXJvUGFkID09ICdudW1iZXInKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgc3RyLCBsZW4sIHBhZCwgZGlyCiAgICAgICAgICAgICAgICBmcmFtZSA9IFBoYXNlci5VdGlscy5wYWQoaS50b1N0cmluZygpLCB6ZXJvUGFkLCAnMCcsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZnJhbWUgPSBpLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZyYW1lID0gcHJlZml4ICsgZnJhbWUgKyBzdWZmaXg7CgogICAgICAgICAgICBvdXRwdXQucHVzaChmcmFtZSk7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiBvdXRwdXQ7Cgp9CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIEZyYW1lIGlzIGEgc2luZ2xlIGZyYW1lIG9mIGFuIGFuaW1hdGlvbiBhbmQgaXMgcGFydCBvZiBhIEZyYW1lRGF0YSBjb2xsZWN0aW9uLgoqCiogQGNsYXNzIFBoYXNlci5GcmFtZQoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGlzIEZyYW1lIHdpdGhpbiB0aGUgRnJhbWVEYXRhIHNldCBpdCBpcyBiZWluZyBhZGRlZCB0by4KKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGZyYW1lIHdpdGhpbiB0aGUgdGV4dHVyZSBpbWFnZS4KKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGZyYW1lIHdpdGhpbiB0aGUgdGV4dHVyZSBpbWFnZS4KKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBXaWR0aCBvZiB0aGUgZnJhbWUgd2l0aGluIHRoZSB0ZXh0dXJlIGltYWdlLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBIZWlnaHQgb2YgdGhlIGZyYW1lIHdpdGhpbiB0aGUgdGV4dHVyZSBpbWFnZS4KKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBmcmFtZS4gSW4gVGV4dHVyZSBBdGxhcyBkYXRhIHRoaXMgaXMgdXN1YWxseSBzZXQgdG8gdGhlIGZpbGVuYW1lLgoqIEBwYXJhbSB7c3RyaW5nfSB1dWlkIC0gSW50ZXJuYWwgVVVJRCBrZXkuCiovClBoYXNlci5GcmFtZSA9IGZ1bmN0aW9uIChpbmRleCwgeCwgeSwgd2lkdGgsIGhlaWdodCwgbmFtZSwgdXVpZCkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhpcyBGcmFtZSB3aXRoaW4gdGhlIEZyYW1lRGF0YSBzZXQgaXQgaXMgYmVpbmcgYWRkZWQgdG8uCiAgICAqLwogICAgdGhpcy5pbmRleCA9IGluZGV4OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIHdpdGhpbiB0aGUgaW1hZ2UgdG8gY3V0IGZyb20uCiAgICAqLwogICAgdGhpcy54ID0geDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIHdpdGhpbiB0aGUgaW1hZ2UgdG8gY3V0IGZyb20uCiAgICAqLwogICAgdGhpcy55ID0geTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gV2lkdGggb2YgdGhlIGZyYW1lLgogICAgKi8KICAgIHRoaXMud2lkdGggPSB3aWR0aDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIEhlaWdodCBvZiB0aGUgZnJhbWUuCiAgICAqLwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gVXNlZnVsIGZvciBUZXh0dXJlIEF0bGFzIGZpbGVzIChpcyBzZXQgdG8gdGhlIGZpbGVuYW1lIHZhbHVlKS4KICAgICovCiAgICB0aGlzLm5hbWUgPSBuYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gdXVpZCAtIEEgbGluayB0byB0aGUgUElYSS5UZXh0dXJlQ2FjaGUgZW50cnkuCiAgICAqLwogICAgdGhpcy51dWlkID0gdXVpZDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGNlbnRlclggLSBDZW50ZXIgWCBwb3NpdGlvbiB3aXRoaW4gdGhlIGltYWdlIHRvIGN1dCBmcm9tLgogICAgKi8KICAgIHRoaXMuY2VudGVyWCA9IE1hdGguZmxvb3Iod2lkdGggLyAyKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGNlbnRlclkgLSBDZW50ZXIgWSBwb3NpdGlvbiB3aXRoaW4gdGhlIGltYWdlIHRvIGN1dCBmcm9tLgogICAgKi8KICAgIHRoaXMuY2VudGVyWSA9IE1hdGguZmxvb3IoaGVpZ2h0IC8gMik7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkaXN0YW5jZSAtIFRoZSBkaXN0YW5jZSBmcm9tIHRoZSB0b3AgbGVmdCB0byB0aGUgYm90dG9tLXJpZ2h0IG9mIHRoaXMgRnJhbWUuCiAgICAqLwogICAgdGhpcy5kaXN0YW5jZSA9IFBoYXNlci5NYXRoLmRpc3RhbmNlKDAsIDAsIHdpZHRoLCBoZWlnaHQpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHJvdGF0ZWQgLSBSb3RhdGVkPyAobm90IHlldCBpbXBsZW1lbnRlZCkKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnJvdGF0ZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IHJvdGF0aW9uRGlyZWN0aW9uIC0gRWl0aGVyICdjdycgb3IgJ2NjdycsIHJvdGF0aW9uIGlzIGFsd2F5cyA5MCBkZWdyZWVzLgogICAgKiBAZGVmYXVsdCAnY3cnCiAgICAqLwogICAgdGhpcy5yb3RhdGlvbkRpcmVjdGlvbiA9ICdjdyc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdHJpbW1lZCAtIFdhcyBpdCB0cmltbWVkIHdoZW4gcGFja2VkPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudHJpbW1lZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc291cmNlU2l6ZVcgLSBXaWR0aCBvZiB0aGUgb3JpZ2luYWwgc3ByaXRlLgogICAgKi8KICAgIHRoaXMuc291cmNlU2l6ZVcgPSB3aWR0aDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNvdXJjZVNpemVIIC0gSGVpZ2h0IG9mIHRoZSBvcmlnaW5hbCBzcHJpdGUuCiAgICAqLwogICAgdGhpcy5zb3VyY2VTaXplSCA9IGhlaWdodDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNwcml0ZVNvdXJjZVNpemVYIC0gWCBwb3NpdGlvbiBvZiB0aGUgdHJpbW1lZCBzcHJpdGUgaW5zaWRlIG9yaWdpbmFsIHNwcml0ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNwcml0ZVNvdXJjZVNpemVYID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNwcml0ZVNvdXJjZVNpemVZIC0gWSBwb3NpdGlvbiBvZiB0aGUgdHJpbW1lZCBzcHJpdGUgaW5zaWRlIG9yaWdpbmFsIHNwcml0ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNwcml0ZVNvdXJjZVNpemVZID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNwcml0ZVNvdXJjZVNpemVXIC0gV2lkdGggb2YgdGhlIHRyaW1tZWQgc3ByaXRlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc3ByaXRlU291cmNlU2l6ZVcgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc3ByaXRlU291cmNlU2l6ZUggLSBIZWlnaHQgb2YgdGhlIHRyaW1tZWQgc3ByaXRlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc3ByaXRlU291cmNlU2l6ZUggPSAwOwoKfTsKClBoYXNlci5GcmFtZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIElmIHRoZSBmcmFtZSB3YXMgdHJpbW1lZCB3aGVuIGFkZGVkIHRvIHRoZSBUZXh0dXJlIEF0bGFzIHRoaXMgcmVjb3JkcyB0aGUgdHJpbSBhbmQgc291cmNlIGRhdGEuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lI3NldFRyaW0KICAgICogQHBhcmFtIHtib29sZWFufSB0cmltbWVkIC0gSWYgdGhpcyBmcmFtZSB3YXMgdHJpbW1lZCBvciBub3QuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhY3R1YWxXaWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgZnJhbWUgYmVmb3JlIGJlaW5nIHRyaW1tZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhY3R1YWxIZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBmcmFtZSBiZWZvcmUgYmVpbmcgdHJpbW1lZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGRlc3RYIC0gVGhlIGRlc3RpbmF0aW9uIFggcG9zaXRpb24gb2YgdGhlIHRyaW1tZWQgZnJhbWUgZm9yIGRpc3BsYXkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkZXN0WSAtIFRoZSBkZXN0aW5hdGlvbiBZIHBvc2l0aW9uIG9mIHRoZSB0cmltbWVkIGZyYW1lIGZvciBkaXNwbGF5LgogICAgKiBAcGFyYW0ge251bWJlcn0gZGVzdFdpZHRoIC0gVGhlIGRlc3RpbmF0aW9uIHdpZHRoIG9mIHRoZSB0cmltbWVkIGZyYW1lIGZvciBkaXNwbGF5LgogICAgKiBAcGFyYW0ge251bWJlcn0gZGVzdEhlaWdodCAtIFRoZSBkZXN0aW5hdGlvbiBoZWlnaHQgb2YgdGhlIHRyaW1tZWQgZnJhbWUgZm9yIGRpc3BsYXkuCiAgICAqLwogICAgc2V0VHJpbTogZnVuY3Rpb24gKHRyaW1tZWQsIGFjdHVhbFdpZHRoLCBhY3R1YWxIZWlnaHQsIGRlc3RYLCBkZXN0WSwgZGVzdFdpZHRoLCBkZXN0SGVpZ2h0KSB7CgogICAgICAgIHRoaXMudHJpbW1lZCA9IHRyaW1tZWQ7CgogICAgICAgIGlmICh0cmltbWVkKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IGFjdHVhbFdpZHRoOwogICAgICAgICAgICB0aGlzLmhlaWdodCA9IGFjdHVhbEhlaWdodDsKICAgICAgICAgICAgdGhpcy5zb3VyY2VTaXplVyA9IGFjdHVhbFdpZHRoOwogICAgICAgICAgICB0aGlzLnNvdXJjZVNpemVIID0gYWN0dWFsSGVpZ2h0OwogICAgICAgICAgICB0aGlzLmNlbnRlclggPSBNYXRoLmZsb29yKGFjdHVhbFdpZHRoIC8gMik7CiAgICAgICAgICAgIHRoaXMuY2VudGVyWSA9IE1hdGguZmxvb3IoYWN0dWFsSGVpZ2h0IC8gMik7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlU291cmNlU2l6ZVggPSBkZXN0WDsKICAgICAgICAgICAgdGhpcy5zcHJpdGVTb3VyY2VTaXplWSA9IGRlc3RZOwogICAgICAgICAgICB0aGlzLnNwcml0ZVNvdXJjZVNpemVXID0gZGVzdFdpZHRoOwogICAgICAgICAgICB0aGlzLnNwcml0ZVNvdXJjZVNpemVIID0gZGVzdEhlaWdodDsKICAgICAgICB9CgogICAgfQoKfTsKClBoYXNlci5GcmFtZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuRnJhbWU7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBGcmFtZURhdGEgaXMgYSBjb250YWluZXIgZm9yIEZyYW1lIG9iamVjdHMsIHdoaWNoIGFyZSB0aGUgaW50ZXJuYWwgcmVwcmVzZW50YXRpb24gb2YgYW5pbWF0aW9uIGRhdGEgaW4gUGhhc2VyLgoqCiogQGNsYXNzIFBoYXNlci5GcmFtZURhdGEKKiBAY29uc3RydWN0b3IKKi8KUGhhc2VyLkZyYW1lRGF0YSA9IGZ1bmN0aW9uICgpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBcnJheX0gX2ZyYW1lcyAtIExvY2FsIGFycmF5IG9mIGZyYW1lcy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9mcmFtZXMgPSBbXTsKCgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7QXJyYXl9IF9mcmFtZU5hbWVzIC0gTG9jYWwgYXJyYXkgb2YgZnJhbWUgbmFtZXMgZm9yIG5hbWUgdG8gaW5kZXggY29udmVyc2lvbnMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZnJhbWVOYW1lcyA9IFtdOwoKfTsKClBoYXNlci5GcmFtZURhdGEucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBBZGRzIGEgbmV3IEZyYW1lIHRvIHRoaXMgRnJhbWVEYXRhIGNvbGxlY3Rpb24uIFR5cGljYWxseSBjYWxsZWQgYnkgdGhlIEFuaW1hdGlvbi5QYXJzZXIgYW5kIG5vdCBkaXJlY3RseS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuRnJhbWVEYXRhI2FkZEZyYW1lCiAgICAqIEBwYXJhbSB7UGhhc2VyLkZyYW1lfSBmcmFtZSAtIFRoZSBmcmFtZSB0byBhZGQgdG8gdGhpcyBGcmFtZURhdGEgc2V0LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWV9IFRoZSBmcmFtZSB0aGF0IHdhcyBqdXN0IGFkZGVkLgogICAgKi8KICAgIGFkZEZyYW1lOiBmdW5jdGlvbiAoZnJhbWUpIHsKCiAgICAgICAgZnJhbWUuaW5kZXggPSB0aGlzLl9mcmFtZXMubGVuZ3RoOwoKICAgICAgICB0aGlzLl9mcmFtZXMucHVzaChmcmFtZSk7CgogICAgICAgIGlmIChmcmFtZS5uYW1lICE9PSAnJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ZyYW1lTmFtZXNbZnJhbWUubmFtZV0gPSBmcmFtZS5pbmRleDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmcmFtZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgYSBGcmFtZSBieSBpdHMgbnVtZXJpY2FsIGluZGV4LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5GcmFtZURhdGEjZ2V0RnJhbWUKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoZSBmcmFtZSB5b3Ugd2FudCB0byBnZXQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZX0gVGhlIGZyYW1lLCBpZiBmb3VuZC4KICAgICovCiAgICBnZXRGcmFtZTogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgICAgIGlmICh0aGlzLl9mcmFtZXMubGVuZ3RoID4gaW5kZXgpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZnJhbWVzW2luZGV4XTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBhIEZyYW1lIGJ5IGl0cyBmcmFtZSBuYW1lLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5GcmFtZURhdGEjZ2V0RnJhbWVCeU5hbWUKICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgZnJhbWUgeW91IHdhbnQgdG8gZ2V0LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWV9IFRoZSBmcmFtZSwgaWYgZm91bmQuCiAgICAqLwogICAgZ2V0RnJhbWVCeU5hbWU6IGZ1bmN0aW9uIChuYW1lKSB7CgogICAgICAgIGlmICh0eXBlb2YgdGhpcy5fZnJhbWVOYW1lc1tuYW1lXSA9PT0gJ251bWJlcicpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZnJhbWVzW3RoaXMuX2ZyYW1lTmFtZXNbbmFtZV1dOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgaWYgdGhlcmUgaXMgYSBGcmFtZSB3aXRoIHRoZSBnaXZlbiBuYW1lLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5GcmFtZURhdGEjY2hlY2tGcmFtZU5hbWUKICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgZnJhbWUgeW91IHdhbnQgdG8gY2hlY2suCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGZyYW1lIGlzIGZvdW5kLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgY2hlY2tGcmFtZU5hbWU6IGZ1bmN0aW9uIChuYW1lKSB7CgogICAgICAgIGlmICh0aGlzLl9mcmFtZU5hbWVzW25hbWVdID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSByYW5nZSBvZiBmcmFtZXMgYmFzZWQgb24gdGhlIGdpdmVuIHN0YXJ0IGFuZCBlbmQgZnJhbWUgaW5kZXhlcyBhbmQgcmV0dXJucyB0aGVtIGluIGFuIEFycmF5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5GcmFtZURhdGEjZ2V0RnJhbWVSYW5nZQogICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnQgLSBUaGUgc3RhcnRpbmcgZnJhbWUgaW5kZXguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBlbmQgLSBUaGUgZW5kaW5nIGZyYW1lIGluZGV4LgogICAgKiBAcGFyYW0ge0FycmF5fSBbb3V0cHV0XSAtIElmIGdpdmVuIHRoZSByZXN1bHRzIHdpbGwgYmUgYXBwZW5kZWQgdG8gdGhlIGVuZCBvZiB0aGlzIGFycmF5IG90aGVyd2lzZSBhIG5ldyBhcnJheSB3aWxsIGJlIGNyZWF0ZWQuCiAgICAqIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBvZiBGcmFtZXMgYmV0d2VlbiB0aGUgc3RhcnQgYW5kIGVuZCBpbmRleCB2YWx1ZXMsIG9yIGFuIGVtcHR5IGFycmF5IGlmIG5vbmUgd2VyZSBmb3VuZC4KICAgICovCiAgICBnZXRGcmFtZVJhbmdlOiBmdW5jdGlvbiAoc3RhcnQsIGVuZCwgb3V0cHV0KSB7CiAgICAgICAgCiAgICAgICAgaWYgKHR5cGVvZiBvdXRwdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dHB1dCA9IFtdOyB9CgogICAgICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8PSBlbmQ7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIG91dHB1dC5wdXNoKHRoaXMuX2ZyYW1lc1tpXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gb3V0cHV0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYWxsIG9mIHRoZSBGcmFtZXMgaW4gdGhpcyBGcmFtZURhdGEgc2V0IHdoZXJlIHRoZSBmcmFtZSBpbmRleCBpcyBmb3VuZCBpbiB0aGUgaW5wdXQgYXJyYXkuCiAgICAqIFRoZSBmcmFtZXMgYXJlIHJldHVybmVkIGluIHRoZSBvdXRwdXQgYXJyYXksIG9yIGlmIG5vbmUgaXMgcHJvdmlkZWQgaW4gYSBuZXcgQXJyYXkgb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5GcmFtZURhdGEjZ2V0RnJhbWVzCiAgICAqIEBwYXJhbSB7QXJyYXl9IGZyYW1lcyAtIEFuIEFycmF5IGNvbnRhaW5pbmcgdGhlIGluZGV4ZXMgb2YgdGhlIGZyYW1lcyB0byByZXRyaWV2ZS4gSWYgdGhlIGFycmF5IGlzIGVtcHR5IHRoZW4gYWxsIGZyYW1lcyBpbiB0aGUgRnJhbWVEYXRhIGFyZSByZXR1cm5lZC4KICAgICogQHBhcmFtIHtib29sZWFufSBbdXNlTnVtZXJpY0luZGV4PXRydWVdIC0gQXJlIHRoZSBnaXZlbiBmcmFtZXMgdXNpbmcgbnVtZXJpYyBpbmRleGVzIChkZWZhdWx0KSBvciBzdHJpbmdzPyAoZmFsc2UpCiAgICAqIEBwYXJhbSB7QXJyYXl9IFtvdXRwdXRdIC0gSWYgZ2l2ZW4gdGhlIHJlc3VsdHMgd2lsbCBiZSBhcHBlbmRlZCB0byB0aGUgZW5kIG9mIHRoaXMgYXJyYXkgb3RoZXJ3aXNlIGEgbmV3IGFycmF5IHdpbGwgYmUgY3JlYXRlZC4KICAgICogQHJldHVybiB7QXJyYXl9IEFuIGFycmF5IG9mIGFsbCBGcmFtZXMgaW4gdGhpcyBGcmFtZURhdGEgc2V0IG1hdGNoaW5nIHRoZSBnaXZlbiBuYW1lcyBvciBJRHMuCiAgICAqLwogICAgZ2V0RnJhbWVzOiBmdW5jdGlvbiAoZnJhbWVzLCB1c2VOdW1lcmljSW5kZXgsIG91dHB1dCkgewoKICAgICAgICBpZiAodHlwZW9mIHVzZU51bWVyaWNJbmRleCA9PT0gInVuZGVmaW5lZCIpIHsgdXNlTnVtZXJpY0luZGV4ID0gdHJ1ZTsgfQogICAgICAgIGlmICh0eXBlb2Ygb3V0cHV0ID09PSAidW5kZWZpbmVkIikgeyBvdXRwdXQgPSBbXTsgfQoKICAgICAgICBpZiAodHlwZW9mIGZyYW1lcyA9PT0gInVuZGVmaW5lZCIgfHwgZnJhbWVzLmxlbmd0aCA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBObyBpbnB1dCBhcnJheSwgc28gd2UgbG9vcCB0aHJvdWdoIGFsbCBmcmFtZXMKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9mcmFtZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBXZSBvbmx5IG5lZWQgdGhlIGluZGV4ZXMKICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKHRoaXMuX2ZyYW1lc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIElucHV0IGFycmF5IGdpdmVuLCBsb29wIHRocm91Z2ggdGhhdCBpbnN0ZWFkCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBmcmFtZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBEb2VzIHRoZSBpbnB1dCBhcnJheSBjb250YWluIG5hbWVzIG9yIGluZGV4ZXM/CiAgICAgICAgICAgICAgICBpZiAodXNlTnVtZXJpY0luZGV4KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICBUaGUgYWN0dWFsIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0LnB1c2godGhpcy5nZXRGcmFtZShmcmFtZXNbaV0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyAgVGhlIGFjdHVhbCBmcmFtZQogICAgICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKHRoaXMuZ2V0RnJhbWVCeU5hbWUoZnJhbWVzW2ldKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBvdXRwdXQ7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhbGwgb2YgdGhlIEZyYW1lIGluZGV4ZXMgaW4gdGhpcyBGcmFtZURhdGEgc2V0LgogICAgKiBUaGUgZnJhbWVzIGluZGV4ZXMgYXJlIHJldHVybmVkIGluIHRoZSBvdXRwdXQgYXJyYXksIG9yIGlmIG5vbmUgaXMgcHJvdmlkZWQgaW4gYSBuZXcgQXJyYXkgb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5GcmFtZURhdGEjZ2V0RnJhbWVJbmRleGVzCiAgICAqIEBwYXJhbSB7QXJyYXl9IGZyYW1lcyAtIEFuIEFycmF5IGNvbnRhaW5pbmcgdGhlIGluZGV4ZXMgb2YgdGhlIGZyYW1lcyB0byByZXRyaWV2ZS4gSWYgdGhlIGFycmF5IGlzIGVtcHR5IHRoZW4gYWxsIGZyYW1lcyBpbiB0aGUgRnJhbWVEYXRhIGFyZSByZXR1cm5lZC4KICAgICogQHBhcmFtIHtib29sZWFufSBbdXNlTnVtZXJpY0luZGV4PXRydWVdIC0gQXJlIHRoZSBnaXZlbiBmcmFtZXMgdXNpbmcgbnVtZXJpYyBpbmRleGVzIChkZWZhdWx0KSBvciBzdHJpbmdzPyAoZmFsc2UpCiAgICAqIEBwYXJhbSB7QXJyYXl9IFtvdXRwdXRdIC0gSWYgZ2l2ZW4gdGhlIHJlc3VsdHMgd2lsbCBiZSBhcHBlbmRlZCB0byB0aGUgZW5kIG9mIHRoaXMgYXJyYXkgb3RoZXJ3aXNlIGEgbmV3IGFycmF5IHdpbGwgYmUgY3JlYXRlZC4KICAgICogQHJldHVybiB7QXJyYXl9IEFuIGFycmF5IG9mIGFsbCBGcmFtZSBpbmRleGVzIG1hdGNoaW5nIHRoZSBnaXZlbiBuYW1lcyBvciBJRHMuCiAgICAqLwogICAgZ2V0RnJhbWVJbmRleGVzOiBmdW5jdGlvbiAoZnJhbWVzLCB1c2VOdW1lcmljSW5kZXgsIG91dHB1dCkgewoKICAgICAgICBpZiAodHlwZW9mIHVzZU51bWVyaWNJbmRleCA9PT0gInVuZGVmaW5lZCIpIHsgdXNlTnVtZXJpY0luZGV4ID0gdHJ1ZTsgfQogICAgICAgIGlmICh0eXBlb2Ygb3V0cHV0ID09PSAidW5kZWZpbmVkIikgeyBvdXRwdXQgPSBbXTsgfQoKICAgICAgICBpZiAodHlwZW9mIGZyYW1lcyA9PT0gInVuZGVmaW5lZCIgfHwgZnJhbWVzLmxlbmd0aCA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBObyBmcmFtZXMgYXJyYXksIHNvIHdlIGxvb3AgdGhyb3VnaCBhbGwgZnJhbWVzCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLl9mcmFtZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKHRoaXMuX2ZyYW1lc1tpXS5pbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIElucHV0IGFycmF5IGdpdmVuLCBsb29wIHRocm91Z2ggdGhhdCBpbnN0ZWFkCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBmcmFtZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBEb2VzIHRoZSBmcmFtZXMgYXJyYXkgY29udGFpbiBuYW1lcyBvciBpbmRleGVzPwogICAgICAgICAgICAgICAgaWYgKHVzZU51bWVyaWNJbmRleCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBvdXRwdXQucHVzaChmcmFtZXNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldEZyYW1lQnlOYW1lKGZyYW1lc1tpXSkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXQucHVzaCh0aGlzLmdldEZyYW1lQnlOYW1lKGZyYW1lc1tpXSkuaW5kZXgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG91dHB1dDsKCiAgICB9Cgp9OwoKUGhhc2VyLkZyYW1lRGF0YS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuRnJhbWVEYXRhOwoKLyoqCiogQG5hbWUgUGhhc2VyLkZyYW1lRGF0YSN0b3RhbAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3RhbCAtIFRoZSB0b3RhbCBudW1iZXIgb2YgZnJhbWVzIGluIHRoaXMgRnJhbWVEYXRhIHNldC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5GcmFtZURhdGEucHJvdG90eXBlLCAidG90YWwiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ZyYW1lcy5sZW5ndGg7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFJlc3BvbnNpYmxlIGZvciBwYXJzaW5nIHNwcml0ZSBzaGVldCBhbmQgSlNPTiBkYXRhIGludG8gdGhlIGludGVybmFsIEZyYW1lRGF0YSBmb3JtYXQgdGhhdCBQaGFzZXIgdXNlcyBmb3IgYW5pbWF0aW9ucy4KKgoqIEBjbGFzcyBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyCiovClBoYXNlci5BbmltYXRpb25QYXJzZXIgPSB7CgogICAgLyoqCiAgICAqIFBhcnNlIGEgU3ByaXRlIFNoZWV0IGFuZCBleHRyYWN0IHRoZSBhbmltYXRpb24gZnJhbWUgZGF0YSBmcm9tIGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25QYXJzZXIuc3ByaXRlU2hlZXQKICAgICogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIEdhbWUuQ2FjaGUgYXNzZXQga2V5IG9mIHRoZSBTcHJpdGUgU2hlZXQgaW1hZ2UuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBmcmFtZVdpZHRoIC0gVGhlIGZpeGVkIHdpZHRoIG9mIGVhY2ggZnJhbWUgb2YgdGhlIGFuaW1hdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IGZyYW1lSGVpZ2h0IC0gVGhlIGZpeGVkIGhlaWdodCBvZiBlYWNoIGZyYW1lIG9mIHRoZSBhbmltYXRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJhbWVNYXg9LTFdIC0gVGhlIHRvdGFsIG51bWJlciBvZiBhbmltYXRpb24gZnJhbWVzIHRvIGV4dGFjdCBmcm9tIHRoZSBTcHJpdGUgU2hlZXQuIFRoZSBkZWZhdWx0IHZhbHVlIG9mIC0xIG1lYW5zICJleHRyYWN0IGFsbCBmcmFtZXMiLgogICAgKiBAcGFyYW0ge251bWJlcn0gW21hcmdpbj0wXSAtIElmIHRoZSBmcmFtZXMgaGF2ZSBiZWVuIGRyYXduIHdpdGggYSBtYXJnaW4sIHNwZWNpZnkgdGhlIGFtb3VudCBoZXJlLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwYWNpbmc9MF0gLSBJZiB0aGUgZnJhbWVzIGhhdmUgYmVlbiBkcmF3biB3aXRoIHNwYWNpbmcgYmV0d2VlbiB0aGVtLCBzcGVjaWZ5IHRoZSBhbW91bnQgaGVyZS4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lRGF0YX0gQSBGcmFtZURhdGEgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHBhcnNlZCBmcmFtZXMuCiAgICAqLwogICAgc3ByaXRlU2hlZXQ6IGZ1bmN0aW9uIChnYW1lLCBrZXksIGZyYW1lV2lkdGgsIGZyYW1lSGVpZ2h0LCBmcmFtZU1heCwgbWFyZ2luLCBzcGFjaW5nKSB7CgogICAgICAgIC8vICBIb3cgYmlnIGlzIG91ciBpbWFnZT8KICAgICAgICB2YXIgaW1nID0gZ2FtZS5jYWNoZS5nZXRJbWFnZShrZXkpOwoKICAgICAgICBpZiAoaW1nID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHZhciB3aWR0aCA9IGltZy53aWR0aDsKICAgICAgICB2YXIgaGVpZ2h0ID0gaW1nLmhlaWdodDsKCiAgICAgICAgaWYgKGZyYW1lV2lkdGggPD0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGZyYW1lV2lkdGggPSBNYXRoLmZsb29yKC13aWR0aCAvIE1hdGgubWluKC0xLCBmcmFtZVdpZHRoKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoZnJhbWVIZWlnaHQgPD0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGZyYW1lSGVpZ2h0ID0gTWF0aC5mbG9vcigtaGVpZ2h0IC8gTWF0aC5taW4oLTEsIGZyYW1lSGVpZ2h0KSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcm93ID0gTWF0aC5yb3VuZCh3aWR0aCAvIGZyYW1lV2lkdGgpOwogICAgICAgIHZhciBjb2x1bW4gPSBNYXRoLnJvdW5kKGhlaWdodCAvIGZyYW1lSGVpZ2h0KTsKICAgICAgICB2YXIgdG90YWwgPSByb3cgKiBjb2x1bW47CiAgICAgICAgCiAgICAgICAgaWYgKGZyYW1lTWF4ICE9PSAtMSkKICAgICAgICB7CiAgICAgICAgICAgIHRvdGFsID0gZnJhbWVNYXg7CiAgICAgICAgfQoKICAgICAgICAvLyAgWmVybyBvciBzbWFsbGVyIHRoYW4gZnJhbWUgc2l6ZXM/CiAgICAgICAgaWYgKHdpZHRoID09PSAwIHx8IGhlaWdodCA9PT0gMCB8fCB3aWR0aCA8IGZyYW1lV2lkdGggfHwgaGVpZ2h0IDwgZnJhbWVIZWlnaHQgfHwgdG90YWwgPT09IDApCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5BbmltYXRpb25QYXJzZXIuc3ByaXRlU2hlZXQ6IHdpZHRoL2hlaWdodCB6ZXJvIG9yIHdpZHRoL2hlaWdodCA8IGdpdmVuIGZyYW1lV2lkdGgvZnJhbWVIZWlnaHQiKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyAgTGV0J3MgY3JlYXRlIHNvbWUgZnJhbWVzIHRoZW4KICAgICAgICB2YXIgZGF0YSA9IG5ldyBQaGFzZXIuRnJhbWVEYXRhKCk7CiAgICAgICAgdmFyIHggPSBtYXJnaW47CiAgICAgICAgdmFyIHkgPSBtYXJnaW47CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdG90YWw7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB1dWlkID0gZ2FtZS5ybmQudXVpZCgpOwoKICAgICAgICAgICAgZGF0YS5hZGRGcmFtZShuZXcgUGhhc2VyLkZyYW1lKGksIHgsIHksIGZyYW1lV2lkdGgsIGZyYW1lSGVpZ2h0LCAnJywgdXVpZCkpOwoKICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldLCB7CiAgICAgICAgICAgICAgICB4OiB4LAogICAgICAgICAgICAgICAgeTogeSwKICAgICAgICAgICAgICAgIHdpZHRoOiBmcmFtZVdpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBmcmFtZUhlaWdodAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHggKz0gZnJhbWVXaWR0aCArIHNwYWNpbmc7CgogICAgICAgICAgICBpZiAoeCA9PT0gd2lkdGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHggPSBtYXJnaW47CiAgICAgICAgICAgICAgICB5ICs9IGZyYW1lSGVpZ2h0ICsgc3BhY2luZzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGE7CgogICAgfSwKCiAgICAvKioKICAgICogUGFyc2UgdGhlIEpTT04gZGF0YSBhbmQgZXh0cmFjdCB0aGUgYW5pbWF0aW9uIGZyYW1lIGRhdGEgZnJvbSBpdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLkpTT05EYXRhCiAgICAqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICogQHBhcmFtIHtPYmplY3R9IGpzb24gLSBUaGUgSlNPTiBkYXRhIGZyb20gdGhlIFRleHR1cmUgQXRsYXMuIE11c3QgYmUgaW4gQXJyYXkgZm9ybWF0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gY2FjaGVLZXkgLSBUaGUgR2FtZS5DYWNoZSBhc3NldCBrZXkgb2YgdGhlIHRleHR1cmUgaW1hZ2UuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZURhdGF9IEEgRnJhbWVEYXRhIG9iamVjdCBjb250YWluaW5nIHRoZSBwYXJzZWQgZnJhbWVzLgogICAgKi8KICAgIEpTT05EYXRhOiBmdW5jdGlvbiAoZ2FtZSwganNvbiwgY2FjaGVLZXkpIHsKCiAgICAgICAgLy8gIE1hbGZvcm1lZD8KICAgICAgICBpZiAoIWpzb25bJ2ZyYW1lcyddKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLkpTT05EYXRhOiBJbnZhbGlkIFRleHR1cmUgQXRsYXMgSlNPTiBnaXZlbiwgbWlzc2luZyAnZnJhbWVzJyBhcnJheSIpOwogICAgICAgICAgICBjb25zb2xlLmxvZyhqc29uKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gIExldCdzIGNyZWF0ZSBzb21lIGZyYW1lcyB0aGVuCiAgICAgICAgdmFyIGRhdGEgPSBuZXcgUGhhc2VyLkZyYW1lRGF0YSgpOwogICAgICAgIAogICAgICAgIC8vICBCeSB0aGlzIHN0YWdlIGZyYW1lcyBpcyBhIGZ1bGx5IHBhcnNlZCBhcnJheQogICAgICAgIHZhciBmcmFtZXMgPSBqc29uWydmcmFtZXMnXTsKICAgICAgICB2YXIgbmV3RnJhbWU7CiAgICAgICAgCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmcmFtZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB2YXIgdXVpZCA9IGdhbWUucm5kLnV1aWQoKTsKCiAgICAgICAgICAgIG5ld0ZyYW1lID0gZGF0YS5hZGRGcmFtZShuZXcgUGhhc2VyLkZyYW1lKAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgIGZyYW1lc1tpXS5mcmFtZS54LAogICAgICAgICAgICAgICAgZnJhbWVzW2ldLmZyYW1lLnksCiAgICAgICAgICAgICAgICBmcmFtZXNbaV0uZnJhbWUudywKICAgICAgICAgICAgICAgIGZyYW1lc1tpXS5mcmFtZS5oLAogICAgICAgICAgICAgICAgZnJhbWVzW2ldLmZpbGVuYW1lLAogICAgICAgICAgICAgICAgdXVpZAogICAgICAgICAgICApKTsKCiAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbY2FjaGVLZXldLCB7CiAgICAgICAgICAgICAgICB4OiBmcmFtZXNbaV0uZnJhbWUueCwKICAgICAgICAgICAgICAgIHk6IGZyYW1lc1tpXS5mcmFtZS55LAogICAgICAgICAgICAgICAgd2lkdGg6IGZyYW1lc1tpXS5mcmFtZS53LAogICAgICAgICAgICAgICAgaGVpZ2h0OiBmcmFtZXNbaV0uZnJhbWUuaAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChmcmFtZXNbaV0udHJpbW1lZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmV3RnJhbWUuc2V0VHJpbSgKICAgICAgICAgICAgICAgICAgICBmcmFtZXNbaV0udHJpbW1lZCwKICAgICAgICAgICAgICAgICAgICBmcmFtZXNbaV0uc291cmNlU2l6ZS53LAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1tpXS5zb3VyY2VTaXplLmgsCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2ldLnNwcml0ZVNvdXJjZVNpemUueCwKICAgICAgICAgICAgICAgICAgICBmcmFtZXNbaV0uc3ByaXRlU291cmNlU2l6ZS55LAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1tpXS5zcHJpdGVTb3VyY2VTaXplLncsCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2ldLnNwcml0ZVNvdXJjZVNpemUuaAogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICAvLyAgV2UgaGFkIHRvIGhhY2sgUGl4aSB0byBnZXQgdGhpcyB0byB3b3JrIDooCiAgICAgICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXS50cmltbWVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW0ueCA9IGZyYW1lc1tpXS5zcHJpdGVTb3VyY2VTaXplLng7CiAgICAgICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXS50cmltLnkgPSBmcmFtZXNbaV0uc3ByaXRlU291cmNlU2l6ZS55OwoKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGE7CgogICAgfSwKCiAgICAvKioKICAgICogUGFyc2UgdGhlIEpTT04gZGF0YSBhbmQgZXh0cmFjdCB0aGUgYW5pbWF0aW9uIGZyYW1lIGRhdGEgZnJvbSBpdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLkpTT05EYXRhSGFzaAogICAgKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBqc29uIC0gVGhlIEpTT04gZGF0YSBmcm9tIHRoZSBUZXh0dXJlIEF0bGFzLiBNdXN0IGJlIGluIEpTT04gSGFzaCBmb3JtYXQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZUtleSAtIFRoZSBHYW1lLkNhY2hlIGFzc2V0IGtleSBvZiB0aGUgdGV4dHVyZSBpbWFnZS4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lRGF0YX0gQSBGcmFtZURhdGEgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHBhcnNlZCBmcmFtZXMuCiAgICAqLwogICAgSlNPTkRhdGFIYXNoOiBmdW5jdGlvbiAoZ2FtZSwganNvbiwgY2FjaGVLZXkpIHsKCiAgICAgICAgLy8gIE1hbGZvcm1lZD8KICAgICAgICBpZiAoIWpzb25bJ2ZyYW1lcyddKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLkpTT05EYXRhSGFzaDogSW52YWxpZCBUZXh0dXJlIEF0bGFzIEpTT04gZ2l2ZW4sIG1pc3NpbmcgJ2ZyYW1lcycgb2JqZWN0Iik7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGpzb24pOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAvLyAgTGV0J3MgY3JlYXRlIHNvbWUgZnJhbWVzIHRoZW4KICAgICAgICB2YXIgZGF0YSA9IG5ldyBQaGFzZXIuRnJhbWVEYXRhKCk7CgogICAgICAgIC8vICBCeSB0aGlzIHN0YWdlIGZyYW1lcyBpcyBhIGZ1bGx5IHBhcnNlZCBhcnJheQogICAgICAgIHZhciBmcmFtZXMgPSBqc29uWydmcmFtZXMnXTsKICAgICAgICB2YXIgbmV3RnJhbWU7CiAgICAgICAgdmFyIGkgPSAwOwogICAgICAgIAogICAgICAgIGZvciAodmFyIGtleSBpbiBmcmFtZXMpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdXVpZCA9IGdhbWUucm5kLnV1aWQoKTsKCiAgICAgICAgICAgIG5ld0ZyYW1lID0gZGF0YS5hZGRGcmFtZShuZXcgUGhhc2VyLkZyYW1lKAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLmZyYW1lLngsCiAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS5mcmFtZS55LAogICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uZnJhbWUudywKICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLmZyYW1lLmgsCiAgICAgICAgICAgICAgICBrZXksCiAgICAgICAgICAgICAgICB1dWlkCiAgICAgICAgICAgICkpOwoKICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtjYWNoZUtleV0sIHsKICAgICAgICAgICAgICAgIHg6IGZyYW1lc1trZXldLmZyYW1lLngsCiAgICAgICAgICAgICAgICB5OiBmcmFtZXNba2V5XS5mcmFtZS55LAogICAgICAgICAgICAgICAgd2lkdGg6IGZyYW1lc1trZXldLmZyYW1lLncsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGZyYW1lc1trZXldLmZyYW1lLmgKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoZnJhbWVzW2tleV0udHJpbW1lZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmV3RnJhbWUuc2V0VHJpbSgKICAgICAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS50cmltbWVkLAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLnNvdXJjZVNpemUudywKICAgICAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS5zb3VyY2VTaXplLmgsCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uc3ByaXRlU291cmNlU2l6ZS54LAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLnNwcml0ZVNvdXJjZVNpemUueSwKICAgICAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS5zcHJpdGVTb3VyY2VTaXplLncsCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uc3ByaXRlU291cmNlU2l6ZS5oCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIC8vICBXZSBoYWQgdG8gaGFjayBQaXhpIHRvIGdldCB0aGlzIHRvIHdvcmsgOigKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW1tZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0udHJpbS54ID0gZnJhbWVzW2tleV0uc3ByaXRlU291cmNlU2l6ZS54OwogICAgICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0udHJpbS55ID0gZnJhbWVzW2tleV0uc3ByaXRlU291cmNlU2l6ZS55OwoKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaSsrOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGE7CgogICAgfSwKCiAgICAvKioKICAgICogUGFyc2UgdGhlIFhNTCBkYXRhIGFuZCBleHRyYWN0IHRoZSBhbmltYXRpb24gZnJhbWUgZGF0YSBmcm9tIGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25QYXJzZXIuWE1MRGF0YQogICAgKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSB4bWwgLSBUaGUgWE1MIGRhdGEgZnJvbSB0aGUgVGV4dHVyZSBBdGxhcy4gTXVzdCBiZSBpbiBTdGFybGluZyBYTUwgZm9ybWF0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gY2FjaGVLZXkgLSBUaGUgR2FtZS5DYWNoZSBhc3NldCBrZXkgb2YgdGhlIHRleHR1cmUgaW1hZ2UuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZURhdGF9IEEgRnJhbWVEYXRhIG9iamVjdCBjb250YWluaW5nIHRoZSBwYXJzZWQgZnJhbWVzLgogICAgKi8KICAgIFhNTERhdGE6IGZ1bmN0aW9uIChnYW1lLCB4bWwsIGNhY2hlS2V5KSB7CgogICAgICAgIC8vICBNYWxmb3JtZWQ/CiAgICAgICAgaWYgKCF4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ1RleHR1cmVBdGxhcycpKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLlhNTERhdGE6IEludmFsaWQgVGV4dHVyZSBBdGxhcyBYTUwgZ2l2ZW4sIG1pc3NpbmcgPFRleHR1cmVBdGxhcz4gdGFnIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vICBMZXQncyBjcmVhdGUgc29tZSBmcmFtZXMgdGhlbgogICAgICAgIHZhciBkYXRhID0gbmV3IFBoYXNlci5GcmFtZURhdGEoKTsKICAgICAgICB2YXIgZnJhbWVzID0geG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdTdWJUZXh0dXJlJyk7CiAgICAgICAgdmFyIG5ld0ZyYW1lOwoKICAgICAgICB2YXIgdXVpZDsKICAgICAgICB2YXIgbmFtZTsKICAgICAgICB2YXIgZnJhbWU7CiAgICAgICAgdmFyIHg7CiAgICAgICAgdmFyIHk7CiAgICAgICAgdmFyIHdpZHRoOwogICAgICAgIHZhciBoZWlnaHQ7CiAgICAgICAgdmFyIGZyYW1lWDsKICAgICAgICB2YXIgZnJhbWVZOwogICAgICAgIHZhciBmcmFtZVdpZHRoOwogICAgICAgIHZhciBmcmFtZUhlaWdodDsKICAgICAgICAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZyYW1lcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHV1aWQgPSBnYW1lLnJuZC51dWlkKCk7CgogICAgICAgICAgICBmcmFtZSA9IGZyYW1lc1tpXS5hdHRyaWJ1dGVzOwoKICAgICAgICAgICAgbmFtZSA9IGZyYW1lLm5hbWUubm9kZVZhbHVlOwogICAgICAgICAgICB4ID0gcGFyc2VJbnQoZnJhbWUueC5ub2RlVmFsdWUsIDEwKTsKICAgICAgICAgICAgeSA9IHBhcnNlSW50KGZyYW1lLnkubm9kZVZhbHVlLCAxMCk7CiAgICAgICAgICAgIHdpZHRoID0gcGFyc2VJbnQoZnJhbWUud2lkdGgubm9kZVZhbHVlLCAxMCk7CiAgICAgICAgICAgIGhlaWdodCA9IHBhcnNlSW50KGZyYW1lLmhlaWdodC5ub2RlVmFsdWUsIDEwKTsKCiAgICAgICAgICAgIGZyYW1lWCA9IG51bGw7CiAgICAgICAgICAgIGZyYW1lWSA9IG51bGw7CgogICAgICAgICAgICBpZiAoZnJhbWUuZnJhbWVYKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmcmFtZVggPSBNYXRoLmFicyhwYXJzZUludChmcmFtZS5mcmFtZVgubm9kZVZhbHVlLCAxMCkpOwogICAgICAgICAgICAgICAgZnJhbWVZID0gTWF0aC5hYnMocGFyc2VJbnQoZnJhbWUuZnJhbWVZLm5vZGVWYWx1ZSwgMTApKTsKICAgICAgICAgICAgICAgIGZyYW1lV2lkdGggPSBwYXJzZUludChmcmFtZS5mcmFtZVdpZHRoLm5vZGVWYWx1ZSwgMTApOwogICAgICAgICAgICAgICAgZnJhbWVIZWlnaHQgPSBwYXJzZUludChmcmFtZS5mcmFtZUhlaWdodC5ub2RlVmFsdWUsIDEwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbmV3RnJhbWUgPSBkYXRhLmFkZEZyYW1lKG5ldyBQaGFzZXIuRnJhbWUoaSwgeCwgeSwgd2lkdGgsIGhlaWdodCwgbmFtZSwgdXVpZCkpOwoKICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtjYWNoZUtleV0sIHsKICAgICAgICAgICAgICAgIHg6IHgsCiAgICAgICAgICAgICAgICB5OiB5LAogICAgICAgICAgICAgICAgd2lkdGg6IHdpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyAgVHJpbW1lZD8KICAgICAgICAgICAgaWYgKGZyYW1lWCAhPT0gbnVsbCB8fCBmcmFtZVkgIT09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5ld0ZyYW1lLnNldFRyaW0odHJ1ZSwgd2lkdGgsIGhlaWdodCwgZnJhbWVYLCBmcmFtZVksIGZyYW1lV2lkdGgsIGZyYW1lSGVpZ2h0KTsKCiAgICAgICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXS5yZWFsU2l6ZSA9IHsgeDogZnJhbWVYLCB5OiBmcmFtZVksIHc6IGZyYW1lV2lkdGgsIGg6IGZyYW1lSGVpZ2h0IH07CgogICAgICAgICAgICAgICAgLy8gIFdlIGhhZCB0byBoYWNrIFBpeGkgdG8gZ2V0IHRoaXMgdG8gd29yayA6KAogICAgICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0udHJpbW1lZCA9IHRydWU7CiAgICAgICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXS50cmltLnggPSBmcmFtZVg7CiAgICAgICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXS50cmltLnkgPSBmcmFtZVk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBkYXRhOwoKICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIuQ2FjaGUgY29uc3RydWN0b3IuCioKKiBAY2xhc3MgUGhhc2VyLkNhY2hlCiogQGNsYXNzZGVzYyBBIGdhbWUgb25seSBoYXMgb25lIGluc3RhbmNlIG9mIGEgQ2FjaGUgYW5kIGl0IGlzIHVzZWQgdG8gc3RvcmUgYWxsIGV4dGVybmFsbHkgbG9hZGVkIGFzc2V0cyBzdWNoIGFzIGltYWdlcywgc291bmRzIGFuZCBkYXRhIGZpbGVzIGFzIGEgcmVzdWx0IG9mIExvYWRlciBjYWxscy4gQ2FjaGVkIGl0ZW1zIHVzZSBzdHJpbmcgYmFzZWQga2V5cyBmb3IgbG9vay11cC4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5DYWNoZSA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBMb2NhbCByZWZlcmVuY2UgdG8gZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gZ2FtZSAtIENhbnZhcyBrZXktdmFsdWUgY29udGFpbmVyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2NhbnZhc2VzID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfaW1hZ2VzIC0gSW1hZ2Uga2V5LXZhbHVlIGNvbnRhaW5lci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9pbWFnZXMgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF90ZXh0dXJlcyAtIFJlbmRlclRleHR1cmUga2V5LXZhbHVlIGNvbnRhaW5lci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90ZXh0dXJlcyA9IHt9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX3NvdW5kcyAtIFNvdW5kIGtleS12YWx1ZSBjb250YWluZXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fc291bmRzID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfdGV4dCAtIFRleHQga2V5LXZhbHVlIGNvbnRhaW5lci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90ZXh0ID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfdGlsZW1hcHMgLSBUaWxlbWFwIGtleS12YWx1ZSBjb250YWluZXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdGlsZW1hcHMgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF9iaW5hcnkgLSBCaW5hcnkgZmlsZSBrZXktdmFsdWUgY29udGFpbmVyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2JpbmFyeSA9IHt9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX2JpdG1hcERhdGFzIC0gQml0bWFwRGF0YSBrZXktdmFsdWUgY29udGFpbmVyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2JpdG1hcERhdGFzID0ge307CgogICAgdGhpcy5hZGREZWZhdWx0SW1hZ2UoKTsKICAgIHRoaXMuYWRkTWlzc2luZ0ltYWdlKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Tb3VuZFVubG9jayAtIFRoaXMgZXZlbnQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoZSBzb3VuZCBzeXN0ZW0gaXMgdW5sb2NrZWQgdmlhIGEgdG91Y2ggZXZlbnQgb24gY2VsbHVsYXIgZGV2aWNlcy4KICAgICovCiAgICB0aGlzLm9uU291bmRVbmxvY2sgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKfTsKClBoYXNlci5DYWNoZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBjYW52YXMgb2JqZWN0IGluIHRvIHRoZSBjYWNoZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkQ2FudmFzCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoaXMgY2FudmFzLgogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBDYW52YXMgRE9NIGVsZW1lbnQuCiAgICAqIEBwYXJhbSB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBjb250ZXh0IC0gUmVuZGVyIGNvbnRleHQgb2YgdGhpcyBjYW52YXMuCiAgICAqLwogICAgYWRkQ2FudmFzOiBmdW5jdGlvbiAoa2V5LCBjYW52YXMsIGNvbnRleHQpIHsKCiAgICAgICAgdGhpcy5fY2FudmFzZXNba2V5XSA9IHsgY2FudmFzOiBjYW52YXMsIGNvbnRleHQ6IGNvbnRleHQgfTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBiaW5hcnkgb2JqZWN0IGluIHRvIHRoZSBjYWNoZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkQmluYXJ5CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoaXMgYmluYXJ5IGRhdGEuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBiaW5hcnlEYXRhIC0gVGhlIGJpbmFyeSBvYmplY3QgdG8gYmUgYWRkZGVkIHRvIHRoZSBjYWNoZS4KICAgICovCiAgICBhZGRCaW5hcnk6IGZ1bmN0aW9uIChrZXksIGJpbmFyeURhdGEpIHsKCiAgICAgICAgdGhpcy5fYmluYXJ5W2tleV0gPSBiaW5hcnlEYXRhOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIEJpdG1hcERhdGEgb2JqZWN0IGluIHRvIHRoZSBjYWNoZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkQml0bWFwRGF0YQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGlzIEJpdG1hcERhdGEuCiAgICAqIEBwYXJhbSB7UGhhc2VyLkJpdG1hcERhdGF9IGJpdG1hcERhdGEgLSBUaGUgQml0bWFwRGF0YSBvYmplY3QgdG8gYmUgYWRkZGVkIHRvIHRoZSBjYWNoZS4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIG9iamVjdCB0byBiZSBhZGRkZWQgdG8gdGhlIGNhY2hlLgogICAgKi8KICAgIGFkZEJpdG1hcERhdGE6IGZ1bmN0aW9uIChrZXksIGJpdG1hcERhdGEpIHsKCiAgICAgICAgdGhpcy5fYml0bWFwRGF0YXNba2V5XSA9IGJpdG1hcERhdGE7CgogICAgICAgIHJldHVybiBiaXRtYXBEYXRhOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBQaGFzZXIuUmVuZGVyVGV4dHVyZSBpbiB0byB0aGUgY2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZFJlbmRlclRleHR1cmUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSB1bmlxdWUga2V5IGJ5IHdoaWNoIHlvdSB3aWxsIHJlZmVyZW5jZSB0aGlzIG9iamVjdC4KICAgICogQHBhcmFtIHtQaGFzZXIuVGV4dHVyZX0gdGV4dHVyZSAtIFRoZSB0ZXh0dXJlIHRvIHVzZSBhcyB0aGUgYmFzZSBvZiB0aGUgUmVuZGVyVGV4dHVyZS4KICAgICovCiAgICBhZGRSZW5kZXJUZXh0dXJlOiBmdW5jdGlvbiAoa2V5LCB0ZXh0dXJlKSB7CgogICAgICAgIHZhciBmcmFtZSA9IG5ldyBQaGFzZXIuRnJhbWUoMCwgMCwgMCwgdGV4dHVyZS53aWR0aCwgdGV4dHVyZS5oZWlnaHQsICcnLCAnJyk7CgogICAgICAgIHRoaXMuX3RleHR1cmVzW2tleV0gPSB7IHRleHR1cmU6IHRleHR1cmUsIGZyYW1lOiBmcmFtZSB9OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBzcHJpdGUgc2hlZXQgaW4gdG8gdGhlIGNhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRTcHJpdGVTaGVldAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHVuaXF1ZSBrZXkgYnkgd2hpY2ggeW91IHdpbGwgcmVmZXJlbmNlIHRoaXMgb2JqZWN0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoaXMgc3ByaXRlIHNoZWV0IGZpbGUuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gRXh0cmEgc3ByaXRlIHNoZWV0IGRhdGEuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBmcmFtZVdpZHRoIC0gV2lkdGggb2YgdGhlIHNwcml0ZSBzaGVldC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGZyYW1lSGVpZ2h0IC0gSGVpZ2h0IG9mIHRoZSBzcHJpdGUgc2hlZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJhbWVNYXg9LTFdIC0gSG93IG1hbnkgZnJhbWVzIHN0b3JlZCBpbiB0aGUgc3ByaXRlIHNoZWV0LiBJZiAtMSB0aGVuIGl0IGRpdmlkZXMgdGhlIHdob2xlIHNoZWV0IGV2ZW5seS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFttYXJnaW49MF0gLSBJZiB0aGUgZnJhbWVzIGhhdmUgYmVlbiBkcmF3biB3aXRoIGEgbWFyZ2luLCBzcGVjaWZ5IHRoZSBhbW91bnQgaGVyZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGFjaW5nPTBdIC0gSWYgdGhlIGZyYW1lcyBoYXZlIGJlZW4gZHJhd24gd2l0aCBzcGFjaW5nIGJldHdlZW4gdGhlbSwgc3BlY2lmeSB0aGUgYW1vdW50IGhlcmUuCiAgICAqLwogICAgYWRkU3ByaXRlU2hlZXQ6IGZ1bmN0aW9uIChrZXksIHVybCwgZGF0YSwgZnJhbWVXaWR0aCwgZnJhbWVIZWlnaHQsIGZyYW1lTWF4LCBtYXJnaW4sIHNwYWNpbmcpIHsKCiAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0gPSB7IHVybDogdXJsLCBkYXRhOiBkYXRhLCBzcHJpdGVTaGVldDogdHJ1ZSwgZnJhbWVXaWR0aDogZnJhbWVXaWR0aCwgZnJhbWVIZWlnaHQ6IGZyYW1lSGVpZ2h0LCBtYXJnaW46IG1hcmdpbiwgc3BhY2luZzogc3BhY2luZyB9OwoKICAgICAgICBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKGRhdGEpOwogICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldKTsKCiAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhID0gUGhhc2VyLkFuaW1hdGlvblBhcnNlci5zcHJpdGVTaGVldCh0aGlzLmdhbWUsIGtleSwgZnJhbWVXaWR0aCwgZnJhbWVIZWlnaHQsIGZyYW1lTWF4LCBtYXJnaW4sIHNwYWNpbmcpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyB0aWxlbWFwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRUaWxlbWFwCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgdW5pcXVlIGtleSBieSB3aGljaCB5b3Ugd2lsbCByZWZlcmVuY2UgdGhpcyBvYmplY3QuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhlIHRpbGVtYXAgaW1hZ2UuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBtYXBEYXRhIC0gVGhlIHRpbGVtYXAgZGF0YSBvYmplY3QgKGVpdGhlciBhIENTViBvciBKU09OIGZpbGUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gZm9ybWF0IC0gVGhlIGZvcm1hdCBvZiB0aGUgdGlsZW1hcCBkYXRhLgogICAgKi8KICAgIGFkZFRpbGVtYXA6IGZ1bmN0aW9uIChrZXksIHVybCwgbWFwRGF0YSwgZm9ybWF0KSB7CgogICAgICAgIHRoaXMuX3RpbGVtYXBzW2tleV0gPSB7IHVybDogdXJsLCBkYXRhOiBtYXBEYXRhLCBmb3JtYXQ6IGZvcm1hdCB9OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyB0ZXh0dXJlIGF0bGFzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRUZXh0dXJlQXRsYXMKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSB1bmlxdWUga2V5IGJ5IHdoaWNoIHlvdSB3aWxsIHJlZmVyZW5jZSB0aGlzIG9iamVjdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGlzIHRleHR1cmUgYXRsYXMgZmlsZS4KICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBFeHRyYSB0ZXh0dXJlIGF0bGFzIGRhdGEuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBhdGxhc0RhdGEgIC0gVGV4dHVyZSBhdGxhcyBmcmFtZXMgZGF0YS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGZvcm1hdCAtIFRoZSBmb3JtYXQgb2YgdGhlIHRleHR1cmUgYXRsYXMuCiAgICAqLwogICAgYWRkVGV4dHVyZUF0bGFzOiBmdW5jdGlvbiAoa2V5LCB1cmwsIGRhdGEsIGF0bGFzRGF0YSwgZm9ybWF0KSB7CgogICAgICAgIHRoaXMuX2ltYWdlc1trZXldID0geyB1cmw6IHVybCwgZGF0YTogZGF0YSwgc3ByaXRlU2hlZXQ6IHRydWUgfTsKCiAgICAgICAgUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5CYXNlVGV4dHVyZShkYXRhKTsKICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVtrZXldID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSk7CgogICAgICAgIGlmIChmb3JtYXQgPT0gUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX0pTT05fQVJSQVkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEgPSBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLkpTT05EYXRhKHRoaXMuZ2FtZSwgYXRsYXNEYXRhLCBrZXkpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChmb3JtYXQgPT0gUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX0pTT05fSEFTSCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lRGF0YSA9IFBoYXNlci5BbmltYXRpb25QYXJzZXIuSlNPTkRhdGFIYXNoKHRoaXMuZ2FtZSwgYXRsYXNEYXRhLCBrZXkpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChmb3JtYXQgPT0gUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX1hNTF9TVEFSTElORykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lRGF0YSA9IFBoYXNlci5BbmltYXRpb25QYXJzZXIuWE1MRGF0YSh0aGlzLmdhbWUsIGF0bGFzRGF0YSwga2V5KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IEJpdG1hcCBGb250LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRCaXRtYXBGb250CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgdW5pcXVlIGtleSBieSB3aGljaCB5b3Ugd2lsbCByZWZlcmVuY2UgdGhpcyBvYmplY3QuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhpcyBmb250IHhtbCBmaWxlLgogICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEV4dHJhIGZvbnQgZGF0YS4KICAgICogQHBhcmFtIHhtbERhdGEge29iamVjdH0gVGV4dHVyZSBhdGxhcyBmcmFtZXMgZGF0YS4KICAgICovCiAgICBhZGRCaXRtYXBGb250OiBmdW5jdGlvbiAoa2V5LCB1cmwsIGRhdGEsIHhtbERhdGEpIHsKCiAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0gPSB7IHVybDogdXJsLCBkYXRhOiBkYXRhLCBzcHJpdGVTaGVldDogdHJ1ZSB9OwoKICAgICAgICBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKGRhdGEpOwogICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldKTsKCiAgICAgICAgUGhhc2VyLkxvYWRlclBhcnNlci5iaXRtYXBGb250KHRoaXMuZ2FtZSwgeG1sRGF0YSwga2V5KTsKICAgICAgICAvLyB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEgPSBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLlhNTERhdGEodGhpcy5nYW1lLCB4bWxEYXRhLCBrZXkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgYSBkZWZhdWx0IGltYWdlIHRvIGJlIHVzZWQgaW4gc3BlY2lhbCBjYXNlcyBzdWNoIGFzIFdlYkdMIEZpbHRlcnMuIElzIG1hcHBlZCB0byB0aGUga2V5IF9fZGVmYXVsdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkRGVmYXVsdEltYWdlCiAgICAqLwogICAgYWRkRGVmYXVsdEltYWdlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBpbWcgPSBuZXcgSW1hZ2UoKTsKICAgICAgICBpbWcuc3JjID0gImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQ0FBQUFBZ0FRTUFBQUJKdE9pM0FBQUFBMUJNVkVYLy8vK254QnZJQUFBQUFYUlNUbE1BUU9iWVpnQUFBQlZKUkVGVWVGN053SUVBQUFBQWdLRDlxZGVvY0FNQW9BQUJtM0RrY0FBQUFBQkpSVTVFcmtKZ2dnPT0iOwoKICAgICAgICB0aGlzLl9pbWFnZXNbJ19fZGVmYXVsdCddID0geyB1cmw6IG51bGwsIGRhdGE6IGltZywgc3ByaXRlU2hlZXQ6IGZhbHNlIH07CiAgICAgICAgdGhpcy5faW1hZ2VzWydfX2RlZmF1bHQnXS5mcmFtZSA9IG5ldyBQaGFzZXIuRnJhbWUoMCwgMCwgMCwgMzIsIDMyLCAnJywgJycpOwoKICAgICAgICBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbJ19fZGVmYXVsdCddID0gbmV3IFBJWEkuQmFzZVRleHR1cmUoaW1nKTsKICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVsnX19kZWZhdWx0J10gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVsnX19kZWZhdWx0J10pOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgYW4gaW1hZ2UgdG8gYmUgdXNlZCB3aGVuIGEga2V5IGlzIHdyb25nIC8gbWlzc2luZy4gSXMgbWFwcGVkIHRvIHRoZSBrZXkgX19taXNzaW5nLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRNaXNzaW5nSW1hZ2UKICAgICovCiAgICBhZGRNaXNzaW5nSW1hZ2U6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpOwogICAgICAgIGltZy5zcmMgPSAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFDQUFBQUFnQ0FJQUFBRDhHTzJqQUFBQUdYUkZXSFJUYjJaMGQyRnlaUUJCWkc5aVpTQkpiV0ZuWlZKbFlXUjVjY2xsUEFBQUFKOUpSRUZVZU5xMDFzc093eUFNUkZHNDZ2Ly9NdDFFU21naCtERm1FMkdQT0JBUktiMk5Wam8rMTdQWExEOGExK3BsNStBK3dTZ0Z5Z3ltV1lIQmIwRnRzS2hKRGRabG5jRzJJeko0YXlvTUR2MjB3VG1TTXpDbEVnYldZTlRBa1EwWitPSitBL2VXbkFhUjkrb3hDRjRPczBIOGh0c01VcCtwd2NnQkJpTU5uQXdGOEdxSWdMMmhBemFHRkZnWmF1RFBLQUJtb3daNEdMMzY5LzByd0FDcDJ5QS90dG12c1FBQUFBQkpSVTVFcmtKZ2dnPT0iOwoKICAgICAgICB0aGlzLl9pbWFnZXNbJ19fbWlzc2luZyddID0geyB1cmw6IG51bGwsIGRhdGE6IGltZywgc3ByaXRlU2hlZXQ6IGZhbHNlIH07CiAgICAgICAgdGhpcy5faW1hZ2VzWydfX21pc3NpbmcnXS5mcmFtZSA9IG5ldyBQaGFzZXIuRnJhbWUoMCwgMCwgMCwgMzIsIDMyLCAnJywgJycpOwoKICAgICAgICBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbJ19fbWlzc2luZyddID0gbmV3IFBJWEkuQmFzZVRleHR1cmUoaW1nKTsKICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVsnX19taXNzaW5nJ10gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVsnX19taXNzaW5nJ10pOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyB0ZXh0IGRhdGEuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZFRleHQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHRleHQgZGF0YS4gCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhpcyB0ZXh0IGRhdGEgZmlsZS4KICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBFeHRyYSB0ZXh0IGRhdGEuCiAgICAqLwogICAgYWRkVGV4dDogZnVuY3Rpb24gKGtleSwgdXJsLCBkYXRhKSB7CgogICAgICAgIHRoaXMuX3RleHRba2V5XSA9IHsKICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICB9OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBpbWFnZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkSW1hZ2UKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSB1bmlxdWUga2V5IGJ5IHdoaWNoIHlvdSB3aWxsIHJlZmVyZW5jZSB0aGlzIG9iamVjdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGlzIGltYWdlIGZpbGUuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gRXh0cmEgaW1hZ2UgZGF0YS4KICAgICovCiAgICBhZGRJbWFnZTogZnVuY3Rpb24gKGtleSwgdXJsLCBkYXRhKSB7CgogICAgICAgIHRoaXMuX2ltYWdlc1trZXldID0geyB1cmw6IHVybCwgZGF0YTogZGF0YSwgc3ByaXRlU2hlZXQ6IGZhbHNlIH07CgogICAgICAgIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lID0gbmV3IFBoYXNlci5GcmFtZSgwLCAwLCAwLCBkYXRhLndpZHRoLCBkYXRhLmhlaWdodCwga2V5LCB0aGlzLmdhbWUucm5kLnV1aWQoKSk7CgogICAgICAgIFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldID0gbmV3IFBJWEkuQmFzZVRleHR1cmUoZGF0YSk7CiAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVba2V5XSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0pOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBzb3VuZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkU291bmQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHNvdW5kLgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoaXMgc291bmQgZmlsZS4KICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBFeHRyYSBzb3VuZCBkYXRhLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHdlYkF1ZGlvIC0gVHJ1ZSBpZiB0aGUgZmlsZSBpcyB1c2luZyB3ZWIgYXVkaW8uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gYXVkaW9UYWcgLSBUcnVlIGlmIHRoZSBmaWxlIGlzIHVzaW5nIGxlZ2FjeSBIVE1MIGF1ZGlvLgogICAgKi8KICAgIGFkZFNvdW5kOiBmdW5jdGlvbiAoa2V5LCB1cmwsIGRhdGEsIHdlYkF1ZGlvLCBhdWRpb1RhZykgewoKICAgICAgICB3ZWJBdWRpbyA9IHdlYkF1ZGlvIHx8IHRydWU7CiAgICAgICAgYXVkaW9UYWcgPSBhdWRpb1RhZyB8fCBmYWxzZTsKCiAgICAgICAgdmFyIGRlY29kZWQgPSBmYWxzZTsKCiAgICAgICAgaWYgKGF1ZGlvVGFnKQogICAgICAgIHsKICAgICAgICAgICAgZGVjb2RlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9zb3VuZHNba2V5XSA9IHsgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIGlzRGVjb2Rpbmc6IGZhbHNlLCBkZWNvZGVkOiBkZWNvZGVkLCB3ZWJBdWRpbzogd2ViQXVkaW8sIGF1ZGlvVGFnOiBhdWRpb1RhZywgbG9ja2VkOiB0aGlzLmdhbWUuc291bmQudG91Y2hMb2NrZWQgfTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZWxvYWQgYSBzb3VuZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjcmVsb2FkU291bmQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHNvdW5kLgogICAgKi8KICAgIHJlbG9hZFNvdW5kOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIGlmICh0aGlzLl9zb3VuZHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3NvdW5kc1trZXldLmRhdGEuc3JjID0gdGhpcy5fc291bmRzW2tleV0udXJsOwoKICAgICAgICAgICAgdGhpcy5fc291bmRzW2tleV0uZGF0YS5hZGRFdmVudExpc3RlbmVyKCdjYW5wbGF5dGhyb3VnaCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5yZWxvYWRTb3VuZENvbXBsZXRlKGtleSk7CiAgICAgICAgICAgIH0sIGZhbHNlKTsKCiAgICAgICAgICAgIHRoaXMuX3NvdW5kc1trZXldLmRhdGEubG9hZCgpOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAqIEZpcmVzIHRoZSBvblNvdW5kVW5sb2NrIGV2ZW50IHdoZW4gdGhlIHNvdW5kIGhhcyBjb21wbGV0ZWQgcmVsb2FkaW5nLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNyZWxvYWRTb3VuZENvbXBsZXRlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSBzb3VuZC4KICAgICovCiAgICByZWxvYWRTb3VuZENvbXBsZXRlOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9zb3VuZHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3NvdW5kc1trZXldLmxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm9uU291bmRVbmxvY2suZGlzcGF0Y2goa2V5KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlcyB0aGUgc291bmQgb2JqZWN0IGluIHRoZSBjYWNoZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjdXBkYXRlU291bmQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHNvdW5kLgogICAgKi8KICAgIHVwZGF0ZVNvdW5kOiBmdW5jdGlvbiAoa2V5LCBwcm9wZXJ0eSwgdmFsdWUpIHsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5fc291bmRzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9zb3VuZHNba2V5XVtwcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IGRlY29kZWQgc291bmQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2RlY29kZWRTb3VuZAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgc291bmQuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gRXh0cmEgc291bmQgZGF0YS4KICAgICovCiAgICBkZWNvZGVkU291bmQ6IGZ1bmN0aW9uIChrZXksIGRhdGEpIHsKCiAgICAgICAgdGhpcy5fc291bmRzW2tleV0uZGF0YSA9IGRhdGE7CiAgICAgICAgdGhpcy5fc291bmRzW2tleV0uZGVjb2RlZCA9IHRydWU7CiAgICAgICAgdGhpcy5fc291bmRzW2tleV0uaXNEZWNvZGluZyA9IGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBhIGNhbnZhcyBvYmplY3QgZnJvbSB0aGUgY2FjaGUgYnkgaXRzIGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0Q2FudmFzCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIGNhbnZhcyB0byByZXRyaWV2ZSBmcm9tIHRoZSBDYWNoZS4KICAgICogQHJldHVybiB7b2JqZWN0fSBUaGUgY2FudmFzIG9iamVjdC4KICAgICovCiAgICBnZXRDYW52YXM6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2NhbnZhc2VzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fY2FudmFzZXNba2V5XS5jYW52YXM7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignUGhhc2VyLkNhY2hlLmdldENhbnZhczogSW52YWxpZCBrZXk6ICInICsga2V5ICsgJyInKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgQml0bWFwRGF0YSBvYmplY3QgZnJvbSB0aGUgY2FjaGUgYnkgaXRzIGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0Qml0bWFwRGF0YQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBCaXRtYXBEYXRhIG9iamVjdCB0byByZXRyaWV2ZSBmcm9tIHRoZSBDYWNoZS4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSByZXF1ZXN0ZWQgQml0bWFwRGF0YSBvYmplY3QgaWYgZm91bmQsIG9yIG51bGwgaWYgbm90LgogICAgKi8KICAgIGdldEJpdG1hcERhdGE6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2JpdG1hcERhdGFzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fYml0bWFwRGF0YXNba2V5XTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdQaGFzZXIuQ2FjaGUuZ2V0Qml0bWFwRGF0YTogSW52YWxpZCBrZXk6ICInICsga2V5ICsgJyInKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGlmIGFuIGltYWdlIGtleSBleGlzdHMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2NoZWNrSW1hZ2VLZXkKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgaW1hZ2UgdG8gY2hlY2sgaXMgaW4gdGhlIENhY2hlLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBrZXkgZXhpc3RzLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgY2hlY2tJbWFnZUtleTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5faW1hZ2VzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgaW1hZ2UgZGF0YSBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldEltYWdlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIGltYWdlIHRvIHJldHJpZXZlIGZyb20gdGhlIENhY2hlLgogICAgKiBAcmV0dXJuIHtvYmplY3R9IFRoZSBpbWFnZSBkYXRhLgogICAgKi8KICAgIGdldEltYWdlOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9pbWFnZXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbWFnZXNba2V5XS5kYXRhOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BoYXNlci5DYWNoZS5nZXRJbWFnZTogSW52YWxpZCBrZXk6ICInICsga2V5ICsgJyInKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IHRpbGVtYXAgZGF0YSBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFRpbGVtYXAKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgdGlsZW1hcCBkYXRhIHRvIHJldHJpZXZlIGZyb20gdGhlIENhY2hlLgogICAgKiBAcmV0dXJuIHtPYmplY3R9IFRoZSByYXcgdGlsZW1hcCBkYXRhIGluIENTViBvciBKU09OIGZvcm1hdC4KICAgICovCiAgICBnZXRUaWxlbWFwRGF0YTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fdGlsZW1hcHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90aWxlbWFwc1trZXldOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BoYXNlci5DYWNoZS5nZXRUaWxlbWFwRGF0YTogSW52YWxpZCBrZXk6ICInICsga2V5ICsgJyInKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IGZyYW1lIGRhdGEgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRGcmFtZURhdGEKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgZnJhbWUgZGF0YSB0byByZXRyaWV2ZSBmcm9tIHRoZSBDYWNoZS4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lRGF0YX0gVGhlIGZyYW1lIGRhdGEuCiAgICAqLwogICAgZ2V0RnJhbWVEYXRhOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9pbWFnZXNba2V5XSAmJiB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgYSBzaW5nbGUgZnJhbWUgb3V0IG9mIGEgZnJhbWVEYXRhIHNldCBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldEZyYW1lQnlJbmRleAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBmcmFtZSBkYXRhIHRvIHJldHJpZXZlIGZyb20gdGhlIENhY2hlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWV9IFRoZSBmcmFtZSBvYmplY3QuCiAgICAqLwogICAgZ2V0RnJhbWVCeUluZGV4OiBmdW5jdGlvbiAoa2V5LCBmcmFtZSkgewoKICAgICAgICBpZiAodGhpcy5faW1hZ2VzW2tleV0gJiYgdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lRGF0YS5nZXRGcmFtZShmcmFtZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBhIHNpbmdsZSBmcmFtZSBvdXQgb2YgYSBmcmFtZURhdGEgc2V0IGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0RnJhbWVCeU5hbWUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgZnJhbWUgZGF0YSB0byByZXRyaWV2ZSBmcm9tIHRoZSBDYWNoZS4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lfSBUaGUgZnJhbWUgb2JqZWN0LgogICAgKi8KICAgIGdldEZyYW1lQnlOYW1lOiBmdW5jdGlvbiAoa2V5LCBmcmFtZSkgewoKICAgICAgICBpZiAodGhpcy5faW1hZ2VzW2tleV0gJiYgdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lRGF0YS5nZXRGcmFtZUJ5TmFtZShmcmFtZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBhIHNpbmdsZSBmcmFtZSBieSBrZXkuIFlvdSdkIG9ubHkgZG8gdGhpcyB0byBnZXQgdGhlIGRlZmF1bHQgRnJhbWUgY3JlYXRlZCBmb3IgYSBub24tYXRsYXMvc3ByaXRlc2hlZXQgaW1hZ2UuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldEZyYW1lCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIGZyYW1lIGRhdGEgdG8gcmV0cmlldmUgZnJvbSB0aGUgQ2FjaGUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZX0gVGhlIGZyYW1lIGRhdGEuCiAgICAqLwogICAgZ2V0RnJhbWU6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ltYWdlc1trZXldICYmIHRoaXMuX2ltYWdlc1trZXldLnNwcml0ZVNoZWV0ID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgc2luZ2xlIHRleHR1cmUgZnJhbWUgYnkga2V5LiBZb3UnZCBvbmx5IGRvIHRoaXMgdG8gZ2V0IHRoZSBkZWZhdWx0IEZyYW1lIGNyZWF0ZWQgZm9yIGEgbm9uLWF0bGFzL3Nwcml0ZXNoZWV0IGltYWdlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRUZXh0dXJlRnJhbWUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgZnJhbWUgdG8gcmV0cmlldmUgZnJvbSB0aGUgQ2FjaGUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZX0gVGhlIGZyYW1lIGRhdGEuCiAgICAqLwogICAgZ2V0VGV4dHVyZUZyYW1lOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl90ZXh0dXJlc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RleHR1cmVzW2tleV0uZnJhbWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBhIFJlbmRlclRleHR1cmUgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRUZXh0dXJlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIFJlbmRlclRleHR1cmUgdG8gcmV0cmlldmUgZnJvbSB0aGUgQ2FjaGUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5SZW5kZXJUZXh0dXJlfSBUaGUgUmVuZGVyVGV4dHVyZSBvYmplY3QuCiAgICAqLwogICAgZ2V0VGV4dHVyZTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fdGV4dHVyZXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90ZXh0dXJlc1trZXldOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BoYXNlci5DYWNoZS5nZXRUZXh0dXJlOiBJbnZhbGlkIGtleTogIicgKyBrZXkgKyAnIicpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgc291bmQgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRTb3VuZAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBzb3VuZCB0byByZXRyaWV2ZSBmcm9tIHRoZSBDYWNoZS4KICAgICogQHJldHVybiB7UGhhc2VyLlNvdW5kfSBUaGUgc291bmQgb2JqZWN0LgogICAgKi8KICAgIGdldFNvdW5kOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9zb3VuZHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zb3VuZHNba2V5XTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdQaGFzZXIuQ2FjaGUuZ2V0U291bmQ6IEludmFsaWQga2V5OiAiJyArIGtleSArICciJyk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBzb3VuZCBkYXRhIGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0U291bmREYXRhCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIHNvdW5kIHRvIHJldHJpZXZlIGZyb20gdGhlIENhY2hlLgogICAgKiBAcmV0dXJuIHtvYmplY3R9IFRoZSBzb3VuZCBkYXRhLgogICAgKi8KICAgIGdldFNvdW5kRGF0YTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fc291bmRzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc291bmRzW2tleV0uZGF0YTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdQaGFzZXIuQ2FjaGUuZ2V0U291bmREYXRhOiBJbnZhbGlkIGtleTogIicgKyBrZXkgKyAnIicpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayBpZiB0aGUgZ2l2ZW4gc291bmQgaGFzIGZpbmlzaGVkIGRlY29kaW5nLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNpc1NvdW5kRGVjb2RlZAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBzb3VuZCBpbiB0aGUgQ2FjaGUuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRoZSBkZWNvZGVkIHN0YXRlIG9mIHRoZSBTb3VuZCBvYmplY3QuCiAgICAqLwogICAgaXNTb3VuZERlY29kZWQ6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NvdW5kc1trZXldLmRlY29kZWQ7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrIGlmIHRoZSBnaXZlbiBzb3VuZCBpcyByZWFkeSBmb3IgcGxheWJhY2suIEEgc291bmQgaXMgY29uc2lkZXJlZCByZWFkeSB3aGVuIGl0IGhhcyBmaW5pc2hlZCBkZWNvZGluZyBhbmQgdGhlIGRldmljZSBpcyBubyBsb25nZXIgdG91Y2ggbG9ja2VkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNpc1NvdW5kUmVhZHkKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgc291bmQgaW4gdGhlIENhY2hlLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBzb3VuZCBpcyBkZWNvZGVkIGFuZCB0aGUgZGV2aWNlIGlzIG5vdCB0b3VjaCBsb2NrZWQuCiAgICAqLwogICAgaXNTb3VuZFJlYWR5OiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIHJldHVybiAodGhpcy5fc291bmRzW2tleV0gJiYgdGhpcy5fc291bmRzW2tleV0uZGVjb2RlZCAmJiB0aGlzLmdhbWUuc291bmQudG91Y2hMb2NrZWQgPT09IGZhbHNlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayB3aGV0aGVyIGFuIGltYWdlIGFzc2V0IGlzIHNwcml0ZSBzaGVldCBvciBub3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2lzU3ByaXRlU2hlZXQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgc3ByaXRlIHNoZWV0IHlvdSB3YW50LgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBpbWFnZSBpcyBhIHNwcml0ZSBzaGVldC4KICAgICovCiAgICBpc1Nwcml0ZVNoZWV0OiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9pbWFnZXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbWFnZXNba2V5XS5zcHJpdGVTaGVldDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgdGV4dCBkYXRhIGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0VGV4dAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSB0ZXh0IGRhdGEgdG8gcmV0cmlldmUgZnJvbSB0aGUgQ2FjaGUuCiAgICAqIEByZXR1cm4ge29iamVjdH0gVGhlIHRleHQgZGF0YS4KICAgICovCiAgICBnZXRUZXh0OiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl90ZXh0W2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGV4dFtrZXldLmRhdGE7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignUGhhc2VyLkNhY2hlLmdldFRleHQ6IEludmFsaWQga2V5OiAiJyArIGtleSArICciJyk7CiAgICAgICAgfQogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogR2V0IGJpbmFyeSBkYXRhIGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0QmluYXJ5CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIGJpbmFyeSBkYXRhIG9iamVjdCB0byByZXRyaWV2ZSBmcm9tIHRoZSBDYWNoZS4KICAgICogQHJldHVybiB7b2JqZWN0fSBUaGUgYmluYXJ5IGRhdGEgb2JqZWN0LgogICAgKi8KICAgIGdldEJpbmFyeTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fYmluYXJ5W2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fYmluYXJ5W2tleV07CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignUGhhc2VyLkNhY2hlLmdldEJpbmFyeTogSW52YWxpZCBrZXk6ICInICsga2V5ICsgJyInKTsKICAgICAgICB9CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgdGhlIGNhY2hlIGtleXMgZnJvbSBhIGdpdmVuIGFycmF5IG9mIG9iamVjdHMuCiAgICAqIE5vcm1hbGx5IHlvdSBkb24ndCBjYWxsIHRoaXMgZGlyZWN0bHkgYnV0IGluc3RlYWQgdXNlIGdldEltYWdlS2V5cywgZ2V0U291bmRLZXlzLCBldGMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldEtleXMKICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgLSBBbiBhcnJheSBvZiBpdGVtcyB0byByZXR1cm4gdGhlIGtleXMgZm9yLgogICAgKiBAcmV0dXJuIHtBcnJheX0gVGhlIGFycmF5IG9mIGl0ZW0ga2V5cy4KICAgICovCiAgICBnZXRLZXlzOiBmdW5jdGlvbiAoYXJyYXkpIHsKCiAgICAgICAgdmFyIG91dHB1dCA9IFtdOwoKICAgICAgICBmb3IgKHZhciBpdGVtIGluIGFycmF5KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGl0ZW0gIT09ICdfX2RlZmF1bHQnICYmIGl0ZW0gIT09ICdfX21pc3NpbmcnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvdXRwdXQucHVzaChpdGVtKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG91dHB1dDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGFuIGFycmF5IGNvbnRhaW5pbmcgYWxsIG9mIHRoZSBrZXlzIG9mIEltYWdlcyBpbiB0aGUgQ2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldEltYWdlS2V5cwogICAgKiBAcmV0dXJuIHtBcnJheX0gVGhlIHN0cmluZyBiYXNlZCBrZXlzIGluIHRoZSBDYWNoZS4KICAgICovCiAgICBnZXRJbWFnZUtleXM6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRLZXlzKHRoaXMuX2ltYWdlcyk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGFuIGFycmF5IGNvbnRhaW5pbmcgYWxsIG9mIHRoZSBrZXlzIG9mIFNvdW5kcyBpbiB0aGUgQ2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFNvdW5kS2V5cwogICAgKiBAcmV0dXJuIHtBcnJheX0gVGhlIHN0cmluZyBiYXNlZCBrZXlzIGluIHRoZSBDYWNoZS4KICAgICovCiAgICBnZXRTb3VuZEtleXM6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRLZXlzKHRoaXMuX3NvdW5kcyk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGFuIGFycmF5IGNvbnRhaW5pbmcgYWxsIG9mIHRoZSBrZXlzIG9mIFRleHQgRmlsZXMgaW4gdGhlIENhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRUZXh0S2V5cwogICAgKiBAcmV0dXJuIHtBcnJheX0gVGhlIHN0cmluZyBiYXNlZCBrZXlzIGluIHRoZSBDYWNoZS4KICAgICovCiAgICBnZXRUZXh0S2V5czogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldEtleXModGhpcy5fdGV4dCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGEgY2FudmFzIGZyb20gdGhlIGNhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNyZW1vdmVDYW52YXMKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEtleSBvZiB0aGUgYXNzZXQgeW91IHdhbnQgdG8gcmVtb3ZlLgogICAgKi8KICAgIHJlbW92ZUNhbnZhczogZnVuY3Rpb24gKGtleSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9jYW52YXNlc1trZXldOwogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlcyBhbiBpbWFnZSBmcm9tIHRoZSBjYWNoZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjcmVtb3ZlSW1hZ2UKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEtleSBvZiB0aGUgYXNzZXQgeW91IHdhbnQgdG8gcmVtb3ZlLgogICAgKi8KICAgIHJlbW92ZUltYWdlOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2ltYWdlc1trZXldOwogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlcyBhIHNvdW5kIGZyb20gdGhlIGNhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNyZW1vdmVTb3VuZAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gS2V5IG9mIHRoZSBhc3NldCB5b3Ugd2FudCB0byByZW1vdmUuCiAgICAqLwogICAgcmVtb3ZlU291bmQ6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBkZWxldGUgdGhpcy5fc291bmRzW2tleV07CiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGEgdGV4dCBmcm9tIHRoZSBjYWNoZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjcmVtb3ZlVGV4dAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gS2V5IG9mIHRoZSBhc3NldCB5b3Ugd2FudCB0byByZW1vdmUuCiAgICAqLwogICAgcmVtb3ZlVGV4dDogZnVuY3Rpb24gKGtleSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl90ZXh0W2tleV07CiAgICB9LAoKICAgIC8qKgogICAgKiBDbGVhcnMgdGhlIGNhY2hlLiBSZW1vdmVzIGV2ZXJ5IGxvY2FsIGNhY2hlIG9iamVjdCByZWZlcmVuY2UuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGZvciAodmFyIGl0ZW0gaW4gdGhpcy5fY2FudmFzZXMpCiAgICAgICAgewogICAgICAgICAgICBkZWxldGUgdGhpcy5fY2FudmFzZXNbaXRlbVsna2V5J11dOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaXRlbSBpbiB0aGlzLl9pbWFnZXMpCiAgICAgICAgewogICAgICAgICAgICBkZWxldGUgdGhpcy5faW1hZ2VzW2l0ZW1bJ2tleSddXTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGl0ZW0gaW4gdGhpcy5fc291bmRzKQogICAgICAgIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3NvdW5kc1tpdGVtWydrZXknXV07CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpdGVtIGluIHRoaXMuX3RleHQpCiAgICAgICAgewogICAgICAgICAgICBkZWxldGUgdGhpcy5fdGV4dFtpdGVtWydrZXknXV07CiAgICAgICAgfQogICAgfQoKfTsKClBoYXNlci5DYWNoZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuQ2FjaGU7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIgbG9hZGVyIGNvbnN0cnVjdG9yLgoqIFRoZSBMb2FkZXIgaGFuZGxlcyBsb2FkaW5nIGFsbCBleHRlcm5hbCBjb250ZW50IHN1Y2ggYXMgSW1hZ2VzLCBTb3VuZHMsIFRleHR1cmUgQXRsYXNlcyBhbmQgZGF0YSBmaWxlcy4KKiBJdCB1c2VzIGEgY29tYmluYXRpb24gb2YgSW1hZ2UoKSBsb2FkaW5nIGFuZCB4aHIgYW5kIHByb3ZpZGVzIHByb2dyZXNzIGFuZCBjb21wbGV0aW9uIGNhbGxiYWNrcy4KKiBAY2xhc3MgUGhhc2VyLkxvYWRlcgoqIEBjbGFzc2Rlc2MgIFRoZSBMb2FkZXIgaGFuZGxlcyBsb2FkaW5nIGFsbCBleHRlcm5hbCBjb250ZW50IHN1Y2ggYXMgSW1hZ2VzLCBTb3VuZHMsIFRleHR1cmUgQXRsYXNlcyBhbmQgZGF0YSBmaWxlcy4KKiBJdCB1c2VzIGEgY29tYmluYXRpb24gb2YgSW1hZ2UoKSBsb2FkaW5nIGFuZCB4aHIgYW5kIHByb3ZpZGVzIHByb2dyZXNzIGFuZCBjb21wbGV0aW9uIGNhbGxiYWNrcy4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5Mb2FkZXIgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gX2ZpbGVMaXN0IC0gQ29udGFpbnMgYWxsIHRoZSBhc3NldHMgZmlsZSBpbmZvcy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9maWxlTGlzdCA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2ZpbGVJbmRleCAtIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBmaWxlIGJlaW5nIGxvYWRlZC4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9maWxlSW5kZXggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3Byb2dyZXNzQ2h1bmsgLSBJbmRpY2F0ZXMgdGhlIHNpemUgb2YgMSBmaWxlIGluIHRlcm1zIG9mIGEgcGVyY2VudGFnZSBvdXQgb2YgMTAwLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3Byb2dyZXNzQ2h1bmsgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1hNTEh0dHBSZXF1ZXN0fSAtIEFuIFhNTEh0dHBSZXF1ZXN0IG9iamVjdCB1c2VkIGZvciBsb2FkaW5nIHRleHQgYW5kIGF1ZGlvIGRhdGEuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5feGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNMb2FkaW5nIC0gVHJ1ZSBpZiB0aGUgTG9hZGVyIGlzIGluIHRoZSBwcm9jZXNzIG9mIGxvYWRpbmcgdGhlIHF1ZXVlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGFzTG9hZGVkIC0gVHJ1ZSBpZiBhbGwgYXNzZXRzIGluIHRoZSBxdWV1ZSBoYXZlIGZpbmlzaGVkIGxvYWRpbmcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5oYXNMb2FkZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHByb2dyZXNzIC0gVGhlIHJvdW5kZWQgbG9hZCBwcm9ncmVzcyBwZXJjZW50YWdlIHZhbHVlIChmcm9tIDAgdG8gMTAwKQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucHJvZ3Jlc3MgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcHJvZ3Jlc3NGbG9hdCAtIFRoZSBub24tcm91bmRlZCBsb2FkIHByb2dyZXNzIHZhbHVlIChmcm9tIDAuMCB0byAxMDAuMCkKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnByb2dyZXNzRmxvYXQgPSAwOwoKICAgIC8qKgogICAgKiBZb3UgY2FuIG9wdGlvbmFsbHkgbGluayBhIHNwcml0ZSB0byB0aGUgcHJlbG9hZGVyLgogICAgKiBJZiB5b3UgZG8gc28gdGhlIFNwcml0ZSdzIHdpZHRoIG9yIGhlaWdodCB3aWxsIGJlIGNyb3BwZWQgYmFzZWQgb24gdGhlIHBlcmNlbnRhZ2UgbG9hZGVkLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TcHJpdGV9IHByZWxvYWRTcHJpdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnByZWxvYWRTcHJpdGUgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gY3Jvc3NPcmlnaW4gLSBUaGUgY3Jvc3NPcmlnaW4gdmFsdWUgYXBwbGllZCB0byBsb2FkZWQgaW1hZ2VzCiAgICAqLwogICAgdGhpcy5jcm9zc09yaWdpbiA9ICcnOwoKICAgIC8qKgogICAgKiBJZiB5b3Ugd2FudCB0byBhcHBlbmQgYSBVUkwgYmVmb3JlIHRoZSBwYXRoIG9mIGFueSBhc3NldCB5b3UgY2FuIHNldCB0aGlzIGhlcmUuCiAgICAqIFVzZWZ1bCBpZiB5b3UgbmVlZCB0byBhbGxvdyBhbiBhc3NldCB1cmwgdG8gYmUgY29uZmlndXJlZCBvdXRzaWRlIG9mIHRoZSBnYW1lIGNvZGUuCiAgICAqIE1VU1QgaGF2ZSAvIG9uIHRoZSBlbmQgb2YgaXQhCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBiYXNlVVJMCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5iYXNlVVJMID0gJyc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25GaWxlQ29tcGxldGUgLSBFdmVudCBzaWduYWwuCiAgICAqLwogICAgdGhpcy5vbkZpbGVDb21wbGV0ZSA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uRmlsZUVycm9yIC0gRXZlbnQgc2lnbmFsLgogICAgKi8KICAgIHRoaXMub25GaWxlRXJyb3IgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkxvYWRTdGFydCAtIEV2ZW50IHNpZ25hbC4KICAgICovCiAgICB0aGlzLm9uTG9hZFN0YXJ0ID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Mb2FkQ29tcGxldGUgLSBFdmVudCBzaWduYWwuCiAgICAqLwogICAgdGhpcy5vbkxvYWRDb21wbGV0ZSA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7Cgp9OwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX0pTT05fQVJSQVkgPSAwOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX0pTT05fSEFTSCA9IDE7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfWE1MX1NUQVJMSU5HID0gMjsKClBoYXNlci5Mb2FkZXIucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBZb3UgY2FuIHNldCBhIFNwcml0ZSB0byBiZSBhICJwcmVsb2FkIiBzcHJpdGUgYnkgcGFzc2luZyBpdCB0byB0aGlzIG1ldGhvZC4KICAgICogQSAicHJlbG9hZCIgc3ByaXRlIHdpbGwgaGF2ZSBpdHMgd2lkdGggb3IgaGVpZ2h0IGNyb3AgYWRqdXN0ZWQgYmFzZWQgb24gdGhlIHBlcmNlbnRhZ2Ugb2YgdGhlIGxvYWRlciBpbiByZWFsLXRpbWUuCiAgICAqIFRoaXMgYWxsb3dzIHlvdSB0byBlYXNpbHkgbWFrZSBsb2FkaW5nIGJhcnMgZm9yIGdhbWVzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjc2V0UHJlbG9hZFNwcml0ZQogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFRoZSBzcHJpdGUgdGhhdCB3aWxsIGJlIGNyb3BwZWQgZHVyaW5nIHRoZSBsb2FkLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2RpcmVjdGlvbj0wXSAtIEEgdmFsdWUgb2YgemVybyBtZWFucyB0aGUgc3ByaXRlIHdpZHRoIHdpbGwgYmUgY3JvcHBlZCwgYSB2YWx1ZSBvZiAxIG1lYW5zIGl0cyBoZWlnaHQgd2lsbCBiZSBjcm9wcGVkLgogICAgKi8KICAgIHNldFByZWxvYWRTcHJpdGU6IGZ1bmN0aW9uIChzcHJpdGUsIGRpcmVjdGlvbikgewoKICAgICAgICBkaXJlY3Rpb24gPSBkaXJlY3Rpb24gfHwgMDsKCiAgICAgICAgdGhpcy5wcmVsb2FkU3ByaXRlID0geyBzcHJpdGU6IHNwcml0ZSwgZGlyZWN0aW9uOiBkaXJlY3Rpb24sIHdpZHRoOiBzcHJpdGUud2lkdGgsIGhlaWdodDogc3ByaXRlLmhlaWdodCwgY3JvcDogbnVsbCB9OwoKICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIEhvcml6b250YWwgY3JvcAogICAgICAgICAgICB0aGlzLnByZWxvYWRTcHJpdGUuY3JvcCA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKDAsIDAsIDEsIHNwcml0ZS5oZWlnaHQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgVmVydGljYWwgY3JvcAogICAgICAgICAgICB0aGlzLnByZWxvYWRTcHJpdGUuY3JvcCA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKDAsIDAsIHNwcml0ZS53aWR0aCwgMSk7CiAgICAgICAgfQoKICAgICAgICBzcHJpdGUuY3JvcCA9IHRoaXMucHJlbG9hZFNwcml0ZS5jcm9wOwogICAgICAgIHNwcml0ZS5jcm9wRW5hYmxlZCA9IHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgd2hldGhlciBhc3NldCBleGlzdHMgd2l0aCBhIHNwZWNpZmljIGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2NoZWNrS2V5RXhpc3RzCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIC0gVGhlIHR5cGUgYXNzZXQgeW91IHdhbnQgdG8gY2hlY2suCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIGFzc2V0IHlvdSB3YW50IHRvIGNoZWNrLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBSZXR1cm4gdHJ1ZSBpZiBleGlzdHMsIG90aGVyd2lzZSByZXR1cm4gZmFsc2UuCiAgICAqLwogICAgY2hlY2tLZXlFeGlzdHM6IGZ1bmN0aW9uICh0eXBlLCBrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ZpbGVMaXN0Lmxlbmd0aCA+IDApCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2ZpbGVMaXN0Lmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fZmlsZUxpc3RbaV0udHlwZSA9PT0gdHlwZSAmJiB0aGlzLl9maWxlTGlzdFtpXS5rZXkgPT09IGtleSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogR2V0cyB0aGUgYXNzZXQgdGhhdCBpcyBxdWV1ZWQgZm9yIGxvYWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNnZXRBc3NldAogICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSAtIFRoZSB0eXBlIGFzc2V0IHlvdSB3YW50IHRvIGNoZWNrLgogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gS2V5IG9mIHRoZSBhc3NldCB5b3Ugd2FudCB0byBjaGVjay4KICAgICogQHJldHVybiB7YW55fSBSZXR1cm5zIGFuIG9iamVjdCBpZiBmb3VuZCB0aGF0IGhhcyAyIHByb3BlcnRpZXM6IGluZGV4IGFuZCBmaWxlLiBPdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgZ2V0QXNzZXQ6IGZ1bmN0aW9uICh0eXBlLCBrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ZpbGVMaXN0Lmxlbmd0aCA+IDApCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2ZpbGVMaXN0Lmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fZmlsZUxpc3RbaV0udHlwZSA9PT0gdHlwZSAmJiB0aGlzLl9maWxlTGlzdFtpXS5rZXkgPT09IGtleSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBpbmRleDogaSwgZmlsZTogdGhpcy5fZmlsZUxpc3RbaV0gfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogUmVzZXQgbG9hZGVyLCB0aGlzIHdpbGwgcmVtb3ZlIHRoZSBsb2FkIHF1ZXVlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjcmVzZXQKICAgICovCiAgICByZXNldDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnByZWxvYWRTcHJpdGUgPSBudWxsOwogICAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5fZmlsZUxpc3QubGVuZ3RoID0gMDsKICAgICAgICB0aGlzLl9maWxlSW5kZXggPSAwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIGZ1bmN0aW9uIHRoYXQgYWRkcyBhIG5ldyBlbnRyeSB0byB0aGUgZmlsZSBsaXN0LiBEbyBub3QgY2FsbCBkaXJlY3RseS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2FkZFRvRmlsZUxpc3QKICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgLSBUaGUgdHlwZSBvZiByZXNvdXJjZSB0byBhZGQgdG8gdGhlIGxpc3QgKGltYWdlLCBhdWRpbywgeG1sLCBldGMpLgogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHVuaXF1ZSBDYWNoZSBJRCBrZXkgb2YgdGhpcyByZXNvdXJjZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFRoZSBVUkwgdGhlIGFzc2V0IHdpbGwgYmUgbG9hZGVkIGZyb20uCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBwcm9wZXJ0aWVzIC0gQW55IGFkZGl0aW9uYWwgcHJvcGVydGllcyBuZWVkZWQgdG8gbG9hZCB0aGUgZmlsZS4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGFkZFRvRmlsZUxpc3Q6IGZ1bmN0aW9uICh0eXBlLCBrZXksIHVybCwgcHJvcGVydGllcykgewoKICAgICAgICB2YXIgZW50cnkgPSB7CiAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICAgICAgZXJyb3I6IGZhbHNlLAogICAgICAgICAgICBsb2FkZWQ6IGZhbHNlCiAgICAgICAgfTsKCiAgICAgICAgaWYgKHR5cGVvZiBwcm9wZXJ0aWVzICE9PSAidW5kZWZpbmVkIikKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gcHJvcGVydGllcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZW50cnlbcHJvcF0gPSBwcm9wZXJ0aWVzW3Byb3BdOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jaGVja0tleUV4aXN0cyh0eXBlLCBrZXkpID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ZpbGVMaXN0LnB1c2goZW50cnkpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBmdW5jdGlvbiB0aGF0IHJlcGxhY2VzIGFuIGV4aXN0aW5nIGVudHJ5IGluIHRoZSBmaWxlIGxpc3Qgd2l0aCBhIG5ldyBvbmUuIERvIG5vdCBjYWxsIGRpcmVjdGx5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjcmVwbGFjZUluRmlsZUxpc3QKICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgLSBUaGUgdHlwZSBvZiByZXNvdXJjZSB0byBhZGQgdG8gdGhlIGxpc3QgKGltYWdlLCBhdWRpbywgeG1sLCBldGMpLgogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHVuaXF1ZSBDYWNoZSBJRCBrZXkgb2YgdGhpcyByZXNvdXJjZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFRoZSBVUkwgdGhlIGFzc2V0IHdpbGwgYmUgbG9hZGVkIGZyb20uCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBwcm9wZXJ0aWVzIC0gQW55IGFkZGl0aW9uYWwgcHJvcGVydGllcyBuZWVkZWQgdG8gbG9hZCB0aGUgZmlsZS4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHJlcGxhY2VJbkZpbGVMaXN0OiBmdW5jdGlvbiAodHlwZSwga2V5LCB1cmwsIHByb3BlcnRpZXMpIHsKCiAgICAgICAgdmFyIGVudHJ5ID0gewogICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgICAgIGVycm9yOiBmYWxzZSwKICAgICAgICAgICAgbG9hZGVkOiBmYWxzZQogICAgICAgIH07CgogICAgICAgIGlmICh0eXBlb2YgcHJvcGVydGllcyAhPT0gInVuZGVmaW5lZCIpCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIHByb3BlcnRpZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVudHJ5W3Byb3BdID0gcHJvcGVydGllc1twcm9wXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY2hlY2tLZXlFeGlzdHModHlwZSwga2V5KSA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9maWxlTGlzdC5wdXNoKGVudHJ5KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGFuIGltYWdlIHRvIHRoZSBMb2FkZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNpbWFnZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGFzc2V0IGtleSBvZiB0aGlzIGltYWdlIGZpbGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgaW1hZ2UgZmlsZS4KICAgICogQHBhcmFtIHtib29sZWFufSBbb3ZlcndyaXRlPWZhbHNlXSAtIElmIGFuIHVubG9hZGVkIGZpbGUgd2l0aCBhIG1hdGNoaW5nIGtleSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgcXVldWUsIHRoaXMgZW50cnkgd2lsbCBvdmVyd3JpdGUgaXQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Mb2FkZXJ9IFRoaXMgTG9hZGVyIGluc3RhbmNlLgogICAgKi8KICAgIGltYWdlOiBmdW5jdGlvbiAoa2V5LCB1cmwsIG92ZXJ3cml0ZSkgewoKICAgICAgICBpZiAodHlwZW9mIG92ZXJ3cml0ZSA9PT0gInVuZGVmaW5lZCIpIHsgb3ZlcndyaXRlID0gZmFsc2U7IH0KCiAgICAgICAgaWYgKG92ZXJ3cml0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucmVwbGFjZUluRmlsZUxpc3QoJ2ltYWdlJywga2V5LCB1cmwpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFkZFRvRmlsZUxpc3QoJ2ltYWdlJywga2V5LCB1cmwpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgdGV4dCBmaWxlIHRvIHRoZSBMb2FkZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciN0ZXh0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSB0ZXh0IGZpbGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhlIHRleHQgZmlsZS4KICAgICogQHBhcmFtIHtib29sZWFufSBbb3ZlcndyaXRlPWZhbHNlXSAtIElmIGFuIHVubG9hZGVkIGZpbGUgd2l0aCBhIG1hdGNoaW5nIGtleSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgcXVldWUsIHRoaXMgZW50cnkgd2lsbCBvdmVyd3JpdGUgaXQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Mb2FkZXJ9IFRoaXMgTG9hZGVyIGluc3RhbmNlLgogICAgKi8KICAgIHRleHQ6IGZ1bmN0aW9uIChrZXksIHVybCwgb3ZlcndyaXRlKSB7CgogICAgICAgIGlmICh0eXBlb2Ygb3ZlcndyaXRlID09PSAidW5kZWZpbmVkIikgeyBvdmVyd3JpdGUgPSBmYWxzZTsgfQoKICAgICAgICBpZiAob3ZlcndyaXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZXBsYWNlSW5GaWxlTGlzdCgndGV4dCcsIGtleSwgdXJsKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hZGRUb0ZpbGVMaXN0KCd0ZXh0Jywga2V5LCB1cmwpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgSmF2YVNjcmlwdCBmaWxlIHRvIHRoZSBMb2FkZXIuIE9uY2UgbG9hZGVkIHRoZSBKYXZhU2NyaXB0IGZpbGUgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IHR1cm5lZCBpbnRvIGEgc2NyaXB0IHRhZyAoYW5kIGV4ZWN1dGVkKSwgc28gYmUgY2FyZWZ1bCB3aGF0IHlvdSBsb2FkIQogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjc2NyaXB0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSBzY3JpcHQgZmlsZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGUgSmF2YVNjcmlwdCBmaWxlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuTG9hZGVyfSBUaGlzIExvYWRlciBpbnN0YW5jZS4KICAgICovCiAgICBzY3JpcHQ6IGZ1bmN0aW9uIChrZXksIHVybCkgewoKICAgICAgICB0aGlzLmFkZFRvRmlsZUxpc3QoJ3NjcmlwdCcsIGtleSwgdXJsKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgYmluYXJ5IGZpbGUgdG8gdGhlIExvYWRlci4gSXQgd2lsbCBiZSBsb2FkZWQgdmlhIHhociB3aXRoIGEgcmVzcG9uc2VUeXBlIG9mICJhcnJheWJ1ZmZlciIuIFlvdSBjYW4gc3BlY2lmeSBhbiBvcHRpb25hbCBjYWxsYmFjayB0byBwcm9jZXNzIHRoZSBmaWxlIGFmdGVyIGxvYWQuCiAgICAqIFdoZW4gdGhlIGNhbGxiYWNrIGlzIGNhbGxlZCBpdCB3aWxsIGJlIHBhc3NlZCAyIHBhcmFtZXRlcnM6IHRoZSBrZXkgb2YgdGhlIGZpbGUgYW5kIHRoZSBmaWxlIGRhdGEuCiAgICAqIFdBUk5JTkc6IElmIHlvdSBzcGVjaWZ5IGEgY2FsbGJhY2ssIHRoZSBmaWxlIGRhdGEgd2lsbCBiZSBzZXQgdG8gd2hhdGV2ZXIgeW91ciBjYWxsYmFjayByZXR1cm5zLiBTbyBhbHdheXMgcmV0dXJuIHRoZSBkYXRhIG9iamVjdCwgZXZlbiBpZiB5b3UgZGlkbid0IG1vZGlmeSBpdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2JpbmFyeQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGFzc2V0IGtleSBvZiB0aGUgYmluYXJ5IGZpbGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhlIGJpbmFyeSBmaWxlLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbY2FsbGJhY2tdIC0gT3B0aW9uYWwgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIHBhc3NlZCB0aGUgZmlsZSBhZnRlciBsb2FkaW5nLCBzbyB5b3UgY2FuIHBlcmZvcm0gYWRkaXRpb25hbCBwcm9jZXNzaW5nIG9uIGl0LgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbY2FsbGJhY2tDb250ZXh0XSAtIFRoZSBjb250ZXh0IHVuZGVyIHdoaWNoIHRoZSBjYWxsYmFjayB3aWxsIGJlIGFwcGxpZWQuIElmIG5vdCBzcGVjaWZpZWQgaXQgd2lsbCB1c2UgdGhlIGNhbGxiYWNrIGl0c2VsZiBhcyB0aGUgY29udGV4dC4KICAgICogQHJldHVybiB7UGhhc2VyLkxvYWRlcn0gVGhpcyBMb2FkZXIgaW5zdGFuY2UuCiAgICAqLwogICAgYmluYXJ5OiBmdW5jdGlvbiAoa2V5LCB1cmwsIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ3VuZGVmaW5lZCcpIHsgY2FsbGJhY2sgPSBmYWxzZTsgfQogICAgICAgIGlmIChjYWxsYmFjayAhPT0gZmFsc2UgJiYgdHlwZW9mIGNhbGxiYWNrQ29udGV4dCA9PT0gJ3VuZGVmaW5lZCcpIHsgY2FsbGJhY2tDb250ZXh0ID0gY2FsbGJhY2s7IH0KCiAgICAgICAgdGhpcy5hZGRUb0ZpbGVMaXN0KCdiaW5hcnknLCBrZXksIHVybCwgeyBjYWxsYmFjazogY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dDogY2FsbGJhY2tDb250ZXh0IH0pOwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgc3ByaXRlIHNoZWV0IHRvIHRoZSBsb2FkZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNzcHJpdGVzaGVldAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGFzc2V0IGtleSBvZiB0aGUgc2hlZXQgZmlsZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGUgc2hlZXQgZmlsZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGZyYW1lV2lkdGggLSBXaWR0aCBvZiBlYWNoIHNpbmdsZSBmcmFtZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGZyYW1lSGVpZ2h0IC0gSGVpZ2h0IG9mIGVhY2ggc2luZ2xlIGZyYW1lLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2ZyYW1lTWF4PS0xXSAtIEhvdyBtYW55IGZyYW1lcyBpbiB0aGlzIHNwcml0ZSBzaGVldC4gSWYgbm90IHNwZWNpZmllZCBpdCB3aWxsIGRpdmlkZSB0aGUgd2hvbGUgaW1hZ2UgaW50byBmcmFtZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWFyZ2luPTBdIC0gSWYgdGhlIGZyYW1lcyBoYXZlIGJlZW4gZHJhd24gd2l0aCBhIG1hcmdpbiwgc3BlY2lmeSB0aGUgYW1vdW50IGhlcmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BhY2luZz0wXSAtIElmIHRoZSBmcmFtZXMgaGF2ZSBiZWVuIGRyYXduIHdpdGggc3BhY2luZyBiZXR3ZWVuIHRoZW0sIHNwZWNpZnkgdGhlIGFtb3VudCBoZXJlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuTG9hZGVyfSBUaGlzIExvYWRlciBpbnN0YW5jZS4KICAgICovCiAgICBzcHJpdGVzaGVldDogZnVuY3Rpb24gKGtleSwgdXJsLCBmcmFtZVdpZHRoLCBmcmFtZUhlaWdodCwgZnJhbWVNYXgsIG1hcmdpbiwgc3BhY2luZykgewoKICAgICAgICBpZiAodHlwZW9mIGZyYW1lTWF4ID09PSAidW5kZWZpbmVkIikgeyBmcmFtZU1heCA9IC0xOyB9CiAgICAgICAgaWYgKHR5cGVvZiBtYXJnaW4gPT09ICJ1bmRlZmluZWQiKSB7IG1hcmdpbiA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIHNwYWNpbmcgPT09ICJ1bmRlZmluZWQiKSB7IHNwYWNpbmcgPSAwOyB9CgogICAgICAgIHRoaXMuYWRkVG9GaWxlTGlzdCgnc3ByaXRlc2hlZXQnLCBrZXksIHVybCwgeyBmcmFtZVdpZHRoOiBmcmFtZVdpZHRoLCBmcmFtZUhlaWdodDogZnJhbWVIZWlnaHQsIGZyYW1lTWF4OiBmcmFtZU1heCwgbWFyZ2luOiBtYXJnaW4sIHNwYWNpbmc6IHNwYWNpbmcgfSk7CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBhdWRpbyBmaWxlIHRvIHRoZSBsb2FkZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNhdWRpbwogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGFzc2V0IGtleSBvZiB0aGUgYXVkaW8gZmlsZS4KICAgICogQHBhcmFtIHtBcnJheXxzdHJpbmd9IHVybHMgLSBBbiBhcnJheSBjb250YWluaW5nIHRoZSBVUkxzIG9mIHRoZSBhdWRpbyBmaWxlcywgaS5lLjogWyAnanVtcC5tcDMnLCAnanVtcC5vZ2cnLCAnanVtcC5tNGEnIF0gb3IgYSBzaW5nbGUgc3RyaW5nIGNvbnRhaW5pbmcganVzdCBvbmUgVVJMLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGF1dG9EZWNvZGUgLSBXaGVuIHVzaW5nIFdlYiBBdWRpbyB0aGUgYXVkaW8gZmlsZXMgY2FuIGVpdGhlciBiZSBkZWNvZGVkIGF0IGxvYWQgdGltZSBvciBydW4tdGltZS4gVGhleSBjYW4ndCBiZSBwbGF5ZWQgdW50aWwgdGhleSBhcmUgZGVjb2RlZCwgYnV0IHRoaXMgbGV0J3MgeW91IGNvbnRyb2wgd2hlbiB0aGF0IGhhcHBlbnMuIERlY29kaW5nIGlzIGEgbm9uLWJsb2NraW5nIGFzeW5jIHByb2Nlc3MuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Mb2FkZXJ9IFRoaXMgTG9hZGVyIGluc3RhbmNlLgogICAgKi8KICAgIGF1ZGlvOiBmdW5jdGlvbiAoa2V5LCB1cmxzLCBhdXRvRGVjb2RlKSB7CgogICAgICAgIGlmICh0eXBlb2YgYXV0b0RlY29kZSA9PT0gInVuZGVmaW5lZCIpIHsgYXV0b0RlY29kZSA9IHRydWU7IH0KCiAgICAgICAgdGhpcy5hZGRUb0ZpbGVMaXN0KCdhdWRpbycsIGtleSwgdXJscywgeyBidWZmZXI6IG51bGwsIGF1dG9EZWNvZGU6IGF1dG9EZWNvZGUgfSk7CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyB0aWxlbWFwIGxvYWRpbmcgcmVxdWVzdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3RpbGVtYXAKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIHRpbGVtYXAgZGF0YS4KICAgICogQHBhcmFtIHtzdHJpbmd9IFttYXBEYXRhVVJMXSAtIFRoZSB1cmwgb2YgdGhlIG1hcCBkYXRhIGZpbGUgKGNzdi9qc29uKQogICAgKiBAcGFyYW0ge29iamVjdH0gW21hcERhdGFdIC0gQW4gb3B0aW9uYWwgSlNPTiBkYXRhIG9iamVjdC4gSWYgZ2l2ZW4gdGhlbiB0aGUgbWFwRGF0YVVSTCBpcyBpZ25vcmVkIGFuZCB0aGlzIEpTT04gb2JqZWN0IGlzIHVzZWQgZm9yIG1hcCBkYXRhIGluc3RlYWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbZm9ybWF0PVBoYXNlci5UaWxlbWFwLkNTVl0gLSBUaGUgZm9ybWF0IG9mIHRoZSBtYXAgZGF0YS4gRWl0aGVyIFBoYXNlci5UaWxlbWFwLkNTViBvciBQaGFzZXIuVGlsZW1hcC5USUxFRF9KU09OLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuTG9hZGVyfSBUaGlzIExvYWRlciBpbnN0YW5jZS4KICAgICovCiAgICB0aWxlbWFwOiBmdW5jdGlvbiAoa2V5LCBtYXBEYXRhVVJMLCBtYXBEYXRhLCBmb3JtYXQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBtYXBEYXRhVVJMID09PSAidW5kZWZpbmVkIikgeyBtYXBEYXRhVVJMID0gbnVsbDsgfQogICAgICAgIGlmICh0eXBlb2YgbWFwRGF0YSA9PT0gInVuZGVmaW5lZCIpIHsgbWFwRGF0YSA9IG51bGw7IH0KICAgICAgICBpZiAodHlwZW9mIGZvcm1hdCA9PT0gInVuZGVmaW5lZCIpIHsgZm9ybWF0ID0gUGhhc2VyLlRpbGVtYXAuQ1NWOyB9CgogICAgICAgIGlmIChtYXBEYXRhVVJMID09IG51bGwgJiYgbWFwRGF0YSA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdQaGFzZXIuTG9hZGVyLnRpbGVtYXAgLSBCb3RoIG1hcERhdGFVUkwgYW5kIG1hcERhdGEgYXJlIG51bGwuIE9uZSBtdXN0IGJlIHNldC4nKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KCiAgICAgICAgLy8gIEEgbWFwIGRhdGEgb2JqZWN0IGhhcyBiZWVuIGdpdmVuCiAgICAgICAgaWYgKG1hcERhdGEpCiAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZvcm1hdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIEEgY3N2IHN0cmluZyBvciBvYmplY3QgaGFzIGJlZW4gZ2l2ZW4KICAgICAgICAgICAgICAgIGNhc2UgUGhhc2VyLlRpbGVtYXAuQ1NWOgogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIC8vICBBbiB4bWwgc3RyaW5nIG9yIG9iamVjdCBoYXMgYmVlbiBnaXZlbgogICAgICAgICAgICAgICAgY2FzZSBQaGFzZXIuVGlsZW1hcC5USUxFRF9KU09OOgoKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG1hcERhdGEgPT09ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWFwRGF0YSA9IEpTT04ucGFyc2UobWFwRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkVGlsZW1hcChrZXksIG51bGwsIG1hcERhdGEsIGZvcm1hdCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYWRkVG9GaWxlTGlzdCgndGlsZW1hcCcsIGtleSwgbWFwRGF0YVVSTCwgeyBmb3JtYXQ6IGZvcm1hdCB9KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBiaXRtYXAgZm9udCBsb2FkaW5nIHJlcXVlc3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNiaXRtYXBGb250CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSBiaXRtYXAgZm9udC4KICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHR1cmVVUkwgLSBUaGUgdXJsIG9mIHRoZSBmb250IGltYWdlIGZpbGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbeG1sVVJMXSAtIFRoZSB1cmwgb2YgdGhlIGZvbnQgZGF0YSBmaWxlICh4bWwvZm50KQogICAgKiBAcGFyYW0ge29iamVjdH0gW3htbERhdGFdIC0gQW4gb3B0aW9uYWwgWE1MIGRhdGEgb2JqZWN0LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuTG9hZGVyfSBUaGlzIExvYWRlciBpbnN0YW5jZS4KICAgICovCiAgICBiaXRtYXBGb250OiBmdW5jdGlvbiAoa2V5LCB0ZXh0dXJlVVJMLCB4bWxVUkwsIHhtbERhdGEpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB4bWxVUkwgPT09ICJ1bmRlZmluZWQiKSB7IHhtbFVSTCA9IG51bGw7IH0KICAgICAgICBpZiAodHlwZW9mIHhtbERhdGEgPT09ICJ1bmRlZmluZWQiKSB7IHhtbERhdGEgPSBudWxsOyB9CgogICAgICAgIC8vICBBIFVSTCB0byBhIGpzb24veG1sIGZpbGUgaGFzIGJlZW4gZ2l2ZW4KICAgICAgICBpZiAoeG1sVVJMKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hZGRUb0ZpbGVMaXN0KCdiaXRtYXBmb250Jywga2V5LCB0ZXh0dXJlVVJMLCB7IHhtbFVSTDogeG1sVVJMIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgQW4geG1sIHN0cmluZyBvciBvYmplY3QgaGFzIGJlZW4gZ2l2ZW4KICAgICAgICAgICAgaWYgKHR5cGVvZiB4bWxEYXRhID09PSAnc3RyaW5nJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHhtbDsKCiAgICAgICAgICAgICAgICB0cnkgIHsKICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93WydET01QYXJzZXInXSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkb21wYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHhtbCA9IGRvbXBhcnNlci5wYXJzZUZyb21TdHJpbmcoeG1sRGF0YSwgInRleHQveG1sIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHhtbCA9IG5ldyBBY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MRE9NIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHhtbC5hc3luYyA9ICdmYWxzZSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHhtbC5sb2FkWE1MKHhtbERhdGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGNoIChlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHhtbCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIXhtbCB8fCAheG1sLmRvY3VtZW50RWxlbWVudCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInBhcnNlcmVycm9yIikubGVuZ3RoKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUGhhc2VyLkxvYWRlci4gSW52YWxpZCBCaXRtYXAgRm9udCBYTUwgZ2l2ZW4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZFRvRmlsZUxpc3QoJ2JpdG1hcGZvbnQnLCBrZXksIHRleHR1cmVVUkwsIHsgeG1sVVJMOiBudWxsLCB4bWxEYXRhOiB4bWwgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyB0ZXh0dXJlIGF0bGFzIHRvIHRoZSBsb2FkZXIuIFRoaXMgYXRsYXMgdXNlcyB0aGUgSlNPTiBBcnJheSBkYXRhIGZvcm1hdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2F0bGFzSlNPTkFycmF5CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSB0ZXh0dXJlIGF0bGFzIGZpbGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0dXJlVVJMIC0gVGhlIHVybCBvZiB0aGUgdGV4dHVyZSBhdGxhcyBpbWFnZSBmaWxlLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2F0bGFzVVJMXSAtIFRoZSB1cmwgb2YgdGhlIHRleHR1cmUgYXRsYXMgZGF0YSBmaWxlIChqc29uL3htbCkuIFlvdSBkb24ndCBuZWVkIHRoaXMgaWYgeW91IGFyZSBwYXNzaW5nIGFuIGF0bGFzRGF0YSBvYmplY3QgaW5zdGVhZC4KICAgICogQHBhcmFtIHtvYmplY3R9IFthdGxhc0RhdGFdIC0gQSBKU09OIG9yIFhNTCBkYXRhIG9iamVjdC4gWW91IGRvbid0IG5lZWQgdGhpcyBpZiB0aGUgZGF0YSBpcyBiZWluZyBsb2FkZWQgZnJvbSBhIFVSTC4KICAgICogQHJldHVybiB7UGhhc2VyLkxvYWRlcn0gVGhpcyBMb2FkZXIgaW5zdGFuY2UuCiAgICAqLwogICAgYXRsYXNKU09OQXJyYXk6IGZ1bmN0aW9uIChrZXksIHRleHR1cmVVUkwsIGF0bGFzVVJMLCBhdGxhc0RhdGEpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuYXRsYXMoa2V5LCB0ZXh0dXJlVVJMLCBhdGxhc1VSTCwgYXRsYXNEYXRhLCBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9BUlJBWSk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IHRleHR1cmUgYXRsYXMgdG8gdGhlIGxvYWRlci4gVGhpcyBhdGxhcyB1c2VzIHRoZSBKU09OIEhhc2ggZGF0YSBmb3JtYXQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNhdGxhc0pTT05IYXNoCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSB0ZXh0dXJlIGF0bGFzIGZpbGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0dXJlVVJMIC0gVGhlIHVybCBvZiB0aGUgdGV4dHVyZSBhdGxhcyBpbWFnZSBmaWxlLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2F0bGFzVVJMXSAtIFRoZSB1cmwgb2YgdGhlIHRleHR1cmUgYXRsYXMgZGF0YSBmaWxlIChqc29uL3htbCkuIFlvdSBkb24ndCBuZWVkIHRoaXMgaWYgeW91IGFyZSBwYXNzaW5nIGFuIGF0bGFzRGF0YSBvYmplY3QgaW5zdGVhZC4KICAgICogQHBhcmFtIHtvYmplY3R9IFthdGxhc0RhdGFdIC0gQSBKU09OIG9yIFhNTCBkYXRhIG9iamVjdC4gWW91IGRvbid0IG5lZWQgdGhpcyBpZiB0aGUgZGF0YSBpcyBiZWluZyBsb2FkZWQgZnJvbSBhIFVSTC4KICAgICogQHJldHVybiB7UGhhc2VyLkxvYWRlcn0gVGhpcyBMb2FkZXIgaW5zdGFuY2UuCiAgICAqLwogICAgYXRsYXNKU09OSGFzaDogZnVuY3Rpb24gKGtleSwgdGV4dHVyZVVSTCwgYXRsYXNVUkwsIGF0bGFzRGF0YSkgewoKICAgICAgICByZXR1cm4gdGhpcy5hdGxhcyhrZXksIHRleHR1cmVVUkwsIGF0bGFzVVJMLCBhdGxhc0RhdGEsIFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0hBU0gpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyB0ZXh0dXJlIGF0bGFzIHRvIHRoZSBsb2FkZXIuIFRoaXMgYXRsYXMgdXNlcyB0aGUgU3RhcmxpbmcgWE1MIGRhdGEgZm9ybWF0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjYXRsYXNYTUwKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIHRleHR1cmUgYXRsYXMgZmlsZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHR1cmVVUkwgLSBUaGUgdXJsIG9mIHRoZSB0ZXh0dXJlIGF0bGFzIGltYWdlIGZpbGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbYXRsYXNVUkxdIC0gVGhlIHVybCBvZiB0aGUgdGV4dHVyZSBhdGxhcyBkYXRhIGZpbGUgKGpzb24veG1sKS4gWW91IGRvbid0IG5lZWQgdGhpcyBpZiB5b3UgYXJlIHBhc3NpbmcgYW4gYXRsYXNEYXRhIG9iamVjdCBpbnN0ZWFkLgogICAgKiBAcGFyYW0ge29iamVjdH0gW2F0bGFzRGF0YV0gLSBBIEpTT04gb3IgWE1MIGRhdGEgb2JqZWN0LiBZb3UgZG9uJ3QgbmVlZCB0aGlzIGlmIHRoZSBkYXRhIGlzIGJlaW5nIGxvYWRlZCBmcm9tIGEgVVJMLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuTG9hZGVyfSBUaGlzIExvYWRlciBpbnN0YW5jZS4KICAgICovCiAgICBhdGxhc1hNTDogZnVuY3Rpb24gKGtleSwgdGV4dHVyZVVSTCwgYXRsYXNVUkwsIGF0bGFzRGF0YSkgewoKICAgICAgICByZXR1cm4gdGhpcy5hdGxhcyhrZXksIHRleHR1cmVVUkwsIGF0bGFzVVJMLCBhdGxhc0RhdGEsIFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19YTUxfU1RBUkxJTkcpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyB0ZXh0dXJlIGF0bGFzIHRvIHRoZSBsb2FkZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNhdGxhcwogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGFzc2V0IGtleSBvZiB0aGUgdGV4dHVyZSBhdGxhcyBmaWxlLgogICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dHVyZVVSTCAtIFRoZSB1cmwgb2YgdGhlIHRleHR1cmUgYXRsYXMgaW1hZ2UgZmlsZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IFthdGxhc1VSTF0gLSBUaGUgdXJsIG9mIHRoZSB0ZXh0dXJlIGF0bGFzIGRhdGEgZmlsZSAoanNvbi94bWwpLiBZb3UgZG9uJ3QgbmVlZCB0aGlzIGlmIHlvdSBhcmUgcGFzc2luZyBhbiBhdGxhc0RhdGEgb2JqZWN0IGluc3RlYWQuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBbYXRsYXNEYXRhXSAtIEEgSlNPTiBvciBYTUwgZGF0YSBvYmplY3QuIFlvdSBkb24ndCBuZWVkIHRoaXMgaWYgdGhlIGRhdGEgaXMgYmVpbmcgbG9hZGVkIGZyb20gYSBVUkwuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZm9ybWF0XSAtIEEgdmFsdWUgZGVzY3JpYmluZyB0aGUgZm9ybWF0IG9mIHRoZSBkYXRhLCB0aGUgZGVmYXVsdCBpcyBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9BUlJBWS4KICAgICogQHJldHVybiB7UGhhc2VyLkxvYWRlcn0gVGhpcyBMb2FkZXIgaW5zdGFuY2UuCiAgICAqLwogICAgYXRsYXM6IGZ1bmN0aW9uIChrZXksIHRleHR1cmVVUkwsIGF0bGFzVVJMLCBhdGxhc0RhdGEsIGZvcm1hdCkgewoKICAgICAgICBpZiAodHlwZW9mIGF0bGFzVVJMID09PSAidW5kZWZpbmVkIikgeyBhdGxhc1VSTCA9IG51bGw7IH0KICAgICAgICBpZiAodHlwZW9mIGF0bGFzRGF0YSA9PT0gInVuZGVmaW5lZCIpIHsgYXRsYXNEYXRhID0gbnVsbDsgfQogICAgICAgIGlmICh0eXBlb2YgZm9ybWF0ID09PSAidW5kZWZpbmVkIikgeyBmb3JtYXQgPSBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9BUlJBWTsgfQoKICAgICAgICAvLyAgQSBVUkwgdG8gYSBqc29uL3htbCBmaWxlIGhhcyBiZWVuIGdpdmVuCiAgICAgICAgaWYgKGF0bGFzVVJMKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hZGRUb0ZpbGVMaXN0KCd0ZXh0dXJlYXRsYXMnLCBrZXksIHRleHR1cmVVUkwsIHsgYXRsYXNVUkw6IGF0bGFzVVJMLCBmb3JtYXQ6IGZvcm1hdCB9KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChmb3JtYXQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBBIGpzb24gc3RyaW5nIG9yIG9iamVjdCBoYXMgYmVlbiBnaXZlbgogICAgICAgICAgICAgICAgY2FzZSBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9BUlJBWToKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhdGxhc0RhdGEgPT09ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXRsYXNEYXRhID0gSlNPTi5wYXJzZShhdGxhc0RhdGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAvLyAgQW4geG1sIHN0cmluZyBvciBvYmplY3QgaGFzIGJlZW4gZ2l2ZW4KICAgICAgICAgICAgICAgIGNhc2UgUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX1hNTF9TVEFSTElORzoKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhdGxhc0RhdGEgPT09ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHhtbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvd1snRE9NUGFyc2VyJ10pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRvbXBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4bWwgPSBkb21wYXJzZXIucGFyc2VGcm9tU3RyaW5nKGF0bGFzRGF0YSwgInRleHQveG1sIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeG1sID0gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxET00iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4bWwuYXN5bmMgPSAnZmFsc2UnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhtbC5sb2FkWE1MKGF0bGFzRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhtbCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF4bWwgfHwgIXhtbC5kb2N1bWVudEVsZW1lbnQgfHwgeG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJwYXJzZXJlcnJvciIpLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQaGFzZXIuTG9hZGVyLiBJbnZhbGlkIFRleHR1cmUgQXRsYXMgWE1MIGdpdmVuIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdGxhc0RhdGEgPSB4bWw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuYWRkVG9GaWxlTGlzdCgndGV4dHVyZWF0bGFzJywga2V5LCB0ZXh0dXJlVVJMLCB7IGF0bGFzVVJMOiBudWxsLCBhdGxhc0RhdGE6IGF0bGFzRGF0YSwgZm9ybWF0OiBmb3JtYXQgfSk7CgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlIGxvYWRpbmcgcmVxdWVzdCBvZiBhIGZpbGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNyZW1vdmVGaWxlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIC0gVGhlIHR5cGUgb2YgcmVzb3VyY2UgdG8gYWRkIHRvIHRoZSBsaXN0IChpbWFnZSwgYXVkaW8sIHhtbCwgZXRjKS4KICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEtleSBvZiB0aGUgZmlsZSB5b3Ugd2FudCB0byByZW1vdmUuCiAgICAqLwogICAgcmVtb3ZlRmlsZTogZnVuY3Rpb24gKHR5cGUsIGtleSkgewoKICAgICAgICB2YXIgZmlsZSA9IHRoaXMuZ2V0QXNzZXQodHlwZSwga2V5KTsKCiAgICAgICAgaWYgKGZpbGUgIT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZmlsZUxpc3Quc3BsaWNlKGZpbGUuaW5kZXgsIDEpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmUgYWxsIGZpbGUgbG9hZGluZyByZXF1ZXN0cy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3JlbW92ZUFsbAogICAgKi8KICAgIHJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9maWxlTGlzdC5sZW5ndGggPSAwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0YXJ0IGxvYWRpbmcgdGhlIGFzc2V0cy4gTm9ybWFsbHkgeW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHlvdXJzZWxmIGFzIHRoZSBTdGF0ZU1hbmFnZXIgd2lsbCBkbyBzby4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3N0YXJ0CiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuaXNMb2FkaW5nKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5wcm9ncmVzcyA9IDA7CiAgICAgICAgdGhpcy5wcm9ncmVzc0Zsb2F0ID0gMDsKICAgICAgICB0aGlzLmhhc0xvYWRlZCA9IGZhbHNlOwogICAgICAgIHRoaXMuaXNMb2FkaW5nID0gdHJ1ZTsKCiAgICAgICAgdGhpcy5vbkxvYWRTdGFydC5kaXNwYXRjaCh0aGlzLl9maWxlTGlzdC5sZW5ndGgpOwoKICAgICAgICBpZiAodGhpcy5fZmlsZUxpc3QubGVuZ3RoID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ZpbGVJbmRleCA9IDA7CiAgICAgICAgICAgIHRoaXMuX3Byb2dyZXNzQ2h1bmsgPSAxMDAgLyB0aGlzLl9maWxlTGlzdC5sZW5ndGg7CiAgICAgICAgICAgIHRoaXMubG9hZEZpbGUoKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5wcm9ncmVzcyA9IDEwMDsKICAgICAgICAgICAgdGhpcy5wcm9ncmVzc0Zsb2F0ID0gMTAwOwogICAgICAgICAgICB0aGlzLmhhc0xvYWRlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMub25Mb2FkQ29tcGxldGUuZGlzcGF0Y2goKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogTG9hZCBmaWxlcy4gUHJpdmF0ZSBtZXRob2QgT05MWSB1c2VkIGJ5IGxvYWRlci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2xvYWRGaWxlCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgbG9hZEZpbGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKCF0aGlzLl9maWxlTGlzdFt0aGlzLl9maWxlSW5kZXhdKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdQaGFzZXIuTG9hZGVyIGxvYWRGaWxlIGludmFsaWQgaW5kZXggJyArIHRoaXMuX2ZpbGVJbmRleCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBmaWxlID0gdGhpcy5fZmlsZUxpc3RbdGhpcy5fZmlsZUluZGV4XTsKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAvLyAgSW1hZ2Ugb3IgRGF0YT8KICAgICAgICBzd2l0Y2ggKGZpbGUudHlwZSkKICAgICAgICB7CiAgICAgICAgICAgIGNhc2UgJ2ltYWdlJzoKICAgICAgICAgICAgY2FzZSAnc3ByaXRlc2hlZXQnOgogICAgICAgICAgICBjYXNlICd0ZXh0dXJlYXRsYXMnOgogICAgICAgICAgICBjYXNlICdiaXRtYXBmb250JzoKICAgICAgICAgICAgICAgIGZpbGUuZGF0YSA9IG5ldyBJbWFnZSgpOwogICAgICAgICAgICAgICAgZmlsZS5kYXRhLm5hbWUgPSBmaWxlLmtleTsKICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmZpbGVDb21wbGV0ZShfdGhpcy5fZmlsZUluZGV4KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmaWxlLmRhdGEub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZmlsZUVycm9yKF90aGlzLl9maWxlSW5kZXgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5jcm9zc09yaWdpbiA9IHRoaXMuY3Jvc3NPcmlnaW47CiAgICAgICAgICAgICAgICBmaWxlLmRhdGEuc3JjID0gdGhpcy5iYXNlVVJMICsgZmlsZS51cmw7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ2F1ZGlvJzoKICAgICAgICAgICAgICAgIGZpbGUudXJsID0gdGhpcy5nZXRBdWRpb1VSTChmaWxlLnVybCk7CgogICAgICAgICAgICAgICAgaWYgKGZpbGUudXJsICE9PSBudWxsKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICBXZWJBdWRpbyBvciBBdWRpbyBUYWc/CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zb3VuZC51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLm9wZW4oIkdFVCIsIHRoaXMuYmFzZVVSTCArIGZpbGUudXJsLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLnJlc3BvbnNlVHlwZSA9ICJhcnJheWJ1ZmZlciI7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3hoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZmlsZUNvbXBsZXRlKF90aGlzLl9maWxlSW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl94aHIub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5maWxlRXJyb3IoX3RoaXMuX2ZpbGVJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3hoci5zZW5kKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZ2FtZS5zb3VuZC51c2luZ0F1ZGlvVGFnKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zb3VuZC50b3VjaExvY2tlZCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gIElmIGF1ZGlvIGlzIGxvY2tlZCB3ZSBjYW4ndCBkbyB0aGlzIHlldCwgc28gbmVlZCB0byBxdWV1ZSB0aGlzIGxvYWQgcmVxdWVzdC4gQnVtLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZS5kYXRhID0gbmV3IEF1ZGlvKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLmRhdGEubmFtZSA9IGZpbGUua2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZS5kYXRhLnByZWxvYWQgPSAnYXV0byc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLmRhdGEuc3JjID0gdGhpcy5iYXNlVVJMICsgZmlsZS51cmw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbGVDb21wbGV0ZSh0aGlzLl9maWxlSW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZS5kYXRhID0gbmV3IEF1ZGlvKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLmRhdGEubmFtZSA9IGZpbGUua2V5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZS5kYXRhLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmZpbGVFcnJvcihfdGhpcy5fZmlsZUluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLmRhdGEucHJlbG9hZCA9ICdhdXRvJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5zcmMgPSB0aGlzLmJhc2VVUkwgKyBmaWxlLnVybDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5hZGRFdmVudExpc3RlbmVyKCdjYW5wbGF5dGhyb3VnaCcsIFBoYXNlci5HQU1FU1t0aGlzLmdhbWUuaWRdLmxvYWQuZmlsZUNvbXBsZXRlKHRoaXMuX2ZpbGVJbmRleCksIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5sb2FkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWxlRXJyb3IodGhpcy5fZmlsZUluZGV4KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ3RpbGVtYXAnOgogICAgICAgICAgICAgICAgdGhpcy5feGhyLm9wZW4oIkdFVCIsIHRoaXMuYmFzZVVSTCArIGZpbGUudXJsLCB0cnVlKTsKICAgICAgICAgICAgICAgIHRoaXMuX3hoci5yZXNwb25zZVR5cGUgPSAidGV4dCI7CgogICAgICAgICAgICAgICAgaWYgKGZpbGUuZm9ybWF0ID09PSBQaGFzZXIuVGlsZW1hcC5USUxFRF9KU09OKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3hoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5qc29uTG9hZENvbXBsZXRlKF90aGlzLl9maWxlSW5kZXgpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChmaWxlLmZvcm1hdCA9PT0gUGhhc2VyLlRpbGVtYXAuQ1NWKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3hoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5jc3ZMb2FkQ29tcGxldGUoX3RoaXMuX2ZpbGVJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBoYXNlci5Mb2FkZXIuIEludmFsaWQgVGlsZW1hcCBmb3JtYXQ6ICIgKyBmaWxlLmZvcm1hdCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5feGhyLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmRhdGFMb2FkRXJyb3IoX3RoaXMuX2ZpbGVJbmRleCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdGhpcy5feGhyLnNlbmQoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAndGV4dCc6CiAgICAgICAgICAgIGNhc2UgJ3NjcmlwdCc6CiAgICAgICAgICAgICAgICB0aGlzLl94aHIub3BlbigiR0VUIiwgdGhpcy5iYXNlVVJMICsgZmlsZS51cmwsIHRydWUpOwogICAgICAgICAgICAgICAgdGhpcy5feGhyLnJlc3BvbnNlVHlwZSA9ICJ0ZXh0IjsKICAgICAgICAgICAgICAgIHRoaXMuX3hoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmZpbGVDb21wbGV0ZShfdGhpcy5fZmlsZUluZGV4KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLl94aHIub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZmlsZUVycm9yKF90aGlzLl9maWxlSW5kZXgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHRoaXMuX3hoci5zZW5kKCk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICAgICAgICB0aGlzLl94aHIub3BlbigiR0VUIiwgdGhpcy5iYXNlVVJMICsgZmlsZS51cmwsIHRydWUpOwogICAgICAgICAgICAgICAgdGhpcy5feGhyLnJlc3BvbnNlVHlwZSA9ICJhcnJheWJ1ZmZlciI7CiAgICAgICAgICAgICAgICB0aGlzLl94aHIub25sb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5maWxlQ29tcGxldGUoX3RoaXMuX2ZpbGVJbmRleCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdGhpcy5feGhyLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmZpbGVFcnJvcihfdGhpcy5fZmlsZUluZGV4KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLl94aHIuc2VuZCgpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFByaXZhdGUgbWV0aG9kIE9OTFkgdXNlZCBieSBsb2FkZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNnZXRBdWRpb1VSTAogICAgKiBAcGFyYW0ge2FycmF5fHN0cmluZ30gdXJscyAtIEVpdGhlciBhbiBhcnJheSBvZiBhdWRpbyBmaWxlIFVSTHMgb3IgYSBzdHJpbmcgY29udGFpbmluZyBhIHNpbmdsZSBVUkwgcGF0aC4KICAgICogQHByaXZhdGUKICAgICovCiAgICBnZXRBdWRpb1VSTDogZnVuY3Rpb24gKHVybHMpIHsKCiAgICAgICAgdmFyIGV4dGVuc2lvbjsKCiAgICAgICAgaWYgKHR5cGVvZiB1cmxzID09PSAnc3RyaW5nJykgeyB1cmxzID0gW3VybHNdOyB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdXJscy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGV4dGVuc2lvbiA9IHVybHNbaV0udG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgZXh0ZW5zaW9uID0gZXh0ZW5zaW9uLnN1YnN0cigoTWF0aC5tYXgoMCwgZXh0ZW5zaW9uLmxhc3RJbmRleE9mKCIuIikpIHx8IEluZmluaXR5KSArIDEpOwoKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UuY2FuUGxheUF1ZGlvKGV4dGVuc2lvbikpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB1cmxzW2ldOwogICAgICAgICAgICB9CgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogRXJyb3Igb2NjdXJlZCB3aGVuIGxvYWRpbmcgYSBmaWxlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjZmlsZUVycm9yCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGUgZmlsZSBpbiB0aGUgZmlsZSBxdWV1ZSB0aGF0IGVycm9yZWQuCiAgICAqLwogICAgZmlsZUVycm9yOiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAgICAgdGhpcy5fZmlsZUxpc3RbaW5kZXhdLmxvYWRlZCA9IHRydWU7CiAgICAgICAgdGhpcy5fZmlsZUxpc3RbaW5kZXhdLmVycm9yID0gdHJ1ZTsKCiAgICAgICAgdGhpcy5vbkZpbGVFcnJvci5kaXNwYXRjaCh0aGlzLl9maWxlTGlzdFtpbmRleF0ua2V5LCB0aGlzLl9maWxlTGlzdFtpbmRleF0pOwoKICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5Mb2FkZXIgZXJyb3IgbG9hZGluZyBmaWxlOiAiICsgdGhpcy5fZmlsZUxpc3RbaW5kZXhdLmtleSArICcgZnJvbSBVUkwgJyArIHRoaXMuX2ZpbGVMaXN0W2luZGV4XS51cmwpOwoKICAgICAgICB0aGlzLm5leHRGaWxlKGluZGV4LCBmYWxzZSk7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIHdoZW4gYSBmaWxlIGlzIHN1Y2Nlc3NmdWxseSBsb2FkZWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNmaWxlQ29tcGxldGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoZSBmaWxlIGluIHRoZSBmaWxlIHF1ZXVlIHRoYXQgbG9hZGVkLgogICAgKi8KICAgIGZpbGVDb21wbGV0ZTogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgICAgIGlmICghdGhpcy5fZmlsZUxpc3RbaW5kZXhdKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdQaGFzZXIuTG9hZGVyIGZpbGVDb21wbGV0ZSBpbnZhbGlkIGluZGV4ICcgKyBpbmRleCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBmaWxlID0gdGhpcy5fZmlsZUxpc3RbaW5kZXhdOwogICAgICAgIGZpbGUubG9hZGVkID0gdHJ1ZTsKCiAgICAgICAgdmFyIGxvYWROZXh0ID0gdHJ1ZTsKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICBzd2l0Y2ggKGZpbGUudHlwZSkKICAgICAgICB7CiAgICAgICAgICAgIGNhc2UgJ2ltYWdlJzoKCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkSW1hZ2UoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICdzcHJpdGVzaGVldCc6CgogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLmFkZFNwcml0ZVNoZWV0KGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCBmaWxlLmZyYW1lV2lkdGgsIGZpbGUuZnJhbWVIZWlnaHQsIGZpbGUuZnJhbWVNYXgsIGZpbGUubWFyZ2luLCBmaWxlLnNwYWNpbmcpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICd0ZXh0dXJlYXRsYXMnOgoKICAgICAgICAgICAgICAgIGlmIChmaWxlLmF0bGFzVVJMID09IG51bGwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLmFkZFRleHR1cmVBdGxhcyhmaWxlLmtleSwgZmlsZS51cmwsIGZpbGUuZGF0YSwgZmlsZS5hdGxhc0RhdGEsIGZpbGUuZm9ybWF0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyAgTG9hZCB0aGUgSlNPTiBvciBYTUwgYmVmb3JlIGNhcnJ5aW5nIG9uIHdpdGggdGhlIG5leHQgZmlsZQogICAgICAgICAgICAgICAgICAgIGxvYWROZXh0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLm9wZW4oIkdFVCIsIHRoaXMuYmFzZVVSTCArIGZpbGUuYXRsYXNVUkwsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3hoci5yZXNwb25zZVR5cGUgPSAidGV4dCI7CgogICAgICAgICAgICAgICAgICAgIGlmIChmaWxlLmZvcm1hdCA9PSBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9BUlJBWSB8fCBmaWxlLmZvcm1hdCA9PSBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9IQVNIKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5qc29uTG9hZENvbXBsZXRlKGluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoZmlsZS5mb3JtYXQgPT0gUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX1hNTF9TVEFSTElORykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3hoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMueG1sTG9hZENvbXBsZXRlKGluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQaGFzZXIuTG9hZGVyLiBJbnZhbGlkIFRleHR1cmUgQXRsYXMgZm9ybWF0OiAiICsgZmlsZS5mb3JtYXQpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5kYXRhTG9hZEVycm9yKGluZGV4KTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3hoci5zZW5kKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ2JpdG1hcGZvbnQnOgoKICAgICAgICAgICAgICAgIGlmIChmaWxlLnhtbFVSTCA9PSBudWxsKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5hZGRCaXRtYXBGb250KGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCBmaWxlLnhtbERhdGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICBMb2FkIHRoZSBYTUwgYmVmb3JlIGNhcnJ5aW5nIG9uIHdpdGggdGhlIG5leHQgZmlsZQogICAgICAgICAgICAgICAgICAgIGxvYWROZXh0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLm9wZW4oIkdFVCIsIHRoaXMuYmFzZVVSTCArIGZpbGUueG1sVVJMLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl94aHIucmVzcG9uc2VUeXBlID0gInRleHQiOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLl94aHIub25sb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMueG1sTG9hZENvbXBsZXRlKGluZGV4KTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICB0aGlzLl94aHIub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmRhdGFMb2FkRXJyb3IoaW5kZXgpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLnNlbmQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnYXVkaW8nOgoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc291bmQudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmaWxlLmRhdGEgPSB0aGlzLl94aHIucmVzcG9uc2U7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5hZGRTb3VuZChmaWxlLmtleSwgZmlsZS51cmwsIGZpbGUuZGF0YSwgdHJ1ZSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZS5hdXRvRGVjb2RlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLnVwZGF0ZVNvdW5kKGtleSwgJ2lzRGVjb2RpbmcnLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IGZpbGUua2V5OwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNvdW5kLmNvbnRleHQuZGVjb2RlQXVkaW9EYXRhKGZpbGUuZGF0YSwgZnVuY3Rpb24gKGJ1ZmZlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1ZmZlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmdhbWUuY2FjaGUuZGVjb2RlZFNvdW5kKGtleSwgYnVmZmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmdhbWUuc291bmQub25Tb3VuZERlY29kZS5kaXNwYXRjaChrZXksIHRoYXQuZ2FtZS5jYWNoZS5nZXRTb3VuZChrZXkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5yZW1vdmVFdmVudExpc3RlbmVyKCdjYW5wbGF5dGhyb3VnaCcsIFBoYXNlci5HQU1FU1t0aGlzLmdhbWUuaWRdLmxvYWQuZmlsZUNvbXBsZXRlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkU291bmQoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEsIGZhbHNlLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAndGV4dCc6CiAgICAgICAgICAgICAgICBmaWxlLmRhdGEgPSB0aGlzLl94aHIucmVzcG9uc2VUZXh0OwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLmFkZFRleHQoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICdzY3JpcHQnOgogICAgICAgICAgICAgICAgZmlsZS5kYXRhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICAgICAgICAgICAgICBmaWxlLmRhdGEubGFuZ3VhZ2UgPSAnamF2YXNjcmlwdCc7CiAgICAgICAgICAgICAgICBmaWxlLmRhdGEudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnOwogICAgICAgICAgICAgICAgZmlsZS5kYXRhLmRlZmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICBmaWxlLmRhdGEudGV4dCA9IHRoaXMuX3hoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGZpbGUuZGF0YSk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICAgICAgICBpZiAoZmlsZS5jYWxsYmFjaykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmaWxlLmRhdGEgPSBmaWxlLmNhbGxiYWNrLmNhbGwoZmlsZS5jYWxsYmFja0NvbnRleHQsIGZpbGUua2V5LCB0aGlzLl94aHIucmVzcG9uc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGZpbGUuZGF0YSA9IHRoaXMuX3hoci5yZXNwb25zZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkQmluYXJ5KGZpbGUua2V5LCBmaWxlLmRhdGEpOwoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgaWYgKGxvYWROZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5uZXh0RmlsZShpbmRleCwgdHJ1ZSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFN1Y2Nlc3NmdWxseSBsb2FkZWQgYSBKU09OIGZpbGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNqc29uTG9hZENvbXBsZXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGUgZmlsZSBpbiB0aGUgZmlsZSBxdWV1ZSB0aGF0IGxvYWRlZC4KICAgICovCiAgICBqc29uTG9hZENvbXBsZXRlOiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAgICAgaWYgKCF0aGlzLl9maWxlTGlzdFtpbmRleF0pCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BoYXNlci5Mb2FkZXIganNvbkxvYWRDb21wbGV0ZSBpbnZhbGlkIGluZGV4ICcgKyBpbmRleCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBmaWxlID0gdGhpcy5fZmlsZUxpc3RbaW5kZXhdOwogICAgICAgIHZhciBkYXRhID0gSlNPTi5wYXJzZSh0aGlzLl94aHIucmVzcG9uc2VUZXh0KTsKCiAgICAgICAgZmlsZS5sb2FkZWQgPSB0cnVlOwoKICAgICAgICBpZiAoZmlsZS50eXBlID09PSAndGlsZW1hcCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkVGlsZW1hcChmaWxlLmtleSwgZmlsZS51cmwsIGRhdGEsIGZpbGUuZm9ybWF0KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLmFkZFRleHR1cmVBdGxhcyhmaWxlLmtleSwgZmlsZS51cmwsIGZpbGUuZGF0YSwgZGF0YSwgZmlsZS5mb3JtYXQpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5uZXh0RmlsZShpbmRleCwgdHJ1ZSk7CgogICAgfSwKCiAgICAvKioKICAgICogU3VjY2Vzc2Z1bGx5IGxvYWRlZCBhIENTViBmaWxlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjY3N2TG9hZENvbXBsZXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGUgZmlsZSBpbiB0aGUgZmlsZSBxdWV1ZSB0aGF0IGxvYWRlZC4KICAgICovCiAgICBjc3ZMb2FkQ29tcGxldGU6IGZ1bmN0aW9uIChpbmRleCkgewoKICAgICAgICBpZiAoIXRoaXMuX2ZpbGVMaXN0W2luZGV4XSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignUGhhc2VyLkxvYWRlciBjc3ZMb2FkQ29tcGxldGUgaW52YWxpZCBpbmRleCAnICsgaW5kZXgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgZmlsZSA9IHRoaXMuX2ZpbGVMaXN0W2luZGV4XTsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuX3hoci5yZXNwb25zZVRleHQ7CgogICAgICAgIGZpbGUubG9hZGVkID0gdHJ1ZTsKCiAgICAgICAgdGhpcy5nYW1lLmNhY2hlLmFkZFRpbGVtYXAoZmlsZS5rZXksIGZpbGUudXJsLCBkYXRhLCBmaWxlLmZvcm1hdCk7CgogICAgICAgIHRoaXMubmV4dEZpbGUoaW5kZXgsIHRydWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEVycm9yIG9jY3VyZWQgd2hlbiBsb2FkIGEgSlNPTi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2RhdGFMb2FkRXJyb3IKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoZSBmaWxlIGluIHRoZSBmaWxlIHF1ZXVlIHRoYXQgZXJyb3JlZC4KICAgICovCiAgICBkYXRhTG9hZEVycm9yOiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAgICAgdmFyIGZpbGUgPSB0aGlzLl9maWxlTGlzdFtpbmRleF07CgogICAgICAgIGZpbGUubG9hZGVkID0gdHJ1ZTsKICAgICAgICBmaWxlLmVycm9yID0gdHJ1ZTsKCiAgICAgICAgY29uc29sZS53YXJuKCJQaGFzZXIuTG9hZGVyIGRhdGFMb2FkRXJyb3I6ICIgKyBmaWxlLmtleSk7CgogICAgICAgIHRoaXMubmV4dEZpbGUoaW5kZXgsIHRydWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN1Y2Nlc3NmdWxseSBsb2FkZWQgYW4gWE1MIGZpbGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciN4bWxMb2FkQ29tcGxldGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoZSBmaWxlIGluIHRoZSBmaWxlIHF1ZXVlIHRoYXQgbG9hZGVkLgogICAgKi8KICAgIHhtbExvYWRDb21wbGV0ZTogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgICAgIHZhciBkYXRhID0gdGhpcy5feGhyLnJlc3BvbnNlVGV4dDsKICAgICAgICB2YXIgeG1sOwoKICAgICAgICB0cnkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aW5kb3dbJ0RPTVBhcnNlciddKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZG9tcGFyc2VyID0gbmV3IERPTVBhcnNlcigpOwogICAgICAgICAgICAgICAgeG1sID0gZG9tcGFyc2VyLnBhcnNlRnJvbVN0cmluZyhkYXRhLCAidGV4dC94bWwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHhtbCA9IG5ldyBBY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MRE9NIik7CiAgICAgICAgICAgICAgICB4bWwuYXN5bmMgPSAnZmFsc2UnOwogICAgICAgICAgICAgICAgeG1sLmxvYWRYTUwoZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGUpCiAgICAgICAgewogICAgICAgICAgICB4bWwgPSB1bmRlZmluZWQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXhtbCB8fCAheG1sLmRvY3VtZW50RWxlbWVudCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInBhcnNlcmVycm9yIikubGVuZ3RoKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQaGFzZXIuTG9hZGVyLiBJbnZhbGlkIFhNTCBnaXZlbiIpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGZpbGUgPSB0aGlzLl9maWxlTGlzdFtpbmRleF07CiAgICAgICAgZmlsZS5sb2FkZWQgPSB0cnVlOwoKICAgICAgICBpZiAoZmlsZS50eXBlID09ICdiaXRtYXBmb250JykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5hZGRCaXRtYXBGb250KGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCB4bWwpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChmaWxlLnR5cGUgPT0gJ3RleHR1cmVhdGxhcycpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkVGV4dHVyZUF0bGFzKGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCB4bWwsIGZpbGUuZm9ybWF0KTsKICAgICAgICB9CgogICAgICAgIHRoaXMubmV4dEZpbGUoaW5kZXgsIHRydWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEhhbmRsZSBsb2FkaW5nIG5leHQgZmlsZS4KICAgICoKICAgICogQHBhcmFtIHtudW1iZXJ9IHByZXZpb3VzSW5kZXggLSBJbmRleCBvZiB0aGUgcHJldmlvdXNseSBsb2FkZWQgYXNzZXQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gc3VjY2VzcyAtIFdoZXRoZXIgdGhlIHByZXZpb3VzIGFzc2V0IGxvYWRlZCBzdWNjZXNzZnVsbHkgb3Igbm90LgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIG5leHRGaWxlOiBmdW5jdGlvbiAocHJldmlvdXNJbmRleCwgc3VjY2VzcykgewoKICAgICAgICB0aGlzLnByb2dyZXNzRmxvYXQgKz0gdGhpcy5fcHJvZ3Jlc3NDaHVuazsKICAgICAgICB0aGlzLnByb2dyZXNzID0gTWF0aC5yb3VuZCh0aGlzLnByb2dyZXNzRmxvYXQpOwoKICAgICAgICBpZiAodGhpcy5wcm9ncmVzcyA+IDEwMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucHJvZ3Jlc3MgPSAxMDA7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wcmVsb2FkU3ByaXRlICE9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMucHJlbG9hZFNwcml0ZS5kaXJlY3Rpb24gPT09IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucHJlbG9hZFNwcml0ZS5jcm9wLndpZHRoID0gTWF0aC5mbG9vcigodGhpcy5wcmVsb2FkU3ByaXRlLndpZHRoIC8gMTAwKSAqIHRoaXMucHJvZ3Jlc3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wcmVsb2FkU3ByaXRlLmNyb3AuaGVpZ2h0ID0gTWF0aC5mbG9vcigodGhpcy5wcmVsb2FkU3ByaXRlLmhlaWdodCAvIDEwMCkgKiB0aGlzLnByb2dyZXNzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wcmVsb2FkU3ByaXRlLnNwcml0ZS5jcm9wID0gdGhpcy5wcmVsb2FkU3ByaXRlLmNyb3A7CiAgICAgICAgfQoKICAgICAgICB0aGlzLm9uRmlsZUNvbXBsZXRlLmRpc3BhdGNoKHRoaXMucHJvZ3Jlc3MsIHRoaXMuX2ZpbGVMaXN0W3ByZXZpb3VzSW5kZXhdLmtleSwgc3VjY2VzcywgdGhpcy50b3RhbExvYWRlZEZpbGVzKCksIHRoaXMuX2ZpbGVMaXN0Lmxlbmd0aCk7CgogICAgICAgIGlmICh0aGlzLnRvdGFsUXVldWVkRmlsZXMoKSA+IDApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9maWxlSW5kZXgrKzsKICAgICAgICAgICAgdGhpcy5sb2FkRmlsZSgpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmhhc0xvYWRlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnJlbW92ZUFsbCgpOwoKICAgICAgICAgICAgdGhpcy5vbkxvYWRDb21wbGV0ZS5kaXNwYXRjaCgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgZmlsZXMgdGhhdCBoYXZlIGFscmVhZHkgYmVlbiBsb2FkZWQsIGV2ZW4gaWYgdGhleSBlcnJvcmVkLgogICAgKgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBudW1iZXIgb2YgZmlsZXMgdGhhdCBoYXZlIGFscmVhZHkgYmVlbiBsb2FkZWQgKGV2ZW4gaWYgdGhleSBlcnJvcmVkKQogICAgKi8KICAgIHRvdGFsTG9hZGVkRmlsZXM6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIHRvdGFsID0gMDsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9maWxlTGlzdC5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9maWxlTGlzdFtpXS5sb2FkZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRvdGFsKys7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0b3RhbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgZmlsZXMgc3RpbGwgd2FpdGluZyB0byBiZSBwcm9jZXNzZWQgaW4gdGhlIGxvYWQgcXVldWUuIFRoaXMgdmFsdWUgZGVjcmVhc2VzIGFzIGVhY2ggZmlsZSBpcyBpbiB0aGUgcXVldWUgaXMgbG9hZGVkLgogICAgKgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBudW1iZXIgb2YgZmlsZXMgdGhhdCBzdGlsbCByZW1haW4gaW4gdGhlIGxvYWQgcXVldWUuCiAgICAqLwogICAgdG90YWxRdWV1ZWRGaWxlczogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgdG90YWwgPSAwOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2ZpbGVMaXN0Lmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2ZpbGVMaXN0W2ldLmxvYWRlZCA9PT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRvdGFsKys7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0b3RhbDsKCiAgICB9Cgp9OwoKUGhhc2VyLkxvYWRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuTG9hZGVyOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLkxvYWRlclBhcnNlciBwYXJzZXMgZGF0YSBvYmplY3RzIGZyb20gUGhhc2VyLkxvYWRlciB0aGF0IG5lZWQgbW9yZSBwcmVwYXJhdGlvbiBiZWZvcmUgdGhleSBjYW4gYmUgaW5zZXJ0ZWQgaW50byB0aGUgQ2FjaGUuCioKKiBAY2xhc3MgUGhhc2VyLkxvYWRlclBhcnNlcgoqLwpQaGFzZXIuTG9hZGVyUGFyc2VyID0gewogICAgCiAgICAvKioKICAgICogUGFyc2UgZnJhbWUgZGF0YSBmcm9tIGFuIFhNTCBmaWxlLgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXJQYXJzZXIuYml0bWFwRm9udAogICAgKiBAcGFyYW0ge29iamVjdH0geG1sIC0gWE1MIGRhdGEgeW91IHdhbnQgdG8gcGFyc2UuCiAgICAqIEByZXR1cm4ge0ZyYW1lRGF0YX0gR2VuZXJhdGVkIEZyYW1lRGF0YSBvYmplY3QuCiAgICAqLwogICAgYml0bWFwRm9udDogZnVuY3Rpb24gKGdhbWUsIHhtbCwgY2FjaGVLZXkpIHsKCiAgICAgICAgLy8gIE1hbGZvcm1lZD8KICAgICAgICBpZiAoIXhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZm9udCcpKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJQaGFzZXIuTG9hZGVyUGFyc2VyLmJpdG1hcEZvbnQ6IEludmFsaWQgWE1MIGdpdmVuLCBtaXNzaW5nIDxmb250PiB0YWciKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRleHR1cmUgPSBQSVhJLlRleHR1cmVDYWNoZVtjYWNoZUtleV07CgogICAgICAgIHZhciBkYXRhID0ge307CiAgICAgICAgdmFyIGluZm8gPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImluZm8iKVswXTsKICAgICAgICB2YXIgY29tbW9uID0geG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJjb21tb24iKVswXTsKICAgICAgICBkYXRhLmZvbnQgPSBpbmZvLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJmYWNlIikubm9kZVZhbHVlOwogICAgICAgIGRhdGEuc2l6ZSA9IHBhcnNlSW50KGluZm8uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oInNpemUiKS5ub2RlVmFsdWUsIDEwKTsKICAgICAgICBkYXRhLmxpbmVIZWlnaHQgPSBwYXJzZUludChjb21tb24uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oImxpbmVIZWlnaHQiKS5ub2RlVmFsdWUsIDEwKTsKICAgICAgICBkYXRhLmNoYXJzID0ge307CgogICAgICAgIC8vcGFyc2UgbGV0dGVycwogICAgICAgIHZhciBsZXR0ZXJzID0geG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJjaGFyIik7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGV0dGVycy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjaGFyQ29kZSA9IHBhcnNlSW50KGxldHRlcnNbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oImlkIikubm9kZVZhbHVlLCAxMCk7CgogICAgICAgICAgICB2YXIgdGV4dHVyZVJlY3QgPSB7CiAgICAgICAgICAgICAgICB4OiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJ4Iikubm9kZVZhbHVlLCAxMCksCiAgICAgICAgICAgICAgICB5OiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJ5Iikubm9kZVZhbHVlLCAxMCksCiAgICAgICAgICAgICAgICB3aWR0aDogcGFyc2VJbnQobGV0dGVyc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgid2lkdGgiKS5ub2RlVmFsdWUsIDEwKSwKICAgICAgICAgICAgICAgIGhlaWdodDogcGFyc2VJbnQobGV0dGVyc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgiaGVpZ2h0Iikubm9kZVZhbHVlLCAxMCkKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vICBOb3RlOiBUaGlzIG1lYW5zIHlvdSBjYW4gb25seSBoYXZlIDEgQml0bWFwRm9udCBsb2FkZWQgYXQgb25jZSEKICAgICAgICAgICAgLy8gIE5lZWQgdG8gcmVwbGFjZSB0aGlzIHdpdGggb3VyIG93biBoYW5kbGVyIHNvb24uCiAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW2NoYXJDb2RlXSA9IG5ldyBQSVhJLlRleHR1cmUodGV4dHVyZSwgdGV4dHVyZVJlY3QpOwoKICAgICAgICAgICAgZGF0YS5jaGFyc1tjaGFyQ29kZV0gPSB7CiAgICAgICAgICAgICAgICB4T2Zmc2V0OiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJ4b2Zmc2V0Iikubm9kZVZhbHVlLCAxMCksCiAgICAgICAgICAgICAgICB5T2Zmc2V0OiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJ5b2Zmc2V0Iikubm9kZVZhbHVlLCAxMCksCiAgICAgICAgICAgICAgICB4QWR2YW5jZTogcGFyc2VJbnQobGV0dGVyc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgieGFkdmFuY2UiKS5ub2RlVmFsdWUsIDEwKSwKICAgICAgICAgICAgICAgIGtlcm5pbmc6IHt9LAogICAgICAgICAgICAgICAgdGV4dHVyZTpuZXcgUElYSS5UZXh0dXJlKHRleHR1cmUsIHRleHR1cmVSZWN0KQoKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIC8vcGFyc2Uga2VybmluZ3MKICAgICAgICB2YXIga2VybmluZ3MgPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImtlcm5pbmciKTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGtlcm5pbmdzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGZpcnN0ID0gcGFyc2VJbnQoa2VybmluZ3NbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oImZpcnN0Iikubm9kZVZhbHVlLCAxMCk7CiAgICAgICAgICAgIHZhciBzZWNvbmQgPSBwYXJzZUludChrZXJuaW5nc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgic2Vjb25kIikubm9kZVZhbHVlLCAxMCk7CiAgICAgICAgICAgIHZhciBhbW91bnQgPSBwYXJzZUludChrZXJuaW5nc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgiYW1vdW50Iikubm9kZVZhbHVlLCAxMCk7CgogICAgICAgICAgICBkYXRhLmNoYXJzW3NlY29uZF0ua2VybmluZ1tmaXJzdF0gPSBhbW91bnQ7CiAgICAgICAgfQoKICAgICAgICBQSVhJLkJpdG1hcFRleHQuZm9udHNbZGF0YS5mb250XSA9IGRhdGE7CgogICAgfQoKfTsKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIFNvdW5kIGNsYXNzIGNvbnN0cnVjdG9yLgoqCiogQGNsYXNzIFBoYXNlci5Tb3VuZAoqIEBjbGFzc2Rlc2MgVGhlIFNvdW5kIGNsYXNzCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIFJlZmVyZW5jZSB0byB0aGUgY3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSBzb3VuZC4KKiBAcGFyYW0ge251bWJlcn0gW3ZvbHVtZT0xXSAtIERlZmF1bHQgdmFsdWUgZm9yIHRoZSB2b2x1bWUsIGJldHdlZW4gMCBhbmQgMS4KKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIFdoZXRoZXIgb3Igbm90IHRoZSBzb3VuZCB3aWxsIGxvb3AuCiovClBoYXNlci5Tb3VuZCA9IGZ1bmN0aW9uIChnYW1lLCBrZXksIHZvbHVtZSwgbG9vcCwgY29ubmVjdCkgewogICAgCiAgICBpZiAodHlwZW9mIHZvbHVtZSA9PSAndW5kZWZpbmVkJykgeyB2b2x1bWUgPSAxOyB9CiAgICBpZiAodHlwZW9mIGxvb3AgPT0gJ3VuZGVmaW5lZCcpIHsgbG9vcCA9IGZhbHNlOyB9CiAgICBpZiAodHlwZW9mIGNvbm5lY3QgPT09ICd1bmRlZmluZWQnKSB7IGNvbm5lY3QgPSBnYW1lLnNvdW5kLmNvbm5lY3RUb01hc3RlcjsgfQoKICAgIC8qKgogICAgKiBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZQogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gTmFtZSBvZiB0aGUgc291bmQuCiAgICAqLwogICAgdGhpcy5uYW1lID0ga2V5OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgc291bmQuCiAgICAqLwogICAgdGhpcy5rZXkgPSBrZXk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbG9vcCAtIFdoZXRoZXIgb3Igbm90IHRoZSBzb3VuZCB3aWxsIGxvb3AuCiAgICAqLwogICAgdGhpcy5sb29wID0gbG9vcDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF92b2x1bWUgLSBUaGUgZ2xvYmFsIGF1ZGlvIHZvbHVtZS4gQSB2YWx1ZSBiZXR3ZWVuIDAgKHNpbGVuY2UpIGFuZCAxIChmdWxsIHZvbHVtZSkuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdm9sdW1lID0gdm9sdW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gbWFya2VycyAtIFRoZSBzb3VuZCBtYXJrZXJzLgogICAgKi8KICAgIHRoaXMubWFya2VycyA9IHt9OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBdWRpb0NvbnRleHR9IGNvbnRleHQgLSBSZWZlcmVuY2UgdG8gdGhlIEF1ZGlvQ29udGV4dCBpbnN0YW5jZS4KICAgICovCiAgICB0aGlzLmNvbnRleHQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfYnVmZmVyIC0gRGVjb2RlZCBkYXRhIGJ1ZmZlciAvIEF1ZGlvIHRhZy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9idWZmZXIgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9tdXRlZCAtIEJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSBzb3VuZCBpcyBtdXRlZCBvciBub3QuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fbXV0ZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhdXRvcGxheSAtIEJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSBzb3VuZCBzaG91bGQgc3RhcnQgYXV0b21hdGljYWxseS4KICAgICovCiAgICB0aGlzLmF1dG9wbGF5ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3RhbER1cmF0aW9uIC0gVGhlIHRvdGFsIGR1cmF0aW9uIG9mIHRoZSBzb3VuZCwgaW4gbWlsbGlzZWNvbmRzCiAgICAqLwogICAgdGhpcy50b3RhbER1cmF0aW9uID0gMDsKICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHN0YXJ0VGltZSAtIFRoZSB0aW1lIHRoZSBTb3VuZCBzdGFydHMgYXQgKHR5cGljYWxseSAwIHVubGVzcyBzdGFydGluZyBmcm9tIGEgbWFya2VyKQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc3RhcnRUaW1lID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjdXJyZW50VGltZSAtIFRoZSBjdXJyZW50IHRpbWUgdGhlIHNvdW5kIGlzIGF0LgogICAgKi8KICAgIHRoaXMuY3VycmVudFRpbWUgPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGR1cmF0aW9uIC0gVGhlIGR1cmF0aW9uIG9mIHRoZSBzb3VuZC4KICAgICovCiAgICB0aGlzLmR1cmF0aW9uID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzdG9wVGltZSAtIFRoZSB0aW1lIHRoZSBzb3VuZCBzdG9wcGVkLgogICAgKi8KICAgIHRoaXMuc3RvcFRpbWUgPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBwYXVzZWQgLSB0cnVlIGlmIHRoZSBzb3VuZCBpcyBwYXVzZWQsIG90aGVyd2lzZSBmYWxzZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBhdXNlZFBvc2l0aW9uIC0gVGhlIHBvc2l0aW9uIHRoZSBzb3VuZCBoYWQgcmVhY2hlZCB3aGVuIGl0IHdhcyBwYXVzZWQuCiAgICAqLwogICAgdGhpcy5wYXVzZWRQb3NpdGlvbiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwYXVzZWRUaW1lIC0gVGhlIGdhbWUgdGltZSBhdCB3aGljaCB0aGUgc291bmQgd2FzIHBhdXNlZC4KICAgICovCiAgICB0aGlzLnBhdXNlZFRpbWUgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzUGxheWluZyAtIHRydWUgaWYgdGhlIHNvdW5kIGlzIGN1cnJlbnRseSBwbGF5aW5nLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjdXJyZW50TWFya2VyIC0gVGhlIHN0cmluZyBJRCBvZiB0aGUgY3VycmVudGx5IHBsYXlpbmcgbWFya2VyLCBpZiBhbnkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jdXJyZW50TWFya2VyID0gJyc7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHBlbmRpbmdQbGF5YmFjayAtIHRydWUgaWYgdGhlIHNvdW5kIGZpbGUgaXMgcGVuZGluZyBwbGF5YmFjawogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnBlbmRpbmdQbGF5YmFjayA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBvdmVycmlkZSAtIGlmIHRydWUgd2hlbiB5b3UgcGxheSB0aGlzIHNvdW5kIGl0IHdpbGwgYWx3YXlzIHN0YXJ0IGZyb20gdGhlIGJlZ2lubmluZy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm92ZXJyaWRlID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHVzaW5nV2ViQXVkaW8gLSB0cnVlIGlmIHRoaXMgc291bmQgaXMgYmVpbmcgcGxheWVkIHdpdGggV2ViIEF1ZGlvLgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnVzaW5nV2ViQXVkaW8gPSB0aGlzLmdhbWUuc291bmQudXNpbmdXZWJBdWRpbzsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdXNpbmdBdWRpb1RhZyAtIHRydWUgaWYgdGhlIHNvdW5kIGlzIGJlaW5nIHBsYXllZCB2aWEgdGhlIEF1ZGlvIHRhZy4KICAgICovCiAgICB0aGlzLnVzaW5nQXVkaW9UYWcgPSB0aGlzLmdhbWUuc291bmQudXNpbmdBdWRpb1RhZzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IGV4dGVybmFsTm9kZSAtIElmIGRlZmluZWQgdGhpcyBTb3VuZCB3b24ndCBjb25uZWN0IHRvIHRoZSBTb3VuZE1hbmFnZXIgbWFzdGVyIGdhaW4gbm9kZSwgYnV0IHdpbGwgaW5zdGVhZCBjb25uZWN0IHRvIGV4dGVybmFsTm9kZS5pbnB1dC4KICAgICovCiAgICB0aGlzLmV4dGVybmFsTm9kZSA9IG51bGw7CgogICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgIHsKICAgICAgICB0aGlzLmNvbnRleHQgPSB0aGlzLmdhbWUuc291bmQuY29udGV4dDsKICAgICAgICB0aGlzLm1hc3RlckdhaW5Ob2RlID0gdGhpcy5nYW1lLnNvdW5kLm1hc3RlckdhaW47CgogICAgICAgIGlmICh0eXBlb2YgdGhpcy5jb250ZXh0LmNyZWF0ZUdhaW4gPT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYWluTm9kZSA9IHRoaXMuY29udGV4dC5jcmVhdGVHYWluTm9kZSgpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhaW5Ob2RlID0gdGhpcy5jb250ZXh0LmNyZWF0ZUdhaW4oKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IHZvbHVtZSAqIHRoaXMuZ2FtZS5zb3VuZC52b2x1bWU7CgogICAgICAgIGlmIChjb25uZWN0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYWluTm9kZS5jb25uZWN0KHRoaXMubWFzdGVyR2Fpbk5vZGUpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBpZiAodGhpcy5nYW1lLmNhY2hlLmdldFNvdW5kKGtleSkgJiYgdGhpcy5nYW1lLmNhY2hlLmlzU291bmRSZWFkeShrZXkpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fc291bmQgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmREYXRhKGtleSk7CiAgICAgICAgICAgIHRoaXMudG90YWxEdXJhdGlvbiA9IDA7CgogICAgICAgICAgICBpZiAodGhpcy5fc291bmQuZHVyYXRpb24pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudG90YWxEdXJhdGlvbiA9IHRoaXMuX3NvdW5kLmR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5vblNvdW5kVW5sb2NrLmFkZCh0aGlzLnNvdW5kSGFzVW5sb2NrZWQsIHRoaXMpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkRlY29kZWQgLSBUaGUgb25EZWNvZGVkIGV2ZW50IGlzIGRpc3BhdGNoZWQgd2hlbiB0aGUgc291bmQgaGFzIGZpbmlzaGVkIGRlY29kaW5nICh0eXBpY2FsbHkgZm9yIG1wMyBmaWxlcykKICAgICovCiAgICB0aGlzLm9uRGVjb2RlZCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uUGxheSAtIFRoZSBvblBsYXkgZXZlbnQgaXMgZGlzcGF0Y2hlZCBlYWNoIHRpbWUgdGhpcyBzb3VuZCBpcyBwbGF5ZWQuCiAgICAqLwogICAgdGhpcy5vblBsYXkgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvblBhdXNlIC0gVGhlIG9uUGF1c2UgZXZlbnQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoaXMgc291bmQgaXMgcGF1c2VkLgogICAgKi8KICAgIHRoaXMub25QYXVzZSA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uUmVzdW1lIC0gVGhlIG9uUmVzdW1lIGV2ZW50IGlzIGRpc3BhdGNoZWQgd2hlbiB0aGlzIHNvdW5kIGlzIHJlc3VtZWQgZnJvbSBhIHBhdXNlZCBzdGF0ZS4KICAgICovCiAgICB0aGlzLm9uUmVzdW1lID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Mb29wIC0gVGhlIG9uTG9vcCBldmVudCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhpcyBzb3VuZCBsb29wcyBkdXJpbmcgcGxheWJhY2suCiAgICAqLwogICAgdGhpcy5vbkxvb3AgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvblN0b3AgLSBUaGUgb25TdG9wIGV2ZW50IGlzIGRpc3BhdGNoZWQgd2hlbiB0aGlzIHNvdW5kIHN0b3BzIHBsYXliYWNrLgogICAgKi8KICAgIHRoaXMub25TdG9wID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25NdXRlIC0gVGhlIG9uTW91c2UgZXZlbnQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoaXMgc291bmQgaXMgbXV0ZWQuCiAgICAqLwogICAgdGhpcy5vbk11dGUgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbk1hcmtlckNvbXBsZXRlIC0gVGhlIG9uTWFya2VyQ29tcGxldGUgZXZlbnQgaXMgZGlzcGF0Y2hlZCB3aGVuIGEgbWFya2VyIHdpdGhpbiB0aGlzIHNvdW5kIGNvbXBsZXRlcyBwbGF5YmFjay4KICAgICovCiAgICB0aGlzLm9uTWFya2VyQ29tcGxldGUgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKfTsKClBoYXNlci5Tb3VuZC5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIENhbGxlZCBhdXRvbWF0aWNhbGx5IHdoZW4gdGhpcyBzb3VuZCBpcyB1bmxvY2tlZC4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmQjc291bmRIYXNVbmxvY2tlZAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIFBoYXNlci5DYWNoZSBrZXkgb2YgdGhlIHNvdW5kIGZpbGUgdG8gY2hlY2sgZm9yIGRlY29kaW5nLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgc291bmRIYXNVbmxvY2tlZDogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAoa2V5ID09IHRoaXMua2V5KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fc291bmQgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmREYXRhKHRoaXMua2V5KTsKICAgICAgICAgICAgdGhpcy50b3RhbER1cmF0aW9uID0gdGhpcy5fc291bmQuZHVyYXRpb247CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdzb3VuZCBoYXMgdW5sb2NrZWQnICsgdGhpcy5fc291bmQpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgICogRGVzY3JpcHRpb24uCiAgICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNhZGRNYXJrZXIKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gRGVzY3JpcHRpb24uCiAgICAgKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBzdGFydCAtIERlc2NyaXB0aW9uLgogICAgICogQHBhcmFtIHtEZXNjcmlwdGlvbn0gc3RvcCAtIERlc2NyaXB0aW9uLgogICAgICogQHBhcmFtIHtEZXNjcmlwdGlvbn0gdm9sdW1lIC0gRGVzY3JpcHRpb24uCiAgICAgKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBsb29wIC0gRGVzY3JpcHRpb24uCiAgICBhZGRNYXJrZXI6IGZ1bmN0aW9uIChuYW1lLCBzdGFydCwgc3RvcCwgdm9sdW1lLCBsb29wKSB7CgogICAgICAgIHZvbHVtZSA9IHZvbHVtZSB8fCAxOwogICAgICAgIGlmICh0eXBlb2YgbG9vcCA9PSAndW5kZWZpbmVkJykgeyBsb29wID0gZmFsc2U7IH0KCiAgICAgICAgdGhpcy5tYXJrZXJzW25hbWVdID0gewogICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICBzdGFydDogc3RhcnQsCiAgICAgICAgICAgIHN0b3A6IHN0b3AsCiAgICAgICAgICAgIHZvbHVtZTogdm9sdW1lLAogICAgICAgICAgICBkdXJhdGlvbjogc3RvcCAtIHN0YXJ0LAogICAgICAgICAgICBsb29wOiBsb29wCiAgICAgICAgfTsKCiAgICB9LAogICAgKi8KCiAgICAvKioKICAgICogQWRkcyBhIG1hcmtlciBpbnRvIHRoZSBjdXJyZW50IFNvdW5kLiBBIG1hcmtlciBpcyByZXByZXNlbnRlZCBieSBhIHVuaXF1ZSBrZXkgYW5kIGEgc3RhcnQgdGltZSBhbmQgZHVyYXRpb24uCiAgICAqIFRoaXMgYWxsb3dzIHlvdSB0byBidW5kbGUgbXVsdGlwbGUgc291bmRzIHRvZ2V0aGVyIGludG8gYSBzaW5nbGUgYXVkaW8gZmlsZSBhbmQgdXNlIG1hcmtlcnMgdG8ganVtcCBiZXR3ZWVuIHRoZW0gZm9yIHBsYXliYWNrLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNhZGRNYXJrZXIKICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBBIHVuaXF1ZSBuYW1lIGZvciB0aGlzIG1hcmtlciwgaS5lLiAnZXhwbG9zaW9uJywgJ2d1bnNob3QnLCBldGMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCAtIFRoZSBzdGFydCBwb2ludCBvZiB0aGlzIG1hcmtlciBpbiB0aGUgYXVkaW8gZmlsZSwgZ2l2ZW4gaW4gc2Vjb25kcy4gMi41ID0gMjUwMG1zLCAwLjUgPSA1MDBtcywgZXRjLgogICAgKiBAcGFyYW0ge251bWJlcn0gZHVyYXRpb24gLSBUaGUgZHVyYXRpb24gb2YgdGhlIG1hcmtlciBpbiBzZWNvbmRzLiAyLjUgPSAyNTAwbXMsIDAuNSA9IDUwMG1zLCBldGMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdm9sdW1lPTFdIC0gVGhlIHZvbHVtZSB0aGUgc291bmQgd2lsbCBwbGF5IGJhY2sgYXQsIGJldHdlZW4gMCAoc2lsZW50KSBhbmQgMSAoZnVsbCB2b2x1bWUpLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIFNldHMgaWYgdGhlIHNvdW5kIHdpbGwgbG9vcCBvciBub3QuCiAgICAqLwogICAgYWRkTWFya2VyOiBmdW5jdGlvbiAobmFtZSwgc3RhcnQsIGR1cmF0aW9uLCB2b2x1bWUsIGxvb3ApIHsKCiAgICAgICAgdm9sdW1lID0gdm9sdW1lIHx8IDE7CiAgICAgICAgaWYgKHR5cGVvZiBsb29wID09ICd1bmRlZmluZWQnKSB7IGxvb3AgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLm1hcmtlcnNbbmFtZV0gPSB7CiAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgIHN0YXJ0OiBzdGFydCwKICAgICAgICAgICAgc3RvcDogc3RhcnQgKyBkdXJhdGlvbiwKICAgICAgICAgICAgdm9sdW1lOiB2b2x1bWUsCiAgICAgICAgICAgIGR1cmF0aW9uOiBkdXJhdGlvbiwKICAgICAgICAgICAgZHVyYXRpb25NUzogZHVyYXRpb24gKiAxMDAwLAogICAgICAgICAgICBsb29wOiBsb29wCiAgICAgICAgfTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGEgbWFya2VyIGZyb20gdGhlIHNvdW5kLgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNyZW1vdmVNYXJrZXIKICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUga2V5IG9mIHRoZSBtYXJrZXIgdG8gcmVtb3ZlLgogICAgKi8KICAgIHJlbW92ZU1hcmtlcjogZnVuY3Rpb24gKG5hbWUpIHsKCiAgICAgICAgZGVsZXRlIHRoaXMubWFya2Vyc1tuYW1lXTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgYXV0b21hdGljYWxseSBieSBQaGFzZXIuU291bmRNYW5hZ2VyLgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCN1cGRhdGUKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5wZW5kaW5nUGxheWJhY2sgJiYgdGhpcy5nYW1lLmNhY2hlLmlzU291bmRSZWFkeSh0aGlzLmtleSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnBlbmRpbmdQbGF5YmFjayA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnBsYXkodGhpcy5fdGVtcE1hcmtlciwgdGhpcy5fdGVtcFBvc2l0aW9uLCB0aGlzLl90ZW1wVm9sdW1lLCB0aGlzLl90ZW1wTG9vcCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5pc1BsYXlpbmcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5zdGFydFRpbWU7CgogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50VGltZSA+PSB0aGlzLmR1cmF0aW9uTVMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2codGhpcy5jdXJyZW50TWFya2VyLCAnaGFzIGhpdCBkdXJhdGlvbicpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29wKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2xvb3AxJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vICB3b24ndCB3b3JrIHdpdGggbWFya2VycywgbmVlZHMgdG8gcmVzZXQgdGhlIHBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25Mb29wLmRpc3BhdGNoKHRoaXMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudE1hcmtlciA9PT0gJycpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdsb29wMicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdsb29wMycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5KHRoaXMuY3VycmVudE1hcmtlciwgMCwgdGhpcy52b2x1bWUsIHRydWUsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdzdG9wcGluZywgbm8gbG9vcCBmb3IgbWFya2VyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29wKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkxvb3AuZGlzcGF0Y2godGhpcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGxheSh0aGlzLmN1cnJlbnRNYXJrZXIsIDAsIHRoaXMudm9sdW1lLCB0cnVlLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogUGxheSB0aGlzIHNvdW5kLCBvciBhIG1hcmtlZCBzZWN0aW9uIG9mIGl0LgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNwbGF5CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbbWFya2VyPScnXSAtIElmIHlvdSB3YW50IHRvIHBsYXkgYSBtYXJrZXIgdGhlbiBnaXZlIHRoZSBrZXkgaGVyZSwgb3RoZXJ3aXNlIGxlYXZlIGJsYW5rIHRvIHBsYXkgdGhlIGZ1bGwgc291bmQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcG9zaXRpb249MF0gLSBUaGUgc3RhcnRpbmcgcG9zaXRpb24gdG8gcGxheSB0aGUgc291bmQgZnJvbSAtIHRoaXMgaXMgaWdub3JlZCBpZiB5b3UgcHJvdmlkZSBhIG1hcmtlci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt2b2x1bWU9MV0gLSBWb2x1bWUgb2YgdGhlIHNvdW5kIHlvdSB3YW50IHRvIHBsYXkuIElmIG5vbmUgaXMgZ2l2ZW4gaXQgd2lsbCB1c2UgdGhlIHZvbHVtZSBnaXZlbiB0byB0aGUgU291bmQgd2hlbiBpdCB3YXMgY3JlYXRlZCAod2hpY2ggZGVmYXVsdHMgdG8gMSBpZiBub25lIHdhcyBzcGVjaWZpZWQpLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIExvb3Agd2hlbiBpdCBmaW5pc2hlZCBwbGF5aW5nPwogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmb3JjZVJlc3RhcnQ9dHJ1ZV0gLSBJZiB0aGUgc291bmQgaXMgYWxyZWFkeSBwbGF5aW5nIHlvdSBjYW4gc2V0IGZvcmNlUmVzdGFydCB0byByZXN0YXJ0IGl0IGZyb20gdGhlIGJlZ2lubmluZy4KICAgICogQHJldHVybiB7UGhhc2VyLlNvdW5kfSBUaGlzIHNvdW5kIGluc3RhbmNlLgogICAgKi8KICAgIHBsYXk6IGZ1bmN0aW9uIChtYXJrZXIsIHBvc2l0aW9uLCB2b2x1bWUsIGxvb3AsIGZvcmNlUmVzdGFydCkgewoKICAgICAgICBtYXJrZXIgPSBtYXJrZXIgfHwgJyc7CiAgICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbiB8fCAwOwoKICAgICAgICBpZiAodHlwZW9mIHZvbHVtZSA9PT0gJ3VuZGVmaW5lZCcpIHsgdm9sdW1lID0gdGhpcy5fdm9sdW1lOyB9CiAgICAgICAgaWYgKHR5cGVvZiBsb29wID09PSAndW5kZWZpbmVkJykgeyBsb29wID0gZmFsc2U7IH0KICAgICAgICBpZiAodHlwZW9mIGZvcmNlUmVzdGFydCA9PT0gJ3VuZGVmaW5lZCcpIHsgZm9yY2VSZXN0YXJ0ID0gdHJ1ZTsgfQoKICAgICAgICAvLyBjb25zb2xlLmxvZyh0aGlzLm5hbWUgKyAnIHBsYXkgJyArIG1hcmtlciArICcgcG9zaXRpb24gJyArIHBvc2l0aW9uICsgJyB2b2x1bWUgJyArIHZvbHVtZSArICcgbG9vcCAnICsgbG9vcCwgJ2ZvcmNlJywgZm9yY2VSZXN0YXJ0KTsKCiAgICAgICAgaWYgKHRoaXMuaXNQbGF5aW5nID09PSB0cnVlICYmIGZvcmNlUmVzdGFydCA9PT0gZmFsc2UgJiYgdGhpcy5vdmVycmlkZSA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICAvLyAgVXNlIFJlc3RhcnQgaW5zdGVhZAogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5pc1BsYXlpbmcgJiYgdGhpcy5vdmVycmlkZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdhc2tlZCB0byBwbGF5ICcgKyBtYXJrZXIgKyAnIGJ1dCBhbHJlYWR5IHBsYXlpbmcgJyArIHRoaXMuY3VycmVudE1hcmtlcik7CiAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnVzaW5nV2ViQXVkaW8pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5fc291bmQuc3RvcCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQubm90ZU9mZigwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5zdG9wKDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudXNpbmdBdWRpb1RhZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc291bmQucGF1c2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5jdXJyZW50TWFya2VyID0gbWFya2VyOwoKICAgICAgICBpZiAobWFya2VyICE9PSAnJykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLm1hcmtlcnNbbWFya2VyXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHRoaXMubWFya2Vyc1ttYXJrZXJdLnN0YXJ0OwogICAgICAgICAgICAgICAgdGhpcy52b2x1bWUgPSB0aGlzLm1hcmtlcnNbbWFya2VyXS52b2x1bWU7CiAgICAgICAgICAgICAgICB0aGlzLmxvb3AgPSB0aGlzLm1hcmtlcnNbbWFya2VyXS5sb29wOwogICAgICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IHRoaXMubWFya2Vyc1ttYXJrZXJdLmR1cmF0aW9uOwogICAgICAgICAgICAgICAgdGhpcy5kdXJhdGlvbk1TID0gdGhpcy5tYXJrZXJzW21hcmtlcl0uZHVyYXRpb25NUzsKCiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnTWFya2VyIExvYWRlZDogJywgbWFya2VyLCAnc3RhcnQ6JywgdGhpcy5wb3NpdGlvbiwgJ2VuZDogJywgdGhpcy5kdXJhdGlvbiwgJ2xvb3AnLCB0aGlzLmxvb3ApOwoKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBNYXJrZXIgPSBtYXJrZXI7CiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wUG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZvbHVtZSA9IHRoaXMudm9sdW1lOwogICAgICAgICAgICAgICAgdGhpcy5fdGVtcExvb3AgPSB0aGlzLmxvb3A7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5Tb3VuZC5wbGF5OiBhdWRpbyBtYXJrZXIgIiArIG1hcmtlciArICIgZG9lc24ndCBleGlzdCIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdubyBtYXJrZXIgaW5mbyBsb2FkZWQnLCBtYXJrZXIpOwoKICAgICAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHBvc2l0aW9uOwogICAgICAgICAgICB0aGlzLnZvbHVtZSA9IHZvbHVtZTsKICAgICAgICAgICAgdGhpcy5sb29wID0gbG9vcDsKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuZHVyYXRpb25NUyA9IDA7CgogICAgICAgICAgICB0aGlzLl90ZW1wTWFya2VyID0gbWFya2VyOwogICAgICAgICAgICB0aGlzLl90ZW1wUG9zaXRpb24gPSBwb3NpdGlvbjsKICAgICAgICAgICAgdGhpcy5fdGVtcFZvbHVtZSA9IHZvbHVtZTsKICAgICAgICAgICAgdGhpcy5fdGVtcExvb3AgPSBsb29wOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBEb2VzIHRoZSBzb3VuZCBuZWVkIGRlY29kaW5nPwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhY2hlLmlzU291bmREZWNvZGVkKHRoaXMua2V5KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIERvIHdlIG5lZWQgdG8gZG8gdGhpcyBldmVyeSB0aW1lIHdlIHBsYXk/IEhvdyBhYm91dCBqdXN0IGlmIHRoZSBidWZmZXIgaXMgZW1wdHk/CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYnVmZmVyID09IG51bGwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnVmZmVyID0gdGhpcy5nYW1lLmNhY2hlLmdldFNvdW5kRGF0YSh0aGlzLmtleSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fc291bmQgPSB0aGlzLmNvbnRleHQuY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5idWZmZXIgPSB0aGlzLl9idWZmZXI7CiAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmV4dGVybmFsTm9kZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5jb25uZWN0KHRoaXMuZXh0ZXJuYWxOb2RlLmlucHV0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5jb25uZWN0KHRoaXMuZ2Fpbk5vZGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMudG90YWxEdXJhdGlvbiA9IHRoaXMuX3NvdW5kLmJ1ZmZlci5kdXJhdGlvbjsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kdXJhdGlvbiA9PT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnZHVyYXRpb24gcmVzZXQnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gdGhpcy50b3RhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHVyYXRpb25NUyA9IHRoaXMudG90YWxEdXJhdGlvbiAqIDEwMDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubG9vcCAmJiBtYXJrZXIgPT09ICcnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmxvb3AgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vICBVc2VmdWwgdG8gY2FjaGUgdGhpcyBzb21ld2hlcmUgcGVyaGFwcz8KICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5fc291bmQuc3RhcnQgPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLm5vdGVHcmFpbk9uKDAsIHRoaXMucG9zaXRpb24sIHRoaXMuZHVyYXRpb24pOwogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuX3NvdW5kLm5vdGVHcmFpbk9uKDAsIHRoaXMucG9zaXRpb24sIHRoaXMuZHVyYXRpb24gLyAxMDAwKTsKICAgICAgICAgICAgICAgICAgICAvL3RoaXMuX3NvdW5kLm5vdGVPbigwKTsgLy8gdGhlIHplcm8gaXMgdml0YWxseSBpbXBvcnRhbnQsIGNyYXNoZXMgaU9TNiB3aXRob3V0IGl0CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5fc291bmQuc3RhcnQoMCwgdGhpcy5wb3NpdGlvbiwgdGhpcy5kdXJhdGlvbiAvIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnN0YXJ0KDAsIHRoaXMucG9zaXRpb24sIHRoaXMuZHVyYXRpb24pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaXNQbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3BUaW1lID0gdGhpcy5zdGFydFRpbWUgKyB0aGlzLmR1cmF0aW9uTVM7CiAgICAgICAgICAgICAgICB0aGlzLm9uUGxheS5kaXNwYXRjaCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucGVuZGluZ1BsYXliYWNrID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhY2hlLmdldFNvdW5kKHRoaXMua2V5KSAmJiB0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmQodGhpcy5rZXkpLmlzRGVjb2RpbmcgPT09IGZhbHNlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zb3VuZC5kZWNvZGUodGhpcy5rZXksIHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdTb3VuZCBwbGF5IEF1ZGlvJyk7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmQodGhpcy5rZXkpICYmIHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZCh0aGlzLmtleSkubG9ja2VkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygndHJpZWQgcGxheWluZyBsb2NrZWQgc291bmQsIHBlbmRpbmcgc2V0LCByZWxvYWQgc3RhcnRlZCcpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLnJlbG9hZFNvdW5kKHRoaXMua2V5KTsKICAgICAgICAgICAgICAgIHRoaXMucGVuZGluZ1BsYXliYWNrID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdzb3VuZCBub3QgbG9ja2VkLCBzdGF0ZT8nLCB0aGlzLl9zb3VuZC5yZWFkeVN0YXRlKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9zb3VuZCAmJiAodGhpcy5nYW1lLmRldmljZS5jb2Nvb25KUyB8fCB0aGlzLl9zb3VuZC5yZWFkeVN0YXRlID09PSA0KSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgLy8gIFRoaXMgZG9lc24ndCBiZWNvbWUgYXZhaWxhYmxlIHVudGlsIHlvdSBjYWxsIHBsYXkoKSwgd29uZGVyZnVsIC4uLgogICAgICAgICAgICAgICAgICAgIHRoaXMudG90YWxEdXJhdGlvbiA9IHRoaXMuX3NvdW5kLmR1cmF0aW9uOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kdXJhdGlvbiA9PT0gMCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZHVyYXRpb24gPSB0aGlzLnRvdGFsRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZHVyYXRpb25NUyA9IHRoaXMudG90YWxEdXJhdGlvbiAqIDEwMDA7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygncGxheWluZycsIHRoaXMuX3NvdW5kKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5jdXJyZW50VGltZSA9IHRoaXMucG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQubXV0ZWQgPSB0aGlzLl9tdXRlZDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fbXV0ZWQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC52b2x1bWUgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC52b2x1bWUgPSB0aGlzLl92b2x1bWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUGxheWluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydFRpbWUgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9wVGltZSA9IHRoaXMuc3RhcnRUaW1lICsgdGhpcy5kdXJhdGlvbk1TOwogICAgICAgICAgICAgICAgICAgIHRoaXMub25QbGF5LmRpc3BhdGNoKHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMucGVuZGluZ1BsYXliYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAqIFJlc3RhcnQgdGhlIHNvdW5kLCBvciBhIG1hcmtlZCBzZWN0aW9uIG9mIGl0LgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNyZXN0YXJ0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbbWFya2VyPScnXSAtIElmIHlvdSB3YW50IHRvIHBsYXkgYSBtYXJrZXIgdGhlbiBnaXZlIHRoZSBrZXkgaGVyZSwgb3RoZXJ3aXNlIGxlYXZlIGJsYW5rIHRvIHBsYXkgdGhlIGZ1bGwgc291bmQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcG9zaXRpb249MF0gLSBUaGUgc3RhcnRpbmcgcG9zaXRpb24gdG8gcGxheSB0aGUgc291bmQgZnJvbSAtIHRoaXMgaXMgaWdub3JlZCBpZiB5b3UgcHJvdmlkZSBhIG1hcmtlci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt2b2x1bWU9MV0gLSBWb2x1bWUgb2YgdGhlIHNvdW5kIHlvdSB3YW50IHRvIHBsYXkuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gTG9vcCB3aGVuIGl0IGZpbmlzaGVkIHBsYXlpbmc/CiAgICAqLwogICAgcmVzdGFydDogZnVuY3Rpb24gKG1hcmtlciwgcG9zaXRpb24sIHZvbHVtZSwgbG9vcCkgewoKICAgICAgICBtYXJrZXIgPSBtYXJrZXIgfHwgJyc7CiAgICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbiB8fCAwOwogICAgICAgIHZvbHVtZSA9IHZvbHVtZSB8fCAxOwogICAgICAgIGlmICh0eXBlb2YgbG9vcCA9PSAndW5kZWZpbmVkJykgeyBsb29wID0gZmFsc2U7IH0KCiAgICAgICAgdGhpcy5wbGF5KG1hcmtlciwgcG9zaXRpb24sIHZvbHVtZSwgbG9vcCwgdHJ1ZSk7CgogICAgfSwKCiAgICAvKioKICAgICogUGF1c2VzIHRoZSBzb3VuZAogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNwYXVzZQogICAgKi8KICAgIHBhdXNlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmlzUGxheWluZyAmJiB0aGlzLl9zb3VuZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICB0aGlzLmlzUGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnBhdXNlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMucGF1c2VkUG9zaXRpb24gPSB0aGlzLmN1cnJlbnRUaW1lOwogICAgICAgICAgICB0aGlzLnBhdXNlZFRpbWUgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgIHRoaXMub25QYXVzZS5kaXNwYXRjaCh0aGlzKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUmVzdW1lcyB0aGUgc291bmQKICAgICogQG1ldGhvZCBQaGFzZXIuU291bmQjcmVzdW1lCiAgICAqLwogICAgcmVzdW1lOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnBhdXNlZCAmJiB0aGlzLl9zb3VuZCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnVzaW5nV2ViQXVkaW8pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBwID0gdGhpcy5wb3NpdGlvbiArICh0aGlzLnBhdXNlZFBvc2l0aW9uIC8gMTAwMCk7CgogICAgICAgICAgICAgICAgdGhpcy5fc291bmQgPSB0aGlzLmNvbnRleHQuY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5idWZmZXIgPSB0aGlzLl9idWZmZXI7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuZXh0ZXJuYWxOb2RlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmNvbm5lY3QodGhpcy5leHRlcm5hbE5vZGUuaW5wdXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmNvbm5lY3QodGhpcy5nYWluTm9kZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubG9vcCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5sb29wID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3NvdW5kLnN0YXJ0ID09PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5ub3RlR3JhaW5PbigwLCBwLCB0aGlzLmR1cmF0aW9uKTsKICAgICAgICAgICAgICAgICAgICAvL3RoaXMuX3NvdW5kLm5vdGVPbigwKTsgLy8gdGhlIHplcm8gaXMgdml0YWxseSBpbXBvcnRhbnQsIGNyYXNoZXMgaU9TNiB3aXRob3V0IGl0CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQuc3RhcnQoMCwgcCwgdGhpcy5kdXJhdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5wbGF5KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaXNQbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdGFydFRpbWUgKz0gKHRoaXMuZ2FtZS50aW1lLm5vdyAtIHRoaXMucGF1c2VkVGltZSk7CiAgICAgICAgICAgIHRoaXMub25SZXN1bWUuZGlzcGF0Y2godGhpcyk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3AgcGxheWluZyB0aGlzIHNvdW5kLgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNzdG9wCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5pc1BsYXlpbmcgJiYgdGhpcy5fc291bmQpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3NvdW5kLnN0b3AgPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLm5vdGVPZmYoMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQuc3RvcCgwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLnVzaW5nQXVkaW9UYWcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnBhdXNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgdmFyIHByZXZNYXJrZXIgPSB0aGlzLmN1cnJlbnRNYXJrZXI7CiAgICAgICAgCiAgICAgICAgdGhpcy5jdXJyZW50TWFya2VyID0gJyc7CiAgICAgICAgdGhpcy5vblN0b3AuZGlzcGF0Y2godGhpcywgcHJldk1hcmtlcik7CgogICAgfQoKfTsKClBoYXNlci5Tb3VuZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuU291bmQ7CgovKioKKiBAbmFtZSBQaGFzZXIuU291bmQjaXNEZWNvZGluZwoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNEZWNvZGluZyAtIFJldHVybnMgdHJ1ZSBpZiB0aGUgc291bmQgZmlsZSBpcyBzdGlsbCBkZWNvZGluZy4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Tb3VuZC5wcm90b3R5cGUsICJpc0RlY29kaW5nIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmQodGhpcy5rZXkpLmlzRGVjb2Rpbmc7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Tb3VuZCNpc0RlY29kZWQKKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzRGVjb2RlZCAtIFJldHVybnMgdHJ1ZSBpZiB0aGUgc291bmQgZmlsZSBoYXMgZGVjb2RlZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Tb3VuZC5wcm90b3R5cGUsICJpc0RlY29kZWQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5jYWNoZS5pc1NvdW5kRGVjb2RlZCh0aGlzLmtleSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Tb3VuZCNtdXRlCiogQHByb3BlcnR5IHtib29sZWFufSBtdXRlIC0gR2V0cyBvciBzZXRzIHRoZSBtdXRlZCBzdGF0ZSBvZiB0aGlzIHNvdW5kLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNvdW5kLnByb3RvdHlwZSwgIm11dGUiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9tdXRlZDsKICAgIH0sCiAKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHZhbHVlID0gdmFsdWUgfHwgbnVsbDsKCiAgICAgICAgaWYgKHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fbXV0ZWQgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fbXV0ZVZvbHVtZSA9IHRoaXMuZ2Fpbk5vZGUuZ2Fpbi52YWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy51c2luZ0F1ZGlvVGFnICYmIHRoaXMuX3NvdW5kKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9tdXRlVm9sdW1lID0gdGhpcy5fc291bmQudm9sdW1lOwogICAgICAgICAgICAgICAgdGhpcy5fc291bmQudm9sdW1lID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9tdXRlZCA9IGZhbHNlOwoKICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5nYWluTm9kZS5nYWluLnZhbHVlID0gdGhpcy5fbXV0ZVZvbHVtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLnVzaW5nQXVkaW9UYWcgJiYgdGhpcy5fc291bmQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnZvbHVtZSA9IHRoaXMuX211dGVWb2x1bWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMub25NdXRlLmRpc3BhdGNoKHRoaXMpOwoKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNvdW5kI3ZvbHVtZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB2b2x1bWUgLSBHZXRzIG9yIHNldHMgdGhlIHZvbHVtZSBvZiB0aGlzIHNvdW5kLCBhIHZhbHVlIGJldHdlZW4gMCBhbmQgMS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Tb3VuZC5wcm90b3R5cGUsICJ2b2x1bWUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3ZvbHVtZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3ZvbHVtZSA9IHZhbHVlOwogICAgICAgICAgICB0aGlzLmdhaW5Ob2RlLmdhaW4udmFsdWUgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy51c2luZ0F1ZGlvVGFnICYmIHRoaXMuX3NvdW5kKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIENhdXNlcyBhbiBJbmRleCBzaXplIGVycm9yIGluIEZpcmVmb3ggaWYgeW91IGRvbid0IGNsYW1wIHRoZSB2YWx1ZQogICAgICAgICAgICBpZiAodmFsdWUgPj0gMCAmJiB2YWx1ZSA8PSAxKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl92b2x1bWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnZvbHVtZSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBTb3VuZCBNYW5hZ2VyIGNvbnN0cnVjdG9yLgoqIFRoZSBTb3VuZCBNYW5hZ2VyIGlzIHJlc3BvbnNpYmxlIGZvciBwbGF5aW5nIGJhY2sgYXVkaW8gdmlhIGVpdGhlciB0aGUgTGVnYWN5IEhUTUwgQXVkaW8gdGFnIG9yIHZpYSBXZWIgQXVkaW8gaWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgaXQuCiogTm90ZTogT24gRmlyZWZveCAyNSsgb24gTGludXggaWYgeW91IGhhdmUgbWVkaWEuZ3N0cmVhbWVyIGRpc2FibGVkIGluIGFib3V0OmNvbmZpZyB0aGVuIGl0IGNhbm5vdCBwbGF5IGJhY2sgbXAzIG9yIG00YSBmaWxlcy4KKgoqIEBjbGFzcyBQaGFzZXIuU291bmRNYW5hZ2VyCiogQGNsYXNzZGVzYyBQaGFzZXIgU291bmQgTWFuYWdlci4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudCBnYW1lIGluc3RhbmNlLgoqLwpQaGFzZXIuU291bmRNYW5hZ2VyID0gZnVuY3Rpb24gKGdhbWUpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uU291bmREZWNvZGUgLSBUaGUgZXZlbnQgZGlzcGF0Y2hlZCB3aGVuIGEgc291bmQgZGVjb2RlcyAodHlwaWNhbGx5IG9ubHkgZm9yIG1wMyBmaWxlcykKICAgICovCiAgICB0aGlzLm9uU291bmREZWNvZGUgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfbXV0ZWQgLSBJbnRlcm5hbCBtdXRlIHRyYWNraW5nIHZhci4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9tdXRlZCA9IGZhbHNlOwogICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfdW5sb2NrU291cmNlIC0gSW50ZXJuYWwgdW5sb2NrIHRyYWNraW5nIHZhci4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl91bmxvY2tTb3VyY2UgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3ZvbHVtZSAtIFRoZSBnbG9iYWwgYXVkaW8gdm9sdW1lLiBBIHZhbHVlIGJldHdlZW4gMCAoc2lsZW5jZSkgYW5kIDEgKGZ1bGwgdm9sdW1lKS4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQgCiAgICAqLwogICAgdGhpcy5fdm9sdW1lID0gMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gX3NvdW5kcyAtIEFuIGFycmF5IGNvbnRhaW5pbmcgYWxsIHRoZSBzb3VuZHMgCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0IFRoZSBlbXB0eSBhcnJheS4KICAgICovCiAgICB0aGlzLl9zb3VuZHMgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBdWRpb0NvbnRleHR9IGNvbnRleHQgLSBUaGUgQXVkaW9Db250ZXh0IGJlaW5nIHVzZWQgZm9yIHBsYXliYWNrLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHVzaW5nV2ViQXVkaW8gLSB0cnVlIGlmIHRoaXMgc291bmQgaXMgYmVpbmcgcGxheWVkIHdpdGggV2ViIEF1ZGlvLgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnVzaW5nV2ViQXVkaW8gPSB0cnVlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB1c2luZ0F1ZGlvVGFnIC0gdHJ1ZSBpZiB0aGUgc291bmQgaXMgYmVpbmcgcGxheWVkIHZpYSB0aGUgQXVkaW8gdGFnLgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnVzaW5nQXVkaW9UYWcgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbm9BdWRpbyAtIEhhcyBhdWRpbyBiZWVuIGRpc2FibGVkIHZpYSB0aGUgUGhhc2VyR2xvYmFsIG9iamVjdD8gVXNlZnVsIGlmIHlvdSBuZWVkIHRvIHVzZSBhIDNyZCBwYXJ0eSBhdWRpbyBsaWJyYXJ5IGluc3RlYWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5ub0F1ZGlvID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29ubmVjdFRvTWFzdGVyIC0gVXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIFNvdW5kLmV4dGVybmFsTm9kZSB0aGlzIGFsbG93cyB5b3UgdG8gc3RvcCBhIFNvdW5kIG5vZGUgYmVpbmcgY29ubmVjdGVkIHRvIHRoZSBTb3VuZE1hbmFnZXIgbWFzdGVyIGdhaW4gbm9kZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNvbm5lY3RUb01hc3RlciA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdG91Y2hMb2NrZWQgLSB0cnVlIGlmIHRoZSBhdWRpbyBzeXN0ZW0gaXMgY3VycmVudGx5IGxvY2tlZCBhd2FpdGluZyBhIHRvdWNoIGV2ZW50LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudG91Y2hMb2NrZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGNoYW5uZWxzIC0gVGhlIG51bWJlciBvZiBhdWRpbyBjaGFubmVscyB0byB1c2UgaW4gcGxheWJhY2suCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jaGFubmVscyA9IDMyOwogICAgCn07CgpQaGFzZXIuU291bmRNYW5hZ2VyLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogSW5pdGlhbGlzZXMgdGhlIHNvdW5kIG1hbmFnZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kTWFuYWdlciNib290CiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBib290OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLmlPUyAmJiB0aGlzLmdhbWUuZGV2aWNlLndlYkF1ZGlvID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2hhbm5lbHMgPSAxOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UuaU9TIHx8ICh3aW5kb3dbJ1BoYXNlckdsb2JhbCddICYmIHdpbmRvd1snUGhhc2VyR2xvYmFsJ10uZmFrZWlPU1RvdWNoTG9jaykpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQudG91Y2guY2FsbGJhY2tDb250ZXh0ID0gdGhpczsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnRvdWNoLnRvdWNoU3RhcnRDYWxsYmFjayA9IHRoaXMudW5sb2NrOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQubW91c2UuY2FsbGJhY2tDb250ZXh0ID0gdGhpczsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm1vdXNlLm1vdXNlRG93bkNhbGxiYWNrID0gdGhpcy51bmxvY2s7CiAgICAgICAgICAgIHRoaXMudG91Y2hMb2NrZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgV2hhdCBhYm91dCBpT1M1PwogICAgICAgICAgICB0aGlzLnRvdWNoTG9ja2VkID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAod2luZG93WydQaGFzZXJHbG9iYWwnXSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBDaGVjayB0byBzZWUgaWYgYWxsIGF1ZGlvIHBsYXliYWNrIGlzIGRpc2FibGVkIChpLmUuIGhhbmRsZWQgYnkgYSAzcmQgcGFydHkgY2xhc3MpCiAgICAgICAgICAgIGlmICh3aW5kb3dbJ1BoYXNlckdsb2JhbCddLmRpc2FibGVBdWRpbyA9PT0gdHJ1ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy51c2luZ1dlYkF1ZGlvID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm5vQXVkaW8gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAgQ2hlY2sgaWYgdGhlIFdlYiBBdWRpbyBBUEkgaXMgZGlzYWJsZWQgKGZvciB0ZXN0aW5nIEF1ZGlvIFRhZyBwbGF5YmFjayBkdXJpbmcgZGV2ZWxvcG1lbnQpCiAgICAgICAgICAgIGlmICh3aW5kb3dbJ1BoYXNlckdsb2JhbCddLmRpc2FibGVXZWJBdWRpbyA9PT0gdHJ1ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy51c2luZ1dlYkF1ZGlvID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnVzaW5nQXVkaW9UYWcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5ub0F1ZGlvID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghIXdpbmRvd1snQXVkaW9Db250ZXh0J10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBuZXcgd2luZG93WydBdWRpb0NvbnRleHQnXSgpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICghIXdpbmRvd1snd2Via2l0QXVkaW9Db250ZXh0J10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBuZXcgd2luZG93Wyd3ZWJraXRBdWRpb0NvbnRleHQnXSgpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICghIXdpbmRvd1snQXVkaW8nXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudXNpbmdXZWJBdWRpbyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnVzaW5nQXVkaW9UYWcgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnVzaW5nV2ViQXVkaW8gPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5ub0F1ZGlvID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuY29udGV4dC5jcmVhdGVHYWluID09PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5tYXN0ZXJHYWluID0gdGhpcy5jb250ZXh0LmNyZWF0ZUdhaW5Ob2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm1hc3RlckdhaW4gPSB0aGlzLmNvbnRleHQuY3JlYXRlR2FpbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1hc3RlckdhaW4uZ2Fpbi52YWx1ZSA9IDE7CiAgICAgICAgICAgIHRoaXMubWFzdGVyR2Fpbi5jb25uZWN0KHRoaXMuY29udGV4dC5kZXN0aW5hdGlvbik7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEVuYWJsZXMgdGhlIGF1ZGlvLCB1c3VhbGx5IGFmdGVyIHRoZSBmaXJzdCB0b3VjaC4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI3VubG9jawogICAgKi8KICAgIHVubG9jazogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy50b3VjaExvY2tlZCA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyAgR2xvYmFsIG92ZXJyaWRlIChtb3N0bHkgZm9yIEF1ZGlvIFRhZyB0ZXN0aW5nKQogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLndlYkF1ZGlvID09PSBmYWxzZSB8fCAod2luZG93WydQaGFzZXJHbG9iYWwnXSAmJiB3aW5kb3dbJ1BoYXNlckdsb2JhbCddLmRpc2FibGVXZWJBdWRpbyA9PT0gdHJ1ZSkpCiAgICAgICAgewogICAgICAgICAgICAvLyAgQ3JlYXRlIGFuIEF1ZGlvIHRhZz8KICAgICAgICAgICAgdGhpcy50b3VjaExvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl91bmxvY2tTb3VyY2UgPSBudWxsOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQudG91Y2guY2FsbGJhY2tDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnRvdWNoLnRvdWNoU3RhcnRDYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5tb3VzZS5jYWxsYmFja0NvbnRleHQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQubW91c2UubW91c2VEb3duQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyBDcmVhdGUgZW1wdHkgYnVmZmVyIGFuZCBwbGF5IGl0CiAgICAgICAgICAgIHZhciBidWZmZXIgPSB0aGlzLmNvbnRleHQuY3JlYXRlQnVmZmVyKDEsIDEsIDIyMDUwKTsKICAgICAgICAgICAgdGhpcy5fdW5sb2NrU291cmNlID0gdGhpcy5jb250ZXh0LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICB0aGlzLl91bmxvY2tTb3VyY2UuYnVmZmVyID0gYnVmZmVyOwogICAgICAgICAgICB0aGlzLl91bmxvY2tTb3VyY2UuY29ubmVjdCh0aGlzLmNvbnRleHQuZGVzdGluYXRpb24pOwogICAgICAgICAgICB0aGlzLl91bmxvY2tTb3VyY2Uubm90ZU9uKDApOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wcyBhbGwgdGhlIHNvdW5kcyBpbiB0aGUgZ2FtZS4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI3N0b3BBbGwKICAgICovCiAgICBzdG9wQWxsOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc291bmRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1tpXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc291bmRzW2ldLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXVzZXMgYWxsIHRoZSBzb3VuZHMgaW4gdGhlIGdhbWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kTWFuYWdlciNwYXVzZUFsbAogICAgKi8KICAgIHBhdXNlQWxsOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc291bmRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1tpXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc291bmRzW2ldLnBhdXNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogcmVzdW1lcyBldmVyeSBzb3VuZCBpbiB0aGUgZ2FtZS4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI3Jlc3VtZUFsbAogICAgKi8KICAgIHJlc3VtZUFsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NvdW5kcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9zb3VuZHNbaV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kc1tpXS5yZXN1bWUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBEZWNvZGUgYSBzb3VuZCBieSBpdHMgYXNzZXRzIGtleS4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI2RlY29kZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXRzIGtleSBvZiB0aGUgc291bmQgdG8gYmUgZGVjb2RlZC4KICAgICogQHBhcmFtIHtQaGFzZXIuU291bmR9IFtzb3VuZF0gLSBJdHMgYnVmZmVyIHdpbGwgYmUgc2V0IHRvIGRlY29kZWQgZGF0YS4KICAgICovCiAgICBkZWNvZGU6IGZ1bmN0aW9uIChrZXksIHNvdW5kKSB7CgogICAgICAgIHNvdW5kID0gc291bmQgfHwgbnVsbDsKCiAgICAgICAgdmFyIHNvdW5kRGF0YSA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZERhdGEoa2V5KTsKCiAgICAgICAgaWYgKHNvdW5kRGF0YSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FjaGUuaXNTb3VuZERlY29kZWQoa2V5KSA9PT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS51cGRhdGVTb3VuZChrZXksICdpc0RlY29kaW5nJywgdHJ1ZSk7CgogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwoKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5kZWNvZGVBdWRpb0RhdGEoc291bmREYXRhLCBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5nYW1lLmNhY2hlLmRlY29kZWRTb3VuZChrZXksIGJ1ZmZlcik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNvdW5kKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5vblNvdW5kRGVjb2RlLmRpc3BhdGNoKGtleSwgc291bmQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZXMgZXZlcnkgc291bmQgaW4gdGhlIGdhbWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kTWFuYWdlciN1cGRhdGUKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMudG91Y2hMb2NrZWQpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS53ZWJBdWRpbyAmJiB0aGlzLl91bmxvY2tTb3VyY2UgIT09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgodGhpcy5fdW5sb2NrU291cmNlLnBsYXliYWNrU3RhdGUgPT09IHRoaXMuX3VubG9ja1NvdXJjZS5QTEFZSU5HX1NUQVRFIHx8IHRoaXMuX3VubG9ja1NvdXJjZS5wbGF5YmFja1N0YXRlID09PSB0aGlzLl91bmxvY2tTb3VyY2UuRklOSVNIRURfU1RBVEUpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMudG91Y2hMb2NrZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91bmxvY2tTb3VyY2UgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC50b3VjaC5jYWxsYmFja0NvbnRleHQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC50b3VjaC50b3VjaFN0YXJ0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NvdW5kcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3NvdW5kc1tpXS51cGRhdGUoKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyBhIG5ldyBTb3VuZCBpbnRvIHRoZSBTb3VuZE1hbmFnZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kTWFuYWdlciNhZGQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHNvdW5kLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ZvbHVtZT0xXSAtIERlZmF1bHQgdmFsdWUgZm9yIHRoZSB2b2x1bWUuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gV2hldGhlciBvciBub3QgdGhlIHNvdW5kIHdpbGwgbG9vcC4KICAgICogQHBhcmFtIHtib29sZWFufSBbY29ubmVjdD10cnVlXSAtIENvbnRyb2xzIGlmIHRoZSBjcmVhdGVkIFNvdW5kIG9iamVjdCB3aWxsIGNvbm5lY3QgdG8gdGhlIG1hc3RlciBnYWluTm9kZSBvZiB0aGUgU291bmRNYW5hZ2VyIHdoZW4gcnVubmluZyB1bmRlciBXZWJBdWRpby4KICAgICogQHJldHVybiB7UGhhc2VyLlNvdW5kfSBUaGUgbmV3IHNvdW5kIGluc3RhbmNlLgogICAgKi8KICAgIGFkZDogZnVuY3Rpb24gKGtleSwgdm9sdW1lLCBsb29wLCBjb25uZWN0KSB7CgogICAgICAgIGlmICh0eXBlb2Ygdm9sdW1lID09PSAndW5kZWZpbmVkJykgeyB2b2x1bWUgPSAxOyB9CiAgICAgICAgaWYgKHR5cGVvZiBsb29wID09PSAndW5kZWZpbmVkJykgeyBsb29wID0gZmFsc2U7IH0KICAgICAgICBpZiAodHlwZW9mIGNvbm5lY3QgPT09ICd1bmRlZmluZWQnKSB7IGNvbm5lY3QgPSB0aGlzLmNvbm5lY3RUb01hc3RlcjsgfQoKICAgICAgICB2YXIgc291bmQgPSBuZXcgUGhhc2VyLlNvdW5kKHRoaXMuZ2FtZSwga2V5LCB2b2x1bWUsIGxvb3AsIGNvbm5lY3QpOwoKICAgICAgICB0aGlzLl9zb3VuZHMucHVzaChzb3VuZCk7CgogICAgICAgIHJldHVybiBzb3VuZDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIGEgbmV3IFNvdW5kIGludG8gdGhlIFNvdW5kTWFuYWdlciBhbmQgc3RhcnRzIGl0IHBsYXlpbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kTWFuYWdlciNwbGF5CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSBzb3VuZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt2b2x1bWU9MV0gLSBEZWZhdWx0IHZhbHVlIGZvciB0aGUgdm9sdW1lLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIFdoZXRoZXIgb3Igbm90IHRoZSBzb3VuZCB3aWxsIGxvb3AuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2Rlc3Ryb3lPbkNvbXBsZXRlPWZhbHNlXSAtIElmIHRydWUgdGhlIFNvdW5kIHdpbGwgZGVzdHJveSBpdHNlbGYgb25jZSBpdCBoYXMgZmluaXNoZWQgcGxheWluZywgb3IgaXMgc3RvcHBlZC4KICAgICogQHJldHVybiB7UGhhc2VyLlNvdW5kfSBUaGUgbmV3IHNvdW5kIGluc3RhbmNlLgogICAgKi8KICAgIHBsYXk6IGZ1bmN0aW9uIChrZXksIHZvbHVtZSwgbG9vcCwgZGVzdHJveU9uQ29tcGxldGUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBkZXN0cm95T25Db21wbGV0ZSA9PSAndW5kZWZpbmVkJykgeyBkZXN0cm95T25Db21wbGV0ZSA9IGZhbHNlOyB9CgogICAgICAgIHZhciBzb3VuZCA9IHRoaXMuYWRkKGtleSwgdm9sdW1lLCBsb29wKTsKCiAgICAgICAgc291bmQucGxheSgpOwoKICAgICAgICByZXR1cm4gc291bmQ7CgogICAgfQoKfTsKClBoYXNlci5Tb3VuZE1hbmFnZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlNvdW5kTWFuYWdlcjsKCi8qKgoqIEBuYW1lIFBoYXNlci5Tb3VuZE1hbmFnZXIjbXV0ZQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbXV0ZSAtIEdldHMgb3Igc2V0cyB0aGUgbXV0ZWQgc3RhdGUgb2YgdGhlIFNvdW5kTWFuYWdlci4gVGhpcyBlZmZlY3RzIGFsbCBzb3VuZHMgaW4gdGhlIGdhbWUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU291bmRNYW5hZ2VyLnByb3RvdHlwZSwgIm11dGUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiB0aGlzLl9tdXRlZDsKCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHZhbHVlID0gdmFsdWUgfHwgbnVsbDsKCiAgICAgICAgaWYgKHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX211dGVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX211dGVkID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnVzaW5nV2ViQXVkaW8pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX211dGVWb2x1bWUgPSB0aGlzLm1hc3RlckdhaW4uZ2Fpbi52YWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWFzdGVyR2Fpbi5nYWluLnZhbHVlID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIExvb3AgdGhyb3VnaCBzb3VuZHMKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zb3VuZHMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9zb3VuZHNbaV0udXNpbmdBdWRpb1RhZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZHNbaV0ubXV0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX211dGVkID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9tdXRlZCA9IGZhbHNlOwoKICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5tYXN0ZXJHYWluLmdhaW4udmFsdWUgPSB0aGlzLl9tdXRlVm9sdW1lOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAgTG9vcCB0aHJvdWdoIHNvdW5kcwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NvdW5kcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1tpXS51c2luZ0F1ZGlvVGFnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kc1tpXS5tdXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Tb3VuZE1hbmFnZXIjdm9sdW1lCiogQHByb3BlcnR5IHtudW1iZXJ9IHZvbHVtZSAtIEdldHMgb3Igc2V0cyB0aGUgZ2xvYmFsIHZvbHVtZSBvZiB0aGUgU291bmRNYW5hZ2VyLCBhIHZhbHVlIGJldHdlZW4gMCBhbmQgMS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Tb3VuZE1hbmFnZXIucHJvdG90eXBlLCAidm9sdW1lIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1hc3RlckdhaW4uZ2Fpbi52YWx1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3ZvbHVtZTsKICAgICAgICB9CgogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICB2YWx1ZSA9IHRoaXMuZ2FtZS5tYXRoLmNsYW1wKHZhbHVlLCAxLCAwKTsKCiAgICAgICAgdGhpcy5fdm9sdW1lID0gdmFsdWU7CgogICAgICAgIGlmICh0aGlzLnVzaW5nV2ViQXVkaW8pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm1hc3RlckdhaW4uZ2Fpbi52YWx1ZSA9IHZhbHVlOwogICAgICAgIH0KCiAgICAgICAgLy8gIExvb3AgdGhyb3VnaCB0aGUgc291bmQgY2FjaGUgYW5kIGNoYW5nZSB0aGUgdm9sdW1lIG9mIGFsbCBodG1sIGF1ZGlvIHRhZ3MKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NvdW5kcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9zb3VuZHNbaV0udXNpbmdBdWRpb1RhZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc291bmRzW2ldLnZvbHVtZSA9IHRoaXMuX3NvdW5kc1tpXS52b2x1bWUgKiB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQSBjb2xsZWN0aW9uIG9mIG1ldGhvZHMgZm9yIGRpc3BsYXlpbmcgZGVidWcgaW5mb3JtYXRpb24gYWJvdXQgZ2FtZSBvYmplY3RzLiBQaGFzZXIuRGVidWcgcmVxdWlyZXMgYSBDQU5WQVMgZ2FtZSB0eXBlIGluIG9yZGVyIHRvIHJlbmRlciwgc28gaWYgeW91J3ZlIGdvdAoqIHlvdXIgZ2FtZSBzZXQgdG8gdXNlIFBoYXNlci5BVVRPIHRoZW4gc3dhcCBpdCBmb3IgUGhhc2VyLkNBTlZBUyB0byBlbnN1cmUgV2ViR0wgZG9lc24ndCBraWNrIGluLCB0aGVuIHRoZSBEZWJ1ZyBmdW5jdGlvbnMgd2lsbCBhbGwgZGlzcGxheS4KKgoqIEBjbGFzcyBQaGFzZXIuVXRpbHMuRGVidWcKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5VdGlscy5EZWJ1ZyA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwogIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Q29udGV4dH0gY29udGV4dCAtIFRoZSBjYW52YXMgY29udGV4dCBvbiB3aGljaCB0byByZW5kZXIgdGhlIGRlYnVnIGluZm9ybWF0aW9uLgogICAgKi8KICAgIHRoaXMuY29udGV4dCA9IGdhbWUuY29udGV4dDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGZvbnQgLSBUaGUgZm9udCB0aGF0IHRoZSBkZWJ1ZyBpbmZvcm1hdGlvbiBpcyByZW5kZXJlZCBpbi4KICAgICogQGRlZmF1bHQgJzE0cHggQ291cmllcicKICAgICovCiAgICB0aGlzLmZvbnQgPSAnMTRweCBDb3VyaWVyJzsKICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGNvbHVtbldpZHRoIC0gVGhlIHNwYWNpbmcgYmV0d2VlbiBjb2x1bW5zLgogICAgKi8KICAgIHRoaXMuY29sdW1uV2lkdGggPSAxMDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsaW5lSGVpZ2h0IC0gVGhlIGxpbmUgaGVpZ2h0IGJldHdlZW4gdGhlIGRlYnVnIHRleHQuCiAgICAqLwogICAgdGhpcy5saW5lSGVpZ2h0ID0gMTY7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHJlbmRlclNoYWRvdyAtIFNob3VsZCB0aGUgdGV4dCBiZSByZW5kZXJlZCB3aXRoIGEgc2xpZ2h0IHNoYWRvdz8gTWFrZXMgaXQgZWFzaWVyIHRvIHJlYWQgb24gZGlmZmVyZW50IHR5cGVzIG9mIGJhY2tncm91bmQuCiAgICAqLwogICAgdGhpcy5yZW5kZXJTaGFkb3cgPSB0cnVlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtDb250ZXh0fSBjdXJyZW50WCAtIFRoZSBjdXJyZW50IFggcG9zaXRpb24gdGhlIGRlYnVnIGluZm9ybWF0aW9uIHdpbGwgYmUgcmVuZGVyZWQgYXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jdXJyZW50WCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY3VycmVudFkgLSBUaGUgY3VycmVudCBZIHBvc2l0aW9uIHRoZSBkZWJ1ZyBpbmZvcm1hdGlvbiB3aWxsIGJlIHJlbmRlcmVkIGF0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY3VycmVudFkgPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGN1cnJlbnRBbHBoYSAtIFRoZSBjdXJyZW50IGFscGhhIHRoZSBkZWJ1ZyBpbmZvcm1hdGlvbiB3aWxsIGJlIHJlbmRlcmVkIGF0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY3VycmVudEFscGhhID0gMTsKCn07CgpQaGFzZXIuVXRpbHMuRGVidWcucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QgdGhhdCByZXNldHMgYW5kIHN0YXJ0cyB0aGUgZGVidWcgb3V0cHV0IHZhbHVlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjc3RhcnQKICAgICogQHBhcmFtIHtudW1iZXJ9IFt4PTBdIC0gVGhlIFggdmFsdWUgdGhlIGRlYnVnIGluZm8gd2lsbCBzdGFydCBmcm9tLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3k9MF0gLSBUaGUgWSB2YWx1ZSB0aGUgZGVidWcgaW5mbyB3aWxsIHN0YXJ0IGZyb20uCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIFRoZSBjb2xvciB0aGUgZGVidWcgdGV4dCB3aWxsIGRyYXduIGluLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2NvbHVtbldpZHRoPTBdIC0gVGhlIHNwYWNpbmcgYmV0d2VlbiBjb2x1bW5zLgogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoeCwgeSwgY29sb3IsIGNvbHVtbldpZHRoKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgeCAhPT0gJ251bWJlcicpIHsgeCA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIHkgIT09ICdudW1iZXInKSB7IHkgPSAwOyB9CiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwyNTUsMjU1KSc7CiAgICAgICAgaWYgKHR5cGVvZiBjb2x1bW5XaWR0aCA9PT0gJ3VuZGVmaW5lZCcpIHsgY29sdW1uV2lkdGggPSAwOyB9CgogICAgICAgIHRoaXMuY3VycmVudFggPSB4OwogICAgICAgIHRoaXMuY3VycmVudFkgPSB5OwogICAgICAgIHRoaXMuY3VycmVudENvbG9yID0gY29sb3I7CiAgICAgICAgdGhpcy5jdXJyZW50QWxwaGEgPSB0aGlzLmNvbnRleHQuZ2xvYmFsQWxwaGE7CiAgICAgICAgdGhpcy5jb2x1bW5XaWR0aCA9IGNvbHVtbldpZHRoOwoKICAgICAgICB0aGlzLmNvbnRleHQuc2F2ZSgpOwogICAgICAgIHRoaXMuY29udGV4dC5zZXRUcmFuc2Zvcm0oMSwgMCwgMCwgMSwgMCwgMCk7CiAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yOwogICAgICAgIHRoaXMuY29udGV4dC5mb250ID0gdGhpcy5mb250OwogICAgICAgIHRoaXMuY29udGV4dC5nbG9iYWxBbHBoYSA9IDE7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kIHRoYXQgc3RvcHMgdGhlIGRlYnVnIG91dHB1dC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjc3RvcAogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5jb250ZXh0LnJlc3RvcmUoKTsKICAgICAgICB0aGlzLmNvbnRleHQuZ2xvYmFsQWxwaGEgPSB0aGlzLmN1cnJlbnRBbHBoYTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QgdGhhdCBvdXRwdXRzIGEgc2luZ2xlIGxpbmUgb2YgdGV4dC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjbGluZQogICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCAtIFRoZSBsaW5lIG9mIHRleHQgdG8gZHJhdy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt4XSAtIFRoZSBYIHZhbHVlIHRoZSBkZWJ1ZyBpbmZvIHdpbGwgc3RhcnQgZnJvbS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5XSAtIFRoZSBZIHZhbHVlIHRoZSBkZWJ1ZyBpbmZvIHdpbGwgc3RhcnQgZnJvbS4KICAgICovCiAgICBsaW5lOiBmdW5jdGlvbiAodGV4dCwgeCwgeSkgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHggIT09ICd1bmRlZmluZWQnKSB7IHRoaXMuY3VycmVudFggPSB4OyB9CiAgICAgICAgaWYgKHR5cGVvZiB5ICE9PSAndW5kZWZpbmVkJykgeyB0aGlzLmN1cnJlbnRZID0geTsgfQoKICAgICAgICBpZiAodGhpcy5yZW5kZXJTaGFkb3cpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gJ3JnYigwLDAsMCknOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFRleHQodGV4dCwgdGhpcy5jdXJyZW50WCArIDEsIHRoaXMuY3VycmVudFkgKyAxKTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IHRoaXMuY3VycmVudENvbG9yOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxUZXh0KHRleHQsIHRoaXMuY3VycmVudFgsIHRoaXMuY3VycmVudFkpOwogICAgICAgIHRoaXMuY3VycmVudFkgKz0gdGhpcy5saW5lSGVpZ2h0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZCB0aGF0IG91dHB1dHMgYSBzaW5nbGUgbGluZSBvZiB0ZXh0IHNwbGl0IG92ZXIgYXMgbWFueSBjb2x1bW5zIGFzIG5lZWRlZCwgb25lIHBlciBwYXJhbWV0ZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3NwbGl0bGluZQogICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCAtIFRoZSB0ZXh0IHRvIHJlbmRlci4gWW91IGNhbiBoYXZlIGFzIG1hbnkgY29sdW1ucyBvZiB0ZXh0IGFzIHlvdSB3YW50LCBqdXN0IHBhc3MgdGhlbSBhcyBhZGRpdGlvbmFsIHBhcmFtZXRlcnMuCiAgICAqLwogICAgc3BsaXRsaW5lOiBmdW5jdGlvbiAodGV4dCkgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgeCA9IHRoaXMuY3VycmVudFg7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMucmVuZGVyU2hhZG93KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gJ3JnYigwLDAsMCknOwogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxUZXh0KGFyZ3VtZW50c1tpXSwgeCArIDEsIHRoaXMuY3VycmVudFkgKyAxKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSB0aGlzLmN1cnJlbnRDb2xvcjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxUZXh0KGFyZ3VtZW50c1tpXSwgeCwgdGhpcy5jdXJyZW50WSk7CgogICAgICAgICAgICB4ICs9IHRoaXMuY29sdW1uV2lkdGg7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmN1cnJlbnRZICs9IHRoaXMubGluZUhlaWdodDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBWaXN1YWxseSByZW5kZXJzIGEgUXVhZFRyZWUgdG8gdGhlIGRpc3BsYXkuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclF1YWRUcmVlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlF1YWRUcmVlfSBxdWFkdHJlZSAtIFRoZSBxdWFkdHJlZSB0byByZW5kZXIuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBjb2xvciAtIFRoZSBjb2xvciBvZiB0aGUgbGluZXMgaW4gdGhlIHF1YWR0cmVlLgogICAgKi8KICAgIHJlbmRlclF1YWRUcmVlOiBmdW5jdGlvbiAocXVhZHRyZWUsIGNvbG9yKSB7CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYmEoMjU1LDAsMCwwLjMpJzsKCiAgICAgICAgdGhpcy5zdGFydCgpOwoKICAgICAgICB2YXIgYm91bmRzID0gcXVhZHRyZWUuYm91bmRzOwoKICAgICAgICBpZiAocXVhZHRyZWUubm9kZXMubGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VSZWN0KGJvdW5kcy54LCBib3VuZHMueSwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0KTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJUZXh0KHF1YWR0cmVlLklEICsgJyAvICcgKyBxdWFkdHJlZS5vYmplY3RzLmxlbmd0aCwgYm91bmRzLnggKyA0LCBib3VuZHMueSArIDE2LCAncmdiKDAsMjAwLDApJywgJzEycHggQ291cmllcicpOwoKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gJ3JnYigwLDI1NSwwKSc7CgogICAgICAgICAgICAvLyBjaGlsZHJlbgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1YWR0cmVlLm9iamVjdHMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VSZWN0KHF1YWR0cmVlLm9iamVjdHNbaV0ueCwgcXVhZHRyZWUub2JqZWN0c1tpXS55LCBxdWFkdHJlZS5vYmplY3RzW2ldLndpZHRoLCBxdWFkdHJlZS5vYmplY3RzW2ldLmhlaWdodCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWFkdHJlZS5ub2Rlcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJRdWFkVHJlZShxdWFkdHJlZS5ub2Rlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMgdGhlIGNvcm5lcnMgYW5kIHBvaW50IGluZm9ybWF0aW9uIG9mIHRoZSBnaXZlbiBTcHJpdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclNwcml0ZUNvcm5lcnMKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBUaGUgc3ByaXRlIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtzaG93VGV4dD1mYWxzZV0gLSBJZiB0cnVlIHRoZSB4L3kgY29vcmRpbmF0ZXMgb2YgZWFjaCBwb2ludCB3aWxsIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtzaG93Qm91bmRzPWZhbHNlXSAtIElmIHRydWUgdGhlIGJvdW5kcyB3aWxsIGJlIHJlbmRlcmVkIG92ZXIgdGhlIHRvcCBvZiB0aGUgc3ByaXRlLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDAsMjU1KSddIC0gVGhlIGNvbG9yIHRoZSB0ZXh0IGlzIHJlbmRlcmVkIGluLgogICAgKi8KICAgIHJlbmRlclNwcml0ZUNvcm5lcnM6IGZ1bmN0aW9uIChzcHJpdGUsIHNob3dUZXh0LCBzaG93Qm91bmRzLCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBzaG93VGV4dCA9IHNob3dUZXh0IHx8IGZhbHNlOwogICAgICAgIHNob3dCb3VuZHMgPSBzaG93Qm91bmRzIHx8IGZhbHNlOwogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KDAsIDAsIGNvbG9yKTsKCiAgICAgICAgaWYgKHNob3dCb3VuZHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VTdHlsZSA9ICdyZ2JhKDAsIDI1NSwgMCwgMC43KSc7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VSZWN0KHNwcml0ZS5ib3VuZHMueCwgc3ByaXRlLmJvdW5kcy55LCBzcHJpdGUuYm91bmRzLndpZHRoLCBzcHJpdGUuYm91bmRzLmhlaWdodCk7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZSgpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgIHRoaXMuY29udGV4dC5tb3ZlVG8oc3ByaXRlLnRvcExlZnQueCwgc3ByaXRlLnRvcExlZnQueSk7CiAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVUbyhzcHJpdGUudG9wUmlnaHQueCwgc3ByaXRlLnRvcFJpZ2h0LnkpOwogICAgICAgIHRoaXMuY29udGV4dC5saW5lVG8oc3ByaXRlLmJvdHRvbVJpZ2h0LngsIHNwcml0ZS5ib3R0b21SaWdodC55KTsKICAgICAgICB0aGlzLmNvbnRleHQubGluZVRvKHNwcml0ZS5ib3R0b21MZWZ0LngsIHNwcml0ZS5ib3R0b21MZWZ0LnkpOwogICAgICAgIHRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsIDAsIDI1NSwgMC43KSc7CiAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZSgpOwoKICAgICAgICB0aGlzLnJlbmRlclBvaW50KHNwcml0ZS5vZmZzZXQpOwogICAgICAgIHRoaXMucmVuZGVyUG9pbnQoc3ByaXRlLmNlbnRlcik7CiAgICAgICAgdGhpcy5yZW5kZXJQb2ludChzcHJpdGUudG9wTGVmdCk7CiAgICAgICAgdGhpcy5yZW5kZXJQb2ludChzcHJpdGUudG9wUmlnaHQpOwogICAgICAgIHRoaXMucmVuZGVyUG9pbnQoc3ByaXRlLmJvdHRvbUxlZnQpOwogICAgICAgIHRoaXMucmVuZGVyUG9pbnQoc3ByaXRlLmJvdHRvbVJpZ2h0KTsKCiAgICAgICAgaWYgKHNob3dUZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50Q29sb3IgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5saW5lKCd4OiAnICsgTWF0aC5mbG9vcihzcHJpdGUudG9wTGVmdC54KSArICcgeTogJyArIE1hdGguZmxvb3Ioc3ByaXRlLnRvcExlZnQueSksIHNwcml0ZS50b3BMZWZ0LngsIHNwcml0ZS50b3BMZWZ0LnkpOwogICAgICAgICAgICB0aGlzLmxpbmUoJ3g6ICcgKyBNYXRoLmZsb29yKHNwcml0ZS50b3BSaWdodC54KSArICcgeTogJyArIE1hdGguZmxvb3Ioc3ByaXRlLnRvcFJpZ2h0LnkpLCBzcHJpdGUudG9wUmlnaHQueCwgc3ByaXRlLnRvcFJpZ2h0LnkpOwogICAgICAgICAgICB0aGlzLmxpbmUoJ3g6ICcgKyBNYXRoLmZsb29yKHNwcml0ZS5ib3R0b21MZWZ0LngpICsgJyB5OiAnICsgTWF0aC5mbG9vcihzcHJpdGUuYm90dG9tTGVmdC55KSwgc3ByaXRlLmJvdHRvbUxlZnQueCwgc3ByaXRlLmJvdHRvbUxlZnQueSk7CiAgICAgICAgICAgIHRoaXMubGluZSgneDogJyArIE1hdGguZmxvb3Ioc3ByaXRlLmJvdHRvbVJpZ2h0LngpICsgJyB5OiAnICsgTWF0aC5mbG9vcihzcHJpdGUuYm90dG9tUmlnaHQueSksIHNwcml0ZS5ib3R0b21SaWdodC54LCBzcHJpdGUuYm90dG9tUmlnaHQueSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgU291bmQgaW5mb3JtYXRpb24sIGluY2x1ZGluZyBkZWNvZGVkIHN0YXRlLCBkdXJhdGlvbiwgdm9sdW1lIGFuZCBtb3JlLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJTb3VuZEluZm8KICAgICogQHBhcmFtIHtQaGFzZXIuU291bmR9IHNvdW5kIC0gVGhlIHNvdW5kIG9iamVjdCB0byBkZWJ1Zy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclNvdW5kSW5mbzogZnVuY3Rpb24gKHNvdW5kLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvcik7CiAgICAgICAgdGhpcy5saW5lKCdTb3VuZDogJyArIHNvdW5kLmtleSArICcgTG9ja2VkOiAnICsgc291bmQuZ2FtZS5zb3VuZC50b3VjaExvY2tlZCk7CiAgICAgICAgdGhpcy5saW5lKCdJcyBSZWFkeT86ICcgKyB0aGlzLmdhbWUuY2FjaGUuaXNTb3VuZFJlYWR5KHNvdW5kLmtleSkgKyAnIFBlbmRpbmcgUGxheWJhY2s6ICcgKyBzb3VuZC5wZW5kaW5nUGxheWJhY2spOwogICAgICAgIHRoaXMubGluZSgnRGVjb2RlZDogJyArIHNvdW5kLmlzRGVjb2RlZCArICcgRGVjb2Rpbmc6ICcgKyBzb3VuZC5pc0RlY29kaW5nKTsKICAgICAgICB0aGlzLmxpbmUoJ1RvdGFsIER1cmF0aW9uOiAnICsgc291bmQudG90YWxEdXJhdGlvbiArICcgUGxheWluZzogJyArIHNvdW5kLmlzUGxheWluZyk7CiAgICAgICAgdGhpcy5saW5lKCdUaW1lOiAnICsgc291bmQuY3VycmVudFRpbWUpOwogICAgICAgIHRoaXMubGluZSgnVm9sdW1lOiAnICsgc291bmQudm9sdW1lICsgJyBNdXRlZDogJyArIHNvdW5kLm11dGUpOwogICAgICAgIHRoaXMubGluZSgnV2ViQXVkaW86ICcgKyBzb3VuZC51c2luZ1dlYkF1ZGlvICsgJyBBdWRpbzogJyArIHNvdW5kLnVzaW5nQXVkaW9UYWcpOwoKICAgICAgICBpZiAoc291bmQuY3VycmVudE1hcmtlciAhPT0gJycpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxpbmUoJ01hcmtlcjogJyArIHNvdW5kLmN1cnJlbnRNYXJrZXIgKyAnIER1cmF0aW9uOiAnICsgc291bmQuZHVyYXRpb24pOwogICAgICAgICAgICB0aGlzLmxpbmUoJ1N0YXJ0OiAnICsgc291bmQubWFya2Vyc1tzb3VuZC5jdXJyZW50TWFya2VyXS5zdGFydCArICcgU3RvcDogJyArIHNvdW5kLm1hcmtlcnNbc291bmQuY3VycmVudE1hcmtlcl0uc3RvcCk7CiAgICAgICAgICAgIHRoaXMubGluZSgnUG9zaXRpb246ICcgKyBzb3VuZC5wb3NpdGlvbik7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgY2FtZXJhIGluZm9ybWF0aW9uIGluY2x1ZGluZyBkaW1lbnNpb25zIGFuZCBsb2NhdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyQ2FtZXJhSW5mbwogICAgKiBAcGFyYW0ge1BoYXNlci5DYW1lcmF9IGNhbWVyYSAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gY29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyQ2FtZXJhSW5mbzogZnVuY3Rpb24gKGNhbWVyYSwgeCwgeSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwyNTUsMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IpOwogICAgICAgIHRoaXMubGluZSgnQ2FtZXJhICgnICsgY2FtZXJhLndpZHRoICsgJyB4ICcgKyBjYW1lcmEuaGVpZ2h0ICsgJyknKTsKICAgICAgICB0aGlzLmxpbmUoJ1g6ICcgKyBjYW1lcmEueCArICcgWTogJyArIGNhbWVyYS55KTsKICAgICAgICB0aGlzLmxpbmUoJ0JvdW5kcyB4OiAnICsgY2FtZXJhLmJvdW5kcy54ICsgJyBZOiAnICsgY2FtZXJhLmJvdW5kcy55ICsgJyB3OiAnICsgY2FtZXJhLmJvdW5kcy53aWR0aCArICcgaDogJyArIGNhbWVyYS5ib3VuZHMuaGVpZ2h0KTsKICAgICAgICB0aGlzLmxpbmUoJ1ZpZXcgeDogJyArIGNhbWVyYS52aWV3LnggKyAnIFk6ICcgKyBjYW1lcmEudmlldy55ICsgJyB3OiAnICsgY2FtZXJhLnZpZXcud2lkdGggKyAnIGg6ICcgKyBjYW1lcmEudmlldy5oZWlnaHQpOwogICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyB0aGUgUG9pbnRlci5jaXJjbGUgb2JqZWN0IG9udG8gdGhlIHN0YWdlIGluIGdyZWVuIGlmIGRvd24gb3IgcmVkIGlmIHVwIGFsb25nIHdpdGggZGVidWcgdGV4dC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyUG9pbnRlcgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2hpZGVJZlVwPWZhbHNlXSAtIERvZXNuJ3QgcmVuZGVyIHRoZSBjaXJjbGUgaWYgdGhlIHBvaW50ZXIgaXMgdXAuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbZG93bkNvbG9yPSdyZ2JhKDAsMjU1LDAsMC41KSddIC0gVGhlIGNvbG9yIHRoZSBjaXJjbGUgaXMgcmVuZGVyZWQgaW4gaWYgZG93bi4KICAgICogQHBhcmFtIHtzdHJpbmd9IFt1cENvbG9yPSdyZ2JhKDI1NSwwLDAsMC41KSddIC0gVGhlIGNvbG9yIHRoZSBjaXJjbGUgaXMgcmVuZGVyZWQgaW4gaWYgdXAgKGFuZCBoaWRlSWZVcCBpcyBmYWxzZSkuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclBvaW50ZXI6IGZ1bmN0aW9uIChwb2ludGVyLCBoaWRlSWZVcCwgZG93bkNvbG9yLCB1cENvbG9yLCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwgfHwgcG9pbnRlciA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBoaWRlSWZVcCA9PT0gJ3VuZGVmaW5lZCcpIHsgaGlkZUlmVXAgPSBmYWxzZTsgfQogICAgICAgIGRvd25Db2xvciA9IGRvd25Db2xvciB8fCAncmdiYSgwLDI1NSwwLDAuNSknOwogICAgICAgIHVwQ29sb3IgPSB1cENvbG9yIHx8ICdyZ2JhKDI1NSwwLDAsMC41KSc7CiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwyNTUsMjU1KSc7CgogICAgICAgIGlmIChoaWRlSWZVcCA9PT0gdHJ1ZSAmJiBwb2ludGVyLmlzVXAgPT09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0YXJ0KHBvaW50ZXIueCwgcG9pbnRlci55IC0gMTAwLCBjb2xvcik7CiAgICAgICAgdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgIHRoaXMuY29udGV4dC5hcmMocG9pbnRlci54LCBwb2ludGVyLnksIHBvaW50ZXIuY2lyY2xlLnJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwoKICAgICAgICBpZiAocG9pbnRlci5hY3RpdmUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gZG93bkNvbG9yOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gdXBDb2xvcjsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29udGV4dC5maWxsKCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmNsb3NlUGF0aCgpOwoKICAgICAgICAvLyAgUmVuZGVyIHRoZSBwb2ludHMKICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgdGhpcy5jb250ZXh0Lm1vdmVUbyhwb2ludGVyLnBvc2l0aW9uRG93bi54LCBwb2ludGVyLnBvc2l0aW9uRG93bi55KTsKICAgICAgICB0aGlzLmNvbnRleHQubGluZVRvKHBvaW50ZXIucG9zaXRpb24ueCwgcG9pbnRlci5wb3NpdGlvbi55KTsKICAgICAgICB0aGlzLmNvbnRleHQubGluZVdpZHRoID0gMjsKICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmNsb3NlUGF0aCgpOwoKICAgICAgICAvLyAgUmVuZGVyIHRoZSB0ZXh0CiAgICAgICAgLy8gdGhpcy5zdGFydChwb2ludGVyLngsIHBvaW50ZXIueSAtIDEwMCwgY29sb3IpOwogICAgICAgIHRoaXMubGluZSgnSUQ6ICcgKyBwb2ludGVyLmlkICsgIiBBY3RpdmU6ICIgKyBwb2ludGVyLmFjdGl2ZSk7CiAgICAgICAgdGhpcy5saW5lKCdXb3JsZCBYOiAnICsgcG9pbnRlci53b3JsZFggKyAiIFdvcmxkIFk6ICIgKyBwb2ludGVyLndvcmxkWSk7CiAgICAgICAgdGhpcy5saW5lKCdTY3JlZW4gWDogJyArIHBvaW50ZXIueCArICIgU2NyZWVuIFk6ICIgKyBwb2ludGVyLnkpOwogICAgICAgIHRoaXMubGluZSgnRHVyYXRpb246ICcgKyBwb2ludGVyLmR1cmF0aW9uICsgIiBtcyIpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciBTcHJpdGUgSW5wdXQgRGVidWcgaW5mb3JtYXRpb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclNwcml0ZUlucHV0SW5mbwogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFRoZSBzcHJpdGUgdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJTcHJpdGVJbnB1dEluZm86IGZ1bmN0aW9uIChzcHJpdGUsIHgsIHksIGNvbG9yKSB7CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yKTsKICAgICAgICB0aGlzLmxpbmUoJ1Nwcml0ZSBJbnB1dDogKCcgKyBzcHJpdGUud2lkdGggKyAnIHggJyArIHNwcml0ZS5oZWlnaHQgKyAnKScpOwogICAgICAgIHRoaXMubGluZSgneDogJyArIHNwcml0ZS5pbnB1dC5wb2ludGVyWCgpLnRvRml4ZWQoMSkgKyAnIHk6ICcgKyBzcHJpdGUuaW5wdXQucG9pbnRlclkoKS50b0ZpeGVkKDEpKTsKICAgICAgICB0aGlzLmxpbmUoJ292ZXI6ICcgKyBzcHJpdGUuaW5wdXQucG9pbnRlck92ZXIoKSArICcgZHVyYXRpb246ICcgKyBzcHJpdGUuaW5wdXQub3ZlckR1cmF0aW9uKCkudG9GaXhlZCgwKSk7CiAgICAgICAgdGhpcy5saW5lKCdkb3duOiAnICsgc3ByaXRlLmlucHV0LnBvaW50ZXJEb3duKCkgKyAnIGR1cmF0aW9uOiAnICsgc3ByaXRlLmlucHV0LmRvd25EdXJhdGlvbigpLnRvRml4ZWQoMCkpOwogICAgICAgIHRoaXMubGluZSgnanVzdCBvdmVyOiAnICsgc3ByaXRlLmlucHV0Lmp1c3RPdmVyKCkgKyAnIGp1c3Qgb3V0OiAnICsgc3ByaXRlLmlucHV0Lmp1c3RPdXQoKSk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVyIFNwcml0ZSBCb2R5IFBoeXNpY3MgRGF0YSBhcyB0ZXh0LgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJCb2R5SW5mbwogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFRoZSBzcHJpdGUgdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJCb2R5SW5mbzogZnVuY3Rpb24gKHNwcml0ZSwgeCwgeSwgY29sb3IpIHsKCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwyNTUsMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IsIDIxMCk7CgogICAgICAgIHRoaXMuc3BsaXRsaW5lKCd4OiAnICsgc3ByaXRlLmJvZHkueC50b0ZpeGVkKDIpLCAneTogJyArIHNwcml0ZS5ib2R5LnkudG9GaXhlZCgyKSwgJ3dpZHRoOiAnICsgc3ByaXRlLndpZHRoLCAnaGVpZ2h0OiAnICsgc3ByaXRlLmhlaWdodCk7CiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ3NwZWVkOiAnICsgc3ByaXRlLmJvZHkuc3BlZWQudG9GaXhlZCgyKSwgJ2FuZ2xlOiAnICsgc3ByaXRlLmJvZHkuYW5nbGUudG9GaXhlZCgyKSwgJ2xpbmVhciBkYW1waW5nOiAnICsgc3ByaXRlLmJvZHkubGluZWFyRGFtcGluZyk7CiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ2Jsb2NrZWQgbGVmdDogJyArIHNwcml0ZS5ib2R5LmJsb2NrZWQubGVmdCwgJ3JpZ2h0OiAnICsgc3ByaXRlLmJvZHkuYmxvY2tlZC5yaWdodCwgJ3VwOiAnICsgc3ByaXRlLmJvZHkuYmxvY2tlZC51cCwgJ2Rvd246ICcgKyBzcHJpdGUuYm9keS5ibG9ja2VkLmRvd24pOwogICAgICAgIHRoaXMuc3BsaXRsaW5lKCd0b3VjaGluZyBsZWZ0OiAnICsgc3ByaXRlLmJvZHkudG91Y2hpbmcubGVmdCwgJ3JpZ2h0OiAnICsgc3ByaXRlLmJvZHkudG91Y2hpbmcucmlnaHQsICd1cDogJyArIHNwcml0ZS5ib2R5LnRvdWNoaW5nLnVwLCAnZG93bjogJyArIHNwcml0ZS5ib2R5LnRvdWNoaW5nLmRvd24pOwogICAgICAgIHRoaXMuc3BsaXRsaW5lKCdncmF2aXR5IHg6ICcgKyBzcHJpdGUuYm9keS5ncmF2aXR5LngsICd5OiAnICsgc3ByaXRlLmJvZHkuZ3Jhdml0eS55LCAnd29ybGQgZ3Jhdml0eSB4OiAnICsgdGhpcy5nYW1lLnBoeXNpY3MuZ3Jhdml0eS54LCAneTogJyArIHRoaXMuZ2FtZS5waHlzaWNzLmdyYXZpdHkueSk7CiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ2FjY2VsZXJhdGlvbiB4OiAnICsgc3ByaXRlLmJvZHkuYWNjZWxlcmF0aW9uLngudG9GaXhlZCgyKSwgJ3k6ICcgKyBzcHJpdGUuYm9keS5hY2NlbGVyYXRpb24ueS50b0ZpeGVkKDIpKTsKICAgICAgICB0aGlzLnNwbGl0bGluZSgndmVsb2NpdHkgeDogJyArIHNwcml0ZS5ib2R5LnZlbG9jaXR5LngudG9GaXhlZCgyKSwgJ3k6ICcgKyBzcHJpdGUuYm9keS52ZWxvY2l0eS55LnRvRml4ZWQoMiksICdkZWx0YVg6ICcgKyBzcHJpdGUuYm9keS5kZWx0YVgoKS50b0ZpeGVkKDIpLCAnZGVsdGFZOiAnICsgc3ByaXRlLmJvZHkuZGVsdGFZKCkudG9GaXhlZCgyKSk7CiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ2JvdW5jZSB4OiAnICsgc3ByaXRlLmJvZHkuYm91bmNlLngudG9GaXhlZCgyKSwgJ3k6ICcgKyBzcHJpdGUuYm9keS5ib3VuY2UueS50b0ZpeGVkKDIpKTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgZGVidWcgaW5mb3JtYXRpb24gYWJvdXQgdGhlIElucHV0IG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVySW5wdXRJbmZvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJJbnB1dEluZm86IGZ1bmN0aW9uICh4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwwKSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IpOwogICAgICAgIHRoaXMubGluZSgnSW5wdXQnKTsKICAgICAgICB0aGlzLmxpbmUoJ1g6ICcgKyB0aGlzLmdhbWUuaW5wdXQueCArICcgWTogJyArIHRoaXMuZ2FtZS5pbnB1dC55KTsKICAgICAgICB0aGlzLmxpbmUoJ1dvcmxkIFg6ICcgKyB0aGlzLmdhbWUuaW5wdXQud29ybGRYICsgJyBXb3JsZCBZOiAnICsgdGhpcy5nYW1lLmlucHV0LndvcmxkWSk7CiAgICAgICAgdGhpcy5saW5lKCdTY2FsZSBYOiAnICsgdGhpcy5nYW1lLmlucHV0LnNjYWxlLngudG9GaXhlZCgxKSArICcgU2NhbGUgWTogJyArIHRoaXMuZ2FtZS5pbnB1dC5zY2FsZS54LnRvRml4ZWQoMSkpOwogICAgICAgIHRoaXMubGluZSgnU2NyZWVuIFg6ICcgKyB0aGlzLmdhbWUuaW5wdXQuYWN0aXZlUG9pbnRlci5zY3JlZW5YICsgJyBTY3JlZW4gWTogJyArIHRoaXMuZ2FtZS5pbnB1dC5hY3RpdmVQb2ludGVyLnNjcmVlblkpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciBkZWJ1ZyBpbmZvcyAoaW5jbHVkaW5nIG5hbWUsIGJvdW5kcyBpbmZvLCBwb3NpdGlvbiBhbmQgc29tZSBvdGhlciBwcm9wZXJ0aWVzKSBhYm91dCB0aGUgU3ByaXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJTcHJpdGVJbmZvCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJTcHJpdGVJbmZvOiBmdW5jdGlvbiAoc3ByaXRlLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LCAyNTUsIDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yKTsKCiAgICAgICAgdGhpcy5saW5lKCdTcHJpdGU6ICcgKyAnICgnICsgc3ByaXRlLndpZHRoICsgJyB4ICcgKyBzcHJpdGUuaGVpZ2h0ICsgJykgYW5jaG9yOiAnICsgc3ByaXRlLmFuY2hvci54ICsgJyB4ICcgKyBzcHJpdGUuYW5jaG9yLnkpOwogICAgICAgIHRoaXMubGluZSgneDogJyArIHNwcml0ZS54LnRvRml4ZWQoMSkgKyAnIHk6ICcgKyBzcHJpdGUueS50b0ZpeGVkKDEpKTsKICAgICAgICB0aGlzLmxpbmUoJ2FuZ2xlOiAnICsgc3ByaXRlLmFuZ2xlLnRvRml4ZWQoMSkgKyAnIHJvdGF0aW9uOiAnICsgc3ByaXRlLnJvdGF0aW9uLnRvRml4ZWQoMSkpOwogICAgICAgIHRoaXMubGluZSgndmlzaWJsZTogJyArIHNwcml0ZS52aXNpYmxlICsgJyBpbiBjYW1lcmE6ICcgKyBzcHJpdGUuaW5DYW1lcmEpOwogICAgICAgIHRoaXMubGluZSgnYm9keSB4OiAnICsgc3ByaXRlLmJvZHkueC50b0ZpeGVkKDEpICsgJyB5OiAnICsgc3ByaXRlLmJvZHkueS50b0ZpeGVkKDEpKTsKCiAgICAgICAgLy8gIDAgPSBzY2FsZVgKICAgICAgICAvLyAgMSA9IHNrZXdZCiAgICAgICAgLy8gIDIgPSB0cmFuc2xhdGVYCiAgICAgICAgLy8gIDMgPSBza2V3WAogICAgICAgIC8vICA0ID0gc2NhbGVZCiAgICAgICAgLy8gIDUgPSB0cmFuc2xhdGVZCgogICAgICAgIHRoaXMubGluZSgnaWQ6ICcgKyBzcHJpdGUuX2lkKTsKICAgICAgICB0aGlzLmxpbmUoJ3NjYWxlIHg6ICcgKyBzcHJpdGUud29ybGRUcmFuc2Zvcm1bMF0pOwogICAgICAgIHRoaXMubGluZSgnc2NhbGUgeTogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVs0XSk7CiAgICAgICAgdGhpcy5saW5lKCd0eDogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVsyXSk7CiAgICAgICAgdGhpcy5saW5lKCd0eTogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVs1XSk7CiAgICAgICAgdGhpcy5saW5lKCdza2V3IHg6ICcgKyBzcHJpdGUud29ybGRUcmFuc2Zvcm1bM10pOwogICAgICAgIHRoaXMubGluZSgnc2tldyB5OiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzFdKTsKICAgICAgICB0aGlzLmxpbmUoJ3NkeDogJyArIHNwcml0ZS5kZWx0YVgpOwogICAgICAgIHRoaXMubGluZSgnc2R5OiAnICsgc3ByaXRlLmRlbHRhWSk7CgogICAgICAgIC8vIHRoaXMubGluZSgnaW5DYW1lcmE6ICcgKyB0aGlzLmdhbWUucmVuZGVyZXIuc3ByaXRlUmVuZGVyZXIuaW5DYW1lcmEodGhpcy5nYW1lLmNhbWVyYSwgc3ByaXRlKSk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyB0aGUgc3ByaXRlIGNvb3JkaW5hdGVzIGluIGxvY2FsLCBwb3NpdGlvbmFsIGFuZCB3b3JsZCBzcGFjZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyU3ByaXRlQ29vcmRzCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gbGluZSAtIFRoZSBzcHJpdGUgdG8gaW5zcGVjdC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclNwcml0ZUNvb3JkczogZnVuY3Rpb24gKHNwcml0ZSwgeCwgeSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwgMjU1LCAyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvciwgMTAwKTsKCiAgICAgICAgaWYgKHNwcml0ZS5uYW1lKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5saW5lKHNwcml0ZS5uYW1lKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3BsaXRsaW5lKCd4OicsIHNwcml0ZS54LnRvRml4ZWQoMiksICd5OicsIHNwcml0ZS55LnRvRml4ZWQoMikpOwogICAgICAgIHRoaXMuc3BsaXRsaW5lKCdwb3MgeDonLCBzcHJpdGUucG9zaXRpb24ueC50b0ZpeGVkKDIpLCAncG9zIHk6Jywgc3ByaXRlLnBvc2l0aW9uLnkudG9GaXhlZCgyKSk7CiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ3dvcmxkIHg6Jywgc3ByaXRlLndvcmxkLngudG9GaXhlZCgyKSwgJ3dvcmxkIHk6Jywgc3ByaXRlLndvcmxkLnkudG9GaXhlZCgyKSk7CgogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMgYSBMaW5lIG9iamVjdCBpbiB0aGUgZ2l2ZW4gY29sb3IuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlckxpbmUKICAgICogQHBhcmFtIHtQaGFzZXIuTGluZX0gbGluZSAtIFRoZSBMaW5lIHRvIHJlbmRlci4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gY29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyTGluZTogZnVuY3Rpb24gKGxpbmUsIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsIDI1NSwgMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoMCwgMCwgY29sb3IpOwogICAgICAgIHRoaXMuY29udGV4dC5saW5lV2lkdGggPSAxOwogICAgICAgIHRoaXMuY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgICB0aGlzLmNvbnRleHQubW92ZVRvKGxpbmUuc3RhcnQueCArIDAuNSwgbGluZS5zdGFydC55ICsgMC41KTsKICAgICAgICB0aGlzLmNvbnRleHQubGluZVRvKGxpbmUuZW5kLnggKyAwLjUsIGxpbmUuZW5kLnkgKyAwLjUpOwogICAgICAgIHRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyBMaW5lIGluZm9ybWF0aW9uIGluIHRoZSBnaXZlbiBjb2xvci4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyTGluZUluZm8KICAgICogQHBhcmFtIHtQaGFzZXIuTGluZX0gbGluZSAtIFRoZSBMaW5lIHRvIHJlbmRlci4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlckxpbmVJbmZvOiBmdW5jdGlvbiAobGluZSwgeCwgeSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwgMjU1LCAyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvciwgODApOwogICAgICAgIHRoaXMuc3BsaXRsaW5lKCdzdGFydC54OicsIGxpbmUuc3RhcnQueC50b0ZpeGVkKDIpLCAnc3RhcnQueTonLCBsaW5lLnN0YXJ0LnkudG9GaXhlZCgyKSk7CiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ2VuZC54OicsIGxpbmUuZW5kLngudG9GaXhlZCgyKSwgJ2VuZC55OicsIGxpbmUuZW5kLnkudG9GaXhlZCgyKSk7CiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ2xlbmd0aDonLCBsaW5lLmxlbmd0aC50b0ZpeGVkKDIpLCAnYW5nbGU6JywgbGluZS5hbmdsZSk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyBQb2ludCBjb29yZGluYXRlcyBpbiB0aGUgZ2l2ZW4gY29sb3IuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclBvaW50SW5mbwogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gc3ByaXRlIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJQb2ludEluZm86IGZ1bmN0aW9uIChwb2ludCwgeCwgeSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwgMjU1LCAyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvcik7CiAgICAgICAgdGhpcy5saW5lKCdweDogJyArIHBvaW50LngudG9GaXhlZCgxKSArICcgcHk6ICcgKyBwb2ludC55LnRvRml4ZWQoMSkpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMganVzdCB0aGUgZnVsbCBTcHJpdGUgYm91bmRzLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJTcHJpdGVCb3VuZHMKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmaWxsPWZhbHNlXSAtIElmIGZhbHNlIHRoZSBib3VuZHMgb3V0bGluZSBpcyByZW5kZXJlZCwgaWYgdHJ1ZSB0aGUgd2hvbGUgcmVjdGFuZ2xlIGlzIHJlbmRlcmVkLgogICAgKi8KICAgIHJlbmRlclNwcml0ZUJvZHk6IGZ1bmN0aW9uIChzcHJpdGUsIGNvbG9yLCBmaWxsKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMCwyNTUpJzsKCiAgICAgICAgaWYgKHR5cGVvZiBmaWxsID09PSAndW5kZWZpbmVkJykgeyBmaWxsID0gZmFsc2U7IH0KCiAgICAgICAgdGhpcy5zdGFydCgwLCAwLCBjb2xvcik7CgogICAgICAgIGlmIChmaWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFJlY3Qoc3ByaXRlLmJvZHkubGVmdCwgc3ByaXRlLmJvZHkudG9wLCBzcHJpdGUuYm9keS53aWR0aCwgc3ByaXRlLmJvZHkuaGVpZ2h0KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VSZWN0KHNwcml0ZS5ib2R5LmxlZnQsIHNwcml0ZS5ib2R5LnRvcCwgc3ByaXRlLmJvZHkud2lkdGgsIHNwcml0ZS5ib2R5LmhlaWdodCk7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2UoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMganVzdCB0aGUgZnVsbCBTcHJpdGUgYm91bmRzLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJTcHJpdGVCb3VuZHMKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmaWxsPWZhbHNlXSAtIElmIGZhbHNlIHRoZSBib3VuZHMgb3V0bGluZSBpcyByZW5kZXJlZCwgaWYgdHJ1ZSB0aGUgd2hvbGUgcmVjdGFuZ2xlIGlzIHJlbmRlcmVkLgogICAgKi8KICAgIHJlbmRlclNwcml0ZUJvdW5kczogZnVuY3Rpb24gKHNwcml0ZSwgY29sb3IsIGZpbGwpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwwLDI1NSknOwoKICAgICAgICBpZiAodHlwZW9mIGZpbGwgPT09ICd1bmRlZmluZWQnKSB7IGZpbGwgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLnN0YXJ0KDAsIDAsIGNvbG9yKTsKCiAgICAgICAgaWYgKGZpbGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsUmVjdChzcHJpdGUuYm91bmRzLngsIHNwcml0ZS5ib3VuZHMueSwgc3ByaXRlLmJvdW5kcy53aWR0aCwgc3ByaXRlLmJvdW5kcy5oZWlnaHQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVJlY3Qoc3ByaXRlLmJvdW5kcy54LCBzcHJpdGUuYm91bmRzLnksIHNwcml0ZS5ib3VuZHMud2lkdGgsIHNwcml0ZS5ib3VuZHMuaGVpZ2h0KTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZSgpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyBhIHNpbmdsZSBwaXhlbC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyUGl4ZWwKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JdIC0gQ29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQgKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJQaXhlbDogZnVuY3Rpb24gKHgsIHksIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYmEoMCwyNTUsMCwxKSc7CgogICAgICAgIHRoaXMuc3RhcnQoKTsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHgsIHksIDIsIDIpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMgYSBQb2ludCBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclBvaW50CiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBwb2ludCAtIFRoZSBQb2ludCB0byByZW5kZXIuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JdIC0gQ29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQgKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJQb2ludDogZnVuY3Rpb24gKHBvaW50LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2JhKDAsMjU1LDAsMSknOwoKICAgICAgICB0aGlzLnN0YXJ0KCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsUmVjdChwb2ludC54LCBwb2ludC55LCA0LCA0KTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXJzIGEgUmVjdGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJSZWN0YW5nbGUKICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSByZWN0IC0gVGhlIFJlY3RhbmdsZSB0byByZW5kZXIuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JdIC0gQ29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQgKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJSZWN0YW5nbGU6IGZ1bmN0aW9uIChyZWN0LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2JhKDAsMjU1LDAsMC4zKSc7CgogICAgICAgIHRoaXMuc3RhcnQoKTsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHJlY3QueCwgcmVjdC55LCByZWN0LndpZHRoLCByZWN0LmhlaWdodCk7CiAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXJzIGEgQ2lyY2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJDaXJjbGUKICAgICogQHBhcmFtIHtQaGFzZXIuQ2lyY2xlfSBjaXJjbGUgLSBUaGUgQ2lyY2xlIHRvIHJlbmRlci4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlckNpcmNsZTogZnVuY3Rpb24gKGNpcmNsZSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiYSgwLDI1NSwwLDAuMyknOwoKICAgICAgICB0aGlzLnN0YXJ0KCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICB0aGlzLmNvbnRleHQuYXJjKGNpcmNsZS54LCBjaXJjbGUueSwgY2lyY2xlLnJhZGl1cywgMCwgTWF0aC5QSSAqIDIsIGZhbHNlKTsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbCgpOwogICAgICAgIHRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgdGV4dC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyVGV4dAogICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCAtIFRoZSBsaW5lIG9mIHRleHQgdG8gZHJhdy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JdIC0gQ29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQgKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICogQHBhcmFtIHtzdHJpbmd9IGZvbnQgLSBUaGUgZm9udCBvZiB0ZXh0IHRvIGRyYXcuCiAgICAqLwogICAgcmVuZGVyVGV4dDogZnVuY3Rpb24gKHRleHQsIHgsIHksIGNvbG9yLCBmb250KSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDI1NSknOwogICAgICAgIGZvbnQgPSBmb250IHx8ICcxNnB4IENvdXJpZXInOwoKICAgICAgICB0aGlzLnN0YXJ0KCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmZvbnQgPSBmb250OwogICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFRleHQodGV4dCwgeCwgeSk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyUGh5c2ljc0JvZHkKICAgICogQHBhcmFtIHthcnJheX0gYm9keQogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBUaGUgY29sb3IgdGhlIHBvbHlnb24gaXMgc3Ryb2tlZCBpbi4KICAgICovCiAgICByZW5kZXJQaHlzaWNzQm9keTogZnVuY3Rpb24gKGJvZHksIGNvbG9yLCBjb250ZXh0KSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT09IG51bGwgJiYgY29udGV4dCA9PT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDI1NSknOwoKICAgICAgICB2YXIgeCA9IGJvZHkueCAtIHRoaXMuZ2FtZS5jYW1lcmEueDsKICAgICAgICB2YXIgeSA9IGJvZHkueSAtIHRoaXMuZ2FtZS5jYW1lcmEueTsKCiAgICAgICAgaWYgKGJvZHkudHlwZSA9PT0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkNJUkNMRSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3RhcnQoMCwgMCwgY29sb3IpOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VTdHlsZSA9IGNvbG9yOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuYXJjKHgsIHksIGJvZHkuc2hhcGUuciwgMCwgTWF0aC5QSSAqIDIsIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZSgpOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuY2xvc2VQYXRoKCk7CgogICAgICAgICAgICAvLyB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSAncmdiKDAsMCwyNTUpJzsKICAgICAgICAgICAgLy8gdGhpcy5jb250ZXh0LnN0cm9rZVJlY3QoYm9keS5sZWZ0LCBib2R5LnRvcCwgYm9keS53aWR0aCwgYm9keS5oZWlnaHQpOwoKICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHZhciBwb2ludHMgPSBib2R5LnBvbHlnb24ucG9pbnRzOwoKICAgICAgICAgICAgdGhpcy5zdGFydCgwLCAwLCBjb2xvcik7CgogICAgICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5tb3ZlVG8oeCArIHBvaW50c1swXS54LCB5ICsgcG9pbnRzWzBdLnkpOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBwb2ludHMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5saW5lVG8oeCArIHBvaW50c1tpXS54LCB5ICsgcG9pbnRzW2ldLnkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmNvbnRleHQuY2xvc2VQYXRoKCk7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VTdHlsZSA9IGNvbG9yOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CgogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gJ3JnYigyNTUsMCwwKSc7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsUmVjdCh4ICsgcG9pbnRzWzBdLnggLSAyLCB5ICsgcG9pbnRzWzBdLnkgLSAyLCA1LCA1KTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgcG9pbnRzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gJ3JnYigyNTUsJyArIChpICogNDApICsgJywwKSc7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFJlY3QoeCArIHBvaW50c1tpXS54IC0gMiwgeSArIHBvaW50c1tpXS55IC0gMiwgNSwgNSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHRoaXMuY29udGV4dC5zdHJva2VTdHlsZSA9ICdyZ2IoMCwyNTUsMjU1KSc7CiAgICAgICAgICAgIC8vIHRoaXMuY29udGV4dC5zdHJva2VSZWN0KGJvZHkubGVmdCwgYm9keS50b3AsIGJvZHkud2lkdGgsIGJvZHkuaGVpZ2h0KTsKCiAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJQb2x5Z29uCiAgICAqIEBwYXJhbSB7YXJyYXl9IHBvbHlnb24KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gVGhlIGNvbG9yIHRoZSBwb2x5Z29uIGlzIHN0cm9rZWQgaW4uCiAgICAqLwogICAgcmVuZGVyUG9seWdvbjogZnVuY3Rpb24gKHBvbHlnb24sIGNvbG9yLCBjb250ZXh0KSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT09IG51bGwgJiYgY29udGV4dCA9PT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDI1NSknOwoKICAgICAgICB2YXIgcG9pbnRzID0gcG9seWdvbi5wb2ludHM7CiAgICAgICAgdmFyIHggPSBwb2x5Z29uLnBvcy54OwogICAgICAgIHZhciB5ID0gcG9seWdvbi5wb3MueTsKCiAgICAgICAgdGhpcy5zdGFydCgwLCAwLCBjb2xvcik7CgogICAgICAgIHRoaXMuY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgICB0aGlzLmNvbnRleHQubW92ZVRvKHggKyBwb2ludHNbMF0ueCwgeSArIHBvaW50c1swXS55KTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBwb2ludHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQubGluZVRvKHggKyBwb2ludHNbaV0ueCwgeSArIHBvaW50c1tpXS55KTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSBjb2xvcjsKICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CgogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0KCn07CgpQaGFzZXIuVXRpbHMuRGVidWcucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlV0aWxzLkRlYnVnOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQSBjb2xsZWN0aW9uIG9mIG1ldGhvZHMgdXNlZnVsIGZvciBtYW5pcHVsYXRpbmcgYW5kIGNvbXBhcmluZyBjb2xvcnMuCioKKiBAY2xhc3MgUGhhc2VyLkNvbG9yCiovClBoYXNlci5Db2xvciA9IHsKCiAgICAvKioKICAgICogR2l2ZW4gYW4gYWxwaGEgYW5kIDMgY29sb3IgdmFsdWVzIHRoaXMgd2lsbCByZXR1cm4gYW4gaW50ZWdlciByZXByZXNlbnRhdGlvbiBvZiBpdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0Q29sb3IzMgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBBbHBoYSB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gcmVkIC0gVGhlIFJlZCBjaGFubmVsIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBncmVlbiAtIFRoZSBHcmVlbiBjaGFubmVsIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBibHVlIC0gVGhlIEJsdWUgY2hhbm5lbCB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBBIG5hdGl2ZSBjb2xvciB2YWx1ZSBpbnRlZ2VyIChmb3JtYXQ6IDB4QUFSUkdHQkIpLgogICAgKi8KICAgIGdldENvbG9yMzI6IGZ1bmN0aW9uIChhbHBoYSwgcmVkLCBncmVlbiwgYmx1ZSkgewogICAgICAgIHJldHVybiBhbHBoYSA8PCAyNCB8IHJlZCA8PCAxNiB8IGdyZWVuIDw8IDggfCBibHVlOwogICAgfSwKCiAgICAvKioKICAgICogR2l2ZW4gMyBjb2xvciB2YWx1ZXMgdGhpcyB3aWxsIHJldHVybiBhbiBpbnRlZ2VyIHJlcHJlc2VudGF0aW9uIG9mIGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRDb2xvcgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByZWQgLSBUaGUgUmVkIGNoYW5uZWwgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGdyZWVuIC0gVGhlIEdyZWVuIGNoYW5uZWwgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGJsdWUgLSBUaGUgQmx1ZSBjaGFubmVsIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IEEgbmF0aXZlIGNvbG9yIHZhbHVlIGludGVnZXIgKGZvcm1hdDogMHhSUkdHQkIpLgogICAgKi8KICAgIGdldENvbG9yOiBmdW5jdGlvbiAocmVkLCBncmVlbiwgYmx1ZSkgewogICAgICAgIHJldHVybiByZWQgPDwgMTYgfCBncmVlbiA8PCA4IHwgYmx1ZTsKICAgIH0sCgogICAgLyoqCiAgICAqIENvbnZlcnRzIHRoZSBnaXZlbiBoZXggc3RyaW5nIGludG8gYW4gaW50ZWdlciBjb2xvciB2YWx1ZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuaGV4VG9SR0IKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge3N0cmluZ30gaCAtIFRoZSBzdHJpbmcgaGV4IGNvbG9yIHRvIGNvbnZlcnQuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSByZ2IgY29sb3IgdmFsdWUuCiAgICAqLwogICAgaGV4VG9SR0I6IGZ1bmN0aW9uIChoKSB7CgogICAgICAgIHZhciBoZXgxNiA9IChoLmNoYXJBdCgwKSA9PSAiIyIpID8gaC5zdWJzdHJpbmcoMSwgNykgOiBoOwoKICAgICAgICBpZiAoaGV4MTYubGVuZ3RoPT0zKQogICAgICAgIHsKICAgICAgICAgICAgaGV4MTYgPSBoZXgxNi5jaGFyQXQoMCkgKyBoZXgxNi5jaGFyQXQoMCkgKyBoZXgxNi5jaGFyQXQoMSkgKyBoZXgxNi5jaGFyQXQoMSkgKyBoZXgxNi5jaGFyQXQoMikgKyBoZXgxNi5jaGFyQXQoMik7CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVkID0gcGFyc2VJbnQoaGV4MTYuc3Vic3RyaW5nKDAsIDIpLCAxNik7CiAgICAgICAgdmFyIGdyZWVuID0gcGFyc2VJbnQoaGV4MTYuc3Vic3RyaW5nKDIsIDQpLCAxNik7CiAgICAgICAgdmFyIGJsdWUgPSBwYXJzZUludChoZXgxNi5zdWJzdHJpbmcoNCwgNiksIDE2KTsKCiAgICAgICAgcmV0dXJuIHJlZCA8PCAxNiB8IGdyZWVuIDw8IDggfCBibHVlOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHN0cmluZyBjb250YWluaW5nIGhhbmR5IGluZm9ybWF0aW9uIGFib3V0IHRoZSBnaXZlbiBjb2xvciBpbmNsdWRpbmcgc3RyaW5nIGhleCB2YWx1ZSwKICAgICogUkdCIGZvcm1hdCBpbmZvcm1hdGlvbiBhbmQgSFNMIGluZm9ybWF0aW9uLiBFYWNoIHNlY3Rpb24gc3RhcnRzIG9uIGEgbmV3bGluZSwgMyBsaW5lcyBpbiB0b3RhbC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0Q29sb3JJbmZvCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gQSBjb2xvciB2YWx1ZSBpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFN0cmluZyBjb250YWluaW5nIHRoZSAzIGxpbmVzIG9mIGluZm9ybWF0aW9uLgogICAgKi8KICAgIGdldENvbG9ySW5mbzogZnVuY3Rpb24gKGNvbG9yKSB7CgogICAgICAgIHZhciBhcmdiID0gUGhhc2VyLkNvbG9yLmdldFJHQihjb2xvcik7CiAgICAgICAgdmFyIGhzbCA9IFBoYXNlci5Db2xvci5SR0J0b0hTVihjb2xvcik7CiAgICAgICAgCiAgICAgICAgLy8gIEhleCBmb3JtYXQKICAgICAgICB2YXIgcmVzdWx0ID0gUGhhc2VyLkNvbG9yLlJHQnRvSGV4c3RyaW5nKGNvbG9yKSArICJcbiI7CiAgICAgICAgCiAgICAgICAgLy8gIFJHQiBmb3JtYXQKICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KCJBbHBoYTogIiArIGFyZ2IuYWxwaGEgKyAiIFJlZDogIiArIGFyZ2IucmVkICsgIiBHcmVlbjogIiArIGFyZ2IuZ3JlZW4gKyAiIEJsdWU6ICIgKyBhcmdiLmJsdWUpICsgIlxuIjsKICAgICAgICAKICAgICAgICAvLyAgSFNMIGluZm8KICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KCJIdWU6ICIgKyBoc2wuaHVlICsgIiBTYXR1cmF0aW9uOiAiICsgaHNsLnNhdHVyYXRpb24gKyAiIExpZ2h0bmVzOiAiICsgaHNsLmxpZ2h0bmVzcyk7CgogICAgICAgIHJldHVybiByZXN1bHQ7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJuIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBjb2xvciBpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLlJHQnRvSGV4c3RyaW5nCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gVGhlIGNvbG9yIHRvIGdldCB0aGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uIGZvcgogICAgKiBAcmV0dXJucyB7c3RyaW5nfSBBIHN0cmluZyBvZiBsZW5ndGggMTAgY2hhcmFjdGVycyBpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIKICAgICovCiAgICBSR0J0b0hleHN0cmluZzogZnVuY3Rpb24gKGNvbG9yKSB7CgogICAgICAgIHZhciBhcmdiID0gUGhhc2VyLkNvbG9yLmdldFJHQihjb2xvcik7CgogICAgICAgIHJldHVybiAiMHgiICsgUGhhc2VyLkNvbG9yLmNvbG9yVG9IZXhzdHJpbmcoYXJnYi5hbHBoYSkgKyBQaGFzZXIuQ29sb3IuY29sb3JUb0hleHN0cmluZyhhcmdiLnJlZCkgKyBQaGFzZXIuQ29sb3IuY29sb3JUb0hleHN0cmluZyhhcmdiLmdyZWVuKSArIFBoYXNlci5Db2xvci5jb2xvclRvSGV4c3RyaW5nKGFyZ2IuYmx1ZSk7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJuIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBjb2xvciBpbiB0aGUgZm9ybWF0ICNSUkdHQkIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLlJHQnRvV2Vic3RyaW5nCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gVGhlIGNvbG9yIHRvIGdldCB0aGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uIGZvci4KICAgICogQHJldHVybnMge3N0cmluZ30gQSBzdHJpbmcgb2YgbGVuZ3RoIDEwIGNoYXJhY3RlcnMgaW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCLgogICAgKi8KICAgIFJHQnRvV2Vic3RyaW5nOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdmFyIGFyZ2IgPSBQaGFzZXIuQ29sb3IuZ2V0UkdCKGNvbG9yKTsKCiAgICAgICAgcmV0dXJuICIjIiArIFBoYXNlci5Db2xvci5jb2xvclRvSGV4c3RyaW5nKGFyZ2IucmVkKSArIFBoYXNlci5Db2xvci5jb2xvclRvSGV4c3RyaW5nKGFyZ2IuZ3JlZW4pICsgUGhhc2VyLkNvbG9yLmNvbG9yVG9IZXhzdHJpbmcoYXJnYi5ibHVlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm4gYSBzdHJpbmcgY29udGFpbmluZyBhIGhleCByZXByZXNlbnRhdGlvbiBvZiB0aGUgZ2l2ZW4gY29sb3IuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmNvbG9yVG9IZXhzdHJpbmcKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBUaGUgY29sb3IgY2hhbm5lbCB0byBnZXQgdGhlIGhleCB2YWx1ZSBmb3IsIG11c3QgYmUgYSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDI1NSkuCiAgICAqIEByZXR1cm5zIHtzdHJpbmd9IEEgc3RyaW5nIG9mIGxlbmd0aCAyIGNoYXJhY3RlcnMsIGkuZS4gMjU1ID0gRkYsIDAgPSAwMC4KICAgICovCiAgICBjb2xvclRvSGV4c3RyaW5nOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdmFyIGRpZ2l0cyA9ICIwMTIzNDU2Nzg5QUJDREVGIjsKICAgICAgICB2YXIgbHNkID0gY29sb3IgJSAxNjsKICAgICAgICB2YXIgbXNkID0gKGNvbG9yIC0gbHNkKSAvIDE2OwogICAgICAgIHZhciBoZXhpZmllZCA9IGRpZ2l0cy5jaGFyQXQobXNkKSArIGRpZ2l0cy5jaGFyQXQobHNkKTsKICAgICAgICByZXR1cm4gaGV4aWZpZWQ7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJwb2xhdGVzIHRoZSB0d28gZ2l2ZW4gY29sb3VycyBiYXNlZCBvbiB0aGUgc3VwcGxpZWQgc3RlcCBhbmQgY3VycmVudFN0ZXAgcHJvcGVydGllcy4KICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuaW50ZXJwb2xhdGVDb2xvcgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvcjEgLSBUaGUgZmlyc3QgY29sb3IgdmFsdWUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvcjIgLSBUaGUgc2Vjb25kIGNvbG9yIHZhbHVlLgogICAgKiBAcGFyYW0ge251bWJlcn0gc3RlcHMgLSBUaGUgbnVtYmVyIG9mIHN0ZXBzIHRvIHJ1biB0aGUgaW50ZXJwb2xhdGlvbiBvdmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gY3VycmVudFN0ZXAgLSBUaGUgY3VycmVudFN0ZXAgdmFsdWUuIElmIHRoZSBpbnRlcnBvbGF0aW9uIHdpbGwgdGFrZSAxMDAgc3RlcHMsIGEgY3VycmVudFN0ZXAgdmFsdWUgb2YgNTAgd291bGQgYmUgaGFsZi13YXkgYmV0d2VlbiB0aGUgdHdvLgogICAgKiBAcGFyYW0ge251bWJlcn0gYWxwaGEgLSBUaGUgYWxwaGEgb2YgdGhlIHJldHVybmVkIGNvbG9yLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgaW50ZXJwb2xhdGVkIGNvbG9yIHZhbHVlLgogICAgKi8KICAgIGludGVycG9sYXRlQ29sb3I6IGZ1bmN0aW9uIChjb2xvcjEsIGNvbG9yMiwgc3RlcHMsIGN1cnJlbnRTdGVwLCBhbHBoYSkgewoKICAgICAgICBpZiAodHlwZW9mIGFscGhhID09PSAidW5kZWZpbmVkIikgeyBhbHBoYSA9IDI1NTsgfQoKICAgICAgICB2YXIgc3JjMSA9IFBoYXNlci5Db2xvci5nZXRSR0IoY29sb3IxKTsKICAgICAgICB2YXIgc3JjMiA9IFBoYXNlci5Db2xvci5nZXRSR0IoY29sb3IyKTsKICAgICAgICB2YXIgciA9ICgoKHNyYzIucmVkIC0gc3JjMS5yZWQpICogY3VycmVudFN0ZXApIC8gc3RlcHMpICsgc3JjMS5yZWQ7CiAgICAgICAgdmFyIGcgPSAoKChzcmMyLmdyZWVuIC0gc3JjMS5ncmVlbikgKiBjdXJyZW50U3RlcCkgLyBzdGVwcykgKyBzcmMxLmdyZWVuOwogICAgICAgIHZhciBiID0gKCgoc3JjMi5ibHVlIC0gc3JjMS5ibHVlKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIHNyYzEuYmx1ZTsKCiAgICAgICAgcmV0dXJuIFBoYXNlci5Db2xvci5nZXRDb2xvcjMyKGFscGhhLCByLCBnLCBiKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcnBvbGF0ZXMgdGhlIHR3byBnaXZlbiBjb2xvdXJzIGJhc2VkIG9uIHRoZSBzdXBwbGllZCBzdGVwIGFuZCBjdXJyZW50U3RlcCBwcm9wZXJ0aWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5pbnRlcnBvbGF0ZUNvbG9yV2l0aFJHQgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciAtIFRoZSBmaXJzdCBjb2xvciB2YWx1ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHIgLSBUaGUgcmVkIGNvbG9yIHZhbHVlLCBiZXR3ZWVuIDAgYW5kIDB4RkYgKDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBnIC0gVGhlIGdyZWVuIGNvbG9yIHZhbHVlLCBiZXR3ZWVuIDAgYW5kIDB4RkYgKDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBiIC0gVGhlIGJsdWUgY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHN0ZXBzIC0gVGhlIG51bWJlciBvZiBzdGVwcyB0byBydW4gdGhlIGludGVycG9sYXRpb24gb3Zlci4KICAgICogQHBhcmFtIHtudW1iZXJ9IGN1cnJlbnRTdGVwIC0gVGhlIGN1cnJlbnRTdGVwIHZhbHVlLiBJZiB0aGUgaW50ZXJwb2xhdGlvbiB3aWxsIHRha2UgMTAwIHN0ZXBzLCBhIGN1cnJlbnRTdGVwIHZhbHVlIG9mIDUwIHdvdWxkIGJlIGhhbGYtd2F5IGJldHdlZW4gdGhlIHR3by4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIGludGVycG9sYXRlZCBjb2xvciB2YWx1ZS4KICAgICovCiAgICBpbnRlcnBvbGF0ZUNvbG9yV2l0aFJHQjogZnVuY3Rpb24gKGNvbG9yLCByLCBnLCBiLCBzdGVwcywgY3VycmVudFN0ZXApIHsKCiAgICAgICAgdmFyIHNyYyA9IFBoYXNlci5Db2xvci5nZXRSR0IoY29sb3IpOwogICAgICAgIHZhciBvciA9ICgoKHIgLSBzcmMucmVkKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIHNyYy5yZWQ7CiAgICAgICAgdmFyIG9nID0gKCgoZyAtIHNyYy5ncmVlbikgKiBjdXJyZW50U3RlcCkgLyBzdGVwcykgKyBzcmMuZ3JlZW47CiAgICAgICAgdmFyIG9iID0gKCgoYiAtIHNyYy5ibHVlKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIHNyYy5ibHVlOwoKICAgICAgICByZXR1cm4gUGhhc2VyLkNvbG9yLmdldENvbG9yKG9yLCBvZywgb2IpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVycG9sYXRlcyB0aGUgdHdvIGdpdmVuIGNvbG91cnMgYmFzZWQgb24gdGhlIHN1cHBsaWVkIHN0ZXAgYW5kIGN1cnJlbnRTdGVwIHByb3BlcnRpZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmludGVycG9sYXRlUkdCCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IHIxIC0gVGhlIHJlZCBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gZzEgLSBUaGUgZ3JlZW4gY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGIxIC0gVGhlIGJsdWUgY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHIyIC0gVGhlIHJlZCBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gZzIgLSBUaGUgZ3JlZW4gY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGIyIC0gVGhlIGJsdWUgY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHN0ZXBzIC0gVGhlIG51bWJlciBvZiBzdGVwcyB0byBydW4gdGhlIGludGVycG9sYXRpb24gb3Zlci4KICAgICogQHBhcmFtIHtudW1iZXJ9IGN1cnJlbnRTdGVwIC0gVGhlIGN1cnJlbnRTdGVwIHZhbHVlLiBJZiB0aGUgaW50ZXJwb2xhdGlvbiB3aWxsIHRha2UgMTAwIHN0ZXBzLCBhIGN1cnJlbnRTdGVwIHZhbHVlIG9mIDUwIHdvdWxkIGJlIGhhbGYtd2F5IGJldHdlZW4gdGhlIHR3by4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIGludGVycG9sYXRlZCBjb2xvciB2YWx1ZS4KICAgICovCiAgICBpbnRlcnBvbGF0ZVJHQjogZnVuY3Rpb24gKHIxLCBnMSwgYjEsIHIyLCBnMiwgYjIsIHN0ZXBzLCBjdXJyZW50U3RlcCkgewoKICAgICAgICB2YXIgciA9ICgoKHIyIC0gcjEpICogY3VycmVudFN0ZXApIC8gc3RlcHMpICsgcjE7CiAgICAgICAgdmFyIGcgPSAoKChnMiAtIGcxKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIGcxOwogICAgICAgIHZhciBiID0gKCgoYjIgLSBiMSkgKiBjdXJyZW50U3RlcCkgLyBzdGVwcykgKyBiMTsKCiAgICAgICAgcmV0dXJuIFBoYXNlci5Db2xvci5nZXRDb2xvcihyLCBnLCBiKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgcmFuZG9tIGNvbG9yIHZhbHVlIGJldHdlZW4gYmxhY2sgYW5kIHdoaXRlCiAgICAqIFNldCB0aGUgbWluIHZhbHVlIHRvIHN0YXJ0IGVhY2ggY2hhbm5lbCBmcm9tIHRoZSBnaXZlbiBvZmZzZXQuCiAgICAqIFNldCB0aGUgbWF4IHZhbHVlIHRvIHJlc3RyaWN0IHRoZSBtYXhpbXVtIGNvbG9yIHVzZWQgcGVyIGNoYW5uZWwuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldFJhbmRvbUNvbG9yCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBsb3dlc3QgdmFsdWUgdG8gdXNlIGZvciB0aGUgY29sb3IuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYXggLSBUaGUgaGlnaGVzdCB2YWx1ZSB0byB1c2UgZm9yIHRoZSBjb2xvci4KICAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIGFscGhhIHZhbHVlIG9mIHRoZSByZXR1cm5pbmcgY29sb3IgKGRlZmF1bHQgMjU1ID0gZnVsbHkgb3BhcXVlKS4KICAgICogQHJldHVybnMge251bWJlcn0gMzItYml0IGNvbG9yIHZhbHVlIHdpdGggYWxwaGEuCiAgICAqLwogICAgZ2V0UmFuZG9tQ29sb3I6IGZ1bmN0aW9uIChtaW4sIG1heCwgYWxwaGEpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBtaW4gPT09ICJ1bmRlZmluZWQiKSB7IG1pbiA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIG1heCA9PT0gInVuZGVmaW5lZCIpIHsgbWF4ID0gMjU1OyB9CiAgICAgICAgaWYgKHR5cGVvZiBhbHBoYSA9PT0gInVuZGVmaW5lZCIpIHsgYWxwaGEgPSAyNTU7IH0KCiAgICAgICAgLy8gIFNhbml0eSBjaGVja3MKICAgICAgICBpZiAobWF4ID4gMjU1KSB7CiAgICAgICAgICAgIHJldHVybiBQaGFzZXIuQ29sb3IuZ2V0Q29sb3IoMjU1LCAyNTUsIDI1NSk7CiAgICAgICAgfQoKICAgICAgICBpZiAobWluID4gbWF4KSB7CiAgICAgICAgICAgIHJldHVybiBQaGFzZXIuQ29sb3IuZ2V0Q29sb3IoMjU1LCAyNTUsIDI1NSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVkID0gbWluICsgTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbikpOwogICAgICAgIHZhciBncmVlbiA9IG1pbiArIE1hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4pKTsKICAgICAgICB2YXIgYmx1ZSA9IG1pbiArIE1hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4pKTsKCiAgICAgICAgcmV0dXJuIFBoYXNlci5Db2xvci5nZXRDb2xvcjMyKGFscGhhLCByZWQsIGdyZWVuLCBibHVlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm4gdGhlIGNvbXBvbmVudCBwYXJ0cyBvZiBhIGNvbG9yIGFzIGFuIE9iamVjdCB3aXRoIHRoZSBwcm9wZXJ0aWVzIGFscGhhLCByZWQsIGdyZWVuLCBibHVlCiAgICAqCiAgICAqIEFscGhhIHdpbGwgb25seSBiZSBzZXQgaWYgaXQgZXhpc3QgaW4gdGhlIGdpdmVuIGNvbG9yICgweEFBUlJHR0JCKQogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRSR0IKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBDb2xvciBpbiBSR0IgKDB4UlJHR0JCKSBvciBBUkdCIGZvcm1hdCAoMHhBQVJSR0dCQikuCiAgICAqIEByZXR1cm5zIHtvYmplY3R9IEFuIE9iamVjdCB3aXRoIHByb3BlcnRpZXM6IGFscGhhLCByZWQsIGdyZWVuLCBibHVlLgogICAgKi8KICAgIGdldFJHQjogZnVuY3Rpb24gKGNvbG9yKSB7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGFscGhhOiBjb2xvciA+Pj4gMjQsCiAgICAgICAgICAgIHJlZDogY29sb3IgPj4gMTYgJiAweEZGLAogICAgICAgICAgICBncmVlbjogY29sb3IgPj4gOCAmIDB4RkYsCiAgICAgICAgICAgIGJsdWU6IGNvbG9yICYgMHhGRgogICAgICAgIH07CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIENTUyBmcmllbmRseSBzdHJpbmcgdmFsdWUgZnJvbSB0aGUgZ2l2ZW4gY29sb3IuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldFdlYlJHQgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvcgogICAgKiBAcmV0dXJucyB7c3RyaW5nfUEgc3RyaW5nIGluIHRoZSBmb3JtYXQ6ICdyZ2JhKHIsZyxiLGEpJwogICAgKi8KICAgIGdldFdlYlJHQjogZnVuY3Rpb24gKGNvbG9yKSB7CgogICAgICAgIHZhciBhbHBoYSA9IChjb2xvciA+Pj4gMjQpIC8gMjU1OwogICAgICAgIHZhciByZWQgPSBjb2xvciA+PiAxNiAmIDB4RkY7CiAgICAgICAgdmFyIGdyZWVuID0gY29sb3IgPj4gOCAmIDB4RkY7CiAgICAgICAgdmFyIGJsdWUgPSBjb2xvciAmIDB4RkY7CgogICAgICAgIHJldHVybiAncmdiYSgnICsgcmVkLnRvU3RyaW5nKCkgKyAnLCcgKyBncmVlbi50b1N0cmluZygpICsgJywnICsgYmx1ZS50b1N0cmluZygpICsgJywnICsgYWxwaGEudG9TdHJpbmcoKSArICcpJzsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIEdpdmVuIGEgbmF0aXZlIGNvbG9yIHZhbHVlIChpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIpIHRoaXMgd2lsbCByZXR1cm4gdGhlIEFscGhhIGNvbXBvbmVudCwgYXMgYSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDI1NS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0QWxwaGEKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBJbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBBbHBoYSBjb21wb25lbnQgb2YgdGhlIGNvbG9yLCB3aWxsIGJlIGJldHdlZW4gMCBhbmQgMSAoMCBiZWluZyBubyBBbHBoYSAob3BhcXVlKSwgMSBmdWxsIEFscGhhICh0cmFuc3BhcmVudCkpLgogICAgKi8KICAgIGdldEFscGhhOiBmdW5jdGlvbiAoY29sb3IpIHsKICAgICAgICByZXR1cm4gY29sb3IgPj4+IDI0OwogICAgfSwKCiAgICAvKioKICAgICogR2l2ZW4gYSBuYXRpdmUgY29sb3IgdmFsdWUgKGluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQikgdGhpcyB3aWxsIHJldHVybiB0aGUgQWxwaGEgY29tcG9uZW50IGFzIGEgdmFsdWUgYmV0d2VlbiAwIGFuZCAxLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRBbHBoYUZsb2F0CiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gSW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgQWxwaGEgY29tcG9uZW50IG9mIHRoZSBjb2xvciwgd2lsbCBiZSBiZXR3ZWVuIDAgYW5kIDEgKDAgYmVpbmcgbm8gQWxwaGEgKG9wYXF1ZSksIDEgZnVsbCBBbHBoYSAodHJhbnNwYXJlbnQpKS4KICAgICovCiAgICBnZXRBbHBoYUZsb2F0OiBmdW5jdGlvbiAoY29sb3IpIHsKICAgICAgICByZXR1cm4gKGNvbG9yID4+PiAyNCkgLyAyNTU7CiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiBhIG5hdGl2ZSBjb2xvciB2YWx1ZSAoaW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCKSB0aGlzIHdpbGwgcmV0dXJuIHRoZSBSZWQgY29tcG9uZW50LCBhcyBhIHZhbHVlIGJldHdlZW4gMCBhbmQgMjU1LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRSZWQKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgSW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgUmVkIGNvbXBvbmVudCBvZiB0aGUgY29sb3IsIHdpbGwgYmUgYmV0d2VlbiAwIGFuZCAyNTUgKDAgYmVpbmcgbm8gY29sb3IsIDI1NSBmdWxsIFJlZCkuCiAgICAqLwogICAgZ2V0UmVkOiBmdW5jdGlvbiAoY29sb3IpIHsKICAgICAgICByZXR1cm4gY29sb3IgPj4gMTYgJiAweEZGOwogICAgfSwKCiAgICAvKioKICAgICogR2l2ZW4gYSBuYXRpdmUgY29sb3IgdmFsdWUgKGluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQikgdGhpcyB3aWxsIHJldHVybiB0aGUgR3JlZW4gY29tcG9uZW50LCBhcyBhIHZhbHVlIGJldHdlZW4gMCBhbmQgMjU1LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRHcmVlbgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciAtIEluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQi4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIEdyZWVuIGNvbXBvbmVudCBvZiB0aGUgY29sb3IsIHdpbGwgYmUgYmV0d2VlbiAwIGFuZCAyNTUgKDAgYmVpbmcgbm8gY29sb3IsIDI1NSBmdWxsIEdyZWVuKS4KICAgICovCiAgICBnZXRHcmVlbjogZnVuY3Rpb24gKGNvbG9yKSB7CiAgICAgICAgcmV0dXJuIGNvbG9yID4+IDggJiAweEZGOwogICAgfSwKCiAgICAvKioKICAgICogR2l2ZW4gYSBuYXRpdmUgY29sb3IgdmFsdWUgKGluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQikgdGhpcyB3aWxsIHJldHVybiB0aGUgQmx1ZSBjb21wb25lbnQsIGFzIGEgdmFsdWUgYmV0d2VlbiAwIGFuZCAyNTUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldEJsdWUKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBJbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBCbHVlIGNvbXBvbmVudCBvZiB0aGUgY29sb3IsIHdpbGwgYmUgYmV0d2VlbiAwIGFuZCAyNTUgKDAgYmVpbmcgbm8gY29sb3IsIDI1NSBmdWxsIEJsdWUpLgogICAgKi8KICAgIGdldEJsdWU6IGZ1bmN0aW9uIChjb2xvcikgewogICAgICAgIHJldHVybiBjb2xvciAmIDB4RkY7CiAgICB9CiAgICAKfTsKCi8vIFZlcnNpb24gMC4yIC0gQ29weXJpZ2h0IDIwMTMgLSAgSmltIFJpZWNrZW4gPGppbXJAamltci5jYT4KLy8KLy8gUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlIC0gaHR0cHM6Ly9naXRodWIuY29tL2pyaWVja2VuL3NhdC1qcwovLwovLyBBIHNpbXBsZSBsaWJyYXJ5IGZvciBkZXRlcm1pbmluZyBpbnRlcnNlY3Rpb25zIG9mIGNpcmNsZXMgYW5kCi8vIHBvbHlnb25zIHVzaW5nIHRoZSBTZXBhcmF0aW5nIEF4aXMgVGhlb3JlbS4KLyoqIEBwcmVzZXJ2ZSBTQVQuanMgLSBWZXJzaW9uIDAuMiAtIENvcHlyaWdodCAyMDEzIC0gSmltIFJpZWNrZW4gPGppbXJAamltci5jYT4gLSByZWxlYXNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuIGh0dHBzOi8vZ2l0aHViLmNvbS9qcmllY2tlbi9zYXQtanMgKi8KCnZhciBTQVQgPSAoZnVuY3Rpb24gKCkgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIFNBVCA9IHt9OwoKICAvLwogIC8vICMjIFZlY3RvcgogIC8vCiAgLy8gUmVwcmVzZW50cyBhIHZlY3RvciBpbiB0d28gZGltZW5zaW9ucyB3aXRoIGB4YCBhbmQgYHlgIHByb3BlcnRpZXMuCgoKICAvLyBDcmVhdGUgYSBuZXcgVmVjdG9yLCBvcHRpb25hbGx5IHBhc3NpbmcgaW4gdGhlIGB4YCBhbmQgYHlgIGNvb3JkaW5hdGVzLiBJZgogIC8vIGEgY29vcmRpbmF0ZSBpcyBub3Qgc3BlY2lmaWVkLCBpdCB3aWxsIGJlIHNldCB0byBgMGAKICAvKioKICAgKiBAcGFyYW0gez9udW1iZXI9fSB4IFRoZSB4IHBvc2l0aW9uLgogICAqIEBwYXJhbSB7P251bWJlcj19IHkgVGhlIHkgcG9zaXRpb24uCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gVmVjdG9yKHgsIHkpIHsKICAgIHRoaXNbJ3gnXSA9IHggfHwgMDsKICAgIHRoaXNbJ3knXSA9IHkgfHwgMDsKICB9CiAgU0FUWydWZWN0b3InXSA9IFZlY3RvcjsKICAvLyBBbGlhcyBgVmVjdG9yYCBhcyBgVmAKICBTQVRbJ1YnXSA9IFZlY3RvcjsKCgogIC8vIENvcHkgdGhlIHZhbHVlcyBvZiBhbm90aGVyIFZlY3RvciBpbnRvIHRoaXMgb25lLgogIC8qKgogICAqIEBwYXJhbSB7VmVjdG9yfSBvdGhlciBUaGUgb3RoZXIgVmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3Rvcn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsnY29weSddID0gVmVjdG9yLnByb3RvdHlwZS5jb3B5ID0gZnVuY3Rpb24ob3RoZXIpIHsKICAgIHRoaXNbJ3gnXSA9IG90aGVyWyd4J107CiAgICB0aGlzWyd5J10gPSBvdGhlclsneSddOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gQ2hhbmdlIHRoaXMgdmVjdG9yIHRvIGJlIHBlcnBlbmRpY3VsYXIgdG8gd2hhdCBpdCB3YXMgYmVmb3JlLiAoRWZmZWN0aXZlbHkKICAvLyByb2F0YXRlcyBpdCA5MCBkZWdyZWVzIGluIGEgY2xvY2t3aXNlIGRpcmVjdGlvbikKICAvKioKICAgKiBAcmV0dXJuIHtWZWN0b3J9IFRoaXMgZm9yIGNoYWluaW5nLgogICAqLwogIFZlY3Rvci5wcm90b3R5cGVbJ3BlcnAnXSA9IFZlY3Rvci5wcm90b3R5cGUucGVycCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHggPSB0aGlzWyd4J107CiAgICB0aGlzWyd4J10gPSB0aGlzWyd5J107CiAgICB0aGlzWyd5J10gPSAteDsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFJvdGF0ZSB0aGlzIHZlY3RvciAoY291bnRlci1jbG9ja3dpc2UpIGJ5IHRoZSBzcGVjaWZpZWQgYW5nbGUgKGluIHJhZGlhbnMpLgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSBUaGUgYW5nbGUgdG8gcm90YXRlIChpbiByYWRpYW5zKQogICAqIEByZXR1cm4ge1ZlY3Rvcn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsncm90YXRlJ10gPSBWZWN0b3IucHJvdG90eXBlLnJvdGF0ZSA9IGZ1bmN0aW9uIChhbmdsZSkgewogICAgdmFyIHggPSB0aGlzWyd4J107CiAgICB2YXIgeSA9IHRoaXNbJ3knXTsKICAgIHRoaXNbJ3gnXSA9IHggKiBNYXRoLmNvcyhhbmdsZSkgLSB5ICogTWF0aC5zaW4oYW5nbGUpOwogICAgdGhpc1sneSddID0geCAqIE1hdGguc2luKGFuZ2xlKSArIHkgKiBNYXRoLmNvcyhhbmdsZSk7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBSb3RhdGUgdGhpcyB2ZWN0b3IgKGNvdW50ZXItY2xvY2t3aXNlKSBieSB0aGUgc3BlY2lmaWVkIGFuZ2xlIChpbiByYWRpYW5zKSB3aGljaCBoYXMgYWxyZWFkeSBiZWVuIGNhbGN1bGF0ZWQgaW50byBzaW4gYW5kIGNvcy4KICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gc2luIC0gVGhlIE1hdGguc2luKGFuZ2xlKQogICAqIEBwYXJhbSB7bnVtYmVyfSBjb3MgLSBUaGUgTWF0aC5jb3MoYW5nbGUpCiAgICogQHJldHVybiB7VmVjdG9yfSBUaGlzIGZvciBjaGFpbmluZy4KICAgKi8KICBWZWN0b3IucHJvdG90eXBlWydyb3RhdGVQcmVjYWxjJ10gPSBWZWN0b3IucHJvdG90eXBlLnJvdGF0ZVByZWNhbGMgPSBmdW5jdGlvbiAoc2luLCBjb3MpIHsKICAgIHZhciB4ID0gdGhpc1sneCddOwogICAgdmFyIHkgPSB0aGlzWyd5J107CiAgICB0aGlzWyd4J10gPSB4ICogY29zIC0geSAqIHNpbjsKICAgIHRoaXNbJ3knXSA9IHggKiBzaW4gKyB5ICogY29zOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gUmV2ZXJzZSB0aGlzIHZlY3Rvci4KICAvKioKICAgKiBAcmV0dXJuIHtWZWN0b3J9IFRoaXMgZm9yIGNoYWluaW5nLgogICAqLwogIFZlY3Rvci5wcm90b3R5cGVbJ3JldmVyc2UnXSA9IFZlY3Rvci5wcm90b3R5cGUucmV2ZXJzZSA9IGZ1bmN0aW9uKCkgewogICAgdGhpc1sneCddID0gLXRoaXNbJ3gnXTsKICAgIHRoaXNbJ3knXSA9IC10aGlzWyd5J107CiAgICByZXR1cm4gdGhpczsKICB9OwoKCiAgLy8gTm9ybWFsaXplIHRoaXMgdmVjdG9yLiAgKG1ha2UgaXQgaGF2ZSBsZW5ndGggb2YgYDFgKQogIC8qKgogICAqIEByZXR1cm4ge1ZlY3Rvcn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsnbm9ybWFsaXplJ10gPSBWZWN0b3IucHJvdG90eXBlLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGQgPSB0aGlzLmxlbigpOwogICAgaWYoZCA+IDApIHsKICAgICAgdGhpc1sneCddID0gdGhpc1sneCddIC8gZDsKICAgICAgdGhpc1sneSddID0gdGhpc1sneSddIC8gZDsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIEFkZCBhbm90aGVyIHZlY3RvciB0byB0aGlzIG9uZS4KICAvKioKICAgKiBAcGFyYW0ge1ZlY3Rvcn0gb3RoZXIgVGhlIG90aGVyIFZlY3Rvci4KICAgKiBAcmV0dXJuIHtWZWN0b3J9IFRoaXMgZm9yIGNoYWluaW5nLgogICAqLwogIFZlY3Rvci5wcm90b3R5cGVbJ2FkZCddID0gVmVjdG9yLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbihvdGhlcikgewogICAgdGhpc1sneCddICs9IG90aGVyWyd4J107CiAgICB0aGlzWyd5J10gKz0gb3RoZXJbJ3knXTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFN1YnRyYWN0IGFub3RoZXIgdmVjdG9yIGZyb20gdGhpcyBvbmUuCiAgLyoqCiAgICogQHBhcmFtIHtWZWN0b3J9IG90aGVyIFRoZSBvdGhlciBWZWN0b3IuCiAgICogQHJldHVybiB7VmVjdG9yfSBUaGlzIGZvciBjaGFpaW5nLgogICAqLwogIFZlY3Rvci5wcm90b3R5cGVbJ3N1YiddID0gVmVjdG9yLnByb3RvdHlwZS5zdWIgPSBmdW5jdGlvbihvdGhlcikgewogICAgdGhpc1sneCddIC09IG90aGVyWyd4J107CiAgICB0aGlzWyd5J10gLT0gb3RoZXJbJ3knXTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFNjYWxlIHRoaXMgdmVjdG9yLiBBbiBpbmRlcGVuZGFudCBzY2FsaW5nIGZhY3RvciBjYW4gYmUgcHJvdmlkZWQKICAvLyBmb3IgZWFjaCBheGlzLCBvciBhIHNpbmdsZSBzY2FsaW5nIGZhY3RvciB0aGF0IHdpbGwgc2NhbGUgYm90aCBgeGAgYW5kIGB5YC4KICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0geCBUaGUgc2NhbGluZyBmYWN0b3IgaW4gdGhlIHggZGlyZWN0aW9uLgogICAqIEBwYXJhbSB7P251bWJlcj19IHkgVGhlIHNjYWxpbmcgZmFjdG9yIGluIHRoZSB5IGRpcmVjdGlvbi4gIElmIHRoaXMKICAgKiAgIGlzIG5vdCBzcGVjaWZpZWQsIHRoZSB4IHNjYWxpbmcgZmFjdG9yIHdpbGwgYmUgdXNlZC4KICAgKiBAcmV0dXJuIHtWZWN0b3J9IFRoaXMgZm9yIGNoYWluaW5nLgogICAqLwogIFZlY3Rvci5wcm90b3R5cGVbJ3NjYWxlJ10gPSBWZWN0b3IucHJvdG90eXBlLnNjYWxlID0gZnVuY3Rpb24oeCx5KSB7CiAgICB0aGlzWyd4J10gKj0geDsKICAgIHRoaXNbJ3knXSAqPSB5IHx8IHg7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBQcm9qZWN0IHRoaXMgdmVjdG9yIG9uIHRvIGFub3RoZXIgdmVjdG9yLgogIC8qKgogICAqIEBwYXJhbSB7VmVjdG9yfSBvdGhlciBUaGUgdmVjdG9yIHRvIHByb2plY3Qgb250by4KICAgKiBAcmV0dXJuIHtWZWN0b3J9IFRoaXMgZm9yIGNoYWluaW5nLgogICAqLwogIFZlY3Rvci5wcm90b3R5cGVbJ3Byb2plY3QnXSA9IFZlY3Rvci5wcm90b3R5cGUucHJvamVjdCA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICB2YXIgYW10ID0gdGhpcy5kb3Qob3RoZXIpIC8gb3RoZXIubGVuMigpOwogICAgdGhpc1sneCddID0gYW10ICogb3RoZXJbJ3gnXTsKICAgIHRoaXNbJ3knXSA9IGFtdCAqIG90aGVyWyd5J107CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBQcm9qZWN0IHRoaXMgdmVjdG9yIG9udG8gYSB2ZWN0b3Igb2YgdW5pdCBsZW5ndGguIFRoaXMgaXMgc2xpZ2h0bHkgbW9yZSBlZmZpY2llbnQKICAvLyB0aGFuIGBwcm9qZWN0YCB3aGVuIGRlYWxpbmcgd2l0aCB1bml0IHZlY3RvcnMuCiAgLyoqCiAgICogQHBhcmFtIHtWZWN0b3J9IG90aGVyIFRoZSB1bml0IHZlY3RvciB0byBwcm9qZWN0IG9udG8uCiAgICogQHJldHVybiB7VmVjdG9yfSBUaGlzIGZvciBjaGFpbmluZy4KICAgKi8KICBWZWN0b3IucHJvdG90eXBlWydwcm9qZWN0TiddID0gVmVjdG9yLnByb3RvdHlwZS5wcm9qZWN0TiA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICB2YXIgYW10ID0gdGhpcy5kb3Qob3RoZXIpOwogICAgdGhpc1sneCddID0gYW10ICogb3RoZXJbJ3gnXTsKICAgIHRoaXNbJ3knXSA9IGFtdCAqIG90aGVyWyd5J107CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBSZWZsZWN0IHRoaXMgdmVjdG9yIG9uIGFuIGFyYml0cmFyeSBheGlzLgogIC8qKgogICAqIEBwYXJhbSB7VmVjdG9yfSBheGlzIFRoZSB2ZWN0b3IgcmVwcmVzZW50aW5nIHRoZSBheGlzLgogICAqIEByZXR1cm4ge1ZlY3Rvcn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsncmVmbGVjdCddID0gVmVjdG9yLnByb3RvdHlwZS5yZWZsZWN0ID0gZnVuY3Rpb24oYXhpcykgewogICAgdmFyIHggPSB0aGlzWyd4J107CiAgICB2YXIgeSA9IHRoaXNbJ3knXTsKICAgIHRoaXMucHJvamVjdChheGlzKS5zY2FsZSgyKTsKICAgIHRoaXNbJ3gnXSAtPSB4OwogICAgdGhpc1sneSddIC09IHk7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBSZWZsZWN0IHRoaXMgdmVjdG9yIG9uIGFuIGFyYml0cmFyeSBheGlzIChyZXByZXNlbnRlZCBieSBhIHVuaXQgdmVjdG9yKS4gVGhpcyBpcwogIC8vIHNsaWdodGx5IG1vcmUgZWZmaWNpZW50IHRoYW4gYHJlZmxlY3RgIHdoZW4gZGVhbGluZyB3aXRoIGFuIGF4aXMgdGhhdCBpcyBhIHVuaXQgdmVjdG9yLgogIC8qKgogICAqIEBwYXJhbSB7VmVjdG9yfSBheGlzIFRoZSB1bml0IHZlY3RvciByZXByZXNlbnRpbmcgdGhlIGF4aXMuCiAgICogQHJldHVybiB7VmVjdG9yfSBUaGlzIGZvciBjaGFpbmluZy4KICAgKi8KICBWZWN0b3IucHJvdG90eXBlWydyZWZsZWN0TiddID0gVmVjdG9yLnByb3RvdHlwZS5yZWZsZWN0TiA9IGZ1bmN0aW9uKGF4aXMpIHsKICAgIHZhciB4ID0gdGhpc1sneCddOwogICAgdmFyIHkgPSB0aGlzWyd5J107CiAgICB0aGlzLnByb2plY3ROKGF4aXMpLnNjYWxlKDIpOwogICAgdGhpc1sneCddIC09IHg7CiAgICB0aGlzWyd5J10gLT0geTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIEdldCB0aGUgZG90IHByb2R1Y3Qgb2YgdGhpcyB2ZWN0b3IgYW5kIGFub3RoZXIuCiAgLyoqCiAgICogQHBhcmFtIHtWZWN0b3J9ICBvdGhlciBUaGUgdmVjdG9yIHRvIGRvdCB0aGlzIG9uZSBhZ2FpbnN0LgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRvdCBwcm9kdWN0LgogICAqLwogIFZlY3Rvci5wcm90b3R5cGVbJ2RvdCddID0gVmVjdG9yLnByb3RvdHlwZS5kb3QgPSBmdW5jdGlvbihvdGhlcikgewogICAgcmV0dXJuIHRoaXNbJ3gnXSAqIG90aGVyWyd4J10gKyB0aGlzWyd5J10gKiBvdGhlclsneSddOwogIH07CgogIC8vIEdldCB0aGUgc3F1YXJlZCBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgLyoqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbGVuZ3RoXjIgb2YgdGhpcyB2ZWN0b3IuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsnbGVuMiddID0gVmVjdG9yLnByb3RvdHlwZS5sZW4yID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5kb3QodGhpcyk7CiAgfTsKCiAgLy8gR2V0IHRoZSBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgLyoqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbGVuZ3RoIG9mIHRoaXMgdmVjdG9yLgogICAqLwogIFZlY3Rvci5wcm90b3R5cGVbJ2xlbiddID0gVmVjdG9yLnByb3RvdHlwZS5sZW4gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBNYXRoLnNxcnQodGhpcy5sZW4yKCkpOwogIH07CgogIC8vICMjIENpcmNsZQogIC8vCiAgLy8gUmVwcmVzZW50cyBhIGNpcmNsZSB3aXRoIGEgcG9zaXRpb24gYW5kIGEgcmFkaXVzLgoKICAvLyBDcmVhdGUgYSBuZXcgY2lyY2xlLCBvcHRpb25hbGx5IHBhc3NpbmcgaW4gYSBwb3NpdGlvbiBhbmQvb3IgcmFkaXVzLiBJZiBubyBwb3NpdGlvbgogIC8vIGlzIGdpdmVuLCB0aGUgY2lyY2xlIHdpbGwgYmUgYXQgYCgwLDApYC4gSWYgbm8gcmFkaXVzIGlzIHByb3ZpZGVkLCB0aGUgY2lyY2xlIHdpbGwKICAvLyBoYXZlIGEgcmFkaXVzIG9mIGAwYC4KICAvKioKICAgKiBAcGFyYW0ge1ZlY3Rvcj19IHBvcyBBIHZlY3RvciByZXByZXNlbnRpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZQogICAqIEBwYXJhbSB7P251bWJlcj19IHIgVGhlIHJhZGl1cyBvZiB0aGUgY2lyY2xlCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gQ2lyY2xlKHBvcywgcikgewogICAgdGhpc1sncG9zJ10gPSBwb3MgfHwgbmV3IFZlY3RvcigpOwogICAgdGhpc1snciddID0gciB8fCAwOwogIH0KICBTQVRbJ0NpcmNsZSddID0gQ2lyY2xlOwoKICAvLyAjIyBQb2x5Z29uCiAgLy8KICAvLyBSZXByZXNlbnRzIGEgKmNvbnZleCogcG9seWdvbiB3aXRoIGFueSBudW1iZXIgb2YgcG9pbnRzIChzcGVjaWZpZWQgaW4gY291bnRlci1jbG9ja3dpc2Ugb3JkZXIpCiAgLy8KICAvLyBUaGUgZWRnZXMvbm9ybWFscyBvZiB0aGUgcG9seWdvbiB3aWxsIGJlIGNhbGN1bGF0ZWQgb24gY3JlYXRpb24gYW5kIHN0b3JlZCBpbiB0aGUKICAvLyBgZWRnZXNgIGFuZCBgbm9ybWFsc2AgcHJvcGVydGllcy4gSWYgeW91IGNoYW5nZSB0aGUgcG9seWdvbidzIHBvaW50cywgeW91IHdpbGwgbmVlZAogIC8vIHRvIGNhbGwgYHJlY2FsY2AgdG8gcmVjYWxjdWxhdGUgdGhlIGVkZ2VzL25vcm1hbHMuCgogIC8vIENyZWF0ZSBhIG5ldyBwb2x5Z29uLCBwYXNzaW5nIGluIGEgcG9zaXRpb24gdmVjdG9yLCBhbmQgYW4gYXJyYXkgb2YgcG9pbnRzIChyZXByZXNlbnRlZAogIC8vIGJ5IHZlY3RvcnMgcmVsYXRpdmUgdG8gdGhlIHBvc2l0aW9uIHZlY3RvcikuIElmIG5vIHBvc2l0aW9uIGlzIHBhc3NlZCBpbiwgdGhlIHBvc2l0aW9uCiAgLy8gb2YgdGhlIHBvbHlnb24gd2lsbCBiZSBgKDAsMClgLgogIC8qKgogICAqIEBwYXJhbSB7VmVjdG9yPX0gcG9zIEEgdmVjdG9yIHJlcHJlc2VudGluZyB0aGUgb3JpZ2luIG9mIHRoZSBwb2x5Z29uLiAoYWxsIG90aGVyCiAgICogICBwb2ludHMgYXJlIHJlbGF0aXZlIHRvIHRoaXMgb25lKQogICAqIEBwYXJhbSB7QXJyYXkuPFZlY3Rvcj49fSBwb2ludHMgQW4gYXJyYXkgb2YgdmVjdG9ycyByZXByZXNlbnRpbmcgdGhlIHBvaW50cyBpbiB0aGUgcG9seWdvbiwKICAgKiAgIGluIGNvdW50ZXItY2xvY2t3aXNlIG9yZGVyLgogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIFBvbHlnb24ocG9zLCBwb2ludHMpIHsKICAgIHRoaXNbJ3BvcyddID0gcG9zIHx8IG5ldyBWZWN0b3IoKTsKICAgIHRoaXNbJ3BvaW50cyddID0gcG9pbnRzIHx8IFtdOwogICAgdGhpcy5yZWNhbGMoKTsKICB9CiAgU0FUWydQb2x5Z29uJ10gPSBQb2x5Z29uOwoKICAvLyBSZWNhbGN1bGF0ZXMgdGhlIGVkZ2VzIGFuZCBub3JtYWxzIG9mIHRoZSBwb2x5Z29uLiBUaGlzICoqbXVzdCoqIGJlIGNhbGxlZAogIC8vIGlmIHRoZSBgcG9pbnRzYCBhcnJheSBpcyBtb2RpZmllZCBhdCBhbGwgYW5kIHRoZSBlZGdlcyBvciBub3JtYWxzIGFyZSB0byBiZQogIC8vIGFjY2Vzc2VkLgogIC8qKgogICAqIEByZXR1cm4ge1BvbHlnb259IFRoaXMgZm9yIGNoYWluaW5nLgogICAqLwogIFBvbHlnb24ucHJvdG90eXBlWydyZWNhbGMnXSA9IFBvbHlnb24ucHJvdG90eXBlLnJlY2FsYyA9IGZ1bmN0aW9uKCkgewogICAgLy8gVGhlIGVkZ2VzIGhlcmUgYXJlIHRoZSBkaXJlY3Rpb24gb2YgdGhlIGBuYHRoIGVkZ2Ugb2YgdGhlIHBvbHlnb24sIHJlbGF0aXZlIHRvCiAgICAvLyB0aGUgYG5gdGggcG9pbnQuIElmIHlvdSB3YW50IHRvIGRyYXcgYSBnaXZlbiBlZGdlIGZyb20gdGhlIGVkZ2UgdmFsdWUsIHlvdSBtdXN0CiAgICAvLyBmaXJzdCB0cmFuc2xhdGUgdG8gdGhlIHBvc2l0aW9uIG9mIHRoZSBzdGFydGluZyBwb2ludC4KICAgIHRoaXNbJ2VkZ2VzJ10gPSBbXTsKICAgIC8vIFRoZSBub3JtYWxzIGhlcmUgYXJlIHRoZSBkaXJlY3Rpb24gb2YgdGhlIG5vcm1hbCBmb3IgdGhlIGBuYHRoIGVkZ2Ugb2YgdGhlIHBvbHlnb24sIHJlbGF0aXZlCiAgICAvLyB0byB0aGUgcG9zaXRpb24gb2YgdGhlIGBuYHRoIHBvaW50LiBJZiB5b3Ugd2FudCB0byBkcmF3IGFuIGVkZ2Ugbm9ybWFsLCB5b3UgbXVzdCBmaXJzdAogICAgLy8gdHJhbnNsYXRlIHRvIHRoZSBwb3NpdGlvbiBvZiB0aGUgc3RhcnRpbmcgcG9pbnQuCiAgICB0aGlzWydub3JtYWxzJ10gPSBbXTsKICAgIHZhciBwb2ludHMgPSB0aGlzWydwb2ludHMnXTsKICAgIHZhciBsZW4gPSBwb2ludHMubGVuZ3RoOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICB2YXIgcDEgPSBwb2ludHNbaV07CiAgICAgIHZhciBwMiA9IGkgPCBsZW4gLSAxID8gcG9pbnRzW2kgKyAxXSA6IHBvaW50c1swXTsKICAgICAgdmFyIGUgPSBuZXcgVmVjdG9yKCkuY29weShwMikuc3ViKHAxKTsKICAgICAgdmFyIG4gPSBuZXcgVmVjdG9yKCkuY29weShlKS5wZXJwKCkubm9ybWFsaXplKCk7CiAgICAgIHRoaXNbJ2VkZ2VzJ10ucHVzaChlKTsKICAgICAgdGhpc1snbm9ybWFscyddLnB1c2gobik7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBSb3RhdGVzIHRoaXMgcG9seWdvbiBjb3VudGVyLWNsb2Nrd2lzZSBhcm91bmQgdGhlIG9yaWdpbiBvZiAqaXRzIGxvY2FsIGNvb3JkaW5hdGUgc3lzdGVtKiAoaS5lLiBgcG9zYCkuCiAgLy8KICAvLyBOb3RlOiBZb3UgZG8gKipub3QqKiBuZWVkIHRvIGNhbGwgYHJlY2FsY2AgYWZ0ZXIgcm90YXRpb24uCiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIFRoZSBhbmdsZSB0byByb3RhdGUgKGluIHJhZGlhbnMpCiAgICogQHJldHVybiB7UG9seWdvbn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgUG9seWdvbi5wcm90b3R5cGVbJ3JvdGF0ZSddID0gUG9seWdvbi5wcm90b3R5cGUucm90YXRlID0gZnVuY3Rpb24oYW5nbGUpIHsKICAgIHZhciBpOwogICAgdmFyIHBvaW50cyA9IHRoaXNbJ3BvaW50cyddOwogICAgdmFyIGVkZ2VzID0gdGhpc1snZWRnZXMnXTsKICAgIHZhciBub3JtYWxzID0gdGhpc1snbm9ybWFscyddOwogICAgdmFyIGxlbiA9IHBvaW50cy5sZW5ndGg7CgogICAgLy8gIENhbGMgaXQganVzdCB0aGUgb25jZSwgcmF0aGVyIHRoYW4gNCB0aW1lcyBwZXIgYXJyYXkgZWxlbWVudAogICAgdmFyIGNvcyA9IE1hdGguY29zKGFuZ2xlKTsKICAgIHZhciBzaW4gPSBNYXRoLnNpbihhbmdsZSk7CgogICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHBvaW50c1tpXS5yb3RhdGVQcmVjYWxjKHNpbiwgY29zKTsKICAgICAgZWRnZXNbaV0ucm90YXRlUHJlY2FsYyhzaW4sIGNvcyk7CiAgICAgIG5vcm1hbHNbaV0ucm90YXRlUHJlY2FsYyhzaW4sIGNvcyk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBSb3RhdGVzIHRoaXMgcG9seWdvbiBjb3VudGVyLWNsb2Nrd2lzZSBhcm91bmQgdGhlIG9yaWdpbiBvZiAqaXRzIGxvY2FsIGNvb3JkaW5hdGUgc3lzdGVtKiAoaS5lLiBgcG9zYCkuCiAgLy8KICAvLyBOb3RlOiBZb3UgZG8gKipub3QqKiBuZWVkIHRvIGNhbGwgYHJlY2FsY2AgYWZ0ZXIgcm90YXRpb24uCiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIFRoZSBhbmdsZSB0byByb3RhdGUgKGluIHJhZGlhbnMpCiAgICogQHJldHVybiB7UG9seWdvbn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgUG9seWdvbi5wcm90b3R5cGVbJ3NjYWxlJ10gPSBQb2x5Z29uLnByb3RvdHlwZS5zY2FsZSA9IGZ1bmN0aW9uKHgsIHkpIHsKICAgIHZhciBpOwogICAgdmFyIHBvaW50cyA9IHRoaXNbJ3BvaW50cyddOwogICAgdmFyIGVkZ2VzID0gdGhpc1snZWRnZXMnXTsKICAgIHZhciBub3JtYWxzID0gdGhpc1snbm9ybWFscyddOwogICAgdmFyIGxlbiA9IHBvaW50cy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgcG9pbnRzW2ldLnNjYWxlKHgseSk7CiAgICAgIGVkZ2VzW2ldLnNjYWxlKHgseSk7CiAgICAgIG5vcm1hbHNbaV0uc2NhbGUoeCx5KTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFRyYW5zbGF0ZXMgdGhlIHBvaW50cyBvZiB0aGlzIHBvbHlnb24gYnkgYSBzcGVjaWZpZWQgYW1vdW50IHJlbGF0aXZlIHRvIHRoZSBvcmlnaW4gb2YgKml0cyBvd24gY29vcmRpbmF0ZQogIC8vIHN5c3RlbSogKGkuZS4gYHBvc2ApLgogIC8vCiAgLy8gVGhpcyBpcyBtb3N0IHVzZWZ1bCB0byBjaGFuZ2UgdGhlICJjZW50ZXIgcG9pbnQiIG9mIGEgcG9seWdvbi4KICAvLwogIC8vIE5vdGU6IFlvdSBkbyAqKm5vdCoqIG5lZWQgdG8gY2FsbCBgcmVjYWxjYCBhZnRlciB0cmFuc2xhdGlvbi4KICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0geCBUaGUgaG9yaXpvbnRhbCBhbW91bnQgdG8gdHJhbnNsYXRlLgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IFRoZSB2ZXJ0aWNhbCBhbW91bnQgdG8gdHJhbnNsYXRlLgogICAqIEByZXR1cm4ge1BvbHlnb259IFRoaXMgZm9yIGNoYWluaW5nLgogICAqLwogIFBvbHlnb24ucHJvdG90eXBlWyd0cmFuc2xhdGUnXSA9IFBvbHlnb24ucHJvdG90eXBlLnRyYW5zbGF0ZSA9IGZ1bmN0aW9uICh4LCB5KSB7CiAgICB2YXIgaTsKICAgIHZhciBwb2ludHMgPSB0aGlzWydwb2ludHMnXTsKICAgIHZhciBsZW4gPSBwb2ludHMubGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHBvaW50c1tpXS54ICs9IHg7CiAgICAgIHBvaW50c1tpXS55ICs9IHk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyAjIyBCb3gKICAvLwogIC8vIFJlcHJlc2VudHMgYW4gYXhpcy1hbGlnbmVkIGJveCwgd2l0aCBhIHdpZHRoIGFuZCBoZWlnaHQuCgoKICAvLyBDcmVhdGUgYSBuZXcgYm94LCB3aXRoIHRoZSBzcGVjaWZpZWQgcG9zaXRpb24sIHdpZHRoLCBhbmQgaGVpZ2h0LiBJZiBubyBwb3NpdGlvbgogIC8vIGlzIGdpdmVuLCB0aGUgcG9zaXRpb24gd2lsbCBiZSBgKDAsMClgLiBJZiBubyB3aWR0aCBvciBoZWlnaHQgYXJlIGdpdmVuLCB0aGV5IHdpbGwKICAvLyBiZSBzZXQgdG8gYDBgLgogIC8qKgogICAqIEBwYXJhbSB7VmVjdG9yPX0gcG9zIEEgdmVjdG9yIHJlcHJlc2VudGluZyB0aGUgdG9wLWxlZnQgb2YgdGhlIGJveC4KICAgKiBAcGFyYW0gez9udW1iZXI9fSB3IFRoZSB3aWR0aCBvZiB0aGUgYm94LgogICAqIEBwYXJhbSB7P251bWJlcj19IGggVGhlIGhlaWdodCBvZiB0aGUgYm94LgogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIEJveChwb3MsIHcsIGgpIHsKICAgIHRoaXNbJ3BvcyddID0gcG9zIHx8IG5ldyBWZWN0b3IoKTsKICAgIHRoaXNbJ3cnXSA9IHcgfHwgMDsKICAgIHRoaXNbJ2gnXSA9IGggfHwgMDsKICB9CiAgU0FUWydCb3gnXSA9IEJveDsKCiAgLy8gUmV0dXJucyBhIHBvbHlnb24gd2hvc2UgZWRnZXMgYXJlIHRoZSBzYW1lIGFzIHRoaXMgYm94LgogIC8qKgogICAqIEByZXR1cm4ge1BvbHlnb259IEEgbmV3IFBvbHlnb24gdGhhdCByZXByZXNlbnRzIHRoaXMgYm94LgogICAqLwogIEJveC5wcm90b3R5cGVbJ3RvUG9seWdvbiddID0gQm94LnByb3RvdHlwZS50b1BvbHlnb24gPSBmdW5jdGlvbigpIHsKICAgIHZhciBwb3MgPSB0aGlzWydwb3MnXTsKICAgIHZhciB3ID0gdGhpc1sndyddOwogICAgdmFyIGggPSB0aGlzWydoJ107CiAgICByZXR1cm4gbmV3IFBvbHlnb24obmV3IFZlY3Rvcihwb3NbJ3gnXSwgcG9zWyd5J10pLCBbCiAgICAgbmV3IFZlY3RvcigpLCBuZXcgVmVjdG9yKHcsIDApLAogICAgIG5ldyBWZWN0b3IodyxoKSwgbmV3IFZlY3RvcigwLGgpCiAgICBdKTsKICB9OwoKICAvLyAjIyBSZXNwb25zZQogIC8vCiAgLy8gQW4gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcmVzdWx0IG9mIGFuIGludGVyc2VjdGlvbi4gQ29udGFpbnM6CiAgLy8gIC0gVGhlIHR3byBvYmplY3RzIHBhcnRpY2lwYXRpbmcgaW4gdGhlIGludGVyc2VjdGlvbgogIC8vICAtIFRoZSB2ZWN0b3IgcmVwcmVzZW50aW5nIHRoZSBtaW5pbXVtIGNoYW5nZSBuZWNlc3NhcnkgdG8gZXh0cmFjdCB0aGUgZmlyc3Qgb2JqZWN0CiAgLy8gICAgZnJvbSB0aGUgc2Vjb25kIG9uZSAoYXMgd2VsbCBhcyBhIHVuaXQgdmVjdG9yIGluIHRoYXQgZGlyZWN0aW9uIGFuZCB0aGUgbWFnbml0dWRlCiAgLy8gICAgb2YgdGhlIG92ZXJsYXApCiAgLy8gIC0gV2hldGhlciB0aGUgZmlyc3Qgb2JqZWN0IGlzIGVudGlyZWx5IGluc2lkZSB0aGUgc2Vjb25kLCBhbmQgdmljZSB2ZXJzYS4KICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBSZXNwb25zZSgpIHsKICAgIHRoaXNbJ2EnXSA9IG51bGw7CiAgICB0aGlzWydiJ10gPSBudWxsOwogICAgdGhpc1snb3ZlcmxhcE4nXSA9IG5ldyBWZWN0b3IoKTsKICAgIHRoaXNbJ292ZXJsYXBWJ10gPSBuZXcgVmVjdG9yKCk7CiAgICB0aGlzLmNsZWFyKCk7CiAgfQogIFNBVFsnUmVzcG9uc2UnXSA9IFJlc3BvbnNlOwoKICAvLyBTZXQgc29tZSB2YWx1ZXMgb2YgdGhlIHJlc3BvbnNlIGJhY2sgdG8gdGhlaXIgZGVmYXVsdHMuICBDYWxsIHRoaXMgYmV0d2VlbiB0ZXN0cyBpZgogIC8vIHlvdSBhcmUgZ29pbmcgdG8gcmV1c2UgYSBzaW5nbGUgUmVzcG9uc2Ugb2JqZWN0IGZvciBtdWx0aXBsZSBpbnRlcnNlY3Rpb24gdGVzdHMgKHJlY29tbWVudGVkCiAgLy8gYXMgaXQgd2lsbCBhdm9pZCBhbGxjYXRpbmcgZXh0cmEgbWVtb3J5KQogIC8qKgogICAqIEByZXR1cm4ge1Jlc3BvbnNlfSBUaGlzIGZvciBjaGFpbmluZwogICAqLwogIFJlc3BvbnNlLnByb3RvdHlwZVsnY2xlYXInXSA9IFJlc3BvbnNlLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKCkgewogICAgdGhpc1snYUluQiddID0gdHJ1ZTsKICAgIHRoaXNbJ2JJbkEnXSA9IHRydWU7CiAgICB0aGlzWydvdmVybGFwJ10gPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gIyMgT2JqZWN0IFBvb2xzCgogIC8vIEEgcG9vbCBvZiBgVmVjdG9yYCBvYmplY3RzIHRoYXQgYXJlIHVzZWQgaW4gY2FsY3VsYXRpb25zIHRvIGF2b2lkCiAgLy8gYWxsb2NhdGluZyBtZW1vcnkuCiAgLyoqCiAgICogQHR5cGUge0FycmF5LjxWZWN0b3I+fQogICAqLwogIHZhciBUX1ZFQ1RPUlMgPSBbXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IDEwOyBpKyspIHsgVF9WRUNUT1JTLnB1c2gobmV3IFZlY3RvcigpKTsgfQoKICAvLyBBIHBvb2wgb2YgYXJyYXlzIG9mIG51bWJlcnMgdXNlZCBpbiBjYWxjdWxhdGlvbnMgdG8gYXZvaWQgYWxsb2NhdGluZwogIC8vIG1lbW9yeS4KICAvKioKICAgKiBAdHlwZSB7QXJyYXkuPEFycmF5LjxudW1iZXI+Pn0KICAgKi8KICB2YXIgVF9BUlJBWVMgPSBbXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IDU7IGkrKykgeyBUX0FSUkFZUy5wdXNoKFtdKTsgfQoKICAvLyAjIyBIZWxwZXIgRnVuY3Rpb25zCgogIC8vIEZsYXR0ZW5zIHRoZSBzcGVjaWZpZWQgYXJyYXkgb2YgcG9pbnRzIG9udG8gYSB1bml0IHZlY3RvciBheGlzLAogIC8vIHJlc3VsdGluZyBpbiBhIG9uZSBkaW1lbnNpb25hbCByYW5nZSBvZiB0aGUgbWluaW11bSBhbmQKICAvLyBtYXhpbXVtIHZhbHVlIG9uIHRoYXQgYXhpcy4KICAvKioKICAgKiBAcGFyYW0ge0FycmF5LjxWZWN0b3I+fSBwb2ludHMgVGhlIHBvaW50cyB0byBmbGF0dGVuLgogICAqIEBwYXJhbSB7VmVjdG9yfSBub3JtYWwgVGhlIHVuaXQgdmVjdG9yIGF4aXMgdG8gZmxhdHRlbiBvbi4KICAgKiBAcGFyYW0ge0FycmF5LjxudW1iZXI+fSByZXN1bHQgQW4gYXJyYXkuICBBZnRlciBjYWxsaW5nIHRoaXMgZnVuY3Rpb24sCiAgICogICByZXN1bHRbMF0gd2lsbCBiZSB0aGUgbWluaW11bSB2YWx1ZSwKICAgKiAgIHJlc3VsdFsxXSB3aWxsIGJlIHRoZSBtYXhpbXVtIHZhbHVlLgogICAqLwogIGZ1bmN0aW9uIGZsYXR0ZW5Qb2ludHNPbihwb2ludHMsIG5vcm1hbCwgcmVzdWx0KSB7CiAgICB2YXIgbWluID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgIHZhciBtYXggPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgIHZhciBsZW4gPSBwb2ludHMubGVuZ3RoOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKICAgICAgLy8gVGhlIG1hZ25pdHVkZSBvZiB0aGUgcHJvamVjdGlvbiBvZiB0aGUgcG9pbnQgb250byB0aGUgbm9ybWFsCiAgICAgIHZhciBkb3QgPSBwb2ludHNbaV0uZG90KG5vcm1hbCk7CiAgICAgIGlmIChkb3QgPCBtaW4pIHsgbWluID0gZG90OyB9CiAgICAgIGlmIChkb3QgPiBtYXgpIHsgbWF4ID0gZG90OyB9CiAgICB9CiAgICByZXN1bHRbMF0gPSBtaW47IHJlc3VsdFsxXSA9IG1heDsKICB9CgogIC8vIENoZWNrIHdoZXRoZXIgdHdvIGNvbnZleCBwb2x5Z29ucyBhcmUgc2VwYXJhdGVkIGJ5IHRoZSBzcGVjaWZpZWQKICAvLyBheGlzIChtdXN0IGJlIGEgdW5pdCB2ZWN0b3IpLgogIC8qKgogICAqIEBwYXJhbSB7VmVjdG9yfSBhUG9zIFRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgcG9seWdvbi4KICAgKiBAcGFyYW0ge1ZlY3Rvcn0gYlBvcyBUaGUgcG9zaXRpb24gb2YgdGhlIHNlY29uZCBwb2x5Z29uLgogICAqIEBwYXJhbSB7QXJyYXkuPFZlY3Rvcj59IGFQb2ludHMgVGhlIHBvaW50cyBpbiB0aGUgZmlyc3QgcG9seWdvbi4KICAgKiBAcGFyYW0ge0FycmF5LjxWZWN0b3I+fSBiUG9pbnRzIFRoZSBwb2ludHMgaW4gdGhlIHNlY29uZCBwb2x5Z29uLgogICAqIEBwYXJhbSB7VmVjdG9yfSBheGlzIFRoZSBheGlzICh1bml0IHNpemVkKSB0byB0ZXN0IGFnYWluc3QuICBUaGUgcG9pbnRzIG9mIGJvdGggcG9seWdvbnMKICAgKiAgIHdpbGwgYmUgcHJvamVjdGVkIG9udG8gdGhpcyBheGlzLgogICAqIEBwYXJhbSB7UmVzcG9uc2U9fSByZXNwb25zZSBBIFJlc3BvbnNlIG9iamVjdCAob3B0aW9uYWwpIHdoaWNoIHdpbGwgYmUgcG9wdWxhdGVkCiAgICogICBpZiB0aGUgYXhpcyBpcyBub3QgYSBzZXBhcmF0aW5nIGF4aXMuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiBpdCBpcyBhIHNlcGFyYXRpbmcgYXhpcywgZmFsc2Ugb3RoZXJ3aXNlLiAgSWYgZmFsc2UsCiAgICogICBhbmQgYSByZXNwb25zZSBpcyBwYXNzZWQgaW4sIGluZm9ybWF0aW9uIGFib3V0IGhvdyBtdWNoIG92ZXJsYXAgYW5kCiAgICogICB0aGUgZGlyZWN0aW9uIG9mIHRoZSBvdmVybGFwIHdpbGwgYmUgcG9wdWxhdGVkLgogICAqLwogIGZ1bmN0aW9uIGlzU2VwYXJhdGluZ0F4aXMoYVBvcywgYlBvcywgYVBvaW50cywgYlBvaW50cywgYXhpcywgcmVzcG9uc2UpIHsKICAgIHZhciByYW5nZUEgPSBUX0FSUkFZUy5wb3AoKTsKICAgIHZhciByYW5nZUIgPSBUX0FSUkFZUy5wb3AoKTsKICAgIC8vIFRoZSBtYWduaXR1ZGUgb2YgdGhlIG9mZnNldCBiZXR3ZWVuIHRoZSB0d28gcG9seWdvbnMKICAgIHZhciBvZmZzZXRWID0gVF9WRUNUT1JTLnBvcCgpLmNvcHkoYlBvcykuc3ViKGFQb3MpOwogICAgdmFyIHByb2plY3RlZE9mZnNldCA9IG9mZnNldFYuZG90KGF4aXMpOwogICAgLy8gUHJvamVjdCB0aGUgcG9seWdvbnMgb250byB0aGUgYXhpcy4KICAgIGZsYXR0ZW5Qb2ludHNPbihhUG9pbnRzLCBheGlzLCByYW5nZUEpOwogICAgZmxhdHRlblBvaW50c09uKGJQb2ludHMsIGF4aXMsIHJhbmdlQik7CiAgICAvLyBNb3ZlIEIncyByYW5nZSB0byBpdHMgcG9zaXRpb24gcmVsYXRpdmUgdG8gQS4KICAgIHJhbmdlQlswXSArPSBwcm9qZWN0ZWRPZmZzZXQ7CiAgICByYW5nZUJbMV0gKz0gcHJvamVjdGVkT2Zmc2V0OwogICAgLy8gQ2hlY2sgaWYgdGhlcmUgaXMgYSBnYXAuIElmIHRoZXJlIGlzLCB0aGlzIGlzIGEgc2VwYXJhdGluZyBheGlzIGFuZCB3ZSBjYW4gc3RvcAogICAgaWYgKHJhbmdlQVswXSA+IHJhbmdlQlsxXSB8fCByYW5nZUJbMF0gPiByYW5nZUFbMV0pIHsKICAgICAgVF9WRUNUT1JTLnB1c2gob2Zmc2V0Vik7CiAgICAgIFRfQVJSQVlTLnB1c2gocmFuZ2VBKTsKICAgICAgVF9BUlJBWVMucHVzaChyYW5nZUIpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8vIFRoaXMgaXMgbm90IGEgc2VwYXJhdGluZyBheGlzLiBJZiB3ZSdyZSBjYWxjdWxhdGluZyBhIHJlc3BvbnNlLCBjYWxjdWxhdGUgdGhlIG92ZXJsYXAuCiAgICBpZiAocmVzcG9uc2UpIHsKICAgICAgdmFyIG92ZXJsYXAgPSAwOwogICAgICAvLyBBIHN0YXJ0cyBmdXJ0aGVyIGxlZnQgdGhhbiBCCiAgICAgIGlmIChyYW5nZUFbMF0gPCByYW5nZUJbMF0pIHsKICAgICAgICByZXNwb25zZVsnYUluQiddID0gZmFsc2U7CiAgICAgICAgLy8gQSBlbmRzIGJlZm9yZSBCIGRvZXMuIFdlIGhhdmUgdG8gcHVsbCBBIG91dCBvZiBCCiAgICAgICAgaWYgKHJhbmdlQVsxXSA8IHJhbmdlQlsxXSkgewogICAgICAgICAgb3ZlcmxhcCA9IHJhbmdlQVsxXSAtIHJhbmdlQlswXTsKICAgICAgICAgIHJlc3BvbnNlWydiSW5BJ10gPSBmYWxzZTsKICAgICAgICAvLyBCIGlzIGZ1bGx5IGluc2lkZSBBLiAgUGljayB0aGUgc2hvcnRlc3Qgd2F5IG91dC4KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIG9wdGlvbjEgPSByYW5nZUFbMV0gLSByYW5nZUJbMF07CiAgICAgICAgICB2YXIgb3B0aW9uMiA9IHJhbmdlQlsxXSAtIHJhbmdlQVswXTsKICAgICAgICAgIG92ZXJsYXAgPSBvcHRpb24xIDwgb3B0aW9uMiA/IG9wdGlvbjEgOiAtb3B0aW9uMjsKICAgICAgICB9CiAgICAgIC8vIEIgc3RhcnRzIGZ1cnRoZXIgbGVmdCB0aGFuIEEKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNwb25zZVsnYkluQSddID0gZmFsc2U7CiAgICAgICAgLy8gQiBlbmRzIGJlZm9yZSBBIGVuZHMuIFdlIGhhdmUgdG8gcHVzaCBBIG91dCBvZiBCCiAgICAgICAgaWYgKHJhbmdlQVsxXSA+IHJhbmdlQlsxXSkgewogICAgICAgICAgb3ZlcmxhcCA9IHJhbmdlQVswXSAtIHJhbmdlQlsxXTsKICAgICAgICAgIHJlc3BvbnNlWydhSW5CJ10gPSBmYWxzZTsKICAgICAgICAvLyBBIGlzIGZ1bGx5IGluc2lkZSBCLiAgUGljayB0aGUgc2hvcnRlc3Qgd2F5IG91dC4KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIG9wdGlvbjEgPSByYW5nZUFbMV0gLSByYW5nZUJbMF07CiAgICAgICAgICB2YXIgb3B0aW9uMiA9IHJhbmdlQlsxXSAtIHJhbmdlQVswXTsKICAgICAgICAgIG92ZXJsYXAgPSBvcHRpb24xIDwgb3B0aW9uMiA/IG9wdGlvbjEgOiAtb3B0aW9uMjsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gSWYgdGhpcyBpcyB0aGUgc21hbGxlc3QgYW1vdW50IG9mIG92ZXJsYXAgd2UndmUgc2VlbiBzbyBmYXIsIHNldCBpdCBhcyB0aGUgbWluaW11bSBvdmVybGFwLgogICAgICB2YXIgYWJzT3ZlcmxhcCA9IE1hdGguYWJzKG92ZXJsYXApOwogICAgICBpZiAoYWJzT3ZlcmxhcCA8IHJlc3BvbnNlWydvdmVybGFwJ10pIHsKICAgICAgICByZXNwb25zZVsnb3ZlcmxhcCddID0gYWJzT3ZlcmxhcDsKICAgICAgICByZXNwb25zZVsnb3ZlcmxhcE4nXS5jb3B5KGF4aXMpOwogICAgICAgIGlmIChvdmVybGFwIDwgMCkgewogICAgICAgICAgcmVzcG9uc2VbJ292ZXJsYXBOJ10ucmV2ZXJzZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgVF9WRUNUT1JTLnB1c2gob2Zmc2V0Vik7CiAgICBUX0FSUkFZUy5wdXNoKHJhbmdlQSk7CiAgICBUX0FSUkFZUy5wdXNoKHJhbmdlQik7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICAvLyBDYWxjdWxhdGVzIHdoaWNoIFZvcm5vaSByZWdpb24gYSBwb2ludCBpcyBvbiBhIGxpbmUgc2VnbWVudC4KICAvLyBJdCBpcyBhc3N1bWVkIHRoYXQgYm90aCB0aGUgbGluZSBhbmQgdGhlIHBvaW50IGFyZSByZWxhdGl2ZSB0byBgKDAsMClgCiAgLy8KICAvLyAgICAgICAgICAgIHwgICAgICAgKDApICAgICAgfAogIC8vICAgICAoLTEpICBbU10tLS0tLS0tLS0tLS0tLVtFXSAgKDEpCiAgLy8gICAgICAgICAgICB8ICAgICAgICgwKSAgICAgIHwKICAvKioKICAgKiBAcGFyYW0ge1ZlY3Rvcn0gbGluZSBUaGUgbGluZSBzZWdtZW50LgogICAqIEBwYXJhbSB7VmVjdG9yfSBwb2ludCBUaGUgcG9pbnQuCiAgICogQHJldHVybiAge251bWJlcn0gTEVGVF9WT1JOT0lfUkVHSU9OICgtMSkgaWYgaXQgaXMgdGhlIGxlZnQgcmVnaW9uLAogICAqICAgICAgICAgIE1JRERMRV9WT1JOT0lfUkVHSU9OICgwKSBpZiBpdCBpcyB0aGUgbWlkZGxlIHJlZ2lvbiwKICAgKiAgICAgICAgICBSSUdIVF9WT1JOT0lfUkVHSU9OICgxKSBpZiBpdCBpcyB0aGUgcmlnaHQgcmVnaW9uLgogICAqLwogIGZ1bmN0aW9uIHZvcm5vaVJlZ2lvbihsaW5lLCBwb2ludCkgewogICAgdmFyIGxlbjIgPSBsaW5lLmxlbjIoKTsKICAgIHZhciBkcCA9IHBvaW50LmRvdChsaW5lKTsKICAgIC8vIElmIHRoZSBwb2ludCBpcyBiZXlvbmQgdGhlIHN0YXJ0IG9mIHRoZSBsaW5lLCBpdCBpcyBpbiB0aGUKICAgIC8vIGxlZnQgdm9ybm9pIHJlZ2lvbi4KICAgIGlmIChkcCA8IDApIHsgcmV0dXJuIExFRlRfVk9STk9JX1JFR0lPTjsgfQogICAgLy8gSWYgdGhlIHBvaW50IGlzIGJleW9uZCB0aGUgZW5kIG9mIHRoZSBsaW5lLCBpdCBpcyBpbiB0aGUKICAgIC8vIHJpZ2h0IHZvcm5vaSByZWdpb24uCiAgICBlbHNlIGlmIChkcCA+IGxlbjIpIHsgcmV0dXJuIFJJR0hUX1ZPUk5PSV9SRUdJT047IH0KICAgIC8vIE90aGVyd2lzZSwgaXQncyBpbiB0aGUgbWlkZGxlIG9uZS4KICAgIGVsc2UgeyByZXR1cm4gTUlERExFX1ZPUk5PSV9SRUdJT047IH0KICB9CiAgLy8gQ29uc3RhbnRzIGZvciBWb3Jub2kgcmVnaW9ucwogIC8qKgogICAqIEBjb25zdAogICAqLwogIHZhciBMRUZUX1ZPUk5PSV9SRUdJT04gPSAtMTsKICAvKioKICAgKiBAY29uc3QKICAgKi8KICB2YXIgTUlERExFX1ZPUk5PSV9SRUdJT04gPSAwOwogIC8qKgogICAqIEBjb25zdAogICAqLwogIHZhciBSSUdIVF9WT1JOT0lfUkVHSU9OID0gMTsKCiAgLy8gIyMgQ29sbGlzaW9uIFRlc3RzCgogIC8vIENoZWNrIGlmIHR3byBjaXJjbGVzIGNvbGxpZGUuCiAgLyoqCiAgICogQHBhcmFtIHtDaXJjbGV9IGEgVGhlIGZpcnN0IGNpcmNsZS4KICAgKiBAcGFyYW0ge0NpcmNsZX0gYiBUaGUgc2Vjb25kIGNpcmNsZS4KICAgKiBAcGFyYW0ge1Jlc3BvbnNlPX0gcmVzcG9uc2UgUmVzcG9uc2Ugb2JqZWN0IChvcHRpb25hbCkgdGhhdCB3aWxsIGJlIHBvcHVsYXRlZCBpZgogICAqICAgdGhlIGNpcmNsZXMgaW50ZXJzZWN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWYgdGhlIGNpcmNsZXMgaW50ZXJzZWN0LCBmYWxzZSBpZiB0aGV5IGRvbid0LgogICAqLwogIGZ1bmN0aW9uIHRlc3RDaXJjbGVDaXJjbGUoYSwgYiwgcmVzcG9uc2UpIHsKICAgIC8vIENoZWNrIGlmIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSBjZW50ZXJzIG9mIHRoZSB0d28KICAgIC8vIGNpcmNsZXMgaXMgZ3JlYXRlciB0aGFuIHRoZWlyIGNvbWJpbmVkIHJhZGl1cy4KICAgIHZhciBkaWZmZXJlbmNlViA9IFRfVkVDVE9SUy5wb3AoKS5jb3B5KGJbJ3BvcyddKS5zdWIoYVsncG9zJ10pOwogICAgdmFyIHRvdGFsUmFkaXVzID0gYVsnciddICsgYlsnciddOwogICAgdmFyIHRvdGFsUmFkaXVzU3EgPSB0b3RhbFJhZGl1cyAqIHRvdGFsUmFkaXVzOwogICAgdmFyIGRpc3RhbmNlU3EgPSBkaWZmZXJlbmNlVi5sZW4yKCk7CiAgICAvLyBJZiB0aGUgZGlzdGFuY2UgaXMgYmlnZ2VyIHRoYW4gdGhlIGNvbWJpbmVkIHJhZGl1cywgdGhleSBkb24ndCBpbnRlcnNlY3QuCiAgICBpZiAoZGlzdGFuY2VTcSA+IHRvdGFsUmFkaXVzU3EpIHsKICAgICAgVF9WRUNUT1JTLnB1c2goZGlmZmVyZW5jZVYpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvLyBUaGV5IGludGVyc2VjdC4gIElmIHdlJ3JlIGNhbGN1bGF0aW5nIGEgcmVzcG9uc2UsIGNhbGN1bGF0ZSB0aGUgb3ZlcmxhcC4KICAgIGlmIChyZXNwb25zZSkgewogICAgICB2YXIgZGlzdCA9IE1hdGguc3FydChkaXN0YW5jZVNxKTsKICAgICAgcmVzcG9uc2VbJ2EnXSA9IGE7CiAgICAgIHJlc3BvbnNlWydiJ10gPSBiOwogICAgICByZXNwb25zZVsnb3ZlcmxhcCddID0gdG90YWxSYWRpdXMgLSBkaXN0OwogICAgICByZXNwb25zZVsnb3ZlcmxhcE4nXS5jb3B5KGRpZmZlcmVuY2VWLm5vcm1hbGl6ZSgpKTsKICAgICAgcmVzcG9uc2VbJ292ZXJsYXBWJ10uY29weShkaWZmZXJlbmNlVikuc2NhbGUocmVzcG9uc2VbJ292ZXJsYXAnXSk7CiAgICAgIHJlc3BvbnNlWydhSW5CJ109IGFbJ3InXSA8PSBiWydyJ10gJiYgZGlzdCA8PSBiWydyJ10gLSBhWydyJ107CiAgICAgIHJlc3BvbnNlWydiSW5BJ10gPSBiWydyJ10gPD0gYVsnciddICYmIGRpc3QgPD0gYVsnciddIC0gYlsnciddOwogICAgfQogICAgVF9WRUNUT1JTLnB1c2goZGlmZmVyZW5jZVYpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIFNBVFsndGVzdENpcmNsZUNpcmNsZSddID0gdGVzdENpcmNsZUNpcmNsZTsKCiAgLy8gQ2hlY2sgaWYgYSBwb2x5Z29uIGFuZCBhIGNpcmNsZSBjb2xsaWRlLgogIC8qKgogICAqIEBwYXJhbSB7UG9seWdvbn0gcG9seWdvbiBUaGUgcG9seWdvbi4KICAgKiBAcGFyYW0ge0NpcmNsZX0gY2lyY2xlIFRoZSBjaXJjbGUuCiAgICogQHBhcmFtIHtSZXNwb25zZT19IHJlc3BvbnNlIFJlc3BvbnNlIG9iamVjdCAob3B0aW9uYWwpIHRoYXQgd2lsbCBiZSBwb3B1bGF0ZWQgaWYKICAgKiAgIHRoZXkgaW50ZXJzZXQuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiB0aGV5IGludGVyc2VjdCwgZmFsc2UgaWYgdGhleSBkb24ndC4KICAgKi8KICBmdW5jdGlvbiB0ZXN0UG9seWdvbkNpcmNsZShwb2x5Z29uLCBjaXJjbGUsIHJlc3BvbnNlKSB7CiAgICAvLyBHZXQgdGhlIHBvc2l0aW9uIG9mIHRoZSBjaXJjbGUgcmVsYXRpdmUgdG8gdGhlIHBvbHlnb24uCiAgICB2YXIgY2lyY2xlUG9zID0gVF9WRUNUT1JTLnBvcCgpLmNvcHkoY2lyY2xlWydwb3MnXSkuc3ViKHBvbHlnb25bJ3BvcyddKTsKICAgIHZhciByYWRpdXMgPSBjaXJjbGVbJ3InXTsKICAgIHZhciByYWRpdXMyID0gcmFkaXVzICogcmFkaXVzOwogICAgdmFyIHBvaW50cyA9IHBvbHlnb25bJ3BvaW50cyddOwogICAgdmFyIGxlbiA9IHBvaW50cy5sZW5ndGg7CiAgICB2YXIgZWRnZSA9IFRfVkVDVE9SUy5wb3AoKTsKICAgIHZhciBwb2ludCA9IFRfVkVDVE9SUy5wb3AoKTsKCiAgICAvLyBGb3IgZWFjaCBlZGdlIGluIHRoZSBwb2x5Z29uOgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICB2YXIgbmV4dCA9IGkgPT09IGxlbiAtIDEgPyAwIDogaSArIDE7CiAgICAgIHZhciBwcmV2ID0gaSA9PT0gMCA/IGxlbiAtIDEgOiBpIC0gMTsKICAgICAgdmFyIG92ZXJsYXAgPSAwOwogICAgICB2YXIgb3ZlcmxhcE4gPSBudWxsOwoKICAgICAgLy8gR2V0IHRoZSBlZGdlLgogICAgICBlZGdlLmNvcHkocG9seWdvblsnZWRnZXMnXVtpXSk7CiAgICAgIC8vIENhbGN1bGF0ZSB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUgcmVsYXRpdmUgdG8gdGhlIHN0YXJ0aW5nIHBvaW50IG9mIHRoZSBlZGdlLgogICAgICBwb2ludC5jb3B5KGNpcmNsZVBvcykuc3ViKHBvaW50c1tpXSk7CgogICAgICAvLyBJZiB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUgYW5kIHRoZSBwb2ludAogICAgICAvLyBpcyBiaWdnZXIgdGhhbiB0aGUgcmFkaXVzLCB0aGUgcG9seWdvbiBpcyBkZWZpbml0ZWx5IG5vdCBmdWxseSBpbgogICAgICAvLyB0aGUgY2lyY2xlLgogICAgICBpZiAocmVzcG9uc2UgJiYgcG9pbnQubGVuMigpID4gcmFkaXVzMikgewogICAgICAgIHJlc3BvbnNlWydhSW5CJ10gPSBmYWxzZTsKICAgICAgfQoKICAgICAgLy8gQ2FsY3VsYXRlIHdoaWNoIFZvcm5vaSByZWdpb24gdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlIGlzIGluLgogICAgICB2YXIgcmVnaW9uID0gdm9ybm9pUmVnaW9uKGVkZ2UsIHBvaW50KTsKICAgICAgLy8gSWYgaXQncyB0aGUgbGVmdCByZWdpb246CiAgICAgIGlmIChyZWdpb24gPT09IExFRlRfVk9STk9JX1JFR0lPTikgewogICAgICAgIC8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHdlJ3JlIGluIHRoZSBSSUdIVF9WT1JOT0lfUkVHSU9OIG9mIHRoZSBwcmV2aW91cyBlZGdlLgogICAgICAgIGVkZ2UuY29weShwb2x5Z29uWydlZGdlcyddW3ByZXZdKTsKICAgICAgICAvLyBDYWxjdWxhdGUgdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlIHJlbGF0aXZlIHRoZSBzdGFydGluZyBwb2ludCBvZiB0aGUgcHJldmlvdXMgZWRnZQogICAgICAgIHZhciBwb2ludDIgPSBUX1ZFQ1RPUlMucG9wKCkuY29weShjaXJjbGVQb3MpLnN1Yihwb2ludHNbcHJldl0pOwogICAgICAgIHJlZ2lvbiA9IHZvcm5vaVJlZ2lvbihlZGdlLCBwb2ludDIpOwogICAgICAgIGlmIChyZWdpb24gPT09IFJJR0hUX1ZPUk5PSV9SRUdJT04pIHsKICAgICAgICAgIC8vIEl0J3MgaW4gdGhlIHJlZ2lvbiB3ZSB3YW50LiAgQ2hlY2sgaWYgdGhlIGNpcmNsZSBpbnRlcnNlY3RzIHRoZSBwb2ludC4KICAgICAgICAgIHZhciBkaXN0ID0gcG9pbnQubGVuKCk7CiAgICAgICAgICBpZiAoZGlzdCA+IHJhZGl1cykgewogICAgICAgICAgICAvLyBObyBpbnRlcnNlY3Rpb24KICAgICAgICAgICAgVF9WRUNUT1JTLnB1c2goY2lyY2xlUG9zKTsKICAgICAgICAgICAgVF9WRUNUT1JTLnB1c2goZWRnZSk7CiAgICAgICAgICAgIFRfVkVDVE9SUy5wdXNoKHBvaW50KTsKICAgICAgICAgICAgVF9WRUNUT1JTLnB1c2gocG9pbnQyKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZSkgewogICAgICAgICAgICAvLyBJdCBpbnRlcnNlY3RzLCBjYWxjdWxhdGUgdGhlIG92ZXJsYXAuCiAgICAgICAgICAgIHJlc3BvbnNlWydiSW5BJ10gPSBmYWxzZTsKICAgICAgICAgICAgb3ZlcmxhcE4gPSBwb2ludC5ub3JtYWxpemUoKTsKICAgICAgICAgICAgb3ZlcmxhcCA9IHJhZGl1cyAtIGRpc3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFRfVkVDVE9SUy5wdXNoKHBvaW50Mik7CiAgICAgIC8vIElmIGl0J3MgdGhlIHJpZ2h0IHJlZ2lvbjoKICAgICAgfSBlbHNlIGlmIChyZWdpb24gPT09IFJJR0hUX1ZPUk5PSV9SRUdJT04pIHsKICAgICAgICAvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB3ZSdyZSBpbiB0aGUgbGVmdCByZWdpb24gb24gdGhlIG5leHQgZWRnZQogICAgICAgIGVkZ2UuY29weShwb2x5Z29uWydlZGdlcyddW25leHRdKTsKICAgICAgICAvLyBDYWxjdWxhdGUgdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlIHJlbGF0aXZlIHRvIHRoZSBzdGFydGluZyBwb2ludCBvZiB0aGUgbmV4dCBlZGdlLgogICAgICAgIHBvaW50LmNvcHkoY2lyY2xlUG9zKS5zdWIocG9pbnRzW25leHRdKTsKICAgICAgICByZWdpb24gPSB2b3Jub2lSZWdpb24oZWRnZSwgcG9pbnQpOwogICAgICAgIGlmIChyZWdpb24gPT09IExFRlRfVk9STk9JX1JFR0lPTikgewogICAgICAgICAgLy8gSXQncyBpbiB0aGUgcmVnaW9uIHdlIHdhbnQuICBDaGVjayBpZiB0aGUgY2lyY2xlIGludGVyc2VjdHMgdGhlIHBvaW50LgogICAgICAgICAgdmFyIGRpc3QgPSBwb2ludC5sZW4oKTsKICAgICAgICAgIGlmIChkaXN0ID4gcmFkaXVzKSB7CiAgICAgICAgICAgIC8vIE5vIGludGVyc2VjdGlvbgogICAgICAgICAgICBUX1ZFQ1RPUlMucHVzaChjaXJjbGVQb3MpOwogICAgICAgICAgICBUX1ZFQ1RPUlMucHVzaChlZGdlKTsKICAgICAgICAgICAgVF9WRUNUT1JTLnB1c2gocG9pbnQpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIC8vIEl0IGludGVyc2VjdHMsIGNhbGN1bGF0ZSB0aGUgb3ZlcmxhcC4KICAgICAgICAgICAgcmVzcG9uc2VbJ2JJbkEnXSA9IGZhbHNlOwogICAgICAgICAgICBvdmVybGFwTiA9IHBvaW50Lm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBvdmVybGFwID0gcmFkaXVzIC0gZGlzdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIC8vIE90aGVyd2lzZSwgaXQncyB0aGUgbWlkZGxlIHJlZ2lvbjoKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBOZWVkIHRvIGNoZWNrIGlmIHRoZSBjaXJjbGUgaXMgaW50ZXJzZWN0aW5nIHRoZSBlZGdlLAogICAgICAgIC8vIENoYW5nZSB0aGUgZWRnZSBpbnRvIGl0cyAiZWRnZSBub3JtYWwiLgogICAgICAgIHZhciBub3JtYWwgPSBlZGdlLnBlcnAoKS5ub3JtYWxpemUoKTsKICAgICAgICAvLyBGaW5kIHRoZSBwZXJwZW5kaWN1bGFyIGRpc3RhbmNlIGJldHdlZW4gdGhlIGNlbnRlciBvZiB0aGUKICAgICAgICAvLyBjaXJjbGUgYW5kIHRoZSBlZGdlLgogICAgICAgIHZhciBkaXN0ID0gcG9pbnQuZG90KG5vcm1hbCk7CiAgICAgICAgdmFyIGRpc3RBYnMgPSBNYXRoLmFicyhkaXN0KTsKICAgICAgICAvLyBJZiB0aGUgY2lyY2xlIGlzIG9uIHRoZSBvdXRzaWRlIG9mIHRoZSBlZGdlLCB0aGVyZSBpcyBubyBpbnRlcnNlY3Rpb24uCiAgICAgICAgaWYgKGRpc3QgPiAwICYmIGRpc3RBYnMgPiByYWRpdXMpIHsKICAgICAgICAgIC8vIE5vIGludGVyc2VjdGlvbgogICAgICAgICAgVF9WRUNUT1JTLnB1c2goY2lyY2xlUG9zKTsKICAgICAgICAgIFRfVkVDVE9SUy5wdXNoKG5vcm1hbCk7CiAgICAgICAgICBUX1ZFQ1RPUlMucHVzaChwb2ludCk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZSkgewogICAgICAgICAgLy8gSXQgaW50ZXJzZWN0cywgY2FsY3VsYXRlIHRoZSBvdmVybGFwLgogICAgICAgICAgb3ZlcmxhcE4gPSBub3JtYWw7CiAgICAgICAgICBvdmVybGFwID0gcmFkaXVzIC0gZGlzdDsKICAgICAgICAgIC8vIElmIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZSBpcyBvbiB0aGUgb3V0c2lkZSBvZiB0aGUgZWRnZSwgb3IgcGFydCBvZiB0aGUKICAgICAgICAgIC8vIGNpcmNsZSBpcyBvbiB0aGUgb3V0c2lkZSwgdGhlIGNpcmNsZSBpcyBub3QgZnVsbHkgaW5zaWRlIHRoZSBwb2x5Z29uLgogICAgICAgICAgaWYgKGRpc3QgPj0gMCB8fCBvdmVybGFwIDwgMiAqIHJhZGl1cykgewogICAgICAgICAgICByZXNwb25zZVsnYkluQSddID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBJZiB0aGlzIGlzIHRoZSBzbWFsbGVzdCBvdmVybGFwIHdlJ3ZlIHNlZW4sIGtlZXAgaXQuCiAgICAgIC8vIChvdmVybGFwTiBtYXkgYmUgbnVsbCBpZiB0aGUgY2lyY2xlIHdhcyBpbiB0aGUgd3JvbmcgVm9ybm9pIHJlZ2lvbikuCiAgICAgIGlmIChvdmVybGFwTiAmJiByZXNwb25zZSAmJiBNYXRoLmFicyhvdmVybGFwKSA8IE1hdGguYWJzKHJlc3BvbnNlWydvdmVybGFwJ10pKSB7CiAgICAgICAgcmVzcG9uc2VbJ292ZXJsYXAnXSA9IG92ZXJsYXA7CiAgICAgICAgcmVzcG9uc2VbJ292ZXJsYXBOJ10uY29weShvdmVybGFwTik7CiAgICAgIH0KICAgIH0KCiAgICAvLyBDYWxjdWxhdGUgdGhlIGZpbmFsIG92ZXJsYXAgdmVjdG9yIC0gYmFzZWQgb24gdGhlIHNtYWxsZXN0IG92ZXJsYXAuCiAgICBpZiAocmVzcG9uc2UpIHsKICAgICAgcmVzcG9uc2VbJ2EnXSA9IHBvbHlnb247CiAgICAgIHJlc3BvbnNlWydiJ10gPSBjaXJjbGU7CiAgICAgIHJlc3BvbnNlWydvdmVybGFwViddLmNvcHkocmVzcG9uc2VbJ292ZXJsYXBOJ10pLnNjYWxlKHJlc3BvbnNlWydvdmVybGFwJ10pOwogICAgfQogICAgVF9WRUNUT1JTLnB1c2goY2lyY2xlUG9zKTsKICAgIFRfVkVDVE9SUy5wdXNoKGVkZ2UpOwogICAgVF9WRUNUT1JTLnB1c2gocG9pbnQpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIFNBVFsndGVzdFBvbHlnb25DaXJjbGUnXSA9IHRlc3RQb2x5Z29uQ2lyY2xlOwoKICAvLyBDaGVjayBpZiBhIGNpcmNsZSBhbmQgYSBwb2x5Z29uIGNvbGxpZGUuCiAgLy8KICAvLyAqKk5PVEU6KiogVGhpcyBpcyBzbGlnaHRseSBsZXNzIGVmZmljaWVudCB0aGFuIHBvbHlnb25DaXJjbGUgYXMgaXQganVzdAogIC8vIHJ1bnMgcG9seWdvbkNpcmNsZSBhbmQgcmV2ZXJzZXMgZXZlcnl0aGluZyBhdCB0aGUgZW5kLgogIC8qKgogICAqIEBwYXJhbSB7Q2lyY2xlfSBjaXJjbGUgVGhlIGNpcmNsZS4KICAgKiBAcGFyYW0ge1BvbHlnb259IHBvbHlnb24gVGhlIHBvbHlnb24uCiAgICogQHBhcmFtIHtSZXNwb25zZT19IHJlc3BvbnNlIFJlc3BvbnNlIG9iamVjdCAob3B0aW9uYWwpIHRoYXQgd2lsbCBiZSBwb3B1bGF0ZWQgaWYKICAgKiAgIHRoZXkgaW50ZXJzZXQuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiB0aGV5IGludGVyc2VjdCwgZmFsc2UgaWYgdGhleSBkb24ndC4KICAgKi8KICBmdW5jdGlvbiB0ZXN0Q2lyY2xlUG9seWdvbihjaXJjbGUsIHBvbHlnb24sIHJlc3BvbnNlKSB7CiAgICAvLyBUZXN0IHRoZSBwb2x5Z29uIGFnYWluc3QgdGhlIGNpcmNsZS4KICAgIHZhciByZXN1bHQgPSB0ZXN0UG9seWdvbkNpcmNsZShwb2x5Z29uLCBjaXJjbGUsIHJlc3BvbnNlKTsKICAgIGlmIChyZXN1bHQgJiYgcmVzcG9uc2UpIHsKICAgICAgLy8gU3dhcCBBIGFuZCBCIGluIHRoZSByZXNwb25zZS4KICAgICAgdmFyIGEgPSByZXNwb25zZVsnYSddOwogICAgICB2YXIgYUluQiA9IHJlc3BvbnNlWydhSW5CJ107CiAgICAgIHJlc3BvbnNlWydvdmVybGFwTiddLnJldmVyc2UoKTsKICAgICAgcmVzcG9uc2VbJ292ZXJsYXBWJ10ucmV2ZXJzZSgpOwogICAgICByZXNwb25zZVsnYSddID0gcmVzcG9uc2VbJ2InXTsKICAgICAgcmVzcG9uc2VbJ2InXSA9IGE7CiAgICAgIHJlc3BvbnNlWydhSW5CJ10gPSByZXNwb25zZVsnYkluQSddOwogICAgICByZXNwb25zZVsnYkluQSddID0gYUluQjsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIFNBVFsndGVzdENpcmNsZVBvbHlnb24nXSA9IHRlc3RDaXJjbGVQb2x5Z29uOwoKICAvLyBDaGVja3Mgd2hldGhlciBwb2x5Z29ucyBjb2xsaWRlLgogIC8qKgogICAqIEBwYXJhbSB7UG9seWdvbn0gYSBUaGUgZmlyc3QgcG9seWdvbi4KICAgKiBAcGFyYW0ge1BvbHlnb259IGIgVGhlIHNlY29uZCBwb2x5Z29uLgogICAqIEBwYXJhbSB7UmVzcG9uc2U9fSByZXNwb25zZSBSZXNwb25zZSBvYmplY3QgKG9wdGlvbmFsKSB0aGF0IHdpbGwgYmUgcG9wdWxhdGVkIGlmCiAgICogICB0aGV5IGludGVyc2V0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWYgdGhleSBpbnRlcnNlY3QsIGZhbHNlIGlmIHRoZXkgZG9uJ3QuCiAgICovCiAgZnVuY3Rpb24gdGVzdFBvbHlnb25Qb2x5Z29uKGEsIGIsIHJlc3BvbnNlKSB7CiAgICB2YXIgYVBvaW50cyA9IGFbJ3BvaW50cyddOwogICAgdmFyIGFMZW4gPSBhUG9pbnRzLmxlbmd0aDsKICAgIHZhciBiUG9pbnRzID0gYlsncG9pbnRzJ107CiAgICB2YXIgYkxlbiA9IGJQb2ludHMubGVuZ3RoOwogICAgLy8gSWYgYW55IG9mIHRoZSBlZGdlIG5vcm1hbHMgb2YgQSBpcyBhIHNlcGFyYXRpbmcgYXhpcywgbm8gaW50ZXJzZWN0aW9uLgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhTGVuOyBpKyspIHsKICAgICAgaWYgKGlzU2VwYXJhdGluZ0F4aXMoYVsncG9zJ10sIGJbJ3BvcyddLCBhUG9pbnRzLCBiUG9pbnRzLCBhWydub3JtYWxzJ11baV0sIHJlc3BvbnNlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgLy8gSWYgYW55IG9mIHRoZSBlZGdlIG5vcm1hbHMgb2YgQiBpcyBhIHNlcGFyYXRpbmcgYXhpcywgbm8gaW50ZXJzZWN0aW9uLgogICAgZm9yICh2YXIgaSA9IDA7aSA8IGJMZW47IGkrKykgewogICAgICBpZiAoaXNTZXBhcmF0aW5nQXhpcyhhWydwb3MnXSwgYlsncG9zJ10sIGFQb2ludHMsIGJQb2ludHMsIGJbJ25vcm1hbHMnXVtpXSwgcmVzcG9uc2UpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICAvLyBTaW5jZSBub25lIG9mIHRoZSBlZGdlIG5vcm1hbHMgb2YgQSBvciBCIGFyZSBhIHNlcGFyYXRpbmcgYXhpcywgdGhlcmUgaXMgYW4gaW50ZXJzZWN0aW9uCiAgICAvLyBhbmQgd2UndmUgYWxyZWFkeSBjYWxjdWxhdGVkIHRoZSBzbWFsbGVzdCBvdmVybGFwIChpbiBpc1NlcGFyYXRpbmdBeGlzKS4gIENhbGN1bGF0ZSB0aGUKICAgIC8vIGZpbmFsIG92ZXJsYXAgdmVjdG9yLgogICAgaWYgKHJlc3BvbnNlKSB7CiAgICAgIHJlc3BvbnNlWydhJ10gPSBhOwogICAgICByZXNwb25zZVsnYiddID0gYjsKICAgICAgcmVzcG9uc2VbJ292ZXJsYXBWJ10uY29weShyZXNwb25zZVsnb3ZlcmxhcE4nXSkuc2NhbGUocmVzcG9uc2VbJ292ZXJsYXAnXSk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgU0FUWyd0ZXN0UG9seWdvblBvbHlnb24nXSA9IHRlc3RQb2x5Z29uUG9seWdvbjsKCiAgcmV0dXJuIFNBVDsKfSkoKTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEBjbGFzcyBQaGFzZXIuUGh5c2ljcwoqLwpQaGFzZXIuUGh5c2ljcyA9IHt9OwoKLyoqCiogQXJjYWRlIFBoeXNpY3MgY29uc3RydWN0b3IuCioKKiBAY2xhc3MgUGhhc2VyLlBoeXNpY3MuQXJjYWRlCiogQGNsYXNzZGVzYyBBcmNhZGUgUGh5c2ljcyBDb25zdHJ1Y3RvcgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50IGdhbWUgaW5zdGFuY2UuCiovClBoYXNlci5QaHlzaWNzLkFyY2FkZSA9IGZ1bmN0aW9uIChnYW1lKSB7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGdyYXZpdHkgLSBUaGUgV29ybGQgZ3Jhdml0eSBzZXR0aW5nLiBEZWZhdWx0cyB0byB4OiAwLCB5OiAwLCBvciBubyBncmF2aXR5LgogICAgKi8KICAgIHRoaXMuZ3Jhdml0eSA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtTQVQuQm94fSB3b3JsZExlZnQgLSBUaGUgbGVmdCBoYW5kIHNpZGUgb2YgdGhlIHBoeXNpY3MgYm91bmRzLgogICAgKi8KICAgIHRoaXMud29ybGRMZWZ0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtTQVQuQm94fSB3b3JsZFJpZ2h0IC0gVGhlIHJpZ2h0IGhhbmQgc2lkZSBvZiB0aGUgcGh5c2ljcyBib3VuZHMuCiAgICAqLwogICAgdGhpcy53b3JsZFJpZ2h0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtTQVQuQm94fSB3b3JsZFRvcCAtIFRoZSB0b3Agc2lkZSBvZiB0aGUgcGh5c2ljcyBib3VuZHMuCiAgICAqLwogICAgdGhpcy53b3JsZFRvcCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7U0FULkJveH0gd29ybGRCb3R0b20gLSBUaGUgYm90dG9tIG9mIHRoZSBwaHlzaWNzIGJvdW5kcy4KICAgICovCiAgICB0aGlzLndvcmxkQm90dG9tID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheTxTQVQuUG9seWdvbj59IHdvcmxkUG9seXMgLSBBbiBhcnJheSBvZiB0aGUgcG9seWdvbiBkYXRhIGZyb20gdGhlIHBoeXNpY3MgYm91bmRzLgogICAgKi8KICAgIHRoaXMud29ybGRQb2x5cyA9IFsgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCBdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5RdWFkVHJlZX0gcXVhZFRyZWUgLSBUaGUgd29ybGQgUXVhZFRyZWUuCiAgICAqLwogICAgdGhpcy5xdWFkVHJlZSA9IG5ldyBQaGFzZXIuUXVhZFRyZWUodGhpcy5nYW1lLndvcmxkLmJvdW5kcy54LCB0aGlzLmdhbWUud29ybGQuYm91bmRzLnksIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMud2lkdGgsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMuaGVpZ2h0LCB0aGlzLm1heE9iamVjdHMsIHRoaXMubWF4TGV2ZWxzKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heE9iamVjdHMgLSBVc2VkIGJ5IHRoZSBRdWFkVHJlZSB0byBzZXQgdGhlIG1heGltdW0gbnVtYmVyIG9mIG9iamVjdHMgcGVyIHF1YWQuCiAgICAqLwogICAgdGhpcy5tYXhPYmplY3RzID0gMTA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYXhMZXZlbHMgLSBVc2VkIGJ5IHRoZSBRdWFkVHJlZSB0byBzZXQgdGhlIG1heGltdW0gbnVtYmVyIG9mIGl0ZXJhdGlvbiBsZXZlbHMuCiAgICAqLwogICAgdGhpcy5tYXhMZXZlbHMgPSA0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0FycmF5fSBfbWFwRGF0YSAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9tYXBEYXRhID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfbWFwVGlsZXMgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fbWFwVGlsZXMgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9yZXN1bHQgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fcmVzdWx0ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdG90YWwgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdG90YWwgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2FuZ2xlIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2FuZ2xlID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9kcmFnIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2RyYWcgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R4IC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2R4ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9keSAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9keSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBfcCAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9wID0gbmV3IFBoYXNlci5Qb2ludCgwLCAwKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9pbnRlcnNlY3Rpb24gLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5faW50ZXJzZWN0aW9uID0gWzAsMCwwLDBdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2dyYXZpdHlYIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2dyYXZpdHlYID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9ncmF2aXR5WSAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9ncmF2aXR5WSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7U0FULlJlc3BvbnNlfSBfcmVzcG9uc2UgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fcmVzcG9uc2UgPSBuZXcgU0FULlJlc3BvbnNlKCk7CgogICAgLy8gIFNldCB0aGUgYm91bmRzIHRvIHRoZSB3b3JsZCBhcyBkZWZhdWx0CiAgICB0aGlzLnNldEJvdW5kc1RvV29ybGQodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7Cgp9OwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLlBoeXNpY3MuQXJjYWRlLlJFQ1QgPSAwOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkNJUkNMRSA9IDE7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuUGh5c2ljcy5BcmNhZGUuUE9MWUdPTiA9IDI7CgpQaGFzZXIuUGh5c2ljcy5BcmNhZGUucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBDaGVja3MgdGhlIGdpdmVuIFBoeXNpY3MuQm9keSBhZ2FpbnN0IHRoZSBQaHlzaWNzIEJvdW5kcywgaWYgYW55IGFyZSBzZXQsIGFuZCBzZXBhcmF0ZXMgdGhlbSwgc2V0dGluZyB0aGUgYmxvY2tlZCBmbGFncyBvbiB0aGUgQm9keSBhcyBpdCBkb2VzIHNvLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjaGVja0JvdW5kcwogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBUaGUgQm9keSBvYmplY3QgdG8gYmUgY2hlY2tlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgYm9keSBoaXQgdGhlIGJvdW5kcywgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGNoZWNrQm91bmRzOiBmdW5jdGlvbiAoYm9keSkgewoKICAgICAgICBpZiAoIWJvZHkuY29sbGlkZVdvcmxkQm91bmRzIHx8ICghdGhpcy53b3JsZExlZnQgJiYgIXRoaXMud29ybGRSaWdodCAmJiAhdGhpcy53b3JsZFRvcCAmJiAhdGhpcy53b3JsZEJvdHRvbSkpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9yZXNwb25zZS5jbGVhcigpOwoKICAgICAgICB2YXIgdGVzdCA9IFNBVC50ZXN0UG9seWdvblBvbHlnb247CiAgICAgICAgdmFyIHBhcnQgPSBib2R5LnBvbHlnb247CiAgICAgICAgdmFyIHJlYm91bmRlZCA9IGZhbHNlOwoKICAgICAgICBpZiAoYm9keS50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQ0lSQ0xFKQogICAgICAgIHsKICAgICAgICAgICAgdGVzdCA9IFNBVC50ZXN0UG9seWdvbkNpcmNsZTsKICAgICAgICAgICAgcGFydCA9IGJvZHkuc2hhcGU7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy53b3JsZExlZnQgJiYgdGVzdCh0aGlzLndvcmxkUG9seXNbMF0sIHBhcnQsIHRoaXMuX3Jlc3BvbnNlKSkKICAgICAgICB7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC5sZWZ0ID0gdHJ1ZTsKICAgICAgICAgICAgcGFydC5wb3MuYWRkKHRoaXMuX3Jlc3BvbnNlLm92ZXJsYXBWKTsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnggPSBNYXRoLmZsb29yKGJvZHkueCk7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC55ID0gTWF0aC5mbG9vcihib2R5LnkpOwogICAgICAgICAgICByZWJvdW5kZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLndvcmxkUmlnaHQgJiYgdGVzdCh0aGlzLndvcmxkUG9seXNbMV0sIHBhcnQsIHRoaXMuX3Jlc3BvbnNlKSkKICAgICAgICB7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC5yaWdodCA9IHRydWU7CiAgICAgICAgICAgIHBhcnQucG9zLmFkZCh0aGlzLl9yZXNwb25zZS5vdmVybGFwVik7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC54ID0gTWF0aC5mbG9vcihib2R5LngpOwogICAgICAgICAgICBib2R5LmJsb2NrZWQueSA9IE1hdGguZmxvb3IoYm9keS55KTsKICAgICAgICAgICAgcmVib3VuZGVkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3Jlc3BvbnNlLmNsZWFyKCk7CgogICAgICAgIGlmICh0aGlzLndvcmxkVG9wICYmIHRlc3QodGhpcy53b3JsZFBvbHlzWzJdLCBwYXJ0LCB0aGlzLl9yZXNwb25zZSkpCiAgICAgICAgewogICAgICAgICAgICBib2R5LmJsb2NrZWQudXAgPSB0cnVlOwogICAgICAgICAgICBwYXJ0LnBvcy5hZGQodGhpcy5fcmVzcG9uc2Uub3ZlcmxhcFYpOwogICAgICAgICAgICBib2R5LmJsb2NrZWQueCA9IE1hdGguZmxvb3IoYm9keS54KTsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnkgPSBNYXRoLmZsb29yKGJvZHkueSk7CiAgICAgICAgICAgIHJlYm91bmRlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMud29ybGRCb3R0b20gJiYgdGVzdCh0aGlzLndvcmxkUG9seXNbM10sIHBhcnQsIHRoaXMuX3Jlc3BvbnNlKSkKICAgICAgICB7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC5kb3duID0gdHJ1ZTsKICAgICAgICAgICAgcGFydC5wb3MuYWRkKHRoaXMuX3Jlc3BvbnNlLm92ZXJsYXBWKTsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnggPSBNYXRoLmZsb29yKGJvZHkueCk7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC55ID0gTWF0aC5mbG9vcihib2R5LnkpOwogICAgICAgICAgICByZWJvdW5kZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlYm91bmRlZDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBib3VuZHMgb2YgdGhlIFBoeXNpY3Mgd29ybGQgdG8gbWF0Y2ggdGhlIEdhbWUuV29ybGQuCiAgICAqIFlvdSBjYW4gb3B0aW9uYWxseSBzZXQgd2hpY2ggJ3dhbGxzJyB0byBjcmVhdGU6IGxlZnQsIHJpZ2h0LCB0b3Agb3IgYm90dG9tLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNzZXRCb3VuZHNUb1dvcmxkCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xlZnQ9dHJ1ZV0gLSBJZiB0cnVlIHdpbGwgY3JlYXRlIHRoZSBsZWZ0IGJvdW5kcyB3YWxsLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyaWdodD10cnVlXSAtIElmIHRydWUgd2lsbCBjcmVhdGUgdGhlIHJpZ2h0IGJvdW5kcyB3YWxsLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt0b3A9dHJ1ZV0gLSBJZiB0cnVlIHdpbGwgY3JlYXRlIHRoZSB0b3AgYm91bmRzIHdhbGwuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2JvdHRvbT10cnVlXSAtIElmIHRydWUgd2lsbCBjcmVhdGUgdGhlIGJvdHRvbSBib3VuZHMgd2FsbC4KICAgICovCiAgICBzZXRCb3VuZHNUb1dvcmxkOiBmdW5jdGlvbiAobGVmdCwgcmlnaHQsIHRvcCwgYm90dG9tKSB7CgogICAgICAgIHRoaXMuc2V0Qm91bmRzKHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMueCwgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy55LCB0aGlzLmdhbWUud29ybGQuYm91bmRzLndpZHRoLCB0aGlzLmdhbWUud29ybGQuYm91bmRzLmhlaWdodCwgbGVmdCwgcmlnaHQsIHRvcCwgYm90dG9tKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBib3VuZHMgb2YgdGhlIFBoeXNpY3Mgd29ybGQgdG8gbWF0Y2ggdGhlIGdpdmVuIHdvcmxkIHBpeGVsIGRpbWVuc2lvbnMuCiAgICAqIFlvdSBjYW4gb3B0aW9uYWxseSBzZXQgd2hpY2ggJ3dhbGxzJyB0byBjcmVhdGU6IGxlZnQsIHJpZ2h0LCB0b3Agb3IgYm90dG9tLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNzZXRCb3VuZHMKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSB0b3AtbGVmdCBjb3JuZXIgb2YgdGhlIGJvdW5kcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSB0b3AtbGVmdCBjb3JuZXIgb2YgdGhlIGJvdW5kcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBib3VuZHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBib3VuZHMuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xlZnQ9dHJ1ZV0gLSBJZiB0cnVlIHdpbGwgY3JlYXRlIHRoZSBsZWZ0IGJvdW5kcyB3YWxsLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyaWdodD10cnVlXSAtIElmIHRydWUgd2lsbCBjcmVhdGUgdGhlIHJpZ2h0IGJvdW5kcyB3YWxsLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt0b3A9dHJ1ZV0gLSBJZiB0cnVlIHdpbGwgY3JlYXRlIHRoZSB0b3AgYm91bmRzIHdhbGwuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2JvdHRvbT10cnVlXSAtIElmIHRydWUgd2lsbCBjcmVhdGUgdGhlIGJvdHRvbSBib3VuZHMgd2FsbC4KICAgICovCiAgICBzZXRCb3VuZHM6IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsZWZ0LCByaWdodCwgdG9wLCBib3R0b20pIHsKCiAgICAgICAgaWYgKHR5cGVvZiBsZWZ0ID09PSAndW5kZWZpbmVkJykgeyBsZWZ0ID0gdHJ1ZTsgfQogICAgICAgIGlmICh0eXBlb2YgcmlnaHQgPT09ICd1bmRlZmluZWQnKSB7IHJpZ2h0ID0gdHJ1ZTsgfQogICAgICAgIGlmICh0eXBlb2YgdG9wID09PSAndW5kZWZpbmVkJykgeyB0b3AgPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBib3R0b20gPT09ICd1bmRlZmluZWQnKSB7IGJvdHRvbSA9IHRydWU7IH0KCiAgICAgICAgdmFyIHRoaWNrbmVzcyA9IDEwMDsKCiAgICAgICAgaWYgKGxlZnQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndvcmxkTGVmdCA9IG5ldyBTQVQuQm94KG5ldyBTQVQuVmVjdG9yKHggLSB0aGlja25lc3MsIHkpLCB0aGlja25lc3MsIGhlaWdodCk7CiAgICAgICAgICAgIHRoaXMud29ybGRQb2x5c1swXSA9IHRoaXMud29ybGRMZWZ0LnRvUG9seWdvbigpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndvcmxkTGVmdCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMud29ybGRQb2x5c1swXSA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAocmlnaHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndvcmxkUmlnaHQgPSBuZXcgU0FULkJveChuZXcgU0FULlZlY3Rvcih4ICsgd2lkdGgsIHkpLCB0aGlja25lc3MsIGhlaWdodCk7CiAgICAgICAgICAgIHRoaXMud29ybGRQb2x5c1sxXSA9IHRoaXMud29ybGRSaWdodC50b1BvbHlnb24oKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy53b3JsZFJpZ2h0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy53b3JsZFBvbHlzWzFdID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmICh0b3ApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndvcmxkVG9wID0gbmV3IFNBVC5Cb3gobmV3IFNBVC5WZWN0b3IoeCwgeSAtIHRoaWNrbmVzcyksIHdpZHRoLCB0aGlja25lc3MpOwogICAgICAgICAgICB0aGlzLndvcmxkUG9seXNbMl0gPSB0aGlzLndvcmxkVG9wLnRvUG9seWdvbigpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndvcmxkVG9wID0gbnVsbDsKICAgICAgICAgICAgdGhpcy53b3JsZFBvbHlzWzJdID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChib3R0b20pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndvcmxkQm90dG9tID0gbmV3IFNBVC5Cb3gobmV3IFNBVC5WZWN0b3IoeCwgeSArIGhlaWdodCksIHdpZHRoLCB0aGlja25lc3MpOwogICAgICAgICAgICB0aGlzLndvcmxkUG9seXNbM10gPSB0aGlzLndvcmxkQm90dG9tLnRvUG9seWdvbigpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndvcmxkQm90dG9tID0gbnVsbDsKICAgICAgICAgICAgdGhpcy53b3JsZFBvbHlzWzNdID0gbnVsbDsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgYSBQaHlzaWNzIGJvZHksIGl0IHVwZGF0ZXMgYWxsIG1vdGlvbiByZWxhdGVkIHZhbHVlcyBvbiB0aGUgQm9keS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjdXBkYXRlTW90aW9uCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IFRoZSBCb2R5IG9iamVjdCB0byBiZSB1cGRhdGVkLgogICAgKi8KICAgIHVwZGF0ZU1vdGlvbjogZnVuY3Rpb24gKGJvZHkpIHsKCiAgICAgICAgLy8gIElmIHlvdSdyZSB3b25kZXJpbmcgd2h5IHRoZSB2ZWxvY2l0eSBpcyBoYWx2ZWQgYW5kIGFwcGxpZWQgdHdpY2UsIHJlYWQgdGhpczogaHR0cDovL3d3dy5uaWtzdWxhLmh1dC5maS9+aGthbmthYW4vSG9tZXBhZ2VzL2dyYXZpdHkuaHRtbAoKICAgICAgICAvLyAgV29ybGQgZ3Jhdml0eSBpcyBhbGxvd2VkCiAgICAgICAgaWYgKGJvZHkuYWxsb3dHcmF2aXR5KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZ3Jhdml0eVggPSB0aGlzLmdyYXZpdHkueCArIGJvZHkuZ3Jhdml0eS54OwogICAgICAgICAgICB0aGlzLl9ncmF2aXR5WSA9IHRoaXMuZ3Jhdml0eS55ICsgYm9keS5ncmF2aXR5Lnk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2dyYXZpdHlYID0gYm9keS5ncmF2aXR5Lng7CiAgICAgICAgICAgIHRoaXMuX2dyYXZpdHlZID0gYm9keS5ncmF2aXR5Lnk7CiAgICAgICAgfQoKICAgICAgICAvLyAgRG9uJ3QgYXBwbHkgZ3Jhdml0eSB0byBhbnkgYm9keSB0aGF0IGlzIGJsb2NrZWQKICAgICAgICBpZiAoKHRoaXMuX2dyYXZpdHlYIDwgMCAmJiBib2R5LmJsb2NrZWQubGVmdCkgfHwgKHRoaXMuX2dyYXZpdHlYID4gMCAmJiBib2R5LmJsb2NrZWQucmlnaHQpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZ3Jhdml0eVggPSAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKCh0aGlzLl9ncmF2aXR5WSA8IDAgJiYgYm9keS5ibG9ja2VkLnVwKSB8fCAodGhpcy5fZ3Jhdml0eVkgPiAwICYmIGJvZHkuYmxvY2tlZC5kb3duKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2dyYXZpdHlZID0gMDsKICAgICAgICB9CgogICAgICAgIC8vICBSb3RhdGlvbgogICAgICAgIGlmIChib2R5LmFsbG93Um90YXRpb24pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl92ZWxvY2l0eURlbHRhID0gYm9keS5hbmd1bGFyQWNjZWxlcmF0aW9uICogdGhpcy5nYW1lLnRpbWUucGh5c2ljc0VsYXBzZWQ7CgogICAgICAgICAgICBpZiAoYm9keS5hbmd1bGFyRHJhZyAhPT0gMCAmJiBib2R5LmFuZ3VsYXJBY2NlbGVyYXRpb24gPT09IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX2RyYWcgPSBib2R5LmFuZ3VsYXJEcmFnICogdGhpcy5nYW1lLnRpbWUucGh5c2ljc0VsYXBzZWQ7CgogICAgICAgICAgICAgICAgaWYgKGJvZHkuYW5ndWxhclZlbG9jaXR5ID4gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBib2R5LmFuZ3VsYXJWZWxvY2l0eSAtPSB0aGlzLl9kcmFnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoYm9keS5hbmd1bGFyVmVsb2NpdHkgPCAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkuYW5ndWxhclZlbG9jaXR5ICs9IHRoaXMuX2RyYWc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGJvZHkucm90YXRpb24gKz0gdGhpcy5nYW1lLnRpbWUucGh5c2ljc0VsYXBzZWQgKiAoYm9keS5hbmd1bGFyVmVsb2NpdHkgKyB0aGlzLl92ZWxvY2l0eURlbHRhIC8gMik7CiAgICAgICAgICAgIGJvZHkuYW5ndWxhclZlbG9jaXR5ICs9IHRoaXMuX3ZlbG9jaXR5RGVsdGE7CiAgICAKICAgICAgICAgICAgaWYgKGJvZHkuYW5ndWxhclZlbG9jaXR5ID4gYm9keS5tYXhBbmd1bGFyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib2R5LmFuZ3VsYXJWZWxvY2l0eSA9IGJvZHkubWF4QW5ndWxhcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChib2R5LmFuZ3VsYXJWZWxvY2l0eSA8IC1ib2R5Lm1heEFuZ3VsYXIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJvZHkuYW5ndWxhclZlbG9jaXR5ID0gLWJvZHkubWF4QW5ndWxhcjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gdGVtcCA9IGFjYypkdAogICAgICAgIC8vIHBvcyA9IHBvcyArIGR0Kih2ZWwgKyB0ZW1wLzIpCiAgICAgICAgLy8gdmVsID0gdmVsICsgdGVtcAoKICAgICAgICB0aGlzLl9wLnNldFRvKChib2R5LmFjY2VsZXJhdGlvbi54ICsgdGhpcy5fZ3Jhdml0eVgpICogdGhpcy5nYW1lLnRpbWUucGh5c2ljc0VsYXBzZWQsIChib2R5LmFjY2VsZXJhdGlvbi55ICsgdGhpcy5fZ3Jhdml0eVkpICogdGhpcy5nYW1lLnRpbWUucGh5c2ljc0VsYXBzZWQpOwoKICAgICAgICByZXR1cm4gdGhpcy5fcDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgZm9yIG92ZXJsYXBzIGJldHdlZW4gdHdvIGdhbWUgb2JqZWN0cy4gVGhlIG9iamVjdHMgY2FuIGJlIFNwcml0ZXMsIEdyb3VwcyBvciBFbWl0dGVycy4KICAgICogWW91IGNhbiBwZXJmb3JtIFNwcml0ZSB2cy4gU3ByaXRlLCBTcHJpdGUgdnMuIEdyb3VwIGFuZCBHcm91cCB2cy4gR3JvdXAgb3ZlcmxhcCBjaGVja3MuCiAgICAqIFVubGlrZSBjb2xsaWRlIHRoZSBvYmplY3RzIGFyZSBOT1QgYXV0b21hdGljYWxseSBzZXBhcmF0ZWQgb3IgaGF2ZSBhbnkgcGh5c2ljcyBhcHBsaWVkLCB0aGV5IG1lcmVseSB0ZXN0IGZvciBvdmVybGFwIHJlc3VsdHMuCiAgICAqIFRoZSBzZWNvbmQgcGFyYW1ldGVyIGNhbiBiZSBhbiBhcnJheSBvZiBvYmplY3RzLCBvZiBkaWZmZXJpbmcgdHlwZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI292ZXJsYXAKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfFBoYXNlci5Hcm91cHxQaGFzZXIuUGFydGljbGVzLkVtaXR0ZXJ9IG9iamVjdDEgLSBUaGUgZmlyc3Qgb2JqZWN0IHRvIGNoZWNrLiBDYW4gYmUgYW4gaW5zdGFuY2Ugb2YgUGhhc2VyLlNwcml0ZSwgUGhhc2VyLkdyb3VwIG9yIFBoYXNlci5QYXJ0aWNsZXMuRW1pdHRlci4KICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfFBoYXNlci5Hcm91cHxQaGFzZXIuUGFydGljbGVzLkVtaXR0ZXJ8YXJyYXl9IG9iamVjdDIgLSBUaGUgc2Vjb25kIG9iamVjdCBvciBhcnJheSBvZiBvYmplY3RzIHRvIGNoZWNrLiBDYW4gYmUgUGhhc2VyLlNwcml0ZSwgUGhhc2VyLkdyb3VwIG9yIFBoYXNlci5QYXJ0aWNsZXMuRW1pdHRlci4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gW292ZXJsYXBDYWxsYmFjaz1udWxsXSAtIEFuIG9wdGlvbmFsIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgaXMgY2FsbGVkIGlmIHRoZSBvYmplY3RzIG92ZXJsYXAuIFRoZSB0d28gb2JqZWN0cyB3aWxsIGJlIHBhc3NlZCB0byB0aGlzIGZ1bmN0aW9uIGluIHRoZSBzYW1lIG9yZGVyIGluIHdoaWNoIHlvdSBzcGVjaWZpZWQgdGhlbS4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gW3Byb2Nlc3NDYWxsYmFjaz1udWxsXSAtIEEgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBsZXRzIHlvdSBwZXJmb3JtIGFkZGl0aW9uYWwgY2hlY2tzIGFnYWluc3QgdGhlIHR3byBvYmplY3RzIGlmIHRoZXkgb3ZlcmxhcC4gSWYgdGhpcyBpcyBzZXQgdGhlbiBvdmVybGFwQ2FsbGJhY2sgd2lsbCBvbmx5IGJlIGNhbGxlZCBpZiBwcm9jZXNzQ2FsbGJhY2sgcmV0dXJucyB0cnVlLgogICAgKiBAcGFyYW0ge29iamVjdH0gW2NhbGxiYWNrQ29udGV4dF0gLSBUaGUgY29udGV4dCBpbiB3aGljaCB0byBydW4gdGhlIGNhbGxiYWNrcy4KICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYW4gb3ZlcmxhcCBvY2N1cmVkIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBvdmVybGFwOiBmdW5jdGlvbiAob2JqZWN0MSwgb2JqZWN0Miwgb3ZlcmxhcENhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKICAgICAgICBvdmVybGFwQ2FsbGJhY2sgPSBvdmVybGFwQ2FsbGJhY2sgfHwgbnVsbDsKICAgICAgICBwcm9jZXNzQ2FsbGJhY2sgPSBwcm9jZXNzQ2FsbGJhY2sgfHwgbnVsbDsKICAgICAgICBjYWxsYmFja0NvbnRleHQgPSBjYWxsYmFja0NvbnRleHQgfHwgb3ZlcmxhcENhbGxiYWNrOwoKICAgICAgICB0aGlzLl9yZXN1bHQgPSBmYWxzZTsKICAgICAgICB0aGlzLl90b3RhbCA9IDA7CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KG9iamVjdDIpKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsICBsZW4gPSBvYmplY3QyLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVIYW5kbGVyKG9iamVjdDEsIG9iamVjdDJbaV0sIG92ZXJsYXBDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29sbGlkZUhhbmRsZXIob2JqZWN0MSwgb2JqZWN0Miwgb3ZlcmxhcENhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKHRoaXMuX3RvdGFsID4gMCk7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGZvciBjb2xsaXNpb24gYmV0d2VlbiB0d28gZ2FtZSBvYmplY3RzLiBZb3UgY2FuIHBlcmZvcm0gU3ByaXRlIHZzLiBTcHJpdGUsIFNwcml0ZSB2cy4gR3JvdXAsIEdyb3VwIHZzLiBHcm91cCwgU3ByaXRlIHZzLiBUaWxlbWFwIExheWVyIG9yIEdyb3VwIHZzLiBUaWxlbWFwIExheWVyIGNvbGxpc2lvbnMuCiAgICAqIFRoZSBzZWNvbmQgcGFyYW1ldGVyIGNhbiBiZSBhbiBhcnJheSBvZiBvYmplY3RzLCBvZiBkaWZmZXJpbmcgdHlwZXMuCiAgICAqIFRoZSBvYmplY3RzIGFyZSBhbHNvIGF1dG9tYXRpY2FsbHkgc2VwYXJhdGVkLiBJZiB5b3UgZG9uJ3QgcmVxdWlyZSBzZXBhcmF0aW9uIHRoZW4gdXNlIEFyY2FkZVBoeXNpY3Mub3ZlcmxhcCBpbnN0ZWFkLgogICAgKiBBbiBvcHRpb25hbCBwcm9jZXNzQ2FsbGJhY2sgY2FuIGJlIHByb3ZpZGVkLiBJZiBnaXZlbiB0aGlzIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdoZW4gdHdvIHNwcml0ZXMgYXJlIGZvdW5kIHRvIGJlIGNvbGxpZGluZy4gSXQgaXMgY2FsbGVkIGJlZm9yZSBhbnkgc2VwYXJhdGlvbiB0YWtlcyBwbGFjZSwKICAgICogZ2l2aW5nIHlvdSB0aGUgY2hhbmNlIHRvIHBlcmZvcm0gYWRkaXRpb25hbCBjaGVja3MuIElmIHRoZSBmdW5jdGlvbiByZXR1cm5zIHRydWUgdGhlbiB0aGUgY29sbGlzaW9uIGFuZCBzZXBhcmF0aW9uIGlzIGNhcnJpZWQgb3V0LiBJZiBpdCByZXR1cm5zIGZhbHNlIGl0IGlzIHNraXBwZWQuCiAgICAqIFRoZSBjb2xsaWRlQ2FsbGJhY2sgaXMgYW4gb3B0aW9uYWwgZnVuY3Rpb24gdGhhdCBpcyBvbmx5IGNhbGxlZCBpZiB0d28gc3ByaXRlcyBjb2xsaWRlLiBJZiBhIHByb2Nlc3NDYWxsYmFjayBoYXMgYmVlbiBzZXQgdGhlbiBpdCBuZWVkcyB0byByZXR1cm4gdHJ1ZSBmb3IgY29sbGlkZUNhbGxiYWNrIHRvIGJlIGNhbGxlZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjY29sbGlkZQogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV8UGhhc2VyLkdyb3VwfFBoYXNlci5QYXJ0aWNsZXMuRW1pdHRlcnxQaGFzZXIuVGlsZW1hcH0gb2JqZWN0MSAtIFRoZSBmaXJzdCBvYmplY3QgdG8gY2hlY2suIENhbiBiZSBhbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuR3JvdXAsIFBoYXNlci5QYXJ0aWNsZXMuRW1pdHRlciwgb3IgUGhhc2VyLlRpbGVtYXAuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZXxQaGFzZXIuR3JvdXB8UGhhc2VyLlBhcnRpY2xlcy5FbWl0dGVyfFBoYXNlci5UaWxlbWFwfGFycmF5fSBvYmplY3QyIC0gVGhlIHNlY29uZCBvYmplY3Qgb3IgYXJyYXkgb2Ygb2JqZWN0cyB0byBjaGVjay4gQ2FuIGJlIFBoYXNlci5TcHJpdGUsIFBoYXNlci5Hcm91cCwgUGhhc2VyLlBhcnRpY2xlcy5FbWl0dGVyIG9yIFBoYXNlci5UaWxlbWFwLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbY29sbGlkZUNhbGxiYWNrPW51bGxdIC0gQW4gb3B0aW9uYWwgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgaWYgdGhlIG9iamVjdHMgY29sbGlkZS4gVGhlIHR3byBvYmplY3RzIHdpbGwgYmUgcGFzc2VkIHRvIHRoaXMgZnVuY3Rpb24gaW4gdGhlIHNhbWUgb3JkZXIgaW4gd2hpY2ggeW91IHNwZWNpZmllZCB0aGVtLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbcHJvY2Vzc0NhbGxiYWNrPW51bGxdIC0gQSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGxldHMgeW91IHBlcmZvcm0gYWRkaXRpb25hbCBjaGVja3MgYWdhaW5zdCB0aGUgdHdvIG9iamVjdHMgaWYgdGhleSBvdmVybGFwLiBJZiB0aGlzIGlzIHNldCB0aGVuIGNvbGxpc2lvbiB3aWxsIG9ubHkgaGFwcGVuIGlmIHByb2Nlc3NDYWxsYmFjayByZXR1cm5zIHRydWUuIFRoZSB0d28gb2JqZWN0cyB3aWxsIGJlIHBhc3NlZCB0byB0aGlzIGZ1bmN0aW9uIGluIHRoZSBzYW1lIG9yZGVyIGluIHdoaWNoIHlvdSBzcGVjaWZpZWQgdGhlbS4KICAgICogQHBhcmFtIHtvYmplY3R9IFtjYWxsYmFja0NvbnRleHRdIC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdG8gcnVuIHRoZSBjYWxsYmFja3MuCiAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGEgY29sbGlzaW9uIG9jY3VyZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGNvbGxpZGU6IGZ1bmN0aW9uIChvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIGNvbGxpZGVDYWxsYmFjayA9IGNvbGxpZGVDYWxsYmFjayB8fCBudWxsOwogICAgICAgIHByb2Nlc3NDYWxsYmFjayA9IHByb2Nlc3NDYWxsYmFjayB8fCBudWxsOwogICAgICAgIGNhbGxiYWNrQ29udGV4dCA9IGNhbGxiYWNrQ29udGV4dCB8fCBjb2xsaWRlQ2FsbGJhY2s7CgogICAgICAgIHRoaXMuX3Jlc3VsdCA9IGZhbHNlOwogICAgICAgIHRoaXMuX3RvdGFsID0gMDsKCiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkob2JqZWN0MikpCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgIGxlbiA9IG9iamVjdDIubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZUhhbmRsZXIob2JqZWN0MSwgb2JqZWN0MltpXSwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29sbGlkZUhhbmRsZXIob2JqZWN0MSwgb2JqZWN0MiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgZmFsc2UpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICh0aGlzLl90b3RhbCA+IDApOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIGNvbGxpc2lvbiBoYW5kbGVyLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjb2xsaWRlSGFuZGxlcgogICAgKiBAcHJpdmF0ZQogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV8UGhhc2VyLkdyb3VwfFBoYXNlci5QYXJ0aWNsZXMuRW1pdHRlcnxQaGFzZXIuVGlsZW1hcH0gb2JqZWN0MSAtIFRoZSBmaXJzdCBvYmplY3QgdG8gY2hlY2suIENhbiBiZSBhbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuR3JvdXAsIFBoYXNlci5QYXJ0aWNsZXMuRW1pdHRlciwgb3IgUGhhc2VyLlRpbGVtYXAuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZXxQaGFzZXIuR3JvdXB8UGhhc2VyLlBhcnRpY2xlcy5FbWl0dGVyfFBoYXNlci5UaWxlbWFwfSBvYmplY3QyIC0gVGhlIHNlY29uZCBvYmplY3QgdG8gY2hlY2suIENhbiBiZSBhbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuR3JvdXAsIFBoYXNlci5QYXJ0aWNsZXMuRW1pdHRlciBvciBQaGFzZXIuVGlsZW1hcC4gQ2FuIGFsc28gYmUgYW4gYXJyYXkgb2Ygb2JqZWN0cyB0byBjaGVjay4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY29sbGlkZUNhbGxiYWNrIC0gQW4gb3B0aW9uYWwgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgaWYgdGhlIG9iamVjdHMgY29sbGlkZS4gVGhlIHR3byBvYmplY3RzIHdpbGwgYmUgcGFzc2VkIHRvIHRoaXMgZnVuY3Rpb24gaW4gdGhlIHNhbWUgb3JkZXIgaW4gd2hpY2ggeW91IHNwZWNpZmllZCB0aGVtLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBwcm9jZXNzQ2FsbGJhY2sgLSBBIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgbGV0cyB5b3UgcGVyZm9ybSBhZGRpdGlvbmFsIGNoZWNrcyBhZ2FpbnN0IHRoZSB0d28gb2JqZWN0cyBpZiB0aGV5IG92ZXJsYXAuIElmIHRoaXMgaXMgc2V0IHRoZW4gY29sbGlzaW9uIHdpbGwgb25seSBoYXBwZW4gaWYgcHJvY2Vzc0NhbGxiYWNrIHJldHVybnMgdHJ1ZS4gVGhlIHR3byBvYmplY3RzIHdpbGwgYmUgcGFzc2VkIHRvIHRoaXMgZnVuY3Rpb24gaW4gdGhlIHNhbWUgb3JkZXIgaW4gd2hpY2ggeW91IHNwZWNpZmllZCB0aGVtLgogICAgKiBAcGFyYW0ge29iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdG8gcnVuIHRoZSBjYWxsYmFja3MuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3ZlcmxhcE9ubHkgLSBKdXN0IHJ1biBhbiBvdmVybGFwIG9yIGEgZnVsbCBjb2xsaXNpb24uCiAgICAqLwogICAgY29sbGlkZUhhbmRsZXI6IGZ1bmN0aW9uIChvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSkgewoKICAgICAgICAvLyAgT25seSBjb2xsaWRlIHZhbGlkIG9iamVjdHMKICAgICAgICBpZiAodHlwZW9mIG9iamVjdDIgPT09ICd1bmRlZmluZWQnICYmIChvYmplY3QxLnR5cGUgPT09IFBoYXNlci5HUk9VUCB8fCBvYmplY3QxLnR5cGUgPT09IFBoYXNlci5FTUlUVEVSKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29sbGlkZUdyb3VwVnNTZWxmKG9iamVjdDEsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJsYXBPbmx5KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKG9iamVjdDEgJiYgb2JqZWN0MiAmJiBvYmplY3QxLmV4aXN0cyAmJiBvYmplY3QyLmV4aXN0cykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBTUFJJVEVTCiAgICAgICAgICAgIGlmIChvYmplY3QxLnR5cGUgPT0gUGhhc2VyLlNQUklURSB8fCBvYmplY3QxLnR5cGUgPT0gUGhhc2VyLlRJTEVTUFJJVEUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlNQUklURSB8fCBvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlRJTEVTUFJJVEUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlU3ByaXRlVnNTcHJpdGUob2JqZWN0MSwgb2JqZWN0MiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlcmxhcE9ubHkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAob2JqZWN0Mi50eXBlID09IFBoYXNlci5HUk9VUCB8fCBvYmplY3QyLnR5cGUgPT0gUGhhc2VyLkVNSVRURVIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlU3ByaXRlVnNHcm91cChvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlRJTEVNQVBMQVlFUikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc1RpbGVtYXBMYXllcihvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAgR1JPVVBTCiAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDEudHlwZSA9PSBQaGFzZXIuR1JPVVApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlNQUklURSB8fCBvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlRJTEVTUFJJVEUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlU3ByaXRlVnNHcm91cChvYmplY3QyLCBvYmplY3QxLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLkdST1VQIHx8IG9iamVjdDIudHlwZSA9PSBQaGFzZXIuRU1JVFRFUikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVHcm91cFZzR3JvdXAob2JqZWN0MSwgb2JqZWN0MiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlcmxhcE9ubHkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAob2JqZWN0Mi50eXBlID09IFBoYXNlci5USUxFTUFQTEFZRVIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlR3JvdXBWc1RpbGVtYXBMYXllcihvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAgVElMRU1BUCBMQVlFUlMKICAgICAgICAgICAgZWxzZSBpZiAob2JqZWN0MS50eXBlID09IFBoYXNlci5USUxFTUFQTEFZRVIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlNQUklURSB8fCBvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlRJTEVTUFJJVEUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlU3ByaXRlVnNUaWxlbWFwTGF5ZXIob2JqZWN0Miwgb2JqZWN0MSwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLkdST1VQIHx8IG9iamVjdDIudHlwZSA9PSBQaGFzZXIuRU1JVFRFUikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVHcm91cFZzVGlsZW1hcExheWVyKG9iamVjdDIsIG9iamVjdDEsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vICBFTUlUVEVSCiAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDEudHlwZSA9PSBQaGFzZXIuRU1JVFRFUikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuU1BSSVRFIHx8IG9iamVjdDIudHlwZSA9PSBQaGFzZXIuVElMRVNQUklURSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc0dyb3VwKG9iamVjdDIsIG9iamVjdDEsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJsYXBPbmx5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuR1JPVVAgfHwgb2JqZWN0Mi50eXBlID09IFBoYXNlci5FTUlUVEVSKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZUdyb3VwVnNHcm91cChvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlRJTEVNQVBMQVlFUikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVHcm91cFZzVGlsZW1hcExheWVyKG9iamVjdDEsIG9iamVjdDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEFuIGludGVybmFsIGZ1bmN0aW9uLiBVc2UgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLmNvbGxpZGUgaW5zdGVhZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjY29sbGlkZVNwcml0ZVZzU3ByaXRlCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgY29sbGlkZVNwcml0ZVZzU3ByaXRlOiBmdW5jdGlvbiAoc3ByaXRlMSwgc3ByaXRlMiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlcmxhcE9ubHkpIHsKCiAgICAgICAgaWYgKHRoaXMuc2VwYXJhdGUoc3ByaXRlMS5ib2R5LCBzcHJpdGUyLmJvZHksIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSkpCiAgICAgICAgewogICAgICAgICAgICBpZiAoY29sbGlkZUNhbGxiYWNrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb2xsaWRlQ2FsbGJhY2suY2FsbChjYWxsYmFja0NvbnRleHQsIHNwcml0ZTEsIHNwcml0ZTIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl90b3RhbCsrOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBbiBpbnRlcm5hbCBmdW5jdGlvbi4gVXNlIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5jb2xsaWRlIGluc3RlYWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NvbGxpZGVTcHJpdGVWc0dyb3VwCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgY29sbGlkZVNwcml0ZVZzR3JvdXA6IGZ1bmN0aW9uIChzcHJpdGUsIGdyb3VwLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSkgewoKICAgICAgICBpZiAoZ3JvdXAubGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gIFdoYXQgaXMgdGhlIHNwcml0ZSBjb2xsaWRpbmcgd2l0aCBpbiB0aGUgcXVhZHRyZWU/CiAgICAgICAgdGhpcy5xdWFkVHJlZS5jbGVhcigpOwoKICAgICAgICB0aGlzLnF1YWRUcmVlID0gbmV3IFBoYXNlci5RdWFkVHJlZSh0aGlzLmdhbWUud29ybGQuYm91bmRzLngsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMueSwgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy53aWR0aCwgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy5oZWlnaHQsIHRoaXMubWF4T2JqZWN0cywgdGhpcy5tYXhMZXZlbHMpOwoKICAgICAgICB0aGlzLnF1YWRUcmVlLnBvcHVsYXRlKGdyb3VwKTsKCiAgICAgICAgdGhpcy5fcG90ZW50aWFscyA9IHRoaXMucXVhZFRyZWUucmV0cmlldmUoc3ByaXRlKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX3BvdGVudGlhbHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgewogICAgICAgICAgICAvLyAgV2UgaGF2ZSBvdXIgcG90ZW50aWFsIHN1c3BlY3RzLCBhcmUgdGhleSBpbiB0aGlzIGdyb3VwPwogICAgICAgICAgICBpZiAodGhpcy5zZXBhcmF0ZShzcHJpdGUuYm9keSwgdGhpcy5fcG90ZW50aWFsc1tpXSwgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJsYXBPbmx5KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGNvbGxpZGVDYWxsYmFjaykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjb2xsaWRlQ2FsbGJhY2suY2FsbChjYWxsYmFja0NvbnRleHQsIHNwcml0ZSwgdGhpcy5fcG90ZW50aWFsc1tpXS5zcHJpdGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuX3RvdGFsKys7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQW4gaW50ZXJuYWwgZnVuY3Rpb24uIFVzZSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuY29sbGlkZSBpbnN0ZWFkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjb2xsaWRlR3JvdXBWc1NlbGYKICAgICogQHByaXZhdGUKICAgICovCiAgICBjb2xsaWRlR3JvdXBWc1NlbGY6IGZ1bmN0aW9uIChncm91cCwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlcmxhcE9ubHkpIHsKCiAgICAgICAgaWYgKGdyb3VwLmxlbmd0aCA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBsZW4gPSBncm91cC5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aDsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGogPSBpICsgMTsgaiA8PSBsZW47IGorKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGdyb3VwLl9jb250YWluZXIuY2hpbGRyZW5baV0gJiYgZ3JvdXAuX2NvbnRhaW5lci5jaGlsZHJlbltqXSAmJiBncm91cC5fY29udGFpbmVyLmNoaWxkcmVuW2ldLmV4aXN0cyAmJiBncm91cC5fY29udGFpbmVyLmNoaWxkcmVuW2pdLmV4aXN0cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc1Nwcml0ZShncm91cC5fY29udGFpbmVyLmNoaWxkcmVuW2ldLCBncm91cC5fY29udGFpbmVyLmNoaWxkcmVuW2pdLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQW4gaW50ZXJuYWwgZnVuY3Rpb24uIFVzZSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuY29sbGlkZSBpbnN0ZWFkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjb2xsaWRlR3JvdXBWc0dyb3VwCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgY29sbGlkZUdyb3VwVnNHcm91cDogZnVuY3Rpb24gKGdyb3VwMSwgZ3JvdXAyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSkgewoKICAgICAgICBpZiAoZ3JvdXAxLmxlbmd0aCA9PT0gMCB8fCBncm91cDIubGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGdyb3VwMS5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IGdyb3VwMS5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBkbwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuZXhpc3RzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZVNwcml0ZVZzR3JvdXAoY3VycmVudE5vZGUsIGdyb3VwMiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlcmxhcE9ubHkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnROb2RlICE9IGdyb3VwMS5fY29udGFpbmVyLmxhc3QuX2lOZXh0KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQW4gaW50ZXJuYWwgZnVuY3Rpb24uIFVzZSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuY29sbGlkZSBpbnN0ZWFkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjb2xsaWRlU3ByaXRlVnNUaWxlbWFwTGF5ZXIKICAgICogQHByaXZhdGUKICAgICovCiAgICBjb2xsaWRlU3ByaXRlVnNUaWxlbWFwTGF5ZXI6IGZ1bmN0aW9uIChzcHJpdGUsIHRpbGVtYXBMYXllciwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKICAgICAgICB0aGlzLl9tYXBEYXRhID0gdGlsZW1hcExheWVyLmdldFRpbGVzKHNwcml0ZS5ib2R5LmxlZnQsIHNwcml0ZS5ib2R5LnRvcCwgc3ByaXRlLmJvZHkud2lkdGgsIHNwcml0ZS5ib2R5LmhlaWdodCwgdHJ1ZSk7CgogICAgICAgIGlmICh0aGlzLl9tYXBEYXRhLmxlbmd0aCA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9tYXBEYXRhLmxlbmd0aCA+IDEpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNlcGFyYXRlVGlsZXMoc3ByaXRlLmJvZHksIHRoaXMuX21hcERhdGEpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB2YXIgaSA9IDA7CgogICAgICAgICAgICBpZiAodGhpcy5zZXBhcmF0ZVRpbGUoc3ByaXRlLmJvZHksIHRoaXMuX21hcERhdGFbaV0pKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgVGhleSBjb2xsaWRlZCwgaXMgdGhlcmUgYSBjdXN0b20gcHJvY2VzcyBjYWxsYmFjaz8KICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzQ2FsbGJhY2spCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByb2Nlc3NDYWxsYmFjay5jYWxsKGNhbGxiYWNrQ29udGV4dCwgc3ByaXRlLCB0aGlzLl9tYXBEYXRhW2ldKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3RvdGFsKys7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sbGlkZUNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsaWRlQ2FsbGJhY2suY2FsbChjYWxsYmFja0NvbnRleHQsIHNwcml0ZSwgdGhpcy5fbWFwRGF0YVtpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG90YWwrKzsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbGxpZGVDYWxsYmFjaykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxpZGVDYWxsYmFjay5jYWxsKGNhbGxiYWNrQ29udGV4dCwgc3ByaXRlLCB0aGlzLl9tYXBEYXRhW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQW4gaW50ZXJuYWwgZnVuY3Rpb24uIFVzZSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuY29sbGlkZSBpbnN0ZWFkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjb2xsaWRlR3JvdXBWc1RpbGVtYXBMYXllcgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIGNvbGxpZGVHcm91cFZzVGlsZW1hcExheWVyOiBmdW5jdGlvbiAoZ3JvdXAsIHRpbGVtYXBMYXllciwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKICAgICAgICBpZiAoZ3JvdXAubGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGdyb3VwLl9jb250YWluZXIuZmlyc3QuX2lOZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gZ3JvdXAuX2NvbnRhaW5lci5maXJzdC5faU5leHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmV4aXN0cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc1RpbGVtYXBMYXllcihjdXJyZW50Tm9kZSwgdGlsZW1hcExheWVyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSAhPSBncm91cC5fY29udGFpbmVyLmxhc3QuX2lOZXh0KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIGNvcmUgc2VwYXJhdGlvbiBmdW5jdGlvbiB0byBzZXBhcmF0ZSB0d28gcGh5c2ljcyBib2RpZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3NlcGFyYXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkxIC0gVGhlIEJvZHkgb2JqZWN0IHRvIHNlcGFyYXRlLgogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5MiAtIFRoZSBCb2R5IG9iamVjdCB0byBzZXBhcmF0ZS4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gW3Byb2Nlc3NDYWxsYmFjaz1udWxsXSAtIEEgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBsZXRzIHlvdSBwZXJmb3JtIGFkZGl0aW9uYWwgY2hlY2tzIGFnYWluc3QgdGhlIHR3byBvYmplY3RzIGlmIHRoZXkgb3ZlcmxhcC4gSWYgdGhpcyBmdW5jdGlvbiBpcyBzZXQgdGhlbiB0aGUgc3ByaXRlcyB3aWxsIG9ubHkgYmUgY29sbGlkZWQgaWYgaXQgcmV0dXJucyB0cnVlLgogICAgKiBAcGFyYW0ge29iamVjdH0gW2NhbGxiYWNrQ29udGV4dF0gLSBUaGUgY29udGV4dCBpbiB3aGljaCB0byBydW4gdGhlIHByb2Nlc3MgY2FsbGJhY2suCiAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdGhlIGJvZGllcyBjb2xsaWRlZCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIHNlcGFyYXRlOiBmdW5jdGlvbiAoYm9keTEsIGJvZHkyLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlcmxhcE9ubHkpIHsKCiAgICAgICAgaWYgKGJvZHkxID09PSBib2R5MiB8fCB0aGlzLmludGVyc2VjdHMoYm9keTEsIGJvZHkyKSA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICAvLyAgVGhleSBvdmVybGFwLiBJcyB0aGVyZSBhIGN1c3RvbSBwcm9jZXNzIGNhbGxiYWNrPyBJZiBpdCByZXR1cm5zIHRydWUgdGhlbiB3ZSBjYW4gY2Fycnkgb24sIG90aGVyd2lzZSB3ZSBzaG91bGQgYWJvcnQuCiAgICAgICAgaWYgKHByb2Nlc3NDYWxsYmFjayAmJiBwcm9jZXNzQ2FsbGJhY2suY2FsbChjYWxsYmFja0NvbnRleHQsIGJvZHkxLnNwcml0ZSwgYm9keTIuc3ByaXRlKSA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9yZXNwb25zZS5jbGVhcigpOwoKICAgICAgICBpZiAob3ZlcmxhcE9ubHkpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gYm9keTEub3ZlcmxhcChib2R5MiwgdGhpcy5fcmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoYm9keTEub3ZlcmxhcChib2R5MiwgdGhpcy5fcmVzcG9uc2UpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gYm9keTEuc2VwYXJhdGUoYm9keTIsIHRoaXMuX3Jlc3BvbnNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFBlcmZvcm1zIGEgcmVjdCBpbnRlcnNlY3Rpb24gdGVzdCBhZ2FpbnN0IHRoZSB0d28gb2JqZWN0cy4KICAgICogT2JqZWN0cyBtdXN0IGV4cG9zZSBwcm9wZXJ0aWVzOiB3aWR0aCwgaGVpZ2h0LCBsZWZ0LCByaWdodCwgdG9wLCBib3R0b20uCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2ludGVyc2VjdHMKICAgICogQHBhcmFtIHtvYmplY3R9IGEgLSBUaGUgZmlyc3Qgb2JqZWN0IHRvIHRlc3QuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBiIC0gVGhlIHNlY29uZCBvYmplY3QgdG8gdGVzdC4KICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB0aGUgb2JqZWN0cyBpbnRlcnNlY3QsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBpbnRlcnNlY3RzOiBmdW5jdGlvbiAoYSwgYikgewoKICAgICAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CgogICAgICAgIGlmIChhLndpZHRoIDw9IDAgfHwgYS5oZWlnaHQgPD0gMCB8fCBiLndpZHRoIDw9IDAgfHwgYi5oZWlnaHQgPD0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgcmVzdWx0ID0gIShhLnJpZ2h0IDwgYi5sZWZ0IHx8IGEuYm90dG9tIDwgYi50b3AgfHwgYS5sZWZ0ID4gYi5yaWdodCB8fCBhLnRvcCA+IGIuYm90dG9tKTsKCiAgICAgICAgaWYgKCFyZXN1bHQgJiYgYS5pbkNvbnRhY3QoYikpCiAgICAgICAgewogICAgICAgICAgICBhLnJlbW92ZUNvbnRhY3QoYik7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFBlcmZvcm1zIGEgcmVjdCBpbnRlcnNlY3Rpb24gdGVzdCBhZ2FpbnN0IHRoZSB0d28gb2JqZWN0cy4KICAgICogT2JqZWN0cyBtdXN0IGV4cG9zZSBwcm9wZXJ0aWVzOiB3aWR0aCwgaGVpZ2h0LCBsZWZ0LCByaWdodCwgdG9wLCBib3R0b20uCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3RpbGVJbnRlcnNlY3RzCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBib2R5IC0gVGhlIEJvZHkgdG8gdGVzdC4KICAgICogQHBhcmFtIHtvYmplY3R9IHRpbGUgLSBUaGUgVGlsZSB0byB0ZXN0LgogICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHRoZSBvYmplY3RzIGludGVyc2VjdCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIHRpbGVJbnRlcnNlY3RzOiBmdW5jdGlvbiAoYm9keSwgdGlsZSkgewoKICAgICAgICBpZiAoYm9keS53aWR0aCA8PSAwIHx8IGJvZHkuaGVpZ2h0IDw9IDAgfHwgdGlsZS53aWR0aCA8PSAwIHx8IHRpbGUuaGVpZ2h0IDw9IDApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9pbnRlcnNlY3Rpb25bNF0gPSAwOwogICAgICAgICAgICByZXR1cm4gdGhpcy5faW50ZXJzZWN0aW9uOwogICAgICAgIH0KCiAgICAgICAgaWYgKCEoYm9keS5yaWdodCA8IHRpbGUueCB8fCBib2R5LmJvdHRvbSA8IHRpbGUueSB8fCBib2R5LmxlZnQgPiB0aWxlLnJpZ2h0IHx8IGJvZHkudG9wID4gdGlsZS5ib3R0b20pKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJzZWN0aW9uWzBdID0gTWF0aC5tYXgoYm9keS5sZWZ0LCB0aWxlLngpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHgKICAgICAgICAgICAgdGhpcy5faW50ZXJzZWN0aW9uWzFdID0gTWF0aC5tYXgoYm9keS50b3AsIHRpbGUueSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHkKICAgICAgICAgICAgdGhpcy5faW50ZXJzZWN0aW9uWzJdID0gTWF0aC5taW4oYm9keS5yaWdodCwgdGlsZS5yaWdodCkgLSB0aGlzLl9pbnRlcnNlY3Rpb25bMF07ICAgICAgIC8vIHdpZHRoCiAgICAgICAgICAgIHRoaXMuX2ludGVyc2VjdGlvblszXSA9IE1hdGgubWluKGJvZHkuYm90dG9tLCB0aWxlLmJvdHRvbSkgLSB0aGlzLl9pbnRlcnNlY3Rpb25bMV07ICAgICAvLyBoZWlnaHQKICAgICAgICAgICAgdGhpcy5faW50ZXJzZWN0aW9uWzRdID0gMTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbnRlcnNlY3Rpb247CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9pbnRlcnNlY3Rpb25bNF0gPSAwOwoKICAgICAgICByZXR1cm4gdGhpcy5faW50ZXJzZWN0aW9uOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBjb3JlIHNlcGFyYXRpb24gZnVuY3Rpb24gdG8gc2VwYXJhdGUgYSBwaHlzaWNzIGJvZHkgYW5kIGFuIGFycmF5IG9mIHRpbGVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNzZXBhcmF0ZVRpbGVzCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkgLSBUaGUgQm9keSBvYmplY3QgdG8gc2VwYXJhdGUuCiAgICAqIEBwYXJhbSB7YXJyYXk8UGhhc2VyLlRpbGU+fSB0aWxlcyAtIFRoZSBhcnJheSBvZiB0aWxlcyB0byBjb2xsaWRlIGFnYWluc3QuCiAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdGhlIGJvZHkgd2FzIHNlcGFyYXRlZCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIHNlcGFyYXRlVGlsZXM6IGZ1bmN0aW9uIChib2R5LCB0aWxlcykgewoKICAgICAgICB2YXIgdGlsZTsKICAgICAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGlsZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aWxlID0gdGlsZXNbaV07CgogICAgICAgICAgICBpZiAodGhpcy5zZXBhcmF0ZVRpbGUoYm9keSwgdGlsZSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQ7CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIGNvcmUgc2VwYXJhdGlvbiBmdW5jdGlvbiB0byBzZXBhcmF0ZSBhIHBoeXNpY3MgYm9keSBhbmQgYSB0aWxlLgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNzZXBhcmF0ZVRpbGUKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IG9iamVjdCB0byBzZXBhcmF0ZS4KICAgICogQHBhcmFtIHtQaGFzZXIuVGlsZX0gdGlsZSAtIFRoZSB0aWxlIHRvIGNvbGxpZGUgYWdhaW5zdC4KICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB0aGUgYm9keSB3YXMgc2VwYXJhdGVkLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgc2VwYXJhdGVUaWxlOiBmdW5jdGlvbiAoYm9keSwgdGlsZSkgewoKICAgICAgICB0aGlzLl9pbnRlcnNlY3Rpb24gPSB0aGlzLnRpbGVJbnRlcnNlY3RzKGJvZHksIHRpbGUpOwoKICAgICAgICAvLyAgSWYgdGhlIGludGVyc2VjdGlvbiBhcmVhIGlzIGVpdGhlciBlbnRpcmVseSBudWxsLCBvciBoYXMgYSB3aWR0aC9oZWlnaHQgb2YgemVybywgd2UgYmFpbCBvdXQgbm93CiAgICAgICAgaWYgKHRoaXMuX2ludGVyc2VjdGlvbls0XSA9PT0gMCB8fCB0aGlzLl9pbnRlcnNlY3Rpb25bMl0gPT09IDAgfHwgdGhpcy5faW50ZXJzZWN0aW9uWzNdID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgLy8gIFRoZXkgb3ZlcmxhcC4gQW55IGN1c3RvbSBjYWxsYmFja3M/CiAgICAgICAgaWYgKHRpbGUudGlsZS5jYWxsYmFjayB8fCB0aWxlLmxheWVyLmNhbGxiYWNrc1t0aWxlLnRpbGUuaW5kZXhdKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIEEgbG9jYWwgY2FsbGJhY2sgdGFrZXMgcHJpb3JpdHkgb3ZlciBhIGdsb2JhbCBjYWxsYmFjay4KICAgICAgICAgICAgaWYgKHRpbGUudGlsZS5jYWxsYmFjayAmJiB0aWxlLnRpbGUuY2FsbGJhY2suY2FsbCh0aWxlLnRpbGUuY2FsbGJhY2tDb250ZXh0LCBib2R5LnNwcml0ZSwgdGlsZSkgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgSXMgdGhlcmUgYSB0aWxlIHNwZWNpZmljIGNvbGxpc2lvbiBjYWxsYmFjaz8gSWYgaXQgcmV0dXJucyB0cnVlIHRoZW4gd2UgY2FuIGNhcnJ5IG9uLCBvdGhlcndpc2Ugd2Ugc2hvdWxkIGFib3J0LgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRpbGUubGF5ZXIuY2FsbGJhY2tzW3RpbGUudGlsZS5pbmRleF0gJiYgdGlsZS5sYXllci5jYWxsYmFja3NbdGlsZS50aWxlLmluZGV4XS5jYWxsYmFjay5jYWxsKHRpbGUubGF5ZXIuY2FsbGJhY2tzW3RpbGUudGlsZS5pbmRleF0uY2FsbGJhY2tDb250ZXh0LCBib2R5LnNwcml0ZSwgdGlsZSkgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgSXMgdGhlcmUgYSB0aWxlIGluZGV4IGNvbGxpc2lvbiBjYWxsYmFjaz8gSWYgaXQgcmV0dXJucyB0cnVlIHRoZW4gd2UgY2FuIGNhcnJ5IG9uLCBvdGhlcndpc2Ugd2Ugc2hvdWxkIGFib3J0LgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBib2R5Lm92ZXJsYXBYID0gMDsKICAgICAgICBib2R5Lm92ZXJsYXBZID0gMDsKCiAgICAgICAgdmFyIHByb2Nlc3MgPSBmYWxzZTsKCiAgICAgICAgaWYgKGJvZHkuZGVsdGFYKCkgPCAwICYmIGJvZHkuY2hlY2tDb2xsaXNpb24ubGVmdCAmJiB0aWxlLnRpbGUuZmFjZVJpZ2h0ICYmICFib2R5LmJsb2NrZWQubGVmdCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBMRUZUCiAgICAgICAgICAgIGJvZHkub3ZlcmxhcFggPSBib2R5LmxlZnQgLSB0aWxlLnJpZ2h0OwoKICAgICAgICAgICAgaWYgKGJvZHkub3ZlcmxhcFggPCAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwcm9jZXNzID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJvZHkub3ZlcmxhcFggPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGJvZHkuZGVsdGFYKCkgPiAwICYmIGJvZHkuY2hlY2tDb2xsaXNpb24ucmlnaHQgJiYgdGlsZS50aWxlLmZhY2VMZWZ0ICYmICFib2R5LmJsb2NrZWQucmlnaHQpCiAgICAgICAgewogICAgICAgICAgICAvLyAgUklHSFQKICAgICAgICAgICAgYm9keS5vdmVybGFwWCA9IGJvZHkucmlnaHQgLSB0aWxlLng7CgogICAgICAgICAgICBpZiAoYm9keS5vdmVybGFwWCA+IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHByb2Nlc3MgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYm9keS5vdmVybGFwWCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChib2R5LmRlbHRhWSgpIDwgMCAmJiBib2R5LmNoZWNrQ29sbGlzaW9uLnVwICYmIHRpbGUudGlsZS5mYWNlQm90dG9tICYmICFib2R5LmJsb2NrZWQudXApCiAgICAgICAgewogICAgICAgICAgICAvLyAgVVAKICAgICAgICAgICAgYm9keS5vdmVybGFwWSA9IGJvZHkudG9wIC0gdGlsZS5ib3R0b207CgogICAgICAgICAgICBpZiAoYm9keS5vdmVybGFwWSA8IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHByb2Nlc3MgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYm9keS5vdmVybGFwWSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYm9keS5kZWx0YVkoKSA+IDAgJiYgYm9keS5jaGVja0NvbGxpc2lvbi5kb3duICYmIHRpbGUudGlsZS5mYWNlVG9wICYmICFib2R5LmJsb2NrZWQuZG93bikKICAgICAgICB7CiAgICAgICAgICAgIC8vICBET1dOCiAgICAgICAgICAgIGJvZHkub3ZlcmxhcFkgPSBib2R5LmJvdHRvbSAtIHRpbGUueTsKCiAgICAgICAgICAgIGlmIChib2R5Lm92ZXJsYXBZID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcHJvY2VzcyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib2R5Lm92ZXJsYXBZID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gIE9ubHkgc2VwYXJhdGUgb24gdGhlIHNtYWxsZXN0IG9mIHRoZSB0d28gdmFsdWVzIGlmIGl0J3MgYSBzaW5nbGUgdGlsZQogICAgICAgIGlmIChib2R5Lm92ZXJsYXBYICE9PSAwICYmIGJvZHkub3ZlcmxhcFkgIT09IDApCiAgICAgICAgewogICAgICAgICAgICBpZiAoTWF0aC5hYnMoYm9keS5vdmVybGFwWCkgPiBNYXRoLmFicyhib2R5Lm92ZXJsYXBZKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYm9keS5vdmVybGFwWCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib2R5Lm92ZXJsYXBZID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gIFNlcGFyYXRlIGluIGEgc2luZ2xlIHN3ZWVwCiAgICAgICAgaWYgKHByb2Nlc3MpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wcm9jZXNzVGlsZVNlcGFyYXRpb24oYm9keSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgZnVuY3Rpb24gdG8gcHJvY2VzcyB0aGUgc2VwYXJhdGlvbiBvZiBhIHBoeXNpY3MgYm9keSBmcm9tIGEgdGlsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjcHJvY2Vzc1RpbGVTZXBhcmF0aW9uCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keTEgLSBUaGUgQm9keSBvYmplY3QgdG8gc2VwYXJhdGUuCiAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgc2VwYXJhdGVkLCBmYWxzZSBpZiBub3QuCiAgICAqLwogICAgcHJvY2Vzc1RpbGVTZXBhcmF0aW9uOiBmdW5jdGlvbiAoYm9keSkgewoKICAgICAgICBpZiAoYm9keS5vdmVybGFwWCA8IDApCiAgICAgICAgewogICAgICAgICAgICBib2R5LnggLT0gYm9keS5vdmVybGFwWDsKICAgICAgICAgICAgYm9keS5sZWZ0IC09IGJvZHkub3ZlcmxhcFg7CiAgICAgICAgICAgIGJvZHkucmlnaHQgLT0gYm9keS5vdmVybGFwWDsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnggPSBNYXRoLmZsb29yKGJvZHkueCk7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC55ID0gTWF0aC5mbG9vcihib2R5LnkpOwogICAgICAgICAgICBib2R5LmJsb2NrZWQubGVmdCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGJvZHkub3ZlcmxhcFggPiAwKQogICAgICAgIHsKICAgICAgICAgICAgYm9keS54IC09IGJvZHkub3ZlcmxhcFg7CiAgICAgICAgICAgIGJvZHkubGVmdCAtPSBib2R5Lm92ZXJsYXBYOwogICAgICAgICAgICBib2R5LnJpZ2h0IC09IGJvZHkub3ZlcmxhcFg7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC54ID0gTWF0aC5mbG9vcihib2R5LngpOwogICAgICAgICAgICBib2R5LmJsb2NrZWQueSA9IE1hdGguZmxvb3IoYm9keS55KTsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnJpZ2h0ID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmIChib2R5Lm92ZXJsYXBZIDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIGJvZHkueSAtPSBib2R5Lm92ZXJsYXBZOwogICAgICAgICAgICBib2R5LnRvcCAtPSBib2R5Lm92ZXJsYXBZOwogICAgICAgICAgICBib2R5LmJvdHRvbSAtPSBib2R5Lm92ZXJsYXBZOwogICAgICAgICAgICBib2R5LmJsb2NrZWQueCA9IE1hdGguZmxvb3IoYm9keS54KTsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnkgPSBNYXRoLmZsb29yKGJvZHkueSk7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC51cCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGJvZHkub3ZlcmxhcFkgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgYm9keS55IC09IGJvZHkub3ZlcmxhcFk7CiAgICAgICAgICAgIGJvZHkudG9wIC09IGJvZHkub3ZlcmxhcFk7CiAgICAgICAgICAgIGJvZHkuYm90dG9tIC09IGJvZHkub3ZlcmxhcFk7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC54ID0gTWF0aC5mbG9vcihib2R5LngpOwogICAgICAgICAgICBib2R5LmJsb2NrZWQueSA9IE1hdGguZmxvb3IoYm9keS55KTsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLmRvd24gPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgYm9keS5yZWJvdW5kQ2hlY2soYm9keS5vdmVybGFwWCwgYm9keS5vdmVybGFwWSwgdHJ1ZSk7CgogICAgICAgIHJldHVybiB0cnVlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIE1vdmUgdGhlIGdpdmVuIGRpc3BsYXkgb2JqZWN0IHRvd2FyZHMgdGhlIGRlc3RpbmF0aW9uIG9iamVjdCBhdCBhIHN0ZWFkeSB2ZWxvY2l0eS4KICAgICogSWYgeW91IHNwZWNpZnkgYSBtYXhUaW1lIHRoZW4gaXQgd2lsbCBhZGp1c3QgdGhlIHNwZWVkIChvdmVyLXdyaXRpbmcgd2hhdCB5b3Ugc2V0KSBzbyBpdCBhcnJpdmVzIGF0IHRoZSBkZXN0aW5hdGlvbiBpbiB0aGF0IG51bWJlciBvZiBzZWNvbmRzLgogICAgKiBUaW1pbmdzIGFyZSBhcHByb3hpbWF0ZSBkdWUgdG8gdGhlIHdheSBicm93c2VyIHRpbWVycyB3b3JrLiBBbGxvdyBmb3IgYSB2YXJpYW5jZSBvZiArLSA1MG1zLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lcyBub3QgY29udGludW91c2x5IHRyYWNrIHRoZSB0YXJnZXQuIElmIHRoZSB0YXJnZXQgY2hhbmdlcyBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdCB0aGUgZGlzcGxheSBvYmplY3Qgd2lsbCBub3QgbW9kaWZ5IGl0cyBjb3Vyc2UuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2Vzbid0IHN0b3AgbW92aW5nIG9uY2UgaXQgcmVhY2hlcyB0aGUgZGVzdGluYXRpb24gY29vcmRpbmF0ZXMuCiAgICAqIE5vdGU6IERvZXNuJ3QgdGFrZSBpbnRvIGFjY291bnQgYWNjZWxlcmF0aW9uLCBtYXhWZWxvY2l0eSBvciBkcmFnIChpZiB5b3UndmUgc2V0IGRyYWcgb3IgYWNjZWxlcmF0aW9uIHRvbyBoaWdoIHRoaXMgb2JqZWN0IG1heSBub3QgbW92ZSBhdCBhbGwpCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNtb3ZlVG9PYmplY3QKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZS4KICAgICogQHBhcmFtIHthbnl9IGRlc3RpbmF0aW9uIC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIG1vdmUgdG93YXJkcy4gQ2FuIGJlIGFueSBvYmplY3QgYnV0IG11c3QgaGF2ZSB2aXNpYmxlIHgveSBwcm9wZXJ0aWVzLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkPTYwXSAtIFRoZSBzcGVlZCBpdCB3aWxsIG1vdmUsIGluIHBpeGVscyBwZXIgc2Vjb25kIChkZWZhdWx0IGlzIDYwIHBpeGVscy9zZWMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWF4VGltZT0wXSAtIFRpbWUgZ2l2ZW4gaW4gbWlsbGlzZWNvbmRzICgxMDAwID0gMSBzZWMpLiBJZiBzZXQgdGhlIHNwZWVkIGlzIGFkanVzdGVkIHNvIHRoZSBvYmplY3Qgd2lsbCBhcnJpdmUgYXQgZGVzdGluYXRpb24gaW4gdGhlIGdpdmVuIG51bWJlciBvZiBtcy4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgKGluIHJhZGlhbnMpIHRoYXQgdGhlIG9iamVjdCBzaG91bGQgYmUgdmlzdWFsbHkgc2V0IHRvIGluIG9yZGVyIHRvIG1hdGNoIGl0cyBuZXcgdmVsb2NpdHkuCiAgICAqLwogICAgbW92ZVRvT2JqZWN0OiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgZGVzdGluYXRpb24sIHNwZWVkLCBtYXhUaW1lKSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBpZiAodHlwZW9mIG1heFRpbWUgPT09ICd1bmRlZmluZWQnKSB7IG1heFRpbWUgPSAwOyB9CgogICAgICAgIHRoaXMuX2FuZ2xlID0gTWF0aC5hdGFuMihkZXN0aW5hdGlvbi55IC0gZGlzcGxheU9iamVjdC55LCBkZXN0aW5hdGlvbi54IC0gZGlzcGxheU9iamVjdC54KTsKICAgICAgICAKICAgICAgICBpZiAobWF4VGltZSA+IDApCiAgICAgICAgewogICAgICAgICAgICAvLyAgV2Uga25vdyBob3cgbWFueSBwaXhlbHMgd2UgbmVlZCB0byBtb3ZlLCBidXQgaG93IGZhc3Q/CiAgICAgICAgICAgIHNwZWVkID0gdGhpcy5kaXN0YW5jZUJldHdlZW4oZGlzcGxheU9iamVjdCwgZGVzdGluYXRpb24pIC8gKG1heFRpbWUgLyAxMDAwKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5LnZlbG9jaXR5LnggPSBNYXRoLmNvcyh0aGlzLl9hbmdsZSkgKiBzcGVlZDsKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkudmVsb2NpdHkueSA9IE1hdGguc2luKHRoaXMuX2FuZ2xlKSAqIHNwZWVkOwoKICAgICAgICByZXR1cm4gdGhpcy5fYW5nbGU7CgogICAgfSwKCiAgICAvKioKICAgICogTW92ZSB0aGUgZ2l2ZW4gZGlzcGxheSBvYmplY3QgdG93YXJkcyB0aGUgcG9pbnRlciBhdCBhIHN0ZWFkeSB2ZWxvY2l0eS4gSWYgbm8gcG9pbnRlciBpcyBnaXZlbiBpdCB3aWxsIHVzZSBQaGFzZXIuSW5wdXQuYWN0aXZlUG9pbnRlci4KICAgICogSWYgeW91IHNwZWNpZnkgYSBtYXhUaW1lIHRoZW4gaXQgd2lsbCBhZGp1c3QgdGhlIHNwZWVkIChvdmVyLXdyaXRpbmcgd2hhdCB5b3Ugc2V0KSBzbyBpdCBhcnJpdmVzIGF0IHRoZSBkZXN0aW5hdGlvbiBpbiB0aGF0IG51bWJlciBvZiBzZWNvbmRzLgogICAgKiBUaW1pbmdzIGFyZSBhcHByb3hpbWF0ZSBkdWUgdG8gdGhlIHdheSBicm93c2VyIHRpbWVycyB3b3JrLiBBbGxvdyBmb3IgYSB2YXJpYW5jZSBvZiArLSA1MG1zLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lcyBub3QgY29udGludW91c2x5IHRyYWNrIHRoZSB0YXJnZXQuIElmIHRoZSB0YXJnZXQgY2hhbmdlcyBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdCB0aGUgZGlzcGxheSBvYmplY3Qgd2lsbCBub3QgbW9kaWZ5IGl0cyBjb3Vyc2UuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2Vzbid0IHN0b3AgbW92aW5nIG9uY2UgaXQgcmVhY2hlcyB0aGUgZGVzdGluYXRpb24gY29vcmRpbmF0ZXMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNtb3ZlVG9Qb2ludGVyCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIG1vdmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BlZWQ9NjBdIC0gVGhlIHNwZWVkIGl0IHdpbGwgbW92ZSwgaW4gcGl4ZWxzIHBlciBzZWNvbmQgKGRlZmF1bHQgaXMgNjAgcGl4ZWxzL3NlYykKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gW3BvaW50ZXJdIC0gVGhlIHBvaW50ZXIgdG8gbW92ZSB0b3dhcmRzLiBEZWZhdWx0cyB0byBQaGFzZXIuSW5wdXQuYWN0aXZlUG9pbnRlci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFttYXhUaW1lPTBdIC0gVGltZSBnaXZlbiBpbiBtaWxsaXNlY29uZHMgKDEwMDAgPSAxIHNlYykuIElmIHNldCB0aGUgc3BlZWQgaXMgYWRqdXN0ZWQgc28gdGhlIG9iamVjdCB3aWxsIGFycml2ZSBhdCBkZXN0aW5hdGlvbiBpbiB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1zLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSAoaW4gcmFkaWFucykgdGhhdCB0aGUgb2JqZWN0IHNob3VsZCBiZSB2aXN1YWxseSBzZXQgdG8gaW4gb3JkZXIgdG8gbWF0Y2ggaXRzIG5ldyB2ZWxvY2l0eS4KICAgICovCiAgICBtb3ZlVG9Qb2ludGVyOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgc3BlZWQsIHBvaW50ZXIsIG1heFRpbWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCA9PT0gJ3VuZGVmaW5lZCcpIHsgc3BlZWQgPSA2MDsgfQogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IHRoaXMuZ2FtZS5pbnB1dC5hY3RpdmVQb2ludGVyOwogICAgICAgIGlmICh0eXBlb2YgbWF4VGltZSA9PT0gJ3VuZGVmaW5lZCcpIHsgbWF4VGltZSA9IDA7IH0KCiAgICAgICAgdGhpcy5fYW5nbGUgPSB0aGlzLmFuZ2xlVG9Qb2ludGVyKGRpc3BsYXlPYmplY3QsIHBvaW50ZXIpOwogICAgICAgIAogICAgICAgIGlmIChtYXhUaW1lID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBXZSBrbm93IGhvdyBtYW55IHBpeGVscyB3ZSBuZWVkIHRvIG1vdmUsIGJ1dCBob3cgZmFzdD8KICAgICAgICAgICAgc3BlZWQgPSB0aGlzLmRpc3RhbmNlVG9Qb2ludGVyKGRpc3BsYXlPYmplY3QsIHBvaW50ZXIpIC8gKG1heFRpbWUgLyAxMDAwKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5LnZlbG9jaXR5LnggPSBNYXRoLmNvcyh0aGlzLl9hbmdsZSkgKiBzcGVlZDsKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkudmVsb2NpdHkueSA9IE1hdGguc2luKHRoaXMuX2FuZ2xlKSAqIHNwZWVkOwoKICAgICAgICByZXR1cm4gdGhpcy5fYW5nbGU7CgogICAgfSwKCiAgICAvKioKICAgICogTW92ZSB0aGUgZ2l2ZW4gZGlzcGxheSBvYmplY3QgdG93YXJkcyB0aGUgeC95IGNvb3JkaW5hdGVzIGF0IGEgc3RlYWR5IHZlbG9jaXR5LgogICAgKiBJZiB5b3Ugc3BlY2lmeSBhIG1heFRpbWUgdGhlbiBpdCB3aWxsIGFkanVzdCB0aGUgc3BlZWQgKG92ZXItd3JpdGluZyB3aGF0IHlvdSBzZXQpIHNvIGl0IGFycml2ZXMgYXQgdGhlIGRlc3RpbmF0aW9uIGluIHRoYXQgbnVtYmVyIG9mIHNlY29uZHMuCiAgICAqIFRpbWluZ3MgYXJlIGFwcHJveGltYXRlIGR1ZSB0byB0aGUgd2F5IGJyb3dzZXIgdGltZXJzIHdvcmsuIEFsbG93IGZvciBhIHZhcmlhbmNlIG9mICstIDUwbXMuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2VzIG5vdCBjb250aW51b3VzbHkgdHJhY2sgdGhlIHRhcmdldC4gSWYgdGhlIHRhcmdldCBjaGFuZ2VzIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0IHRoZSBkaXNwbGF5IG9iamVjdCB3aWxsIG5vdCBtb2RpZnkgaXRzIGNvdXJzZS4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXNuJ3Qgc3RvcCBtb3Zpbmcgb25jZSBpdCByZWFjaGVzIHRoZSBkZXN0aW5hdGlvbiBjb29yZGluYXRlcy4KICAgICogTm90ZTogRG9lc24ndCB0YWtlIGludG8gYWNjb3VudCBhY2NlbGVyYXRpb24sIG1heFZlbG9jaXR5IG9yIGRyYWcgKGlmIHlvdSd2ZSBzZXQgZHJhZyBvciBhY2NlbGVyYXRpb24gdG9vIGhpZ2ggdGhpcyBvYmplY3QgbWF5IG5vdCBtb3ZlIGF0IGFsbCkKICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI21vdmVUb1hZCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIG1vdmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSB0byBtb3ZlIHRvd2FyZHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSB0byBtb3ZlIHRvd2FyZHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BlZWQ9NjBdIC0gVGhlIHNwZWVkIGl0IHdpbGwgbW92ZSwgaW4gcGl4ZWxzIHBlciBzZWNvbmQgKGRlZmF1bHQgaXMgNjAgcGl4ZWxzL3NlYykKICAgICogQHBhcmFtIHtudW1iZXJ9IFttYXhUaW1lPTBdIC0gVGltZSBnaXZlbiBpbiBtaWxsaXNlY29uZHMgKDEwMDAgPSAxIHNlYykuIElmIHNldCB0aGUgc3BlZWQgaXMgYWRqdXN0ZWQgc28gdGhlIG9iamVjdCB3aWxsIGFycml2ZSBhdCBkZXN0aW5hdGlvbiBpbiB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1zLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSAoaW4gcmFkaWFucykgdGhhdCB0aGUgb2JqZWN0IHNob3VsZCBiZSB2aXN1YWxseSBzZXQgdG8gaW4gb3JkZXIgdG8gbWF0Y2ggaXRzIG5ldyB2ZWxvY2l0eS4KICAgICovCiAgICBtb3ZlVG9YWTogZnVuY3Rpb24gKGRpc3BsYXlPYmplY3QsIHgsIHksIHNwZWVkLCBtYXhUaW1lKSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBpZiAodHlwZW9mIG1heFRpbWUgPT09ICd1bmRlZmluZWQnKSB7IG1heFRpbWUgPSAwOyB9CgogICAgICAgIHRoaXMuX2FuZ2xlID0gTWF0aC5hdGFuMih5IC0gZGlzcGxheU9iamVjdC55LCB4IC0gZGlzcGxheU9iamVjdC54KTsKICAgICAgICAKICAgICAgICBpZiAobWF4VGltZSA+IDApCiAgICAgICAgewogICAgICAgICAgICAvLyAgV2Uga25vdyBob3cgbWFueSBwaXhlbHMgd2UgbmVlZCB0byBtb3ZlLCBidXQgaG93IGZhc3Q/CiAgICAgICAgICAgIHNwZWVkID0gdGhpcy5kaXN0YW5jZVRvWFkoZGlzcGxheU9iamVjdCwgeCwgeSkgLyAobWF4VGltZSAvIDEwMDApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkudmVsb2NpdHkueCA9IE1hdGguY29zKHRoaXMuX2FuZ2xlKSAqIHNwZWVkOwogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS52ZWxvY2l0eS55ID0gTWF0aC5zaW4odGhpcy5fYW5nbGUpICogc3BlZWQ7CgogICAgICAgIHJldHVybiB0aGlzLl9hbmdsZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiB0aGUgYW5nbGUgKGluIGRlZ3JlZXMpIGFuZCBzcGVlZCBjYWxjdWxhdGUgdGhlIHZlbG9jaXR5IGFuZCByZXR1cm4gaXQgYXMgYSBQb2ludCBvYmplY3QsIG9yIHNldCBpdCB0byB0aGUgZ2l2ZW4gcG9pbnQgb2JqZWN0LgogICAgKiBPbmUgd2F5IHRvIHVzZSB0aGlzIGlzOiB2ZWxvY2l0eUZyb21BbmdsZShhbmdsZSwgMjAwLCBzcHJpdGUudmVsb2NpdHkpIHdoaWNoIHdpbGwgc2V0IHRoZSB2YWx1ZXMgZGlyZWN0bHkgdG8gdGhlIHNwcml0ZXMgdmVsb2NpdHkgYW5kIG5vdCBjcmVhdGUgYSBuZXcgUG9pbnQgb2JqZWN0LgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjdmVsb2NpdHlGcm9tQW5nbGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIGRlZ3JlZXMgY2FsY3VsYXRlZCBpbiBjbG9ja3dpc2UgcG9zaXRpdmUgZGlyZWN0aW9uIChkb3duID0gOTAgZGVncmVlcyBwb3NpdGl2ZSwgcmlnaHQgPSAwIGRlZ3JlZXMgcG9zaXRpdmUsIHVwID0gOTAgZGVncmVlcyBuZWdhdGl2ZSkKICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBtb3ZlLCBpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR8b2JqZWN0fSBbcG9pbnRdIC0gVGhlIFBvaW50IG9iamVjdCBpbiB3aGljaCB0aGUgeCBhbmQgeSBwcm9wZXJ0aWVzIHdpbGwgYmUgc2V0IHRvIHRoZSBjYWxjdWxhdGVkIHZlbG9jaXR5LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IC0gQSBQb2ludCB3aGVyZSBwb2ludC54IGNvbnRhaW5zIHRoZSB2ZWxvY2l0eSB4IHZhbHVlIGFuZCBwb2ludC55IGNvbnRhaW5zIHRoZSB2ZWxvY2l0eSB5IHZhbHVlLgogICAgKi8KICAgIHZlbG9jaXR5RnJvbUFuZ2xlOiBmdW5jdGlvbiAoYW5nbGUsIHNwZWVkLCBwb2ludCkgewoKICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgeyBzcGVlZCA9IDYwOyB9CiAgICAgICAgcG9pbnQgPSBwb2ludCB8fCBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgICAgIHJldHVybiBwb2ludC5zZXRUbygoTWF0aC5jb3ModGhpcy5nYW1lLm1hdGguZGVnVG9SYWQoYW5nbGUpKSAqIHNwZWVkKSwgKE1hdGguc2luKHRoaXMuZ2FtZS5tYXRoLmRlZ1RvUmFkKGFuZ2xlKSkgKiBzcGVlZCkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdpdmVuIHRoZSByb3RhdGlvbiAoaW4gcmFkaWFucykgYW5kIHNwZWVkIGNhbGN1bGF0ZSB0aGUgdmVsb2NpdHkgYW5kIHJldHVybiBpdCBhcyBhIFBvaW50IG9iamVjdCwgb3Igc2V0IGl0IHRvIHRoZSBnaXZlbiBwb2ludCBvYmplY3QuCiAgICAqIE9uZSB3YXkgdG8gdXNlIHRoaXMgaXM6IHZlbG9jaXR5RnJvbVJvdGF0aW9uKHJvdGF0aW9uLCAyMDAsIHNwcml0ZS52ZWxvY2l0eSkgd2hpY2ggd2lsbCBzZXQgdGhlIHZhbHVlcyBkaXJlY3RseSB0byB0aGUgc3ByaXRlcyB2ZWxvY2l0eSBhbmQgbm90IGNyZWF0ZSBhIG5ldyBQb2ludCBvYmplY3QuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSN2ZWxvY2l0eUZyb21Sb3RhdGlvbgogICAgKiBAcGFyYW0ge251bWJlcn0gcm90YXRpb24gLSBUaGUgYW5nbGUgaW4gcmFkaWFucy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBtb3ZlLCBpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR8b2JqZWN0fSBbcG9pbnRdIC0gVGhlIFBvaW50IG9iamVjdCBpbiB3aGljaCB0aGUgeCBhbmQgeSBwcm9wZXJ0aWVzIHdpbGwgYmUgc2V0IHRvIHRoZSBjYWxjdWxhdGVkIHZlbG9jaXR5LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IC0gQSBQb2ludCB3aGVyZSBwb2ludC54IGNvbnRhaW5zIHRoZSB2ZWxvY2l0eSB4IHZhbHVlIGFuZCBwb2ludC55IGNvbnRhaW5zIHRoZSB2ZWxvY2l0eSB5IHZhbHVlLgogICAgKi8KICAgIHZlbG9jaXR5RnJvbVJvdGF0aW9uOiBmdW5jdGlvbiAocm90YXRpb24sIHNwZWVkLCBwb2ludCkgewoKICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgeyBzcGVlZCA9IDYwOyB9CiAgICAgICAgcG9pbnQgPSBwb2ludCB8fCBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgICAgIHJldHVybiBwb2ludC5zZXRUbygoTWF0aC5jb3Mocm90YXRpb24pICogc3BlZWQpLCAoTWF0aC5zaW4ocm90YXRpb24pICogc3BlZWQpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiB0aGUgcm90YXRpb24gKGluIHJhZGlhbnMpIGFuZCBzcGVlZCBjYWxjdWxhdGUgdGhlIGFjY2VsZXJhdGlvbiBhbmQgcmV0dXJuIGl0IGFzIGEgUG9pbnQgb2JqZWN0LCBvciBzZXQgaXQgdG8gdGhlIGdpdmVuIHBvaW50IG9iamVjdC4KICAgICogT25lIHdheSB0byB1c2UgdGhpcyBpczogYWNjZWxlcmF0aW9uRnJvbVJvdGF0aW9uKHJvdGF0aW9uLCAyMDAsIHNwcml0ZS5hY2NlbGVyYXRpb24pIHdoaWNoIHdpbGwgc2V0IHRoZSB2YWx1ZXMgZGlyZWN0bHkgdG8gdGhlIHNwcml0ZXMgYWNjZWxlcmF0aW9uIGFuZCBub3QgY3JlYXRlIGEgbmV3IFBvaW50IG9iamVjdC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2FjY2VsZXJhdGlvbkZyb21Sb3RhdGlvbgogICAgKiBAcGFyYW0ge251bWJlcn0gcm90YXRpb24gLSBUaGUgYW5nbGUgaW4gcmFkaWFucy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBtb3ZlLCBpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR8b2JqZWN0fSBbcG9pbnRdIC0gVGhlIFBvaW50IG9iamVjdCBpbiB3aGljaCB0aGUgeCBhbmQgeSBwcm9wZXJ0aWVzIHdpbGwgYmUgc2V0IHRvIHRoZSBjYWxjdWxhdGVkIGFjY2VsZXJhdGlvbi4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSAtIEEgUG9pbnQgd2hlcmUgcG9pbnQueCBjb250YWlucyB0aGUgYWNjZWxlcmF0aW9uIHggdmFsdWUgYW5kIHBvaW50LnkgY29udGFpbnMgdGhlIGFjY2VsZXJhdGlvbiB5IHZhbHVlLgogICAgKi8KICAgIGFjY2VsZXJhdGlvbkZyb21Sb3RhdGlvbjogZnVuY3Rpb24gKHJvdGF0aW9uLCBzcGVlZCwgcG9pbnQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCA9PT0gJ3VuZGVmaW5lZCcpIHsgc3BlZWQgPSA2MDsgfQogICAgICAgIHBvaW50ID0gcG9pbnQgfHwgbmV3IFBoYXNlci5Qb2ludCgpOwoKICAgICAgICByZXR1cm4gcG9pbnQuc2V0VG8oKE1hdGguY29zKHJvdGF0aW9uKSAqIHNwZWVkKSwgKE1hdGguc2luKHJvdGF0aW9uKSAqIHNwZWVkKSk7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgYWNjZWxlcmF0aW9uLngveSBwcm9wZXJ0eSBvbiB0aGUgZGlzcGxheSBvYmplY3Qgc28gaXQgd2lsbCBtb3ZlIHRvd2FyZHMgdGhlIHRhcmdldCBhdCB0aGUgZ2l2ZW4gc3BlZWQgKGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLikKICAgICogWW91IG11c3QgZ2l2ZSBhIG1heGltdW0gc3BlZWQgdmFsdWUsIGJleW9uZCB3aGljaCB0aGUgZGlzcGxheSBvYmplY3Qgd29uJ3QgZ28gYW55IGZhc3Rlci4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXMgbm90IGNvbnRpbnVvdXNseSB0cmFjayB0aGUgdGFyZ2V0LiBJZiB0aGUgdGFyZ2V0IGNoYW5nZXMgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXQgdGhlIGRpc3BsYXkgb2JqZWN0IHdpbGwgbm90IG1vZGlmeSBpdHMgY291cnNlLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lc24ndCBzdG9wIG1vdmluZyBvbmNlIGl0IHJlYWNoZXMgdGhlIGRlc3RpbmF0aW9uIGNvb3JkaW5hdGVzLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjYWNjZWxlcmF0ZVRvT2JqZWN0CiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIG1vdmUuCiAgICAqIEBwYXJhbSB7YW55fSBkZXN0aW5hdGlvbiAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byBtb3ZlIHRvd2FyZHMuIENhbiBiZSBhbnkgb2JqZWN0IGJ1dCBtdXN0IGhhdmUgdmlzaWJsZSB4L3kgcHJvcGVydGllcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBhY2NlbGVyYXRlIGluIHBpeGVscyBwZXIgc2Vjb25kLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3hTcGVlZE1heD01MDBdIC0gVGhlIG1heGltdW0geCB2ZWxvY2l0eSB0aGUgZGlzcGxheSBvYmplY3QgY2FuIHJlYWNoLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3lTcGVlZE1heD01MDBdIC0gVGhlIG1heGltdW0geSB2ZWxvY2l0eSB0aGUgZGlzcGxheSBvYmplY3QgY2FuIHJlYWNoLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSAoaW4gcmFkaWFucykgdGhhdCB0aGUgb2JqZWN0IHNob3VsZCBiZSB2aXN1YWxseSBzZXQgdG8gaW4gb3JkZXIgdG8gbWF0Y2ggaXRzIG5ldyB0cmFqZWN0b3J5LgogICAgKi8KICAgIGFjY2VsZXJhdGVUb09iamVjdDogZnVuY3Rpb24gKGRpc3BsYXlPYmplY3QsIGRlc3RpbmF0aW9uLCBzcGVlZCwgeFNwZWVkTWF4LCB5U3BlZWRNYXgpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCA9PT0gJ3VuZGVmaW5lZCcpIHsgc3BlZWQgPSA2MDsgfQogICAgICAgIGlmICh0eXBlb2YgeFNwZWVkTWF4ID09PSAndW5kZWZpbmVkJykgeyB4U3BlZWRNYXggPSAxMDAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB5U3BlZWRNYXggPT09ICd1bmRlZmluZWQnKSB7IHlTcGVlZE1heCA9IDEwMDA7IH0KCiAgICAgICAgdGhpcy5fYW5nbGUgPSB0aGlzLmFuZ2xlQmV0d2VlbihkaXNwbGF5T2JqZWN0LCBkZXN0aW5hdGlvbik7CgogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS5hY2NlbGVyYXRpb24uc2V0VG8oTWF0aC5jb3ModGhpcy5fYW5nbGUpICogc3BlZWQsIE1hdGguc2luKHRoaXMuX2FuZ2xlKSAqIHNwZWVkKTsKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkubWF4VmVsb2NpdHkuc2V0VG8oeFNwZWVkTWF4LCB5U3BlZWRNYXgpOwoKICAgICAgICByZXR1cm4gdGhpcy5fYW5nbGU7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgYWNjZWxlcmF0aW9uLngveSBwcm9wZXJ0eSBvbiB0aGUgZGlzcGxheSBvYmplY3Qgc28gaXQgd2lsbCBtb3ZlIHRvd2FyZHMgdGhlIHRhcmdldCBhdCB0aGUgZ2l2ZW4gc3BlZWQgKGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLikKICAgICogWW91IG11c3QgZ2l2ZSBhIG1heGltdW0gc3BlZWQgdmFsdWUsIGJleW9uZCB3aGljaCB0aGUgZGlzcGxheSBvYmplY3Qgd29uJ3QgZ28gYW55IGZhc3Rlci4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXMgbm90IGNvbnRpbnVvdXNseSB0cmFjayB0aGUgdGFyZ2V0LiBJZiB0aGUgdGFyZ2V0IGNoYW5nZXMgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXQgdGhlIGRpc3BsYXkgb2JqZWN0IHdpbGwgbm90IG1vZGlmeSBpdHMgY291cnNlLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lc24ndCBzdG9wIG1vdmluZyBvbmNlIGl0IHJlYWNoZXMgdGhlIGRlc3RpbmF0aW9uIGNvb3JkaW5hdGVzLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjYWNjZWxlcmF0ZVRvUG9pbnRlcgogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byBtb3ZlLgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBbcG9pbnRlcl0gLSBUaGUgcG9pbnRlciB0byBtb3ZlIHRvd2FyZHMuIERlZmF1bHRzIHRvIFBoYXNlci5JbnB1dC5hY3RpdmVQb2ludGVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkPTYwXSAtIFRoZSBzcGVlZCBpdCB3aWxsIGFjY2VsZXJhdGUgaW4gcGl4ZWxzIHBlciBzZWNvbmQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeFNwZWVkTWF4PTUwMF0gLSBUaGUgbWF4aW11bSB4IHZlbG9jaXR5IHRoZSBkaXNwbGF5IG9iamVjdCBjYW4gcmVhY2guCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeVNwZWVkTWF4PTUwMF0gLSBUaGUgbWF4aW11bSB5IHZlbG9jaXR5IHRoZSBkaXNwbGF5IG9iamVjdCBjYW4gcmVhY2guCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIChpbiByYWRpYW5zKSB0aGF0IHRoZSBvYmplY3Qgc2hvdWxkIGJlIHZpc3VhbGx5IHNldCB0byBpbiBvcmRlciB0byBtYXRjaCBpdHMgbmV3IHRyYWplY3RvcnkuCiAgICAqLwogICAgYWNjZWxlcmF0ZVRvUG9pbnRlcjogZnVuY3Rpb24gKGRpc3BsYXlPYmplY3QsIHBvaW50ZXIsIHNwZWVkLCB4U3BlZWRNYXgsIHlTcGVlZE1heCkgewoKICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgeyBzcGVlZCA9IDYwOyB9CiAgICAgICAgaWYgKHR5cGVvZiBwb2ludGVyID09PSAndW5kZWZpbmVkJykgeyBwb2ludGVyID0gdGhpcy5nYW1lLmlucHV0LmFjdGl2ZVBvaW50ZXI7IH0KICAgICAgICBpZiAodHlwZW9mIHhTcGVlZE1heCA9PT0gJ3VuZGVmaW5lZCcpIHsgeFNwZWVkTWF4ID0gMTAwMDsgfQogICAgICAgIGlmICh0eXBlb2YgeVNwZWVkTWF4ID09PSAndW5kZWZpbmVkJykgeyB5U3BlZWRNYXggPSAxMDAwOyB9CgogICAgICAgIHRoaXMuX2FuZ2xlID0gdGhpcy5hbmdsZVRvUG9pbnRlcihkaXNwbGF5T2JqZWN0LCBwb2ludGVyKTsKICAgICAgICAKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkuYWNjZWxlcmF0aW9uLnNldFRvKE1hdGguY29zKHRoaXMuX2FuZ2xlKSAqIHNwZWVkLCBNYXRoLnNpbih0aGlzLl9hbmdsZSkgKiBzcGVlZCk7CiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5Lm1heFZlbG9jaXR5LnNldFRvKHhTcGVlZE1heCwgeVNwZWVkTWF4KTsKCiAgICAgICAgcmV0dXJuIHRoaXMuX2FuZ2xlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGFjY2VsZXJhdGlvbi54L3kgcHJvcGVydHkgb24gdGhlIGRpc3BsYXkgb2JqZWN0IHNvIGl0IHdpbGwgbW92ZSB0b3dhcmRzIHRoZSB4L3kgY29vcmRpbmF0ZXMgYXQgdGhlIGdpdmVuIHNwZWVkIChpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4pCiAgICAqIFlvdSBtdXN0IGdpdmUgYSBtYXhpbXVtIHNwZWVkIHZhbHVlLCBiZXlvbmQgd2hpY2ggdGhlIGRpc3BsYXkgb2JqZWN0IHdvbid0IGdvIGFueSBmYXN0ZXIuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2VzIG5vdCBjb250aW51b3VzbHkgdHJhY2sgdGhlIHRhcmdldC4gSWYgdGhlIHRhcmdldCBjaGFuZ2VzIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0IHRoZSBkaXNwbGF5IG9iamVjdCB3aWxsIG5vdCBtb2RpZnkgaXRzIGNvdXJzZS4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXNuJ3Qgc3RvcCBtb3Zpbmcgb25jZSBpdCByZWFjaGVzIHRoZSBkZXN0aW5hdGlvbiBjb29yZGluYXRlcy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2FjY2VsZXJhdGVUb1hZCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIG1vdmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSB0byBhY2NlbGVyYXRlIHRvd2FyZHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSB0byBhY2NlbGVyYXRlIHRvd2FyZHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BlZWQ9NjBdIC0gVGhlIHNwZWVkIGl0IHdpbGwgYWNjZWxlcmF0ZSBpbiBwaXhlbHMgcGVyIHNlY29uZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt4U3BlZWRNYXg9NTAwXSAtIFRoZSBtYXhpbXVtIHggdmVsb2NpdHkgdGhlIGRpc3BsYXkgb2JqZWN0IGNhbiByZWFjaC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5U3BlZWRNYXg9NTAwXSAtIFRoZSBtYXhpbXVtIHkgdmVsb2NpdHkgdGhlIGRpc3BsYXkgb2JqZWN0IGNhbiByZWFjaC4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgKGluIHJhZGlhbnMpIHRoYXQgdGhlIG9iamVjdCBzaG91bGQgYmUgdmlzdWFsbHkgc2V0IHRvIGluIG9yZGVyIHRvIG1hdGNoIGl0cyBuZXcgdHJhamVjdG9yeS4KICAgICovCiAgICBhY2NlbGVyYXRlVG9YWTogZnVuY3Rpb24gKGRpc3BsYXlPYmplY3QsIHgsIHksIHNwZWVkLCB4U3BlZWRNYXgsIHlTcGVlZE1heCkgewoKICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgeyBzcGVlZCA9IDYwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB4U3BlZWRNYXggPT09ICd1bmRlZmluZWQnKSB7IHhTcGVlZE1heCA9IDEwMDA7IH0KICAgICAgICBpZiAodHlwZW9mIHlTcGVlZE1heCA9PT0gJ3VuZGVmaW5lZCcpIHsgeVNwZWVkTWF4ID0gMTAwMDsgfQoKICAgICAgICB0aGlzLl9hbmdsZSA9IHRoaXMuYW5nbGVUb1hZKGRpc3BsYXlPYmplY3QsIHgsIHkpOwoKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkuYWNjZWxlcmF0aW9uLnNldFRvKE1hdGguY29zKHRoaXMuX2FuZ2xlKSAqIHNwZWVkLCBNYXRoLnNpbih0aGlzLl9hbmdsZSkgKiBzcGVlZCk7CiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5Lm1heFZlbG9jaXR5LnNldFRvKHhTcGVlZE1heCwgeVNwZWVkTWF4KTsKCiAgICAgICAgcmV0dXJuIHRoaXMuX2FuZ2xlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEZpbmQgdGhlIGRpc3RhbmNlIGJldHdlZW4gdHdvIGRpc3BsYXkgb2JqZWN0cyAobGlrZSBTcHJpdGVzKS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2Rpc3RhbmNlQmV0d2VlbgogICAgKiBAcGFyYW0ge2FueX0gc291cmNlIC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgZnJvbS4KICAgICogQHBhcmFtIHthbnl9IHRhcmdldCAtIFRoZSBEaXNwbGF5IE9iamVjdCB0byB0ZXN0IHRvLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSBzb3VyY2UgYW5kIHRhcmdldCBvYmplY3RzLgogICAgKi8KICAgIGRpc3RhbmNlQmV0d2VlbjogZnVuY3Rpb24gKHNvdXJjZSwgdGFyZ2V0KSB7CgogICAgICAgIHRoaXMuX2R4ID0gc291cmNlLnggLSB0YXJnZXQueDsKICAgICAgICB0aGlzLl9keSA9IHNvdXJjZS55IC0gdGFyZ2V0Lnk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLl9keCAqIHRoaXMuX2R4ICsgdGhpcy5fZHkgKiB0aGlzLl9keSk7CgogICAgfSwKCiAgICAvKioKICAgICogRmluZCB0aGUgZGlzdGFuY2UgYmV0d2VlbiBhIGRpc3BsYXkgb2JqZWN0IChsaWtlIGEgU3ByaXRlKSBhbmQgdGhlIGdpdmVuIHgveSBjb29yZGluYXRlcy4KICAgICogVGhlIGNhbGN1bGF0aW9uIGlzIG1hZGUgZnJvbSB0aGUgZGlzcGxheSBvYmplY3RzIHgveSBjb29yZGluYXRlLiBUaGlzIG1heSBiZSB0aGUgdG9wLWxlZnQgaWYgaXRzIGFuY2hvciBoYXNuJ3QgYmVlbiBjaGFuZ2VkLgogICAgKiBJZiB5b3UgbmVlZCB0byBjYWxjdWxhdGUgZnJvbSB0aGUgY2VudGVyIG9mIGEgZGlzcGxheSBvYmplY3QgaW5zdGVhZCB1c2UgdGhlIG1ldGhvZCBkaXN0YW5jZUJldHdlZW5DZW50ZXJzKCkKICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2Rpc3RhbmNlVG9YWQogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBEaXNwbGF5IE9iamVjdCB0byB0ZXN0IGZyb20uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSB0byBtb3ZlIHRvd2FyZHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSB0byBtb3ZlIHRvd2FyZHMuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhlIG9iamVjdCBhbmQgdGhlIHgveSBjb29yZGluYXRlcy4KICAgICovCiAgICBkaXN0YW5jZVRvWFk6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCB4LCB5KSB7CgogICAgICAgIHRoaXMuX2R4ID0gZGlzcGxheU9iamVjdC54IC0geDsKICAgICAgICB0aGlzLl9keSA9IGRpc3BsYXlPYmplY3QueSAtIHk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLl9keCAqIHRoaXMuX2R4ICsgdGhpcy5fZHkgKiB0aGlzLl9keSk7CgogICAgfSwKCiAgICAvKioKICAgICogRmluZCB0aGUgZGlzdGFuY2UgYmV0d2VlbiBhIGRpc3BsYXkgb2JqZWN0IChsaWtlIGEgU3ByaXRlKSBhbmQgYSBQb2ludGVyLiBJZiBubyBQb2ludGVyIGlzIGdpdmVuIHRoZSBJbnB1dC5hY3RpdmVQb2ludGVyIGlzIHVzZWQuCiAgICAqIFRoZSBjYWxjdWxhdGlvbiBpcyBtYWRlIGZyb20gdGhlIGRpc3BsYXkgb2JqZWN0cyB4L3kgY29vcmRpbmF0ZS4gVGhpcyBtYXkgYmUgdGhlIHRvcC1sZWZ0IGlmIGl0cyBhbmNob3IgaGFzbid0IGJlZW4gY2hhbmdlZC4KICAgICogSWYgeW91IG5lZWQgdG8gY2FsY3VsYXRlIGZyb20gdGhlIGNlbnRlciBvZiBhIGRpc3BsYXkgb2JqZWN0IGluc3RlYWQgdXNlIHRoZSBtZXRob2QgZGlzdGFuY2VCZXR3ZWVuQ2VudGVycygpCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNkaXN0YW5jZVRvUG9pbnRlcgogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBEaXNwbGF5IE9iamVjdCB0byB0ZXN0IGZyb20uCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IFtwb2ludGVyXSAtIFRoZSBQaGFzZXIuUG9pbnRlciB0byB0ZXN0IHRvLiBJZiBub25lIGlzIGdpdmVuIHRoZW4gSW5wdXQuYWN0aXZlUG9pbnRlciBpcyB1c2VkLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSBvYmplY3QgYW5kIHRoZSBQb2ludGVyLgogICAgKi8KICAgIGRpc3RhbmNlVG9Qb2ludGVyOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgcG9pbnRlcikgewoKICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCB0aGlzLmdhbWUuaW5wdXQuYWN0aXZlUG9pbnRlcjsKCiAgICAgICAgdGhpcy5fZHggPSBkaXNwbGF5T2JqZWN0LnggLSBwb2ludGVyLng7CiAgICAgICAgdGhpcy5fZHkgPSBkaXNwbGF5T2JqZWN0LnkgLSBwb2ludGVyLnk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLl9keCAqIHRoaXMuX2R4ICsgdGhpcy5fZHkgKiB0aGlzLl9keSk7CgogICAgfSwKCiAgICAvKioKICAgICogRmluZCB0aGUgYW5nbGUgaW4gcmFkaWFucyBiZXR3ZWVuIHR3byBkaXNwbGF5IG9iamVjdHMgKGxpa2UgU3ByaXRlcykuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNhbmdsZUJldHdlZW4KICAgICogQHBhcmFtIHthbnl9IHNvdXJjZSAtIFRoZSBEaXNwbGF5IE9iamVjdCB0byB0ZXN0IGZyb20uCiAgICAqIEBwYXJhbSB7YW55fSB0YXJnZXQgLSBUaGUgRGlzcGxheSBPYmplY3QgdG8gdGVzdCB0by4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgaW4gcmFkaWFucyBiZXR3ZWVuIHRoZSBzb3VyY2UgYW5kIHRhcmdldCBkaXNwbGF5IG9iamVjdHMuCiAgICAqLwogICAgYW5nbGVCZXR3ZWVuOiBmdW5jdGlvbiAoc291cmNlLCB0YXJnZXQpIHsKCiAgICAgICAgdGhpcy5fZHggPSB0YXJnZXQueCAtIHNvdXJjZS54OwogICAgICAgIHRoaXMuX2R5ID0gdGFyZ2V0LnkgLSBzb3VyY2UueTsKCiAgICAgICAgcmV0dXJuIE1hdGguYXRhbjIodGhpcy5fZHksIHRoaXMuX2R4KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBGaW5kIHRoZSBhbmdsZSBpbiByYWRpYW5zIGJldHdlZW4gYSBkaXNwbGF5IG9iamVjdCAobGlrZSBhIFNwcml0ZSkgYW5kIHRoZSBnaXZlbiB4L3kgY29vcmRpbmF0ZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2FuZ2xlVG9YWQogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBEaXNwbGF5IE9iamVjdCB0byB0ZXN0IGZyb20uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSB0byBnZXQgdGhlIGFuZ2xlIHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgdG8gZ2V0IHRoZSBhbmdsZSB0by4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgaW4gcmFkaWFucyBiZXR3ZWVuIGRpc3BsYXlPYmplY3QueC95IHRvIFBvaW50ZXIueC95CiAgICAqLwogICAgYW5nbGVUb1hZOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgeCwgeSkgewoKICAgICAgICB0aGlzLl9keCA9IHggLSBkaXNwbGF5T2JqZWN0Lng7CiAgICAgICAgdGhpcy5fZHkgPSB5IC0gZGlzcGxheU9iamVjdC55OwogICAgICAgIAogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHRoaXMuX2R5LCB0aGlzLl9keCk7CgogICAgfSwKICAgIAogICAgLyoqCiAgICAqIEZpbmQgdGhlIGFuZ2xlIGluIHJhZGlhbnMgYmV0d2VlbiBhIGRpc3BsYXkgb2JqZWN0IChsaWtlIGEgU3ByaXRlKSBhbmQgYSBQb2ludGVyLCB0YWtpbmcgdGhlaXIgeC95IGFuZCBjZW50ZXIgaW50byBhY2NvdW50LgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjYW5nbGVUb1BvaW50ZXIKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgRGlzcGxheSBPYmplY3QgdG8gdGVzdCBmcm9tLgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBbcG9pbnRlcl0gLSBUaGUgUGhhc2VyLlBvaW50ZXIgdG8gdGVzdCB0by4gSWYgbm9uZSBpcyBnaXZlbiB0aGVuIElucHV0LmFjdGl2ZVBvaW50ZXIgaXMgdXNlZC4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgaW4gcmFkaWFucyBiZXR3ZWVuIGRpc3BsYXlPYmplY3QueC95IHRvIFBvaW50ZXIueC95CiAgICAqLwogICAgYW5nbGVUb1BvaW50ZXI6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCBwb2ludGVyKSB7CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IHRoaXMuZ2FtZS5pbnB1dC5hY3RpdmVQb2ludGVyOwoKICAgICAgICB0aGlzLl9keCA9IHBvaW50ZXIud29ybGRYIC0gZGlzcGxheU9iamVjdC54OwogICAgICAgIHRoaXMuX2R5ID0gcG9pbnRlci53b3JsZFkgLSBkaXNwbGF5T2JqZWN0Lnk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIE1hdGguYXRhbjIodGhpcy5fZHksIHRoaXMuX2R4KTsKCiAgICB9Cgp9OwoKUGhhc2VyLlBoeXNpY3MuQXJjYWRlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5QaHlzaWNzLkFyY2FkZTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBQaHlzaWNzIEJvZHkgaXMgbGlua2VkIHRvIGEgc2luZ2xlIFNwcml0ZSBhbmQgZGVmaW5lcyBwcm9wZXJ0aWVzIHRoYXQgZGV0ZXJtaW5lIGhvdyB0aGUgcGh5c2ljcyBib2R5IGlzIHNpbXVsYXRlZC4KKiBUaGVzZSBwcm9wZXJ0aWVzIGFmZmVjdCBob3cgdGhlIGJvZHkgcmVhY3RzIHRvIGZvcmNlcywgd2hhdCBmb3JjZXMgaXQgZ2VuZXJhdGVzIG9uIGl0c2VsZiAodG8gc2ltdWxhdGUgZnJpY3Rpb24pLCBhbmQgaG93IGl0IHJlYWN0cyB0byBjb2xsaXNpb25zIGluIHRoZSBzY2VuZS4gSW4gbW9zdCBjYXNlcywgdGhlIHByb3BlcnRpZXMgYXJlIHVzZWQgdG8gc2ltdWxhdGUgcGh5c2ljYWwgZWZmZWN0cy4KKiBFYWNoIGJvZHkgYWxzbyBoYXMgaXRzIG93biBwcm9wZXJ0eSB2YWx1ZXMgdGhhdCBkZXRlcm1pbmUgZXhhY3RseSBob3cgaXQgcmVhY3RzIHRvIGZvcmNlcyBhbmQgY29sbGlzaW9ucyBpbiB0aGUgc2NlbmUuCioKKiBAY2xhc3MgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkKKiBAY2xhc3NkZXNjIEFyY2FkZSBQaHlzaWNzIEJvZHkgQ29uc3RydWN0b3IKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFRoZSBTcHJpdGUgb2JqZWN0IHRoaXMgcGh5c2ljcyBib2R5IGJlbG9uZ3MgdG8uCiovClBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5ID0gZnVuY3Rpb24gKHNwcml0ZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFJlZmVyZW5jZSB0byB0aGUgcGFyZW50IFNwcml0ZS4KICAgICovCiAgICB0aGlzLnNwcml0ZSA9IHNwcml0ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IHNwcml0ZS5nYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gb2Zmc2V0IC0gVGhlIG9mZnNldCBvZiB0aGUgUGh5c2ljcyBCb2R5IGZyb20gdGhlIFNwcml0ZSB4L3kgcG9zaXRpb24uCiAgICAqLwogICAgdGhpcy5vZmZzZXQgPSBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwcmVYIC0gVGhlIHByZXZpb3VzIHggcG9zaXRpb24gb2YgdGhlIHBoeXNpY3MgYm9keS4KICAgICogQHJlYWRvbmx5CiAgICAqLwogICAgdGhpcy5wcmVYID0gc3ByaXRlLndvcmxkLng7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwcmVZIC0gVGhlIHByZXZpb3VzIHkgcG9zaXRpb24gb2YgdGhlIHBoeXNpY3MgYm9keS4KICAgICogQHJlYWRvbmx5CiAgICAqLwogICAgdGhpcy5wcmVZID0gc3ByaXRlLndvcmxkLnk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwcmVSb3RhdGlvbiAtIFRoZSBwcmV2aW91cyByb3RhdGlvbiBvZiB0aGUgcGh5c2ljcyBib2R5LgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnByZVJvdGF0aW9uID0gc3ByaXRlLmFuZ2xlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gdmVsb2NpdHkgLSBUaGUgdmVsb2NpdHkgb2YgdGhlIEJvZHkuCiAgICAqLwogICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGFjY2VsZXJhdGlvbiAtIFRoZSBhY2NlbGVyYXRpb24gaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuIG9mIHRoZSBCb2R5LgogICAgKi8KICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gbmV3IFBoYXNlci5Qb2ludCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc3BlZWQgLSBUaGUgc3BlZWQgaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuIG9mIHRoZSBCb2R5LgogICAgKi8KICAgIHRoaXMuc3BlZWQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgb2YgdGhlIEJvZHkgYmFzZWQgb24gaXRzIHZlbG9jaXR5IGluIHJhZGlhbnMuCiAgICAqLwogICAgdGhpcy5hbmdsZSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBncmF2aXR5IC0gVGhlIGdyYXZpdHkgYXBwbGllZCB0byB0aGUgbW90aW9uIG9mIHRoZSBCb2R5LiBUaGlzIHdvcmtzIGluIGFkZGl0aW9uIHRvIGFueSBncmF2aXR5IHNldCBvbiB0aGUgd29ybGQuCiAgICAqLwogICAgdGhpcy5ncmF2aXR5ID0gbmV3IFBoYXNlci5Qb2ludCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYm91bmNlIC0gVGhlIGVsYXN0aWNpdGl5IG9mIHRoZSBCb2R5IHdoZW4gY29sbGlkaW5nLiBUaGlzIHByb3BlcnR5IGRldGVybWluZXMgaG93IG11Y2ggZW5lcmd5IGEgYm9keSBtYWludGFpbnMgZHVyaW5nIGEgY29sbGlzaW9uLCBpLmUuIGl0cyBib3VuY2luZXNzLgogICAgKi8KICAgIHRoaXMuYm91bmNlID0gbmV3IFBoYXNlci5Qb2ludCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gbWluVmVsb2NpdHkgLSBXaGVuIGEgYm9keSByZWJvdW5kcyBvZmYgYW5vdGhlciBib2R5IG9yIGEgd2FsbCB0aGUgbWluVmVsb2NpdHkgaXMgY2hlY2tlZC4gSWYgdGhlIG5ldyB2ZWxvY2l0eSBpcyBsb3dlciB0aGFuIG1pblZlbG9jaXR5IHRoZSBib2R5IGlzIHN0b3BwZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5taW5WZWxvY2l0eSA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IG1heFZlbG9jaXR5IC0gVGhlIG1heGltdW0gdmVsb2NpdHkgdGhhdCB0aGUgQm9keSBjYW4gcmVhY2guCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXhWZWxvY2l0eSA9IG5ldyBQaGFzZXIuUG9pbnQoMTAwMCwgMTAwMCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmd1bGFyVmVsb2NpdHkgLSBUaGUgYW5ndWxhciB2ZWxvY2l0eSBvZiB0aGUgQm9keS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmd1bGFyQWNjZWxlcmF0aW9uIC0gVGhlIGFuZ3VsYXIgYWNjZWxlcmF0aW9uIG9mIHRoZSBCb2R5LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYW5ndWxhckFjY2VsZXJhdGlvbiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmd1bGFyRHJhZyAtIGFuZ3VsYXJEcmFnIGlzIHVzZWQgdG8gY2FsY3VsYXRlIGZyaWN0aW9uIG9uIHRoZSBib2R5IGFzIGl0IHJvdGF0ZXMuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbmd1bGFyRHJhZyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYXhBbmd1bGFyIC0gVGhlIG1heGltdW0gYW5ndWxhciB2ZWxvY2l0eSB0aGF0IHRoZSBCb2R5IGNhbiByZWFjaC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1heEFuZ3VsYXIgPSAxMDAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWFzcyAtIFRoZSBtYXNzIHByb3BlcnR5IGRldGVybWluZXMgaG93IGZvcmNlcyBhZmZlY3QgdGhlIGJvZHksIGFzIHdlbGwgYXMgaG93IG11Y2ggbW9tZW50dW0gdGhlIGJvZHkgaGFzIHdoZW4gaXQgaXMgaW52b2x2ZWQgaW4gYSBjb2xsaXNpb24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXNzID0gMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGxpbmVhckRhbXBpbmcgLSBsaW5lYXJEYW1waW5nIGlzIHVzZWQgdG8gY2FsY3VsYXRlIGZyaWN0aW9uIG9uIHRoZSBib2R5IGFzIGl0IG1vdmVzIHRocm91Z2ggdGhlIHdvcmxkLiBGb3IgZXhhbXBsZSwgdGhpcyBtaWdodCBiZSB1c2VkIHRvIHNpbXVsYXRlIGFpciBvciB3YXRlciBmcmljdGlvbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmxpbmVhckRhbXBpbmcgPSAwLjA7CgogICAgLyoqCiAgICAqIFNldCB0aGUgY2hlY2tDb2xsaXNpb24gcHJvcGVydGllcyB0byBjb250cm9sIHdoaWNoIGRpcmVjdGlvbnMgY29sbGlzaW9uIGlzIHByb2Nlc3NlZCBmb3IgdGhpcyBCb2R5LgogICAgKiBGb3IgZXhhbXBsZSBjaGVja0NvbGxpc2lvbi51cCA9IGZhbHNlIG1lYW5zIGl0IHdvbid0IGNvbGxpZGUgd2hlbiB0aGUgY29sbGlzaW9uIGhhcHBlbmVkIHdoaWxlIG1vdmluZyB1cC4KICAgICogQHByb3BlcnR5IHtvYmplY3R9IGNoZWNrQ29sbGlzaW9uIC0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsb3dlZCBjb2xsaXNpb24uCiAgICAqLwogICAgdGhpcy5jaGVja0NvbGxpc2lvbiA9IHsgbm9uZTogZmFsc2UsIGFueTogdHJ1ZSwgdXA6IHRydWUsIGRvd246IHRydWUsIGxlZnQ6IHRydWUsIHJpZ2h0OiB0cnVlIH07CgogICAgLyoqCiAgICAqIFRoaXMgb2JqZWN0IGlzIHBvcHVsYXRlZCB3aXRoIGJvb2xlYW4gdmFsdWVzIHdoZW4gdGhlIEJvZHkgY29sbGlkZXMgd2l0aCBhbm90aGVyLgogICAgKiB0b3VjaGluZy51cCA9IHRydWUgbWVhbnMgdGhlIGNvbGxpc2lvbiBoYXBwZW5lZCB0byB0aGUgdG9wIG9mIHRoaXMgQm9keSBmb3IgZXhhbXBsZS4KICAgICogQHByb3BlcnR5IHtvYmplY3R9IHRvdWNoaW5nIC0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgdG91Y2hpbmcgcmVzdWx0cy4KICAgICovCiAgICB0aGlzLnRvdWNoaW5nID0geyBub25lOiB0cnVlLCB1cDogZmFsc2UsIGRvd246IGZhbHNlLCBsZWZ0OiBmYWxzZSwgcmlnaHQ6IGZhbHNlIH07CgogICAgLyoqCiAgICAqIFRoaXMgb2JqZWN0IGlzIHBvcHVsYXRlZCB3aXRoIGJvb2xlYW4gdmFsdWVzIHdoZW4gdGhlIEJvZHkgY29sbGlkZXMgd2l0aCB0aGUgV29ybGQgYm91bmRzIG9yIGEgVGlsZS4KICAgICogRm9yIGV4YW1wbGUgaWYgYmxvY2tlZC51cCBpcyB0cnVlIHRoZW4gdGhlIEJvZHkgY2Fubm90IG1vdmUgdXAuCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBibG9ja2VkIC0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgb24gd2hpY2ggZmFjZXMgdGhpcyBCb2R5IGlzIGJsb2NrZWQgZnJvbSBtb3ZpbmcsIGlmIGFueS4KICAgICovCiAgICB0aGlzLmJsb2NrZWQgPSB7IHg6IDAsIHk6IDAsIHVwOiBmYWxzZSwgZG93bjogZmFsc2UsIGxlZnQ6IGZhbHNlLCByaWdodDogZmFsc2UgfTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGZhY2luZyAtIEEgY29uc3QgcmVmZXJlbmNlIHRvIHRoZSBkaXJlY3Rpb24gdGhlIEJvZHkgaXMgdHJhdmVsaW5nIG9yIGZhY2luZy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZhY2luZyA9IFBoYXNlci5OT05FOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHJlYm91bmQgLSBBIEJvZHkgc2V0IHRvIHJlYm91bmQgd2lsbCBleGNoYW5nZSB2ZWxvY2l0eSB3aXRoIGFub3RoZXIgQm9keSBkdXJpbmcgY29sbGlzaW9uLiBTZXQgdG8gZmFsc2UgdG8gYWxsb3cgdGhpcyBib2R5IHRvIGJlICdwdXNoZWQnIHJhdGhlciB0aGFuIGV4Y2hhbmdlIHZlbG9jaXR5LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucmVib3VuZCA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaW1tb3ZhYmxlIC0gQW4gaW1tb3ZhYmxlIEJvZHkgd2lsbCBub3QgcmVjZWl2ZSBhbnkgaW1wYWN0cyBvciBleGNoYW5nZXMgb2YgdmVsb2NpdHkgZnJvbSBvdGhlciBib2RpZXMuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pbW1vdmFibGUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBtb3ZlcyAtIFNldCB0byB0cnVlIHRvIGFsbG93IHRoZSBQaHlzaWNzIHN5c3RlbSAoc3VjaCBhcyB2ZWxvY2l0eSkgdG8gbW92ZSB0aGlzIEJvZHksIG9yIGZhbHNlIHRvIG1vdmUgaXQgbWFudWFsbHkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tb3ZlcyA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSByb3RhdGlvbiAtIFRoZSBhbW91bnQgdGhlIHBhcmVudCBTcHJpdGUgaXMgcm90YXRlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnJvdGF0aW9uID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhbGxvd1JvdGF0aW9uIC0gQWxsb3cgYW5ndWxhciByb3RhdGlvbj8gVGhpcyB3aWxsIGNhdXNlIHRoZSBTcHJpdGUgdG8gYmUgcm90YXRlZCB2aWEgYW5ndWxhclZlbG9jaXR5LCBldGMuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbGxvd1JvdGF0aW9uID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhbGxvd0dyYXZpdHkgLSBBbGxvdyB0aGlzIEJvZHkgdG8gYmUgaW5mbHVlbmNlZCBieSB0aGUgZ2xvYmFsIEdyYXZpdHkgdmFsdWU/IE5vdGU6IEl0IHdpbGwgYWx3YXlzIGJlIGluZmx1ZW5jZWQgYnkgdGhlIGxvY2FsIGdyYXZpdHkgaWYgc2V0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYWxsb3dHcmF2aXR5ID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gY3VzdG9tU2VwYXJhdGVDYWxsYmFjayAtIElmIHNldCB0aGlzIGNhbGxiYWNrIHdpbGwgYmUgdXNlZCBmb3IgQm9keSBzZXBhcmF0aW9uIGluc3RlYWQgb2YgdGhlIGJ1aWx0LWluIG9uZS4gQ2FsbGJhY2sgc2hvdWxkIHJldHVybiB0cnVlIGlmIHNlcGFyYXRlZCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY3VzdG9tU2VwYXJhdGVDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjdXN0b21TZXBhcmF0ZUNvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY3VzdG9tU2VwYXJhdGVDYWxsYmFjayBpcyBjYWxsZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jdXN0b21TZXBhcmF0ZUNvbnRleHQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBjb2xsaWRlQ2FsbGJhY2sgLSBJZiBzZXQgdGhpcyBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIHdoZW5ldmVyIHRoaXMgQm9keSBpcyBoaXQgKG9uIGFueSBmYWNlKS4gSXQgd2lsbCBzZW5kIHRocmVlIHBhcmFtZXRlcnMsIHRoZSBmYWNlIGl0IGhpdCBvbiwgdGhpcyBCb2R5IGFuZCB0aGUgQm9keSB0aGF0IGhpdCBpdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNvbGxpZGVDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjb2xsaWRlQ2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGNvbGxpZGVDYWxsYmFjayBpcyBjYWxsZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb2xsaWRlQ2FsbGJhY2tDb250ZXh0ID0gbnVsbDsKCiAgICAvKioKICAgICogQSBCb2R5IGNhbiBiZSBzZXQgdG8gY29sbGlkZSBhZ2FpbnN0IHRoZSBXb3JsZCBib3VuZHMgYXV0b21hdGljYWxseSBhbmQgcmVib3VuZCBiYWNrIGludG8gdGhlIFdvcmxkIGlmIHRoaXMgaXMgc2V0IHRvIHRydWUuIE90aGVyd2lzZSBpdCB3aWxsIGxlYXZlIHRoZSBXb3JsZC4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBjb2xsaWRlV29ybGRCb3VuZHMgLSBTaG91bGQgdGhlIEJvZHkgY29sbGlkZSB3aXRoIHRoZSBXb3JsZCBib3VuZHM/CiAgICAqLwogICAgdGhpcy5jb2xsaWRlV29ybGRCb3VuZHMgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuUkVDVHxQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQ0lSQ0xFfSB0eXBlIC0gVGhlIHR5cGUgb2YgU0FUIFNoYXBlLgogICAgKi8KICAgIHRoaXMudHlwZSA9IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5SRUNUOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1NBVC5Cb3h8U0FULkNpcmNsZXxTQVQuUG9seWdvbn0gc2hhcGUgLSBUaGUgU0FUIENvbGxpc2lvbiBzaGFwZS4KICAgICovCiAgICB0aGlzLnNoYXBlID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtTQVQuUG9seWdvbn0gcG9seWdvbiAtIFRoZSBTQVQgUG9seWdvbnMsIGFzIGRlcml2ZWQgZnJvbSB0aGUgU2hhcGUuCiAgICAqLwogICAgdGhpcy5wb2x5Z29uID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGxlZnQgLSBUaGUgbGVmdC1tb3N0IHBvaW50IG9mIHRoaXMgQm9keS4KICAgICogQHJlYWRvbmx5CiAgICAqLwogICAgdGhpcy5sZWZ0ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHJpZ2h0IC0gVGhlIHJpZ2h0LW1vc3QgcG9pbnQgb2YgdGhpcyBCb2R5LgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnJpZ2h0ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRvcCAtIFRoZSB0b3AtbW9zdCBwb2ludCBvZiB0aGlzIEJvZHkuCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMudG9wID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGJvdHRvbSAtIFRoZSBib3R0b20tbW9zdCBwb2ludCBvZiB0aGlzIEJvZHkuCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMuYm90dG9tID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gVGhlIGN1cnJlbnQgd2lkdGggb2YgdGhlIEJvZHksIHRha2luZyBpbnRvIGFjY291bnQgdGhlIHBvaW50IHJvdGF0aW9uLgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLndpZHRoID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIFRoZSBjdXJyZW50IGhlaWdodCBvZiB0aGUgQm9keSwgdGFraW5nIGludG8gYWNjb3VudCB0aGUgcG9pbnQgcm90YXRpb24uCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMuaGVpZ2h0ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheTxQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keT59IGNvbnRhY3RzIC0gVXNlZCB0byBzdG9yZSByZWZlcmVuY2VzIHRvIGJvZGllcyB0aGlzIEJvZHkgaXMgaW4gY29udGFjdCB3aXRoLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdGhpcy5jb250YWN0cyA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gb3ZlcmxhcFggLSBNb3N0bHkgdXNlZCBpbnRlcm5hbGx5IHRvIHN0b3JlIHRoZSBvdmVybGFwIHZhbHVlcyBmcm9tIFRpbGUgc2VwZXJhdGlvbi4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHRoaXMub3ZlcmxhcFggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gb3ZlcmxhcFkgLSBNb3N0bHkgdXNlZCBpbnRlcm5hbGx5IHRvIHN0b3JlIHRoZSBvdmVybGFwIHZhbHVlcyBmcm9tIFRpbGUgc2VwZXJhdGlvbi4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHRoaXMub3ZlcmxhcFkgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gX3RlbXAgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdGVtcCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZHggLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZHggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R5IC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2R5ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9zeCAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9zeCA9IHNwcml0ZS5zY2FsZS54OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3N5IC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3N5ID0gc3ByaXRlLnNjYWxlLnk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IF9kaXN0YW5jZXMgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZGlzdGFuY2VzID0gWzAsIDAsIDAsIDBdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3Z4IC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3Z4ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF92eSAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl92eSA9IDA7CgogICAgLy8gIFNldC11cCB0aGUgZGVmYXVsdCBzaGFwZQogICAgdGhpcy5zZXRSZWN0YW5nbGUoc3ByaXRlLndpZHRoLCBzcHJpdGUuaGVpZ2h0LCAwLCAwKTsKCiAgICAvLyAgU2V0LXVwIGNvbnRhY3QgZXZlbnRzCiAgICB0aGlzLnNwcml0ZS5ldmVudHMub25CZWdpbkNvbnRhY3QgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uRW5kQ29udGFjdCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7Cgp9OwoKUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QgdGhhdCB1cGRhdGVzIHRoZSBCb2R5IHNjYWxlIGluIHJlbGF0aW9uIHRvIHRoZSBwYXJlbnQgU3ByaXRlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3VwZGF0ZVNjYWxlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB1cGRhdGVTY2FsZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5wb2x5Z29uKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5wb2x5Z29uLnNjYWxlKHRoaXMuc3ByaXRlLnNjYWxlLnggLyB0aGlzLl9zeCwgdGhpcy5zcHJpdGUuc2NhbGUueSAvIHRoaXMuX3N5KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zaGFwZS5yICo9IE1hdGgubWF4KHRoaXMuc3ByaXRlLnNjYWxlLngsIHRoaXMuc3ByaXRlLnNjYWxlLnkpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fc3ggPSB0aGlzLnNwcml0ZS5zY2FsZS54OwogICAgICAgIHRoaXMuX3N5ID0gdGhpcy5zcHJpdGUuc2NhbGUueTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QgdGhhdCB1cGRhdGVzIHRoZSBCb2R5IHBvc2l0aW9uIGluIHJlbGF0aW9uIHRvIHRoZSBwYXJlbnQgU3ByaXRlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3ByZVVwZGF0ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcHJlVXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMueCA9ICh0aGlzLnNwcml0ZS53b3JsZC54IC0gKHRoaXMuc3ByaXRlLmFuY2hvci54ICogdGhpcy5zcHJpdGUud2lkdGgpKSArIHRoaXMub2Zmc2V0Lng7CiAgICAgICAgdGhpcy55ID0gKHRoaXMuc3ByaXRlLndvcmxkLnkgLSAodGhpcy5zcHJpdGUuYW5jaG9yLnkgKiB0aGlzLnNwcml0ZS5oZWlnaHQpKSArIHRoaXMub2Zmc2V0Lnk7CgogICAgICAgIC8vICBUaGlzIGNvdmVycyBhbnkgbW90aW9uIHRoYXQgaGFwcGVucyBkdXJpbmcgdGhpcyBmcmFtZSwgbm90IHNpbmNlIHRoZSBsYXN0IGZyYW1lCiAgICAgICAgdGhpcy5wcmVYID0gdGhpcy54OwogICAgICAgIHRoaXMucHJlWSA9IHRoaXMueTsKICAgICAgICB0aGlzLnByZVJvdGF0aW9uID0gdGhpcy5zcHJpdGUuYW5nbGU7CgogICAgICAgIHRoaXMucm90YXRpb24gPSB0aGlzLnByZVJvdGF0aW9uOwoKICAgICAgICBpZiAodGhpcy5zcHJpdGUuc2NhbGUueCAhPT0gdGhpcy5fc3ggfHwgdGhpcy5zcHJpdGUuc2NhbGUueSAhPT0gdGhpcy5fc3kpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVNjYWxlKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNoZWNrQmxvY2tlZCgpOwoKICAgICAgICB0aGlzLnRvdWNoaW5nLm5vbmUgPSB0cnVlOwogICAgICAgIHRoaXMudG91Y2hpbmcudXAgPSBmYWxzZTsKICAgICAgICB0aGlzLnRvdWNoaW5nLmRvd24gPSBmYWxzZTsKICAgICAgICB0aGlzLnRvdWNoaW5nLmxlZnQgPSBmYWxzZTsKICAgICAgICB0aGlzLnRvdWNoaW5nLnJpZ2h0ID0gZmFsc2U7CgogICAgICAgIGlmICh0aGlzLm1vdmVzKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3Z4ICE9PSB0aGlzLnZlbG9jaXR5LnggfHwgdGhpcy5fdnkgIT09IHRoaXMudmVsb2NpdHkueSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIE5vIG5lZWQgdG8gcmUtY2FsYyB0aGVzZSBpZiB0aGV5IGhhdmVuJ3QgY2hhbmdlZAogICAgICAgICAgICAgICAgdGhpcy5fdnggPSB0aGlzLnZlbG9jaXR5Lng7CiAgICAgICAgICAgICAgICB0aGlzLl92eSA9IHRoaXMudmVsb2NpdHkueTsKICAgICAgICAgICAgICAgIHRoaXMuc3BlZWQgPSBNYXRoLnNxcnQodGhpcy52ZWxvY2l0eS54ICogdGhpcy52ZWxvY2l0eS54ICsgdGhpcy52ZWxvY2l0eS55ICogdGhpcy52ZWxvY2l0eS55KTsKICAgICAgICAgICAgICAgIHRoaXMuYW5nbGUgPSBNYXRoLmF0YW4yKHRoaXMudmVsb2NpdHkueSwgdGhpcy52ZWxvY2l0eS54KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5waHlzaWNzLmNoZWNrQm91bmRzKHRoaXMpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnJlYm91bmRDaGVjayh0cnVlLCB0cnVlLCB0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5hcHBseURhbXBpbmcoKTsKCiAgICAgICAgICAgIHRoaXMuaW50ZWdyYXRlVmVsb2NpdHkoKTsKCiAgICAgICAgICAgIHRoaXMudXBkYXRlQm91bmRzKCk7CgogICAgICAgICAgICB0aGlzLmNoZWNrQmxvY2tlZCgpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnVwZGF0ZUJvdW5kcygpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QgdGhhdCBjaGVja3MgYW5kIHBvdGVudGlhbGx5IHJlc2V0cyB0aGUgYmxvY2tlZCBzdGF0dXMgZmxhZ3MuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjY2hlY2tCbG9ja2VkCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBjaGVja0Jsb2NrZWQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKCh0aGlzLmJsb2NrZWQubGVmdCB8fCB0aGlzLmJsb2NrZWQucmlnaHQpICYmIChNYXRoLmZsb29yKHRoaXMueCkgIT09IHRoaXMuYmxvY2tlZC54IHx8IE1hdGguZmxvb3IodGhpcy55KSAhPT0gdGhpcy5ibG9ja2VkLnkpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5ibG9ja2VkLmxlZnQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5ibG9ja2VkLnJpZ2h0ID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoKHRoaXMuYmxvY2tlZC51cCB8fCB0aGlzLmJsb2NrZWQuZG93bikgJiYgKE1hdGguZmxvb3IodGhpcy54KSAhPT0gdGhpcy5ibG9ja2VkLnggfHwgTWF0aC5mbG9vcih0aGlzLnkpICE9PSB0aGlzLmJsb2NrZWQueSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJsb2NrZWQudXAgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5ibG9ja2VkLmRvd24gPSBmYWxzZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kIHRoYXQgdXBkYXRlcyB0aGUgbGVmdCwgcmlnaHQsIHRvcCwgYm90dG9tLCB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjdXBkYXRlQm91bmRzCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB1cGRhdGVCb3VuZHM6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkNJUkNMRSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubGVmdCA9IHRoaXMuc2hhcGUucG9zLnggLSB0aGlzLnNoYXBlLnI7CiAgICAgICAgICAgIHRoaXMucmlnaHQgPSB0aGlzLnNoYXBlLnBvcy54ICsgdGhpcy5zaGFwZS5yOwogICAgICAgICAgICB0aGlzLnRvcCA9IHRoaXMuc2hhcGUucG9zLnkgLSB0aGlzLnNoYXBlLnI7CiAgICAgICAgICAgIHRoaXMuYm90dG9tID0gdGhpcy5zaGFwZS5wb3MueSArIHRoaXMuc2hhcGUucjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5sZWZ0ID0gUGhhc2VyLk1hdGgubWluUHJvcGVydHkoJ3gnLCB0aGlzLnBvbHlnb24ucG9pbnRzKSArIHRoaXMucG9seWdvbi5wb3MueDsKICAgICAgICAgICAgdGhpcy5yaWdodCA9IFBoYXNlci5NYXRoLm1heFByb3BlcnR5KCd4JywgdGhpcy5wb2x5Z29uLnBvaW50cykgKyB0aGlzLnBvbHlnb24ucG9zLng7CiAgICAgICAgICAgIHRoaXMudG9wID0gUGhhc2VyLk1hdGgubWluUHJvcGVydHkoJ3knLCB0aGlzLnBvbHlnb24ucG9pbnRzKSArIHRoaXMucG9seWdvbi5wb3MueTsKICAgICAgICAgICAgdGhpcy5ib3R0b20gPSBQaGFzZXIuTWF0aC5tYXhQcm9wZXJ0eSgneScsIHRoaXMucG9seWdvbi5wb2ludHMpICsgdGhpcy5wb2x5Z29uLnBvcy55OwogICAgICAgIH0KCiAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMucmlnaHQgLSB0aGlzLmxlZnQ7CiAgICAgICAgdGhpcy5oZWlnaHQgPSB0aGlzLmJvdHRvbSAtIHRoaXMudG9wOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZCB0aGF0IGNoZWNrcyB0aGUgYWNjZWxlcmF0aW9uIGFuZCBhcHBsaWVzIGRhbXBpbmcgaWYgbm90IHNldC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNhcHBseURhbXBpbmcKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGFwcGx5RGFtcGluZzogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5saW5lYXJEYW1waW5nID4gMCAmJiB0aGlzLmFjY2VsZXJhdGlvbi5pc1plcm8oKSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnNwZWVkID4gdGhpcy5saW5lYXJEYW1waW5nKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwZWVkIC09IHRoaXMubGluZWFyRGFtcGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3BlZWQgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAgRG9uJ3QgYm90aGVyIGlmIHNwZWVkIDAKICAgICAgICAgICAgaWYgKHRoaXMuc3BlZWQgPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggPSBNYXRoLmNvcyh0aGlzLmFuZ2xlKSAqIHRoaXMuc3BlZWQ7CiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgPSBNYXRoLnNpbih0aGlzLmFuZ2xlKSAqIHRoaXMuc3BlZWQ7CgogICAgICAgICAgICAgICAgdGhpcy5zcGVlZCA9IE1hdGguc3FydCh0aGlzLnZlbG9jaXR5LnggKiB0aGlzLnZlbG9jaXR5LnggKyB0aGlzLnZlbG9jaXR5LnkgKiB0aGlzLnZlbG9jaXR5LnkpOwogICAgICAgICAgICAgICAgdGhpcy5hbmdsZSA9IE1hdGguYXRhbjIodGhpcy52ZWxvY2l0eS55LCB0aGlzLnZlbG9jaXR5LngpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrIGlmIHdlJ3JlIGJlbG93IG1pblZlbG9jaXR5IGFuZCBncmF2aXR5IGlzbid0IHRyeWluZyB0byBkcmFnIHVzIGluIHRoZSBvcHBvc2l0ZSBkaXJlY3Rpb24uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjcmVib3VuZENoZWNrCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtib29sZWFufSB4IC0gQ2hlY2sgdGhlIFggYXhpcz8KICAgICogQHBhcmFtIHtib29sZWFufSB5IC0gQ2hlY2sgdGhlIFkgYXhpcz8KICAgICogQHBhcmFtIHtib29sZWFufSByZWJvdW5kIC0gSWYgdHJ1ZSBpdCB3aWxsIHJldmVyc2UgdGhlIHZlbG9jaXR5IG9uIHRoZSBnaXZlbiBheGlzCiAgICAqLwogICAgcmVib3VuZENoZWNrOiBmdW5jdGlvbiAoeCwgeSwgcmVib3VuZCkgewoKICAgICAgICBpZiAoeCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZWJvdW5kICYmIHRoaXMuYm91bmNlLnggIT09IDAgJiYgKHRoaXMuYmxvY2tlZC5sZWZ0IHx8IHRoaXMuYmxvY2tlZC5yaWdodCB8fCB0aGlzLnRvdWNoaW5nLmxlZnQgfHwgdGhpcy50b3VjaGluZy5yaWdodCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBEb24ndCByZWJvdW5kIGlmIHRoZXkndmUgYWxyZWFkeSByZWJvdW5kZWQgaW4gdGhpcyBmcmFtZQogICAgICAgICAgICAgICAgaWYgKCEodGhpcy5fdnggPD0gMCAmJiB0aGlzLnZlbG9jaXR5LnggPiAwKSAmJiAhKHRoaXMuX3Z4ID49IDAgJiYgdGhpcy52ZWxvY2l0eS54IDwgMCkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICo9IC10aGlzLmJvdW5jZS54OwogICAgICAgICAgICAgICAgICAgIHRoaXMuYW5nbGUgPSBNYXRoLmF0YW4yKHRoaXMudmVsb2NpdHkueSwgdGhpcy52ZWxvY2l0eS54KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuYm91bmNlLnggPT09IDAgfHwgTWF0aC5hYnModGhpcy52ZWxvY2l0eS54KSA8IHRoaXMubWluVmVsb2NpdHkueCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGd4ID0gdGhpcy5nZXRVcHdhcmRGb3JjZSgpOwoKICAgICAgICAgICAgICAgIGlmICgoKHRoaXMuYmxvY2tlZC5sZWZ0IHx8IHRoaXMudG91Y2hpbmcubGVmdCkgJiYgKGd4IDwgMCB8fCB0aGlzLnZlbG9jaXR5LnggPCAwKSkgfHwgKCh0aGlzLmJsb2NrZWQucmlnaHQgfHwgdGhpcy50b3VjaGluZy5yaWdodCkgJiYgKGd4ID4gMCB8fCB0aGlzLnZlbG9jaXR5LnggPiAwKSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHkpCiAgICAgICAgewogICAgICAgICAgICBpZiAocmVib3VuZCAmJiB0aGlzLmJvdW5jZS55ICE9PSAwICYmICh0aGlzLmJsb2NrZWQudXAgfHwgdGhpcy5ibG9ja2VkLmRvd24gfHwgdGhpcy50b3VjaGluZy51cCB8fCB0aGlzLnRvdWNoaW5nLmRvd24pKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgRG9uJ3QgcmVib3VuZCBpZiB0aGV5J3ZlIGFscmVhZHkgcmVib3VuZGVkIGluIHRoaXMgZnJhbWUKICAgICAgICAgICAgICAgIGlmICghKHRoaXMuX3Z5IDw9IDAgJiYgdGhpcy52ZWxvY2l0eS55ID4gMCkgJiYgISh0aGlzLl92eSA+PSAwICYmIHRoaXMudmVsb2NpdHkueSA8IDApKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSAqPSAtdGhpcy5ib3VuY2UueTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZ2xlID0gTWF0aC5hdGFuMih0aGlzLnZlbG9jaXR5LnksIHRoaXMudmVsb2NpdHkueCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmJvdW5jZS55ID09PSAwIHx8IE1hdGguYWJzKHRoaXMudmVsb2NpdHkueSkgPCB0aGlzLm1pblZlbG9jaXR5LnkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBneSA9IHRoaXMuZ2V0RG93bndhcmRGb3JjZSgpOwoKICAgICAgICAgICAgICAgIGlmICgoKHRoaXMuYmxvY2tlZC51cCB8fCB0aGlzLnRvdWNoaW5nLnVwKSAmJiAoZ3kgPCAwIHx8IHRoaXMudmVsb2NpdHkueSA8IDApKSB8fCAoKHRoaXMuYmxvY2tlZC5kb3duIHx8IHRoaXMudG91Y2hpbmcuZG93bikgJiYgKGd5ID4gMCB8fCB0aGlzLnZlbG9jaXR5LnkgPiAwKSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXRzIHRoZSB0b3RhbCBmb3JjZSBiZWluZyBhcHBsaWVkIG9uIHRoZSBYIGF4aXMsIGluY2x1ZGluZyBncmF2aXR5IGFuZCB2ZWxvY2l0eS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNnZXRVcHdhcmRGb3JjZQogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSB0b3RhbCBmb3JjZSBiZWluZyBhcHBsaWVkIG9uIHRoZSBYIGF4aXMuCiAgICAqLwogICAgZ2V0VXB3YXJkRm9yY2U6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuYWxsb3dHcmF2aXR5KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ3Jhdml0eS54ICsgdGhpcy5nYW1lLnBoeXNpY3MuZ3Jhdml0eS54ICsgdGhpcy52ZWxvY2l0eS54OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ncmF2aXR5LnggKyB0aGlzLnZlbG9jaXR5Lng7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldHMgdGhlIHRvdGFsIGZvcmNlIGJlaW5nIGFwcGxpZWQgb24gdGhlIFggYXhpcywgaW5jbHVkaW5nIGdyYXZpdHkgYW5kIHZlbG9jaXR5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2dldERvd253YXJkRm9yY2UKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgdG90YWwgZm9yY2UgYmVpbmcgYXBwbGllZCBvbiB0aGUgWSBheGlzLgogICAgKi8KICAgIGdldERvd253YXJkRm9yY2U6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuYWxsb3dHcmF2aXR5KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ3Jhdml0eS55ICsgdGhpcy5nYW1lLnBoeXNpY3MuZ3Jhdml0eS55ICsgdGhpcy52ZWxvY2l0eS55OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ncmF2aXR5LnkgKyB0aGlzLnZlbG9jaXR5Lnk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4gVmVjdG9yIGZyb20gdGhpcyBCb2R5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3N1YgogICAgKiBAcHJvdGVjdGVkCiAgICAqIEBwYXJhbSB7U0FULlZlY3Rvcn0gdiAtIFRoZSB2ZWN0b3IgdG8gc3Vic3RyYWN0IGZyb20gdGhpcyBCb2R5LgogICAgKi8KICAgIHN1YjogZnVuY3Rpb24gKHYpIHsKCiAgICAgICAgdGhpcy54IC09IHYueDsKICAgICAgICB0aGlzLnkgLT0gdi55OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgdGhlIGdpdmVuIFZlY3RvciB0byB0aGlzIEJvZHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjYWRkCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtTQVQuVmVjdG9yfSB2IC0gVGhlIHZlY3RvciB0byBhZGQgdG8gdGhpcyBCb2R5LgogICAgKi8KICAgIGFkZDogZnVuY3Rpb24gKHYpIHsKCiAgICAgICAgdGhpcy54ICs9IHYueDsKICAgICAgICB0aGlzLnkgKz0gdi55OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNlcGFyYXRpb24gcmVzcG9uc2UgaGFuZGxlci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNnaXZlCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IHRoYXQgY29sbGlkZWQuCiAgICAqIEBwYXJhbSB7U0FULlJlc3BvbnNlfSByZXNwb25zZSAtIFRoZSBTQVQgUmVzcG9uc2Ugb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGNvbGxpc2lvbiBkYXRhLgogICAgKi8KICAgIGdpdmU6IGZ1bmN0aW9uIChib2R5LCByZXNwb25zZSkgewoKICAgICAgICB0aGlzLmFkZChyZXNwb25zZS5vdmVybGFwVik7CgogICAgICAgIGlmICh0aGlzLnJlYm91bmQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnByb2Nlc3NSZWJvdW5kKGJvZHkpOwogICAgICAgICAgICB0aGlzLnJlYm91bmRDaGVjayh0cnVlLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgICAgIGJvZHkucmVib3VuZENoZWNrKHRydWUsIHRydWUsIGZhbHNlKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU2VwYXJhdGlvbiByZXNwb25zZSBoYW5kbGVyLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3Rha2UKICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gVGhlIEJvZHkgdGhhdCBjb2xsaWRlZC4KICAgICogQHBhcmFtIHtTQVQuUmVzcG9uc2V9IHJlc3BvbnNlIC0gVGhlIFNBVCBSZXNwb25zZSBvYmplY3QgY29udGFpbmluZyB0aGUgY29sbGlzaW9uIGRhdGEuCiAgICAqLwogICAgdGFrZTogZnVuY3Rpb24gKGJvZHksIHJlc3BvbnNlKSB7CgogICAgICAgIHRoaXMuc3ViKHJlc3BvbnNlLm92ZXJsYXBWKTsKCiAgICAgICAgaWYgKHRoaXMucmVib3VuZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1JlYm91bmQoYm9keSk7CiAgICAgICAgICAgIHRoaXMucmVib3VuZENoZWNrKHRydWUsIHRydWUsIGZhbHNlKTsKICAgICAgICAgICAgYm9keS5yZWJvdW5kQ2hlY2sodHJ1ZSwgdHJ1ZSwgZmFsc2UpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTcGxpdCB0aGUgY29sbGlzaW9uIHJlc3BvbnNlIGV2ZW5seSBiZXR3ZWVuIHRoZSB0d28gYm9kaWVzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3NwbGl0CiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IHRoYXQgY29sbGlkZWQuCiAgICAqIEBwYXJhbSB7U0FULlJlc3BvbnNlfSByZXNwb25zZSAtIFRoZSBTQVQgUmVzcG9uc2Ugb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGNvbGxpc2lvbiBkYXRhLgogICAgKi8KICAgIHNwbGl0OiBmdW5jdGlvbiAoYm9keSwgcmVzcG9uc2UpIHsKICAgIAogICAgICAgIHJlc3BvbnNlLm92ZXJsYXBWLnNjYWxlKDAuNSk7CiAgICAgICAgdGhpcy5zdWIocmVzcG9uc2Uub3ZlcmxhcFYpOwogICAgICAgIGJvZHkuYWRkKHJlc3BvbnNlLm92ZXJsYXBWKTsKCiAgICAgICAgaWYgKHRoaXMucmVib3VuZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZXhjaGFuZ2UoYm9keSk7CiAgICAgICAgICAgIHRoaXMucmVib3VuZENoZWNrKHRydWUsIHRydWUsIGZhbHNlKTsKICAgICAgICAgICAgYm9keS5yZWJvdW5kQ2hlY2sodHJ1ZSwgdHJ1ZSwgZmFsc2UpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBFeGNoYW5nZSB2ZWxvY2l0eSB3aXRoIHRoZSBnaXZlbiBCb2R5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2V4Y2hhbmdlCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IHRoYXQgY29sbGlkZWQuCiAgICAqLwogICAgZXhjaGFuZ2U6IGZ1bmN0aW9uIChib2R5KSB7CgogICAgICAgIGlmICh0aGlzLm1hc3MgPT09IGJvZHkubWFzcyAmJiB0aGlzLnNwZWVkID4gMCAmJiBib2R5LnNwZWVkID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBBIGRpcmVjdCB2ZWxvY2l0eSBleGNoYW5nZSAoYXMgdGhleSBhcmUgYm90aCBtb3ZpbmcgYW5kIGhhdmUgdGhlIHNhbWUgbWFzcykKICAgICAgICAgICAgdGhpcy5fZHggPSBib2R5LnZlbG9jaXR5Lng7CiAgICAgICAgICAgIHRoaXMuX2R5ID0gYm9keS52ZWxvY2l0eS55OwoKICAgICAgICAgICAgYm9keS52ZWxvY2l0eS54ID0gdGhpcy52ZWxvY2l0eS54ICogYm9keS5ib3VuY2UueDsKICAgICAgICAgICAgYm9keS52ZWxvY2l0eS55ID0gdGhpcy52ZWxvY2l0eS55ICogYm9keS5ib3VuY2UueDsKCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCA9IHRoaXMuX2R4ICogdGhpcy5ib3VuY2UueDsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ID0gdGhpcy5fZHkgKiB0aGlzLmJvdW5jZS55OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB2YXIgbnYxID0gTWF0aC5zcXJ0KChib2R5LnZlbG9jaXR5LnggKiBib2R5LnZlbG9jaXR5LnggKiBib2R5Lm1hc3MpIC8gdGhpcy5tYXNzKSAqICgoYm9keS52ZWxvY2l0eS54ID4gMCkgPyAxIDogLTEpOwogICAgICAgICAgICB2YXIgbnYyID0gTWF0aC5zcXJ0KCh0aGlzLnZlbG9jaXR5LnggKiB0aGlzLnZlbG9jaXR5LnggKiB0aGlzLm1hc3MpIC8gYm9keS5tYXNzKSAqICgodGhpcy52ZWxvY2l0eS54ID4gMCkgPyAxIDogLTEpOwogICAgICAgICAgICB2YXIgYXZlcmFnZSA9IChudjEgKyBudjIpICogMC41OwogICAgICAgICAgICBudjEgLT0gYXZlcmFnZTsKICAgICAgICAgICAgbnYyIC09IGF2ZXJhZ2U7CgogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggPSBudjE7CiAgICAgICAgICAgIGJvZHkudmVsb2NpdHkueCA9IG52MjsKCiAgICAgICAgICAgIG52MSA9IE1hdGguc3FydCgoYm9keS52ZWxvY2l0eS55ICogYm9keS52ZWxvY2l0eS55ICogYm9keS5tYXNzKSAvIHRoaXMubWFzcykgKiAoKGJvZHkudmVsb2NpdHkueSA+IDApID8gMSA6IC0xKTsKICAgICAgICAgICAgbnYyID0gTWF0aC5zcXJ0KCh0aGlzLnZlbG9jaXR5LnkgKiB0aGlzLnZlbG9jaXR5LnkgKiB0aGlzLm1hc3MpIC8gYm9keS5tYXNzKSAqICgodGhpcy52ZWxvY2l0eS55ID4gMCkgPyAxIDogLTEpOwogICAgICAgICAgICBhdmVyYWdlID0gKG52MSArIG52MikgKiAwLjU7CiAgICAgICAgICAgIG52MSAtPSBhdmVyYWdlOwogICAgICAgICAgICBudjIgLT0gYXZlcmFnZTsKCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSA9IG52MTsKICAgICAgICAgICAgYm9keS52ZWxvY2l0eS55ID0gbnYyOwogICAgICAgIH0KCiAgICAgICAgLy8gIHVwZGF0ZSBzcGVlZCAvIGFuZ2xlPwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlYm91bmQgdGhlIHZlbG9jaXR5IG9mIHRoaXMgQm9keS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNwcm9jZXNzUmVib3VuZAogICAgKiBAcHJvdGVjdGVkCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkgLSBUaGUgQm9keSB0aGF0IGNvbGxpZGVkLgogICAgKi8KICAgIHByb2Nlc3NSZWJvdW5kOiBmdW5jdGlvbiAoYm9keSkgewoKICAgICAgICAvLyAgRG9uJ3QgcmVib3VuZCBhZ2FpbiBpZiB0aGV5J3ZlIGFscmVhZHkgcmVib3VuZGVkIGluIHRoaXMgZnJhbWUKICAgICAgICBpZiAoISh0aGlzLl92eCA8PSAwICYmIHRoaXMudmVsb2NpdHkueCA+IDApICYmICEodGhpcy5fdnggPj0gMCAmJiB0aGlzLnZlbG9jaXR5LnggPCAwKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCA9IGJvZHkudmVsb2NpdHkueCAtIHRoaXMudmVsb2NpdHkueCAqIHRoaXMuYm91bmNlLng7CiAgICAgICAgfQoKICAgICAgICBpZiAoISh0aGlzLl92eSA8PSAwICYmIHRoaXMudmVsb2NpdHkueSA+IDApICYmICEodGhpcy5fdnkgPj0gMCAmJiB0aGlzLnZlbG9jaXR5LnkgPCAwKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSA9IGJvZHkudmVsb2NpdHkueSAtIHRoaXMudmVsb2NpdHkueSAqIHRoaXMuYm91bmNlLnk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmFuZ2xlID0gTWF0aC5hdGFuMih0aGlzLnZlbG9jaXR5LnksIHRoaXMudmVsb2NpdHkueCk7CgogICAgICAgIHRoaXMucmVib3VuZENoZWNrKHRydWUsIHRydWUsIGZhbHNlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgZm9yIGFuIG92ZXJsYXAgYmV0d2VlbiB0aGlzIEJvZHkgYW5kIHRoZSBnaXZlbiBCb2R5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I292ZXJsYXAKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IHRoYXQgaXMgYmVpbmcgY2hlY2tlZCBhZ2FpbnN0IHRoaXMgQm9keS4KICAgICogQHBhcmFtIHtTQVQuUmVzcG9uc2V9IHJlc3BvbnNlIC0gU0FUIFJlc3BvbnNlIGhhbmRsZXIuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIHR3byBib2RpZXMgb3ZlcmxhcCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIG92ZXJsYXA6IGZ1bmN0aW9uIChib2R5LCByZXNwb25zZSkgewoKICAgICAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CgogICAgICAgIGlmICgodGhpcy50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuUkVDVCB8fCB0aGlzLnR5cGUgPT09IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5QT0xZR09OKSAmJiAoYm9keS50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuUkVDVCB8fCBib2R5LnR5cGUgPT09IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5QT0xZR09OKSkKICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA9IFNBVC50ZXN0UG9seWdvblBvbHlnb24odGhpcy5wb2x5Z29uLCBib2R5LnBvbHlnb24sIHJlc3BvbnNlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQ0lSQ0xFICYmIGJvZHkudHlwZSA9PT0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkNJUkNMRSkKICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA9IFNBVC50ZXN0Q2lyY2xlQ2lyY2xlKHRoaXMuc2hhcGUsIGJvZHkuc2hhcGUsIHJlc3BvbnNlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoKHRoaXMudHlwZSA9PT0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLlJFQ1QgfHwgdGhpcy50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuUE9MWUdPTikgJiYgYm9keS50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQ0lSQ0xFKQogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0ID0gU0FULnRlc3RQb2x5Z29uQ2lyY2xlKHRoaXMucG9seWdvbiwgYm9keS5zaGFwZSwgcmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnR5cGUgPT09IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5DSVJDTEUgJiYgKGJvZHkudHlwZSA9PT0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLlJFQ1QgfHwgYm9keS50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuUE9MWUdPTikpCiAgICAgICAgewogICAgICAgICAgICByZXN1bHQgPSBTQVQudGVzdENpcmNsZVBvbHlnb24odGhpcy5zaGFwZSwgYm9keS5wb2x5Z29uLCByZXNwb25zZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXJlc3VsdCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlQ29udGFjdChib2R5KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQ7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGlmIHRoaXMgQm9keSBpcyBhbHJlYWR5IGluIGNvbnRhY3Qgd2l0aCB0aGUgZ2l2ZW4gQm9keS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNpbkNvbnRhY3QKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IHRvIGJlIGNoZWNrZWQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIEJvZHkgaXMgYWxyZWFkeSBpbiBjb250YWN0IHdpdGggdGhpcyBCb2R5LgogICAgKi8KICAgIGluQ29udGFjdDogZnVuY3Rpb24gKGJvZHkpIHsKCiAgICAgICAgcmV0dXJuICh0aGlzLmNvbnRhY3RzLmluZGV4T2YoYm9keSkgIT0gLTEpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgdGhlIGdpdmVuIEJvZHkgdG8gdGhlIGNvbnRhY3QgbGlzdCBvZiB0aGlzIEJvZHkuIEFsc28gYWRkcyB0aGlzIEJvZHkgdG8gdGhlIGNvbnRhY3QgbGlzdCBvZiB0aGUgZ2l2ZW4gQm9keS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNhZGRDb250YWN0CiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkgLSBUaGUgQm9keSB0byBiZSBhZGRlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gQm9keSB3YXMgYWRkZWQgdG8gdGhpcyBjb250YWN0IGxpc3QsIGZhbHNlIGlmIGFscmVhZHkgb24gaXQuCiAgICAqLwogICAgYWRkQ29udGFjdDogZnVuY3Rpb24gKGJvZHkpIHsKCiAgICAgICAgaWYgKHRoaXMuaW5Db250YWN0KGJvZHkpKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb250YWN0cy5wdXNoKGJvZHkpOwoKICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25CZWdpbkNvbnRhY3QuZGlzcGF0Y2godGhpcy5zcHJpdGUsIGJvZHkuc3ByaXRlLCB0aGlzLCBib2R5KTsKCiAgICAgICAgYm9keS5hZGRDb250YWN0KHRoaXMpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIHRoZSBnaXZlbiBCb2R5IGZyb20gdGhlIGNvbnRhY3QgbGlzdCBvZiB0aGlzIEJvZHkuIEFsc28gcmVtb3ZlcyB0aGlzIEJvZHkgZnJvbSB0aGUgY29udGFjdCBsaXN0IG9mIHRoZSBnaXZlbiBCb2R5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3JlbW92ZUNvbnRhY3QKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IHRvIGJlIHJlbW92ZWQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIEJvZHkgd2FzIHJlbW92ZWQgZnJvbSB0aGlzIGNvbnRhY3QgbGlzdCwgZmFsc2UgaWYgd2Fzbid0IG9uIGl0LgogICAgKi8KICAgIHJlbW92ZUNvbnRhY3Q6IGZ1bmN0aW9uIChib2R5KSB7CgogICAgICAgIGlmICghdGhpcy5pbkNvbnRhY3QoYm9keSkpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNvbnRhY3RzLnNwbGljZSh0aGlzLmNvbnRhY3RzLmluZGV4T2YoYm9keSksIDEpOwoKICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25FbmRDb250YWN0LmRpc3BhdGNoKHRoaXMuc3ByaXRlLCBib2R5LnNwcml0ZSwgdGhpcywgYm9keSk7CgogICAgICAgIGJvZHkucmVtb3ZlQ29udGFjdCh0aGlzKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogVGhpcyBzZXBhcmF0ZXMgdGhpcyBCb2R5IGZyb20gdGhlIGdpdmVuIEJvZHkgdW5sZXNzIGEgY3VzdG9tU2VwYXJhdGVDYWxsYmFjayBpcyBzZXQuCiAgICAqIEl0IGFzc3VtZXMgdGhleSBoYXZlIGFscmVhZHkgYmVlbiBvdmVybGFwIGNoZWNrZWQgYW5kIHRoZSByZXN1bHRpbmcgb3ZlcmxhcCBpcyBzdG9yZWQgaW4gdGhlIFNBVCByZXNwb25zZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNzZXBhcmF0ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkgLSBUaGUgQm9keSB0byBiZSBzZXBhcmF0ZWQgZnJvbSB0aGlzIG9uZS4KICAgICogQHBhcmFtIHtTQVQuUmVzcG9uc2V9IHJlc3BvbnNlIC0gU0FUIFJlc3BvbnNlIGhhbmRsZXIuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGJvZGllcyB3ZXJlIHNlcGFyYXRlZCwgZmFsc2UgaWYgbm90IChmb3IgZXhhbXBsZSBjaGVja0NvbGxpZGUgYWxsb3dzIHRoZW0gdG8gcGFzcyB0aHJvdWdoKQogICAgKi8KICAgIHNlcGFyYXRlOiBmdW5jdGlvbiAoYm9keSwgcmVzcG9uc2UpIHsKCiAgICAgICAgLy8gaWYgKHRoaXMuaW5Db250YWN0KGJvZHkpKQogICAgICAgIC8vIHsKICAgICAgICAgICAgLy8gcmV0dXJuIGZhbHNlOwogICAgICAgIC8vIH0KCiAgICAgICAgdGhpcy5fZGlzdGFuY2VzWzBdID0gYm9keS5yaWdodCAtIHRoaXMueDsgICAvLyBEaXN0YW5jZSBvZiBCIHRvIGZhY2Ugb24gbGVmdCBzaWRlIG9mIEEKICAgICAgICB0aGlzLl9kaXN0YW5jZXNbMV0gPSB0aGlzLnJpZ2h0IC0gYm9keS54OyAgIC8vIERpc3RhbmNlIG9mIEIgdG8gZmFjZSBvbiByaWdodCBzaWRlIG9mIEEKICAgICAgICB0aGlzLl9kaXN0YW5jZXNbMl0gPSBib2R5LmJvdHRvbSAtIHRoaXMueTsgIC8vIERpc3RhbmNlIG9mIEIgdG8gZmFjZSBvbiBib3R0b20gc2lkZSBvZiBBCiAgICAgICAgdGhpcy5fZGlzdGFuY2VzWzNdID0gdGhpcy5ib3R0b20gLSBib2R5Lnk7ICAvLyBEaXN0YW5jZSBvZiBCIHRvIGZhY2Ugb24gdG9wIHNpZGUgb2YgQQoKICAgICAgICAvLyAgSWYgd2UndmUgemVybyBkaXN0YW5jZSB0aGVuIGNoZWNrIGZvciBzaWRlLXNsaWNpbmcKICAgICAgICBpZiAocmVzcG9uc2Uub3ZlcmxhcE4ueCAmJiAodGhpcy5fZGlzdGFuY2VzWzBdID09PSAwIHx8IHRoaXMuX2Rpc3RhbmNlc1sxXSA9PT0gMCkpCiAgICAgICAgewogICAgICAgICAgICByZXNwb25zZS5vdmVybGFwTi54ID0gZmFsc2U7CiAgICAgICAgICAgIHJlc3BvbnNlLm92ZXJsYXBOLnkgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChyZXNwb25zZS5vdmVybGFwTi55ICYmICh0aGlzLl9kaXN0YW5jZXNbMl0gPT09IDAgfHwgdGhpcy5fZGlzdGFuY2VzWzNdID09PSAwKSkKICAgICAgICB7CiAgICAgICAgICAgIHJlc3BvbnNlLm92ZXJsYXBOLnggPSB0cnVlOwogICAgICAgICAgICByZXNwb25zZS5vdmVybGFwTi55ID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jdXN0b21TZXBhcmF0ZUNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3VzdG9tU2VwYXJhdGVDYWxsYmFjay5jYWxsKHRoaXMuY3VzdG9tU2VwYXJhdGVDb250ZXh0LCB0aGlzLCByZXNwb25zZSwgdGhpcy5fZGlzdGFuY2VzKTsKICAgICAgICB9CgogICAgICAgIHZhciBoYXNTZXBhcmF0ZWQgPSBmYWxzZTsKCiAgICAgICAgaWYgKHJlc3BvbnNlLm92ZXJsYXBOLngpCiAgICAgICAgewogICAgICAgICAgICAvLyAgV2hpY2ggaXMgc21hbGxlcj8gTGVmdCBvciBSaWdodD8KICAgICAgICAgICAgaWYgKHRoaXMuX2Rpc3RhbmNlc1swXSA8IHRoaXMuX2Rpc3RhbmNlc1sxXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaGFzU2VwYXJhdGVkID0gdGhpcy5oaXRMZWZ0KGJvZHksIHJlc3BvbnNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLl9kaXN0YW5jZXNbMV0gPCB0aGlzLl9kaXN0YW5jZXNbMF0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGhhc1NlcGFyYXRlZCA9IHRoaXMuaGl0UmlnaHQoYm9keSwgcmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHJlc3BvbnNlLm92ZXJsYXBOLnkpCiAgICAgICAgewogICAgICAgICAgICAvLyAgV2hpY2ggaXMgc21hbGxlcj8gVG9wIG9yIEJvdHRvbT8KICAgICAgICAgICAgaWYgKHRoaXMuX2Rpc3RhbmNlc1syXSA8IHRoaXMuX2Rpc3RhbmNlc1szXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaGFzU2VwYXJhdGVkID0gdGhpcy5oaXRUb3AoYm9keSwgcmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuX2Rpc3RhbmNlc1szXSA8IHRoaXMuX2Rpc3RhbmNlc1syXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaGFzU2VwYXJhdGVkID0gdGhpcy5oaXRCb3R0b20oYm9keSwgcmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoaGFzU2VwYXJhdGVkKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLnBoeXNpY3MuY2hlY2tCb3VuZHModGhpcyk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5waHlzaWNzLmNoZWNrQm91bmRzKGJvZHkpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgVGhleSBjYW4gb25seSBjb250YWN0IGxpa2UgdGhpcyBpZiBhdCBsZWFzdCBvbmUgb2YgdGhlaXIgc2lkZXMgaXMgb3Blbiwgb3RoZXJ3aXNlIGl0J3MgYSBzZXBhcmF0aW9uCiAgICAgICAgICAgIGlmICghdGhpcy5jaGVja0NvbGxpc2lvbi51cCB8fCAhdGhpcy5jaGVja0NvbGxpc2lvbi5kb3duIHx8ICF0aGlzLmNoZWNrQ29sbGlzaW9uLmxlZnQgfHwgIXRoaXMuY2hlY2tDb2xsaXNpb24ucmlnaHQgfHwgIWJvZHkuY2hlY2tDb2xsaXNpb24udXAgfHwgIWJvZHkuY2hlY2tDb2xsaXNpb24uZG93biB8fCAhYm9keS5jaGVja0NvbGxpc2lvbi5sZWZ0IHx8ICFib2R5LmNoZWNrQ29sbGlzaW9uLnJpZ2h0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmFkZENvbnRhY3QoYm9keSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBoYXNTZXBhcmF0ZWQ7CgogICAgfSwKCiAgICAvKioKICAgICogUHJvY2VzcyBhIGNvbGxpc2lvbiB3aXRoIHRoZSBsZWZ0IGZhY2Ugb2YgdGhpcyBCb2R5LgogICAgKiBDb2xsaXNpb24gYW5kIHNlcGFyYXRpb24gY2FuIGJlIGZ1cnRoZXIgY2hlY2tlZCBieSBzZXR0aW5nIGEgY29sbGlkZUNhbGxiYWNrLgogICAgKiBUaGlzIGNhbGxiYWNrIHdpbGwgYmUgc2VudCA0IHBhcmFtZXRlcnM6IFRoZSBmYWNlIG9mIGNvbGxpc2lvbiwgdGhpcyBCb2R5LCB0aGUgY29sbGlkaW5nIEJvZHkgYW5kIHRoZSBTQVQgUmVzcG9uc2UuCiAgICAqIElmIHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWUgdGhlbiBzZXBhcmF0aW9uLCByZWJvdW5kcyBhbmQgdGhlIHRvdWNoaW5nIGZsYWdzIHdpbGwgYWxsIGJlIHNldC4KICAgICogSWYgaXQgcmV0dXJucyBmYWxzZSB0aGlzIHdpbGwgYmUgc2tpcHBlZCBhbmQgbXVzdCBiZSBoYW5kbGVkIG1hbnVhbGx5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2hpdExlZnQKICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gVGhlIEJvZHkgdGhhdCBjb2xsaWRlZC4KICAgICogQHBhcmFtIHtTQVQuUmVzcG9uc2V9IHJlc3BvbnNlIC0gVGhlIFNBVCBSZXNwb25zZSBvYmplY3QgY29udGFpbmluZyB0aGUgY29sbGlzaW9uIGRhdGEuCiAgICAqLwogICAgaGl0TGVmdDogZnVuY3Rpb24gKGJvZHksIHJlc3BvbnNlKSB7CgogICAgICAgIGlmICghdGhpcy5jaGVja0NvbGxpc2lvbi5sZWZ0IHx8ICFib2R5LmNoZWNrQ29sbGlzaW9uLnJpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY29sbGlkZUNhbGxiYWNrICYmICF0aGlzLmNvbGxpZGVDYWxsYmFjay5jYWxsKHRoaXMuY29sbGlkZUNhbGxiYWNrQ29udGV4dCwgUGhhc2VyLkxFRlQsIHRoaXMsIGJvZHksIHJlc3BvbnNlKSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghdGhpcy5tb3ZlcyB8fCB0aGlzLmltbW92YWJsZSB8fCB0aGlzLmJsb2NrZWQucmlnaHQgfHwgdGhpcy50b3VjaGluZy5yaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIGJvZHkuZ2l2ZSh0aGlzLCByZXNwb25zZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmIChib2R5LmltbW92YWJsZSB8fCBib2R5LmJsb2NrZWQubGVmdCB8fCBib2R5LnRvdWNoaW5nLmxlZnQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBXZSB0YWtlIHRoZSBmdWxsIHNlcGFyYXRpb24KICAgICAgICAgICAgICAgIHRoaXMudGFrZShib2R5LCByZXNwb25zZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgU2hhcmUgb3V0IHRoZSBzZXBhcmF0aW9uCiAgICAgICAgICAgICAgICB0aGlzLnNwbGl0KGJvZHksIHJlc3BvbnNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy50b3VjaGluZy5sZWZ0ID0gdHJ1ZTsKICAgICAgICBib2R5LnRvdWNoaW5nLnJpZ2h0ID0gdHJ1ZTsKCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogUHJvY2VzcyBhIGNvbGxpc2lvbiB3aXRoIHRoZSByaWdodCBmYWNlIG9mIHRoaXMgQm9keS4KICAgICogQ29sbGlzaW9uIGFuZCBzZXBhcmF0aW9uIGNhbiBiZSBmdXJ0aGVyIGNoZWNrZWQgYnkgc2V0dGluZyBhIGNvbGxpZGVDYWxsYmFjay4KICAgICogVGhpcyBjYWxsYmFjayB3aWxsIGJlIHNlbnQgNCBwYXJhbWV0ZXJzOiBUaGUgZmFjZSBvZiBjb2xsaXNpb24sIHRoaXMgQm9keSwgdGhlIGNvbGxpZGluZyBCb2R5IGFuZCB0aGUgU0FUIFJlc3BvbnNlLgogICAgKiBJZiB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVlIHRoZW4gc2VwYXJhdGlvbiwgcmVib3VuZHMgYW5kIHRoZSB0b3VjaGluZyBmbGFncyB3aWxsIGFsbCBiZSBzZXQuCiAgICAqIElmIGl0IHJldHVybnMgZmFsc2UgdGhpcyB3aWxsIGJlIHNraXBwZWQgYW5kIG11c3QgYmUgaGFuZGxlZCBtYW51YWxseS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNoaXRSaWdodAogICAgKiBAcHJvdGVjdGVkCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkgLSBUaGUgQm9keSB0aGF0IGNvbGxpZGVkLgogICAgKiBAcGFyYW0ge1NBVC5SZXNwb25zZX0gcmVzcG9uc2UgLSBUaGUgU0FUIFJlc3BvbnNlIG9iamVjdCBjb250YWluaW5nIHRoZSBjb2xsaXNpb24gZGF0YS4KICAgICovCiAgICBoaXRSaWdodDogZnVuY3Rpb24gKGJvZHksIHJlc3BvbnNlKSB7CgogICAgICAgIGlmICghdGhpcy5jaGVja0NvbGxpc2lvbi5yaWdodCB8fCAhYm9keS5jaGVja0NvbGxpc2lvbi5sZWZ0KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY29sbGlkZUNhbGxiYWNrICYmICF0aGlzLmNvbGxpZGVDYWxsYmFjay5jYWxsKHRoaXMuY29sbGlkZUNhbGxiYWNrQ29udGV4dCwgUGhhc2VyLlJJR0hULCB0aGlzLCBib2R5KSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghdGhpcy5tb3ZlcyB8fCB0aGlzLmltbW92YWJsZSB8fCB0aGlzLmJsb2NrZWQubGVmdCB8fCB0aGlzLnRvdWNoaW5nLmxlZnQpCiAgICAgICAgewogICAgICAgICAgICBib2R5LmdpdmUodGhpcywgcmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoYm9keS5pbW1vdmFibGUgfHwgYm9keS5ibG9ja2VkLnJpZ2h0IHx8IGJvZHkudG91Y2hpbmcucmlnaHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBXZSB0YWtlIHRoZSBmdWxsIHNlcGFyYXRpb24KICAgICAgICAgICAgICAgIHRoaXMudGFrZShib2R5LCByZXNwb25zZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgU2hhcmUgb3V0IHRoZSBzZXBhcmF0aW9uCiAgICAgICAgICAgICAgICB0aGlzLnNwbGl0KGJvZHksIHJlc3BvbnNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy50b3VjaGluZy5yaWdodCA9IHRydWU7CiAgICAgICAgYm9keS50b3VjaGluZy5sZWZ0ID0gdHJ1ZTsKCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogUHJvY2VzcyBhIGNvbGxpc2lvbiB3aXRoIHRoZSB0b3AgZmFjZSBvZiB0aGlzIEJvZHkuCiAgICAqIENvbGxpc2lvbiBhbmQgc2VwYXJhdGlvbiBjYW4gYmUgZnVydGhlciBjaGVja2VkIGJ5IHNldHRpbmcgYSBjb2xsaWRlQ2FsbGJhY2suCiAgICAqIFRoaXMgY2FsbGJhY2sgd2lsbCBiZSBzZW50IDQgcGFyYW1ldGVyczogVGhlIGZhY2Ugb2YgY29sbGlzaW9uLCB0aGlzIEJvZHksIHRoZSBjb2xsaWRpbmcgQm9keSBhbmQgdGhlIFNBVCBSZXNwb25zZS4KICAgICogSWYgdGhlIGNhbGxiYWNrIHJldHVybnMgdHJ1ZSB0aGVuIHNlcGFyYXRpb24sIHJlYm91bmRzIGFuZCB0aGUgdG91Y2hpbmcgZmxhZ3Mgd2lsbCBhbGwgYmUgc2V0LgogICAgKiBJZiBpdCByZXR1cm5zIGZhbHNlIHRoaXMgd2lsbCBiZSBza2lwcGVkIGFuZCBtdXN0IGJlIGhhbmRsZWQgbWFudWFsbHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjaGl0VG9wCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IHRoYXQgY29sbGlkZWQuCiAgICAqIEBwYXJhbSB7U0FULlJlc3BvbnNlfSByZXNwb25zZSAtIFRoZSBTQVQgUmVzcG9uc2Ugb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGNvbGxpc2lvbiBkYXRhLgogICAgKi8KICAgIGhpdFRvcDogZnVuY3Rpb24gKGJvZHksIHJlc3BvbnNlKSB7CgogICAgICAgIGlmICghdGhpcy5jaGVja0NvbGxpc2lvbi51cCB8fCAhYm9keS5jaGVja0NvbGxpc2lvbi5kb3duKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY29sbGlkZUNhbGxiYWNrICYmICF0aGlzLmNvbGxpZGVDYWxsYmFjay5jYWxsKHRoaXMuY29sbGlkZUNhbGxiYWNrQ29udGV4dCwgUGhhc2VyLlVQLCB0aGlzLCBib2R5KSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghdGhpcy5tb3ZlcyB8fCB0aGlzLmltbW92YWJsZSB8fCB0aGlzLmJsb2NrZWQuZG93biB8fCB0aGlzLnRvdWNoaW5nLmRvd24pCiAgICAgICAgewogICAgICAgICAgICBib2R5LmdpdmUodGhpcywgcmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoYm9keS5pbW1vdmFibGUgfHwgYm9keS5ibG9ja2VkLnVwIHx8IGJvZHkudG91Y2hpbmcudXApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBXZSB0YWtlIHRoZSBmdWxsIHNlcGFyYXRpb24KICAgICAgICAgICAgICAgIHRoaXMudGFrZShib2R5LCByZXNwb25zZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgU2hhcmUgb3V0IHRoZSBzZXBhcmF0aW9uCiAgICAgICAgICAgICAgICB0aGlzLnNwbGl0KGJvZHksIHJlc3BvbnNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy50b3VjaGluZy51cCA9IHRydWU7CiAgICAgICAgYm9keS50b3VjaGluZy5kb3duID0gdHJ1ZTsKCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogUHJvY2VzcyBhIGNvbGxpc2lvbiB3aXRoIHRoZSBib3R0b20gZmFjZSBvZiB0aGlzIEJvZHkuCiAgICAqIENvbGxpc2lvbiBhbmQgc2VwYXJhdGlvbiBjYW4gYmUgZnVydGhlciBjaGVja2VkIGJ5IHNldHRpbmcgYSBjb2xsaWRlQ2FsbGJhY2suCiAgICAqIFRoaXMgY2FsbGJhY2sgd2lsbCBiZSBzZW50IDQgcGFyYW1ldGVyczogVGhlIGZhY2Ugb2YgY29sbGlzaW9uLCB0aGlzIEJvZHksIHRoZSBjb2xsaWRpbmcgQm9keSBhbmQgdGhlIFNBVCBSZXNwb25zZS4KICAgICogSWYgdGhlIGNhbGxiYWNrIHJldHVybnMgdHJ1ZSB0aGVuIHNlcGFyYXRpb24sIHJlYm91bmRzIGFuZCB0aGUgdG91Y2hpbmcgZmxhZ3Mgd2lsbCBhbGwgYmUgc2V0LgogICAgKiBJZiBpdCByZXR1cm5zIGZhbHNlIHRoaXMgd2lsbCBiZSBza2lwcGVkIGFuZCBtdXN0IGJlIGhhbmRsZWQgbWFudWFsbHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjaGl0Qm90dG9tCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IHRoYXQgY29sbGlkZWQuCiAgICAqIEBwYXJhbSB7U0FULlJlc3BvbnNlfSByZXNwb25zZSAtIFRoZSBTQVQgUmVzcG9uc2Ugb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGNvbGxpc2lvbiBkYXRhLgogICAgKi8KICAgIGhpdEJvdHRvbTogZnVuY3Rpb24gKGJvZHksIHJlc3BvbnNlKSB7CgogICAgICAgIGlmICghdGhpcy5jaGVja0NvbGxpc2lvbi5kb3duIHx8ICFib2R5LmNoZWNrQ29sbGlzaW9uLnVwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY29sbGlkZUNhbGxiYWNrICYmICF0aGlzLmNvbGxpZGVDYWxsYmFjay5jYWxsKHRoaXMuY29sbGlkZUNhbGxiYWNrQ29udGV4dCwgUGhhc2VyLkRPV04sIHRoaXMsIGJvZHkpKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLm1vdmVzIHx8IHRoaXMuaW1tb3ZhYmxlIHx8IHRoaXMuYmxvY2tlZC51cCB8fCB0aGlzLnRvdWNoaW5nLnVwKQogICAgICAgIHsKICAgICAgICAgICAgYm9keS5naXZlKHRoaXMsIHJlc3BvbnNlKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGJvZHkuaW1tb3ZhYmxlIHx8IGJvZHkuYmxvY2tlZC5kb3duIHx8IGJvZHkudG91Y2hpbmcuZG93bikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFdlIHRha2UgdGhlIGZ1bGwgc2VwYXJhdGlvbgogICAgICAgICAgICAgICAgdGhpcy50YWtlKGJvZHksIHJlc3BvbnNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBTaGFyZSBvdXQgdGhlIHNlcGFyYXRpb24KICAgICAgICAgICAgICAgIHRoaXMuc3BsaXQoYm9keSwgcmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnRvdWNoaW5nLmRvd24gPSB0cnVlOwogICAgICAgIGJvZHkudG91Y2hpbmcudXAgPSB0cnVlOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QuIEludGVncmF0ZXMgdmVsb2NpdHksIGdsb2JhbCBncmF2aXR5IGFuZCB0aGUgZGVsdGEgdGltZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjaW50ZWdyYXRlVmVsb2NpdHkKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGludGVncmF0ZVZlbG9jaXR5OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuX3RlbXAgPSB0aGlzLmdhbWUucGh5c2ljcy51cGRhdGVNb3Rpb24odGhpcyk7CiAgICAgICAgdGhpcy5fZHggPSB0aGlzLmdhbWUudGltZS5waHlzaWNzRWxhcHNlZCAqICh0aGlzLnZlbG9jaXR5LnggKyB0aGlzLl90ZW1wLnggLyAyKTsKICAgICAgICB0aGlzLl9keSA9IHRoaXMuZ2FtZS50aW1lLnBoeXNpY3NFbGFwc2VkICogKHRoaXMudmVsb2NpdHkueSArIHRoaXMuX3RlbXAueSAvIDIpOwoKICAgICAgICAvLyAgcG9zaXRpdmUgPSBSSUdIVCAvIERPV04KICAgICAgICAvLyAgbmVnYXRpdmUgPSBMRUZUIC8gVVAKCiAgICAgICAgaWYgKCh0aGlzLl9keCA8IDAgJiYgIXRoaXMuYmxvY2tlZC5sZWZ0ICYmICF0aGlzLnRvdWNoaW5nLmxlZnQpIHx8ICh0aGlzLl9keCA+IDAgJiYgIXRoaXMuYmxvY2tlZC5yaWdodCAmJiAhdGhpcy50b3VjaGluZy5yaWdodCkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnggKz0gdGhpcy5fZHg7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCArPSB0aGlzLl90ZW1wLng7CiAgICAgICAgfQoKICAgICAgICBpZiAoKHRoaXMuX2R5IDwgMCAmJiAhdGhpcy5ibG9ja2VkLnVwICYmICF0aGlzLnRvdWNoaW5nLnVwKSB8fCAodGhpcy5fZHkgPiAwICYmICF0aGlzLmJsb2NrZWQuZG93biAmJiAhdGhpcy50b3VjaGluZy5kb3duKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMueSArPSB0aGlzLl9keTsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICs9IHRoaXMuX3RlbXAueTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnZlbG9jaXR5LnggPiB0aGlzLm1heFZlbG9jaXR5LngpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggPSB0aGlzLm1heFZlbG9jaXR5Lng7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMudmVsb2NpdHkueCA8IC10aGlzLm1heFZlbG9jaXR5LngpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggPSAtdGhpcy5tYXhWZWxvY2l0eS54OwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudmVsb2NpdHkueSA+IHRoaXMubWF4VmVsb2NpdHkueSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSA9IHRoaXMubWF4VmVsb2NpdHkueTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy52ZWxvY2l0eS55IDwgLXRoaXMubWF4VmVsb2NpdHkueSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSA9IC10aGlzLm1heFZlbG9jaXR5Lnk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZC4gVGhpcyBpcyBjYWxsZWQgZGlyZWN0bHkgYmVmb3JlIHRoZSBzcHJpdGVzIGFyZSBzZW50IHRvIHRoZSByZW5kZXJlciBhbmQgYWZ0ZXIgdGhlIHVwZGF0ZSBmdW5jdGlvbiBoYXMgZmluaXNoZWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjcG9zdFVwZGF0ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcG9zdFVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5tb3ZlcykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5waHlzaWNzLmNoZWNrQm91bmRzKHRoaXMpOwoKICAgICAgICAgICAgdGhpcy5yZWJvdW5kQ2hlY2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSk7CgogICAgICAgICAgICB0aGlzLl9keCA9IHRoaXMuZGVsdGFYKCk7CiAgICAgICAgICAgIHRoaXMuX2R5ID0gdGhpcy5kZWx0YVkoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLl9keCA8IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZmFjaW5nID0gUGhhc2VyLkxFRlQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5fZHggPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZhY2luZyA9IFBoYXNlci5SSUdIVDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuX2R5IDwgMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5mYWNpbmcgPSBQaGFzZXIuVVA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5fZHkgPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZhY2luZyA9IFBoYXNlci5ET1dOOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5fZHggIT09IDAgfHwgdGhpcy5fZHkgIT09IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLnggKz0gdGhpcy5fZHg7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS55ICs9IHRoaXMuX2R5OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5hbGxvd1JvdGF0aW9uICYmIHRoaXMuZGVsdGFaKCkgIT09IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmFuZ2xlICs9IHRoaXMuZGVsdGFaKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnNwcml0ZS5zY2FsZS54ICE9PSB0aGlzLl9zeCB8fCB0aGlzLnNwcml0ZS5zY2FsZS55ICE9PSB0aGlzLl9zeSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVTY2FsZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlc2V0cyB0aGUgQm9keSBtb3Rpb24gdmFsdWVzOiB2ZWxvY2l0eSwgYWNjZWxlcmF0aW9uLCBhbmd1bGFyVmVsb2NpdHkgYW5kIGFuZ3VsYXJBY2NlbGVyYXRpb24uCiAgICAqIEFsc28gcmVzZXRzIHRoZSBmb3JjZXMgdG8gZGVmYXVsdHM6IGdyYXZpdHksIGJvdW5jZSwgbWluVmVsb2NpdHksbWF4VmVsb2NpdHksIGFuZ3VsYXJEcmFnLCBtYXhBbmd1bGFyLCBtYXNzLCBmcmljdGlvbiBhbmQgY2hlY2tDb2xsaXNpb24gaWYgJ2Z1bGwnIHNwZWNpZmllZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNyZXNldAogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmdWxsPWZhbHNlXSAtIEEgZnVsbCByZXNldCBjbGVhcnMgZG93biBzZXR0aW5ncyB5b3UgbWF5IGhhdmUgc2V0LCBzdWNoIGFzIGdyYXZpdHksIGJvdW5jZSBhbmQgZHJhZy4gQSBub24tZnVsbCByZXNldCBqdXN0IGNsZWFycyBtb3Rpb24gdmFsdWVzLgogICAgKi8KICAgIHJlc2V0OiBmdW5jdGlvbiAoZnVsbCkgewoKICAgICAgICBpZiAodHlwZW9mIGZ1bGwgPT09ICd1bmRlZmluZWQnKSB7IGZ1bGwgPSBmYWxzZTsgfQoKICAgICAgICBpZiAoZnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ3Jhdml0eS5zZXRUbygwLCAwKTsKICAgICAgICAgICAgdGhpcy5ib3VuY2Uuc2V0VG8oMCwgMCk7CiAgICAgICAgICAgIHRoaXMubWluVmVsb2NpdHkuc2V0VG8oNSwgNSk7CiAgICAgICAgICAgIHRoaXMubWF4VmVsb2NpdHkuc2V0VG8oMTAwMCwgMTAwMCk7CiAgICAgICAgICAgIHRoaXMuYW5ndWxhckRyYWcgPSAwOwogICAgICAgICAgICB0aGlzLm1heEFuZ3VsYXIgPSAxMDAwOwogICAgICAgICAgICB0aGlzLm1hc3MgPSAxOwogICAgICAgICAgICB0aGlzLmZyaWN0aW9uID0gMC4wOwogICAgICAgICAgICB0aGlzLmNoZWNrQ29sbGlzaW9uID0geyBub25lOiBmYWxzZSwgYW55OiB0cnVlLCB1cDogdHJ1ZSwgZG93bjogdHJ1ZSwgbGVmdDogdHJ1ZSwgcmlnaHQ6IHRydWUgfTsKICAgICAgICB9CgogICAgICAgIHRoaXMudmVsb2NpdHkuc2V0VG8oMCwgMCk7CiAgICAgICAgdGhpcy5hY2NlbGVyYXRpb24uc2V0VG8oMCwgMCk7CiAgICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkgPSAwOwogICAgICAgIHRoaXMuYW5ndWxhckFjY2VsZXJhdGlvbiA9IDA7CiAgICAgICAgdGhpcy5ibG9ja2VkID0geyB4OiAwLCB5OiAwLCB1cDogZmFsc2UsIGRvd246IGZhbHNlLCBsZWZ0OiBmYWxzZSwgcmlnaHQ6IGZhbHNlIH07CiAgICAgICAgdGhpcy54ID0gKHRoaXMuc3ByaXRlLndvcmxkLnggLSAodGhpcy5zcHJpdGUuYW5jaG9yLnggKiB0aGlzLnNwcml0ZS53aWR0aCkpICsgdGhpcy5vZmZzZXQueDsKICAgICAgICB0aGlzLnkgPSAodGhpcy5zcHJpdGUud29ybGQueSAtICh0aGlzLnNwcml0ZS5hbmNob3IueSAqIHRoaXMuc3ByaXRlLmhlaWdodCkpICsgdGhpcy5vZmZzZXQueTsKICAgICAgICB0aGlzLnByZVggPSB0aGlzLng7CiAgICAgICAgdGhpcy5wcmVZID0gdGhpcy55OwogICAgICAgIHRoaXMudXBkYXRlQm91bmRzKCk7CgogICAgICAgIHRoaXMuY29udGFjdHMubGVuZ3RoID0gMDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBEZXN0cm95cyB0aGlzIEJvZHkgYW5kIGFsbCByZWZlcmVuY2VzIGl0IGhvbGRzIHRvIG90aGVyIG9iamVjdHMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5zcHJpdGUgPSBudWxsOwoKICAgICAgICB0aGlzLmNvbGxpZGVDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5jb2xsaWRlQ2FsbGJhY2tDb250ZXh0ID0gbnVsbDsKCiAgICAgICAgdGhpcy5jdXN0b21TZXBhcmF0ZUNhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLmN1c3RvbVNlcGFyYXRlQ29udGV4dCA9IG51bGw7CgogICAgICAgIHRoaXMuY29udGFjdHMubGVuZ3RoID0gMDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoaXMgQm9keSB0byB1c2UgYSBjaXJjbGUgb2YgdGhlIGdpdmVuIHJhZGl1cyBmb3IgYWxsIGNvbGxpc2lvbi4KICAgICogVGhlIENpcmNsZSB3aWxsIGJlIGNlbnRlcmVkIG9uIHRoZSBjZW50ZXIgb2YgdGhlIFNwcml0ZSBieSBkZWZhdWx0LCBidXQgY2FuIGJlIGFkanVzdGVkIHZpYSB0aGUgQm9keS5vZmZzZXQgcHJvcGVydHkgYW5kIHRoZSBzZXRDaXJjbGUgeC95IHBhcmFtZXRlcnMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjc2V0Q2lyY2xlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByYWRpdXMgLSBUaGUgcmFkaXVzIG9mIHRoaXMgY2lyY2xlIChpbiBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0WD0wXSAtIFRoZSB4IGFtb3VudCB0aGUgY2lyY2xlIHdpbGwgYmUgb2Zmc2V0IGZyb20gdGhlIFNwcml0ZXMgY2VudGVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW29mZnNldFk9MF0gLSBUaGUgeSBhbW91bnQgdGhlIGNpcmNsZSB3aWxsIGJlIG9mZnNldCBmcm9tIHRoZSBTcHJpdGVzIGNlbnRlci4KICAgICovCiAgICBzZXRDaXJjbGU6IGZ1bmN0aW9uIChyYWRpdXMsIG9mZnNldFgsIG9mZnNldFkpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBvZmZzZXRYID09PSAndW5kZWZpbmVkJykgeyBvZmZzZXRYID0gdGhpcy5zcHJpdGUuX2NhY2hlLmhhbGZXaWR0aDsgfQogICAgICAgIGlmICh0eXBlb2Ygb2Zmc2V0WSA9PT0gJ3VuZGVmaW5lZCcpIHsgb2Zmc2V0WSA9IHRoaXMuc3ByaXRlLl9jYWNoZS5oYWxmSGVpZ2h0OyB9CgogICAgICAgIHRoaXMudHlwZSA9IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5DSVJDTEU7CiAgICAgICAgdGhpcy5zaGFwZSA9IG5ldyBTQVQuQ2lyY2xlKG5ldyBTQVQuVmVjdG9yKHRoaXMuc3ByaXRlLngsIHRoaXMuc3ByaXRlLnkpLCByYWRpdXMpOwogICAgICAgIHRoaXMucG9seWdvbiA9IG51bGw7CgogICAgICAgIHRoaXMub2Zmc2V0LnNldFRvKG9mZnNldFgsIG9mZnNldFkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhpcyBCb2R5IHRvIHVzZSBhIHJlY3RhbmdsZSBmb3IgYWxsIGNvbGxpc2lvbi4KICAgICogSWYgeW91IGRvbid0IHNwZWNpZnkgYW55IHBhcmFtZXRlcnMgaXQgd2lsbCBiZSBzaXplZCB0byBtYXRjaCB0aGUgcGFyZW50IFNwcml0ZXMgY3VycmVudCB3aWR0aCBhbmQgaGVpZ2h0IChpbmNsdWRpbmcgc2NhbGUgZmFjdG9yKSBhbmQgY2VudGVyZWQgb24gdGhlIHNwcml0ZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNzZXRSZWN0YW5nbGUKICAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aF0gLSBUaGUgd2lkdGggb2YgdGhlIHJlY3RhbmdsZS4gSWYgbm90IHNwZWNpZmllZCBpdCB3aWxsIGRlZmF1bHQgdG8gdGhlIHdpZHRoIG9mIHRoZSBwYXJlbnQgU3ByaXRlLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodF0gLSBUaGUgaGVpZ2h0IG9mIHRoZSByZWN0YW5nbGUuIElmIG5vdCBzcGVjaWZpZWQgaXQgd2lsbCBkZWZhdWx0IHRvIHRoZSBoZWlnaHQgb2YgdGhlIHBhcmVudCBTcHJpdGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdHJhbnNsYXRlWF0gLSBUaGUgeCBhbW91bnQgdGhlIHJlY3RhbmdsZSB3aWxsIGJlIHRyYW5zbGF0ZWQgZnJvbSB0aGUgU3ByaXRlcyBjZW50ZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdHJhbnNsYXRlWV0gLSBUaGUgeSBhbW91bnQgdGhlIHJlY3RhbmdsZSB3aWxsIGJlIHRyYW5zbGF0ZWQgZnJvbSB0aGUgU3ByaXRlcyBjZW50ZXIuCiAgICAqLwogICAgc2V0UmVjdGFuZ2xlOiBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCwgdHJhbnNsYXRlWCwgdHJhbnNsYXRlWSkgewoKICAgICAgICBpZiAodHlwZW9mIHdpZHRoID09PSAndW5kZWZpbmVkJykgeyB3aWR0aCA9IHRoaXMuc3ByaXRlLndpZHRoOyB9CiAgICAgICAgaWYgKHR5cGVvZiBoZWlnaHQgPT09ICd1bmRlZmluZWQnKSB7IGhlaWdodCA9IHRoaXMuc3ByaXRlLmhlaWdodDsgfQogICAgICAgIGlmICh0eXBlb2YgdHJhbnNsYXRlWCA9PT0gJ3VuZGVmaW5lZCcpIHsgdHJhbnNsYXRlWCA9IC10aGlzLnNwcml0ZS5fY2FjaGUuaGFsZldpZHRoOyB9CiAgICAgICAgaWYgKHR5cGVvZiB0cmFuc2xhdGVZID09PSAndW5kZWZpbmVkJykgeyB0cmFuc2xhdGVZID0gLXRoaXMuc3ByaXRlLl9jYWNoZS5oYWxmSGVpZ2h0OyB9CgogICAgICAgIHRoaXMudHlwZSA9IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5SRUNUOwogICAgICAgIHRoaXMuc2hhcGUgPSBuZXcgU0FULkJveChuZXcgU0FULlZlY3Rvcih0aGlzLnNwcml0ZS53b3JsZC54LCB0aGlzLnNwcml0ZS53b3JsZC55KSwgd2lkdGgsIGhlaWdodCk7CiAgICAgICAgdGhpcy5wb2x5Z29uID0gdGhpcy5zaGFwZS50b1BvbHlnb24oKTsKICAgICAgICB0aGlzLnBvbHlnb24udHJhbnNsYXRlKHRyYW5zbGF0ZVgsIHRyYW5zbGF0ZVkpOwoKICAgICAgICB0aGlzLm9mZnNldC5zZXRUbygwLCAwKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoaXMgQm9keSB0byB1c2UgYSBjb252ZXggcG9seWdvbiBmb3IgY29sbGlzaW9uLgogICAgKiBUaGUgcG9pbnRzIGFyZSBzcGVjaWZpZWQgaW4gYSBjb3VudGVyLWNsb2Nrd2lzZSBkaXJlY3Rpb24gYW5kIG11c3QgY3JlYXRlIGEgY29udmV4IHBvbHlnb24uCiAgICAqIFVzZSBCb2R5LnRyYW5zbGF0ZSBhbmQvb3IgQm9keS5vZmZzZXQgdG8gcmUtcG9zaXRpb24gdGhlIHBvbHlnb24gZnJvbSB0aGUgU3ByaXRlIG9yaWdpbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNzZXRQb2x5Z29uCiAgICAqIEBwYXJhbSB7KFNBVC5WZWN0b3JbXXxudW1iZXJbXXwuLi5TQVQuVmVjdG9yfC4uLm51bWJlcil9IHBvaW50cyAtIFRoaXMgY2FuIGJlIGFuIGFycmF5IG9mIFZlY3RvcnMgdGhhdCBmb3JtIHRoZSBwb2x5Z29uLAogICAgKiAgICAgIGEgZmxhdCBhcnJheSBvZiBudW1iZXJzIHRoYXQgd2lsbCBiZSBpbnRlcnByZXRlZCBhcyBbeCx5LCB4LHksIC4uLl0sIG9yIHRoZSBhcmd1bWVudHMgcGFzc2VkIGNhbiBiZQogICAgKiAgICAgIGFsbCB0aGUgcG9pbnRzIG9mIHRoZSBwb2x5Z29uIGUuZy4gYHNldFBvbHlnb24obmV3IFNBVC5WZWN0b3IoKSwgbmV3IFNBVC5WZWN0b3IoKSwgLi4uKWAsIG9yIHRoZQogICAgKiAgICAgIGFyZ3VtZW50cyBwYXNzZWQgY2FuIGJlIGZsYXQgeCx5IHZhbHVlcyBlLmcuIGBzZXRQb2x5Z29uKHgseSwgeCx5LCB4LHksIC4uLilgIHdoZXJlIGB4YCBhbmQgYHlgIGFyZSBOdW1iZXJzLgogICAgKi8KICAgIHNldFBvbHlnb246IGZ1bmN0aW9uIChwb2ludHMpIHsKCiAgICAgICAgdGhpcy50eXBlID0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLlBPTFlHT047CiAgICAgICAgdGhpcy5zaGFwZSA9IG51bGw7CgogICAgICAgIGlmICghQXJyYXkuaXNBcnJheShwb2ludHMpKQogICAgICAgIHsKICAgICAgICAgICAgcG9pbnRzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgcG9pbnRzWzBdID09PSAnbnVtYmVyJykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBwID0gW107CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gcG9pbnRzLmxlbmd0aDsgaSA8IGxlbjsgaSArPSAyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwLnB1c2gobmV3IFNBVC5WZWN0b3IocG9pbnRzW2ldLCBwb2ludHNbaSArIDFdKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHBvaW50cyA9IHA7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnBvbHlnb24gPSBuZXcgU0FULlBvbHlnb24obmV3IFNBVC5WZWN0b3IodGhpcy5zcHJpdGUuY2VudGVyLngsIHRoaXMuc3ByaXRlLmNlbnRlci55KSwgcG9pbnRzKTsKCiAgICAgICAgdGhpcy5vZmZzZXQuc2V0VG8oMCwgMCk7CgogICAgfSwKCiAgICAvKioKICAgICogVXNlZCBmb3IgdHJhbnNsYXRpbmcgcmVjdGFuZ2xlIGFuZCBwb2x5Z29uIGJvZGllcyBmcm9tIHRoZSBTcHJpdGUgcGFyZW50LiBEb2Vzbid0IGFwcGx5IHRvIENpcmNsZXMuCiAgICAqIFNlZSBhbHNvIHRoZSBCb2R5Lm9mZnNldCBwcm9wZXJ0eS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSN0cmFuc2xhdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBhbW91bnQgdGhlIHBvbHlnb24gb3IgcmVjdGFuZ2xlIHdpbGwgYmUgdHJhbnNsYXRlZCBieSBmcm9tIHRoZSBTcHJpdGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYW1vdW50IHRoZSBwb2x5Z29uIG9yIHJlY3RhbmdsZSB3aWxsIGJlIHRyYW5zbGF0ZWQgYnkgZnJvbSB0aGUgU3ByaXRlLgogICAgKi8KICAgIHRyYW5zbGF0ZTogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgaWYgKHRoaXMucG9seWdvbikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucG9seWdvbi50cmFuc2xhdGUoeCwgeSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIERldGVybWluZXMgaWYgdGhpcyBCb2R5IGlzICdvbiB0aGUgZmxvb3InLCB3aGljaCBtZWFucyBpbiBjb250YWN0IHdpdGggYSBUaWxlIG9yIFdvcmxkIGJvdW5kcywgb3Igb3RoZXIgb2JqZWN0IHRoYXQgaGFzIHNldCAnZG93bicgYXMgYmxvY2tlZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNvbkZsb29yCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBCb2R5IGlzICdvbiB0aGUgZmxvb3InLCB3aGljaCBtZWFucyBpbiBjb250YWN0IHdpdGggYSBUaWxlIG9yIFdvcmxkIGJvdW5kcywgb3Igb2JqZWN0IHRoYXQgaGFzIHNldCAnZG93bicgYXMgYmxvY2tlZC4KICAgICovCiAgICBvbkZsb29yOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYmxvY2tlZC5kb3duOwogICAgfSwKCiAgICAvKioKICAgICogRGV0ZXJtaW5zIGlmIHRoaXMgQm9keSBpcyAnb24gYSB3YWxsJywgd2hpY2ggbWVhbnMgaG9yaXpvbnRhbGx5IGluIGNvbnRhY3Qgd2l0aCBhIFRpbGUgb3IgV29ybGQgYm91bmRzLCBvciBvdGhlciBvYmplY3QgYnV0IG5vdCB0aGUgZ3JvdW5kLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I29uV2FsbAogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoaXMgQm9keSBpcyAnb24gYSB3YWxsJywgd2hpY2ggbWVhbnMgaG9yaXpvbnRhbGx5IGluIGNvbnRhY3Qgd2l0aCBhIFRpbGUgb3IgV29ybGQgYm91bmRzLCBvciBvdGhlciBvYmplY3QgYnV0IG5vdCB0aGUgZ3JvdW5kLgogICAgKi8KICAgIG9uV2FsbDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAoIXRoaXMuYmxvY2tlZC5kb3duICYmICh0aGlzLmJsb2NrZWQubGVmdCB8fCB0aGlzLmJsb2NrZWQucmlnaHQpKTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIGRlbHRhIHggdmFsdWUuIFRoZSBhbW91bnQgdGhlIEJvZHkgaGFzIG1vdmVkIGhvcml6b250YWxseSBpbiB0aGUgY3VycmVudCBzdGVwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2RlbHRhWAogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkZWx0YSB2YWx1ZS4gUG9zaXRpdmUgaWYgdGhlIG1vdGlvbiB3YXMgdG8gdGhlIHJpZ2h0LCBuZWdhdGl2ZSBpZiB0byB0aGUgbGVmdC4KICAgICovCiAgICBkZWx0YVg6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy54IC0gdGhpcy5wcmVYOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgZGVsdGEgeSB2YWx1ZS4gVGhlIGFtb3VudCB0aGUgQm9keSBoYXMgbW92ZWQgdmVydGljYWxseSBpbiB0aGUgY3VycmVudCBzdGVwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2RlbHRhWQogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkZWx0YSB2YWx1ZS4gUG9zaXRpdmUgaWYgdGhlIG1vdGlvbiB3YXMgZG93bndhcmRzLCBuZWdhdGl2ZSBpZiB1cHdhcmRzLgogICAgKi8KICAgIGRlbHRhWTogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnkgLSB0aGlzLnByZVk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBkZWx0YSB6IHZhbHVlLiBUaGUgYW1vdW50IHRoZSBCb2R5IGhhcyByb3RhdGVkIGluIHRoZSBjdXJyZW50IHN0ZXAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjZGVsdGFaCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRlbHRhIHZhbHVlLgogICAgKi8KICAgIGRlbHRhWjogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnJvdGF0aW9uIC0gdGhpcy5wcmVSb3RhdGlvbjsKICAgIH0KCn07CgpQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keTsKCi8qKgoqIEBuYW1lIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3gKKiBAcHJvcGVydHkge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhpcyBCb2R5LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkucHJvdG90eXBlLCAieCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkNJUkNMRSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNoYXBlLnBvcy54OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2x5Z29uLnBvcy54OwogICAgICAgIH0KCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh0aGlzLnR5cGUgPT09IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5DSVJDTEUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNoYXBlLnBvcy54ID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucG9seWdvbi5wb3MueCA9IHZhbHVlOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3kKKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhpcyBCb2R5LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkucHJvdG90eXBlLCAieSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkNJUkNMRSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNoYXBlLnBvcy55OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2x5Z29uLnBvcy55OwogICAgICAgIH0KCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh0aGlzLnR5cGUgPT09IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5DSVJDTEUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNoYXBlLnBvcy55ID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucG9seWdvbi5wb3MueSA9IHZhbHVlOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlci5QYXJ0aWNsZXMgaXMgdGhlIFBhcnRpY2xlIE1hbmFnZXIgZm9yIHRoZSBnYW1lLiBJdCBpcyBjYWxsZWQgZHVyaW5nIHRoZSBnYW1lIHVwZGF0ZSBsb29wIGFuZCBpbiB0dXJuIHVwZGF0ZXMgYW55IEVtaXR0ZXJzIGF0dGFjaGVkIHRvIGl0LgoqCiogQGNsYXNzIFBoYXNlci5QYXJ0aWNsZXMKKiBAY2xhc3NkZXNjIFBoYXNlciBQYXJ0aWNsZXMKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5QYXJ0aWNsZXMgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IGVtaXR0ZXJzIC0gSW50ZXJuYWwgZW1pdHRlcnMgc3RvcmUuCiAgICAqLwogICAgdGhpcy5lbWl0dGVycyA9IHt9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gSUQgLSAKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLklEID0gMDsKCn07CgpQaGFzZXIuUGFydGljbGVzLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkcyBhIG5ldyBQYXJ0aWNsZSBFbWl0dGVyIHRvIHRoZSBQYXJ0aWNsZSBNYW5hZ2VyLgogICAgKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMjYWRkCiAgICAqIEBwYXJhbSB7UGhhc2VyLkVtaXR0ZXJ9IGVtaXR0ZXIgLSBUaGUgZW1pdHRlciB0byBiZSBhZGRlZCB0byB0aGUgcGFydGljbGUgbWFuYWdlci4KICAgICogQHJldHVybiB7UGhhc2VyLkVtaXR0ZXJ9IFRoZSBlbWl0dGVyIHRoYXQgd2FzIGFkZGVkLgogICAgKi8KICAgIGFkZDogZnVuY3Rpb24gKGVtaXR0ZXIpIHsKCiAgICAgICAgdGhpcy5lbWl0dGVyc1tlbWl0dGVyLm5hbWVdID0gZW1pdHRlcjsKCiAgICAgICAgcmV0dXJuIGVtaXR0ZXI7CgogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlcyBhbiBleGlzdGluZyBQYXJ0aWNsZSBFbWl0dGVyIGZyb20gdGhlIFBhcnRpY2xlIE1hbmFnZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcyNyZW1vdmUKICAgICogQHBhcmFtIHtQaGFzZXIuRW1pdHRlcn0gZW1pdHRlciAtIFRoZSBlbWl0dGVyIHRvIHJlbW92ZS4KICAgICovCiAgICByZW1vdmU6IGZ1bmN0aW9uIChlbWl0dGVyKSB7CgogICAgICAgIGRlbGV0ZSB0aGlzLmVtaXR0ZXJzW2VtaXR0ZXIubmFtZV07CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIGJ5IHRoZSBjb3JlIGdhbWUgbG9vcC4gVXBkYXRlcyBhbGwgRW1pdHRlcnMgd2hvIGhhdmUgdGhlaXIgZXhpc3RzIHZhbHVlIHNldCB0byB0cnVlLgogICAgKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMjdXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuZW1pdHRlcnMpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5lbWl0dGVyc1trZXldLmV4aXN0cykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5lbWl0dGVyc1trZXldLnVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0KCn07CgpQaGFzZXIuUGFydGljbGVzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5QYXJ0aWNsZXM7CgpQaGFzZXIuUGFydGljbGVzLkFyY2FkZSA9IHt9Ci8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlciAtIEFyY2FkZUVtaXR0ZXIKKgoqIEBjbGFzcyBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyCiogQGNsYXNzZGVzYyBFbWl0dGVyIGlzIGEgbGlnaHR3ZWlnaHQgcGFydGljbGUgZW1pdHRlci4gSXQgY2FuIGJlIHVzZWQgZm9yIG9uZS10aW1lIGV4cGxvc2lvbnMgb3IgZm9yCiogY29udGludW91cyBlZmZlY3RzIGxpa2UgcmFpbiBhbmQgZmlyZS4gQWxsIGl0IHJlYWxseSBkb2VzIGlzIGxhdW5jaCBQYXJ0aWNsZSBvYmplY3RzIG91dAoqIGF0IHNldCBpbnRlcnZhbHMsIGFuZCBmaXhlcyB0aGVpciBwb3NpdGlvbnMgYW5kIHZlbG9jaXRpZXMgYWNjb3JpbmRnbHkuCiogQGNvbnN0cnVjdG9yCiogQGV4dGVuZHMgUGhhc2VyLkdyb3VwCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKiBAcGFyYW0ge251bWJlcn0gW3g9MF0gLSBUaGUgeCBjb29yZGluYXRlIHdpdGhpbiB0aGUgRW1pdHRlciB0aGF0IHRoZSBwYXJ0aWNsZXMgYXJlIGVtaXR0ZWQgZnJvbS4KKiBAcGFyYW0ge251bWJlcn0gW3k9MF0gLSBUaGUgeSBjb29yZGluYXRlIHdpdGhpbiB0aGUgRW1pdHRlciB0aGF0IHRoZSBwYXJ0aWNsZXMgYXJlIGVtaXR0ZWQgZnJvbS4KKiBAcGFyYW0ge251bWJlcn0gW21heFBhcnRpY2xlcz01MF0gLSBUaGUgdG90YWwgbnVtYmVyIG9mIHBhcnRpY2xlcyBpbiB0aGlzIGVtaXR0ZXIuLgoqLwoKUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciA9IGZ1bmN0aW9uIChnYW1lLCB4LCB5LCBtYXhQYXJ0aWNsZXMpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heFBhcnRpY2xlcyAtIFRoZSB0b3RhbCBudW1iZXIgb2YgcGFydGljbGVzIGluIHRoaXMgZW1pdHRlci4uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXhQYXJ0aWNsZXMgPSBtYXhQYXJ0aWNsZXMgfHwgNTA7CgogICAgUGhhc2VyLkdyb3VwLmNhbGwodGhpcywgZ2FtZSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgdGhpcy5uYW1lID0gJ2VtaXR0ZXInICsgdGhpcy5nYW1lLnBhcnRpY2xlcy5JRCsrOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIEludGVybmFsIFBoYXNlciBUeXBlIHZhbHVlLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLkVNSVRURVI7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIFggcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IGNvcm5lciBvZiB0aGUgZW1pdHRlciBpbiB3b3JsZCBzcGFjZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSBZIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBjb3JuZXIgb2YgZW1pdHRlciBpbiB3b3JsZCBzcGFjZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnkgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIGVtaXR0ZXIuICBQYXJ0aWNsZXMgY2FuIGJlIHJhbmRvbWx5IGdlbmVyYXRlZCBmcm9tIGFueXdoZXJlIHdpdGhpbiB0aGlzIGJveC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndpZHRoID0gMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIGVtaXR0ZXIuICBQYXJ0aWNsZXMgY2FuIGJlIHJhbmRvbWx5IGdlbmVyYXRlZCBmcm9tIGFueXdoZXJlIHdpdGhpbiB0aGlzIGJveC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmhlaWdodCA9IDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBtaW5QYXJ0aWNsZVNwZWVkIC0gVGhlIG1pbmltdW0gcG9zc2libGUgdmVsb2NpdHkgb2YgYSBwYXJ0aWNsZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1pblBhcnRpY2xlU3BlZWQgPSBuZXcgUGhhc2VyLlBvaW50KC0xMDAsIC0xMDApOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gbWF4UGFydGljbGVTcGVlZCAtIFRoZSBtYXhpbXVtIHBvc3NpYmxlIHZlbG9jaXR5IG9mIGEgcGFydGljbGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXhQYXJ0aWNsZVNwZWVkID0gbmV3IFBoYXNlci5Qb2ludCgxMDAsIDEwMCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtaW5QYXJ0aWNsZVNjYWxlIC0gVGhlIG1pbmltdW0gcG9zc2libGUgc2NhbGUgb2YgYSBwYXJ0aWNsZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1pblBhcnRpY2xlU2NhbGUgPSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4UGFydGljbGVTY2FsZSAtIFRoZSBtYXhpbXVtIHBvc3NpYmxlIHNjYWxlIG9mIGEgcGFydGljbGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXhQYXJ0aWNsZVNjYWxlID0gMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1pblJvdGF0aW9uIC0gVGhlIG1pbmltdW0gcG9zc2libGUgYW5ndWxhciB2ZWxvY2l0eSBvZiBhIHBhcnRpY2xlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWluUm90YXRpb24gPSAtMzYwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4Um90YXRpb24gLSBUaGUgbWF4aW11bSBwb3NzaWJsZSBhbmd1bGFyIHZlbG9jaXR5IG9mIGEgcGFydGljbGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXhSb3RhdGlvbiA9IDM2MDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGdyYXZpdHkgLSBTZXRzIHRoZSBgYm9keS5ncmF2aXR5LnlgIG9mIGVhY2ggcGFydGljbGUgc3ByaXRlIHRvIHRoaXMgdmFsdWUgb24gbGF1bmNoLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZ3Jhdml0eSA9IDEwMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthbnl9IHBhcnRpY2xlQ2xhc3MgLSBGb3IgZW1pdHRpbmcgeW91ciBvd24gcGFydGljbGUgY2xhc3MgdHlwZXMuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYXJ0aWNsZUNsYXNzID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBhcnRpY2xlRnJpY3Rpb24gLSBUaGUgZnJpY3Rpb24gY29tcG9uZW50IG9mIHBhcnRpY2xlcyBsYXVuY2hlZCBmcm9tIHRoZSBlbWl0dGVyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGFydGljbGVGcmljdGlvbiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmd1bGFyRHJhZyAtIFRoZSBhbmd1bGFyIGRyYWcgY29tcG9uZW50IG9mIHBhcnRpY2xlcyBsYXVuY2hlZCBmcm9tIHRoZSBlbWl0dGVyIGlmIHRoZXkgYXJlIHJvdGF0aW5nLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYW5ndWxhckRyYWcgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZyZXF1ZW5jeSAtIEhvdyBvZnRlbiBhIHBhcnRpY2xlIGlzIGVtaXR0ZWQgaW4gbXMgKGlmIGVtaXR0ZXIgaXMgc3RhcnRlZCB3aXRoIEV4cGxvZGUgPT09IGZhbHNlKS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZyZXF1ZW5jeSA9IDEwMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGxpZmVzcGFuIC0gSG93IGxvbmcgZWFjaCBwYXJ0aWNsZSBsaXZlcyBvbmNlIGl0IGlzIGVtaXR0ZWQgaW4gbXMuIERlZmF1bHQgaXMgMiBzZWNvbmRzLiBTZXQgbGlmZXNwYW4gdG8gJ3plcm8nIGZvciBwYXJ0aWNsZXMgdG8gbGl2ZSBmb3JldmVyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubGlmZXNwYW4gPSAyMDAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYm91bmNlIC0gSG93IG11Y2ggZWFjaCBwYXJ0aWNsZSBzaG91bGQgYm91bmNlIG9uIGVhY2ggYXhpcy4gIDEgPSBmdWxsIGJvdW5jZSwgMCA9IG5vIGJvdW5jZS4KICAgICovCiAgICB0aGlzLmJvdW5jZSA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9xdWFudGl0eSAtIEludGVybmFsIGhlbHBlciBmb3IgZGVjaWRpbmcgaG93IG1hbnkgcGFydGljbGVzIHRvIGxhdW5jaC4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9xdWFudGl0eSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdGltZXIgLSBJbnRlcm5hbCBoZWxwZXIgZm9yIGRlY2lkaW5nIHdoZW4gdG8gbGF1bmNoIHBhcnRpY2xlcyBvciBraWxsIHRoZW0uCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdGltZXIgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2NvdW50ZXIgLSBJbnRlcm5hbCBjb3VudGVyIGZvciBmaWd1cmluZyBvdXQgaG93IG1hbnkgcGFydGljbGVzIHRvIGxhdW5jaC4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9jb3VudGVyID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfZXhwbG9kZSAtIEludGVybmFsIGhlbHBlciBmb3IgdGhlIHN0eWxlIG9mIHBhcnRpY2xlIGVtaXNzaW9uIChhbGwgYXQgb25jZSwgb3Igb25lIGF0IGEgdGltZSkuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZXhwbG9kZSA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gb24gLSBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIGVtaXR0ZXIgaXMgY3VycmVudGx5IGVtaXR0aW5nIHBhcnRpY2xlcy4gSXQgaXMgdG90YWxseSBzYWZlIHRvIGRpcmVjdGx5IHRvZ2dsZSB0aGlzLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub24gPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBleGlzdHMgLSBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIGVtaXR0ZXIgaXMgYmVpbmcgdXBkYXRlZCBieSB0aGUgY29yZSBnYW1lIGxvb3AuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwoKICAgIC8qKgogICAgKiBUaGUgcG9pbnQgdGhlIHBhcnRpY2xlcyBhcmUgZW1pdHRlZCBmcm9tLgogICAgKiBFbWl0dGVyLnggYW5kIEVtaXR0ZXIueSBjb250cm9sIHRoZSBjb250YWluZXJzIGxvY2F0aW9uLCB3aGljaCB1cGRhdGVzIGFsbCBjdXJyZW50IHBhcnRpY2xlcwogICAgKiBFbWl0dGVyLmVtaXRYIGFuZCBFbWl0dGVyLmVtaXRZIGNvbnRyb2wgdGhlIGVtaXNzaW9uIGxvY2F0aW9uIHJlbGF0aXZlIHRvIHRoZSB4L3kgcG9zaXRpb24uCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZW1pdFgKICAgICovCiAgICB0aGlzLmVtaXRYID0geDsKICAgIAogICAgLyoqCiAgICAqIFRoZSBwb2ludCB0aGUgcGFydGljbGVzIGFyZSBlbWl0dGVkIGZyb20uCiAgICAqIEVtaXR0ZXIueCBhbmQgRW1pdHRlci55IGNvbnRyb2wgdGhlIGNvbnRhaW5lcnMgbG9jYXRpb24sIHdoaWNoIHVwZGF0ZXMgYWxsIGN1cnJlbnQgcGFydGljbGVzCiAgICAqIEVtaXR0ZXIuZW1pdFggYW5kIEVtaXR0ZXIuZW1pdFkgY29udHJvbCB0aGUgZW1pc3Npb24gbG9jYXRpb24gcmVsYXRpdmUgdG8gdGhlIHgveSBwb3NpdGlvbi4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBlbWl0WQogICAgKi8KICAgIHRoaXMuZW1pdFkgPSB5OwogICAgCn07CgpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUGhhc2VyLkdyb3VwLnByb3RvdHlwZSk7ClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlcjsKCi8qKgoqIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IHRoZSBnYW1lIGxvb3AsIGRlY2lkZXMgd2hlbiB0byBsYXVuY2ggcGFydGljbGVzIGFuZCB3aGVuIHRvICJkaWUiLgoqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciN1cGRhdGUKKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKCkgewoKICAgIGlmICh0aGlzLm9uKQogICAgewogICAgICAgIGlmICh0aGlzLl9leHBsb2RlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fY291bnRlciA9IDA7CgogICAgICAgICAgICBkbwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmVtaXRQYXJ0aWNsZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fY291bnRlcisrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9jb3VudGVyIDwgdGhpcy5fcXVhbnRpdHkpOwoKICAgICAgICAgICAgdGhpcy5vbiA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnRpbWUubm93ID49IHRoaXMuX3RpbWVyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmVtaXRQYXJ0aWNsZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLl9jb3VudGVyKys7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3F1YW50aXR5ID4gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fY291bnRlciA+PSB0aGlzLl9xdWFudGl0eSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fdGltZXIgPSB0aGlzLmdhbWUudGltZS5ub3cgKyB0aGlzLmZyZXF1ZW5jeTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCn0KCi8qKgoqIFRoaXMgZnVuY3Rpb24gZ2VuZXJhdGVzIGEgbmV3IGFycmF5IG9mIHBhcnRpY2xlIHNwcml0ZXMgdG8gYXR0YWNoIHRvIHRoZSBlbWl0dGVyLgoqCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI21ha2VQYXJ0aWNsZXMKKiBAcGFyYW0ge2FycmF5fHN0cmluZ30ga2V5cyAtIEEgc3RyaW5nIG9yIGFuIGFycmF5IG9mIHN0cmluZ3MgdGhhdCB0aGUgcGFydGljbGUgc3ByaXRlcyB3aWxsIHVzZSBhcyB0aGVpciB0ZXh0dXJlLiBJZiBhbiBhcnJheSBvbmUgaXMgcGlja2VkIGF0IHJhbmRvbS4KKiBAcGFyYW0ge2FycmF5fG51bWJlcn0gZnJhbWVzIC0gQSBmcmFtZSBudW1iZXIsIG9yIGFycmF5IG9mIGZyYW1lcyB0aGF0IHRoZSBzcHJpdGUgd2lsbCB1c2UuIElmIGFuIGFycmF5IG9uZSBpcyBwaWNrZWQgYXQgcmFuZG9tLgoqIEBwYXJhbSB7bnVtYmVyfSBxdWFudGl0eSAtIFRoZSBudW1iZXIgb2YgcGFydGljbGVzIHRvIGdlbmVyYXRlLgoqIEBwYXJhbSB7Ym9vbGVhbn0gW2NvbGxpZGU9ZmFsc2VdIC0gU2V0cyB0aGUgY2hlY2tDb2xsaXNpb24ubm9uZSBmbGFnIG9uIHRoZSBwYXJ0aWNsZSBzcHJpdGVzIGJvZHkuCiogQHBhcmFtIHtib29sZWFufSBbY29sbGlkZVdvcmxkQm91bmRzPWZhbHNlXSAtIEEgcGFydGljbGUgY2FuIGJlIHNldCB0byBjb2xsaWRlIGFnYWluc3QgdGhlIFdvcmxkIGJvdW5kcyBhdXRvbWF0aWNhbGx5IGFuZCByZWJvdW5kIGJhY2sgaW50byB0aGUgV29ybGQgaWYgdGhpcyBpcyBzZXQgdG8gdHJ1ZS4gT3RoZXJ3aXNlIGl0IHdpbGwgbGVhdmUgdGhlIFdvcmxkLgoqIEByZXR1cm4ge1BoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXJ9IFRoaXMgRW1pdHRlciBpbnN0YW5jZS4KKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUubWFrZVBhcnRpY2xlcyA9IGZ1bmN0aW9uIChrZXlzLCBmcmFtZXMsIHF1YW50aXR5LCBjb2xsaWRlLCBjb2xsaWRlV29ybGRCb3VuZHMpIHsKCiAgICBpZiAodHlwZW9mIGZyYW1lcyA9PT0gJ3VuZGVmaW5lZCcpIHsgZnJhbWVzID0gMDsgfQogICAgaWYgKHR5cGVvZiBxdWFudGl0eSA9PT0gJ3VuZGVmaW5lZCcpIHsgcXVhbnRpdHkgPSB0aGlzLm1heFBhcnRpY2xlczsgfQogICAgaWYgKHR5cGVvZiBjb2xsaWRlID09PSAndW5kZWZpbmVkJykgeyBjb2xsaWRlID0gZmFsc2U7IH0KICAgIGlmICh0eXBlb2YgY29sbGlkZVdvcmxkQm91bmRzID09PSAndW5kZWZpbmVkJykgeyBjb2xsaWRlV29ybGRCb3VuZHMgPSBmYWxzZTsgfQoKICAgIHZhciBwYXJ0aWNsZTsKICAgIHZhciBpID0gMDsKICAgIHZhciBybmRLZXkgPSBrZXlzOwogICAgdmFyIHJuZEZyYW1lID0gZnJhbWVzOwoKICAgIHdoaWxlIChpIDwgcXVhbnRpdHkpCiAgICB7CiAgICAgICAgaWYgKHRoaXMucGFydGljbGVDbGFzcyA9PT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5cyA9PT0gJ29iamVjdCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJuZEtleSA9IHRoaXMuZ2FtZS5ybmQucGljayhrZXlzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBmcmFtZXMgPT09ICdvYmplY3QnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBybmRGcmFtZSA9IHRoaXMuZ2FtZS5ybmQucGljayhmcmFtZXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwYXJ0aWNsZSA9IG5ldyBQaGFzZXIuU3ByaXRlKHRoaXMuZ2FtZSwgMCwgMCwgcm5kS2V5LCBybmRGcmFtZSk7CiAgICAgICAgfQogICAgICAgIC8vIGVsc2UKICAgICAgICAvLyB7CiAgICAgICAgICAgIC8vIHBhcnRpY2xlID0gbmV3IHRoaXMucGFydGljbGVDbGFzcyh0aGlzLmdhbWUpOwogICAgICAgIC8vIH0KCiAgICAgICAgaWYgKGNvbGxpZGUpCiAgICAgICAgewogICAgICAgICAgICBwYXJ0aWNsZS5ib2R5LmNoZWNrQ29sbGlzaW9uLmFueSA9IHRydWU7CiAgICAgICAgICAgIHBhcnRpY2xlLmJvZHkuY2hlY2tDb2xsaXNpb24ubm9uZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBwYXJ0aWNsZS5ib2R5LmNoZWNrQ29sbGlzaW9uLm5vbmUgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcGFydGljbGUuYm9keS5jb2xsaWRlV29ybGRCb3VuZHMgPSBjb2xsaWRlV29ybGRCb3VuZHM7CgogICAgICAgIHBhcnRpY2xlLmV4aXN0cyA9IGZhbHNlOwogICAgICAgIHBhcnRpY2xlLnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgLy8gIENlbnRlciB0aGUgb3JpZ2luIGZvciByb3RhdGlvbiBhc3Npc3RhbmNlCiAgICAgICAgcGFydGljbGUuYW5jaG9yLnNldFRvKDAuNSwgMC41KTsKCiAgICAgICAgdGhpcy5hZGQocGFydGljbGUpOwoKICAgICAgICBpKys7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cn0KCi8qKgoqIENhbGwgdGhpcyBmdW5jdGlvbiB0byB0dXJuIG9mZiBhbGwgdGhlIHBhcnRpY2xlcyBhbmQgdGhlIGVtaXR0ZXIuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI2tpbGwKKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUua2lsbCA9IGZ1bmN0aW9uICgpIHsKCiAgICB0aGlzLm9uID0gZmFsc2U7CiAgICB0aGlzLmFsaXZlID0gZmFsc2U7CiAgICB0aGlzLmV4aXN0cyA9IGZhbHNlOwoKfQoKLyoqCiogSGFuZHkgZm9yIGJyaW5naW5nIGdhbWUgb2JqZWN0cyAiYmFjayB0byBsaWZlIi4gSnVzdCBzZXRzIGFsaXZlIGFuZCBleGlzdHMgYmFjayB0byB0cnVlLgoqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNyZXZpdmUKKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUucmV2aXZlID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuYWxpdmUgPSB0cnVlOwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwoKfQoKLyoqCiogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIHN0YXJ0IGVtaXR0aW5nIHBhcnRpY2xlcy4KKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjc3RhcnQKKiBAcGFyYW0ge2Jvb2xlYW59IFtleHBsb2RlPXRydWVdIC0gV2hldGhlciB0aGUgcGFydGljbGVzIHNob3VsZCBhbGwgYnVyc3Qgb3V0IGF0IG9uY2UuCiogQHBhcmFtIHtudW1iZXJ9IFtsaWZlc3Bhbj0wXSAtIEhvdyBsb25nIGVhY2ggcGFydGljbGUgbGl2ZXMgb25jZSBlbWl0dGVkLiAwID0gZm9yZXZlci4KKiBAcGFyYW0ge251bWJlcn0gW2ZyZXF1ZW5jeT0yNTBdIC0gSWdub3JlZCBpZiBFeHBsb2RlIGlzIHNldCB0byB0cnVlLiBGcmVxdWVuY3kgaXMgaG93IG9mdGVuIHRvIGVtaXQgYSBwYXJ0aWNsZSBpbiBtcy4KKiBAcGFyYW0ge251bWJlcn0gW3F1YW50aXR5PTBdIC0gSG93IG1hbnkgcGFydGljbGVzIHRvIGxhdW5jaC4gMCA9ICJhbGwgb2YgdGhlIHBhcnRpY2xlcyIuCiovClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLnN0YXJ0ID0gZnVuY3Rpb24gKGV4cGxvZGUsIGxpZmVzcGFuLCBmcmVxdWVuY3ksIHF1YW50aXR5KSB7CgogICAgaWYgKHR5cGVvZiBleHBsb2RlID09PSAndW5kZWZpbmVkJykgeyBleHBsb2RlID0gdHJ1ZTsgfQogICAgaWYgKHR5cGVvZiBsaWZlc3BhbiA9PT0gJ3VuZGVmaW5lZCcpIHsgbGlmZXNwYW4gPSAwOyB9CiAgICBpZiAodHlwZW9mIGZyZXF1ZW5jeSA9PT0gJ3VuZGVmaW5lZCcpIHsgZnJlcXVlbmN5ID0gMjUwOyB9CiAgICBpZiAodHlwZW9mIHF1YW50aXR5ID09PSAndW5kZWZpbmVkJykgeyBxdWFudGl0eSA9IDA7IH0KCiAgICB0aGlzLnJldml2ZSgpOwoKICAgIHRoaXMudmlzaWJsZSA9IHRydWU7CiAgICB0aGlzLm9uID0gdHJ1ZTsKCiAgICB0aGlzLl9leHBsb2RlID0gZXhwbG9kZTsKICAgIHRoaXMubGlmZXNwYW4gPSBsaWZlc3BhbjsKICAgIHRoaXMuZnJlcXVlbmN5ID0gZnJlcXVlbmN5OwoKICAgIGlmIChleHBsb2RlKQogICAgewogICAgICAgIHRoaXMuX3F1YW50aXR5ID0gcXVhbnRpdHk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5fcXVhbnRpdHkgKz0gcXVhbnRpdHk7CiAgICB9CgogICAgdGhpcy5fY291bnRlciA9IDA7CiAgICB0aGlzLl90aW1lciA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIGZyZXF1ZW5jeTsKCn0KCi8qKgoqIFRoaXMgZnVuY3Rpb24gY2FuIGJlIHVzZWQgYm90aCBpbnRlcm5hbGx5IGFuZCBleHRlcm5hbGx5IHRvIGVtaXQgdGhlIG5leHQgcGFydGljbGUuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI2VtaXRQYXJ0aWNsZQoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5lbWl0UGFydGljbGUgPSBmdW5jdGlvbiAoKSB7CgogICAgdmFyIHBhcnRpY2xlID0gdGhpcy5nZXRGaXJzdEV4aXN0cyhmYWxzZSk7CgogICAgaWYgKHBhcnRpY2xlID09IG51bGwpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh0aGlzLndpZHRoID4gMSB8fCB0aGlzLmhlaWdodCA+IDEpCiAgICB7CiAgICAgICAgcGFydGljbGUucmVzZXQodGhpcy5nYW1lLnJuZC5pbnRlZ2VySW5SYW5nZSh0aGlzLmxlZnQsIHRoaXMucmlnaHQpLCB0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMudG9wLCB0aGlzLmJvdHRvbSkpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHBhcnRpY2xlLnJlc2V0KHRoaXMuZW1pdFgsIHRoaXMuZW1pdFkpOwogICAgfQoKICAgIHBhcnRpY2xlLmxpZmVzcGFuID0gdGhpcy5saWZlc3BhbjsKCiAgICBwYXJ0aWNsZS5ib2R5LmJvdW5jZS5zZXRUbyh0aGlzLmJvdW5jZS54LCB0aGlzLmJvdW5jZS55KTsKCiAgICBpZiAodGhpcy5taW5QYXJ0aWNsZVNwZWVkLnggIT0gdGhpcy5tYXhQYXJ0aWNsZVNwZWVkLngpCiAgICB7CiAgICAgICAgcGFydGljbGUuYm9keS52ZWxvY2l0eS54ID0gdGhpcy5nYW1lLnJuZC5pbnRlZ2VySW5SYW5nZSh0aGlzLm1pblBhcnRpY2xlU3BlZWQueCwgdGhpcy5tYXhQYXJ0aWNsZVNwZWVkLngpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHBhcnRpY2xlLmJvZHkudmVsb2NpdHkueCA9IHRoaXMubWluUGFydGljbGVTcGVlZC54OwogICAgfQoKICAgIGlmICh0aGlzLm1pblBhcnRpY2xlU3BlZWQueSAhPSB0aGlzLm1heFBhcnRpY2xlU3BlZWQueSkKICAgIHsKICAgICAgICBwYXJ0aWNsZS5ib2R5LnZlbG9jaXR5LnkgPSB0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMubWluUGFydGljbGVTcGVlZC55LCB0aGlzLm1heFBhcnRpY2xlU3BlZWQueSk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgcGFydGljbGUuYm9keS52ZWxvY2l0eS55ID0gdGhpcy5taW5QYXJ0aWNsZVNwZWVkLnk7CiAgICB9CgogICAgcGFydGljbGUuYm9keS5ncmF2aXR5LnkgPSB0aGlzLmdyYXZpdHk7CgogICAgaWYgKHRoaXMubWluUm90YXRpb24gIT0gdGhpcy5tYXhSb3RhdGlvbikKICAgIHsKICAgICAgICBwYXJ0aWNsZS5ib2R5LmFuZ3VsYXJWZWxvY2l0eSA9IHRoaXMuZ2FtZS5ybmQuaW50ZWdlckluUmFuZ2UodGhpcy5taW5Sb3RhdGlvbiwgdGhpcy5tYXhSb3RhdGlvbik7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgcGFydGljbGUuYm9keS5hbmd1bGFyVmVsb2NpdHkgPSB0aGlzLm1pblJvdGF0aW9uOwogICAgfQoKICAgIGlmICh0aGlzLm1pblBhcnRpY2xlU2NhbGUgIT09IDEgfHwgdGhpcy5tYXhQYXJ0aWNsZVNjYWxlICE9PSAxKQogICAgewogICAgICAgIHZhciBzY2FsZSA9IHRoaXMuZ2FtZS5ybmQucmVhbEluUmFuZ2UodGhpcy5taW5QYXJ0aWNsZVNjYWxlLCB0aGlzLm1heFBhcnRpY2xlU2NhbGUpOwogICAgICAgIHBhcnRpY2xlLnNjYWxlLnNldFRvKHNjYWxlLCBzY2FsZSk7CiAgICB9CgogICAgcGFydGljbGUuYm9keS5mcmljdGlvbiA9IHRoaXMucGFydGljbGVGcmljdGlvbjsKICAgIHBhcnRpY2xlLmJvZHkuYW5ndWxhckRyYWcgPSB0aGlzLmFuZ3VsYXJEcmFnOwoKfQoKLyoqCiogQSBtb3JlIGNvbXBhY3Qgd2F5IG9mIHNldHRpbmcgdGhlIHdpZHRoIGFuZCBoZWlnaHQgb2YgdGhlIGVtaXR0ZXIuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3NldFNpemUKKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgZGVzaXJlZCB3aWR0aCBvZiB0aGUgZW1pdHRlciAocGFydGljbGVzIGFyZSBzcGF3bmVkIHJhbmRvbWx5IHdpdGhpbiB0aGVzZSBkaW1lbnNpb25zKS4KKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGRlc2lyZWQgaGVpZ2h0IG9mIHRoZSBlbWl0dGVyLgoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5zZXRTaXplID0gZnVuY3Rpb24gKHdpZHRoLCBoZWlnaHQpIHsKCiAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKCn0KCi8qKgoqIEEgbW9yZSBjb21wYWN0IHdheSBvZiBzZXR0aW5nIHRoZSBYIHZlbG9jaXR5IHJhbmdlIG9mIHRoZSBlbWl0dGVyLgoqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNzZXRYU3BlZWQKKiBAcGFyYW0ge251bWJlcn0gW21pbj0wXSAtIFRoZSBtaW5pbXVtIHZhbHVlIGZvciB0aGlzIHJhbmdlLgoqIEBwYXJhbSB7bnVtYmVyfSBbbWF4PTBdIC0gVGhlIG1heGltdW0gdmFsdWUgZm9yIHRoaXMgcmFuZ2UuCiovClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLnNldFhTcGVlZCA9IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKICAgIG1pbiA9IG1pbiB8fCAwOwogICAgbWF4ID0gbWF4IHx8IDA7CgogICAgdGhpcy5taW5QYXJ0aWNsZVNwZWVkLnggPSBtaW47CiAgICB0aGlzLm1heFBhcnRpY2xlU3BlZWQueCA9IG1heDsKCn0KCi8qKgoqIEEgbW9yZSBjb21wYWN0IHdheSBvZiBzZXR0aW5nIHRoZSBZIHZlbG9jaXR5IHJhbmdlIG9mIHRoZSBlbWl0dGVyLgoqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNzZXRZU3BlZWQKKiBAcGFyYW0ge251bWJlcn0gW21pbj0wXSAtIFRoZSBtaW5pbXVtIHZhbHVlIGZvciB0aGlzIHJhbmdlLgoqIEBwYXJhbSB7bnVtYmVyfSBbbWF4PTBdIC0gVGhlIG1heGltdW0gdmFsdWUgZm9yIHRoaXMgcmFuZ2UuCiovClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLnNldFlTcGVlZCA9IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKICAgIG1pbiA9IG1pbiB8fCAwOwogICAgbWF4ID0gbWF4IHx8IDA7CgogICAgdGhpcy5taW5QYXJ0aWNsZVNwZWVkLnkgPSBtaW47CiAgICB0aGlzLm1heFBhcnRpY2xlU3BlZWQueSA9IG1heDsKCn0KCi8qKgoqIEEgbW9yZSBjb21wYWN0IHdheSBvZiBzZXR0aW5nIHRoZSBhbmd1bGFyIHZlbG9jaXR5IGNvbnN0cmFpbnRzIG9mIHRoZSBlbWl0dGVyLgoqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNzZXRSb3RhdGlvbgoqIEBwYXJhbSB7bnVtYmVyfSBbbWluPTBdIC0gVGhlIG1pbmltdW0gdmFsdWUgZm9yIHRoaXMgcmFuZ2UuCiogQHBhcmFtIHtudW1iZXJ9IFttYXg9MF0gLSBUaGUgbWF4aW11bSB2YWx1ZSBmb3IgdGhpcyByYW5nZS4KKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUuc2V0Um90YXRpb24gPSBmdW5jdGlvbiAobWluLCBtYXgpIHsKCiAgICBtaW4gPSBtaW4gfHwgMDsKICAgIG1heCA9IG1heCB8fCAwOwoKICAgIHRoaXMubWluUm90YXRpb24gPSBtaW47CiAgICB0aGlzLm1heFJvdGF0aW9uID0gbWF4OwoKfQoKLyoqCiogQ2hhbmdlIHRoZSBlbWl0dGVycyBjZW50ZXIgdG8gbWF0Y2ggdGhlIGNlbnRlciBvZiBhbnkgb2JqZWN0IHdpdGggYSBgY2VudGVyYCBwcm9wZXJ0eSwgc3VjaCBhcyBhIFNwcml0ZS4KKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjYXQKKiBAcGFyYW0ge29iamVjdHxQaGFzZXIuU3ByaXRlfSBvYmplY3QgLSBUaGUgb2JqZWN0IHRoYXQgeW91IHdpc2ggdG8gbWF0Y2ggdGhlIGNlbnRlciB3aXRoLgoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5hdCA9IGZ1bmN0aW9uIChvYmplY3QpIHsKCiAgICBpZiAob2JqZWN0LmNlbnRlcikKICAgIHsKICAgICAgICB0aGlzLmVtaXRYID0gb2JqZWN0LmNlbnRlci54OwogICAgICAgIHRoaXMuZW1pdFkgPSBvYmplY3QuY2VudGVyLnk7CiAgICB9Cgp9CgovKioKKiBUaGUgZW1pdHRlcnMgYWxwaGEgdmFsdWUuCiogQG5hbWUgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNhbHBoYQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbHBoYSAtIEdldHMgb3Igc2V0cyB0aGUgYWxwaGEgdmFsdWUgb2YgdGhlIEVtaXR0ZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSwgImFscGhhIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLmFscGhhOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci5hbHBoYSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBUaGUgZW1pdHRlciB2aXNpYmxlIHN0YXRlLgoqIEBuYW1lIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjdmlzaWJsZQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmlzaWJsZSAtIEdldHMgb3Igc2V0cyB0aGUgRW1pdHRlciB2aXNpYmxlIHN0YXRlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUsICJ2aXNpYmxlIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLnZpc2libGU7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLnZpc2libGUgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciN4CiogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBHZXRzIG9yIHNldHMgdGhlIHggcG9zaXRpb24gb2YgdGhlIEVtaXR0ZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSwgIngiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW1pdFg7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5lbWl0WCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3kKKiBAcHJvcGVydHkge251bWJlcn0geSAtIEdldHMgb3Igc2V0cyB0aGUgeSBwb3NpdGlvbiBvZiB0aGUgRW1pdHRlci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLCAieSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbWl0WTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLmVtaXRZID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjbGVmdAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsZWZ0IC0gR2V0cyB0aGUgbGVmdCBwb3NpdGlvbiBvZiB0aGUgRW1pdHRlci4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLCAibGVmdCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodGhpcy54IC0gKHRoaXMud2lkdGggLyAyKSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjcmlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gcmlnaHQgLSBHZXRzIHRoZSByaWdodCBwb3NpdGlvbiBvZiB0aGUgRW1pdHRlci4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLCAicmlnaHQiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBNYXRoLmZsb29yKHRoaXMueCArICh0aGlzLndpZHRoIC8gMikpOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3RvcAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3AgLSBHZXRzIHRoZSB0b3AgcG9zaXRpb24gb2YgdGhlIEVtaXR0ZXIuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSwgInRvcCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodGhpcy55IC0gKHRoaXMuaGVpZ2h0IC8gMikpOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI2JvdHRvbQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBib3R0b20gLSBHZXRzIHRoZSBib3R0b20gcG9zaXRpb24gb2YgdGhlIEVtaXR0ZXIuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSwgImJvdHRvbSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodGhpcy55ICsgKHRoaXMuaGVpZ2h0IC8gMikpOwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGUgYSBuZXcgYFRpbGVgIG9iamVjdC4KKgoqIEBjbGFzcyBQaGFzZXIuVGlsZQoqIEBjbGFzc2Rlc2MgQSBUaWxlIGlzIGEgcmVwcmVzZW50YXRpb24gb2YgYSBzaW5nbGUgdGlsZSB3aXRoaW4gdGhlIFRpbGVtYXAuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtvYmplY3R9IGxheWVyIC0gVGhlIGxheWVyIGluIHRoZSBUaWxlbWFwIGRhdGEgdGhhdCB0aGlzIHRpbGUgYmVsb25ncyB0by4KKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhpcyB0aWxlIHR5cGUgaW4gdGhlIGNvcmUgbWFwIGRhdGEuCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoaXMgdGlsZS4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhpcyB0aWxlLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFdpZHRoIG9mIHRoZSB0aWxlLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBIZWlnaHQgb2YgdGhlIHRpbGUuCiovClBoYXNlci5UaWxlID0gZnVuY3Rpb24gKGxheWVyLCBpbmRleCwgeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gbGF5ZXIgLSBUaGUgbGF5ZXIgaW4gdGhlIFRpbGVtYXAgZGF0YSB0aGF0IHRoaXMgdGlsZSBiZWxvbmdzIHRvLgogICAgKi8KICAgIHRoaXMubGF5ZXIgPSBsYXllcjsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoaXMgdGlsZSB3aXRoaW4gdGhlIG1hcCBkYXRhIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHRpbGVzZXQuCiAgICAqLwogICAgdGhpcy5pbmRleCA9IGluZGV4OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBUaGUgeCBtYXAgY29vcmRpbmF0ZSBvZiB0aGlzIHRpbGUuCiAgICAqLwogICAgdGhpcy54ID0geDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIHkgbWFwIGNvb3JkaW5hdGUgb2YgdGhpcyB0aWxlLgogICAgKi8KICAgIHRoaXMueSA9IHk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgdGlsZSBpbiBwaXhlbHMuCiAgICAqLwogICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIHRpbGUgaW4gcGl4ZWxzLgogICAgKi8KICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gYWxwaGEgLSBUaGUgYWxwaGEgdmFsdWUgYXQgd2hpY2ggdGhpcyB0aWxlIGlzIGRyYXduIHRvIHRoZSBjYW52YXMuCiAgICAqLwogICAgdGhpcy5hbHBoYSA9IDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBwcm9wZXJ0aWVzIC0gVGlsZSBzcGVjaWZpYyBwcm9wZXJ0aWVzLgogICAgKi8KICAgIHRoaXMucHJvcGVydGllcyA9IHt9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHNjYW5uZWQgLSBIYXMgdGhpcyB0aWxlIGJlZW4gd2Fsa2VkIC8gdHVybmVkIGludG8gYSBwb2x5PwogICAgKi8KICAgIHRoaXMuc2Nhbm5lZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZhY2VUb3AgLSBJcyB0aGUgdG9wIG9mIHRoaXMgdGlsZSBhbiBpbnRlcmVzdGluZyBlZGdlPwogICAgKi8KICAgIHRoaXMuZmFjZVRvcCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZhY2VCb3R0b20gLSBJcyB0aGUgYm90dG9tIG9mIHRoaXMgdGlsZSBhbiBpbnRlcmVzdGluZyBlZGdlPwogICAgKi8KICAgIHRoaXMuZmFjZUJvdHRvbSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZhY2VMZWZ0IC0gSXMgdGhlIGxlZnQgb2YgdGhpcyB0aWxlIGFuIGludGVyZXN0aW5nIGVkZ2U/CiAgICAqLwogICAgdGhpcy5mYWNlTGVmdCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZhY2VSaWdodCAtIElzIHRoZSByaWdodCBvZiB0aGlzIHRpbGUgYW4gaW50ZXJlc3RpbmcgZWRnZT8KICAgICovCiAgICB0aGlzLmZhY2VSaWdodCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbGxpZGVzIC0gRG9lcyB0aGlzIHRpbGUgY29sbGlkZSBhdCBhbGw/CiAgICAqLwogICAgdGhpcy5jb2xsaWRlcyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbGxpZGVOb25lIC0gSW5kaWNhdGluZyB0aGlzIFRpbGUgZG9lc24ndCBjb2xsaWRlIGF0IGFsbC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNvbGxpZGVOb25lID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjb2xsaWRlTGVmdCAtIEluZGljYXRpbmcgY29sbGlkZSB3aXRoIGFueSBvYmplY3Qgb24gdGhlIGxlZnQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb2xsaWRlTGVmdCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbGxpZGVSaWdodCAtIEluZGljYXRpbmcgY29sbGlkZSB3aXRoIGFueSBvYmplY3Qgb24gdGhlIHJpZ2h0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29sbGlkZVJpZ2h0ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29sbGlkZVVwIC0gSW5kaWNhdGluZyBjb2xsaWRlIHdpdGggYW55IG9iamVjdCBvbiB0aGUgdG9wLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29sbGlkZVVwID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29sbGlkZURvd24gLSBJbmRpY2F0aW5nIGNvbGxpZGUgd2l0aCBhbnkgb2JqZWN0IG9uIHRoZSBib3R0b20uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb2xsaWRlRG93biA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBjYWxsYmFjayAtIFRpbGUgY29sbGlzaW9uIGNhbGxiYWNrLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGNvbGxpc2lvbiBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNhbGxiYWNrQ29udGV4dCA9IHRoaXM7Cgp9OwoKUGhhc2VyLlRpbGUucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBTZXQgYSBjYWxsYmFjayB0byBiZSBjYWxsZWQgd2hlbiB0aGlzIHRpbGUgaXMgaGl0IGJ5IGFuIG9iamVjdC4KICAgICogVGhlIGNhbGxiYWNrIG11c3QgdHJ1ZSB0cnVlIGZvciBjb2xsaXNpb24gcHJvY2Vzc2luZyB0byB0YWtlIHBsYWNlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZSNzZXRDb2xsaXNpb25DYWxsYmFjawogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIENhbGxiYWNrIGZ1bmN0aW9uLgogICAgKiBAcGFyYW0ge29iamVjdH0gY29udGV4dCAtIENhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhpcyBjb250ZXh0LgogICAgKi8KICAgIHNldENvbGxpc2lvbkNhbGxiYWNrOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNvbnRleHQpIHsKCiAgICAgICAgdGhpcy5jb2xsaXNpb25DYWxsYmFja0NvbnRleHQgPSBjb250ZXh0OwogICAgICAgIHRoaXMuY29sbGlzaW9uQ2FsbGJhY2sgPSBjYWxsYmFjazsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGVhbiB1cCBtZW1vcnkuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGUjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5jb2xsaXNpb25DYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5jb2xsaXNpb25DYWxsYmFja0NvbnRleHQgPSBudWxsOwogICAgICAgIHRoaXMucHJvcGVydGllcyA9IG51bGw7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXQgY29sbGlzaW9uIHNldHRpbmdzIG9uIHRoaXMgdGlsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZSNzZXRDb2xsaXNpb24KICAgICogQHBhcmFtIHtib29sZWFufSBsZWZ0IC0gSW5kaWNhdGluZyBjb2xsaWRlIHdpdGggYW55IG9iamVjdCBvbiB0aGUgbGVmdC4KICAgICogQHBhcmFtIHtib29sZWFufSByaWdodCAtIEluZGljYXRpbmcgY29sbGlkZSB3aXRoIGFueSBvYmplY3Qgb24gdGhlIHJpZ2h0LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHVwIC0gSW5kaWNhdGluZyBjb2xsaWRlIHdpdGggYW55IG9iamVjdCBvbiB0aGUgdG9wLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGRvd24gLSBJbmRpY2F0aW5nIGNvbGxpZGUgd2l0aCBhbnkgb2JqZWN0IG9uIHRoZSBib3R0b20uCiAgICAqLwogICAgc2V0Q29sbGlzaW9uOiBmdW5jdGlvbiAobGVmdCwgcmlnaHQsIHVwLCBkb3duKSB7CgogICAgICAgIHRoaXMuY29sbGlkZUxlZnQgPSBsZWZ0OwogICAgICAgIHRoaXMuY29sbGlkZVJpZ2h0ID0gcmlnaHQ7CiAgICAgICAgdGhpcy5jb2xsaWRlVXAgPSB1cDsKICAgICAgICB0aGlzLmNvbGxpZGVEb3duID0gZG93bjsKCiAgICAgICAgaWYgKGxlZnQgfHwgcmlnaHQgfHwgdXAgfHwgZG93bikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29sbGlkZU5vbmUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb2xsaWRlTm9uZSA9IHRydWU7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlc2V0IGNvbGxpc2lvbiBzdGF0dXMgZmxhZ3MuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGUjcmVzZXRDb2xsaXNpb24KICAgICovCiAgICByZXNldENvbGxpc2lvbjogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmNvbGxpZGVOb25lID0gdHJ1ZTsKICAgICAgICB0aGlzLmNvbGxpZGVMZWZ0ID0gZmFsc2U7CiAgICAgICAgdGhpcy5jb2xsaWRlUmlnaHQgPSBmYWxzZTsKICAgICAgICB0aGlzLmNvbGxpZGVVcCA9IGZhbHNlOwogICAgICAgIHRoaXMuY29sbGlkZURvd24gPSBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDb3BpZXMgdGhlIHRpbGUgZGF0YSBhbmQgcHJvcGVydGllcyBmcm9tIHRoZSBnaXZlbiB0aWxlIHRvIHRoaXMgdGlsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZSNjb3B5CiAgICAqIEBwYXJhbSB7UGhhc2VyLlRpbGV9IHRpbGUgLSBUaGUgdGlsZSB0byBjb3B5IGZyb20uCiAgICAqLwogICAgY29weTogZnVuY3Rpb24gKHRpbGUpIHsKCiAgICAgICAgdGhpcy5pbmRleCA9IHRpbGUuaW5kZXg7CiAgICAgICAgdGhpcy5hbHBoYSA9IHRpbGUuYWxwaGE7CiAgICAgICAgdGhpcy5wcm9wZXJ0aWVzID0gdGlsZS5wcm9wZXJ0aWVzOwogICAgICAgIHRoaXMuY29sbGlkZXMgPSB0aWxlLmNvbGxpZGVzOwogICAgICAgIHRoaXMuY29sbGlkZU5vbmUgPSB0aWxlLmNvbGxpZGVOb25lOwogICAgICAgIHRoaXMuY29sbGlkZVVwID0gdGlsZS5jb2xsaWRlVXA7CiAgICAgICAgdGhpcy5jb2xsaWRlRG93biA9IHRpbGUuY29sbGlkZURvd247CiAgICAgICAgdGhpcy5jb2xsaWRlTGVmdCA9IHRpbGUuY29sbGlkZUxlZnQ7CiAgICAgICAgdGhpcy5jb2xsaWRlUmlnaHQgPSB0aWxlLmNvbGxpZGVSaWdodDsKICAgICAgICB0aGlzLmNvbGxpc2lvbkNhbGxiYWNrID0gdGlsZS5jb2xsaXNpb25DYWxsYmFjazsKICAgICAgICB0aGlzLmNvbGxpc2lvbkNhbGxiYWNrQ29udGV4dCA9IHRpbGUuY29sbGlzaW9uQ2FsbGJhY2tDb250ZXh0OwoKICAgIH0KCn07CgpQaGFzZXIuVGlsZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuVGlsZTsKCi8qKgoqIEBuYW1lIFBoYXNlci5UaWxlI2NhbkNvbGxpZGUKKiBAcHJvcGVydHkge2Jvb2xlYW59IGNhbkNvbGxpZGUgLSBUcnVlIGlmIHRoaXMgdGlsZSBjYW4gY29sbGlkZSBvciBoYXMgYSBjb2xsaXNpb24gY2FsbGJhY2suCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZS5wcm90b3R5cGUsICJjYW5Db2xsaWRlIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKHRoaXMuY29sbGlkZXMgfHwgdGhpcy5jb2xsaXNpb25DYWxsYmFjayB8fCB0aGlzLmxheWVyLmNhbGxiYWNrc1t0aGlzLmluZGV4XSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5UaWxlI2xlZnQKKiBAcHJvcGVydHkge251bWJlcn0gbGVmdCAtIFRoZSB4IHZhbHVlLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGUucHJvdG90eXBlLCAibGVmdCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueDsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbGUjcmlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gcmlnaHQgLSBUaGUgc3VtIG9mIHRoZSB4IGFuZCB3aWR0aCBwcm9wZXJ0aWVzLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGUucHJvdG90eXBlLCAicmlnaHQiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnggKyB0aGlzLndpZHRoOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuVGlsZSN0b3AKKiBAcHJvcGVydHkge251bWJlcn0gdG9wIC0gVGhlIHkgdmFsdWUuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZS5wcm90b3R5cGUsICJ0b3AiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5UaWxlI2JvdHRvbQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBib3R0b20gLSBUaGUgc3VtIG9mIHRoZSB5IGFuZCBoZWlnaHQgcHJvcGVydGllcy4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaWxlLnByb3RvdHlwZSwgImJvdHRvbSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueSArIHRoaXMuaGVpZ2h0OwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIFRpbGUgTWFwIG9iamVjdC4gQSBUaWxlIG1hcCBjb25zaXN0cyBvZiBhIHNldCBvZiB0aWxlIGRhdGEgYW5kIHRpbGUgc2V0cy4gSXQgaXMgcmVuZGVyZWQgdG8gdGhlIGRpc3BsYXkgdXNpbmcgYSBUaWxlbWFwTGF5ZXIuCiogQSBtYXAgbWF5IGhhdmUgbXVsdGlwbGUgbGF5ZXJzLiBZb3UgY2FuIHBlcmZvcm0gb3BlcmF0aW9ucyBvbiB0aGUgbWFwIGRhdGEgc3VjaCBhcyBjb3B5aW5nLCBwYXN0aW5nLCBmaWxsaW5nIGFuZCBzaHVmZmxpbmcgdGhlIHRpbGVzIGFyb3VuZC4KKgoqIEBjbGFzcyBQaGFzZXIuVGlsZW1hcAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBHYW1lIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge3N0cmluZ30gW2tleV0gLSBUaGUga2V5IG9mIHRoZSB0aWxlbWFwIGRhdGEgYXMgc3RvcmVkIGluIHRoZSBDYWNoZS4KKi8KUGhhc2VyLlRpbGVtYXAgPSBmdW5jdGlvbiAoZ2FtZSwga2V5KSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30ga2V5IC0gVGhlIGtleSBvZiB0aGlzIG1hcCBkYXRhIGluIHRoZSBQaGFzZXIuQ2FjaGUuCiAgICAqLwogICAgdGhpcy5rZXkgPSBrZXk7CgogICAgdmFyIGRhdGEgPSBQaGFzZXIuVGlsZW1hcFBhcnNlci5wYXJzZSh0aGlzLmdhbWUsIGtleSk7CgogICAgaWYgKGRhdGEgPT09IG51bGwpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIG1hcCAoaW4gdGlsZXMpLgogICAgKi8KICAgIHRoaXMud2lkdGggPSBkYXRhLndpZHRoOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgbWFwIChpbiB0aWxlcykuCiAgICAqLwogICAgdGhpcy5oZWlnaHQgPSBkYXRhLmhlaWdodDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbGVXaWR0aCAtIFRoZSBiYXNlIHdpZHRoIG9mIHRoZSB0aWxlcyBpbiB0aGUgbWFwIChpbiBwaXhlbHMpLgogICAgKi8KICAgIHRoaXMudGlsZVdpZHRoID0gZGF0YS50aWxlV2lkdGg7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aWxlSGVpZ2h0IC0gVGhlIGJhc2UgaGVpZ2h0IG9mIHRoZSB0aWxlcyBpbiB0aGUgbWFwIChpbiBwaXhlbHMpLgogICAgKi8KICAgIHRoaXMudGlsZUhlaWdodCA9IGRhdGEudGlsZUhlaWdodDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG9yaWVudGF0aW9uIC0gVGhlIG9yaWVudGF0aW9uIG9mIHRoZSBtYXAgZGF0YSAoYXMgc3BlY2lmaWVkIGluIFRpbGVkKSwgdXN1YWxseSAnb3J0aG9nb25hbCcuCiAgICAqLwogICAgdGhpcy5vcmllbnRhdGlvbiA9IGRhdGEub3JpZW50YXRpb247CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB2ZXJzaW9uIC0gVGhlIHZlcnNpb24gb2YgdGhlIG1hcCBkYXRhIChhcyBzcGVjaWZpZWQgaW4gVGlsZWQsIHVzdWFsbHkgMSkuCiAgICAqLwogICAgdGhpcy52ZXJzaW9uID0gZGF0YS52ZXJzaW9uOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gcHJvcGVydGllcyAtIE1hcCBzcGVjaWZpYyBwcm9wZXJ0aWVzIGFzIHNwZWNpZmllZCBpbiBUaWxlZC4KICAgICovCiAgICB0aGlzLnByb3BlcnRpZXMgPSBkYXRhLnByb3BlcnRpZXM7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aEluUGl4ZWxzIC0gVGhlIHdpZHRoIG9mIHRoZSBtYXAgaW4gcGl4ZWxzIGJhc2VkIG9uIHdpZHRoICogdGlsZVdpZHRoLgogICAgKi8KICAgIHRoaXMud2lkdGhJblBpeGVscyA9IGRhdGEud2lkdGhJblBpeGVsczsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodEluUGl4ZWxzIC0gVGhlIGhlaWdodCBvZiB0aGUgbWFwIGluIHBpeGVscyBiYXNlZCBvbiBoZWlnaHQgKiB0aWxlSGVpZ2h0LgogICAgKi8KICAgIHRoaXMuaGVpZ2h0SW5QaXhlbHMgPSBkYXRhLmhlaWdodEluUGl4ZWxzOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBsYXllcnMgLSBBbiBhcnJheSBvZiBUaWxlbWFwIGxheWVyIGRhdGEuCiAgICAqLwogICAgdGhpcy5sYXllcnMgPSBkYXRhLmxheWVyczsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gdGlsZXNldHMgLSBBbiBhcnJheSBvZiBUaWxlc2V0cy4KICAgICovCiAgICB0aGlzLnRpbGVzZXRzID0gZGF0YS50aWxlc2V0czsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gdGlsZXMgLSBUaGUgc3VwZXIgYXJyYXkgb2YgVGlsZXMuCiAgICAqLwogICAgdGhpcy50aWxlcyA9IGRhdGEudGlsZXM7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IG9iamVjdHMgLSBBbiBhcnJheSBvZiBUaWxlZCBPYmplY3QgTGF5ZXJzLgogICAgKi8KICAgIHRoaXMub2JqZWN0cyA9IGRhdGEub2JqZWN0czsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gaW1hZ2VzIC0gQW4gYXJyYXkgb2YgVGlsZWQgSW1hZ2UgTGF5ZXJzLgogICAgKi8KICAgIHRoaXMuaW1hZ2VzID0gZGF0YS5pbWFnZXM7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjdXJyZW50TGF5ZXIgLSBUaGUgY3VycmVudCBsYXllci4KICAgICovCiAgICB0aGlzLmN1cnJlbnRMYXllciA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGRlYnVnTWFwIC0gTWFwIGRhdGEgdXNlZCBmb3IgZGVidWcgdmFsdWVzIG9ubHkuCiAgICAqLwogICAgdGhpcy5kZWJ1Z01hcCA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBfcmVzdWx0cyAtIEludGVybmFsIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9yZXN1bHRzID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdGVtcEEgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdGVtcEEgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3RlbXBCIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3RlbXBCID0gMDsKCn07CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuVGlsZW1hcC5DU1YgPSAwOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLlRpbGVtYXAuVElMRURfSlNPTiA9IDE7CgpQaGFzZXIuVGlsZW1hcC5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIENyZWF0ZXMgYW4gZW1wdHkgbWFwIG9mIHRoZSBnaXZlbiBkaW1lbnNpb25zLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI2NyZWF0ZQogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBtYXAgKG1vc3RseSB1c2VkIGZvciBkZWJ1Z2dpbmcpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgbWFwIGluIHRpbGVzLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgbWFwIGluIHRpbGVzLgogICAgKi8KICAgIGNyZWF0ZTogZnVuY3Rpb24gKG5hbWUsIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgdmFyIGRhdGEgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgeSA9IDA7IHkgPCBoZWlnaHQ7IHkrKykKICAgICAgICB7CiAgICAgICAgICAgIGRhdGFbeV0gPSBbXTsKCiAgICAgICAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgd2lkdGg7IHgrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZGF0YVt5XVt4XSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMubGF5ZXJzLnB1c2goewoKICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgd2lkdGg6IHdpZHRoLAogICAgICAgICAgICBoZWlnaHQ6IGhlaWdodCwKICAgICAgICAgICAgYWxwaGE6IDEsCiAgICAgICAgICAgIHZpc2libGU6IHRydWUsCiAgICAgICAgICAgIHRpbGVNYXJnaW46IDAsCiAgICAgICAgICAgIHRpbGVTcGFjaW5nOiAwLAogICAgICAgICAgICBmb3JtYXQ6IFBoYXNlci5UaWxlbWFwLkNTViwKICAgICAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICAgICAgaW5kZXhlczogW10sCiAgICAgICAgICAgIGRpcnR5OiB0cnVlCgogICAgICAgIH0pOwoKICAgICAgICB0aGlzLmN1cnJlbnRMYXllciA9IHRoaXMubGF5ZXJzLmxlbmd0aCAtIDE7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyBhbiBpbWFnZSB0byB0aGUgbWFwIHRvIGJlIHVzZWQgYXMgYSB0aWxlc2V0LiBBIHNpbmdsZSBtYXAgbWF5IHVzZSBtdWx0aXBsZSB0aWxlc2V0cy4KICAgICogTm90ZSB0aGF0IHRoZSB0aWxlc2V0IG5hbWUgY2FuIGJlIGZvdW5kIGluIHRoZSBKU09OIGZpbGUgZXhwb3J0ZWQgZnJvbSBUaWxlZCwgb3IgaW4gdGhlIFRpbGVkIGVkaXRvci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNhZGRUaWxlc2V0SW1hZ2UKICAgICogQHBhcmFtIHtzdHJpbmd9IHRpbGVzZXQgLSBUaGUgbmFtZSBvZiB0aGUgdGlsZXNldCBhcyBzcGVjaWZpZWQgaW4gdGhlIG1hcCBkYXRhLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2tleV0gLSBUaGUga2V5IG9mIHRoZSBQaGFzZXIuQ2FjaGUgaW1hZ2UgdXNlZCBmb3IgdGhpcyB0aWxlc2V0LiBJZiBub3Qgc3BlY2lmaWVkIGl0IHdpbGwgbG9vayBmb3IgYW4gaW1hZ2Ugd2l0aCBhIGtleSBtYXRjaGluZyB0aGUgdGlsZXNldCBwYXJhbWV0ZXIuCiAgICAqLwogICAgYWRkVGlsZXNldEltYWdlOiBmdW5jdGlvbiAodGlsZXNldCwga2V5KSB7CgogICAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdGlsZXNldCA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGtleSA9IHRpbGVzZXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgdGlsZXNldCA9PT0gJ3N0cmluZycpCiAgICAgICAgewogICAgICAgICAgICB0aWxlc2V0ID0gdGhpcy5nZXRUaWxlc2V0SW5kZXgodGlsZXNldCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy50aWxlc2V0c1t0aWxlc2V0XSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudGlsZXNldHNbdGlsZXNldF0uaW1hZ2UgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0SW1hZ2Uoa2V5KTsKCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoKICAgIGNyZWF0ZUZyb21UaWxlczogZnVuY3Rpb24gKGxheWVyLCB0aWxlSW5kZXgsIGtleSwgZnJhbWUsIGdyb3VwKSB7CgogICAgICAgIGlmICh0eXBlb2YgZ3JvdXAgPT09ICd1bmRlZmluZWQnKSB7IGdyb3VwID0gdGhpcy5nYW1lLndvcmxkOyB9CgogICAgfSwKICAgICovCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBTcHJpdGUgZm9yIGV2ZXJ5IG9iamVjdCBtYXRjaGluZyB0aGUgZ2l2ZW4gZ2lkIGluIHRoZSBtYXAgZGF0YS4gWW91IGNhbiBvcHRpb25hbGx5IHNwZWNpZnkgdGhlIGdyb3VwIHRoYXQgdGhlIFNwcml0ZSB3aWxsIGJlIGNyZWF0ZWQgaW4uIElmIG5vbmUgaXMKICAgICogZ2l2ZW4gaXQgd2lsbCBiZSBjcmVhdGVkIGluIHRoZSBXb3JsZC4gQWxsIHByb3BlcnRpZXMgZnJvbSB0aGUgbWFwIGRhdGEgb2JqZWN0Z3JvdXAgYXJlIGNvcGllZCBhY3Jvc3MgdG8gdGhlIFNwcml0ZSwgc28geW91IGNhbiB1c2UgdGhpcyBhcyBhbiBlYXN5IHdheSB0bwogICAgKiBjb25maWd1cmUgU3ByaXRlIHByb3BlcnRpZXMgZnJvbSB3aXRoaW4gdGhlIG1hcCBlZGl0b3IuIEZvciBleGFtcGxlIGdpdmluZyBhbiBvYmplY3QgYSBwcm9wZXJ0eSBpZiBhbHBoYTogMC41IGluIHRoZSBtYXAgZWRpdG9yIHdpbGwgZHVwbGljYXRlIHRoYXQgd2hlbiB0aGUKICAgICogU3ByaXRlIGlzIGNyZWF0ZWQuIFlvdSBjb3VsZCBhbHNvIGdpdmUgaXQgYSB2YWx1ZSBsaWtlOiBib2R5LnZlbG9jaXR5Lng6IDEwMCB0byBzZXQgaXQgbW92aW5nIGF1dG9tYXRpY2FsbHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjY3JlYXRlRnJvbU9iamVjdHMKICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgT2JqZWN0IEdyb3VwIHRvIGNyZWF0ZSBTcHJpdGVzIGZyb20uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBnaWQgLSBUaGUgbGF5ZXIgYXJyYXkgaW5kZXggdmFsdWUsIG9yIGlmIGEgc3RyaW5nIGlzIGdpdmVuIHRoZSBsYXllciBuYW1lLCB3aXRoaW4gdGhlIG1hcCBkYXRhIHRoYXQgdGhpcyBUaWxlbWFwTGF5ZXIgcmVwcmVzZW50cy4KICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBHYW1lLmNhY2hlIGtleSBvZiB0aGUgaW1hZ2UgdGhhdCB0aGlzIFNwcml0ZSB3aWxsIHVzZS4KICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBbZnJhbWVdIC0gSWYgdGhlIFNwcml0ZSBpbWFnZSBjb250YWlucyBtdWx0aXBsZSBmcmFtZXMgeW91IGNhbiBzcGVjaWZ5IHdoaWNoIG9uZSB0byB1c2UgaGVyZS4KICAgICogQHBhcmFtIHtib29sZWFufSBbZXhpc3RzPXRydWVdIC0gVGhlIGRlZmF1bHQgZXhpc3RzIHN0YXRlIG9mIHRoZSBTcHJpdGUuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2F1dG9DdWxsPXRydWVdIC0gVGhlIGRlZmF1bHQgYXV0b0N1bGwgc3RhdGUgb2YgdGhlIFNwcml0ZS4gU3ByaXRlcyB0aGF0IGFyZSBhdXRvQ3VsbGVkIGFyZSBjdWxsZWQgZnJvbSB0aGUgY2FtZXJhIGlmIG91dCBvZiBpdHMgcmFuZ2UuCiAgICAqIEBwYXJhbSB7UGhhc2VyLkdyb3VwfSBbZ3JvdXBdIC0gT3B0aW9uYWwgR3JvdXAgdG8gYWRkIHRoZSBTcHJpdGUgdG8uIElmIG5vdCBzcGVjaWZpZWQgaXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgV29ybGQgZ3JvdXAuCiAgICAqLwogICAgY3JlYXRlRnJvbU9iamVjdHM6IGZ1bmN0aW9uIChuYW1lLCBnaWQsIGtleSwgZnJhbWUsIGV4aXN0cywgYXV0b0N1bGwsIGdyb3VwKSB7CgogICAgICAgIGlmICh0eXBlb2YgZXhpc3RzID09PSAndW5kZWZpbmVkJykgeyBleGlzdHMgPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBhdXRvQ3VsbCA9PT0gJ3VuZGVmaW5lZCcpIHsgYXV0b0N1bGwgPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBncm91cCA9PT0gJ3VuZGVmaW5lZCcpIHsgZ3JvdXAgPSB0aGlzLmdhbWUud29ybGQ7IH0KCiAgICAgICAgaWYgKCF0aGlzLm9iamVjdHNbbmFtZV0pCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1RpbGVtYXAuY3JlYXRlRnJvbU9iamVjdHM6IEludmFsaWQgb2JqZWN0Z3JvdXAgbmFtZSBnaXZlbjogJyArIG5hbWUpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgc3ByaXRlOwoKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5vYmplY3RzW25hbWVdLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMub2JqZWN0c1tuYW1lXVtpXS5naWQgPT09IGdpZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3ByaXRlID0gZ3JvdXAuY3JlYXRlKHRoaXMub2JqZWN0c1tuYW1lXVtpXS54LCB0aGlzLm9iamVjdHNbbmFtZV1baV0ueSwga2V5LCBmcmFtZSwgZXhpc3RzKTsKCiAgICAgICAgICAgICAgICBzcHJpdGUuYW5jaG9yLnNldFRvKDAsIDEpOwogICAgICAgICAgICAgICAgc3ByaXRlLm5hbWUgPSB0aGlzLm9iamVjdHNbbmFtZV1baV0ubmFtZTsKICAgICAgICAgICAgICAgIHNwcml0ZS52aXNpYmxlID0gdGhpcy5vYmplY3RzW25hbWVdW2ldLnZpc2libGU7CiAgICAgICAgICAgICAgICBzcHJpdGUuYXV0b0N1bGwgPSBhdXRvQ3VsbDsKCiAgICAgICAgICAgICAgICBmb3IgKHByb3BlcnR5IGluIHRoaXMub2JqZWN0c1tuYW1lXVtpXS5wcm9wZXJ0aWVzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGdyb3VwLnNldChzcHJpdGUsIHByb3BlcnR5LCB0aGlzLm9iamVjdHNbbmFtZV1baV0ucHJvcGVydGllc1twcm9wZXJ0eV0sIGZhbHNlLCBmYWxzZSwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ3JlYXRlcyBhIG5ldyBUaWxlbWFwTGF5ZXIgb2JqZWN0LiBCeSBkZWZhdWx0IFRpbGVtYXBMYXllcnMgYXJlIGZpeGVkIHRvIHRoZSBjYW1lcmEuCiAgICAqIFRoZSBgbGF5ZXJgIHBhcmFtZXRlciBpcyBpbXBvcnRhbnQuIElmIHlvdSd2ZSBjcmVhdGVkIHlvdXIgbWFwIGluIFRpbGVkIHRoZW4geW91IGNhbiBnZXQgdGhpcyBieSBsb29raW5nIGluIFRpbGVkIGFuZCBsb29raW5nIGF0IHRoZSBMYXllciBuYW1lLgogICAgKiBPciB5b3UgY2FuIG9wZW4gdGhlIEpTT04gZmlsZSBpdCBleHBvcnRzIGFuZCBsb29rIGF0IHRoZSBsYXllcnNbXS5uYW1lIHZhbHVlLiBFaXRoZXIgd2F5IGl0IG11c3QgbWF0Y2guCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjY3JlYXRlTGF5ZXIKICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBsYXllciAtIFRoZSBsYXllciBhcnJheSBpbmRleCB2YWx1ZSwgb3IgaWYgYSBzdHJpbmcgaXMgZ2l2ZW4gdGhlIGxheWVyIG5hbWUsIHdpdGhpbiB0aGUgbWFwIGRhdGEgdGhhdCB0aGlzIFRpbGVtYXBMYXllciByZXByZXNlbnRzLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoXSAtIFRoZSByZW5kZXJlZCB3aWR0aCBvZiB0aGUgbGF5ZXIsIHNob3VsZCBuZXZlciBiZSB3aWRlciB0aGFuIEdhbWUud2lkdGguIElmIG5vdCBnaXZlbiBpdCB3aWxsIGJlIHNldCB0byBHYW1lLndpZHRoLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodF0gLSBUaGUgcmVuZGVyZWQgaGVpZ2h0IG9mIHRoZSBsYXllciwgc2hvdWxkIG5ldmVyIGJlIHdpZGVyIHRoYW4gR2FtZS5oZWlnaHQuIElmIG5vdCBnaXZlbiBpdCB3aWxsIGJlIHNldCB0byBHYW1lLmhlaWdodC4KICAgICogQHBhcmFtIHtQaGFzZXIuR3JvdXB9IFtncm91cF0gLSBPcHRpb25hbCBHcm91cCB0byBhZGQgdGhlIG9iamVjdCB0by4gSWYgbm90IHNwZWNpZmllZCBpdCB3aWxsIGJlIGFkZGVkIHRvIHRoZSBXb3JsZCBncm91cC4KICAgICogQHJldHVybiB7UGhhc2VyLlRpbGVtYXBMYXllcn0gVGhlIFRpbGVtYXBMYXllciBvYmplY3QuIFRoaXMgaXMgYW4gZXh0ZW5zaW9uIG9mIFBoYXNlci5TcHJpdGUgYW5kIGNhbiBiZSBtb3ZlZCBhcm91bmQgdGhlIGRpc3BsYXkgbGlzdCBhY2NvcmRpbmdseS4KICAgICovCiAgICBjcmVhdGVMYXllcjogZnVuY3Rpb24gKGxheWVyLCB3aWR0aCwgaGVpZ2h0LCBncm91cCkgewoKICAgICAgICAvLyAgQWRkIEJ1ZmZlciBzdXBwb3J0IGZvciB0aGUgbGVmdCBvZiB0aGUgY2FudmFzCgogICAgICAgIGlmICh0eXBlb2Ygd2lkdGggPT09ICd1bmRlZmluZWQnKSB7IHdpZHRoID0gdGhpcy5nYW1lLndpZHRoOyB9CiAgICAgICAgaWYgKHR5cGVvZiBoZWlnaHQgPT09ICd1bmRlZmluZWQnKSB7IGhlaWdodCA9IHRoaXMuZ2FtZS5oZWlnaHQ7IH0KICAgICAgICBpZiAodHlwZW9mIGdyb3VwID09PSAndW5kZWZpbmVkJykgeyBncm91cCA9IHRoaXMuZ2FtZS53b3JsZDsgfQoKICAgICAgICB2YXIgaW5kZXggPSBsYXllcjsKCiAgICAgICAgaWYgKHR5cGVvZiBsYXllciA9PT0gJ3N0cmluZycpCiAgICAgICAgewogICAgICAgICAgICBpbmRleCA9IHRoaXMuZ2V0TGF5ZXJJbmRleChsYXllcik7CiAgICAgICAgfQoKICAgICAgICBpZiAoaW5kZXggPT09IG51bGwgfHwgaW5kZXggPiB0aGlzLmxheWVycy5sZW5ndGgpCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1RpbGVtYXAuY3JlYXRlTGF5ZXI6IEludmFsaWQgbGF5ZXIgSUQgZ2l2ZW46ICcgKyBpbmRleCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBncm91cC5hZGQobmV3IFBoYXNlci5UaWxlbWFwTGF5ZXIodGhpcy5nYW1lLCB0aGlzLCBpbmRleCwgd2lkdGgsIGhlaWdodCkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldHMgdGhlIGxheWVyIGluZGV4IGJhc2VkIG9uIHRoZSBsYXllcnMgbmFtZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNnZXRJbmRleAogICAgKiBAcHJvdGVjdGVkCiAgICAqIEBwYXJhbSB7YXJyYXl9IGxvY2F0aW9uIC0gVGhlIGxvY2FsIGFycmF5IHRvIHNlYXJjaC4KICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgYXJyYXkgZWxlbWVudCB0byBnZXQuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGluZGV4IG9mIHRoZSBlbGVtZW50IGluIHRoZSBhcnJheSwgb3IgbnVsbCBpZiBub3QgZm91bmQuCiAgICAqLwogICAgZ2V0SW5kZXg6IGZ1bmN0aW9uIChsb2NhdGlvbiwgbmFtZSkgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxvY2F0aW9uLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGxvY2F0aW9uW2ldLm5hbWUgPT09IG5hbWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXRzIHRoZSBsYXllciBpbmRleCBiYXNlZCBvbiBpdHMgbmFtZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNnZXRMYXllckluZGV4CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGxheWVyIHRvIGdldC4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgaW5kZXggb2YgdGhlIGxheWVyIGluIHRoaXMgdGlsZW1hcCwgb3IgbnVsbCBpZiBub3QgZm91bmQuCiAgICAqLwogICAgZ2V0TGF5ZXJJbmRleDogZnVuY3Rpb24gKG5hbWUpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SW5kZXgodGhpcy5sYXllcnMsIG5hbWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldHMgdGhlIHRpbGVzZXQgaW5kZXggYmFzZWQgb24gaXRzIG5hbWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjZ2V0VGlsZXNldEluZGV4CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHRpbGVzZXQgdG8gZ2V0LgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBpbmRleCBvZiB0aGUgdGlsZXNldCBpbiB0aGlzIHRpbGVtYXAsIG9yIG51bGwgaWYgbm90IGZvdW5kLgogICAgKi8KICAgIGdldFRpbGVzZXRJbmRleDogZnVuY3Rpb24gKG5hbWUpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SW5kZXgodGhpcy50aWxlc2V0cywgbmFtZSk7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0cyB0aGUgaW1hZ2UgaW5kZXggYmFzZWQgb24gaXRzIG5hbWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjZ2V0SW1hZ2VJbmRleAogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBpbWFnZSB0byBnZXQuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGluZGV4IG9mIHRoZSBpbWFnZSBpbiB0aGlzIHRpbGVtYXAsIG9yIG51bGwgaWYgbm90IGZvdW5kLgogICAgKi8KICAgIGdldEltYWdlSW5kZXg6IGZ1bmN0aW9uIChuYW1lKSB7CgogICAgICAgIHJldHVybiB0aGlzLmdldEluZGV4KHRoaXMuaW1hZ2VzLCBuYW1lKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXRzIHRoZSBvYmplY3QgaW5kZXggYmFzZWQgb24gaXRzIG5hbWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjZ2V0T2JqZWN0SW5kZXgKICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgb2JqZWN0IHRvIGdldC4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgaW5kZXggb2YgdGhlIG9iamVjdCBpbiB0aGlzIHRpbGVtYXAsIG9yIG51bGwgaWYgbm90IGZvdW5kLgogICAgKi8KICAgIGdldE9iamVjdEluZGV4OiBmdW5jdGlvbiAobmFtZSkgewoKICAgICAgICByZXR1cm4gdGhpcy5nZXRJbmRleCh0aGlzLm9iamVjdHMsIG5hbWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgYSBnbG9iYWwgY29sbGlzaW9uIGNhbGxiYWNrIGZvciB0aGUgZ2l2ZW4gdGlsZSBpbmRleCB3aXRoaW4gdGhlIGxheWVyLiBUaGlzIHdpbGwgYWZmZWN0IGFsbCB0aWxlcyBvbiB0aGlzIGxheWVyIHRoYXQgaGF2ZSB0aGUgc2FtZSBpbmRleC4KICAgICogSWYgYSBjYWxsYmFjayBpcyBhbHJlYWR5IHNldCBmb3IgdGhlIHRpbGUgaW5kZXggaXQgd2lsbCBiZSByZXBsYWNlZC4gU2V0IHRoZSBjYWxsYmFjayB0byBudWxsIHRvIHJlbW92ZSBpdC4KICAgICogSWYgeW91IHdhbnQgdG8gc2V0IGEgY2FsbGJhY2sgZm9yIGEgdGlsZSBhdCBhIHNwZWNpZmljIGxvY2F0aW9uIG9uIHRoZSBtYXAgdGhlbiBzZWUgc2V0VGlsZUxvY2F0aW9uQ2FsbGJhY2suCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjc2V0VGlsZUluZGV4Q2FsbGJhY2sKICAgICogQHBhcmFtIHtudW1iZXJ8YXJyYXl9IGluZGV4ZXMgLSBFaXRoZXIgYSBzaW5nbGUgdGlsZSBpbmRleCwgb3IgYW4gYXJyYXkgb2YgdGlsZSBpbmRleGVzIHRvIGhhdmUgYSBjb2xsaXNpb24gY2FsbGJhY2sgc2V0IGZvci4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGludm9rZWQgd2hlbiB0aGUgdGlsZSBpcyBjb2xsaWRlZCB3aXRoLgogICAgKiBAcGFyYW0ge29iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgdW5kZXIgd2hpY2ggdGhlIGNhbGxiYWNrIGlzIGNhbGxlZC4KICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfFBoYXNlci5UaWxlbWFwTGF5ZXJ9IFtsYXllcl0gLSBUaGUgbGF5ZXIgdG8gb3BlcmF0ZSBvbi4gSWYgbm90IGdpdmVuIHdpbGwgZGVmYXVsdCB0byB0aGlzLmN1cnJlbnRMYXllci4KICAgICovCiAgICBzZXRUaWxlSW5kZXhDYWxsYmFjazogZnVuY3Rpb24gKGluZGV4ZXMsIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIGxheWVyKSB7CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIGlmICh0eXBlb2YgaW5kZXhlcyA9PT0gJ251bWJlcicpCiAgICAgICAgewogICAgICAgICAgICAvLyAgVGhpcyBtYXkgc2VlbSBhIGJpdCB3YXN0ZWZ1bCwgYmVjYXVzZSBpdCB3aWxsIGNhdXNlIGVtcHR5IGFycmF5IGVsZW1lbnRzIHRvIGJlIGNyZWF0ZWQsIGJ1dCB0aGUgbG9vay11cCBjb3N0IGlzIG11Y2gKICAgICAgICAgICAgLy8gIGxlc3MgdGhhbiBoYXZpbmcgdG8gaXRlcmF0ZSB0aHJvdWdoIHRoZSBjYWxsYmFja3MgYXJyYXkgaHVudGluZyBkb3duIHRpbGUgaW5kZXhlcyBlYWNoIHRpbWUsIHNvIEknbGwgdGFrZSB0aGUgc21hbGwgbWVtb3J5IGhpdC4KICAgICAgICAgICAgdGhpcy5sYXllcnNbbGF5ZXJdLmNhbGxiYWNrc1tpbmRleGVzXSA9IHsgY2FsbGJhY2s6IGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQ6IGNhbGxiYWNrQ29udGV4dCB9OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaW5kZXhlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5sYXllcnNbbGF5ZXJdLmNhbGxiYWNrc1tpbmRleGVzW2ldXSA9IHsgY2FsbGJhY2s6IGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQ6IGNhbGxiYWNrQ29udGV4dCB9OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgYSBnbG9iYWwgY29sbGlzaW9uIGNhbGxiYWNrIGZvciB0aGUgZ2l2ZW4gdGlsZSBpbmRleCB3aXRoaW4gdGhlIGxheWVyLiBUaGlzIHdpbGwgYWZmZWN0IGFsbCB0aWxlcyBvbiB0aGlzIGxheWVyIHRoYXQgaGF2ZSB0aGUgc2FtZSBpbmRleC4KICAgICogSWYgYSBjYWxsYmFjayBpcyBhbHJlYWR5IHNldCBmb3IgdGhlIHRpbGUgaW5kZXggaXQgd2lsbCBiZSByZXBsYWNlZC4gU2V0IHRoZSBjYWxsYmFjayB0byBudWxsIHRvIHJlbW92ZSBpdC4KICAgICogSWYgeW91IHdhbnQgdG8gc2V0IGEgY2FsbGJhY2sgZm9yIGEgdGlsZSBhdCBhIHNwZWNpZmljIGxvY2F0aW9uIG9uIHRoZSBtYXAgdGhlbiBzZWUgc2V0VGlsZUxvY2F0aW9uQ2FsbGJhY2suCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjc2V0VGlsZUxvY2F0aW9uQ2FsbGJhY2sKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBvZiB0aGUgYXJlYSB0byBjb3B5IChnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscykKICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBvZiB0aGUgYXJlYSB0byBjb3B5IChnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscykKICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBhcmVhIHRvIGNvcHkgKGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgYXJlYSB0byBjb3B5IChnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscykKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGludm9rZWQgd2hlbiB0aGUgdGlsZSBpcyBjb2xsaWRlZCB3aXRoLgogICAgKiBAcGFyYW0ge29iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgdW5kZXIgd2hpY2ggdGhlIGNhbGxiYWNrIGlzIGNhbGxlZC4KICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfFBoYXNlci5UaWxlbWFwTGF5ZXJ9IFtsYXllcl0gLSBUaGUgbGF5ZXIgdG8gb3BlcmF0ZSBvbi4gSWYgbm90IGdpdmVuIHdpbGwgZGVmYXVsdCB0byB0aGlzLmN1cnJlbnRMYXllci4KICAgICovCiAgICBzZXRUaWxlTG9jYXRpb25DYWxsYmFjazogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQsIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIGxheWVyKSB7CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIHRoaXMuY29weSh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcik7CgogICAgICAgIGlmICh0aGlzLl9yZXN1bHRzLmxlbmd0aCA8IDIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRoaXMuX3Jlc3VsdHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9yZXN1bHRzW2ldLnNldENvbGxpc2lvbkNhbGxiYWNrKGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIGNvbGxpc2lvbiB0aGUgZ2l2ZW4gdGlsZSBvciB0aWxlcy4gWW91IGNhbiBwYXNzIGluIGVpdGhlciBhIHNpbmdsZSBudW1lcmljIGluZGV4IG9yIGFuIGFycmF5IG9mIGluZGV4ZXM6IFsgMiwgMywgMTUsIDIwXS4KICAgICogVGhlIGBjb2xsaWRlc2AgcGFyYW1ldGVyIGNvbnRyb2xzIGlmIGNvbGxpc2lvbiB3aWxsIGJlIGVuYWJsZWQgKHRydWUpIG9yIGRpc2FibGVkIChmYWxzZSkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjc2V0Q29sbGlzaW9uCiAgICAqIEBwYXJhbSB7bnVtYmVyfGFycmF5fSBpbmRleGVzIC0gRWl0aGVyIGEgc2luZ2xlIHRpbGUgaW5kZXgsIG9yIGFuIGFycmF5IG9mIHRpbGUgSURzIHRvIGJlIGNoZWNrZWQgZm9yIGNvbGxpc2lvbi4KICAgICogQHBhcmFtIHtib29sZWFufSBbY29sbGlkZXM9dHJ1ZV0gLSBJZiB0cnVlIGl0IHdpbGwgZW5hYmxlIGNvbGxpc2lvbi4gSWYgZmFsc2UgaXQgd2lsbCBjbGVhciBjb2xsaXNpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIG9wZXJhdGUgb24uIElmIG5vdCBnaXZlbiB3aWxsIGRlZmF1bHQgdG8gdGhpcy5jdXJyZW50TGF5ZXIuCiAgICAqLwogICAgc2V0Q29sbGlzaW9uOiBmdW5jdGlvbiAoaW5kZXhlcywgY29sbGlkZXMsIGxheWVyKSB7CgogICAgICAgIGlmICh0eXBlb2YgY29sbGlkZXMgPT09ICd1bmRlZmluZWQnKSB7IGNvbGxpZGVzID0gdHJ1ZTsgfQoKICAgICAgICBsYXllciA9IHRoaXMuZ2V0TGF5ZXIobGF5ZXIpOwoKICAgICAgICBpZiAodHlwZW9mIGluZGV4ZXMgPT09ICdudW1iZXInKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0Q29sbGlzaW9uQnlJbmRleChpbmRleGVzLCBjb2xsaWRlcywgbGF5ZXIsIHRydWUpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgQ29sbGlkZSBhbGwgb2YgdGhlIElEcyBnaXZlbiBpbiB0aGUgaW5kZXhlcyBhcnJheQogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaW5kZXhlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zZXRDb2xsaXNpb25CeUluZGV4KGluZGV4ZXNbaV0sIGNvbGxpZGVzLCBsYXllciwgZmFsc2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAgTm93IHJlLWNhbGN1bGF0ZSBpbnRlcmVzdGluZyBmYWNlcwogICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZUZhY2VzKGxheWVyKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyBjb2xsaXNpb24gb24gYSByYW5nZSBvZiB0aWxlcyB3aGVyZSB0aGUgdGlsZSBJRHMgaW5jcmVtZW50IHNlcXVlbnRpYWxseS4KICAgICogQ2FsbGluZyB0aGlzIHdpdGggYSBzdGFydCB2YWx1ZSBvZiAxMCBhbmQgYSBzdG9wIHZhbHVlIG9mIDE0IHdvdWxkIHNldCBjb2xsaXNpb24gZm9yIHRpbGVzIDEwLCAxMSwgMTIsIDEzIGFuZCAxNC4KICAgICogVGhlIGBjb2xsaWRlc2AgcGFyYW1ldGVyIGNvbnRyb2xzIGlmIGNvbGxpc2lvbiB3aWxsIGJlIGVuYWJsZWQgKHRydWUpIG9yIGRpc2FibGVkIChmYWxzZSkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjc2V0Q29sbGlzaW9uQmV0d2VlbgogICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnQgLSBUaGUgZmlyc3QgaW5kZXggb2YgdGhlIHRpbGUgdG8gYmUgc2V0IGZvciBjb2xsaXNpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdG9wIC0gVGhlIGxhc3QgaW5kZXggb2YgdGhlIHRpbGUgdG8gYmUgc2V0IGZvciBjb2xsaXNpb24uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2NvbGxpZGVzPXRydWVdIC0gSWYgdHJ1ZSBpdCB3aWxsIGVuYWJsZSBjb2xsaXNpb24uIElmIGZhbHNlIGl0IHdpbGwgY2xlYXIgY29sbGlzaW9uLgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBvcGVyYXRlIG9uLiBJZiBub3QgZ2l2ZW4gd2lsbCBkZWZhdWx0IHRvIHRoaXMuY3VycmVudExheWVyLgogICAgKi8KICAgIHNldENvbGxpc2lvbkJldHdlZW46IGZ1bmN0aW9uIChzdGFydCwgc3RvcCwgY29sbGlkZXMsIGxheWVyKSB7CgogICAgICAgIGlmICh0eXBlb2YgY29sbGlkZXMgPT09ICd1bmRlZmluZWQnKSB7IGNvbGxpZGVzID0gdHJ1ZTsgfQoKICAgICAgICBsYXllciA9IHRoaXMuZ2V0TGF5ZXIobGF5ZXIpOwoKICAgICAgICBpZiAoc3RhcnQgPiBzdG9wKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaW5kZXggPSBzdGFydDsgaW5kZXggPD0gc3RvcDsgaW5kZXgrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc2V0Q29sbGlzaW9uQnlJbmRleChpbmRleCwgY29sbGlkZXMsIGxheWVyLCBmYWxzZSk7CiAgICAgICAgfQoKICAgICAgICAvLyAgTm93IHJlLWNhbGN1bGF0ZSBpbnRlcmVzdGluZyBmYWNlcwogICAgICAgIHRoaXMuY2FsY3VsYXRlRmFjZXMobGF5ZXIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgY29sbGlzaW9uIG9uIGFsbCB0aWxlcyBpbiB0aGUgZ2l2ZW4gbGF5ZXIsIGV4Y2VwdCBmb3IgdGhlIElEcyBvZiB0aG9zZSBpbiB0aGUgZ2l2ZW4gYXJyYXkuCiAgICAqIFRoZSBgY29sbGlkZXNgIHBhcmFtZXRlciBjb250cm9scyBpZiBjb2xsaXNpb24gd2lsbCBiZSBlbmFibGVkICh0cnVlKSBvciBkaXNhYmxlZCAoZmFsc2UpLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI3NldENvbGxpc2lvbkJ5RXhjbHVzaW9uCiAgICAqIEBwYXJhbSB7YXJyYXl9IGluZGV4ZXMgLSBBbiBhcnJheSBvZiB0aGUgdGlsZSBJRHMgdG8gbm90IGJlIGNvdW50ZWQgZm9yIGNvbGxpc2lvbi4KICAgICogQHBhcmFtIHtib29sZWFufSBbY29sbGlkZXM9dHJ1ZV0gLSBJZiB0cnVlIGl0IHdpbGwgZW5hYmxlIGNvbGxpc2lvbi4gSWYgZmFsc2UgaXQgd2lsbCBjbGVhciBjb2xsaXNpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIG9wZXJhdGUgb24uIElmIG5vdCBnaXZlbiB3aWxsIGRlZmF1bHQgdG8gdGhpcy5jdXJyZW50TGF5ZXIuCiAgICAqLwogICAgc2V0Q29sbGlzaW9uQnlFeGNsdXNpb246IGZ1bmN0aW9uIChpbmRleGVzLCBjb2xsaWRlcywgbGF5ZXIpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBjb2xsaWRlcyA9PT0gJ3VuZGVmaW5lZCcpIHsgY29sbGlkZXMgPSB0cnVlOyB9CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIC8vICBDb2xsaWRlIGV2ZXJ5dGhpbmcsIGV4Y2VwdCB0aGUgSURzIGdpdmVuIGluIHRoZSBpbmRleGVzIGFycmF5CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMudGlsZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAoaW5kZXhlcy5pbmRleE9mKGkpID09PSAtMSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zZXRDb2xsaXNpb25CeUluZGV4KGksIGNvbGxpZGVzLCBsYXllciwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyAgTm93IHJlLWNhbGN1bGF0ZSBpbnRlcmVzdGluZyBmYWNlcwogICAgICAgIHRoaXMuY2FsY3VsYXRlRmFjZXMobGF5ZXIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgY29sbGlzaW9uIHZhbHVlcyBvbiBhIHRpbGUgaW4gdGhlIHNldC4KICAgICogWW91IHNob3VsZG4ndCB1c3VhbGx5IGNhbGwgdGhpcyBtZXRob2QgZGlyZWN0bHksIGluc3RlYWQgdXNlIHNldENvbGxpc2lvbiwgc2V0Q29sbGlzaW9uQmV0d2VlbiBvciBzZXRDb2xsaXNpb25CeUV4Y2x1c2lvbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNzZXRDb2xsaXNpb25CeUluZGV4CiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoZSB0aWxlIG9uIHRoZSBsYXllci4KICAgICogQHBhcmFtIHtib29sZWFufSBbY29sbGlkZXM9dHJ1ZV0gLSBJZiB0cnVlIGl0IHdpbGwgZW5hYmxlIGNvbGxpc2lvbiBvbiB0aGUgdGlsZS4gSWYgZmFsc2UgaXQgd2lsbCBjbGVhciBjb2xsaXNpb24gdmFsdWVzIGZyb20gdGhlIHRpbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIG9wZXJhdGUgb24uIElmIG5vdCBnaXZlbiB3aWxsIGRlZmF1bHQgdG8gdGhpcy5jdXJyZW50TGF5ZXIuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3JlY2FsY3VsYXRlPXRydWVdIC0gUmVjYWxjdWxhdGVzIHRoZSB0aWxlIGZhY2VzIGFmdGVyIHRoZSB1cGRhdGUuCiAgICAqLwogICAgc2V0Q29sbGlzaW9uQnlJbmRleDogZnVuY3Rpb24gKGluZGV4LCBjb2xsaWRlcywgbGF5ZXIsIHJlY2FsY3VsYXRlKSB7CgogICAgICAgIGlmICh0eXBlb2YgY29sbGlkZXMgPT09ICd1bmRlZmluZWQnKSB7IGNvbGxpZGVzID0gdHJ1ZTsgfQogICAgICAgIGlmICh0eXBlb2YgbGF5ZXIgPT09ICd1bmRlZmluZWQnKSB7IGxheWVyID0gdGhpcy5jdXJyZW50TGF5ZXI7IH0KICAgICAgICBpZiAodHlwZW9mIHJlY2FsY3VsYXRlID09PSAndW5kZWZpbmVkJykgeyByZWNhbGN1bGF0ZSA9IHRydWU7IH0KCiAgICAgICAgZm9yICh2YXIgeSA9IDA7IHkgPCB0aGlzLmxheWVyc1tsYXllcl0uaGVpZ2h0IDsgeSsrKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLmxheWVyc1tsYXllcl0ud2lkdGg7IHgrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRpbGUgPSB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt5XVt4XTsKCiAgICAgICAgICAgICAgICBpZiAodGlsZSAmJiB0aWxlLmluZGV4ID09PSBpbmRleCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aWxlLmNvbGxpZGVzID0gY29sbGlkZXM7CiAgICAgICAgICAgICAgICAgICAgdGlsZS5mYWNlVG9wID0gY29sbGlkZXM7CiAgICAgICAgICAgICAgICAgICAgdGlsZS5mYWNlQm90dG9tID0gY29sbGlkZXM7CiAgICAgICAgICAgICAgICAgICAgdGlsZS5mYWNlTGVmdCA9IGNvbGxpZGVzOwogICAgICAgICAgICAgICAgICAgIHRpbGUuZmFjZVJpZ2h0ID0gY29sbGlkZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChyZWNhbGN1bGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBOb3cgcmUtY2FsY3VsYXRlIGludGVyZXN0aW5nIGZhY2VzCiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlRmFjZXMobGF5ZXIpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGxheWVyOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldHMgdGhlIFRpbGVtYXBMYXllciBpbmRleCBhcyB1c2VkIGluIHRoZSBzZXRDb2xsaXNpb24gY2FsbHMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjZ2V0TGF5ZXIKICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gbGF5ZXIgLSBUaGUgbGF5ZXIgdG8gb3BlcmF0ZSBvbi4gSWYgbm90IGdpdmVuIHdpbGwgZGVmYXVsdCB0byB0aGlzLmN1cnJlbnRMYXllci4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgVGlsZW1hcExheWVyIGluZGV4LgogICAgKi8KICAgIGdldExheWVyOiBmdW5jdGlvbiAobGF5ZXIpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBsYXllciA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICBsYXllciA9IHRoaXMuY3VycmVudExheWVyOwogICAgICAgIH0KICAgICAgICAvLyBlbHNlIGlmICh0eXBlb2YgbGF5ZXIgPT09ICdudW1iZXInKQogICAgICAgIC8vIHsKICAgICAgICAvLyAgICAgbGF5ZXIgPSBsYXllcjsKICAgICAgICAvLyB9CiAgICAgICAgZWxzZSBpZiAodHlwZW9mIGxheWVyID09PSAnc3RyaW5nJykKICAgICAgICB7CiAgICAgICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllckluZGV4KGxheWVyKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAobGF5ZXIgaW5zdGFuY2VvZiBQaGFzZXIuVGlsZW1hcExheWVyKQogICAgICAgIHsKICAgICAgICAgICAgbGF5ZXIgPSBsYXllci5pbmRleDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBsYXllcjsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBmdW5jdGlvbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNjYWxjdWxhdGVGYWNlcwogICAgKiBAcHJvdGVjdGVkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllciAtIFRoZSBpbmRleCBvZiB0aGUgVGlsZW1hcExheWVyIHRvIG9wZXJhdGUgb24uCiAgICAqLwogICAgY2FsY3VsYXRlRmFjZXM6IGZ1bmN0aW9uIChsYXllcikgewoKICAgICAgICB2YXIgYWJvdmUgPSBudWxsOwogICAgICAgIHZhciBiZWxvdyA9IG51bGw7CiAgICAgICAgdmFyIGxlZnQgPSBudWxsOwogICAgICAgIHZhciByaWdodCA9IG51bGw7CgogICAgICAgIGZvciAodmFyIHkgPSAwLCBoID0gdGhpcy5sYXllcnNbbGF5ZXJdLmhlaWdodDsgeSA8IGg7IHkrKykKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIHggPSAwLCB3ID0gdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoOyB4IDwgdzsgeCsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdGlsZSA9IHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3ldW3hdOwoKICAgICAgICAgICAgICAgIGlmICh0aWxlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGFib3ZlID0gdGhpcy5nZXRUaWxlQWJvdmUobGF5ZXIsIHgsIHkpOwogICAgICAgICAgICAgICAgICAgIGJlbG93ID0gdGhpcy5nZXRUaWxlQmVsb3cobGF5ZXIsIHgsIHkpOwogICAgICAgICAgICAgICAgICAgIGxlZnQgPSB0aGlzLmdldFRpbGVMZWZ0KGxheWVyLCB4LCB5KTsKICAgICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZ2V0VGlsZVJpZ2h0KGxheWVyLCB4LCB5KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGFib3ZlICYmIGFib3ZlLmNvbGxpZGVzKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIFRoZXJlIGlzIGEgdGlsZSBhYm92ZSB0aGlzIG9uZSB0aGF0IGFsc28gY29sbGlkZXMsIHNvIHRoZSB0b3Agb2YgdGhpcyB0aWxlIGlzIG5vIGxvbmdlciBpbnRlcmVzdGluZwogICAgICAgICAgICAgICAgICAgICAgICB0aWxlLmZhY2VUb3AgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChiZWxvdyAmJiBiZWxvdy5jb2xsaWRlcykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vICBUaGVyZSBpcyBhIHRpbGUgYmVsb3cgdGhpcyBvbmUgdGhhdCBhbHNvIGNvbGxpZGVzLCBzbyB0aGUgYm90dG9tIG9mIHRoaXMgdGlsZSBpcyBubyBsb25nZXIgaW50ZXJlc3RpbmcKICAgICAgICAgICAgICAgICAgICAgICAgdGlsZS5mYWNlQm90dG9tID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAobGVmdCAmJiBsZWZ0LmNvbGxpZGVzKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIFRoZXJlIGlzIGEgdGlsZSBsZWZ0IHRoaXMgb25lIHRoYXQgYWxzbyBjb2xsaWRlcywgc28gdGhlIGxlZnQgb2YgdGhpcyB0aWxlIGlzIG5vIGxvbmdlciBpbnRlcmVzdGluZwogICAgICAgICAgICAgICAgICAgICAgICB0aWxlLmZhY2VMZWZ0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAocmlnaHQgJiYgcmlnaHQuY29sbGlkZXMpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyAgVGhlcmUgaXMgYSB0aWxlIHJpZ2h0IHRoaXMgb25lIHRoYXQgYWxzbyBjb2xsaWRlcywgc28gdGhlIHJpZ2h0IG9mIHRoaXMgdGlsZSBpcyBubyBsb25nZXIgaW50ZXJlc3RpbmcKICAgICAgICAgICAgICAgICAgICAgICAgdGlsZS5mYWNlUmlnaHQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogR2V0cyB0aGUgdGlsZSBhYm92ZSB0aGUgdGlsZSBjb29yZGluYXRlcyBnaXZlbi4KICAgICogTW9zdGx5IHVzZWQgYXMgYW4gaW50ZXJuYWwgZnVuY3Rpb24gYnkgY2FsY3VsYXRlRmFjZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjZ2V0VGlsZUFib3ZlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllciAtIFRoZSBsb2NhbCBsYXllciBpbmRleCB0byBnZXQgdGhlIHRpbGUgZnJvbS4gQ2FuIGJlIGRldGVybWluZWQgYnkgVGlsZW1hcC5nZXRMYXllcigpLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgdG8gZ2V0IHRoZSB0aWxlIGZyb20uIEluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgdG8gZ2V0IHRoZSB0aWxlIGZyb20uIEluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKi8KICAgIGdldFRpbGVBYm92ZTogZnVuY3Rpb24gKGxheWVyLCB4LCB5KSB7CgogICAgICAgIGlmICh5ID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt5IC0gMV1beF07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXRzIHRoZSB0aWxlIGJlbG93IHRoZSB0aWxlIGNvb3JkaW5hdGVzIGdpdmVuLgogICAgKiBNb3N0bHkgdXNlZCBhcyBhbiBpbnRlcm5hbCBmdW5jdGlvbiBieSBjYWxjdWxhdGVGYWNlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNnZXRUaWxlQmVsb3cKICAgICogQHBhcmFtIHtudW1iZXJ9IGxheWVyIC0gVGhlIGxvY2FsIGxheWVyIGluZGV4IHRvIGdldCB0aGUgdGlsZSBmcm9tLiBDYW4gYmUgZGV0ZXJtaW5lZCBieSBUaWxlbWFwLmdldExheWVyKCkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSB0byBnZXQgdGhlIHRpbGUgZnJvbS4gSW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSB0byBnZXQgdGhlIHRpbGUgZnJvbS4gSW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqLwogICAgZ2V0VGlsZUJlbG93OiBmdW5jdGlvbiAobGF5ZXIsIHgsIHkpIHsKCiAgICAgICAgaWYgKHkgPCB0aGlzLmxheWVyc1tsYXllcl0uaGVpZ2h0IC0gMSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt5ICsgMV1beF07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXRzIHRoZSB0aWxlIHRvIHRoZSBsZWZ0IG9mIHRoZSB0aWxlIGNvb3JkaW5hdGVzIGdpdmVuLgogICAgKiBNb3N0bHkgdXNlZCBhcyBhbiBpbnRlcm5hbCBmdW5jdGlvbiBieSBjYWxjdWxhdGVGYWNlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNnZXRUaWxlTGVmdAogICAgKiBAcGFyYW0ge251bWJlcn0gbGF5ZXIgLSBUaGUgbG9jYWwgbGF5ZXIgaW5kZXggdG8gZ2V0IHRoZSB0aWxlIGZyb20uIENhbiBiZSBkZXRlcm1pbmVkIGJ5IFRpbGVtYXAuZ2V0TGF5ZXIoKS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIGdldCB0aGUgdGlsZSBmcm9tLiBJbiB0aWxlcywgbm90IHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIHRvIGdldCB0aGUgdGlsZSBmcm9tLiBJbiB0aWxlcywgbm90IHBpeGVscy4KICAgICovCiAgICBnZXRUaWxlTGVmdDogZnVuY3Rpb24gKGxheWVyLCB4LCB5KSB7CgogICAgICAgIGlmICh4ID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt5XVt4IC0gMV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXRzIHRoZSB0aWxlIHRvIHRoZSByaWdodCBvZiB0aGUgdGlsZSBjb29yZGluYXRlcyBnaXZlbi4KICAgICogTW9zdGx5IHVzZWQgYXMgYW4gaW50ZXJuYWwgZnVuY3Rpb24gYnkgY2FsY3VsYXRlRmFjZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjZ2V0VGlsZVJpZ2h0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllciAtIFRoZSBsb2NhbCBsYXllciBpbmRleCB0byBnZXQgdGhlIHRpbGUgZnJvbS4gQ2FuIGJlIGRldGVybWluZWQgYnkgVGlsZW1hcC5nZXRMYXllcigpLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgdG8gZ2V0IHRoZSB0aWxlIGZyb20uIEluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgdG8gZ2V0IHRoZSB0aWxlIGZyb20uIEluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKi8KICAgIGdldFRpbGVSaWdodDogZnVuY3Rpb24gKGxheWVyLCB4LCB5KSB7CgogICAgICAgIGlmICh4IDwgdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoIC0gMSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt5XVt4ICsgMV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBjdXJyZW50IGxheWVyIHRvIHRoZSBnaXZlbiBpbmRleC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNzZXRMYXllcgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gbGF5ZXIgLSBUaGUgbGF5ZXIgdG8gc2V0IGFzIGN1cnJlbnQuCiAgICAqLwogICAgc2V0TGF5ZXI6IGZ1bmN0aW9uIChsYXllcikgewoKICAgICAgICBsYXllciA9IHRoaXMuZ2V0TGF5ZXIobGF5ZXIpOwoKICAgICAgICBpZiAodGhpcy5sYXllcnNbbGF5ZXJdKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50TGF5ZXIgPSBsYXllcjsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUHV0cyBhIHRpbGUgb2YgdGhlIGdpdmVuIGluZGV4IHZhbHVlIGF0IHRoZSBjb29yZGluYXRlIHNwZWNpZmllZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNwdXRUaWxlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlRpbGV8bnVtYmVyfSB0aWxlIC0gVGhlIGluZGV4IG9mIHRoaXMgdGlsZSB0byBzZXQgb3IgYSBQaGFzZXIuVGlsZSBvYmplY3QuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiB0byBwbGFjZSB0aGUgdGlsZSAoZ2l2ZW4gaW4gdGlsZSB1bml0cywgbm90IHBpeGVscykKICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIHRvIHBsYWNlIHRoZSB0aWxlIChnaXZlbiBpbiB0aWxlIHVuaXRzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBtb2RpZnkuCiAgICAqLwogICAgcHV0VGlsZTogZnVuY3Rpb24gKHRpbGUsIHgsIHksIGxheWVyKSB7CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIGlmICh4ID49IDAgJiYgeCA8IHRoaXMubGF5ZXJzW2xheWVyXS53aWR0aCAmJiB5ID49IDAgJiYgeSA8IHRoaXMubGF5ZXJzW2xheWVyXS5oZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGlsZSBpbnN0YW5jZW9mIFBoYXNlci5UaWxlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt5XVt4XS5jb3B5KHRpbGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5sYXllcnNbbGF5ZXJdLmRhdGFbeV1beF0uaW5kZXggPSB0aWxlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmxheWVyc1tsYXllcl0uZGlydHkgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZUZhY2VzKGxheWVyKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUHV0cyBhIHRpbGUgaW50byB0aGUgVGlsZW1hcCBsYXllci4gVGhlIGNvb3JkaW5hdGVzIGFyZSBnaXZlbiBpbiBwaXhlbCB2YWx1ZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjcHV0VGlsZVdvcmxkWFkKICAgICogQHBhcmFtIHtQaGFzZXIuVGlsZXxudW1iZXJ9IHRpbGUgLSBUaGUgaW5kZXggb2YgdGhpcyB0aWxlIHRvIHNldCBvciBhIFBoYXNlci5UaWxlIG9iamVjdC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIHRvIGluc2VydCB0aGUgdGlsZSAoZ2l2ZW4gaW4gcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gdG8gaW5zZXJ0IHRoZSB0aWxlIChnaXZlbiBpbiBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlV2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIHRpbGUgaW4gcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZUhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIHRpbGUgaW4gcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBtb2RpZnkuCiAgICAqLwogICAgcHV0VGlsZVdvcmxkWFk6IGZ1bmN0aW9uICh0aWxlLCB4LCB5LCB0aWxlV2lkdGgsIHRpbGVIZWlnaHQsIGxheWVyKSB7CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIHggPSB0aGlzLmdhbWUubWF0aC5zbmFwVG9GbG9vcih4LCB0aWxlV2lkdGgpIC8gdGlsZVdpZHRoOwogICAgICAgIHkgPSB0aGlzLmdhbWUubWF0aC5zbmFwVG9GbG9vcih5LCB0aWxlSGVpZ2h0KSAvIHRpbGVIZWlnaHQ7CgogICAgICAgIHRoaXMucHV0VGlsZSh0aWxlLCB4LCB5LCBsYXllcik7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0cyBhIHRpbGUgZnJvbSB0aGUgVGlsZW1hcCBMYXllci4gVGhlIGNvb3JkaW5hdGVzIGFyZSBnaXZlbiBpbiB0aWxlIHZhbHVlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNnZXRUaWxlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiB0byBnZXQgdGhlIHRpbGUgZnJvbSAoZ2l2ZW4gaW4gdGlsZSB1bml0cywgbm90IHBpeGVscykKICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIHRvIGdldCB0aGUgdGlsZSBmcm9tIChnaXZlbiBpbiB0aWxlIHVuaXRzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBnZXQgdGhlIHRpbGUgZnJvbS4KICAgICogQHJldHVybiB7UGhhc2VyLlRpbGV9IFRoZSB0aWxlIGF0IHRoZSBnaXZlbiBjb29yZGluYXRlcy4KICAgICovCiAgICBnZXRUaWxlOiBmdW5jdGlvbiAoeCwgeSwgbGF5ZXIpIHsKCiAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVyKTsKCiAgICAgICAgaWYgKHggPj0gMCAmJiB4IDwgdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoICYmIHkgPj0gMCAmJiB5IDwgdGhpcy5sYXllcnNbbGF5ZXJdLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt5XVt4XTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogR2V0cyBhIHRpbGUgZnJvbSB0aGUgVGlsZW1hcCBsYXllci4gVGhlIGNvb3JkaW5hdGVzIGFyZSBnaXZlbiBpbiBwaXhlbCB2YWx1ZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjZ2V0VGlsZVdvcmxkWFkKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIHRvIGdldCB0aGUgdGlsZSBmcm9tIChnaXZlbiBpbiBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiB0byBnZXQgdGhlIHRpbGUgZnJvbSAoZ2l2ZW4gaW4gcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBnZXQgdGhlIHRpbGUgZnJvbS4KICAgICogQHJldHVybiB7UGhhc2VyLlRpbGV9IFRoZSB0aWxlIGF0IHRoZSBnaXZlbiBjb29yZGluYXRlcy4KICAgICovCiAgICBnZXRUaWxlV29ybGRYWTogZnVuY3Rpb24gKHgsIHksIHRpbGVXaWR0aCwgdGlsZUhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVyKTsKCiAgICAgICAgeCA9IHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHgsIHRpbGVXaWR0aCkgLyB0aWxlV2lkdGg7CiAgICAgICAgeSA9IHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHksIHRpbGVIZWlnaHQpIC8gdGlsZUhlaWdodDsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VGlsZSh4LCB5LCBsYXllcik7CgogICAgfSwKCiAgICAvKioKICAgICogQ29waWVzIGFsbCBvZiB0aGUgdGlsZXMgaW4gdGhlIGdpdmVuIHJlY3Rhbmd1bGFyIGJsb2NrIGludG8gdGhlIHRpbGVtYXAgZGF0YSBidWZmZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjY29weQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIGNvcHkgKGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIGNvcHkgKGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIGFyZWEgdG8gY29weSAoZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBhcmVhIHRvIGNvcHkgKGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBjb3B5IHRoZSB0aWxlcyBmcm9tLgogICAgKiBAcmV0dXJuIHthcnJheX0gQW4gYXJyYXkgb2YgdGhlIHRpbGVzIHRoYXQgd2VyZSBjb3BpZWQuCiAgICAqLwogICAgY29weTogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKSB7CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIGlmICghdGhpcy5sYXllcnNbbGF5ZXJdKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcmVzdWx0cy5sZW5ndGggPSAwOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHggPT09ICJ1bmRlZmluZWQiKSB7IHggPSAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB5ID09PSAidW5kZWZpbmVkIikgeyB5ID0gMDsgfQogICAgICAgIGlmICh0eXBlb2Ygd2lkdGggPT09ICJ1bmRlZmluZWQiKSB7IHdpZHRoID0gdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoOyB9CiAgICAgICAgaWYgKHR5cGVvZiBoZWlnaHQgPT09ICJ1bmRlZmluZWQiKSB7IGhlaWdodCA9IHRoaXMubGF5ZXJzW2xheWVyXS5oZWlnaHQ7IH0KCiAgICAgICAgaWYgKHggPCAwKQogICAgICAgIHsKICAgICAgICAgICAgeCA9IDA7CiAgICAgICAgfQoKICAgICAgICBpZiAoeSA8IDApCiAgICAgICAgewogICAgICAgICAgICB5ID0gMDsKICAgICAgICB9CgogICAgICAgIGlmICh3aWR0aCA+IHRoaXMubGF5ZXJzW2xheWVyXS53aWR0aCkKICAgICAgICB7CiAgICAgICAgICAgIHdpZHRoID0gdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKGhlaWdodCA+IHRoaXMubGF5ZXJzW2xheWVyXS5oZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICBoZWlnaHQgPSB0aGlzLmxheWVyc1tsYXllcl0uaGVpZ2h0OwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fcmVzdWx0cy5sZW5ndGggPSAwOwoKICAgICAgICB0aGlzLl9yZXN1bHRzLnB1c2goIHsgeDogeCwgeTogeSwgd2lkdGg6IHdpZHRoLCBoZWlnaHQ6IGhlaWdodCwgbGF5ZXI6IGxheWVyIH0pOwoKICAgICAgICBmb3IgKHZhciB0eSA9IHk7IHR5IDwgeSArIGhlaWdodDsgdHkrKykKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIHR4ID0geDsgdHggPCB4ICsgd2lkdGg7IHR4KyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHMucHVzaCh0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt0eV1bdHhdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuX3Jlc3VsdHM7CgogICAgfSwKCiAgICAvKioKICAgICogUGFzdGVzIGEgcHJldmlvdXNseSBjb3BpZWQgYmxvY2sgb2YgdGlsZSBkYXRhIGludG8gdGhlIGdpdmVuIHgveSBjb29yZGluYXRlcy4gRGF0YSBzaG91bGQgaGF2ZSBiZWVuIHByZXBhcmVkIHdpdGggVGlsZW1hcC5jb3B5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI3Bhc3RlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgb2YgdGhlIGFyZWEgdG8gcGFzdGUgdG8gKGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIHBhc3RlIHRvIChnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscykKICAgICogQHBhcmFtIHthcnJheX0gdGlsZWJsb2NrIC0gVGhlIGJsb2NrIG9mIHRpbGVzIHRvIHBhc3RlLgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBwYXN0ZSB0aGUgdGlsZXMgaW50by4KICAgICovCiAgICBwYXN0ZTogZnVuY3Rpb24gKHgsIHksIHRpbGVibG9jaywgbGF5ZXIpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB4ID09PSAidW5kZWZpbmVkIikgeyB4ID0gMDsgfQogICAgICAgIGlmICh0eXBlb2YgeSA9PT0gInVuZGVmaW5lZCIpIHsgeSA9IDA7IH0KICAgICAgICAKICAgICAgICBsYXllciA9IHRoaXMuZ2V0TGF5ZXIobGF5ZXIpOwoKICAgICAgICBpZiAoIXRpbGVibG9jayB8fCB0aWxlYmxvY2subGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vICBGaW5kIG91dCB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIHRpbGVibG9ja1sxXS54L3kgYW5kIHgveSBhbmQgdXNlIGl0IGFzIGFuIG9mZnNldCwgYXMgaXQncyB0aGUgdG9wIGxlZnQgb2YgdGhlIGJsb2NrIHRvIHBhc3RlCiAgICAgICAgdmFyIGRpZmZYID0geCAtIHRpbGVibG9ja1sxXS54OwogICAgICAgIHZhciBkaWZmWSA9IHkgLSB0aWxlYmxvY2tbMV0ueTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCB0aWxlYmxvY2subGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVsgZGlmZlkgKyB0aWxlYmxvY2tbaV0ueSBdWyBkaWZmWCArIHRpbGVibG9ja1tpXS54IF0uY29weSh0aWxlYmxvY2tbaV0pOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5sYXllcnNbbGF5ZXJdLmRpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNhbGN1bGF0ZUZhY2VzKGxheWVyKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTY2FucyB0aGUgZ2l2ZW4gYXJlYSBmb3IgdGlsZXMgd2l0aCBhbiBpbmRleCBtYXRjaGluZyB0aWxlQSBhbmQgc3dhcHMgdGhlbSB3aXRoIHRpbGVCLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI3N3YXBUaWxlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlQSAtIEZpcnN0IHRpbGUgaW5kZXguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlQiAtIFNlY29uZCB0aWxlIGluZGV4LgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb25lLCBnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uZSwgZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBpbiB0aWxlcyBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBpbiB0aWxlcyBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uLgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBvcGVyYXRlIG9uLgogICAgKi8KICAgIHN3YXA6IGZ1bmN0aW9uICh0aWxlQSwgdGlsZUIsIHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKSB7CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIHRoaXMuY29weSh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcik7CgogICAgICAgIGlmICh0aGlzLl9yZXN1bHRzLmxlbmd0aCA8IDIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLl90ZW1wQSA9IHRpbGVBOwogICAgICAgIHRoaXMuX3RlbXBCID0gdGlsZUI7CgogICAgICAgIHRoaXMuX3Jlc3VsdHMuZm9yRWFjaCh0aGlzLnN3YXBIYW5kbGVyLCB0aGlzKTsKCiAgICAgICAgdGhpcy5wYXN0ZSh4LCB5LCB0aGlzLl9yZXN1bHRzLCBsYXllcik7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIHRoZSBzd2FwcGluZyBvZiB0aWxlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNzd2FwSGFuZGxlcgogICAgKiBAcHJpdmF0ZQogICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4CiAgICAqLwogICAgc3dhcEhhbmRsZXI6IGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgpIHsKCiAgICAgICAgaWYgKHZhbHVlLmluZGV4ID09PSB0aGlzLl90ZW1wQSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHNbaW5kZXhdLmluZGV4ID0gdGhpcy5fdGVtcEI7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHZhbHVlLmluZGV4ID09PSB0aGlzLl90ZW1wQikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHNbaW5kZXhdLmluZGV4ID0gdGhpcy5fdGVtcEE7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEZvciBlYWNoIHRpbGUgaW4gdGhlIGdpdmVuIGFyZWEgZGVmaW5lZCBieSB4L3kgYW5kIHdpZHRoL2hlaWdodCBydW4gdGhlIGdpdmVuIGNhbGxiYWNrLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI2ZvckVhY2gKICAgICogQHBhcmFtIHtudW1iZXJ9IGNhbGxiYWNrIC0gVGhlIGNhbGxiYWNrLiBFYWNoIHRpbGUgaW4gdGhlIGdpdmVuIGFyZWEgd2lsbCBiZSBwYXNzZWQgdG8gdGhpcyBjYWxsYmFjayBhcyB0aGUgZmlyc3QgYW5kIG9ubHkgcGFyYW1ldGVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gY29udGV4dCAtIFRoZSBjb250ZXh0IHVuZGVyIHdoaWNoIHRoZSBjYWxsYmFjayBzaG91bGQgYmUgcnVuLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb25lLCBnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uZSwgZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBpbiB0aWxlcyBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBpbiB0aWxlcyBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uLgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBvcGVyYXRlIG9uLgogICAgKi8KICAgIGZvckVhY2g6IGZ1bmN0aW9uIChjYWxsYmFjaywgY29udGV4dCwgeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVyKTsKCiAgICAgICAgdGhpcy5jb3B5KHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKTsKCiAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHMubGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3Jlc3VsdHMuZm9yRWFjaChjYWxsYmFjaywgY29udGV4dCk7CgogICAgICAgIHRoaXMucGFzdGUoeCwgeSwgdGhpcy5fcmVzdWx0cywgbGF5ZXIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNjYW5zIHRoZSBnaXZlbiBhcmVhIGZvciB0aWxlcyB3aXRoIGFuIGluZGV4IG1hdGNoaW5nIGBzb3VyY2VgIGFuZCB1cGRhdGVzIHRoZWlyIGluZGV4IHRvIG1hdGNoIGBkZXN0YC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNyZXBsYWNlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzb3VyY2UgLSBUaGUgdGlsZSBpbmRleCB2YWx1ZSB0byBzY2FuIGZvci4KICAgICogQHBhcmFtIHtudW1iZXJ9IGRlc3QgLSBUaGUgdGlsZSBpbmRleCB2YWx1ZSB0byByZXBsYWNlIGZvdW5kIHRpbGVzIHdpdGguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbmUsIGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb25lLCBnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIGluIHRpbGVzIG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IGluIHRpbGVzIG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIG9wZXJhdGUgb24uCiAgICAqLwogICAgcmVwbGFjZTogZnVuY3Rpb24gKHNvdXJjZSwgZGVzdCwgeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVyKTsKCiAgICAgICAgdGhpcy5jb3B5KHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKTsKCiAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHMubGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdGhpcy5fcmVzdWx0cy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9yZXN1bHRzW2ldLmluZGV4ID09PSBzb3VyY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHNbaV0uaW5kZXggPSBkZXN0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnBhc3RlKHgsIHksIHRoaXMuX3Jlc3VsdHMsIGxheWVyKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSYW5kb21pc2VzIGEgc2V0IG9mIHRpbGVzIGluIGEgZ2l2ZW4gYXJlYS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNyYW5kb20KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uZSwgZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbmUsIGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggaW4gdGlsZXMgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgaW4gdGlsZXMgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbi4KICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfFBoYXNlci5UaWxlbWFwTGF5ZXJ9IFtsYXllcl0gLSBUaGUgbGF5ZXIgdG8gb3BlcmF0ZSBvbi4KICAgICovCiAgICByYW5kb206IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcikgewoKICAgICAgICBsYXllciA9IHRoaXMuZ2V0TGF5ZXIobGF5ZXIpOwoKICAgICAgICB0aGlzLmNvcHkoeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpOwoKICAgICAgICBpZiAodGhpcy5fcmVzdWx0cy5sZW5ndGggPCAyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGluZGV4ZXMgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgdCA9IDE7IHQgPCB0aGlzLl9yZXN1bHRzLmxlbmd0aDsgdCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHNbdF0uaW5kZXgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBpZHggPSB0aGlzLl9yZXN1bHRzW3RdLmluZGV4OwoKICAgICAgICAgICAgICAgIGlmIChpbmRleGVzLmluZGV4T2YoaWR4KSA9PT0gLTEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXhlcy5wdXNoKGlkeCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdGhpcy5fcmVzdWx0cy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHNbaV0uaW5kZXggPSB0aGlzLmdhbWUucm5kLnBpY2soaW5kZXhlcyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnBhc3RlKHgsIHksIHRoaXMuX3Jlc3VsdHMsIGxheWVyKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTaHVmZmxlcyBhIHNldCBvZiB0aWxlcyBpbiBhIGdpdmVuIGFyZWEuIEl0IHdpbGwgb25seSByYW5kb21pc2UgdGhlIHRpbGVzIGluIHRoYXQgYXJlYSwgc28gaWYgdGhleSdyZSBhbGwgdGhlIHNhbWUgbm90aGluZyB3aWxsIGFwcGVhciB0byBoYXZlIGNoYW5nZWQhCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjc2h1ZmZsZQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb25lLCBnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uZSwgZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBpbiB0aWxlcyBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBpbiB0aWxlcyBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uLgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBvcGVyYXRlIG9uLgogICAgKi8KICAgIHNodWZmbGU6IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcikgewoKICAgICAgICBsYXllciA9IHRoaXMuZ2V0TGF5ZXIobGF5ZXIpOwoKICAgICAgICB0aGlzLmNvcHkoeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpOwoKICAgICAgICBpZiAodGhpcy5fcmVzdWx0cy5sZW5ndGggPCAyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGluZGV4ZXMgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgdCA9IDE7IHQgPCB0aGlzLl9yZXN1bHRzLmxlbmd0aDsgdCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHNbdF0uaW5kZXgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGluZGV4ZXMucHVzaCh0aGlzLl9yZXN1bHRzW3RdLmluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgUGhhc2VyLlV0aWxzLnNodWZmbGUoaW5kZXhlcyk7CgogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdGhpcy5fcmVzdWx0cy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHNbaV0uaW5kZXggPSBpbmRleGVzW2kgLSAxXTsKICAgICAgICB9CgogICAgICAgIHRoaXMucGFzdGUoeCwgeSwgdGhpcy5fcmVzdWx0cywgbGF5ZXIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEZpbGxzIHRoZSBnaXZlbiBhcmVhIHdpdGggdGhlIHNwZWNpZmllZCB0aWxlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI2ZpbGwKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoZSB0aWxlIHRoYXQgdGhlIGFyZWEgd2lsbCBiZSBmaWxsZWQgd2l0aC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uZSwgZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbmUsIGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggaW4gdGlsZXMgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgaW4gdGlsZXMgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbi4KICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfFBoYXNlci5UaWxlbWFwTGF5ZXJ9IFtsYXllcl0gLSBUaGUgbGF5ZXIgdG8gb3BlcmF0ZSBvbi4KICAgICovCiAgICBmaWxsOiBmdW5jdGlvbiAoaW5kZXgsIHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKSB7CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIHRoaXMuY29weSh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcik7CgogICAgICAgIGlmICh0aGlzLl9yZXN1bHRzLmxlbmd0aCA8IDIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRoaXMuX3Jlc3VsdHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9yZXN1bHRzW2ldLmluZGV4ID0gaW5kZXg7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnBhc3RlKHgsIHksIHRoaXMuX3Jlc3VsdHMsIGxheWVyKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGFsbCBsYXllcnMgZnJvbSB0aGlzIHRpbGUgbWFwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI3JlbW92ZUFsbExheWVycwogICAgKi8KICAgIHJlbW92ZUFsbExheWVyczogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmxheWVycy5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuY3VycmVudExheWVyID0gMDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBEdW1wcyB0aGUgdGlsZW1hcCBkYXRhIG91dCB0byB0aGUgY29uc29sZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNkdW1wCiAgICAqLwogICAgZHVtcDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgdHh0ID0gJyc7CiAgICAgICAgdmFyIGFyZ3MgPSBbJyddOwoKICAgICAgICBmb3IgKHZhciB5ID0gMDsgeSA8IHRoaXMubGF5ZXJzW3RoaXMuY3VycmVudExheWVyXS5oZWlnaHQ7IHkrKykKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5sYXllcnNbdGhpcy5jdXJyZW50TGF5ZXJdLndpZHRoOyB4KyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHR4dCArPSAiJWMgICI7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubGF5ZXJzW3RoaXMuY3VycmVudExheWVyXS5kYXRhW3ldW3hdID4gMSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWJ1Z01hcFt0aGlzLmxheWVyc1t0aGlzLmN1cnJlbnRMYXllcl0uZGF0YVt5XVt4XV0pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goImJhY2tncm91bmQ6ICIgKyB0aGlzLmRlYnVnTWFwW3RoaXMubGF5ZXJzW3RoaXMuY3VycmVudExheWVyXS5kYXRhW3ldW3hdXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCgiYmFja2dyb3VuZDogI2ZmZmZmZiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goImJhY2tncm91bmQ6IHJnYigwLCAwLCAwKSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0eHQgKz0gIlxuIjsKICAgICAgICB9CgogICAgICAgIGFyZ3NbMF0gPSB0eHQ7CiAgICAgICAgY29uc29sZS5sb2cuYXBwbHkoY29uc29sZSwgYXJncyk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlcyBhbGwgbGF5ZXJzIGZyb20gdGhpcyB0aWxlIG1hcCBhbmQgbnVsbHMgdGhlIGdhbWUgcmVmZXJlbmNlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMucmVtb3ZlQWxsTGF5ZXJzKCk7CiAgICAgICAgdGhpcy5kYXRhID0gW107CiAgICAgICAgdGhpcy5nYW1lID0gbnVsbDsKCiAgICB9Cgp9OwoKUGhhc2VyLlRpbGVtYXAucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlRpbGVtYXA7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIFRpbGVtYXAgTGF5ZXIgaXMgYSBzZXQgb2YgbWFwIGRhdGEgY29tYmluZWQgd2l0aCBhIFRpbGVzZXQgaW4gb3JkZXIgdG8gcmVuZGVyIHRoYXQgZGF0YSB0byB0aGUgZ2FtZS4KKgoqIEBjbGFzcyBQaGFzZXIuVGlsZW1hcExheWVyCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEdhbWUgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7UGhhc2VyLlRpbGVtYXB9IHRpbGVtYXAgLSBUaGUgdGlsZW1hcCB0byB3aGljaCB0aGlzIGxheWVyIGJlbG9uZ3MuCiogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGxheWVyIGluZGV4IHdpdGhpbiB0aGUgbWFwIHRoYXQgdGhpcyBUaWxlbWFwTGF5ZXIgcmVwcmVzZW50cy4KKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBXaWR0aCBvZiB0aGUgcmVuZGVyYWJsZSBhcmVhIG9mIHRoZSBsYXllci4KKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gSGVpZ2h0IG9mIHRoZSByZW5kZXJhYmxlIGFyZWEgb2YgdGhlIGxheWVyLgoqLwpQaGFzZXIuVGlsZW1hcExheWVyID0gZnVuY3Rpb24gKGdhbWUsIHRpbGVtYXAsIGluZGV4LCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5UaWxlbWFwfSBtYXAgLSBUaGUgVGlsZW1hcCB0byB3aGljaCB0aGlzIGxheWVyIGlzIGJvdW5kLgogICAgKi8KICAgIHRoaXMubWFwID0gdGlsZW1hcDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoaXMgbGF5ZXIgd2l0aGluIHRoZSBUaWxlbWFwLgogICAgKi8KICAgIHRoaXMuaW5kZXggPSBpbmRleDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IGxheWVyIC0gVGhlIGxheWVyIG9iamVjdCB3aXRoaW4gdGhlIFRpbGVtYXAgdGhhdCB0aGlzIGxheWVyIHJlcHJlc2VudHMuCiAgICAqLwogICAgdGhpcy5sYXllciA9IHRpbGVtYXAubGF5ZXJzW2luZGV4XTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gVGhlIGNhbnZhcyB0byB3aGljaCB0aGlzIFRpbGVtYXBMYXllciBkcmF3cy4KICAgICovCiAgICB0aGlzLmNhbnZhcyA9IFBoYXNlci5DYW52YXMuY3JlYXRlKHdpZHRoLCBoZWlnaHQpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHQgLSBUaGUgMmQgY29udGV4dCBvZiB0aGUgY2FudmFzLgogICAgKi8KICAgIHRoaXMuY29udGV4dCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJyk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BJWEkuQmFzZVRleHR1cmV9IGJhc2VUZXh0dXJlIC0gUmVxdWlyZWQgUGl4aSB2YXIuCiAgICAqLwogICAgdGhpcy5iYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKHRoaXMuY2FudmFzKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UElYSS5UZXh0dXJlfSB0ZXh0dXJlIC0gUmVxdWlyZWQgUGl4aSB2YXIuCiAgICAqLwogICAgdGhpcy50ZXh0dXJlID0gbmV3IFBJWEkuVGV4dHVyZSh0aGlzLmJhc2VUZXh0dXJlKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkZyYW1lfSB0ZXh0dXJlRnJhbWUgLSBEaW1lbnNpb25zIG9mIHRoZSByZW5kZXJhYmxlIGFyZWEuCiAgICAqLwogICAgdGhpcy50ZXh0dXJlRnJhbWUgPSBuZXcgUGhhc2VyLkZyYW1lKDAsIDAsIDAsIHdpZHRoLCBoZWlnaHQsICd0aWxlbWFwTGF5ZXInLCBnYW1lLnJuZC51dWlkKCkpOwoKICAgIFBoYXNlci5TcHJpdGUuY2FsbCh0aGlzLCB0aGlzLmdhbWUsIDAsIDAsIHRoaXMudGV4dHVyZSwgdGhpcy50ZXh0dXJlRnJhbWUpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBsYXllci4KICAgICovCiAgICB0aGlzLm5hbWUgPSAnJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBUaGUgY29uc3QgdHlwZSBvZiB0aGlzIG9iamVjdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuVElMRU1BUExBWUVSOwoKICAgIC8qKgogICAgKiBBbiBvYmplY3QgdGhhdCBpcyBmaXhlZCB0byB0aGUgY2FtZXJhIGlnbm9yZXMgdGhlIHBvc2l0aW9uIG9mIGFueSBhbmNlc3RvcnMgaW4gdGhlIGRpc3BsYXkgbGlzdCBhbmQgdXNlcyBpdHMgeC95IGNvb3JkaW5hdGVzIGFzIG9mZnNldHMgZnJvbSB0aGUgdG9wIGxlZnQgb2YgdGhlIGNhbWVyYS4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBmaXhlZFRvQ2FtZXJhIC0gRml4ZXMgdGhpcyBvYmplY3QgdG8gdGhlIENhbWVyYS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZpeGVkVG9DYW1lcmEgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gY2FtZXJhT2Zmc2V0IC0gSWYgdGhpcyBvYmplY3QgaXMgZml4ZWQgdG8gdGhlIGNhbWVyYSB0aGVuIHVzZSB0aGlzIFBvaW50IHRvIHNwZWNpZnkgaG93IGZhciBhd2F5IGZyb20gdGhlIENhbWVyYSB4L3kgaXQncyByZW5kZXJlZC4KICAgICovCiAgICB0aGlzLmNhbWVyYU9mZnNldCA9IG5ldyBQaGFzZXIuUG9pbnQoMCwgMCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB0aWxlQ29sb3IgLSBJZiBubyB0aWxlc2V0IGlzIGdpdmVuIHRoZSB0aWxlcyB3aWxsIGJlIHJlbmRlcmVkIGFzIHJlY3RhbmdsZXMgaW4gdGhpcyBjb2xvci4gUHJvdmlkZSBpbiBoZXggb3IgcmdiL3JnYmEgc3RyaW5nIGZvcm1hdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRpbGVDb2xvciA9ICdyZ2IoMjU1LCAyNTUsIDI1NSknOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRlYnVnIC0gSWYgc2V0IHRvIHRydWUgdGhlIGNvbGxpZGVhYmxlIHRpbGUgZWRnZXMgcGF0aCB3aWxsIGJlIHJlbmRlcmVkLiBPbmx5IHdvcmtzIHdoZW4gZ2FtZSBpcyBydW5uaW5nIGluIFBoYXNlci5DQU5WQVMgbW9kZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmRlYnVnID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkZWJ1Z0FscGhhIC0gSWYgZGVidWcgaXMgdHJ1ZSB0aGVuIHRoZSB0aWxlc2V0IGlzIHJlbmRlcmVkIHdpdGggdGhpcyBhbHBoYSBsZXZlbCwgdG8gbWFrZSB0aGUgdGlsZSBlZGdlcyBjbGVhcmVyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGVidWdBbHBoYSA9IDAuNTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGRlYnVnQ29sb3IgLSBJZiBkZWJ1ZyBpcyB0cnVlIHRoaXMgaXMgdGhlIGNvbG9yIHVzZWQgdG8gb3V0bGluZSB0aGUgZWRnZXMgb2YgY29sbGlkYWJsZSB0aWxlcy4gUHJvdmlkZSBpbiBoZXggb3IgcmdiL3JnYmEgc3RyaW5nIGZvcm1hdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmRlYnVnQ29sb3IgPSAncmdiYSgwLCAyNTUsIDAsIDEpJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBkZWJ1Z0ZpbGwgLSBJZiB0cnVlIHRoZSBkZWJ1ZyB0aWxlcyBhcmUgZmlsbGVkIHdpdGggZGVidWdGaWxsQ29sb3IgQU5EIHN0cm9rZWQgYXJvdW5kLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGVidWdGaWxsID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBkZWJ1Z0ZpbGxDb2xvciAtIElmIGRlYnVnRmlsbCBpcyB0cnVlIHRoaXMgaXMgdGhlIGNvbG9yIHVzZWQgdG8gZmlsbCB0aGUgdGlsZXMuIFByb3ZpZGUgaW4gaGV4IG9yIHJnYi9yZ2JhIHN0cmluZyBmb3JtYXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kZWJ1Z0ZpbGxDb2xvciA9ICdyZ2JhKDAsIDI1NSwgMCwgMC4yKSc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBkZWJ1Z0NhbGxiYWNrQ29sb3IgLSBJZiBkZWJ1ZyBpcyB0cnVlIHRoaXMgaXMgdGhlIGNvbG9yIHVzZWQgdG8gb3V0bGluZSB0aGUgZWRnZXMgb2YgdGlsZXMgdGhhdCBoYXZlIGNvbGxpc2lvbiBjYWxsYmFja3MuIFByb3ZpZGUgaW4gaGV4IG9yIHJnYi9yZ2JhIHN0cmluZyBmb3JtYXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kZWJ1Z0NhbGxiYWNrQ29sb3IgPSAncmdiYSgyNTUsIDAsIDAsIDEpJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNjcm9sbEZhY3RvclggLSBzcGVlZCBhdCB3aGljaCB0aGlzIGxheWVyIHNjcm9sbHMKICAgICogaG9yaXpvbnRhbGx5LCByZWxhdGl2ZSB0byB0aGUgY2FtZXJhIChlLmcuIHNjcm9sbEZhY3Rvclggb2YgMC41IHNjcm9sbHMKICAgICogaGFsZiBhcyBxdWlja2x5IGFzIHRoZSAnbm9ybWFsJyBjYW1lcmEtbG9ja2VkIGxheWVycyBkbykKICAgICogQGRlZmF1bHQgMQogICAgKi8KICAgIHRoaXMuc2Nyb2xsRmFjdG9yWCA9IDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzY3JvbGxGYWN0b3JZIC0gc3BlZWQgYXQgd2hpY2ggdGhpcyBsYXllciBzY3JvbGxzCiAgICAqIHZlcnRpY2FsbHksIHJlbGF0aXZlIHRvIHRoZSBjYW1lcmEgKGUuZy4gc2Nyb2xsRmFjdG9yWSBvZiAwLjUgc2Nyb2xscwogICAgKiBoYWxmIGFzIHF1aWNrbHkgYXMgdGhlICdub3JtYWwnIGNhbWVyYS1sb2NrZWQgbGF5ZXJzIGRvKQogICAgKiBAZGVmYXVsdCAxCiAgICAqLwogICAgdGhpcy5zY3JvbGxGYWN0b3JZID0gMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBkaXJ0eSAtIEZsYWcgY29udHJvbGxpbmcgd2hlbiB0byByZS1yZW5kZXIgdGhlIGxheWVyLgogICAgKi8KICAgIHRoaXMuZGlydHkgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2N3IC0gTG9jYWwgY29sbGlzaW9uIHZhci4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fY3cgPSB0aWxlbWFwLnRpbGVXaWR0aDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9jaCAtIExvY2FsIGNvbGxpc2lvbiB2YXIuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX2NoID0gdGlsZW1hcC50aWxlSGVpZ2h0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2dhIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9nYSA9IDE7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R4IC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9keCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R5IC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9keSA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R3IC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9kdyA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2RoIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9kaCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3R4IC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl90eCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3R5IC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl90eSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdHcgLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX3R3ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF90aCAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fdGggPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF90bCAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fdGwgPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9tYXhYIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9tYXhYID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfbWF4WSAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fbWF4WSA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3N0YXJ0WCAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fc3RhcnRYID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfc3RhcnRZIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9zdGFydFkgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBfcmVzdWx0cyAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fcmVzdWx0cyA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3ggLSBQcml2YXRlIHZhci4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5feCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfeSAtIFByaXZhdGUgdmFyLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl95ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9wcmV2WCAtIFByaXZhdGUgdmFyLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9wcmV2WCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfcHJldlkgLSBQcml2YXRlIHZhci4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fcHJldlkgPSAwOwoKICAgIHRoaXMudXBkYXRlTWF4KCk7Cgp9OwoKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBoYXNlci5TcHJpdGUucHJvdG90eXBlKTsKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUgPSBQaGFzZXIuVXRpbHMuZXh0ZW5kKHRydWUsIFBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLCBQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgUElYSS5TcHJpdGUucHJvdG90eXBlKTsKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuVGlsZW1hcExheWVyOwoKLyoqCiogQXV0b21hdGljYWxseSBjYWxsZWQgYnkgV29ybGQucG9zdFVwZGF0ZS4gSGFuZGxlcyBjYWNoZSB1cGRhdGVzLgoqCiogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcExheWVyI3Bvc3RVcGRhdGUKKiBAbWVtYmVyb2YgUGhhc2VyLlRpbGVtYXBMYXllcgoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5wb3N0VXBkYXRlID0gZnVuY3Rpb24gKCkgewoKCVBoYXNlci5TcHJpdGUucHJvdG90eXBlLnBvc3RVcGRhdGUuY2FsbCh0aGlzKTsKCQogICAgLy8gIFN0b3BzIHlvdSBiZWluZyBhYmxlIHRvIGF1dG8tc2Nyb2xsIHRoZSBjYW1lcmEgaWYgaXQncyBub3QgZm9sbG93aW5nIGEgc3ByaXRlCiAgICB0aGlzLnNjcm9sbFggPSB0aGlzLmdhbWUuY2FtZXJhLnggKiB0aGlzLnNjcm9sbEZhY3Rvclg7CiAgICB0aGlzLnNjcm9sbFkgPSB0aGlzLmdhbWUuY2FtZXJhLnkgKiB0aGlzLnNjcm9sbEZhY3Rvclk7CgogICAgdGhpcy5yZW5kZXIoKTsKCn0KCi8qKgoqIFNldHMgdGhlIHdvcmxkIHNpemUgdG8gbWF0Y2ggdGhlIHNpemUgb2YgdGhpcyBsYXllci4KKgoqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXBMYXllciNyZXNpemVXb3JsZAoqIEBtZW1iZXJvZiBQaGFzZXIuVGlsZW1hcExheWVyCiovClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLnJlc2l6ZVdvcmxkID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuZ2FtZS53b3JsZC5zZXRCb3VuZHMoMCwgMCwgdGhpcy5sYXllci53aWR0aEluUGl4ZWxzLCB0aGlzLmxheWVyLmhlaWdodEluUGl4ZWxzKTsKCn0KCi8qKgoqIFRha2UgYW4geCBjb29yZGluYXRlIHRoYXQgZG9lc24ndCBhY2NvdW50IGZvciBzY3JvbGxGYWN0b3JYIGFuZCAnZml4JyBpdCAKKiBpbnRvIGEgc2Nyb2xsZWQgbG9jYWwgc3BhY2UuIFVzZWQgcHJpbWFyaWx5IGludGVybmFsbHkKKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwTGF5ZXIjX2ZpeFgKKiBAbWVtYmVyb2YgUGhhc2VyLlRpbGVtYXBMYXllcgoqIEBwcml2YXRlCiogQHBhcmFtIHtudW1iZXJ9IHggLSB4IGNvb3JkaW5hdGUgaW4gY2FtZXJhIHNwYWNlCiogQHJldHVybiB7bnVtYmVyfSB4IGNvb3JkaW5hdGUgaW4gc2Nyb2xsRmFjdG9yLWFkanVzdGVkIGRpbWVuc2lvbnMKKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuX2ZpeFggPSBmdW5jdGlvbih4KSB7CgogICAgaWYgKHggPCAwKQogICAgewogICAgICAgIHggPSAwOwogICAgfQoKICAgIGlmICh0aGlzLnNjcm9sbEZhY3RvclggPT09IDEpCiAgICB7CiAgICAgICAgcmV0dXJuIHg7CiAgICB9CgogICAgcmV0dXJuIHRoaXMuX3ggKyAoeCAtICh0aGlzLl94IC8gdGhpcy5zY3JvbGxGYWN0b3JYKSk7Cgp9CgovKioKKiBUYWtlIGFuIHggY29vcmRpbmF0ZSB0aGF0IF9kb2VzXyBhY2NvdW50IGZvciBzY3JvbGxGYWN0b3JYIGFuZCAndW5maXgnIGl0IAoqIGJhY2sgdG8gY2FtZXJhIHNwYWNlLiBVc2VkIHByaW1hcmlseSBpbnRlcm5hbGx5CiogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcExheWVyI191bmZpeFgKKiBAbWVtYmVyb2YgUGhhc2VyLlRpbGVtYXBMYXllcgoqIEBwcml2YXRlCiogQHBhcmFtIHtudW1iZXJ9IHggLSB4IGNvb3JkaW5hdGUgaW4gc2Nyb2xsRmFjdG9yLWFkanVzdGVkIGRpbWVuc2lvbnMKKiBAcmV0dXJuIHtudW1iZXJ9IHggY29vcmRpbmF0ZSBpbiBjYW1lcmEgc3BhY2UKKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuX3VuZml4WCA9IGZ1bmN0aW9uKHgpIHsKCiAgICBpZiAodGhpcy5zY3JvbGxGYWN0b3JYID09PSAxKQogICAgewogICAgICAgIHJldHVybiB4OwogICAgfQoKICAgIHJldHVybiAodGhpcy5feCAvIHRoaXMuc2Nyb2xsRmFjdG9yWCkgKyAoeCAtIHRoaXMuX3gpOwoKfQoKLyoqCiogVGFrZSBhIHkgY29vcmRpbmF0ZSB0aGF0IGRvZXNuJ3QgYWNjb3VudCBmb3Igc2Nyb2xsRmFjdG9yWSBhbmQgJ2ZpeCcgaXQgCiogaW50byBhIHNjcm9sbGVkIGxvY2FsIHNwYWNlLiBVc2VkIHByaW1hcmlseSBpbnRlcm5hbGx5CiogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcExheWVyI19maXhZCiogQG1lbWJlcm9mIFBoYXNlci5UaWxlbWFwTGF5ZXIKKiBAcHJpdmF0ZQoqIEBwYXJhbSB7bnVtYmVyfSB5IC0geSBjb29yZGluYXRlIGluIGNhbWVyYSBzcGFjZQoqIEByZXR1cm4ge251bWJlcn0geSBjb29yZGluYXRlIGluIHNjcm9sbEZhY3Rvci1hZGp1c3RlZCBkaW1lbnNpb25zCiovClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLl9maXhZID0gZnVuY3Rpb24oeSkgewoKICAgIGlmICh5IDwgMCkKICAgIHsKICAgICAgICB5ID0gMDsKICAgIH0KCiAgICBpZiAodGhpcy5zY3JvbGxGYWN0b3JZID09PSAxKQogICAgewogICAgICAgIHJldHVybiB5OwogICAgfQoKICAgIHJldHVybiB0aGlzLl95ICsgKHkgLSAodGhpcy5feSAvIHRoaXMuc2Nyb2xsRmFjdG9yWSkpOwoKfQoKLyoqCiogVGFrZSBhIHkgY29vcmRpbmF0ZSB0aGF0IF9kb2VzXyBhY2NvdW50IGZvciBzY3JvbGxGYWN0b3JZIGFuZCAndW5maXgnIGl0IAoqIGJhY2sgdG8gY2FtZXJhIHNwYWNlLiBVc2VkIHByaW1hcmlseSBpbnRlcm5hbGx5CiogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcExheWVyI191bmZpeFkKKiBAbWVtYmVyb2YgUGhhc2VyLlRpbGVtYXBMYXllcgoqIEBwcml2YXRlCiogQHBhcmFtIHtudW1iZXJ9IHkgLSB5IGNvb3JkaW5hdGUgaW4gc2Nyb2xsRmFjdG9yLWFkanVzdGVkIGRpbWVuc2lvbnMKKiBAcmV0dXJuIHtudW1iZXJ9IHkgY29vcmRpbmF0ZSBpbiBjYW1lcmEgc3BhY2UKKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuX3VuZml4WSA9IGZ1bmN0aW9uKHkpIHsKCiAgICBpZiAodGhpcy5zY3JvbGxGYWN0b3JZID09PSAxKQogICAgewogICAgICAgIHJldHVybiB5OwogICAgfQoKICAgIHJldHVybiAodGhpcy5feSAvIHRoaXMuc2Nyb2xsRmFjdG9yWSkgKyAoeSAtIHRoaXMuX3kpOwoKfQoKLyoqCiogQ29udmVydCBhIHBpeGVsIHZhbHVlIHRvIGEgdGlsZSBjb29yZGluYXRlLgoqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXBMYXllciNnZXRUaWxlWAoqIEBtZW1iZXJvZiBQaGFzZXIuVGlsZW1hcExheWVyCiogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBwb2ludCBpbiB0YXJnZXQgdGlsZS4KKiBAcmV0dXJuIHtQaGFzZXIuVGlsZX0gVGhlIHRpbGUgd2l0aCBzcGVjaWZpYyBwcm9wZXJ0aWVzLgoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5nZXRUaWxlWCA9IGZ1bmN0aW9uICh4KSB7CgogICAgLy8gdmFyIHRpbGVXaWR0aCA9IHRoaXMudGlsZVdpZHRoICogdGhpcy5zY2FsZS54OwoKICAgIHJldHVybiB0aGlzLmdhbWUubWF0aC5zbmFwVG9GbG9vcih0aGlzLl9maXhYKHgpLCB0aGlzLm1hcC50aWxlV2lkdGgpIC8gdGhpcy5tYXAudGlsZVdpZHRoOwoKfQoKLyoqCiogQ29udmVydCBhIHBpeGVsIHZhbHVlIHRvIGEgdGlsZSBjb29yZGluYXRlLgoqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXBMYXllciNnZXRUaWxlWQoqIEBtZW1iZXJvZiBQaGFzZXIuVGlsZW1hcExheWVyCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBwb2ludCBpbiB0YXJnZXQgdGlsZS4KKiBAcmV0dXJuIHtQaGFzZXIuVGlsZX0gVGhlIHRpbGUgd2l0aCBzcGVjaWZpYyBwcm9wZXJ0aWVzLgoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5nZXRUaWxlWSA9IGZ1bmN0aW9uICh5KSB7CgogICAgLy8gdmFyIHRpbGVIZWlnaHQgPSB0aGlzLnRpbGVIZWlnaHQgKiB0aGlzLnNjYWxlLnk7CgogICAgcmV0dXJuIHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHRoaXMuX2ZpeFkoeSksIHRoaXMubWFwLnRpbGVIZWlnaHQpIC8gdGhpcy5tYXAudGlsZUhlaWdodDsKCn0KCi8qKgoqIENvbnZlcnQgYSBwaXhlbCB2YWx1ZSB0byBhIHRpbGUgY29vcmRpbmF0ZS4KKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwTGF5ZXIjZ2V0VGlsZVhZCiogQG1lbWJlcm9mIFBoYXNlci5UaWxlbWFwTGF5ZXIKKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIHBvaW50IGluIHRhcmdldCB0aWxlLgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgcG9pbnQgaW4gdGFyZ2V0IHRpbGUuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR8b2JqZWN0fSBwb2ludCAtIFRoZSBQb2ludCBvYmplY3QgdG8gc2V0IHRoZSB4IGFuZCB5IHZhbHVlcyBvbi4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR8b2JqZWN0fSBBIFBvaW50IG9iamVjdCB3aXRoIGl0cyB4IGFuZCB5IHByb3BlcnRpZXMgc2V0LgoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5nZXRUaWxlWFkgPSBmdW5jdGlvbiAoeCwgeSwgcG9pbnQpIHsKCiAgICBwb2ludC54ID0gdGhpcy5nZXRUaWxlWCh4KTsKICAgIHBvaW50LnkgPSB0aGlzLmdldFRpbGVZKHkpOwoKICAgIHJldHVybiBwb2ludDsKCn0KCi8qKgoqIEdldCBhbGwgdGlsZXMgdGhhdCBleGlzdCB3aXRoaW4gdGhlIGdpdmVuIGFyZWEsIGRlZmluZWQgYnkgdGhlIHRvcC1sZWZ0IGNvcm5lciwgd2lkdGggYW5kIGhlaWdodC4gVmFsdWVzIGdpdmVuIGFyZSBpbiBwaXhlbHMsIG5vdCB0aWxlcy4KKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwTGF5ZXIjZ2V0VGlsZXMKKiBAbWVtYmVyb2YgUGhhc2VyLlRpbGVtYXBMYXllcgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgY29ybmVyLgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgY29ybmVyLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFdpZHRoIG9mIHRoZSBhcmVhIHRvIGdldC4KKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gSGVpZ2h0IG9mIHRoZSBhcmVhIHRvIGdldC4KKiBAcGFyYW0ge2Jvb2xlYW59IFtjb2xsaWRlcz1mYWxzZV0gLSBJZiB0cnVlIG9ubHkgcmV0dXJuIHRpbGVzIHRoYXQgY29sbGlkZSBvbiBvbmUgb3IgbW9yZSBmYWNlcy4KKiBAcmV0dXJuIHthcnJheX0gQXJyYXkgd2l0aCB0aWxlcyBpbmZvcm1hdGlvbnMgKGVhY2ggY29udGFpbnMgeCwgeSwgYW5kIHRoZSB0aWxlKS4KKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuZ2V0VGlsZXMgPSBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCwgY29sbGlkZXMpIHsKCiAgICAvLyAgU2hvdWxkIHdlIG9ubHkgZ2V0IHRpbGVzIHRoYXQgaGF2ZSBhdCBsZWFzdCBvbmUgb2YgdGhlaXIgY29sbGlzaW9uIGZsYWdzIHNldD8gKHRydWUgPSB5ZXMsIGZhbHNlID0gbm8ganVzdCBnZXQgdGhlbSBhbGwpCiAgICBpZiAodHlwZW9mIGNvbGxpZGVzID09PSAndW5kZWZpbmVkJykgeyBjb2xsaWRlcyA9IGZhbHNlOyB9CgogICAgLy8gYWRqdXN0IHRoZSB4LHkgY29vcmRpbmF0ZXMgZm9yIHNjcm9sbEZhY3RvcgogICAgeCA9IHRoaXMuX2ZpeFgoeCk7CiAgICB5ID0gdGhpcy5fZml4WSh5KTsKCiAgICBpZiAod2lkdGggPiB0aGlzLmxheWVyLndpZHRoSW5QaXhlbHMpCiAgICB7CiAgICAgICAgd2lkdGggPSB0aGlzLmxheWVyLndpZHRoSW5QaXhlbHM7CiAgICB9CgogICAgaWYgKGhlaWdodCA+IHRoaXMubGF5ZXIuaGVpZ2h0SW5QaXhlbHMpCiAgICB7CiAgICAgICAgaGVpZ2h0ID0gdGhpcy5sYXllci5oZWlnaHRJblBpeGVsczsKICAgIH0KCiAgICAvLyAgQ29udmVydCB0aGUgcGl4ZWwgdmFsdWVzIGludG8gdGlsZSBjb29yZGluYXRlcwogICAgdGhpcy5fdHggPSB0aGlzLmdhbWUubWF0aC5zbmFwVG9GbG9vcih4LCB0aGlzLl9jdykgLyB0aGlzLl9jdzsKICAgIHRoaXMuX3R5ID0gdGhpcy5nYW1lLm1hdGguc25hcFRvRmxvb3IoeSwgdGhpcy5fY2gpIC8gdGhpcy5fY2g7CiAgICB0aGlzLl90dyA9ICh0aGlzLmdhbWUubWF0aC5zbmFwVG9DZWlsKHdpZHRoLCB0aGlzLl9jdykgKyB0aGlzLl9jdykgLyB0aGlzLl9jdzsKICAgIHRoaXMuX3RoID0gKHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0NlaWwoaGVpZ2h0LCB0aGlzLl9jaCkgKyB0aGlzLl9jaCkgLyB0aGlzLl9jaDsKCiAgICAvLyAgVGhpcyBzaG91bGQgYXBwbHkgdGhlIGxheWVyIHgveSBoZXJlCiAgICB0aGlzLl9yZXN1bHRzLmxlbmd0aCA9IDA7CgogICAgZm9yICh2YXIgd3kgPSB0aGlzLl90eTsgd3kgPCB0aGlzLl90eSArIHRoaXMuX3RoOyB3eSsrKQogICAgewogICAgICAgIGZvciAodmFyIHd4ID0gdGhpcy5fdHg7IHd4IDwgdGhpcy5fdHggKyB0aGlzLl90dzsgd3grKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmxheWVyLmRhdGFbd3ldICYmIHRoaXMubGF5ZXIuZGF0YVt3eV1bd3hdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY29sbGlkZXMgPT09IGZhbHNlIHx8IChjb2xsaWRlcyAmJiB0aGlzLmxheWVyLmRhdGFbd3ldW3d4XS5jYW5Db2xsaWRlKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyAgQ29udmVydCB0aWxlIGNvb3JkaW5hdGVzIGJhY2sgdG8gY2FtZXJhIHNwYWNlIGZvciByZXR1cm4KICAgICAgICAgICAgICAgICAgICB2YXIgX3d4ID0gdGhpcy5fdW5maXhYKHd4ICogdGhpcy5fY3cpIC8gdGhpcy5fY3c7CiAgICAgICAgICAgICAgICAgICAgdmFyIF93eSA9IHRoaXMuX3VuZml4WSh3eSAqIHRoaXMuX2NoKSAvIHRoaXMuX2NoOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXN1bHRzLnB1c2goeyAKICAgICAgICAgICAgICAgICAgICAgICAgeDogX3d4ICogdGhpcy5fY3csIAogICAgICAgICAgICAgICAgICAgICAgICB5OiBfd3kgKiB0aGlzLl9jaCwgCiAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAoX3d4ICogdGhpcy5fY3cpICsgdGhpcy5fY3csIAogICAgICAgICAgICAgICAgICAgICAgICBib3R0b206IChfd3kgKiB0aGlzLl9jaCkgKyB0aGlzLl9jaCwgCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbGU6IHRoaXMubGF5ZXIuZGF0YVt3eV1bd3hdLAogICAgICAgICAgICAgICAgICAgICAgICBsYXllcjogdGhpcy5sYXllci5kYXRhW3d5XVt3eF0ubGF5ZXIKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpcy5fcmVzdWx0czsKCn0KCi8qKgoqIEludGVybmFsIGZ1bmN0aW9uIHRvIHVwZGF0ZSBtYXhpbXVtIHZhbHVlcy4KKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwTGF5ZXIjdXBkYXRlTWF4CiogQG1lbWJlcm9mIFBoYXNlci5UaWxlbWFwTGF5ZXIKKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUudXBkYXRlTWF4ID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuX21heFggPSB0aGlzLmdhbWUubWF0aC5jZWlsKHRoaXMuY2FudmFzLndpZHRoIC8gdGhpcy5tYXAudGlsZVdpZHRoKSArIDE7CiAgICB0aGlzLl9tYXhZID0gdGhpcy5nYW1lLm1hdGguY2VpbCh0aGlzLmNhbnZhcy5oZWlnaHQgLyB0aGlzLm1hcC50aWxlSGVpZ2h0KSArIDE7CgogICAgaWYgKHRoaXMubGF5ZXIpCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX21heFggPiB0aGlzLmxheWVyLndpZHRoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fbWF4WCA9IHRoaXMubGF5ZXIud2lkdGg7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fbWF4WSA+IHRoaXMubGF5ZXIuaGVpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fbWF4WSA9IHRoaXMubGF5ZXIuaGVpZ2h0OwogICAgICAgIH0KICAgIH0KCiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKCn0KCi8qKgoqIFJlbmRlcnMgdGhlIHRpbGVzIHRvIHRoZSBsYXllciBjYW52YXMgYW5kIHB1c2hlcyB0byB0aGUgZGlzcGxheS4KKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwTGF5ZXIjcmVuZGVyCiogQG1lbWJlcm9mIFBoYXNlci5UaWxlbWFwTGF5ZXIKKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24gKCkgewoKCWlmICh0aGlzLmxheWVyLmRpcnR5KQogICAgewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgfQoKICAgIGlmICghdGhpcy5kaXJ0eSB8fCAhdGhpcy52aXNpYmxlKQogICAgewogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLl9wcmV2WCA9IHRoaXMuX2R4OwogICAgdGhpcy5fcHJldlkgPSB0aGlzLl9keTsKCiAgICB0aGlzLl9keCA9IC0odGhpcy5feCAtICh0aGlzLl9zdGFydFggKiB0aGlzLm1hcC50aWxlV2lkdGgpKTsKICAgIHRoaXMuX2R5ID0gLSh0aGlzLl95IC0gKHRoaXMuX3N0YXJ0WSAqIHRoaXMubWFwLnRpbGVIZWlnaHQpKTsKCiAgICB0aGlzLl90eCA9IHRoaXMuX2R4OwogICAgdGhpcy5fdHkgPSB0aGlzLl9keTsKCiAgICB0aGlzLmNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHRoaXMuY2FudmFzLndpZHRoLCB0aGlzLmNhbnZhcy5oZWlnaHQpOwoKICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSB0aGlzLnRpbGVDb2xvcjsKCiAgICB2YXIgdGlsZTsKICAgIHZhciBzZXQ7CiAgICB2YXIgb3ggPSAwOwogICAgdmFyIG95ID0gMDsKCiAgICBpZiAodGhpcy5kZWJ1ZykKICAgIHsKICAgICAgICB0aGlzLmNvbnRleHQuZ2xvYmFsQWxwaGEgPSB0aGlzLmRlYnVnQWxwaGE7CiAgICB9CgogICAgZm9yICh2YXIgeSA9IHRoaXMuX3N0YXJ0WSwgbGVuWSA9IHRoaXMuX3N0YXJ0WSArIHRoaXMuX21heFk7IHkgPCBsZW5ZOyB5KyspCiAgICB7CiAgICAgICAgdGhpcy5fY29sdW1uID0gdGhpcy5sYXllci5kYXRhW3ldOwoKICAgICAgICBmb3IgKHZhciB4ID0gdGhpcy5fc3RhcnRYLCBsZW5YID0gdGhpcy5fc3RhcnRYICsgdGhpcy5fbWF4WDsgeCA8IGxlblg7IHgrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9jb2x1bW5beF0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRpbGUgPSB0aGlzLl9jb2x1bW5beF07CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubWFwLnRpbGVzW3RpbGUuaW5kZXhdKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHNldCA9IHRoaXMubWFwLnRpbGVzZXRzW3RoaXMubWFwLnRpbGVzW3RpbGUuaW5kZXhdWzJdXQoKICAgICAgICAgICAgICAgICAgICBpZiAoc2V0LmltYWdlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVidWcgPT09IGZhbHNlICYmIHRpbGUuYWxwaGEgIT09IHRoaXMuY29udGV4dC5nbG9iYWxBbHBoYSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0Lmdsb2JhbEFscGhhID0gdGlsZS5hbHBoYTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNldC50aWxlV2lkdGggIT09IHRoaXMubWFwLnRpbGVXaWR0aCB8fCBzZXQudGlsZUhlaWdodCAhPT0gdGhpcy5tYXAudGlsZUhlaWdodCkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gIFRPRE86IFNtYWxsZXIgc2l6ZWQgdGlsZSBjaGVjawogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmRyYXdJbWFnZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcC50aWxlc2V0c1t0aGlzLm1hcC50aWxlc1t0aWxlLmluZGV4XVsyXV0uaW1hZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXAudGlsZXNbdGlsZS5pbmRleF1bMF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXAudGlsZXNbdGlsZS5pbmRleF1bMV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0LnRpbGVXaWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXQudGlsZUhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKHRoaXMuX3R4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKHRoaXMuX3R5KSAtIChzZXQudGlsZUhlaWdodCAtIHRoaXMubWFwLnRpbGVIZWlnaHQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldC50aWxlV2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0LnRpbGVIZWlnaHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZHJhd0ltYWdlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFwLnRpbGVzZXRzW3RoaXMubWFwLnRpbGVzW3RpbGUuaW5kZXhdWzJdXS5pbWFnZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcC50aWxlc1t0aWxlLmluZGV4XVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcC50aWxlc1t0aWxlLmluZGV4XVsxXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcC50aWxlV2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXAudGlsZUhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKHRoaXMuX3R4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKHRoaXMuX3R5KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcC50aWxlV2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXAudGlsZUhlaWdodAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRpbGUuZGVidWcpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSAncmdiYSgwLCAyNTUsIDAsIDAuNCknOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KE1hdGguZmxvb3IodGhpcy5fdHgpLCBNYXRoLmZsb29yKHRoaXMuX3R5KSwgdGhpcy5tYXAudGlsZVdpZHRoLCB0aGlzLm1hcC50aWxlSGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFJlY3QoTWF0aC5mbG9vcih0aGlzLl90eCksIE1hdGguZmxvb3IodGhpcy5fdHkpLCB0aGlzLm1hcC50aWxlV2lkdGgsIHRoaXMubWFwLnRpbGVIZWlnaHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdHggKz0gdGhpcy5tYXAudGlsZVdpZHRoOwoKICAgICAgICB9CgogICAgICAgIHRoaXMuX3R4ID0gdGhpcy5fZHg7CiAgICAgICAgdGhpcy5fdHkgKz0gdGhpcy5tYXAudGlsZUhlaWdodDsKCiAgICB9CgogICAgaWYgKHRoaXMuZGVidWcpCiAgICB7CiAgICAgICAgdGhpcy5jb250ZXh0Lmdsb2JhbEFscGhhID0gMTsKICAgICAgICB0aGlzLnJlbmRlckRlYnVnKCk7CiAgICB9CgogICAgLy8gIE9ubHkgbmVlZGVkIGlmIHJ1bm5pbmcgaW4gV2ViR0wsIG90aGVyd2lzZSB0aGlzIGFycmF5IHdpbGwgbmV2ZXIgZ2V0IGNsZWFyZWQgZG93biBJIGRvbid0IHRoaW5rIQogICAgaWYgKHRoaXMuZ2FtZS5yZW5kZXJUeXBlID09PSBQaGFzZXIuV0VCR0wpCiAgICB7CiAgICAgICAgUElYSS50ZXh0dXJlc1RvVXBkYXRlLnB1c2godGhpcy5iYXNlVGV4dHVyZSk7CiAgICB9CgogICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgdGhpcy5sYXllci5kaXJ0eSA9IGZhbHNlOwoKICAgIHJldHVybiB0cnVlOwoKfQoKLyoqCiogUmVuZGVycyBhIGNvbGxpc2lvbiBkZWJ1ZyBvdmVybGF5IG9uLXRvcCBvZiB0aGUgY2FudmFzLiBDYWxsZWQgYXV0b21hdGljYWxseSBieSByZW5kZXIgd2hlbiBkZWJ1ZyA9IHRydWUuCiogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcExheWVyI3JlbmRlckRlYnVnCiogQG1lbWJlcm9mIFBoYXNlci5UaWxlbWFwTGF5ZXIKKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUucmVuZGVyRGVidWcgPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5fdHggPSB0aGlzLl9keDsKICAgIHRoaXMuX3R5ID0gdGhpcy5fZHk7CgogICAgdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gdGhpcy5kZWJ1Z0NvbG9yOwogICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IHRoaXMuZGVidWdGaWxsQ29sb3I7CgogICAgZm9yICh2YXIgeSA9IHRoaXMuX3N0YXJ0WSwgbGVuWSA9IHRoaXMuX3N0YXJ0WSArIHRoaXMuX21heFk7IHkgPCBsZW5ZOyB5KyspCiAgICB7CiAgICAgICAgdGhpcy5fY29sdW1uID0gdGhpcy5sYXllci5kYXRhW3ldOwoKICAgICAgICBmb3IgKHZhciB4ID0gdGhpcy5fc3RhcnRYLCBsZW5YID0gdGhpcy5fc3RhcnRYICsgdGhpcy5fbWF4WDsgeCA8IGxlblg7IHgrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0aWxlID0gdGhpcy5fY29sdW1uW3hdOwoKICAgICAgICAgICAgaWYgKHRpbGUgJiYgKHRpbGUuZmFjZVRvcCB8fCB0aWxlLmZhY2VCb3R0b20gfHwgdGlsZS5mYWNlTGVmdCB8fCB0aWxlLmZhY2VSaWdodCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3R4ID0gTWF0aC5mbG9vcih0aGlzLl90eCk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVidWdGaWxsKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsUmVjdCh0aGlzLl90eCwgdGhpcy5fdHksIHRoaXMuX2N3LCB0aGlzLl9jaCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpOwoKICAgICAgICAgICAgICAgIGlmICh0aWxlLmZhY2VUb3ApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0Lm1vdmVUbyh0aGlzLl90eCwgdGhpcy5fdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5saW5lVG8odGhpcy5fdHggKyB0aGlzLl9jdywgdGhpcy5fdHkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aWxlLmZhY2VCb3R0b20pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0Lm1vdmVUbyh0aGlzLl90eCwgdGhpcy5fdHkgKyB0aGlzLl9jaCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVUbyh0aGlzLl90eCArIHRoaXMuX2N3LCB0aGlzLl90eSArIHRoaXMuX2NoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGlsZS5mYWNlTGVmdCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQubW92ZVRvKHRoaXMuX3R4LCB0aGlzLl90eSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVUbyh0aGlzLl90eCwgdGhpcy5fdHkgKyB0aGlzLl9jaCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRpbGUuZmFjZVJpZ2h0KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5tb3ZlVG8odGhpcy5fdHggKyB0aGlzLl9jdywgdGhpcy5fdHkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5saW5lVG8odGhpcy5fdHggKyB0aGlzLl9jdywgdGhpcy5fdHkgKyB0aGlzLl9jaCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAgQ29sbGlzaW9uIGNhbGxiYWNrCiAgICAgICAgICAgIGlmICh0aWxlICYmICh0aWxlLmNvbGxpc2lvbkNhbGxiYWNrIHx8IHRpbGUubGF5ZXIuY2FsbGJhY2tzW3RpbGUuaW5kZXhdKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IHRoaXMuZGVidWdDYWxsYmFja0NvbG9yOwogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHRoaXMuX3R4LCB0aGlzLl90eSwgdGhpcy5fY3csIHRoaXMuX2NoKTsKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSB0aGlzLmRlYnVnRmlsbENvbG9yOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl90eCArPSB0aGlzLm1hcC50aWxlV2lkdGg7CgogICAgICAgIH0KCiAgICAgICAgdGhpcy5fdHggPSB0aGlzLl9keDsKICAgICAgICB0aGlzLl90eSArPSB0aGlzLm1hcC50aWxlSGVpZ2h0OwoKICAgIH0KCn0KCi8qKgoqIEBuYW1lIFBoYXNlci5UaWxlbWFwTGF5ZXIjc2Nyb2xsWAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzY3JvbGxYIC0gU2Nyb2xscyB0aGUgbWFwIGhvcml6b250YWxseSBvciByZXR1cm5zIHRoZSBjdXJyZW50IHggcG9zaXRpb24uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZSwgInNjcm9sbFgiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl94OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICAvLyBpZiAodmFsdWUgIT09IHRoaXMuX3ggJiYgdmFsdWUgPj0gMCAmJiB0aGlzLmxheWVyICYmIHRoaXMubGF5ZXIud2lkdGhJblBpeGVscyA+IHRoaXMud2lkdGgpCiAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLl94ICYmIHZhbHVlID49IDAgJiYgdGhpcy5sYXllci53aWR0aEluUGl4ZWxzID4gdGhpcy53aWR0aCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3ggPSB2YWx1ZTsKICAgIAogICAgICAgICAgICBpZiAodGhpcy5feCA+ICh0aGlzLmxheWVyLndpZHRoSW5QaXhlbHMgLSB0aGlzLndpZHRoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5feCA9IHRoaXMubGF5ZXIud2lkdGhJblBpeGVscyAtIHRoaXMud2lkdGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3N0YXJ0WCA9IHRoaXMuZ2FtZS5tYXRoLmZsb29yKHRoaXMuX3ggLyB0aGlzLm1hcC50aWxlV2lkdGgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXJ0WCA8IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0WCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLl9zdGFydFggKyB0aGlzLl9tYXhYID4gdGhpcy5sYXllci53aWR0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhcnRYID0gdGhpcy5sYXllci53aWR0aCAtIHRoaXMuX21heFg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5UaWxlbWFwTGF5ZXIjc2Nyb2xsWQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzY3JvbGxZIC0gU2Nyb2xscyB0aGUgbWFwIHZlcnRpY2FsbHkgb3IgcmV0dXJucyB0aGUgY3VycmVudCB5IHBvc2l0aW9uLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUsICJzY3JvbGxZIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5feTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgLy8gaWYgKHZhbHVlICE9PSB0aGlzLl95ICYmIHZhbHVlID49IDAgJiYgdGhpcy5sYXllciAmJiB0aGlzLmhlaWdodEluUGl4ZWxzID4gdGhpcy5yZW5kZXJIZWlnaHQpCiAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLl95ICYmIHZhbHVlID49IDAgJiYgdGhpcy5sYXllci5oZWlnaHRJblBpeGVscyA+IHRoaXMuaGVpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5feSA9IHZhbHVlOwoKICAgICAgICAgICAgaWYgKHRoaXMuX3kgPiAodGhpcy5sYXllci5oZWlnaHRJblBpeGVscyAtIHRoaXMuaGVpZ2h0KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5feSA9IHRoaXMubGF5ZXIuaGVpZ2h0SW5QaXhlbHMgLSB0aGlzLmhlaWdodDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fc3RhcnRZID0gdGhpcy5nYW1lLm1hdGguZmxvb3IodGhpcy5feSAvIHRoaXMubWFwLnRpbGVIZWlnaHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXJ0WSA8IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0WSA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLl9zdGFydFkgKyB0aGlzLl9tYXhZID4gdGhpcy5sYXllci5oZWlnaHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0WSA9IHRoaXMubGF5ZXIuaGVpZ2h0IC0gdGhpcy5fbWF4WTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IHRydWU7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbGVtYXBMYXllciNjb2xsaXNpb25XaWR0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjb2xsaXNpb25XaWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgY29sbGlzaW9uIHRpbGVzLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUsICJjb2xsaXNpb25XaWR0aCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2N3OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICB0aGlzLl9jdyA9IHZhbHVlOwoKICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5UaWxlbWFwTGF5ZXIjY29sbGlzaW9uSGVpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IGNvbGxpc2lvbkhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIGNvbGxpc2lvbiB0aWxlcy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLCAiY29sbGlzaW9uSGVpZ2h0IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY2g7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHRoaXMuX2NoID0gdmFsdWU7CgogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwoKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLlRpbGVtYXBQYXJzZXIgcGFyc2VzIGRhdGEgb2JqZWN0cyBmcm9tIFBoYXNlci5Mb2FkZXIgdGhhdCBuZWVkIG1vcmUgcHJlcGFyYXRpb24gYmVmb3JlIHRoZXkgY2FuIGJlIGluc2VydGVkIGludG8gYSBUaWxlbWFwLgoqCiogQGNsYXNzIFBoYXNlci5UaWxlbWFwUGFyc2VyCiovClBoYXNlci5UaWxlbWFwUGFyc2VyID0gewoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgVGlsZXNldCBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXBQYXJzZXIudGlsZXNldAogICAgKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gR2FtZSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgQ2FjaGUga2V5IG9mIHRoaXMgdGlsZXNldC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbGVXaWR0aCAtIFdpZHRoIG9mIGVhY2ggc2luZ2xlIHRpbGUgaW4gcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZUhlaWdodCAtIEhlaWdodCBvZiBlYWNoIHNpbmdsZSB0aWxlIGluIHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt0aWxlTWFyZ2luPTBdIC0gSWYgdGhlIHRpbGVzIGhhdmUgYmVlbiBkcmF3biB3aXRoIGEgbWFyZ2luLCBzcGVjaWZ5IHRoZSBhbW91bnQgaGVyZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt0aWxlU3BhY2luZz0wXSAtIElmIHRoZSB0aWxlcyBoYXZlIGJlZW4gZHJhd24gd2l0aCBzcGFjaW5nIGJldHdlZW4gdGhlbSwgc3BlY2lmeSB0aGUgYW1vdW50IGhlcmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcm93cz0tMV0gLSBIb3cgbWFueSB0aWxlcyBhcmUgcGxhY2VkIGhvcml6b250YWxseSBpbiBlYWNoIHJvdz8gSWYgLTEgaXQgd2lsbCBjYWxjdWxhdGUgcm93cyBieSBkaXZpZGluZyB0aGUgaW1hZ2Ugd2lkdGggYnkgdGlsZVdpZHRoLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2NvbHVtbnM9LTFdIC0gSG93IG1hbnkgdGlsZXMgYXJlIHBsYWNlZCB2ZXJ0aWNhbGx5IGluIGVhY2ggY29sdW1uPyBJZiAtMSBpdCB3aWxsIGNhbGN1bGF0ZSBjb2x1bW5zIGJ5IGRpdmlkaW5nIHRoZSBpbWFnZSBoZWlnaHQgYnkgdGlsZUhlaWdodC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt0b3RhbD0tMV0gLSBUaGUgbWF4aW11bSBudW1iZXIgb2YgdGlsZXMgdG8gZXh0cmFjdCBmcm9tIHRoZSBpbWFnZS4gSWYgLTEgaXQgd2lsbCBleHRyYWN0IGByb3dzICogY29sdW1uc2Agd29ydGguIFlvdSBjYW4gYWxzbyBzZXQgYSB2YWx1ZSBsb3dlciB0aGFuIHRoZSBhY3R1YWwgbnVtYmVyIG9mIHRpbGVzLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGlsZXNldH0gR2VuZXJhdGVkIFRpbGVzZXQgb2JqZWN0LgogICAgKi8KICAgIHRpbGVzZXQ6IGZ1bmN0aW9uIChnYW1lLCBrZXksIHRpbGVXaWR0aCwgdGlsZUhlaWdodCwgdGlsZU1hcmdpbiwgdGlsZVNwYWNpbmcsIHJvd3MsIGNvbHVtbnMsIHRvdGFsKSB7CgogICAgICAgIC8vICBIb3cgYmlnIGlzIG91ciBpbWFnZT8KICAgICAgICB2YXIgaW1nID0gZ2FtZS5jYWNoZS5nZXRUaWxlc2V0SW1hZ2Uoa2V5KTsKCiAgICAgICAgaWYgKGltZyA9PT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiUGhhc2VyLlRpbGVtYXBQYXJzZXIudGlsZVNldDogSW52YWxpZCBpbWFnZSBrZXkgZ2l2ZW4iKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICB2YXIgd2lkdGggPSBpbWcud2lkdGg7CiAgICAgICAgdmFyIGhlaWdodCA9IGltZy5oZWlnaHQ7CgogICAgICAgIGlmIChyb3dzID09PSAtMSkKICAgICAgICB7CiAgICAgICAgICAgIHJvd3MgPSBNYXRoLnJvdW5kKHdpZHRoIC8gdGlsZVdpZHRoKTsKICAgICAgICB9CgogICAgICAgIGlmIChjb2x1bW5zID09PSAtMSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbHVtbnMgPSBNYXRoLnJvdW5kKGhlaWdodCAvIHRpbGVIZWlnaHQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRvdGFsID09PSAtMSkKICAgICAgICB7CiAgICAgICAgICAgIHRvdGFsID0gcm93cyAqIGNvbHVtbnM7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vICBaZXJvIG9yIHNtYWxsZXIgdGhhbiB0aWxlIHNpemVzPwogICAgICAgIGlmICh3aWR0aCA9PT0gMCB8fCBoZWlnaHQgPT09IDAgfHwgd2lkdGggPCB0aWxlV2lkdGggfHwgaGVpZ2h0IDwgdGlsZUhlaWdodCB8fCB0b3RhbCA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiUGhhc2VyLlRpbGVtYXBQYXJzZXIudGlsZVNldDogd2lkdGgvaGVpZ2h0IHplcm8gb3Igd2lkdGgvaGVpZ2h0IDwgZ2l2ZW4gdGlsZVdpZHRoL3RpbGVIZWlnaHQiKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbmV3IFBoYXNlci5UaWxlc2V0KGltZywga2V5LCB0aWxlV2lkdGgsIHRpbGVIZWlnaHQsIHRpbGVNYXJnaW4sIHRpbGVTcGFjaW5nLCByb3dzLCBjb2x1bW5zLCB0b3RhbCk7CgogICAgfSwKCiAgICAvKioKICAgICogUGFyc2UgdGlsZXNldCBkYXRhIGZyb20gdGhlIGNhY2hlIGFuZCBjcmVhdGVzIGEgVGlsZXNldCBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXBQYXJzZXIucGFyc2UKICAgICogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEdhbWUgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIGtleSBvZiB0aGUgdGlsZW1hcCBpbiB0aGUgQ2FjaGUuCiAgICAqIEByZXR1cm4ge29iamVjdH0gVGhlIHBhcnNlZCBtYXAgb2JqZWN0LgogICAgKi8KICAgIHBhcnNlOiBmdW5jdGlvbiAoZ2FtZSwga2V5KSB7CgogICAgICAgIHZhciBtYXAgPSBnYW1lLmNhY2hlLmdldFRpbGVtYXBEYXRhKGtleSk7CgogICAgICAgIGlmIChtYXApCiAgICAgICAgewogICAgICAgICAgICBpZiAobWFwLmZvcm1hdCA9PT0gUGhhc2VyLlRpbGVtYXAuQ1NWKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUNTVihtYXAuZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAobWFwLmZvcm1hdCA9PT0gUGhhc2VyLlRpbGVtYXAuVElMRURfSlNPTikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VUaWxlZEpTT04obWFwLmRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB7IGxheWVyczogW10sIG9iamVjdHM6IFtdLCBpbWFnZXM6IFtdLCB0aWxlc2V0czogW10gfTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUGFyc2VzIGEgQ1NWIGZpbGUgaW50byB2YWxpZCBtYXAgZGF0YS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcFBhcnNlci5wYXJzZUNTVgogICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YSAtIFRoZSBDU1YgZmlsZSBkYXRhLgogICAgKiBAcmV0dXJuIHtvYmplY3R9IEdlbmVyYXRlZCBtYXAgZGF0YS4KICAgICovCiAgICBwYXJzZUNTVjogZnVuY3Rpb24gKGRhdGEpIHsKCiAgICAgICAgLy8gIFRyaW0gYW55IHJvZ3VlIHdoaXRlc3BhY2UgZnJvbSB0aGUgZGF0YQogICAgICAgIGRhdGEgPSBkYXRhLnRyaW0oKTsKCiAgICAgICAgdmFyIG91dHB1dCA9IFtdOwogICAgICAgIHZhciByb3dzID0gZGF0YS5zcGxpdCgiXG4iKTsKICAgICAgICB2YXIgaGVpZ2h0ID0gcm93cy5sZW5ndGg7CiAgICAgICAgdmFyIHdpZHRoID0gMDsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByb3dzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgb3V0cHV0W2ldID0gW107CgogICAgICAgICAgICB2YXIgY29sdW1uID0gcm93c1tpXS5zcGxpdCgiLCIpOwoKICAgICAgICAgICAgZm9yICh2YXIgYyA9IDA7IGMgPCBjb2x1bW4ubGVuZ3RoOyBjKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG91dHB1dFtpXVtjXSA9IHBhcnNlSW50KGNvbHVtbltjXSwgMTApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAod2lkdGggPT09IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdpZHRoID0gY29sdW1uLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gIEJ1aWxkIGNvbGxpc2lvbiBtYXAKCiAgICAgICAgcmV0dXJuIFt7IG5hbWU6ICdjc3YnLCB3aWR0aDogd2lkdGgsIGhlaWdodDogaGVpZ2h0LCBhbHBoYTogMSwgdmlzaWJsZTogdHJ1ZSwgaW5kZXhlczogW10sIHRpbGVNYXJnaW46IDAsIHRpbGVTcGFjaW5nOiAwLCBkYXRhOiBvdXRwdXQgfV07CgogICAgfSwKCiAgICAvKioKICAgICogUGFyc2VzIGEgVGlsZWQgSlNPTiBmaWxlIGludG8gdmFsaWQgbWFwIGRhdGEuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXBQYXJzZXIucGFyc2VKU09OCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBqc29uIC0gVGhlIEpTT04gbWFwIGRhdGEuCiAgICAqIEByZXR1cm4ge29iamVjdH0gR2VuZXJhdGVkIGFuZCBwYXJzZWQgbWFwIGRhdGEuCiAgICAqLwogICAgcGFyc2VUaWxlZEpTT046IGZ1bmN0aW9uIChqc29uKSB7CgogICAgICAgIGlmIChqc29uLm9yaWVudGF0aW9uICE9PSAnb3J0aG9nb25hbCcpCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1RpbGVtYXBQYXJzZXIucGFyc2VUaWxlZEpTT046IE9ubHkgb3J0aG9nb25hbCBtYXAgdHlwZXMgYXJlIHN1cHBvcnRlZCBpbiB0aGlzIHZlcnNpb24gb2YgUGhhc2VyJyk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgLy8gIE1hcCBkYXRhIHdpbGwgY29uc2lzdCBvZjogbGF5ZXJzLCBvYmplY3RzLCBpbWFnZXMsIHRpbGVzZXRzLCBzaXplcwogICAgICAgIHZhciBtYXAgPSB7fTsKCiAgICAgICAgbWFwLndpZHRoID0ganNvbi53aWR0aDsKICAgICAgICBtYXAuaGVpZ2h0ID0ganNvbi5oZWlnaHQ7CiAgICAgICAgbWFwLnRpbGVXaWR0aCA9IGpzb24udGlsZXdpZHRoOwogICAgICAgIG1hcC50aWxlSGVpZ2h0ID0ganNvbi50aWxlaGVpZ2h0OwogICAgICAgIG1hcC5vcmllbnRhdGlvbiA9IGpzb24ub3JpZW50YXRpb247CiAgICAgICAgbWFwLnZlcnNpb24gPSBqc29uLnZlcnNpb247CiAgICAgICAgbWFwLnByb3BlcnRpZXMgPSBqc29uLnByb3BlcnRpZXM7CiAgICAgICAgbWFwLndpZHRoSW5QaXhlbHMgPSBtYXAud2lkdGggKiBtYXAudGlsZVdpZHRoOwogICAgICAgIG1hcC5oZWlnaHRJblBpeGVscyA9IG1hcC5oZWlnaHQgKiBtYXAudGlsZUhlaWdodDsKCiAgICAgICAgLy8gIFRpbGUgTGF5ZXJzCiAgICAgICAgdmFyIGxheWVycyA9IFtdOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGpzb24ubGF5ZXJzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGpzb24ubGF5ZXJzW2ldLnR5cGUgIT09ICd0aWxlbGF5ZXInKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGxheWVyID0gewoKICAgICAgICAgICAgICAgIG5hbWU6IGpzb24ubGF5ZXJzW2ldLm5hbWUsCiAgICAgICAgICAgICAgICB4OiBqc29uLmxheWVyc1tpXS54LAogICAgICAgICAgICAgICAgeToganNvbi5sYXllcnNbaV0ueSwKICAgICAgICAgICAgICAgIHdpZHRoOiBqc29uLmxheWVyc1tpXS53aWR0aCwKICAgICAgICAgICAgICAgIGhlaWdodDoganNvbi5sYXllcnNbaV0uaGVpZ2h0LAogICAgICAgICAgICAgICAgd2lkdGhJblBpeGVsczoganNvbi5sYXllcnNbaV0ud2lkdGggKiBqc29uLnRpbGV3aWR0aCwKICAgICAgICAgICAgICAgIGhlaWdodEluUGl4ZWxzOiBqc29uLmxheWVyc1tpXS5oZWlnaHQgKiBqc29uLnRpbGVoZWlnaHQsCiAgICAgICAgICAgICAgICBhbHBoYToganNvbi5sYXllcnNbaV0ub3BhY2l0eSwKICAgICAgICAgICAgICAgIHZpc2libGU6IGpzb24ubGF5ZXJzW2ldLnZpc2libGUsCiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7fSwKICAgICAgICAgICAgICAgIGluZGV4ZXM6IFtdLAogICAgICAgICAgICAgICAgY2FsbGJhY2tzOiBbXQoKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChqc29uLmxheWVyc1tpXS5wcm9wZXJ0aWVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsYXllci5wcm9wZXJ0aWVzID0ganNvbi5sYXllcnNbaV0ucHJvcGVydGllczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHggPSAwOwogICAgICAgICAgICB2YXIgcm93ID0gW107CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSBbXTsKCiAgICAgICAgICAgIC8vICBMb29wIHRocm91Z2ggdGhlIGRhdGEgZmllbGQgaW4gdGhlIEpTT04uCgogICAgICAgICAgICAvLyAgVGhpcyBpcyBhbiBhcnJheSBjb250YWluaW5nIHRoZSB0aWxlIGluZGV4ZXMsIG9uZSBhZnRlciB0aGUgb3RoZXIuIDAgPSBubyB0aWxlLCBldmVyeXRoaW5nIGVsc2UgPSB0aGUgdGlsZSBpbmRleCAoc3RhcnRpbmcgYXQgMSkKICAgICAgICAgICAgLy8gIElmIHRoZSBtYXAgY29udGFpbnMgbXVsdGlwbGUgdGlsZXNldHMgdGhlbiB0aGUgaW5kZXhlcyBhcmUgcmVsYXRpdmUgdG8gdGhhdCB3aGljaCB0aGUgc2V0IHN0YXJ0cyBmcm9tLgogICAgICAgICAgICAvLyAgTmVlZCB0byBzZXQgd2hpY2ggdGlsZXNldCBpbiB0aGUgY2FjaGUgPSB3aGljaCB0aWxlc2V0IGluIHRoZSBKU09OLCBpZiB5b3UgZG8gdGhpcyBtYW51YWxseSBpdCBtZWFucyB5b3UgY2FuIHVzZSB0aGUgc2FtZSBtYXAgZGF0YSBidXQgYSBuZXcgdGlsZXNldC4KCiAgICAgICAgICAgIGZvciAodmFyIHQgPSAwLCBsZW4gPSBqc29uLmxheWVyc1tpXS5kYXRhLmxlbmd0aDsgdCA8IGxlbjsgdCsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgaW5kZXgsIHgsIHksIHdpZHRoLCBoZWlnaHQKICAgICAgICAgICAgICAgIGlmIChqc29uLmxheWVyc1tpXS5kYXRhW3RdID4gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByb3cucHVzaChuZXcgUGhhc2VyLlRpbGUobGF5ZXIsIGpzb24ubGF5ZXJzW2ldLmRhdGFbdF0sIHgsIG91dHB1dC5sZW5ndGgsIGpzb24udGlsZXdpZHRoLCBqc29uLnRpbGVoZWlnaHQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByb3cucHVzaChudWxsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB4Kys7CgogICAgICAgICAgICAgICAgaWYgKHggPT09IGpzb24ubGF5ZXJzW2ldLndpZHRoKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKHJvdyk7CiAgICAgICAgICAgICAgICAgICAgeCA9IDA7CiAgICAgICAgICAgICAgICAgICAgcm93ID0gW107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxheWVyLmRhdGEgPSBvdXRwdXQ7CgogICAgICAgICAgICBsYXllcnMucHVzaChsYXllcik7CgogICAgICAgIH0KCiAgICAgICAgbWFwLmxheWVycyA9IGxheWVyczsKCiAgICAgICAgLy8gIEltYWdlcwogICAgICAgIHZhciBpbWFnZXMgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBqc29uLmxheWVycy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChqc29uLmxheWVyc1tpXS50eXBlICE9PSAnaW1hZ2VsYXllcicpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaW1hZ2UgPSB7CgogICAgICAgICAgICAgICAgbmFtZToganNvbi5sYXllcnNbaV0ubmFtZSwKICAgICAgICAgICAgICAgIGltYWdlOiBqc29uLmxheWVyc1tpXS5pbWFnZSwKICAgICAgICAgICAgICAgIHg6IGpzb24ubGF5ZXJzW2ldLngsCiAgICAgICAgICAgICAgICB5OiBqc29uLmxheWVyc1tpXS55LAogICAgICAgICAgICAgICAgYWxwaGE6IGpzb24ubGF5ZXJzW2ldLm9wYWNpdHksCiAgICAgICAgICAgICAgICB2aXNpYmxlOiBqc29uLmxheWVyc1tpXS52aXNpYmxlLAogICAgICAgICAgICAgICAgcHJvcGVydGllczoge30KCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAoanNvbi5sYXllcnNbaV0ucHJvcGVydGllcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaW1hZ2UucHJvcGVydGllcyA9IGpzb24ubGF5ZXJzW2ldLnByb3BlcnRpZXM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGltYWdlcy5wdXNoKGltYWdlKTsKCiAgICAgICAgfQoKICAgICAgICBtYXAuaW1hZ2VzID0gaW1hZ2VzOwoKICAgICAgICAvLyAgT2JqZWN0cwogICAgICAgIHZhciBvYmplY3RzID0ge307CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwganNvbi5sYXllcnMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAoanNvbi5sYXllcnNbaV0udHlwZSAhPT0gJ29iamVjdGdyb3VwJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9iamVjdHNbanNvbi5sYXllcnNbaV0ubmFtZV0gPSBbXTsKCiAgICAgICAgICAgIGZvciAodmFyIHYgPSAwLCBsZW4gPSBqc29uLmxheWVyc1tpXS5vYmplY3RzLmxlbmd0aDsgdiA8IGxlbjsgdisrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgRm9yIG5vdyB3ZSdsbCBqdXN0IHN1cHBvcnQgb2JqZWN0IHRpbGVzCiAgICAgICAgICAgICAgICBpZiAoanNvbi5sYXllcnNbaV0ub2JqZWN0c1t2XS5naWQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9iamVjdCA9IHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGdpZDoganNvbi5sYXllcnNbaV0ub2JqZWN0c1t2XS5naWQsCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGpzb24ubGF5ZXJzW2ldLm9iamVjdHNbdl0ubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgeDoganNvbi5sYXllcnNbaV0ub2JqZWN0c1t2XS54LAogICAgICAgICAgICAgICAgICAgICAgICB5OiBqc29uLmxheWVyc1tpXS5vYmplY3RzW3ZdLnksCiAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGU6IGpzb24ubGF5ZXJzW2ldLm9iamVjdHNbdl0udmlzaWJsZSwKICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllczoganNvbi5sYXllcnNbaV0ub2JqZWN0c1t2XS5wcm9wZXJ0aWVzCgogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgb2JqZWN0c1tqc29uLmxheWVyc1tpXS5uYW1lXS5wdXNoKG9iamVjdCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBtYXAub2JqZWN0cyA9IG9iamVjdHM7CgogICAgICAgIC8vICBUaWxlc2V0cwogICAgICAgIHZhciB0aWxlc2V0cyA9IFtdOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGpzb24udGlsZXNldHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICAvLyAgbmFtZSwgZmlyc3RnaWQsIHdpZHRoLCBoZWlnaHQsIG1hcmdpbiwgc3BhY2luZywgcHJvcGVydGllcwogICAgICAgICAgICB2YXIgc2V0ID0ganNvbi50aWxlc2V0c1tpXTsKICAgICAgICAgICAgdmFyIG5ld1NldCA9IG5ldyBQaGFzZXIuVGlsZXNldChzZXQubmFtZSwgc2V0LmZpcnN0Z2lkLCBzZXQudGlsZXdpZHRoLCBzZXQudGlsZWhlaWdodCwgc2V0Lm1hcmdpbiwgc2V0LnNwYWNpbmcsIHNldC5wcm9wZXJ0aWVzKTsKCiAgICAgICAgICAgIGlmIChzZXQudGlsZXByb3BlcnRpZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5ld1NldC50aWxlUHJvcGVydGllcyA9IHNldC50aWxlcHJvcGVydGllczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbmV3U2V0LnJvd3MgPSAoc2V0LmltYWdlaGVpZ2h0IC0gc2V0Lm1hcmdpbikgLyAoc2V0LnRpbGVoZWlnaHQgKyBzZXQuc3BhY2luZyk7CiAgICAgICAgICAgIG5ld1NldC5jb2x1bW5zID0gKHNldC5pbWFnZXdpZHRoIC0gc2V0Lm1hcmdpbikgLyAoc2V0LnRpbGV3aWR0aCArIHNldC5zcGFjaW5nKTsKICAgICAgICAgICAgbmV3U2V0LnRvdGFsID0gbmV3U2V0LnJvd3MgKiBuZXdTZXQuY29sdW1uczsKCiAgICAgICAgICAgIHRpbGVzZXRzLnB1c2gobmV3U2V0KTsKICAgICAgICB9CgogICAgICAgIG1hcC50aWxlc2V0cyA9IHRpbGVzZXRzOwoKICAgICAgICBtYXAudGlsZXMgPSBbXTsKCiAgICAgICAgLy8gIEZpbmFsbHkgbGV0cyBidWlsZCBvdXIgc3VwZXIgdGlsZXNldCBpbmRleAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWFwLnRpbGVzZXRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNldCA9IG1hcC50aWxlc2V0c1tpXTsKICAgIAogICAgICAgICAgICB2YXIgeCA9IHNldC50aWxlTWFyZ2luOwogICAgICAgICAgICB2YXIgeSA9IHNldC50aWxlTWFyZ2luOwoKICAgICAgICAgICAgdmFyIGNvdW50ID0gMDsKICAgICAgICAgICAgdmFyIGNvdW50WCA9IDA7CiAgICAgICAgICAgIHZhciBjb3VudFkgPSAwOwoKICAgICAgICAgICAgZm9yICh2YXIgdCA9IHNldC5maXJzdGdpZDsgdCA8IHNldC5maXJzdGdpZCArIHNldC50b3RhbDsgdCsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgQ2FuIGFkZCBleHRyYSBwcm9wZXJ0aWVzIGhlcmUgYXMgbmVlZGVkCiAgICAgICAgICAgICAgICBtYXAudGlsZXNbdF0gPSBbeCwgeSwgaV07CgogICAgICAgICAgICAgICAgeCArPSBzZXQudGlsZVdpZHRoICsgc2V0LnRpbGVTcGFjaW5nOwoKICAgICAgICAgICAgICAgIGNvdW50Kys7CgogICAgICAgICAgICAgICAgaWYgKGNvdW50ID09PSBzZXQudG90YWwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY291bnRYKys7CgogICAgICAgICAgICAgICAgaWYgKGNvdW50WCA9PT0gc2V0LmNvbHVtbnMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgeCA9IHNldC50aWxlTWFyZ2luOwogICAgICAgICAgICAgICAgICAgIHkgKz0gc2V0LnRpbGVIZWlnaHQgKyBzZXQudGlsZVNwYWNpbmc7CgogICAgICAgICAgICAgICAgICAgIGNvdW50WCA9IDA7CiAgICAgICAgICAgICAgICAgICAgY291bnRZKys7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb3VudFkgPT09IHNldC5yb3dzKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG1hcDsKCiAgICB9Cgp9CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIFRpbGUgc2V0IGlzIGEgY29tYmluYXRpb24gb2YgYW4gaW1hZ2UgY29udGFpbmluZyB0aGUgdGlsZXMgYW5kIGNvbGxpc2lvbiBkYXRhIHBlciB0aWxlLgoqIFlvdSBzaG91bGQgbm90IG5vcm1hbGx5IGluc3RhbnRpYXRlIHRoaXMgY2xhc3MgZGlyZWN0bHkuCioKKiBAY2xhc3MgUGhhc2VyLlRpbGVzZXQKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSB0aWxlc2V0IGluIHRoZSBtYXAgZGF0YS4KKiBAcGFyYW0ge251bWJlcn0gZmlyc3RnaWQgLSBUaGUgVGlsZWQgZmlyc3RnaWQgdmFsdWUuCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gV2lkdGggb2YgZWFjaCB0aWxlIGluIHBpeGVscy4KKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gSGVpZ2h0IG9mIGVhY2ggdGlsZSBpbiBwaXhlbHMuCiogQHBhcmFtIHtudW1iZXJ9IG1hcmdpbiAtIFRoZSBhbW91bnQgb2YgbWFyZ2luIGFyb3VuZCB0aGUgdGlsZXNoZWV0LgoqIEBwYXJhbSB7bnVtYmVyfSBzcGFjaW5nIC0gVGhlIGFtb3VudCBvZiBzcGFjaW5nIGJldHdlZW4gZWFjaCB0aWxlIGluIHRoZSBzaGVldC4KKiBAcGFyYW0ge29iamVjdH0gcHJvcGVydGllcyAtIFRpbGVzZXQgcHJvcGVydGllcy4KKi8KUGhhc2VyLlRpbGVzZXQgPSBmdW5jdGlvbiAobmFtZSwgZmlyc3RnaWQsIHdpZHRoLCBoZWlnaHQsIG1hcmdpbiwgc3BhY2luZywgcHJvcGVydGllcykgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBUaWxlc2V0LgogICAgKi8KICAgIHRoaXMubmFtZSA9IG5hbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmaXJzdGdpZCAtIFRoZSBUaWxlZCBmaXJzdGdpZCB2YWx1ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZpcnN0Z2lkID0gZmlyc3RnaWQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aWxlV2lkdGggLSBUaGUgd2lkdGggb2YgYSB0aWxlIGluIHBpeGVscy4KICAgICovCiAgICB0aGlzLnRpbGVXaWR0aCA9IHdpZHRoOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdGlsZUhlaWdodCAtIFRoZSBoZWlnaHQgb2YgYSB0aWxlIGluIHBpeGVscy4KICAgICovCiAgICB0aGlzLnRpbGVIZWlnaHQgPSBoZWlnaHQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aWxlTWFyZ2luIC0gVGhlIG1hcmdpbiBhcm91bmQgdGhlIHRpbGVzIGluIHRoZSBzaGVldC4KICAgICovCiAgICB0aGlzLnRpbGVNYXJnaW4gPSBtYXJnaW47CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aWxlU3BhY2luZyAtIFRoZSBtYXJnaW4gYXJvdW5kIHRoZSB0aWxlcyBpbiB0aGUgc2hlZXQuCiAgICAqLwogICAgdGhpcy50aWxlU3BhY2luZyA9IHNwYWNpbmc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBwcm9wZXJ0aWVzIC0gVGlsZXNldCBzcGVjaWZpYyBwcm9wZXJ0aWVzICh0eXBpY2FsbHkgZGVmaW5lZCBpbiB0aGUgVGlsZWQgZWRpdG9yKS4KICAgICovCiAgICB0aGlzLnByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gdGlsZVBwcm9wZXJ0aWVzIC0gVGlsZSBzcGVjaWZpYyBwcm9wZXJ0aWVzICh0eXBpY2FsbHkgZGVmaW5lZCBpbiB0aGUgVGlsZWQgZWRpdG9yKS4KICAgICovCiAgICAvLyB0aGlzLnRpbGVQcm9wZXJ0aWVzID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBpbWFnZSAtIFRoZSBpbWFnZSB1c2VkIGZvciByZW5kZXJpbmcuIFRoaXMgaXMgYSByZWZlcmVuY2UgdG8gdGhlIGltYWdlIHN0b3JlZCBpbiBQaGFzZXIuQ2FjaGUuCiAgICAqLwogICAgdGhpcy5pbWFnZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSByb3dzIC0gVGhlIG51bWJlciBvZiByb3dzIGluIHRoZSB0aWxlIHNoZWV0LgogICAgKi8KICAgIHRoaXMucm93cyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjb2x1bW5zIC0gVGhlIG51bWJlciBvZiBjb2x1bW5zIGluIHRoZSB0aWxlIHNoZWV0LgogICAgKi8KICAgIHRoaXMuY29sdW1ucyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3RhbCAtIFRoZSB0b3RhbCBudW1iZXIgb2YgdGlsZXMgaW4gdGhlIHRpbGVzaGVldC4KICAgICovCiAgICB0aGlzLnRvdGFsID0gMDsKCn07CgpQaGFzZXIuVGlsZXNldC5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEdldHMgYSBUaWxlIGZyb20gdGhpcyBzZXQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVzZXQjZ2V0VGlsZQogICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhlIHRpbGUgd2l0aGluIHRoZSBzZXQuCiAgICAqIEByZXR1cm4ge29iamVjdH0gVGhlIHRpbGUgb2JqZWN0LgogICAgZ2V0VGlsZTogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgICAgIHJldHVybiB0aGlzLnRpbGVzW2luZGV4XTsKCiAgICB9LAogICAgKi8KCiAgICAvKioKICAgICogR2V0cyBhIFRpbGUgZnJvbSB0aGlzIHNldC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZXNldCNnZXRUaWxlWAogICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhlIHRpbGUgd2l0aGluIHRoZSBzZXQuCiAgICAqIEByZXR1cm4ge29iamVjdH0gVGhlIHRpbGUgb2JqZWN0LgogICAgZ2V0VGlsZVg6IGZ1bmN0aW9uIChpbmRleCkgewoKICAgICAgICByZXR1cm4gdGhpcy50aWxlc1tpbmRleF1bMF07CgogICAgfSwKICAgICovCgogICAgLyoqCiAgICAqIEdldHMgYSBUaWxlIGZyb20gdGhpcyBzZXQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVzZXQjZ2V0VGlsZVkKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoZSB0aWxlIHdpdGhpbiB0aGUgc2V0LgogICAgKiBAcmV0dXJuIHtvYmplY3R9IFRoZSB0aWxlIG9iamVjdC4KICAgIGdldFRpbGVZOiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMudGlsZXNbaW5kZXhdWzFdOwoKICAgIH0sCiAgICAqLwoKICAgIC8qKgogICAgKiBTZXRzIHRpbGUgc3BhY2luZyBhbmQgbWFyZ2lucy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZXNldCNzZXRTcGFjaW5nCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdGlsZU1hcmdpbl0gLSBUaGUgbWFyZ2luIGFyb3VuZCB0aGUgdGlsZXMgaW4gdGhlIHNoZWV0LgogICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbGVTcGFjaW5nXSAtIFRoZSBzcGFjaW5nIGJldHdlZW4gdGhlIHRpbGVzIGluIHRoZSBzaGVldC4KICAgICovCiAgICBzZXRTcGFjaW5nOiBmdW5jdGlvbiAobWFyZ2luLCBzcGFjaW5nKSB7CgogICAgICAgIHRoaXMudGlsZU1hcmdpbiA9IG1hcmdpbjsKICAgICAgICB0aGlzLnRpbGVTcGFjaW5nID0gc3BhY2luZzsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgaWYgdGhlIHRpbGUgYXQgdGhlIGdpdmVuIGluZGV4IGV4aXN0cy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZXNldCNjaGVja1RpbGVJbmRleAogICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhlIHRpbGUgd2l0aGluIHRoZSBzZXQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgYSB0aWxlIGV4aXN0cyBhdCB0aGUgZ2l2ZW4gaW5kZXggb3RoZXJ3aXNlIGZhbHNlLgogICAgY2hlY2tUaWxlSW5kZXg6IGZ1bmN0aW9uIChpbmRleCkgewoKICAgICAgICByZXR1cm4gKHRoaXMudGlsZXNbaW5kZXhdKTsKCiAgICB9CiAgICAqLwoKfTsKClBoYXNlci5UaWxlc2V0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5UaWxlc2V0OwoKLyoqCiogV2UncmUgcmVwbGFjaW5nIGEgY291cGxlIG9mIFBpeGkncyBtZXRob2RzIGhlcmUgdG8gZml4IG9yIGFkZCBzb21lIHZpdGFsIGZ1bmN0aW9uYWxpdHk6CioKKiAxKSBBZGRlZCBzdXBwb3J0IGZvciBUcmltbWVkIHNwcml0ZSBzaGVldHMKKiAyKSBTa2lwIGRpc3BsYXkgb2JqZWN0cyB3aXRoIGFuIGFscGhhIG9mIHplcm8KKiAzKSBBdm9pZCBTdHlsZSBSZWNhbGN1bGF0aW9uIGZyb20gdGhlIGluY29ycmVjdCBiZ2NvbG9yIHZhbHVlCiogNCkgQWRkZWQgc3VwcG9ydCBmb3IgQ2FudmFzIHVuaXQgcm91bmRpbmcgdmlhIFBoYXNlci5DQU5WQVNfUFhfUk9VTkQgYm9vbGVhbiAoZGlzYWJsZWQgYnkgZGVmYXVsdCkuCioKKiBIb3BlZnVsbHkgd2UgY2FuIHJlbW92ZSB0aGlzIG9uY2UgUGl4aSBoYXMgYmVlbiB1cGRhdGVkIHRvIHN1cHBvcnQgdGhlc2UgdGhpbmdzLgoqLwoKLyoqCiAqIFJlbmRlcnMgdGhlIHN0YWdlIHRvIGl0cyBjYW52YXMgdmlldwogKgogKiBAbWV0aG9kIHJlbmRlcgogKiBAcGFyYW0gc3RhZ2Uge1N0YWdlfSB0aGUgU3RhZ2UgZWxlbWVudCB0byBiZSByZW5kZXJlZAogKi8KUElYSS5DYW52YXNSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oc3RhZ2UpCnsKICAgIFBJWEkudGV4dHVyZXNUb1VwZGF0ZS5sZW5ndGggPSAwOwogICAgUElYSS50ZXh0dXJlc1RvRGVzdHJveS5sZW5ndGggPSAwOwogICAgCiAgICBQSVhJLnZpc2libGVDb3VudCsrOwogICAgc3RhZ2UudXBkYXRlVHJhbnNmb3JtKCk7CgogICAgdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybSgxLCAwLCAwLCAxLCAwLCAwKTsKCiAgICBpZiAoUGhhc2VyLkNBTlZBU19DTEVBUl9SRUNUKQogICAgewogICAgICAgIHRoaXMuY29udGV4dC5jbGVhclJlY3QoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpCiAgICB9CgogICAgdGhpcy5yZW5kZXJEaXNwbGF5T2JqZWN0KHN0YWdlLCBmYWxzZSk7CiAgIAogICAgLy8gIFJlbW92ZSBmcmFtZSB1cGRhdGVzCiAgICBpZiAoUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcy5sZW5ndGggPiAwKQogICAgewogICAgICAgIFBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMubGVuZ3RoID0gMDsKICAgIH0KICAgIAp9CgovLyBAcGFyYW0ge2Jvb2xlYW59IFtyZW5kZXJIaWRkZW49ZmFsc2VdIC0gSWYgdHJ1ZSBkaXNwbGF5T2JqZWN0cyB0aGF0IGhhdmUgdGhlaXIgdmlzaWJsZSBwcm9wZXJ0eSBzZXQgdG8gZmFsc2Ugd2lsbCBzdGlsbCBiZSByZW5kZXJlZC4KClBJWEkuQ2FudmFzUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlckRpc3BsYXlPYmplY3QgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0LCByZW5kZXJIaWRkZW4pCnsKICAgIC8vIE9uY2UgdGhlIGRpc3BsYXkgb2JqZWN0IGhpdHMgdGhpcyB3ZSBjYW4gYnJlYWsgdGhlIGxvb3AgIAogICAgdmFyIHRlc3RPYmplY3QgPSBkaXNwbGF5T2JqZWN0Lmxhc3QuX2lOZXh0OwogICAgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuZmlyc3Q7CiAgICAKICAgIGRvCiAgICB7CiAgICAgICAgaWYgKCFkaXNwbGF5T2JqZWN0LnZpc2libGUgJiYgIXJlbmRlckhpZGRlbikKICAgICAgICB7CiAgICAgICAgICAgIGRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Lmxhc3QuX2lOZXh0OwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKCFkaXNwbGF5T2JqZWN0LnJlbmRlcmFibGUgfHwgZGlzcGxheU9iamVjdC5hbHBoYSA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGE7CgogICAgICAgICAgICAgICAgaWYgKFBoYXNlci5DQU5WQVNfUFhfUk9VTkQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzNdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsxXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5mbG9vcihkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzNdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsxXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGRpc3BsYXlPYmplY3QudGV4dHVyZS50cmltbWVkKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC50cmFuc2Zvcm0oMSwgMCwgMCwgMSwgZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueCwgZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy9pZiBzbW9vdGhpbmdFbmFibGVkIGlzIHN1cHBvcnRlZCBhbmQgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIHNtb290aGluZyBwcm9wZXJ0eSBmb3IgdGhpcyB0ZXh0dXJlCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zbW9vdGhQcm9wZXJ0eSAmJiB0aGlzLnNjYWxlTW9kZSAhPT0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmJhc2VUZXh0dXJlLnNjYWxlTW9kZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNjYWxlTW9kZSA9IGRpc3BsYXlPYmplY3QudGV4dHVyZS5iYXNlVGV4dHVyZS5zY2FsZU1vZGU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0W3RoaXMuc21vb3RoUHJvcGVydHldID0gKHRoaXMuc2NhbGVNb2RlID09PSBQSVhJLkJhc2VUZXh0dXJlLlNDQUxFX01PREUuTElORUFSKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5kcmF3SW1hZ2UoCiAgICAgICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC50ZXh0dXJlLmJhc2VUZXh0dXJlLnNvdXJjZSwKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUueCwKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUueSwKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLmhlaWdodCwKICAgICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKChkaXNwbGF5T2JqZWN0LmFuY2hvci54KSAqIC1kaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUud2lkdGgpLAogICAgICAgICAgICAgICAgICAgIE1hdGguZmxvb3IoKGRpc3BsYXlPYmplY3QuYW5jaG9yLnkpICogLWRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS5oZWlnaHQpLAogICAgICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS53aWR0aCwKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUuaGVpZ2h0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5TdHJpcCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zZXRUcmFuc2Zvcm0oZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVswXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVszXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsxXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs0XSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsyXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSkKICAgICAgICAgICAgdGhpcy5yZW5kZXJTdHJpcChkaXNwbGF5T2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuVGlsaW5nU3ByaXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybShkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzBdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzNdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzFdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzRdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzJdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdKQogICAgICAgICAgICB0aGlzLnJlbmRlclRpbGluZ1Nwcml0ZShkaXNwbGF5T2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuQ3VzdG9tUmVuZGVyYWJsZSkKICAgICAgICB7CiAgICAgICAgICAgIGRpc3BsYXlPYmplY3QucmVuZGVyQ2FudmFzKHRoaXMpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5HcmFwaGljcykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zZXRUcmFuc2Zvcm0oZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVswXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVszXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsxXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs0XSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsyXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSkKICAgICAgICAgICAgUElYSS5DYW52YXNHcmFwaGljcy5yZW5kZXJHcmFwaGljcyhkaXNwbGF5T2JqZWN0LCB0aGlzLmNvbnRleHQpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5GaWx0ZXJCbG9jaykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNwbGF5T2JqZWN0Lm9wZW4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5zYXZlKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZhciBjYWNoZUFscGhhID0gZGlzcGxheU9iamVjdC5tYXNrLmFscGhhOwogICAgICAgICAgICAgICAgdmFyIG1hc2tUcmFuc2Zvcm0gPSBkaXNwbGF5T2JqZWN0Lm1hc2sud29ybGRUcmFuc2Zvcm07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5zZXRUcmFuc2Zvcm0obWFza1RyYW5zZm9ybVswXSwgbWFza1RyYW5zZm9ybVszXSwgbWFza1RyYW5zZm9ybVsxXSwgbWFza1RyYW5zZm9ybVs0XSwgbWFza1RyYW5zZm9ybVsyXSwgbWFza1RyYW5zZm9ybVs1XSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC5tYXNrLndvcmxkQWxwaGEgPSAwLjU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC53b3JsZEFscGhhID0gMDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgUElYSS5DYW52YXNHcmFwaGljcy5yZW5kZXJHcmFwaGljc01hc2soZGlzcGxheU9iamVjdC5tYXNrLCB0aGlzLmNvbnRleHQpOwogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmNsaXAoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC5tYXNrLndvcmxkQWxwaGEgPSBjYWNoZUFscGhhOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LnJlc3RvcmUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyAgY291bnQrKwogICAgICAgIGRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKICAgIH0KICAgIHdoaWxlKGRpc3BsYXlPYmplY3QgIT0gdGVzdE9iamVjdCkKICAgIAp9CgpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKCkKewogICAgLy8gdmFyIGdsID0gdGhpcy5nbDsKICAgIC8vIHZhciB3b3JsZFRyYW5zZm9ybSwgd2lkdGgsIGhlaWdodCwgYVgsIGFZLCB3MCwgdzEsIGgwLCBoMSwgaW5kZXgsIGluZGV4MiwgaW5kZXgzCgogICAgdmFyIHdvcmxkVHJhbnNmb3JtLCB3aWR0aCwgaGVpZ2h0LCBhWCwgYVksIHcwLCB3MSwgaDAsIGgxLCBpbmRleDsKCiAgICB2YXIgYSwgYiwgYywgZCwgdHgsIHR5OwoKICAgIHZhciBpbmRleFJ1biA9IDA7CgogICAgdmFyIGRpc3BsYXlPYmplY3QgPSB0aGlzLmhlYWQ7CgogICAgd2hpbGUoZGlzcGxheU9iamVjdCkKICAgIHsKICAgICAgICBpZihkaXNwbGF5T2JqZWN0LnZjb3VudCA9PT0gUElYSS52aXNpYmxlQ291bnQpCiAgICAgICAgewogICAgICAgICAgICB3aWR0aCA9IGRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS53aWR0aDsKICAgICAgICAgICAgaGVpZ2h0ID0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLmhlaWdodDsKCiAgICAgICAgICAgIC8vIFRPRE8gdHJpbT8/CiAgICAgICAgICAgIGFYID0gZGlzcGxheU9iamVjdC5hbmNob3IueDsvLyAtIGRpc3BsYXlPYmplY3QudGV4dHVyZS50cmltLngKICAgICAgICAgICAgYVkgPSBkaXNwbGF5T2JqZWN0LmFuY2hvci55OyAvLy0gZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueQogICAgICAgICAgICB3MCA9IHdpZHRoICogKDEtYVgpOwogICAgICAgICAgICB3MSA9IHdpZHRoICogLWFYOwoKICAgICAgICAgICAgaDAgPSBoZWlnaHQgKiAoMS1hWSk7CiAgICAgICAgICAgIGgxID0gaGVpZ2h0ICogLWFZOwoKICAgICAgICAgICAgaW5kZXggPSBpbmRleFJ1biAqIDg7CgogICAgICAgICAgICB3b3JsZFRyYW5zZm9ybSA9IGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm07CgogICAgICAgICAgICBhID0gd29ybGRUcmFuc2Zvcm1bMF07CiAgICAgICAgICAgIGIgPSB3b3JsZFRyYW5zZm9ybVszXTsKICAgICAgICAgICAgYyA9IHdvcmxkVHJhbnNmb3JtWzFdOwogICAgICAgICAgICBkID0gd29ybGRUcmFuc2Zvcm1bNF07CiAgICAgICAgICAgIHR4ID0gd29ybGRUcmFuc2Zvcm1bMl07CiAgICAgICAgICAgIHR5ID0gd29ybGRUcmFuc2Zvcm1bNV07CgogICAgICAgICAgICBpZiAoZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW1tZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHR4ICs9IGRpc3BsYXlPYmplY3QudGV4dHVyZS50cmltLng7CiAgICAgICAgICAgICAgICB0eSArPSBkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbS55OwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnZlcnRpY2llc1tpbmRleCArIDAgXSA9IGEgKiB3MSArIGMgKiBoMSArIHR4OwogICAgICAgICAgICB0aGlzLnZlcnRpY2llc1tpbmRleCArIDEgXSA9IGQgKiBoMSArIGIgKiB3MSArIHR5OwoKICAgICAgICAgICAgdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyAyIF0gPSBhICogdzAgKyBjICogaDEgKyB0eDsKICAgICAgICAgICAgdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyAzIF0gPSBkICogaDEgKyBiICogdzAgKyB0eTsKCiAgICAgICAgICAgIHRoaXMudmVydGljaWVzW2luZGV4ICsgNCBdID0gYSAqIHcwICsgYyAqIGgwICsgdHg7CiAgICAgICAgICAgIHRoaXMudmVydGljaWVzW2luZGV4ICsgNSBdID0gZCAqIGgwICsgYiAqIHcwICsgdHk7CgogICAgICAgICAgICB0aGlzLnZlcnRpY2llc1tpbmRleCArIDZdID0gIGEgKiB3MSArIGMgKiBoMCArIHR4OwogICAgICAgICAgICB0aGlzLnZlcnRpY2llc1tpbmRleCArIDddID0gIGQgKiBoMCArIGIgKiB3MSArIHR5OwoKICAgICAgICAgICAgaWYoZGlzcGxheU9iamVjdC51cGRhdGVGcmFtZSB8fCBkaXNwbGF5T2JqZWN0LnRleHR1cmUudXBkYXRlRnJhbWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZGlydHlVVlMgPSB0cnVlOwoKICAgICAgICAgICAgICAgIHZhciB0ZXh0dXJlID0gZGlzcGxheU9iamVjdC50ZXh0dXJlOwoKICAgICAgICAgICAgICAgIHZhciBmcmFtZSA9IHRleHR1cmUuZnJhbWU7CiAgICAgICAgICAgICAgICB2YXIgdHcgPSB0ZXh0dXJlLmJhc2VUZXh0dXJlLndpZHRoOwogICAgICAgICAgICAgICAgdmFyIHRoID0gdGV4dHVyZS5iYXNlVGV4dHVyZS5oZWlnaHQ7CgogICAgICAgICAgICAgICAgdGhpcy51dnNbaW5kZXggKyAwXSA9IGZyYW1lLnggLyB0dzsKICAgICAgICAgICAgICAgIHRoaXMudXZzW2luZGV4ICsxXSA9IGZyYW1lLnkgLyB0aDsKCiAgICAgICAgICAgICAgICB0aGlzLnV2c1tpbmRleCArMl0gPSAoZnJhbWUueCArIGZyYW1lLndpZHRoKSAvIHR3OwogICAgICAgICAgICAgICAgdGhpcy51dnNbaW5kZXggKzNdID0gZnJhbWUueSAvIHRoOwoKICAgICAgICAgICAgICAgIHRoaXMudXZzW2luZGV4ICs0XSA9IChmcmFtZS54ICsgZnJhbWUud2lkdGgpIC8gdHc7CiAgICAgICAgICAgICAgICB0aGlzLnV2c1tpbmRleCArNV0gPSAoZnJhbWUueSArIGZyYW1lLmhlaWdodCkgLyB0aDsKCiAgICAgICAgICAgICAgICB0aGlzLnV2c1tpbmRleCArNl0gPSBmcmFtZS54IC8gdHc7CiAgICAgICAgICAgICAgICB0aGlzLnV2c1tpbmRleCArN10gPSAoZnJhbWUueSArIGZyYW1lLmhlaWdodCkgLyB0aDsKCiAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LnVwZGF0ZUZyYW1lID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFRPRE8gdGhpcyBwcm9iYWJseSBjb3VsZCBkbyB3aXRoIHNvbWUgb3B0aW1pc2F0aW9uLi4uLgogICAgICAgICAgICBpZihkaXNwbGF5T2JqZWN0LmNhY2hlQWxwaGEgIT0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LmNhY2hlQWxwaGEgPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGE7CgogICAgICAgICAgICAgICAgdmFyIGNvbG9ySW5kZXggPSBpbmRleFJ1biAqIDQ7CiAgICAgICAgICAgICAgICB0aGlzLmNvbG9yc1tjb2xvckluZGV4XSA9IHRoaXMuY29sb3JzW2NvbG9ySW5kZXggKyAxXSA9IHRoaXMuY29sb3JzW2NvbG9ySW5kZXggKyAyXSA9IHRoaXMuY29sb3JzW2NvbG9ySW5kZXggKyAzXSA9IGRpc3BsYXlPYmplY3Qud29ybGRBbHBoYTsKICAgICAgICAgICAgICAgIHRoaXMuZGlydHlDb2xvcnMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGluZGV4ID0gaW5kZXhSdW4gKiA4OwoKICAgICAgICAgICAgdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyAwIF0gPSAwOwogICAgICAgICAgICB0aGlzLnZlcnRpY2llc1tpbmRleCArIDEgXSA9IDA7CgogICAgICAgICAgICB0aGlzLnZlcnRpY2llc1tpbmRleCArIDIgXSA9IDA7CiAgICAgICAgICAgIHRoaXMudmVydGljaWVzW2luZGV4ICsgMyBdID0gMDsKCiAgICAgICAgICAgIHRoaXMudmVydGljaWVzW2luZGV4ICsgNCBdID0gMDsKICAgICAgICAgICAgdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyA1IF0gPSAwOwoKICAgICAgICAgICAgdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyA2XSA9IDA7CiAgICAgICAgICAgIHRoaXMudmVydGljaWVzW2luZGV4ICsgN10gPSAwOwogICAgICAgIH0KCiAgICAgICAgaW5kZXhSdW4rKzsKICAgICAgICBkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5fX25leHQ7CiAgICB9Cn0KICByZXR1cm4gUGhhc2VyOwp9KTs=",
                "body": "IWZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKICBpZiAodHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSB7CiAgICBkZWZpbmUoZmFjdG9yeSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gIm9iamVjdCIpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7CiAgfSBlbHNlIHsKICAgIHJvb3QuUGhhc2VyID0gZmFjdG9yeSgpOwogIH0KfSh0aGlzLCBmdW5jdGlvbigpIHsKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQG92ZXJ2aWV3CioKKiBQaGFzZXIgLSBodHRwOi8vd3d3LnBoYXNlci5pbwoqCiogdjEuMS41IC0gQnVpbHQgYXQ6IFdlZCBGZWIgMTIgMjAxNCAwOTo0Nzo1NgoqCiogQnkgUmljaGFyZCBEYXZleSBodHRwOi8vd3d3LnBob3RvbnN0b3JtLmNvbSBAcGhvdG9uc3Rvcm0KKgoqIEEgZmVhdHVyZS1wYWNrZWQgMkQgSFRNTDUgZ2FtZSBmcmFtZXdvcmsgYm9ybiBmcm9tIHRoZSBzbW91bGRlcmluZyBwaXRzIG9mIEZsaXhlbCBhbmQKKiBjb25zdHJ1Y3RlZCB2aWEgcGxlbnR5IG9mIGJsb29kLCBzd2VhdCwgdGVhcnMgYW5kIGNvZmZlZSBieSBSaWNoYXJkIERhdmV5IChAcGhvdG9uc3Rvcm0pLgoqCiogUGhhc2VyIHVzZXMgUGl4aS5qcyBmb3IgcmVuZGVyaW5nLCBjcmVhdGVkIGJ5IE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMuCioKKiBGb2xsb3cgUGhhc2VyIGRldmVsb3BtZW50IHByb2dyZXNzIGF0IGh0dHA6Ly93d3cucGhvdG9uc3Rvcm0uY29tCioKKiBNYW55IHRoYW5rcyB0byBBZGFtIFNhbHRzbWFuIChAQURBTUFUT01JQykgZm9yIHJlbGVhc2luZyBGbGl4ZWwsIGZyb20gd2hpY2ggYm90aCBQaGFzZXIKKiBhbmQgbXkgbG92ZSBvZiBnYW1lIGRldmVsb3BtZW50IG9yaWdpbmF0ZS4KKgoqICJJZiB5b3Ugd2FudCB5b3VyIGNoaWxkcmVuIHRvIGJlIGludGVsbGlnZW50LCAgcmVhZCB0aGVtIGZhaXJ5IHRhbGVzLiIKKiAiSWYgeW91IHdhbnQgdGhlbSB0byBiZSBtb3JlIGludGVsbGlnZW50LCByZWFkIHRoZW0gbW9yZSBmYWlyeSB0YWxlcy4iCiogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0tIEFsYmVydCBFaW5zdGVpbgoqLwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiBAbW9kdWxlIFBJWEkKICovCnZhciBQSVhJID0gUElYSSB8fCB7fTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEBuYW1lc3BhY2UgUGhhc2VyCiovCnZhciBQaGFzZXIgPSBQaGFzZXIgfHwgewoKCVZFUlNJT046ICcxLjEuNScsCglERVZfVkVSU0lPTjogJzEuMS41JywKCUdBTUVTOiBbXSwKCglBVVRPOiAwLAoJQ0FOVkFTOiAxLAoJV0VCR0w6IDIsCglIRUFETEVTUzogMywKCglTUFJJVEU6IDAsCglCVVRUT046IDEsCglCVUxMRVQ6IDIsCglHUkFQSElDUzogMywKCVRFWFQ6IDQsCglUSUxFU1BSSVRFOiA1LAoJQklUTUFQVEVYVDogNiwKCUdST1VQOiA3LAoJUkVOREVSVEVYVFVSRTogOCwKCVRJTEVNQVA6IDksCglUSUxFTUFQTEFZRVI6IDEwLAoJRU1JVFRFUjogMTEsCglQT0xZR09OOiAxMiwKCUJJVE1BUERBVEE6IDEzLAoJQ0FOVkFTX0ZJTFRFUjogMTQsCglXRUJHTF9GSUxURVI6IDE1LAoKCU5PTkU6IDAsCglMRUZUOiAxLAoJUklHSFQ6IDIsCglVUDogMywKCURPV046IDQsCgoJQ0FOVkFTX1BYX1JPVU5EOiBmYWxzZSwKCUNBTlZBU19DTEVBUl9SRUNUOiB0cnVlCgogfTsKClBJWEkuSW50ZXJhY3Rpb25NYW5hZ2VyID0gZnVuY3Rpb24gKGR1bW15KSB7CgkvLwlXZSBkb24ndCBuZWVkIHRoaXMgaW4gUGl4aSwgc28gd2UndmUgcmVtb3ZlZCBpdCB0byBzYXZlIHNwYWNlCgkvLwlob3dldmVyIHRoZSBTdGFnZSBvYmplY3QgZXhwZWN0cyBhIHJlZmVyZW5jZSB0byBpdCwgc28gaGVyZSBpcyBhIGR1bW15IGVudHJ5Lgp9OwoKLyoganNoaW50IHN1cGVybmV3OiB0cnVlICovCgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBAY2xhc3MgUGhhc2VyLlV0aWxzCiogQHN0YXRpYwoqLwpQaGFzZXIuVXRpbHMgPSB7CiAgICAKICAgIC8qKgogICAgKiBBIHN0YW5kYXJkIEZpc2hlci1ZYXRlcyBBcnJheSBzaHVmZmxlIGltcGxlbWVudGF0aW9uLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5zaHVmZmxlCiAgICAqIEBwYXJhbSB7YXJyYXl9IGFycmF5IC0gVGhlIGFycmF5IHRvIHNodWZmbGUuCiAgICAqIEByZXR1cm4ge2FycmF5fSBUaGUgc2h1ZmZsZWQgYXJyYXkuCiAgICAqLwogICAgc2h1ZmZsZTogZnVuY3Rpb24gKGFycmF5KSB7CgogICAgICAgIGZvciAodmFyIGkgPSBhcnJheS5sZW5ndGggLSAxOyBpID4gMDsgaS0tKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGogPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoaSArIDEpKTsKICAgICAgICAgICAgdmFyIHRlbXAgPSBhcnJheVtpXTsKICAgICAgICAgICAgYXJyYXlbaV0gPSBhcnJheVtqXTsKICAgICAgICAgICAgYXJyYXlbal0gPSB0ZW1wOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogSmF2YXNjcmlwdCBzdHJpbmcgcGFkIGh0dHA6Ly93d3cud2VidG9vbGtpdC5pbmZvLy4KICAgICogcGFkID0gdGhlIHN0cmluZyB0byBwYWQgaXQgb3V0IHdpdGggKGRlZmF1bHRzIHRvIGEgc3BhY2UpCiAgICAqIGRpciA9IDEgKGxlZnQpLCAyIChyaWdodCksIDMgKGJvdGgpCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLnBhZAogICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyIC0gVGhlIHRhcmdldCBzdHJpbmcuIAogICAgKiBAcGFyYW0ge251bWJlcn0gbGVuIC0gVGhlIG51bWJlciBvZiBjaGFyYWN0ZXJzIHRvIGJlIGFkZGVkLgogICAgKiBAcGFyYW0ge251bWJlcn0gcGFkIC0gVGhlIHN0cmluZyB0byBwYWQgaXQgb3V0IHdpdGggKGRlZmF1bHRzIHRvIGEgc3BhY2UpLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2Rpcj0zXSBUaGUgZGlyZWN0aW9uIGRpciA9IDEgKGxlZnQpLCAyIChyaWdodCksIDMgKGJvdGgpLgogICAgKiBAcmV0dXJuIHtzdHJpbmd9IFRoZSBwYWRkZWQgc3RyaW5nCiAgICAqLwogICAgcGFkOiBmdW5jdGlvbiAoc3RyLCBsZW4sIHBhZCwgZGlyKSB7CgogICAgICAgIGlmICh0eXBlb2YobGVuKSA9PSAidW5kZWZpbmVkIikgeyB2YXIgbGVuID0gMDsgfQogICAgICAgIGlmICh0eXBlb2YocGFkKSA9PSAidW5kZWZpbmVkIikgeyB2YXIgcGFkID0gJyAnOyB9CiAgICAgICAgaWYgKHR5cGVvZihkaXIpID09ICJ1bmRlZmluZWQiKSB7IHZhciBkaXIgPSAzOyB9CgogICAgICAgIHZhciBwYWRsZW4gPSAwOwoKICAgICAgICBpZiAobGVuICsgMSA+PSBzdHIubGVuZ3RoKQogICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChkaXIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgICAgICBzdHIgPSBBcnJheShsZW4gKyAxIC0gc3RyLmxlbmd0aCkuam9pbihwYWQpICsgc3RyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICB2YXIgcmlnaHQgPSBNYXRoLmNlaWwoKHBhZGxlbiA9IGxlbiAtIHN0ci5sZW5ndGgpIC8gMik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxlZnQgPSBwYWRsZW4gLSByaWdodDsKICAgICAgICAgICAgICAgICAgICBzdHIgPSBBcnJheShsZWZ0KzEpLmpvaW4ocGFkKSArIHN0ciArIEFycmF5KHJpZ2h0KzEpLmpvaW4ocGFkKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHN0ciA9IHN0ciArIEFycmF5KGxlbiArIDEgLSBzdHIubGVuZ3RoKS5qb2luKHBhZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBzdHI7CgogICAgfSwKCiAgICAvKioKICAgICogVGhpcyBpcyBhIHNsaWdodGx5IG1vZGlmaWVkIHZlcnNpb24gb2YgalF1ZXJ5LmlzUGxhaW5PYmplY3QuIEEgcGxhaW4gb2JqZWN0IGlzIGFuIG9iamVjdCB3aG9zZSBpbnRlcm5hbCBjbGFzcyBwcm9wZXJ0eSBpcyBbb2JqZWN0IE9iamVjdF0uCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLmlzUGxhaW5PYmplY3QKICAgICogQHBhcmFtIHtvYmplY3R9IG9iaiAtIFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gLSB0cnVlIGlmIHRoZSBvYmplY3QgaXMgcGxhaW4sIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBpc1BsYWluT2JqZWN0OiBmdW5jdGlvbiAob2JqKSB7CgogICAgICAgIC8vIE5vdCBwbGFpbiBvYmplY3RzOgogICAgICAgIC8vIC0gQW55IG9iamVjdCBvciB2YWx1ZSB3aG9zZSBpbnRlcm5hbCBbW0NsYXNzXV0gcHJvcGVydHkgaXMgbm90ICJbb2JqZWN0IE9iamVjdF0iCiAgICAgICAgLy8gLSBET00gbm9kZXMKICAgICAgICAvLyAtIHdpbmRvdwogICAgICAgIGlmICh0eXBlb2Yob2JqKSAhPT0gIm9iamVjdCIgfHwgb2JqLm5vZGVUeXBlIHx8IG9iaiA9PT0gb2JqLndpbmRvdykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3ggPDIwCiAgICAgICAgLy8gVGhlIHRyeS9jYXRjaCBzdXBwcmVzc2VzIGV4Y2VwdGlvbnMgdGhyb3duIHdoZW4gYXR0ZW1wdGluZyB0byBhY2Nlc3MKICAgICAgICAvLyB0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBvZiBjZXJ0YWluIGhvc3Qgb2JqZWN0cywgaWUuIHx3aW5kb3cubG9jYXRpb258CiAgICAgICAgLy8gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9ODE0NjIyCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciAmJiAhaGFzT3duLmNhbGwob2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgImlzUHJvdG90eXBlT2YiKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB0aGUgZnVuY3Rpb24gaGFzbid0IHJldHVybmVkIGFscmVhZHksIHdlJ3JlIGNvbmZpZGVudCB0aGF0CiAgICAgICAgLy8gfG9ianwgaXMgYSBwbGFpbiBvYmplY3QsIGNyZWF0ZWQgYnkge30gb3IgY29uc3RydWN0ZWQgd2l0aCBuZXcgT2JqZWN0CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKCiAgICAvLyAgZGVlcCwgdGFyZ2V0LCBvYmplY3RzIHRvIGNvcHkgdG8gdGhlIHRhcmdldCBvYmplY3QKICAgIC8vICBUaGlzIGlzIGEgc2xpZ2h0bHkgbW9kaWZpZWQgdmVyc2lvbiBvZiB7QGxpbmsgaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS5leHRlbmQvfGpRdWVyeS5leHRlbmR9CiAgICAvLyAgZGVlcCAoYm9vbGVhbikKICAgIC8vICB0YXJnZXQgKG9iamVjdCB0byBhZGQgdG8pCiAgICAvLyAgb2JqZWN0cyAuLi4gKG9iamVjdHMgdG8gcmVjdXJzZSBhbmQgY29weSBmcm9tKQoKICAgIC8qKgogICAgKiBUaGlzIGlzIGEgc2xpZ2h0bHkgbW9kaWZpZWQgdmVyc2lvbiBvZiBodHRwOi8vYXBpLmpxdWVyeS5jb20valF1ZXJ5LmV4dGVuZC8KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuZXh0ZW5kCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZGVlcCAtIFBlcmZvcm0gYSBkZWVwIGNvcHk/CiAgICAqIEBwYXJhbSB7b2JqZWN0fSB0YXJnZXQgLSBUaGUgdGFyZ2V0IG9iamVjdCB0byBjb3B5IHRvLgogICAgKiBAcmV0dXJuIHtvYmplY3R9IFRoZSBleHRlbmRlZCBvYmplY3QuCiAgICAqLwogICAgZXh0ZW5kOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBvcHRpb25zLCBuYW1lLCBzcmMsIGNvcHksIGNvcHlJc0FycmF5LCBjbG9uZSwKICAgICAgICAgICAgdGFyZ2V0ID0gYXJndW1lbnRzWzBdIHx8IHt9LAogICAgICAgICAgICBpID0gMSwKICAgICAgICAgICAgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwKICAgICAgICAgICAgZGVlcCA9IGZhbHNlOwoKICAgICAgICAvLyBIYW5kbGUgYSBkZWVwIGNvcHkgc2l0dWF0aW9uCiAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIikKICAgICAgICB7CiAgICAgICAgICAgIGRlZXAgPSB0YXJnZXQ7CiAgICAgICAgICAgIHRhcmdldCA9IGFyZ3VtZW50c1sxXSB8fCB7fTsKICAgICAgICAgICAgLy8gc2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldAogICAgICAgICAgICBpID0gMjsKICAgICAgICB9CgogICAgICAgIC8vIGV4dGVuZCBQaGFzZXIgaWYgb25seSBvbmUgYXJndW1lbnQgaXMgcGFzc2VkCiAgICAgICAgaWYgKGxlbmd0aCA9PT0gaSkKICAgICAgICB7CiAgICAgICAgICAgIHRhcmdldCA9IHRoaXM7CiAgICAgICAgICAgIC0taTsKICAgICAgICB9CgogICAgICAgIGZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkKICAgICAgICB7CiAgICAgICAgICAgIC8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKICAgICAgICAgICAgaWYgKChvcHRpb25zID0gYXJndW1lbnRzW2ldKSAhPSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBFeHRlbmQgdGhlIGJhc2Ugb2JqZWN0CiAgICAgICAgICAgICAgICBmb3IgKG5hbWUgaW4gb3B0aW9ucykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBzcmMgPSB0YXJnZXRbbmFtZV07CiAgICAgICAgICAgICAgICAgICAgY29weSA9IG9wdGlvbnNbbmFtZV07CgogICAgICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgbmV2ZXItZW5kaW5nIGxvb3AKICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ID09PSBjb3B5KQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBSZWN1cnNlIGlmIHdlJ3JlIG1lcmdpbmcgcGxhaW4gb2JqZWN0cyBvciBhcnJheXMKICAgICAgICAgICAgICAgICAgICBpZiAoZGVlcCAmJiBjb3B5ICYmIChQaGFzZXIuVXRpbHMuaXNQbGFpbk9iamVjdChjb3B5KSB8fCAoY29weUlzQXJyYXkgPSBBcnJheS5pc0FycmF5KGNvcHkpKSkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29weUlzQXJyYXkpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvcHlJc0FycmF5ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbG9uZSA9IHNyYyAmJiBBcnJheS5pc0FycmF5KHNyYykgPyBzcmMgOiBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb25lID0gc3JjICYmIFBoYXNlci5VdGlscy5pc1BsYWluT2JqZWN0KHNyYykgPyBzcmMgOiB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTmV2ZXIgbW92ZSBvcmlnaW5hbCBvYmplY3RzLCBjbG9uZSB0aGVtCiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtuYW1lXSA9IFBoYXNlci5VdGlscy5leHRlbmQoZGVlcCwgY2xvbmUsIGNvcHkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGNvcHkgIT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtuYW1lXSA9IGNvcHk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9Cgp9OwoKZnVuY3Rpb24gSEVYdG9SR0IoaGV4KSB7CiAgICByZXR1cm4gWyhoZXggPj4gMTYgJiAweEZGKSAvIDI1NSwgKCBoZXggPj4gOCAmIDB4RkYpIC8gMjU1LCAoaGV4ICYgMHhGRikvIDI1NV07Cn0KClBJWEkuaGV4MnJnYiA9IGZ1bmN0aW9uIGhleDJyZ2IoaGV4KSB7CiAgICByZXR1cm4gWyhoZXggPj4gMTYgJiAweEZGKSAvIDI1NSwgKCBoZXggPj4gOCAmIDB4RkYpIC8gMjU1LCAoaGV4ICYgMHhGRikvIDI1NV07Cn07CgovKioKKiBBIHBvbHlmaWxsIGZvciBGdW5jdGlvbi5wcm90b3R5cGUuYmluZAoqLwppZiAodHlwZW9mIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kICE9ICdmdW5jdGlvbicpIHsKCiAgICBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCA9IChmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0aGlzQXJnKSB7CgogICAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcywgYm91bmRBcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogCiAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0ICE9ICdmdW5jdGlvbicpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGZ1bmN0aW9uIGJvdW5kKCkgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBib3VuZEFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSk7CiAgICAgICAgICAgICAgICB0YXJnZXQuYXBwbHkodGhpcyBpbnN0YW5jZW9mIGJvdW5kID8gdGhpcyA6IHRoaXNBcmcsIGFyZ3MpOwogICAgICAgICAgICB9CiAKICAgICAgICAgICAgYm91bmQucHJvdG90eXBlID0gKGZ1bmN0aW9uIEYocHJvdG8pIHsKICAgICAgICAgICAgICAgIHByb3RvICYmIChGLnByb3RvdHlwZSA9IHByb3RvKTsKCiAgICAgICAgICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgRikpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBGOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSh0YXJnZXQucHJvdG90eXBlKTsKIAogICAgICAgICAgICByZXR1cm4gYm91bmQ7CiAgICAgICAgfTsKICAgIH0pKCk7Cn0KCi8qKgoqIEEgcG9seWZpbGwgZm9yIEFycmF5LmlzQXJyYXkKKi8KaWYgKCFBcnJheS5pc0FycmF5KSB7CiAgQXJyYXkuaXNBcnJheSA9IGZ1bmN0aW9uIChhcmcpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYXJnKSA9PSAnW29iamVjdCBBcnJheV0nOwogIH07Cn0KCgoKCi8qCiAqIEEgbGlnaHRlciB2ZXJzaW9uIG9mIHRoZSByYWQgZ2wtbWF0cml4IGNyZWF0ZWQgYnkgQnJhbmRvbiBKb25lcywgQ29saW4gTWFjS2VuemllIElWCiAqIHlvdSBib3RoIHJvY2shCiAqLwoKZnVuY3Rpb24gZGV0ZXJtaW5lTWF0cml4QXJyYXlUeXBlKCkgewogICAgUElYSS5NYXRyaXggPSAodHlwZW9mIEZsb2F0MzJBcnJheSAhPT0gJ3VuZGVmaW5lZCcpID8gRmxvYXQzMkFycmF5IDogQXJyYXk7CiAgICByZXR1cm4gUElYSS5NYXRyaXg7Cn0KCmRldGVybWluZU1hdHJpeEFycmF5VHlwZSgpOwoKUElYSS5tYXQzID0ge307CgpQSVhJLm1hdDMuY3JlYXRlID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgbWF0cml4ID0gbmV3IFBJWEkuTWF0cml4KDkpOwoKICAgIG1hdHJpeFswXSA9IDE7CiAgICBtYXRyaXhbMV0gPSAwOwogICAgbWF0cml4WzJdID0gMDsKICAgIG1hdHJpeFszXSA9IDA7CiAgICBtYXRyaXhbNF0gPSAxOwogICAgbWF0cml4WzVdID0gMDsKICAgIG1hdHJpeFs2XSA9IDA7CiAgICBtYXRyaXhbN10gPSAwOwogICAgbWF0cml4WzhdID0gMTsKCiAgICByZXR1cm4gbWF0cml4Owp9OwoKClBJWEkubWF0My5pZGVudGl0eSA9IGZ1bmN0aW9uKG1hdHJpeCkKewogICAgbWF0cml4WzBdID0gMTsKICAgIG1hdHJpeFsxXSA9IDA7CiAgICBtYXRyaXhbMl0gPSAwOwogICAgbWF0cml4WzNdID0gMDsKICAgIG1hdHJpeFs0XSA9IDE7CiAgICBtYXRyaXhbNV0gPSAwOwogICAgbWF0cml4WzZdID0gMDsKICAgIG1hdHJpeFs3XSA9IDA7CiAgICBtYXRyaXhbOF0gPSAxOwoKICAgIHJldHVybiBtYXRyaXg7Cn07CgoKUElYSS5tYXQ0ID0ge307CgpQSVhJLm1hdDQuY3JlYXRlID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgbWF0cml4ID0gbmV3IFBJWEkuTWF0cml4KDE2KTsKCiAgICBtYXRyaXhbMF0gPSAxOwogICAgbWF0cml4WzFdID0gMDsKICAgIG1hdHJpeFsyXSA9IDA7CiAgICBtYXRyaXhbM10gPSAwOwogICAgbWF0cml4WzRdID0gMDsKICAgIG1hdHJpeFs1XSA9IDE7CiAgICBtYXRyaXhbNl0gPSAwOwogICAgbWF0cml4WzddID0gMDsKICAgIG1hdHJpeFs4XSA9IDA7CiAgICBtYXRyaXhbOV0gPSAwOwogICAgbWF0cml4WzEwXSA9IDE7CiAgICBtYXRyaXhbMTFdID0gMDsKICAgIG1hdHJpeFsxMl0gPSAwOwogICAgbWF0cml4WzEzXSA9IDA7CiAgICBtYXRyaXhbMTRdID0gMDsKICAgIG1hdHJpeFsxNV0gPSAxOwoKICAgIHJldHVybiBtYXRyaXg7Cn07CgpQSVhJLm1hdDMubXVsdGlwbHkgPSBmdW5jdGlvbiAobWF0LCBtYXQyLCBkZXN0KQp7CiAgICBpZiAoIWRlc3QpIHsgZGVzdCA9IG1hdDsgfQoKICAgIC8vIENhY2hlIHRoZSBtYXRyaXggdmFsdWVzIChtYWtlcyBmb3IgaHVnZSBzcGVlZCBpbmNyZWFzZXMhKQogICAgdmFyIGEwMCA9IG1hdFswXSwgYTAxID0gbWF0WzFdLCBhMDIgPSBtYXRbMl0sCiAgICAgICAgYTEwID0gbWF0WzNdLCBhMTEgPSBtYXRbNF0sIGExMiA9IG1hdFs1XSwKICAgICAgICBhMjAgPSBtYXRbNl0sIGEyMSA9IG1hdFs3XSwgYTIyID0gbWF0WzhdLAoKICAgICAgICBiMDAgPSBtYXQyWzBdLCBiMDEgPSBtYXQyWzFdLCBiMDIgPSBtYXQyWzJdLAogICAgICAgIGIxMCA9IG1hdDJbM10sIGIxMSA9IG1hdDJbNF0sIGIxMiA9IG1hdDJbNV0sCiAgICAgICAgYjIwID0gbWF0Mls2XSwgYjIxID0gbWF0Mls3XSwgYjIyID0gbWF0Mls4XTsKCiAgICBkZXN0WzBdID0gYjAwICogYTAwICsgYjAxICogYTEwICsgYjAyICogYTIwOwogICAgZGVzdFsxXSA9IGIwMCAqIGEwMSArIGIwMSAqIGExMSArIGIwMiAqIGEyMTsKICAgIGRlc3RbMl0gPSBiMDAgKiBhMDIgKyBiMDEgKiBhMTIgKyBiMDIgKiBhMjI7CgogICAgZGVzdFszXSA9IGIxMCAqIGEwMCArIGIxMSAqIGExMCArIGIxMiAqIGEyMDsKICAgIGRlc3RbNF0gPSBiMTAgKiBhMDEgKyBiMTEgKiBhMTEgKyBiMTIgKiBhMjE7CiAgICBkZXN0WzVdID0gYjEwICogYTAyICsgYjExICogYTEyICsgYjEyICogYTIyOwoKICAgIGRlc3RbNl0gPSBiMjAgKiBhMDAgKyBiMjEgKiBhMTAgKyBiMjIgKiBhMjA7CiAgICBkZXN0WzddID0gYjIwICogYTAxICsgYjIxICogYTExICsgYjIyICogYTIxOwogICAgZGVzdFs4XSA9IGIyMCAqIGEwMiArIGIyMSAqIGExMiArIGIyMiAqIGEyMjsKCiAgICByZXR1cm4gZGVzdDsKfTsKClBJWEkubWF0My5jbG9uZSA9IGZ1bmN0aW9uKG1hdCkKewogICAgdmFyIG1hdHJpeCA9IG5ldyBQSVhJLk1hdHJpeCg5KTsKCiAgICBtYXRyaXhbMF0gPSBtYXRbMF07CiAgICBtYXRyaXhbMV0gPSBtYXRbMV07CiAgICBtYXRyaXhbMl0gPSBtYXRbMl07CiAgICBtYXRyaXhbM10gPSBtYXRbM107CiAgICBtYXRyaXhbNF0gPSBtYXRbNF07CiAgICBtYXRyaXhbNV0gPSBtYXRbNV07CiAgICBtYXRyaXhbNl0gPSBtYXRbNl07CiAgICBtYXRyaXhbN10gPSBtYXRbN107CiAgICBtYXRyaXhbOF0gPSBtYXRbOF07CgogICAgcmV0dXJuIG1hdHJpeDsKfTsKClBJWEkubWF0My50cmFuc3Bvc2UgPSBmdW5jdGlvbiAobWF0LCBkZXN0KQp7CiAgICAvLyBJZiB3ZSBhcmUgdHJhbnNwb3Npbmcgb3Vyc2VsdmVzIHdlIGNhbiBza2lwIGEgZmV3IHN0ZXBzIGJ1dCBoYXZlIHRvIGNhY2hlIHNvbWUgdmFsdWVzCiAgICBpZiAoIWRlc3QgfHwgbWF0ID09PSBkZXN0KSB7CiAgICAgICAgdmFyIGEwMSA9IG1hdFsxXSwgYTAyID0gbWF0WzJdLAogICAgICAgICAgICBhMTIgPSBtYXRbNV07CgogICAgICAgIG1hdFsxXSA9IG1hdFszXTsKICAgICAgICBtYXRbMl0gPSBtYXRbNl07CiAgICAgICAgbWF0WzNdID0gYTAxOwogICAgICAgIG1hdFs1XSA9IG1hdFs3XTsKICAgICAgICBtYXRbNl0gPSBhMDI7CiAgICAgICAgbWF0WzddID0gYTEyOwogICAgICAgIHJldHVybiBtYXQ7CiAgICB9CgogICAgZGVzdFswXSA9IG1hdFswXTsKICAgIGRlc3RbMV0gPSBtYXRbM107CiAgICBkZXN0WzJdID0gbWF0WzZdOwogICAgZGVzdFszXSA9IG1hdFsxXTsKICAgIGRlc3RbNF0gPSBtYXRbNF07CiAgICBkZXN0WzVdID0gbWF0WzddOwogICAgZGVzdFs2XSA9IG1hdFsyXTsKICAgIGRlc3RbN10gPSBtYXRbNV07CiAgICBkZXN0WzhdID0gbWF0WzhdOwogICAgcmV0dXJuIGRlc3Q7Cn07CgpQSVhJLm1hdDMudG9NYXQ0ID0gZnVuY3Rpb24gKG1hdCwgZGVzdCkKewogICAgaWYgKCFkZXN0KSB7IGRlc3QgPSBQSVhJLm1hdDQuY3JlYXRlKCk7IH0KCiAgICBkZXN0WzE1XSA9IDE7CiAgICBkZXN0WzE0XSA9IDA7CiAgICBkZXN0WzEzXSA9IDA7CiAgICBkZXN0WzEyXSA9IDA7CgogICAgZGVzdFsxMV0gPSAwOwogICAgZGVzdFsxMF0gPSBtYXRbOF07CiAgICBkZXN0WzldID0gbWF0WzddOwogICAgZGVzdFs4XSA9IG1hdFs2XTsKCiAgICBkZXN0WzddID0gMDsKICAgIGRlc3RbNl0gPSBtYXRbNV07CiAgICBkZXN0WzVdID0gbWF0WzRdOwogICAgZGVzdFs0XSA9IG1hdFszXTsKCiAgICBkZXN0WzNdID0gMDsKICAgIGRlc3RbMl0gPSBtYXRbMl07CiAgICBkZXN0WzFdID0gbWF0WzFdOwogICAgZGVzdFswXSA9IG1hdFswXTsKCiAgICByZXR1cm4gZGVzdDsKfTsKCgovLy8vLwoKClBJWEkubWF0NC5jcmVhdGUgPSBmdW5jdGlvbigpCnsKICAgIHZhciBtYXRyaXggPSBuZXcgUElYSS5NYXRyaXgoMTYpOwoKICAgIG1hdHJpeFswXSA9IDE7CiAgICBtYXRyaXhbMV0gPSAwOwogICAgbWF0cml4WzJdID0gMDsKICAgIG1hdHJpeFszXSA9IDA7CiAgICBtYXRyaXhbNF0gPSAwOwogICAgbWF0cml4WzVdID0gMTsKICAgIG1hdHJpeFs2XSA9IDA7CiAgICBtYXRyaXhbN10gPSAwOwogICAgbWF0cml4WzhdID0gMDsKICAgIG1hdHJpeFs5XSA9IDA7CiAgICBtYXRyaXhbMTBdID0gMTsKICAgIG1hdHJpeFsxMV0gPSAwOwogICAgbWF0cml4WzEyXSA9IDA7CiAgICBtYXRyaXhbMTNdID0gMDsKICAgIG1hdHJpeFsxNF0gPSAwOwogICAgbWF0cml4WzE1XSA9IDE7CgogICAgcmV0dXJuIG1hdHJpeDsKfTsKClBJWEkubWF0NC50cmFuc3Bvc2UgPSBmdW5jdGlvbiAobWF0LCBkZXN0KQp7CiAgICAvLyBJZiB3ZSBhcmUgdHJhbnNwb3Npbmcgb3Vyc2VsdmVzIHdlIGNhbiBza2lwIGEgZmV3IHN0ZXBzIGJ1dCBoYXZlIHRvIGNhY2hlIHNvbWUgdmFsdWVzCiAgICBpZiAoIWRlc3QgfHwgbWF0ID09PSBkZXN0KQogICAgewogICAgICAgIHZhciBhMDEgPSBtYXRbMV0sIGEwMiA9IG1hdFsyXSwgYTAzID0gbWF0WzNdLAogICAgICAgICAgICBhMTIgPSBtYXRbNl0sIGExMyA9IG1hdFs3XSwKICAgICAgICAgICAgYTIzID0gbWF0WzExXTsKCiAgICAgICAgbWF0WzFdID0gbWF0WzRdOwogICAgICAgIG1hdFsyXSA9IG1hdFs4XTsKICAgICAgICBtYXRbM10gPSBtYXRbMTJdOwogICAgICAgIG1hdFs0XSA9IGEwMTsKICAgICAgICBtYXRbNl0gPSBtYXRbOV07CiAgICAgICAgbWF0WzddID0gbWF0WzEzXTsKICAgICAgICBtYXRbOF0gPSBhMDI7CiAgICAgICAgbWF0WzldID0gYTEyOwogICAgICAgIG1hdFsxMV0gPSBtYXRbMTRdOwogICAgICAgIG1hdFsxMl0gPSBhMDM7CiAgICAgICAgbWF0WzEzXSA9IGExMzsKICAgICAgICBtYXRbMTRdID0gYTIzOwogICAgICAgIHJldHVybiBtYXQ7CiAgICB9CgogICAgZGVzdFswXSA9IG1hdFswXTsKICAgIGRlc3RbMV0gPSBtYXRbNF07CiAgICBkZXN0WzJdID0gbWF0WzhdOwogICAgZGVzdFszXSA9IG1hdFsxMl07CiAgICBkZXN0WzRdID0gbWF0WzFdOwogICAgZGVzdFs1XSA9IG1hdFs1XTsKICAgIGRlc3RbNl0gPSBtYXRbOV07CiAgICBkZXN0WzddID0gbWF0WzEzXTsKICAgIGRlc3RbOF0gPSBtYXRbMl07CiAgICBkZXN0WzldID0gbWF0WzZdOwogICAgZGVzdFsxMF0gPSBtYXRbMTBdOwogICAgZGVzdFsxMV0gPSBtYXRbMTRdOwogICAgZGVzdFsxMl0gPSBtYXRbM107CiAgICBkZXN0WzEzXSA9IG1hdFs3XTsKICAgIGRlc3RbMTRdID0gbWF0WzExXTsKICAgIGRlc3RbMTVdID0gbWF0WzE1XTsKICAgIHJldHVybiBkZXN0Owp9OwoKUElYSS5tYXQ0Lm11bHRpcGx5ID0gZnVuY3Rpb24gKG1hdCwgbWF0MiwgZGVzdCkKewogICAgaWYgKCFkZXN0KSB7IGRlc3QgPSBtYXQ7IH0KCiAgICAvLyBDYWNoZSB0aGUgbWF0cml4IHZhbHVlcyAobWFrZXMgZm9yIGh1Z2Ugc3BlZWQgaW5jcmVhc2VzISkKICAgIHZhciBhMDAgPSBtYXRbIDBdLCBhMDEgPSBtYXRbIDFdLCBhMDIgPSBtYXRbIDJdLCBhMDMgPSBtYXRbM107CiAgICB2YXIgYTEwID0gbWF0WyA0XSwgYTExID0gbWF0WyA1XSwgYTEyID0gbWF0WyA2XSwgYTEzID0gbWF0WzddOwogICAgdmFyIGEyMCA9IG1hdFsgOF0sIGEyMSA9IG1hdFsgOV0sIGEyMiA9IG1hdFsxMF0sIGEyMyA9IG1hdFsxMV07CiAgICB2YXIgYTMwID0gbWF0WzEyXSwgYTMxID0gbWF0WzEzXSwgYTMyID0gbWF0WzE0XSwgYTMzID0gbWF0WzE1XTsKCiAgICAvLyBDYWNoZSBvbmx5IHRoZSBjdXJyZW50IGxpbmUgb2YgdGhlIHNlY29uZCBtYXRyaXgKICAgIHZhciBiMCAgPSBtYXQyWzBdLCBiMSA9IG1hdDJbMV0sIGIyID0gbWF0MlsyXSwgYjMgPSBtYXQyWzNdOwogICAgZGVzdFswXSA9IGIwKmEwMCArIGIxKmExMCArIGIyKmEyMCArIGIzKmEzMDsKICAgIGRlc3RbMV0gPSBiMCphMDEgKyBiMSphMTEgKyBiMiphMjEgKyBiMyphMzE7CiAgICBkZXN0WzJdID0gYjAqYTAyICsgYjEqYTEyICsgYjIqYTIyICsgYjMqYTMyOwogICAgZGVzdFszXSA9IGIwKmEwMyArIGIxKmExMyArIGIyKmEyMyArIGIzKmEzMzsKCiAgICBiMCA9IG1hdDJbNF07CiAgICBiMSA9IG1hdDJbNV07CiAgICBiMiA9IG1hdDJbNl07CiAgICBiMyA9IG1hdDJbN107CiAgICBkZXN0WzRdID0gYjAqYTAwICsgYjEqYTEwICsgYjIqYTIwICsgYjMqYTMwOwogICAgZGVzdFs1XSA9IGIwKmEwMSArIGIxKmExMSArIGIyKmEyMSArIGIzKmEzMTsKICAgIGRlc3RbNl0gPSBiMCphMDIgKyBiMSphMTIgKyBiMiphMjIgKyBiMyphMzI7CiAgICBkZXN0WzddID0gYjAqYTAzICsgYjEqYTEzICsgYjIqYTIzICsgYjMqYTMzOwoKICAgIGIwID0gbWF0Mls4XTsKICAgIGIxID0gbWF0Mls5XTsKICAgIGIyID0gbWF0MlsxMF07CiAgICBiMyA9IG1hdDJbMTFdOwogICAgZGVzdFs4XSA9IGIwKmEwMCArIGIxKmExMCArIGIyKmEyMCArIGIzKmEzMDsKICAgIGRlc3RbOV0gPSBiMCphMDEgKyBiMSphMTEgKyBiMiphMjEgKyBiMyphMzE7CiAgICBkZXN0WzEwXSA9IGIwKmEwMiArIGIxKmExMiArIGIyKmEyMiArIGIzKmEzMjsKICAgIGRlc3RbMTFdID0gYjAqYTAzICsgYjEqYTEzICsgYjIqYTIzICsgYjMqYTMzOwoKICAgIGIwID0gbWF0MlsxMl07CiAgICBiMSA9IG1hdDJbMTNdOwogICAgYjIgPSBtYXQyWzE0XTsKICAgIGIzID0gbWF0MlsxNV07CiAgICBkZXN0WzEyXSA9IGIwKmEwMCArIGIxKmExMCArIGIyKmEyMCArIGIzKmEzMDsKICAgIGRlc3RbMTNdID0gYjAqYTAxICsgYjEqYTExICsgYjIqYTIxICsgYjMqYTMxOwogICAgZGVzdFsxNF0gPSBiMCphMDIgKyBiMSphMTIgKyBiMiphMjIgKyBiMyphMzI7CiAgICBkZXN0WzE1XSA9IGIwKmEwMyArIGIxKmExMyArIGIyKmEyMyArIGIzKmEzMzsKCiAgICByZXR1cm4gZGVzdDsKfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogVGhlIFBvaW50IG9iamVjdCByZXByZXNlbnRzIGEgbG9jYXRpb24gaW4gYSB0d28tZGltZW5zaW9uYWwgY29vcmRpbmF0ZSBzeXN0ZW0sIHdoZXJlIHggcmVwcmVzZW50cyB0aGUgaG9yaXpvbnRhbCBheGlzIGFuZCB5IHJlcHJlc2VudHMgdGhlIHZlcnRpY2FsIGF4aXMuCiAqCiAqIEBjbGFzcyBQb2ludAogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHgge051bWJlcn0gcG9zaXRpb24gb2YgdGhlIHBvaW50CiAqIEBwYXJhbSB5IHtOdW1iZXJ9IHBvc2l0aW9uIG9mIHRoZSBwb2ludAogKi8KUElYSS5Qb2ludCA9IGZ1bmN0aW9uKHgsIHkpCnsKICAgIC8qKgogICAgICogQHByb3BlcnR5IHgKICAgICAqIEB0eXBlIE51bWJlcgogICAgICogQGRlZmF1bHQgMAogICAgICovCiAgICB0aGlzLnggPSB4IHx8IDA7CgogICAgLyoqCiAgICAgKiBAcHJvcGVydHkgeQogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KICAgIHRoaXMueSA9IHkgfHwgMDsKfTsKCi8qKgogKiBDcmVhdGVzIGEgY2xvbmUgb2YgdGhpcyBwb2ludAogKgogKiBAbWV0aG9kIGNsb25lCiAqIEByZXR1cm4ge1BvaW50fSBhIGNvcHkgb2YgdGhlIHBvaW50CiAqLwpQSVhJLlBvaW50LnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkKewogICAgcmV0dXJuIG5ldyBQSVhJLlBvaW50KHRoaXMueCwgdGhpcy55KTsKfTsKCi8vIGNvbnN0cnVjdG9yClBJWEkuUG9pbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5Qb2ludDsKCgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLwogKi8KCi8qKgogKiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBpcyBhbiBhcmVhIGRlZmluZWQgYnkgaXRzIHBvc2l0aW9uLCBhcyBpbmRpY2F0ZWQgYnkgaXRzIHRvcC1sZWZ0IGNvcm5lciBwb2ludCAoeCwgeSkgYW5kIGJ5IGl0cyB3aWR0aCBhbmQgaXRzIGhlaWdodC4KICoKICogQGNsYXNzIFJlY3RhbmdsZQogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHgge051bWJlcn0gVGhlIFggY29vcmQgb2YgdGhlIHVwcGVyLWxlZnQgY29ybmVyIG9mIHRoZSByZWN0YW5nbGUKICogQHBhcmFtIHkge051bWJlcn0gVGhlIFkgY29vcmQgb2YgdGhlIHVwcGVyLWxlZnQgY29ybmVyIG9mIHRoZSByZWN0YW5nbGUKICogQHBhcmFtIHdpZHRoIHtOdW1iZXJ9IFRoZSBvdmVyYWxsIHdpZHRoIG9mIHRoaXMgcmVjdGFuZ2xlCiAqIEBwYXJhbSBoZWlnaHQge051bWJlcn0gVGhlIG92ZXJhbGwgaGVpZ2h0IG9mIHRoaXMgcmVjdGFuZ2xlCiAqLwpQSVhJLlJlY3RhbmdsZSA9IGZ1bmN0aW9uKHgsIHksIHdpZHRoLCBoZWlnaHQpCnsKICAgIC8qKgogICAgICogQHByb3BlcnR5IHgKICAgICAqIEB0eXBlIE51bWJlcgogICAgICogQGRlZmF1bHQgMAogICAgICovCiAgICB0aGlzLnggPSB4IHx8IDA7CgogICAgLyoqCiAgICAgKiBAcHJvcGVydHkgeQogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KICAgIHRoaXMueSA9IHkgfHwgMDsKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB3aWR0aAogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KICAgIHRoaXMud2lkdGggPSB3aWR0aCB8fCAwOwoKICAgIC8qKgogICAgICogQHByb3BlcnR5IGhlaWdodAogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IDA7Cn07CgovKioKICogQ3JlYXRlcyBhIGNsb25lIG9mIHRoaXMgUmVjdGFuZ2xlCiAqCiAqIEBtZXRob2QgY2xvbmUKICogQHJldHVybiB7UmVjdGFuZ2xlfSBhIGNvcHkgb2YgdGhlIHJlY3RhbmdsZQogKi8KUElYSS5SZWN0YW5nbGUucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKQp7CiAgICByZXR1cm4gbmV3IFBJWEkuUmVjdGFuZ2xlKHRoaXMueCwgdGhpcy55LCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7Cn07CgovKioKICogQ2hlY2tzIGlmIHRoZSB4LCBhbmQgeSBjb29yZHMgcGFzc2VkIHRvIHRoaXMgZnVuY3Rpb24gYXJlIGNvbnRhaW5lZCB3aXRoaW4gdGhpcyBSZWN0YW5nbGUKICoKICogQG1ldGhvZCBjb250YWlucwogKiBAcGFyYW0geCB7TnVtYmVyfSBUaGUgWCBjb29yZCBvZiB0aGUgcG9pbnQgdG8gdGVzdAogKiBAcGFyYW0geSB7TnVtYmVyfSBUaGUgWSBjb29yZCBvZiB0aGUgcG9pbnQgdG8gdGVzdAogKiBAcmV0dXJuIHtCb29sZWFufSBpZiB0aGUgeC95IGNvb3JkcyBhcmUgd2l0aGluIHRoaXMgUmVjdGFuZ2xlCiAqLwpQSVhJLlJlY3RhbmdsZS5wcm90b3R5cGUuY29udGFpbnMgPSBmdW5jdGlvbih4LCB5KQp7CiAgICBpZih0aGlzLndpZHRoIDw9IDAgfHwgdGhpcy5oZWlnaHQgPD0gMCkKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgdmFyIHgxID0gdGhpcy54OwogICAgaWYoeCA+PSB4MSAmJiB4IDw9IHgxICsgdGhpcy53aWR0aCkKICAgIHsKICAgICAgICB2YXIgeTEgPSB0aGlzLnk7CgogICAgICAgIGlmKHkgPj0geTEgJiYgeSA8PSB5MSArIHRoaXMuaGVpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiBmYWxzZTsKfTsKCi8vIGNvbnN0cnVjdG9yClBJWEkuUmVjdGFuZ2xlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuUmVjdGFuZ2xlOwoKCi8qKgogKiBAYXV0aG9yIEFkcmllbiBCcmF1bHQgPGFkcmllbi5icmF1bHRAZ21haWwuY29tPgogKi8KCi8qKgogKiBAY2xhc3MgUG9seWdvbgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHBvaW50cyoge0FycmF5PFBvaW50PnxBcnJheTxOdW1iZXI+fFBvaW50Li4ufE51bWJlci4uLn0gVGhpcyBjYW4gYmUgYW4gYXJyYXkgb2YgUG9pbnRzIHRoYXQgZm9ybSB0aGUgcG9seWdvbiwKICogICAgICBhIGZsYXQgYXJyYXkgb2YgbnVtYmVycyB0aGF0IHdpbGwgYmUgaW50ZXJwcmV0ZWQgYXMgW3gseSwgeCx5LCAuLi5dLCBvciB0aGUgYXJndW1lbnRzIHBhc3NlZCBjYW4gYmUKICogICAgICBhbGwgdGhlIHBvaW50cyBvZiB0aGUgcG9seWdvbiBlLmcuIGBuZXcgUElYSS5Qb2x5Z29uKG5ldyBQSVhJLlBvaW50KCksIG5ldyBQSVhJLlBvaW50KCksIC4uLilgLCBvciB0aGUKICogICAgICBhcmd1bWVudHMgcGFzc2VkIGNhbiBiZSBmbGF0IHgseSB2YWx1ZXMgZS5nLiBgbmV3IFBJWEkuUG9seWdvbih4LHksIHgseSwgeCx5LCAuLi4pYCB3aGVyZSBgeGAgYW5kIGB5YCBhcmUKICogICAgICBOdW1iZXJzLgogKi8KUElYSS5Qb2x5Z29uID0gZnVuY3Rpb24ocG9pbnRzKQp7CiAgICAvL2lmIHBvaW50cyBpc24ndCBhbiBhcnJheSwgdXNlIGFyZ3VtZW50cyBhcyB0aGUgYXJyYXkKICAgIGlmKCEocG9pbnRzIGluc3RhbmNlb2YgQXJyYXkpKQogICAgICAgIHBvaW50cyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CgogICAgLy9pZiB0aGlzIGlzIGEgZmxhdCBhcnJheSBvZiBudW1iZXJzLCBjb252ZXJ0IGl0IHRvIHBvaW50cwogICAgaWYodHlwZW9mIHBvaW50c1swXSA9PT0gJ251bWJlcicpIHsKICAgICAgICB2YXIgcCA9IFtdOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGlsID0gcG9pbnRzLmxlbmd0aDsgaSA8IGlsOyBpKz0yKSB7CiAgICAgICAgICAgIHAucHVzaCgKICAgICAgICAgICAgICAgIG5ldyBQSVhJLlBvaW50KHBvaW50c1tpXSwgcG9pbnRzW2kgKyAxXSkKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHBvaW50cyA9IHA7CiAgICB9CgogICAgdGhpcy5wb2ludHMgPSBwb2ludHM7Cn07CgovKioKICogQ3JlYXRlcyBhIGNsb25lIG9mIHRoaXMgcG9seWdvbgogKgogKiBAbWV0aG9kIGNsb25lCiAqIEByZXR1cm4ge1BvbHlnb259IGEgY29weSBvZiB0aGUgcG9seWdvbgogKi8KUElYSS5Qb2x5Z29uLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkKewogICAgdmFyIHBvaW50cyA9IFtdOwogICAgZm9yICh2YXIgaT0wOyBpPHRoaXMucG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcG9pbnRzLnB1c2godGhpcy5wb2ludHNbaV0uY2xvbmUoKSk7CiAgICB9CgogICAgcmV0dXJuIG5ldyBQSVhJLlBvbHlnb24ocG9pbnRzKTsKfTsKCi8qKgogKiBDaGVja3MgaWYgdGhlIHgsIGFuZCB5IGNvb3JkcyBwYXNzZWQgdG8gdGhpcyBmdW5jdGlvbiBhcmUgY29udGFpbmVkIHdpdGhpbiB0aGlzIHBvbHlnb24KICoKICogQG1ldGhvZCBjb250YWlucwogKiBAcGFyYW0geCB7TnVtYmVyfSBUaGUgWCBjb29yZCBvZiB0aGUgcG9pbnQgdG8gdGVzdAogKiBAcGFyYW0geSB7TnVtYmVyfSBUaGUgWSBjb29yZCBvZiB0aGUgcG9pbnQgdG8gdGVzdAogKiBAcmV0dXJuIHtCb29sZWFufSBpZiB0aGUgeC95IGNvb3JkcyBhcmUgd2l0aGluIHRoaXMgcG9seWdvbgogKi8KUElYSS5Qb2x5Z29uLnByb3RvdHlwZS5jb250YWlucyA9IGZ1bmN0aW9uKHgsIHkpCnsKICAgIHZhciBpbnNpZGUgPSBmYWxzZTsKCiAgICAvLyB1c2Ugc29tZSByYXljYXN0aW5nIHRvIHRlc3QgaGl0cwogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3N1YnN0YWNrL3BvaW50LWluLXBvbHlnb24vYmxvYi9tYXN0ZXIvaW5kZXguanMKICAgIGZvcih2YXIgaSA9IDAsIGogPSB0aGlzLnBvaW50cy5sZW5ndGggLSAxOyBpIDwgdGhpcy5wb2ludHMubGVuZ3RoOyBqID0gaSsrKSB7CiAgICAgICAgdmFyIHhpID0gdGhpcy5wb2ludHNbaV0ueCwgeWkgPSB0aGlzLnBvaW50c1tpXS55LAogICAgICAgICAgICB4aiA9IHRoaXMucG9pbnRzW2pdLngsIHlqID0gdGhpcy5wb2ludHNbal0ueSwKICAgICAgICAgICAgaW50ZXJzZWN0ID0gKCh5aSA+IHkpICE9PSAoeWogPiB5KSkgJiYgKHggPCAoeGogLSB4aSkgKiAoeSAtIHlpKSAvICh5aiAtIHlpKSArIHhpKTsKCiAgICAgICAgaWYoaW50ZXJzZWN0KSBpbnNpZGUgPSAhaW5zaWRlOwogICAgfQoKICAgIHJldHVybiBpbnNpZGU7Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlBvbHlnb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5Qb2x5Z29uOwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiBUaGUgYmFzZSBjbGFzcyBmb3IgYWxsIG9iamVjdHMgdGhhdCBhcmUgcmVuZGVyZWQgb24gdGhlIHNjcmVlbi4KICoKICogQGNsYXNzIERpc3BsYXlPYmplY3QKICogQGNvbnN0cnVjdG9yCiAqLwpQSVhJLkRpc3BsYXlPYmplY3QgPSBmdW5jdGlvbigpCnsKICAgIHRoaXMubGFzdCA9IHRoaXM7CiAgICB0aGlzLmZpcnN0ID0gdGhpczsKICAgIC8qKgogICAgICogVGhlIGNvb3JkaW5hdGUgb2YgdGhlIG9iamVjdCByZWxhdGl2ZSB0byB0aGUgbG9jYWwgY29vcmRpbmF0ZXMgb2YgdGhlIHBhcmVudC4KICAgICAqCiAgICAgKiBAcHJvcGVydHkgcG9zaXRpb24KICAgICAqIEB0eXBlIFBvaW50CiAgICAgKi8KICAgIHRoaXMucG9zaXRpb24gPSBuZXcgUElYSS5Qb2ludCgpOwoKICAgIC8qKgogICAgICogVGhlIHNjYWxlIGZhY3RvciBvZiB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBzY2FsZQogICAgICogQHR5cGUgUG9pbnQKICAgICAqLwogICAgdGhpcy5zY2FsZSA9IG5ldyBQSVhJLlBvaW50KDEsMSk7Ly97eDoxLCB5OjF9OwoKICAgIC8qKgogICAgICogVGhlIHBpdm90IHBvaW50IG9mIHRoZSBkaXNwbGF5T2JqZWN0IHRoYXQgaXQgcm90YXRlcyBhcm91bmQKICAgICAqCiAgICAgKiBAcHJvcGVydHkgcGl2b3QKICAgICAqIEB0eXBlIFBvaW50CiAgICAgKi8KICAgIHRoaXMucGl2b3QgPSBuZXcgUElYSS5Qb2ludCgwLDApOwoKICAgIC8qKgogICAgICogVGhlIHJvdGF0aW9uIG9mIHRoZSBvYmplY3QgaW4gcmFkaWFucy4KICAgICAqCiAgICAgKiBAcHJvcGVydHkgcm90YXRpb24KICAgICAqIEB0eXBlIE51bWJlcgogICAgICovCiAgICB0aGlzLnJvdGF0aW9uID0gMDsKCiAgICAvKioKICAgICAqIFRoZSBvcGFjaXR5IG9mIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQHByb3BlcnR5IGFscGhhCiAgICAgKiBAdHlwZSBOdW1iZXIKICAgICAqLwogICAgdGhpcy5hbHBoYSA9IDE7CgogICAgLyoqCiAgICAgKiBUaGUgdmlzaWJpbGl0eSBvZiB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBwcm9wZXJ0eSB2aXNpYmxlCiAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgKi8KICAgIHRoaXMudmlzaWJsZSA9IHRydWU7CgogICAgLyoqCiAgICAgKiBUaGlzIGlzIHRoZSBkZWZpbmVkIGFyZWEgdGhhdCB3aWxsIHBpY2sgdXAgbW91c2UgLyB0b3VjaCBldmVudHMuIEl0IGlzIG51bGwgYnkgZGVmYXVsdC4KICAgICAqIFNldHRpbmcgaXQgaXMgYSBuZWF0IHdheSBvZiBvcHRpbWlzaW5nIHRoZSBoaXRUZXN0IGZ1bmN0aW9uIHRoYXQgdGhlIGludGVyYWN0aW9uTWFuYWdlciB3aWxsIHVzZSAoYXMgaXQgd2lsbCBub3QgbmVlZCB0byBoaXQgdGVzdCBhbGwgdGhlIGNoaWxkcmVuKQogICAgICoKICAgICAqIEBwcm9wZXJ0eSBoaXRBcmVhCiAgICAgKiBAdHlwZSBSZWN0YW5nbGV8Q2lyY2xlfEVsbGlwc2V8UG9seWdvbgogICAgICovCiAgICB0aGlzLmhpdEFyZWEgPSBudWxsOwoKICAgIC8qKgogICAgICogVGhpcyBpcyB1c2VkIHRvIGluZGljYXRlIGlmIHRoZSBkaXNwbGF5T2JqZWN0IHNob3VsZCBkaXNwbGF5IGEgbW91c2UgaGFuZCBjdXJzb3Igb24gcm9sbG92ZXIKICAgICAqCiAgICAgKiBAcHJvcGVydHkgYnV0dG9uTW9kZQogICAgICogQHR5cGUgQm9vbGVhbgogICAgICovCiAgICB0aGlzLmJ1dHRvbk1vZGUgPSBmYWxzZTsKCiAgICAvKioKICAgICAqIENhbiB0aGlzIG9iamVjdCBiZSByZW5kZXJlZAogICAgICoKICAgICAqIEBwcm9wZXJ0eSByZW5kZXJhYmxlCiAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgKi8KICAgIHRoaXMucmVuZGVyYWJsZSA9IGZhbHNlOwoKICAgIC8qKgogICAgICogW3JlYWQtb25seV0gVGhlIGRpc3BsYXkgb2JqZWN0IGNvbnRhaW5lciB0aGF0IGNvbnRhaW5zIHRoaXMgZGlzcGxheSBvYmplY3QuCiAgICAgKgogICAgICogQHByb3BlcnR5IHBhcmVudAogICAgICogQHR5cGUgRGlzcGxheU9iamVjdENvbnRhaW5lcgogICAgICogQHJlYWRPbmx5CiAgICAgKi8KICAgIHRoaXMucGFyZW50ID0gbnVsbDsKCiAgICAvKioKICAgICAqIFtyZWFkLW9ubHldIFRoZSBzdGFnZSB0aGUgZGlzcGxheSBvYmplY3QgaXMgY29ubmVjdGVkIHRvLCBvciB1bmRlZmluZWQgaWYgaXQgaXMgbm90IGNvbm5lY3RlZCB0byB0aGUgc3RhZ2UuCiAgICAgKgogICAgICogQHByb3BlcnR5IHN0YWdlCiAgICAgKiBAdHlwZSBTdGFnZQogICAgICogQHJlYWRPbmx5CiAgICAgKi8KICAgIHRoaXMuc3RhZ2UgPSBudWxsOwoKICAgIC8qKgogICAgICogW3JlYWQtb25seV0gVGhlIG11bHRpcGxpZWQgYWxwaGEgb2YgdGhlIGRpc3BsYXlvYmplY3QKICAgICAqCiAgICAgKiBAcHJvcGVydHkgd29ybGRBbHBoYQogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKiBAcmVhZE9ubHkKICAgICAqLwogICAgdGhpcy53b3JsZEFscGhhID0gMTsKCiAgICAvKioKICAgICAqIFtyZWFkLW9ubHldIFdoZXRoZXIgb3Igbm90IHRoZSBvYmplY3QgaXMgaW50ZXJhY3RpdmUsIGRvIG5vdCB0b2dnbGUgZGlyZWN0bHkhIHVzZSB0aGUgYGludGVyYWN0aXZlYCBwcm9wZXJ0eQogICAgICoKICAgICAqIEBwcm9wZXJ0eSBfaW50ZXJhY3RpdmUKICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAqIEByZWFkT25seQogICAgICogQHByaXZhdGUKICAgICAqLwogICAgdGhpcy5faW50ZXJhY3RpdmUgPSBmYWxzZTsKCiAgICB0aGlzLmRlZmF1bHRDdXJzb3IgPSAncG9pbnRlcic7CgogICAgLyoqCiAgICAgKiBbcmVhZC1vbmx5XSBDdXJyZW50IHRyYW5zZm9ybSBvZiB0aGUgb2JqZWN0IGJhc2VkIG9uIHdvcmxkIChwYXJlbnQpIGZhY3RvcnMKICAgICAqCiAgICAgKiBAcHJvcGVydHkgd29ybGRUcmFuc2Zvcm0KICAgICAqIEB0eXBlIE1hdDMKICAgICAqIEByZWFkT25seQogICAgICogQHByaXZhdGUKICAgICAqLwogICAgdGhpcy53b3JsZFRyYW5zZm9ybSA9IFBJWEkubWF0My5jcmVhdGUoKTsgLy9tYXQzLmlkZW50aXR5KCk7CgogICAgLyoqCiAgICAgKiBbcmVhZC1vbmx5XSBDdXJyZW50IHRyYW5zZm9ybSBvZiB0aGUgb2JqZWN0IGxvY2FsbHkKICAgICAqCiAgICAgKiBAcHJvcGVydHkgbG9jYWxUcmFuc2Zvcm0KICAgICAqIEB0eXBlIE1hdDMKICAgICAqIEByZWFkT25seQogICAgICogQHByaXZhdGUKICAgICAqLwogICAgdGhpcy5sb2NhbFRyYW5zZm9ybSA9IFBJWEkubWF0My5jcmVhdGUoKTsgLy9tYXQzLmlkZW50aXR5KCk7CgogICAgLyoqCiAgICAgKiBbTllJXSBVbmtvd24KICAgICAqCiAgICAgKiBAcHJvcGVydHkgY29sb3IKICAgICAqIEB0eXBlIEFycmF5PD4KICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHRoaXMuY29sb3IgPSBbXTsKCiAgICAvKioKICAgICAqIFtOWUldIEhvbGRzIHdoZXRoZXIgb3Igbm90IHRoaXMgb2JqZWN0IGlzIGR5bmFtaWMsIGZvciByZW5kZXJpbmcgb3B0aW1pemF0aW9uCiAgICAgKgogICAgICogQHByb3BlcnR5IGR5bmFtaWMKICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHRoaXMuZHluYW1pYyA9IHRydWU7CgogICAgLy8gY2hhY2ggdGhhdCBwdXBweSEKICAgIHRoaXMuX3NyID0gMDsKICAgIHRoaXMuX2NyID0gMTsKCgogICAgdGhpcy5maWx0ZXJBcmVhID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsMCwxLDEpOwoKICAgIC8qCiAgICAgKiBNT1VTRSBDYWxsYmFja3MKICAgICAqLwoKICAgIC8qKgogICAgICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlcnMgY2xpY2tzIG9uIHRoZSBkaXNwbGF5T2JqZWN0IHdpdGggdGhlaXIgbW91c2UKICAgICAqIEBtZXRob2QgY2xpY2sKICAgICAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KICAgICAqLwoKICAgIC8qKgogICAgICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlciBjbGlja3MgdGhlIG1vdXNlIGRvd24gb3ZlciB0aGUgc3ByaXRlCiAgICAgKiBAbWV0aG9kIG1vdXNlZG93bgogICAgICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQogICAgICovCgogICAgLyoqCiAgICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VyIHJlbGVhc2VzIHRoZSBtb3VzZSB0aGF0IHdhcyBvdmVyIHRoZSBkaXNwbGF5T2JqZWN0CiAgICAgKiBmb3IgdGhpcyBjYWxsYmFjayB0byBiZSBmaXJlZCB0aGUgbW91c2UgbXVzdCBoYXZlIGJlZW4gcHJlc3NlZCBkb3duIG92ZXIgdGhlIGRpc3BsYXlPYmplY3QKICAgICAqIEBtZXRob2QgbW91c2V1cAogICAgICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQogICAgICovCgogICAgLyoqCiAgICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VyIHJlbGVhc2VzIHRoZSBtb3VzZSB0aGF0IHdhcyBvdmVyIHRoZSBkaXNwbGF5T2JqZWN0IGJ1dCBpcyBubyBsb25nZXIgb3ZlciB0aGUgZGlzcGxheU9iamVjdAogICAgICogZm9yIHRoaXMgY2FsbGJhY2sgdG8gYmUgZmlyZWQsIFRoZSB0b3VjaCBtdXN0IGhhdmUgc3RhcnRlZCBvdmVyIHRoZSBkaXNwbGF5T2JqZWN0CiAgICAgKiBAbWV0aG9kIG1vdXNldXBvdXRzaWRlCiAgICAgKiBAcGFyYW0gaW50ZXJhY3Rpb25EYXRhIHtJbnRlcmFjdGlvbkRhdGF9CiAgICAgKi8KCiAgICAvKioKICAgICAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXJzIG1vdXNlIHJvbGxzIG92ZXIgdGhlIGRpc3BsYXlPYmplY3QKICAgICAqIEBtZXRob2QgbW91c2VvdmVyCiAgICAgKiBAcGFyYW0gaW50ZXJhY3Rpb25EYXRhIHtJbnRlcmFjdGlvbkRhdGF9CiAgICAgKi8KCiAgICAvKioKICAgICAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXJzIG1vdXNlIGxlYXZlcyB0aGUgZGlzcGxheU9iamVjdAogICAgICogQG1ldGhvZCBtb3VzZW91dAogICAgICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQogICAgICovCgoKICAgIC8qCiAgICAgKiBUT1VDSCBDYWxsYmFja3MKICAgICAqLwoKICAgIC8qKgogICAgICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlcnMgdGFwcyBvbiB0aGUgc3ByaXRlIHdpdGggdGhlaXIgZmluZ2VyCiAgICAgKiBiYXNpY2FsbHkgYSB0b3VjaCB2ZXJzaW9uIG9mIGNsaWNrCiAgICAgKiBAbWV0aG9kIHRhcAogICAgICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQogICAgICovCgogICAgLyoqCiAgICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VyIHRvdWNoJ3Mgb3ZlciB0aGUgZGlzcGxheU9iamVjdAogICAgICogQG1ldGhvZCB0b3VjaHN0YXJ0CiAgICAgKiBAcGFyYW0gaW50ZXJhY3Rpb25EYXRhIHtJbnRlcmFjdGlvbkRhdGF9CiAgICAgKi8KCiAgICAvKioKICAgICAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXIgcmVsZWFzZXMgYSB0b3VjaCBvdmVyIHRoZSBkaXNwbGF5T2JqZWN0CiAgICAgKiBAbWV0aG9kIHRvdWNoZW5kCiAgICAgKiBAcGFyYW0gaW50ZXJhY3Rpb25EYXRhIHtJbnRlcmFjdGlvbkRhdGF9CiAgICAgKi8KCiAgICAvKioKICAgICAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXIgcmVsZWFzZXMgdGhlIHRvdWNoIHRoYXQgd2FzIG92ZXIgdGhlIGRpc3BsYXlPYmplY3QKICAgICAqIGZvciB0aGlzIGNhbGxiYWNrIHRvIGJlIGZpcmVkLCBUaGUgdG91Y2ggbXVzdCBoYXZlIHN0YXJ0ZWQgb3ZlciB0aGUgc3ByaXRlCiAgICAgKiBAbWV0aG9kIHRvdWNoZW5kb3V0c2lkZQogICAgICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQogICAgICovCn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5EaXNwbGF5T2JqZWN0OwoKLyoqCiAqIFtEZXByZWNhdGVkXSBJbmRpY2F0ZXMgaWYgdGhlIHNwcml0ZSB3aWxsIGhhdmUgdG91Y2ggYW5kIG1vdXNlIGludGVyYWN0aXZpdHkuIEl0IGlzIGZhbHNlIGJ5IGRlZmF1bHQKICogSW5zdGVhZCBvZiB1c2luZyB0aGlzIGZ1bmN0aW9uIHlvdSBjYW4gbm93IHNpbXBseSBzZXQgdGhlIGludGVyYWN0aXZlIHByb3BlcnR5IHRvIHRydWUgb3IgZmFsc2UKICoKICogQG1ldGhvZCBzZXRJbnRlcmFjdGl2ZQogKiBAcGFyYW0gaW50ZXJhY3RpdmUge0Jvb2xlYW59CiAqIEBkZXByZWNhdGVkIFNpbXBseSBzZXQgdGhlIGBpbnRlcmFjdGl2ZWAgcHJvcGVydHkgZGlyZWN0bHkKICovClBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUuc2V0SW50ZXJhY3RpdmUgPSBmdW5jdGlvbihpbnRlcmFjdGl2ZSkKewogICAgdGhpcy5pbnRlcmFjdGl2ZSA9IGludGVyYWN0aXZlOwp9OwoKLyoqCiAqIEluZGljYXRlcyBpZiB0aGUgc3ByaXRlIHdpbGwgaGF2ZSB0b3VjaCBhbmQgbW91c2UgaW50ZXJhY3Rpdml0eS4gSXQgaXMgZmFsc2UgYnkgZGVmYXVsdAogKgogKiBAcHJvcGVydHkgaW50ZXJhY3RpdmUKICogQHR5cGUgQm9vbGVhbgogKiBAZGVmYXVsdCBmYWxzZQogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUsICdpbnRlcmFjdGl2ZScsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ludGVyYWN0aXZlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLl9pbnRlcmFjdGl2ZSA9IHZhbHVlOwoKICAgICAgICAvLyBUT0RPIG1vcmUgdG8gYmUgZG9uZSBoZXJlLi4KICAgICAgICAvLyBuZWVkIHRvIHNvcnQgb3V0IGEgcmUtY3Jhd2whCiAgICAgICAgaWYodGhpcy5zdGFnZSl0aGlzLnN0YWdlLmRpcnR5ID0gdHJ1ZTsKICAgIH0KfSk7CgovKioKICogU2V0cyBhIG1hc2sgZm9yIHRoZSBkaXNwbGF5T2JqZWN0LiBBIG1hc2sgaXMgYW4gb2JqZWN0IHRoYXQgbGltaXRzIHRoZSB2aXNpYmlsaXR5IG9mIGFuIG9iamVjdCB0byB0aGUgc2hhcGUgb2YgdGhlIG1hc2sgYXBwbGllZCB0byBpdC4KICogSW4gUElYSSBhIHJlZ3VsYXIgbWFzayBtdXN0IGJlIGEgUElYSS5HZ3JhcGhpY3Mgb2JqZWN0LiBUaGlzIGFsbG93cyBmb3IgbXVjaCBmYXN0ZXIgbWFza2luZyBpbiBjYW52YXMgYXMgaXQgdXRpbGlzZXMgc2hhcGUgY2xpcHBpbmcuCiAqIFRvIHJlbW92ZSBhIG1hc2ssIHNldCB0aGlzIHByb3BlcnR5IHRvIG51bGwuCiAqCiAqIEBwcm9wZXJ0eSBtYXNrCiAqIEB0eXBlIEdyYXBoaWNzCiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZSwgJ21hc2snLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLl9tYXNrOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKCgogICAgICAgIGlmKHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgaWYodGhpcy5fbWFzaykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsdWUuc3RhcnQgPSB0aGlzLl9tYXNrLnN0YXJ0OwogICAgICAgICAgICAgICAgdmFsdWUuZW5kID0gdGhpcy5fbWFzay5lbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmFkZEZpbHRlcih2YWx1ZSk7CiAgICAgICAgICAgICAgICB2YWx1ZS5yZW5kZXJhYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWx0ZXIodGhpcy5fbWFzayk7CiAgICAgICAgICAgIHRoaXMuX21hc2sucmVuZGVyYWJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9tYXNrID0gdmFsdWU7CiAgICB9Cn0pOwoKLyoqCiAqIFNldHMgdGhlIGZpbHRlcnMgZm9yIHRoZSBkaXNwbGF5T2JqZWN0LgogKiAqIElNUE9SVEFOVDogVGhpcyBpcyBhIHdlYkdMIG9ubHkgZmVhdHVyZSBhbmQgd2lsbCBiZSBpZ25vcmVkIGJ5IHRoZSBjYW52YXMgcmVuZGVyZXIuCiAqIFRvIHJlbW92ZSBmaWx0ZXJzIHNpbXBseSBzZXQgdGhpcyBwcm9wZXJ0eSB0byAnbnVsbCcKICogQHByb3BlcnR5IGZpbHRlcnMKICogQHR5cGUgQXJyYXkgQW4gYXJyYXkgb2YgZmlsdGVycwogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUsICdmaWx0ZXJzJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZmlsdGVyczsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CgogICAgICAgIGlmKHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgaWYodGhpcy5fZmlsdGVycyl0aGlzLnJlbW92ZUZpbHRlcih0aGlzLl9maWx0ZXJzKTsKICAgICAgICAgICAgdGhpcy5hZGRGaWx0ZXIodmFsdWUpOwoKICAgICAgICAgICAgLy8gbm93IHB1dCBhbGwgdGhlIHBhc3NlcyBpbiBvbmUgcGxhY2UuLgogICAgICAgICAgICB2YXIgcGFzc2VzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBmaWx0ZXJQYXNzZXMgPSB2YWx1ZVtpXS5wYXNzZXM7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpbHRlclBhc3Nlcy5sZW5ndGg7IGorKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBwYXNzZXMucHVzaChmaWx0ZXJQYXNzZXNbal0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB2YWx1ZS5zdGFydC5maWx0ZXJQYXNzZXMgPSBwYXNzZXM7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmKHRoaXMuX2ZpbHRlcnMpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlRmlsdGVyKHRoaXMuX2ZpbHRlcnMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9maWx0ZXJzID0gdmFsdWU7CiAgICB9Cn0pOwoKLyoKICogQWRkcyBhIGZpbHRlciB0byB0aGlzIGRpc3BsYXlPYmplY3QKICoKICogQG1ldGhvZCBhZGRGaWx0ZXIKICogQHBhcmFtIG1hc2sge0dyYXBoaWNzfSB0aGUgZ3JhcGhpY3Mgb2JqZWN0IHRvIHVzZSBhcyBhIGZpbHRlcgogKiBAcHJpdmF0ZQogKi8KUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZS5hZGRGaWx0ZXIgPSBmdW5jdGlvbihkYXRhKQp7CiAgICAvL2lmKHRoaXMuZmlsdGVyKXJldHVybjsKICAgIC8vdGhpcy5maWx0ZXIgPSB0cnVlOwovLyAgZGF0YVswXS50YXJnZXQgPSB0aGlzOwoKCiAgICAvLyBpbnNlcnQgYSBmaWx0ZXIgYmxvY2suLgogICAgLy8gVE9ETyBPbmplY3QgcG9vbCB0aGVhc2UgYmFkIGJveXMuLgogICAgdmFyIHN0YXJ0ID0gbmV3IFBJWEkuRmlsdGVyQmxvY2soKTsKICAgIHZhciBlbmQgPSBuZXcgUElYSS5GaWx0ZXJCbG9jaygpOwoKICAgIGRhdGEuc3RhcnQgPSBzdGFydDsKICAgIGRhdGEuZW5kID0gZW5kOwoKICAgIHN0YXJ0LmRhdGEgPSBkYXRhOwogICAgZW5kLmRhdGEgPSBkYXRhOwoKICAgIHN0YXJ0LmZpcnN0ID0gc3RhcnQubGFzdCA9ICB0aGlzOwogICAgZW5kLmZpcnN0ID0gZW5kLmxhc3QgPSB0aGlzOwoKICAgIHN0YXJ0Lm9wZW4gPSB0cnVlOwoKICAgIHN0YXJ0LnRhcmdldCA9IHRoaXM7CgogICAgLyoKICAgICAqIGluc2VydCBzdGFydAogICAgICovCgogICAgdmFyIGNoaWxkRmlyc3QgPSBzdGFydDsKICAgIHZhciBjaGlsZExhc3QgPSBzdGFydDsKICAgIHZhciBuZXh0T2JqZWN0OwogICAgdmFyIHByZXZpb3VzT2JqZWN0OwoKICAgIHByZXZpb3VzT2JqZWN0ID0gdGhpcy5maXJzdC5faVByZXY7CgogICAgaWYocHJldmlvdXNPYmplY3QpCiAgICB7CiAgICAgICAgbmV4dE9iamVjdCA9IHByZXZpb3VzT2JqZWN0Ll9pTmV4dDsKICAgICAgICBjaGlsZEZpcnN0Ll9pUHJldiA9IHByZXZpb3VzT2JqZWN0OwogICAgICAgIHByZXZpb3VzT2JqZWN0Ll9pTmV4dCA9IGNoaWxkRmlyc3Q7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgbmV4dE9iamVjdCA9IHRoaXM7CiAgICB9CgogICAgaWYobmV4dE9iamVjdCkKICAgIHsKICAgICAgICBuZXh0T2JqZWN0Ll9pUHJldiA9IGNoaWxkTGFzdDsKICAgICAgICBjaGlsZExhc3QuX2lOZXh0ID0gbmV4dE9iamVjdDsKICAgIH0KCiAgICAvLyBub3cgaW5zZXJ0IHRoZSBlbmQgZmlsdGVyIGJsb2NrLi4KCiAgICAvKgogICAgICogaW5zZXJ0IGVuZCBmaWx0ZXIKICAgICAqLwogICAgY2hpbGRGaXJzdCA9IGVuZDsKICAgIGNoaWxkTGFzdCA9IGVuZDsKICAgIG5leHRPYmplY3QgPSBudWxsOwogICAgcHJldmlvdXNPYmplY3QgPSBudWxsOwoKICAgIHByZXZpb3VzT2JqZWN0ID0gdGhpcy5sYXN0OwogICAgbmV4dE9iamVjdCA9IHByZXZpb3VzT2JqZWN0Ll9pTmV4dDsKCiAgICBpZihuZXh0T2JqZWN0KQogICAgewogICAgICAgIG5leHRPYmplY3QuX2lQcmV2ID0gY2hpbGRMYXN0OwogICAgICAgIGNoaWxkTGFzdC5faU5leHQgPSBuZXh0T2JqZWN0OwogICAgfQoKICAgIGNoaWxkRmlyc3QuX2lQcmV2ID0gcHJldmlvdXNPYmplY3Q7CiAgICBwcmV2aW91c09iamVjdC5faU5leHQgPSBjaGlsZEZpcnN0OwoKICAgIHZhciB1cGRhdGVMYXN0ID0gdGhpczsKCiAgICB2YXIgcHJldkxhc3QgPSB0aGlzLmxhc3Q7CiAgICB3aGlsZSh1cGRhdGVMYXN0KQogICAgewogICAgICAgIGlmKHVwZGF0ZUxhc3QubGFzdCA9PT0gcHJldkxhc3QpCiAgICAgICAgewogICAgICAgICAgICB1cGRhdGVMYXN0Lmxhc3QgPSBlbmQ7CiAgICAgICAgfQogICAgICAgIHVwZGF0ZUxhc3QgPSB1cGRhdGVMYXN0LnBhcmVudDsKICAgIH0KCiAgICB0aGlzLmZpcnN0ID0gc3RhcnQ7CgogICAgLy8gaWYgd2ViR0wuLi4KICAgIGlmKHRoaXMuX19yZW5kZXJHcm91cCkKICAgIHsKICAgICAgICB0aGlzLl9fcmVuZGVyR3JvdXAuYWRkRmlsdGVyQmxvY2tzKHN0YXJ0LCBlbmQpOwogICAgfQp9OwoKLyoKICogUmVtb3ZlcyB0aGUgZmlsdGVyIHRvIHRoaXMgZGlzcGxheU9iamVjdAogKgogKiBAbWV0aG9kIHJlbW92ZUZpbHRlcgogKiBAcHJpdmF0ZQogKi8KUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZS5yZW1vdmVGaWx0ZXIgPSBmdW5jdGlvbihkYXRhKQp7CiAgICAvL2lmKCF0aGlzLmZpbHRlcilyZXR1cm47CiAgICAvL3RoaXMuZmlsdGVyID0gZmFsc2U7CiAgICAvLyBjb25zb2xlLmxvZygnWVVPSU8nKQogICAgLy8gbW9kaWZ5IHRoZSBsaXN0Li4KICAgIHZhciBzdGFydEJsb2NrID0gZGF0YS5zdGFydDsKCgogICAgdmFyIG5leHRPYmplY3QgPSBzdGFydEJsb2NrLl9pTmV4dDsKICAgIHZhciBwcmV2aW91c09iamVjdCA9IHN0YXJ0QmxvY2suX2lQcmV2OwoKICAgIGlmKG5leHRPYmplY3QpbmV4dE9iamVjdC5faVByZXYgPSBwcmV2aW91c09iamVjdDsKICAgIGlmKHByZXZpb3VzT2JqZWN0KXByZXZpb3VzT2JqZWN0Ll9pTmV4dCA9IG5leHRPYmplY3Q7CgogICAgdGhpcy5maXJzdCA9IHN0YXJ0QmxvY2suX2lOZXh0OwoKICAgIC8vIHJlbW92ZSB0aGUgZW5kIGZpbHRlcgogICAgdmFyIGxhc3RCbG9jayA9IGRhdGEuZW5kOwoKICAgIG5leHRPYmplY3QgPSBsYXN0QmxvY2suX2lOZXh0OwogICAgcHJldmlvdXNPYmplY3QgPSBsYXN0QmxvY2suX2lQcmV2OwoKICAgIGlmKG5leHRPYmplY3QpbmV4dE9iamVjdC5faVByZXYgPSBwcmV2aW91c09iamVjdDsKICAgIHByZXZpb3VzT2JqZWN0Ll9pTmV4dCA9IG5leHRPYmplY3Q7CgogICAgLy8gdGhpcyBpcyBhbHdheXMgdHJ1ZSB0b28hCiAgICB2YXIgdGVtcExhc3QgPSAgbGFzdEJsb2NrLl9pUHJldjsKICAgIC8vIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYXJlbnRzIGxhc3QgaXMgdXBkYXRlZCB0b28KICAgIHZhciB1cGRhdGVMYXN0ID0gdGhpczsKICAgIHdoaWxlKHVwZGF0ZUxhc3QubGFzdCA9PT0gbGFzdEJsb2NrKQogICAgewogICAgICAgIHVwZGF0ZUxhc3QubGFzdCA9IHRlbXBMYXN0OwogICAgICAgIHVwZGF0ZUxhc3QgPSB1cGRhdGVMYXN0LnBhcmVudDsKICAgICAgICBpZighdXBkYXRlTGFzdClicmVhazsKICAgIH0KCiAgICAvLyBpZiB3ZWJHTC4uLgogICAgaWYodGhpcy5fX3JlbmRlckdyb3VwKQogICAgewogICAgICAgIHRoaXMuX19yZW5kZXJHcm91cC5yZW1vdmVGaWx0ZXJCbG9ja3Moc3RhcnRCbG9jaywgbGFzdEJsb2NrKTsKICAgIH0KfTsKCi8qCiAqIFVwZGF0ZXMgdGhlIG9iamVjdCB0cmFuc2Zvcm0gZm9yIHJlbmRlcmluZwogKgogKiBAbWV0aG9kIHVwZGF0ZVRyYW5zZm9ybQogKiBAcHJpdmF0ZQogKi8KUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZS51cGRhdGVUcmFuc2Zvcm0gPSBmdW5jdGlvbigpCnsKICAgIC8vIFRPRE8gT1BUSU1JWkUgVEhJUyEhIHdpdGggZGlydHkKICAgIGlmKHRoaXMucm90YXRpb24gIT09IHRoaXMucm90YXRpb25DYWNoZSkKICAgIHsKICAgICAgICB0aGlzLnJvdGF0aW9uQ2FjaGUgPSB0aGlzLnJvdGF0aW9uOwogICAgICAgIHRoaXMuX3NyID0gIE1hdGguc2luKHRoaXMucm90YXRpb24pOwogICAgICAgIHRoaXMuX2NyID0gIE1hdGguY29zKHRoaXMucm90YXRpb24pOwogICAgfQoKICAgIHZhciBsb2NhbFRyYW5zZm9ybSA9IHRoaXMubG9jYWxUcmFuc2Zvcm07CiAgICB2YXIgcGFyZW50VHJhbnNmb3JtID0gdGhpcy5wYXJlbnQud29ybGRUcmFuc2Zvcm07CiAgICB2YXIgd29ybGRUcmFuc2Zvcm0gPSB0aGlzLndvcmxkVHJhbnNmb3JtOwogICAgLy9jb25zb2xlLmxvZyhsb2NhbFRyYW5zZm9ybSkKICAgIGxvY2FsVHJhbnNmb3JtWzBdID0gdGhpcy5fY3IgKiB0aGlzLnNjYWxlLng7CiAgICBsb2NhbFRyYW5zZm9ybVsxXSA9IC10aGlzLl9zciAqIHRoaXMuc2NhbGUueTsKICAgIGxvY2FsVHJhbnNmb3JtWzNdID0gdGhpcy5fc3IgKiB0aGlzLnNjYWxlLng7CiAgICBsb2NhbFRyYW5zZm9ybVs0XSA9IHRoaXMuX2NyICogdGhpcy5zY2FsZS55OwoKICAgIC8vIFRPRE8gLS0+IGRvIHdlIGV2ZW4gbmVlZCBhIGxvY2FsIG1hdHJpeD8/PwoKICAgIHZhciBweCA9IHRoaXMucGl2b3QueDsKICAgIHZhciBweSA9IHRoaXMucGl2b3QueTsKCiAgICAvLyBDYWNoZSB0aGUgbWF0cml4IHZhbHVlcyAobWFrZXMgZm9yIGh1Z2Ugc3BlZWQgaW5jcmVhc2VzISkKICAgIHZhciBhMDAgPSBsb2NhbFRyYW5zZm9ybVswXSwgYTAxID0gbG9jYWxUcmFuc2Zvcm1bMV0sIGEwMiA9IHRoaXMucG9zaXRpb24ueCAtIGxvY2FsVHJhbnNmb3JtWzBdICogcHggLSBweSAqIGxvY2FsVHJhbnNmb3JtWzFdLAogICAgICAgIGExMCA9IGxvY2FsVHJhbnNmb3JtWzNdLCBhMTEgPSBsb2NhbFRyYW5zZm9ybVs0XSwgYTEyID0gdGhpcy5wb3NpdGlvbi55IC0gbG9jYWxUcmFuc2Zvcm1bNF0gKiBweSAtIHB4ICogbG9jYWxUcmFuc2Zvcm1bM10sCgogICAgICAgIGIwMCA9IHBhcmVudFRyYW5zZm9ybVswXSwgYjAxID0gcGFyZW50VHJhbnNmb3JtWzFdLCBiMDIgPSBwYXJlbnRUcmFuc2Zvcm1bMl0sCiAgICAgICAgYjEwID0gcGFyZW50VHJhbnNmb3JtWzNdLCBiMTEgPSBwYXJlbnRUcmFuc2Zvcm1bNF0sIGIxMiA9IHBhcmVudFRyYW5zZm9ybVs1XTsKCiAgICBsb2NhbFRyYW5zZm9ybVsyXSA9IGEwMjsKICAgIGxvY2FsVHJhbnNmb3JtWzVdID0gYTEyOwoKICAgIHdvcmxkVHJhbnNmb3JtWzBdID0gYjAwICogYTAwICsgYjAxICogYTEwOwogICAgd29ybGRUcmFuc2Zvcm1bMV0gPSBiMDAgKiBhMDEgKyBiMDEgKiBhMTE7CiAgICB3b3JsZFRyYW5zZm9ybVsyXSA9IGIwMCAqIGEwMiArIGIwMSAqIGExMiArIGIwMjsKCiAgICB3b3JsZFRyYW5zZm9ybVszXSA9IGIxMCAqIGEwMCArIGIxMSAqIGExMDsKICAgIHdvcmxkVHJhbnNmb3JtWzRdID0gYjEwICogYTAxICsgYjExICogYTExOwogICAgd29ybGRUcmFuc2Zvcm1bNV0gPSBiMTAgKiBhMDIgKyBiMTEgKiBhMTIgKyBiMTI7CgogICAgLy8gYmVjYXVzZSB3ZSBhcmUgdXNpbmcgYWZmaW5lIHRyYW5zZm9ybWF0aW9uLCB3ZSBjYW4gb3B0aW1pc2UgdGhlIG1hdHJpeCBjb25jYXRlbmF0aW9uIHByb2Nlc3MuLiB3b29vIQogICAgLy8gbWF0My5tdWx0aXBseSh0aGlzLmxvY2FsVHJhbnNmb3JtLCB0aGlzLnBhcmVudC53b3JsZFRyYW5zZm9ybSwgdGhpcy53b3JsZFRyYW5zZm9ybSk7CiAgICB0aGlzLndvcmxkQWxwaGEgPSB0aGlzLmFscGhhICogdGhpcy5wYXJlbnQud29ybGRBbHBoYTsKCiAgICB0aGlzLnZjb3VudCA9IFBJWEkudmlzaWJsZUNvdW50Owp9OwoKUElYSS52aXNpYmxlQ291bnQgPSAwOwovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKCi8qKgogKiBBIERpc3BsYXlPYmplY3RDb250YWluZXIgcmVwcmVzZW50cyBhIGNvbGxlY3Rpb24gb2YgZGlzcGxheSBvYmplY3RzLgogKiBJdCBpcyB0aGUgYmFzZSBjbGFzcyBvZiBhbGwgZGlzcGxheSBvYmplY3RzIHRoYXQgYWN0IGFzIGEgY29udGFpbmVyIGZvciBvdGhlciBvYmplY3RzLgogKgogKiBAY2xhc3MgRGlzcGxheU9iamVjdENvbnRhaW5lcgogKiBAZXh0ZW5kcyBEaXNwbGF5T2JqZWN0CiAqIEBjb25zdHJ1Y3RvcgogKi8KUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyID0gZnVuY3Rpb24oKQp7CiAgICBQSVhJLkRpc3BsYXlPYmplY3QuY2FsbCggdGhpcyApOwoKICAgIC8qKgogICAgICogW3JlYWQtb25seV0gVGhlIG9mIGNoaWxkcmVuIG9mIHRoaXMgY29udGFpbmVyLgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBjaGlsZHJlbgogICAgICogQHR5cGUgQXJyYXk8RGlzcGxheU9iamVjdD4KICAgICAqIEByZWFkT25seQogICAgICovCiAgICB0aGlzLmNoaWxkcmVuID0gW107Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZSApOwpQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyOwoKLyoqCiAqIEFkZHMgYSBjaGlsZCB0byB0aGUgY29udGFpbmVyLgogKgogKiBAbWV0aG9kIGFkZENoaWxkCiAqIEBwYXJhbSBjaGlsZCB7RGlzcGxheU9iamVjdH0gVGhlIERpc3BsYXlPYmplY3QgdG8gYWRkIHRvIHRoZSBjb250YWluZXIKICovClBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUuYWRkQ2hpbGQgPSBmdW5jdGlvbihjaGlsZCkKewogICAgaWYoY2hpbGQucGFyZW50ICYmIGNoaWxkLnBhcmVudCAhPT0gdGhpcykKICAgIHsKICAgICAgICAvLy8vIENPVUxEIEJFIFRISVM/Pz8KICAgICAgICBjaGlsZC5wYXJlbnQucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgLy8gIHJldHVybjsKICAgIH0KCiAgICBjaGlsZC5wYXJlbnQgPSB0aGlzOwoKICAgIHRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZCk7CgogICAgLy8gdXBkYXRlIHRoZSBzdGFnZSByZWZmZXJlbmNlLi4KCiAgICBpZih0aGlzLnN0YWdlKQogICAgewogICAgICAgIHZhciB0bXBDaGlsZCA9IGNoaWxkOwogICAgICAgIGRvCiAgICAgICAgewogICAgICAgICAgICBpZih0bXBDaGlsZC5pbnRlcmFjdGl2ZSl0aGlzLnN0YWdlLmRpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgdG1wQ2hpbGQuc3RhZ2UgPSB0aGlzLnN0YWdlOwogICAgICAgICAgICB0bXBDaGlsZCA9IHRtcENoaWxkLl9pTmV4dDsKICAgICAgICB9CiAgICAgICAgd2hpbGUodG1wQ2hpbGQpOwogICAgfQoKICAgIC8vIExJTktFRCBMSVNUIC8vCgogICAgLy8gbW9kaWZ5IHRoZSBsaXN0Li4KICAgIHZhciBjaGlsZEZpcnN0ID0gY2hpbGQuZmlyc3Q7CiAgICB2YXIgY2hpbGRMYXN0ID0gY2hpbGQubGFzdDsKICAgIHZhciBuZXh0T2JqZWN0OwogICAgdmFyIHByZXZpb3VzT2JqZWN0OwoKICAgIC8vIHRoaXMgY291bGQgYmUgd3JvbmcgaWYgdGhlcmUgaXMgYSBmaWx0ZXI/PwogICAgaWYodGhpcy5fZmlsdGVycyB8fCB0aGlzLl9tYXNrKQogICAgewogICAgICAgIHByZXZpb3VzT2JqZWN0ID0gIHRoaXMubGFzdC5faVByZXY7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgcHJldmlvdXNPYmplY3QgPSB0aGlzLmxhc3Q7CiAgICB9CgogICAgbmV4dE9iamVjdCA9IHByZXZpb3VzT2JqZWN0Ll9pTmV4dDsKCiAgICAvLyBhbHdheXMgdHJ1ZSBpbiB0aGlzIGNhc2UKICAgIC8vIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYXJlbnRzIGxhc3QgaXMgdXBkYXRlZCB0b28KICAgIHZhciB1cGRhdGVMYXN0ID0gdGhpczsKICAgIHZhciBwcmV2TGFzdCA9IHByZXZpb3VzT2JqZWN0OwoKICAgIHdoaWxlKHVwZGF0ZUxhc3QpCiAgICB7CiAgICAgICAgaWYodXBkYXRlTGFzdC5sYXN0ID09PSBwcmV2TGFzdCkKICAgICAgICB7CiAgICAgICAgICAgIHVwZGF0ZUxhc3QubGFzdCA9IGNoaWxkLmxhc3Q7CiAgICAgICAgfQogICAgICAgIHVwZGF0ZUxhc3QgPSB1cGRhdGVMYXN0LnBhcmVudDsKICAgIH0KCiAgICBpZihuZXh0T2JqZWN0KQogICAgewogICAgICAgIG5leHRPYmplY3QuX2lQcmV2ID0gY2hpbGRMYXN0OwogICAgICAgIGNoaWxkTGFzdC5faU5leHQgPSBuZXh0T2JqZWN0OwogICAgfQoKICAgIGNoaWxkRmlyc3QuX2lQcmV2ID0gcHJldmlvdXNPYmplY3Q7CiAgICBwcmV2aW91c09iamVjdC5faU5leHQgPSBjaGlsZEZpcnN0OwoKICAgIC8vIG5lZWQgdG8gcmVtb3ZlIGFueSByZW5kZXIgZ3JvdXBzLi4KICAgIGlmKHRoaXMuX19yZW5kZXJHcm91cCkKICAgIHsKICAgICAgICAvLyBiZWluZyB1c2VkIGJ5IGEgcmVuZGVyVGV4dHVyZS4uIGlmIGl0IGV4aXN0cyB0aGVuIGl0IG11c3QgYmUgZnJvbSBhIHJlbmRlciB0ZXh0dXJlOwogICAgICAgIGlmKGNoaWxkLl9fcmVuZGVyR3JvdXApY2hpbGQuX19yZW5kZXJHcm91cC5yZW1vdmVEaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4oY2hpbGQpOwogICAgICAgIC8vIGFkZCB0aGVtIHRvIHRoZSBuZXcgcmVuZGVyIGdyb3VwLi4KICAgICAgICB0aGlzLl9fcmVuZGVyR3JvdXAuYWRkRGlzcGxheU9iamVjdEFuZENoaWxkcmVuKGNoaWxkKTsKICAgIH0KfTsKCi8qKgogKiBBZGRzIGEgY2hpbGQgdG8gdGhlIGNvbnRhaW5lciBhdCBhIHNwZWNpZmllZCBpbmRleC4gSWYgdGhlIGluZGV4IGlzIG91dCBvZiBib3VuZHMgYW4gZXJyb3Igd2lsbCBiZSB0aHJvd24KICoKICogQG1ldGhvZCBhZGRDaGlsZEF0CiAqIEBwYXJhbSBjaGlsZCB7RGlzcGxheU9iamVjdH0gVGhlIGNoaWxkIHRvIGFkZAogKiBAcGFyYW0gaW5kZXgge051bWJlcn0gVGhlIGluZGV4IHRvIHBsYWNlIHRoZSBjaGlsZCBpbgogKi8KUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZS5hZGRDaGlsZEF0ID0gZnVuY3Rpb24oY2hpbGQsIGluZGV4KQp7CiAgICBpZihpbmRleCA+PSAwICYmIGluZGV4IDw9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoKQogICAgewogICAgICAgIGlmKGNoaWxkLnBhcmVudCAhPT0gdW5kZWZpbmVkKQogICAgICAgIHsKICAgICAgICAgICAgY2hpbGQucGFyZW50LnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICB9CgogICAgICAgIGNoaWxkLnBhcmVudCA9IHRoaXM7CgogICAgICAgIGlmKHRoaXMuc3RhZ2UpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdG1wQ2hpbGQgPSBjaGlsZDsKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYodG1wQ2hpbGQuaW50ZXJhY3RpdmUpdGhpcy5zdGFnZS5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgICAgICB0bXBDaGlsZC5zdGFnZSA9IHRoaXMuc3RhZ2U7CiAgICAgICAgICAgICAgICB0bXBDaGlsZCA9IHRtcENoaWxkLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSh0bXBDaGlsZCk7CiAgICAgICAgfQoKICAgICAgICAvLyBtb2RpZnkgdGhlIGxpc3QuLgogICAgICAgIHZhciBjaGlsZEZpcnN0ID0gY2hpbGQuZmlyc3Q7CiAgICAgICAgdmFyIGNoaWxkTGFzdCA9IGNoaWxkLmxhc3Q7CiAgICAgICAgdmFyIG5leHRPYmplY3Q7CiAgICAgICAgdmFyIHByZXZpb3VzT2JqZWN0OwoKICAgICAgICBpZihpbmRleCA9PT0gdGhpcy5jaGlsZHJlbi5sZW5ndGgpCiAgICAgICAgewogICAgICAgICAgICBwcmV2aW91c09iamVjdCA9ICB0aGlzLmxhc3Q7CiAgICAgICAgICAgIHZhciB1cGRhdGVMYXN0ID0gdGhpczsKICAgICAgICAgICAgdmFyIHByZXZMYXN0ID0gdGhpcy5sYXN0OwogICAgICAgICAgICB3aGlsZSh1cGRhdGVMYXN0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZih1cGRhdGVMYXN0Lmxhc3QgPT09IHByZXZMYXN0KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHVwZGF0ZUxhc3QubGFzdCA9IGNoaWxkLmxhc3Q7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1cGRhdGVMYXN0ID0gdXBkYXRlTGFzdC5wYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZihpbmRleCA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzT2JqZWN0ID0gdGhpczsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNPYmplY3QgPSB0aGlzLmNoaWxkcmVuW2luZGV4LTFdLmxhc3Q7CiAgICAgICAgfQoKICAgICAgICBuZXh0T2JqZWN0ID0gcHJldmlvdXNPYmplY3QuX2lOZXh0OwoKICAgICAgICAvLyBhbHdheXMgdHJ1ZSBpbiB0aGlzIGNhc2UKICAgICAgICBpZihuZXh0T2JqZWN0KQogICAgICAgIHsKICAgICAgICAgICAgbmV4dE9iamVjdC5faVByZXYgPSBjaGlsZExhc3Q7CiAgICAgICAgICAgIGNoaWxkTGFzdC5faU5leHQgPSBuZXh0T2JqZWN0OwogICAgICAgIH0KCiAgICAgICAgY2hpbGRGaXJzdC5faVByZXYgPSBwcmV2aW91c09iamVjdDsKICAgICAgICBwcmV2aW91c09iamVjdC5faU5leHQgPSBjaGlsZEZpcnN0OwoKICAgICAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpbmRleCwgMCwgY2hpbGQpOwogICAgICAgIC8vIG5lZWQgdG8gcmVtb3ZlIGFueSByZW5kZXIgZ3JvdXBzLi4KICAgICAgICBpZih0aGlzLl9fcmVuZGVyR3JvdXApCiAgICAgICAgewogICAgICAgICAgICAvLyBiZWluZyB1c2VkIGJ5IGEgcmVuZGVyVGV4dHVyZS4uIGlmIGl0IGV4aXN0cyB0aGVuIGl0IG11c3QgYmUgZnJvbSBhIHJlbmRlciB0ZXh0dXJlOwogICAgICAgICAgICBpZihjaGlsZC5fX3JlbmRlckdyb3VwKWNoaWxkLl9fcmVuZGVyR3JvdXAucmVtb3ZlRGlzcGxheU9iamVjdEFuZENoaWxkcmVuKGNoaWxkKTsKICAgICAgICAgICAgLy8gYWRkIHRoZW0gdG8gdGhlIG5ldyByZW5kZXIgZ3JvdXAuLgogICAgICAgICAgICB0aGlzLl9fcmVuZGVyR3JvdXAuYWRkRGlzcGxheU9iamVjdEFuZENoaWxkcmVuKGNoaWxkKTsKICAgICAgICB9CgogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRocm93IG5ldyBFcnJvcihjaGlsZCArICcgVGhlIGluZGV4ICcrIGluZGV4ICsnIHN1cHBsaWVkIGlzIG91dCBvZiBib3VuZHMgJyArIHRoaXMuY2hpbGRyZW4ubGVuZ3RoKTsKICAgIH0KfTsKCi8qKgogKiBbTllJXSBTd2FwcyB0aGUgZGVwdGggb2YgMiBkaXNwbGF5T2JqZWN0cwogKgogKiBAbWV0aG9kIHN3YXBDaGlsZHJlbgogKiBAcGFyYW0gY2hpbGQge0Rpc3BsYXlPYmplY3R9CiAqIEBwYXJhbSBjaGlsZDIge0Rpc3BsYXlPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLnN3YXBDaGlsZHJlbiA9IGZ1bmN0aW9uKGNoaWxkLCBjaGlsZDIpCnsKICAgIGlmKGNoaWxkID09PSBjaGlsZDIpIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGluZGV4MSA9IHRoaXMuY2hpbGRyZW4uaW5kZXhPZihjaGlsZCk7CiAgICB2YXIgaW5kZXgyID0gdGhpcy5jaGlsZHJlbi5pbmRleE9mKGNoaWxkMik7CgogICAgaWYoaW5kZXgxIDwgMCB8fCBpbmRleDIgPCAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzd2FwQ2hpbGRyZW46IEJvdGggdGhlIHN1cHBsaWVkIERpc3BsYXlPYmplY3RzIG11c3QgYmUgYSBjaGlsZCBvZiB0aGUgY2FsbGVyLicpOwogICAgfQoKICAgIHRoaXMucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgdGhpcy5yZW1vdmVDaGlsZChjaGlsZDIpOwoKICAgIGlmKGluZGV4MSA8IGluZGV4MikKICAgIHsKICAgICAgICB0aGlzLmFkZENoaWxkQXQoY2hpbGQyLCBpbmRleDEpOwogICAgICAgIHRoaXMuYWRkQ2hpbGRBdChjaGlsZCwgaW5kZXgyKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLmFkZENoaWxkQXQoY2hpbGQsIGluZGV4Mik7CiAgICAgICAgdGhpcy5hZGRDaGlsZEF0KGNoaWxkMiwgaW5kZXgxKTsKICAgIH0KfTsKCi8qKgogKiBSZXR1cm5zIHRoZSBDaGlsZCBhdCB0aGUgc3BlY2lmaWVkIGluZGV4CiAqCiAqIEBtZXRob2QgZ2V0Q2hpbGRBdAogKiBAcGFyYW0gaW5kZXgge051bWJlcn0gVGhlIGluZGV4IHRvIGdldCB0aGUgY2hpbGQgZnJvbQogKi8KUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZS5nZXRDaGlsZEF0ID0gZnVuY3Rpb24oaW5kZXgpCnsKICAgIGlmKGluZGV4ID49IDAgJiYgaW5kZXggPCB0aGlzLmNoaWxkcmVuLmxlbmd0aCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5jaGlsZHJlbltpbmRleF07CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCb3RoIHRoZSBzdXBwbGllZCBEaXNwbGF5T2JqZWN0cyBtdXN0IGJlIGEgY2hpbGQgb2YgdGhlIGNhbGxlciAnICsgdGhpcyk7CiAgICB9Cn07CgovKioKICogUmVtb3ZlcyBhIGNoaWxkIGZyb20gdGhlIGNvbnRhaW5lci4KICoKICogQG1ldGhvZCByZW1vdmVDaGlsZAogKiBAcGFyYW0gY2hpbGQge0Rpc3BsYXlPYmplY3R9IFRoZSBEaXNwbGF5T2JqZWN0IHRvIHJlbW92ZQogKi8KUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZS5yZW1vdmVDaGlsZCA9IGZ1bmN0aW9uKGNoaWxkKQp7CiAgICB2YXIgaW5kZXggPSB0aGlzLmNoaWxkcmVuLmluZGV4T2YoIGNoaWxkICk7CiAgICBpZiAoIGluZGV4ICE9PSAtMSApCiAgICB7CiAgICAgICAgLy8gdW5saW5rIC8vCiAgICAgICAgLy8gbW9kaWZ5IHRoZSBsaXN0Li4KICAgICAgICB2YXIgY2hpbGRGaXJzdCA9IGNoaWxkLmZpcnN0OwogICAgICAgIHZhciBjaGlsZExhc3QgPSBjaGlsZC5sYXN0OwoKICAgICAgICB2YXIgbmV4dE9iamVjdCA9IGNoaWxkTGFzdC5faU5leHQ7CiAgICAgICAgdmFyIHByZXZpb3VzT2JqZWN0ID0gY2hpbGRGaXJzdC5faVByZXY7CgogICAgICAgIGlmKG5leHRPYmplY3QpbmV4dE9iamVjdC5faVByZXYgPSBwcmV2aW91c09iamVjdDsKICAgICAgICBwcmV2aW91c09iamVjdC5faU5leHQgPSBuZXh0T2JqZWN0OwoKICAgICAgICBpZih0aGlzLmxhc3QgPT09IGNoaWxkTGFzdCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0ZW1wTGFzdCA9IGNoaWxkRmlyc3QuX2lQcmV2OwogICAgICAgICAgICAvLyBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFyZW50cyBsYXN0IGlzIHVwZGF0ZWQgdG9vCiAgICAgICAgICAgIHZhciB1cGRhdGVMYXN0ID0gdGhpczsKCiAgICAgICAgICAgIHdoaWxlKHVwZGF0ZUxhc3QubGFzdCA9PT0gY2hpbGRMYXN0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB1cGRhdGVMYXN0Lmxhc3QgPSB0ZW1wTGFzdDsKICAgICAgICAgICAgICAgIHVwZGF0ZUxhc3QgPSB1cGRhdGVMYXN0LnBhcmVudDsKICAgICAgICAgICAgICAgIGlmKCF1cGRhdGVMYXN0KWJyZWFrOwoKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2hpbGRMYXN0Ll9pTmV4dCA9IG51bGw7CiAgICAgICAgY2hpbGRGaXJzdC5faVByZXYgPSBudWxsOwoKICAgICAgICAvLyB1cGRhdGUgdGhlIHN0YWdlIHJlZmVyZW5jZS4uCiAgICAgICAgaWYodGhpcy5zdGFnZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0bXBDaGlsZCA9IGNoaWxkOwogICAgICAgICAgICBkbwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZih0bXBDaGlsZC5pbnRlcmFjdGl2ZSl0aGlzLnN0YWdlLmRpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRtcENoaWxkLnN0YWdlID0gbnVsbDsKICAgICAgICAgICAgICAgIHRtcENoaWxkID0gdG1wQ2hpbGQuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKHRtcENoaWxkKTsKICAgICAgICB9CgogICAgICAgIC8vIHdlYkdMIHRyaW0KICAgICAgICBpZihjaGlsZC5fX3JlbmRlckdyb3VwKQogICAgICAgIHsKICAgICAgICAgICAgY2hpbGQuX19yZW5kZXJHcm91cC5yZW1vdmVEaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4oY2hpbGQpOwogICAgICAgIH0KCiAgICAgICAgY2hpbGQucGFyZW50ID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMuY2hpbGRyZW4uc3BsaWNlKCBpbmRleCwgMSApOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRocm93IG5ldyBFcnJvcihjaGlsZCArICcgVGhlIHN1cHBsaWVkIERpc3BsYXlPYmplY3QgbXVzdCBiZSBhIGNoaWxkIG9mIHRoZSBjYWxsZXIgJyArIHRoaXMpOwogICAgfQp9OwoKLyoKICogVXBkYXRlcyB0aGUgY29udGFpbmVyJ3MgY2hpbGRyZW4ncyB0cmFuc2Zvcm0gZm9yIHJlbmRlcmluZwogKgogKiBAbWV0aG9kIHVwZGF0ZVRyYW5zZm9ybQogKiBAcHJpdmF0ZQogKi8KUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZS51cGRhdGVUcmFuc2Zvcm0gPSBmdW5jdGlvbigpCnsKICAgIGlmKCF0aGlzLnZpc2libGUpcmV0dXJuOwoKICAgIFBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtLmNhbGwoIHRoaXMgKTsKCiAgICBmb3IodmFyIGk9MCxqPXRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpPGo7IGkrKykKICAgIHsKICAgICAgICB0aGlzLmNoaWxkcmVuW2ldLnVwZGF0ZVRyYW5zZm9ybSgpOwogICAgfQp9OwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KClBJWEkuYmxlbmRNb2RlcyA9IHt9OwpQSVhJLmJsZW5kTW9kZXMuTk9STUFMID0gMDsKUElYSS5ibGVuZE1vZGVzLlNDUkVFTiA9IDE7CgoKLyoqCiAqIFRoZSBTUHJpdGUgb2JqZWN0IGlzIHRoZSBiYXNlIGZvciBhbGwgdGV4dHVyZWQgb2JqZWN0cyB0aGF0IGFyZSByZW5kZXJlZCB0byB0aGUgc2NyZWVuCiAqCiAqIEBjbGFzcyBTcHJpdGUKICogQGV4dGVuZHMgRGlzcGxheU9iamVjdENvbnRhaW5lcgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHRleHR1cmUge1RleHR1cmV9IFRoZSB0ZXh0dXJlIGZvciB0aGlzIHNwcml0ZQogKiBAdHlwZSBTdHJpbmcKICovClBJWEkuU3ByaXRlID0gZnVuY3Rpb24odGV4dHVyZSkKewogICAgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwoIHRoaXMgKTsKCiAgICAvKioKICAgICAqIFRoZSBhbmNob3Igc2V0cyB0aGUgb3JpZ2luIHBvaW50IG9mIHRoZSB0ZXh0dXJlLgogICAgICogVGhlIGRlZmF1bHQgaXMgMCwwIHRoaXMgbWVhbnMgdGhlIHRleHR1cmVzIG9yaWdpbiBpcyB0aGUgdG9wIGxlZnQKICAgICAqIFNldHRpbmcgdGhhbiBhbmNob3IgdG8gMC41LDAuNSBtZWFucyB0aGUgdGV4dHVyZXMgb3JpZ2luIGlzIGNlbnRlcmVkCiAgICAgKiBTZXR0aW5nIHRoZSBhbmNob3IgdG8gMSwxIHdvdWxkIG1lYW4gdGhlIHRleHR1cmVzIG9yaWdpbiBwb2ludHMgd2lsbCBiZSB0aGUgYm90dG9tIHJpZ2h0CiAgICAgKgogICAgICogQHByb3BlcnR5IGFuY2hvcgogICAgICogQHR5cGUgUG9pbnQKICAgICAqLwogICAgdGhpcy5hbmNob3IgPSBuZXcgUElYSS5Qb2ludCgpOwoKICAgIC8qKgogICAgICogVGhlIHRleHR1cmUgdGhhdCB0aGUgc3ByaXRlIGlzIHVzaW5nCiAgICAgKgogICAgICogQHByb3BlcnR5IHRleHR1cmUKICAgICAqIEB0eXBlIFRleHR1cmUKICAgICAqLwogICAgdGhpcy50ZXh0dXJlID0gdGV4dHVyZTsKCiAgICAvKioKICAgICAqIFRoZSBibGVuZCBtb2RlIG9mIHNwcml0ZS4KICAgICAqIGN1cnJlbnRseSBzdXBwb3J0cyBQSVhJLmJsZW5kTW9kZXMuTk9STUFMIGFuZCBQSVhJLmJsZW5kTW9kZXMuU0NSRUVOCiAgICAgKgogICAgICogQHByb3BlcnR5IGJsZW5kTW9kZQogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKi8KICAgIHRoaXMuYmxlbmRNb2RlID0gUElYSS5ibGVuZE1vZGVzLk5PUk1BTDsKCiAgICAvKioKICAgICAqIFRoZSB3aWR0aCBvZiB0aGUgc3ByaXRlICh0aGlzIGlzIGluaXRpYWxseSBzZXQgYnkgdGhlIHRleHR1cmUpCiAgICAgKgogICAgICogQHByb3BlcnR5IF93aWR0aAogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICB0aGlzLl93aWR0aCA9IDA7CgogICAgLyoqCiAgICAgKiBUaGUgaGVpZ2h0IG9mIHRoZSBzcHJpdGUgKHRoaXMgaXMgaW5pdGlhbGx5IHNldCBieSB0aGUgdGV4dHVyZSkKICAgICAqCiAgICAgKiBAcHJvcGVydHkgX2hlaWdodAogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICB0aGlzLl9oZWlnaHQgPSAwOwoKICAgIGlmKHRleHR1cmUuYmFzZVRleHR1cmUuaGFzTG9hZGVkKQogICAgewogICAgICAgIHRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMub25UZXh0dXJlVXBkYXRlQmluZCA9IHRoaXMub25UZXh0dXJlVXBkYXRlLmJpbmQodGhpcyk7CiAgICAgICAgdGhpcy50ZXh0dXJlLmFkZEV2ZW50TGlzdGVuZXIoICd1cGRhdGUnLCB0aGlzLm9uVGV4dHVyZVVwZGF0ZUJpbmQgKTsKICAgIH0KCiAgICB0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwp9OwoKLy8gY29uc3RydWN0b3IKUElYSS5TcHJpdGUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZSApOwpQSVhJLlNwcml0ZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlNwcml0ZTsKCi8qKgogKiBUaGUgd2lkdGggb2YgdGhlIHNwcml0ZSwgc2V0dGluZyB0aGlzIHdpbGwgYWN0dWFsbHkgbW9kaWZ5IHRoZSBzY2FsZSB0byBhY2hlaXZlIHRoZSB2YWx1ZSBzZXQKICoKICogQHByb3BlcnR5IHdpZHRoCiAqIEB0eXBlIE51bWJlcgogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuU3ByaXRlLnByb3RvdHlwZSwgJ3dpZHRoJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zY2FsZS54ICogdGhpcy50ZXh0dXJlLmZyYW1lLndpZHRoOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnNjYWxlLnggPSB2YWx1ZSAvIHRoaXMudGV4dHVyZS5mcmFtZS53aWR0aDsKICAgICAgICB0aGlzLl93aWR0aCA9IHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiBUaGUgaGVpZ2h0IG9mIHRoZSBzcHJpdGUsIHNldHRpbmcgdGhpcyB3aWxsIGFjdHVhbGx5IG1vZGlmeSB0aGUgc2NhbGUgdG8gYWNoZWl2ZSB0aGUgdmFsdWUgc2V0CiAqCiAqIEBwcm9wZXJ0eSBoZWlnaHQKICogQHR5cGUgTnVtYmVyCiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5TcHJpdGUucHJvdG90eXBlLCAnaGVpZ2h0JywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gIHRoaXMuc2NhbGUueSAqIHRoaXMudGV4dHVyZS5mcmFtZS5oZWlnaHQ7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMuc2NhbGUueSA9IHZhbHVlIC8gdGhpcy50ZXh0dXJlLmZyYW1lLmhlaWdodDsKICAgICAgICB0aGlzLl9oZWlnaHQgPSB2YWx1ZTsKICAgIH0KfSk7CgovKioKICogU2V0cyB0aGUgdGV4dHVyZSBvZiB0aGUgc3ByaXRlCiAqCiAqIEBtZXRob2Qgc2V0VGV4dHVyZQogKiBAcGFyYW0gdGV4dHVyZSB7VGV4dHVyZX0gVGhlIFBJWEkgdGV4dHVyZSB0aGF0IGlzIGRpc3BsYXllZCBieSB0aGUgc3ByaXRlCiAqLwpQSVhJLlNwcml0ZS5wcm90b3R5cGUuc2V0VGV4dHVyZSA9IGZ1bmN0aW9uKHRleHR1cmUpCnsKICAgIC8vIHN0b3AgY3VycmVudCB0ZXh0dXJlOwogICAgaWYodGhpcy50ZXh0dXJlLmJhc2VUZXh0dXJlICE9PSB0ZXh0dXJlLmJhc2VUZXh0dXJlKQogICAgewogICAgICAgIHRoaXMudGV4dHVyZUNoYW5nZSA9IHRydWU7CiAgICAgICAgdGhpcy50ZXh0dXJlID0gdGV4dHVyZTsKCiAgICAgICAgaWYodGhpcy5fX3JlbmRlckdyb3VwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fX3JlbmRlckdyb3VwLnVwZGF0ZVRleHR1cmUodGhpcyk7CiAgICAgICAgfQogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMudGV4dHVyZSA9IHRleHR1cmU7CiAgICB9CgogICAgdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cn07CgovKioKICogV2hlbiB0aGUgdGV4dHVyZSBpcyB1cGRhdGVkLCB0aGlzIGV2ZW50IHdpbGwgZmlyZSB0byB1cGRhdGUgdGhlIHNjYWxlIGFuZCBmcmFtZQogKgogKiBAbWV0aG9kIG9uVGV4dHVyZVVwZGF0ZQogKiBAcGFyYW0gZXZlbnQKICogQHByaXZhdGUKICovClBJWEkuU3ByaXRlLnByb3RvdHlwZS5vblRleHR1cmVVcGRhdGUgPSBmdW5jdGlvbigpCnsKICAgIC8vdGhpcy50ZXh0dXJlLnJlbW92ZUV2ZW50TGlzdGVuZXIoICd1cGRhdGUnLCB0aGlzLm9uVGV4dHVyZVVwZGF0ZUJpbmQgKTsKCiAgICAvLyBzbyBpZiBfd2lkdGggaXMgMCB0aGVuIHdpZHRoIHdhcyBub3Qgc2V0Li4KICAgIGlmKHRoaXMuX3dpZHRoKXRoaXMuc2NhbGUueCA9IHRoaXMuX3dpZHRoIC8gdGhpcy50ZXh0dXJlLmZyYW1lLndpZHRoOwogICAgaWYodGhpcy5faGVpZ2h0KXRoaXMuc2NhbGUueSA9IHRoaXMuX2hlaWdodCAvIHRoaXMudGV4dHVyZS5mcmFtZS5oZWlnaHQ7CgogICAgdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cn07CgovLyBzb21lIGhlbHBlciBmdW5jdGlvbnMuLgoKLyoqCiAqCiAqIEhlbHBlciBmdW5jdGlvbiB0aGF0IGNyZWF0ZXMgYSBzcHJpdGUgdGhhdCB3aWxsIGNvbnRhaW4gYSB0ZXh0dXJlIGZyb20gdGhlIFRleHR1cmVDYWNoZSBiYXNlZCBvbiB0aGUgZnJhbWVJZAogKiBUaGUgZnJhbWUgaWRzIGFyZSBjcmVhdGVkIHdoZW4gYSBUZXh0dXJlIHBhY2tlciBmaWxlIGhhcyBiZWVuIGxvYWRlZAogKgogKiBAbWV0aG9kIGZyb21GcmFtZQogKiBAc3RhdGljCiAqIEBwYXJhbSBmcmFtZUlkIHtTdHJpbmd9IFRoZSBmcmFtZSBJZCBvZiB0aGUgdGV4dHVyZSBpbiB0aGUgY2FjaGUKICogQHJldHVybiB7U3ByaXRlfSBBIG5ldyBTcHJpdGUgdXNpbmcgYSB0ZXh0dXJlIGZyb20gdGhlIHRleHR1cmUgY2FjaGUgbWF0Y2hpbmcgdGhlIGZyYW1lSWQKICovClBJWEkuU3ByaXRlLmZyb21GcmFtZSA9IGZ1bmN0aW9uKGZyYW1lSWQpCnsKICAgIHZhciB0ZXh0dXJlID0gUElYSS5UZXh0dXJlQ2FjaGVbZnJhbWVJZF07CiAgICBpZighdGV4dHVyZSkgdGhyb3cgbmV3IEVycm9yKCdUaGUgZnJhbWVJZCAiJyArIGZyYW1lSWQgKyAnIiBkb2VzIG5vdCBleGlzdCBpbiB0aGUgdGV4dHVyZSBjYWNoZScgKyB0aGlzKTsKICAgIHJldHVybiBuZXcgUElYSS5TcHJpdGUodGV4dHVyZSk7Cn07CgovKioKICoKICogSGVscGVyIGZ1bmN0aW9uIHRoYXQgY3JlYXRlcyBhIHNwcml0ZSB0aGF0IHdpbGwgY29udGFpbiBhIHRleHR1cmUgYmFzZWQgb24gYW4gaW1hZ2UgdXJsCiAqIElmIHRoZSBpbWFnZSBpcyBub3QgaW4gdGhlIHRleHR1cmUgY2FjaGUgaXQgd2lsbCBiZSBsb2FkZWQKICoKICogQG1ldGhvZCBmcm9tSW1hZ2UKICogQHN0YXRpYwogKiBAcGFyYW0gaW1hZ2VJZCB7U3RyaW5nfSBUaGUgaW1hZ2UgdXJsIG9mIHRoZSB0ZXh0dXJlCiAqIEByZXR1cm4ge1Nwcml0ZX0gQSBuZXcgU3ByaXRlIHVzaW5nIGEgdGV4dHVyZSBmcm9tIHRoZSB0ZXh0dXJlIGNhY2hlIG1hdGNoaW5nIHRoZSBpbWFnZSBpZAogKi8KUElYSS5TcHJpdGUuZnJvbUltYWdlID0gZnVuY3Rpb24oaW1hZ2VJZCkKewogICAgdmFyIHRleHR1cmUgPSBQSVhJLlRleHR1cmUuZnJvbUltYWdlKGltYWdlSWQpOwogICAgcmV0dXJuIG5ldyBQSVhJLlNwcml0ZSh0ZXh0dXJlKTsKfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogQSBTdGFnZSByZXByZXNlbnRzIHRoZSByb290IG9mIHRoZSBkaXNwbGF5IHRyZWUuIEV2ZXJ5dGhpbmcgY29ubmVjdGVkIHRvIHRoZSBzdGFnZSBpcyByZW5kZXJlZAogKgogKiBAY2xhc3MgU3RhZ2UKICogQGV4dGVuZHMgRGlzcGxheU9iamVjdENvbnRhaW5lcgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIGJhY2tncm91bmRDb2xvciB7TnVtYmVyfSB0aGUgYmFja2dyb3VuZCBjb2xvciBvZiB0aGUgc3RhZ2UsIGVhc2llc3Qgd2F5IHRvIHBhc3MgdGhpcyBpbiBpcyBpbiBoZXggZm9ybWF0CiAqICAgICAgbGlrZTogMHhGRkZGRkYgZm9yIHdoaXRlCiAqLwpQSVhJLlN0YWdlID0gZnVuY3Rpb24oYmFja2dyb3VuZENvbG9yKQp7CiAgICBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCggdGhpcyApOwoKICAgIC8qKgogICAgICogW3JlYWQtb25seV0gQ3VycmVudCB0cmFuc2Zvcm0gb2YgdGhlIG9iamVjdCBiYXNlZCBvbiB3b3JsZCAocGFyZW50KSBmYWN0b3JzCiAgICAgKgogICAgICogQHByb3BlcnR5IHdvcmxkVHJhbnNmb3JtCiAgICAgKiBAdHlwZSBNYXQzCiAgICAgKiBAcmVhZE9ubHkKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHRoaXMud29ybGRUcmFuc2Zvcm0gPSBQSVhJLm1hdDMuY3JlYXRlKCk7CgogICAgLyoqCiAgICAgKiBXaGV0aGVyIG9yIG5vdCB0aGUgc3RhZ2UgaXMgaW50ZXJhY3RpdmUKICAgICAqCiAgICAgKiBAcHJvcGVydHkgaW50ZXJhY3RpdmUKICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAqLwogICAgdGhpcy5pbnRlcmFjdGl2ZSA9IHRydWU7CgogICAgLyoqCiAgICAgKiBUaGUgaW50ZXJhY3Rpb24gbWFuYWdlIGZvciB0aGlzIHN0YWdlLCBtYW5hZ2VzIGFsbCBpbnRlcmFjdGl2ZSBhY3Rpdml0eSBvbiB0aGUgc3RhZ2UKICAgICAqCiAgICAgKiBAcHJvcGVydHkgaW50ZXJhY3RpdmUKICAgICAqIEB0eXBlIEludGVyYWN0aW9uTWFuYWdlcgogICAgICovCiAgICB0aGlzLmludGVyYWN0aW9uTWFuYWdlciA9IG5ldyBQSVhJLkludGVyYWN0aW9uTWFuYWdlcih0aGlzKTsKCiAgICAvKioKICAgICAqIFdoZXRoZXIgdGhlIHN0YWdlIGlzIGRpcnR5IGFuZCBuZWVkcyB0byBoYXZlIGludGVyYWN0aW9ucyB1cGRhdGVkCiAgICAgKgogICAgICogQHByb3BlcnR5IGRpcnR5CiAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKCiAgICB0aGlzLl9fY2hpbGRyZW5BZGRlZCA9IFtdOwogICAgdGhpcy5fX2NoaWxkcmVuUmVtb3ZlZCA9IFtdOwoKICAgIC8vdGhlIHN0YWdlIGlzIGl0J3Mgb3duIHN0YWdlCiAgICB0aGlzLnN0YWdlID0gdGhpczsKCiAgICAvL29wdGltaXplIGhpdCBkZXRlY3Rpb24gYSBiaXQKICAgIHRoaXMuc3RhZ2UuaGl0QXJlYSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLDAsMTAwMDAwLCAxMDAwMDApOwoKICAgIHRoaXMuc2V0QmFja2dyb3VuZENvbG9yKGJhY2tncm91bmRDb2xvcik7CiAgICB0aGlzLndvcmxkVmlzaWJsZSA9IHRydWU7Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlN0YWdlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUgKTsKUElYSS5TdGFnZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlN0YWdlOwoKLyoqCiAqIFNldHMgYW5vdGhlciBET00gZWxlbWVudCB3aGljaCBjYW4gcmVjZWl2ZSBtb3VzZS90b3VjaCBpbnRlcmFjdGlvbnMgaW5zdGVhZCBvZiB0aGUgZGVmYXVsdCBDYW52YXMgZWxlbWVudC4KICogVGhpcyBpcyB1c2VmdWwgZm9yIHdoZW4geW91IGhhdmUgb3RoZXIgRE9NIGVsZW1lbnRzIG9udG9wIG9mIHRoZSBDYW52YXMgZWxlbWVudC4KICoKICogQG1ldGhvZCBzZXRJbnRlcmFjdGlvbkRlbGVnYXRlCiAqIEBwYXJhbSBkb21FbGVtZW50IHtET01FbGVtZW50fSBUaGlzIG5ldyBkb21FbGVtZW50IHdoaWNoIHdpbGwgcmVjZWl2ZSBtb3VzZS90b3VjaCBldmVudHMKICovClBJWEkuU3RhZ2UucHJvdG90eXBlLnNldEludGVyYWN0aW9uRGVsZWdhdGUgPSBmdW5jdGlvbihkb21FbGVtZW50KQp7CiAgICB0aGlzLmludGVyYWN0aW9uTWFuYWdlci5zZXRUYXJnZXREb21FbGVtZW50KCBkb21FbGVtZW50ICk7Cn07CgovKgogKiBVcGRhdGVzIHRoZSBvYmplY3QgdHJhbnNmb3JtIGZvciByZW5kZXJpbmcKICoKICogQG1ldGhvZCB1cGRhdGVUcmFuc2Zvcm0KICogQHByaXZhdGUKICovClBJWEkuU3RhZ2UucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybSA9IGZ1bmN0aW9uKCkKewogICAgdGhpcy53b3JsZEFscGhhID0gMTsKICAgIHRoaXMudmNvdW50ID0gUElYSS52aXNpYmxlQ291bnQ7CgogICAgZm9yKHZhciBpPTAsaj10aGlzLmNoaWxkcmVuLmxlbmd0aDsgaTxqOyBpKyspCiAgICB7CiAgICAgICAgdGhpcy5jaGlsZHJlbltpXS51cGRhdGVUcmFuc2Zvcm0oKTsKICAgIH0KCiAgICBpZih0aGlzLmRpcnR5KQogICAgewogICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgICAvLyB1cGRhdGUgaW50ZXJhY3RpdmUhCiAgICAgICAgdGhpcy5pbnRlcmFjdGlvbk1hbmFnZXIuZGlydHkgPSB0cnVlOwogICAgfQoKCiAgICBpZih0aGlzLmludGVyYWN0aXZlKXRoaXMuaW50ZXJhY3Rpb25NYW5hZ2VyLnVwZGF0ZSgpOwp9OwoKLyoqCiAqIFNldHMgdGhlIGJhY2tncm91bmQgY29sb3IgZm9yIHRoZSBzdGFnZQogKgogKiBAbWV0aG9kIHNldEJhY2tncm91bmRDb2xvcgogKiBAcGFyYW0gYmFja2dyb3VuZENvbG9yIHtOdW1iZXJ9IHRoZSBjb2xvciBvZiB0aGUgYmFja2dyb3VuZCwgZWFzaWVzdCB3YXkgdG8gcGFzcyB0aGlzIGluIGlzIGluIGhleCBmb3JtYXQKICogICAgICBsaWtlOiAweEZGRkZGRiBmb3Igd2hpdGUKICovClBJWEkuU3RhZ2UucHJvdG90eXBlLnNldEJhY2tncm91bmRDb2xvciA9IGZ1bmN0aW9uKGJhY2tncm91bmRDb2xvcikKewogICAgdGhpcy5iYWNrZ3JvdW5kQ29sb3IgPSBiYWNrZ3JvdW5kQ29sb3IgfHwgMHgwMDAwMDA7CiAgICB0aGlzLmJhY2tncm91bmRDb2xvclNwbGl0ID0gUElYSS5oZXgycmdiKHRoaXMuYmFja2dyb3VuZENvbG9yKTsKICAgIHZhciBoZXggPSB0aGlzLmJhY2tncm91bmRDb2xvci50b1N0cmluZygxNik7CiAgICBoZXggPSAnMDAwMDAwJy5zdWJzdHIoMCwgNiAtIGhleC5sZW5ndGgpICsgaGV4OwogICAgdGhpcy5iYWNrZ3JvdW5kQ29sb3JTdHJpbmcgPSAnIycgKyBoZXg7Cn07CgovKioKICogVGhpcyB3aWxsIHJldHVybiB0aGUgcG9pbnQgY29udGFpbmluZyBnbG9iYWwgY29vcmRzIG9mIHRoZSBtb3VzZS4KICoKICogQG1ldGhvZCBnZXRNb3VzZVBvc2l0aW9uCiAqIEByZXR1cm4ge1BvaW50fSBUaGUgcG9pbnQgY29udGFpbmluZyB0aGUgY29vcmRzIG9mIHRoZSBnbG9iYWwgSW50ZXJhY3Rpb25EYXRhIHBvc2l0aW9uLgogKi8KUElYSS5TdGFnZS5wcm90b3R5cGUuZ2V0TW91c2VQb3NpdGlvbiA9IGZ1bmN0aW9uKCkKewogICAgcmV0dXJuIHRoaXMuaW50ZXJhY3Rpb25NYW5hZ2VyLm1vdXNlLmdsb2JhbDsKfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKLyoqCiAqIFRoaXMgb2JqZWN0IGlzIG9uZSB0aGF0IHdpbGwgYWxsb3cgeW91IHRvIHNwZWNpZnkgY3VzdG9tIHJlbmRlcmluZyBmdW5jdGlvbnMgYmFzZWQgb24gcmVuZGVyIHR5cGUKICoKICogQGNsYXNzIEN1c3RvbVJlbmRlcmFibGUKICogQGV4dGVuZHMgRGlzcGxheU9iamVjdAogKiBAY29uc3RydWN0b3IKICovClBJWEkuQ3VzdG9tUmVuZGVyYWJsZSA9IGZ1bmN0aW9uKCkKewogICAgUElYSS5EaXNwbGF5T2JqZWN0LmNhbGwoIHRoaXMgKTsKCiAgICB0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwp9OwoKLy8gY29uc3RydWN0b3IKUElYSS5DdXN0b21SZW5kZXJhYmxlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUgKTsKUElYSS5DdXN0b21SZW5kZXJhYmxlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuQ3VzdG9tUmVuZGVyYWJsZTsKCi8qKgogKiBJZiB0aGlzIG9iamVjdCBpcyBiZWluZyByZW5kZXJlZCBieSBhIENhbnZhc1JlbmRlcmVyIGl0IHdpbGwgY2FsbCB0aGlzIGNhbGxiYWNrCiAqCiAqIEBtZXRob2QgcmVuZGVyQ2FudmFzCiAqIEBwYXJhbSByZW5kZXJlciB7Q2FudmFzUmVuZGVyZXJ9IFRoZSByZW5kZXJlciBpbnN0YW5jZQogKi8KUElYSS5DdXN0b21SZW5kZXJhYmxlLnByb3RvdHlwZS5yZW5kZXJDYW52YXMgPSBmdW5jdGlvbigpCnsKICAgIC8vIG92ZXJyaWRlIQp9OwoKLyoqCiAqIElmIHRoaXMgb2JqZWN0IGlzIGJlaW5nIHJlbmRlcmVkIGJ5IGEgV2ViR0xSZW5kZXJlciBpdCB3aWxsIGNhbGwgdGhpcyBjYWxsYmFjayB0byBpbml0aWFsaXplCiAqCiAqIEBtZXRob2QgaW5pdFdlYkdMCiAqIEBwYXJhbSByZW5kZXJlciB7V2ViR0xSZW5kZXJlcn0gVGhlIHJlbmRlcmVyIGluc3RhbmNlCiAqLwpQSVhJLkN1c3RvbVJlbmRlcmFibGUucHJvdG90eXBlLmluaXRXZWJHTCA9IGZ1bmN0aW9uKCkKewogICAgLy8gb3ZlcnJpZGUhCn07CgovKioKICogSWYgdGhpcyBvYmplY3QgaXMgYmVpbmcgcmVuZGVyZWQgYnkgYSBXZWJHTFJlbmRlcmVyIGl0IHdpbGwgY2FsbCB0aGlzIGNhbGxiYWNrCiAqCiAqIEBtZXRob2QgcmVuZGVyV2ViR0wKICogQHBhcmFtIHJlbmRlcmVyR3JvdXAge1dlYkdMUmVuZGVyR3JvdXB9IFRoZSByZW5kZXJlciBncm91cCBpbnN0YW5jZQogKiBAcGFyYW0gcHJvamVjdGlvbk1hdHJpeCB7TWF0cml4fSBUaGUgb2JqZWN0J3MgcHJvamVjdGlvbiBtYXRyaXgKICovClBJWEkuQ3VzdG9tUmVuZGVyYWJsZS5wcm90b3R5cGUucmVuZGVyV2ViR0wgPSBmdW5jdGlvbigpCnsKICAgIC8vIG5vdCBzdXJlIGlmIGJvdGggbmVlZGVkPyBidXQgeWEgaGF2ZSBmb3Igbm93IQogICAgLy8gb3ZlcnJpZGUhCn07CgoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8KICovCgpQSVhJLlN0cmlwID0gZnVuY3Rpb24odGV4dHVyZSwgd2lkdGgsIGhlaWdodCkKewogICAgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwoIHRoaXMgKTsKICAgIHRoaXMudGV4dHVyZSA9IHRleHR1cmU7CiAgICB0aGlzLmJsZW5kTW9kZSA9IFBJWEkuYmxlbmRNb2Rlcy5OT1JNQUw7CgogICAgdHJ5CiAgICB7CiAgICAgICAgdGhpcy51dnMgPSBuZXcgRmxvYXQzMkFycmF5KFswLCAxLAogICAgICAgICAgICAgICAgMSwgMSwKICAgICAgICAgICAgICAgIDEsIDAsIDAsMV0pOwoKICAgICAgICB0aGlzLnZlcnRpY2llcyA9IG5ldyBGbG9hdDMyQXJyYXkoWzAsIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgMCwwLAogICAgICAgICAgICAgICAgICAgICAgICAgIDAsMCwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAwLCAwXSk7CgogICAgICAgIHRoaXMuY29sb3JzID0gbmV3IEZsb2F0MzJBcnJheShbMSwgMSwgMSwgMV0pOwoKICAgICAgICB0aGlzLmluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoWzAsIDEsIDIsIDNdKTsKICAgIH0KICAgIGNhdGNoKGVycm9yKQogICAgewogICAgICAgIHRoaXMudXZzID0gWzAsIDEsCiAgICAgICAgICAgICAgICAxLCAxLAogICAgICAgICAgICAgICAgMSwgMCwgMCwxXTsKCiAgICAgICAgdGhpcy52ZXJ0aWNpZXMgPSBbMCwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAwLDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgMCwwLCAwLAogICAgICAgICAgICAgICAgICAgICAgICAgIDAsIDBdOwoKICAgICAgICB0aGlzLmNvbG9ycyA9IFsxLCAxLCAxLCAxXTsKCiAgICAgICAgdGhpcy5pbmRpY2VzID0gWzAsIDEsIDIsIDNdOwogICAgfQoKCiAgICAvKgogICAgdGhpcy51dnMgPSBuZXcgRmxvYXQzMkFycmF5KCkKICAgIHRoaXMudmVydGljaWVzID0gbmV3IEZsb2F0MzJBcnJheSgpCiAgICB0aGlzLmNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkoKQogICAgdGhpcy5pbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KCkKICAgICovCiAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKCiAgICAvLyBsb2FkIHRoZSB0ZXh0dXJlIQogICAgaWYodGV4dHVyZS5iYXNlVGV4dHVyZS5oYXNMb2FkZWQpCiAgICB7CiAgICAgICAgdGhpcy53aWR0aCAgID0gdGhpcy50ZXh0dXJlLmZyYW1lLndpZHRoOwogICAgICAgIHRoaXMuaGVpZ2h0ICA9IHRoaXMudGV4dHVyZS5mcmFtZS5oZWlnaHQ7CiAgICAgICAgdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5vblRleHR1cmVVcGRhdGVCaW5kID0gdGhpcy5vblRleHR1cmVVcGRhdGUuYmluZCh0aGlzKTsKICAgICAgICB0aGlzLnRleHR1cmUuYWRkRXZlbnRMaXN0ZW5lciggJ3VwZGF0ZScsIHRoaXMub25UZXh0dXJlVXBkYXRlQmluZCApOwogICAgfQoKICAgIHRoaXMucmVuZGVyYWJsZSA9IHRydWU7Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlN0cmlwLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUgKTsKUElYSS5TdHJpcC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlN0cmlwOwoKUElYSS5TdHJpcC5wcm90b3R5cGUuc2V0VGV4dHVyZSA9IGZ1bmN0aW9uKHRleHR1cmUpCnsKICAgIC8vVE9ETyBTRVQgVEhFIFRFWFRVUkVTCiAgICAvL1RPRE8gVklTSUJJTElUWQoKICAgIC8vIHN0b3AgY3VycmVudCB0ZXh0dXJlCiAgICB0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwogICAgdGhpcy53aWR0aCAgID0gdGV4dHVyZS5mcmFtZS53aWR0aDsKICAgIHRoaXMuaGVpZ2h0ICA9IHRleHR1cmUuZnJhbWUuaGVpZ2h0OwogICAgdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cn07CgpQSVhJLlN0cmlwLnByb3RvdHlwZS5vblRleHR1cmVVcGRhdGUgPSBmdW5jdGlvbigpCnsKICAgIHRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwp9OwovLyBzb21lIGhlbHBlciBmdW5jdGlvbnMuLgoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8KICovCgpQSVhJLlJvcGUgPSBmdW5jdGlvbih0ZXh0dXJlLCBwb2ludHMpCnsKICAgIFBJWEkuU3RyaXAuY2FsbCggdGhpcywgdGV4dHVyZSApOwogICAgdGhpcy5wb2ludHMgPSBwb2ludHM7CgogICAgdHJ5CiAgICB7CiAgICAgICAgdGhpcy52ZXJ0aWNpZXMgPSBuZXcgRmxvYXQzMkFycmF5KHBvaW50cy5sZW5ndGggKiA0KTsKICAgICAgICB0aGlzLnV2cyA9IG5ldyBGbG9hdDMyQXJyYXkocG9pbnRzLmxlbmd0aCAqIDQpOwogICAgICAgIHRoaXMuY29sb3JzID0gbmV3IEZsb2F0MzJBcnJheShwb2ludHMubGVuZ3RoICogMik7CiAgICAgICAgdGhpcy5pbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KHBvaW50cy5sZW5ndGggKiAyKTsKICAgIH0KICAgIGNhdGNoKGVycm9yKQogICAgewogICAgICAgIHRoaXMudmVydGljaWVzID0gbmV3IEFycmF5KHBvaW50cy5sZW5ndGggKiA0KTsKICAgICAgICB0aGlzLnV2cyA9IG5ldyBBcnJheShwb2ludHMubGVuZ3RoICogNCk7CiAgICAgICAgdGhpcy5jb2xvcnMgPSBuZXcgQXJyYXkocG9pbnRzLmxlbmd0aCAqIDIpOwogICAgICAgIHRoaXMuaW5kaWNlcyA9IG5ldyBBcnJheShwb2ludHMubGVuZ3RoICogMik7CiAgICB9CgogICAgdGhpcy5yZWZyZXNoKCk7Cn07CgoKLy8gY29uc3RydWN0b3IKUElYSS5Sb3BlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuU3RyaXAucHJvdG90eXBlICk7ClBJWEkuUm9wZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlJvcGU7CgpQSVhJLlJvcGUucHJvdG90eXBlLnJlZnJlc2ggPSBmdW5jdGlvbigpCnsKICAgIHZhciBwb2ludHMgPSB0aGlzLnBvaW50czsKICAgIGlmKHBvaW50cy5sZW5ndGggPCAxKSByZXR1cm47CgogICAgdmFyIHV2cyA9IHRoaXMudXZzOwoKICAgIHZhciBsYXN0UG9pbnQgPSBwb2ludHNbMF07CiAgICB2YXIgaW5kaWNlcyA9IHRoaXMuaW5kaWNlczsKICAgIHZhciBjb2xvcnMgPSB0aGlzLmNvbG9yczsKCiAgICB0aGlzLmNvdW50LT0wLjI7CgoKICAgIHV2c1swXSA9IDA7CiAgICB1dnNbMV0gPSAxOwogICAgdXZzWzJdID0gMDsKICAgIHV2c1szXSA9IDE7CgogICAgY29sb3JzWzBdID0gMTsKICAgIGNvbG9yc1sxXSA9IDE7CgogICAgaW5kaWNlc1swXSA9IDA7CiAgICBpbmRpY2VzWzFdID0gMTsKCiAgICB2YXIgdG90YWwgPSBwb2ludHMubGVuZ3RoLAogICAgICAgIHBvaW50LCBpbmRleCwgYW1vdW50OwoKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdG90YWw7IGkrKykKICAgIHsKCiAgICAgICAgcG9pbnQgPSBwb2ludHNbaV07CiAgICAgICAgaW5kZXggPSBpICogNDsKICAgICAgICAvLyB0aW1lIHRvIGRvIHNvbWUgc21hcnQgZHJhd2luZyEKICAgICAgICBhbW91bnQgPSBpIC8gKHRvdGFsLTEpOwoKICAgICAgICBpZihpJTIpCiAgICAgICAgewogICAgICAgICAgICB1dnNbaW5kZXhdID0gYW1vdW50OwogICAgICAgICAgICB1dnNbaW5kZXgrMV0gPSAwOwoKICAgICAgICAgICAgdXZzW2luZGV4KzJdID0gYW1vdW50OwogICAgICAgICAgICB1dnNbaW5kZXgrM10gPSAxOwoKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdXZzW2luZGV4XSA9IGFtb3VudDsKICAgICAgICAgICAgdXZzW2luZGV4KzFdID0gMDsKCiAgICAgICAgICAgIHV2c1tpbmRleCsyXSA9IGFtb3VudDsKICAgICAgICAgICAgdXZzW2luZGV4KzNdID0gMTsKICAgICAgICB9CgogICAgICAgIGluZGV4ID0gaSAqIDI7CiAgICAgICAgY29sb3JzW2luZGV4XSA9IDE7CiAgICAgICAgY29sb3JzW2luZGV4KzFdID0gMTsKCiAgICAgICAgaW5kZXggPSBpICogMjsKICAgICAgICBpbmRpY2VzW2luZGV4XSA9IGluZGV4OwogICAgICAgIGluZGljZXNbaW5kZXggKyAxXSA9IGluZGV4ICsgMTsKCiAgICAgICAgbGFzdFBvaW50ID0gcG9pbnQ7CiAgICB9Cn07CgpQSVhJLlJvcGUucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybSA9IGZ1bmN0aW9uKCkKewoKICAgIHZhciBwb2ludHMgPSB0aGlzLnBvaW50czsKICAgIGlmKHBvaW50cy5sZW5ndGggPCAxKXJldHVybjsKCiAgICB2YXIgbGFzdFBvaW50ID0gcG9pbnRzWzBdOwogICAgdmFyIG5leHRQb2ludDsKICAgIHZhciBwZXJwID0ge3g6MCwgeTowfTsKCiAgICB0aGlzLmNvdW50LT0wLjI7CgogICAgdmFyIHZlcnRpY2llcyA9IHRoaXMudmVydGljaWVzOwogICAgdmVydGljaWVzWzBdID0gbGFzdFBvaW50LnggKyBwZXJwLng7CiAgICB2ZXJ0aWNpZXNbMV0gPSBsYXN0UG9pbnQueSArIHBlcnAueTsgLy8rIDIwMAogICAgdmVydGljaWVzWzJdID0gbGFzdFBvaW50LnggLSBwZXJwLng7CiAgICB2ZXJ0aWNpZXNbM10gPSBsYXN0UG9pbnQueSAtIHBlcnAueTsvLysyMDAKICAgIC8vIHRpbWUgdG8gZG8gc29tZSBzbWFydCBkcmF3aW5nIQoKICAgIHZhciB0b3RhbCA9IHBvaW50cy5sZW5ndGgsCiAgICAgICAgcG9pbnQsIGluZGV4LCByYXRpbywgcGVycExlbmd0aCwgbnVtOwoKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdG90YWw7IGkrKykKICAgIHsKICAgICAgICBwb2ludCA9IHBvaW50c1tpXTsKICAgICAgICBpbmRleCA9IGkgKiA0OwoKICAgICAgICBpZihpIDwgcG9pbnRzLmxlbmd0aC0xKQogICAgICAgIHsKICAgICAgICAgICAgbmV4dFBvaW50ID0gcG9pbnRzW2krMV07CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIG5leHRQb2ludCA9IHBvaW50OwogICAgICAgIH0KCiAgICAgICAgcGVycC55ID0gLShuZXh0UG9pbnQueCAtIGxhc3RQb2ludC54KTsKICAgICAgICBwZXJwLnggPSBuZXh0UG9pbnQueSAtIGxhc3RQb2ludC55OwoKICAgICAgICByYXRpbyA9ICgxIC0gKGkgLyAodG90YWwtMSkpKSAqIDEwOwoKICAgICAgICBpZihyYXRpbyA+IDEpIHJhdGlvID0gMTsKCiAgICAgICAgcGVycExlbmd0aCA9IE1hdGguc3FydChwZXJwLnggKiBwZXJwLnggKyBwZXJwLnkgKiBwZXJwLnkpOwogICAgICAgIG51bSA9IHRoaXMudGV4dHVyZS5oZWlnaHQgLyAyOyAvLygyMCArIE1hdGguYWJzKE1hdGguc2luKChpICsgdGhpcy5jb3VudCkgKiAwLjMpICogNTApICkqIHJhdGlvOwogICAgICAgIHBlcnAueCAvPSBwZXJwTGVuZ3RoOwogICAgICAgIHBlcnAueSAvPSBwZXJwTGVuZ3RoOwoKICAgICAgICBwZXJwLnggKj0gbnVtOwogICAgICAgIHBlcnAueSAqPSBudW07CgogICAgICAgIHZlcnRpY2llc1tpbmRleF0gPSBwb2ludC54ICsgcGVycC54OwogICAgICAgIHZlcnRpY2llc1tpbmRleCsxXSA9IHBvaW50LnkgKyBwZXJwLnk7CiAgICAgICAgdmVydGljaWVzW2luZGV4KzJdID0gcG9pbnQueCAtIHBlcnAueDsKICAgICAgICB2ZXJ0aWNpZXNbaW5kZXgrM10gPSBwb2ludC55IC0gcGVycC55OwoKICAgICAgICBsYXN0UG9pbnQgPSBwb2ludDsKICAgIH0KCiAgICBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybS5jYWxsKCB0aGlzICk7Cn07CgpQSVhJLlJvcGUucHJvdG90eXBlLnNldFRleHR1cmUgPSBmdW5jdGlvbih0ZXh0dXJlKQp7CiAgICAvLyBzdG9wIGN1cnJlbnQgdGV4dHVyZQogICAgdGhpcy50ZXh0dXJlID0gdGV4dHVyZTsKICAgIHRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwp9OwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8KICovCgovKioKICogQSB0aWxpbmcgc3ByaXRlIGlzIGEgZmFzdCB3YXkgb2YgcmVuZGVyaW5nIGEgdGlsaW5nIGltYWdlCiAqCiAqIEBjbGFzcyBUaWxpbmdTcHJpdGUKICogQGV4dGVuZHMgRGlzcGxheU9iamVjdENvbnRhaW5lcgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHRleHR1cmUge1RleHR1cmV9IHRoZSB0ZXh0dXJlIG9mIHRoZSB0aWxpbmcgc3ByaXRlCiAqIEBwYXJhbSB3aWR0aCB7TnVtYmVyfSAgdGhlIHdpZHRoIG9mIHRoZSB0aWxpbmcgc3ByaXRlCiAqIEBwYXJhbSBoZWlnaHQge051bWJlcn0gdGhlIGhlaWdodCBvZiB0aGUgdGlsaW5nIHNwcml0ZQogKi8KUElYSS5UaWxpbmdTcHJpdGUgPSBmdW5jdGlvbih0ZXh0dXJlLCB3aWR0aCwgaGVpZ2h0KQp7CiAgICBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCggdGhpcyApOwoKICAgIC8qKgogICAgICogVGhlIHRleHR1cmUgdGhhdCB0aGUgc3ByaXRlIGlzIHVzaW5nCiAgICAgKgogICAgICogQHByb3BlcnR5IHRleHR1cmUKICAgICAqIEB0eXBlIFRleHR1cmUKICAgICAqLwogICAgdGhpcy50ZXh0dXJlID0gdGV4dHVyZTsKCiAgICAvKioKICAgICAqIFRoZSB3aWR0aCBvZiB0aGUgdGlsaW5nIHNwcml0ZQogICAgICoKICAgICAqIEBwcm9wZXJ0eSB3aWR0aAogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKi8KICAgIHRoaXMud2lkdGggPSB3aWR0aDsKCiAgICAvKioKICAgICAqIFRoZSBoZWlnaHQgb2YgdGhlIHRpbGluZyBzcHJpdGUKICAgICAqCiAgICAgKiBAcHJvcGVydHkgaGVpZ2h0CiAgICAgKiBAdHlwZSBOdW1iZXIKICAgICAqLwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgLyoqCiAgICAgKiBUaGUgc2NhbGluZyBvZiB0aGUgaW1hZ2UgdGhhdCBpcyBiZWluZyB0aWxlZAogICAgICoKICAgICAqIEBwcm9wZXJ0eSB0aWxlU2NhbGUKICAgICAqIEB0eXBlIFBvaW50CiAgICAgKi8KICAgIHRoaXMudGlsZVNjYWxlID0gbmV3IFBJWEkuUG9pbnQoMSwxKTsKCiAgICAvKioKICAgICAqIFRoZSBvZmZzZXQgcG9zaXRpb24gb2YgdGhlIGltYWdlIHRoYXQgaXMgYmVpbmcgdGlsZWQKICAgICAqCiAgICAgKiBAcHJvcGVydHkgdGlsZVBvc2l0aW9uCiAgICAgKiBAdHlwZSBQb2ludAogICAgICovCiAgICB0aGlzLnRpbGVQb3NpdGlvbiA9IG5ldyBQSVhJLlBvaW50KDAsMCk7CgogICAgdGhpcy5yZW5kZXJhYmxlID0gdHJ1ZTsKCiAgICB0aGlzLmJsZW5kTW9kZSA9IFBJWEkuYmxlbmRNb2Rlcy5OT1JNQUw7Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlRpbGluZ1Nwcml0ZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlICk7ClBJWEkuVGlsaW5nU3ByaXRlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuVGlsaW5nU3ByaXRlOwoKLyoqCiAqIFNldHMgdGhlIHRleHR1cmUgb2YgdGhlIHRpbGluZyBzcHJpdGUKICoKICogQG1ldGhvZCBzZXRUZXh0dXJlCiAqIEBwYXJhbSB0ZXh0dXJlIHtUZXh0dXJlfSBUaGUgUElYSSB0ZXh0dXJlIHRoYXQgaXMgZGlzcGxheWVkIGJ5IHRoZSBzcHJpdGUKICovClBJWEkuVGlsaW5nU3ByaXRlLnByb3RvdHlwZS5zZXRUZXh0dXJlID0gZnVuY3Rpb24odGV4dHVyZSkKewogICAgLy9UT0RPIFNFVCBUSEUgVEVYVFVSRVMKICAgIC8vVE9ETyBWSVNJQklMSVRZCgogICAgLy8gc3RvcCBjdXJyZW50IHRleHR1cmUKICAgIHRoaXMudGV4dHVyZSA9IHRleHR1cmU7CiAgICB0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKfTsKCi8qKgogKiBXaGVuIHRoZSB0ZXh0dXJlIGlzIHVwZGF0ZWQsIHRoaXMgZXZlbnQgd2lsbCBmaXJlIHRvIHVwZGF0ZSB0aGUgZnJhbWUKICoKICogQG1ldGhvZCBvblRleHR1cmVVcGRhdGUKICogQHBhcmFtIGV2ZW50CiAqIEBwcml2YXRlCiAqLwpQSVhJLlRpbGluZ1Nwcml0ZS5wcm90b3R5cGUub25UZXh0dXJlVXBkYXRlID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogVGhpcyBpcyB0aGUgYmFzZSBjbGFzcyBmb3IgIGNyZWF0aW5nIGEgcGl4aS5qcyBmaWx0ZXIuIEN1cnJlbnRseSBvbmx5IHdlYkdMIHN1cHBvcnRzIGZpbHRlcnMuCiAqIElmIHlvdSB3YW50IHRvIG1ha2UgYSBjdXN0b20gZmlsdGVyIHRoaXMgc2hvdWxkIGJlIHlvdXIgYmFzZSBjbGFzcy4KICogQGNsYXNzIEFic3RyYWN0RmlsdGVyCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gZnJhZ21lbnRTcmMKICogQHBhcmFtIHVuaWZvcm1zCiAqLwpQSVhJLkFic3RyYWN0RmlsdGVyID0gZnVuY3Rpb24oZnJhZ21lbnRTcmMsIHVuaWZvcm1zKQp7CiAgICAvKioKICAgICogQW4gYXJyYXkgb2YgcGFzc2VzIC0gc29tZSBmaWx0ZXJzIGNvbnRhaW4gYSBmZXcgc3RlcHMgdGhpcyBhcnJheSBzaW1wbHkgc3RvcmVzIHRoZSBzdGVwcyBpbiBhIGxpbmllYXIgZmFzaGlvbi4KICAgICogRm9yIGV4YW1wbGUgdGhlIGJsdXIgZmlsdGVyIGhhcyB0d28gcGFzc2VzIGJsdXJYIGFuZCBibHVyWS4KICAgICogQHByb3BlcnR5IHBhc3NlcwogICAgKiBAdHlwZSBBcnJheSBhbiBhcnJheSBvZiBmaWx0ZXIgb2JqZWN0cwogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMucGFzc2VzID0gW3RoaXNdOwoKCiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIHRoaXMucGFkZGluZyA9IDA7CgogICAgLyoqCiAgICBAcHJvcGVydHkgdW5pZm9ybXMKICAgIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy51bmlmb3JtcyA9IHVuaWZvcm1zIHx8IHt9OwoKICAgIHRoaXMuZnJhZ21lbnRTcmMgPSBmcmFnbWVudFNyYyB8fCBbXTsKfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKClBJWEkuRmlsdGVyQmxvY2sgPSBmdW5jdGlvbigpCnsKICAgIHRoaXMudmlzaWJsZSA9IHRydWU7CiAgICB0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwp9OwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgovKioKICogVGhlIEdyYXBoaWNzIGNsYXNzIGNvbnRhaW5zIGEgc2V0IG9mIG1ldGhvZHMgdGhhdCB5b3UgY2FuIHVzZSB0byBjcmVhdGUgcHJpbWl0aXZlIHNoYXBlcyBhbmQgbGluZXMuCiAqIEl0IGlzIGltcG9ydGFudCB0byBrbm93IHRoYXQgd2l0aCB0aGUgd2ViR0wgcmVuZGVyZXIgb25seSBzaW1wbGUgcG9seXMgY2FuIGJlIGZpbGxlZCBhdCB0aGlzIHN0YWdlCiAqIENvbXBsZXggcG9seXMgd2lsbCBub3QgYmUgZmlsbGVkLiBIZXJlcyBhbiBleGFtcGxlIG9mIGEgY29tcGxleCBwb2x5OiBodHRwOi8vd3d3Lmdvb2Rib3lkaWdpdGFsLmNvbS93cC1jb250ZW50L3VwbG9hZHMvMjAxMy8wNi9jb21wbGV4UG9seWdvbi5wbmcKICoKICogQGNsYXNzIEdyYXBoaWNzCiAqIEBleHRlbmRzIERpc3BsYXlPYmplY3RDb250YWluZXIKICogQGNvbnN0cnVjdG9yCiAqLwpQSVhJLkdyYXBoaWNzID0gZnVuY3Rpb24oKQp7CiAgICBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCggdGhpcyApOwoKICAgIHRoaXMucmVuZGVyYWJsZSA9IHRydWU7CgogICAgLyoqCiAgICAgKiBUaGUgYWxwaGEgb2YgdGhlIGZpbGwgb2YgdGhpcyBncmFwaGljcyBvYmplY3QKICAgICAqCiAgICAgKiBAcHJvcGVydHkgZmlsbEFscGhhCiAgICAgKiBAdHlwZSBOdW1iZXIKICAgICAqLwogICAgdGhpcy5maWxsQWxwaGEgPSAxOwoKICAgIC8qKgogICAgICogVGhlIHdpZHRoIG9mIGFueSBsaW5lcyBkcmF3bgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBsaW5lV2lkdGgKICAgICAqIEB0eXBlIE51bWJlcgogICAgICovCiAgICB0aGlzLmxpbmVXaWR0aCA9IDA7CgogICAgLyoqCiAgICAgKiBUaGUgY29sb3Igb2YgYW55IGxpbmVzIGRyYXduCiAgICAgKgogICAgICogQHByb3BlcnR5IGxpbmVDb2xvcgogICAgICogQHR5cGUgU3RyaW5nCiAgICAgKi8KICAgIHRoaXMubGluZUNvbG9yID0gImJsYWNrIjsKCiAgICAvKioKICAgICAqIEdyYXBoaWNzIGRhdGEKICAgICAqCiAgICAgKiBAcHJvcGVydHkgZ3JhcGhpY3NEYXRhCiAgICAgKiBAdHlwZSBBcnJheQogICAgICogQHByaXZhdGUKICAgICAqLwogICAgdGhpcy5ncmFwaGljc0RhdGEgPSBbXTsKCiAgICAvKioKICAgICAqIEN1cnJlbnQgcGF0aAogICAgICoKICAgICAqIEBwcm9wZXJ0eSBjdXJyZW50UGF0aAogICAgICogQHR5cGUgT2JqZWN0CiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICB0aGlzLmN1cnJlbnRQYXRoID0ge3BvaW50czpbXX07Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUgKTsKUElYSS5HcmFwaGljcy5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLkdyYXBoaWNzOwoKLyoqCiAqIFNwZWNpZmllcyBhIGxpbmUgc3R5bGUgdXNlZCBmb3Igc3Vic2VxdWVudCBjYWxscyB0byBHcmFwaGljcyBtZXRob2RzIHN1Y2ggYXMgdGhlIGxpbmVUbygpIG1ldGhvZCBvciB0aGUgZHJhd0NpcmNsZSgpIG1ldGhvZC4KICoKICogQG1ldGhvZCBsaW5lU3R5bGUKICogQHBhcmFtIGxpbmVXaWR0aCB7TnVtYmVyfSB3aWR0aCBvZiB0aGUgbGluZSB0byBkcmF3LCB3aWxsIHVwZGF0ZSB0aGUgb2JqZWN0J3Mgc3RvcmVkIHN0eWxlCiAqIEBwYXJhbSBjb2xvciB7TnVtYmVyfSBjb2xvciBvZiB0aGUgbGluZSB0byBkcmF3LCB3aWxsIHVwZGF0ZSB0aGUgb2JqZWN0J3Mgc3RvcmVkIHN0eWxlCiAqIEBwYXJhbSBhbHBoYSB7TnVtYmVyfSBhbHBoYSBvZiB0aGUgbGluZSB0byBkcmF3LCB3aWxsIHVwZGF0ZSB0aGUgb2JqZWN0J3Mgc3RvcmVkIHN0eWxlCiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5saW5lU3R5bGUgPSBmdW5jdGlvbihsaW5lV2lkdGgsIGNvbG9yLCBhbHBoYSkKewogICAgaWYgKCF0aGlzLmN1cnJlbnRQYXRoLnBvaW50cy5sZW5ndGgpIHRoaXMuZ3JhcGhpY3NEYXRhLnBvcCgpOwoKICAgIHRoaXMubGluZVdpZHRoID0gbGluZVdpZHRoIHx8IDA7CiAgICB0aGlzLmxpbmVDb2xvciA9IGNvbG9yIHx8IDA7CiAgICB0aGlzLmxpbmVBbHBoYSA9IChhcmd1bWVudHMubGVuZ3RoIDwgMykgPyAxIDogYWxwaGE7CgogICAgdGhpcy5jdXJyZW50UGF0aCA9IHtsaW5lV2lkdGg6dGhpcy5saW5lV2lkdGgsIGxpbmVDb2xvcjp0aGlzLmxpbmVDb2xvciwgbGluZUFscGhhOnRoaXMubGluZUFscGhhLAogICAgICAgICAgICAgICAgICAgICAgICBmaWxsQ29sb3I6dGhpcy5maWxsQ29sb3IsIGZpbGxBbHBoYTp0aGlzLmZpbGxBbHBoYSwgZmlsbDp0aGlzLmZpbGxpbmcsIHBvaW50czpbXSwgdHlwZTpQSVhJLkdyYXBoaWNzLlBPTFl9OwoKICAgIHRoaXMuZ3JhcGhpY3NEYXRhLnB1c2godGhpcy5jdXJyZW50UGF0aCk7Cn07CgovKioKICogTW92ZXMgdGhlIGN1cnJlbnQgZHJhd2luZyBwb3NpdGlvbiB0byAoeCwgeSkuCiAqCiAqIEBtZXRob2QgbW92ZVRvCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IHRoZSBYIGNvb3JkIHRvIG1vdmUgdG8KICogQHBhcmFtIHkge051bWJlcn0gdGhlIFkgY29vcmQgdG8gbW92ZSB0bwogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUubW92ZVRvID0gZnVuY3Rpb24oeCwgeSkKewogICAgaWYgKCF0aGlzLmN1cnJlbnRQYXRoLnBvaW50cy5sZW5ndGgpIHRoaXMuZ3JhcGhpY3NEYXRhLnBvcCgpOwoKICAgIHRoaXMuY3VycmVudFBhdGggPSB0aGlzLmN1cnJlbnRQYXRoID0ge2xpbmVXaWR0aDp0aGlzLmxpbmVXaWR0aCwgbGluZUNvbG9yOnRoaXMubGluZUNvbG9yLCBsaW5lQWxwaGE6dGhpcy5saW5lQWxwaGEsCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGxDb2xvcjp0aGlzLmZpbGxDb2xvciwgZmlsbEFscGhhOnRoaXMuZmlsbEFscGhhLCBmaWxsOnRoaXMuZmlsbGluZywgcG9pbnRzOltdLCB0eXBlOlBJWEkuR3JhcGhpY3MuUE9MWX07CgogICAgdGhpcy5jdXJyZW50UGF0aC5wb2ludHMucHVzaCh4LCB5KTsKCiAgICB0aGlzLmdyYXBoaWNzRGF0YS5wdXNoKHRoaXMuY3VycmVudFBhdGgpOwp9OwoKLyoqCiAqIERyYXdzIGEgbGluZSB1c2luZyB0aGUgY3VycmVudCBsaW5lIHN0eWxlIGZyb20gdGhlIGN1cnJlbnQgZHJhd2luZyBwb3NpdGlvbiB0byAoeCwgeSk7CiAqIHRoZSBjdXJyZW50IGRyYXdpbmcgcG9zaXRpb24gaXMgdGhlbiBzZXQgdG8gKHgsIHkpLgogKgogKiBAbWV0aG9kIGxpbmVUbwogKiBAcGFyYW0geCB7TnVtYmVyfSB0aGUgWCBjb29yZCB0byBkcmF3IHRvCiAqIEBwYXJhbSB5IHtOdW1iZXJ9IHRoZSBZIGNvb3JkIHRvIGRyYXcgdG8KICovClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLmxpbmVUbyA9IGZ1bmN0aW9uKHgsIHkpCnsKICAgIHRoaXMuY3VycmVudFBhdGgucG9pbnRzLnB1c2goeCwgeSk7CiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKfTsKCi8qKgogKiBTcGVjaWZpZXMgYSBzaW1wbGUgb25lLWNvbG9yIGZpbGwgdGhhdCBzdWJzZXF1ZW50IGNhbGxzIHRvIG90aGVyIEdyYXBoaWNzIG1ldGhvZHMKICogKHN1Y2ggYXMgbGluZVRvKCkgb3IgZHJhd0NpcmNsZSgpKSB1c2Ugd2hlbiBkcmF3aW5nLgogKgogKiBAbWV0aG9kIGJlZ2luRmlsbAogKiBAcGFyYW0gY29sb3Ige3VpbnR9IHRoZSBjb2xvciBvZiB0aGUgZmlsbAogKiBAcGFyYW0gYWxwaGEge051bWJlcn0gdGhlIGFscGhhCiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5iZWdpbkZpbGwgPSBmdW5jdGlvbihjb2xvciwgYWxwaGEpCnsKICAgIHRoaXMuZmlsbGluZyA9IHRydWU7CiAgICB0aGlzLmZpbGxDb2xvciA9IGNvbG9yIHx8IDA7CiAgICB0aGlzLmZpbGxBbHBoYSA9IChhcmd1bWVudHMubGVuZ3RoIDwgMikgPyAxIDogYWxwaGE7Cn07CgovKioKICogQXBwbGllcyBhIGZpbGwgdG8gdGhlIGxpbmVzIGFuZCBzaGFwZXMgdGhhdCB3ZXJlIGFkZGVkIHNpbmNlIHRoZSBsYXN0IGNhbGwgdG8gdGhlIGJlZ2luRmlsbCgpIG1ldGhvZC4KICoKICogQG1ldGhvZCBlbmRGaWxsCiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5lbmRGaWxsID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLmZpbGxpbmcgPSBmYWxzZTsKICAgIHRoaXMuZmlsbENvbG9yID0gbnVsbDsKICAgIHRoaXMuZmlsbEFscGhhID0gMTsKfTsKCi8qKgogKiBAbWV0aG9kIGRyYXdSZWN0CiAqCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IFRoZSBYIGNvb3JkIG9mIHRoZSB0b3AtbGVmdCBvZiB0aGUgcmVjdGFuZ2xlCiAqIEBwYXJhbSB5IHtOdW1iZXJ9IFRoZSBZIGNvb3JkIG9mIHRoZSB0b3AtbGVmdCBvZiB0aGUgcmVjdGFuZ2xlCiAqIEBwYXJhbSB3aWR0aCB7TnVtYmVyfSBUaGUgd2lkdGggb2YgdGhlIHJlY3RhbmdsZQogKiBAcGFyYW0gaGVpZ2h0IHtOdW1iZXJ9IFRoZSBoZWlnaHQgb2YgdGhlIHJlY3RhbmdsZQogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUuZHJhd1JlY3QgPSBmdW5jdGlvbiggeCwgeSwgd2lkdGgsIGhlaWdodCApCnsKICAgIGlmICghdGhpcy5jdXJyZW50UGF0aC5wb2ludHMubGVuZ3RoKSB0aGlzLmdyYXBoaWNzRGF0YS5wb3AoKTsKCiAgICB0aGlzLmN1cnJlbnRQYXRoID0ge2xpbmVXaWR0aDp0aGlzLmxpbmVXaWR0aCwgbGluZUNvbG9yOnRoaXMubGluZUNvbG9yLCBsaW5lQWxwaGE6dGhpcy5saW5lQWxwaGEsCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGxDb2xvcjp0aGlzLmZpbGxDb2xvciwgZmlsbEFscGhhOnRoaXMuZmlsbEFscGhhLCBmaWxsOnRoaXMuZmlsbGluZywKICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnRzOlt4LCB5LCB3aWR0aCwgaGVpZ2h0XSwgdHlwZTpQSVhJLkdyYXBoaWNzLlJFQ1R9OwoKICAgIHRoaXMuZ3JhcGhpY3NEYXRhLnB1c2godGhpcy5jdXJyZW50UGF0aCk7CiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKfTsKCi8qKgogKiBEcmF3cyBhIGNpcmNsZS4KICoKICogQG1ldGhvZCBkcmF3Q2lyY2xlCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IFRoZSBYIGNvb3JkIG9mIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZQogKiBAcGFyYW0geSB7TnVtYmVyfSBUaGUgWSBjb29yZCBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUKICogQHBhcmFtIHJhZGl1cyB7TnVtYmVyfSBUaGUgcmFkaXVzIG9mIHRoZSBjaXJjbGUKICovClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLmRyYXdDaXJjbGUgPSBmdW5jdGlvbiggeCwgeSwgcmFkaXVzKQp7CiAgICBpZiAoIXRoaXMuY3VycmVudFBhdGgucG9pbnRzLmxlbmd0aCkgdGhpcy5ncmFwaGljc0RhdGEucG9wKCk7CgogICAgdGhpcy5jdXJyZW50UGF0aCA9IHtsaW5lV2lkdGg6dGhpcy5saW5lV2lkdGgsIGxpbmVDb2xvcjp0aGlzLmxpbmVDb2xvciwgbGluZUFscGhhOnRoaXMubGluZUFscGhhLAogICAgICAgICAgICAgICAgICAgICAgICBmaWxsQ29sb3I6dGhpcy5maWxsQ29sb3IsIGZpbGxBbHBoYTp0aGlzLmZpbGxBbHBoYSwgZmlsbDp0aGlzLmZpbGxpbmcsCiAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50czpbeCwgeSwgcmFkaXVzLCByYWRpdXNdLCB0eXBlOlBJWEkuR3JhcGhpY3MuQ0lSQ307CgogICAgdGhpcy5ncmFwaGljc0RhdGEucHVzaCh0aGlzLmN1cnJlbnRQYXRoKTsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwp9OwoKLyoqCiAqIERyYXdzIGFuIGVsbGlwc2UuCiAqCiAqIEBtZXRob2QgZHJhd0VsbGlwc2UKICogQHBhcmFtIHgge051bWJlcn0KICogQHBhcmFtIHkge051bWJlcn0KICogQHBhcmFtIHdpZHRoIHtOdW1iZXJ9CiAqIEBwYXJhbSBoZWlnaHQge051bWJlcn0KICovClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLmRyYXdFbGxpcHNlID0gZnVuY3Rpb24oIHgsIHksIHdpZHRoLCBoZWlnaHQpCnsKICAgIGlmICghdGhpcy5jdXJyZW50UGF0aC5wb2ludHMubGVuZ3RoKSB0aGlzLmdyYXBoaWNzRGF0YS5wb3AoKTsKCiAgICB0aGlzLmN1cnJlbnRQYXRoID0ge2xpbmVXaWR0aDp0aGlzLmxpbmVXaWR0aCwgbGluZUNvbG9yOnRoaXMubGluZUNvbG9yLCBsaW5lQWxwaGE6dGhpcy5saW5lQWxwaGEsCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGxDb2xvcjp0aGlzLmZpbGxDb2xvciwgZmlsbEFscGhhOnRoaXMuZmlsbEFscGhhLCBmaWxsOnRoaXMuZmlsbGluZywKICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnRzOlt4LCB5LCB3aWR0aCwgaGVpZ2h0XSwgdHlwZTpQSVhJLkdyYXBoaWNzLkVMSVB9OwoKICAgIHRoaXMuZ3JhcGhpY3NEYXRhLnB1c2godGhpcy5jdXJyZW50UGF0aCk7CiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKfTsKCi8qKgogKiBDbGVhcnMgdGhlIGdyYXBoaWNzIHRoYXQgd2VyZSBkcmF3biB0byB0aGlzIEdyYXBoaWNzIG9iamVjdCwgYW5kIHJlc2V0cyBmaWxsIGFuZCBsaW5lIHN0eWxlIHNldHRpbmdzLgogKgogKiBAbWV0aG9kIGNsZWFyCiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKCkKewogICAgdGhpcy5saW5lV2lkdGggPSAwOwogICAgdGhpcy5maWxsaW5nID0gZmFsc2U7CgogICAgdGhpcy5kaXJ0eSA9IHRydWU7CiAgICB0aGlzLmNsZWFyRGlydHkgPSB0cnVlOwogICAgdGhpcy5ncmFwaGljc0RhdGEgPSBbXTsKCiAgICB0aGlzLmJvdW5kcyA9IG51bGw7IC8vbmV3IFBJWEkuUmVjdGFuZ2xlKCk7Cn07CgoKUElYSS5HcmFwaGljcy5wcm90b3R5cGUudXBkYXRlRmlsdGVyQm91bmRzID0gZnVuY3Rpb24oKQp7CiAgICBpZighdGhpcy5ib3VuZHMpCiAgICB7CiAgICAgICAgdmFyIG1pblggPSBJbmZpbml0eTsKICAgICAgICB2YXIgbWF4WCA9IC1JbmZpbml0eTsKCiAgICAgICAgdmFyIG1pblkgPSBJbmZpbml0eTsKICAgICAgICB2YXIgbWF4WSA9IC1JbmZpbml0eTsKCiAgICAgICAgdmFyIHBvaW50cywgeCwgeTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmdyYXBoaWNzRGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgZGF0YSA9IHRoaXMuZ3JhcGhpY3NEYXRhW2ldOwogICAgICAgICAgICB2YXIgdHlwZSA9IGRhdGEudHlwZTsKICAgICAgICAgICAgdmFyIGxpbmVXaWR0aCA9IGRhdGEubGluZVdpZHRoOwoKICAgICAgICAgICAgcG9pbnRzID0gZGF0YS5wb2ludHM7CgogICAgICAgICAgICBpZih0eXBlID09PSBQSVhJLkdyYXBoaWNzLlJFQ1QpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHggPSBwb2ludHMueCAtIGxpbmVXaWR0aC8yOwogICAgICAgICAgICAgICAgeSA9IHBvaW50cy55IC0gbGluZVdpZHRoLzI7CiAgICAgICAgICAgICAgICB2YXIgd2lkdGggPSBwb2ludHMud2lkdGggKyBsaW5lV2lkdGg7CiAgICAgICAgICAgICAgICB2YXIgaGVpZ2h0ID0gcG9pbnRzLmhlaWdodCArIGxpbmVXaWR0aDsKCiAgICAgICAgICAgICAgICBtaW5YID0geCA8IG1pblggPyB4IDogbWluWDsKICAgICAgICAgICAgICAgIG1heFggPSB4ICsgd2lkdGggPiBtYXhYID8geCArIHdpZHRoIDogbWF4WDsKCiAgICAgICAgICAgICAgICBtaW5ZID0geSA8IG1pblkgPyB4IDogbWluWTsKICAgICAgICAgICAgICAgIG1heFkgPSB5ICsgaGVpZ2h0ID4gbWF4WSA/IHkgKyBoZWlnaHQgOiBtYXhZOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYodHlwZSA9PT0gUElYSS5HcmFwaGljcy5DSVJDIHx8IHR5cGUgPT09IFBJWEkuR3JhcGhpY3MuRUxJUCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgeCA9IHBvaW50cy54OwogICAgICAgICAgICAgICAgeSA9IHBvaW50cy55OwogICAgICAgICAgICAgICAgdmFyIHJhZGl1cyA9IHBvaW50cy5yYWRpdXMgKyBsaW5lV2lkdGgvMjsKCiAgICAgICAgICAgICAgICBtaW5YID0geCAtIHJhZGl1cyA8IG1pblggPyB4IC0gcmFkaXVzIDogbWluWDsKICAgICAgICAgICAgICAgIG1heFggPSB4ICsgcmFkaXVzID4gbWF4WCA/IHggKyByYWRpdXMgOiBtYXhYOwoKICAgICAgICAgICAgICAgIG1pblkgPSB5IC0gcmFkaXVzIDwgbWluWSA/IHkgLSByYWRpdXMgOiBtaW5ZOwogICAgICAgICAgICAgICAgbWF4WSA9IHkgKyByYWRpdXMgPiBtYXhZID8geSArIHJhZGl1cyA6IG1heFk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBQT0xZCiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHBvaW50cy5sZW5ndGg7IGorPTIpCiAgICAgICAgICAgICAgICB7CgogICAgICAgICAgICAgICAgICAgIHggPSBwb2ludHNbal07CiAgICAgICAgICAgICAgICAgICAgeSA9IHBvaW50c1tqKzFdOwoKICAgICAgICAgICAgICAgICAgICBtaW5YID0geC1saW5lV2lkdGggPCBtaW5YID8geC1saW5lV2lkdGggOiBtaW5YOwogICAgICAgICAgICAgICAgICAgIG1heFggPSB4K2xpbmVXaWR0aCA+IG1heFggPyB4K2xpbmVXaWR0aCA6IG1heFg7CgogICAgICAgICAgICAgICAgICAgIG1pblkgPSB5LWxpbmVXaWR0aCA8IG1pblkgPyB5LWxpbmVXaWR0aCA6IG1pblk7CiAgICAgICAgICAgICAgICAgICAgbWF4WSA9IHkrbGluZVdpZHRoID4gbWF4WSA/IHkrbGluZVdpZHRoIDogbWF4WTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5ib3VuZHMgPSBuZXcgUElYSS5SZWN0YW5nbGUobWluWCwgbWluWSwgbWF4WCAtIG1pblgsIG1heFkgLSBtaW5ZKTsKICAgIH0KLy8gIGNvbnNvbGUubG9nKHRoaXMuYm91bmRzKTsKfTsKCi8vIFNPTUUgVFlQRVM6ClBJWEkuR3JhcGhpY3MuUE9MWSA9IDA7ClBJWEkuR3JhcGhpY3MuUkVDVCA9IDE7ClBJWEkuR3JhcGhpY3MuQ0lSQyA9IDI7ClBJWEkuR3JhcGhpY3MuRUxJUCA9IDM7CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKCi8qKgogKiBBIHNldCBvZiBmdW5jdGlvbnMgdXNlZCBieSB0aGUgY2FudmFzIHJlbmRlcmVyIHRvIGRyYXcgdGhlIHByaW1pdGl2ZSBncmFwaGljcyBkYXRhCiAqCiAqIEBjbGFzcyBDYW52YXNHcmFwaGljcwogKi8KUElYSS5DYW52YXNHcmFwaGljcyA9IGZ1bmN0aW9uKCkKewoKfTsKCgovKgogKiBSZW5kZXJzIHRoZSBncmFwaGljcyBvYmplY3QKICoKICogQHN0YXRpYwogKiBAcHJpdmF0ZQogKiBAbWV0aG9kIHJlbmRlckdyYXBoaWNzCiAqIEBwYXJhbSBncmFwaGljcyB7R3JhcGhpY3N9CiAqIEBwYXJhbSBjb250ZXh0IHtDb250ZXh0MkR9CiAqLwpQSVhJLkNhbnZhc0dyYXBoaWNzLnJlbmRlckdyYXBoaWNzID0gZnVuY3Rpb24oZ3JhcGhpY3MsIGNvbnRleHQpCnsKICAgIHZhciB3b3JsZEFscGhhID0gZ3JhcGhpY3Mud29ybGRBbHBoYTsKICAgIHZhciBjb2xvciA9ICcnOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZ3JhcGhpY3MuZ3JhcGhpY3NEYXRhLmxlbmd0aDsgaSsrKQogICAgewogICAgICAgIHZhciBkYXRhID0gZ3JhcGhpY3MuZ3JhcGhpY3NEYXRhW2ldOwogICAgICAgIHZhciBwb2ludHMgPSBkYXRhLnBvaW50czsKCiAgICAgICAgY29udGV4dC5zdHJva2VTdHlsZSA9IGNvbG9yID0gJyMnICsgKCcwMDAwMCcgKyAoIGRhdGEubGluZUNvbG9yIHwgMCkudG9TdHJpbmcoMTYpKS5zdWJzdHIoLTYpOwoKICAgICAgICBjb250ZXh0LmxpbmVXaWR0aCA9IGRhdGEubGluZVdpZHRoOwoKICAgICAgICBpZihkYXRhLnR5cGUgPT09IFBJWEkuR3JhcGhpY3MuUE9MWSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRleHQuYmVnaW5QYXRoKCk7CgogICAgICAgICAgICBjb250ZXh0Lm1vdmVUbyhwb2ludHNbMF0sIHBvaW50c1sxXSk7CgogICAgICAgICAgICBmb3IgKHZhciBqPTE7IGogPCBwb2ludHMubGVuZ3RoLzI7IGorKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29udGV4dC5saW5lVG8ocG9pbnRzW2ogKiAyXSwgcG9pbnRzW2ogKiAyICsgMV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiB0aGUgZmlyc3QgYW5kIGxhc3QgcG9pbnQgYXJlIHRoZSBzYW1lIGNsb3NlIHRoZSBwYXRoIC0gbXVjaCBuZWF0ZXIgOikKICAgICAgICAgICAgaWYocG9pbnRzWzBdID09PSBwb2ludHNbcG9pbnRzLmxlbmd0aC0yXSAmJiBwb2ludHNbMV0gPT09IHBvaW50c1twb2ludHMubGVuZ3RoLTFdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb250ZXh0LmNsb3NlUGF0aCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihkYXRhLmZpbGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkYXRhLmZpbGxBbHBoYSAqIHdvcmxkQWxwaGE7CiAgICAgICAgICAgICAgICBjb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yID0gJyMnICsgKCcwMDAwMCcgKyAoIGRhdGEuZmlsbENvbG9yIHwgMCkudG9TdHJpbmcoMTYpKS5zdWJzdHIoLTYpOwogICAgICAgICAgICAgICAgY29udGV4dC5maWxsKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZGF0YS5saW5lV2lkdGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkYXRhLmxpbmVBbHBoYSAqIHdvcmxkQWxwaGE7CiAgICAgICAgICAgICAgICBjb250ZXh0LnN0cm9rZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoZGF0YS50eXBlID09PSBQSVhJLkdyYXBoaWNzLlJFQ1QpCiAgICAgICAgewoKICAgICAgICAgICAgaWYoZGF0YS5maWxsQ29sb3IgfHwgZGF0YS5maWxsQ29sb3IgPT09IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkYXRhLmZpbGxBbHBoYSAqIHdvcmxkQWxwaGE7CiAgICAgICAgICAgICAgICBjb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yID0gJyMnICsgKCcwMDAwMCcgKyAoIGRhdGEuZmlsbENvbG9yIHwgMCkudG9TdHJpbmcoMTYpKS5zdWJzdHIoLTYpOwogICAgICAgICAgICAgICAgY29udGV4dC5maWxsUmVjdChwb2ludHNbMF0sIHBvaW50c1sxXSwgcG9pbnRzWzJdLCBwb2ludHNbM10pOwoKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihkYXRhLmxpbmVXaWR0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29udGV4dC5nbG9iYWxBbHBoYSA9IGRhdGEubGluZUFscGhhICogd29ybGRBbHBoYTsKICAgICAgICAgICAgICAgIGNvbnRleHQuc3Ryb2tlUmVjdChwb2ludHNbMF0sIHBvaW50c1sxXSwgcG9pbnRzWzJdLCBwb2ludHNbM10pOwogICAgICAgICAgICB9CgogICAgICAgIH0KICAgICAgICBlbHNlIGlmKGRhdGEudHlwZSA9PT0gUElYSS5HcmFwaGljcy5DSVJDKQogICAgICAgIHsKICAgICAgICAgICAgLy8gVE9ETyAtIG5lZWQgdG8gYmUgVW5kZWZpbmVkIQogICAgICAgICAgICBjb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjb250ZXh0LmFyYyhwb2ludHNbMF0sIHBvaW50c1sxXSwgcG9pbnRzWzJdLDAsMipNYXRoLlBJKTsKICAgICAgICAgICAgY29udGV4dC5jbG9zZVBhdGgoKTsKCiAgICAgICAgICAgIGlmKGRhdGEuZmlsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29udGV4dC5nbG9iYWxBbHBoYSA9IGRhdGEuZmlsbEFscGhhICogd29ybGRBbHBoYTsKICAgICAgICAgICAgICAgIGNvbnRleHQuZmlsbFN0eWxlID0gY29sb3IgPSAnIycgKyAoJzAwMDAwJyArICggZGF0YS5maWxsQ29sb3IgfCAwKS50b1N0cmluZygxNikpLnN1YnN0cigtNik7CiAgICAgICAgICAgICAgICBjb250ZXh0LmZpbGwoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihkYXRhLmxpbmVXaWR0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29udGV4dC5nbG9iYWxBbHBoYSA9IGRhdGEubGluZUFscGhhICogd29ybGRBbHBoYTsKICAgICAgICAgICAgICAgIGNvbnRleHQuc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZihkYXRhLnR5cGUgPT09IFBJWEkuR3JhcGhpY3MuRUxJUCkKICAgICAgICB7CgogICAgICAgICAgICAvLyBlbGxpcHNlIGNvZGUgdGFrZW4gZnJvbTogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8yMTcyNzk4L2hvdy10by1kcmF3LWFuLW92YWwtaW4taHRtbDUtY2FudmFzCgogICAgICAgICAgICB2YXIgZWxsaXBzZURhdGEgPSAgZGF0YS5wb2ludHM7CgogICAgICAgICAgICB2YXIgdyA9IGVsbGlwc2VEYXRhWzJdICogMjsKICAgICAgICAgICAgdmFyIGggPSBlbGxpcHNlRGF0YVszXSAqIDI7CgogICAgICAgICAgICB2YXIgeCA9IGVsbGlwc2VEYXRhWzBdIC0gdy8yOwogICAgICAgICAgICB2YXIgeSA9IGVsbGlwc2VEYXRhWzFdIC0gaC8yOwoKICAgICAgICAgICAgY29udGV4dC5iZWdpblBhdGgoKTsKCiAgICAgICAgICAgIHZhciBrYXBwYSA9IDAuNTUyMjg0OCwKICAgICAgICAgICAgICAgIG94ID0gKHcgLyAyKSAqIGthcHBhLCAvLyBjb250cm9sIHBvaW50IG9mZnNldCBob3Jpem9udGFsCiAgICAgICAgICAgICAgICBveSA9IChoIC8gMikgKiBrYXBwYSwgLy8gY29udHJvbCBwb2ludCBvZmZzZXQgdmVydGljYWwKICAgICAgICAgICAgICAgIHhlID0geCArIHcsICAgICAgICAgICAvLyB4LWVuZAogICAgICAgICAgICAgICAgeWUgPSB5ICsgaCwgICAgICAgICAgIC8vIHktZW5kCiAgICAgICAgICAgICAgICB4bSA9IHggKyB3IC8gMiwgICAgICAgLy8geC1taWRkbGUKICAgICAgICAgICAgICAgIHltID0geSArIGggLyAyOyAgICAgICAvLyB5LW1pZGRsZQoKICAgICAgICAgICAgY29udGV4dC5tb3ZlVG8oeCwgeW0pOwogICAgICAgICAgICBjb250ZXh0LmJlemllckN1cnZlVG8oeCwgeW0gLSBveSwgeG0gLSBveCwgeSwgeG0sIHkpOwogICAgICAgICAgICBjb250ZXh0LmJlemllckN1cnZlVG8oeG0gKyBveCwgeSwgeGUsIHltIC0gb3ksIHhlLCB5bSk7CiAgICAgICAgICAgIGNvbnRleHQuYmV6aWVyQ3VydmVUbyh4ZSwgeW0gKyBveSwgeG0gKyBveCwgeWUsIHhtLCB5ZSk7CiAgICAgICAgICAgIGNvbnRleHQuYmV6aWVyQ3VydmVUbyh4bSAtIG94LCB5ZSwgeCwgeW0gKyBveSwgeCwgeW0pOwoKICAgICAgICAgICAgY29udGV4dC5jbG9zZVBhdGgoKTsKCiAgICAgICAgICAgIGlmKGRhdGEuZmlsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29udGV4dC5nbG9iYWxBbHBoYSA9IGRhdGEuZmlsbEFscGhhICogd29ybGRBbHBoYTsKICAgICAgICAgICAgICAgIGNvbnRleHQuZmlsbFN0eWxlID0gY29sb3IgPSAnIycgKyAoJzAwMDAwJyArICggZGF0YS5maWxsQ29sb3IgfCAwKS50b1N0cmluZygxNikpLnN1YnN0cigtNik7CiAgICAgICAgICAgICAgICBjb250ZXh0LmZpbGwoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihkYXRhLmxpbmVXaWR0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29udGV4dC5nbG9iYWxBbHBoYSA9IGRhdGEubGluZUFscGhhICogd29ybGRBbHBoYTsKICAgICAgICAgICAgICAgIGNvbnRleHQuc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn07CgovKgogKiBSZW5kZXJzIGEgZ3JhcGhpY3MgbWFzawogKgogKiBAc3RhdGljCiAqIEBwcml2YXRlCiAqIEBtZXRob2QgcmVuZGVyR3JhcGhpY3NNYXNrCiAqIEBwYXJhbSBncmFwaGljcyB7R3JhcGhpY3N9CiAqIEBwYXJhbSBjb250ZXh0IHtDb250ZXh0MkR9CiAqLwpQSVhJLkNhbnZhc0dyYXBoaWNzLnJlbmRlckdyYXBoaWNzTWFzayA9IGZ1bmN0aW9uKGdyYXBoaWNzLCBjb250ZXh0KQp7CiAgICB2YXIgbGVuID0gZ3JhcGhpY3MuZ3JhcGhpY3NEYXRhLmxlbmd0aDsKCiAgICBpZihsZW4gPT09IDApIHJldHVybjsKCiAgICBpZihsZW4gPiAxKQogICAgewogICAgICAgIGxlbiA9IDE7CiAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCdQaXhpLmpzIHdhcm5pbmc6IG1hc2tzIGluIGNhbnZhcyBjYW4gb25seSBtYXNrIHVzaW5nIHRoZSBmaXJzdCBwYXRoIGluIHRoZSBncmFwaGljcyBvYmplY3QnKTsKICAgIH0KCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IDE7IGkrKykKICAgIHsKICAgICAgICB2YXIgZGF0YSA9IGdyYXBoaWNzLmdyYXBoaWNzRGF0YVtpXTsKICAgICAgICB2YXIgcG9pbnRzID0gZGF0YS5wb2ludHM7CgogICAgICAgIGlmKGRhdGEudHlwZSA9PT0gUElYSS5HcmFwaGljcy5QT0xZKQogICAgICAgIHsKICAgICAgICAgICAgY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY29udGV4dC5tb3ZlVG8ocG9pbnRzWzBdLCBwb2ludHNbMV0pOwoKICAgICAgICAgICAgZm9yICh2YXIgaj0xOyBqIDwgcG9pbnRzLmxlbmd0aC8yOyBqKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQubGluZVRvKHBvaW50c1tqICogMl0sIHBvaW50c1tqICogMiArIDFdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgdGhlIGZpcnN0IGFuZCBsYXN0IHBvaW50IGFyZSB0aGUgc2FtZSBjbG9zZSB0aGUgcGF0aCAtIG11Y2ggbmVhdGVyIDopCiAgICAgICAgICAgIGlmKHBvaW50c1swXSA9PT0gcG9pbnRzW3BvaW50cy5sZW5ndGgtMl0gJiYgcG9pbnRzWzFdID09PSBwb2ludHNbcG9pbnRzLmxlbmd0aC0xXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgfQoKICAgICAgICB9CiAgICAgICAgZWxzZSBpZihkYXRhLnR5cGUgPT09IFBJWEkuR3JhcGhpY3MuUkVDVCkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGNvbnRleHQucmVjdChwb2ludHNbMF0sIHBvaW50c1sxXSwgcG9pbnRzWzJdLCBwb2ludHNbM10pOwogICAgICAgICAgICBjb250ZXh0LmNsb3NlUGF0aCgpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmKGRhdGEudHlwZSA9PT0gUElYSS5HcmFwaGljcy5DSVJDKQogICAgICAgIHsKICAgICAgICAgICAgLy8gVE9ETyAtIG5lZWQgdG8gYmUgVW5kZWZpbmVkIQogICAgICAgICAgICBjb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjb250ZXh0LmFyYyhwb2ludHNbMF0sIHBvaW50c1sxXSwgcG9pbnRzWzJdLDAsMipNYXRoLlBJKTsKICAgICAgICAgICAgY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZihkYXRhLnR5cGUgPT09IFBJWEkuR3JhcGhpY3MuRUxJUCkKICAgICAgICB7CgogICAgICAgICAgICAvLyBlbGxpcHNlIGNvZGUgdGFrZW4gZnJvbTogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8yMTcyNzk4L2hvdy10by1kcmF3LWFuLW92YWwtaW4taHRtbDUtY2FudmFzCiAgICAgICAgICAgIHZhciBlbGxpcHNlRGF0YSA9ICBkYXRhLnBvaW50czsKCiAgICAgICAgICAgIHZhciB3ID0gZWxsaXBzZURhdGFbMl0gKiAyOwogICAgICAgICAgICB2YXIgaCA9IGVsbGlwc2VEYXRhWzNdICogMjsKCiAgICAgICAgICAgIHZhciB4ID0gZWxsaXBzZURhdGFbMF0gLSB3LzI7CiAgICAgICAgICAgIHZhciB5ID0gZWxsaXBzZURhdGFbMV0gLSBoLzI7CgogICAgICAgICAgICBjb250ZXh0LmJlZ2luUGF0aCgpOwoKICAgICAgICAgICAgdmFyIGthcHBhID0gMC41NTIyODQ4LAogICAgICAgICAgICAgICAgb3ggPSAodyAvIDIpICoga2FwcGEsIC8vIGNvbnRyb2wgcG9pbnQgb2Zmc2V0IGhvcml6b250YWwKICAgICAgICAgICAgICAgIG95ID0gKGggLyAyKSAqIGthcHBhLCAvLyBjb250cm9sIHBvaW50IG9mZnNldCB2ZXJ0aWNhbAogICAgICAgICAgICAgICAgeGUgPSB4ICsgdywgICAgICAgICAgIC8vIHgtZW5kCiAgICAgICAgICAgICAgICB5ZSA9IHkgKyBoLCAgICAgICAgICAgLy8geS1lbmQKICAgICAgICAgICAgICAgIHhtID0geCArIHcgLyAyLCAgICAgICAvLyB4LW1pZGRsZQogICAgICAgICAgICAgICAgeW0gPSB5ICsgaCAvIDI7ICAgICAgIC8vIHktbWlkZGxlCgogICAgICAgICAgICBjb250ZXh0Lm1vdmVUbyh4LCB5bSk7CiAgICAgICAgICAgIGNvbnRleHQuYmV6aWVyQ3VydmVUbyh4LCB5bSAtIG95LCB4bSAtIG94LCB5LCB4bSwgeSk7CiAgICAgICAgICAgIGNvbnRleHQuYmV6aWVyQ3VydmVUbyh4bSArIG94LCB5LCB4ZSwgeW0gLSBveSwgeGUsIHltKTsKICAgICAgICAgICAgY29udGV4dC5iZXppZXJDdXJ2ZVRvKHhlLCB5bSArIG95LCB4bSArIG94LCB5ZSwgeG0sIHllKTsKICAgICAgICAgICAgY29udGV4dC5iZXppZXJDdXJ2ZVRvKHhtIC0gb3gsIHllLCB4LCB5bSArIG95LCB4LCB5bSk7CiAgICAgICAgICAgIGNvbnRleHQuY2xvc2VQYXRoKCk7CiAgICAgICAgfQogICAgfQp9OwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiB0aGUgQ2FudmFzUmVuZGVyZXIgZHJhd3MgdGhlIHN0YWdlIGFuZCBhbGwgaXRzIGNvbnRlbnQgb250byBhIDJkIGNhbnZhcy4gVGhpcyByZW5kZXJlciBzaG91bGQgYmUgdXNlZCBmb3IgYnJvd3NlcnMgdGhhdCBkbyBub3Qgc3VwcG9ydCB3ZWJHTC4KICogRG9udCBmb3JnZXQgdG8gYWRkIHRoZSB2aWV3IHRvIHlvdXIgRE9NIG9yIHlvdSB3aWxsIG5vdCBzZWUgYW55dGhpbmcgOikKICoKICogQGNsYXNzIENhbnZhc1JlbmRlcmVyCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gd2lkdGg9MCB7TnVtYmVyfSB0aGUgd2lkdGggb2YgdGhlIGNhbnZhcyB2aWV3CiAqIEBwYXJhbSBoZWlnaHQ9MCB7TnVtYmVyfSB0aGUgaGVpZ2h0IG9mIHRoZSBjYW52YXMgdmlldwogKiBAcGFyYW0gdmlldyB7Q2FudmFzfSB0aGUgY2FudmFzIHRvIHVzZSBhcyBhIHZpZXcsIG9wdGlvbmFsCiAqIEBwYXJhbSB0cmFuc3BhcmVudD1mYWxzZSB7Qm9vbGVhbn0gdGhlIHRyYW5zcGFyZW5jeSBvZiB0aGUgcmVuZGVyIHZpZXcsIGRlZmF1bHQgZmFsc2UKICovClBJWEkuQ2FudmFzUmVuZGVyZXIgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0LCB2aWV3LCB0cmFuc3BhcmVudCkKewogICAgdGhpcy50cmFuc3BhcmVudCA9IHRyYW5zcGFyZW50OwoKICAgIC8qKgogICAgICogVGhlIHdpZHRoIG9mIHRoZSBjYW52YXMgdmlldwogICAgICoKICAgICAqIEBwcm9wZXJ0eSB3aWR0aAogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKiBAZGVmYXVsdCA4MDAKICAgICAqLwogICAgdGhpcy53aWR0aCA9IHdpZHRoIHx8IDgwMDsKCiAgICAvKioKICAgICAqIFRoZSBoZWlnaHQgb2YgdGhlIGNhbnZhcyB2aWV3CiAgICAgKgogICAgICogQHByb3BlcnR5IGhlaWdodAogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKiBAZGVmYXVsdCA2MDAKICAgICAqLwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQgfHwgNjAwOwoKICAgIC8qKgogICAgICogVGhlIGNhbnZhcyBlbGVtZW50IHRoYXQgdGhlIGV2ZXJ5dGhpbmcgaXMgZHJhd24gdG8KICAgICAqCiAgICAgKiBAcHJvcGVydHkgdmlldwogICAgICogQHR5cGUgQ2FudmFzCiAgICAgKi8KICAgIHRoaXMudmlldyA9IHZpZXcgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2NhbnZhcycgKTsKCiAgICAvKioKICAgICAqIFRoZSBjYW52YXMgY29udGV4dCB0aGF0IHRoZSBldmVyeXRoaW5nIGlzIGRyYXduIHRvCiAgICAgKiBAcHJvcGVydHkgY29udGV4dAogICAgICogQHR5cGUgQ2FudmFzIDJkIENvbnRleHQKICAgICAqLwogICAgdGhpcy5jb250ZXh0ID0gdGhpcy52aWV3LmdldENvbnRleHQoICcyZCcgKTsKCiAgICAvL3NvbWUgZmlsdGVyIHZhcmlhYmxlcwogICAgdGhpcy5zbW9vdGhQcm9wZXJ0eSA9IG51bGw7CgogICAgaWYoJ2ltYWdlU21vb3RoaW5nRW5hYmxlZCcgaW4gdGhpcy5jb250ZXh0KQogICAgICAgIHRoaXMuc21vb3RoUHJvcGVydHkgPSAnaW1hZ2VTbW9vdGhpbmdFbmFibGVkJzsKICAgIGVsc2UgaWYoJ3dlYmtpdEltYWdlU21vb3RoaW5nRW5hYmxlZCcgaW4gdGhpcy5jb250ZXh0KQogICAgICAgIHRoaXMuc21vb3RoUHJvcGVydHkgPSAnd2Via2l0SW1hZ2VTbW9vdGhpbmdFbmFibGVkJzsKICAgIGVsc2UgaWYoJ21vekltYWdlU21vb3RoaW5nRW5hYmxlZCcgaW4gdGhpcy5jb250ZXh0KQogICAgICAgIHRoaXMuc21vb3RoUHJvcGVydHkgPSAnbW96SW1hZ2VTbW9vdGhpbmdFbmFibGVkJzsKICAgIGVsc2UgaWYoJ29JbWFnZVNtb290aGluZ0VuYWJsZWQnIGluIHRoaXMuY29udGV4dCkKICAgICAgICB0aGlzLnNtb290aFByb3BlcnR5ID0gJ29JbWFnZVNtb290aGluZ0VuYWJsZWQnOwoKICAgIHRoaXMuc2NhbGVNb2RlID0gbnVsbDsKCiAgICB0aGlzLnJlZnJlc2ggPSB0cnVlOwogICAgLy8gaGFjayB0byBlbmFibGUgc29tZSBoYXJkd2FyZSBhY2NlbGVyYXRpb24hCiAgICAvL3RoaXMudmlldy5zdHlsZVsidHJhbnNmb3JtIl0gPSAidHJhbnNsYXRleigwKSI7CgogICAgdGhpcy52aWV3LndpZHRoID0gdGhpcy53aWR0aDsKICAgIHRoaXMudmlldy5oZWlnaHQgPSB0aGlzLmhlaWdodDsKICAgIHRoaXMuY291bnQgPSAwOwp9OwoKLy8gY29uc3RydWN0b3IKUElYSS5DYW52YXNSZW5kZXJlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLkNhbnZhc1JlbmRlcmVyOwoKLyoqCiAqIFJlbmRlcnMgdGhlIHN0YWdlIHRvIGl0cyBjYW52YXMgdmlldwogKgogKiBAbWV0aG9kIHJlbmRlcgogKiBAcGFyYW0gc3RhZ2Uge1N0YWdlfSB0aGUgU3RhZ2UgZWxlbWVudCB0byBiZSByZW5kZXJlZAogKi8KUElYSS5DYW52YXNSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oc3RhZ2UpCnsKICAgIC8vc3RhZ2UuX19jaGlsZHJlbkFkZGVkID0gW107CiAgICAvL3N0YWdlLl9fY2hpbGRyZW5SZW1vdmVkID0gW107CgogICAgLy8gdXBkYXRlIHRleHR1cmVzIGlmIG5lZWQgYmUKICAgIFBJWEkudGV4dHVyZXNUb1VwZGF0ZSA9IFtdOwogICAgUElYSS50ZXh0dXJlc1RvRGVzdHJveSA9IFtdOwoKICAgIFBJWEkudmlzaWJsZUNvdW50Kys7CiAgICBzdGFnZS51cGRhdGVUcmFuc2Zvcm0oKTsKCiAgICAvLyB1cGRhdGUgdGhlIGJhY2tncm91bmQgY29sb3IKICAgIGlmKHRoaXMudmlldy5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgIT09IHN0YWdlLmJhY2tncm91bmRDb2xvclN0cmluZyAmJiAhdGhpcy50cmFuc3BhcmVudCkKICAgICAgICB0aGlzLnZpZXcuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gc3RhZ2UuYmFja2dyb3VuZENvbG9yU3RyaW5nOwoKICAgIHRoaXMuY29udGV4dC5zZXRUcmFuc2Zvcm0oMSwwLDAsMSwwLDApOwogICAgdGhpcy5jb250ZXh0LmNsZWFyUmVjdCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CiAgICB0aGlzLnJlbmRlckRpc3BsYXlPYmplY3Qoc3RhZ2UpOwogICAgLy9hcwoKICAgIC8vIHJ1biBpbnRlcmFjdGlvbiEKICAgIGlmKHN0YWdlLmludGVyYWN0aXZlKQogICAgewogICAgICAgIC8vbmVlZCB0byBhZGQgc29tZSBldmVudHMhCiAgICAgICAgaWYoIXN0YWdlLl9pbnRlcmFjdGl2ZUV2ZW50c0FkZGVkKQogICAgICAgIHsKICAgICAgICAgICAgc3RhZ2UuX2ludGVyYWN0aXZlRXZlbnRzQWRkZWQgPSB0cnVlOwogICAgICAgICAgICBzdGFnZS5pbnRlcmFjdGlvbk1hbmFnZXIuc2V0VGFyZ2V0KHRoaXMpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyByZW1vdmUgZnJhbWUgdXBkYXRlcy4uCiAgICBpZihQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzLmxlbmd0aCA+IDApCiAgICB7CiAgICAgICAgUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcyA9IFtdOwogICAgfQp9OwoKLyoqCiAqIHJlc2l6ZXMgdGhlIGNhbnZhcyB2aWV3IHRvIHRoZSBzcGVjaWZpZWQgd2lkdGggYW5kIGhlaWdodAogKgogKiBAbWV0aG9kIHJlc2l6ZQogKiBAcGFyYW0gd2lkdGgge051bWJlcn0gdGhlIG5ldyB3aWR0aCBvZiB0aGUgY2FudmFzIHZpZXcKICogQHBhcmFtIGhlaWdodCB7TnVtYmVyfSB0aGUgbmV3IGhlaWdodCBvZiB0aGUgY2FudmFzIHZpZXcKICovClBJWEkuQ2FudmFzUmVuZGVyZXIucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCnsKICAgIHRoaXMud2lkdGggPSB3aWR0aDsKICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgIHRoaXMudmlldy53aWR0aCA9IHdpZHRoOwogICAgdGhpcy52aWV3LmhlaWdodCA9IGhlaWdodDsKfTsKCi8qKgogKiBSZW5kZXJzIGEgZGlzcGxheSBvYmplY3QKICoKICogQG1ldGhvZCByZW5kZXJEaXNwbGF5T2JqZWN0CiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fSBUaGUgZGlzcGxheU9iamVjdCB0byByZW5kZXIKICogQHByaXZhdGUKICovClBJWEkuQ2FudmFzUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlckRpc3BsYXlPYmplY3QgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0KQp7CiAgICAvLyBubyBsb2dlciByZWN1cnJzaXZlIQogICAgdmFyIHRyYW5zZm9ybTsKICAgIHZhciBjb250ZXh0ID0gdGhpcy5jb250ZXh0OwoKICAgIGNvbnRleHQuZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ3NvdXJjZS1vdmVyJzsKCiAgICAvLyBvbmUgdGhlIGRpc3BsYXkgb2JqZWN0IGhpdHMgdGhpcy4gd2UgY2FuIGJyZWFrIHRoZSBsb29wCiAgICB2YXIgdGVzdE9iamVjdCA9IGRpc3BsYXlPYmplY3QubGFzdC5faU5leHQ7CiAgICBkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5maXJzdDsKCiAgICBkbwogICAgewogICAgICAgIHRyYW5zZm9ybSA9IGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm07CgogICAgICAgIGlmKCFkaXNwbGF5T2JqZWN0LnZpc2libGUpCiAgICAgICAgewogICAgICAgICAgICBkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5sYXN0Ll9pTmV4dDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBpZighZGlzcGxheU9iamVjdC5yZW5kZXJhYmxlKQogICAgICAgIHsKICAgICAgICAgICAgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuX2lOZXh0OwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKICAgICAgICB7CgogICAgICAgICAgICB2YXIgZnJhbWUgPSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWU7CgogICAgICAgICAgICAvL2lnbm9yZSBudWxsIHNvdXJjZXMKICAgICAgICAgICAgaWYoZnJhbWUgJiYgZnJhbWUud2lkdGggJiYgZnJhbWUuaGVpZ2h0ICYmIGRpc3BsYXlPYmplY3QudGV4dHVyZS5iYXNlVGV4dHVyZS5zb3VyY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGE7CgogICAgICAgICAgICAgICAgY29udGV4dC5zZXRUcmFuc2Zvcm0odHJhbnNmb3JtWzBdLCB0cmFuc2Zvcm1bM10sIHRyYW5zZm9ybVsxXSwgdHJhbnNmb3JtWzRdLCB0cmFuc2Zvcm1bMl0sIHRyYW5zZm9ybVs1XSk7CgogICAgICAgICAgICAgICAgLy9pZiBzbW9vdGhpbmdFbmFibGVkIGlzIHN1cHBvcnRlZCBhbmQgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIHNtb290aGluZyBwcm9wZXJ0eSBmb3IgdGhpcyB0ZXh0dXJlCiAgICAgICAgICAgICAgICBpZih0aGlzLnNtb290aFByb3BlcnR5ICYmIHRoaXMuc2NhbGVNb2RlICE9PSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuYmFzZVRleHR1cmUuc2NhbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY2FsZU1vZGUgPSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuYmFzZVRleHR1cmUuc2NhbGVNb2RlOwogICAgICAgICAgICAgICAgICAgIGNvbnRleHRbdGhpcy5zbW9vdGhQcm9wZXJ0eV0gPSAodGhpcy5zY2FsZU1vZGUgPT09IFBJWEkuQmFzZVRleHR1cmUuU0NBTEVfTU9ERS5MSU5FQVIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnRleHQuZHJhd0ltYWdlKGRpc3BsYXlPYmplY3QudGV4dHVyZS5iYXNlVGV4dHVyZS5zb3VyY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUueCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFtZS55LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lLndpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lLmhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZGlzcGxheU9iamVjdC5hbmNob3IueCkgKiAtZnJhbWUud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGRpc3BsYXlPYmplY3QuYW5jaG9yLnkpICogLWZyYW1lLmhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFtZS53aWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFtZS5oZWlnaHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuU3RyaXApCiAgICAgICAgewogICAgICAgICAgICBjb250ZXh0LnNldFRyYW5zZm9ybSh0cmFuc2Zvcm1bMF0sIHRyYW5zZm9ybVszXSwgdHJhbnNmb3JtWzFdLCB0cmFuc2Zvcm1bNF0sIHRyYW5zZm9ybVsyXSwgdHJhbnNmb3JtWzVdKTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJTdHJpcChkaXNwbGF5T2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5UaWxpbmdTcHJpdGUpCiAgICAgICAgewogICAgICAgICAgICBjb250ZXh0LnNldFRyYW5zZm9ybSh0cmFuc2Zvcm1bMF0sIHRyYW5zZm9ybVszXSwgdHJhbnNmb3JtWzFdLCB0cmFuc2Zvcm1bNF0sIHRyYW5zZm9ybVsyXSwgdHJhbnNmb3JtWzVdKTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJUaWxpbmdTcHJpdGUoZGlzcGxheU9iamVjdCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuQ3VzdG9tUmVuZGVyYWJsZSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRleHQuc2V0VHJhbnNmb3JtKHRyYW5zZm9ybVswXSwgdHJhbnNmb3JtWzNdLCB0cmFuc2Zvcm1bMV0sIHRyYW5zZm9ybVs0XSwgdHJhbnNmb3JtWzJdLCB0cmFuc2Zvcm1bNV0pOwogICAgICAgICAgICBkaXNwbGF5T2JqZWN0LnJlbmRlckNhbnZhcyh0aGlzKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5HcmFwaGljcykKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRleHQuc2V0VHJhbnNmb3JtKHRyYW5zZm9ybVswXSwgdHJhbnNmb3JtWzNdLCB0cmFuc2Zvcm1bMV0sIHRyYW5zZm9ybVs0XSwgdHJhbnNmb3JtWzJdLCB0cmFuc2Zvcm1bNV0pOwogICAgICAgICAgICBQSVhJLkNhbnZhc0dyYXBoaWNzLnJlbmRlckdyYXBoaWNzKGRpc3BsYXlPYmplY3QsIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLkZpbHRlckJsb2NrKQogICAgICAgIHsKICAgICAgICAgICAgaWYoZGlzcGxheU9iamVjdC5kYXRhIGluc3RhbmNlb2YgUElYSS5HcmFwaGljcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIG1hc2sgPSBkaXNwbGF5T2JqZWN0LmRhdGE7CgogICAgICAgICAgICAgICAgaWYoZGlzcGxheU9iamVjdC5vcGVuKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQuc2F2ZSgpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgY2FjaGVBbHBoYSA9IG1hc2suYWxwaGE7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hc2tUcmFuc2Zvcm0gPSBtYXNrLndvcmxkVHJhbnNmb3JtOwoKICAgICAgICAgICAgICAgICAgICBjb250ZXh0LnNldFRyYW5zZm9ybShtYXNrVHJhbnNmb3JtWzBdLCBtYXNrVHJhbnNmb3JtWzNdLCBtYXNrVHJhbnNmb3JtWzFdLCBtYXNrVHJhbnNmb3JtWzRdLCBtYXNrVHJhbnNmb3JtWzJdLCBtYXNrVHJhbnNmb3JtWzVdKTsKCiAgICAgICAgICAgICAgICAgICAgbWFzay53b3JsZEFscGhhID0gMC41OwoKICAgICAgICAgICAgICAgICAgICBjb250ZXh0LndvcmxkQWxwaGEgPSAwOwoKICAgICAgICAgICAgICAgICAgICBQSVhJLkNhbnZhc0dyYXBoaWNzLnJlbmRlckdyYXBoaWNzTWFzayhtYXNrLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmNsaXAoKTsKCiAgICAgICAgICAgICAgICAgICAgbWFzay53b3JsZEFscGhhID0gY2FjaGVBbHBoYTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjb250ZXh0LnJlc3RvcmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvL2NvdW50KysKICAgICAgICBkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5faU5leHQ7CiAgICB9CiAgICB3aGlsZShkaXNwbGF5T2JqZWN0ICE9PSB0ZXN0T2JqZWN0KTsKfTsKCi8qKgogKiBSZW5kZXJzIGEgZmxhdCBzdHJpcAogKgogKiBAbWV0aG9kIHJlbmRlclN0cmlwRmxhdAogKiBAcGFyYW0gc3RyaXAge1N0cmlwfSBUaGUgU3RyaXAgdG8gcmVuZGVyCiAqIEBwcml2YXRlCiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJTdHJpcEZsYXQgPSBmdW5jdGlvbihzdHJpcCkKewogICAgdmFyIGNvbnRleHQgPSB0aGlzLmNvbnRleHQ7CiAgICB2YXIgdmVydGljaWVzID0gc3RyaXAudmVydGljaWVzOwoKICAgIHZhciBsZW5ndGggPSB2ZXJ0aWNpZXMubGVuZ3RoLzI7CiAgICB0aGlzLmNvdW50Kys7CgogICAgY29udGV4dC5iZWdpblBhdGgoKTsKICAgIGZvciAodmFyIGk9MTsgaSA8IGxlbmd0aC0yOyBpKyspCiAgICB7CiAgICAgICAgLy8gZHJhdyBzb21lIHRyaWFuZ2xlcyEKICAgICAgICB2YXIgaW5kZXggPSBpKjI7CgogICAgICAgIHZhciB4MCA9IHZlcnRpY2llc1tpbmRleF0sICAgeDEgPSB2ZXJ0aWNpZXNbaW5kZXgrMl0sIHgyID0gdmVydGljaWVzW2luZGV4KzRdOwogICAgICAgIHZhciB5MCA9IHZlcnRpY2llc1tpbmRleCsxXSwgeTEgPSB2ZXJ0aWNpZXNbaW5kZXgrM10sIHkyID0gdmVydGljaWVzW2luZGV4KzVdOwoKICAgICAgICBjb250ZXh0Lm1vdmVUbyh4MCwgeTApOwogICAgICAgIGNvbnRleHQubGluZVRvKHgxLCB5MSk7CiAgICAgICAgY29udGV4dC5saW5lVG8oeDIsIHkyKTsKICAgIH0KCiAgICBjb250ZXh0LmZpbGxTdHlsZSA9ICcjRkYwMDAwJzsKICAgIGNvbnRleHQuZmlsbCgpOwogICAgY29udGV4dC5jbG9zZVBhdGgoKTsKfTsKCi8qKgogKiBSZW5kZXJzIGEgdGlsaW5nIHNwcml0ZQogKgogKiBAbWV0aG9kIHJlbmRlclRpbGluZ1Nwcml0ZQogKiBAcGFyYW0gc3ByaXRlIHtUaWxpbmdTcHJpdGV9IFRoZSB0aWxpbmdzcHJpdGUgdG8gcmVuZGVyCiAqIEBwcml2YXRlCiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJUaWxpbmdTcHJpdGUgPSBmdW5jdGlvbihzcHJpdGUpCnsKICAgIHZhciBjb250ZXh0ID0gdGhpcy5jb250ZXh0OwoKICAgIGNvbnRleHQuZ2xvYmFsQWxwaGEgPSBzcHJpdGUud29ybGRBbHBoYTsKCiAgICBpZighc3ByaXRlLl9fdGlsZVBhdHRlcm4pCiAgICAgICAgc3ByaXRlLl9fdGlsZVBhdHRlcm4gPSBjb250ZXh0LmNyZWF0ZVBhdHRlcm4oc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuc291cmNlLCAncmVwZWF0Jyk7CgogICAgY29udGV4dC5iZWdpblBhdGgoKTsKCiAgICB2YXIgdGlsZVBvc2l0aW9uID0gc3ByaXRlLnRpbGVQb3NpdGlvbjsKICAgIHZhciB0aWxlU2NhbGUgPSBzcHJpdGUudGlsZVNjYWxlOwoKICAgIC8vIG9mZnNldAogICAgY29udGV4dC5zY2FsZSh0aWxlU2NhbGUueCx0aWxlU2NhbGUueSk7CiAgICBjb250ZXh0LnRyYW5zbGF0ZSh0aWxlUG9zaXRpb24ueCwgdGlsZVBvc2l0aW9uLnkpOwoKICAgIGNvbnRleHQuZmlsbFN0eWxlID0gc3ByaXRlLl9fdGlsZVBhdHRlcm47CiAgICBjb250ZXh0LmZpbGxSZWN0KC10aWxlUG9zaXRpb24ueCwtdGlsZVBvc2l0aW9uLnksc3ByaXRlLndpZHRoIC8gdGlsZVNjYWxlLngsIHNwcml0ZS5oZWlnaHQgLyB0aWxlU2NhbGUueSk7CgogICAgY29udGV4dC5zY2FsZSgxL3RpbGVTY2FsZS54LCAxL3RpbGVTY2FsZS55KTsKICAgIGNvbnRleHQudHJhbnNsYXRlKC10aWxlUG9zaXRpb24ueCwgLXRpbGVQb3NpdGlvbi55KTsKCiAgICBjb250ZXh0LmNsb3NlUGF0aCgpOwp9OwoKLyoqCiAqIFJlbmRlcnMgYSBzdHJpcAogKgogKiBAbWV0aG9kIHJlbmRlclN0cmlwCiAqIEBwYXJhbSBzdHJpcCB7U3RyaXB9IFRoZSBTdHJpcCB0byByZW5kZXIKICogQHByaXZhdGUKICovClBJWEkuQ2FudmFzUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlclN0cmlwID0gZnVuY3Rpb24oc3RyaXApCnsKICAgIHZhciBjb250ZXh0ID0gdGhpcy5jb250ZXh0OwoKICAgIC8vIGRyYXcgdHJpYW5nbGVzISEKICAgIHZhciB2ZXJ0aWNpZXMgPSBzdHJpcC52ZXJ0aWNpZXM7CiAgICB2YXIgdXZzID0gc3RyaXAudXZzOwoKICAgIHZhciBsZW5ndGggPSB2ZXJ0aWNpZXMubGVuZ3RoLzI7CiAgICB0aGlzLmNvdW50Kys7CgogICAgZm9yICh2YXIgaSA9IDE7IGkgPCBsZW5ndGgtMjsgaSsrKQogICAgewogICAgICAgIC8vIGRyYXcgc29tZSB0cmlhbmdsZXMhCiAgICAgICAgdmFyIGluZGV4ID0gaSoyOwoKICAgICAgICB2YXIgeDAgPSB2ZXJ0aWNpZXNbaW5kZXhdLCAgIHgxID0gdmVydGljaWVzW2luZGV4KzJdLCB4MiA9IHZlcnRpY2llc1tpbmRleCs0XTsKICAgICAgICB2YXIgeTAgPSB2ZXJ0aWNpZXNbaW5kZXgrMV0sIHkxID0gdmVydGljaWVzW2luZGV4KzNdLCB5MiA9IHZlcnRpY2llc1tpbmRleCs1XTsKCiAgICAgICAgdmFyIHUwID0gdXZzW2luZGV4XSAqIHN0cmlwLnRleHR1cmUud2lkdGgsICAgdTEgPSB1dnNbaW5kZXgrMl0gKiBzdHJpcC50ZXh0dXJlLndpZHRoLCB1MiA9IHV2c1tpbmRleCs0XSogc3RyaXAudGV4dHVyZS53aWR0aDsKICAgICAgICB2YXIgdjAgPSB1dnNbaW5kZXgrMV0qIHN0cmlwLnRleHR1cmUuaGVpZ2h0LCB2MSA9IHV2c1tpbmRleCszXSAqIHN0cmlwLnRleHR1cmUuaGVpZ2h0LCB2MiA9IHV2c1tpbmRleCs1XSogc3RyaXAudGV4dHVyZS5oZWlnaHQ7CgogICAgICAgIGNvbnRleHQuc2F2ZSgpOwogICAgICAgIGNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgY29udGV4dC5tb3ZlVG8oeDAsIHkwKTsKICAgICAgICBjb250ZXh0LmxpbmVUbyh4MSwgeTEpOwogICAgICAgIGNvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICAgICAgY29udGV4dC5jbG9zZVBhdGgoKTsKCiAgICAgICAgY29udGV4dC5jbGlwKCk7CgogICAgICAgIC8vIENvbXB1dGUgbWF0cml4IHRyYW5zZm9ybQogICAgICAgIHZhciBkZWx0YSA9IHUwKnYxICsgdjAqdTIgKyB1MSp2MiAtIHYxKnUyIC0gdjAqdTEgLSB1MCp2MjsKICAgICAgICB2YXIgZGVsdGFBID0geDAqdjEgKyB2MCp4MiArIHgxKnYyIC0gdjEqeDIgLSB2MCp4MSAtIHgwKnYyOwogICAgICAgIHZhciBkZWx0YUIgPSB1MCp4MSArIHgwKnUyICsgdTEqeDIgLSB4MSp1MiAtIHgwKnUxIC0gdTAqeDI7CiAgICAgICAgdmFyIGRlbHRhQyA9IHUwKnYxKngyICsgdjAqeDEqdTIgKyB4MCp1MSp2MiAtIHgwKnYxKnUyIC0gdjAqdTEqeDIgLSB1MCp4MSp2MjsKICAgICAgICB2YXIgZGVsdGFEID0geTAqdjEgKyB2MCp5MiArIHkxKnYyIC0gdjEqeTIgLSB2MCp5MSAtIHkwKnYyOwogICAgICAgIHZhciBkZWx0YUUgPSB1MCp5MSArIHkwKnUyICsgdTEqeTIgLSB5MSp1MiAtIHkwKnUxIC0gdTAqeTI7CiAgICAgICAgdmFyIGRlbHRhRiA9IHUwKnYxKnkyICsgdjAqeTEqdTIgKyB5MCp1MSp2MiAtIHkwKnYxKnUyIC0gdjAqdTEqeTIgLSB1MCp5MSp2MjsKCiAgICAgICAgY29udGV4dC50cmFuc2Zvcm0oZGVsdGFBIC8gZGVsdGEsIGRlbHRhRCAvIGRlbHRhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGFCIC8gZGVsdGEsIGRlbHRhRSAvIGRlbHRhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGFDIC8gZGVsdGEsIGRlbHRhRiAvIGRlbHRhKTsKCiAgICAgICAgY29udGV4dC5kcmF3SW1hZ2Uoc3RyaXAudGV4dHVyZS5iYXNlVGV4dHVyZS5zb3VyY2UsIDAsIDApOwogICAgICAgIGNvbnRleHQucmVzdG9yZSgpOwogICAgfQp9OwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKiBAYXV0aG9yIFJpY2hhcmQgRGF2ZXkgaHR0cDovL3d3dy5waG90b25zdG9ybS5jb20gQHBob3RvbnN0b3JtCiAqLwoKLyoqCiogQGNsYXNzIFBJWEkuUGl4aVNoYWRlcgoqIEBjb25zdHJ1Y3RvcgoqLwpQSVhJLlBpeGlTaGFkZXIgPSBmdW5jdGlvbigpCnsKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FueX0gcHJvZ3JhbSAtIFRoZSBXZWJHTCBwcm9ncmFtLgogICAgKi8KICAgIHRoaXMucHJvZ3JhbSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGZyYWdtZW50U3JjIC0gVGhlIGZyYWdtZW50IHNoYWRlci4KICAgICovCiAgICB0aGlzLmZyYWdtZW50U3JjID0gWwogICAgICAgICdwcmVjaXNpb24gbG93cCBmbG9hdDsnLAogICAgICAgICd2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsnLAogICAgICAgICd2YXJ5aW5nIGZsb2F0IHZDb2xvcjsnLAogICAgICAgICd1bmlmb3JtIHNhbXBsZXIyRCB1U2FtcGxlcjsnLAogICAgICAgICd2b2lkIG1haW4odm9pZCkgeycsCiAgICAgICAgJyAgIGdsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1U2FtcGxlciwgdlRleHR1cmVDb29yZCkgKiB2Q29sb3I7JywKICAgICAgICAnfScKICAgIF07CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0ZXh0dXJlQ291bnQgLSBBIGxvY2FsIHRleHR1cmUgY291bnRlciBmb3IgbXVsdGktdGV4dHVyZSBzaGFkZXJzLgogICAgKi8KICAgIHRoaXMudGV4dHVyZUNvdW50ID0gMDsKfTsKCi8qKgoqIEBtZXRob2QgUElYSS5QaXhpU2hhZGVyI2luaXQKKi8KUElYSS5QaXhpU2hhZGVyLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgcHJvZ3JhbSA9IFBJWEkuY29tcGlsZVByb2dyYW0odGhpcy52ZXJ0ZXhTcmMgfHwgUElYSS5QaXhpU2hhZGVyLmRlZmF1bHRWZXJ0ZXhTcmMsIHRoaXMuZnJhZ21lbnRTcmMpOwoKICAgIHZhciBnbCA9IFBJWEkuZ2w7CgogICAgZ2wudXNlUHJvZ3JhbShwcm9ncmFtKTsKCiAgICAvLyBnZXQgYW5kIHN0b3JlIHRoZSB1bmlmb3JtcyBmb3IgdGhlIHNoYWRlcgogICAgdGhpcy51U2FtcGxlciA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAndVNhbXBsZXInKTsKICAgIHRoaXMucHJvamVjdGlvblZlY3RvciA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAncHJvamVjdGlvblZlY3RvcicpOwogICAgdGhpcy5vZmZzZXRWZWN0b3IgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ29mZnNldFZlY3RvcicpOwogICAgdGhpcy5kaW1lbnNpb25zID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICdkaW1lbnNpb25zJyk7CgogICAgLy8gZ2V0IGFuZCBzdG9yZSB0aGUgYXR0cmlidXRlcwogICAgdGhpcy5hVmVydGV4UG9zaXRpb24gPSBnbC5nZXRBdHRyaWJMb2NhdGlvbihwcm9ncmFtLCAnYVZlcnRleFBvc2l0aW9uJyk7CiAgICB0aGlzLmNvbG9yQXR0cmlidXRlID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgJ2FDb2xvcicpOwogICAgdGhpcy5hVGV4dHVyZUNvb3JkID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgJ2FUZXh0dXJlQ29vcmQnKTsKCiAgICAvLyBhZGQgdGhvc2UgY3VzdG9tIHNoYWRlcnMhCiAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy51bmlmb3JtcykKICAgIHsKICAgICAgICAvLyBnZXQgdGhlIHVuaWZvcm0gbG9jYXRpb25zLi4KICAgICAgICB0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sIGtleSk7CiAgICB9CgogICAgdGhpcy5pbml0VW5pZm9ybXMoKTsKCiAgICB0aGlzLnByb2dyYW0gPSBwcm9ncmFtOwp9OwoKLyoqCiogSW5pdGlhbGlzZXMgdGhlIHNoYWRlciB1bmlmb3JtIHZhbHVlcy4KKiBVbmlmb3JtcyBhcmUgc3BlY2lmaWVkIGluIHRoZSBHTFNMX0VTIFNwZWNpZmljYXRpb246IGh0dHA6Ly93d3cua2hyb25vcy5vcmcvcmVnaXN0cnkvd2ViZ2wvc3BlY3MvbGF0ZXN0LzEuMC8KKiBodHRwOi8vd3d3Lmtocm9ub3Mub3JnL3JlZ2lzdHJ5L2dsZXMvc3BlY3MvMi4wL0dMU0xfRVNfU3BlY2lmaWNhdGlvbl8xLjAuMTcucGRmCioKKiBAbWV0aG9kIFBJWEkuUGl4aVNoYWRlciNpbml0VW5pZm9ybXMKKi8KUElYSS5QaXhpU2hhZGVyLnByb3RvdHlwZS5pbml0VW5pZm9ybXMgPSBmdW5jdGlvbigpCnsKICAgIHRoaXMudGV4dHVyZUNvdW50ID0gMTsKCiAgICB2YXIgdW5pZm9ybTsKCiAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy51bmlmb3JtcykKICAgIHsKICAgICAgICB1bmlmb3JtID0gdGhpcy51bmlmb3Jtc1trZXldOwoKICAgICAgICB2YXIgdHlwZSA9IHVuaWZvcm0udHlwZTsKCiAgICAgICAgaWYgKHR5cGUgPT09ICdzYW1wbGVyMkQnKQogICAgICAgIHsKICAgICAgICAgICAgdW5pZm9ybS5faW5pdCA9IGZhbHNlOwoKICAgICAgICAgICAgaWYgKHVuaWZvcm0udmFsdWUgIT09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5pdFNhbXBsZXIyRCh1bmlmb3JtKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnbWF0MicgfHwgdHlwZSA9PT0gJ21hdDMnIHx8IHR5cGUgPT09ICdtYXQ0JykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBUaGVzZSByZXF1aXJlIHNwZWNpYWwgaGFuZGxpbmcKICAgICAgICAgICAgdW5pZm9ybS5nbE1hdHJpeCA9IHRydWU7CiAgICAgICAgICAgIHVuaWZvcm0uZ2xWYWx1ZUxlbmd0aCA9IDE7CgogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ21hdDInKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB1bmlmb3JtLmdsRnVuYyA9IFBJWEkuZ2wudW5pZm9ybU1hdHJpeDJmdjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnbWF0MycpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHVuaWZvcm0uZ2xGdW5jID0gUElYSS5nbC51bmlmb3JtTWF0cml4M2Z2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdtYXQ0JykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdW5pZm9ybS5nbEZ1bmMgPSBQSVhJLmdsLnVuaWZvcm1NYXRyaXg0ZnY7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIEdMIGZ1bmN0aW9uIHJlZmVyZW5jZQogICAgICAgICAgICB1bmlmb3JtLmdsRnVuYyA9IFBJWEkuZ2xbJ3VuaWZvcm0nICsgdHlwZV07CgogICAgICAgICAgICBpZiAodHlwZSA9PT0gJzJmJyB8fCB0eXBlID09PSAnMmknKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB1bmlmb3JtLmdsVmFsdWVMZW5ndGggPSAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICczZicgfHwgdHlwZSA9PT0gJzNpJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdW5pZm9ybS5nbFZhbHVlTGVuZ3RoID0gMzsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSAnNGYnIHx8IHR5cGUgPT09ICc0aScpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHVuaWZvcm0uZ2xWYWx1ZUxlbmd0aCA9IDQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB1bmlmb3JtLmdsVmFsdWVMZW5ndGggPSAxOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKfTsKCi8qKgoqIEluaXRpYWxpc2VzIGEgU2FtcGxlcjJEIHVuaWZvcm0gKHdoaWNoIG1heSBvbmx5IGJlIGF2YWlsYWJsZSBsYXRlciBvbiBhZnRlciBpbml0VW5pZm9ybXMgb25jZSB0aGUgdGV4dHVyZSBpcyBoYXMgbG9hZGVkKQoqCiogQG1ldGhvZCBQSVhJLlBpeGlTaGFkZXIjaW5pdFNhbXBsZXIyRAoqLwpQSVhJLlBpeGlTaGFkZXIucHJvdG90eXBlLmluaXRTYW1wbGVyMkQgPSBmdW5jdGlvbih1bmlmb3JtKQp7CiAgICBpZiAoIXVuaWZvcm0udmFsdWUgfHwgIXVuaWZvcm0udmFsdWUuYmFzZVRleHR1cmUgfHwgIXVuaWZvcm0udmFsdWUuYmFzZVRleHR1cmUuaGFzTG9hZGVkKQogICAgewogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBQSVhJLmdsLmFjdGl2ZVRleHR1cmUoUElYSS5nbFsnVEVYVFVSRScgKyB0aGlzLnRleHR1cmVDb3VudF0pOwogICAgUElYSS5nbC5iaW5kVGV4dHVyZShQSVhJLmdsLlRFWFRVUkVfMkQsIHVuaWZvcm0udmFsdWUuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CgogICAgLy8gIEV4dGVuZGVkIHRleHR1cmUgZGF0YQogICAgaWYgKHVuaWZvcm0udGV4dHVyZURhdGEpCiAgICB7CiAgICAgICAgdmFyIGRhdGEgPSB1bmlmb3JtLnRleHR1cmVEYXRhOwoKICAgICAgICAvLyBHTFRleHR1cmUgPSBtYWcgbGluZWFyLCBtaW4gbGluZWFyX21pcG1hcF9saW5lYXIsIHdyYXAgcmVwZWF0ICsgZ2wuZ2VuZXJhdGVNaXBtYXAoZ2wuVEVYVFVSRV8yRCk7CiAgICAgICAgLy8gR0xUZXh0dXJlTGluZWFyID0gbWFnL21pbiBsaW5lYXIsIHdyYXAgY2xhbXAKICAgICAgICAvLyBHTFRleHR1cmVOZWFyZXN0UmVwZWF0ID0gbWFnL21pbiBORUFSRVNULCB3cmFwIHJlcGVhdAogICAgICAgIC8vIEdMVGV4dHVyZU5lYXJlc3QgPSBtYWcvbWluIG5lYXJlc3QsIHdyYXAgY2xhbXAKICAgICAgICAvLyBBdWRpb1RleHR1cmUgPSB3aGF0ZXZlciArIGx1bWluYW5jZSArIHdpZHRoIDUxMiwgaGVpZ2h0IDIsIGJvcmRlciAwCiAgICAgICAgLy8gS2V5VGV4dHVyZSA9IHdoYXRldmVyICsgbHVtaW5hbmNlICsgd2lkdGggMjU2LCBoZWlnaHQgMiwgYm9yZGVyIDAKCiAgICAgICAgLy8gIG1hZ0ZpbHRlciBjYW4gYmU6IGdsLkxJTkVBUiwgZ2wuTElORUFSX01JUE1BUF9MSU5FQVIgb3IgZ2wuTkVBUkVTVAogICAgICAgIC8vICB3cmFwUy9UIGNhbiBiZTogZ2wuQ0xBTVBfVE9fRURHRSBvciBnbC5SRVBFQVQKCiAgICAgICAgdmFyIG1hZ0ZpbHRlciA9IChkYXRhLm1hZ0ZpbHRlcikgPyBkYXRhLm1hZ0ZpbHRlciA6IFBJWEkuZ2wuTElORUFSOwogICAgICAgIHZhciBtaW5GaWx0ZXIgPSAoZGF0YS5taW5GaWx0ZXIpID8gZGF0YS5taW5GaWx0ZXIgOiBQSVhJLmdsLkxJTkVBUjsKICAgICAgICB2YXIgd3JhcFMgPSAoZGF0YS53cmFwUykgPyBkYXRhLndyYXBTIDogUElYSS5nbC5DTEFNUF9UT19FREdFOwogICAgICAgIHZhciB3cmFwVCA9IChkYXRhLndyYXBUKSA/IGRhdGEud3JhcFQgOiBQSVhJLmdsLkNMQU1QX1RPX0VER0U7CiAgICAgICAgdmFyIGZvcm1hdCA9IChkYXRhLmx1bWluYW5jZSkgPyBQSVhJLmdsLkxVTUlOQU5DRSA6IFBJWEkuZ2wuUkdCQTsKCiAgICAgICAgaWYgKGRhdGEucmVwZWF0KQogICAgICAgIHsKICAgICAgICAgICAgd3JhcFMgPSBQSVhJLmdsLlJFUEVBVDsKICAgICAgICAgICAgd3JhcFQgPSBQSVhJLmdsLlJFUEVBVDsKICAgICAgICB9CgogICAgICAgIFBJWEkuZ2wucGl4ZWxTdG9yZWkoUElYSS5nbC5VTlBBQ0tfRkxJUF9ZX1dFQkdMLCBmYWxzZSk7CgogICAgICAgIGlmIChkYXRhLndpZHRoKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHdpZHRoID0gKGRhdGEud2lkdGgpID8gZGF0YS53aWR0aCA6IDUxMjsKICAgICAgICAgICAgdmFyIGhlaWdodCA9IChkYXRhLmhlaWdodCkgPyBkYXRhLmhlaWdodCA6IDI7CiAgICAgICAgICAgIHZhciBib3JkZXIgPSAoZGF0YS5ib3JkZXIpID8gZGF0YS5ib3JkZXIgOiAwOwoKICAgICAgICAgICAgLy8gdm9pZCB0ZXhJbWFnZTJEKEdMZW51bSB0YXJnZXQsIEdMaW50IGxldmVsLCBHTGVudW0gaW50ZXJuYWxmb3JtYXQsIEdMc2l6ZWkgd2lkdGgsIEdMc2l6ZWkgaGVpZ2h0LCBHTGludCBib3JkZXIsIEdMZW51bSBmb3JtYXQsIEdMZW51bSB0eXBlLCBBcnJheUJ1ZmZlclZpZXc/IHBpeGVscyk7CiAgICAgICAgICAgIFBJWEkuZ2wudGV4SW1hZ2UyRChQSVhJLmdsLlRFWFRVUkVfMkQsIDAsIGZvcm1hdCwgd2lkdGgsIGhlaWdodCwgYm9yZGVyLCBmb3JtYXQsIFBJWEkuZ2wuVU5TSUdORURfQllURSwgbnVsbCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICB2b2lkIHRleEltYWdlMkQoR0xlbnVtIHRhcmdldCwgR0xpbnQgbGV2ZWwsIEdMZW51bSBpbnRlcm5hbGZvcm1hdCwgR0xlbnVtIGZvcm1hdCwgR0xlbnVtIHR5cGUsIEltYWdlRGF0YT8gcGl4ZWxzKTsKICAgICAgICAgICAgUElYSS5nbC50ZXhJbWFnZTJEKFBJWEkuZ2wuVEVYVFVSRV8yRCwgMCwgZm9ybWF0LCBQSVhJLmdsLlJHQkEsIFBJWEkuZ2wuVU5TSUdORURfQllURSwgdW5pZm9ybS52YWx1ZS5iYXNlVGV4dHVyZS5zb3VyY2UpOwogICAgICAgIH0KCiAgICAgICAgUElYSS5nbC50ZXhQYXJhbWV0ZXJpKFBJWEkuZ2wuVEVYVFVSRV8yRCwgUElYSS5nbC5URVhUVVJFX01BR19GSUxURVIsIG1hZ0ZpbHRlcik7CiAgICAgICAgUElYSS5nbC50ZXhQYXJhbWV0ZXJpKFBJWEkuZ2wuVEVYVFVSRV8yRCwgUElYSS5nbC5URVhUVVJFX01JTl9GSUxURVIsIG1pbkZpbHRlcik7CiAgICAgICAgUElYSS5nbC50ZXhQYXJhbWV0ZXJpKFBJWEkuZ2wuVEVYVFVSRV8yRCwgUElYSS5nbC5URVhUVVJFX1dSQVBfUywgd3JhcFMpOwogICAgICAgIFBJWEkuZ2wudGV4UGFyYW1ldGVyaShQSVhJLmdsLlRFWFRVUkVfMkQsIFBJWEkuZ2wuVEVYVFVSRV9XUkFQX1QsIHdyYXBUKTsKICAgIH0KCiAgICBQSVhJLmdsLnVuaWZvcm0xaSh1bmlmb3JtLnVuaWZvcm1Mb2NhdGlvbiwgdGhpcy50ZXh0dXJlQ291bnQpOwoKICAgIHVuaWZvcm0uX2luaXQgPSB0cnVlOwoKICAgIHRoaXMudGV4dHVyZUNvdW50Kys7Cgp9OwoKLyoqCiogVXBkYXRlcyB0aGUgc2hhZGVyIHVuaWZvcm0gdmFsdWVzLgoqCiogQG1ldGhvZCBQSVhJLlBpeGlTaGFkZXIjc3luY1VuaWZvcm1zCiovClBJWEkuUGl4aVNoYWRlci5wcm90b3R5cGUuc3luY1VuaWZvcm1zID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLnRleHR1cmVDb3VudCA9IDE7CiAgICB2YXIgdW5pZm9ybTsKCiAgICAvLyAgVGhpcyB3b3VsZCBwcm9iYWJseSBiZSBmYXN0ZXIgaW4gYW4gYXJyYXkgYW5kIGl0IHdvdWxkIGd1YXJhbnRlZSBrZXkgb3JkZXIKICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnVuaWZvcm1zKQogICAgewoKICAgICAgICB1bmlmb3JtID0gdGhpcy51bmlmb3Jtc1trZXldOwoKICAgICAgICBpZiAodW5pZm9ybS5nbFZhbHVlTGVuZ3RoID09PSAxKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHVuaWZvcm0uZ2xNYXRyaXggPT09IHRydWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHVuaWZvcm0uZ2xGdW5jLmNhbGwoUElYSS5nbCwgdW5pZm9ybS51bmlmb3JtTG9jYXRpb24sIHVuaWZvcm0udHJhbnNwb3NlLCB1bmlmb3JtLnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHVuaWZvcm0uZ2xGdW5jLmNhbGwoUElYSS5nbCwgdW5pZm9ybS51bmlmb3JtTG9jYXRpb24sIHVuaWZvcm0udmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHVuaWZvcm0uZ2xWYWx1ZUxlbmd0aCA9PT0gMikKICAgICAgICB7CiAgICAgICAgICAgIHVuaWZvcm0uZ2xGdW5jLmNhbGwoUElYSS5nbCwgdW5pZm9ybS51bmlmb3JtTG9jYXRpb24sIHVuaWZvcm0udmFsdWUueCwgdW5pZm9ybS52YWx1ZS55KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodW5pZm9ybS5nbFZhbHVlTGVuZ3RoID09PSAzKQogICAgICAgIHsKICAgICAgICAgICAgdW5pZm9ybS5nbEZ1bmMuY2FsbChQSVhJLmdsLCB1bmlmb3JtLnVuaWZvcm1Mb2NhdGlvbiwgdW5pZm9ybS52YWx1ZS54LCB1bmlmb3JtLnZhbHVlLnksIHVuaWZvcm0udmFsdWUueik7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHVuaWZvcm0uZ2xWYWx1ZUxlbmd0aCA9PT0gNCkKICAgICAgICB7CiAgICAgICAgICAgIHVuaWZvcm0uZ2xGdW5jLmNhbGwoUElYSS5nbCwgdW5pZm9ybS51bmlmb3JtTG9jYXRpb24sIHVuaWZvcm0udmFsdWUueCwgdW5pZm9ybS52YWx1ZS55LCB1bmlmb3JtLnZhbHVlLnosIHVuaWZvcm0udmFsdWUudyk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHVuaWZvcm0udHlwZSA9PT0gJ3NhbXBsZXIyRCcpCiAgICAgICAgewogICAgICAgICAgICBpZiAodW5pZm9ybS5faW5pdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgUElYSS5nbC5hY3RpdmVUZXh0dXJlKFBJWEkuZ2xbJ1RFWFRVUkUnICsgdGhpcy50ZXh0dXJlQ291bnRdKTsKICAgICAgICAgICAgICAgIFBJWEkuZ2wuYmluZFRleHR1cmUoUElYSS5nbC5URVhUVVJFXzJELCB1bmlmb3JtLnZhbHVlLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpOwogICAgICAgICAgICAgICAgUElYSS5nbC51bmlmb3JtMWkodW5pZm9ybS51bmlmb3JtTG9jYXRpb24sIHRoaXMudGV4dHVyZUNvdW50KTsKICAgICAgICAgICAgICAgIHRoaXMudGV4dHVyZUNvdW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmluaXRTYW1wbGVyMkQodW5pZm9ybSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cgp9OwoKUElYSS5QaXhpU2hhZGVyLmRlZmF1bHRWZXJ0ZXhTcmMgPSBbCiAgICAnYXR0cmlidXRlIHZlYzIgYVZlcnRleFBvc2l0aW9uOycsCiAgICAnYXR0cmlidXRlIHZlYzIgYVRleHR1cmVDb29yZDsnLAogICAgJ2F0dHJpYnV0ZSBmbG9hdCBhQ29sb3I7JywKCiAgICAndW5pZm9ybSB2ZWMyIHByb2plY3Rpb25WZWN0b3I7JywKICAgICd1bmlmb3JtIHZlYzIgb2Zmc2V0VmVjdG9yOycsCiAgICAndmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7JywKCiAgICAndmFyeWluZyBmbG9hdCB2Q29sb3I7JywKCiAgICAnY29uc3QgdmVjMiBjZW50ZXIgPSB2ZWMyKC0xLjAsIDEuMCk7JywKCiAgICAndm9pZCBtYWluKHZvaWQpIHsnLAogICAgJyAgIGdsX1Bvc2l0aW9uID0gdmVjNCggKChhVmVydGV4UG9zaXRpb24gKyBvZmZzZXRWZWN0b3IpIC8gcHJvamVjdGlvblZlY3RvcikgKyBjZW50ZXIgLCAwLjAsIDEuMCk7JywKICAgICcgICB2VGV4dHVyZUNvb3JkID0gYVRleHR1cmVDb29yZDsnLAogICAgJyAgIHZDb2xvciA9IGFDb2xvcjsnLAogICAgJ30nCl07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKClBJWEkuUHJpbWl0aXZlU2hhZGVyID0gZnVuY3Rpb24oKQp7CiAgICAvLyB0aGUgd2ViR0wgcHJvZ3JhbS4uCiAgICB0aGlzLnByb2dyYW0gPSBudWxsOwoKICAgIHRoaXMuZnJhZ21lbnRTcmMgPSBbCiAgICAgICAgJ3ByZWNpc2lvbiBtZWRpdW1wIGZsb2F0OycsCiAgICAgICAgJ3ZhcnlpbmcgdmVjNCB2Q29sb3I7JywKCiAgICAgICAgJ3ZvaWQgbWFpbih2b2lkKSB7JywKICAgICAgICAnICAgZ2xfRnJhZ0NvbG9yID0gdkNvbG9yOycsCiAgICAgICAgJ30nCiAgICBdOwoKICAgIHRoaXMudmVydGV4U3JjICA9IFsKICAgICAgICAnYXR0cmlidXRlIHZlYzIgYVZlcnRleFBvc2l0aW9uOycsCiAgICAgICAgJ2F0dHJpYnV0ZSB2ZWM0IGFDb2xvcjsnLAogICAgICAgICd1bmlmb3JtIG1hdDMgdHJhbnNsYXRpb25NYXRyaXg7JywKICAgICAgICAndW5pZm9ybSB2ZWMyIHByb2plY3Rpb25WZWN0b3I7JywKICAgICAgICAndW5pZm9ybSB2ZWMyIG9mZnNldFZlY3RvcjsnLAogICAgICAgICd1bmlmb3JtIGZsb2F0IGFscGhhOycsCiAgICAgICAgJ3ZhcnlpbmcgdmVjNCB2Q29sb3I7JywKCiAgICAgICAgJ3ZvaWQgbWFpbih2b2lkKSB7JywKICAgICAgICAnICAgdmVjMyB2ID0gdHJhbnNsYXRpb25NYXRyaXggKiB2ZWMzKGFWZXJ0ZXhQb3NpdGlvbiAsIDEuMCk7JywKICAgICAgICAnICAgdiAtPSBvZmZzZXRWZWN0b3IueHl4OycsCiAgICAgICAgJyAgIGdsX1Bvc2l0aW9uID0gdmVjNCggdi54IC8gcHJvamVjdGlvblZlY3Rvci54IC0xLjAsIHYueSAvIC1wcm9qZWN0aW9uVmVjdG9yLnkgKyAxLjAgLCAwLjAsIDEuMCk7JywKICAgICAgICAnICAgdkNvbG9yID0gYUNvbG9yICAqIGFscGhhOycsCiAgICAgICAgJ30nCiAgICBdOwp9OwoKUElYSS5QcmltaXRpdmVTaGFkZXIucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbigpCnsKICAgIHZhciBwcm9ncmFtID0gUElYSS5jb21waWxlUHJvZ3JhbSh0aGlzLnZlcnRleFNyYywgdGhpcy5mcmFnbWVudFNyYyk7CgogICAgdmFyIGdsID0gUElYSS5nbDsKCiAgICBnbC51c2VQcm9ncmFtKHByb2dyYW0pOwoKICAgIC8vIGdldCBhbmQgc3RvcmUgdGhlIHVuaWZvcm1zIGZvciB0aGUgc2hhZGVyCiAgICB0aGlzLnByb2plY3Rpb25WZWN0b3IgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ3Byb2plY3Rpb25WZWN0b3InKTsKICAgIHRoaXMub2Zmc2V0VmVjdG9yID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICdvZmZzZXRWZWN0b3InKTsKCiAgICAvLyBnZXQgYW5kIHN0b3JlIHRoZSBhdHRyaWJ1dGVzCiAgICB0aGlzLmFWZXJ0ZXhQb3NpdGlvbiA9IGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sICdhVmVydGV4UG9zaXRpb24nKTsKICAgIHRoaXMuY29sb3JBdHRyaWJ1dGUgPSBnbC5nZXRBdHRyaWJMb2NhdGlvbihwcm9ncmFtLCAnYUNvbG9yJyk7CgogICAgdGhpcy50cmFuc2xhdGlvbk1hdHJpeCA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAndHJhbnNsYXRpb25NYXRyaXgnKTsKICAgIHRoaXMuYWxwaGEgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ2FscGhhJyk7CgogICAgdGhpcy5wcm9ncmFtID0gcHJvZ3JhbTsKfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKUElYSS5TdHJpcFNoYWRlciA9IGZ1bmN0aW9uKCkKewogICAgLy8gdGhlIHdlYkdMIHByb2dyYW0uLgogICAgdGhpcy5wcm9ncmFtID0gbnVsbDsKCiAgICB0aGlzLmZyYWdtZW50U3JjID0gWwogICAgICAgICdwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsnLAogICAgICAgICd2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsnLAogICAgICAgICd2YXJ5aW5nIGZsb2F0IHZDb2xvcjsnLAogICAgICAgICd1bmlmb3JtIGZsb2F0IGFscGhhOycsCiAgICAgICAgJ3VuaWZvcm0gc2FtcGxlcjJEIHVTYW1wbGVyOycsCgogICAgICAgICd2b2lkIG1haW4odm9pZCkgeycsCiAgICAgICAgJyAgIGdsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLngsIHZUZXh0dXJlQ29vcmQueSkpOycsCiAgICAgICAgJyAgIGdsX0ZyYWdDb2xvciA9IGdsX0ZyYWdDb2xvciAqIGFscGhhOycsCiAgICAgICAgJ30nCiAgICBdOwoKICAgIHRoaXMudmVydGV4U3JjID0gWwogICAgICAgICdhdHRyaWJ1dGUgdmVjMiBhVmVydGV4UG9zaXRpb247JywKICAgICAgICAnYXR0cmlidXRlIHZlYzIgYVRleHR1cmVDb29yZDsnLAogICAgICAgICdhdHRyaWJ1dGUgZmxvYXQgYUNvbG9yOycsCiAgICAgICAgJ3VuaWZvcm0gbWF0MyB0cmFuc2xhdGlvbk1hdHJpeDsnLAogICAgICAgICd1bmlmb3JtIHZlYzIgcHJvamVjdGlvblZlY3RvcjsnLAogICAgICAgICd1bmlmb3JtIHZlYzIgb2Zmc2V0VmVjdG9yOycsCiAgICAgICAgJ3ZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOycsCiAgICAgICAgJ3ZhcnlpbmcgZmxvYXQgdkNvbG9yOycsCgogICAgICAgICd2b2lkIG1haW4odm9pZCkgeycsCiAgICAgICAgJyAgIHZlYzMgdiA9IHRyYW5zbGF0aW9uTWF0cml4ICogdmVjMyhhVmVydGV4UG9zaXRpb24sIDEuMCk7JywKICAgICAgICAnICAgdiAtPSBvZmZzZXRWZWN0b3IueHl4OycsCiAgICAgICAgJyAgIGdsX1Bvc2l0aW9uID0gdmVjNCggdi54IC8gcHJvamVjdGlvblZlY3Rvci54IC0xLjAsIHYueSAvIHByb2plY3Rpb25WZWN0b3IueSArIDEuMCAsIDAuMCwgMS4wKTsnLAogICAgICAgICcgICB2VGV4dHVyZUNvb3JkID0gYVRleHR1cmVDb29yZDsnLAogICAgICAgICcgICB2Q29sb3IgPSBhQ29sb3I7JywKICAgICAgICAnfScKICAgIF07Cn07CgpQSVhJLlN0cmlwU2hhZGVyLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgcHJvZ3JhbSA9IFBJWEkuY29tcGlsZVByb2dyYW0odGhpcy52ZXJ0ZXhTcmMsIHRoaXMuZnJhZ21lbnRTcmMpOwoKICAgIHZhciBnbCA9IFBJWEkuZ2w7CgogICAgZ2wudXNlUHJvZ3JhbShwcm9ncmFtKTsKCiAgICAvLyBnZXQgYW5kIHN0b3JlIHRoZSB1bmlmb3JtcyBmb3IgdGhlIHNoYWRlcgogICAgdGhpcy51U2FtcGxlciA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAndVNhbXBsZXInKTsKICAgIHRoaXMucHJvamVjdGlvblZlY3RvciA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAncHJvamVjdGlvblZlY3RvcicpOwogICAgdGhpcy5vZmZzZXRWZWN0b3IgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ29mZnNldFZlY3RvcicpOwogICAgdGhpcy5jb2xvckF0dHJpYnV0ZSA9IGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sICdhQ29sb3InKTsKICAgIC8vdGhpcy5kaW1lbnNpb25zID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHRoaXMucHJvZ3JhbSwgJ2RpbWVuc2lvbnMnKTsKCiAgICAvLyBnZXQgYW5kIHN0b3JlIHRoZSBhdHRyaWJ1dGVzCiAgICB0aGlzLmFWZXJ0ZXhQb3NpdGlvbiA9IGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sICdhVmVydGV4UG9zaXRpb24nKTsKICAgIHRoaXMuYVRleHR1cmVDb29yZCA9IGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sICdhVGV4dHVyZUNvb3JkJyk7CgogICAgdGhpcy50cmFuc2xhdGlvbk1hdHJpeCA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAndHJhbnNsYXRpb25NYXRyaXgnKTsKICAgIHRoaXMuYWxwaGEgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ2FscGhhJyk7CgogICAgdGhpcy5wcm9ncmFtID0gcHJvZ3JhbTsKfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgpQSVhJLl9iYXRjaHMgPSBbXTsKCi8qKgogKiBAcHJpdmF0ZQogKi8KUElYSS5fZ2V0QmF0Y2ggPSBmdW5jdGlvbihnbCkKewogICAgaWYoUElYSS5fYmF0Y2hzLmxlbmd0aCA9PT0gMCkKICAgIHsKICAgICAgICByZXR1cm4gbmV3IFBJWEkuV2ViR0xCYXRjaChnbCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgcmV0dXJuIFBJWEkuX2JhdGNocy5wb3AoKTsKICAgIH0KfTsKCi8qKgogKiBAcHJpdmF0ZQogKi8KUElYSS5fcmV0dXJuQmF0Y2ggPSBmdW5jdGlvbihiYXRjaCkKewogICAgYmF0Y2guY2xlYW4oKTsKICAgIFBJWEkuX2JhdGNocy5wdXNoKGJhdGNoKTsKfTsKCi8qKgogKiBAcHJpdmF0ZQogKi8KUElYSS5fcmVzdG9yZUJhdGNocyA9IGZ1bmN0aW9uKGdsKQp7CiAgICBmb3IgKHZhciBpPTA7IGkgPCBQSVhJLl9iYXRjaHMubGVuZ3RoOyBpKyspCiAgICB7CiAgICAgICAgUElYSS5fYmF0Y2hzW2ldLnJlc3RvcmVMb3N0Q29udGV4dChnbCk7CiAgICB9Cn07CgovKioKICogQSBXZWJHTEJhdGNoIEVuYWJsZXMgYSBncm91cCBvZiBzcHJpdGVzIHRvIGJlIGRyYXduIHVzaW5nIHRoZSBzYW1lIHNldHRpbmdzLgogKiBpZiBhIGdyb3VwIG9mIHNwcml0ZXMgYWxsIGhhdmUgdGhlIHNhbWUgYmFzZVRleHR1cmUgYW5kIGJsZW5kTW9kZSB0aGVuIHRoZXkgY2FuIGJlIGdyb3VwZWQgaW50byBhIGJhdGNoLgogKiBBbGwgdGhlIHNwcml0ZXMgaW4gYSBiYXRjaCBjYW4gdGhlbiBiZSBkcmF3biBpbiBvbmUgZ28gYnkgdGhlIEdQVSB3aGljaCBpcyBodWdlbHkgZWZmaWNpZW50LiBBTEwgc3ByaXRlcwogKiBpbiB0aGUgd2ViR0wgcmVuZGVyZXIgYXJlIGFkZGVkIHRvIGEgYmF0Y2ggZXZlbiBpZiB0aGUgYmF0Y2ggb25seSBjb250YWlucyBvbmUgc3ByaXRlLiBCYXRjaGluZyBpcyBoYW5kbGVkCiAqIGF1dG9tYXRpY2FsbHkgYnkgdGhlIHdlYkdMIHJlbmRlcmVyLiBBIGdvb2QgdGlwIGlzOiB0aGUgc21hbGxlciB0aGUgbnVtYmVyIG9mIGJhdGNocyB0aGVyZSBhcmUsIHRoZSBmYXN0ZXIKICogdGhlIHdlYkdMIHJlbmRlcmVyIHdpbGwgcnVuLgogKgogKiBAY2xhc3MgV2ViR0xCYXRjaAogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIGdsIHtXZWJHTENvbnRleHR9IGFuIGluc3RhbmNlIG9mIHRoZSB3ZWJHTCBjb250ZXh0CiAqLwpQSVhJLldlYkdMQmF0Y2ggPSBmdW5jdGlvbihnbCkKewogICAgdGhpcy5nbCA9IGdsOwoKICAgIHRoaXMuc2l6ZSA9IDA7CgogICAgdGhpcy52ZXJ0ZXhCdWZmZXIgPSAgZ2wuY3JlYXRlQnVmZmVyKCk7CiAgICB0aGlzLmluZGV4QnVmZmVyID0gIGdsLmNyZWF0ZUJ1ZmZlcigpOwogICAgdGhpcy51dkJ1ZmZlciA9ICBnbC5jcmVhdGVCdWZmZXIoKTsKICAgIHRoaXMuY29sb3JCdWZmZXIgPSAgZ2wuY3JlYXRlQnVmZmVyKCk7CiAgICB0aGlzLmJsZW5kTW9kZSA9IFBJWEkuYmxlbmRNb2Rlcy5OT1JNQUw7CiAgICB0aGlzLmR5bmFtaWNTaXplID0gMTsKfTsKCi8vIGNvbnN0cnVjdG9yClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLldlYkdMQmF0Y2g7CgovKioKICogQ2xlYW5zIHRoZSBiYXRjaCBzbyB0aGF0IGlzIGNhbiBiZSByZXR1cm5lZCB0byBhbiBvYmplY3QgcG9vbCBhbmQgcmV1c2VkCiAqCiAqIEBtZXRob2QgY2xlYW4KICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUuY2xlYW4gPSBmdW5jdGlvbigpCnsKICAgIHRoaXMudmVydGljaWVzID0gW107CiAgICB0aGlzLnV2cyA9IFtdOwogICAgdGhpcy5pbmRpY2VzID0gW107CiAgICB0aGlzLmNvbG9ycyA9IFtdOwogICAgdGhpcy5keW5hbWljU2l6ZSA9IDE7CiAgICB0aGlzLnRleHR1cmUgPSBudWxsOwogICAgdGhpcy5sYXN0ID0gbnVsbDsKICAgIHRoaXMuc2l6ZSA9IDA7CiAgICB0aGlzLmhlYWQgPSBudWxsOwogICAgdGhpcy50YWlsID0gbnVsbDsKfTsKCi8qKgogKiBSZWNyZWF0ZXMgdGhlIGJ1ZmZlcnMgaW4gdGhlIGV2ZW50IG9mIGEgY29udGV4dCBsb3NzCiAqCiAqIEBtZXRob2QgcmVzdG9yZUxvc3RDb250ZXh0CiAqIEBwYXJhbSBnbCB7V2ViR0xDb250ZXh0fQogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5yZXN0b3JlTG9zdENvbnRleHQgPSBmdW5jdGlvbihnbCkKewogICAgdGhpcy5nbCA9IGdsOwogICAgdGhpcy52ZXJ0ZXhCdWZmZXIgPSAgZ2wuY3JlYXRlQnVmZmVyKCk7CiAgICB0aGlzLmluZGV4QnVmZmVyID0gIGdsLmNyZWF0ZUJ1ZmZlcigpOwogICAgdGhpcy51dkJ1ZmZlciA9ICBnbC5jcmVhdGVCdWZmZXIoKTsKICAgIHRoaXMuY29sb3JCdWZmZXIgPSAgZ2wuY3JlYXRlQnVmZmVyKCk7Cn07CgovKioKICogaW5pdHMgdGhlIGJhdGNoJ3MgdGV4dHVyZSBhbmQgYmxlbmQgbW9kZSBiYXNlZCBpZiB0aGUgc3VwcGxpZWQgc3ByaXRlCiAqCiAqIEBtZXRob2QgaW5pdAogKiBAcGFyYW0gc3ByaXRlIHtTcHJpdGV9IHRoZSBmaXJzdCBzcHJpdGUgdG8gYmUgYWRkZWQgdG8gdGhlIGJhdGNoLiBPbmx5IHNwcml0ZXMgd2l0aAogKiAgICAgIHRoZSBzYW1lIGJhc2UgdGV4dHVyZSBhbmQgYmxlbmQgbW9kZSB3aWxsIGJlIGFsbG93ZWQgdG8gYmUgYWRkZWQgdG8gdGhpcyBiYXRjaAogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oc3ByaXRlKQp7CiAgICBzcHJpdGUuYmF0Y2ggPSB0aGlzOwogICAgdGhpcy5kaXJ0eSA9IHRydWU7CiAgICB0aGlzLmJsZW5kTW9kZSA9IHNwcml0ZS5ibGVuZE1vZGU7CiAgICB0aGlzLnRleHR1cmUgPSBzcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZTsKICAgIHRoaXMuaGVhZCA9IHNwcml0ZTsKICAgIHRoaXMudGFpbCA9IHNwcml0ZTsKICAgIHRoaXMuc2l6ZSA9IDE7CgogICAgdGhpcy5ncm93QmF0Y2goKTsKfTsKCi8qKgogKiBpbnNlcnRzIGEgc3ByaXRlIGJlZm9yZSB0aGUgc3BlY2lmaWVkIHNwcml0ZQogKgogKiBAbWV0aG9kIGluc2VydEJlZm9yZQogKiBAcGFyYW0gc3ByaXRlIHtTcHJpdGV9IHRoZSBzcHJpdGUgdG8gYmUgYWRkZWQKICogQHBhcmFtIG5leHRTcHJpdGUge25leHRTcHJpdGV9IHRoZSBmaXJzdCBzcHJpdGUgd2lsbCBiZSBpbnNlcnRlZCBiZWZvcmUgdGhpcyBzcHJpdGUKICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUuaW5zZXJ0QmVmb3JlID0gZnVuY3Rpb24oc3ByaXRlLCBuZXh0U3ByaXRlKQp7CiAgICB0aGlzLnNpemUrKzsKCiAgICBzcHJpdGUuYmF0Y2ggPSB0aGlzOwogICAgdGhpcy5kaXJ0eSA9IHRydWU7CiAgICB2YXIgdGVtcFByZXYgPSBuZXh0U3ByaXRlLl9fcHJldjsKICAgIG5leHRTcHJpdGUuX19wcmV2ID0gc3ByaXRlOwogICAgc3ByaXRlLl9fbmV4dCA9IG5leHRTcHJpdGU7CgogICAgaWYodGVtcFByZXYpCiAgICB7CiAgICAgICAgc3ByaXRlLl9fcHJldiA9IHRlbXBQcmV2OwogICAgICAgIHRlbXBQcmV2Ll9fbmV4dCA9IHNwcml0ZTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLmhlYWQgPSBzcHJpdGU7CiAgICB9Cn07CgovKioKICogaW5zZXJ0cyBhIHNwcml0ZSBhZnRlciB0aGUgc3BlY2lmaWVkIHNwcml0ZQogKgogKiBAbWV0aG9kIGluc2VydEFmdGVyCiAqIEBwYXJhbSBzcHJpdGUge1Nwcml0ZX0gdGhlIHNwcml0ZSB0byBiZSBhZGRlZAogKiBAcGFyYW0gIHByZXZpb3VzU3ByaXRlIHtTcHJpdGV9IHRoZSBmaXJzdCBzcHJpdGUgd2lsbCBiZSBpbnNlcnRlZCBhZnRlciB0aGlzIHNwcml0ZQogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5pbnNlcnRBZnRlciA9IGZ1bmN0aW9uKHNwcml0ZSwgcHJldmlvdXNTcHJpdGUpCnsKICAgIHRoaXMuc2l6ZSsrOwoKICAgIHNwcml0ZS5iYXRjaCA9IHRoaXM7CiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKCiAgICB2YXIgdGVtcE5leHQgPSBwcmV2aW91c1Nwcml0ZS5fX25leHQ7CiAgICBwcmV2aW91c1Nwcml0ZS5fX25leHQgPSBzcHJpdGU7CiAgICBzcHJpdGUuX19wcmV2ID0gcHJldmlvdXNTcHJpdGU7CgogICAgaWYodGVtcE5leHQpCiAgICB7CiAgICAgICAgc3ByaXRlLl9fbmV4dCA9IHRlbXBOZXh0OwogICAgICAgIHRlbXBOZXh0Ll9fcHJldiA9IHNwcml0ZTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLnRhaWwgPSBzcHJpdGU7CiAgICB9Cn07CgovKioKICogcmVtb3ZlcyBhIHNwcml0ZSBmcm9tIHRoZSBiYXRjaAogKgogKiBAbWV0aG9kIHJlbW92ZQogKiBAcGFyYW0gc3ByaXRlIHtTcHJpdGV9IHRoZSBzcHJpdGUgdG8gYmUgcmVtb3ZlZAogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbihzcHJpdGUpCnsKICAgIHRoaXMuc2l6ZS0tOwoKICAgIGlmKHRoaXMuc2l6ZSA9PT0gMCkKICAgIHsKICAgICAgICBzcHJpdGUuYmF0Y2ggPSBudWxsOwogICAgICAgIHNwcml0ZS5fX3ByZXYgPSBudWxsOwogICAgICAgIHNwcml0ZS5fX25leHQgPSBudWxsOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZihzcHJpdGUuX19wcmV2KQogICAgewogICAgICAgIHNwcml0ZS5fX3ByZXYuX19uZXh0ID0gc3ByaXRlLl9fbmV4dDsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLmhlYWQgPSBzcHJpdGUuX19uZXh0OwogICAgICAgIHRoaXMuaGVhZC5fX3ByZXYgPSBudWxsOwogICAgfQoKICAgIGlmKHNwcml0ZS5fX25leHQpCiAgICB7CiAgICAgICAgc3ByaXRlLl9fbmV4dC5fX3ByZXYgPSBzcHJpdGUuX19wcmV2OwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMudGFpbCA9IHNwcml0ZS5fX3ByZXY7CiAgICAgICAgdGhpcy50YWlsLl9fbmV4dCA9IG51bGw7CiAgICB9CgogICAgc3ByaXRlLmJhdGNoID0gbnVsbDsKICAgIHNwcml0ZS5fX25leHQgPSBudWxsOwogICAgc3ByaXRlLl9fcHJldiA9IG51bGw7CiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKfTsKCi8qKgogKiBTcGxpdHMgdGhlIGJhdGNoIGludG8gdHdvIHdpdGggdGhlIHNwZWNpZmllZCBzcHJpdGUgYmVpbmcgdGhlIHN0YXJ0IG9mIHRoZSBuZXcgYmF0Y2guCiAqCiAqIEBtZXRob2Qgc3BsaXQKICogQHBhcmFtIHNwcml0ZSB7U3ByaXRlfSB0aGUgc3ByaXRlIHRoYXQgaW5kaWNhdGVzIHdoZXJlIHRoZSBiYXRjaCBzaG91bGQgYmUgc3BsaXQKICogQHJldHVybiB7V2ViR0xCYXRjaH0gdGhlIG5ldyBiYXRjaAogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5zcGxpdCA9IGZ1bmN0aW9uKHNwcml0ZSkKewogICAgdGhpcy5kaXJ0eSA9IHRydWU7CgogICAgdmFyIGJhdGNoID0gbmV3IFBJWEkuV2ViR0xCYXRjaCh0aGlzLmdsKTsKICAgIGJhdGNoLmluaXQoc3ByaXRlKTsKICAgIGJhdGNoLnRleHR1cmUgPSB0aGlzLnRleHR1cmU7CiAgICBiYXRjaC50YWlsID0gdGhpcy50YWlsOwoKICAgIHRoaXMudGFpbCA9IHNwcml0ZS5fX3ByZXY7CiAgICB0aGlzLnRhaWwuX19uZXh0ID0gbnVsbDsKCiAgICBzcHJpdGUuX19wcmV2ID0gbnVsbDsKICAgIC8vIHJldHVybiBhIHNwbGl0ZSBiYXRjaCEKCiAgICAvLyBUT0RPIHRoaXMgc2l6ZSBpcyB3cm9uZyEKICAgIC8vIG5lZWQgdG8gcmVjYWxjdWxhdGUgOi8gcHJvYmxlbSB3aXRoIGEgbGlua2VkIGxpc3QhCiAgICAvLyB1bmxlc3MgaXQgZ2V0cyBjYWxjdWxhdGVkIGluIHRoZSAiY2xlYW4iPwoKICAgIC8vIG5lZWQgdG8gbG9vcCB0aHJvdWdoIGl0ZW1zIGFzIHRoZXJlIGlzIG5vIHdheSB0byBrbm93IHRoZSBsZW5ndGggb24gYSBsaW5rZWQgbGlzdCA6LwogICAgdmFyIHRlbXBTaXplID0gMDsKICAgIHdoaWxlKHNwcml0ZSkKICAgIHsKICAgICAgICB0ZW1wU2l6ZSsrOwogICAgICAgIHNwcml0ZS5iYXRjaCA9IGJhdGNoOwogICAgICAgIHNwcml0ZSA9IHNwcml0ZS5fX25leHQ7CiAgICB9CgogICAgYmF0Y2guc2l6ZSA9IHRlbXBTaXplOwogICAgdGhpcy5zaXplIC09IHRlbXBTaXplOwoKICAgIHJldHVybiBiYXRjaDsKfTsKCi8qKgogKiBNZXJnZXMgdHdvIGJhdGNocyB0b2dldGhlcgogKgogKiBAbWV0aG9kIG1lcmdlCiAqIEBwYXJhbSBiYXRjaCB7V2ViR0xCYXRjaH0gdGhlIGJhdGNoIHRoYXQgd2lsbCBiZSBtZXJnZWQKICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUubWVyZ2UgPSBmdW5jdGlvbihiYXRjaCkKewogICAgdGhpcy5kaXJ0eSA9IHRydWU7CgogICAgdGhpcy50YWlsLl9fbmV4dCA9IGJhdGNoLmhlYWQ7CiAgICBiYXRjaC5oZWFkLl9fcHJldiA9IHRoaXMudGFpbDsKCiAgICB0aGlzLnNpemUgKz0gYmF0Y2guc2l6ZTsKCiAgICB0aGlzLnRhaWwgPSBiYXRjaC50YWlsOwoKICAgIHZhciBzcHJpdGUgPSBiYXRjaC5oZWFkOwogICAgd2hpbGUoc3ByaXRlKQogICAgewogICAgICAgIHNwcml0ZS5iYXRjaCA9IHRoaXM7CiAgICAgICAgc3ByaXRlID0gc3ByaXRlLl9fbmV4dDsKICAgIH0KfTsKCi8qKgogKiBHcm93cyB0aGUgc2l6ZSBvZiB0aGUgYmF0Y2guIEFzIHRoZSBlbGVtZW50cyBpbiB0aGUgYmF0Y2ggY2Fubm90IGhhdmUgYSBkeW5hbWljIHNpemUgdGhpcwogKiBmdW5jdGlvbiBpcyB1c2VkIHRvIGluY3JlYXNlIHRoZSBzaXplIG9mIHRoZSBiYXRjaC4gSXQgYWxzbyBjcmVhdGVzIGEgbGl0dGxlIGV4dHJhIHJvb20gc28KICogdGhhdCB0aGUgYmF0Y2ggZG9lcyBub3QgbmVlZCB0byBiZSByZXNpemVkIGV2ZXJ5IHRpbWUgYSBzcHJpdGUgaXMgYWRkZWQKICoKICogQG1ldGhvZCBncm93QmF0Y2gKICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUuZ3Jvd0JhdGNoID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgZ2wgPSB0aGlzLmdsOwogICAgaWYoIHRoaXMuc2l6ZSA9PT0gMSkKICAgIHsKICAgICAgICB0aGlzLmR5bmFtaWNTaXplID0gMTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLmR5bmFtaWNTaXplID0gdGhpcy5zaXplICogMS41OwogICAgfQoKICAgIC8vIGdyb3cgdmVydHMKICAgIHRoaXMudmVydGljaWVzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmR5bmFtaWNTaXplICogOCk7CgogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudmVydGV4QnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLHRoaXMudmVydGljaWVzICwgZ2wuRFlOQU1JQ19EUkFXKTsKCiAgICB0aGlzLnV2cyAgPSBuZXcgRmxvYXQzMkFycmF5KCB0aGlzLmR5bmFtaWNTaXplICogOCApOwogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudXZCdWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHRoaXMudXZzICwgZ2wuRFlOQU1JQ19EUkFXKTsKCiAgICB0aGlzLmRpcnR5VVZTID0gdHJ1ZTsKCiAgICB0aGlzLmNvbG9ycyAgPSBuZXcgRmxvYXQzMkFycmF5KCB0aGlzLmR5bmFtaWNTaXplICogNCApOwogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMuY29sb3JCdWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHRoaXMuY29sb3JzICwgZ2wuRFlOQU1JQ19EUkFXKTsKCiAgICB0aGlzLmRpcnR5Q29sb3JzID0gdHJ1ZTsKCiAgICB0aGlzLmluZGljZXMgPSBuZXcgVWludDE2QXJyYXkodGhpcy5keW5hbWljU2l6ZSAqIDYpOwogICAgdmFyIGxlbmd0aCA9IHRoaXMuaW5kaWNlcy5sZW5ndGgvNjsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKQogICAgewogICAgICAgIHZhciBpbmRleDIgPSBpICogNjsKICAgICAgICB2YXIgaW5kZXgzID0gaSAqIDQ7CiAgICAgICAgdGhpcy5pbmRpY2VzW2luZGV4MiArIDBdID0gaW5kZXgzICsgMDsKICAgICAgICB0aGlzLmluZGljZXNbaW5kZXgyICsgMV0gPSBpbmRleDMgKyAxOwogICAgICAgIHRoaXMuaW5kaWNlc1tpbmRleDIgKyAyXSA9IGluZGV4MyArIDI7CiAgICAgICAgdGhpcy5pbmRpY2VzW2luZGV4MiArIDNdID0gaW5kZXgzICsgMDsKICAgICAgICB0aGlzLmluZGljZXNbaW5kZXgyICsgNF0gPSBpbmRleDMgKyAyOwogICAgICAgIHRoaXMuaW5kaWNlc1tpbmRleDIgKyA1XSA9IGluZGV4MyArIDM7CiAgICB9CgogICAgZ2wuYmluZEJ1ZmZlcihnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgdGhpcy5pbmRleEJ1ZmZlcik7CiAgICBnbC5idWZmZXJEYXRhKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCB0aGlzLmluZGljZXMsIGdsLlNUQVRJQ19EUkFXKTsKfTsKCi8qKgogKiBSZWZyZXNoJ3MgYWxsIHRoZSBkYXRhIGluIHRoZSBiYXRjaCBhbmQgc3luYydzIGl0IHdpdGggdGhlIHdlYkdMIGJ1ZmZlcnMKICoKICogQG1ldGhvZCByZWZyZXNoCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLnJlZnJlc2ggPSBmdW5jdGlvbigpCnsKICAgIGlmICh0aGlzLmR5bmFtaWNTaXplIDwgdGhpcy5zaXplKQogICAgewogICAgICAgIHRoaXMuZ3Jvd0JhdGNoKCk7CiAgICB9CgogICAgdmFyIGluZGV4UnVuID0gMDsKICAgIHZhciBpbmRleCwgY29sb3JJbmRleDsKCiAgICB2YXIgZGlzcGxheU9iamVjdCA9IHRoaXMuaGVhZDsKCiAgICB3aGlsZShkaXNwbGF5T2JqZWN0KQogICAgewogICAgICAgIGluZGV4ID0gaW5kZXhSdW4gKiA4OwoKICAgICAgICB2YXIgdGV4dHVyZSA9IGRpc3BsYXlPYmplY3QudGV4dHVyZTsKCiAgICAgICAgdmFyIGZyYW1lID0gdGV4dHVyZS5mcmFtZTsKICAgICAgICB2YXIgdHcgPSB0ZXh0dXJlLmJhc2VUZXh0dXJlLndpZHRoOwogICAgICAgIHZhciB0aCA9IHRleHR1cmUuYmFzZVRleHR1cmUuaGVpZ2h0OwoKICAgICAgICB0aGlzLnV2c1tpbmRleCArIDBdID0gZnJhbWUueCAvIHR3OwogICAgICAgIHRoaXMudXZzW2luZGV4ICsxXSA9IGZyYW1lLnkgLyB0aDsKCiAgICAgICAgdGhpcy51dnNbaW5kZXggKzJdID0gKGZyYW1lLnggKyBmcmFtZS53aWR0aCkgLyB0dzsKICAgICAgICB0aGlzLnV2c1tpbmRleCArM10gPSBmcmFtZS55IC8gdGg7CgogICAgICAgIHRoaXMudXZzW2luZGV4ICs0XSA9IChmcmFtZS54ICsgZnJhbWUud2lkdGgpIC8gdHc7CiAgICAgICAgdGhpcy51dnNbaW5kZXggKzVdID0gKGZyYW1lLnkgKyBmcmFtZS5oZWlnaHQpIC8gdGg7CgogICAgICAgIHRoaXMudXZzW2luZGV4ICs2XSA9IGZyYW1lLnggLyB0dzsKICAgICAgICB0aGlzLnV2c1tpbmRleCArN10gPSAoZnJhbWUueSArIGZyYW1lLmhlaWdodCkgLyB0aDsKCiAgICAgICAgZGlzcGxheU9iamVjdC51cGRhdGVGcmFtZSA9IGZhbHNlOwoKICAgICAgICBjb2xvckluZGV4ID0gaW5kZXhSdW4gKiA0OwogICAgICAgIHRoaXMuY29sb3JzW2NvbG9ySW5kZXhdID0gdGhpcy5jb2xvcnNbY29sb3JJbmRleCArIDFdID0gdGhpcy5jb2xvcnNbY29sb3JJbmRleCArIDJdID0gdGhpcy5jb2xvcnNbY29sb3JJbmRleCArIDNdID0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhOwoKICAgICAgICBkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5fX25leHQ7CgogICAgICAgIGluZGV4UnVuKys7CiAgICB9CgogICAgdGhpcy5kaXJ0eVVWUyA9IHRydWU7CiAgICB0aGlzLmRpcnR5Q29sb3JzID0gdHJ1ZTsKfTsKCi8qKgogKiBVcGRhdGVzIGFsbCB0aGUgcmVsZXZhbnQgZ2VvbWV0cnkgYW5kIHVwbG9hZHMgdGhlIGRhdGEgdG8gdGhlIEdQVQogKgogKiBAbWV0aG9kIHVwZGF0ZQogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbigpCnsKICAgIHZhciB3b3JsZFRyYW5zZm9ybSwgd2lkdGgsIGhlaWdodCwgYVgsIGFZLCB3MCwgdzEsIGgwLCBoMSwgaW5kZXg7CgogICAgdmFyIGEsIGIsIGMsIGQsIHR4LCB0eTsKCiAgICB2YXIgaW5kZXhSdW4gPSAwOwoKICAgIHZhciBkaXNwbGF5T2JqZWN0ID0gdGhpcy5oZWFkOwogICAgdmFyIHZlcnRpY2llcyA9IHRoaXMudmVydGljaWVzOwogICAgdmFyIHV2cyA9IHRoaXMudXZzOwogICAgdmFyIGNvbG9ycyA9IHRoaXMuY29sb3JzOwoKICAgIHdoaWxlKGRpc3BsYXlPYmplY3QpCiAgICB7CiAgICAgICAgaWYoZGlzcGxheU9iamVjdC52Y291bnQgPT09IFBJWEkudmlzaWJsZUNvdW50KQogICAgICAgIHsKICAgICAgICAgICAgd2lkdGggPSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUud2lkdGg7CiAgICAgICAgICAgIGhlaWdodCA9IGRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS5oZWlnaHQ7CgogICAgICAgICAgICAvLyBUT0RPIHRyaW0/PwogICAgICAgICAgICBhWCA9IGRpc3BsYXlPYmplY3QuYW5jaG9yLng7Ly8gLSBkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbS54CiAgICAgICAgICAgIGFZID0gZGlzcGxheU9iamVjdC5hbmNob3IueTsgLy8tIGRpc3BsYXlPYmplY3QudGV4dHVyZS50cmltLnkKICAgICAgICAgICAgdzAgPSB3aWR0aCAqICgxLWFYKTsKICAgICAgICAgICAgdzEgPSB3aWR0aCAqIC1hWDsKCiAgICAgICAgICAgIGgwID0gaGVpZ2h0ICogKDEtYVkpOwogICAgICAgICAgICBoMSA9IGhlaWdodCAqIC1hWTsKCiAgICAgICAgICAgIGluZGV4ID0gaW5kZXhSdW4gKiA4OwoKICAgICAgICAgICAgd29ybGRUcmFuc2Zvcm0gPSBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtOwoKICAgICAgICAgICAgYSA9IHdvcmxkVHJhbnNmb3JtWzBdOwogICAgICAgICAgICBiID0gd29ybGRUcmFuc2Zvcm1bM107CiAgICAgICAgICAgIGMgPSB3b3JsZFRyYW5zZm9ybVsxXTsKICAgICAgICAgICAgZCA9IHdvcmxkVHJhbnNmb3JtWzRdOwogICAgICAgICAgICB0eCA9IHdvcmxkVHJhbnNmb3JtWzJdOwogICAgICAgICAgICB0eSA9IHdvcmxkVHJhbnNmb3JtWzVdOwoKICAgICAgICAgICAgdmVydGljaWVzW2luZGV4ICsgMCBdID0gYSAqIHcxICsgYyAqIGgxICsgdHg7CiAgICAgICAgICAgIHZlcnRpY2llc1tpbmRleCArIDEgXSA9IGQgKiBoMSArIGIgKiB3MSArIHR5OwoKICAgICAgICAgICAgdmVydGljaWVzW2luZGV4ICsgMiBdID0gYSAqIHcwICsgYyAqIGgxICsgdHg7CiAgICAgICAgICAgIHZlcnRpY2llc1tpbmRleCArIDMgXSA9IGQgKiBoMSArIGIgKiB3MCArIHR5OwoKICAgICAgICAgICAgdmVydGljaWVzW2luZGV4ICsgNCBdID0gYSAqIHcwICsgYyAqIGgwICsgdHg7CiAgICAgICAgICAgIHZlcnRpY2llc1tpbmRleCArIDUgXSA9IGQgKiBoMCArIGIgKiB3MCArIHR5OwoKICAgICAgICAgICAgdmVydGljaWVzW2luZGV4ICsgNl0gPSAgYSAqIHcxICsgYyAqIGgwICsgdHg7CiAgICAgICAgICAgIHZlcnRpY2llc1tpbmRleCArIDddID0gIGQgKiBoMCArIGIgKiB3MSArIHR5OwoKICAgICAgICAgICAgaWYoZGlzcGxheU9iamVjdC51cGRhdGVGcmFtZSB8fCBkaXNwbGF5T2JqZWN0LnRleHR1cmUudXBkYXRlRnJhbWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZGlydHlVVlMgPSB0cnVlOwoKICAgICAgICAgICAgICAgIHZhciB0ZXh0dXJlID0gZGlzcGxheU9iamVjdC50ZXh0dXJlOwoKICAgICAgICAgICAgICAgIHZhciBmcmFtZSA9IHRleHR1cmUuZnJhbWU7CiAgICAgICAgICAgICAgICB2YXIgdHcgPSB0ZXh0dXJlLmJhc2VUZXh0dXJlLndpZHRoOwogICAgICAgICAgICAgICAgdmFyIHRoID0gdGV4dHVyZS5iYXNlVGV4dHVyZS5oZWlnaHQ7CgogICAgICAgICAgICAgICAgdXZzW2luZGV4ICsgMF0gPSBmcmFtZS54IC8gdHc7CiAgICAgICAgICAgICAgICB1dnNbaW5kZXggKzFdID0gZnJhbWUueSAvIHRoOwoKICAgICAgICAgICAgICAgIHV2c1tpbmRleCArMl0gPSAoZnJhbWUueCArIGZyYW1lLndpZHRoKSAvIHR3OwogICAgICAgICAgICAgICAgdXZzW2luZGV4ICszXSA9IGZyYW1lLnkgLyB0aDsKCiAgICAgICAgICAgICAgICB1dnNbaW5kZXggKzRdID0gKGZyYW1lLnggKyBmcmFtZS53aWR0aCkgLyB0dzsKICAgICAgICAgICAgICAgIHV2c1tpbmRleCArNV0gPSAoZnJhbWUueSArIGZyYW1lLmhlaWdodCkgLyB0aDsKCiAgICAgICAgICAgICAgICB1dnNbaW5kZXggKzZdID0gZnJhbWUueCAvIHR3OwogICAgICAgICAgICAgICAgdXZzW2luZGV4ICs3XSA9IChmcmFtZS55ICsgZnJhbWUuaGVpZ2h0KSAvIHRoOwoKICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3QudXBkYXRlRnJhbWUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVE9ETyB0aGlzIHByb2JhYmx5IGNvdWxkIGRvIHdpdGggc29tZSBvcHRpbWlzYXRpb24uLi4uCiAgICAgICAgICAgIGlmKGRpc3BsYXlPYmplY3QuY2FjaGVBbHBoYSAhPT0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LmNhY2hlQWxwaGEgPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGE7CgogICAgICAgICAgICAgICAgdmFyIGNvbG9ySW5kZXggPSBpbmRleFJ1biAqIDQ7CiAgICAgICAgICAgICAgICBjb2xvcnNbY29sb3JJbmRleF0gPSBjb2xvcnNbY29sb3JJbmRleCArIDFdID0gY29sb3JzW2NvbG9ySW5kZXggKyAyXSA9IGNvbG9yc1tjb2xvckluZGV4ICsgM10gPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGE7CiAgICAgICAgICAgICAgICB0aGlzLmRpcnR5Q29sb3JzID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpbmRleCA9IGluZGV4UnVuICogODsKCiAgICAgICAgICAgIHZlcnRpY2llc1tpbmRleCArIDAgXSA9IHZlcnRpY2llc1tpbmRleCArIDEgXSA9IHZlcnRpY2llc1tpbmRleCArIDIgXSA9IHZlcnRpY2llc1tpbmRleCArIDMgXSA9IHZlcnRpY2llc1tpbmRleCArIDQgXSA9IHZlcnRpY2llc1tpbmRleCArIDUgXSA9IHZlcnRpY2llc1tpbmRleCArIDZdID0gIHZlcnRpY2llc1tpbmRleCArIDddID0gMDsKICAgICAgICB9CgogICAgICAgIGluZGV4UnVuKys7CiAgICAgICAgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuX19uZXh0OwogICAgfQp9OwoKLyoqCiAqIERyYXdzIHRoZSBiYXRjaCB0byB0aGUgZnJhbWUgYnVmZmVyCiAqCiAqIEBtZXRob2QgcmVuZGVyCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpCnsKICAgIHN0YXJ0ID0gc3RhcnQgfHwgMDsKCiAgICBpZihlbmQgPT09IHVuZGVmaW5lZCkKICAgICAgICBlbmQgPSB0aGlzLnNpemU7CgogICAgaWYodGhpcy5kaXJ0eSkKICAgIHsKICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgICB0aGlzLmRpcnR5ID0gZmFsc2U7CiAgICB9CgogICAgaWYgKHRoaXMuc2l6ZSA9PT0gMClyZXR1cm47CgogICAgdGhpcy51cGRhdGUoKTsKICAgIHZhciBnbCA9IHRoaXMuZ2w7CgogICAgLy9UT0RPIG9wdGltaXplIHRoaXMhCgogICAgdmFyIHNoYWRlclByb2dyYW0gPSBQSVhJLmRlZmF1bHRTaGFkZXI7CgogICAgLy9nbC51c2VQcm9ncmFtKHNoYWRlclByb2dyYW0pOwoKICAgIC8vIHVwZGF0ZSB0aGUgdmVydHMuLgogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudmVydGV4QnVmZmVyKTsKICAgIC8vIG9rLi4KICAgIGdsLmJ1ZmZlclN1YkRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAwLCB0aGlzLnZlcnRpY2llcyk7CiAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlclByb2dyYW0uYVZlcnRleFBvc2l0aW9uLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwogICAgLy8gdXBkYXRlIHRoZSB1dnMKICAgIC8vdmFyIGlzRGVmYXVsdCA9IChzaGFkZXJQcm9ncmFtID09IFBJWEkuc2hhZGVyUHJvZ3JhbSkKCiAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy51dkJ1ZmZlcik7CgogICAgaWYodGhpcy5kaXJ0eVVWUykKICAgIHsKICAgICAgICB0aGlzLmRpcnR5VVZTID0gZmFsc2U7CiAgICAgICAgZ2wuYnVmZmVyU3ViRGF0YShnbC5BUlJBWV9CVUZGRVIsICAwLCB0aGlzLnV2cyk7CiAgICB9CgogICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXJQcm9ncmFtLmFUZXh0dXJlQ29vcmQsIDIsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgogICAgZ2wuYWN0aXZlVGV4dHVyZShnbC5URVhUVVJFMCk7CiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0aGlzLnRleHR1cmUuX2dsVGV4dHVyZSk7CgogICAgLy8gdXBkYXRlIGNvbG9yIQogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMuY29sb3JCdWZmZXIpOwoKICAgIGlmKHRoaXMuZGlydHlDb2xvcnMpCiAgICB7CiAgICAgICAgdGhpcy5kaXJ0eUNvbG9ycyA9IGZhbHNlOwogICAgICAgIGdsLmJ1ZmZlclN1YkRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAwLCB0aGlzLmNvbG9ycyk7CiAgICB9CgogICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXJQcm9ncmFtLmNvbG9yQXR0cmlidXRlLCAxLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwogICAgLy8gZG9udCBuZWVkIHRvIHVwbG9hZCEKICAgIGdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHRoaXMuaW5kZXhCdWZmZXIpOwoKICAgIHZhciBsZW4gPSBlbmQgLSBzdGFydDsKCiAgICAvLyBEUkFXIFRIQVQgdGhpcyEKICAgIGdsLmRyYXdFbGVtZW50cyhnbC5UUklBTkdMRVMsIGxlbiAqIDYsIGdsLlVOU0lHTkVEX1NIT1JULCBzdGFydCAqIDIgKiA2ICk7Cn07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKClBJWEkuV2ViR0xGaWx0ZXJNYW5hZ2VyID0gZnVuY3Rpb24odHJhbnNwYXJlbnQpCnsKICAgIHRoaXMudHJhbnNwYXJlbnQgPSB0cmFuc3BhcmVudDsKCiAgICB0aGlzLmZpbHRlclN0YWNrID0gW107CiAgICB0aGlzLnRleHR1cmVQb29sID0gW107CgogICAgdGhpcy5vZmZzZXRYID0gMDsKICAgIHRoaXMub2Zmc2V0WSA9IDA7CgogICAgdGhpcy5pbml0U2hhZGVyQnVmZmVycygpOwp9OwoKLy8gQVBJCgpQSVhJLldlYkdMRmlsdGVyTWFuYWdlci5wcm90b3R5cGUuYmVnaW4gPSBmdW5jdGlvbihwcm9qZWN0aW9uLCBidWZmZXIpCnsKICAgIHRoaXMud2lkdGggPSBwcm9qZWN0aW9uLnggKiAyOwogICAgdGhpcy5oZWlnaHQgPSAtcHJvamVjdGlvbi55ICogMjsKICAgIHRoaXMuYnVmZmVyID0gYnVmZmVyOwp9OwoKUElYSS5XZWJHTEZpbHRlck1hbmFnZXIucHJvdG90eXBlLnB1c2hGaWx0ZXIgPSBmdW5jdGlvbihmaWx0ZXJCbG9jaykKewogICAgdmFyIGdsID0gUElYSS5nbDsKCiAgICAvLyBmaWx0ZXIgcHJvZ3JhbQogICAgLy8gT1BUSU1JU0FUSU9OIC0gdGhlIGZpcnN0IGZpbHRlciBpcyBmcmVlIGlmIGl0cyBhIHNpbXBsZSBjb2xvciBjaGFuZ2U/CiAgICB0aGlzLmZpbHRlclN0YWNrLnB1c2goZmlsdGVyQmxvY2spOwoKICAgIHZhciBmaWx0ZXIgPSBmaWx0ZXJCbG9jay5maWx0ZXJQYXNzZXNbMF07CgogICAgdGhpcy5vZmZzZXRYICs9IGZpbHRlckJsb2NrLnRhcmdldC5maWx0ZXJBcmVhLng7CiAgICB0aGlzLm9mZnNldFkgKz0gZmlsdGVyQmxvY2sudGFyZ2V0LmZpbHRlckFyZWEueTsKCiAgICB2YXIgdGV4dHVyZSA9IHRoaXMudGV4dHVyZVBvb2wucG9wKCk7CiAgICBpZighdGV4dHVyZSkKICAgIHsKICAgICAgICB0ZXh0dXJlID0gbmV3IFBJWEkuRmlsdGVyVGV4dHVyZSh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGV4dHVyZS5yZXNpemUodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwogICAgfQoKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsICB0ZXh0dXJlLnRleHR1cmUpOwoKICAgIHRoaXMuZ2V0Qm91bmRzKGZpbHRlckJsb2NrLnRhcmdldCk7CgogICAgdmFyIGZpbHRlckFyZWEgPSBmaWx0ZXJCbG9jay50YXJnZXQuZmlsdGVyQXJlYTsKCiAgICB2YXIgcGFkaWRuZyA9IGZpbHRlci5wYWRkaW5nOwogICAgZmlsdGVyQXJlYS54IC09IHBhZGlkbmc7CiAgICBmaWx0ZXJBcmVhLnkgLT0gcGFkaWRuZzsKICAgIGZpbHRlckFyZWEud2lkdGggKz0gcGFkaWRuZyAqIDI7CiAgICBmaWx0ZXJBcmVhLmhlaWdodCArPSBwYWRpZG5nICogMjsKCiAgICAvLyBjYXAgZmlsdGVyIHRvIHNjcmVlbiBzaXplLi4KICAgIGlmKGZpbHRlckFyZWEueCA8IDApZmlsdGVyQXJlYS54ID0gMDsKICAgIGlmKGZpbHRlckFyZWEud2lkdGggPiB0aGlzLndpZHRoKWZpbHRlckFyZWEud2lkdGggPSB0aGlzLndpZHRoOwogICAgaWYoZmlsdGVyQXJlYS55IDwgMClmaWx0ZXJBcmVhLnkgPSAwOwogICAgaWYoZmlsdGVyQXJlYS5oZWlnaHQgPiB0aGlzLmhlaWdodClmaWx0ZXJBcmVhLmhlaWdodCA9IHRoaXMuaGVpZ2h0OwoKICAgIC8vZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCAgZmlsdGVyQXJlYS53aWR0aCwgZmlsdGVyQXJlYS5oZWlnaHQsIDAsIGdsLlJHQkEsIGdsLlVOU0lHTkVEX0JZVEUsIG51bGwpOwogICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0ZXh0dXJlLmZyYW1lQnVmZmVyKTsKCiAgICAvLyBzZXQgdmlldyBwb3J0CiAgICBnbC52aWV3cG9ydCgwLCAwLCBmaWx0ZXJBcmVhLndpZHRoLCBmaWx0ZXJBcmVhLmhlaWdodCk7CgogICAgUElYSS5wcm9qZWN0aW9uLnggPSBmaWx0ZXJBcmVhLndpZHRoLzI7CiAgICBQSVhJLnByb2plY3Rpb24ueSA9IC1maWx0ZXJBcmVhLmhlaWdodC8yOwoKICAgIFBJWEkub2Zmc2V0LnggPSAtZmlsdGVyQXJlYS54OwogICAgUElYSS5vZmZzZXQueSA9IC1maWx0ZXJBcmVhLnk7CgogICAgLy8gdXBkYXRlIHByb2plY3Rpb24KICAgIGdsLnVuaWZvcm0yZihQSVhJLmRlZmF1bHRTaGFkZXIucHJvamVjdGlvblZlY3RvciwgZmlsdGVyQXJlYS53aWR0aC8yLCAtZmlsdGVyQXJlYS5oZWlnaHQvMik7CiAgICBnbC51bmlmb3JtMmYoUElYSS5kZWZhdWx0U2hhZGVyLm9mZnNldFZlY3RvciwgLWZpbHRlckFyZWEueCwgLWZpbHRlckFyZWEueSk7CiAgICAvL1BJWEkucHJpbWl0aXZlUHJvZ3JhbQoKICAgIGdsLmNvbG9yTWFzayh0cnVlLCB0cnVlLCB0cnVlLCB0cnVlKTsKICAgIGdsLmNsZWFyQ29sb3IoMCwwLDAsIDApOwogICAgZ2wuY2xlYXIoZ2wuQ09MT1JfQlVGRkVSX0JJVCk7CgogICAgZmlsdGVyQmxvY2suX2dsRmlsdGVyVGV4dHVyZSA9IHRleHR1cmU7Cn07CgoKUElYSS5XZWJHTEZpbHRlck1hbmFnZXIucHJvdG90eXBlLnBvcEZpbHRlciA9IGZ1bmN0aW9uKCkKewogICAgdmFyIGdsID0gUElYSS5nbDsKICAgIHZhciBmaWx0ZXJCbG9jayA9IHRoaXMuZmlsdGVyU3RhY2sucG9wKCk7CiAgICB2YXIgZmlsdGVyQXJlYSA9IGZpbHRlckJsb2NrLnRhcmdldC5maWx0ZXJBcmVhOwogICAgdmFyIHRleHR1cmUgPSBmaWx0ZXJCbG9jay5fZ2xGaWx0ZXJUZXh0dXJlOwoKICAgIGlmKGZpbHRlckJsb2NrLmZpbHRlclBhc3Nlcy5sZW5ndGggPiAxKQogICAgewogICAgICAgIGdsLnZpZXdwb3J0KDAsIDAsIGZpbHRlckFyZWEud2lkdGgsIGZpbHRlckFyZWEuaGVpZ2h0KTsKCiAgICAgICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudmVydGV4QnVmZmVyKTsKCiAgICAgICAgdGhpcy52ZXJ0ZXhBcnJheVswXSA9IDA7CiAgICAgICAgdGhpcy52ZXJ0ZXhBcnJheVsxXSA9IGZpbHRlckFyZWEuaGVpZ2h0OwoKICAgICAgICB0aGlzLnZlcnRleEFycmF5WzJdID0gZmlsdGVyQXJlYS53aWR0aDsKICAgICAgICB0aGlzLnZlcnRleEFycmF5WzNdID0gZmlsdGVyQXJlYS5oZWlnaHQ7CgogICAgICAgIHRoaXMudmVydGV4QXJyYXlbNF0gPSAwOwogICAgICAgIHRoaXMudmVydGV4QXJyYXlbNV0gPSAwOwoKICAgICAgICB0aGlzLnZlcnRleEFycmF5WzZdID0gZmlsdGVyQXJlYS53aWR0aDsKICAgICAgICB0aGlzLnZlcnRleEFycmF5WzddID0gMDsKCiAgICAgICAgZ2wuYnVmZmVyU3ViRGF0YShnbC5BUlJBWV9CVUZGRVIsIDAsIHRoaXMudmVydGV4QXJyYXkpOwoKICAgICAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy51dkJ1ZmZlcik7CiAgICAgICAgLy8gbm5vdyBzZXQgdGhlIHV2cy4uCiAgICAgICAgdGhpcy51dkFycmF5WzJdID0gZmlsdGVyQXJlYS53aWR0aC90aGlzLndpZHRoOwogICAgICAgIHRoaXMudXZBcnJheVs1XSA9IGZpbHRlckFyZWEuaGVpZ2h0L3RoaXMuaGVpZ2h0OwogICAgICAgIHRoaXMudXZBcnJheVs2XSA9IGZpbHRlckFyZWEud2lkdGgvdGhpcy53aWR0aDsKICAgICAgICB0aGlzLnV2QXJyYXlbN10gPSBmaWx0ZXJBcmVhLmhlaWdodC90aGlzLmhlaWdodDsKCiAgICAgICAgZ2wuYnVmZmVyU3ViRGF0YShnbC5BUlJBWV9CVUZGRVIsIDAsIHRoaXMudXZBcnJheSk7CgogICAgICAgIHZhciBpbnB1dFRleHR1cmUgPSB0ZXh0dXJlOwogICAgICAgIHZhciBvdXRwdXRUZXh0dXJlID0gdGhpcy50ZXh0dXJlUG9vbC5wb3AoKTsKICAgICAgICBpZighb3V0cHV0VGV4dHVyZSlvdXRwdXRUZXh0dXJlID0gbmV3IFBJWEkuRmlsdGVyVGV4dHVyZSh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgogICAgICAgIC8vIG5lZWQgdG8gY2xlYXIgdGhpcyBGQk8gYXMgaXQgbWF5IGhhdmUgc29tZSBsZWZ0IG92ZXIgZWxlbWVudHMgZnJvbSBhIHBydmlvdXMgZmlsdGVyLgogICAgICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgb3V0cHV0VGV4dHVyZS5mcmFtZUJ1ZmZlciApOwogICAgICAgIGdsLmNsZWFyKGdsLkNPTE9SX0JVRkZFUl9CSVQpOwoKICAgICAgICBnbC5kaXNhYmxlKGdsLkJMRU5EKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaWx0ZXJCbG9jay5maWx0ZXJQYXNzZXMubGVuZ3RoLTE7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBmaWx0ZXJQYXNzID0gZmlsdGVyQmxvY2suZmlsdGVyUGFzc2VzW2ldOwoKICAgICAgICAgICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCBvdXRwdXRUZXh0dXJlLmZyYW1lQnVmZmVyICk7CgogICAgICAgICAgICAvLyBzZXQgdGV4dHVyZQogICAgICAgICAgICBnbC5hY3RpdmVUZXh0dXJlKGdsLlRFWFRVUkUwKTsKICAgICAgICAgICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgaW5wdXRUZXh0dXJlLnRleHR1cmUpOwoKICAgICAgICAgICAgLy8gZHJhdyB0ZXh0dXJlLi4KICAgICAgICAgICAgLy9maWx0ZXJQYXNzLmFwcGx5RmlsdGVyUGFzcyhmaWx0ZXJBcmVhLndpZHRoLCBmaWx0ZXJBcmVhLmhlaWdodCk7CiAgICAgICAgICAgIHRoaXMuYXBwbHlGaWx0ZXJQYXNzKGZpbHRlclBhc3MsIGZpbHRlckFyZWEsIGZpbHRlckFyZWEud2lkdGgsIGZpbHRlckFyZWEuaGVpZ2h0KTsKCiAgICAgICAgICAgIC8vIHN3YXAgdGhlIHRleHR1cmVzLi4KICAgICAgICAgICAgdmFyIHRlbXAgPSBpbnB1dFRleHR1cmU7CiAgICAgICAgICAgIGlucHV0VGV4dHVyZSA9IG91dHB1dFRleHR1cmU7CiAgICAgICAgICAgIG91dHB1dFRleHR1cmUgPSB0ZW1wOwogICAgICAgIH0KCiAgICAgICAgZ2wuZW5hYmxlKGdsLkJMRU5EKTsKCiAgICAgICAgdGV4dHVyZSA9IGlucHV0VGV4dHVyZTsKICAgICAgICB0aGlzLnRleHR1cmVQb29sLnB1c2gob3V0cHV0VGV4dHVyZSk7CiAgICB9CgogICAgdmFyIGZpbHRlciA9IGZpbHRlckJsb2NrLmZpbHRlclBhc3Nlc1tmaWx0ZXJCbG9jay5maWx0ZXJQYXNzZXMubGVuZ3RoLTFdOwoKICAgIHRoaXMub2Zmc2V0WCAtPSBmaWx0ZXJBcmVhLng7CiAgICB0aGlzLm9mZnNldFkgLT0gZmlsdGVyQXJlYS55OwoKCiAgICB2YXIgc2l6ZVggPSB0aGlzLndpZHRoOwogICAgdmFyIHNpemVZID0gdGhpcy5oZWlnaHQ7CgogICAgdmFyIG9mZnNldFggPSAwOwogICAgdmFyIG9mZnNldFkgPSAwOwoKICAgIHZhciBidWZmZXIgPSB0aGlzLmJ1ZmZlcjsKCiAgICAvLyB0aW1lIHRvIHJlbmRlciB0aGUgZmlsdGVycyB0ZXh0dXJlIHRvIHRoZSBwcmV2aW91cyBzY2VuZQogICAgaWYodGhpcy5maWx0ZXJTdGFjay5sZW5ndGggPT09IDApCiAgICB7CiAgICAgICAgZ2wuY29sb3JNYXNrKHRydWUsIHRydWUsIHRydWUsIHRoaXMudHJhbnNwYXJlbnQpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHZhciBjdXJyZW50RmlsdGVyID0gdGhpcy5maWx0ZXJTdGFja1t0aGlzLmZpbHRlclN0YWNrLmxlbmd0aC0xXTsKICAgICAgICBmaWx0ZXJBcmVhID0gY3VycmVudEZpbHRlci50YXJnZXQuZmlsdGVyQXJlYTsKCiAgICAgICAgc2l6ZVggPSBmaWx0ZXJBcmVhLndpZHRoOwogICAgICAgIHNpemVZID0gZmlsdGVyQXJlYS5oZWlnaHQ7CgogICAgICAgIG9mZnNldFggPSBmaWx0ZXJBcmVhLng7CiAgICAgICAgb2Zmc2V0WSA9IGZpbHRlckFyZWEueTsKCiAgICAgICAgYnVmZmVyID0gIGN1cnJlbnRGaWx0ZXIuX2dsRmlsdGVyVGV4dHVyZS5mcmFtZUJ1ZmZlcjsKICAgIH0KCgoKICAgIC8vIFRPRE8gbmVlZCB0b3JlbW92ZSB0aGVhc2UgZ2xvYmFsIGVsZW1lbnRzLi4KICAgIFBJWEkucHJvamVjdGlvbi54ID0gc2l6ZVgvMjsKICAgIFBJWEkucHJvamVjdGlvbi55ID0gLXNpemVZLzI7CgogICAgUElYSS5vZmZzZXQueCA9IG9mZnNldFg7CiAgICBQSVhJLm9mZnNldC55ID0gb2Zmc2V0WTsKCiAgICBmaWx0ZXJBcmVhID0gZmlsdGVyQmxvY2sudGFyZ2V0LmZpbHRlckFyZWE7CgogICAgdmFyIHggPSBmaWx0ZXJBcmVhLngtb2Zmc2V0WDsKICAgIHZhciB5ID0gZmlsdGVyQXJlYS55LW9mZnNldFk7CgogICAgLy8gdXBkYXRlIHRoZSBidWZmZXJzLi4KICAgIC8vIG1ha2Ugc3VyZSB0byBmbGlwIHRoZSB5IQogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudmVydGV4QnVmZmVyKTsKCiAgICB0aGlzLnZlcnRleEFycmF5WzBdID0geDsKICAgIHRoaXMudmVydGV4QXJyYXlbMV0gPSB5ICsgZmlsdGVyQXJlYS5oZWlnaHQ7CgogICAgdGhpcy52ZXJ0ZXhBcnJheVsyXSA9IHggKyBmaWx0ZXJBcmVhLndpZHRoOwogICAgdGhpcy52ZXJ0ZXhBcnJheVszXSA9IHkgKyBmaWx0ZXJBcmVhLmhlaWdodDsKCiAgICB0aGlzLnZlcnRleEFycmF5WzRdID0geDsKICAgIHRoaXMudmVydGV4QXJyYXlbNV0gPSB5OwoKICAgIHRoaXMudmVydGV4QXJyYXlbNl0gPSB4ICsgZmlsdGVyQXJlYS53aWR0aDsKICAgIHRoaXMudmVydGV4QXJyYXlbN10gPSB5OwoKICAgIGdsLmJ1ZmZlclN1YkRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAwLCB0aGlzLnZlcnRleEFycmF5KTsKCiAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy51dkJ1ZmZlcik7CgogICAgdGhpcy51dkFycmF5WzJdID0gZmlsdGVyQXJlYS53aWR0aC90aGlzLndpZHRoOwogICAgdGhpcy51dkFycmF5WzVdID0gZmlsdGVyQXJlYS5oZWlnaHQvdGhpcy5oZWlnaHQ7CiAgICB0aGlzLnV2QXJyYXlbNl0gPSBmaWx0ZXJBcmVhLndpZHRoL3RoaXMud2lkdGg7CiAgICB0aGlzLnV2QXJyYXlbN10gPSBmaWx0ZXJBcmVhLmhlaWdodC90aGlzLmhlaWdodDsKCiAgICBnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgMCwgdGhpcy51dkFycmF5KTsKCiAgICBnbC52aWV3cG9ydCgwLCAwLCBzaXplWCwgc2l6ZVkpOwogICAgLy8gYmluZCB0aGUgYnVmZmVyCiAgICBnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIGJ1ZmZlciApOwoKICAgIC8vIHNldCB0ZXh0dXJlCiAgICBnbC5hY3RpdmVUZXh0dXJlKGdsLlRFWFRVUkUwKTsKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRleHR1cmUudGV4dHVyZSk7CgogICAgLy8gYXBwbHkhCiAgICAvL2ZpbHRlci5hcHBseUZpbHRlclBhc3Moc2l6ZVgsIHNpemVZKTsKICAgIHRoaXMuYXBwbHlGaWx0ZXJQYXNzKGZpbHRlciwgZmlsdGVyQXJlYSwgc2l6ZVgsIHNpemVZKTsKCiAgICAvLyBub3cgcmVzdG9yZSB0aGUgcmVndWxhciBzaGFkZXIuLgogICAgZ2wudXNlUHJvZ3JhbShQSVhJLmRlZmF1bHRTaGFkZXIucHJvZ3JhbSk7CiAgICBnbC51bmlmb3JtMmYoUElYSS5kZWZhdWx0U2hhZGVyLnByb2plY3Rpb25WZWN0b3IsIHNpemVYLzIsIC1zaXplWS8yKTsKICAgIGdsLnVuaWZvcm0yZihQSVhJLmRlZmF1bHRTaGFkZXIub2Zmc2V0VmVjdG9yLCAtb2Zmc2V0WCwgLW9mZnNldFkpOwoKICAgIC8vIHJldHVybiB0aGUgdGV4dHVyZSB0byB0aGUgcG9vbAogICAgdGhpcy50ZXh0dXJlUG9vbC5wdXNoKHRleHR1cmUpOwogICAgZmlsdGVyQmxvY2suX2dsRmlsdGVyVGV4dHVyZSA9IG51bGw7Cn07CgpQSVhJLldlYkdMRmlsdGVyTWFuYWdlci5wcm90b3R5cGUuYXBwbHlGaWx0ZXJQYXNzID0gZnVuY3Rpb24oZmlsdGVyLCBmaWx0ZXJBcmVhLCB3aWR0aCwgaGVpZ2h0KQp7CiAgICAvLyB1c2UgcHJvZ3JhbQogICAgdmFyIGdsID0gUElYSS5nbDsKICAgIHZhciBzaGFkZXIgPSBmaWx0ZXIuc2hhZGVyOwoKICAgIGlmKCFzaGFkZXIpCiAgICB7CiAgICAgICAgc2hhZGVyID0gbmV3IFBJWEkuUGl4aVNoYWRlcigpOwoKICAgICAgICBzaGFkZXIuZnJhZ21lbnRTcmMgPSBmaWx0ZXIuZnJhZ21lbnRTcmM7CiAgICAgICAgc2hhZGVyLnVuaWZvcm1zID0gZmlsdGVyLnVuaWZvcm1zOwogICAgICAgIHNoYWRlci5pbml0KCk7CgogICAgICAgIGZpbHRlci5zaGFkZXIgPSBzaGFkZXI7CiAgICB9CgogICAgLy8gc2V0IHRoZSBzaGFkZXIKICAgIGdsLnVzZVByb2dyYW0oc2hhZGVyLnByb2dyYW0pOwoKICAgIGdsLnVuaWZvcm0yZihzaGFkZXIucHJvamVjdGlvblZlY3Rvciwgd2lkdGgvMiwgLWhlaWdodC8yKTsKICAgIGdsLnVuaWZvcm0yZihzaGFkZXIub2Zmc2V0VmVjdG9yLCAwLDApOwoKICAgIGlmKGZpbHRlci51bmlmb3Jtcy5kaW1lbnNpb25zKQogICAgewogICAgICAgIGZpbHRlci51bmlmb3Jtcy5kaW1lbnNpb25zLnZhbHVlWzBdID0gdGhpcy53aWR0aDsvL3dpZHRoOwogICAgICAgIGZpbHRlci51bmlmb3Jtcy5kaW1lbnNpb25zLnZhbHVlWzFdID0gdGhpcy5oZWlnaHQ7Ly9oZWlnaHQ7CiAgICAgICAgZmlsdGVyLnVuaWZvcm1zLmRpbWVuc2lvbnMudmFsdWVbMl0gPSB0aGlzLnZlcnRleEFycmF5WzBdOwogICAgICAgIGZpbHRlci51bmlmb3Jtcy5kaW1lbnNpb25zLnZhbHVlWzNdID0gdGhpcy52ZXJ0ZXhBcnJheVs1XTsvL2ZpbHRlckFyZWEuaGVpZ2h0OwogICAgfQoKICAgIHNoYWRlci5zeW5jVW5pZm9ybXMoKTsKCiAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy52ZXJ0ZXhCdWZmZXIpOwogICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXIuYVZlcnRleFBvc2l0aW9uLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwoKICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnV2QnVmZmVyKTsKICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmFUZXh0dXJlQ29vcmQsIDIsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgogICAgZ2wuYmluZEJ1ZmZlcihnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgdGhpcy5pbmRleEJ1ZmZlcik7CgogICAgLy8gZHJhdyB0aGUgZmlsdGVyLi4uCiAgICBnbC5kcmF3RWxlbWVudHMoZ2wuVFJJQU5HTEVTLCA2LCBnbC5VTlNJR05FRF9TSE9SVCwgMCApOwp9OwoKUElYSS5XZWJHTEZpbHRlck1hbmFnZXIucHJvdG90eXBlLmluaXRTaGFkZXJCdWZmZXJzID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIC8vIGNyZWF0ZSBzb21lIGJ1ZmZlcnMKICAgIHRoaXMudmVydGV4QnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CiAgICB0aGlzLnV2QnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CiAgICB0aGlzLmluZGV4QnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CgogICAgLy8gYmluZCBhbmQgdXBsb2FkIHRoZSB2ZXJ0ZXhzLi4KICAgIC8vIGtlZXAgYSByZWZmZXJhbmNlIHRvIHRoZSB2ZXJ0ZXhGbG9hdERhdGEuLgogICAgdGhpcy52ZXJ0ZXhBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoWzAuMCwgMC4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEuMCwgMC4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAuMCwgMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEuMCwgMS4wXSk7CgogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudmVydGV4QnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoCiAgICBnbC5BUlJBWV9CVUZGRVIsCiAgICB0aGlzLnZlcnRleEFycmF5LAogICAgZ2wuU1RBVElDX0RSQVcpOwoKCiAgICAvLyBiaW5kIGFuZCB1cGxvYWQgdGhlIHV2IGJ1ZmZlcgogICAgdGhpcy51dkFycmF5ID0gbmV3IEZsb2F0MzJBcnJheShbMC4wLCAwLjAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxLjAsIDAuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAuMCwgMS4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMS4wLCAxLjBdKTsKCiAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy51dkJ1ZmZlcik7CiAgICBnbC5idWZmZXJEYXRhKAogICAgZ2wuQVJSQVlfQlVGRkVSLAogICAgdGhpcy51dkFycmF5LAogICAgZ2wuU1RBVElDX0RSQVcpOwoKICAgIC8vIGJpbmQgYW5kIHVwbG9hZCB0aGUgaW5kZXgKICAgIGdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHRoaXMuaW5kZXhCdWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YSgKICAgIGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLAogICAgbmV3IFVpbnQxNkFycmF5KFswLCAxLCAyLCAxLCAzLCAyXSksCiAgICBnbC5TVEFUSUNfRFJBVyk7Cn07CgpQSVhJLldlYkdMRmlsdGVyTWFuYWdlci5wcm90b3R5cGUuZ2V0Qm91bmRzID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCkKewogICAgLy8gdGltZSB0byBnZXQgdGhlIHdpZHRoIGFuZCBoZWlnaHQgb2YgdGhlIG9iamVjdCEKICAgIHZhciB3b3JsZFRyYW5zZm9ybSwgd2lkdGgsIGhlaWdodCwgYVgsIGFZLCB3MCwgdzEsIGgwLCBoMSwgZG9UZXN0OwogICAgdmFyIGEsIGIsIGMsIGQsIHR4LCB0eSwgeDEsIHgyLCB4MywgeDQsIHkxLCB5MiwgeTMsIHk0OwoKICAgIHZhciB0ZW1wT2JqZWN0ID0gZGlzcGxheU9iamVjdC5maXJzdDsKICAgIHZhciB0ZXN0T2JqZWN0ID0gZGlzcGxheU9iamVjdC5sYXN0Ll9pTmV4dDsKCiAgICB2YXIgbWF4WCA9IC1JbmZpbml0eTsKICAgIHZhciBtYXhZID0gLUluZmluaXR5OwoKICAgIHZhciBtaW5YID0gSW5maW5pdHk7CiAgICB2YXIgbWluWSA9IEluZmluaXR5OwoKICAgIGRvCiAgICB7CiAgICAgICAgLy8gVE9ETyBjYW4gYmUgb3B0aW1pemVkISAtIHdoYXQgaWYgdGhlcmUgaXMgbm8gc2NhbGUgLyByb3RhdGlvbj8KCiAgICAgICAgaWYodGVtcE9iamVjdC52aXNpYmxlKQogICAgICAgIHsKICAgICAgICAgICAgaWYodGVtcE9iamVjdCBpbnN0YW5jZW9mIFBJWEkuU3ByaXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3aWR0aCA9IHRlbXBPYmplY3QudGV4dHVyZS5mcmFtZS53aWR0aDsKICAgICAgICAgICAgICAgIGhlaWdodCA9IHRlbXBPYmplY3QudGV4dHVyZS5mcmFtZS5oZWlnaHQ7CgogICAgICAgICAgICAgICAgLy8gVE9ETyB0cmltPz8KICAgICAgICAgICAgICAgIGFYID0gdGVtcE9iamVjdC5hbmNob3IueDsKICAgICAgICAgICAgICAgIGFZID0gdGVtcE9iamVjdC5hbmNob3IueTsKICAgICAgICAgICAgICAgIHcwID0gd2lkdGggKiAoMS1hWCk7CiAgICAgICAgICAgICAgICB3MSA9IHdpZHRoICogLWFYOwoKICAgICAgICAgICAgICAgIGgwID0gaGVpZ2h0ICogKDEtYVkpOwogICAgICAgICAgICAgICAgaDEgPSBoZWlnaHQgKiAtYVk7CgogICAgICAgICAgICAgICAgZG9UZXN0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmKHRlbXBPYmplY3QgaW5zdGFuY2VvZiBQSVhJLkdyYXBoaWNzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0ZW1wT2JqZWN0LnVwZGF0ZUZpbHRlckJvdW5kcygpOwoKICAgICAgICAgICAgICAgIHZhciBib3VuZHMgPSB0ZW1wT2JqZWN0LmJvdW5kczsKCiAgICAgICAgICAgICAgICB3aWR0aCA9IGJvdW5kcy53aWR0aDsKICAgICAgICAgICAgICAgIGhlaWdodCA9IGJvdW5kcy5oZWlnaHQ7CgogICAgICAgICAgICAgICAgdzAgPSBib3VuZHMueDsKICAgICAgICAgICAgICAgIHcxID0gYm91bmRzLnggKyBib3VuZHMud2lkdGg7CgogICAgICAgICAgICAgICAgaDAgPSBib3VuZHMueTsKICAgICAgICAgICAgICAgIGgxID0gYm91bmRzLnkgKyBib3VuZHMuaGVpZ2h0OwoKICAgICAgICAgICAgICAgIGRvVGVzdCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmKGRvVGVzdCkKICAgICAgICB7CiAgICAgICAgICAgIHdvcmxkVHJhbnNmb3JtID0gdGVtcE9iamVjdC53b3JsZFRyYW5zZm9ybTsKCiAgICAgICAgICAgIGEgPSB3b3JsZFRyYW5zZm9ybVswXTsKICAgICAgICAgICAgYiA9IHdvcmxkVHJhbnNmb3JtWzNdOwogICAgICAgICAgICBjID0gd29ybGRUcmFuc2Zvcm1bMV07CiAgICAgICAgICAgIGQgPSB3b3JsZFRyYW5zZm9ybVs0XTsKICAgICAgICAgICAgdHggPSB3b3JsZFRyYW5zZm9ybVsyXTsKICAgICAgICAgICAgdHkgPSB3b3JsZFRyYW5zZm9ybVs1XTsKCiAgICAgICAgICAgIHgxID0gYSAqIHcxICsgYyAqIGgxICsgdHg7CiAgICAgICAgICAgIHkxID0gZCAqIGgxICsgYiAqIHcxICsgdHk7CgogICAgICAgICAgICB4MiA9IGEgKiB3MCArIGMgKiBoMSArIHR4OwogICAgICAgICAgICB5MiA9IGQgKiBoMSArIGIgKiB3MCArIHR5OwoKICAgICAgICAgICAgeDMgPSBhICogdzAgKyBjICogaDAgKyB0eDsKICAgICAgICAgICAgeTMgPSBkICogaDAgKyBiICogdzAgKyB0eTsKCiAgICAgICAgICAgIHg0ID0gIGEgKiB3MSArIGMgKiBoMCArIHR4OwogICAgICAgICAgICB5NCA9ICBkICogaDAgKyBiICogdzEgKyB0eTsKCiAgICAgICAgICAgIG1pblggPSB4MSA8IG1pblggPyB4MSA6IG1pblg7CiAgICAgICAgICAgIG1pblggPSB4MiA8IG1pblggPyB4MiA6IG1pblg7CiAgICAgICAgICAgIG1pblggPSB4MyA8IG1pblggPyB4MyA6IG1pblg7CiAgICAgICAgICAgIG1pblggPSB4NCA8IG1pblggPyB4NCA6IG1pblg7CgogICAgICAgICAgICBtaW5ZID0geTEgPCBtaW5ZID8geTEgOiBtaW5ZOwogICAgICAgICAgICBtaW5ZID0geTIgPCBtaW5ZID8geTIgOiBtaW5ZOwogICAgICAgICAgICBtaW5ZID0geTMgPCBtaW5ZID8geTMgOiBtaW5ZOwogICAgICAgICAgICBtaW5ZID0geTQgPCBtaW5ZID8geTQgOiBtaW5ZOwoKICAgICAgICAgICAgbWF4WCA9IHgxID4gbWF4WCA/IHgxIDogbWF4WDsKICAgICAgICAgICAgbWF4WCA9IHgyID4gbWF4WCA/IHgyIDogbWF4WDsKICAgICAgICAgICAgbWF4WCA9IHgzID4gbWF4WCA/IHgzIDogbWF4WDsKICAgICAgICAgICAgbWF4WCA9IHg0ID4gbWF4WCA/IHg0IDogbWF4WDsKCiAgICAgICAgICAgIG1heFkgPSB5MSA+IG1heFkgPyB5MSA6IG1heFk7CiAgICAgICAgICAgIG1heFkgPSB5MiA+IG1heFkgPyB5MiA6IG1heFk7CiAgICAgICAgICAgIG1heFkgPSB5MyA+IG1heFkgPyB5MyA6IG1heFk7CiAgICAgICAgICAgIG1heFkgPSB5NCA+IG1heFkgPyB5NCA6IG1heFk7CiAgICAgICAgfQoKICAgICAgICBkb1Rlc3QgPSBmYWxzZTsKICAgICAgICB0ZW1wT2JqZWN0ID0gdGVtcE9iamVjdC5faU5leHQ7CgogICAgfQogICAgd2hpbGUodGVtcE9iamVjdCAhPT0gdGVzdE9iamVjdCk7CgogICAgZGlzcGxheU9iamVjdC5maWx0ZXJBcmVhLnggPSBtaW5YOwogICAgZGlzcGxheU9iamVjdC5maWx0ZXJBcmVhLnkgPSBtaW5ZOwoKICAgIGRpc3BsYXlPYmplY3QuZmlsdGVyQXJlYS53aWR0aCA9IG1heFggLSBtaW5YOwogICAgZGlzcGxheU9iamVjdC5maWx0ZXJBcmVhLmhlaWdodCA9IG1heFkgLSBtaW5ZOwp9OwoKUElYSS5GaWx0ZXJUZXh0dXJlID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkKewogICAgdmFyIGdsID0gUElYSS5nbDsKCiAgICAvLyBuZXh0IHRpbWUgdG8gY3JlYXRlIGEgZnJhbWUgYnVmZmVyIGFuZCB0ZXh0dXJlCiAgICB0aGlzLmZyYW1lQnVmZmVyID0gZ2wuY3JlYXRlRnJhbWVidWZmZXIoKTsKICAgIHRoaXMudGV4dHVyZSA9IGdsLmNyZWF0ZVRleHR1cmUoKTsKCiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCAgdGhpcy50ZXh0dXJlKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NQUdfRklMVEVSLCBnbC5MSU5FQVIpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01JTl9GSUxURVIsIGdsLkxJTkVBUik7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9TLCBnbC5DTEFNUF9UT19FREdFKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1QsIGdsLkNMQU1QX1RPX0VER0UpOwogICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0aGlzLmZyYW1lYnVmZmVyICk7CgogICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0aGlzLmZyYW1lQnVmZmVyICk7CiAgICBnbC5mcmFtZWJ1ZmZlclRleHR1cmUyRChnbC5GUkFNRUJVRkZFUiwgZ2wuQ09MT1JfQVRUQUNITUVOVDAsIGdsLlRFWFRVUkVfMkQsIHRoaXMudGV4dHVyZSwgMCk7CgogICAgdGhpcy5yZXNpemUod2lkdGgsIGhlaWdodCk7Cn07CgpQSVhJLkZpbHRlclRleHR1cmUucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCnsKICAgIGlmKHRoaXMud2lkdGggPT09IHdpZHRoICYmIHRoaXMuaGVpZ2h0ID09PSBoZWlnaHQpIHJldHVybjsKCiAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKCiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsICB0aGlzLnRleHR1cmUpOwogICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCAgd2lkdGgsIGhlaWdodCwgMCwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgbnVsbCk7Cgp9OwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiBBIHNldCBvZiBmdW5jdGlvbnMgdXNlZCBieSB0aGUgd2ViR0wgcmVuZGVyZXIgdG8gZHJhdyB0aGUgcHJpbWl0aXZlIGdyYXBoaWNzIGRhdGEKICoKICogQGNsYXNzIENhbnZhc0dyYXBoaWNzCiAqLwpQSVhJLldlYkdMR3JhcGhpY3MgPSBmdW5jdGlvbigpCnsKCn07CgovKioKICogUmVuZGVycyB0aGUgZ3JhcGhpY3Mgb2JqZWN0CiAqCiAqIEBzdGF0aWMKICogQHByaXZhdGUKICogQG1ldGhvZCByZW5kZXJHcmFwaGljcwogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKiBAcGFyYW0gcHJvamVjdGlvbiB7T2JqZWN0fQogKi8KUElYSS5XZWJHTEdyYXBoaWNzLnJlbmRlckdyYXBoaWNzID0gZnVuY3Rpb24oZ3JhcGhpY3MsIHByb2plY3Rpb24pCnsKICAgIHZhciBnbCA9IFBJWEkuZ2w7CgogICAgaWYoIWdyYXBoaWNzLl93ZWJHTClncmFwaGljcy5fd2ViR0wgPSB7cG9pbnRzOltdLCBpbmRpY2VzOltdLCBsYXN0SW5kZXg6MCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlcjpnbC5jcmVhdGVCdWZmZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4QnVmZmVyOmdsLmNyZWF0ZUJ1ZmZlcigpfTsKCiAgICBpZihncmFwaGljcy5kaXJ0eSkKICAgIHsKICAgICAgICBncmFwaGljcy5kaXJ0eSA9IGZhbHNlOwoKICAgICAgICBpZihncmFwaGljcy5jbGVhckRpcnR5KQogICAgICAgIHsKICAgICAgICAgICAgZ3JhcGhpY3MuY2xlYXJEaXJ0eSA9IGZhbHNlOwoKICAgICAgICAgICAgZ3JhcGhpY3MuX3dlYkdMLmxhc3RJbmRleCA9IDA7CiAgICAgICAgICAgIGdyYXBoaWNzLl93ZWJHTC5wb2ludHMgPSBbXTsKICAgICAgICAgICAgZ3JhcGhpY3MuX3dlYkdMLmluZGljZXMgPSBbXTsKCiAgICAgICAgfQoKICAgICAgICBQSVhJLldlYkdMR3JhcGhpY3MudXBkYXRlR3JhcGhpY3MoZ3JhcGhpY3MpOwogICAgfQoKICAgIFBJWEkuYWN0aXZhdGVQcmltaXRpdmVTaGFkZXIoKTsKCiAgICAvLyBUaGlzICBjb3VsZCBiZSBzcGVlZGVkIHVwIGZvIHN1cmUhCiAgICB2YXIgbSA9IFBJWEkubWF0My5jbG9uZShncmFwaGljcy53b3JsZFRyYW5zZm9ybSk7CgogICAgUElYSS5tYXQzLnRyYW5zcG9zZShtKTsKCiAgICAvLyBzZXQgdGhlIG1hdHJpeCB0cmFuc2Zvcm0gZm9yIHRoZQogICAgZ2wuYmxlbmRGdW5jKGdsLk9ORSwgZ2wuT05FX01JTlVTX1NSQ19BTFBIQSk7CgogICAgZ2wudW5pZm9ybU1hdHJpeDNmdihQSVhJLnByaW1pdGl2ZVNoYWRlci50cmFuc2xhdGlvbk1hdHJpeCwgZmFsc2UsIG0pOwoKICAgIGdsLnVuaWZvcm0yZihQSVhJLnByaW1pdGl2ZVNoYWRlci5wcm9qZWN0aW9uVmVjdG9yLCBwcm9qZWN0aW9uLngsIC1wcm9qZWN0aW9uLnkpOwogICAgZ2wudW5pZm9ybTJmKFBJWEkucHJpbWl0aXZlU2hhZGVyLm9mZnNldFZlY3RvciwgLVBJWEkub2Zmc2V0LngsIC1QSVhJLm9mZnNldC55KTsKCiAgICBnbC51bmlmb3JtMWYoUElYSS5wcmltaXRpdmVTaGFkZXIuYWxwaGEsIGdyYXBoaWNzLndvcmxkQWxwaGEpOwogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIGdyYXBoaWNzLl93ZWJHTC5idWZmZXIpOwoKICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoUElYSS5wcmltaXRpdmVTaGFkZXIuYVZlcnRleFBvc2l0aW9uLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDQgKiA2LCAwKTsKICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoUElYSS5wcmltaXRpdmVTaGFkZXIuY29sb3JBdHRyaWJ1dGUsIDQsIGdsLkZMT0FULCBmYWxzZSw0ICogNiwgMiAqIDQpOwoKICAgIC8vIHNldCB0aGUgaW5kZXggYnVmZmVyIQogICAgZ2wuYmluZEJ1ZmZlcihnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgZ3JhcGhpY3MuX3dlYkdMLmluZGV4QnVmZmVyKTsKCgogICAgZ2wuZHJhd0VsZW1lbnRzKGdsLlRSSUFOR0xFX1NUUklQLCAgZ3JhcGhpY3MuX3dlYkdMLmluZGljZXMubGVuZ3RoLCBnbC5VTlNJR05FRF9TSE9SVCwgMCApOwoKICAgIFBJWEkuZGVhY3RpdmF0ZVByaW1pdGl2ZVNoYWRlcigpOwoKICAgIC8vIHJldHVybiB0byBkZWZhdWx0IHNoYWRlci4uLgovLyAgUElYSS5hY3RpdmF0ZVNoYWRlcihQSVhJLmRlZmF1bHRTaGFkZXIpOwp9OwoKLyoqCiAqIFVwZGF0ZXMgdGhlIGdyYXBoaWNzIG9iamVjdAogKgogKiBAc3RhdGljCiAqIEBwcml2YXRlCiAqIEBtZXRob2QgdXBkYXRlR3JhcGhpY3MKICogQHBhcmFtIGdyYXBoaWNzIHtHcmFwaGljc30KICovClBJWEkuV2ViR0xHcmFwaGljcy51cGRhdGVHcmFwaGljcyA9IGZ1bmN0aW9uKGdyYXBoaWNzKQp7CiAgICBmb3IgKHZhciBpID0gZ3JhcGhpY3MuX3dlYkdMLmxhc3RJbmRleDsgaSA8IGdyYXBoaWNzLmdyYXBoaWNzRGF0YS5sZW5ndGg7IGkrKykKICAgIHsKICAgICAgICB2YXIgZGF0YSA9IGdyYXBoaWNzLmdyYXBoaWNzRGF0YVtpXTsKCiAgICAgICAgaWYoZGF0YS50eXBlID09PSBQSVhJLkdyYXBoaWNzLlBPTFkpCiAgICAgICAgewogICAgICAgICAgICBpZihkYXRhLmZpbGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmKGRhdGEucG9pbnRzLmxlbmd0aD4zKQogICAgICAgICAgICAgICAgICAgIFBJWEkuV2ViR0xHcmFwaGljcy5idWlsZFBvbHkoZGF0YSwgZ3JhcGhpY3MuX3dlYkdMKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoZGF0YS5saW5lV2lkdGggPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRMaW5lKGRhdGEsIGdyYXBoaWNzLl93ZWJHTCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZihkYXRhLnR5cGUgPT09IFBJWEkuR3JhcGhpY3MuUkVDVCkKICAgICAgICB7CiAgICAgICAgICAgIFBJWEkuV2ViR0xHcmFwaGljcy5idWlsZFJlY3RhbmdsZShkYXRhLCBncmFwaGljcy5fd2ViR0wpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmKGRhdGEudHlwZSA9PT0gUElYSS5HcmFwaGljcy5DSVJDIHx8IGRhdGEudHlwZSA9PT0gUElYSS5HcmFwaGljcy5FTElQKQogICAgICAgIHsKICAgICAgICAgICAgUElYSS5XZWJHTEdyYXBoaWNzLmJ1aWxkQ2lyY2xlKGRhdGEsIGdyYXBoaWNzLl93ZWJHTCk7CiAgICAgICAgfQogICAgfQoKICAgIGdyYXBoaWNzLl93ZWJHTC5sYXN0SW5kZXggPSBncmFwaGljcy5ncmFwaGljc0RhdGEubGVuZ3RoOwoKICAgIHZhciBnbCA9IFBJWEkuZ2w7CgogICAgZ3JhcGhpY3MuX3dlYkdMLmdsUG9pbnRzID0gbmV3IEZsb2F0MzJBcnJheShncmFwaGljcy5fd2ViR0wucG9pbnRzKTsKCiAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgZ3JhcGhpY3MuX3dlYkdMLmJ1ZmZlcik7CiAgICBnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgZ3JhcGhpY3MuX3dlYkdMLmdsUG9pbnRzLCBnbC5TVEFUSUNfRFJBVyk7CgogICAgZ3JhcGhpY3MuX3dlYkdMLmdsSW5kaWNpZXMgPSBuZXcgVWludDE2QXJyYXkoZ3JhcGhpY3MuX3dlYkdMLmluZGljZXMpOwoKICAgIGdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIGdyYXBoaWNzLl93ZWJHTC5pbmRleEJ1ZmZlcik7CiAgICBnbC5idWZmZXJEYXRhKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBncmFwaGljcy5fd2ViR0wuZ2xJbmRpY2llcywgZ2wuU1RBVElDX0RSQVcpOwp9OwoKLyoqCiAqIEJ1aWxkcyBhIHJlY3RhbmdsZSB0byBkcmF3CiAqCiAqIEBzdGF0aWMKICogQHByaXZhdGUKICogQG1ldGhvZCBidWlsZFJlY3RhbmdsZQogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKiBAcGFyYW0gd2ViR0xEYXRhIHtPYmplY3R9CiAqLwpQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRSZWN0YW5nbGUgPSBmdW5jdGlvbihncmFwaGljc0RhdGEsIHdlYkdMRGF0YSkKewogICAgLy8gLS0tIC8vCiAgICAvLyBuZWVkIHRvIGNvbnZlcnQgcG9pbnRzIHRvIGEgbmljZSByZWd1bGFyIGRhdGEKICAgIC8vCiAgICB2YXIgcmVjdERhdGEgPSBncmFwaGljc0RhdGEucG9pbnRzOwogICAgdmFyIHggPSByZWN0RGF0YVswXTsKICAgIHZhciB5ID0gcmVjdERhdGFbMV07CiAgICB2YXIgd2lkdGggPSByZWN0RGF0YVsyXTsKICAgIHZhciBoZWlnaHQgPSByZWN0RGF0YVszXTsKCgogICAgaWYoZ3JhcGhpY3NEYXRhLmZpbGwpCiAgICB7CiAgICAgICAgdmFyIGNvbG9yID0gUElYSS5oZXgycmdiKGdyYXBoaWNzRGF0YS5maWxsQ29sb3IpOwogICAgICAgIHZhciBhbHBoYSA9IGdyYXBoaWNzRGF0YS5maWxsQWxwaGE7CgogICAgICAgIHZhciByID0gY29sb3JbMF0gKiBhbHBoYTsKICAgICAgICB2YXIgZyA9IGNvbG9yWzFdICogYWxwaGE7CiAgICAgICAgdmFyIGIgPSBjb2xvclsyXSAqIGFscGhhOwoKICAgICAgICB2YXIgdmVydHMgPSB3ZWJHTERhdGEucG9pbnRzOwogICAgICAgIHZhciBpbmRpY2VzID0gd2ViR0xEYXRhLmluZGljZXM7CgogICAgICAgIHZhciB2ZXJ0UG9zID0gdmVydHMubGVuZ3RoLzY7CgogICAgICAgIC8vIHN0YXJ0CiAgICAgICAgdmVydHMucHVzaCh4LCB5KTsKICAgICAgICB2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCiAgICAgICAgdmVydHMucHVzaCh4ICsgd2lkdGgsIHkpOwogICAgICAgIHZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoKICAgICAgICB2ZXJ0cy5wdXNoKHggLCB5ICsgaGVpZ2h0KTsKICAgICAgICB2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCiAgICAgICAgdmVydHMucHVzaCh4ICsgd2lkdGgsIHkgKyBoZWlnaHQpOwogICAgICAgIHZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoKICAgICAgICAvLyBpbnNlcnQgMiBkZWFkIHRyaWFuZ2xlcy4uCiAgICAgICAgaW5kaWNlcy5wdXNoKHZlcnRQb3MsIHZlcnRQb3MsIHZlcnRQb3MrMSwgdmVydFBvcysyLCB2ZXJ0UG9zKzMsIHZlcnRQb3MrMyk7CiAgICB9CgogICAgaWYoZ3JhcGhpY3NEYXRhLmxpbmVXaWR0aCkKICAgIHsKICAgICAgICBncmFwaGljc0RhdGEucG9pbnRzID0gW3gsIHksCiAgICAgICAgICAgICAgICAgIHggKyB3aWR0aCwgeSwKICAgICAgICAgICAgICAgICAgeCArIHdpZHRoLCB5ICsgaGVpZ2h0LAogICAgICAgICAgICAgICAgICB4LCB5ICsgaGVpZ2h0LAogICAgICAgICAgICAgICAgICB4LCB5XTsKCiAgICAgICAgUElYSS5XZWJHTEdyYXBoaWNzLmJ1aWxkTGluZShncmFwaGljc0RhdGEsIHdlYkdMRGF0YSk7CiAgICB9Cn07CgovKioKICogQnVpbGRzIGEgY2lyY2xlIHRvIGRyYXcKICoKICogQHN0YXRpYwogKiBAcHJpdmF0ZQogKiBAbWV0aG9kIGJ1aWxkQ2lyY2xlCiAqIEBwYXJhbSBncmFwaGljcyB7R3JhcGhpY3N9CiAqIEBwYXJhbSB3ZWJHTERhdGEge09iamVjdH0KICovClBJWEkuV2ViR0xHcmFwaGljcy5idWlsZENpcmNsZSA9IGZ1bmN0aW9uKGdyYXBoaWNzRGF0YSwgd2ViR0xEYXRhKQp7CiAgICAvLyAtLS0gLy8KICAgIC8vIG5lZWQgdG8gY29udmVydCBwb2ludHMgdG8gYSBuaWNlIHJlZ3VsYXIgZGF0YQogICAgLy8KICAgIHZhciByZWN0RGF0YSA9IGdyYXBoaWNzRGF0YS5wb2ludHM7CiAgICB2YXIgeCA9IHJlY3REYXRhWzBdOwogICAgdmFyIHkgPSByZWN0RGF0YVsxXTsKICAgIHZhciB3aWR0aCA9IHJlY3REYXRhWzJdOwogICAgdmFyIGhlaWdodCA9IHJlY3REYXRhWzNdOwoKICAgIHZhciB0b3RhbFNlZ3MgPSA0MDsKICAgIHZhciBzZWcgPSAoTWF0aC5QSSAqIDIpIC8gdG90YWxTZWdzIDsKCiAgICB2YXIgaSA9IDA7CgogICAgaWYoZ3JhcGhpY3NEYXRhLmZpbGwpCiAgICB7CiAgICAgICAgdmFyIGNvbG9yID0gUElYSS5oZXgycmdiKGdyYXBoaWNzRGF0YS5maWxsQ29sb3IpOwogICAgICAgIHZhciBhbHBoYSA9IGdyYXBoaWNzRGF0YS5maWxsQWxwaGE7CgogICAgICAgIHZhciByID0gY29sb3JbMF0gKiBhbHBoYTsKICAgICAgICB2YXIgZyA9IGNvbG9yWzFdICogYWxwaGE7CiAgICAgICAgdmFyIGIgPSBjb2xvclsyXSAqIGFscGhhOwoKICAgICAgICB2YXIgdmVydHMgPSB3ZWJHTERhdGEucG9pbnRzOwogICAgICAgIHZhciBpbmRpY2VzID0gd2ViR0xEYXRhLmluZGljZXM7CgogICAgICAgIHZhciB2ZWNQb3MgPSB2ZXJ0cy5sZW5ndGgvNjsKCiAgICAgICAgaW5kaWNlcy5wdXNoKHZlY1Bvcyk7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCB0b3RhbFNlZ3MgKyAxIDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdmVydHMucHVzaCh4LHksIHIsIGcsIGIsIGFscGhhKTsKCiAgICAgICAgICAgIHZlcnRzLnB1c2goeCArIE1hdGguc2luKHNlZyAqIGkpICogd2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgeSArIE1hdGguY29zKHNlZyAqIGkpICogaGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICAgIHIsIGcsIGIsIGFscGhhKTsKCiAgICAgICAgICAgIGluZGljZXMucHVzaCh2ZWNQb3MrKywgdmVjUG9zKyspOwogICAgICAgIH0KCiAgICAgICAgaW5kaWNlcy5wdXNoKHZlY1Bvcy0xKTsKICAgIH0KCiAgICBpZihncmFwaGljc0RhdGEubGluZVdpZHRoKQogICAgewogICAgICAgIGdyYXBoaWNzRGF0YS5wb2ludHMgPSBbXTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRvdGFsU2VncyArIDE7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGdyYXBoaWNzRGF0YS5wb2ludHMucHVzaCh4ICsgTWF0aC5zaW4oc2VnICogaSkgKiB3aWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHkgKyBNYXRoLmNvcyhzZWcgKiBpKSAqIGhlaWdodCk7CiAgICAgICAgfQoKICAgICAgICBQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRMaW5lKGdyYXBoaWNzRGF0YSwgd2ViR0xEYXRhKTsKICAgIH0KfTsKCi8qKgogKiBCdWlsZHMgYSBsaW5lIHRvIGRyYXcKICoKICogQHN0YXRpYwogKiBAcHJpdmF0ZQogKiBAbWV0aG9kIGJ1aWxkTGluZQogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKiBAcGFyYW0gd2ViR0xEYXRhIHtPYmplY3R9CiAqLwpQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRMaW5lID0gZnVuY3Rpb24oZ3JhcGhpY3NEYXRhLCB3ZWJHTERhdGEpCnsKICAgIC8vIFRPRE8gT1BUSU1JU0UhCiAgICB2YXIgaSA9IDA7CgogICAgdmFyIHBvaW50cyA9IGdyYXBoaWNzRGF0YS5wb2ludHM7CiAgICBpZihwb2ludHMubGVuZ3RoID09PSAwKXJldHVybjsKCiAgICAvLyBpZiB0aGUgbGluZSB3aWR0aCBpcyBhbiBvZGQgbnVtYmVyIGFkZCAwLjUgdG8gYWxpZ24gdG8gYSB3aG9sZSBwaXhlbAogICAgaWYoZ3JhcGhpY3NEYXRhLmxpbmVXaWR0aCUyKQogICAgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb2ludHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcG9pbnRzW2ldICs9IDAuNTsKICAgICAgICB9CiAgICB9CgogICAgLy8gZ2V0IGZpcnN0IGFuZCBsYXN0IHBvaW50Li4gZmlndXJlIG91dCB0aGUgbWlkZGxlIQogICAgdmFyIGZpcnN0UG9pbnQgPSBuZXcgUElYSS5Qb2ludCggcG9pbnRzWzBdLCBwb2ludHNbMV0gKTsKICAgIHZhciBsYXN0UG9pbnQgPSBuZXcgUElYSS5Qb2ludCggcG9pbnRzW3BvaW50cy5sZW5ndGggLSAyXSwgcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXSApOwoKICAgIC8vIGlmIHRoZSBmaXJzdCBwb2ludCBpcyB0aGUgbGFzdCBwb2ludCAtIGdvb25hIGhhdmUgaXNzdWVzIDopCiAgICBpZihmaXJzdFBvaW50LnggPT09IGxhc3RQb2ludC54ICYmIGZpcnN0UG9pbnQueSA9PT0gbGFzdFBvaW50LnkpCiAgICB7CiAgICAgICAgcG9pbnRzLnBvcCgpOwogICAgICAgIHBvaW50cy5wb3AoKTsKCiAgICAgICAgbGFzdFBvaW50ID0gbmV3IFBJWEkuUG9pbnQoIHBvaW50c1twb2ludHMubGVuZ3RoIC0gMl0sIHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV0gKTsKCiAgICAgICAgdmFyIG1pZFBvaW50WCA9IGxhc3RQb2ludC54ICsgKGZpcnN0UG9pbnQueCAtIGxhc3RQb2ludC54KSAqMC41OwogICAgICAgIHZhciBtaWRQb2ludFkgPSBsYXN0UG9pbnQueSArIChmaXJzdFBvaW50LnkgLSBsYXN0UG9pbnQueSkgKjAuNTsKCiAgICAgICAgcG9pbnRzLnVuc2hpZnQobWlkUG9pbnRYLCBtaWRQb2ludFkpOwogICAgICAgIHBvaW50cy5wdXNoKG1pZFBvaW50WCwgbWlkUG9pbnRZKTsKICAgIH0KCiAgICB2YXIgdmVydHMgPSB3ZWJHTERhdGEucG9pbnRzOwogICAgdmFyIGluZGljZXMgPSB3ZWJHTERhdGEuaW5kaWNlczsKICAgIHZhciBsZW5ndGggPSBwb2ludHMubGVuZ3RoIC8gMjsKICAgIHZhciBpbmRleENvdW50ID0gcG9pbnRzLmxlbmd0aDsKICAgIHZhciBpbmRleFN0YXJ0ID0gdmVydHMubGVuZ3RoLzY7CgogICAgLy8gRFJBVyB0aGUgTGluZQogICAgdmFyIHdpZHRoID0gZ3JhcGhpY3NEYXRhLmxpbmVXaWR0aCAvIDI7CgogICAgLy8gc29ydCBjb2xvcgogICAgdmFyIGNvbG9yID0gUElYSS5oZXgycmdiKGdyYXBoaWNzRGF0YS5saW5lQ29sb3IpOwogICAgdmFyIGFscGhhID0gZ3JhcGhpY3NEYXRhLmxpbmVBbHBoYTsKICAgIHZhciByID0gY29sb3JbMF0gKiBhbHBoYTsKICAgIHZhciBnID0gY29sb3JbMV0gKiBhbHBoYTsKICAgIHZhciBiID0gY29sb3JbMl0gKiBhbHBoYTsKCiAgICB2YXIgcHgsIHB5LCBwMXgsIHAxeSwgcDJ4LCBwMnksIHAzeCwgcDN5OwogICAgdmFyIHBlcnB4LCBwZXJweSwgcGVycDJ4LCBwZXJwMnksIHBlcnAzeCwgcGVycDN5OwogICAgdmFyIGExLCBiMSwgYzEsIGEyLCBiMiwgYzI7CiAgICB2YXIgZGVub20sIHBkaXN0LCBkaXN0OwoKICAgIHAxeCA9IHBvaW50c1swXTsKICAgIHAxeSA9IHBvaW50c1sxXTsKCiAgICBwMnggPSBwb2ludHNbMl07CiAgICBwMnkgPSBwb2ludHNbM107CgogICAgcGVycHggPSAtKHAxeSAtIHAyeSk7CiAgICBwZXJweSA9ICBwMXggLSBwMng7CgogICAgZGlzdCA9IE1hdGguc3FydChwZXJweCpwZXJweCArIHBlcnB5KnBlcnB5KTsKCiAgICBwZXJweCAvPSBkaXN0OwogICAgcGVycHkgLz0gZGlzdDsKICAgIHBlcnB4ICo9IHdpZHRoOwogICAgcGVycHkgKj0gd2lkdGg7CgogICAgLy8gc3RhcnQKICAgIHZlcnRzLnB1c2gocDF4IC0gcGVycHggLCBwMXkgLSBwZXJweSwKICAgICAgICAgICAgICAgIHIsIGcsIGIsIGFscGhhKTsKCiAgICB2ZXJ0cy5wdXNoKHAxeCArIHBlcnB4ICwgcDF5ICsgcGVycHksCiAgICAgICAgICAgICAgICByLCBnLCBiLCBhbHBoYSk7CgogICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aC0xOyBpKyspCiAgICB7CiAgICAgICAgcDF4ID0gcG9pbnRzWyhpLTEpKjJdOwogICAgICAgIHAxeSA9IHBvaW50c1soaS0xKSoyICsgMV07CgogICAgICAgIHAyeCA9IHBvaW50c1soaSkqMl07CiAgICAgICAgcDJ5ID0gcG9pbnRzWyhpKSoyICsgMV07CgogICAgICAgIHAzeCA9IHBvaW50c1soaSsxKSoyXTsKICAgICAgICBwM3kgPSBwb2ludHNbKGkrMSkqMiArIDFdOwoKICAgICAgICBwZXJweCA9IC0ocDF5IC0gcDJ5KTsKICAgICAgICBwZXJweSA9IHAxeCAtIHAyeDsKCiAgICAgICAgZGlzdCA9IE1hdGguc3FydChwZXJweCpwZXJweCArIHBlcnB5KnBlcnB5KTsKICAgICAgICBwZXJweCAvPSBkaXN0OwogICAgICAgIHBlcnB5IC89IGRpc3Q7CiAgICAgICAgcGVycHggKj0gd2lkdGg7CiAgICAgICAgcGVycHkgKj0gd2lkdGg7CgogICAgICAgIHBlcnAyeCA9IC0ocDJ5IC0gcDN5KTsKICAgICAgICBwZXJwMnkgPSBwMnggLSBwM3g7CgogICAgICAgIGRpc3QgPSBNYXRoLnNxcnQocGVycDJ4KnBlcnAyeCArIHBlcnAyeSpwZXJwMnkpOwogICAgICAgIHBlcnAyeCAvPSBkaXN0OwogICAgICAgIHBlcnAyeSAvPSBkaXN0OwogICAgICAgIHBlcnAyeCAqPSB3aWR0aDsKICAgICAgICBwZXJwMnkgKj0gd2lkdGg7CgogICAgICAgIGExID0gKC1wZXJweSArIHAxeSkgLSAoLXBlcnB5ICsgcDJ5KTsKICAgICAgICBiMSA9ICgtcGVycHggKyBwMngpIC0gKC1wZXJweCArIHAxeCk7CiAgICAgICAgYzEgPSAoLXBlcnB4ICsgcDF4KSAqICgtcGVycHkgKyBwMnkpIC0gKC1wZXJweCArIHAyeCkgKiAoLXBlcnB5ICsgcDF5KTsKICAgICAgICBhMiA9ICgtcGVycDJ5ICsgcDN5KSAtICgtcGVycDJ5ICsgcDJ5KTsKICAgICAgICBiMiA9ICgtcGVycDJ4ICsgcDJ4KSAtICgtcGVycDJ4ICsgcDN4KTsKICAgICAgICBjMiA9ICgtcGVycDJ4ICsgcDN4KSAqICgtcGVycDJ5ICsgcDJ5KSAtICgtcGVycDJ4ICsgcDJ4KSAqICgtcGVycDJ5ICsgcDN5KTsKCiAgICAgICAgZGVub20gPSBhMSpiMiAtIGEyKmIxOwoKICAgICAgICBpZihNYXRoLmFicyhkZW5vbSkgPCAwLjEgKQogICAgICAgIHsKCiAgICAgICAgICAgIGRlbm9tKz0xMC4xOwogICAgICAgICAgICB2ZXJ0cy5wdXNoKHAyeCAtIHBlcnB4ICwgcDJ5IC0gcGVycHksCiAgICAgICAgICAgICAgICByLCBnLCBiLCBhbHBoYSk7CgogICAgICAgICAgICB2ZXJ0cy5wdXNoKHAyeCArIHBlcnB4ICwgcDJ5ICsgcGVycHksCiAgICAgICAgICAgICAgICByLCBnLCBiLCBhbHBoYSk7CgogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIHB4ID0gKGIxKmMyIC0gYjIqYzEpL2Rlbm9tOwogICAgICAgIHB5ID0gKGEyKmMxIC0gYTEqYzIpL2Rlbm9tOwoKCiAgICAgICAgcGRpc3QgPSAocHggLXAyeCkgKiAocHggLXAyeCkgKyAocHkgLXAyeSkgKyAocHkgLXAyeSk7CgoKICAgICAgICBpZihwZGlzdCA+IDE0MCAqIDE0MCkKICAgICAgICB7CiAgICAgICAgICAgIHBlcnAzeCA9IHBlcnB4IC0gcGVycDJ4OwogICAgICAgICAgICBwZXJwM3kgPSBwZXJweSAtIHBlcnAyeTsKCiAgICAgICAgICAgIGRpc3QgPSBNYXRoLnNxcnQocGVycDN4KnBlcnAzeCArIHBlcnAzeSpwZXJwM3kpOwogICAgICAgICAgICBwZXJwM3ggLz0gZGlzdDsKICAgICAgICAgICAgcGVycDN5IC89IGRpc3Q7CiAgICAgICAgICAgIHBlcnAzeCAqPSB3aWR0aDsKICAgICAgICAgICAgcGVycDN5ICo9IHdpZHRoOwoKICAgICAgICAgICAgdmVydHMucHVzaChwMnggLSBwZXJwM3gsIHAyeSAtcGVycDN5KTsKICAgICAgICAgICAgdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgogICAgICAgICAgICB2ZXJ0cy5wdXNoKHAyeCArIHBlcnAzeCwgcDJ5ICtwZXJwM3kpOwogICAgICAgICAgICB2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCiAgICAgICAgICAgIHZlcnRzLnB1c2gocDJ4IC0gcGVycDN4LCBwMnkgLXBlcnAzeSk7CiAgICAgICAgICAgIHZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoKICAgICAgICAgICAgaW5kZXhDb3VudCsrOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewoKICAgICAgICAgICAgdmVydHMucHVzaChweCAsIHB5KTsKICAgICAgICAgICAgdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgogICAgICAgICAgICB2ZXJ0cy5wdXNoKHAyeCAtIChweC1wMngpLCBwMnkgLSAocHkgLSBwMnkpKTsKICAgICAgICAgICAgdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CiAgICAgICAgfQogICAgfQoKICAgIHAxeCA9IHBvaW50c1sobGVuZ3RoLTIpKjJdOwogICAgcDF5ID0gcG9pbnRzWyhsZW5ndGgtMikqMiArIDFdOwoKICAgIHAyeCA9IHBvaW50c1sobGVuZ3RoLTEpKjJdOwogICAgcDJ5ID0gcG9pbnRzWyhsZW5ndGgtMSkqMiArIDFdOwoKICAgIHBlcnB4ID0gLShwMXkgLSBwMnkpOwogICAgcGVycHkgPSBwMXggLSBwMng7CgogICAgZGlzdCA9IE1hdGguc3FydChwZXJweCpwZXJweCArIHBlcnB5KnBlcnB5KTsKICAgIHBlcnB4IC89IGRpc3Q7CiAgICBwZXJweSAvPSBkaXN0OwogICAgcGVycHggKj0gd2lkdGg7CiAgICBwZXJweSAqPSB3aWR0aDsKCiAgICB2ZXJ0cy5wdXNoKHAyeCAtIHBlcnB4ICwgcDJ5IC0gcGVycHkpOwogICAgdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgogICAgdmVydHMucHVzaChwMnggKyBwZXJweCAsIHAyeSArIHBlcnB5KTsKICAgIHZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoKICAgIGluZGljZXMucHVzaChpbmRleFN0YXJ0KTsKCiAgICBmb3IgKGkgPSAwOyBpIDwgaW5kZXhDb3VudDsgaSsrKQogICAgewogICAgICAgIGluZGljZXMucHVzaChpbmRleFN0YXJ0KyspOwogICAgfQoKICAgIGluZGljZXMucHVzaChpbmRleFN0YXJ0LTEpOwp9OwoKLyoqCiAqIEJ1aWxkcyBhIHBvbHlnb24gdG8gZHJhdwogKgogKiBAc3RhdGljCiAqIEBwcml2YXRlCiAqIEBtZXRob2QgYnVpbGRQb2x5CiAqIEBwYXJhbSBncmFwaGljcyB7R3JhcGhpY3N9CiAqIEBwYXJhbSB3ZWJHTERhdGEge09iamVjdH0KICovClBJWEkuV2ViR0xHcmFwaGljcy5idWlsZFBvbHkgPSBmdW5jdGlvbihncmFwaGljc0RhdGEsIHdlYkdMRGF0YSkKewogICAgdmFyIHBvaW50cyA9IGdyYXBoaWNzRGF0YS5wb2ludHM7CiAgICBpZihwb2ludHMubGVuZ3RoIDwgNilyZXR1cm47CgogICAgLy8gZ2V0IGZpcnN0IGFuZCBsYXN0IHBvaW50Li4gZmlndXJlIG91dCB0aGUgbWlkZGxlIQogICAgdmFyIHZlcnRzID0gd2ViR0xEYXRhLnBvaW50czsKICAgIHZhciBpbmRpY2VzID0gd2ViR0xEYXRhLmluZGljZXM7CgogICAgdmFyIGxlbmd0aCA9IHBvaW50cy5sZW5ndGggLyAyOwoKICAgIC8vIHNvcnQgY29sb3IKICAgIHZhciBjb2xvciA9IFBJWEkuaGV4MnJnYihncmFwaGljc0RhdGEuZmlsbENvbG9yKTsKICAgIHZhciBhbHBoYSA9IGdyYXBoaWNzRGF0YS5maWxsQWxwaGE7CiAgICB2YXIgciA9IGNvbG9yWzBdICogYWxwaGE7CiAgICB2YXIgZyA9IGNvbG9yWzFdICogYWxwaGE7CiAgICB2YXIgYiA9IGNvbG9yWzJdICogYWxwaGE7CgogICAgdmFyIHRyaWFuZ2xlcyA9IFBJWEkuUG9seUsuVHJpYW5ndWxhdGUocG9pbnRzKTsKCiAgICB2YXIgdmVydFBvcyA9IHZlcnRzLmxlbmd0aCAvIDY7CgogICAgdmFyIGkgPSAwOwoKICAgIGZvciAoaSA9IDA7IGkgPCB0cmlhbmdsZXMubGVuZ3RoOyBpKz0zKQogICAgewogICAgICAgIGluZGljZXMucHVzaCh0cmlhbmdsZXNbaV0gKyB2ZXJ0UG9zKTsKICAgICAgICBpbmRpY2VzLnB1c2godHJpYW5nbGVzW2ldICsgdmVydFBvcyk7CiAgICAgICAgaW5kaWNlcy5wdXNoKHRyaWFuZ2xlc1tpKzFdICsgdmVydFBvcyk7CiAgICAgICAgaW5kaWNlcy5wdXNoKHRyaWFuZ2xlc1tpKzJdICt2ZXJ0UG9zKTsKICAgICAgICBpbmRpY2VzLnB1c2godHJpYW5nbGVzW2krMl0gKyB2ZXJ0UG9zKTsKICAgIH0KCiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspCiAgICB7CiAgICAgICAgdmVydHMucHVzaChwb2ludHNbaSAqIDJdLCBwb2ludHNbaSAqIDIgKyAxXSwKICAgICAgICAgICAgICAgICAgIHIsIGcsIGIsIGFscGhhKTsKICAgIH0KfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgpQSVhJLl9kZWZhdWx0RnJhbWUgPSBuZXcgUElYSS5SZWN0YW5nbGUoMCwwLDEsMSk7CgovLyBhbiBpbnN0YW5jZSBvZiB0aGUgZ2wgY29udGV4dC4uCi8vIG9ubHkgb25lIGF0IHRoZSBtb21lbnQgOi8KUElYSS5nbCA9IG51bGw7CgovKioKICogdGhlIFdlYkdMUmVuZGVyZXIgaXMgZHJhd3MgdGhlIHN0YWdlIGFuZCBhbGwgaXRzIGNvbnRlbnQgb250byBhIHdlYkdMIGVuYWJsZWQgY2FudmFzLiBUaGlzIHJlbmRlcmVyCiAqIHNob3VsZCBiZSB1c2VkIGZvciBicm93c2VycyBzdXBwb3J0IHdlYkdMLiBUaGlzIFJlbmRlciB3b3JrcyBieSBhdXRvbWF0aWNhbGx5IG1hbmFnaW5nIHdlYkdMQmF0Y2hzLgogKiBTbyBubyBuZWVkIGZvciBTcHJpdGUgQmF0Y2gncyBvciBTcHJpdGUgQ2xvdWQncwogKiBEb250IGZvcmdldCB0byBhZGQgdGhlIHZpZXcgdG8geW91ciBET00gb3IgeW91IHdpbGwgbm90IHNlZSBhbnl0aGluZyA6KQogKgogKiBAY2xhc3MgV2ViR0xSZW5kZXJlcgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHdpZHRoPTAge051bWJlcn0gdGhlIHdpZHRoIG9mIHRoZSBjYW52YXMgdmlldwogKiBAcGFyYW0gaGVpZ2h0PTAge051bWJlcn0gdGhlIGhlaWdodCBvZiB0aGUgY2FudmFzIHZpZXcKICogQHBhcmFtIHZpZXcge0NhbnZhc30gdGhlIGNhbnZhcyB0byB1c2UgYXMgYSB2aWV3LCBvcHRpb25hbAogKiBAcGFyYW0gdHJhbnNwYXJlbnQ9ZmFsc2Uge0Jvb2xlYW59IHRoZSB0cmFuc3BhcmVuY3kgb2YgdGhlIHJlbmRlciB2aWV3LCBkZWZhdWx0IGZhbHNlCiAqIEBwYXJhbSBhbnRpYWxpYXM9ZmFsc2Uge0Jvb2xlYW59IHNldHMgYW50aWFsaWFzIChvbmx5IGFwcGxpY2FibGUgaW4gY2hyb21lIGF0IHRoZSBtb21lbnQpCiAqCiAqLwpQSVhJLldlYkdMUmVuZGVyZXIgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0LCB2aWV3LCB0cmFuc3BhcmVudCwgYW50aWFsaWFzKQp7CiAgICAvLyBkbyBhIGNhdGNoLi4gb25seSAxIHdlYkdMIHJlbmRlcmVyLi4KCiAgICB0aGlzLnRyYW5zcGFyZW50ID0gISF0cmFuc3BhcmVudDsKCiAgICB0aGlzLndpZHRoID0gd2lkdGggfHwgODAwOwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQgfHwgNjAwOwoKICAgIHRoaXMudmlldyA9IHZpZXcgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2NhbnZhcycgKTsKICAgIHRoaXMudmlldy53aWR0aCA9IHRoaXMud2lkdGg7CiAgICB0aGlzLnZpZXcuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CgogICAgLy8gZGVhbCB3aXRoIGxvc2luZyBjb250ZXh0Li4KICAgIHZhciBzY29wZSA9IHRoaXM7CiAgICB0aGlzLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcignd2ViZ2xjb250ZXh0bG9zdCcsIGZ1bmN0aW9uKGV2ZW50KSB7IHNjb3BlLmhhbmRsZUNvbnRleHRMb3N0KGV2ZW50KTsgfSwgZmFsc2UpOwogICAgdGhpcy52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmdsY29udGV4dHJlc3RvcmVkJywgZnVuY3Rpb24oZXZlbnQpIHsgc2NvcGUuaGFuZGxlQ29udGV4dFJlc3RvcmVkKGV2ZW50KTsgfSwgZmFsc2UpOwoKICAgIHRoaXMuYmF0Y2hzID0gW107CgogICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgYWxwaGE6IHRoaXMudHJhbnNwYXJlbnQsCiAgICAgICAgYW50aWFsaWFzOiEhYW50aWFsaWFzLCAvLyBTUEVFRCBVUD8/CiAgICAgICAgcHJlbXVsdGlwbGllZEFscGhhOmZhbHNlLAogICAgICAgIHN0ZW5jaWw6dHJ1ZQogICAgfTsKCiAgICAvL3RyeSAnZXhwZXJpbWVudGFsLXdlYmdsJwogICAgdHJ5IHsKICAgICAgICBQSVhJLmdsID0gdGhpcy5nbCA9IHRoaXMudmlldy5nZXRDb250ZXh0KCdleHBlcmltZW50YWwtd2ViZ2wnLCAgb3B0aW9ucyk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgLy90cnkgJ3dlYmdsJwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIFBJWEkuZ2wgPSB0aGlzLmdsID0gdGhpcy52aWV3LmdldENvbnRleHQoJ3dlYmdsJywgIG9wdGlvbnMpOwogICAgICAgIH0gY2F0Y2ggKGUyKSB7CiAgICAgICAgICAgIC8vIGZhaWwsIG5vdCBhYmxlIHRvIGdldCBhIGNvbnRleHQKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCcgVGhpcyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgd2ViR0wuIFRyeSB1c2luZyB0aGUgY2FudmFzIHJlbmRlcmVyJyArIHRoaXMpOwogICAgICAgIH0KICAgIH0KCiAgICBQSVhJLmluaXREZWZhdWx0U2hhZGVycygpOwoKCgoKICAgLy8gUElYSS5hY3RpdmF0ZURlZmF1bHRTaGFkZXIoKTsKCiAgICB2YXIgZ2wgPSB0aGlzLmdsOwoKICAgIGdsLnVzZVByb2dyYW0oUElYSS5kZWZhdWx0U2hhZGVyLnByb2dyYW0pOwoKCiAgICBQSVhJLldlYkdMUmVuZGVyZXIuZ2wgPSBnbDsKCiAgICB0aGlzLmJhdGNoID0gbmV3IFBJWEkuV2ViR0xCYXRjaChnbCk7CiAgICBnbC5kaXNhYmxlKGdsLkRFUFRIX1RFU1QpOwogICAgZ2wuZGlzYWJsZShnbC5DVUxMX0ZBQ0UpOwoKICAgIGdsLmVuYWJsZShnbC5CTEVORCk7CiAgICBnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdGhpcy50cmFuc3BhcmVudCk7CgogICAgUElYSS5wcm9qZWN0aW9uID0gbmV3IFBJWEkuUG9pbnQoNDAwLCAzMDApOwogICAgUElYSS5vZmZzZXQgPSBuZXcgUElYSS5Qb2ludCgwLCAwKTsKCiAgICAvLyBUT0RPIHJlbW92ZSB0aGVhc2UgZ2xvYmFscy4uCgogICAgdGhpcy5yZXNpemUodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwogICAgdGhpcy5jb250ZXh0TG9zdCA9IGZhbHNlOwoKICAgIC8vUElYSS5wdXNoU2hhZGVyKFBJWEkuZGVmYXVsdFNoYWRlcik7CgogICAgdGhpcy5zdGFnZVJlbmRlckdyb3VwID0gbmV3IFBJWEkuV2ViR0xSZW5kZXJHcm91cCh0aGlzLmdsLCB0aGlzLnRyYW5zcGFyZW50KTsKICAvLyAgdGhpcy5zdGFnZVJlbmRlckdyb3VwLiA9IHRoaXMudHJhbnNwYXJlbnQKfTsKCi8vIGNvbnN0cnVjdG9yClBJWEkuV2ViR0xSZW5kZXJlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLldlYkdMUmVuZGVyZXI7CgovKioKICogR2V0cyBhIG5ldyBXZWJHTEJhdGNoIGZyb20gdGhlIHBvb2wKICoKICogQHN0YXRpYwogKiBAbWV0aG9kIGdldEJhdGNoCiAqIEByZXR1cm4ge1dlYkdMQmF0Y2h9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyZXIuZ2V0QmF0Y2ggPSBmdW5jdGlvbigpCnsKICAgIGlmKFBJWEkuX2JhdGNocy5sZW5ndGggPT09IDApCiAgICB7CiAgICAgICAgcmV0dXJuIG5ldyBQSVhJLldlYkdMQmF0Y2goUElYSS5XZWJHTFJlbmRlcmVyLmdsKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICByZXR1cm4gUElYSS5fYmF0Y2hzLnBvcCgpOwogICAgfQp9OwoKLyoqCiAqIFB1dHMgYSBiYXRjaCBiYWNrIGludG8gdGhlIHBvb2wKICoKICogQHN0YXRpYwogKiBAbWV0aG9kIHJldHVybkJhdGNoCiAqIEBwYXJhbSBiYXRjaCB7V2ViR0xCYXRjaH0gVGhlIGJhdGNoIHRvIHJldHVybgogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlcmVyLnJldHVybkJhdGNoID0gZnVuY3Rpb24oYmF0Y2gpCnsKICAgIGJhdGNoLmNsZWFuKCk7CiAgICBQSVhJLl9iYXRjaHMucHVzaChiYXRjaCk7Cn07CgovKioKICogUmVuZGVycyB0aGUgc3RhZ2UgdG8gaXRzIHdlYkdMIHZpZXcKICoKICogQG1ldGhvZCByZW5kZXIKICogQHBhcmFtIHN0YWdlIHtTdGFnZX0gdGhlIFN0YWdlIGVsZW1lbnQgdG8gYmUgcmVuZGVyZWQKICovClBJWEkuV2ViR0xSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oc3RhZ2UpCnsKICAgIGlmKHRoaXMuY29udGV4dExvc3QpcmV0dXJuOwoKCiAgICAvLyBpZiByZW5kZXJpbmcgYSBuZXcgc3RhZ2UgY2xlYXIgdGhlIGJhdGNocy4uCiAgICBpZih0aGlzLl9fc3RhZ2UgIT09IHN0YWdlKQogICAgewogICAgICAgIC8vIFRPRE8gbWFrZSB0aGlzIHdvcmsKICAgICAgICAvLyBkb250IHRoaW5rIHRoaXMgaXMgbmVlZGVkIGFueSBtb3JlPwogICAgICAgIHRoaXMuX19zdGFnZSA9IHN0YWdlOwogICAgICAgIHRoaXMuc3RhZ2VSZW5kZXJHcm91cC5zZXRSZW5kZXJhYmxlKHN0YWdlKTsKICAgIH0KCiAgICAvLyB1cGRhdGUgYW55IHRleHR1cmVzCiAgICBQSVhJLldlYkdMUmVuZGVyZXIudXBkYXRlVGV4dHVyZXMoKTsKCiAgICAvLyB1cGRhdGUgdGhlIHNjZW5lIGdyYXBoCiAgICBQSVhJLnZpc2libGVDb3VudCsrOwogICAgc3RhZ2UudXBkYXRlVHJhbnNmb3JtKCk7CgogICAgdmFyIGdsID0gdGhpcy5nbDsKCiAgICAvLyAtLSBEb2VzIHRoaXMgbmVlZCB0byBiZSBzZXQgZXZlcnkgZnJhbWU/IC0tIC8vCiAgICBnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdGhpcy50cmFuc3BhcmVudCk7CiAgICBnbC52aWV3cG9ydCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgogICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCBudWxsKTsKCiAgICBnbC5jbGVhckNvbG9yKHN0YWdlLmJhY2tncm91bmRDb2xvclNwbGl0WzBdLHN0YWdlLmJhY2tncm91bmRDb2xvclNwbGl0WzFdLHN0YWdlLmJhY2tncm91bmRDb2xvclNwbGl0WzJdLCAhdGhpcy50cmFuc3BhcmVudCk7CiAgICBnbC5jbGVhcihnbC5DT0xPUl9CVUZGRVJfQklUKTsKCiAgICAvLyBIQUNLIFRPIFRFU1QKCiAgICB0aGlzLnN0YWdlUmVuZGVyR3JvdXAuYmFja2dyb3VuZENvbG9yID0gc3RhZ2UuYmFja2dyb3VuZENvbG9yU3BsaXQ7CgogICAgUElYSS5wcm9qZWN0aW9uLnggPSAgdGhpcy53aWR0aC8yOwogICAgUElYSS5wcm9qZWN0aW9uLnkgPSAgLXRoaXMuaGVpZ2h0LzI7CgogICAgdGhpcy5zdGFnZVJlbmRlckdyb3VwLnJlbmRlcihQSVhJLnByb2plY3Rpb24pOwoKICAgIC8vIGludGVyYWN0aW9uCiAgICAvLyBydW4gaW50ZXJhY3Rpb24hCiAgICBpZihzdGFnZS5pbnRlcmFjdGl2ZSkKICAgIHsKICAgICAgICAvL25lZWQgdG8gYWRkIHNvbWUgZXZlbnRzIQogICAgICAgIGlmKCFzdGFnZS5faW50ZXJhY3RpdmVFdmVudHNBZGRlZCkKICAgICAgICB7CiAgICAgICAgICAgIHN0YWdlLl9pbnRlcmFjdGl2ZUV2ZW50c0FkZGVkID0gdHJ1ZTsKICAgICAgICAgICAgc3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyLnNldFRhcmdldCh0aGlzKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gYWZ0ZXIgcmVuZGVyaW5nIGxldHMgY29uZmlybSBhbGwgZnJhbWVzIHRoYXQgaGF2ZSBiZWVuIHVvZGF0ZWQuLgogICAgaWYoUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcy5sZW5ndGggPiAwKQogICAgewogICAgICAgIGZvciAodmFyIGk9MDsgaSA8IFBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzW2ldLnVwZGF0ZUZyYW1lID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzID0gW107CiAgICB9Cn07CgovKioKICogVXBkYXRlcyB0aGUgdGV4dHVyZXMgbG9hZGVkIGludG8gdGhpcyB3ZWJnbCByZW5kZXJlcgogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgdXBkYXRlVGV4dHVyZXMKICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJlci51cGRhdGVUZXh0dXJlcyA9IGZ1bmN0aW9uKCkKewogICAgdmFyIGkgPSAwOwoKICAgIC8vVE9ETyBicmVhayB0aGlzIG91dCBpbnRvIGEgdGV4dHVyZSBtYW5hZ2VyLi4uCiAgICBmb3IgKGkgPSAwOyBpIDwgUElYSS50ZXh0dXJlc1RvVXBkYXRlLmxlbmd0aDsgaSsrKQogICAgICAgIFBJWEkuV2ViR0xSZW5kZXJlci51cGRhdGVUZXh0dXJlKFBJWEkudGV4dHVyZXNUb1VwZGF0ZVtpXSk7CgogICAgZm9yIChpID0gMDsgaSA8IFBJWEkudGV4dHVyZXNUb0Rlc3Ryb3kubGVuZ3RoOyBpKyspCiAgICAgICAgUElYSS5XZWJHTFJlbmRlcmVyLmRlc3Ryb3lUZXh0dXJlKFBJWEkudGV4dHVyZXNUb0Rlc3Ryb3lbaV0pOwoKICAgIFBJWEkudGV4dHVyZXNUb1VwZGF0ZSA9IFtdOwogICAgUElYSS50ZXh0dXJlc1RvRGVzdHJveSA9IFtdOwp9OwoKLyoqCiAqIFVwZGF0ZXMgYSBsb2FkZWQgd2ViZ2wgdGV4dHVyZQogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgdXBkYXRlVGV4dHVyZQogKiBAcGFyYW0gdGV4dHVyZSB7VGV4dHVyZX0gVGhlIHRleHR1cmUgdG8gdXBkYXRlCiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyZXIudXBkYXRlVGV4dHVyZSA9IGZ1bmN0aW9uKHRleHR1cmUpCnsKICAgIC8vVE9ETyBicmVhayB0aGlzIG91dCBpbnRvIGEgdGV4dHVyZSBtYW5hZ2VyLi4uCiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIGlmKCF0ZXh0dXJlLl9nbFRleHR1cmUpCiAgICB7CiAgICAgICAgdGV4dHVyZS5fZ2xUZXh0dXJlID0gZ2wuY3JlYXRlVGV4dHVyZSgpOwogICAgfQoKICAgIGlmKHRleHR1cmUuaGFzTG9hZGVkKQogICAgewogICAgICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRleHR1cmUuX2dsVGV4dHVyZSk7CiAgICAgICAgZ2wucGl4ZWxTdG9yZWkoZ2wuVU5QQUNLX1BSRU1VTFRJUExZX0FMUEhBX1dFQkdMLCB0cnVlKTsKCiAgICAgICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCB0ZXh0dXJlLnNvdXJjZSk7CiAgICAgICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01BR19GSUxURVIsIHRleHR1cmUuc2NhbGVNb2RlID09PSBQSVhJLkJhc2VUZXh0dXJlLlNDQUxFX01PREUuTElORUFSID8gZ2wuTElORUFSIDogZ2wuTkVBUkVTVCk7CiAgICAgICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01JTl9GSUxURVIsIHRleHR1cmUuc2NhbGVNb2RlID09PSBQSVhJLkJhc2VUZXh0dXJlLlNDQUxFX01PREUuTElORUFSID8gZ2wuTElORUFSIDogZ2wuTkVBUkVTVCk7CgogICAgICAgIC8vIHJlZ3VsZXIuLi4KCiAgICAgICAgaWYoIXRleHR1cmUuX3Bvd2VyT2YyKQogICAgICAgIHsKICAgICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSk7CiAgICAgICAgICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1QsIGdsLkNMQU1QX1RPX0VER0UpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9TLCBnbC5SRVBFQVQpOwogICAgICAgICAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5SRVBFQVQpOwogICAgICAgIH0KCiAgICAgICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgbnVsbCk7CiAgICB9Cn07CgovKioKICogRGVzdHJveXMgYSBsb2FkZWQgd2ViZ2wgdGV4dHVyZQogKgogKiBAbWV0aG9kIGRlc3Ryb3lUZXh0dXJlCiAqIEBwYXJhbSB0ZXh0dXJlIHtUZXh0dXJlfSBUaGUgdGV4dHVyZSB0byB1cGRhdGUKICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJlci5kZXN0cm95VGV4dHVyZSA9IGZ1bmN0aW9uKHRleHR1cmUpCnsKICAgIC8vVE9ETyBicmVhayB0aGlzIG91dCBpbnRvIGEgdGV4dHVyZSBtYW5hZ2VyLi4uCiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIGlmKHRleHR1cmUuX2dsVGV4dHVyZSkKICAgIHsKICAgICAgICB0ZXh0dXJlLl9nbFRleHR1cmUgPSBnbC5jcmVhdGVUZXh0dXJlKCk7CiAgICAgICAgZ2wuZGVsZXRlVGV4dHVyZShnbC5URVhUVVJFXzJELCB0ZXh0dXJlLl9nbFRleHR1cmUpOwogICAgfQp9OwoKLyoqCiAqIHJlc2l6ZXMgdGhlIHdlYkdMIHZpZXcgdG8gdGhlIHNwZWNpZmllZCB3aWR0aCBhbmQgaGVpZ2h0CiAqCiAqIEBtZXRob2QgcmVzaXplCiAqIEBwYXJhbSB3aWR0aCB7TnVtYmVyfSB0aGUgbmV3IHdpZHRoIG9mIHRoZSB3ZWJHTCB2aWV3CiAqIEBwYXJhbSBoZWlnaHQge051bWJlcn0gdGhlIG5ldyBoZWlnaHQgb2YgdGhlIHdlYkdMIHZpZXcKICovClBJWEkuV2ViR0xSZW5kZXJlci5wcm90b3R5cGUucmVzaXplID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkKewogICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgdGhpcy52aWV3LndpZHRoID0gd2lkdGg7CiAgICB0aGlzLnZpZXcuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgIHRoaXMuZ2wudmlld3BvcnQoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoKICAgIC8vdmFyIHByb2plY3Rpb25NYXRyaXggPSB0aGlzLnByb2plY3Rpb25NYXRyaXg7CgogICAgUElYSS5wcm9qZWN0aW9uLnggPSAgdGhpcy53aWR0aC8yOwogICAgUElYSS5wcm9qZWN0aW9uLnkgPSAgLXRoaXMuaGVpZ2h0LzI7CgogICAgLy9QSVhJLnNpemUueCA9ICB0aGlzLndpZHRoLzI7CiAgICAvL1BJWEkuc2l6ZS55ID0gIC10aGlzLmhlaWdodC8yOwoKLy8gIHByb2plY3Rpb25NYXRyaXhbMF0gPSAyL3RoaXMud2lkdGg7Ci8vICBwcm9qZWN0aW9uTWF0cml4WzVdID0gLTIvdGhpcy5oZWlnaHQ7Ci8vICBwcm9qZWN0aW9uTWF0cml4WzEyXSA9IC0xOwovLyAgcHJvamVjdGlvbk1hdHJpeFsxM10gPSAxOwp9OwoKLyoqCiAqIEhhbmRsZXMgYSBsb3N0IHdlYmdsIGNvbnRleHQKICoKICogQG1ldGhvZCBoYW5kbGVDb250ZXh0TG9zdAogKiBAcGFyYW0gZXZlbnQge0V2ZW50fQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlcmVyLnByb3RvdHlwZS5oYW5kbGVDb250ZXh0TG9zdCA9IGZ1bmN0aW9uKGV2ZW50KQp7CiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgdGhpcy5jb250ZXh0TG9zdCA9IHRydWU7Cn07CgovKioKICogSGFuZGxlcyBhIHJlc3RvcmVkIHdlYmdsIGNvbnRleHQKICoKICogQG1ldGhvZCBoYW5kbGVDb250ZXh0UmVzdG9yZWQKICogQHBhcmFtIGV2ZW50IHtFdmVudH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJlci5wcm90b3R5cGUuaGFuZGxlQ29udGV4dFJlc3RvcmVkID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLmdsID0gdGhpcy52aWV3LmdldENvbnRleHQoJ2V4cGVyaW1lbnRhbC13ZWJnbCcsICB7CiAgICAgICAgYWxwaGE6IHRydWUKICAgIH0pOwoKICAgIHRoaXMuaW5pdFNoYWRlcnMoKTsKCiAgICBmb3IodmFyIGtleSBpbiBQSVhJLlRleHR1cmVDYWNoZSkKICAgIHsKICAgICAgICB2YXIgdGV4dHVyZSA9IFBJWEkuVGV4dHVyZUNhY2hlW2tleV0uYmFzZVRleHR1cmU7CiAgICAgICAgdGV4dHVyZS5fZ2xUZXh0dXJlID0gbnVsbDsKICAgICAgICBQSVhJLldlYkdMUmVuZGVyZXIudXBkYXRlVGV4dHVyZSh0ZXh0dXJlKTsKICAgIH0KCiAgICBmb3IgKHZhciBpPTA7IGkgPCAgdGhpcy5iYXRjaHMubGVuZ3RoOyBpKyspCiAgICB7CiAgICAgICAgdGhpcy5iYXRjaHNbaV0ucmVzdG9yZUxvc3RDb250ZXh0KHRoaXMuZ2wpOwogICAgICAgIHRoaXMuYmF0Y2hzW2ldLmRpcnR5ID0gdHJ1ZTsKICAgIH0KCiAgICBQSVhJLl9yZXN0b3JlQmF0Y2hzKHRoaXMuZ2wpOwoKICAgIHRoaXMuY29udGV4dExvc3QgPSBmYWxzZTsKfTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogQSBXZWJHTEJhdGNoIEVuYWJsZXMgYSBncm91cCBvZiBzcHJpdGVzIHRvIGJlIGRyYXduIHVzaW5nIHRoZSBzYW1lIHNldHRpbmdzLgogKiBpZiBhIGdyb3VwIG9mIHNwcml0ZXMgYWxsIGhhdmUgdGhlIHNhbWUgYmFzZVRleHR1cmUgYW5kIGJsZW5kTW9kZSB0aGVuIHRoZXkgY2FuIGJlCiAqIGdyb3VwZWQgaW50byBhIGJhdGNoLiBBbGwgdGhlIHNwcml0ZXMgaW4gYSBiYXRjaCBjYW4gdGhlbiBiZSBkcmF3biBpbiBvbmUgZ28gYnkgdGhlCiAqIEdQVSB3aGljaCBpcyBodWdlbHkgZWZmaWNpZW50LiBBTEwgc3ByaXRlcyBpbiB0aGUgd2ViR0wgcmVuZGVyZXIgYXJlIGFkZGVkIHRvIGEgYmF0Y2gKICogZXZlbiBpZiB0aGUgYmF0Y2ggb25seSBjb250YWlucyBvbmUgc3ByaXRlLiBCYXRjaGluZyBpcyBoYW5kbGVkIGF1dG9tYXRpY2FsbHkgYnkgdGhlCiAqIHdlYkdMIHJlbmRlcmVyLiBBIGdvb2QgdGlwIGlzOiB0aGUgc21hbGxlciB0aGUgbnVtYmVyIG9mIGJhdGNocyB0aGVyZSBhcmUsIHRoZSBmYXN0ZXIKICogdGhlIHdlYkdMIHJlbmRlcmVyIHdpbGwgcnVuLgogKgogKiBAY2xhc3MgV2ViR0xCYXRjaAogKiBAY29udHJ1Y3RvcgogKiBAcGFyYW0gZ2wge1dlYkdMQ29udGV4dH0gQW4gaW5zdGFuY2Ugb2YgdGhlIHdlYkdMIGNvbnRleHQKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cCA9IGZ1bmN0aW9uKGdsLCB0cmFuc3BhcmVudCkKewoJdGhpcy5nbCA9IGdsOwoJdGhpcy5yb290OwoJCgl0aGlzLmJhY2tncm91bmRDb2xvcjsKCXRoaXMudHJhbnNwYXJlbnQgPSB0cmFuc3BhcmVudCA9PSB1bmRlZmluZWQgPyB0cnVlIDogdHJhbnNwYXJlbnQ7CgkKCXRoaXMuYmF0Y2hzID0gW107Cgl0aGlzLnRvUmVtb3ZlID0gW107CgkvLyBjb25zb2xlLmxvZyh0aGlzLnRyYW5zcGFyZW50KQoJdGhpcy5maWx0ZXJNYW5hZ2VyID0gbmV3IFBJWEkuV2ViR0xGaWx0ZXJNYW5hZ2VyKHRoaXMudHJhbnNwYXJlbnQpOwp9CgovLyBjb25zdHJ1Y3RvcgpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5XZWJHTFJlbmRlckdyb3VwOwoKLyoqCiAqIEFkZCBhIGRpc3BsYXkgb2JqZWN0IHRvIHRoZSB3ZWJnbCByZW5kZXJlcgogKgogKiBAbWV0aG9kIHNldFJlbmRlcmFibGUKICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9CiAqIEBwcml2YXRlIAogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5zZXRSZW5kZXJhYmxlID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCkKewoJLy8gaGFzIHRoaXMgY2hhbmdlZD8/CglpZih0aGlzLnJvb3QpdGhpcy5yZW1vdmVEaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4odGhpcy5yb290KTsKCQoJZGlzcGxheU9iamVjdC53b3JsZFZpc2libGUgPSBkaXNwbGF5T2JqZWN0LnZpc2libGU7CgkKCS8vIHNvb29vb28gLy8KCS8vIHRvIGNoZWNrIGlmIGFueSBiYXRjaHMgZXhpc3QgYWxyZWFkeT8/CgkKCS8vIFRPRE8gd2hhdCBpZiBpdHMgYWxyZWFkeSBoYXMgYW4gb2JqZWN0PyBzaG91bGQgcmVtb3ZlIGl0Cgl0aGlzLnJvb3QgPSBkaXNwbGF5T2JqZWN0OwoJdGhpcy5hZGREaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4oZGlzcGxheU9iamVjdCk7Cn0KCi8qKgogKiBSZW5kZXJzIHRoZSBzdGFnZSB0byBpdHMgd2ViZ2wgdmlldwogKgogKiBAbWV0aG9kIHJlbmRlcgogKiBAcGFyYW0gcHJvamVjdGlvbiB7T2JqZWN0fQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihwcm9qZWN0aW9uLCBidWZmZXIpCnsKCVBJWEkuV2ViR0xSZW5kZXJlci51cGRhdGVUZXh0dXJlcygpOwoJCgl2YXIgZ2wgPSB0aGlzLmdsOwoJZ2wudW5pZm9ybTJmKFBJWEkuZGVmYXVsdFNoYWRlci5wcm9qZWN0aW9uVmVjdG9yLCBwcm9qZWN0aW9uLngsIHByb2plY3Rpb24ueSk7CgoJdGhpcy5maWx0ZXJNYW5hZ2VyLmJlZ2luKHByb2plY3Rpb24sIGJ1ZmZlcik7CgoJCglnbC5ibGVuZEZ1bmMoZ2wuT05FLCBnbC5PTkVfTUlOVVNfU1JDX0FMUEhBKTsKCS8vIHdpbGwgcmVuZGVyIGFsbCB0aGUgZWxlbWVudHMgaW4gdGhlIGdyb3VwCgl2YXIgcmVuZGVyYWJsZTsKCglmb3IgKHZhciBpPTA7IGkgPCB0aGlzLmJhdGNocy5sZW5ndGg7IGkrKykgCgl7CgkJCgkJcmVuZGVyYWJsZSA9IHRoaXMuYmF0Y2hzW2ldOwoJCWlmKHJlbmRlcmFibGUgaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2gpCgkJewoJCQl0aGlzLmJhdGNoc1tpXS5yZW5kZXIoKTsKCQkJY29udGludWU7CgkJfQoJCQoJCS8vIHJlbmRlciBzcGVjaWFsCgkJdGhpcy5yZW5kZXJTcGVjaWFsKHJlbmRlcmFibGUsIHByb2plY3Rpb24pOwoJfQoJCn0KCi8qKgogKiBSZW5kZXJzIGEgc3BlY2lmaWMgZGlzcGxheU9iamVjdAogKgogKiBAbWV0aG9kIHJlbmRlclNwZWNpZmljCiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fQogKiBAcGFyYW0gcHJvamVjdGlvbiB7T2JqZWN0fQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5yZW5kZXJTcGVjaWZpYyA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QsIHByb2plY3Rpb24sIGJ1ZmZlcikKewoJUElYSS5XZWJHTFJlbmRlcmVyLnVwZGF0ZVRleHR1cmVzKCk7Cgl2YXIgZ2wgPSB0aGlzLmdsOwoKCWdsLnVuaWZvcm0yZihQSVhJLmRlZmF1bHRTaGFkZXIucHJvamVjdGlvblZlY3RvciwgcHJvamVjdGlvbi54LCBwcm9qZWN0aW9uLnkpOwoKCXRoaXMuZmlsdGVyTWFuYWdlci5iZWdpbihwcm9qZWN0aW9uLCBidWZmZXIpOwoKCS8vIHRvIGRvIQoJLy8gcmVuZGVyIHBhcnQgb2YgdGhlIHNjZW5lLi4uCgkKCXZhciBzdGFydEluZGV4OwoJdmFyIHN0YXJ0QmF0Y2hJbmRleDsKCQoJdmFyIGVuZEluZGV4OwoJdmFyIGVuZEJhdGNoSW5kZXg7CgkKCS8qCgkgKiAgTE9PSyBGT1IgVEhFIE5FWFQgU1BSSVRFCgkgKiAgVGhpcyBwYXJ0IGxvb2tzIGZvciB0aGUgY2xvc2VzdCBuZXh0IHNwcml0ZSB0aGF0IGNhbiBnbyBpbnRvIGEgYmF0Y2gKCSAqICBpdCBrZWVwcyBsb29raW5nIHVudGlsIGl0IGZpbmRzIGEgc3ByaXRlIG9yIGdldHMgdG8gdGhlIGVuZCBvZiB0aGUgZGlzcGxheQoJICogIHNjZW5lIGdyYXBoCgkgKi8KCXZhciBuZXh0UmVuZGVyYWJsZSA9IGRpc3BsYXlPYmplY3QuZmlyc3Q7Cgl3aGlsZShuZXh0UmVuZGVyYWJsZS5faU5leHQpCgl7CgkJaWYobmV4dFJlbmRlcmFibGUucmVuZGVyYWJsZSAmJiBuZXh0UmVuZGVyYWJsZS5fX3JlbmRlckdyb3VwKWJyZWFrOwoJCW5leHRSZW5kZXJhYmxlID0gbmV4dFJlbmRlcmFibGUuX2lOZXh0OwoJfQoJdmFyIHN0YXJ0QmF0Y2ggPSBuZXh0UmVuZGVyYWJsZS5iYXRjaDsKCS8vY29uc29sZS5sb2cobmV4dFJlbmRlcmFibGUpOwoJCgkvL2NvbnNvbGUubG9nKHJlbmRlcmFibGUpCglpZihuZXh0UmVuZGVyYWJsZSBpbnN0YW5jZW9mIFBJWEkuU3ByaXRlKQoJewoJCXN0YXJ0QmF0Y2ggPSBuZXh0UmVuZGVyYWJsZS5iYXRjaDsKCQkKCQl2YXIgaGVhZCA9IHN0YXJ0QmF0Y2guaGVhZDsKCQl2YXIgbmV4dCA9IGhlYWQ7CgkJCgkJLy8gb2sgbm93IHdlIGhhdmUgdGhlIGJhdGNoLi4gbmVlZCB0byBmaW5kIHRoZSBzdGFydCBpbmRleCEKCQlpZihoZWFkID09IG5leHRSZW5kZXJhYmxlKQoJCXsKCQkJc3RhcnRJbmRleCA9IDA7CgkJfQoJCWVsc2UKCQl7CgkJCXN0YXJ0SW5kZXggPSAxOwoJCQkKCQkJd2hpbGUoaGVhZC5fX25leHQgIT0gbmV4dFJlbmRlcmFibGUpCgkJCXsKCQkJCXN0YXJ0SW5kZXgrKzsKCQkJCWhlYWQgPSBoZWFkLl9fbmV4dDsKCQkJfQoJCX0KCX0KCWVsc2UKCXsKCQlzdGFydEJhdGNoID0gbmV4dFJlbmRlcmFibGU7Cgl9CgkKCS8vIEdldCB0aGUgTEFTVCByZW5kZXJhYmxlIG9iamVjdAoJdmFyIGxhc3RSZW5kZXJhYmxlID0gZGlzcGxheU9iamVjdC5sYXN0OwoJd2hpbGUobGFzdFJlbmRlcmFibGUuX2lQcmV2KQoJewoJCWlmKGxhc3RSZW5kZXJhYmxlLnJlbmRlcmFibGUgJiYgbGFzdFJlbmRlcmFibGUuX19yZW5kZXJHcm91cClicmVhazsKCQlsYXN0UmVuZGVyYWJsZSA9IGxhc3RSZW5kZXJhYmxlLl9pTmV4dDsKCX0KCQoJaWYobGFzdFJlbmRlcmFibGUgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKCXsKCQllbmRCYXRjaCA9IGxhc3RSZW5kZXJhYmxlLmJhdGNoOwoJCQoJCXZhciBoZWFkID0gZW5kQmF0Y2guaGVhZDsKCQkKCQlpZihoZWFkID09IGxhc3RSZW5kZXJhYmxlKQoJCXsKCQkJZW5kSW5kZXggPSAwOwoJCX0KCQllbHNlCgkJewoJCQllbmRJbmRleCA9IDE7CgkJCQoJCQl3aGlsZShoZWFkLl9fbmV4dCAhPSBsYXN0UmVuZGVyYWJsZSkKCQkJewoJCQkJZW5kSW5kZXgrKzsKCQkJCWhlYWQgPSBoZWFkLl9fbmV4dDsKCQkJfQoJCX0KCX0KCWVsc2UKCXsKCQllbmRCYXRjaCA9IGxhc3RSZW5kZXJhYmxlOwoJfQoJCglpZihzdGFydEJhdGNoID09IGVuZEJhdGNoKQoJewoJCWlmKHN0YXJ0QmF0Y2ggaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2gpCgkJewoJCQlzdGFydEJhdGNoLnJlbmRlcihzdGFydEluZGV4LCBlbmRJbmRleCsxKTsKCQl9CgkJZWxzZQoJCXsKCQkJdGhpcy5yZW5kZXJTcGVjaWFsKHN0YXJ0QmF0Y2gsIHByb2plY3Rpb24pOwoJCX0KCQlyZXR1cm47Cgl9CgkKCS8vIG5vdyB3ZSBoYXZlIGZpcnN0IGFuZCBsYXN0IQoJc3RhcnRCYXRjaEluZGV4ID0gdGhpcy5iYXRjaHMuaW5kZXhPZihzdGFydEJhdGNoKTsKCWVuZEJhdGNoSW5kZXggPSB0aGlzLmJhdGNocy5pbmRleE9mKGVuZEJhdGNoKTsKCQoJLy8gRE8gdGhlIGZpcnN0IGJhdGNoCglpZihzdGFydEJhdGNoIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoKQoJewoJCXN0YXJ0QmF0Y2gucmVuZGVyKHN0YXJ0SW5kZXgpOwoJfQoJZWxzZQoJewoJCXRoaXMucmVuZGVyU3BlY2lhbChzdGFydEJhdGNoLCBwcm9qZWN0aW9uKTsKCX0KCQoJLy8gRE8gdGhlIG1pZGRsZSBiYXRjaHMuLgoJZm9yICh2YXIgaT1zdGFydEJhdGNoSW5kZXgrMTsgaSA8IGVuZEJhdGNoSW5kZXg7IGkrKykgCgl7CgkJcmVuZGVyYWJsZSA9IHRoaXMuYmF0Y2hzW2ldOwoJCgkJaWYocmVuZGVyYWJsZSBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaCkKCQl7CgkJCXRoaXMuYmF0Y2hzW2ldLnJlbmRlcigpOwoJCX0KCQllbHNlCgkJewoJCQl0aGlzLnJlbmRlclNwZWNpYWwocmVuZGVyYWJsZSwgcHJvamVjdGlvbik7CgkJfQoJfQoJCgkvLyBETyB0aGUgbGFzdCBiYXRjaC4uCglpZihlbmRCYXRjaCBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaCkKCXsKCQllbmRCYXRjaC5yZW5kZXIoMCwgZW5kSW5kZXgrMSk7Cgl9CgllbHNlCgl7CgkJdGhpcy5yZW5kZXJTcGVjaWFsKGVuZEJhdGNoLCBwcm9qZWN0aW9uKTsKCX0KfQoKLyoqCiAqIFJlbmRlcnMgYSBzcGVjaWZpYyByZW5kZXJhYmxlCiAqCiAqIEBtZXRob2QgcmVuZGVyU3BlY2lhbAogKiBAcGFyYW0gcmVuZGVyYWJsZSB7RGlzcGxheU9iamVjdH0KICogQHBhcmFtIHByb2plY3Rpb24ge09iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVuZGVyU3BlY2lhbCA9IGZ1bmN0aW9uKHJlbmRlcmFibGUsIHByb2plY3Rpb24pCnsKCQoJdmFyIHdvcmxkVmlzaWJsZSA9IHJlbmRlcmFibGUudmNvdW50ID09PSBQSVhJLnZpc2libGVDb3VudAoKCglpZihyZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5UaWxpbmdTcHJpdGUpCgl7CgkJaWYod29ybGRWaXNpYmxlKXRoaXMucmVuZGVyVGlsaW5nU3ByaXRlKHJlbmRlcmFibGUsIHByb2plY3Rpb24pOwoJfQoJZWxzZSBpZihyZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5TdHJpcCkKCXsKCQlpZih3b3JsZFZpc2libGUpdGhpcy5yZW5kZXJTdHJpcChyZW5kZXJhYmxlLCBwcm9qZWN0aW9uKTsKCX0KCWVsc2UgaWYocmVuZGVyYWJsZSBpbnN0YW5jZW9mIFBJWEkuQ3VzdG9tUmVuZGVyYWJsZSkKCXsKCQlpZih3b3JsZFZpc2libGUpIHJlbmRlcmFibGUucmVuZGVyV2ViR0wodGhpcywgcHJvamVjdGlvbik7Cgl9CgllbHNlIGlmKHJlbmRlcmFibGUgaW5zdGFuY2VvZiBQSVhJLkdyYXBoaWNzKQoJewoJCWlmKHdvcmxkVmlzaWJsZSAmJiByZW5kZXJhYmxlLnJlbmRlcmFibGUpIFBJWEkuV2ViR0xHcmFwaGljcy5yZW5kZXJHcmFwaGljcyhyZW5kZXJhYmxlLCBwcm9qZWN0aW9uKTsKCX0KCWVsc2UgaWYocmVuZGVyYWJsZSBpbnN0YW5jZW9mIFBJWEkuRmlsdGVyQmxvY2spCgl7CgkJdGhpcy5oYW5kbGVGaWx0ZXJCbG9jayhyZW5kZXJhYmxlLCBwcm9qZWN0aW9uKTsKCX0KfQoKZmxpcCA9IGZhbHNlOwp2YXIgbWFza1N0YWNrID0gW107CnZhciBtYXNrUG9zaXRpb24gPSAwOwoKLy92YXIgdXNlZE1hc2tTdGFjayA9IFtdOwoKUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5oYW5kbGVGaWx0ZXJCbG9jayA9IGZ1bmN0aW9uKGZpbHRlckJsb2NrLCBwcm9qZWN0aW9uKQp7CgkvKgoJICogZm9yIG5vdyBvbmx5IG1hc2tzIGFyZSBzdXBwb3J0ZWQuLgoJICovCgl2YXIgZ2wgPSBQSVhJLmdsOwoJCglpZihmaWx0ZXJCbG9jay5vcGVuKQoJewoJCWlmKGZpbHRlckJsb2NrLmRhdGEgaW5zdGFuY2VvZiBBcnJheSkKCQl7CgkJCXRoaXMuZmlsdGVyTWFuYWdlci5wdXNoRmlsdGVyKGZpbHRlckJsb2NrKTsKCQkJLy8gb2sgc28uLgoJCQkKCQl9CgkJZWxzZQoJCXsJCgkJCW1hc2tQb3NpdGlvbisrOwoKCQkJbWFza1N0YWNrLnB1c2goZmlsdGVyQmxvY2spCgkKCQkJZ2wuZW5hYmxlKGdsLlNURU5DSUxfVEVTVCk7CgkJCQoJCQlnbC5jb2xvck1hc2soZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UpOwoJCQkKCQkJZ2wuc3RlbmNpbEZ1bmMoZ2wuQUxXQVlTLDEsMSk7CgkJCWdsLnN0ZW5jaWxPcChnbC5LRUVQLGdsLktFRVAsZ2wuSU5DUik7CgkKCQkJUElYSS5XZWJHTEdyYXBoaWNzLnJlbmRlckdyYXBoaWNzKGZpbHRlckJsb2NrLmRhdGEsIHByb2plY3Rpb24pOwoJCQkKCQkJZ2wuY29sb3JNYXNrKHRydWUsIHRydWUsIHRydWUsIHRydWUpOwoJCQlnbC5zdGVuY2lsRnVuYyhnbC5OT1RFUVVBTCwwLG1hc2tTdGFjay5sZW5ndGgpOwoJCQlnbC5zdGVuY2lsT3AoZ2wuS0VFUCxnbC5LRUVQLGdsLktFRVApOwoJCX0KCX0KCWVsc2UKCXsKCQlpZihmaWx0ZXJCbG9jay5kYXRhIGluc3RhbmNlb2YgQXJyYXkpCgkJewoJCQl0aGlzLmZpbHRlck1hbmFnZXIucG9wRmlsdGVyKCk7CgkJfQoJCWVsc2UKCQl7CgkJCXZhciBtYXNrRGF0YSA9IG1hc2tTdGFjay5wb3AoZmlsdGVyQmxvY2spCgoKCQkJaWYobWFza0RhdGEpCgkJCXsKCQkJCWdsLmNvbG9yTWFzayhmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSk7CgkJCQoJCQkJZ2wuc3RlbmNpbEZ1bmMoZ2wuQUxXQVlTLDEsMSk7CgkJCQlnbC5zdGVuY2lsT3AoZ2wuS0VFUCxnbC5LRUVQLGdsLkRFQ1IpOwoKCQkJCVBJWEkuV2ViR0xHcmFwaGljcy5yZW5kZXJHcmFwaGljcyhtYXNrRGF0YS5kYXRhLCBwcm9qZWN0aW9uKTsKCQkJCgkJCQlnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7CgkJCQlnbC5zdGVuY2lsRnVuYyhnbC5OT1RFUVVBTCwwLG1hc2tTdGFjay5sZW5ndGgpOwoJCQkJZ2wuc3RlbmNpbE9wKGdsLktFRVAsZ2wuS0VFUCxnbC5LRUVQKTsKCQkJfTsKCgkJCWdsLmRpc2FibGUoZ2wuU1RFTkNJTF9URVNUKTsKCQl9Cgl9Cn0KCi8qKgogKiBVcGRhdGVzIGEgd2ViZ2wgdGV4dHVyZQogKgogKiBAbWV0aG9kIHVwZGF0ZVRleHR1cmUKICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnVwZGF0ZVRleHR1cmUgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0KQp7CgkKCS8vIFRPRE8gZGVmaW5pdGVseSBjYW4gb3B0aW1zZSB0aGlzIGZ1bmN0aW9uLi4KCQoJdGhpcy5yZW1vdmVPYmplY3QoZGlzcGxheU9iamVjdCk7CgkKCS8qCgkgKiAgTE9PSyBGT1IgVEhFIFBSRVZJT1VTIFJFTkRFUkFCTEUKCSAqICBUaGlzIHBhcnQgbG9va3MgZm9yIHRoZSBjbG9zZXN0IHByZXZpb3VzIHNwcml0ZSB0aGF0IGNhbiBnbyBpbnRvIGEgYmF0Y2gKCSAqICBJdCBrZWVwcyBnb2luZyBiYWNrIHVudGlsIGl0IGZpbmRzIGEgc3ByaXRlIG9yIHRoZSBzdGFnZQoJICovCgl2YXIgcHJldmlvdXNSZW5kZXJhYmxlID0gZGlzcGxheU9iamVjdC5maXJzdDsKCXdoaWxlKHByZXZpb3VzUmVuZGVyYWJsZSAhPSB0aGlzLnJvb3QpCgl7CgkJcHJldmlvdXNSZW5kZXJhYmxlID0gcHJldmlvdXNSZW5kZXJhYmxlLl9pUHJldjsKCQlpZihwcmV2aW91c1JlbmRlcmFibGUucmVuZGVyYWJsZSAmJiBwcmV2aW91c1JlbmRlcmFibGUuX19yZW5kZXJHcm91cClicmVhazsKCX0KCQoJLyoKCSAqICBMT09LIEZPUiBUSEUgTkVYVCBTUFJJVEUKCSAqICBUaGlzIHBhcnQgbG9va3MgZm9yIHRoZSBjbG9zZXN0IG5leHQgc3ByaXRlIHRoYXQgY2FuIGdvIGludG8gYSBiYXRjaAoJICogIGl0IGtlZXBzIGxvb2tpbmcgdW50aWwgaXQgZmluZHMgYSBzcHJpdGUgb3IgZ2V0cyB0byB0aGUgZW5kIG9mIHRoZSBkaXNwbGF5CgkgKiAgc2NlbmUgZ3JhcGgKCSAqLwoJdmFyIG5leHRSZW5kZXJhYmxlID0gZGlzcGxheU9iamVjdC5sYXN0OwoJd2hpbGUobmV4dFJlbmRlcmFibGUuX2lOZXh0KQoJewoJCW5leHRSZW5kZXJhYmxlID0gbmV4dFJlbmRlcmFibGUuX2lOZXh0OwoJCWlmKG5leHRSZW5kZXJhYmxlLnJlbmRlcmFibGUgJiYgbmV4dFJlbmRlcmFibGUuX19yZW5kZXJHcm91cClicmVhazsKCX0KCQoJdGhpcy5pbnNlcnRPYmplY3QoZGlzcGxheU9iamVjdCwgcHJldmlvdXNSZW5kZXJhYmxlLCBuZXh0UmVuZGVyYWJsZSk7Cn0KCi8qKgogKiBBZGRzIGZpbHRlciBibG9ja3MKICoKICogQG1ldGhvZCBhZGRGaWx0ZXJCbG9ja3MKICogQHBhcmFtIHN0YXJ0IHtGaWx0ZXJCbG9ja30KICogQHBhcmFtIGVuZCB7RmlsdGVyQmxvY2t9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLmFkZEZpbHRlckJsb2NrcyA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpCnsKCXN0YXJ0Ll9fcmVuZGVyR3JvdXAgPSB0aGlzOwoJZW5kLl9fcmVuZGVyR3JvdXAgPSB0aGlzOwoJLyoKCSAqICBMT09LIEZPUiBUSEUgUFJFVklPVVMgUkVOREVSQUJMRQoJICogIFRoaXMgcGFydCBsb29rcyBmb3IgdGhlIGNsb3Nlc3QgcHJldmlvdXMgc3ByaXRlIHRoYXQgY2FuIGdvIGludG8gYSBiYXRjaAoJICogIEl0IGtlZXBzIGdvaW5nIGJhY2sgdW50aWwgaXQgZmluZHMgYSBzcHJpdGUgb3IgdGhlIHN0YWdlCgkgKi8KCXZhciBwcmV2aW91c1JlbmRlcmFibGUgPSBzdGFydDsKCXdoaWxlKHByZXZpb3VzUmVuZGVyYWJsZSAhPSB0aGlzLnJvb3QuZmlyc3QpCgl7CgkJcHJldmlvdXNSZW5kZXJhYmxlID0gcHJldmlvdXNSZW5kZXJhYmxlLl9pUHJldjsKCQlpZihwcmV2aW91c1JlbmRlcmFibGUucmVuZGVyYWJsZSAmJiBwcmV2aW91c1JlbmRlcmFibGUuX19yZW5kZXJHcm91cClicmVhazsKCX0KCXRoaXMuaW5zZXJ0QWZ0ZXIoc3RhcnQsIHByZXZpb3VzUmVuZGVyYWJsZSk7CgkJCgkvKgoJICogIExPT0sgRk9SIFRIRSBORVhUIFNQUklURQoJICogIFRoaXMgcGFydCBsb29rcyBmb3IgdGhlIGNsb3Nlc3QgbmV4dCBzcHJpdGUgdGhhdCBjYW4gZ28gaW50byBhIGJhdGNoCgkgKiAgaXQga2VlcHMgbG9va2luZyB1bnRpbCBpdCBmaW5kcyBhIHNwcml0ZSBvciBnZXRzIHRvIHRoZSBlbmQgb2YgdGhlIGRpc3BsYXkKCSAqICBzY2VuZSBncmFwaAoJICovCgl2YXIgcHJldmlvdXNSZW5kZXJhYmxlMiA9IGVuZDsKCXdoaWxlKHByZXZpb3VzUmVuZGVyYWJsZTIgIT0gdGhpcy5yb290LmZpcnN0KQoJewoJCXByZXZpb3VzUmVuZGVyYWJsZTIgPSBwcmV2aW91c1JlbmRlcmFibGUyLl9pUHJldjsKCQlpZihwcmV2aW91c1JlbmRlcmFibGUyLnJlbmRlcmFibGUgJiYgcHJldmlvdXNSZW5kZXJhYmxlMi5fX3JlbmRlckdyb3VwKWJyZWFrOwoJfQoJdGhpcy5pbnNlcnRBZnRlcihlbmQsIHByZXZpb3VzUmVuZGVyYWJsZTIpOwp9CgovKioKICogUmVtb3ZlIGZpbHRlciBibG9ja3MKICoKICogQG1ldGhvZCByZW1vdmVGaWx0ZXJCbG9ja3MKICogQHBhcmFtIHN0YXJ0IHtGaWx0ZXJCbG9ja30KICogQHBhcmFtIGVuZCB7RmlsdGVyQmxvY2t9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnJlbW92ZUZpbHRlckJsb2NrcyA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpCnsKCXRoaXMucmVtb3ZlT2JqZWN0KHN0YXJ0KTsKCXRoaXMucmVtb3ZlT2JqZWN0KGVuZCk7Cn0KCi8qKgogKiBBZGRzIGEgZGlzcGxheSBvYmplY3QgYW5kIGNoaWxkcmVuIHRvIHRoZSB3ZWJnbCBjb250ZXh0CiAqCiAqIEBtZXRob2QgYWRkRGlzcGxheU9iamVjdEFuZENoaWxkcmVuCiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5hZGREaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4gPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0KQp7CglpZihkaXNwbGF5T2JqZWN0Ll9fcmVuZGVyR3JvdXApZGlzcGxheU9iamVjdC5fX3JlbmRlckdyb3VwLnJlbW92ZURpc3BsYXlPYmplY3RBbmRDaGlsZHJlbihkaXNwbGF5T2JqZWN0KTsKCQoJLyoKCSAqICBMT09LIEZPUiBUSEUgUFJFVklPVVMgUkVOREVSQUJMRQoJICogIFRoaXMgcGFydCBsb29rcyBmb3IgdGhlIGNsb3Nlc3QgcHJldmlvdXMgc3ByaXRlIHRoYXQgY2FuIGdvIGludG8gYSBiYXRjaAoJICogIEl0IGtlZXBzIGdvaW5nIGJhY2sgdW50aWwgaXQgZmluZHMgYSBzcHJpdGUgb3IgdGhlIHN0YWdlCgkgKi8KCQoJdmFyIHByZXZpb3VzUmVuZGVyYWJsZSA9IGRpc3BsYXlPYmplY3QuZmlyc3Q7Cgl3aGlsZShwcmV2aW91c1JlbmRlcmFibGUgIT0gdGhpcy5yb290LmZpcnN0KQoJewoJCXByZXZpb3VzUmVuZGVyYWJsZSA9IHByZXZpb3VzUmVuZGVyYWJsZS5faVByZXY7CgkJaWYocHJldmlvdXNSZW5kZXJhYmxlLnJlbmRlcmFibGUgJiYgcHJldmlvdXNSZW5kZXJhYmxlLl9fcmVuZGVyR3JvdXApYnJlYWs7Cgl9CgkKCS8qCgkgKiAgTE9PSyBGT1IgVEhFIE5FWFQgU1BSSVRFCgkgKiAgVGhpcyBwYXJ0IGxvb2tzIGZvciB0aGUgY2xvc2VzdCBuZXh0IHNwcml0ZSB0aGF0IGNhbiBnbyBpbnRvIGEgYmF0Y2gKCSAqICBpdCBrZWVwcyBsb29raW5nIHVudGlsIGl0IGZpbmRzIGEgc3ByaXRlIG9yIGdldHMgdG8gdGhlIGVuZCBvZiB0aGUgZGlzcGxheQoJICogIHNjZW5lIGdyYXBoCgkgKi8KCXZhciBuZXh0UmVuZGVyYWJsZSA9IGRpc3BsYXlPYmplY3QubGFzdDsKCXdoaWxlKG5leHRSZW5kZXJhYmxlLl9pTmV4dCkKCXsKCQluZXh0UmVuZGVyYWJsZSA9IG5leHRSZW5kZXJhYmxlLl9pTmV4dDsKCQlpZihuZXh0UmVuZGVyYWJsZS5yZW5kZXJhYmxlICYmIG5leHRSZW5kZXJhYmxlLl9fcmVuZGVyR3JvdXApYnJlYWs7Cgl9CgkKCS8vIG9uZSB0aGUgZGlzcGxheSBvYmplY3QgaGl0cyB0aGlzLiB3ZSBjYW4gYnJlYWsgdGhlIGxvb3AJCgkKCXZhciB0ZW1wT2JqZWN0ID0gZGlzcGxheU9iamVjdC5maXJzdDsKCXZhciB0ZXN0T2JqZWN0ID0gZGlzcGxheU9iamVjdC5sYXN0Ll9pTmV4dDsKCWRvCQoJewoJCXRlbXBPYmplY3QuX19yZW5kZXJHcm91cCA9IHRoaXM7CgkJCgkJaWYodGVtcE9iamVjdC5yZW5kZXJhYmxlKQoJCXsKCQkKCQkJdGhpcy5pbnNlcnRPYmplY3QodGVtcE9iamVjdCwgcHJldmlvdXNSZW5kZXJhYmxlLCBuZXh0UmVuZGVyYWJsZSk7CgkJCXByZXZpb3VzUmVuZGVyYWJsZSA9IHRlbXBPYmplY3Q7CgkJfQoJCQoJCXRlbXBPYmplY3QgPSB0ZW1wT2JqZWN0Ll9pTmV4dDsKCX0KCXdoaWxlKHRlbXBPYmplY3QgIT0gdGVzdE9iamVjdCkKfQoKLyoqCiAqIFJlbW92ZXMgYSBkaXNwbGF5IG9iamVjdCBhbmQgY2hpbGRyZW4gdG8gdGhlIHdlYmdsIGNvbnRleHQKICoKICogQG1ldGhvZCByZW1vdmVEaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4KICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnJlbW92ZURpc3BsYXlPYmplY3RBbmRDaGlsZHJlbiA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QpCnsKCWlmKGRpc3BsYXlPYmplY3QuX19yZW5kZXJHcm91cCAhPSB0aGlzKXJldHVybjsKCQovLwl2YXIgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuZmlyc3Q7Cgl2YXIgbGFzdE9iamVjdCA9IGRpc3BsYXlPYmplY3QubGFzdDsKCWRvCQoJewoJCWRpc3BsYXlPYmplY3QuX19yZW5kZXJHcm91cCA9IG51bGw7CgkJaWYoZGlzcGxheU9iamVjdC5yZW5kZXJhYmxlKXRoaXMucmVtb3ZlT2JqZWN0KGRpc3BsYXlPYmplY3QpOwoJCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKCX0KCXdoaWxlKGRpc3BsYXlPYmplY3QpCn0KCi8qKgogKiBJbnNlcnRzIGEgZGlzcGxheU9iamVjdCBpbnRvIHRoZSBsaW5rZWQgbGlzdAogKgogKiBAbWV0aG9kIGluc2VydE9iamVjdAogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0KICogQHBhcmFtIHByZXZpb3VzT2JqZWN0IHtEaXNwbGF5T2JqZWN0fQogKiBAcGFyYW0gbmV4dE9iamVjdCB7RGlzcGxheU9iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUuaW5zZXJ0T2JqZWN0ID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcHJldmlvdXNPYmplY3QsIG5leHRPYmplY3QpCnsKCS8vIHdoaWxlIGxvb3BpbmcgYmVsb3cgVEhFIE9CSkVDVCBNQVkgTk9UIEhBVkUgQkVFTiBBRERFRAoJdmFyIHByZXZpb3VzU3ByaXRlID0gcHJldmlvdXNPYmplY3Q7Cgl2YXIgbmV4dFNwcml0ZSA9IG5leHRPYmplY3Q7CgkKCS8qCgkgKiBzbyBub3cgd2UgaGF2ZSB0aGUgbmV4dCByZW5kZXJhYmxlIGFuZCB0aGUgcHJldmlvdXMgcmVuZGVyYWJsZQoJICogCgkgKi8KCWlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKCXsKCQl2YXIgcHJldmlvdXNCYXRjaAoJCXZhciBuZXh0QmF0Y2gKCQkKCQlpZihwcmV2aW91c1Nwcml0ZSBpbnN0YW5jZW9mIFBJWEkuU3ByaXRlKQoJCXsKCQkJcHJldmlvdXNCYXRjaCA9IHByZXZpb3VzU3ByaXRlLmJhdGNoOwoJCQlpZihwcmV2aW91c0JhdGNoKQoJCQl7CgkJCQlpZihwcmV2aW91c0JhdGNoLnRleHR1cmUgPT0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmJhc2VUZXh0dXJlICYmIHByZXZpb3VzQmF0Y2guYmxlbmRNb2RlID09IGRpc3BsYXlPYmplY3QuYmxlbmRNb2RlKQoJCQkJewoJCQkJCXByZXZpb3VzQmF0Y2guaW5zZXJ0QWZ0ZXIoZGlzcGxheU9iamVjdCwgcHJldmlvdXNTcHJpdGUpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoJCX0KCQllbHNlCgkJewoJCQkvLyBUT0RPIHJld29yZCEKCQkJcHJldmlvdXNCYXRjaCA9IHByZXZpb3VzU3ByaXRlOwoJCX0KCQoJCWlmKG5leHRTcHJpdGUpCgkJewoJCQlpZihuZXh0U3ByaXRlIGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgkJCXsKCQkJCW5leHRCYXRjaCA9IG5leHRTcHJpdGUuYmF0Y2g7CgkJCQoJCQkJLy9iYXRjaCBtYXkgbm90IGV4aXN0IGlmIGl0ZW0gd2FzIGFkZGVkIHRvIHRoZSBkaXNwbGF5IGxpc3QgYnV0IG5vdCB0byB0aGUgd2ViR0wKCQkJCWlmKG5leHRCYXRjaCkKCQkJCXsKCQkJCQlpZihuZXh0QmF0Y2gudGV4dHVyZSA9PSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuYmFzZVRleHR1cmUgJiYgbmV4dEJhdGNoLmJsZW5kTW9kZSA9PSBkaXNwbGF5T2JqZWN0LmJsZW5kTW9kZSkKCQkJCQl7CgkJCQkJCW5leHRCYXRjaC5pbnNlcnRCZWZvcmUoZGlzcGxheU9iamVjdCwgbmV4dFNwcml0ZSk7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQkJZWxzZQoJCQkJCXsKCQkJCQkJaWYobmV4dEJhdGNoID09IHByZXZpb3VzQmF0Y2gpCgkJCQkJCXsKCQkJCQkJCS8vIFRIRVJFIElTIEEgU1BMSVQgSU4gVEhJUyBCQVRDSCEgLy8KCQkJCQkJCXZhciBzcGxpdEJhdGNoID0gcHJldmlvdXNCYXRjaC5zcGxpdChuZXh0U3ByaXRlKTsKCQkJCQkJCS8vIENPT0whCgkJCQkJCQkvLyBhZGQgaXQgYmFjayBpbnRvIHRoZSBhcnJheQkKCQkJCQkJCS8qCgkJCQkJCQkgKiBPT1BTIQoJCQkJCQkJICogc2VlbXMgdGhlIG5ldyBzcHJpdGUgaXMgaW4gdGhlIG1pZGRsZSBvZiBhIGJhdGNoCgkJCQkJCQkgKiBsZXRzIHNwbGl0IGl0Li4gCgkJCQkJCQkgKi8KCQkJCQkJCXZhciBiYXRjaCA9IFBJWEkuV2ViR0xSZW5kZXJlci5nZXRCYXRjaCgpOwoKCQkJCQkJCXZhciBpbmRleCA9IHRoaXMuYmF0Y2hzLmluZGV4T2YoIHByZXZpb3VzQmF0Y2ggKTsKCQkJCQkJCWJhdGNoLmluaXQoZGlzcGxheU9iamVjdCk7CgkJCQkJCQl0aGlzLmJhdGNocy5zcGxpY2UoaW5kZXgrMSwgMCwgYmF0Y2gsIHNwbGl0QmF0Y2gpOwoJCQkJCQkJCgkJCQkJCQlyZXR1cm47CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkvLyBUT0RPIHJlLXdvcmQhCgkJCQkKCQkJCW5leHRCYXRjaCA9IG5leHRTcHJpdGU7CgkJCX0KCQl9CgkJCgkJLyoKCQkgKiBsb29rcyBsaWtlIGl0IGRvZXMgbm90IGJlbG9uZyB0byBhbnkgYmF0Y2ghCgkJICogYnV0IGlzIGFsc28gbm90IGludGVyc2VjdGluZyBvbmUuLgoJCSAqIHRpbWUgdG8gY3JlYXRlIGFuZXcgb25lIQoJCSAqLwoJCQoJCXZhciBiYXRjaCA9ICBQSVhJLldlYkdMUmVuZGVyZXIuZ2V0QmF0Y2goKTsKCQliYXRjaC5pbml0KGRpc3BsYXlPYmplY3QpOwoKCQlpZihwcmV2aW91c0JhdGNoKSAvLyBpZiB0aGlzIGlzIGludmFsaWQgaXQgbWVhbnMgCgkJewoJCQl2YXIgaW5kZXggPSB0aGlzLmJhdGNocy5pbmRleE9mKCBwcmV2aW91c0JhdGNoICk7CgkJCXRoaXMuYmF0Y2hzLnNwbGljZShpbmRleCsxLCAwLCBiYXRjaCk7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMuYmF0Y2hzLnB1c2goYmF0Y2gpOwoJCX0KCQkKCQlyZXR1cm47Cgl9CgllbHNlIGlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlRpbGluZ1Nwcml0ZSkKCXsKCQkKCQkvLyBhZGQgdG8gYSBiYXRjaCEhCgkJdGhpcy5pbml0VGlsaW5nU3ByaXRlKGRpc3BsYXlPYmplY3QpOwoJLy8JdGhpcy5iYXRjaHMucHVzaChkaXNwbGF5T2JqZWN0KTsKCQkKCX0KCWVsc2UgaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuU3RyaXApCgl7CgkJLy8gYWRkIHRvIGEgYmF0Y2ghIQoJCXRoaXMuaW5pdFN0cmlwKGRpc3BsYXlPYmplY3QpOwoJLy8JdGhpcy5iYXRjaHMucHVzaChkaXNwbGF5T2JqZWN0KTsKCX0KCWVsc2UgaWYoZGlzcGxheU9iamVjdCkvLyBpbnN0YW5jZW9mIFBJWEkuR3JhcGhpY3MpCgl7CgkJLy9kaXNwbGF5T2JqZWN0LmluaXRXZWJHTCh0aGlzKTsKCQkKCQkvLyBhZGQgdG8gYSBiYXRjaCEhCgkJLy90aGlzLmluaXRTdHJpcChkaXNwbGF5T2JqZWN0KTsKCQkvL3RoaXMuYmF0Y2hzLnB1c2goZGlzcGxheU9iamVjdCk7Cgl9CgkKCXRoaXMuaW5zZXJ0QWZ0ZXIoZGlzcGxheU9iamVjdCwgcHJldmlvdXNTcHJpdGUpOwoJCQkKCS8vIGluc2VydCBhbmQgU1BMSVQhCgp9CgovKioKICogSW5zZXJ0cyBhIGRpc3BsYXlPYmplY3QgaW50byB0aGUgbGlua2VkIGxpc3QKICoKICogQG1ldGhvZCBpbnNlcnRBZnRlcgogKiBAcGFyYW0gaXRlbSB7RGlzcGxheU9iamVjdH0KICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9IFRoZSBvYmplY3QgdG8gaW5zZXJ0CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLmluc2VydEFmdGVyID0gZnVuY3Rpb24oaXRlbSwgZGlzcGxheU9iamVjdCkKewoJaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuU3ByaXRlKQoJewoJCXZhciBwcmV2aW91c0JhdGNoID0gZGlzcGxheU9iamVjdC5iYXRjaDsKCQkKCQlpZihwcmV2aW91c0JhdGNoKQoJCXsKCQkJLy8gc28gdGhpcyBvYmplY3QgaXMgaW4gYSBiYXRjaCEKCQkJCgkJCS8vIGlzIGl0IG5vdD8gbmVlZCB0byBzcGxpdCB0aGUgYmF0Y2gKCQkJaWYocHJldmlvdXNCYXRjaC50YWlsID09IGRpc3BsYXlPYmplY3QpCgkJCXsKCQkJCS8vIGlzIGl0IHRhaWw/IGluc2VydCBpbiB0byBiYXRjaHMJCgkJCQl2YXIgaW5kZXggPSB0aGlzLmJhdGNocy5pbmRleE9mKCBwcmV2aW91c0JhdGNoICk7CgkJCQl0aGlzLmJhdGNocy5zcGxpY2UoaW5kZXgrMSwgMCwgaXRlbSk7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkvLyBUT0RPIE1PRElGWSBBREQgLyBSRU1PVkUgQ0hJTEQgVE8gQUNDT1VOVCBGT1IgRklMVEVSUyAoYWxzbyBnZXQgcHJldiBhbmQgbmV4dCkgLy8KCQkJCQoJCQkJLy8gVEhFUkUgSVMgQSBTUExJVCBJTiBUSElTIEJBVENIISAvLwoJCQkJdmFyIHNwbGl0QmF0Y2ggPSBwcmV2aW91c0JhdGNoLnNwbGl0KGRpc3BsYXlPYmplY3QuX19uZXh0KTsKCQkJCQoJCQkJLy8gQ09PTCEKCQkJCS8vIGFkZCBpdCBiYWNrIGludG8gdGhlIGFycmF5CQoJCQkJLyoKCQkJCSAqIE9PUFMhCgkJCQkgKiBzZWVtcyB0aGUgbmV3IHNwcml0ZSBpcyBpbiB0aGUgbWlkZGxlIG9mIGEgYmF0Y2gKCQkJCSAqIGxldHMgc3BsaXQgaXQuLiAKCQkJCSAqLwoJCQkJdmFyIGluZGV4ID0gdGhpcy5iYXRjaHMuaW5kZXhPZiggcHJldmlvdXNCYXRjaCApOwoJCQkJdGhpcy5iYXRjaHMuc3BsaWNlKGluZGV4KzEsIDAsIGl0ZW0sIHNwbGl0QmF0Y2gpOwoJCQl9CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMuYmF0Y2hzLnB1c2goaXRlbSk7CgkJfQoJfQoJZWxzZQoJewoJCXZhciBpbmRleCA9IHRoaXMuYmF0Y2hzLmluZGV4T2YoIGRpc3BsYXlPYmplY3QgKTsKCQl0aGlzLmJhdGNocy5zcGxpY2UoaW5kZXgrMSwgMCwgaXRlbSk7Cgl9Cn0KCi8qKgogKiBSZW1vdmVzIGEgZGlzcGxheU9iamVjdCBmcm9tIHRoZSBsaW5rZWQgbGlzdAogKgogKiBAbWV0aG9kIHJlbW92ZU9iamVjdAogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0gVGhlIG9iamVjdCB0byByZW1vdmUKICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVtb3ZlT2JqZWN0ID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCkKewoJLy8gbG9vcCB0aHJvdWdoIGNoaWxkcmVuLi4KCS8vIGRpc3BsYXkgb2JqZWN0IC8vCgkKCS8vIGFkZCBhIGNoaWxkIGZyb20gdGhlIHJlbmRlciBncm91cC4uCgkvLyByZW1vdmUgaXQgYW5kIGFsbCBpdHMgY2hpbGRyZW4hCgkvL2Rpc3BsYXlPYmplY3QuY2FjaGVWaXNpYmxlID0gZmFsc2U7Ly9kaXNwbGF5T2JqZWN0LnZpc2libGU7CgoJLyoKCSAqIHJlbW92aW5nIGlzIGEgbG90IHF1aWNrZXIuLgoJICogCgkgKi8KCXZhciBiYXRjaFRvUmVtb3ZlOwoJCglpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgl7CgkJLy8gc2hvdWxkIGFsd2F5cyBoYXZlIGEgYmF0Y2ghCgkJdmFyIGJhdGNoID0gZGlzcGxheU9iamVjdC5iYXRjaDsKCQlpZighYmF0Y2gpcmV0dXJuOyAvLyB0aGlzIG1lYW5zIHRoZSBkaXNwbGF5IGxpc3QgaGFzIGJlZW4gYWx0ZXJlZCBiZWZyZSByZW5kZXJpbmcKCQkKCQliYXRjaC5yZW1vdmUoZGlzcGxheU9iamVjdCk7CgkJCgkJaWYoYmF0Y2guc2l6ZT09MCkKCQl7CgkJCWJhdGNoVG9SZW1vdmUgPSBiYXRjaDsKCQl9Cgl9CgllbHNlCgl7CgkJYmF0Y2hUb1JlbW92ZSA9IGRpc3BsYXlPYmplY3Q7Cgl9CgkKCS8qCgkgKiBMb29rcyBsaWtlIHRoZXJlIGlzIHNvbXRoaW5nIHRoYXQgbmVlZHMgcmVtb3ZpbmchCgkgKi8KCWlmKGJhdGNoVG9SZW1vdmUpCQoJewoJCXZhciBpbmRleCA9IHRoaXMuYmF0Y2hzLmluZGV4T2YoIGJhdGNoVG9SZW1vdmUgKTsKCQlpZihpbmRleCA9PSAtMSlyZXR1cm47Ly8gdGhpcyBtZWFucyBpdCB3YXMgYWRkZWQgdGhlbiByZW1vdmVkIGJlZm9yZSByZW5kZXJlZAoJCQoJCS8vIG9rIHNvLi4gY2hlY2sgdG8gc2VlIGlmIHlvdSBhZGphY2VudCBiYXRjaHMgc2hvdWxkIGJlIGpvaW5lZC4KCQkvLyBUT0RPIG1heSBvcHRpbWlzZT8KCQlpZihpbmRleCA9PSAwIHx8IGluZGV4ID09IHRoaXMuYmF0Y2hzLmxlbmd0aC0xKQoJCXsKCQkJLy8gd2hhIC0gZXZhISBqdXN0IGdldCBvZiB0aGUgZW1wdHkgYmF0Y2ghCgkJCXRoaXMuYmF0Y2hzLnNwbGljZShpbmRleCwgMSk7CgkJCWlmKGJhdGNoVG9SZW1vdmUgaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2gpUElYSS5XZWJHTFJlbmRlcmVyLnJldHVybkJhdGNoKGJhdGNoVG9SZW1vdmUpOwoJCQoJCQlyZXR1cm47CgkJfQoJCQoJCWlmKHRoaXMuYmF0Y2hzW2luZGV4LTFdIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoICYmIHRoaXMuYmF0Y2hzW2luZGV4KzFdIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoKQoJCXsKCQkJaWYodGhpcy5iYXRjaHNbaW5kZXgtMV0udGV4dHVyZSA9PSB0aGlzLmJhdGNoc1tpbmRleCsxXS50ZXh0dXJlICYmIHRoaXMuYmF0Y2hzW2luZGV4LTFdLmJsZW5kTW9kZSA9PSB0aGlzLmJhdGNoc1tpbmRleCsxXS5ibGVuZE1vZGUpCgkJCXsKCQkJCS8vY29uc29sZS5sb2coIk1FUkdFIikKCQkJCXRoaXMuYmF0Y2hzW2luZGV4LTFdLm1lcmdlKHRoaXMuYmF0Y2hzW2luZGV4KzFdKTsKCQkJCQoJCQkJaWYoYmF0Y2hUb1JlbW92ZSBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaClQSVhJLldlYkdMUmVuZGVyZXIucmV0dXJuQmF0Y2goYmF0Y2hUb1JlbW92ZSk7CgkJCQlQSVhJLldlYkdMUmVuZGVyZXIucmV0dXJuQmF0Y2godGhpcy5iYXRjaHNbaW5kZXgrMV0pOwoJCQkJdGhpcy5iYXRjaHMuc3BsaWNlKGluZGV4LCAyKTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCQkKCQl0aGlzLmJhdGNocy5zcGxpY2UoaW5kZXgsIDEpOwoJCWlmKGJhdGNoVG9SZW1vdmUgaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2gpUElYSS5XZWJHTFJlbmRlcmVyLnJldHVybkJhdGNoKGJhdGNoVG9SZW1vdmUpOwoJfQp9CgoKLyoqCiAqIEluaXRpYWxpemVzIGEgdGlsaW5nIHNwcml0ZQogKgogKiBAbWV0aG9kIGluaXRUaWxpbmdTcHJpdGUKICogQHBhcmFtIHNwcml0ZSB7VGlsaW5nU3ByaXRlfSBUaGUgdGlsaW5nIHNwcml0ZSB0byBpbml0aWFsaXplCiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLmluaXRUaWxpbmdTcHJpdGUgPSBmdW5jdGlvbihzcHJpdGUpCnsKCXZhciBnbCA9IHRoaXMuZ2w7CgoJLy8gbWFrZSB0aGUgdGV4dHVyZSB0aWxhYmxlLi4KCQkJCglzcHJpdGUudmVydGljaWVzID0gbmV3IEZsb2F0MzJBcnJheShbMCwgMCwKCQkJCQkJCQkJCSAgc3ByaXRlLndpZHRoLCAwLAoJCQkJCQkJCQkJICBzcHJpdGUud2lkdGgsICBzcHJpdGUuaGVpZ2h0LAoJCQkJCQkJCQkJIDAsICBzcHJpdGUuaGVpZ2h0XSk7CgkJCQkJCglzcHJpdGUudXZzID0gbmV3IEZsb2F0MzJBcnJheShbMCwgMCwKCQkJCQkJCQkJMSwgMCwKCQkJCQkJCQkJMSwgMSwKCQkJCQkJCQkJMCwgMV0pOwoJCQkJCglzcHJpdGUuY29sb3JzID0gbmV3IEZsb2F0MzJBcnJheShbMSwxLDEsMV0pOwoJCglzcHJpdGUuaW5kaWNlcyA9ICBuZXcgVWludDE2QXJyYXkoWzAsIDEsIDMsMl0pLy8sIDJdKTsKCQoJc3ByaXRlLl92ZXJ0ZXhCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCXNwcml0ZS5faW5kZXhCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCXNwcml0ZS5fdXZCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCXNwcml0ZS5fY29sb3JCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCQkJCQkJCglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3ByaXRlLl92ZXJ0ZXhCdWZmZXIpOwoJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHNwcml0ZS52ZXJ0aWNpZXMsIGdsLlNUQVRJQ19EUkFXKTsKCglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3ByaXRlLl91dkJ1ZmZlcik7CiAgICBnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgIHNwcml0ZS51dnMsIGdsLkRZTkFNSUNfRFJBVyk7CgogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHNwcml0ZS5fY29sb3JCdWZmZXIpOwoJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHNwcml0ZS5jb2xvcnMsIGdsLlNUQVRJQ19EUkFXKTsKCiAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBzcHJpdGUuX2luZGV4QnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHNwcml0ZS5pbmRpY2VzLCBnbC5TVEFUSUNfRFJBVyk7CiAgICAKLy8gICAgcmV0dXJuICggKHggPiAwKSAmJiAoKHggJiAoeCAtIDEpKSA9PSAwKSApOwoKCWlmKHNwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpCgl7CiAgICAJZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CiAgICAJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuUkVQRUFUKTsKCQlnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5SRVBFQVQpOwoJCXNwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLl9wb3dlck9mMiA9IHRydWU7Cgl9CgllbHNlCgl7CgkJc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuX3Bvd2VyT2YyID0gdHJ1ZTsKCX0KfQoKLyoqCiAqIFJlbmRlcnMgYSBTdHJpcAogKgogKiBAbWV0aG9kIHJlbmRlclN0cmlwCiAqIEBwYXJhbSBzdHJpcCB7U3RyaXB9IFRoZSBzdHJpcCB0byByZW5kZXIKICogQHBhcmFtIHByb2plY3Rpb24ge09iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVuZGVyU3RyaXAgPSBmdW5jdGlvbihzdHJpcCwgcHJvamVjdGlvbikKewoJdmFyIGdsID0gdGhpcy5nbDsKCglQSVhJLmFjdGl2YXRlU3RyaXBTaGFkZXIoKTsKCgl2YXIgc2hhZGVyID0gUElYSS5zdHJpcFNoYWRlcjsKCgl2YXIgcHJvZ3JhbSA9IHNoYWRlci5wcm9ncmFtOwoJCgl2YXIgbSA9IFBJWEkubWF0My5jbG9uZShzdHJpcC53b3JsZFRyYW5zZm9ybSk7CgkKCVBJWEkubWF0My50cmFuc3Bvc2UobSk7CgkKLy8JY29uc29sZS5sb2cocHJvamVjdGlvbikKCS8vIHNldCB0aGUgbWF0cml4IHRyYW5zZm9ybSBmb3IgdGhlIAogCWdsLnVuaWZvcm1NYXRyaXgzZnYoc2hhZGVyLnRyYW5zbGF0aW9uTWF0cml4LCBmYWxzZSwgbSk7CglnbC51bmlmb3JtMmYoc2hhZGVyLnByb2plY3Rpb25WZWN0b3IsIHByb2plY3Rpb24ueCwgcHJvamVjdGlvbi55KTsKCWdsLnVuaWZvcm0yZihzaGFkZXIub2Zmc2V0VmVjdG9yLCAtUElYSS5vZmZzZXQueCwgLVBJWEkub2Zmc2V0LnkpOwoJCglnbC51bmlmb3JtMWYoc2hhZGVyLmFscGhhLCBzdHJpcC53b3JsZEFscGhhKTsKCgkvKgoJaWYoc3RyaXAuYmxlbmRNb2RlID09IFBJWEkuYmxlbmRNb2Rlcy5OT1JNQUwpCgl7CgkJZ2wuYmxlbmRGdW5jKGdsLk9ORSwgZ2wuT05FX01JTlVTX1NSQ19BTFBIQSk7Cgl9CgllbHNlCgl7CgkJZ2wuYmxlbmRGdW5jKGdsLk9ORSwgZ2wuT05FX01JTlVTX1NSQ19DT0xPUik7Cgl9CgkqLwoJCgkvL2NvbnNvbGUubG9nKCIhISIpCglpZighc3RyaXAuZGlydHkpCgl7CQoJCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fdmVydGV4QnVmZmVyKTsKCQlnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgMCwgc3RyaXAudmVydGljaWVzKQoJICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbiwgMiwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKCQkKCQkvLyB1cGRhdGUgdGhlIHV2cwoJICAgCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fdXZCdWZmZXIpOwoJICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmFUZXh0dXJlQ29vcmQsIDIsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgkJCQoJICAgIGdsLmFjdGl2ZVRleHR1cmUoZ2wuVEVYVFVSRTApOwoJICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHN0cmlwLnRleHR1cmUuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CgkJCgkJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl9jb2xvckJ1ZmZlcik7CgkgICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXIuY29sb3JBdHRyaWJ1dGUsIDEsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgkJCgkJLy8gZG9udCBuZWVkIHRvIHVwbG9hZCEKCSAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBzdHJpcC5faW5kZXhCdWZmZXIpOwoJfQoJZWxzZQoJewoJCXN0cmlwLmRpcnR5ID0gZmFsc2U7CgkJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl92ZXJ0ZXhCdWZmZXIpOwoJCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC52ZXJ0aWNpZXMsIGdsLlNUQVRJQ19EUkFXKQoJICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbiwgMiwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKCQkKCQkvLyB1cGRhdGUgdGhlIHV2cwoJICAgCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fdXZCdWZmZXIpOwoJICAgCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC51dnMsIGdsLlNUQVRJQ19EUkFXKQoJICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmFUZXh0dXJlQ29vcmQsIDIsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgkJCQoJICAgIGdsLmFjdGl2ZVRleHR1cmUoZ2wuVEVYVFVSRTApOwoJICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHN0cmlwLnRleHR1cmUuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CgkvLwljb25zb2xlLmxvZyhzdHJpcC50ZXh0dXJlLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpCgkJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl9jb2xvckJ1ZmZlcik7CgkJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLmNvbG9ycywgZ2wuU1RBVElDX0RSQVcpCgkgICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXIuY29sb3JBdHRyaWJ1dGUsIDEsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgkJCgkJLy8gZG9udCBuZWVkIHRvIHVwbG9hZCEKCSAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBzdHJpcC5faW5kZXhCdWZmZXIpOwoJICAgIGdsLmJ1ZmZlckRhdGEoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHN0cmlwLmluZGljZXMsIGdsLlNUQVRJQ19EUkFXKTsKCSAgICAKCX0KCQoJZ2wuZHJhd0VsZW1lbnRzKGdsLlRSSUFOR0xFX1NUUklQLCBzdHJpcC5pbmRpY2VzLmxlbmd0aCwgZ2wuVU5TSUdORURfU0hPUlQsIDApOwogICAgCiAgICBQSVhJLmRlYWN0aXZhdGVTdHJpcFNoYWRlcigpOwogIAkvL2dsLnVzZVByb2dyYW0oUElYSS5jdXJyZW50UHJvZ3JhbSk7Cn0KCi8qKgogKiBSZW5kZXJzIGEgVGlsaW5nU3ByaXRlCiAqCiAqIEBtZXRob2QgcmVuZGVyVGlsaW5nU3ByaXRlCiAqIEBwYXJhbSBzcHJpdGUge1RpbGluZ1Nwcml0ZX0gVGhlIHRpbGluZyBzcHJpdGUgdG8gcmVuZGVyCiAqIEBwYXJhbSBwcm9qZWN0aW9uTWF0cml4IHtPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnJlbmRlclRpbGluZ1Nwcml0ZSA9IGZ1bmN0aW9uKHNwcml0ZSwgcHJvamVjdGlvbk1hdHJpeCkKewoJdmFyIGdsID0gdGhpcy5nbDsKCgoJdmFyIHNoYWRlclByb2dyYW0gPSBQSVhJLnNoYWRlclByb2dyYW07CgkKCXZhciB0aWxlUG9zaXRpb24gPSBzcHJpdGUudGlsZVBvc2l0aW9uOwoJdmFyIHRpbGVTY2FsZSA9IHNwcml0ZS50aWxlU2NhbGU7CgkKCXZhciBvZmZzZXRYID0gIHRpbGVQb3NpdGlvbi54L3Nwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLndpZHRoOwoJdmFyIG9mZnNldFkgPSAgdGlsZVBvc2l0aW9uLnkvc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuaGVpZ2h0OwoJCgl2YXIgc2NhbGVYID0gIChzcHJpdGUud2lkdGggLyBzcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS53aWR0aCkgIC8gdGlsZVNjYWxlLng7Cgl2YXIgc2NhbGVZID0gIChzcHJpdGUuaGVpZ2h0IC8gc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuaGVpZ2h0KSAvIHRpbGVTY2FsZS55OwoKCXNwcml0ZS51dnNbMF0gPSAwIC0gb2Zmc2V0WDsKCXNwcml0ZS51dnNbMV0gPSAwIC0gb2Zmc2V0WTsKCQoJc3ByaXRlLnV2c1syXSA9ICgxICogc2NhbGVYKSAgLW9mZnNldFg7CglzcHJpdGUudXZzWzNdID0gMCAtIG9mZnNldFk7CgkKCXNwcml0ZS51dnNbNF0gPSAoMSAqc2NhbGVYKSAtIG9mZnNldFg7CglzcHJpdGUudXZzWzVdID0gKDEgKnNjYWxlWSkgLSBvZmZzZXRZOwoJCglzcHJpdGUudXZzWzZdID0gMCAtIG9mZnNldFg7CglzcHJpdGUudXZzWzddID0gKDEgKnNjYWxlWSkgLSBvZmZzZXRZOwoJCglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3ByaXRlLl91dkJ1ZmZlcik7CglnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgMCwgc3ByaXRlLnV2cykKCQoJdGhpcy5yZW5kZXJTdHJpcChzcHJpdGUsIHByb2plY3Rpb25NYXRyaXgpOwp9CgovKioKICogSW5pdGlhbGl6ZXMgYSBzdHJpcCB0byBiZSByZW5kZXJlZAogKgogKiBAbWV0aG9kIGluaXRTdHJpcAogKiBAcGFyYW0gc3RyaXAge1N0cmlwfSBUaGUgc3RyaXAgdG8gaW5pdGlhbGl6ZQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5pbml0U3RyaXAgPSBmdW5jdGlvbihzdHJpcCkKewoJLy8gYnVpbGQgdGhlIHN0cmlwIQoJdmFyIGdsID0gdGhpcy5nbDsKCXZhciBzaGFkZXJQcm9ncmFtID0gdGhpcy5zaGFkZXJQcm9ncmFtOwoJCglzdHJpcC5fdmVydGV4QnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CglzdHJpcC5faW5kZXhCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCXN0cmlwLl91dkJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwoJc3RyaXAuX2NvbG9yQnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CgkKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fdmVydGV4QnVmZmVyKTsKCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC52ZXJ0aWNpZXMsIGdsLkRZTkFNSUNfRFJBVyk7CgoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl91dkJ1ZmZlcik7CiAgICBnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgIHN0cmlwLnV2cywgZ2wuU1RBVElDX0RSQVcpOwoKICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fY29sb3JCdWZmZXIpOwoJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLmNvbG9ycywgZ2wuU1RBVElDX0RSQVcpOwoKCQogICAgZ2wuYmluZEJ1ZmZlcihnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgc3RyaXAuX2luZGV4QnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHN0cmlwLmluZGljZXMsIGdsLlNUQVRJQ19EUkFXKTsKfQoKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgpQSVhJLmluaXREZWZhdWx0U2hhZGVycyA9IGZ1bmN0aW9uKCkKewogICAgUElYSS5wcmltaXRpdmVTaGFkZXIgPSBuZXcgUElYSS5QcmltaXRpdmVTaGFkZXIoKTsKICAgIFBJWEkucHJpbWl0aXZlU2hhZGVyLmluaXQoKTsKCiAgICBQSVhJLnN0cmlwU2hhZGVyID0gbmV3IFBJWEkuU3RyaXBTaGFkZXIoKTsKICAgIFBJWEkuc3RyaXBTaGFkZXIuaW5pdCgpOwoKICAgIFBJWEkuZGVmYXVsdFNoYWRlciA9IG5ldyBQSVhJLlBpeGlTaGFkZXIoKTsKICAgIFBJWEkuZGVmYXVsdFNoYWRlci5pbml0KCk7CgogICAgdmFyIGdsID0gUElYSS5nbDsKICAgIHZhciBzaGFkZXJQcm9ncmFtID0gUElYSS5kZWZhdWx0U2hhZGVyLnByb2dyYW07CgogICAgZ2wudXNlUHJvZ3JhbShzaGFkZXJQcm9ncmFtKTsKCiAgICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuYVZlcnRleFBvc2l0aW9uKTsKICAgIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5jb2xvckF0dHJpYnV0ZSk7CiAgICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuYVRleHR1cmVDb29yZCk7Cn07CgpQSVhJLmFjdGl2YXRlUHJpbWl0aXZlU2hhZGVyID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIGdsLnVzZVByb2dyYW0oUElYSS5wcmltaXRpdmVTaGFkZXIucHJvZ3JhbSk7CgogICAgZ2wuZGlzYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5hVmVydGV4UG9zaXRpb24pOwogICAgZ2wuZGlzYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5jb2xvckF0dHJpYnV0ZSk7CiAgICBnbC5kaXNhYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmFUZXh0dXJlQ29vcmQpOwoKICAgIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkucHJpbWl0aXZlU2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbik7CiAgICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLnByaW1pdGl2ZVNoYWRlci5jb2xvckF0dHJpYnV0ZSk7Cn07CgpQSVhJLmRlYWN0aXZhdGVQcmltaXRpdmVTaGFkZXIgPSBmdW5jdGlvbigpCnsKICAgIHZhciBnbCA9IFBJWEkuZ2w7CgogICAgZ2wudXNlUHJvZ3JhbShQSVhJLmRlZmF1bHRTaGFkZXIucHJvZ3JhbSk7CgogICAgZ2wuZGlzYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkucHJpbWl0aXZlU2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbik7CiAgICBnbC5kaXNhYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5wcmltaXRpdmVTaGFkZXIuY29sb3JBdHRyaWJ1dGUpOwoKICAgIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5hVmVydGV4UG9zaXRpb24pOwogICAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmNvbG9yQXR0cmlidXRlKTsKICAgIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5hVGV4dHVyZUNvb3JkKTsKfTsKClBJWEkuYWN0aXZhdGVTdHJpcFNoYWRlciA9IGZ1bmN0aW9uKCkKewogICAgdmFyIGdsID0gUElYSS5nbDsKCiAgICBnbC51c2VQcm9ncmFtKFBJWEkuc3RyaXBTaGFkZXIucHJvZ3JhbSk7CiAvLyBnbC5kaXNhYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmFUZXh0dXJlQ29vcmQpOwp9OwoKUElYSS5kZWFjdGl2YXRlU3RyaXBTaGFkZXIgPSBmdW5jdGlvbigpCnsKICAgIHZhciBnbCA9IFBJWEkuZ2w7CgogICAgZ2wudXNlUHJvZ3JhbShQSVhJLmRlZmF1bHRTaGFkZXIucHJvZ3JhbSk7CiAgICAvL2dsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5hVGV4dHVyZUNvb3JkKTsKfTsKCi8qCgpTSEFERVIgQ09NUElMRVIgSEVMUEVSUwoqLwoKUElYSS5Db21waWxlVmVydGV4U2hhZGVyID0gZnVuY3Rpb24oZ2wsIHNoYWRlclNyYykKewogICAgcmV0dXJuIFBJWEkuX0NvbXBpbGVTaGFkZXIoZ2wsIHNoYWRlclNyYywgZ2wuVkVSVEVYX1NIQURFUik7Cn07CgpQSVhJLkNvbXBpbGVGcmFnbWVudFNoYWRlciA9IGZ1bmN0aW9uKGdsLCBzaGFkZXJTcmMpCnsKICAgIHJldHVybiBQSVhJLl9Db21waWxlU2hhZGVyKGdsLCBzaGFkZXJTcmMsIGdsLkZSQUdNRU5UX1NIQURFUik7Cn07CgpQSVhJLl9Db21waWxlU2hhZGVyID0gZnVuY3Rpb24oZ2wsIHNoYWRlclNyYywgc2hhZGVyVHlwZSkKewogICAgdmFyIHNyYyA9IHNoYWRlclNyYy5qb2luKCJcbiIpOwogICAgdmFyIHNoYWRlciA9IGdsLmNyZWF0ZVNoYWRlcihzaGFkZXJUeXBlKTsKICAgIGdsLnNoYWRlclNvdXJjZShzaGFkZXIsIHNyYyk7CiAgICBnbC5jb21waWxlU2hhZGVyKHNoYWRlcik7CgogICAgaWYgKCFnbC5nZXRTaGFkZXJQYXJhbWV0ZXIoc2hhZGVyLCBnbC5DT01QSUxFX1NUQVRVUykpIHsKICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coZ2wuZ2V0U2hhZGVySW5mb0xvZyhzaGFkZXIpKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICByZXR1cm4gc2hhZGVyOwp9OwoKUElYSS5jb21waWxlUHJvZ3JhbSA9IGZ1bmN0aW9uKHZlcnRleFNyYywgZnJhZ21lbnRTcmMpCnsKICAgIHZhciBnbCA9IFBJWEkuZ2w7CiAgICB2YXIgZnJhZ21lbnRTaGFkZXIgPSBQSVhJLkNvbXBpbGVGcmFnbWVudFNoYWRlcihnbCwgZnJhZ21lbnRTcmMpOwogICAgdmFyIHZlcnRleFNoYWRlciA9IFBJWEkuQ29tcGlsZVZlcnRleFNoYWRlcihnbCwgdmVydGV4U3JjKTsKCiAgICB2YXIgc2hhZGVyUHJvZ3JhbSA9IGdsLmNyZWF0ZVByb2dyYW0oKTsKCiAgICBnbC5hdHRhY2hTaGFkZXIoc2hhZGVyUHJvZ3JhbSwgdmVydGV4U2hhZGVyKTsKICAgIGdsLmF0dGFjaFNoYWRlcihzaGFkZXJQcm9ncmFtLCBmcmFnbWVudFNoYWRlcik7CiAgICBnbC5saW5rUHJvZ3JhbShzaGFkZXJQcm9ncmFtKTsKCiAgICBpZiAoIWdsLmdldFByb2dyYW1QYXJhbWV0ZXIoc2hhZGVyUHJvZ3JhbSwgZ2wuTElOS19TVEFUVVMpKSB7CiAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKCJDb3VsZCBub3QgaW5pdGlhbGlzZSBzaGFkZXJzIik7CiAgICB9CgogICAgcmV0dXJuIHNoYWRlclByb2dyYW07Cn07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIEEgVGV4dCBPYmplY3Qgd2lsbCBjcmVhdGUgYSBsaW5lKHMpIG9mIHRleHQgdXNpbmcgYml0bWFwIGZvbnQuIFRvIHNwbGl0IGEgbGluZSB5b3UgY2FuIHVzZSAnXG4nLCAnXHInIG9yICdcclxuJwogKiBZb3UgY2FuIGdlbmVyYXRlIHRoZSBmbnQgZmlsZXMgdXNpbmcKICogaHR0cDovL3d3dy5hbmdlbGNvZGUuY29tL3Byb2R1Y3RzL2JtZm9udC8gZm9yIHdpbmRvd3Mgb3IKICogaHR0cDovL3d3dy5ibWdseXBoLmNvbS8gZm9yIG1hYy4KICoKICogQGNsYXNzIEJpdG1hcFRleHQKICogQGV4dGVuZHMgRGlzcGxheU9iamVjdENvbnRhaW5lcgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHRleHQge1N0cmluZ30gVGhlIGNvcHkgdGhhdCB5b3Ugd291bGQgbGlrZSB0aGUgdGV4dCB0byBkaXNwbGF5CiAqIEBwYXJhbSBzdHlsZSB7T2JqZWN0fSBUaGUgc3R5bGUgcGFyYW1ldGVycwogKiBAcGFyYW0gc3R5bGUuZm9udCB7U3RyaW5nfSBUaGUgc2l6ZSAob3B0aW9uYWwpIGFuZCBiaXRtYXAgZm9udCBpZCAocmVxdWlyZWQpIGVxICdBcmlhbCcgb3IgJzIwcHggQXJpYWwnIChtdXN0IGhhdmUgbG9hZGVkIHByZXZpb3VzbHkpCiAqIEBwYXJhbSBbc3R5bGUuYWxpZ249J2xlZnQnXSB7U3RyaW5nfSBBbiBhbGlnbm1lbnQgb2YgdGhlIG11bHRpbGluZSB0ZXh0ICgnbGVmdCcsICdjZW50ZXInIG9yICdyaWdodCcpCiAqLwpQSVhJLkJpdG1hcFRleHQgPSBmdW5jdGlvbih0ZXh0LCBzdHlsZSkKewogICAgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwodGhpcyk7CgogICAgdGhpcy5zZXRUZXh0KHRleHQpOwogICAgdGhpcy5zZXRTdHlsZShzdHlsZSk7CiAgICB0aGlzLnVwZGF0ZVRleHQoKTsKICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKfTsKCi8vIGNvbnN0cnVjdG9yClBJWEkuQml0bWFwVGV4dC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUpOwpQSVhJLkJpdG1hcFRleHQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5CaXRtYXBUZXh0OwoKLyoqCiAqIFNldCB0aGUgY29weSBmb3IgdGhlIHRleHQgb2JqZWN0CiAqCiAqIEBtZXRob2Qgc2V0VGV4dAogKiBAcGFyYW0gdGV4dCB7U3RyaW5nfSBUaGUgY29weSB0aGF0IHlvdSB3b3VsZCBsaWtlIHRoZSB0ZXh0IHRvIGRpc3BsYXkKICovClBJWEkuQml0bWFwVGV4dC5wcm90b3R5cGUuc2V0VGV4dCA9IGZ1bmN0aW9uKHRleHQpCnsKICAgIHRoaXMudGV4dCA9IHRleHQgfHwgJyAnOwogICAgdGhpcy5kaXJ0eSA9IHRydWU7Cn07CgovKioKICogU2V0IHRoZSBzdHlsZSBvZiB0aGUgdGV4dAogKgogKiBAbWV0aG9kIHNldFN0eWxlCiAqIEBwYXJhbSBzdHlsZSB7T2JqZWN0fSBUaGUgc3R5bGUgcGFyYW1ldGVycwogKiBAcGFyYW0gc3R5bGUuZm9udCB7U3RyaW5nfSBUaGUgc2l6ZSAob3B0aW9uYWwpIGFuZCBiaXRtYXAgZm9udCBpZCAocmVxdWlyZWQpIGVxICdBcmlhbCcgb3IgJzIwcHggQXJpYWwnIChtdXN0IGhhdmUgbG9hZGVkIHByZXZpb3VzbHkpCiAqIEBwYXJhbSBbc3R5bGUuYWxpZ249J2xlZnQnXSB7U3RyaW5nfSBBbiBhbGlnbm1lbnQgb2YgdGhlIG11bHRpbGluZSB0ZXh0ICgnbGVmdCcsICdjZW50ZXInIG9yICdyaWdodCcpCiAqLwpQSVhJLkJpdG1hcFRleHQucHJvdG90eXBlLnNldFN0eWxlID0gZnVuY3Rpb24oc3R5bGUpCnsKICAgIHN0eWxlID0gc3R5bGUgfHwge307CiAgICBzdHlsZS5hbGlnbiA9IHN0eWxlLmFsaWduIHx8ICdsZWZ0JzsKICAgIHRoaXMuc3R5bGUgPSBzdHlsZTsKCiAgICB2YXIgZm9udCA9IHN0eWxlLmZvbnQuc3BsaXQoJyAnKTsKICAgIHRoaXMuZm9udE5hbWUgPSBmb250W2ZvbnQubGVuZ3RoIC0gMV07CiAgICB0aGlzLmZvbnRTaXplID0gZm9udC5sZW5ndGggPj0gMiA/IHBhcnNlSW50KGZvbnRbZm9udC5sZW5ndGggLSAyXSwgMTApIDogUElYSS5CaXRtYXBUZXh0LmZvbnRzW3RoaXMuZm9udE5hbWVdLnNpemU7CgogICAgdGhpcy5kaXJ0eSA9IHRydWU7Cn07CgovKioKICogUmVuZGVycyB0ZXh0CiAqCiAqIEBtZXRob2QgdXBkYXRlVGV4dAogKiBAcHJpdmF0ZQogKi8KUElYSS5CaXRtYXBUZXh0LnByb3RvdHlwZS51cGRhdGVUZXh0ID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgZGF0YSA9IFBJWEkuQml0bWFwVGV4dC5mb250c1t0aGlzLmZvbnROYW1lXTsKICAgIHZhciBwb3MgPSBuZXcgUElYSS5Qb2ludCgpOwogICAgdmFyIHByZXZDaGFyQ29kZSA9IG51bGw7CiAgICB2YXIgY2hhcnMgPSBbXTsKICAgIHZhciBtYXhMaW5lV2lkdGggPSAwOwogICAgdmFyIGxpbmVXaWR0aHMgPSBbXTsKICAgIHZhciBsaW5lID0gMDsKICAgIHZhciBzY2FsZSA9IHRoaXMuZm9udFNpemUgLyBkYXRhLnNpemU7CiAgICBmb3IodmFyIGkgPSAwOyBpIDwgdGhpcy50ZXh0Lmxlbmd0aDsgaSsrKQogICAgewogICAgICAgIHZhciBjaGFyQ29kZSA9IHRoaXMudGV4dC5jaGFyQ29kZUF0KGkpOwogICAgICAgIGlmKC8oPzpcclxufFxyfFxuKS8udGVzdCh0aGlzLnRleHQuY2hhckF0KGkpKSkKICAgICAgICB7CiAgICAgICAgICAgIGxpbmVXaWR0aHMucHVzaChwb3MueCk7CiAgICAgICAgICAgIG1heExpbmVXaWR0aCA9IE1hdGgubWF4KG1heExpbmVXaWR0aCwgcG9zLngpOwogICAgICAgICAgICBsaW5lKys7CgogICAgICAgICAgICBwb3MueCA9IDA7CiAgICAgICAgICAgIHBvcy55ICs9IGRhdGEubGluZUhlaWdodDsKICAgICAgICAgICAgcHJldkNoYXJDb2RlID0gbnVsbDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgY2hhckRhdGEgPSBkYXRhLmNoYXJzW2NoYXJDb2RlXTsKICAgICAgICBpZighY2hhckRhdGEpIGNvbnRpbnVlOwoKICAgICAgICBpZihwcmV2Q2hhckNvZGUgJiYgY2hhckRhdGFbcHJldkNoYXJDb2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIHBvcy54ICs9IGNoYXJEYXRhLmtlcm5pbmdbcHJldkNoYXJDb2RlXTsKICAgICAgICB9CiAgICAgICAgY2hhcnMucHVzaCh7dGV4dHVyZTpjaGFyRGF0YS50ZXh0dXJlLCBsaW5lOiBsaW5lLCBjaGFyQ29kZTogY2hhckNvZGUsIHBvc2l0aW9uOiBuZXcgUElYSS5Qb2ludChwb3MueCArIGNoYXJEYXRhLnhPZmZzZXQsIHBvcy55ICsgY2hhckRhdGEueU9mZnNldCl9KTsKICAgICAgICBwb3MueCArPSBjaGFyRGF0YS54QWR2YW5jZTsKCiAgICAgICAgcHJldkNoYXJDb2RlID0gY2hhckNvZGU7CiAgICB9CgogICAgbGluZVdpZHRocy5wdXNoKHBvcy54KTsKICAgIG1heExpbmVXaWR0aCA9IE1hdGgubWF4KG1heExpbmVXaWR0aCwgcG9zLngpOwoKICAgIHZhciBsaW5lQWxpZ25PZmZzZXRzID0gW107CiAgICBmb3IoaSA9IDA7IGkgPD0gbGluZTsgaSsrKQogICAgewogICAgICAgIHZhciBhbGlnbk9mZnNldCA9IDA7CiAgICAgICAgaWYodGhpcy5zdHlsZS5hbGlnbiA9PT0gJ3JpZ2h0JykKICAgICAgICB7CiAgICAgICAgICAgIGFsaWduT2Zmc2V0ID0gbWF4TGluZVdpZHRoIC0gbGluZVdpZHRoc1tpXTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZih0aGlzLnN0eWxlLmFsaWduID09PSAnY2VudGVyJykKICAgICAgICB7CiAgICAgICAgICAgIGFsaWduT2Zmc2V0ID0gKG1heExpbmVXaWR0aCAtIGxpbmVXaWR0aHNbaV0pIC8gMjsKICAgICAgICB9CiAgICAgICAgbGluZUFsaWduT2Zmc2V0cy5wdXNoKGFsaWduT2Zmc2V0KTsKICAgIH0KCiAgICBmb3IoaSA9IDA7IGkgPCBjaGFycy5sZW5ndGg7IGkrKykKICAgIHsKICAgICAgICB2YXIgYyA9IG5ldyBQSVhJLlNwcml0ZShjaGFyc1tpXS50ZXh0dXJlKTsgLy9QSVhJLlNwcml0ZS5mcm9tRnJhbWUoY2hhcnNbaV0uY2hhckNvZGUpOwogICAgICAgIGMucG9zaXRpb24ueCA9IChjaGFyc1tpXS5wb3NpdGlvbi54ICsgbGluZUFsaWduT2Zmc2V0c1tjaGFyc1tpXS5saW5lXSkgKiBzY2FsZTsKICAgICAgICBjLnBvc2l0aW9uLnkgPSBjaGFyc1tpXS5wb3NpdGlvbi55ICogc2NhbGU7CiAgICAgICAgYy5zY2FsZS54ID0gYy5zY2FsZS55ID0gc2NhbGU7CiAgICAgICAgdGhpcy5hZGRDaGlsZChjKTsKICAgIH0KCiAgICB0aGlzLndpZHRoID0gbWF4TGluZVdpZHRoICogc2NhbGU7CiAgICB0aGlzLmhlaWdodCA9IChwb3MueSArIGRhdGEubGluZUhlaWdodCkgKiBzY2FsZTsKfTsKCi8qKgogKiBVcGRhdGVzIHRoZSB0cmFuc2ZvciBvZiB0aGlzIG9iamVjdAogKgogKiBAbWV0aG9kIHVwZGF0ZVRyYW5zZm9ybQogKiBAcHJpdmF0ZQogKi8KUElYSS5CaXRtYXBUZXh0LnByb3RvdHlwZS51cGRhdGVUcmFuc2Zvcm0gPSBmdW5jdGlvbigpCnsKICAgIGlmKHRoaXMuZGlydHkpCiAgICB7CiAgICAgICAgd2hpbGUodGhpcy5jaGlsZHJlbi5sZW5ndGggPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmVDaGlsZCh0aGlzLmdldENoaWxkQXQoMCkpOwogICAgICAgIH0KICAgICAgICB0aGlzLnVwZGF0ZVRleHQoKTsKCiAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgfQoKICAgIFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtLmNhbGwodGhpcyk7Cn07CgpQSVhJLkJpdG1hcFRleHQuZm9udHMgPSB7fTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogQSBUZXh0IE9iamVjdCB3aWxsIGNyZWF0ZSBhIGxpbmUocykgb2YgdGV4dCB0byBzcGxpdCBhIGxpbmUgeW91IGNhbiB1c2UgJ1xuJwogKgogKiBAY2xhc3MgVGV4dAogKiBAZXh0ZW5kcyBTcHJpdGUKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB0ZXh0IHtTdHJpbmd9IFRoZSBjb3B5IHRoYXQgeW91IHdvdWxkIGxpa2UgdGhlIHRleHQgdG8gZGlzcGxheQogKiBAcGFyYW0gW3N0eWxlXSB7T2JqZWN0fSBUaGUgc3R5bGUgcGFyYW1ldGVycwogKiBAcGFyYW0gW3N0eWxlLmZvbnRdIHtTdHJpbmd9IGRlZmF1bHQgJ2JvbGQgMjBwdCBBcmlhbCcgVGhlIHN0eWxlIGFuZCBzaXplIG9mIHRoZSBmb250CiAqIEBwYXJhbSBbc3R5bGUuZmlsbD0nYmxhY2snXSB7T2JqZWN0fSBBIGNhbnZhcyBmaWxsc3R5bGUgdGhhdCB3aWxsIGJlIHVzZWQgb24gdGhlIHRleHQgZWcgJ3JlZCcsICcjMDBGRjAwJwogKiBAcGFyYW0gW3N0eWxlLmFsaWduPSdsZWZ0J10ge1N0cmluZ30gQW4gYWxpZ25tZW50IG9mIHRoZSBtdWx0aWxpbmUgdGV4dCAoJ2xlZnQnLCAnY2VudGVyJyBvciAncmlnaHQnKQogKiBAcGFyYW0gW3N0eWxlLnN0cm9rZV0ge1N0cmluZ30gQSBjYW52YXMgZmlsbHN0eWxlIHRoYXQgd2lsbCBiZSB1c2VkIG9uIHRoZSB0ZXh0IHN0cm9rZSBlZyAnYmx1ZScsICcjRkNGRjAwJwogKiBAcGFyYW0gW3N0eWxlLnN0cm9rZVRoaWNrbmVzcz0wXSB7TnVtYmVyfSBBIG51bWJlciB0aGF0IHJlcHJlc2VudHMgdGhlIHRoaWNrbmVzcyBvZiB0aGUgc3Ryb2tlLiBEZWZhdWx0IGlzIDAgKG5vIHN0cm9rZSkKICogQHBhcmFtIFtzdHlsZS53b3JkV3JhcD1mYWxzZV0ge0Jvb2xlYW59IEluZGljYXRlcyBpZiB3b3JkIHdyYXAgc2hvdWxkIGJlIHVzZWQKICogQHBhcmFtIFtzdHlsZS53b3JkV3JhcFdpZHRoPTEwMF0ge051bWJlcn0gVGhlIHdpZHRoIGF0IHdoaWNoIHRleHQgd2lsbCB3cmFwCiAqLwpQSVhJLlRleHQgPSBmdW5jdGlvbih0ZXh0LCBzdHlsZSkKewogICAgdGhpcy5jYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgIHRoaXMuY29udGV4dCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJyk7CiAgICBQSVhJLlNwcml0ZS5jYWxsKHRoaXMsIFBJWEkuVGV4dHVyZS5mcm9tQ2FudmFzKHRoaXMuY2FudmFzKSk7CgogICAgdGhpcy5zZXRUZXh0KHRleHQpOwogICAgdGhpcy5zZXRTdHlsZShzdHlsZSk7CgogICAgdGhpcy51cGRhdGVUZXh0KCk7CiAgICB0aGlzLmRpcnR5ID0gZmFsc2U7Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlRleHQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLlNwcml0ZS5wcm90b3R5cGUpOwpQSVhJLlRleHQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5UZXh0OwoKLyoqCiAqIFNldCB0aGUgc3R5bGUgb2YgdGhlIHRleHQKICoKICogQG1ldGhvZCBzZXRTdHlsZQogKiBAcGFyYW0gW3N0eWxlXSB7T2JqZWN0fSBUaGUgc3R5bGUgcGFyYW1ldGVycwogKiBAcGFyYW0gW3N0eWxlLmZvbnQ9J2JvbGQgMjBwdCBBcmlhbCddIHtTdHJpbmd9IFRoZSBzdHlsZSBhbmQgc2l6ZSBvZiB0aGUgZm9udAogKiBAcGFyYW0gW3N0eWxlLmZpbGw9J2JsYWNrJ10ge09iamVjdH0gQSBjYW52YXMgZmlsbHN0eWxlIHRoYXQgd2lsbCBiZSB1c2VkIG9uIHRoZSB0ZXh0IGVnICdyZWQnLCAnIzAwRkYwMCcKICogQHBhcmFtIFtzdHlsZS5hbGlnbj0nbGVmdCddIHtTdHJpbmd9IEFuIGFsaWdubWVudCBvZiB0aGUgbXVsdGlsaW5lIHRleHQgKCdsZWZ0JywgJ2NlbnRlcicgb3IgJ3JpZ2h0JykKICogQHBhcmFtIFtzdHlsZS5zdHJva2U9J2JsYWNrJ10ge1N0cmluZ30gQSBjYW52YXMgZmlsbHN0eWxlIHRoYXQgd2lsbCBiZSB1c2VkIG9uIHRoZSB0ZXh0IHN0cm9rZSBlZyAnYmx1ZScsICcjRkNGRjAwJwogKiBAcGFyYW0gW3N0eWxlLnN0cm9rZVRoaWNrbmVzcz0wXSB7TnVtYmVyfSBBIG51bWJlciB0aGF0IHJlcHJlc2VudHMgdGhlIHRoaWNrbmVzcyBvZiB0aGUgc3Ryb2tlLiBEZWZhdWx0IGlzIDAgKG5vIHN0cm9rZSkKICogQHBhcmFtIFtzdHlsZS53b3JkV3JhcD1mYWxzZV0ge0Jvb2xlYW59IEluZGljYXRlcyBpZiB3b3JkIHdyYXAgc2hvdWxkIGJlIHVzZWQKICogQHBhcmFtIFtzdHlsZS53b3JkV3JhcFdpZHRoPTEwMF0ge051bWJlcn0gVGhlIHdpZHRoIGF0IHdoaWNoIHRleHQgd2lsbCB3cmFwCiAqLwpQSVhJLlRleHQucHJvdG90eXBlLnNldFN0eWxlID0gZnVuY3Rpb24oc3R5bGUpCnsKICAgIHN0eWxlID0gc3R5bGUgfHwge307CiAgICBzdHlsZS5mb250ID0gc3R5bGUuZm9udCB8fCAnYm9sZCAyMHB0IEFyaWFsJzsKICAgIHN0eWxlLmZpbGwgPSBzdHlsZS5maWxsIHx8ICdibGFjayc7CiAgICBzdHlsZS5hbGlnbiA9IHN0eWxlLmFsaWduIHx8ICdsZWZ0JzsKICAgIHN0eWxlLnN0cm9rZSA9IHN0eWxlLnN0cm9rZSB8fCAnYmxhY2snOyAvL3Byb3ZpZGUgYSBkZWZhdWx0LCBzZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9Hb29kQm95RGlnaXRhbC9waXhpLmpzL2lzc3Vlcy8xMzYKICAgIHN0eWxlLnN0cm9rZVRoaWNrbmVzcyA9IHN0eWxlLnN0cm9rZVRoaWNrbmVzcyB8fCAwOwogICAgc3R5bGUud29yZFdyYXAgPSBzdHlsZS53b3JkV3JhcCB8fCBmYWxzZTsKICAgIHN0eWxlLndvcmRXcmFwV2lkdGggPSBzdHlsZS53b3JkV3JhcFdpZHRoIHx8IDEwMDsKICAgIHRoaXMuc3R5bGUgPSBzdHlsZTsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwp9OwoKLyoqCiAqIFNldCB0aGUgY29weSBmb3IgdGhlIHRleHQgb2JqZWN0LiBUbyBzcGxpdCBhIGxpbmUgeW91IGNhbiB1c2UgJ1xuJwogKgogKiBAbWV0aG9kIHNldFRleHQKICogQHBhcmFtIHtTdHJpbmd9IHRleHQgVGhlIGNvcHkgdGhhdCB5b3Ugd291bGQgbGlrZSB0aGUgdGV4dCB0byBkaXNwbGF5CiAqLwpQSVhJLlRleHQucHJvdG90eXBlLnNldFRleHQgPSBmdW5jdGlvbih0ZXh0KQp7CiAgICB0aGlzLnRleHQgPSB0ZXh0LnRvU3RyaW5nKCkgfHwgJyAnOwogICAgdGhpcy5kaXJ0eSA9IHRydWU7Cn07CgovKioKICogUmVuZGVycyB0ZXh0CiAqCiAqIEBtZXRob2QgdXBkYXRlVGV4dAogKiBAcHJpdmF0ZQogKi8KUElYSS5UZXh0LnByb3RvdHlwZS51cGRhdGVUZXh0ID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLmNvbnRleHQuZm9udCA9IHRoaXMuc3R5bGUuZm9udDsKCiAgICB2YXIgb3V0cHV0VGV4dCA9IHRoaXMudGV4dDsKCiAgICAvLyB3b3JkIHdyYXAKICAgIC8vIHByZXNlcnZlIG9yaWdpbmFsIHRleHQKICAgIGlmKHRoaXMuc3R5bGUud29yZFdyYXApb3V0cHV0VGV4dCA9IHRoaXMud29yZFdyYXAodGhpcy50ZXh0KTsKCiAgICAvL3NwbGl0IHRleHQgaW50byBsaW5lcwogICAgdmFyIGxpbmVzID0gb3V0cHV0VGV4dC5zcGxpdCgvKD86XHJcbnxccnxcbikvKTsKCiAgICAvL2NhbGN1bGF0ZSB0ZXh0IHdpZHRoCiAgICB2YXIgbGluZVdpZHRocyA9IFtdOwogICAgdmFyIG1heExpbmVXaWR0aCA9IDA7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKQogICAgewogICAgICAgIHZhciBsaW5lV2lkdGggPSB0aGlzLmNvbnRleHQubWVhc3VyZVRleHQobGluZXNbaV0pLndpZHRoOwogICAgICAgIGxpbmVXaWR0aHNbaV0gPSBsaW5lV2lkdGg7CiAgICAgICAgbWF4TGluZVdpZHRoID0gTWF0aC5tYXgobWF4TGluZVdpZHRoLCBsaW5lV2lkdGgpOwogICAgfQogICAgdGhpcy5jYW52YXMud2lkdGggPSBtYXhMaW5lV2lkdGggKyB0aGlzLnN0eWxlLnN0cm9rZVRoaWNrbmVzczsKCiAgICAvL2NhbGN1bGF0ZSB0ZXh0IGhlaWdodAogICAgdmFyIGxpbmVIZWlnaHQgPSB0aGlzLmRldGVybWluZUZvbnRIZWlnaHQoJ2ZvbnQ6ICcgKyB0aGlzLnN0eWxlLmZvbnQgICsgJzsnKSArIHRoaXMuc3R5bGUuc3Ryb2tlVGhpY2tuZXNzOwogICAgdGhpcy5jYW52YXMuaGVpZ2h0ID0gbGluZUhlaWdodCAqIGxpbmVzLmxlbmd0aDsKCiAgICAvL3NldCBjYW52YXMgdGV4dCBzdHlsZXMKICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSB0aGlzLnN0eWxlLmZpbGw7CiAgICB0aGlzLmNvbnRleHQuZm9udCA9IHRoaXMuc3R5bGUuZm9udDsKCiAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSB0aGlzLnN0eWxlLnN0cm9rZTsKICAgIHRoaXMuY29udGV4dC5saW5lV2lkdGggPSB0aGlzLnN0eWxlLnN0cm9rZVRoaWNrbmVzczsKCiAgICB0aGlzLmNvbnRleHQudGV4dEJhc2VsaW5lID0gJ3RvcCc7CgogICAgLy9kcmF3IGxpbmVzIGxpbmUgYnkgbGluZQogICAgZm9yIChpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKQogICAgewogICAgICAgIHZhciBsaW5lUG9zaXRpb24gPSBuZXcgUElYSS5Qb2ludCh0aGlzLnN0eWxlLnN0cm9rZVRoaWNrbmVzcyAvIDIsIHRoaXMuc3R5bGUuc3Ryb2tlVGhpY2tuZXNzIC8gMiArIGkgKiBsaW5lSGVpZ2h0KTsKCiAgICAgICAgaWYodGhpcy5zdHlsZS5hbGlnbiA9PT0gJ3JpZ2h0JykKICAgICAgICB7CiAgICAgICAgICAgIGxpbmVQb3NpdGlvbi54ICs9IG1heExpbmVXaWR0aCAtIGxpbmVXaWR0aHNbaV07CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYodGhpcy5zdHlsZS5hbGlnbiA9PT0gJ2NlbnRlcicpCiAgICAgICAgewogICAgICAgICAgICBsaW5lUG9zaXRpb24ueCArPSAobWF4TGluZVdpZHRoIC0gbGluZVdpZHRoc1tpXSkgLyAyOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5zdHlsZS5zdHJva2UgJiYgdGhpcy5zdHlsZS5zdHJva2VUaGlja25lc3MpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlVGV4dChsaW5lc1tpXSwgbGluZVBvc2l0aW9uLngsIGxpbmVQb3NpdGlvbi55KTsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMuc3R5bGUuZmlsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsVGV4dChsaW5lc1tpXSwgbGluZVBvc2l0aW9uLngsIGxpbmVQb3NpdGlvbi55KTsKICAgICAgICB9CiAgICB9CgogICAgdGhpcy51cGRhdGVUZXh0dXJlKCk7Cn07CgovKioKICogVXBkYXRlcyB0ZXh0dXJlIHNpemUgYmFzZWQgb24gY2FudmFzIHNpemUKICoKICogQG1ldGhvZCB1cGRhdGVUZXh0dXJlCiAqIEBwcml2YXRlCiAqLwpQSVhJLlRleHQucHJvdG90eXBlLnVwZGF0ZVRleHR1cmUgPSBmdW5jdGlvbigpCnsKICAgIHRoaXMudGV4dHVyZS5iYXNlVGV4dHVyZS53aWR0aCA9IHRoaXMuY2FudmFzLndpZHRoOwogICAgdGhpcy50ZXh0dXJlLmJhc2VUZXh0dXJlLmhlaWdodCA9IHRoaXMuY2FudmFzLmhlaWdodDsKICAgIHRoaXMudGV4dHVyZS5mcmFtZS53aWR0aCA9IHRoaXMuY2FudmFzLndpZHRoOwogICAgdGhpcy50ZXh0dXJlLmZyYW1lLmhlaWdodCA9IHRoaXMuY2FudmFzLmhlaWdodDsKCiAgICB0aGlzLl93aWR0aCA9IHRoaXMuY2FudmFzLndpZHRoOwogICAgdGhpcy5faGVpZ2h0ID0gdGhpcy5jYW52YXMuaGVpZ2h0OwoKICAgIFBJWEkudGV4dHVyZXNUb1VwZGF0ZS5wdXNoKHRoaXMudGV4dHVyZS5iYXNlVGV4dHVyZSk7Cn07CgovKioKICogVXBkYXRlcyB0aGUgdHJhbnNmb3Igb2YgdGhpcyBvYmplY3QKICoKICogQG1ldGhvZCB1cGRhdGVUcmFuc2Zvcm0KICogQHByaXZhdGUKICovClBJWEkuVGV4dC5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtID0gZnVuY3Rpb24oKQp7CiAgICBpZih0aGlzLmRpcnR5KQogICAgewogICAgICAgIHRoaXMudXBkYXRlVGV4dCgpOwogICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgIH0KCiAgICBQSVhJLlNwcml0ZS5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtLmNhbGwodGhpcyk7Cn07CgovKgogKiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vdXNlcnMvMzQ0NDEvZWxsaXNiYmVuCiAqIGdyZWF0IHNvbHV0aW9uIHRvIHRoZSBwcm9ibGVtIQogKgogKiBAbWV0aG9kIGRldGVybWluZUZvbnRIZWlnaHQKICogQHBhcmFtIGZvbnRTdHlsZSB7T2JqZWN0fQogKiBAcHJpdmF0ZQogKi8KUElYSS5UZXh0LnByb3RvdHlwZS5kZXRlcm1pbmVGb250SGVpZ2h0ID0gZnVuY3Rpb24oZm9udFN0eWxlKQp7CiAgICAvLyBidWlsZCBhIGxpdHRsZSByZWZlcmVuY2UgZGljdGlvbmFyeSBzbyBpZiB0aGUgZm9udCBzdHlsZSBoYXMgYmVlbiB1c2VkIHJldHVybiBhCiAgICAvLyBjYWNoZWQgdmVyc2lvbi4uLgogICAgdmFyIHJlc3VsdCA9IFBJWEkuVGV4dC5oZWlnaHRDYWNoZVtmb250U3R5bGVdOwoKICAgIGlmKCFyZXN1bHQpCiAgICB7CiAgICAgICAgdmFyIGJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYm9keScpWzBdOwogICAgICAgIHZhciBkdW1teSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHZhciBkdW1teVRleHQgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnTScpOwogICAgICAgIGR1bW15LmFwcGVuZENoaWxkKGR1bW15VGV4dCk7CiAgICAgICAgZHVtbXkuc2V0QXR0cmlidXRlKCdzdHlsZScsIGZvbnRTdHlsZSArICc7cG9zaXRpb246YWJzb2x1dGU7dG9wOjA7bGVmdDowJyk7CiAgICAgICAgYm9keS5hcHBlbmRDaGlsZChkdW1teSk7CgogICAgICAgIHJlc3VsdCA9IGR1bW15Lm9mZnNldEhlaWdodDsKICAgICAgICBQSVhJLlRleHQuaGVpZ2h0Q2FjaGVbZm9udFN0eWxlXSA9IHJlc3VsdDsKCiAgICAgICAgYm9keS5yZW1vdmVDaGlsZChkdW1teSk7CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKfTsKCi8qKgogKiBBcHBsaWVzIG5ld2xpbmVzIHRvIGEgc3RyaW5nIHRvIGhhdmUgaXQgb3B0aW1hbGx5IGZpdCBpbnRvIHRoZSBob3Jpem9udGFsCiAqIGJvdW5kcyBzZXQgYnkgdGhlIFRleHQgb2JqZWN0J3Mgd29yZFdyYXBXaWR0aCBwcm9wZXJ0eS4KICoKICogQG1ldGhvZCB3b3JkV3JhcAogKiBAcGFyYW0gdGV4dCB7U3RyaW5nfQogKiBAcHJpdmF0ZQogKi8KUElYSS5UZXh0LnByb3RvdHlwZS53b3JkV3JhcCA9IGZ1bmN0aW9uKHRleHQpCnsKICAgIC8vIEdyZWVkeSB3cmFwcGluZyBhbGdvcml0aG0gdGhhdCB3aWxsIHdyYXAgd29yZHMgYXMgdGhlIGxpbmUgZ3Jvd3MgbG9uZ2VyCiAgICAvLyB0aGFuIGl0cyBob3Jpem9udGFsIGJvdW5kcy4KICAgIHZhciByZXN1bHQgPSAnJzsKICAgIHZhciBsaW5lcyA9IHRleHQuc3BsaXQoJ1xuJyk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKQogICAgewogICAgICAgIHZhciBzcGFjZUxlZnQgPSB0aGlzLnN0eWxlLndvcmRXcmFwV2lkdGg7CiAgICAgICAgdmFyIHdvcmRzID0gbGluZXNbaV0uc3BsaXQoJyAnKTsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHdvcmRzLmxlbmd0aDsgaisrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHdvcmRXaWR0aCA9IHRoaXMuY29udGV4dC5tZWFzdXJlVGV4dCh3b3Jkc1tqXSkud2lkdGg7CiAgICAgICAgICAgIHZhciB3b3JkV2lkdGhXaXRoU3BhY2UgPSB3b3JkV2lkdGggKyB0aGlzLmNvbnRleHQubWVhc3VyZVRleHQoJyAnKS53aWR0aDsKICAgICAgICAgICAgaWYod29yZFdpZHRoV2l0aFNwYWNlID4gc3BhY2VMZWZ0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBTa2lwIHByaW50aW5nIHRoZSBuZXdsaW5lIGlmIGl0J3MgdGhlIGZpcnN0IHdvcmQgb2YgdGhlIGxpbmUgdGhhdCBpcwogICAgICAgICAgICAgICAgLy8gZ3JlYXRlciB0aGFuIHRoZSB3b3JkIHdyYXAgd2lkdGguCiAgICAgICAgICAgICAgICBpZihqID4gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgKz0gJ1xuJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc3VsdCArPSB3b3Jkc1tqXSArICcgJzsKICAgICAgICAgICAgICAgIHNwYWNlTGVmdCA9IHRoaXMuc3R5bGUud29yZFdyYXBXaWR0aCAtIHdvcmRXaWR0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHNwYWNlTGVmdCAtPSB3b3JkV2lkdGhXaXRoU3BhY2U7CiAgICAgICAgICAgICAgICByZXN1bHQgKz0gd29yZHNbal0gKyAnICc7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0ICs9ICdcbic7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0Owp9OwoKLyoqCiAqIERlc3Ryb3lzIHRoaXMgdGV4dCBvYmplY3QKICoKICogQG1ldGhvZCBkZXN0cm95CiAqIEBwYXJhbSBkZXN0cm95VGV4dHVyZSB7Qm9vbGVhbn0KICovClBJWEkuVGV4dC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKGRlc3Ryb3lUZXh0dXJlKQp7CiAgICBpZihkZXN0cm95VGV4dHVyZSkKICAgIHsKICAgICAgICB0aGlzLnRleHR1cmUuZGVzdHJveSgpOwogICAgfQoKfTsKClBJWEkuVGV4dC5oZWlnaHRDYWNoZSA9IHt9OwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KClBJWEkuQmFzZVRleHR1cmVDYWNoZSA9IHt9OwpQSVhJLnRleHR1cmVzVG9VcGRhdGUgPSBbXTsKUElYSS50ZXh0dXJlc1RvRGVzdHJveSA9IFtdOwoKLyoqCiAqIEEgdGV4dHVyZSBzdG9yZXMgdGhlIGluZm9ybWF0aW9uIHRoYXQgcmVwcmVzZW50cyBhbiBpbWFnZS4gQWxsIHRleHR1cmVzIGhhdmUgYSBiYXNlIHRleHR1cmUKICoKICogQGNsYXNzIEJhc2VUZXh0dXJlCiAqIEB1c2VzIEV2ZW50VGFyZ2V0CiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gc291cmNlIHtTdHJpbmd9IHRoZSBzb3VyY2Ugb2JqZWN0IChpbWFnZSBvciBjYW52YXMpCiAqLwpQSVhJLkJhc2VUZXh0dXJlID0gZnVuY3Rpb24oc291cmNlLCBzY2FsZU1vZGUpCnsKICAgIFBJWEkuRXZlbnRUYXJnZXQuY2FsbCggdGhpcyApOwoKICAgIC8qKgogICAgICogW3JlYWQtb25seV0gVGhlIHdpZHRoIG9mIHRoZSBiYXNlIHRleHR1cmUgc2V0IHdoZW4gdGhlIGltYWdlIGhhcyBsb2FkZWQKICAgICAqCiAgICAgKiBAcHJvcGVydHkgd2lkdGgKICAgICAqIEB0eXBlIE51bWJlcgogICAgICogQHJlYWRPbmx5CiAgICAgKi8KICAgIHRoaXMud2lkdGggPSAxMDA7CgogICAgLyoqCiAgICAgKiBbcmVhZC1vbmx5XSBUaGUgaGVpZ2h0IG9mIHRoZSBiYXNlIHRleHR1cmUgc2V0IHdoZW4gdGhlIGltYWdlIGhhcyBsb2FkZWQKICAgICAqCiAgICAgKiBAcHJvcGVydHkgaGVpZ2h0CiAgICAgKiBAdHlwZSBOdW1iZXIKICAgICAqIEByZWFkT25seQogICAgICovCiAgICB0aGlzLmhlaWdodCA9IDEwMDsKCiAgICAvKioKICAgICAqIFRoZSBzY2FsZSBtb2RlIHRvIGFwcGx5IHdoZW4gc2NhbGluZyB0aGlzIHRleHR1cmUKICAgICAqIEBwcm9wZXJ0eSBzY2FsZU1vZGUKICAgICAqIEB0eXBlIFBJWEkuQmFzZVRleHR1cmUuU0NBTEVfTU9ERQogICAgICogQGRlZmF1bHQgUElYSS5CYXNlVGV4dHVyZS5TQ0FMRV9NT0RFLkxJTkVBUgogICAgICovCiAgICB0aGlzLnNjYWxlTW9kZSA9IHNjYWxlTW9kZSB8fCBQSVhJLkJhc2VUZXh0dXJlLlNDQUxFX01PREUuREVGQVVMVDsKCiAgICAvKioKICAgICAqIFtyZWFkLW9ubHldIERlc2NyaWJlcyBpZiB0aGUgYmFzZSB0ZXh0dXJlIGhhcyBsb2FkZWQgb3Igbm90CiAgICAgKgogICAgICogQHByb3BlcnR5IGhhc0xvYWRlZAogICAgICogQHR5cGUgQm9vbGVhbgogICAgICogQHJlYWRPbmx5CiAgICAgKi8KICAgIHRoaXMuaGFzTG9hZGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAgKiBUaGUgc291cmNlIHRoYXQgaXMgbG9hZGVkIHRvIGNyZWF0ZSB0aGUgdGV4dHVyZQogICAgICoKICAgICAqIEBwcm9wZXJ0eSBzb3VyY2UKICAgICAqIEB0eXBlIEltYWdlCiAgICAgKi8KICAgIHRoaXMuc291cmNlID0gc291cmNlOwoKICAgIGlmKCFzb3VyY2UpcmV0dXJuOwoKICAgIGlmKHRoaXMuc291cmNlIGluc3RhbmNlb2YgSW1hZ2UgfHwgdGhpcy5zb3VyY2UgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50KQogICAgewogICAgICAgIGlmKHRoaXMuc291cmNlLmNvbXBsZXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5oYXNMb2FkZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5zb3VyY2Uud2lkdGg7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy5zb3VyY2UuaGVpZ2h0OwoKICAgICAgICAgICAgUElYSS50ZXh0dXJlc1RvVXBkYXRlLnB1c2godGhpcyk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CgogICAgICAgICAgICB2YXIgc2NvcGUgPSB0aGlzOwogICAgICAgICAgICB0aGlzLnNvdXJjZS5vbmxvYWQgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICBzY29wZS5oYXNMb2FkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgc2NvcGUud2lkdGggPSBzY29wZS5zb3VyY2Uud2lkdGg7CiAgICAgICAgICAgICAgICBzY29wZS5oZWlnaHQgPSBzY29wZS5zb3VyY2UuaGVpZ2h0OwoKICAgICAgICAgICAgICAgIC8vIGFkZCBpdCB0byBzb21ld2hlcmUuLi4KICAgICAgICAgICAgICAgIFBJWEkudGV4dHVyZXNUb1VwZGF0ZS5wdXNoKHNjb3BlKTsKICAgICAgICAgICAgICAgIHNjb3BlLmRpc3BhdGNoRXZlbnQoIHsgdHlwZTogJ2xvYWRlZCcsIGNvbnRlbnQ6IHNjb3BlIH0gKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgLy90aGlzLmltYWdlLnNyYyA9IGltYWdlVXJsOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLmhhc0xvYWRlZCA9IHRydWU7CiAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMuc291cmNlLndpZHRoOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy5zb3VyY2UuaGVpZ2h0OwoKICAgICAgICBQSVhJLnRleHR1cmVzVG9VcGRhdGUucHVzaCh0aGlzKTsKICAgIH0KCiAgICB0aGlzLmltYWdlVXJsID0gbnVsbDsKICAgIHRoaXMuX3Bvd2VyT2YyID0gZmFsc2U7Cn07CgpQSVhJLkJhc2VUZXh0dXJlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuQmFzZVRleHR1cmU7CgovKioKICogRGVzdHJveXMgdGhpcyBiYXNlIHRleHR1cmUKICoKICogQG1ldGhvZCBkZXN0cm95CiAqLwpQSVhJLkJhc2VUZXh0dXJlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKQp7CiAgICBpZih0aGlzLnNvdXJjZSBpbnN0YW5jZW9mIEltYWdlKQogICAgewogICAgICAgIGlmICh0aGlzLmltYWdlVXJsIGluIFBJWEkuQmFzZVRleHR1cmVDYWNoZSkKICAgICAgICAgICAgZGVsZXRlIFBJWEkuQmFzZVRleHR1cmVDYWNoZVt0aGlzLmltYWdlVXJsXTsKICAgICAgICB0aGlzLmltYWdlVXJsID0gbnVsbDsKICAgICAgICB0aGlzLnNvdXJjZS5zcmMgPSBudWxsOwogICAgfQogICAgdGhpcy5zb3VyY2UgPSBudWxsOwogICAgUElYSS50ZXh0dXJlc1RvRGVzdHJveS5wdXNoKHRoaXMpOwp9OwoKLyoqCiAqCiAqCiAqIEBtZXRob2QgZGVzdHJveQogKi8KClBJWEkuQmFzZVRleHR1cmUucHJvdG90eXBlLnVwZGF0ZVNvdXJjZUltYWdlID0gZnVuY3Rpb24obmV3U3JjKQp7CiAgICB0aGlzLmhhc0xvYWRlZCA9IGZhbHNlOwogICAgdGhpcy5zb3VyY2Uuc3JjID0gbnVsbDsKICAgIHRoaXMuc291cmNlLnNyYyA9IG5ld1NyYzsKfTsKCi8qKgogKiBIZWxwZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgYmFzZSB0ZXh0dXJlIGJhc2VkIG9uIGFuIGltYWdlIHVybAogKiBJZiB0aGUgaW1hZ2UgaXMgbm90IGluIHRoZSBiYXNlIHRleHR1cmUgY2FjaGUgaXQgd2lsbCBiZSAgY3JlYXRlZCBhbmQgbG9hZGVkCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCBmcm9tSW1hZ2UKICogQHBhcmFtIGltYWdlVXJsIHtTdHJpbmd9IFRoZSBpbWFnZSB1cmwgb2YgdGhlIHRleHR1cmUKICogQHJldHVybiBCYXNlVGV4dHVyZQogKi8KUElYSS5CYXNlVGV4dHVyZS5mcm9tSW1hZ2UgPSBmdW5jdGlvbihpbWFnZVVybCwgY3Jvc3NvcmlnaW4sIHNjYWxlTW9kZSkKewogICAgdmFyIGJhc2VUZXh0dXJlID0gUElYSS5CYXNlVGV4dHVyZUNhY2hlW2ltYWdlVXJsXTsKICAgIGlmKCFiYXNlVGV4dHVyZSkKICAgIHsKICAgICAgICAvLyBuZXcgSW1hZ2UoKSBicmVha3MgdGV4IGxvYWRpbmcgaW4gc29tZSB2ZXJzaW9ucyBvZiBDaHJvbWUuCiAgICAgICAgLy8gU2VlIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD0yMzgwNzEKICAgICAgICB2YXIgaW1hZ2UgPSBuZXcgSW1hZ2UoKTsvL2RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOwogICAgICAgIGlmIChjcm9zc29yaWdpbikKICAgICAgICB7CiAgICAgICAgICAgIGltYWdlLmNyb3NzT3JpZ2luID0gJyc7CiAgICAgICAgfQogICAgICAgIGltYWdlLnNyYyA9IGltYWdlVXJsOwogICAgICAgIGJhc2VUZXh0dXJlID0gbmV3IFBJWEkuQmFzZVRleHR1cmUoaW1hZ2UsIHNjYWxlTW9kZSk7CiAgICAgICAgYmFzZVRleHR1cmUuaW1hZ2VVcmwgPSBpbWFnZVVybDsKICAgICAgICBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbaW1hZ2VVcmxdID0gYmFzZVRleHR1cmU7CiAgICB9CgogICAgcmV0dXJuIGJhc2VUZXh0dXJlOwp9OwoKUElYSS5CYXNlVGV4dHVyZS5TQ0FMRV9NT0RFID0gewogICAgREVGQVVMVDogMCwgLy9kZWZhdWx0IHRvIExJTkVBUgogICAgTElORUFSOiAwLAogICAgTkVBUkVTVDogMQp9OwovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKUElYSS5UZXh0dXJlQ2FjaGUgPSB7fTsKUElYSS5GcmFtZUNhY2hlID0ge307CgovKioKICogQSB0ZXh0dXJlIHN0b3JlcyB0aGUgaW5mb3JtYXRpb24gdGhhdCByZXByZXNlbnRzIGFuIGltYWdlIG9yIHBhcnQgb2YgYW4gaW1hZ2UuIEl0IGNhbm5vdCBiZSBhZGRlZAogKiB0byB0aGUgZGlzcGxheSBsaXN0IGRpcmVjdGx5LiBUbyBkbyB0aGlzIHVzZSBQSVhJLlNwcml0ZS4gSWYgbm8gZnJhbWUgaXMgcHJvdmlkZWQgdGhlbiB0aGUgd2hvbGUgaW1hZ2UgaXMgdXNlZAogKgogKiBAY2xhc3MgVGV4dHVyZQogKiBAdXNlcyBFdmVudFRhcmdldAogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIGJhc2VUZXh0dXJlIHtCYXNlVGV4dHVyZX0gVGhlIGJhc2UgdGV4dHVyZSBzb3VyY2UgdG8gY3JlYXRlIHRoZSB0ZXh0dXJlIGZyb20KICogQHBhcmFtIGZyYW1lIHtSZWN0YW5nbGV9IFRoZSByZWN0YW5nbGUgZnJhbWUgb2YgdGhlIHRleHR1cmUgdG8gc2hvdwogKi8KUElYSS5UZXh0dXJlID0gZnVuY3Rpb24oYmFzZVRleHR1cmUsIGZyYW1lKQp7CiAgICBQSVhJLkV2ZW50VGFyZ2V0LmNhbGwoIHRoaXMgKTsKCiAgICBpZighZnJhbWUpCiAgICB7CiAgICAgICAgdGhpcy5ub0ZyYW1lID0gdHJ1ZTsKICAgICAgICBmcmFtZSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLDAsMSwxKTsKICAgIH0KCiAgICBpZihiYXNlVGV4dHVyZSBpbnN0YW5jZW9mIFBJWEkuVGV4dHVyZSkKICAgICAgICBiYXNlVGV4dHVyZSA9IGJhc2VUZXh0dXJlLmJhc2VUZXh0dXJlOwoKICAgIC8qKgogICAgICogVGhlIGJhc2UgdGV4dHVyZSBvZiB0aGlzIHRleHR1cmUKICAgICAqCiAgICAgKiBAcHJvcGVydHkgYmFzZVRleHR1cmUKICAgICAqIEB0eXBlIEJhc2VUZXh0dXJlCiAgICAgKi8KICAgIHRoaXMuYmFzZVRleHR1cmUgPSBiYXNlVGV4dHVyZTsKCiAgICAvKioKICAgICAqIFRoZSBmcmFtZSBzcGVjaWZpZXMgdGhlIHJlZ2lvbiBvZiB0aGUgYmFzZSB0ZXh0dXJlIHRoYXQgdGhpcyB0ZXh0dXJlIHVzZXMKICAgICAqCiAgICAgKiBAcHJvcGVydHkgZnJhbWUKICAgICAqIEB0eXBlIFJlY3RhbmdsZQogICAgICovCiAgICB0aGlzLmZyYW1lID0gZnJhbWU7CgogICAgLyoqCiAgICAgKiBUaGUgdHJpbSBwb2ludAogICAgICoKICAgICAqIEBwcm9wZXJ0eSB0cmltCiAgICAgKiBAdHlwZSBQb2ludAogICAgICovCiAgICB0aGlzLnRyaW0gPSBuZXcgUElYSS5Qb2ludCgpOwoKICAgIHRoaXMuc2NvcGUgPSB0aGlzOwoKICAgIGlmKGJhc2VUZXh0dXJlLmhhc0xvYWRlZCkKICAgIHsKICAgICAgICBpZih0aGlzLm5vRnJhbWUpZnJhbWUgPSBuZXcgUElYSS5SZWN0YW5nbGUoMCwwLCBiYXNlVGV4dHVyZS53aWR0aCwgYmFzZVRleHR1cmUuaGVpZ2h0KTsKICAgICAgICAvL2NvbnNvbGUubG9nKGZyYW1lKQoKICAgICAgICB0aGlzLnNldEZyYW1lKGZyYW1lKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB2YXIgc2NvcGUgPSB0aGlzOwogICAgICAgIGJhc2VUZXh0dXJlLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWRlZCcsIGZ1bmN0aW9uKCl7IHNjb3BlLm9uQmFzZVRleHR1cmVMb2FkZWQoKTsgfSk7CiAgICB9Cn07CgpQSVhJLlRleHR1cmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5UZXh0dXJlOwoKLyoqCiAqIENhbGxlZCB3aGVuIHRoZSBiYXNlIHRleHR1cmUgaXMgbG9hZGVkCiAqCiAqIEBtZXRob2Qgb25CYXNlVGV4dHVyZUxvYWRlZAogKiBAcGFyYW0gZXZlbnQKICogQHByaXZhdGUKICovClBJWEkuVGV4dHVyZS5wcm90b3R5cGUub25CYXNlVGV4dHVyZUxvYWRlZCA9IGZ1bmN0aW9uKCkKewogICAgdmFyIGJhc2VUZXh0dXJlID0gdGhpcy5iYXNlVGV4dHVyZTsKICAgIGJhc2VUZXh0dXJlLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdsb2FkZWQnLCB0aGlzLm9uTG9hZGVkICk7CgogICAgaWYodGhpcy5ub0ZyYW1lKXRoaXMuZnJhbWUgPSBuZXcgUElYSS5SZWN0YW5nbGUoMCwwLCBiYXNlVGV4dHVyZS53aWR0aCwgYmFzZVRleHR1cmUuaGVpZ2h0KTsKICAgIHRoaXMubm9GcmFtZSA9IGZhbHNlOwogICAgdGhpcy53aWR0aCA9IHRoaXMuZnJhbWUud2lkdGg7CiAgICB0aGlzLmhlaWdodCA9IHRoaXMuZnJhbWUuaGVpZ2h0OwoKICAgIHRoaXMuc2NvcGUuZGlzcGF0Y2hFdmVudCggeyB0eXBlOiAndXBkYXRlJywgY29udGVudDogdGhpcyB9ICk7Cn07CgovKioKICogRGVzdHJveXMgdGhpcyB0ZXh0dXJlCiAqCiAqIEBtZXRob2QgZGVzdHJveQogKiBAcGFyYW0gZGVzdHJveUJhc2Uge0Jvb2xlYW59IFdoZXRoZXIgdG8gZGVzdHJveSB0aGUgYmFzZSB0ZXh0dXJlIGFzIHdlbGwKICovClBJWEkuVGV4dHVyZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKGRlc3Ryb3lCYXNlKQp7CiAgICBpZihkZXN0cm95QmFzZSkgdGhpcy5iYXNlVGV4dHVyZS5kZXN0cm95KCk7Cn07CgovKioKICogU3BlY2lmaWVzIHRoZSByZWN0YW5nbGUgcmVnaW9uIG9mIHRoZSBiYXNlVGV4dHVyZQogKgogKiBAbWV0aG9kIHNldEZyYW1lCiAqIEBwYXJhbSBmcmFtZSB7UmVjdGFuZ2xlfSBUaGUgZnJhbWUgb2YgdGhlIHRleHR1cmUgdG8gc2V0IGl0IHRvCiAqLwpQSVhJLlRleHR1cmUucHJvdG90eXBlLnNldEZyYW1lID0gZnVuY3Rpb24oZnJhbWUpCnsKICAgIHRoaXMuZnJhbWUgPSBmcmFtZTsKICAgIHRoaXMud2lkdGggPSBmcmFtZS53aWR0aDsKICAgIHRoaXMuaGVpZ2h0ID0gZnJhbWUuaGVpZ2h0OwoKICAgIGlmKGZyYW1lLnggKyBmcmFtZS53aWR0aCA+IHRoaXMuYmFzZVRleHR1cmUud2lkdGggfHwgZnJhbWUueSArIGZyYW1lLmhlaWdodCA+IHRoaXMuYmFzZVRleHR1cmUuaGVpZ2h0KQogICAgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVGV4dHVyZSBFcnJvcjogZnJhbWUgZG9lcyBub3QgZml0IGluc2lkZSB0aGUgYmFzZSBUZXh0dXJlIGRpbWVuc2lvbnMgJyArIHRoaXMpOwogICAgfQoKICAgIHRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwoKICAgIFBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMucHVzaCh0aGlzKTsKICAgIC8vdGhpcy5kaXNwYXRjaEV2ZW50KCB7IHR5cGU6ICd1cGRhdGUnLCBjb250ZW50OiB0aGlzIH0gKTsKfTsKCi8qKgogKiBIZWxwZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgdGV4dHVyZSBiYXNlZCBvbiBhbiBpbWFnZSB1cmwKICogSWYgdGhlIGltYWdlIGlzIG5vdCBpbiB0aGUgdGV4dHVyZSBjYWNoZSBpdCB3aWxsIGJlICBjcmVhdGVkIGFuZCBsb2FkZWQKICoKICogQHN0YXRpYwogKiBAbWV0aG9kIGZyb21JbWFnZQogKiBAcGFyYW0gaW1hZ2VVcmwge1N0cmluZ30gVGhlIGltYWdlIHVybCBvZiB0aGUgdGV4dHVyZQogKiBAcGFyYW0gY3Jvc3NvcmlnaW4ge0Jvb2xlYW59IFdoZXRoZXIgcmVxdWVzdHMgc2hvdWxkIGJlIHRyZWF0ZWQgYXMgY3Jvc3NvcmlnaW4KICogQHJldHVybiBUZXh0dXJlCiAqLwpQSVhJLlRleHR1cmUuZnJvbUltYWdlID0gZnVuY3Rpb24oaW1hZ2VVcmwsIGNyb3Nzb3JpZ2luLCBzY2FsZU1vZGUpCnsKICAgIHZhciB0ZXh0dXJlID0gUElYSS5UZXh0dXJlQ2FjaGVbaW1hZ2VVcmxdOwoKICAgIGlmKCF0ZXh0dXJlKQogICAgewogICAgICAgIHRleHR1cmUgPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmUuZnJvbUltYWdlKGltYWdlVXJsLCBjcm9zc29yaWdpbiwgc2NhbGVNb2RlKSk7CiAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbaW1hZ2VVcmxdID0gdGV4dHVyZTsKICAgIH0KCiAgICByZXR1cm4gdGV4dHVyZTsKfTsKCi8qKgogKiBIZWxwZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgdGV4dHVyZSBiYXNlZCBvbiBhIGZyYW1lIGlkCiAqIElmIHRoZSBmcmFtZSBpZCBpcyBub3QgaW4gdGhlIHRleHR1cmUgY2FjaGUgYW4gZXJyb3Igd2lsbCBiZSB0aHJvd24KICoKICogQHN0YXRpYwogKiBAbWV0aG9kIGZyb21GcmFtZQogKiBAcGFyYW0gZnJhbWVJZCB7U3RyaW5nfSBUaGUgZnJhbWUgaWQgb2YgdGhlIHRleHR1cmUKICogQHJldHVybiBUZXh0dXJlCiAqLwpQSVhJLlRleHR1cmUuZnJvbUZyYW1lID0gZnVuY3Rpb24oZnJhbWVJZCkKewogICAgdmFyIHRleHR1cmUgPSBQSVhJLlRleHR1cmVDYWNoZVtmcmFtZUlkXTsKICAgIGlmKCF0ZXh0dXJlKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBmcmFtZUlkICInICsgZnJhbWVJZCArICciIGRvZXMgbm90IGV4aXN0IGluIHRoZSB0ZXh0dXJlIGNhY2hlICcgKyB0aGlzKTsKICAgIHJldHVybiB0ZXh0dXJlOwp9OwoKLyoqCiAqIEhlbHBlciBmdW5jdGlvbiB0aGF0IHJldHVybnMgYSB0ZXh0dXJlIGJhc2VkIG9uIGEgY2FudmFzIGVsZW1lbnQKICogSWYgdGhlIGNhbnZhcyBpcyBub3QgaW4gdGhlIHRleHR1cmUgY2FjaGUgaXQgd2lsbCBiZSAgY3JlYXRlZCBhbmQgbG9hZGVkCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCBmcm9tQ2FudmFzCiAqIEBwYXJhbSBjYW52YXMge0NhbnZhc30gVGhlIGNhbnZhcyBlbGVtZW50IHNvdXJjZSBvZiB0aGUgdGV4dHVyZQogKiBAcmV0dXJuIFRleHR1cmUKICovClBJWEkuVGV4dHVyZS5mcm9tQ2FudmFzID0gZnVuY3Rpb24oY2FudmFzLCBzY2FsZU1vZGUpCnsKICAgIHZhciBiYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKGNhbnZhcywgc2NhbGVNb2RlKTsKICAgIHJldHVybiBuZXcgUElYSS5UZXh0dXJlKGJhc2VUZXh0dXJlKTsKfTsKCgovKioKICogQWRkcyBhIHRleHR1cmUgdG8gdGhlIHRleHR1cmVDYWNoZS4KICoKICogQHN0YXRpYwogKiBAbWV0aG9kIGFkZFRleHR1cmVUb0NhY2hlCiAqIEBwYXJhbSB0ZXh0dXJlIHtUZXh0dXJlfQogKiBAcGFyYW0gaWQge1N0cmluZ30gdGhlIGlkIHRoYXQgdGhlIHRleHR1cmUgd2lsbCBiZSBzdG9yZWQgYWdhaW5zdC4KICovClBJWEkuVGV4dHVyZS5hZGRUZXh0dXJlVG9DYWNoZSA9IGZ1bmN0aW9uKHRleHR1cmUsIGlkKQp7CiAgICBQSVhJLlRleHR1cmVDYWNoZVtpZF0gPSB0ZXh0dXJlOwp9OwoKLyoqCiAqIFJlbW92ZSBhIHRleHR1cmUgZnJvbSB0aGUgdGV4dHVyZUNhY2hlLgogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgcmVtb3ZlVGV4dHVyZUZyb21DYWNoZQogKiBAcGFyYW0gaWQge1N0cmluZ30gdGhlIGlkIG9mIHRoZSB0ZXh0dXJlIHRvIGJlIHJlbW92ZWQKICogQHJldHVybiB7VGV4dHVyZX0gdGhlIHRleHR1cmUgdGhhdCB3YXMgcmVtb3ZlZAogKi8KUElYSS5UZXh0dXJlLnJlbW92ZVRleHR1cmVGcm9tQ2FjaGUgPSBmdW5jdGlvbihpZCkKewogICAgdmFyIHRleHR1cmUgPSBQSVhJLlRleHR1cmVDYWNoZVtpZF07CiAgICBQSVhJLlRleHR1cmVDYWNoZVtpZF0gPSBudWxsOwogICAgcmV0dXJuIHRleHR1cmU7Cn07CgovLyB0aGlzIGlzIG1vcmUgZm9yIHdlYkdMLi4gaXQgY29udGFpbnMgdXBkYXRlZCBmcmFtZXMuLgpQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzID0gW107CgpQSVhJLlRleHR1cmUuU0NBTEVfTU9ERSA9IFBJWEkuQmFzZVRleHR1cmUuU0NBTEVfTU9ERTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKIEEgUmVuZGVyVGV4dHVyZSBpcyBhIHNwZWNpYWwgdGV4dHVyZSB0aGF0IGFsbG93cyBhbnkgcGl4aSBkaXNwbGF5T2JqZWN0IHRvIGJlIHJlbmRlcmVkIHRvIGl0LgoKIF9fSGludF9fOiBBbGwgRGlzcGxheU9iamVjdHMgKGV4bXBsLiBTcHJpdGVzKSB0aGF0IHJlbmRlcnMgb24gUmVuZGVyVGV4dHVyZSBzaG91bGQgYmUgcHJlbG9hZGVkLgogT3RoZXJ3aXNlIGJsYWNrIHJlY3RhbmdsZXMgd2lsbCBiZSBkcmF3biBpbnN0ZWFkLgoKIFJlbmRlclRleHR1cmUgdGFrZXMgc25hcHNob3Qgb2YgRGlzcGxheU9iamVjdCBwYXNzZWQgdG8gcmVuZGVyIG1ldGhvZC4gSWYgRGlzcGxheU9iamVjdCBpcyBwYXNzZWQgdG8gcmVuZGVyIG1ldGhvZCwgcG9zaXRpb24gYW5kIHJvdGF0aW9uIG9mIGl0IHdpbGwgYmUgaWdub3JlZC4gRm9yIGV4YW1wbGU6CgogICAgdmFyIHJlbmRlclRleHR1cmUgPSBuZXcgUElYSS5SZW5kZXJUZXh0dXJlKDgwMCwgNjAwKTsKICAgIHZhciBzcHJpdGUgPSBQSVhJLlNwcml0ZS5mcm9tSW1hZ2UoInNwaW5PYmpfMDEucG5nIik7CiAgICBzcHJpdGUucG9zaXRpb24ueCA9IDgwMC8yOwogICAgc3ByaXRlLnBvc2l0aW9uLnkgPSA2MDAvMjsKICAgIHNwcml0ZS5hbmNob3IueCA9IDAuNTsKICAgIHNwcml0ZS5hbmNob3IueSA9IDAuNTsKICAgIHJlbmRlclRleHR1cmUucmVuZGVyKHNwcml0ZSk7CgogU3ByaXRlIGluIHRoaXMgY2FzZSB3aWxsIGJlIHJlbmRlcmVkIHRvIDAsMCBwb3NpdGlvbi4gVG8gcmVuZGVyIHRoaXMgc3ByaXRlIGF0IGNlbnRlciBEaXNwbGF5T2JqZWN0Q29udGFpbmVyIHNob3VsZCBiZSB1c2VkOgoKICAgIHZhciBkb2MgPSBuZXcgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyKCk7CiAgICBkb2MuYWRkQ2hpbGQoc3ByaXRlKTsKICAgIHJlbmRlclRleHR1cmUucmVuZGVyKGRvYyk7ICAvLyBSZW5kZXJzIHRvIGNlbnRlciBvZiByZW5kZXJUZXh0dXJlCgogQGNsYXNzIFJlbmRlclRleHR1cmUKIEBleHRlbmRzIFRleHR1cmUKIEBjb25zdHJ1Y3RvcgogQHBhcmFtIHdpZHRoIHtOdW1iZXJ9IFRoZSB3aWR0aCBvZiB0aGUgcmVuZGVyIHRleHR1cmUKIEBwYXJhbSBoZWlnaHQge051bWJlcn0gVGhlIGhlaWdodCBvZiB0aGUgcmVuZGVyIHRleHR1cmUKICovClBJWEkuUmVuZGVyVGV4dHVyZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCnsKICAgIFBJWEkuRXZlbnRUYXJnZXQuY2FsbCggdGhpcyApOwoKICAgIHRoaXMud2lkdGggPSB3aWR0aCB8fCAxMDA7CiAgICB0aGlzLmhlaWdodCA9IGhlaWdodCB8fCAxMDA7CgogICAgdGhpcy5pbmRldGl0eU1hdHJpeCA9IFBJWEkubWF0My5jcmVhdGUoKTsKCiAgICB0aGlzLmZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCiAgICBpZihQSVhJLmdsKQogICAgewogICAgICAgIHRoaXMuaW5pdFdlYkdMKCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5pbml0Q2FudmFzKCk7CiAgICB9Cn07CgpQSVhJLlJlbmRlclRleHR1cmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5UZXh0dXJlLnByb3RvdHlwZSApOwpQSVhJLlJlbmRlclRleHR1cmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5SZW5kZXJUZXh0dXJlOwoKLyoqCiAqIEluaXRpYWxpemVzIHRoZSB3ZWJnbCBkYXRhIGZvciB0aGlzIHRleHR1cmUKICoKICogQG1ldGhvZCBpbml0V2ViR0wKICogQHByaXZhdGUKICovClBJWEkuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUuaW5pdFdlYkdMID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgZ2wgPSBQSVhJLmdsOwogICAgdGhpcy5nbEZyYW1lYnVmZmVyID0gZ2wuY3JlYXRlRnJhbWVidWZmZXIoKTsKCiAgICBnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHRoaXMuZ2xGcmFtZWJ1ZmZlciApOwoKICAgIHRoaXMuZ2xGcmFtZWJ1ZmZlci53aWR0aCA9IHRoaXMud2lkdGg7CiAgICB0aGlzLmdsRnJhbWVidWZmZXIuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CgogICAgdGhpcy5iYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKCk7CgogICAgdGhpcy5iYXNlVGV4dHVyZS53aWR0aCA9IHRoaXMud2lkdGg7CiAgICB0aGlzLmJhc2VUZXh0dXJlLmhlaWdodCA9IHRoaXMuaGVpZ2h0OwoKICAgIHRoaXMuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSA9IGdsLmNyZWF0ZVRleHR1cmUoKTsKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRoaXMuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CgogICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCAgdGhpcy53aWR0aCwgIHRoaXMuaGVpZ2h0LCAwLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKTsKCiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUFHX0ZJTFRFUiwgZ2wuTElORUFSKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBnbC5MSU5FQVIpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5DTEFNUF9UT19FREdFKTsKCiAgICB0aGlzLmJhc2VUZXh0dXJlLmlzUmVuZGVyID0gdHJ1ZTsKCiAgICBnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHRoaXMuZ2xGcmFtZWJ1ZmZlciApOwogICAgZ2wuZnJhbWVidWZmZXJUZXh0dXJlMkQoZ2wuRlJBTUVCVUZGRVIsIGdsLkNPTE9SX0FUVEFDSE1FTlQwLCBnbC5URVhUVVJFXzJELCB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUsIDApOwoKICAgIC8vIGNyZWF0ZSBhIHByb2plY3Rpb24gbWF0cml4Li4KICAgIHRoaXMucHJvamVjdGlvbiA9IG5ldyBQSVhJLlBvaW50KHRoaXMud2lkdGgvMiAsIC10aGlzLmhlaWdodC8yKTsKCiAgICAvLyBzZXQgdGhlIGNvcnJlY3QgcmVuZGVyIGZ1bmN0aW9uLi4KICAgIHRoaXMucmVuZGVyID0gdGhpcy5yZW5kZXJXZWJHTDsKfTsKCgpQSVhJLlJlbmRlclRleHR1cmUucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCnsKCiAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKCiAgICBpZihQSVhJLmdsKQogICAgewogICAgICAgIHRoaXMucHJvamVjdGlvbi54ID0gdGhpcy53aWR0aCAvIDI7CiAgICAgICAgdGhpcy5wcm9qZWN0aW9uLnkgPSAtdGhpcy5oZWlnaHQgLyAyOwoKICAgICAgICB2YXIgZ2wgPSBQSVhJLmdsOwogICAgICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRoaXMuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CiAgICAgICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCAgdGhpcy53aWR0aCwgIHRoaXMuaGVpZ2h0LCAwLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKTsKICAgIH0KICAgIGVsc2UKICAgIHsKCiAgICAgICAgdGhpcy5mcmFtZS53aWR0aCA9IHRoaXMud2lkdGg7CiAgICAgICAgdGhpcy5mcmFtZS5oZWlnaHQgPSB0aGlzLmhlaWdodDsKICAgICAgICB0aGlzLnJlbmRlcmVyLnJlc2l6ZSh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CiAgICB9Cn07CgovKioKICogSW5pdGlhbGl6ZXMgdGhlIGNhbnZhcyBkYXRhIGZvciB0aGlzIHRleHR1cmUKICoKICogQG1ldGhvZCBpbml0Q2FudmFzCiAqIEBwcml2YXRlCiAqLwpQSVhJLlJlbmRlclRleHR1cmUucHJvdG90eXBlLmluaXRDYW52YXMgPSBmdW5jdGlvbigpCnsKICAgIHRoaXMucmVuZGVyZXIgPSBuZXcgUElYSS5DYW52YXNSZW5kZXJlcih0aGlzLndpZHRoLCB0aGlzLmhlaWdodCwgbnVsbCwgMCk7CgogICAgdGhpcy5iYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKHRoaXMucmVuZGVyZXIudmlldyk7CiAgICB0aGlzLmZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCiAgICB0aGlzLnJlbmRlciA9IHRoaXMucmVuZGVyQ2FudmFzOwp9OwoKLyoqCiAqIFRoaXMgZnVuY3Rpb24gd2lsbCBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdCB0byB0aGUgdGV4dHVyZS4KICoKICogQG1ldGhvZCByZW5kZXJXZWJHTAogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIHJlbmRlciB0aGlzIHRleHR1cmUgb24KICogQHBhcmFtIGNsZWFyIHtCb29sZWFufSBJZiB0cnVlIHRoZSB0ZXh0dXJlIHdpbGwgYmUgY2xlYXJlZCBiZWZvcmUgdGhlIGRpc3BsYXlPYmplY3QgaXMgZHJhd24KICogQHByaXZhdGUKICovClBJWEkuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUucmVuZGVyV2ViR0wgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0LCBwb3NpdGlvbiwgY2xlYXIpCnsKICAgIHZhciBnbCA9IFBJWEkuZ2w7CgogICAgLy8gZW5hYmxlIHRoZSBhbHBoYSBjb2xvciBtYXNrLi4KICAgIGdsLmNvbG9yTWFzayh0cnVlLCB0cnVlLCB0cnVlLCB0cnVlKTsKCiAgICBnbC52aWV3cG9ydCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgogICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0aGlzLmdsRnJhbWVidWZmZXIgKTsKCiAgICBpZihjbGVhcikKICAgIHsKICAgICAgICBnbC5jbGVhckNvbG9yKDAsMCwwLCAwKTsKICAgICAgICBnbC5jbGVhcihnbC5DT0xPUl9CVUZGRVJfQklUKTsKICAgIH0KCiAgICAvLyBUSElTIFdJTEwgTUVTUyBXSVRIIEhJVCBURVNUSU5HIQogICAgdmFyIGNoaWxkcmVuID0gZGlzcGxheU9iamVjdC5jaGlsZHJlbjsKCiAgICAvL1RPRE8gLT8gY3JlYXRlIGEgbmV3IG9uZT8/PyBkb250IHRoaW5rIHNvIQogICAgdmFyIG9yaWdpbmFsV29ybGRUcmFuc2Zvcm0gPSBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtOwogICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybSA9IFBJWEkubWF0My5jcmVhdGUoKTsvL3N0aGlzLmluZGV0aXR5TWF0cml4OwogICAgLy8gbW9kaWZ5IHRvIGZsaXAuLi4KICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNF0gPSAtMTsKICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0gPSB0aGlzLnByb2plY3Rpb24ueSAqIC0yOwoKICAgIGlmKHBvc2l0aW9uKQogICAgewogICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0gPSBwb3NpdGlvbi54OwogICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0gLT0gcG9zaXRpb24ueTsKICAgIH0KCiAgICBQSVhJLnZpc2libGVDb3VudCsrOwogICAgZGlzcGxheU9iamVjdC52Y291bnQgPSBQSVhJLnZpc2libGVDb3VudDsKCiAgICBmb3IodmFyIGk9MCxqPWNoaWxkcmVuLmxlbmd0aDsgaTxqOyBpKyspCiAgICB7CiAgICAgICAgY2hpbGRyZW5baV0udXBkYXRlVHJhbnNmb3JtKCk7CiAgICB9CgogICAgdmFyIHJlbmRlckdyb3VwID0gZGlzcGxheU9iamVjdC5fX3JlbmRlckdyb3VwOwoKICAgIGlmKHJlbmRlckdyb3VwKQogICAgewogICAgICAgIGlmKGRpc3BsYXlPYmplY3QgPT09IHJlbmRlckdyb3VwLnJvb3QpCiAgICAgICAgewogICAgICAgICAgICByZW5kZXJHcm91cC5yZW5kZXIodGhpcy5wcm9qZWN0aW9uLCB0aGlzLmdsRnJhbWVidWZmZXIpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZW5kZXJHcm91cC5yZW5kZXJTcGVjaWZpYyhkaXNwbGF5T2JqZWN0LCB0aGlzLnByb2plY3Rpb24sIHRoaXMuZ2xGcmFtZWJ1ZmZlcik7CiAgICAgICAgfQogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGlmKCF0aGlzLnJlbmRlckdyb3VwKXRoaXMucmVuZGVyR3JvdXAgPSBuZXcgUElYSS5XZWJHTFJlbmRlckdyb3VwKGdsKTsKICAgICAgICB0aGlzLnJlbmRlckdyb3VwLnNldFJlbmRlcmFibGUoZGlzcGxheU9iamVjdCk7CiAgICAgICAgdGhpcy5yZW5kZXJHcm91cC5yZW5kZXIodGhpcy5wcm9qZWN0aW9uLCB0aGlzLmdsRnJhbWVidWZmZXIpOwogICAgfQoKICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm0gPSBvcmlnaW5hbFdvcmxkVHJhbnNmb3JtOwp9OwoKCi8qKgogKiBUaGlzIGZ1bmN0aW9uIHdpbGwgZHJhdyB0aGUgZGlzcGxheSBvYmplY3QgdG8gdGhlIHRleHR1cmUuCiAqCiAqIEBtZXRob2QgcmVuZGVyQ2FudmFzCiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fSBUaGUgZGlzcGxheSBvYmplY3QgdG8gcmVuZGVyIHRoaXMgdGV4dHVyZSBvbgogKiBAcGFyYW0gY2xlYXIge0Jvb2xlYW59IElmIHRydWUgdGhlIHRleHR1cmUgd2lsbCBiZSBjbGVhcmVkIGJlZm9yZSB0aGUgZGlzcGxheU9iamVjdCBpcyBkcmF3bgogKiBAcHJpdmF0ZQogKi8KUElYSS5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5yZW5kZXJDYW52YXMgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0LCBwb3NpdGlvbiwgY2xlYXIpCnsKICAgIHZhciBjaGlsZHJlbiA9IGRpc3BsYXlPYmplY3QuY2hpbGRyZW47CgogICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybSA9IFBJWEkubWF0My5jcmVhdGUoKTsKCiAgICBpZihwb3NpdGlvbikKICAgIHsKICAgICAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzJdID0gcG9zaXRpb24ueDsKICAgICAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdID0gcG9zaXRpb24ueTsKICAgIH0KCgogICAgZm9yKHZhciBpID0gMCwgaiA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGo7IGkrKykKICAgIHsKICAgICAgICBjaGlsZHJlbltpXS51cGRhdGVUcmFuc2Zvcm0oKTsKICAgIH0KCiAgICBpZihjbGVhcikgdGhpcy5yZW5kZXJlci5jb250ZXh0LmNsZWFyUmVjdCgwLDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCiAgICB0aGlzLnJlbmRlcmVyLnJlbmRlckRpc3BsYXlPYmplY3QoZGlzcGxheU9iamVjdCk7CgogICAgdGhpcy5yZW5kZXJlci5jb250ZXh0LnNldFRyYW5zZm9ybSgxLDAsMCwxLDAsMCk7CgogICAgLy9QSVhJLnRleHR1cmVzVG9VcGRhdGUucHVzaCh0aGlzLmJhc2VUZXh0dXJlKTsKfTsKCi8qKgogKiBodHRwczovL2dpdGh1Yi5jb20vbXJkb29iL2V2ZW50dGFyZ2V0LmpzLwogKiBUSGFua1MgbXIgRE9vYiEKICovCgovKioKICogQWRkcyBldmVudCBlbWl0dGVyIGZ1bmN0aW9uYWxpdHkgdG8gYSBjbGFzcwogKgogKiBAY2xhc3MgRXZlbnRUYXJnZXQKICogQGV4YW1wbGUKICogICAgICBmdW5jdGlvbiBNeUVtaXR0ZXIoKSB7CiAqICAgICAgICAgIFBJWEkuRXZlbnRUYXJnZXQuY2FsbCh0aGlzKTsgLy9taXhlcyBpbiBldmVudCB0YXJnZXQgc3R1ZmYKICogICAgICB9CiAqCiAqICAgICAgdmFyIGVtID0gbmV3IE15RW1pdHRlcigpOwogKiAgICAgIGVtLmVtaXQoeyB0eXBlOiAnZXZlbnROYW1lJywgZGF0YTogJ3NvbWUgZGF0YScgfSk7CiAqLwpQSVhJLkV2ZW50VGFyZ2V0ID0gZnVuY3Rpb24gKCkgewoKICAgIHZhciBsaXN0ZW5lcnMgPSB7fTsKCiAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIgPSB0aGlzLm9uID0gZnVuY3Rpb24gKCB0eXBlLCBsaXN0ZW5lciApIHsKCgogICAgICAgIGlmICggbGlzdGVuZXJzWyB0eXBlIF0gPT09IHVuZGVmaW5lZCApIHsKCiAgICAgICAgICAgIGxpc3RlbmVyc1sgdHlwZSBdID0gW107CgogICAgICAgIH0KCiAgICAgICAgaWYgKCBsaXN0ZW5lcnNbIHR5cGUgXS5pbmRleE9mKCBsaXN0ZW5lciApID09PSAtIDEgKSB7CgogICAgICAgICAgICBsaXN0ZW5lcnNbIHR5cGUgXS5wdXNoKCBsaXN0ZW5lciApOwogICAgICAgIH0KCiAgICB9OwoKICAgIHRoaXMuZGlzcGF0Y2hFdmVudCA9IHRoaXMuZW1pdCA9IGZ1bmN0aW9uICggZXZlbnQgKSB7CgogICAgICAgIGlmICggIWxpc3RlbmVyc1sgZXZlbnQudHlwZSBdIHx8ICFsaXN0ZW5lcnNbIGV2ZW50LnR5cGUgXS5sZW5ndGggKSB7CgogICAgICAgICAgICByZXR1cm47CgogICAgICAgIH0KCiAgICAgICAgZm9yKHZhciBpID0gMCwgbCA9IGxpc3RlbmVyc1sgZXZlbnQudHlwZSBdLmxlbmd0aDsgaSA8IGw7IGkrKykgewoKICAgICAgICAgICAgbGlzdGVuZXJzWyBldmVudC50eXBlIF1bIGkgXSggZXZlbnQgKTsKCiAgICAgICAgfQoKICAgIH07CgogICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyID0gdGhpcy5vZmYgPSBmdW5jdGlvbiAoIHR5cGUsIGxpc3RlbmVyICkgewoKICAgICAgICB2YXIgaW5kZXggPSBsaXN0ZW5lcnNbIHR5cGUgXS5pbmRleE9mKCBsaXN0ZW5lciApOwoKICAgICAgICBpZiAoIGluZGV4ICE9PSAtIDEgKSB7CgogICAgICAgICAgICBsaXN0ZW5lcnNbIHR5cGUgXS5zcGxpY2UoIGluZGV4LCAxICk7CgogICAgICAgIH0KCiAgICB9OwoKCXRoaXMucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMgPSBmdW5jdGlvbiggdHlwZSApIHsKCQl2YXIgYSA9IGxpc3RlbmVyc1t0eXBlXTsKCQlpZiAoYSkKCQkJYS5sZW5ndGggPSAwOwoJfTsKfTsKCi8qCiAgICBQb2x5SyBsaWJyYXJ5CiAgICB1cmw6IGh0dHA6Ly9wb2x5ay5pdmFuay5uZXQKICAgIFJlbGVhc2VkIHVuZGVyIE1JVCBsaWNlbmNlLgoKICAgIENvcHlyaWdodCAoYykgMjAxMiBJdmFuIEt1Y2tpcgoKICAgIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uCiAgICBvYnRhaW5pbmcgYSBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbgogICAgZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dAogICAgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsCiAgICBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogICAgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlCiAgICBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZwogICAgY29uZGl0aW9uczoKCiAgICBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQogICAgaW5jbHVkZWQgaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgogICAgVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsCiAgICBFWFBSRVNTIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMKICAgIE9GIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5ECiAgICBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVAogICAgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksCiAgICBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcKICAgIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IKICAgIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCiAgICBUaGlzIGlzIGFuIGFtYXppbmcgbGliIQoKICAgIHNsaWdodGx5IG1vZGlmaWVkIGJ5IG1hdCBncm92ZXMgKG1hdGdyb3Zlcy5jb20pOwoqLwoKUElYSS5Qb2x5SyA9IHt9OwoKLyoqCiAqIFRyaWFuZ3VsYXRlcyBzaGFwZXMgZm9yIHdlYkdMIGdyYXBoaWMgZmlsbHMKICoKICogQG1ldGhvZCBUcmlhbmd1bGF0ZQogKiBAbmFtZXNwYWNlIFBvbHlLCiAqIEBjb25zdHJ1Y3RvcgogKi8KUElYSS5Qb2x5Sy5Ucmlhbmd1bGF0ZSA9IGZ1bmN0aW9uKHApCnsKICAgIHZhciBzaWduID0gdHJ1ZTsKCiAgICB2YXIgbiA9IHAubGVuZ3RoID4+IDE7CiAgICBpZihuIDwgMykgcmV0dXJuIFtdOwoKICAgIHZhciB0Z3MgPSBbXTsKICAgIHZhciBhdmwgPSBbXTsKICAgIGZvcih2YXIgaSA9IDA7IGkgPCBuOyBpKyspIGF2bC5wdXNoKGkpOwoKICAgIGkgPSAwOwogICAgdmFyIGFsID0gbjsKICAgIHdoaWxlKGFsID4gMykKICAgIHsKICAgICAgICB2YXIgaTAgPSBhdmxbKGkrMCklYWxdOwogICAgICAgIHZhciBpMSA9IGF2bFsoaSsxKSVhbF07CiAgICAgICAgdmFyIGkyID0gYXZsWyhpKzIpJWFsXTsKCiAgICAgICAgdmFyIGF4ID0gcFsyKmkwXSwgIGF5ID0gcFsyKmkwKzFdOwogICAgICAgIHZhciBieCA9IHBbMippMV0sICBieSA9IHBbMippMSsxXTsKICAgICAgICB2YXIgY3ggPSBwWzIqaTJdLCAgY3kgPSBwWzIqaTIrMV07CgogICAgICAgIHZhciBlYXJGb3VuZCA9IGZhbHNlOwogICAgICAgIGlmKFBJWEkuUG9seUsuX2NvbnZleChheCwgYXksIGJ4LCBieSwgY3gsIGN5LCBzaWduKSkKICAgICAgICB7CiAgICAgICAgICAgIGVhckZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgZm9yKHZhciBqID0gMDsgaiA8IGFsOyBqKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB2aSA9IGF2bFtqXTsKICAgICAgICAgICAgICAgIGlmKHZpID09PSBpMCB8fCB2aSA9PT0gaTEgfHwgdmkgPT09IGkyKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBpZihQSVhJLlBvbHlLLl9Qb2ludEluVHJpYW5nbGUocFsyKnZpXSwgcFsyKnZpKzFdLCBheCwgYXksIGJ4LCBieSwgY3gsIGN5KSkgewogICAgICAgICAgICAgICAgICAgIGVhckZvdW5kID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmKGVhckZvdW5kKQogICAgICAgIHsKICAgICAgICAgICAgdGdzLnB1c2goaTAsIGkxLCBpMik7CiAgICAgICAgICAgIGF2bC5zcGxpY2UoKGkrMSklYWwsIDEpOwogICAgICAgICAgICBhbC0tOwogICAgICAgICAgICBpID0gMDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZihpKysgPiAzKmFsKQogICAgICAgIHsKICAgICAgICAgICAgLy8gbmVlZCB0byBmbGlwIGZsaXAgcmV2ZXJzZSBpdCEKICAgICAgICAgICAgLy8gcmVzZXQhCiAgICAgICAgICAgIGlmKHNpZ24pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRncyA9IFtdOwogICAgICAgICAgICAgICAgYXZsID0gW107CiAgICAgICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBuOyBpKyspIGF2bC5wdXNoKGkpOwoKICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgYWwgPSBuOwoKICAgICAgICAgICAgICAgIHNpZ24gPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygiUElYSSBXYXJuaW5nOiBzaGFwZSB0b28gY29tcGxleCB0byBmaWxsIik7CiAgICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgdGdzLnB1c2goYXZsWzBdLCBhdmxbMV0sIGF2bFsyXSk7CiAgICByZXR1cm4gdGdzOwp9OwoKLyoqCiAqIENoZWNrcyBpZiBhIHBvaW50IGlzIHdpdGhpbiBhIHRyaWFuZ2xlCiAqCiAqIEBjbGFzcyBfUG9pbnRJblRyaWFuZ2xlCiAqIEBuYW1lc3BhY2UgUG9seUsKICogQHByaXZhdGUKICovClBJWEkuUG9seUsuX1BvaW50SW5UcmlhbmdsZSA9IGZ1bmN0aW9uKHB4LCBweSwgYXgsIGF5LCBieCwgYnksIGN4LCBjeSkKewogICAgdmFyIHYweCA9IGN4LWF4OwogICAgdmFyIHYweSA9IGN5LWF5OwogICAgdmFyIHYxeCA9IGJ4LWF4OwogICAgdmFyIHYxeSA9IGJ5LWF5OwogICAgdmFyIHYyeCA9IHB4LWF4OwogICAgdmFyIHYyeSA9IHB5LWF5OwoKICAgIHZhciBkb3QwMCA9IHYweCp2MHgrdjB5KnYweTsKICAgIHZhciBkb3QwMSA9IHYweCp2MXgrdjB5KnYxeTsKICAgIHZhciBkb3QwMiA9IHYweCp2MngrdjB5KnYyeTsKICAgIHZhciBkb3QxMSA9IHYxeCp2MXgrdjF5KnYxeTsKICAgIHZhciBkb3QxMiA9IHYxeCp2MngrdjF5KnYyeTsKCiAgICB2YXIgaW52RGVub20gPSAxIC8gKGRvdDAwICogZG90MTEgLSBkb3QwMSAqIGRvdDAxKTsKICAgIHZhciB1ID0gKGRvdDExICogZG90MDIgLSBkb3QwMSAqIGRvdDEyKSAqIGludkRlbm9tOwogICAgdmFyIHYgPSAoZG90MDAgKiBkb3QxMiAtIGRvdDAxICogZG90MDIpICogaW52RGVub207CgogICAgLy8gQ2hlY2sgaWYgcG9pbnQgaXMgaW4gdHJpYW5nbGUKICAgIHJldHVybiAodSA+PSAwKSAmJiAodiA+PSAwKSAmJiAodSArIHYgPCAxKTsKfTsKCi8qKgogKiBDaGVja3MgaWYgYSBzaGFwZSBpcyBjb252ZXgKICoKICogQGNsYXNzIF9jb252ZXgKICogQG5hbWVzcGFjZSBQb2x5SwogKiBAcHJpdmF0ZQogKi8KUElYSS5Qb2x5Sy5fY29udmV4ID0gZnVuY3Rpb24oYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgc2lnbikKewogICAgcmV0dXJuICgoYXktYnkpKihjeC1ieCkgKyAoYngtYXgpKihjeS1ieSkgPj0gMCkgPT09IHNpZ247Cn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIENhbWVyYSBpcyB5b3VyIHZpZXcgaW50byB0aGUgZ2FtZSB3b3JsZC4gSXQgaGFzIGEgcG9zaXRpb24gYW5kIHNpemUgYW5kIHJlbmRlcnMgb25seSB0aG9zZSBvYmplY3RzIHdpdGhpbiBpdHMgZmllbGQgb2Ygdmlldy4KKiBUaGUgZ2FtZSBhdXRvbWF0aWNhbGx5IGNyZWF0ZXMgYSBzaW5nbGUgU3RhZ2Ugc2l6ZWQgY2FtZXJhIG9uIGJvb3QuIE1vdmUgdGhlIGNhbWVyYSBhcm91bmQgdGhlIHdvcmxkIHdpdGggUGhhc2VyLkNhbWVyYS54L3kKKgoqIEBjbGFzcyBQaGFzZXIuQ2FtZXJhCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEdhbWUgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7bnVtYmVyfSBpZCAtIE5vdCBiZWluZyB1c2VkIGF0IHRoZSBtb21lbnQsIHdpbGwgYmUgd2hlbiBQaGFzZXIgc3VwcG9ydHMgbXVsdGlwbGUgY2FtZXJhCiogQHBhcmFtIHtudW1iZXJ9IHggLSBQb3NpdGlvbiBvZiB0aGUgY2FtZXJhIG9uIHRoZSBYIGF4aXMKKiBAcGFyYW0ge251bWJlcn0geSAtIFBvc2l0aW9uIG9mIHRoZSBjYW1lcmEgb24gdGhlIFkgYXhpcwoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgdmlldyByZWN0YW5nbGUKKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgdmlldyByZWN0YW5nbGUKKi8KUGhhc2VyLkNhbWVyYSA9IGZ1bmN0aW9uIChnYW1lLCBpZCwgeCwgeSwgd2lkdGgsIGhlaWdodCkgewogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLldvcmxkfSB3b3JsZCAtIEEgcmVmZXJlbmNlIHRvIHRoZSBnYW1lIHdvcmxkLgogICAgKi8KICAgIHRoaXMud29ybGQgPSBnYW1lLndvcmxkOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaWQgLSBSZXNlcnZlZCBmb3IgZnV0dXJlIG11bHRpcGxlIGNhbWVyYSBzZXQtdXBzLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaWQgPSAwOwoKICAgIC8qKgogICAgKiBDYW1lcmEgdmlldy4gCiAgICAqIFRoZSB2aWV3IGludG8gdGhlIHdvcmxkIHdlIHdpc2ggdG8gcmVuZGVyIChieSBkZWZhdWx0IHRoZSBnYW1lIGRpbWVuc2lvbnMpLgogICAgKiBUaGUgeC95IHZhbHVlcyBhcmUgaW4gd29ybGQgY29vcmRpbmF0ZXMsIG5vdCBzY3JlZW4gY29vcmRpbmF0ZXMsIHRoZSB3aWR0aC9oZWlnaHQgaXMgaG93IG1hbnkgcGl4ZWxzIHRvIHJlbmRlci4KICAgICogT2JqZWN0cyBvdXRzaWRlIG9mIHRoaXMgdmlldyBhcmUgbm90IHJlbmRlcmVkIGlmIHNldCB0byBjYW1lcmEgY3VsbC4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSB2aWV3CiAgICAqLwogICAgdGhpcy52aWV3ID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoeCwgeSwgd2lkdGgsIGhlaWdodCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gc2NyZWVuVmlldyAtIFVzZWQgYnkgU3ByaXRlcyB0byB3b3JrIG91dCBDYW1lcmEgY3VsbGluZy4KICAgICovCiAgICB0aGlzLnNjcmVlblZpZXcgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSh4LCB5LCB3aWR0aCwgaGVpZ2h0KTsKCiAgICAvKioKICAgICogVGhlIENhbWVyYSBpcyBib3VuZCB0byB0aGlzIFJlY3RhbmdsZSBhbmQgY2Fubm90IG1vdmUgb3V0c2lkZSBvZiBpdC4gQnkgZGVmYXVsdCBpdCBpcyBlbmFibGVkIGFuZCBzZXQgdG8gdGhlIHNpemUgb2YgdGhlIFdvcmxkLgogICAgKiBUaGUgUmVjdGFuZ2xlIGNhbiBiZSBsb2NhdGVkIGFueXdoZXJlIGluIHRoZSB3b3JsZCBhbmQgdXBkYXRlZCBhcyBvZnRlbiBhcyB5b3UgbGlrZS4gSWYgeW91IGRvbid0IHdpc2ggdGhlIENhbWVyYSB0byBiZSBib3VuZAogICAgKiBhdCBhbGwgdGhlbiBzZXQgdGhpcyB0byBudWxsLiBUaGUgdmFsdWVzIGNhbiBiZSBhbnl0aGluZyBhbmQgYXJlIGluIFdvcmxkIGNvb3JkaW5hdGVzLCB3aXRoIDAsMCBiZWluZyB0aGUgY2VudGVyIG9mIHRoZSB3b3JsZC4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSBib3VuZHMgLSBUaGUgUmVjdGFuZ2xlIGluIHdoaWNoIHRoZSBDYW1lcmEgaXMgYm91bmRlZC4gU2V0IHRvIG51bGwgdG8gYWxsb3cgZm9yIG1vdmVtZW50IGFueXdoZXJlLgogICAgKi8KICAgIHRoaXMuYm91bmRzID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoeCwgeSwgd2lkdGgsIGhlaWdodCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gZGVhZHpvbmUgLSBNb3ZpbmcgaW5zaWRlIHRoaXMgUmVjdGFuZ2xlIHdpbGwgbm90IGNhdXNlIGNhbWVyYSBtb3ZpbmcuCiAgICAqLwogICAgdGhpcy5kZWFkem9uZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmlzaWJsZSAtIFdoZXRoZXIgdGhpcyBjYW1lcmEgaXMgdmlzaWJsZSBvciBub3QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy52aXNpYmxlID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhdExpbWl0IC0gV2hldGhlciB0aGlzIGNhbWVyYSBpcyBmbHVzaCB3aXRoIHRoZSBXb3JsZCBCb3VuZHMgb3Igbm90LgogICAgKi8KICAgIHRoaXMuYXRMaW1pdCA9IHsgeDogZmFsc2UsIHk6IGZhbHNlIH07CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNwcml0ZX0gdGFyZ2V0IC0gSWYgdGhlIGNhbWVyYSBpcyB0cmFja2luZyBhIFNwcml0ZSwgdGhpcyBpcyBhIHJlZmVyZW5jZSB0byBpdCwgb3RoZXJ3aXNlIG51bGwuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50YXJnZXQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZWRnZSAtIEVkZ2UgcHJvcGVydHkuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fZWRnZSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UElYSS5EaXNwbGF5T2JqZWN0fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIHdoaWNoIGFsbCBnYW1lIG9iamVjdHMgYXJlIGFkZGVkLiBTZXQgYnkgV29ybGQuYm9vdAogICAgKi8KICAgIHRoaXMuZGlzcGxheU9iamVjdCA9IG51bGw7CiAgICAKfTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5DYW1lcmEuRk9MTE9XX0xPQ0tPTiA9IDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuQ2FtZXJhLkZPTExPV19QTEFURk9STUVSID0gMTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5DYW1lcmEuRk9MTE9XX1RPUERPV04gPSAyOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkNhbWVyYS5GT0xMT1dfVE9QRE9XTl9USUdIVCA9IDM7CgpQaGFzZXIuQ2FtZXJhLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogVGVsbHMgdGhpcyBjYW1lcmEgd2hpY2ggc3ByaXRlIHRvIGZvbGxvdy4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FtZXJhI2ZvbGxvdwogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHRhcmdldCAtIFRoZSBvYmplY3QgeW91IHdhbnQgdGhlIGNhbWVyYSB0byB0cmFjay4gU2V0IHRvIG51bGwgdG8gbm90IGZvbGxvdyBhbnl0aGluZy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzdHlsZV0gTGV2ZXJhZ2Ugb25lIG9mIHRoZSBleGlzdGluZyAiZGVhZHpvbmUiIHByZXNldHMuIElmIHlvdSB1c2UgYSBjdXN0b20gZGVhZHpvbmUsIGlnbm9yZSB0aGlzIHBhcmFtZXRlciBhbmQgbWFudWFsbHkgc3BlY2lmeSB0aGUgZGVhZHpvbmUgYWZ0ZXIgY2FsbGluZyBmb2xsb3coKS4KICAgICovCiAgICBmb2xsb3c6IGZ1bmN0aW9uICh0YXJnZXQsIHN0eWxlKSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3R5bGUgPT09ICJ1bmRlZmluZWQiKSB7IHN0eWxlID0gUGhhc2VyLkNhbWVyYS5GT0xMT1dfTE9DS09OOyB9CgogICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwoKICAgICAgICB2YXIgaGVscGVyOwoKICAgICAgICBzd2l0Y2ggKHN0eWxlKSB7CgogICAgICAgICAgICBjYXNlIFBoYXNlci5DYW1lcmEuRk9MTE9XX1BMQVRGT1JNRVI6CiAgICAgICAgICAgICAgICB2YXIgdyA9IHRoaXMud2lkdGggLyA4OwogICAgICAgICAgICAgICAgdmFyIGggPSB0aGlzLmhlaWdodCAvIDM7CiAgICAgICAgICAgICAgICB0aGlzLmRlYWR6b25lID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoKHRoaXMud2lkdGggLSB3KSAvIDIsICh0aGlzLmhlaWdodCAtIGgpIC8gMiAtIGggKiAwLjI1LCB3LCBoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSBQaGFzZXIuQ2FtZXJhLkZPTExPV19UT1BET1dOOgogICAgICAgICAgICAgICAgaGVscGVyID0gTWF0aC5tYXgodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpIC8gNDsKICAgICAgICAgICAgICAgIHRoaXMuZGVhZHpvbmUgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgodGhpcy53aWR0aCAtIGhlbHBlcikgLyAyLCAodGhpcy5oZWlnaHQgLSBoZWxwZXIpIC8gMiwgaGVscGVyLCBoZWxwZXIpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIFBoYXNlci5DYW1lcmEuRk9MTE9XX1RPUERPV05fVElHSFQ6CiAgICAgICAgICAgICAgICBoZWxwZXIgPSBNYXRoLm1heCh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCkgLyA4OwogICAgICAgICAgICAgICAgdGhpcy5kZWFkem9uZSA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKCh0aGlzLndpZHRoIC0gaGVscGVyKSAvIDIsICh0aGlzLmhlaWdodCAtIGhlbHBlcikgLyAyLCBoZWxwZXIsIGhlbHBlcik7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgUGhhc2VyLkNhbWVyYS5GT0xMT1dfTE9DS09OOgogICAgICAgICAgICAgICAgdGhpcy5kZWFkem9uZSA9IG51bGw7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aGlzLmRlYWR6b25lID0gbnVsbDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBNb3ZlIHRoZSBjYW1lcmEgZm9jdXMgb24gYSBkaXNwbGF5IG9iamVjdCBpbnN0YW50bHkuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbWVyYSNmb2N1c09uCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIGZvY3VzIHRoZSBjYW1lcmEgb24uIE11c3QgaGF2ZSB2aXNpYmxlIHgveSBwcm9wZXJ0aWVzLgogICAgKi8KICAgIGZvY3VzT246IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0KSB7CgogICAgICAgIHRoaXMuc2V0UG9zaXRpb24oTWF0aC5yb3VuZChkaXNwbGF5T2JqZWN0LnggLSB0aGlzLnZpZXcuaGFsZldpZHRoKSwgTWF0aC5yb3VuZChkaXNwbGF5T2JqZWN0LnkgLSB0aGlzLnZpZXcuaGFsZkhlaWdodCkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIE1vdmUgdGhlIGNhbWVyYSBmb2N1cyBvbiBhIGxvY2F0aW9uIGluc3RhbnRseS4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FtZXJhI2ZvY3VzT25YWQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbi4KICAgICovCiAgICBmb2N1c09uWFk6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMuc2V0UG9zaXRpb24oTWF0aC5yb3VuZCh4IC0gdGhpcy52aWV3LmhhbGZXaWR0aCksIE1hdGgucm91bmQoeSAtIHRoaXMudmlldy5oYWxmSGVpZ2h0KSk7CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlIGZvY3VzaW5nIGFuZCBzY3JvbGxpbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbWVyYSN1cGRhdGUKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMudGFyZ2V0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVUYXJnZXQoKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmJvdW5kcykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tCb3VuZHMoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZGlzcGxheU9iamVjdC5wb3NpdGlvbi54ID0gLXRoaXMudmlldy54OwogICAgICAgIHRoaXMuZGlzcGxheU9iamVjdC5wb3NpdGlvbi55ID0gLXRoaXMudmlldy55OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZAogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjdXBkYXRlVGFyZ2V0CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdXBkYXRlVGFyZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmRlYWR6b25lKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZWRnZSA9IHRoaXMudGFyZ2V0LnggLSB0aGlzLmRlYWR6b25lLng7CgogICAgICAgICAgICBpZiAodGhpcy52aWV3LnggPiB0aGlzLl9lZGdlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnZpZXcueCA9IHRoaXMuX2VkZ2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2VkZ2UgPSB0aGlzLnRhcmdldC54ICsgdGhpcy50YXJnZXQud2lkdGggLSB0aGlzLmRlYWR6b25lLnggLSB0aGlzLmRlYWR6b25lLndpZHRoOwoKICAgICAgICAgICAgaWYgKHRoaXMudmlldy54IDwgdGhpcy5fZWRnZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy52aWV3LnggPSB0aGlzLl9lZGdlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9lZGdlID0gdGhpcy50YXJnZXQueSAtIHRoaXMuZGVhZHpvbmUueTsKCiAgICAgICAgICAgIGlmICh0aGlzLnZpZXcueSA+IHRoaXMuX2VkZ2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlldy55ID0gdGhpcy5fZWRnZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fZWRnZSA9IHRoaXMudGFyZ2V0LnkgKyB0aGlzLnRhcmdldC5oZWlnaHQgLSB0aGlzLmRlYWR6b25lLnkgLSB0aGlzLmRlYWR6b25lLmhlaWdodDsKCiAgICAgICAgICAgIGlmICh0aGlzLnZpZXcueSA8IHRoaXMuX2VkZ2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlldy55ID0gdGhpcy5fZWRnZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZvY3VzT25YWSh0aGlzLnRhcmdldC54LCB0aGlzLnRhcmdldC55KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlIHRoZSBDYW1lcmEgYm91bmRzIHRvIG1hdGNoIHRoZSBnYW1lIHdvcmxkLgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjc2V0Qm91bmRzVG9Xb3JsZAogICAgKi8KICAgIHNldEJvdW5kc1RvV29ybGQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5ib3VuZHMuc2V0VG8odGhpcy5nYW1lLndvcmxkLmJvdW5kcy54LCB0aGlzLmdhbWUud29ybGQuYm91bmRzLnksIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMud2lkdGgsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMuaGVpZ2h0KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNZXRob2QgY2FsbGVkIHRvIGVuc3VyZSB0aGUgY2FtZXJhIGRvZXNuJ3QgdmVudHVyZSBvdXRzaWRlIG9mIHRoZSBnYW1lIHdvcmxkLgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjY2hlY2tXb3JsZEJvdW5kcwogICAgKi8KICAgIGNoZWNrQm91bmRzOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuYXRMaW1pdC54ID0gZmFsc2U7CiAgICAgICAgdGhpcy5hdExpbWl0LnkgPSBmYWxzZTsKCiAgICAgICAgLy8gIE1ha2Ugc3VyZSB3ZSBkaWRuJ3QgZ28gb3V0c2lkZSB0aGUgY2FtZXJhcyBib3VuZHMKICAgICAgICBpZiAodGhpcy52aWV3LnggPCB0aGlzLmJvdW5kcy54KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hdExpbWl0LnggPSB0cnVlOwogICAgICAgICAgICB0aGlzLnZpZXcueCA9IHRoaXMuYm91bmRzLng7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy52aWV3LnJpZ2h0ID4gdGhpcy5ib3VuZHMucmlnaHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmF0TGltaXQueCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudmlldy54ID0gdGhpcy5ib3VuZHMucmlnaHQgLSB0aGlzLndpZHRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudmlldy55IDwgdGhpcy5ib3VuZHMudG9wKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hdExpbWl0LnkgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnZpZXcueSA9IHRoaXMuYm91bmRzLnRvcDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnZpZXcuYm90dG9tID4gdGhpcy5ib3VuZHMuYm90dG9tKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hdExpbWl0LnkgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnZpZXcueSA9IHRoaXMuYm91bmRzLmJvdHRvbSAtIHRoaXMuaGVpZ2h0OwogICAgICAgIH0KCiAgICAgICAgdGhpcy52aWV3LmZsb29yKCk7CgogICAgfSwKCiAgICAvKioKICAgICogQSBoZWxwZXIgZnVuY3Rpb24gdG8gc2V0IGJvdGggdGhlIFggYW5kIFkgcHJvcGVydGllcyBvZiB0aGUgY2FtZXJhIGF0IG9uY2UKICAgICogd2l0aG91dCBoYXZpbmcgdG8gdXNlIGdhbWUuY2FtZXJhLnggYW5kIGdhbWUuY2FtZXJhLnkuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjc2V0UG9zaXRpb24KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24uCiAgICAqLwogICAgc2V0UG9zaXRpb246IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMudmlldy54ID0geDsKICAgICAgICB0aGlzLnZpZXcueSA9IHk7CgogICAgICAgIGlmICh0aGlzLmJvdW5kcykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tCb3VuZHMoKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgc2l6ZSBvZiB0aGUgdmlldyByZWN0YW5nbGUgZ2l2ZW4gdGhlIHdpZHRoIGFuZCBoZWlnaHQgaW4gcGFyYW1ldGVycy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbWVyYSNzZXRTaXplCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSBkZXNpcmVkIHdpZHRoLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGRlc2lyZWQgaGVpZ2h0LgogICAgKi8KICAgIHNldFNpemU6IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHRoaXMudmlldy53aWR0aCA9IHdpZHRoOwogICAgICAgIHRoaXMudmlldy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgfQoKfTsKClBoYXNlci5DYW1lcmEucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkNhbWVyYTsKCi8qKgoqIFRoZSBDYW1lcmFzIHggY29vcmRpbmF0ZS4gVGhpcyB2YWx1ZSBpcyBhdXRvbWF0aWNhbGx5IGNsYW1wZWQgaWYgaXQgZmFsbHMgb3V0c2lkZSBvZiB0aGUgV29ybGQgYm91bmRzLgoqIEBuYW1lIFBoYXNlci5DYW1lcmEjeAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gR2V0cyBvciBzZXRzIHRoZSBjYW1lcmFzIHggcG9zaXRpb24uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2FtZXJhLnByb3RvdHlwZSwgIngiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmlldy54OwogICAgfSwKIAogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdGhpcy52aWV3LnggPSB2YWx1ZTsKCiAgICAgICAgaWYgKHRoaXMuYm91bmRzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jaGVja0JvdW5kcygpOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIENhbWVyYXMgeSBjb29yZGluYXRlLiBUaGlzIHZhbHVlIGlzIGF1dG9tYXRpY2FsbHkgY2xhbXBlZCBpZiBpdCBmYWxscyBvdXRzaWRlIG9mIHRoZSBXb3JsZCBib3VuZHMuCiogQG5hbWUgUGhhc2VyLkNhbWVyYSN5CiogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBHZXRzIG9yIHNldHMgdGhlIGNhbWVyYXMgeSBwb3NpdGlvbi4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DYW1lcmEucHJvdG90eXBlLCAieSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmlldy55OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICB0aGlzLnZpZXcueSA9IHZhbHVlOwoKICAgICAgICBpZiAodGhpcy5ib3VuZHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNoZWNrQm91bmRzKCk7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgQ2FtZXJhcyB3aWR0aC4gQnkgZGVmYXVsdCB0aGlzIGlzIHRoZSBzYW1lIGFzIHRoZSBHYW1lIHNpemUgYW5kIHNob3VsZCBub3QgYmUgYWRqdXN0ZWQgZm9yIG5vdy4KKiBAbmFtZSBQaGFzZXIuQ2FtZXJhI3dpZHRoCiogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gR2V0cyBvciBzZXRzIHRoZSBjYW1lcmFzIHdpZHRoLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNhbWVyYS5wcm90b3R5cGUsICJ3aWR0aCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy52aWV3LndpZHRoOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMudmlldy53aWR0aCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBUaGUgQ2FtZXJhcyBoZWlnaHQuIEJ5IGRlZmF1bHQgdGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgR2FtZSBzaXplIGFuZCBzaG91bGQgbm90IGJlIGFkanVzdGVkIGZvciBub3cuCiogQG5hbWUgUGhhc2VyLkNhbWVyYSNoZWlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gR2V0cyBvciBzZXRzIHRoZSBjYW1lcmFzIGhlaWdodC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DYW1lcmEucHJvdG90eXBlLCAiaGVpZ2h0IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnZpZXcuaGVpZ2h0OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMudmlldy5oZWlnaHQgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhpcyBpcyBhIGJhc2UgU3RhdGUgY2xhc3Mgd2hpY2ggY2FuIGJlIGV4dGVuZGVkIGlmIHlvdSBhcmUgY3JlYXRpbmcgeW91ciBvd24gZ2FtZS4KKiBJdCBwcm92aWRlcyBxdWljayBhY2Nlc3MgdG8gY29tbW9uIGZ1bmN0aW9ucyBzdWNoIGFzIHRoZSBjYW1lcmEsIGNhY2hlLCBpbnB1dCwgbWF0Y2gsIHNvdW5kIGFuZCBtb3JlLgoqCiogQGNsYXNzIFBoYXNlci5TdGF0ZQoqIEBjb25zdHJ1Y3RvcgoqLwoKUGhhc2VyLlN0YXRlID0gZnVuY3Rpb24gKCkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5fSBhZGQgLSBSZWZlcmVuY2UgdG8gdGhlIEdhbWVPYmplY3RGYWN0b3J5LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYWRkID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkNhbWVyYX0gY2FtZXJhIC0gQSBoYW5keSByZWZlcmVuY2UgdG8gd29ybGQuY2FtZXJhLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2FtZXJhID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkNhY2hlfSBjYWNoZSAtIFJlZmVyZW5jZSB0byB0aGUgYXNzZXRzIGNhY2hlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2FjaGUgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuSW5wdXR9IGlucHV0IC0gUmVmZXJlbmNlIHRvIHRoZSBpbnB1dCBtYW5hZ2VyCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pbnB1dCA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Mb2FkZXJ9IGxvYWQgLSBSZWZlcmVuY2UgdG8gdGhlIGFzc2V0cyBsb2FkZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5sb2FkID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLk1hdGh9IG1hdGggLSBSZWZlcmVuY2UgdG8gdGhlIG1hdGggaGVscGVyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWF0aCA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Tb3VuZE1hbmFnZXJ9IHNvdW5kIC0gUmVmZXJlbmNlIHRvIHRoZSBzb3VuZCBtYW5hZ2VyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc291bmQgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU3RhZ2V9IHN0YWdlIC0gUmVmZXJlbmNlIHRvIHRoZSBzdGFnZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnN0YWdlID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlRpbWVNYW5hZ2VyfSB0aW1lIC0gUmVmZXJlbmNlIHRvIGdhbWUgY2xvY2suCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50aW1lID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlR3ZWVuTWFuYWdlcn0gdHdlZW5zIC0gUmVmZXJlbmNlIHRvIHRoZSB0d2VlbiBtYW5hZ2VyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudHdlZW5zID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLldvcmxkfSB3b3JsZCAtIFJlZmVyZW5jZSB0byB0aGUgd29ybGQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy53b3JsZCA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5QYXJ0aWNsZXN9IHBhcnRpY2xlcyAtIFRoZSBQYXJ0aWNsZSBNYW5hZ2VyIGZvciB0aGUgZ2FtZS4gSXQgaXMgY2FsbGVkIGR1cmluZyB0aGUgZ2FtZSB1cGRhdGUgbG9vcCBhbmQgaW4gdHVybiB1cGRhdGVzIGFueSBFbWl0dGVycyBhdHRhY2hlZCB0byBpdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhcnRpY2xlcyA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5QaHlzaWNzLlBoeXNpY3NNYW5hZ2VyfSBwaHlzaWNzIC0gUmVmZXJlbmNlIHRvIHRoZSBwaHlzaWNzIG1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5waHlzaWNzID0gbnVsbDsKCn07CgpQaGFzZXIuU3RhdGUucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBhZGQgc29tZSBsb2FkIG9wZXJhdGlvbnMuCiAgICAqIElmIHlvdSBuZWVkIHRvIHVzZSB0aGUgbG9hZGVyLCB5b3UgbWF5IG5lZWQgdG8gdXNlIHRoZW0gaGVyZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlI3ByZWxvYWQKICAgICovCiAgICBwcmVsb2FkOiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKICAgIC8qKgogICAgKiBQdXQgdXBkYXRlIGxvZ2ljIGhlcmUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZSNsb2FkVXBkYXRlCiAgICAqLwogICAgbG9hZFVwZGF0ZTogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogUHV0IHJlbmRlciBvcGVyYXRpb25zIGhlcmUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZSNsb2FkUmVuZGVyCiAgICAqLwogICAgbG9hZFJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogVGhpcyBtZXRob2QgaXMgY2FsbGVkIGFmdGVyIHRoZSBnYW1lIGVuZ2luZSBzdWNjZXNzZnVsbHkgc3dpdGNoZXMgc3RhdGVzLgogICAgKiBGZWVsIGZyZWUgdG8gYWRkIGFueSBzZXR1cCBjb2RlIGhlcmUgKGRvIG5vdCBsb2FkIGFueXRoaW5nIGhlcmUsIG92ZXJyaWRlIHByZWxvYWQoKSBpbnN0ZWFkKS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlI2NyZWF0ZQogICAgKi8KICAgIGNyZWF0ZTogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogUHV0IHVwZGF0ZSBsb2dpYyBoZXJlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGUjdXBkYXRlCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKICAgIC8qKgogICAgKiBQdXQgcmVuZGVyIG9wZXJhdGlvbnMgaGVyZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlI3JlbmRlcgogICAgKi8KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogVGhpcyBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgd2hlbiBnYW1lIHBhdXNlZC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlI3BhdXNlZAogICAgKi8KICAgIHBhdXNlZDogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogVGhpcyBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgc3RhdGUgaXMgZGVzdHJveWVkLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZSNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgfQoKfTsKClBoYXNlci5TdGF0ZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuU3RhdGU7CgovKiBqc2hpbnQgbmV3Y2FwOiBmYWxzZSAqLwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIFN0YXRlIE1hbmFnZXIgaXMgcmVzcG9uc2libGUgZm9yIGxvYWRpbmcsIHNldHRpbmcgdXAgYW5kIHN3aXRjaGluZyBnYW1lIHN0YXRlcy4KKiAKKiBAY2xhc3MgUGhhc2VyLlN0YXRlTWFuYWdlcgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge1BoYXNlci5TdGF0ZXxPYmplY3R9IFtwZW5kaW5nU3RhdGU9bnVsbF0gLSBBIFN0YXRlIG9iamVjdCB0byBzZWVkIHRoZSBtYW5hZ2VyIHdpdGguCiovClBoYXNlci5TdGF0ZU1hbmFnZXIgPSBmdW5jdGlvbiAoZ2FtZSwgcGVuZGluZ1N0YXRlKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge09iamVjdH0gc3RhdGVzIC0gVGhlIG9iamVjdCBjb250YWluaW5nIFBoYXNlci5TdGF0ZXMuCiAgICAqLwogICAgdGhpcy5zdGF0ZXMgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU3RhdGV9IF9wZW5kaW5nU3RhdGUgLSBUaGUgc3RhdGUgdG8gYmUgc3dpdGNoZWQgdG8gaW4gdGhlIG5leHQgZnJhbWUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fcGVuZGluZ1N0YXRlID0gbnVsbDsKCiAgICBpZiAodHlwZW9mIHBlbmRpbmdTdGF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgcGVuZGluZ1N0YXRlICE9PSBudWxsKQogICAgewogICAgICAgIHRoaXMuX3BlbmRpbmdTdGF0ZSA9IHBlbmRpbmdTdGF0ZTsKICAgIH0KCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfY3JlYXRlZCAtIEZsYWcgdGhhdCBzZXRzIGlmIHRoZSBTdGF0ZSBoYXMgYmVlbiBjcmVhdGVkIG9yIG5vdC4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9jcmVhdGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjdXJyZW50IC0gVGhlIGN1cnJlbnQgYWN0aXZlIFN0YXRlIG9iamVjdCAoZGVmYXVsdHMgdG8gbnVsbCkuCiAgICAqLwogICAgdGhpcy5jdXJyZW50ID0gJyc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uSW5pdENhbGxiYWNrIC0gVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBzdGF0ZSBpcyBzdGFydGVkIChpLmUuIHNldCBhcyB0aGUgY3VycmVudCBhY3RpdmUgc3RhdGUpLgogICAgKi8KICAgIHRoaXMub25Jbml0Q2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvblByZWxvYWRDYWxsYmFjayAtIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiBpbml0IHN0YXRlcyAobG9hZGluZyBhc3NldHMuLi4pLgogICAgKi8KICAgIHRoaXMub25QcmVsb2FkQ2FsbGJhY2sgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25DcmVhdGVDYWxsYmFjayAtIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiBjcmVhdGUgc3RhdGVzIChzZXR1cCBzdGF0ZXMuLi4pLgogICAgKi8KICAgIHRoaXMub25DcmVhdGVDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uVXBkYXRlQ2FsbGJhY2sgLSBUaGlzIHdpbGwgYmUgY2FsbGVkIHdoZW4gU3RhdGUgaXMgdXBkYXRlZCwgdGhpcyBkb2Vzbid0IGhhcHBlbiBkdXJpbmcgbG9hZCAoQHNlZSBvbkxvYWRVcGRhdGVDYWxsYmFjaykuCiAgICAqLwogICAgdGhpcy5vblVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25SZW5kZXJDYWxsYmFjayAtIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgU3RhdGUgaXMgcmVuZGVyZWQsIHRoaXMgZG9lc24ndCBoYXBwZW4gZHVyaW5nIGxvYWQgKHNlZSBvbkxvYWRSZW5kZXJDYWxsYmFjaykuCiAgICAqLwogICAgdGhpcy5vblJlbmRlckNhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25QcmVSZW5kZXJDYWxsYmFjayAtIFRoaXMgd2lsbCBiZSBjYWxsZWQgYmVmb3JlIHRoZSBTdGF0ZSBpcyByZW5kZXJlZCBhbmQgYmVmb3JlIHRoZSBzdGFnZSBpcyBjbGVhcmVkLgogICAgKi8KICAgIHRoaXMub25QcmVSZW5kZXJDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uTG9hZFVwZGF0ZUNhbGxiYWNrIC0gVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBTdGF0ZSBpcyB1cGRhdGVkIGJ1dCBvbmx5IGR1cmluZyB0aGUgbG9hZCBwcm9jZXNzLgogICAgKi8KICAgIHRoaXMub25Mb2FkVXBkYXRlQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvbkxvYWRSZW5kZXJDYWxsYmFjayAtIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgU3RhdGUgaXMgcmVuZGVyZWQgYnV0IG9ubHkgZHVyaW5nIHRoZSBsb2FkIHByb2Nlc3MuCiAgICAqLwogICAgdGhpcy5vbkxvYWRSZW5kZXJDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uUGF1c2VkQ2FsbGJhY2sgLSBUaGlzIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIHN0YXRlIGlzIHBhdXNlZC4KICAgICovCiAgICB0aGlzLm9uUGF1c2VkQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvblNodXREb3duQ2FsbGJhY2sgLSBUaGlzIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIHN0YXRlIGlzIHNodXQgZG93biAoaS5lLiBzd2FwcGVkIHRvIGFub3RoZXIgc3RhdGUpLgogICAgKi8KICAgIHRoaXMub25TaHV0RG93bkNhbGxiYWNrID0gbnVsbDsKCgp9OwoKUGhhc2VyLlN0YXRlTWFuYWdlci5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFRoZSBCb290IGhhbmRsZXIgaXMgY2FsbGVkIGJ5IFBoYXNlci5HYW1lIHdoZW4gaXQgZmlyc3Qgc3RhcnRzIHVwLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjYm9vdAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIGJvb3Q6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5nYW1lLm9uUGF1c2UuYWRkKHRoaXMucGF1c2UsIHRoaXMpOwogICAgICAgIHRoaXMuZ2FtZS5vblJlc3VtZS5hZGQodGhpcy5yZXN1bWUsIHRoaXMpOwoKICAgICAgICBpZiAodGhpcy5fcGVuZGluZ1N0YXRlICE9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9wZW5kaW5nU3RhdGUgPT09ICdzdHJpbmcnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgU3RhdGUgd2FzIGFscmVhZHkgYWRkZWQsIHNvIGp1c3Qgc3RhcnQgaXQKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnQodGhpcy5fcGVuZGluZ1N0YXRlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5hZGQoJ2RlZmF1bHQnLCB0aGlzLl9wZW5kaW5nU3RhdGUsIHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgU3RhdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNhZGQKICAgICogQHBhcmFtIGtleSB7c3RyaW5nfSAtIEEgdW5pcXVlIGtleSB5b3UgdXNlIHRvIHJlZmVyZW5jZSB0aGlzIHN0YXRlLCBpLmUuICJNYWluTWVudSIsICJMZXZlbDEiLgogICAgKiBAcGFyYW0gc3RhdGUge1N0YXRlfSAtIFRoZSBzdGF0ZSB5b3Ugd2FudCB0byBzd2l0Y2ggdG8uCiAgICAqIEBwYXJhbSBhdXRvU3RhcnQge2Jvb2xlYW59IC0gU3RhcnQgdGhlIHN0YXRlIGltbWVkaWF0ZWx5IGFmdGVyIGNyZWF0aW5nIGl0PyAoZGVmYXVsdCB0cnVlKQogICAgKi8KICAgIGFkZDogZnVuY3Rpb24gKGtleSwgc3RhdGUsIGF1dG9TdGFydCkgewoKICAgICAgICBpZiAodHlwZW9mIGF1dG9TdGFydCA9PT0gInVuZGVmaW5lZCIpIHsgYXV0b1N0YXJ0ID0gZmFsc2U7IH0KCiAgICAgICAgdmFyIG5ld1N0YXRlOwoKICAgICAgICBpZiAoc3RhdGUgaW5zdGFuY2VvZiBQaGFzZXIuU3RhdGUpCiAgICAgICAgewogICAgICAgICAgICBuZXdTdGF0ZSA9IHN0YXRlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlb2Ygc3RhdGUgPT09ICdvYmplY3QnKQogICAgICAgIHsKICAgICAgICAgICAgbmV3U3RhdGUgPSBzdGF0ZTsKICAgICAgICAgICAgbmV3U3RhdGUuZ2FtZSA9IHRoaXMuZ2FtZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZW9mIHN0YXRlID09PSAnZnVuY3Rpb24nKQogICAgICAgIHsKICAgICAgICAgICAgbmV3U3RhdGUgPSBuZXcgc3RhdGUodGhpcy5nYW1lKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RhdGVzW2tleV0gPSBuZXdTdGF0ZTsKCiAgICAgICAgaWYgKGF1dG9TdGFydCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuaXNCb290ZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnQoa2V5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BlbmRpbmdTdGF0ZSA9IGtleTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5ld1N0YXRlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERlbGV0ZSB0aGUgZ2l2ZW4gc3RhdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNyZW1vdmUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEEgdW5pcXVlIGtleSB5b3UgdXNlIHRvIHJlZmVyZW5jZSB0aGlzIHN0YXRlLCBpLmUuICJNYWluTWVudSIsICJMZXZlbDEiLgogICAgKi8KICAgIHJlbW92ZTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5jdXJyZW50ID09IGtleSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gbnVsbDsKCiAgICAgICAgICAgIHRoaXMub25Jbml0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICB0aGlzLm9uU2h1dERvd25DYWxsYmFjayA9IG51bGw7CgogICAgICAgICAgICB0aGlzLm9uUHJlbG9hZENhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5vbkxvYWRSZW5kZXJDYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgIHRoaXMub25Mb2FkVXBkYXRlQ2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICB0aGlzLm9uQ3JlYXRlQ2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICB0aGlzLm9uVXBkYXRlQ2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICB0aGlzLm9uUmVuZGVyQ2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICB0aGlzLm9uUGF1c2VkQ2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICB0aGlzLm9uRGVzdHJveUNhbGxiYWNrID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGRlbGV0ZSB0aGlzLnN0YXRlc1trZXldOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0YXJ0IHRoZSBnaXZlbiBzdGF0ZQogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjc3RhcnQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBrZXkgb2YgdGhlIHN0YXRlIHlvdSB3YW50IHRvIHN0YXJ0LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjbGVhcldvcmxkXSAtIGNsZWFyIGV2ZXJ5dGhpbmcgaW4gdGhlIHdvcmxkPyAoRGVmYXVsdCB0byB0cnVlKQogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjbGVhckNhY2hlXSAtIGNsZWFyIGFzc2V0IGNhY2hlPyAoRGVmYXVsdCB0byBmYWxzZSBhbmQgT05MWSBhdmFpbGFibGUgd2hlbiBjbGVhcldvcmxkPXRydWUpCiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uIChrZXksIGNsZWFyV29ybGQsIGNsZWFyQ2FjaGUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBjbGVhcldvcmxkID09PSAidW5kZWZpbmVkIikgeyBjbGVhcldvcmxkID0gdHJ1ZTsgfQogICAgICAgIGlmICh0eXBlb2YgY2xlYXJDYWNoZSA9PT0gInVuZGVmaW5lZCIpIHsgY2xlYXJDYWNoZSA9IGZhbHNlOyB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuaXNCb290ZWQgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcGVuZGluZ1N0YXRlID0ga2V5OwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jaGVja1N0YXRlKGtleSkgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgQWxyZWFkeSBnb3QgYSBzdGF0ZSBydW5uaW5nPwogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm9uU2h1dERvd25DYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCB0aGlzLmdhbWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY2xlYXJXb3JsZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnR3ZWVucy5yZW1vdmVBbGwoKTsKCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUud29ybGQuZGVzdHJveSgpOwoKICAgICAgICAgICAgICAgIGlmIChjbGVhckNhY2hlID09PSB0cnVlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc2V0Q3VycmVudFN0YXRlKGtleSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5vblByZWxvYWRDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5sb2FkLnJlc2V0KCk7CiAgICAgICAgICAgIHRoaXMub25QcmVsb2FkQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5nYW1lKTsKCiAgICAgICAgICAgIC8vICBJcyB0aGUgbG9hZGVyIGVtcHR5PwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmxvYWQudG90YWxRdWV1ZWRGaWxlcygpID09PSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUubG9hZENvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgU3RhcnQgdGhlIGxvYWRlciBnb2luZyBhcyB3ZSBoYXZlIHNvbWV0aGluZyBpbiB0aGUgcXVldWUKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5sb2FkLnN0YXJ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIE5vIGluaXQ/IFRoZW4gdGhlcmUgd2FzIG5vdGhpbmcgdG8gbG9hZCBlaXRoZXIKICAgICAgICAgICAgdGhpcy5nYW1lLmxvYWRDb21wbGV0ZSgpOwogICAgICAgIH0KCiAgICB9LAogICAgCiAgICAvKioKICAgICogVXNlZCBieSBvbkluaXQgYW5kIG9uU2h1dGRvd24gd2hlbiB0aG9zZSBmdW5jdGlvbnMgZG9uJ3QgZXhpc3Qgb24gdGhlIHN0YXRlCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNkdW1teQogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIGR1bW15OiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgaSBhIGdpdmVuIHBoYXNlciBzdGF0ZSBpcyB2YWxpZC4KICAgICogU3RhdGUgbXVzdCBleGlzdCBhbmQgaGF2ZSBhdCBsZWFzdCBvbmUgY2FsbGJhY2sgZnVuY3Rpb24gcmVnaXN0ZXJlZC4uCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNjaGVja1N0YXRlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUga2V5IG9mIHRoZSBzdGF0ZSB5b3Ugd2FudCB0byBjaGVjay4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgY2hlY2tTdGF0ZTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5zdGF0ZXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciB2YWxpZCA9IGZhbHNlOwoKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGVzW2tleV1bJ3ByZWxvYWQnXSkgeyB2YWxpZCA9IHRydWU7IH0KCiAgICAgICAgICAgIGlmICh2YWxpZCA9PT0gZmFsc2UgJiYgdGhpcy5zdGF0ZXNba2V5XVsnbG9hZFJlbmRlciddKSB7IHZhbGlkID0gdHJ1ZTsgfQogICAgICAgICAgICBpZiAodmFsaWQgPT09IGZhbHNlICYmIHRoaXMuc3RhdGVzW2tleV1bJ2xvYWRVcGRhdGUnXSkgeyB2YWxpZCA9IHRydWU7IH0KICAgICAgICAgICAgaWYgKHZhbGlkID09PSBmYWxzZSAmJiB0aGlzLnN0YXRlc1trZXldWydjcmVhdGUnXSkgeyB2YWxpZCA9IHRydWU7IH0KICAgICAgICAgICAgaWYgKHZhbGlkID09PSBmYWxzZSAmJiB0aGlzLnN0YXRlc1trZXldWyd1cGRhdGUnXSkgeyB2YWxpZCA9IHRydWU7IH0KICAgICAgICAgICAgaWYgKHZhbGlkID09PSBmYWxzZSAmJiB0aGlzLnN0YXRlc1trZXldWydwcmVSZW5kZXInXSkgeyB2YWxpZCA9IHRydWU7IH0KICAgICAgICAgICAgaWYgKHZhbGlkID09PSBmYWxzZSAmJiB0aGlzLnN0YXRlc1trZXldWydyZW5kZXInXSkgeyB2YWxpZCA9IHRydWU7IH0KICAgICAgICAgICAgaWYgKHZhbGlkID09PSBmYWxzZSAmJiB0aGlzLnN0YXRlc1trZXldWydwYXVzZWQnXSkgeyB2YWxpZCA9IHRydWU7IH0KCiAgICAgICAgICAgIGlmICh2YWxpZCA9PT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiSW52YWxpZCBQaGFzZXIgU3RhdGUgb2JqZWN0IGdpdmVuLiBNdXN0IGNvbnRhaW4gYXQgbGVhc3QgYSBvbmUgb2YgdGhlIHJlcXVpcmVkIGZ1bmN0aW9ucy4iKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiUGhhc2VyLlN0YXRlTWFuYWdlciAtIE5vIHN0YXRlIGZvdW5kIHdpdGggdGhlIGtleTogIiArIGtleSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogTGlua3MgZ2FtZSBwcm9wZXJ0aWVzIHRvIHRoZSBTdGF0ZSBnaXZlbiBieSB0aGUga2V5LgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjbGluawogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gU3RhdGUga2V5LgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgbGluazogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICB0aGlzLnN0YXRlc1trZXldLmdhbWUgPSB0aGlzLmdhbWU7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5hZGQgPSB0aGlzLmdhbWUuYWRkOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0uY2FtZXJhID0gdGhpcy5nYW1lLmNhbWVyYTsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLmNhY2hlID0gdGhpcy5nYW1lLmNhY2hlOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0uaW5wdXQgPSB0aGlzLmdhbWUuaW5wdXQ7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5sb2FkID0gdGhpcy5nYW1lLmxvYWQ7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5tYXRoID0gdGhpcy5nYW1lLm1hdGg7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5zb3VuZCA9IHRoaXMuZ2FtZS5zb3VuZDsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLnN0YWdlID0gdGhpcy5nYW1lLnN0YWdlOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0udGltZSA9IHRoaXMuZ2FtZS50aW1lOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0udHdlZW5zID0gdGhpcy5nYW1lLnR3ZWVuczsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLndvcmxkID0gdGhpcy5nYW1lLndvcmxkOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0ucGFydGljbGVzID0gdGhpcy5nYW1lLnBhcnRpY2xlczsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLnBoeXNpY3MgPSB0aGlzLmdhbWUucGh5c2ljczsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLnJuZCA9IHRoaXMuZ2FtZS5ybmQ7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgY3VycmVudCBTdGF0ZS4gU2hvdWxkIG5vdCBiZSBjYWxsZWQgZGlyZWN0bHkgKHVzZSBTdGF0ZU1hbmFnZXIuc3RhcnQpCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNzZXRDdXJyZW50U3RhdGUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFN0YXRlIGtleS4KICAgICogQHByaXZhdGUKICAgICovCiAgICBzZXRDdXJyZW50U3RhdGU6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgdGhpcy5jYWxsYmFja0NvbnRleHQgPSB0aGlzLnN0YXRlc1trZXldOwoKICAgICAgICB0aGlzLmxpbmsoa2V5KTsKCiAgICAgICAgLy8gIFVzZWQgd2hlbiB0aGUgc3RhdGUgaXMgc2V0IGFzIGJlaW5nIHRoZSBjdXJyZW50IGFjdGl2ZSBzdGF0ZQogICAgICAgIHRoaXMub25Jbml0Q2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWydpbml0J10gfHwgdGhpcy5kdW1teTsKCiAgICAgICAgdGhpcy5vblByZWxvYWRDYWxsYmFjayA9IHRoaXMuc3RhdGVzW2tleV1bJ3ByZWxvYWQnXSB8fCBudWxsOwogICAgICAgIHRoaXMub25Mb2FkUmVuZGVyQ2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWydsb2FkUmVuZGVyJ10gfHwgbnVsbDsKICAgICAgICB0aGlzLm9uTG9hZFVwZGF0ZUNhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsnbG9hZFVwZGF0ZSddIHx8IG51bGw7CiAgICAgICAgdGhpcy5vbkNyZWF0ZUNhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsnY3JlYXRlJ10gfHwgbnVsbDsKICAgICAgICB0aGlzLm9uVXBkYXRlQ2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWyd1cGRhdGUnXSB8fCBudWxsOwogICAgICAgIHRoaXMub25QcmVSZW5kZXJDYWxsYmFjayA9IHRoaXMuc3RhdGVzW2tleV1bJ3ByZVJlbmRlciddIHx8IG51bGw7CiAgICAgICAgdGhpcy5vblJlbmRlckNhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsncmVuZGVyJ10gfHwgbnVsbDsKICAgICAgICB0aGlzLm9uUGF1c2VkQ2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWydwYXVzZWQnXSB8fCBudWxsOwoKICAgICAgICAvLyAgVXNlZCB3aGVuIHRoZSBzdGF0ZSBpcyBubyBsb25nZXIgdGhlIGN1cnJlbnQgYWN0aXZlIHN0YXRlCiAgICAgICAgdGhpcy5vblNodXREb3duQ2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWydzaHV0ZG93biddIHx8IHRoaXMuZHVtbXk7CgogICAgICAgIHRoaXMuY3VycmVudCA9IGtleTsKICAgICAgICB0aGlzLl9jcmVhdGVkID0gZmFsc2U7CgogICAgICAgIHRoaXMub25Jbml0Q2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5nYW1lKTsKCiAgICB9LAoKICAgIC8qKgogICAgICogR2V0cyB0aGUgY3VycmVudCBTdGF0ZS4KICAgICAqCiAgICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjZ2V0Q3VycmVudFN0YXRlCiAgICAgKiBAcmV0dXJuIFBoYXNlci5TdGF0ZQogICAgICogQHB1YmxpYwogICAgICovCiAgICBnZXRDdXJyZW50U3RhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0YXRlc1t0aGlzLmN1cnJlbnRdOwogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI2xvYWRDb21wbGV0ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgbG9hZENvbXBsZXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9jcmVhdGVkID09PSBmYWxzZSAmJiB0aGlzLm9uQ3JlYXRlQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9jcmVhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5vbkNyZWF0ZUNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjcGF1c2UKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHBhdXNlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9jcmVhdGVkICYmIHRoaXMub25QYXVzZWRDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25QYXVzZWRDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCB0aGlzLmdhbWUsIHRydWUpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjcmVzdW1lCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICByZXN1bWU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX2NyZWF0ZWQgJiYgdGhpcy5vbnJlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vblBhdXNlZENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSwgZmFsc2UpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjdXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX2NyZWF0ZWQgJiYgdGhpcy5vblVwZGF0ZUNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vblVwZGF0ZUNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLm9uTG9hZFVwZGF0ZUNhbGxiYWNrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm9uTG9hZFVwZGF0ZUNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI3ByZVJlbmRlcgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcHJlUmVuZGVyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLm9uUHJlUmVuZGVyQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uUHJlUmVuZGVyQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5nYW1lKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI3JlbmRlcgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9jcmVhdGVkICYmIHRoaXMub25SZW5kZXJDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyVHlwZSA9PT0gUGhhc2VyLkNBTlZBUykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNvbnRleHQuc2F2ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNvbnRleHQuc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIDAsIDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm9uUmVuZGVyQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5nYW1lKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyVHlwZSA9PT0gUGhhc2VyLkNBTlZBUykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNvbnRleHQucmVzdG9yZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLm9uTG9hZFJlbmRlckNhbGxiYWNrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm9uTG9hZFJlbmRlckNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogTnVrZSB0aGUgZW50aXJlIGdhbWUgZnJvbSBvcmJpdAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5jYWxsYmFja0NvbnRleHQgPSBudWxsOwoKICAgICAgICB0aGlzLm9uSW5pdENhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLm9uU2h1dERvd25DYWxsYmFjayA9IG51bGw7CgogICAgICAgIHRoaXMub25QcmVsb2FkQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMub25Mb2FkUmVuZGVyQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMub25Mb2FkVXBkYXRlQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMub25DcmVhdGVDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5vblVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLm9uUmVuZGVyQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMub25QYXVzZWRDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5vbkRlc3Ryb3lDYWxsYmFjayA9IG51bGw7CgogICAgICAgIHRoaXMuZ2FtZSA9IG51bGw7CiAgICAgICAgdGhpcy5zdGF0ZXMgPSB7fTsKICAgICAgICB0aGlzLl9wZW5kaW5nU3RhdGUgPSBudWxsOwoKICAgIH0KCn07CgpQaGFzZXIuU3RhdGVNYW5hZ2VyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5TdGF0ZU1hbmFnZXI7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIGJhc2ljIGxpbmtlZCBsaXN0IGRhdGEgc3RydWN0dXJlLgoqCiogQGNsYXNzIFBoYXNlci5MaW5rZWRMaXN0CiogQGNvbnN0cnVjdG9yCiovClBoYXNlci5MaW5rZWRMaXN0ID0gZnVuY3Rpb24gKCkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gbmV4dCAtIE5leHQgZWxlbWVudCBpbiB0aGUgbGlzdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm5leHQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gcHJldiAtIFByZXZpb3VzIGVsZW1lbnQgaW4gdGhlIGxpc3QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wcmV2ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IGZpcnN0IC0gRmlyc3QgZWxlbWVudCBpbiB0aGUgbGlzdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZpcnN0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IGxhc3QgLSBMYXN0IGVsZW1lbnQgaW4gdGhlIGxpc3QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5sYXN0ID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBnYW1lIC0gTnVtYmVyIG9mIGVsZW1lbnRzIGluIHRoZSBsaXN0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudG90YWwgPSAwOwoKfTsKClBoYXNlci5MaW5rZWRMaXN0LnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkcyBhIG5ldyBlbGVtZW50IHRvIHRoaXMgbGlua2VkIGxpc3QuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5MaW5rZWRMaXN0I2FkZAogICAgKiBAcGFyYW0ge29iamVjdH0gY2hpbGQgLSBUaGUgZWxlbWVudCB0byBhZGQgdG8gdGhpcyBsaXN0LiBDYW4gYmUgYSBQaGFzZXIuU3ByaXRlIG9yIGFueSBvdGhlciBvYmplY3QgeW91IG5lZWQgdG8gcXVpY2tseSBpdGVyYXRlIHRocm91Z2guCiAgICAqIEByZXR1cm4ge29iamVjdH0gVGhlIGNoaWxkIHRoYXQgd2FzIGFkZGVkLgogICAgKi8KICAgIGFkZDogZnVuY3Rpb24gKGNoaWxkKSB7CgogICAgICAgIC8vICBJZiB0aGUgbGlzdCBpcyBlbXB0eQogICAgICAgIGlmICh0aGlzLnRvdGFsID09PSAwICYmIHRoaXMuZmlyc3QgPT0gbnVsbCAmJiB0aGlzLmxhc3QgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZmlyc3QgPSBjaGlsZDsKICAgICAgICAgICAgdGhpcy5sYXN0ID0gY2hpbGQ7CiAgICAgICAgICAgIHRoaXMubmV4dCA9IGNoaWxkOwogICAgICAgICAgICBjaGlsZC5wcmV2ID0gdGhpczsKICAgICAgICAgICAgdGhpcy50b3RhbCsrOwogICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgfQoKICAgICAgICAvLyAgR2V0IGdldHMgYXBwZW5kZWQgdG8gdGhlIGVuZCBvZiB0aGUgbGlzdCwgcmVnYXJkbGVzcyBvZiBhbnl0aGluZywgYW5kIGl0IHdvbid0IGhhdmUgYW55IGNoaWxkcmVuIG9mIGl0cyBvd24gKG5vbi1uZXN0ZWQgbGlzdCkKICAgICAgICB0aGlzLmxhc3QubmV4dCA9IGNoaWxkOwoKICAgICAgICBjaGlsZC5wcmV2ID0gdGhpcy5sYXN0OwoKICAgICAgICB0aGlzLmxhc3QgPSBjaGlsZDsKCiAgICAgICAgdGhpcy50b3RhbCsrOwoKICAgICAgICByZXR1cm4gY2hpbGQ7CgogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlcyB0aGUgZ2l2ZW4gZWxlbWVudCBmcm9tIHRoaXMgbGlua2VkIGxpc3QgaWYgaXQgZXhpc3RzLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTGlua2VkTGlzdCNyZW1vdmUKICAgICogQHBhcmFtIHtvYmplY3R9IGNoaWxkIC0gVGhlIGNoaWxkIHRvIGJlIHJlbW92ZWQgZnJvbSB0aGUgbGlzdC4KICAgICovCiAgICByZW1vdmU6IGZ1bmN0aW9uIChjaGlsZCkgewoKICAgICAgICBpZiAoY2hpbGQgPT0gdGhpcy5maXJzdCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIEl0IHdhcyAnZmlyc3QnLCBtYWtlICdmaXJzdCcgcG9pbnQgdG8gZmlyc3QubmV4dAogICAgICAgICAgICB0aGlzLmZpcnN0ID0gdGhpcy5maXJzdC5uZXh0OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChjaGlsZCA9PSB0aGlzLmxhc3QpCiAgICAgICAgewogICAgICAgICAgICAvLyBJdCB3YXMgJ2xhc3QnLCBtYWtlICdsYXN0JyBwb2ludCB0byBsYXN0LnByZXYKICAgICAgICAgICAgdGhpcy5sYXN0ID0gdGhpcy5sYXN0LnByZXY7CiAgICAgICAgfQoKICAgICAgICBpZiAoY2hpbGQucHJldikKICAgICAgICB7CiAgICAgICAgICAgIC8vIG1ha2UgY2hpbGQucHJldi5uZXh0IHBvaW50IHRvIGNoaWxkcy5uZXh0IGluc3RlYWQgb2YgY2hpbGQKICAgICAgICAgICAgY2hpbGQucHJldi5uZXh0ID0gY2hpbGQubmV4dDsKICAgICAgICB9CgogICAgICAgIGlmIChjaGlsZC5uZXh0KQogICAgICAgIHsKICAgICAgICAgICAgLy8gbWFrZSBjaGlsZC5uZXh0LnByZXYgcG9pbnQgdG8gY2hpbGQucHJldiBpbnN0ZWFkIG9mIGNoaWxkCiAgICAgICAgICAgIGNoaWxkLm5leHQucHJldiA9IGNoaWxkLnByZXY7CiAgICAgICAgfQoKICAgICAgICBjaGlsZC5uZXh0ID0gY2hpbGQucHJldiA9IG51bGw7CgogICAgICAgIGlmICh0aGlzLmZpcnN0ID09IG51bGwgKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5sYXN0ID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHRoaXMudG90YWwtLTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxscyBhIGZ1bmN0aW9uIG9uIGFsbCBtZW1iZXJzIG9mIHRoaXMgbGlzdCwgdXNpbmcgdGhlIG1lbWJlciBhcyB0aGUgY29udGV4dCBmb3IgdGhlIGNhbGxiYWNrLgogICAgKiBUaGUgZnVuY3Rpb24gbXVzdCBleGlzdCBvbiB0aGUgbWVtYmVyLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTGlua2VkTGlzdCNjYWxsQWxsCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGZ1bmN0aW9uIHRvIGNhbGwuCiAgICAqLwogICAgY2FsbEFsbDogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CgogICAgICAgIGlmICghdGhpcy5maXJzdCB8fCAhdGhpcy5sYXN0KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGVudGl0eSA9IHRoaXMuZmlyc3Q7CiAgICAgICAgCiAgICAgICAgZG8KICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbnRpdHkgJiYgZW50aXR5W2NhbGxiYWNrXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZW50aXR5W2NhbGxiYWNrXS5jYWxsKGVudGl0eSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGVudGl0eSA9IGVudGl0eS5uZXh0OwoKICAgICAgICB9CiAgICAgICAgd2hpbGUoZW50aXR5ICE9IHRoaXMubGFzdC5uZXh0KQoKICAgIH0KCn07CgpQaGFzZXIuTGlua2VkTGlzdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuTGlua2VkTGlzdDsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEBjbGFzcyBQaGFzZXIuU2lnbmFsCiogQGNsYXNzZGVzYyBBIFNpZ25hbCBpcyB1c2VkIGZvciBvYmplY3QgY29tbXVuaWNhdGlvbiB2aWEgYSBjdXN0b20gYnJvYWRjYXN0ZXIgaW5zdGVhZCBvZiBFdmVudHMuCiogQGF1dGhvciBNaWxsZXIgTWVkZWlyb3MgaHR0cDovL21pbGxlcm1lZGVpcm9zLmdpdGh1Yi5jb20vanMtc2lnbmFscy8KKiBAY29uc3RydWN0b3IKKi8KUGhhc2VyLlNpZ25hbCA9IGZ1bmN0aW9uICgpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBcnJheS48UGhhc2VyLlNpZ25hbEJpbmRpbmc+fSBfYmluZGluZ3MgLSBJbnRlcm5hbCB2YXJpYWJsZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9iaW5kaW5ncyA9IFtdOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHthbnl9IF9wcmV2UGFyYW1zIC0gSW50ZXJuYWwgdmFyaWFibGUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fcHJldlBhcmFtcyA9IG51bGw7CgogICAgLy8gZW5mb3JjZSBkaXNwYXRjaCB0byBhd2F5cyB3b3JrIG9uIHNhbWUgY29udGV4dCAoIzQ3KQogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBkaXNwYXRjaCAtIFRoZSBkaXNwYXRjaCBmdW5jdGlvbiBpcyB3aGF0IHNlbmRzIHRoZSBTaWduYWwgb3V0LgogICAgKi8KICAgIHRoaXMuZGlzcGF0Y2ggPSBmdW5jdGlvbigpewogICAgICAgIFBoYXNlci5TaWduYWwucHJvdG90eXBlLmRpc3BhdGNoLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICB9OwoKfTsKClBoYXNlci5TaWduYWwucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBJZiBTaWduYWwgc2hvdWxkIGtlZXAgcmVjb3JkIG9mIHByZXZpb3VzbHkgZGlzcGF0Y2hlZCBwYXJhbWV0ZXJzIGFuZAogICAgKiBhdXRvbWF0aWNhbGx5IGV4ZWN1dGUgbGlzdGVuZXIgZHVyaW5nIGBhZGQoKWAvYGFkZE9uY2UoKWAgaWYgU2lnbmFsIHdhcwogICAgKiBhbHJlYWR5IGRpc3BhdGNoZWQgYmVmb3JlLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG1lbW9yaXplCiAgICAqLwogICAgbWVtb3JpemU6IGZhbHNlLAoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9zaG91bGRQcm9wYWdhdGUgCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX3Nob3VsZFByb3BhZ2F0ZTogdHJ1ZSwKCiAgICAvKioKICAgICogSWYgU2lnbmFsIGlzIGFjdGl2ZSBhbmQgc2hvdWxkIGJyb2FkY2FzdCBldmVudHMuCiAgICAqIDxwPjxzdHJvbmc+SU1QT1JUQU5UOjwvc3Ryb25nPiBTZXR0aW5nIHRoaXMgcHJvcGVydHkgZHVyaW5nIGEgZGlzcGF0Y2ggd2lsbCBvbmx5IGFmZmVjdCB0aGUgbmV4dCBkaXNwYXRjaCwgaWYgeW91IHdhbnQgdG8gc3RvcCB0aGUgcHJvcGFnYXRpb24gb2YgYSBzaWduYWwgdXNlIGBoYWx0KClgIGluc3RlYWQuPC9wPgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFjdGl2ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIGFjdGl2ZTogdHJ1ZSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI3ZhbGlkYXRlTGlzdGVuZXIKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgLSBTaWduYWwgaGFuZGxlciBmdW5jdGlvbi4KICAgICogQHBhcmFtIHtzdHJpbmd9IGZuTmFtZSAtIEZ1bmN0aW9uIG5hbWUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdmFsaWRhdGVMaXN0ZW5lcjogZnVuY3Rpb24gKGxpc3RlbmVyLCBmbk5hbWUpIHsKICAgICAgICBpZiAodHlwZW9mIGxpc3RlbmVyICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvciggJ2xpc3RlbmVyIGlzIGEgcmVxdWlyZWQgcGFyYW0gb2Yge2ZufSgpIGFuZCBzaG91bGQgYmUgYSBGdW5jdGlvbi4nLnJlcGxhY2UoJ3tmbn0nLCBmbk5hbWUpICk7CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI19yZWdpc3Rlckxpc3RlbmVyCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGxpc3RlbmVyIC0gU2lnbmFsIGhhbmRsZXIgZnVuY3Rpb24uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNPbmNlIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBbbGlzdGVuZXJDb250ZXh0XSAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ByaW9yaXR5XSAtIFRoZSBwcmlvcml0eSBsZXZlbCBvZiB0aGUgZXZlbnQgbGlzdGVuZXIuIExpc3RlbmVycyB3aXRoIGhpZ2hlciBwcmlvcml0eSB3aWxsIGJlIGV4ZWN1dGVkIGJlZm9yZSBsaXN0ZW5lcnMgd2l0aCBsb3dlciBwcmlvcml0eS4gTGlzdGVuZXJzIHdpdGggc2FtZSBwcmlvcml0eSBsZXZlbCB3aWxsIGJlIGV4ZWN1dGVkIGF0IHRoZSBzYW1lIG9yZGVyIGFzIHRoZXkgd2VyZSBhZGRlZC4gKGRlZmF1bHQgPSAwKS4KICAgICogQHJldHVybiB7UGhhc2VyLlNpZ25hbEJpbmRpbmd9IEFuIE9iamVjdCByZXByZXNlbnRpbmcgdGhlIGJpbmRpbmcgYmV0d2VlbiB0aGUgU2lnbmFsIGFuZCBsaXN0ZW5lci4KICAgICogQHByaXZhdGUKICAgICovCiAgICBfcmVnaXN0ZXJMaXN0ZW5lcjogZnVuY3Rpb24gKGxpc3RlbmVyLCBpc09uY2UsIGxpc3RlbmVyQ29udGV4dCwgcHJpb3JpdHkpIHsKCiAgICAgICAgdmFyIHByZXZJbmRleCA9IHRoaXMuX2luZGV4T2ZMaXN0ZW5lcihsaXN0ZW5lciwgbGlzdGVuZXJDb250ZXh0KSwKICAgICAgICAgICAgYmluZGluZzsKCiAgICAgICAgaWYgKHByZXZJbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgYmluZGluZyA9IHRoaXMuX2JpbmRpbmdzW3ByZXZJbmRleF07CiAgICAgICAgICAgIGlmIChiaW5kaW5nLmlzT25jZSgpICE9PSBpc09uY2UpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignWW91IGNhbm5vdCBhZGQnKyAoaXNPbmNlPyAnJyA6ICdPbmNlJykgKycoKSB0aGVuIGFkZCcrICghaXNPbmNlPyAnJyA6ICdPbmNlJykgKycoKSB0aGUgc2FtZSBsaXN0ZW5lciB3aXRob3V0IHJlbW92aW5nIHRoZSByZWxhdGlvbnNoaXAgZmlyc3QuJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBiaW5kaW5nID0gbmV3IFBoYXNlci5TaWduYWxCaW5kaW5nKHRoaXMsIGxpc3RlbmVyLCBpc09uY2UsIGxpc3RlbmVyQ29udGV4dCwgcHJpb3JpdHkpOwogICAgICAgICAgICB0aGlzLl9hZGRCaW5kaW5nKGJpbmRpbmcpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMubWVtb3JpemUgJiYgdGhpcy5fcHJldlBhcmFtcyl7CiAgICAgICAgICAgIGJpbmRpbmcuZXhlY3V0ZSh0aGlzLl9wcmV2UGFyYW1zKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBiaW5kaW5nOwogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI19hZGRCaW5kaW5nIAogICAgKiBAcGFyYW0ge1BoYXNlci5TaWduYWxCaW5kaW5nfSBiaW5kaW5nIC0gQW4gT2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYmluZGluZyBiZXR3ZWVuIHRoZSBTaWduYWwgYW5kIGxpc3RlbmVyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIF9hZGRCaW5kaW5nOiBmdW5jdGlvbiAoYmluZGluZykgewogICAgICAgIC8vc2ltcGxpZmllZCBpbnNlcnRpb24gc29ydAogICAgICAgIHZhciBuID0gdGhpcy5fYmluZGluZ3MubGVuZ3RoOwogICAgICAgIGRvIHsgLS1uOyB9IHdoaWxlICh0aGlzLl9iaW5kaW5nc1tuXSAmJiBiaW5kaW5nLl9wcmlvcml0eSA8PSB0aGlzLl9iaW5kaW5nc1tuXS5fcHJpb3JpdHkpOwogICAgICAgIHRoaXMuX2JpbmRpbmdzLnNwbGljZShuICsgMSwgMCwgYmluZGluZyk7CiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjX2luZGV4T2ZMaXN0ZW5lcgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBsaXN0ZW5lciAtIFNpZ25hbCBoYW5kbGVyIGZ1bmN0aW9uLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIF9pbmRleE9mTGlzdGVuZXI6IGZ1bmN0aW9uIChsaXN0ZW5lciwgY29udGV4dCkgewogICAgICAgIHZhciBuID0gdGhpcy5fYmluZGluZ3MubGVuZ3RoLAogICAgICAgICAgICBjdXI7CiAgICAgICAgd2hpbGUgKG4tLSkgewogICAgICAgICAgICBjdXIgPSB0aGlzLl9iaW5kaW5nc1tuXTsKICAgICAgICAgICAgaWYgKGN1ci5fbGlzdGVuZXIgPT09IGxpc3RlbmVyICYmIGN1ci5jb250ZXh0ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayBpZiBsaXN0ZW5lciB3YXMgYXR0YWNoZWQgdG8gU2lnbmFsLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI2hhcwogICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciAtIFNpZ25hbCBoYW5kbGVyIGZ1bmN0aW9uLgogICAgKiBAcGFyYW0ge09iamVjdH0gW2NvbnRleHRdIC0gQ29udGV4dCBvbiB3aGljaCBsaXN0ZW5lciB3aWxsIGJlIGV4ZWN1dGVkIChvYmplY3QgdGhhdCBzaG91bGQgcmVwcmVzZW50IHRoZSBgdGhpc2AgdmFyaWFibGUgaW5zaWRlIGxpc3RlbmVyIGZ1bmN0aW9uKS4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gSWYgU2lnbmFsIGhhcyB0aGUgc3BlY2lmaWVkIGxpc3RlbmVyLgogICAgKi8KICAgIGhhczogZnVuY3Rpb24gKGxpc3RlbmVyLCBjb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2luZGV4T2ZMaXN0ZW5lcihsaXN0ZW5lciwgY29udGV4dCkgIT09IC0xOwogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbGlzdGVuZXIgdG8gdGhlIHNpZ25hbC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNhZGQKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgLSBTaWduYWwgaGFuZGxlciBmdW5jdGlvbi4KICAgICogQHBhcmFtIHtvYmplY3R9IFtsaXN0ZW5lckNvbnRleHRdIENvbnRleHQgb24gd2hpY2ggbGlzdGVuZXIgd2lsbCBiZSBleGVjdXRlZCAob2JqZWN0IHRoYXQgc2hvdWxkIHJlcHJlc2VudCB0aGUgYHRoaXNgIHZhcmlhYmxlIGluc2lkZSBsaXN0ZW5lciBmdW5jdGlvbikuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcHJpb3JpdHldIFRoZSBwcmlvcml0eSBsZXZlbCBvZiB0aGUgZXZlbnQgbGlzdGVuZXIuIExpc3RlbmVycyB3aXRoIGhpZ2hlciBwcmlvcml0eSB3aWxsIGJlIGV4ZWN1dGVkIGJlZm9yZSBsaXN0ZW5lcnMgd2l0aCBsb3dlciBwcmlvcml0eS4gTGlzdGVuZXJzIHdpdGggc2FtZSBwcmlvcml0eSBsZXZlbCB3aWxsIGJlIGV4ZWN1dGVkIGF0IHRoZSBzYW1lIG9yZGVyIGFzIHRoZXkgd2VyZSBhZGRlZC4gKGRlZmF1bHQgPSAwKS4KICAgICogQHJldHVybiB7UGhhc2VyLlNpZ25hbEJpbmRpbmd9IEFuIE9iamVjdCByZXByZXNlbnRpbmcgdGhlIGJpbmRpbmcgYmV0d2VlbiB0aGUgU2lnbmFsIGFuZCBsaXN0ZW5lci4KICAgICovCiAgICBhZGQ6IGZ1bmN0aW9uIChsaXN0ZW5lciwgbGlzdGVuZXJDb250ZXh0LCBwcmlvcml0eSkgewogICAgICAgIHRoaXMudmFsaWRhdGVMaXN0ZW5lcihsaXN0ZW5lciwgJ2FkZCcpOwogICAgICAgIHJldHVybiB0aGlzLl9yZWdpc3Rlckxpc3RlbmVyKGxpc3RlbmVyLCBmYWxzZSwgbGlzdGVuZXJDb250ZXh0LCBwcmlvcml0eSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgbGlzdGVuZXIgdG8gdGhlIHNpZ25hbCB0aGF0IHNob3VsZCBiZSByZW1vdmVkIGFmdGVyIGZpcnN0IGV4ZWN1dGlvbiAod2lsbCBiZSBleGVjdXRlZCBvbmx5IG9uY2UpLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjYWRkT25jZQogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBsaXN0ZW5lciBTaWduYWwgaGFuZGxlciBmdW5jdGlvbi4KICAgICogQHBhcmFtIHtvYmplY3R9IFtsaXN0ZW5lckNvbnRleHRdIENvbnRleHQgb24gd2hpY2ggbGlzdGVuZXIgd2lsbCBiZSBleGVjdXRlZCAob2JqZWN0IHRoYXQgc2hvdWxkIHJlcHJlc2VudCB0aGUgYHRoaXNgIHZhcmlhYmxlIGluc2lkZSBsaXN0ZW5lciBmdW5jdGlvbikuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcHJpb3JpdHldIFRoZSBwcmlvcml0eSBsZXZlbCBvZiB0aGUgZXZlbnQgbGlzdGVuZXIuIExpc3RlbmVycyB3aXRoIGhpZ2hlciBwcmlvcml0eSB3aWxsIGJlIGV4ZWN1dGVkIGJlZm9yZSBsaXN0ZW5lcnMgd2l0aCBsb3dlciBwcmlvcml0eS4gTGlzdGVuZXJzIHdpdGggc2FtZSBwcmlvcml0eSBsZXZlbCB3aWxsIGJlIGV4ZWN1dGVkIGF0IHRoZSBzYW1lIG9yZGVyIGFzIHRoZXkgd2VyZSBhZGRlZC4gKGRlZmF1bHQgPSAwKQogICAgKiBAcmV0dXJuIHtQaGFzZXIuU2lnbmFsQmluZGluZ30gQW4gT2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYmluZGluZyBiZXR3ZWVuIHRoZSBTaWduYWwgYW5kIGxpc3RlbmVyLgogICAgKi8KICAgIGFkZE9uY2U6IGZ1bmN0aW9uIChsaXN0ZW5lciwgbGlzdGVuZXJDb250ZXh0LCBwcmlvcml0eSkgewogICAgICAgIHRoaXMudmFsaWRhdGVMaXN0ZW5lcihsaXN0ZW5lciwgJ2FkZE9uY2UnKTsKICAgICAgICByZXR1cm4gdGhpcy5fcmVnaXN0ZXJMaXN0ZW5lcihsaXN0ZW5lciwgdHJ1ZSwgbGlzdGVuZXJDb250ZXh0LCBwcmlvcml0eSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmUgYSBzaW5nbGUgbGlzdGVuZXIgZnJvbSB0aGUgZGlzcGF0Y2ggcXVldWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNyZW1vdmUKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgSGFuZGxlciBmdW5jdGlvbiB0aGF0IHNob3VsZCBiZSByZW1vdmVkLgogICAgKiBAcGFyYW0ge29iamVjdH0gW2NvbnRleHRdIEV4ZWN1dGlvbiBjb250ZXh0IChzaW5jZSB5b3UgY2FuIGFkZCB0aGUgc2FtZSBoYW5kbGVyIG11bHRpcGxlIHRpbWVzIGlmIGV4ZWN1dGluZyBpbiBhIGRpZmZlcmVudCBjb250ZXh0KS4KICAgICogQHJldHVybiB7ZnVuY3Rpb259IExpc3RlbmVyIGhhbmRsZXIgZnVuY3Rpb24uCiAgICAqLwogICAgcmVtb3ZlOiBmdW5jdGlvbiAobGlzdGVuZXIsIGNvbnRleHQpIHsKCiAgICAgICAgdGhpcy52YWxpZGF0ZUxpc3RlbmVyKGxpc3RlbmVyLCAncmVtb3ZlJyk7CgogICAgICAgIHZhciBpID0gdGhpcy5faW5kZXhPZkxpc3RlbmVyKGxpc3RlbmVyLCBjb250ZXh0KTsKCiAgICAgICAgaWYgKGkgIT09IC0xKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fYmluZGluZ3NbaV0uX2Rlc3Ryb3koKTsgLy9ubyByZWFzb24gdG8gYSBQaGFzZXIuU2lnbmFsQmluZGluZyBleGlzdCBpZiBpdCBpc24ndCBhdHRhY2hlZCB0byBhIHNpZ25hbAogICAgICAgICAgICB0aGlzLl9iaW5kaW5ncy5zcGxpY2UoaSwgMSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbGlzdGVuZXI7CgogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlIGFsbCBsaXN0ZW5lcnMgZnJvbSB0aGUgU2lnbmFsLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjcmVtb3ZlQWxsCiAgICAqLwogICAgcmVtb3ZlQWxsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG4gPSB0aGlzLl9iaW5kaW5ncy5sZW5ndGg7CiAgICAgICAgd2hpbGUgKG4tLSkgewogICAgICAgICAgICB0aGlzLl9iaW5kaW5nc1tuXS5fZGVzdHJveSgpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9iaW5kaW5ncy5sZW5ndGggPSAwOwogICAgfSwKCiAgICAvKioKICAgICogR2V0cyB0aGUgdG90YWwgbnVtYmVyIG9mIGxpc3RlbmVyZXMgYXR0YWNoZWQgdG8gdGhzIFNpZ25hbC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI2dldE51bUxpc3RlbmVycwogICAgKiBAcmV0dXJuIHtudW1iZXJ9IE51bWJlciBvZiBsaXN0ZW5lcnMgYXR0YWNoZWQgdG8gdGhlIFNpZ25hbC4KICAgICovCiAgICBnZXROdW1MaXN0ZW5lcnM6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYmluZGluZ3MubGVuZ3RoOwogICAgfSwKCiAgICAvKioKICAgICogU3RvcCBwcm9wYWdhdGlvbiBvZiB0aGUgZXZlbnQsIGJsb2NraW5nIHRoZSBkaXNwYXRjaCB0byBuZXh0IGxpc3RlbmVycyBvbiB0aGUgcXVldWUuCiAgICAqIElNUE9SVEFOVDogc2hvdWxkIGJlIGNhbGxlZCBvbmx5IGR1cmluZyBzaWduYWwgZGlzcGF0Y2gsIGNhbGxpbmcgaXQgYmVmb3JlL2FmdGVyIGRpc3BhdGNoIHdvbid0IGFmZmVjdCBzaWduYWwgYnJvYWRjYXN0LgogICAgKiBAc2VlIFNpZ25hbC5wcm90b3R5cGUuZGlzYWJsZQogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjaGFsdAogICAgKi8KICAgIGhhbHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLl9zaG91bGRQcm9wYWdhdGUgPSBmYWxzZTsKICAgIH0sCgogICAgLyoqCiAgICAqIERpc3BhdGNoL0Jyb2FkY2FzdCBTaWduYWwgdG8gYWxsIGxpc3RlbmVycyBhZGRlZCB0byB0aGUgcXVldWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNkaXNwYXRjaAogICAgKiBAcGFyYW0ge2FueX0gW3BhcmFtc10gLSBQYXJhbWV0ZXJzIHRoYXQgc2hvdWxkIGJlIHBhc3NlZCB0byBlYWNoIGhhbmRsZXIuCiAgICAqLwogICAgZGlzcGF0Y2g6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKCF0aGlzLmFjdGl2ZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBwYXJhbXNBcnIgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIHZhciBuID0gdGhpcy5fYmluZGluZ3MubGVuZ3RoOwogICAgICAgIHZhciBiaW5kaW5nczsKCiAgICAgICAgaWYgKHRoaXMubWVtb3JpemUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wcmV2UGFyYW1zID0gcGFyYW1zQXJyOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFuKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFNob3VsZCBjb21lIGFmdGVyIG1lbW9yaXplCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGJpbmRpbmdzID0gdGhpcy5fYmluZGluZ3Muc2xpY2UoKTsgLy9jbG9uZSBhcnJheSBpbiBjYXNlIGFkZC9yZW1vdmUgaXRlbXMgZHVyaW5nIGRpc3BhdGNoCiAgICAgICAgdGhpcy5fc2hvdWxkUHJvcGFnYXRlID0gdHJ1ZTsgLy9pbiBjYXNlIGBoYWx0YCB3YXMgY2FsbGVkIGJlZm9yZSBkaXNwYXRjaCBvciBkdXJpbmcgdGhlIHByZXZpb3VzIGRpc3BhdGNoLgoKICAgICAgICAvL2V4ZWN1dGUgYWxsIGNhbGxiYWNrcyB1bnRpbCBlbmQgb2YgdGhlIGxpc3Qgb3IgdW50aWwgYSBjYWxsYmFjayByZXR1cm5zIGBmYWxzZWAgb3Igc3RvcHMgcHJvcGFnYXRpb24KICAgICAgICAvL3JldmVyc2UgbG9vcCBzaW5jZSBsaXN0ZW5lcnMgd2l0aCBoaWdoZXIgcHJpb3JpdHkgd2lsbCBiZSBhZGRlZCBhdCB0aGUgZW5kIG9mIHRoZSBsaXN0CiAgICAgICAgZG8geyBuLS07IH0gd2hpbGUgKGJpbmRpbmdzW25dICYmIHRoaXMuX3Nob3VsZFByb3BhZ2F0ZSAmJiBiaW5kaW5nc1tuXS5leGVjdXRlKHBhcmFtc0FycikgIT09IGZhbHNlKTsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIEZvcmdldCBtZW1vcml6ZWQgYXJndW1lbnRzLgogICAgKiBAc2VlIFNpZ25hbC5tZW1vcml6ZQogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjZm9yZ2V0CiAgICAqLwogICAgZm9yZ2V0OiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuX3ByZXZQYXJhbXMgPSBudWxsOwogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlIGFsbCBiaW5kaW5ncyBmcm9tIHNpZ25hbCBhbmQgZGVzdHJveSBhbnkgcmVmZXJlbmNlIHRvIGV4dGVybmFsIG9iamVjdHMgKGRlc3Ryb3kgU2lnbmFsIG9iamVjdCkuCiAgICAqIElNUE9SVEFOVDogY2FsbGluZyBhbnkgbWV0aG9kIG9uIHRoZSBzaWduYWwgaW5zdGFuY2UgYWZ0ZXIgY2FsbGluZyBkaXNwb3NlIHdpbGwgdGhyb3cgZXJyb3JzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjZGlzcG9zZQogICAgKi8KICAgIGRpc3Bvc2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLnJlbW92ZUFsbCgpOwogICAgICAgIGRlbGV0ZSB0aGlzLl9iaW5kaW5nczsKICAgICAgICBkZWxldGUgdGhpcy5fcHJldlBhcmFtczsKICAgIH0sCgogICAgLyoqCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCN0b1N0cmluZwogICAgKiBAcmV0dXJuIHtzdHJpbmd9IFN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgb2JqZWN0LgogICAgKi8KICAgIHRvU3RyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICdbUGhhc2VyLlNpZ25hbCBhY3RpdmU6JysgdGhpcy5hY3RpdmUgKycgbnVtTGlzdGVuZXJzOicrIHRoaXMuZ2V0TnVtTGlzdGVuZXJzKCkgKyddJzsKICAgIH0KCn07CgpQaGFzZXIuU2lnbmFsLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5TaWduYWw7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIuU2lnbmFsQmluZGluZwoqCiogT2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGJpbmRpbmcgYmV0d2VlbiBhIFNpZ25hbCBhbmQgYSBsaXN0ZW5lciBmdW5jdGlvbi4KKiBUaGlzIGlzIGFuIGludGVybmFsIGNvbnN0cnVjdG9yIGFuZCBzaG91bGRuJ3QgYmUgY2FsbGVkIGJ5IHJlZ3VsYXIgdXNlcnMuCiogSW5zcGlyZWQgYnkgSm9hIEViZXJ0IEFTMyBTaWduYWxCaW5kaW5nIGFuZCBSb2JlcnQgUGVubmVyJ3MgU2xvdCBjbGFzc2VzLgoqCiogQGNsYXNzIFBoYXNlci5TaWduYWxCaW5kaW5nCiogQG5hbWUgU2lnbmFsQmluZGluZwoqIEBhdXRob3IgTWlsbGVyIE1lZGVpcm9zIGh0dHA6Ly9taWxsZXJtZWRlaXJvcy5naXRodWIuY29tL2pzLXNpZ25hbHMvCiogQGNvbnN0cnVjdG9yCiogQGlubmVyCiogQHBhcmFtIHtQaGFzZXIuU2lnbmFsfSBzaWduYWwgLSBSZWZlcmVuY2UgdG8gU2lnbmFsIG9iamVjdCB0aGF0IGxpc3RlbmVyIGlzIGN1cnJlbnRseSBib3VuZCB0by4KKiBAcGFyYW0ge2Z1bmN0aW9ufSBsaXN0ZW5lciAtIEhhbmRsZXIgZnVuY3Rpb24gYm91bmQgdG8gdGhlIHNpZ25hbC4KKiBAcGFyYW0ge2Jvb2xlYW59IGlzT25jZSAtIElmIGJpbmRpbmcgc2hvdWxkIGJlIGV4ZWN1dGVkIGp1c3Qgb25jZS4KKiBAcGFyYW0ge29iamVjdH0gW2xpc3RlbmVyQ29udGV4dF0gLSBDb250ZXh0IG9uIHdoaWNoIGxpc3RlbmVyIHdpbGwgYmUgZXhlY3V0ZWQgKG9iamVjdCB0aGF0IHNob3VsZCByZXByZXNlbnQgdGhlIGB0aGlzYCB2YXJpYWJsZSBpbnNpZGUgbGlzdGVuZXIgZnVuY3Rpb24pLgoqIEBwYXJhbSB7bnVtYmVyfSBbcHJpb3JpdHldIC0gVGhlIHByaW9yaXR5IGxldmVsIG9mIHRoZSBldmVudCBsaXN0ZW5lci4gKGRlZmF1bHQgPSAwKS4KKi8KUGhhc2VyLlNpZ25hbEJpbmRpbmcgPSBmdW5jdGlvbiAoc2lnbmFsLCBsaXN0ZW5lciwgaXNPbmNlLCBsaXN0ZW5lckNvbnRleHQsIHByaW9yaXR5KSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IF9saXN0ZW5lciAtIEhhbmRsZXIgZnVuY3Rpb24gYm91bmQgdG8gdGhlIHNpZ25hbC4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9saXN0ZW5lciA9IGxpc3RlbmVyOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9pc09uY2UgLSBJZiBiaW5kaW5nIHNob3VsZCBiZSBleGVjdXRlZCBqdXN0IG9uY2UuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5faXNPbmNlID0gaXNPbmNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdHx1bmRlZmluZWR8bnVsbH0gY29udGV4dCAtIENvbnRleHQgb24gd2hpY2ggbGlzdGVuZXIgd2lsbCBiZSBleGVjdXRlZCAob2JqZWN0IHRoYXQgc2hvdWxkIHJlcHJlc2VudCB0aGUgYHRoaXNgIHZhcmlhYmxlIGluc2lkZSBsaXN0ZW5lciBmdW5jdGlvbikuCiAgICAqIEBtZW1iZXJvZiBTaWduYWxCaW5kaW5nLnByb3RvdHlwZQogICAgKi8KICAgIHRoaXMuY29udGV4dCA9IGxpc3RlbmVyQ29udGV4dDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBfc2lnbmFsIC0gUmVmZXJlbmNlIHRvIFNpZ25hbCBvYmplY3QgdGhhdCBsaXN0ZW5lciBpcyBjdXJyZW50bHkgYm91bmQgdG8uCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fc2lnbmFsID0gc2lnbmFsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3ByaW9yaXR5IC0gTGlzdGVuZXIgcHJpb3JpdHkuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fcHJpb3JpdHkgPSBwcmlvcml0eSB8fCAwOwoKfTsKClBoYXNlci5TaWduYWxCaW5kaW5nLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogSWYgYmluZGluZyBpcyBhY3RpdmUgYW5kIHNob3VsZCBiZSBleGVjdXRlZC4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBhY3RpdmUKICAgICogQGRlZmF1bHQKICAgICovCiAgICBhY3RpdmU6IHRydWUsCgogICAgLyoqCiAgICAqIERlZmF1bHQgcGFyYW1ldGVycyBwYXNzZWQgdG8gbGlzdGVuZXIgZHVyaW5nIGBTaWduYWwuZGlzcGF0Y2hgIGFuZCBgU2lnbmFsQmluZGluZy5leGVjdXRlYCAoY3VycmllZCBwYXJhbWV0ZXJzKS4KICAgICogQHByb3BlcnR5IHthcnJheXxudWxsfSBwYXJhbXMgCiAgICAqIEBkZWZhdWx0IAogICAgKi8KICAgIHBhcmFtczogbnVsbCwKCiAgICAvKioKICAgICogQ2FsbCBsaXN0ZW5lciBwYXNzaW5nIGFyYml0cmFyeSBwYXJhbWV0ZXJzLgogICAgKiBJZiBiaW5kaW5nIHdhcyBhZGRlZCB1c2luZyBgU2lnbmFsLmFkZE9uY2UoKWAgaXQgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IHJlbW92ZWQgZnJvbSBzaWduYWwgZGlzcGF0Y2ggcXVldWUsIHRoaXMgbWV0aG9kIGlzIHVzZWQgaW50ZXJuYWxseSBmb3IgdGhlIHNpZ25hbCBkaXNwYXRjaC4KICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsQmluZGluZyNleGVjdXRlCiAgICAqIEBwYXJhbSB7YXJyYXl9IFtwYXJhbXNBcnJdIC0gQXJyYXkgb2YgcGFyYW1ldGVycyB0aGF0IHNob3VsZCBiZSBwYXNzZWQgdG8gdGhlIGxpc3RlbmVyLgogICAgKiBAcmV0dXJuIHthbnl9IFZhbHVlIHJldHVybmVkIGJ5IHRoZSBsaXN0ZW5lci4KICAgICovCiAgICBleGVjdXRlOiBmdW5jdGlvbiAocGFyYW1zQXJyKSB7CgogICAgICAgIHZhciBoYW5kbGVyUmV0dXJuLCBwYXJhbXM7CgogICAgICAgIGlmICh0aGlzLmFjdGl2ZSAmJiAhIXRoaXMuX2xpc3RlbmVyKQogICAgICAgIHsKICAgICAgICAgICAgcGFyYW1zID0gdGhpcy5wYXJhbXM/IHRoaXMucGFyYW1zLmNvbmNhdChwYXJhbXNBcnIpIDogcGFyYW1zQXJyOwogICAgICAgICAgICBoYW5kbGVyUmV0dXJuID0gdGhpcy5fbGlzdGVuZXIuYXBwbHkodGhpcy5jb250ZXh0LCBwYXJhbXMpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX2lzT25jZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5kZXRhY2goKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGhhbmRsZXJSZXR1cm47CgogICAgfSwKCiAgICAvKioKICAgICogRGV0YWNoIGJpbmRpbmcgZnJvbSBzaWduYWwuCiAgICAqIGFsaWFzIHRvOiBAc2VlIG15U2lnbmFsLnJlbW92ZShteUJpbmRpbmcuZ2V0TGlzdGVuZXIoKSk7CiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbEJpbmRpbmcjZGV0YWNoCiAgICAqIEByZXR1cm4ge2Z1bmN0aW9ufG51bGx9IEhhbmRsZXIgZnVuY3Rpb24gYm91bmQgdG8gdGhlIHNpZ25hbCBvciBgbnVsbGAgaWYgYmluZGluZyB3YXMgcHJldmlvdXNseSBkZXRhY2hlZC4KICAgICovCiAgICBkZXRhY2g6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5pc0JvdW5kKCkgPyB0aGlzLl9zaWduYWwucmVtb3ZlKHRoaXMuX2xpc3RlbmVyLCB0aGlzLmNvbnRleHQpIDogbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbEJpbmRpbmcjaXNCb3VuZAogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGJpbmRpbmcgaXMgc3RpbGwgYm91bmQgdG8gdGhlIHNpZ25hbCBhbmQgaGFzIGEgbGlzdGVuZXIuCiAgICAqLwogICAgaXNCb3VuZDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAoISF0aGlzLl9zaWduYWwgJiYgISF0aGlzLl9saXN0ZW5lcik7CiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI2lzT25jZQogICAgKiBAcmV0dXJuIHtib29sZWFufSBJZiBTaWduYWxCaW5kaW5nIHdpbGwgb25seSBiZSBleGVjdXRlZCBvbmNlLgogICAgKi8KICAgIGlzT25jZTogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9pc09uY2U7CiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI2dldExpc3RlbmVyCiAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSBIYW5kbGVyIGZ1bmN0aW9uIGJvdW5kIHRvIHRoZSBzaWduYWwuCiAgICAqLwogICAgZ2V0TGlzdGVuZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbGlzdGVuZXI7CiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI2dldFNpZ25hbAogICAgKiBAcmV0dXJuIHtTaWduYWx9IFNpZ25hbCB0aGF0IGxpc3RlbmVyIGlzIGN1cnJlbnRseSBib3VuZCB0by4KICAgICovCiAgICBnZXRTaWduYWw6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc2lnbmFsOwogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsQmluZGluZyNfZGVzdHJveQogICAgKiBEZWxldGUgaW5zdGFuY2UgcHJvcGVydGllcwogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIF9kZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX3NpZ25hbDsKICAgICAgICBkZWxldGUgdGhpcy5fbGlzdGVuZXI7CiAgICAgICAgZGVsZXRlIHRoaXMuY29udGV4dDsKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbEJpbmRpbmcjdG9TdHJpbmcKICAgICogQHJldHVybiB7c3RyaW5nfSBTdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIG9iamVjdC4KICAgICovCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAnW1BoYXNlci5TaWduYWxCaW5kaW5nIGlzT25jZTonICsgdGhpcy5faXNPbmNlICsnLCBpc0JvdW5kOicrIHRoaXMuaXNCb3VuZCgpICsnLCBhY3RpdmU6JyArIHRoaXMuYWN0aXZlICsgJ10nOwogICAgfQoKfTsKClBoYXNlci5TaWduYWxCaW5kaW5nLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5TaWduYWxCaW5kaW5nOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqIAoqIFRoaXMgaXMgYSBiYXNlIEZpbHRlciB0ZW1wbGF0ZSB0byB1c2UgZm9yIGFueSBQaGFzZXIgZmlsdGVyIGRldmVsb3BtZW50LgoqIAoqIEBjbGFzcyBQaGFzZXIuRmlsdGVyCiogQGNsYXNzZGVzYyBQaGFzZXIgLSBGaWx0ZXIKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtPYmplY3R9IHVuaWZvcm1zIC0gVW5pZm9ybSBtYXBwaW5ncyBvYmplY3QKKiBAcGFyYW0ge0FycmF5fSBmcmFnbWVudFNyYyAtIFRoZSBmcmFnbWVudCBzaGFkZXIgY29kZS4KKi8KUGhhc2VyLkZpbHRlciA9IGZ1bmN0aW9uIChnYW1lLCB1bmlmb3JtcywgZnJhZ21lbnRTcmMpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0eXBlIC0gVGhlIGNvbnN0IHR5cGUgb2YgdGhpcyBvYmplY3QsIGVpdGhlciBQaGFzZXIuV0VCR0xfRklMVEVSIG9yIFBoYXNlci5DQU5WQVNfRklMVEVSLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudHlwZSA9ICBQaGFzZXIuV0VCR0xfRklMVEVSOwogICAgCiAgICAvKioKICAgICogQW4gYXJyYXkgb2YgcGFzc2VzIC0gc29tZSBmaWx0ZXJzIGNvbnRhaW4gYSBmZXcgc3RlcHMgdGhpcyBhcnJheSBzaW1wbHkgc3RvcmVzIHRoZSBzdGVwcyBpbiBhIGxpbmVhciBmYXNoaW9uLgogICAgKiBGb3IgZXhhbXBsZSB0aGUgYmx1ciBmaWx0ZXIgaGFzIHR3byBwYXNzZXMgYmx1clggYW5kIGJsdXJZLgogICAgKiBAcHJvcGVydHkge2FycmF5fSBwYXNzZXMgLSBBbiBhcnJheSBvZiBmaWx0ZXIgb2JqZWN0cy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLnBhc3NlcyA9IFt0aGlzXTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZGlydHkgLSBJbnRlcm5hbCBQSVhJIHZhci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBhZGRpbmcgLSBJbnRlcm5hbCBQSVhJIHZhci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhZGRpbmcgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gdW5pZm9ybXMgLSBEZWZhdWx0IHVuaWZvcm0gbWFwcGluZ3MuCiAgICAqLwogICAgdGhpcy51bmlmb3JtcyA9IHsKCiAgICAgICAgdGltZTogeyB0eXBlOiAnMWYnLCB2YWx1ZTogMCB9LAogICAgICAgIHJlc29sdXRpb246IHsgdHlwZTogJzJmJywgdmFsdWU6IHsgeDogMjU2LCB5OiAyNTYgfX0sCiAgICAgICAgbW91c2U6IHsgdHlwZTogJzJmJywgdmFsdWU6IHsgeDogMC4wLCB5OiAwLjAgfX0KCiAgICB9OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gZnJhZ21lbnRTcmMgLSBUaGUgZnJhZ21lbnQgc2hhZGVyIGNvZGUuCiAgICAqLwogICAgdGhpcy5mcmFnbWVudFNyYyA9IGZyYWdtZW50U3JjIHx8IFtdOwoKfTsKClBoYXNlci5GaWx0ZXIucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBTaG91bGQgYmUgb3Zlci1yaWRkZW4uCiAgICAqIEBtZXRob2QgUGhhc2VyLkZpbHRlciNpbml0CiAgICAqLwogICAgaW5pdDogZnVuY3Rpb24gKCkgewogICAgICAgIC8vICBUaGlzIHNob3VsZCBiZSBvdmVyLXJpZGRlbi4gV2lsbCByZWNlaXZlIGEgdmFyaWFibGUgbnVtYmVyIG9mIGFyZ3VtZW50cy4KICAgIH0sCgogICAgLyoqCiAgICAqIFNldCB0aGUgcmVzb2x1dGlvbiB1bmlmb3JtcyBvbiB0aGUgZmlsdGVyLgogICAgKiBAbWV0aG9kIFBoYXNlci5GaWx0ZXIjc2V0UmVzb2x1dGlvbgogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIGRpc3BsYXkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBkaXNwbGF5LgogICAgKi8KICAgIHNldFJlc29sdXRpb246IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHRoaXMudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZS54ID0gd2lkdGg7CiAgICAgICAgdGhpcy51bmlmb3Jtcy5yZXNvbHV0aW9uLnZhbHVlLnkgPSBoZWlnaHQ7CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlcyB0aGUgZmlsdGVyLgogICAgKiBAbWV0aG9kIFBoYXNlci5GaWx0ZXIjdXBkYXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IFtwb2ludGVyXSAtIEEgUG9pbnRlciBvYmplY3QgdG8gdXNlIGZvciB0aGUgZmlsdGVyLiBUaGUgY29vcmRpbmF0ZXMgYXJlIG1hcHBlZCB0byB0aGUgbW91c2UgdW5pZm9ybS4KICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIGlmICh0eXBlb2YgcG9pbnRlciAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICBpZiAocG9pbnRlci54ID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy5tb3VzZS54ID0gcG9pbnRlci54LnRvRml4ZWQoMik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChwb2ludGVyLnkgPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnVuaWZvcm1zLm1vdXNlLnkgPSBwb2ludGVyLnkudG9GaXhlZCgyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy51bmlmb3Jtcy50aW1lLnZhbHVlID0gdGhpcy5nYW1lLnRpbWUudG90YWxFbGFwc2VkU2Vjb25kcygpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENsZWFyIGRvd24gdGhpcyBGaWx0ZXIgYW5kIG51bGwgb3V0IHJlZmVyZW5jZXMKICAgICogQG1ldGhvZCBQaGFzZXIuRmlsdGVyI2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuZ2FtZSA9IG51bGw7CiAgICAgICAgCiAgICB9Cgp9OwoKUGhhc2VyLkZpbHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuRmlsdGVyOwoKLyoqCiogQG5hbWUgUGhhc2VyLkZpbHRlciN3aWR0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCAocmVzb2x1dGlvbiB1bmlmb3JtKQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkZpbHRlci5wcm90b3R5cGUsICd3aWR0aCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLnJlc29sdXRpb24udmFsdWUueDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZS54ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5GaWx0ZXIjaGVpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgKHJlc29sdXRpb24gdW5pZm9ybSkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5GaWx0ZXIucHJvdG90eXBlLCAnaGVpZ2h0JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZS55OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy51bmlmb3Jtcy5yZXNvbHV0aW9uLnZhbHVlLnkgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqIAoqIFRoaXMgaXMgYSBiYXNlIFBsdWdpbiB0ZW1wbGF0ZSB0byB1c2UgZm9yIGFueSBQaGFzZXIgcGx1Z2luIGRldmVsb3BtZW50LgoqIAoqIEBjbGFzcyBQaGFzZXIuUGx1Z2luCiogQGNsYXNzZGVzYyBQaGFzZXIgLSBQbHVnaW4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtBbnl9IHBhcmVudCAtIFRoZSBvYmplY3QgdGhhdCBvd25zIHRoaXMgcGx1Z2luLCB1c3VhbGx5IFBoYXNlci5QbHVnaW5NYW5hZ2VyLgoqLwpQaGFzZXIuUGx1Z2luID0gZnVuY3Rpb24gKGdhbWUsIHBhcmVudCkgewoKICAgIGlmICh0eXBlb2YgcGFyZW50ID09PSAndW5kZWZpbmVkJykgeyBwYXJlbnQgPSBudWxsOyB9CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBbnl9IHBhcmVudCAtIFRoZSBwYXJlbnQgb2YgdGhpcyBwbHVnaW4uIElmIGFkZGVkIHRvIHRoZSBQbHVnaW5NYW5hZ2VyIHRoZSBwYXJlbnQgd2lsbCBiZSBzZXQgdG8gdGhhdCwgb3RoZXJ3aXNlIGl0IHdpbGwgYmUgbnVsbC4KICAgICovCiAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWN0aXZlIC0gQSBQbHVnaW4gd2l0aCBhY3RpdmU9dHJ1ZSBoYXMgaXRzIHByZVVwZGF0ZSBhbmQgdXBkYXRlIG1ldGhvZHMgY2FsbGVkIGJ5IHRoZSBwYXJlbnQsIG90aGVyd2lzZSB0aGV5IGFyZSBza2lwcGVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHZpc2libGUgLSBBIFBsdWdpbiB3aXRoIHZpc2libGU9dHJ1ZSBoYXMgaXRzIHJlbmRlciBhbmQgcG9zdFJlbmRlciBtZXRob2RzIGNhbGxlZCBieSB0aGUgcGFyZW50LCBvdGhlcndpc2UgdGhleSBhcmUgc2tpcHBlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnZpc2libGUgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGFzUHJlVXBkYXRlIC0gQSBmbGFnIHRvIGluZGljYXRlIGlmIHRoaXMgcGx1Z2luIGhhcyBhIHByZVVwZGF0ZSBtZXRob2QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5oYXNQcmVVcGRhdGUgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGFzVXBkYXRlIC0gQSBmbGFnIHRvIGluZGljYXRlIGlmIHRoaXMgcGx1Z2luIGhhcyBhbiB1cGRhdGUgbWV0aG9kLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaGFzVXBkYXRlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGFzUG9zdFVwZGF0ZSAtIEEgZmxhZyB0byBpbmRpY2F0ZSBpZiB0aGlzIHBsdWdpbiBoYXMgYSBwb3N0VXBkYXRlIG1ldGhvZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmhhc1Bvc3RVcGRhdGUgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGFzUmVuZGVyIC0gQSBmbGFnIHRvIGluZGljYXRlIGlmIHRoaXMgcGx1Z2luIGhhcyBhIHJlbmRlciBtZXRob2QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5oYXNSZW5kZXIgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGFzUG9zdFJlbmRlciAtIEEgZmxhZyB0byBpbmRpY2F0ZSBpZiB0aGlzIHBsdWdpbiBoYXMgYSBwb3N0UmVuZGVyIG1ldGhvZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmhhc1Bvc3RSZW5kZXIgPSBmYWxzZTsKCn07CgpQaGFzZXIuUGx1Z2luLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogUHJlLXVwZGF0ZSBpcyBjYWxsZWQgYXQgdGhlIHZlcnkgc3RhcnQgb2YgdGhlIHVwZGF0ZSBjeWNsZSwgYmVmb3JlIGFueSBvdGhlciBzdWJzeXN0ZW1zIGhhdmUgYmVlbiB1cGRhdGVkIChpbmNsdWRpbmcgUGh5c2ljcykuCiAgICAqIEl0IGlzIG9ubHkgY2FsbGVkIGlmIGFjdGl2ZSBpcyBzZXQgdG8gdHJ1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luI3ByZVVwZGF0ZQogICAgKi8KICAgIHByZVVwZGF0ZTogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlIGlzIGNhbGxlZCBhZnRlciBhbGwgdGhlIGNvcmUgc3Vic3lzdGVtcyAoSW5wdXQsIFR3ZWVucywgU291bmQsIGV0YykgYW5kIHRoZSBTdGF0ZSBoYXZlIHVwZGF0ZWQsIGJ1dCBiZWZvcmUgdGhlIHJlbmRlci4KICAgICogSXQgaXMgb25seSBjYWxsZWQgaWYgYWN0aXZlIGlzIHNldCB0byB0cnVlLgogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW4jdXBkYXRlCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgaXMgY2FsbGVkIHJpZ2h0IGFmdGVyIHRoZSBHYW1lIFJlbmRlcmVyIGNvbXBsZXRlcywgYnV0IGJlZm9yZSB0aGUgU3RhdGUucmVuZGVyLgogICAgKiBJdCBpcyBvbmx5IGNhbGxlZCBpZiB2aXNpYmxlIGlzIHNldCB0byB0cnVlLgogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW4jcmVuZGVyCiAgICAqLwogICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKICAgIC8qKgogICAgKiBQb3N0LXJlbmRlciBpcyBjYWxsZWQgYWZ0ZXIgdGhlIEdhbWUgUmVuZGVyZXIgYW5kIFN0YXRlLnJlbmRlciBoYXZlIHJ1bi4KICAgICogSXQgaXMgb25seSBjYWxsZWQgaWYgdmlzaWJsZSBpcyBzZXQgdG8gdHJ1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luI3Bvc3RSZW5kZXIKICAgICovCiAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKICAgIC8qKgogICAgKiBDbGVhciBkb3duIHRoaXMgUGx1Z2luIGFuZCBudWxsIG91dCByZWZlcmVuY2VzCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbiNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmdhbWUgPSBudWxsOwogICAgICAgIHRoaXMucGFyZW50ID0gbnVsbDsKICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgIHRoaXMudmlzaWJsZSA9IGZhbHNlOwogICAgICAgIAogICAgfQoKfTsKClBoYXNlci5QbHVnaW4ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlBsdWdpbjsKCi8qIGpzaGludCBuZXdjYXA6IGZhbHNlICovCgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKiogCiogVGhlIFBsdWdpbiBNYW5hZ2VyIGlzIHJlc3BvbnNpYmxlIGZvciB0aGUgbG9hZGluZywgcnVubmluZyBhbmQgdW5sb2FkaW5nIG9mIFBoYXNlciBQbHVnaW5zLgoqIAoqIEBjbGFzcyBQaGFzZXIuUGx1Z2luTWFuYWdlcgoqIEBjbGFzc2Rlc2MgUGhhc2VyIC0gUGx1Z2luTWFuYWdlcgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBwYXJlbnQgLSBEZXNjcmlwdGlvbi4KKi8KUGhhc2VyLlBsdWdpbk1hbmFnZXIgPSBmdW5jdGlvbihnYW1lLCBwYXJlbnQpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfcGFyZW50IC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fcGFyZW50ID0gcGFyZW50OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gcGx1Z2lucyAtIERlc2NyaXB0aW9uLgogICAgKi8KICAgIHRoaXMucGx1Z2lucyA9IFtdOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gX3BsdWdpbnNMZW5ndGggLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9wbHVnaW5zTGVuZ3RoID0gMDsKCn07CgpQaGFzZXIuUGx1Z2luTWFuYWdlci5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBQbHVnaW4gdG8gdGhlIFBsdWdpbk1hbmFnZXIuCiAgICAqIFRoZSBwbHVnaW4ncyBnYW1lIGFuZCBwYXJlbnQgcmVmZXJlbmNlIGFyZSBzZXQgdG8gdGhpcyBnYW1lIGFuZCBwbHVnaW5tYW5hZ2VyIHBhcmVudC4KICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luTWFuYWdlciNhZGQKICAgICogQHBhcmFtIHtQaGFzZXIuUGx1Z2lufSBwbHVnaW4gLSBEZXNjcmlwdGlvbi4KICAgICogQHJldHVybiB7UGhhc2VyLlBsdWdpbn0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgYWRkOiBmdW5jdGlvbiAocGx1Z2luKSB7CgogICAgICAgIHZhciByZXN1bHQgPSBmYWxzZTsKCiAgICAgICAgLy8gIFByb3RvdHlwZT8KICAgICAgICBpZiAodHlwZW9mIHBsdWdpbiA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICB7CiAgICAgICAgICAgIHBsdWdpbiA9IG5ldyBwbHVnaW4odGhpcy5nYW1lLCB0aGlzLl9wYXJlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBwbHVnaW4uZ2FtZSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgcGx1Z2luLnBhcmVudCA9IHRoaXMuX3BhcmVudDsKICAgICAgICB9CgogICAgICAgIC8vICBDaGVjayBmb3IgbWV0aG9kcyBub3cgdG8gYXZvaWQgaGF2aW5nIHRvIGRvIHRoaXMgZXZlcnkgbG9vcAogICAgICAgIGlmICh0eXBlb2YgcGx1Z2luWydwcmVVcGRhdGUnXSA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICB7CiAgICAgICAgICAgIHBsdWdpbi5oYXNQcmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICByZXN1bHQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBwbHVnaW5bJ3VwZGF0ZSddID09PSAnZnVuY3Rpb24nKQogICAgICAgIHsKICAgICAgICAgICAgcGx1Z2luLmhhc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIHJlc3VsdCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHBsdWdpblsncG9zdFVwZGF0ZSddID09PSAnZnVuY3Rpb24nKQogICAgICAgIHsKICAgICAgICAgICAgcGx1Z2luLmhhc1Bvc3RVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICByZXN1bHQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBwbHVnaW5bJ3JlbmRlciddID09PSAnZnVuY3Rpb24nKQogICAgICAgIHsKICAgICAgICAgICAgcGx1Z2luLmhhc1JlbmRlciA9IHRydWU7CiAgICAgICAgICAgIHJlc3VsdCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHBsdWdpblsncG9zdFJlbmRlciddID09PSAnZnVuY3Rpb24nKQogICAgICAgIHsKICAgICAgICAgICAgcGx1Z2luLmhhc1Bvc3RSZW5kZXIgPSB0cnVlOwogICAgICAgICAgICByZXN1bHQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gIFRoZSBwbHVnaW4gbXVzdCBoYXZlIGF0IGxlYXN0IG9uZSBvZiB0aGUgYWJvdmUgZnVuY3Rpb25zIHRvIGJlIGFkZGVkIHRvIHRoZSBQbHVnaW5NYW5hZ2VyLgogICAgICAgIGlmIChyZXN1bHQpCiAgICAgICAgewogICAgICAgICAgICBpZiAocGx1Z2luLmhhc1ByZVVwZGF0ZSB8fCBwbHVnaW4uaGFzVXBkYXRlIHx8IHBsdWdpbi5oYXNQb3N0VXBkYXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwbHVnaW4uYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHBsdWdpbi5oYXNSZW5kZXIgfHwgcGx1Z2luLmhhc1Bvc3RSZW5kZXIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHBsdWdpbi52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcGx1Z2luc0xlbmd0aCA9IHRoaXMucGx1Z2lucy5wdXNoKHBsdWdpbik7CgogICAgICAgICAgICAvLyBBbGxvd3MgcGx1Z2lucyB0byBydW4gcG90ZW50aWFsbHkgZGVzdHJ1Y3RpdmUgY29kZSBvdXRzaWRlIG9mIHRoZSBjb25zdHJ1Y3RvciwgYW5kIG9ubHkgaWYgYmVpbmcgYWRkZWQgdG8gdGhlIFBsdWdpbk1hbmFnZXIKICAgICAgICAgICAgaWYgKHR5cGVvZiBwbHVnaW5bJ2luaXQnXSA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcGx1Z2luLmluaXQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHBsdWdpbjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlIGEgUGx1Z2luIGZyb20gdGhlIFBsdWdpbk1hbmFnZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbk1hbmFnZXIjcmVtb3ZlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBsdWdpbn0gcGx1Z2luIC0gVGhlIHBsdWdpbiB0byBiZSByZW1vdmVkLgogICAgKi8KICAgIHJlbW92ZTogZnVuY3Rpb24gKHBsdWdpbikgewogICAgICAgIAogICAgICAgIGlmICh0aGlzLl9wbHVnaW5zTGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh0aGlzLl9wID0gMDsgdGhpcy5fcCA8IHRoaXMuX3BsdWdpbnNMZW5ndGg7IHRoaXMuX3ArKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnBsdWdpbnNbdGhpcy5fcF0gPT09IHBsdWdpbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcGx1Z2luLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIHRoaXMucGx1Z2lucy5zcGxpY2UodGhpcy5fcCwgMSk7CiAgICAgICAgICAgICAgICB0aGlzLl9wbHVnaW5zTGVuZ3RoLS07CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGFsbCBQbHVnaW5zIGZyb20gdGhlIFBsdWdpbk1hbmFnZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbk1hbmFnZXIjcmVtb3ZlQWxsCiAgICAqLwogICAgcmVtb3ZlQWxsOiBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICBmb3IgKHRoaXMuX3AgPSAwOyB0aGlzLl9wIDwgdGhpcy5fcGx1Z2luc0xlbmd0aDsgdGhpcy5fcCsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLmRlc3Ryb3koKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5wbHVnaW5zLmxlbmd0aCA9IDA7CiAgICAgICAgdGhpcy5fcGx1Z2luc0xlbmd0aCA9IDA7CiAgICB9LAoKICAgIC8qKgogICAgKiBQcmUtdXBkYXRlIGlzIGNhbGxlZCBhdCB0aGUgdmVyeSBzdGFydCBvZiB0aGUgdXBkYXRlIGN5Y2xlLCBiZWZvcmUgYW55IG90aGVyIHN1YnN5c3RlbXMgaGF2ZSBiZWVuIHVwZGF0ZWQgKGluY2x1ZGluZyBQaHlzaWNzKS4KICAgICogSXQgb25seSBjYWxscyBwbHVnaW5zIHdobyBoYXZlIGFjdGl2ZT10cnVlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luTWFuYWdlciNwcmVVcGRhdGUKICAgICovCiAgICBwcmVVcGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX3BsdWdpbnNMZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKHRoaXMuX3AgPSAwOyB0aGlzLl9wIDwgdGhpcy5fcGx1Z2luc0xlbmd0aDsgdGhpcy5fcCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMucGx1Z2luc1t0aGlzLl9wXS5hY3RpdmUgJiYgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLmhhc1ByZVVwZGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLnByZVVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZSBpcyBjYWxsZWQgYWZ0ZXIgYWxsIHRoZSBjb3JlIHN1YnN5c3RlbXMgKElucHV0LCBUd2VlbnMsIFNvdW5kLCBldGMpIGFuZCB0aGUgU3RhdGUgaGF2ZSB1cGRhdGVkLCBidXQgYmVmb3JlIHRoZSByZW5kZXIuCiAgICAqIEl0IG9ubHkgY2FsbHMgcGx1Z2lucyB3aG8gaGF2ZSBhY3RpdmU9dHJ1ZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbk1hbmFnZXIjdXBkYXRlCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuX3BsdWdpbnNMZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKHRoaXMuX3AgPSAwOyB0aGlzLl9wIDwgdGhpcy5fcGx1Z2luc0xlbmd0aDsgdGhpcy5fcCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMucGx1Z2luc1t0aGlzLl9wXS5hY3RpdmUgJiYgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLmhhc1VwZGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLnVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFBvc3RVcGRhdGUgaXMgdGhlIGxhc3QgdGhpbmcgdG8gYmUgY2FsbGVkIGJlZm9yZSB0aGUgd29ybGQgcmVuZGVyLgogICAgKiBJbiBwYXJ0aWN1bGFyLCBpdCBpcyBjYWxsZWQgYWZ0ZXIgdGhlIHdvcmxkIHBvc3RVcGRhdGUsIHdoaWNoIG1lYW5zIHRoZSBjYW1lcmEgaGFzIGJlZW4gYWRqdXN0ZWQuCiAgICAqIEl0IG9ubHkgY2FsbHMgcGx1Z2lucyB3aG8gaGF2ZSBhY3RpdmU9dHJ1ZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbk1hbmFnZXIjcG9zdFVwZGF0ZQogICAgKi8KICAgIHBvc3RVcGRhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5fcGx1Z2luc0xlbmd0aCA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodGhpcy5fcCA9IDA7IHRoaXMuX3AgPCB0aGlzLl9wbHVnaW5zTGVuZ3RoOyB0aGlzLl9wKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5wbHVnaW5zW3RoaXMuX3BdLmFjdGl2ZSAmJiB0aGlzLnBsdWdpbnNbdGhpcy5fcF0uaGFzUG9zdFVwZGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLnBvc3RVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgaXMgY2FsbGVkIHJpZ2h0IGFmdGVyIHRoZSBHYW1lIFJlbmRlcmVyIGNvbXBsZXRlcywgYnV0IGJlZm9yZSB0aGUgU3RhdGUucmVuZGVyLgogICAgKiBJdCBvbmx5IGNhbGxzIHBsdWdpbnMgd2hvIGhhdmUgdmlzaWJsZT10cnVlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luTWFuYWdlciNyZW5kZXIKICAgICovCiAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX3BsdWdpbnNMZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKHRoaXMuX3AgPSAwOyB0aGlzLl9wIDwgdGhpcy5fcGx1Z2luc0xlbmd0aDsgdGhpcy5fcCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMucGx1Z2luc1t0aGlzLl9wXS52aXNpYmxlICYmIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5oYXNSZW5kZXIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5yZW5kZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBQb3N0LXJlbmRlciBpcyBjYWxsZWQgYWZ0ZXIgdGhlIEdhbWUgUmVuZGVyZXIgYW5kIFN0YXRlLnJlbmRlciBoYXZlIHJ1bi4KICAgICogSXQgb25seSBjYWxscyBwbHVnaW5zIHdobyBoYXZlIHZpc2libGU9dHJ1ZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbk1hbmFnZXIjcG9zdFJlbmRlcgogICAgKi8KICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX3BsdWdpbnNMZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKHRoaXMuX3AgPSAwOyB0aGlzLl9wIDwgdGhpcy5fcGx1Z2luc0xlbmd0aDsgdGhpcy5fcCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMucGx1Z2luc1t0aGlzLl9wXS52aXNpYmxlICYmIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5oYXNQb3N0UmVuZGVyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbnNbdGhpcy5fcF0ucG9zdFJlbmRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENsZWFyIGRvd24gdGhpcyBQbHVnaW5NYW5hZ2VyIGFuZCBudWxsIG91dCByZWZlcmVuY2VzCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMucGx1Z2lucy5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuX3BsdWdpbnNMZW5ndGggPSAwOwogICAgICAgIHRoaXMuZ2FtZSA9IG51bGw7CiAgICAgICAgdGhpcy5fcGFyZW50ID0gbnVsbDsKCiAgICB9Cgp9OwoKUGhhc2VyLlBsdWdpbk1hbmFnZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlBsdWdpbk1hbmFnZXI7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBUaGUgU3RhZ2UgY29udHJvbHMgdGhlIGNhbnZhcyBvbiB3aGljaCBldmVyeXRoaW5nIGlzIGRpc3BsYXllZC4gSXQgaGFuZGxlcyBkaXNwbGF5IHdpdGhpbiB0aGUgYnJvd3NlciwKKiBmb2N1cyBoYW5kbGluZywgZ2FtZSByZXNpemluZywgc2NhbGluZyBhbmQgdGhlIHBhdXNlLCBib290IGFuZCBvcmllbnRhdGlvbiBzY3JlZW5zLgoqCiogQGNsYXNzIFBoYXNlci5TdGFnZQoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBHYW1lIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBXaWR0aCBvZiB0aGUgY2FudmFzIGVsZW1lbnQuCiogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIEhlaWdodCBvZiB0aGUgY2FudmFzIGVsZW1lbnQuCiAqLwpQaGFzZXIuU3RhZ2UgPSBmdW5jdGlvbiAoZ2FtZSwgd2lkdGgsIGhlaWdodCkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGdhbWUgLSBCYWNrZ3JvdW5kIGNvbG9yIG9mIHRoZSBzdGFnZSAoZGVmYXVsdHMgdG8gYmxhY2spLiBTZXQgdmlhIHRoZSBwdWJsaWMgYmFja2dyb3VuZENvbG9yIHByb3BlcnR5LgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2JhY2tncm91bmRDb2xvciA9ICdyZ2IoMCwwLDApJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IG9mZnNldCAtIEdldCB0aGUgb2Zmc2V0IHZhbHVlcyAoZm9yIGlucHV0IGFuZCBvdGhlciB0aGluZ3MpLgogICAgKi8KICAgIHRoaXMub2Zmc2V0ID0gbmV3IFBoYXNlci5Qb2ludCgpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gUmVmZXJlbmNlIHRvIHRoZSBuZXdseSBjcmVhdGVkIGBjYW52YXNgIGVsZW1lbnQuCiAgICAqLwogICAgdGhpcy5jYW52YXMgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQSVhJLlN0YWdlfSBfc3RhZ2UgLSBUaGUgUGl4aSBTdGFnZSB3aGljaCBpcyBob29rZWQgdG8gdGhlIHJlbmRlcmVyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3N0YWdlID0gbmV3IFBJWEkuU3RhZ2UoMHgwMDAwMDAsIGZhbHNlKTsKICAgIHRoaXMuX3N0YWdlLm5hbWUgPSAnX3N0YWdlX3Jvb3QnOwogICAgdGhpcy5fc3RhZ2UuaW50ZXJhY3RpdmUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQSVhJLlN0YWdlfSBkaXNwbGF5IC0gVGhlIFBpeGkgU3RhZ2Ugd2hpY2ggaXMgaG9va2VkIHRvIHRoZSByZW5kZXJlci4KICAgICovCiAgICB0aGlzLmRpc3BsYXkgPSB0aGlzLl9zdGFnZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNjYWxlTW9kZSAtIFRoZSBjdXJyZW50IHNjYWxlTW9kZS4KICAgICovCiAgICB0aGlzLnNjYWxlTW9kZSA9IFBoYXNlci5TdGFnZVNjYWxlTW9kZS5OT19TQ0FMRTsKCiAgICAvKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZnVsbFNjcmVlblNjYWxlTW9kZSAtIFNjYWxlIG1vZGUgdG8gYmUgdXNlZCBpbiBmdWxsU2NyZWVuCiAgICAgKi8KICAgIHRoaXMuZnVsbFNjcmVlblNjYWxlTW9kZSA9IFBoYXNlci5TdGFnZVNjYWxlTW9kZS5OT19TQ0FMRTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU3RhZ2VTY2FsZU1vZGV9IHNjYWxlIC0gVGhlIHNjYWxlIG9mIHRoZSBjdXJyZW50IHJ1bm5pbmcgZ2FtZS4KICAgICovCiAgICB0aGlzLnNjYWxlID0gbmV3IFBoYXNlci5TdGFnZVNjYWxlTW9kZSh0aGlzLmdhbWUsIHdpZHRoLCBoZWlnaHQpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gYXNwZWN0UmF0aW8gLSBBc3BlY3QgcmF0aW8uCiAgICAqLwogICAgdGhpcy5hc3BlY3RSYXRpbyA9IHdpZHRoIC8gaGVpZ2h0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRpc2FibGVWaXNpYmlsaXR5Q2hhbmdlIC0gQnkgZGVmYXVsdCBpZiB0aGUgYnJvd3NlciB0YWIgbG9zZXMgZm9jdXMgdGhlIGdhbWUgd2lsbCBwYXVzZS4gWW91IGNhbiBzdG9wIHRoYXQgYmVoYXZpb3VyIGJ5IHNldHRpbmcgdGhpcyBwcm9wZXJ0eSB0byB0cnVlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGlzYWJsZVZpc2liaWxpdHlDaGFuZ2UgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9uZXh0T2Zmc2V0Q2hlY2sgLSBUaGUgdGltZSB0byBydW4gdGhlIG5leHQgb2Zmc2V0IGNoZWNrLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX25leHRPZmZzZXRDaGVjayA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfGZhbHNlfSBjaGVja09mZnNldEludGVydmFsIC0gVGhlIHRpbWUgKGluIG1zKSBiZXR3ZWVuIHdoaWNoIHRoZSBzdGFnZSBzaG91bGQgY2hlY2sgdG8gc2VlIGlmIGl0IGhhcyBtb3ZlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNoZWNrT2Zmc2V0SW50ZXJ2YWwgPSAyNTAwOwoKICAgIGlmIChnYW1lLmNvbmZpZykKICAgIHsKICAgICAgICB0aGlzLnBhcnNlQ29uZmlnKGdhbWUuY29uZmlnKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLmNhbnZhcyA9IFBoYXNlci5DYW52YXMuY3JlYXRlKHdpZHRoLCBoZWlnaHQpOwogICAgICAgIHRoaXMuY2FudmFzLnN0eWxlWyctd2Via2l0LWZ1bGwtc2NyZWVuJ10gPSAnd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJSc7CiAgICB9Cgp9OwoKUGhhc2VyLlN0YWdlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogUGFyc2VzIGEgR2FtZSBjb25maWd1cmF0aW9uIG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2UjcGFyc2VDb25maWcKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHBhcnNlQ29uZmlnOiBmdW5jdGlvbiAoY29uZmlnKSB7CgogICAgICAgIGlmIChjb25maWdbJ2NhbnZhc0lEJ10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNhbnZhcyA9IFBoYXNlci5DYW52YXMuY3JlYXRlKHRoaXMuZ2FtZS53aWR0aCwgdGhpcy5nYW1lLmhlaWdodCwgY29uZmlnWydjYW52YXNJRCddKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jYW52YXMgPSBQaGFzZXIuQ2FudmFzLmNyZWF0ZSh0aGlzLmdhbWUud2lkdGgsIHRoaXMuZ2FtZS5oZWlnaHQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZ1snY2FudmFzU3R5bGUnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2FudmFzLnN0bHllID0gY29uZmlnWydjYW52YXNTdHlsZSddOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNhbnZhcy5zdHlsZVsnLXdlYmtpdC1mdWxsLXNjcmVlbiddID0gJ3dpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCUnOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZ1snY2hlY2tPZmZzZXRJbnRlcnZhbCddKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jaGVja09mZnNldEludGVydmFsID0gY29uZmlnWydjaGVja09mZnNldEludGVydmFsJ107CiAgICAgICAgfQoKICAgICAgICBpZiAoY29uZmlnWydkaXNhYmxlVmlzaWJpbGl0eUNoYW5nZSddKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5kaXNhYmxlVmlzaWJpbGl0eUNoYW5nZSA9IGNvbmZpZ1snZGlzYWJsZVZpc2liaWxpdHlDaGFuZ2UnXTsKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWdbJ2Z1bGxTY3JlZW5TY2FsZU1vZGUnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnVsbFNjcmVlblNjYWxlTW9kZSA9IGNvbmZpZ1snZnVsbFNjcmVlblNjYWxlTW9kZSddOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZ1snc2NhbGVNb2RlJ10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNjYWxlTW9kZSA9IGNvbmZpZ1snc2NhbGVNb2RlJ107CiAgICAgICAgfQoKICAgICAgICBpZiAoY29uZmlnWydiYWNrZ3JvdW5kQ29sb3InXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYmFja2dyb3VuZENvbG9yID0gY29uZmlnWydiYWNrZ3JvdW5kQ29sb3InXTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSW5pdGlhbGlzZXMgdGhlIHN0YWdlIGFuZCBhZGRzIHRoZSBldmVudCBsaXN0ZW5lcnMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlI2Jvb3QKICAgICogQHByaXZhdGUKICAgICovCiAgICBib290OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIFBoYXNlci5DYW52YXMuZ2V0T2Zmc2V0KHRoaXMuY2FudmFzLCB0aGlzLm9mZnNldCk7CgogICAgICAgIHRoaXMuYm91bmRzID0gbmV3IFBoYXNlci5SZWN0YW5nbGUodGhpcy5vZmZzZXQueCwgdGhpcy5vZmZzZXQueSwgdGhpcy5nYW1lLndpZHRoLCB0aGlzLmdhbWUuaGVpZ2h0KTsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgdGhpcy5fb25DaGFuZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLnZpc2liaWxpdHlDaGFuZ2UoZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgUGhhc2VyLkNhbnZhcy5zZXRVc2VyU2VsZWN0KHRoaXMuY2FudmFzLCAnbm9uZScpOwogICAgICAgIFBoYXNlci5DYW52YXMuc2V0VG91Y2hBY3Rpb24odGhpcy5jYW52YXMsICdub25lJyk7CgogICAgICAgIHRoaXMuYmFja2dyb3VuZENvbG9yID0gJyMwMDAnOwoKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd2aXNpYmlsaXR5Y2hhbmdlJywgdGhpcy5fb25DaGFuZ2UsIGZhbHNlKTsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXR2aXNpYmlsaXR5Y2hhbmdlJywgdGhpcy5fb25DaGFuZ2UsIGZhbHNlKTsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdwYWdlaGlkZScsIHRoaXMuX29uQ2hhbmdlLCBmYWxzZSk7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigncGFnZXNob3cnLCB0aGlzLl9vbkNoYW5nZSwgZmFsc2UpOwoKICAgICAgICB3aW5kb3cub25ibHVyID0gdGhpcy5fb25DaGFuZ2U7CiAgICAgICAgd2luZG93Lm9uZm9jdXMgPSB0aGlzLl9vbkNoYW5nZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSdW5zIFN0YWdlIHByb2Nlc3NlcyB0aGF0IG5lZWQgcGVyaW9kaWMgdXBkYXRlcywgc3VjaCBhcyB0aGUgb2Zmc2V0IGNoZWNrcy4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2UjdXBkYXRlCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmNoZWNrT2Zmc2V0SW50ZXJ2YWwgIT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50aW1lLm5vdyA+IHRoaXMuX25leHRPZmZzZXRDaGVjaykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgUGhhc2VyLkNhbnZhcy5nZXRPZmZzZXQodGhpcy5jYW52YXMsIHRoaXMub2Zmc2V0KTsKICAgICAgICAgICAgICAgIHRoaXMuX25leHRPZmZzZXRDaGVjayA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIHRoaXMuY2hlY2tPZmZzZXRJbnRlcnZhbDsKICAgICAgICAgICAgfQoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVGhpcyBtZXRob2QgaXMgY2FsbGVkIHdoZW4gdGhlIGRvY3VtZW50IHZpc2liaWxpdHkgaXMgY2hhbmdlZC4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2UjdmlzaWJpbGl0eUNoYW5nZQogICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAtIEl0cyB0eXBlIHdpbGwgYmUgdXNlZCB0byBkZWNpZGUgd2hldGhlciB0aGUgZ2FtZSBzaG91bGQgYmUgcGF1c2VkIG9yIG5vdC4KICAgICovCiAgICB2aXNpYmlsaXR5Q2hhbmdlOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZVZpc2liaWxpdHlDaGFuZ2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLnBhdXNlZCA9PT0gZmFsc2UgJiYgKGV2ZW50LnR5cGUgPT0gJ3BhZ2VoaWRlJyB8fCBldmVudC50eXBlID09ICdibHVyJyB8fCBkb2N1bWVudFsnaGlkZGVuJ10gPT09IHRydWUgfHwgZG9jdW1lbnRbJ3dlYmtpdEhpZGRlbiddID09PSB0cnVlKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXVzZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUucGF1c2VkID0gZmFsc2U7CiAgICAgICAgfQoKICAgIH0KCn07CgpQaGFzZXIuU3RhZ2UucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlN0YWdlOwoKLyoqCiogQG5hbWUgUGhhc2VyLlN0YWdlI2JhY2tncm91bmRDb2xvcgoqIEBwcm9wZXJ0eSB7bnVtYmVyfHN0cmluZ30gYmFja2dyb3VuZENvbG9yIC0gR2V0cyBhbmQgc2V0cyB0aGUgYmFja2dyb3VuZCBjb2xvciBvZiB0aGUgc3RhZ2UuIFRoZSBjb2xvciBjYW4gYmUgZ2l2ZW4gYXMgYSBudW1iZXI6IDB4ZmYwMDAwIG9yIGEgaGV4IHN0cmluZzogJyNmZjAwMDAnCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3RhZ2UucHJvdG90eXBlLCAiYmFja2dyb3VuZENvbG9yIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9iYWNrZ3JvdW5kQ29sb3I7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKGNvbG9yKSB7CgogICAgICAgIHRoaXMuX2JhY2tncm91bmRDb2xvciA9IGNvbG9yOwoKICAgICAgICBpZiAodGhpcy5nYW1lLnRyYW5zcGFyZW50ID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyVHlwZSA9PSBQaGFzZXIuQ0FOVkFTKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgU2V0IGl0IGRpcmVjdGx5LCB0aGlzIGFsbG93cyB1cyB0byB1c2UgcmdiIGFscGhhIHZhbHVlcyBpbiBDYW52YXMgbW9kZS4KICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW52YXMuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbG9yID09PSAnc3RyaW5nJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjb2xvciA9IFBoYXNlci5Db2xvci5oZXhUb1JHQihjb2xvcik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fc3RhZ2Uuc2V0QmFja2dyb3VuZENvbG9yKGNvbG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIgR3JvdXAgY29uc3RydWN0b3IuCiogQGNsYXNzIFBoYXNlci5Hcm91cAoqIEBjbGFzc2Rlc2MgQSBHcm91cCBpcyBhIGNvbnRhaW5lciBmb3IgZGlzcGxheSBvYmplY3RzIHRoYXQgYWxsb3dzIGZvciBmYXN0IHBvb2xpbmcsIHJlY3ljbGluZyBhbmQgY29sbGlzaW9uIGNoZWNrcy4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHsqfSBwYXJlbnQgLSBUaGUgcGFyZW50IEdyb3VwIG9yIERpc3BsYXlPYmplY3RDb250YWluZXIgdGhhdCB3aWxsIGhvbGQgdGhpcyBncm91cCwgaWYgYW55LiBJZiB1bmRlZmluZWQgaXQgd2lsbCB1c2UgZ2FtZS53b3JsZC4KKiBAcGFyYW0ge3N0cmluZ30gW25hbWU9Z3JvdXBdIC0gQSBuYW1lIGZvciB0aGlzIEdyb3VwLiBOb3QgdXNlZCBpbnRlcm5hbGx5IGJ1dCB1c2VmdWwgZm9yIGRlYnVnZ2luZy4KKiBAcGFyYW0ge2Jvb2xlYW59IFt1c2VTdGFnZT1mYWxzZV0gLSBTaG91bGQgdGhlIERpc3BsYXlPYmplY3RDb250YWluZXIgdGhpcyBHcm91cCBjcmVhdGVzIGJlIGFkZGVkIHRvIHRoZSBXb3JsZCAoZGVmYXVsdCwgZmFsc2UpIG9yIGRpcmVjdCB0byB0aGUgU3RhZ2UgKHRydWUpLgoqLwpQaGFzZXIuR3JvdXAgPSBmdW5jdGlvbiAoZ2FtZSwgcGFyZW50LCBuYW1lLCB1c2VTdGFnZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICBpZiAodHlwZW9mIHBhcmVudCA9PT0gJ3VuZGVmaW5lZCcpCiAgICB7CiAgICAgICAgcGFyZW50ID0gZ2FtZS53b3JsZDsKICAgIH0KCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBBIG5hbWUgZm9yIHRoaXMgR3JvdXAuIE5vdCB1c2VkIGludGVybmFsbHkgYnV0IHVzZWZ1bCBmb3IgZGVidWdnaW5nLgogICAgKi8KICAgIHRoaXMubmFtZSA9IG5hbWUgfHwgJ2dyb3VwJzsKCiAgICBpZiAodHlwZW9mIHVzZVN0YWdlID09PSAndW5kZWZpbmVkJykKICAgIHsKICAgICAgICB1c2VTdGFnZSA9IGZhbHNlOwogICAgfQoKICAgIGlmICh1c2VTdGFnZSkKICAgIHsKICAgICAgICB0aGlzLl9jb250YWluZXIgPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMuX2NvbnRhaW5lciA9IG5ldyBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIoKTsKICAgICAgICB0aGlzLl9jb250YWluZXIubmFtZSA9IHRoaXMubmFtZTsKCiAgICAgICAgaWYgKHBhcmVudCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChwYXJlbnQgaW5zdGFuY2VvZiBQaGFzZXIuR3JvdXApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHBhcmVudC5fY29udGFpbmVyLmFkZENoaWxkKHRoaXMuX2NvbnRhaW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwYXJlbnQuYWRkQ2hpbGQodGhpcy5fY29udGFpbmVyKTsKICAgICAgICAgICAgICAgIHBhcmVudC51cGRhdGVUcmFuc2Zvcm0oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmFkZENoaWxkKHRoaXMuX2NvbnRhaW5lcik7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UudXBkYXRlVHJhbnNmb3JtKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIEludGVybmFsIFBoYXNlciBUeXBlIHZhbHVlLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLkdST1VQOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsaXZlIC0gVGhlIGFsaXZlIHByb3BlcnR5IGlzIHVzZWZ1bCBmb3IgR3JvdXBzIHRoYXQgYXJlIGNoaWxkcmVuIG9mIG90aGVyIEdyb3VwcyBhbmQgbmVlZCB0byBiZSBpbmNsdWRlZC9leGNsdWRlZCBpbiBjaGVja3MgbGlrZSBmb3JFYWNoQWxpdmUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbGl2ZSA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZXhpc3RzIC0gSWYgZXhpc3RzIGlzIHRydWUgdGhlIHRoZSBHcm91cCBpcyB1cGRhdGVkLCBvdGhlcndpc2UgaXQgaXMgc2tpcHBlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmV4aXN0cyA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdyb3VwfSBncm91cCAtIFRoZSBwYXJlbnQgR3JvdXAgb2YgdGhpcyBHcm91cCwgaWYgYSBjaGlsZCBvZiBhbm90aGVyLgogICAgKi8KICAgIHRoaXMuZ3JvdXAgPSBudWxsOwoKICAgIC8vICBSZXBsYWNlcyB0aGUgUElYSS5Qb2ludCB3aXRoIGEgc2xpZ2h0bHkgbW9yZSBmbGV4aWJsZSBvbmUuCiAgICB0aGlzLl9jb250YWluZXIuc2NhbGUgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc2NhbGUgLSBUaGUgc2NhbmUgb2YgdGhlIEdyb3VwIGNvbnRhaW5lci4KICAgICovCiAgICB0aGlzLnNjYWxlID0gdGhpcy5fY29udGFpbmVyLnNjYWxlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gcGl2b3QgLSBUaGUgcGl2b3QgcG9pbnQgb2YgdGhlIEdyb3VwIGNvbnRhaW5lci4KICAgICovCiAgICB0aGlzLnBpdm90ID0gdGhpcy5fY29udGFpbmVyLnBpdm90OwoKICAgIC8qKgogICAgKiBUaGUgY3Vyc29yIGlzIGEgc2ltcGxlIHdheSB0byBpdGVyYXRlIHRocm91Z2ggdGhlIG9iamVjdHMgaW4gYSBHcm91cCB1c2luZyB0aGUgR3JvdXAubmV4dCBhbmQgR3JvdXAucHJldmlvdXMgZnVuY3Rpb25zLgogICAgKiBUaGUgY3Vyc29yIGlzIHNldCB0byB0aGUgZmlyc3QgY2hpbGQgYWRkZWQgdG8gdGhlIEdyb3VwIGFuZCBkb2Vzbid0IGNoYW5nZSB1bmxlc3MgeW91IGNhbGwgbmV4dCwgcHJldmlvdXMgb3Igc2V0IGl0IGRpcmVjdGx5IHdpdGggR3JvdXAuY3Vyc29yLgogICAgKiBAcHJvcGVydHkge2FueX0gY3Vyc29yIC0gVGhlIGN1cnJlbnQgZGlzcGxheSBvYmplY3QgdGhhdCB0aGUgR3JvdXAgY3Vyc29yIGlzIHBvaW50aW5nIHRvLgogICAgKi8KICAgIHRoaXMuY3Vyc29yID0gbnVsbDsKCn07CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuR3JvdXAuUkVUVVJOX05PTkUgPSAwOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCA9IDE7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuR3JvdXAuUkVUVVJOX0NISUxEID0gMjsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Hcm91cC5TT1JUX0FTQ0VORElORyA9IC0xOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkdyb3VwLlNPUlRfREVTQ0VORElORyA9IDE7CgpQaGFzZXIuR3JvdXAucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBBZGRzIGFuIGV4aXN0aW5nIG9iamVjdCB0byB0aGlzIEdyb3VwLiBUaGUgb2JqZWN0IGNhbiBiZSBhbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuQnV0dG9uIG9yIGFueSBvdGhlciBkaXNwbGF5IG9iamVjdC4KICAgICogVGhlIGNoaWxkIGlzIGF1dG9tYXRpY2FsbHkgYWRkZWQgdG8gdGhlIHRvcCBvZiB0aGUgR3JvdXAsIHNvIHJlbmRlcnMgb24tdG9wIG9mIGV2ZXJ5dGhpbmcgZWxzZSB3aXRoaW4gdGhlIEdyb3VwLiBJZiB5b3UgbmVlZCB0byBjb250cm9sCiAgICAqIHRoYXQgdGhlbiBzZWUgdGhlIGFkZEF0IG1ldGhvZC4KICAgICoKICAgICogQHNlZSBQaGFzZXIuR3JvdXAjY3JlYXRlCiAgICAqIEBzZWUgUGhhc2VyLkdyb3VwI2FkZEF0CiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2FkZAogICAgKiBAcGFyYW0geyp9IGNoaWxkIC0gQW4gaW5zdGFuY2Ugb2YgUGhhc2VyLlNwcml0ZSwgUGhhc2VyLkJ1dHRvbiBvciBhbnkgb3RoZXIgZGlzcGxheSBvYmplY3QuLgogICAgKiBAcmV0dXJuIHsqfSBUaGUgY2hpbGQgdGhhdCB3YXMgYWRkZWQgdG8gdGhlIEdyb3VwLgogICAgKi8KICAgIGFkZDogZnVuY3Rpb24gKGNoaWxkKSB7CgogICAgICAgIGlmIChjaGlsZC5ncm91cCAhPT0gdGhpcykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChjaGlsZC50eXBlICYmIGNoaWxkLnR5cGUgPT09IFBoYXNlci5HUk9VUCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hpbGQuZ3JvdXAgPSB0aGlzOwoKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5hZGRDaGlsZChjaGlsZC5fY29udGFpbmVyKTsKCiAgICAgICAgICAgICAgICBjaGlsZC5fY29udGFpbmVyLnVwZGF0ZVRyYW5zZm9ybSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hpbGQuZ3JvdXAgPSB0aGlzOwoKICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5hZGRDaGlsZChjaGlsZCk7CgogICAgICAgICAgICAgICAgY2hpbGQudXBkYXRlVHJhbnNmb3JtKCk7CgogICAgICAgICAgICAgICAgaWYgKGNoaWxkLmV2ZW50cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjaGlsZC5ldmVudHMub25BZGRlZFRvR3JvdXAuZGlzcGF0Y2goY2hpbGQsIHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5jdXJzb3IgPT09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3Vyc29yID0gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBjaGlsZDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIGFuIGV4aXN0aW5nIG9iamVjdCB0byB0aGlzIEdyb3VwLiBUaGUgb2JqZWN0IGNhbiBiZSBhbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuQnV0dG9uIG9yIGFueSBvdGhlciBkaXNwbGF5IG9iamVjdC4KICAgICogVGhlIGNoaWxkIGlzIGFkZGVkIHRvIHRoZSBHcm91cCBhdCB0aGUgbG9jYXRpb24gc3BlY2lmaWVkIGJ5IHRoZSBpbmRleCB2YWx1ZSwgdGhpcyBhbGxvd3MgeW91IHRvIGNvbnRyb2wgY2hpbGQgb3JkZXJpbmcuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2FkZEF0CiAgICAqIEBwYXJhbSB7Kn0gY2hpbGQgLSBBbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuQnV0dG9uIG9yIGFueSBvdGhlciBkaXNwbGF5IG9iamVjdC4uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCB3aXRoaW4gdGhlIEdyb3VwIHRvIGluc2VydCB0aGUgY2hpbGQgdG8uCiAgICAqIEByZXR1cm4geyp9IFRoZSBjaGlsZCB0aGF0IHdhcyBhZGRlZCB0byB0aGUgR3JvdXAuCiAgICAqLwogICAgYWRkQXQ6IGZ1bmN0aW9uIChjaGlsZCwgaW5kZXgpIHsKCiAgICAgICAgaWYgKGNoaWxkLmdyb3VwICE9PSB0aGlzKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGNoaWxkLnR5cGUgJiYgY2hpbGQudHlwZSA9PT0gUGhhc2VyLkdST1VQKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGlsZC5ncm91cCA9IHRoaXM7CgogICAgICAgICAgICAgICAgdGhpcy5fY29udGFpbmVyLmFkZENoaWxkQXQoY2hpbGQuX2NvbnRhaW5lciwgaW5kZXgpOwoKICAgICAgICAgICAgICAgIGNoaWxkLl9jb250YWluZXIudXBkYXRlVHJhbnNmb3JtKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGlsZC5ncm91cCA9IHRoaXM7CgogICAgICAgICAgICAgICAgdGhpcy5fY29udGFpbmVyLmFkZENoaWxkQXQoY2hpbGQsIGluZGV4KTsKCiAgICAgICAgICAgICAgICBjaGlsZC51cGRhdGVUcmFuc2Zvcm0oKTsKCiAgICAgICAgICAgICAgICBpZiAoY2hpbGQuZXZlbnRzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNoaWxkLmV2ZW50cy5vbkFkZGVkVG9Hcm91cC5kaXNwYXRjaChjaGlsZCwgdGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnNvciA9PT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jdXJzb3IgPSBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGNoaWxkOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIGNoaWxkIGZvdW5kIGF0IHRoZSBnaXZlbiBpbmRleCB3aXRoaW4gdGhpcyBHcm91cC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZ2V0QXQKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IHRvIHJldHVybiB0aGUgY2hpbGQgZnJvbS4KICAgICogQHJldHVybiB7Kn0gVGhlIGNoaWxkIHRoYXQgd2FzIGZvdW5kIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgICovCiAgICBnZXRBdDogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgICAgIHJldHVybiB0aGlzLl9jb250YWluZXIuZ2V0Q2hpbGRBdChpbmRleCk7CgogICAgfSwKCiAgICAvKioKICAgICogQXV0b21hdGljYWxseSBjcmVhdGVzIGEgbmV3IFBoYXNlci5TcHJpdGUgb2JqZWN0IGFuZCBhZGRzIGl0IHRvIHRoZSB0b3Agb2YgdGhpcyBHcm91cC4KICAgICogVXNlZnVsIGlmIHlvdSBkb24ndCBuZWVkIHRvIGNyZWF0ZSB0aGUgU3ByaXRlIGluc3RhbmNlcyBiZWZvcmUtaGFuZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjY3JlYXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSB0byBkaXNwbGF5IHRoZSBuZXdseSBjcmVhdGVkIFNwcml0ZSBhdC4gVGhlIHZhbHVlIGlzIGluIHJlbGF0aW9uIHRvIHRoZSBHcm91cC54IHBvaW50LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgdG8gZGlzcGxheSB0aGUgbmV3bHkgY3JlYXRlZCBTcHJpdGUgYXQuIFRoZSB2YWx1ZSBpcyBpbiByZWxhdGlvbiB0byB0aGUgR3JvdXAueSBwb2ludC4KICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBHYW1lLmNhY2hlIGtleSBvZiB0aGUgaW1hZ2UgdGhhdCB0aGlzIFNwcml0ZSB3aWxsIHVzZS4KICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBbZnJhbWVdIC0gSWYgdGhlIFNwcml0ZSBpbWFnZSBjb250YWlucyBtdWx0aXBsZSBmcmFtZXMgeW91IGNhbiBzcGVjaWZ5IHdoaWNoIG9uZSB0byB1c2UgaGVyZS4KICAgICogQHBhcmFtIHtib29sZWFufSBbZXhpc3RzPXRydWVdIC0gVGhlIGRlZmF1bHQgZXhpc3RzIHN0YXRlIG9mIHRoZSBTcHJpdGUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5TcHJpdGV9IFRoZSBjaGlsZCB0aGF0IHdhcyBjcmVhdGVkLgogICAgKi8KICAgIGNyZWF0ZTogZnVuY3Rpb24gKHgsIHksIGtleSwgZnJhbWUsIGV4aXN0cykgewoKICAgICAgICBpZiAodHlwZW9mIGV4aXN0cyA9PT0gJ3VuZGVmaW5lZCcpIHsgZXhpc3RzID0gdHJ1ZTsgfQoKICAgICAgICB2YXIgY2hpbGQgPSBuZXcgUGhhc2VyLlNwcml0ZSh0aGlzLmdhbWUsIHgsIHksIGtleSwgZnJhbWUpOwoKICAgICAgICBjaGlsZC5ncm91cCA9IHRoaXM7CiAgICAgICAgY2hpbGQuZXhpc3RzID0gZXhpc3RzOwogICAgICAgIGNoaWxkLnZpc2libGUgPSBleGlzdHM7CiAgICAgICAgY2hpbGQuYWxpdmUgPSBleGlzdHM7CgogICAgICAgIHRoaXMuX2NvbnRhaW5lci5hZGRDaGlsZChjaGlsZCk7CiAgICAgICAgICAgIAogICAgICAgIGNoaWxkLnVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICBpZiAoY2hpbGQuZXZlbnRzKQogICAgICAgIHsKICAgICAgICAgICAgY2hpbGQuZXZlbnRzLm9uQWRkZWRUb0dyb3VwLmRpc3BhdGNoKGNoaWxkLCB0aGlzKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmN1cnNvciA9PT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY3Vyc29yID0gY2hpbGQ7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY2hpbGQ7CgogICAgfSwKCiAgICAvKioKICAgICogQXV0b21hdGljYWxseSBjcmVhdGVzIG11bHRpcGxlIFBoYXNlci5TcHJpdGUgb2JqZWN0cyBhbmQgYWRkcyB0aGVtIHRvIHRoZSB0b3Agb2YgdGhpcyBHcm91cC4KICAgICogVXNlZnVsIGlmIHlvdSBuZWVkIHRvIHF1aWNrbHkgZ2VuZXJhdGUgYSBwb29sIG9mIGlkZW50aWNhbCBzcHJpdGVzLCBzdWNoIGFzIGJ1bGxldHMuIEJ5IGRlZmF1bHQgdGhlIHNwcml0ZXMgd2lsbCBiZSBzZXQgdG8gbm90IGV4aXN0CiAgICAqIGFuZCB3aWxsIGJlIHBvc2l0aW9uZWQgYXQgMCwgMCAocmVsYXRpdmUgdG8gdGhlIEdyb3VwLngveSkKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjY3JlYXRlTXVsdGlwbGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHF1YW50aXR5IC0gVGhlIG51bWJlciBvZiBTcHJpdGVzIHRvIGNyZWF0ZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBHYW1lLmNhY2hlIGtleSBvZiB0aGUgaW1hZ2UgdGhhdCB0aGlzIFNwcml0ZSB3aWxsIHVzZS4KICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBbZnJhbWVdIC0gSWYgdGhlIFNwcml0ZSBpbWFnZSBjb250YWlucyBtdWx0aXBsZSBmcmFtZXMgeW91IGNhbiBzcGVjaWZ5IHdoaWNoIG9uZSB0byB1c2UgaGVyZS4KICAgICogQHBhcmFtIHtib29sZWFufSBbZXhpc3RzPWZhbHNlXSAtIFRoZSBkZWZhdWx0IGV4aXN0cyBzdGF0ZSBvZiB0aGUgU3ByaXRlLgogICAgKi8KICAgIGNyZWF0ZU11bHRpcGxlOiBmdW5jdGlvbiAocXVhbnRpdHksIGtleSwgZnJhbWUsIGV4aXN0cykgewoKICAgICAgICBpZiAodHlwZW9mIGV4aXN0cyA9PT0gJ3VuZGVmaW5lZCcpIHsgZXhpc3RzID0gZmFsc2U7IH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWFudGl0eTsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gbmV3IFBoYXNlci5TcHJpdGUodGhpcy5nYW1lLCAwLCAwLCBrZXksIGZyYW1lKTsKCiAgICAgICAgICAgIGNoaWxkLmdyb3VwID0gdGhpczsKICAgICAgICAgICAgY2hpbGQuZXhpc3RzID0gZXhpc3RzOwogICAgICAgICAgICBjaGlsZC52aXNpYmxlID0gZXhpc3RzOwogICAgICAgICAgICBjaGlsZC5hbGl2ZSA9IGV4aXN0czsKCiAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5hZGRDaGlsZChjaGlsZCk7CgogICAgICAgICAgICBjaGlsZC51cGRhdGVUcmFuc2Zvcm0oKTsKCiAgICAgICAgICAgIGlmIChjaGlsZC5ldmVudHMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoaWxkLmV2ZW50cy5vbkFkZGVkVG9Hcm91cC5kaXNwYXRjaChjaGlsZCwgdGhpcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnNvciA9PT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jdXJzb3IgPSBjaGlsZDsKICAgICAgICAgICAgfQoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQWR2YW5jZXMgdGhlIEdyb3VwIGN1cnNvciB0byB0aGUgbmV4dCBvYmplY3QgaW4gdGhlIEdyb3VwLiBJZiBpdCdzIGF0IHRoZSBlbmQgb2YgdGhlIEdyb3VwIGl0IHdyYXBzIGFyb3VuZCB0byB0aGUgZmlyc3Qgb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNuZXh0CiAgICAqLwogICAgbmV4dDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5jdXJzb3IpCiAgICAgICAgewogICAgICAgICAgICAvLyAgV3JhcCB0aGUgY3Vyc29yPwogICAgICAgICAgICBpZiAodGhpcy5jdXJzb3IgPT0gdGhpcy5fY29udGFpbmVyLmxhc3QpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3Vyc29yID0gdGhpcy5fY29udGFpbmVyLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3Vyc29yID0gdGhpcy5jdXJzb3IuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIE1vdmVzIHRoZSBHcm91cCBjdXJzb3IgdG8gdGhlIHByZXZpb3VzIG9iamVjdCBpbiB0aGUgR3JvdXAuIElmIGl0J3MgYXQgdGhlIHN0YXJ0IG9mIHRoZSBHcm91cCBpdCB3cmFwcyBhcm91bmQgdG8gdGhlIGxhc3Qgb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNwcmV2aW91cwogICAgKi8KICAgIHByZXZpb3VzOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmN1cnNvcikKICAgICAgICB7CiAgICAgICAgICAgIC8vICBXcmFwIHRoZSBjdXJzb3I/CiAgICAgICAgICAgIGlmICh0aGlzLmN1cnNvciA9PSB0aGlzLl9jb250YWluZXIuX2lOZXh0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnNvciA9IHRoaXMuX2NvbnRhaW5lci5sYXN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jdXJzb3IgPSB0aGlzLmN1cnNvci5faVByZXY7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgdGVzdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjY2hpbGRUZXN0CiAgICAqLwogICAgY2hpbGRUZXN0OiBmdW5jdGlvbiAocHJlZml4LCBjaGlsZCkgewoKICAgICAgICB2YXIgcyA9IHByZWZpeCArICcgbmV4dDogJzsKCiAgICAgICAgaWYgKGNoaWxkLl9pTmV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHMgPSBzICsgY2hpbGQuX2lOZXh0Lm5hbWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHMgPSBzICsgJy1udWxsLSc7CiAgICAgICAgfQoKICAgICAgICBzID0gcyArICcgJyArIHByZWZpeCArICcgcHJldjogJzsKCiAgICAgICAgaWYgKGNoaWxkLl9pUHJldikKICAgICAgICB7CiAgICAgICAgICAgIHMgPSBzICsgY2hpbGQuX2lQcmV2Lm5hbWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHMgPSBzICsgJy1udWxsLSc7CiAgICAgICAgfQoKICAgICAgICBjb25zb2xlLmxvZyhzKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCB0ZXN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNzd2FwSW5kZXgKICAgICovCiAgICBzd2FwSW5kZXg6IGZ1bmN0aW9uIChpbmRleDEsIGluZGV4MikgewoKICAgICAgICB2YXIgY2hpbGQxID0gdGhpcy5nZXRBdChpbmRleDEpOwogICAgICAgIHZhciBjaGlsZDIgPSB0aGlzLmdldEF0KGluZGV4Mik7CgogICAgICAgIHRoaXMuc3dhcChjaGlsZDEsIGNoaWxkMik7CgogICAgfSwKCiAgICAvKioKICAgICogU3dhcHMgdGhlIHBvc2l0aW9uIG9mIHR3byBjaGlsZHJlbiBpbiB0aGlzIEdyb3VwLiBCb3RoIGNoaWxkcmVuIG11c3QgYmUgaW4gdGhpcyBHcm91cC4KICAgICogWW91IGNhbm5vdCBzd2FwIGEgY2hpbGQgd2l0aCBpdHNlbGYsIG9yIHN3YXAgdW4tcGFyZW50ZWQgY2hpbGRyZW4sIGRvaW5nIHNvIHdpbGwgcmV0dXJuIGZhbHNlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNzd2FwCiAgICAqIEBwYXJhbSB7Kn0gY2hpbGQxIC0gVGhlIGZpcnN0IGNoaWxkIHRvIHN3YXAuCiAgICAqIEBwYXJhbSB7Kn0gY2hpbGQyIC0gVGhlIHNlY29uZCBjaGlsZCB0byBzd2FwLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBzd2FwIHdhcyBzdWNjZXNzZnVsLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgc3dhcDogZnVuY3Rpb24gKGNoaWxkMSwgY2hpbGQyKSB7CgogICAgICAgIGlmIChjaGlsZDEgPT09IGNoaWxkMiB8fCAhY2hpbGQxLnBhcmVudCB8fCAhY2hpbGQyLnBhcmVudCB8fCBjaGlsZDEuZ3JvdXAgIT09IHRoaXMgfHwgY2hpbGQyLmdyb3VwICE9PSB0aGlzKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgLy8gIENhY2hlIHRoZSB2YWx1ZXMKICAgICAgICB2YXIgY2hpbGQxUHJldiA9IGNoaWxkMS5faVByZXY7CiAgICAgICAgdmFyIGNoaWxkMU5leHQgPSBjaGlsZDEuX2lOZXh0OwogICAgICAgIHZhciBjaGlsZDJQcmV2ID0gY2hpbGQyLl9pUHJldjsKICAgICAgICB2YXIgY2hpbGQyTmV4dCA9IGNoaWxkMi5faU5leHQ7CgogICAgICAgIHZhciBlbmROb2RlID0gdGhpcy5fY29udGFpbmVyLmxhc3QuX2lOZXh0OwogICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2U7CiAgICAgICAgICAgIAogICAgICAgIGRvCiAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudE5vZGUgIT09IGNoaWxkMSAmJiBjdXJyZW50Tm9kZSAhPT0gY2hpbGQyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuZmlyc3QgPT09IGNoaWxkMSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5maXJzdCA9IGNoaWxkMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGN1cnJlbnROb2RlLmZpcnN0ID09PSBjaGlsZDIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuZmlyc3QgPSBjaGlsZDE7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmxhc3QgPT09IGNoaWxkMSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5sYXN0ID0gY2hpbGQyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoY3VycmVudE5vZGUubGFzdCA9PT0gY2hpbGQyKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmxhc3QgPSBjaGlsZDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgIH0KICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gZW5kTm9kZSkKCiAgICAgICAgaWYgKGNoaWxkMS5faU5leHQgPT0gY2hpbGQyKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFRoaXMgaXMgYSBkb3dud2FyZCAoQSB0byBCKSBuZWlnaGJvdXIgc3dhcAogICAgICAgICAgICBjaGlsZDEuX2lOZXh0ID0gY2hpbGQyTmV4dDsKICAgICAgICAgICAgY2hpbGQxLl9pUHJldiA9IGNoaWxkMjsKICAgICAgICAgICAgY2hpbGQyLl9pTmV4dCA9IGNoaWxkMTsKICAgICAgICAgICAgY2hpbGQyLl9pUHJldiA9IGNoaWxkMVByZXY7CgogICAgICAgICAgICBpZiAoY2hpbGQxUHJldikgeyBjaGlsZDFQcmV2Ll9pTmV4dCA9IGNoaWxkMjsgfQogICAgICAgICAgICBpZiAoY2hpbGQyTmV4dCkgeyBjaGlsZDJOZXh0Ll9pUHJldiA9IGNoaWxkMTsgfQoKICAgICAgICAgICAgaWYgKGNoaWxkMS5fX3JlbmRlckdyb3VwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGlsZDEuX19yZW5kZXJHcm91cC51cGRhdGVUZXh0dXJlKGNoaWxkMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjaGlsZDIuX19yZW5kZXJHcm91cCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hpbGQyLl9fcmVuZGVyR3JvdXAudXBkYXRlVGV4dHVyZShjaGlsZDIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoY2hpbGQyLl9pTmV4dCA9PSBjaGlsZDEpCiAgICAgICAgewogICAgICAgICAgICAvLyAgVGhpcyBpcyBhbiB1cHdhcmQgKEIgdG8gQSkgbmVpZ2hib3VyIHN3YXAKICAgICAgICAgICAgY2hpbGQxLl9pTmV4dCA9IGNoaWxkMjsKICAgICAgICAgICAgY2hpbGQxLl9pUHJldiA9IGNoaWxkMlByZXY7CiAgICAgICAgICAgIGNoaWxkMi5faU5leHQgPSBjaGlsZDFOZXh0OwogICAgICAgICAgICBjaGlsZDIuX2lQcmV2ID0gY2hpbGQxOwoKICAgICAgICAgICAgaWYgKGNoaWxkMlByZXYpIHsgY2hpbGQyUHJldi5faU5leHQgPSBjaGlsZDE7IH0KICAgICAgICAgICAgaWYgKGNoaWxkMU5leHQpIHsgY2hpbGQxTmV4dC5faVByZXYgPSBjaGlsZDI7IH0KCiAgICAgICAgICAgIGlmIChjaGlsZDEuX19yZW5kZXJHcm91cCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hpbGQxLl9fcmVuZGVyR3JvdXAudXBkYXRlVGV4dHVyZShjaGlsZDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY2hpbGQyLl9fcmVuZGVyR3JvdXApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoaWxkMi5fX3JlbmRlckdyb3VwLnVwZGF0ZVRleHR1cmUoY2hpbGQyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBDaGlsZHJlbiBhcmUgZmFyIGFwYXJ0CiAgICAgICAgICAgIGNoaWxkMS5faU5leHQgPSBjaGlsZDJOZXh0OwogICAgICAgICAgICBjaGlsZDEuX2lQcmV2ID0gY2hpbGQyUHJldjsKICAgICAgICAgICAgY2hpbGQyLl9pTmV4dCA9IGNoaWxkMU5leHQ7CiAgICAgICAgICAgIGNoaWxkMi5faVByZXYgPSBjaGlsZDFQcmV2OwoKICAgICAgICAgICAgaWYgKGNoaWxkMVByZXYpIHsgY2hpbGQxUHJldi5faU5leHQgPSBjaGlsZDI7IH0KICAgICAgICAgICAgaWYgKGNoaWxkMU5leHQpIHsgY2hpbGQxTmV4dC5faVByZXYgPSBjaGlsZDI7IH0KICAgICAgICAgICAgaWYgKGNoaWxkMlByZXYpIHsgY2hpbGQyUHJldi5faU5leHQgPSBjaGlsZDE7IH0KICAgICAgICAgICAgaWYgKGNoaWxkMk5leHQpIHsgY2hpbGQyTmV4dC5faVByZXYgPSBjaGlsZDE7IH0KCiAgICAgICAgICAgIGlmIChjaGlsZDEuX19yZW5kZXJHcm91cCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hpbGQxLl9fcmVuZGVyR3JvdXAudXBkYXRlVGV4dHVyZShjaGlsZDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY2hpbGQyLl9fcmVuZGVyR3JvdXApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoaWxkMi5fX3JlbmRlckdyb3VwLnVwZGF0ZVRleHR1cmUoY2hpbGQyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBCcmluZ3MgdGhlIGdpdmVuIGNoaWxkIHRvIHRoZSB0b3Agb2YgdGhpcyBHcm91cCBzbyBpdCByZW5kZXJzIGFib3ZlIGFsbCBvdGhlciBjaGlsZHJlbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjYnJpbmdUb1RvcAogICAgKiBAcGFyYW0geyp9IGNoaWxkIC0gVGhlIGNoaWxkIHRvIGJyaW5nIHRvIHRoZSB0b3Agb2YgdGhpcyBHcm91cC4KICAgICogQHJldHVybiB7Kn0gVGhlIGNoaWxkIHRoYXQgd2FzIG1vdmVkLgogICAgKi8KICAgIGJyaW5nVG9Ub3A6IGZ1bmN0aW9uIChjaGlsZCkgewoKICAgICAgICBpZiAoY2hpbGQuZ3JvdXAgPT09IHRoaXMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnJlbW92ZShjaGlsZCk7CiAgICAgICAgICAgIHRoaXMuYWRkKGNoaWxkKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBjaGlsZDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgdGhlIGluZGV4IHBvc2l0aW9uIG9mIHRoZSBnaXZlbiBjaGlsZCBpbiB0aGlzIEdyb3VwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNnZXRJbmRleAogICAgKiBAcGFyYW0geyp9IGNoaWxkIC0gVGhlIGNoaWxkIHRvIGdldCB0aGUgaW5kZXggZm9yLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBpbmRleCBvZiB0aGUgY2hpbGQgb3IgLTEgaWYgaXQncyBub3QgYSBtZW1iZXIgb2YgdGhpcyBHcm91cC4KICAgICovCiAgICBnZXRJbmRleDogZnVuY3Rpb24gKGNoaWxkKSB7CgogICAgICAgIHJldHVybiB0aGlzLl9jb250YWluZXIuY2hpbGRyZW4uaW5kZXhPZihjaGlsZCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVwbGFjZXMgYSBjaGlsZCBvZiB0aGlzIEdyb3VwIHdpdGggdGhlIGdpdmVuIG5ld0NoaWxkLiBUaGUgbmV3Q2hpbGQgY2Fubm90IGJlIGEgbWVtYmVyIG9mIHRoaXMgR3JvdXAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI3JlcGxhY2UKICAgICogQHBhcmFtIHsqfSBvbGRDaGlsZCAtIFRoZSBjaGlsZCBpbiB0aGlzIEdyb3VwIHRoYXQgd2lsbCBiZSByZXBsYWNlZC4KICAgICogQHBhcmFtIHsqfSBuZXdDaGlsZCAtIFRoZSBjaGlsZCB0byBiZSBpbnNlcnRlZCBpbnRvIHRoaXMgZ3JvdXAuCiAgICAqLwogICAgcmVwbGFjZTogZnVuY3Rpb24gKG9sZENoaWxkLCBuZXdDaGlsZCkgewoKICAgICAgICBpZiAoIXRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmdldEluZGV4KG9sZENoaWxkKTsKICAgICAgICAKICAgICAgICBpZiAoaW5kZXggIT0gLTEpCiAgICAgICAgewogICAgICAgICAgICBpZiAobmV3Q2hpbGQucGFyZW50ICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkLmV2ZW50cy5vblJlbW92ZWRGcm9tR3JvdXAuZGlzcGF0Y2gobmV3Q2hpbGQsIHRoaXMpOwogICAgICAgICAgICAgICAgbmV3Q2hpbGQucGFyZW50LnJlbW92ZUNoaWxkKG5ld0NoaWxkKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fY29udGFpbmVyLnJlbW92ZUNoaWxkKG9sZENoaWxkKTsKICAgICAgICAgICAgdGhpcy5fY29udGFpbmVyLmFkZENoaWxkQXQobmV3Q2hpbGQsIGluZGV4KTsKCiAgICAgICAgICAgIG5ld0NoaWxkLmV2ZW50cy5vbkFkZGVkVG9Hcm91cC5kaXNwYXRjaChuZXdDaGlsZCwgdGhpcyk7CiAgICAgICAgICAgIG5ld0NoaWxkLnVwZGF0ZVRyYW5zZm9ybSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY3Vyc29yID09IG9sZENoaWxkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnNvciA9IHRoaXMuX2NvbnRhaW5lci5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgZ2l2ZW4gcHJvcGVydHkgdG8gdGhlIGdpdmVuIHZhbHVlIG9uIHRoZSBjaGlsZC4gVGhlIG9wZXJhdGlvbiBjb250cm9scyB0aGUgYXNzaWdubWVudCBvZiB0aGUgdmFsdWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI3NldFByb3BlcnR5CiAgICAqIEBwYXJhbSB7Kn0gY2hpbGQgLSBUaGUgY2hpbGQgdG8gc2V0IHRoZSBwcm9wZXJ0eSB2YWx1ZSBvbi4KICAgICogQHBhcmFtIHthcnJheX0ga2V5IC0gQW4gYXJyYXkgb2Ygc3RyaW5ncyB0aGF0IG1ha2UgdXAgdGhlIHByb3BlcnR5IHRoYXQgd2lsbCBiZSBzZXQuCiAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgLSBUaGUgdmFsdWUgdGhhdCB3aWxsIGJlIHNldC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcGVyYXRpb249MF0gLSBDb250cm9scyBob3cgdGhlIHZhbHVlIGlzIGFzc2lnbmVkLiBBIHZhbHVlIG9mIDAgcmVwbGFjZXMgdGhlIHZhbHVlIHdpdGggdGhlIG5ldyBvbmUuIEEgdmFsdWUgb2YgMSBhZGRzIGl0LCAyIHN1YnRyYWN0cyBpdCwgMyBtdWx0aXBsaWVzIGl0IGFuZCA0IGRpdmlkZXMgaXQuCiAgICAqLwogICAgc2V0UHJvcGVydHk6IGZ1bmN0aW9uIChjaGlsZCwga2V5LCB2YWx1ZSwgb3BlcmF0aW9uKSB7CgogICAgICAgIG9wZXJhdGlvbiA9IG9wZXJhdGlvbiB8fCAwOwoKICAgICAgICAvLyAgQXMgdWdseSBhcyB0aGlzIGFwcHJvYWNoIGxvb2tzLCBhbmQgYWx0aG91Z2ggaXQncyBsaW1pdGVkIHRvIGEgZGVwdGggb2Ygb25seSA0LCBpdCdzIGV4dHJlbWVseSBmYXN0LgogICAgICAgIC8vICBNdWNoIGZhc3RlciB0aGFuIGEgZm9yIGxvb3Agb3Igb2JqZWN0IGl0ZXJhdGlvbi4gVGhlcmUgYXJlIG5vIGNoZWNrcywgc28gaWYgdGhlIGtleSBpc24ndCB2YWxpZCB0aGVuIGl0J2xsIGZhaWwKICAgICAgICAvLyAgYnV0IGFzIHlvdSBhcmUgbGlrZWx5IHRvIGNhbGwgdGhpcyBmcm9tIGlubmVyIGxvb3BzIHRoYXQgaGF2ZSB0byBwZXJmb3JtIHdlbGwsIEknbGwgdGFrZSB0aGF0IHRyYWRlIG9mZi4KCiAgICAgICAgLy8gIDAgPSBFcXVhbHMKICAgICAgICAvLyAgMSA9IEFkZAogICAgICAgIC8vICAyID0gU3VidHJhY3QKICAgICAgICAvLyAgMyA9IE11bHRpcGx5CiAgICAgICAgLy8gIDQgPSBEaXZpZGUKCiAgICAgICAgdmFyIGxlbiA9IGtleS5sZW5ndGg7CgogICAgICAgIGlmIChsZW4gPT0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChvcGVyYXRpb24gPT09IDApIHsgY2hpbGRba2V5WzBdXSA9IHZhbHVlOyB9CiAgICAgICAgICAgIGVsc2UgaWYgKG9wZXJhdGlvbiA9PSAxKSB7IGNoaWxkW2tleVswXV0gKz0gdmFsdWU7IH0KICAgICAgICAgICAgZWxzZSBpZiAob3BlcmF0aW9uID09IDIpIHsgY2hpbGRba2V5WzBdXSAtPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gMykgeyBjaGlsZFtrZXlbMF1dICo9IHZhbHVlOyB9CiAgICAgICAgICAgIGVsc2UgaWYgKG9wZXJhdGlvbiA9PSA0KSB7IGNoaWxkW2tleVswXV0gLz0gdmFsdWU7IH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAobGVuID09IDIpCiAgICAgICAgewogICAgICAgICAgICBpZiAob3BlcmF0aW9uID09PSAwKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXSA9IHZhbHVlOyB9CiAgICAgICAgICAgIGVsc2UgaWYgKG9wZXJhdGlvbiA9PSAxKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXSArPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gMikgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV0gLT0gdmFsdWU7IH0KICAgICAgICAgICAgZWxzZSBpZiAob3BlcmF0aW9uID09IDMpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dICo9IHZhbHVlOyB9CiAgICAgICAgICAgIGVsc2UgaWYgKG9wZXJhdGlvbiA9PSA0KSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXSAvPSB2YWx1ZTsgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChsZW4gPT0gMykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChvcGVyYXRpb24gPT09IDApIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dW2tleVsyXV0gPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gMSkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXSArPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gMikgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXSAtPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gMykgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXSAqPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gNCkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXSAvPSB2YWx1ZTsgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChsZW4gPT0gNCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChvcGVyYXRpb24gPT09IDApIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dW2tleVsyXV1ba2V5WzNdXSA9IHZhbHVlOyB9CiAgICAgICAgICAgIGVsc2UgaWYgKG9wZXJhdGlvbiA9PSAxKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXVtrZXlbMl1dW2tleVszXV0gKz0gdmFsdWU7IH0KICAgICAgICAgICAgZWxzZSBpZiAob3BlcmF0aW9uID09IDIpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dW2tleVsyXV1ba2V5WzNdXSAtPSB2YWx1ZTsgfQogICAgICAgICAgICBlbHNlIGlmIChvcGVyYXRpb24gPT0gMykgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXVtrZXlbM11dICo9IHZhbHVlOyB9CiAgICAgICAgICAgIGVsc2UgaWYgKG9wZXJhdGlvbiA9PSA0KSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXVtrZXlbMl1dW2tleVszXV0gLz0gdmFsdWU7IH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gIFRPRE8gLSBEZWVwIHByb3BlcnR5IHNjYW5lCgogICAgfSwKCiAgICAvKioKICAgICogVGhpcyBmdW5jdGlvbiBhbGxvd3MgeW91IHRvIHF1aWNrbHkgc2V0IGEgcHJvcGVydHkgb24gYSBzaW5nbGUgY2hpbGQgb2YgdGhpcyBHcm91cCB0byBhIG5ldyB2YWx1ZS4KICAgICogVGhlIG9wZXJhdGlvbiBwYXJhbWV0ZXIgY29udHJvbHMgaG93IHRoZSBuZXcgdmFsdWUgaXMgYXNzaWduZWQgdG8gdGhlIHByb3BlcnR5LCBmcm9tIHNpbXBsZSByZXBsYWNlbWVudCB0byBhZGRpdGlvbiBhbmQgbXVsdGlwbGljYXRpb24uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI3NldAogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IGNoaWxkIC0gVGhlIGNoaWxkIHRvIHNldCB0aGUgcHJvcGVydHkgb24uCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgcHJvcGVydHksIGFzIGEgc3RyaW5nLCB0byBiZSBzZXQuIEZvciBleGFtcGxlOiAnYm9keS52ZWxvY2l0eS54JwogICAgKiBAcGFyYW0geyp9IHZhbHVlIC0gVGhlIHZhbHVlIHRoYXQgd2lsbCBiZSBzZXQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2NoZWNrQWxpdmU9ZmFsc2VdIC0gSWYgc2V0IHRoZW4gdGhlIGNoaWxkIHdpbGwgb25seSBiZSB1cGRhdGVkIGlmIGFsaXZlPXRydWUuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2NoZWNrVmlzaWJsZT1mYWxzZV0gLSBJZiBzZXQgdGhlbiB0aGUgY2hpbGQgd2lsbCBvbmx5IGJlIHVwZGF0ZWQgaWYgdmlzaWJsZT10cnVlLgogICAgKiBAcGFyYW0ge251bWJlcn0gW29wZXJhdGlvbj0wXSAtIENvbnRyb2xzIGhvdyB0aGUgdmFsdWUgaXMgYXNzaWduZWQuIEEgdmFsdWUgb2YgMCByZXBsYWNlcyB0aGUgdmFsdWUgd2l0aCB0aGUgbmV3IG9uZS4gQSB2YWx1ZSBvZiAxIGFkZHMgaXQsIDIgc3VidHJhY3RzIGl0LCAzIG11bHRpcGxpZXMgaXQgYW5kIDQgZGl2aWRlcyBpdC4KICAgICovCiAgICBzZXQ6IGZ1bmN0aW9uIChjaGlsZCwga2V5LCB2YWx1ZSwgY2hlY2tBbGl2ZSwgY2hlY2tWaXNpYmxlLCBvcGVyYXRpb24pIHsKCiAgICAgICAga2V5ID0ga2V5LnNwbGl0KCcuJyk7CgogICAgICAgIGlmICh0eXBlb2YgY2hlY2tBbGl2ZSA9PT0gJ3VuZGVmaW5lZCcpIHsgY2hlY2tBbGl2ZSA9IGZhbHNlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBjaGVja1Zpc2libGUgPT09ICd1bmRlZmluZWQnKSB7IGNoZWNrVmlzaWJsZSA9IGZhbHNlOyB9CgogICAgICAgIGlmICgoY2hlY2tBbGl2ZSA9PT0gZmFsc2UgfHwgKGNoZWNrQWxpdmUgJiYgY2hpbGQuYWxpdmUpKSAmJiAoY2hlY2tWaXNpYmxlID09PSBmYWxzZSB8fCAoY2hlY2tWaXNpYmxlICYmIGNoaWxkLnZpc2libGUpKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc2V0UHJvcGVydHkoY2hpbGQsIGtleSwgdmFsdWUsIG9wZXJhdGlvbik7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoaXMgZnVuY3Rpb24gYWxsb3dzIHlvdSB0byBxdWlja2x5IHNldCB0aGUgc2FtZSBwcm9wZXJ0eSBhY3Jvc3MgYWxsIGNoaWxkcmVuIG9mIHRoaXMgR3JvdXAgdG8gYSBuZXcgdmFsdWUuCiAgICAqIFRoZSBvcGVyYXRpb24gcGFyYW1ldGVyIGNvbnRyb2xzIGhvdyB0aGUgbmV3IHZhbHVlIGlzIGFzc2lnbmVkIHRvIHRoZSBwcm9wZXJ0eSwgZnJvbSBzaW1wbGUgcmVwbGFjZW1lbnQgdG8gYWRkaXRpb24gYW5kIG11bHRpcGxpY2F0aW9uLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNzZXRBbGwKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBwcm9wZXJ0eSwgYXMgYSBzdHJpbmcsIHRvIGJlIHNldC4gRm9yIGV4YW1wbGU6ICdib2R5LnZlbG9jaXR5LngnCiAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgLSBUaGUgdmFsdWUgdGhhdCB3aWxsIGJlIHNldC4KICAgICogQHBhcmFtIHtib29sZWFufSBbY2hlY2tBbGl2ZT1mYWxzZV0gLSBJZiBzZXQgdGhlbiBvbmx5IGNoaWxkcmVuIHdpdGggYWxpdmU9dHJ1ZSB3aWxsIGJlIHVwZGF0ZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2NoZWNrVmlzaWJsZT1mYWxzZV0gLSBJZiBzZXQgdGhlbiBvbmx5IGNoaWxkcmVuIHdpdGggdmlzaWJsZT10cnVlIHdpbGwgYmUgdXBkYXRlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcGVyYXRpb249MF0gLSBDb250cm9scyBob3cgdGhlIHZhbHVlIGlzIGFzc2lnbmVkLiBBIHZhbHVlIG9mIDAgcmVwbGFjZXMgdGhlIHZhbHVlIHdpdGggdGhlIG5ldyBvbmUuIEEgdmFsdWUgb2YgMSBhZGRzIGl0LCAyIHN1YnRyYWN0cyBpdCwgMyBtdWx0aXBsaWVzIGl0IGFuZCA0IGRpdmlkZXMgaXQuCiAgICAqLwogICAgc2V0QWxsOiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgY2hlY2tBbGl2ZSwgY2hlY2tWaXNpYmxlLCBvcGVyYXRpb24pIHsKCiAgICAgICAga2V5ID0ga2V5LnNwbGl0KCcuJyk7CgogICAgICAgIGlmICh0eXBlb2YgY2hlY2tBbGl2ZSA9PT0gJ3VuZGVmaW5lZCcpIHsgY2hlY2tBbGl2ZSA9IGZhbHNlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBjaGVja1Zpc2libGUgPT09ICd1bmRlZmluZWQnKSB7IGNoZWNrVmlzaWJsZSA9IGZhbHNlOyB9CgogICAgICAgIG9wZXJhdGlvbiA9IG9wZXJhdGlvbiB8fCAwOwoKICAgICAgICBpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCA+IDAgJiYgdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKChjaGVja0FsaXZlID09PSBmYWxzZSB8fCAoY2hlY2tBbGl2ZSAmJiBjdXJyZW50Tm9kZS5hbGl2ZSkpICYmIChjaGVja1Zpc2libGUgPT09IGZhbHNlIHx8IChjaGVja1Zpc2libGUgJiYgY3VycmVudE5vZGUudmlzaWJsZSkpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0UHJvcGVydHkoY3VycmVudE5vZGUsIGtleSwgdmFsdWUsIG9wZXJhdGlvbik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnROb2RlICE9IHRoaXMuX2NvbnRhaW5lci5sYXN0Ll9pTmV4dCkKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyB0aGUgYW1vdW50IHRvIHRoZSBnaXZlbiBwcm9wZXJ0eSBvbiBhbGwgY2hpbGRyZW4gaW4gdGhpcyBHcm91cC4KICAgICogR3JvdXAuYWRkQWxsKCd4JywgMTApIHdpbGwgYWRkIDEwIHRvIHRoZSBjaGlsZC54IHZhbHVlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNhZGRBbGwKICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3BlcnR5IC0gVGhlIHByb3BlcnR5IHRvIGluY3JlbWVudCwgZm9yIGV4YW1wbGUgJ2JvZHkudmVsb2NpdHkueCcgb3IgJ2FuZ2xlJy4KICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gaW5jcmVtZW50IHRoZSBwcm9wZXJ0eSBieS4gSWYgY2hpbGQueCA9IDEwIHRoZW4gYWRkQWxsKCd4JywgNDApIHdvdWxkIG1ha2UgY2hpbGQueCA9IDUwLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoZWNrQWxpdmUgLSBJZiB0cnVlIHRoZSBwcm9wZXJ0eSB3aWxsIG9ubHkgYmUgY2hhbmdlZCBpZiB0aGUgY2hpbGQgaXMgYWxpdmUuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tWaXNpYmxlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIHZpc2libGUuCiAgICAqLwogICAgYWRkQWxsOiBmdW5jdGlvbiAocHJvcGVydHksIGFtb3VudCwgY2hlY2tBbGl2ZSwgY2hlY2tWaXNpYmxlKSB7CgogICAgICAgIHRoaXMuc2V0QWxsKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSwgMSk7CgogICAgfSwKCiAgICAvKioKICAgICogU3VidHJhY3RzIHRoZSBhbW91bnQgZnJvbSB0aGUgZ2l2ZW4gcHJvcGVydHkgb24gYWxsIGNoaWxkcmVuIGluIHRoaXMgR3JvdXAuCiAgICAqIEdyb3VwLnN1YkFsbCgneCcsIDEwKSB3aWxsIG1pbnVzIDEwIGZyb20gdGhlIGNoaWxkLnggdmFsdWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI3N1YkFsbAogICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcGVydHkgLSBUaGUgcHJvcGVydHkgdG8gZGVjcmVtZW50LCBmb3IgZXhhbXBsZSAnYm9keS52ZWxvY2l0eS54JyBvciAnYW5nbGUnLgogICAgKiBAcGFyYW0ge251bWJlcn0gYW1vdW50IC0gVGhlIGFtb3VudCB0byBzdWJ0cmFjdCBmcm9tIHRoZSBwcm9wZXJ0eS4gSWYgY2hpbGQueCA9IDUwIHRoZW4gc3ViQWxsKCd4JywgNDApIHdvdWxkIG1ha2UgY2hpbGQueCA9IDEwLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoZWNrQWxpdmUgLSBJZiB0cnVlIHRoZSBwcm9wZXJ0eSB3aWxsIG9ubHkgYmUgY2hhbmdlZCBpZiB0aGUgY2hpbGQgaXMgYWxpdmUuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tWaXNpYmxlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIHZpc2libGUuCiAgICAqLwogICAgc3ViQWxsOiBmdW5jdGlvbiAocHJvcGVydHksIGFtb3VudCwgY2hlY2tBbGl2ZSwgY2hlY2tWaXNpYmxlKSB7CgogICAgICAgIHRoaXMuc2V0QWxsKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSwgMik7CgogICAgfSwKCiAgICAvKioKICAgICogTXVsdGlwbGllcyB0aGUgZ2l2ZW4gcHJvcGVydHkgYnkgdGhlIGFtb3VudCBvbiBhbGwgY2hpbGRyZW4gaW4gdGhpcyBHcm91cC4KICAgICogR3JvdXAubXVsdGlwbHlBbGwoJ3gnLCAyKSB3aWxsIHgyIHRoZSBjaGlsZC54IHZhbHVlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNtdWx0aXBseUFsbAogICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcGVydHkgLSBUaGUgcHJvcGVydHkgdG8gbXVsdGlwbHksIGZvciBleGFtcGxlICdib2R5LnZlbG9jaXR5LngnIG9yICdhbmdsZScuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgLSBUaGUgYW1vdW50IHRvIG11bHRpcGx5IHRoZSBwcm9wZXJ0eSBieS4gSWYgY2hpbGQueCA9IDEwIHRoZW4gbXVsdGlwbHlBbGwoJ3gnLCAyKSB3b3VsZCBtYWtlIGNoaWxkLnggPSAyMC4KICAgICogQHBhcmFtIHtib29sZWFufSBjaGVja0FsaXZlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIGFsaXZlLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoZWNrVmlzaWJsZSAtIElmIHRydWUgdGhlIHByb3BlcnR5IHdpbGwgb25seSBiZSBjaGFuZ2VkIGlmIHRoZSBjaGlsZCBpcyB2aXNpYmxlLgogICAgKi8KICAgIG11bHRpcGx5QWxsOiBmdW5jdGlvbiAocHJvcGVydHksIGFtb3VudCwgY2hlY2tBbGl2ZSwgY2hlY2tWaXNpYmxlKSB7CgogICAgICAgIHRoaXMuc2V0QWxsKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSwgMyk7CgogICAgfSwKCiAgICAvKioKICAgICogRGl2aWRlcyB0aGUgZ2l2ZW4gcHJvcGVydHkgYnkgdGhlIGFtb3VudCBvbiBhbGwgY2hpbGRyZW4gaW4gdGhpcyBHcm91cC4KICAgICogR3JvdXAuZGl2aWRlQWxsKCd4JywgMikgd2lsbCBoYWxmIHRoZSBjaGlsZC54IHZhbHVlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNkaXZpZGVBbGwKICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3BlcnR5IC0gVGhlIHByb3BlcnR5IHRvIGRpdmlkZSwgZm9yIGV4YW1wbGUgJ2JvZHkudmVsb2NpdHkueCcgb3IgJ2FuZ2xlJy4KICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gZGl2aWRlIHRoZSBwcm9wZXJ0eSBieS4gSWYgY2hpbGQueCA9IDEwMCB0aGVuIGRpdmlkZUFsbCgneCcsIDIpIHdvdWxkIG1ha2UgY2hpbGQueCA9IDUwLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoZWNrQWxpdmUgLSBJZiB0cnVlIHRoZSBwcm9wZXJ0eSB3aWxsIG9ubHkgYmUgY2hhbmdlZCBpZiB0aGUgY2hpbGQgaXMgYWxpdmUuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tWaXNpYmxlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIHZpc2libGUuCiAgICAqLwogICAgZGl2aWRlQWxsOiBmdW5jdGlvbiAocHJvcGVydHksIGFtb3VudCwgY2hlY2tBbGl2ZSwgY2hlY2tWaXNpYmxlKSB7CgogICAgICAgIHRoaXMuc2V0QWxsKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSwgNCk7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbHMgYSBmdW5jdGlvbiBvbiBhbGwgb2YgdGhlIGNoaWxkcmVuIHRoYXQgaGF2ZSBleGlzdHM9dHJ1ZSBpbiB0aGlzIEdyb3VwLgogICAgKiBBZnRlciB0aGUgZXhpc3RzVmFsdWUgcGFyYW1ldGVyIHlvdSBjYW4gYWRkIGFzIG1hbnkgcGFyYW1ldGVycyBhcyB5b3UgbGlrZSwgd2hpY2ggd2lsbCBhbGwgYmUgcGFzc2VkIHRvIHRoZSBjaGlsZCBjYWxsYmFjay4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NhbGxBbGxFeGlzdHMKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgZnVuY3Rpb24gdGhhdCBleGlzdHMgb24gdGhlIGNoaWxkcmVuIHRoYXQgd2lsbCBiZSBjYWxsZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZXhpc3RzVmFsdWUgLSBPbmx5IGNoaWxkcmVuIHdpdGggZXhpc3RzPWV4aXN0c1ZhbHVlIHdpbGwgYmUgY2FsbGVkLgogICAgKiBAcGFyYW0gey4uLip9IHBhcmFtZXRlciAtIEFkZGl0aW9uYWwgcGFyYW1ldGVycyB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjay4KICAgICovCiAgICBjYWxsQWxsRXhpc3RzOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGV4aXN0c1ZhbHVlKSB7CgogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgogICAgICAgIGlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID4gMCAmJiB0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBkbwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuZXhpc3RzID09IGV4aXN0c1ZhbHVlICYmIGN1cnJlbnROb2RlW2NhbGxiYWNrXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZVtjYWxsYmFja10uYXBwbHkoY3VycmVudE5vZGUsIGFyZ3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSAhPSB0aGlzLl9jb250YWluZXIubGFzdC5faU5leHQpCgogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIGEgZnVuY3Rpb24gdGhhdCBleGlzdHMgb24gYSBjaGlsZCBvZiB0aGUgR3JvdXAgYmFzZWQgb24gdGhlIGdpdmVuIGNhbGxiYWNrIGFycmF5LgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjY2FsbGJhY2tGcm9tQXJyYXkKICAgICogQHBhcmFtIHtvYmplY3R9IGNoaWxkIC0gVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgKiBAcGFyYW0ge2FycmF5fSBjYWxsYmFjayAtIFRoZSBhcnJheSBvZiBmdW5jdGlvbiBuYW1lcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IGxlbmd0aCAtIFRoZSBzaXplIG9mIHRoZSBhcnJheSAocHJlLWNhbGN1bGF0ZWQgaW4gY2FsbEFsbCkuCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBjYWxsYmFja0Zyb21BcnJheTogZnVuY3Rpb24gKGNoaWxkLCBjYWxsYmFjaywgbGVuZ3RoKSB7CgogICAgICAgIC8vICBLaW5kYSBsb29rcyBsaWtlIGEgQ2hyaXN0bWFzIHRyZWUKCiAgICAgICAgaWYgKGxlbmd0aCA9PSAxKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGNoaWxkW2NhbGxiYWNrWzBdXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkW2NhbGxiYWNrWzBdXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChsZW5ndGggPT0gMikKICAgICAgICB7CiAgICAgICAgICAgIGlmIChjaGlsZFtjYWxsYmFja1swXV1bY2FsbGJhY2tbMV1dKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGRbY2FsbGJhY2tbMF1dW2NhbGxiYWNrWzFdXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChsZW5ndGggPT0gMykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChjaGlsZFtjYWxsYmFja1swXV1bY2FsbGJhY2tbMV1dW2NhbGxiYWNrWzJdXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkW2NhbGxiYWNrWzBdXVtjYWxsYmFja1sxXV1bY2FsbGJhY2tbMl1dOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGxlbmd0aCA9PSA0KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGNoaWxkW2NhbGxiYWNrWzBdXVtjYWxsYmFja1sxXV1bY2FsbGJhY2tbMl1dW2NhbGxiYWNrWzNdXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkW2NhbGxiYWNrWzBdXVtjYWxsYmFja1sxXV1bY2FsbGJhY2tbMl1dW2NhbGxiYWNrWzNdXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoY2hpbGRbY2FsbGJhY2tdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGRbY2FsbGJhY2tdOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbHMgYSBmdW5jdGlvbiBvbiBhbGwgb2YgdGhlIGNoaWxkcmVuIHJlZ2FyZGxlc3MgaWYgdGhleSBhcmUgZGVhZCBvciBhbGl2ZSAoc2VlIGNhbGxBbGxFeGlzdHMgaWYgeW91IG5lZWQgY29udHJvbCBvdmVyIHRoYXQpCiAgICAqIEFmdGVyIHRoZSBtZXRob2QgcGFyYW1ldGVyIGFuZCBjb250ZXh0IHlvdSBjYW4gYWRkIGFzIG1hbnkgZXh0cmEgcGFyYW1ldGVycyBhcyB5b3UgbGlrZSwgd2hpY2ggd2lsbCBhbGwgYmUgcGFzc2VkIHRvIHRoZSBjaGlsZC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NhbGxBbGwKICAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZCAtIEEgc3RyaW5nIGNvbnRhaW5pbmcgdGhlIG5hbWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQuIFRoZSBmdW5jdGlvbiBtdXN0IGV4aXN0IG9uIHRoZSBjaGlsZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb250ZXh0PW51bGxdIC0gQSBzdHJpbmcgY29udGFpbmluZyB0aGUgY29udGV4dCB1bmRlciB3aGljaCB0aGUgbWV0aG9kIHdpbGwgYmUgZXhlY3V0ZWQuIFNldCB0byBudWxsIHRvIGRlZmF1bHQgdG8gdGhlIGNoaWxkLgogICAgKiBAcGFyYW0gey4uLip9IHBhcmFtZXRlciAtIEFkZGl0aW9uYWwgcGFyYW1ldGVycyB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBtZXRob2QuCiAgICAqLwogICAgY2FsbEFsbDogZnVuY3Rpb24gKG1ldGhvZCwgY29udGV4dCkgewoKICAgICAgICBpZiAodHlwZW9mIG1ldGhvZCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyAgRXh0cmFjdCB0aGUgbWV0aG9kIGludG8gYW4gYXJyYXkKICAgICAgICBtZXRob2QgPSBtZXRob2Quc3BsaXQoJy4nKTsKCiAgICAgICAgdmFyIG1ldGhvZExlbmd0aCA9IG1ldGhvZC5sZW5ndGg7CgogICAgICAgIGlmICh0eXBlb2YgY29udGV4dCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICBjb250ZXh0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIEV4dHJhY3QgdGhlIGNvbnRleHQgaW50byBhbiBhcnJheQogICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQgPT09ICdzdHJpbmcnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5zcGxpdCgnLicpOwogICAgICAgICAgICAgICAgdmFyIGNvbnRleHRMZW5ndGggPSBjb250ZXh0Lmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgICB2YXIgY2FsbGJhY2sgPSBudWxsOwogICAgICAgIHZhciBjYWxsYmFja0NvbnRleHQgPSBudWxsOwoKICAgICAgICBpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCA+IDAgJiYgdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSB0aGlzLmNhbGxiYWNrRnJvbUFycmF5KGNoaWxkLCBtZXRob2QsIG1ldGhvZExlbmd0aCk7CgogICAgICAgICAgICAgICAgaWYgKGNvbnRleHQgJiYgY2FsbGJhY2spCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tDb250ZXh0ID0gdGhpcy5jYWxsYmFja0Zyb21BcnJheShjaGlsZCwgY29udGV4dCwgY29udGV4dExlbmd0aCk7CiAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShjYWxsYmFja0NvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGNhbGxiYWNrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KGNoaWxkLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT0gdGhpcy5fY29udGFpbmVyLmxhc3QuX2lOZXh0KQoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQWxsb3dzIHlvdSB0byBjYWxsIHlvdXIgb3duIGZ1bmN0aW9uIG9uIGVhY2ggbWVtYmVyIG9mIHRoaXMgR3JvdXAuIFlvdSBtdXN0IHBhc3MgdGhlIGNhbGxiYWNrIGFuZCBjb250ZXh0IGluIHdoaWNoIGl0IHdpbGwgcnVuLgogICAgKiBBZnRlciB0aGUgY2hlY2tFeGlzdHMgcGFyYW1ldGVyIHlvdSBjYW4gYWRkIGFzIG1hbnkgcGFyYW1ldGVycyBhcyB5b3UgbGlrZSwgd2hpY2ggd2lsbCBhbGwgYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjayBhbG9uZyB3aXRoIHRoZSBjaGlsZC4KICAgICogRm9yIGV4YW1wbGU6IEdyb3VwLmZvckVhY2goYXdhcmRCb251c0dvbGQsIHRoaXMsIHRydWUsIDEwMCwgNTAwKQogICAgKiBOb3RlOiBDdXJyZW50bHkgdGhpcyB3aWxsIHNraXAgYW55IGNoaWxkcmVuIHdoaWNoIGFyZSBHcm91cHMgdGhlbXNlbHZlcy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2ZvckVhY2gKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZC4gRWFjaCBjaGlsZCBvZiB0aGUgR3JvdXAgd2lsbCBiZSBwYXNzZWQgdG8gaXQgYXMgaXRzIGZpcnN0IHBhcmFtZXRlci4KICAgICogQHBhcmFtIHtPYmplY3R9IGNhbGxiYWNrQ29udGV4dCAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRoZSBmdW5jdGlvbiBzaG91bGQgYmUgY2FsbGVkICh1c3VhbGx5ICd0aGlzJykuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tFeGlzdHMgLSBJZiBzZXQgb25seSBjaGlsZHJlbiB3aXRoIGV4aXN0cz10cnVlIHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjaywgb3RoZXJ3aXNlIGFsbCBjaGlsZHJlbiB3aWxsIGJlIHBhc3NlZC4KICAgICovCiAgICBmb3JFYWNoOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgY2hlY2tFeGlzdHMpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBjaGVja0V4aXN0cyA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICBjaGVja0V4aXN0cyA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLCAzKTsKICAgICAgICBhcmdzLnVuc2hpZnQobnVsbCk7CgogICAgICAgIGlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID4gMCAmJiB0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBkbwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY2hlY2tFeGlzdHMgPT09IGZhbHNlIHx8IChjaGVja0V4aXN0cyAmJiBjdXJyZW50Tm9kZS5leGlzdHMpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGFyZ3NbMF0gPSBjdXJyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShjYWxsYmFja0NvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSAhPSB0aGlzLl9jb250YWluZXIubGFzdC5faU5leHQpOwoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQWxsb3dzIHlvdSB0byBjYWxsIHlvdXIgb3duIGZ1bmN0aW9uIG9uIGVhY2ggYWxpdmUgbWVtYmVyIG9mIHRoaXMgR3JvdXAgKHdoZXJlIGNoaWxkLmFsaXZlPXRydWUpLiBZb3UgbXVzdCBwYXNzIHRoZSBjYWxsYmFjayBhbmQgY29udGV4dCBpbiB3aGljaCBpdCB3aWxsIHJ1bi4KICAgICogWW91IGNhbiBhZGQgYXMgbWFueSBwYXJhbWV0ZXJzIGFzIHlvdSBsaWtlLCB3aGljaCB3aWxsIGFsbCBiZSBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrIGFsb25nIHdpdGggdGhlIGNoaWxkLgogICAgKiBGb3IgZXhhbXBsZTogR3JvdXAuZm9yRWFjaEFsaXZlKGNhdXNlRGFtYWdlLCB0aGlzLCA1MDApCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNmb3JFYWNoQWxpdmUKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZC4gRWFjaCBjaGlsZCBvZiB0aGUgR3JvdXAgd2lsbCBiZSBwYXNzZWQgdG8gaXQgYXMgaXRzIGZpcnN0IHBhcmFtZXRlci4KICAgICogQHBhcmFtIHtPYmplY3R9IGNhbGxiYWNrQ29udGV4dCAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRoZSBmdW5jdGlvbiBzaG91bGQgYmUgY2FsbGVkICh1c3VhbGx5ICd0aGlzJykuCiAgICAqLwogICAgZm9yRWFjaEV4aXN0czogZnVuY3Rpb24gKGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgICBhcmdzLnVuc2hpZnQobnVsbCk7CgogICAgICAgIHRoaXMuaXRlcmF0ZSgnZXhpc3RzJywgdHJ1ZSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgYXJncyk7CgogICAgfSwKCiAgICAvKioKICAgICogQWxsb3dzIHlvdSB0byBjYWxsIHlvdXIgb3duIGZ1bmN0aW9uIG9uIGVhY2ggYWxpdmUgbWVtYmVyIG9mIHRoaXMgR3JvdXAgKHdoZXJlIGNoaWxkLmFsaXZlPXRydWUpLiBZb3UgbXVzdCBwYXNzIHRoZSBjYWxsYmFjayBhbmQgY29udGV4dCBpbiB3aGljaCBpdCB3aWxsIHJ1bi4KICAgICogWW91IGNhbiBhZGQgYXMgbWFueSBwYXJhbWV0ZXJzIGFzIHlvdSBsaWtlLCB3aGljaCB3aWxsIGFsbCBiZSBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrIGFsb25nIHdpdGggdGhlIGNoaWxkLgogICAgKiBGb3IgZXhhbXBsZTogR3JvdXAuZm9yRWFjaEFsaXZlKGNhdXNlRGFtYWdlLCB0aGlzLCA1MDApCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNmb3JFYWNoQWxpdmUKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZC4gRWFjaCBjaGlsZCBvZiB0aGUgR3JvdXAgd2lsbCBiZSBwYXNzZWQgdG8gaXQgYXMgaXRzIGZpcnN0IHBhcmFtZXRlci4KICAgICogQHBhcmFtIHtPYmplY3R9IGNhbGxiYWNrQ29udGV4dCAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRoZSBmdW5jdGlvbiBzaG91bGQgYmUgY2FsbGVkICh1c3VhbGx5ICd0aGlzJykuCiAgICAqLwogICAgZm9yRWFjaEFsaXZlOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgICAgIGFyZ3MudW5zaGlmdChudWxsKTsKCiAgICAgICAgdGhpcy5pdGVyYXRlKCdhbGl2ZScsIHRydWUsIFBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwsIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIGFyZ3MpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFsbG93cyB5b3UgdG8gY2FsbCB5b3VyIG93biBmdW5jdGlvbiBvbiBlYWNoIGRlYWQgbWVtYmVyIG9mIHRoaXMgR3JvdXAgKHdoZXJlIGFsaXZlPWZhbHNlKS4gWW91IG11c3QgcGFzcyB0aGUgY2FsbGJhY2sgYW5kIGNvbnRleHQgaW4gd2hpY2ggaXQgd2lsbCBydW4uCiAgICAqIFlvdSBjYW4gYWRkIGFzIG1hbnkgcGFyYW1ldGVycyBhcyB5b3UgbGlrZSwgd2hpY2ggd2lsbCBhbGwgYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjayBhbG9uZyB3aXRoIHRoZSBjaGlsZC4KICAgICogRm9yIGV4YW1wbGU6IEdyb3VwLmZvckVhY2hEZWFkKGJyaW5nVG9MaWZlLCB0aGlzKQogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZm9yRWFjaERlYWQKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZC4gRWFjaCBjaGlsZCBvZiB0aGUgR3JvdXAgd2lsbCBiZSBwYXNzZWQgdG8gaXQgYXMgaXRzIGZpcnN0IHBhcmFtZXRlci4KICAgICogQHBhcmFtIHtPYmplY3R9IGNhbGxiYWNrQ29udGV4dCAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRoZSBmdW5jdGlvbiBzaG91bGQgYmUgY2FsbGVkICh1c3VhbGx5ICd0aGlzJykuCiAgICAqLwogICAgZm9yRWFjaERlYWQ6IGZ1bmN0aW9uIChjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgICAgYXJncy51bnNoaWZ0KG51bGwpOwoKICAgICAgICB0aGlzLml0ZXJhdGUoJ2FsaXZlJywgZmFsc2UsIFBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwsIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIGFyZ3MpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGwgdGhpcyBmdW5jdGlvbiB0byBzb3J0IHRoZSBncm91cCBhY2NvcmRpbmcgdG8gYSBwYXJ0aWN1bGFyIHZhbHVlIGFuZCBvcmRlci4KICAgICogRm9yIGV4YW1wbGUgdG8gZGVwdGggc29ydCBTcHJpdGVzIGZvciBaZWxkYS1zdHlsZSBnYW1lIHlvdSBtaWdodCBjYWxsIGBncm91cC5zb3J0KCd5JywgUGhhc2VyLkdyb3VwLlNPUlRfQVNDRU5ESU5HKWAgYXQgdGhlIGJvdHRvbSBvZiB5b3VyIGBTdGF0ZS51cGRhdGUoKWAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI3NvcnQKICAgICogQHBhcmFtIHtzdHJpbmd9IFtpbmRleD0neSddIC0gVGhlIGBzdHJpbmdgIG5hbWUgb2YgdGhlIHByb3BlcnR5IHlvdSB3YW50IHRvIHNvcnQgb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb3JkZXI9UGhhc2VyLkdyb3VwLlNPUlRfQVNDRU5ESU5HXSAtIFRoZSBgR3JvdXBgIGNvbnN0YW50IHRoYXQgZGVmaW5lcyB0aGUgc29ydCBvcmRlci4gUG9zc2libGUgdmFsdWVzIGFyZSBQaGFzZXIuR3JvdXAuU09SVF9BU0NFTkRJTkcgYW5kIFBoYXNlci5Hcm91cC5TT1JUX0RFU0NFTkRJTkcuCiAgICAqLwogICAgc29ydDogZnVuY3Rpb24gKGluZGV4LCBvcmRlcikgewoKICAgICAgICBpZiAodHlwZW9mIGluZGV4ID09PSAndW5kZWZpbmVkJykgeyBpbmRleCA9ICd5JzsgfQogICAgICAgIGlmICh0eXBlb2Ygb3JkZXIgPT09ICd1bmRlZmluZWQnKSB7IG9yZGVyID0gUGhhc2VyLkdyb3VwLlNPUlRfQVNDRU5ESU5HOyB9CgogICAgICAgIHZhciBzd2FwcGVkOwogICAgICAgIHZhciB0ZW1wOwoKICAgICAgICBkbyB7CgogICAgICAgICAgICBzd2FwcGVkID0gZmFsc2U7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCAtIDE7IGkgPCBsZW47IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG9yZGVyID09IFBoYXNlci5Hcm91cC5TT1JUX0FTQ0VORElORykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2ldW2luZGV4XSA+IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpICsgMV1baW5kZXhdKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zd2FwKHRoaXMuZ2V0QXQoaSksIHRoaXMuZ2V0QXQoaSArIDEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcCA9IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2ldID0gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2kgKyAxXTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2kgKyAxXSA9IHRlbXA7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3YXBwZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2ldW2luZGV4XSA8IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpICsgMV1baW5kZXhdKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zd2FwKHRoaXMuZ2V0QXQoaSksIHRoaXMuZ2V0QXQoaSArIDEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcCA9IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2ldID0gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2kgKyAxXTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2kgKyAxXSA9IHRlbXA7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3YXBwZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gd2hpbGUgKHN3YXBwZWQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEl0ZXJhdGVzIG92ZXIgdGhlIGNoaWxkcmVuIG9mIHRoZSBHcm91cC4gV2hlbiBhIGNoaWxkIGhhcyBhIHByb3BlcnR5IG1hdGNoaW5nIGtleSB0aGF0IGVxdWFscyB0aGUgZ2l2ZW4gdmFsdWUsIGl0IGlzIGNvbnNpZGVyZWQgYXMgYSBtYXRjaC4KICAgICogTWF0Y2hlZCBjaGlsZHJlbiBjYW4gYmUgc2VudCB0byB0aGUgb3B0aW9uYWwgY2FsbGJhY2ssIG9yIHNpbXBseSByZXR1cm5lZCBvciBjb3VudGVkLgogICAgKiBZb3UgY2FuIGFkZCBhcyBtYW55IGNhbGxiYWNrIHBhcmFtZXRlcnMgYXMgeW91IGxpa2UsIHdoaWNoIHdpbGwgYWxsIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2sgYWxvbmcgd2l0aCB0aGUgY2hpbGQsIGFmdGVyIHRoZSBjYWxsYmFja0NvbnRleHQgcGFyYW1ldGVyLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjaXRlcmF0ZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIGNoaWxkIHByb3BlcnR5IHRvIGNoZWNrLCBpLmUuICdleGlzdHMnLCAnYWxpdmUnLCAnaGVhbHRoJwogICAgKiBAcGFyYW0ge2FueX0gdmFsdWUgLSBJZiBjaGlsZC5rZXkgPT09IHRoaXMgdmFsdWUgaXQgd2lsbCBiZSBjb25zaWRlcmVkIGEgbWF0Y2guIE5vdGUgdGhhdCBhIHN0cmljdCBjb21wYXJpc29uIGlzIHVzZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByZXR1cm5UeXBlIC0gSG93IHRvIHJldHVybiB0aGUgZGF0YSBmcm9tIHRoaXMgbWV0aG9kLiBFaXRoZXIgUGhhc2VyLkdyb3VwLlJFVFVSTl9OT05FLCBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMIG9yIFBoYXNlci5Hcm91cC5SRVRVUk5fQ0hJTEQuCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtjYWxsYmFjaz1udWxsXSAtIE9wdGlvbmFsIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgb24gZWFjaCBtYXRjaGluZyBjaGlsZC4gRWFjaCBjaGlsZCBvZiB0aGUgR3JvdXAgd2lsbCBiZSBwYXNzZWQgdG8gaXQgYXMgaXRzIGZpcnN0IHBhcmFtZXRlci4KICAgICogQHBhcmFtIHtPYmplY3R9IFtjYWxsYmFja0NvbnRleHRdIC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIHNob3VsZCBiZSBjYWxsZWQgKHVzdWFsbHkgJ3RoaXMnKS4KICAgICogQHJldHVybiB7YW55fSBSZXR1cm5zIGVpdGhlciBhIG51bWVyaWMgdG90YWwgKGlmIFJFVFVSTl9UT1RBTCB3YXMgc3BlY2lmaWVkKSBvciB0aGUgY2hpbGQgb2JqZWN0LgogICAgKi8KICAgIGl0ZXJhdGU6IGZ1bmN0aW9uIChrZXksIHZhbHVlLCByZXR1cm5UeXBlLCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBhcmdzKSB7CgogICAgICAgIGlmIChyZXR1cm5UeXBlID09PSBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMICYmIHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgY2FsbGJhY2sgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciB0b3RhbCA9IDA7CgogICAgICAgIGlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID4gMCAmJiB0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBkbwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGVba2V5XSA9PT0gdmFsdWUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdG90YWwrKzsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJnc1swXSA9IGN1cnJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShjYWxsYmFja0NvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHJldHVyblR5cGUgPT09IFBoYXNlci5Hcm91cC5SRVRVUk5fQ0hJTEQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSAhPSB0aGlzLl9jb250YWluZXIubGFzdC5faU5leHQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHJldHVyblR5cGUgPT09IFBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdG90YWw7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHJldHVyblR5cGUgPT09IFBoYXNlci5Hcm91cC5SRVRVUk5fQ0hJTEQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIHJldHJpZXZlIHRoZSBmaXJzdCBvYmplY3Qgd2l0aCBleGlzdHMgPT0gKHRoZSBnaXZlbiBzdGF0ZSkgaW4gdGhlIEdyb3VwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNnZXRGaXJzdEV4aXN0cwogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHN0YXRlIC0gVHJ1ZSBvciBmYWxzZS4KICAgICogQHJldHVybiB7QW55fSBUaGUgZmlyc3QgY2hpbGQsIG9yIG51bGwgaWYgbm9uZSBmb3VuZC4KICAgICovCiAgICBnZXRGaXJzdEV4aXN0czogZnVuY3Rpb24gKHN0YXRlKSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3RhdGUgIT09ICdib29sZWFuJykKICAgICAgICB7CiAgICAgICAgICAgIHN0YXRlID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLml0ZXJhdGUoJ2V4aXN0cycsIHN0YXRlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX0NISUxEKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gcmV0cmlldmUgdGhlIGZpcnN0IG9iamVjdCB3aXRoIGFsaXZlID09PSB0cnVlIGluIHRoZSBncm91cC4KICAgICogVGhpcyBpcyBoYW5keSBmb3IgY2hlY2tpbmcgaWYgZXZlcnl0aGluZyBoYXMgYmVlbiB3aXBlZCBvdXQsIG9yIGNob29zaW5nIGEgc3F1YWQgbGVhZGVyLCBldGMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2dldEZpcnN0QWxpdmUKICAgICogQHJldHVybiB7QW55fSBUaGUgZmlyc3QgYWxpdmUgY2hpbGQsIG9yIG51bGwgaWYgbm9uZSBmb3VuZC4KICAgICovCiAgICBnZXRGaXJzdEFsaXZlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiB0aGlzLml0ZXJhdGUoJ2FsaXZlJywgdHJ1ZSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9DSElMRCk7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIHJldHJpZXZlIHRoZSBmaXJzdCBvYmplY3Qgd2l0aCBhbGl2ZSA9PT0gZmFsc2UgaW4gdGhlIGdyb3VwLgogICAgKiBUaGlzIGlzIGhhbmR5IGZvciBjaGVja2luZyBpZiBldmVyeXRoaW5nIGhhcyBiZWVuIHdpcGVkIG91dCwgb3IgY2hvb3NpbmcgYSBzcXVhZCBsZWFkZXIsIGV0Yy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZ2V0Rmlyc3REZWFkCiAgICAqIEByZXR1cm4ge0FueX0gVGhlIGZpcnN0IGRlYWQgY2hpbGQsIG9yIG51bGwgaWYgbm9uZSBmb3VuZC4KICAgICovCiAgICBnZXRGaXJzdERlYWQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuaXRlcmF0ZSgnYWxpdmUnLCBmYWxzZSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9DSElMRCk7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIGZpbmQgb3V0IGhvdyBtYW55IG1lbWJlcnMgb2YgdGhlIGdyb3VwIGFyZSBhbGl2ZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjY291bnRMaXZpbmcKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbnVtYmVyIG9mIGNoaWxkcmVuIGZsYWdnZWQgYXMgYWxpdmUuCiAgICAqLwogICAgY291bnRMaXZpbmc6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuaXRlcmF0ZSgnYWxpdmUnLCB0cnVlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gZmluZCBvdXQgaG93IG1hbnkgbWVtYmVycyBvZiB0aGUgZ3JvdXAgYXJlIGRlYWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NvdW50RGVhZAogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBudW1iZXIgb2YgY2hpbGRyZW4gZmxhZ2dlZCBhcyBkZWFkLgogICAgKi8KICAgIGNvdW50RGVhZDogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4gdGhpcy5pdGVyYXRlKCdhbGl2ZScsIGZhbHNlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgbWVtYmVyIGF0IHJhbmRvbSBmcm9tIHRoZSBncm91cC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZ2V0UmFuZG9tCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydEluZGV4IC0gT3B0aW9uYWwgb2Zmc2V0IG9mZiB0aGUgZnJvbnQgb2YgdGhlIGFycmF5LiBEZWZhdWx0IHZhbHVlIGlzIDAsIG9yIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5LgogICAgKiBAcGFyYW0ge251bWJlcn0gbGVuZ3RoIC0gT3B0aW9uYWwgcmVzdHJpY3Rpb24gb24gdGhlIG51bWJlciBvZiB2YWx1ZXMgeW91IHdhbnQgdG8gcmFuZG9tbHkgc2VsZWN0IGZyb20uCiAgICAqIEByZXR1cm4ge0FueX0gQSByYW5kb20gY2hpbGQgb2YgdGhpcyBHcm91cC4KICAgICovCiAgICBnZXRSYW5kb206IGZ1bmN0aW9uIChzdGFydEluZGV4LCBsZW5ndGgpIHsKCiAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHN0YXJ0SW5kZXggPSBzdGFydEluZGV4IHx8IDA7CiAgICAgICAgbGVuZ3RoID0gbGVuZ3RoIHx8IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGg7CgogICAgICAgIHJldHVybiB0aGlzLmdhbWUubWF0aC5nZXRSYW5kb20odGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLCBzdGFydEluZGV4LCBsZW5ndGgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgdGhlIGdpdmVuIGNoaWxkIGZyb20gdGhpcyBHcm91cCBhbmQgc2V0cyBpdHMgZ3JvdXAgcHJvcGVydHkgdG8gbnVsbC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjcmVtb3ZlCiAgICAqIEBwYXJhbSB7QW55fSBjaGlsZCAtIFRoZSBjaGlsZCB0byByZW1vdmUuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWYgdGhlIGNoaWxkIHdhcyByZW1vdmVkIGZyb20gdGhpcyBHcm91cCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIHJlbW92ZTogZnVuY3Rpb24gKGNoaWxkKSB7CgogICAgICAgIGlmIChjaGlsZC5ncm91cCAhPT0gdGhpcykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmIChjaGlsZC5ldmVudHMpCiAgICAgICAgewogICAgICAgICAgICBjaGlsZC5ldmVudHMub25SZW1vdmVkRnJvbUdyb3VwLmRpc3BhdGNoKGNoaWxkLCB0aGlzKTsKICAgICAgICB9CgogICAgICAgIC8vICBDaGVjayBpdCdzIGFjdHVhbGx5IGluIHRoZSBjb250YWluZXIKICAgICAgICBpZiAoY2hpbGQucGFyZW50ID09PSB0aGlzLl9jb250YWluZXIpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9jb250YWluZXIucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY3Vyc29yID09IGNoaWxkKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5faU5leHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3Vyc29yID0gdGhpcy5fY29udGFpbmVyLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3Vyc29yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2hpbGQuZ3JvdXAgPSBudWxsOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGFsbCBjaGlsZHJlbiBmcm9tIHRoaXMgR3JvdXAsIHNldHRpbmcgYWxsIGdyb3VwIHByb3BlcnRpZXMgdG8gbnVsbC4KICAgICogVGhlIEdyb3VwIGNvbnRhaW5lciByZW1haW5zIG9uIHRoZSBkaXNwbGF5IGxpc3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI3JlbW92ZUFsbAogICAgKi8KICAgIHJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGRvCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuWzBdLmV2ZW50cykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuWzBdLmV2ZW50cy5vblJlbW92ZWRGcm9tR3JvdXAuZGlzcGF0Y2godGhpcy5fY29udGFpbmVyLmNoaWxkcmVuWzBdLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9jb250YWluZXIucmVtb3ZlQ2hpbGQodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuWzBdKTsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPiAwKTsKCiAgICAgICAgdGhpcy5jdXJzb3IgPSBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgYWxsIGNoaWxkcmVuIGZyb20gdGhpcyBHcm91cCB3aG9zIGluZGV4IGZhbGxzIGJldGVlbiB0aGUgZ2l2ZW4gc3RhcnRJbmRleCBhbmQgZW5kSW5kZXggdmFsdWVzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNyZW1vdmVCZXR3ZWVuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydEluZGV4IC0gVGhlIGluZGV4IHRvIHN0YXJ0IHJlbW92aW5nIGNoaWxkcmVuIGZyb20uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBlbmRJbmRleCAtIFRoZSBpbmRleCB0byBzdG9wIHJlbW92aW5nIGNoaWxkcmVuIGZyb20uIE11c3QgYmUgaGlnaGVyIHRoYW4gc3RhcnRJbmRleCBhbmQgbGVzcyB0aGFuIHRoZSBsZW5ndGggb2YgdGhlIEdyb3VwLgogICAgKi8KICAgIHJlbW92ZUJldHdlZW46IGZ1bmN0aW9uIChzdGFydEluZGV4LCBlbmRJbmRleCkgewoKICAgICAgICBpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChzdGFydEluZGV4ID4gZW5kSW5kZXggfHwgc3RhcnRJbmRleCA8IDAgfHwgZW5kSW5kZXggPiB0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0SW5kZXg7IGkgPCBlbmRJbmRleDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2ldOwogICAgICAgICAgICBjaGlsZC5ldmVudHMub25SZW1vdmVkRnJvbUdyb3VwLmRpc3BhdGNoKGNoaWxkLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5fY29udGFpbmVyLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgIAogICAgICAgICAgICBpZiAodGhpcy5jdXJzb3IgPT0gY2hpbGQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9jb250YWluZXIuX2lOZXh0KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY3Vyc29yID0gdGhpcy5fY29udGFpbmVyLl9pTmV4dDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnNvciA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogRGVzdHJveXMgdGhpcyBHcm91cC4gUmVtb3ZlcyBhbGwgY2hpbGRyZW4sIHRoZW4gcmVtb3ZlcyB0aGUgY29udGFpbmVyIGZyb20gdGhlIGRpc3BsYXkgbGlzdCBhbmQgbnVsbHMgcmVmZXJlbmNlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZGVzdHJveQogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtkZXN0cm95Q2hpbGRyZW49ZmFsc2VdIC0gU2hvdWxkIGV2ZXJ5IGNoaWxkIG9mIHRoaXMgR3JvdXAgaGF2ZSBpdHMgZGVzdHJveSBtZXRob2QgY2FsbGVkPwogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIChkZXN0cm95Q2hpbGRyZW4pIHsKCiAgICAgICAgaWYgKHR5cGVvZiBkZXN0cm95Q2hpbGRyZW4gPT09ICd1bmRlZmluZWQnKSB7IGRlc3Ryb3lDaGlsZHJlbiA9IGZhbHNlOyB9CgogICAgICAgIGlmIChkZXN0cm95Q2hpbGRyZW4pCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCA+IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGRvCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlblswXS5ncm91cCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlblswXS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPiAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnJlbW92ZUFsbCgpOwogICAgICAgIH0KICAgIAogICAgICAgIHRoaXMuX2NvbnRhaW5lci5wYXJlbnQucmVtb3ZlQ2hpbGQodGhpcy5fY29udGFpbmVyKTsKCiAgICAgICAgdGhpcy5fY29udGFpbmVyID0gbnVsbDsKCiAgICAgICAgdGhpcy5nYW1lID0gbnVsbDsKCiAgICAgICAgdGhpcy5leGlzdHMgPSBmYWxzZTsKCiAgICAgICAgdGhpcy5jdXJzb3IgPSBudWxsOwoKICAgIH0sCgogICAgdmFsaWRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIHRlc3RPYmplY3QgPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmxhc3QuX2lOZXh0OwogICAgICAgIHZhciBkaXNwbGF5T2JqZWN0ID0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZTsKICAgICAgICB2YXIgbmV4dE9iamVjdCA9IG51bGw7CiAgICAgICAgdmFyIHByZXZPYmplY3QgPSBudWxsOwogICAgICAgIHZhciBjb3VudCA9IDA7CgogICAgICAgIGRvCiAgICAgICAgewogICAgICAgICAgICBpZiAoY291bnQgPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgY2hlY2sgbmV4dAogICAgICAgICAgICAgICAgaWYgKGRpc3BsYXlPYmplY3QgIT09IG5leHRPYmplY3QpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2NoZWNrIG5leHQgZmFpbCcpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAgY2hlY2sgcHJldmlvdXMKICAgICAgICAgICAgICAgIGlmIChkaXNwbGF5T2JqZWN0Ll9pUHJldiAhPT0gcHJldk9iamVjdCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY2hlY2sgcHJldmlvdXMgZmFpbCcpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIFNldCB0aGUgbmV4dCBvYmplY3QKICAgICAgICAgICAgbmV4dE9iamVjdCA9IGRpc3BsYXlPYmplY3QuX2lOZXh0OwogICAgICAgICAgICBwcmV2T2JqZWN0ID0gZGlzcGxheU9iamVjdDsKCiAgICAgICAgICAgIGRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKCiAgICAgICAgICAgIGNvdW50Kys7CgogICAgICAgIH0KICAgICAgICB3aGlsZShkaXNwbGF5T2JqZWN0ICE9IHRlc3RPYmplY3QpCgogICAgICAgIHJldHVybiB0cnVlOwoKICAgIH0KCn07CgpQaGFzZXIuR3JvdXAucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkdyb3VwOwoKLyoqCiogQG5hbWUgUGhhc2VyLkdyb3VwI3RvdGFsCiogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsIC0gVGhlIHRvdGFsIG51bWJlciBvZiBjaGlsZHJlbiBpbiB0aGlzIEdyb3VwIHdobyBoYXZlIGEgc3RhdGUgb2YgZXhpc3RzID0gdHJ1ZS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJ0b3RhbCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLml0ZXJhdGUoJ2V4aXN0cycsIHRydWUsIFBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuR3JvdXAjbGVuZ3RoCiogQHByb3BlcnR5IHtudW1iZXJ9IGxlbmd0aCAtIFRoZSB0b3RhbCBudW1iZXIgb2YgY2hpbGRyZW4gaW4gdGhpcyBHcm91cCwgcmVnYXJkbGVzcyBvZiB0aGVpciBleGlzdHMvYWxpdmUgc3RhdHVzLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyb3VwLnByb3RvdHlwZSwgImxlbmd0aCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBHcm91cCBjb250YWluZXIuIFlvdSBjYW4gYWRqdXN0IHRoZSBHcm91cCBjb250YWluZXIgaXRzZWxmIGJ5IG1vZGlmeWluZyBpdHMgY29vcmRpbmF0ZXMuCiogVGhpcyB3aWxsIGhhdmUgbm8gaW1wYWN0IG9uIHRoZSB4L3kgY29vcmRpbmF0ZXMgb2YgaXRzIGNoaWxkcmVuLCBidXQgaXQgd2lsbCB1cGRhdGUgdGhlaXIgd29ybGRUcmFuc2Zvcm0gYW5kIG9uLXNjcmVlbiBwb3NpdGlvbi4KKiBAbmFtZSBQaGFzZXIuR3JvdXAjeAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgR3JvdXAgY29udGFpbmVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyb3VwLnByb3RvdHlwZSwgIngiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnRhaW5lci5wb3NpdGlvbi54OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci5wb3NpdGlvbi54ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIEdyb3VwIGNvbnRhaW5lci4gWW91IGNhbiBhZGp1c3QgdGhlIEdyb3VwIGNvbnRhaW5lciBpdHNlbGYgYnkgbW9kaWZ5aW5nIGl0cyBjb29yZGluYXRlcy4KKiBUaGlzIHdpbGwgaGF2ZSBubyBpbXBhY3Qgb24gdGhlIHgveSBjb29yZGluYXRlcyBvZiBpdHMgY2hpbGRyZW4sIGJ1dCBpdCB3aWxsIHVwZGF0ZSB0aGVpciB3b3JsZFRyYW5zZm9ybSBhbmQgb24tc2NyZWVuIHBvc2l0aW9uLgoqIEBuYW1lIFBoYXNlci5Hcm91cCN5CiogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBHcm91cCBjb250YWluZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JvdXAucHJvdG90eXBlLCAieSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLnBvc2l0aW9uLnk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLnBvc2l0aW9uLnkgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIGFuZ2xlIG9mIHJvdGF0aW9uIG9mIHRoZSBHcm91cCBjb250YWluZXIuIFRoaXMgd2lsbCBhZGp1c3QgdGhlIEdyb3VwIGNvbnRhaW5lciBpdHNlbGYgYnkgbW9kaWZ5aW5nIGl0cyByb3RhdGlvbi4KKiBUaGlzIHdpbGwgaGF2ZSBubyBpbXBhY3Qgb24gdGhlIHJvdGF0aW9uIHZhbHVlIG9mIGl0cyBjaGlsZHJlbiwgYnV0IGl0IHdpbGwgdXBkYXRlIHRoZWlyIHdvcmxkVHJhbnNmb3JtIGFuZCBvbi1zY3JlZW4gcG9zaXRpb24uCiogQG5hbWUgUGhhc2VyLkdyb3VwI2FuZ2xlCiogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIG9mIHJvdGF0aW9uIGdpdmVuIGluIGRlZ3JlZXMsIHdoZXJlIDAgZGVncmVlcyA9IHRvIHRoZSByaWdodC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJhbmdsZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBQaGFzZXIuTWF0aC5yYWRUb0RlZyh0aGlzLl9jb250YWluZXIucm90YXRpb24pOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLnJvdGF0aW9uID0gUGhhc2VyLk1hdGguZGVnVG9SYWQodmFsdWUpOwogICAgfQoKfSk7CgovKioKKiBUaGUgYW5nbGUgb2Ygcm90YXRpb24gb2YgdGhlIEdyb3VwIGNvbnRhaW5lci4gVGhpcyB3aWxsIGFkanVzdCB0aGUgR3JvdXAgY29udGFpbmVyIGl0c2VsZiBieSBtb2RpZnlpbmcgaXRzIHJvdGF0aW9uLgoqIFRoaXMgd2lsbCBoYXZlIG5vIGltcGFjdCBvbiB0aGUgcm90YXRpb24gdmFsdWUgb2YgaXRzIGNoaWxkcmVuLCBidXQgaXQgd2lsbCB1cGRhdGUgdGhlaXIgd29ybGRUcmFuc2Zvcm0gYW5kIG9uLXNjcmVlbiBwb3NpdGlvbi4KKiBAbmFtZSBQaGFzZXIuR3JvdXAjcm90YXRpb24KKiBAcHJvcGVydHkge251bWJlcn0gcm90YXRpb24gLSBUaGUgYW5nbGUgb2Ygcm90YXRpb24gZ2l2ZW4gaW4gcmFkaWFucy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJyb3RhdGlvbiIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLnJvdGF0aW9uOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci5yb3RhdGlvbiA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuR3JvdXAjdmlzaWJsZQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmlzaWJsZSAtIFRoZSB2aXNpYmxlIHN0YXRlIG9mIHRoZSBHcm91cC4gTm9uLXZpc2libGUgR3JvdXBzIGFuZCBhbGwgb2YgdGhlaXIgY2hpbGRyZW4gYXJlIG5vdCByZW5kZXJlZC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJ2aXNpYmxlIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jb250YWluZXIudmlzaWJsZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLl9jb250YWluZXIudmlzaWJsZSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuR3JvdXAjYWxwaGEKKiBAcHJvcGVydHkge251bWJlcn0gYWxwaGEgLSBUaGUgYWxwaGEgdmFsdWUgb2YgdGhlIEdyb3VwIGNvbnRhaW5lci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJhbHBoYSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLmFscGhhOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci5hbHBoYSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiAiVGhpcyB3b3JsZCBpcyBidXQgYSBjYW52YXMgdG8gb3VyIGltYWdpbmF0aW9uLiIgLSBIZW5yeSBEYXZpZCBUaG9yZWF1CioKKiBBIGdhbWUgaGFzIG9ubHkgb25lIHdvcmxkLiBUaGUgd29ybGQgaXMgYW4gYWJzdHJhY3QgcGxhY2UgaW4gd2hpY2ggYWxsIGdhbWUgb2JqZWN0cyBsaXZlLiBJdCBpcyBub3QgYm91bmQKKiBieSBzdGFnZSBsaW1pdHMgYW5kIGNhbiBiZSBhbnkgc2l6ZS4gWW91IGxvb2sgaW50byB0aGUgd29ybGQgdmlhIGNhbWVyYXMuIEFsbCBnYW1lIG9iamVjdHMgbGl2ZSB3aXRoaW4KKiB0aGUgd29ybGQgYXQgd29ybGQtYmFzZWQgY29vcmRpbmF0ZXMuIEJ5IGRlZmF1bHQgYSB3b3JsZCBpcyBjcmVhdGVkIHRoZSBzYW1lIHNpemUgYXMgeW91ciBTdGFnZS4KKgoqIEBjbGFzcyBQaGFzZXIuV29ybGQKKiBAZXh0ZW5kcyBQaGFzZXIuR3JvdXAKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gUmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50IGdhbWUgaW5zdGFuY2UuCiovClBoYXNlci5Xb3JsZCA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgUGhhc2VyLkdyb3VwLmNhbGwodGhpcywgZ2FtZSwgbnVsbCwgJ19fd29ybGQnLCBmYWxzZSk7CgogICAgLyoqCiAgICAqIFRoZSBXb3JsZCBoYXMgbm8gZml4ZWQgc2l6ZSwgYnV0IGl0IGRvZXMgaGF2ZSBhIGJvdW5kcyBvdXRzaWRlIG9mIHdoaWNoIG9iamVjdHMgYXJlIG5vIGxvbmdlciBjb25zaWRlcmVkIGFzIGJlaW5nICJpbiB3b3JsZCIgYW5kIHlvdSBzaG91bGQgdXNlIHRoaXMgdG8gY2xlYW4tdXAgdGhlIGRpc3BsYXkgbGlzdCBhbmQgcHVyZ2UgZGVhZCBvYmplY3RzLgogICAgKiBCeSBkZWZhdWx0IHdlIHNldCB0aGUgQm91bmRzIHRvIGJlIGZyb20gMCwwIHRvIEdhbWUud2lkdGgsR2FtZS5oZWlnaHQuIEkuZS4gaXQgd2lsbCBtYXRjaCB0aGUgc2l6ZSBnaXZlbiB0byB0aGUgZ2FtZSBjb25zdHJ1Y3RvciB3aXRoIDAsMCByZXByZXNlbnRpbmcgdGhlIHRvcC1sZWZ0IG9mIHRoZSBkaXNwbGF5LgogICAgKiBIb3dldmVyIDAsMCBpcyBhY3R1YWxseSB0aGUgY2VudGVyIG9mIHRoZSB3b3JsZCwgYW5kIGlmIHlvdSByb3RhdGUgb3Igc2NhbGUgdGhlIHdvcmxkIGFsbCBvZiB0aGF0IHdpbGwgaGFwcGVuIGZyb20gMCwwLgogICAgKiBTbyBpZiB5b3Ugd2FudCB0byBtYWtlIGEgZ2FtZSBpbiB3aGljaCB0aGUgd29ybGQgaXRzZWxmIHdpbGwgcm90YXRlIHlvdSBzaG91bGQgYWRqdXN0IHRoZSBib3VuZHMgc28gdGhhdCAwLDAgaXMgdGhlIGNlbnRlciBwb2ludCwgaS5lLiBzZXQgdGhlbSB0byAtMTAwMCwtMTAwMCwyMDAwLDIwMDAgZm9yIGEgMjAwMHgyMDAwIHNpemVkIHdvcmxkIGNlbnRlcmVkIGFyb3VuZCAwLDAuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gYm91bmRzIC0gQm91bmQgb2YgdGhpcyB3b3JsZCB0aGF0IG9iamVjdHMgY2FuIG5vdCBlc2NhcGUgZnJvbS4KICAgICovCiAgICB0aGlzLmJvdW5kcyA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKDAsIDAsIGdhbWUud2lkdGgsIGdhbWUuaGVpZ2h0KTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuQ2FtZXJhfSBjYW1lcmEgLSBDYW1lcmEgaW5zdGFuY2UuCiAgICAqLwogICAgdGhpcy5jYW1lcmEgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY3VycmVudFJlbmRlck9yZGVySUQgLSBSZXNldCBlYWNoIGZyYW1lLCBrZWVwcyBhIGNvdW50IG9mIHRoZSB0b3RhbCBudW1iZXIgb2Ygb2JqZWN0cyB1cGRhdGVkLgogICAgKi8KICAgIHRoaXMuY3VycmVudFJlbmRlck9yZGVySUQgPSAwOwogICAgCn07CgpQaGFzZXIuV29ybGQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQaGFzZXIuR3JvdXAucHJvdG90eXBlKTsKUGhhc2VyLldvcmxkLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5Xb3JsZDsKCi8qKgoqIEluaXRpYWxpc2VzIHRoZSBnYW1lIHdvcmxkLgoqCiogQG1ldGhvZCBQaGFzZXIuV29ybGQjYm9vdAoqIEBwcm90ZWN0ZWQKKi8KUGhhc2VyLldvcmxkLnByb3RvdHlwZS5ib290ID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuY2FtZXJhID0gbmV3IFBoYXNlci5DYW1lcmEodGhpcy5nYW1lLCAwLCAwLCAwLCB0aGlzLmdhbWUud2lkdGgsIHRoaXMuZ2FtZS5oZWlnaHQpOwoKICAgIHRoaXMuY2FtZXJhLmRpc3BsYXlPYmplY3QgPSB0aGlzLl9jb250YWluZXI7CgogICAgdGhpcy5nYW1lLmNhbWVyYSA9IHRoaXMuY2FtZXJhOwoKfQoKLyoqCiogVGhpcyBpcyBjYWxsZWQgYXV0b21hdGljYWxseSBhZnRlciB0aGUgcGx1Z2lucyBwcmVVcGRhdGUgYW5kIGJlZm9yZSB0aGUgU3RhdGUudXBkYXRlLgoqIE1vc3Qgb2JqZWN0cyBoYXZlIHByZVVwZGF0ZSBtZXRob2RzIGFuZCBpdCdzIHdoZXJlIGluaXRpYWwgbW92ZW1lbnQsIGRyYXdpbmcgYW5kIGNhbGN1bGF0aW9ucyBhcmUgZG9uZS4KKiAKKiBAbWV0aG9kIFBoYXNlci5Xb3JsZCN1cGRhdGUKKi8KUGhhc2VyLldvcmxkLnByb3RvdHlwZS5wcmVVcGRhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAKICAgIGlmICh0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmZpcnN0Ll9pTmV4dCkKICAgIHsKICAgICAgICB2YXIgY3VycmVudE5vZGUgPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmZpcnN0Ll9pTmV4dDsKICAgICAgICAKICAgICAgICBkbwogICAgICAgIHsKICAgICAgICAgICAgLy8gSWYgcHJlVXBkYXRlIGV4aXN0cywgYW5kIGl0IHJldHVybnMgZmFsc2UsIHNraXAgUElYSSBjaGlsZCBvYmplY3RzCiAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZVsncHJlVXBkYXRlJ10gJiYgIWN1cnJlbnROb2RlLnByZVVwZGF0ZSgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLmxhc3QuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgfQogICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSAhPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmxhc3QuX2lOZXh0KQogICAgfQoKfQoKLyoqCiogVGhpcyBpcyBjYWxsZWQgYXV0b21hdGljYWxseSBhZnRlciB0aGUgU3RhdGUudXBkYXRlLCBidXQgYmVmb3JlIHBhcnRpY2xlcyBvciBwbHVnaW5zIHVwZGF0ZS4KKiBNb3N0IG9iamVjdHMgd29uJ3QgaGF2ZSBhbiB1cGRhdGUgbWV0aG9kIHNldCB1bmxlc3MgZXhwbGljaXRseSBnaXZlbiBvbmUuCiogCiogQG1ldGhvZCBQaGFzZXIuV29ybGQjdXBkYXRlCiovClBoYXNlci5Xb3JsZC5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuY3VycmVudFJlbmRlck9yZGVySUQgPSAwOwogICAgCiAgICBpZiAodGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5maXJzdC5faU5leHQpCiAgICB7CiAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5maXJzdC5faU5leHQ7CiAgICAgICAgCiAgICAgICAgZG8KICAgICAgICB7CiAgICAgICAgICAgIC8vIElmIHVwZGF0ZSBleGlzdHMsIGFuZCBpdCByZXR1cm5zIGZhbHNlLCBza2lwIFBJWEkgY2hpbGQgb2JqZWN0cwogICAgICAgICAgICBpZiAoY3VycmVudE5vZGVbJ3VwZGF0ZSddICYmICFjdXJyZW50Tm9kZS51cGRhdGUoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5sYXN0Ll9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIH0KICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5sYXN0Ll9pTmV4dCkKICAgIH0KCn0KCi8qKgoqIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgYmVmb3JlIHRoZSByZW5kZXJlciBydW5zIGFuZCBhZnRlciB0aGUgcGx1Z2lucyBoYXZlIHVwZGF0ZWQuCiogSW4gcG9zdFVwZGF0ZSB0aGlzIGlzIHdoZXJlIGFsbCB0aGUgZmluYWwgcGh5c2ljcyBjYWxjdWxhdGF0aW9ucyBhbmQgb2JqZWN0IHBvc2l0aW9uaW5nIGhhcHBlbnMuCiogVGhlIG9iamVjdHMgYXJlIHByb2Nlc3NlZCBpbiB0aGUgb3JkZXIgb2YgdGhlIGRpc3BsYXkgbGlzdC4KKiBUaGUgb25seSBleGNlcHRpb24gdG8gdGhpcyBpcyBpZiB0aGUgY2FtZXJhIGlzIGZvbGxvd2luZyBhbiBvYmplY3QsIGluIHdoaWNoIGNhc2UgdGhhdCBpcyB1cGRhdGVkIGZpcnN0LgoqIAoqIEBtZXRob2QgUGhhc2VyLldvcmxkI3Bvc3RVcGRhdGUKKi8KUGhhc2VyLldvcmxkLnByb3RvdHlwZS5wb3N0VXBkYXRlID0gZnVuY3Rpb24gKCkgewoKICAgIGlmICh0aGlzLmNhbWVyYS50YXJnZXQgJiYgdGhpcy5jYW1lcmEudGFyZ2V0Wydwb3N0VXBkYXRlJ10pCiAgICB7CiAgICAgICAgdGhpcy5jYW1lcmEudGFyZ2V0LnBvc3RVcGRhdGUoKTsKCiAgICAgICAgdGhpcy5jYW1lcmEudXBkYXRlKCk7CgogICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmZpcnN0Ll9pTmV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UuZmlyc3QuX2lOZXh0OwogICAgICAgICAgICAKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlWydwb3N0VXBkYXRlJ10gJiYgY3VycmVudE5vZGUgIT09IHRoaXMuY2FtZXJhLnRhcmdldCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5wb3N0VXBkYXRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSAhPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmxhc3QuX2lOZXh0KQogICAgICAgIH0KICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLmNhbWVyYS51cGRhdGUoKTsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UuZmlyc3QuX2lOZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5maXJzdC5faU5leHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICBkbwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGVbJ3Bvc3RVcGRhdGUnXSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5wb3N0VXBkYXRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSAhPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmxhc3QuX2lOZXh0KQogICAgICAgIH0KICAgIH0KCn0KCi8qKgoqIFVwZGF0ZXMgdGhlIHNpemUgb2YgdGhpcyB3b3JsZC4gTm90ZSB0aGF0IHRoaXMgZG9lc24ndCBtb2RpZnkgdGhlIHdvcmxkIHgveSBjb29yZGluYXRlcywganVzdCB0aGUgd2lkdGggYW5kIGhlaWdodC4KKgoqIEBtZXRob2QgUGhhc2VyLldvcmxkI3NldEJvdW5kcwoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVG9wIGxlZnQgbW9zdCBjb3JuZXIgb2YgdGhlIHdvcmxkLgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVG9wIGxlZnQgbW9zdCBjb3JuZXIgb2YgdGhlIHdvcmxkLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIE5ldyB3aWR0aCBvZiB0aGUgd29ybGQuIENhbiBuZXZlciBiZSBzbWFsbGVyIHRoYW4gdGhlIEdhbWUud2lkdGguCiogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIE5ldyBoZWlnaHQgb2YgdGhlIHdvcmxkLiBDYW4gbmV2ZXIgYmUgc21hbGxlciB0aGFuIHRoZSBHYW1lLmhlaWdodC4KKi8KUGhhc2VyLldvcmxkLnByb3RvdHlwZS5zZXRCb3VuZHMgPSBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKICAgIGlmICh3aWR0aCA8IHRoaXMuZ2FtZS53aWR0aCkKICAgIHsKICAgICAgICB3aWR0aCA9IHRoaXMuZ2FtZS53aWR0aDsKICAgIH0KCiAgICBpZiAoaGVpZ2h0IDwgdGhpcy5nYW1lLmhlaWdodCkKICAgIHsKICAgICAgICBoZWlnaHQgPSB0aGlzLmdhbWUuaGVpZ2h0OwogICAgfQoKICAgIHRoaXMuYm91bmRzLnNldFRvKHgsIHksIHdpZHRoLCBoZWlnaHQpOwoKICAgIGlmICh0aGlzLmNhbWVyYS5ib3VuZHMpCiAgICB7CiAgICAgICAgLy8gIFRoZSBDYW1lcmEgY2FuIG5ldmVyIGJlIHNtYWxsZXIgdGhhbiB0aGUgZ2FtZSBzaXplCiAgICAgICAgdGhpcy5jYW1lcmEuYm91bmRzLnNldFRvKHgsIHksIHdpZHRoLCBoZWlnaHQpOwogICAgfQoKICAgIHRoaXMuZ2FtZS5waHlzaWNzLnNldEJvdW5kc1RvV29ybGQoKTsKCn0KCi8qKgoqIERlc3Ryb3llciBvZiB3b3JsZHMuCiogQG1ldGhvZCBQaGFzZXIuV29ybGQjZGVzdHJveQoqLwpQaGFzZXIuV29ybGQucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5jYW1lcmEueCA9IDA7CiAgICB0aGlzLmNhbWVyYS55ID0gMDsKCiAgICB0aGlzLmdhbWUuaW5wdXQucmVzZXQodHJ1ZSk7CgogICAgdGhpcy5yZW1vdmVBbGwoKTsKCn0KCi8qKgoqIEBuYW1lIFBoYXNlci5Xb3JsZCN3aWR0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIEdldHMgb3Igc2V0cyB0aGUgY3VycmVudCB3aWR0aCBvZiB0aGUgZ2FtZSB3b3JsZC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Xb3JsZC5wcm90b3R5cGUsICJ3aWR0aCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5ib3VuZHMud2lkdGg7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5ib3VuZHMud2lkdGggPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLldvcmxkI2hlaWdodAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBHZXRzIG9yIHNldHMgdGhlIGN1cnJlbnQgaGVpZ2h0IG9mIHRoZSBnYW1lIHdvcmxkLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLldvcmxkLnByb3RvdHlwZSwgImhlaWdodCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5ib3VuZHMuaGVpZ2h0OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuYm91bmRzLmhlaWdodCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuV29ybGQjY2VudGVyWAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjZW50ZXJYIC0gR2V0cyB0aGUgWCBwb3NpdGlvbiBjb3JyZXNwb25kaW5nIHRvIHRoZSBjZW50ZXIgcG9pbnQgb2YgdGhlIHdvcmxkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLldvcmxkLnByb3RvdHlwZSwgImNlbnRlclgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYm91bmRzLmhhbGZXaWR0aDsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLldvcmxkI2NlbnRlclkKKiBAcHJvcGVydHkge251bWJlcn0gY2VudGVyWSAtIEdldHMgdGhlIFkgcG9zaXRpb24gY29ycmVzcG9uZGluZyB0byB0aGUgY2VudGVyIHBvaW50IG9mIHRoZSB3b3JsZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Xb3JsZC5wcm90b3R5cGUsICJjZW50ZXJZIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmJvdW5kcy5oYWxmSGVpZ2h0OwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuV29ybGQjcmFuZG9tWAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSByYW5kb21YIC0gR2V0cyBhIHJhbmRvbSBpbnRlZ2VyIHdoaWNoIGlzIGxlc3NlciB0aGFuIG9yIGVxdWFsIHRvIHRoZSBjdXJyZW50IHdpZHRoIG9mIHRoZSBnYW1lIHdvcmxkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLldvcmxkLnByb3RvdHlwZSwgInJhbmRvbVgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmJvdW5kcy54IDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMuYm91bmRzLngsICh0aGlzLmJvdW5kcy53aWR0aCAtIE1hdGguYWJzKHRoaXMuYm91bmRzLngpKSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMuYm91bmRzLngsIHRoaXMuYm91bmRzLndpZHRoKTsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuV29ybGQjcmFuZG9tWQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSByYW5kb21ZIC0gR2V0cyBhIHJhbmRvbSBpbnRlZ2VyIHdoaWNoIGlzIGxlc3NlciB0aGFuIG9yIGVxdWFsIHRvIHRoZSBjdXJyZW50IGhlaWdodCBvZiB0aGUgZ2FtZSB3b3JsZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Xb3JsZC5wcm90b3R5cGUsICJyYW5kb21ZIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5ib3VuZHMueSA8IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnJuZC5pbnRlZ2VySW5SYW5nZSh0aGlzLmJvdW5kcy55LCAodGhpcy5ib3VuZHMuaGVpZ2h0IC0gTWF0aC5hYnModGhpcy5ib3VuZHMueSkpKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5ybmQuaW50ZWdlckluUmFuZ2UodGhpcy5ib3VuZHMueSwgdGhpcy5ib3VuZHMuaGVpZ2h0KTsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuV29ybGQjdmlzaWJsZQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmlzaWJsZSAtIEdldHMgb3Igc2V0cyB0aGUgdmlzaWJsZSBzdGF0ZSBvZiB0aGUgV29ybGQuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuV29ybGQucHJvdG90eXBlLCAidmlzaWJsZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLnZpc2libGU7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLnZpc2libGUgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogR2FtZSBjb25zdHJ1Y3RvcgoqCiogSW5zdGFudGlhdGUgYSBuZXcgPGNvZGU+UGhhc2VyLkdhbWU8L2NvZGU+IG9iamVjdC4KKiBAY2xhc3MgUGhhc2VyLkdhbWUKKiBAY2xhc3NkZXNjIFRoaXMgaXMgd2hlcmUgdGhlIG1hZ2ljIGhhcHBlbnMuIFRoZSBHYW1lIG9iamVjdCBpcyB0aGUgaGVhcnQgb2YgeW91ciBnYW1lLAoqIHByb3ZpZGluZyBxdWljayBhY2Nlc3MgdG8gY29tbW9uIGZ1bmN0aW9ucyBhbmQgaGFuZGxpbmcgdGhlIGJvb3QgcHJvY2Vzcy4KKiAiSGVsbCwgdGhlcmUgYXJlIG5vIHJ1bGVzIGhlcmUgLSB3ZSdyZSB0cnlpbmcgdG8gYWNjb21wbGlzaCBzb21ldGhpbmcuIgoqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRob21hcyBBLiBFZGlzb24KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoPTgwMF0gLSBUaGUgd2lkdGggb2YgeW91ciBnYW1lIGluIGdhbWUgcGl4ZWxzLgoqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0PTYwMF0gLSBUaGUgaGVpZ2h0IG9mIHlvdXIgZ2FtZSBpbiBnYW1lIHBpeGVscy4KKiBAcGFyYW0ge251bWJlcn0gW3JlbmRlcmVyPVBoYXNlci5BVVRPXSAtIFdoaWNoIHJlbmRlcmVyIHRvIHVzZTogUGhhc2VyLkFVVE8gd2lsbCBhdXRvLWRldGVjdCwgUGhhc2VyLldFQkdMLCBQaGFzZXIuQ0FOVkFTIG9yIFBoYXNlci5IRUFETEVTUyAobm8gcmVuZGVyaW5nIGF0IGFsbCkuCiogQHBhcmFtIHtzdHJpbmd8SFRNTEVsZW1lbnR9IFtwYXJlbnQ9JyddIC0gVGhlIERPTSBlbGVtZW50IGludG8gd2hpY2ggdGhpcyBnYW1lcyBjYW52YXMgd2lsbCBiZSBpbmplY3RlZC4gRWl0aGVyIGEgRE9NIElEIChzdHJpbmcpIG9yIHRoZSBlbGVtZW50IGl0c2VsZi4KKiBAcGFyYW0ge29iamVjdH0gW3N0YXRlPW51bGxdIC0gVGhlIGRlZmF1bHQgc3RhdGUgb2JqZWN0LiBBIG9iamVjdCBjb25zaXN0aW5nIG9mIFBoYXNlci5TdGF0ZSBmdW5jdGlvbnMgKHByZWxvYWQsIGNyZWF0ZSwgdXBkYXRlLCByZW5kZXIpIG9yIG51bGwuCiogQHBhcmFtIHtib29sZWFufSBbdHJhbnNwYXJlbnQ9ZmFsc2VdIC0gVXNlIGEgdHJhbnNwYXJlbnQgY2FudmFzIGJhY2tncm91bmQgb3Igbm90LgoqIEBwYXJhbSAge2Jvb2xlYW59IFthbnRpYWxpYXM9dHJ1ZV0gLSBBbnRpLWFsaWFzIGdyYXBoaWNzLgoqLwpQaGFzZXIuR2FtZSA9IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0LCByZW5kZXJlciwgcGFyZW50LCBzdGF0ZSwgdHJhbnNwYXJlbnQsIGFudGlhbGlhcykgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaWQgLSBQaGFzZXIgR2FtZSBJRCAoZm9yIHdoZW4gUGl4aSBzdXBwb3J0cyBtdWx0aXBsZSBpbnN0YW5jZXMpLgogICAgKi8KICAgIHRoaXMuaWQgPSBQaGFzZXIuR0FNRVMucHVzaCh0aGlzKSAtIDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjb25maWcgLSBUaGUgUGhhc2VyLkdhbWUgY29uZmlndXJhdGlvbiBvYmplY3QuCiAgICAqLwogICAgdGhpcy5jb25maWcgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0hUTUxFbGVtZW50fSBwYXJlbnQgLSBUaGUgR2FtZXMgRE9NIHBhcmVudC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhcmVudCA9ICcnOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBUaGUgR2FtZSB3aWR0aCAoaW4gcGl4ZWxzKS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndpZHRoID0gODAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gVGhlIEdhbWUgaGVpZ2h0IChpbiBwaXhlbHMpLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaGVpZ2h0ID0gNjAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHRyYW5zcGFyZW50IC0gVXNlIGEgdHJhbnNwYXJlbnQgY2FudmFzIGJhY2tncm91bmQgb3Igbm90LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudHJhbnNwYXJlbnQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhbnRpYWxpYXMgLSBBbnRpLWFsaWFzIGdyYXBoaWNzIChpbiBXZWJHTCB0aGlzIGhlbHBzIHdpdGggZWRnZXMsIGluIENhbnZhczJEIGl0IHJldGFpbnMgcGl4ZWwtYXJ0IHF1YWxpdHkpLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYW50aWFsaWFzID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHJlbmRlcmVyIC0gVGhlIFBpeGkgUmVuZGVyZXIKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnJlbmRlcmVyID0gUGhhc2VyLkFVVE87CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZW5kZXJUeXBlIC0gVGhlIFJlbmRlcmVyIHRoaXMgUGhhc2VyLkdhbWUgd2lsbCB1c2UuIEVpdGhlciBQaGFzZXIuUkVOREVSRVJfQVVUTywgUGhhc2VyLlJFTkRFUkVSX0NBTlZBUyBvciBQaGFzZXIuUkVOREVSRVJfV0VCR0wuCiAgICAqLwogICAgdGhpcy5yZW5kZXJUeXBlID0gUGhhc2VyLkFVVE87CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzdGF0ZSAtIFRoZSBTdGF0ZU1hbmFnZXIuCiAgICAqLwogICAgdGhpcy5zdGF0ZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX3BhdXNlZCAtIElzIGdhbWUgcGF1c2VkPwogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3BhdXNlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9sb2FkQ29tcGxldGUgLSBXaGV0aGVyIGxvYWQgY29tcGxldGUgbG9hZGluZyBvciBub3QuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fbG9hZENvbXBsZXRlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNCb290ZWQgLSBXaGV0aGVyIHRoZSBnYW1lIGVuZ2luZSBpcyBib290ZWQsIGFrYSBhdmFpbGFibGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc0Jvb3RlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlkIC1JcyBnYW1lIHJ1bm5pbmcgb3IgcGF1c2VkPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNSdW5uaW5nID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZX0gcmFmIC0gQXV0b21hdGljYWxseSBoYW5kbGVzIHRoZSBjb3JlIGdhbWUgbG9vcCB2aWEgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIG9yIHNldFRpbWVvdXQKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnJhZiA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5fSBhZGQgLSBSZWZlcmVuY2UgdG8gdGhlIEdhbWVPYmplY3QgRmFjdG9yeS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFkZCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkNhY2hlfSBjYWNoZSAtIFJlZmVyZW5jZSB0byB0aGUgYXNzZXRzIGNhY2hlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2FjaGUgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5JbnB1dH0gaW5wdXQgLSBSZWZlcmVuY2UgdG8gdGhlIGlucHV0IG1hbmFnZXIKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlucHV0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuTG9hZGVyfSBsb2FkIC0gUmVmZXJlbmNlIHRvIHRoZSBhc3NldHMgbG9hZGVyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubG9hZCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLk1hdGh9IG1hdGggLSBSZWZlcmVuY2UgdG8gdGhlIG1hdGggaGVscGVyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWF0aCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLk5ldH0gbmV0IC0gUmVmZXJlbmNlIHRvIHRoZSBuZXR3b3JrIGNsYXNzLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubmV0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU291bmRNYW5hZ2VyfSBzb3VuZCAtIFJlZmVyZW5jZSB0byB0aGUgc291bmQgbWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNvdW5kID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU3RhZ2V9IHN0YWdlIC0gUmVmZXJlbmNlIHRvIHRoZSBzdGFnZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnN0YWdlID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuVGltZU1hbmFnZXJ9IHRpbWUgLSBSZWZlcmVuY2UgdG8gZ2FtZSBjbG9jay4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRpbWUgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Ud2Vlbk1hbmFnZXJ9IHR3ZWVucyAtIFJlZmVyZW5jZSB0byB0aGUgdHdlZW4gbWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnR3ZWVucyA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLldvcmxkfSB3b3JsZCAtIFJlZmVyZW5jZSB0byB0aGUgd29ybGQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy53b3JsZCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBoeXNpY3MuUGh5c2ljc01hbmFnZXJ9IHBoeXNpY3MgLSBSZWZlcmVuY2UgdG8gdGhlIHBoeXNpY3MgbWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBoeXNpY3MgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yfSBybmQgLSBJbnN0YW5jZSBvZiByZXBlYXRhYmxlIHJhbmRvbSBkYXRhIGdlbmVyYXRvciBoZWxwZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5ybmQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5EZXZpY2V9IGRldmljZSAtIENvbnRhaW5zIGRldmljZSBpbmZvcm1hdGlvbiBhbmQgY2FwYWJpbGl0aWVzLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGV2aWNlID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUGh5c2ljcy5QaHlzaWNzTWFuYWdlcn0gY2FtZXJhIC0gQSBoYW5keSByZWZlcmVuY2UgdG8gd29ybGQuY2FtZXJhLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2FtZXJhID0gbnVsbDsKCiAgICAgICAvKioKICAgICogQHByb3BlcnR5IHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gQSBoYW5keSByZWZlcmVuY2UgdG8gcmVuZGVyZXIudmlldy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNhbnZhcyA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Q29udGV4dH0gY29udGV4dCAtIEEgaGFuZHkgcmVmZXJlbmNlIHRvIHJlbmRlcmVyLmNvbnRleHQgKG9ubHkgc2V0IGZvciBDQU5WQVMgZ2FtZXMpCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuVXRpbHMuRGVidWd9IGRlYnVnIC0gQSBzZXQgb2YgdXNlZnVsIGRlYnVnIHV0aWxpdGllLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGVidWcgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5QYXJ0aWNsZXN9IHBhcnRpY2xlcyAtIFRoZSBQYXJ0aWNsZSBNYW5hZ2VyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGFydGljbGVzID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBzdGVwcGluZyAtIEVuYWJsZSBjb3JlIGxvb3Agc3RlcHBpbmcgd2l0aCBHYW1lLmVuYWJsZVN0ZXAoKS4KICAgICogQGRlZmF1bHQKICAgICogQHJlYWRvbmx5CiAgICAqLwogICAgdGhpcy5zdGVwcGluZyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHN0ZXBwaW5nIC0gQW4gaW50ZXJuYWwgcHJvcGVydHkgdXNlZCBieSBlbmFibGVTdGVwLCBidXQgYWxzbyB1c2VmdWwgdG8gcXVlcnkgZnJvbSB5b3VyIG93biBnYW1lIG9iamVjdHMuCiAgICAqIEBkZWZhdWx0CiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMucGVuZGluZ1N0ZXAgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHN0ZXBDb3VudCAtIFdoZW4gc3RlcHBpbmcgaXMgZW5hYmxlZCB0aGlzIGNvbnRhaW5zIHRoZSBjdXJyZW50IHN0ZXAgY3ljbGUuCiAgICAqIEBkZWZhdWx0CiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMuc3RlcENvdW50ID0gMDsKCiAgICAvLyAgUGFyc2UgdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IChpZiBhbnkpCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzBdID09PSAnb2JqZWN0JykKICAgIHsKICAgICAgICB0aGlzLnBhcnNlQ29uZmlnKGFyZ3VtZW50c1swXSk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgaWYgKHR5cGVvZiB3aWR0aCAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGhlaWdodCAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgcmVuZGVyZXIgIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyOwogICAgICAgICAgICB0aGlzLnJlbmRlclR5cGUgPSByZW5kZXJlcjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgcGFyZW50ICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiB0cmFuc3BhcmVudCAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRyYW5zcGFyZW50ID0gdHJhbnNwYXJlbnQ7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGFudGlhbGlhcyAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFudGlhbGlhcyA9IGFudGlhbGlhczsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RhdGUgPSBuZXcgUGhhc2VyLlN0YXRlTWFuYWdlcih0aGlzLCBzdGF0ZSk7CiAgICB9CgogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICB0aGlzLl9vbkJvb3QgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIF90aGlzLmJvb3QoKTsKICAgIH0KCiAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJyB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnaW50ZXJhY3RpdmUnKQogICAgewogICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KHRoaXMuX29uQm9vdCwgMCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIHRoaXMuX29uQm9vdCwgZmFsc2UpOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgdGhpcy5fb25Cb290LCBmYWxzZSk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cgp9OwoKUGhhc2VyLkdhbWUucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBQYXJzZXMgYSBHYW1lIGNvbmZpZ3VyYXRpb24gb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI3BhcnNlQ29uZmlnCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwYXJzZUNvbmZpZzogZnVuY3Rpb24gKGNvbmZpZykgewoKICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZzsKCiAgICAgICAgaWYgKGNvbmZpZ1snd2lkdGgnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSB0aGlzLnBhcnNlRGltZW5zaW9uKGNvbmZpZ1snd2lkdGgnXSwgMCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoY29uZmlnWydoZWlnaHQnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy5wYXJzZURpbWVuc2lvbihjb25maWdbJ2hlaWdodCddLCAxKTsKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWdbJ3JlbmRlcmVyJ10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnJlbmRlcmVyID0gY29uZmlnWydyZW5kZXJlciddOwogICAgICAgICAgICB0aGlzLnJlbmRlclR5cGUgPSBjb25maWdbJ3JlbmRlcmVyJ107CiAgICAgICAgfQoKICAgICAgICBpZiAoY29uZmlnWydwYXJlbnQnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gY29uZmlnWydwYXJlbnQnXTsKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWdbJ3RyYW5zcGFyZW50J10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRyYW5zcGFyZW50ID0gY29uZmlnWyd0cmFuc3BhcmVudCddOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZ1snYW50aWFsaWFzJ10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFudGlhbGlhcyA9IGNvbmZpZ1snYW50aWFsaWFzJ107CiAgICAgICAgfQoKICAgICAgICB2YXIgc3RhdGUgPSBudWxsOwoKICAgICAgICBpZiAoY29uZmlnWydzdGF0ZSddKQogICAgICAgIHsKICAgICAgICAgICAgc3RhdGUgPSBjb25maWdbJ3N0YXRlJ107CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0YXRlID0gbmV3IFBoYXNlci5TdGF0ZU1hbmFnZXIodGhpcywgc3RhdGUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBkaW1lbnNpb24uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWUjcGFyc2VEaW1lbnNpb24KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHBhcnNlRGltZW5zaW9uOiBmdW5jdGlvbiAoc2l6ZSwgZGltZW5zaW9uKSB7CgogICAgICAgIHZhciBmID0gMDsKICAgICAgICB2YXIgcHggPSAwOwoKICAgICAgICBpZiAodHlwZW9mIHNpemUgPT09ICdzdHJpbmcnKQogICAgICAgIHsKICAgICAgICAgICAgLy8gICU/CiAgICAgICAgICAgIGlmIChzaXplLnN1YnN0cigtMSkgPT09ICclJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZiA9IHBhcnNlSW50KHNpemUsIDEwKSAvIDEwMDsKCiAgICAgICAgICAgICAgICBpZiAoZGltZW5zaW9uID09PSAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHB4ID0gd2luZG93LmlubmVyV2lkdGggKiBmOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHB4ID0gd2luZG93LmlubmVySGVpZ2h0ICogZjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHB4ID0gcGFyc2VJbnQoc2l6ZSwgMTApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHB4ID0gc2l6ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBweDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbml0aWFsaXplIGVuZ2luZSBzdWIgbW9kdWxlcyBhbmQgc3RhcnQgdGhlIGdhbWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWUjYm9vdAogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgYm9vdDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5pc0Jvb3RlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICghZG9jdW1lbnQuYm9keSkKICAgICAgICB7CiAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KHRoaXMuX29uQm9vdCwgMjApOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgdGhpcy5fb25Cb290KTsKICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2xvYWQnLCB0aGlzLl9vbkJvb3QpOwoKICAgICAgICAgICAgdGhpcy5vblBhdXNlID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICAgICAgdGhpcy5vblJlc3VtZSA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgICAgICAgICB0aGlzLmlzQm9vdGVkID0gdHJ1ZTsKCiAgICAgICAgICAgIHRoaXMuZGV2aWNlID0gbmV3IFBoYXNlci5EZXZpY2UoKTsKICAgICAgICAgICAgdGhpcy5tYXRoID0gUGhhc2VyLk1hdGg7CiAgICAgICAgICAgIHRoaXMucm5kID0gbmV3IFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yKFsoRGF0ZS5ub3coKSAqIE1hdGgucmFuZG9tKCkpLnRvU3RyaW5nKCldKTsKCiAgICAgICAgICAgIHRoaXMuc3RhZ2UgPSBuZXcgUGhhc2VyLlN0YWdlKHRoaXMsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCiAgICAgICAgICAgIHRoaXMuc2V0VXBSZW5kZXJlcigpOwoKICAgICAgICAgICAgdGhpcy53b3JsZCA9IG5ldyBQaGFzZXIuV29ybGQodGhpcyk7CiAgICAgICAgICAgIHRoaXMuYWRkID0gbmV3IFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSh0aGlzKTsKICAgICAgICAgICAgdGhpcy5jYWNoZSA9IG5ldyBQaGFzZXIuQ2FjaGUodGhpcyk7CiAgICAgICAgICAgIHRoaXMubG9hZCA9IG5ldyBQaGFzZXIuTG9hZGVyKHRoaXMpOwogICAgICAgICAgICB0aGlzLnRpbWUgPSBuZXcgUGhhc2VyLlRpbWUodGhpcyk7CiAgICAgICAgICAgIHRoaXMudHdlZW5zID0gbmV3IFBoYXNlci5Ud2Vlbk1hbmFnZXIodGhpcyk7CiAgICAgICAgICAgIHRoaXMuaW5wdXQgPSBuZXcgUGhhc2VyLklucHV0KHRoaXMpOwogICAgICAgICAgICB0aGlzLnNvdW5kID0gbmV3IFBoYXNlci5Tb3VuZE1hbmFnZXIodGhpcyk7CiAgICAgICAgICAgIHRoaXMucGh5c2ljcyA9IG5ldyBQaGFzZXIuUGh5c2ljcy5BcmNhZGUodGhpcyk7CiAgICAgICAgICAgIHRoaXMucGFydGljbGVzID0gbmV3IFBoYXNlci5QYXJ0aWNsZXModGhpcyk7CiAgICAgICAgICAgIHRoaXMucGx1Z2lucyA9IG5ldyBQaGFzZXIuUGx1Z2luTWFuYWdlcih0aGlzLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5uZXQgPSBuZXcgUGhhc2VyLk5ldCh0aGlzKTsKICAgICAgICAgICAgdGhpcy5kZWJ1ZyA9IG5ldyBQaGFzZXIuVXRpbHMuRGVidWcodGhpcyk7CgogICAgICAgICAgICB0aGlzLnRpbWUuYm9vdCgpOwogICAgICAgICAgICB0aGlzLnN0YWdlLmJvb3QoKTsKICAgICAgICAgICAgdGhpcy53b3JsZC5ib290KCk7CiAgICAgICAgICAgIHRoaXMuaW5wdXQuYm9vdCgpOwogICAgICAgICAgICB0aGlzLnNvdW5kLmJvb3QoKTsKICAgICAgICAgICAgdGhpcy5zdGF0ZS5ib290KCk7CgogICAgICAgICAgICB0aGlzLmxvYWQub25Mb2FkQ29tcGxldGUuYWRkKHRoaXMubG9hZENvbXBsZXRlLCB0aGlzKTsKCiAgICAgICAgICAgIHRoaXMuc2hvd0RlYnVnSGVhZGVyKCk7CgogICAgICAgICAgICB0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX2xvYWRDb21wbGV0ZSA9IGZhbHNlOwoKICAgICAgICAgICAgdGhpcy5yYWYgPSBuZXcgUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzKTsKICAgICAgICAgICAgdGhpcy5yYWYuc3RhcnQoKTsKCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIERpc3BsYXlzIGEgUGhhc2VyIHZlcnNpb24gZGVidWcgaGVhZGVyIGluIHRoZSBjb25zb2xlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI3Nob3dEZWJ1Z0hlYWRlcgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgc2hvd0RlYnVnSGVhZGVyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciB2ID0gUGhhc2VyLkRFVl9WRVJTSU9OOwogICAgICAgIHZhciByID0gJ0NhbnZhcyc7CiAgICAgICAgdmFyIGEgPSAnSFRNTCBBdWRpbyc7CgogICAgICAgIGlmICh0aGlzLnJlbmRlclR5cGUgPT0gUGhhc2VyLldFQkdMKQogICAgICAgIHsKICAgICAgICAgICAgciA9ICdXZWJHTCc7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMucmVuZGVyVHlwZSA9PSBQaGFzZXIuSEVBRExFU1MpCiAgICAgICAgewogICAgICAgICAgICByID0gJ0hlYWRsZXNzJzsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmRldmljZS53ZWJBdWRpbykKICAgICAgICB7CiAgICAgICAgICAgIGEgPSAnV2ViQXVkaW8nOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZGV2aWNlLmNocm9tZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBhcmdzID0gWwogICAgICAgICAgICAgICAgJyVjICVjICVjICBQaGFzZXIgdicgKyB2ICsgJyAtIFJlbmRlcmVyOiAnICsgciArICcgLSBBdWRpbzogJyArIGEgKyAnICAlYyAlYyAnLAogICAgICAgICAgICAgICAgJ2JhY2tncm91bmQ6ICMwMGJmZjMnLAogICAgICAgICAgICAgICAgJ2JhY2tncm91bmQ6ICMwMDcyYmMnLAogICAgICAgICAgICAgICAgJ2NvbG9yOiAjZmZmZmZmOyBiYWNrZ3JvdW5kOiAjMDAzNDcxJywKICAgICAgICAgICAgICAgICdiYWNrZ3JvdW5kOiAjMDA3MmJjJywKICAgICAgICAgICAgICAgICdiYWNrZ3JvdW5kOiAjMDBiZmYzJwogICAgICAgICAgICBdOwoKICAgICAgICAgICAgY29uc29sZS5sb2cuYXBwbHkoY29uc29sZSwgYXJncyk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQaGFzZXIgdicgKyB2ICsgJyAtIFJlbmRlcmVyOiAnICsgciArICcgLSBBdWRpbzogJyArIGEpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgaWYgdGhlIGRldmljZSBpcyBjYXBhYmxlIG9mIHVzaW5nIHRoZSByZXF1ZXN0ZWQgcmVuZGVyZXIgYW5kIHNldHMgaXQgdXAgb3IgYW4gYWx0ZXJuYXRpdmUgaWYgbm90LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI3NldFVwUmVuZGVyZXIKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHNldFVwUmVuZGVyZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLyoKICAgICAgICBpZiAodGhpcy5kZXZpY2UudHJpZGVudCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBQaXhpIFdlYkdMIHJlbmRlcmVyIG9uIElFMTEgZG9lc24ndCB3b3JrIGNvcnJlY3RseSB3aXRoIG1hc2tzLCBpZiB5b3UgbmVlZCB0aGVtIHlvdSBtYXkgd2FudCB0byBjb21tZW50IHRoaXMgYmxvY2sgb3V0CiAgICAgICAgICAgIHRoaXMucmVuZGVyVHlwZSA9IFBoYXNlci5DQU5WQVM7CiAgICAgICAgfQogICAgICAgICovCgogICAgICAgIGlmICh0aGlzLnJlbmRlclR5cGUgPT09IFBoYXNlci5IRUFETEVTUyB8fCB0aGlzLnJlbmRlclR5cGUgPT09IFBoYXNlci5DQU5WQVMgfHwgKHRoaXMucmVuZGVyVHlwZSA9PT0gUGhhc2VyLkFVVE8gJiYgdGhpcy5kZXZpY2Uud2ViR0wgPT09IGZhbHNlKSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmRldmljZS5jYW52YXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlbmRlclR5cGUgPT09IFBoYXNlci5BVVRPKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyVHlwZSA9IFBoYXNlci5DQU5WQVM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IG5ldyBQSVhJLkNhbnZhc1JlbmRlcmVyKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0LCB0aGlzLnN0YWdlLmNhbnZhcywgdGhpcy50cmFuc3BhcmVudCk7CiAgICAgICAgICAgICAgICBQaGFzZXIuQ2FudmFzLnNldFNtb290aGluZ0VuYWJsZWQodGhpcy5yZW5kZXJlci5jb250ZXh0LCB0aGlzLmFudGlhbGlhcyk7CiAgICAgICAgICAgICAgICB0aGlzLmNhbnZhcyA9IHRoaXMucmVuZGVyZXIudmlldzsKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IHRoaXMucmVuZGVyZXIuY29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUGhhc2VyLkdhbWUgLSBjYW5ub3QgY3JlYXRlIENhbnZhcyBvciBXZWJHTCBjb250ZXh0LCBhYm9ydGluZy4nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgVGhleSByZXF1ZXN0ZWQgV2ViR0wsIGFuZCB0aGVpciBicm93c2VyIHN1cHBvcnRzIGl0CiAgICAgICAgICAgIHRoaXMucmVuZGVyVHlwZSA9IFBoYXNlci5XRUJHTDsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IG5ldyBQSVhJLldlYkdMUmVuZGVyZXIodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQsIHRoaXMuc3RhZ2UuY2FudmFzLCB0aGlzLnRyYW5zcGFyZW50LCB0aGlzLmFudGlhbGlhcyk7CiAgICAgICAgICAgIHRoaXMuY2FudmFzID0gdGhpcy5yZW5kZXJlci52aWV3OwogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgUGhhc2VyLkNhbnZhcy5hZGRUb0RPTSh0aGlzLnJlbmRlcmVyLnZpZXcsIHRoaXMucGFyZW50LCB0cnVlKTsKICAgICAgICBQaGFzZXIuQ2FudmFzLnNldFRvdWNoQWN0aW9uKHRoaXMucmVuZGVyZXIudmlldyk7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIHdoZW4gdGhlIGxvYWQgaGFzIGZpbmlzaGVkLCBhZnRlciBwcmVsb2FkIHdhcyBydW4uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWUjbG9hZENvbXBsZXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBsb2FkQ29tcGxldGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fbG9hZENvbXBsZXRlID0gdHJ1ZTsKCiAgICAgICAgdGhpcy5zdGF0ZS5sb2FkQ29tcGxldGUoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgY29yZSBnYW1lIGxvb3AuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWUjdXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbWUgLSBUaGUgY3VycmVudCB0aW1lIGFzIHByb3ZpZGVkIGJ5IFJlcXVlc3RBbmltYXRpb25GcmFtZS4KICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICh0aW1lKSB7CgogICAgICAgIHRoaXMudGltZS51cGRhdGUodGltZSk7CgogICAgICAgIGlmICh0aGlzLl9wYXVzZWQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcih0aGlzLnN0YWdlLl9zdGFnZSk7CiAgICAgICAgICAgIHRoaXMucGx1Z2lucy5yZW5kZXIoKTsKICAgICAgICAgICAgdGhpcy5zdGF0ZS5yZW5kZXIoKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnBlbmRpbmdTdGVwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGVwcGluZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBlbmRpbmdTdGVwID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbnMucHJlVXBkYXRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLndvcmxkLnByZVVwZGF0ZSgpOwoKICAgICAgICAgICAgICAgIHRoaXMuc3RhZ2UudXBkYXRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLnR3ZWVucy51cGRhdGUoKTsKICAgICAgICAgICAgICAgIHRoaXMuc291bmQudXBkYXRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnVwZGF0ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS51cGRhdGUoKTsKICAgICAgICAgICAgICAgIHRoaXMud29ybGQudXBkYXRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlcy51cGRhdGUoKTsgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMucGx1Z2lucy51cGRhdGUoKTsKCiAgICAgICAgICAgICAgICB0aGlzLndvcmxkLnBvc3RVcGRhdGUoKTsKICAgICAgICAgICAgICAgIHRoaXMucGx1Z2lucy5wb3N0VXBkYXRlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnJlbmRlclR5cGUgIT09IFBoYXNlci5IRUFETEVTUykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5yZW5kZXIodGhpcy5zdGFnZS5fc3RhZ2UpOwogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zLnJlbmRlcigpOwogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5yZW5kZXIoKTsKCiAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbnMucG9zdFJlbmRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEVuYWJsZSBjb3JlIGdhbWUgbG9vcCBzdGVwcGluZy4gV2hlbiBlbmFibGVkIHlvdSBtdXN0IGNhbGwgZ2FtZS5zdGVwKCkgZGlyZWN0bHkgKHBlcmhhcHMgdmlhIGEgRE9NIGJ1dHRvbj8pCiAgICAqIENhbGxpbmcgc3RlcCB3aWxsIGFkdmFuY2UgdGhlIGdhbWUgbG9vcCBieSBvbmUgZnJhbWUuIFRoaXMgaXMgZXh0cmVtZWx5IHVzZWZ1bCB0byBoYXJkIHRvIHRyYWNrIGRvd24gZXJyb3JzIQogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI2VuYWJsZVN0ZXAKICAgICovCiAgICBlbmFibGVTdGVwOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuc3RlcHBpbmcgPSB0cnVlOwogICAgICAgIHRoaXMucGVuZGluZ1N0ZXAgPSBmYWxzZTsKICAgICAgICB0aGlzLnN0ZXBDb3VudCA9IDA7CgogICAgfSwKCiAgICAvKioKICAgICogRGlzYWJsZXMgY29yZSBnYW1lIGxvb3Agc3RlcHBpbmcuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWUjZGlzYWJsZVN0ZXAKICAgICovCiAgICBkaXNhYmxlU3RlcDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnN0ZXBwaW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5wZW5kaW5nU3RlcCA9IGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFdoZW4gc3RlcHBpbmcgaXMgZW5hYmxlZCB5b3UgbXVzdCBjYWxsIHRoaXMgZnVuY3Rpb24gZGlyZWN0bHkgKHBlcmhhcHMgdmlhIGEgRE9NIGJ1dHRvbj8pIHRvIGFkdmFuY2UgdGhlIGdhbWUgbG9vcCBieSBvbmUgZnJhbWUuCiAgICAqIFRoaXMgaXMgZXh0cmVtZWx5IHVzZWZ1bCB0byBoYXJkIHRvIHRyYWNrIGRvd24gZXJyb3JzISBVc2UgdGhlIGludGVybmFsIHN0ZXBDb3VudCBwcm9wZXJ0eSB0byBtb25pdG9yIHByb2dyZXNzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI3N0ZXAKICAgICovCiAgICBzdGVwOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMucGVuZGluZ1N0ZXAgPSBmYWxzZTsKICAgICAgICB0aGlzLnN0ZXBDb3VudCsrOwoKICAgIH0sCgogICAgLyoqCiAgICAqIE51a2UgdGhlIGVudGlyZSBnYW1lIGZyb20gb3JiaXQKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZSNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnJhZi5zdG9wKCk7CgogICAgICAgIHRoaXMuaW5wdXQuZGVzdHJveSgpOwoKICAgICAgICB0aGlzLnN0YXRlLmRlc3Ryb3koKTsKCiAgICAgICAgdGhpcy5zdGF0ZSA9IG51bGw7CiAgICAgICAgdGhpcy5jYWNoZSA9IG51bGw7CiAgICAgICAgdGhpcy5pbnB1dCA9IG51bGw7CiAgICAgICAgdGhpcy5sb2FkID0gbnVsbDsKICAgICAgICB0aGlzLnNvdW5kID0gbnVsbDsKICAgICAgICB0aGlzLnN0YWdlID0gbnVsbDsKICAgICAgICB0aGlzLnRpbWUgPSBudWxsOwogICAgICAgIHRoaXMud29ybGQgPSBudWxsOwogICAgICAgIHRoaXMuaXNCb290ZWQgPSBmYWxzZTsKCiAgICB9Cgp9OwoKUGhhc2VyLkdhbWUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkdhbWU7CgovKioKKiBUaGUgcGF1c2VkIHN0YXRlIG9mIHRoZSBHYW1lLiBBIHBhdXNlZCBnYW1lIGRvZXNuJ3QgdXBkYXRlIGFueSBvZiBpdHMgc3Vic3lzdGVtcy4KKiBXaGVuIGEgZ2FtZSBpcyBwYXVzZWQgdGhlIG9uUGF1c2UgZXZlbnQgaXMgZGlzcGF0Y2hlZC4gV2hlbiBpdCBpcyByZXN1bWVkIHRoZSBvblJlc3VtZSBldmVudCBpcyBkaXNwYXRjaGVkLgoqIEBuYW1lIFBoYXNlci5HYW1lI3BhdXNlZAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGF1c2VkIC0gR2V0cyBhbmQgc2V0cyB0aGUgcGF1c2VkIHN0YXRlIG9mIHRoZSBHYW1lLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdhbWUucHJvdG90eXBlLCAicGF1c2VkIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9wYXVzZWQ7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh2YWx1ZSA9PT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXVzZWQgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXVzZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5vblBhdXNlLmRpc3BhdGNoKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXVzZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BhdXNlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5vblJlc3VtZS5kaXNwYXRjaCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqICJEZWxldGVkIGNvZGUgaXMgZGVidWdnZWQgY29kZS4iIC0gSmVmZiBTaWNrZWwKKi8KCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlci5JbnB1dCBpcyB0aGUgSW5wdXQgTWFuYWdlciBmb3IgYWxsIHR5cGVzIG9mIElucHV0IGFjcm9zcyBQaGFzZXIsIGluY2x1ZGluZyBtb3VzZSwga2V5Ym9hcmQsIHRvdWNoIGFuZCBNU1BvaW50ZXIuCiogVGhlIElucHV0IG1hbmFnZXIgaXMgdXBkYXRlZCBhdXRvbWF0aWNhbGx5IGJ5IHRoZSBjb3JlIGdhbWUgbG9vcC4KKgoqIEBjbGFzcyBQaGFzZXIuSW5wdXQKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqLwpQaGFzZXIuSW5wdXQgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuIAogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7SFRNTENhbnZhc0VsZW1lbnR9IGhpdENhbnZhcyAtIFRoZSBjYW52YXMgdG8gd2hpY2ggc2luZ2xlIHBpeGVscyBhcmUgZHJhd24gaW4gb3JkZXIgdG8gcGVyZm9ybSBwaXhlbC1wZXJmZWN0IGhpdCBkZXRlY3Rpb24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5oaXRDYW52YXMgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGhpdENvbnRleHQgLSBUaGUgY29udGV4dCBvZiB0aGUgcGl4ZWwgcGVyZmVjdCBoaXQgY2FudmFzLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaGl0Q29udGV4dCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG1vdmVDYWxsYmFjayAtIEFuIG9wdGlvbmFsIGNhbGxiYWNrIHRoYXQgd2lsbCBiZSBmaXJlZCBldmVyeSB0aW1lIHRoZSBhY3RpdmVQb2ludGVyIHJlY2VpdmVzIGEgbW92ZSBldmVudCBmcm9tIHRoZSBET00uIFNldCB0byBudWxsIHRvIGRpc2FibGUuCiAgICAqLwogICAgdGhpcy5tb3ZlQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gbW92ZUNhbGxiYWNrQ29udGV4dCAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRoZSBtb3ZlQ2FsbGJhY2sgd2lsbCBiZSBzZW50LiBEZWZhdWx0cyB0byBQaGFzZXIuSW5wdXQgYnV0IGNhbiBiZSBzZXQgdG8gYW55IHZhbGlkIEpTIG9iamVjdC4KICAgICovCiAgICB0aGlzLm1vdmVDYWxsYmFja0NvbnRleHQgPSB0aGlzOwogICAgCn07CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuSW5wdXQuTU9VU0VfT1ZFUlJJREVTX1RPVUNIID0gMDsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5JbnB1dC5UT1VDSF9PVkVSUklERVNfTU9VU0UgPSAxOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLklucHV0Lk1PVVNFX1RPVUNIX0NPTUJJTkUgPSAyOwoKUGhhc2VyLklucHV0LnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogSG93IG9mdGVuIHNob3VsZCB0aGUgaW5wdXQgcG9pbnRlcnMgYmUgY2hlY2tlZCBmb3IgdXBkYXRlcz8KICAgICogQSB2YWx1ZSBvZiAwIG1lYW5zIGV2ZXJ5IHNpbmdsZSBmcmFtZSAoNjBmcHMpLCBhIHZhbHVlIG9mIDEgbWVhbnMgZXZlcnkgb3RoZXIgZnJhbWUgKDMwZnBzKSBhbmQgc28gb24uCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwb2xsUmF0ZSAKICAgICogQGRlZmF1bHQKICAgICovCiAgICBwb2xsUmF0ZTogMCwKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfcG9sbENvdW50ZXIgLSBJbnRlcm5hbCB2YXIgaG9sZGluZyB0aGUgY3VycmVudCBwb2xsIGNvdW50ZXIuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgX3BvbGxDb3VudGVyOiAwLAoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gX29sZFBvc2l0aW9uIC0gQSBwb2ludCBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBwcmV2aW91cyBwb3NpdGlvbiBvZiB0aGUgUG9pbnRlci4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQgCiAgICAqLwogICAgX29sZFBvc2l0aW9uOiBudWxsLAoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3ggLSB4IGNvb3JkaW5hdGUgb2YgdGhlIG1vc3QgcmVjZW50IFBvaW50ZXIgZXZlbnQKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICBfeDogMCwKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF95IC0gWSBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudCBQb2ludGVyIGV2ZW50CiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgX3k6IDAsCgogICAgLyoqCiAgICAqIFlvdSBjYW4gZGlzYWJsZSBhbGwgSW5wdXQgYnkgc2V0dGluZyBJbnB1dC5kaXNhYmxlZDogdHJ1ZS4gV2hpbGUgc2V0IGFsbCBuZXcgaW5wdXQgcmVsYXRlZCBldmVudHMgd2lsbCBiZSBpZ25vcmVkLgogICAgKiBJZiB5b3UgbmVlZCB0byBkaXNhYmxlIGp1c3Qgb25lIHR5cGUgb2YgaW5wdXQsIGZvciBleGFtcGxlIG1vdXNlLCB1c2UgSW5wdXQubW91c2UuZGlzYWJsZWQ6IHRydWUgaW5zdGVhZAogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRpc2FibGVkCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgZGlzYWJsZWQ6IGZhbHNlLAoKICAgIC8qKgogICAgKiBDb250cm9scyB0aGUgZXhwZWN0ZWQgYmVoYXZpb3VyIHdoZW4gdXNpbmcgYSBtb3VzZSBhbmQgdG91Y2ggdG9nZXRoZXIgb24gYSBtdWx0aS1pbnB1dCBkZXZpY2UuCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IG11bHRpSW5wdXRPdmVycmlkZQogICAgKi8KICAgIG11bHRpSW5wdXRPdmVycmlkZTogUGhhc2VyLklucHV0Lk1PVVNFX1RPVUNIX0NPTUJJTkUsCgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBwb3NpdGlvbiAtIEEgcG9pbnQgb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgY3VycmVudCBwb3NpdGlvbiBvZiB0aGUgUG9pbnRlci4KICAgICogQGRlZmF1bHQgCiAgICAqLwogICAgcG9zaXRpb246IG51bGwsCgogICAgLyoqCiAgICAqIEEgcG9pbnQgb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc3BlZWQgb2YgdGhlIFBvaW50ZXIuIE9ubHkgcmVhbGx5IHVzZWZ1bCBpbiBzaW5nbGUgUG9pbnRlciBnYW1lcywgb3RoZXJ3aXNlIHNlZSB0aGUgUG9pbnRlciBvYmplY3RzIGRpcmVjdGx5LgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc3BlZWQKICAgICovCiAgICBzcGVlZDogbnVsbCwKCiAgICAvKioKICAgICogQSBDaXJjbGUgb2JqZWN0IGNlbnRlcmVkIG9uIHRoZSB4L3kgc2NyZWVuIGNvb3JkaW5hdGVzIG9mIHRoZSBJbnB1dC4KICAgICogRGVmYXVsdCBzaXplIG9mIDQ0cHggKEFwcGxlcyByZWNvbW1lbmRlZCAiZmluZ2VyIHRpcCIgc2l6ZSkgYnV0IGNhbiBiZSBjaGFuZ2VkIHRvIGFueXRoaW5nLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5DaXJjbGV9IGNpcmNsZQogICAgKi8KICAgIGNpcmNsZTogbnVsbCwKCiAgICAvKioKICAgICogVGhlIHNjYWxlIGJ5IHdoaWNoIGFsbCBpbnB1dCBjb29yZGluYXRlcyBhcmUgbXVsdGlwbGllZCwgY2FsY3VsYXRlZCBieSB0aGUgU3RhZ2VTY2FsZU1vZGUuCiAgICAqIEluIGFuIHVuLXNjYWxlZCBnYW1lIHRoZSB2YWx1ZXMgd2lsbCBiZSB4OiAxIGFuZCB5OiAxLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc2NhbGUKICAgICovCiAgICBzY2FsZTogbnVsbCwKCiAgICAvKioKICAgICogVGhlIG1heGltdW0gbnVtYmVyIG9mIFBvaW50ZXJzIGFsbG93ZWQgdG8gYmUgYWN0aXZlIGF0IGFueSBvbmUgdGltZS4KICAgICogRm9yIGxvdHMgb2YgZ2FtZXMgaXQncyB1c2VmdWwgdG8gc2V0IHRoaXMgdG8gMS4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heFBvaW50ZXJzCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgbWF4UG9pbnRlcnM6IDEwLAoKICAgIC8qKgogICAgKiBUaGUgY3VycmVudCBudW1iZXIgb2YgYWN0aXZlIFBvaW50ZXJzLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY3VycmVudFBvaW50ZXJzCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgY3VycmVudFBvaW50ZXJzOiAwLAoKICAgIC8qKgogICAgKiBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0aGF0IHRoZSBQb2ludGVyIGhhcyB0byBiZSBwcmVzc2VkIGRvd24gYW5kIHRoZW4gcmVsZWFzZWQgdG8gYmUgY29uc2lkZXJlZCBhIHRhcCBvciBjbGlja2UKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRhcFJhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0YXBSYXRlOiAyMDAsCgogICAgLyoqCiAgICAqIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIGJldHdlZW4gdGFwcyBvZiB0aGUgc2FtZSBQb2ludGVyIGZvciBpdCB0byBiZSBjb25zaWRlcmVkIGEgZG91YmxlIHRhcCAvIGNsaWNrCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkb3VibGVUYXBSYXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgZG91YmxlVGFwUmF0ZTogMzAwLAoKICAgIC8qKgogICAgKiBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0aGF0IHRoZSBQb2ludGVyIGhhcyB0byBiZSBwcmVzc2VkIGRvd24gZm9yIGl0IHRvIGZpcmUgYSBvbkhvbGQgZXZlbnQKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhvbGRSYXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgaG9sZFJhdGU6IDIwMDAsCgogICAgLyoqCiAgICAqIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIGJlbG93IHdoaWNoIHRoZSBQb2ludGVyIGlzIGNvbnNpZGVyZWQganVzdFByZXNzZWQKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGp1c3RQcmVzc2VkUmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIGp1c3RQcmVzc2VkUmF0ZTogMjAwLAoKICAgIC8qKgogICAgKiBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBiZWxvdyB3aGljaCB0aGUgUG9pbnRlciBpcyBjb25zaWRlcmVkIGp1c3RSZWxlYXNlZCAKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGp1c3RSZWxlYXNlZFJhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICBqdXN0UmVsZWFzZWRSYXRlOiAyMDAsCgogICAgLyoqCiAgICAqIFNldHMgaWYgdGhlIFBvaW50ZXIgb2JqZWN0cyBzaG91bGQgcmVjb3JkIGEgaGlzdG9yeSBvZiB4L3kgY29vcmRpbmF0ZXMgdGhleSBoYXZlIHBhc3NlZCB0aHJvdWdoLgogICAgKiBUaGUgaGlzdG9yeSBpcyBjbGVhcmVkIGVhY2ggdGltZSB0aGUgUG9pbnRlciBpcyBwcmVzc2VkIGRvd24uCiAgICAqIFRoZSBoaXN0b3J5IGlzIHVwZGF0ZWQgYXQgdGhlIHJhdGUgc3BlY2lmaWVkIGluIElucHV0LnBvbGxSYXRlCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcmVjb3JkUG9pbnRlckhpc3RvcnkKICAgICogQGRlZmF1bHQKICAgICovCiAgICByZWNvcmRQb2ludGVySGlzdG9yeTogZmFsc2UsCgogICAgLyoqCiAgICAqIFRoZSByYXRlIGluIG1pbGxpc2Vjb25kcyBhdCB3aGljaCB0aGUgUG9pbnRlciBvYmplY3RzIHNob3VsZCB1cGRhdGUgdGhlaXIgdHJhY2tpbmcgaGlzdG9yeQogICAgKiBAcHJvcGVydHkge251bWJlcn0gcmVjb3JkUmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHJlY29yZFJhdGU6IDEwMCwKCiAgICAvKioKICAgICogVGhlIHRvdGFsIG51bWJlciBvZiBlbnRyaWVzIHRoYXQgY2FuIGJlIHJlY29yZGVkIGludG8gdGhlIFBvaW50ZXIgb2JqZWN0cyB0cmFja2luZyBoaXN0b3J5LgogICAgKiBJZiB0aGUgUG9pbnRlciBpcyB0cmFja2luZyBvbmUgZXZlbnQgZXZlcnkgMTAwbXMsIHRoZW4gYSB0cmFja0xpbWl0IG9mIDEwMCB3b3VsZCBzdG9yZSB0aGUgbGFzdCAxMCBzZWNvbmRzIHdvcnRoIG9mIGhpc3RvcnkuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZWNvcmRMaW1pdAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHJlY29yZExpbWl0OiAxMDAsCgogICAgLyoqCiAgICAqIEEgUG9pbnRlciBvYmplY3QKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjEKICAgICovCiAgICBwb2ludGVyMTogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyMgogICAgKi8KICAgIHBvaW50ZXIyOiBudWxsLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0ICAKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjMKICAgICovCiAgICBwb2ludGVyMzogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyNAogICAgKi8KICAgIHBvaW50ZXI0OiBudWxsLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0CiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXI1CiAgICAqLwogICAgcG9pbnRlcjU6IG51bGwsCgogICAgLyoqCiAgICAqIEEgUG9pbnRlciBvYmplY3QKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjYKICAgICovCiAgICBwb2ludGVyNjogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdCAgCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXI3CiAgICAqLwogICAgcG9pbnRlcjc6IG51bGwsCgogICAgLyoqCiAgICAqIEEgUG9pbnRlciBvYmplY3QKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjgKICAgICovCiAgICBwb2ludGVyODogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyOQogICAgKi8KICAgIHBvaW50ZXI5OiBudWxsLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0LgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyMTAKICAgICovCiAgICBwb2ludGVyMTA6IG51bGwsCgogICAgLyoqCiAgICAqIFRoZSBtb3N0IHJlY2VudGx5IGFjdGl2ZSBQb2ludGVyIG9iamVjdC4KICAgICogV2hlbiB5b3UndmUgbGltaXRlZCBtYXggcG9pbnRlcnMgdG8gMSB0aGlzIHdpbGwgYWNjdXJhdGVseSBiZSBlaXRoZXIgdGhlIGZpcnN0IGZpbmdlciB0b3VjaGVkIG9yIG1vdXNlLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBhY3RpdmVQb2ludGVyCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgYWN0aXZlUG9pbnRlcjogbnVsbCwKCiAgICAvKioKICAgICogVGhlIG1vdXNlIGhhcyBpdHMgb3duIHVuaXF1ZSBQaGFzZXIuUG9pbnRlciBvYmplY3Qgd2hpY2ggeW91IGNhbiB1c2UgaWYgbWFraW5nIGEgZGVza3RvcCBzcGVjaWZpYyBnYW1lLgogICAgKiBAcHJvcGVydHkge1BvaW50ZXJ9IG1vdXNlUG9pbnRlcgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIG1vdXNlUG9pbnRlcjogbnVsbCwKICAgIAogICAgLyoqCiAgICAqIFRoZSBNb3VzZSBJbnB1dCBtYW5hZ2VyLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Nb3VzZX0gbW91c2UgLSBUaGUgTW91c2UgSW5wdXQgbWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICBtb3VzZTogbnVsbCwKICAgIAogICAgLyoqCiAgICAqIFRoZSBLZXlib2FyZCBJbnB1dCBtYW5hZ2VyLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5LZXlib2FyZH0ga2V5Ym9hcmQgLSBUaGUgS2V5Ym9hcmQgSW5wdXQgbWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICBrZXlib2FyZDogbnVsbCwKICAgIAogICAgLyoqCiAgICAqIFRoZSBUb3VjaCBJbnB1dCBtYW5hZ2VyLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Ub3VjaH0gdG91Y2ggLSB0aGUgVG91Y2ggSW5wdXQgbWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0b3VjaDogbnVsbCwKICAgIAogICAgLyoqCiAgICAqIFRoZSBNU1BvaW50ZXIgSW5wdXQgbWFuYWdlci4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuTVNQb2ludGVyfSBtc3BvaW50ZXIgLSBUaGUgTVNQb2ludGVyIElucHV0IG1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgbXNwb2ludGVyOiBudWxsLAoKICAgIC8qKgogICAgICogVGhlIEdhbWVwYWQgSW5wdXQgbWFuYWdlci4KICAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWVwYWR9IGdhbWVwYWQgLSBUaGUgR2FtZXBhZCBJbnB1dCBtYW5hZ2VyLgogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgZ2FtZXBhZDogbnVsbCwKCiAgICAvKioKICAgICogQSBTaWduYWwgdGhhdCBpcyBkaXNwYXRjaGVkIGVhY2ggdGltZSBhIHBvaW50ZXIgaXMgcHJlc3NlZCBkb3duLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uRG93bgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIG9uRG93bjogbnVsbCwKICAgIAogICAgLyoqCiAgICAqIEEgU2lnbmFsIHRoYXQgaXMgZGlzcGF0Y2hlZCBlYWNoIHRpbWUgYSBwb2ludGVyIGlzIHJlbGVhc2VkLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uVXAKICAgICogQGRlZmF1bHQKICAgICovCiAgICBvblVwOiBudWxsLAogICAgCiAgICAvKioKICAgICogQSBTaWduYWwgdGhhdCBpcyBkaXNwYXRjaGVkIGVhY2ggdGltZSBhIHBvaW50ZXIgaXMgdGFwcGVkLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uVGFwCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgb25UYXA6IG51bGwsCiAgICAKICAgIC8qKgogICAgKiBBIFNpZ25hbCB0aGF0IGlzIGRpc3BhdGNoZWQgZWFjaCB0aW1lIGEgcG9pbnRlciBpcyBoZWxkIGRvd24uCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Ib2xkCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgb25Ib2xkOiBudWxsLAoKICAgIC8qKgogICAgKiBBIGxpbmtlZCBsaXN0IG9mIGludGVyYWN0aXZlIG9iamVjdHMsIHRoZSBJbnB1dEhhbmRsZXIgY29tcG9uZW50cyAoYmVsb25naW5nIHRvIFNwcml0ZXMpIHJlZ2lzdGVyIHRoZW1zZWx2ZXMgd2l0aCB0aGlzLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5MaW5rZWRMaXN0fSBpbnRlcmFjdGl2ZUl0ZW1zCiAgICAqLwogICAgaW50ZXJhY3RpdmVJdGVtczogbmV3IFBoYXNlci5MaW5rZWRMaXN0KCksCgogICAgLyoqCiAgICAqIFN0YXJ0cyB0aGUgSW5wdXQgTWFuYWdlciBydW5uaW5nLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCNib290CiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBib290OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMubW91c2VQb2ludGVyID0gbmV3IFBoYXNlci5Qb2ludGVyKHRoaXMuZ2FtZSwgMCk7CiAgICAgICAgdGhpcy5wb2ludGVyMSA9IG5ldyBQaGFzZXIuUG9pbnRlcih0aGlzLmdhbWUsIDEpOwogICAgICAgIHRoaXMucG9pbnRlcjIgPSBuZXcgUGhhc2VyLlBvaW50ZXIodGhpcy5nYW1lLCAyKTsKCiAgICAgICAgdGhpcy5tb3VzZSA9IG5ldyBQaGFzZXIuTW91c2UodGhpcy5nYW1lKTsKICAgICAgICB0aGlzLmtleWJvYXJkID0gbmV3IFBoYXNlci5LZXlib2FyZCh0aGlzLmdhbWUpOwogICAgICAgIHRoaXMudG91Y2ggPSBuZXcgUGhhc2VyLlRvdWNoKHRoaXMuZ2FtZSk7CiAgICAgICAgdGhpcy5tc3BvaW50ZXIgPSBuZXcgUGhhc2VyLk1TUG9pbnRlcih0aGlzLmdhbWUpOwogICAgICAgIHRoaXMuZ2FtZXBhZCA9IG5ldyBQaGFzZXIuR2FtZXBhZCh0aGlzLmdhbWUpOwoKICAgICAgICB0aGlzLm9uRG93biA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgdGhpcy5vblVwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICB0aGlzLm9uVGFwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICB0aGlzLm9uSG9sZCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgICAgIHRoaXMuc2NhbGUgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwogICAgICAgIHRoaXMuc3BlZWQgPSBuZXcgUGhhc2VyLlBvaW50KCk7CiAgICAgICAgdGhpcy5wb3NpdGlvbiA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKICAgICAgICB0aGlzLl9vbGRQb3NpdGlvbiA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAgICAgdGhpcy5jaXJjbGUgPSBuZXcgUGhhc2VyLkNpcmNsZSgwLCAwLCA0NCk7CgogICAgICAgIHRoaXMuYWN0aXZlUG9pbnRlciA9IHRoaXMubW91c2VQb2ludGVyOwogICAgICAgIHRoaXMuY3VycmVudFBvaW50ZXJzID0gMDsKCiAgICAgICAgdGhpcy5oaXRDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICB0aGlzLmhpdENhbnZhcy53aWR0aCA9IDE7CiAgICAgICAgdGhpcy5oaXRDYW52YXMuaGVpZ2h0ID0gMTsKICAgICAgICB0aGlzLmhpdENvbnRleHQgPSB0aGlzLmhpdENhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKICAgICAgICB0aGlzLm1vdXNlLnN0YXJ0KCk7CiAgICAgICAgdGhpcy5rZXlib2FyZC5zdGFydCgpOwogICAgICAgIHRoaXMudG91Y2guc3RhcnQoKTsKICAgICAgICB0aGlzLm1zcG9pbnRlci5zdGFydCgpOwogICAgICAgIHRoaXMubW91c2VQb2ludGVyLmFjdGl2ZSA9IHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgYWxsIG9mIHRoZSBJbnB1dCBNYW5hZ2VycyBmcm9tIHJ1bm5pbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMubW91c2Uuc3RvcCgpOwogICAgICAgIHRoaXMua2V5Ym9hcmQuc3RvcCgpOwogICAgICAgIHRoaXMudG91Y2guc3RvcCgpOwogICAgICAgIHRoaXMubXNwb2ludGVyLnN0b3AoKTsKICAgICAgICB0aGlzLmdhbWVwYWQuc3RvcCgpOwoKICAgICAgICB0aGlzLm1vdmVDYWxsYmFjayA9IG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyBhIGNhbGxiYWNrIHRoYXQgaXMgZmlyZWQgZXZlcnkgdGltZSB0aGUgYWN0aXZlUG9pbnRlciByZWNlaXZlcyBhIERPTSBtb3ZlIGV2ZW50IHN1Y2ggYXMgYSBtb3VzZW1vdmUgb3IgdG91Y2htb3ZlLgogICAgKiBJdCB3aWxsIGJlIGNhbGxlZCBldmVyeSB0aW1lIHRoZSBhY3RpdmVQb2ludGVyIG1vdmVzLCB3aGljaCBpbiBhIG11bHRpLXRvdWNoIGdhbWUgY2FuIGJlIGEgbG90IG9mIHRpbWVzLCBzbyB0aGlzIGlzIGJlc3QKICAgICogdG8gb25seSB1c2UgaWYgeW91J3ZlIGxpbWl0ZWQgaW5wdXQgdG8gYSBzaW5nbGUgcG9pbnRlciAoaS5lLiBtb3VzZSBvciB0b3VjaCkKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjc2V0TW92ZUNhbGxiYWNrCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGNhbGxiYWNrIHRoYXQgd2lsbCBiZSBjYWxsZWQgZWFjaCB0aW1lIHRoZSBhY3RpdmVQb2ludGVyIHJlY2VpdmVzIGEgRE9NIG1vdmUgZXZlbnQuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQuCiAgICAqLwogICAgc2V0TW92ZUNhbGxiYWNrOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKICAgICAgICB0aGlzLm1vdmVDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgIHRoaXMubW92ZUNhbGxiYWNrQ29udGV4dCA9IGNhbGxiYWNrQ29udGV4dDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgUG9pbnRlciBvYmplY3QgdG8gdGhlIElucHV0IE1hbmFnZXIuIEJ5IGRlZmF1bHQgSW5wdXQgY3JlYXRlcyAzIHBvaW50ZXIgb2JqZWN0czogbW91c2VQb2ludGVyLCBwb2ludGVyMSBhbmQgcG9pbnRlcjIuCiAgICAqIElmIHlvdSBuZWVkIG1vcmUgdGhlbiB1c2UgdGhpcyB0byBjcmVhdGUgYSBuZXcgb25lLCB1cCB0byBhIG1heGltdW0gb2YgMTAuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I2FkZFBvaW50ZXIKICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50ZXJ9IEEgcmVmZXJlbmNlIHRvIHRoZSBuZXcgUG9pbnRlciBvYmplY3QgdGhhdCB3YXMgY3JlYXRlZC4KICAgICovCiAgICBhZGRQb2ludGVyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBuZXh0ID0gMDsKCiAgICAgICAgZm9yICh2YXIgaSA9IDEwOyBpID4gMDsgaS0tKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXNbJ3BvaW50ZXInICsgaV0gPT09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5leHQgPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobmV4dCA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiWW91IGNhbiBvbmx5IGhhdmUgMTAgUG9pbnRlciBvYmplY3RzIik7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzWydwb2ludGVyJyArIG5leHRdID0gbmV3IFBoYXNlci5Qb2ludGVyKHRoaXMuZ2FtZSwgbmV4dCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzWydwb2ludGVyJyArIG5leHRdOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGVzIHRoZSBJbnB1dCBNYW5hZ2VyLiBDYWxsZWQgYnkgdGhlIGNvcmUgR2FtZSBsb29wLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCN1cGRhdGUKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5wb2xsUmF0ZSA+IDAgJiYgdGhpcy5fcG9sbENvdW50ZXIgPCB0aGlzLnBvbGxSYXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcG9sbENvdW50ZXIrKzsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zcGVlZC54ID0gdGhpcy5wb3NpdGlvbi54IC0gdGhpcy5fb2xkUG9zaXRpb24ueDsKICAgICAgICB0aGlzLnNwZWVkLnkgPSB0aGlzLnBvc2l0aW9uLnkgLSB0aGlzLl9vbGRQb3NpdGlvbi55OwoKICAgICAgICB0aGlzLl9vbGRQb3NpdGlvbi5jb3B5RnJvbSh0aGlzLnBvc2l0aW9uKTsKICAgICAgICB0aGlzLm1vdXNlUG9pbnRlci51cGRhdGUoKTsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZXBhZC5hY3RpdmUpIHsgdGhpcy5nYW1lcGFkLnVwZGF0ZSgpOyB9CgogICAgICAgIHRoaXMucG9pbnRlcjEudXBkYXRlKCk7CiAgICAgICAgdGhpcy5wb2ludGVyMi51cGRhdGUoKTsKCiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjMpIHsgdGhpcy5wb2ludGVyMy51cGRhdGUoKTsgfQogICAgICAgIGlmICh0aGlzLnBvaW50ZXI0KSB7IHRoaXMucG9pbnRlcjQudXBkYXRlKCk7IH0KICAgICAgICBpZiAodGhpcy5wb2ludGVyNSkgeyB0aGlzLnBvaW50ZXI1LnVwZGF0ZSgpOyB9CiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjYpIHsgdGhpcy5wb2ludGVyNi51cGRhdGUoKTsgfQogICAgICAgIGlmICh0aGlzLnBvaW50ZXI3KSB7IHRoaXMucG9pbnRlcjcudXBkYXRlKCk7IH0KICAgICAgICBpZiAodGhpcy5wb2ludGVyOCkgeyB0aGlzLnBvaW50ZXI4LnVwZGF0ZSgpOyB9CiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjkpIHsgdGhpcy5wb2ludGVyOS51cGRhdGUoKTsgfQogICAgICAgIGlmICh0aGlzLnBvaW50ZXIxMCkgeyB0aGlzLnBvaW50ZXIxMC51cGRhdGUoKTsgfQoKICAgICAgICB0aGlzLl9wb2xsQ291bnRlciA9IDA7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXNldCBhbGwgb2YgdGhlIFBvaW50ZXJzIGFuZCBJbnB1dCBzdGF0ZXMKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjcmVzZXQKICAgICogQHBhcmFtIHtib29sZWFufSBoYXJkIC0gQSBzb2Z0IHJlc2V0IChoYXJkID0gZmFsc2UpIHdvbid0IHJlc2V0IGFueSBTaWduYWxzIHRoYXQgbWlnaHQgYmUgYm91bmQuIEEgaGFyZCByZXNldCB3aWxsLgogICAgKi8KICAgIHJlc2V0OiBmdW5jdGlvbiAoaGFyZCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlzQm9vdGVkID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgaGFyZCA9PSAndW5kZWZpbmVkJykgeyBoYXJkID0gZmFsc2U7IH0KCiAgICAgICAgdGhpcy5rZXlib2FyZC5yZXNldCgpOwogICAgICAgIHRoaXMubW91c2VQb2ludGVyLnJlc2V0KCk7CiAgICAgICAgdGhpcy5nYW1lcGFkLnJlc2V0KCk7CgogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDw9IDEwOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpc1sncG9pbnRlcicgKyBpXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpc1sncG9pbnRlcicgKyBpXS5yZXNldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLmN1cnJlbnRQb2ludGVycyA9IDA7CgogICAgICAgIGlmICh0aGlzLmdhbWUuY2FudmFzLnN0eWxlLmN1cnNvciAhPT0gJ25vbmUnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhbnZhcy5zdHlsZS5jdXJzb3IgPSAnZGVmYXVsdCc7CiAgICAgICAgfQoKICAgICAgICBpZiAoaGFyZCA9PT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25Eb3duLmRpc3Bvc2UoKTsKICAgICAgICAgICAgdGhpcy5vblVwLmRpc3Bvc2UoKTsKICAgICAgICAgICAgdGhpcy5vblRhcC5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25Ib2xkLmRpc3Bvc2UoKTsKICAgICAgICAgICAgdGhpcy5vbkRvd24gPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgICAgICAgICB0aGlzLm9uVXAgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgICAgICAgICB0aGlzLm9uVGFwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICAgICAgdGhpcy5vbkhvbGQgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgICAgICAgICAgdGhpcy5pbnRlcmFjdGl2ZUl0ZW1zLmNhbGxBbGwoJ3Jlc2V0Jyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9wb2xsQ291bnRlciA9IDA7CgogICAgfSwKCiAgICAvKioKICAgICogUmVzZXRzIHRoZSBzcGVlZCBhbmQgb2xkIHBvc2l0aW9uIHByb3BlcnRpZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I3Jlc2V0U3BlZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBTZXRzIHRoZSBvbGRQb3NpdGlvbi54IHZhbHVlLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFNldHMgdGhlIG9sZFBvc2l0aW9uLnkgdmFsdWUuCiAgICAqLwogICAgcmVzZXRTcGVlZDogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgdGhpcy5fb2xkUG9zaXRpb24uc2V0VG8oeCwgeSk7CiAgICAgICAgdGhpcy5zcGVlZC5zZXRUbygwLCAwKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBGaW5kIHRoZSBmaXJzdCBmcmVlIFBvaW50ZXIgb2JqZWN0IGFuZCBzdGFydCBpdCwgcGFzc2luZyBpbiB0aGUgZXZlbnQgZGF0YS4gVGhpcyBpcyBjYWxsZWQgYXV0b21hdGljYWxseSBieSBQaGFzZXIuVG91Y2ggYW5kIFBoYXNlci5NU1BvaW50ZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I3N0YXJ0UG9pbnRlcgogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQgLSBUaGUgZXZlbnQgZGF0YSBmcm9tIHRoZSBUb3VjaCBldmVudC4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50ZXJ9IFRoZSBQb2ludGVyIG9iamVjdCB0aGF0IHdhcyBzdGFydGVkIG9yIG51bGwgaWYgbm8gUG9pbnRlciBvYmplY3QgaXMgYXZhaWxhYmxlLgogICAgKi8KICAgIHN0YXJ0UG9pbnRlcjogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLm1heFBvaW50ZXJzIDwgMTAgJiYgdGhpcy50b3RhbEFjdGl2ZVBvaW50ZXJzID09IHRoaXMubWF4UG9pbnRlcnMpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnBvaW50ZXIxLmFjdGl2ZSA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVyMS5zdGFydChldmVudCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMucG9pbnRlcjIuYWN0aXZlID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIyLnN0YXJ0KGV2ZW50KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDM7IGkgPD0gMTA7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXNbJ3BvaW50ZXInICsgaV0gJiYgdGhpc1sncG9pbnRlcicgKyBpXS5hY3RpdmUgPT09IGZhbHNlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWydwb2ludGVyJyArIGldLnN0YXJ0KGV2ZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlcyB0aGUgbWF0Y2hpbmcgUG9pbnRlciBvYmplY3QsIHBhc3NpbmcgaW4gdGhlIGV2ZW50IGRhdGEuIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgYW5kIHNob3VsZCBub3Qgbm9ybWFsbHkgbmVlZCB0byBiZSBpbnZva2VkLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCN1cGRhdGVQb2ludGVyCiAgICAqIEBwYXJhbSB7QW55fSBldmVudCAtIFRoZSBldmVudCBkYXRhIGZyb20gdGhlIFRvdWNoIGV2ZW50LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnRlcn0gVGhlIFBvaW50ZXIgb2JqZWN0IHRoYXQgd2FzIHVwZGF0ZWQgb3IgbnVsbCBpZiBubyBQb2ludGVyIG9iamVjdCBpcyBhdmFpbGFibGUuCiAgICAqLwogICAgdXBkYXRlUG9pbnRlcjogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLnBvaW50ZXIxLmFjdGl2ZSAmJiB0aGlzLnBvaW50ZXIxLmlkZW50aWZpZXIgPT0gZXZlbnQuaWRlbnRpZmllcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIxLm1vdmUoZXZlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnBvaW50ZXIyLmFjdGl2ZSAmJiB0aGlzLnBvaW50ZXIyLmlkZW50aWZpZXIgPT0gZXZlbnQuaWRlbnRpZmllcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIyLm1vdmUoZXZlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMzsgaSA8PSAxMDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpc1sncG9pbnRlcicgKyBpXSAmJiB0aGlzWydwb2ludGVyJyArIGldLmFjdGl2ZSAmJiB0aGlzWydwb2ludGVyJyArIGldLmlkZW50aWZpZXIgPT0gZXZlbnQuaWRlbnRpZmllcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1sncG9pbnRlcicgKyBpXS5tb3ZlKGV2ZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgdGhlIG1hdGNoaW5nIFBvaW50ZXIgb2JqZWN0LCBwYXNzaW5nIGluIHRoZSBldmVudCBkYXRhLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCNzdG9wUG9pbnRlcgogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQgLSBUaGUgZXZlbnQgZGF0YSBmcm9tIHRoZSBUb3VjaCBldmVudC4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50ZXJ9IFRoZSBQb2ludGVyIG9iamVjdCB0aGF0IHdhcyBzdG9wcGVkIG9yIG51bGwgaWYgbm8gUG9pbnRlciBvYmplY3QgaXMgYXZhaWxhYmxlLgogICAgKi8KICAgIHN0b3BQb2ludGVyOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjEuYWN0aXZlICYmIHRoaXMucG9pbnRlcjEuaWRlbnRpZmllciA9PSBldmVudC5pZGVudGlmaWVyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjEuc3RvcChldmVudCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMucG9pbnRlcjIuYWN0aXZlICYmIHRoaXMucG9pbnRlcjIuaWRlbnRpZmllciA9PSBldmVudC5pZGVudGlmaWVyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjIuc3RvcChldmVudCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAzOyBpIDw9IDEwOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzWydwb2ludGVyJyArIGldICYmIHRoaXNbJ3BvaW50ZXInICsgaV0uYWN0aXZlICYmIHRoaXNbJ3BvaW50ZXInICsgaV0uaWRlbnRpZmllciA9PSBldmVudC5pZGVudGlmaWVyKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWydwb2ludGVyJyArIGldLnN0b3AoZXZlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgdGhlIG5leHQgUG9pbnRlciBvYmplY3Qgd2hvcyBhY3RpdmUgcHJvcGVydHkgbWF0Y2hlcyB0aGUgZ2l2ZW4gc3RhdGUKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjZ2V0UG9pbnRlcgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHN0YXRlIC0gVGhlIHN0YXRlIHRoZSBQb2ludGVyIHNob3VsZCBiZSBpbiAoZmFsc2UgZm9yIGluYWN0aXZlLCB0cnVlIGZvciBhY3RpdmUpLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnRlcn0gQSBQb2ludGVyIG9iamVjdCBvciBudWxsIGlmIG5vIFBvaW50ZXIgb2JqZWN0IG1hdGNoZXMgdGhlIHJlcXVlc3RlZCBzdGF0ZS4KICAgICovCiAgICBnZXRQb2ludGVyOiBmdW5jdGlvbiAoc3RhdGUpIHsKCiAgICAgICAgc3RhdGUgPSBzdGF0ZSB8fCBmYWxzZTsKCiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjEuYWN0aXZlID09IHN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjE7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMucG9pbnRlcjIuYWN0aXZlID09IHN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjI7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAzOyBpIDw9IDEwOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzWydwb2ludGVyJyArIGldICYmIHRoaXNbJ3BvaW50ZXInICsgaV0uYWN0aXZlID09IHN0YXRlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWydwb2ludGVyJyArIGldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgdGhlIFBvaW50ZXIgb2JqZWN0IHdob3MgaWRlbnRpZmllZCBwcm9wZXJ0eSBtYXRjaGVzIHRoZSBnaXZlbiBpZGVudGlmaWVyIHZhbHVlLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCNnZXRQb2ludGVyRnJvbUlkZW50aWZpZXIKICAgICogQHBhcmFtIHtudW1iZXJ9IGlkZW50aWZpZXIgLSBUaGUgUG9pbnRlci5pZGVudGlmaWVyIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludGVyfSBBIFBvaW50ZXIgb2JqZWN0IG9yIG51bGwgaWYgbm8gUG9pbnRlciBvYmplY3QgbWF0Y2hlcyB0aGUgcmVxdWVzdGVkIGlkZW50aWZpZXIuCiAgICAqLwogICAgZ2V0UG9pbnRlckZyb21JZGVudGlmaWVyOiBmdW5jdGlvbiAoaWRlbnRpZmllcikgewoKICAgICAgICBpZiAodGhpcy5wb2ludGVyMS5pZGVudGlmaWVyID09IGlkZW50aWZpZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVyMTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5wb2ludGVyMi5pZGVudGlmaWVyID09IGlkZW50aWZpZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVyMjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDM7IGkgPD0gMTA7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXNbJ3BvaW50ZXInICsgaV0gJiYgdGhpc1sncG9pbnRlcicgKyBpXS5pZGVudGlmaWVyID09IGlkZW50aWZpZXIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ3BvaW50ZXInICsgaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0KCn07CgpQaGFzZXIuSW5wdXQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLklucHV0OwoKLyoqCiogVGhlIFggY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnRseSBhY3RpdmUgcG9pbnRlci4gVGhpcyB2YWx1ZSB0YWtlcyBnYW1lIHNjYWxpbmcgaW50byBhY2NvdW50IGF1dG9tYXRpY2FsbHkuIFNlZSBQb2ludGVyLnNjcmVlblgvY2xpZW50WCBmb3Igc291cmNlIHZhbHVlcy4KKiBAbmFtZSBQaGFzZXIuSW5wdXQjeAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIFggY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnRseSBhY3RpdmUgcG9pbnRlci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5JbnB1dC5wcm90b3R5cGUsICJ4IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl94OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX3ggPSBNYXRoLmZsb29yKHZhbHVlKTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIFkgY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnRseSBhY3RpdmUgcG9pbnRlci4gVGhpcyB2YWx1ZSB0YWtlcyBnYW1lIHNjYWxpbmcgaW50byBhY2NvdW50IGF1dG9tYXRpY2FsbHkuIFNlZSBQb2ludGVyLnNjcmVlblkvY2xpZW50WSBmb3Igc291cmNlIHZhbHVlcy4KKiBAbmFtZSBQaGFzZXIuSW5wdXQjeQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIFkgY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnRseSBhY3RpdmUgcG9pbnRlci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5JbnB1dC5wcm90b3R5cGUsICJ5IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5feTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLl95ID0gTWF0aC5mbG9vcih2YWx1ZSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5JbnB1dCNwb2xsTG9ja2VkCiogQHByb3BlcnR5IHtib29sZWFufSBwb2xsTG9ja2VkIC0gVHJ1ZSBpZiB0aGUgSW5wdXQgaXMgY3VycmVudGx5IHBvbGwgcmF0ZSBsb2NrZWQuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuSW5wdXQucHJvdG90eXBlLCAicG9sbExvY2tlZCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKHRoaXMucG9sbFJhdGUgPiAwICYmIHRoaXMuX3BvbGxDb3VudGVyIDwgdGhpcy5wb2xsUmF0ZSk7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB0b3RhbCBudW1iZXIgb2YgaW5hY3RpdmUgUG9pbnRlcnMKKiBAbmFtZSBQaGFzZXIuSW5wdXQjdG90YWxJbmFjdGl2ZVBvaW50ZXJzCiogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsSW5hY3RpdmVQb2ludGVycyAtIFRoZSB0b3RhbCBudW1iZXIgb2YgaW5hY3RpdmUgUG9pbnRlcnMuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuSW5wdXQucHJvdG90eXBlLCAidG90YWxJbmFjdGl2ZVBvaW50ZXJzIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAxMCAtIHRoaXMuY3VycmVudFBvaW50ZXJzOwogICAgfQoKfSk7CgovKioKKiBUaGUgdG90YWwgbnVtYmVyIG9mIGFjdGl2ZSBQb2ludGVycwoqIEBuYW1lIFBoYXNlci5JbnB1dCN0b3RhbEFjdGl2ZVBvaW50ZXJzCiogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsQWN0aXZlUG9pbnRlcnMgLSBUaGUgdG90YWwgbnVtYmVyIG9mIGFjdGl2ZSBQb2ludGVycy4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5JbnB1dC5wcm90b3R5cGUsICJ0b3RhbEFjdGl2ZVBvaW50ZXJzIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5jdXJyZW50UG9pbnRlcnMgPSAwOwoKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8PSAxMDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXNbJ3BvaW50ZXInICsgaV0gJiYgdGhpc1sncG9pbnRlcicgKyBpXS5hY3RpdmUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFBvaW50ZXJzKys7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRQb2ludGVyczsKCiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB3b3JsZCBYIGNvb3JkaW5hdGUgb2YgdGhlIG1vc3QgcmVjZW50bHkgYWN0aXZlIHBvaW50ZXIuCiogQG5hbWUgUGhhc2VyLklucHV0I3dvcmxkWAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3b3JsZFggLSBUaGUgd29ybGQgWCBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudGx5IGFjdGl2ZSBwb2ludGVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLklucHV0LnByb3RvdHlwZSwgIndvcmxkWCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLmNhbWVyYS52aWV3LnggKyB0aGlzLng7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB3b3JsZCBZIGNvb3JkaW5hdGUgb2YgdGhlIG1vc3QgcmVjZW50bHkgYWN0aXZlIHBvaW50ZXIuCiogQG5hbWUgUGhhc2VyLklucHV0I3dvcmxkWQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3b3JsZFkgLSBUaGUgd29ybGQgWSBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudGx5IGFjdGl2ZSBwb2ludGVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLklucHV0LnByb3RvdHlwZSwgIndvcmxkWSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLmNhbWVyYS52aWV3LnkgKyB0aGlzLnk7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEBjbGFzcyBQaGFzZXIuS2V5CiogQGNsYXNzZGVzYyBJZiB5b3UgbmVlZCBtb3JlIGZpbmUtZ3JhaW5lZCBjb250cm9sIG92ZXIgdGhlIGhhbmRsaW5nIG9mIHNwZWNpZmljIGtleXMgeW91IGNhbiBjcmVhdGUgYW5kIHVzZSBQaGFzZXIuS2V5IG9iamVjdHMuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKiBAcGFyYW0ge251bWJlcn0ga2V5Y29kZSAtIFRoZSBrZXkgY29kZSB0aGlzIEtleSBpcyByZXNwb25zaWJsZSBmb3IuCiovClBoYXNlci5LZXkgPSBmdW5jdGlvbiAoZ2FtZSwga2V5Y29kZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuIAogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNEb3duIC0gVGhlICJkb3duIiBzdGF0ZSBvZiB0aGUga2V5LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNEb3duID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNVcCAtIFRoZSAidXAiIHN0YXRlIG9mIHRoZSBrZXkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc1VwID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWx0S2V5IC0gVGhlIGRvd24gc3RhdGUgb2YgdGhlIEFMVCBrZXksIGlmIHByZXNzZWQgYXQgdGhlIHNhbWUgdGltZSBhcyB0aGlzIGtleS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFsdEtleSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGN0cmxLZXkgLSBUaGUgZG93biBzdGF0ZSBvZiB0aGUgQ1RSTCBrZXksIGlmIHByZXNzZWQgYXQgdGhlIHNhbWUgdGltZSBhcyB0aGlzIGtleS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmN0cmxLZXkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBzaGlmdEtleSAtIFRoZSBkb3duIHN0YXRlIG9mIHRoZSBTSElGVCBrZXksIGlmIHByZXNzZWQgYXQgdGhlIHNhbWUgdGltZSBhcyB0aGlzIGtleS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNoaWZ0S2V5ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lRG93biAtIFRoZSB0aW1lc3RhbXAgd2hlbiB0aGUga2V5IHdhcyBsYXN0IHByZXNzZWQgZG93bi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRpbWVEb3duID0gMDsKCiAgICAvKioKICAgICogSWYgdGhlIGtleSBpcyBkb3duIHRoaXMgdmFsdWUgaG9sZHMgdGhlIGR1cmF0aW9uIG9mIHRoYXQga2V5IHByZXNzIGFuZCBpcyBjb25zdGFudGx5IHVwZGF0ZWQuCiAgICAqIElmIHRoZSBrZXkgaXMgdXAgaXQgaG9sZHMgdGhlIGR1cmF0aW9uIG9mIHRoZSBwcmV2aW91cyBkb3duIHNlc3Npb24uCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkdXJhdGlvbiAtIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRoaXMga2V5IGhhcyBiZWVuIGhlbGQgZG93biBmb3IuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kdXJhdGlvbiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lVXAgLSBUaGUgdGltZXN0YW1wIHdoZW4gdGhlIGtleSB3YXMgbGFzdCByZWxlYXNlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRpbWVVcCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZXBlYXRzIC0gSWYgYSBrZXkgaXMgaGVsZCBkb3duIHRoaXMgaG9sZHMgZG93biB0aGUgbnVtYmVyIG9mIHRpbWVzIHRoZSBrZXkgaGFzICdyZXBlYXRlZCcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5yZXBlYXRzID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGtleUNvZGUgLSBUaGUga2V5Y29kZSBvZiB0aGlzIGtleS4KICAgICovCiAgICB0aGlzLmtleUNvZGUgPSBrZXljb2RlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uRG93biAtIFRoaXMgU2lnbmFsIGlzIGRpc3BhdGNoZWQgZXZlcnkgdGltZSB0aGlzIEtleSBpcyBwcmVzc2VkIGRvd24uIEl0IGlzIG9ubHkgZGlzcGF0Y2hlZCBvbmNlICh1bnRpbCB0aGUga2V5IGlzIHJlbGVhc2VkIGFnYWluKS4KICAgICovCiAgICB0aGlzLm9uRG93biA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25VcCAtIFRoaXMgU2lnbmFsIGlzIGRpc3BhdGNoZWQgZXZlcnkgdGltZSB0aGlzIEtleSBpcyBwcmVzc2VkIGRvd24uIEl0IGlzIG9ubHkgZGlzcGF0Y2hlZCBvbmNlICh1bnRpbCB0aGUga2V5IGlzIHJlbGVhc2VkIGFnYWluKS4KICAgICovCiAgICB0aGlzLm9uVXAgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgCn07CgpQaGFzZXIuS2V5LnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQ2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgUGhhc2VyLktleWJvYXJkLgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXkjcHJvY2Vzc0tleURvd24KICAgICogQHBhcmFtIHtLZXlib2FyZEV2ZW50fSBldmVudC4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHByb2Nlc3NLZXlEb3duOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5hbHRLZXkgPSBldmVudC5hbHRLZXk7CiAgICAgICAgdGhpcy5jdHJsS2V5ID0gZXZlbnQuY3RybEtleTsKICAgICAgICB0aGlzLnNoaWZ0S2V5ID0gZXZlbnQuc2hpZnRLZXk7CgogICAgICAgIGlmICh0aGlzLmlzRG93bikKICAgICAgICB7CiAgICAgICAgICAgIC8vICBLZXkgd2FzIGFscmVhZHkgaGVsZCBkb3duLCB0aGlzIG11c3QgYmUgYSByZXBlYXQgcmF0ZSBiYXNlZCBldmVudAogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gZXZlbnQudGltZVN0YW1wIC0gdGhpcy50aW1lRG93bjsKICAgICAgICAgICAgdGhpcy5yZXBlYXRzKys7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuaXNEb3duID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pc1VwID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMudGltZURvd24gPSBldmVudC50aW1lU3RhbXA7CiAgICAgICAgICAgIHRoaXMuZHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLnJlcGVhdHMgPSAwOwoKICAgICAgICAgICAgdGhpcy5vbkRvd24uZGlzcGF0Y2godGhpcyk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IFBoYXNlci5LZXlib2FyZC4KICAgICogQG1ldGhvZCBQaGFzZXIuS2V5I3Byb2Nlc3NLZXlVcAogICAgKiBAcGFyYW0ge0tleWJvYXJkRXZlbnR9IGV2ZW50LgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcHJvY2Vzc0tleVVwOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5pc0Rvd24gPSBmYWxzZTsKICAgICAgICB0aGlzLmlzVXAgPSB0cnVlOwogICAgICAgIHRoaXMudGltZVVwID0gZXZlbnQudGltZVN0YW1wOwoKICAgICAgICB0aGlzLm9uVXAuZGlzcGF0Y2godGhpcyk7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgImp1c3QgcHJlc3NlZCIgc3RhdGUgb2YgdGhlIEtleS4gSnVzdCBwcmVzc2VkIGlzIGNvbnNpZGVyZWQgdHJ1ZSBpZiB0aGUga2V5IHdhcyBwcmVzc2VkIGRvd24gd2l0aGluIHRoZSBkdXJhdGlvbiBnaXZlbiAoZGVmYXVsdCAyNTBtcykKICAgICogQG1ldGhvZCBQaGFzZXIuS2V5I2p1c3RQcmVzc2VkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZHVyYXRpb249MjUwXSAtIFRoZSBkdXJhdGlvbiBiZWxvdyB3aGljaCB0aGUga2V5IGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcganVzdCBwcmVzc2VkLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBrZXkgaXMganVzdCBwcmVzc2VkIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBqdXN0UHJlc3NlZDogZnVuY3Rpb24gKGR1cmF0aW9uKSB7CgogICAgICAgIGlmICh0eXBlb2YgZHVyYXRpb24gPT09ICJ1bmRlZmluZWQiKSB7IGR1cmF0aW9uID0gMjUwOyB9CgogICAgICAgIHJldHVybiAodGhpcy5pc0Rvd24gJiYgdGhpcy5kdXJhdGlvbiA8IGR1cmF0aW9uKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSAianVzdCByZWxlYXNlZCIgc3RhdGUgb2YgdGhlIEtleS4gSnVzdCByZWxlYXNlZCBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIHRydWUgaWYgdGhlIGtleSB3YXMgcmVsZWFzZWQgd2l0aGluIHRoZSBkdXJhdGlvbiBnaXZlbiAoZGVmYXVsdCAyNTBtcykKICAgICogQG1ldGhvZCBQaGFzZXIuS2V5I2p1c3RQcmVzc2VkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZHVyYXRpb249MjUwXSAtIFRoZSBkdXJhdGlvbiBiZWxvdyB3aGljaCB0aGUga2V5IGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcganVzdCByZWxlYXNlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUga2V5IGlzIGp1c3QgcmVsZWFzZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGp1c3RSZWxlYXNlZDogZnVuY3Rpb24gKGR1cmF0aW9uKSB7CgogICAgICAgIGlmICh0eXBlb2YgZHVyYXRpb24gPT09ICJ1bmRlZmluZWQiKSB7IGR1cmF0aW9uID0gMjUwOyB9CgogICAgICAgIHJldHVybiAodGhpcy5pc0Rvd24gPT09IGZhbHNlICYmICh0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLnRpbWVVcCA8IGR1cmF0aW9uKSk7CgogICAgfQoKfTsKClBoYXNlci5LZXkucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLktleTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBLZXlib2FyZCBjbGFzcyBoYW5kbGVzIGxvb2tpbmcgYWZ0ZXIga2V5Ym9hcmQgaW5wdXQgZm9yIHlvdXIgZ2FtZS4gSXQgd2lsbCByZWNvZ25pc2UgYW5kIHJlc3BvbmQgdG8ga2V5IHByZXNzZXMgYW5kIGRpc3BhdGNoIHRoZSByZXF1aXJlZCBldmVudHMuCioKKiBAY2xhc3MgUGhhc2VyLktleWJvYXJkCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuS2V5Ym9hcmQgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfa2V5cyAtIFRoZSBvYmplY3QgdGhlIGtleSB2YWx1ZXMgYXJlIHN0b3JlZCBpbi4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9rZXlzID0ge307CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX2hvdGtleXMgLSBUaGUgb2JqZWN0IHRoZSBob3Qga2V5cyBhcmUgc3RvcmVkIGluLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2hvdGtleXMgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF9jYXB0dXJlIC0gVGhlIG9iamVjdCB0aGUga2V5IGNhcHR1cmUgdmFsdWVzIGFyZSBzdG9yZWQgaW4uCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fY2FwdHVyZSA9IHt9OwoKICAgIC8qKgogICAgKiBZb3UgY2FuIGRpc2FibGUgYWxsIEtleWJvYXJkIElucHV0IGJ5IHNldHRpbmcgZGlzYWJsZWQgdG8gdHJ1ZS4gV2hpbGUgdHJ1ZSBhbGwgbmV3IGlucHV0IHJlbGF0ZWQgZXZlbnRzIHdpbGwgYmUgaWdub3JlZC4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBkaXNhYmxlZCAtIFRoZSBkaXNhYmxlZCBzdGF0ZSBvZiB0aGUgS2V5Ym9hcmQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kaXNhYmxlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25LZXlEb3duCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb25LZXlEb3duID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vbktleVVwCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb25LZXlVcCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCB1bmRlciB3aGljaCB0aGUgY2FsbGJhY2tzIGFyZSBydW4uCiAgICAqLwogICAgdGhpcy5jYWxsYmFja0NvbnRleHQgPSB0aGlzOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvbkRvd25DYWxsYmFjayAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIGEga2V5IGlzIHByZXNzZWQgZG93bi4KICAgICovCiAgICB0aGlzLm9uRG93bkNhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25VcENhbGxiYWNrIC0gVGhpcyBjYWxsYmFjayBpcyBpbnZva2VkIGV2ZXJ5IHRpbWUgYSBrZXkgaXMgcmVsZWFzZWQuCiAgICAqLwogICAgdGhpcy5vblVwQ2FsbGJhY2sgPSBudWxsOwogICAgCn07CgpQaGFzZXIuS2V5Ym9hcmQucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBBZGQgY2FsbGJhY2tzIHRvIHRoZSBLZXlib2FyZCBoYW5kbGVyIHNvIHRoYXQgZWFjaCB0aW1lIGEga2V5IGlzIHByZXNzZWQgZG93biBvciByZWxlYXNlcyB0aGUgY2FsbGJhY2tzIGFyZSBhY3RpdmF0ZWQuCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI2FkZENhbGxiYWNrcwogICAgKiBAcGFyYW0ge09iamVjdH0gY29udGV4dCAtIFRoZSBjb250ZXh0IHVuZGVyIHdoaWNoIHRoZSBjYWxsYmFja3MgYXJlIHJ1bi4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gb25Eb3duIC0gVGhpcyBjYWxsYmFjayBpcyBpbnZva2VkIGV2ZXJ5IHRpbWUgYSBrZXkgaXMgcHJlc3NlZCBkb3duLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbb25VcD1udWxsXSAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIGEga2V5IGlzIHJlbGVhc2VkLgogICAgKi8KICAgIGFkZENhbGxiYWNrczogZnVuY3Rpb24gKGNvbnRleHQsIG9uRG93biwgb25VcCkgewoKICAgICAgICB0aGlzLmNhbGxiYWNrQ29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgdGhpcy5vbkRvd25DYWxsYmFjayA9IG9uRG93bjsKCiAgICAgICAgaWYgKHR5cGVvZiBvblVwICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25VcENhbGxiYWNrID0gb25VcDsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSWYgeW91IG5lZWQgbW9yZSBmaW5lLWdyYWluZWQgY29udHJvbCBvdmVyIGEgS2V5IHlvdSBjYW4gY3JlYXRlIGEgbmV3IFBoYXNlci5LZXkgb2JqZWN0IHZpYSB0aGlzIG1ldGhvZC4KICAgICogVGhlIEtleSBvYmplY3QgY2FuIHRoZW4gYmUgcG9sbGVkLCBoYXZlIGV2ZW50cyBhdHRhY2hlZCB0byBpdCwgZXRjLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNhZGRLZXkKICAgICogQHBhcmFtIHtudW1iZXJ9IGtleWNvZGUgLSBUaGUga2V5Y29kZSBvZiB0aGUga2V5LCBpLmUuIFBoYXNlci5LZXlib2FyZC5VUCBvciBQaGFzZXIuS2V5Ym9hcmQuU1BBQ0VCQVIKICAgICogQHJldHVybiB7UGhhc2VyLktleX0gVGhlIEtleSBvYmplY3Qgd2hpY2ggeW91IGNhbiBzdG9yZSBsb2NhbGx5IGFuZCByZWZlcmVuY2UgZGlyZWN0bHkuCiAgICAqLwogICAgYWRkS2V5OiBmdW5jdGlvbiAoa2V5Y29kZSkgewoKICAgICAgICB0aGlzLl9ob3RrZXlzW2tleWNvZGVdID0gbmV3IFBoYXNlci5LZXkodGhpcy5nYW1lLCBrZXljb2RlKTsKCiAgICAgICAgdGhpcy5hZGRLZXlDYXB0dXJlKGtleWNvZGUpOwoKICAgICAgICByZXR1cm4gdGhpcy5faG90a2V5c1trZXljb2RlXTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGEgS2V5IG9iamVjdCBmcm9tIHRoZSBLZXlib2FyZCBtYW5hZ2VyLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNyZW1vdmVLZXkKICAgICogQHBhcmFtIHtudW1iZXJ9IGtleWNvZGUgLSBUaGUga2V5Y29kZSBvZiB0aGUga2V5IHRvIHJlbW92ZSwgaS5lLiBQaGFzZXIuS2V5Ym9hcmQuVVAgb3IgUGhhc2VyLktleWJvYXJkLlNQQUNFQkFSCiAgICAqLwogICAgcmVtb3ZlS2V5OiBmdW5jdGlvbiAoa2V5Y29kZSkgewoKICAgICAgICBkZWxldGUgKHRoaXMuX2hvdGtleXNba2V5Y29kZV0pOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYW5kIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgNCBob3RrZXlzIGZvciBVcCwgRG93biwgTGVmdCBhbmQgUmlnaHQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI2NyZWF0ZUN1cnNvcktleXMKICAgICogQHJldHVybiB7b2JqZWN0fSBBbiBvYmplY3QgY29udGFpbmluZyBwcm9wZXJ0aWVzOiB1cCwgZG93biwgbGVmdCBhbmQgcmlnaHQuIFdoaWNoIGNhbiBiZSBwb2xsZWQgbGlrZSBhbnkgb3RoZXIgUGhhc2VyLktleSBvYmplY3QuCiAgICAqLwogICAgY3JlYXRlQ3Vyc29yS2V5czogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB1cDogdGhpcy5hZGRLZXkoUGhhc2VyLktleWJvYXJkLlVQKSwKICAgICAgICAgICAgZG93bjogdGhpcy5hZGRLZXkoUGhhc2VyLktleWJvYXJkLkRPV04pLAogICAgICAgICAgICBsZWZ0OiB0aGlzLmFkZEtleShQaGFzZXIuS2V5Ym9hcmQuTEVGVCksCiAgICAgICAgICAgIHJpZ2h0OiB0aGlzLmFkZEtleShQaGFzZXIuS2V5Ym9hcmQuUklHSFQpCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0YXJ0cyB0aGUgS2V5Ym9hcmQgZXZlbnQgbGlzdGVuZXJzIHJ1bm5pbmcgKGtleWRvd24gYW5kIGtleXVwKS4gVGhleSBhcmUgYXR0YWNoZWQgdG8gdGhlIGRvY3VtZW50LmJvZHkuCiAgICAqIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgUGhhc2VyLklucHV0IGFuZCBzaG91bGQgbm90IG5vcm1hbGx5IGJlIGludm9rZWQgZGlyZWN0bHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI3N0YXJ0CiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgdGhpcy5fb25LZXlEb3duID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBfdGhpcy5wcm9jZXNzS2V5RG93bihldmVudCk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5fb25LZXlVcCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMucHJvY2Vzc0tleVVwKGV2ZW50KTsKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMuX29uS2V5RG93biwgZmFsc2UpOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIHRoaXMuX29uS2V5VXAsIGZhbHNlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wcyB0aGUgS2V5Ym9hcmQgZXZlbnQgbGlzdGVuZXJzIGZyb20gcnVubmluZyAoa2V5ZG93biBhbmQga2V5dXApLiBUaGV5IGFyZSByZW1vdmVkIGZyb20gdGhlIGRvY3VtZW50LmJvZHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI3N0b3AKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5fb25LZXlEb3duKTsKICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5dXAnLCB0aGlzLl9vbktleVVwKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBCeSBkZWZhdWx0IHdoZW4gYSBrZXkgaXMgcHJlc3NlZCBQaGFzZXIgd2lsbCBub3Qgc3RvcCB0aGUgZXZlbnQgZnJvbSBwcm9wYWdhdGluZyB1cCB0byB0aGUgYnJvd3Nlci4KICAgICogVGhlcmUgYXJlIHNvbWUga2V5cyB0aGlzIGNhbiBiZSBhbm5veWluZyBmb3IsIGxpa2UgdGhlIGFycm93IGtleXMgb3Igc3BhY2UgYmFyLCB3aGljaCBtYWtlIHRoZSBicm93c2VyIHdpbmRvdyBzY3JvbGwuCiAgICAqIFlvdSBjYW4gdXNlIGFkZEtleUNhcHR1cmUgdG8gY29uc3VtZSB0aGUga2V5Ym9hcmQgZXZlbnQgZm9yIHNwZWNpZmljIGtleXMgc28gaXQgZG9lc24ndCBidWJibGUgdXAgdG8gdGhlIHRoZSBicm93c2VyLgogICAgKiBQYXNzIGluIGVpdGhlciBhIHNpbmdsZSBrZXljb2RlIG9yIGFuIGFycmF5L2hhc2ggb2Yga2V5Y29kZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI2FkZEtleUNhcHR1cmUKICAgICogQHBhcmFtIHtBbnl9IGtleWNvZGUKICAgICovCiAgICBhZGRLZXlDYXB0dXJlOiBmdW5jdGlvbiAoa2V5Y29kZSkgewoKICAgICAgICBpZiAodHlwZW9mIGtleWNvZGUgPT09ICdvYmplY3QnKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGtleWNvZGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NhcHR1cmVba2V5Y29kZVtrZXldXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fY2FwdHVyZVtrZXljb2RlXSA9IHRydWU7CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlcyBhbiBleGlzdGluZyBrZXkgY2FwdHVyZS4KICAgICogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjcmVtb3ZlS2V5Q2FwdHVyZQogICAgKiBAcGFyYW0ge251bWJlcn0ga2V5Y29kZQogICAgKi8KICAgIHJlbW92ZUtleUNhcHR1cmU6IGZ1bmN0aW9uIChrZXljb2RlKSB7CgogICAgICAgIGRlbGV0ZSB0aGlzLl9jYXB0dXJlW2tleWNvZGVdOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENsZWFyIGFsbCBzZXQga2V5IGNhcHR1cmVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNjbGVhckNhcHR1cmVzCiAgICAqLwogICAgY2xlYXJDYXB0dXJlczogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9jYXB0dXJlID0ge307CgogICAgfSwKCiAgICAvKioKICAgICogUHJvY2VzcyB0aGUga2V5ZG93biBldmVudC4KICAgICogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjcHJvY2Vzc0tleURvd24KICAgICogQHBhcmFtIHtLZXlib2FyZEV2ZW50fSBldmVudAogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcHJvY2Vzc0tleURvd246IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fY2FwdHVyZVtldmVudC5rZXlDb2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5vbkRvd25DYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25Eb3duQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0gJiYgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXS5pc0Rvd24pCiAgICAgICAgewogICAgICAgICAgICAvLyAgS2V5IGFscmVhZHkgZG93biBhbmQgc3RpbGwgZG93biwgc28gdXBkYXRlCiAgICAgICAgICAgIHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0uZHVyYXRpb24gPSB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdLnRpbWVEb3duOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoIXRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBOb3QgdXNlZCB0aGlzIGtleSBiZWZvcmUsIHNvIHJlZ2lzdGVyIGl0CiAgICAgICAgICAgICAgICB0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdID0gewogICAgICAgICAgICAgICAgICAgIGlzRG93bjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICB0aW1lRG93bjogdGhpcy5nYW1lLnRpbWUubm93LAogICAgICAgICAgICAgICAgICAgIHRpbWVVcDogMCwKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBLZXkgdXNlZCBiZWZvcmUgYnV0IGZyZXNobHkgZG93bgogICAgICAgICAgICAgICAgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXS5pc0Rvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXS50aW1lRG93biA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgICAgIHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0uZHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5faG90a2V5c1tldmVudC5rZXlDb2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2hvdGtleXNbZXZlbnQua2V5Q29kZV0ucHJvY2Vzc0tleURvd24oZXZlbnQpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBQcm9jZXNzIHRoZSBrZXl1cCBldmVudC4KICAgICogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjcHJvY2Vzc0tleVVwCiAgICAqIEBwYXJhbSB7S2V5Ym9hcmRFdmVudH0gZXZlbnQKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHByb2Nlc3NLZXlVcDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9jYXB0dXJlW2V2ZW50LmtleUNvZGVdKQogICAgICAgIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm9uVXBDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25VcENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9ob3RrZXlzW2V2ZW50LmtleUNvZGVdKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faG90a2V5c1tldmVudC5rZXlDb2RlXS5wcm9jZXNzS2V5VXAoZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdLmlzRG93biA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdLnRpbWVVcCA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIE5vdCB1c2VkIHRoaXMga2V5IGJlZm9yZSwgc28gcmVnaXN0ZXIgaXQKICAgICAgICAgICAgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXSA9IHsKICAgICAgICAgICAgICAgIGlzRG93bjogZmFsc2UsCiAgICAgICAgICAgICAgICB0aW1lRG93bjogdGhpcy5nYW1lLnRpbWUubm93LAogICAgICAgICAgICAgICAgdGltZVVwOiB0aGlzLmdhbWUudGltZS5ub3csCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogMAogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXNldCB0aGUgImlzRG93biIgc3RhdGUgb2YgYWxsIGtleXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI3Jlc2V0CiAgICAqLwogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuX2tleXMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9rZXlzW2tleV0uaXNEb3duID0gZmFsc2U7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlICJqdXN0IHByZXNzZWQiIHN0YXRlIG9mIHRoZSBrZXkuIEp1c3QgcHJlc3NlZCBpcyBjb25zaWRlcmVkIHRydWUgaWYgdGhlIGtleSB3YXMgcHJlc3NlZCBkb3duIHdpdGhpbiB0aGUgZHVyYXRpb24gZ2l2ZW4gKGRlZmF1bHQgMjUwbXMpCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI2p1c3RQcmVzc2VkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBrZXljb2RlIC0gVGhlIGtleWNvZGUgb2YgdGhlIGtleSB0byByZW1vdmUsIGkuZS4gUGhhc2VyLktleWJvYXJkLlVQIG9yIFBoYXNlci5LZXlib2FyZC5TUEFDRUJBUgogICAgKiBAcGFyYW0ge251bWJlcn0gW2R1cmF0aW9uPTI1MF0gLSBUaGUgZHVyYXRpb24gYmVsb3cgd2hpY2ggdGhlIGtleSBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIGp1c3QgcHJlc3NlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUga2V5IGlzIGp1c3QgcHJlc3NlZCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAganVzdFByZXNzZWQ6IGZ1bmN0aW9uIChrZXljb2RlLCBkdXJhdGlvbikgewoKICAgICAgICBpZiAodHlwZW9mIGR1cmF0aW9uID09PSAidW5kZWZpbmVkIikgeyBkdXJhdGlvbiA9IDI1MDsgfQoKICAgICAgICBpZiAodGhpcy5fa2V5c1trZXljb2RlXSAmJiB0aGlzLl9rZXlzW2tleWNvZGVdLmlzRG93biAmJiB0aGlzLl9rZXlzW2tleWNvZGVdLmR1cmF0aW9uIDwgZHVyYXRpb24pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSAianVzdCByZWxlYXNlZCIgc3RhdGUgb2YgdGhlIEtleS4gSnVzdCByZWxlYXNlZCBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIHRydWUgaWYgdGhlIGtleSB3YXMgcmVsZWFzZWQgd2l0aGluIHRoZSBkdXJhdGlvbiBnaXZlbiAoZGVmYXVsdCAyNTBtcykKICAgICogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjanVzdFJlbGVhc2VkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBrZXljb2RlIC0gVGhlIGtleWNvZGUgb2YgdGhlIGtleSB0byByZW1vdmUsIGkuZS4gUGhhc2VyLktleWJvYXJkLlVQIG9yIFBoYXNlci5LZXlib2FyZC5TUEFDRUJBUgogICAgKiBAcGFyYW0ge251bWJlcn0gW2R1cmF0aW9uPTI1MF0gLSBUaGUgZHVyYXRpb24gYmVsb3cgd2hpY2ggdGhlIGtleSBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIGp1c3QgcmVsZWFzZWQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGtleSBpcyBqdXN0IHJlbGVhc2VkIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBqdXN0UmVsZWFzZWQ6IGZ1bmN0aW9uIChrZXljb2RlLCBkdXJhdGlvbikgewoKICAgICAgICBpZiAodHlwZW9mIGR1cmF0aW9uID09PSAidW5kZWZpbmVkIikgeyBkdXJhdGlvbiA9IDI1MDsgfQoKICAgICAgICBpZiAodGhpcy5fa2V5c1trZXljb2RlXSAmJiB0aGlzLl9rZXlzW2tleWNvZGVdLmlzRG93biA9PT0gZmFsc2UgJiYgKHRoaXMuZ2FtZS50aW1lLm5vdyAtIHRoaXMuX2tleXNba2V5Y29kZV0udGltZVVwIDwgZHVyYXRpb24pKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0cnVlIG9mIHRoZSBrZXkgaXMgY3VycmVudGx5IHByZXNzZWQgZG93bi4gTm90ZSB0aGF0IGl0IGNhbiBvbmx5IGRldGVjdCBrZXkgcHJlc3NlcyBvbiB0aGUgd2ViIGJyb3dzZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI2lzRG93bgogICAgKiBAcGFyYW0ge251bWJlcn0ga2V5Y29kZSAtIFRoZSBrZXljb2RlIG9mIHRoZSBrZXkgdG8gcmVtb3ZlLCBpLmUuIFBoYXNlci5LZXlib2FyZC5VUCBvciBQaGFzZXIuS2V5Ym9hcmQuU1BBQ0VCQVIKICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUga2V5IGlzIGN1cnJlbnRseSBkb3duLgogICAgKi8KICAgIGlzRG93bjogZnVuY3Rpb24gKGtleWNvZGUpIHsKCiAgICAgICAgaWYgKHRoaXMuX2tleXNba2V5Y29kZV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fa2V5c1trZXljb2RlXS5pc0Rvd247CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfQoKfTsKClBoYXNlci5LZXlib2FyZC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuS2V5Ym9hcmQ7CgpQaGFzZXIuS2V5Ym9hcmQuQSA9ICJBIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuQiA9ICJCIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuQyA9ICJDIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuRCA9ICJEIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuRSA9ICJFIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuRiA9ICJGIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuRyA9ICJHIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuSCA9ICJIIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuSSA9ICJJIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuSiA9ICJKIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuSyA9ICJLIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuTCA9ICJMIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuTSA9ICJNIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuTiA9ICJOIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuTyA9ICJPIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuUCA9ICJQIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuUSA9ICJRIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuUiA9ICJSIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuUyA9ICJTIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuVCA9ICJUIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuVSA9ICJVIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuViA9ICJWIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuVyA9ICJXIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuWCA9ICJYIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuWSA9ICJZIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuWiA9ICJaIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuWkVSTyA9ICIwIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuT05FID0gIjEiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5UV08gPSAiMiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlRIUkVFID0gIjMiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5GT1VSID0gIjQiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5GSVZFID0gIjUiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5TSVggPSAiNiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlNFVkVOID0gIjciLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5FSUdIVCA9ICI4Ii5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuTklORSA9ICI5Ii5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzAgPSA5NjsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF8xID0gOTc7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfMiA9IDk4OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzMgPSA5OTsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF80ID0gMTAwOwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzUgPSAxMDE7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfNiA9IDEwMjsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF83ID0gMTAzOwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzggPSAxMDQ7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfOSA9IDEwNTsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF9NVUxUSVBMWSA9IDEwNjsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF9BREQgPSAxMDc7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfRU5URVIgPSAxMDg7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfU1VCVFJBQ1QgPSAxMDk7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfREVDSU1BTCA9IDExMDsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF9ESVZJREUgPSAxMTE7ClBoYXNlci5LZXlib2FyZC5GMSA9IDExMjsKUGhhc2VyLktleWJvYXJkLkYyID0gMTEzOwpQaGFzZXIuS2V5Ym9hcmQuRjMgPSAxMTQ7ClBoYXNlci5LZXlib2FyZC5GNCA9IDExNTsKUGhhc2VyLktleWJvYXJkLkY1ID0gMTE2OwpQaGFzZXIuS2V5Ym9hcmQuRjYgPSAxMTc7ClBoYXNlci5LZXlib2FyZC5GNyA9IDExODsKUGhhc2VyLktleWJvYXJkLkY4ID0gMTE5OwpQaGFzZXIuS2V5Ym9hcmQuRjkgPSAxMjA7ClBoYXNlci5LZXlib2FyZC5GMTAgPSAxMjE7ClBoYXNlci5LZXlib2FyZC5GMTEgPSAxMjI7ClBoYXNlci5LZXlib2FyZC5GMTIgPSAxMjM7ClBoYXNlci5LZXlib2FyZC5GMTMgPSAxMjQ7ClBoYXNlci5LZXlib2FyZC5GMTQgPSAxMjU7ClBoYXNlci5LZXlib2FyZC5GMTUgPSAxMjY7ClBoYXNlci5LZXlib2FyZC5DT0xPTiA9IDE4NjsKUGhhc2VyLktleWJvYXJkLkVRVUFMUyA9IDE4NzsKUGhhc2VyLktleWJvYXJkLlVOREVSU0NPUkUgPSAxODk7ClBoYXNlci5LZXlib2FyZC5RVUVTVElPTl9NQVJLID0gMTkxOwpQaGFzZXIuS2V5Ym9hcmQuVElMREUgPSAxOTI7ClBoYXNlci5LZXlib2FyZC5PUEVOX0JSQUNLRVQgPSAyMTk7ClBoYXNlci5LZXlib2FyZC5CQUNLV0FSRF9TTEFTSCA9IDIyMDsKUGhhc2VyLktleWJvYXJkLkNMT1NFRF9CUkFDS0VUID0gMjIxOwpQaGFzZXIuS2V5Ym9hcmQuUVVPVEVTID0gMjIyOwpQaGFzZXIuS2V5Ym9hcmQuQkFDS1NQQUNFID0gODsKUGhhc2VyLktleWJvYXJkLlRBQiA9IDk7ClBoYXNlci5LZXlib2FyZC5DTEVBUiA9IDEyOwpQaGFzZXIuS2V5Ym9hcmQuRU5URVIgPSAxMzsKUGhhc2VyLktleWJvYXJkLlNISUZUID0gMTY7ClBoYXNlci5LZXlib2FyZC5DT05UUk9MID0gMTc7ClBoYXNlci5LZXlib2FyZC5BTFQgPSAxODsKUGhhc2VyLktleWJvYXJkLkNBUFNfTE9DSyA9IDIwOwpQaGFzZXIuS2V5Ym9hcmQuRVNDID0gMjc7ClBoYXNlci5LZXlib2FyZC5TUEFDRUJBUiA9IDMyOwpQaGFzZXIuS2V5Ym9hcmQuUEFHRV9VUCA9IDMzOwpQaGFzZXIuS2V5Ym9hcmQuUEFHRV9ET1dOID0gMzQ7ClBoYXNlci5LZXlib2FyZC5FTkQgPSAzNTsKUGhhc2VyLktleWJvYXJkLkhPTUUgPSAzNjsKUGhhc2VyLktleWJvYXJkLkxFRlQgPSAzNzsKUGhhc2VyLktleWJvYXJkLlVQID0gMzg7ClBoYXNlci5LZXlib2FyZC5SSUdIVCA9IDM5OwpQaGFzZXIuS2V5Ym9hcmQuRE9XTiA9IDQwOwpQaGFzZXIuS2V5Ym9hcmQuSU5TRVJUID0gNDU7ClBoYXNlci5LZXlib2FyZC5ERUxFVEUgPSA0NjsKUGhhc2VyLktleWJvYXJkLkhFTFAgPSA0NzsKUGhhc2VyLktleWJvYXJkLk5VTV9MT0NLID0gMTQ0OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLk1vdXNlIGlzIHJlc3BvbnNpYmxlIGZvciBoYW5kbGluZyBhbGwgYXNwZWN0cyBvZiBtb3VzZSBpbnRlcmFjdGlvbiB3aXRoIHRoZSBicm93c2VyLiBJdCBjYXB0dXJlcyBhbmQgcHJvY2Vzc2VzIG1vdXNlIGV2ZW50cy4KKgoqIEBjbGFzcyBQaGFzZXIuTW91c2UKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5Nb3VzZSA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtPYmplY3R9IGNhbGxiYWNrQ29udGV4dCAtIFRoZSBjb250ZXh0IHVuZGVyIHdoaWNoIGNhbGxiYWNrcyBhcmUgY2FsbGVkLgogICAgKi8KICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gdGhpcy5nYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBtb3VzZURvd25DYWxsYmFjayAtIEEgY2FsbGJhY2sgdGhhdCBjYW4gYmUgZmlyZWQgd2hlbiB0aGUgbW91c2UgaXMgcHJlc3NlZCBkb3duLgogICAgKi8KICAgIHRoaXMubW91c2VEb3duQ2FsbGJhY2sgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gbW91c2VNb3ZlQ2FsbGJhY2sgLSBBIGNhbGxiYWNrIHRoYXQgY2FuIGJlIGZpcmVkIHdoZW4gdGhlIG1vdXNlIGlzIG1vdmVkIHdoaWxlIHByZXNzZWQgZG93bi4KICAgICovCiAgICB0aGlzLm1vdXNlTW92ZUNhbGxiYWNrID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG1vdXNlVXBDYWxsYmFjayAtIEEgY2FsbGJhY2sgdGhhdCBjYW4gYmUgZmlyZWQgd2hlbiB0aGUgbW91c2UgaXMgcmVsZWFzZWQgZnJvbSBhIHByZXNzZWQgZG93biBzdGF0ZS4KICAgICovCiAgICB0aGlzLm1vdXNlVXBDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY2FwdHVyZSAtIElmIHRydWUgdGhlIERPTSBtb3VzZSBldmVudHMgd2lsbCBoYXZlIGV2ZW50LnByZXZlbnREZWZhdWx0IGFwcGxpZWQgdG8gdGhlbSwgaWYgZmFsc2UgdGhleSB3aWxsIHByb3BvZ2F0ZSBmdWxseS4KICAgICovCiAgICB0aGlzLmNhcHR1cmUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGJ1dHRvbi0gVGhlIHR5cGUgb2YgY2xpY2ssIGVpdGhlcjogUGhhc2VyLk1vdXNlLk5PX0JVVFRPTiwgUGhhc2VyLk1vdXNlLkxFRlRfQlVUVE9OLCBQaGFzZXIuTW91c2UuTUlERExFX0JVVFRPTiBvciBQaGFzZXIuTW91c2UuUklHSFRfQlVUVE9OLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYnV0dG9uID0gLTE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZGlzYWJsZWQgLSBZb3UgY2FuIGRpc2FibGUgYWxsIElucHV0IGJ5IHNldHRpbmcgZGlzYWJsZWQgPSB0cnVlLiBXaGlsZSBzZXQgYWxsIG5ldyBpbnB1dCByZWxhdGVkIGV2ZW50cyB3aWxsIGJlIGlnbm9yZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kaXNhYmxlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGxvY2tlZCAtIElmIHRoZSBtb3VzZSBoYXMgYmVlbiBQb2ludGVyIExvY2tlZCBzdWNjZXNzZnVsbHkgdGhpcyB3aWxsIGJlIHNldCB0byB0cnVlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubG9ja2VkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gcG9pbnRlckxvY2sgLSBUaGlzIGV2ZW50IGlzIGRpc3BhdGNoZWQgd2hlbiB0aGUgYnJvd3NlciBlbnRlcnMgb3IgbGVhdmVzIHBvaW50ZXIgbG9jayBzdGF0ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBvaW50ZXJMb2NrID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtNb3VzZUV2ZW50fSBldmVudCAtIFRoZSBicm93c2VyIG1vdXNlIERPTSBldmVudC4gV2lsbCBiZSBzZXQgdG8gbnVsbCBpZiBubyBtb3VzZSBldmVudCBoYXMgZXZlciBiZWVuIHJlY2VpdmVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZXZlbnQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25Nb3VzZURvd24gLSBJbnRlcm5hbCBldmVudCBoYW5kbGVyIHJlZmVyZW5jZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vbk1vdXNlRG93biA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vbk1vdXNlTW92ZSAtIEludGVybmFsIGV2ZW50IGhhbmRsZXIgcmVmZXJlbmNlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uTW91c2VNb3ZlID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uTW91c2VVcCAtIEludGVybmFsIGV2ZW50IGhhbmRsZXIgcmVmZXJlbmNlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uTW91c2VVcCA9IG51bGw7Cgp9OwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLk1vdXNlLk5PX0JVVFRPTiA9IC0xOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLk1vdXNlLkxFRlRfQlVUVE9OID0gMDsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Nb3VzZS5NSURETEVfQlVUVE9OID0gMTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Nb3VzZS5SSUdIVF9CVVRUT04gPSAyOwoKUGhhc2VyLk1vdXNlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogU3RhcnRzIHRoZSBldmVudCBsaXN0ZW5lcnMgcnVubmluZy4KICAgICogQG1ldGhvZCBQaGFzZXIuTW91c2Ujc3RhcnQKICAgICovCiAgICBzdGFydDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS5hbmRyb2lkICYmIHRoaXMuZ2FtZS5kZXZpY2UuY2hyb21lID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBBbmRyb2lkIHN0b2NrIGJyb3dzZXIgZmlyZXMgbW91c2UgZXZlbnRzIGV2ZW4gaWYgeW91IHByZXZlbnREZWZhdWx0IG9uIHRoZSB0b3VjaFN0YXJ0LCBzbyAuLi4KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fb25Nb3VzZURvd24gPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uTW91c2VEb3duKGV2ZW50KTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLl9vbk1vdXNlTW92ZSA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMub25Nb3VzZU1vdmUoZXZlbnQpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuX29uTW91c2VVcCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMub25Nb3VzZVVwKGV2ZW50KTsKICAgICAgICB9OwoKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCB0aGlzLl9vbk1vdXNlRG93biwgdHJ1ZSk7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5fb25Nb3VzZU1vdmUsIHRydWUpOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLl9vbk1vdXNlVXAsIHRydWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBpbnRlcm5hbCBtZXRob2QgdGhhdCBoYW5kbGVzIHRoZSBtb3VzZSBkb3duIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1vdXNlI29uTW91c2VEb3duCiAgICAqIEBwYXJhbSB7TW91c2VFdmVudH0gZXZlbnQgLSBUaGUgbmF0aXZlIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuIFRoaXMgZ2V0cyBzdG9yZWQgaW4gTW91c2UuZXZlbnQuCiAgICAqLwogICAgb25Nb3VzZURvd246IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7CgogICAgICAgIGlmICh0aGlzLmNhcHR1cmUpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5idXR0b24gPSBldmVudC53aGljaDsKCiAgICAgICAgaWYgKHRoaXMubW91c2VEb3duQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm1vdXNlRG93bkNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGV2ZW50WydpZGVudGlmaWVyJ10gPSAwOwoKICAgICAgICB0aGlzLmdhbWUuaW5wdXQubW91c2VQb2ludGVyLnN0YXJ0KGV2ZW50KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgaW50ZXJuYWwgbWV0aG9kIHRoYXQgaGFuZGxlcyB0aGUgbW91c2UgbW92ZSBldmVudCBmcm9tIHRoZSBicm93c2VyLgogICAgKiBAbWV0aG9kIFBoYXNlci5Nb3VzZSNvbk1vdXNlTW92ZQogICAgKiBAcGFyYW0ge01vdXNlRXZlbnR9IGV2ZW50IC0gVGhlIG5hdGl2ZSBldmVudCBmcm9tIHRoZSBicm93c2VyLiBUaGlzIGdldHMgc3RvcmVkIGluIE1vdXNlLmV2ZW50LgogICAgKi8KICAgIG9uTW91c2VNb3ZlOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5ldmVudCA9IGV2ZW50OwoKICAgICAgICBpZiAodGhpcy5jYXB0dXJlKQogICAgICAgIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm1vdXNlTW92ZUNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb3VzZU1vdmVDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBldmVudFsnaWRlbnRpZmllciddID0gMDsKCiAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm1vdXNlUG9pbnRlci5tb3ZlKGV2ZW50KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgaW50ZXJuYWwgbWV0aG9kIHRoYXQgaGFuZGxlcyB0aGUgbW91c2UgdXAgZXZlbnQgZnJvbSB0aGUgYnJvd3Nlci4KICAgICogQG1ldGhvZCBQaGFzZXIuTW91c2Ujb25Nb3VzZVVwCiAgICAqIEBwYXJhbSB7TW91c2VFdmVudH0gZXZlbnQgLSBUaGUgbmF0aXZlIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuIFRoaXMgZ2V0cyBzdG9yZWQgaW4gTW91c2UuZXZlbnQuCiAgICAqLwogICAgb25Nb3VzZVVwOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5ldmVudCA9IGV2ZW50OwoKICAgICAgICBpZiAodGhpcy5jYXB0dXJlKQogICAgICAgIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuYnV0dG9uID0gUGhhc2VyLk1vdXNlLk5PX0JVVFRPTjsKCiAgICAgICAgaWYgKHRoaXMubW91c2VVcENhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb3VzZVVwQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZXZlbnRbJ2lkZW50aWZpZXInXSA9IDA7CgogICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5tb3VzZVBvaW50ZXIuc3RvcChldmVudCk7CgogICAgfSwKCiAgICAvKioKICAgICogSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgaXQgeW91IGNhbiByZXF1ZXN0IHRoYXQgdGhlIHBvaW50ZXIgYmUgbG9ja2VkIHRvIHRoZSBicm93c2VyIHdpbmRvdy4KICAgICogVGhpcyBpcyBjbGFzc2ljYWxseSBrbm93biBhcyAnRlBTIGNvbnRyb2xzJywgd2hlcmUgdGhlIHBvaW50ZXIgY2FuJ3QgbGVhdmUgdGhlIGJyb3dzZXIgdW50aWwgdGhlIHVzZXIgcHJlc3NlcyBhbiBleGl0IGtleS4KICAgICogSWYgdGhlIGJyb3dzZXIgc3VjY2Vzc2Z1bGx5IGVudGVycyBhIGxvY2tlZCBzdGF0ZSB0aGUgZXZlbnQgUGhhc2VyLk1vdXNlLnBvaW50ZXJMb2NrIHdpbGwgYmUgZGlzcGF0Y2hlZCBhbmQgdGhlIGZpcnN0IHBhcmFtZXRlciB3aWxsIGJlICd0cnVlJy4KICAgICogQG1ldGhvZCBQaGFzZXIuTW91c2UjcmVxdWVzdFBvaW50ZXJMb2NrCiAgICAqLwogICAgcmVxdWVzdFBvaW50ZXJMb2NrOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLnBvaW50ZXJMb2NrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzOwoKICAgICAgICAgICAgZWxlbWVudC5yZXF1ZXN0UG9pbnRlckxvY2sgPSBlbGVtZW50LnJlcXVlc3RQb2ludGVyTG9jayB8fCBlbGVtZW50Lm1velJlcXVlc3RQb2ludGVyTG9jayB8fCBlbGVtZW50LndlYmtpdFJlcXVlc3RQb2ludGVyTG9jazsKCiAgICAgICAgICAgIGVsZW1lbnQucmVxdWVzdFBvaW50ZXJMb2NrKCk7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckxvY2tDaGFuZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5wb2ludGVyTG9ja0NoYW5nZShldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVybG9ja2NoYW5nZScsIHRoaXMuX3BvaW50ZXJMb2NrQ2hhbmdlLCB0cnVlKTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW96cG9pbnRlcmxvY2tjaGFuZ2UnLCB0aGlzLl9wb2ludGVyTG9ja0NoYW5nZSwgdHJ1ZSk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdHBvaW50ZXJsb2NrY2hhbmdlJywgdGhpcy5fcG9pbnRlckxvY2tDaGFuZ2UsIHRydWUpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBwb2ludGVyTG9ja0NoYW5nZSBoYW5kbGVyLgogICAgKiBAbWV0aG9kIFBoYXNlci5Nb3VzZSNwb2ludGVyTG9ja0NoYW5nZQogICAgKiBAcGFyYW0ge3BvaW50ZXJsb2NrY2hhbmdlfSBldmVudCAtIFRoZSBuYXRpdmUgZXZlbnQgZnJvbSB0aGUgYnJvd3Nlci4gVGhpcyBnZXRzIHN0b3JlZCBpbiBNb3VzZS5ldmVudC4KICAgICovCiAgICBwb2ludGVyTG9ja0NoYW5nZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5nYW1lLnN0YWdlLmNhbnZhczsKCiAgICAgICAgaWYgKGRvY3VtZW50LnBvaW50ZXJMb2NrRWxlbWVudCA9PT0gZWxlbWVudCB8fCBkb2N1bWVudC5tb3pQb2ludGVyTG9ja0VsZW1lbnQgPT09IGVsZW1lbnQgfHwgZG9jdW1lbnQud2Via2l0UG9pbnRlckxvY2tFbGVtZW50ID09PSBlbGVtZW50KQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFBvaW50ZXIgd2FzIHN1Y2Nlc3NmdWxseSBsb2NrZWQKICAgICAgICAgICAgdGhpcy5sb2NrZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnBvaW50ZXJMb2NrLmRpc3BhdGNoKHRydWUsIGV2ZW50KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFBvaW50ZXIgd2FzIHVubG9ja2VkCiAgICAgICAgICAgIHRoaXMubG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMucG9pbnRlckxvY2suZGlzcGF0Y2goZmFsc2UsIGV2ZW50KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgcmVsZWFzZSBwb2ludGVyIGxvY2sgaGFuZGxlci4KICAgICogQG1ldGhvZCBQaGFzZXIuTW91c2UjcmVsZWFzZVBvaW50ZXJMb2NrCiAgICAqLwogICAgcmVsZWFzZVBvaW50ZXJMb2NrOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGRvY3VtZW50LmV4aXRQb2ludGVyTG9jayA9IGRvY3VtZW50LmV4aXRQb2ludGVyTG9jayB8fCBkb2N1bWVudC5tb3pFeGl0UG9pbnRlckxvY2sgfHwgZG9jdW1lbnQud2Via2l0RXhpdFBvaW50ZXJMb2NrOwoKICAgICAgICBkb2N1bWVudC5leGl0UG9pbnRlckxvY2soKTsKCiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9pbnRlcmxvY2tjaGFuZ2UnLCB0aGlzLl9wb2ludGVyTG9ja0NoYW5nZSwgdHJ1ZSk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW96cG9pbnRlcmxvY2tjaGFuZ2UnLCB0aGlzLl9wb2ludGVyTG9ja0NoYW5nZSwgdHJ1ZSk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignd2Via2l0cG9pbnRlcmxvY2tjaGFuZ2UnLCB0aGlzLl9wb2ludGVyTG9ja0NoYW5nZSwgdHJ1ZSk7CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcCB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgKiBAbWV0aG9kIFBoYXNlci5Nb3VzZSNzdG9wCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCB0aGlzLl9vbk1vdXNlRG93biwgdHJ1ZSk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5fb25Nb3VzZU1vdmUsIHRydWUpOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLl9vbk1vdXNlVXAsIHRydWUpOwoKICAgIH0KCn07CgpQaGFzZXIuTW91c2UucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLk1vdXNlOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyIC0gTVNQb2ludGVyIGNvbnN0cnVjdG9yLgoqCiogQGNsYXNzIFBoYXNlci5NU1BvaW50ZXIKKiBAY2xhc3NkZXNjIFRoZSBNU1BvaW50ZXIgY2xhc3MgaGFuZGxlcyB0b3VjaCBpbnRlcmFjdGlvbnMgd2l0aCB0aGUgZ2FtZSBhbmQgdGhlIHJlc3VsdGluZyBQb2ludGVyIG9iamVjdHMuCiogSXQgd2lsbCB3b3JrIG9ubHkgaW4gSW50ZXJuZXQgRXhwbG9yZXIgMTAgYW5kIFdpbmRvd3MgU3RvcmUgb3IgV2luZG93cyBQaG9uZSA4IGFwcHMgdXNpbmcgSmF2YVNjcmlwdC4KKiBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvaWUvaGg2NzM1NTcodj12cy44NSkuYXNweAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLk1TUG9pbnRlciA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtPYmplY3R9IGNhbGxiYWNrQ29udGV4dCAtIFRoZSBjb250ZXh0IHVuZGVyIHdoaWNoIGNhbGxiYWNrcyBhcmUgY2FsbGVkIChkZWZhdWx0cyB0byBnYW1lKS4KICAgICovCiAgICB0aGlzLmNhbGxiYWNrQ29udGV4dCA9IHRoaXMuZ2FtZTsKCiAgICAvKioKICAgICogWW91IGNhbiBkaXNhYmxlIGFsbCBJbnB1dCBieSBzZXR0aW5nIGRpc2FibGVkID0gdHJ1ZS4gV2hpbGUgc2V0IGFsbCBuZXcgaW5wdXQgcmVsYXRlZCBldmVudHMgd2lsbCBiZSBpZ25vcmVkLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRpc2FibGVkCiAgICAqLwogICAgdGhpcy5kaXNhYmxlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25NU1BvaW50ZXJEb3duIC0gSW50ZXJuYWwgZnVuY3Rpb24gdG8gaGFuZGxlIE1TUG9pbnRlciBldmVudHMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fb25NU1BvaW50ZXJEb3duID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vbk1TUG9pbnRlck1vdmUgLSBJbnRlcm5hbCBmdW5jdGlvbiB0byBoYW5kbGUgTVNQb2ludGVyIGV2ZW50cy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vbk1TUG9pbnRlck1vdmUgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uTVNQb2ludGVyVXAgLSBJbnRlcm5hbCBmdW5jdGlvbiB0byBoYW5kbGUgTVNQb2ludGVyIGV2ZW50cy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vbk1TUG9pbnRlclVwID0gbnVsbDsKCn07CgpQaGFzZXIuTVNQb2ludGVyLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogU3RhcnRzIHRoZSBldmVudCBsaXN0ZW5lcnMgcnVubmluZy4KICAgICogQG1ldGhvZCBQaGFzZXIuTVNQb2ludGVyI3N0YXJ0CiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UubXNwb2ludGVyID09PSB0cnVlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fb25NU1BvaW50ZXJEb3duID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMub25Qb2ludGVyRG93bihldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9vbk1TUG9pbnRlck1vdmUgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblBvaW50ZXJNb3ZlKGV2ZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuX29uTVNQb2ludGVyVXAgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblBvaW50ZXJVcChldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJEb3duJywgdGhpcy5fb25NU1BvaW50ZXJEb3duLCBmYWxzZSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ01TUG9pbnRlck1vdmUnLCB0aGlzLl9vbk1TUG9pbnRlck1vdmUsIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcignTVNQb2ludGVyVXAnLCB0aGlzLl9vbk1TUG9pbnRlclVwLCBmYWxzZSk7CgogICAgICAgICAgICAvLyAgSUUxMSsgdXNlcyBub24tcHJlZml4IGV2ZW50cwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVyRG93bicsIHRoaXMuX29uTVNQb2ludGVyRG93biwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVyTW92ZScsIHRoaXMuX29uTVNQb2ludGVyTW92ZSwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVyVXAnLCB0aGlzLl9vbk1TUG9pbnRlclVwLCBmYWxzZSk7CgogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5zdHlsZVsnLW1zLWNvbnRlbnQtem9vbWluZyddID0gJ25vbmUnOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5zdHlsZVsnLW1zLXRvdWNoLWFjdGlvbiddID0gJ25vbmUnOwoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIGZ1bmN0aW9uIHRoYXQgaGFuZGxlcyB0aGUgUG9pbnRlckRvd24gZXZlbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1TUG9pbnRlciNvblBvaW50ZXJEb3duCiAgICAqIEBwYXJhbSB7UG9pbnRlckV2ZW50fSBldmVudAogICAgKi8KICAgIG9uUG9pbnRlckRvd246IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGV2ZW50LmlkZW50aWZpZXIgPSBldmVudC5wb2ludGVySWQ7CgogICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5zdGFydFBvaW50ZXIoZXZlbnQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBmdW5jdGlvbiB0aGF0IGhhbmRsZXMgdGhlIFBvaW50ZXJNb3ZlIGV2ZW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5NU1BvaW50ZXIjb25Qb2ludGVyTW92ZQogICAgKiBAcGFyYW0ge1BvaW50ZXJFdmVudCB9IGV2ZW50CiAgICAqLwogICAgb25Qb2ludGVyTW92ZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgZXZlbnQuaWRlbnRpZmllciA9IGV2ZW50LnBvaW50ZXJJZDsKCiAgICAgICAgdGhpcy5nYW1lLmlucHV0LnVwZGF0ZVBvaW50ZXIoZXZlbnQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBmdW5jdGlvbiB0aGF0IGhhbmRsZXMgdGhlIFBvaW50ZXJVcCBldmVudC4KICAgICogQG1ldGhvZCBQaGFzZXIuTVNQb2ludGVyI29uUG9pbnRlclVwCiAgICAqIEBwYXJhbSB7UG9pbnRlckV2ZW50fSBldmVudAogICAgKi8KICAgIG9uUG9pbnRlclVwOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICBldmVudC5pZGVudGlmaWVyID0gZXZlbnQucG9pbnRlcklkOwoKICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc3RvcFBvaW50ZXIoZXZlbnQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3AgdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICogQG1ldGhvZCBQaGFzZXIuTVNQb2ludGVyI3N0b3AKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignTVNQb2ludGVyRG93bicsIHRoaXMuX29uTVNQb2ludGVyRG93bik7CiAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJNb3ZlJywgdGhpcy5fb25NU1BvaW50ZXJNb3ZlKTsKICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ01TUG9pbnRlclVwJywgdGhpcy5fb25NU1BvaW50ZXJVcCk7CgogICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9pbnRlckRvd24nLCB0aGlzLl9vbk1TUG9pbnRlckRvd24pOwogICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9pbnRlck1vdmUnLCB0aGlzLl9vbk1TUG9pbnRlck1vdmUpOwogICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9pbnRlclVwJywgdGhpcy5fb25NU1BvaW50ZXJVcCk7CgogICAgfQoKfTsKClBoYXNlci5NU1BvaW50ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLk1TUG9pbnRlcjsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlciAtIFBvaW50ZXIgY29uc3RydWN0b3IuCioKKiBAY2xhc3MgUGhhc2VyLlBvaW50ZXIKKiBAY2xhc3NkZXNjIEEgUG9pbnRlciBvYmplY3QgaXMgdXNlZCBieSB0aGUgTW91c2UsIFRvdWNoIGFuZCBNU1BvaW50IG1hbmFnZXJzIGFuZCByZXByZXNlbnRzIGEgc2luZ2xlIGZpbmdlciBvbiB0aGUgdG91Y2ggc2NyZWVuLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge251bWJlcn0gaWQgLSBUaGUgSUQgb2YgdGhlIFBvaW50ZXIgb2JqZWN0IHdpdGhpbiB0aGUgZ2FtZS4gRWFjaCBnYW1lIGNhbiBoYXZlIHVwIHRvIDEwIGFjdGl2ZSBwb2ludGVycy4KKi8KUGhhc2VyLlBvaW50ZXIgPSBmdW5jdGlvbiAoZ2FtZSwgaWQpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpZCAtIFRoZSBJRCBvZiB0aGUgUG9pbnRlciBvYmplY3Qgd2l0aGluIHRoZSBnYW1lLiBFYWNoIGdhbWUgY2FuIGhhdmUgdXAgdG8gMTAgYWN0aXZlIHBvaW50ZXJzLgogICAgKi8KICAgIHRoaXMuaWQgPSBpZDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfaG9sZFNlbnQgLSBMb2NhbCBwcml2YXRlIHZhcmlhYmxlIHRvIHN0b3JlIHRoZSBzdGF0dXMgb2YgZGlzcGF0Y2hpbmcgYSBob2xkIGV2ZW50LgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX2hvbGRTZW50ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IF9oaXN0b3J5IC0gTG9jYWwgcHJpdmF0ZSB2YXJpYWJsZSBzdG9yaW5nIHRoZSBzaG9ydC10ZXJtIGhpc3Rvcnkgb2YgcG9pbnRlciBtb3ZlbWVudHMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5faGlzdG9yeSA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2xhc3REcm9wIC0gTG9jYWwgcHJpdmF0ZSB2YXJpYWJsZSBzdG9yaW5nIHRoZSB0aW1lIGF0IHdoaWNoIHRoZSBuZXh0IGhpc3RvcnkgZHJvcCBzaG91bGQgb2NjdXIuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fbmV4dERyb3AgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9zdGF0ZVJlc2V0IC0gTW9uaXRvciBldmVudHMgb3V0c2lkZSBvZiBhIHN0YXRlIHJlc2V0IGxvb3AuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fc3RhdGVSZXNldCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHdpdGhpbkdhbWUgLSB0cnVlIGlmIHRoZSBQb2ludGVyIGlzIHdpdGhpbiB0aGUgZ2FtZSBhcmVhLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgdGhpcy53aXRoaW5HYW1lID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjbGllbnRYIC0gVGhlIGhvcml6b250YWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQgaW4gcGl4ZWxzLCBleGNsdWRpbmcgYW55IHNjcm9sbCBvZmZzZXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jbGllbnRYID0gLTE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjbGllbnRZIC0gVGhlIHZlcnRpY2FsIGNvb3JkaW5hdGUgb2YgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIHZpZXdwb3J0IGluIHBpeGVscywgZXhjbHVkaW5nIGFueSBzY3JvbGwgb2Zmc2V0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2xpZW50WSA9IC0xOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGFnZVggLSBUaGUgaG9yaXpvbnRhbCBjb29yZGluYXRlIG9mIHBvaW50IHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydCBpbiBwaXhlbHMsIGluY2x1ZGluZyBhbnkgc2Nyb2xsIG9mZnNldC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhZ2VYID0gLTE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwYWdlWSAtIFRoZSB2ZXJ0aWNhbCBjb29yZGluYXRlIG9mIHBvaW50IHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydCBpbiBwaXhlbHMsIGluY2x1ZGluZyBhbnkgc2Nyb2xsIG9mZnNldC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhZ2VZID0gLTE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzY3JlZW5YIC0gVGhlIGhvcml6b250YWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgc2NyZWVuIGluIHBpeGVscy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNjcmVlblggPSAtMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNjcmVlblkgLSBUaGUgdmVydGljYWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgc2NyZWVuIGluIHBpeGVscy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNjcmVlblkgPSAtMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBUaGUgaG9yaXpvbnRhbCBjb29yZGluYXRlIG9mIHBvaW50IHJlbGF0aXZlIHRvIHRoZSBnYW1lIGVsZW1lbnQuIFRoaXMgdmFsdWUgaXMgYXV0b21hdGljYWxseSBzY2FsZWQgYmFzZWQgb24gZ2FtZSBzaXplLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMueCA9IC0xOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSB2ZXJ0aWNhbCBjb29yZGluYXRlIG9mIHBvaW50IHJlbGF0aXZlIHRvIHRoZSBnYW1lIGVsZW1lbnQuIFRoaXMgdmFsdWUgaXMgYXV0b21hdGljYWxseSBzY2FsZWQgYmFzZWQgb24gZ2FtZSBzaXplLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMueSA9IC0xOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzTW91c2UgLSBJZiB0aGUgUG9pbnRlciBpcyBhIG1vdXNlIHRoaXMgaXMgdHJ1ZSwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNNb3VzZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzRG93biAtIElmIHRoZSBQb2ludGVyIGlzIHRvdWNoaW5nIHRoZSB0b3VjaHNjcmVlbiwgb3IgdGhlIG1vdXNlIGJ1dHRvbiBpcyBoZWxkIGRvd24sIGlzRG93biBpcyBzZXQgdG8gdHJ1ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzRG93biA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzVXAgLSBJZiB0aGUgUG9pbnRlciBpcyBub3QgdG91Y2hpbmcgdGhlIHRvdWNoc2NyZWVuLCBvciB0aGUgbW91c2UgYnV0dG9uIGlzIHVwLCBpc1VwIGlzIHNldCB0byB0cnVlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNVcCA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lRG93biAtIEEgdGltZXN0YW1wIHJlcHJlc2VudGluZyB3aGVuIHRoZSBQb2ludGVyIGZpcnN0IHRvdWNoZWQgdGhlIHRvdWNoc2NyZWVuLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGltZURvd24gPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdGltZVVwIC0gQSB0aW1lc3RhbXAgcmVwcmVzZW50aW5nIHdoZW4gdGhlIFBvaW50ZXIgbGVmdCB0aGUgdG91Y2hzY3JlZW4uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50aW1lVXAgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcHJldmlvdXNUYXBUaW1lIC0gQSB0aW1lc3RhbXAgcmVwcmVzZW50aW5nIHdoZW4gdGhlIFBvaW50ZXIgd2FzIGxhc3QgdGFwcGVkIG9yIGNsaWNrZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wcmV2aW91c1RhcFRpbWUgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdG90YWxUb3VjaGVzIC0gVGhlIHRvdGFsIG51bWJlciBvZiB0aW1lcyB0aGlzIFBvaW50ZXIgaGFzIGJlZW4gdG91Y2hlZCB0byB0aGUgdG91Y2hzY3JlZW4uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50b3RhbFRvdWNoZXMgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbXNTaW5jZUxhc3RDbGljayAtIFRoZSBudW1iZXIgb2YgbWlsaXNlY29uZHMgc2luY2UgdGhlIGxhc3QgY2xpY2suCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tc1NpbmNlTGFzdENsaWNrID0gTnVtYmVyLk1BWF9WQUxVRTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthbnl9IHRhcmdldE9iamVjdCAtIFRoZSBHYW1lIE9iamVjdCB0aGlzIFBvaW50ZXIgaXMgY3VycmVudGx5IG92ZXIgLyB0b3VjaGluZyAvIGRyYWdnaW5nLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGFyZ2V0T2JqZWN0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhY3RpdmUgLSBBbiBhY3RpdmUgcG9pbnRlciBpcyBvbmUgdGhhdCBpcyBjdXJyZW50bHkgcHJlc3NlZCBkb3duIG9uIHRoZSBkaXNwbGF5LiBBIE1vdXNlIGlzIGFsd2F5cyBhY3RpdmUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHBvc2l0aW9uIC0gQSBQaGFzZXIuUG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGN1cnJlbnQgeC95IHZhbHVlcyBvZiB0aGUgcG9pbnRlciBvbiB0aGUgZGlzcGxheS4KICAgICovCiAgICB0aGlzLnBvc2l0aW9uID0gbmV3IFBoYXNlci5Qb2ludCgpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHBvc2l0aW9uRG93biAtIEEgUGhhc2VyLlBvaW50IG9iamVjdCBjb250YWluaW5nIHRoZSB4L3kgdmFsdWVzIG9mIHRoZSBwb2ludGVyIHdoZW4gaXQgd2FzIGxhc3QgaW4gYSBkb3duIHN0YXRlIG9uIHRoZSBkaXNwbGF5LgogICAgKi8KICAgIHRoaXMucG9zaXRpb25Eb3duID0gbmV3IFBoYXNlci5Qb2ludCgpOwoKICAgIC8qKgogICAgKiBBIFBoYXNlci5DaXJjbGUgdGhhdCBpcyBjZW50ZXJlZCBvbiB0aGUgeC95IGNvb3JkaW5hdGVzIG9mIHRoaXMgcG9pbnRlciwgdXNlZnVsIGZvciBoaXQgZGV0ZWN0aW9uLgogICAgKiBUaGUgQ2lyY2xlIHNpemUgaXMgNDRweCAoQXBwbGVzIHJlY29tbWVuZGVkICJmaW5nZXIgdGlwIiBzaXplKS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuQ2lyY2xlfSBjaXJjbGUKICAgICovCiAgICB0aGlzLmNpcmNsZSA9IG5ldyBQaGFzZXIuQ2lyY2xlKDAsIDAsIDQ0KTsKCiAgICBpZiAoaWQgPT09IDApCiAgICB7CiAgICAgICAgdGhpcy5pc01vdXNlID0gdHJ1ZTsKICAgIH0KCn07CgpQaGFzZXIuUG9pbnRlci5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIENhbGxlZCB3aGVuIHRoZSBQb2ludGVyIGlzIHByZXNzZWQgb250byB0aGUgdG91Y2hzY3JlZW4uCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50ZXIjc3RhcnQKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50CiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmlkZW50aWZpZXIgPSBldmVudC5pZGVudGlmaWVyOwogICAgICAgIHRoaXMudGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoKICAgICAgICBpZiAodHlwZW9mIGV2ZW50LmJ1dHRvbiAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJ1dHRvbiA9IGV2ZW50LmJ1dHRvbjsKICAgICAgICB9CgogICAgICAgIC8vICBGaXggdG8gc3RvcCByb2d1ZSBicm93c2VyIHBsdWdpbnMgZnJvbSBibG9ja2luZyB0aGUgdmlzaWJpbGl0eSBzdGF0ZSBldmVudAogICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZ2UuZGlzYWJsZVZpc2liaWxpdHlDaGFuZ2UgPT09IGZhbHNlICYmIHRoaXMuZ2FtZS5wYXVzZWQgJiYgdGhpcy5nYW1lLnN0YWdlLnNjYWxlLmluY29ycmVjdE9yaWVudGF0aW9uID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXVzZWQgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9oaXN0b3J5Lmxlbmd0aCA9IDA7CiAgICAgICAgdGhpcy5hY3RpdmUgPSB0cnVlOwogICAgICAgIHRoaXMud2l0aGluR2FtZSA9IHRydWU7CiAgICAgICAgdGhpcy5pc0Rvd24gPSB0cnVlOwogICAgICAgIHRoaXMuaXNVcCA9IGZhbHNlOwoKICAgICAgICAvLyAgV29yayBvdXQgaG93IGxvbmcgaXQgaGFzIGJlZW4gc2luY2UgdGhlIGxhc3QgY2xpY2sKICAgICAgICB0aGlzLm1zU2luY2VMYXN0Q2xpY2sgPSB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLnRpbWVEb3duOwogICAgICAgIHRoaXMudGltZURvd24gPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgdGhpcy5faG9sZFNlbnQgPSBmYWxzZTsKCiAgICAgICAgLy8gIFRoaXMgc2V0cyB0aGUgeC95IGFuZCBvdGhlciBsb2NhbCB2YWx1ZXMKICAgICAgICB0aGlzLm1vdmUoZXZlbnQpOwoKICAgICAgICAvLyB4IGFuZCB5IGFyZSB0aGUgb2xkIHZhbHVlcyBoZXJlPwogICAgICAgIHRoaXMucG9zaXRpb25Eb3duLnNldFRvKHRoaXMueCwgdGhpcy55KTsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0Lk1PVVNFX09WRVJSSURFU19UT1VDSCB8fCB0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9UT1VDSF9DT01CSU5FIHx8ICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5UT1VDSF9PVkVSUklERVNfTU9VU0UgJiYgdGhpcy5nYW1lLmlucHV0LmN1cnJlbnRQb2ludGVycyA9PT0gMCkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQueCA9IHRoaXMueDsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnkgPSB0aGlzLnk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5wb3NpdGlvbi5zZXRUbyh0aGlzLngsIHRoaXMueSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5vbkRvd24uZGlzcGF0Y2godGhpcywgZXZlbnQpOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQucmVzZXRTcGVlZCh0aGlzLngsIHRoaXMueSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9zdGF0ZVJlc2V0ID0gZmFsc2U7CiAgICAgICAgdGhpcy50b3RhbFRvdWNoZXMrKzsKCiAgICAgICAgaWYgKHRoaXMuaXNNb3VzZSA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuY3VycmVudFBvaW50ZXJzKys7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy50YXJnZXRPYmplY3QgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdC5fdG91Y2hlZEhhbmRsZXIodGhpcyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgYnkgdGhlIElucHV0IE1hbmFnZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50ZXIjdXBkYXRlCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmFjdGl2ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9ob2xkU2VudCA9PT0gZmFsc2UgJiYgdGhpcy5kdXJhdGlvbiA+PSB0aGlzLmdhbWUuaW5wdXQuaG9sZFJhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9PVkVSUklERVNfVE9VQ0ggfHwgdGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuTU9VU0VfVE9VQ0hfQ09NQklORSB8fCAodGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuVE9VQ0hfT1ZFUlJJREVTX01PVVNFICYmIHRoaXMuZ2FtZS5pbnB1dC5jdXJyZW50UG9pbnRlcnMgPT09IDApKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5vbkhvbGQuZGlzcGF0Y2godGhpcyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5faG9sZFNlbnQgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAgVXBkYXRlIHRoZSBkcm9wcGluZ3MgaGlzdG9yeQogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LnJlY29yZFBvaW50ZXJIaXN0b3J5ICYmIHRoaXMuZ2FtZS50aW1lLm5vdyA+PSB0aGlzLl9uZXh0RHJvcCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fbmV4dERyb3AgPSB0aGlzLmdhbWUudGltZS5ub3cgKyB0aGlzLmdhbWUuaW5wdXQucmVjb3JkUmF0ZTsKCiAgICAgICAgICAgICAgICB0aGlzLl9oaXN0b3J5LnB1c2goewogICAgICAgICAgICAgICAgICAgIHg6IHRoaXMucG9zaXRpb24ueCwKICAgICAgICAgICAgICAgICAgICB5OiB0aGlzLnBvc2l0aW9uLnkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9oaXN0b3J5Lmxlbmd0aCA+IHRoaXMuZ2FtZS5pbnB1dC5yZWNvcmRMaW1pdCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaXN0b3J5LnNoaWZ0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIHdoZW4gdGhlIFBvaW50ZXIgaXMgbW92ZWQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50ZXIjbW92ZQogICAgKiBAcGFyYW0ge01vdXNlRXZlbnR8UG9pbnRlckV2ZW50fFRvdWNoRXZlbnR9IGV2ZW50IC0gVGhlIGV2ZW50IHBhc3NlZCB1cCBmcm9tIHRoZSBpbnB1dCBoYW5kbGVyLgogICAgKi8KICAgIG1vdmU6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LnBvbGxMb2NrZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGV2ZW50LmJ1dHRvbiAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJ1dHRvbiA9IGV2ZW50LmJ1dHRvbjsKICAgICAgICB9CgogICAgICAgIHRoaXMuY2xpZW50WCA9IGV2ZW50LmNsaWVudFg7CiAgICAgICAgdGhpcy5jbGllbnRZID0gZXZlbnQuY2xpZW50WTsKCiAgICAgICAgdGhpcy5wYWdlWCA9IGV2ZW50LnBhZ2VYOwogICAgICAgIHRoaXMucGFnZVkgPSBldmVudC5wYWdlWTsKCiAgICAgICAgdGhpcy5zY3JlZW5YID0gZXZlbnQuc2NyZWVuWDsKICAgICAgICB0aGlzLnNjcmVlblkgPSBldmVudC5zY3JlZW5ZOwoKICAgICAgICB0aGlzLnggPSAodGhpcy5wYWdlWCAtIHRoaXMuZ2FtZS5zdGFnZS5vZmZzZXQueCkgKiB0aGlzLmdhbWUuaW5wdXQuc2NhbGUueDsKICAgICAgICB0aGlzLnkgPSAodGhpcy5wYWdlWSAtIHRoaXMuZ2FtZS5zdGFnZS5vZmZzZXQueSkgKiB0aGlzLmdhbWUuaW5wdXQuc2NhbGUueTsKCiAgICAgICAgdGhpcy5wb3NpdGlvbi5zZXRUbyh0aGlzLngsIHRoaXMueSk7CiAgICAgICAgdGhpcy5jaXJjbGUueCA9IHRoaXMueDsKICAgICAgICB0aGlzLmNpcmNsZS55ID0gdGhpcy55OwoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuTU9VU0VfT1ZFUlJJREVTX1RPVUNIIHx8IHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0Lk1PVVNFX1RPVUNIX0NPTUJJTkUgfHwgKHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0LlRPVUNIX09WRVJSSURFU19NT1VTRSAmJiB0aGlzLmdhbWUuaW5wdXQuY3VycmVudFBvaW50ZXJzID09PSAwKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5hY3RpdmVQb2ludGVyID0gdGhpczsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnggPSB0aGlzLng7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC55ID0gdGhpcy55OwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQucG9zaXRpb24uc2V0VG8odGhpcy5nYW1lLmlucHV0LngsIHRoaXMuZ2FtZS5pbnB1dC55KTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LmNpcmNsZS54ID0gdGhpcy5nYW1lLmlucHV0Lng7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5jaXJjbGUueSA9IHRoaXMuZ2FtZS5pbnB1dC55OwogICAgICAgIH0KCiAgICAgICAgLy8gIElmIHRoZSBnYW1lIGlzIHBhdXNlZCB3ZSBkb24ndCBwcm9jZXNzIGFueSB0YXJnZXQgb2JqZWN0cyBvciBjYWxsYmFja3MKICAgICAgICBpZiAodGhpcy5nYW1lLnBhdXNlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5tb3ZlQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQubW92ZUNhbGxiYWNrLmNhbGwodGhpcy5nYW1lLmlucHV0Lm1vdmVDYWxsYmFja0NvbnRleHQsIHRoaXMsIHRoaXMueCwgdGhpcy55KTsKICAgICAgICB9CgogICAgICAgIC8vICBFYXN5IG91dCBpZiB3ZSdyZSBkcmFnZ2luZyBzb21ldGhpbmcgYW5kIGl0IHN0aWxsIGV4aXN0cwogICAgICAgIGlmICh0aGlzLnRhcmdldE9iamVjdCAhPT0gbnVsbCAmJiB0aGlzLnRhcmdldE9iamVjdC5pc0RyYWdnZWQgPT09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRPYmplY3QudXBkYXRlKHRoaXMpID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgICAgIC8vICBXb3JrIG91dCB3aGljaCBvYmplY3QgaXMgb24gdGhlIHRvcAogICAgICAgIHRoaXMuX2hpZ2hlc3RSZW5kZXJPcmRlcklEID0gLTE7CiAgICAgICAgdGhpcy5faGlnaGVzdFJlbmRlck9iamVjdCA9IG51bGw7CiAgICAgICAgdGhpcy5faGlnaGVzdElucHV0UHJpb3JpdHlJRCA9IC0xOwoKICAgICAgICAvLyAgSnVzdCBydW4gdGhyb3VnaCB0aGUgbGlua2VkIGxpc3QKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmludGVyYWN0aXZlSXRlbXMudG90YWwgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5nYW1lLmlucHV0LmludGVyYWN0aXZlSXRlbXMubmV4dDsKCiAgICAgICAgICAgIGRvCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBJZiB0aGUgb2JqZWN0IGlzIHVzaW5nIHBpeGVsUGVyZmVjdCBjaGVja3MsIG9yIGhhcyBhIGhpZ2hlciBJbnB1dE1hbmFnZXIuUHJpb3JpdHlJRCBPUiBpZiB0aGUgcHJpb3JpdHkgSUQgaXMgdGhlIHNhbWUgYXMgdGhlIGN1cnJlbnQgaGlnaGVzdCBBTkQgaXQgaGFzIGEgaGlnaGVyIHJlbmRlck9yZGVySUQsIHRoZW4gc2V0IGl0IHRvIHRoZSB0b3AKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5waXhlbFBlcmZlY3QgfHwgY3VycmVudE5vZGUucHJpb3JpdHlJRCA+IHRoaXMuX2hpZ2hlc3RJbnB1dFByaW9yaXR5SUQgfHwgKGN1cnJlbnROb2RlLnByaW9yaXR5SUQgPT0gdGhpcy5faGlnaGVzdElucHV0UHJpb3JpdHlJRCAmJiBjdXJyZW50Tm9kZS5zcHJpdGUucmVuZGVyT3JkZXJJRCA+IHRoaXMuX2hpZ2hlc3RSZW5kZXJPcmRlcklEKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuY2hlY2tQb2ludGVyT3Zlcih0aGlzKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdIUk8gc2V0JywgY3VycmVudE5vZGUuc3ByaXRlLm5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWdoZXN0UmVuZGVyT3JkZXJJRCA9IGN1cnJlbnROb2RlLnNwcml0ZS5yZW5kZXJPcmRlcklEOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWdoZXN0SW5wdXRQcmlvcml0eUlEID0gY3VycmVudE5vZGUucHJpb3JpdHlJRDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlnaGVzdFJlbmRlck9iamVjdCA9IGN1cnJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUubmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gbnVsbCkKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9oaWdoZXN0UmVuZGVyT2JqZWN0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICAvLyAgVGhlIHBvaW50ZXIgaXNuJ3QgY3VycmVudGx5IG92ZXIgYW55dGhpbmcsIGNoZWNrIGlmIHdlJ3ZlIGdvdCBhIGxpbmdlcmluZyBwcmV2aW91cyB0YXJnZXQKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0T2JqZWN0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiVGhlIHBvaW50ZXIgaXNuJ3QgY3VycmVudGx5IG92ZXIgYW55dGhpbmcsIGNoZWNrIGlmIHdlJ3ZlIGdvdCBhIGxpbmdlcmluZyBwcmV2aW91cyB0YXJnZXQiKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0Ll9wb2ludGVyT3V0SGFuZGxlcih0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRPYmplY3QgPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIEFuZCBub3cgc2V0IHRoZSBuZXcgb25lCiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnQW5kIG5vdyBzZXQgdGhlIG5ldyBvbmUnKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0ID0gdGhpcy5faGlnaGVzdFJlbmRlck9iamVjdDsKICAgICAgICAgICAgICAgIHRoaXMuX2hpZ2hlc3RSZW5kZXJPYmplY3QuX3BvaW50ZXJPdmVySGFuZGxlcih0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBXZSd2ZSBnb3QgYSB0YXJnZXQgZnJvbSB0aGUgbGFzdCB1cGRhdGUKICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCJXZSd2ZSBnb3QgYSB0YXJnZXQgZnJvbSB0aGUgbGFzdCB1cGRhdGUiKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldE9iamVjdCA9PSB0aGlzLl9oaWdoZXN0UmVuZGVyT2JqZWN0KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICBTYW1lIHRhcmdldCBhcyBiZWZvcmUsIHNvIHVwZGF0ZSBpdAogICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCJTYW1lIHRhcmdldCBhcyBiZWZvcmUsIHNvIHVwZGF0ZSBpdCIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9oaWdoZXN0UmVuZGVyT2JqZWN0LnVwZGF0ZSh0aGlzKSA9PT0gZmFsc2UpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICBUaGUgdGFyZ2V0IGhhcyBjaGFuZ2VkLCBzbyB0ZWxsIHRoZSBvbGQgb25lIHdlJ3ZlIGxlZnQgaXQKICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiVGhlIHRhcmdldCBoYXMgY2hhbmdlZCwgc28gdGVsbCB0aGUgb2xkIG9uZSB3ZSd2ZSBsZWZ0IGl0Iik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QuX3BvaW50ZXJPdXRIYW5kbGVyKHRoaXMpOwoKICAgICAgICAgICAgICAgICAgICAvLyAgQW5kIG5vdyBzZXQgdGhlIG5ldyBvbmUKICAgICAgICAgICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdCA9IHRoaXMuX2hpZ2hlc3RSZW5kZXJPYmplY3Q7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QuX3BvaW50ZXJPdmVySGFuZGxlcih0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIHdoZW4gdGhlIFBvaW50ZXIgbGVhdmVzIHRoZSB0YXJnZXQgYXJlYS4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnRlciNsZWF2ZQogICAgKiBAcGFyYW0ge01vdXNlRXZlbnR8UG9pbnRlckV2ZW50fFRvdWNoRXZlbnR9IGV2ZW50IC0gVGhlIGV2ZW50IHBhc3NlZCB1cCBmcm9tIHRoZSBpbnB1dCBoYW5kbGVyLgogICAgKi8KICAgIGxlYXZlOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy53aXRoaW5HYW1lID0gZmFsc2U7CiAgICAgICAgdGhpcy5tb3ZlKGV2ZW50KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgd2hlbiB0aGUgUG9pbnRlciBsZWF2ZXMgdGhlIHRvdWNoc2NyZWVuLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludGVyI3N0b3AKICAgICogQHBhcmFtIHtNb3VzZUV2ZW50fFBvaW50ZXJFdmVudHxUb3VjaEV2ZW50fSBldmVudCAtIFRoZSBldmVudCBwYXNzZWQgdXAgZnJvbSB0aGUgaW5wdXQgaGFuZGxlci4KICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuX3N0YXRlUmVzZXQpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLnRpbWVVcCA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0Lk1PVVNFX09WRVJSSURFU19UT1VDSCB8fCB0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9UT1VDSF9DT01CSU5FIHx8ICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5UT1VDSF9PVkVSUklERVNfTU9VU0UgJiYgdGhpcy5nYW1lLmlucHV0LmN1cnJlbnRQb2ludGVycyA9PT0gMCkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQub25VcC5kaXNwYXRjaCh0aGlzLCBldmVudCk7CgogICAgICAgICAgICAvLyAgV2FzIGl0IGEgdGFwPwogICAgICAgICAgICBpZiAodGhpcy5kdXJhdGlvbiA+PSAwICYmIHRoaXMuZHVyYXRpb24gPD0gdGhpcy5nYW1lLmlucHV0LnRhcFJhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBXYXMgaXQgYSBkb3VibGUtdGFwPwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGltZVVwIC0gdGhpcy5wcmV2aW91c1RhcFRpbWUgPCB0aGlzLmdhbWUuaW5wdXQuZG91YmxlVGFwUmF0ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyAgWWVzLCBsZXQncyBkaXNwYXRjaCB0aGUgc2lnbmFsIHRoZW4gd2l0aCB0aGUgMm5kIHBhcmFtZXRlciBzZXQgdG8gdHJ1ZQogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5vblRhcC5kaXNwYXRjaCh0aGlzLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyAgV2Fzbid0IGEgZG91YmxlLXRhcCwgc28gZGlzcGF0Y2ggYSBzaW5nbGUgdGFwIHNpZ25hbAogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5vblRhcC5kaXNwYXRjaCh0aGlzLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5wcmV2aW91c1RhcFRpbWUgPSB0aGlzLnRpbWVVcDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gIE1vdXNlIGlzIGFsd2F5cyBhY3RpdmUKICAgICAgICBpZiAodGhpcy5pZCA+IDApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy53aXRoaW5HYW1lID0gZmFsc2U7CiAgICAgICAgdGhpcy5pc0Rvd24gPSBmYWxzZTsKICAgICAgICB0aGlzLmlzVXAgPSB0cnVlOwoKICAgICAgICBpZiAodGhpcy5pc01vdXNlID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5jdXJyZW50UG9pbnRlcnMtLTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuaW50ZXJhY3RpdmVJdGVtcy50b3RhbCA+IDApCiAgICAgICAgewogICAgICAgICAgICB2YXIgY3VycmVudE5vZGUgPSB0aGlzLmdhbWUuaW5wdXQuaW50ZXJhY3RpdmVJdGVtcy5uZXh0OwogICAgICAgICAgICAKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLl9yZWxlYXNlZEhhbmRsZXIodGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUubmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gbnVsbCkKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnRhcmdldE9iamVjdCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0Ll9yZWxlYXNlZEhhbmRsZXIodGhpcyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnRhcmdldE9iamVjdCA9IG51bGw7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIFBvaW50ZXIgaXMgY29uc2lkZXJlZCBqdXN0UHJlc3NlZCBpZiB0aGUgdGltZSBpdCB3YXMgcHJlc3NlZCBvbnRvIHRoZSB0b3VjaHNjcmVlbiBvciBjbGlja2VkIGlzIGxlc3MgdGhhbiBqdXN0UHJlc3NlZFJhdGUuCiAgICAqIE5vdGUgdGhhdCBjYWxsaW5nIGp1c3RQcmVzc2VkIGRvZXNuJ3QgcmVzZXQgdGhlIHByZXNzZWQgc3RhdHVzIG9mIHRoZSBQb2ludGVyLCBpdCB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGFzIGxvbmcgYXMgdGhlIGR1cmF0aW9uIGlzIHZhbGlkLgogICAgKiBJZiB5b3Ugd2lzaCB0byBjaGVjayBpZiB0aGUgUG9pbnRlciB3YXMgcHJlc3NlZCBkb3duIGp1c3Qgb25jZSB0aGVuIHNlZSB0aGUgU3ByaXRlLmV2ZW50cy5vbklucHV0RG93biBldmVudC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnRlciNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge251bWJlcn0gW2R1cmF0aW9uXSAtIFRoZSB0aW1lIHRvIGNoZWNrIGFnYWluc3QuIElmIG5vbmUgZ2l2ZW4gaXQgd2lsbCB1c2UgSW5wdXRNYW5hZ2VyLmp1c3RQcmVzc2VkUmF0ZS4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiB0aGUgUG9pbnRlciB3YXMgcHJlc3NlZCBkb3duIHdpdGhpbiB0aGUgZHVyYXRpb24gZ2l2ZW4uCiAgICAqLwogICAganVzdFByZXNzZWQ6IGZ1bmN0aW9uIChkdXJhdGlvbikgewoKICAgICAgICBkdXJhdGlvbiA9IGR1cmF0aW9uIHx8IHRoaXMuZ2FtZS5pbnB1dC5qdXN0UHJlc3NlZFJhdGU7CgogICAgICAgIHJldHVybiAodGhpcy5pc0Rvd24gPT09IHRydWUgJiYgKHRoaXMudGltZURvd24gKyBkdXJhdGlvbikgPiB0aGlzLmdhbWUudGltZS5ub3cpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBQb2ludGVyIGlzIGNvbnNpZGVyZWQganVzdFJlbGVhc2VkIGlmIHRoZSB0aW1lIGl0IGxlZnQgdGhlIHRvdWNoc2NyZWVuIGlzIGxlc3MgdGhhbiBqdXN0UmVsZWFzZWRSYXRlLgogICAgKiBOb3RlIHRoYXQgY2FsbGluZyBqdXN0UmVsZWFzZWQgZG9lc24ndCByZXNldCB0aGUgcHJlc3NlZCBzdGF0dXMgb2YgdGhlIFBvaW50ZXIsIGl0IHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgYXMgbG9uZyBhcyB0aGUgZHVyYXRpb24gaXMgdmFsaWQuCiAgICAqIElmIHlvdSB3aXNoIHRvIGNoZWNrIGlmIHRoZSBQb2ludGVyIHdhcyByZWxlYXNlZCBqdXN0IG9uY2UgdGhlbiBzZWUgdGhlIFNwcml0ZS5ldmVudHMub25JbnB1dFVwIGV2ZW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludGVyI2p1c3RSZWxlYXNlZAogICAgKiBAcGFyYW0ge251bWJlcn0gW2R1cmF0aW9uXSAtIFRoZSB0aW1lIHRvIGNoZWNrIGFnYWluc3QuIElmIG5vbmUgZ2l2ZW4gaXQgd2lsbCB1c2UgSW5wdXRNYW5hZ2VyLmp1c3RSZWxlYXNlZFJhdGUuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWYgdGhlIFBvaW50ZXIgd2FzIHJlbGVhc2VkIHdpdGhpbiB0aGUgZHVyYXRpb24gZ2l2ZW4uCiAgICAqLwogICAganVzdFJlbGVhc2VkOiBmdW5jdGlvbiAoZHVyYXRpb24pIHsKCiAgICAgICAgZHVyYXRpb24gPSBkdXJhdGlvbiB8fCB0aGlzLmdhbWUuaW5wdXQuanVzdFJlbGVhc2VkUmF0ZTsKCiAgICAgICAgcmV0dXJuICh0aGlzLmlzVXAgPT09IHRydWUgJiYgKHRoaXMudGltZVVwICsgZHVyYXRpb24pID4gdGhpcy5nYW1lLnRpbWUubm93KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXNldHMgdGhlIFBvaW50ZXIgcHJvcGVydGllcy4gQ2FsbGVkIGJ5IElucHV0TWFuYWdlci5yZXNldCB3aGVuIHlvdSBwZXJmb3JtIGEgU3RhdGUgY2hhbmdlLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludGVyI3Jlc2V0CiAgICAqLwogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuaXNNb3VzZSA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5pZGVudGlmaWVyID0gbnVsbDsKICAgICAgICB0aGlzLmlzRG93biA9IGZhbHNlOwogICAgICAgIHRoaXMuaXNVcCA9IHRydWU7CiAgICAgICAgdGhpcy50b3RhbFRvdWNoZXMgPSAwOwogICAgICAgIHRoaXMuX2hvbGRTZW50ID0gZmFsc2U7CiAgICAgICAgdGhpcy5faGlzdG9yeS5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuX3N0YXRlUmVzZXQgPSB0cnVlOwoKICAgICAgICBpZiAodGhpcy50YXJnZXRPYmplY3QpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdC5fcmVsZWFzZWRIYW5kbGVyKHRoaXMpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy50YXJnZXRPYmplY3QgPSBudWxsOwoKICAgIH0KCn07CgpQaGFzZXIuUG9pbnRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuUG9pbnRlcjsKCi8qKgoqIEhvdyBsb25nIHRoZSBQb2ludGVyIGhhcyBiZWVuIGRlcHJlc3NlZCBvbiB0aGUgdG91Y2hzY3JlZW4uIElmIG5vdCBjdXJyZW50bHkgZG93biBpdCByZXR1cm5zIC0xLgoqIEBuYW1lIFBoYXNlci5Qb2ludGVyI2R1cmF0aW9uCiogQHByb3BlcnR5IHtudW1iZXJ9IGR1cmF0aW9uIC0gSG93IGxvbmcgdGhlIFBvaW50ZXIgaGFzIGJlZW4gZGVwcmVzc2VkIG9uIHRoZSB0b3VjaHNjcmVlbi4gSWYgbm90IGN1cnJlbnRseSBkb3duIGl0IHJldHVybnMgLTEuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUG9pbnRlci5wcm90b3R5cGUsICJkdXJhdGlvbiIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuaXNVcCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLnRpbWVEb3duOwoKICAgIH0KCn0pOwoKLyoqCiogR2V0cyB0aGUgWCB2YWx1ZSBvZiB0aGlzIFBvaW50ZXIgaW4gd29ybGQgY29vcmRpbmF0ZXMgYmFzZWQgb24gdGhlIHdvcmxkIGNhbWVyYS4KKiBAbmFtZSBQaGFzZXIuUG9pbnRlciN3b3JsZFgKKiBAcHJvcGVydHkge251bWJlcn0gZHVyYXRpb24gLSBUaGUgWCB2YWx1ZSBvZiB0aGlzIFBvaW50ZXIgaW4gd29ybGQgY29vcmRpbmF0ZXMgYmFzZWQgb24gdGhlIHdvcmxkIGNhbWVyYS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Qb2ludGVyLnByb3RvdHlwZSwgIndvcmxkWCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS53b3JsZC5jYW1lcmEueCArIHRoaXMueDsKCiAgICB9Cgp9KTsKCi8qKgoqIEdldHMgdGhlIFkgdmFsdWUgb2YgdGhpcyBQb2ludGVyIGluIHdvcmxkIGNvb3JkaW5hdGVzIGJhc2VkIG9uIHRoZSB3b3JsZCBjYW1lcmEuCiogQG5hbWUgUGhhc2VyLlBvaW50ZXIjd29ybGRZCiogQHByb3BlcnR5IHtudW1iZXJ9IGR1cmF0aW9uIC0gVGhlIFkgdmFsdWUgb2YgdGhpcyBQb2ludGVyIGluIHdvcmxkIGNvb3JkaW5hdGVzIGJhc2VkIG9uIHRoZSB3b3JsZCBjYW1lcmEuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUG9pbnRlci5wcm90b3R5cGUsICJ3b3JsZFkiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiB0aGlzLmdhbWUud29ybGQuY2FtZXJhLnkgKyB0aGlzLnk7CgogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIuVG91Y2ggaGFuZGxlcyB0b3VjaCBldmVudHMgd2l0aCB5b3VyIGdhbWUuIE5vdGU6IEFuZHJvaWQgMi54IG9ubHkgc3VwcG9ydHMgMSB0b3VjaCBldmVudCBhdCBvbmNlLCBubyBtdWx0aS10b3VjaC4KKgoqIEBjbGFzcyBQaGFzZXIuVG91Y2gKKiBAY2xhc3NkZXNjIFRoZSBUb3VjaCBjbGFzcyBoYW5kbGVzIHRvdWNoIGludGVyYWN0aW9ucyB3aXRoIHRoZSBnYW1lIGFuZCB0aGUgcmVzdWx0aW5nIFBvaW50ZXIgb2JqZWN0cy4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5Ub3VjaCA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBkaXNhYmxlZCAtIFlvdSBjYW4gZGlzYWJsZSBhbGwgVG91Y2ggZXZlbnRzIGJ5IHNldHRpbmcgZGlzYWJsZWQgPSB0cnVlLiBXaGlsZSBzZXQgYWxsIG5ldyB0b3VjaCBldmVudHMgd2lsbCBiZSBpZ25vcmVkLgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtPYmplY3R9IGNhbGxiYWNrQ29udGV4dCAtIFRoZSBjb250ZXh0IHVuZGVyIHdoaWNoIGNhbGxiYWNrcyBhcmUgY2FsbGVkLgogICAgKi8KICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gdGhpcy5nYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSB0b3VjaFN0YXJ0Q2FsbGJhY2sgLSBBIGNhbGxiYWNrIHRoYXQgY2FuIGJlIGZpcmVkIG9uIGEgdG91Y2hTdGFydCBldmVudC4KICAgICovCiAgICB0aGlzLnRvdWNoU3RhcnRDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSB0b3VjaE1vdmVDYWxsYmFjayAtIEEgY2FsbGJhY2sgdGhhdCBjYW4gYmUgZmlyZWQgb24gYSB0b3VjaE1vdmUgZXZlbnQuCiAgICAqLwogICAgdGhpcy50b3VjaE1vdmVDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSB0b3VjaEVuZENhbGxiYWNrIC0gQSBjYWxsYmFjayB0aGF0IGNhbiBiZSBmaXJlZCBvbiBhIHRvdWNoRW5kIGV2ZW50LgogICAgKi8KICAgIHRoaXMudG91Y2hFbmRDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSB0b3VjaEVudGVyQ2FsbGJhY2sgLSBBIGNhbGxiYWNrIHRoYXQgY2FuIGJlIGZpcmVkIG9uIGEgdG91Y2hFbnRlciBldmVudC4KICAgICovCiAgICB0aGlzLnRvdWNoRW50ZXJDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSB0b3VjaExlYXZlQ2FsbGJhY2sgLSBBIGNhbGxiYWNrIHRoYXQgY2FuIGJlIGZpcmVkIG9uIGEgdG91Y2hMZWF2ZSBldmVudC4KICAgICovCiAgICB0aGlzLnRvdWNoTGVhdmVDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSB0b3VjaENhbmNlbENhbGxiYWNrIC0gQSBjYWxsYmFjayB0aGF0IGNhbiBiZSBmaXJlZCBvbiBhIHRvdWNoQ2FuY2VsIGV2ZW50LgogICAgKi8KICAgIHRoaXMudG91Y2hDYW5jZWxDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHByZXZlbnREZWZhdWx0IC0gSWYgdHJ1ZSB0aGUgVG91Y2hFdmVudCB3aWxsIGhhdmUgcHJldmVudC5kZWZhdWx0IGNhbGxlZCBvbiBpdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnByZXZlbnREZWZhdWx0ID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtUb3VjaEV2ZW50fSBldmVudCAtIFRoZSBicm93c2VyIHRvdWNoIERPTSBldmVudC4gV2lsbCBiZSBzZXQgdG8gbnVsbCBpZiBubyB0b3VjaCBldmVudCBoYXMgZXZlciBiZWVuIHJlY2VpdmVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZXZlbnQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25Ub3VjaFN0YXJ0IC0gSW50ZXJuYWwgZXZlbnQgaGFuZGxlciByZWZlcmVuY2UuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fb25Ub3VjaFN0YXJ0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uVG91Y2hNb3ZlIC0gSW50ZXJuYWwgZXZlbnQgaGFuZGxlciByZWZlcmVuY2UuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fb25Ub3VjaE1vdmUgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25Ub3VjaEVuZCAtIEludGVybmFsIGV2ZW50IGhhbmRsZXIgcmVmZXJlbmNlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uVG91Y2hFbmQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25Ub3VjaEVudGVyIC0gSW50ZXJuYWwgZXZlbnQgaGFuZGxlciByZWZlcmVuY2UuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fb25Ub3VjaEVudGVyID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uVG91Y2hMZWF2ZSAtIEludGVybmFsIGV2ZW50IGhhbmRsZXIgcmVmZXJlbmNlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uVG91Y2hMZWF2ZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vblRvdWNoQ2FuY2VsIC0gSW50ZXJuYWwgZXZlbnQgaGFuZGxlciByZWZlcmVuY2UuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fb25Ub3VjaENhbmNlbCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vblRvdWNoTW92ZSAtIEludGVybmFsIGV2ZW50IGhhbmRsZXIgcmVmZXJlbmNlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uVG91Y2hNb3ZlID0gbnVsbDsKCn07CgpQaGFzZXIuVG91Y2gucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBTdGFydHMgdGhlIGV2ZW50IGxpc3RlbmVycyBydW5uaW5nLgogICAgKiBAbWV0aG9kIFBoYXNlci5Ub3VjaCNzdGFydAogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLnRvdWNoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fb25Ub3VjaFN0YXJ0ID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMub25Ub3VjaFN0YXJ0KGV2ZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuX29uVG91Y2hNb3ZlID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMub25Ub3VjaE1vdmUoZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5fb25Ub3VjaEVuZCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uVG91Y2hFbmQoZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5fb25Ub3VjaEVudGVyID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMub25Ub3VjaEVudGVyKGV2ZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuX29uVG91Y2hMZWF2ZSA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uVG91Y2hMZWF2ZShldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9vblRvdWNoQ2FuY2VsID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMub25Ub3VjaENhbmNlbChldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgdGhpcy5fb25Ub3VjaFN0YXJ0LCBmYWxzZSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMuX29uVG91Y2hNb3ZlLCBmYWxzZSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgdGhpcy5fb25Ub3VjaEVuZCwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVudGVyJywgdGhpcy5fb25Ub3VjaEVudGVyLCBmYWxzZSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobGVhdmUnLCB0aGlzLl9vblRvdWNoTGVhdmUsIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCB0aGlzLl9vblRvdWNoQ2FuY2VsLCBmYWxzZSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENvbnN1bWVzIGFsbCB0b3VjaG1vdmUgZXZlbnRzIG9uIHRoZSBkb2N1bWVudCAob25seSBlbmFibGUgdGhpcyBpZiB5b3Uga25vdyB5b3UgbmVlZCBpdCEpLgogICAgKiBAbWV0aG9kIFBoYXNlci5Ub3VjaCNjb25zdW1lVG91Y2hNb3ZlCiAgICAqLwogICAgY29uc3VtZURvY3VtZW50VG91Y2hlczogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9kb2N1bWVudFRvdWNoTW92ZSA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH07CgogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMuX2RvY3VtZW50VG91Y2hNb3ZlLCBmYWxzZSk7CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIGludGVybmFsIG1ldGhvZCB0aGF0IGhhbmRsZXMgdGhlIHRvdWNoc3RhcnQgZXZlbnQgZnJvbSB0aGUgYnJvd3Nlci4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjb25Ub3VjaFN0YXJ0CiAgICAqIEBwYXJhbSB7VG91Y2hFdmVudH0gZXZlbnQgLSBUaGUgbmF0aXZlIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuIFRoaXMgZ2V0cyBzdG9yZWQgaW4gVG91Y2guZXZlbnQuCiAgICAqLwogICAgb25Ub3VjaFN0YXJ0OiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5ldmVudCA9IGV2ZW50OwoKICAgICAgICBpZiAodGhpcy50b3VjaFN0YXJ0Q2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRvdWNoU3RhcnRDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wcmV2ZW50RGVmYXVsdCkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICAvLyAgZXZlbnQudGFyZ2V0VG91Y2hlcyA9IGxpc3Qgb2YgYWxsIHRvdWNoZXMgb24gdGhlIFRBUkdFVCBFTEVNRU5UIChpLmUuIGdhbWUgZG9tIGVsZW1lbnQpCiAgICAgICAgLy8gIGV2ZW50LnRvdWNoZXMgPSBsaXN0IG9mIGFsbCB0b3VjaGVzIG9uIHRoZSBFTlRJUkUgRE9DVU1FTlQsIG5vdCBqdXN0IHRoZSB0YXJnZXQgZWxlbWVudAogICAgICAgIC8vICBldmVudC5jaGFuZ2VkVG91Y2hlcyA9IHRoZSB0b3VjaGVzIHRoYXQgQ0hBTkdFRCBpbiB0aGlzIGV2ZW50LCBub3QgdGhlIHRvdGFsIG51bWJlciBvZiB0aGVtCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5zdGFydFBvaW50ZXIoZXZlbnQuY2hhbmdlZFRvdWNoZXNbaV0pOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBUb3VjaCBjYW5jZWwgLSB0b3VjaGVzIHRoYXQgd2VyZSBkaXNydXB0ZWQgKHBlcmhhcHMgYnkgbW92aW5nIGludG8gYSBwbHVnaW4gb3IgYnJvd3NlciBjaHJvbWUpLgogICAgKiBPY2N1cnMgZm9yIGV4YW1wbGUgb24gaU9TIHdoZW4geW91IHB1dCBkb3duIDQgZmluZ2VycyBhbmQgdGhlIGFwcCBzZWxlY3RvciBVSSBhcHBlYXJzLgogICAgKiBAbWV0aG9kIFBoYXNlci5Ub3VjaCNvblRvdWNoQ2FuY2VsCiAgICAqIEBwYXJhbSB7VG91Y2hFdmVudH0gZXZlbnQgLSBUaGUgbmF0aXZlIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuIFRoaXMgZ2V0cyBzdG9yZWQgaW4gVG91Y2guZXZlbnQuCiAgICAqLwogICAgb25Ub3VjaENhbmNlbDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuZXZlbnQgPSBldmVudDsKCiAgICAgICAgaWYgKHRoaXMudG91Y2hDYW5jZWxDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudG91Y2hDYW5jZWxDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wcmV2ZW50RGVmYXVsdCkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICAvLyAgVG91Y2ggY2FuY2VsIC0gdG91Y2hlcyB0aGF0IHdlcmUgZGlzcnVwdGVkIChwZXJoYXBzIGJ5IG1vdmluZyBpbnRvIGEgcGx1Z2luIG9yIGJyb3dzZXIgY2hyb21lKQogICAgICAgIC8vICBodHRwOi8vd3d3LnczLm9yZy9UUi90b3VjaC1ldmVudHMvI2Rmbi10b3VjaGNhbmNlbAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc3RvcFBvaW50ZXIoZXZlbnQuY2hhbmdlZFRvdWNoZXNbaV0pOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBGb3IgdG91Y2ggZW50ZXIgYW5kIGxlYXZlIGl0cyBhIGxpc3Qgb2YgdGhlIHRvdWNoIHBvaW50cyB0aGF0IGhhdmUgZW50ZXJlZCBvciBsZWZ0IHRoZSB0YXJnZXQuCiAgICAqIERvZXNuJ3QgYXBwZWFyIHRvIGJlIHN1cHBvcnRlZCBieSBtb3N0IGJyb3dzZXJzIG9uIGEgY2FudmFzIGVsZW1lbnQgeWV0LgogICAgKiBAbWV0aG9kIFBoYXNlci5Ub3VjaCNvblRvdWNoRW50ZXIKICAgICogQHBhcmFtIHtUb3VjaEV2ZW50fSBldmVudCAtIFRoZSBuYXRpdmUgZXZlbnQgZnJvbSB0aGUgYnJvd3Nlci4gVGhpcyBnZXRzIHN0b3JlZCBpbiBUb3VjaC5ldmVudC4KICAgICovCiAgICBvblRvdWNoRW50ZXI6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7CgogICAgICAgIGlmICh0aGlzLnRvdWNoRW50ZXJDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudG91Y2hFbnRlckNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnByZXZlbnREZWZhdWx0KQogICAgICAgIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogRm9yIHRvdWNoIGVudGVyIGFuZCBsZWF2ZSBpdHMgYSBsaXN0IG9mIHRoZSB0b3VjaCBwb2ludHMgdGhhdCBoYXZlIGVudGVyZWQgb3IgbGVmdCB0aGUgdGFyZ2V0LgogICAgKiBEb2Vzbid0IGFwcGVhciB0byBiZSBzdXBwb3J0ZWQgYnkgbW9zdCBicm93c2VycyBvbiBhIGNhbnZhcyBlbGVtZW50IHlldC4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjb25Ub3VjaExlYXZlCiAgICAqIEBwYXJhbSB7VG91Y2hFdmVudH0gZXZlbnQgLSBUaGUgbmF0aXZlIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuIFRoaXMgZ2V0cyBzdG9yZWQgaW4gVG91Y2guZXZlbnQuCiAgICAqLwogICAgb25Ub3VjaExlYXZlOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5ldmVudCA9IGV2ZW50OwoKICAgICAgICBpZiAodGhpcy50b3VjaExlYXZlQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRvdWNoTGVhdmVDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wcmV2ZW50RGVmYXVsdCkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBoYW5kbGVyIGZvciB0aGUgdG91Y2htb3ZlIGV2ZW50cy4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjb25Ub3VjaE1vdmUKICAgICogQHBhcmFtIHtUb3VjaEV2ZW50fSBldmVudCAtIFRoZSBuYXRpdmUgZXZlbnQgZnJvbSB0aGUgYnJvd3Nlci4gVGhpcyBnZXRzIHN0b3JlZCBpbiBUb3VjaC5ldmVudC4KICAgICovCiAgICBvblRvdWNoTW92ZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuZXZlbnQgPSBldmVudDsKCiAgICAgICAgaWYgKHRoaXMudG91Y2hNb3ZlQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRvdWNoTW92ZUNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnByZXZlbnREZWZhdWx0KQogICAgICAgIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQudXBkYXRlUG9pbnRlcihldmVudC5jaGFuZ2VkVG91Y2hlc1tpXSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBoYW5kbGVyIGZvciB0aGUgdG91Y2hlbmQgZXZlbnRzLgogICAgKiBAbWV0aG9kIFBoYXNlci5Ub3VjaCNvblRvdWNoRW5kCiAgICAqIEBwYXJhbSB7VG91Y2hFdmVudH0gZXZlbnQgLSBUaGUgbmF0aXZlIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuIFRoaXMgZ2V0cyBzdG9yZWQgaW4gVG91Y2guZXZlbnQuCiAgICAqLwogICAgb25Ub3VjaEVuZDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuZXZlbnQgPSBldmVudDsKCiAgICAgICAgaWYgKHRoaXMudG91Y2hFbmRDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudG91Y2hFbmRDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wcmV2ZW50RGVmYXVsdCkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICAvLyAgRm9yIHRvdWNoIGVuZCBpdHMgYSBsaXN0IG9mIHRoZSB0b3VjaCBwb2ludHMgdGhhdCBoYXZlIGJlZW4gcmVtb3ZlZCBmcm9tIHRoZSBzdXJmYWNlCiAgICAgICAgLy8gIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL1RvdWNoTGlzdAogICAgICAgIC8vICBldmVudC5jaGFuZ2VkVG91Y2hlcyA9IHRoZSB0b3VjaGVzIHRoYXQgQ0hBTkdFRCBpbiB0aGlzIGV2ZW50LCBub3QgdGhlIHRvdGFsIG51bWJlciBvZiB0aGVtCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5zdG9wUG9pbnRlcihldmVudC5jaGFuZ2VkVG91Y2hlc1tpXSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3AgdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjc3RvcAogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UudG91Y2gpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCB0aGlzLl9vblRvdWNoU3RhcnQpOwogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMuX29uVG91Y2hNb3ZlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRoaXMuX29uVG91Y2hFbmQpOwogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW50ZXInLCB0aGlzLl9vblRvdWNoRW50ZXIpOwogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobGVhdmUnLCB0aGlzLl9vblRvdWNoTGVhdmUpOwogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgdGhpcy5fb25Ub3VjaENhbmNlbCk7CiAgICAgICAgfQoKICAgIH0KCn07CgpQaGFzZXIuVG91Y2gucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlRvdWNoOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIElucHV0IEhhbmRsZXIgaXMgYm91bmQgdG8gYSBzcGVjaWZpYyBTcHJpdGUgYW5kIGlzIHJlc3BvbnNpYmxlIGZvciBtYW5hZ2luZyBhbGwgSW5wdXQgZXZlbnRzIG9uIHRoYXQgU3ByaXRlLgoqIEBjbGFzcyBQaGFzZXIuSW5wdXRIYW5kbGVyCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBUaGUgU3ByaXRlIG9iamVjdCB0byB3aGljaCB0aGlzIElucHV0IEhhbmRsZXIgYmVsb25ncy4KKi8KUGhhc2VyLklucHV0SGFuZGxlciA9IGZ1bmN0aW9uIChzcHJpdGUpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBUaGUgU3ByaXRlIG9iamVjdCB0byB3aGljaCB0aGlzIElucHV0IEhhbmRsZXIgYmVsb25ncy4KICAgICovCiAgICB0aGlzLnNwcml0ZSA9IHNwcml0ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLiAKICAgICovCiAgICB0aGlzLmdhbWUgPSBzcHJpdGUuZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBlbmFibGVkIC0gSWYgZW5hYmxlZCB0aGUgSW5wdXQgSGFuZGxlciB3aWxsIHByb2Nlc3MgaW5wdXQgcmVxdWVzdHMgYW5kIG1vbml0b3IgcG9pbnRlciBhY3Rpdml0eS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHByaW9yaXR5SUQgLSBUaGUgUHJpb3JpdHlJRCBjb250cm9scyB3aGljaCBTcHJpdGUgcmVjZWl2ZXMgYW4gSW5wdXQgZXZlbnQgZmlyc3QgaWYgdGhleSBzaG91bGQgb3ZlcmxhcC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnByaW9yaXR5SUQgPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB1c2VIYW5kQ3Vyc29yIC0gT24gYSBkZXNrdG9wIGJyb3dzZXIgeW91IGNhbiBzZXQgdGhlICdoYW5kJyBjdXJzb3IgdG8gYXBwZWFyIHdoZW4gbW92aW5nIG92ZXIgdGhlIFNwcml0ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnVzZUhhbmRDdXJzb3IgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNEcmFnZ2VkIC0gdHJ1ZSBpZiB0aGUgU3ByaXRlIGlzIGJlaW5nIGN1cnJlbnRseSBkcmFnZ2VkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNEcmFnZ2VkID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsbG93SG9yaXpvbnRhbERyYWcgLSBDb250cm9scyBpZiB0aGUgU3ByaXRlIGlzIGFsbG93ZWQgdG8gYmUgZHJhZ2dlZCBob3Jpem9udGFsbHkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbGxvd0hvcml6b250YWxEcmFnID0gdHJ1ZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWxsb3dWZXJ0aWNhbERyYWcgLSBDb250cm9scyBpZiB0aGUgU3ByaXRlIGlzIGFsbG93ZWQgdG8gYmUgZHJhZ2dlZCB2ZXJ0aWNhbGx5LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYWxsb3dWZXJ0aWNhbERyYWcgPSB0cnVlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBicmluZ1RvVG9wIC0gSWYgdHJ1ZSB3aGVuIHRoaXMgU3ByaXRlIGlzIGNsaWNrZWQgb3IgZHJhZ2dlZCBpdCB3aWxsIGF1dG9tYXRpY2FsbHkgYmUgYm91Z2h0IHRvIHRoZSB0b3Agb2YgdGhlIEdyb3VwIGl0IGlzIHdpdGhpbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmJyaW5nVG9Ub3AgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHNuYXBPZmZzZXQgLSBBIFBvaW50IG9iamVjdCB0aGF0IGNvbnRhaW5zIGJ5IGhvdyBmYXIgdGhlIFNwcml0ZSBzbmFwIGlzIG9mZnNldC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNuYXBPZmZzZXQgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBzbmFwT25EcmFnIC0gV2hlbiB0aGUgU3ByaXRlIGlzIGRyYWdnZWQgdGhpcyBjb250cm9scyBpZiB0aGUgY2VudGVyIG9mIHRoZSBTcHJpdGUgd2lsbCBzbmFwIHRvIHRoZSBwb2ludGVyIG9uIGRyYWcgb3Igbm90LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc25hcE9uRHJhZyA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBzbmFwT25SZWxlYXNlIC0gV2hlbiB0aGUgU3ByaXRlIGlzIGRyYWdnZWQgdGhpcyBjb250cm9scyBpZiB0aGUgU3ByaXRlIHdpbGwgYmUgc25hcHBlZCBvbiByZWxlYXNlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc25hcE9uUmVsZWFzZSA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNuYXBYIC0gV2hlbiBhIFNwcml0ZSBoYXMgc25hcHBpbmcgZW5hYmxlZCB0aGlzIGhvbGRzIHRoZSB3aWR0aCBvZiB0aGUgc25hcCBncmlkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc25hcFggPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNuYXBZIC0gV2hlbiBhIFNwcml0ZSBoYXMgc25hcHBpbmcgZW5hYmxlZCB0aGlzIGhvbGRzIHRoZSBoZWlnaHQgb2YgdGhlIHNuYXAgZ3JpZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNuYXBZID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNuYXBPZmZzZXRYIC0gVGhpcyBkZWZpbmVzIHRoZSB0b3AtbGVmdCBYIGNvb3JkaW5hdGUgb2YgdGhlIHNuYXAgZ3JpZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNuYXBPZmZzZXRYID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzbmFwT2Zmc2V0WSAtIFRoaXMgZGVmaW5lcyB0aGUgdG9wLWxlZnQgWSBjb29yZGluYXRlIG9mIHRoZSBzbmFwIGdyaWQuLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc25hcE9mZnNldFkgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGl4ZWxQZXJmZWN0IC0gU2hvdWxkIHdlIHVzZSBwaXhlbCBwZXJmZWN0IGhpdCBkZXRlY3Rpb24/IFdhcm5pbmc6IGV4cGVuc2l2ZS4gT25seSBlbmFibGUgaWYgeW91IHJlYWxseSBuZWVkIGl0IQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGl4ZWxQZXJmZWN0ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwaXhlbFBlcmZlY3RBbHBoYSAtIFRoZSBhbHBoYSB0b2xlcmFuY2UgdGhyZXNob2xkLiBJZiB0aGUgYWxwaGEgdmFsdWUgb2YgdGhlIHBpeGVsIG1hdGNoZXMgb3IgaXMgYWJvdmUgdGhpcyB2YWx1ZSwgaXQncyBjb25zaWRlcmVkIGEgaGl0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGl4ZWxQZXJmZWN0QWxwaGEgPSAyNTU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZHJhZ2dhYmxlIC0gSXMgdGhpcyBzcHJpdGUgYWxsb3dlZCB0byBiZSBkcmFnZ2VkIGJ5IHRoZSBtb3VzZT8gdHJ1ZSA9IHllcywgZmFsc2UgPSBubwogICAgKiBAZGVmYXVsdCAKICAgICovCiAgICB0aGlzLmRyYWdnYWJsZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IGJvdW5kc1JlY3QgLSBBIHJlZ2lvbiBvZiB0aGUgZ2FtZSB3b3JsZCB3aXRoaW4gd2hpY2ggdGhlIHNwcml0ZSBpcyByZXN0cmljdGVkIGR1cmluZyBkcmFnLgogICAgKiBAZGVmYXVsdCAKICAgICovCiAgICB0aGlzLmJvdW5kc1JlY3QgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TcHJpdGV9IGJvdW5kc1Nwcml0ZSAtIEEgU3ByaXRlIHRoZSBib3VuZHMgb2Ygd2hpY2ggdGhpcyBzcHJpdGUgaXMgcmVzdHJpY3RlZCBkdXJpbmcgZHJhZy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmJvdW5kc1Nwcml0ZSA9IG51bGw7CgogICAgLyoqCiAgICAqIElmIHRoaXMgb2JqZWN0IGlzIHNldCB0byBjb25zdW1lIHRoZSBwb2ludGVyIGV2ZW50IHRoZW4gaXQgd2lsbCBzdG9wIGFsbCBwcm9wb2dhdGlvbiBmcm9tIHRoaXMgb2JqZWN0IG9uLgogICAgKiBGb3IgZXhhbXBsZSBpZiB5b3UgaGFkIGEgc3RhY2sgb2YgNiBzcHJpdGVzIHdpdGggdGhlIHNhbWUgcHJpb3JpdHkgSURzIGFuZCBvbmUgY29uc3VtZWQgdGhlIGV2ZW50LCBub25lIG9mIHRoZSBvdGhlcnMgd291bGQgcmVjZWl2ZSBpdC4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBjb25zdW1lUG9pbnRlckV2ZW50CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb25zdW1lUG9pbnRlckV2ZW50ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBfdGVtcFBvaW50IC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdGVtcFBvaW50ID0gbmV3IFBoYXNlci5Qb2ludCgpOwoKICAgIHRoaXMuX3BvaW50ZXJEYXRhID0gW107CgogICAgdGhpcy5fcG9pbnRlckRhdGEucHVzaCh7CiAgICAgICAgaWQ6IDAsCiAgICAgICAgeDogMCwKICAgICAgICB5OiAwLAogICAgICAgIGlzRG93bjogZmFsc2UsCiAgICAgICAgaXNVcDogZmFsc2UsCiAgICAgICAgaXNPdmVyOiBmYWxzZSwKICAgICAgICBpc091dDogZmFsc2UsCiAgICAgICAgdGltZU92ZXI6IDAsCiAgICAgICAgdGltZU91dDogMCwKICAgICAgICB0aW1lRG93bjogMCwKICAgICAgICB0aW1lVXA6IDAsCiAgICAgICAgZG93bkR1cmF0aW9uOiAwLAogICAgICAgIGlzRHJhZ2dlZDogZmFsc2UKICAgIH0pOwoKfTsKClBoYXNlci5JbnB1dEhhbmRsZXIucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBTdGFydHMgdGhlIElucHV0IEhhbmRsZXIgcnVubmluZy4gVGhpcyBpcyBjYWxsZWQgYXV0b21hdGljYWxseSB3aGVuIHlvdSBlbmFibGUgaW5wdXQgb24gYSBTcHJpdGUsIG9yIGNhbiBiZSBjYWxsZWQgZGlyZWN0bHkgaWYgeW91IG5lZWQgdG8gc2V0IGEgc3BlY2lmaWMgcHJpb3JpdHkuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNzdGFydAogICAgKiBAcGFyYW0ge251bWJlcn0gcHJpb3JpdHkgLSBIaWdoZXIgcHJpb3JpdHkgc3ByaXRlcyB0YWtlIGNsaWNrIHByaW9yaXR5IG92ZXIgbG93LXByaW9yaXR5IHNwcml0ZXMgd2hlbiB0aGV5IGFyZSBzdGFja2VkIG9uLXRvcCBvZiBlYWNoIG90aGVyLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHVzZUhhbmRDdXJzb3IgLSBJZiB0cnVlIHRoZSBTcHJpdGUgd2lsbCBzaG93IHRoZSBoYW5kIGN1cnNvciBvbiBtb3VzZS1vdmVyIChkb2Vzbid0IGFwcGx5IHRvIG1vYmlsZSBicm93c2VycykKICAgICogQHJldHVybiB7UGhhc2VyLlNwcml0ZX0gVGhlIFNwcml0ZSBvYmplY3QgdG8gd2hpY2ggdGhlIElucHV0IEhhbmRsZXIgaXMgYm91bmQuCiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uIChwcmlvcml0eSwgdXNlSGFuZEN1cnNvcikgewoKICAgICAgICBwcmlvcml0eSA9IHByaW9yaXR5IHx8IDA7CiAgICAgICAgaWYgKHR5cGVvZiB1c2VIYW5kQ3Vyc29yID09ICd1bmRlZmluZWQnKSB7IHVzZUhhbmRDdXJzb3IgPSBmYWxzZTsgfQoKICAgICAgICAvLyAgVHVybmluZyBvbgogICAgICAgIGlmICh0aGlzLmVuYWJsZWQgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFJlZ2lzdGVyLCBldGMKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LmludGVyYWN0aXZlSXRlbXMuYWRkKHRoaXMpOwogICAgICAgICAgICB0aGlzLnVzZUhhbmRDdXJzb3IgPSB1c2VIYW5kQ3Vyc29yOwogICAgICAgICAgICB0aGlzLnByaW9yaXR5SUQgPSBwcmlvcml0eTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTA7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbaV0gPSB7CiAgICAgICAgICAgICAgICAgICAgaWQ6IGksCiAgICAgICAgICAgICAgICAgICAgeDogMCwKICAgICAgICAgICAgICAgICAgICB5OiAwLAogICAgICAgICAgICAgICAgICAgIGlzRG93bjogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgaXNVcDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgaXNPdmVyOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBpc091dDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgdGltZU92ZXI6IDAsCiAgICAgICAgICAgICAgICAgICAgdGltZU91dDogMCwKICAgICAgICAgICAgICAgICAgICB0aW1lRG93bjogMCwKICAgICAgICAgICAgICAgICAgICB0aW1lVXA6IDAsCiAgICAgICAgICAgICAgICAgICAgZG93bkR1cmF0aW9uOiAwLAogICAgICAgICAgICAgICAgICAgIGlzRHJhZ2dlZDogZmFsc2UKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc25hcE9mZnNldCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKICAgICAgICAgICAgdGhpcy5lbmFibGVkID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vICBDcmVhdGUgdGhlIHNpZ25hbHMgdGhlIElucHV0IGNvbXBvbmVudCB3aWxsIGVtaXQKICAgICAgICAgICAgaWYgKHRoaXMuc3ByaXRlLmV2ZW50cyAmJiB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dE92ZXIgPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXRPdmVyID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0T3V0ID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0RG93biA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dFVwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbkRyYWdTdGFydCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25EcmFnU3RvcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLnNwcml0ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXNldHMgdGhlIElucHV0IEhhbmRsZXIgYW5kIGRpc2FibGVzIGl0LgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcmVzZXQKICAgICovCiAgICByZXNldDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAxMDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbaV0gPSB7CiAgICAgICAgICAgICAgICBpZDogaSwKICAgICAgICAgICAgICAgIHg6IDAsCiAgICAgICAgICAgICAgICB5OiAwLAogICAgICAgICAgICAgICAgaXNEb3duOiBmYWxzZSwKICAgICAgICAgICAgICAgIGlzVXA6IGZhbHNlLAogICAgICAgICAgICAgICAgaXNPdmVyOiBmYWxzZSwKICAgICAgICAgICAgICAgIGlzT3V0OiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVPdmVyOiAwLAogICAgICAgICAgICAgICAgdGltZU91dDogMCwKICAgICAgICAgICAgICAgIHRpbWVEb3duOiAwLAogICAgICAgICAgICAgICAgdGltZVVwOiAwLAogICAgICAgICAgICAgICAgZG93bkR1cmF0aW9uOiAwLAogICAgICAgICAgICAgICAgaXNEcmFnZ2VkOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3BzIHRoZSBJbnB1dCBIYW5kbGVyIGZyb20gcnVubmluZy4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3N0b3AKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vICBUdXJuaW5nIG9mZgogICAgICAgIGlmICh0aGlzLmVuYWJsZWQgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgRGUtcmVnaXN0ZXIsIGV0YwogICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LmludGVyYWN0aXZlSXRlbXMucmVtb3ZlKHRoaXMpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGVhbiB1cCBtZW1vcnkuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5lbmFibGVkKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lbmFibGVkID0gZmFsc2U7CgogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuaW50ZXJhY3RpdmVJdGVtcy5yZW1vdmUodGhpcyk7CgogICAgICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICAgICAgICAgIHRoaXMuc3ByaXRlID0gbnVsbDsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBJbnB1dCBwb2ludGVyLCByZWxhdGl2ZSB0byB0aGUgdG9wLWxlZnQgb2YgdGhlIHBhcmVudCBTcHJpdGUuCiAgICAqIFRoaXMgdmFsdWUgaXMgb25seSBzZXQgd2hlbiB0aGUgcG9pbnRlciBpcyBvdmVyIHRoaXMgU3ByaXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlclgKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIElucHV0IHBvaW50ZXIuCiAgICAqLwogICAgcG9pbnRlclg6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS54OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIElucHV0IHBvaW50ZXIsIHJlbGF0aXZlIHRvIHRoZSB0b3AtbGVmdCBvZiB0aGUgcGFyZW50IFNwcml0ZQogICAgKiBUaGlzIHZhbHVlIGlzIG9ubHkgc2V0IHdoZW4gdGhlIHBvaW50ZXIgaXMgb3ZlciB0aGlzIFNwcml0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJZCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBJbnB1dCBwb2ludGVyLgogICAgKi8KICAgIHBvaW50ZXJZOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0ueTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJZiB0aGUgUG9pbnRlciBpcyB0b3VjaGluZyB0aGUgdG91Y2hzY3JlZW4sIG9yIHRoZSBtb3VzZSBidXR0b24gaXMgaGVsZCBkb3duLCBpc0Rvd24gaXMgc2V0IHRvIHRydWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyRG93bgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAgcG9pbnRlckRvd246IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc0Rvd247CgogICAgfSwKCiAgICAvKioKICAgICogSWYgdGhlIFBvaW50ZXIgaXMgbm90IHRvdWNoaW5nIHRoZSB0b3VjaHNjcmVlbiwgb3IgdGhlIG1vdXNlIGJ1dHRvbiBpcyB1cCwgaXNVcCBpcyBzZXQgdG8gdHJ1ZQogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlclVwCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICBwb2ludGVyVXA6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc1VwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEEgdGltZXN0YW1wIHJlcHJlc2VudGluZyB3aGVuIHRoZSBQb2ludGVyIGZpcnN0IHRvdWNoZWQgdGhlIHRvdWNoc2NyZWVuLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlclRpbWVEb3duCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHBvaW50ZXJUaW1lRG93bjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLnRpbWVEb3duOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEEgdGltZXN0YW1wIHJlcHJlc2VudGluZyB3aGVuIHRoZSBQb2ludGVyIGxlZnQgdGhlIHRvdWNoc2NyZWVuLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlclRpbWVVcAogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBwb2ludGVyVGltZVVwOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZVVwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIElzIHRoZSBQb2ludGVyIG92ZXIgdGhpcyBTcHJpdGU/CiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyT3ZlcgogICAgKiBAcGFyYW0ge251bWJlcn0gW2luZGV4XSAtIFRoZSBJRCBudW1iZXIgb2YgYSBQb2ludGVyIHRvIGNoZWNrLiBJZiB5b3UgZG9uJ3QgcHJvdmlkZSBhIG51bWJlciBpdCB3aWxsIGNoZWNrIGFsbCBQb2ludGVycy4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gcG9pbnRlciAoaWYgYSBpbmRleCB3YXMgZ2l2ZW4sIG9yIGFueSBwb2ludGVyIGlmIG5vdCkgaXMgb3ZlciB0aGlzIG9iamVjdC4KICAgICovCiAgICBwb2ludGVyT3ZlcjogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgICAgIGlmICh0aGlzLmVuYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGluZGV4ID09PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAxMDsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wb2ludGVyRGF0YVtpXS5pc092ZXIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbaW5kZXhdLmlzT3ZlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIElzIHRoZSBQb2ludGVyIG91dHNpZGUgb2YgdGhpcyBTcHJpdGU/CiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyT3V0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaW5kZXhdIC0gVGhlIElEIG51bWJlciBvZiBhIFBvaW50ZXIgdG8gY2hlY2suIElmIHlvdSBkb24ndCBwcm92aWRlIGEgbnVtYmVyIGl0IHdpbGwgY2hlY2sgYWxsIFBvaW50ZXJzLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBnaXZlbiBwb2ludGVyIChpZiBhIGluZGV4IHdhcyBnaXZlbiwgb3IgYW55IHBvaW50ZXIgaWYgbm90KSBpcyBvdXQgb2YgdGhpcyBvYmplY3QuCiAgICAqLwogICAgcG9pbnRlck91dDogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgICAgIGlmICh0aGlzLmVuYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGluZGV4ID09PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAxMDsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wb2ludGVyRGF0YVtpXS5pc091dCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtpbmRleF0uaXNPdXQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIHRpbWVzdGFtcCByZXByZXNlbnRpbmcgd2hlbiB0aGUgUG9pbnRlciBmaXJzdCB0b3VjaGVkIHRoZSB0b3VjaHNjcmVlbi4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJUaW1lT3ZlcgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBwb2ludGVyVGltZU92ZXI6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lT3ZlcjsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIHRpbWVzdGFtcCByZXByZXNlbnRpbmcgd2hlbiB0aGUgUG9pbnRlciBsZWZ0IHRoZSB0b3VjaHNjcmVlbi4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJUaW1lT3V0CiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHBvaW50ZXJUaW1lT3V0OiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZU91dDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJcyB0aGlzIHNwcml0ZSBiZWluZyBkcmFnZ2VkIGJ5IHRoZSBtb3VzZSBvciBub3Q/CiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyVGltZU91dAogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBwb2ludGVyRHJhZ2dlZDogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzRHJhZ2dlZDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIHBvaW50ZXIgaXMgb3ZlciB0aGlzIFNwcml0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2NoZWNrUG9pbnRlck92ZXIKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGNoZWNrUG9pbnRlck92ZXI6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIGlmICh0aGlzLmVuYWJsZWQgPT09IGZhbHNlIHx8IHRoaXMuc3ByaXRlLnZpc2libGUgPT09IGZhbHNlIHx8ICh0aGlzLnNwcml0ZS5ncm91cCAmJiB0aGlzLnNwcml0ZS5ncm91cC52aXNpYmxlID09PSBmYWxzZSkpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNwcml0ZS5nZXRMb2NhbFVubW9kaWZpZWRQb3NpdGlvbih0aGlzLl90ZW1wUG9pbnQsIHBvaW50ZXIueCwgcG9pbnRlci55KTsKCiAgICAgICAgaWYgKHRoaXMuX3RlbXBQb2ludC54ID49IDAgJiYgdGhpcy5fdGVtcFBvaW50LnggPD0gdGhpcy5zcHJpdGUuY3VycmVudEZyYW1lLndpZHRoICYmIHRoaXMuX3RlbXBQb2ludC55ID49IDAgJiYgdGhpcy5fdGVtcFBvaW50LnkgPD0gdGhpcy5zcHJpdGUuY3VycmVudEZyYW1lLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnBpeGVsUGVyZmVjdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tQaXhlbCh0aGlzLl90ZW1wUG9pbnQueCwgdGhpcy5fdGVtcFBvaW50LnkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUnVucyBhIHBpeGVsIHBlcmZlY3QgY2hlY2sgYWdhaW5zdCB0aGUgZ2l2ZW4geC95IGNvb3JkaW5hdGVzIG9mIHRoZSBTcHJpdGUgdGhpcyBJbnB1dEhhbmRsZXIgaXMgYm91bmQgdG8uCiAgICAqIEl0IGNvbXBhcmVzIHRoZSBhbHBoYSB2YWx1ZSBvZiB0aGUgcGl4ZWwgYW5kIGlmID49IElucHV0SGFuZGxlci5waXhlbFBlcmZlY3RBbHBoYSBpdCByZXR1cm5zIHRydWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNjaGVja1BpeGVsCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSB0byBjaGVjay4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIHRvIGNoZWNrLgogICAgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHRoZXJlIGlzIHRoZSBhbHBoYSBvZiB0aGUgcGl4ZWwgaXMgPj0gSW5wdXRIYW5kbGVyLnBpeGVsUGVyZmVjdEFscGhhCiAgICAqLwogICAgY2hlY2tQaXhlbDogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgLy8gIEdyYWIgYSBwaXhlbCBmcm9tIG91ciBpbWFnZSBpbnRvIHRoZSBoaXRDYW52YXMgYW5kIHRoZW4gdGVzdCBpdAogICAgICAgIGlmICh0aGlzLnNwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLnNvdXJjZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5oaXRDb250ZXh0LmNsZWFyUmVjdCgwLCAwLCAxLCAxKTsKCiAgICAgICAgICAgIHggKz0gdGhpcy5zcHJpdGUudGV4dHVyZS5mcmFtZS54OwogICAgICAgICAgICB5ICs9IHRoaXMuc3ByaXRlLnRleHR1cmUuZnJhbWUueTsKCiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5oaXRDb250ZXh0LmRyYXdJbWFnZSh0aGlzLnNwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLnNvdXJjZSwgeCwgeSwgMSwgMSwgMCwgMCwgMSwgMSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgcmdiID0gdGhpcy5nYW1lLmlucHV0LmhpdENvbnRleHQuZ2V0SW1hZ2VEYXRhKDAsIDAsIDEsIDEpOwoKICAgICAgICAgICAgaWYgKHJnYi5kYXRhWzNdID49IHRoaXMucGl4ZWxQZXJmZWN0QWxwaGEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjdXBkYXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIGlmICh0aGlzLmVuYWJsZWQgPT09IGZhbHNlIHx8IHRoaXMuc3ByaXRlLnZpc2libGUgPT09IGZhbHNlIHx8ICh0aGlzLnNwcml0ZS5ncm91cCAmJiB0aGlzLnNwcml0ZS5ncm91cC52aXNpYmxlID09PSBmYWxzZSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wb2ludGVyT3V0SGFuZGxlcihwb2ludGVyKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZHJhZ2dhYmxlICYmIHRoaXMuX2RyYWdnZWRQb2ludGVySUQgPT0gcG9pbnRlci5pZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZURyYWcocG9pbnRlcik7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3ZlciA9PT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmNoZWNrUG9pbnRlck92ZXIocG9pbnRlcikpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnggPSBwb2ludGVyLnggLSB0aGlzLnNwcml0ZS54OwogICAgICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0ueSA9IHBvaW50ZXIueSAtIHRoaXMuc3ByaXRlLnk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJPdXRIYW5kbGVyKHBvaW50ZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kIGhhbmRsaW5nIHRoZSBwb2ludGVyIG92ZXIgZXZlbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNfcG9pbnRlck92ZXJIYW5kbGVyCiAgICAqIEBwcml2YXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICovCiAgICBfcG9pbnRlck92ZXJIYW5kbGVyOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBpZiAodGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNPdmVyID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3ZlciA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3V0ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnRpbWVPdmVyID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS54ID0gcG9pbnRlci54IC0gdGhpcy5zcHJpdGUueDsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0ueSA9IHBvaW50ZXIueSAtIHRoaXMuc3ByaXRlLnk7CgogICAgICAgICAgICBpZiAodGhpcy51c2VIYW5kQ3Vyc29yICYmIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzRHJhZ2dlZCA9PT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW52YXMuc3R5bGUuY3Vyc29yID0gInBvaW50ZXIiOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dE92ZXIuZGlzcGF0Y2godGhpcy5zcHJpdGUsIHBvaW50ZXIpOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZCBoYW5kbGluZyB0aGUgcG9pbnRlciBvdXQgZXZlbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNfcG9pbnRlck91dEhhbmRsZXIKICAgICogQHByaXZhdGUKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKi8KICAgIF9wb2ludGVyT3V0SGFuZGxlcjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNPdmVyID0gZmFsc2U7CiAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNPdXQgPSB0cnVlOwogICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnRpbWVPdXQgPSB0aGlzLmdhbWUudGltZS5ub3c7CgogICAgICAgIGlmICh0aGlzLnVzZUhhbmRDdXJzb3IgJiYgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNEcmFnZ2VkID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW52YXMuc3R5bGUuY3Vyc29yID0gImRlZmF1bHQiOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuc3ByaXRlICYmIHRoaXMuc3ByaXRlLmV2ZW50cykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0T3V0LmRpc3BhdGNoKHRoaXMuc3ByaXRlLCBwb2ludGVyKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kIGhhbmRsaW5nIHRoZSB0b3VjaGVkIGV2ZW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjX3RvdWNoZWRIYW5kbGVyCiAgICAqIEBwcml2YXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICovCiAgICBfdG91Y2hlZEhhbmRsZXI6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIGlmICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc0Rvd24gPT09IGZhbHNlICYmIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3ZlciA9PT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzRG93biA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzVXAgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0udGltZURvd24gPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0RG93bi5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlcik7CgogICAgICAgICAgICAvLyAgU3RhcnQgZHJhZwogICAgICAgICAgICBpZiAodGhpcy5kcmFnZ2FibGUgJiYgdGhpcy5pc0RyYWdnZWQgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0RHJhZyhwb2ludGVyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuYnJpbmdUb1RvcCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuYnJpbmdUb1RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyAgQ29uc3VtZSB0aGUgZXZlbnQ/CiAgICAgICAgcmV0dXJuIHRoaXMuY29uc3VtZVBvaW50ZXJFdmVudDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QgaGFuZGxpbmcgdGhlIHBvaW50ZXIgcmVsZWFzZWQgZXZlbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNfcmVsZWFzZWRIYW5kbGVyCiAgICAqIEBwcml2YXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICovCiAgICBfcmVsZWFzZWRIYW5kbGVyOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICAvLyAgSWYgd2FzIHByZXZpb3VzbHkgdG91Y2hlZCBieSB0aGlzIFBvaW50ZXIsIGNoZWNrIGlmIHN0aWxsIGlzIEFORCBzdGlsbCBvdmVyIHRoaXMgaXRlbQogICAgICAgIGlmICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc0Rvd24gJiYgcG9pbnRlci5pc1VwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNEb3duID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzVXAgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS50aW1lVXAgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmRvd25EdXJhdGlvbiA9IHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnRpbWVVcCAtIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnRpbWVEb3duOwoKICAgICAgICAgICAgLy8gIE9ubHkgcmVsZWFzZSB0aGUgSW5wdXRVcCBzaWduYWwgaWYgdGhlIHBvaW50ZXIgaXMgc3RpbGwgb3ZlciB0aGlzIHNwcml0ZQogICAgICAgICAgICBpZiAodGhpcy5jaGVja1BvaW50ZXJPdmVyKHBvaW50ZXIpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgUmVsZWFzZSB0aGUgaW5wdXRVcCBzaWduYWwgYW5kIHByb3ZpZGUgb3B0aW9uYWwgcGFyYW1ldGVyIGlmIHBvaW50ZXIgaXMgc3RpbGwgb3ZlciB0aGUgc3ByaXRlIG9yIG5vdAogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXRVcC5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlciwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgUmVsZWFzZSB0aGUgaW5wdXRVcCBzaWduYWwgYW5kIHByb3ZpZGUgb3B0aW9uYWwgcGFyYW1ldGVyIGlmIHBvaW50ZXIgaXMgc3RpbGwgb3ZlciB0aGUgc3ByaXRlIG9yIG5vdAogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXRVcC5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlciwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIC8vICBQb2ludGVyIG91dHNpZGUgdGhlIHNwcml0ZT8gUmVzZXQgdGhlIGN1cnNvcgogICAgICAgICAgICAgICAgaWYgKHRoaXMudXNlSGFuZEN1cnNvcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLmN1cnNvciA9ICJkZWZhdWx0IjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIFN0b3AgZHJhZwogICAgICAgICAgICBpZiAodGhpcy5kcmFnZ2FibGUgJiYgdGhpcy5pc0RyYWdnZWQgJiYgdGhpcy5fZHJhZ2dlZFBvaW50ZXJJRCA9PSBwb2ludGVyLmlkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3BEcmFnKHBvaW50ZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZXMgdGhlIFBvaW50ZXIgZHJhZyBvbiB0aGlzIFNwcml0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3VwZGF0ZURyYWcKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIHVwZGF0ZURyYWc6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIGlmIChwb2ludGVyLmlzVXApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnN0b3BEcmFnKHBvaW50ZXIpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5zcHJpdGUuZml4ZWRUb0NhbWVyYSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmFsbG93SG9yaXpvbnRhbERyYWcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC54ID0gcG9pbnRlci54ICsgdGhpcy5fZHJhZ1BvaW50LnggKyB0aGlzLmRyYWdPZmZzZXQueDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuYWxsb3dWZXJ0aWNhbERyYWcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC55ID0gcG9pbnRlci55ICsgdGhpcy5fZHJhZ1BvaW50LnkgKyB0aGlzLmRyYWdPZmZzZXQueTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuYm91bmRzUmVjdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jaGVja0JvdW5kc1JlY3QoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuYm91bmRzU3ByaXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrQm91bmRzU3ByaXRlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnNuYXBPbkRyYWcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC54ID0gTWF0aC5yb3VuZCgodGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnggLSAodGhpcy5zbmFwT2Zmc2V0WCAlIHRoaXMuc25hcFgpKSAvIHRoaXMuc25hcFgpICogdGhpcy5zbmFwWCArICh0aGlzLnNuYXBPZmZzZXRYICUgdGhpcy5zbmFwWCk7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueSA9IE1hdGgucm91bmQoKHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC55IC0gKHRoaXMuc25hcE9mZnNldFkgJSB0aGlzLnNuYXBZKSkgLyB0aGlzLnNuYXBZKSAqIHRoaXMuc25hcFkgKyAodGhpcy5zbmFwT2Zmc2V0WSAlIHRoaXMuc25hcFkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmFsbG93SG9yaXpvbnRhbERyYWcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLnggPSBwb2ludGVyLnggKyB0aGlzLl9kcmFnUG9pbnQueCArIHRoaXMuZHJhZ09mZnNldC54OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5hbGxvd1ZlcnRpY2FsRHJhZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUueSA9IHBvaW50ZXIueSArIHRoaXMuX2RyYWdQb2ludC55ICsgdGhpcy5kcmFnT2Zmc2V0Lnk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmJvdW5kc1JlY3QpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tCb3VuZHNSZWN0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmJvdW5kc1Nwcml0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jaGVja0JvdW5kc1Nwcml0ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zbmFwT25EcmFnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS54ID0gTWF0aC5yb3VuZCgodGhpcy5zcHJpdGUueCAtICh0aGlzLnNuYXBPZmZzZXRYICUgdGhpcy5zbmFwWCkpIC8gdGhpcy5zbmFwWCkgKiB0aGlzLnNuYXBYICsgKHRoaXMuc25hcE9mZnNldFggJSB0aGlzLnNuYXBYKTsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgPSBNYXRoLnJvdW5kKCh0aGlzLnNwcml0ZS55IC0gKHRoaXMuc25hcE9mZnNldFkgJSB0aGlzLnNuYXBZKSkgLyB0aGlzLnNuYXBZKSAqIHRoaXMuc25hcFkgKyAodGhpcy5zbmFwT2Zmc2V0WSAlIHRoaXMuc25hcFkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIHBvaW50ZXIgaGFzIGVudGVyZWQgdGhlIFNwcml0ZSB3aXRoaW4gdGhlIHNwZWNpZmllZCBkZWxheSB0aW1lIChkZWZhdWx0cyB0byA1MDBtcywgaGFsZiBhIHNlY29uZCkKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2p1c3RPdmVyCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIHRpbWUgYmVsb3cgd2hpY2ggdGhlIHBvaW50ZXIgaXMgY29uc2lkZXJlZCBhcyBqdXN0IG92ZXIuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAganVzdE92ZXI6IGZ1bmN0aW9uIChwb2ludGVyLCBkZWxheSkgewoKICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCAwOwogICAgICAgIGRlbGF5ID0gZGVsYXkgfHwgNTAwOwoKICAgICAgICByZXR1cm4gKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzT3ZlciAmJiB0aGlzLm92ZXJEdXJhdGlvbihwb2ludGVyKSA8IGRlbGF5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIHBvaW50ZXIgaGFzIGxlZnQgdGhlIFNwcml0ZSB3aXRoaW4gdGhlIHNwZWNpZmllZCBkZWxheSB0aW1lIChkZWZhdWx0cyB0byA1MDBtcywgaGFsZiBhIHNlY29uZCkKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2p1c3RPdXQKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgLSBUaGUgdGltZSBiZWxvdyB3aGljaCB0aGUgcG9pbnRlciBpcyBjb25zaWRlcmVkIGFzIGp1c3Qgb3V0LgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGp1c3RPdXQ6IGZ1bmN0aW9uIChwb2ludGVyLCBkZWxheSkgewoKICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCAwOwogICAgICAgIGRlbGF5ID0gZGVsYXkgfHwgNTAwOwoKICAgICAgICByZXR1cm4gKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzT3V0ICYmICh0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lT3V0IDwgZGVsYXkpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIHBvaW50ZXIgaGFzIGVudGVyZWQgdGhlIFNwcml0ZSB3aXRoaW4gdGhlIHNwZWNpZmllZCBkZWxheSB0aW1lIChkZWZhdWx0cyB0byA1MDBtcywgaGFsZiBhIHNlY29uZCkKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2p1c3RQcmVzc2VkCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIHRpbWUgYmVsb3cgd2hpY2ggdGhlIHBvaW50ZXIgaXMgY29uc2lkZXJlZCBhcyBqdXN0IG92ZXIuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAganVzdFByZXNzZWQ6IGZ1bmN0aW9uIChwb2ludGVyLCBkZWxheSkgewoKICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCAwOwogICAgICAgIGRlbGF5ID0gZGVsYXkgfHwgNTAwOwoKICAgICAgICByZXR1cm4gKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzRG93biAmJiB0aGlzLmRvd25EdXJhdGlvbihwb2ludGVyKSA8IGRlbGF5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIHBvaW50ZXIgaGFzIGxlZnQgdGhlIFNwcml0ZSB3aXRoaW4gdGhlIHNwZWNpZmllZCBkZWxheSB0aW1lIChkZWZhdWx0cyB0byA1MDBtcywgaGFsZiBhIHNlY29uZCkKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2p1c3RSZWxlYXNlZAogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkZWxheSAtIFRoZSB0aW1lIGJlbG93IHdoaWNoIHRoZSBwb2ludGVyIGlzIGNvbnNpZGVyZWQgYXMganVzdCBvdXQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAganVzdFJlbGVhc2VkOiBmdW5jdGlvbiAocG9pbnRlciwgZGVsYXkpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKICAgICAgICBkZWxheSA9IGRlbGF5IHx8IDUwMDsKCiAgICAgICAgcmV0dXJuICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc1VwICYmICh0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lVXAgPCBkZWxheSkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIElmIHRoZSBwb2ludGVyIGlzIGN1cnJlbnRseSBvdmVyIHRoaXMgU3ByaXRlIHRoaXMgcmV0dXJucyBob3cgbG9uZyBpdCBoYXMgYmVlbiB0aGVyZSBmb3IgaW4gbWlsbGlzZWNvbmRzLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjb3ZlckR1cmF0aW9uCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0aGUgcG9pbnRlciBoYXMgYmVlbiBvdmVyIHRoZSBTcHJpdGUsIG9yIC0xIGlmIG5vdCBvdmVyLgogICAgKi8KICAgIG92ZXJEdXJhdGlvbjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgaWYgKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzT3ZlcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lT3ZlcjsKICAgICAgICB9CgogICAgICAgIHJldHVybiAtMTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJZiB0aGUgcG9pbnRlciBpcyBjdXJyZW50bHkgb3ZlciB0aGlzIFNwcml0ZSB0aGlzIHJldHVybnMgaG93IGxvbmcgaXQgaGFzIGJlZW4gdGhlcmUgZm9yIGluIG1pbGxpc2Vjb25kcy4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2Rvd25EdXJhdGlvbgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdGhlIHBvaW50ZXIgaGFzIGJlZW4gcHJlc3NlZCBkb3duIG9uIHRoZSBTcHJpdGUsIG9yIC0xIGlmIG5vdCBvdmVyLgogICAgKi8KICAgIGRvd25EdXJhdGlvbjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgaWYgKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzRG93bikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lRG93bjsKICAgICAgICB9CgogICAgICAgIHJldHVybiAtMTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNYWtlIHRoaXMgU3ByaXRlIGRyYWdnYWJsZSBieSB0aGUgbW91c2UuIFlvdSBjYW4gYWxzbyBvcHRpb25hbGx5IHNldCBtb3VzZVN0YXJ0RHJhZ0NhbGxiYWNrIGFuZCBtb3VzZVN0b3BEcmFnQ2FsbGJhY2sKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2VuYWJsZURyYWcKICAgICogQHBhcmFtIHtib29sZWFufSBbbG9ja0NlbnRlcj1mYWxzZV0gLSBJZiBmYWxzZSB0aGUgU3ByaXRlIHdpbGwgZHJhZyBmcm9tIHdoZXJlIHlvdSBjbGljayBpdCBtaW51cyB0aGUgZHJhZ09mZnNldC4gSWYgdHJ1ZSBpdCB3aWxsIGNlbnRlciBpdHNlbGYgdG8gdGhlIHRpcCBvZiB0aGUgbW91c2UgcG9pbnRlci4KICAgICogQHBhcmFtIHtib29sZWFufSBbYnJpbmdUb1RvcD1mYWxzZV0gLSBJZiB0cnVlIHRoZSBTcHJpdGUgd2lsbCBiZSBib3VnaHQgdG8gdGhlIHRvcCBvZiB0aGUgcmVuZGVyaW5nIGxpc3QgaW4gaXRzIGN1cnJlbnQgR3JvdXAuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3BpeGVsUGVyZmVjdD1mYWxzZV0gLSBJZiB0cnVlIGl0IHdpbGwgdXNlIGEgcGl4ZWwgcGVyZmVjdCB0ZXN0IHRvIHNlZSBpZiB5b3UgY2xpY2tlZCB0aGUgU3ByaXRlLiBGYWxzZSB1c2VzIHRoZSBib3VuZGluZyBib3guCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2FscGhhVGhyZXNob2xkPTI1NV0gLSBJZiB1c2luZyBwaXhlbCBwZXJmZWN0IGNvbGxpc2lvbiB0aGlzIHNwZWNpZmllcyB0aGUgYWxwaGEgbGV2ZWwgZnJvbSAwIHRvIDI1NSBhYm92ZSB3aGljaCBhIGNvbGxpc2lvbiBpcyBwcm9jZXNzZWQuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gW2JvdW5kc1JlY3Q9bnVsbF0gLSBJZiB5b3Ugd2FudCB0byByZXN0cmljdCB0aGUgZHJhZyBvZiB0aGlzIHNwcml0ZSB0byBhIHNwZWNpZmljIFJlY3RhbmdsZSwgcGFzcyB0aGUgUGhhc2VyLlJlY3RhbmdsZSBoZXJlLCBvdGhlcndpc2UgaXQncyBmcmVlIHRvIGRyYWcgYW55d2hlcmUuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gW2JvdW5kc1Nwcml0ZT1udWxsXSAtIElmIHlvdSB3YW50IHRvIHJlc3RyaWN0IHRoZSBkcmFnIG9mIHRoaXMgc3ByaXRlIHRvIHdpdGhpbiB0aGUgYm91bmRpbmcgYm94IG9mIGFub3RoZXIgc3ByaXRlLCBwYXNzIGl0IGhlcmUuCiAgICAqLwogICAgZW5hYmxlRHJhZzogZnVuY3Rpb24gKGxvY2tDZW50ZXIsIGJyaW5nVG9Ub3AsIHBpeGVsUGVyZmVjdCwgYWxwaGFUaHJlc2hvbGQsIGJvdW5kc1JlY3QsIGJvdW5kc1Nwcml0ZSkgewoKICAgICAgICBpZiAodHlwZW9mIGxvY2tDZW50ZXIgPT0gJ3VuZGVmaW5lZCcpIHsgbG9ja0NlbnRlciA9IGZhbHNlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBicmluZ1RvVG9wID09ICd1bmRlZmluZWQnKSB7IGJyaW5nVG9Ub3AgPSBmYWxzZTsgfQogICAgICAgIGlmICh0eXBlb2YgcGl4ZWxQZXJmZWN0ID09ICd1bmRlZmluZWQnKSB7IHBpeGVsUGVyZmVjdCA9IGZhbHNlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBhbHBoYVRocmVzaG9sZCA9PSAndW5kZWZpbmVkJykgeyBhbHBoYVRocmVzaG9sZCA9IDI1NTsgfQogICAgICAgIGlmICh0eXBlb2YgYm91bmRzUmVjdCA9PSAndW5kZWZpbmVkJykgeyBib3VuZHNSZWN0ID0gbnVsbDsgfQogICAgICAgIGlmICh0eXBlb2YgYm91bmRzU3ByaXRlID09ICd1bmRlZmluZWQnKSB7IGJvdW5kc1Nwcml0ZSA9IG51bGw7IH0KCiAgICAgICAgdGhpcy5fZHJhZ1BvaW50ID0gbmV3IFBoYXNlci5Qb2ludCgpOwogICAgICAgIHRoaXMuZHJhZ2dhYmxlID0gdHJ1ZTsKICAgICAgICB0aGlzLmJyaW5nVG9Ub3AgPSBicmluZ1RvVG9wOwogICAgICAgIHRoaXMuZHJhZ09mZnNldCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKICAgICAgICB0aGlzLmRyYWdGcm9tQ2VudGVyID0gbG9ja0NlbnRlcjsKCiAgICAgICAgdGhpcy5waXhlbFBlcmZlY3QgPSBwaXhlbFBlcmZlY3Q7CiAgICAgICAgdGhpcy5waXhlbFBlcmZlY3RBbHBoYSA9IGFscGhhVGhyZXNob2xkOwoKICAgICAgICBpZiAoYm91bmRzUmVjdCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYm91bmRzUmVjdCA9IGJvdW5kc1JlY3Q7CiAgICAgICAgfQoKICAgICAgICBpZiAoYm91bmRzU3ByaXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5ib3VuZHNTcHJpdGUgPSBib3VuZHNTcHJpdGU7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3BzIHRoaXMgc3ByaXRlIGZyb20gYmVpbmcgYWJsZSB0byBiZSBkcmFnZ2VkLiBJZiBpdCBpcyBjdXJyZW50bHkgdGhlIHRhcmdldCBvZiBhbiBhY3RpdmUgZHJhZyBpdCB3aWxsIGJlIHN0b3BwZWQgaW1tZWRpYXRlbHkuIEFsc28gZGlzYWJsZXMgYW55IHNldCBjYWxsYmFja3MuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNkaXNhYmxlRHJhZwogICAgKi8KICAgIGRpc2FibGVEcmFnOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9wb2ludGVyRGF0YSkKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTA7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbaV0uaXNEcmFnZ2VkID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuZHJhZ2dhYmxlID0gZmFsc2U7CiAgICAgICAgdGhpcy5pc0RyYWdnZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLl9kcmFnZ2VkUG9pbnRlcklEID0gLTE7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIGJ5IFBvaW50ZXIgd2hlbiBkcmFnIHN0YXJ0cyBvbiB0aGlzIFNwcml0ZS4gU2hvdWxkIG5vdCB1c3VhbGx5IGJlIGNhbGxlZCBkaXJlY3RseS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3N0YXJ0RHJhZwogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqLwogICAgc3RhcnREcmFnOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICB0aGlzLmlzRHJhZ2dlZCA9IHRydWU7CiAgICAgICAgdGhpcy5fZHJhZ2dlZFBvaW50ZXJJRCA9IHBvaW50ZXIuaWQ7CiAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNEcmFnZ2VkID0gdHJ1ZTsKCiAgICAgICAgaWYgKHRoaXMuc3ByaXRlLmZpeGVkVG9DYW1lcmEpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5kcmFnRnJvbUNlbnRlcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuY2VudGVyT24ocG9pbnRlci54LCBwb2ludGVyLnkpOwogICAgICAgICAgICAgICAgdGhpcy5fZHJhZ1BvaW50LnNldFRvKHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC54IC0gcG9pbnRlci54LCB0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueSAtIHBvaW50ZXIueSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9kcmFnUG9pbnQuc2V0VG8odGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnggLSBwb2ludGVyLngsIHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC55IC0gcG9pbnRlci55KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5kcmFnRnJvbUNlbnRlcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuY2VudGVyT24ocG9pbnRlci54LCBwb2ludGVyLnkpOwogICAgICAgICAgICAgICAgdGhpcy5fZHJhZ1BvaW50LnNldFRvKHRoaXMuc3ByaXRlLnggLSBwb2ludGVyLngsIHRoaXMuc3ByaXRlLnkgLSBwb2ludGVyLnkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fZHJhZ1BvaW50LnNldFRvKHRoaXMuc3ByaXRlLnggLSBwb2ludGVyLngsIHRoaXMuc3ByaXRlLnkgLSBwb2ludGVyLnkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnVwZGF0ZURyYWcocG9pbnRlcik7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuYnJpbmdUb1RvcCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmJyaW5nVG9Ub3AoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbkRyYWdTdGFydC5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlcik7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIGJ5IFBvaW50ZXIgd2hlbiBkcmFnIGlzIHN0b3BwZWQgb24gdGhpcyBTcHJpdGUuIFNob3VsZCBub3QgdXN1YWxseSBiZSBjYWxsZWQgZGlyZWN0bHkuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNzdG9wRHJhZwogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyCiAgICAqLwogICAgc3RvcERyYWc6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIHRoaXMuaXNEcmFnZ2VkID0gZmFsc2U7CiAgICAgICAgdGhpcy5fZHJhZ2dlZFBvaW50ZXJJRCA9IC0xOwogICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzRHJhZ2dlZCA9IGZhbHNlOwogICAgICAgIAogICAgICAgIGlmICh0aGlzLnNuYXBPblJlbGVhc2UpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5zcHJpdGUuZml4ZWRUb0NhbWVyYSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnggPSBNYXRoLnJvdW5kKCh0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueCAtICh0aGlzLnNuYXBPZmZzZXRYICUgdGhpcy5zbmFwWCkpIC8gdGhpcy5zbmFwWCkgKiB0aGlzLnNuYXBYICsgKHRoaXMuc25hcE9mZnNldFggJSB0aGlzLnNuYXBYKTsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC55ID0gTWF0aC5yb3VuZCgodGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnkgLSAodGhpcy5zbmFwT2Zmc2V0WSAlIHRoaXMuc25hcFkpKSAvIHRoaXMuc25hcFkpICogdGhpcy5zbmFwWSArICh0aGlzLnNuYXBPZmZzZXRZICUgdGhpcy5zbmFwWSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS54ID0gTWF0aC5yb3VuZCgodGhpcy5zcHJpdGUueCAtICh0aGlzLnNuYXBPZmZzZXRYICUgdGhpcy5zbmFwWCkpIC8gdGhpcy5zbmFwWCkgKiB0aGlzLnNuYXBYICsgKHRoaXMuc25hcE9mZnNldFggJSB0aGlzLnNuYXBYKTsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgPSBNYXRoLnJvdW5kKCh0aGlzLnNwcml0ZS55IC0gKHRoaXMuc25hcE9mZnNldFkgJSB0aGlzLnNuYXBZKSkgLyB0aGlzLnNuYXBZKSAqIHRoaXMuc25hcFkgKyAodGhpcy5zbmFwT2Zmc2V0WSAlIHRoaXMuc25hcFkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25EcmFnU3RvcC5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlcik7CiAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXRVcC5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlcik7CgogICAgICAgIGlmICh0aGlzLmNoZWNrUG9pbnRlck92ZXIocG9pbnRlcikgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlck91dEhhbmRsZXIocG9pbnRlcik7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlc3RyaWN0cyB0aGlzIHNwcml0ZSB0byBkcmFnIG1vdmVtZW50IG9ubHkgb24gdGhlIGdpdmVuIGF4aXMuIE5vdGU6IElmIGJvdGggYXJlIHNldCB0byBmYWxzZSB0aGUgc3ByaXRlIHdpbGwgbmV2ZXIgbW92ZSEKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3NldERyYWdMb2NrCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2FsbG93SG9yaXpvbnRhbD10cnVlXSAtIFRvIGVuYWJsZSB0aGUgc3ByaXRlIHRvIGJlIGRyYWdnZWQgaG9yaXpvbnRhbGx5IHNldCB0byB0cnVlLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2FsbG93VmVydGljYWw9dHJ1ZV0gLSBUbyBlbmFibGUgdGhlIHNwcml0ZSB0byBiZSBkcmFnZ2VkIHZlcnRpY2FsbHkgc2V0IHRvIHRydWUsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBzZXREcmFnTG9jazogZnVuY3Rpb24gKGFsbG93SG9yaXpvbnRhbCwgYWxsb3dWZXJ0aWNhbCkgewoKICAgICAgICBpZiAodHlwZW9mIGFsbG93SG9yaXpvbnRhbCA9PSAndW5kZWZpbmVkJykgeyBhbGxvd0hvcml6b250YWwgPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBhbGxvd1ZlcnRpY2FsID09ICd1bmRlZmluZWQnKSB7IGFsbG93VmVydGljYWwgPSB0cnVlOyB9CgogICAgICAgIHRoaXMuYWxsb3dIb3Jpem9udGFsRHJhZyA9IGFsbG93SG9yaXpvbnRhbDsKICAgICAgICB0aGlzLmFsbG93VmVydGljYWxEcmFnID0gYWxsb3dWZXJ0aWNhbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNYWtlIHRoaXMgU3ByaXRlIHNuYXAgdG8gdGhlIGdpdmVuIGdyaWQgZWl0aGVyIGR1cmluZyBkcmFnIG9yIHdoZW4gaXQncyByZWxlYXNlZC4KICAgICogRm9yIGV4YW1wbGUgMTZ4MTYgYXMgdGhlIHNuYXBYIGFuZCBzbmFwWSB3b3VsZCBtYWtlIHRoZSBzcHJpdGUgc25hcCB0byBldmVyeSAxNiBwaXhlbHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNlbmFibGVTbmFwCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzbmFwWCAtIFRoZSB3aWR0aCBvZiB0aGUgZ3JpZCBjZWxsIHRvIHNuYXAgdG8uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzbmFwWSAtIFRoZSBoZWlnaHQgb2YgdGhlIGdyaWQgY2VsbCB0byBzbmFwIHRvLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvbkRyYWc9dHJ1ZV0gLSBJZiB0cnVlIHRoZSBzcHJpdGUgd2lsbCBzbmFwIHRvIHRoZSBncmlkIHdoaWxlIGJlaW5nIGRyYWdnZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29uUmVsZWFzZT1mYWxzZV0gLSBJZiB0cnVlIHRoZSBzcHJpdGUgd2lsbCBzbmFwIHRvIHRoZSBncmlkIHdoZW4gcmVsZWFzZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc25hcE9mZnNldFg9MF0gLSBVc2VkIHRvIG9mZnNldCB0aGUgdG9wLWxlZnQgc3RhcnRpbmcgcG9pbnQgb2YgdGhlIHNuYXAgZ3JpZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzbmFwT2Zmc2V0WD0wXSAtIFVzZWQgdG8gb2Zmc2V0IHRoZSB0b3AtbGVmdCBzdGFydGluZyBwb2ludCBvZiB0aGUgc25hcCBncmlkLgogICAgKi8KICAgIGVuYWJsZVNuYXA6IGZ1bmN0aW9uIChzbmFwWCwgc25hcFksIG9uRHJhZywgb25SZWxlYXNlLCBzbmFwcE9mZnNldFgsIHNuYXBwT2Zmc2V0WSkgewoKICAgICAgICBpZiAodHlwZW9mIG9uRHJhZyA9PSAndW5kZWZpbmVkJykgeyBvbkRyYWcgPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBvblJlbGVhc2UgPT0gJ3VuZGVmaW5lZCcpIHsgb25SZWxlYXNlID0gZmFsc2U7IH0KICAgICAgICBpZiAodHlwZW9mIHNuYXBPZmZzZXRYID09ICd1bmRlZmluZWQnKSB7IHNuYXBPZmZzZXRYID0gMDsgfQogICAgICAgIGlmICh0eXBlb2Ygc25hcE9mZnNldFkgPT0gJ3VuZGVmaW5lZCcpIHsgc25hcE9mZnNldFkgPSAwOyB9CgogICAgICAgIHRoaXMuc25hcFggPSBzbmFwWDsKICAgICAgICB0aGlzLnNuYXBZID0gc25hcFk7CiAgICAgICAgdGhpcy5zbmFwT2Zmc2V0WCA9IHNuYXBPZmZzZXRYOwogICAgICAgIHRoaXMuc25hcE9mZnNldFkgPSBzbmFwT2Zmc2V0WTsKICAgICAgICB0aGlzLnNuYXBPbkRyYWcgPSBvbkRyYWc7CiAgICAgICAgdGhpcy5zbmFwT25SZWxlYXNlID0gb25SZWxlYXNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3BzIHRoZSBzcHJpdGUgZnJvbSBzbmFwcGluZyB0byBhIGdyaWQgZHVyaW5nIGRyYWcgb3IgcmVsZWFzZS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2Rpc2FibGVTbmFwCiAgICAqLwogICAgZGlzYWJsZVNuYXA6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5zbmFwT25EcmFnID0gZmFsc2U7CiAgICAgICAgdGhpcy5zbmFwT25SZWxlYXNlID0gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogQm91bmRzIFJlY3QgY2hlY2sgZm9yIHRoZSBzcHJpdGUgZHJhZwogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjY2hlY2tCb3VuZHNSZWN0CiAgICAqLwogICAgY2hlY2tCb3VuZHNSZWN0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnNwcml0ZS5maXhlZFRvQ2FtZXJhKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC54IDwgdGhpcy5ib3VuZHNSZWN0LmxlZnQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC54ID0gdGhpcy5ib3VuZHNSZWN0LmNhbWVyYU9mZnNldC54OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKCh0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueCArIHRoaXMuc3ByaXRlLndpZHRoKSA+IHRoaXMuYm91bmRzUmVjdC5yaWdodCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnggPSB0aGlzLmJvdW5kc1JlY3QucmlnaHQgLSB0aGlzLnNwcml0ZS53aWR0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC55IDwgdGhpcy5ib3VuZHNSZWN0LnRvcCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnkgPSB0aGlzLmJvdW5kc1JlY3QudG9wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKCh0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueSArIHRoaXMuc3ByaXRlLmhlaWdodCkgPiB0aGlzLmJvdW5kc1JlY3QuYm90dG9tKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueSA9IHRoaXMuYm91bmRzUmVjdC5ib3R0b20gLSB0aGlzLnNwcml0ZS5oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3ByaXRlLnggPCB0aGlzLmJvdW5kc1JlY3QubGVmdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUueCA9IHRoaXMuYm91bmRzUmVjdC54OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKCh0aGlzLnNwcml0ZS54ICsgdGhpcy5zcHJpdGUud2lkdGgpID4gdGhpcy5ib3VuZHNSZWN0LnJpZ2h0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS54ID0gdGhpcy5ib3VuZHNSZWN0LnJpZ2h0IC0gdGhpcy5zcHJpdGUud2lkdGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnNwcml0ZS55IDwgdGhpcy5ib3VuZHNSZWN0LnRvcCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUueSA9IHRoaXMuYm91bmRzUmVjdC50b3A7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoKHRoaXMuc3ByaXRlLnkgKyB0aGlzLnNwcml0ZS5oZWlnaHQpID4gdGhpcy5ib3VuZHNSZWN0LmJvdHRvbSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUueSA9IHRoaXMuYm91bmRzUmVjdC5ib3R0b20gLSB0aGlzLnNwcml0ZS5oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUGFyZW50IFNwcml0ZSBCb3VuZHMgY2hlY2sgZm9yIHRoZSBzcHJpdGUgZHJhZy4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2NoZWNrQm91bmRzU3ByaXRlCiAgICAqLwogICAgY2hlY2tCb3VuZHNTcHJpdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuc3ByaXRlLmZpeGVkVG9DYW1lcmEgJiYgdGhpcy5ib3VuZHNTcHJpdGUuZml4ZWRUb0NhbWVyYSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueCA8IHRoaXMuYm91bmRzU3ByaXRlLmNhbWVyT2Zmc2V0LngpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC54ID0gdGhpcy5ib3VuZHNTcHJpdGUuY2FtZXJPZmZzZXQueDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICgodGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnggKyB0aGlzLnNwcml0ZS53aWR0aCkgPiAodGhpcy5ib3VuZHNTcHJpdGUuY2FtZXJPZmZzZXQueCArIHRoaXMuYm91bmRzU3ByaXRlLndpZHRoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnggPSAodGhpcy5ib3VuZHNTcHJpdGUuY2FtZXJPZmZzZXQueCArIHRoaXMuYm91bmRzU3ByaXRlLndpZHRoKSAtIHRoaXMuc3ByaXRlLndpZHRoOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnkgPCB0aGlzLmJvdW5kc1Nwcml0ZS5jYW1lck9mZnNldC55KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5jYW1lcmFPZmZzZXQueSA9IHRoaXMuYm91bmRzU3ByaXRlLmNhbWVyT2Zmc2V0Lnk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoKHRoaXMuc3ByaXRlLmNhbWVyYU9mZnNldC55ICsgdGhpcy5zcHJpdGUuaGVpZ2h0KSA+ICh0aGlzLmJvdW5kc1Nwcml0ZS5jYW1lck9mZnNldC55ICsgdGhpcy5ib3VuZHNTcHJpdGUuaGVpZ2h0KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuY2FtZXJhT2Zmc2V0LnkgPSAodGhpcy5ib3VuZHNTcHJpdGUuY2FtZXJPZmZzZXQueSArIHRoaXMuYm91bmRzU3ByaXRlLmhlaWdodCkgLSB0aGlzLnNwcml0ZS5oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3ByaXRlLnggPCB0aGlzLmJvdW5kc1Nwcml0ZS54KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS54ID0gdGhpcy5ib3VuZHNTcHJpdGUueDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICgodGhpcy5zcHJpdGUueCArIHRoaXMuc3ByaXRlLndpZHRoKSA+ICh0aGlzLmJvdW5kc1Nwcml0ZS54ICsgdGhpcy5ib3VuZHNTcHJpdGUud2lkdGgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS54ID0gKHRoaXMuYm91bmRzU3ByaXRlLnggKyB0aGlzLmJvdW5kc1Nwcml0ZS53aWR0aCkgLSB0aGlzLnNwcml0ZS53aWR0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3ByaXRlLnkgPCB0aGlzLmJvdW5kc1Nwcml0ZS55KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS55ID0gdGhpcy5ib3VuZHNTcHJpdGUueTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICgodGhpcy5zcHJpdGUueSArIHRoaXMuc3ByaXRlLmhlaWdodCkgPiAodGhpcy5ib3VuZHNTcHJpdGUueSArIHRoaXMuYm91bmRzU3ByaXRlLmhlaWdodCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgPSAodGhpcy5ib3VuZHNTcHJpdGUueSArIHRoaXMuYm91bmRzU3ByaXRlLmhlaWdodCkgLSB0aGlzLnNwcml0ZS5oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfQoKfTsKClBoYXNlci5JbnB1dEhhbmRsZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLklucHV0SGFuZGxlcjsKCi8qKgoqIEBhdXRob3IgICAgICAgQGthcmxtYWNrbGluIDx0YWNrbGVtY2NsZWFuQGdtYWlsLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIEdhbWVwYWQgY2xhc3MgaGFuZGxlcyBsb29raW5nIGFmdGVyIGdhbWVwYWQgaW5wdXQgZm9yIHlvdXIgZ2FtZS4KKiBSZW1lbWJlciB0byBjYWxsIGdhbWVwYWQuc3RhcnQoKTsgZXhwZWN0aW5nIGlucHV0IQoqCiogSFRNTDUgR0FNRVBBRCBBUEkgU1VQUE9SVCBJUyBBVCBBTiBFWFBFUklNRU5UQUwgU1RBR0UhCiogQXQgbW9tZW50IG9mIHdyaXRpbmcgdGhpcyAoZW5kIG9mIDIwMTMpIG9ubHkgQ2hyb21lIHN1cHBvcnRzIHBhcnRzIG9mIGl0IG91dCBvZiB0aGUgYm94LiBGaXJlZm94IHN1cHBvcnRzIGl0CiogdmlhIHByZWZzIGZsYWdzIChhYm91dDpjb25maWcsIHNlYXJjaCBnYW1lcGFkKS4gVGhlIGJyb3dzZXJzIG1hcCB0aGUgc2FtZSBjb250cm9sbGVycyBkaWZmZXJlbnRseS4KKiBUaGlzIGNsYXNzIGhhcyBjb25zdGFucyBmb3IgV2luZG93cyA3IENocm9tZSBtYXBwaW5nIG9mCiogWEJPWCAzNjAgY29udHJvbGxlci4KKgoqIEBjbGFzcyBQaGFzZXIuR2FtZXBhZAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLkdhbWVwYWQgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBcnJheTxQaGFzZXIuU2luZ2xlUGFkPn0gX2dhbWVwYWRzIC0gVGhlIGZvdXIgUGhhc2VyIEdhbWVwYWRzLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2dhbWVwYWRzID0gWwogICAgICAgIG5ldyBQaGFzZXIuU2luZ2xlUGFkKGdhbWUsIHRoaXMpLAogICAgICAgIG5ldyBQaGFzZXIuU2luZ2xlUGFkKGdhbWUsIHRoaXMpLAogICAgICAgIG5ldyBQaGFzZXIuU2luZ2xlUGFkKGdhbWUsIHRoaXMpLAogICAgICAgIG5ldyBQaGFzZXIuU2luZ2xlUGFkKGdhbWUsIHRoaXMpCiAgICBdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge09iamVjdH0gX2dhbWVwYWRJbmRleE1hcCAtIE1hcHMgdGhlIGJyb3dzZXJzIGdhbWVwYWQgaW5kaWNlcyB0byBvdXIgUGhhc2VyIEdhbWVwYWRzCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZ2FtZXBhZEluZGV4TWFwID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7QXJyYXl9IF9yYXdQYWRzIC0gVGhlIHJhdyBzdGF0ZSBvZiB0aGUgZ2FtZXBhZHMgZnJvbSB0aGUgYnJvd3NlcgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3Jhd1BhZHMgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfYWN0aXZlIC0gUHJpdmF0ZSBmbGFnIGZvciB3aGV0aGVyIG9yIG5vdCB0aGUgQVBJIGlzIHBvbGxlZAogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX2FjdGl2ZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBZb3UgY2FuIGRpc2FibGUgYWxsIEdhbWVwYWQgSW5wdXQgYnkgc2V0dGluZyBkaXNhYmxlZCB0byB0cnVlLiBXaGlsZSB0cnVlIGFsbCBuZXcgaW5wdXQgcmVsYXRlZCBldmVudHMgd2lsbCBiZSBpZ25vcmVkLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRpc2FibGVkIC0gVGhlIGRpc2FibGVkIHN0YXRlIG9mIHRoZSBHYW1lcGFkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogV2hldGhlciBvciBub3QgZ2FtZXBhZHMgYXJlIHN1cHBvcnRlZCBpbiB0aGUgY3VycmVudCBicm93c2VyLiBOb3RlIHRoYXQgYXMgb2YgRGVjLiAyMDEzIHRoaXMgY2hlY2sgaXMgYWN0dWFsbHkgbm90IGFjY3VyYXRlIGF0IGFsbCBkdWUgdG8gcG9vciBpbXBsZW1lbnRhdGlvbi4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBfZ2FtZXBhZFN1cHBvcnRBdmFpbGFibGUgLSBBcmUgZ2FtZXBhZHMgc3VwcG9ydGVkIGluIHRoaXMgYnJvd3NlciBvciBub3Q/CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZ2FtZXBhZFN1cHBvcnRBdmFpbGFibGUgPSAhIW5hdmlnYXRvci53ZWJraXRHZXRHYW1lcGFkcyB8fCAhIW5hdmlnYXRvci53ZWJraXRHYW1lcGFkcyB8fCAobmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdGaXJlZm94LycpICE9IC0xKTsKCiAgICAvKioKICAgICogVXNlZCB0byBjaGVjayBmb3IgZGlmZmVyZW5jZXMgYmV0d2VlbiBlYXJsaWVyIHBvbGxzIGFuZCBjdXJyZW50IHN0YXRlIG9mIGdhbWVwYWRzLgogICAgKiBAcHJvcGVydHkge0FycmF5fSBfcHJldlJhd0dhbWVwYWRUeXBlcwogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3ByZXZSYXdHYW1lcGFkVHlwZXMgPSBbXTsKCiAgICAvKioKICAgICogVXNlZCB0byBjaGVjayBmb3IgZGlmZmVyZW5jZXMgYmV0d2VlbiBlYXJsaWVyIHBvbGxzIGFuZCBjdXJyZW50IHN0YXRlIG9mIGdhbWVwYWRzLgogICAgKiBAcHJvcGVydHkge0FycmF5fSBfcHJldlRpbWVzdGFtcHMKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9wcmV2VGltZXN0YW1wcyA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge09iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgdW5kZXIgd2hpY2ggdGhlIGNhbGxiYWNrcyBhcmUgcnVuLgogICAgKi8KICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gdGhpczsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25Db25uZWN0Q2FsbGJhY2sgLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhbnkgZ2FtZXBhZCBpcyBjb25uZWN0ZWQKICAgICovCiAgICB0aGlzLm9uQ29ubmVjdENhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25EaXNjb25uZWN0Q2FsbGJhY2sgLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhbnkgZ2FtZXBhZCBpcyBkaXNjb25uZWN0ZWQKICAgICovCiAgICB0aGlzLm9uRGlzY29ubmVjdENhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25Eb3duQ2FsbGJhY2sgLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhbnkgZ2FtZXBhZCBidXR0b24gaXMgcHJlc3NlZCBkb3duLgogICAgKi8KICAgIHRoaXMub25Eb3duQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvblVwQ2FsbGJhY2sgLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhbnkgZ2FtZXBhZCBidXR0b24gaXMgcmVsZWFzZWQuCiAgICAqLwogICAgdGhpcy5vblVwQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvbkF4aXNDYWxsYmFjayAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIGFueSBnYW1lcGFkIGF4aXMgaXMgY2hhbmdlZC4KICAgICovCiAgICB0aGlzLm9uQXhpc0NhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25GbG9hdENhbGxiYWNrIC0gVGhpcyBjYWxsYmFjayBpcyBpbnZva2VkIGV2ZXJ5IHRpbWUgYW55IGdhbWVwYWQgYnV0dG9uIGlzIGNoYW5nZWQgdG8gYSB2YWx1ZSB3aGVyZSB2YWx1ZSA+IDAgYW5kIHZhbHVlIDwgMS4KICAgICovCiAgICB0aGlzLm9uRmxvYXRDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vbmdhbWVwYWRjb25uZWN0ZWQgLSBQcml2YXRlIGNhbGxiYWNrIGZvciBGaXJlZm94IGdhbWVwYWQgY29ubmVjdGlvbiBoYW5kbGluZwogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uZ2FtZXBhZGNvbm5lY3RlZCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9nYW1lcGFkZGlzY29ubmVjdGVkIC0gUHJpdmF0ZSBjYWxsYmFjayBmb3IgRmlyZWZveCBnYW1lcGFkIGNvbm5lY3Rpb24gaGFuZGxpbmcKICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9nYW1lcGFkZGlzY29ubmVjdGVkID0gbnVsbDsKfTsKClBoYXNlci5HYW1lcGFkLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkIGNhbGxiYWNrcyB0byB0aGUgbWFpbiBHYW1lcGFkIGhhbmRsZXIgdG8gaGFuZGxlIGNvbm5lY3QvZGlzY29ubmVjdC9idXR0b24gZG93bi9idXR0b24gdXAvYXhpcyBjaGFuZ2UvZmxvYXQgdmFsdWUgYnV0dG9ucwogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lcGFkI2FkZENhbGxiYWNrcwogICAgKiBAcGFyYW0ge09iamVjdH0gY29udGV4dCAtIFRoZSBjb250ZXh0IHVuZGVyIHdoaWNoIHRoZSBjYWxsYmFja3MgYXJlIHJ1bi4KICAgICogQHBhcmFtIHtPYmplY3R9IGNhbGxiYWNrcyAtIE9iamVjdCB0aGF0IHRha2VzIHNpeCBkaWZmZXJlbnQgY2FsbGJhY2sgbWV0aG9kczoKICAgICogb25Db25uZWN0Q2FsbGJhY2ssIG9uRGlzY29ubmVjdENhbGxiYWNrLCBvbkRvd25DYWxsYmFjaywgb25VcENhbGxiYWNrLCBvbkF4aXNDYWxsYmFjaywgb25GbG9hdENhbGxiYWNrCiAgICAqLwogICAgYWRkQ2FsbGJhY2tzOiBmdW5jdGlvbiAoY29udGV4dCwgY2FsbGJhY2tzKSB7CgogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2tzICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25Db25uZWN0Q2FsbGJhY2sgPSAodHlwZW9mIGNhbGxiYWNrcy5vbkNvbm5lY3QgPT09ICdmdW5jdGlvbicpID8gY2FsbGJhY2tzLm9uQ29ubmVjdCA6IHRoaXMub25Db25uZWN0Q2FsbGJhY2s7CiAgICAgICAgICAgIHRoaXMub25EaXNjb25uZWN0Q2FsbGJhY2sgPSAodHlwZW9mIGNhbGxiYWNrcy5vbkRpc2Nvbm5lY3QgPT09ICdmdW5jdGlvbicpID8gY2FsbGJhY2tzLm9uRGlzY29ubmVjdCA6IHRoaXMub25EaXNjb25uZWN0Q2FsbGJhY2s7CiAgICAgICAgICAgIHRoaXMub25Eb3duQ2FsbGJhY2sgPSAodHlwZW9mIGNhbGxiYWNrcy5vbkRvd24gPT09ICdmdW5jdGlvbicpID8gY2FsbGJhY2tzLm9uRG93biA6IHRoaXMub25Eb3duQ2FsbGJhY2s7CiAgICAgICAgICAgIHRoaXMub25VcENhbGxiYWNrID0gKHR5cGVvZiBjYWxsYmFja3Mub25VcCA9PT0gJ2Z1bmN0aW9uJykgPyBjYWxsYmFja3Mub25VcCA6IHRoaXMub25VcENhbGxiYWNrOwogICAgICAgICAgICB0aGlzLm9uQXhpc0NhbGxiYWNrID0gKHR5cGVvZiBjYWxsYmFja3Mub25BeGlzID09PSAnZnVuY3Rpb24nKSA/IGNhbGxiYWNrcy5vbkF4aXMgOiB0aGlzLm9uQXhpc0NhbGxiYWNrOwogICAgICAgICAgICB0aGlzLm9uRmxvYXRDYWxsYmFjayA9ICh0eXBlb2YgY2FsbGJhY2tzLm9uRmxvYXQgPT09ICdmdW5jdGlvbicpID8gY2FsbGJhY2tzLm9uRmxvYXQgOiB0aGlzLm9uRmxvYXRDYWxsYmFjazsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU3RhcnRzIHRoZSBHYW1lcGFkIGV2ZW50IGhhbmRsaW5nLgogICAgKiBUaGlzIE1VU1QgYmUgY2FsbGVkIG1hbnVhbGx5IGJlZm9yZSBQaGFzZXIgd2lsbCBzdGFydCBwb2xsaW5nIHRoZSBHYW1lcGFkIEFQSS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZCNzdGFydAogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuX2FjdGl2ZSA9IHRydWU7CiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgdGhpcy5fb25nYW1lcGFkY29ubmVjdGVkID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgdmFyIG5ld1BhZCA9IGV2ZW50LmdhbWVwYWQ7CiAgICAgICAgICAgIF90aGlzLl9yYXdQYWRzLnB1c2gobmV3UGFkKTsKICAgICAgICAgICAgX3RoaXMuX2dhbWVwYWRzW25ld1BhZC5pbmRleF0uY29ubmVjdChuZXdQYWQpOwogICAgICAgIH07CgogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdnYW1lcGFkY29ubmVjdGVkJywgdGhpcy5fb25nYW1lcGFkY29ubmVjdGVkLCBmYWxzZSk7CgogICAgICAgIHRoaXMuX29uZ2FtZXBhZGRpc2Nvbm5lY3RlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7CgogICAgICAgICAgICB2YXIgcmVtb3ZlZFBhZCA9IGV2ZW50LmdhbWVwYWQ7CgogICAgICAgICAgICBmb3IgKHZhciBpIGluIF90aGlzLl9yYXdQYWRzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoX3RoaXMuX3Jhd1BhZHNbaV0uaW5kZXggPT09IHJlbW92ZWRQYWQuaW5kZXgpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuX3Jhd1BhZHMuc3BsaWNlKGksMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3RoaXMuX2dhbWVwYWRzW3JlbW92ZWRQYWQuaW5kZXhdLmRpc2Nvbm5lY3QoKTsKICAgICAgICB9OwoKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZ2FtZXBhZGRpc2Nvbm5lY3RlZCcsIHRoaXMuX29uZ2FtZXBhZGRpc2Nvbm5lY3RlZCwgZmFsc2UpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIE1haW4gZ2FtZXBhZCB1cGRhdGUgbG9vcC4gU2hvdWxkIG5vdCBiZSBjYWxsZWQgbWFudWFsbHkuCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVwYWQjdXBkYXRlCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuX3BvbGxHYW1lcGFkcygpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2dhbWVwYWRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2dhbWVwYWRzW2ldLl9jb25uZWN0ZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX2dhbWVwYWRzW2ldLnBvbGxTdGF0dXMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGluZyBjb25uZWN0ZWQgZ2FtZXBhZHMgKGZvciBHb29nbGUgQ2hyb21lKS4KICAgICogU2hvdWxkIG5vdCBiZSBjYWxsZWQgbWFudWFsbHkuCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVwYWQjX3BvbGxHYW1lcGFkcwogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIF9wb2xsR2FtZXBhZHM6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIHJhd0dhbWVwYWRzID0gKG5hdmlnYXRvci53ZWJraXRHZXRHYW1lcGFkcyAmJiBuYXZpZ2F0b3Iud2Via2l0R2V0R2FtZXBhZHMoKSkgfHwgbmF2aWdhdG9yLndlYmtpdEdhbWVwYWRzOwoKICAgICAgICBpZiAocmF3R2FtZXBhZHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9yYXdQYWRzID0gW107CgogICAgICAgICAgICB2YXIgZ2FtZXBhZHNDaGFuZ2VkID0gZmFsc2U7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJhd0dhbWVwYWRzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJhd0dhbWVwYWRzW2ldICE9PSB0aGlzLl9wcmV2UmF3R2FtZXBhZFR5cGVzW2ldKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGdhbWVwYWRzQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHJldlJhd0dhbWVwYWRUeXBlc1tpXSA9IHR5cGVvZiByYXdHYW1lcGFkc1tpXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAocmF3R2FtZXBhZHNbaV0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmF3UGFkcy5wdXNoKHJhd0dhbWVwYWRzW2ldKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTdXBwb3J0IG1heCA0IHBhZHMgYXQgdGhlIG1vbWVudAogICAgICAgICAgICAgICAgaWYgKGkgPT09IDMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChnYW1lcGFkc0NoYW5nZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB2YWxpZENvbm5lY3Rpb25zID0geyByYXdJbmRpY2VzOiB7fSwgcGFkSW5kaWNlczoge30gfTsKICAgICAgICAgICAgICAgIHZhciBzaW5nbGVQYWQ7CgogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0aGlzLl9nYW1lcGFkcy5sZW5ndGg7IGorKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBzaW5nbGVQYWQgPSB0aGlzLl9nYW1lcGFkc1tqXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHNpbmdsZVBhZC5jb25uZWN0ZWQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IHRoaXMuX3Jhd1BhZHMubGVuZ3RoOyBrKyspCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yYXdQYWRzW2tdLmluZGV4ID09PSBzaW5nbGVQYWQuaW5kZXgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRDb25uZWN0aW9ucy5yYXdJbmRpY2VzW3NpbmdsZVBhZC5pbmRleF0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQ29ubmVjdGlvbnMucGFkSW5kaWNlc1tqXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yICh2YXIgbCA9IDA7IGwgPCB0aGlzLl9nYW1lcGFkcy5sZW5ndGg7IGwrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBzaW5nbGVQYWQgPSB0aGlzLl9nYW1lcGFkc1tsXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbGlkQ29ubmVjdGlvbnMucGFkSW5kaWNlc1tsXSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3Jhd1BhZHMubGVuZ3RoIDwgMSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNpbmdsZVBhZC5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBtID0gMDsgbSA8IHRoaXMuX3Jhd1BhZHMubGVuZ3RoOyBtKyspCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsaWRDb25uZWN0aW9ucy5wYWRJbmRpY2VzW2xdKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJhd1BhZCA9IHRoaXMuX3Jhd1BhZHNbbV07CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmF3UGFkKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsaWRDb25uZWN0aW9ucy5yYXdJbmRpY2VzW3Jhd1BhZC5pbmRleF0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2luZ2xlUGFkLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaW5nbGVQYWQuY29ubmVjdChyYXdQYWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQ29ubmVjdGlvbnMucmF3SW5kaWNlc1tyYXdQYWQuaW5kZXhdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZENvbm5lY3Rpb25zLnBhZEluZGljZXNbbF0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2luZ2xlUGFkLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGRlYWRab25lIHZhcmlhYmxlIGZvciBhbGwgZm91ciBnYW1lcGFkcwogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lcGFkI3NldERlYWRab25lcwogICAgKi8KICAgIHNldERlYWRab25lczogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fZ2FtZXBhZHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9nYW1lcGFkc1tpXS5kZWFkWm9uZSA9IHZhbHVlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wcyB0aGUgR2FtZXBhZCBldmVudCBoYW5kbGluZy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZCNzdG9wCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9hY3RpdmUgPSBmYWxzZTsKCiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2dhbWVwYWRjb25uZWN0ZWQnLCB0aGlzLl9vbmdhbWVwYWRjb25uZWN0ZWQpOwogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdnYW1lcGFkZGlzY29ubmVjdGVkJywgdGhpcy5fb25nYW1lcGFkZGlzY29ubmVjdGVkKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXNldCBhbGwgYnV0dG9ucy9heGVzIG9mIGFsbCBnYW1lcGFkcwogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lcGFkI3Jlc2V0CiAgICAqLwogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy51cGRhdGUoKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9nYW1lcGFkcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2dhbWVwYWRzW2ldLnJlc2V0KCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlICJqdXN0IHByZXNzZWQiIHN0YXRlIG9mIGEgYnV0dG9uIGZyb20gQU5ZIGdhbWVwYWQgY29ubmVjdGVkLiBKdXN0IHByZXNzZWQgaXMgY29uc2lkZXJlZCB0cnVlIGlmIHRoZSBidXR0b24gd2FzIHByZXNzZWQgZG93biB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuIChkZWZhdWx0IDI1MG1zKS4KICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZCNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge251bWJlcn0gYnV0dG9uQ29kZSAtIFRoZSBidXR0b25Db2RlIG9mIHRoZSBidXR0b24gdG8gY2hlY2sgZm9yLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2R1cmF0aW9uPTI1MF0gLSBUaGUgZHVyYXRpb24gYmVsb3cgd2hpY2ggdGhlIGJ1dHRvbiBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIGp1c3QgcHJlc3NlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgYnV0dG9uIGlzIGp1c3QgcHJlc3NlZCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAganVzdFByZXNzZWQ6IGZ1bmN0aW9uIChidXR0b25Db2RlLCBkdXJhdGlvbikgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2dhbWVwYWRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2dhbWVwYWRzW2ldLmp1c3RQcmVzc2VkKGJ1dHRvbkNvZGUsIGR1cmF0aW9uKSA9PT0gdHJ1ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSAianVzdCByZWxlYXNlZCIgc3RhdGUgb2YgYSBidXR0b24gZnJvbSBBTlkgZ2FtZXBhZCBjb25uZWN0ZWQuIEp1c3QgcmVsZWFzZWQgaXMgY29uc2lkZXJlZCBhcyBiZWluZyB0cnVlIGlmIHRoZSBidXR0b24gd2FzIHJlbGVhc2VkIHdpdGhpbiB0aGUgZHVyYXRpb24gZ2l2ZW4gKGRlZmF1bHQgMjUwbXMpLgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lcGFkI2p1c3RQcmVzc2VkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBidXR0b25Db2RlIC0gVGhlIGJ1dHRvbkNvZGUgb2YgdGhlIGJ1dHRvbiB0byBjaGVjayBmb3IuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZHVyYXRpb249MjUwXSAtIFRoZSBkdXJhdGlvbiBiZWxvdyB3aGljaCB0aGUgYnV0dG9uIGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcganVzdCByZWxlYXNlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgYnV0dG9uIGlzIGp1c3QgcmVsZWFzZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGp1c3RSZWxlYXNlZDogZnVuY3Rpb24gKGJ1dHRvbkNvZGUsIGR1cmF0aW9uKSB7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fZ2FtZXBhZHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fZ2FtZXBhZHNbaV0uanVzdFJlbGVhc2VkKGJ1dHRvbkNvZGUsIGR1cmF0aW9uKSA9PT0gdHJ1ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGJ1dHRvbiBpcyBjdXJyZW50bHkgcHJlc3NlZCBkb3duLCBvbiBBTlkgZ2FtZXBhZC4KICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZCNpc0Rvd24KICAgICogQHBhcmFtIHtudW1iZXJ9IGJ1dHRvbkNvZGUgLSBUaGUgYnV0dG9uQ29kZSBvZiB0aGUgYnV0dG9uIHRvIGNoZWNrIGZvci4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBhIGJ1dHRvbiBpcyBjdXJyZW50bHkgZG93bi4KICAgICovCiAgICBpc0Rvd246IGZ1bmN0aW9uIChidXR0b25Db2RlKSB7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fZ2FtZXBhZHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fZ2FtZXBhZHNbaV0uaXNEb3duKGJ1dHRvbkNvZGUpID09PSB0cnVlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKfTsKClBoYXNlci5HYW1lcGFkLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5HYW1lcGFkOwoKLyoqCiogSWYgdGhlIGdhbWVwYWQgaW5wdXQgaXMgYWN0aXZlIG9yIG5vdCAtIGlmIG5vdCBhY3RpdmUgaXQgc2hvdWxkIG5vdCBiZSB1cGRhdGVkIGZyb20gSW5wdXQuanMKKiBAbmFtZSBQaGFzZXIuR2FtZXBhZCNhY3RpdmUKKiBAcHJvcGVydHkge2Jvb2xlYW59IGFjdGl2ZSAtIElmIHRoZSBnYW1lcGFkIGlucHV0IGlzIGFjdGl2ZSBvciBub3QuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR2FtZXBhZC5wcm90b3R5cGUsICJhY3RpdmUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2FjdGl2ZTsKICAgIH0KCn0pOwoKLyoqCiogV2hldGhlciBvciBub3QgZ2FtZXBhZHMgYXJlIHN1cHBvcnRlZCBpbiBjdXJyZW50IGJyb3dzZXIuCiogQG5hbWUgUGhhc2VyLkdhbWVwYWQjc3VwcG9ydGVkCiogQHByb3BlcnR5IHtib29sZWFufSBzdXBwb3J0ZWQgLSBXaGV0aGVyIG9yIG5vdCBnYW1lcGFkcyBhcmUgc3VwcG9ydGVkIGluIGN1cnJlbnQgYnJvd3Nlci4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5HYW1lcGFkLnByb3RvdHlwZSwgInN1cHBvcnRlZCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2FtZXBhZFN1cHBvcnRBdmFpbGFibGU7CiAgICB9Cgp9KTsKCi8qKgoqIEhvdyBtYW55IGxpdmUgZ2FtZXBhZHMgYXJlIGN1cnJlbnRseSBjb25uZWN0ZWQuCiogQG5hbWUgUGhhc2VyLkdhbWVwYWQjcGFkc0Nvbm5lY3RlZAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGFkc0Nvbm5lY3RlZCAtIEhvdyBtYW55IGxpdmUgZ2FtZXBhZHMgYXJlIGN1cnJlbnRseSBjb25uZWN0ZWQuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR2FtZXBhZC5wcm90b3R5cGUsICJwYWRzQ29ubmVjdGVkIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9yYXdQYWRzLmxlbmd0aDsKICAgIH0KCn0pOwoKLyoqCiogR2FtZXBhZCAjMQoqIEBuYW1lIFBoYXNlci5HYW1lcGFkI3BhZDEKKiBAcHJvcGVydHkge2Jvb2xlYW59IHBhZDEgLSBHYW1lcGFkICMxOwoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdhbWVwYWQucHJvdG90eXBlLCAicGFkMSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2FtZXBhZHNbMF07CiAgICB9Cgp9KTsKCi8qKgoqIEdhbWVwYWQgIzIKKiBAbmFtZSBQaGFzZXIuR2FtZXBhZCNwYWQyCiogQHByb3BlcnR5IHtib29sZWFufSBwYWQyIC0gR2FtZXBhZCAjMgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdhbWVwYWQucHJvdG90eXBlLCAicGFkMiIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2FtZXBhZHNbMV07CiAgICB9Cgp9KTsKCi8qKgoqIEdhbWVwYWQgIzMKKiBAbmFtZSBQaGFzZXIuR2FtZXBhZCNwYWQzCiogQHByb3BlcnR5IHtib29sZWFufSBwYWQzIC0gR2FtZXBhZCAjMwoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdhbWVwYWQucHJvdG90eXBlLCAicGFkMyIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2FtZXBhZHNbMl07CiAgICB9Cgp9KTsKCi8qKgoqIEdhbWVwYWQgIzQKKiBAbmFtZSBQaGFzZXIuR2FtZXBhZCNwYWQ0CiogQHByb3BlcnR5IHtib29sZWFufSBwYWQ0IC0gR2FtZXBhZCAjNAoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdhbWVwYWQucHJvdG90eXBlLCAicGFkNCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2FtZXBhZHNbM107CiAgICB9Cgp9KTsKClBoYXNlci5HYW1lcGFkLkJVVFRPTl8wID0gMDsKUGhhc2VyLkdhbWVwYWQuQlVUVE9OXzEgPSAxOwpQaGFzZXIuR2FtZXBhZC5CVVRUT05fMiA9IDI7ClBoYXNlci5HYW1lcGFkLkJVVFRPTl8zID0gMzsKUGhhc2VyLkdhbWVwYWQuQlVUVE9OXzQgPSA0OwpQaGFzZXIuR2FtZXBhZC5CVVRUT05fNSA9IDU7ClBoYXNlci5HYW1lcGFkLkJVVFRPTl82ID0gNjsKUGhhc2VyLkdhbWVwYWQuQlVUVE9OXzcgPSA3OwpQaGFzZXIuR2FtZXBhZC5CVVRUT05fOCA9IDg7ClBoYXNlci5HYW1lcGFkLkJVVFRPTl85ID0gOTsKUGhhc2VyLkdhbWVwYWQuQlVUVE9OXzEwID0gMTA7ClBoYXNlci5HYW1lcGFkLkJVVFRPTl8xMSA9IDExOwpQaGFzZXIuR2FtZXBhZC5CVVRUT05fMTIgPSAxMjsKUGhhc2VyLkdhbWVwYWQuQlVUVE9OXzEzID0gMTM7ClBoYXNlci5HYW1lcGFkLkJVVFRPTl8xNCA9IDE0OwpQaGFzZXIuR2FtZXBhZC5CVVRUT05fMTUgPSAxNTsKClBoYXNlci5HYW1lcGFkLkFYSVNfMCA9IDA7ClBoYXNlci5HYW1lcGFkLkFYSVNfMSA9IDE7ClBoYXNlci5HYW1lcGFkLkFYSVNfMiA9IDI7ClBoYXNlci5HYW1lcGFkLkFYSVNfMyA9IDM7ClBoYXNlci5HYW1lcGFkLkFYSVNfNCA9IDQ7ClBoYXNlci5HYW1lcGFkLkFYSVNfNSA9IDU7ClBoYXNlci5HYW1lcGFkLkFYSVNfNiA9IDY7ClBoYXNlci5HYW1lcGFkLkFYSVNfNyA9IDc7ClBoYXNlci5HYW1lcGFkLkFYSVNfOCA9IDg7ClBoYXNlci5HYW1lcGFkLkFYSVNfOSA9IDk7CgovLyBCZWxvdyBtYXBwaW5nIGFwcGxpZXMgdG8gWEJPWCAzNjAgV2lyZWQgYW5kIFdpcmVsZXNzIGNvbnRyb2xsZXIgb24gR29vZ2xlIENocm9tZSAodGVzdGVkIG9uIFdpbmRvd3MgNykuCi8vIC0gRmlyZWZveCB1c2VzIGRpZmZlcmVudCBtYXAhIFNlcGFyYXRlIGFtb3VudCBvZiBidXR0b25zIGFuZCBheGVzLiBEUEFEID0gYXhpcyBhbmQgbm90IGEgYnV0dG9uLgovLyBJbiBvdGhlciB3b3JkcyAtIGRpc2NyZXBhbmNpZXMgd2hlbiB1c2luZyBnYW1lcGFkcy4KClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfQSA9IDA7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfQiA9IDE7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfWCA9IDI7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfWSA9IDM7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfTEVGVF9CVU1QRVIgPSA0OwpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX1JJR0hUX0JVTVBFUiA9IDU7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfTEVGVF9UUklHR0VSID0gNjsKUGhhc2VyLkdhbWVwYWQuWEJPWDM2MF9SSUdIVF9UUklHR0VSID0gNzsKUGhhc2VyLkdhbWVwYWQuWEJPWDM2MF9CQUNLID0gODsKUGhhc2VyLkdhbWVwYWQuWEJPWDM2MF9TVEFSVCA9IDk7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfU1RJQ0tfTEVGVF9CVVRUT04gPSAxMDsKUGhhc2VyLkdhbWVwYWQuWEJPWDM2MF9TVElDS19SSUdIVF9CVVRUT04gPSAxMTsKClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfRFBBRF9MRUZUID0gMTQ7ClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfRFBBRF9SSUdIVCA9IDE1OwpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX0RQQURfVVAgPSAxMjsKUGhhc2VyLkdhbWVwYWQuWEJPWDM2MF9EUEFEX0RPV04gPSAxMzsKClBoYXNlci5HYW1lcGFkLlhCT1gzNjBfU1RJQ0tfTEVGVF9YID0gMDsKUGhhc2VyLkdhbWVwYWQuWEJPWDM2MF9TVElDS19MRUZUX1kgPSAxOwpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX1NUSUNLX1JJR0hUX1ggPSAyOwpQaGFzZXIuR2FtZXBhZC5YQk9YMzYwX1NUSUNLX1JJR0hUX1kgPSAzOwoKLyoqCiogQGF1dGhvciAgICAgICBAa2FybG1hY2tsaW4gPHRhY2tsZW1jY2xlYW5AZ21haWwuY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBAY2xhc3MgUGhhc2VyLlNpbmdsZVBhZAoqIEBjbGFzc2Rlc2MgQSBzaW5nbGUgUGhhc2VyIEdhbWVwYWQKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7T2JqZWN0fSBwYWRQYXJlbnQgLSBUaGUgcGFyZW50IFBoYXNlci5HYW1lcGFkIG9iamVjdCAoYWxsIGdhbWVwYWRzIHJlc2lkZSB1bmRlciB0aGlzKQoqLwpQaGFzZXIuU2luZ2xlUGFkID0gZnVuY3Rpb24gKGdhbWUsIHBhZFBhcmVudCkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZXBhZH0gcGFkUGFyZW50IC0gTWFpbiBQaGFzZXIgR2FtZXBhZCBvYmplY3QKICAgICovCiAgICB0aGlzLl9wYWRQYXJlbnQgPSBwYWRQYXJlbnQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpbmRleCAtIFRoZSBnYW1lcGFkIGluZGV4IGFzIHBlciBicm93c2VycyBkYXRhCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5faW5kZXggPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge09iamVjdH0gX3Jhd1BhZCAtIFRoZSAncmF3JyBnYW1lcGFkIGRhdGEuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fcmF3UGFkID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfY29ubmVjdGVkIC0gSXMgdGhpcyBwYWQgY29ubmVjdGVkIG9yIG5vdC4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9jb25uZWN0ZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9wcmV2VGltZXN0YW1wIC0gVXNlZCB0byBjaGVjayBmb3IgZGlmZmVyZW5jZXMgYmV0d2VlbiBlYXJsaWVyIHBvbGxzIGFuZCBjdXJyZW50IHN0YXRlIG9mIGdhbWVwYWRzLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3ByZXZUaW1lc3RhbXAgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0FycmF5fSBfcmF3QnV0dG9ucyAtIFRoZSAncmF3JyBidXR0b24gc3RhdGUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fcmF3QnV0dG9ucyA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0FycmF5fSBfYnV0dG9ucyAtIEN1cnJlbnQgUGhhc2VyIHN0YXRlIG9mIHRoZSBidXR0b25zLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2J1dHRvbnMgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBcnJheX0gX2F4ZXMgLSBDdXJyZW50IGF4ZXMgc3RhdGUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fYXhlcyA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0FycmF5fSBfaG90a2V5cyAtIEhvdGtleSBidXR0b25zLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2hvdGtleXMgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtPYmplY3R9IGNhbGxiYWNrQ29udGV4dCAtIFRoZSBjb250ZXh0IHVuZGVyIHdoaWNoIHRoZSBjYWxsYmFja3MgYXJlIHJ1bi4KICAgICovCiAgICB0aGlzLmNhbGxiYWNrQ29udGV4dCA9IHRoaXM7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uQ29ubmVjdENhbGxiYWNrIC0gVGhpcyBjYWxsYmFjayBpcyBpbnZva2VkIGV2ZXJ5IHRpbWUgdGhpcyBnYW1lcGFkIGlzIGNvbm5lY3RlZAogICAgKi8KICAgIHRoaXMub25Db25uZWN0Q2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvbkRpc2Nvbm5lY3RDYWxsYmFjayAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIHRoaXMgZ2FtZXBhZCBpcyBkaXNjb25uZWN0ZWQKICAgICovCiAgICB0aGlzLm9uRGlzY29ubmVjdENhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25Eb3duQ2FsbGJhY2sgLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhIGJ1dHRvbiBpcyBwcmVzc2VkIGRvd24uCiAgICAqLwogICAgdGhpcy5vbkRvd25DYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uVXBDYWxsYmFjayAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIGEgZ2FtZXBhZCBidXR0b24gaXMgcmVsZWFzZWQuCiAgICAqLwogICAgdGhpcy5vblVwQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvbkF4aXNDYWxsYmFjayAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIGFuIGF4aXMgaXMgY2hhbmdlZC4KICAgICovCiAgICB0aGlzLm9uQXhpc0NhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25GbG9hdENhbGxiYWNrIC0gVGhpcyBjYWxsYmFjayBpcyBpbnZva2VkIGV2ZXJ5IHRpbWUgYSBidXR0b24gaXMgY2hhbmdlZCB0byBhIHZhbHVlIHdoZXJlIHZhbHVlID4gMCBhbmQgdmFsdWUgPCAxLgogICAgKi8KICAgIHRoaXMub25GbG9hdENhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGRlYWRab25lIC0gRGVhZCB6b25lIGZvciBheGlzIGZlZWRiYWNrIC0gd2l0aGluIHRoaXMgdmFsdWUgeW91IHdvbid0IHRyaWdnZXIgdXBkYXRlcy4KICAgICovCiAgICB0aGlzLmRlYWRab25lID0gMC4yNjsKCn07CgpQaGFzZXIuU2luZ2xlUGFkLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkIGNhbGxiYWNrcyB0byB0aGUgdGhpcyBHYW1lcGFkIHRvIGhhbmRsZSBjb25uZWN0L2Rpc2Nvbm5lY3QvYnV0dG9uIGRvd24vYnV0dG9uIHVwL2F4aXMgY2hhbmdlL2Zsb2F0IHZhbHVlIGJ1dHRvbnMKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZCNhZGRDYWxsYmFja3MKICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgLSBUaGUgY29udGV4dCB1bmRlciB3aGljaCB0aGUgY2FsbGJhY2tzIGFyZSBydW4uCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBjYWxsYmFja3MgLSBPYmplY3QgdGhhdCB0YWtlcyBzaXggZGlmZmVyZW50IGNhbGxiYWsgbWV0aG9kczoKICAgICogb25Db25uZWN0Q2FsbGJhY2ssIG9uRGlzY29ubmVjdENhbGxiYWNrLCBvbkRvd25DYWxsYmFjaywgb25VcENhbGxiYWNrLCBvbkF4aXNDYWxsYmFjaywgb25GbG9hdENhbGxiYWNrCiAgICAqLwogICAgYWRkQ2FsbGJhY2tzOiBmdW5jdGlvbiAoY29udGV4dCwgY2FsbGJhY2tzKSB7CgogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2tzICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25Db25uZWN0Q2FsbGJhY2sgPSAodHlwZW9mIGNhbGxiYWNrcy5vbkNvbm5lY3QgPT09ICdmdW5jdGlvbicpID8gY2FsbGJhY2tzLm9uQ29ubmVjdCA6IHRoaXMub25Db25uZWN0Q2FsbGJhY2s7CiAgICAgICAgICAgIHRoaXMub25EaXNjb25uZWN0Q2FsbGJhY2sgPSAodHlwZW9mIGNhbGxiYWNrcy5vbkRpc2Nvbm5lY3QgPT09ICdmdW5jdGlvbicpID8gY2FsbGJhY2tzLm9uRGlzY29ubmVjdCA6IHRoaXMub25EaXNjb25uZWN0Q2FsbGJhY2s7CiAgICAgICAgICAgIHRoaXMub25Eb3duQ2FsbGJhY2sgPSAodHlwZW9mIGNhbGxiYWNrcy5vbkRvd24gPT09ICdmdW5jdGlvbicpID8gY2FsbGJhY2tzLm9uRG93biA6IHRoaXMub25Eb3duQ2FsbGJhY2s7CiAgICAgICAgICAgIHRoaXMub25VcENhbGxiYWNrID0gKHR5cGVvZiBjYWxsYmFja3Mub25VcCA9PT0gJ2Z1bmN0aW9uJykgPyBjYWxsYmFja3Mub25VcCA6IHRoaXMub25VcENhbGxiYWNrOwogICAgICAgICAgICB0aGlzLm9uQXhpc0NhbGxiYWNrID0gKHR5cGVvZiBjYWxsYmFja3Mub25BeGlzID09PSAnZnVuY3Rpb24nKSA/IGNhbGxiYWNrcy5vbkF4aXMgOiB0aGlzLm9uQXhpc0NhbGxiYWNrOwogICAgICAgICAgICB0aGlzLm9uRmxvYXRDYWxsYmFjayA9ICh0eXBlb2YgY2FsbGJhY2tzLm9uRmxvYXQgPT09ICdmdW5jdGlvbicpID8gY2FsbGJhY2tzLm9uRmxvYXQgOiB0aGlzLm9uRmxvYXRDYWxsYmFjazsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSWYgeW91IG5lZWQgbW9yZSBmaW5lLWdyYWluZWQgY29udHJvbCBvdmVyIGEgS2V5IHlvdSBjYW4gY3JlYXRlIGEgbmV3IFBoYXNlci5LZXkgb2JqZWN0IHZpYSB0aGlzIG1ldGhvZC4KICAgICogVGhlIEtleSBvYmplY3QgY2FuIHRoZW4gYmUgcG9sbGVkLCBoYXZlIGV2ZW50cyBhdHRhY2hlZCB0byBpdCwgZXRjLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaW5nbGVQYWQjYWRkQnV0dG9uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBidXR0b25Db2RlIC0gVGhlIGJ1dHRvbkNvZGUgb2YgdGhlIGJ1dHRvbiwgaS5lLiBQaGFzZXIuR2FtZXBhZC5CVVRUT05fMCBvciBQaGFzZXIuR2FtZXBhZC5CVVRUT05fMQogICAgKiBAcmV0dXJuIHtQaGFzZXIuR2FtZXBhZEJ1dHRvbn0gVGhlIEdhbWVwYWRCdXR0b24gb2JqZWN0IHdoaWNoIHlvdSBjYW4gc3RvcmUgbG9jYWxseSBhbmQgcmVmZXJlbmNlIGRpcmVjdGx5LgogICAgKi8KICAgIGFkZEJ1dHRvbjogZnVuY3Rpb24gKGJ1dHRvbkNvZGUpIHsKCiAgICAgICAgdGhpcy5faG90a2V5c1tidXR0b25Db2RlXSA9IG5ldyBQaGFzZXIuR2FtZXBhZEJ1dHRvbih0aGlzLmdhbWUsIGJ1dHRvbkNvZGUpOwogICAgICAgIHJldHVybiB0aGlzLl9ob3RrZXlzW2J1dHRvbkNvZGVdOwoKICAgIH0sCgogICAgLyoqCiAgICAqIE1haW4gdXBkYXRlIGZ1bmN0aW9uLCBzaG91bGQgYmUgY2FsbGVkIGJ5IFBoYXNlci5HYW1lcGFkCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpbmdsZVBhZCNwb2xsU3RhdHVzCiAgICAqLwogICAgcG9sbFN0YXR1czogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fcmF3UGFkLnRpbWVzdGFtcCAmJiAodGhpcy5fcmF3UGFkLnRpbWVzdGFtcCA9PSB0aGlzLl9wcmV2VGltZXN0YW1wKSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fcmF3UGFkLmJ1dHRvbnMubGVuZ3RoOyBpICs9IDEpCiAgICAgICAgewogICAgICAgICAgICB2YXIgYnV0dG9uVmFsdWUgPSB0aGlzLl9yYXdQYWQuYnV0dG9uc1tpXTsKCiAgICAgICAgICAgIGlmICh0aGlzLl9yYXdCdXR0b25zW2ldICE9PSBidXR0b25WYWx1ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGJ1dHRvblZhbHVlID09PSAxKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc0J1dHRvbkRvd24oaSwgYnV0dG9uVmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoYnV0dG9uVmFsdWUgPT09IDApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzQnV0dG9uVXAoaSwgYnV0dG9uVmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc0J1dHRvbkZsb2F0KGksIGJ1dHRvblZhbHVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLl9yYXdCdXR0b25zW2ldID0gYnV0dG9uVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBheGVzID0gdGhpcy5fcmF3UGFkLmF4ZXM7CgogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXhlcy5sZW5ndGg7IGogKz0gMSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBheGlzID0gYXhlc1tqXTsKCiAgICAgICAgICAgIGlmIChheGlzID4gMCAmJiBheGlzID4gdGhpcy5kZWFkWm9uZSB8fCBheGlzIDwgMCAmJiBheGlzIDwgLXRoaXMuZGVhZFpvbmUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc0F4aXNDaGFuZ2Uoe2F4aXM6IGosIHZhbHVlOiBheGlzfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NBeGlzQ2hhbmdlKHtheGlzOiBqLCB2YWx1ZTogMH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9wcmV2VGltZXN0YW1wID0gdGhpcy5fcmF3UGFkLnRpbWVzdGFtcDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHYW1lcGFkIGNvbm5lY3QgZnVuY3Rpb24sIHNob3VsZCBiZSBjYWxsZWQgYnkgUGhhc2VyLkdhbWVwYWQKICAgICogQHBhcmFtIHtPYmplY3R9IHJhd1BhZCAtIFRoZSByYXcgZ2FtZXBhZCBvYmplY3QKICAgICogQG1ldGhvZCBQaGFzZXIuU2luZ2xlUGFkI2Nvbm5lY3QKICAgICovCiAgICBjb25uZWN0OiBmdW5jdGlvbiAocmF3UGFkKSB7CgogICAgICAgIHZhciB0cmlnZ2VyQ2FsbGJhY2sgPSAhdGhpcy5fY29ubmVjdGVkOwoKICAgICAgICB0aGlzLl9pbmRleCA9IHJhd1BhZC5pbmRleDsKICAgICAgICB0aGlzLl9jb25uZWN0ZWQgPSB0cnVlOwogICAgICAgIHRoaXMuX3Jhd1BhZCA9IHJhd1BhZDsKICAgICAgICB0aGlzLl9yYXdCdXR0b25zID0gcmF3UGFkLmJ1dHRvbnM7CiAgICAgICAgdGhpcy5fYXhlcyA9IHJhd1BhZC5heGVzOwoKICAgICAgICBpZiAodHJpZ2dlckNhbGxiYWNrICYmIHRoaXMuX3BhZFBhcmVudC5vbkNvbm5lY3RDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BhZFBhcmVudC5vbkNvbm5lY3RDYWxsYmFjay5jYWxsKHRoaXMuX3BhZFBhcmVudC5jYWxsYmFja0NvbnRleHQsIHRoaXMuX2luZGV4KTsKICAgICAgICB9CgogICAgICAgIGlmICh0cmlnZ2VyQ2FsbGJhY2sgJiYgdGhpcy5vbkNvbm5lY3RDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25Db25uZWN0Q2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEdhbWVwYWQgZGlzY29ubmVjdCBmdW5jdGlvbiwgc2hvdWxkIGJlIGNhbGxlZCBieSBQaGFzZXIuR2FtZXBhZAogICAgKiBAbWV0aG9kIFBoYXNlci5TaW5nbGVQYWQjZGlzY29ubmVjdAogICAgKi8KICAgIGRpc2Nvbm5lY3Q6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIHRyaWdnZXJDYWxsYmFjayA9IHRoaXMuX2Nvbm5lY3RlZDsKICAgICAgICB0aGlzLl9jb25uZWN0ZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLl9yYXdQYWQgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5fcmF3QnV0dG9ucyA9IFtdOwogICAgICAgIHRoaXMuX2J1dHRvbnMgPSBbXTsKICAgICAgICB2YXIgZGlzY29ubmVjdGluZ0luZGV4ID0gdGhpcy5faW5kZXg7CiAgICAgICAgdGhpcy5faW5kZXggPSBudWxsOwoKICAgICAgICBpZiAodHJpZ2dlckNhbGxiYWNrICYmIHRoaXMuX3BhZFBhcmVudC5vbkRpc2Nvbm5lY3RDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BhZFBhcmVudC5vbkRpc2Nvbm5lY3RDYWxsYmFjay5jYWxsKHRoaXMuX3BhZFBhcmVudC5jYWxsYmFja0NvbnRleHQsIGRpc2Nvbm5lY3RpbmdJbmRleCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodHJpZ2dlckNhbGxiYWNrICYmIHRoaXMub25EaXNjb25uZWN0Q2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uRGlzY29ubmVjdENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBIYW5kbGVzIGNoYW5nZXMgaW4gYXhpcwogICAgKiBAcGFyYW0ge09iamVjdH0gYXhpc1N0YXRlIC0gU3RhdGUgb2YgdGhlIHJlbGV2YW50IGF4aXMKICAgICogQG1ldGhvZCBQaGFzZXIuU2luZ2xlUGFkI3Byb2Nlc3NBeGlzQ2hhbmdlCiAgICAqLwogICAgcHJvY2Vzc0F4aXNDaGFuZ2U6IGZ1bmN0aW9uIChheGlzU3RhdGUpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmdhbWUuaW5wdXQuZ2FtZXBhZC5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9heGVzW2F4aXNTdGF0ZS5heGlzXSA9PT0gYXhpc1N0YXRlLnZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fYXhlc1theGlzU3RhdGUuYXhpc10gPSBheGlzU3RhdGUudmFsdWU7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuX3BhZFBhcmVudC5vbkF4aXNDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BhZFBhcmVudC5vbkF4aXNDYWxsYmFjay5jYWxsKHRoaXMuX3BhZFBhcmVudC5jYWxsYmFja0NvbnRleHQsIGF4aXNTdGF0ZSwgdGhpcy5faW5kZXgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMub25BeGlzQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uQXhpc0NhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGF4aXNTdGF0ZSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEhhbmRsZXMgYnV0dG9uIGRvd24gcHJlc3MKICAgICogQHBhcmFtIHtudW1iZXJ9IGJ1dHRvbkNvZGUgLSBXaGljaCBidXR0b25Db2RlIG9mIHRoaXMgYnV0dG9uCiAgICAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZSAtIEJ1dHRvbiB2YWx1ZQogICAgKiBAbWV0aG9kIFBoYXNlci5TaW5nbGVQYWQjcHJvY2Vzc0J1dHRvbkRvd24KICAgICovCiAgICBwcm9jZXNzQnV0dG9uRG93bjogZnVuY3Rpb24gKGJ1dHRvbkNvZGUsIHZhbHVlKSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5nYW1lLmlucHV0LmdhbWVwYWQuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fcGFkUGFyZW50Lm9uRG93bkNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcGFkUGFyZW50Lm9uRG93bkNhbGxiYWNrLmNhbGwodGhpcy5fcGFkUGFyZW50LmNhbGxiYWNrQ29udGV4dCwgYnV0dG9uQ29kZSwgdmFsdWUsIHRoaXMuX2luZGV4KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm9uRG93bkNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vbkRvd25DYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBidXR0b25Db2RlLCB2YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXSAmJiB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdLmlzRG93bikKICAgICAgICB7CiAgICAgICAgICAgIC8vICBLZXkgYWxyZWFkeSBkb3duIGFuZCBzdGlsbCBkb3duLCBzbyB1cGRhdGUKICAgICAgICAgICAgdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXS5kdXJhdGlvbiA9IHRoaXMuZ2FtZS50aW1lLm5vdyAtIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0udGltZURvd247CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICghdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIE5vdCB1c2VkIHRoaXMgYnV0dG9uIGJlZm9yZSwgc28gcmVnaXN0ZXIgaXQKICAgICAgICAgICAgICAgIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgaXNEb3duOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHRpbWVEb3duOiB0aGlzLmdhbWUudGltZS5ub3csCiAgICAgICAgICAgICAgICAgICAgdGltZVVwOiAwLAogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAwLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBCdXR0b24gdXNlZCBiZWZvcmUgYnV0IGZyZXNobHkgZG93bgogICAgICAgICAgICAgICAgdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXS5pc0Rvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXS50aW1lRG93biA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgICAgIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0uZHVyYXRpb24gPSAwOwogICAgICAgICAgICAgICAgdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXS52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5faG90a2V5c1tidXR0b25Db2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2hvdGtleXNbYnV0dG9uQ29kZV0ucHJvY2Vzc0J1dHRvbkRvd24odmFsdWUpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBIYW5kbGVzIGJ1dHRvbiByZWxlYXNlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBidXR0b25Db2RlIC0gV2hpY2ggYnV0dG9uQ29kZSBvZiB0aGlzIGJ1dHRvbgogICAgKiBAcGFyYW0ge09iamVjdH0gdmFsdWUgLSBCdXR0b24gdmFsdWUKICAgICogQG1ldGhvZCBQaGFzZXIuU2luZ2xlUGFkI3Byb2Nlc3NCdXR0b25VcAogICAgKi8KICAgIHByb2Nlc3NCdXR0b25VcDogZnVuY3Rpb24gKGJ1dHRvbkNvZGUsIHZhbHVlKSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5nYW1lLmlucHV0LmdhbWVwYWQuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fcGFkUGFyZW50Lm9uVXBDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BhZFBhcmVudC5vblVwQ2FsbGJhY2suY2FsbCh0aGlzLl9wYWRQYXJlbnQuY2FsbGJhY2tDb250ZXh0LCBidXR0b25Db2RlLCB2YWx1ZSwgdGhpcy5faW5kZXgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMub25VcENhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vblVwQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgYnV0dG9uQ29kZSwgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2hvdGtleXNbYnV0dG9uQ29kZV0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9ob3RrZXlzW2J1dHRvbkNvZGVdLnByb2Nlc3NCdXR0b25VcCh2YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0uaXNEb3duID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0udGltZVVwID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgICAgICB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBOb3QgdXNlZCB0aGlzIGJ1dHRvbiBiZWZvcmUsIHNvIHJlZ2lzdGVyIGl0CiAgICAgICAgICAgIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0gPSB7CiAgICAgICAgICAgICAgICBpc0Rvd246IGZhbHNlLAogICAgICAgICAgICAgICAgdGltZURvd246IHRoaXMuZ2FtZS50aW1lLm5vdywKICAgICAgICAgICAgICAgIHRpbWVVcDogdGhpcy5nYW1lLnRpbWUubm93LAogICAgICAgICAgICAgICAgZHVyYXRpb246IDAsCiAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSGFuZGxlcyBidXR0b25zIHdpdGggZmxvYXRpbmcgdmFsdWVzIChsaWtlIGFuYWxvZyBidXR0b25zIHRoYXQgYWN0cyBhbG1vc3QgbGlrZSBhbiBheGlzIGJ1dCBzdGlsbCByZWdpc3RlcnMgbGlrZSBhIGJ1dHRvbikKICAgICogQHBhcmFtIHtudW1iZXJ9IGJ1dHRvbkNvZGUgLSBXaGljaCBidXR0b25Db2RlIG9mIHRoaXMgYnV0dG9uCiAgICAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZSAtIEJ1dHRvbiB2YWx1ZSAod2lsbCByYW5nZSBzb21ld2hlcmUgYmV0d2VlbiAwIGFuZCAxLCBidXQgbm90IHNwZWNpZmljYWxseSAwIG9yIDEuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpbmdsZVBhZCNwcm9jZXNzQnV0dG9uRmxvYXQKICAgICovCiAgICBwcm9jZXNzQnV0dG9uRmxvYXQ6IGZ1bmN0aW9uIChidXR0b25Db2RlLCB2YWx1ZSkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZ2FtZS5pbnB1dC5nYW1lcGFkLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX3BhZFBhcmVudC5vbkZsb2F0Q2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wYWRQYXJlbnQub25GbG9hdENhbGxiYWNrLmNhbGwodGhpcy5fcGFkUGFyZW50LmNhbGxiYWNrQ29udGV4dCwgYnV0dG9uQ29kZSwgdmFsdWUsIHRoaXMuX2luZGV4KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm9uRmxvYXRDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25GbG9hdENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGJ1dHRvbkNvZGUsIHZhbHVlKTsKICAgICAgICB9CgogICAgICAgIGlmICghdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBOb3QgdXNlZCB0aGlzIGJ1dHRvbiBiZWZvcmUsIHNvIHJlZ2lzdGVyIGl0CiAgICAgICAgICAgIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0gPSB7IHZhbHVlOiB2YWx1ZSB9OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgQnV0dG9uIHVzZWQgYmVmb3JlIGJ1dCBmcmVzaGx5IGRvd24KICAgICAgICAgICAgdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXS52YWx1ZSA9IHZhbHVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2hvdGtleXNbYnV0dG9uQ29kZV0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9ob3RrZXlzW2J1dHRvbkNvZGVdLnByb2Nlc3NCdXR0b25GbG9hdCh2YWx1ZSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdmFsdWUgb2YgcmVxdWVzdGVkIGF4aXMKICAgICogQG1ldGhvZCBQaGFzZXIuU2luZ2xlUGFkI2lzRG93bgogICAgKiBAcGFyYW0ge251bWJlcn0gYXhpc0NvZGUgLSBUaGUgaW5kZXggb2YgdGhlIGF4aXMgdG8gY2hlY2sKICAgICogQHJldHVybiB7bnVtYmVyfSBBeGlzIHZhbHVlIGlmIGF2YWlsYWJsZSBvdGhlcndpc2UgZmFsc2UKICAgICovCiAgICBheGlzOiBmdW5jdGlvbiAoYXhpc0NvZGUpIHsKCiAgICAgICAgaWYgKHRoaXMuX2F4ZXNbYXhpc0NvZGVdKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2F4ZXNbYXhpc0NvZGVdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgYnV0dG9uIGlzIGN1cnJlbnRseSBwcmVzc2VkIGRvd24uCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpbmdsZVBhZCNpc0Rvd24KICAgICogQHBhcmFtIHtudW1iZXJ9IGJ1dHRvbkNvZGUgLSBUaGUgYnV0dG9uQ29kZSBvZiB0aGUga2V5IHRvIGNoZWNrLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBrZXkgaXMgY3VycmVudGx5IGRvd24uCiAgICAqLwogICAgaXNEb3duOiBmdW5jdGlvbiAoYnV0dG9uQ29kZSkgewoKICAgICAgICBpZiAodGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdLmlzRG93bjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSAianVzdCByZWxlYXNlZCIgc3RhdGUgb2YgYSBidXR0b24gZnJvbSB0aGlzIGdhbWVwYWQuIEp1c3QgcmVsZWFzZWQgaXMgY29uc2lkZXJlZCBhcyBiZWluZyB0cnVlIGlmIHRoZSBidXR0b24gd2FzIHJlbGVhc2VkIHdpdGhpbiB0aGUgZHVyYXRpb24gZ2l2ZW4gKGRlZmF1bHQgMjUwbXMpLgogICAgKiBAbWV0aG9kIFBoYXNlci5TaW5nbGVQYWQjanVzdFByZXNzZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IGJ1dHRvbkNvZGUgLSBUaGUgYnV0dG9uQ29kZSBvZiB0aGUgYnV0dG9uIHRvIGNoZWNrIGZvci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbj0yNTBdIC0gVGhlIGR1cmF0aW9uIGJlbG93IHdoaWNoIHRoZSBidXR0b24gaXMgY29uc2lkZXJlZCBhcyBiZWluZyBqdXN0IHJlbGVhc2VkLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBidXR0b24gaXMganVzdCByZWxlYXNlZCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAganVzdFJlbGVhc2VkOiBmdW5jdGlvbiAoYnV0dG9uQ29kZSwgZHVyYXRpb24pIHsKCiAgICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gInVuZGVmaW5lZCIpIHsgZHVyYXRpb24gPSAyNTA7IH0KCiAgICAgICAgcmV0dXJuICh0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdICYmIHRoaXMuX2J1dHRvbnNbYnV0dG9uQ29kZV0uaXNEb3duID09PSBmYWxzZSAmJiAodGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXS50aW1lVXAgPCBkdXJhdGlvbikpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlICJqdXN0IHByZXNzZWQiIHN0YXRlIG9mIGEgYnV0dG9uIGZyb20gdGhpcyBnYW1lcGFkLiBKdXN0IHByZXNzZWQgaXMgY29uc2lkZXJlZCB0cnVlIGlmIHRoZSBidXR0b24gd2FzIHByZXNzZWQgZG93biB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuIChkZWZhdWx0IDI1MG1zKS4KICAgICogQG1ldGhvZCBQaGFzZXIuU2luZ2xlUGFkI2p1c3RQcmVzc2VkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBidXR0b25Db2RlIC0gVGhlIGJ1dHRvbkNvZGUgb2YgdGhlIGJ1dHRvbiB0byBjaGVjayBmb3IuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZHVyYXRpb249MjUwXSAtIFRoZSBkdXJhdGlvbiBiZWxvdyB3aGljaCB0aGUgYnV0dG9uIGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcganVzdCBwcmVzc2VkLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBidXR0b24gaXMganVzdCBwcmVzc2VkIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBqdXN0UHJlc3NlZDogZnVuY3Rpb24gKGJ1dHRvbkNvZGUsIGR1cmF0aW9uKSB7CgogICAgICAgIGlmICh0eXBlb2YgZHVyYXRpb24gPT09ICJ1bmRlZmluZWQiKSB7IGR1cmF0aW9uID0gMjUwOyB9CgogICAgICAgIHJldHVybiAodGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXSAmJiB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdLmlzRG93biAmJiB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdLmR1cmF0aW9uIDwgZHVyYXRpb24pOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIHZhbHVlIG9mIGEgZ2FtZXBhZCBidXR0b24uIEludGVuZGVkIG1haW5seSBmb3IgY2FzZXMgd2hlbiB5b3UgaGF2ZSBmbG9hdGluZyBidXR0b24gdmFsdWVzLCBmb3IgZXhhbXBsZQogICAgKiBhbmFsb2cgdHJpZ2dlciBidXR0b25zIG9uIHRoZSBYQk9YIDM2MCBjb250cm9sbGVyCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpbmdsZVBhZCNidXR0b25WYWx1ZQogICAgKiBAcGFyYW0ge251bWJlcn0gYnV0dG9uQ29kZSAtIFRoZSBidXR0b25Db2RlIG9mIHRoZSBidXR0b24gdG8gY2hlY2suCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEJ1dHRvbiB2YWx1ZSBpZiBhdmFpbGFibGUgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGJ1dHRvblZhbHVlOiBmdW5jdGlvbiAoYnV0dG9uQ29kZSkgewoKICAgICAgICBpZiAodGhpcy5fYnV0dG9uc1tidXR0b25Db2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9idXR0b25zW2J1dHRvbkNvZGVdLnZhbHVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlc2V0IGFsbCBidXR0b25zL2F4ZXMgb2YgdGhpcyBnYW1lcGFkCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpbmdsZVBhZCNyZXNldAogICAgKi8KICAgIHJlc2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fYnV0dG9ucy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2J1dHRvbnNbaV0gPSAwOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0aGlzLl9heGVzLmxlbmd0aDsgaisrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fYXhlc1tqXSA9IDA7CiAgICAgICAgfQoKICAgIH0KCn07CgpQaGFzZXIuU2luZ2xlUGFkLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5TaW5nbGVQYWQ7CgovKioKICogV2hldGhlciBvciBub3QgdGhpcyBwYXJ0aWN1bGFyIGdhbWVwYWQgaXMgY29ubmVjdGVkIG9yIG5vdC4KICogQG5hbWUgUGhhc2VyLlNpbmdsZVBhZCNjb25uZWN0ZWQKICogQHByb3BlcnR5IHtib29sZWFufSBjb25uZWN0ZWQgLSBXaGV0aGVyIG9yIG5vdCB0aGlzIHBhcnRpY3VsYXIgZ2FtZXBhZCBpcyBjb25uZWN0ZWQgb3Igbm90LgogKiBAcmVhZG9ubHkKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU2luZ2xlUGFkLnByb3RvdHlwZSwgImNvbm5lY3RlZCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGVkOwogICAgfQoKfSk7CgovKioKICogR2FtZXBhZCBpbmRleCBhcyBwZXIgYnJvd3NlciBkYXRhCiAqIEBuYW1lIFBoYXNlci5TaW5nbGVQYWQjaW5kZXgKICogQHByb3BlcnR5IHtudW1iZXJ9IGluZGV4IC0gVGhlIGdhbWVwYWQgaW5kZXgsIHVzZWQgdG8gaWRlbnRpZnkgc3BlY2lmaWMgZ2FtZXBhZHMgaW4gdGhlIGJyb3dzZXIKICogQHJlYWRvbmx5CiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNpbmdsZVBhZC5wcm90b3R5cGUsICJpbmRleCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5faW5kZXg7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgQGthcmxtYWNrbGluIDx0YWNrbGVtY2NsZWFuQGdtYWlsLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQGNsYXNzIFBoYXNlci5HYW1lcGFkQnV0dG9uCiogQGNsYXNzZGVzYyBJZiB5b3UgbmVlZCBtb3JlIGZpbmUtZ3JhaW5lZCBjb250cm9sIG92ZXIgdGhlIGhhbmRsaW5nIG9mIHNwZWNpZmljIGJ1dHRvbnMgeW91IGNhbiBjcmVhdGUgYW5kIHVzZSBQaGFzZXIuR2FtZXBhZEJ1dHRvbiBvYmplY3RzLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBDdXJyZW50IGdhbWUgaW5zdGFuY2UuCiogQHBhcmFtIHtudW1iZXJ9IGJ1dHRvbmNvZGUgLSBUaGUgYnV0dG9uIGNvZGUgdGhpcyBHYW1lcGFkQnV0dG9uIGlzIHJlc3BvbnNpYmxlIGZvci4KKi8KUGhhc2VyLkdhbWVwYWRCdXR0b24gPSBmdW5jdGlvbiAoZ2FtZSwgYnV0dG9uY29kZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc0Rvd24gLSBUaGUgImRvd24iIHN0YXRlIG9mIHRoZSBidXR0b24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc0Rvd24gPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc1VwIC0gVGhlICJ1cCIgc3RhdGUgb2YgdGhlIGJ1dHRvbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzVXAgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVEb3duIC0gVGhlIHRpbWVzdGFtcCB3aGVuIHRoZSBidXR0b24gd2FzIGxhc3QgcHJlc3NlZCBkb3duLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGltZURvd24gPSAwOwoKICAgIC8qKgogICAgKiBJZiB0aGUgYnV0dG9uIGlzIGRvd24gdGhpcyB2YWx1ZSBob2xkcyB0aGUgZHVyYXRpb24gb2YgdGhhdCBidXR0b24gcHJlc3MgYW5kIGlzIGNvbnN0YW50bHkgdXBkYXRlZC4KICAgICogSWYgdGhlIGJ1dHRvbiBpcyB1cCBpdCBob2xkcyB0aGUgZHVyYXRpb24gb2YgdGhlIHByZXZpb3VzIGRvd24gc2Vzc2lvbi4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGR1cmF0aW9uIC0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdGhpcyBidXR0b24gaGFzIGJlZW4gaGVsZCBkb3duIGZvci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmR1cmF0aW9uID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVVcCAtIFRoZSB0aW1lc3RhbXAgd2hlbiB0aGUgYnV0dG9uIHdhcyBsYXN0IHJlbGVhc2VkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGltZVVwID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHJlcGVhdHMgLSBJZiBhIGJ1dHRvbiBpcyBoZWxkIGRvd24gdGhpcyBob2xkcyBkb3duIHRoZSBudW1iZXIgb2YgdGltZXMgdGhlIGJ1dHRvbiBoYXMgJ3JlcGVhdGVkJy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnJlcGVhdHMgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdmFsdWUgLSBCdXR0b24gdmFsdWUuIE1haW5seSB1c2VmdWwgZm9yIGNoZWNraW5nIGFuYWxvZyBidXR0b25zIChsaWtlIHNob3VsZGVyIHRyaWdnZXJzKQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudmFsdWUgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gYnV0dG9uQ29kZSAtIFRoZSBidXR0b25jb2RlIG9mIHRoaXMgYnV0dG9uLgogICAgKi8KICAgIHRoaXMuYnV0dG9uQ29kZSA9IGJ1dHRvbmNvZGU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Eb3duIC0gVGhpcyBTaWduYWwgaXMgZGlzcGF0Y2hlZCBldmVyeSB0aW1lIHRoaXMgR2FtZXBhZEJ1dHRvbiBpcyBwcmVzc2VkIGRvd24uIEl0IGlzIG9ubHkgZGlzcGF0Y2hlZCBvbmNlICh1bnRpbCB0aGUgYnV0dG9uIGlzIHJlbGVhc2VkIGFnYWluKS4KICAgICovCiAgICB0aGlzLm9uRG93biA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25VcCAtIFRoaXMgU2lnbmFsIGlzIGRpc3BhdGNoZWQgZXZlcnkgdGltZSB0aGlzIEdhbWVwYWRCdXR0b24gaXMgcHJlc3NlZCBkb3duLiBJdCBpcyBvbmx5IGRpc3BhdGNoZWQgb25jZSAodW50aWwgdGhlIGJ1dHRvbiBpcyByZWxlYXNlZCBhZ2FpbikuCiAgICAqLwogICAgdGhpcy5vblVwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkZsb2F0IC0gVGhpcyBTaWduYWwgaXMgZGlzcGF0Y2hlZCBldmVyeSB0aW1lIHRoaXMgR2FtZXBhZEJ1dHRvbiBjaGFuZ2VzIGZsb2F0aW5nIHZhbHVlIChiZXR3ZWVuIChidXQgbm90IGV4YWN0bHkpIDAgYW5kIDEpCiAgICAqLwogICAgdGhpcy5vbkZsb2F0ID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCn07CgpQaGFzZXIuR2FtZXBhZEJ1dHRvbi5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IFBoYXNlci5TaW5nbGVQYWQuCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVwYWRCdXR0b24jcHJvY2Vzc0J1dHRvbkRvd24KICAgICogQHBhcmFtIHtPYmplY3R9IHZhbHVlIC0gQnV0dG9uIHZhbHVlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwcm9jZXNzQnV0dG9uRG93bjogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh0aGlzLmlzRG93bikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZHVyYXRpb24gPSB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLnRpbWVEb3duOwogICAgICAgICAgICB0aGlzLnJlcGVhdHMrKzsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5pc0Rvd24gPSB0cnVlOwogICAgICAgICAgICB0aGlzLmlzVXAgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy50aW1lRG93biA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMucmVwZWF0cyA9IDA7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKCiAgICAgICAgICAgIHRoaXMub25Eb3duLmRpc3BhdGNoKHRoaXMsIHZhbHVlKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgUGhhc2VyLlNpbmdsZVBhZC4KICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZEJ1dHRvbiNwcm9jZXNzQnV0dG9uVXAKICAgICogQHBhcmFtIHtPYmplY3R9IHZhbHVlIC0gQnV0dG9uIHZhbHVlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwcm9jZXNzQnV0dG9uVXA6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICB0aGlzLmlzRG93biA9IGZhbHNlOwogICAgICAgIHRoaXMuaXNVcCA9IHRydWU7CiAgICAgICAgdGhpcy50aW1lVXAgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwoKICAgICAgICB0aGlzLm9uVXAuZGlzcGF0Y2godGhpcywgdmFsdWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IFBoYXNlci5HYW1lcGFkLgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lcGFkQnV0dG9uI3Byb2Nlc3NCdXR0b25GbG9hdAogICAgKiBAcGFyYW0ge09iamVjdH0gdmFsdWUgLSBCdXR0b24gdmFsdWUKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHByb2Nlc3NCdXR0b25GbG9hdDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICB0aGlzLm9uRmxvYXQuZGlzcGF0Y2godGhpcywgdmFsdWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlICJqdXN0IHByZXNzZWQiIHN0YXRlIG9mIHRoaXMgYnV0dG9uLiBKdXN0IHByZXNzZWQgaXMgY29uc2lkZXJlZCB0cnVlIGlmIHRoZSBidXR0b24gd2FzIHByZXNzZWQgZG93biB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuIChkZWZhdWx0IDI1MG1zKS4KICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZEJ1dHRvbiNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge251bWJlcn0gW2R1cmF0aW9uPTI1MF0gLSBUaGUgZHVyYXRpb24gYmVsb3cgd2hpY2ggdGhlIGJ1dHRvbiBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIGp1c3QgcHJlc3NlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgYnV0dG9uIGlzIGp1c3QgcHJlc3NlZCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAganVzdFByZXNzZWQ6IGZ1bmN0aW9uIChkdXJhdGlvbikgewoKICAgICAgICBpZiAodHlwZW9mIGR1cmF0aW9uID09PSAidW5kZWZpbmVkIikgeyBkdXJhdGlvbiA9IDI1MDsgfQoKICAgICAgICByZXR1cm4gKHRoaXMuaXNEb3duICYmIHRoaXMuZHVyYXRpb24gPCBkdXJhdGlvbik7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgImp1c3QgcmVsZWFzZWQiIHN0YXRlIG9mIHRoaXMgYnV0dG9uLiBKdXN0IHJlbGVhc2VkIGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcgdHJ1ZSBpZiB0aGUgYnV0dG9uIHdhcyByZWxlYXNlZCB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuIChkZWZhdWx0IDI1MG1zKS4KICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZXBhZEJ1dHRvbiNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge251bWJlcn0gW2R1cmF0aW9uPTI1MF0gLSBUaGUgZHVyYXRpb24gYmVsb3cgd2hpY2ggdGhlIGJ1dHRvbiBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIGp1c3QgcmVsZWFzZWQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGJ1dHRvbiBpcyBqdXN0IHByZXNzZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGp1c3RSZWxlYXNlZDogZnVuY3Rpb24gKGR1cmF0aW9uKSB7CgogICAgICAgIGlmICh0eXBlb2YgZHVyYXRpb24gPT09ICJ1bmRlZmluZWQiKSB7IGR1cmF0aW9uID0gMjUwOyB9CgogICAgICAgIHJldHVybiAodGhpcy5pc0Rvd24gPT09IGZhbHNlICYmICh0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLnRpbWVVcCA8IGR1cmF0aW9uKSk7CiAgICB9Cgp9OwoKUGhhc2VyLkdhbWVwYWRCdXR0b24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkdhbWVwYWRCdXR0b247CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBAY2xhc3MgUGhhc2VyLkV2ZW50cwoqCiogQGNsYXNzZGVzYyBUaGUgRXZlbnRzIGNvbXBvbmVudCBpcyBhIGNvbGxlY3Rpb24gb2YgZXZlbnRzIGZpcmVkIGJ5IHRoZSBwYXJlbnQgZ2FtZSBvYmplY3QuCioKKiBGb3IgZXhhbXBsZSB0byB0ZWxsIHdoZW4gYSBTcHJpdGUgaGFzIGJlZW4gYWRkZWQgdG8gYSBuZXcgZ3JvdXA6CioKKiBgYGBzcHJpdGUuZXZlbnRzLm9uQWRkZWRUb0dyb3VwLmFkZCh5b3VyRnVuY3Rpb24sIHRoaXMpO2BgYAoqCiogV2hlcmUgYHlvdXJGdW5jdGlvbmAgaXMgdGhlIGZ1bmN0aW9uIHlvdSB3YW50IGNhbGxlZCB3aGVuIHRoaXMgZXZlbnQgb2NjdXJzLgoqCiogTm90ZSB0aGF0IHRoZSBJbnB1dCByZWxhdGVkIGV2ZW50cyBvbmx5IGV4aXN0IGlmIHRoZSBTcHJpdGUgaGFzIGhhZCBgaW5wdXRFbmFibGVkYCBzZXQgdG8gYHRydWVgLgoqCiogQGNvbnN0cnVjdG9yCioKKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIEEgcmVmZXJlbmNlIHRvIERlc2NyaXB0aW9uLgoqLwpQaGFzZXIuRXZlbnRzID0gZnVuY3Rpb24gKHNwcml0ZSkgewogICAgCiAgICB0aGlzLnBhcmVudCA9IHNwcml0ZTsKCiAgICB0aGlzLm9uQWRkZWRUb0dyb3VwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIHRoaXMub25SZW1vdmVkRnJvbUdyb3VwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIHRoaXMub25LaWxsZWQgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgdGhpcy5vblJldml2ZWQgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgdGhpcy5vbk91dE9mQm91bmRzID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICB0aGlzLm9uSW5wdXRPdmVyID0gbnVsbDsKICAgIHRoaXMub25JbnB1dE91dCA9IG51bGw7CiAgICB0aGlzLm9uSW5wdXREb3duID0gbnVsbDsKICAgIHRoaXMub25JbnB1dFVwID0gbnVsbDsKICAgIHRoaXMub25EcmFnU3RhcnQgPSBudWxsOwogICAgdGhpcy5vbkRyYWdTdG9wID0gbnVsbDsKCiAgICB0aGlzLm9uQW5pbWF0aW9uU3RhcnQgPSBudWxsOwogICAgdGhpcy5vbkFuaW1hdGlvbkNvbXBsZXRlID0gbnVsbDsKICAgIHRoaXMub25BbmltYXRpb25Mb29wID0gbnVsbDsKCiAgICB0aGlzLm9uQmVnaW5Db250YWN0ID0gbnVsbDsKICAgIHRoaXMub25FbmRDb250YWN0ID0gbnVsbDsKCn07CgpQaGFzZXIuRXZlbnRzLnByb3RvdHlwZSA9IHsKCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMucGFyZW50ID0gbnVsbDsKICAgICAgICB0aGlzLm9uQWRkZWRUb0dyb3VwLmRpc3Bvc2UoKTsKICAgICAgICB0aGlzLm9uUmVtb3ZlZEZyb21Hcm91cC5kaXNwb3NlKCk7CiAgICAgICAgdGhpcy5vbktpbGxlZC5kaXNwb3NlKCk7CiAgICAgICAgdGhpcy5vblJldml2ZWQuZGlzcG9zZSgpOwogICAgICAgIHRoaXMub25PdXRPZkJvdW5kcy5kaXNwb3NlKCk7CgogICAgICAgIGlmICh0aGlzLm9uSW5wdXRPdmVyKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vbklucHV0T3Zlci5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25JbnB1dE91dC5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25JbnB1dERvd24uZGlzcG9zZSgpOwogICAgICAgICAgICB0aGlzLm9uSW5wdXRVcC5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25EcmFnU3RhcnQuZGlzcG9zZSgpOwogICAgICAgICAgICB0aGlzLm9uRHJhZ1N0b3AuZGlzcG9zZSgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMub25BbmltYXRpb25TdGFydCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25BbmltYXRpb25TdGFydC5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25BbmltYXRpb25Db21wbGV0ZS5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25BbmltYXRpb25Mb29wLmRpc3Bvc2UoKTsKICAgICAgICB9CgogICAgfQoKfTsKClBoYXNlci5FdmVudHMucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkV2ZW50czsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBHYW1lIE9iamVjdCBGYWN0b3J5IGlzIGEgcXVpY2sgd2F5IHRvIGNyZWF0ZSBhbGwgb2YgdGhlIGRpZmZlcmVudCBzb3J0cyBvZiBjb3JlIG9iamVjdHMgdGhhdCBQaGFzZXIgdXNlcy4KKgoqIEBjbGFzcyBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuV29ybGR9IHdvcmxkIC0gQSByZWZlcmVuY2UgdG8gdGhlIGdhbWUgd29ybGQuCiAgICAqLwogICAgdGhpcy53b3JsZCA9IHRoaXMuZ2FtZS53b3JsZDsKCn07CgpQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBBZGRzIGFuIGV4aXN0aW5nIG9iamVjdCB0byB0aGUgZ2FtZSB3b3JsZC4KICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjZXhpc3RpbmcKICAgICogQHBhcmFtIHsqfSBvYmplY3QgLSBBbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuQnV0dG9uIG9yIGFueSBvdGhlciBkaXNwbGF5IG9iamVjdC4uCiAgICAqIEByZXR1cm4geyp9IFRoZSBjaGlsZCB0aGF0IHdhcyBhZGRlZCB0byB0aGUgR3JvdXAuCiAgICAqLwogICAgZXhpc3Rpbmc6IGZ1bmN0aW9uIChvYmplY3QpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMud29ybGQuYWRkKG9iamVjdCk7CgogICAgfSwKCiAgICAvKioKICAgICogQ3JlYXRlIGEgbmV3IFNwcml0ZSB3aXRoIHNwZWNpZmljIHBvc2l0aW9uIGFuZCBzcHJpdGUgc2hlZXQga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNzcHJpdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgc3ByaXRlLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyBzcHJpdGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfFBoYXNlci5SZW5kZXJUZXh0dXJlfFBJWEkuVGV4dHVyZX0ga2V5IC0gVGhpcyBpcyB0aGUgaW1hZ2Ugb3IgdGV4dHVyZSB1c2VkIGJ5IHRoZSBTcHJpdGUgZHVyaW5nIHJlbmRlcmluZy4gSXQgY2FuIGJlIGEgc3RyaW5nIHdoaWNoIGlzIGEgcmVmZXJlbmNlIHRvIHRoZSBDYWNoZSBlbnRyeSwgb3IgYW4gaW5zdGFuY2Ugb2YgYSBSZW5kZXJUZXh0dXJlIG9yIFBJWEkuVGV4dHVyZS4KICAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbZnJhbWVdIC0gSWYgdGhlIHNwcml0ZSB1c2VzIGFuIGltYWdlIGZyb20gYSB0ZXh0dXJlIGF0bGFzIG9yIHNwcml0ZSBzaGVldCB5b3UgY2FuIHBhc3MgdGhlIGZyYW1lIGhlcmUuIEVpdGhlciBhIG51bWJlciBmb3IgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgogICAgKiBAcGFyYW0ge1BoYXNlci5Hcm91cH0gW2dyb3VwXSAtIE9wdGlvbmFsIEdyb3VwIHRvIGFkZCB0aGUgb2JqZWN0IHRvLiBJZiBub3Qgc3BlY2lmaWVkIGl0IHdpbGwgYmUgYWRkZWQgdG8gdGhlIFdvcmxkIGdyb3VwLgogICAgKiBAcmV0dXJucyB7UGhhc2VyLlNwcml0ZX0gdGhlIG5ld2x5IGNyZWF0ZWQgc3ByaXRlIG9iamVjdC4KICAgICovCiAgICBzcHJpdGU6IGZ1bmN0aW9uICh4LCB5LCBrZXksIGZyYW1lLCBncm91cCkgewoKICAgICAgICBpZiAodHlwZW9mIGdyb3VwID09PSAndW5kZWZpbmVkJykgeyBncm91cCA9IHRoaXMud29ybGQ7IH0KCiAgICAgICAgcmV0dXJuIGdyb3VwLmNyZWF0ZSh4LCB5LCBrZXksIGZyYW1lKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBERVBSRUNBVEVEIC0gd2lsbCBiZSByZW1vdmVkIGluIFBoYXNlciAxLjIKICAgICogQ3JlYXRlIGEgbmV3IFNwcml0ZSB3aXRoIHNwZWNpZmljIHBvc2l0aW9uIGFuZCBzcHJpdGUgc2hlZXQga2V5IHRoYXQgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIGFkZGVkIGFzIGEgY2hpbGQgb2YgdGhlIGdpdmVuIHBhcmVudC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjY2hpbGQKICAgICogQHBhcmFtIHtQaGFzZXIuR3JvdXB9IGdyb3VwIC0gVGhlIEdyb3VwIHRvIGFkZCB0aGlzIGNoaWxkIHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyBzcHJpdGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IHNwcml0ZS4KICAgICogQHBhcmFtIHtzdHJpbmd8UmVuZGVyVGV4dHVyZX0gW2tleV0gLSBUaGUgaW1hZ2Uga2V5IGFzIGRlZmluZWQgaW4gdGhlIEdhbWUuQ2FjaGUgdG8gdXNlIGFzIHRoZSB0ZXh0dXJlIGZvciB0aGlzIHNwcml0ZSBPUiBhIFJlbmRlclRleHR1cmUuCiAgICAqIEBwYXJhbSAge3N0cmluZ3xudW1iZXJ9IFtmcmFtZV0gLSBJZiB0aGUgc3ByaXRlIHVzZXMgYW4gaW1hZ2UgZnJvbSBhIHRleHR1cmUgYXRsYXMgb3Igc3ByaXRlIHNoZWV0IHlvdSBjYW4gcGFzcyB0aGUgZnJhbWUgaGVyZS4gRWl0aGVyIGEgbnVtYmVyIGZvciBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiAgICAqIEByZXR1cm5zIHtQaGFzZXIuU3ByaXRlfSB0aGUgbmV3bHkgY3JlYXRlZCBzcHJpdGUgb2JqZWN0LgogICAgKi8KICAgIGNoaWxkOiBmdW5jdGlvbiAoZ3JvdXAsIHgsIHksIGtleSwgZnJhbWUpIHsKCiAgICAgICAgcmV0dXJuIGdyb3VwLmNyZWF0ZSh4LCB5LCBrZXksIGZyYW1lKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGUgYSB0d2VlbiBvYmplY3QgZm9yIGEgc3BlY2lmaWMgb2JqZWN0LiBUaGUgb2JqZWN0IGNhbiBiZSBhbnkgSmF2YVNjcmlwdCBvYmplY3Qgb3IgUGhhc2VyIG9iamVjdCBzdWNoIGFzIFNwcml0ZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjdHdlZW4KICAgICogQHBhcmFtIHtvYmplY3R9IG9iaiAtIE9iamVjdCB0aGUgdHdlZW4gd2lsbCBiZSBydW4gb24uCiAgICAqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgdHdlZW46IGZ1bmN0aW9uIChvYmopIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS50d2VlbnMuY3JlYXRlKG9iaik7CgogICAgfSwKCiAgICAvKioKICAgICogQSBHcm91cCBpcyBhIGNvbnRhaW5lciBmb3IgZGlzcGxheSBvYmplY3RzIHRoYXQgYWxsb3dzIGZvciBmYXN0IHBvb2xpbmcsIHJlY3ljbGluZyBhbmQgY29sbGlzaW9uIGNoZWNrcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjZ3JvdXAKICAgICogQHBhcmFtIHthbnl9IHBhcmVudCAtIFRoZSBwYXJlbnQgR3JvdXAgb3IgRGlzcGxheU9iamVjdENvbnRhaW5lciB0aGF0IHdpbGwgaG9sZCB0aGlzIGdyb3VwLCBpZiBhbnkuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbbmFtZT0nZ3JvdXAnXSAtIEEgbmFtZSBmb3IgdGhpcyBHcm91cC4gTm90IHVzZWQgaW50ZXJuYWxseSBidXQgdXNlZnVsIGZvciBkZWJ1Z2dpbmcuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Hcm91cH0gVGhlIG5ld2x5IGNyZWF0ZWQgZ3JvdXAuCiAgICAqLwogICAgZ3JvdXA6IGZ1bmN0aW9uIChwYXJlbnQsIG5hbWUpIHsKCiAgICAgICAgcmV0dXJuIG5ldyBQaGFzZXIuR3JvdXAodGhpcy5nYW1lLCBwYXJlbnQsIG5hbWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBuZXcgU291bmQgb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNhdWRpbwogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIEdhbWUuY2FjaGUga2V5IG9mIHRoZSBzb3VuZCB0aGF0IHRoaXMgb2JqZWN0IHdpbGwgdXNlLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ZvbHVtZT0xXSAtIFRoZSB2b2x1bWUgYXQgd2hpY2ggdGhlIHNvdW5kIHdpbGwgYmUgcGxheWVkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIFdoZXRoZXIgb3Igbm90IHRoZSBzb3VuZCB3aWxsIGxvb3AuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2Nvbm5lY3Q9dHJ1ZV0gLSBDb250cm9scyBpZiB0aGUgY3JlYXRlZCBTb3VuZCBvYmplY3Qgd2lsbCBjb25uZWN0IHRvIHRoZSBtYXN0ZXIgZ2Fpbk5vZGUgb2YgdGhlIFNvdW5kTWFuYWdlciB3aGVuIHJ1bm5pbmcgdW5kZXIgV2ViQXVkaW8uCiAgICAqIEByZXR1cm4ge1BoYXNlci5Tb3VuZH0gVGhlIG5ld2x5IGNyZWF0ZWQgdGV4dCBvYmplY3QuCiAgICAqLwogICAgYXVkaW86IGZ1bmN0aW9uIChrZXksIHZvbHVtZSwgbG9vcCwgY29ubmVjdCkgewoKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnNvdW5kLmFkZChrZXksIHZvbHVtZSwgbG9vcCwgY29ubmVjdCk7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IFNvdW5kIG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3Rvcnkjc291bmQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBHYW1lLmNhY2hlIGtleSBvZiB0aGUgc291bmQgdGhhdCB0aGlzIG9iamVjdCB3aWxsIHVzZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt2b2x1bWU9MV0gLSBUaGUgdm9sdW1lIGF0IHdoaWNoIHRoZSBzb3VuZCB3aWxsIGJlIHBsYXllZC4KICAgICogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBXaGV0aGVyIG9yIG5vdCB0aGUgc291bmQgd2lsbCBsb29wLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjb25uZWN0PXRydWVdIC0gQ29udHJvbHMgaWYgdGhlIGNyZWF0ZWQgU291bmQgb2JqZWN0IHdpbGwgY29ubmVjdCB0byB0aGUgbWFzdGVyIGdhaW5Ob2RlIG9mIHRoZSBTb3VuZE1hbmFnZXIgd2hlbiBydW5uaW5nIHVuZGVyIFdlYkF1ZGlvLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuU291bmR9IFRoZSBuZXdseSBjcmVhdGVkIHRleHQgb2JqZWN0LgogICAgKi8KICAgIHNvdW5kOiBmdW5jdGlvbiAoa2V5LCB2b2x1bWUsIGxvb3AsIGNvbm5lY3QpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5zb3VuZC5hZGQoa2V5LCB2b2x1bWUsIGxvb3AsIGNvbm5lY3QpOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogQ3JlYXRlcyBhIG5ldyBUaWxlU3ByaXRlIG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjdGlsZVNwcml0ZQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyB0aWxlU3ByaXRlLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyB0aWxlU3ByaXRlLgogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSB0aGUgd2lkdGggb2YgdGhlIHRpbGVzcHJpdGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSB0aGUgaGVpZ2h0IG9mIHRoZSB0aWxlc3ByaXRlLgogICAgKiBAcGFyYW0ge3N0cmluZ3xQaGFzZXIuUmVuZGVyVGV4dHVyZXxQSVhJLlRleHR1cmV9IGtleSAtIFRoaXMgaXMgdGhlIGltYWdlIG9yIHRleHR1cmUgdXNlZCBieSB0aGUgU3ByaXRlIGR1cmluZyByZW5kZXJpbmcuIEl0IGNhbiBiZSBhIHN0cmluZyB3aGljaCBpcyBhIHJlZmVyZW5jZSB0byB0aGUgQ2FjaGUgZW50cnksIG9yIGFuIGluc3RhbmNlIG9mIGEgUmVuZGVyVGV4dHVyZSBvciBQSVhJLlRleHR1cmUuCiAgICAqIEBwYXJhbSB7UGhhc2VyLkdyb3VwfSBbZ3JvdXBdIC0gT3B0aW9uYWwgR3JvdXAgdG8gYWRkIHRoZSBvYmplY3QgdG8uIElmIG5vdCBzcGVjaWZpZWQgaXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgV29ybGQgZ3JvdXAuCiAgICAqIEByZXR1cm4ge1BoYXNlci5UaWxlU3ByaXRlfSBUaGUgbmV3bHkgY3JlYXRlZCB0aWxlU3ByaXRlIG9iamVjdC4KICAgICovCiAgICB0aWxlU3ByaXRlOiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCwga2V5LCBncm91cCkgewoKICAgICAgICBpZiAodHlwZW9mIGdyb3VwID09PSAndW5kZWZpbmVkJykgeyBncm91cCA9IHRoaXMud29ybGQ7IH0KCiAgICAgICAgcmV0dXJuIGdyb3VwLmFkZChuZXcgUGhhc2VyLlRpbGVTcHJpdGUodGhpcy5nYW1lLCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBrZXkpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IFRleHQgb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSN0ZXh0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IHRleHQgb2JqZWN0LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyB0ZXh0IG9iamVjdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgLSBUaGUgYWN0dWFsIHRleHQgdGhhdCB3aWxsIGJlIHdyaXR0ZW4uCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBzdHlsZSAtIFRoZSBzdHlsZSBvYmplY3QgY29udGFpbmluZyBzdHlsZSBhdHRyaWJ1dGVzIGxpa2UgZm9udCwgZm9udCBzaXplICwgZXRjLgogICAgKiBAcGFyYW0ge1BoYXNlci5Hcm91cH0gW2dyb3VwXSAtIE9wdGlvbmFsIEdyb3VwIHRvIGFkZCB0aGUgb2JqZWN0IHRvLiBJZiBub3Qgc3BlY2lmaWVkIGl0IHdpbGwgYmUgYWRkZWQgdG8gdGhlIFdvcmxkIGdyb3VwLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGV4dH0gVGhlIG5ld2x5IGNyZWF0ZWQgdGV4dCBvYmplY3QuCiAgICAqLwogICAgdGV4dDogZnVuY3Rpb24gKHgsIHksIHRleHQsIHN0eWxlLCBncm91cCkgewoKICAgICAgICBpZiAodHlwZW9mIGdyb3VwID09PSAndW5kZWZpbmVkJykgeyBncm91cCA9IHRoaXMud29ybGQ7IH0KCiAgICAgICAgcmV0dXJuIGdyb3VwLmFkZChuZXcgUGhhc2VyLlRleHQodGhpcy5nYW1lLCB4LCB5LCB0ZXh0LCBzdHlsZSkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBuZXcgQnV0dG9uIG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjYnV0dG9uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeF0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IGJ1dHRvbiBvYmplY3QuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeV0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IGJ1dHRvbiBvYmplY3QuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBba2V5XSBUaGUgaW1hZ2Uga2V5IGFzIGRlZmluZWQgaW4gdGhlIEdhbWUuQ2FjaGUgdG8gdXNlIGFzIHRoZSB0ZXh0dXJlIGZvciB0aGlzIGJ1dHRvbi4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoaXMgYnV0dG9uIGlzIHByZXNzZWQKICAgICogQHBhcmFtIHtvYmplY3R9IFtjYWxsYmFja0NvbnRleHRdIFRoZSBjb250ZXh0IGluIHdoaWNoIHRoZSBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCAodXN1YWxseSAndGhpcycpCiAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW292ZXJGcmFtZV0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhbiBvdmVyIHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgogICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtvdXRGcmFtZV0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhbiBvdXQgc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW2Rvd25GcmFtZV0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhIGRvd24gc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW3VwRnJhbWVdIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYW4gdXAgc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiAgICAqIEBwYXJhbSB7UGhhc2VyLkdyb3VwfSBbZ3JvdXBdIC0gT3B0aW9uYWwgR3JvdXAgdG8gYWRkIHRoZSBvYmplY3QgdG8uIElmIG5vdCBzcGVjaWZpZWQgaXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgV29ybGQgZ3JvdXAuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CdXR0b259IFRoZSBuZXdseSBjcmVhdGVkIGJ1dHRvbiBvYmplY3QuCiAgICAqLwogICAgYnV0dG9uOiBmdW5jdGlvbiAoeCwgeSwga2V5LCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVyRnJhbWUsIG91dEZyYW1lLCBkb3duRnJhbWUsIHVwRnJhbWUsIGdyb3VwKSB7CgogICAgICAgIGlmICh0eXBlb2YgZ3JvdXAgPT09ICd1bmRlZmluZWQnKSB7IGdyb3VwID0gdGhpcy53b3JsZDsgfQoKICAgICAgICByZXR1cm4gZ3JvdXAuYWRkKG5ldyBQaGFzZXIuQnV0dG9uKHRoaXMuZ2FtZSwgeCwgeSwga2V5LCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVyRnJhbWUsIG91dEZyYW1lLCBkb3duRnJhbWUsIHVwRnJhbWUpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IEdyYXBoaWNzIG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjZ3JhcGhpY3MKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgZ3JhcGhpY3Mgb2JqZWN0LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyBncmFwaGljcyBvYmplY3QuCiAgICAqIEBwYXJhbSB7UGhhc2VyLkdyb3VwfSBbZ3JvdXBdIC0gT3B0aW9uYWwgR3JvdXAgdG8gYWRkIHRoZSBvYmplY3QgdG8uIElmIG5vdCBzcGVjaWZpZWQgaXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgV29ybGQgZ3JvdXAuCiAgICAqIEByZXR1cm4ge1BoYXNlci5HcmFwaGljc30gVGhlIG5ld2x5IGNyZWF0ZWQgZ3JhcGhpY3Mgb2JqZWN0LgogICAgKi8KICAgIGdyYXBoaWNzOiBmdW5jdGlvbiAoeCwgeSwgZ3JvdXApIHsKCiAgICAgICAgaWYgKHR5cGVvZiBncm91cCA9PT0gJ3VuZGVmaW5lZCcpIHsgZ3JvdXAgPSB0aGlzLndvcmxkOyB9CgogICAgICAgIHJldHVybiBncm91cC5hZGQobmV3IFBoYXNlci5HcmFwaGljcyh0aGlzLmdhbWUsIHgsIHkpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBFbWl0dGVyIGlzIGEgbGlnaHR3ZWlnaHQgcGFydGljbGUgZW1pdHRlci4gSXQgY2FuIGJlIHVzZWQgZm9yIG9uZS10aW1lIGV4cGxvc2lvbnMgb3IgZm9yCiAgICAqIGNvbnRpbnVvdXMgZWZmZWN0cyBsaWtlIHJhaW4gYW5kIGZpcmUuIEFsbCBpdCByZWFsbHkgZG9lcyBpcyBsYXVuY2ggUGFydGljbGUgb2JqZWN0cyBvdXQKICAgICogYXQgc2V0IGludGVydmFscywgYW5kIGZpeGVzIHRoZWlyIHBvc2l0aW9ucyBhbmQgdmVsb2NpdGllcyBhY2NvcmluZGdseS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjZW1pdHRlcgogICAgKiBAcGFyYW0ge251bWJlcn0gW3g9MF0gLSBUaGUgeCBjb29yZGluYXRlIHdpdGhpbiB0aGUgRW1pdHRlciB0aGF0IHRoZSBwYXJ0aWNsZXMgYXJlIGVtaXR0ZWQgZnJvbS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5PTBdIC0gVGhlIHkgY29vcmRpbmF0ZSB3aXRoaW4gdGhlIEVtaXR0ZXIgdGhhdCB0aGUgcGFydGljbGVzIGFyZSBlbWl0dGVkIGZyb20uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWF4UGFydGljbGVzPTUwXSAtIFRoZSB0b3RhbCBudW1iZXIgb2YgcGFydGljbGVzIGluIHRoaXMgZW1pdHRlci4KICAgICogQHJldHVybiB7UGhhc2VyLkVtaXR0ZXJ9IFRoZSBuZXdseSBjcmVhdGVkIGVtaXR0ZXIgb2JqZWN0LgogICAgKi8KICAgIGVtaXR0ZXI6IGZ1bmN0aW9uICh4LCB5LCBtYXhQYXJ0aWNsZXMpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5wYXJ0aWNsZXMuYWRkKG5ldyBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyKHRoaXMuZ2FtZSwgeCwgeSwgbWF4UGFydGljbGVzKSk7CgogICAgfSwKCiAgICAvKioKICAgICogKiBDcmVhdGUgYSBuZXcgQml0bWFwVGV4dCBvYmplY3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2JpdG1hcFRleHQKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgYml0bWFwVGV4dCBvYmplY3QuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IGJpdG1hcFRleHQgb2JqZWN0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCAtIFRoZSBhY3R1YWwgdGV4dCB0aGF0IHdpbGwgYmUgd3JpdHRlbi4KICAgICogQHBhcmFtIHtvYmplY3R9IHN0eWxlIC0gVGhlIHN0eWxlIG9iamVjdCBjb250YWluaW5nIHN0eWxlIGF0dHJpYnV0ZXMgbGlrZSBmb250LCBmb250IHNpemUgLCBldGMuCiAgICAqIEBwYXJhbSB7UGhhc2VyLkdyb3VwfSBbZ3JvdXBdIC0gT3B0aW9uYWwgR3JvdXAgdG8gYWRkIHRoZSBvYmplY3QgdG8uIElmIG5vdCBzcGVjaWZpZWQgaXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgV29ybGQgZ3JvdXAuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBUZXh0fSBUaGUgbmV3bHkgY3JlYXRlZCBiaXRtYXBUZXh0IG9iamVjdC4KICAgICovCiAgICBiaXRtYXBUZXh0OiBmdW5jdGlvbiAoeCwgeSwgdGV4dCwgc3R5bGUsIGdyb3VwKSB7CgogICAgICAgIGlmICh0eXBlb2YgZ3JvdXAgPT09ICd1bmRlZmluZWQnKSB7IGdyb3VwID0gdGhpcy53b3JsZDsgfQoKICAgICAgICByZXR1cm4gdGhpcy53b3JsZC5hZGQobmV3IFBoYXNlci5CaXRtYXBUZXh0KHRoaXMuZ2FtZSwgeCwgeSwgdGV4dCwgc3R5bGUpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IFRpbGVtYXAgb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSN0aWxlbWFwCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSBKU09OIG9yIENTViBtYXAgZGF0YSBpbiB0aGUgY2FjaGUuCiAgICAqIEBwYXJhbSB7b2JqZWN0fHN0cmluZ30gdGlsZXNldHMgLSBBbiBvYmplY3QgbWFwcGluZyBDYWNoZS50aWxlc2V0IGtleXMgd2l0aCB0aGUgdGlsZXNldCBuYW1lcyBpbiB0aGUgSlNPTiBmaWxlLiBJZiBhIHN0cmluZyBpcyBwcm92aWRlZCB0aGF0IHdpbGwgYmUgdXNlZC4KICAgICogQHJldHVybiB7UGhhc2VyLlRpbGVtYXB9IFRoZSBuZXdseSBjcmVhdGVkIHRpbGVtYXAgb2JqZWN0LgogICAgKi8KICAgIHRpbGVtYXA6IGZ1bmN0aW9uIChrZXksIHRpbGVzZXRzKSB7CgogICAgICAgIHJldHVybiBuZXcgUGhhc2VyLlRpbGVtYXAodGhpcy5nYW1lLCBrZXksIHRpbGVzZXRzKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIGR5bmFtaWMgaW5pdGlhbGx5IGJsYW5rIGNhbnZhcyB0byB3aGljaCBpbWFnZXMgY2FuIGJlIGRyYXduLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNyZW5kZXJUZXh0dXJlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSByZW5kZXIgdGV4dHVyZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gdGhlIHdpZHRoIG9mIHRoZSByZW5kZXIgdGV4dHVyZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIHRoZSBoZWlnaHQgb2YgdGhlIHJlbmRlciB0ZXh0dXJlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUmVuZGVyVGV4dHVyZX0gVGhlIG5ld2x5IGNyZWF0ZWQgcmVuZGVyVGV4dHVyZSBvYmplY3QuCiAgICAqLwogICAgcmVuZGVyVGV4dHVyZTogZnVuY3Rpb24gKGtleSwgd2lkdGgsIGhlaWdodCkgewoKICAgICAgICB2YXIgdGV4dHVyZSA9IG5ldyBQaGFzZXIuUmVuZGVyVGV4dHVyZSh0aGlzLmdhbWUsIGtleSwgd2lkdGgsIGhlaWdodCk7CgogICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5hZGRSZW5kZXJUZXh0dXJlKGtleSwgdGV4dHVyZSk7CgogICAgICAgIHJldHVybiB0ZXh0dXJlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEV4cGVyaW1lbnRhbDogQSBCaXRtYXBEYXRhIG9iamVjdCB3aGljaCBjYW4gYmUgbWFuaXB1bGF0ZWQgYW5kIGRyYXduIHRvIGxpa2UgYSB0cmFkaXRpb25hbCBDYW52YXMgb2JqZWN0IGFuZCB1c2VkIHRvIHRleHR1cmUgU3ByaXRlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjYml0bWFwRGF0YQogICAgKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoPTI1Nl0gLSBUaGUgd2lkdGggb2YgdGhlIEJpdG1hcERhdGEgaW4gcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodD0yNTZdIC0gVGhlIGhlaWdodCBvZiB0aGUgQml0bWFwRGF0YSBpbiBwaXhlbHMuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgbmV3bHkgY3JlYXRlZCBCaXRtYXBEYXRhIG9iamVjdC4KICAgICovCiAgICBiaXRtYXBEYXRhOiBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewoKICAgICAgICByZXR1cm4gbmV3IFBoYXNlci5CaXRtYXBEYXRhKHRoaXMuZ2FtZSwgd2lkdGgsIGhlaWdodCk7CgogICAgfSwKCiAgICAvKioKICAgICogQSBXZWJHTCBzaGFkZXIvZmlsdGVyIHRoYXQgY2FuIGJlIGFwcGxpZWQgdG8gU3ByaXRlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjZmlsdGVyCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBmaWx0ZXIgLSBUaGUgbmFtZSBvZiB0aGUgZmlsdGVyIHlvdSB3aXNoIHRvIGNyZWF0ZSwgZm9yIGV4YW1wbGUgSHVlUm90YXRlIG9yIFNpbmVXYXZlLgogICAgKiBAcGFyYW0ge2FueX0gLSBXaGF0ZXZlciBwYXJhbWV0ZXJzIGFyZSBuZWVkZWQgdG8gYmUgcGFzc2VkIHRvIHRoZSBmaWx0ZXIgaW5pdCBmdW5jdGlvbi4KICAgICogQHJldHVybiB7UGhhc2VyLkZpbHRlcn0gVGhlIG5ld2x5IGNyZWF0ZWQgUGhhc2VyLkZpbHRlciBvYmplY3QuCiAgICAqLwogICAgZmlsdGVyOiBmdW5jdGlvbiAoZmlsdGVyKSB7CgogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgogICAgICAgIHZhciBmaWx0ZXIgPSBuZXcgUGhhc2VyLkZpbHRlcltmaWx0ZXJdKHRoaXMuZ2FtZSk7CgogICAgICAgIGZpbHRlci5pbml0LmFwcGx5KGZpbHRlciwgYXJncyk7CgogICAgICAgIHJldHVybiBmaWx0ZXI7CgogICAgfQoKfTsKClBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuR2FtZU9iamVjdEZhY3Rvcnk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGVzIGEgbmV3IEJpdG1hcERhdGEgb2JqZWN0LgoqCiogQGNsYXNzIFBoYXNlci5CaXRtYXBEYXRhCioKKiBAY2xhc3NkZXNjIE5vdGU6IFRoaXMgb2JqZWN0IGlzIHN0aWxsIGV4cGVyaW1lbnRhbCBhbmQgbGlrZWx5IHRvIGNoYW5nZS4KKgoqIEEgQml0bWFwRGF0YSBvYmplY3QgY2FuIGJlIHRob3VnaHQgb2YgYXMgYSBibGFuayBjYW52YXMgb250byB3aGljaCB5b3UgY2FuIHBlcmZvcm0gZ3JhcGhpY3Mgb3BlcmF0aW9ucyBhcyB5b3Ugd291bGQgb24gYSBub3JtYWwgY2FudmFzLCAKKiBzdWNoIGFzIGRyYXdpbmcgbGluZXMsIGNpcmNsZXMsIGFyY3MsIGZpbGxzIGFuZCBjb3B5aW5nIGFuZCBzZXR0aW5nIGJsb2NrcyBvZiBwaXhlbCBkYXRhLiBBIHNpbmdsZSBCaXRtYXBEYXRhIGNhbiBiZSB1c2VkIGFzIHRoZSB0ZXh0dXJlIAoqIGZvciBtdWx0aXBsZSBTcHJpdGVzLiBTbyBpZiB5b3UgbmVlZCB0byBkeW5hbWljYWxseSBjcmVhdGUgYSBTcHJpdGUgdGV4dHVyZSB0aGVuIHRoZXkgYXJlIGEgZ29vZCBjaG9pY2UuIEl0IHN1cHBvcnRzIHRoZSBFYXNlbEpTIFRpbnkgQVBJLgoqCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGg9MjU2XSAtIFRoZSB3aWR0aCBvZiB0aGUgQml0bWFwRGF0YSBpbiBwaXhlbHMuCiogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHQ9MjU2XSAtIFRoZSBoZWlnaHQgb2YgdGhlIEJpdG1hcERhdGEgaW4gcGl4ZWxzLgoqLwpQaGFzZXIuQml0bWFwRGF0YSA9IGZ1bmN0aW9uIChnYW1lLCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgaWYgKHR5cGVvZiB3aWR0aCA9PT0gJ3VuZGVmaW5lZCcpIHsgd2lkdGggPSAyNTY7IH0KICAgIGlmICh0eXBlb2YgaGVpZ2h0ID09PSAndW5kZWZpbmVkJykgeyBoZWlnaHQgPSAyNTY7IH0KCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLiAKICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBCaXRtYXBEYXRhLgogICAgKi8KICAgIHRoaXMubmFtZSA9ICcnOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIEJpdG1hcERhdGEgaW4gcGl4ZWxzLgogICAgKi8KICAgIHRoaXMud2lkdGggPSB3aWR0aDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBCaXRtYXBEYXRhIGluIHBpeGVscy4KICAgICovCiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gVGhlIGNhbnZhcyB0byB3aGljaCB0aGlzIEJpdG1hcERhdGEgZHJhd3MuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jYW52YXMgPSBQaGFzZXIuQ2FudmFzLmNyZWF0ZSh3aWR0aCwgaGVpZ2h0KTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBjb250ZXh0IC0gVGhlIDJkIGNvbnRleHQgb2YgdGhlIGNhbnZhcy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNvbnRleHQgPSB0aGlzLmNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBpbWFnZURhdGEgLSBUaGUgY2FudmFzIGltYWdlIGRhdGEuCiAgICAqLwogICAgdGhpcy5pbWFnZURhdGEgPSB0aGlzLmNvbnRleHQuZ2V0SW1hZ2VEYXRhKDAsIDAsIHdpZHRoLCBoZWlnaHQpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1VJbnQ4Q2xhbXBlZH0gcGl4ZWxzIC0gQSByZWZlcmVuY2UgdG8gdGhlIGNvbnRleHQgaW1hZ2VEYXRhIGJ1ZmZlci4KICAgICovCiAgICBpZiAodGhpcy5pbWFnZURhdGEuZGF0YS5idWZmZXIpCiAgICB7CiAgICAgICAgdGhpcy5waXhlbHMgPSB0aGlzLmltYWdlRGF0YS5kYXRhLmJ1ZmZlcjsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLnBpeGVscyA9IHRoaXMuaW1hZ2VEYXRhLmRhdGE7CiAgICB9CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UElYSS5CYXNlVGV4dHVyZX0gYmFzZVRleHR1cmUgLSBUaGUgUElYSS5CYXNlVGV4dHVyZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmJhc2VUZXh0dXJlID0gbmV3IFBJWEkuQmFzZVRleHR1cmUodGhpcy5jYW52YXMpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQSVhJLlRleHR1cmV9IHRleHR1cmUgLSBUaGUgUElYSS5UZXh0dXJlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGV4dHVyZSA9IG5ldyBQSVhJLlRleHR1cmUodGhpcy5iYXNlVGV4dHVyZSk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5GcmFtZX0gdGV4dHVyZUZyYW1lIC0gVGhlIEZyYW1lIHRoaXMgQml0bWFwRGF0YSB1c2VzIGZvciByZW5kZXJpbmcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50ZXh0dXJlRnJhbWUgPSBuZXcgUGhhc2VyLkZyYW1lKDAsIDAsIDAsIHdpZHRoLCBoZWlnaHQsICdiaXRtYXBEYXRhJywgZ2FtZS5ybmQudXVpZCgpKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBUaGUgY29uc3QgdHlwZSBvZiB0aGlzIG9iamVjdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuQklUTUFQREFUQTsKCiAgICB0aGlzLl9kaXJ0eSA9IGZhbHNlOwoKfQoKUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBVcGRhdGVzIHRoZSBnaXZlbiBTcHJpdGUgc28gdGhhdCBpdCB1c2VzIHRoaXMgQml0bWFwRGF0YSBhcyBpdHMgdGV4dHVyZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNhZGQKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBUaGUgc3ByaXRlIHRvIGFwcGx5IHRoaXMgdGV4dHVyZSB0by4KICAgICovCiAgICBhZGQ6IGZ1bmN0aW9uIChzcHJpdGUpIHsKCiAgICAgICAgc3ByaXRlLmxvYWRUZXh0dXJlKHRoaXMpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdpdmVuIGFuIGFycmF5IG9mIFNwcml0ZXMgaXQgd2lsbCB1cGRhdGUgZWFjaCBvZiB0aGVtIHNvIHRoYXQgdGhlaXIgVGV4dHVyZXMgcmVmZXJlbmNlIHRoaXMgQml0bWFwRGF0YS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNhZGRUbwogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGVbXX0gc3ByaXRlcyAtIEFuIGFycmF5IG9mIFNwcml0ZXMgdG8gYXBwbHkgdGhpcyB0ZXh0dXJlIHRvLgogICAgKi8KICAgIGFkZFRvOiBmdW5jdGlvbiAoc3ByaXRlcykgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNwcml0ZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAoc3ByaXRlc1tpXS50ZXh0dXJlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzcHJpdGVzW2ldLmxvYWRUZXh0dXJlKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENsZWFycyB0aGUgQml0bWFwRGF0YS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNjbGVhcgogICAgKi8KICAgIGNsZWFyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuY29udGV4dC5jbGVhclJlY3QoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwogICAgCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwoKICAgIH0sCgogICAgcmVmcmVzaEJ1ZmZlcjogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmltYWdlRGF0YSA9IHRoaXMuY29udGV4dC5nZXRJbWFnZURhdGEoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwogICAgICAgIHRoaXMucGl4ZWxzID0gbmV3IEludDMyQXJyYXkodGhpcy5pbWFnZURhdGEuZGF0YS5idWZmZXIpOwoKICAgICAgICAvLyB0aGlzLmRhdGE4ID0gbmV3IFVpbnQ4Q2xhbXBlZEFycmF5KHRoaXMuaW1hZ2VEYXRhLmJ1ZmZlcik7CiAgICAgICAgLy8gdGhpcy5kYXRhMzIgPSBuZXcgVWludDMyQXJyYXkodGhpcy5pbWFnZURhdGEuYnVmZmVyKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBjb2xvciBvZiB0aGUgZ2l2ZW4gcGl4ZWwgdG8gdGhlIHNwZWNpZmllZCByZWQsIGdyZWVuLCBibHVlIGFuZCBhbHBoYSB2YWx1ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjc2V0UGl4ZWwzMgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBYIGNvb3JkaW5hdGUgb2YgdGhlIHBpeGVsIHRvIGJlIHNldC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgWSBjb29yZGluYXRlIG9mIHRoZSBwaXhlbCB0byBiZSBzZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByZWQgLSBUaGUgcmVkIGNvbG9yIHZhbHVlLCBiZXR3ZWVuIDAgYW5kIDB4RkYgKDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBncmVlbiAtIFRoZSBncmVlbiBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gYmx1ZSAtIFRoZSBibHVlIGNvbG9yIHZhbHVlLCBiZXR3ZWVuIDAgYW5kIDB4RkYgKDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBhbHBoYSBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKi8KICAgIHNldFBpeGVsMzI6IGZ1bmN0aW9uICh4LCB5LCByZWQsIGdyZWVuLCBibHVlLCBhbHBoYSkgewoKICAgICAgICBpZiAoeCA+PSAwICYmIHggPD0gdGhpcy53aWR0aCAmJiB5ID49IDAgJiYgeSA8PSB0aGlzLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucGl4ZWxzW3kgKiB0aGlzLndpZHRoICsgeF0gPSAoYWxwaGEgPDwgMjQpIHwgKGJsdWUgPDwgMTYpIHwgKGdyZWVuIDw8IDgpIHwgcmVkOwoKICAgICAgICAgICAgLyoKICAgICAgICAgICAgaWYgKHRoaXMuaXNMaXR0bGVFbmRpYW4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZGF0YTMyW3kgKiB0aGlzLndpZHRoICsgeF0gPSAoYWxwaGEgPDwgMjQpIHwgKGJsdWUgPDwgMTYpIHwgKGdyZWVuIDw8IDgpIHwgcmVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5kYXRhMzJbeSAqIHRoaXMud2lkdGggKyB4XSA9IChyZWQgPDwgMjQpIHwgKGdyZWVuIDw8IDE2KSB8IChibHVlIDw8IDgpIHwgYWxwaGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAqLwoKICAgICAgICAgICAgLy8gdGhpcy5pbWFnZURhdGEuZGF0YS5zZXQodGhpcy5kYXRhOCk7CgogICAgICAgICAgICB0aGlzLmNvbnRleHQucHV0SW1hZ2VEYXRhKHRoaXMuaW1hZ2VEYXRhLCAwLCAwKTsKCiAgICAgICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgY29sb3Igb2YgdGhlIGdpdmVuIHBpeGVsIHRvIHRoZSBzcGVjaWZpZWQgcmVkLCBncmVlbiBhbmQgYmx1ZSB2YWx1ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjc2V0UGl4ZWwKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgWCBjb29yZGluYXRlIG9mIHRoZSBwaXhlbCB0byBiZSBzZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIFkgY29vcmRpbmF0ZSBvZiB0aGUgcGl4ZWwgdG8gYmUgc2V0LgogICAgKiBAcGFyYW0ge251bWJlcn0gcmVkIC0gVGhlIHJlZCBjb2xvciB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBncmVlbiAtIFRoZSBncmVlbiBjb2xvciB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBibHVlIC0gVGhlIGJsdWUgY29sb3IgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KQogICAgKi8KICAgIHNldFBpeGVsOiBmdW5jdGlvbiAoeCwgeSwgcmVkLCBncmVlbiwgYmx1ZSkgewoKICAgICAgICB0aGlzLnNldFBpeGVsMzIoeCwgeSwgcmVkLCBncmVlbiwgYmx1ZSwgMjU1KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgYSBjb2xvciBvZiBhIHNwZWNpZmljIHBpeGVsLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBYIGNvb3JkaW5hdGUgb2YgdGhlIHBpeGVsIHRvIGdldC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgWSBjb29yZGluYXRlIG9mIHRoZSBwaXhlbCB0byBnZXQuCiAgICAqIEByZXR1cm4ge251bWJlcn0gQSBuYXRpdmUgY29sb3IgdmFsdWUgaW50ZWdlciAoZm9ybWF0OiAweFJSR0dCQikKICAgICovCiAgICBnZXRQaXhlbDogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgaWYgKHggPj0gMCAmJiB4IDw9IHRoaXMud2lkdGggJiYgeSA+PSAwICYmIHkgPD0gdGhpcy5oZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhMzJbeSAqIHRoaXMud2lkdGggKyB4XTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgY29sb3Igb2YgYSBzcGVjaWZpYyBwaXhlbCAoaW5jbHVkaW5nIGFscGhhIHZhbHVlKS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgWCBjb29yZGluYXRlIG9mIHRoZSBwaXhlbCB0byBnZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIFkgY29vcmRpbmF0ZSBvZiB0aGUgcGl4ZWwgdG8gZ2V0LgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IEEgbmF0aXZlIGNvbG9yIHZhbHVlIGludGVnZXIgKGZvcm1hdDogMHhBQVJSR0dCQikKICAgICovCiAgICBnZXRQaXhlbDMyOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICBpZiAoeCA+PSAwICYmIHggPD0gdGhpcy53aWR0aCAmJiB5ID49IDAgJiYgeSA8PSB0aGlzLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmRhdGEzMlt5ICogdGhpcy53aWR0aCArIHhdOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgcGl4ZWxzIGluIGFycmF5IGluIGEgc3BlY2lmaWMgUmVjdGFuZ2xlLgogICAgKiBAcGFyYW0gcmVjdCB7UmVjdGFuZ2xlfSBUaGUgc3BlY2lmaWMgUmVjdGFuZ2xlLgogICAgKiBAcmV0dXJuIHthcnJheX0gQ2FudmFzUGl4ZWxBcnJheS4KICAgICovCiAgICBnZXRQaXhlbHM6IGZ1bmN0aW9uIChyZWN0KSB7CgogICAgICAgIHJldHVybiB0aGlzLmNvbnRleHQuZ2V0SW1hZ2VEYXRhKHJlY3QueCwgcmVjdC55LCByZWN0LndpZHRoLCByZWN0LmhlaWdodCk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyBhbiBhcmMgdG8gdGhlIHBhdGggd2hpY2ggaXMgY2VudGVyZWQgYXQgKHgsIHkpIHBvc2l0aW9uIHdpdGggcmFkaXVzIHIgc3RhcnRpbmcgYXQgc3RhcnRBbmdsZSBhbmQgZW5kaW5nIGF0IGVuZEFuZ2xlIAogICAgKiBnb2luZyBpbiB0aGUgZ2l2ZW4gZGlyZWN0aW9uIGJ5IGFudGljbG9ja3dpc2UgKGRlZmF1bHRpbmcgdG8gY2xvY2t3aXNlKS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNhcmMKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgYXJjJ3MgY2VudGVyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIGFyYydzIGNlbnRlcgogICAgKiBAcGFyYW0ge251bWJlcn0gcmFkaXVzIC0gVGhlIGFyYydzIHJhZGl1cwogICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnRBbmdsZSAtIFRoZSBzdGFydGluZyBwb2ludCwgbWVhc3VyZWQgZnJvbSB0aGUgeCBheGlzLCBmcm9tIHdoaWNoIGl0IHdpbGwgYmUgZHJhd24sIGV4cHJlc3NlZCBpbiByYWRpYW5zLgogICAgKiBAcGFyYW0ge251bWJlcn0gZW5kQW5nbGUgLSBUaGUgZW5kIGFyYydzIGFuZ2xlIHRvIHdoaWNoIGl0IHdpbGwgYmUgZHJhd24sIGV4cHJlc3NlZCBpbiByYWRpYW5zLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFthbnRpY2xvY2t3aXNlPXRydWVdIC0gdHJ1ZSBkcmF3cyB0aGUgYXJjIGFudGljbG9ja3dpc2UsIG90aGVyd2lzZSBpbiBhIGNsb2Nrd2lzZSBkaXJlY3Rpb24uCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGFyYzogZnVuY3Rpb24gKHgsIHksIHJhZGl1cywgc3RhcnRBbmdsZSwgZW5kQW5nbGUsIGFudGljbG9ja3dpc2UpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBhbnRpY2xvY2t3aXNlID09PSAndW5kZWZpbmVkJykgeyBhbnRpY2xvY2t3aXNlID0gZmFsc2U7IH0KCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY29udGV4dC5hcmMoeCwgeSwgcmFkaXVzLCBzdGFydEFuZ2xlLCBlbmRBbmdsZSwgYW50aWNsb2Nrd2lzZSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyBhbiBhcmMgd2l0aCB0aGUgZ2l2ZW4gY29udHJvbCBwb2ludHMgYW5kIHJhZGl1cywgY29ubmVjdGVkIHRvIHRoZSBwcmV2aW91cyBwb2ludCBieSBhIHN0cmFpZ2h0IGxpbmUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjYXJjVG8KICAgICogQHBhcmFtIHtudW1iZXJ9IHgxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MQogICAgKiBAcGFyYW0ge251bWJlcn0geDIKICAgICogQHBhcmFtIHtudW1iZXJ9IHkyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByYWRpdXMKICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgYXJjVG86IGZ1bmN0aW9uICh4MSwgeTEsIHgyLCB5MiwgcmFkaXVzKSB7CgogICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNvbnRleHQuYXJjVG8oeDEsIHkxLCB4MiwgeTIsIHJhZGl1cyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQmVnaW5zIGEgZmlsbCB3aXRoIHRoZSBzcGVjaWZpZWQgY29sb3IuIFRoaXMgZW5kcyB0aGUgY3VycmVudCBzdWItcGF0aC4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNiZWdpbkZpbGwKICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbG9yIC0gQSBDU1MgY29tcGF0aWJsZSBjb2xvciB2YWx1ZSAoZXguICJyZWQiLCAiI0ZGMDAwMCIsIG9yICJyZ2JhKDI1NSwwLDAsMC41KSIpLiBTZXR0aW5nIHRvIG51bGwgd2lsbCByZXN1bHQgaW4gbm8gZmlsbC4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgYmVnaW5GaWxsOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdGhpcy5maWxsU3R5bGUoY29sb3IpOwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBCZWdpbnMgYSBsaW5lYXIgZ3JhZGllbnQgZmlsbCBkZWZpbmVkIGJ5IHRoZSBsaW5lICh4MCwgeTApIHRvICh4MSwgeTEpLiBUaGlzIGVuZHMgdGhlIGN1cnJlbnQgc3ViLXBhdGguIEZvcgogICAgKiBleGFtcGxlLCB0aGUgZm9sbG93aW5nIGNvZGUgZGVmaW5lcyBhIGJsYWNrIHRvIHdoaXRlIHZlcnRpY2FsIGdyYWRpZW50IHJhbmdpbmcgZnJvbSAyMHB4IHRvIDEyMHB4LCBhbmQgZHJhd3MgYSBzcXVhcmUgdG8gZGlzcGxheSBpdDoKICAgICoKICAgICogICAgICBgYGBteUdyYXBoaWNzLmJlZ2luTGluZWFyR3JhZGllbnRGaWxsKFsiIzAwMCIsIiNGRkYiXSwgWzAsIDFdLCAwLCAyMCwgMCwgMTIwKS5yZWN0KDIwLCAyMCwgMTIwLCAxMjApO2BgYAogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2JlZ2luTGluZWFyR3JhZGllbnRGaWxsCiAgICAqIEBwYXJhbSB7QXJyYXl9IGNvbG9ycyAtIEFuIGFycmF5IG9mIENTUyBjb21wYXRpYmxlIGNvbG9yIHZhbHVlcy4gRm9yIGV4YW1wbGUsIFsiI0YwMCIsIiMwMEYiXSB3b3VsZCBkZWZpbmUgYSBncmFkaWVudCBkcmF3aW5nIGZyb20gcmVkIHRvIGJsdWUuCiAgICAqIEBwYXJhbSB7QXJyYXl9IHJhdGlvcyAtIEFuIGFycmF5IG9mIGdyYWRpZW50IHBvc2l0aW9ucyB3aGljaCBjb3JyZXNwb25kIHRvIHRoZSBjb2xvcnMuIEZvciBleGFtcGxlLCBbMC4xLCAwLjldIHdvdWxkIGRyYXcgdGhlIGZpcnN0IGNvbG9yIHRvIDEwJSB0aGVuIGludGVycG9sYXRpbmcgdG8gdGhlIHNlY29uZCBjb2xvciBhdCA5MCUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MCAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgcG9pbnQgZGVmaW5pbmcgdGhlIGxpbmUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudCBkaXJlY3Rpb24gYW5kIHNpemUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MCAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgcG9pbnQgZGVmaW5pbmcgdGhlIGxpbmUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudCBkaXJlY3Rpb24gYW5kIHNpemUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MSAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgc2Vjb25kIHBvaW50IGRlZmluaW5nIHRoZSBsaW5lIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQgZGlyZWN0aW9uIGFuZCBzaXplLgogICAgKiBAcGFyYW0ge251bWJlcn0geTEgLSBUaGUgcG9zaXRpb24gb2YgdGhlIHNlY29uZCBwb2ludCBkZWZpbmluZyB0aGUgbGluZSB0aGF0IGRlZmluZXMgdGhlIGdyYWRpZW50IGRpcmVjdGlvbiBhbmQgc2l6ZS4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgYmVnaW5MaW5lYXJHcmFkaWVudEZpbGw6IGZ1bmN0aW9uIChjb2xvcnMsIHJhdGlvcywgeDAsIHkwLCB4MSwgeTEpIHsKCiAgICAgICAgdmFyIGdyYWRpZW50ID0gdGhpcy5jcmVhdGVMaW5lYXJHcmFkaWVudCh4MCwgeTAsIHgxLCB5MSk7CgogICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBjb2xvcnMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBncmFkaWVudC5hZGRDb2xvclN0b3AocmF0aW9zW2ldLCBjb2xvcnNbaV0pOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5maWxsU3R5bGUoZ3JhZGllbnQpOwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBCZWdpbnMgYSBsaW5lYXIgZ3JhZGllbnQgc3Ryb2tlIGRlZmluZWQgYnkgdGhlIGxpbmUgKHgwLCB5MCkgdG8gKHgxLCB5MSkuIFRoaXMgZW5kcyB0aGUgY3VycmVudCBzdWItcGF0aC4gRm9yCiAgICAqIGV4YW1wbGUsIHRoZSBmb2xsb3dpbmcgY29kZSBkZWZpbmVzIGEgYmxhY2sgdG8gd2hpdGUgdmVydGljYWwgZ3JhZGllbnQgcmFuZ2luZyBmcm9tIDIwcHggdG8gMTIwcHgsIGFuZCBkcmF3cyBhCiAgICAqIHNxdWFyZSB0byBkaXNwbGF5IGl0OgogICAgKgogICAgKiAgICAgIGBgYG15R3JhcGhpY3Muc2V0U3Ryb2tlU3R5bGUoMTApLmJlZ2luTGluZWFyR3JhZGllbnRTdHJva2UoWyIjMDAwIiwiI0ZGRiJdLCBbMCwgMV0sIDAsIDIwLCAwLCAxMjApLmRyYXdSZWN0KDIwLCAyMCwgMTIwLCAxMjApO2BgYAogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2JlZ2luTGluZWFyR3JhZGllbnRTdHJva2UKICAgICogQHBhcmFtIHtBcnJheX0gY29sb3JzIC0gQW4gYXJyYXkgb2YgQ1NTIGNvbXBhdGlibGUgY29sb3IgdmFsdWVzLiBGb3IgZXhhbXBsZSwgWyIjRjAwIiwiIzAwRiJdIHdvdWxkIGRlZmluZSBhIGdyYWRpZW50IGRyYXdpbmcgZnJvbSByZWQgdG8gYmx1ZS4KICAgICogQHBhcmFtIHtBcnJheX0gcmF0aW9zIC0gQW4gYXJyYXkgb2YgZ3JhZGllbnQgcG9zaXRpb25zIHdoaWNoIGNvcnJlc3BvbmQgdG8gdGhlIGNvbG9ycy4gRm9yIGV4YW1wbGUsIFswLjEsIDAuOV0gd291bGQgZHJhdyB0aGUgZmlyc3QgY29sb3IgdG8gMTAlIHRoZW4gaW50ZXJwb2xhdGluZyB0byB0aGUgc2Vjb25kIGNvbG9yIGF0IDkwJS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHgwIC0gVGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBwb2ludCBkZWZpbmluZyB0aGUgbGluZSB0aGF0IGRlZmluZXMgdGhlIGdyYWRpZW50IGRpcmVjdGlvbiBhbmQgc2l6ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkwIC0gVGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBwb2ludCBkZWZpbmluZyB0aGUgbGluZSB0aGF0IGRlZmluZXMgdGhlIGdyYWRpZW50IGRpcmVjdGlvbiBhbmQgc2l6ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHgxIC0gVGhlIHBvc2l0aW9uIG9mIHRoZSBzZWNvbmQgcG9pbnQgZGVmaW5pbmcgdGhlIGxpbmUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudCBkaXJlY3Rpb24gYW5kIHNpemUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MSAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgc2Vjb25kIHBvaW50IGRlZmluaW5nIHRoZSBsaW5lIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQgZGlyZWN0aW9uIGFuZCBzaXplLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBiZWdpbkxpbmVhckdyYWRpZW50U3Ryb2tlOiBmdW5jdGlvbiAoY29sb3JzLCByYXRpb3MsIHgwLCB5MCwgeDEsIHkxKSB7CgogICAgICAgIHZhciBncmFkaWVudCA9IHRoaXMuY3JlYXRlTGluZWFyR3JhZGllbnQoeDAsIHkwLCB4MSwgeTEpOwoKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gY29sb3JzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKHJhdGlvc1tpXSwgY29sb3JzW2ldKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3Ryb2tlU3R5bGUoZ3JhZGllbnQpOwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBCZWdpbnMgYSByYWRpYWwgZ3JhZGllbnQgc3Ryb2tlLiBUaGlzIGVuZHMgdGhlIGN1cnJlbnQgc3ViLXBhdGguIEZvciBleGFtcGxlLCB0aGUgZm9sbG93aW5nIGNvZGUgZGVmaW5lcyBhIHJlZCB0bwogICAgKiBibHVlIHJhZGlhbCBncmFkaWVudCBjZW50ZXJlZCBhdCAoMTAwLCAxMDApLCB3aXRoIGEgcmFkaXVzIG9mIDUwLCBhbmQgZHJhd3MgYSByZWN0YW5nbGUgdG8gZGlzcGxheSBpdDoKICAgICoKICAgICogICAgICBteUdyYXBoaWNzLnNldFN0cm9rZVN0eWxlKDEwKQogICAgKiAgICAgICAgICAuYmVnaW5SYWRpYWxHcmFkaWVudFN0cm9rZShbIiNGMDAiLCIjMDBGIl0sIFswLCAxXSwgMTAwLCAxMDAsIDAsIDEwMCwgMTAwLCA1MCkKICAgICogICAgICAgICAgLmRyYXdSZWN0KDUwLCA5MCwgMTUwLCAxMTApOwogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2JlZ2luUmFkaWFsR3JhZGllbnRTdHJva2UKICAgICogQHBhcmFtIHtBcnJheX0gY29sb3JzIC0gQW4gYXJyYXkgb2YgQ1NTIGNvbXBhdGlibGUgY29sb3IgdmFsdWVzLiBGb3IgZXhhbXBsZSwgWyIjRjAwIiwiIzAwRiJdIHdvdWxkIGRlZmluZSBhIGdyYWRpZW50IGRyYXdpbmcgZnJvbSByZWQgdG8gYmx1ZS4KICAgICogQHBhcmFtIHtBcnJheX0gcmF0aW9zIC0gQW4gYXJyYXkgb2YgZ3JhZGllbnQgcG9zaXRpb25zIHdoaWNoIGNvcnJlc3BvbmQgdG8gdGhlIGNvbG9ycy4gRm9yIGV4YW1wbGUsIFswLjEsIDAuOV0gd291bGQgZHJhdyB0aGUgZmlyc3QgY29sb3IgdG8gMTAlIHRoZW4gaW50ZXJwb2xhdGluZyB0byB0aGUgc2Vjb25kIGNvbG9yIGF0IDkwJS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHgwIC0gQ2VudGVyIHBvc2l0aW9uIG9mIHRoZSBpbm5lciBjaXJjbGUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkwIC0gQ2VudGVyIHBvc2l0aW9uIG9mIHRoZSBpbm5lciBjaXJjbGUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHIwIC0gUmFkaXVzIG9mIHRoZSBpbm5lciBjaXJjbGUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHgxIC0gQ2VudGVyIHBvc2l0aW9uIG9mIHRoZSBvdXRlciBjaXJjbGUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkxIC0gQ2VudGVyIHBvc2l0aW9uIG9mIHRoZSBvdXRlciBjaXJjbGUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHIxIC0gUmFkaXVzIG9mIHRoZSBvdXRlciBjaXJjbGUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudC4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgYmVnaW5SYWRpYWxHcmFkaWVudFN0cm9rZTogZnVuY3Rpb24gKGNvbG9ycywgcmF0aW9zLCB4MCwgeTAsIHIwLCB4MSwgeTEsIHIxKSB7CgogICAgICAgIHZhciBncmFkaWVudCA9IHRoaXMuY3JlYXRlUmFkaWFsR3JhZGllbnQoeDAsIHkwLCByMCwgeDEsIHkxLCByMSk7CgogICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBjb2xvcnMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBncmFkaWVudC5hZGRDb2xvclN0b3AocmF0aW9zW2ldLCBjb2xvcnNbaV0pOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdHJva2VTdHlsZShncmFkaWVudCk7CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0YXJ0cyBhIG5ldyBwYXRoIGJ5IHJlc2V0dGluZyB0aGUgbGlzdCBvZiBzdWItcGF0aHMuIENhbGwgdGhpcyBtZXRob2Qgd2hlbiB5b3Ugd2FudCB0byBjcmVhdGUgYSBuZXcgcGF0aC4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNiZWdpblBhdGgKICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgYmVnaW5QYXRoOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBCZWdpbnMgYSBzdHJva2Ugd2l0aCB0aGUgc3BlY2lmaWVkIGNvbG9yLiBUaGlzIGVuZHMgdGhlIGN1cnJlbnQgc3ViLXBhdGguCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjYmVnaW5TdHJva2UKICAgICogQHBhcmFtIHtTdHJpbmd9IGNvbG9yIEEgQ1NTIGNvbXBhdGlibGUgY29sb3IgdmFsdWUgKGV4LiAiI0ZGMDAwMCIsICJyZWQiLCBvciAicmdiYSgyNTUsMCwwLDAuNSkiKS4gU2V0dGluZyB0byBudWxsIHdpbGwgcmVzdWx0IGluIG5vIHN0cm9rZS4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgYmVnaW5TdHJva2U6IGZ1bmN0aW9uIChjb2xvcikgewoKICAgICAgICB0aGlzLnN0cm9rZVN0eWxlKGNvbG9yKTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIGEgYmV6aWVyIGN1cnZlIGZyb20gdGhlIGN1cnJlbnQgY29udGV4dCBwb2ludCB0byAoeCwgeSkgdXNpbmcgdGhlIGNvbnRyb2wgcG9pbnRzIChjcDF4LCBjcDF5KSBhbmQgKGNwMngsIGNwMnkpLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2JlemllckN1cnZlVG8KICAgICogQHBhcmFtIHtudW1iZXJ9IGNwMXggLSBUaGUgeCBheGlzIG9mIGNvbnRyb2wgcG9pbnQgMS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGNwMXkgLSBUaGUgeSBheGlzIG9mIGNvbnRyb2wgcG9pbnQgMS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGNwMnggLSBUaGUgeCBheGlzIG9mIGNvbnRyb2wgcG9pbnQgMi4KICAgICogQHBhcmFtIHtudW1iZXJ9IGNwMnkgLSBUaGUgeSBheGlzIG9mIGNvbnRyb2wgcG9pbnQgMi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBlbmRpbmcgcG9pbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgZW5kaW5nIHBvaW50LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBiZXppZXJDdXJ2ZVRvOiBmdW5jdGlvbiAoY3AxeCwgY3AxeSwgY3AyeCwgY3AyeSwgeCwgeSkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LmJlemllckN1cnZlVG8oY3AxeCwgY3AxeSwgY3AyeCwgY3AyeSwgeCwgeSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogRHJhd3MgYSBjaXJjbGUgd2l0aCB0aGUgc3BlY2lmaWVkIHJhZGl1cyBhdCAoeCwgeSkuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjY2lyY2xlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0geCBjb29yZGluYXRlIGNlbnRlciBwb2ludCBvZiBjaXJjbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0geSBjb29yZGluYXRlIGNlbnRlciBwb2ludCBvZiBjaXJjbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByYWRpdXMgLSBSYWRpdXMgb2YgY2lyY2xlIGluIHJhZGlhbnMuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGNpcmNsZTogZnVuY3Rpb24gKHgsIHksIHJhZGl1cykgewoKICAgICAgICB0aGlzLmFyYyh4LCB5LCByYWRpdXMsIDAsIE1hdGguUEkqMik7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyBhbGwgcGl4ZWxzIGluIHRoZSByZWN0YW5nbGUgZGVmaW5lZCBieSBzdGFydGluZyBwb2ludCAoeCwgeSkgYW5kIHNpemUgKHdpZHRoLCBoZWlnaHQpIHRvIHRyYW5zcGFyZW50IGJsYWNrLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2NsZWFyUmVjdAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSByZWN0YW5nbGUgc3RhcnRpbmcgcG9pbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIHJlY3RhbmdsZSBzdGFydGluZyBwb2ludC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHJlY3RhbmdsZXMgd2lkdGguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgcmVjdGFuZ2xlcyBoZWlnaHQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGNsZWFyUmVjdDogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY29udGV4dC5jbGVhclJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQ3JlYXRlcyBhIGNsaXBwaW5nIHBhdGggZnJvbSB0aGUgY3VycmVudCBzdWItcGF0aHMuIEV2ZXJ5dGhpbmcgZHJhd24gYWZ0ZXIgY2xpcCgpIGlzIGNhbGxlZCBhcHBlYXJzIGluc2lkZSB0aGUgY2xpcHBpbmcgcGF0aCBvbmx5LgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2NsaXAKICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgY2xpcDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LmNsaXAoKTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUcmllcyB0byBkcmF3IGEgc3RyYWlnaHQgbGluZSBmcm9tIHRoZSBjdXJyZW50IHBvaW50IHRvIHRoZSBzdGFydC4gSWYgdGhlIHNoYXBlIGhhcyBhbHJlYWR5IGJlZW4gY2xvc2VkIG9yIGhhcyBvbmx5IG9uZSBwb2ludCwgdGhpcyBmdW5jdGlvbiBkb2VzIG5vdGhpbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjY2xvc2VQYXRoCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGNsb3NlUGF0aDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBsaW5lYXIgZ3JhZGllbnQgd2l0aCBkZWZpbmVkIGJ5IGFuIGltYWdpbmFyeSBsaW5lIHdoaWNoIGltcGxpZXMgdGhlIGRpcmVjdGlvbiBvZiB0aGUgZ3JhZGllbnQuCiAgICAqIE9uY2UgdGhlIGdyYWRpZW50IGlzIGNyZWF0ZWQgY29sb3JzIGNhbiBiZSBpbnNlcnRlZCB1c2luZyB0aGUgYWRkQ29sb3JTdG9wIG1ldGhvZC4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNjcmVhdGVMaW5lYXJHcmFkaWVudAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSBncmFkaWVudHMgc3RhcnRpbmcgcG9pbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIGdyYWRpZW50cyBzdGFydGluZyBwb2ludC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBncmFkaWVudC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIGdyYWRpZW50LgogICAgKiBAcmV0dXJuIHtDYW52YXNHcmFkaWVudH0gVGhlIExpbmVhciBHcmFkaWVudC4KICAgICovCiAgICBjcmVhdGVMaW5lYXJHcmFkaWVudDogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuY29udGV4dC5jcmVhdGVMaW5lYXJHcmFkaWVudCh4LCB5LCB3aWR0aCwgaGVpZ2h0KTsKCiAgICB9LAoKICAgIC8vICBjcmVhdGVQYXR0ZXJuCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSByYWRpYWwgZ3JhZGllbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjY3JlYXRlUmFkaWFsR3JhZGllbnQKICAgICogQHBhcmFtIHtudW1iZXJ9IHgwCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MAogICAgKiBAcGFyYW0ge251bWJlcn0gcjAKICAgICogQHBhcmFtIHtudW1iZXJ9IHgxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MQogICAgKiBAcGFyYW0ge251bWJlcn0gcjEKICAgICogQHJldHVybiB7Q2FudmFzR3JhZGllbnR9IFRoZSBSYWRpYWwgR3JhZGllbnQuCiAgICAqLwogICAgY3JlYXRlUmFkaWFsR3JhZGllbnQ6IGZ1bmN0aW9uICh4MCwgeTAsIHIwLCB4MSwgeTEsIHIxKSB7CgogICAgICAgIHJldHVybiB0aGlzLmNvbnRleHQuY3JlYXRlUmFkaWFsR3JhZGllbnQoeDAsIHkwLCByMCwgeDEsIHkxLCByMSk7CgogICAgfSwKCiAgICAvLyAgZHJhd0ltYWdlCiAgICAvLyAgZHJhd1N5c3RlbUZvY3VzUmluZyAoPykKCiAgICAvKioKICAgICogRHJhd3MgYW4gZWxsaXBzZSAob3ZhbCkgd2l0aCBhIHNwZWNpZmllZCB3aWR0aCAodykgYW5kIGhlaWdodCAoaCkuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjZWxsaXBzZQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIHggY29vcmRpbmF0ZSBjZW50ZXIgcG9pbnQgb2YgZWxsaXBzZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSB5IGNvb3JkaW5hdGUgY2VudGVyIHBvaW50IG9mIGVsbGlwc2UuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3IC0gaGVpZ2h0IChob3Jpem9udGFsIGRpYW1ldGVyKSBvZiBlbGxpcHNlLiBUaGUgaG9yaXpvbnRhbCByYWRpdXMgd2lsbCBiZSBoYWxmIG9mIHRoaXMgbnVtYmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gaCAtIHdpZHRoICh2ZXJ0aWNhbCBkaWFtZXRlcikgb2YgZWxsaXBzZS4gVGhlIHZlcnRpY2FsIHJhZGl1cyB3aWxsIGJlIGhhbGYgb2YgdGhpcyBudW1iZXIuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGVsbGlwc2U6IGZ1bmN0aW9uICh4LCB5LCB3LCBoKSB7CgogICAgICAgIHZhciBrID0gMC41NTIyODQ4OwogICAgICAgIHZhciBveCA9ICh3IC8gMikgKiBrOwogICAgICAgIHZhciBveSA9IChoIC8gMikgKiBrOwogICAgICAgIHZhciB4ZSA9IHggKyB3OwogICAgICAgIHZhciB5ZSA9IHkgKyBoOwogICAgICAgIHZhciB4bSA9IHggKyB3IC8gMjsKICAgICAgICB2YXIgeW0gPSB5ICsgaCAvIDI7CiAgICAgICAgICAgIAogICAgICAgIHRoaXMubW92ZVRvKHgsIHltKTsKICAgICAgICB0aGlzLmJlemllckN1cnZlVG8oeCwgeW0gLSBveSwgeG0gLSBveCwgeSwgeG0sIHkpOwogICAgICAgIHRoaXMuYmV6aWVyQ3VydmVUbyh4bSArIG94LCB5LCB4ZSwgeW0gLSBveSwgeGUsIHltKTsKICAgICAgICB0aGlzLmJlemllckN1cnZlVG8oeGUsIHltICsgb3ksIHhtICsgb3gsIHllLCB4bSwgeWUpOwogICAgICAgIHRoaXMuYmV6aWVyQ3VydmVUbyh4bSAtIG94LCB5ZSwgeCwgeW0gKyBveSwgeCwgeW0pOwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBGaWxscyB0aGUgc3VicGF0aHMgd2l0aCB0aGUgY3VycmVudCBmaWxsIHN0eWxlLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2ZpbGwKICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgZmlsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGwoKTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBEcmF3cyBhIGZpbGxlZCByZWN0YW5nbGUgYXQgKHgsIHkpIHBvc2l0aW9uIHdob3NlIHNpemUgaXMgZGV0ZXJtaW5lZCBieSB3aWR0aCBhbmQgaGVpZ2h0LgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2ZpbGxSZWN0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIHJlY3RhbmdsZSBzdGFydGluZyBwb2ludC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgcmVjdGFuZ2xlIHN0YXJ0aW5nIHBvaW50LgogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgcmVjdGFuZ2xlcyB3aWR0aC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSByZWN0YW5nbGVzIGhlaWdodC4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgZmlsbFJlY3Q6IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgZmlsbCBzdHlsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNmaWxsU3R5bGUKICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbG9yIC0gVGhlIGZpbGwgY29sb3IgdmFsdWUgaW4gQ1NTIGZvcm1hdDogI1JSR0dCQiBvciByZ2JhKHIsZyxiLGEpCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGZpbGxTdHlsZTogZnVuY3Rpb24gKGNvbG9yKSB7CgogICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8vICBmaWxsVGV4dAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBmb250LgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2ZvbnQKICAgICogQHBhcmFtIHtET01TdHJpbmd9IGZvbnQgLSBUaGUgZm9udCB0byBiZSB1c2VkIGZvciBhbnkgdGV4dCByZW5kZXJpbmcuIERlZmF1bHQgdmFsdWUgMTBweCBzYW5zLXNlcmlmLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBmb250OiBmdW5jdGlvbiAoZm9udCkgewoKICAgICAgICB0aGlzLmNvbnRleHQuZm9udCA9IGZvbnQ7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQWxwaGEgdmFsdWUgdGhhdCBpcyBhcHBsaWVkIHRvIHNoYXBlcyBhbmQgaW1hZ2VzIGJlZm9yZSB0aGV5IGFyZSBjb21wb3NpdGVkIG9udG8gdGhlIGNhbnZhcy4gRGVmYXVsdCAxLjAgKG9wYXF1ZSkuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjZ2xvYmFsQWxwaGEKICAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gQWxwaGEgdmFsdWUgdGhhdCBpcyBhcHBsaWVkIHRvIHNoYXBlcyBhbmQgaW1hZ2VzIGJlZm9yZSB0aGV5IGFyZSBjb21wb3NpdGVkIG9udG8gdGhlIGNhbnZhcy4gRGVmYXVsdCAxLjAgKG9wYXF1ZSkuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGdsb2JhbEFscGhhOiBmdW5jdGlvbiAoYWxwaGEpIHsKCiAgICAgICAgdGhpcy5jb250ZXh0Lmdsb2JhbEFscGhhID0gYWxwaGE7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogV2l0aCBnbG9iYWxBbHBoYSBhcHBsaWVkIHRoaXMgc2V0cyBob3cgc2hhcGVzIGFuZCBpbWFnZXMgYXJlIGRyYXduIG9udG8gdGhlIGV4aXN0aW5nIGJpdG1hcC4gUG9zc2libGUgdmFsdWVzOiBzb3VyY2UtYXRvcCwgc291cmNlLWluLCBzb3VyY2Utb3V0LAogICAgKiBzb3VyY2Utb3ZlciAoZGVmYXVsdCksIGRlc3RpbmF0aW9uLWF0b3AsIGRlc3RpbmF0aW9uLWluLCBkZXN0aW5hdGlvbi1vdXQsIGRlc3RpbmF0aW9uLW92ZXIsIGxpZ2h0ZXIsIGRhcmtlciwgY29weSBhbmQgeG9yLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2dsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbgogICAgKiBAcGFyYW0ge0RPTVN0cmluZ30gb3BlcmF0aW9uIC0gVGhlIGNvbXBvc2l0ZSBvcGVyYXRpb24gdG8gYXBwbHkuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbjogZnVuY3Rpb24gKG9wZXJhdGlvbikgewoKICAgICAgICB0aGlzLmNvbnRleHQuZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gb3BlcmF0aW9uOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFR5cGUgb2YgZW5kaW5ncyBvbiB0aGUgZW5kIG9mIGxpbmVzLiBQb3NzaWJsZSB2YWx1ZXM6IGJ1dHQgKGRlZmF1bHQpLCByb3VuZCwgc3F1YXJlLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2xpbmVDYXAKICAgICogQHBhcmFtIHtET01TdHJpbmd9IHN0eWxlIC0gUG9zc2libGUgdmFsdWVzOiBidXR0IChkZWZhdWx0KSwgcm91bmQsIHNxdWFyZQogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBsaW5lQ2FwOiBmdW5jdGlvbiAoc3R5bGUpIHsKCiAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVDYXAgPSBzdHlsZTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTcGVjaWZpZXMgd2hlcmUgdG8gc3RhcnQgYSBkYXNoYXJyYXkgb24gYSBsaW5lLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2xpbmVEYXNoT2Zmc2V0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBvZmZzZXQgLSBTcGVjaWZpZXMgd2hlcmUgdG8gc3RhcnQgYSBkYXNoYXJyYXkgb24gYSBsaW5lLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBsaW5lRGFzaE9mZnNldDogZnVuY3Rpb24gKG9mZnNldCkgewoKICAgICAgICB0aGlzLmNvbnRleHQubGluZURhc2hPZmZzZXQgPSBvZmZzZXQ7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogRGVmaW5lcyB0aGUgdHlwZSBvZiBjb3JuZXJzIHdoZXJlIHR3byBsaW5lcyBtZWV0LiBQb3NzaWJsZSB2YWx1ZXM6IHJvdW5kLCBiZXZlbCwgbWl0ZXIgKGRlZmF1bHQpCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjbGluZUpvaW4KICAgICogQHBhcmFtIHtET01TdHJpbmd9IGpvaW4gLSBQb3NzaWJsZSB2YWx1ZXM6IHJvdW5kLCBiZXZlbCwgbWl0ZXIgKGRlZmF1bHQpCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIGxpbmVKb2luOiBmdW5jdGlvbiAoam9pbikgewoKICAgICAgICB0aGlzLmNvbnRleHQubGluZUpvaW4gPSBqb2luOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFdpZHRoIG9mIGxpbmVzLiBEZWZhdWx0IDEuMAogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI2xpbmVXaWR0aAogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBXaWR0aCBvZiBsaW5lcy4gRGVmYXVsdCAxLjAKICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgbGluZVdpZHRoOiBmdW5jdGlvbiAod2lkdGgpIHsKCiAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVXaWR0aCA9IHdpZHRoOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERlZmF1bHQgMTAuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjbWl0ZXJMaW1pdAogICAgKiBAcGFyYW0ge251bWJlcn0gbGltaXQgLSBEZWZhdWx0IDEwLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBtaXRlckxpbWl0OiBmdW5jdGlvbiAobGltaXQpIHsKCiAgICAgICAgdGhpcy5jb250ZXh0Lm1pdGVyTGltaXQgPSBsaW1pdDsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8vICBnZXRJbWFnZURhdGEKICAgIC8vICBnZXRMaW5lRGFzaAogICAgLy8gIGlzUG9pbnRJblBhdGgKICAgIC8vICBpc1BvaW50SW5TdHJva2UKCiAgICAvKioKICAgICogQ29ubmVjdHMgdGhlIGxhc3QgcG9pbnQgaW4gdGhlIHN1YnBhdGggdG8gdGhlIHgsIHkgY29vcmRpbmF0ZXMgd2l0aCBhIHN0cmFpZ2h0IGxpbmUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjbGluZVRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIGVuZCBvZiB0aGUgbGluZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgZW5kIG9mIHRoZSBsaW5lLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBsaW5lVG86IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNvbnRleHQubGluZVRvKHgsIHkpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLy8gIG1lYXN1cmVUZXh0CgogICAgLyoqCiAgICAqIE1vdmVzIHRoZSBzdGFydGluZyBwb2ludCBvZiBhIG5ldyBzdWJwYXRoIHRvIHRoZSAoeCwgeSkgY29vcmRpbmF0ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjbW92ZVRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggYXhpcyBvZiB0aGUgcG9pbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgcG9pbnQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIG1vdmVUbzogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgdGhpcy5jb250ZXh0Lm1vdmVUbyh4LCB5KTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8vICBwdXRJbWFnZURhdGEKCiAgICAvKioKICAgICogRHJhd3MgYSBxdWFkcmF0aWMgY3VydmUgZnJvbSB0aGUgY3VycmVudCBkcmF3aW5nIHBvaW50IHRvICh4LCB5KSB1c2luZyB0aGUgY29udHJvbCBwb2ludCAoY3B4LCBjcHkpLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI3F1YWRyYXRpY0N1cnZlVG8KICAgICogQHBhcmFtIHtOdW1iZXJ9IGNweCAtIFRoZSB4IGF4aXMgb2YgdGhlIGNvbnRyb2wgcG9pbnQuCiAgICAqIEBwYXJhbSB7TnVtYmVyfSBjcHkgLSBUaGUgeSBheGlzIG9mIHRoZSBjb250cm9sIHBvaW50LgogICAgKiBAcGFyYW0ge051bWJlcn0geCAtIFRoZSB4IGF4aXMgb2YgdGhlIGVuZGluZyBwb2ludC4KICAgICogQHBhcmFtIHtOdW1iZXJ9IHkgLSBUaGUgeSBheGlzIG9mIHRoZSBlbmRpbmcgcG9pbnQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIHF1YWRyYXRpY0N1cnZlVG86IGZ1bmN0aW9uKGNweCwgY3B5LCB4LCB5KSB7CgogICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNvbnRleHQucXVhZHJhdGljQ3VydmVUbyhjcHgsIGNweSwgeCwgeSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogRHJhd3MgYSByZWN0YW5nbGUgYXQgKHgsIHkpIHBvc2l0aW9uIHdob3NlIHNpemUgaXMgZGV0ZXJtaW5lZCBieSB3aWR0aCBhbmQgaGVpZ2h0LgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI3JlY3QKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgcmVjdGFuZ2xlIHN0YXJ0aW5nIHBvaW50LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSByZWN0YW5nbGUgc3RhcnRpbmcgcG9pbnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSByZWN0YW5nbGVzIHdpZHRoLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIHJlY3RhbmdsZXMgaGVpZ2h0LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICByZWN0OiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LnJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKICAgIAogICAgLyoqCiAgICAqIFJlc3RvcmVzIHRoZSBkcmF3aW5nIHN0eWxlIHN0YXRlIHRvIHRoZSBsYXN0IGVsZW1lbnQgb24gdGhlICdzdGF0ZSBzdGFjaycgc2F2ZWQgYnkgc2F2ZSgpLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI3Jlc3RvcmUKICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgcmVzdG9yZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LnJlc3RvcmUoKTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSb3RhdGVzIHRoZSBkcmF3aW5nIGNvbnRleHQgdmFsdWVzIGJ5IHIgcmFkaWFucy4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNyb3RhdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIG9mIHJvdGF0aW9uIGdpdmVuIGluIHJhZGlhbnMuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIHJvdGF0ZTogZnVuY3Rpb24gKGFuZ2xlKSB7CgogICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNvbnRleHQucm90YXRlKGFuZ2xlKTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBzdHJva2Ugc3R5bGUgZm9yIHRoZSBjdXJyZW50IHN1Yi1wYXRoLiBMaWtlIGFsbCBkcmF3aW5nIG1ldGhvZHMsIHRoaXMgY2FuIGJlIGNoYWluZWQsIHNvIHlvdSBjYW4gZGVmaW5lCiAgICAqIHRoZSBzdHJva2Ugc3R5bGUgYW5kIGNvbG9yIGluIGEgc2luZ2xlIGxpbmUgb2YgY29kZSBsaWtlIHNvOgogICAgKgogICAgKiAgICAgIGBgYG15R3JhcGhpY3Muc2V0U3Ryb2tlU3R5bGUoOCwicm91bmQiKS5iZWdpblN0cm9rZSgiI0YwMCIpO2BgYAogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI3NldFN0cm9rZVN0eWxlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aGlja25lc3MgLSBUaGUgd2lkdGggb2YgdGhlIHN0cm9rZS4KICAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbY2Fwcz0wXSAtIEluZGljYXRlcyB0aGUgdHlwZSBvZiBjYXBzIHRvIHVzZSBhdCB0aGUgZW5kIG9mIGxpbmVzLiBPbmUgb2YgYnV0dCwgcm91bmQsIG9yIHNxdWFyZS4gRGVmYXVsdHMgdG8gImJ1dHQiLiBBbHNvIGFjY2VwdHMgdGhlIHZhbHVlcyAwIChidXR0KSwgMSAocm91bmQpLCBhbmQgMiAoc3F1YXJlKSBmb3IgdXNlIHdpdGggaGUgdGlueSBBUEkuCiAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW2pvaW50cz0wXSBTcGVjaWZpZXMgdGhlIHR5cGUgb2Ygam9pbnRzIHRoYXQgc2hvdWxkIGJlIHVzZWQgd2hlcmUgdHdvIGxpbmVzIG1lZXQuIE9uZSBvZiBiZXZlbCwgcm91bmQsIG9yIG1pdGVyLiBEZWZhdWx0cyB0byAibWl0ZXIiLiBBbHNvIGFjY2VwdHMgdGhlIHZhbHVlcyAwIChtaXRlciksIDEgKHJvdW5kKSwgYW5kIDIgKGJldmVsKSBmb3IgdXNlIHdpdGggdGhlIHRpbnkgQVBJLgogICAgKiBAcGFyYW0ge251bWJlcn0gW21pdGVyTGltaXQ9MTBdIC0gSWYgam9pbnRzIGlzIHNldCB0byAibWl0ZXIiLCB0aGVuIHlvdSBjYW4gc3BlY2lmeSBhIG1pdGVyIGxpbWl0IHJhdGlvIHdoaWNoIGNvbnRyb2xzIGF0IHdoYXQgcG9pbnQgYSBtaXRlcmVkIGpvaW50IHdpbGwgYmUgY2xpcHBlZC4KICAgICogQHBhcmFtIHtib29sZWFufSBbaWdub3JlU2NhbGU9ZmFsc2VdIC0gSWYgdHJ1ZSwgdGhlIHN0cm9rZSB3aWxsIGJlIGRyYXduIGF0IHRoZSBzcGVjaWZpZWQgdGhpY2tuZXNzIHJlZ2FyZGxlc3Mgb2YgYWN0aXZlIHRyYW5zZm9ybWF0aW9ucy4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgc2V0U3Ryb2tlU3R5bGU6IGZ1bmN0aW9uICh0aGlja25lc3MsIGNhcHMsIGpvaW50cywgbWl0ZXJMaW1pdCwgaWdub3JlU2NhbGUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB0aGlja25lc3MgPT09ICd1bmRlZmluZWQnKSB7IHRoaWNrbmVzcyA9IDE7IH0KICAgICAgICBpZiAodHlwZW9mIGNhcHMgPT09ICd1bmRlZmluZWQnKSB7IGNhcHMgPSAnYnV0dCc7IH0KICAgICAgICBpZiAodHlwZW9mIGpvaW50cyA9PT0gJ3VuZGVmaW5lZCcpIHsgam9pbnRzID0gJ21pdGVyJzsgfQogICAgICAgIGlmICh0eXBlb2YgbWl0ZXJMaW1pdCA9PT0gJ3VuZGVmaW5lZCcpIHsgbWl0ZXJMaW1pdCA9IDEwOyB9CgogICAgICAgIC8vICBUT0RPCiAgICAgICAgaWdub3JlU2NhbGUgPSBmYWxzZTsKCiAgICAgICAgdGhpcy5saW5lV2lkdGgodGhpY2tuZXNzKTsKICAgICAgICB0aGlzLmxpbmVDYXAoY2Fwcyk7CiAgICAgICAgdGhpcy5saW5lSm9pbihqb2ludHMpOwogICAgICAgIHRoaXMubWl0ZXJMaW1pdChtaXRlckxpbWl0KTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2F2ZXMgdGhlIGN1cnJlbnQgZHJhd2luZyBzdHlsZSBzdGF0ZSB1c2luZyBhIHN0YWNrIHNvIHlvdSBjYW4gcmV2ZXJ0IGFueSBjaGFuZ2UgeW91IG1ha2UgdG8gaXQgdXNpbmcgcmVzdG9yZSgpLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI3NhdmUKICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgc2F2ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LnNhdmUoKTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTY2FsZXMgdGhlIGN1cnJlbnQgZHJhd2luZyBjb250ZXh0LgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI3NjYWxlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5CiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgogICAgKi8KICAgIHNjYWxlOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLl9kaXJ0eSA9IHRydWU7CiAgICAgICAgdGhpcy5jb250ZXh0LnNjYWxlKHgsIHkpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI3Njcm9sbFBhdGhJbnRvVmlldwogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBzY3JvbGxQYXRoSW50b1ZpZXc6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY29udGV4dC5zY3JvbGxQYXRoSW50b1ZpZXcoKTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8vICBzZXRMaW5lRGFzaAogICAgLy8gIHNldFRyYW5zZm9ybQoKICAgIC8qKgogICAgKiBTdHJva2VzIHRoZSBzdWJwYXRocyB3aXRoIHRoZSBjdXJyZW50IHN0cm9rZSBzdHlsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YSNzdHJva2UKICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgc3Ryb2tlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogUGFpbnRzIGEgcmVjdGFuZ2xlIHdoaWNoIGhhcyBhIHN0YXJ0aW5nIHBvaW50IGF0ICh4LCB5KSBhbmQgaGFzIGEgdyB3aWR0aCBhbmQgYW4gaCBoZWlnaHQgb250byB0aGUgY2FudmFzLCB1c2luZyB0aGUgY3VycmVudCBzdHJva2Ugc3R5bGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjc3Ryb2tlUmVjdAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGF4aXMgZm9yIHRoZSBzdGFydGluZyBwb2ludCBvZiB0aGUgcmVjdGFuZ2xlLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgZm9yIHRoZSBzdGFydGluZyBwb2ludCBvZiB0aGUgcmVjdGFuZ2xlLgogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgcmVjdGFuZ2xlcyB3aWR0aC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSByZWN0YW5nbGVzIGhlaWdodC4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCiAgICAqLwogICAgc3Ryb2tlUmVjdDogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgdGhpcy5fZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VSZWN0KHgsIHksIHdpZHRoLCBoZWlnaHQpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENvbG9yIG9yIHN0eWxlIHRvIHVzZSBmb3IgdGhlIGxpbmVzIGFyb3VuZCBzaGFwZXMuIERlZmF1bHQgIzAwMCAoYmxhY2spLgogICAgKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhI3N0cm9rZVN0eWxlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdHlsZSAtIENvbG9yIG9yIHN0eWxlIHRvIHVzZSBmb3IgdGhlIGxpbmVzIGFyb3VuZCBzaGFwZXMuIERlZmF1bHQgIzAwMCAoYmxhY2spLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KICAgICovCiAgICBzdHJva2VTdHlsZTogZnVuY3Rpb24gKHN0eWxlKSB7CgogICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VTdHlsZSA9IHN0eWxlOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLy8gIHN0cm9rZVRleHQKICAgIC8vICB0cmFuc2Zvcm0KICAgIC8vICB0cmFuc2xhdGUKCiAgICAvKioKICAgICogSWYgdGhlIGdhbWUgaXMgcnVubmluZyBpbiBXZWJHTCB0aGlzIHdpbGwgcHVzaCB0aGUgdGV4dHVyZSB1cCB0byB0aGUgR1BVIGlmIGl0J3MgZGlydHkuCiAgICAqIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgaWYgdGhlIEJpdG1hcERhdGEgaXMgYmVpbmcgdXNlZCBieSBhIFNwcml0ZSwgb3RoZXJ3aXNlIHlvdSBuZWVkIHRvIHJlbWVtYmVyIHRvIGNhbGwgaXQgaW4geW91ciByZW5kZXIgZnVuY3Rpb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEjcmVuZGVyCiAgICAqLwogICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9kaXJ0eSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBPbmx5IG5lZWRlZCBpZiBydW5uaW5nIGluIFdlYkdMLCBvdGhlcndpc2UgdGhpcyBhcnJheSB3aWxsIG5ldmVyIGdldCBjbGVhcmVkIGRvd24KICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5yZW5kZXJUeXBlID09IFBoYXNlci5XRUJHTCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgUElYSS50ZXh0dXJlc1RvVXBkYXRlLnB1c2godGhpcy5iYXNlVGV4dHVyZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2RpcnR5ID0gZmFsc2U7CiAgICAgICAgfQoKICAgIH0KCn07CgpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuQml0bWFwRGF0YTsKCi8vICBFYXNlbEpTIFRpbnkgQVBJIGVtdWxhdGlvbgoKLyoqCiogU2hvcnRjdXQgdG8gbW92ZVRvLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLm10CiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5tdCA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5tb3ZlVG87CgovKioKKiBTaG9ydGN1dCB0byBsaW5lVG8uCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUubXQKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmx0ID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmxpbmVUbzsKCi8qKgoqIFNob3J0Y3V0IHRvIGFyY1RvLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmF0CiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5hdCA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5hcmNUbzsKCi8qKgoqIFNob3J0Y3V0IHRvIGJlemllckN1cnZlVG8uCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYnQKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJ0ID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJlemllckN1cnZlVG87CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gcXVhZHJhdGljQ3VydmVUby4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5xdAoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucXQgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucXVhZHJhdGljQ3VydmVUbzsKICAgIAovKioKKiBTaG9ydGN1dCB0byBhcmMuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYQoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYSA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5hcmM7CgovKioKKiBTaG9ydGN1dCB0byByZWN0LgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnIKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnIgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucmVjdDsKICAgIAovKioKKiBTaG9ydGN1dCB0byBjbG9zZVBhdGguCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuY3AKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmNwID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmNsb3NlUGF0aDsKCi8qKgoqIFNob3J0Y3V0IHRvIGNsZWFyLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmMKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuY2xlYXI7CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5GaWxsLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmYKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmYgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5GaWxsOwoKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5MaW5lYXJHcmFkaWVudEZpbGwuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUubGYKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmxmID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJlZ2luTGluZWFyR3JhZGllbnRGaWxsOwogICAgCi8qKgoqIFNob3J0Y3V0IHRvIGJlZ2luUmFkaWFsR3JhZGllbnRGaWxsLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnJmCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yZiA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5iZWdpblJhZGlhbEdyYWRpZW50RmlsbDsKICAgIAovKioKKiBTaG9ydGN1dCB0byBiZWdpbkJpdG1hcEZpbGwuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmYKKi8KLy9QaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmYgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5CaXRtYXBGaWxsOwogICAgCi8qKgoqIFNob3J0Y3V0IHRvIGVuZEZpbGwuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZWYKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmVmID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmVuZEZpbGw7CgovKioKKiBTaG9ydGN1dCB0byBzZXRTdHJva2VTdHlsZS4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5zcwoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuc3MgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuc2V0U3Ryb2tlU3R5bGU7CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5TdHJva2UuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucwoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucyA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5iZWdpblN0cm9rZTsKICAgIAovKioKKiBTaG9ydGN1dCB0byBiZWdpbkxpbmVhckdyYWRpZW50U3Ryb2tlLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmxzCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5scyA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5iZWdpbkxpbmVhckdyYWRpZW50U3Ryb2tlOwoKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5SYWRpYWxHcmFkaWVudFN0cm9rZS4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5ycwoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucnMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5SYWRpYWxHcmFkaWVudFN0cm9rZTsKICAgIAovKioKKiBTaG9ydGN1dCB0byBiZWdpbkJpdG1hcFN0cm9rZS4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5icwoqLwovLyBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYnMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5CaXRtYXBTdHJva2U7CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gZW5kU3Ryb2tlLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmVzCiovCi8vIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5lcyA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5lbmRTdHJva2U7CiAgICAKLyoqCiogU2hvcnRjdXQgdG8gcmVjdC4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kcgoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZHIgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucmVjdDsKICAgIAovKioKKiBTaG9ydGN1dCB0byBkcmF3Um91bmRSZWN0LgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnJyCiovCi8vIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yciA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kcmF3Um91bmRSZWN0OwogICAgCi8qKgoqIFNob3J0Y3V0IHRvIGRyYXdSb3VuZFJlY3RDb21wbGV4LgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnJjCiovCi8vIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yYyA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kcmF3Um91bmRSZWN0Q29tcGxleDsKCi8qKgoqIFNob3J0Y3V0IHRvIGRyYXdDaXJjbGUuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZGMKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRjID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmNpcmNsZTsKICAgIAovKioKKiBTaG9ydGN1dCB0byBkcmF3RWxsaXBzZS4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kZQoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZGUgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZWxsaXBzZTsKICAgIAovKioKKiBTaG9ydGN1dCB0byBkcmF3UG9seVN0YXIuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZHAKKi8KLy8gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRwID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRyYXdQb2x5U3RhcjsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEBjbGFzcyBQaGFzZXIuU3ByaXRlCioKKiBAY2xhc3NkZXNjIENyZWF0ZSBhIG5ldyBgU3ByaXRlYCBvYmplY3QuIFNwcml0ZXMgYXJlIHRoZSBsaWZlYmxvb2Qgb2YgeW91ciBnYW1lLCB1c2VkIGZvciBuZWFybHkgZXZlcnl0aGluZyB2aXN1YWwuCioKKiBBdCBpdHMgbW9zdCBiYXNpYyBhIFNwcml0ZSBjb25zaXN0cyBvZiBhIHNldCBvZiBjb29yZGluYXRlcyBhbmQgYSB0ZXh0dXJlIHRoYXQgaXMgcmVuZGVyZWQgdG8gdGhlIGNhbnZhcy4KKiBUaGV5IGFsc28gY29udGFpbiBhZGRpdGlvbmFsIHByb3BlcnRpZXMgYWxsb3dpbmcgZm9yIHBoeXNpY3MgbW90aW9uICh2aWEgU3ByaXRlLmJvZHkpLCBpbnB1dCBoYW5kbGluZyAodmlhIFNwcml0ZS5pbnB1dCksCiogZXZlbnRzICh2aWEgU3ByaXRlLmV2ZW50cyksIGFuaW1hdGlvbiAodmlhIFNwcml0ZS5hbmltYXRpb25zKSwgY2FtZXJhIGN1bGxpbmcgYW5kIG1vcmUuIFBsZWFzZSBzZWUgdGhlIEV4YW1wbGVzIGZvciB1c2UgY2FzZXMuCioKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIChpbiB3b3JsZCBzcGFjZSkgdG8gcG9zaXRpb24gdGhlIFNwcml0ZSBhdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgKGluIHdvcmxkIHNwYWNlKSB0byBwb3NpdGlvbiB0aGUgU3ByaXRlIGF0LgoqIEBwYXJhbSB7c3RyaW5nfFBoYXNlci5SZW5kZXJUZXh0dXJlfFBoYXNlci5CaXRtYXBEYXRhfFBJWEkuVGV4dHVyZX0ga2V5IC0gVGhpcyBpcyB0aGUgaW1hZ2Ugb3IgdGV4dHVyZSB1c2VkIGJ5IHRoZSBTcHJpdGUgZHVyaW5nIHJlbmRlcmluZy4gSXQgY2FuIGJlIGEgc3RyaW5nIHdoaWNoIGlzIGEgcmVmZXJlbmNlIHRvIHRoZSBDYWNoZSBlbnRyeSwgb3IgYW4gaW5zdGFuY2Ugb2YgYSBSZW5kZXJUZXh0dXJlIG9yIFBJWEkuVGV4dHVyZS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGZyYW1lIC0gSWYgdGhpcyBTcHJpdGUgaXMgdXNpbmcgcGFydCBvZiBhIHNwcml0ZSBzaGVldCBvciB0ZXh0dXJlIGF0bGFzIHlvdSBjYW4gc3BlY2lmeSB0aGUgZXhhY3QgZnJhbWUgdG8gdXNlIGJ5IGdpdmluZyBhIHN0cmluZyBvciBudW1lcmljIGluZGV4LgoqLwpQaGFzZXIuU3ByaXRlID0gZnVuY3Rpb24gKGdhbWUsIHgsIHksIGtleSwgZnJhbWUpIHsKCiAgICB4ID0geCB8fCAwOwogICAgeSA9IHkgfHwgMDsKICAgIGtleSA9IGtleSB8fCBudWxsOwogICAgZnJhbWUgPSBmcmFtZSB8fCBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CiAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGV4aXN0cyAtIElmIGV4aXN0cyA9IGZhbHNlIHRoZW4gdGhlIFNwcml0ZSBpc24ndCB1cGRhdGVkIGJ5IHRoZSBjb3JlIGdhbWUgbG9vcCBvciBwaHlzaWNzIHN1YnN5c3RlbSBhdCBhbGwuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsaXZlIC0gVGhpcyBpcyBhIGhhbmR5IGxpdHRsZSB2YXIgeW91ciBnYW1lIGNhbiB1c2UgdG8gZGV0ZXJtaW5lIGlmIGEgc3ByaXRlIGlzIGFsaXZlIG9yIG5vdCwgaXQgZG9lc24ndCBlZmZlY3QgcmVuZGVyaW5nLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYWxpdmUgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Hcm91cH0gZ3JvdXAgLSBUaGUgcGFyZW50IEdyb3VwIG9mIHRoaXMgU3ByaXRlLiBUaGlzIGlzIHVzdWFsbHkgc2V0IGFmdGVyIFNwcml0ZSBpbnN0YW50aWF0aW9uIGJ5IHRoZSBwYXJlbnQuCiAgICAqLwogICAgdGhpcy5ncm91cCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gVGhlIHVzZXIgZGVmaW5lZCBuYW1lIGdpdmVuIHRvIHRoaXMgU3ByaXRlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubmFtZSA9ICcnOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIFRoZSBjb25zdCB0eXBlIG9mIHRoaXMgb2JqZWN0LgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuU1BSSVRFOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcmVuZGVyT3JkZXJJRCAtIFVzZWQgYnkgdGhlIFJlbmRlcmVyIGFuZCBJbnB1dCBNYW5hZ2VyIHRvIGNvbnRyb2wgcGlja2luZyBvcmRlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnJlbmRlck9yZGVySUQgPSAtMTsKCiAgICAvKioKICAgICogSWYgeW91IHdvdWxkIGxpa2UgdGhlIFNwcml0ZSB0byBoYXZlIGEgbGlmZXNwYW4gb25jZSAnYm9ybicgeW91IGNhbiBzZXQgdGhpcyB0byBhIHBvc2l0aXZlIHZhbHVlLiBIYW5keSBmb3IgcGFydGljbGVzLCBidWxsZXRzLCBldGMuCiAgICAqIFRoZSBsaWZlc3BhbiBpcyBkZWNyZW1lbnRlZCBieSBnYW1lLnRpbWUuZWxhcHNlZCBlYWNoIHVwZGF0ZSwgb25jZSBpdCByZWFjaGVzIHplcm8gdGhlIGtpbGwoKSBmdW5jdGlvbiBpcyBjYWxsZWQuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsaWZlc3BhbiAtIFRoZSBsaWZlc3BhbiBvZiB0aGUgU3ByaXRlIChpbiBtcykgYmVmb3JlIGl0IHdpbGwgYmUga2lsbGVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubGlmZXNwYW4gPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5FdmVudHN9IGV2ZW50cyAtIFRoZSBFdmVudHMgeW91IGNhbiBzdWJzY3JpYmUgdG8gdGhhdCBhcmUgZGlzcGF0Y2hlZCB3aGVuIGNlcnRhaW4gdGhpbmdzIGhhcHBlbiBvbiB0aGlzIFNwcml0ZSBvciBpdHMgY29tcG9uZW50cy4KICAgICovCiAgICB0aGlzLmV2ZW50cyA9IG5ldyBQaGFzZXIuRXZlbnRzKHRoaXMpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5BbmltYXRpb25NYW5hZ2VyfSBhbmltYXRpb25zIC0gVGhpcyBtYW5hZ2VzIGFuaW1hdGlvbnMgb2YgdGhlIHNwcml0ZS4gWW91IGNhbiBtb2RpZnkgYW5pbWF0aW9ucyB0aHJvdWdoIGl0IChzZWUgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIpCiAgICAqLwogICAgdGhpcy5hbmltYXRpb25zID0gbmV3IFBoYXNlci5BbmltYXRpb25NYW5hZ2VyKHRoaXMpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5JbnB1dEhhbmRsZXJ9IGlucHV0IC0gVGhlIElucHV0IEhhbmRsZXIgQ29tcG9uZW50LgogICAgKi8KICAgIHRoaXMuaW5wdXQgPSBuZXcgUGhhc2VyLklucHV0SGFuZGxlcih0aGlzKTsKCiAgICAvKioKICAgICogIEBwcm9wZXJ0eSB7c3RyaW5nfFBoYXNlci5SZW5kZXJUZXh0dXJlfFBoYXNlci5CaXRtYXBEYXRhfFBJWEkuVGV4dHVyZX0ga2V5IC0gVGhpcyBpcyB0aGUgaW1hZ2Ugb3IgdGV4dHVyZSB1c2VkIGJ5IHRoZSBTcHJpdGUgZHVyaW5nIHJlbmRlcmluZy4gSXQgY2FuIGJlIGEgc3RyaW5nIHdoaWNoIGlzIGEgcmVmZXJlbmNlIHRvIHRoZSBDYWNoZSBlbnRyeSwgb3IgYW4gaW5zdGFuY2Ugb2YgYSBSZW5kZXJUZXh0dXJlLCBCaXRtYXBEYXRhIG9yIFBJWEkuVGV4dHVyZS4KICAgICovCiAgICB0aGlzLmtleSA9IGtleTsKCiAgICAvKioKICAgICogIEBwcm9wZXJ0eSB7UGhhc2VyLkZyYW1lfSBjdXJyZW50RnJhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IGRpc3BsYXllZCBmcmFtZS4KICAgICovCiAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IG51bGw7CgogICAgaWYgKGtleSBpbnN0YW5jZW9mIFBoYXNlci5SZW5kZXJUZXh0dXJlKQogICAgewogICAgICAgIFBJWEkuU3ByaXRlLmNhbGwodGhpcywga2V5KTsKCiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0VGV4dHVyZUZyYW1lKGtleS5uYW1lKTsKICAgIH0KICAgIGVsc2UgaWYgKGtleSBpbnN0YW5jZW9mIFBoYXNlci5CaXRtYXBEYXRhKQogICAgewogICAgICAgIFBJWEkuU3ByaXRlLmNhbGwodGhpcywga2V5LnRleHR1cmUsIGtleS50ZXh0dXJlRnJhbWUpOwoKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IGtleS50ZXh0dXJlRnJhbWU7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgaW5zdGFuY2VvZiBQSVhJLlRleHR1cmUpCiAgICB7CiAgICAgICAgUElYSS5TcHJpdGUuY2FsbCh0aGlzLCBrZXkpOwoKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IGZyYW1lOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGlmIChrZXkgPT09IG51bGwgfHwgdHlwZW9mIGtleSA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICBrZXkgPSAnX19kZWZhdWx0JzsKICAgICAgICAgICAgdGhpcy5rZXkgPSBrZXk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnICYmIHRoaXMuZ2FtZS5jYWNoZS5jaGVja0ltYWdlS2V5KGtleSkgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAga2V5ID0gJ19fbWlzc2luZyc7CiAgICAgICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgIH0KCiAgICAgICAgUElYSS5TcHJpdGUuY2FsbCh0aGlzLCBQSVhJLlRleHR1cmVDYWNoZVtrZXldKTsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5jYWNoZS5pc1Nwcml0ZVNoZWV0KGtleSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFuaW1hdGlvbnMubG9hZEZyYW1lRGF0YSh0aGlzLmdhbWUuY2FjaGUuZ2V0RnJhbWVEYXRhKGtleSkpOwoKICAgICAgICAgICAgaWYgKGZyYW1lICE9PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZyYW1lID09PSAnc3RyaW5nJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IGZyYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZnJhbWUgPSBmcmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRGcmFtZShrZXkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICogVGhlIHJlY3Rhbmd1bGFyIGFyZWEgZnJvbSB0aGUgdGV4dHVyZSB0aGF0IHdpbGwgYmUgcmVuZGVyZWQuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gdGV4dHVyZVJlZ2lvbgogICAgKi8KICAgIHRoaXMudGV4dHVyZVJlZ2lvbiA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKHRoaXMudGV4dHVyZS5mcmFtZS54LCB0aGlzLnRleHR1cmUuZnJhbWUueSwgdGhpcy50ZXh0dXJlLmZyYW1lLndpZHRoLCB0aGlzLnRleHR1cmUuZnJhbWUuaGVpZ2h0KTsKCiAgICAvKioKICAgICogVGhlIGFuY2hvciBzZXRzIHRoZSBvcmlnaW4gcG9pbnQgb2YgdGhlIHRleHR1cmUuCiAgICAqIFRoZSBkZWZhdWx0IGlzIDAsMCB0aGlzIG1lYW5zIHRoZSB0ZXh0dXJlcyBvcmlnaW4gaXMgdGhlIHRvcCBsZWZ0IAogICAgKiBTZXR0aW5nIHRoYW4gYW5jaG9yIHRvIDAuNSwwLjUgbWVhbnMgdGhlIHRleHR1cmVzIG9yaWdpbiBpcyBjZW50ZXJlZAogICAgKiBTZXR0aW5nIHRoZSBhbmNob3IgdG8gMSwxIHdvdWxkIG1lYW4gdGhlIHRleHR1cmVzIG9yaWdpbiBwb2ludHMgd2lsbCBiZSB0aGUgYm90dG9tIHJpZ2h0CiAgICAqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBhbmNob3IgLSBUaGUgYW5jaG9yIGFyb3VuZCB3aGljaCByb3RhdGlvbiBhbmQgc2NhbGluZyB0YWtlcyBwbGFjZS4KICAgICovCiAgICB0aGlzLmFuY2hvciA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIGluIHdvcmxkIHNwYWNlIG9mIHRoaXMgU3ByaXRlLgogICAgKi8KICAgIHRoaXMueCA9IHg7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgaW4gd29ybGQgc3BhY2Ugb2YgdGhpcyBTcHJpdGUuCiAgICAqLwogICAgdGhpcy55ID0geTsKCiAgICB0aGlzLnBvc2l0aW9uLnggPSB4OwogICAgdGhpcy5wb3NpdGlvbi55ID0geTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHdvcmxkIC0gVGhlIHdvcmxkIGNvb3JkaW5hdGVzIG9mIHRoaXMgU3ByaXRlLiBUaGlzIGRpZmZlcnMgZnJvbSB0aGUgeC95IGNvb3JkaW5hdGVzIHdoaWNoIGFyZSByZWxhdGl2ZSB0byB0aGUgU3ByaXRlcyBjb250YWluZXIuCiAgICAqLwogICAgdGhpcy53b3JsZCA9IG5ldyBQaGFzZXIuUG9pbnQoeCwgeSk7CgogICAgLyoqCiAgICAqIFNob3VsZCB0aGlzIFNwcml0ZSBiZSBhdXRvbWF0aWNhbGx5IGN1bGxlZCBpZiBvdXQgb2YgcmFuZ2Ugb2YgdGhlIGNhbWVyYT8KICAgICogQSBjdWxsZWQgc3ByaXRlIGhhcyBpdHMgcmVuZGVyYWJsZSBwcm9wZXJ0eSBzZXQgdG8gJ2ZhbHNlJy4KICAgICoKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhdXRvQ3VsbCAtIEEgZmxhZyBpbmRpY2F0aW5nIGlmIHRoZSBTcHJpdGUgc2hvdWxkIGJlIGF1dG9tYXRpY2FsbHkgY2FtZXJhIGN1bGxlZCBvciBub3QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hdXRvQ3VsbCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc2NhbGUgLSBUaGUgc2NhbGUgb2YgdGhlIFNwcml0ZSB3aGVuIHJlbmRlcmVkLiBCeSBkZWZhdWx0IGl0J3Mgc2V0IHRvIDEgKG5vIHNjYWxlKS4gWW91IGNhbiBtb2RpZnkgaXQgdmlhIHNjYWxlLnggb3Igc2NhbGUueSBvciBzY2FsZS5zZXRUbyh4LCB5KS4gQSB2YWx1ZSBvZiAxIG1lYW5zIG5vIGNoYW5nZSB0byB0aGUgc2NhbGUsIDAuNSBtZWFucyAiaGFsZiB0aGUgc2l6ZSIsIDIgbWVhbnMgInR3aWNlIHRoZSBzaXplIiwgZXRjLgogICAgKi8KICAgIHRoaXMuc2NhbGUgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX2NhY2hlIC0gQSBtaW5pIGNhY2hlIGZvciBzdG9yaW5nIGFsbCBvZiB0aGUgY2FsY3VsYXRlZCB2YWx1ZXMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fY2FjaGUgPSB7CgogICAgICAgIGZyZXNoOiB0cnVlLAogICAgICAgIGRpcnR5OiBmYWxzZSwKCiAgICAgICAgLy8gIFRyYW5zZm9ybSBjYWNoZQogICAgICAgIGEwMDogLTEsCiAgICAgICAgYTAxOiAtMSwKICAgICAgICBhMDI6IC0xLAogICAgICAgIGExMDogLTEsCiAgICAgICAgYTExOiAtMSwKICAgICAgICBhMTI6IC0xLAogICAgICAgIGlkOiAtMSwKCiAgICAgICAgLy8gIElucHV0IHNwZWNpZmljIHRyYW5zZm9ybSBjYWNoZQogICAgICAgIGkwMTogLTEsCiAgICAgICAgaTEwOiAtMSwKICAgICAgICBpZGk6IC0xLAoKICAgICAgICAvLyAgQm91bmRzIGNoZWNrCiAgICAgICAgbGVmdDogbnVsbCwKICAgICAgICByaWdodDogbnVsbCwKICAgICAgICB0b3A6IG51bGwsCiAgICAgICAgYm90dG9tOiBudWxsLAoKICAgICAgICAvLyAgZGVsdGEgY2FjaGUKICAgICAgICBwcmV2WDogeCwKICAgICAgICBwcmV2WTogeSwKCiAgICAgICAgLy8gIFRoZSBwcmV2aW91cyBjYWxjdWxhdGVkIHBvc2l0aW9uCiAgICAgICAgeDogLTEsCiAgICAgICAgeTogLTEsCgogICAgICAgIC8vICBUaGUgYWN0dWFsIHNjYWxlIHZhbHVlcyBiYXNlZCBvbiB0aGUgd29ybGRUcmFuc2Zvcm0KICAgICAgICBzY2FsZVg6IDEsCiAgICAgICAgc2NhbGVZOiAxLAoKICAgICAgICAvLyAgVGhlIHdpZHRoL2hlaWdodCBvZiB0aGUgaW1hZ2UsIGJhc2VkIG9uIHRoZSB1bi1tb2RpZmllZCBmcmFtZSBzaXplIG11bHRpcGxpZWQgYnkgdGhlIGZpbmFsIGNhbGN1bGF0ZWQgc2NhbGUgc2l6ZQogICAgICAgIHdpZHRoOiB0aGlzLmN1cnJlbnRGcmFtZS5zb3VyY2VTaXplVywKICAgICAgICBoZWlnaHQ6IHRoaXMuY3VycmVudEZyYW1lLnNvdXJjZVNpemVILAoKICAgICAgICAvLyAgVGhlIGFjdHVhbCB3aWR0aC9oZWlnaHQgb2YgdGhlIGltYWdlIGlmIGZyb20gYSB0cmltbWVkIGF0bGFzLCBtdWx0aXBsaWVkIGJ5IHRoZSBmaW5hbCBjYWxjdWxhdGVkIHNjYWxlIHNpemUKICAgICAgICBoYWxmV2lkdGg6IE1hdGguZmxvb3IodGhpcy5jdXJyZW50RnJhbWUuc291cmNlU2l6ZVcgLyAyKSwKICAgICAgICBoYWxmSGVpZ2h0OiBNYXRoLmZsb29yKHRoaXMuY3VycmVudEZyYW1lLnNvdXJjZVNpemVIIC8gMiksCgogICAgICAgIC8vICBUaGUgd2lkdGgvaGVpZ2h0IG9mIHRoZSBpbWFnZSwgYmFzZWQgb24gdGhlIHVuLW1vZGlmaWVkIGZyYW1lIHNpemUgbXVsdGlwbGllZCBieSB0aGUgZmluYWwgY2FsY3VsYXRlZCBzY2FsZSBzaXplCiAgICAgICAgY2FsY1dpZHRoOiAtMSwKICAgICAgICBjYWxjSGVpZ2h0OiAtMSwKCiAgICAgICAgLy8gIFRoZSBjdXJyZW50IGZyYW1lIGRldGFpbHMKICAgICAgICAvLyBmcmFtZUlEOiB0aGlzLmN1cnJlbnRGcmFtZS51dWlkLCBmcmFtZVdpZHRoOiB0aGlzLmN1cnJlbnRGcmFtZS53aWR0aCwgZnJhbWVIZWlnaHQ6IHRoaXMuY3VycmVudEZyYW1lLmhlaWdodCwKICAgICAgICBmcmFtZUlEOiAtMSwKICAgICAgICBmcmFtZVdpZHRoOiB0aGlzLmN1cnJlbnRGcmFtZS53aWR0aCwKICAgICAgICBmcmFtZUhlaWdodDogdGhpcy5jdXJyZW50RnJhbWUuaGVpZ2h0LAoKICAgICAgICAvLyAgSWYgdGhpcyBzcHJpdGUgdmlzaWJsZSB0byB0aGUgY2FtZXJhIChyZWdhcmRsZXNzIG9mIGJlaW5nIHNldCB0byB2aXNpYmxlIG9yIG5vdCkKICAgICAgICBjYW1lcmFWaXNpYmxlOiB0cnVlLAoKICAgICAgICAvLyAgQ3JvcCBjYWNoZQogICAgICAgIGNyb3BYOiAwLAogICAgICAgIGNyb3BZOiAwLAogICAgICAgIGNyb3BXaWR0aDogdGhpcy5jdXJyZW50RnJhbWUuc291cmNlU2l6ZVcsCiAgICAgICAgY3JvcEhlaWdodDogdGhpcy5jdXJyZW50RnJhbWUuc291cmNlU2l6ZUgKCiAgICB9OwogIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBvZmZzZXQgLSBDb3JuZXIgcG9pbnQgZGVmYXVsdHMuIFNob3VsZCBub3QgdHlwaWNhbGx5IGJlIG1vZGlmaWVkLgogICAgKi8KICAgIHRoaXMub2Zmc2V0ID0gbmV3IFBoYXNlci5Qb2ludCgpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGNlbnRlciAtIEEgUG9pbnQgY29udGFpbmluZyB0aGUgY2VudGVyIGNvb3JkaW5hdGUgb2YgdGhlIFNwcml0ZS4gVGFrZXMgcm90YXRpb24gYW5kIHNjYWxlIGludG8gYWNjb3VudC4KICAgICovCiAgICB0aGlzLmNlbnRlciA9IG5ldyBQaGFzZXIuUG9pbnQoeCArIE1hdGguZmxvb3IodGhpcy5fY2FjaGUud2lkdGggLyAyKSwgeSArIE1hdGguZmxvb3IodGhpcy5fY2FjaGUuaGVpZ2h0IC8gMikpOwogICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gdG9wTGVmdCAtIEEgUG9pbnQgY29udGFpbmluZyB0aGUgdG9wIGxlZnQgY29vcmRpbmF0ZSBvZiB0aGUgU3ByaXRlLiBUYWtlcyByb3RhdGlvbiBhbmQgc2NhbGUgaW50byBhY2NvdW50LgogICAgKi8KICAgIHRoaXMudG9wTGVmdCA9IG5ldyBQaGFzZXIuUG9pbnQoeCwgeSk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gdG9wUmlnaHQgLSBBIFBvaW50IGNvbnRhaW5pbmcgdGhlIHRvcCByaWdodCBjb29yZGluYXRlIG9mIHRoZSBTcHJpdGUuIFRha2VzIHJvdGF0aW9uIGFuZCBzY2FsZSBpbnRvIGFjY291bnQuCiAgICAqLwogICAgdGhpcy50b3BSaWdodCA9IG5ldyBQaGFzZXIuUG9pbnQoeCArIHRoaXMuX2NhY2hlLndpZHRoLCB5KTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBib3R0b21SaWdodCAtIEEgUG9pbnQgY29udGFpbmluZyB0aGUgYm90dG9tIHJpZ2h0IGNvb3JkaW5hdGUgb2YgdGhlIFNwcml0ZS4gVGFrZXMgcm90YXRpb24gYW5kIHNjYWxlIGludG8gYWNjb3VudC4KICAgICovCiAgICB0aGlzLmJvdHRvbVJpZ2h0ID0gbmV3IFBoYXNlci5Qb2ludCh4ICsgdGhpcy5fY2FjaGUud2lkdGgsIHkgKyB0aGlzLl9jYWNoZS5oZWlnaHQpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGJvdHRvbUxlZnQgLSBBIFBvaW50IGNvbnRhaW5pbmcgdGhlIGJvdHRvbSBsZWZ0IGNvb3JkaW5hdGUgb2YgdGhlIFNwcml0ZS4gVGFrZXMgcm90YXRpb24gYW5kIHNjYWxlIGludG8gYWNjb3VudC4KICAgICovCiAgICB0aGlzLmJvdHRvbUxlZnQgPSBuZXcgUGhhc2VyLlBvaW50KHgsIHkgKyB0aGlzLl9jYWNoZS5oZWlnaHQpOwogICAgCiAgICAvKioKICAgICogVGhpcyBSZWN0YW5nbGUgb2JqZWN0IGZ1bGx5IGVuY29tcGFzc2VzIHRoZSBTcHJpdGUgYW5kIGlzIHVwZGF0ZWQgaW4gcmVhbC10aW1lLgogICAgKiBUaGUgYm91bmRzIGlzIHRoZSBmdWxsIGJvdW5kaW5nIGFyZWEgYWZ0ZXIgcm90YXRpb24gYW5kIHNjYWxlIGhhdmUgYmVlbiB0YWtlbiBpbnRvIGFjY291bnQuIEl0IHNob3VsZCBub3QgYmUgbW9kaWZpZWQgZGlyZWN0bHkuCiAgICAqIEl0J3MgdXNlZCBmb3IgQ2FtZXJhIGN1bGxpbmcgYW5kIHBoeXNpY3MgYm9keSBhbGlnbm1lbnQuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gYm91bmRzCiAgICAqLwogICAgdGhpcy5ib3VuZHMgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSh4LCB5LCB0aGlzLl9jYWNoZS53aWR0aCwgdGhpcy5fY2FjaGUuaGVpZ2h0KTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkgLSBCeSBkZWZhdWx0IFNwcml0ZXMgaGF2ZSBhIFBoYXNlci5QaHlzaWNzIEJvZHkgYXR0YWNoZWQgdG8gdGhlbS4gWW91IGNhbiBvcGVyYXRlIHBoeXNpY3MgYWN0aW9ucyB2aWEgdGhpcyBwcm9wZXJ0eSwgb3IgbnVsbCBpdCB0byBza2lwIGFsbCBwaHlzaWNzIHVwZGF0ZXMuCiAgICAqLwogICAgdGhpcy5ib2R5ID0gbmV3IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5KHRoaXMpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVhbHRoIC0gSGVhbHRoIHZhbHVlLiBVc2VkIGluIGNvbWJpbmF0aW9uIHdpdGggZGFtYWdlKCkgdG8gYWxsb3cgZm9yIHF1aWNrIGtpbGxpbmcgb2YgU3ByaXRlcy4KICAgICovCiAgICB0aGlzLmhlYWx0aCA9IDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaW5Xb3JsZCAtIFRoaXMgdmFsdWUgaXMgc2V0IHRvIHRydWUgaWYgdGhlIFNwcml0ZSBpcyBwb3NpdGlvbmVkIHdpdGhpbiB0aGUgV29ybGQsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICB0aGlzLmluV29ybGQgPSBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHModGhpcy5ib3VuZHMsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGluV29ybGRUaHJlc2hvbGQgLSBBIHRocmVzaG9sZCB2YWx1ZSBhcHBsaWVkIHRvIHRoZSBpbldvcmxkIGNoZWNrLiBJZiB5b3UgZG9uJ3Qgd2FudCBhIFNwcml0ZSB0byBiZSBjb25zaWRlcmVkICJvdXQgb2YgdGhlIHdvcmxkIiB1bnRpbCBhdCBsZWFzdCAxMDBweCBhd2F5IGZvciBleGFtcGxlIHRoZW4gc2V0IGl0IHRvIDEwMC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmluV29ybGRUaHJlc2hvbGQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG91dE9mQm91bmRzS2lsbCAtIElmIHRydWUgdGhlIFNwcml0ZSBpcyBraWxsZWQgYXMgc29vbiBhcyBTcHJpdGUuaW5Xb3JsZCBpcyBmYWxzZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm91dE9mQm91bmRzS2lsbCA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfb3V0T2ZCb3VuZHNGaXJlZCAtIEludGVybmFsIGZsYWcuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb3V0T2ZCb3VuZHNGaXJlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBBIFNwcml0ZSB0aGF0IGlzIGZpeGVkIHRvIHRoZSBjYW1lcmEgaWdub3JlcyB0aGUgcG9zaXRpb24gb2YgYW55IGFuY2VzdG9ycyBpbiB0aGUgZGlzcGxheSBsaXN0IGFuZCB1c2VzIGl0cyB4L3kgY29vcmRpbmF0ZXMgYXMgb2Zmc2V0cyBmcm9tIHRoZSB0b3AgbGVmdCBvZiB0aGUgY2FtZXJhLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZpeGVkVG9DYW1lcmEgLSBGaXhlcyB0aGlzIFNwcml0ZSB0byB0aGUgQ2FtZXJhLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZml4ZWRUb0NhbWVyYSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gY2FtZXJhT2Zmc2V0IC0gSWYgdGhpcyBTcHJpdGUgaXMgZml4ZWQgdG8gdGhlIGNhbWVyYSB0aGVuIHVzZSB0aGlzIFBvaW50IHRvIHNwZWNpZnkgaG93IGZhciBhd2F5IGZyb20gdGhlIENhbWVyYSB4L3kgaXQncyByZW5kZXJlZC4KICAgICovCiAgICB0aGlzLmNhbWVyYU9mZnNldCA9IG5ldyBQaGFzZXIuUG9pbnQoeCwgeSk7CgogICAgLyoqCiAgICAqIFlvdSBjYW4gY3JvcCB0aGUgU3ByaXRlcyB0ZXh0dXJlIGJ5IG1vZGlmeWluZyB0aGUgY3JvcCBwcm9wZXJ0aWVzLiBGb3IgZXhhbXBsZSBjcm9wLndpZHRoID0gNTAgd291bGQgc2V0IHRoZSBTcHJpdGUgdG8gb25seSByZW5kZXIgNTBweCB3aWRlLgogICAgKiBUaGUgY3JvcCBpcyBvbmx5IGFwcGxpZWQgaWYgeW91IGhhdmUgc2V0IFNwcml0ZS5jcm9wRW5hYmxlZCB0byB0cnVlLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IGNyb3AgLSBUaGUgY3JvcCBSZWN0YW5nbGUgYXBwbGllZCB0byB0aGUgU3ByaXRlIHRleHR1cmUgYmVmb3JlIHJlbmRlcmluZy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNyb3AgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgwLCAwLCB0aGlzLl9jYWNoZS53aWR0aCwgdGhpcy5fY2FjaGUuaGVpZ2h0KTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjcm9wRW5hYmxlZCAtIElmIHRydWUgdGhlIFNwcml0ZS5jcm9wIHByb3BlcnR5IGlzIHVzZWQgdG8gY3JvcCB0aGUgdGV4dHVyZSBiZWZvcmUgcmVuZGVyLiBTZXQgdG8gZmFsc2UgdG8gZGlzYWJsZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNyb3BFbmFibGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZGVidWcgLSBIYW5keSBmbGFnIHRvIHVzZSB3aXRoIEdhbWUuZW5hYmxlU3RlcAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGVidWcgPSBmYWxzZTsKCiAgICB0aGlzLnVwZGF0ZUNhY2hlKCk7CiAgICB0aGlzLnVwZGF0ZUJvdW5kcygpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BJWEkuUG9pbnR9IHBpdm90IC0gVGhlIHBpdm90IHBvaW50IG9mIHRoZSBkaXNwbGF5T2JqZWN0IHRoYXQgaXQgcm90YXRlcyBhcm91bmQuCiAgICAqLwoKfTsKCi8vICBOZWVkZWQgdG8ga2VlcCB0aGUgUElYSS5TcHJpdGUgY29uc3RydWN0b3IgaW4gdGhlIHByb3RvdHlwZSBjaGFpbiAoYXMgdGhlIGNvcmUgcGl4aSByZW5kZXJlciB1c2VzIGFuIGluc3RhbmNlb2YgY2hlY2sgc2FkbHkpClBoYXNlci5TcHJpdGUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLlNwcml0ZS5wcm90b3R5cGUpOwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5TcHJpdGU7CgovKioKKiBBdXRvbWF0aWNhbGx5IGNhbGxlZCBieSBXb3JsZC5wcmVVcGRhdGUuIEhhbmRsZXMgY2FjaGUgdXBkYXRlcywgbGlmZXNwYW4gY2hlY2tzLCBhbmltYXRpb24gdXBkYXRlcyBhbmQgcGh5c2ljcyB1cGRhdGVzLgoqCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3ByZVVwZGF0ZQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLnByZVVwZGF0ZSA9IGZ1bmN0aW9uKCkgewoKICAgIGlmICh0aGlzLl9jYWNoZS5mcmVzaCkKICAgIHsKICAgICAgICB0aGlzLndvcmxkLnNldFRvKHRoaXMucGFyZW50LnBvc2l0aW9uLnggKyB0aGlzLngsIHRoaXMucGFyZW50LnBvc2l0aW9uLnkgKyB0aGlzLnkpOwogICAgICAgIHRoaXMud29ybGRUcmFuc2Zvcm1bMl0gPSB0aGlzLndvcmxkLng7CiAgICAgICAgdGhpcy53b3JsZFRyYW5zZm9ybVs1XSA9IHRoaXMud29ybGQueTsKICAgICAgICB0aGlzLl9jYWNoZS5mcmVzaCA9IGZhbHNlOwoKICAgICAgICBpZiAodGhpcy5ib2R5KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5ib2R5LnggPSAodGhpcy53b3JsZC54IC0gKHRoaXMuYW5jaG9yLnggKiB0aGlzLndpZHRoKSkgKyB0aGlzLmJvZHkub2Zmc2V0Lng7CiAgICAgICAgICAgIHRoaXMuYm9keS55ID0gKHRoaXMud29ybGQueSAtICh0aGlzLmFuY2hvci55ICogdGhpcy5oZWlnaHQpKSArIHRoaXMuYm9keS5vZmZzZXQueTsKICAgICAgICAgICAgdGhpcy5ib2R5LnByZVggPSB0aGlzLmJvZHkueDsKICAgICAgICAgICAgdGhpcy5ib2R5LnByZVkgPSB0aGlzLmJvZHkueTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoIXRoaXMuZXhpc3RzIHx8ICh0aGlzLmdyb3VwICYmICF0aGlzLmdyb3VwLmV4aXN0cykpCiAgICB7CiAgICAgICAgdGhpcy5yZW5kZXJPcmRlcklEID0gLTE7CiAgICAgICAgCiAgICAgICAgLy8gU2tpcCBjaGlsZHJlbiBpZiBub3QgZXhpc3RzCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmICh0aGlzLmxpZmVzcGFuID4gMCkKICAgIHsKICAgICAgICB0aGlzLmxpZmVzcGFuIC09IHRoaXMuZ2FtZS50aW1lLmVsYXBzZWQ7CgogICAgICAgIGlmICh0aGlzLmxpZmVzcGFuIDw9IDApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmtpbGwoKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9jYWNoZS5kaXJ0eSA9IGZhbHNlOwoKICAgIGlmICh0aGlzLnZpc2libGUpCiAgICB7CiAgICAgICAgdGhpcy5yZW5kZXJPcmRlcklEID0gdGhpcy5nYW1lLndvcmxkLmN1cnJlbnRSZW5kZXJPcmRlcklEKys7CiAgICB9CgogICAgdGhpcy51cGRhdGVDYWNoZSgpOwoKICAgIHRoaXMudXBkYXRlQW5pbWF0aW9uKCk7CgogICAgdGhpcy51cGRhdGVDcm9wKCk7CgogICAgLy8gIFJlLXJ1biB0aGUgY2FtZXJhIHZpc2liaWxpdHkgY2hlY2sKICAgIGlmICh0aGlzLl9jYWNoZS5kaXJ0eSB8fCB0aGlzLndvcmxkLnggIT09IHRoaXMuX2NhY2hlLnByZXZYIHx8IHRoaXMud29ybGQueSAhPT0gdGhpcy5fY2FjaGUucHJldlkpCiAgICB7CiAgICAgICAgdGhpcy51cGRhdGVCb3VuZHMoKTsKICAgIH0KCiAgICBpZiAodGhpcy5ib2R5KQogICAgewogICAgICAgIHRoaXMuYm9keS5wcmVVcGRhdGUoKTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKCn07CgovKioKKiBJbnRlcm5hbCBmdW5jdGlvbiBjYWxsZWQgYnkgcHJlVXBkYXRlLgoqCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3VwZGF0ZUNhY2hlCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUudXBkYXRlQ2FjaGUgPSBmdW5jdGlvbigpIHsKCiAgICB0aGlzLl9jYWNoZS5wcmV2WCA9IHRoaXMud29ybGQueDsKICAgIHRoaXMuX2NhY2hlLnByZXZZID0gdGhpcy53b3JsZC55OwoKICAgIGlmICh0aGlzLmZpeGVkVG9DYW1lcmEpCiAgICB7CiAgICAgICAgdGhpcy54ID0gdGhpcy5nYW1lLmNhbWVyYS52aWV3LnggKyB0aGlzLmNhbWVyYU9mZnNldC54OwogICAgICAgIHRoaXMueSA9IHRoaXMuZ2FtZS5jYW1lcmEudmlldy55ICsgdGhpcy5jYW1lcmFPZmZzZXQueTsKICAgIH0KCiAgICB0aGlzLndvcmxkLnNldFRvKHRoaXMuZ2FtZS5jYW1lcmEueCArIHRoaXMud29ybGRUcmFuc2Zvcm1bMl0sIHRoaXMuZ2FtZS5jYW1lcmEueSArIHRoaXMud29ybGRUcmFuc2Zvcm1bNV0pOwoKICAgIGlmICh0aGlzLndvcmxkVHJhbnNmb3JtWzFdICE9IHRoaXMuX2NhY2hlLmkwMSB8fCB0aGlzLndvcmxkVHJhbnNmb3JtWzNdICE9IHRoaXMuX2NhY2hlLmkxMCB8fCB0aGlzLndvcmxkVHJhbnNmb3JtWzBdICE9IHRoaXMuX2NhY2hlLmEwMCB8fCB0aGlzLndvcmxkVHJhbnNmb3JtWzQxXSAhPSB0aGlzLl9jYWNoZS5hMTEpCiAgICB7CiAgICAgICAgdGhpcy5fY2FjaGUuYTAwID0gdGhpcy53b3JsZFRyYW5zZm9ybVswXTsgIC8vICBzY2FsZVggICAgICAgICBhICAgICB8YSBjIHR4fAogICAgICAgIHRoaXMuX2NhY2hlLmEwMSA9IHRoaXMud29ybGRUcmFuc2Zvcm1bMV07ICAvLyAgc2tld1kgICAgICAgICAgYyAgICAgfGIgZCB0eXwKICAgICAgICB0aGlzLl9jYWNoZS5hMTAgPSB0aGlzLndvcmxkVHJhbnNmb3JtWzNdOyAgLy8gIHNrZXdYICAgICAgICAgIGIgICAgIHwwIDAgIDF8CiAgICAgICAgdGhpcy5fY2FjaGUuYTExID0gdGhpcy53b3JsZFRyYW5zZm9ybVs0XTsgIC8vICBzY2FsZVkgICAgICAgICBkCgogICAgICAgIHRoaXMuX2NhY2hlLmkwMSA9IHRoaXMud29ybGRUcmFuc2Zvcm1bMV07ICAvLyAgc2tld1kgICAgICAgICAgYyAocmVtYWlucyBub24tbW9kaWZpZWQgZm9yIGlucHV0IGNoZWNrcykKICAgICAgICB0aGlzLl9jYWNoZS5pMTAgPSB0aGlzLndvcmxkVHJhbnNmb3JtWzNdOyAgLy8gIHNrZXdYICAgICAgICAgIGIgKHJlbWFpbnMgbm9uLW1vZGlmaWVkIGZvciBpbnB1dCBjaGVja3MpCgogICAgICAgIHRoaXMuX2NhY2hlLnNjYWxlWCA9IE1hdGguc3FydCgodGhpcy5fY2FjaGUuYTAwICogdGhpcy5fY2FjaGUuYTAwKSArICh0aGlzLl9jYWNoZS5hMDEgKiB0aGlzLl9jYWNoZS5hMDEpKTsgLy8gcm91bmQgdGhpcyBvZmYgYSBiaXQ/CiAgICAgICAgdGhpcy5fY2FjaGUuc2NhbGVZID0gTWF0aC5zcXJ0KCh0aGlzLl9jYWNoZS5hMTAgKiB0aGlzLl9jYWNoZS5hMTApICsgKHRoaXMuX2NhY2hlLmExMSAqIHRoaXMuX2NhY2hlLmExMSkpOyAvLyByb3VuZCB0aGlzIG9mZiBhIGJpdD8KCiAgICAgICAgdGhpcy5fY2FjaGUuYTAxICo9IC0xOwogICAgICAgIHRoaXMuX2NhY2hlLmExMCAqPSAtMTsKCiAgICAgICAgdGhpcy5fY2FjaGUuaWQgPSAxIC8gKHRoaXMuX2NhY2hlLmEwMCAqIHRoaXMuX2NhY2hlLmExMSArIHRoaXMuX2NhY2hlLmEwMSAqIC10aGlzLl9jYWNoZS5hMTApOwogICAgICAgIHRoaXMuX2NhY2hlLmlkaSA9IDEgLyAodGhpcy5fY2FjaGUuYTAwICogdGhpcy5fY2FjaGUuYTExICsgdGhpcy5fY2FjaGUuaTAxICogLXRoaXMuX2NhY2hlLmkxMCk7CgogICAgICAgIHRoaXMuX2NhY2hlLmRpcnR5ID0gdHJ1ZTsKICAgIH0KCiAgICB0aGlzLl9jYWNoZS5hMDIgPSB0aGlzLndvcmxkVHJhbnNmb3JtWzJdOyAgLy8gIHRyYW5zbGF0ZVggICAgIHR4CiAgICB0aGlzLl9jYWNoZS5hMTIgPSB0aGlzLndvcmxkVHJhbnNmb3JtWzVdOyAgLy8gIHRyYW5zbGF0ZVkgICAgIHR5Cgp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gY2FsbGVkIGJ5IHByZVVwZGF0ZS4KKgoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSN1cGRhdGVBbmltYXRpb24KKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS51cGRhdGVBbmltYXRpb24gPSBmdW5jdGlvbigpIHsKCiAgICBpZiAodGhpcy5hbmltYXRpb25zLnVwZGF0ZSgpIHx8ICh0aGlzLmN1cnJlbnRGcmFtZSAmJiB0aGlzLmN1cnJlbnRGcmFtZS51dWlkICE9IHRoaXMuX2NhY2hlLmZyYW1lSUQpKQogICAgewogICAgICAgIHRoaXMuX2NhY2hlLmZyYW1lSUQgPSB0aGlzLmN1cnJlbnRGcmFtZS51dWlkOwoKICAgICAgICB0aGlzLl9jYWNoZS5mcmFtZVdpZHRoID0gdGhpcy50ZXh0dXJlLmZyYW1lLndpZHRoOwogICAgICAgIHRoaXMuX2NhY2hlLmZyYW1lSGVpZ2h0ID0gdGhpcy50ZXh0dXJlLmZyYW1lLmhlaWdodDsKCiAgICAgICAgdGhpcy5fY2FjaGUud2lkdGggPSB0aGlzLmN1cnJlbnRGcmFtZS53aWR0aDsKICAgICAgICB0aGlzLl9jYWNoZS5oZWlnaHQgPSB0aGlzLmN1cnJlbnRGcmFtZS5oZWlnaHQ7CgogICAgICAgIHRoaXMuX2NhY2hlLmhhbGZXaWR0aCA9IE1hdGguZmxvb3IodGhpcy5fY2FjaGUud2lkdGggLyAyKTsKICAgICAgICB0aGlzLl9jYWNoZS5oYWxmSGVpZ2h0ID0gTWF0aC5mbG9vcih0aGlzLl9jYWNoZS5oZWlnaHQgLyAyKTsKCiAgICAgICAgdGhpcy5fY2FjaGUuZGlydHkgPSB0cnVlOwogICAgfQoKfTsKCi8qKgoqIEludGVybmFsIGZ1bmN0aW9uIGNhbGxlZCBieSBwcmVVcGRhdGUuCioKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjdXBkYXRlQ3JvcAoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLnVwZGF0ZUNyb3AgPSBmdW5jdGlvbigpIHsKCiAgICAvLyAgVGhpcyBvbmx5IHJ1bnMgaWYgY3JvcCBpcyBlbmFibGVkCiAgICBpZiAodGhpcy5jcm9wRW5hYmxlZCAmJiAodGhpcy5jcm9wLndpZHRoICE9IHRoaXMuX2NhY2hlLmNyb3BXaWR0aCB8fCB0aGlzLmNyb3AuaGVpZ2h0ICE9IHRoaXMuX2NhY2hlLmNyb3BIZWlnaHQgfHwgdGhpcy5jcm9wLnggIT0gdGhpcy5fY2FjaGUuY3JvcFggfHwgdGhpcy5jcm9wLnkgIT0gdGhpcy5fY2FjaGUuY3JvcFkpKQogICAgewogICAgICAgIHRoaXMuY3JvcC5mbG9vckFsbCgpOwoKICAgICAgICB0aGlzLl9jYWNoZS5jcm9wWCA9IHRoaXMuY3JvcC54OwogICAgICAgIHRoaXMuX2NhY2hlLmNyb3BZID0gdGhpcy5jcm9wLnk7CiAgICAgICAgdGhpcy5fY2FjaGUuY3JvcFdpZHRoID0gdGhpcy5jcm9wLndpZHRoOwogICAgICAgIHRoaXMuX2NhY2hlLmNyb3BIZWlnaHQgPSB0aGlzLmNyb3AuaGVpZ2h0OwoKICAgICAgICB0aGlzLnRleHR1cmUuZnJhbWUgPSB0aGlzLmNyb3A7CiAgICAgICAgdGhpcy50ZXh0dXJlLndpZHRoID0gdGhpcy5jcm9wLndpZHRoOwogICAgICAgIHRoaXMudGV4dHVyZS5oZWlnaHQgPSB0aGlzLmNyb3AuaGVpZ2h0OwoKICAgICAgICB0aGlzLnRleHR1cmUudXBkYXRlRnJhbWUgPSB0cnVlOwoKICAgICAgICBQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzLnB1c2godGhpcy50ZXh0dXJlKTsKICAgIH0KCn07CgovKioKKiBJbnRlcm5hbCBmdW5jdGlvbiBjYWxsZWQgYnkgcHJlVXBkYXRlLgoqCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3VwZGF0ZUJvdW5kcwoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLnVwZGF0ZUJvdW5kcyA9IGZ1bmN0aW9uKCkgewoKICAgIHRoaXMub2Zmc2V0LnNldFRvKHRoaXMuX2NhY2hlLmEwMiAtICh0aGlzLmFuY2hvci54ICogdGhpcy53aWR0aCksIHRoaXMuX2NhY2hlLmExMiAtICh0aGlzLmFuY2hvci55ICogdGhpcy5oZWlnaHQpKTsKCiAgICB0aGlzLmdldExvY2FsUG9zaXRpb24odGhpcy5jZW50ZXIsIHRoaXMub2Zmc2V0LnggKyAodGhpcy53aWR0aCAvIDIpLCB0aGlzLm9mZnNldC55ICsgKHRoaXMuaGVpZ2h0IC8gMikpOwogICAgdGhpcy5nZXRMb2NhbFBvc2l0aW9uKHRoaXMudG9wTGVmdCwgdGhpcy5vZmZzZXQueCwgdGhpcy5vZmZzZXQueSk7CiAgICB0aGlzLmdldExvY2FsUG9zaXRpb24odGhpcy50b3BSaWdodCwgdGhpcy5vZmZzZXQueCArIHRoaXMud2lkdGgsIHRoaXMub2Zmc2V0LnkpOwogICAgdGhpcy5nZXRMb2NhbFBvc2l0aW9uKHRoaXMuYm90dG9tTGVmdCwgdGhpcy5vZmZzZXQueCwgdGhpcy5vZmZzZXQueSArIHRoaXMuaGVpZ2h0KTsKICAgIHRoaXMuZ2V0TG9jYWxQb3NpdGlvbih0aGlzLmJvdHRvbVJpZ2h0LCB0aGlzLm9mZnNldC54ICsgdGhpcy53aWR0aCwgdGhpcy5vZmZzZXQueSArIHRoaXMuaGVpZ2h0KTsKCiAgICB0aGlzLl9jYWNoZS5sZWZ0ID0gUGhhc2VyLk1hdGgubWluKHRoaXMudG9wTGVmdC54LCB0aGlzLnRvcFJpZ2h0LngsIHRoaXMuYm90dG9tTGVmdC54LCB0aGlzLmJvdHRvbVJpZ2h0LngpOwogICAgdGhpcy5fY2FjaGUucmlnaHQgPSBQaGFzZXIuTWF0aC5tYXgodGhpcy50b3BMZWZ0LngsIHRoaXMudG9wUmlnaHQueCwgdGhpcy5ib3R0b21MZWZ0LngsIHRoaXMuYm90dG9tUmlnaHQueCk7CiAgICB0aGlzLl9jYWNoZS50b3AgPSBQaGFzZXIuTWF0aC5taW4odGhpcy50b3BMZWZ0LnksIHRoaXMudG9wUmlnaHQueSwgdGhpcy5ib3R0b21MZWZ0LnksIHRoaXMuYm90dG9tUmlnaHQueSk7CiAgICB0aGlzLl9jYWNoZS5ib3R0b20gPSBQaGFzZXIuTWF0aC5tYXgodGhpcy50b3BMZWZ0LnksIHRoaXMudG9wUmlnaHQueSwgdGhpcy5ib3R0b21MZWZ0LnksIHRoaXMuYm90dG9tUmlnaHQueSk7CgogICAgdGhpcy5ib3VuZHMuc2V0VG8odGhpcy5fY2FjaGUubGVmdCwgdGhpcy5fY2FjaGUudG9wLCB0aGlzLl9jYWNoZS5yaWdodCAtIHRoaXMuX2NhY2hlLmxlZnQsIHRoaXMuX2NhY2hlLmJvdHRvbSAtIHRoaXMuX2NhY2hlLnRvcCk7CgogICAgdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7CgogICAgaWYgKHRoaXMuaW5Xb3JsZCA9PT0gZmFsc2UpCiAgICB7CiAgICAgICAgLy8gIFNwcml0ZSBXQVMgb3V0IG9mIHRoZSBzY3JlZW4sIGlzIGl0IHN0aWxsPwogICAgICAgIHRoaXMuaW5Xb3JsZCA9IFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cyh0aGlzLmJvdW5kcywgdGhpcy5nYW1lLndvcmxkLmJvdW5kcywgdGhpcy5pbldvcmxkVGhyZXNob2xkKTsKCiAgICAgICAgaWYgKHRoaXMuaW5Xb3JsZCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBJdCdzIGJhY2sgYWdhaW4sIHJlc2V0IHRoZSBPT0IgY2hlY2sKICAgICAgICAgICAgdGhpcy5fb3V0T2ZCb3VuZHNGaXJlZCA9IGZhbHNlOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICAvLyAgIFNwcml0ZSBXQVMgaW4gdGhlIHNjcmVlbiwgaGFzIGl0IG5vdyBsZWZ0PwogICAgICAgIHRoaXMuaW5Xb3JsZCA9IFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cyh0aGlzLmJvdW5kcywgdGhpcy5nYW1lLndvcmxkLmJvdW5kcywgdGhpcy5pbldvcmxkVGhyZXNob2xkKTsKCiAgICAgICAgaWYgKHRoaXMuaW5Xb3JsZCA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmV2ZW50cy5vbk91dE9mQm91bmRzLmRpc3BhdGNoKHRoaXMpOwogICAgICAgICAgICB0aGlzLl9vdXRPZkJvdW5kc0ZpcmVkID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmICh0aGlzLm91dE9mQm91bmRzS2lsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5raWxsKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgdGhpcy5fY2FjaGUuY2FtZXJhVmlzaWJsZSA9IFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cyh0aGlzLmdhbWUud29ybGQuY2FtZXJhLnNjcmVlblZpZXcsIHRoaXMuYm91bmRzLCAwKTsKCiAgICBpZiAodGhpcy5hdXRvQ3VsbCkKICAgIHsKICAgICAgICAvLyAgV29uJ3QgZ2V0IHJlbmRlcmVkIGJ1dCB3aWxsIHN0aWxsIGdldCBpdHMgdHJhbnNmb3JtIHVwZGF0ZWQKICAgICAgICB0aGlzLnJlbmRlcmFibGUgPSB0aGlzLl9jYWNoZS5jYW1lcmFWaXNpYmxlOwogICAgfQoKfTsKCi8qKgoqIEdldHMgdGhlIGxvY2FsIHBvc2l0aW9uIG9mIGEgY29vcmRpbmF0ZSByZWxhdGl2ZSB0byB0aGUgU3ByaXRlLCBmYWN0b3JpbmcgaW4gcm90YXRpb24gYW5kIHNjYWxlLgoqIE1vc3RseSBvbmx5IHVzZWQgaW50ZXJuYWxseS4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjZ2V0TG9jYWxQb3NpdGlvbgoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IHAgLSBUaGUgUG9pbnQgb2JqZWN0IHRvIHN0b3JlIHRoZSByZXN1bHRzIGluLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0geCBjb29yZGluYXRlIHdpdGhpbiB0aGUgU3ByaXRlIHRvIHRyYW5zbGF0ZS4KKiBAcGFyYW0ge251bWJlcn0geSAtIHkgY29vcmRpbmF0ZSB3aXRoaW4gdGhlIFNwcml0ZSB0byB0cmFuc2xhdGUuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgdHJhbnNsYXRlZCBwb2ludC4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUuZ2V0TG9jYWxQb3NpdGlvbiA9IGZ1bmN0aW9uKHAsIHgsIHkpIHsKCiAgICBwLnggPSAoKHRoaXMuX2NhY2hlLmExMSAqIHRoaXMuX2NhY2hlLmlkICogeCArIC10aGlzLl9jYWNoZS5hMDEgKiB0aGlzLl9jYWNoZS5pZCAqIHkgKyAodGhpcy5fY2FjaGUuYTEyICogdGhpcy5fY2FjaGUuYTAxIC0gdGhpcy5fY2FjaGUuYTAyICogdGhpcy5fY2FjaGUuYTExKSAqIHRoaXMuX2NhY2hlLmlkKSAqIHRoaXMuc2NhbGUueCkgKyB0aGlzLl9jYWNoZS5hMDI7CiAgICBwLnkgPSAoKHRoaXMuX2NhY2hlLmEwMCAqIHRoaXMuX2NhY2hlLmlkICogeSArIC10aGlzLl9jYWNoZS5hMTAgKiB0aGlzLl9jYWNoZS5pZCAqIHggKyAoLXRoaXMuX2NhY2hlLmExMiAqIHRoaXMuX2NhY2hlLmEwMCArIHRoaXMuX2NhY2hlLmEwMiAqIHRoaXMuX2NhY2hlLmExMCkgKiB0aGlzLl9jYWNoZS5pZCkgKiB0aGlzLnNjYWxlLnkpICsgdGhpcy5fY2FjaGUuYTEyOwoKICAgIHJldHVybiBwOwoKfTsKCi8qKgoqIEdldHMgdGhlIGxvY2FsIHVubW9kaWZpZWQgcG9zaXRpb24gb2YgYSBjb29yZGluYXRlIHJlbGF0aXZlIHRvIHRoZSBTcHJpdGUsIGZhY3RvcmluZyBpbiByb3RhdGlvbiBhbmQgc2NhbGUuCiogTW9zdGx5IG9ubHkgdXNlZCBpbnRlcm5hbGx5IGJ5IHRoZSBJbnB1dCBNYW5hZ2VyLCBidXQgYWxzbyB1c2VmdWwgZm9yIGN1c3RvbSBoaXQgZGV0ZWN0aW9uLgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNnZXRMb2NhbFVubW9kaWZpZWRQb3NpdGlvbgoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IHAgLSBUaGUgUG9pbnQgb2JqZWN0IHRvIHN0b3JlIHRoZSByZXN1bHRzIGluLgoqIEBwYXJhbSB7bnVtYmVyfSBneCAtIHggY29vcmRpbmF0ZSB3aXRoaW4gdGhlIFNwcml0ZSB0byB0cmFuc2xhdGUuCiogQHBhcmFtIHtudW1iZXJ9IGd5IC0geSBjb29yZGluYXRlIHdpdGhpbiB0aGUgU3ByaXRlIHRvIHRyYW5zbGF0ZS4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSB0cmFuc2xhdGVkIHBvaW50LgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5nZXRMb2NhbFVubW9kaWZpZWRQb3NpdGlvbiA9IGZ1bmN0aW9uKHAsIGd4LCBneSkgewoKICAgIHAueCA9ICh0aGlzLl9jYWNoZS5hMTEgKiB0aGlzLl9jYWNoZS5pZGkgKiBneCArIC10aGlzLl9jYWNoZS5pMDEgKiB0aGlzLl9jYWNoZS5pZGkgKiBneSArICh0aGlzLl9jYWNoZS5hMTIgKiB0aGlzLl9jYWNoZS5pMDEgLSB0aGlzLl9jYWNoZS5hMDIgKiB0aGlzLl9jYWNoZS5hMTEpICogdGhpcy5fY2FjaGUuaWRpKSArICh0aGlzLmFuY2hvci54ICogdGhpcy5fY2FjaGUud2lkdGgpOwogICAgcC55ID0gKHRoaXMuX2NhY2hlLmEwMCAqIHRoaXMuX2NhY2hlLmlkaSAqIGd5ICsgLXRoaXMuX2NhY2hlLmkxMCAqIHRoaXMuX2NhY2hlLmlkaSAqIGd4ICsgKC10aGlzLl9jYWNoZS5hMTIgKiB0aGlzLl9jYWNoZS5hMDAgKyB0aGlzLl9jYWNoZS5hMDIgKiB0aGlzLl9jYWNoZS5pMTApICogdGhpcy5fY2FjaGUuaWRpKSArICh0aGlzLmFuY2hvci55ICogdGhpcy5fY2FjaGUuaGVpZ2h0KTsKCiAgICByZXR1cm4gcDsKCn07CgovKioKKiBSZXNldHMgdGhlIFNwcml0ZS5jcm9wIHZhbHVlIGJhY2sgdG8gdGhlIGZyYW1lIGRpbWVuc2lvbnMuCioKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjcmVzZXRDcm9wCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUucmVzZXRDcm9wID0gZnVuY3Rpb24oKSB7CgogICAgdGhpcy5jcm9wID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoMCwgMCwgdGhpcy5fY2FjaGUud2lkdGgsIHRoaXMuX2NhY2hlLmhlaWdodCk7CiAgICB0aGlzLnRleHR1cmUuc2V0RnJhbWUodGhpcy5jcm9wKTsKICAgIHRoaXMuY3JvcEVuYWJsZWQgPSBmYWxzZTsKCn07CgovKioKKiBJbnRlcm5hbCBmdW5jdGlvbiBjYWxsZWQgYnkgdGhlIFdvcmxkIHBvc3RVcGRhdGUgY3ljbGUuCioKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjcG9zdFVwZGF0ZQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLnBvc3RVcGRhdGUgPSBmdW5jdGlvbigpIHsKCiAgICBpZiAodGhpcy5rZXkgaW5zdGFuY2VvZiBQaGFzZXIuQml0bWFwRGF0YSAmJiB0aGlzLmtleS5fZGlydHkpCiAgICB7CiAgICAgICAgdGhpcy5rZXkucmVuZGVyKCk7CiAgICB9CgogICAgaWYgKHRoaXMuZXhpc3RzKQogICAgewogICAgICAgIGlmICh0aGlzLmJvZHkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJvZHkucG9zdFVwZGF0ZSgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZml4ZWRUb0NhbWVyYSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2NhY2hlLnggPSB0aGlzLmdhbWUuY2FtZXJhLnZpZXcueCArIHRoaXMuY2FtZXJhT2Zmc2V0Lng7CiAgICAgICAgICAgIHRoaXMuX2NhY2hlLnkgPSB0aGlzLmdhbWUuY2FtZXJhLnZpZXcueSArIHRoaXMuY2FtZXJhT2Zmc2V0Lnk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2NhY2hlLnggPSB0aGlzLng7CiAgICAgICAgICAgIHRoaXMuX2NhY2hlLnkgPSB0aGlzLnk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnBvc2l0aW9uLnggPSB0aGlzLl9jYWNoZS54OwogICAgICAgIHRoaXMucG9zaXRpb24ueSA9IHRoaXMuX2NhY2hlLnk7CiAgICB9Cgp9OwoKLyoqCiogQ2hhbmdlcyB0aGUgVGV4dHVyZSB0aGUgU3ByaXRlIGlzIHVzaW5nIGVudGlyZWx5LiBUaGUgb2xkIHRleHR1cmUgaXMgcmVtb3ZlZCBhbmQgdGhlIG5ldyBvbmUgaXMgcmVmZXJlbmNlZCBvciBmZXRjaGVkIGZyb20gdGhlIENhY2hlLgoqIFRoaXMgY2F1c2VzIGEgV2ViR0wgdGV4dHVyZSB1cGRhdGUsIHNvIHVzZSBzcGFyaW5nbHkgb3IgaW4gbG93LWludGVuc2l0eSBwb3J0aW9ucyBvZiB5b3VyIGdhbWUuCioKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjbG9hZFRleHR1cmUKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqIEBwYXJhbSB7c3RyaW5nfFBoYXNlci5SZW5kZXJUZXh0dXJlfFBoYXNlci5CaXRtYXBEYXRhfFBJWEkuVGV4dHVyZX0ga2V5IC0gVGhpcyBpcyB0aGUgaW1hZ2Ugb3IgdGV4dHVyZSB1c2VkIGJ5IHRoZSBTcHJpdGUgZHVyaW5nIHJlbmRlcmluZy4gSXQgY2FuIGJlIGEgc3RyaW5nIHdoaWNoIGlzIGEgcmVmZXJlbmNlIHRvIHRoZSBDYWNoZSBlbnRyeSwgb3IgYW4gaW5zdGFuY2Ugb2YgYSBSZW5kZXJUZXh0dXJlLCBCaXRtYXBEYXRhIG9yIFBJWEkuVGV4dHVyZS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGZyYW1lIC0gSWYgdGhpcyBTcHJpdGUgaXMgdXNpbmcgcGFydCBvZiBhIHNwcml0ZSBzaGVldCBvciB0ZXh0dXJlIGF0bGFzIHlvdSBjYW4gc3BlY2lmeSB0aGUgZXhhY3QgZnJhbWUgdG8gdXNlIGJ5IGdpdmluZyBhIHN0cmluZyBvciBudW1lcmljIGluZGV4LgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5sb2FkVGV4dHVyZSA9IGZ1bmN0aW9uIChrZXksIGZyYW1lKSB7CgogICAgdGhpcy5rZXkgPSBrZXk7CgogICAgaWYgKGtleSBpbnN0YW5jZW9mIFBoYXNlci5SZW5kZXJUZXh0dXJlKQogICAgewogICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5nYW1lLmNhY2hlLmdldFRleHR1cmVGcmFtZShrZXkubmFtZSk7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgaW5zdGFuY2VvZiBQaGFzZXIuQml0bWFwRGF0YSkKICAgIHsKICAgICAgICB0aGlzLnNldFRleHR1cmUoa2V5LnRleHR1cmUpOwogICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0ga2V5LnRleHR1cmVGcmFtZTsKICAgIH0KICAgIGVsc2UgaWYgKGtleSBpbnN0YW5jZW9mIFBJWEkuVGV4dHVyZSkKICAgIHsKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IGZyYW1lOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAndW5kZWZpbmVkJyB8fCB0aGlzLmdhbWUuY2FjaGUuY2hlY2tJbWFnZUtleShrZXkpID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIGtleSA9ICdfX2RlZmF1bHQnOwogICAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuY2FjaGUuaXNTcHJpdGVTaGVldChrZXkpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRpb25zLmxvYWRGcmFtZURhdGEodGhpcy5nYW1lLmNhY2hlLmdldEZyYW1lRGF0YShrZXkpKTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgZnJhbWUgIT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZyYW1lID09PSAnc3RyaW5nJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IGZyYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZnJhbWUgPSBmcmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRGcmFtZShrZXkpOwogICAgICAgICAgICB0aGlzLnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVba2V5XSk7CiAgICAgICAgfQogICAgfQoKfTsKCi8qKgoqIE1vdmVzIHRoZSBzcHJpdGUgc28gaXRzIGNlbnRlciBpcyBsb2NhdGVkIG9uIHRoZSBnaXZlbiB4IGFuZCB5IGNvb3JkaW5hdGVzLgoqIERvZXNuJ3QgY2hhbmdlIHRoZSBhbmNob3IgcG9pbnQgb2YgdGhlIHNwcml0ZS4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjY2VudGVyT24KKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSAoaW4gd29ybGQgc3BhY2UpIHRvIHBvc2l0aW9uIHRoZSBTcHJpdGUgYXQuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIChpbiB3b3JsZCBzcGFjZSkgdG8gcG9zaXRpb24gdGhlIFNwcml0ZSBhdC4KKiBAcmV0dXJuIChQaGFzZXIuU3ByaXRlKSBUaGlzIGluc3RhbmNlLgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5jZW50ZXJPbiA9IGZ1bmN0aW9uKHgsIHkpIHsKCiAgICBpZiAodGhpcy5maXhlZFRvQ2FtZXJhKQogICAgewogICAgICAgIHRoaXMuY2FtZXJhT2Zmc2V0LnggPSB4ICsgKHRoaXMuY2FtZXJhT2Zmc2V0LnggLSB0aGlzLmNlbnRlci54KTsKICAgICAgICB0aGlzLmNhbWVyYU9mZnNldC55ID0geSArICh0aGlzLmNhbWVyYU9mZnNldC55IC0gdGhpcy5jZW50ZXIueSk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy54ID0geCArICh0aGlzLnggLSB0aGlzLmNlbnRlci54KTsKICAgICAgICB0aGlzLnkgPSB5ICsgKHRoaXMueSAtIHRoaXMuY2VudGVyLnkpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwoKfTsKCi8qKgoqIEJyaW5ncyBhICdkZWFkJyBTcHJpdGUgYmFjayB0byBsaWZlLCBvcHRpb25hbGx5IGdpdmluZyBpdCB0aGUgaGVhbHRoIHZhbHVlIHNwZWNpZmllZC4KKiBBIHJlc3VycmVjdGVkIFNwcml0ZSBoYXMgaXRzIGFsaXZlLCBleGlzdHMgYW5kIHZpc2libGUgcHJvcGVydGllcyBhbGwgc2V0IHRvIHRydWUuCiogSXQgd2lsbCBkaXNwYXRjaCB0aGUgb25SZXZpdmVkIGV2ZW50LCB5b3UgY2FuIGxpc3RlbiB0byBTcHJpdGUuZXZlbnRzLm9uUmV2aXZlZCBmb3IgdGhlIHNpZ25hbC4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjcmV2aXZlCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcGFyYW0ge251bWJlcn0gW2hlYWx0aD0xXSAtIFRoZSBoZWFsdGggdG8gZ2l2ZSB0aGUgU3ByaXRlLgoqIEByZXR1cm4gKFBoYXNlci5TcHJpdGUpIFRoaXMgaW5zdGFuY2UuCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLnJldml2ZSA9IGZ1bmN0aW9uKGhlYWx0aCkgewoKICAgIGlmICh0eXBlb2YgaGVhbHRoID09PSAndW5kZWZpbmVkJykgeyBoZWFsdGggPSAxOyB9CgogICAgdGhpcy5hbGl2ZSA9IHRydWU7CiAgICB0aGlzLmV4aXN0cyA9IHRydWU7CiAgICB0aGlzLnZpc2libGUgPSB0cnVlOwogICAgdGhpcy5oZWFsdGggPSBoZWFsdGg7CgogICAgaWYgKHRoaXMuZXZlbnRzKQogICAgewogICAgICAgIHRoaXMuZXZlbnRzLm9uUmV2aXZlZC5kaXNwYXRjaCh0aGlzKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKCn07CgovKioKKiBLaWxscyBhIFNwcml0ZS4gQSBraWxsZWQgU3ByaXRlIGhhcyBpdHMgYWxpdmUsIGV4aXN0cyBhbmQgdmlzaWJsZSBwcm9wZXJ0aWVzIGFsbCBzZXQgdG8gZmFsc2UuCiogSXQgd2lsbCBkaXNwYXRjaCB0aGUgb25LaWxsZWQgZXZlbnQsIHlvdSBjYW4gbGlzdGVuIHRvIFNwcml0ZS5ldmVudHMub25LaWxsZWQgZm9yIHRoZSBzaWduYWwuCiogTm90ZSB0aGF0IGtpbGxpbmcgYSBTcHJpdGUgaXMgYSB3YXkgZm9yIHlvdSB0byBxdWlja2x5IHJlY3ljbGUgaXQgaW4gYSBTcHJpdGUgcG9vbCwgaXQgZG9lc24ndCBmcmVlIGl0IHVwIGZyb20gbWVtb3J5LgoqIElmIHlvdSBkb24ndCBuZWVkIHRoaXMgU3ByaXRlIGFueSBtb3JlIHlvdSBzaG91bGQgY2FsbCBTcHJpdGUuZGVzdHJveSBpbnN0ZWFkLgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNraWxsCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcmV0dXJuIChQaGFzZXIuU3ByaXRlKSBUaGlzIGluc3RhbmNlLgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5raWxsID0gZnVuY3Rpb24oKSB7CgogICAgdGhpcy5hbGl2ZSA9IGZhbHNlOwogICAgdGhpcy5leGlzdHMgPSBmYWxzZTsKICAgIHRoaXMudmlzaWJsZSA9IGZhbHNlOwoKICAgIGlmICh0aGlzLmV2ZW50cykKICAgIHsKICAgICAgICB0aGlzLmV2ZW50cy5vbktpbGxlZC5kaXNwYXRjaCh0aGlzKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKCn07CgovKioKKiBEZXN0cm95cyB0aGUgU3ByaXRlLiBUaGlzIHJlbW92ZXMgaXQgZnJvbSBpdHMgcGFyZW50IGdyb3VwLCBkZXN0cm95cyB0aGUgaW5wdXQsIGV2ZW50IGFuZCBhbmltYXRpb24gaGFuZGxlcnMgaWYgcHJlc2VudAoqIGFuZCBudWxscyBpdHMgcmVmZXJlbmNlIHRvIGdhbWUsIGZyZWVpbmcgaXQgdXAgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbi4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjZGVzdHJveQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCiAgICBpZiAodGhpcy5maWx0ZXJzKQogICAgewogICAgICAgIHRoaXMuZmlsdGVycyA9IG51bGw7CiAgICB9CgogICAgaWYgKHRoaXMuZ3JvdXApCiAgICB7CiAgICAgICAgdGhpcy5ncm91cC5yZW1vdmUodGhpcyk7CiAgICB9CgogICAgaWYgKHRoaXMuaW5wdXQpCiAgICB7CiAgICAgICAgdGhpcy5pbnB1dC5kZXN0cm95KCk7CiAgICB9CgogICAgaWYgKHRoaXMuZXZlbnRzKQogICAgewogICAgICAgIHRoaXMuZXZlbnRzLmRlc3Ryb3koKTsKICAgIH0KCiAgICBpZiAodGhpcy5hbmltYXRpb25zKQogICAgewogICAgICAgIHRoaXMuYW5pbWF0aW9ucy5kZXN0cm95KCk7CiAgICB9CgogICAgaWYgKHRoaXMuYm9keSkKICAgIHsKICAgICAgICB0aGlzLmJvZHkuZGVzdHJveSgpOwogICAgfQoKICAgIHRoaXMuYWxpdmUgPSBmYWxzZTsKICAgIHRoaXMuZXhpc3RzID0gZmFsc2U7CiAgICB0aGlzLnZpc2libGUgPSBmYWxzZTsKCiAgICB0aGlzLmdhbWUgPSBudWxsOwoKfTsKCi8qKgoqIERhbWFnZXMgdGhlIFNwcml0ZSwgdGhpcyByZW1vdmVzIHRoZSBnaXZlbiBhbW91bnQgZnJvbSB0aGUgU3ByaXRlcyBoZWFsdGggcHJvcGVydHkuCiogSWYgaGVhbHRoIGlzIHRoZW4gdGFrZW4gYmVsb3cgemVybyBTcHJpdGUua2lsbCBpcyBjYWxsZWQuCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI2RhbWFnZQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gc3VidHJhY3QgZnJvbSB0aGUgU3ByaXRlLmhlYWx0aCB2YWx1ZS4KKiBAcmV0dXJuIChQaGFzZXIuU3ByaXRlKSBUaGlzIGluc3RhbmNlLgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5kYW1hZ2UgPSBmdW5jdGlvbihhbW91bnQpIHsKCiAgICBpZiAodGhpcy5hbGl2ZSkKICAgIHsKICAgICAgICB0aGlzLmhlYWx0aCAtPSBhbW91bnQ7CgogICAgICAgIGlmICh0aGlzLmhlYWx0aCA8IDApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmtpbGwoKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cgp9OwoKLyoqCiogUmVzZXRzIHRoZSBTcHJpdGUuIFRoaXMgcGxhY2VzIHRoZSBTcHJpdGUgYXQgdGhlIGdpdmVuIHgveSB3b3JsZCBjb29yZGluYXRlcyBhbmQgdGhlbgoqIHNldHMgYWxpdmUsIGV4aXN0cywgdmlzaWJsZSBhbmQgcmVuZGVyYWJsZSBhbGwgdG8gdHJ1ZS4gQWxzbyByZXNldHMgdGhlIG91dE9mQm91bmRzIHN0YXRlIGFuZCBoZWFsdGggdmFsdWVzLgoqIElmIHRoZSBTcHJpdGUgaGFzIGEgcGh5c2ljcyBib2R5IHRoYXQgdG9vIGlzIHJlc2V0LgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNyZXNldAoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIChpbiB3b3JsZCBzcGFjZSkgdG8gcG9zaXRpb24gdGhlIFNwcml0ZSBhdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgKGluIHdvcmxkIHNwYWNlKSB0byBwb3NpdGlvbiB0aGUgU3ByaXRlIGF0LgoqIEBwYXJhbSB7bnVtYmVyfSBbaGVhbHRoPTFdIC0gVGhlIGhlYWx0aCB0byBnaXZlIHRoZSBTcHJpdGUuCiogQHJldHVybiAoUGhhc2VyLlNwcml0ZSkgVGhpcyBpbnN0YW5jZS4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbih4LCB5LCBoZWFsdGgpIHsKCiAgICBpZiAodHlwZW9mIGhlYWx0aCA9PT0gJ3VuZGVmaW5lZCcpIHsgaGVhbHRoID0gMTsgfQoKICAgIHRoaXMueCA9IHg7CiAgICB0aGlzLnkgPSB5OwogICAgdGhpcy53b3JsZC5zZXRUbyh4LCB5KTsKICAgIHRoaXMucG9zaXRpb24ueCA9IHRoaXMueDsKICAgIHRoaXMucG9zaXRpb24ueSA9IHRoaXMueTsKICAgIHRoaXMuYWxpdmUgPSB0cnVlOwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwogICAgdGhpcy52aXNpYmxlID0gdHJ1ZTsKICAgIHRoaXMucmVuZGVyYWJsZSA9IHRydWU7CiAgICB0aGlzLl9vdXRPZkJvdW5kc0ZpcmVkID0gZmFsc2U7CgogICAgdGhpcy5oZWFsdGggPSBoZWFsdGg7CgogICAgaWYgKHRoaXMuYm9keSkKICAgIHsKICAgICAgICB0aGlzLmJvZHkucmVzZXQoZmFsc2UpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogICAgCn07CgovKioKKiBCcmluZ3MgdGhlIFNwcml0ZSB0byB0aGUgdG9wIG9mIHRoZSBkaXNwbGF5IGxpc3QgaXQgaXMgYSBjaGlsZCBvZi4gU3ByaXRlcyB0aGF0IGFyZSBtZW1iZXJzIG9mIGEgUGhhc2VyLkdyb3VwIGFyZSBvbmx5CiogYm91Z2h0IHRvIHRoZSB0b3Agb2YgdGhhdCBHcm91cCwgbm90IHRoZSBlbnRpcmUgZGlzcGxheSBsaXN0LgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNicmluZ1RvVG9wCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcmV0dXJuIChQaGFzZXIuU3ByaXRlKSBUaGlzIGluc3RhbmNlLgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5icmluZ1RvVG9wID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKHRoaXMuZ3JvdXApCiAgICB7CiAgICAgICAgdGhpcy5ncm91cC5icmluZ1RvVG9wKHRoaXMpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMuZ2FtZS53b3JsZC5icmluZ1RvVG9wKHRoaXMpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwoKfTsKCi8qKgoqIFBsYXkgYW4gYW5pbWF0aW9uIGJhc2VkIG9uIHRoZSBnaXZlbiBrZXkuIFRoZSBhbmltYXRpb24gc2hvdWxkIHByZXZpb3VzbHkgaGF2ZSBiZWVuIGFkZGVkIHZpYSBzcHJpdGUuYW5pbWF0aW9ucy5hZGQoKQoqIElmIHRoZSByZXF1ZXN0ZWQgYW5pbWF0aW9uIGlzIGFscmVhZHkgcGxheWluZyB0aGlzIHJlcXVlc3Qgd2lsbCBiZSBpZ25vcmVkLiBJZiB5b3UgbmVlZCB0byByZXNldCBhbiBhbHJlYWR5IHJ1bm5pbmcgYW5pbWF0aW9uIGRvIHNvIGRpcmVjdGx5IG9uIHRoZSBBbmltYXRpb24gb2JqZWN0IGl0c2VsZi4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjcGxheQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgYW5pbWF0aW9uIHRvIGJlIHBsYXllZCwgZS5nLiAiZmlyZSIsICJ3YWxrIiwgImp1bXAiLgoqIEBwYXJhbSB7bnVtYmVyfSBbZnJhbWVSYXRlPW51bGxdIC0gVGhlIGZyYW1lcmF0ZSB0byBwbGF5IHRoZSBhbmltYXRpb24gYXQuIFRoZSBzcGVlZCBpcyBnaXZlbiBpbiBmcmFtZXMgcGVyIHNlY29uZC4gSWYgbm90IHByb3ZpZGVkIHRoZSBwcmV2aW91c2x5IHNldCBmcmFtZVJhdGUgb2YgdGhlIEFuaW1hdGlvbiBpcyB1c2VkLgoqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gU2hvdWxkIHRoZSBhbmltYXRpb24gYmUgbG9vcGVkIGFmdGVyIHBsYXliYWNrLiBJZiBub3QgcHJvdmlkZWQgdGhlIHByZXZpb3VzbHkgc2V0IGxvb3AgdmFsdWUgb2YgdGhlIEFuaW1hdGlvbiBpcyB1c2VkLgoqIEBwYXJhbSB7Ym9vbGVhbn0gW2tpbGxPbkNvbXBsZXRlPWZhbHNlXSAtIElmIHNldCB0byB0cnVlIHdoZW4gdGhlIGFuaW1hdGlvbiBjb21wbGV0ZXMgKG9ubHkgaGFwcGVucyBpZiBsb29wPWZhbHNlKSB0aGUgcGFyZW50IFNwcml0ZSB3aWxsIGJlIGtpbGxlZC4KKiBAcmV0dXJuIHtQaGFzZXIuQW5pbWF0aW9ufSBBIHJlZmVyZW5jZSB0byBwbGF5aW5nIEFuaW1hdGlvbiBpbnN0YW5jZS4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUucGxheSA9IGZ1bmN0aW9uIChuYW1lLCBmcmFtZVJhdGUsIGxvb3AsIGtpbGxPbkNvbXBsZXRlKSB7CgogICAgaWYgKHRoaXMuYW5pbWF0aW9ucykKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5hbmltYXRpb25zLnBsYXkobmFtZSwgZnJhbWVSYXRlLCBsb29wLCBraWxsT25Db21wbGV0ZSk7CiAgICB9Cgp9OwoKLyoqCiogUmV0dXJucyB0aGUgZGVsdGEgeCB2YWx1ZS4gVGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBTcHJpdGUueCBub3cgYW5kIGluIHRoZSBwcmV2aW91cyBzdGVwLgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjZGVsdGFYCiogQHByb3BlcnR5IHtudW1iZXJ9IGRlbHRhWCAtIFRoZSBkZWx0YSB2YWx1ZS4gUG9zaXRpdmUgaWYgdGhlIG1vdGlvbiB3YXMgdG8gdGhlIHJpZ2h0LCBuZWdhdGl2ZSBpZiB0byB0aGUgbGVmdC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCAnZGVsdGFYJywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMud29ybGQueCAtIHRoaXMuX2NhY2hlLnByZXZYOwogICAgfQoKfSk7CgovKioKKiBSZXR1cm5zIHRoZSBkZWx0YSB4IHZhbHVlLiBUaGUgZGlmZmVyZW5jZSBiZXR3ZWVuIFNwcml0ZS55IG5vdyBhbmQgaW4gdGhlIHByZXZpb3VzIHN0ZXAuCiogQG5hbWUgUGhhc2VyLlNwcml0ZSNkZWx0YVkKKiBAcHJvcGVydHkge251bWJlcn0gZGVsdGFZIC0gVGhlIGRlbHRhIHZhbHVlLiBQb3NpdGl2ZSBpZiB0aGUgbW90aW9uIHdhcyBkb3dud2FyZHMsIG5lZ2F0aXZlIGlmIHVwd2FyZHMuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgJ2RlbHRhWScsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLndvcmxkLnkgLSB0aGlzLl9jYWNoZS5wcmV2WTsKICAgIH0KCn0pOwoKLyoqCiogSW5kaWNhdGVzIHRoZSByb3RhdGlvbiBvZiB0aGUgU3ByaXRlLCBpbiBkZWdyZWVzLCBmcm9tIGl0cyBvcmlnaW5hbCBvcmllbnRhdGlvbi4gVmFsdWVzIGZyb20gMCB0byAxODAgcmVwcmVzZW50IGNsb2Nrd2lzZSByb3RhdGlvbjsgdmFsdWVzIGZyb20gMCB0byAtMTgwIHJlcHJlc2VudCBjb3VudGVyY2xvY2t3aXNlIHJvdGF0aW9uLgoqIFZhbHVlcyBvdXRzaWRlIHRoaXMgcmFuZ2UgYXJlIGFkZGVkIHRvIG9yIHN1YnRyYWN0ZWQgZnJvbSAzNjAgdG8gb2J0YWluIGEgdmFsdWUgd2l0aGluIHRoZSByYW5nZS4gRm9yIGV4YW1wbGUsIHRoZSBzdGF0ZW1lbnQgcGxheWVyLmFuZ2xlID0gNDUwIGlzIHRoZSBzYW1lIGFzIHBsYXllci5hbmdsZSA9IDkwLgoqIElmIHlvdSB3aXNoIHRvIHdvcmsgaW4gcmFkaWFucyBpbnN0ZWFkIG9mIGRlZ3JlZXMgdXNlIHRoZSBwcm9wZXJ0eSBTcHJpdGUucm90YXRpb24gaW5zdGVhZC4KKiBAbmFtZSBQaGFzZXIuU3ByaXRlI2FuZ2xlCiogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ2xlIC0gR2V0cyBvciBzZXRzIHRoZSBTcHJpdGVzIGFuZ2xlIG9mIHJvdGF0aW9uIGluIGRlZ3JlZXMuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgJ2FuZ2xlJywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLndyYXBBbmdsZShQaGFzZXIuTWF0aC5yYWRUb0RlZyh0aGlzLnJvdGF0aW9uKSk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnJvdGF0aW9uID0gUGhhc2VyLk1hdGguZGVnVG9SYWQoUGhhc2VyLk1hdGgud3JhcEFuZ2xlKHZhbHVlKSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjZnJhbWUKKiBAcHJvcGVydHkge251bWJlcn0gZnJhbWUgLSBHZXRzIG9yIHNldHMgdGhlIGN1cnJlbnQgZnJhbWUgaW5kZXggYW5kIHVwZGF0ZXMgdGhlIFRleHR1cmUgQ2FjaGUgZm9yIGRpc3BsYXkuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgImZyYW1lIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hbmltYXRpb25zLmZyYW1lOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuYW5pbWF0aW9ucy5mcmFtZSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuU3ByaXRlI2ZyYW1lTmFtZQoqIEBwcm9wZXJ0eSB7c3RyaW5nfSBmcmFtZU5hbWUgLSBHZXRzIG9yIHNldHMgdGhlIGN1cnJlbnQgZnJhbWUgbmFtZSBhbmQgdXBkYXRlcyB0aGUgVGV4dHVyZSBDYWNoZSBmb3IgZGlzcGxheS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCAiZnJhbWVOYW1lIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hbmltYXRpb25zLmZyYW1lTmFtZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLmFuaW1hdGlvbnMuZnJhbWVOYW1lID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjaW5DYW1lcmEKKiBAcHJvcGVydHkge2Jvb2xlYW59IGluQ2FtZXJhIC0gSXMgdGhpcyBzcHJpdGUgdmlzaWJsZSB0byB0aGUgY2FtZXJhIG9yIG5vdD8KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCAiaW5DYW1lcmEiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jYWNoZS5jYW1lcmFWaXNpYmxlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuU3ByaXRlI3dvcmxkQ2VudGVyWAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3b3JsZENlbnRlclggLSBUaGUgY2VudGVyIG9mIHRoZSBTcHJpdGUgaW4gd29ybGQgY29vcmRpbmF0ZXMuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgIndvcmxkQ2VudGVyWCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5jYW1lcmEueCArIHRoaXMuY2VudGVyLng7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjd29ybGRDZW50ZXJZCiogQHByb3BlcnR5IHtudW1iZXJ9IHdvcmxkQ2VudGVyWSAtIFRoZSBjZW50ZXIgb2YgdGhlIFNwcml0ZSBpbiB3b3JsZCBjb29yZGluYXRlcy4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCAid29ybGRDZW50ZXJZIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLmNhbWVyYS55ICsgdGhpcy5jZW50ZXIueTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHdpZHRoIG9mIHRoZSBzcHJpdGUgaW4gcGl4ZWxzLCBzZXR0aW5nIHRoaXMgd2lsbCBhY3R1YWxseSBtb2RpZnkgdGhlIHNjYWxlIHRvIGFjaGVpdmUgdGhlIHZhbHVlIGRlc2lyZWQuCiogSWYgeW91IHdpc2ggdG8gY3JvcCB0aGUgU3ByaXRlIGluc3RlYWQgc2VlIHRoZSBTcHJpdGUuY3JvcCB2YWx1ZS4KKgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjd2lkdGgKKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIFNwcml0ZSBpbiBwaXhlbHMuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgJ3dpZHRoJywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUueCAqIHRoaXMuY3VycmVudEZyYW1lLndpZHRoOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CgogICAgICAgIHRoaXMuc2NhbGUueCA9IHZhbHVlIC8gdGhpcy5jdXJyZW50RnJhbWUud2lkdGg7CiAgICAgICAgdGhpcy5fY2FjaGUuc2NhbGVYID0gdmFsdWUgLyB0aGlzLmN1cnJlbnRGcmFtZS53aWR0aDsKICAgICAgICB0aGlzLl93aWR0aCA9IHZhbHVlOwoKICAgIH0KCn0pOwoKLyoqCiogVGhlIGhlaWdodCBvZiB0aGUgc3ByaXRlIGluIHBpeGVscywgc2V0dGluZyB0aGlzIHdpbGwgYWN0dWFsbHkgbW9kaWZ5IHRoZSBzY2FsZSB0byBhY2hlaXZlIHRoZSB2YWx1ZSBkZXNpcmVkLgoqIElmIHlvdSB3aXNoIHRvIGNyb3AgdGhlIFNwcml0ZSBpbnN0ZWFkIHNlZSB0aGUgU3ByaXRlLmNyb3AgdmFsdWUuCioKKiBAbmFtZSBQaGFzZXIuU3ByaXRlI2hlaWdodAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBTcHJpdGUgaW4gcGl4ZWxzLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsICdoZWlnaHQnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zY2FsZS55ICogdGhpcy5jdXJyZW50RnJhbWUuaGVpZ2h0OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CgogICAgICAgIHRoaXMuc2NhbGUueSA9IHZhbHVlIC8gdGhpcy5jdXJyZW50RnJhbWUuaGVpZ2h0OwogICAgICAgIHRoaXMuX2NhY2hlLnNjYWxlWSA9IHZhbHVlIC8gdGhpcy5jdXJyZW50RnJhbWUuaGVpZ2h0OwogICAgICAgIHRoaXMuX2hlaWdodCA9IHZhbHVlOwoKICAgIH0KCn0pOwoKLyoqCiogQnkgZGVmYXVsdCBhIFNwcml0ZSB3b24ndCBwcm9jZXNzIGFueSBpbnB1dCBldmVudHMgYXQgYWxsLiBCeSBzZXR0aW5nIGlucHV0RW5hYmxlZCB0byB0cnVlIHRoZSBQaGFzZXIuSW5wdXRIYW5kbGVyIGlzCiogYWN0aXZhdGVkIGZvciB0aGlzIFNwcml0ZSBpbnN0YW5jZSBhbmQgaXQgd2lsbCB0aGVuIHN0YXJ0IHRvIHByb2Nlc3MgY2xpY2svdG91Y2ggZXZlbnRzIGFuZCBtb3JlLgoqCiogQG5hbWUgUGhhc2VyLlNwcml0ZSNpbnB1dEVuYWJsZWQKKiBAcHJvcGVydHkge2Jvb2xlYW59IGlucHV0RW5hYmxlZCAtIFNldCB0byB0cnVlIHRvIGFsbG93IHRoaXMgU3ByaXRlIHRvIHJlY2VpdmUgaW5wdXQgZXZlbnRzLCBvdGhlcndpc2UgZmFsc2UuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgImlucHV0RW5hYmxlZCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiAodGhpcy5pbnB1dC5lbmFibGVkKTsKCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh2YWx1ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LmVuYWJsZWQgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnN0YXJ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQuZW5hYmxlZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIFRpbGVTcHJpdGUgaXMgYSBTcHJpdGUgd2hvcyB0ZXh0dXJlIGlzIHNldCB0byByZXBlYXQgYW5kIGNhbiBiZSBzY3JvbGxlZC4gQXMgaXQgc2Nyb2xscyB0aGUgdGV4dHVyZSByZXBlYXRzICh3cmFwcykgb24gdGhlIGVkZ2VzLgoqIEBjbGFzcyBQaGFzZXIuVGlsZW1hcAoqIEBleHRlbmRzIFBoYXNlci5TcHJpdGUKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IHRpbGVTcHJpdGUuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgdGlsZVNwcml0ZS4KKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSB0aGUgd2lkdGggb2YgdGhlIHRpbGVzcHJpdGUuCiogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIHRoZSBoZWlnaHQgb2YgdGhlIHRpbGVzcHJpdGUuCiogQHBhcmFtIHtzdHJpbmd8UGhhc2VyLlJlbmRlclRleHR1cmV8UElYSS5UZXh0dXJlfSBrZXkgLSBUaGlzIGlzIHRoZSBpbWFnZSBvciB0ZXh0dXJlIHVzZWQgYnkgdGhlIFNwcml0ZSBkdXJpbmcgcmVuZGVyaW5nLiBJdCBjYW4gYmUgYSBzdHJpbmcgd2hpY2ggaXMgYSByZWZlcmVuY2UgdG8gdGhlIENhY2hlIGVudHJ5LCBvciBhbiBpbnN0YW5jZSBvZiBhIFJlbmRlclRleHR1cmUgb3IgUElYSS5UZXh0dXJlLgoqLwpQaGFzZXIuVGlsZVNwcml0ZSA9IGZ1bmN0aW9uIChnYW1lLCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBrZXkpIHsKCiAgICB4ID0geCB8fCAwOwogICAgeSA9IHkgfHwgMDsKICAgIHdpZHRoID0gd2lkdGggfHwgMjU2OwogICAgaGVpZ2h0ID0gaGVpZ2h0IHx8IDI1NjsKICAgIGtleSA9IGtleSB8fCBudWxsOwoKICAgIFBoYXNlci5TcHJpdGUuY2FsbCh0aGlzLCBnYW1lLCB4LCB5LCBrZXkpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BJWEkuVGV4dHVyZX0gdGV4dHVyZSAtIFRoZSB0ZXh0dXJlIHRoYXQgdGhlIHNwcml0ZSByZW5kZXJzIHdpdGguCiAgICAqLwogICAgdGhpcy50ZXh0dXJlID0gUElYSS5UZXh0dXJlQ2FjaGVba2V5XTsKCiAgICBQSVhJLlRpbGluZ1Nwcml0ZS5jYWxsKHRoaXMsIHRoaXMudGV4dHVyZSwgd2lkdGgsIGhlaWdodCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0eXBlIC0gVGhlIGNvbnN0IHR5cGUgb2YgdGhpcyBvYmplY3QuCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMudHlwZSA9IFBoYXNlci5USUxFU1BSSVRFOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gdGlsZVNjYWxlIC0gVGhlIHNjYWxpbmcgb2YgdGhlIGltYWdlIHRoYXQgaXMgYmVpbmcgdGlsZWQuCiAgICAqLwogICAgdGhpcy50aWxlU2NhbGUgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gdGlsZVBvc2l0aW9uIC0gVGhlIG9mZnNldCBwb3NpdGlvbiBvZiB0aGUgaW1hZ2UgdGhhdCBpcyBiZWluZyB0aWxlZC4KICAgICovCiAgICB0aGlzLnRpbGVQb3NpdGlvbiA9IG5ldyBQaGFzZXIuUG9pbnQoMCwgMCk7CgogICAgdGhpcy5ib2R5LndpZHRoID0gd2lkdGg7CiAgICB0aGlzLmJvZHkuaGVpZ2h0ID0gaGVpZ2h0OwoKfTsKClBoYXNlci5UaWxlU3ByaXRlLnByb3RvdHlwZSA9IFBoYXNlci5VdGlscy5leHRlbmQodHJ1ZSwgUElYSS5UaWxpbmdTcHJpdGUucHJvdG90eXBlLCBQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSk7ClBoYXNlci5UaWxlU3ByaXRlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5UaWxlU3ByaXRlOwoKLyoqCiogSW5kaWNhdGVzIHRoZSByb3RhdGlvbiBvZiB0aGUgU3ByaXRlLCBpbiBkZWdyZWVzLCBmcm9tIGl0cyBvcmlnaW5hbCBvcmllbnRhdGlvbi4gVmFsdWVzIGZyb20gMCB0byAxODAgcmVwcmVzZW50IGNsb2Nrd2lzZSByb3RhdGlvbjsgdmFsdWVzIGZyb20gMCB0byAtMTgwIHJlcHJlc2VudCBjb3VudGVyY2xvY2t3aXNlIHJvdGF0aW9uLgoqIFZhbHVlcyBvdXRzaWRlIHRoaXMgcmFuZ2UgYXJlIGFkZGVkIHRvIG9yIHN1YnRyYWN0ZWQgZnJvbSAzNjAgdG8gb2J0YWluIGEgdmFsdWUgd2l0aGluIHRoZSByYW5nZS4gRm9yIGV4YW1wbGUsIHRoZSBzdGF0ZW1lbnQgcGxheWVyLmFuZ2xlID0gNDUwIGlzIHRoZSBzYW1lIGFzIHBsYXllci5hbmdsZSA9IDkwLgoqIElmIHlvdSB3aXNoIHRvIHdvcmsgaW4gcmFkaWFucyBpbnN0ZWFkIG9mIGRlZ3JlZXMgdXNlIHRoZSBwcm9wZXJ0eSBTcHJpdGUucm90YXRpb24gaW5zdGVhZC4KKiBAbmFtZSBQaGFzZXIuVGlsZVNwcml0ZSNhbmdsZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmdsZSAtIEdldHMgb3Igc2V0cyB0aGUgU3ByaXRlcyBhbmdsZSBvZiByb3RhdGlvbiBpbiBkZWdyZWVzLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGVTcHJpdGUucHJvdG90eXBlLCAnYW5nbGUnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGgud3JhcEFuZ2xlKFBoYXNlci5NYXRoLnJhZFRvRGVnKHRoaXMucm90YXRpb24pKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucm90YXRpb24gPSBQaGFzZXIuTWF0aC5kZWdUb1JhZChQaGFzZXIuTWF0aC53cmFwQW5nbGUodmFsdWUpKTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbGVTcHJpdGUjZnJhbWUKKiBAcHJvcGVydHkge251bWJlcn0gZnJhbWUgLSBHZXRzIG9yIHNldHMgdGhlIGN1cnJlbnQgZnJhbWUgaW5kZXggYW5kIHVwZGF0ZXMgdGhlIFRleHR1cmUgQ2FjaGUgZm9yIGRpc3BsYXkuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZVNwcml0ZS5wcm90b3R5cGUsICJmcmFtZSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0aW9ucy5mcmFtZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLmFuaW1hdGlvbnMuZnJhbWUgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbGVTcHJpdGUjZnJhbWVOYW1lCiogQHByb3BlcnR5IHtzdHJpbmd9IGZyYW1lTmFtZSAtIEdldHMgb3Igc2V0cyB0aGUgY3VycmVudCBmcmFtZSBuYW1lIGFuZCB1cGRhdGVzIHRoZSBUZXh0dXJlIENhY2hlIGZvciBkaXNwbGF5LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGVTcHJpdGUucHJvdG90eXBlLCAiZnJhbWVOYW1lIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hbmltYXRpb25zLmZyYW1lTmFtZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLmFuaW1hdGlvbnMuZnJhbWVOYW1lID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5UaWxlU3ByaXRlI2luQ2FtZXJhCiogQHByb3BlcnR5IHtib29sZWFufSBpbkNhbWVyYSAtIElzIHRoaXMgc3ByaXRlIHZpc2libGUgdG8gdGhlIGNhbWVyYSBvciBub3Q/CiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZVNwcml0ZS5wcm90b3R5cGUsICJpbkNhbWVyYSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NhY2hlLmNhbWVyYVZpc2libGU7CiAgICB9Cgp9KTsKCi8qKgoqIEJ5IGRlZmF1bHQgYSBTcHJpdGUgd29uJ3QgcHJvY2VzcyBhbnkgaW5wdXQgZXZlbnRzIGF0IGFsbC4gQnkgc2V0dGluZyBpbnB1dEVuYWJsZWQgdG8gdHJ1ZSB0aGUgUGhhc2VyLklucHV0SGFuZGxlciBpcwoqIGFjdGl2YXRlZCBmb3IgdGhpcyBTcHJpdGUgaW5zdGFuY2UgYW5kIGl0IHdpbGwgdGhlbiBzdGFydCB0byBwcm9jZXNzIGNsaWNrL3RvdWNoIGV2ZW50cyBhbmQgbW9yZS4KKgoqIEBuYW1lIFBoYXNlci5UaWxlU3ByaXRlI2lucHV0RW5hYmxlZAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaW5wdXRFbmFibGVkIC0gU2V0IHRvIHRydWUgdG8gYWxsb3cgdGhpcyBTcHJpdGUgdG8gcmVjZWl2ZSBpbnB1dCBldmVudHMsIG90aGVyd2lzZSBmYWxzZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaWxlU3ByaXRlLnByb3RvdHlwZSwgImlucHV0RW5hYmxlZCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiAodGhpcy5pbnB1dC5lbmFibGVkKTsKCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh2YWx1ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LmVuYWJsZWQgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnN0YXJ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQuZW5hYmxlZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGUgYSBuZXcgYFRleHRgIG9iamVjdC4KKiBAY2xhc3MgUGhhc2VyLlRleHQKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IHRleHQgb2JqZWN0LgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IHRleHQgb2JqZWN0LgoqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIGFjdHVhbCB0ZXh0IHRoYXQgd2lsbCBiZSB3cml0dGVuLgoqIEBwYXJhbSB7b2JqZWN0fSBzdHlsZSAtIFRoZSBzdHlsZSBvYmplY3QgY29udGFpbmluZyBzdHlsZSBhdHRyaWJ1dGVzIGxpa2UgZm9udCwgZm9udCBzaXplICwKKi8KUGhhc2VyLlRleHQgPSBmdW5jdGlvbiAoZ2FtZSwgeCwgeSwgdGV4dCwgc3R5bGUpIHsKCiAgICB4ID0geCB8fCAwOwogICAgeSA9IHkgfHwgMDsKICAgIHRleHQgPSB0ZXh0IHx8ICcnOwogICAgc3R5bGUgPSBzdHlsZSB8fCAnJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CiAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGV4aXN0cyAtIElmIGV4aXN0cyA9IGZhbHNlIHRoZW4gdGhlIFRleHQgaXNuJ3QgdXBkYXRlZCBieSB0aGUgY29yZSBnYW1lIGxvb3AuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsaXZlIC0gVGhpcyBpcyBhIGhhbmR5IGxpdHRsZSB2YXIgeW91ciBnYW1lIGNhbiB1c2UgdG8gZGV0ZXJtaW5lIGlmIGFuIG9iamVjdCBpcyBhbGl2ZSBvciBub3QsIGl0IGRvZXNuJ3QgZWZmZWN0IHJlbmRlcmluZy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFsaXZlID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR3JvdXB9IGdyb3VwIC0gVGhlIHBhcmVudCBHcm91cCBvZiB0aGlzIFRleHQgb2JqZWN0LgogICAgKi8KICAgIHRoaXMuZ3JvdXAgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIFRoZSB1c2VyIGRlZmluZWQgbmFtZSBnaXZlbiB0byB0aGlzIG9iamVjdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm5hbWUgPSAnJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBUaGUgY29uc3QgdHlwZSBvZiB0aGlzIG9iamVjdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuVEVYVDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IF90ZXh0IC0gSW50ZXJuYWwgdmFsdWUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdGV4dCA9IHRleHQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBfc3R5bGUgLSBJbnRlcm5hbCB2YWx1ZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9zdHlsZSA9IHN0eWxlOwoKICAgIFBJWEkuVGV4dC5jYWxsKHRoaXMsIHRleHQsIHN0eWxlKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHBvc2l0aW9uIC0gVGhlIHBvc2l0aW9uIG9mIHRoaXMgVGV4dCBvYmplY3QgaW4gd29ybGQgc3BhY2UuCiAgICAqLwogICAgdGhpcy5wb3NpdGlvbi54ID0gdGhpcy54ID0geDsKICAgIHRoaXMucG9zaXRpb24ueSA9IHRoaXMueSA9IHk7CgogICAgLyoqCiAgICAqIFRoZSBhbmNob3Igc2V0cyB0aGUgb3JpZ2luIHBvaW50IG9mIHRoZSB0ZXh0dXJlLgogICAgKiBUaGUgZGVmYXVsdCBpcyAwLDAgdGhpcyBtZWFucyB0aGUgdGV4dHVyZXMgb3JpZ2luIGlzIHRoZSB0b3AgbGVmdCAKICAgICogU2V0dGluZyB0aGFuIGFuY2hvciB0byAwLjUsMC41IG1lYW5zIHRoZSB0ZXh0dXJlcyBvcmlnaW4gaXMgY2VudGVyZWQKICAgICogU2V0dGluZyB0aGUgYW5jaG9yIHRvIDEsMSB3b3VsZCBtZWFuIHRoZSB0ZXh0dXJlcyBvcmlnaW4gcG9pbnRzIHdpbGwgYmUgdGhlIGJvdHRvbSByaWdodAogICAgKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYW5jaG9yIC0gVGhlIGFuY2hvciBhcm91bmQgd2hpY2ggcm90YXRpb24gYW5kIHNjYWxpbmcgdGFrZXMgcGxhY2UuCiAgICAqLwogICAgdGhpcy5hbmNob3IgPSBuZXcgUGhhc2VyLlBvaW50KCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc2NhbGUgLSBUaGUgc2NhbGUgb2YgdGhlIG9iamVjdCB3aGVuIHJlbmRlcmVkLiBCeSBkZWZhdWx0IGl0J3Mgc2V0IHRvIDEgKG5vIHNjYWxlKS4gWW91IGNhbiBtb2RpZnkgaXQgdmlhIHNjYWxlLnggb3Igc2NhbGUueSBvciBzY2FsZS5zZXRUbyh4LCB5KS4gQSB2YWx1ZSBvZiAxIG1lYW5zIG5vIGNoYW5nZSB0byB0aGUgc2NhbGUsIDAuNSBtZWFucyAiaGFsZiB0aGUgc2l6ZSIsIDIgbWVhbnMgInR3aWNlIHRoZSBzaXplIiwgZXRjLgogICAgKi8KICAgIHRoaXMuc2NhbGUgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwoKICAgIC8qKgogICAgKiBBbiBvYmplY3QgdGhhdCBpcyBmaXhlZCB0byB0aGUgY2FtZXJhIGlnbm9yZXMgdGhlIHBvc2l0aW9uIG9mIGFueSBhbmNlc3RvcnMgaW4gdGhlIGRpc3BsYXkgbGlzdCBhbmQgdXNlcyBpdHMgeC95IGNvb3JkaW5hdGVzIGFzIG9mZnNldHMgZnJvbSB0aGUgdG9wIGxlZnQgb2YgdGhlIGNhbWVyYS4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBmaXhlZFRvQ2FtZXJhIC0gRml4ZXMgdGhpcyBvYmplY3QgdG8gdGhlIENhbWVyYS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZpeGVkVG9DYW1lcmEgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGNhbWVyYU9mZnNldCAtIElmIHRoaXMgb2JqZWN0IGlzIGZpeGVkIHRvIHRoZSBjYW1lcmEgdGhlbiB1c2UgdGhpcyBQb2ludCB0byBzcGVjaWZ5IGhvdyBmYXIgYXdheSBmcm9tIHRoZSBDYW1lcmEgeC95IGl0J3MgcmVuZGVyZWQuCiAgICAqLwogICAgdGhpcy5jYW1lcmFPZmZzZXQgPSBuZXcgUGhhc2VyLlBvaW50KHgsIHkpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX2NhY2hlIC0gQSBtaW5pIGNhY2hlIGZvciBzdG9yaW5nIGFsbCBvZiB0aGUgY2FsY3VsYXRlZCB2YWx1ZXMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fY2FjaGUgPSB7CgogICAgICAgIGRpcnR5OiBmYWxzZSwKCiAgICAgICAgLy8gIFRyYW5zZm9ybSBjYWNoZQogICAgICAgIGEwMDogMSwKICAgICAgICBhMDE6IDAsCiAgICAgICAgYTAyOiB4LAogICAgICAgIGExMDogMCwKICAgICAgICBhMTE6IDEsCiAgICAgICAgYTEyOiB5LAogICAgICAgIGlkOiAxLAoKICAgICAgICAvLyAgVGhlIHByZXZpb3VzIGNhbGN1bGF0ZWQgcG9zaXRpb24KICAgICAgICB4OiAtMSwKICAgICAgICB5OiAtMSwKCiAgICAgICAgLy8gIFRoZSBhY3R1YWwgc2NhbGUgdmFsdWVzIGJhc2VkIG9uIHRoZSB3b3JsZFRyYW5zZm9ybQogICAgICAgIHNjYWxlWDogMSwKICAgICAgICBzY2FsZVk6IDEKCiAgICB9OwoKICAgIHRoaXMuX2NhY2hlLnggPSB0aGlzLng7CiAgICB0aGlzLl9jYWNoZS55ID0gdGhpcy55OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHJlbmRlcmFibGUgLSBBIHJlbmRlcmFibGUgb2JqZWN0IHdpbGwgYmUgcmVuZGVyZWQgdG8gdGhlIGNvbnRleHQgZWFjaCBmcmFtZS4KICAgICovCiAgICB0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwoKfTsKClBoYXNlci5UZXh0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5UZXh0LnByb3RvdHlwZSk7ClBoYXNlci5UZXh0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5UZXh0OwoKLyoqCiogQXV0b21hdGljYWxseSBjYWxsZWQgYnkgV29ybGQudXBkYXRlLgoqIEBtZXRob2QgUGhhc2VyLlRleHQucHJvdG90eXBlLnVwZGF0ZQoqLwpQaGFzZXIuVGV4dC5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKCF0aGlzLmV4aXN0cykKICAgIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHRoaXMuZml4ZWRUb0NhbWVyYSkKICAgIHsKICAgICAgICB0aGlzLnggPSB0aGlzLmdhbWUuY2FtZXJhLnZpZXcueCArIHRoaXMuY2FtZXJhT2Zmc2V0Lng7CiAgICAgICAgdGhpcy55ID0gdGhpcy5nYW1lLmNhbWVyYS52aWV3LnkgKyB0aGlzLmNhbWVyYU9mZnNldC55OwogICAgfQoKICAgIHRoaXMuX2NhY2hlLmRpcnR5ID0gZmFsc2U7CgogICAgdGhpcy5fY2FjaGUueCA9IHRoaXMueDsKICAgIHRoaXMuX2NhY2hlLnkgPSB0aGlzLnk7CgogICAgaWYgKHRoaXMucG9zaXRpb24ueCAhPSB0aGlzLl9jYWNoZS54IHx8IHRoaXMucG9zaXRpb24ueSAhPSB0aGlzLl9jYWNoZS55KQogICAgewogICAgICAgIHRoaXMucG9zaXRpb24ueCA9IHRoaXMuX2NhY2hlLng7CiAgICAgICAgdGhpcy5wb3NpdGlvbi55ID0gdGhpcy5fY2FjaGUueTsKICAgICAgICB0aGlzLl9jYWNoZS5kaXJ0eSA9IHRydWU7CiAgICB9Cgp9CgovKioKKiBAbWV0aG9kIFBoYXNlci5UZXh0LnByb3RvdHlwZS5kZXN0cm95CiovClBoYXNlci5UZXh0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKHRoaXMuZ3JvdXApCiAgICB7CiAgICAgICAgdGhpcy5ncm91cC5yZW1vdmUodGhpcyk7CiAgICB9CgogICAgaWYgKHRoaXMuY2FudmFzLnBhcmVudE5vZGUpCiAgICB7CiAgICAgICAgdGhpcy5jYW52YXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLmNhbnZhcyk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5jYW52YXMgPSBudWxsOwogICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICB9CgogICAgdGhpcy5leGlzdHMgPSBmYWxzZTsKCiAgICB0aGlzLmdyb3VwID0gbnVsbDsKCn0KCi8qKgoqIEluZGljYXRlcyB0aGUgcm90YXRpb24gb2YgdGhlIFRleHQsIGluIGRlZ3JlZXMsIGZyb20gaXRzIG9yaWdpbmFsIG9yaWVudGF0aW9uLiBWYWx1ZXMgZnJvbSAwIHRvIDE4MCByZXByZXNlbnQgY2xvY2t3aXNlIHJvdGF0aW9uOyB2YWx1ZXMgZnJvbSAwIHRvIC0xODAgcmVwcmVzZW50IGNvdW50ZXJjbG9ja3dpc2Ugcm90YXRpb24uCiogVmFsdWVzIG91dHNpZGUgdGhpcyByYW5nZSBhcmUgYWRkZWQgdG8gb3Igc3VidHJhY3RlZCBmcm9tIDM2MCB0byBvYnRhaW4gYSB2YWx1ZSB3aXRoaW4gdGhlIHJhbmdlLiBGb3IgZXhhbXBsZSwgdGhlIHN0YXRlbWVudCBwbGF5ZXIuYW5nbGUgPSA0NTAgaXMgdGhlIHNhbWUgYXMgcGxheWVyLmFuZ2xlID0gOTAuCiogSWYgeW91IHdpc2ggdG8gd29yayBpbiByYWRpYW5zIGluc3RlYWQgb2YgZGVncmVlcyB1c2UgdGhlIHByb3BlcnR5IFNwcml0ZS5yb3RhdGlvbiBpbnN0ZWFkLgoqIEBuYW1lIFBoYXNlci5UZXh0I2FuZ2xlCiogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ2xlIC0gR2V0cyBvciBzZXRzIHRoZSBhbmdsZSBvZiByb3RhdGlvbiBpbiBkZWdyZWVzLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRleHQucHJvdG90eXBlLCAnYW5nbGUnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGgucmFkVG9EZWcodGhpcy5yb3RhdGlvbik7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnJvdGF0aW9uID0gUGhhc2VyLk1hdGguZGVnVG9SYWQodmFsdWUpOwogICAgfQoKfSk7CgovKioKKiBUaGUgeCBjb29yZGluYXRlIG9mIHRoaXMgb2JqZWN0IGluIHdvcmxkIHNwYWNlLgoqIEBuYW1lIFBoYXNlci5UZXh0I3gKKiBAcHJvcGVydHkge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhpcyBvYmplY3QgaW4gd29ybGQgc3BhY2UuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGV4dC5wcm90b3R5cGUsICd4JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb24ueDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucG9zaXRpb24ueCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBUaGUgeSBjb29yZGluYXRlIG9mIHRoaXMgb2JqZWN0IGluIHdvcmxkIHNwYWNlLgoqIEBuYW1lIFBoYXNlci5UZXh0I3kKKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhpcyBvYmplY3QgaW4gd29ybGQgc3BhY2UuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGV4dC5wcm90b3R5cGUsICd5JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb24ueTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucG9zaXRpb24ueSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBUaGUgc3RyaW5nIHRvIGJlIHJlbmRlcmVkIGJ5IHRoaXMgVGV4dCBvYmplY3QuCiogQG5hbWUgUGhhc2VyLlRleHQjY29udGVudAoqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZW50IC0gVGhlIHN0cmluZyB0byBiZSByZW5kZXJlZCBieSB0aGlzIFRleHQgb2JqZWN0LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRleHQucHJvdG90eXBlLCAnY29udGVudCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLl90ZXh0OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CgogICAgICAgIC8vICBMZXQncyBub3QgdXBkYXRlIHVubGVzcyBuZWVkZWQsIHRoaXMgd2F5IHdlIGNhbiBzYWZlbHkgdXBkYXRlIHRoZSB0ZXh0IGluIGEgY29yZSBsb29wIHdpdGhvdXQgY29uc3RhbnQgcmUtZHJhd3MKICAgICAgICBpZiAodmFsdWUgIT09IHRoaXMuX3RleHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl90ZXh0ID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuc2V0VGV4dCh2YWx1ZSk7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogVGhlIGZvbnQgdGhlIHRleHQgd2lsbCBiZSByZW5kZXJlZCBpbi4KKiBAbmFtZSBQaGFzZXIuVGV4dCNmb250CiogQHByb3BlcnR5IHtzdHJpbmd9IGZvbnQgLSBUaGUgZm9udCB0aGUgdGV4dCB3aWxsIGJlIHJlbmRlcmVkIGluLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRleHQucHJvdG90eXBlLCAnZm9udCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLl9zdHlsZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoKICAgICAgICAvLyAgTGV0J3Mgbm90IHVwZGF0ZSB1bmxlc3MgbmVlZGVkLCB0aGlzIHdheSB3ZSBjYW4gc2FmZWx5IHVwZGF0ZSB0aGUgdGV4dCBpbiBhIGNvcmUgbG9vcCB3aXRob3V0IGNvbnN0YW50IHJlLWRyYXdzCiAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLl9zdHlsZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3N0eWxlID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuc2V0U3R5bGUodmFsdWUpOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIENyZWF0ZXMgYSBuZXcgQml0bWFwVGV4dCBvYmplY3QuCioKKiBAY2xhc3MgUGhhc2VyLkJpdG1hcFRleHQKKgoqIEBjbGFzc2Rlc2MgQml0bWFwVGV4dCBvYmplY3RzIHdvcmsgYnkgdGFraW5nIGEgdGV4dHVyZSBmaWxlIGFuZCBhbiBYTUwgZmlsZSB0aGF0IGRlc2NyaWJlcyB0aGUgZm9udCBsYXlvdXQuCioKKiBPbiBXaW5kb3dzIHlvdSBjYW4gdXNlIHRoZSBmcmVlIGFwcCBCTUZvbnQ6IGh0dHA6Ly93d3cuYW5nZWxjb2RlLmNvbS9wcm9kdWN0cy9ibWZvbnQvCioKKiBPbiBPUyBYIHdlIHJlY29tbWVuZCBHbHlwaCBEZXNpZ25lcjogaHR0cDovL3d3dy43MXNxdWFyZWQuY29tL2VuL2dseXBoZGVzaWduZXIKKgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyBiaXRtYXBUZXh0IG9iamVjdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyBiaXRtYXBUZXh0IG9iamVjdC4KKiBAcGFyYW0ge3N0cmluZ30gdGV4dCAtIFRoZSBhY3R1YWwgdGV4dCB0aGF0IHdpbGwgYmUgd3JpdHRlbi4KKiBAcGFyYW0ge29iamVjdH0gc3R5bGUgLSBUaGUgc3R5bGUgb2JqZWN0IGNvbnRhaW5pbmcgc3R5bGUgYXR0cmlidXRlcyBsaWtlIGZvbnQsIGZvbnQgc2l6ZSAsIGV0Yy4KKi8KUGhhc2VyLkJpdG1hcFRleHQgPSBmdW5jdGlvbiAoZ2FtZSwgeCwgeSwgdGV4dCwgc3R5bGUpIHsKCiAgICB4ID0geCB8fCAwOwogICAgeSA9IHkgfHwgMDsKICAgIHRleHQgPSB0ZXh0IHx8ICcnOwogICAgc3R5bGUgPSBzdHlsZSB8fCAnJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGV4aXN0cyAtIElmIGV4aXN0cyA9IGZhbHNlIHRoZW4gdGhlIFNwcml0ZSBpc24ndCB1cGRhdGVkIGJ5IHRoZSBjb3JlIGdhbWUgbG9vcCBvciBwaHlzaWNzIHN1YnN5c3RlbSBhdCBhbGwuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsaXZlIC0gVGhpcyBpcyBhIGhhbmR5IGxpdHRsZSB2YXIgeW91ciBnYW1lIGNhbiB1c2UgdG8gZGV0ZXJtaW5lIGlmIGEgc3ByaXRlIGlzIGFsaXZlIG9yIG5vdCwgaXQgZG9lc24ndCBlZmZlY3QgcmVuZGVyaW5nLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYWxpdmUgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Hcm91cH0gZ3JvdXAgLSBUaGUgcGFyZW50IEdyb3VwIG9mIHRoaXMgQml0bWFwVGV4dC4KICAgICovCiAgICB0aGlzLmdyb3VwID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBUaGUgdXNlciBkZWZpbmVkIG5hbWUgZ2l2ZW4gdG8gdGhpcyBCaXRtYXBUZXh0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubmFtZSA9ICcnOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIFRoZSBjb25zdCB0eXBlIG9mIHRoaXMgb2JqZWN0LgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuQklUTUFQVEVYVDsKCiAgICBQSVhJLkJpdG1hcFRleHQuY2FsbCh0aGlzLCB0ZXh0LCBzdHlsZSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwb3NpdGlvbi54IC0gVGhlIHggcG9zaXRpb24gb2YgdGhpcyBvYmplY3QuCiAgICAqLwogICAgdGhpcy5wb3NpdGlvbi54ID0geDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwb3NpdGlvbi55IC0gVGhlIHkgcG9zaXRpb24gb2YgdGhpcyBvYmplY3QuCiAgICAqLwogICAgdGhpcy5wb3NpdGlvbi55ID0geTsKCiAgICAvKioKICAgICogVGhlIGFuY2hvciBzZXRzIHRoZSBvcmlnaW4gcG9pbnQgb2YgdGhlIHRleHR1cmUuCiAgICAqIFRoZSBkZWZhdWx0IGlzIDAsMCB0aGlzIG1lYW5zIHRoZSB0ZXh0dXJlcyBvcmlnaW4gaXMgdGhlIHRvcCBsZWZ0IAogICAgKiBTZXR0aW5nIHRoYW4gYW5jaG9yIHRvIDAuNSwwLjUgbWVhbnMgdGhlIHRleHR1cmVzIG9yaWdpbiBpcyBjZW50ZXJlZAogICAgKiBTZXR0aW5nIHRoZSBhbmNob3IgdG8gMSwxIHdvdWxkIG1lYW4gdGhlIHRleHR1cmVzIG9yaWdpbiBwb2ludHMgd2lsbCBiZSB0aGUgYm90dG9tIHJpZ2h0CiAgICAqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBhbmNob3IgLSBUaGUgYW5jaG9yIGFyb3VuZCB3aGljaCByb3RhdGlvbiBhbmQgc2NhbGluZyB0YWtlcyBwbGFjZS4KICAgICovCiAgICB0aGlzLmFuY2hvciA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBzY2FsZSAtIFRoZSBzY2FsZSBvZiB0aGUgb2JqZWN0IHdoZW4gcmVuZGVyZWQuIEJ5IGRlZmF1bHQgaXQncyBzZXQgdG8gMSAobm8gc2NhbGUpLiBZb3UgY2FuIG1vZGlmeSBpdCB2aWEgc2NhbGUueCBvciBzY2FsZS55IG9yIHNjYWxlLnNldFRvKHgsIHkpLiBBIHZhbHVlIG9mIDEgbWVhbnMgbm8gY2hhbmdlIHRvIHRoZSBzY2FsZSwgMC41IG1lYW5zICJoYWxmIHRoZSBzaXplIiwgMiBtZWFucyAidHdpY2UgdGhlIHNpemUiLCBldGMuCiAgICAqLwogICAgdGhpcy5zY2FsZSA9IG5ldyBQaGFzZXIuUG9pbnQoMSwgMSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfY2FjaGUgLSBBIG1pbmkgY2FjaGUgZm9yIHN0b3JpbmcgYWxsIG9mIHRoZSBjYWxjdWxhdGVkIHZhbHVlcy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9jYWNoZSA9IHsKCiAgICAgICAgZGlydHk6IGZhbHNlLAoKICAgICAgICAvLyAgVHJhbnNmb3JtIGNhY2hlCiAgICAgICAgYTAwOiAxLAogICAgICAgIGEwMTogMCwKICAgICAgICBhMDI6IHgsCiAgICAgICAgYTEwOiAwLAogICAgICAgIGExMTogMSwKICAgICAgICBhMTI6IHksCiAgICAgICAgaWQ6IDEsCgogICAgICAgIC8vICBUaGUgcHJldmlvdXMgY2FsY3VsYXRlZCBwb3NpdGlvbgogICAgICAgIHg6IC0xLAogICAgICAgIHk6IC0xLAoKICAgICAgICAvLyAgVGhlIGFjdHVhbCBzY2FsZSB2YWx1ZXMgYmFzZWQgb24gdGhlIHdvcmxkVHJhbnNmb3JtCiAgICAgICAgc2NhbGVYOiAxLAogICAgICAgIHNjYWxlWTogMQoKICAgIH07CgogICAgdGhpcy5fY2FjaGUueCA9IHRoaXMueDsKICAgIHRoaXMuX2NhY2hlLnkgPSB0aGlzLnk7Cgp9OwoKUGhhc2VyLkJpdG1hcFRleHQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLkJpdG1hcFRleHQucHJvdG90eXBlKTsKUGhhc2VyLkJpdG1hcFRleHQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkJpdG1hcFRleHQ7CgovKioKKiBBdXRvbWF0aWNhbGx5IGNhbGxlZCBieSBXb3JsZC51cGRhdGUKKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZS51cGRhdGUKKi8KUGhhc2VyLkJpdG1hcFRleHQucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKCkgewoKICAgIGlmICghdGhpcy5leGlzdHMpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMuX2NhY2hlLmRpcnR5ID0gZmFsc2U7CgogICAgdGhpcy5fY2FjaGUueCA9IHRoaXMueDsKICAgIHRoaXMuX2NhY2hlLnkgPSB0aGlzLnk7CgogICAgaWYgKHRoaXMucG9zaXRpb24ueCAhPSB0aGlzLl9jYWNoZS54IHx8IHRoaXMucG9zaXRpb24ueSAhPSB0aGlzLl9jYWNoZS55KQogICAgewogICAgICAgIHRoaXMucG9zaXRpb24ueCA9IHRoaXMuX2NhY2hlLng7CiAgICAgICAgdGhpcy5wb3NpdGlvbi55ID0gdGhpcy5fY2FjaGUueTsKICAgICAgICB0aGlzLl9jYWNoZS5kaXJ0eSA9IHRydWU7CiAgICB9CgogICAgdGhpcy5waXZvdC54ID0gdGhpcy5hbmNob3IueCAqIHRoaXMud2lkdGg7CiAgICB0aGlzLnBpdm90LnkgPSB0aGlzLmFuY2hvci55ICogdGhpcy5oZWlnaHQ7Cgp9CgovKioKKiBAbWV0aG9kIFBoYXNlci5UZXh0LnByb3RvdHlwZS5kZXN0cm95CiovClBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKHRoaXMuZ3JvdXApCiAgICB7CiAgICAgICAgdGhpcy5ncm91cC5yZW1vdmUodGhpcyk7CiAgICB9CgogICAgaWYgKHRoaXMuY2FudmFzICYmIHRoaXMuY2FudmFzLnBhcmVudE5vZGUpCiAgICB7CiAgICAgICAgdGhpcy5jYW52YXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLmNhbnZhcyk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5jYW52YXMgPSBudWxsOwogICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICB9CgogICAgdGhpcy5leGlzdHMgPSBmYWxzZTsKCiAgICB0aGlzLmdyb3VwID0gbnVsbDsKCn0KCi8qKgoqIEluZGljYXRlcyB0aGUgcm90YXRpb24gb2YgdGhlIEJpdG1hcFRleHQsIGluIGRlZ3JlZXMsIGZyb20gaXRzIG9yaWdpbmFsIG9yaWVudGF0aW9uLiBWYWx1ZXMgZnJvbSAwIHRvIDE4MCByZXByZXNlbnQgY2xvY2t3aXNlIHJvdGF0aW9uOyB2YWx1ZXMgZnJvbSAwIHRvIC0xODAgcmVwcmVzZW50IGNvdW50ZXJjbG9ja3dpc2Ugcm90YXRpb24uCiogVmFsdWVzIG91dHNpZGUgdGhpcyByYW5nZSBhcmUgYWRkZWQgdG8gb3Igc3VidHJhY3RlZCBmcm9tIDM2MCB0byBvYnRhaW4gYSB2YWx1ZSB3aXRoaW4gdGhlIHJhbmdlLiBGb3IgZXhhbXBsZSwgdGhlIHN0YXRlbWVudCBwbGF5ZXIuYW5nbGUgPSA0NTAgaXMgdGhlIHNhbWUgYXMgcGxheWVyLmFuZ2xlID0gOTAuCiogSWYgeW91IHdpc2ggdG8gd29yayBpbiByYWRpYW5zIGluc3RlYWQgb2YgZGVncmVlcyB1c2UgdGhlIHByb3BlcnR5IFNwcml0ZS5yb3RhdGlvbiBpbnN0ZWFkLgoqIEBuYW1lIFBoYXNlci5CaXRtYXBUZXh0I2FuZ2xlCiogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ2xlIC0gR2V0cyBvciBzZXRzIHRoZSBhbmdsZSBvZiByb3RhdGlvbiBpbiBkZWdyZWVzLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkJpdG1hcFRleHQucHJvdG90eXBlLCAnYW5nbGUnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGgucmFkVG9EZWcodGhpcy5yb3RhdGlvbik7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnJvdGF0aW9uID0gUGhhc2VyLk1hdGguZGVnVG9SYWQodmFsdWUpOwogICAgfQoKfSk7CgovKioKKiBUaGUgeCBjb29yZGluYXRlIG9mIHRoaXMgb2JqZWN0IGluIHdvcmxkIHNwYWNlLgoqIEBuYW1lIFBoYXNlci5CaXRtYXBUZXh0I3gKKiBAcHJvcGVydHkge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhpcyBvYmplY3QgaW4gd29ybGQgc3BhY2UuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQml0bWFwVGV4dC5wcm90b3R5cGUsICd4JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb24ueDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucG9zaXRpb24ueCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBUaGUgeSBjb29yZGluYXRlIG9mIHRoaXMgb2JqZWN0IGluIHdvcmxkIHNwYWNlLgoqIEBuYW1lIFBoYXNlci5CaXRtYXBUZXh0I3kKKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhpcyBvYmplY3QgaW4gd29ybGQgc3BhY2UuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQml0bWFwVGV4dC5wcm90b3R5cGUsICd5JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb24ueTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucG9zaXRpb24ueSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBAY2xhc3MgUGhhc2VyLkJ1dHRvbgoqCiogQGNsYXNzZGVzYyBDcmVhdGUgYSBuZXcgYEJ1dHRvbmAgb2JqZWN0LiBBIEJ1dHRvbiBpcyBhIHNwZWNpYWwgdHlwZSBvZiBTcHJpdGUgdGhhdCBpcyBzZXQtdXAgdG8gaGFuZGxlIFBvaW50ZXIgZXZlbnRzIGF1dG9tYXRpY2FsbHkuIFRoZSBmb3VyIHN0YXRlcyBhIEJ1dHRvbiByZXNwb25kcyB0byBhcmU6CioKKiAqICdPdmVyJyAtIHdoZW4gdGhlIFBvaW50ZXIgbW92ZXMgb3ZlciB0aGUgQnV0dG9uLiBUaGlzIGlzIGFsc28gY29tbW9ubHkga25vd24gYXMgJ2hvdmVyJy4KKiAqICdPdXQnIC0gd2hlbiB0aGUgUG9pbnRlciB0aGF0IHdhcyBwcmV2aW91c2x5IG92ZXIgdGhlIEJ1dHRvbiBtb3ZlcyBvdXQgb2YgaXQuCiogKiAnRG93bicgLSB3aGVuIHRoZSBQb2ludGVyIGlzIHByZXNzZWQgZG93biBvbiB0aGUgQnV0dG9uLiBJLmUuIHRvdWNoZWQgb24gYSB0b3VjaCBlbmFibGVkIGRldmljZSBvciBjbGlja2VkIHdpdGggdGhlIG1vdXNlLgoqICogJ1VwJyAtIHdoZW4gdGhlIFBvaW50ZXIgdGhhdCB3YXMgcHJlc3NlZCBkb3duIG9uIHRoZSBCdXR0b24gaXMgcmVsZWFzZWQgYWdhaW4uCioKKiBZb3UgY2FuIHNldCBhIHVuaXF1ZSB0ZXh0dXJlIGZyYW1lIGFuZCBTb3VuZCBmb3IgYW55IG9mIHRoZXNlIHN0YXRlcy4KKgoqIEBjb25zdHJ1Y3RvcgoqCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSBDdXJyZW50IGdhbWUgaW5zdGFuY2UuCiogQHBhcmFtIHtudW1iZXJ9IFt4PTBdIC0gWCBwb3NpdGlvbiBvZiB0aGUgQnV0dG9uLgoqIEBwYXJhbSB7bnVtYmVyfSBbeT0wXSAtIFkgcG9zaXRpb24gb2YgdGhlIEJ1dHRvbi4KKiBAcGFyYW0ge3N0cmluZ30gW2tleV0gLSBUaGUgaW1hZ2Uga2V5IGFzIGRlZmluZWQgaW4gdGhlIEdhbWUuQ2FjaGUgdG8gdXNlIGFzIHRoZSB0ZXh0dXJlIGZvciB0aGlzIEJ1dHRvbi4KKiBAcGFyYW0ge2Z1bmN0aW9ufSBbY2FsbGJhY2tdIC0gVGhlIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGlzIEJ1dHRvbiBpcyBwcmVzc2VkLgoqIEBwYXJhbSB7b2JqZWN0fSBbY2FsbGJhY2tDb250ZXh0XSAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRoZSBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCAodXN1YWxseSAndGhpcycpLgoqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW292ZXJGcmFtZV0gLSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGFuIG92ZXIgc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbb3V0RnJhbWVdIC0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhbiBvdXQgc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbZG93bkZyYW1lXSAtIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYSBkb3duIHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgoqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW3VwRnJhbWVdIC0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhbiB1cCBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KKi8KUGhhc2VyLkJ1dHRvbiA9IGZ1bmN0aW9uIChnYW1lLCB4LCB5LCBrZXksIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJGcmFtZSwgb3V0RnJhbWUsIGRvd25GcmFtZSwgdXBGcmFtZSkgewoKICAgIHggPSB4IHx8IDA7CiAgICB5ID0geSB8fCAwOwogICAga2V5ID0ga2V5IHx8IG51bGw7CiAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IG51bGw7CiAgICBjYWxsYmFja0NvbnRleHQgPSBjYWxsYmFja0NvbnRleHQgfHwgdGhpczsKCiAgICBQaGFzZXIuU3ByaXRlLmNhbGwodGhpcywgZ2FtZSwgeCwgeSwga2V5LCBvdXRGcmFtZSk7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIFRoZSBQaGFzZXIgT2JqZWN0IFR5cGUuCiAgICAqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLkJVVFRPTjsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBfb25PdmVyRnJhbWVOYW1lIC0gSW50ZXJuYWwgdmFyaWFibGUuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb25PdmVyRnJhbWVOYW1lID0gbnVsbDsKICAgIAogICAgLyoqIAogICAgKiBAcHJvcGVydHkge3N0cmluZ30gX29uT3V0RnJhbWVOYW1lIC0gSW50ZXJuYWwgdmFyaWFibGUuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb25PdXRGcmFtZU5hbWUgPSBudWxsOwogICAgCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBfb25Eb3duRnJhbWVOYW1lIC0gSW50ZXJuYWwgdmFyaWFibGUuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb25Eb3duRnJhbWVOYW1lID0gbnVsbDsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBfb25VcEZyYW1lTmFtZSAtIEludGVybmFsIHZhcmlhYmxlLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uVXBGcmFtZU5hbWUgPSBudWxsOwogICAgCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfb25PdmVyRnJhbWVJRCAtIEludGVybmFsIHZhcmlhYmxlLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uT3ZlckZyYW1lSUQgPSBudWxsOwogICAgCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfb25PdXRGcmFtZUlEIC0gSW50ZXJuYWwgdmFyaWFibGUuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb25PdXRGcmFtZUlEID0gbnVsbDsKICAgIAogICAgLyoqIAogICAgKiBAcHJvcGVydHkge251bWJlcn0gX29uRG93bkZyYW1lSUQgLSBJbnRlcm5hbCB2YXJpYWJsZS4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9vbkRvd25GcmFtZUlEID0gbnVsbDsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfb25VcEZyYW1lSUQgLSBJbnRlcm5hbCB2YXJpYWJsZS4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9vblVwRnJhbWVJRCA9IG51bGw7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Tb3VuZH0gb25PdmVyU291bmQgLSBUaGUgU291bmQgdG8gYmUgcGxheWVkIHdoZW4gdGhpcyBCdXR0b25zIE92ZXIgc3RhdGUgaXMgYWN0aXZhdGVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub25PdmVyU291bmQgPSBudWxsOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU291bmR9IG9uT3V0U291bmQgLSBUaGUgU291bmQgdG8gYmUgcGxheWVkIHdoZW4gdGhpcyBCdXR0b25zIE91dCBzdGF0ZSBpcyBhY3RpdmF0ZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vbk91dFNvdW5kID0gbnVsbDsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNvdW5kfSBvbkRvd25Tb3VuZCAtIFRoZSBTb3VuZCB0byBiZSBwbGF5ZWQgd2hlbiB0aGlzIEJ1dHRvbnMgRG93biBzdGF0ZSBpcyBhY3RpdmF0ZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vbkRvd25Tb3VuZCA9IG51bGw7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Tb3VuZH0gb25VcFNvdW5kIC0gVGhlIFNvdW5kIHRvIGJlIHBsYXllZCB3aGVuIHRoaXMgQnV0dG9ucyBVcCBzdGF0ZSBpcyBhY3RpdmF0ZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vblVwU291bmQgPSBudWxsOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG9uT3ZlclNvdW5kTWFya2VyIC0gVGhlIFNvdW5kIE1hcmtlciB1c2VkIGluIGNvbmp1bmN0aW9uIHdpdGggdGhlIG9uT3ZlclNvdW5kLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub25PdmVyU291bmRNYXJrZXIgPSAnJzsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBvbk91dFNvdW5kTWFya2VyIC0gVGhlIFNvdW5kIE1hcmtlciB1c2VkIGluIGNvbmp1bmN0aW9uIHdpdGggdGhlIG9uT3V0U291bmQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vbk91dFNvdW5kTWFya2VyID0gJyc7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge3N0cmluZ30gb25Eb3duU291bmRNYXJrZXIgLSBUaGUgU291bmQgTWFya2VyIHVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB0aGUgb25Eb3duU291bmQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vbkRvd25Tb3VuZE1hcmtlciA9ICcnOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG9uVXBTb3VuZE1hcmtlciAtIFRoZSBTb3VuZCBNYXJrZXIgdXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHRoZSBvblVwU291bmQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vblVwU291bmRNYXJrZXIgPSAnJzsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25JbnB1dE92ZXIgLSBUaGUgU2lnbmFsIChvciBldmVudCkgZGlzcGF0Y2hlZCB3aGVuIHRoaXMgQnV0dG9uIGlzIGluIGFuIE92ZXIgc3RhdGUuCiAgICAqLwogICAgdGhpcy5vbklucHV0T3ZlciA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbklucHV0T3V0IC0gVGhlIFNpZ25hbCAob3IgZXZlbnQpIGRpc3BhdGNoZWQgd2hlbiB0aGlzIEJ1dHRvbiBpcyBpbiBhbiBPdXQgc3RhdGUuCiAgICAqLwogICAgdGhpcy5vbklucHV0T3V0ID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIAogICAgLyoqIAogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uSW5wdXREb3duIC0gVGhlIFNpZ25hbCAob3IgZXZlbnQpIGRpc3BhdGNoZWQgd2hlbiB0aGlzIEJ1dHRvbiBpcyBpbiBhbiBEb3duIHN0YXRlLgogICAgKi8KICAgIHRoaXMub25JbnB1dERvd24gPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25JbnB1dFVwIC0gVGhlIFNpZ25hbCAob3IgZXZlbnQpIGRpc3BhdGNoZWQgd2hlbiB0aGlzIEJ1dHRvbiBpcyBpbiBhbiBVcCBzdGF0ZS4KICAgICovCiAgICB0aGlzLm9uSW5wdXRVcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZyZWV6ZUZyYW1lcyAtIFdoZW4gdHJ1ZSB0aGUgQnV0dG9uIHdpbGwgY2Vhc2UgdG8gY2hhbmdlIHRleHR1cmUgZnJhbWUgb24gYWxsIGV2ZW50cyAob3Zlciwgb3V0LCB1cCwgZG93bikuCiAgICAqLwogICAgdGhpcy5mcmVlemVGcmFtZXMgPSBmYWxzZTsKCiAgICAvKioKICAgICogV2hlbiB0aGUgQnV0dG9uIGlzIHRvdWNoZWQgLyBjbGlja2VkIGFuZCB0aGVuIHJlbGVhc2VkIHlvdSBjYW4gZm9yY2UgaXQgdG8gZW50ZXIgYSBzdGF0ZSBvZiAib3V0IiBpbnN0ZWFkIG9mICJ1cCIuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZm9yY2VPdXQKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZvcmNlT3V0ID0gZmFsc2U7CgogICAgdGhpcy5zZXRGcmFtZXMob3ZlckZyYW1lLCBvdXRGcmFtZSwgZG93bkZyYW1lLCB1cEZyYW1lKTsKCiAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwpCiAgICB7CiAgICAgICAgdGhpcy5vbklucHV0VXAuYWRkKGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgfQoKICAgIHRoaXMuaW5wdXQuc3RhcnQoMCwgdHJ1ZSk7CgogICAgLy8gIFJlZGlyZWN0IHRoZSBpbnB1dCBldmVudHMgdG8gaGVyZSBzbyB3ZSBjYW4gaGFuZGxlIGFuaW1hdGlvbiB1cGRhdGVzLCBldGMKICAgIHRoaXMuZXZlbnRzLm9uSW5wdXRPdmVyLmFkZCh0aGlzLm9uSW5wdXRPdmVySGFuZGxlciwgdGhpcyk7CiAgICB0aGlzLmV2ZW50cy5vbklucHV0T3V0LmFkZCh0aGlzLm9uSW5wdXRPdXRIYW5kbGVyLCB0aGlzKTsKICAgIHRoaXMuZXZlbnRzLm9uSW5wdXREb3duLmFkZCh0aGlzLm9uSW5wdXREb3duSGFuZGxlciwgdGhpcyk7CiAgICB0aGlzLmV2ZW50cy5vbklucHV0VXAuYWRkKHRoaXMub25JbnB1dFVwSGFuZGxlciwgdGhpcyk7Cgp9OwoKUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBoYXNlci5TcHJpdGUucHJvdG90eXBlKTsKUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUgPSBQaGFzZXIuVXRpbHMuZXh0ZW5kKHRydWUsIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLCBQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgUElYSS5TcHJpdGUucHJvdG90eXBlKTsKUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuQnV0dG9uOwoKLyoqCiogQ2xlYXJzIGFsbCBvZiB0aGUgZnJhbWVzIHNldCBvbiB0aGlzIEJ1dHRvbi4KKgoqIEBtZXRob2QgUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuY2xlYXJGcmFtZXMKKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuY2xlYXJGcmFtZXMgPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5fb25PdmVyRnJhbWVOYW1lID0gbnVsbDsKICAgIHRoaXMuX29uT3ZlckZyYW1lSUQgPSBudWxsOwoKICAgIHRoaXMuX29uT3V0RnJhbWVOYW1lID0gbnVsbDsKICAgIHRoaXMuX29uT3V0RnJhbWVJRCA9IG51bGw7CgogICAgdGhpcy5fb25Eb3duRnJhbWVOYW1lID0gbnVsbDsKICAgIHRoaXMuX29uRG93bkZyYW1lSUQgPSBudWxsOwoKICAgIHRoaXMuX29uVXBGcmFtZU5hbWUgPSBudWxsOwogICAgdGhpcy5fb25VcEZyYW1lSUQgPSBudWxsOwoKfQoKLyoqCiogVXNlZCB0byBtYW51YWxseSBzZXQgdGhlIGZyYW1lcyB0aGF0IHdpbGwgYmUgdXNlZCBmb3IgdGhlIGRpZmZlcmVudCBzdGF0ZXMgb2YgdGhlIEJ1dHRvbi4KKgoqIEBtZXRob2QgUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0RnJhbWVzCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbb3ZlckZyYW1lXSAtIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYW4gb3ZlciBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtvdXRGcmFtZV0gLSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGFuIG91dCBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtkb3duRnJhbWVdIC0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhIGRvd24gc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbdXBGcmFtZV0gLSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGFuIHVwIHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRGcmFtZXMgPSBmdW5jdGlvbiAob3ZlckZyYW1lLCBvdXRGcmFtZSwgZG93bkZyYW1lLCB1cEZyYW1lKSB7CgogICAgdGhpcy5jbGVhckZyYW1lcygpOwoKICAgIGlmIChvdmVyRnJhbWUgIT09IG51bGwpCiAgICB7CiAgICAgICAgaWYgKHR5cGVvZiBvdmVyRnJhbWUgPT09ICdzdHJpbmcnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fb25PdmVyRnJhbWVOYW1lID0gb3ZlckZyYW1lOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQucG9pbnRlck92ZXIoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSBvdmVyRnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fb25PdmVyRnJhbWVJRCA9IG92ZXJGcmFtZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LnBvaW50ZXJPdmVyKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZnJhbWUgPSBvdmVyRnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaWYgKG91dEZyYW1lICE9PSBudWxsKQogICAgewogICAgICAgIGlmICh0eXBlb2Ygb3V0RnJhbWUgPT09ICdzdHJpbmcnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fb25PdXRGcmFtZU5hbWUgPSBvdXRGcmFtZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LnBvaW50ZXJPdmVyKCkgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IG91dEZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uT3V0RnJhbWVJRCA9IG91dEZyYW1lOwoKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQucG9pbnRlck92ZXIoKSA9PT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZnJhbWUgPSBvdXRGcmFtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpZiAoZG93bkZyYW1lICE9PSBudWxsKQogICAgewogICAgICAgIGlmICh0eXBlb2YgZG93bkZyYW1lID09PSAnc3RyaW5nJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uRG93bkZyYW1lTmFtZSA9IGRvd25GcmFtZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LnBvaW50ZXJEb3duKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZnJhbWVOYW1lID0gZG93bkZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uRG93bkZyYW1lSUQgPSBkb3duRnJhbWU7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5wb2ludGVyRG93bigpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lID0gZG93bkZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGlmICh1cEZyYW1lICE9PSBudWxsKQogICAgewogICAgICAgIGlmICh0eXBlb2YgdXBGcmFtZSA9PT0gJ3N0cmluZycpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9vblVwRnJhbWVOYW1lID0gdXBGcmFtZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LnBvaW50ZXJVcCgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IHVwRnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fb25VcEZyYW1lSUQgPSB1cEZyYW1lOwoKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQucG9pbnRlclVwKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZnJhbWUgPSB1cEZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKfTsKCi8qKgoqIFNldHMgdGhlIHNvdW5kcyB0byBiZSBwbGF5ZWQgd2hlbmV2ZXIgdGhpcyBCdXR0b24gaXMgaW50ZXJhY3RlZCB3aXRoLiBTb3VuZHMgY2FuIGJlIGVpdGhlciBmdWxsIFNvdW5kIG9iamVjdHMsIG9yIG1hcmtlcnMgcG9pbnRpbmcgdG8gYSBzZWN0aW9uIG9mIGEgU291bmQgb2JqZWN0LgoqIFRoZSBtb3N0IGNvbW1vbiBmb3JtcyBvZiBzb3VuZHMgYXJlICdob3ZlcicgZWZmZWN0cyBhbmQgJ2NsaWNrJyBlZmZlY3RzLCB3aGljaCBpcyB3aHkgdGhlIG9yZGVyIG9mIHRoZSBwYXJhbWV0ZXJzIGlzIG92ZXJTb3VuZCB0aGVuIGRvd25Tb3VuZC4KKiBDYWxsIHRoaXMgZnVuY3Rpb24gd2l0aCBubyBwYXJhbWV0ZXJzIGF0IGFsbCB0byByZXNldCBhbGwgc291bmRzIG9uIHRoaXMgQnV0dG9uLgoqCiogQG1ldGhvZCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRTb3VuZHMKKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gW292ZXJTb3VuZF0gLSBPdmVyIEJ1dHRvbiBTb3VuZC4KKiBAcGFyYW0ge3N0cmluZ30gW292ZXJNYXJrZXJdIC0gT3ZlciBCdXR0b24gU291bmQgTWFya2VyLgoqIEBwYXJhbSB7UGhhc2VyLlNvdW5kfSBbZG93blNvdW5kXSAtIERvd24gQnV0dG9uIFNvdW5kLgoqIEBwYXJhbSB7c3RyaW5nfSBbZG93bk1hcmtlcl0gLSBEb3duIEJ1dHRvbiBTb3VuZCBNYXJrZXIuCiogQHBhcmFtIHtQaGFzZXIuU291bmR9IFtvdXRTb3VuZF0gLSBPdXQgQnV0dG9uIFNvdW5kLgoqIEBwYXJhbSB7c3RyaW5nfSBbb3V0TWFya2VyXSAtIE91dCBCdXR0b24gU291bmQgTWFya2VyLgoqIEBwYXJhbSB7UGhhc2VyLlNvdW5kfSBbdXBTb3VuZF0gLSBVcCBCdXR0b24gU291bmQuCiogQHBhcmFtIHtzdHJpbmd9IFt1cE1hcmtlcl0gLSBVcCBCdXR0b24gU291bmQgTWFya2VyLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRTb3VuZHMgPSBmdW5jdGlvbiAob3ZlclNvdW5kLCBvdmVyTWFya2VyLCBkb3duU291bmQsIGRvd25NYXJrZXIsIG91dFNvdW5kLCBvdXRNYXJrZXIsIHVwU291bmQsIHVwTWFya2VyKSB7CgogICAgdGhpcy5zZXRPdmVyU291bmQob3ZlclNvdW5kLCBvdmVyTWFya2VyKTsKICAgIHRoaXMuc2V0T3V0U291bmQob3V0U291bmQsIG91dE1hcmtlcik7CiAgICB0aGlzLnNldERvd25Tb3VuZChkb3duU291bmQsIGRvd25NYXJrZXIpOwogICAgdGhpcy5zZXRVcFNvdW5kKHVwU291bmQsIHVwTWFya2VyKTsKCn0KCi8qKgoqIFRoZSBTb3VuZCB0byBiZSBwbGF5ZWQgd2hlbiBhIFBvaW50ZXIgbW92ZXMgb3ZlciB0aGlzIEJ1dHRvbi4KKgoqIEBtZXRob2QgUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0T3ZlclNvdW5kCiogQHBhcmFtIHtQaGFzZXIuU291bmR9IHNvdW5kIC0gVGhlIFNvdW5kIHRoYXQgd2lsbCBiZSBwbGF5ZWQuCiogQHBhcmFtIHtzdHJpbmd9IFttYXJrZXJdIC0gQSBTb3VuZCBNYXJrZXIgdGhhdCB3aWxsIGJlIHVzZWQgaW4gdGhlIHBsYXliYWNrLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRPdmVyU291bmQgPSBmdW5jdGlvbiAoc291bmQsIG1hcmtlcikgewoKICAgIHRoaXMub25PdmVyU291bmQgPSBudWxsOwogICAgdGhpcy5vbk92ZXJTb3VuZE1hcmtlciA9ICcnOwoKICAgIGlmIChzb3VuZCBpbnN0YW5jZW9mIFBoYXNlci5Tb3VuZCkKICAgIHsKICAgICAgICB0aGlzLm9uT3ZlclNvdW5kID0gc291bmQ7CiAgICB9CgogICAgaWYgKHR5cGVvZiBtYXJrZXIgPT09ICdzdHJpbmcnKQogICAgewogICAgICAgIHRoaXMub25PdmVyU291bmRNYXJrZXIgPSBtYXJrZXI7CiAgICB9Cgp9CgovKioKKiBUaGUgU291bmQgdG8gYmUgcGxheWVkIHdoZW4gYSBQb2ludGVyIG1vdmVzIG91dCBvZiB0aGlzIEJ1dHRvbi4KKgoqIEBtZXRob2QgUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0T3V0U291bmQKKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gc291bmQgLSBUaGUgU291bmQgdGhhdCB3aWxsIGJlIHBsYXllZC4KKiBAcGFyYW0ge3N0cmluZ30gW21hcmtlcl0gLSBBIFNvdW5kIE1hcmtlciB0aGF0IHdpbGwgYmUgdXNlZCBpbiB0aGUgcGxheWJhY2suCiovClBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldE91dFNvdW5kID0gZnVuY3Rpb24gKHNvdW5kLCBtYXJrZXIpIHsKCiAgICB0aGlzLm9uT3V0U291bmQgPSBudWxsOwogICAgdGhpcy5vbk91dFNvdW5kTWFya2VyID0gJyc7CgogICAgaWYgKHNvdW5kIGluc3RhbmNlb2YgUGhhc2VyLlNvdW5kKQogICAgewogICAgICAgIHRoaXMub25PdXRTb3VuZCA9IHNvdW5kOwogICAgfQoKICAgIGlmICh0eXBlb2YgbWFya2VyID09PSAnc3RyaW5nJykKICAgIHsKICAgICAgICB0aGlzLm9uT3V0U291bmRNYXJrZXIgPSBtYXJrZXI7CiAgICB9Cgp9CgovKioKKiBUaGUgU291bmQgdG8gYmUgcGxheWVkIHdoZW4gYSBQb2ludGVyIHByZXNzZXMgZG93biBvbiB0aGlzIEJ1dHRvbi4KKgoqIEBtZXRob2QgUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0RG93blNvdW5kCiogQHBhcmFtIHtQaGFzZXIuU291bmR9IHNvdW5kIC0gVGhlIFNvdW5kIHRoYXQgd2lsbCBiZSBwbGF5ZWQuCiogQHBhcmFtIHtzdHJpbmd9IFttYXJrZXJdIC0gQSBTb3VuZCBNYXJrZXIgdGhhdCB3aWxsIGJlIHVzZWQgaW4gdGhlIHBsYXliYWNrLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXREb3duU291bmQgPSBmdW5jdGlvbiAoc291bmQsIG1hcmtlcikgewoKICAgIHRoaXMub25Eb3duU291bmQgPSBudWxsOwogICAgdGhpcy5vbkRvd25Tb3VuZE1hcmtlciA9ICcnOwoKICAgIGlmIChzb3VuZCBpbnN0YW5jZW9mIFBoYXNlci5Tb3VuZCkKICAgIHsKICAgICAgICB0aGlzLm9uRG93blNvdW5kID0gc291bmQ7CiAgICB9CgogICAgaWYgKHR5cGVvZiBtYXJrZXIgPT09ICdzdHJpbmcnKQogICAgewogICAgICAgIHRoaXMub25Eb3duU291bmRNYXJrZXIgPSBtYXJrZXI7CiAgICB9Cgp9CgovKioKKiBUaGUgU291bmQgdG8gYmUgcGxheWVkIHdoZW4gYSBQb2ludGVyIGhhcyBwcmVzc2VkIGRvd24gYW5kIGlzIHJlbGVhc2VkIGZyb20gdGhpcyBCdXR0b24uCioKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldFVwU291bmQKKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gc291bmQgLSBUaGUgU291bmQgdGhhdCB3aWxsIGJlIHBsYXllZC4KKiBAcGFyYW0ge3N0cmluZ30gW21hcmtlcl0gLSBBIFNvdW5kIE1hcmtlciB0aGF0IHdpbGwgYmUgdXNlZCBpbiB0aGUgcGxheWJhY2suCiovClBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldFVwU291bmQgPSBmdW5jdGlvbiAoc291bmQsIG1hcmtlcikgewoKICAgIHRoaXMub25VcFNvdW5kID0gbnVsbDsKICAgIHRoaXMub25VcFNvdW5kTWFya2VyID0gJyc7CgogICAgaWYgKHNvdW5kIGluc3RhbmNlb2YgUGhhc2VyLlNvdW5kKQogICAgewogICAgICAgIHRoaXMub25VcFNvdW5kID0gc291bmQ7CiAgICB9CgogICAgaWYgKHR5cGVvZiBtYXJrZXIgPT09ICdzdHJpbmcnKQogICAgewogICAgICAgIHRoaXMub25VcFNvdW5kTWFya2VyID0gbWFya2VyOwogICAgfQoKfQoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIGlucHV0IGV2ZW50cy4KKgoqIEBwcm90ZWN0ZWQKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLm9uSW5wdXRPdmVySGFuZGxlcgoqIEBwYXJhbSB7UGhhc2VyLkJ1dHRvbn0gc3ByaXRlIC0gVGhlIEJ1dHRvbiB0aGF0IHRoZSBldmVudCBvY2N1cmVkIG9uLgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIgLSBUaGUgUG9pbnRlciB0aGF0IGFjdGl2YXRlZCB0aGUgQnV0dG9uLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0T3ZlckhhbmRsZXIgPSBmdW5jdGlvbiAoc3ByaXRlLCBwb2ludGVyKSB7CgogICAgaWYgKHRoaXMuZnJlZXplRnJhbWVzID09PSBmYWxzZSkKICAgIHsKICAgICAgICB0aGlzLnNldFN0YXRlKDEpOwogICAgfQoKICAgIGlmICh0aGlzLm9uT3ZlclNvdW5kKQogICAgewogICAgICAgIHRoaXMub25PdmVyU291bmQucGxheSh0aGlzLm9uT3ZlclNvdW5kTWFya2VyKTsKICAgIH0KCiAgICBpZiAodGhpcy5vbklucHV0T3ZlcikKICAgIHsKICAgICAgICB0aGlzLm9uSW5wdXRPdmVyLmRpc3BhdGNoKHRoaXMsIHBvaW50ZXIpOwogICAgfQp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIGlucHV0IGV2ZW50cy4KKgoqIEBwcm90ZWN0ZWQKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLm9uSW5wdXRPdmVySGFuZGxlcgoqIEBwYXJhbSB7UGhhc2VyLkJ1dHRvbn0gc3ByaXRlIC0gVGhlIEJ1dHRvbiB0aGF0IHRoZSBldmVudCBvY2N1cmVkIG9uLgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIgLSBUaGUgUG9pbnRlciB0aGF0IGFjdGl2YXRlZCB0aGUgQnV0dG9uLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0T3V0SGFuZGxlciA9IGZ1bmN0aW9uIChzcHJpdGUsIHBvaW50ZXIpIHsKCiAgICBpZiAodGhpcy5mcmVlemVGcmFtZXMgPT09IGZhbHNlKQogICAgewogICAgICAgIHRoaXMuc2V0U3RhdGUoMik7CiAgICB9CgogICAgaWYgKHRoaXMub25PdXRTb3VuZCkKICAgIHsKICAgICAgICB0aGlzLm9uT3V0U291bmQucGxheSh0aGlzLm9uT3V0U291bmRNYXJrZXIpOwogICAgfQoKICAgIGlmICh0aGlzLm9uSW5wdXRPdXQpCiAgICB7CiAgICAgICAgdGhpcy5vbklucHV0T3V0LmRpc3BhdGNoKHRoaXMsIHBvaW50ZXIpOwogICAgfQp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIGlucHV0IGV2ZW50cy4KKgoqIEBwcm90ZWN0ZWQKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLm9uSW5wdXRPdmVySGFuZGxlcgoqIEBwYXJhbSB7UGhhc2VyLkJ1dHRvbn0gc3ByaXRlIC0gVGhlIEJ1dHRvbiB0aGF0IHRoZSBldmVudCBvY2N1cmVkIG9uLgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIgLSBUaGUgUG9pbnRlciB0aGF0IGFjdGl2YXRlZCB0aGUgQnV0dG9uLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0RG93bkhhbmRsZXIgPSBmdW5jdGlvbiAoc3ByaXRlLCBwb2ludGVyKSB7CgogICAgaWYgKHRoaXMuZnJlZXplRnJhbWVzID09PSBmYWxzZSkKICAgIHsKICAgICAgICB0aGlzLnNldFN0YXRlKDMpOwogICAgfQoKICAgIGlmICh0aGlzLm9uRG93blNvdW5kKQogICAgewogICAgICAgIHRoaXMub25Eb3duU291bmQucGxheSh0aGlzLm9uRG93blNvdW5kTWFya2VyKTsKICAgIH0KCiAgICBpZiAodGhpcy5vbklucHV0RG93bikKICAgIHsKICAgICAgICB0aGlzLm9uSW5wdXREb3duLmRpc3BhdGNoKHRoaXMsIHBvaW50ZXIpOwogICAgfQp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIGlucHV0IGV2ZW50cy4KKgoqIEBwcm90ZWN0ZWQKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLm9uSW5wdXRPdmVySGFuZGxlcgoqIEBwYXJhbSB7UGhhc2VyLkJ1dHRvbn0gc3ByaXRlIC0gVGhlIEJ1dHRvbiB0aGF0IHRoZSBldmVudCBvY2N1cmVkIG9uLgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIgLSBUaGUgUG9pbnRlciB0aGF0IGFjdGl2YXRlZCB0aGUgQnV0dG9uLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0VXBIYW5kbGVyID0gZnVuY3Rpb24gKHNwcml0ZSwgcG9pbnRlciwgaXNPdmVyKSB7CgogICAgaWYgKHRoaXMub25VcFNvdW5kKQogICAgewogICAgICAgIHRoaXMub25VcFNvdW5kLnBsYXkodGhpcy5vblVwU291bmRNYXJrZXIpOwogICAgfQoKICAgIGlmICh0aGlzLm9uSW5wdXRVcCkKICAgIHsKICAgICAgICB0aGlzLm9uSW5wdXRVcC5kaXNwYXRjaCh0aGlzLCBwb2ludGVyLCBpc092ZXIpOwogICAgfQoKICAgIGlmICh0aGlzLmZyZWV6ZUZyYW1lcykKICAgIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHRoaXMuZm9yY2VPdXQpCiAgICB7CiAgICAgICAgLy8gIEJ1dHRvbiBzaG91bGQgYmUgZm9yY2VkIHRvIHRoZSBPdXQgZnJhbWUgd2hlbiByZWxlYXNlZC4KICAgICAgICB0aGlzLnNldFN0YXRlKDIpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGlmICh0aGlzLl9vblVwRnJhbWVOYW1lIHx8IHRoaXMuX29uVXBGcmFtZUlEKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSg0KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzT3ZlcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSgxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoMik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cgp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIEJ1dHRvbiBzdGF0ZSBjaGFuZ2VzLgoqCiogQHByb3RlY3RlZAoqIEBtZXRob2QgUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0U3RhdGUKKiBAcGFyYW0ge251bWJlcn0gbmV3U3RhdGUgLSBUaGUgbmV3IFN0YXRlIG9mIHRoZSBCdXR0b24uCiovClBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKG5ld1N0YXRlKSB7CgogICAgaWYgKG5ld1N0YXRlID09PSAxKQogICAgewogICAgICAgIC8vICBPdmVyCiAgICAgICAgaWYgKHRoaXMuX29uT3ZlckZyYW1lTmFtZSAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSB0aGlzLl9vbk92ZXJGcmFtZU5hbWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMuX29uT3ZlckZyYW1lSUQgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWUgPSB0aGlzLl9vbk92ZXJGcmFtZUlEOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgaWYgKG5ld1N0YXRlID09PSAyKQogICAgewogICAgICAgIC8vICBPdXQKICAgICAgICBpZiAodGhpcy5fb25PdXRGcmFtZU5hbWUgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWVOYW1lID0gdGhpcy5fb25PdXRGcmFtZU5hbWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMuX29uT3V0RnJhbWVJRCAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZSA9IHRoaXMuX29uT3V0RnJhbWVJRDsKICAgICAgICB9CiAgICB9CiAgICBlbHNlIGlmIChuZXdTdGF0ZSA9PT0gMykKICAgIHsKICAgICAgICAvLyAgRG93bgogICAgICAgIGlmICh0aGlzLl9vbkRvd25GcmFtZU5hbWUgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWVOYW1lID0gdGhpcy5fb25Eb3duRnJhbWVOYW1lOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLl9vbkRvd25GcmFtZUlEICE9IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZyYW1lID0gdGhpcy5fb25Eb3duRnJhbWVJRDsKICAgICAgICB9CiAgICB9CiAgICBlbHNlIGlmIChuZXdTdGF0ZSA9PT0gNCkKICAgIHsKICAgICAgICAvLyAgVXAKICAgICAgICBpZiAodGhpcy5fb25VcEZyYW1lTmFtZSAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSB0aGlzLl9vblVwRnJhbWVOYW1lOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLl9vblVwRnJhbWVJRCAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZSA9IHRoaXMuX29uVXBGcmFtZUlEOwogICAgICAgIH0KICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGVzIGEgbmV3IGBHcmFwaGljc2Agb2JqZWN0LgoqIAoqIEBjbGFzcyBQaGFzZXIuR3JhcGhpY3MKKiBAY29uc3RydWN0b3IKKgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IGdyYXBoaWNzIG9iamVjdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyBncmFwaGljcyBvYmplY3QuCiovClBoYXNlci5HcmFwaGljcyA9IGZ1bmN0aW9uIChnYW1lLCB4LCB5KSB7CgogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICBQSVhJLkdyYXBoaWNzLmNhbGwodGhpcyk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0eXBlIC0gVGhlIFBoYXNlciBPYmplY3QgVHlwZS4KCSovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuR1JBUEhJQ1M7CgogICAgdGhpcy5wb3NpdGlvbi54ID0geDsKICAgIHRoaXMucG9zaXRpb24ueSA9IHk7Cgp9OwoKUGhhc2VyLkdyYXBoaWNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5HcmFwaGljcy5wcm90b3R5cGUpOwpQaGFzZXIuR3JhcGhpY3MucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkdyYXBoaWNzOwoKLyoqCiogRGVzdHJveSB0aGlzIEdyYXBoaWNzIGluc3RhbmNlLgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUuZGVzdHJveQoqLwpQaGFzZXIuR3JhcGhpY3MucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCiAgICB0aGlzLmNsZWFyKCk7CgogICAgaWYgKHRoaXMuZ3JvdXApCiAgICB7CiAgICAgICAgdGhpcy5ncm91cC5yZW1vdmUodGhpcyk7CiAgICB9CgogICAgdGhpcy5nYW1lID0gbnVsbDsKCn0KCi8qCiogRHJhd3MgYSB7UGhhc2VyLlBvbHlnb259IG9yIGEge1BJWEkuUG9seWdvbn0gZmlsbGVkCiovClBoYXNlci5HcmFwaGljcy5wcm90b3R5cGUuZHJhd1BvbHlnb24gPSBmdW5jdGlvbiAocG9seSkgewoKICAgIHRoaXMubW92ZVRvKHBvbHkucG9pbnRzWzBdLngsIHBvbHkucG9pbnRzWzBdLnkpOwoKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgcG9seS5wb2ludHMubGVuZ3RoOyBpICs9IDEpCiAgICB7CiAgICAgICAgdGhpcy5saW5lVG8ocG9seS5wb2ludHNbaV0ueCwgcG9seS5wb2ludHNbaV0ueSk7CiAgICB9CgogICAgdGhpcy5saW5lVG8ocG9seS5wb2ludHNbMF0ueCwgcG9seS5wb2ludHNbMF0ueSk7CiAgICAKfQoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5HcmFwaGljcy5wcm90b3R5cGUsICdhbmdsZScsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBQaGFzZXIuTWF0aC53cmFwQW5nbGUoUGhhc2VyLk1hdGgucmFkVG9EZWcodGhpcy5yb3RhdGlvbikpOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5yb3RhdGlvbiA9IFBoYXNlci5NYXRoLmRlZ1RvUmFkKFBoYXNlci5NYXRoLndyYXBBbmdsZSh2YWx1ZSkpOwogICAgfQoKfSk7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyYXBoaWNzLnByb3RvdHlwZSwgJ3gnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5wb3NpdGlvbi54OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5wb3NpdGlvbi54ID0gdmFsdWU7CiAgICB9Cgp9KTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JhcGhpY3MucHJvdG90eXBlLCAneScsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLnk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLnkgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQSBSZW5kZXJUZXh0dXJlIGlzIGEgc3BlY2lhbCB0ZXh0dXJlIHRoYXQgYWxsb3dzIGFueSBkaXNwbGF5T2JqZWN0IHRvIGJlIHJlbmRlcmVkIHRvIGl0LgoqIEBjbGFzcyBQaGFzZXIuUmVuZGVyVGV4dHVyZQoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBDdXJyZW50IGdhbWUgaW5zdGFuY2UuCiogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHJlbmRlciB0ZXh0dXJlLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIHRoZSB3aWR0aCBvZiB0aGUgcmVuZGVyIHRleHR1cmUuCiogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIHRoZSBoZWlnaHQgb2YgdGhlIHJlbmRlciB0ZXh0dXJlLgoqLwpQaGFzZXIuUmVuZGVyVGV4dHVyZSA9IGZ1bmN0aW9uIChnYW1lLCBrZXksIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLiAKICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIHRoZSBuYW1lIG9mIHRoZSBvYmplY3QuIAogICAgKi8KICAgIHRoaXMubmFtZSA9IGtleTsKCiAgICBQSVhJLkV2ZW50VGFyZ2V0LmNhbGwodGhpcyk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIHRoZSB3aWR0aC4gCiAgICAqLwogICAgdGhpcy53aWR0aCA9IHdpZHRoIHx8IDEwMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSB0aGUgaGVpZ2h0LiAKICAgICovCiAgICB0aGlzLmhlaWdodCA9IGhlaWdodCB8fCAxMDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UElYSS5tYXQzfSBpbmRldGl0eU1hdHJpeCAtIE1hdHJpeCBvYmplY3QuIAogICAgKi8KICAgIHRoaXMuaW5kZXRpdHlNYXRyaXggPSBQSVhJLm1hdDMuY3JlYXRlKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UElYSS5SZWN0YW5nbGV9IGZyYW1lIC0gVGhlIGZyYW1lIGZvciB0aGlzIHRleHR1cmUuIAogICAgKi8KICAgIHRoaXMuZnJhbWUgPSBuZXcgUElYSS5SZWN0YW5nbGUoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIEJhc2UgUGhhc2VyIG9iamVjdCB0eXBlLiAKICAgICovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuUkVOREVSVEVYVFVSRTsKCiAgICB0aGlzLl90ZW1wUG9pbnQgPSB7IHg6IDAsIHk6IDAgfTsKCiAgICBpZiAoUElYSS5nbCkKICAgIHsKICAgICAgICB0aGlzLmluaXRXZWJHTCgpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMuaW5pdENhbnZhcygpOwogICAgfQogICAgCn07CgpQaGFzZXIuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuVGV4dHVyZS5wcm90b3R5cGUpOwpQaGFzZXIuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlJlbmRlclRleHR1cmU7CgovKioKKiBUaGlzIGZ1bmN0aW9uIHdpbGwgZHJhdyB0aGUgZGlzcGxheSBvYmplY3QgdG8gdGhlIHRleHR1cmUuIElmIHRoZSBkaXNwbGF5IG9iamVjdCBpcyBhIEdyb3VwIG9yIGhhcyBjaGlsZHJlbiBpdCB3aWxsCiogZHJhdyBhbGwgY2hpbGRyZW4gYXMgd2VsbC4KKiAKKiBAbWV0aG9kIFBoYXNlci5SZW5kZXJUZXh0dXJlI3JlbmRlcgoqIEBtZW1iZXJvZiBQaGFzZXIuUmVuZGVyVGV4dHVyZQoqIEBwYXJhbSB7RGlzcGxheU9iamVjdH0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byByZW5kZXIgdGhpcyB0ZXh0dXJlIG9uLgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbcG9zaXRpb25dIC0gV2hlcmUgdG8gZHJhdyB0aGUgZGlzcGxheSBvYmplY3QuCiogQHBhcmFtIHtib29sZWFufSBbY2xlYXI9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgdGV4dHVyZSB3aWxsIGJlIGNsZWFyZWQgYmVmb3JlIHRoZSBkaXNwbGF5T2JqZWN0IGlzIGRyYXduLgoqIEBwYXJhbSB7Ym9vbGVhbn0gW3JlbmRlckhpZGRlbj1mYWxzZV0gLSBJZiB0cnVlIGRpc3BsYXlPYmplY3RzIHRoYXQgaGF2ZSB0aGVpciB2aXNpYmxlIHByb3BlcnR5IHNldCB0byBmYWxzZSB3aWxsIHN0aWxsIGJlIHJlbmRlcmVkLgoqLwpQaGFzZXIuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcG9zaXRpb24sIGNsZWFyLCByZW5kZXJIaWRkZW4pIHsKCiAgICBpZiAodHlwZW9mIHBvc2l0aW9uID09PSAndW5kZWZpbmVkJykgeyBwb3NpdGlvbiA9IGZhbHNlOyB9CiAgICBpZiAodHlwZW9mIGNsZWFyID09PSAndW5kZWZpbmVkJykgeyBjbGVhciA9IGZhbHNlOyB9CiAgICBpZiAodHlwZW9mIHJlbmRlckhpZGRlbiA9PT0gJ3VuZGVmaW5lZCcpIHsgcmVuZGVySGlkZGVuID0gZmFsc2U7IH0KCiAgICBpZiAoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBoYXNlci5Hcm91cCkKICAgIHsKICAgICAgICBkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5fY29udGFpbmVyOwogICAgfQoKICAgIGlmIChQSVhJLmdsKQogICAgewogICAgICAgIHRoaXMucmVuZGVyV2ViR0woZGlzcGxheU9iamVjdCwgcG9zaXRpb24sIGNsZWFyLCByZW5kZXJIaWRkZW4pOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMucmVuZGVyQ2FudmFzKGRpc3BsYXlPYmplY3QsIHBvc2l0aW9uLCBjbGVhciwgcmVuZGVySGlkZGVuKTsKICAgIH0KCn0KCi8qKgoqIFRoaXMgZnVuY3Rpb24gd2lsbCBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdCB0byB0aGUgdGV4dHVyZSBhdCB0aGUgZ2l2ZW4geC95IGNvb3JkaW5hdGVzLgoqIElmIHRoZSBkaXNwbGF5IG9iamVjdCBpcyBhIEdyb3VwIG9yIGhhcyBjaGlsZHJlbiBpdCB3aWxsIGRyYXcgYWxsIGNoaWxkcmVuIGFzIHdlbGwuCioKKiBAbWV0aG9kIFBoYXNlci5SZW5kZXJUZXh0dXJlI3JlbmRlclhZCiogQG1lbWJlcm9mIFBoYXNlci5SZW5kZXJUZXh0dXJlCiogQHBhcmFtIHtEaXNwbGF5T2JqZWN0fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIHJlbmRlciB0aGlzIHRleHR1cmUgb24uCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIGRyYXcgdGhlIGRpc3BsYXkgb2JqZWN0IGF0LgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSB0byBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdCBhdC4KKiBAcGFyYW0ge2Jvb2xlYW59IFtjbGVhcj1mYWxzZV0gLSBJZiB0cnVlIHRoZSB0ZXh0dXJlIHdpbGwgYmUgY2xlYXJlZCBiZWZvcmUgdGhlIGRpc3BsYXlPYmplY3QgaXMgZHJhd24uCiogQHBhcmFtIHtib29sZWFufSBbcmVuZGVySGlkZGVuPWZhbHNlXSAtIElmIHRydWUgZGlzcGxheU9iamVjdHMgdGhhdCBoYXZlIHRoZWlyIHZpc2libGUgcHJvcGVydHkgc2V0IHRvIGZhbHNlIHdpbGwgc3RpbGwgYmUgcmVuZGVyZWQuCiovClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5yZW5kZXJYWSA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QsIHgsIHksIGNsZWFyLCByZW5kZXJIaWRkZW4pIHsKCiAgICB0aGlzLl90ZW1wUG9pbnQueCA9IHg7CiAgICB0aGlzLl90ZW1wUG9pbnQueSA9IHk7CgogICAgdGhpcy5yZW5kZXIoZGlzcGxheU9iamVjdCwgdGhpcy5fdGVtcFBvaW50LCBjbGVhciwgcmVuZGVySGlkZGVuKTsKCn0KCi8qKgoqIEluaXRpYWxpemVzIHRoZSB3ZWJnbCBkYXRhIGZvciB0aGlzIHRleHR1cmUKKgoqIEBtZXRob2QgUGhhc2VyLlJlbmRlclRleHR1cmUjaW5pdFdlYkdMCiogQG1lbWJlcm9mIFBoYXNlci5SZW5kZXJUZXh0dXJlCiogQHByaXZhdGUKKi8KUGhhc2VyLlJlbmRlclRleHR1cmUucHJvdG90eXBlLmluaXRXZWJHTCA9IGZ1bmN0aW9uKCkgewoKICAgIHZhciBnbCA9IFBJWEkuZ2w7CiAgICB0aGlzLmdsRnJhbWVidWZmZXIgPSBnbC5jcmVhdGVGcmFtZWJ1ZmZlcigpOwoKICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGhpcy5nbEZyYW1lYnVmZmVyICk7CgogICAgdGhpcy5nbEZyYW1lYnVmZmVyLndpZHRoID0gdGhpcy53aWR0aDsKICAgIHRoaXMuZ2xGcmFtZWJ1ZmZlci5oZWlnaHQgPSB0aGlzLmhlaWdodDsKCiAgICB0aGlzLmJhc2VUZXh0dXJlID0gbmV3IFBJWEkuQmFzZVRleHR1cmUoKTsKCiAgICB0aGlzLmJhc2VUZXh0dXJlLndpZHRoID0gdGhpcy53aWR0aDsKICAgIHRoaXMuYmFzZVRleHR1cmUuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CgogICAgdGhpcy5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlID0gZ2wuY3JlYXRlVGV4dHVyZSgpOwogICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgdGhpcy5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlKTsKCiAgICBnbC50ZXhJbWFnZTJEKGdsLlRFWFRVUkVfMkQsIDAsIGdsLlJHQkEsICB0aGlzLndpZHRoLCAgdGhpcy5oZWlnaHQsIDAsIGdsLlJHQkEsIGdsLlVOU0lHTkVEX0JZVEUsIG51bGwpOwoKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NQUdfRklMVEVSLCBnbC5MSU5FQVIpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01JTl9GSUxURVIsIGdsLkxJTkVBUik7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9TLCBnbC5DTEFNUF9UT19FREdFKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1QsIGdsLkNMQU1QX1RPX0VER0UpOwoKICAgIHRoaXMuYmFzZVRleHR1cmUuaXNSZW5kZXIgPSB0cnVlOwoKICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGhpcy5nbEZyYW1lYnVmZmVyICk7CiAgICBnbC5mcmFtZWJ1ZmZlclRleHR1cmUyRChnbC5GUkFNRUJVRkZFUiwgZ2wuQ09MT1JfQVRUQUNITUVOVDAsIGdsLlRFWFRVUkVfMkQsIHRoaXMuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSwgMCk7CgogICAgLy8gY3JlYXRlIGEgcHJvamVjdGlvbiBtYXRyaXguLgogICAgdGhpcy5wcm9qZWN0aW9uID0gbmV3IFBJWEkuUG9pbnQodGhpcy53aWR0aC8yICwgLXRoaXMuaGVpZ2h0LzIpOwoKICAgIC8vIHNldCB0aGUgY29ycmVjdCByZW5kZXIgZnVuY3Rpb24uLgogICAgLy8gdGhpcy5yZW5kZXIgPSB0aGlzLnJlbmRlcldlYkdMOwp9CgovKioKKiBSZXNpemVzIHRoZSBSZW5kZXJUZXh0dXJlLgoqCiogQG1ldGhvZCBQaGFzZXIuUmVuZGVyVGV4dHVyZSNyZXNpemUKKiBAbWVtYmVyb2YgUGhhc2VyLlJlbmRlclRleHR1cmUKKi8KUGhhc2VyLlJlbmRlclRleHR1cmUucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCnsKCiAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKICAgIAogICAgaWYoUElYSS5nbCkKICAgIHsKICAgICAgICB0aGlzLnByb2plY3Rpb24ueCA9IHRoaXMud2lkdGgvMgogICAgICAgIHRoaXMucHJvamVjdGlvbi55ID0gLXRoaXMuaGVpZ2h0LzI7CiAgICAKICAgICAgICB2YXIgZ2wgPSBQSVhJLmdsOwogICAgICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRoaXMuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CiAgICAgICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCAgdGhpcy53aWR0aCwgIHRoaXMuaGVpZ2h0LCAwLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICAKICAgICAgICB0aGlzLmZyYW1lLndpZHRoID0gdGhpcy53aWR0aAogICAgICAgIHRoaXMuZnJhbWUuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CiAgICAgICAgdGhpcy5yZW5kZXJlci5yZXNpemUodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwogICAgfQp9CgovKioKKiBJbml0aWFsaXplcyB0aGUgY2FudmFzIGRhdGEgZm9yIHRoaXMgdGV4dHVyZQoqCiogQG1ldGhvZCBQaGFzZXIuUmVuZGVyVGV4dHVyZSNpbml0Q2FudmFzCiogQG1lbWJlcm9mIFBoYXNlci5SZW5kZXJUZXh0dXJlCiogQHByaXZhdGUKKi8KUGhhc2VyLlJlbmRlclRleHR1cmUucHJvdG90eXBlLmluaXRDYW52YXMgPSBmdW5jdGlvbigpCnsKICAgIHRoaXMucmVuZGVyZXIgPSBuZXcgUElYSS5DYW52YXNSZW5kZXJlcih0aGlzLndpZHRoLCB0aGlzLmhlaWdodCwgbnVsbCwgMCk7CgogICAgdGhpcy5iYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKHRoaXMucmVuZGVyZXIudmlldyk7CiAgICB0aGlzLmZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCiAgICAvLyB0aGlzLnJlbmRlciA9IHRoaXMucmVuZGVyQ2FudmFzOwp9CgovKioKKiBUaGlzIGZ1bmN0aW9uIHdpbGwgZHJhdyB0aGUgZGlzcGxheSBvYmplY3QgdG8gdGhlIHRleHR1cmUuCioKKiBAbWV0aG9kIFBoYXNlci5SZW5kZXJUZXh0dXJlI3JlbmRlcldlYkdMCiogQG1lbWJlcm9mIFBoYXNlci5SZW5kZXJUZXh0dXJlCiogQHByaXZhdGUKKiBAcGFyYW0ge0Rpc3BsYXlPYmplY3R9IGRpc3BsYXlPYmplY3QgLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gcmVuZGVyIHRoaXMgdGV4dHVyZSBvbi4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW3Bvc2l0aW9uXSAtIFdoZXJlIHRvIGRyYXcgdGhlIGRpc3BsYXkgb2JqZWN0LgoqIEBwYXJhbSB7Ym9vbGVhbn0gW2NsZWFyPWZhbHNlXSAtIElmIHRydWUgdGhlIHRleHR1cmUgd2lsbCBiZSBjbGVhcmVkIGJlZm9yZSB0aGUgZGlzcGxheU9iamVjdCBpcyBkcmF3bi4KKiBAcGFyYW0ge2Jvb2xlYW59IFtyZW5kZXJIaWRkZW49ZmFsc2VdIC0gSWYgdHJ1ZSBkaXNwbGF5T2JqZWN0cyB0aGF0IGhhdmUgdGhlaXIgdmlzaWJsZSBwcm9wZXJ0eSBzZXQgdG8gZmFsc2Ugd2lsbCBzdGlsbCBiZSByZW5kZXJlZC4KKi8KUGhhc2VyLlJlbmRlclRleHR1cmUucHJvdG90eXBlLnJlbmRlcldlYkdMID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcG9zaXRpb24sIGNsZWFyLCByZW5kZXJIaWRkZW4pCnsKICAgIHZhciBnbCA9IFBJWEkuZ2w7CgogICAgLy8gZW5hYmxlIHRoZSBhbHBoYSBjb2xvciBtYXNrLi4KICAgIGdsLmNvbG9yTWFzayh0cnVlLCB0cnVlLCB0cnVlLCB0cnVlKTsKCiAgICBnbC52aWV3cG9ydCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgogICAgZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0aGlzLmdsRnJhbWVidWZmZXIgKTsKCiAgICBpZiAoY2xlYXIpCiAgICB7CiAgICAgICAgZ2wuY2xlYXJDb2xvcigwLDAsMCwgMCk7CiAgICAgICAgZ2wuY2xlYXIoZ2wuQ09MT1JfQlVGRkVSX0JJVCk7CiAgICB9CgogICAgLy8gVEhJUyBXSUxMIE1FU1MgV0lUSCBISVQgVEVTVElORyEKICAgIHZhciBjaGlsZHJlbiA9IGRpc3BsYXlPYmplY3QuY2hpbGRyZW47CgogICAgLy9UT0RPIC0/IGNyZWF0ZSBhIG5ldyBvbmU/Pz8gZG9udCB0aGluayBzbyEKICAgIHZhciBvcmlnaW5hbFdvcmxkVHJhbnNmb3JtID0gZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybTsKICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm0gPSBQSVhJLm1hdDMuY3JlYXRlKCk7Ly9zdGhpcy5pbmRldGl0eU1hdHJpeDsKICAgIC8vIG1vZGlmeSB0byBmbGlwLi4uCiAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzRdID0gLTE7CiAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdID0gdGhpcy5wcm9qZWN0aW9uLnkgKiAtMjsKCiAgICBpZiAocG9zaXRpb24pCiAgICB7CiAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsyXSA9IHBvc2l0aW9uLng7CiAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSAtPSBwb3NpdGlvbi55OwogICAgfQogICAgCiAgICBQSVhJLnZpc2libGVDb3VudCsrOwogICAgZGlzcGxheU9iamVjdC52Y291bnQgPSBQSVhJLnZpc2libGVDb3VudDsKICAgIAogICAgZm9yICh2YXIgaSA9IDAsIGogPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICB7CiAgICAgICAgY2hpbGRyZW5baV0udXBkYXRlVHJhbnNmb3JtKCk7CiAgICB9CgogICAgdmFyIHJlbmRlckdyb3VwID0gZGlzcGxheU9iamVjdC5fX3JlbmRlckdyb3VwOwoKICAgIGlmIChyZW5kZXJHcm91cCkKICAgIHsKICAgICAgICBpZiAoZGlzcGxheU9iamVjdCA9PSByZW5kZXJHcm91cC5yb290KQogICAgICAgIHsKICAgICAgICAgICAgcmVuZGVyR3JvdXAucmVuZGVyKHRoaXMucHJvamVjdGlvbiwgdGhpcy5nbEZyYW1lYnVmZmVyKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmVuZGVyR3JvdXAucmVuZGVyU3BlY2lmaWMoZGlzcGxheU9iamVjdCwgdGhpcy5wcm9qZWN0aW9uLCB0aGlzLmdsRnJhbWVidWZmZXIpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBpZiAoIXRoaXMucmVuZGVyR3JvdXApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnJlbmRlckdyb3VwID0gbmV3IFBJWEkuV2ViR0xSZW5kZXJHcm91cChnbCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnJlbmRlckdyb3VwLnNldFJlbmRlcmFibGUoZGlzcGxheU9iamVjdCk7CiAgICAgICAgdGhpcy5yZW5kZXJHcm91cC5yZW5kZXIodGhpcy5wcm9qZWN0aW9uLCB0aGlzLmdsRnJhbWVidWZmZXIpOwogICAgfQogICAgCiAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtID0gb3JpZ2luYWxXb3JsZFRyYW5zZm9ybTsKfQoKLyoqCiAqIFRoaXMgZnVuY3Rpb24gd2lsbCBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdCB0byB0aGUgdGV4dHVyZS4KICoKKiBAbWV0aG9kIFBoYXNlci5SZW5kZXJUZXh0dXJlI3JlbmRlckNhbnZhcwoqIEBtZW1iZXJvZiBQaGFzZXIuUmVuZGVyVGV4dHVyZQoqIEBwcml2YXRlCiogQHBhcmFtIHtEaXNwbGF5T2JqZWN0fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIHJlbmRlciB0aGlzIHRleHR1cmUgb24uCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtwb3NpdGlvbl0gLSBXaGVyZSB0byBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdC4KKiBAcGFyYW0ge2Jvb2xlYW59IFtjbGVhcj1mYWxzZV0gLSBJZiB0cnVlIHRoZSB0ZXh0dXJlIHdpbGwgYmUgY2xlYXJlZCBiZWZvcmUgdGhlIGRpc3BsYXlPYmplY3QgaXMgZHJhd24uCiogQHBhcmFtIHtib29sZWFufSBbcmVuZGVySGlkZGVuPWZhbHNlXSAtIElmIHRydWUgZGlzcGxheU9iamVjdHMgdGhhdCBoYXZlIHRoZWlyIHZpc2libGUgcHJvcGVydHkgc2V0IHRvIGZhbHNlIHdpbGwgc3RpbGwgYmUgcmVuZGVyZWQuCiovClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5yZW5kZXJDYW52YXMgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0LCBwb3NpdGlvbiwgY2xlYXIsIHJlbmRlckhpZGRlbikKewogICAgdmFyIGNoaWxkcmVuID0gZGlzcGxheU9iamVjdC5jaGlsZHJlbjsKCiAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtID0gUElYSS5tYXQzLmNyZWF0ZSgpOwogICAgCiAgICBpZiAocG9zaXRpb24pCiAgICB7CiAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsyXSA9IHBvc2l0aW9uLng7CiAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSA9IHBvc2l0aW9uLnk7CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDAsIGogPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBqOyBpKyspCiAgICB7CiAgICAgICAgY2hpbGRyZW5baV0udXBkYXRlVHJhbnNmb3JtKCk7CiAgICB9CgogICAgaWYgKGNsZWFyKQogICAgewogICAgICAgIHRoaXMucmVuZGVyZXIuY29udGV4dC5jbGVhclJlY3QoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwogICAgfQoKICAgIHRoaXMucmVuZGVyZXIucmVuZGVyRGlzcGxheU9iamVjdChkaXNwbGF5T2JqZWN0LCByZW5kZXJIaWRkZW4pOwogICAgCiAgICB0aGlzLnJlbmRlcmVyLmNvbnRleHQuc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIDAsIDApOwoKfQoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIENhbnZhcyBjbGFzcyBoYW5kbGVzIGV2ZXJ5dGhpbmcgcmVsYXRlZCB0byBjcmVhdGluZyB0aGUgYGNhbnZhc2AgRE9NIHRhZyB0aGF0IFBoYXNlciB3aWxsIHVzZSwgaW5jbHVkaW5nIHN0eWxlcywgb2Zmc2V0IGFuZCBhc3BlY3QgcmF0aW8uCioKKiBAY2xhc3MgUGhhc2VyLkNhbnZhcwoqIEBzdGF0aWMKKi8KUGhhc2VyLkNhbnZhcyA9IHsKCiAgICAvKioKICAgICogQ3JlYXRlcyBhIGBjYW52YXNgIERPTSBlbGVtZW50LiBUaGUgZWxlbWVudCBpcyBub3QgYXV0b21hdGljYWxseSBhZGRlZCB0byB0aGUgZG9jdW1lbnQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5jcmVhdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aD0yNTZdIC0gVGhlIHdpZHRoIG9mIHRoZSBjYW52YXMgZWxlbWVudC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHQ9MjU2XSAtIFRoZSBoZWlnaHQgb2YgdGhlIGNhbnZhcyBlbGVtZW50Li4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtpZD0nJ10gLSBJZiBnaXZlbiB0aGlzIHdpbGwgYmUgc2V0IGFzIHRoZSBJRCBvZiB0aGUgY2FudmFzIGVsZW1lbnQsIG90aGVyd2lzZSBubyBJRCB3aWxsIGJlIHNldC4KICAgICogQHJldHVybiB7SFRNTENhbnZhc0VsZW1lbnR9IFRoZSBuZXdseSBjcmVhdGVkIGNhbnZhcyBlbGVtZW50LgogICAgKi8KICAgIGNyZWF0ZTogZnVuY3Rpb24gKHdpZHRoLCBoZWlnaHQsIGlkKSB7CgogICAgICAgIHdpZHRoID0gd2lkdGggfHwgMjU2OwogICAgICAgIGhlaWdodCA9IGhlaWdodCB8fCAyNTY7CgogICAgICAgIHZhciBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKCiAgICAgICAgaWYgKHR5cGVvZiBpZCA9PT0gJ3N0cmluZycpCiAgICAgICAgewogICAgICAgICAgICBjYW52YXMuaWQgPSBpZDsKICAgICAgICB9CgogICAgICAgIGNhbnZhcy53aWR0aCA9IHdpZHRoOwogICAgICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgICAgIGNhbnZhcy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKCiAgICAgICAgcmV0dXJuIGNhbnZhczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgdGhlIERPTSBvZmZzZXQgdmFsdWVzIG9mIGFueSBnaXZlbiBlbGVtZW50CiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5nZXRPZmZzZXQKICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gZWxlbWVudCAtIFRoZSB0YXJnZXRlZCBlbGVtZW50IHRoYXQgd2Ugd2FudCB0byByZXRyaWV2ZSB0aGUgb2Zmc2V0LgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW3BvaW50XSAtIFRoZSBwb2ludCB3ZSB3YW50IHRvIHRha2UgdGhlIHgveSB2YWx1ZXMgb2YgdGhlIG9mZnNldC4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSAtIEEgcG9pbnQgb2JqZXQgd2l0aCB0aGUgb2Zmc2V0WCBhbmQgWSBhcyBpdHMgcHJvcGVydGllcy4KICAgICovCiAgICBnZXRPZmZzZXQ6IGZ1bmN0aW9uIChlbGVtZW50LCBwb2ludCkgewoKICAgICAgICBwb2ludCA9IHBvaW50IHx8IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAgICAgdmFyIGJveCA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgdmFyIGNsaWVudFRvcCA9IGVsZW1lbnQuY2xpZW50VG9wIHx8IGRvY3VtZW50LmJvZHkuY2xpZW50VG9wIHx8IDA7CiAgICAgICAgdmFyIGNsaWVudExlZnQgPSBlbGVtZW50LmNsaWVudExlZnQgfHwgZG9jdW1lbnQuYm9keS5jbGllbnRMZWZ0IHx8IDA7CgogICAgICAgIC8vICBXaXRob3V0IHRoaXMgY2hlY2sgQ2hyb21lIGlzIG5vdyB0aHJvd2luZyBjb25zb2xlIHdhcm5pbmdzIGFib3V0IHN0cmljdCB2cy4gcXVpcmtzIDooCgogICAgICAgIHZhciBzY3JvbGxUb3AgPSAwOwogICAgICAgIHZhciBzY3JvbGxMZWZ0ID0gMDsKCiAgICAgICAgaWYgKGRvY3VtZW50LmNvbXBhdE1vZGUgPT09ICdDU1MxQ29tcGF0JykKICAgICAgICB7CiAgICAgICAgICAgIHNjcm9sbFRvcCA9IHdpbmRvdy5wYWdlWU9mZnNldCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wIHx8IGVsZW1lbnQuc2Nyb2xsVG9wIHx8IDA7CiAgICAgICAgICAgIHNjcm9sbExlZnQgPSB3aW5kb3cucGFnZVhPZmZzZXQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQgfHwgZWxlbWVudC5zY3JvbGxMZWZ0IHx8IDA7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHNjcm9sbFRvcCA9IHdpbmRvdy5wYWdlWU9mZnNldCB8fCBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCB8fCBlbGVtZW50LnNjcm9sbFRvcCB8fCAwOwogICAgICAgICAgICBzY3JvbGxMZWZ0ID0gd2luZG93LnBhZ2VYT2Zmc2V0IHx8IGRvY3VtZW50LmJvZHkuc2Nyb2xsTGVmdCB8fCBlbGVtZW50LnNjcm9sbExlZnQgfHwgMDsKICAgICAgICB9CgogICAgICAgIHBvaW50LnggPSBib3gubGVmdCArIHNjcm9sbExlZnQgLSBjbGllbnRMZWZ0OwogICAgICAgIHBvaW50LnkgPSBib3gudG9wICsgc2Nyb2xsVG9wIC0gY2xpZW50VG9wOwoKICAgICAgICByZXR1cm4gcG9pbnQ7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgYXNwZWN0IHJhdGlvIG9mIHRoZSBnaXZlbiBjYW52YXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5nZXRBc3BlY3RSYXRpbwogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgY2FudmFzIHRvIGdldCB0aGUgYXNwZWN0IHJhdGlvIGZyb20uCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHJhdGlvIGJldHdlZW4gY2FudmFzJyB3aWR0aCBhbmQgaGVpZ2h0LgogICAgKi8KICAgIGdldEFzcGVjdFJhdGlvOiBmdW5jdGlvbiAoY2FudmFzKSB7CiAgICAgICAgcmV0dXJuIGNhbnZhcy53aWR0aCAvIGNhbnZhcy5oZWlnaHQ7CiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBiYWNrZ3JvdW5kIGNvbG9yIGJlaGluZCB0aGUgY2FudmFzLiBUaGlzIGNoYW5nZXMgdGhlIGNhbnZhcyBzdHlsZSBwcm9wZXJ0eS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLnNldEJhY2tncm91bmRDb2xvcgogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgY2FudmFzIHRvIHNldCB0aGUgYmFja2dyb3VuZCBjb2xvciBvbi4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBUaGUgY29sb3IgdG8gc2V0LiBDYW4gYmUgaW4gdGhlIGZvcm1hdCAncmdiKHIsZyxiKScsIG9yICcjUlJHR0JCJyBvciBhbnkgdmFsaWQgQ1NTIGNvbG9yLgogICAgKiBAcmV0dXJuIHtIVE1MQ2FudmFzRWxlbWVudH0gUmV0dXJucyB0aGUgc291cmNlIGNhbnZhcy4KICAgICovCiAgICBzZXRCYWNrZ3JvdW5kQ29sb3I6IGZ1bmN0aW9uIChjYW52YXMsIGNvbG9yKSB7CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigwLDAsMCknOwoKICAgICAgICBjYW52YXMuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sb3I7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIGNhbnZhczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSB0b3VjaC1hY3Rpb24gcHJvcGVydHkgb24gdGhlIGNhbnZhcyBzdHlsZS4gQ2FuIGJlIHVzZWQgdG8gZGlzYWJsZSBkZWZhdWx0IGJyb3dzZXIgdG91Y2ggYWN0aW9ucy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLnNldFRvdWNoQWN0aW9uCiAgICAqIEBwYXJhbSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIFRoZSBjYW52YXMgdG8gc2V0IHRoZSB0b3VjaCBhY3Rpb24gb24uCiAgICAqIEBwYXJhbSB7U3RyaW5nfSBbdmFsdWVdIC0gVGhlIHRvdWNoIGFjdGlvbiB0byBzZXQuIERlZmF1bHRzIHRvICdub25lJy4KICAgICogQHJldHVybiB7SFRNTENhbnZhc0VsZW1lbnR9IFRoZSBzb3VyY2UgY2FudmFzLgogICAgKi8KICAgIHNldFRvdWNoQWN0aW9uOiBmdW5jdGlvbiAoY2FudmFzLCB2YWx1ZSkgewoKICAgICAgICB2YWx1ZSA9IHZhbHVlIHx8ICdub25lJzsKCiAgICAgICAgY2FudmFzLnN0eWxlLm1zVG91Y2hBY3Rpb24gPSB2YWx1ZTsKICAgICAgICBjYW52YXMuc3R5bGVbJ21zLXRvdWNoLWFjdGlvbiddID0gdmFsdWU7CiAgICAgICAgY2FudmFzLnN0eWxlWyd0b3VjaC1hY3Rpb24nXSA9IHZhbHVlOwoKICAgICAgICByZXR1cm4gY2FudmFzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIHVzZXItc2VsZWN0IHByb3BlcnR5IG9uIHRoZSBjYW52YXMgc3R5bGUuIENhbiBiZSB1c2VkIHRvIGRpc2FibGUgZGVmYXVsdCBicm93c2VyIHNlbGVjdGlvbiBhY3Rpb25zLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW52YXMuc2V0VXNlclNlbGVjdAogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgY2FudmFzIHRvIHNldCB0aGUgdG91Y2ggYWN0aW9uIG9uLgogICAgKiBAcGFyYW0ge1N0cmluZ30gW3ZhbHVlXSAtIFRoZSB0b3VjaCBhY3Rpb24gdG8gc2V0LiBEZWZhdWx0cyB0byAnbm9uZScuCiAgICAqIEByZXR1cm4ge0hUTUxDYW52YXNFbGVtZW50fSBUaGUgc291cmNlIGNhbnZhcy4KICAgICovCiAgICBzZXRVc2VyU2VsZWN0OiBmdW5jdGlvbiAoY2FudmFzLCB2YWx1ZSkgewoKICAgICAgICB2YWx1ZSA9IHZhbHVlIHx8ICdub25lJzsKCiAgICAgICAgY2FudmFzLnN0eWxlWyctd2Via2l0LXRvdWNoLWNhbGxvdXQnXSA9IHZhbHVlOwogICAgICAgIGNhbnZhcy5zdHlsZVsnLXdlYmtpdC11c2VyLXNlbGVjdCddID0gdmFsdWU7CiAgICAgICAgY2FudmFzLnN0eWxlWycta2h0bWwtdXNlci1zZWxlY3QnXSA9IHZhbHVlOwogICAgICAgIGNhbnZhcy5zdHlsZVsnLW1vei11c2VyLXNlbGVjdCddID0gdmFsdWU7CiAgICAgICAgY2FudmFzLnN0eWxlWyctbXMtdXNlci1zZWxlY3QnXSA9IHZhbHVlOwogICAgICAgIGNhbnZhcy5zdHlsZVsndXNlci1zZWxlY3QnXSA9IHZhbHVlOwogICAgICAgIGNhbnZhcy5zdHlsZVsnLXdlYmtpdC10YXAtaGlnaGxpZ2h0LWNvbG9yJ10gPSAncmdiYSgwLCAwLCAwLCAwKSc7CgogICAgICAgIHJldHVybiBjYW52YXM7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyB0aGUgZ2l2ZW4gY2FudmFzIGVsZW1lbnQgdG8gdGhlIERPTS4gVGhlIGNhbnZhcyB3aWxsIGJlIGFkZGVkIGFzIGEgY2hpbGQgb2YgdGhlIGdpdmVuIHBhcmVudC4KICAgICogSWYgbm8gcGFyZW50IGlzIGdpdmVuIGl0IHdpbGwgYmUgYWRkZWQgYXMgYSBjaGlsZCBvZiB0aGUgZG9jdW1lbnQuYm9keS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLmFkZFRvRE9NCiAgICAqIEBwYXJhbSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIFRoZSBjYW52YXMgdG8gc2V0IHRoZSB0b3VjaCBhY3Rpb24gb24uCiAgICAqIEBwYXJhbSB7c3RyaW5nfEhUTUxFbGVtZW50fSBwYXJlbnQgLSBUaGUgRE9NIGVsZW1lbnQgdG8gYWRkIHRoZSBjYW52YXMgdG8uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW292ZXJmbG93SGlkZGVuPXRydWVdIC0gSWYgc2V0IHRvIHRydWUgaXQgd2lsbCBhZGQgdGhlIG92ZXJmbG93PSdoaWRkZW4nIHN0eWxlIHRvIHRoZSBwYXJlbnQgRE9NIGVsZW1lbnQuCiAgICAqIEByZXR1cm4ge0hUTUxDYW52YXNFbGVtZW50fSBSZXR1cm5zIHRoZSBzb3VyY2UgY2FudmFzLgogICAgKi8KICAgIGFkZFRvRE9NOiBmdW5jdGlvbiAoY2FudmFzLCBwYXJlbnQsIG92ZXJmbG93SGlkZGVuKSB7CgogICAgICAgIHZhciB0YXJnZXQ7CgogICAgICAgIGlmICh0eXBlb2Ygb3ZlcmZsb3dIaWRkZW4gPT09ICd1bmRlZmluZWQnKSB7IG92ZXJmbG93SGlkZGVuID0gdHJ1ZTsgfQoKICAgICAgICBpZiAocGFyZW50KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJlbnQgPT09ICdzdHJpbmcnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBob3BlZnVsbHkgYW4gZWxlbWVudCBJRAogICAgICAgICAgICAgICAgdGFyZ2V0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocGFyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgcGFyZW50ID09PSAnb2JqZWN0JyAmJiBwYXJlbnQubm9kZVR5cGUgPT09IDEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIHF1aWNrIHRlc3QgZm9yIGEgSFRNTGVsZW1lbnQKICAgICAgICAgICAgICAgIHRhcmdldCA9IHBhcmVudDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRmFsbGJhY2ssIGNvdmVycyBhbiBpbnZhbGlkIElEIGFuZCBhIG5vbiBIVE1MZWxlbWVudCBvYmplY3QKICAgICAgICBpZiAoIXRhcmdldCkKICAgICAgICB7CiAgICAgICAgICAgIHRhcmdldCA9IGRvY3VtZW50LmJvZHk7CiAgICAgICAgfQoKICAgICAgICBpZiAob3ZlcmZsb3dIaWRkZW4gJiYgdGFyZ2V0LnN0eWxlKQogICAgICAgIHsKICAgICAgICAgICAgdGFyZ2V0LnN0eWxlLm92ZXJmbG93ID0gJ2hpZGRlbic7CiAgICAgICAgfQoKICAgICAgICB0YXJnZXQuYXBwZW5kQ2hpbGQoY2FudmFzKTsKCiAgICAgICAgcmV0dXJuIGNhbnZhczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSB0cmFuc2Zvcm0gb2YgdGhlIGdpdmVuIGNhbnZhcyB0byB0aGUgbWF0cml4IHZhbHVlcyBwcm92aWRlZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLnNldFRyYW5zZm9ybQogICAgKiBAcGFyYW0ge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gY29udGV4dCAtIFRoZSBjb250ZXh0IHRvIHNldCB0aGUgdHJhbnNmb3JtIG9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gdHJhbnNsYXRlWCAtIFRoZSB2YWx1ZSB0byB0cmFuc2xhdGUgaG9yaXpvbnRhbGx5IGJ5LgogICAgKiBAcGFyYW0ge251bWJlcn0gdHJhbnNsYXRlWSAtIFRoZSB2YWx1ZSB0byB0cmFuc2xhdGUgdmVydGljYWxseSBieS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHNjYWxlWCAtIFRoZSB2YWx1ZSB0byBzY2FsZSBob3Jpem9udGFsbHkgYnkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzY2FsZVkgLSBUaGUgdmFsdWUgdG8gc2NhbGUgdmVydGljYWxseSBieS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHNrZXdYIC0gVGhlIHZhbHVlIHRvIHNrZXcgaG9yaXpvbnRhbHkgYnkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBza2V3WSAtIFRoZSB2YWx1ZSB0byBza2V3IHZlcnRpY2FsbHkgYnkuCiAgICAqIEByZXR1cm4ge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gUmV0dXJucyB0aGUgc291cmNlIGNvbnRleHQuCiAgICAqLwogICAgc2V0VHJhbnNmb3JtOiBmdW5jdGlvbiAoY29udGV4dCwgdHJhbnNsYXRlWCwgdHJhbnNsYXRlWSwgc2NhbGVYLCBzY2FsZVksIHNrZXdYLCBza2V3WSkgewoKICAgICAgICBjb250ZXh0LnNldFRyYW5zZm9ybShzY2FsZVgsIHNrZXdYLCBza2V3WSwgc2NhbGVZLCB0cmFuc2xhdGVYLCB0cmFuc2xhdGVZKTsKCiAgICAgICAgcmV0dXJuIGNvbnRleHQ7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgSW1hZ2UgU21vb3RoaW5nIHByb3BlcnR5IG9uIHRoZSBnaXZlbiBjb250ZXh0LiBTZXQgdG8gZmFsc2UgdG8gZGlzYWJsZSBpbWFnZSBzbW9vdGhpbmcuCiAgICAqIEJ5IGRlZmF1bHQgYnJvd3NlcnMgaGF2ZSBpbWFnZSBzbW9vdGhpbmcgZW5hYmxlZCwgd2hpY2ggaXNuJ3QgYWx3YXlzIHdoYXQgeW91IHZpc3VhbGx5IHdhbnQsIGVzcGVjaWFsbHkKICAgICogd2hlbiB1c2luZyBwaXhlbCBhcnQgaW4gYSBnYW1lLiBOb3RlIHRoYXQgdGhpcyBzZXRzIHRoZSBwcm9wZXJ0eSBvbiB0aGUgY29udGV4dCBpdHNlbGYsIHNvIHRoYXQgYW55IGltYWdlCiAgICAqIGRyYXduIHRvIHRoZSBjb250ZXh0IHdpbGwgYmUgYWZmZWN0ZWQuIFRoaXMgc2V0cyB0aGUgcHJvcGVydHkgYWNyb3NzIGFsbCBjdXJyZW50IGJyb3dzZXJzIGJ1dCBzdXBwb3J0IGlzCiAgICAqIHBhdGNoeSBvbiBlYXJsaWVyIGJyb3dzZXJzLCBlc3BlY2lhbGx5IG9uIG1vYmlsZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLnNldFNtb290aGluZ0VuYWJsZWQKICAgICogQHBhcmFtIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHQgLSBUaGUgY29udGV4dCB0byBlbmFibGUgb3IgZGlzYWJsZSB0aGUgaW1hZ2Ugc21vb3RoaW5nIG9uLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlIC0gSWYgc2V0IHRvIHRydWUgaXQgd2lsbCBlbmFibGUgaW1hZ2Ugc21vb3RoaW5nLCBmYWxzZSB3aWxsIGRpc2FibGUgaXQuCiAgICAqIEByZXR1cm4ge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gUmV0dXJucyB0aGUgc291cmNlIGNvbnRleHQuCiAgICAqLwogICAgc2V0U21vb3RoaW5nRW5hYmxlZDogZnVuY3Rpb24gKGNvbnRleHQsIHZhbHVlKSB7CgogICAgICAgIGNvbnRleHRbJ2ltYWdlU21vb3RoaW5nRW5hYmxlZCddID0gdmFsdWU7CiAgICAgICAgY29udGV4dFsnbW96SW1hZ2VTbW9vdGhpbmdFbmFibGVkJ10gPSB2YWx1ZTsKICAgICAgICBjb250ZXh0WydvSW1hZ2VTbW9vdGhpbmdFbmFibGVkJ10gPSB2YWx1ZTsKICAgICAgICBjb250ZXh0Wyd3ZWJraXRJbWFnZVNtb290aGluZ0VuYWJsZWQnXSA9IHZhbHVlOwogICAgICAgIGNvbnRleHRbJ21zSW1hZ2VTbW9vdGhpbmdFbmFibGVkJ10gPSB2YWx1ZTsKCiAgICAgICAgcmV0dXJuIGNvbnRleHQ7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgQ1NTIGltYWdlLXJlbmRlcmluZyBwcm9wZXJ0eSBvbiB0aGUgZ2l2ZW4gY2FudmFzIHRvIGJlICdjcmlzcCcgKGFrYSAnb3B0aW1pemUgY29udHJhc3Qgb24gd2Via2l0JykuCiAgICAqIE5vdGUgdGhhdCBpZiB0aGlzIGRvZXNuJ3QgZ2l2ZW4gdGhlIGRlc2lyZWQgcmVzdWx0IHRoZW4gc2VlIHRoZSBzZXRTbW9vdGhpbmdFbmFibGVkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW52YXMuc2V0SW1hZ2VSZW5kZXJpbmdDcmlzcAogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgY2FudmFzIHRvIHNldCBpbWFnZS1yZW5kZXJpbmcgY3Jpc3Agb24uCiAgICAqIEByZXR1cm4ge0hUTUxDYW52YXNFbGVtZW50fSBSZXR1cm5zIHRoZSBzb3VyY2UgY2FudmFzLgogICAgKi8KICAgIHNldEltYWdlUmVuZGVyaW5nQ3Jpc3A6IGZ1bmN0aW9uIChjYW52YXMpIHsKCiAgICAgICAgY2FudmFzLnN0eWxlWydpbWFnZS1yZW5kZXJpbmcnXSA9ICdvcHRpbWl6ZVNwZWVkJzsKICAgICAgICBjYW52YXMuc3R5bGVbJ2ltYWdlLXJlbmRlcmluZyddID0gJ2NyaXNwLWVkZ2VzJzsKICAgICAgICBjYW52YXMuc3R5bGVbJ2ltYWdlLXJlbmRlcmluZyddID0gJy1tb3otY3Jpc3AtZWRnZXMnOwogICAgICAgIGNhbnZhcy5zdHlsZVsnaW1hZ2UtcmVuZGVyaW5nJ10gPSAnLXdlYmtpdC1vcHRpbWl6ZS1jb250cmFzdCc7CiAgICAgICAgY2FudmFzLnN0eWxlWydpbWFnZS1yZW5kZXJpbmcnXSA9ICdvcHRpbWl6ZS1jb250cmFzdCc7CiAgICAgICAgY2FudmFzLnN0eWxlLm1zSW50ZXJwb2xhdGlvbk1vZGUgPSAnbmVhcmVzdC1uZWlnaGJvcic7CgogICAgICAgIHJldHVybiBjYW52YXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgQ1NTIGltYWdlLXJlbmRlcmluZyBwcm9wZXJ0eSBvbiB0aGUgZ2l2ZW4gY2FudmFzIHRvIGJlICdiaWN1YmljJyAoYWthICdhdXRvJykuCiAgICAqIE5vdGUgdGhhdCBpZiB0aGlzIGRvZXNuJ3QgZ2l2ZW4gdGhlIGRlc2lyZWQgcmVzdWx0IHRoZW4gc2VlIHRoZSBDYW52YXNVdGlscy5zZXRTbW9vdGhpbmdFbmFibGVkIG1ldGhvZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLnNldEltYWdlUmVuZGVyaW5nQmljdWJpYwogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgVGhlIGNhbnZhcyB0byBzZXQgaW1hZ2UtcmVuZGVyaW5nIGJpY3ViaWMgb24uCiAgICAqIEByZXR1cm4ge0hUTUxDYW52YXNFbGVtZW50fSBSZXR1cm5zIHRoZSBzb3VyY2UgY2FudmFzLgogICAgKi8KICAgIHNldEltYWdlUmVuZGVyaW5nQmljdWJpYzogZnVuY3Rpb24gKGNhbnZhcykgewoKICAgICAgICBjYW52YXMuc3R5bGVbJ2ltYWdlLXJlbmRlcmluZyddID0gJ2F1dG8nOwogICAgICAgIGNhbnZhcy5zdHlsZS5tc0ludGVycG9sYXRpb25Nb2RlID0gJ2JpY3ViaWMnOwoKICAgICAgICByZXR1cm4gY2FudmFzOwoKICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBUaGUgU3RhZ2VTY2FsZU1vZGUgb2JqZWN0IGlzIHJlc3BvbnNpYmxlIGZvciBoZWxwaW5nIHlvdSBtYW5hZ2UgdGhlIHNjYWxpbmcsIHJlc2l6aW5nIGFuZCBhbGlnbm1lbnQgb2YgeW91ciBnYW1lIHdpdGhpbiB0aGUgYnJvd3Nlci4KKgoqIEBjbGFzcyBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUgCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSBuYXRpdmUgd2lkdGggb2YgdGhlIGdhbWUuCiogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBuYXRpdmUgaGVpZ2h0IG9mIHRoZSBnYW1lLgoqLwpQaGFzZXIuU3RhZ2VTY2FsZU1vZGUgPSBmdW5jdGlvbiAoZ2FtZSwgd2lkdGgsIGhlaWdodCkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gV2lkdGggb2YgdGhlIHN0YWdlIGFmdGVyIGNhbGN1bGF0aW9uLgogICAgKi8KICAgIHRoaXMud2lkdGggPSB3aWR0aDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIEhlaWdodCBvZiB0aGUgc3RhZ2UgYWZ0ZXIgY2FsY3VsYXRpb24uCiAgICAqLwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtaW5XaWR0aCAtIE1pbmltdW0gd2lkdGggdGhlIGNhbnZhcyBzaG91bGQgYmUgc2NhbGVkIHRvIChpbiBwaXhlbHMpLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWluV2lkdGggPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4V2lkdGggLSBNYXhpbXVtIHdpZHRoIHRoZSBjYW52YXMgc2hvdWxkIGJlIHNjYWxlZCB0byAoaW4gcGl4ZWxzKS4KICAgICogSWYgbnVsbCBpdCB3aWxsIHNjYWxlIHRvIHdoYXRldmVyIHdpZHRoIHRoZSBicm93c2VyIGNhbiBoYW5kbGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXhXaWR0aCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtaW5IZWlnaHQgLSBNaW5pbXVtIGhlaWdodCB0aGUgY2FudmFzIHNob3VsZCBiZSBzY2FsZWQgdG8gKGluIHBpeGVscykuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5taW5IZWlnaHQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4SGVpZ2h0IC0gTWF4aW11bSBoZWlnaHQgdGhlIGNhbnZhcyBzaG91bGQgYmUgc2NhbGVkIHRvIChpbiBwaXhlbHMpLgogICAgKiBJZiBudWxsIGl0IHdpbGwgc2NhbGUgdG8gd2hhdGV2ZXIgaGVpZ2h0IHRoZSBicm93c2VyIGNhbiBoYW5kbGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXhIZWlnaHQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3N0YXJ0SGVpZ2h0IC0gU3RhZ2UgaGVpZ2h0IHdoZW4gc3RhcnRpbmcgdGhlIGdhbWUuCiAgICAqIEBkZWZhdWx0CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fc3RhcnRIZWlnaHQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZvcmNlTGFuZHNjYXBlIC0gSWYgdGhlIGdhbWUgc2hvdWxkIGJlIGZvcmNlZCB0byB1c2UgTGFuZHNjYXBlIG1vZGUsIHRoaXMgaXMgc2V0IHRvIHRydWUgYnkgR2FtZS5TdGFnZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZm9yY2VMYW5kc2NhcGUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBmb3JjZVBvcnRyYWl0IC0gSWYgdGhlIGdhbWUgc2hvdWxkIGJlIGZvcmNlZCB0byB1c2UgUG9ydHJhaXQgbW9kZSwgdGhpcyBpcyBzZXQgdG8gdHJ1ZSBieSBHYW1lLlN0YWdlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5mb3JjZVBvcnRyYWl0ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaW5jb3JyZWN0T3JpZW50YXRpb24gLSBJZiB0aGUgZ2FtZSBzaG91bGQgYmUgZm9yY2VkIHRvIHVzZSBhIHNwZWNpZmljIG9yaWVudGF0aW9uIGFuZCB0aGUgZGV2aWNlIGN1cnJlbnRseSBpc24ndCBpbiB0aGF0IG9yaWVudGF0aW9uIHRoaXMgaXMgc2V0IHRvIHRydWUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pbmNvcnJlY3RPcmllbnRhdGlvbiA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHBhZ2VBbGlnbkhvcml6b250YWxseSAtIElmIHlvdSB3aXNoIHRvIGFsaWduIHlvdXIgZ2FtZSBpbiB0aGUgbWlkZGxlIG9mIHRoZSBwYWdlIHRoZW4geW91IGNhbiBzZXQgdGhpcyB2YWx1ZSB0byB0cnVlLgogICAgKiBJdCB3aWxsIHBsYWNlIGEgcmUtY2FsY3VsYXRlZCBtYXJnaW4tbGVmdCBwaXhlbCB2YWx1ZSBvbnRvIHRoZSBjYW52YXMgZWxlbWVudCB3aGljaCBpcyB1cGRhdGVkIG9uIG9yaWVudGF0aW9uL3Jlc2l6aW5nLgogICAgKiBJdCBkb2Vzbid0IGNhcmUgYWJvdXQgYW55IG90aGVyIERPTSBlbGVtZW50IHRoYXQgbWF5IGJlIG9uIHRoZSBwYWdlLCBpdCBsaXRlcmFsbHkganVzdCBzZXRzIHRoZSBtYXJnaW4uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYWdlQWxpZ25Ib3Jpem9udGFsbHkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBwYWdlQWxpZ25WZXJ0aWNhbGx5IC0gSWYgeW91IHdpc2ggdG8gYWxpZ24geW91ciBnYW1lIGluIHRoZSBtaWRkbGUgb2YgdGhlIHBhZ2UgdGhlbiB5b3UgY2FuIHNldCB0aGlzIHZhbHVlIHRvIHRydWUuCiAgICAqIEl0IHdpbGwgcGxhY2UgYSByZS1jYWxjdWxhdGVkIG1hcmdpbi1sZWZ0IHBpeGVsIHZhbHVlIG9udG8gdGhlIGNhbnZhcyBlbGVtZW50IHdoaWNoIGlzIHVwZGF0ZWQgb24gb3JpZW50YXRpb24vcmVzaXppbmcuCiAgICAqIEl0IGRvZXNuJ3QgY2FyZSBhYm91dCBhbnkgb3RoZXIgRE9NIGVsZW1lbnQgdGhhdCBtYXkgYmUgb24gdGhlIHBhZ2UsIGl0IGxpdGVyYWxseSBqdXN0IHNldHMgdGhlIG1hcmdpbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhZ2VBbGlnblZlcnRpY2FsbHkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF93aWR0aCAtIENhY2hlZCBzdGFnZSB3aWR0aCBmb3IgZnVsbCBzY3JlZW4gbW9kZS4KICAgICogQGRlZmF1bHQKICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl93aWR0aCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfaGVpZ2h0IC0gQ2FjaGVkIHN0YWdlIGhlaWdodCBmb3IgZnVsbCBzY3JlZW4gbW9kZS4KICAgICogQGRlZmF1bHQKICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9oZWlnaHQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4SXRlcmF0aW9ucyAtIFRoZSBtYXhpbXVtIG51bWJlciBvZiB0aW1lcyBpdCB3aWxsIHRyeSB0byByZXNpemUgdGhlIGNhbnZhcyB0byBmaWxsIHRoZSBicm93c2VyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWF4SXRlcmF0aW9ucyA9IDU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UElYSS5TcHJpdGV9IG9yaWVudGF0aW9uU3ByaXRlIC0gVGhlIFNwcml0ZSB0aGF0IGlzIG9wdGlvbmFsbHkgZGlzcGxheWVkIGlmIHRoZSBicm93c2VyIGVudGVycyBhbiB1bnN1cHBvcnRlZCBvcmllbnRhdGlvbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBlbnRlckxhbmRzY2FwZSAtIFRoZSBldmVudCB0aGF0IGlzIGRpc3BhdGNoZWQgd2hlbiB0aGUgYnJvd3NlciBlbnRlcnMgbGFuZHNjYXBlIG9yaWVudGF0aW9uLgogICAgKi8KICAgIHRoaXMuZW50ZXJMYW5kc2NhcGUgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IGVudGVyUG9ydHJhaXQgLSBUaGUgZXZlbnQgdGhhdCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhlIGJyb3dzZXIgZW50ZXJzIGhvcml6b250YWwgb3JpZW50YXRpb24uCiAgICAqLwogICAgdGhpcy5lbnRlclBvcnRyYWl0ID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBlbnRlckluY29ycmVjdE9yaWVudGF0aW9uIC0gVGhlIGV2ZW50IHRoYXQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoZSBicm93c2VyIGVudGVycyBhbiBpbmNvcnJlY3Qgb3JpZW50YXRpb24sIGFzIGRlZmluZWQgYnkgZm9yY2VPcmllbnRhdGlvbi4KICAgICovCiAgICB0aGlzLmVudGVySW5jb3JyZWN0T3JpZW50YXRpb24gPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IGxlYXZlSW5jb3JyZWN0T3JpZW50YXRpb24gLSBUaGUgZXZlbnQgdGhhdCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhlIGJyb3dzZXIgbGVhdmVzIGFuIGluY29ycmVjdCBvcmllbnRhdGlvbiwgYXMgZGVmaW5lZCBieSBmb3JjZU9yaWVudGF0aW9uLgogICAgKi8KICAgIHRoaXMubGVhdmVJbmNvcnJlY3RPcmllbnRhdGlvbiA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gaGFzUmVzaXplZCAtIFRoZSBldmVudCB0aGF0IGlzIGRpc3BhdGNoZWQgd2hlbiB0aGUgZ2FtZSBzY2FsZSBjaGFuZ2VzLgogICAgKi8KICAgIHRoaXMuaGFzUmVzaXplZCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgaWYgKHdpbmRvd1snb3JpZW50YXRpb24nXSkKICAgIHsKICAgICAgICB0aGlzLm9yaWVudGF0aW9uID0gd2luZG93WydvcmllbnRhdGlvbiddOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGlmICh3aW5kb3cub3V0ZXJXaWR0aCA+IHdpbmRvdy5vdXRlckhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb24gPSA5MDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvbiA9IDA7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc2NhbGVGYWN0b3IgLSBUaGUgc2NhbGUgZmFjdG9yIGJhc2VkIG9uIHRoZSBnYW1lIGRpbWVuc2lvbnMgdnMuIHRoZSBzY2FsZWQgZGltZW5zaW9ucy4KICAgICogQHJlYWRvbmx5CiAgICAqLwogICAgdGhpcy5zY2FsZUZhY3RvciA9IG5ldyBQaGFzZXIuUG9pbnQoMSwgMSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBzY2FsZUZhY3RvckludmVyc2VkIC0gVGhlIGludmVyc2VkIHNjYWxlIGZhY3Rvci4gVGhlIGRpc3BsYXllZCBkaW1lbnNpb25zIGRpdmlkZWQgYnkgdGhlIGdhbWUgZGltZW5zaW9ucy4KICAgICogQHJlYWRvbmx5CiAgICAqLwogICAgdGhpcy5zY2FsZUZhY3RvckludmVyc2VkID0gbmV3IFBoYXNlci5Qb2ludCgxLCAxKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IG1hcmdpbiAtIElmIHRoZSBnYW1lIGNhbnZhcyBpcyBzZXRvIHRvIGFsaWduIGJ5IGFkanVzdGluZyB0aGUgbWFyZ2luLCB0aGUgbWFyZ2luIGNhbGN1bGF0aW9uIHZhbHVlcyBhcmUgc3RvcmVkIGluIHRoaXMgUG9pbnQuCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMubWFyZ2luID0gbmV3IFBoYXNlci5Qb2ludCgwLCAwKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGFzcGVjdFJhdGlvIC0gQXNwZWN0IHJhdGlvLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYXNwZWN0UmF0aW8gPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FueX0gZXZlbnQtIFRoZSBuYXRpdmUgYnJvd3NlciBldmVudHMgZnJvbSBmdWxsIHNjcmVlbiBBUEkgY2hhbmdlcy4KICAgICovCiAgICB0aGlzLmV2ZW50ID0gbnVsbDsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvcmllbnRhdGlvbmNoYW5nZScsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHJldHVybiBfdGhpcy5jaGVja09yaWVudGF0aW9uKGV2ZW50KTsKICAgIH0sIGZhbHNlKTsKCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIF90aGlzLmNoZWNrUmVzaXplKGV2ZW50KTsKICAgIH0sIGZhbHNlKTsKCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRmdWxsc2NyZWVuY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIF90aGlzLmZ1bGxTY3JlZW5DaGFuZ2UoZXZlbnQpOwogICAgfSwgZmFsc2UpOwoKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vemZ1bGxzY3JlZW5jaGFuZ2UnLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICByZXR1cm4gX3RoaXMuZnVsbFNjcmVlbkNoYW5nZShldmVudCk7CiAgICB9LCBmYWxzZSk7CgogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZnVsbHNjcmVlbmNoYW5nZScsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHJldHVybiBfdGhpcy5mdWxsU2NyZWVuQ2hhbmdlKGV2ZW50KTsKICAgIH0sIGZhbHNlKTsKICAgIAp9OwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLlN0YWdlU2NhbGVNb2RlLkVYQUNUX0ZJVCA9IDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuTk9fU0NBTEUgPSAxOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLlN0YWdlU2NhbGVNb2RlLlNIT1dfQUxMID0gMjsKClBoYXNlci5TdGFnZVNjYWxlTW9kZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFRyaWVzIHRvIGVudGVyIHRoZSBicm93c2VyIGludG8gZnVsbCBzY3JlZW4gbW9kZS4KICAgICogUGxlYXNlIG5vdGUgdGhhdCB0aGlzIG5lZWRzIHRvIGJlIHN1cHBvcnRlZCBieSB0aGUgd2ViIGJyb3dzZXIgYW5kIGlzbid0IHRoZSBzYW1lIHRoaW5nIGFzIHNldHRpbmcgeW91ciBnYW1lIHRvIGZpbGwgdGhlIGJyb3dzZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI3N0YXJ0RnVsbFNjcmVlbgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGFudGlhbGlhcyAtIFlvdSBjYW4gdG9nZ2xlIHRoZSBhbnRpLWFsaWFzIGZlYXR1cmUgb2YgdGhlIGNhbnZhcyBiZWZvcmUganVtcGluZyBpbiB0byBmdWxsIHNjcmVlbiAoZmFsc2UgPSByZXRhaW4gcGl4ZWwgYXJ0LCB0cnVlID0gc21vb3RoIGFydCkKICAgICovCiAgICBzdGFydEZ1bGxTY3JlZW46IGZ1bmN0aW9uIChhbnRpYWxpYXMpIHsKCiAgICAgICAgaWYgKHRoaXMuaXNGdWxsU2NyZWVuKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBhbnRpYWxpYXMgIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgUGhhc2VyLkNhbnZhcy5zZXRTbW9vdGhpbmdFbmFibGVkKHRoaXMuZ2FtZS5jb250ZXh0LCBhbnRpYWxpYXMpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmdhbWUuY2FudmFzOwogICAgICAgIAogICAgICAgIHRoaXMuX3dpZHRoID0gdGhpcy53aWR0aDsKICAgICAgICB0aGlzLl9oZWlnaHQgPSB0aGlzLmhlaWdodDsKCiAgICAgICAgLy8gIFRoaXMgbmVlZHMgdXBkYXRpbmcgdG8gbWF0Y2ggdGhlIGZpbmFsIHNwZWM6CiAgICAgICAgLy8gIGh0dHA6Ly9nZW5lcmF0ZWRjb250ZW50Lm9yZy9wb3N0LzcwMzQ3NTczMjk0L2lzLXlvdXItZnVsbHNjcmVlbi1hcGktY29kZS11cC10by1kYXRlLWZpbmQtb3V0LWhvdy10bwoKICAgICAgICBpZiAoZWxlbWVudFsncmVxdWVzdEZ1bGxTY3JlZW4nXSkKICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnRbJ3JlcXVlc3RGdWxsU2NyZWVuJ10oKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZWxlbWVudFsnbW96UmVxdWVzdEZ1bGxTY3JlZW4nXSkKICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnQucGFyZW50Tm9kZVsnbW96UmVxdWVzdEZ1bGxTY3JlZW4nXSgpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChlbGVtZW50Wyd3ZWJraXRSZXF1ZXN0RnVsbFNjcmVlbiddKQogICAgICAgIHsKICAgICAgICAgICAgZWxlbWVudFsnd2Via2l0UmVxdWVzdEZ1bGxTY3JlZW4nXShFbGVtZW50LkFMTE9XX0tFWUJPQVJEX0lOUFVUKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgZnVsbCBzY3JlZW4gbW9kZSBpZiB0aGUgYnJvd3NlciBpcyBpbiBpdC4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjc3RvcEZ1bGxTY3JlZW4KICAgICovCiAgICBzdG9wRnVsbFNjcmVlbjogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAoZG9jdW1lbnRbJ2NhbmNlbEZ1bGxTY3JlZW4nXSkKICAgICAgICB7CiAgICAgICAgICAgIGRvY3VtZW50WydjYW5jZWxGdWxsU2NyZWVuJ10oKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZG9jdW1lbnRbJ21vekNhbmNlbEZ1bGxTY3JlZW4nXSkKICAgICAgICB7CiAgICAgICAgICAgIGRvY3VtZW50Wydtb3pDYW5jZWxGdWxsU2NyZWVuJ10oKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZG9jdW1lbnRbJ3dlYmtpdENhbmNlbEZ1bGxTY3JlZW4nXSkKICAgICAgICB7CiAgICAgICAgICAgIGRvY3VtZW50Wyd3ZWJraXRDYW5jZWxGdWxsU2NyZWVuJ10oKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGUgYnJvd3NlciBlbnRlcnMgb2YgbGVhdmVzIGZ1bGwgc2NyZWVuIG1vZGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2Z1bGxTY3JlZW5DaGFuZ2UKICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgLSBUaGUgZnVsbHNjcmVlbmNoYW5nZSBldmVudAogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgZnVsbFNjcmVlbkNoYW5nZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuZXZlbnQgPSBldmVudDsKCiAgICAgICAgaWYgKHRoaXMuaXNGdWxsU2NyZWVuKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGFnZS5mdWxsU2NyZWVuU2NhbGVNb2RlID09PSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuRVhBQ1RfRklUKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnN0eWxlWyd3aWR0aCddID0gJzEwMCUnOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5zdHlsZVsnaGVpZ2h0J10gPSAnMTAwJSc7CgogICAgICAgICAgICAgICAgdGhpcy5zZXRNYXhpbXVtKCk7CgogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnNjYWxlLnNldFRvKHRoaXMuZ2FtZS53aWR0aCAvIHRoaXMud2lkdGgsIHRoaXMuZ2FtZS5oZWlnaHQgLyB0aGlzLmhlaWdodCk7CgogICAgICAgICAgICAgICAgdGhpcy5hc3BlY3RSYXRpbyA9IHRoaXMud2lkdGggLyB0aGlzLmhlaWdodDsKICAgICAgICAgICAgICAgIHRoaXMuc2NhbGVGYWN0b3IueCA9IHRoaXMuZ2FtZS53aWR0aCAvIHRoaXMud2lkdGg7CiAgICAgICAgICAgICAgICB0aGlzLnNjYWxlRmFjdG9yLnkgPSB0aGlzLmdhbWUuaGVpZ2h0IC8gdGhpcy5oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5nYW1lLnN0YWdlLmZ1bGxTY3JlZW5TY2FsZU1vZGUgPT09IFBoYXNlci5TdGFnZVNjYWxlTW9kZS5TSE9XX0FMTCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLnNjYWxlLnNldFNob3dBbGwoKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5zY2FsZS5yZWZyZXNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5zdHlsZVsnd2lkdGgnXSA9IHRoaXMuZ2FtZS53aWR0aCArICdweCc7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMuc3R5bGVbJ2hlaWdodCddID0gdGhpcy5nYW1lLmhlaWdodCArICdweCc7CgogICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5fd2lkdGg7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy5faGVpZ2h0OwoKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnNjYWxlLnNldFRvKHRoaXMuZ2FtZS53aWR0aCAvIHRoaXMud2lkdGgsIHRoaXMuZ2FtZS5oZWlnaHQgLyB0aGlzLmhlaWdodCk7CgogICAgICAgICAgICB0aGlzLmFzcGVjdFJhdGlvID0gdGhpcy53aWR0aCAvIHRoaXMuaGVpZ2h0OwogICAgICAgICAgICB0aGlzLnNjYWxlRmFjdG9yLnggPSB0aGlzLmdhbWUud2lkdGggLyB0aGlzLndpZHRoOwogICAgICAgICAgICB0aGlzLnNjYWxlRmFjdG9yLnkgPSB0aGlzLmdhbWUuaGVpZ2h0IC8gdGhpcy5oZWlnaHQ7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIElmIHlvdSBuZWVkIHlvdXIgZ2FtZSB0byBydW4gaW4gb25seSBvbmUgb3JpZW50YXRpb24geW91IGNhbiBmb3JjZSB0aGF0IHRvIGhhcHBlbi4KICAgICogVGhlIG9wdGlvbmFsIG9yaWVudGF0aW9uSW1hZ2UgaXMgZGlzcGxheWVkIHdoZW4gdGhlIGdhbWUgaXMgaW4gdGhlIGluY29ycmVjdCBvcmllbnRhdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjZm9yY2VPcmllbnRhdGlvbgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZvcmNlTGFuZHNjYXBlIC0gdHJ1ZSBpZiB0aGUgZ2FtZSBzaG91bGQgcnVuIGluIGxhbmRzY2FwZSBtb2RlIG9ubHkuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2ZvcmNlUG9ydHJhaXQ9ZmFsc2VdIC0gdHJ1ZSBpZiB0aGUgZ2FtZSBzaG91bGQgcnVuIGluIHBvcnRyYWl0IG1vZGUgb25seS4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtvcmllbnRhdGlvbkltYWdlPScnXSAtIFRoZSBzdHJpbmcgb2YgYW4gaW1hZ2UgaW4gdGhlIFBoYXNlci5DYWNoZSB0byBkaXNwbGF5IHdoZW4gdGhpcyBnYW1lIGlzIGluIHRoZSBpbmNvcnJlY3Qgb3JpZW50YXRpb24uCiAgICAqLwogICAgZm9yY2VPcmllbnRhdGlvbjogZnVuY3Rpb24gKGZvcmNlTGFuZHNjYXBlLCBmb3JjZVBvcnRyYWl0LCBvcmllbnRhdGlvbkltYWdlKSB7CgogICAgICAgIGlmICh0eXBlb2YgZm9yY2VQb3J0cmFpdCA9PT0gJ3VuZGVmaW5lZCcpIHsgZm9yY2VQb3J0cmFpdCA9IGZhbHNlOyB9CgogICAgICAgIHRoaXMuZm9yY2VMYW5kc2NhcGUgPSBmb3JjZUxhbmRzY2FwZTsKICAgICAgICB0aGlzLmZvcmNlUG9ydHJhaXQgPSBmb3JjZVBvcnRyYWl0OwoKICAgICAgICBpZiAodHlwZW9mIG9yaWVudGF0aW9uSW1hZ2UgIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKG9yaWVudGF0aW9uSW1hZ2UgPT0gbnVsbCB8fCB0aGlzLmdhbWUuY2FjaGUuY2hlY2tJbWFnZUtleShvcmllbnRhdGlvbkltYWdlKSA9PT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9yaWVudGF0aW9uSW1hZ2UgPSAnX19kZWZhdWx0JzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZSA9IG5ldyBQSVhJLlNwcml0ZShQSVhJLlRleHR1cmVDYWNoZVtvcmllbnRhdGlvbkltYWdlXSk7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUuYW5jaG9yLnggPSAwLjU7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUuYW5jaG9yLnkgPSAwLjU7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUucG9zaXRpb24ueCA9IHRoaXMuZ2FtZS53aWR0aCAvIDI7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUucG9zaXRpb24ueSA9IHRoaXMuZ2FtZS5oZWlnaHQgLyAyOwoKICAgICAgICAgICAgdGhpcy5jaGVja09yaWVudGF0aW9uU3RhdGUoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLndvcmxkLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLndvcmxkLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmFkZENoaWxkKHRoaXMub3JpZW50YXRpb25TcHJpdGUpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgaWYgdGhlIGJyb3dzZXIgaXMgaW4gdGhlIGNvcnJlY3Qgb3JpZW50YXRpb24gZm9yIHlvdXIgZ2FtZSAoaWYgZm9yY2VMYW5kc2NhcGUgb3IgZm9yY2VQb3J0cmFpdCBoYXZlIGJlZW4gc2V0KQogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNjaGVja09yaWVudGF0aW9uU3RhdGUKICAgICovCiAgICBjaGVja09yaWVudGF0aW9uU3RhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy8gIFRoZXkgYXJlIGluIHRoZSB3cm9uZyBvcmllbnRhdGlvbgogICAgICAgIGlmICh0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCh0aGlzLmZvcmNlTGFuZHNjYXBlICYmIHdpbmRvdy5pbm5lcldpZHRoID4gd2luZG93LmlubmVySGVpZ2h0KSB8fCAodGhpcy5mb3JjZVBvcnRyYWl0ICYmIHdpbmRvdy5pbm5lckhlaWdodCA+IHdpbmRvdy5pbm5lcldpZHRoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIEJhY2sgdG8gbm9ybWFsCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGF1c2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmxlYXZlSW5jb3JyZWN0T3JpZW50YXRpb24uZGlzcGF0Y2goKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcmllbnRhdGlvblNwcml0ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUud29ybGQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCh0aGlzLmZvcmNlTGFuZHNjYXBlICYmIHdpbmRvdy5pbm5lcldpZHRoIDwgd2luZG93LmlubmVySGVpZ2h0KSB8fCAodGhpcy5mb3JjZVBvcnRyYWl0ICYmIHdpbmRvdy5pbm5lckhlaWdodCA8IHdpbmRvdy5pbm5lcldpZHRoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFNob3cgb3JpZW50YXRpb24gc2NyZWVuCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGF1c2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5lbnRlckluY29ycmVjdE9yaWVudGF0aW9uLmRpc3BhdGNoKCk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMub3JpZW50YXRpb25TcHJpdGUgJiYgdGhpcy5vcmllbnRhdGlvblNwcml0ZS52aXNpYmxlID09PSBmYWxzZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS53b3JsZC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgKiBIYW5kbGUgd2luZG93Lm9yaWVudGF0aW9uY2hhbmdlIGV2ZW50cwogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNjaGVja09yaWVudGF0aW9uCiAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IC0gVGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRhdGEuCiAgICAqLwogICAgY2hlY2tPcmllbnRhdGlvbjogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuZXZlbnQgPSBldmVudDsKCiAgICAgICAgdGhpcy5vcmllbnRhdGlvbiA9IHdpbmRvd1snb3JpZW50YXRpb24nXTsKCiAgICAgICAgaWYgKHRoaXMuaXNMYW5kc2NhcGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmVudGVyTGFuZHNjYXBlLmRpc3BhdGNoKHRoaXMub3JpZW50YXRpb24sIHRydWUsIGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lbnRlclBvcnRyYWl0LmRpc3BhdGNoKHRoaXMub3JpZW50YXRpb24sIGZhbHNlLCB0cnVlKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZ2Uuc2NhbGVNb2RlICE9PSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuTk9fU0NBTEUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSGFuZGxlIHdpbmRvdy5yZXNpemUgZXZlbnRzCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2NoZWNrUmVzaXplCiAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IC0gVGhlIHJlc2l6ZSBldmVudCBkYXRhLgogICAgKi8KICAgIGNoZWNrUmVzaXplOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5ldmVudCA9IGV2ZW50OwoKICAgICAgICBpZiAod2luZG93Lm91dGVyV2lkdGggPiB3aW5kb3cub3V0ZXJIZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uID0gOTA7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb24gPSAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuaXNMYW5kc2NhcGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmVudGVyTGFuZHNjYXBlLmRpc3BhdGNoKHRoaXMub3JpZW50YXRpb24sIHRydWUsIGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lbnRlclBvcnRyYWl0LmRpc3BhdGNoKHRoaXMub3JpZW50YXRpb24sIGZhbHNlLCB0cnVlKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZ2Uuc2NhbGVNb2RlICE9PSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuTk9fU0NBTEUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY2hlY2tPcmllbnRhdGlvblN0YXRlKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmUtY2FsY3VsYXRlIHNjYWxlIG1vZGUgYW5kIHVwZGF0ZSBzY3JlZW4gc2l6ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjcmVmcmVzaAogICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy8gIFdlIGNhbid0IGRvIGFueXRoaW5nIGFib3V0IHRoZSBzdGF0dXMgYmFycyBpbiBpUGFkcywgd2ViIGFwcHMgb3IgZGVza3RvcHMKICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS5pUGFkID09PSBmYWxzZSAmJiB0aGlzLmdhbWUuZGV2aWNlLndlYkFwcCA9PT0gZmFsc2UgJiYgdGhpcy5nYW1lLmRldmljZS5kZXNrdG9wID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLmFuZHJvaWQgJiYgdGhpcy5nYW1lLmRldmljZS5jaHJvbWUgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9jaGVjayA9PSBudWxsICYmIHRoaXMubWF4SXRlcmF0aW9ucyA+IDApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9pdGVyYXRpb25zID0gdGhpcy5tYXhJdGVyYXRpb25zOwoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuX2NoZWNrID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5zZXRTY3JlZW5TaXplKCk7CiAgICAgICAgICAgIH0sIDEwKTsKCiAgICAgICAgICAgIHRoaXMuc2V0U2NyZWVuU2l6ZSgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXQgc2NyZWVuIHNpemUgYXV0b21hdGljYWxseSBiYXNlZCBvbiB0aGUgc2NhbGVNb2RlLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZvcmNlIC0gSWYgZm9yY2UgaXMgdHJ1ZSBpdCB3aWxsIHRyeSB0byByZXNpemUgdGhlIGdhbWUgcmVnYXJkbGVzcyBvZiB0aGUgZG9jdW1lbnQgZGltZW5zaW9ucy4KICAgICovCiAgICBzZXRTY3JlZW5TaXplOiBmdW5jdGlvbiAoZm9yY2UpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBmb3JjZSA9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIGZvcmNlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLmlQYWQgPT09IGZhbHNlICYmIHRoaXMuZ2FtZS5kZXZpY2Uud2ViQXBwID09PSBmYWxzZSAmJiB0aGlzLmdhbWUuZGV2aWNlLmRlc2t0b3AgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UuYW5kcm9pZCAmJiB0aGlzLmdhbWUuZGV2aWNlLmNocm9tZSA9PT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5faXRlcmF0aW9ucy0tOwoKICAgICAgICBpZiAoZm9yY2UgfHwgd2luZG93LmlubmVySGVpZ2h0ID4gdGhpcy5fc3RhcnRIZWlnaHQgfHwgdGhpcy5faXRlcmF0aW9ucyA8IDApCiAgICAgICAgewogICAgICAgICAgICAvLyBTZXQgbWluaW11bSBoZWlnaHQgb2YgY29udGVudCB0byBuZXcgd2luZG93IGhlaWdodAogICAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbJ3N0eWxlJ10ubWluSGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0ICsgJ3B4JzsKICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24gPT09IHRydWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0TWF4aW11bSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKCF0aGlzLmlzRnVsbFNjcmVlbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGFnZS5zY2FsZU1vZGUgPT0gUGhhc2VyLlN0YWdlU2NhbGVNb2RlLkVYQUNUX0ZJVCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEV4YWN0Rml0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmdhbWUuc3RhZ2Uuc2NhbGVNb2RlID09IFBoYXNlci5TdGFnZVNjYWxlTW9kZS5TSE9XX0FMTCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFNob3dBbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZ2UuZnVsbFNjcmVlblNjYWxlTW9kZSA9PSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuRVhBQ1RfRklUKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RXhhY3RGaXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZ2FtZS5zdGFnZS5mdWxsU2NyZWVuU2NhbGVNb2RlID09IFBoYXNlci5TdGFnZVNjYWxlTW9kZS5TSE9XX0FMTCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFNob3dBbGwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zZXRTaXplKCk7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fY2hlY2spOwogICAgICAgICAgICB0aGlzLl9jaGVjayA9IG51bGw7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGNhbnZhcyBzdHlsZSB3aWR0aCBhbmQgaGVpZ2h0IHZhbHVlcyBiYXNlZCBvbiBtaW5XaWR0aC9IZWlnaHQgYW5kIG1heFdpZHRoL0hlaWdodC4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjc2V0U2l6ZQogICAgKi8KICAgIHNldFNpemU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24gPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMubWF4V2lkdGggJiYgdGhpcy53aWR0aCA+IHRoaXMubWF4V2lkdGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMud2lkdGggPSB0aGlzLm1heFdpZHRoOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5tYXhIZWlnaHQgJiYgdGhpcy5oZWlnaHQgPiB0aGlzLm1heEhlaWdodCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSB0aGlzLm1heEhlaWdodDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWluV2lkdGggJiYgdGhpcy53aWR0aCA8IHRoaXMubWluV2lkdGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMud2lkdGggPSB0aGlzLm1pbldpZHRoOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5taW5IZWlnaHQgJiYgdGhpcy5oZWlnaHQgPCB0aGlzLm1pbkhlaWdodCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSB0aGlzLm1pbkhlaWdodDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5nYW1lLmNhbnZhcy5zdHlsZS53aWR0aCA9IHRoaXMud2lkdGggKyAncHgnOwogICAgICAgIHRoaXMuZ2FtZS5jYW52YXMuc3R5bGUuaGVpZ2h0ID0gdGhpcy5oZWlnaHQgKyAncHgnOwogICAgICAgIAogICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5zY2FsZS5zZXRUbyh0aGlzLmdhbWUud2lkdGggLyB0aGlzLndpZHRoLCB0aGlzLmdhbWUuaGVpZ2h0IC8gdGhpcy5oZWlnaHQpOwoKICAgICAgICBpZiAodGhpcy5wYWdlQWxpZ25Ib3Jpem9udGFsbHkpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy53aWR0aCA8IHdpbmRvdy5pbm5lcldpZHRoICYmIHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24gPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm1hcmdpbi54ID0gTWF0aC5yb3VuZCgod2luZG93LmlubmVyV2lkdGggLSB0aGlzLndpZHRoKSAvIDIpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhbnZhcy5zdHlsZS5tYXJnaW5MZWZ0ID0gdGhpcy5tYXJnaW4ueCArICdweCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm1hcmdpbi54ID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW52YXMuc3R5bGUubWFyZ2luTGVmdCA9ICcwcHgnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wYWdlQWxpZ25WZXJ0aWNhbGx5KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuaGVpZ2h0IDwgd2luZG93LmlubmVySGVpZ2h0ICYmIHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24gPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm1hcmdpbi55ID0gTWF0aC5yb3VuZCgod2luZG93LmlubmVySGVpZ2h0IC0gdGhpcy5oZWlnaHQpIC8gMik7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLm1hcmdpblRvcCA9IHRoaXMubWFyZ2luLnkgKyAncHgnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5tYXJnaW4ueSA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLm1hcmdpblRvcCA9ICcwcHgnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBQaGFzZXIuQ2FudmFzLmdldE9mZnNldCh0aGlzLmdhbWUuY2FudmFzLCB0aGlzLmdhbWUuc3RhZ2Uub2Zmc2V0KTsKICAgICAgICAKICAgICAgICB0aGlzLmFzcGVjdFJhdGlvID0gdGhpcy53aWR0aCAvIHRoaXMuaGVpZ2h0OwogICAgICAgIAogICAgICAgIHRoaXMuc2NhbGVGYWN0b3IueCA9IHRoaXMuZ2FtZS53aWR0aCAvIHRoaXMud2lkdGg7CiAgICAgICAgdGhpcy5zY2FsZUZhY3Rvci55ID0gdGhpcy5nYW1lLmhlaWdodCAvIHRoaXMuaGVpZ2h0OwoKICAgICAgICB0aGlzLnNjYWxlRmFjdG9ySW52ZXJzZWQueCA9IHRoaXMud2lkdGggLyB0aGlzLmdhbWUud2lkdGg7CiAgICAgICAgdGhpcy5zY2FsZUZhY3RvckludmVyc2VkLnkgPSB0aGlzLmhlaWdodCAvIHRoaXMuZ2FtZS5oZWlnaHQ7CgogICAgICAgIHRoaXMuaGFzUmVzaXplZC5kaXNwYXRjaCh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgogICAgICAgIHRoaXMuY2hlY2tPcmllbnRhdGlvblN0YXRlKCk7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGlzLndpZHRoIGVxdWFsIHRvIHdpbmRvdy5pbm5lcldpZHRoIGFuZCB0aGlzLmhlaWdodCBlcXVhbCB0byB3aW5kb3cuaW5uZXJIZWlnaHQKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjc2V0TWF4aW11bQogICAgKi8KICAgIHNldE1heGltdW06IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy53aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGN1bGF0ZXMgdGhlIG11bHRpcGxpZXIgbmVlZGVkIHRvIHNjYWxlIHRoZSBnYW1lIHByb3BvcnRpb25hbGx5LgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNzZXRTaG93QWxsCiAgICAqLwogICAgc2V0U2hvd0FsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgbXVsdGlwbGllciA9IE1hdGgubWluKCh3aW5kb3cuaW5uZXJIZWlnaHQgLyB0aGlzLmdhbWUuaGVpZ2h0KSwgKHdpbmRvdy5pbm5lcldpZHRoIC8gdGhpcy5nYW1lLndpZHRoKSk7CgogICAgICAgIHRoaXMud2lkdGggPSBNYXRoLnJvdW5kKHRoaXMuZ2FtZS53aWR0aCAqIG11bHRpcGxpZXIpOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gTWF0aC5yb3VuZCh0aGlzLmdhbWUuaGVpZ2h0ICogbXVsdGlwbGllcik7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgd2lkdGggYW5kIGhlaWdodCB2YWx1ZXMgb2YgdGhlIGNhbnZhcywgbm8gbGFyZ2VyIHRoYW4gdGhlIG1heFdpZHRoL0hlaWdodC4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjc2V0RXhhY3RGaXQKICAgICovCiAgICBzZXRFeGFjdEZpdDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgYXZhaWxhYmxlV2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICB2YXIgYXZhaWxhYmxlSGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwoKICAgICAgICBpZiAodGhpcy5tYXhXaWR0aCAmJiBhdmFpbGFibGVXaWR0aCA+IHRoaXMubWF4V2lkdGgpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5tYXhXaWR0aDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IGF2YWlsYWJsZVdpZHRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMubWF4SGVpZ2h0ICYmIGF2YWlsYWJsZUhlaWdodCA+IHRoaXMubWF4SGVpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSB0aGlzLm1heEhlaWdodDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSBhdmFpbGFibGVIZWlnaHQ7CiAgICAgICAgfQoKICAgIH0KCn07CgpQaGFzZXIuU3RhZ2VTY2FsZU1vZGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlN0YWdlU2NhbGVNb2RlOwoKLyoqCiogQG5hbWUgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2lzRnVsbFNjcmVlbgoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNGdWxsU2NyZWVuIC0gUmV0dXJucyB0cnVlIGlmIHRoZSBicm93c2VyIGlzIGluIGZ1bGwgc2NyZWVuIG1vZGUsIG90aGVyd2lzZSBmYWxzZS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TdGFnZVNjYWxlTW9kZS5wcm90b3R5cGUsICJpc0Z1bGxTY3JlZW4iLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiAoZG9jdW1lbnRbJ2Z1bGxzY3JlZW5FbGVtZW50J10gfHwgZG9jdW1lbnRbJ21vekZ1bGxTY3JlZW5FbGVtZW50J10gfHwgZG9jdW1lbnRbJ3dlYmtpdEZ1bGxzY3JlZW5FbGVtZW50J10pCgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjaXNQb3J0cmFpdAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNQb3J0cmFpdCAtIFJldHVybnMgdHJ1ZSBpZiB0aGUgYnJvd3NlciBkaW1lbnNpb25zIG1hdGNoIGEgcG9ydHJhaXQgZGlzcGxheS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TdGFnZVNjYWxlTW9kZS5wcm90b3R5cGUsICJpc1BvcnRyYWl0IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLm9yaWVudGF0aW9uID09PSAwIHx8IHRoaXMub3JpZW50YXRpb24gPT0gMTgwOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjaXNMYW5kc2NhcGUKKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzTGFuZHNjYXBlIC0gUmV0dXJucyB0cnVlIGlmIHRoZSBicm93c2VyIGRpbWVuc2lvbnMgbWF0Y2ggYSBsYW5kc2NhcGUgZGlzcGxheS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TdGFnZVNjYWxlTW9kZS5wcm90b3R5cGUsICJpc0xhbmRzY2FwZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5vcmllbnRhdGlvbiA9PT0gOTAgfHwgdGhpcy5vcmllbnRhdGlvbiA9PT0gLTkwOwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBEZXRlY3RzIGRldmljZSBzdXBwb3J0IGNhcGFiaWxpdGllcy4gVXNpbmcgc29tZSBlbGVtZW50cyBmcm9tIFN5c3RlbS5qcyBieSBNckRvb2IgYW5kIE1vZGVybml6cgoqCiogQGNsYXNzIFBoYXNlci5EZXZpY2UKKiBAY29uc3RydWN0b3IKKi8KClBoYXNlci5EZXZpY2UgPSBmdW5jdGlvbiAoKSB7CgogICAgLyoqCiAgICAqIEFuIG9wdGlvbmFsICdmaXgnIGZvciB0aGUgaG9ycmVuZG91cyBBbmRyb2lkIHN0b2NrIGJyb3dzZXIgYnVnIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvYW5kcm9pZC9pc3N1ZXMvZGV0YWlsP2lkPTM5MjQ3CiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGF0Y2hBbmRyb2lkQ2xlYXJSZWN0QnVnIC0gRGVzY3JpcHRpb24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYXRjaEFuZHJvaWRDbGVhclJlY3RCdWcgPSBmYWxzZTsKCiAgICAvLyAgT3BlcmF0aW5nIFN5c3RlbQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRlc2t0b3AgLSBJcyBydW5uaW5nIGRlc2t0b3A/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kZXNrdG9wID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaU9TIC0gSXMgcnVubmluZyBvbiBpT1M/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pT1MgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjb2Nvb25KUyAtIElzIHRoZSBnYW1lIHJ1bm5pbmcgdW5kZXIgQ29jb29uSlM/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb2Nvb25KUyA9IGZhbHNlOwoKICAgIC8qKgogICAgICogQHByb3BlcnR5IHtib29sZWFufSBlamVjdGEgLSBJcyB0aGUgZ2FtZSBydW5uaW5nIHVuZGVyIEVqZWN0YT8KICAgICAqIEBkZWZhdWx0CiAgICAgKi8KICAgIHRoaXMuZWplY3RhID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYW5kcm9pZCAtIElzIHJ1bm5pbmcgb24gYW5kcm9pZD8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFuZHJvaWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjaHJvbWVPUyAtIElzIHJ1bm5pbmcgb24gY2hyb21lT1M/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jaHJvbWVPUyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGxpbnV4IC0gSXMgcnVubmluZyBvbiBsaW51eD8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmxpbnV4ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbWFjT1MgLSBJcyBydW5uaW5nIG9uIG1hY09TPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWFjT1MgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB3aW5kb3dzIC0gSXMgcnVubmluZyBvbiB3aW5kb3dzPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMud2luZG93cyA9IGZhbHNlOwoKICAgIC8vICBGZWF0dXJlcwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNhbnZhcyAtIElzIGNhbnZhcyBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jYW52YXMgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBmaWxlIC0gSXMgZmlsZSBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5maWxlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZmlsZVN5c3RlbSAtIElzIGZpbGVTeXN0ZW0gYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZmlsZVN5c3RlbSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGxvY2FsU3RvcmFnZSAtIElzIGxvY2FsU3RvcmFnZSBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5sb2NhbFN0b3JhZ2UgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB3ZWJHTCAtIElzIHdlYkdMIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndlYkdMID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gd29ya2VyIC0gSXMgd29ya2VyIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndvcmtlciA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHRvdWNoIC0gSXMgdG91Y2ggYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudG91Y2ggPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBtc3BvaW50ZXIgLSBJcyBtc3BvaW50ZXIgYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubXNwb2ludGVyID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY3NzM0QgLSBJcyBjc3MzRCBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jc3MzRCA9IGZhbHNlOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtib29sZWFufSBwb2ludGVyTG9jayAtIElzIFBvaW50ZXIgTG9jayBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wb2ludGVyTG9jayA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHR5cGVkQXJyYXkgLSBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgVHlwZWRBcnJheXM/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50eXBlZEFycmF5ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmlicmF0aW9uIC0gRG9lcyB0aGUgZGV2aWNlIHN1cHBvcnQgdGhlIFZpYnJhdGlvbiBBUEk/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy52aWJyYXRpb24gPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBxdWlya3NNb2RlIC0gSXMgdGhlIGJyb3dzZXIgcnVubmluZyBpbiBzdHJpY3QgbW9kZSAoZmFsc2UpIG9yIHF1aXJrcyBtb2RlPyAodHJ1ZSkKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnF1aXJrc01vZGUgPSBmYWxzZTsKCiAgICAvLyAgQnJvd3NlcgoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFyb3JhIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBBcm9yYS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFyb3JhID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY2hyb21lIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBDaHJvbWUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jaHJvbWUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBlcGlwaGFueSAtIFNldCB0byB0cnVlIGlmIHJ1bm5pbmcgaW4gRXBpcGhhbnkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5lcGlwaGFueSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZpcmVmb3ggLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGluIEZpcmVmb3guCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5maXJlZm94ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaWUgLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGluIEludGVybmV0IEV4cGxvcmVyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaWUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGllVmVyc2lvbiAtIElmIHJ1bm5pbmcgaW4gSW50ZXJuZXQgRXhwbG9yZXIgdGhpcyB3aWxsIGNvbnRhaW4gdGhlIG1ham9yIHZlcnNpb24gbnVtYmVyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaWVWZXJzaW9uID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB0cmlkZW50IC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBhIFRyaWRlbnQgdmVyc2lvbiBvZiBJbnRlcm5ldCBFeHBsb3JlciAoSUUxMSspCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50cmlkZW50ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0cmlkZW50VmVyc2lvbiAtIElmIHJ1bm5pbmcgaW4gSW50ZXJuZXQgRXhwbG9yZXIgMTEgdGhpcyB3aWxsIGNvbnRhaW4gdGhlIG1ham9yIHZlcnNpb24gbnVtYmVyLiBTZWUgaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2llL21zNTM3NTAzKHY9dnMuODUpLmFzcHgKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRyaWRlbnRWZXJzaW9uID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBtb2JpbGVTYWZhcmkgLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGluIE1vYmlsZSBTYWZhcmkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tb2JpbGVTYWZhcmkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBtaWRvcmkgLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGluIE1pZG9yaS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1pZG9yaSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG9wZXJhIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBPcGVyYS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9wZXJhID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gc2FmYXJpIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBTYWZhcmkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zYWZhcmkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB3ZWJBcHAgLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGFzIGEgV2ViQXBwLCBpLmUuIHdpdGhpbiBhIFdlYlZpZXcKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndlYkFwcCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHNpbGsgLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGluIHRoZSBTaWxrIGJyb3dzZXIgKGFzIHVzZWQgb24gdGhlIEFtYXpvbiBLaW5kbGUpCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zaWxrID0gZmFsc2U7CgogICAgLy8gIEF1ZGlvCgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYXVkaW9EYXRhIC0gQXJlIEF1ZGlvIHRhZ3MgYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYXVkaW9EYXRhID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gd2ViQXVkaW8gLSBJcyB0aGUgV2ViQXVkaW8gQVBJIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndlYkF1ZGlvID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gb2dnIC0gQ2FuIHRoaXMgZGV2aWNlIHBsYXkgb2dnIGZpbGVzPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub2dnID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gb3B1cyAtIENhbiB0aGlzIGRldmljZSBwbGF5IG9wdXMgZmlsZXM/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vcHVzID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbXAzIC0gQ2FuIHRoaXMgZGV2aWNlIHBsYXkgbXAzIGZpbGVzPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubXAzID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gd2F2IC0gQ2FuIHRoaXMgZGV2aWNlIHBsYXkgd2F2IGZpbGVzPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMud2F2ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIENhbiB0aGlzIGRldmljZSBwbGF5IG00YSBmaWxlcz8KICAgICogQHByb3BlcnR5IHtib29sZWFufSBtNGEgLSBUcnVlIGlmIHRoaXMgZGV2aWNlIGNhbiBwbGF5IG00YSBmaWxlcy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm00YSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHdlYm0gLSBDYW4gdGhpcyBkZXZpY2UgcGxheSB3ZWJtIGZpbGVzPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMud2VibSA9IGZhbHNlOwoKICAgIC8vICBEZXZpY2UKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpUGhvbmUgLSBJcyBydW5uaW5nIG9uIGlQaG9uZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlQaG9uZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlQaG9uZTQgLSBJcyBydW5uaW5nIG9uIGlQaG9uZTQ/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pUGhvbmU0ID0gZmFsc2U7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlQYWQgLSBJcyBydW5uaW5nIG9uIGlQYWQ/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pUGFkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwaXhlbFJhdGlvIC0gUGl4ZWxSYXRpbyBvZiB0aGUgaG9zdCBkZXZpY2U/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5waXhlbFJhdGlvID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBsaXR0bGVFbmRpYW4gLSBJcyB0aGUgZGV2aWNlIGJpZyBvciBsaXR0bGUgZW5kaWFuPyAob25seSBkZXRlY3RlZCBpZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBUeXBlZEFycmF5cykKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmxpdHRsZUVuZGlhbiA9IGZhbHNlOwoKICAgIC8vICBSdW4gdGhlIGNoZWNrcwogICAgdGhpcy5fY2hlY2tBdWRpbygpOwogICAgdGhpcy5fY2hlY2tCcm93c2VyKCk7CiAgICB0aGlzLl9jaGVja0NTUzNEKCk7CiAgICB0aGlzLl9jaGVja0RldmljZSgpOwogICAgdGhpcy5fY2hlY2tGZWF0dXJlcygpOwogICAgdGhpcy5fY2hlY2tPUygpOwogICAgCn07CgpQaGFzZXIuRGV2aWNlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQ2hlY2sgd2hpY2ggT1MgaXMgZ2FtZSBydW5uaW5nIG9uLgogICAgKiBAbWV0aG9kIFBoYXNlci5EZXZpY2UjX2NoZWNrT1MKICAgICogQHByaXZhdGUKICAgICovCiAgICBfY2hlY2tPUzogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50OwoKICAgICAgICBpZiAoL0FuZHJvaWQvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hbmRyb2lkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoL0NyT1MvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jaHJvbWVPUyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9pUFthb11kfGlQaG9uZS9pLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5pT1MgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgvTGludXgvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5saW51eCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9NYWMgT1MvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tYWNPUyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9XaW5kb3dzLy50ZXN0KHVhKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud2luZG93cyA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy53aW5kb3dzIHx8IHRoaXMubWFjT1MgfHwgKHRoaXMubGludXggJiYgdGhpcy5zaWxrID09PSBmYWxzZSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmRlc2t0b3AgPSB0cnVlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayBIVE1MNSBmZWF0dXJlcyBvZiB0aGUgaG9zdCBlbnZpcm9ubWVudC4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI19jaGVja0ZlYXR1cmVzCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX2NoZWNrRmVhdHVyZXM6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5jYW52YXMgPSAhIXdpbmRvd1snQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEJ107CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHRoaXMubG9jYWxTdG9yYWdlID0gISFsb2NhbFN0b3JhZ2UuZ2V0SXRlbTsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZSA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5maWxlID0gISF3aW5kb3dbJ0ZpbGUnXSAmJiAhIXdpbmRvd1snRmlsZVJlYWRlciddICYmICEhd2luZG93WydGaWxlTGlzdCddICYmICEhd2luZG93WydCbG9iJ107CiAgICAgICAgdGhpcy5maWxlU3lzdGVtID0gISF3aW5kb3dbJ3JlcXVlc3RGaWxlU3lzdGVtJ107CiAgICAgICAgdGhpcy53ZWJHTCA9ICggZnVuY3Rpb24gKCkgeyB0cnkgeyB2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2NhbnZhcycgKTsgcmV0dXJuICEhIHdpbmRvdy5XZWJHTFJlbmRlcmluZ0NvbnRleHQgJiYgKCBjYW52YXMuZ2V0Q29udGV4dCggJ3dlYmdsJyApIHx8IGNhbnZhcy5nZXRDb250ZXh0KCAnZXhwZXJpbWVudGFsLXdlYmdsJyApICk7IH0gY2F0Y2goIGUgKSB7IHJldHVybiBmYWxzZTsgfSB9ICkoKTsKCiAgICAgICAgaWYgKHRoaXMud2ViR0wgPT09IG51bGwgfHwgdGhpcy53ZWJHTCA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndlYkdMID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud2ViR0wgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy53b3JrZXIgPSAhIXdpbmRvd1snV29ya2VyJ107CiAgICAgICAgCiAgICAgICAgaWYgKCdvbnRvdWNoc3RhcnQnIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fCAod2luZG93Lm5hdmlnYXRvci5tYXhUb3VjaFBvaW50cyAmJiB3aW5kb3cubmF2aWdhdG9yLm1heFRvdWNoUG9pbnRzID4gMSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRvdWNoID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQgfHwgd2luZG93Lm5hdmlnYXRvci5wb2ludGVyRW5hYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubXNwb2ludGVyID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGhpcy5wb2ludGVyTG9jayA9ICdwb2ludGVyTG9ja0VsZW1lbnQnIGluIGRvY3VtZW50IHx8ICdtb3pQb2ludGVyTG9ja0VsZW1lbnQnIGluIGRvY3VtZW50IHx8ICd3ZWJraXRQb2ludGVyTG9ja0VsZW1lbnQnIGluIGRvY3VtZW50OwoKICAgICAgICB0aGlzLnF1aXJrc01vZGUgPSAoZG9jdW1lbnQuY29tcGF0TW9kZSA9PT0gJ0NTUzFDb21wYXQnKSA/IGZhbHNlIDogdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayB3aGF0IGJyb3dzZXIgaXMgZ2FtZSBydW5uaW5nIGluLgogICAgKiBAbWV0aG9kIFBoYXNlci5EZXZpY2UjX2NoZWNrQnJvd3NlcgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIF9jaGVja0Jyb3dzZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKCiAgICAgICAgaWYgKC9Bcm9yYS8udGVzdCh1YSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFyb3JhID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoL0Nocm9tZS8udGVzdCh1YSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNocm9tZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9FcGlwaGFueS8udGVzdCh1YSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmVwaXBoYW55ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoL0ZpcmVmb3gvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5maXJlZm94ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoL01vYmlsZSBTYWZhcmkvLnRlc3QodWEpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb2JpbGVTYWZhcmkgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgvTVNJRSAoXGQrXC5cZCspOy8udGVzdCh1YSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmllID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pZVZlcnNpb24gPSBwYXJzZUludChSZWdFeHAuJDEsIDEwKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoL01pZG9yaS8udGVzdCh1YSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm1pZG9yaSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9PcGVyYS8udGVzdCh1YSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9wZXJhID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoL1NhZmFyaS8udGVzdCh1YSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNhZmFyaSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9TaWxrLy50ZXN0KHVhKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc2lsayA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKC9UcmlkZW50XC8oXGQrXC5cZCspOy8udGVzdCh1YSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmllID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50cmlkZW50ID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy50cmlkZW50VmVyc2lvbiA9IHBhcnNlSW50KFJlZ0V4cC4kMSwgMTApOwogICAgICAgIH0KCiAgICAgICAgLy8gV2ViQXBwIG1vZGUgaW4gaU9TCiAgICAgICAgaWYgKG5hdmlnYXRvclsnc3RhbmRhbG9uZSddKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy53ZWJBcHAgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKG5hdmlnYXRvclsnaXNDb2Nvb25KUyddKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb2Nvb25KUyA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHdpbmRvdy5lamVjdGEgIT09ICJ1bmRlZmluZWQiKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lamVjdGEgPSB0cnVlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayBhdWRpbyBzdXBwb3J0LgogICAgKiBAbWV0aG9kIFBoYXNlci5EZXZpY2UjX2NoZWNrQXVkaW8KICAgICogQHByaXZhdGUKICAgICovCiAgICBfY2hlY2tBdWRpbzogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmF1ZGlvRGF0YSA9ICEhKHdpbmRvd1snQXVkaW8nXSk7CiAgICAgICAgdGhpcy53ZWJBdWRpbyA9ICEhKHdpbmRvd1snd2Via2l0QXVkaW9Db250ZXh0J10gfHwgd2luZG93WydBdWRpb0NvbnRleHQnXSk7CiAgICAgICAgdmFyIGF1ZGlvRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2F1ZGlvJyk7CiAgICAgICAgdmFyIHJlc3VsdCA9IGZhbHNlOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAocmVzdWx0ID0gISFhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGF1ZGlvRWxlbWVudC5jYW5QbGF5VHlwZSgnYXVkaW8vb2dnOyBjb2RlY3M9InZvcmJpcyInKS5yZXBsYWNlKC9ebm8kLywgJycpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vZ2cgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUoJ2F1ZGlvL29nZzsgY29kZWNzPSJvcHVzIicpLnJlcGxhY2UoL15ubyQvLCAnJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUoJ2F1ZGlvL21wZWc7JykucmVwbGFjZSgvXm5vJC8sICcnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubXAzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNaW1ldHlwZXMgYWNjZXB0ZWQ6CiAgICAgICAgICAgICAgICAvLyAgIGRldmVsb3Blci5tb3ppbGxhLm9yZy9Fbi9NZWRpYV9mb3JtYXRzX3N1cHBvcnRlZF9ieV90aGVfYXVkaW9fYW5kX3ZpZGVvX2VsZW1lbnRzCiAgICAgICAgICAgICAgICAvLyAgIGJpdC5seS9pcGhvbmVvc2NvZGVjcwogICAgICAgICAgICAgICAgaWYgKGF1ZGlvRWxlbWVudC5jYW5QbGF5VHlwZSgnYXVkaW8vd2F2OyBjb2RlY3M9IjEiJykucmVwbGFjZSgvXm5vJC8sICcnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMud2F2ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYXVkaW9FbGVtZW50LmNhblBsYXlUeXBlKCdhdWRpby94LW00YTsnKSB8fCBhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUoJ2F1ZGlvL2FhYzsnKS5yZXBsYWNlKC9ebm8kLywgJycpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tNGEgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUoJ2F1ZGlvL3dlYm07IGNvZGVjcz0idm9yYmlzIicpLnJlcGxhY2UoL15ubyQvLCAnJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLndlYm0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayBQaXhlbFJhdGlvIG9mIGRldmljZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkRldmljZSNfY2hlY2tEZXZpY2UKICAgICogQHByaXZhdGUKICAgICovCiAgICBfY2hlY2tEZXZpY2U6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5waXhlbFJhdGlvID0gd2luZG93WydkZXZpY2VQaXhlbFJhdGlvJ10gfHwgMTsKICAgICAgICB0aGlzLmlQaG9uZSA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCdpcGhvbmUnKSAhPSAtMTsKICAgICAgICB0aGlzLmlQaG9uZTQgPSAodGhpcy5waXhlbFJhdGlvID09IDIgJiYgdGhpcy5pUGhvbmUpOwogICAgICAgIHRoaXMuaVBhZCA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCdpcGFkJykgIT0gLTE7CgogICAgICAgIGlmICh0eXBlb2YgSW50OEFycmF5ICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubGl0dGxlRW5kaWFuID0gbmV3IEludDhBcnJheShuZXcgSW50MTZBcnJheShbMV0pLmJ1ZmZlcilbMF0gPiAwOwogICAgICAgICAgICB0aGlzLnR5cGVkQXJyYXkgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxpdHRsZUVuZGlhbiA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnR5cGVkQXJyYXkgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIG5hdmlnYXRvci52aWJyYXRlID0gbmF2aWdhdG9yLnZpYnJhdGUgfHwgbmF2aWdhdG9yLndlYmtpdFZpYnJhdGUgfHwgbmF2aWdhdG9yLm1velZpYnJhdGUgfHwgbmF2aWdhdG9yLm1zVmlicmF0ZTsKICAgICAgICAgCiAgICAgICAgaWYgKG5hdmlnYXRvci52aWJyYXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy52aWJyYXRpb24gPSB0cnVlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayB3aGV0aGVyIHRoZSBob3N0IGVudmlyb25tZW50IHN1cHBvcnQgM0QgQ1NTLgogICAgKiBAbWV0aG9kIFBoYXNlci5EZXZpY2UjX2NoZWNrQ1NTM0QKICAgICogQHByaXZhdGUKICAgICovCiAgICBfY2hlY2tDU1MzRDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7CiAgICAgICAgdmFyIGhhczNkOwogICAgICAgIHZhciB0cmFuc2Zvcm1zID0gewogICAgICAgICAgICAnd2Via2l0VHJhbnNmb3JtJzogJy13ZWJraXQtdHJhbnNmb3JtJywKICAgICAgICAgICAgJ09UcmFuc2Zvcm0nOiAnLW8tdHJhbnNmb3JtJywKICAgICAgICAgICAgJ21zVHJhbnNmb3JtJzogJy1tcy10cmFuc2Zvcm0nLAogICAgICAgICAgICAnTW96VHJhbnNmb3JtJzogJy1tb3otdHJhbnNmb3JtJywKICAgICAgICAgICAgJ3RyYW5zZm9ybSc6ICd0cmFuc2Zvcm0nCiAgICAgICAgfTsKCiAgICAgICAgLy8gQWRkIGl0IHRvIHRoZSBib2R5IHRvIGdldCB0aGUgY29tcHV0ZWQgc3R5bGUuCiAgICAgICAgZG9jdW1lbnQuYm9keS5pbnNlcnRCZWZvcmUoZWwsIG51bGwpOwoKICAgICAgICBmb3IgKHZhciB0IGluIHRyYW5zZm9ybXMpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZWwuc3R5bGVbdF0gIT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZWwuc3R5bGVbdF0gPSAidHJhbnNsYXRlM2QoMXB4LDFweCwxcHgpIjsKICAgICAgICAgICAgICAgIGhhczNkID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwpLmdldFByb3BlcnR5VmFsdWUodHJhbnNmb3Jtc1t0XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChlbCk7CiAgICAgICAgdGhpcy5jc3MzRCA9IChoYXMzZCAhPT0gdW5kZWZpbmVkICYmIGhhczNkLmxlbmd0aCA+IDAgJiYgaGFzM2QgIT09ICJub25lIik7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgd2hldGhlciB0aGUgaG9zdCBlbnZpcm9ubWVudCBjYW4gcGxheSBhdWRpby4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI2NhblBsYXlBdWRpbwogICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSAtIE9uZSBvZiAnbXAzLCAnb2dnJywgJ200YScsICd3YXYnLCAnd2VibScuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIGZpbGUgdHlwZSBpcyBzdXBwb3J0ZWQgYnkgdGhlIGJyb3dzZXIsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBjYW5QbGF5QXVkaW86IGZ1bmN0aW9uICh0eXBlKSB7CgogICAgICAgIGlmICh0eXBlID09ICdtcDMnICYmIHRoaXMubXAzKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gJ29nZycgJiYgKHRoaXMub2dnIHx8IHRoaXMub3B1cykpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAnbTRhJyAmJiB0aGlzLm00YSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICd3YXYnICYmIHRoaXMud2F2KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gJ3dlYm0nICYmIHRoaXMud2VibSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrIHdoZXRoZXIgdGhlIGNvbnNvbGUgaXMgb3Blbi4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI2lzQ29uc29sZU9wZW4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgYnJvd3NlciBkZXYgY29uc29sZSBpcyBvcGVuLgogICAgKi8KICAgIGlzQ29uc29sZU9wZW46IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHdpbmRvdy5jb25zb2xlICYmIHdpbmRvdy5jb25zb2xlWydmaXJlYnVnJ10pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cuY29uc29sZSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUucHJvZmlsZSgpOwogICAgICAgICAgICBjb25zb2xlLnByb2ZpbGVFbmQoKTsKCiAgICAgICAgICAgIGlmIChjb25zb2xlLmNsZWFyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmNsZWFyKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBjb25zb2xlWydwcm9maWxlcyddLmxlbmd0aCA+IDA7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfQoKfTsKClBoYXNlci5EZXZpY2UucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkRldmljZTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEFic3RyYWN0cyBhd2F5IHRoZSB1c2Ugb2YgUkFGIG9yIHNldFRpbWVPdXQgZm9yIHRoZSBjb3JlIGdhbWUgdXBkYXRlIGxvb3AuCioKKiBAY2xhc3MgUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSAKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSBmdW5jdGlvbihnYW1lKSB7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gVGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc1J1bm5pbmcgLSB0cnVlIGlmIFJlcXVlc3RBbmltYXRpb25GcmFtZSBpcyBydW5uaW5nLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc1J1bm5pbmcgPSBmYWxzZTsKCiAgICB2YXIgdmVuZG9ycyA9IFsKICAgICAgICAnbXMnLAogICAgICAgICdtb3onLAogICAgICAgICd3ZWJraXQnLAogICAgICAgICdvJwogICAgXTsKCiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHZlbmRvcnMubGVuZ3RoICYmICF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lOyB4KyspCiAgICB7CiAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IHdpbmRvd1t2ZW5kb3JzW3hdICsgJ1JlcXVlc3RBbmltYXRpb25GcmFtZSddOwogICAgICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IHdpbmRvd1t2ZW5kb3JzW3hdICsgJ0NhbmNlbEFuaW1hdGlvbkZyYW1lJ107CiAgICB9CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX2lzU2V0VGltZU91dCAgLSB0cnVlIGlmIHRoZSBicm93c2VyIGlzIHVzaW5nIHNldFRpbWVvdXQgaW5zdGVhZCBvZiByYWYuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5faXNTZXRUaW1lT3V0ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vbkxvb3AgLSBUaGUgZnVuY3Rpb24gY2FsbGVkIGJ5IHRoZSB1cGRhdGUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fb25Mb29wID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF90aW1lT3V0SUQgLSBUaGUgY2FsbGJhY2sgSUQgdXNlZCB3aGVuIGNhbGxpbmcgY2FuY2VsLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3RpbWVPdXRJRCA9IG51bGw7Cgp9OwoKUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFN0YXJ0cyB0aGUgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIHJ1bm5pbmcgb3Igc2V0VGltZW91dCBpZiB1bmF2YWlsYWJsZSBpbiBicm93c2VyCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSNzdGFydAogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuaXNSdW5uaW5nID0gdHJ1ZTsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgaWYgKCF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faXNTZXRUaW1lT3V0ID0gdHJ1ZTsKCiAgICAgICAgICAgIHRoaXMuX29uTG9vcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy51cGRhdGVTZXRUaW1lb3V0KCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl90aW1lT3V0SUQgPSB3aW5kb3cuc2V0VGltZW91dCh0aGlzLl9vbkxvb3AsIDApOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9pc1NldFRpbWVPdXQgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMuX29uTG9vcCA9IGZ1bmN0aW9uICh0aW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlUkFGKHRpbWUpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5fdGltZU91dElEID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLl9vbkxvb3ApOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgdXBkYXRlIG1ldGhvZCBmb3IgdGhlIHJlcXVlc3RBbmltYXRpb25GcmFtZQogICAgKiBAbWV0aG9kIFBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUjdXBkYXRlUkFGICAgIAogICAgKiBAcGFyYW0ge251bWJlcn0gdGltZSAtIEEgdGltZXN0YW1wLCBlaXRoZXIgZnJvbSBSQUYgb3Igc2V0VGltZU91dAogICAgKi8KICAgIHVwZGF0ZVJBRjogZnVuY3Rpb24gKHRpbWUpIHsKCiAgICAgICAgdGhpcy5nYW1lLnVwZGF0ZSh0aW1lKTsKCiAgICAgICAgdGhpcy5fdGltZU91dElEID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLl9vbkxvb3ApOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSB1cGRhdGUgbWV0aG9kIGZvciB0aGUgc2V0VGltZW91dC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lI3VwZGF0ZVNldFRpbWVvdXQKICAgICovCiAgICB1cGRhdGVTZXRUaW1lb3V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuZ2FtZS51cGRhdGUoRGF0ZS5ub3coKSk7CgogICAgICAgIHRoaXMuX3RpbWVPdXRJRCA9IHdpbmRvdy5zZXRUaW1lb3V0KHRoaXMuX29uTG9vcCwgdGhpcy5nYW1lLnRpbWUudGltZVRvQ2FsbCk7CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgdGhlIHJlcXVlc3RBbmltYXRpb25GcmFtZSBmcm9tIHJ1bm5pbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSNzdG9wCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5faXNTZXRUaW1lT3V0KQogICAgICAgIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVPdXRJRCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLl90aW1lT3V0SUQpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5pc1J1bm5pbmcgPSBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJcyB0aGUgYnJvd3NlciB1c2luZyBzZXRUaW1lb3V0PwogICAgKiBAbWV0aG9kIFBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUjaXNTZXRUaW1lT3V0CiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAgaXNTZXRUaW1lT3V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2lzU2V0VGltZU91dDsKICAgIH0sCgogICAgLyoqCiAgICAqIElzIHRoZSBicm93c2VyIHVzaW5nIHJlcXVlc3RBbmltYXRpb25GcmFtZT8KICAgICogQG1ldGhvZCBQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lI2lzUkFGCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAgaXNSQUY6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKHRoaXMuX2lzU2V0VGltZU91dCA9PT0gZmFsc2UpOwogICAgfQoKfTsKClBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZTsKCi8qIGpzaGludCBub2VtcHR5OiBmYWxzZSAqLwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IgY29uc3RydWN0b3IuCiogCiogQGNsYXNzIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yCiogQGNsYXNzZGVzYyBBbiBleHRyZW1lbHkgdXNlZnVsIHJlcGVhdGFibGUgcmFuZG9tIGRhdGEgZ2VuZXJhdG9yLiBBY2Nlc3MgaXQgdmlhIFBoYXNlci5HYW1lLnJuZAoqIEJhc2VkIG9uIE5vbnNlbnNlIGJ5IEpvc2ggRmF1bCBodHRwczovL2dpdGh1Yi5jb20vam9jYWZhL05vbnNlbnNlLgoqIFJhbmRvbSBudW1iZXIgZ2VuZXJhdG9yIGZyb20gaHR0cDovL2JhYWdvZS5vcmcvZW4vd2lraS9CZXR0ZXJfcmFuZG9tX251bWJlcnNfZm9yX2phdmFzY3JpcHQKKiAKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge2FycmF5fSBzZWVkcwoqLwpQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciA9IGZ1bmN0aW9uIChzZWVkcykgewogICAgCiAgICBpZiAodHlwZW9mIHNlZWRzID09PSAidW5kZWZpbmVkIikgeyBzZWVkcyA9IFtdOyB9CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjIC0gSW50ZXJuYWwgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuYyA9IDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzMCAtIEludGVybmFsIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLnMwID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHMxIC0gSW50ZXJuYWwgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuczEgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gczIgLSBJbnRlcm5hbCB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5zMiA9IDA7CgogICAgdGhpcy5zb3coc2VlZHMpOwoKfTsKClBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogUHJpdmF0ZSByYW5kb20gaGVscGVyLgogICAgKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI3JuZAogICAgKiBAcHJpdmF0ZQogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgcm5kOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciB0ID0gMjA5MTYzOSAqIHRoaXMuczAgKyB0aGlzLmMgKiAyLjMyODMwNjQzNjUzODY5NjNlLTEwOyAvLyAyXi0zMgoKICAgICAgICB0aGlzLmMgPSB0IHwgMDsKICAgICAgICB0aGlzLnMwID0gdGhpcy5zMTsKICAgICAgICB0aGlzLnMxID0gdGhpcy5zMjsKICAgICAgICB0aGlzLnMyID0gdCAtIHRoaXMuYzsKCiAgICAgICAgcmV0dXJuIHRoaXMuczI7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXNldCB0aGUgc2VlZCBvZiB0aGUgcmFuZG9tIGRhdGEgZ2VuZXJhdG9yLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNzb3cKICAgICogQHBhcmFtIHthcnJheX0gc2VlZHMKICAgICovCiAgICBzb3c6IGZ1bmN0aW9uIChzZWVkcykgewoKICAgICAgICBpZiAodHlwZW9mIHNlZWRzID09PSAidW5kZWZpbmVkIikgeyBzZWVkcyA9IFtdOyB9CgogICAgICAgIHRoaXMuczAgPSB0aGlzLmhhc2goJyAnKTsKICAgICAgICB0aGlzLnMxID0gdGhpcy5oYXNoKHRoaXMuczApOwogICAgICAgIHRoaXMuczIgPSB0aGlzLmhhc2godGhpcy5zMSk7CiAgICAgICAgdGhpcy5jID0gMTsKCiAgICAgICAgdmFyIHNlZWQ7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBzZWVkID0gc2VlZHNbaSsrXTsgKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zMCAtPSB0aGlzLmhhc2goc2VlZCk7CiAgICAgICAgICAgIHRoaXMuczAgKz0gfn4odGhpcy5zMCA8IDApOwogICAgICAgICAgICB0aGlzLnMxIC09IHRoaXMuaGFzaChzZWVkKTsKICAgICAgICAgICAgdGhpcy5zMSArPSB+fih0aGlzLnMxIDwgMCk7CiAgICAgICAgICAgIHRoaXMuczIgLT0gdGhpcy5oYXNoKHNlZWQpOwogICAgICAgICAgICB0aGlzLnMyICs9IH5+KHRoaXMuczIgPCAwKTsKICAgICAgICB9CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QgdGhhdCBjcmVhdGVzIGEgc2VlZCBoYXNoLgogICAgKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI2hhc2gKICAgICogQHBhcmFtIHtBbnl9IGRhdGEKICAgICogQHByaXZhdGUKICAgICogQHJldHVybiB7bnVtYmVyfSBoYXNoZWQgdmFsdWUuCiAgICAqLwogICAgaGFzaDogZnVuY3Rpb24gKGRhdGEpIHsKCiAgICAgICAgdmFyIGgsIGksIG47CiAgICAgICAgbiA9IDB4ZWZjODI0OWQ7CiAgICAgICAgZGF0YSA9IGRhdGEudG9TdHJpbmcoKTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgbiArPSBkYXRhLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgIGggPSAwLjAyNTE5NjAzMjgyNDE2OTM4ICogbjsKICAgICAgICAgICAgbiA9IGggPj4+IDA7CiAgICAgICAgICAgIGggLT0gbjsKICAgICAgICAgICAgaCAqPSBuOwogICAgICAgICAgICBuID0gaCA+Pj4gMDsKICAgICAgICAgICAgaCAtPSBuOwogICAgICAgICAgICBuICs9IGggKiAweDEwMDAwMDAwMDsvLyAyXjMyCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKG4gPj4+IDApICogMi4zMjgzMDY0MzY1Mzg2OTYzZS0xMDsvLyAyXi0zMgoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSByYW5kb20gaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDJeMzIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IjaW50ZWdlcgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IEEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiAwIGFuZCAyXjMyLgogICAgKi8KICAgIGludGVnZXI6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnJuZC5hcHBseSh0aGlzKSAqIDB4MTAwMDAwMDAwOy8vIDJeMzIKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSByYW5kb20gcmVhbCBudW1iZXIgYmV0d2VlbiAwIGFuZCAxLgogICAgKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI2ZyYWMKICAgICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSByZWFsIG51bWJlciBiZXR3ZWVuIDAgYW5kIDEuCiAgICAqLwogICAgZnJhYzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucm5kLmFwcGx5KHRoaXMpICsgKHRoaXMucm5kLmFwcGx5KHRoaXMpICogMHgyMDAwMDAgfCAwKSAqIDEuMTEwMjIzMDI0NjI1MTU2NWUtMTY7Ly8gMl4tNTMKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSByYW5kb20gcmVhbCBudW1iZXIgYmV0d2VlbiAwIGFuZCAyXjMyLgogICAgKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI3JlYWwKICAgICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSByZWFsIG51bWJlciBiZXR3ZWVuIDAgYW5kIDJeMzIuCiAgICAqLwogICAgcmVhbDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZWdlcigpICsgdGhpcy5mcmFjKCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNpbnRlZ2VySW5SYW5nZQogICAgKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gdmFsdWUgaW4gdGhlIHJhbmdlLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gdmFsdWUgaW4gdGhlIHJhbmdlLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IEEgcmFuZG9tIG51bWJlciBiZXR3ZWVuIG1pbiBhbmQgbWF4LgogICAgKi8KICAgIGludGVnZXJJblJhbmdlOiBmdW5jdGlvbiAobWluLCBtYXgpIHsKICAgICAgICByZXR1cm4gTWF0aC5mbG9vcih0aGlzLnJlYWxJblJhbmdlKG1pbiwgbWF4KSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgcmFuZG9tIHJlYWwgbnVtYmVyIGJldHdlZW4gbWluIGFuZCBtYXguCiAgICAqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IjcmVhbEluUmFuZ2UKICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIHZhbHVlIGluIHRoZSByYW5nZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIGluIHRoZSByYW5nZS4KICAgICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSBudW1iZXIgYmV0d2VlbiBtaW4gYW5kIG1heC4KICAgICovCiAgICByZWFsSW5SYW5nZTogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgogICAgICAgIHJldHVybiB0aGlzLmZyYWMoKSAqIChtYXggLSBtaW4pICsgbWluOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSByYW5kb20gcmVhbCBudW1iZXIgYmV0d2VlbiAtMSBhbmQgMS4KICAgICogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNub3JtYWwKICAgICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSByZWFsIG51bWJlciBiZXR3ZWVuIC0xIGFuZCAxLgogICAgKi8KICAgIG5vcm1hbDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAxIC0gMiAqIHRoaXMuZnJhYygpOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHZhbGlkIFJGQzQxMjIgdmVyc2lvbjQgSUQgaGV4IHN0cmluZyBmcm9tIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzEzMDgzNjgKICAgICogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciN1dWlkCiAgICAqIEByZXR1cm4ge3N0cmluZ30gQSB2YWxpZCBSRkM0MTIyIHZlcnNpb240IElEIGhleCBzdHJpbmcKICAgICovCiAgICB1dWlkOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBhID0gJyc7CiAgICAgICAgdmFyIGIgPSAnJzsKCiAgICAgICAgZm9yIChiID0gYSA9ICcnOyBhKysgPCAzNjsgYiArPX5hICUgNSB8IGEgKiAzJjQgPyAoYV4xNSA/IDhedGhpcy5mcmFjKCkgKiAoYV4yMCA/IDE2IDogNCkgOiA0KS50b1N0cmluZygxNikgOiAnLScpCiAgICAgICAgewogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGI7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHJhbmRvbSBtZW1iZXIgb2YgYGFycmF5YC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNwaWNrCiAgICAqIEBwYXJhbSB7QXJyYXl9IGFyeSAtIEFuIEFycmF5IHRvIHBpY2sgYSByYW5kb20gbWVtYmVyIG9mLgogICAgKiBAcmV0dXJuIHthbnl9IEEgcmFuZG9tIG1lbWJlciBvZiB0aGUgYXJyYXkuCiAgICAqLwogICAgcGljazogZnVuY3Rpb24gKGFyeSkgewogICAgICAgIHJldHVybiBhcnlbdGhpcy5pbnRlZ2VySW5SYW5nZSgwLCBhcnkubGVuZ3RoKV07CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgcmFuZG9tIG1lbWJlciBvZiBgYXJyYXlgLCBmYXZvcmluZyB0aGUgZWFybGllciBlbnRyaWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI3dlaWdodGVkUGljawogICAgKiBAcGFyYW0ge0FycmF5fSBhcnkgLSBBbiBBcnJheSB0byBwaWNrIGEgcmFuZG9tIG1lbWJlciBvZi4KICAgICogQHJldHVybiB7YW55fSBBIHJhbmRvbSBtZW1iZXIgb2YgdGhlIGFycmF5LgogICAgKi8KICAgIHdlaWdodGVkUGljazogZnVuY3Rpb24gKGFyeSkgewogICAgICAgIHJldHVybiBhcnlbfn4oTWF0aC5wb3codGhpcy5mcmFjKCksIDIpICogYXJ5Lmxlbmd0aCldOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHJhbmRvbSB0aW1lc3RhbXAgYmV0d2VlbiBtaW4gYW5kIG1heCwgb3IgYmV0d2VlbiB0aGUgYmVnaW5uaW5nIG9mIDIwMDAgYW5kIHRoZSBlbmQgb2YgMjAyMCBpZiBtaW4gYW5kIG1heCBhcmVuJ3Qgc3BlY2lmaWVkLgogICAgKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI3RpbWVzdGFtcAogICAgKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gdmFsdWUgaW4gdGhlIHJhbmdlLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gdmFsdWUgaW4gdGhlIHJhbmdlLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IEEgcmFuZG9tIHRpbWVzdGFtcCBiZXR3ZWVuIG1pbiBhbmQgbWF4LgogICAgKi8KICAgIHRpbWVzdGFtcDogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CiAgICAgICAgcmV0dXJuIHRoaXMucmVhbEluUmFuZ2UobWluIHx8IDk0NjY4NDgwMDAwMCwgbWF4IHx8IDE1Nzc4NjIwMDAwMDApOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHJhbmRvbSBhbmdsZSBiZXR3ZWVuIC0xODAgYW5kIDE4MC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNhbmdsZQogICAgKiBAcmV0dXJuIHtudW1iZXJ9IEEgcmFuZG9tIG51bWJlciBiZXR3ZWVuIC0xODAgYW5kIDE4MC4KICAgICovCiAgICBhbmdsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZWdlckluUmFuZ2UoLTE4MCwgMTgwKTsKICAgIH0KCn07CgpQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvcjsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgY29sbGVjdGlvbiBvZiBtYXRoZW1hdGljYWwgbWV0aG9kcy4KKgoqIEBjbGFzcyBQaGFzZXIuTWF0aAoqLwpQaGFzZXIuTWF0aCA9IHsKCiAgICAvKioKICAgICogPSAyICZwaTsKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNQSTIKICAgICovCiAgICBQSTI6IE1hdGguUEkgKiAyLAoKICAgIC8qKgogICAgKiBUd28gbnVtYmVyIGFyZSBmdXp6eUVxdWFsIGlmIHRoZWlyIGRpZmZlcmVuY2UgaXMgbGVzcyB0aGFuICZlcHNpbG9uOy4gCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZnV6enlFcXVhbAogICAgKiBAcGFyYW0ge251bWJlcn0gYQogICAgKiBAcGFyYW0ge251bWJlcn0gYgogICAgKiBAcGFyYW0ge251bWJlcn0gZXBzaWxvbiAKICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB8YS1ifDwmZXBzaWxvbjsKICAgICovCiAgICBmdXp6eUVxdWFsOiBmdW5jdGlvbiAoYSwgYiwgZXBzaWxvbikgewogICAgICAgIGlmICh0eXBlb2YgZXBzaWxvbiA9PT0gInVuZGVmaW5lZCIpIHsgZXBzaWxvbiA9IDAuMDAwMTsgfQogICAgICAgIHJldHVybiBNYXRoLmFicyhhIC0gYikgPCBlcHNpbG9uOwogICAgfSwKCiAgICAvKioKICAgICogYSBpcyBmdXp6eUxlc3NUaGFuIGIgaWYgaXQgaXMgbGVzcyB0aGFuIGIgKyAmZXBzaWxvbjsuIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2Z1enp5RXF1YWwKICAgICogQHBhcmFtIHtudW1iZXJ9IGEKICAgICogQHBhcmFtIHtudW1iZXJ9IGIKICAgICogQHBhcmFtIHtudW1iZXJ9IGVwc2lsb24gCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgYTxiKyZlcHNpbG9uOwogICAgKi8KICAgIGZ1enp5TGVzc1RoYW46IGZ1bmN0aW9uIChhLCBiLCBlcHNpbG9uKSB7CiAgICAgICAgaWYgKHR5cGVvZiBlcHNpbG9uID09PSAidW5kZWZpbmVkIikgeyBlcHNpbG9uID0gMC4wMDAxOyB9CiAgICAgICAgcmV0dXJuIGEgPCBiICsgZXBzaWxvbjsKICAgIH0sCgogICAgLyoqCiAgICAqIGEgaXMgZnV6enlHcmVhdGVyVGhhbiBiIGlmIGl0IGlzIG1vcmUgdGhhbiBiIC0gJmVwc2lsb247LiAgCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZnV6enlHcmVhdGVyVGhhbgogICAgKiBAcGFyYW0ge251bWJlcn0gYQogICAgKiBAcGFyYW0ge251bWJlcn0gYgogICAgKiBAcGFyYW0ge251bWJlcn0gZXBzaWxvbiAKICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBhPmIrJmVwc2lsb247CiAgICAqLwogICAgZnV6enlHcmVhdGVyVGhhbjogZnVuY3Rpb24gKGEsIGIsIGVwc2lsb24pIHsKICAgICAgICBpZiAodHlwZW9mIGVwc2lsb24gPT09ICJ1bmRlZmluZWQiKSB7IGVwc2lsb24gPSAwLjAwMDE7IH0KICAgICAgICByZXR1cm4gYSA+IGIgLSBlcHNpbG9uOwogICAgfSwKCiAgICAvKiogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZnV6enlDZWlsCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWwKICAgICogQHBhcmFtIHtudW1iZXJ9IGVwc2lsb24gCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IGNlaWxpbmcodmFsLSZlcHNpbG9uOykKICAgICovCiAgICBmdXp6eUNlaWw6IGZ1bmN0aW9uICh2YWwsIGVwc2lsb24pIHsKICAgICAgICBpZiAodHlwZW9mIGVwc2lsb24gPT09ICJ1bmRlZmluZWQiKSB7IGVwc2lsb24gPSAwLjAwMDE7IH0KICAgICAgICByZXR1cm4gTWF0aC5jZWlsKHZhbCAtIGVwc2lsb24pOwogICAgfSwKCiAgICAvKiogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZnV6enlGbG9vcgogICAgKiBAcGFyYW0ge251bWJlcn0gdmFsCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBlcHNpbG9uIAogICAgKiBAcmV0dXJuIHtib29sZWFufSBmbG9vcih2YWwtJmVwc2lsb247KQogICAgKi8KICAgIGZ1enp5Rmxvb3I6IGZ1bmN0aW9uICh2YWwsIGVwc2lsb24pIHsKICAgICAgICBpZiAodHlwZW9mIGVwc2lsb24gPT09ICJ1bmRlZmluZWQiKSB7IGVwc2lsb24gPSAwLjAwMDE7IH0KICAgICAgICByZXR1cm4gTWF0aC5mbG9vcih2YWwgKyBlcHNpbG9uKTsKICAgIH0sCgogICAgLyoqIAogICAgKiBBdmVyYWdlcyBhbGwgdmFsdWVzIHBhc3NlZCB0byB0aGUgZnVuY3Rpb24gYW5kIHJldHVybnMgdGhlIHJlc3VsdC4gWW91IGNhbiBwYXNzIGFzIG1hbnkgcGFyYW1ldGVycyBhcyB5b3UgbGlrZS4KICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNhdmVyYWdlCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGF2ZXJhZ2Ugb2YgYWxsIGdpdmVuIHZhbHVlcy4KICAgICovCiAgICBhdmVyYWdlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBhcmdzID0gW107CgogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCAoYXJndW1lbnRzLmxlbmd0aCAtIDApOyBfaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pICsgMF07CiAgICAgICAgfQoKICAgICAgICB2YXIgYXZnID0gMDsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGF2ZyArPSBhcmdzW2ldOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGF2ZyAvIGFyZ3MubGVuZ3RoOwoKICAgIH0sCgogICAgLyoqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3RydW5jYXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBuCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICB0cnVuY2F0ZTogZnVuY3Rpb24gKG4pIHsKICAgICAgICByZXR1cm4gKG4gPiAwKSA/IE1hdGguZmxvb3IobikgOiBNYXRoLmNlaWwobik7CiAgICB9LAoKICAgIC8qKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNzaGVhcgogICAgKiBAcGFyYW0ge251bWJlcn0gbgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IG4gbW9kIDEKICAgICovCiAgICBzaGVhcjogZnVuY3Rpb24gKG4pIHsKICAgICAgICByZXR1cm4gbiAlIDE7CiAgICB9LAoKICAgIC8qKgogICAgKiBTbmFwIGEgdmFsdWUgdG8gbmVhcmVzdCBncmlkIHNsaWNlLCB1c2luZyByb3VuZGluZy4KICAgICoKICAgICogRXhhbXBsZTogaWYgeW91IGhhdmUgYW4gaW50ZXJ2YWwgZ2FwIG9mIDUgYW5kIGEgcG9zaXRpb24gb2YgMTIuLi4geW91IHdpbGwgc25hcCB0byAxMCB3aGVyZWFzIDE0IHdpbGwgc25hcCB0byAxNS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNzbmFwVG8KICAgICogQHBhcmFtIHtudW1iZXJ9IGlucHV0IC0gVGhlIHZhbHVlIHRvIHNuYXAuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBnYXAgLSBUaGUgaW50ZXJ2YWwgZ2FwIG9mIHRoZSBncmlkLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3N0YXJ0XSAtIE9wdGlvbmFsIHN0YXJ0aW5nIG9mZnNldCBmb3IgZ2FwLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgc25hcFRvOiBmdW5jdGlvbiAoaW5wdXQsIGdhcCwgc3RhcnQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzdGFydCA9PT0gInVuZGVmaW5lZCIpIHsgc3RhcnQgPSAwOyB9CgogICAgICAgIGlmIChnYXAgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIGlucHV0OwogICAgICAgIH0KCiAgICAgICAgaW5wdXQgLT0gc3RhcnQ7CiAgICAgICAgaW5wdXQgPSBnYXAgKiBNYXRoLnJvdW5kKGlucHV0IC8gZ2FwKTsKCiAgICAgICAgcmV0dXJuIHN0YXJ0ICsgaW5wdXQ7CgogICAgfSwKCiAgICAvKioKICAgICogU25hcCBhIHZhbHVlIHRvIG5lYXJlc3QgZ3JpZCBzbGljZSwgdXNpbmcgZmxvb3IuCiAgICAqCiAgICAqIEV4YW1wbGU6IGlmIHlvdSBoYXZlIGFuIGludGVydmFsIGdhcCBvZiA1IGFuZCBhIHBvc2l0aW9uIG9mIDEyLi4uIHlvdSB3aWxsIHNuYXAgdG8gMTAuIEFzIHdpbGwgMTQgc25hcCB0byAxMC4uLiBidXQgMTYgd2lsbCBzbmFwIHRvIDE1CiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc25hcFRvRmxvb3IKICAgICogQHBhcmFtIHtudW1iZXJ9IGlucHV0IC0gVGhlIHZhbHVlIHRvIHNuYXAuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBnYXAgLSBUaGUgaW50ZXJ2YWwgZ2FwIG9mIHRoZSBncmlkLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3N0YXJ0XSAtIE9wdGlvbmFsIHN0YXJ0aW5nIG9mZnNldCBmb3IgZ2FwLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgc25hcFRvRmxvb3I6IGZ1bmN0aW9uIChpbnB1dCwgZ2FwLCBzdGFydCkgewoKICAgICAgICBpZiAodHlwZW9mIHN0YXJ0ID09PSAidW5kZWZpbmVkIikgeyBzdGFydCA9IDA7IH0KCiAgICAgICAgaWYgKGdhcCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gaW5wdXQ7CiAgICAgICAgfQoKICAgICAgICBpbnB1dCAtPSBzdGFydDsKICAgICAgICBpbnB1dCA9IGdhcCAqIE1hdGguZmxvb3IoaW5wdXQgLyBnYXApOwoKICAgICAgICByZXR1cm4gc3RhcnQgKyBpbnB1dDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTbmFwIGEgdmFsdWUgdG8gbmVhcmVzdCBncmlkIHNsaWNlLCB1c2luZyBjZWlsLgogICAgKgogICAgKiBFeGFtcGxlOiBpZiB5b3UgaGF2ZSBhbiBpbnRlcnZhbCBnYXAgb2YgNSBhbmQgYSBwb3NpdGlvbiBvZiAxMi4uLiB5b3Ugd2lsbCBzbmFwIHRvIDE1LiBBcyB3aWxsIDE0IHdpbGwgc25hcCB0byAxNS4uLiBidXQgMTYgd2lsbCBzbmFwIHRvIDIwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3NuYXBUb0NlaWwKICAgICogQHBhcmFtIHtudW1iZXJ9IGlucHV0IC0gVGhlIHZhbHVlIHRvIHNuYXAuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBnYXAgLSBUaGUgaW50ZXJ2YWwgZ2FwIG9mIHRoZSBncmlkLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3N0YXJ0XSAtIE9wdGlvbmFsIHN0YXJ0aW5nIG9mZnNldCBmb3IgZ2FwLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgc25hcFRvQ2VpbDogZnVuY3Rpb24gKGlucHV0LCBnYXAsIHN0YXJ0KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3RhcnQgPT09ICJ1bmRlZmluZWQiKSB7IHN0YXJ0ID0gMDsgfQoKICAgICAgICBpZiAoZ2FwID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBpbnB1dDsKICAgICAgICB9CgogICAgICAgIGlucHV0IC09IHN0YXJ0OwogICAgICAgIGlucHV0ID0gZ2FwICogTWF0aC5jZWlsKGlucHV0IC8gZ2FwKTsKCiAgICAgICAgcmV0dXJuIHN0YXJ0ICsgaW5wdXQ7CgogICAgfSwKCgogICAgLyoqCiAgICAqIFNuYXBzIGEgdmFsdWUgdG8gdGhlIG5lYXJlc3QgdmFsdWUgaW4gYW4gYXJyYXkuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc25hcFRvSW5BcnJheQogICAgKiBAcGFyYW0ge251bWJlcn0gaW5wdXQKICAgICogQHBhcmFtIHthcnJheX0gYXJyIAogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHNvcnQgLSBUcnVlIGlmIHRoZSBhcnJheSBuZWVkcyB0byBiZSBzb3J0ZWQuCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBzbmFwVG9JbkFycmF5OiBmdW5jdGlvbiAoaW5wdXQsIGFyciwgc29ydCkgewoKICAgICAgICBpZiAodHlwZW9mIHNvcnQgPT09ICJ1bmRlZmluZWQiKSB7IHNvcnQgPSB0cnVlOyB9CgogICAgICAgIGlmIChzb3J0KSB7CiAgICAgICAgICAgIGFyci5zb3J0KCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaW5wdXQgPCBhcnJbMF0pIHsKICAgICAgICAgICAgcmV0dXJuIGFyclswXTsKICAgICAgICB9CgogICAgICAgIHZhciBpID0gMTsKICAgICAgICAKICAgICAgICB3aGlsZSAoYXJyW2ldIDwgaW5wdXQpIHsKICAgICAgICAgICAgaSsrOwogICAgICAgIH0KCiAgICAgICAgdmFyIGxvdyA9IGFycltpIC0gMV07CiAgICAgICAgdmFyIGhpZ2ggPSAoaSA8IGFyci5sZW5ndGgpID8gYXJyW2ldIDogTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIAogICAgICAgIHJldHVybiAoKGhpZ2ggLSBpbnB1dCkgPD0gKGlucHV0IC0gbG93KSkgPyBoaWdoIDogbG93OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJvdW5kIHRvIHNvbWUgcGxhY2UgY29tcGFyYXRpdmUgdG8gYSAnYmFzZScsIGRlZmF1bHQgaXMgMTAgZm9yIGRlY2ltYWwgcGxhY2UuCiAgICAqCiAgICAqICdwbGFjZScgaXMgcmVwcmVzZW50ZWQgYnkgdGhlIHBvd2VyIGFwcGxpZWQgdG8gJ2Jhc2UnIHRvIGdldCB0aGF0IHBsYWNlCiAgICAqIGUuZy4KICAgICogMjAwMC83IH49IDI4NS43MTQyODU3MTQyODU3MTQyODU3MTQgfj0gKGJpbikxMDAwMTExMDEuMTAxMTAxMTAxMTAxMTAxMQogICAgKgogICAgKiByb3VuZFRvKDIwMDAvNywzKSA9PT0gMAogICAgKiByb3VuZFRvKDIwMDAvNywyKSA9PSAzMDAKICAgICogcm91bmRUbygyMDAwLzcsMSkgPT0gMjkwCiAgICAqIHJvdW5kVG8oMjAwMC83LDApID09IDI4NgogICAgKiByb3VuZFRvKDIwMDAvNywtMSkgPT0gMjg1LjcKICAgICogcm91bmRUbygyMDAwLzcsLTIpID09IDI4NS43MQogICAgKiByb3VuZFRvKDIwMDAvNywtMykgPT0gMjg1LjcxNAogICAgKiByb3VuZFRvKDIwMDAvNywtNCkgPT0gMjg1LjcxNDMKICAgICogcm91bmRUbygyMDAwLzcsLTUpID09IDI4NS43MTQyOQogICAgKgogICAgKiByb3VuZFRvKDIwMDAvNywzLDIpICA9PSAyODggICAgICAgLS0gMTAwMTAwMDAwCiAgICAqIHJvdW5kVG8oMjAwMC83LDIsMikgID09IDI4NCAgICAgICAtLSAxMDAwMTExMDAKICAgICogcm91bmRUbygyMDAwLzcsMSwyKSAgPT0gMjg2ICAgICAgIC0tIDEwMDAxMTExMAogICAgKiByb3VuZFRvKDIwMDAvNywwLDIpICA9PSAyODYgICAgICAgLS0gMTAwMDExMTEwCiAgICAqIHJvdW5kVG8oMjAwMC83LC0xLDIpID09IDI4NS41ICAgICAtLSAxMDAwMTExMDEuMQogICAgKiByb3VuZFRvKDIwMDAvNywtMiwyKSA9PSAyODUuNzUgICAgLS0gMTAwMDExMTAxLjExCiAgICAqIHJvdW5kVG8oMjAwMC83LC0zLDIpID09IDI4NS43NSAgICAtLSAxMDAwMTExMDEuMTEKICAgICogcm91bmRUbygyMDAwLzcsLTQsMikgPT0gMjg1LjY4NzUgIC0tIDEwMDAxMTEwMS4xMDExCiAgICAqIHJvdW5kVG8oMjAwMC83LC01LDIpID09IDI4NS43MTg3NSAtLSAxMDAwMTExMDEuMTAxMTEKICAgICoKICAgICogTm90ZSB3aGF0IG9jY3VycyB3aGVuIHdlIHJvdW5kIHRvIHRoZSAzcmQgc3BhY2UgKDh0aHMgcGxhY2UpLCAxMDAxMDAwMDAsIHRoaXMgaXMgdG8gYmUgYXNzdW1lZAogICAgKiBiZWNhdXNlIHdlIGFyZSByb3VuZGluZyAxMDAwMTEuMTAxMTAxMTAxMTAxMTAxMSB3aGljaCByb3VuZHMgdXAuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3JvdW5kVG8KICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIHJvdW5kLgogICAgKiBAcGFyYW0ge251bWJlcn0gcGxhY2UgLSBUaGUgcGxhY2UgdG8gcm91bmQgdG8uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBiYXNlIC0gVGhlIGJhc2UgdG8gcm91bmQgaW4uLi4gZGVmYXVsdCBpcyAxMCBmb3IgZGVjaW1hbC4KICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHJvdW5kVG86IGZ1bmN0aW9uICh2YWx1ZSwgcGxhY2UsIGJhc2UpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBwbGFjZSA9PT0gInVuZGVmaW5lZCIpIHsgcGxhY2UgPSAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiBiYXNlID09PSAidW5kZWZpbmVkIikgeyBiYXNlID0gMTA7IH0KICAgICAgICAKICAgICAgICB2YXIgcCA9IE1hdGgucG93KGJhc2UsIC1wbGFjZSk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQodmFsdWUgKiBwKSAvIHA7CgogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNmbG9vclRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byByb3VuZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHBsYWNlIC0gVGhlIHBsYWNlIHRvIHJvdW5kIHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0gYmFzZSAtIFRoZSBiYXNlIHRvIHJvdW5kIGluLi4uIGRlZmF1bHQgaXMgMTAgZm9yIGRlY2ltYWwuCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBmbG9vclRvOiBmdW5jdGlvbiAodmFsdWUsIHBsYWNlLCBiYXNlKSB7CgogICAgICAgIGlmICh0eXBlb2YgcGxhY2UgPT09ICJ1bmRlZmluZWQiKSB7IHBsYWNlID0gMDsgfQogICAgICAgIGlmICh0eXBlb2YgYmFzZSA9PT0gInVuZGVmaW5lZCIpIHsgYmFzZSA9IDEwOyB9CgogICAgICAgIHZhciBwID0gTWF0aC5wb3coYmFzZSwgLXBsYWNlKTsKCiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodmFsdWUgKiBwKSAvIHA7CgogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNjZWlsVG8KICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIHJvdW5kLgogICAgKiBAcGFyYW0ge251bWJlcn0gcGxhY2UgLSBUaGUgcGxhY2UgdG8gcm91bmQgdG8uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBiYXNlIC0gVGhlIGJhc2UgdG8gcm91bmQgaW4uLi4gZGVmYXVsdCBpcyAxMCBmb3IgZGVjaW1hbC4KICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIGNlaWxUbzogZnVuY3Rpb24gKHZhbHVlLCBwbGFjZSwgYmFzZSkgewoKICAgICAgICBpZiAodHlwZW9mIHBsYWNlID09PSAidW5kZWZpbmVkIikgeyBwbGFjZSA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIGJhc2UgPT09ICJ1bmRlZmluZWQiKSB7IGJhc2UgPSAxMDsgfQoKICAgICAgICB2YXIgcCA9IE1hdGgucG93KGJhc2UsIC1wbGFjZSk7CgogICAgICAgIHJldHVybiBNYXRoLmNlaWwodmFsdWUgKiBwKSAvIHA7CgogICAgfSwKCiAgICAvKioKICAgICogQSBvbmUgZGltZW5zaW9uYWwgbGluZWFyIGludGVycG9sYXRpb24gb2YgYSB2YWx1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNpbnRlcnBvbGF0ZUZsb2F0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBiCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3ZWlnaHQgCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBpbnRlcnBvbGF0ZUZsb2F0OiBmdW5jdGlvbiAoYSwgYiwgd2VpZ2h0KSB7CiAgICAgICAgcmV0dXJuIChiIC0gYSkgKiB3ZWlnaHQgKyBhOwogICAgfSwKCiAgICAvKioKICAgICogRmluZCB0aGUgYW5nbGUgb2YgYSBzZWdtZW50IGZyb20gKHgxLCB5MSkgLT4gKHgyLCB5MikuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjYW5nbGVCZXR3ZWVuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MQogICAgKiBAcGFyYW0ge251bWJlcn0geTEKICAgICogQHBhcmFtIHtudW1iZXJ9IHgyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgYW5nbGVCZXR3ZWVuOiBmdW5jdGlvbiAoeDEsIHkxLCB4MiwgeTIpIHsKICAgICAgICByZXR1cm4gTWF0aC5hdGFuMih5MiAtIHkxLCB4MiAtIHgxKTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldmVyc2VzIGFuIGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3JldmVyc2VBbmdsZQogICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGVSYWQgLSBUaGUgYW5nbGUgdG8gcmV2ZXJzZSwgaW4gcmFkaWFucy4KICAgICogQHJldHVybiB7bnVtYmVyfSBSZXR1cm5zIHRoZSByZXZlcnNlIGFuZ2xlLCBpbiByYWRpYW5zLgogICAgKi8KICAgIHJldmVyc2VBbmdsZTogZnVuY3Rpb24gKGFuZ2xlUmFkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplQW5nbGUoYW5nbGVSYWQgKyBNYXRoLlBJLCB0cnVlKTsKICAgIH0sCgogICAgLyoqCiAgICAqIE5vcm1hbGl6ZXMgYW4gYW5nbGUgdG8gdGhlIFswLDJwaSkgcmFuZ2UuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjbm9ybWFsaXplQW5nbGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlUmFkIC0gVGhlIGFuZ2xlIHRvIG5vcm1hbGl6ZSwgaW4gcmFkaWFucy4KICAgICogQHJldHVybiB7bnVtYmVyfSBSZXR1cm5zIHRoZSBhbmdsZSwgZml0IHdpdGhpbiB0aGUgWzAsMnBpXSByYW5nZSwgaW4gcmFkaWFucy4KICAgICovCiAgICBub3JtYWxpemVBbmdsZTogZnVuY3Rpb24gKGFuZ2xlUmFkKSB7CgogICAgICAgIGFuZ2xlUmFkID0gYW5nbGVSYWQgJSAoMiAqIE1hdGguUEkpOwogICAgICAgIHJldHVybiBhbmdsZVJhZCA+PSAwID8gYW5nbGVSYWQgOiBhbmdsZVJhZCArIDIgKiBNYXRoLlBJOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogTm9ybWFsaXplcyBhIGxhdGl0dWRlIHRvIHRoZSBbLTkwLDkwXSByYW5nZS4gTGF0aXR1ZGVzIGFib3ZlIDkwIG9yIGJlbG93IC05MCBhcmUgY2FwcGVkLCBub3Qgd3JhcHBlZC4KICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNub3JtYWxpemVMYXRpdHVkZQogICAgKiBAcGFyYW0ge251bWJlcn0gbGF0IC0gVGhlIGxhdGl0dWRlIHRvIG5vcm1hbGl6ZSwgaW4gZGVncmVlcy4KICAgICogQHJldHVybiB7bnVtYmVyfSBSZXR1cm5zIHRoZSBsYXRpdHVkZSwgZml0IHdpdGhpbiB0aGUgWy05MCw5MF0gcmFuZ2UuCiAgICAqLwogICAgbm9ybWFsaXplTGF0aXR1ZGU6IGZ1bmN0aW9uIChsYXQpIHsKICAgICAgICByZXR1cm4gTWF0aC5tYXgoLTkwLCBNYXRoLm1pbig5MCwgbGF0KSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBOb3JtYWxpemVzIGEgbG9uZ2l0dWRlIHRvIHRoZSBbLTE4MCwxODBdIHJhbmdlLiBMb25naXR1ZGVzIGFib3ZlIDE4MCBvciBiZWxvdyAtMTgwIGFyZSB3cmFwcGVkLgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI25vcm1hbGl6ZUxvbmdpdHVkZQogICAgKiBAcGFyYW0ge251bWJlcn0gbG5nIC0gVGhlIGxvbmdpdHVkZSB0byBub3JtYWxpemUsIGluIGRlZ3JlZXMuCiAgICAqIEByZXR1cm4ge251bWJlcn0gUmV0dXJucyB0aGUgbG9uZ2l0dWRlLCBmaXQgd2l0aGluIHRoZSBbLTE4MCwxODBdIHJhbmdlLgogICAgKi8KICAgIG5vcm1hbGl6ZUxvbmdpdHVkZTogZnVuY3Rpb24gKGxuZykgewoKICAgICAgICBpZiAobG5nICUgMzYwID09IDE4MCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAxODA7CiAgICAgICAgfQoKICAgICAgICBsbmcgPSBsbmcgJSAzNjA7CiAgICAgICAgcmV0dXJuIGxuZyA8IC0xODAgPyBsbmcgKyAzNjAgOiBsbmcgPiAxODAgPyBsbmcgLSAzNjAgOiBsbmc7CgogICAgfSwKCiAgICAvKioKICAgICogQ2xvc2VzdCBhbmdsZSBiZXR3ZWVuIHR3byBhbmdsZXMgZnJvbSBhMSB0byBhMiBhYnNvbHV0ZSB2YWx1ZSB0aGUgcmV0dXJuIGZvciBleGFjdCBhbmdsZQogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI25lYXJlc3RBbmdsZUJldHdlZW4KICAgICogQHBhcmFtIHtudW1iZXJ9IGExCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhMgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHJhZGlhbnMgLSBUcnVlIGlmIGFuZ2xlIHNpemVzIGFyZSBleHByZXNzZWQgaW4gcmFkaWFucy4KICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIG5lYXJlc3RBbmdsZUJldHdlZW46IGZ1bmN0aW9uIChhMSwgYTIsIHJhZGlhbnMpIHsKCiAgICAgICAgaWYgKHR5cGVvZiByYWRpYW5zID09PSAidW5kZWZpbmVkIikgeyByYWRpYW5zID0gdHJ1ZTsgfQoKICAgICAgICB2YXIgcmQgPSAocmFkaWFucykgPyBNYXRoLlBJIDogMTgwOwogICAgICAgIGExID0gdGhpcy5ub3JtYWxpemVBbmdsZShhMSwgcmFkaWFucyk7CiAgICAgICAgYTIgPSB0aGlzLm5vcm1hbGl6ZUFuZ2xlKGEyLCByYWRpYW5zKTsKICAgICAgICAKICAgICAgICBpZiAoYTEgPCAtcmQgLyAyICYmIGEyID4gcmQgLyAyKQogICAgICAgIHsKICAgICAgICAgICAgYTEgKz0gcmQgKiAyOwogICAgICAgIH0KCiAgICAgICAgaWYgKGEyIDwgLXJkIC8gMiAmJiBhMSA+IHJkIC8gMikKICAgICAgICB7CiAgICAgICAgICAgIGEyICs9IHJkICogMjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhMiAtIGExOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVycG9sYXRlIGFjcm9zcyB0aGUgc2hvcnRlc3QgYXJjIGJldHdlZW4gdHdvIGFuZ2xlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNpbnRlcnBvbGF0ZUFuZ2xlcwogICAgKiBAcGFyYW0ge251bWJlcn0gYTEgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IGEyIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3ZWlnaHQgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtib29sZWFufSByYWRpYW5zIC0gVHJ1ZSBpZiBhbmdsZSBzaXplcyBhcmUgZXhwcmVzc2VkIGluIHJhZGlhbnMuCiAgICAqIEBwYXJhbSB7RGVzY3JpcHRpb259IGVhc2UgLSBEZXNjcmlwdGlvbi4KICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIGludGVycG9sYXRlQW5nbGVzOiBmdW5jdGlvbiAoYTEsIGEyLCB3ZWlnaHQsIHJhZGlhbnMsIGVhc2UpIHsKCiAgICAgICAgaWYgKHR5cGVvZiByYWRpYW5zID09PSAidW5kZWZpbmVkIikgeyByYWRpYW5zID0gdHJ1ZTsgfQogICAgICAgIGlmICh0eXBlb2YgZWFzZSA9PT0gInVuZGVmaW5lZCIpIHsgZWFzZSA9IG51bGw7IH0KCiAgICAgICAgYTEgPSB0aGlzLm5vcm1hbGl6ZUFuZ2xlKGExLCByYWRpYW5zKTsKICAgICAgICBhMiA9IHRoaXMubm9ybWFsaXplQW5nbGVUb0Fub3RoZXIoYTIsIGExLCByYWRpYW5zKTsKCiAgICAgICAgcmV0dXJuICh0eXBlb2YgZWFzZSA9PT0gJ2Z1bmN0aW9uJykgPyBlYXNlKHdlaWdodCwgYTEsIGEyIC0gYTEsIDEpIDogdGhpcy5pbnRlcnBvbGF0ZUZsb2F0KGExLCBhMiwgd2VpZ2h0KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZW5lcmF0ZSBhIHJhbmRvbSBib29sIHJlc3VsdCBiYXNlZCBvbiB0aGUgY2hhbmNlIHZhbHVlLgogICAgKiA8cD4KICAgICogUmV0dXJucyB0cnVlIG9yIGZhbHNlIGJhc2VkIG9uIHRoZSBjaGFuY2UgdmFsdWUgKGRlZmF1bHQgNTAlKS4gRm9yIGV4YW1wbGUgaWYgeW91IHdhbnRlZCBhIHBsYXllciB0byBoYXZlIGEgMzAlIGNoYW5jZQogICAgKiBvZiBnZXR0aW5nIGEgYm9udXMsIGNhbGwgY2hhbmNlUm9sbCgzMCkgLSB0cnVlIG1lYW5zIHRoZSBjaGFuY2UgcGFzc2VkLCBmYWxzZSBtZWFucyBpdCBmYWlsZWQuCiAgICAqIDwvcD4KICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNjaGFuY2VSb2xsCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjaGFuY2UgLSBUaGUgY2hhbmNlIG9mIHJlY2VpdmluZyB0aGUgdmFsdWUuIEEgbnVtYmVyIGJldHdlZW4gMCBhbmQgMTAwIChlZmZlY3RpdmVseSAwJSB0byAxMDAlKS4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgcm9sbCBwYXNzZWQsIG9yIGZhbHNlIG90aGVyd2lzZS4KICAgICovCiAgICBjaGFuY2VSb2xsOiBmdW5jdGlvbiAoY2hhbmNlKSB7CgogICAgICAgIGlmICh0eXBlb2YgY2hhbmNlID09PSAidW5kZWZpbmVkIikgeyBjaGFuY2UgPSA1MDsgfQogICAgICAgIAogICAgICAgIGlmIChjaGFuY2UgPD0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoY2hhbmNlID49IDEwMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSAqIDEwMCA+PSBjaGFuY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYW4gQXJyYXkgY29udGFpbmluZyB0aGUgbnVtYmVycyBmcm9tIG1pbiB0byBtYXggKGluY2x1c2l2ZSkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjbnVtYmVyQXJyYXkKICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIHZhbHVlIHRoZSBhcnJheSBzdGFydHMgd2l0aC4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIHRoZSBhcnJheSBjb250YWlucy4KICAgICogQHJldHVybiB7YXJyYXl9IFRoZSBhcnJheSBvZiBudW1iZXIgdmFsdWVzLgogICAgKi8KICAgIG51bWJlckFycmF5OiBmdW5jdGlvbiAobWluLCBtYXgpIHsKCiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwoKICAgICAgICBmb3IgKHZhciBpID0gbWluOyBpIDw9IG1heDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0LnB1c2goaSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgdGhlIGdpdmVuIGFtb3VudCB0byB0aGUgdmFsdWUsIGJ1dCBuZXZlciBsZXRzIHRoZSB2YWx1ZSBnbyBvdmVyIHRoZSBzcGVjaWZpZWQgbWF4aW11bS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNtYXhBZGQKICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIGFkZCB0aGUgYW1vdW50IHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0gYW1vdW50IC0gVGhlIGFtb3VudCB0byBhZGQgdG8gdGhlIHZhbHVlLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4LSBUaGUgbWF4aW11bSB0aGUgdmFsdWUgaXMgYWxsb3dlZCB0byBiZS4KICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIG1heEFkZDogZnVuY3Rpb24gKHZhbHVlLCBhbW91bnQsIG1heCkgewoKICAgICAgICB2YWx1ZSArPSBhbW91bnQ7CgogICAgICAgIGlmICh2YWx1ZSA+IG1heCkKICAgICAgICB7CiAgICAgICAgICAgIHZhbHVlID0gbWF4OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4gYW1vdW50IGZyb20gdGhlIHZhbHVlLCBidXQgbmV2ZXIgbGV0cyB0aGUgdmFsdWUgZ28gYmVsb3cgdGhlIHNwZWNpZmllZCBtaW5pbXVtLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI21pblN1YgogICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgYmFzZSB2YWx1ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gc3VidHJhY3QgZnJvbSB0aGUgYmFzZSB2YWx1ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIHRoZSB2YWx1ZSBpcyBhbGxvd2VkIHRvIGJlLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBuZXcgdmFsdWUuCiAgICAqLwogICAgbWluU3ViOiBmdW5jdGlvbiAodmFsdWUsIGFtb3VudCwgbWluKSB7CgogICAgICAgIHZhbHVlIC09IGFtb3VudDsKICAgICAgICAKICAgICAgICBpZiAodmFsdWUgPCBtaW4pCiAgICAgICAgewogICAgICAgICAgICB2YWx1ZSA9IG1pbjsKICAgICAgICB9CgogICAgICAgIHJldHVybiB2YWx1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBFbnN1cmVzIHRoYXQgdGhlIHZhbHVlIGFsd2F5cyBzdGF5cyBiZXR3ZWVuIG1pbiBhbmQgbWF4LCBieSB3cmFwcGluZyB0aGUgdmFsdWUgYXJvdW5kLgogICAgKiBtYXggc2hvdWxkIGJlIGxhcmdlciB0aGFuIG1pbiwgb3IgdGhlIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIDAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjd3JhcAogICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gd3JhcC4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIHRoZSB2YWx1ZSBpcyBhbGxvd2VkIHRvIGJlLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gdGhlIHZhbHVlIGlzIGFsbG93ZWQgdG8gYmUuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHdyYXBwZWQgdmFsdWUuCiAgICAqLwogICAgd3JhcDogZnVuY3Rpb24gKHZhbHVlLCBtaW4sIG1heCkgewoKICAgICAgICB2YXIgcmFuZ2UgPSBtYXggLSBtaW47CgogICAgICAgIGlmIChyYW5nZSA8PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVzdWx0ID0gKHZhbHVlIC0gbWluKSAlIHJhbmdlOwoKICAgICAgICBpZiAocmVzdWx0IDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCArPSByYW5nZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJlc3VsdCArIG1pbjsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIHZhbHVlIHRvIGFtb3VudCBhbmQgZW5zdXJlcyB0aGF0IHRoZSByZXN1bHQgYWx3YXlzIHN0YXlzIGJldHdlZW4gMCBhbmQgbWF4LCBieSB3cmFwcGluZyB0aGUgdmFsdWUgYXJvdW5kLgogICAgKiA8cD5WYWx1ZXMgbXVzdCBiZSBwb3NpdGl2ZSBpbnRlZ2VycywgYW5kIGFyZSBwYXNzZWQgdGhyb3VnaCBNYXRoLmFiczwvcD4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCN3cmFwVmFsdWUKICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIGFkZCB0aGUgYW1vdW50IHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0gYW1vdW50IC0gVGhlIGFtb3VudCB0byBhZGQgdG8gdGhlIHZhbHVlLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gdGhlIHZhbHVlIGlzIGFsbG93ZWQgdG8gYmUuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHdyYXBwZWQgdmFsdWUuCiAgICAqLwogICAgd3JhcFZhbHVlOiBmdW5jdGlvbiAodmFsdWUsIGFtb3VudCwgbWF4KSB7CgogICAgICAgIHZhciBkaWZmOwogICAgICAgIHZhbHVlID0gTWF0aC5hYnModmFsdWUpOwogICAgICAgIGFtb3VudCA9IE1hdGguYWJzKGFtb3VudCk7CiAgICAgICAgbWF4ID0gTWF0aC5hYnMobWF4KTsKICAgICAgICBkaWZmID0gKHZhbHVlICsgYW1vdW50KSAlIG1heDsKCiAgICAgICAgcmV0dXJuIGRpZmY7CgogICAgfSwKCiAgICAvKioKICAgICogUmFuZG9tbHkgcmV0dXJucyBlaXRoZXIgYSAxIG9yIC0xLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3JhbmRvbVNpZ24KICAgICogQHJldHVybiB7bnVtYmVyfSAgMSBvciAtMQogICAgKi8KICAgIHJhbmRvbVNpZ246IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKE1hdGgucmFuZG9tKCkgPiAwLjUpID8gMSA6IC0xOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBudW1iZXIgZ2l2ZW4gaXMgb2RkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2lzT2RkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBuIC0gVGhlIG51bWJlciB0byBjaGVjay4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gbnVtYmVyIGlzIG9kZC4gRmFsc2UgaWYgdGhlIGdpdmVuIG51bWJlciBpcyBldmVuLgogICAgKi8KICAgIGlzT2RkOiBmdW5jdGlvbiAobikgewoKICAgICAgICByZXR1cm4gKG4gJiAxKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIG51bWJlciBnaXZlbiBpcyBldmVuLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2lzRXZlbgogICAgKiBAcGFyYW0ge251bWJlcn0gbiAtIFRoZSBudW1iZXIgdG8gY2hlY2suCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIG51bWJlciBpcyBldmVuLiBGYWxzZSBpZiB0aGUgZ2l2ZW4gbnVtYmVyIGlzIG9kZC4KICAgICovCiAgICBpc0V2ZW46IGZ1bmN0aW9uIChuKSB7CgogICAgICAgIGlmIChuICYgMSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNpZ25pZmljYW50bHkgZmFzdGVyIHZlcnNpb24gb2YgTWF0aC5tYXgKICAgICogU2VlIGh0dHA6Ly9qc3BlcmYuY29tL21hdGgtcy1taW4tbWF4LXZzLWhvbWVtYWRlLzUKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNtYXgKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgaGlnaGVzdCB2YWx1ZSBmcm9tIHRob3NlIGdpdmVuLgogICAgKi8KICAgIG1heDogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBpID0gMSwgbWF4ID0gMCwgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGFyZ3VtZW50c1ttYXhdIDwgYXJndW1lbnRzW2ldKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXggPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiBhcmd1bWVudHNbbWF4XTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGVkIHZlcnNpb24gb2YgTWF0aC5taW4gdGhhdCBjYW4gYmUgcGFzc2VkIGVpdGhlciBhbiBhcnJheSBvZiBudW1iZXJzIG9yIHRoZSBudW1iZXJzIGFzIHBhcmFtZXRlcnMuCiAgICAqIFNlZSBodHRwOi8vanNwZXJmLmNvbS9tYXRoLXMtbWluLW1heC12cy1ob21lbWFkZS81CiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjbWluCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxvd2VzdCB2YWx1ZSBmcm9tIHRob3NlIGdpdmVuLgogICAgKi8KICAgIG1pbjogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzBdID09PSAnb2JqZWN0JykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkYXRhID0gYXJndW1lbnRzWzBdOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB2YXIgZGF0YSA9IGFyZ3VtZW50czsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAxLCBtaW4gPSAwLCBsZW4gPSBkYXRhLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGRhdGFbaV0gPCBkYXRhW21pbl0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1pbiA9IGk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBkYXRhW21pbl07CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlZCB2ZXJzaW9uIG9mIE1hdGgubWF4IHRoYXQgY2FuIGJlIHBhc3NlZCBlaXRoZXIgYW4gYXJyYXkgb2YgbnVtYmVycyBvciB0aGUgbnVtYmVycyBhcyBwYXJhbWV0ZXJzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI21heAogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsYXJnZXN0IHZhbHVlIGZyb20gdGhvc2UgZ2l2ZW4uCiAgICAqLwogICAgbWF4OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICdvYmplY3QnKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGRhdGEgPSBhcmd1bWVudHNbMF07CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkYXRhID0gYXJndW1lbnRzOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDEsIG1heCA9IDAsIGxlbiA9IGRhdGEubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAoZGF0YVtpXSA+IGRhdGFbbWF4XSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWF4ID0gaTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGFbbWF4XTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGVkIHZlcnNpb24gb2YgTWF0aC5taW4gdGhhdCBjYW4gYmUgcGFzc2VkIGEgcHJvcGVydHkgYW5kIGVpdGhlciBhbiBhcnJheSBvZiBvYmplY3RzIG9yIHRoZSBvYmplY3RzIGFzIHBhcmFtZXRlcnMuCiAgICAqIEl0IHdpbGwgZmluZCB0aGUgbG93ZXN0IG1hdGNoaW5nIHByb3BlcnR5IHZhbHVlIGZyb20gdGhlIGdpdmVuIG9iamVjdHMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjbWluUHJvcGVydHkKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbG93ZXN0IHZhbHVlIGZyb20gdGhvc2UgZ2l2ZW4uCiAgICAqLwogICAgbWluUHJvcGVydHk6IGZ1bmN0aW9uIChwcm9wZXJ0eSkgewoKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiB0eXBlb2YgYXJndW1lbnRzWzFdID09PSAnb2JqZWN0JykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkYXRhID0gYXJndW1lbnRzWzFdOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB2YXIgZGF0YSA9IGFyZ3VtZW50cy5zbGljZSgxKTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAxLCBtaW4gPSAwLCBsZW4gPSBkYXRhLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGRhdGFbaV1bcHJvcGVydHldIDwgZGF0YVttaW5dW3Byb3BlcnR5XSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWluID0gaTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGFbbWluXVtwcm9wZXJ0eV07CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlZCB2ZXJzaW9uIG9mIE1hdGgubWF4IHRoYXQgY2FuIGJlIHBhc3NlZCBhIHByb3BlcnR5IGFuZCBlaXRoZXIgYW4gYXJyYXkgb2Ygb2JqZWN0cyBvciB0aGUgb2JqZWN0cyBhcyBwYXJhbWV0ZXJzLgogICAgKiBJdCB3aWxsIGZpbmQgdGhlIGxhcmdlc3QgbWF0Y2hpbmcgcHJvcGVydHkgdmFsdWUgZnJvbSB0aGUgZ2l2ZW4gb2JqZWN0cy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNtYXhQcm9wZXJ0eQogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsYXJnZXN0IHZhbHVlIGZyb20gdGhvc2UgZ2l2ZW4uCiAgICAqLwogICAgbWF4UHJvcGVydHk6IGZ1bmN0aW9uIChwcm9wZXJ0eSkgewoKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiB0eXBlb2YgYXJndW1lbnRzWzFdID09PSAnb2JqZWN0JykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBkYXRhID0gYXJndW1lbnRzWzFdOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB2YXIgZGF0YSA9IGFyZ3VtZW50cy5zbGljZSgxKTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAxLCBtYXggPSAwLCBsZW4gPSBkYXRhLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGRhdGFbaV1bcHJvcGVydHldID4gZGF0YVttYXhdW3Byb3BlcnR5XSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWF4ID0gaTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGFbbWF4XVtwcm9wZXJ0eV07CgogICAgfSwKCiAgICAvKioKICAgICogS2VlcHMgYW4gYW5nbGUgdmFsdWUgYmV0d2VlbiAtMTgwIGFuZCArMTgwPGJyPgogICAgKiBTaG91bGQgYmUgY2FsbGVkIHdoZW5ldmVyIHRoZSBhbmdsZSBpcyB1cGRhdGVkIG9uIHRoZSBTcHJpdGUgdG8gc3RvcCBpdCBmcm9tIGdvaW5nIGluc2FuZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCN3cmFwQW5nbGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIHZhbHVlIHRvIGNoZWNrCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG5ldyBhbmdsZSB2YWx1ZSwgcmV0dXJucyB0aGUgc2FtZSBhcyB0aGUgaW5wdXQgYW5nbGUgaWYgaXQgd2FzIHdpdGhpbiBib3VuZHMuCiAgICAqLwogICAgd3JhcEFuZ2xlOiBmdW5jdGlvbiAoYW5nbGUpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMud3JhcChhbmdsZSwgLTE4MCwgMTgwKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBLZWVwcyBhbiBhbmdsZSB2YWx1ZSBiZXR3ZWVuIHRoZSBnaXZlbiBtaW4gYW5kIG1heCB2YWx1ZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjYW5nbGVMaW1pdAogICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgdmFsdWUgdG8gY2hlY2suIE11c3QgYmUgYmV0d2VlbiAtMTgwIGFuZCArMTgwLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gYW5nbGUgdGhhdCBpcyBhbGxvd2VkIChtdXN0IGJlIC0xODAgb3IgZ3JlYXRlcikuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYXggLSBUaGUgbWF4aW11bSBhbmdsZSB0aGF0IGlzIGFsbG93ZWQgKG11c3QgYmUgMTgwIG9yIGxlc3MpLgogICAgKgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBuZXcgYW5nbGUgdmFsdWUsIHJldHVybnMgdGhlIHNhbWUgYXMgdGhlIGlucHV0IGFuZ2xlIGlmIGl0IHdhcyB3aXRoaW4gYm91bmRzCiAgICAqLwogICAgYW5nbGVMaW1pdDogZnVuY3Rpb24gKGFuZ2xlLCBtaW4sIG1heCkgewoKICAgICAgICB2YXIgcmVzdWx0ID0gYW5nbGU7CgogICAgICAgIGlmIChhbmdsZSA+IG1heCkKICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA9IG1heDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYW5nbGUgPCBtaW4pCiAgICAgICAgewogICAgICAgICAgICByZXN1bHQgPSBtaW47CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEEgTGluZWFyIEludGVycG9sYXRpb24gTWV0aG9kLCBtb3N0bHkgdXNlZCBieSBQaGFzZXIuVHdlZW4uCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjbGluZWFySW50ZXJwb2xhdGlvbgogICAgKiBAcGFyYW0ge251bWJlcn0gdgogICAgKiBAcGFyYW0ge251bWJlcn0gawogICAgKiBAcmV0dXJuIHtudW1iZXJ9IAogICAgKi8KICAgIGxpbmVhckludGVycG9sYXRpb246IGZ1bmN0aW9uICh2LCBrKSB7CgogICAgICAgIHZhciBtID0gdi5sZW5ndGggLSAxOwogICAgICAgIHZhciBmID0gbSAqIGs7CiAgICAgICAgdmFyIGkgPSBNYXRoLmZsb29yKGYpOwoKICAgICAgICBpZiAoayA8IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5saW5lYXIodlswXSwgdlsxXSwgZik7CiAgICAgICAgfQoKICAgICAgICBpZiAoayA+IDEpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5saW5lYXIodlttXSwgdlttIC0gMV0sIG0gLSBmKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmxpbmVhcih2W2ldLCB2W2kgKyAxID4gbSA/IG0gOiBpICsgMV0sIGYgLSBpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIEJlemllciBJbnRlcnBvbGF0aW9uIE1ldGhvZCwgbW9zdGx5IHVzZWQgYnkgUGhhc2VyLlR3ZWVuLgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2JlemllckludGVycG9sYXRpb24KICAgICogQHBhcmFtIHtudW1iZXJ9IHYKICAgICogQHBhcmFtIHtudW1iZXJ9IGsKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIGJlemllckludGVycG9sYXRpb246IGZ1bmN0aW9uICh2LCBrKSB7CgogICAgICAgIHZhciBiID0gMDsKICAgICAgICB2YXIgbiA9IHYubGVuZ3RoIC0gMTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPD0gbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgYiArPSBNYXRoLnBvdygxIC0gaywgbiAtIGkpICogTWF0aC5wb3coaywgaSkgKiB2W2ldICogdGhpcy5iZXJuc3RlaW4obiwgaSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYjsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIENhdG11bGwgUm9tIEludGVycG9sYXRpb24gTWV0aG9kLCBtb3N0bHkgdXNlZCBieSBQaGFzZXIuVHdlZW4uCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjY2F0bXVsbFJvbUludGVycG9sYXRpb24KICAgICogQHBhcmFtIHtudW1iZXJ9IHYKICAgICogQHBhcmFtIHtudW1iZXJ9IGsKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIGNhdG11bGxSb21JbnRlcnBvbGF0aW9uOiBmdW5jdGlvbiAodiwgaykgewoKICAgICAgICB2YXIgbSA9IHYubGVuZ3RoIC0gMTsKICAgICAgICB2YXIgZiA9IG0gKiBrOwogICAgICAgIHZhciBpID0gTWF0aC5mbG9vcihmKTsKCiAgICAgICAgaWYgKHZbMF0gPT09IHZbbV0pCiAgICAgICAgewogICAgICAgICAgICBpZiAoayA8IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGkgPSBNYXRoLmZsb29yKGYgPSBtICogKDEgKyBrKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzLmNhdG11bGxSb20odlsoaSAtIDEgKyBtKSAlIG1dLCB2W2ldLCB2WyhpICsgMSkgJSBtXSwgdlsoaSArIDIpICUgbV0sIGYgLSBpKTsKCiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmIChrIDwgMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHZbMF0gLSAodGhpcy5jYXRtdWxsUm9tKHZbMF0sIHZbMF0sIHZbMV0sIHZbMV0sIC1mKSAtIHZbMF0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoayA+IDEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB2W21dIC0gKHRoaXMuY2F0bXVsbFJvbSh2W21dLCB2W21dLCB2W20gLSAxXSwgdlttIC0gMV0sIGYgLSBtKSAtIHZbbV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRtdWxsUm9tKHZbaSA/IGkgLSAxIDogMF0sIHZbaV0sIHZbbSA8IGkgKyAxID8gbSA6IGkgKyAxXSwgdlttIDwgaSArIDIgPyBtIDogaSArIDJdLCBmIC0gaSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI0xpbmVhcgogICAgKiBAcGFyYW0ge251bWJlcn0gcDAKICAgICogQHBhcmFtIHtudW1iZXJ9IHAxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0CiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBsaW5lYXI6IGZ1bmN0aW9uIChwMCwgcDEsIHQpIHsKICAgICAgICByZXR1cm4gKHAxIC0gcDApICogdCArIHAwOwogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNiZXJuc3RlaW4KICAgICogQHBhcmFtIHtudW1iZXJ9IG4KICAgICogQHBhcmFtIHtudW1iZXJ9IGkKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIGJlcm5zdGVpbjogZnVuY3Rpb24gKG4sIGkpIHsKICAgICAgICByZXR1cm4gdGhpcy5mYWN0b3JpYWwobikgLyB0aGlzLmZhY3RvcmlhbChpKSAvIHRoaXMuZmFjdG9yaWFsKG4gLSBpKTsKICAgIH0sCgogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2NhdG11bGxSb20KICAgICogQHBhcmFtIHtudW1iZXJ9IHAwCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBwMQogICAgKiBAcGFyYW0ge251bWJlcn0gcDIKICAgICogQHBhcmFtIHtudW1iZXJ9IHAzCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0CiAgICAqIEByZXR1cm4ge251bWJlcn0gCiAgICAqLwogICAgY2F0bXVsbFJvbTogZnVuY3Rpb24gKHAwLCBwMSwgcDIsIHAzLCB0KSB7CgogICAgICAgIHZhciB2MCA9IChwMiAtIHAwKSAqIDAuNSwgdjEgPSAocDMgLSBwMSkgKiAwLjUsIHQyID0gdCAqIHQsIHQzID0gdCAqIHQyOwoKICAgICAgICByZXR1cm4gKDIgKiBwMSAtIDIgKiBwMiArIHYwICsgdjEpICogdDMgKyAoLTMgKiBwMSArIDMgKiBwMiAtIDIgKiB2MCAtIHYxKSAqIHQyICsgdjAgKiB0ICsgcDE7CgogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNkaWZmZXJlbmNlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBiCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBkaWZmZXJlbmNlOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHJldHVybiBNYXRoLmFicyhhIC0gYik7CiAgICB9LAoKICAgIC8qKgogICAgKiBGZXRjaCBhIHJhbmRvbSBlbnRyeSBmcm9tIHRoZSBnaXZlbiBhcnJheS4KICAgICogV2lsbCByZXR1cm4gbnVsbCBpZiByYW5kb20gc2VsZWN0aW9uIGlzIG1pc3NpbmcsIG9yIGFycmF5IGhhcyBubyBlbnRyaWVzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2dldFJhbmRvbQogICAgKiBAcGFyYW0ge2FycmF5fSBvYmplY3RzIC0gQW4gYXJyYXkgb2Ygb2JqZWN0cy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0SW5kZXggLSBPcHRpb25hbCBvZmZzZXQgb2ZmIHRoZSBmcm9udCBvZiB0aGUgYXJyYXkuIERlZmF1bHQgdmFsdWUgaXMgMCwgb3IgdGhlIGJlZ2lubmluZyBvZiB0aGUgYXJyYXkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBsZW5ndGggLSBPcHRpb25hbCByZXN0cmljdGlvbiBvbiB0aGUgbnVtYmVyIG9mIHZhbHVlcyB5b3Ugd2FudCB0byByYW5kb21seSBzZWxlY3QgZnJvbS4KICAgICogQHJldHVybiB7b2JqZWN0fSBUaGUgcmFuZG9tIG9iamVjdCB0aGF0IHdhcyBzZWxlY3RlZC4KICAgICovCiAgICBnZXRSYW5kb206IGZ1bmN0aW9uIChvYmplY3RzLCBzdGFydEluZGV4LCBsZW5ndGgpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzdGFydEluZGV4ID09PSAidW5kZWZpbmVkIikgeyBzdGFydEluZGV4ID0gMDsgfQogICAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09PSAidW5kZWZpbmVkIikgeyBsZW5ndGggPSAwOyB9CiAgICAgICAgCiAgICAgICAgaWYgKG9iamVjdHMgIT0gbnVsbCkgewoKICAgICAgICAgICAgdmFyIGwgPSBsZW5ndGg7CgogICAgICAgICAgICBpZiAoKGwgPT09IDApIHx8IChsID4gb2JqZWN0cy5sZW5ndGggLSBzdGFydEluZGV4KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbCA9IG9iamVjdHMubGVuZ3RoIC0gc3RhcnRJbmRleDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGwgPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0c1tzdGFydEluZGV4ICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbCldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSb3VuZCBkb3duIHRvIHRoZSBuZXh0IHdob2xlIG51bWJlci4gRS5nLiBmbG9vcigxLjcpID09IDEsIGFuZCBmbG9vcigtMi43KSA9PSAtMi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNmbG9vcgogICAgKiBAcGFyYW0ge251bWJlcn0gVmFsdWUgQW55IG51bWJlci4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgcm91bmRlZCB2YWx1ZSBvZiB0aGF0IG51bWJlci4KICAgICovCiAgICBmbG9vcjogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHZhciBuID0gdmFsdWUgfCAwOwoKICAgICAgICByZXR1cm4gKHZhbHVlID4gMCkgPyAobikgOiAoKG4gIT0gdmFsdWUpID8gKG4gLSAxKSA6IChuKSk7CgogICAgfSwKCiAgICAvKioKICAgICogUm91bmQgdXAgdG8gdGhlIG5leHQgd2hvbGUgbnVtYmVyLiAgRS5nLiBjZWlsKDEuMykgPT0gMiwgYW5kIGNlaWwoLTIuMykgPT0gLTMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjY2VpbAogICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBBbnkgbnVtYmVyLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSByb3VuZGVkIHZhbHVlIG9mIHRoYXQgbnVtYmVyLgogICAgKi8KICAgIGNlaWw6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHZhciBuID0gdmFsdWUgfCAwOwogICAgICAgIHJldHVybiAodmFsdWUgPiAwKSA/ICgobiAhPSB2YWx1ZSkgPyAobiArIDEpIDogKG4pKSA6IChuKTsKICAgIH0sCgogICAgLyoqCiAgICAqIEdlbmVyYXRlIGEgc2luZSBhbmQgY29zaW5lIHRhYmxlIHNpbXVsdGFuZW91c2x5IGFuZCBleHRyZW1lbHkgcXVpY2tseS4gQmFzZWQgb24gcmVzZWFyY2ggYnkgRnJhbmt5IG9mIHNjZW5lLmF0CiAgICAqIDxwPgogICAgKiBUaGUgcGFyYW1ldGVycyBhbGxvdyB5b3UgdG8gc3BlY2lmeSB0aGUgbGVuZ3RoLCBhbXBsaXR1ZGUgYW5kIGZyZXF1ZW5jeSBvZiB0aGUgd2F2ZS4gT25jZSB5b3UgaGF2ZSBjYWxsZWQgdGhpcyBmdW5jdGlvbgogICAgKiB5b3Ugc2hvdWxkIGdldCB0aGUgcmVzdWx0cyB2aWEgZ2V0U2luVGFibGUoKSBhbmQgZ2V0Q29zVGFibGUoKS4gVGhpcyBnZW5lcmF0b3IgaXMgZmFzdCBlbm91Z2ggdG8gYmUgdXNlZCBpbiByZWFsLXRpbWUuCiAgICAqIDwvcD4KICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNzaW5Db3NHZW5lcmF0b3IKICAgICogQHBhcmFtIHtudW1iZXJ9IGxlbmd0aCAtIFRoZSBsZW5ndGggb2YgdGhlIHdhdmUKICAgICogQHBhcmFtIHtudW1iZXJ9IHNpbkFtcGxpdHVkZSAtIFRoZSBhbXBsaXR1ZGUgdG8gYXBwbHkgdG8gdGhlIHNpbmUgdGFibGUgKGRlZmF1bHQgMS4wKSBpZiB5b3UgbmVlZCB2YWx1ZXMgYmV0d2VlbiBzYXkgLSsgMTI1IHRoZW4gZ2l2ZSAxMjUgYXMgdGhlIHZhbHVlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb3NBbXBsaXR1ZGUgLSBUaGUgYW1wbGl0dWRlIHRvIGFwcGx5IHRvIHRoZSBjb3NpbmUgdGFibGUgKGRlZmF1bHQgMS4wKSBpZiB5b3UgbmVlZCB2YWx1ZXMgYmV0d2VlbiBzYXkgLSsgMTI1IHRoZW4gZ2l2ZSAxMjUgYXMgdGhlIHZhbHVlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBmcmVxdWVuY3kgIC0gVGhlIGZyZXF1ZW5jeSBvZiB0aGUgc2luZSBhbmQgY29zaW5lIHRhYmxlIGRhdGEKICAgICogQHJldHVybiB7QXJyYXl9IFJldHVybnMgdGhlIHNpbmUgdGFibGUKICAgICovCiAgICBzaW5Db3NHZW5lcmF0b3I6IGZ1bmN0aW9uIChsZW5ndGgsIHNpbkFtcGxpdHVkZSwgY29zQW1wbGl0dWRlLCBmcmVxdWVuY3kpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzaW5BbXBsaXR1ZGUgPT09ICJ1bmRlZmluZWQiKSB7IHNpbkFtcGxpdHVkZSA9IDEuMDsgfQogICAgICAgIGlmICh0eXBlb2YgY29zQW1wbGl0dWRlID09PSAidW5kZWZpbmVkIikgeyBjb3NBbXBsaXR1ZGUgPSAxLjA7IH0KICAgICAgICBpZiAodHlwZW9mIGZyZXF1ZW5jeSA9PT0gInVuZGVmaW5lZCIpIHsgZnJlcXVlbmN5ID0gMS4wOyB9CiAgICAgICAgCiAgICAgICAgdmFyIHNpbiA9IHNpbkFtcGxpdHVkZTsKICAgICAgICB2YXIgY29zID0gY29zQW1wbGl0dWRlOwogICAgICAgIHZhciBmcnEgPSBmcmVxdWVuY3kgKiBNYXRoLlBJIC8gbGVuZ3RoOwogICAgICAgIAogICAgICAgIHZhciBjb3NUYWJsZSA9IFtdOwogICAgICAgIHZhciBzaW5UYWJsZSA9IFtdOwogICAgICAgIAogICAgICAgIGZvciAodmFyIGMgPSAwOyBjIDwgbGVuZ3RoOyBjKyspIHsKCiAgICAgICAgICAgIGNvcyAtPSBzaW4gKiBmcnE7CiAgICAgICAgICAgIHNpbiArPSBjb3MgKiBmcnE7CgogICAgICAgICAgICBjb3NUYWJsZVtjXSA9IGNvczsKICAgICAgICAgICAgc2luVGFibGVbY10gPSBzaW47CgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsgc2luOiBzaW5UYWJsZSwgY29zOiBjb3NUYWJsZSwgbGVuZ3RoOiBsZW5ndGggfTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIHRoZSB0b3AgZWxlbWVudCBmcm9tIHRoZSBzdGFjayBhbmQgcmUtaW5zZXJ0cyBpdCBvbnRvIHRoZSBib3R0b20sIHRoZW4gcmV0dXJucyBpdC4KICAgICogVGhlIG9yaWdpbmFsIHN0YWNrIGlzIG1vZGlmaWVkIGluIHRoZSBwcm9jZXNzLiBUaGlzIGVmZmVjdGl2ZWx5IG1vdmVzIHRoZSBwb3NpdGlvbiBvZiB0aGUgZGF0YSBmcm9tIHRoZSBzdGFydCB0byB0aGUgZW5kIG9mIHRoZSB0YWJsZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc2hpZnQKICAgICogQHBhcmFtIHthcnJheX0gc3RhY2sgLSBUaGUgYXJyYXkgdG8gc2hpZnQuCiAgICAqIEByZXR1cm4ge2FueX0gVGhlIHNoaWZ0ZWQgdmFsdWUuCiAgICAqLwogICAgc2hpZnQ6IGZ1bmN0aW9uIChzdGFjaykgewoKICAgICAgICB2YXIgcyA9IHN0YWNrLnNoaWZ0KCk7CiAgICAgICAgc3RhY2sucHVzaChzKTsKCiAgICAgICAgcmV0dXJuIHM7CgogICAgfSwKCiAgICAvKioKICAgICogU2h1ZmZsZXMgdGhlIGRhdGEgaW4gdGhlIGdpdmVuIGFycmF5IGludG8gYSBuZXcgb3JkZXIKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNzaHVmZmxlQXJyYXkKICAgICogQHBhcmFtIHthcnJheX0gYXJyYXkgLSBUaGUgYXJyYXkgdG8gc2h1ZmZsZQogICAgKiBAcmV0dXJuIHthcnJheX0gVGhlIGFycmF5CiAgICAqLwogICAgc2h1ZmZsZUFycmF5OiBmdW5jdGlvbiAoYXJyYXkpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IGFycmF5Lmxlbmd0aCAtIDE7IGkgPiAwOyBpLS0pIHsKCiAgICAgICAgICAgIHZhciBqID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKGkgKyAxKSk7CiAgICAgICAgICAgIHZhciB0ZW1wID0gYXJyYXlbaV07CiAgICAgICAgICAgIGFycmF5W2ldID0gYXJyYXlbal07CiAgICAgICAgICAgIGFycmF5W2pdID0gdGVtcDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhcnJheTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSB0d28gZ2l2ZW4gc2V0IG9mIGNvb3JkaW5hdGVzLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNkaXN0YW5jZQogICAgKiBAcGFyYW0ge251bWJlcn0geDEKICAgICogQHBhcmFtIHtudW1iZXJ9IHkxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MgogICAgKiBAcGFyYW0ge251bWJlcn0geTIKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgdHdvIHNldHMgb2YgY29vcmRpbmF0ZXMuCiAgICAqLwogICAgZGlzdGFuY2U6IGZ1bmN0aW9uICh4MSwgeTEsIHgyLCB5MikgewoKICAgICAgICB2YXIgZHggPSB4MSAtIHgyOwogICAgICAgIHZhciBkeSA9IHkxIC0geTI7CgogICAgICAgIHJldHVybiBNYXRoLnNxcnQoZHggKiBkeCArIGR5ICogZHkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIGRpc3RhbmNlIGJldHdlZW4gdGhlIHR3byBnaXZlbiBzZXQgb2YgY29vcmRpbmF0ZXMgYXQgdGhlIHBvd2VyIGdpdmVuLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNkaXN0YW5jZVBvdwogICAgKiBAcGFyYW0ge251bWJlcn0geDEKICAgICogQHBhcmFtIHtudW1iZXJ9IHkxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MgogICAgKiBAcGFyYW0ge251bWJlcn0geTIKICAgICogQHBhcmFtIHtudW1iZXJ9IFtwb3c9Ml0KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgdHdvIHNldHMgb2YgY29vcmRpbmF0ZXMuCiAgICAqLwogICAgZGlzdGFuY2VQb3c6IGZ1bmN0aW9uICh4MSwgeTEsIHgyLCB5MiwgcG93KSB7CgogICAgICAgIGlmICh0eXBlb2YgcG93ID09PSAndW5kZWZpbmVkJykgeyBwb3cgPSAyOyB9CgogICAgICAgIHJldHVybiBNYXRoLnNxcnQoTWF0aC5wb3coeDIgLSB4MSwgcG93KSArIE1hdGgucG93KHkyIC0geTEsIHBvdykpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIHJvdW5kZWQgZGlzdGFuY2UgYmV0d2VlbiB0aGUgdHdvIGdpdmVuIHNldCBvZiBjb29yZGluYXRlcy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZGlzdGFuY2VSb3VuZGVkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MQogICAgKiBAcGFyYW0ge251bWJlcn0geTEKICAgICogQHBhcmFtIHtudW1iZXJ9IHgyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoaXMgUG9pbnQgb2JqZWN0IGFuZCB0aGUgZGVzdGluYXRpb24gUG9pbnQgb2JqZWN0LgogICAgKi8KICAgIGRpc3RhbmNlUm91bmRlZDogZnVuY3Rpb24gKHgxLCB5MSwgeDIsIHkyKSB7CgogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKFBoYXNlci5NYXRoLmRpc3RhbmNlKHgxLCB5MSwgeDIsIHkyKSk7CgogICAgfSwKCiAgICAvKioKICAgICogRm9yY2UgYSB2YWx1ZSB3aXRoaW4gdGhlIGJvdW5kYXJpZXMgb2YgdHdvIHZhbHVlcy4KICAgICogQ2xhbXAgdmFsdWUgdG8gcmFuZ2UgPGEsIGI+CiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2NsYW1wCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBiCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBjbGFtcDogZnVuY3Rpb24gKCB4LCBhLCBiICkgewoKICAgICAgICByZXR1cm4gKCB4IDwgYSApID8gYSA6ICggKCB4ID4gYiApID8gYiA6IHggKTsKCiAgICB9LAogCiAgICAvKioKICAgICogQ2xhbXAgdmFsdWUgdG8gcmFuZ2UgPGEsIGluZikuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2NsYW1wQm90dG9tCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBjbGFtcEJvdHRvbTogZnVuY3Rpb24gKCB4LCBhICkgewoKICAgICAgICByZXR1cm4geCA8IGEgPyBhIDogeDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgaWYgdHdvIHZhbHVlcyBhcmUgd2l0aGluIHRoZSBnaXZlbiB0b2xlcmFuY2Ugb2YgZWFjaCBvdGhlci4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjd2l0aGluCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhIC0gVGhlIGZpcnN0IG51bWJlciB0byBjaGVjawogICAgKiBAcGFyYW0ge251bWJlcn0gYiAtIFRoZSBzZWNvbmQgbnVtYmVyIHRvIGNoZWNrCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0b2xlcmFuY2UgLSBUaGUgdG9sZXJhbmNlLiBBbnl0aGluZyBlcXVhbCB0byBvciBsZXNzIHRoYW4gdGhpcyBpcyBjb25zaWRlcmVkIHdpdGhpbiB0aGUgcmFuZ2UuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgYSBpcyA8PSB0b2xlcmFuY2Ugb2YgYi4KICAgICovCiAgICB3aXRoaW46IGZ1bmN0aW9uICggYSwgYiwgdG9sZXJhbmNlICkgewoKICAgICAgICByZXR1cm4gKE1hdGguYWJzKGEgLSBiKSA8PSB0b2xlcmFuY2UpOwoKICAgIH0sCiAKICAgIC8qKgogICAgKiBMaW5lYXIgbWFwcGluZyBmcm9tIHJhbmdlIDxhMSwgYTI+IHRvIHJhbmdlIDxiMSwgYjI+CiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI21hcExpbmVhcgogICAgKiBAcGFyYW0ge251bWJlcn0geAogICAgKiBAcGFyYW0ge251bWJlcn0gYTEKICAgICogQHBhcmFtIHtudW1iZXJ9IGExCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhMgogICAgKiBAcGFyYW0ge251bWJlcn0gYjEKICAgICogQHBhcmFtIHtudW1iZXJ9IGIyCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBtYXBMaW5lYXI6IGZ1bmN0aW9uICggeCwgYTEsIGEyLCBiMSwgYjIgKSB7CgogICAgICAgIHJldHVybiBiMSArICggeCAtIGExICkgKiAoIGIyIC0gYjEgKSAvICggYTIgLSBhMSApOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNtb290aHN0ZXAgZnVuY3Rpb24gYXMgZGV0YWlsZWQgYXQgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TbW9vdGhzdGVwCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3Ntb290aHN0ZXAKICAgICogQHBhcmFtIHtudW1iZXJ9IHgKICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4CiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBzbW9vdGhzdGVwOiBmdW5jdGlvbiAoIHgsIG1pbiwgbWF4ICkgewoKICAgICAgICBpZiAoeCA8PSBtaW4pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CgogICAgICAgIGlmICh4ID49IG1heCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgIH0KCiAgICAgICAgeCA9ICh4IC0gbWluKSAvIChtYXggLSBtaW4pOwoKICAgICAgICByZXR1cm4geCAqIHggKiAoMyAtIDIgKiB4KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTbW9vdGhlcnN0ZXAgZnVuY3Rpb24gYXMgZGV0YWlsZWQgYXQgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TbW9vdGhzdGVwCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3Ntb290aGVyc3RlcAogICAgKiBAcGFyYW0ge251bWJlcn0geAogICAgKiBAcGFyYW0ge251bWJlcn0gbWluCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYXgKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHNtb290aGVyc3RlcDogZnVuY3Rpb24gKCB4LCBtaW4sIG1heCApIHsKCiAgICAgICAgaWYgKHggPD0gbWluKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgICAgICBpZiAoeCA+PSBtYXgpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CgogICAgICAgIHggPSAoeCAtIG1pbikgLyAobWF4IC0gbWluKTsKCiAgICAgICAgcmV0dXJuIHggKiB4ICogeCAqICh4ICogKHggKiA2IC0gMTUpICsgMTApOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEEgdmFsdWUgcmVwcmVzZW50aW5nIHRoZSBzaWduIG9mIHRoZSB2YWx1ZS4KICAgICogLTEgZm9yIG5lZ2F0aXZlLCArMSBmb3IgcG9zaXRpdmUsIDAgaWYgdmFsdWUgaXMgMAogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNzaWduCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4CiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBzaWduOiBmdW5jdGlvbiAoIHggKSB7CgogICAgICAgIHJldHVybiAoIHggPCAwICkgPyAtMSA6ICggKCB4ID4gMCApID8gMSA6IDAgKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDb252ZXJ0IGRlZ3JlZXMgdG8gcmFkaWFucy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZGVnVG9SYWQKICAgICogQHJldHVybiB7ZnVuY3Rpb259CiAgICAqLwogICAgZGVnVG9SYWQ6IGZ1bmN0aW9uKCkgewoKICAgICAgICB2YXIgZGVncmVlVG9SYWRpYW5zRmFjdG9yID0gTWF0aC5QSSAvIDE4MDsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICggZGVncmVlcyApIHsKCiAgICAgICAgICAgIHJldHVybiBkZWdyZWVzICogZGVncmVlVG9SYWRpYW5zRmFjdG9yOwoKICAgICAgICB9OwoKICAgIH0oKSwKCiAgICAvKioKICAgICogQ29udmVydCBkZWdyZWVzIHRvIHJhZGlhbnMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3JhZFRvRGVnCiAgICAqIEByZXR1cm4ge2Z1bmN0aW9ufQogICAgKi8KICAgIHJhZFRvRGVnOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIHJhZGlhblRvRGVncmVlc0ZhY3RvciA9IDE4MCAvIE1hdGguUEk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoIHJhZGlhbnMgKSB7CgogICAgICAgICAgICByZXR1cm4gcmFkaWFucyAqIHJhZGlhblRvRGVncmVlc0ZhY3RvcjsKCiAgICAgICAgfTsKCiAgICB9KCkKCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBKYXZhc2NyaXB0IFF1YWRUcmVlIAoqIEB2ZXJzaW9uIDEuMAoqIEBhdXRob3IgVGltbyBIYXVzbWFubgoqCiogQHZlcnNpb24gMS4yLCBTZXB0ZW1iZXIgNHRoIDIwMTMKKiBAYXV0aG9yIFJpY2hhcmQgRGF2ZXkKKiBUaGUgb3JpZ2luYWwgY29kZSB3YXMgYSBjb252ZXJzaW9uIG9mIHRoZSBKYXZhIGNvZGUgcG9zdGVkIHRvIEdhbWVEZXZUdXRzLiBIb3dldmVyIEkndmUgdHdlYWtlZAoqIGl0IG1hc3NpdmVseSB0byBhZGQgbm9kZSBpbmRleGluZywgcmVtb3ZlZCBsb3RzIG9mIHRlbXAuIHZhciBjcmVhdGlvbiBhbmQgc2lnbmlmaWNhbnRseQoqIGluY3JlYXNlZCBwZXJmb3JtYW5jZSBhcyBhIHJlc3VsdC4KKgoqIE9yaWdpbmFsIHZlcnNpb24gYXQgaHR0cHM6Ly9naXRodWIuY29tL3RpbW9oYXVzbWFubi9xdWFkdHJlZS1qcy8KKi8KIAovKioKKiBAY29weXJpZ2h0IMKpIDIwMTIgVGltbyBIYXVzbWFubgoqCiogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nCiogYSBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiogIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwoqIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKKiBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8KKiBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8KKiB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CioKKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQoqIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoqCiogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsCiogRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiogTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQKKiBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFCiogTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTgoqIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTgoqIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoqLwoKLyoqCiogUXVhZFRyZWUgQ29uc3RydWN0b3IKKiAKKiBAY2xhc3MgUGhhc2VyLlF1YWRUcmVlCiogQGNsYXNzZGVzYyBBIFF1YWRUcmVlIGltcGxlbWVudGF0aW9uLiBUaGUgb3JpZ2luYWwgY29kZSB3YXMgYSBjb252ZXJzaW9uIG9mIHRoZSBKYXZhIGNvZGUgcG9zdGVkIHRvIEdhbWVEZXZUdXRzLiAKKiBIb3dldmVyIEkndmUgdHdlYWtlZCBpdCBtYXNzaXZlbHkgdG8gYWRkIG5vZGUgaW5kZXhpbmcsIHJlbW92ZWQgbG90cyBvZiB0ZW1wLiB2YXIgY3JlYXRpb24gYW5kIHNpZ25pZmljYW50bHkgaW5jcmVhc2VkIHBlcmZvcm1hbmNlIGFzIGEgcmVzdWx0LiAKKiBPcmlnaW5hbCB2ZXJzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS90aW1vaGF1c21hbm4vcXVhZHRyZWUtanMvCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdG9wIGxlZnQgY29vcmRpbmF0ZSBvZiB0aGUgcXVhZHRyZWUuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgdG9wIGxlZnQgY29vcmRpbmF0ZSBvZiB0aGUgcXVhZHRyZWUuCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBxdWFkdHJlZSBpbiBwaXhlbHMuCiogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIHF1YWR0cmVlIGluIHBpeGVscy4KKiBAcGFyYW0ge251bWJlcn0gW21heE9iamVjdHM9MTBdIC0gVGhlIG1heGltdW0gbnVtYmVyIG9mIG9iamVjdHMgcGVyIG5vZGUuCiogQHBhcmFtIHtudW1iZXJ9IFttYXhMZXZlbHM9NF0gLSBUaGUgbWF4aW11bSBudW1iZXIgb2YgbGV2ZWxzIHRvIGl0ZXJhdGUgdG8uCiogQHBhcmFtIHtudW1iZXJ9IFtsZXZlbD0wXSAtIFdoaWNoIGxldmVsIGlzIHRoaXM/CiovClBoYXNlci5RdWFkVHJlZSA9IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBtYXhPYmplY3RzLCBtYXhMZXZlbHMsIGxldmVsKSB7CiAgICAgICAgCiAgICB0aGlzLm1heE9iamVjdHMgPSBtYXhPYmplY3RzIHx8IDEwOwogICAgdGhpcy5tYXhMZXZlbHMgPSBtYXhMZXZlbHMgfHwgNDsKICAgIHRoaXMubGV2ZWwgPSBsZXZlbCB8fCAwOwoKICAgIHRoaXMuYm91bmRzID0gewogICAgICAgIHg6IE1hdGgucm91bmQoeCksCiAgICAgICAgeTogTWF0aC5yb3VuZCh5KSwKICAgICAgICB3aWR0aDogd2lkdGgsCiAgICAgICAgaGVpZ2h0OiBoZWlnaHQsCiAgICAgICAgc3ViV2lkdGg6IE1hdGguZmxvb3Iod2lkdGggLyAyKSwKICAgICAgICBzdWJIZWlnaHQ6IE1hdGguZmxvb3IoaGVpZ2h0IC8gMiksCiAgICAgICAgcmlnaHQ6IE1hdGgucm91bmQoeCkgKyBNYXRoLmZsb29yKHdpZHRoIC8gMiksCiAgICAgICAgYm90dG9tOiBNYXRoLnJvdW5kKHkpICsgTWF0aC5mbG9vcihoZWlnaHQgLyAyKQogICAgfTsKICAgIAogICAgdGhpcy5vYmplY3RzID0gW107CiAgICB0aGlzLm5vZGVzID0gW107Cgp9OwoKUGhhc2VyLlF1YWRUcmVlLnByb3RvdHlwZSA9IHsKCiAgICAvKgogICAgKiBQb3B1bGF0ZXMgdGhpcyBxdWFkdHJlZSB3aXRoIHRoZSBtZW1iZXJzIG9mIHRoZSBnaXZlbiBHcm91cC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlF1YWRUcmVlI3BvcHVsYXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLkdyb3VwfSBncm91cCAtIFRoZSBHcm91cCB0byBhZGQgdG8gdGhlIHF1YWR0cmVlLgogICAgKi8KICAgIHBvcHVsYXRlOiBmdW5jdGlvbiAoZ3JvdXApIHsKCiAgICAgICAgZ3JvdXAuZm9yRWFjaCh0aGlzLnBvcHVsYXRlSGFuZGxlciwgdGhpcywgdHJ1ZSk7CgogICAgfSwKCiAgICAvKgogICAgKiBIYW5kbGVyIGZvciB0aGUgcG9wdWxhdGUgbWV0aG9kLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUXVhZFRyZWUjcG9wdWxhdGVIYW5kbGVyCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gVGhlIFNwcml0ZSB0byBjaGVjay4KICAgICovCiAgICBwb3B1bGF0ZUhhbmRsZXI6IGZ1bmN0aW9uIChzcHJpdGUpIHsKCiAgICAgICAgaWYgKHNwcml0ZS5ib2R5ICYmIHNwcml0ZS5ib2R5LmNoZWNrQ29sbGlzaW9uLm5vbmUgPT09IGZhbHNlICYmIHNwcml0ZS5hbGl2ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuaW5zZXJ0KHNwcml0ZS5ib2R5KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKgogICAgKiBTcGxpdCB0aGUgbm9kZSBpbnRvIDQgc3Vibm9kZXMKICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlF1YWRUcmVlI3NwbGl0CiAgICAqLwogICAgc3BsaXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5sZXZlbCsrOwogICAgICAgIAogICAgICAgIC8vICB0b3AgcmlnaHQgbm9kZQogICAgICAgIHRoaXMubm9kZXNbMF0gPSBuZXcgUGhhc2VyLlF1YWRUcmVlKHRoaXMuYm91bmRzLnJpZ2h0LCB0aGlzLmJvdW5kcy55LCB0aGlzLmJvdW5kcy5zdWJXaWR0aCwgdGhpcy5ib3VuZHMuc3ViSGVpZ2h0LCB0aGlzLm1heE9iamVjdHMsIHRoaXMubWF4TGV2ZWxzLCB0aGlzLmxldmVsKTsKICAgICAgICAKICAgICAgICAvLyAgdG9wIGxlZnQgbm9kZQogICAgICAgIHRoaXMubm9kZXNbMV0gPSBuZXcgUGhhc2VyLlF1YWRUcmVlKHRoaXMuYm91bmRzLngsIHRoaXMuYm91bmRzLnksIHRoaXMuYm91bmRzLnN1YldpZHRoLCB0aGlzLmJvdW5kcy5zdWJIZWlnaHQsIHRoaXMubWF4T2JqZWN0cywgdGhpcy5tYXhMZXZlbHMsIHRoaXMubGV2ZWwpOwogICAgICAgIAogICAgICAgIC8vICBib3R0b20gbGVmdCBub2RlCiAgICAgICAgdGhpcy5ub2Rlc1syXSA9IG5ldyBQaGFzZXIuUXVhZFRyZWUodGhpcy5ib3VuZHMueCwgdGhpcy5ib3VuZHMuYm90dG9tLCB0aGlzLmJvdW5kcy5zdWJXaWR0aCwgdGhpcy5ib3VuZHMuc3ViSGVpZ2h0LCB0aGlzLm1heE9iamVjdHMsIHRoaXMubWF4TGV2ZWxzLCB0aGlzLmxldmVsKTsKICAgICAgICAKICAgICAgICAvLyAgYm90dG9tIHJpZ2h0IG5vZGUKICAgICAgICB0aGlzLm5vZGVzWzNdID0gbmV3IFBoYXNlci5RdWFkVHJlZSh0aGlzLmJvdW5kcy5yaWdodCwgdGhpcy5ib3VuZHMuYm90dG9tLCB0aGlzLmJvdW5kcy5zdWJXaWR0aCwgdGhpcy5ib3VuZHMuc3ViSGVpZ2h0LCB0aGlzLm1heE9iamVjdHMsIHRoaXMubWF4TGV2ZWxzLCB0aGlzLmxldmVsKTsKCiAgICB9LAoKICAgIC8qCiAgICAqIEluc2VydCB0aGUgb2JqZWN0IGludG8gdGhlIG5vZGUuIElmIHRoZSBub2RlIGV4Y2VlZHMgdGhlIGNhcGFjaXR5LCBpdCB3aWxsIHNwbGl0IGFuZCBhZGQgYWxsIG9iamVjdHMgdG8gdGhlaXIgY29ycmVzcG9uZGluZyBzdWJub2Rlcy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlF1YWRUcmVlI2luc2VydAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fG9iamVjdH0gYm9keSAtIFRoZSBCb2R5IG9iamVjdCB0byBpbnNlcnQgaW50byB0aGUgcXVhZHRyZWUuCiAgICAqLwogICAgaW5zZXJ0OiBmdW5jdGlvbiAoYm9keSkgewogICAgICAgIAogICAgICAgIHZhciBpID0gMDsKICAgICAgICB2YXIgaW5kZXg7CiAgICAgICAgCiAgICAgICAgLy8gIGlmIHdlIGhhdmUgc3Vibm9kZXMgLi4uCiAgICAgICAgaWYgKHRoaXMubm9kZXNbMF0gIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIGluZGV4ID0gdGhpcy5nZXRJbmRleChib2R5KTsKICAgICAKICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5ub2Rlc1tpbmRleF0uaW5zZXJ0KGJvZHkpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgIAogICAgICAgIHRoaXMub2JqZWN0cy5wdXNoKGJvZHkpOwogICAgICAgIAogICAgICAgIGlmICh0aGlzLm9iamVjdHMubGVuZ3RoID4gdGhpcy5tYXhPYmplY3RzICYmIHRoaXMubGV2ZWwgPCB0aGlzLm1heExldmVscykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBTcGxpdCBpZiB3ZSBkb24ndCBhbHJlYWR5IGhhdmUgc3Vibm9kZXMKICAgICAgICAgICAgaWYgKHRoaXMubm9kZXNbMF0gPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcGxpdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyAgQWRkIG9iamVjdHMgdG8gc3Vibm9kZXMKICAgICAgICAgICAgd2hpbGUgKGkgPCB0aGlzLm9iamVjdHMubGVuZ3RoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpbmRleCA9IHRoaXMuZ2V0SW5kZXgodGhpcy5vYmplY3RzW2ldKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyAgdGhpcyBpcyBleHBlbnNpdmUgLSBzZWUgd2hhdCB3ZSBjYW4gZG8gYWJvdXQgaXQKICAgICAgICAgICAgICAgICAgICB0aGlzLm5vZGVzW2luZGV4XS5pbnNlcnQodGhpcy5vYmplY3RzLnNwbGljZShpLCAxKVswXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCiAgICAgCiAgICAvKgogICAgKiBEZXRlcm1pbmUgd2hpY2ggbm9kZSB0aGUgb2JqZWN0IGJlbG9uZ3MgdG8uCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5RdWFkVHJlZSNnZXRJbmRleAogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV8b2JqZWN0fSByZWN0IC0gVGhlIGJvdW5kcyBpbiB3aGljaCB0byBjaGVjay4KICAgICogQHJldHVybiB7bnVtYmVyfSBpbmRleCAtIEluZGV4IG9mIHRoZSBzdWJub2RlICgwLTMpLCBvciAtMSBpZiByZWN0IGNhbm5vdCBjb21wbGV0ZWx5IGZpdCB3aXRoaW4gYSBzdWJub2RlIGFuZCBpcyBwYXJ0IG9mIHRoZSBwYXJlbnQgbm9kZS4KICAgICovCiAgICBnZXRJbmRleDogZnVuY3Rpb24gKHJlY3QpIHsKICAgICAgICAKICAgICAgICAvLyAgZGVmYXVsdCBpcyB0aGF0IHJlY3QgZG9lc24ndCBmaXQsIGkuZS4gaXQgc3RyYWRkbGVzIHRoZSBpbnRlcm5hbCBxdWFkcmFudHMKICAgICAgICB2YXIgaW5kZXggPSAtMTsKCiAgICAgICAgaWYgKHJlY3QueCA8IHRoaXMuYm91bmRzLnJpZ2h0ICYmIHJlY3QucmlnaHQgPCB0aGlzLmJvdW5kcy5yaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICgocmVjdC55IDwgdGhpcy5ib3VuZHMuYm90dG9tICYmIHJlY3QuYm90dG9tIDwgdGhpcy5ib3VuZHMuYm90dG9tKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIHJlY3QgZml0cyB3aXRoaW4gdGhlIHRvcC1sZWZ0IHF1YWRyYW50IG9mIHRoaXMgcXVhZHRyZWUKICAgICAgICAgICAgICAgIGluZGV4ID0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICgocmVjdC55ID4gdGhpcy5ib3VuZHMuYm90dG9tKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIHJlY3QgZml0cyB3aXRoaW4gdGhlIGJvdHRvbS1sZWZ0IHF1YWRyYW50IG9mIHRoaXMgcXVhZHRyZWUKICAgICAgICAgICAgICAgIGluZGV4ID0gMjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChyZWN0LnggPiB0aGlzLmJvdW5kcy5yaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICByZWN0IGNhbiBjb21wbGV0ZWx5IGZpdCB3aXRoaW4gdGhlIHJpZ2h0IHF1YWRyYW50cwogICAgICAgICAgICBpZiAoKHJlY3QueSA8IHRoaXMuYm91bmRzLmJvdHRvbSAmJiByZWN0LmJvdHRvbSA8IHRoaXMuYm91bmRzLmJvdHRvbSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICByZWN0IGZpdHMgd2l0aGluIHRoZSB0b3AtcmlnaHQgcXVhZHJhbnQgb2YgdGhpcyBxdWFkdHJlZQogICAgICAgICAgICAgICAgaW5kZXggPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKChyZWN0LnkgPiB0aGlzLmJvdW5kcy5ib3R0b20pKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgcmVjdCBmaXRzIHdpdGhpbiB0aGUgYm90dG9tLXJpZ2h0IHF1YWRyYW50IG9mIHRoaXMgcXVhZHRyZWUKICAgICAgICAgICAgICAgIGluZGV4ID0gMzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAKICAgICAgICByZXR1cm4gaW5kZXg7CgogICAgfSwKCiAgICAvKgogICAgKiBSZXR1cm4gYWxsIG9iamVjdHMgdGhhdCBjb3VsZCBjb2xsaWRlIHdpdGggdGhlIGdpdmVuIFNwcml0ZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlF1YWRUcmVlI3JldHJpZXZlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gVGhlIHNwcml0ZSB0byBjaGVjayBhZ2FpbnN0LgogICAgKiBAcmV0dXJuIHthcnJheX0gLSBBcnJheSB3aXRoIGFsbCBkZXRlY3RlZCBvYmplY3RzLgogICAgKi8KICAgIHJldHJpZXZlOiBmdW5jdGlvbiAoc3ByaXRlKSB7CiAgICAgICAgCiAgICAgICAgdmFyIHJldHVybk9iamVjdHMgPSB0aGlzLm9iamVjdHM7CgogICAgICAgIHNwcml0ZS5ib2R5LnF1YWRUcmVlSW5kZXggPSB0aGlzLmdldEluZGV4KHNwcml0ZS5ib2R5KTsKCiAgICAgICAgLy8gIFRlbXAgc3RvcmUgZm9yIHRoZSBub2RlIElEcyB0aGlzIHNwcml0ZSBpcyBpbiwgd2UgY2FuIHVzZSB0aGlzIGZvciBmYXN0IGVsaW1pbmF0aW9uIGxhdGVyCiAgICAgICAgLy8gc3ByaXRlLmJvZHkucXVhZFRyZWVJRHMucHVzaCh0aGlzLklEKTsKCiAgICAgICAgaWYgKHRoaXMubm9kZXNbMF0pCiAgICAgICAgewogICAgICAgICAgICAvLyAgaWYgcmVjdCBmaXRzIGludG8gYSBzdWJub2RlIC4uCiAgICAgICAgICAgIGlmIChzcHJpdGUuYm9keS5xdWFkVHJlZUluZGV4ICE9PSAtMSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuT2JqZWN0cyA9IHJldHVybk9iamVjdHMuY29uY2F0KHRoaXMubm9kZXNbc3ByaXRlLmJvZHkucXVhZFRyZWVJbmRleF0ucmV0cmlldmUoc3ByaXRlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgaWYgcmVjdCBkb2VzIG5vdCBmaXQgaW50byBhIHN1Ym5vZGUsIGNoZWNrIGl0IGFnYWluc3QgYWxsIHN1Ym5vZGVzICh1bnJvbGxlZCBmb3Igc3BlZWQpCiAgICAgICAgICAgICAgICByZXR1cm5PYmplY3RzID0gcmV0dXJuT2JqZWN0cy5jb25jYXQodGhpcy5ub2Rlc1swXS5yZXRyaWV2ZShzcHJpdGUpKTsKICAgICAgICAgICAgICAgIHJldHVybk9iamVjdHMgPSByZXR1cm5PYmplY3RzLmNvbmNhdCh0aGlzLm5vZGVzWzFdLnJldHJpZXZlKHNwcml0ZSkpOwogICAgICAgICAgICAgICAgcmV0dXJuT2JqZWN0cyA9IHJldHVybk9iamVjdHMuY29uY2F0KHRoaXMubm9kZXNbMl0ucmV0cmlldmUoc3ByaXRlKSk7CiAgICAgICAgICAgICAgICByZXR1cm5PYmplY3RzID0gcmV0dXJuT2JqZWN0cy5jb25jYXQodGhpcy5ub2Rlc1szXS5yZXRyaWV2ZShzcHJpdGUpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAKICAgICAgICByZXR1cm4gcmV0dXJuT2JqZWN0czsKCiAgICB9LAoKICAgIC8qCiAgICAqIENsZWFyIHRoZSBxdWFkdHJlZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUXVhZFRyZWUjY2xlYXIKICAgICovCiAgICBjbGVhcjogZnVuY3Rpb24gKCkgewogICAgICAgIAogICAgICAgIHRoaXMub2JqZWN0cyA9IFtdOwogICAgIAogICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLm5vZGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMubm9kZXNbaV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMubm9kZXNbaV0uY2xlYXIoKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vZGVzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKfTsKClBoYXNlci5RdWFkVHJlZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuUXVhZFRyZWU7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGVzIGEgbmV3IENpcmNsZSBvYmplY3Qgd2l0aCB0aGUgY2VudGVyIGNvb3JkaW5hdGUgc3BlY2lmaWVkIGJ5IHRoZSB4IGFuZCB5IHBhcmFtZXRlcnMgYW5kIHRoZSBkaWFtZXRlciBzcGVjaWZpZWQgYnkgdGhlIGRpYW1ldGVyIHBhcmFtZXRlci4gSWYgeW91IGNhbGwgdGhpcyBmdW5jdGlvbiB3aXRob3V0IHBhcmFtZXRlcnMsIGEgY2lyY2xlIHdpdGggeCwgeSwgZGlhbWV0ZXIgYW5kIHJhZGl1cyBwcm9wZXJ0aWVzIHNldCB0byAwIGlzIGNyZWF0ZWQuCiogQGNsYXNzIENpcmNsZQoqIEBjbGFzc2Rlc2MgUGhhc2VyIC0gQ2lyY2xlCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtudW1iZXJ9IFt4PTBdIC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUuCiogQHBhcmFtIHtudW1iZXJ9IFt5PTBdIC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUuCiogQHBhcmFtIHtudW1iZXJ9IFtkaWFtZXRlcj0wXSAtIFRoZSBkaWFtZXRlciBvZiB0aGUgY2lyY2xlLgoqIEByZXR1cm4ge1BoYXNlci5DaXJjbGV9IFRoaXMgY2lyY2xlIG9iamVjdAoqLwpQaGFzZXIuQ2lyY2xlID0gZnVuY3Rpb24gKHgsIHksIGRpYW1ldGVyKSB7CgogICAgeCA9IHggfHwgMDsKICAgIHkgPSB5IHx8IDA7CiAgICBkaWFtZXRlciA9IGRpYW1ldGVyIHx8IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUuCiAgICAqLwogICAgdGhpcy54ID0geDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZS4KICAgICovCiAgICB0aGlzLnkgPSB5OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2RpYW1ldGVyIC0gVGhlIGRpYW1ldGVyIG9mIHRoZSBjaXJjbGUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZGlhbWV0ZXIgPSBkaWFtZXRlcjsKCiAgICBpZiAoZGlhbWV0ZXIgPiAwKQogICAgewogICAgICAgIC8qKgogICAgICAgKiBAcHJvcGVydHkge251bWJlcn0gX3JhZGl1cyAtIFRoZSByYWRpdXMgb2YgdGhlIGNpcmNsZS4KICAgICAgICogQHByaXZhdGUKICAgICAgICovCiAgICAgICAgdGhpcy5fcmFkaXVzID0gZGlhbWV0ZXIgKiAwLjU7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5fcmFkaXVzID0gMDsKICAgIH0KCn07CgpQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogVGhlIGNpcmN1bWZlcmVuY2Ugb2YgdGhlIGNpcmNsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI2NpcmN1bWZlcmVuY2UKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIGNpcmN1bWZlcmVuY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gMiAqIChNYXRoLlBJICogdGhpcy5fcmFkaXVzKTsKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIG1lbWJlcnMgb2YgQ2lyY2xlIHRvIHRoZSBzcGVjaWZpZWQgdmFsdWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjc2V0VG8KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGRpYW1ldGVyIC0gVGhlIGRpYW1ldGVyIG9mIHRoZSBjaXJjbGUgaW4gcGl4ZWxzLgogICAgKiBAcmV0dXJuIHtDaXJjbGV9IFRoaXMgY2lyY2xlIG9iamVjdC4KICAgICovCiAgICBzZXRUbzogZnVuY3Rpb24gKHgsIHksIGRpYW1ldGVyKSB7CiAgICAgICAgdGhpcy54ID0geDsKICAgICAgICB0aGlzLnkgPSB5OwogICAgICAgIHRoaXMuX2RpYW1ldGVyID0gZGlhbWV0ZXI7CiAgICAgICAgdGhpcy5fcmFkaXVzID0gZGlhbWV0ZXIgKiAwLjU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8qKgogICAgKiBDb3BpZXMgdGhlIHgsIHkgYW5kIGRpYW1ldGVyIHByb3BlcnRpZXMgZnJvbSBhbnkgZ2l2ZW4gb2JqZWN0IHRvIHRoaXMgQ2lyY2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjY29weUZyb20KICAgICogQHBhcmFtIHthbnl9IHNvdXJjZSAtIFRoZSBvYmplY3QgdG8gY29weSBmcm9tLgogICAgKiBAcmV0dXJuIHtDaXJjbGV9IFRoaXMgQ2lyY2xlIG9iamVjdC4KICAgICovCiAgICBjb3B5RnJvbTogZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICAgIHJldHVybiB0aGlzLnNldFRvKHNvdXJjZS54LCBzb3VyY2UueSwgc291cmNlLmRpYW1ldGVyKTsKICAgIH0sCgogICAgLyoqCiAgICAqIENvcGllcyB0aGUgeCwgeSBhbmQgZGlhbWV0ZXIgcHJvcGVydGllcyBmcm9tIHRoaXMgQ2lyY2xlIHRvIGFueSBnaXZlbiBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNjb3B5VG8KICAgICogQHBhcmFtIHthbnl9IGRlc3QgLSBUaGUgb2JqZWN0IHRvIGNvcHkgdG8uCiAgICAqIEByZXR1cm4ge09iamVjdH0gVGhpcyBkZXN0IG9iamVjdC4KICAgICovCiAgICBjb3B5VG86IGZ1bmN0aW9uKGRlc3QpIHsKICAgICAgICBkZXN0LnggPSB0aGlzLng7CiAgICAgICAgZGVzdC55ID0gdGhpcy55OwogICAgICAgIGRlc3QuZGlhbWV0ZXIgPSB0aGlzLl9kaWFtZXRlcjsKICAgICAgICByZXR1cm4gZGVzdDsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIGRpc3RhbmNlIGZyb20gdGhlIGNlbnRlciBvZiB0aGUgQ2lyY2xlIG9iamVjdCB0byB0aGUgZ2l2ZW4gb2JqZWN0CiAgICAqIChjYW4gYmUgQ2lyY2xlLCBQb2ludCBvciBhbnl0aGluZyB3aXRoIHgveSBwcm9wZXJ0aWVzKQogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjZGlzdGFuY2UKICAgICogQHBhcmFtIHtvYmplY3R9IGRlc3QgLSBUaGUgdGFyZ2V0IG9iamVjdC4gTXVzdCBoYXZlIHZpc2libGUgeCBhbmQgeSBwcm9wZXJ0aWVzIHRoYXQgcmVwcmVzZW50IHRoZSBjZW50ZXIgb2YgdGhlIG9iamVjdC4KICAgICogQHBhcmFtIHtib29sZWFufSBbcm91bmRdIC0gUm91bmQgdGhlIGRpc3RhbmNlIHRvIHRoZSBuZWFyZXN0IGludGVnZXIgKGRlZmF1bHQgZmFsc2UpLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoaXMgUG9pbnQgb2JqZWN0IGFuZCB0aGUgZGVzdGluYXRpb24gUG9pbnQgb2JqZWN0LgogICAgKi8KICAgIGRpc3RhbmNlOiBmdW5jdGlvbiAoZGVzdCwgcm91bmQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiByb3VuZCA9PT0gInVuZGVmaW5lZCIpIHsgcm91bmQgPSBmYWxzZSB9CgogICAgICAgIGlmIChyb3VuZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBQaGFzZXIuTWF0aC5kaXN0YW5jZVJvdW5kKHRoaXMueCwgdGhpcy55LCBkZXN0LngsIGRlc3QueSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBQaGFzZXIuTWF0aC5kaXN0YW5jZSh0aGlzLngsIHRoaXMueSwgZGVzdC54LCBkZXN0LnkpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgbmV3IENpcmNsZSBvYmplY3Qgd2l0aCB0aGUgc2FtZSB2YWx1ZXMgZm9yIHRoZSB4LCB5LCB3aWR0aCwgYW5kIGhlaWdodCBwcm9wZXJ0aWVzIGFzIHRoaXMgQ2lyY2xlIG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI2Nsb25lCiAgICAqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gb3V0IC0gT3B0aW9uYWwgQ2lyY2xlIG9iamVjdC4gSWYgZ2l2ZW4gdGhlIHZhbHVlcyB3aWxsIGJlIHNldCBpbnRvIHRoZSBvYmplY3QsIG90aGVyd2lzZSBhIGJyYW5kIG5ldyBDaXJjbGUgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5DaXJjbGV9IFRoZSBjbG9uZWQgQ2lyY2xlIG9iamVjdC4KICAgICovCiAgICBjbG9uZTogZnVuY3Rpb24ob3V0KSB7CgogICAgICAgIGlmICh0eXBlb2Ygb3V0ID09PSAidW5kZWZpbmVkIikgeyBvdXQgPSBuZXcgUGhhc2VyLkNpcmNsZSgpOyB9CgogICAgICAgIHJldHVybiBvdXQuc2V0VG8odGhpcy54LCB0aGlzLnksIHRoaXMuZGlhbWV0ZXIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybiB0cnVlIGlmIHRoZSBnaXZlbiB4L3kgY29vcmRpbmF0ZXMgYXJlIHdpdGhpbiB0aGlzIENpcmNsZSBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNjb250YWlucwogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBYIHZhbHVlIG9mIHRoZSBjb29yZGluYXRlIHRvIHRlc3QuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIFkgdmFsdWUgb2YgdGhlIGNvb3JkaW5hdGUgdG8gdGVzdC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgY29vcmRpbmF0ZXMgYXJlIHdpdGhpbiB0aGlzIGNpcmNsZSwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGNvbnRhaW5zOiBmdW5jdGlvbiAoeCwgeSkgewogICAgICAgIHJldHVybiBQaGFzZXIuQ2lyY2xlLmNvbnRhaW5zKHRoaXMsIHgsIHkpOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIFBvaW50IG9iamVjdCBjb250YWluaW5nIHRoZSBjb29yZGluYXRlcyBvZiBhIHBvaW50IG9uIHRoZSBjaXJjdW1mZXJlbmNlIG9mIHRoZSBDaXJjbGUgYmFzZWQgb24gdGhlIGdpdmVuIGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjY2lyY3VtZmVyZW5jZVBvaW50CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBpbiByYWRpYW5zICh1bmxlc3MgYXNEZWdyZWVzIGlzIHRydWUpIHRvIHJldHVybiB0aGUgcG9pbnQgZnJvbS4KICAgICogQHBhcmFtIHtib29sZWFufSBhc0RlZ3JlZXMgLSBJcyB0aGUgZ2l2ZW4gYW5nbGUgaW4gcmFkaWFucyAoZmFsc2UpIG9yIGRlZ3JlZXMgKHRydWUpPwogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW291dF0gLSBBbiBvcHRpb25hbCBQb2ludCBvYmplY3QgdG8gcHV0IHRoZSByZXN1bHQgaW4gdG8uIElmIG5vbmUgc3BlY2lmaWVkIGEgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIFBvaW50IG9iamVjdCBob2xkaW5nIHRoZSByZXN1bHQuCiAgICAqLwogICAgY2lyY3VtZmVyZW5jZVBvaW50OiBmdW5jdGlvbiAoYW5nbGUsIGFzRGVncmVlcywgb3V0KSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5DaXJjbGUuY2lyY3VtZmVyZW5jZVBvaW50KHRoaXMsIGFuZ2xlLCBhc0RlZ3JlZXMsIG91dCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBBZGp1c3RzIHRoZSBsb2NhdGlvbiBvZiB0aGUgQ2lyY2xlIG9iamVjdCwgYXMgZGV0ZXJtaW5lZCBieSBpdHMgY2VudGVyIGNvb3JkaW5hdGUsIGJ5IHRoZSBzcGVjaWZpZWQgYW1vdW50cy4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI29mZnNldAogICAgKiBAcGFyYW0ge251bWJlcn0gZHggLSBNb3ZlcyB0aGUgeCB2YWx1ZSBvZiB0aGUgQ2lyY2xlIG9iamVjdCBieSB0aGlzIGFtb3VudC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGR5IC0gTW92ZXMgdGhlIHkgdmFsdWUgb2YgdGhlIENpcmNsZSBvYmplY3QgYnkgdGhpcyBhbW91bnQuCiAgICAqIEByZXR1cm4ge0NpcmNsZX0gVGhpcyBDaXJjbGUgb2JqZWN0LgogICAgKi8KICAgIG9mZnNldDogZnVuY3Rpb24gKGR4LCBkeSkgewogICAgICAgIHRoaXMueCArPSBkeDsKICAgICAgICB0aGlzLnkgKz0gZHk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8qKgogICAgKiBBZGp1c3RzIHRoZSBsb2NhdGlvbiBvZiB0aGUgQ2lyY2xlIG9iamVjdCB1c2luZyBhIFBvaW50IG9iamVjdCBhcyBhIHBhcmFtZXRlci4gVGhpcyBtZXRob2QgaXMgc2ltaWxhciB0byB0aGUgQ2lyY2xlLm9mZnNldCgpIG1ldGhvZCwgZXhjZXB0IHRoYXQgaXQgdGFrZXMgYSBQb2ludCBvYmplY3QgYXMgYSBwYXJhbWV0ZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNvZmZzZXRQb2ludAogICAgKiBAcGFyYW0ge1BvaW50fSBwb2ludCBBIFBvaW50IG9iamVjdCB0byB1c2UgdG8gb2Zmc2V0IHRoaXMgQ2lyY2xlIG9iamVjdCAob3IgYW55IHZhbGlkIG9iamVjdCB3aXRoIGV4cG9zZWQgeCBhbmQgeSBwcm9wZXJ0aWVzKS4KICAgICogQHJldHVybiB7Q2lyY2xlfSBUaGlzIENpcmNsZSBvYmplY3QuCiAgICAqLwogICAgb2Zmc2V0UG9pbnQ6IGZ1bmN0aW9uIChwb2ludCkgewogICAgICAgIHJldHVybiB0aGlzLm9mZnNldChwb2ludC54LCBwb2ludC55KTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSN0b1N0cmluZwogICAgKiBAcmV0dXJuIHtzdHJpbmd9IGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBpbnN0YW5jZS4KICAgICovCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAiW3tQaGFzZXIuQ2lyY2xlICh4PSIgKyB0aGlzLnggKyAiIHk9IiArIHRoaXMueSArICIgZGlhbWV0ZXI9IiArIHRoaXMuZGlhbWV0ZXIgKyAiIHJhZGl1cz0iICsgdGhpcy5yYWRpdXMgKyAiKX1dIjsKICAgIH0KCn07CgpQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5DaXJjbGU7CgovKioKKiBUaGUgbGFyZ2VzdCBkaXN0YW5jZSBiZXR3ZWVuIGFueSB0d28gcG9pbnRzIG9uIHRoZSBjaXJjbGUuIFRoZSBzYW1lIGFzIHRoZSByYWRpdXMgKiAyLgoqIEBuYW1lIFBoYXNlci5DaXJjbGUjZGlhbWV0ZXIKKiBAcHJvcGVydHkge251bWJlcn0gZGlhbWV0ZXIgLSBHZXRzIG9yIHNldHMgdGhlIGRpYW1ldGVyIG9mIHRoZSBjaXJjbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZSwgImRpYW1ldGVyIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9kaWFtZXRlcjsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuX2RpYW1ldGVyID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuX3JhZGl1cyA9IHZhbHVlICogMC41OwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIGxlbmd0aCBvZiBhIGxpbmUgZXh0ZW5kaW5nIGZyb20gdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlIHRvIGFueSBwb2ludCBvbiB0aGUgY2lyY2xlIGl0c2VsZi4gVGhlIHNhbWUgYXMgaGFsZiB0aGUgZGlhbWV0ZXIuCiogQG5hbWUgUGhhc2VyLkNpcmNsZSNyYWRpdXMKKiBAcHJvcGVydHkge251bWJlcn0gcmFkaXVzIC0gR2V0cyBvciBzZXRzIHRoZSByYWRpdXMgb2YgdGhlIGNpcmNsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DaXJjbGUucHJvdG90eXBlLCAicmFkaXVzIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmFkaXVzOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcmFkaXVzID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuX2RpYW1ldGVyID0gdmFsdWUgKiAyOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgbGVmdG1vc3QgcG9pbnQgb2YgdGhlIGNpcmNsZS4gQ2hhbmdpbmcgdGhlIGxlZnQgcHJvcGVydHkgb2YgYSBDaXJjbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHggYW5kIHkgcHJvcGVydGllcy4gSG93ZXZlciBpdCBkb2VzIGFmZmVjdCB0aGUgZGlhbWV0ZXIsIHdoZXJlYXMgY2hhbmdpbmcgdGhlIHggdmFsdWUgZG9lcyBub3QgYWZmZWN0IHRoZSBkaWFtZXRlciBwcm9wZXJ0eS4KKiBAbmFtZSBQaGFzZXIuQ2lyY2xlI2xlZnQKKiBAcHJvcGV0eSB7bnVtYmVyfSBsZWZ0IC0gR2V0cyBvciBzZXRzIHRoZSB2YWx1ZSBvZiB0aGUgbGVmdG1vc3QgcG9pbnQgb2YgdGhlIGNpcmNsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DaXJjbGUucHJvdG90eXBlLCAibGVmdCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueCAtIHRoaXMuX3JhZGl1czsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiB0aGlzLngpIHsKICAgICAgICAgICAgdGhpcy5fcmFkaXVzID0gMDsKICAgICAgICAgICAgdGhpcy5fZGlhbWV0ZXIgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMucmFkaXVzID0gdGhpcy54IC0gdmFsdWU7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSByaWdodG1vc3QgcG9pbnQgb2YgdGhlIGNpcmNsZS4gQ2hhbmdpbmcgdGhlIHJpZ2h0IHByb3BlcnR5IG9mIGEgQ2lyY2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMuIEhvd2V2ZXIgaXQgZG9lcyBhZmZlY3QgdGhlIGRpYW1ldGVyLCB3aGVyZWFzIGNoYW5naW5nIHRoZSB4IHZhbHVlIGRvZXMgbm90IGFmZmVjdCB0aGUgZGlhbWV0ZXIgcHJvcGVydHkuCiogQG5hbWUgUGhhc2VyLkNpcmNsZSNyaWdodAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSByaWdodCAtIEdldHMgb3Igc2V0cyB0aGUgdmFsdWUgb2YgdGhlIHJpZ2h0bW9zdCBwb2ludCBvZiB0aGUgY2lyY2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUsICJyaWdodCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy54ICsgdGhpcy5fcmFkaXVzOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA8IHRoaXMueCkgewogICAgICAgICAgICB0aGlzLl9yYWRpdXMgPSAwOwogICAgICAgICAgICB0aGlzLl9kaWFtZXRlciA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5yYWRpdXMgPSB2YWx1ZSAtIHRoaXMueDsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBzdW0gb2YgdGhlIHkgbWludXMgdGhlIHJhZGl1cyBwcm9wZXJ0eS4gQ2hhbmdpbmcgdGhlIHRvcCBwcm9wZXJ0eSBvZiBhIENpcmNsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCBhbmQgeSBwcm9wZXJ0aWVzLCBidXQgZG9lcyBjaGFuZ2UgdGhlIGRpYW1ldGVyLgoqIEBuYW1lIFBoYXNlci5DaXJjbGUjdG9wCiogQHByb3BlcnR5IHtudW1iZXJ9IHRvcCAtIEdldHMgb3Igc2V0cyB0aGUgdG9wIG9mIHRoZSBjaXJjbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZSwgInRvcCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy55IC0gdGhpcy5fcmFkaXVzOwogICAgfSwKICAgIAogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiB0aGlzLnkpIHsKICAgICAgICAgICAgdGhpcy5fcmFkaXVzID0gMDsKICAgICAgICAgICAgdGhpcy5fZGlhbWV0ZXIgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMucmFkaXVzID0gdGhpcy55IC0gdmFsdWU7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgc3VtIG9mIHRoZSB5IGFuZCByYWRpdXMgcHJvcGVydGllcy4gQ2hhbmdpbmcgdGhlIGJvdHRvbSBwcm9wZXJ0eSBvZiBhIENpcmNsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCBhbmQgeSBwcm9wZXJ0aWVzLCBidXQgZG9lcyBjaGFuZ2UgdGhlIGRpYW1ldGVyLgoqIEBuYW1lIFBoYXNlci5DaXJjbGUjYm90dG9tCiogQHByb3BlcnR5IHtudW1iZXJ9IGJvdHRvbSAtIEdldHMgb3Igc2V0cyB0aGUgYm90dG9tIG9mIHRoZSBjaXJjbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZSwgImJvdHRvbSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy55ICsgdGhpcy5fcmFkaXVzOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodmFsdWUgPCB0aGlzLnkpIHsKICAgICAgICAgICAgdGhpcy5fcmFkaXVzID0gMDsKICAgICAgICAgICAgdGhpcy5fZGlhbWV0ZXIgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMucmFkaXVzID0gdmFsdWUgLSB0aGlzLnk7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgYXJlYSBvZiB0aGlzIENpcmNsZS4KKiBAbmFtZSBQaGFzZXIuQ2lyY2xlI2FyZWEKKiBAcHJvcGVydHkge251bWJlcn0gYXJlYSAtIFRoZSBhcmVhIG9mIHRoaXMgY2lyY2xlLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUsICJhcmVhIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIGlmICh0aGlzLl9yYWRpdXMgPiAwKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLlBJICogdGhpcy5fcmFkaXVzICogdGhpcy5fcmFkaXVzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIG9yIG5vdCB0aGlzIENpcmNsZSBvYmplY3QgaXMgZW1wdHkuIFdpbGwgcmV0dXJuIGEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgQ2lyY2xlIG9iamVjdHMgZGlhbWV0ZXIgaXMgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIDA7IG90aGVyd2lzZSBmYWxzZS4KKiBJZiBzZXQgdG8gdHJ1ZSBpdCB3aWxsIHJlc2V0IGFsbCBvZiB0aGUgQ2lyY2xlIG9iamVjdHMgcHJvcGVydGllcyB0byAwLiBBIENpcmNsZSBvYmplY3QgaXMgZW1wdHkgaWYgaXRzIGRpYW1ldGVyIGlzIGxlc3MgdGhhbiBvciBlcXVhbCB0byAwLgoqIEBuYW1lIFBoYXNlci5DaXJjbGUjZW1wdHkKKiBAcHJvcGVydHkge2Jvb2xlYW59IGVtcHR5IC0gR2V0cyBvciBzZXRzIHRoZSBlbXB0eSBzdGF0ZSBvZiB0aGUgY2lyY2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUsICJlbXB0eSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKHRoaXMuX2RpYW1ldGVyID09PSAwKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHZhbHVlID09PSB0cnVlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zZXRUbygwLCAwLCAwKTsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBSZXR1cm4gdHJ1ZSBpZiB0aGUgZ2l2ZW4geC95IGNvb3JkaW5hdGVzIGFyZSB3aXRoaW4gdGhlIENpcmNsZSBvYmplY3QuCiogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlLmNvbnRhaW5zCiogQHBhcmFtIHtQaGFzZXIuQ2lyY2xlfSBhIC0gVGhlIENpcmNsZSB0byBiZSBjaGVja2VkLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIFggdmFsdWUgb2YgdGhlIGNvb3JkaW5hdGUgdG8gdGVzdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBZIHZhbHVlIG9mIHRoZSBjb29yZGluYXRlIHRvIHRlc3QuCiogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgY29vcmRpbmF0ZXMgYXJlIHdpdGhpbiB0aGlzIGNpcmNsZSwgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuQ2lyY2xlLmNvbnRhaW5zID0gZnVuY3Rpb24gKGEsIHgsIHkpIHsKCiAgICAvLyAgQ2hlY2sgaWYgeC95IGFyZSB3aXRoaW4gdGhlIGJvdW5kcyBmaXJzdAogICAgaWYgKHggPj0gYS5sZWZ0ICYmIHggPD0gYS5yaWdodCAmJiB5ID49IGEudG9wICYmIHkgPD0gYS5ib3R0b20pIHsKCiAgICAgICAgdmFyIGR4ID0gKGEueCAtIHgpICogKGEueCAtIHgpOwogICAgICAgIHZhciBkeSA9IChhLnkgLSB5KSAqIChhLnkgLSB5KTsKCiAgICAgICAgcmV0dXJuIChkeCArIGR5KSA8PSAoYS5yYWRpdXMgKiBhLnJhZGl1cyk7CgogICAgfQoKICAgIHJldHVybiBmYWxzZTsKCn07CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHR3byBDaXJjbGUgb2JqZWN0cyBtYXRjaC4gVGhpcyBtZXRob2QgY29tcGFyZXMgdGhlIHgsIHkgYW5kIGRpYW1ldGVyIHByb3BlcnRpZXMuCiogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlLmVxdWFscwoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYSAtIFRoZSBmaXJzdCBDaXJjbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYiAtIFRoZSBzZWNvbmQgQ2lyY2xlIG9iamVjdC4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIG9iamVjdCBoYXMgZXhhY3RseSB0aGUgc2FtZSB2YWx1ZXMgZm9yIHRoZSB4LCB5IGFuZCBkaWFtZXRlciBwcm9wZXJ0aWVzIGFzIHRoaXMgQ2lyY2xlIG9iamVjdDsgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuQ2lyY2xlLmVxdWFscyA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICByZXR1cm4gKGEueCA9PSBiLnggJiYgYS55ID09IGIueSAmJiBhLmRpYW1ldGVyID09IGIuZGlhbWV0ZXIpOwp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSB0d28gQ2lyY2xlIG9iamVjdHMgaW50ZXJzZWN0LgoqIFRoaXMgbWV0aG9kIGNoZWNrcyB0aGUgcmFkaXVzIGRpc3RhbmNlcyBiZXR3ZWVuIHRoZSB0d28gQ2lyY2xlIG9iamVjdHMgdG8gc2VlIGlmIHRoZXkgaW50ZXJzZWN0LgoqIEBtZXRob2QgUGhhc2VyLkNpcmNsZS5pbnRlcnNlY3RzCiogQHBhcmFtIHtQaGFzZXIuQ2lyY2xlfSBhIC0gVGhlIGZpcnN0IENpcmNsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuQ2lyY2xlfSBiIC0gVGhlIHNlY29uZCBDaXJjbGUgb2JqZWN0LgoqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBpbnRlcnNlY3RzIHdpdGggdGhpcyBDaXJjbGUgb2JqZWN0OyBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5DaXJjbGUuaW50ZXJzZWN0cyA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICByZXR1cm4gKFBoYXNlci5NYXRoLmRpc3RhbmNlKGEueCwgYS55LCBiLngsIGIueSkgPD0gKGEucmFkaXVzICsgYi5yYWRpdXMpKTsKfTsKCi8qKgoqIFJldHVybnMgYSBQb2ludCBvYmplY3QgY29udGFpbmluZyB0aGUgY29vcmRpbmF0ZXMgb2YgYSBwb2ludCBvbiB0aGUgY2lyY3VtZmVyZW5jZSBvZiB0aGUgQ2lyY2xlIGJhc2VkIG9uIHRoZSBnaXZlbiBhbmdsZS4KKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUuY2lyY3VtZmVyZW5jZVBvaW50CiogQHBhcmFtIHtQaGFzZXIuQ2lyY2xlfSBhIC0gVGhlIGZpcnN0IENpcmNsZSBvYmplY3QuCiogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMgKHVubGVzcyBhc0RlZ3JlZXMgaXMgdHJ1ZSkgdG8gcmV0dXJuIHRoZSBwb2ludCBmcm9tLgoqIEBwYXJhbSB7Ym9vbGVhbn0gYXNEZWdyZWVzIC0gSXMgdGhlIGdpdmVuIGFuZ2xlIGluIHJhZGlhbnMgKGZhbHNlKSBvciBkZWdyZWVzICh0cnVlKT8KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW291dF0gLSBBbiBvcHRpb25hbCBQb2ludCBvYmplY3QgdG8gcHV0IHRoZSByZXN1bHQgaW4gdG8uIElmIG5vbmUgc3BlY2lmaWVkIGEgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgUG9pbnQgb2JqZWN0IGhvbGRpbmcgdGhlIHJlc3VsdC4KKi8KUGhhc2VyLkNpcmNsZS5jaXJjdW1mZXJlbmNlUG9pbnQgPSBmdW5jdGlvbiAoYSwgYW5nbGUsIGFzRGVncmVlcywgb3V0KSB7CgogICAgaWYgKHR5cGVvZiBhc0RlZ3JlZXMgPT09ICJ1bmRlZmluZWQiKSB7IGFzRGVncmVlcyA9IGZhbHNlOyB9CiAgICBpZiAodHlwZW9mIG91dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0ID0gbmV3IFBoYXNlci5Qb2ludCgpOyB9CgogICAgaWYgKGFzRGVncmVlcyA9PT0gdHJ1ZSkgewogICAgICAgIGFuZ2xlID0gUGhhc2VyLk1hdGgucmFkVG9EZWcoYW5nbGUpOwogICAgfQoKICAgIG91dC54ID0gYS54ICsgYS5yYWRpdXMgKiBNYXRoLmNvcyhhbmdsZSk7CiAgICBvdXQueSA9IGEueSArIGEucmFkaXVzICogTWF0aC5zaW4oYW5nbGUpOwoKICAgIHJldHVybiBvdXQ7Cgp9OwoKLyoqCiogQ2hlY2tzIGlmIHRoZSBnaXZlbiBDaXJjbGUgYW5kIFJlY3RhbmdsZSBvYmplY3RzIGludGVyc2VjdC4KKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUuaW50ZXJzZWN0c1JlY3RhbmdsZQoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYyAtIFRoZSBDaXJjbGUgb2JqZWN0IHRvIHRlc3QuCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSByIC0gVGhlIFJlY3RhbmdsZSBvYmplY3QgdG8gdGVzdC4KKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSB0d28gb2JqZWN0cyBpbnRlcnNlY3QsIG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLkNpcmNsZS5pbnRlcnNlY3RzUmVjdGFuZ2xlID0gZnVuY3Rpb24gKGMsIHIpIHsKCiAgICB2YXIgY3ggPSBNYXRoLmFicyhjLnggLSByLnggLSByLmhhbGZXaWR0aCk7CiAgICB2YXIgeERpc3QgPSByLmhhbGZXaWR0aCArIGMucmFkaXVzOwoKICAgIGlmIChjeCA+IHhEaXN0KSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHZhciBjeSA9IE1hdGguYWJzKGMueSAtIHIueSAtIHIuaGFsZkhlaWdodCk7CiAgICB2YXIgeURpc3QgPSByLmhhbGZIZWlnaHQgKyBjLnJhZGl1czsKCiAgICBpZiAoY3kgPiB5RGlzdCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBpZiAoY3ggPD0gci5oYWxmV2lkdGggfHwgY3kgPD0gci5oYWxmSGVpZ2h0KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgdmFyIHhDb3JuZXJEaXN0ID0gY3ggLSByLmhhbGZXaWR0aDsKICAgIHZhciB5Q29ybmVyRGlzdCA9IGN5IC0gci5oYWxmSGVpZ2h0OwogICAgdmFyIHhDb3JuZXJEaXN0U3EgPSB4Q29ybmVyRGlzdCAqIHhDb3JuZXJEaXN0OwogICAgdmFyIHlDb3JuZXJEaXN0U3EgPSB5Q29ybmVyRGlzdCAqIHlDb3JuZXJEaXN0OwogICAgdmFyIG1heENvcm5lckRpc3RTcSA9IGMucmFkaXVzICogYy5yYWRpdXM7CgogICAgcmV0dXJuIHhDb3JuZXJEaXN0U3EgKyB5Q29ybmVyRGlzdFNxIDw9IG1heENvcm5lckRpc3RTcTsKCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGVzIGEgbmV3IFBvaW50LiBJZiB5b3UgcGFzcyBubyBwYXJhbWV0ZXJzIGEgUG9pbnQgaXMgY3JlYXRlZCBzZXQgdG8gKDAsMCkuCiogQGNsYXNzIFBoYXNlci5Qb2ludAoqIEBjbGFzc2Rlc2MgVGhlIFBvaW50IG9iamVjdCByZXByZXNlbnRzIGEgbG9jYXRpb24gaW4gYSB0d28tZGltZW5zaW9uYWwgY29vcmRpbmF0ZSBzeXN0ZW0sIHdoZXJlIHggcmVwcmVzZW50cyB0aGUgaG9yaXpvbnRhbCBheGlzIGFuZCB5IHJlcHJlc2VudHMgdGhlIHZlcnRpY2FsIGF4aXMuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtudW1iZXJ9IHggVGhlIGhvcml6b250YWwgcG9zaXRpb24gb2YgdGhpcyBQb2ludCAoZGVmYXVsdCAwKQoqIEBwYXJhbSB7bnVtYmVyfSB5IFRoZSB2ZXJ0aWNhbCBwb3NpdGlvbiBvZiB0aGlzIFBvaW50IChkZWZhdWx0IDApCiovClBoYXNlci5Qb2ludCA9IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgeCA9IHggfHwgMDsKICAgIHkgPSB5IHx8IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgcG9pbnQuCiAgICAqLwogICAgdGhpcy54ID0geDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgcG9pbnQuCiAgICAqLwogICAgdGhpcy55ID0geTsKCn07CgpQaGFzZXIuUG9pbnQucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBDb3BpZXMgdGhlIHggYW5kIHkgcHJvcGVydGllcyBmcm9tIGFueSBnaXZlbiBvYmplY3QgdG8gdGhpcyBQb2ludC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjY29weUZyb20KICAgICogQHBhcmFtIHthbnl9IHNvdXJjZSAtIFRoZSBvYmplY3QgdG8gY29weSBmcm9tLgogICAgKiBAcmV0dXJuIHtQb2ludH0gVGhpcyBQb2ludCBvYmplY3QuCiAgICAqLwogICAgY29weUZyb206IGZ1bmN0aW9uIChzb3VyY2UpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRUbyhzb3VyY2UueCwgc291cmNlLnkpOwogICAgfSwKCiAgICAvKioKICAgICogSW52ZXJ0cyB0aGUgeCBhbmQgeSB2YWx1ZXMgb2YgdGhpcyBQb2ludAogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNpbnZlcnQKICAgICogQHJldHVybiB7UG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LgogICAgKi8KICAgIGludmVydDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnNldFRvKHRoaXMueSwgdGhpcy54KTsKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIHggYW5kIHkgdmFsdWVzIG9mIHRoaXMgUG9pbnQgb2JqZWN0IHRvIHRoZSBnaXZlbiBjb29yZGluYXRlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjc2V0VG8KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgaG9yaXpvbnRhbCBwb3NpdGlvbiBvZiB0aGlzIHBvaW50LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2ZXJ0aWNhbCBwb3NpdGlvbiBvZiB0aGlzIHBvaW50LgogICAgKiBAcmV0dXJuIHtQb2ludH0gVGhpcyBQb2ludCBvYmplY3QuIFVzZWZ1bCBmb3IgY2hhaW5pbmcgbWV0aG9kIGNhbGxzLgogICAgKi8KICAgIHNldFRvOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnggPSB4OwogICAgICAgIHRoaXMueSA9IHk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIHRoZSBnaXZlbiB4IGFuZCB5IHZhbHVlcyB0byB0aGlzIFBvaW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNhZGQKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgdG8gYWRkIHRvIFBvaW50LnguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIHRvIGFkZCB0byBQb2ludC55LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LiBVc2VmdWwgZm9yIGNoYWluaW5nIG1ldGhvZCBjYWxscy4KICAgICovCiAgICBhZGQ6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMueCArPSB4OwogICAgICAgIHRoaXMueSArPSB5OwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4geCBhbmQgeSB2YWx1ZXMgZnJvbSB0aGlzIFBvaW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNzdWJ0cmFjdAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB2YWx1ZSB0byBzdWJ0cmFjdCBmcm9tIFBvaW50LnguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIHRvIHN1YnRyYWN0IGZyb20gUG9pbnQueS4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGlzIFBvaW50IG9iamVjdC4gVXNlZnVsIGZvciBjaGFpbmluZyBtZXRob2QgY2FsbHMuCiAgICAqLwogICAgc3VidHJhY3Q6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMueCAtPSB4OwogICAgICAgIHRoaXMueSAtPSB5OwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIE11bHRpcGxpZXMgUG9pbnQueCBhbmQgUG9pbnQueSBieSB0aGUgZ2l2ZW4geCBhbmQgeSB2YWx1ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I211bHRpcGx5CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHZhbHVlIHRvIG11bHRpcGx5IFBvaW50LnggYnkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIHRvIG11bHRpcGx5IFBvaW50LnggYnkuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhpcyBQb2ludCBvYmplY3QuIFVzZWZ1bCBmb3IgY2hhaW5pbmcgbWV0aG9kIGNhbGxzLgogICAgKi8KICAgIG11bHRpcGx5OiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnggKj0geDsKICAgICAgICB0aGlzLnkgKj0geTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBEaXZpZGVzIFBvaW50LnggYW5kIFBvaW50LnkgYnkgdGhlIGdpdmVuIHggYW5kIHkgdmFsdWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNkaXZpZGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgdG8gZGl2aWRlIFBvaW50LnggYnkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIHRvIGRpdmlkZSBQb2ludC54IGJ5LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LiBVc2VmdWwgZm9yIGNoYWluaW5nIG1ldGhvZCBjYWxscy4KICAgICovCiAgICBkaXZpZGU6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMueCAvPSB4OwogICAgICAgIHRoaXMueSAvPSB5OwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENsYW1wcyB0aGUgeCB2YWx1ZSBvZiB0aGlzIFBvaW50IHRvIGJlIGJldHdlZW4gdGhlIGdpdmVuIG1pbiBhbmQgbWF4LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNjbGFtcFgKICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIHZhbHVlIHRvIGNsYW1wIHRoaXMgUG9pbnQgdG8uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYXggLSBUaGUgbWF4aW11bSB2YWx1ZSB0byBjbGFtcCB0aGlzIFBvaW50IHRvLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LgogICAgKi8KICAgIGNsYW1wWDogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgogICAgICAgIHRoaXMueCA9IFBoYXNlci5NYXRoLmNsYW1wKHRoaXMueCwgbWluLCBtYXgpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogQ2xhbXBzIHRoZSB5IHZhbHVlIG9mIHRoaXMgUG9pbnQgdG8gYmUgYmV0d2VlbiB0aGUgZ2l2ZW4gbWluIGFuZCBtYXgKICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjY2xhbXBZCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSB0byBjbGFtcCB0aGlzIFBvaW50IHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gdmFsdWUgdG8gY2xhbXAgdGhpcyBQb2ludCB0by4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGlzIFBvaW50IG9iamVjdC4KICAgICovCiAgICBjbGFtcFk6IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKICAgICAgICB0aGlzLnkgPSBQaGFzZXIuTWF0aC5jbGFtcCh0aGlzLnksIG1pbiwgbWF4KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIENsYW1wcyB0aGlzIFBvaW50IG9iamVjdCB2YWx1ZXMgdG8gYmUgYmV0d2VlbiB0aGUgZ2l2ZW4gbWluIGFuZCBtYXguCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2NsYW1wCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSB0byBjbGFtcCB0aGlzIFBvaW50IHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gdmFsdWUgdG8gY2xhbXAgdGhpcyBQb2ludCB0by4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGlzIFBvaW50IG9iamVjdC4KICAgICovCiAgICBjbGFtcDogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgogICAgICAgIHRoaXMueCA9IFBoYXNlci5NYXRoLmNsYW1wKHRoaXMueCwgbWluLCBtYXgpOwogICAgICAgIHRoaXMueSA9IFBoYXNlci5NYXRoLmNsYW1wKHRoaXMueSwgbWluLCBtYXgpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBjb3B5IG9mIHRoZSBnaXZlbiBQb2ludC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjY2xvbmUKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRwdXRdIE9wdGlvbmFsIFBvaW50IG9iamVjdC4gSWYgZ2l2ZW4gdGhlIHZhbHVlcyB3aWxsIGJlIHNldCBpbnRvIHRoaXMgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUG9pbnQgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIG5ldyBQb2ludCBvYmplY3QuCiAgICAqLwogICAgY2xvbmU6IGZ1bmN0aW9uIChvdXRwdXQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBvdXRwdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dHB1dCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsgfQoKICAgICAgICByZXR1cm4gb3V0cHV0LnNldFRvKHRoaXMueCwgdGhpcy55KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDb3BpZXMgdGhlIHggYW5kIHkgcHJvcGVydGllcyBmcm9tIHRoaXMgUG9pbnQgdG8gYW55IGdpdmVuIG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjY29weVRvCiAgICAqIEBwYXJhbSB7YW55fSBkZXN0IC0gVGhlIG9iamVjdCB0byBjb3B5IHRvLgogICAgKiBAcmV0dXJuIHtPYmplY3R9IFRoZSBkZXN0IG9iamVjdC4KICAgICovCiAgICBjb3B5VG86IGZ1bmN0aW9uKGRlc3QpIHsKCiAgICAgICAgZGVzdC54ID0gdGhpcy54OwogICAgICAgIGRlc3QueSA9IHRoaXMueTsKCiAgICAgICAgcmV0dXJuIGRlc3Q7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgZGlzdGFuY2Ugb2YgdGhpcyBQb2ludCBvYmplY3QgdG8gdGhlIGdpdmVuIG9iamVjdCAoY2FuIGJlIGEgQ2lyY2xlLCBQb2ludCBvciBhbnl0aGluZyB3aXRoIHgveSBwcm9wZXJ0aWVzKQogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNkaXN0YW5jZQogICAgKiBAcGFyYW0ge29iamVjdH0gZGVzdCAtIFRoZSB0YXJnZXQgb2JqZWN0LiBNdXN0IGhhdmUgdmlzaWJsZSB4IGFuZCB5IHByb3BlcnRpZXMgdGhhdCByZXByZXNlbnQgdGhlIGNlbnRlciBvZiB0aGUgb2JqZWN0LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyb3VuZF0gLSBSb3VuZCB0aGUgZGlzdGFuY2UgdG8gdGhlIG5lYXJlc3QgaW50ZWdlciAoZGVmYXVsdCBmYWxzZSkuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhpcyBQb2ludCBvYmplY3QgYW5kIHRoZSBkZXN0aW5hdGlvbiBQb2ludCBvYmplY3QuCiAgICAqLwogICAgZGlzdGFuY2U6IGZ1bmN0aW9uIChkZXN0LCByb3VuZCkgewogICAgICAgIHJldHVybiBQaGFzZXIuUG9pbnQuZGlzdGFuY2UodGhpcywgZGVzdCwgcm91bmQpOwogICAgfSwKCiAgICAvKioKICAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBnaXZlbiBvYmplY3RzIHgveSB2YWx1ZXMgYXJlIGVxdWFsIHRvIHRoaXMgUG9pbnQgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNlcXVhbHMKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGEgLSBUaGUgZmlyc3Qgb2JqZWN0IHRvIGNvbXBhcmUuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUG9pbnRzIGFyZSBlcXVhbCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGVxdWFsczogZnVuY3Rpb24gKGEpIHsKICAgICAgICByZXR1cm4gKGEueCA9PSB0aGlzLnggJiYgYS55ID09IHRoaXMueSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSb3RhdGVzIHRoaXMgUG9pbnQgYXJvdW5kIHRoZSB4L3kgY29vcmRpbmF0ZXMgZ2l2ZW4gdG8gdGhlIGRlc2lyZWQgYW5nbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I3JvdGF0ZQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGFuY2hvciBwb2ludAogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIGFuY2hvciBwb2ludAogICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgaW4gcmFkaWFucyAodW5sZXNzIGFzRGVncmVlcyBpcyB0cnVlKSB0byByb3RhdGUgdGhlIFBvaW50IHRvLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGFzRGVncmVlcyAtIElzIHRoZSBnaXZlbiByb3RhdGlvbiBpbiByYWRpYW5zIChmYWxzZSkgb3IgZGVncmVlcyAodHJ1ZSk/CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZGlzdGFuY2VdIC0gQW4gb3B0aW9uYWwgZGlzdGFuY2UgY29uc3RyYWludCBiZXR3ZWVuIHRoZSBQb2ludCBhbmQgdGhlIGFuY2hvci4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgbW9kaWZpZWQgcG9pbnQgb2JqZWN0LgogICAgKi8KICAgIHJvdGF0ZTogZnVuY3Rpb24gKHgsIHksIGFuZ2xlLCBhc0RlZ3JlZXMsIGRpc3RhbmNlKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5Qb2ludC5yb3RhdGUodGhpcywgeCwgeSwgYW5nbGUsIGFzRGVncmVlcywgZGlzdGFuY2UpOwogICAgfSwKCiAgICAvKioKICAgICogQ2FsY3VsYXRlcyB0aGUgbGVuZ3RoIG9mIHRoZSB2ZWN0b3IKICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjZ2V0TWFnbml0dWRlCiAgICAqIEByZXR1cm4ge251bWJlcn0gdGhlIGxlbmd0aCBvZiB0aGUgdmVjdG9yCiAgICAqLwogICAgZ2V0TWFnbml0dWRlOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KCh0aGlzLnggKiB0aGlzLngpICsgKHRoaXMueSAqIHRoaXMueSkpOwogICAgfSwKCiAgICAvKioKICAgICogQWx0ZXJzIHRoZSBsZW5ndGggb2YgdGhlIHZlY3RvciB3aXRob3V0IGNoYW5naW5nIHRoZSBkaXJlY3Rpb24KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjZ2V0TWFnbml0dWRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYWduaXR1ZGUgdGhlIGRlc2lyZWQgbWFnbml0dWRlIG9mIHRoZSByZXN1bHRpbmcgdmVjdG9yCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gdGhlIG1vZGlmaWVkIG9yaWdpbmFsIHZlY3RvcgogICAgKi8KICAgIHNldE1hZ25pdHVkZTogZnVuY3Rpb24obWFnbml0dWRlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplKCkubXVsdGlwbHkobWFnbml0dWRlLCBtYWduaXR1ZGUpOwogICAgfSwKCiAgICAvKioKICAgICogQWx0ZXJzIHRoZSB2ZWN0b3Igc28gdGhhdCBpdHMgbGVuZ3RoIGlzIDEsIGJ1dCBpdCByZXRhaW5zIHRoZSBzYW1lIGRpcmVjdGlvbgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNub3JtYWxpemUKICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSB0aGUgbW9kaWZpZWQgb3JpZ2luYWwgdmVjdG9yCiAgICAqLwogICAgbm9ybWFsaXplOiBmdW5jdGlvbigpIHsKCiAgICAgICAgaWYoIXRoaXMuaXNaZXJvKCkpIHsKICAgICAgICAgICAgdmFyIG0gPSB0aGlzLmdldE1hZ25pdHVkZSgpOwogICAgICAgICAgICB0aGlzLnggLz0gbTsKICAgICAgICAgICAgdGhpcy55IC89IG07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBEZXRlcm1pbmUgaWYgdGhpcyBwb2ludCBpcyBhdCAwLDAKICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjaXNaZXJvCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBQb2ludCBpcyAwLDAsIG90aGVyd2lzZSBmYWxzZQogICAgKi8KICAgIGlzWmVybzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLnggPT09IDAgJiYgdGhpcy55ID09PSAwKTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I3RvU3RyaW5nCiAgICAqIEByZXR1cm4ge3N0cmluZ30gQSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGluc3RhbmNlLgogICAgKi8KICAgIHRvU3RyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICdbe1BvaW50ICh4PScgKyB0aGlzLnggKyAnIHk9JyArIHRoaXMueSArICcpfV0nOwogICAgfQoKfTsKClBoYXNlci5Qb2ludC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuUG9pbnQ7CgovKioKKiBBZGRzIHRoZSBjb29yZGluYXRlcyBvZiB0d28gcG9pbnRzIHRvZ2V0aGVyIHRvIGNyZWF0ZSBhIG5ldyBwb2ludC4KKiBAbWV0aG9kIFBoYXNlci5Qb2ludC5hZGQKKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYSAtIFRoZSBmaXJzdCBQb2ludCBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGIgLSBUaGUgc2Vjb25kIFBvaW50IG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW291dF0gLSBPcHRpb25hbCBQb2ludCB0byBzdG9yZSB0aGUgdmFsdWUgaW4sIGlmIG5vdCBzdXBwbGllZCBhIG5ldyBQb2ludCBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIG5ldyBQb2ludCBvYmplY3QuCiovClBoYXNlci5Qb2ludC5hZGQgPSBmdW5jdGlvbiAoYSwgYiwgb3V0KSB7CgogICAgaWYgKHR5cGVvZiBvdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsgfQoKICAgIG91dC54ID0gYS54ICsgYi54OwogICAgb3V0LnkgPSBhLnkgKyBiLnk7CgogICAgcmV0dXJuIG91dDsKCn07CgovKioKKiBTdWJ0cmFjdHMgdGhlIGNvb3JkaW5hdGVzIG9mIHR3byBwb2ludHMgdG8gY3JlYXRlIGEgbmV3IHBvaW50LgoqIEBtZXRob2QgUGhhc2VyLlBvaW50LnN1YnRyYWN0CiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGEgLSBUaGUgZmlyc3QgUG9pbnQgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBiIC0gVGhlIHNlY29uZCBQb2ludCBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRdIC0gT3B0aW9uYWwgUG9pbnQgdG8gc3RvcmUgdGhlIHZhbHVlIGluLCBpZiBub3Qgc3VwcGxpZWQgYSBuZXcgUG9pbnQgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZC4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBuZXcgUG9pbnQgb2JqZWN0LgoqLwpQaGFzZXIuUG9pbnQuc3VidHJhY3QgPSBmdW5jdGlvbiAoYSwgYiwgb3V0KSB7CgogICAgaWYgKHR5cGVvZiBvdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsgfQoKICAgIG91dC54ID0gYS54IC0gYi54OwogICAgb3V0LnkgPSBhLnkgLSBiLnk7CgogICAgcmV0dXJuIG91dDsKCn07CgovKioKKiBNdWx0aXBsaWVzIHRoZSBjb29yZGluYXRlcyBvZiB0d28gcG9pbnRzIHRvIGNyZWF0ZSBhIG5ldyBwb2ludC4KKiBAbWV0aG9kIFBoYXNlci5Qb2ludC5tdWx0aXBseQoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBhIC0gVGhlIGZpcnN0IFBvaW50IG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYiAtIFRoZSBzZWNvbmQgUG9pbnQgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbb3V0XSAtIE9wdGlvbmFsIFBvaW50IHRvIHN0b3JlIHRoZSB2YWx1ZSBpbiwgaWYgbm90IHN1cHBsaWVkIGEgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgbmV3IFBvaW50IG9iamVjdC4KKi8KUGhhc2VyLlBvaW50Lm11bHRpcGx5ID0gZnVuY3Rpb24gKGEsIGIsIG91dCkgewoKICAgIGlmICh0eXBlb2Ygb3V0ID09PSAidW5kZWZpbmVkIikgeyBvdXQgPSBuZXcgUGhhc2VyLlBvaW50KCk7IH0KCiAgICBvdXQueCA9IGEueCAqIGIueDsKICAgIG91dC55ID0gYS55ICogYi55OwoKICAgIHJldHVybiBvdXQ7Cgp9OwoKLyoqCiogRGl2aWRlcyB0aGUgY29vcmRpbmF0ZXMgb2YgdHdvIHBvaW50cyB0byBjcmVhdGUgYSBuZXcgcG9pbnQuCiogQG1ldGhvZCBQaGFzZXIuUG9pbnQuZGl2aWRlCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGEgLSBUaGUgZmlyc3QgUG9pbnQgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBiIC0gVGhlIHNlY29uZCBQb2ludCBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRdIC0gT3B0aW9uYWwgUG9pbnQgdG8gc3RvcmUgdGhlIHZhbHVlIGluLCBpZiBub3Qgc3VwcGxpZWQgYSBuZXcgUG9pbnQgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZC4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBuZXcgUG9pbnQgb2JqZWN0LgoqLwpQaGFzZXIuUG9pbnQuZGl2aWRlID0gZnVuY3Rpb24gKGEsIGIsIG91dCkgewoKICAgIGlmICh0eXBlb2Ygb3V0ID09PSAidW5kZWZpbmVkIikgeyBvdXQgPSBuZXcgUGhhc2VyLlBvaW50KCk7IH0KCiAgICBvdXQueCA9IGEueCAvIGIueDsKICAgIG91dC55ID0gYS55IC8gYi55OwoKICAgIHJldHVybiBvdXQ7Cgp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSB0d28gZ2l2ZW4gUG9pbnQgb2JqZWN0cyBhcmUgZXF1YWwuIFRoZXkgYXJlIGNvbnNpZGVyZWQgZXF1YWwgaWYgdGhleSBoYXZlIHRoZSBzYW1lIHggYW5kIHkgdmFsdWVzLgoqIEBtZXRob2QgUGhhc2VyLlBvaW50LmVxdWFscwoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBhIC0gVGhlIGZpcnN0IFBvaW50IG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYiAtIFRoZSBzZWNvbmQgUG9pbnQgb2JqZWN0LgoqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUG9pbnRzIGFyZSBlcXVhbCwgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuUG9pbnQuZXF1YWxzID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgIHJldHVybiAoYS54ID09IGIueCAmJiBhLnkgPT0gYi55KTsKfTsKCi8qKgoqIFJldHVybnMgdGhlIGRpc3RhbmNlIG9mIHRoaXMgUG9pbnQgb2JqZWN0IHRvIHRoZSBnaXZlbiBvYmplY3QgKGNhbiBiZSBhIENpcmNsZSwgUG9pbnQgb3IgYW55dGhpbmcgd2l0aCB4L3kgcHJvcGVydGllcykuCiogQG1ldGhvZCBQaGFzZXIuUG9pbnQuZGlzdGFuY2UKKiBAcGFyYW0ge29iamVjdH0gYSAtIFRoZSB0YXJnZXQgb2JqZWN0LiBNdXN0IGhhdmUgdmlzaWJsZSB4IGFuZCB5IHByb3BlcnRpZXMgdGhhdCByZXByZXNlbnQgdGhlIGNlbnRlciBvZiB0aGUgb2JqZWN0LgoqIEBwYXJhbSB7b2JqZWN0fSBiIC0gVGhlIHRhcmdldCBvYmplY3QuIE11c3QgaGF2ZSB2aXNpYmxlIHggYW5kIHkgcHJvcGVydGllcyB0aGF0IHJlcHJlc2VudCB0aGUgY2VudGVyIG9mIHRoZSBvYmplY3QuCiogQHBhcmFtIHtib29sZWFufSBbcm91bmRdIC0gUm91bmQgdGhlIGRpc3RhbmNlIHRvIHRoZSBuZWFyZXN0IGludGVnZXIgKGRlZmF1bHQgZmFsc2UpLgoqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhpcyBQb2ludCBvYmplY3QgYW5kIHRoZSBkZXN0aW5hdGlvbiBQb2ludCBvYmplY3QuCiovClBoYXNlci5Qb2ludC5kaXN0YW5jZSA9IGZ1bmN0aW9uIChhLCBiLCByb3VuZCkgewoKICAgIGlmICh0eXBlb2Ygcm91bmQgPT09ICJ1bmRlZmluZWQiKSB7IHJvdW5kID0gZmFsc2UgfQoKICAgIGlmIChyb3VuZCkKICAgIHsKICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGguZGlzdGFuY2VSb3VuZChhLngsIGEueSwgYi54LCBiLnkpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHJldHVybiBQaGFzZXIuTWF0aC5kaXN0YW5jZShhLngsIGEueSwgYi54LCBiLnkpOwogICAgfQoKfTsKCi8qKgoqIFJvdGF0ZXMgYSBQb2ludCBhcm91bmQgdGhlIHgveSBjb29yZGluYXRlcyBnaXZlbiB0byB0aGUgZGVzaXJlZCBhbmdsZS4KKiBAbWV0aG9kIFBoYXNlci5Qb2ludC5yb3RhdGUKKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYSAtIFRoZSBQb2ludCBvYmplY3QgdG8gcm90YXRlLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgYW5jaG9yIHBvaW50CiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBhbmNob3IgcG9pbnQKKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgaW4gcmFkaWFucyAodW5sZXNzIGFzRGVncmVlcyBpcyB0cnVlKSB0byByb3RhdGUgdGhlIFBvaW50IHRvLgoqIEBwYXJhbSB7Ym9vbGVhbn0gYXNEZWdyZWVzIC0gSXMgdGhlIGdpdmVuIHJvdGF0aW9uIGluIHJhZGlhbnMgKGZhbHNlKSBvciBkZWdyZWVzICh0cnVlKT8KKiBAcGFyYW0ge251bWJlcn0gZGlzdGFuY2UgLSBBbiBvcHRpb25hbCBkaXN0YW5jZSBjb25zdHJhaW50IGJldHdlZW4gdGhlIFBvaW50IGFuZCB0aGUgYW5jaG9yLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIG1vZGlmaWVkIHBvaW50IG9iamVjdC4KKi8KUGhhc2VyLlBvaW50LnJvdGF0ZSA9IGZ1bmN0aW9uIChhLCB4LCB5LCBhbmdsZSwgYXNEZWdyZWVzLCBkaXN0YW5jZSkgewoKICAgIGFzRGVncmVlcyA9IGFzRGVncmVlcyB8fCBmYWxzZTsKICAgIGRpc3RhbmNlID0gZGlzdGFuY2UgfHwgbnVsbDsKCiAgICBpZiAoYXNEZWdyZWVzKQogICAgewogICAgICAgIGFuZ2xlID0gUGhhc2VyLk1hdGguZGVnVG9SYWQoYW5nbGUpOwogICAgfQoKICAgIC8vICBHZXQgZGlzdGFuY2UgZnJvbSBvcmlnaW4gKGN4L2N5KSB0byB0aGlzIHBvaW50CiAgICBpZiAoZGlzdGFuY2UgPT09IG51bGwpCiAgICB7CiAgICAgICAgZGlzdGFuY2UgPSBNYXRoLnNxcnQoKCh4IC0gYS54KSAqICh4IC0gYS54KSkgKyAoKHkgLSBhLnkpICogKHkgLSBhLnkpKSk7CiAgICB9CgogICAgcmV0dXJuIGEuc2V0VG8oeCArIGRpc3RhbmNlICogTWF0aC5jb3MoYW5nbGUpLCB5ICsgZGlzdGFuY2UgKiBNYXRoLnNpbihhbmdsZSkpOwoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIENyZWF0ZXMgYSBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aXRoIHRoZSB0b3AtbGVmdCBjb3JuZXIgc3BlY2lmaWVkIGJ5IHRoZSB4IGFuZCB5IHBhcmFtZXRlcnMgYW5kIHdpdGggdGhlIHNwZWNpZmllZCB3aWR0aCBhbmQgaGVpZ2h0IHBhcmFtZXRlcnMuIElmIHlvdSBjYWxsIHRoaXMgZnVuY3Rpb24gd2l0aG91dCBwYXJhbWV0ZXJzLCBhIFJlY3RhbmdsZSB3aXRoIHgsIHksIHdpZHRoLCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgc2V0IHRvIDAgaXMgY3JlYXRlZC4KKgoqIEBjbGFzcyBQaGFzZXIuUmVjdGFuZ2xlCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSB0b3AtbGVmdCBjb3JuZXIgb2YgdGhlIFJlY3RhbmdsZS4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgUmVjdGFuZ2xlLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgUmVjdGFuZ2xlLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBSZWN0YW5nbGUuCiogQHJldHVybiB7UmVjdGFuZ2xlfSBUaGlzIFJlY3RhbmdsZSBvYmplY3QuCiovClBoYXNlci5SZWN0YW5nbGUgPSBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKICAgIHggPSB4IHx8IDA7CiAgICB5ID0geSB8fCAwOwogICAgd2lkdGggPSB3aWR0aCB8fCAwOwogICAgaGVpZ2h0ID0gaGVpZ2h0IHx8IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgdG9wLWxlZnQgY29ybmVyIG9mIHRoZSBSZWN0YW5nbGUuCiAgICAqLwogICAgdGhpcy54ID0geDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgdG9wLWxlZnQgY29ybmVyIG9mIHRoZSBSZWN0YW5nbGUuCiAgICAqLwogICAgdGhpcy55ID0geTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgUmVjdGFuZ2xlLgogICAgKi8KICAgIHRoaXMud2lkdGggPSB3aWR0aDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBSZWN0YW5nbGUuCiAgICAqLwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7Cgp9OwoKUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEFkanVzdHMgdGhlIGxvY2F0aW9uIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0LCBhcyBkZXRlcm1pbmVkIGJ5IGl0cyB0b3AtbGVmdCBjb3JuZXIsIGJ5IHRoZSBzcGVjaWZpZWQgYW1vdW50cy4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI29mZnNldAogICAgKiBAcGFyYW0ge251bWJlcn0gZHggLSBNb3ZlcyB0aGUgeCB2YWx1ZSBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBieSB0aGlzIGFtb3VudC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGR5IC0gTW92ZXMgdGhlIHkgdmFsdWUgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QgYnkgdGhpcyBhbW91bnQuCiAgICAqIEByZXR1cm4ge1JlY3RhbmdsZX0gVGhpcyBSZWN0YW5nbGUgb2JqZWN0LgogICAgKi8KICAgIG9mZnNldDogZnVuY3Rpb24gKGR4LCBkeSkgewoKICAgICAgICB0aGlzLnggKz0gZHg7CiAgICAgICAgdGhpcy55ICs9IGR5OwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAogCiAgICAvKioKICAgICogQWRqdXN0cyB0aGUgbG9jYXRpb24gb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QgdXNpbmcgYSBQb2ludCBvYmplY3QgYXMgYSBwYXJhbWV0ZXIuIFRoaXMgbWV0aG9kIGlzIHNpbWlsYXIgdG8gdGhlIFJlY3RhbmdsZS5vZmZzZXQoKSBtZXRob2QsIGV4Y2VwdCB0aGF0IGl0IHRha2VzIGEgUG9pbnQgb2JqZWN0IGFzIGEgcGFyYW1ldGVyLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjb2Zmc2V0UG9pbnQKICAgICogQHBhcmFtIHtQb2ludH0gcG9pbnQgLSBBIFBvaW50IG9iamVjdCB0byB1c2UgdG8gb2Zmc2V0IHRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KICAgICogQHJldHVybiB7UmVjdGFuZ2xlfSBUaGlzIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqLwogICAgb2Zmc2V0UG9pbnQ6IGZ1bmN0aW9uIChwb2ludCkgewogICAgICAgIHJldHVybiB0aGlzLm9mZnNldChwb2ludC54LCBwb2ludC55KTsKICAgIH0sCiAKICAgIC8qKgogICAgKiBTZXRzIHRoZSBtZW1iZXJzIG9mIFJlY3RhbmdsZSB0byB0aGUgc3BlY2lmaWVkIHZhbHVlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI3NldFRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgdG9wLWxlZnQgY29ybmVyIG9mIHRoZSBSZWN0YW5nbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgdG9wLWxlZnQgY29ybmVyIG9mIHRoZSBSZWN0YW5nbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgUmVjdGFuZ2xlIGluIHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIFJlY3RhbmdsZSBpbiBwaXhlbHMuCiAgICAqIEByZXR1cm4ge1JlY3RhbmdsZX0gVGhpcyBSZWN0YW5nbGUgb2JqZWN0CiAgICAqLwogICAgc2V0VG86IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHRoaXMueCA9IHg7CiAgICAgICAgdGhpcy55ID0geTsKICAgICAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCiAKICAgIC8qKgogICAgKiBSdW5zIE1hdGguZmxvb3IoKSBvbiBib3RoIHRoZSB4IGFuZCB5IHZhbHVlcyBvZiB0aGlzIFJlY3RhbmdsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2Zsb29yCiAgICAqLwogICAgZmxvb3I6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy54ID0gTWF0aC5mbG9vcih0aGlzLngpOwogICAgICAgIHRoaXMueSA9IE1hdGguZmxvb3IodGhpcy55KTsKCiAgICB9LAogCiAgICAvKioKICAgICogUnVucyBNYXRoLmZsb29yKCkgb24gdGhlIHgsIHksIHdpZHRoIGFuZCBoZWlnaHQgdmFsdWVzIG9mIHRoaXMgUmVjdGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjZmxvb3JBbGwKICAgICovCiAgICBmbG9vckFsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnggPSBNYXRoLmZsb29yKHRoaXMueCk7CiAgICAgICAgdGhpcy55ID0gTWF0aC5mbG9vcih0aGlzLnkpOwogICAgICAgIHRoaXMud2lkdGggPSBNYXRoLmZsb29yKHRoaXMud2lkdGgpOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gTWF0aC5mbG9vcih0aGlzLmhlaWdodCk7CgogICAgfSwKCiAgICAvKioKICAgICogQ29waWVzIHRoZSB4LCB5LCB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgZnJvbSBhbnkgZ2l2ZW4gb2JqZWN0IHRvIHRoaXMgUmVjdGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjY29weUZyb20KICAgICogQHBhcmFtIHthbnl9IHNvdXJjZSAtIFRoZSBvYmplY3QgdG8gY29weSBmcm9tLgogICAgKiBAcmV0dXJuIHtSZWN0YW5nbGV9IFRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KICAgICovCiAgICBjb3B5RnJvbTogZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICAgIHJldHVybiB0aGlzLnNldFRvKHNvdXJjZS54LCBzb3VyY2UueSwgc291cmNlLndpZHRoLCBzb3VyY2UuaGVpZ2h0KTsKICAgIH0sCgogICAgLyoqCiAgICAqIENvcGllcyB0aGUgeCwgeSwgd2lkdGggYW5kIGhlaWdodCBwcm9wZXJ0aWVzIGZyb20gdGhpcyBSZWN0YW5nbGUgdG8gYW55IGdpdmVuIG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2NvcHlUbwogICAgKiBAcGFyYW0ge2FueX0gc291cmNlIC0gVGhlIG9iamVjdCB0byBjb3B5IHRvLgogICAgKiBAcmV0dXJuIHtvYmplY3R9IFRoaXMgb2JqZWN0LgogICAgKi8KICAgIGNvcHlUbzogZnVuY3Rpb24gKGRlc3QpIHsKCiAgICAgICAgZGVzdC54ID0gdGhpcy54OwogICAgICAgIGRlc3QueSA9IHRoaXMueTsKICAgICAgICBkZXN0LndpZHRoID0gdGhpcy53aWR0aDsKICAgICAgICBkZXN0LmhlaWdodCA9IHRoaXMuaGVpZ2h0OwoKICAgICAgICByZXR1cm4gZGVzdDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbmNyZWFzZXMgdGhlIHNpemUgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QgYnkgdGhlIHNwZWNpZmllZCBhbW91bnRzLiBUaGUgY2VudGVyIHBvaW50IG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0IHN0YXlzIHRoZSBzYW1lLCBhbmQgaXRzIHNpemUgaW5jcmVhc2VzIHRvIHRoZSBsZWZ0IGFuZCByaWdodCBieSB0aGUgZHggdmFsdWUsIGFuZCB0byB0aGUgdG9wIGFuZCB0aGUgYm90dG9tIGJ5IHRoZSBkeSB2YWx1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2luZmxhdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGR4IC0gVGhlIGFtb3VudCB0byBiZSBhZGRlZCB0byB0aGUgbGVmdCBzaWRlIG9mIHRoZSBSZWN0YW5nbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkeSAtIFRoZSBhbW91bnQgdG8gYmUgYWRkZWQgdG8gdGhlIGJvdHRvbSBzaWRlIG9mIHRoZSBSZWN0YW5nbGUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9IFRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KICAgICovCiAgICBpbmZsYXRlOiBmdW5jdGlvbiAoZHgsIGR5KSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuaW5mbGF0ZSh0aGlzLCBkeCwgZHkpOwogICAgfSwKCiAgICAvKioKICAgICogVGhlIHNpemUgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QsIGV4cHJlc3NlZCBhcyBhIFBvaW50IG9iamVjdCB3aXRoIHRoZSB2YWx1ZXMgb2YgdGhlIHdpZHRoIGFuZCBoZWlnaHQgcHJvcGVydGllcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI3NpemUKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRwdXRdIC0gT3B0aW9uYWwgUG9pbnQgb2JqZWN0LiBJZiBnaXZlbiB0aGUgdmFsdWVzIHdpbGwgYmUgc2V0IGludG8gdGhlIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBzaXplIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0LgogICAgKi8KICAgIHNpemU6IGZ1bmN0aW9uIChvdXRwdXQpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5zaXplKHRoaXMsIG91dHB1dCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgbmV3IFJlY3RhbmdsZSBvYmplY3Qgd2l0aCB0aGUgc2FtZSB2YWx1ZXMgZm9yIHRoZSB4LCB5LCB3aWR0aCwgYW5kIGhlaWdodCBwcm9wZXJ0aWVzIGFzIHRoZSBvcmlnaW5hbCBSZWN0YW5nbGUgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjY2xvbmUKICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBbb3V0cHV0XSAtIE9wdGlvbmFsIFJlY3RhbmdsZSBvYmplY3QuIElmIGdpdmVuIHRoZSB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGUgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfSAKICAgICovCiAgICBjbG9uZTogZnVuY3Rpb24gKG91dHB1dCkgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmNsb25lKHRoaXMsIG91dHB1dCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHNwZWNpZmllZCBjb29yZGluYXRlcyBhcmUgY29udGFpbmVkIHdpdGhpbiB0aGUgcmVnaW9uIGRlZmluZWQgYnkgdGhpcyBSZWN0YW5nbGUgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjY29udGFpbnMKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBwb2ludCB0byB0ZXN0LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHBvaW50IHRvIHRlc3QuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBjb250YWlucyB0aGUgc3BlY2lmaWVkIHBvaW50OyBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgY29udGFpbnM6IGZ1bmN0aW9uICh4LCB5KSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuY29udGFpbnModGhpcywgeCwgeSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIGZpcnN0IFJlY3RhbmdsZSBvYmplY3QgaXMgZnVsbHkgY29udGFpbmVkIHdpdGhpbiB0aGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEEgUmVjdGFuZ2xlIG9iamVjdCBpcyBzYWlkIHRvIGNvbnRhaW4gYW5vdGhlciBpZiB0aGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QgZmFsbHMgZW50aXJlbHkgd2l0aGluIHRoZSBib3VuZGFyaWVzIG9mIHRoZSBmaXJzdC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2NvbnRhaW5zUmVjdAogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBjb250YWlucyB0aGUgc3BlY2lmaWVkIHBvaW50OyBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgY29udGFpbnNSZWN0OiBmdW5jdGlvbiAoYikgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zUmVjdCh0aGlzLCBiKTsKICAgIH0sCgogICAgLyoqCiAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgdHdvIFJlY3RhbmdsZXMgYXJlIGVxdWFsLgogICAgKiBUaGlzIG1ldGhvZCBjb21wYXJlcyB0aGUgeCwgeSwgd2lkdGggYW5kIGhlaWdodCBwcm9wZXJ0aWVzIG9mIGVhY2ggUmVjdGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjZXF1YWxzCiAgICAqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSB0d28gUmVjdGFuZ2xlcyBoYXZlIGV4YWN0bHkgdGhlIHNhbWUgdmFsdWVzIGZvciB0aGUgeCwgeSwgd2lkdGggYW5kIGhlaWdodCBwcm9wZXJ0aWVzOyBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgZXF1YWxzOiBmdW5jdGlvbiAoYikgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmVxdWFscyh0aGlzLCBiKTsKICAgIH0sCgogICAgLyoqCiAgICAqIElmIHRoZSBSZWN0YW5nbGUgb2JqZWN0IHNwZWNpZmllZCBpbiB0aGUgdG9JbnRlcnNlY3QgcGFyYW1ldGVyIGludGVyc2VjdHMgd2l0aCB0aGlzIFJlY3RhbmdsZSBvYmplY3QsIHJldHVybnMgdGhlIGFyZWEgb2YgaW50ZXJzZWN0aW9uIGFzIGEgUmVjdGFuZ2xlIG9iamVjdC4gSWYgdGhlIFJlY3RhbmdsZXMgZG8gbm90IGludGVyc2VjdCwgdGhpcyBtZXRob2QgcmV0dXJucyBhbiBlbXB0eSBSZWN0YW5nbGUgb2JqZWN0IHdpdGggaXRzIHByb3BlcnRpZXMgc2V0IHRvIDAuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNpbnRlcnNlY3Rpb24KICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBiIC0gVGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IG91dCAtIE9wdGlvbmFsIFJlY3RhbmdsZSBvYmplY3QuIElmIGdpdmVuIHRoZSBpbnRlcnNlY3Rpb24gdmFsdWVzIHdpbGwgYmUgc2V0IGludG8gdGhpcyBvYmplY3QsIG90aGVyd2lzZSBhIGJyYW5kIG5ldyBSZWN0YW5nbGUgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9IEEgUmVjdGFuZ2xlIG9iamVjdCB0aGF0IGVxdWFscyB0aGUgYXJlYSBvZiBpbnRlcnNlY3Rpb24uIElmIHRoZSBSZWN0YW5nbGVzIGRvIG5vdCBpbnRlcnNlY3QsIHRoaXMgbWV0aG9kIHJldHVybnMgYW4gZW1wdHkgUmVjdGFuZ2xlIG9iamVjdDsgdGhhdCBpcywgYSBSZWN0YW5nbGUgd2l0aCBpdHMgeCwgeSwgd2lkdGgsIGFuZCBoZWlnaHQgcHJvcGVydGllcyBzZXQgdG8gMC4KICAgICovCiAgICBpbnRlcnNlY3Rpb246IGZ1bmN0aW9uIChiLCBvdXQpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3Rpb24odGhpcywgYiwgb3V0KTsKICAgIH0sCgogICAgLyoqCiAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgdHdvIFJlY3RhbmdsZXMgaW50ZXJzZWN0IHdpdGggZWFjaCBvdGhlci4KICAgICogVGhpcyBtZXRob2QgY2hlY2tzIHRoZSB4LCB5LCB3aWR0aCwgYW5kIGhlaWdodCBwcm9wZXJ0aWVzIG9mIHRoZSBSZWN0YW5nbGVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjaW50ZXJzZWN0cwogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0b2xlcmFuY2UgLSBBIHRvbGVyYW5jZSB2YWx1ZSB0byBhbGxvdyBmb3IgYW4gaW50ZXJzZWN0aW9uIHRlc3Qgd2l0aCBwYWRkaW5nLCBkZWZhdWx0IHRvIDAuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBpbnRlcnNlY3RzIHdpdGggdGhpcyBSZWN0YW5nbGUgb2JqZWN0OyBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgaW50ZXJzZWN0czogZnVuY3Rpb24gKGIsIHRvbGVyYW5jZSkgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHModGhpcywgYiwgdG9sZXJhbmNlKTsKICAgIH0sCgogICAgLyoqCiAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgb2JqZWN0IHNwZWNpZmllZCBpbnRlcnNlY3RzIChvdmVybGFwcykgd2l0aCB0aGUgZ2l2ZW4gdmFsdWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjaW50ZXJzZWN0c1JhdwogICAgKiBAcGFyYW0ge251bWJlcn0gbGVmdCAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gcmlnaHQgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHRvcCAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gYm90dG9tdCAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gdG9sZXJhbmNlIC0gQSB0b2xlcmFuY2UgdmFsdWUgdG8gYWxsb3cgZm9yIGFuIGludGVyc2VjdGlvbiB0ZXN0IHdpdGggcGFkZGluZywgZGVmYXVsdCB0byAwCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBpbnRlcnNlY3RzIHdpdGggdGhlIFJlY3RhbmdsZTsgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGludGVyc2VjdHNSYXc6IGZ1bmN0aW9uIChsZWZ0LCByaWdodCwgdG9wLCBib3R0b20sIHRvbGVyYW5jZSkgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHNSYXcodGhpcywgbGVmdCwgcmlnaHQsIHRvcCwgYm90dG9tLCB0b2xlcmFuY2UpOwogICAgfSwKCiAgICAvKioKICAgICogQWRkcyB0d28gUmVjdGFuZ2xlcyB0b2dldGhlciB0byBjcmVhdGUgYSBuZXcgUmVjdGFuZ2xlIG9iamVjdCwgYnkgZmlsbGluZyBpbiB0aGUgaG9yaXpvbnRhbCBhbmQgdmVydGljYWwgc3BhY2UgYmV0d2VlbiB0aGUgdHdvIFJlY3RhbmdsZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSN1bmlvbgogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gW291dF0gLSBPcHRpb25hbCBSZWN0YW5nbGUgb2JqZWN0LiBJZiBnaXZlbiB0aGUgbmV3IHZhbHVlcyB3aWxsIGJlIHNldCBpbnRvIHRoaXMgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfSBBIFJlY3RhbmdsZSBvYmplY3QgdGhhdCBpcyB0aGUgdW5pb24gb2YgdGhlIHR3byBSZWN0YW5nbGVzLgogICAgKi8KICAgIHVuaW9uOiBmdW5jdGlvbiAoYiwgb3V0KSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUudW5pb24odGhpcywgYiwgb3V0KTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSN0b1N0cmluZwogICAgKiBAcmV0dXJuIHtzdHJpbmd9IEEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBpbnN0YW5jZS4KICAgICovCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAiW3tSZWN0YW5nbGUgKHg9IiArIHRoaXMueCArICIgeT0iICsgdGhpcy55ICsgIiB3aWR0aD0iICsgdGhpcy53aWR0aCArICIgaGVpZ2h0PSIgKyB0aGlzLmhlaWdodCArICIgZW1wdHk9IiArIHRoaXMuZW1wdHkgKyAiKX1dIjsKICAgIH0KCn07CgpQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5SZWN0YW5nbGU7CgovKioKKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2hhbGZXaWR0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoYWxmV2lkdGggLSBIYWxmIG9mIHRoZSB3aWR0aCBvZiB0aGUgUmVjdGFuZ2xlLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJoYWxmV2lkdGgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQodGhpcy53aWR0aCAvIDIpOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2hhbGZIZWlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gaGFsZkhlaWdodCAtIEhhbGYgb2YgdGhlIGhlaWdodCBvZiB0aGUgUmVjdGFuZ2xlLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJoYWxmSGVpZ2h0IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHRoaXMuaGVpZ2h0IC8gMik7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBzdW0gb2YgdGhlIHkgYW5kIGhlaWdodCBwcm9wZXJ0aWVzLiBDaGFuZ2luZyB0aGUgYm90dG9tIHByb3BlcnR5IG9mIGEgUmVjdGFuZ2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB4LCB5IGFuZCB3aWR0aCBwcm9wZXJ0aWVzLCBidXQgZG9lcyBjaGFuZ2UgdGhlIGhlaWdodCBwcm9wZXJ0eS4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2JvdHRvbQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBib3R0b20gLSBUaGUgc3VtIG9mIHRoZSB5IGFuZCBoZWlnaHQgcHJvcGVydGllcy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAiYm90dG9tIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy55ICsgdGhpcy5oZWlnaHQ7CiAgICB9LAogIAogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPD0gdGhpcy55KSB7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmhlaWdodCA9ICh0aGlzLnkgLSB2YWx1ZSk7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgbG9jYXRpb24gb2YgdGhlIFJlY3RhbmdsZXMgYm90dG9tIHJpZ2h0IGNvcm5lciBhcyBhIFBvaW50IG9iamVjdC4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2JvdHRvbQoqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBib3R0b21SaWdodCAtIEdldHMgb3Igc2V0cyB0aGUgbG9jYXRpb24gb2YgdGhlIFJlY3RhbmdsZXMgYm90dG9tIHJpZ2h0IGNvcm5lciBhcyBhIFBvaW50IG9iamVjdC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAiYm90dG9tUmlnaHQiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBuZXcgUGhhc2VyLlBvaW50KHRoaXMucmlnaHQsIHRoaXMuYm90dG9tKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLnJpZ2h0ID0gdmFsdWUueDsKICAgICAgICB0aGlzLmJvdHRvbSA9IHZhbHVlLnk7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGxlZnQgb2YgdGhlIFJlY3RhbmdsZS4gQ2hhbmdpbmcgdGhlIGxlZnQgcHJvcGVydHkgb2YgYSBSZWN0YW5nbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHkgYW5kIGhlaWdodCBwcm9wZXJ0aWVzLiBIb3dldmVyIGl0IGRvZXMgYWZmZWN0IHRoZSB3aWR0aCBwcm9wZXJ0eSwgd2hlcmVhcyBjaGFuZ2luZyB0aGUgeCB2YWx1ZSBkb2VzIG5vdCBhZmZlY3QgdGhlIHdpZHRoIHByb3BlcnR5LgoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjbGVmdAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsZWZ0IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgbGVmdCBvZiB0aGUgUmVjdGFuZ2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJsZWZ0IiwgewogICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLng7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID49IHRoaXMucmlnaHQpIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMucmlnaHQgLSB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgdGhpcy54ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBzdW0gb2YgdGhlIHggYW5kIHdpZHRoIHByb3BlcnRpZXMuIENoYW5naW5nIHRoZSByaWdodCBwcm9wZXJ0eSBvZiBhIFJlY3RhbmdsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCwgeSBhbmQgaGVpZ2h0IHByb3BlcnRpZXMsIGhvd2V2ZXIgaXQgZG9lcyBhZmZlY3QgdGhlIHdpZHRoIHByb3BlcnR5LgoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjcmlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gcmlnaHQgLSBUaGUgc3VtIG9mIHRoZSB4IGFuZCB3aWR0aCBwcm9wZXJ0aWVzLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJyaWdodCIsIHsKICAgICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueCArIHRoaXMud2lkdGg7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlIDw9IHRoaXMueCkgewogICAgICAgICAgICB0aGlzLndpZHRoID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy54ICsgdmFsdWU7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgdm9sdW1lIG9mIHRoZSBSZWN0YW5nbGUgZGVyaXZlZCBmcm9tIHdpZHRoICogaGVpZ2h0LgoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjdm9sdW1lCiogQHByb3BlcnR5IHtudW1iZXJ9IHZvbHVtZSAtIFRoZSB2b2x1bWUgb2YgdGhlIFJlY3RhbmdsZSBkZXJpdmVkIGZyb20gd2lkdGggKiBoZWlnaHQuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSwgInZvbHVtZSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMud2lkdGggKiB0aGlzLmhlaWdodDsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHBlcmltZXRlciBzaXplIG9mIHRoZSBSZWN0YW5nbGUuIFRoaXMgaXMgdGhlIHN1bSBvZiBhbGwgNCBzaWRlcy4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI3BlcmltZXRlcgoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwZXJpbWV0ZXIgLSBUaGUgcGVyaW1ldGVyIHNpemUgb2YgdGhlIFJlY3RhbmdsZS4gVGhpcyBpcyB0aGUgc3VtIG9mIGFsbCA0IHNpZGVzLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJwZXJpbWV0ZXIiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAodGhpcy53aWR0aCAqIDIpICsgKHRoaXMuaGVpZ2h0ICogMik7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgUmVjdGFuZ2xlLgoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjY2VudGVyWAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjZW50ZXJYIC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBSZWN0YW5nbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSwgImNlbnRlclgiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnggKyB0aGlzLmhhbGZXaWR0aDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLnggPSB2YWx1ZSAtIHRoaXMuaGFsZldpZHRoOwogICAgfQoKfSk7CgovKioKKiBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIFJlY3RhbmdsZS4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2NlbnRlclkKKiBAcHJvcGVydHkge251bWJlcn0gY2VudGVyWSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgUmVjdGFuZ2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJjZW50ZXJZIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy55ICsgdGhpcy5oYWxmSGVpZ2h0OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMueSA9IHZhbHVlIC0gdGhpcy5oYWxmSGVpZ2h0OwogICAgfQoKfSk7CgovKioKKiBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSB0b3Agb2YgdGhlIFJlY3RhbmdsZS4gQ2hhbmdpbmcgdGhlIHRvcCBwcm9wZXJ0eSBvZiBhIFJlY3RhbmdsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCBhbmQgd2lkdGggcHJvcGVydGllcy4KKiBIb3dldmVyIGl0IGRvZXMgYWZmZWN0IHRoZSBoZWlnaHQgcHJvcGVydHksIHdoZXJlYXMgY2hhbmdpbmcgdGhlIHkgdmFsdWUgZG9lcyBub3QgYWZmZWN0IHRoZSBoZWlnaHQgcHJvcGVydHkuCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSN0b3AKKiBAcHJvcGVydHkge251bWJlcn0gdG9wIC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgdG9wIG9mIHRoZSBSZWN0YW5nbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSwgInRvcCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPj0gdGhpcy5ib3R0b20pIHsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAwOwogICAgICAgICAgICB0aGlzLnkgPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmhlaWdodCA9ICh0aGlzLmJvdHRvbSAtIHZhbHVlKTsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBsb2NhdGlvbiBvZiB0aGUgUmVjdGFuZ2xlcyB0b3AgbGVmdCBjb3JuZXIgYXMgYSBQb2ludCBvYmplY3QuCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSN0b3BMZWZ0CiogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHRvcExlZnQgLSBUaGUgbG9jYXRpb24gb2YgdGhlIFJlY3RhbmdsZXMgdG9wIGxlZnQgY29ybmVyIGFzIGEgUG9pbnQgb2JqZWN0LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJ0b3BMZWZ0IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBuZXcgUGhhc2VyLlBvaW50KHRoaXMueCwgdGhpcy55KTsKICAgIH0sCiAgICAKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy54ID0gdmFsdWUueDsKICAgICAgICB0aGlzLnkgPSB2YWx1ZS55OwogICAgfQoKfSk7CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgb3Igbm90IHRoaXMgUmVjdGFuZ2xlIG9iamVjdCBpcyBlbXB0eS4gQSBSZWN0YW5nbGUgb2JqZWN0IGlzIGVtcHR5IGlmIGl0cyB3aWR0aCBvciBoZWlnaHQgaXMgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIDAuCiogSWYgc2V0IHRvIHRydWUgdGhlbiBhbGwgb2YgdGhlIFJlY3RhbmdsZSBwcm9wZXJ0aWVzIGFyZSBzZXQgdG8gMC4gCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNlbXB0eQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZW1wdHkgLSBHZXRzIG9yIHNldHMgdGhlIFJlY3RhbmdsZXMgZW1wdHkgc3RhdGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSwgImVtcHR5IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKCF0aGlzLndpZHRoIHx8ICF0aGlzLmhlaWdodCk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh2YWx1ZSA9PT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc2V0VG8oMCwgMCwgMCwgMCk7CiAgICAgICAgfQogICAgICAgIAogICAgfQoKfSk7CgovKioKKiBJbmNyZWFzZXMgdGhlIHNpemUgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QgYnkgdGhlIHNwZWNpZmllZCBhbW91bnRzLiBUaGUgY2VudGVyIHBvaW50IG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0IHN0YXlzIHRoZSBzYW1lLCBhbmQgaXRzIHNpemUgaW5jcmVhc2VzIHRvIHRoZSBsZWZ0IGFuZCByaWdodCBieSB0aGUgZHggdmFsdWUsIGFuZCB0byB0aGUgdG9wIGFuZCB0aGUgYm90dG9tIGJ5IHRoZSBkeSB2YWx1ZS4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuaW5mbGF0ZQoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7bnVtYmVyfSBkeCAtIFRoZSBhbW91bnQgdG8gYmUgYWRkZWQgdG8gdGhlIGxlZnQgc2lkZSBvZiB0aGUgUmVjdGFuZ2xlLgoqIEBwYXJhbSB7bnVtYmVyfSBkeSAtIFRoZSBhbW91bnQgdG8gYmUgYWRkZWQgdG8gdGhlIGJvdHRvbSBzaWRlIG9mIHRoZSBSZWN0YW5nbGUuCiogQHJldHVybiB7UGhhc2VyLlJlY3RhbmdsZX0gVGhpcyBSZWN0YW5nbGUgb2JqZWN0LgoqLwpQaGFzZXIuUmVjdGFuZ2xlLmluZmxhdGUgPSBmdW5jdGlvbiAoYSwgZHgsIGR5KSB7CiAgICBhLnggLT0gZHg7CiAgICBhLndpZHRoICs9IDIgKiBkeDsKICAgIGEueSAtPSBkeTsKICAgIGEuaGVpZ2h0ICs9IDIgKiBkeTsKICAgIHJldHVybiBhOwp9OwoKLyoqCiogSW5jcmVhc2VzIHRoZSBzaXplIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0LiBUaGlzIG1ldGhvZCBpcyBzaW1pbGFyIHRvIHRoZSBSZWN0YW5nbGUuaW5mbGF0ZSgpIG1ldGhvZCBleGNlcHQgaXQgdGFrZXMgYSBQb2ludCBvYmplY3QgYXMgYSBwYXJhbWV0ZXIuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmluZmxhdGVQb2ludAoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBwb2ludCAtIFRoZSB4IHByb3BlcnR5IG9mIHRoaXMgUG9pbnQgb2JqZWN0IGlzIHVzZWQgdG8gaW5jcmVhc2UgdGhlIGhvcml6b250YWwgZGltZW5zaW9uIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0LiBUaGUgeSBwcm9wZXJ0eSBpcyB1c2VkIHRvIGluY3JlYXNlIHRoZSB2ZXJ0aWNhbCBkaW1lbnNpb24gb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QuCiogQHJldHVybiB7UGhhc2VyLlJlY3RhbmdsZX0gVGhlIFJlY3RhbmdsZSBvYmplY3QuCiovClBoYXNlci5SZWN0YW5nbGUuaW5mbGF0ZVBvaW50ID0gZnVuY3Rpb24gKGEsIHBvaW50KSB7CiAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5pbmZsYXRlKGEsIHBvaW50LngsIHBvaW50LnkpOwp9OwoKLyoqCiogVGhlIHNpemUgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QsIGV4cHJlc3NlZCBhcyBhIFBvaW50IG9iamVjdCB3aXRoIHRoZSB2YWx1ZXMgb2YgdGhlIHdpZHRoIGFuZCBoZWlnaHQgcHJvcGVydGllcy4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuc2l6ZQoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbb3V0cHV0XSAtIE9wdGlvbmFsIFBvaW50IG9iamVjdC4gSWYgZ2l2ZW4gdGhlIHZhbHVlcyB3aWxsIGJlIHNldCBpbnRvIHRoZSBvYmplY3QsIG90aGVyd2lzZSBhIGJyYW5kIG5ldyBQb2ludCBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkIGFuZCByZXR1cm5lZC4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBzaXplIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0CiovClBoYXNlci5SZWN0YW5nbGUuc2l6ZSA9IGZ1bmN0aW9uIChhLCBvdXRwdXQpIHsKICAgIGlmICh0eXBlb2Ygb3V0cHV0ID09PSAidW5kZWZpbmVkIikgeyBvdXRwdXQgPSBuZXcgUGhhc2VyLlBvaW50KCk7IH0KICAgIHJldHVybiBvdXRwdXQuc2V0VG8oYS53aWR0aCwgYS5oZWlnaHQpOwp9OwoKLyoqCiogUmV0dXJucyBhIG5ldyBSZWN0YW5nbGUgb2JqZWN0IHdpdGggdGhlIHNhbWUgdmFsdWVzIGZvciB0aGUgeCwgeSwgd2lkdGgsIGFuZCBoZWlnaHQgcHJvcGVydGllcyBhcyB0aGUgb3JpZ2luYWwgUmVjdGFuZ2xlIG9iamVjdC4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuY2xvbmUKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IFtvdXRwdXRdIC0gT3B0aW9uYWwgUmVjdGFuZ2xlIG9iamVjdC4gSWYgZ2l2ZW4gdGhlIHZhbHVlcyB3aWxsIGJlIHNldCBpbnRvIHRoZSBvYmplY3QsIG90aGVyd2lzZSBhIGJyYW5kIG5ldyBSZWN0YW5nbGUgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiogQHJldHVybiB7UGhhc2VyLlJlY3RhbmdsZX0KKi8KUGhhc2VyLlJlY3RhbmdsZS5jbG9uZSA9IGZ1bmN0aW9uIChhLCBvdXRwdXQpIHsKICAgIGlmICh0eXBlb2Ygb3V0cHV0ID09PSAidW5kZWZpbmVkIikgeyBvdXRwdXQgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgpOyB9CiAgICByZXR1cm4gb3V0cHV0LnNldFRvKGEueCwgYS55LCBhLndpZHRoLCBhLmhlaWdodCk7Cn07CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHNwZWNpZmllZCBjb29yZGluYXRlcyBhcmUgY29udGFpbmVkIHdpdGhpbiB0aGUgcmVnaW9uIGRlZmluZWQgYnkgdGhpcyBSZWN0YW5nbGUgb2JqZWN0LgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS5jb250YWlucwoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgcG9pbnQgdG8gdGVzdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHBvaW50IHRvIHRlc3QuCiogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBSZWN0YW5nbGUgb2JqZWN0IGNvbnRhaW5zIHRoZSBzcGVjaWZpZWQgcG9pbnQ7IG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLlJlY3RhbmdsZS5jb250YWlucyA9IGZ1bmN0aW9uIChhLCB4LCB5KSB7CiAgICByZXR1cm4gKHggPj0gYS54ICYmIHggPD0gYS5yaWdodCAmJiB5ID49IGEueSAmJiB5IDw9IGEuYm90dG9tKTsKfTsKClBoYXNlci5SZWN0YW5nbGUuY29udGFpbnNSYXcgPSBmdW5jdGlvbiAocngsIHJ5LCBydywgcmgsIHgsIHkpIHsKICAgIHJldHVybiAoeCA+PSByeCAmJiB4IDw9IChyeCArIHJ3KSAmJiB5ID49IHJ5ICYmIHkgPD0gKHJ5ICsgcmgpKTsKfTsKCi8qKgoqIERldGVybWluZXMgd2hldGhlciB0aGUgc3BlY2lmaWVkIHBvaW50IGlzIGNvbnRhaW5lZCB3aXRoaW4gdGhlIHJlY3Rhbmd1bGFyIHJlZ2lvbiBkZWZpbmVkIGJ5IHRoaXMgUmVjdGFuZ2xlIG9iamVjdC4gVGhpcyBtZXRob2QgaXMgc2ltaWxhciB0byB0aGUgUmVjdGFuZ2xlLmNvbnRhaW5zKCkgbWV0aG9kLCBleGNlcHQgdGhhdCBpdCB0YWtlcyBhIFBvaW50IG9iamVjdCBhcyBhIHBhcmFtZXRlci4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuY29udGFpbnNQb2ludAoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBwb2ludCAtIFRoZSBwb2ludCBvYmplY3QgYmVpbmcgY2hlY2tlZC4gQ2FuIGJlIFBvaW50IG9yIGFueSBvYmplY3Qgd2l0aCAueCBhbmQgLnkgdmFsdWVzLgoqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBjb250YWlucyB0aGUgc3BlY2lmaWVkIHBvaW50OyBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5SZWN0YW5nbGUuY29udGFpbnNQb2ludCA9IGZ1bmN0aW9uIChhLCBwb2ludCkgewogICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuY29udGFpbnMoYSwgcG9pbnQueCwgcG9pbnQueSk7Cn07CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIGZpcnN0IFJlY3RhbmdsZSBvYmplY3QgaXMgZnVsbHkgY29udGFpbmVkIHdpdGhpbiB0aGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiogQSBSZWN0YW5nbGUgb2JqZWN0IGlzIHNhaWQgdG8gY29udGFpbiBhbm90aGVyIGlmIHRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdCBmYWxscyBlbnRpcmVseSB3aXRoaW4gdGhlIGJvdW5kYXJpZXMgb2YgdGhlIGZpcnN0LgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS5jb250YWluc1JlY3QKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgZmlyc3QgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBSZWN0YW5nbGUgb2JqZWN0IGNvbnRhaW5zIHRoZSBzcGVjaWZpZWQgcG9pbnQ7IG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLlJlY3RhbmdsZS5jb250YWluc1JlY3QgPSBmdW5jdGlvbiAoYSwgYikgewoKICAgIC8vICBJZiB0aGUgZ2l2ZW4gcmVjdCBoYXMgYSBsYXJnZXIgdm9sdW1lIHRoYW4gdGhpcyBvbmUgdGhlbiBpdCBjYW4gbmV2ZXIgY29udGFpbiBpdAogICAgaWYgKGEudm9sdW1lID4gYi52b2x1bWUpCiAgICB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHJldHVybiAoYS54ID49IGIueCAmJiBhLnkgPj0gYi55ICYmIGEucmlnaHQgPD0gYi5yaWdodCAmJiBhLmJvdHRvbSA8PSBiLmJvdHRvbSk7Cgp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSB0d28gUmVjdGFuZ2xlcyBhcmUgZXF1YWwuCiogVGhpcyBtZXRob2QgY29tcGFyZXMgdGhlIHgsIHksIHdpZHRoIGFuZCBoZWlnaHQgcHJvcGVydGllcyBvZiBlYWNoIFJlY3RhbmdsZS4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuZXF1YWxzCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIGZpcnN0IFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBiIC0gVGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgoqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgdHdvIFJlY3RhbmdsZXMgaGF2ZSBleGFjdGx5IHRoZSBzYW1lIHZhbHVlcyBmb3IgdGhlIHgsIHksIHdpZHRoIGFuZCBoZWlnaHQgcHJvcGVydGllczsgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuUmVjdGFuZ2xlLmVxdWFscyA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICByZXR1cm4gKGEueCA9PSBiLnggJiYgYS55ID09IGIueSAmJiBhLndpZHRoID09IGIud2lkdGggJiYgYS5oZWlnaHQgPT0gYi5oZWlnaHQpOwp9OwoKLyoqCiogSWYgdGhlIFJlY3RhbmdsZSBvYmplY3Qgc3BlY2lmaWVkIGluIHRoZSB0b0ludGVyc2VjdCBwYXJhbWV0ZXIgaW50ZXJzZWN0cyB3aXRoIHRoaXMgUmVjdGFuZ2xlIG9iamVjdCwgcmV0dXJucyB0aGUgYXJlYSBvZiBpbnRlcnNlY3Rpb24gYXMgYSBSZWN0YW5nbGUgb2JqZWN0LiBJZiB0aGUgUmVjdGFuZ2xlcyBkbyBub3QgaW50ZXJzZWN0LCB0aGlzIG1ldGhvZCByZXR1cm5zIGFuIGVtcHR5IFJlY3RhbmdsZSBvYmplY3Qgd2l0aCBpdHMgcHJvcGVydGllcyBzZXQgdG8gMC4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0aW9uCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIGZpcnN0IFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBiIC0gVGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gW291dF0gLSBPcHRpb25hbCBSZWN0YW5nbGUgb2JqZWN0LiBJZiBnaXZlbiB0aGUgaW50ZXJzZWN0aW9uIHZhbHVlcyB3aWxsIGJlIHNldCBpbnRvIHRoaXMgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgoqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9IEEgUmVjdGFuZ2xlIG9iamVjdCB0aGF0IGVxdWFscyB0aGUgYXJlYSBvZiBpbnRlcnNlY3Rpb24uIElmIHRoZSBSZWN0YW5nbGVzIGRvIG5vdCBpbnRlcnNlY3QsIHRoaXMgbWV0aG9kIHJldHVybnMgYW4gZW1wdHkgUmVjdGFuZ2xlIG9iamVjdDsgdGhhdCBpcywgYSBSZWN0YW5nbGUgd2l0aCBpdHMgeCwgeSwgd2lkdGgsIGFuZCBoZWlnaHQgcHJvcGVydGllcyBzZXQgdG8gMC4KKi8KUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3Rpb24gPSBmdW5jdGlvbiAoYSwgYiwgb3V0KSB7CgogICAgb3V0ICA9IG91dCB8fCBuZXcgUGhhc2VyLlJlY3RhbmdsZSgpOwoKICAgIGlmIChQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHMoYSwgYikpCiAgICB7CiAgICAgICAgb3V0LnggPSBNYXRoLm1heChhLngsIGIueCk7CiAgICAgICAgb3V0LnkgPSBNYXRoLm1heChhLnksIGIueSk7CiAgICAgICAgb3V0LndpZHRoID0gTWF0aC5taW4oYS5yaWdodCwgYi5yaWdodCkgLSBvdXQueDsKICAgICAgICBvdXQuaGVpZ2h0ID0gTWF0aC5taW4oYS5ib3R0b20sIGIuYm90dG9tKSAtIG91dC55OwogICAgfQoKICAgIHJldHVybiBvdXQ7Cgp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSB0d28gUmVjdGFuZ2xlcyBpbnRlcnNlY3Qgd2l0aCBlYWNoIG90aGVyLgoqIFRoaXMgbWV0aG9kIGNoZWNrcyB0aGUgeCwgeSwgd2lkdGgsIGFuZCBoZWlnaHQgcHJvcGVydGllcyBvZiB0aGUgUmVjdGFuZ2xlcy4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cwoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBmaXJzdCBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIHNwZWNpZmllZCBvYmplY3QgaW50ZXJzZWN0cyB3aXRoIHRoaXMgUmVjdGFuZ2xlIG9iamVjdDsgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHMgPSBmdW5jdGlvbiAoYSwgYikgewoKICAgIGlmIChhLndpZHRoIDw9IDAgfHwgYS5oZWlnaHQgPD0gMCB8fCBiLndpZHRoIDw9IDAgfHwgYi5oZWlnaHQgPD0gMCkKICAgIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuICEoYS5yaWdodCA8IGIueCB8fCBhLmJvdHRvbSA8IGIueSB8fCBhLnggPiBiLnJpZ2h0IHx8IGEueSA+IGIuYm90dG9tKTsKCn07CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIG9iamVjdCBzcGVjaWZpZWQgaW50ZXJzZWN0cyAob3ZlcmxhcHMpIHdpdGggdGhlIGdpdmVuIHZhbHVlcy4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0c1JhdwoqIEBwYXJhbSB7bnVtYmVyfSBsZWZ0IC0gRGVzY3JpcHRpb24uCiogQHBhcmFtIHtudW1iZXJ9IHJpZ2h0IC0gRGVzY3JpcHRpb24uCiogQHBhcmFtIHtudW1iZXJ9IHRvcCAtIERlc2NyaXB0aW9uLgoqIEBwYXJhbSB7bnVtYmVyfSBib3R0b20gLSBEZXNjcmlwdGlvbi4KKiBAcGFyYW0ge251bWJlcn0gdG9sZXJhbmNlIC0gQSB0b2xlcmFuY2UgdmFsdWUgdG8gYWxsb3cgZm9yIGFuIGludGVyc2VjdGlvbiB0ZXN0IHdpdGggcGFkZGluZywgZGVmYXVsdCB0byAwCiogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBzcGVjaWZpZWQgb2JqZWN0IGludGVyc2VjdHMgd2l0aCB0aGUgUmVjdGFuZ2xlOyBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0c1JhdyA9IGZ1bmN0aW9uIChhLCBsZWZ0LCByaWdodCwgdG9wLCBib3R0b20sIHRvbGVyYW5jZSkgewoKICAgIGlmICh0eXBlb2YgdG9sZXJhbmNlID09PSAidW5kZWZpbmVkIikgeyB0b2xlcmFuY2UgPSAwOyB9CgogICAgcmV0dXJuICEobGVmdCA+IGEucmlnaHQgKyB0b2xlcmFuY2UgfHwgcmlnaHQgPCBhLmxlZnQgLSB0b2xlcmFuY2UgfHwgdG9wID4gYS5ib3R0b20gKyB0b2xlcmFuY2UgfHwgYm90dG9tIDwgYS50b3AgLSB0b2xlcmFuY2UpOwoKfTsKCi8qKgoqIEFkZHMgdHdvIFJlY3RhbmdsZXMgdG9nZXRoZXIgdG8gY3JlYXRlIGEgbmV3IFJlY3RhbmdsZSBvYmplY3QsIGJ5IGZpbGxpbmcgaW4gdGhlIGhvcml6b250YWwgYW5kIHZlcnRpY2FsIHNwYWNlIGJldHdlZW4gdGhlIHR3byBSZWN0YW5nbGVzLgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS51bmlvbgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBmaXJzdCBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IFtvdXRdIC0gT3B0aW9uYWwgUmVjdGFuZ2xlIG9iamVjdC4gSWYgZ2l2ZW4gdGhlIG5ldyB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGlzIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFJlY3RhbmdsZSBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkIGFuZCByZXR1cm5lZC4KKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfSBBIFJlY3RhbmdsZSBvYmplY3QgdGhhdCBpcyB0aGUgdW5pb24gb2YgdGhlIHR3byBSZWN0YW5nbGVzLgoqLwpQaGFzZXIuUmVjdGFuZ2xlLnVuaW9uID0gZnVuY3Rpb24gKGEsIGIsIG91dCkgewoKICAgIGlmICh0eXBlb2Ygb3V0ID09PSAidW5kZWZpbmVkIikgeyBvdXQgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgpOyB9CgogICAgcmV0dXJuIG91dC5zZXRUbyhNYXRoLm1pbihhLngsIGIueCksIE1hdGgubWluKGEueSwgYi55KSwgTWF0aC5tYXgoYS5yaWdodCwgYi5yaWdodCkgLSBNYXRoLm1pbihhLmxlZnQsIGIubGVmdCksIE1hdGgubWF4KGEuYm90dG9tLCBiLmJvdHRvbSkgLSBNYXRoLm1pbihhLnRvcCwgYi50b3ApKTsKICAgIAp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyBQb2x5Z29uLiBZb3UgaGF2ZSB0byBwcm92aWRlIGEgbGlzdCBvZiBwb2ludHMuCiogVGhpcyBjYW4gYmUgYW4gYXJyYXkgb2YgUG9pbnRzIHRoYXQgZm9ybSB0aGUgcG9seWdvbiwgYSBmbGF0IGFycmF5IG9mIG51bWJlcnMgdGhhdCB3aWxsIGJlIGludGVycHJldGVkIGFzIFt4LHksIHgseSwgLi4uXSwgCiogb3IgdGhlIGFyZ3VtZW50cyBwYXNzZWQgY2FuIGJlIGFsbCB0aGUgcG9pbnRzIG9mIHRoZSBwb2x5Z29uIGUuZy4gYG5ldyBQSVhJLlBvbHlnb24obmV3IFBJWEkuUG9pbnQoKSwgbmV3IFBJWEkuUG9pbnQoKSwgLi4uKWAsIG9yIHRoZQoqIGFyZ3VtZW50cyBwYXNzZWQgY2FuIGJlIGZsYXQgeCx5IHZhbHVlcyBlLmcuIGBuZXcgUElYSS5Qb2x5Z29uKHgseSwgeCx5LCB4LHksIC4uLilgIHdoZXJlIGB4YCBhbmQgYHlgIGFyZSBudW1iZXJzLgoqCiogQGNsYXNzIFBoYXNlci5Qb2x5Z29uCiogQGNsYXNzZGVzYyBUaGUgcG9seWdvbiByZXByZXNlbnRzIGEgbGlzdCBvZiBvcmRlcmRlZCBwb2ludHMgaW4gc3BhY2UKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge0FycmF5PFBoYXNlci5Qb2ludD58QXJyYXk8bnVtYmVyPn0gcG9pbnRzIC0gVGhlIGFycmF5IG9mIFBvaW50cy4KKi8KUGhhc2VyLlBvbHlnb24gPSBmdW5jdGlvbiAocG9pbnRzKSB7CgogICAgUElYSS5Qb2x5Z29uLmNhbGwodGhpcywgcG9pbnRzKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBUaGUgYmFzZSBvYmplY3QgdHlwZS4KICAgICovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuUE9MWUdPTjsKCn07CgpQaGFzZXIuUG9seWdvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuUG9seWdvbi5wcm90b3R5cGUpOwpQaGFzZXIuUG9seWdvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuUG9seWdvbjsKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyBMaW5lIG9iamVjdCB3aXRoIGEgc3RhcnQgYW5kIGFuIGVuZCBwb2ludC4KKiBAY2xhc3MgTGluZQoqIEBjbGFzc2Rlc2MgUGhhc2VyIC0gTGluZQoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7bnVtYmVyfSBbeDE9MF0gLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBzdGFydCBvZiB0aGUgbGluZS4KKiBAcGFyYW0ge251bWJlcn0gW3kxPTBdIC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgc3RhcnQgb2YgdGhlIGxpbmUuCiogQHBhcmFtIHtudW1iZXJ9IFt4Mj0wXSAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGVuZCBvZiB0aGUgbGluZS4KKiBAcGFyYW0ge251bWJlcn0gW3kyPTBdIC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgZW5kIG9mIHRoZSBsaW5lLgoqIEByZXR1cm4ge1BoYXNlci5MaW5lfSBUaGlzIGxpbmUgb2JqZWN0CiovClBoYXNlci5MaW5lID0gZnVuY3Rpb24gKHgxLCB5MSwgeDIsIHkyKSB7CgogICAgeDEgPSB4MSB8fCAwOwogICAgeTEgPSB5MSB8fCAwOwogICAgeDIgPSB4MiB8fCAwOwogICAgeTIgPSB5MiB8fCAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc3RhcnQgLSBUaGUgc3RhcnQgcG9pbnQgb2YgdGhlIGxpbmUuCiAgICAqLwogICAgdGhpcy5zdGFydCA9IG5ldyBQaGFzZXIuUG9pbnQoeDEsIHkxKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGVuZCAtIFRoZSBlbmQgcG9pbnQgb2YgdGhlIGxpbmUuCiAgICAqLwogICAgdGhpcy5lbmQgPSBuZXcgUGhhc2VyLlBvaW50KHgyLCB5Mik7Cgp9OwoKUGhhc2VyLkxpbmUucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBjb21wb25lbnRzIG9mIHRoZSBMaW5lIHRvIHRoZSBzcGVjaWZpZWQgdmFsdWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5MaW5lI3NldFRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeDE9MF0gLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBzdGFydCBvZiB0aGUgbGluZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5MT0wXSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHN0YXJ0IG9mIHRoZSBsaW5lLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3gyPTBdIC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgZW5kIG9mIHRoZSBsaW5lLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3kyPTBdIC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgZW5kIG9mIHRoZSBsaW5lLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuTGluZX0gVGhpcyBsaW5lIG9iamVjdAogICAgKi8KICAgIHNldFRvOiBmdW5jdGlvbiAoeDEsIHkxLCB4MiwgeTIpIHsKCiAgICAgICAgdGhpcy5zdGFydC5zZXRUbyh4MSwgeTEpOwogICAgICAgIHRoaXMuZW5kLnNldFRvKHgyLCB5Mik7CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGxpbmUgdG8gbWF0Y2ggdGhlIHgveSBjb29yZGluYXRlcyBvZiB0aGUgdHdvIGdpdmVuIHNwcml0ZXMuCiAgICAqIENhbiBvcHRpb25hbGx5IGJlIGNhbGN1bGF0ZWQgZnJvbSB0aGVpciBjZW50ZXIgY29vcmRpbmF0ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkxpbmUjZnJvbVNwcml0ZQogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHN0YXJ0U3ByaXRlIC0gVGhlIGNvb3JkaW5hdGVzIG9mIHRoaXMgU3ByaXRlIHdpbGwgYmUgc2V0IHRvIHRoZSBMaW5lLnN0YXJ0IHBvaW50LgogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IGVuZFNwcml0ZSAtIFRoZSBjb29yZGluYXRlcyBvZiB0aGlzIFNwcml0ZSB3aWxsIGJlIHNldCB0byB0aGUgTGluZS5zdGFydCBwb2ludC4KICAgICogQHBhcmFtIHtib29sZWFufSBbdXNlQ2VudGVyPXRydWVdIC0gSWYgdHJ1ZSBpdCB3aWxsIHVzZSBzdGFydFNwcml0ZS5jZW50ZXIueCwgaWYgZmFsc2Ugc3RhcnRTcHJpdGUueC4KICAgICogQHJldHVybiB7UGhhc2VyLkxpbmV9IFRoaXMgbGluZSBvYmplY3QKICAgICovCiAgICBmcm9tU3ByaXRlOiBmdW5jdGlvbiAoc3RhcnRTcHJpdGUsIGVuZFNwcml0ZSwgdXNlQ2VudGVyKSB7CgogICAgICAgIGlmICh0eXBlb2YgdXNlQ2VudGVyID09PSAndW5kZWZpbmVkJykgeyB1c2VDZW50ZXIgPSB0cnVlOyB9CgogICAgICAgIGlmICh1c2VDZW50ZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRUbyhzdGFydFNwcml0ZS5jZW50ZXIueCwgc3RhcnRTcHJpdGUuY2VudGVyLnksIGVuZFNwcml0ZS5jZW50ZXIueCwgZW5kU3ByaXRlLmNlbnRlci55KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0VG8oc3RhcnRTcHJpdGUueCwgc3RhcnRTcHJpdGUueSwgZW5kU3ByaXRlLngsIGVuZFNwcml0ZS55KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGZvciBpbnRlcnNlY3Rpb24gYmV0d2VlbiB0aGlzIGxpbmUgYW5kIGFub3RoZXIgTGluZS4KICAgICogSWYgYXNTZWdtZW50IGlzIHRydWUgaXQgd2lsbCBjaGVjayBmb3Igc2VnbWVudCBpbnRlcnNlY3Rpb24uIElmIGFzU2VnbWVudCBpcyBmYWxzZSBpdCB3aWxsIGNoZWNrIGZvciBsaW5lIGludGVyc2VjdGlvbi4KICAgICogUmV0dXJucyB0aGUgaW50ZXJzZWN0aW9uIHNlZ21lbnQgb2YgQUIgYW5kIEVGIGFzIGEgUG9pbnQsIG9yIG51bGwgaWYgdGhlcmUgaXMgbm8gaW50ZXJzZWN0aW9uLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5MaW5lI2ludGVyc2VjdHMKICAgICogQHBhcmFtIHtQaGFzZXIuTGluZX0gbGluZSAtIFRoZSBsaW5lIHRvIGNoZWNrIGFnYWluc3QgdGhpcyBvbmUuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2FzU2VnbWVudD10cnVlXSAtIElmIHRydWUgaXQgd2lsbCBjaGVjayBmb3Igc2VnbWVudCBpbnRlcnNlY3Rpb24sIG90aGVyd2lzZSBmdWxsIGxpbmUgaW50ZXJzZWN0aW9uLgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW3Jlc3VsdF0gLSBBIFBvaW50IG9iamVjdCB0byBzdG9yZSB0aGUgcmVzdWx0IGluLCBpZiBub3QgZ2l2ZW4gYSBuZXcgb25lIHdpbGwgYmUgY3JlYXRlZC4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgaW50ZXJzZWN0aW9uIHNlZ21lbnQgb2YgdGhlIHR3byBsaW5lcyBhcyBhIFBvaW50LCBvciBudWxsIGlmIHRoZXJlIGlzIG5vIGludGVyc2VjdGlvbi4KICAgICovCiAgICBpbnRlcnNlY3RzOiBmdW5jdGlvbiAobGluZSwgYXNTZWdtZW50LCByZXN1bHQpIHsKCiAgICAgICAgcmV0dXJuIFBoYXNlci5MaW5lLmludGVyc2VjdHNQb2ludHModGhpcy5zdGFydCwgdGhpcy5lbmQsIGxpbmUuc3RhcnQsIGxpbmUuZW5kLCBhc1NlZ21lbnQsIHJlc3VsdCk7CgogICAgfSwKCiAgICAvKioKICAgICogVGVzdHMgaWYgdGhlIGdpdmVuIGNvb3JkaW5hdGVzIGZhbGwgb24gdGhpcyBsaW5lLiBTZWUgcG9pbnRPblNlZ21lbnQgdG8gdGVzdCBhZ2FpbnN0IGp1c3QgdGhlIGxpbmUgc2VnbWVudC4KICAgICogQG1ldGhvZCBQaGFzZXIuTGluZSNwb2ludE9uTGluZQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBsaW5lIHRvIGNoZWNrIGFnYWluc3QgdGhpcyBvbmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIGxpbmUgdG8gY2hlY2sgYWdhaW5zdCB0aGlzIG9uZS4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgcG9pbnQgaXMgb24gdGhlIGxpbmUsIGZhbHNlIGlmIG5vdC4KICAgICovCiAgICBwb2ludE9uTGluZTogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgcmV0dXJuICgoeCAtIHRoaXMuc3RhcnQueCkgKiAodGhpcy5lbmQueSAtIHRoaXMuZW5kLnkpID09PSAodGhpcy5lbmQueCAtIHRoaXMuc3RhcnQueCkgKiAoeSAtIHRoaXMuZW5kLnkpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUZXN0cyBpZiB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMgZmFsbCBvbiB0aGlzIGxpbmUgYW5kIHdpdGhpbiB0aGUgc2VnbWVudC4gU2VlIHBvaW50T25MaW5lIHRvIHRlc3QgYWdhaW5zdCBqdXN0IHRoZSBsaW5lLgogICAgKiBAbWV0aG9kIFBoYXNlci5MaW5lI3BvaW50T25TZWdtZW50CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIGxpbmUgdG8gY2hlY2sgYWdhaW5zdCB0aGlzIG9uZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgbGluZSB0byBjaGVjayBhZ2FpbnN0IHRoaXMgb25lLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBwb2ludCBpcyBvbiB0aGUgbGluZSBhbmQgc2VnbWVudCwgZmFsc2UgaWYgbm90LgogICAgKi8KICAgIHBvaW50T25TZWdtZW50OiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB2YXIgeE1pbiA9IE1hdGgubWluKHRoaXMuc3RhcnQueCwgdGhpcy5lbmQueCk7CiAgICAgICAgdmFyIHhNYXggPSBNYXRoLm1heCh0aGlzLnN0YXJ0LngsIHRoaXMuZW5kLngpOwogICAgICAgIHZhciB5TWluID0gTWF0aC5taW4odGhpcy5zdGFydC55LCB0aGlzLmVuZC55KTsKICAgICAgICB2YXIgeU1heCA9IE1hdGgubWF4KHRoaXMuc3RhcnQueSwgdGhpcy5lbmQueSk7CgogICAgICAgIHJldHVybiAodGhpcy5wb2ludE9uTGluZSh4LCB5KSAmJiAoeCA+PSB4TWluICYmIHggPD0geE1heCkgJiYgKHkgPj0geU1pbiAmJiB5IDw9IHlNYXgpKTsKCiAgICB9Cgp9OwoKLyoqCiogQG5hbWUgUGhhc2VyLkxpbmUjbGVuZ3RoCiogQHByb3BlcnR5IHtudW1iZXJ9IGxlbmd0aCAtIEdldHMgdGhlIGxlbmd0aCBvZiB0aGUgbGluZSBzZWdtZW50LgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkxpbmUucHJvdG90eXBlLCAibGVuZ3RoIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBNYXRoLnNxcnQoKHRoaXMuZW5kLnggLSB0aGlzLnN0YXJ0LngpICogKHRoaXMuZW5kLnggLSB0aGlzLnN0YXJ0LngpICsgKHRoaXMuZW5kLnkgLSB0aGlzLnN0YXJ0LnkpICogKHRoaXMuZW5kLnkgLSB0aGlzLnN0YXJ0LnkpKTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkxpbmUjYW5nbGUKKiBAcHJvcGVydHkge251bWJlcn0gYW5nbGUgLSBHZXRzIHRoZSBhbmdsZSBvZiB0aGUgbGluZS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5MaW5lLnByb3RvdHlwZSwgImFuZ2xlIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHRoaXMuZW5kLnggLSB0aGlzLnN0YXJ0LngsIHRoaXMuZW5kLnkgLSB0aGlzLnN0YXJ0LnkpOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuTGluZSNzbG9wZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzbG9wZSAtIEdldHMgdGhlIHNsb3BlIG9mIHRoZSBsaW5lICh5L3gpLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkxpbmUucHJvdG90eXBlLCAic2xvcGUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLmVuZC55IC0gdGhpcy5zdGFydC55KSAvICh0aGlzLmVuZC54IC0gdGhpcy5zdGFydC54KTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkxpbmUjcGVycFNsb3BlCiogQHByb3BlcnR5IHtudW1iZXJ9IHBlcnBTbG9wZSAtIEdldHMgdGhlIHBlcnBlbmRpY3VsYXIgc2xvcGUgb2YgdGhlIGxpbmUgKHgveSkuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuTGluZS5wcm90b3R5cGUsICJwZXJwU2xvcGUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIC0oKHRoaXMuZW5kLnggLSB0aGlzLnN0YXJ0LngpIC8gKHRoaXMuZW5kLnkgLSB0aGlzLnN0YXJ0LnkpKTsKICAgIH0KCn0pOwoKLyoqCiogQ2hlY2tzIGZvciBpbnRlcnNlY3Rpb24gYmV0d2VlbiB0d28gbGluZXMgYXMgZGVmaW5lZCBieSB0aGUgZ2l2ZW4gc3RhcnQgYW5kIGVuZCBwb2ludHMuCiogSWYgYXNTZWdtZW50IGlzIHRydWUgaXQgd2lsbCBjaGVjayBmb3IgbGluZSBzZWdtZW50IGludGVyc2VjdGlvbi4gSWYgYXNTZWdtZW50IGlzIGZhbHNlIGl0IHdpbGwgY2hlY2sgZm9yIGxpbmUgaW50ZXJzZWN0aW9uLgoqIFJldHVybnMgdGhlIGludGVyc2VjdGlvbiBzZWdtZW50IG9mIEFCIGFuZCBFRiBhcyBhIFBvaW50LCBvciBudWxsIGlmIHRoZXJlIGlzIG5vIGludGVyc2VjdGlvbi4KKiBBZGFwdGVkIGZyb20gY29kZSBieSBLZWl0aCBIYWlyCioKKiBAbWV0aG9kIFBoYXNlci5MaW5lLmludGVyc2VjdHMKKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYSAtIFRoZSBzdGFydCBvZiB0aGUgZmlyc3QgTGluZSB0byBiZSBjaGVja2VkLgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBiIC0gVGhlIGVuZCBvZiB0aGUgZmlyc3QgbGluZSB0byBiZSBjaGVja2VkLgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBlIC0gVGhlIHN0YXJ0IG9mIHRoZSBzZWNvbmQgTGluZSB0byBiZSBjaGVja2VkLgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBmIC0gVGhlIGVuZCBvZiB0aGUgc2Vjb25kIGxpbmUgdG8gYmUgY2hlY2tlZC4KKiBAcGFyYW0ge2Jvb2xlYW59IFthc1NlZ21lbnQ9dHJ1ZV0gLSBJZiB0cnVlIGl0IHdpbGwgY2hlY2sgZm9yIHNlZ21lbnQgaW50ZXJzZWN0aW9uLCBvdGhlcndpc2UgZnVsbCBsaW5lIGludGVyc2VjdGlvbi4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW3Jlc3VsdF0gLSBBIFBvaW50IG9iamVjdCB0byBzdG9yZSB0aGUgcmVzdWx0IGluLCBpZiBub3QgZ2l2ZW4gYSBuZXcgb25lIHdpbGwgYmUgY3JlYXRlZC4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBpbnRlcnNlY3Rpb24gc2VnbWVudCBvZiB0aGUgdHdvIGxpbmVzIGFzIGEgUG9pbnQsIG9yIG51bGwgaWYgdGhlcmUgaXMgbm8gaW50ZXJzZWN0aW9uLgoqLwpQaGFzZXIuTGluZS5pbnRlcnNlY3RzUG9pbnRzID0gZnVuY3Rpb24gKGEsIGIsIGUsIGYsIGFzU2VnbWVudCwgcmVzdWx0KSB7CgogICAgaWYgKHR5cGVvZiBhc1NlZ21lbnQgPT09ICd1bmRlZmluZWQnKSB7IGFzU2VnbWVudCA9IHRydWU7IH0KICAgIGlmICh0eXBlb2YgcmVzdWx0ID09PSAndW5kZWZpbmVkJykgeyByZXN1bHQgPSBuZXcgUGhhc2VyLlBvaW50KCk7IH0KCiAgICB2YXIgYTEgPSBiLnkgLSBhLnk7CiAgICB2YXIgYTIgPSBmLnkgLSBlLnk7CiAgICB2YXIgYjEgPSBhLnggLSBiLng7CiAgICB2YXIgYjIgPSBlLnggLSBmLng7CiAgICB2YXIgYzEgPSAoYi54ICogYS55KSAtIChhLnggKiBiLnkpOwogICAgdmFyIGMyID0gKGYueCAqIGUueSkgLSAoZS54ICogZi55KTsKICAgIHZhciBkZW5vbSA9IChhMSAqIGIyKSAtIChhMiAqIGIxKTsKCiAgICBpZiAoZGVub20gPT09IDApCiAgICB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgcmVzdWx0LnggPSAoKGIxICogYzIpIC0gKGIyICogYzEpKSAvIGRlbm9tOwogICAgcmVzdWx0LnkgPSAoKGEyICogYzEpIC0gKGExICogYzIpKSAvIGRlbm9tOwogCiAgICBpZiAoYXNTZWdtZW50KQogICAgewogICAgICAgIGlmIChNYXRoLnBvdygocmVzdWx0LnggLSBiLngpICsgKHJlc3VsdC55IC0gYi55KSwgMikgPiBNYXRoLnBvdygoYS54IC0gYi54KSArIChhLnkgLSBiLnkpLCAyKSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKE1hdGgucG93KChyZXN1bHQueCAtIGEueCkgKyAocmVzdWx0LnkgLSBhLnkpLCAyKSA+IE1hdGgucG93KChhLnggLSBiLngpICsgKGEueSAtIGIueSksIDIpKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAoTWF0aC5wb3coKHJlc3VsdC54IC0gZi54KSArIChyZXN1bHQueSAtIGYueSksIDIpID4gTWF0aC5wb3coKGUueCAtIGYueCkgKyAoZS55IC0gZi55KSwgMikpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChNYXRoLnBvdygocmVzdWx0LnggLSBlLngpICsgKHJlc3VsdC55IC0gZS55KSwgMikgPiBNYXRoLnBvdygoZS54IC0gZi54KSArIChlLnkgLSBmLnkpLCAyKSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVzdWx0OwoKfTsKCi8qKgoqIENoZWNrcyBmb3IgaW50ZXJzZWN0aW9uIGJldHdlZW4gdHdvIGxpbmVzLgoqIElmIGFzU2VnbWVudCBpcyB0cnVlIGl0IHdpbGwgY2hlY2sgZm9yIHNlZ21lbnQgaW50ZXJzZWN0aW9uLgoqIElmIGFzU2VnbWVudCBpcyBmYWxzZSBpdCB3aWxsIGNoZWNrIGZvciBsaW5lIGludGVyc2VjdGlvbi4KKiBSZXR1cm5zIHRoZSBpbnRlcnNlY3Rpb24gc2VnbWVudCBvZiBBQiBhbmQgRUYgYXMgYSBQb2ludCwgb3IgbnVsbCBpZiB0aGVyZSBpcyBubyBpbnRlcnNlY3Rpb24uCiogQWRhcHRlZCBmcm9tIGNvZGUgYnkgS2VpdGggSGFpcgoqCiogQG1ldGhvZCBQaGFzZXIuTGluZS5pbnRlcnNlY3RzCiogQHBhcmFtIHtQaGFzZXIuTGluZX0gYSAtIFRoZSBmaXJzdCBMaW5lIHRvIGJlIGNoZWNrZWQuCiogQHBhcmFtIHtQaGFzZXIuTGluZX0gYiAtIFRoZSBzZWNvbmQgTGluZSB0byBiZSBjaGVja2VkLgoqIEBwYXJhbSB7Ym9vbGVhbn0gW2FzU2VnbWVudD10cnVlXSAtIElmIHRydWUgaXQgd2lsbCBjaGVjayBmb3Igc2VnbWVudCBpbnRlcnNlY3Rpb24sIG90aGVyd2lzZSBmdWxsIGxpbmUgaW50ZXJzZWN0aW9uLgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbcmVzdWx0XSAtIEEgUG9pbnQgb2JqZWN0IHRvIHN0b3JlIHRoZSByZXN1bHQgaW4sIGlmIG5vdCBnaXZlbiBhIG5ldyBvbmUgd2lsbCBiZSBjcmVhdGVkLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIGludGVyc2VjdGlvbiBzZWdtZW50IG9mIHRoZSB0d28gbGluZXMgYXMgYSBQb2ludCwgb3IgbnVsbCBpZiB0aGVyZSBpcyBubyBpbnRlcnNlY3Rpb24uCiovClBoYXNlci5MaW5lLmludGVyc2VjdHMgPSBmdW5jdGlvbiAoYSwgYiwgYXNTZWdtZW50LCByZXN1bHQpIHsKCiAgICByZXR1cm4gUGhhc2VyLkxpbmUuaW50ZXJzZWN0c1BvaW50cyhhLnN0YXJ0LCBhLmVuZCwgYi5zdGFydCwgYi5lbmQsIGFzU2VnbWVudCwgcmVzdWx0KTsKCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIuTmV0IGhhbmRsZXMgYnJvd3NlciBVUkwgcmVsYXRlZCB0YXNrcyBzdWNoIGFzIGNoZWNraW5nIGhvc3QgbmFtZXMsIGRvbWFpbiBuYW1lcyBhbmQgcXVlcnkgc3RyaW5nIG1hbmlwdWxhdGlvbi4KKgoqIEBjbGFzcyBQaGFzZXIuTmV0CiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuTmV0ID0gZnVuY3Rpb24gKGdhbWUpIHsKICAgIAogICAgdGhpcy5nYW1lID0gZ2FtZTsKCn07CgpQaGFzZXIuTmV0LnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgaG9zdG5hbWUgZ2l2ZW4gYnkgdGhlIGJyb3dzZXIuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5OZXQjZ2V0SG9zdE5hbWUKICAgICogQHJldHVybiB7c3RyaW5nfQogICAgKi8KICAgIGdldEhvc3ROYW1lOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh3aW5kb3cubG9jYXRpb24gJiYgd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDb21wYXJlcyB0aGUgZ2l2ZW4gZG9tYWluIG5hbWUgYWdhaW5zdCB0aGUgaG9zdG5hbWUgb2YgdGhlIGJyb3dzZXIgY29udGFpbmluZyB0aGUgZ2FtZS4KICAgICogSWYgdGhlIGRvbWFpbiBuYW1lIGlzIGZvdW5kIGl0IHJldHVybnMgdHJ1ZS4KICAgICogWW91IGNhbiBzcGVjaWZ5IGEgcGFydCBvZiBhIGRvbWFpbiwgZm9yIGV4YW1wbGUgJ2dvb2dsZScgd291bGQgbWF0Y2ggJ2dvb2dsZS5jb20nLCAnZ29vZ2xlLmNvLnVrJywgZXRjLgogICAgKiBEbyBub3QgaW5jbHVkZSAnaHR0cDovLycgYXQgdGhlIHN0YXJ0LgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTmV0I2NoZWNrRG9tYWluTmFtZQogICAgKiBAcGFyYW0ge3N0cmluZ30gZG9tYWluCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWYgdGhlIGdpdmVuIGRvbWFpbiBmcmFnbWVudCBjYW4gYmUgZm91bmQgaW4gdGhlIHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZQogICAgKi8KICAgIGNoZWNrRG9tYWluTmFtZTogZnVuY3Rpb24gKGRvbWFpbikgewogICAgICAgIHJldHVybiB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWUuaW5kZXhPZihkb21haW4pICE9PSAtMTsKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZXMgYSB2YWx1ZSBvbiB0aGUgUXVlcnkgU3RyaW5nIGFuZCByZXR1cm5zIGl0IGluIGZ1bGwuCiAgICAqIElmIHRoZSB2YWx1ZSBkb2Vzbid0IGFscmVhZHkgZXhpc3QgaXQgaXMgc2V0LgogICAgKiBJZiB0aGUgdmFsdWUgZXhpc3RzIGl0IGlzIHJlcGxhY2VkIHdpdGggdGhlIG5ldyB2YWx1ZSBnaXZlbi4gSWYgeW91IGRvbid0IHByb3ZpZGUgYSBuZXcgdmFsdWUgaXQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBxdWVyeSBzdHJpbmcuCiAgICAqIE9wdGlvbmFsbHkgeW91IGNhbiByZWRpcmVjdCB0byB0aGUgbmV3IHVybCwgb3IganVzdCByZXR1cm4gaXQgYXMgYSBzdHJpbmcuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5OZXQjdXBkYXRlUXVlcnlTdHJpbmcKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBxdWVyeXN0cmluZyBrZXkgdG8gdXBkYXRlLgogICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgLSBUaGUgbmV3IHZhbHVlIHRvIGJlIHNldC4gSWYgaXQgYWxyZWFkeSBleGlzdHMgaXQgd2lsbCBiZSByZXBsYWNlZC4KICAgICogQHBhcmFtIHtib29sZWFufSByZWRpcmVjdCAtIElmIHRydWUgdGhlIGJyb3dzZXIgd2lsbCBpc3N1ZSBhIHJlZGlyZWN0IHRvIHRoZSB1cmwgd2l0aCB0aGUgbmV3IHF1ZXJ5c3RyaW5nLgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIFVSTCB0byBtb2RpZnkuIElmIG5vbmUgaXMgZ2l2ZW4gaXQgdXNlcyB3aW5kb3cubG9jYXRpb24uaHJlZi4KICAgICogQHJldHVybiB7c3RyaW5nfSBJZiByZWRpcmVjdCBpcyBmYWxzZSB0aGVuIHRoZSBtb2RpZmllZCB1cmwgYW5kIHF1ZXJ5IHN0cmluZyBpcyByZXR1cm5lZC4KICAgICovCiAgICB1cGRhdGVRdWVyeVN0cmluZzogZnVuY3Rpb24gKGtleSwgdmFsdWUsIHJlZGlyZWN0LCB1cmwpIHsKCiAgICAgICAgaWYgKHR5cGVvZiByZWRpcmVjdCA9PT0gInVuZGVmaW5lZCIpIHsgcmVkaXJlY3QgPSBmYWxzZTsgfQogICAgICAgIGlmICh0eXBlb2YgdXJsID09PSAidW5kZWZpbmVkIiB8fCB1cmwgPT09ICcnKSB7IHVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmOyB9CgogICAgICAgIHZhciBvdXRwdXQgPSAnJzsKICAgICAgICB2YXIgcmUgPSBuZXcgUmVnRXhwKCIoWz98Jl0pIiArIGtleSArICI9Lio/KCZ8I3wkKSguKikiLCAiZ2kiKTsKICAgICAgICAKICAgICAgICBpZiAocmUudGVzdCh1cmwpKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgIT09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG91dHB1dCA9IHVybC5yZXBsYWNlKHJlLCAnJDEnICsga2V5ICsgIj0iICsgdmFsdWUgKyAnJDIkMycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3V0cHV0ID0gdXJsLnJlcGxhY2UocmUsICckMSQzJykucmVwbGFjZSgvKCZ8XD8pJC8sICcnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSAhPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHNlcGFyYXRvciA9IHVybC5pbmRleE9mKCc/JykgIT09IC0xID8gJyYnIDogJz8nOwogICAgICAgICAgICAgICAgdmFyIGhhc2ggPSB1cmwuc3BsaXQoJyMnKTsKICAgICAgICAgICAgICAgIHVybCA9IGhhc2hbMF0gKyBzZXBhcmF0b3IgKyBrZXkgKyAnPScgKyB2YWx1ZTsKCiAgICAgICAgICAgICAgICBpZiAoaGFzaFsxXSkgewogICAgICAgICAgICAgICAgICAgIHVybCArPSAnIycgKyBoYXNoWzFdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG91dHB1dCA9IHVybDsKCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvdXRwdXQgPSB1cmw7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChyZWRpcmVjdCkKICAgICAgICB7CiAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gb3V0cHV0OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBRdWVyeSBTdHJpbmcgYXMgYW4gb2JqZWN0LgogICAgKiBJZiB5b3Ugc3BlY2lmeSBhIHBhcmFtZXRlciBpdCB3aWxsIHJldHVybiBqdXN0IHRoZSB2YWx1ZSBvZiB0aGF0IHBhcmFtZXRlciwgc2hvdWxkIGl0IGV4aXN0LgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTmV0I2dldFF1ZXJ5U3RyaW5nCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbcGFyYW1ldGVyPScnXSAtIElmIHNwZWNpZmllZCB0aGlzIHdpbGwgcmV0dXJuIGp1c3QgdGhlIHZhbHVlIGZvciB0aGF0IGtleS4KICAgICogQHJldHVybiB7c3RyaW5nfG9iamVjdH0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGtleSB2YWx1ZSBwYWlycyBmb3VuZCBpbiB0aGUgcXVlcnkgc3RyaW5nIG9yIGp1c3QgdGhlIHZhbHVlIGlmIGEgcGFyYW1ldGVyIHdhcyBnaXZlbi4KICAgICovCiAgICBnZXRRdWVyeVN0cmluZzogZnVuY3Rpb24gKHBhcmFtZXRlcikgewoKICAgICAgICBpZiAodHlwZW9mIHBhcmFtZXRlciA9PT0gInVuZGVmaW5lZCIpIHsgcGFyYW1ldGVyID0gJyc7IH0KCiAgICAgICAgdmFyIG91dHB1dCA9IHt9OwogICAgICAgIHZhciBrZXlWYWx1ZXMgPSBsb2NhdGlvbi5zZWFyY2guc3Vic3RyaW5nKDEpLnNwbGl0KCcmJyk7CgogICAgICAgIGZvciAodmFyIGkgaW4ga2V5VmFsdWVzKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGtleSA9IGtleVZhbHVlc1tpXS5zcGxpdCgnPScpOwoKICAgICAgICAgICAgaWYgKGtleS5sZW5ndGggPiAxKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAocGFyYW1ldGVyICYmIHBhcmFtZXRlciA9PSB0aGlzLmRlY29kZVVSSShrZXlbMF0pKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRlY29kZVVSSShrZXlbMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG91dHB1dFt0aGlzLmRlY29kZVVSSShrZXlbMF0pXSA9IHRoaXMuZGVjb2RlVVJJKGtleVsxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBvdXRwdXQ7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgUXVlcnkgU3RyaW5nIGFzIGFuIG9iamVjdC4KICAgICogSWYgeW91IHNwZWNpZnkgYSBwYXJhbWV0ZXIgaXQgd2lsbCByZXR1cm4ganVzdCB0aGUgdmFsdWUgb2YgdGhhdCBwYXJhbWV0ZXIsIHNob3VsZCBpdCBleGlzdC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk5ldCNkZWNvZGVVUkkKICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIC0gVGhlIFVSSSBjb21wb25lbnQgdG8gYmUgZGVjb2RlZC4KICAgICogQHJldHVybiB7c3RyaW5nfSBUaGUgZGVjb2RlZCB2YWx1ZS4KICAgICovCiAgICBkZWNvZGVVUkk6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQodmFsdWUucmVwbGFjZSgvXCsvZywgIiAiKSk7CiAgICB9Cgp9OwoKUGhhc2VyLk5ldC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuTmV0OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyIC0gVHdlZW5NYW5hZ2VyCiogCiogQGNsYXNzIFBoYXNlci5Ud2Vlbk1hbmFnZXIKKiBAY2xhc3NkZXNjIAoqIFBoYXNlci5HYW1lIGhhcyBhIHNpbmdsZSBpbnN0YW5jZSBvZiB0aGUgVHdlZW5NYW5hZ2VyIHRocm91Z2ggd2hpY2ggYWxsIFR3ZWVuIG9iamVjdHMgYXJlIGNyZWF0ZWQgYW5kIHVwZGF0ZWQuCiogVHdlZW5zIGFyZSBob29rZWQgaW50byB0aGUgZ2FtZSBjbG9jayBhbmQgcGF1c2Ugc3lzdGVtLCBhZGp1c3RpbmcgYmFzZWQgb24gdGhlIGdhbWUgc3RhdGUuCioKKiBUd2Vlbk1hbmFnZXIgaXMgYmFzZWQgaGVhdmlseSBvbiB0d2Vlbi5qcyBieSBodHRwOi8vc29sZWRhZHBlbmFkZXMuY29tLgoqIFRoZSBkaWZmZXJlbmNlIGJlaW5nIHRoYXQgdHdlZW5zIGJlbG9uZyB0byBhIGdhbWVzIGluc3RhbmNlIG9mIFR3ZWVuTWFuYWdlciwgcmF0aGVyIHRoYW4gdG8gYSBnbG9iYWwgVFdFRU4gb2JqZWN0LgoqIEl0IGFsc28gaGFzIGNhbGxiYWNrcyBzd2FwcGVkIGZvciBTaWduYWxzIGFuZCBhIGZldyBpc3N1ZXMgcGF0Y2hlZCB3aXRoIHJlZ2FyZCB0byBwcm9wZXJ0aWVzIGFuZCBjb21wbGV0aW9uIGVycm9ycy4KKiBQbGVhc2Ugc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9zb2xlL3R3ZWVuLmpzIGZvciBhIGZ1bGwgbGlzdCBvZiBjb250cmlidXRvcnMuCiogQGNvbnN0cnVjdG9yCioKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5Ud2Vlbk1hbmFnZXIgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXk8UGhhc2VyLlR3ZWVuPn0gX3R3ZWVucyAtIEFsbCBvZiB0aGUgY3VycmVudGx5IHJ1bm5pbmcgdHdlZW5zLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3R3ZWVucyA9IFtdOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheTxQaGFzZXIuVHdlZW4+fSBfYWRkIC0gQWxsIG9mIHRoZSB0d2VlbnMgcXVldWVkIHRvIGJlIGFkZGVkIGluIHRoZSBuZXh0IHVwZGF0ZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9hZGQgPSBbXTsKCiAgICB0aGlzLmdhbWUub25QYXVzZS5hZGQodGhpcy5wYXVzZUFsbCwgdGhpcyk7CiAgICB0aGlzLmdhbWUub25SZXN1bWUuYWRkKHRoaXMucmVzdW1lQWxsLCB0aGlzKTsKCn07CgpQaGFzZXIuVHdlZW5NYW5hZ2VyLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogR2V0IGFsbCB0aGUgdHdlZW4gb2JqZWN0cyBpbiBhbiBhcnJheS4KICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW5NYW5hZ2VyI2dldEFsbAogICAgKiBAcmV0dXJucyB7UGhhc2VyLlR3ZWVuW119IEFycmF5IHdpdGggYWxsIHR3ZWVuIG9iamVjdHMuCiAgICAqLwogICAgZ2V0QWxsOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiB0aGlzLl90d2VlbnM7CgogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlIGFsbCB0d2VlbnMgcnVubmluZyBhbmQgaW4gdGhlIHF1ZXVlLiBEb2Vzbid0IGNhbGwgYW55IG9mIHRoZSB0d2VlbiBvbkNvbXBsZXRlIGV2ZW50cy4KICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW5NYW5hZ2VyI3JlbW92ZUFsbAogICAgKi8KICAgIHJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3R3ZWVucy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3R3ZWVuc1tpXS5wZW5kaW5nRGVsZXRlID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2FkZCA9IFtdOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyB0d2VlbiBpbnRvIHRoZSBUd2Vlbk1hbmFnZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciNhZGQKICAgICogQHBhcmFtIHtQaGFzZXIuVHdlZW59IHR3ZWVuIC0gVGhlIHR3ZWVuIG9iamVjdCB5b3Ugd2FudCB0byBhZGQuCiAgICAqIEByZXR1cm5zIHtQaGFzZXIuVHdlZW59IFRoZSB0d2VlbiBvYmplY3QgeW91IGFkZGVkIHRvIHRoZSBtYW5hZ2VyLgogICAgKi8KICAgIGFkZDogZnVuY3Rpb24gKHR3ZWVuKSB7CgogICAgICAgIHRoaXMuX2FkZC5wdXNoKHR3ZWVuKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGUgYSB0d2VlbiBvYmplY3QgZm9yIGEgc3BlY2lmaWMgb2JqZWN0LiBUaGUgb2JqZWN0IGNhbiBiZSBhbnkgSmF2YVNjcmlwdCBvYmplY3Qgb3IgUGhhc2VyIG9iamVjdCBzdWNoIGFzIFNwcml0ZS4gCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciNjcmVhdGUKICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCAtIE9iamVjdCB0aGUgdHdlZW4gd2lsbCBiZSBydW4gb24uCiAgICAqIEByZXR1cm5zIHtQaGFzZXIuVHdlZW59IFRoZSBuZXdseSBjcmVhdGVkIHR3ZWVuIG9iamVjdC4KICAgICovCiAgICBjcmVhdGU6IGZ1bmN0aW9uIChvYmplY3QpIHsKCiAgICAgICAgcmV0dXJuIG5ldyBQaGFzZXIuVHdlZW4ob2JqZWN0LCB0aGlzLmdhbWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZSBhIHR3ZWVuIGZyb20gdGhpcyBtYW5hZ2VyLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Ud2Vlbk1hbmFnZXIjcmVtb3ZlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlR3ZWVufSB0d2VlbiAtIFRoZSB0d2VlbiBvYmplY3QgeW91IHdhbnQgdG8gcmVtb3ZlLgogICAgKi8KICAgIHJlbW92ZTogZnVuY3Rpb24gKHR3ZWVuKSB7CgogICAgICAgIHZhciBpID0gdGhpcy5fdHdlZW5zLmluZGV4T2YodHdlZW4pOwoKICAgICAgICBpZiAoaSAhPT0gLTEpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl90d2VlbnNbaV0ucGVuZGluZ0RlbGV0ZSA9IHRydWU7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZSBhbGwgdGhlIHR3ZWVuIG9iamVjdHMgeW91IGFkZGVkIHRvIHRoaXMgbWFuYWdlci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW5NYW5hZ2VyI3VwZGF0ZQogICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJuIGZhbHNlIGlmIHRoZXJlJ3Mgbm8gdHdlZW4gdG8gdXBkYXRlLCBvdGhlcndpc2UgcmV0dXJuIHRydWUuCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl90d2VlbnMubGVuZ3RoID09PSAwICYmIHRoaXMuX2FkZC5sZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgdmFyIG51bVR3ZWVucyA9IHRoaXMuX3R3ZWVucy5sZW5ndGg7CgogICAgICAgIHdoaWxlIChpIDwgbnVtVHdlZW5zKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3R3ZWVuc1tpXS51cGRhdGUodGhpcy5nYW1lLnRpbWUubm93KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fdHdlZW5zLnNwbGljZShpLCAxKTsKCiAgICAgICAgICAgICAgICBudW1Ud2VlbnMtLTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gIElmIHRoZXJlIGFyZSBhbnkgbmV3IHR3ZWVucyB0byBiZSBhZGRlZCwgZG8gc28gbm93IC0gb3RoZXJ3aXNlIHRoZXkgY2FuIGJlIHNwbGljZWQgb3V0IG9mIHRoZSBhcnJheSBiZWZvcmUgZXZlciBydW5uaW5nCiAgICAgICAgaWYgKHRoaXMuX2FkZC5sZW5ndGggPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fdHdlZW5zID0gdGhpcy5fdHdlZW5zLmNvbmNhdCh0aGlzLl9hZGQpOwogICAgICAgICAgICB0aGlzLl9hZGQubGVuZ3RoID0gMDsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrcyB0byBzZWUgaWYgYSBwYXJ0aWN1bGFyIFNwcml0ZSBpcyBjdXJyZW50bHkgYmVpbmcgdHdlZW5lZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW5NYW5hZ2VyI2lzVHdlZW5pbmcKICAgICogQHBhcmFtIHtvYmplY3R9IG9iamVjdCAtIFRoZSBvYmplY3QgdG8gY2hlY2sgZm9yIHR3ZWVucyBhZ2FpbnN0LgogICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHRoZSBvYmplY3QgaXMgY3VycmVudGx5IGJlaW5nIHR3ZWVuZWQsIGZhbHNlIGlmIG5vdC4KICAgICovCiAgICBpc1R3ZWVuaW5nOiBmdW5jdGlvbihvYmplY3QpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3R3ZWVucy5zb21lKGZ1bmN0aW9uKHR3ZWVuKSB7CiAgICAgICAgICAgIHJldHVybiB0d2Vlbi5fb2JqZWN0ID09PSBvYmplY3Q7CiAgICAgICAgfSk7CgogICAgfSwKCiAgICAvKioKICAgICogUGF1c2VzIGFsbCBjdXJyZW50bHkgcnVubmluZyB0d2VlbnMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciN1cGRhdGUKICAgICovCiAgICBwYXVzZUFsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5fdHdlZW5zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fdHdlZW5zW2ldLnBhdXNlKCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFBhdXNlcyBhbGwgY3VycmVudGx5IHBhdXNlZCB0d2VlbnMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciNyZXN1bWVBbGwKICAgICovCiAgICByZXN1bWVBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuX3R3ZWVucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3R3ZWVuc1tpXS5yZXN1bWUoKTsKICAgICAgICB9CgogICAgfQoKfTsKClBoYXNlci5Ud2Vlbk1hbmFnZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlR3ZWVuTWFuYWdlcjsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFR3ZWVuIGNvbnN0cnVjdG9yCiogQ3JlYXRlIGEgbmV3IDxjb2RlPlR3ZWVuPC9jb2RlPi4KKgoqIEBjbGFzcyBQaGFzZXIuVHdlZW4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge29iamVjdH0gb2JqZWN0IC0gVGFyZ2V0IG9iamVjdCB3aWxsIGJlIGFmZmVjdGVkIGJ5IHRoaXMgdHdlZW4uCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKi8KUGhhc2VyLlR3ZWVuID0gZnVuY3Rpb24gKG9iamVjdCwgZ2FtZSkgewoKICAgIC8qKgogICAgKiBSZWZlcmVuY2UgdG8gdGhlIHRhcmdldCBvYmplY3QuCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfb2JqZWN0CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fb2JqZWN0ID0gb2JqZWN0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuVHdlZW5NYW5hZ2VyfSBfbWFuYWdlciAtIFJlZmVyZW5jZSB0byB0aGUgVHdlZW5NYW5hZ2VyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX21hbmFnZXIgPSB0aGlzLmdhbWUudHdlZW5zOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX3ZhbHVlc1N0YXJ0IC0gUHJpdmF0ZSB2YWx1ZSBvYmplY3QuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdmFsdWVzU3RhcnQgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF92YWx1ZXNFbmQgLSBQcml2YXRlIHZhbHVlIG9iamVjdC4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl92YWx1ZXNFbmQgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF92YWx1ZXNTdGFydFJlcGVhdCAtIFByaXZhdGUgdmFsdWUgb2JqZWN0LgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3ZhbHVlc1N0YXJ0UmVwZWF0ID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZHVyYXRpb24gLSBQcml2YXRlIGR1cmF0aW9uIGNvdW50ZXIuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fZHVyYXRpb24gPSAxMDAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3JlcGVhdCAtIFByaXZhdGUgcmVwZWF0IGNvdW50ZXIuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fcmVwZWF0ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfeW95byAtIFByaXZhdGUgeW95byBmbGFnLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3lveW8gPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfcmV2ZXJzZWQgLSBQcml2YXRlIHJldmVyc2VkIGZsYWcuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fcmV2ZXJzZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9kZWxheVRpbWUgLSBQcml2YXRlIGRlbGF5IGNvdW50ZXIuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fZGVsYXlUaW1lID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9zdGFydFRpbWUgLSBQcml2YXRlIHN0YXJ0IHRpbWUgY291bnRlci4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQgbnVsbAogICAgKi8KICAgIHRoaXMuX3N0YXJ0VGltZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9lYXNpbmdGdW5jdGlvbiAtIFRoZSBlYXNpbmcgZnVuY3Rpb24gdXNlZCBmb3IgdGhlIHR3ZWVuLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2Vhc2luZ0Z1bmN0aW9uID0gUGhhc2VyLkVhc2luZy5MaW5lYXIuTm9uZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX2ludGVycG9sYXRpb25GdW5jdGlvbiAtIFRoZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uIHVzZWQgZm9yIHRoZSB0d2Vlbi4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9pbnRlcnBvbGF0aW9uRnVuY3Rpb24gPSBQaGFzZXIuTWF0aC5saW5lYXJJbnRlcnBvbGF0aW9uOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBfY2hhaW5lZFR3ZWVucyAtIEEgcHJpdmF0ZSBhcnJheSBvZiBjaGFpbmVkIHR3ZWVucy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9jaGFpbmVkVHdlZW5zID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX29uU3RhcnRDYWxsYmFja0ZpcmVkIC0gUHJpdmF0ZSBmbGFnLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uU3RhcnRDYWxsYmFja0ZpcmVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vblVwZGF0ZUNhbGxiYWNrIC0gQW4gb25VcGRhdGUgY2FsbGJhY2suCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0IG51bGwKICAgICovCiAgICB0aGlzLl9vblVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF9vblVwZGF0ZUNhbGxiYWNrQ29udGV4dCAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRvIGNhbGwgdGhlIG9uVXBkYXRlIGNhbGxiYWNrLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdCBudWxsCiAgICAqLwogICAgdGhpcy5fb25VcGRhdGVDYWxsYmFja0NvbnRleHQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3BhdXNlZFRpbWUgLSBQcml2YXRlIHBhdXNlIHRpbWVyLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3BhdXNlZFRpbWUgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHBlbmRpbmdEZWxldGUgLSBJZiB0aGlzIHR3ZWVuIGlzIHJlYWR5IHRvIGJlIGRlbGV0ZWQgYnkgdGhlIFR3ZWVuTWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBlbmRpbmdEZWxldGUgPSBmYWxzZTsKCiAgICAvLyBTZXQgYWxsIHN0YXJ0aW5nIHZhbHVlcyBwcmVzZW50IG9uIHRoZSB0YXJnZXQgb2JqZWN0CiAgICBmb3IgKHZhciBmaWVsZCBpbiBvYmplY3QpCiAgICB7CiAgICAgICAgdGhpcy5fdmFsdWVzU3RhcnRbZmllbGRdID0gcGFyc2VGbG9hdChvYmplY3RbZmllbGRdLCAxMCk7CiAgICB9CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uU3RhcnQgLSBUaGUgb25TdGFydCBldmVudCBpcyBmaXJlZCB3aGVuIHRoZSBUd2VlbiBiZWdpbnMuCiAgICAqLwogICAgdGhpcy5vblN0YXJ0ID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkxvb3AgLSBUaGUgb25Mb29wIGV2ZW50IGlzIGZpcmVkIGlmIHRoZSBUd2VlbiBsb29wcy4KICAgICovCiAgICB0aGlzLm9uTG9vcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Db21wbGV0ZSAtIFRoZSBvbkNvbXBsZXRlIGV2ZW50IGlzIGZpcmVkIHdoZW4gdGhlIFR3ZWVuIGNvbXBsZXRlcy4gRG9lcyBub3QgZmlyZSBpZiB0aGUgVHdlZW4gaXMgc2V0IHRvIGxvb3AuCiAgICAqLwogICAgdGhpcy5vbkNvbXBsZXRlID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc1J1bm5pbmcgLSBJZiB0aGUgdHdlZW4gaXMgcnVubmluZyB0aGlzIGlzIHNldCB0byB0cnVlLCBvdGhlcndpc2UgZmFsc2UuIFR3ZWVucyB0aGF0IGFyZSBpbiBhIGRlbGF5ZWQgc3RhdGUsIHdhaXRpbmcgdG8gc3RhcnQsIGFyZSBjb25zaWRlcmVkIGFzIGJlaW5nIHJ1bm5pbmcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc1J1bm5pbmcgPSBmYWxzZTsKCn07CgpQaGFzZXIuVHdlZW4ucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBDb25maWd1cmUgdGhlIFR3ZWVuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI3RvCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBwcm9wZXJ0aWVzIC0gUHJvcGVydGllcyB5b3Ugd2FudCB0byB0d2Vlbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbj0xMDAwXSAtIER1cmF0aW9uIG9mIHRoaXMgdHdlZW4gaW4gbXMuCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtlYXNlPW51bGxdIC0gRWFzaW5nIGZ1bmN0aW9uLiBJZiBub3Qgc2V0IGl0IHdpbGwgZGVmYXVsdCB0byBQaGFzZXIuRWFzaW5nLkxpbmVhci5Ob25lLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFthdXRvU3RhcnQ9ZmFsc2VdIC0gV2hldGhlciB0aGlzIHR3ZWVuIHdpbGwgc3RhcnQgYXV0b21hdGljYWxseSBvciBub3QuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZGVsYXk9MF0gLSBEZWxheSBiZWZvcmUgdGhpcyB0d2VlbiB3aWxsIHN0YXJ0LCBkZWZhdWx0cyB0byAwIChubyBkZWxheSkuIFZhbHVlIGdpdmVuIGlzIGluIG1zLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXBlYXQ9MF0gLSBTaG91bGQgdGhlIHR3ZWVuIGF1dG9tYXRpY2FsbHkgcmVzdGFydCBvbmNlIGNvbXBsZXRlPyAoaWdub3JlcyBhbnkgY2hhaW5lZCB0d2VlbnMpLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt5b3lvPWZhbHNlXSAtIEEgdHdlZW4gdGhhdCB5b3lvcyB3aWxsIHJldmVyc2UgaXRzZWxmIHdoZW4gaXQgY29tcGxldGVzLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IFRoaXMgVHdlZW4gb2JqZWN0LgogICAgKi8KICAgIHRvOiBmdW5jdGlvbiAocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGF1dG9TdGFydCwgZGVsYXksIHJlcGVhdCwgeW95bykgewoKICAgICAgICBkdXJhdGlvbiA9IGR1cmF0aW9uIHx8IDEwMDA7CiAgICAgICAgZWFzZSA9IGVhc2UgfHwgbnVsbDsKICAgICAgICBhdXRvU3RhcnQgPSBhdXRvU3RhcnQgfHwgZmFsc2U7CiAgICAgICAgZGVsYXkgPSBkZWxheSB8fCAwOwogICAgICAgIHJlcGVhdCA9IHJlcGVhdCB8fCAwOwogICAgICAgIHlveW8gPSB5b3lvIHx8IGZhbHNlOwoKICAgICAgICB2YXIgc2VsZjsKCiAgICAgICAgaWYgKHRoaXMuX3BhcmVudCkKICAgICAgICB7CiAgICAgICAgICAgIHNlbGYgPSB0aGlzLl9tYW5hZ2VyLmNyZWF0ZSh0aGlzLl9vYmplY3QpOwogICAgICAgICAgICB0aGlzLl9sYXN0Q2hpbGQuY2hhaW4oc2VsZik7CiAgICAgICAgICAgIHRoaXMuX2xhc3RDaGlsZCA9IHNlbGY7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHNlbGYgPSB0aGlzOwogICAgICAgICAgICB0aGlzLl9wYXJlbnQgPSB0aGlzOwogICAgICAgICAgICB0aGlzLl9sYXN0Q2hpbGQgPSB0aGlzOwogICAgICAgIH0KCiAgICAgICAgc2VsZi5fcmVwZWF0ID0gcmVwZWF0OwogICAgICAgIHNlbGYuX2R1cmF0aW9uID0gZHVyYXRpb247CiAgICAgICAgc2VsZi5fdmFsdWVzRW5kID0gcHJvcGVydGllczsKCiAgICAgICAgaWYgKGVhc2UgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICBzZWxmLl9lYXNpbmdGdW5jdGlvbiA9IGVhc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoZGVsYXkgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgc2VsZi5fZGVsYXlUaW1lID0gZGVsYXk7CiAgICAgICAgfQoKICAgICAgICBzZWxmLl95b3lvID0geW95bzsKCiAgICAgICAgaWYgKGF1dG9TdGFydCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0YXJ0KCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTdGFydHMgdGhlIHR3ZWVuIHJ1bm5pbmcuIENhbiBhbHNvIGJlIGNhbGxlZCBieSB0aGUgYXV0b1N0YXJ0IHBhcmFtZXRlciBvZiBUd2Vlbi50by4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW4jc3RhcnQKICAgICogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZSA9PT0gbnVsbCB8fCB0aGlzLl9vYmplY3QgPT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9tYW5hZ2VyLmFkZCh0aGlzKTsKCiAgICAgICAgdGhpcy5pc1J1bm5pbmcgPSB0cnVlOwoKICAgICAgICB0aGlzLl9vblN0YXJ0Q2FsbGJhY2tGaXJlZCA9IGZhbHNlOwoKICAgICAgICB0aGlzLl9zdGFydFRpbWUgPSB0aGlzLmdhbWUudGltZS5ub3cgKyB0aGlzLl9kZWxheVRpbWU7CgogICAgICAgIGZvciAodmFyIHByb3BlcnR5IGluIHRoaXMuX3ZhbHVlc0VuZCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIGNoZWNrIGlmIGFuIEFycmF5IHdhcyBwcm92aWRlZCBhcyBwcm9wZXJ0eSB2YWx1ZQogICAgICAgICAgICBpZiAodGhpcy5fdmFsdWVzRW5kW3Byb3BlcnR5XSBpbnN0YW5jZW9mIEFycmF5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fdmFsdWVzRW5kW3Byb3BlcnR5XS5sZW5ndGggPT09IDApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gY3JlYXRlIGEgbG9jYWwgY29weSBvZiB0aGUgQXJyYXkgd2l0aCB0aGUgc3RhcnQgdmFsdWUgYXQgdGhlIGZyb250CiAgICAgICAgICAgICAgICB0aGlzLl92YWx1ZXNFbmRbcHJvcGVydHldID0gW3RoaXMuX29iamVjdFtwcm9wZXJ0eV1dLmNvbmNhdCh0aGlzLl92YWx1ZXNFbmRbcHJvcGVydHldKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdmFsdWVzU3RhcnRbcHJvcGVydHldID0gdGhpcy5fb2JqZWN0W3Byb3BlcnR5XTsKCiAgICAgICAgICAgIGlmICgodGhpcy5fdmFsdWVzU3RhcnRbcHJvcGVydHldIGluc3RhbmNlb2YgQXJyYXkpID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fdmFsdWVzU3RhcnRbcHJvcGVydHldICo9IDEuMDsgLy8gRW5zdXJlcyB3ZSdyZSB1c2luZyBudW1iZXJzLCBub3Qgc3RyaW5ncwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl92YWx1ZXNTdGFydFJlcGVhdFtwcm9wZXJ0eV0gPSB0aGlzLl92YWx1ZXNTdGFydFtwcm9wZXJ0eV0gfHwgMDsKCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wcyB0aGUgdHdlZW4gaWYgcnVubmluZyBhbmQgcmVtb3ZlcyBpdCBmcm9tIHRoZSBUd2Vlbk1hbmFnZXIuIElmIHRoZXJlIGFyZSBhbnkgb25Db21wbGV0ZSBjYWxsYmFja3Mgb3IgZXZlbnRzIHRoZXkgYXJlIG5vdCBkaXNwYXRjaGVkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNzdG9wCiAgICAqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5pc1J1bm5pbmcgPSBmYWxzZTsKCiAgICAgICAgdGhpcy5fb25VcGRhdGVDYWxsYmFjayA9IG51bGw7CgogICAgICAgIHRoaXMuX21hbmFnZXIucmVtb3ZlKHRoaXMpOwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIGEgZGVsYXkgdGltZSBiZWZvcmUgdGhpcyB0d2VlbiB3aWxsIHN0YXJ0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNkZWxheQogICAgKiBAcGFyYW0ge251bWJlcn0gYW1vdW50IC0gVGhlIGFtb3VudCBvZiB0aGUgZGVsYXkgaW4gbXMuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgogICAgKi8KICAgIGRlbGF5OiBmdW5jdGlvbiAoYW1vdW50KSB7CgogICAgICAgIHRoaXMuX2RlbGF5VGltZSA9IGFtb3VudDsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBudW1iZXIgb2YgdGltZXMgdGhpcyB0d2VlbiB3aWxsIHJlcGVhdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW4jcmVwZWF0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lcyAtIEhvdyBtYW55IHRpbWVzIHRvIHJlcGVhdC4KICAgICogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCiAgICAqLwogICAgcmVwZWF0OiBmdW5jdGlvbiAodGltZXMpIHsKCiAgICAgICAgdGhpcy5fcmVwZWF0ID0gdGltZXM7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQSB0d2VlbiB0aGF0IGhhcyB5b3lvIHNldCB0byB0cnVlIHdpbGwgcnVuIHRocm91Z2ggZnJvbSBzdGFydCB0byBmaW5pc2gsIHRoZW4gcmV2ZXJzZSBmcm9tIGZpbmlzaCB0byBzdGFydC4KICAgICogVXNlZCBpbiBjb21iaW5hdGlvbiB3aXRoIHJlcGVhdCB5b3UgY2FuIGNyZWF0ZSBlbmRsZXNzIGxvb3BzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiN5b3lvCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0geW95byAtIFNldCB0byB0cnVlIHRvIHlveW8gdGhpcyB0d2Vlbi4KICAgICogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCiAgICAqLwogICAgeW95bzogZnVuY3Rpb24oeW95bykgewoKICAgICAgICB0aGlzLl95b3lvID0geW95bzsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXQgZWFzaW5nIGZ1bmN0aW9uIHRoaXMgdHdlZW4gd2lsbCB1c2UsIGkuZS4gUGhhc2VyLkVhc2luZy5MaW5lYXIuTm9uZS4gCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI2Vhc2luZwogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBlYXNpbmcgLSBUaGUgZWFzaW5nIGZ1bmN0aW9uIHRoaXMgdHdlZW4gd2lsbCB1c2UsIGkuZS4gUGhhc2VyLkVhc2luZy5MaW5lYXIuTm9uZS4KICAgICogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCiAgICAqLwogICAgZWFzaW5nOiBmdW5jdGlvbiAoZWFzaW5nKSB7CgogICAgICAgIHRoaXMuX2Vhc2luZ0Z1bmN0aW9uID0gZWFzaW5nOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldCBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uIHRoZSB0d2VlbiB3aWxsIHVzZSwgYnkgZGVmYXVsdCBpdCB1c2VzIFBoYXNlci5NYXRoLmxpbmVhckludGVycG9sYXRpb24uCiAgICAqIEFsc28gYXZhaWxhYmxlOiBQaGFzZXIuTWF0aC5iZXppZXJJbnRlcnBvbGF0aW9uIGFuZCBQaGFzZXIuTWF0aC5jYXRtdWxsUm9tSW50ZXJwb2xhdGlvbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW4jaW50ZXJwb2xhdGlvbgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBpbnRlcnBvbGF0aW9uIC0gVGhlIGludGVycG9sYXRpb24gZnVuY3Rpb24gdG8gdXNlIChQaGFzZXIuTWF0aC5saW5lYXJJbnRlcnBvbGF0aW9uIGJ5IGRlZmF1bHQpCiAgICAqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgogICAgKi8KICAgIGludGVycG9sYXRpb246IGZ1bmN0aW9uIChpbnRlcnBvbGF0aW9uKSB7CgogICAgICAgIHRoaXMuX2ludGVycG9sYXRpb25GdW5jdGlvbiA9IGludGVycG9sYXRpb247CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogWW91IGNhbiBjaGFpbiB0d2VlbnMgdG9nZXRoZXIgYnkgcGFzc2luZyBhIHJlZmVyZW5jZSB0byB0aGUgY2hhaW4gZnVuY3Rpb24uIFRoaXMgZW5hYmxlcyBvbmUgdHdlZW4gdG8gY2FsbCBhbm90aGVyIG9uIGNvbXBsZXRpb24uCiAgICAqIFlvdSBjYW4gcGFzcyBhcyBtYW55IHR3ZWVucyBhcyB5b3UgbGlrZSB0byB0aGlzIGZ1bmN0aW9uLCB0aGV5IHdpbGwgZWFjaCBiZSBjaGFpbmVkIGluIHNlcXVlbmNlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNjaGFpbgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KICAgICovCiAgICBjaGFpbjogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9jaGFpbmVkVHdlZW5zID0gYXJndW1lbnRzOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIExvb3AgYSBjaGFpbiBvZiB0d2VlbnMKICAgICogCiAgICAqIFVzYWdlOgogICAgKiBnYW1lLmFkZC50d2VlbihwKS50byh7IHg6IDcwMCB9LCAxMDAwLCBQaGFzZXIuRWFzaW5nLkxpbmVhci5Ob25lLCB0cnVlKQogICAgKiAudG8oeyB5OiAzMDAgfSwgMTAwMCwgUGhhc2VyLkVhc2luZy5MaW5lYXIuTm9uZSkKICAgICogLnRvKHsgeDogMCB9LCAxMDAwLCBQaGFzZXIuRWFzaW5nLkxpbmVhci5Ob25lKQogICAgKiAudG8oeyB5OiAwIH0sIDEwMDAsIFBoYXNlci5FYXNpbmcuTGluZWFyLk5vbmUpCiAgICAqIC5sb29wKCk7CiAgICAqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI2xvb3AKICAgICogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCiAgICAqLwogICAgbG9vcDogZnVuY3Rpb24oKSB7CgogICAgICAgIHRoaXMuX2xhc3RDaGlsZC5jaGFpbih0aGlzKTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIGEgY2FsbGJhY2sgdG8gYmUgZmlyZWQgZWFjaCB0aW1lIHRoaXMgdHdlZW4gdXBkYXRlcy4gTm90ZTogY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaW4gdGhlIGNvbnRleHQgb2YgdGhlIGdsb2JhbCBzY29wZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW4jb25VcGRhdGVDYWxsYmFjawogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBjYWxsYmFjayB0byBpbnZva2UgZWFjaCB0aW1lIHRoaXMgdHdlZW4gaXMgdXBkYXRlZC4KICAgICogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCiAgICAqLwogICAgb25VcGRhdGVDYWxsYmFjazogZnVuY3Rpb24gKGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCiAgICAgICAgdGhpcy5fb25VcGRhdGVDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgIHRoaXMuX29uVXBkYXRlQ2FsbGJhY2tDb250ZXh0ID0gY2FsbGJhY2tDb250ZXh0OwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXVzZXMgdGhlIHR3ZWVuLiAKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW4jcGF1c2UKICAgICovCiAgICBwYXVzZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9wYXVzZWQgPSB0cnVlOwogICAgICAgIHRoaXMuX3BhdXNlZFRpbWUgPSB0aGlzLmdhbWUudGltZS5ub3c7CgogICAgfSwKCiAgICAvKioKICAgICogUmVzdW1lcyBhIHBhdXNlZCB0d2Vlbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW4jcmVzdW1lCiAgICAqLwogICAgcmVzdW1lOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuX3BhdXNlZCA9IGZhbHNlOwogICAgICAgIHRoaXMuX3N0YXJ0VGltZSArPSAodGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fcGF1c2VkVGltZSk7CgogICAgfSwKCiAgICAvKioKICAgICogQ29yZSB0d2VlbiB1cGRhdGUgZnVuY3Rpb24gY2FsbGVkIGJ5IHRoZSBUd2Vlbk1hbmFnZXIuIERvZXMgbm90IG5lZWQgdG8gYmUgaW52b2tlZCBkaXJlY3RseS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVHdlZW4jdXBkYXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lIC0gQSB0aW1lc3RhbXAgcGFzc2VkIGluIGJ5IHRoZSBUd2Vlbk1hbmFnZXIuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IGZhbHNlIGlmIHRoZSB0d2VlbiBoYXMgY29tcGxldGVkIGFuZCBzaG91bGQgYmUgZGVsZXRlZCBmcm9tIHRoZSBtYW5hZ2VyLCBvdGhlcndpc2UgdHJ1ZSAoc3RpbGwgYWN0aXZlKS4KICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICh0aW1lKSB7CgogICAgICAgIGlmICh0aGlzLnBlbmRpbmdEZWxldGUpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fcGF1c2VkIHx8IHRpbWUgPCB0aGlzLl9zdGFydFRpbWUpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHZhciBwcm9wZXJ0eTsKCiAgICAgICAgaWYgKHRpbWUgPCB0aGlzLl9zdGFydFRpbWUpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9vblN0YXJ0Q2FsbGJhY2tGaXJlZCA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uU3RhcnQuZGlzcGF0Y2godGhpcy5fb2JqZWN0KTsKICAgICAgICAgICAgdGhpcy5fb25TdGFydENhbGxiYWNrRmlyZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgdmFyIGVsYXBzZWQgPSAodGltZSAtIHRoaXMuX3N0YXJ0VGltZSkgLyB0aGlzLl9kdXJhdGlvbjsKICAgICAgICBlbGFwc2VkID0gZWxhcHNlZCA+IDEgPyAxIDogZWxhcHNlZDsKCiAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5fZWFzaW5nRnVuY3Rpb24oZWxhcHNlZCk7CgogICAgICAgIGZvciAocHJvcGVydHkgaW4gdGhpcy5fdmFsdWVzRW5kKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fdmFsdWVzU3RhcnRbcHJvcGVydHldIHx8IDA7CiAgICAgICAgICAgIHZhciBlbmQgPSB0aGlzLl92YWx1ZXNFbmRbcHJvcGVydHldOwoKICAgICAgICAgICAgaWYgKGVuZCBpbnN0YW5jZW9mIEFycmF5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9vYmplY3RbcHJvcGVydHldID0gdGhpcy5faW50ZXJwb2xhdGlvbkZ1bmN0aW9uKGVuZCwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gUGFyc2VzIHJlbGF0aXZlIGVuZCB2YWx1ZXMgd2l0aCBzdGFydCBhcyBiYXNlIChlLmcuOiArMTAsIC0zKQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZihlbmQpID09PSAnc3RyaW5nJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlbmQgPSBzdGFydCArIHBhcnNlRmxvYXQoZW5kLCAxMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gcHJvdGVjdCBhZ2FpbnN0IG5vbiBudW1lcmljIHByb3BlcnRpZXMuCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mKGVuZCkgPT09ICdudW1iZXInKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX29iamVjdFtwcm9wZXJ0eV0gPSBzdGFydCArICggZW5kIC0gc3RhcnQgKSAqIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fb25VcGRhdGVDYWxsYmFjayAhPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uVXBkYXRlQ2FsbGJhY2suY2FsbCh0aGlzLl9vblVwZGF0ZUNhbGxiYWNrQ29udGV4dCwgdGhpcywgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGVsYXBzZWQgPT0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9yZXBlYXQgPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaXNGaW5pdGUodGhpcy5fcmVwZWF0KSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXBlYXQtLTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyByZWFzc2lnbiBzdGFydGluZyB2YWx1ZXMsIHJlc3RhcnQgYnkgbWFraW5nIHN0YXJ0VGltZSA9IG5vdwogICAgICAgICAgICAgICAgZm9yIChwcm9wZXJ0eSBpbiB0aGlzLl92YWx1ZXNTdGFydFJlcGVhdCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mKHRoaXMuX3ZhbHVlc0VuZFtwcm9wZXJ0eV0pID09PSAnc3RyaW5nJykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3ZhbHVlc1N0YXJ0UmVwZWF0W3Byb3BlcnR5XSA9IHRoaXMuX3ZhbHVlc1N0YXJ0UmVwZWF0W3Byb3BlcnR5XSArIHBhcnNlRmxvYXQodGhpcy5fdmFsdWVzRW5kW3Byb3BlcnR5XSwgMTApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3lveW8pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wID0gdGhpcy5fdmFsdWVzU3RhcnRSZXBlYXRbcHJvcGVydHldOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl92YWx1ZXNTdGFydFJlcGVhdFtwcm9wZXJ0eV0gPSB0aGlzLl92YWx1ZXNFbmRbcHJvcGVydHldOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl92YWx1ZXNFbmRbcHJvcGVydHldID0gdG1wOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXZlcnNlZCA9ICF0aGlzLl9yZXZlcnNlZDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRoaXMuX3ZhbHVlc1N0YXJ0W3Byb3BlcnR5XSA9IHRoaXMuX3ZhbHVlc1N0YXJ0UmVwZWF0W3Byb3BlcnR5XTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLl9zdGFydFRpbWUgPSB0aW1lICsgdGhpcy5fZGVsYXlUaW1lOwoKICAgICAgICAgICAgICAgIHRoaXMub25Mb29wLmRpc3BhdGNoKHRoaXMuX29iamVjdCk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5pc1J1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMub25Db21wbGV0ZS5kaXNwYXRjaCh0aGlzLl9vYmplY3QpOwoKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBudW1DaGFpbmVkVHdlZW5zID0gdGhpcy5fY2hhaW5lZFR3ZWVucy5sZW5ndGg7IGkgPCBudW1DaGFpbmVkVHdlZW5zOyBpICsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYWluZWRUd2VlbnNbaV0uc3RhcnQodGltZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgfQogICAgCn07CgpQaGFzZXIuVHdlZW4ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlR3ZWVuOwoKLyoganNoaW50IGN1cmx5OiBmYWxzZSAqLwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQSBjb2xsZWN0aW9uIG9mIGVhc2luZyBtZXRob2RzIGRlZmluaW5nIGVhc2UtaW4gZWFzZS1vdXQgY3VydmVzLgoqCiogQGNsYXNzIFBoYXNlci5FYXNpbmcKKi8KUGhhc2VyLkVhc2luZyA9IHsKCiAgICAvKioKICAgICogTGluZWFyIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuTGluZWFyCiAgICAqLwogICAgTGluZWFyOiB7CgogICAgICAgIC8qKgogICAgICAgICogRWFzZS1pbi4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuTGluZWFyI0luIAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4KICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IGteMi4KICAgICAgICAqLwogICAgICAgIE5vbmU6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHJldHVybiBrOwoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUXVhZHJhdGljIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuUXVhZHJhdGljCiAgICAqLwogICAgUXVhZHJhdGljOiB7CgogICAgICAgIC8qKgogICAgICAgICogRWFzZS1pbi4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuUXVhZHJhdGljI0luIAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBrXjIuCiAgICAgICAgKi8KICAgICAgICBJbjogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgcmV0dXJuIGsgKiBrOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIEVhc2Utb3V0LgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5RdWFkcmF0aWMjT3V0IAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBrKiAoMi1rKS4KICAgICAgICAqLwogICAgICAgIE91dDogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgcmV0dXJuIGsgKiAoIDIgLSBrICk7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICogRWFzZS1pbi9vdXQuCiAgICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlF1YWRyYXRpYyNJbk91dAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwogICAgICAgIEluT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICBpZiAoICggayAqPSAyICkgPCAxICkgcmV0dXJuIDAuNSAqIGsgKiBrOwogICAgICAgICAgICByZXR1cm4gLSAwLjUgKiAoIC0tayAqICggayAtIDIgKSAtIDEgKTsKCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEN1YmljIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuQ3ViaWMKICAgICovCiAgICBDdWJpYzogewoKICAgICAgICAvKioKICAgICAgICAqIEN1YmljIGVhc2UtaW4uCiAgICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkN1YmljI0luIAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwogICAgICAgIEluOiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gayAqIGsgKiBrOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIEN1YmljIGVhc2Utb3V0LgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5DdWJpYyNPdXQKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KICAgICAgICBPdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHJldHVybiAtLWsgKiBrICogayArIDE7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICogQ3ViaWMgZWFzZS1pbi9vdXQuCiAgICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkN1YmljI0luT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCiAgICAgICAgSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIGlmICggKCBrICo9IDIgKSA8IDEgKSByZXR1cm4gMC41ICogayAqIGsgKiBrOwogICAgICAgICAgICByZXR1cm4gMC41ICogKCAoIGsgLT0gMiApICogayAqIGsgKyAyICk7CgogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBRdWFydGljIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuUXVhcnRpYwogICAgKi8KICAgIFF1YXJ0aWM6IHsKCiAgICAgICAgLyoqCiAgICAgICAgKiBRdWFydGljIGVhc2UtaW4uCiAgICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlF1YXJ0aWMjSW4gCiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCiAgICAgICAgSW46IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHJldHVybiBrICogayAqIGsgKiBrOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIFF1YXJ0aWMgZWFzZS1vdXQuCiAgICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlF1YXJ0aWMjT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCiAgICAgICAgT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gMSAtICggLS1rICogayAqIGsgKiBrICk7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICogUXVhcnRpYyBlYXNlLWluL291dC4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuUXVhcnRpYyNJbk91dAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwogICAgICAgIEluT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICBpZiAoICggayAqPSAyICkgPCAxKSByZXR1cm4gMC41ICogayAqIGsgKiBrICogazsKICAgICAgICAgICAgcmV0dXJuIC0gMC41ICogKCAoIGsgLT0gMiApICogayAqIGsgKiBrIC0gMiApOwoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUXVpbnRpYyBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLlF1aW50aWMKICAgICovCiAgICBRdWludGljOiB7CgogICAgICAgIC8qKgogICAgICAgICogUXVpbnRpYyBlYXNlLWluLgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5RdWludGljI0luIAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwogICAgICAgIEluOiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gayAqIGsgKiBrICogayAqIGs7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICogUXVpbnRpYyBlYXNlLW91dC4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuUXVpbnRpYyNPdXQKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KICAgICAgICBPdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHJldHVybiAtLWsgKiBrICogayAqIGsgKiBrICsgMTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBRdWludGljIGVhc2UtaW4vb3V0LgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5RdWludGljI0luT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCiAgICAgICAgSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIGlmICggKCBrICo9IDIgKSA8IDEgKSByZXR1cm4gMC41ICogayAqIGsgKiBrICogayAqIGs7CiAgICAgICAgICAgIHJldHVybiAwLjUgKiAoICggayAtPSAyICkgKiBrICogayAqIGsgKiBrICsgMiApOwoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU2ludXNvaWRhbCBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLlNpbnVzb2lkYWwKICAgICovCiAgICBTaW51c29pZGFsOiB7CgogICAgICAgIC8qKgogICAgICAgICogU2ludXNvaWRhbCBlYXNlLWluLgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5TaW51c29pZGFsI0luIAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwogICAgICAgIEluOiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gMSAtIE1hdGguY29zKCBrICogTWF0aC5QSSAvIDIgKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBTaW51c29pZGFsIGVhc2Utb3V0LgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5TaW51c29pZGFsI091dAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwogICAgICAgIE91dDogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgcmV0dXJuIE1hdGguc2luKCBrICogTWF0aC5QSSAvIDIgKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBTaW51c29pZGFsIGVhc2UtaW4vb3V0LgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5TaW51c29pZGFsI0luT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCiAgICAgICAgSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHJldHVybiAwLjUgKiAoIDEgLSBNYXRoLmNvcyggTWF0aC5QSSAqIGsgKSApOwoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogRXhwb25lbnRpYWwgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5FeHBvbmVudGlhbAogICAgKi8KICAgIEV4cG9uZW50aWFsOiB7CgogICAgICAgIC8qKgogICAgICAgICogRXhwb25lbnRpYWwgZWFzZS1pbi4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuRXhwb25lbnRpYWwjSW4gCiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCiAgICAgICAgSW46IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHJldHVybiBrID09PSAwID8gMCA6IE1hdGgucG93KCAxMDI0LCBrIC0gMSApOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIEV4cG9uZW50aWFsIGVhc2Utb3V0LgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5FeHBvbmVudGlhbCNPdXQKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KICAgICAgICBPdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHJldHVybiBrID09PSAxID8gMSA6IDEgLSBNYXRoLnBvdyggMiwgLSAxMCAqIGsgKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBFeHBvbmVudGlhbCBlYXNlLWluL291dC4KICAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuRXhwb25lbnRpYWwjSW5PdXQKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KICAgICAgICBJbk91dDogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgaWYgKCBrID09PSAwICkgcmV0dXJuIDA7CiAgICAgICAgICAgIGlmICggayA9PT0gMSApIHJldHVybiAxOwogICAgICAgICAgICBpZiAoICggayAqPSAyICkgPCAxICkgcmV0dXJuIDAuNSAqIE1hdGgucG93KCAxMDI0LCBrIC0gMSApOwogICAgICAgICAgICByZXR1cm4gMC41ICogKCAtIE1hdGgucG93KCAyLCAtIDEwICogKCBrIC0gMSApICkgKyAyICk7CgogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaXJjdWxhciBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLkNpcmN1bGFyCiAgICAqLwogICAgQ2lyY3VsYXI6IHsKCiAgICAgICAgLyoqCiAgICAgICAgKiBDaXJjdWxhciBlYXNlLWluLgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5DaXJjdWxhciNJbiAKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KICAgICAgICBJbjogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgcmV0dXJuIDEgLSBNYXRoLnNxcnQoIDEgLSBrICogayApOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIENpcmN1bGFyIGVhc2Utb3V0LgogICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5DaXJjdWxhciNPdXQKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KICAgICAgICBPdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHJldHVybiBNYXRoLnNxcnQoIDEgLSAoIC0tayAqIGsgKSApOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIENpcmN1bGFyIGVhc2UtaW4vb3V0LgogICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkNpcmN1bGFyI0luT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgKi8KICAgICAgICBJbk91dDogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgaWYgKCAoIGsgKj0gMiApIDwgMSkgcmV0dXJuIC0gMC41ICogKCBNYXRoLnNxcnQoIDEgLSBrICogaykgLSAxKTsKICAgICAgICAgICAgcmV0dXJuIDAuNSAqICggTWF0aC5zcXJ0KCAxIC0gKCBrIC09IDIpICogaykgKyAxKTsKCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEVsYXN0aWMgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5FbGFzdGljCiAgICAqLwogICAgRWxhc3RpYzogewoKICAgICAgICAvKioKICAgICAgICAqIEVsYXN0aWMgZWFzZS1pbi4KICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5FbGFzdGljI0luIAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICovCiAgICAgICAgSW46IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHZhciBzLCBhID0gMC4xLCBwID0gMC40OwogICAgICAgICAgICBpZiAoIGsgPT09IDAgKSByZXR1cm4gMDsKICAgICAgICAgICAgaWYgKCBrID09PSAxICkgcmV0dXJuIDE7CiAgICAgICAgICAgIGlmICggIWEgfHwgYSA8IDEgKSB7IGEgPSAxOyBzID0gcCAvIDQ7IH0KICAgICAgICAgICAgZWxzZSBzID0gcCAqIE1hdGguYXNpbiggMSAvIGEgKSAvICggMiAqIE1hdGguUEkgKTsKICAgICAgICAgICAgcmV0dXJuIC0gKCBhICogTWF0aC5wb3coIDIsIDEwICogKCBrIC09IDEgKSApICogTWF0aC5zaW4oICggayAtIHMgKSAqICggMiAqIE1hdGguUEkgKSAvIHAgKSApOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIEVsYXN0aWMgZWFzZS1vdXQuCiAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuRWxhc3RpYyNPdXQKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAqLwogICAgICAgIE91dDogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgdmFyIHMsIGEgPSAwLjEsIHAgPSAwLjQ7CiAgICAgICAgICAgIGlmICggayA9PT0gMCApIHJldHVybiAwOwogICAgICAgICAgICBpZiAoIGsgPT09IDEgKSByZXR1cm4gMTsKICAgICAgICAgICAgaWYgKCAhYSB8fCBhIDwgMSApIHsgYSA9IDE7IHMgPSBwIC8gNDsgfQogICAgICAgICAgICBlbHNlIHMgPSBwICogTWF0aC5hc2luKCAxIC8gYSApIC8gKCAyICogTWF0aC5QSSApOwogICAgICAgICAgICByZXR1cm4gKCBhICogTWF0aC5wb3coIDIsIC0gMTAgKiBrKSAqIE1hdGguc2luKCAoIGsgLSBzICkgKiAoIDIgKiBNYXRoLlBJICkgLyBwICkgKyAxICk7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICogRWxhc3RpYyBlYXNlLWluL291dC4KICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5FbGFzdGljI0luT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgKi8KICAgICAgICBJbk91dDogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgdmFyIHMsIGEgPSAwLjEsIHAgPSAwLjQ7CiAgICAgICAgICAgIGlmICggayA9PT0gMCApIHJldHVybiAwOwogICAgICAgICAgICBpZiAoIGsgPT09IDEgKSByZXR1cm4gMTsKICAgICAgICAgICAgaWYgKCAhYSB8fCBhIDwgMSApIHsgYSA9IDE7IHMgPSBwIC8gNDsgfQogICAgICAgICAgICBlbHNlIHMgPSBwICogTWF0aC5hc2luKCAxIC8gYSApIC8gKCAyICogTWF0aC5QSSApOwogICAgICAgICAgICBpZiAoICggayAqPSAyICkgPCAxICkgcmV0dXJuIC0gMC41ICogKCBhICogTWF0aC5wb3coIDIsIDEwICogKCBrIC09IDEgKSApICogTWF0aC5zaW4oICggayAtIHMgKSAqICggMiAqIE1hdGguUEkgKSAvIHAgKSApOwogICAgICAgICAgICByZXR1cm4gYSAqIE1hdGgucG93KCAyLCAtMTAgKiAoIGsgLT0gMSApICkgKiBNYXRoLnNpbiggKCBrIC0gcyApICogKCAyICogTWF0aC5QSSApIC8gcCApICogMC41ICsgMTsKCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEJhY2sgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5CYWNrCiAgICAqLwogICAgQmFjazogewoKICAgICAgICAvKioKICAgICAgICAqIEJhY2sgZWFzZS1pbi4KICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5CYWNrI0luIAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICovCiAgICAgICAgSW46IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIHZhciBzID0gMS43MDE1ODsKICAgICAgICAgICAgcmV0dXJuIGsgKiBrICogKCAoIHMgKyAxICkgKiBrIC0gcyApOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAqIEJhY2sgZWFzZS1vdXQuCiAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQmFjayNPdXQKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAqLwogICAgICAgIE91dDogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgdmFyIHMgPSAxLjcwMTU4OwogICAgICAgICAgICByZXR1cm4gLS1rICogayAqICggKCBzICsgMSApICogayArIHMgKSArIDE7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICogQmFjayBlYXNlLWluL291dC4KICAgICAgICoKICAgICAgICAqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5CYWNrI0luT3V0CiAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKICAgICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgKi8KICAgICAgICBJbk91dDogZnVuY3Rpb24gKCBrICkgewoKICAgICAgICAgICAgdmFyIHMgPSAxLjcwMTU4ICogMS41MjU7CiAgICAgICAgICAgIGlmICggKCBrICo9IDIgKSA8IDEgKSByZXR1cm4gMC41ICogKCBrICogayAqICggKCBzICsgMSApICogayAtIHMgKSApOwogICAgICAgICAgICByZXR1cm4gMC41ICogKCAoIGsgLT0gMiApICogayAqICggKCBzICsgMSApICogayArIHMgKSArIDIgKTsKCiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEJvdW5jZSBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLkJvdW5jZQogICAgKi8KICAgIEJvdW5jZTogewoKICAgICAgICAvKioKICAgICAgICAqIEJvdW5jZSBlYXNlLWluLgogICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkJvdW5jZSNJbiAKICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAogICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAqLwogICAgICAgIEluOiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICByZXR1cm4gMSAtIFBoYXNlci5FYXNpbmcuQm91bmNlLk91dCggMSAtIGsgKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgKiBCb3VuY2UgZWFzZS1vdXQuCiAgICAgICAqCiAgICAgICAgKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQm91bmNlI091dAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICovCiAgICAgICAgT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgogICAgICAgICAgICBpZiAoIGsgPCAoIDEgLyAyLjc1ICkgKSB7CgogICAgICAgICAgICAgICAgcmV0dXJuIDcuNTYyNSAqIGsgKiBrOwoKICAgICAgICAgICAgfSBlbHNlIGlmICggayA8ICggMiAvIDIuNzUgKSApIHsKCiAgICAgICAgICAgICAgICByZXR1cm4gNy41NjI1ICogKCBrIC09ICggMS41IC8gMi43NSApICkgKiBrICsgMC43NTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoIGsgPCAoIDIuNSAvIDIuNzUgKSApIHsKCiAgICAgICAgICAgICAgICByZXR1cm4gNy41NjI1ICogKCBrIC09ICggMi4yNSAvIDIuNzUgKSApICogayArIDAuOTM3NTsKCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgcmV0dXJuIDcuNTYyNSAqICggayAtPSAoIDIuNjI1IC8gMi43NSApICkgKiBrICsgMC45ODQzNzU7CgogICAgICAgICAgICB9CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICogQm91bmNlIGVhc2UtaW4vb3V0LgogICAgICAgKgogICAgICAgICogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkJvdW5jZSNJbk91dAogICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCiAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICovCiAgICAgICAgSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCiAgICAgICAgICAgIGlmICggayA8IDAuNSApIHJldHVybiBQaGFzZXIuRWFzaW5nLkJvdW5jZS5JbiggayAqIDIgKSAqIDAuNTsKICAgICAgICAgICAgcmV0dXJuIFBoYXNlci5FYXNpbmcuQm91bmNlLk91dCggayAqIDIgLSAxICkgKiAwLjUgKyAwLjU7CgogICAgICAgIH0KCiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGltZSBjb25zdHJ1Y3Rvci4KKgoqIEBjbGFzcyBQaGFzZXIuVGltZQoqIEBjbGFzc2Rlc2MgVGhpcyBpcyB0aGUgY29yZSBpbnRlcm5hbCBnYW1lIGNsb2NrLiBJdCBtYW5hZ2VzIHRoZSBlbGFwc2VkIHRpbWUgYW5kIGNhbGN1bGF0aW9uIG9mIGVsYXBzZWQgdmFsdWVzLCB1c2VkIGZvciBnYW1lIG9iamVjdCBtb3Rpb24gYW5kIHR3ZWVucy4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuVGltZSA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBMb2NhbCByZWZlcmVuY2UgdG8gZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdGltZSAtIEdhbWUgdGltZSBjb3VudGVyLiBJZiB5b3UgbmVlZCBhIHZhbHVlIGZvciBpbi1nYW1lIGNhbGN1bGF0aW9uIHBsZWFzZSB1c2UgUGhhc2VyLlRpbWUubm93IGluc3RlYWQuCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB0aGlzLnRpbWUgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbm93IC0gVGhlIHRpbWUgcmlnaHQgbm93LgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdGhpcy5ub3cgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZWxhcHNlZCAtIEVsYXBzZWQgdGltZSBzaW5jZSB0aGUgbGFzdCBmcmFtZSAoaW4gbXMpLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdGhpcy5lbGFwc2VkID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBhdXNlZFRpbWUgLSBSZWNvcmRzIGhvdyBsb25nIHRoZSBnYW1lIGhhcyBiZWVuIHBhdXNlZCBmb3IuIElzIHJlc2V0IGVhY2ggdGltZSB0aGUgZ2FtZSBwYXVzZXMuCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB0aGlzLnBhdXNlZFRpbWUgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZnBzIC0gRnJhbWVzIHBlciBzZWNvbmQuCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB0aGlzLmZwcyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcHNNaW4gLSBUaGUgbG93ZXN0IHJhdGUgdGhlIGZwcyBoYXMgZHJvcHBlZCB0by4KICAgICovCiAgICB0aGlzLmZwc01pbiA9IDEwMDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcHNNYXggLSBUaGUgaGlnaGVzdCByYXRlIHRoZSBmcHMgaGFzIHJlYWNoZWQgKHVzdWFsbHkgbm8gaGlnaGVyIHRoYW4gNjBmcHMpLgogICAgKi8KICAgIHRoaXMuZnBzTWF4ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1zTWluIC0gVGhlIG1pbmltdW0gYW1vdW50IG9mIHRpbWUgdGhlIGdhbWUgaGFzIHRha2VuIGJldHdlZW4gdHdvIGZyYW1lcy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1zTWluID0gMTAwMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1zTWF4IC0gVGhlIG1heGltdW0gYW1vdW50IG9mIHRpbWUgdGhlIGdhbWUgaGFzIHRha2VuIGJldHdlZW4gdHdvIGZyYW1lcy4KICAgICovCiAgICB0aGlzLm1zTWF4ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBoeXNpY3NFbGFwc2VkIC0gVGhlIGVsYXBzZWQgdGltZSBjYWxjdWxhdGVkIGZvciB0aGUgcGh5c2ljcyBtb3Rpb24gdXBkYXRlcy4KICAgICovCiAgICB0aGlzLnBoeXNpY3NFbGFwc2VkID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGZyYW1lcyAtIFRoZSBudW1iZXIgb2YgZnJhbWVzIHJlY29yZCBpbiB0aGUgbGFzdCBzZWNvbmQuCiAgICAqLwogICAgdGhpcy5mcmFtZXMgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGF1c2VEdXJhdGlvbiAtIFJlY29yZHMgaG93IGxvbmcgdGhlIGdhbWUgd2FzIHBhdXNlZCBmb3IgaW4gbWlsaXNlY29uZHMuCiAgICAqLwogICAgdGhpcy5wYXVzZUR1cmF0aW9uID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVUb0NhbGwgLSBUaGUgdmFsdWUgdGhhdCBzZXRUaW1lb3V0IG5lZWRzIHRvIHdvcmsgb3V0IHdoZW4gdG8gbmV4dCB1cGRhdGUKICAgICovCiAgICB0aGlzLnRpbWVUb0NhbGwgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbGFzdFRpbWUgLSBJbnRlcm5hbCB2YWx1ZSB1c2VkIGJ5IHRpbWVUb0NhbGwgYXMgcGFydCBvZiB0aGUgc2V0VGltZW91dCBsb29wCiAgICAqLwogICAgdGhpcy5sYXN0VGltZSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlRpbWVyfSBldmVudHMgLSBUaGlzIGlzIGEgUGhhc2VyLlRpbWVyIG9iamVjdCBib3VuZCB0byB0aGUgbWFzdGVyIGNsb2NrIHRvIHdoaWNoIHlvdSBjYW4gYWRkIHRpbWVkIGV2ZW50cy4KICAgICovCiAgICB0aGlzLmV2ZW50cyA9IG5ldyBQaGFzZXIuVGltZXIodGhpcy5nYW1lLCBmYWxzZSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfc3RhcnRlZCAtIFRoZSB0aW1lIGF0IHdoaWNoIHRoZSBHYW1lIGluc3RhbmNlIHN0YXJ0ZWQuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fc3RhcnRlZCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdGltZUxhc3RTZWNvbmQgLSBUaGUgdGltZSAoaW4gbXMpIHRoYXQgdGhlIGxhc3Qgc2Vjb25kIGNvdW50ZXIgdGlja2VkIG92ZXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdGltZUxhc3RTZWNvbmQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3BhdXNlU3RhcnRlZCAtIFRoZSB0aW1lIHRoZSBnYW1lIHN0YXJ0ZWQgYmVpbmcgcGF1c2VkLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3BhdXNlU3RhcnRlZCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX2p1c3RSZXN1bWVkIC0gSW50ZXJuYWwgdmFsdWUgdXNlZCB0byByZWNvdmVyIGZyb20gdGhlIGdhbWUgcGF1c2Ugc3RhdGUuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fanVzdFJlc3VtZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gX3RpbWVycyAtIEludGVybmFsIHN0b3JlIG9mIFBoYXNlci5UaW1lciBvYmplY3RzLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3RpbWVycyA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2xlbiAtIFRlbXAuIGFycmF5IGxlbmd0aCB2YXJpYWJsZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9sZW4gPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2kgLSBUZW1wLiBhcnJheSBjb3VudGVyIHZhcmlhYmxlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2kgPSAwOwoKICAgIC8vICBMaXN0ZW4gZm9yIGdhbWUgcGF1c2UvcmVzdW1lIGV2ZW50cwogICAgdGhpcy5nYW1lLm9uUGF1c2UuYWRkKHRoaXMuZ2FtZVBhdXNlZCwgdGhpcyk7CiAgICB0aGlzLmdhbWUub25SZXN1bWUuYWRkKHRoaXMuZ2FtZVJlc3VtZWQsIHRoaXMpOwoKfTsKClBoYXNlci5UaW1lLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuVGltZSNib290CiAgICAqLwogICAgYm9vdDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmV2ZW50cy5zdGFydCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBuZXcgc3RhbmQtYWxvbmUgUGhhc2VyLlRpbWVyIG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZSNjcmVhdGUKICAgICogQHBhcmFtIHtib29sZWFufSBbYXV0b0Rlc3Ryb3k9dHJ1ZV0gLSBBIFRpbWVyIHRoYXQgaXMgc2V0IHRvIGF1dG9tYXRpY2FsbHkgZGVzdHJveSBpdHNlbGYgd2lsbCBkbyBzbyBhZnRlciBhbGwgb2YgaXRzIGV2ZW50cyBoYXZlIGJlZW4gZGlzcGF0Y2hlZCAoYXNzdW1pbmcgbm8gbG9vcGluZyBldmVudHMpLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGltZXJ9IFRoZSBUaW1lciBvYmplY3QgdGhhdCB3YXMgY3JlYXRlZC4KICAgICovCiAgICBjcmVhdGU6IGZ1bmN0aW9uIChhdXRvRGVzdHJveSkgewoKICAgICAgICBpZiAodHlwZW9mIGF1dG9EZXN0cm95ID09PSAndW5kZWZpbmVkJykgeyBhdXRvRGVzdHJveSA9IHRydWU7IH0KCiAgICAgICAgdmFyIHRpbWVyID0gbmV3IFBoYXNlci5UaW1lcih0aGlzLmdhbWUsIGF1dG9EZXN0cm95KTsKCiAgICAgICAgdGhpcy5fdGltZXJzLnB1c2godGltZXIpOwoKICAgICAgICByZXR1cm4gdGltZXI7CgogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlIGFsbCBUaW1lciBvYmplY3RzLCByZWdhcmRsZXNzIG9mIHRoZWlyIHN0YXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lI3JlbW92ZUFsbAogICAgKi8KICAgIHJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3RpbWVycy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3RpbWVyc1tpXS5kZXN0cm95KCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl90aW1lcnMgPSBbXTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGVzIHRoZSBnYW1lIGNsb2NrIGFuZCBjYWxjdWxhdGUgdGhlIGZwcy4gVGhpcyBpcyBjYWxsZWQgYXV0b21hdGljYWxseSBieSBQaGFzZXIuR2FtZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZSN1cGRhdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbWUgLSBUaGUgY3VycmVudCB0aW1lc3RhbXAsIGVpdGhlciBwZXJmb3JtYW5jZS5ub3cgb3IgRGF0ZS5ub3cgZGVwZW5kaW5nIG9uIHRoZSBicm93c2VyLgogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKHRpbWUpIHsKCiAgICAgICAgdGhpcy5ub3cgPSB0aW1lOwoKICAgICAgICBpZiAodGhpcy5fanVzdFJlc3VtZWQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRpbWUgPSB0aGlzLm5vdzsKICAgICAgICAgICAgdGhpcy5fanVzdFJlc3VtZWQgPSBmYWxzZTsKICAgIAogICAgICAgICAgICB0aGlzLmV2ZW50cy5yZXN1bWUoKTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fdGltZXJzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl90aW1lcnNbaV0ucmVzdW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMudGltZVRvQ2FsbCA9IHRoaXMuZ2FtZS5tYXRoLm1heCgwLCAxNiAtICh0aW1lIC0gdGhpcy5sYXN0VGltZSkpOwoKICAgICAgICB0aGlzLmVsYXBzZWQgPSB0aGlzLm5vdyAtIHRoaXMudGltZTsKCiAgICAgICAgdGhpcy5tc01pbiA9IHRoaXMuZ2FtZS5tYXRoLm1pbih0aGlzLm1zTWluLCB0aGlzLmVsYXBzZWQpOwogICAgICAgIHRoaXMubXNNYXggPSB0aGlzLmdhbWUubWF0aC5tYXgodGhpcy5tc01heCwgdGhpcy5lbGFwc2VkKTsKCiAgICAgICAgdGhpcy5mcmFtZXMrKzsKCiAgICAgICAgaWYgKHRoaXMubm93ID4gdGhpcy5fdGltZUxhc3RTZWNvbmQgKyAxMDAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcHMgPSBNYXRoLnJvdW5kKCh0aGlzLmZyYW1lcyAqIDEwMDApIC8gKHRoaXMubm93IC0gdGhpcy5fdGltZUxhc3RTZWNvbmQpKTsKICAgICAgICAgICAgdGhpcy5mcHNNaW4gPSB0aGlzLmdhbWUubWF0aC5taW4odGhpcy5mcHNNaW4sIHRoaXMuZnBzKTsKICAgICAgICAgICAgdGhpcy5mcHNNYXggPSB0aGlzLmdhbWUubWF0aC5tYXgodGhpcy5mcHNNYXgsIHRoaXMuZnBzKTsKICAgICAgICAgICAgdGhpcy5fdGltZUxhc3RTZWNvbmQgPSB0aGlzLm5vdzsKICAgICAgICAgICAgdGhpcy5mcmFtZXMgPSAwOwogICAgICAgIH0KCiAgICAgICAgdGhpcy50aW1lID0gdGhpcy5ub3c7CiAgICAgICAgdGhpcy5sYXN0VGltZSA9IHRpbWUgKyB0aGlzLnRpbWVUb0NhbGw7CiAgICAgICAgdGhpcy5waHlzaWNzRWxhcHNlZCA9IDEuMCAqICh0aGlzLmVsYXBzZWQgLyAxMDAwKTsKCiAgICAgICAgLy8gIENsYW1wIHRoZSBkZWx0YQogICAgICAgIGlmICh0aGlzLnBoeXNpY3NFbGFwc2VkID4gMC4wNSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucGh5c2ljc0VsYXBzZWQgPSAwLjA1OwogICAgICAgIH0KCiAgICAgICAgLy8gIFBhdXNlZD8KICAgICAgICBpZiAodGhpcy5nYW1lLnBhdXNlZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucGF1c2VkVGltZSA9IHRoaXMubm93IC0gdGhpcy5fcGF1c2VTdGFydGVkOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgT3VyIGludGVybmFsIFBoYXNlci5UaW1lcgogICAgICAgICAgICB0aGlzLmV2ZW50cy51cGRhdGUodGhpcy5ub3cpOwoKICAgICAgICAgICAgLy8gIEFueSBnYW1lIGxldmVsIHRpbWVycwogICAgICAgICAgICB0aGlzLl9pID0gMDsKICAgICAgICAgICAgdGhpcy5fbGVuID0gdGhpcy5fdGltZXJzLmxlbmd0aDsKCiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9pIDwgdGhpcy5fbGVuKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fdGltZXJzW3RoaXMuX2ldLnVwZGF0ZSh0aGlzLm5vdykpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faSsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3RpbWVycy5zcGxpY2UodGhpcy5faSwgMSk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuX2xlbi0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCB3aGVuIHRoZSBnYW1lIGVudGVycyBhIHBhdXNlZCBzdGF0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZSNnYW1lUGF1c2VkCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgZ2FtZVBhdXNlZDogZnVuY3Rpb24gKCkgewogICAgICAgIAogICAgICAgIHRoaXMuX3BhdXNlU3RhcnRlZCA9IHRoaXMubm93OwoKICAgICAgICB0aGlzLmV2ZW50cy5wYXVzZSgpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3RpbWVycy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3RpbWVyc1tpXS5wYXVzZSgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgd2hlbiB0aGUgZ2FtZSByZXN1bWVzIGZyb20gYSBwYXVzZWQgc3RhdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWUjZ2FtZVJlc3VtZWQKICAgICogQHByaXZhdGUKICAgICovCiAgICBnYW1lUmVzdW1lZDogZnVuY3Rpb24gKCkgewoKICAgICAgICAvLyAgTGV2ZWwgb3V0IHRoZSBlbGFwc2VkIHRpbWVyIHRvIGF2b2lkIHNwaWtlcwogICAgICAgIHRoaXMudGltZSA9IERhdGUubm93KCk7CiAgICAgICAgdGhpcy5wYXVzZUR1cmF0aW9uID0gdGhpcy5wYXVzZWRUaW1lOwogICAgICAgIHRoaXMuX2p1c3RSZXN1bWVkID0gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgbnVtYmVyIG9mIHNlY29uZHMgdGhhdCBoYXZlIGVsYXBzZWQgc2luY2UgdGhlIGdhbWUgd2FzIHN0YXJ0ZWQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWUjdG90YWxFbGFwc2VkU2Vjb25kcwogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgdG90YWxFbGFwc2VkU2Vjb25kczogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLm5vdyAtIHRoaXMuX3N0YXJ0ZWQpICogMC4wMDE7CiAgICB9LAoKICAgIC8qKgogICAgKiBIb3cgbG9uZyBoYXMgcGFzc2VkIHNpbmNlIHRoZSBnaXZlbiB0aW1lLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lI2VsYXBzZWRTaW5jZQogICAgKiBAcGFyYW0ge251bWJlcn0gc2luY2UgLSBUaGUgdGltZSB5b3Ugd2FudCB0byBtZWFzdXJlIGFnYWluc3QuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpZmZlcmVuY2UgYmV0d2VlbiB0aGUgZ2l2ZW4gdGltZSBhbmQgbm93LgogICAgKi8KICAgIGVsYXBzZWRTaW5jZTogZnVuY3Rpb24gKHNpbmNlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubm93IC0gc2luY2U7CiAgICB9LAoKICAgIC8qKgogICAgKiBIb3cgbG9uZyBoYXMgcGFzc2VkIHNpbmNlIHRoZSBnaXZlbiB0aW1lIChpbiBzZWNvbmRzKS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZSNlbGFwc2VkU2Vjb25kc1NpbmNlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzaW5jZSAtIFRoZSB0aW1lIHlvdSB3YW50IHRvIG1lYXN1cmUgKGluIHNlY29uZHMpLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IER1cmF0aW9uIGJldHdlZW4gZ2l2ZW4gdGltZSBhbmQgbm93IChpbiBzZWNvbmRzKS4KICAgICovCiAgICBlbGFwc2VkU2Vjb25kc1NpbmNlOiBmdW5jdGlvbiAoc2luY2UpIHsKICAgICAgICByZXR1cm4gKHRoaXMubm93IC0gc2luY2UpICogMC4wMDE7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXNldHMgdGhlIHByaXZhdGUgX3N0YXJ0ZWQgdmFsdWUgdG8gbm93LgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lI3Jlc2V0CiAgICAqLwogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLl9zdGFydGVkID0gdGhpcy5ub3c7CiAgICB9Cgp9OwoKUGhhc2VyLlRpbWUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlRpbWU7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIFRpbWVyIGlzIGEgd2F5IHRvIGNyZWF0ZSBzbWFsbCByZS11c2FibGUgb3IgZGlzcG9zYWJsZSBvYmplY3RzIHRoYXQgZG8gbm90aGluZyBidXQgd2FpdCBmb3IgYSBzcGVjaWZpYyBtb21lbnQgaW4gdGltZSwgYW5kIHRoZW4gZGlzcGF0Y2ggYW4gZXZlbnQuCiogWW91IGNhbiBhZGQgYXMgbWFueSBldmVudHMgdG8gYSBUaW1lciBhcyB5b3UgbGlrZSwgZWFjaCB3aXRoIHRoZWlyIG93biBkZWxheXMuIEEgVGltZXIgdXNlcyBtaWxsaXNlY29uZHMgYXMgaXRzIHVuaXQgb2YgdGltZS4gVGhlcmUgYXJlIDEwMDAgbXMgaW4gMSBzZWNvbmQuCiogU28gaWYgeW91IHdhbnQgdG8gZmlyZSBhbiBldmVudCBldmVyeSBxdWFydGVyIG9mIGEgc2Vjb25kIHlvdSdkIG5lZWQgdG8gc2V0IHRoZSBkZWxheSB0byAyNTAuCioKKiBAY2xhc3MgUGhhc2VyLlRpbWVyCiogQGNsYXNzZGVzYyBBIFRpbWVyIGlzIGEgd2F5IHRvIGNyZWF0ZSBzbWFsbCByZS11c2FibGUgb3IgZGlzcG9zYWJsZSBvYmplY3RzIHRoYXQgZG8gbm90aGluZyBidXQgd2FpdCBmb3IgYSBzcGVjaWZpYyBtb21lbnQgaW4gdGltZSwgYW5kIHRoZW4gZGlzcGF0Y2ggYW4gZXZlbnQuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge2Jvb2xlYW59IFthdXRvRGVzdHJveT10cnVlXSAtIEEgVGltZXIgdGhhdCBpcyBzZXQgdG8gYXV0b21hdGljYWxseSBkZXN0cm95IGl0c2VsZiB3aWxsIGRvIHNvIGFmdGVyIGFsbCBvZiBpdHMgZXZlbnRzIGhhdmUgYmVlbiBkaXNwYXRjaGVkIChhc3N1bWluZyBubyBsb29waW5nIGV2ZW50cykuCiovClBoYXNlci5UaW1lciA9IGZ1bmN0aW9uIChnYW1lLCBhdXRvRGVzdHJveSkgewoKICAgIGlmICh0eXBlb2YgYXV0b0Rlc3Ryb3kgPT09ICd1bmRlZmluZWQnKSB7IGF1dG9EZXN0cm95ID0gdHJ1ZTsgfQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBydW5uaW5nIC0gVHJ1ZSBpZiB0aGUgVGltZXIgaXMgYWN0aXZlbHkgcnVubmluZy4gRG8gbm90IHN3aXRjaCB0aGlzIGJvb2xlYW4sIGlmIHlvdSB3aXNoIHRvIHBhdXNlIHRoZSB0aW1lciB0aGVuIHVzZSBUaW1lci5wYXVzZSgpIGluc3RlYWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYXV0b0Rlc3Ryb3kgLSBBIFRpbWVyIHRoYXQgaXMgc2V0IHRvIGF1dG9tYXRpY2FsbHkgZGVzdHJveSBpdHNlbGYgd2lsbCBkbyBzbyBhZnRlciBhbGwgb2YgaXRzIGV2ZW50cyBoYXZlIGJlZW4gZGlzcGF0Y2hlZCAoYXNzdW1pbmcgbm8gbG9vcGluZyBldmVudHMpLgogICAgKi8KICAgIHRoaXMuYXV0b0Rlc3Ryb3kgPSBhdXRvRGVzdHJveTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBleHBpcmVkIC0gQW4gZXhwaXJlZCBUaW1lciBpcyBvbmUgaW4gd2hpY2ggYWxsIG9mIGl0cyBldmVudHMgaGF2ZSBiZWVuIGRpc3BhdGNoZWQgYW5kIG5vbmUgYXJlIHBlbmRpbmcuCiAgICAqIEByZWFkb25seQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZXhwaXJlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5PFBoYXNlci5UaW1lckV2ZW50Pn0gZXZlbnRzIC0gQW4gYXJyYXkgaG9sZGluZyBhbGwgb2YgdGhpcyB0aW1lcnMgUGhhc2VyLlRpbWVyRXZlbnQgb2JqZWN0cy4gVXNlIHRoZSBtZXRob2RzIGFkZCwgcmVwZWF0IGFuZCBsb29wIHRvIHBvcHVsYXRlIGl0LgogICAgKi8KICAgIHRoaXMuZXZlbnRzID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Db21wbGV0ZSAtIFRoaXMgc2lnbmFsIHdpbGwgYmUgZGlzcGF0Y2hlZCB3aGVuIHRoaXMgVGltZXIgaGFzIGNvbXBsZXRlZCwgbWVhbmluZyB0aGVyZSBhcmUgbm8gbW9yZSBldmVudHMgaW4gdGhlIHF1ZXVlLgogICAgKi8KICAgIHRoaXMub25Db21wbGV0ZSA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBuZXh0VGljayAtIFRoZSB0aW1lIHRoZSBuZXh0IHRpY2sgd2lsbCBvY2N1ci4KICAgICogQHJlYWRvbmx5CiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB0aGlzLm5leHRUaWNrID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBwYXVzZWQgLSBUaGUgcGF1c2VkIHN0YXRlIG9mIHRoZSBUaW1lci4gWW91IGNhbiBwYXVzZSB0aGUgdGltZXIgYnkgY2FsbGluZyBUaW1lci5wYXVzZSgpIGFuZCBUaW1lci5yZXN1bWUoKSBvciBieSB0aGUgZ2FtZSBwYXVzaW5nLgogICAgKiBAcmVhZG9ubHkKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3N0YXJ0ZWQgLSBUaGUgdGltZSBhdCB3aGljaCB0aGlzIFRpbWVyIGluc3RhbmNlIHN0YXJ0ZWQgcnVubmluZy4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9zdGFydGVkID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9wYXVzZVN0YXJ0ZWQgLSBUaGUgdGltZSB0aGUgZ2FtZSBzdGFydGVkIGJlaW5nIHBhdXNlZC4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9wYXVzZVN0YXJ0ZWQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX25vdyAtIFRoZSBjdXJyZW50IHN0YXJ0LXRpbWUgYWRqdXN0ZWQgdGltZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9ub3cgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2xlbiAtIFRlbXAuIGFycmF5IGxlbmd0aCB2YXJpYWJsZS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9sZW4gPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2kgLSBUZW1wLiBhcnJheSBjb3VudGVyIHZhcmlhYmxlLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2kgPSAwOwoKfTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5UaW1lci5NSU5VVEUgPSA2MDAwMDsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5UaW1lci5TRUNPTkQgPSAxMDAwOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLlRpbWVyLkhBTEYgPSA1MDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuVGltZXIuUVVBUlRFUiA9IDI1MDsKClBoYXNlci5UaW1lci5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBuZXcgVGltZXJFdmVudCBvbiB0aGlzIFRpbWVyLiBVc2UgdGhlIG1ldGhvZHMgYWRkLCByZXBlYXQgb3IgbG9vcCBpbnN0ZWFkIG9mIHRoaXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWVyI2NyZWF0ZQogICAgKiBAcHJpdmF0ZQogICAgKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgLSBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0aGF0IHNob3VsZCBlbGFwc2UgYmVmb3JlIHRoZSBUaW1lciB3aWxsIGNhbGwgdGhlIGdpdmVuIGNhbGxiYWNrLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGxvb3AgLSBTaG91bGQgdGhlIGV2ZW50IGxvb3Agb3Igbm90PwogICAgKiBAcGFyYW0ge251bWJlcn0gcmVwZWF0Q291bnQgLSBUaGUgbnVtYmVyIG9mIHRpbWVzIHRoZSBldmVudCB3aWxsIHJlcGVhdC4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBUaW1lciBldmVudCBvY2N1cnMuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQuCiAgICAqIEBwYXJhbSB7YXJyYXl9IGFyZ3VtZW50cyAtIFRoZSB2YWx1ZXMgdG8gYmUgc2VudCB0byB5b3VyIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gaXQgaXMgY2FsbGVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGltZXJFdmVudH0gVGhlIFBoYXNlci5UaW1lckV2ZW50IG9iamVjdCB0aGF0IHdhcyBjcmVhdGVkLgogICAgKi8KICAgIGNyZWF0ZTogZnVuY3Rpb24gKGRlbGF5LCBsb29wLCByZXBlYXRDb3VudCwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgYXJncykgewoKICAgICAgICB2YXIgdGljayA9IGRlbGF5OwoKICAgICAgICBpZiAodGhpcy5ydW5uaW5nKQogICAgICAgIHsKICAgICAgICAgICAgdGljayArPSB0aGlzLl9ub3c7CiAgICAgICAgfQoKICAgICAgICB2YXIgZXZlbnQgPSBuZXcgUGhhc2VyLlRpbWVyRXZlbnQodGhpcywgZGVsYXksIHRpY2ssIHJlcGVhdENvdW50LCBsb29wLCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBhcmdzKTsKCiAgICAgICAgdGhpcy5ldmVudHMucHVzaChldmVudCk7CgogICAgICAgIHRoaXMub3JkZXIoKTsKCiAgICAgICAgdGhpcy5leHBpcmVkID0gZmFsc2U7CgogICAgICAgIHJldHVybiBldmVudDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIGEgbmV3IEV2ZW50IHRvIHRoaXMgVGltZXIuIFRoZSBldmVudCB3aWxsIGZpcmUgYWZ0ZXIgdGhlIGdpdmVuIGFtb3VudCBvZiAnZGVsYXknIGluIG1pbGxpc2Vjb25kcyBoYXMgcGFzc2VkLCBvbmNlIHRoZSBUaW1lciBoYXMgc3RhcnRlZCBydW5uaW5nLgogICAgKiBDYWxsIFRpbWVyLnN0YXJ0KCkgb25jZSB5b3UgaGF2ZSBhZGRlZCBhbGwgb2YgdGhlIEV2ZW50cyB5b3UgcmVxdWlyZSBmb3IgdGhpcyBUaW1lci4gVGhlIGRlbGF5IGlzIGluIHJlbGF0aW9uIHRvIHdoZW4gdGhlIFRpbWVyIHN0YXJ0cywgbm90IHRoZSB0aW1lIGl0IHdhcyBhZGRlZC4KICAgICogSWYgdGhlIFRpbWVyIGlzIGFscmVhZHkgcnVubmluZyB0aGUgZGVsYXkgd2lsbCBiZSBjYWxjdWxhdGVkIGJhc2VkIG9uIHRoZSB0aW1lcnMgY3VycmVudCB0aW1lLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lciNhZGQKICAgICogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdGhhdCBzaG91bGQgZWxhcHNlIGJlZm9yZSB0aGUgVGltZXIgd2lsbCBjYWxsIHRoZSBnaXZlbiBjYWxsYmFjay4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBUaW1lciBldmVudCBvY2N1cnMuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQuCiAgICAqIEBwYXJhbSB7Li4uKn0gYXJndW1lbnRzIC0gVGhlIHZhbHVlcyB0byBiZSBzZW50IHRvIHlvdXIgY2FsbGJhY2sgZnVuY3Rpb24gd2hlbiBpdCBpcyBjYWxsZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5UaW1lckV2ZW50fSBUaGUgUGhhc2VyLlRpbWVyRXZlbnQgb2JqZWN0IHRoYXQgd2FzIGNyZWF0ZWQuCiAgICAqLwogICAgYWRkOiBmdW5jdGlvbiAoZGVsYXksIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlKGRlbGF5LCBmYWxzZSwgMCwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMykpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgYSBuZXcgRXZlbnQgdG8gdGhpcyBUaW1lciB0aGF0IHdpbGwgcmVwZWF0IGZvciB0aGUgZ2l2ZW4gbnVtYmVyIG9mIGl0ZXJhdGlvbnMuCiAgICAqIFRoZSBldmVudCB3aWxsIGZpcmUgYWZ0ZXIgdGhlIGdpdmVuIGFtb3VudCBvZiAnZGVsYXknIG1pbGxpc2Vjb25kcyBoYXMgcGFzc2VkIG9uY2UgdGhlIFRpbWVyIGhhcyBzdGFydGVkIHJ1bm5pbmcuCiAgICAqIENhbGwgVGltZXIuc3RhcnQoKSBvbmNlIHlvdSBoYXZlIGFkZGVkIGFsbCBvZiB0aGUgRXZlbnRzIHlvdSByZXF1aXJlIGZvciB0aGlzIFRpbWVyLiBUaGUgZGVsYXkgaXMgaW4gcmVsYXRpb24gdG8gd2hlbiB0aGUgVGltZXIgc3RhcnRzLCBub3QgdGhlIHRpbWUgaXQgd2FzIGFkZGVkLgogICAgKiBJZiB0aGUgVGltZXIgaXMgYWxyZWFkeSBydW5uaW5nIHRoZSBkZWxheSB3aWxsIGJlIGNhbGN1bGF0ZWQgYmFzZWQgb24gdGhlIHRpbWVycyBjdXJyZW50IHRpbWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWVyI3JlcGVhdAogICAgKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgLSBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0aGF0IHNob3VsZCBlbGFwc2UgYmVmb3JlIHRoZSBUaW1lciB3aWxsIGNhbGwgdGhlIGdpdmVuIGNhbGxiYWNrLgogICAgKiBAcGFyYW0ge251bWJlcn0gcmVwZWF0Q291bnQgLSBUaGUgbnVtYmVyIG9mIHRpbWVzIHRoZSBldmVudCB3aWxsIHJlcGVhdC4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBUaW1lciBldmVudCBvY2N1cnMuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQuCiAgICAqIEBwYXJhbSB7Li4uKn0gYXJndW1lbnRzIC0gVGhlIHZhbHVlcyB0byBiZSBzZW50IHRvIHlvdXIgY2FsbGJhY2sgZnVuY3Rpb24gd2hlbiBpdCBpcyBjYWxsZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5UaW1lckV2ZW50fSBUaGUgUGhhc2VyLlRpbWVyRXZlbnQgb2JqZWN0IHRoYXQgd2FzIGNyZWF0ZWQuCiAgICAqLwogICAgcmVwZWF0OiBmdW5jdGlvbiAoZGVsYXksIHJlcGVhdENvdW50LCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZShkZWxheSwgZmFsc2UsIHJlcGVhdENvdW50LCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLCA0KSk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyBhIG5ldyBsb29wZWQgRXZlbnQgdG8gdGhpcyBUaW1lciB0aGF0IHdpbGwgcmVwZWF0IGZvcmV2ZXIgb3IgdW50aWwgdGhlIFRpbWVyIGlzIHN0b3BwZWQuCiAgICAqIFRoZSBldmVudCB3aWxsIGZpcmUgYWZ0ZXIgdGhlIGdpdmVuIGFtb3VudCBvZiAnZGVsYXknIG1pbGxpc2Vjb25kcyBoYXMgcGFzc2VkIG9uY2UgdGhlIFRpbWVyIGhhcyBzdGFydGVkIHJ1bm5pbmcuCiAgICAqIENhbGwgVGltZXIuc3RhcnQoKSBvbmNlIHlvdSBoYXZlIGFkZGVkIGFsbCBvZiB0aGUgRXZlbnRzIHlvdSByZXF1aXJlIGZvciB0aGlzIFRpbWVyLiBUaGUgZGVsYXkgaXMgaW4gcmVsYXRpb24gdG8gd2hlbiB0aGUgVGltZXIgc3RhcnRzLCBub3QgdGhlIHRpbWUgaXQgd2FzIGFkZGVkLgogICAgKiBJZiB0aGUgVGltZXIgaXMgYWxyZWFkeSBydW5uaW5nIHRoZSBkZWxheSB3aWxsIGJlIGNhbGN1bGF0ZWQgYmFzZWQgb24gdGhlIHRpbWVycyBjdXJyZW50IHRpbWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWVyI2xvb3AKICAgICogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdGhhdCBzaG91bGQgZWxhcHNlIGJlZm9yZSB0aGUgVGltZXIgd2lsbCBjYWxsIHRoZSBnaXZlbiBjYWxsYmFjay4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBUaW1lciBldmVudCBvY2N1cnMuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQuCiAgICAqIEBwYXJhbSB7Li4uKn0gYXJndW1lbnRzIC0gVGhlIHZhbHVlcyB0byBiZSBzZW50IHRvIHlvdXIgY2FsbGJhY2sgZnVuY3Rpb24gd2hlbiBpdCBpcyBjYWxsZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5UaW1lckV2ZW50fSBUaGUgUGhhc2VyLlRpbWVyRXZlbnQgb2JqZWN0IHRoYXQgd2FzIGNyZWF0ZWQuCiAgICAqLwogICAgbG9vcDogZnVuY3Rpb24gKGRlbGF5LCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZShkZWxheSwgdHJ1ZSwgMCwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMykpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0YXJ0cyB0aGlzIFRpbWVyIHJ1bm5pbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWVyI3N0YXJ0CiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uKCkgewoKICAgICAgICB0aGlzLl9zdGFydGVkID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgIHRoaXMucnVubmluZyA9IHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgdGhpcyBUaW1lciBmcm9tIHJ1bm5pbmcuIERvZXMgbm90IGNhdXNlIGl0IHRvIGJlIGRlc3Ryb3llZCBpZiBhdXRvRGVzdHJveSBpcyBzZXQgdG8gdHJ1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZXIjc3RvcAogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewoKICAgICAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLmV2ZW50cy5sZW5ndGggPSAwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgYSBwZW5kaW5nIFRpbWVyRXZlbnQgZnJvbSB0aGUgcXVldWUuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlRpbWVyRXZlbnR9IGV2ZW50IC0gVGhlIGV2ZW50IHRvIHJlbW92ZSBmcm9tIHRoZSBxdWV1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZXIjcmVtb3ZlCiAgICAqLwogICAgcmVtb3ZlOiBmdW5jdGlvbihldmVudCkgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZXZlbnRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuZXZlbnRzW2ldID09PSBldmVudCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5ldmVudHNbaV0ucGVuZGluZ0RlbGV0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIE9yZGVycyB0aGUgZXZlbnRzIG9uIHRoaXMgVGltZXIgc28gdGhleSBhcmUgaW4gdGljayBvcmRlci4gVGhpcyBpcyBjYWxsZWQgYXV0b21hdGljYWxseSB3aGVuIG5ldyBldmVudHMgYXJlIGNyZWF0ZWQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWVyI29yZGVyCiAgICAqLwogICAgb3JkZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuZXZlbnRzLmxlbmd0aCA+IDApCiAgICAgICAgewogICAgICAgICAgICAvLyAgU29ydCB0aGUgZXZlbnRzIHNvIHRoZSBvbmUgd2l0aCB0aGUgbG93ZXN0IHRpY2sgaXMgZmlyc3QKICAgICAgICAgICAgdGhpcy5ldmVudHMuc29ydCh0aGlzLnNvcnRIYW5kbGVyKTsKCiAgICAgICAgICAgIHRoaXMubmV4dFRpY2sgPSB0aGlzLmV2ZW50c1swXS50aWNrOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTb3J0IGhhbmRsZXIgdXNlZCBieSBQaGFzZXIuVGltZXIub3JkZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWVyI3NvcnRIYW5kbGVyCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBzb3J0SGFuZGxlcjogZnVuY3Rpb24gKGEsIGIpIHsKCiAgICAgICAgaWYgKGEudGljayA8IGIudGljaykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYS50aWNrID4gYi50aWNrKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gMDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgbWFpbiBUaW1lciB1cGRhdGUgZXZlbnQsIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IHRoZSBHYW1lIGNsb2NrLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lciN1cGRhdGUKICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge251bWJlcn0gdGltZSAtIFRoZSB0aW1lIGZyb20gdGhlIGNvcmUgZ2FtZSBjbG9jay4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGVyZSBhcmUgc3RpbGwgZXZlbnRzIHdhaXRpbmcgdG8gYmUgZGlzcGF0Y2hlZCwgb3RoZXJ3aXNlIGZhbHNlIGlmIHRoaXMgVGltZXIgY2FuIGJlIGRlc3Ryb3llZC4KICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uKHRpbWUpIHsKCiAgICAgICAgaWYgKHRoaXMucGF1c2VkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9ub3cgPSB0aW1lIC0gdGhpcy5fc3RhcnRlZDsKCiAgICAgICAgdGhpcy5fbGVuID0gdGhpcy5ldmVudHMubGVuZ3RoOwoKICAgICAgICB0aGlzLl9pID0gMDsKCiAgICAgICAgd2hpbGUgKHRoaXMuX2kgPCB0aGlzLl9sZW4pCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5ldmVudHNbdGhpcy5faV0ucGVuZGluZ0RlbGV0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5ldmVudHMuc3BsaWNlKHRoaXMuX2ksIDEpOwogICAgICAgICAgICAgICAgdGhpcy5fbGVuLS07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2krKzsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2xlbiA9IHRoaXMuZXZlbnRzLmxlbmd0aDsKCiAgICAgICAgaWYgKHRoaXMucnVubmluZyAmJiB0aGlzLl9ub3cgPj0gdGhpcy5uZXh0VGljayAmJiB0aGlzLl9sZW4gPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faSA9IDA7CgogICAgICAgICAgICB3aGlsZSAodGhpcy5faSA8IHRoaXMuX2xlbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX25vdyA+PSB0aGlzLmV2ZW50c1t0aGlzLl9pXS50aWNrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmV2ZW50c1t0aGlzLl9pXS5sb29wID09PSB0cnVlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmVudHNbdGhpcy5faV0udGljayArPSB0aGlzLmV2ZW50c1t0aGlzLl9pXS5kZWxheSAtICh0aGlzLl9ub3cgLSB0aGlzLmV2ZW50c1t0aGlzLl9pXS50aWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmVudHNbdGhpcy5faV0uY2FsbGJhY2suYXBwbHkodGhpcy5ldmVudHNbdGhpcy5faV0uY2FsbGJhY2tDb250ZXh0LCB0aGlzLmV2ZW50c1t0aGlzLl9pXS5hcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5ldmVudHNbdGhpcy5faV0ucmVwZWF0Q291bnQgPiAwKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmVudHNbdGhpcy5faV0ucmVwZWF0Q291bnQtLTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmVudHNbdGhpcy5faV0udGljayArPSB0aGlzLmV2ZW50c1t0aGlzLl9pXS5kZWxheSAtICh0aGlzLl9ub3cgLSB0aGlzLmV2ZW50c1t0aGlzLl9pXS50aWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmVudHNbdGhpcy5faV0uY2FsbGJhY2suYXBwbHkodGhpcy5ldmVudHNbdGhpcy5faV0uY2FsbGJhY2tDb250ZXh0LCB0aGlzLmV2ZW50c1t0aGlzLl9pXS5hcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmVudHNbdGhpcy5faV0uY2FsbGJhY2suYXBwbHkodGhpcy5ldmVudHNbdGhpcy5faV0uY2FsbGJhY2tDb250ZXh0LCB0aGlzLmV2ZW50c1t0aGlzLl9pXS5hcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmVudHMuc3BsaWNlKHRoaXMuX2ksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sZW4tLTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRoaXMuX2krKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIEFyZSB0aGVyZSBhbnkgZXZlbnRzIGxlZnQ/CiAgICAgICAgICAgIGlmICh0aGlzLmV2ZW50cy5sZW5ndGggPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm9yZGVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5vbkNvbXBsZXRlLmRpc3BhdGNoKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5leHBpcmVkICYmIHRoaXMuYXV0b0Rlc3Ryb3kpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXVzZXMgdGhlIFRpbWVyIGFuZCBhbGwgZXZlbnRzIGluIHRoZSBxdWV1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGltZXIjcGF1c2UKICAgICovCiAgICBwYXVzZTogZnVuY3Rpb24gKCkgewogICAgICAgIAogICAgICAgIGlmICh0aGlzLnJ1bm5pbmcgJiYgIXRoaXMuZXhwaXJlZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BhdXNlU3RhcnRlZCA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKCiAgICAgICAgICAgIHRoaXMucGF1c2VkID0gdHJ1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUmVzdW1lcyB0aGUgVGltZXIgYW5kIHVwZGF0ZXMgYWxsIHBlbmRpbmcgZXZlbnRzLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaW1lciNyZXN1bWUKICAgICovCiAgICByZXN1bWU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMucnVubmluZyAmJiAhdGhpcy5leHBpcmVkKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhdXNlRHVyYXRpb24gPSB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9wYXVzZVN0YXJ0ZWQ7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZXZlbnRzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50c1tpXS50aWNrICs9IHBhdXNlRHVyYXRpb247CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubmV4dFRpY2sgKz0gcGF1c2VEdXJhdGlvbjsKCiAgICAgICAgICAgIHRoaXMucGF1c2VkID0gZmFsc2U7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIERlc3Ryb3lzIHRoaXMgVGltZXIuIEV2ZW50cyBhcmUgbm90IGRpc3BhdGNoZWQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbWVyI2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKCiAgICAgICAgdGhpcy5vbkNvbXBsZXRlLnJlbW92ZUFsbCgpOwogICAgICAgIHRoaXMucnVubmluZyA9IGZhbHNlOwogICAgICAgIHRoaXMuZXZlbnRzID0gW107CiAgICAgICAgdGhpcy5faSA9IHRoaXMuX2xlbjsKCiAgICB9Cgp9OwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbWVyI25leHQKKiBAcHJvcGVydHkge251bWJlcn0gbmV4dCAtIFRoZSB0aW1lIGF0IHdoaWNoIHRoZSBuZXh0IGV2ZW50IHdpbGwgb2NjdXIuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGltZXIucHJvdG90eXBlLCAibmV4dCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5uZXh0VGljazsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbWVyI2R1cmF0aW9uCiogQHByb3BlcnR5IHtudW1iZXJ9IGR1cmF0aW9uIC0gVGhlIGR1cmF0aW9uIGluIG1zIHJlbWFpbmluZyB1bnRpbCB0aGUgbmV4dCBldmVudCB3aWxsIG9jY3VyLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbWVyLnByb3RvdHlwZSwgImR1cmF0aW9uIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIAogICAgICAgIGlmICh0aGlzLnJ1bm5pbmcgJiYgdGhpcy5uZXh0VGljayA+IHRoaXMuX25vdykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm5leHRUaWNrIC0gdGhpcy5fbm93OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuVGltZXIjbGVuZ3RoCiogQHByb3BlcnR5IHtudW1iZXJ9IGxlbmd0aCAtIFRoZSBudW1iZXIgb2YgcGVuZGluZyBldmVudHMgaW4gdGhlIHF1ZXVlLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbWVyLnByb3RvdHlwZSwgImxlbmd0aCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5ldmVudHMubGVuZ3RoOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuVGltZXIjbXMKKiBAcHJvcGVydHkge251bWJlcn0gbXMgLSBUaGUgZHVyYXRpb24gaW4gbWlsbGlzZWNvbmRzIHRoYXQgdGhpcyBUaW1lciBoYXMgYmVlbiBydW5uaW5nIGZvci4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaW1lci5wcm90b3R5cGUsICJtcyIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbm93OwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuVGltZXIjc2Vjb25kcwoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzZWNvbmRzIC0gVGhlIGR1cmF0aW9uIGluIHNlY29uZHMgdGhhdCB0aGlzIFRpbWVyIGhhcyBiZWVuIHJ1bm5pbmcgZm9yLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbWVyLnByb3RvdHlwZSwgInNlY29uZHMiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX25vdyAqIDAuMDAxOwogICAgfQoKfSk7CgpQaGFzZXIuVGltZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlRpbWVyOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQSBUaW1lckV2ZW50IGlzIGEgc2luZ2xlIGV2ZW50IHRoYXQgaXMgcHJvY2Vzc2VkIGJ5IGEgUGhhc2VyLlRpbWVyLiBJdCBjb25zaXN0cyBvZiBhIGRlbGF5LCB3aGljaCBpcyBhIHZhbHVlIGluIG1pbGxpc2Vjb25kcyBhZnRlciB3aGljaCB0aGUgZXZlbnQgd2lsbCBmaXJlLgoqIEl0IGNhbiBjYWxsIGEgc3BlY2lmaWMgY2FsbGJhY2ssIHBhc3NpbmcgaW4gb3B0aW9uYWwgcGFyYW1ldGVycy4KKgoqIEBjbGFzcyBQaGFzZXIuVGltZXJFdmVudAoqIEBjbGFzc2Rlc2MgQSBUaW1lckV2ZW50IGlzIGEgc2luZ2xlIGV2ZW50IHRoYXQgaXMgcHJvY2Vzc2VkIGJ5IGEgUGhhc2VyLlRpbWVyLiBJdCBjb25zaXN0cyBvZiBhIGRlbGF5LCB3aGljaCBpcyBhIHZhbHVlIGluIG1pbGxpc2Vjb25kcyBhZnRlciB3aGljaCB0aGUgZXZlbnQgd2lsbCBmaXJlLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLlRpbWVyfSB0aW1lciAtIFRoZSBUaW1lciBvYmplY3QgdGhhdCB0aGlzIFRpbWVyRXZlbnQgYmVsb25ncyB0by4KKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgLSBUaGUgZGVsYXkgaW4gbXMgYXQgd2hpY2ggdGhpcyBUaW1lckV2ZW50IGZpcmVzLgoqIEBwYXJhbSB7bnVtYmVyfSB0aWNrIC0gVGhlIHRpY2sgaXMgdGhlIG5leHQgZ2FtZSBjbG9jayB0aW1lIHRoYXQgdGhpcyBldmVudCB3aWxsIGZpcmUgYXQuCiogQHBhcmFtIHtudW1iZXJ9IHJlcGVhdENvdW50IC0gSWYgdGhpcyBUaW1lckV2ZW50IHJlcGVhdHMgaXQgd2lsbCBkbyBzbyB0aGlzIG1hbnkgdGltZXMuCiogQHBhcmFtIHtib29sZWFufSBsb29wIC0gVHJ1ZSBpZiB0aGlzIFRpbWVyRXZlbnQgbG9vcHMsIG90aGVyd2lzZSBmYWxzZS4KKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBjYWxsYmFjayB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIFRpbWVyRXZlbnQgb2NjdXJzLgoqIEBwYXJhbSB7b2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQuCiogQHBhcmFtIHthcnJheX0gYXJndW1lbnRzIC0gVGhlIHZhbHVlcyB0byBiZSBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrLgoqLwpQaGFzZXIuVGltZXJFdmVudCA9IGZ1bmN0aW9uICh0aW1lciwgZGVsYXksIHRpY2ssIHJlcGVhdENvdW50LCBsb29wLCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBhcmdzKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlRpbWVyfSB0aW1lciAtIFRoZSBUaW1lciBvYmplY3QgdGhhdCB0aGlzIFRpbWVyRXZlbnQgYmVsb25ncyB0by4KICAgICovCgl0aGlzLnRpbWVyID0gdGltZXI7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkZWxheSAtIFRoZSBkZWxheSBpbiBtcyBhdCB3aGljaCB0aGlzIFRpbWVyRXZlbnQgZmlyZXMuCiAgICAqLwoJdGhpcy5kZWxheSA9IGRlbGF5OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdGljayAtIFRoZSB0aWNrIGlzIHRoZSBuZXh0IGdhbWUgY2xvY2sgdGltZSB0aGF0IHRoaXMgZXZlbnQgd2lsbCBmaXJlIGF0LgogICAgKi8KCXRoaXMudGljayA9IHRpY2s7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZXBlYXRDb3VudCAtIElmIHRoaXMgVGltZXJFdmVudCByZXBlYXRzIGl0IHdpbGwgZG8gc28gdGhpcyBtYW55IHRpbWVzLgogICAgKi8KCXRoaXMucmVwZWF0Q291bnQgPSByZXBlYXRDb3VudCAtIDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbG9vcCAtIFRydWUgaWYgdGhpcyBUaW1lckV2ZW50IGxvb3BzLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwoJdGhpcy5sb29wID0gbG9vcDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBUaW1lckV2ZW50IG9jY3Vycy4KICAgICovCgl0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQuCiAgICAqLwoJdGhpcy5jYWxsYmFja0NvbnRleHQgPSBjYWxsYmFja0NvbnRleHQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGFyZ3VtZW50cyAtIFRoZSB2YWx1ZXMgdG8gYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjay4KICAgICovCgl0aGlzLmFyZ3MgPSBhcmdzOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHBlbmRpbmdEZWxldGUgLSBBIGZsYWcgdGhhdCBjb250cm9scyBpZiB0aGUgVGltZXJFdmVudCBpcyBwZW5kaW5nIGRlbGV0aW9uLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdGhpcy5wZW5kaW5nRGVsZXRlID0gZmFsc2U7Cgp9OwoKUGhhc2VyLlRpbWVyRXZlbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlRpbWVyRXZlbnQ7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBUaGUgQW5pbWF0aW9uIE1hbmFnZXIgaXMgdXNlZCB0byBhZGQsIHBsYXkgYW5kIHVwZGF0ZSBQaGFzZXIgQW5pbWF0aW9ucy4KKiBBbnkgR2FtZSBPYmplY3Qgc3VjaCBhcyBQaGFzZXIuU3ByaXRlIHRoYXQgc3VwcG9ydHMgYW5pbWF0aW9uIGNvbnRhaW5zIGEgc2luZ2xlIEFuaW1hdGlvbk1hbmFnZXIgaW5zdGFuY2UuCioKKiBAY2xhc3MgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBHYW1lIE9iamVjdCB0aGF0IG93bnMgdGhpcyBBbmltYXRpb25NYW5hZ2VyLgoqLwpQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciA9IGZ1bmN0aW9uIChzcHJpdGUpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBBIHJlZmVyZW5jZSB0byB0aGUgcGFyZW50IFNwcml0ZSB0aGF0IG93bnMgdGhpcyBBbmltYXRpb25NYW5hZ2VyLgogICAgKi8KICAgIHRoaXMuc3ByaXRlID0gc3ByaXRlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gc3ByaXRlLmdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkZyYW1lfSBjdXJyZW50RnJhbWUgLSBUaGUgY3VycmVudGx5IGRpc3BsYXllZCBGcmFtZSBvZiBhbmltYXRpb24sIGlmIGFueS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHVwZGF0ZUlmVmlzaWJsZSAtIFNob3VsZCB0aGUgYW5pbWF0aW9uIGRhdGEgY29udGludWUgdG8gdXBkYXRlIGV2ZW4gaWYgdGhlIFNwcml0ZS52aXNpYmxlIGlzIHNldCB0byBmYWxzZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnVwZGF0ZUlmVmlzaWJsZSA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNMb2FkZWQgLSBTZXQgdG8gdHJ1ZSBvbmNlIGFuaW1hdGlvbiBkYXRhIGhhcyBiZWVuIGxvYWRlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzTG9hZGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkZyYW1lRGF0YX0gX2ZyYW1lRGF0YSAtIEEgdGVtcC4gdmFyIGZvciBob2xkaW5nIHRoZSBjdXJyZW50bHkgcGxheWluZyBBbmltYXRpb25zIEZyYW1lRGF0YS4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9mcmFtZURhdGEgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX2FuaW1zIC0gQW4gaW50ZXJuYWwgb2JqZWN0IHRoYXQgc3RvcmVzIGFsbCBvZiB0aGUgQW5pbWF0aW9uIGluc3RhbmNlcy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9hbmltcyA9IHt9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX291dHB1dEZyYW1lcyAtIEFuIGludGVybmFsIG9iamVjdCB0byBoZWxwIGF2b2lkIGdjLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX291dHB1dEZyYW1lcyA9IFtdOwoKfTsKClBoYXNlci5BbmltYXRpb25NYW5hZ2VyLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogTG9hZHMgRnJhbWVEYXRhIGludG8gdGhlIGludGVybmFsIHRlbXBvcmFyeSB2YXJzIGFuZCByZXNldHMgdGhlIGZyYW1lIGluZGV4IHRvIHplcm8uCiAgICAqIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgd2hlbiBhIG5ldyBTcHJpdGUgaXMgY3JlYXRlZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNsb2FkRnJhbWVEYXRhCiAgICAqIEBwcml2YXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLkZyYW1lRGF0YX0gZnJhbWVEYXRhIC0gVGhlIEZyYW1lRGF0YSBzZXQgdG8gbG9hZC4KICAgICovCiAgICBsb2FkRnJhbWVEYXRhOiBmdW5jdGlvbiAoZnJhbWVEYXRhKSB7CgogICAgICAgIHRoaXMuX2ZyYW1lRGF0YSA9IGZyYW1lRGF0YTsKICAgICAgICB0aGlzLmZyYW1lID0gMDsKICAgICAgICB0aGlzLmlzTG9hZGVkID0gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIGEgbmV3IGFuaW1hdGlvbiB1bmRlciB0aGUgZ2l2ZW4ga2V5LiBPcHRpb25hbGx5IHNldCB0aGUgZnJhbWVzLCBmcmFtZSByYXRlIGFuZCBsb29wLgogICAgKiBBbmltYXRpb25zIGFkZGVkIGluIHRoaXMgd2F5IGFyZSBwbGF5ZWQgYmFjayB3aXRoIHRoZSBwbGF5IGZ1bmN0aW9uLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2FkZAogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSB1bmlxdWUgKHdpdGhpbiB0aGlzIFNwcml0ZSkgbmFtZSBmb3IgdGhlIGFuaW1hdGlvbiwgaS5lLiAicnVuIiwgImZpcmUiLCAid2FsayIuCiAgICAqIEBwYXJhbSB7QXJyYXl9IFtmcmFtZXM9bnVsbF0gLSBBbiBhcnJheSBvZiBudW1iZXJzL3N0cmluZ3MgdGhhdCBjb3JyZXNwb25kIHRvIHRoZSBmcmFtZXMgdG8gYWRkIHRvIHRoaXMgYW5pbWF0aW9uIGFuZCBpbiB3aGljaCBvcmRlci4gZS5nLiBbMSwgMiwgM10gb3IgWydydW4wJywgJ3J1bjEnLCBydW4yXSkuIElmIG51bGwgdGhlbiBhbGwgZnJhbWVzIHdpbGwgYmUgdXNlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcmFtZVJhdGU9NjBdIC0gVGhlIHNwZWVkIGF0IHdoaWNoIHRoZSBhbmltYXRpb24gc2hvdWxkIHBsYXkuIFRoZSBzcGVlZCBpcyBnaXZlbiBpbiBmcmFtZXMgcGVyIHNlY29uZC4KICAgICogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBXaGV0aGVyIG9yIG5vdCB0aGUgYW5pbWF0aW9uIGlzIGxvb3BlZCBvciBqdXN0IHBsYXlzIG9uY2UuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3VzZU51bWVyaWNJbmRleD10cnVlXSAtIEFyZSB0aGUgZ2l2ZW4gZnJhbWVzIHVzaW5nIG51bWVyaWMgaW5kZXhlcyAoZGVmYXVsdCkgb3Igc3RyaW5ncz8KICAgICogQHJldHVybiB7UGhhc2VyLkFuaW1hdGlvbn0gVGhlIEFuaW1hdGlvbiBvYmplY3QgdGhhdCB3YXMgY3JlYXRlZC4KICAgICovCiAgICBhZGQ6IGZ1bmN0aW9uIChuYW1lLCBmcmFtZXMsIGZyYW1lUmF0ZSwgbG9vcCwgdXNlTnVtZXJpY0luZGV4KSB7CgogICAgICAgIGlmICh0aGlzLl9mcmFtZURhdGEgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignTm8gRnJhbWVEYXRhIGF2YWlsYWJsZSBmb3IgUGhhc2VyLkFuaW1hdGlvbiAnICsgbmFtZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZyYW1lUmF0ZSA9IGZyYW1lUmF0ZSB8fCA2MDsKCiAgICAgICAgaWYgKHR5cGVvZiBsb29wID09PSAndW5kZWZpbmVkJykgeyBsb29wID0gZmFsc2U7IH0KCiAgICAgICAgLy8gIElmIHRoZXkgZGlkbid0IHNldCB0aGUgdXNlTnVtZXJpY0luZGV4IHRoZW4gbGV0J3MgYXQgbGVhc3QgdHJ5IGFuZCBndWVzcyBpdAogICAgICAgIGlmICh0eXBlb2YgdXNlTnVtZXJpY0luZGV4ID09PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChmcmFtZXMgJiYgdHlwZW9mIGZyYW1lc1swXSA9PT0gJ251bWJlcicpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHVzZU51bWVyaWNJbmRleCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB1c2VOdW1lcmljSW5kZXggPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gIENyZWF0ZSB0aGUgc2lnbmFscyB0aGUgQW5pbWF0aW9uTWFuYWdlciB3aWxsIGVtaXQKICAgICAgICBpZiAodGhpcy5zcHJpdGUuZXZlbnRzLm9uQW5pbWF0aW9uU3RhcnQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbkFuaW1hdGlvblN0YXJ0ID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uQW5pbWF0aW9uQ29tcGxldGUgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25BbmltYXRpb25Mb29wID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX291dHB1dEZyYW1lcy5sZW5ndGggPSAwOwoKICAgICAgICB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWVJbmRleGVzKGZyYW1lcywgdXNlTnVtZXJpY0luZGV4LCB0aGlzLl9vdXRwdXRGcmFtZXMpOwoKICAgICAgICB0aGlzLl9hbmltc1tuYW1lXSA9IG5ldyBQaGFzZXIuQW5pbWF0aW9uKHRoaXMuZ2FtZSwgdGhpcy5zcHJpdGUsIG5hbWUsIHRoaXMuX2ZyYW1lRGF0YSwgdGhpcy5fb3V0cHV0RnJhbWVzLCBmcmFtZVJhdGUsIGxvb3ApOwogICAgICAgIHRoaXMuY3VycmVudEFuaW0gPSB0aGlzLl9hbmltc1tuYW1lXTsKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuY3VycmVudEFuaW0uY3VycmVudEZyYW1lOwogICAgICAgIHRoaXMuc3ByaXRlLnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwoKICAgICAgICByZXR1cm4gdGhpcy5fYW5pbXNbbmFtZV07CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgd2hldGhlciB0aGUgZnJhbWVzIGluIHRoZSBnaXZlbiBhcnJheSBhcmUgdmFsaWQgYW5kIGV4aXN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI3ZhbGlkYXRlRnJhbWVzCiAgICAqIEBwYXJhbSB7QXJyYXl9IGZyYW1lcyAtIEFuIGFycmF5IG9mIGZyYW1lcyB0byBiZSB2YWxpZGF0ZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3VzZU51bWVyaWNJbmRleD10cnVlXSAtIFZhbGlkYXRlIHRoZSBmcmFtZXMgYmFzZWQgb24gdGhlaXIgbnVtZXJpYyBpbmRleCAodHJ1ZSkgb3Igc3RyaW5nIGluZGV4IChmYWxzZSkKICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBhbGwgZ2l2ZW4gRnJhbWVzIGFyZSB2YWxpZCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIHZhbGlkYXRlRnJhbWVzOiBmdW5jdGlvbiAoZnJhbWVzLCB1c2VOdW1lcmljSW5kZXgpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB1c2VOdW1lcmljSW5kZXggPT0gJ3VuZGVmaW5lZCcpIHsgdXNlTnVtZXJpY0luZGV4ID0gdHJ1ZTsgfQoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZyYW1lcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh1c2VOdW1lcmljSW5kZXggPT09IHRydWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChmcmFtZXNbaV0gPiB0aGlzLl9mcmFtZURhdGEudG90YWwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2ZyYW1lRGF0YS5jaGVja0ZyYW1lTmFtZShmcmFtZXNbaV0pID09PSBmYWxzZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFBsYXkgYW4gYW5pbWF0aW9uIGJhc2VkIG9uIHRoZSBnaXZlbiBrZXkuIFRoZSBhbmltYXRpb24gc2hvdWxkIHByZXZpb3VzbHkgaGF2ZSBiZWVuIGFkZGVkIHZpYSBzcHJpdGUuYW5pbWF0aW9ucy5hZGQoKQogICAgKiBJZiB0aGUgcmVxdWVzdGVkIGFuaW1hdGlvbiBpcyBhbHJlYWR5IHBsYXlpbmcgdGhpcyByZXF1ZXN0IHdpbGwgYmUgaWdub3JlZC4gSWYgeW91IG5lZWQgdG8gcmVzZXQgYW4gYWxyZWFkeSBydW5uaW5nIGFuaW1hdGlvbiBkbyBzbyBkaXJlY3RseSBvbiB0aGUgQW5pbWF0aW9uIG9iamVjdCBpdHNlbGYuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI3BsYXkKICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgYW5pbWF0aW9uIHRvIGJlIHBsYXllZCwgZS5nLiAiZmlyZSIsICJ3YWxrIiwgImp1bXAiLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2ZyYW1lUmF0ZT1udWxsXSAtIFRoZSBmcmFtZXJhdGUgdG8gcGxheSB0aGUgYW5pbWF0aW9uIGF0LiBUaGUgc3BlZWQgaXMgZ2l2ZW4gaW4gZnJhbWVzIHBlciBzZWNvbmQuIElmIG5vdCBwcm92aWRlZCB0aGUgcHJldmlvdXNseSBzZXQgZnJhbWVSYXRlIG9mIHRoZSBBbmltYXRpb24gaXMgdXNlZC4KICAgICogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBTaG91bGQgdGhlIGFuaW1hdGlvbiBiZSBsb29wZWQgYWZ0ZXIgcGxheWJhY2suIElmIG5vdCBwcm92aWRlZCB0aGUgcHJldmlvdXNseSBzZXQgbG9vcCB2YWx1ZSBvZiB0aGUgQW5pbWF0aW9uIGlzIHVzZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2tpbGxPbkNvbXBsZXRlPWZhbHNlXSAtIElmIHNldCB0byB0cnVlIHdoZW4gdGhlIGFuaW1hdGlvbiBjb21wbGV0ZXMgKG9ubHkgaGFwcGVucyBpZiBsb29wPWZhbHNlKSB0aGUgcGFyZW50IFNwcml0ZSB3aWxsIGJlIGtpbGxlZC4KICAgICogQHJldHVybiB7UGhhc2VyLkFuaW1hdGlvbn0gQSByZWZlcmVuY2UgdG8gcGxheWluZyBBbmltYXRpb24gaW5zdGFuY2UuCiAgICAqLwogICAgcGxheTogZnVuY3Rpb24gKG5hbWUsIGZyYW1lUmF0ZSwgbG9vcCwga2lsbE9uQ29tcGxldGUpIHsKCiAgICAgICAgaWYgKHRoaXMuX2FuaW1zW25hbWVdKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEFuaW0gPT0gdGhpcy5fYW5pbXNbbmFtZV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRBbmltLmlzUGxheWluZyA9PT0gZmFsc2UpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50QW5pbS5wYXVzZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50QW5pbS5wbGF5KGZyYW1lUmF0ZSwgbG9vcCwga2lsbE9uQ29tcGxldGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50QW5pbSA9IHRoaXMuX2FuaW1zW25hbWVdOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50QW5pbS5wYXVzZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRBbmltLnBsYXkoZnJhbWVSYXRlLCBsb29wLCBraWxsT25Db21wbGV0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcCBwbGF5YmFjayBvZiBhbiBhbmltYXRpb24uIElmIGEgbmFtZSBpcyBnaXZlbiB0aGF0IHNwZWNpZmljIGFuaW1hdGlvbiBpcyBzdG9wcGVkLCBvdGhlcndpc2UgdGhlIGN1cnJlbnQgYW5pbWF0aW9uIGlzIHN0b3BwZWQuCiAgICAqIFRoZSBjdXJyZW50QW5pbSBwcm9wZXJ0eSBvZiB0aGUgQW5pbWF0aW9uTWFuYWdlciBpcyBhdXRvbWF0aWNhbGx5IHNldCB0byB0aGUgYW5pbWF0aW9uIGdpdmVuLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI3N0b3AKICAgICogQHBhcmFtIHtzdHJpbmd9IFtuYW1lPW51bGxdIC0gVGhlIG5hbWUgb2YgdGhlIGFuaW1hdGlvbiB0byBiZSBzdG9wcGVkLCBlLmcuICJmaXJlIi4gSWYgbm9uZSBpcyBnaXZlbiB0aGUgY3VycmVudGx5IHJ1bm5pbmcgYW5pbWF0aW9uIGlzIHN0b3BwZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Jlc2V0RnJhbWU9ZmFsc2VdIC0gV2hlbiB0aGUgYW5pbWF0aW9uIGlzIHN0b3BwZWQgc2hvdWxkIHRoZSBjdXJyZW50RnJhbWUgYmUgc2V0IHRvIHRoZSBmaXJzdCBmcmFtZSBvZiB0aGUgYW5pbWF0aW9uICh0cnVlKSBvciBwYXVzZWQgb24gdGhlIGxhc3QgZnJhbWUgZGlzcGxheWVkIChmYWxzZSkKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAobmFtZSwgcmVzZXRGcmFtZSkgewoKICAgICAgICBpZiAodHlwZW9mIHJlc2V0RnJhbWUgPT0gJ3VuZGVmaW5lZCcpIHsgcmVzZXRGcmFtZSA9IGZhbHNlOyB9CgogICAgICAgIGlmICh0eXBlb2YgbmFtZSA9PSAnc3RyaW5nJykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9hbmltc1tuYW1lXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50QW5pbSA9IHRoaXMuX2FuaW1zW25hbWVdOwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50QW5pbS5zdG9wKHJlc2V0RnJhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRBbmltKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRBbmltLnN0b3AocmVzZXRGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIG1haW4gdXBkYXRlIGZ1bmN0aW9uIGlzIGNhbGxlZCBieSB0aGUgU3ByaXRlcyB1cGRhdGUgbG9vcC4gSXQncyByZXNwb25zaWJsZSBmb3IgdXBkYXRpbmcgYW5pbWF0aW9uIGZyYW1lcyBhbmQgZmlyaW5nIHJlbGF0ZWQgZXZlbnRzLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciN1cGRhdGUKICAgICogQHByb3RlY3RlZAogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGEgbmV3IGFuaW1hdGlvbiBmcmFtZSBoYXMgYmVlbiBzZXQsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMudXBkYXRlSWZWaXNpYmxlICYmIHRoaXMuc3ByaXRlLnZpc2libGUgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY3VycmVudEFuaW0gJiYgdGhpcy5jdXJyZW50QW5pbS51cGRhdGUoKSA9PT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5jdXJyZW50QW5pbS5jdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmN1cnJlbnRGcmFtZSA9IHRoaXMuY3VycmVudEZyYW1lOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGFuIGFuaW1hdGlvbiB0aGF0IHdhcyBwcmV2aW91c2x5IGFkZGVkIGJ5IG5hbWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjZ2V0QW5pbWF0aW9uCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGFuaW1hdGlvbiB0byBiZSByZXR1cm5lZCwgZS5nLiAiZmlyZSIuCiAgICAqIEByZXR1cm4ge1BoYXNlci5BbmltYXRpb259IFRoZSBBbmltYXRpb24gaW5zdGFuY2UsIGlmIGZvdW5kLCBvdGhlcndpc2UgbnVsbC4KICAgICovCiAgICBnZXRBbmltYXRpb246IGZ1bmN0aW9uIChuYW1lKSB7CgogICAgICAgIGlmICh0eXBlb2YgbmFtZSA9PSAnc3RyaW5nJykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9hbmltc1tuYW1lXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FuaW1zW25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZWZyZXNoZXMgdGhlIGN1cnJlbnQgZnJhbWUgZGF0YSBiYWNrIHRvIHRoZSBwYXJlbnQgU3ByaXRlIGFuZCBhbHNvIHJlc2V0cyB0aGUgdGV4dHVyZSBkYXRhLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI3JlZnJlc2hGcmFtZQogICAgKi8KICAgIHJlZnJlc2hGcmFtZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnNwcml0ZS5jdXJyZW50RnJhbWUgPSB0aGlzLmN1cnJlbnRGcmFtZTsKICAgICAgICB0aGlzLnNwcml0ZS5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBEZXN0cm95cyBhbGwgcmVmZXJlbmNlcyB0aGlzIEFuaW1hdGlvbk1hbmFnZXIgY29udGFpbnMuIFNldHMgdGhlIF9hbmltcyB0byBhIG5ldyBvYmplY3QgYW5kIG51bGxzIHRoZSBjdXJyZW50IGFuaW1hdGlvbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9hbmltcyA9IHt9OwogICAgICAgIHRoaXMuX2ZyYW1lRGF0YSA9IG51bGw7CiAgICAgICAgdGhpcy5fZnJhbWVJbmRleCA9IDA7CiAgICAgICAgdGhpcy5jdXJyZW50QW5pbSA9IG51bGw7CiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSBudWxsOwoKICAgIH0KCn07CgpQaGFzZXIuQW5pbWF0aW9uTWFuYWdlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlcjsKCi8qKgoqIEBuYW1lIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2ZyYW1lRGF0YQoqIEBwcm9wZXJ0eSB7UGhhc2VyLkZyYW1lRGF0YX0gZnJhbWVEYXRhIC0gVGhlIGN1cnJlbnQgYW5pbWF0aW9ucyBGcmFtZURhdGEuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQW5pbWF0aW9uTWFuYWdlci5wcm90b3R5cGUsICdmcmFtZURhdGEnLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ZyYW1lRGF0YTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjZnJhbWVUb3RhbAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcmFtZVRvdGFsIC0gVGhlIHRvdGFsIG51bWJlciBvZiBmcmFtZXMgaW4gdGhlIGN1cnJlbnRseSBsb2FkZWQgRnJhbWVEYXRhLCBvciAtMSBpZiBubyBGcmFtZURhdGEgaXMgbG9hZGVkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIucHJvdG90eXBlLCAnZnJhbWVUb3RhbCcsIHsKIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9mcmFtZURhdGEpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZnJhbWVEYXRhLnRvdGFsOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNwYXVzZWQKKiBAcHJvcGVydHkge2Jvb2xlYW59IHBhdXNlZCAtIEdldHMgYW5kIHNldHMgdGhlIHBhdXNlZCBzdGF0ZSBvZiB0aGUgY3VycmVudCBhbmltYXRpb24uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQW5pbWF0aW9uTWFuYWdlci5wcm90b3R5cGUsICdwYXVzZWQnLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRBbmltLmlzUGF1c2VkOwoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdGhpcy5jdXJyZW50QW5pbS5wYXVzZWQgPSB2YWx1ZTsKCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2ZyYW1lCiogQHByb3BlcnR5IHtudW1iZXJ9IGZyYW1lIC0gR2V0cyBvciBzZXRzIHRoZSBjdXJyZW50IGZyYW1lIGluZGV4IGFuZCB1cGRhdGVzIHRoZSBUZXh0dXJlIENhY2hlIGZvciBkaXNwbGF5LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIucHJvdG90eXBlLCAnZnJhbWUnLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmN1cnJlbnRGcmFtZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9mcmFtZUluZGV4OwogICAgICAgIH0KICAgICAgICAKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgJiYgdGhpcy5fZnJhbWVEYXRhICYmIHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZSh2YWx1ZSkgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZSh2YWx1ZSk7CiAgICAgICAgICAgIHRoaXMuX2ZyYW1lSW5kZXggPSB2YWx1ZTsKICAgICAgICAgICAgdGhpcy5zcHJpdGUuY3VycmVudEZyYW1lID0gdGhpcy5jdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2ZyYW1lTmFtZQoqIEBwcm9wZXJ0eSB7c3RyaW5nfSBmcmFtZU5hbWUgLSBHZXRzIG9yIHNldHMgdGhlIGN1cnJlbnQgZnJhbWUgbmFtZSBhbmQgdXBkYXRlcyB0aGUgVGV4dHVyZSBDYWNoZSBmb3IgZGlzcGxheS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5BbmltYXRpb25NYW5hZ2VyLnByb3RvdHlwZSwgJ2ZyYW1lTmFtZScsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuY3VycmVudEZyYW1lKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEZyYW1lLm5hbWU7CiAgICAgICAgfQoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgJiYgdGhpcy5fZnJhbWVEYXRhICYmIHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZUJ5TmFtZSh2YWx1ZSkgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZUJ5TmFtZSh2YWx1ZSk7CiAgICAgICAgICAgIHRoaXMuX2ZyYW1lSW5kZXggPSB0aGlzLmN1cnJlbnRGcmFtZS5pbmRleDsKICAgICAgICAgICAgdGhpcy5zcHJpdGUuY3VycmVudEZyYW1lID0gdGhpcy5jdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ0Nhbm5vdCBzZXQgZnJhbWVOYW1lOiAnICsgdmFsdWUpOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQW4gQW5pbWF0aW9uIGluc3RhbmNlIGNvbnRhaW5zIGEgc2luZ2xlIGFuaW1hdGlvbiBhbmQgdGhlIGNvbnRyb2xzIHRvIHBsYXkgaXQuCiogSXQgaXMgY3JlYXRlZCBieSB0aGUgQW5pbWF0aW9uTWFuYWdlciwgY29uc2lzdHMgb2YgQW5pbWF0aW9uLkZyYW1lIG9iamVjdHMgYW5kIGJlbG9uZ3MgdG8gYSBzaW5nbGUgR2FtZSBPYmplY3Qgc3VjaCBhcyBhIFNwcml0ZS4KKgoqIEBjbGFzcyBQaGFzZXIuQW5pbWF0aW9uCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gcGFyZW50IC0gQSByZWZlcmVuY2UgdG8gdGhlIG93bmVyIG9mIHRoaXMgQW5pbWF0aW9uLgoqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIHVuaXF1ZSBuYW1lIGZvciB0aGlzIGFuaW1hdGlvbiwgdXNlZCBpbiBwbGF5YmFjayBjb21tYW5kcy4KKiBAcGFyYW0ge1BoYXNlci5GcmFtZURhdGF9IGZyYW1lRGF0YSAtIFRoZSBGcmFtZURhdGEgb2JqZWN0IHRoYXQgY29udGFpbnMgYWxsIGZyYW1lcyB1c2VkIGJ5IHRoaXMgQW5pbWF0aW9uLgoqIEBwYXJhbSB7KEFycmF5LjxudW1iZXI+fEFycmF5LjxzdHJpbmc+KX0gZnJhbWVzIC0gQW4gYXJyYXkgb2YgbnVtYmVycyBvciBzdHJpbmdzIGluZGljYXRpbmcgd2hpY2ggZnJhbWVzIHRvIHBsYXkgaW4gd2hpY2ggb3JkZXIuCiogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIHRpbWUgYmV0d2VlbiBlYWNoIGZyYW1lIG9mIHRoZSBhbmltYXRpb24sIGdpdmVuIGluIG1zLgoqIEBwYXJhbSB7Ym9vbGVhbn0gbG9vcGVkIC0gU2hvdWxkIHRoaXMgYW5pbWF0aW9uIGxvb3Agb3IgcGxheSB0aHJvdWdoIG9uY2UuCiovClBoYXNlci5BbmltYXRpb24gPSBmdW5jdGlvbiAoZ2FtZSwgcGFyZW50LCBuYW1lLCBmcmFtZURhdGEsIGZyYW1lcywgZGVsYXksIGxvb3BlZCkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU3ByaXRlfSBfcGFyZW50IC0gQSByZWZlcmVuY2UgdG8gdGhlIHBhcmVudCBTcHJpdGUgdGhhdCBvd25zIHRoaXMgQW5pbWF0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3BhcmVudCA9IHBhcmVudDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuRnJhbWVEYXRhfSBfZnJhbWVEYXRhIC0gVGhlIEZyYW1lRGF0YSB0aGUgQW5pbWF0aW9uIHVzZXMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZnJhbWVEYXRhID0gZnJhbWVEYXRhOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIFRoZSB1c2VyIGRlZmluZWQgbmFtZSBnaXZlbiB0byB0aGlzIEFuaW1hdGlvbi4KICAgICovCiAgICB0aGlzLm5hbWUgPSBuYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBfZnJhbWVzCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZnJhbWVzID0gW107CiAgICB0aGlzLl9mcmFtZXMgPSB0aGlzLl9mcmFtZXMuY29uY2F0KGZyYW1lcyk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkZWxheSAtIFRoZSBkZWxheSBpbiBtcyBiZXR3ZWVuIGVhY2ggZnJhbWUgb2YgdGhlIEFuaW1hdGlvbi4KICAgICovCiAgICB0aGlzLmRlbGF5ID0gMTAwMCAvIGRlbGF5OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGxvb3BlZCAtIFRoZSBsb29wIHN0YXRlIG9mIHRoZSBBbmltYXRpb24uCiAgICAqLwogICAgdGhpcy5sb29wZWQgPSBsb29wZWQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0ga2lsbE9uQ29tcGxldGUgLSBTaG91bGQgdGhlIHBhcmVudCBvZiB0aGlzIEFuaW1hdGlvbiBiZSBraWxsZWQgd2hlbiB0aGUgYW5pbWF0aW9uIGNvbXBsZXRlcz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmtpbGxPbkNvbXBsZXRlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNGaW5pc2hlZCAtIFRoZSBmaW5pc2hlZCBzdGF0ZSBvZiB0aGUgQW5pbWF0aW9uLiBTZXQgdG8gdHJ1ZSBvbmNlIHBsYXliYWNrIGNvbXBsZXRlcywgZmFsc2UgZHVyaW5nIHBsYXliYWNrLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNGaW5pc2hlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzUGxheWluZyAtIFRoZSBwbGF5aW5nIHN0YXRlIG9mIHRoZSBBbmltYXRpb24uIFNldCB0byBmYWxzZSBvbmNlIHBsYXliYWNrIGNvbXBsZXRlcywgdHJ1ZSBkdXJpbmcgcGxheWJhY2suCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc1BhdXNlZCAtIFRoZSBwYXVzZWQgc3RhdGUgb2YgdGhlIEFuaW1hdGlvbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzUGF1c2VkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX3BhdXNlU3RhcnRUaW1lIC0gVGhlIHRpbWUgdGhlIGFuaW1hdGlvbiBwYXVzZWQuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fcGF1c2VTdGFydFRpbWUgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2ZyYW1lSW5kZXgKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9mcmFtZUluZGV4ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9mcmFtZURpZmYKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9mcmFtZURpZmYgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2ZyYW1lU2tpcAogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX2ZyYW1lU2tpcCA9IDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkZyYW1lfSBjdXJyZW50RnJhbWUgLSBUaGUgY3VycmVudGx5IGRpc3BsYXllZCBmcmFtZSBvZiB0aGUgQW5pbWF0aW9uLgogICAgKi8KICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5fZnJhbWVEYXRhLmdldEZyYW1lKHRoaXMuX2ZyYW1lc1t0aGlzLl9mcmFtZUluZGV4XSk7CiAgICAKfTsKClBoYXNlci5BbmltYXRpb24ucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBQbGF5cyB0aGlzIGFuaW1hdGlvbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uI3BsYXkKICAgICogQG1lbWJlcm9mIFBoYXNlci5BbmltYXRpb24KICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcmFtZVJhdGU9bnVsbF0gLSBUaGUgZnJhbWVyYXRlIHRvIHBsYXkgdGhlIGFuaW1hdGlvbiBhdC4gVGhlIHNwZWVkIGlzIGdpdmVuIGluIGZyYW1lcyBwZXIgc2Vjb25kLiBJZiBub3QgcHJvdmlkZWQgdGhlIHByZXZpb3VzbHkgc2V0IGZyYW1lUmF0ZSBvZiB0aGUgQW5pbWF0aW9uIGlzIHVzZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gU2hvdWxkIHRoZSBhbmltYXRpb24gYmUgbG9vcGVkIGFmdGVyIHBsYXliYWNrLiBJZiBub3QgcHJvdmlkZWQgdGhlIHByZXZpb3VzbHkgc2V0IGxvb3AgdmFsdWUgb2YgdGhlIEFuaW1hdGlvbiBpcyB1c2VkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtraWxsT25Db21wbGV0ZT1mYWxzZV0gLSBJZiBzZXQgdG8gdHJ1ZSB3aGVuIHRoZSBhbmltYXRpb24gY29tcGxldGVzIChvbmx5IGhhcHBlbnMgaWYgbG9vcD1mYWxzZSkgdGhlIHBhcmVudCBTcHJpdGUgd2lsbCBiZSBraWxsZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5BbmltYXRpb259IC0gQSByZWZlcmVuY2UgdG8gdGhpcyBBbmltYXRpb24gaW5zdGFuY2UuCiAgICAqLwogICAgcGxheTogZnVuY3Rpb24gKGZyYW1lUmF0ZSwgbG9vcCwga2lsbE9uQ29tcGxldGUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBmcmFtZVJhdGUgPT09ICdudW1iZXInKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIElmIHRoZXkgc2V0IGEgbmV3IGZyYW1lIHJhdGUgdGhlbiB1c2UgaXQsIG90aGVyd2lzZSB1c2UgdGhlIG9uZSBzZXQgb24gY3JlYXRpb24KICAgICAgICAgICAgdGhpcy5kZWxheSA9IDEwMDAgLyBmcmFtZVJhdGU7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGxvb3AgPT09ICdib29sZWFuJykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBJZiB0aGV5IHNldCBhIG5ldyBsb29wIHZhbHVlIHRoZW4gdXNlIGl0LCBvdGhlcndpc2UgdXNlIHRoZSBvbmUgc2V0IG9uIGNyZWF0aW9uCiAgICAgICAgICAgIHRoaXMubG9vcGVkID0gbG9vcDsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2Yga2lsbE9uQ29tcGxldGUgIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFJlbW92ZSB0aGUgcGFyZW50IHNwcml0ZSBvbmNlIHRoZSBhbmltYXRpb24gaGFzIGZpbmlzaGVkPwogICAgICAgICAgICB0aGlzLmtpbGxPbkNvbXBsZXRlID0ga2lsbE9uQ29tcGxldGU7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmlzUGxheWluZyA9IHRydWU7CiAgICAgICAgdGhpcy5pc0ZpbmlzaGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTsKCiAgICAgICAgdGhpcy5fdGltZUxhc3RGcmFtZSA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICB0aGlzLl90aW1lTmV4dEZyYW1lID0gdGhpcy5nYW1lLnRpbWUubm93ICsgdGhpcy5kZWxheTsKCiAgICAgICAgdGhpcy5fZnJhbWVJbmRleCA9IDA7CgogICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5fZnJhbWVEYXRhLmdldEZyYW1lKHRoaXMuX2ZyYW1lc1t0aGlzLl9mcmFtZUluZGV4XSk7CiAgICAgICAgdGhpcy5fcGFyZW50LnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwoKICAgICAgICBpZiAodGhpcy5fcGFyZW50LmV2ZW50cykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BhcmVudC5ldmVudHMub25BbmltYXRpb25TdGFydC5kaXNwYXRjaCh0aGlzLl9wYXJlbnQsIHRoaXMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGlzIGFuaW1hdGlvbiBiYWNrIHRvIHRoZSBmaXJzdCBmcmFtZSBhbmQgcmVzdGFydHMgdGhlIGFuaW1hdGlvbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uI3Jlc3RhcnQKICAgICogQG1lbWJlcm9mIFBoYXNlci5BbmltYXRpb24KICAgICovCiAgICByZXN0YXJ0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuaXNQbGF5aW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLmlzRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLnBhdXNlZCA9IGZhbHNlOwoKICAgICAgICB0aGlzLl90aW1lTGFzdEZyYW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgIHRoaXMuX3RpbWVOZXh0RnJhbWUgPSB0aGlzLmdhbWUudGltZS5ub3cgKyB0aGlzLmRlbGF5OwoKICAgICAgICB0aGlzLl9mcmFtZUluZGV4ID0gMDsKCiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodGhpcy5fZnJhbWVzW3RoaXMuX2ZyYW1lSW5kZXhdKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wcyBwbGF5YmFjayBvZiB0aGlzIGFuaW1hdGlvbiBhbmQgc2V0IGl0IHRvIGEgZmluaXNoZWQgc3RhdGUuIElmIGEgcmVzZXRGcmFtZSBpcyBwcm92aWRlZCBpdCB3aWxsIHN0b3AgcGxheWJhY2sgYW5kIHNldCBmcmFtZSB0byB0aGUgZmlyc3QgaW4gdGhlIGFuaW1hdGlvbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uI3N0b3AKICAgICogQG1lbWJlcm9mIFBoYXNlci5BbmltYXRpb24KICAgICogQHBhcmFtIHtib29sZWFufSBbcmVzZXRGcmFtZT1mYWxzZV0gLSBJZiB0cnVlIGFmdGVyIHRoZSBhbmltYXRpb24gc3RvcHMgdGhlIGN1cnJlbnRGcmFtZSB2YWx1ZSB3aWxsIGJlIHNldCB0byB0aGUgZmlyc3QgZnJhbWUgaW4gdGhpcyBhbmltYXRpb24uCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKHJlc2V0RnJhbWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiByZXNldEZyYW1lID09PSAndW5kZWZpbmVkJykgeyByZXNldEZyYW1lID0gZmFsc2U7IH0KCiAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLmlzRmluaXNoZWQgPSB0cnVlOwogICAgICAgIHRoaXMucGF1c2VkID0gZmFsc2U7CgogICAgICAgIGlmIChyZXNldEZyYW1lKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodGhpcy5fZnJhbWVzWzBdKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlcyB0aGlzIGFuaW1hdGlvbi4gQ2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgdGhlIEFuaW1hdGlvbk1hbmFnZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbiN1cGRhdGUKICAgICogQG1lbWJlcm9mIFBoYXNlci5BbmltYXRpb24KICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuaXNQYXVzZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5pc1BsYXlpbmcgPT09IHRydWUgJiYgdGhpcy5nYW1lLnRpbWUubm93ID49IHRoaXMuX3RpbWVOZXh0RnJhbWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9mcmFtZVNraXAgPSAxOwoKICAgICAgICAgICAgLy8gIExhZ2dpbmc/CiAgICAgICAgICAgIHRoaXMuX2ZyYW1lRGlmZiA9IHRoaXMuZ2FtZS50aW1lLm5vdyAtIHRoaXMuX3RpbWVOZXh0RnJhbWU7CgogICAgICAgICAgICB0aGlzLl90aW1lTGFzdEZyYW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwoKICAgICAgICAgICAgaWYgKHRoaXMuX2ZyYW1lRGlmZiA+IHRoaXMuZGVsYXkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBXZSBuZWVkIHRvIHNraXAgYSBmcmFtZSwgd29yayBvdXQgaG93IG1hbnkKICAgICAgICAgICAgICAgIHRoaXMuX2ZyYW1lU2tpcCA9IE1hdGguZmxvb3IodGhpcy5fZnJhbWVEaWZmIC8gdGhpcy5kZWxheSk7CgogICAgICAgICAgICAgICAgdGhpcy5fZnJhbWVEaWZmIC09ICh0aGlzLl9mcmFtZVNraXAgKiB0aGlzLmRlbGF5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIEFuZCB3aGF0J3MgbGVmdCBub3c/CiAgICAgICAgICAgIHRoaXMuX3RpbWVOZXh0RnJhbWUgPSB0aGlzLmdhbWUudGltZS5ub3cgKyAodGhpcy5kZWxheSAtIHRoaXMuX2ZyYW1lRGlmZik7CgogICAgICAgICAgICB0aGlzLl9mcmFtZUluZGV4ICs9IHRoaXMuX2ZyYW1lU2tpcDsKCiAgICAgICAgICAgIGlmICh0aGlzLl9mcmFtZUluZGV4ID49IHRoaXMuX2ZyYW1lcy5sZW5ndGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb3BlZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9mcmFtZUluZGV4ICU9IHRoaXMuX2ZyYW1lcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodGhpcy5fZnJhbWVzW3RoaXMuX2ZyYW1lSW5kZXhdKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEZyYW1lKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFyZW50LnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJlbnQuZXZlbnRzLm9uQW5pbWF0aW9uTG9vcC5kaXNwYXRjaCh0aGlzLl9wYXJlbnQsIHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMub25Db21wbGV0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodGhpcy5fZnJhbWVzW3RoaXMuX2ZyYW1lSW5kZXhdKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RnJhbWUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFyZW50LnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGVhbnMgdXAgdGhpcyBhbmltYXRpb24gcmVhZHkgZm9yIGRlbGV0aW9uLiBOdWxscyBhbGwgdmFsdWVzIGFuZCByZWZlcmVuY2VzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb24jZGVzdHJveQogICAgKiBAbWVtYmVyb2YgUGhhc2VyLkFuaW1hdGlvbgogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5nYW1lID0gbnVsbDsKICAgICAgICB0aGlzLl9wYXJlbnQgPSBudWxsOwogICAgICAgIHRoaXMuX2ZyYW1lcyA9IG51bGw7CiAgICAgICAgdGhpcy5fZnJhbWVEYXRhID0gbnVsbDsKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IG51bGw7CiAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgaW50ZXJuYWxseSB3aGVuIHRoZSBhbmltYXRpb24gZmluaXNoZXMgcGxheWJhY2suIFNldHMgdGhlIGlzUGxheWluZyBhbmQgaXNGaW5pc2hlZCBzdGF0ZXMgYW5kIGRpc3BhdGNoZXMgdGhlIG9uQW5pbWF0aW9uQ29tcGxldGUgZXZlbnQgaWYgaXQgZXhpc3RzIG9uIHRoZSBwYXJlbnQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbiNvbkNvbXBsZXRlCiAgICAqIEBtZW1iZXJvZiBQaGFzZXIuQW5pbWF0aW9uCiAgICAqLwogICAgb25Db21wbGV0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmlzUGxheWluZyA9IGZhbHNlOwogICAgICAgIHRoaXMuaXNGaW5pc2hlZCA9IHRydWU7CiAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTsKCiAgICAgICAgaWYgKHRoaXMuX3BhcmVudC5ldmVudHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wYXJlbnQuZXZlbnRzLm9uQW5pbWF0aW9uQ29tcGxldGUuZGlzcGF0Y2godGhpcy5fcGFyZW50LCB0aGlzKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmtpbGxPbkNvbXBsZXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcGFyZW50LmtpbGwoKTsKICAgICAgICB9CgogICAgfQoKfTsKClBoYXNlci5BbmltYXRpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkFuaW1hdGlvbjsKCi8qKgoqIEBuYW1lIFBoYXNlci5BbmltYXRpb24jcGF1c2VkCiogQHByb3BlcnR5IHtib29sZWFufSBwYXVzZWQgLSBHZXRzIGFuZCBzZXRzIHRoZSBwYXVzZWQgc3RhdGUgb2YgdGhpcyBBbmltYXRpb24uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQW5pbWF0aW9uLnByb3RvdHlwZSwgJ3BhdXNlZCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuaXNQYXVzZWQ7CgogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICB0aGlzLmlzUGF1c2VkID0gdmFsdWU7CgogICAgICAgIGlmICh2YWx1ZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBQYXVzZWQKICAgICAgICAgICAgdGhpcy5fcGF1c2VTdGFydFRpbWUgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBVbi1wYXVzZWQKICAgICAgICAgICAgaWYgKHRoaXMuaXNQbGF5aW5nKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl90aW1lTmV4dEZyYW1lID0gdGhpcy5nYW1lLnRpbWUubm93ICsgdGhpcy5kZWxheTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5BbmltYXRpb24jZnJhbWVUb3RhbAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcmFtZVRvdGFsIC0gVGhlIHRvdGFsIG51bWJlciBvZiBmcmFtZXMgaW4gdGhlIGN1cnJlbnRseSBsb2FkZWQgRnJhbWVEYXRhLCBvciAtMSBpZiBubyBGcmFtZURhdGEgaXMgbG9hZGVkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbi5wcm90b3R5cGUsICdmcmFtZVRvdGFsJywgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9mcmFtZXMubGVuZ3RoOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uI2ZyYW1lCiogQHByb3BlcnR5IHtudW1iZXJ9IGZyYW1lIC0gR2V0cyBvciBzZXRzIHRoZSBjdXJyZW50IGZyYW1lIGluZGV4IGFuZCB1cGRhdGVzIHRoZSBUZXh0dXJlIENhY2hlIGZvciBkaXNwbGF5LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbi5wcm90b3R5cGUsICdmcmFtZScsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuY3VycmVudEZyYW1lICE9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEZyYW1lLmluZGV4OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZnJhbWVJbmRleDsKICAgICAgICB9CgogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZSh2YWx1ZSk7CgogICAgICAgIGlmICh0aGlzLmN1cnJlbnRGcmFtZSAhPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ZyYW1lSW5kZXggPSB2YWx1ZTsKICAgICAgICAgICAgdGhpcy5fcGFyZW50LnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIFJlYWxseSBoYW5keSBmdW5jdGlvbiBmb3Igd2hlbiB5b3UgYXJlIGNyZWF0aW5nIGFycmF5cyBvZiBhbmltYXRpb24gZGF0YSBidXQgaXQncyB1c2luZyBmcmFtZSBuYW1lcyBhbmQgbm90IG51bWJlcnMuCiogRm9yIGV4YW1wbGUgaW1hZ2luZSB5b3UndmUgZ290IDMwIGZyYW1lcyBuYW1lZDogJ2V4cGxvc2lvbl8wMDAxLWxhcmdlJyB0byAnZXhwbG9zaW9uXzAwMzAtbGFyZ2UnCiogWW91IGNvdWxkIHVzZSB0aGlzIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIHRob3NlIGJ5IGRvaW5nOiBQaGFzZXIuQW5pbWF0aW9uLmdlbmVyYXRlRnJhbWVOYW1lcygnZXhwbG9zaW9uXycsIDEsIDMwLCAnLWxhcmdlJywgNCk7CioKKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb24uZ2VuZXJhdGVGcmFtZU5hbWVzCiogQHBhcmFtIHtzdHJpbmd9IHByZWZpeCAtIFRoZSBzdGFydCBvZiB0aGUgZmlsZW5hbWUuIElmIHRoZSBmaWxlbmFtZSB3YXMgJ2V4cGxvc2lvbl8wMDAxLWxhcmdlJyB0aGUgcHJlZml4IHdvdWxkIGJlICdleHBsb3Npb25fJy4KKiBAcGFyYW0ge251bWJlcn0gc3RhcnQgLSBUaGUgbnVtYmVyIHRvIHN0YXJ0IHNlcXVlbnRpYWxseSBjb3VudGluZyBmcm9tLiBJZiB5b3VyIGZyYW1lcyBhcmUgbmFtZWQgJ2V4cGxvc2lvbl8wMDAxJyB0byAnZXhwbG9zaW9uXzAwMzQnIHRoZSBzdGFydCBpcyAxLgoqIEBwYXJhbSB7bnVtYmVyfSBzdG9wIC0gVGhlIG51bWJlciB0byBjb3VudCB0by4gSWYgeW91ciBmcmFtZXMgYXJlIG5hbWVkICdleHBsb3Npb25fMDAwMScgdG8gJ2V4cGxvc2lvbl8wMDM0JyB0aGUgc3RvcCB2YWx1ZSBpcyAzNC4KKiBAcGFyYW0ge3N0cmluZ30gW3N1ZmZpeD0nJ10gLSBUaGUgZW5kIG9mIHRoZSBmaWxlbmFtZS4gSWYgdGhlIGZpbGVuYW1lIHdhcyAnZXhwbG9zaW9uXzAwMDEtbGFyZ2UnIHRoZSBwcmVmaXggd291bGQgYmUgJy1sYXJnZScuCiogQHBhcmFtIHtudW1iZXJ9IFt6ZXJvUGFkPTBdIC0gVGhlIG51bWJlciBvZiB6ZXJvZXMgdG8gcGFkIHRoZSBtaW4gYW5kIG1heCB2YWx1ZXMgd2l0aC4gSWYgeW91ciBmcmFtZXMgYXJlIG5hbWVkICdleHBsb3Npb25fMDAwMScgdG8gJ2V4cGxvc2lvbl8wMDM0JyB0aGVuIHRoZSB6ZXJvUGFkIGlzIDQuCiovClBoYXNlci5BbmltYXRpb24uZ2VuZXJhdGVGcmFtZU5hbWVzID0gZnVuY3Rpb24gKHByZWZpeCwgc3RhcnQsIHN0b3AsIHN1ZmZpeCwgemVyb1BhZCkgewoKICAgIGlmICh0eXBlb2Ygc3VmZml4ID09ICd1bmRlZmluZWQnKSB7IHN1ZmZpeCA9ICcnOyB9CgogICAgdmFyIG91dHB1dCA9IFtdOwogICAgdmFyIGZyYW1lID0gJyc7CgogICAgaWYgKHN0YXJ0IDwgc3RvcCkKICAgIHsKICAgICAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPD0gc3RvcDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB6ZXJvUGFkID09ICdudW1iZXInKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgc3RyLCBsZW4sIHBhZCwgZGlyCiAgICAgICAgICAgICAgICBmcmFtZSA9IFBoYXNlci5VdGlscy5wYWQoaS50b1N0cmluZygpLCB6ZXJvUGFkLCAnMCcsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZnJhbWUgPSBpLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZyYW1lID0gcHJlZml4ICsgZnJhbWUgKyBzdWZmaXg7CgogICAgICAgICAgICBvdXRwdXQucHVzaChmcmFtZSk7CiAgICAgICAgfQogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA+PSBzdG9wOyBpLS0pCiAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHplcm9QYWQgPT0gJ251bWJlcicpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBzdHIsIGxlbiwgcGFkLCBkaXIKICAgICAgICAgICAgICAgIGZyYW1lID0gUGhhc2VyLlV0aWxzLnBhZChpLnRvU3RyaW5nKCksIHplcm9QYWQsICcwJywgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmcmFtZSA9IGkudG9TdHJpbmcoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnJhbWUgPSBwcmVmaXggKyBmcmFtZSArIHN1ZmZpeDsKCiAgICAgICAgICAgIG91dHB1dC5wdXNoKGZyYW1lKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIG91dHB1dDsKCn0KCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgRnJhbWUgaXMgYSBzaW5nbGUgZnJhbWUgb2YgYW4gYW5pbWF0aW9uIGFuZCBpcyBwYXJ0IG9mIGEgRnJhbWVEYXRhIGNvbGxlY3Rpb24uCioKKiBAY2xhc3MgUGhhc2VyLkZyYW1lCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoaXMgRnJhbWUgd2l0aGluIHRoZSBGcmFtZURhdGEgc2V0IGl0IGlzIGJlaW5nIGFkZGVkIHRvLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZnJhbWUgd2l0aGluIHRoZSB0ZXh0dXJlIGltYWdlLgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZnJhbWUgd2l0aGluIHRoZSB0ZXh0dXJlIGltYWdlLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFdpZHRoIG9mIHRoZSBmcmFtZSB3aXRoaW4gdGhlIHRleHR1cmUgaW1hZ2UuCiogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIEhlaWdodCBvZiB0aGUgZnJhbWUgd2l0aGluIHRoZSB0ZXh0dXJlIGltYWdlLgoqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGZyYW1lLiBJbiBUZXh0dXJlIEF0bGFzIGRhdGEgdGhpcyBpcyB1c3VhbGx5IHNldCB0byB0aGUgZmlsZW5hbWUuCiogQHBhcmFtIHtzdHJpbmd9IHV1aWQgLSBJbnRlcm5hbCBVVUlEIGtleS4KKi8KUGhhc2VyLkZyYW1lID0gZnVuY3Rpb24gKGluZGV4LCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBuYW1lLCB1dWlkKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGlzIEZyYW1lIHdpdGhpbiB0aGUgRnJhbWVEYXRhIHNldCBpdCBpcyBiZWluZyBhZGRlZCB0by4KICAgICovCiAgICB0aGlzLmluZGV4ID0gaW5kZXg7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geCAtIFggcG9zaXRpb24gd2l0aGluIHRoZSBpbWFnZSB0byBjdXQgZnJvbS4KICAgICovCiAgICB0aGlzLnggPSB4OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geSAtIFkgcG9zaXRpb24gd2l0aGluIHRoZSBpbWFnZSB0byBjdXQgZnJvbS4KICAgICovCiAgICB0aGlzLnkgPSB5OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBXaWR0aCBvZiB0aGUgZnJhbWUuCiAgICAqLwogICAgdGhpcy53aWR0aCA9IHdpZHRoOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gSGVpZ2h0IG9mIHRoZSBmcmFtZS4KICAgICovCiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBVc2VmdWwgZm9yIFRleHR1cmUgQXRsYXMgZmlsZXMgKGlzIHNldCB0byB0aGUgZmlsZW5hbWUgdmFsdWUpLgogICAgKi8KICAgIHRoaXMubmFtZSA9IG5hbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB1dWlkIC0gQSBsaW5rIHRvIHRoZSBQSVhJLlRleHR1cmVDYWNoZSBlbnRyeS4KICAgICovCiAgICB0aGlzLnV1aWQgPSB1dWlkOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY2VudGVyWCAtIENlbnRlciBYIHBvc2l0aW9uIHdpdGhpbiB0aGUgaW1hZ2UgdG8gY3V0IGZyb20uCiAgICAqLwogICAgdGhpcy5jZW50ZXJYID0gTWF0aC5mbG9vcih3aWR0aCAvIDIpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY2VudGVyWSAtIENlbnRlciBZIHBvc2l0aW9uIHdpdGhpbiB0aGUgaW1hZ2UgdG8gY3V0IGZyb20uCiAgICAqLwogICAgdGhpcy5jZW50ZXJZID0gTWF0aC5mbG9vcihoZWlnaHQgLyAyKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGRpc3RhbmNlIC0gVGhlIGRpc3RhbmNlIGZyb20gdGhlIHRvcCBsZWZ0IHRvIHRoZSBib3R0b20tcmlnaHQgb2YgdGhpcyBGcmFtZS4KICAgICovCiAgICB0aGlzLmRpc3RhbmNlID0gUGhhc2VyLk1hdGguZGlzdGFuY2UoMCwgMCwgd2lkdGgsIGhlaWdodCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcm90YXRlZCAtIFJvdGF0ZWQ/IChub3QgeWV0IGltcGxlbWVudGVkKQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucm90YXRlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gcm90YXRpb25EaXJlY3Rpb24gLSBFaXRoZXIgJ2N3JyBvciAnY2N3Jywgcm90YXRpb24gaXMgYWx3YXlzIDkwIGRlZ3JlZXMuCiAgICAqIEBkZWZhdWx0ICdjdycKICAgICovCiAgICB0aGlzLnJvdGF0aW9uRGlyZWN0aW9uID0gJ2N3JzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB0cmltbWVkIC0gV2FzIGl0IHRyaW1tZWQgd2hlbiBwYWNrZWQ/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50cmltbWVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzb3VyY2VTaXplVyAtIFdpZHRoIG9mIHRoZSBvcmlnaW5hbCBzcHJpdGUuCiAgICAqLwogICAgdGhpcy5zb3VyY2VTaXplVyA9IHdpZHRoOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc291cmNlU2l6ZUggLSBIZWlnaHQgb2YgdGhlIG9yaWdpbmFsIHNwcml0ZS4KICAgICovCiAgICB0aGlzLnNvdXJjZVNpemVIID0gaGVpZ2h0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc3ByaXRlU291cmNlU2l6ZVggLSBYIHBvc2l0aW9uIG9mIHRoZSB0cmltbWVkIHNwcml0ZSBpbnNpZGUgb3JpZ2luYWwgc3ByaXRlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc3ByaXRlU291cmNlU2l6ZVggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc3ByaXRlU291cmNlU2l6ZVkgLSBZIHBvc2l0aW9uIG9mIHRoZSB0cmltbWVkIHNwcml0ZSBpbnNpZGUgb3JpZ2luYWwgc3ByaXRlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc3ByaXRlU291cmNlU2l6ZVkgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc3ByaXRlU291cmNlU2l6ZVcgLSBXaWR0aCBvZiB0aGUgdHJpbW1lZCBzcHJpdGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zcHJpdGVTb3VyY2VTaXplVyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzcHJpdGVTb3VyY2VTaXplSCAtIEhlaWdodCBvZiB0aGUgdHJpbW1lZCBzcHJpdGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zcHJpdGVTb3VyY2VTaXplSCA9IDA7Cgp9OwoKUGhhc2VyLkZyYW1lLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogSWYgdGhlIGZyYW1lIHdhcyB0cmltbWVkIHdoZW4gYWRkZWQgdG8gdGhlIFRleHR1cmUgQXRsYXMgdGhpcyByZWNvcmRzIHRoZSB0cmltIGFuZCBzb3VyY2UgZGF0YS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuRnJhbWUjc2V0VHJpbQogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHRyaW1tZWQgLSBJZiB0aGlzIGZyYW1lIHdhcyB0cmltbWVkIG9yIG5vdC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGFjdHVhbFdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBmcmFtZSBiZWZvcmUgYmVpbmcgdHJpbW1lZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGFjdHVhbEhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIGZyYW1lIGJlZm9yZSBiZWluZyB0cmltbWVkLgogICAgKiBAcGFyYW0ge251bWJlcn0gZGVzdFggLSBUaGUgZGVzdGluYXRpb24gWCBwb3NpdGlvbiBvZiB0aGUgdHJpbW1lZCBmcmFtZSBmb3IgZGlzcGxheS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGRlc3RZIC0gVGhlIGRlc3RpbmF0aW9uIFkgcG9zaXRpb24gb2YgdGhlIHRyaW1tZWQgZnJhbWUgZm9yIGRpc3BsYXkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkZXN0V2lkdGggLSBUaGUgZGVzdGluYXRpb24gd2lkdGggb2YgdGhlIHRyaW1tZWQgZnJhbWUgZm9yIGRpc3BsYXkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkZXN0SGVpZ2h0IC0gVGhlIGRlc3RpbmF0aW9uIGhlaWdodCBvZiB0aGUgdHJpbW1lZCBmcmFtZSBmb3IgZGlzcGxheS4KICAgICovCiAgICBzZXRUcmltOiBmdW5jdGlvbiAodHJpbW1lZCwgYWN0dWFsV2lkdGgsIGFjdHVhbEhlaWdodCwgZGVzdFgsIGRlc3RZLCBkZXN0V2lkdGgsIGRlc3RIZWlnaHQpIHsKCiAgICAgICAgdGhpcy50cmltbWVkID0gdHJpbW1lZDsKCiAgICAgICAgaWYgKHRyaW1tZWQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndpZHRoID0gYWN0dWFsV2lkdGg7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gYWN0dWFsSGVpZ2h0OwogICAgICAgICAgICB0aGlzLnNvdXJjZVNpemVXID0gYWN0dWFsV2lkdGg7CiAgICAgICAgICAgIHRoaXMuc291cmNlU2l6ZUggPSBhY3R1YWxIZWlnaHQ7CiAgICAgICAgICAgIHRoaXMuY2VudGVyWCA9IE1hdGguZmxvb3IoYWN0dWFsV2lkdGggLyAyKTsKICAgICAgICAgICAgdGhpcy5jZW50ZXJZID0gTWF0aC5mbG9vcihhY3R1YWxIZWlnaHQgLyAyKTsKICAgICAgICAgICAgdGhpcy5zcHJpdGVTb3VyY2VTaXplWCA9IGRlc3RYOwogICAgICAgICAgICB0aGlzLnNwcml0ZVNvdXJjZVNpemVZID0gZGVzdFk7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlU291cmNlU2l6ZVcgPSBkZXN0V2lkdGg7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlU291cmNlU2l6ZUggPSBkZXN0SGVpZ2h0OwogICAgICAgIH0KCiAgICB9Cgp9OwoKUGhhc2VyLkZyYW1lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5GcmFtZTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEZyYW1lRGF0YSBpcyBhIGNvbnRhaW5lciBmb3IgRnJhbWUgb2JqZWN0cywgd2hpY2ggYXJlIHRoZSBpbnRlcm5hbCByZXByZXNlbnRhdGlvbiBvZiBhbmltYXRpb24gZGF0YSBpbiBQaGFzZXIuCioKKiBAY2xhc3MgUGhhc2VyLkZyYW1lRGF0YQoqIEBjb25zdHJ1Y3RvcgoqLwpQaGFzZXIuRnJhbWVEYXRhID0gZnVuY3Rpb24gKCkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0FycmF5fSBfZnJhbWVzIC0gTG9jYWwgYXJyYXkgb2YgZnJhbWVzLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2ZyYW1lcyA9IFtdOwoKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBcnJheX0gX2ZyYW1lTmFtZXMgLSBMb2NhbCBhcnJheSBvZiBmcmFtZSBuYW1lcyBmb3IgbmFtZSB0byBpbmRleCBjb252ZXJzaW9ucy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9mcmFtZU5hbWVzID0gW107Cgp9OwoKUGhhc2VyLkZyYW1lRGF0YS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEFkZHMgYSBuZXcgRnJhbWUgdG8gdGhpcyBGcmFtZURhdGEgY29sbGVjdGlvbi4gVHlwaWNhbGx5IGNhbGxlZCBieSB0aGUgQW5pbWF0aW9uLlBhcnNlciBhbmQgbm90IGRpcmVjdGx5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5GcmFtZURhdGEjYWRkRnJhbWUKICAgICogQHBhcmFtIHtQaGFzZXIuRnJhbWV9IGZyYW1lIC0gVGhlIGZyYW1lIHRvIGFkZCB0byB0aGlzIEZyYW1lRGF0YSBzZXQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZX0gVGhlIGZyYW1lIHRoYXQgd2FzIGp1c3QgYWRkZWQuCiAgICAqLwogICAgYWRkRnJhbWU6IGZ1bmN0aW9uIChmcmFtZSkgewoKICAgICAgICBmcmFtZS5pbmRleCA9IHRoaXMuX2ZyYW1lcy5sZW5ndGg7CgogICAgICAgIHRoaXMuX2ZyYW1lcy5wdXNoKGZyYW1lKTsKCiAgICAgICAgaWYgKGZyYW1lLm5hbWUgIT09ICcnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZnJhbWVOYW1lc1tmcmFtZS5uYW1lXSA9IGZyYW1lLmluZGV4OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZyYW1lOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBhIEZyYW1lIGJ5IGl0cyBudW1lcmljYWwgaW5kZXguCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lRGF0YSNnZXRGcmFtZQogICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhlIGZyYW1lIHlvdSB3YW50IHRvIGdldC4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lfSBUaGUgZnJhbWUsIGlmIGZvdW5kLgogICAgKi8KICAgIGdldEZyYW1lOiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ZyYW1lcy5sZW5ndGggPiBpbmRleCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9mcmFtZXNbaW5kZXhdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgRnJhbWUgYnkgaXRzIGZyYW1lIG5hbWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lRGF0YSNnZXRGcmFtZUJ5TmFtZQogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBmcmFtZSB5b3Ugd2FudCB0byBnZXQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZX0gVGhlIGZyYW1lLCBpZiBmb3VuZC4KICAgICovCiAgICBnZXRGcmFtZUJ5TmFtZTogZnVuY3Rpb24gKG5hbWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9mcmFtZU5hbWVzW25hbWVdID09PSAnbnVtYmVyJykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9mcmFtZXNbdGhpcy5fZnJhbWVOYW1lc1tuYW1lXV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayBpZiB0aGVyZSBpcyBhIEZyYW1lIHdpdGggdGhlIGdpdmVuIG5hbWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lRGF0YSNjaGVja0ZyYW1lTmFtZQogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBmcmFtZSB5b3Ugd2FudCB0byBjaGVjay4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZnJhbWUgaXMgZm91bmQsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBjaGVja0ZyYW1lTmFtZTogZnVuY3Rpb24gKG5hbWUpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ZyYW1lTmFtZXNbbmFtZV0gPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHJhbmdlIG9mIGZyYW1lcyBiYXNlZCBvbiB0aGUgZ2l2ZW4gc3RhcnQgYW5kIGVuZCBmcmFtZSBpbmRleGVzIGFuZCByZXR1cm5zIHRoZW0gaW4gYW4gQXJyYXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lRGF0YSNnZXRGcmFtZVJhbmdlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCAtIFRoZSBzdGFydGluZyBmcmFtZSBpbmRleC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGVuZCAtIFRoZSBlbmRpbmcgZnJhbWUgaW5kZXguCiAgICAqIEBwYXJhbSB7QXJyYXl9IFtvdXRwdXRdIC0gSWYgZ2l2ZW4gdGhlIHJlc3VsdHMgd2lsbCBiZSBhcHBlbmRlZCB0byB0aGUgZW5kIG9mIHRoaXMgYXJyYXkgb3RoZXJ3aXNlIGEgbmV3IGFycmF5IHdpbGwgYmUgY3JlYXRlZC4KICAgICogQHJldHVybiB7QXJyYXl9IEFuIGFycmF5IG9mIEZyYW1lcyBiZXR3ZWVuIHRoZSBzdGFydCBhbmQgZW5kIGluZGV4IHZhbHVlcywgb3IgYW4gZW1wdHkgYXJyYXkgaWYgbm9uZSB3ZXJlIGZvdW5kLgogICAgKi8KICAgIGdldEZyYW1lUmFuZ2U6IGZ1bmN0aW9uIChzdGFydCwgZW5kLCBvdXRwdXQpIHsKICAgICAgICAKICAgICAgICBpZiAodHlwZW9mIG91dHB1dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0cHV0ID0gW107IH0KCiAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDw9IGVuZDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgb3V0cHV0LnB1c2godGhpcy5fZnJhbWVzW2ldKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBvdXRwdXQ7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhbGwgb2YgdGhlIEZyYW1lcyBpbiB0aGlzIEZyYW1lRGF0YSBzZXQgd2hlcmUgdGhlIGZyYW1lIGluZGV4IGlzIGZvdW5kIGluIHRoZSBpbnB1dCBhcnJheS4KICAgICogVGhlIGZyYW1lcyBhcmUgcmV0dXJuZWQgaW4gdGhlIG91dHB1dCBhcnJheSwgb3IgaWYgbm9uZSBpcyBwcm92aWRlZCBpbiBhIG5ldyBBcnJheSBvYmplY3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lRGF0YSNnZXRGcmFtZXMKICAgICogQHBhcmFtIHtBcnJheX0gZnJhbWVzIC0gQW4gQXJyYXkgY29udGFpbmluZyB0aGUgaW5kZXhlcyBvZiB0aGUgZnJhbWVzIHRvIHJldHJpZXZlLiBJZiB0aGUgYXJyYXkgaXMgZW1wdHkgdGhlbiBhbGwgZnJhbWVzIGluIHRoZSBGcmFtZURhdGEgYXJlIHJldHVybmVkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt1c2VOdW1lcmljSW5kZXg9dHJ1ZV0gLSBBcmUgdGhlIGdpdmVuIGZyYW1lcyB1c2luZyBudW1lcmljIGluZGV4ZXMgKGRlZmF1bHQpIG9yIHN0cmluZ3M/IChmYWxzZSkKICAgICogQHBhcmFtIHtBcnJheX0gW291dHB1dF0gLSBJZiBnaXZlbiB0aGUgcmVzdWx0cyB3aWxsIGJlIGFwcGVuZGVkIHRvIHRoZSBlbmQgb2YgdGhpcyBhcnJheSBvdGhlcndpc2UgYSBuZXcgYXJyYXkgd2lsbCBiZSBjcmVhdGVkLgogICAgKiBAcmV0dXJuIHtBcnJheX0gQW4gYXJyYXkgb2YgYWxsIEZyYW1lcyBpbiB0aGlzIEZyYW1lRGF0YSBzZXQgbWF0Y2hpbmcgdGhlIGdpdmVuIG5hbWVzIG9yIElEcy4KICAgICovCiAgICBnZXRGcmFtZXM6IGZ1bmN0aW9uIChmcmFtZXMsIHVzZU51bWVyaWNJbmRleCwgb3V0cHV0KSB7CgogICAgICAgIGlmICh0eXBlb2YgdXNlTnVtZXJpY0luZGV4ID09PSAidW5kZWZpbmVkIikgeyB1c2VOdW1lcmljSW5kZXggPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBvdXRwdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dHB1dCA9IFtdOyB9CgogICAgICAgIGlmICh0eXBlb2YgZnJhbWVzID09PSAidW5kZWZpbmVkIiB8fCBmcmFtZXMubGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIE5vIGlucHV0IGFycmF5LCBzbyB3ZSBsb29wIHRocm91Z2ggYWxsIGZyYW1lcwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2ZyYW1lcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFdlIG9ubHkgbmVlZCB0aGUgaW5kZXhlcwogICAgICAgICAgICAgICAgb3V0cHV0LnB1c2godGhpcy5fZnJhbWVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgSW5wdXQgYXJyYXkgZ2l2ZW4sIGxvb3AgdGhyb3VnaCB0aGF0IGluc3RlYWQKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGZyYW1lcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIERvZXMgdGhlIGlucHV0IGFycmF5IGNvbnRhaW4gbmFtZXMgb3IgaW5kZXhlcz8KICAgICAgICAgICAgICAgIGlmICh1c2VOdW1lcmljSW5kZXgpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gIFRoZSBhY3R1YWwgZnJhbWUKICAgICAgICAgICAgICAgICAgICBvdXRwdXQucHVzaCh0aGlzLmdldEZyYW1lKGZyYW1lc1tpXSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICBUaGUgYWN0dWFsIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0LnB1c2godGhpcy5nZXRGcmFtZUJ5TmFtZShmcmFtZXNbaV0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG91dHB1dDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGFsbCBvZiB0aGUgRnJhbWUgaW5kZXhlcyBpbiB0aGlzIEZyYW1lRGF0YSBzZXQuCiAgICAqIFRoZSBmcmFtZXMgaW5kZXhlcyBhcmUgcmV0dXJuZWQgaW4gdGhlIG91dHB1dCBhcnJheSwgb3IgaWYgbm9uZSBpcyBwcm92aWRlZCBpbiBhIG5ldyBBcnJheSBvYmplY3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lRGF0YSNnZXRGcmFtZUluZGV4ZXMKICAgICogQHBhcmFtIHtBcnJheX0gZnJhbWVzIC0gQW4gQXJyYXkgY29udGFpbmluZyB0aGUgaW5kZXhlcyBvZiB0aGUgZnJhbWVzIHRvIHJldHJpZXZlLiBJZiB0aGUgYXJyYXkgaXMgZW1wdHkgdGhlbiBhbGwgZnJhbWVzIGluIHRoZSBGcmFtZURhdGEgYXJlIHJldHVybmVkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt1c2VOdW1lcmljSW5kZXg9dHJ1ZV0gLSBBcmUgdGhlIGdpdmVuIGZyYW1lcyB1c2luZyBudW1lcmljIGluZGV4ZXMgKGRlZmF1bHQpIG9yIHN0cmluZ3M/IChmYWxzZSkKICAgICogQHBhcmFtIHtBcnJheX0gW291dHB1dF0gLSBJZiBnaXZlbiB0aGUgcmVzdWx0cyB3aWxsIGJlIGFwcGVuZGVkIHRvIHRoZSBlbmQgb2YgdGhpcyBhcnJheSBvdGhlcndpc2UgYSBuZXcgYXJyYXkgd2lsbCBiZSBjcmVhdGVkLgogICAgKiBAcmV0dXJuIHtBcnJheX0gQW4gYXJyYXkgb2YgYWxsIEZyYW1lIGluZGV4ZXMgbWF0Y2hpbmcgdGhlIGdpdmVuIG5hbWVzIG9yIElEcy4KICAgICovCiAgICBnZXRGcmFtZUluZGV4ZXM6IGZ1bmN0aW9uIChmcmFtZXMsIHVzZU51bWVyaWNJbmRleCwgb3V0cHV0KSB7CgogICAgICAgIGlmICh0eXBlb2YgdXNlTnVtZXJpY0luZGV4ID09PSAidW5kZWZpbmVkIikgeyB1c2VOdW1lcmljSW5kZXggPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBvdXRwdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dHB1dCA9IFtdOyB9CgogICAgICAgIGlmICh0eXBlb2YgZnJhbWVzID09PSAidW5kZWZpbmVkIiB8fCBmcmFtZXMubGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIE5vIGZyYW1lcyBhcnJheSwgc28gd2UgbG9vcCB0aHJvdWdoIGFsbCBmcmFtZXMKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2ZyYW1lcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3V0cHV0LnB1c2godGhpcy5fZnJhbWVzW2ldLmluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgSW5wdXQgYXJyYXkgZ2l2ZW4sIGxvb3AgdGhyb3VnaCB0aGF0IGluc3RlYWQKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGZyYW1lcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIERvZXMgdGhlIGZyYW1lcyBhcnJheSBjb250YWluIG5hbWVzIG9yIGluZGV4ZXM/CiAgICAgICAgICAgICAgICBpZiAodXNlTnVtZXJpY0luZGV4KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKGZyYW1lc1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0RnJhbWVCeU5hbWUoZnJhbWVzW2ldKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKHRoaXMuZ2V0RnJhbWVCeU5hbWUoZnJhbWVzW2ldKS5pbmRleCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gb3V0cHV0OwoKICAgIH0KCn07CgpQaGFzZXIuRnJhbWVEYXRhLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5GcmFtZURhdGE7CgovKioKKiBAbmFtZSBQaGFzZXIuRnJhbWVEYXRhI3RvdGFsCiogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsIC0gVGhlIHRvdGFsIG51bWJlciBvZiBmcmFtZXMgaW4gdGhpcyBGcmFtZURhdGEgc2V0LgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkZyYW1lRGF0YS5wcm90b3R5cGUsICJ0b3RhbCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZnJhbWVzLmxlbmd0aDsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUmVzcG9uc2libGUgZm9yIHBhcnNpbmcgc3ByaXRlIHNoZWV0IGFuZCBKU09OIGRhdGEgaW50byB0aGUgaW50ZXJuYWwgRnJhbWVEYXRhIGZvcm1hdCB0aGF0IFBoYXNlciB1c2VzIGZvciBhbmltYXRpb25zLgoqCiogQGNsYXNzIFBoYXNlci5BbmltYXRpb25QYXJzZXIKKi8KUGhhc2VyLkFuaW1hdGlvblBhcnNlciA9IHsKCiAgICAvKioKICAgICogUGFyc2UgYSBTcHJpdGUgU2hlZXQgYW5kIGV4dHJhY3QgdGhlIGFuaW1hdGlvbiBmcmFtZSBkYXRhIGZyb20gaXQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvblBhcnNlci5zcHJpdGVTaGVldAogICAgKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgR2FtZS5DYWNoZSBhc3NldCBrZXkgb2YgdGhlIFNwcml0ZSBTaGVldCBpbWFnZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGZyYW1lV2lkdGggLSBUaGUgZml4ZWQgd2lkdGggb2YgZWFjaCBmcmFtZSBvZiB0aGUgYW5pbWF0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gZnJhbWVIZWlnaHQgLSBUaGUgZml4ZWQgaGVpZ2h0IG9mIGVhY2ggZnJhbWUgb2YgdGhlIGFuaW1hdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcmFtZU1heD0tMV0gLSBUaGUgdG90YWwgbnVtYmVyIG9mIGFuaW1hdGlvbiBmcmFtZXMgdG8gZXh0YWN0IGZyb20gdGhlIFNwcml0ZSBTaGVldC4gVGhlIGRlZmF1bHQgdmFsdWUgb2YgLTEgbWVhbnMgImV4dHJhY3QgYWxsIGZyYW1lcyIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWFyZ2luPTBdIC0gSWYgdGhlIGZyYW1lcyBoYXZlIGJlZW4gZHJhd24gd2l0aCBhIG1hcmdpbiwgc3BlY2lmeSB0aGUgYW1vdW50IGhlcmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BhY2luZz0wXSAtIElmIHRoZSBmcmFtZXMgaGF2ZSBiZWVuIGRyYXduIHdpdGggc3BhY2luZyBiZXR3ZWVuIHRoZW0sIHNwZWNpZnkgdGhlIGFtb3VudCBoZXJlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWVEYXRhfSBBIEZyYW1lRGF0YSBvYmplY3QgY29udGFpbmluZyB0aGUgcGFyc2VkIGZyYW1lcy4KICAgICovCiAgICBzcHJpdGVTaGVldDogZnVuY3Rpb24gKGdhbWUsIGtleSwgZnJhbWVXaWR0aCwgZnJhbWVIZWlnaHQsIGZyYW1lTWF4LCBtYXJnaW4sIHNwYWNpbmcpIHsKCiAgICAgICAgLy8gIEhvdyBiaWcgaXMgb3VyIGltYWdlPwogICAgICAgIHZhciBpbWcgPSBnYW1lLmNhY2hlLmdldEltYWdlKGtleSk7CgogICAgICAgIGlmIChpbWcgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgdmFyIHdpZHRoID0gaW1nLndpZHRoOwogICAgICAgIHZhciBoZWlnaHQgPSBpbWcuaGVpZ2h0OwoKICAgICAgICBpZiAoZnJhbWVXaWR0aCA8PSAwKQogICAgICAgIHsKICAgICAgICAgICAgZnJhbWVXaWR0aCA9IE1hdGguZmxvb3IoLXdpZHRoIC8gTWF0aC5taW4oLTEsIGZyYW1lV2lkdGgpKTsKICAgICAgICB9CgogICAgICAgIGlmIChmcmFtZUhlaWdodCA8PSAwKQogICAgICAgIHsKICAgICAgICAgICAgZnJhbWVIZWlnaHQgPSBNYXRoLmZsb29yKC1oZWlnaHQgLyBNYXRoLm1pbigtMSwgZnJhbWVIZWlnaHQpKTsKICAgICAgICB9CgogICAgICAgIHZhciByb3cgPSBNYXRoLnJvdW5kKHdpZHRoIC8gZnJhbWVXaWR0aCk7CiAgICAgICAgdmFyIGNvbHVtbiA9IE1hdGgucm91bmQoaGVpZ2h0IC8gZnJhbWVIZWlnaHQpOwogICAgICAgIHZhciB0b3RhbCA9IHJvdyAqIGNvbHVtbjsKICAgICAgICAKICAgICAgICBpZiAoZnJhbWVNYXggIT09IC0xKQogICAgICAgIHsKICAgICAgICAgICAgdG90YWwgPSBmcmFtZU1heDsKICAgICAgICB9CgogICAgICAgIC8vICBaZXJvIG9yIHNtYWxsZXIgdGhhbiBmcmFtZSBzaXplcz8KICAgICAgICBpZiAod2lkdGggPT09IDAgfHwgaGVpZ2h0ID09PSAwIHx8IHdpZHRoIDwgZnJhbWVXaWR0aCB8fCBoZWlnaHQgPCBmcmFtZUhlaWdodCB8fCB0b3RhbCA9PT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiUGhhc2VyLkFuaW1hdGlvblBhcnNlci5zcHJpdGVTaGVldDogd2lkdGgvaGVpZ2h0IHplcm8gb3Igd2lkdGgvaGVpZ2h0IDwgZ2l2ZW4gZnJhbWVXaWR0aC9mcmFtZUhlaWdodCIpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIC8vICBMZXQncyBjcmVhdGUgc29tZSBmcmFtZXMgdGhlbgogICAgICAgIHZhciBkYXRhID0gbmV3IFBoYXNlci5GcmFtZURhdGEoKTsKICAgICAgICB2YXIgeCA9IG1hcmdpbjsKICAgICAgICB2YXIgeSA9IG1hcmdpbjsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b3RhbDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHV1aWQgPSBnYW1lLnJuZC51dWlkKCk7CgogICAgICAgICAgICBkYXRhLmFkZEZyYW1lKG5ldyBQaGFzZXIuRnJhbWUoaSwgeCwgeSwgZnJhbWVXaWR0aCwgZnJhbWVIZWlnaHQsICcnLCB1dWlkKSk7CgogICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0sIHsKICAgICAgICAgICAgICAgIHg6IHgsCiAgICAgICAgICAgICAgICB5OiB5LAogICAgICAgICAgICAgICAgd2lkdGg6IGZyYW1lV2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGZyYW1lSGVpZ2h0CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgeCArPSBmcmFtZVdpZHRoICsgc3BhY2luZzsKCiAgICAgICAgICAgIGlmICh4ID09PSB3aWR0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgeCA9IG1hcmdpbjsKICAgICAgICAgICAgICAgIHkgKz0gZnJhbWVIZWlnaHQgKyBzcGFjaW5nOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZGF0YTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXJzZSB0aGUgSlNPTiBkYXRhIGFuZCBleHRyYWN0IHRoZSBhbmltYXRpb24gZnJhbWUgZGF0YSBmcm9tIGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25QYXJzZXIuSlNPTkRhdGEKICAgICogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKiBAcGFyYW0ge09iamVjdH0ganNvbiAtIFRoZSBKU09OIGRhdGEgZnJvbSB0aGUgVGV4dHVyZSBBdGxhcy4gTXVzdCBiZSBpbiBBcnJheSBmb3JtYXQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZUtleSAtIFRoZSBHYW1lLkNhY2hlIGFzc2V0IGtleSBvZiB0aGUgdGV4dHVyZSBpbWFnZS4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lRGF0YX0gQSBGcmFtZURhdGEgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHBhcnNlZCBmcmFtZXMuCiAgICAqLwogICAgSlNPTkRhdGE6IGZ1bmN0aW9uIChnYW1lLCBqc29uLCBjYWNoZUtleSkgewoKICAgICAgICAvLyAgTWFsZm9ybWVkPwogICAgICAgIGlmICghanNvblsnZnJhbWVzJ10pCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5BbmltYXRpb25QYXJzZXIuSlNPTkRhdGE6IEludmFsaWQgVGV4dHVyZSBBdGxhcyBKU09OIGdpdmVuLCBtaXNzaW5nICdmcmFtZXMnIGFycmF5Iik7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGpzb24pOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyAgTGV0J3MgY3JlYXRlIHNvbWUgZnJhbWVzIHRoZW4KICAgICAgICB2YXIgZGF0YSA9IG5ldyBQaGFzZXIuRnJhbWVEYXRhKCk7CiAgICAgICAgCiAgICAgICAgLy8gIEJ5IHRoaXMgc3RhZ2UgZnJhbWVzIGlzIGEgZnVsbHkgcGFyc2VkIGFycmF5CiAgICAgICAgdmFyIGZyYW1lcyA9IGpzb25bJ2ZyYW1lcyddOwogICAgICAgIHZhciBuZXdGcmFtZTsKICAgICAgICAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZyYW1lcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB1dWlkID0gZ2FtZS5ybmQudXVpZCgpOwoKICAgICAgICAgICAgbmV3RnJhbWUgPSBkYXRhLmFkZEZyYW1lKG5ldyBQaGFzZXIuRnJhbWUoCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgZnJhbWVzW2ldLmZyYW1lLngsCiAgICAgICAgICAgICAgICBmcmFtZXNbaV0uZnJhbWUueSwKICAgICAgICAgICAgICAgIGZyYW1lc1tpXS5mcmFtZS53LAogICAgICAgICAgICAgICAgZnJhbWVzW2ldLmZyYW1lLmgsCiAgICAgICAgICAgICAgICBmcmFtZXNbaV0uZmlsZW5hbWUsCiAgICAgICAgICAgICAgICB1dWlkCiAgICAgICAgICAgICkpOwoKICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtjYWNoZUtleV0sIHsKICAgICAgICAgICAgICAgIHg6IGZyYW1lc1tpXS5mcmFtZS54LAogICAgICAgICAgICAgICAgeTogZnJhbWVzW2ldLmZyYW1lLnksCiAgICAgICAgICAgICAgICB3aWR0aDogZnJhbWVzW2ldLmZyYW1lLncsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGZyYW1lc1tpXS5mcmFtZS5oCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKGZyYW1lc1tpXS50cmltbWVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuZXdGcmFtZS5zZXRUcmltKAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1tpXS50cmltbWVkLAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1tpXS5zb3VyY2VTaXplLncsCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2ldLnNvdXJjZVNpemUuaCwKICAgICAgICAgICAgICAgICAgICBmcmFtZXNbaV0uc3ByaXRlU291cmNlU2l6ZS54LAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1tpXS5zcHJpdGVTb3VyY2VTaXplLnksCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2ldLnNwcml0ZVNvdXJjZVNpemUudywKICAgICAgICAgICAgICAgICAgICBmcmFtZXNbaV0uc3ByaXRlU291cmNlU2l6ZS5oCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIC8vICBXZSBoYWQgdG8gaGFjayBQaXhpIHRvIGdldCB0aGlzIHRvIHdvcmsgOigKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW1tZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0udHJpbS54ID0gZnJhbWVzW2ldLnNwcml0ZVNvdXJjZVNpemUueDsKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW0ueSA9IGZyYW1lc1tpXS5zcHJpdGVTb3VyY2VTaXplLnk7CgogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZGF0YTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXJzZSB0aGUgSlNPTiBkYXRhIGFuZCBleHRyYWN0IHRoZSBhbmltYXRpb24gZnJhbWUgZGF0YSBmcm9tIGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25QYXJzZXIuSlNPTkRhdGFIYXNoCiAgICAqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICogQHBhcmFtIHtPYmplY3R9IGpzb24gLSBUaGUgSlNPTiBkYXRhIGZyb20gdGhlIFRleHR1cmUgQXRsYXMuIE11c3QgYmUgaW4gSlNPTiBIYXNoIGZvcm1hdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlS2V5IC0gVGhlIEdhbWUuQ2FjaGUgYXNzZXQga2V5IG9mIHRoZSB0ZXh0dXJlIGltYWdlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWVEYXRhfSBBIEZyYW1lRGF0YSBvYmplY3QgY29udGFpbmluZyB0aGUgcGFyc2VkIGZyYW1lcy4KICAgICovCiAgICBKU09ORGF0YUhhc2g6IGZ1bmN0aW9uIChnYW1lLCBqc29uLCBjYWNoZUtleSkgewoKICAgICAgICAvLyAgTWFsZm9ybWVkPwogICAgICAgIGlmICghanNvblsnZnJhbWVzJ10pCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5BbmltYXRpb25QYXJzZXIuSlNPTkRhdGFIYXNoOiBJbnZhbGlkIFRleHR1cmUgQXRsYXMgSlNPTiBnaXZlbiwgbWlzc2luZyAnZnJhbWVzJyBvYmplY3QiKTsKICAgICAgICAgICAgY29uc29sZS5sb2coanNvbik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIC8vICBMZXQncyBjcmVhdGUgc29tZSBmcmFtZXMgdGhlbgogICAgICAgIHZhciBkYXRhID0gbmV3IFBoYXNlci5GcmFtZURhdGEoKTsKCiAgICAgICAgLy8gIEJ5IHRoaXMgc3RhZ2UgZnJhbWVzIGlzIGEgZnVsbHkgcGFyc2VkIGFycmF5CiAgICAgICAgdmFyIGZyYW1lcyA9IGpzb25bJ2ZyYW1lcyddOwogICAgICAgIHZhciBuZXdGcmFtZTsKICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgCiAgICAgICAgZm9yICh2YXIga2V5IGluIGZyYW1lcykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB1dWlkID0gZ2FtZS5ybmQudXVpZCgpOwoKICAgICAgICAgICAgbmV3RnJhbWUgPSBkYXRhLmFkZEZyYW1lKG5ldyBQaGFzZXIuRnJhbWUoCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uZnJhbWUueCwKICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLmZyYW1lLnksCiAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS5mcmFtZS53LAogICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uZnJhbWUuaCwKICAgICAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgICAgIHV1aWQKICAgICAgICAgICAgKSk7CgogICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZUNhY2hlW2NhY2hlS2V5XSwgewogICAgICAgICAgICAgICAgeDogZnJhbWVzW2tleV0uZnJhbWUueCwKICAgICAgICAgICAgICAgIHk6IGZyYW1lc1trZXldLmZyYW1lLnksCiAgICAgICAgICAgICAgICB3aWR0aDogZnJhbWVzW2tleV0uZnJhbWUudywKICAgICAgICAgICAgICAgIGhlaWdodDogZnJhbWVzW2tleV0uZnJhbWUuaAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChmcmFtZXNba2V5XS50cmltbWVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuZXdGcmFtZS5zZXRUcmltKAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLnRyaW1tZWQsCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uc291cmNlU2l6ZS53LAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLnNvdXJjZVNpemUuaCwKICAgICAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS5zcHJpdGVTb3VyY2VTaXplLngsCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uc3ByaXRlU291cmNlU2l6ZS55LAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLnNwcml0ZVNvdXJjZVNpemUudywKICAgICAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS5zcHJpdGVTb3VyY2VTaXplLmgKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgLy8gIFdlIGhhZCB0byBoYWNrIFBpeGkgdG8gZ2V0IHRoaXMgdG8gd29yayA6KAogICAgICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0udHJpbW1lZCA9IHRydWU7CiAgICAgICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXS50cmltLnggPSBmcmFtZXNba2V5XS5zcHJpdGVTb3VyY2VTaXplLng7CiAgICAgICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXS50cmltLnkgPSBmcmFtZXNba2V5XS5zcHJpdGVTb3VyY2VTaXplLnk7CgogICAgICAgICAgICB9CgogICAgICAgICAgICBpKys7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZGF0YTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXJzZSB0aGUgWE1MIGRhdGEgYW5kIGV4dHJhY3QgdGhlIGFuaW1hdGlvbiBmcmFtZSBkYXRhIGZyb20gaXQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvblBhcnNlci5YTUxEYXRhCiAgICAqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICogQHBhcmFtIHtPYmplY3R9IHhtbCAtIFRoZSBYTUwgZGF0YSBmcm9tIHRoZSBUZXh0dXJlIEF0bGFzLiBNdXN0IGJlIGluIFN0YXJsaW5nIFhNTCBmb3JtYXQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZUtleSAtIFRoZSBHYW1lLkNhY2hlIGFzc2V0IGtleSBvZiB0aGUgdGV4dHVyZSBpbWFnZS4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lRGF0YX0gQSBGcmFtZURhdGEgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHBhcnNlZCBmcmFtZXMuCiAgICAqLwogICAgWE1MRGF0YTogZnVuY3Rpb24gKGdhbWUsIHhtbCwgY2FjaGVLZXkpIHsKCiAgICAgICAgLy8gIE1hbGZvcm1lZD8KICAgICAgICBpZiAoIXhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnVGV4dHVyZUF0bGFzJykpCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5BbmltYXRpb25QYXJzZXIuWE1MRGF0YTogSW52YWxpZCBUZXh0dXJlIEF0bGFzIFhNTCBnaXZlbiwgbWlzc2luZyA8VGV4dHVyZUF0bGFzPiB0YWciKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gIExldCdzIGNyZWF0ZSBzb21lIGZyYW1lcyB0aGVuCiAgICAgICAgdmFyIGRhdGEgPSBuZXcgUGhhc2VyLkZyYW1lRGF0YSgpOwogICAgICAgIHZhciBmcmFtZXMgPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ1N1YlRleHR1cmUnKTsKICAgICAgICB2YXIgbmV3RnJhbWU7CgogICAgICAgIHZhciB1dWlkOwogICAgICAgIHZhciBuYW1lOwogICAgICAgIHZhciBmcmFtZTsKICAgICAgICB2YXIgeDsKICAgICAgICB2YXIgeTsKICAgICAgICB2YXIgd2lkdGg7CiAgICAgICAgdmFyIGhlaWdodDsKICAgICAgICB2YXIgZnJhbWVYOwogICAgICAgIHZhciBmcmFtZVk7CiAgICAgICAgdmFyIGZyYW1lV2lkdGg7CiAgICAgICAgdmFyIGZyYW1lSGVpZ2h0OwogICAgICAgIAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZnJhbWVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdXVpZCA9IGdhbWUucm5kLnV1aWQoKTsKCiAgICAgICAgICAgIGZyYW1lID0gZnJhbWVzW2ldLmF0dHJpYnV0ZXM7CgogICAgICAgICAgICBuYW1lID0gZnJhbWUubmFtZS5ub2RlVmFsdWU7CiAgICAgICAgICAgIHggPSBwYXJzZUludChmcmFtZS54Lm5vZGVWYWx1ZSwgMTApOwogICAgICAgICAgICB5ID0gcGFyc2VJbnQoZnJhbWUueS5ub2RlVmFsdWUsIDEwKTsKICAgICAgICAgICAgd2lkdGggPSBwYXJzZUludChmcmFtZS53aWR0aC5ub2RlVmFsdWUsIDEwKTsKICAgICAgICAgICAgaGVpZ2h0ID0gcGFyc2VJbnQoZnJhbWUuaGVpZ2h0Lm5vZGVWYWx1ZSwgMTApOwoKICAgICAgICAgICAgZnJhbWVYID0gbnVsbDsKICAgICAgICAgICAgZnJhbWVZID0gbnVsbDsKCiAgICAgICAgICAgIGlmIChmcmFtZS5mcmFtZVgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZyYW1lWCA9IE1hdGguYWJzKHBhcnNlSW50KGZyYW1lLmZyYW1lWC5ub2RlVmFsdWUsIDEwKSk7CiAgICAgICAgICAgICAgICBmcmFtZVkgPSBNYXRoLmFicyhwYXJzZUludChmcmFtZS5mcmFtZVkubm9kZVZhbHVlLCAxMCkpOwogICAgICAgICAgICAgICAgZnJhbWVXaWR0aCA9IHBhcnNlSW50KGZyYW1lLmZyYW1lV2lkdGgubm9kZVZhbHVlLCAxMCk7CiAgICAgICAgICAgICAgICBmcmFtZUhlaWdodCA9IHBhcnNlSW50KGZyYW1lLmZyYW1lSGVpZ2h0Lm5vZGVWYWx1ZSwgMTApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdGcmFtZSA9IGRhdGEuYWRkRnJhbWUobmV3IFBoYXNlci5GcmFtZShpLCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBuYW1lLCB1dWlkKSk7CgogICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZUNhY2hlW2NhY2hlS2V5XSwgewogICAgICAgICAgICAgICAgeDogeCwKICAgICAgICAgICAgICAgIHk6IHksCiAgICAgICAgICAgICAgICB3aWR0aDogd2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGhlaWdodAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vICBUcmltbWVkPwogICAgICAgICAgICBpZiAoZnJhbWVYICE9PSBudWxsIHx8IGZyYW1lWSAhPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmV3RnJhbWUuc2V0VHJpbSh0cnVlLCB3aWR0aCwgaGVpZ2h0LCBmcmFtZVgsIGZyYW1lWSwgZnJhbWVXaWR0aCwgZnJhbWVIZWlnaHQpOwoKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnJlYWxTaXplID0geyB4OiBmcmFtZVgsIHk6IGZyYW1lWSwgdzogZnJhbWVXaWR0aCwgaDogZnJhbWVIZWlnaHQgfTsKCiAgICAgICAgICAgICAgICAvLyAgV2UgaGFkIHRvIGhhY2sgUGl4aSB0byBnZXQgdGhpcyB0byB3b3JrIDooCiAgICAgICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXS50cmltbWVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW0ueCA9IGZyYW1lWDsKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW0ueSA9IGZyYW1lWTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGE7CgogICAgfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlci5DYWNoZSBjb25zdHJ1Y3Rvci4KKgoqIEBjbGFzcyBQaGFzZXIuQ2FjaGUKKiBAY2xhc3NkZXNjIEEgZ2FtZSBvbmx5IGhhcyBvbmUgaW5zdGFuY2Ugb2YgYSBDYWNoZSBhbmQgaXQgaXMgdXNlZCB0byBzdG9yZSBhbGwgZXh0ZXJuYWxseSBsb2FkZWQgYXNzZXRzIHN1Y2ggYXMgaW1hZ2VzLCBzb3VuZHMgYW5kIGRhdGEgZmlsZXMgYXMgYSByZXN1bHQgb2YgTG9hZGVyIGNhbGxzLiBDYWNoZWQgaXRlbXMgdXNlIHN0cmluZyBiYXNlZCBrZXlzIGZvciBsb29rLXVwLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLkNhY2hlID0gZnVuY3Rpb24gKGdhbWUpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBnYW1lIC0gQ2FudmFzIGtleS12YWx1ZSBjb250YWluZXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fY2FudmFzZXMgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF9pbWFnZXMgLSBJbWFnZSBrZXktdmFsdWUgY29udGFpbmVyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2ltYWdlcyA9IHt9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX3RleHR1cmVzIC0gUmVuZGVyVGV4dHVyZSBrZXktdmFsdWUgY29udGFpbmVyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3RleHR1cmVzID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfc291bmRzIC0gU291bmQga2V5LXZhbHVlIGNvbnRhaW5lci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9zb3VuZHMgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF90ZXh0IC0gVGV4dCBrZXktdmFsdWUgY29udGFpbmVyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3RleHQgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF90aWxlbWFwcyAtIFRpbGVtYXAga2V5LXZhbHVlIGNvbnRhaW5lci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90aWxlbWFwcyA9IHt9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX2JpbmFyeSAtIEJpbmFyeSBmaWxlIGtleS12YWx1ZSBjb250YWluZXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fYmluYXJ5ID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfYml0bWFwRGF0YXMgLSBCaXRtYXBEYXRhIGtleS12YWx1ZSBjb250YWluZXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fYml0bWFwRGF0YXMgPSB7fTsKCiAgICB0aGlzLmFkZERlZmF1bHRJbWFnZSgpOwogICAgdGhpcy5hZGRNaXNzaW5nSW1hZ2UoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvblNvdW5kVW5sb2NrIC0gVGhpcyBldmVudCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhlIHNvdW5kIHN5c3RlbSBpcyB1bmxvY2tlZCB2aWEgYSB0b3VjaCBldmVudCBvbiBjZWxsdWxhciBkZXZpY2VzLgogICAgKi8KICAgIHRoaXMub25Tb3VuZFVubG9jayA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7Cgp9OwoKUGhhc2VyLkNhY2hlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkIGEgbmV3IGNhbnZhcyBvYmplY3QgaW4gdG8gdGhlIGNhY2hlLgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRDYW52YXMKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhpcyBjYW52YXMuCiAgICAqIEBwYXJhbSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIENhbnZhcyBET00gZWxlbWVudC4KICAgICogQHBhcmFtIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHQgLSBSZW5kZXIgY29udGV4dCBvZiB0aGlzIGNhbnZhcy4KICAgICovCiAgICBhZGRDYW52YXM6IGZ1bmN0aW9uIChrZXksIGNhbnZhcywgY29udGV4dCkgewoKICAgICAgICB0aGlzLl9jYW52YXNlc1trZXldID0geyBjYW52YXM6IGNhbnZhcywgY29udGV4dDogY29udGV4dCB9OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIGJpbmFyeSBvYmplY3QgaW4gdG8gdGhlIGNhY2hlLgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRCaW5hcnkKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhpcyBiaW5hcnkgZGF0YS4KICAgICogQHBhcmFtIHtvYmplY3R9IGJpbmFyeURhdGEgLSBUaGUgYmluYXJ5IG9iamVjdCB0byBiZSBhZGRkZWQgdG8gdGhlIGNhY2hlLgogICAgKi8KICAgIGFkZEJpbmFyeTogZnVuY3Rpb24gKGtleSwgYmluYXJ5RGF0YSkgewoKICAgICAgICB0aGlzLl9iaW5hcnlba2V5XSA9IGJpbmFyeURhdGE7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgQml0bWFwRGF0YSBvYmplY3QgaW4gdG8gdGhlIGNhY2hlLgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRCaXRtYXBEYXRhCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoaXMgQml0bWFwRGF0YS4KICAgICogQHBhcmFtIHtQaGFzZXIuQml0bWFwRGF0YX0gYml0bWFwRGF0YSAtIFRoZSBCaXRtYXBEYXRhIG9iamVjdCB0byBiZSBhZGRkZWQgdG8gdGhlIGNhY2hlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgb2JqZWN0IHRvIGJlIGFkZGRlZCB0byB0aGUgY2FjaGUuCiAgICAqLwogICAgYWRkQml0bWFwRGF0YTogZnVuY3Rpb24gKGtleSwgYml0bWFwRGF0YSkgewoKICAgICAgICB0aGlzLl9iaXRtYXBEYXRhc1trZXldID0gYml0bWFwRGF0YTsKCiAgICAgICAgcmV0dXJuIGJpdG1hcERhdGE7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IFBoYXNlci5SZW5kZXJUZXh0dXJlIGluIHRvIHRoZSBjYWNoZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkUmVuZGVyVGV4dHVyZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHVuaXF1ZSBrZXkgYnkgd2hpY2ggeW91IHdpbGwgcmVmZXJlbmNlIHRoaXMgb2JqZWN0LgogICAgKiBAcGFyYW0ge1BoYXNlci5UZXh0dXJlfSB0ZXh0dXJlIC0gVGhlIHRleHR1cmUgdG8gdXNlIGFzIHRoZSBiYXNlIG9mIHRoZSBSZW5kZXJUZXh0dXJlLgogICAgKi8KICAgIGFkZFJlbmRlclRleHR1cmU6IGZ1bmN0aW9uIChrZXksIHRleHR1cmUpIHsKCiAgICAgICAgdmFyIGZyYW1lID0gbmV3IFBoYXNlci5GcmFtZSgwLCAwLCAwLCB0ZXh0dXJlLndpZHRoLCB0ZXh0dXJlLmhlaWdodCwgJycsICcnKTsKCiAgICAgICAgdGhpcy5fdGV4dHVyZXNba2V5XSA9IHsgdGV4dHVyZTogdGV4dHVyZSwgZnJhbWU6IGZyYW1lIH07CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IHNwcml0ZSBzaGVldCBpbiB0byB0aGUgY2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZFNwcml0ZVNoZWV0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgdW5pcXVlIGtleSBieSB3aGljaCB5b3Ugd2lsbCByZWZlcmVuY2UgdGhpcyBvYmplY3QuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhpcyBzcHJpdGUgc2hlZXQgZmlsZS4KICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBFeHRyYSBzcHJpdGUgc2hlZXQgZGF0YS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGZyYW1lV2lkdGggLSBXaWR0aCBvZiB0aGUgc3ByaXRlIHNoZWV0LgogICAgKiBAcGFyYW0ge251bWJlcn0gZnJhbWVIZWlnaHQgLSBIZWlnaHQgb2YgdGhlIHNwcml0ZSBzaGVldC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcmFtZU1heD0tMV0gLSBIb3cgbWFueSBmcmFtZXMgc3RvcmVkIGluIHRoZSBzcHJpdGUgc2hlZXQuIElmIC0xIHRoZW4gaXQgZGl2aWRlcyB0aGUgd2hvbGUgc2hlZXQgZXZlbmx5LgogICAgKiBAcGFyYW0ge251bWJlcn0gW21hcmdpbj0wXSAtIElmIHRoZSBmcmFtZXMgaGF2ZSBiZWVuIGRyYXduIHdpdGggYSBtYXJnaW4sIHNwZWNpZnkgdGhlIGFtb3VudCBoZXJlLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwYWNpbmc9MF0gLSBJZiB0aGUgZnJhbWVzIGhhdmUgYmVlbiBkcmF3biB3aXRoIHNwYWNpbmcgYmV0d2VlbiB0aGVtLCBzcGVjaWZ5IHRoZSBhbW91bnQgaGVyZS4KICAgICovCiAgICBhZGRTcHJpdGVTaGVldDogZnVuY3Rpb24gKGtleSwgdXJsLCBkYXRhLCBmcmFtZVdpZHRoLCBmcmFtZUhlaWdodCwgZnJhbWVNYXgsIG1hcmdpbiwgc3BhY2luZykgewoKICAgICAgICB0aGlzLl9pbWFnZXNba2V5XSA9IHsgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIHNwcml0ZVNoZWV0OiB0cnVlLCBmcmFtZVdpZHRoOiBmcmFtZVdpZHRoLCBmcmFtZUhlaWdodDogZnJhbWVIZWlnaHQsIG1hcmdpbjogbWFyZ2luLCBzcGFjaW5nOiBzcGFjaW5nIH07CgogICAgICAgIFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldID0gbmV3IFBJWEkuQmFzZVRleHR1cmUoZGF0YSk7CiAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVba2V5XSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0pOwoKICAgICAgICB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEgPSBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLnNwcml0ZVNoZWV0KHRoaXMuZ2FtZSwga2V5LCBmcmFtZVdpZHRoLCBmcmFtZUhlaWdodCwgZnJhbWVNYXgsIG1hcmdpbiwgc3BhY2luZyk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IHRpbGVtYXAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZFRpbGVtYXAKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSB1bmlxdWUga2V5IGJ5IHdoaWNoIHlvdSB3aWxsIHJlZmVyZW5jZSB0aGlzIG9iamVjdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGUgdGlsZW1hcCBpbWFnZS4KICAgICogQHBhcmFtIHtvYmplY3R9IG1hcERhdGEgLSBUaGUgdGlsZW1hcCBkYXRhIG9iamVjdCAoZWl0aGVyIGEgQ1NWIG9yIEpTT04gZmlsZSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBmb3JtYXQgLSBUaGUgZm9ybWF0IG9mIHRoZSB0aWxlbWFwIGRhdGEuCiAgICAqLwogICAgYWRkVGlsZW1hcDogZnVuY3Rpb24gKGtleSwgdXJsLCBtYXBEYXRhLCBmb3JtYXQpIHsKCiAgICAgICAgdGhpcy5fdGlsZW1hcHNba2V5XSA9IHsgdXJsOiB1cmwsIGRhdGE6IG1hcERhdGEsIGZvcm1hdDogZm9ybWF0IH07CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IHRleHR1cmUgYXRsYXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZFRleHR1cmVBdGxhcwogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHVuaXF1ZSBrZXkgYnkgd2hpY2ggeW91IHdpbGwgcmVmZXJlbmNlIHRoaXMgb2JqZWN0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoaXMgdGV4dHVyZSBhdGxhcyBmaWxlLgogICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEV4dHJhIHRleHR1cmUgYXRsYXMgZGF0YS4KICAgICogQHBhcmFtIHtvYmplY3R9IGF0bGFzRGF0YSAgLSBUZXh0dXJlIGF0bGFzIGZyYW1lcyBkYXRhLgogICAgKiBAcGFyYW0ge251bWJlcn0gZm9ybWF0IC0gVGhlIGZvcm1hdCBvZiB0aGUgdGV4dHVyZSBhdGxhcy4KICAgICovCiAgICBhZGRUZXh0dXJlQXRsYXM6IGZ1bmN0aW9uIChrZXksIHVybCwgZGF0YSwgYXRsYXNEYXRhLCBmb3JtYXQpIHsKCiAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0gPSB7IHVybDogdXJsLCBkYXRhOiBkYXRhLCBzcHJpdGVTaGVldDogdHJ1ZSB9OwoKICAgICAgICBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKGRhdGEpOwogICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldKTsKCiAgICAgICAgaWYgKGZvcm1hdCA9PSBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9BUlJBWSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lRGF0YSA9IFBoYXNlci5BbmltYXRpb25QYXJzZXIuSlNPTkRhdGEodGhpcy5nYW1lLCBhdGxhc0RhdGEsIGtleSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGZvcm1hdCA9PSBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9IQVNIKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhID0gUGhhc2VyLkFuaW1hdGlvblBhcnNlci5KU09ORGF0YUhhc2godGhpcy5nYW1lLCBhdGxhc0RhdGEsIGtleSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGZvcm1hdCA9PSBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfWE1MX1NUQVJMSU5HKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhID0gUGhhc2VyLkFuaW1hdGlvblBhcnNlci5YTUxEYXRhKHRoaXMuZ2FtZSwgYXRsYXNEYXRhLCBrZXkpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgQml0bWFwIEZvbnQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZEJpdG1hcEZvbnQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSB1bmlxdWUga2V5IGJ5IHdoaWNoIHlvdSB3aWxsIHJlZmVyZW5jZSB0aGlzIG9iamVjdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGlzIGZvbnQgeG1sIGZpbGUuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gRXh0cmEgZm9udCBkYXRhLgogICAgKiBAcGFyYW0geG1sRGF0YSB7b2JqZWN0fSBUZXh0dXJlIGF0bGFzIGZyYW1lcyBkYXRhLgogICAgKi8KICAgIGFkZEJpdG1hcEZvbnQ6IGZ1bmN0aW9uIChrZXksIHVybCwgZGF0YSwgeG1sRGF0YSkgewoKICAgICAgICB0aGlzLl9pbWFnZXNba2V5XSA9IHsgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIHNwcml0ZVNoZWV0OiB0cnVlIH07CgogICAgICAgIFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldID0gbmV3IFBJWEkuQmFzZVRleHR1cmUoZGF0YSk7CiAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVba2V5XSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0pOwoKICAgICAgICBQaGFzZXIuTG9hZGVyUGFyc2VyLmJpdG1hcEZvbnQodGhpcy5nYW1lLCB4bWxEYXRhLCBrZXkpOwogICAgICAgIC8vIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lRGF0YSA9IFBoYXNlci5BbmltYXRpb25QYXJzZXIuWE1MRGF0YSh0aGlzLmdhbWUsIHhtbERhdGEsIGtleSk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyBhIGRlZmF1bHQgaW1hZ2UgdG8gYmUgdXNlZCBpbiBzcGVjaWFsIGNhc2VzIHN1Y2ggYXMgV2ViR0wgRmlsdGVycy4gSXMgbWFwcGVkIHRvIHRoZSBrZXkgX19kZWZhdWx0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGREZWZhdWx0SW1hZ2UKICAgICovCiAgICBhZGREZWZhdWx0SW1hZ2U6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpOwogICAgICAgIGltZy5zcmMgPSAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFDQUFBQUFnQVFNQUFBQkp0T2kzQUFBQUExQk1WRVgvLy8rbnhCdklBQUFBQVhSU1RsTUFRT2JZWmdBQUFCVkpSRUZVZUY3TndJRUFBQUFBZ0tEOXFkZW9jQU1Bb0FBQm0zRGtjQUFBQUFCSlJVNUVya0pnZ2c9PSI7CgogICAgICAgIHRoaXMuX2ltYWdlc1snX19kZWZhdWx0J10gPSB7IHVybDogbnVsbCwgZGF0YTogaW1nLCBzcHJpdGVTaGVldDogZmFsc2UgfTsKICAgICAgICB0aGlzLl9pbWFnZXNbJ19fZGVmYXVsdCddLmZyYW1lID0gbmV3IFBoYXNlci5GcmFtZSgwLCAwLCAwLCAzMiwgMzIsICcnLCAnJyk7CgogICAgICAgIFBJWEkuQmFzZVRleHR1cmVDYWNoZVsnX19kZWZhdWx0J10gPSBuZXcgUElYSS5CYXNlVGV4dHVyZShpbWcpOwogICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlWydfX2RlZmF1bHQnXSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZUNhY2hlWydfX2RlZmF1bHQnXSk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyBhbiBpbWFnZSB0byBiZSB1c2VkIHdoZW4gYSBrZXkgaXMgd3JvbmcgLyBtaXNzaW5nLiBJcyBtYXBwZWQgdG8gdGhlIGtleSBfX21pc3NpbmcuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZE1pc3NpbmdJbWFnZQogICAgKi8KICAgIGFkZE1pc3NpbmdJbWFnZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgaW1nLnNyYyA9ICJkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQUNBQUFBQWdDQUlBQUFEOEdPMmpBQUFBR1hSRldIUlRiMlowZDJGeVpRQkJaRzlpWlNCSmJXRm5aVkpsWVdSNWNjbGxQQUFBQUo5SlJFRlVlTnEwMXNzT3d5QU1SRkc0NnYvL010MUVTbWdoK0RGbUUyR1BPQkFSS2IyTlZqbysxN1BYTEQ4YTErcGw1K0Erd1NnRnlneW1XWUhCYjBGdHNLaEpEZFpsbmNHMkl6SjRheW9NRHYyMHdUbVNNekNsRWdiV1lOVEFrUTBaK09KK0EvZVduQWFSOStveENGNE9zMEg4aHRzTVVwK3B3Y2dCQmlNTm5Bd0Y4R3FJZ0wyaEF6YUdGRmdaYXVEUEtBQm1vd1o0R0wzNjkvMHJ3QUNwMnlBL3R0bXZzUUFBQUFCSlJVNUVya0pnZ2c9PSI7CgogICAgICAgIHRoaXMuX2ltYWdlc1snX19taXNzaW5nJ10gPSB7IHVybDogbnVsbCwgZGF0YTogaW1nLCBzcHJpdGVTaGVldDogZmFsc2UgfTsKICAgICAgICB0aGlzLl9pbWFnZXNbJ19fbWlzc2luZyddLmZyYW1lID0gbmV3IFBoYXNlci5GcmFtZSgwLCAwLCAwLCAzMiwgMzIsICcnLCAnJyk7CgogICAgICAgIFBJWEkuQmFzZVRleHR1cmVDYWNoZVsnX19taXNzaW5nJ10gPSBuZXcgUElYSS5CYXNlVGV4dHVyZShpbWcpOwogICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlWydfX21pc3NpbmcnXSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZUNhY2hlWydfX21pc3NpbmcnXSk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IHRleHQgZGF0YS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkVGV4dAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgdGV4dCBkYXRhLiAKICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGlzIHRleHQgZGF0YSBmaWxlLgogICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEV4dHJhIHRleHQgZGF0YS4KICAgICovCiAgICBhZGRUZXh0OiBmdW5jdGlvbiAoa2V5LCB1cmwsIGRhdGEpIHsKCiAgICAgICAgdGhpcy5fdGV4dFtrZXldID0gewogICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgIH07CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IGltYWdlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRJbWFnZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHVuaXF1ZSBrZXkgYnkgd2hpY2ggeW91IHdpbGwgcmVmZXJlbmNlIHRoaXMgb2JqZWN0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoaXMgaW1hZ2UgZmlsZS4KICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBFeHRyYSBpbWFnZSBkYXRhLgogICAgKi8KICAgIGFkZEltYWdlOiBmdW5jdGlvbiAoa2V5LCB1cmwsIGRhdGEpIHsKCiAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0gPSB7IHVybDogdXJsLCBkYXRhOiBkYXRhLCBzcHJpdGVTaGVldDogZmFsc2UgfTsKCiAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0uZnJhbWUgPSBuZXcgUGhhc2VyLkZyYW1lKDAsIDAsIDAsIGRhdGEud2lkdGgsIGRhdGEuaGVpZ2h0LCBrZXksIHRoaXMuZ2FtZS5ybmQudXVpZCgpKTsKCiAgICAgICAgUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5CYXNlVGV4dHVyZShkYXRhKTsKICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVtrZXldID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IHNvdW5kLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRTb3VuZAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgc291bmQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhpcyBzb3VuZCBmaWxlLgogICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEV4dHJhIHNvdW5kIGRhdGEuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gd2ViQXVkaW8gLSBUcnVlIGlmIHRoZSBmaWxlIGlzIHVzaW5nIHdlYiBhdWRpby4KICAgICogQHBhcmFtIHtib29sZWFufSBhdWRpb1RhZyAtIFRydWUgaWYgdGhlIGZpbGUgaXMgdXNpbmcgbGVnYWN5IEhUTUwgYXVkaW8uCiAgICAqLwogICAgYWRkU291bmQ6IGZ1bmN0aW9uIChrZXksIHVybCwgZGF0YSwgd2ViQXVkaW8sIGF1ZGlvVGFnKSB7CgogICAgICAgIHdlYkF1ZGlvID0gd2ViQXVkaW8gfHwgdHJ1ZTsKICAgICAgICBhdWRpb1RhZyA9IGF1ZGlvVGFnIHx8IGZhbHNlOwoKICAgICAgICB2YXIgZGVjb2RlZCA9IGZhbHNlOwoKICAgICAgICBpZiAoYXVkaW9UYWcpCiAgICAgICAgewogICAgICAgICAgICBkZWNvZGVkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3NvdW5kc1trZXldID0geyB1cmw6IHVybCwgZGF0YTogZGF0YSwgaXNEZWNvZGluZzogZmFsc2UsIGRlY29kZWQ6IGRlY29kZWQsIHdlYkF1ZGlvOiB3ZWJBdWRpbywgYXVkaW9UYWc6IGF1ZGlvVGFnLCBsb2NrZWQ6IHRoaXMuZ2FtZS5zb3VuZC50b3VjaExvY2tlZCB9OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbG9hZCBhIHNvdW5kLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNyZWxvYWRTb3VuZAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgc291bmQuCiAgICAqLwogICAgcmVsb2FkU291bmQ6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fc291bmRzW2tleV0uZGF0YS5zcmMgPSB0aGlzLl9zb3VuZHNba2V5XS51cmw7CgogICAgICAgICAgICB0aGlzLl9zb3VuZHNba2V5XS5kYXRhLmFkZEV2ZW50TGlzdGVuZXIoJ2NhbnBsYXl0aHJvdWdoJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnJlbG9hZFNvdW5kQ29tcGxldGUoa2V5KTsKICAgICAgICAgICAgfSwgZmFsc2UpOwoKICAgICAgICAgICAgdGhpcy5fc291bmRzW2tleV0uZGF0YS5sb2FkKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogRmlyZXMgdGhlIG9uU291bmRVbmxvY2sgZXZlbnQgd2hlbiB0aGUgc291bmQgaGFzIGNvbXBsZXRlZCByZWxvYWRpbmcuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI3JlbG9hZFNvdW5kQ29tcGxldGUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHNvdW5kLgogICAgKi8KICAgIHJlbG9hZFNvdW5kQ29tcGxldGU6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fc291bmRzW2tleV0ubG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMub25Tb3VuZFVubG9jay5kaXNwYXRjaChrZXkpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGVzIHRoZSBzb3VuZCBvYmplY3QgaW4gdGhlIGNhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSN1cGRhdGVTb3VuZAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgc291bmQuCiAgICAqLwogICAgdXBkYXRlU291bmQ6IGZ1bmN0aW9uIChrZXksIHByb3BlcnR5LCB2YWx1ZSkgewogICAgICAgIAogICAgICAgIGlmICh0aGlzLl9zb3VuZHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3NvdW5kc1trZXldW3Byb3BlcnR5XSA9IHZhbHVlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgZGVjb2RlZCBzb3VuZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZGVjb2RlZFNvdW5kCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSBzb3VuZC4KICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBFeHRyYSBzb3VuZCBkYXRhLgogICAgKi8KICAgIGRlY29kZWRTb3VuZDogZnVuY3Rpb24gKGtleSwgZGF0YSkgewoKICAgICAgICB0aGlzLl9zb3VuZHNba2V5XS5kYXRhID0gZGF0YTsKICAgICAgICB0aGlzLl9zb3VuZHNba2V5XS5kZWNvZGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLl9zb3VuZHNba2V5XS5pc0RlY29kaW5nID0gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgY2FudmFzIG9iamVjdCBmcm9tIHRoZSBjYWNoZSBieSBpdHMga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRDYW52YXMKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgY2FudmFzIHRvIHJldHJpZXZlIGZyb20gdGhlIENhY2hlLgogICAgKiBAcmV0dXJuIHtvYmplY3R9IFRoZSBjYW52YXMgb2JqZWN0LgogICAgKi8KICAgIGdldENhbnZhczogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fY2FudmFzZXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jYW52YXNlc1trZXldLmNhbnZhczsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdQaGFzZXIuQ2FjaGUuZ2V0Q2FudmFzOiBJbnZhbGlkIGtleTogIicgKyBrZXkgKyAnIicpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgYSBCaXRtYXBEYXRhIG9iamVjdCBmcm9tIHRoZSBjYWNoZSBieSBpdHMga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRCaXRtYXBEYXRhCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIEJpdG1hcERhdGEgb2JqZWN0IHRvIHJldHJpZXZlIGZyb20gdGhlIENhY2hlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIHJlcXVlc3RlZCBCaXRtYXBEYXRhIG9iamVjdCBpZiBmb3VuZCwgb3IgbnVsbCBpZiBub3QuCiAgICAqLwogICAgZ2V0Qml0bWFwRGF0YTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fYml0bWFwRGF0YXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9iaXRtYXBEYXRhc1trZXldOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BoYXNlci5DYWNoZS5nZXRCaXRtYXBEYXRhOiBJbnZhbGlkIGtleTogIicgKyBrZXkgKyAnIicpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgaWYgYW4gaW1hZ2Uga2V5IGV4aXN0cy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjY2hlY2tJbWFnZUtleQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBpbWFnZSB0byBjaGVjayBpcyBpbiB0aGUgQ2FjaGUuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGtleSBleGlzdHMsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBjaGVja0ltYWdlS2V5OiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9pbWFnZXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBpbWFnZSBkYXRhIGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0SW1hZ2UKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgaW1hZ2UgdG8gcmV0cmlldmUgZnJvbSB0aGUgQ2FjaGUuCiAgICAqIEByZXR1cm4ge29iamVjdH0gVGhlIGltYWdlIGRhdGEuCiAgICAqLwogICAgZ2V0SW1hZ2U6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ltYWdlc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ltYWdlc1trZXldLmRhdGE7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignUGhhc2VyLkNhY2hlLmdldEltYWdlOiBJbnZhbGlkIGtleTogIicgKyBrZXkgKyAnIicpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgdGlsZW1hcCBkYXRhIGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0VGlsZW1hcAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSB0aWxlbWFwIGRhdGEgdG8gcmV0cmlldmUgZnJvbSB0aGUgQ2FjaGUuCiAgICAqIEByZXR1cm4ge09iamVjdH0gVGhlIHJhdyB0aWxlbWFwIGRhdGEgaW4gQ1NWIG9yIEpTT04gZm9ybWF0LgogICAgKi8KICAgIGdldFRpbGVtYXBEYXRhOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl90aWxlbWFwc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RpbGVtYXBzW2tleV07CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignUGhhc2VyLkNhY2hlLmdldFRpbGVtYXBEYXRhOiBJbnZhbGlkIGtleTogIicgKyBrZXkgKyAnIicpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgZnJhbWUgZGF0YSBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldEZyYW1lRGF0YQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBmcmFtZSBkYXRhIHRvIHJldHJpZXZlIGZyb20gdGhlIENhY2hlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWVEYXRhfSBUaGUgZnJhbWUgZGF0YS4KICAgICovCiAgICBnZXRGcmFtZURhdGE6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ltYWdlc1trZXldICYmIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lRGF0YSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBhIHNpbmdsZSBmcmFtZSBvdXQgb2YgYSBmcmFtZURhdGEgc2V0IGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0RnJhbWVCeUluZGV4CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIGZyYW1lIGRhdGEgdG8gcmV0cmlldmUgZnJvbSB0aGUgQ2FjaGUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZX0gVGhlIGZyYW1lIG9iamVjdC4KICAgICovCiAgICBnZXRGcmFtZUJ5SW5kZXg6IGZ1bmN0aW9uIChrZXksIGZyYW1lKSB7CgogICAgICAgIGlmICh0aGlzLl9pbWFnZXNba2V5XSAmJiB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhLmdldEZyYW1lKGZyYW1lKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgc2luZ2xlIGZyYW1lIG91dCBvZiBhIGZyYW1lRGF0YSBzZXQgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRGcmFtZUJ5TmFtZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBmcmFtZSBkYXRhIHRvIHJldHJpZXZlIGZyb20gdGhlIENhY2hlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWV9IFRoZSBmcmFtZSBvYmplY3QuCiAgICAqLwogICAgZ2V0RnJhbWVCeU5hbWU6IGZ1bmN0aW9uIChrZXksIGZyYW1lKSB7CgogICAgICAgIGlmICh0aGlzLl9pbWFnZXNba2V5XSAmJiB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhLmdldEZyYW1lQnlOYW1lKGZyYW1lKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgc2luZ2xlIGZyYW1lIGJ5IGtleS4gWW91J2Qgb25seSBkbyB0aGlzIHRvIGdldCB0aGUgZGVmYXVsdCBGcmFtZSBjcmVhdGVkIGZvciBhIG5vbi1hdGxhcy9zcHJpdGVzaGVldCBpbWFnZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0RnJhbWUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgZnJhbWUgZGF0YSB0byByZXRyaWV2ZSBmcm9tIHRoZSBDYWNoZS4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lfSBUaGUgZnJhbWUgZGF0YS4KICAgICovCiAgICBnZXRGcmFtZTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5faW1hZ2VzW2tleV0gJiYgdGhpcy5faW1hZ2VzW2tleV0uc3ByaXRlU2hlZXQgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgYSBzaW5nbGUgdGV4dHVyZSBmcmFtZSBieSBrZXkuIFlvdSdkIG9ubHkgZG8gdGhpcyB0byBnZXQgdGhlIGRlZmF1bHQgRnJhbWUgY3JlYXRlZCBmb3IgYSBub24tYXRsYXMvc3ByaXRlc2hlZXQgaW1hZ2UuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFRleHR1cmVGcmFtZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBmcmFtZSB0byByZXRyaWV2ZSBmcm9tIHRoZSBDYWNoZS4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lfSBUaGUgZnJhbWUgZGF0YS4KICAgICovCiAgICBnZXRUZXh0dXJlRnJhbWU6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3RleHR1cmVzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGV4dHVyZXNba2V5XS5mcmFtZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgUmVuZGVyVGV4dHVyZSBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFRleHR1cmUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgUmVuZGVyVGV4dHVyZSB0byByZXRyaWV2ZSBmcm9tIHRoZSBDYWNoZS4KICAgICogQHJldHVybiB7UGhhc2VyLlJlbmRlclRleHR1cmV9IFRoZSBSZW5kZXJUZXh0dXJlIG9iamVjdC4KICAgICovCiAgICBnZXRUZXh0dXJlOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl90ZXh0dXJlc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RleHR1cmVzW2tleV07CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignUGhhc2VyLkNhY2hlLmdldFRleHR1cmU6IEludmFsaWQga2V5OiAiJyArIGtleSArICciJyk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBzb3VuZCBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFNvdW5kCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIHNvdW5kIHRvIHJldHJpZXZlIGZyb20gdGhlIENhY2hlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuU291bmR9IFRoZSBzb3VuZCBvYmplY3QuCiAgICAqLwogICAgZ2V0U291bmQ6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NvdW5kc1trZXldOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BoYXNlci5DYWNoZS5nZXRTb3VuZDogSW52YWxpZCBrZXk6ICInICsga2V5ICsgJyInKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IHNvdW5kIGRhdGEgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRTb3VuZERhdGEKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgc291bmQgdG8gcmV0cmlldmUgZnJvbSB0aGUgQ2FjaGUuCiAgICAqIEByZXR1cm4ge29iamVjdH0gVGhlIHNvdW5kIGRhdGEuCiAgICAqLwogICAgZ2V0U291bmREYXRhOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9zb3VuZHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zb3VuZHNba2V5XS5kYXRhOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BoYXNlci5DYWNoZS5nZXRTb3VuZERhdGE6IEludmFsaWQga2V5OiAiJyArIGtleSArICciJyk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrIGlmIHRoZSBnaXZlbiBzb3VuZCBoYXMgZmluaXNoZWQgZGVjb2RpbmcuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2lzU291bmREZWNvZGVkCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIHNvdW5kIGluIHRoZSBDYWNoZS4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVGhlIGRlY29kZWQgc3RhdGUgb2YgdGhlIFNvdW5kIG9iamVjdC4KICAgICovCiAgICBpc1NvdW5kRGVjb2RlZDogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fc291bmRzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc291bmRzW2tleV0uZGVjb2RlZDsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgaWYgdGhlIGdpdmVuIHNvdW5kIGlzIHJlYWR5IGZvciBwbGF5YmFjay4gQSBzb3VuZCBpcyBjb25zaWRlcmVkIHJlYWR5IHdoZW4gaXQgaGFzIGZpbmlzaGVkIGRlY29kaW5nIGFuZCB0aGUgZGV2aWNlIGlzIG5vIGxvbmdlciB0b3VjaCBsb2NrZWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2lzU291bmRSZWFkeQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBzb3VuZCBpbiB0aGUgQ2FjaGUuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIHNvdW5kIGlzIGRlY29kZWQgYW5kIHRoZSBkZXZpY2UgaXMgbm90IHRvdWNoIGxvY2tlZC4KICAgICovCiAgICBpc1NvdW5kUmVhZHk6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgcmV0dXJuICh0aGlzLl9zb3VuZHNba2V5XSAmJiB0aGlzLl9zb3VuZHNba2V5XS5kZWNvZGVkICYmIHRoaXMuZ2FtZS5zb3VuZC50b3VjaExvY2tlZCA9PT0gZmFsc2UpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrIHdoZXRoZXIgYW4gaW1hZ2UgYXNzZXQgaXMgc3ByaXRlIHNoZWV0IG9yIG5vdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjaXNTcHJpdGVTaGVldAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBzcHJpdGUgc2hlZXQgeW91IHdhbnQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGltYWdlIGlzIGEgc3ByaXRlIHNoZWV0LgogICAgKi8KICAgIGlzU3ByaXRlU2hlZXQ6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ltYWdlc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ltYWdlc1trZXldLnNwcml0ZVNoZWV0OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCB0ZXh0IGRhdGEgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRUZXh0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIHRleHQgZGF0YSB0byByZXRyaWV2ZSBmcm9tIHRoZSBDYWNoZS4KICAgICogQHJldHVybiB7b2JqZWN0fSBUaGUgdGV4dCBkYXRhLgogICAgKi8KICAgIGdldFRleHQ6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3RleHRba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90ZXh0W2tleV0uZGF0YTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdQaGFzZXIuQ2FjaGUuZ2V0VGV4dDogSW52YWxpZCBrZXk6ICInICsga2V5ICsgJyInKTsKICAgICAgICB9CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgYmluYXJ5IGRhdGEgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRCaW5hcnkKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgYmluYXJ5IGRhdGEgb2JqZWN0IHRvIHJldHJpZXZlIGZyb20gdGhlIENhY2hlLgogICAgKiBAcmV0dXJuIHtvYmplY3R9IFRoZSBiaW5hcnkgZGF0YSBvYmplY3QuCiAgICAqLwogICAgZ2V0QmluYXJ5OiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9iaW5hcnlba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9iaW5hcnlba2V5XTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdQaGFzZXIuQ2FjaGUuZ2V0QmluYXJ5OiBJbnZhbGlkIGtleTogIicgKyBrZXkgKyAnIicpOwogICAgICAgIH0KICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCB0aGUgY2FjaGUga2V5cyBmcm9tIGEgZ2l2ZW4gYXJyYXkgb2Ygb2JqZWN0cy4KICAgICogTm9ybWFsbHkgeW91IGRvbid0IGNhbGwgdGhpcyBkaXJlY3RseSBidXQgaW5zdGVhZCB1c2UgZ2V0SW1hZ2VLZXlzLCBnZXRTb3VuZEtleXMsIGV0Yy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0S2V5cwogICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSAtIEFuIGFycmF5IG9mIGl0ZW1zIHRvIHJldHVybiB0aGUga2V5cyBmb3IuCiAgICAqIEByZXR1cm4ge0FycmF5fSBUaGUgYXJyYXkgb2YgaXRlbSBrZXlzLgogICAgKi8KICAgIGdldEtleXM6IGZ1bmN0aW9uIChhcnJheSkgewoKICAgICAgICB2YXIgb3V0cHV0ID0gW107CgogICAgICAgIGZvciAodmFyIGl0ZW0gaW4gYXJyYXkpCiAgICAgICAgewogICAgICAgICAgICBpZiAoaXRlbSAhPT0gJ19fZGVmYXVsdCcgJiYgaXRlbSAhPT0gJ19fbWlzc2luZycpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKGl0ZW0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gb3V0cHV0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYW4gYXJyYXkgY29udGFpbmluZyBhbGwgb2YgdGhlIGtleXMgb2YgSW1hZ2VzIGluIHRoZSBDYWNoZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0SW1hZ2VLZXlzCiAgICAqIEByZXR1cm4ge0FycmF5fSBUaGUgc3RyaW5nIGJhc2VkIGtleXMgaW4gdGhlIENhY2hlLgogICAgKi8KICAgIGdldEltYWdlS2V5czogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldEtleXModGhpcy5faW1hZ2VzKTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYW4gYXJyYXkgY29udGFpbmluZyBhbGwgb2YgdGhlIGtleXMgb2YgU291bmRzIGluIHRoZSBDYWNoZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0U291bmRLZXlzCiAgICAqIEByZXR1cm4ge0FycmF5fSBUaGUgc3RyaW5nIGJhc2VkIGtleXMgaW4gdGhlIENhY2hlLgogICAgKi8KICAgIGdldFNvdW5kS2V5czogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldEtleXModGhpcy5fc291bmRzKTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYW4gYXJyYXkgY29udGFpbmluZyBhbGwgb2YgdGhlIGtleXMgb2YgVGV4dCBGaWxlcyBpbiB0aGUgQ2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFRleHRLZXlzCiAgICAqIEByZXR1cm4ge0FycmF5fSBUaGUgc3RyaW5nIGJhc2VkIGtleXMgaW4gdGhlIENhY2hlLgogICAgKi8KICAgIGdldFRleHRLZXlzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0S2V5cyh0aGlzLl90ZXh0KTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgYSBjYW52YXMgZnJvbSB0aGUgY2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI3JlbW92ZUNhbnZhcwogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gS2V5IG9mIHRoZSBhc3NldCB5b3Ugd2FudCB0byByZW1vdmUuCiAgICAqLwogICAgcmVtb3ZlQ2FudmFzOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2NhbnZhc2VzW2tleV07CiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGFuIGltYWdlIGZyb20gdGhlIGNhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNyZW1vdmVJbWFnZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gS2V5IG9mIHRoZSBhc3NldCB5b3Ugd2FudCB0byByZW1vdmUuCiAgICAqLwogICAgcmVtb3ZlSW1hZ2U6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBkZWxldGUgdGhpcy5faW1hZ2VzW2tleV07CiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGEgc291bmQgZnJvbSB0aGUgY2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI3JlbW92ZVNvdW5kCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIGFzc2V0IHlvdSB3YW50IHRvIHJlbW92ZS4KICAgICovCiAgICByZW1vdmVTb3VuZDogZnVuY3Rpb24gKGtleSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9zb3VuZHNba2V5XTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgYSB0ZXh0IGZyb20gdGhlIGNhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNyZW1vdmVUZXh0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIGFzc2V0IHlvdSB3YW50IHRvIHJlbW92ZS4KICAgICovCiAgICByZW1vdmVUZXh0OiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX3RleHRba2V5XTsKICAgIH0sCgogICAgLyoqCiAgICAqIENsZWFycyB0aGUgY2FjaGUuIFJlbW92ZXMgZXZlcnkgbG9jYWwgY2FjaGUgb2JqZWN0IHJlZmVyZW5jZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIgaXRlbSBpbiB0aGlzLl9jYW52YXNlcykKICAgICAgICB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9jYW52YXNlc1tpdGVtWydrZXknXV07CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpdGVtIGluIHRoaXMuX2ltYWdlcykKICAgICAgICB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbWFnZXNbaXRlbVsna2V5J11dOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaXRlbSBpbiB0aGlzLl9zb3VuZHMpCiAgICAgICAgewogICAgICAgICAgICBkZWxldGUgdGhpcy5fc291bmRzW2l0ZW1bJ2tleSddXTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGl0ZW0gaW4gdGhpcy5fdGV4dCkKICAgICAgICB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl90ZXh0W2l0ZW1bJ2tleSddXTsKICAgICAgICB9CiAgICB9Cgp9OwoKUGhhc2VyLkNhY2hlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5DYWNoZTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlciBsb2FkZXIgY29uc3RydWN0b3IuCiogVGhlIExvYWRlciBoYW5kbGVzIGxvYWRpbmcgYWxsIGV4dGVybmFsIGNvbnRlbnQgc3VjaCBhcyBJbWFnZXMsIFNvdW5kcywgVGV4dHVyZSBBdGxhc2VzIGFuZCBkYXRhIGZpbGVzLgoqIEl0IHVzZXMgYSBjb21iaW5hdGlvbiBvZiBJbWFnZSgpIGxvYWRpbmcgYW5kIHhociBhbmQgcHJvdmlkZXMgcHJvZ3Jlc3MgYW5kIGNvbXBsZXRpb24gY2FsbGJhY2tzLgoqIEBjbGFzcyBQaGFzZXIuTG9hZGVyCiogQGNsYXNzZGVzYyAgVGhlIExvYWRlciBoYW5kbGVzIGxvYWRpbmcgYWxsIGV4dGVybmFsIGNvbnRlbnQgc3VjaCBhcyBJbWFnZXMsIFNvdW5kcywgVGV4dHVyZSBBdGxhc2VzIGFuZCBkYXRhIGZpbGVzLgoqIEl0IHVzZXMgYSBjb21iaW5hdGlvbiBvZiBJbWFnZSgpIGxvYWRpbmcgYW5kIHhociBhbmQgcHJvdmlkZXMgcHJvZ3Jlc3MgYW5kIGNvbXBsZXRpb24gY2FsbGJhY2tzLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLkxvYWRlciA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBMb2NhbCByZWZlcmVuY2UgdG8gZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBfZmlsZUxpc3QgLSBDb250YWlucyBhbGwgdGhlIGFzc2V0cyBmaWxlIGluZm9zLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2ZpbGVMaXN0ID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZmlsZUluZGV4IC0gVGhlIGluZGV4IG9mIHRoZSBjdXJyZW50IGZpbGUgYmVpbmcgbG9hZGVkLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2ZpbGVJbmRleCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfcHJvZ3Jlc3NDaHVuayAtIEluZGljYXRlcyB0aGUgc2l6ZSBvZiAxIGZpbGUgaW4gdGVybXMgb2YgYSBwZXJjZW50YWdlIG91dCBvZiAxMDAuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fcHJvZ3Jlc3NDaHVuayA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7WE1MSHR0cFJlcXVlc3R9IC0gQW4gWE1MSHR0cFJlcXVlc3Qgb2JqZWN0IHVzZWQgZm9yIGxvYWRpbmcgdGV4dCBhbmQgYXVkaW8gZGF0YS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl94aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc0xvYWRpbmcgLSBUcnVlIGlmIHRoZSBMb2FkZXIgaXMgaW4gdGhlIHByb2Nlc3Mgb2YgbG9hZGluZyB0aGUgcXVldWUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBoYXNMb2FkZWQgLSBUcnVlIGlmIGFsbCBhc3NldHMgaW4gdGhlIHF1ZXVlIGhhdmUgZmluaXNoZWQgbG9hZGluZy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmhhc0xvYWRlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcHJvZ3Jlc3MgLSBUaGUgcm91bmRlZCBsb2FkIHByb2dyZXNzIHBlcmNlbnRhZ2UgdmFsdWUgKGZyb20gMCB0byAxMDApCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wcm9ncmVzcyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwcm9ncmVzc0Zsb2F0IC0gVGhlIG5vbi1yb3VuZGVkIGxvYWQgcHJvZ3Jlc3MgdmFsdWUgKGZyb20gMC4wIHRvIDEwMC4wKQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucHJvZ3Jlc3NGbG9hdCA9IDA7CgogICAgLyoqCiAgICAqIFlvdSBjYW4gb3B0aW9uYWxseSBsaW5rIGEgc3ByaXRlIHRvIHRoZSBwcmVsb2FkZXIuCiAgICAqIElmIHlvdSBkbyBzbyB0aGUgU3ByaXRlJ3Mgd2lkdGggb3IgaGVpZ2h0IHdpbGwgYmUgY3JvcHBlZCBiYXNlZCBvbiB0aGUgcGVyY2VudGFnZSBsb2FkZWQuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNwcml0ZX0gcHJlbG9hZFNwcml0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucHJlbG9hZFNwcml0ZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjcm9zc09yaWdpbiAtIFRoZSBjcm9zc09yaWdpbiB2YWx1ZSBhcHBsaWVkIHRvIGxvYWRlZCBpbWFnZXMKICAgICovCiAgICB0aGlzLmNyb3NzT3JpZ2luID0gJyc7CgogICAgLyoqCiAgICAqIElmIHlvdSB3YW50IHRvIGFwcGVuZCBhIFVSTCBiZWZvcmUgdGhlIHBhdGggb2YgYW55IGFzc2V0IHlvdSBjYW4gc2V0IHRoaXMgaGVyZS4KICAgICogVXNlZnVsIGlmIHlvdSBuZWVkIHRvIGFsbG93IGFuIGFzc2V0IHVybCB0byBiZSBjb25maWd1cmVkIG91dHNpZGUgb2YgdGhlIGdhbWUgY29kZS4KICAgICogTVVTVCBoYXZlIC8gb24gdGhlIGVuZCBvZiBpdCEKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGJhc2VVUkwKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmJhc2VVUkwgPSAnJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkZpbGVDb21wbGV0ZSAtIEV2ZW50IHNpZ25hbC4KICAgICovCiAgICB0aGlzLm9uRmlsZUNvbXBsZXRlID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25GaWxlRXJyb3IgLSBFdmVudCBzaWduYWwuCiAgICAqLwogICAgdGhpcy5vbkZpbGVFcnJvciA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uTG9hZFN0YXJ0IC0gRXZlbnQgc2lnbmFsLgogICAgKi8KICAgIHRoaXMub25Mb2FkU3RhcnQgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkxvYWRDb21wbGV0ZSAtIEV2ZW50IHNpZ25hbC4KICAgICovCiAgICB0aGlzLm9uTG9hZENvbXBsZXRlID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCn07CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9BUlJBWSA9IDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9IQVNIID0gMTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19YTUxfU1RBUkxJTkcgPSAyOwoKUGhhc2VyLkxvYWRlci5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFlvdSBjYW4gc2V0IGEgU3ByaXRlIHRvIGJlIGEgInByZWxvYWQiIHNwcml0ZSBieSBwYXNzaW5nIGl0IHRvIHRoaXMgbWV0aG9kLgogICAgKiBBICJwcmVsb2FkIiBzcHJpdGUgd2lsbCBoYXZlIGl0cyB3aWR0aCBvciBoZWlnaHQgY3JvcCBhZGp1c3RlZCBiYXNlZCBvbiB0aGUgcGVyY2VudGFnZSBvZiB0aGUgbG9hZGVyIGluIHJlYWwtdGltZS4KICAgICogVGhpcyBhbGxvd3MgeW91IHRvIGVhc2lseSBtYWtlIGxvYWRpbmcgYmFycyBmb3IgZ2FtZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNzZXRQcmVsb2FkU3ByaXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gVGhlIHNwcml0ZSB0aGF0IHdpbGwgYmUgY3JvcHBlZCBkdXJpbmcgdGhlIGxvYWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZGlyZWN0aW9uPTBdIC0gQSB2YWx1ZSBvZiB6ZXJvIG1lYW5zIHRoZSBzcHJpdGUgd2lkdGggd2lsbCBiZSBjcm9wcGVkLCBhIHZhbHVlIG9mIDEgbWVhbnMgaXRzIGhlaWdodCB3aWxsIGJlIGNyb3BwZWQuCiAgICAqLwogICAgc2V0UHJlbG9hZFNwcml0ZTogZnVuY3Rpb24gKHNwcml0ZSwgZGlyZWN0aW9uKSB7CgogICAgICAgIGRpcmVjdGlvbiA9IGRpcmVjdGlvbiB8fCAwOwoKICAgICAgICB0aGlzLnByZWxvYWRTcHJpdGUgPSB7IHNwcml0ZTogc3ByaXRlLCBkaXJlY3Rpb246IGRpcmVjdGlvbiwgd2lkdGg6IHNwcml0ZS53aWR0aCwgaGVpZ2h0OiBzcHJpdGUuaGVpZ2h0LCBjcm9wOiBudWxsIH07CgogICAgICAgIGlmIChkaXJlY3Rpb24gPT09IDApCiAgICAgICAgewogICAgICAgICAgICAvLyAgSG9yaXpvbnRhbCBjcm9wCiAgICAgICAgICAgIHRoaXMucHJlbG9hZFNwcml0ZS5jcm9wID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoMCwgMCwgMSwgc3ByaXRlLmhlaWdodCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBWZXJ0aWNhbCBjcm9wCiAgICAgICAgICAgIHRoaXMucHJlbG9hZFNwcml0ZS5jcm9wID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoMCwgMCwgc3ByaXRlLndpZHRoLCAxKTsKICAgICAgICB9CgogICAgICAgIHNwcml0ZS5jcm9wID0gdGhpcy5wcmVsb2FkU3ByaXRlLmNyb3A7CiAgICAgICAgc3ByaXRlLmNyb3BFbmFibGVkID0gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayB3aGV0aGVyIGFzc2V0IGV4aXN0cyB3aXRoIGEgc3BlY2lmaWMga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjY2hlY2tLZXlFeGlzdHMKICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgLSBUaGUgdHlwZSBhc3NldCB5b3Ugd2FudCB0byBjaGVjay4KICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEtleSBvZiB0aGUgYXNzZXQgeW91IHdhbnQgdG8gY2hlY2suCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybiB0cnVlIGlmIGV4aXN0cywgb3RoZXJ3aXNlIHJldHVybiBmYWxzZS4KICAgICovCiAgICBjaGVja0tleUV4aXN0czogZnVuY3Rpb24gKHR5cGUsIGtleSkgewoKICAgICAgICBpZiAodGhpcy5fZmlsZUxpc3QubGVuZ3RoID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fZmlsZUxpc3QubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9maWxlTGlzdFtpXS50eXBlID09PSB0eXBlICYmIHRoaXMuX2ZpbGVMaXN0W2ldLmtleSA9PT0ga2V5KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXRzIHRoZSBhc3NldCB0aGF0IGlzIHF1ZXVlZCBmb3IgbG9hZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2dldEFzc2V0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIC0gVGhlIHR5cGUgYXNzZXQgeW91IHdhbnQgdG8gY2hlY2suCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIGFzc2V0IHlvdSB3YW50IHRvIGNoZWNrLgogICAgKiBAcmV0dXJuIHthbnl9IFJldHVybnMgYW4gb2JqZWN0IGlmIGZvdW5kIHRoYXQgaGFzIDIgcHJvcGVydGllczogaW5kZXggYW5kIGZpbGUuIE90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBnZXRBc3NldDogZnVuY3Rpb24gKHR5cGUsIGtleSkgewoKICAgICAgICBpZiAodGhpcy5fZmlsZUxpc3QubGVuZ3RoID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fZmlsZUxpc3QubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9maWxlTGlzdFtpXS50eXBlID09PSB0eXBlICYmIHRoaXMuX2ZpbGVMaXN0W2ldLmtleSA9PT0ga2V5KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB7IGluZGV4OiBpLCBmaWxlOiB0aGlzLl9maWxlTGlzdFtpXSB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXNldCBsb2FkZXIsIHRoaXMgd2lsbCByZW1vdmUgdGhlIGxvYWQgcXVldWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNyZXNldAogICAgKi8KICAgIHJlc2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMucHJlbG9hZFNwcml0ZSA9IG51bGw7CiAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLl9maWxlTGlzdC5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuX2ZpbGVJbmRleCA9IDA7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCBhZGRzIGEgbmV3IGVudHJ5IHRvIHRoZSBmaWxlIGxpc3QuIERvIG5vdCBjYWxsIGRpcmVjdGx5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjYWRkVG9GaWxlTGlzdAogICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSAtIFRoZSB0eXBlIG9mIHJlc291cmNlIHRvIGFkZCB0byB0aGUgbGlzdCAoaW1hZ2UsIGF1ZGlvLCB4bWwsIGV0YykuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgdW5pcXVlIENhY2hlIElEIGtleSBvZiB0aGlzIHJlc291cmNlLgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIFVSTCB0aGUgYXNzZXQgd2lsbCBiZSBsb2FkZWQgZnJvbS4KICAgICogQHBhcmFtIHtvYmplY3R9IHByb3BlcnRpZXMgLSBBbnkgYWRkaXRpb25hbCBwcm9wZXJ0aWVzIG5lZWRlZCB0byBsb2FkIHRoZSBmaWxlLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgYWRkVG9GaWxlTGlzdDogZnVuY3Rpb24gKHR5cGUsIGtleSwgdXJsLCBwcm9wZXJ0aWVzKSB7CgogICAgICAgIHZhciBlbnRyeSA9IHsKICAgICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICBkYXRhOiBudWxsLAogICAgICAgICAgICBlcnJvcjogZmFsc2UsCiAgICAgICAgICAgIGxvYWRlZDogZmFsc2UKICAgICAgICB9OwoKICAgICAgICBpZiAodHlwZW9mIHByb3BlcnRpZXMgIT09ICJ1bmRlZmluZWQiKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBwcm9wZXJ0aWVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlbnRyeVtwcm9wXSA9IHByb3BlcnRpZXNbcHJvcF07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNoZWNrS2V5RXhpc3RzKHR5cGUsIGtleSkgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZmlsZUxpc3QucHVzaChlbnRyeSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIGZ1bmN0aW9uIHRoYXQgcmVwbGFjZXMgYW4gZXhpc3RpbmcgZW50cnkgaW4gdGhlIGZpbGUgbGlzdCB3aXRoIGEgbmV3IG9uZS4gRG8gbm90IGNhbGwgZGlyZWN0bHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNyZXBsYWNlSW5GaWxlTGlzdAogICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSAtIFRoZSB0eXBlIG9mIHJlc291cmNlIHRvIGFkZCB0byB0aGUgbGlzdCAoaW1hZ2UsIGF1ZGlvLCB4bWwsIGV0YykuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgdW5pcXVlIENhY2hlIElEIGtleSBvZiB0aGlzIHJlc291cmNlLgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIFVSTCB0aGUgYXNzZXQgd2lsbCBiZSBsb2FkZWQgZnJvbS4KICAgICogQHBhcmFtIHtvYmplY3R9IHByb3BlcnRpZXMgLSBBbnkgYWRkaXRpb25hbCBwcm9wZXJ0aWVzIG5lZWRlZCB0byBsb2FkIHRoZSBmaWxlLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcmVwbGFjZUluRmlsZUxpc3Q6IGZ1bmN0aW9uICh0eXBlLCBrZXksIHVybCwgcHJvcGVydGllcykgewoKICAgICAgICB2YXIgZW50cnkgPSB7CiAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICAgICAgZXJyb3I6IGZhbHNlLAogICAgICAgICAgICBsb2FkZWQ6IGZhbHNlCiAgICAgICAgfTsKCiAgICAgICAgaWYgKHR5cGVvZiBwcm9wZXJ0aWVzICE9PSAidW5kZWZpbmVkIikKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gcHJvcGVydGllcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZW50cnlbcHJvcF0gPSBwcm9wZXJ0aWVzW3Byb3BdOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jaGVja0tleUV4aXN0cyh0eXBlLCBrZXkpID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ZpbGVMaXN0LnB1c2goZW50cnkpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYW4gaW1hZ2UgdG8gdGhlIExvYWRlci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2ltYWdlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoaXMgaW1hZ2UgZmlsZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiBpbWFnZSBmaWxlLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvdmVyd3JpdGU9ZmFsc2VdIC0gSWYgYW4gdW5sb2FkZWQgZmlsZSB3aXRoIGEgbWF0Y2hpbmcga2V5IGFscmVhZHkgZXhpc3RzIGluIHRoZSBxdWV1ZSwgdGhpcyBlbnRyeSB3aWxsIG92ZXJ3cml0ZSBpdC4KICAgICogQHJldHVybiB7UGhhc2VyLkxvYWRlcn0gVGhpcyBMb2FkZXIgaW5zdGFuY2UuCiAgICAqLwogICAgaW1hZ2U6IGZ1bmN0aW9uIChrZXksIHVybCwgb3ZlcndyaXRlKSB7CgogICAgICAgIGlmICh0eXBlb2Ygb3ZlcndyaXRlID09PSAidW5kZWZpbmVkIikgeyBvdmVyd3JpdGUgPSBmYWxzZTsgfQoKICAgICAgICBpZiAob3ZlcndyaXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZXBsYWNlSW5GaWxlTGlzdCgnaW1hZ2UnLCBrZXksIHVybCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYWRkVG9GaWxlTGlzdCgnaW1hZ2UnLCBrZXksIHVybCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSB0ZXh0IGZpbGUgdG8gdGhlIExvYWRlci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3RleHQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIHRleHQgZmlsZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGUgdGV4dCBmaWxlLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvdmVyd3JpdGU9ZmFsc2VdIC0gSWYgYW4gdW5sb2FkZWQgZmlsZSB3aXRoIGEgbWF0Y2hpbmcga2V5IGFscmVhZHkgZXhpc3RzIGluIHRoZSBxdWV1ZSwgdGhpcyBlbnRyeSB3aWxsIG92ZXJ3cml0ZSBpdC4KICAgICogQHJldHVybiB7UGhhc2VyLkxvYWRlcn0gVGhpcyBMb2FkZXIgaW5zdGFuY2UuCiAgICAqLwogICAgdGV4dDogZnVuY3Rpb24gKGtleSwgdXJsLCBvdmVyd3JpdGUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBvdmVyd3JpdGUgPT09ICJ1bmRlZmluZWQiKSB7IG92ZXJ3cml0ZSA9IGZhbHNlOyB9CgogICAgICAgIGlmIChvdmVyd3JpdGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnJlcGxhY2VJbkZpbGVMaXN0KCd0ZXh0Jywga2V5LCB1cmwpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFkZFRvRmlsZUxpc3QoJ3RleHQnLCBrZXksIHVybCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBKYXZhU2NyaXB0IGZpbGUgdG8gdGhlIExvYWRlci4gT25jZSBsb2FkZWQgdGhlIEphdmFTY3JpcHQgZmlsZSB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgdHVybmVkIGludG8gYSBzY3JpcHQgdGFnIChhbmQgZXhlY3V0ZWQpLCBzbyBiZSBjYXJlZnVsIHdoYXQgeW91IGxvYWQhCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNzY3JpcHQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIHNjcmlwdCBmaWxlLgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoZSBKYXZhU2NyaXB0IGZpbGUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Mb2FkZXJ9IFRoaXMgTG9hZGVyIGluc3RhbmNlLgogICAgKi8KICAgIHNjcmlwdDogZnVuY3Rpb24gKGtleSwgdXJsKSB7CgogICAgICAgIHRoaXMuYWRkVG9GaWxlTGlzdCgnc2NyaXB0Jywga2V5LCB1cmwpOwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBiaW5hcnkgZmlsZSB0byB0aGUgTG9hZGVyLiBJdCB3aWxsIGJlIGxvYWRlZCB2aWEgeGhyIHdpdGggYSByZXNwb25zZVR5cGUgb2YgImFycmF5YnVmZmVyIi4gWW91IGNhbiBzcGVjaWZ5IGFuIG9wdGlvbmFsIGNhbGxiYWNrIHRvIHByb2Nlc3MgdGhlIGZpbGUgYWZ0ZXIgbG9hZC4KICAgICogV2hlbiB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkIGl0IHdpbGwgYmUgcGFzc2VkIDIgcGFyYW1ldGVyczogdGhlIGtleSBvZiB0aGUgZmlsZSBhbmQgdGhlIGZpbGUgZGF0YS4KICAgICogV0FSTklORzogSWYgeW91IHNwZWNpZnkgYSBjYWxsYmFjaywgdGhlIGZpbGUgZGF0YSB3aWxsIGJlIHNldCB0byB3aGF0ZXZlciB5b3VyIGNhbGxiYWNrIHJldHVybnMuIFNvIGFsd2F5cyByZXR1cm4gdGhlIGRhdGEgb2JqZWN0LCBldmVuIGlmIHlvdSBkaWRuJ3QgbW9kaWZ5IGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjYmluYXJ5CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSBiaW5hcnkgZmlsZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGUgYmluYXJ5IGZpbGUuCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtjYWxsYmFja10gLSBPcHRpb25hbCBjYWxsYmFjayB0aGF0IHdpbGwgYmUgcGFzc2VkIHRoZSBmaWxlIGFmdGVyIGxvYWRpbmcsIHNvIHlvdSBjYW4gcGVyZm9ybSBhZGRpdGlvbmFsIHByb2Nlc3Npbmcgb24gaXQuCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtjYWxsYmFja0NvbnRleHRdIC0gVGhlIGNvbnRleHQgdW5kZXIgd2hpY2ggdGhlIGNhbGxiYWNrIHdpbGwgYmUgYXBwbGllZC4gSWYgbm90IHNwZWNpZmllZCBpdCB3aWxsIHVzZSB0aGUgY2FsbGJhY2sgaXRzZWxmIGFzIHRoZSBjb250ZXh0LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuTG9hZGVyfSBUaGlzIExvYWRlciBpbnN0YW5jZS4KICAgICovCiAgICBiaW5hcnk6IGZ1bmN0aW9uIChrZXksIHVybCwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAndW5kZWZpbmVkJykgeyBjYWxsYmFjayA9IGZhbHNlOyB9CiAgICAgICAgaWYgKGNhbGxiYWNrICE9PSBmYWxzZSAmJiB0eXBlb2YgY2FsbGJhY2tDb250ZXh0ID09PSAndW5kZWZpbmVkJykgeyBjYWxsYmFja0NvbnRleHQgPSBjYWxsYmFjazsgfQoKICAgICAgICB0aGlzLmFkZFRvRmlsZUxpc3QoJ2JpbmFyeScsIGtleSwgdXJsLCB7IGNhbGxiYWNrOiBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0OiBjYWxsYmFja0NvbnRleHQgfSk7CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBzcHJpdGUgc2hlZXQgdG8gdGhlIGxvYWRlci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3Nwcml0ZXNoZWV0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSBzaGVldCBmaWxlLgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoZSBzaGVldCBmaWxlLgogICAgKiBAcGFyYW0ge251bWJlcn0gZnJhbWVXaWR0aCAtIFdpZHRoIG9mIGVhY2ggc2luZ2xlIGZyYW1lLgogICAgKiBAcGFyYW0ge251bWJlcn0gZnJhbWVIZWlnaHQgLSBIZWlnaHQgb2YgZWFjaCBzaW5nbGUgZnJhbWUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJhbWVNYXg9LTFdIC0gSG93IG1hbnkgZnJhbWVzIGluIHRoaXMgc3ByaXRlIHNoZWV0LiBJZiBub3Qgc3BlY2lmaWVkIGl0IHdpbGwgZGl2aWRlIHRoZSB3aG9sZSBpbWFnZSBpbnRvIGZyYW1lcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFttYXJnaW49MF0gLSBJZiB0aGUgZnJhbWVzIGhhdmUgYmVlbiBkcmF3biB3aXRoIGEgbWFyZ2luLCBzcGVjaWZ5IHRoZSBhbW91bnQgaGVyZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGFjaW5nPTBdIC0gSWYgdGhlIGZyYW1lcyBoYXZlIGJlZW4gZHJhd24gd2l0aCBzcGFjaW5nIGJldHdlZW4gdGhlbSwgc3BlY2lmeSB0aGUgYW1vdW50IGhlcmUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Mb2FkZXJ9IFRoaXMgTG9hZGVyIGluc3RhbmNlLgogICAgKi8KICAgIHNwcml0ZXNoZWV0OiBmdW5jdGlvbiAoa2V5LCB1cmwsIGZyYW1lV2lkdGgsIGZyYW1lSGVpZ2h0LCBmcmFtZU1heCwgbWFyZ2luLCBzcGFjaW5nKSB7CgogICAgICAgIGlmICh0eXBlb2YgZnJhbWVNYXggPT09ICJ1bmRlZmluZWQiKSB7IGZyYW1lTWF4ID0gLTE7IH0KICAgICAgICBpZiAodHlwZW9mIG1hcmdpbiA9PT0gInVuZGVmaW5lZCIpIHsgbWFyZ2luID0gMDsgfQogICAgICAgIGlmICh0eXBlb2Ygc3BhY2luZyA9PT0gInVuZGVmaW5lZCIpIHsgc3BhY2luZyA9IDA7IH0KCiAgICAgICAgdGhpcy5hZGRUb0ZpbGVMaXN0KCdzcHJpdGVzaGVldCcsIGtleSwgdXJsLCB7IGZyYW1lV2lkdGg6IGZyYW1lV2lkdGgsIGZyYW1lSGVpZ2h0OiBmcmFtZUhlaWdodCwgZnJhbWVNYXg6IGZyYW1lTWF4LCBtYXJnaW46IG1hcmdpbiwgc3BhY2luZzogc3BhY2luZyB9KTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IGF1ZGlvIGZpbGUgdG8gdGhlIGxvYWRlci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2F1ZGlvCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSBhdWRpbyBmaWxlLgogICAgKiBAcGFyYW0ge0FycmF5fHN0cmluZ30gdXJscyAtIEFuIGFycmF5IGNvbnRhaW5pbmcgdGhlIFVSTHMgb2YgdGhlIGF1ZGlvIGZpbGVzLCBpLmUuOiBbICdqdW1wLm1wMycsICdqdW1wLm9nZycsICdqdW1wLm00YScgXSBvciBhIHNpbmdsZSBzdHJpbmcgY29udGFpbmluZyBqdXN0IG9uZSBVUkwuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gYXV0b0RlY29kZSAtIFdoZW4gdXNpbmcgV2ViIEF1ZGlvIHRoZSBhdWRpbyBmaWxlcyBjYW4gZWl0aGVyIGJlIGRlY29kZWQgYXQgbG9hZCB0aW1lIG9yIHJ1bi10aW1lLiBUaGV5IGNhbid0IGJlIHBsYXllZCB1bnRpbCB0aGV5IGFyZSBkZWNvZGVkLCBidXQgdGhpcyBsZXQncyB5b3UgY29udHJvbCB3aGVuIHRoYXQgaGFwcGVucy4gRGVjb2RpbmcgaXMgYSBub24tYmxvY2tpbmcgYXN5bmMgcHJvY2Vzcy4KICAgICogQHJldHVybiB7UGhhc2VyLkxvYWRlcn0gVGhpcyBMb2FkZXIgaW5zdGFuY2UuCiAgICAqLwogICAgYXVkaW86IGZ1bmN0aW9uIChrZXksIHVybHMsIGF1dG9EZWNvZGUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBhdXRvRGVjb2RlID09PSAidW5kZWZpbmVkIikgeyBhdXRvRGVjb2RlID0gdHJ1ZTsgfQoKICAgICAgICB0aGlzLmFkZFRvRmlsZUxpc3QoJ2F1ZGlvJywga2V5LCB1cmxzLCB7IGJ1ZmZlcjogbnVsbCwgYXV0b0RlY29kZTogYXV0b0RlY29kZSB9KTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IHRpbGVtYXAgbG9hZGluZyByZXF1ZXN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjdGlsZW1hcAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGFzc2V0IGtleSBvZiB0aGUgdGlsZW1hcCBkYXRhLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW21hcERhdGFVUkxdIC0gVGhlIHVybCBvZiB0aGUgbWFwIGRhdGEgZmlsZSAoY3N2L2pzb24pCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBbbWFwRGF0YV0gLSBBbiBvcHRpb25hbCBKU09OIGRhdGEgb2JqZWN0LiBJZiBnaXZlbiB0aGVuIHRoZSBtYXBEYXRhVVJMIGlzIGlnbm9yZWQgYW5kIHRoaXMgSlNPTiBvYmplY3QgaXMgdXNlZCBmb3IgbWFwIGRhdGEgaW5zdGVhZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtmb3JtYXQ9UGhhc2VyLlRpbGVtYXAuQ1NWXSAtIFRoZSBmb3JtYXQgb2YgdGhlIG1hcCBkYXRhLiBFaXRoZXIgUGhhc2VyLlRpbGVtYXAuQ1NWIG9yIFBoYXNlci5UaWxlbWFwLlRJTEVEX0pTT04uCiAgICAqIEByZXR1cm4ge1BoYXNlci5Mb2FkZXJ9IFRoaXMgTG9hZGVyIGluc3RhbmNlLgogICAgKi8KICAgIHRpbGVtYXA6IGZ1bmN0aW9uIChrZXksIG1hcERhdGFVUkwsIG1hcERhdGEsIGZvcm1hdCkgewoKICAgICAgICBpZiAodHlwZW9mIG1hcERhdGFVUkwgPT09ICJ1bmRlZmluZWQiKSB7IG1hcERhdGFVUkwgPSBudWxsOyB9CiAgICAgICAgaWYgKHR5cGVvZiBtYXBEYXRhID09PSAidW5kZWZpbmVkIikgeyBtYXBEYXRhID0gbnVsbDsgfQogICAgICAgIGlmICh0eXBlb2YgZm9ybWF0ID09PSAidW5kZWZpbmVkIikgeyBmb3JtYXQgPSBQaGFzZXIuVGlsZW1hcC5DU1Y7IH0KCiAgICAgICAgaWYgKG1hcERhdGFVUkwgPT0gbnVsbCAmJiBtYXBEYXRhID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BoYXNlci5Mb2FkZXIudGlsZW1hcCAtIEJvdGggbWFwRGF0YVVSTCBhbmQgbWFwRGF0YSBhcmUgbnVsbC4gT25lIG11c3QgYmUgc2V0LicpOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQoKICAgICAgICAvLyAgQSBtYXAgZGF0YSBvYmplY3QgaGFzIGJlZW4gZ2l2ZW4KICAgICAgICBpZiAobWFwRGF0YSkKICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoZm9ybWF0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgQSBjc3Ygc3RyaW5nIG9yIG9iamVjdCBoYXMgYmVlbiBnaXZlbgogICAgICAgICAgICAgICAgY2FzZSBQaGFzZXIuVGlsZW1hcC5DU1Y6CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgLy8gIEFuIHhtbCBzdHJpbmcgb3Igb2JqZWN0IGhhcyBiZWVuIGdpdmVuCiAgICAgICAgICAgICAgICBjYXNlIFBoYXNlci5UaWxlbWFwLlRJTEVEX0pTT046CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbWFwRGF0YSA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBtYXBEYXRhID0gSlNPTi5wYXJzZShtYXBEYXRhKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5hZGRUaWxlbWFwKGtleSwgbnVsbCwgbWFwRGF0YSwgZm9ybWF0KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hZGRUb0ZpbGVMaXN0KCd0aWxlbWFwJywga2V5LCBtYXBEYXRhVVJMLCB7IGZvcm1hdDogZm9ybWF0IH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IGJpdG1hcCBmb250IGxvYWRpbmcgcmVxdWVzdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2JpdG1hcEZvbnQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIGJpdG1hcCBmb250LgogICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dHVyZVVSTCAtIFRoZSB1cmwgb2YgdGhlIGZvbnQgaW1hZ2UgZmlsZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IFt4bWxVUkxdIC0gVGhlIHVybCBvZiB0aGUgZm9udCBkYXRhIGZpbGUgKHhtbC9mbnQpCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBbeG1sRGF0YV0gLSBBbiBvcHRpb25hbCBYTUwgZGF0YSBvYmplY3QuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Mb2FkZXJ9IFRoaXMgTG9hZGVyIGluc3RhbmNlLgogICAgKi8KICAgIGJpdG1hcEZvbnQ6IGZ1bmN0aW9uIChrZXksIHRleHR1cmVVUkwsIHhtbFVSTCwgeG1sRGF0YSkgewoKICAgICAgICBpZiAodHlwZW9mIHhtbFVSTCA9PT0gInVuZGVmaW5lZCIpIHsgeG1sVVJMID0gbnVsbDsgfQogICAgICAgIGlmICh0eXBlb2YgeG1sRGF0YSA9PT0gInVuZGVmaW5lZCIpIHsgeG1sRGF0YSA9IG51bGw7IH0KCiAgICAgICAgLy8gIEEgVVJMIHRvIGEganNvbi94bWwgZmlsZSBoYXMgYmVlbiBnaXZlbgogICAgICAgIGlmICh4bWxVUkwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFkZFRvRmlsZUxpc3QoJ2JpdG1hcGZvbnQnLCBrZXksIHRleHR1cmVVUkwsIHsgeG1sVVJMOiB4bWxVUkwgfSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBBbiB4bWwgc3RyaW5nIG9yIG9iamVjdCBoYXMgYmVlbiBnaXZlbgogICAgICAgICAgICBpZiAodHlwZW9mIHhtbERhdGEgPT09ICdzdHJpbmcnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgeG1sOwoKICAgICAgICAgICAgICAgIHRyeSAgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3dbJ0RPTVBhcnNlciddKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRvbXBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgeG1sID0gZG9tcGFyc2VyLnBhcnNlRnJvbVN0cmluZyh4bWxEYXRhLCAidGV4dC94bWwiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgeG1sID0gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxET00iKTsKICAgICAgICAgICAgICAgICAgICAgICAgeG1sLmFzeW5jID0gJ2ZhbHNlJzsKICAgICAgICAgICAgICAgICAgICAgICAgeG1sLmxvYWRYTUwoeG1sRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2ggKGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgeG1sID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICgheG1sIHx8ICF4bWwuZG9jdW1lbnRFbGVtZW50IHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgicGFyc2VyZXJyb3IiKS5sZW5ndGgpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQaGFzZXIuTG9hZGVyLiBJbnZhbGlkIEJpdG1hcCBGb250IFhNTCBnaXZlbiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkVG9GaWxlTGlzdCgnYml0bWFwZm9udCcsIGtleSwgdGV4dHVyZVVSTCwgeyB4bWxVUkw6IG51bGwsIHhtbERhdGE6IHhtbCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IHRleHR1cmUgYXRsYXMgdG8gdGhlIGxvYWRlci4gVGhpcyBhdGxhcyB1c2VzIHRoZSBKU09OIEFycmF5IGRhdGEgZm9ybWF0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjYXRsYXNKU09OQXJyYXkKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIHRleHR1cmUgYXRsYXMgZmlsZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHR1cmVVUkwgLSBUaGUgdXJsIG9mIHRoZSB0ZXh0dXJlIGF0bGFzIGltYWdlIGZpbGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbYXRsYXNVUkxdIC0gVGhlIHVybCBvZiB0aGUgdGV4dHVyZSBhdGxhcyBkYXRhIGZpbGUgKGpzb24veG1sKS4gWW91IGRvbid0IG5lZWQgdGhpcyBpZiB5b3UgYXJlIHBhc3NpbmcgYW4gYXRsYXNEYXRhIG9iamVjdCBpbnN0ZWFkLgogICAgKiBAcGFyYW0ge29iamVjdH0gW2F0bGFzRGF0YV0gLSBBIEpTT04gb3IgWE1MIGRhdGEgb2JqZWN0LiBZb3UgZG9uJ3QgbmVlZCB0aGlzIGlmIHRoZSBkYXRhIGlzIGJlaW5nIGxvYWRlZCBmcm9tIGEgVVJMLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuTG9hZGVyfSBUaGlzIExvYWRlciBpbnN0YW5jZS4KICAgICovCiAgICBhdGxhc0pTT05BcnJheTogZnVuY3Rpb24gKGtleSwgdGV4dHVyZVVSTCwgYXRsYXNVUkwsIGF0bGFzRGF0YSkgewoKICAgICAgICByZXR1cm4gdGhpcy5hdGxhcyhrZXksIHRleHR1cmVVUkwsIGF0bGFzVVJMLCBhdGxhc0RhdGEsIFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0FSUkFZKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgdGV4dHVyZSBhdGxhcyB0byB0aGUgbG9hZGVyLiBUaGlzIGF0bGFzIHVzZXMgdGhlIEpTT04gSGFzaCBkYXRhIGZvcm1hdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2F0bGFzSlNPTkhhc2gKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIHRleHR1cmUgYXRsYXMgZmlsZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHR1cmVVUkwgLSBUaGUgdXJsIG9mIHRoZSB0ZXh0dXJlIGF0bGFzIGltYWdlIGZpbGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbYXRsYXNVUkxdIC0gVGhlIHVybCBvZiB0aGUgdGV4dHVyZSBhdGxhcyBkYXRhIGZpbGUgKGpzb24veG1sKS4gWW91IGRvbid0IG5lZWQgdGhpcyBpZiB5b3UgYXJlIHBhc3NpbmcgYW4gYXRsYXNEYXRhIG9iamVjdCBpbnN0ZWFkLgogICAgKiBAcGFyYW0ge29iamVjdH0gW2F0bGFzRGF0YV0gLSBBIEpTT04gb3IgWE1MIGRhdGEgb2JqZWN0LiBZb3UgZG9uJ3QgbmVlZCB0aGlzIGlmIHRoZSBkYXRhIGlzIGJlaW5nIGxvYWRlZCBmcm9tIGEgVVJMLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuTG9hZGVyfSBUaGlzIExvYWRlciBpbnN0YW5jZS4KICAgICovCiAgICBhdGxhc0pTT05IYXNoOiBmdW5jdGlvbiAoa2V5LCB0ZXh0dXJlVVJMLCBhdGxhc1VSTCwgYXRsYXNEYXRhKSB7CgogICAgICAgIHJldHVybiB0aGlzLmF0bGFzKGtleSwgdGV4dHVyZVVSTCwgYXRsYXNVUkwsIGF0bGFzRGF0YSwgUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX0pTT05fSEFTSCk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IHRleHR1cmUgYXRsYXMgdG8gdGhlIGxvYWRlci4gVGhpcyBhdGxhcyB1c2VzIHRoZSBTdGFybGluZyBYTUwgZGF0YSBmb3JtYXQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNhdGxhc1hNTAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGFzc2V0IGtleSBvZiB0aGUgdGV4dHVyZSBhdGxhcyBmaWxlLgogICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dHVyZVVSTCAtIFRoZSB1cmwgb2YgdGhlIHRleHR1cmUgYXRsYXMgaW1hZ2UgZmlsZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IFthdGxhc1VSTF0gLSBUaGUgdXJsIG9mIHRoZSB0ZXh0dXJlIGF0bGFzIGRhdGEgZmlsZSAoanNvbi94bWwpLiBZb3UgZG9uJ3QgbmVlZCB0aGlzIGlmIHlvdSBhcmUgcGFzc2luZyBhbiBhdGxhc0RhdGEgb2JqZWN0IGluc3RlYWQuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBbYXRsYXNEYXRhXSAtIEEgSlNPTiBvciBYTUwgZGF0YSBvYmplY3QuIFlvdSBkb24ndCBuZWVkIHRoaXMgaWYgdGhlIGRhdGEgaXMgYmVpbmcgbG9hZGVkIGZyb20gYSBVUkwuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Mb2FkZXJ9IFRoaXMgTG9hZGVyIGluc3RhbmNlLgogICAgKi8KICAgIGF0bGFzWE1MOiBmdW5jdGlvbiAoa2V5LCB0ZXh0dXJlVVJMLCBhdGxhc1VSTCwgYXRsYXNEYXRhKSB7CgogICAgICAgIHJldHVybiB0aGlzLmF0bGFzKGtleSwgdGV4dHVyZVVSTCwgYXRsYXNVUkwsIGF0bGFzRGF0YSwgUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX1hNTF9TVEFSTElORyk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IHRleHR1cmUgYXRsYXMgdG8gdGhlIGxvYWRlci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2F0bGFzCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSB0ZXh0dXJlIGF0bGFzIGZpbGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0dXJlVVJMIC0gVGhlIHVybCBvZiB0aGUgdGV4dHVyZSBhdGxhcyBpbWFnZSBmaWxlLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2F0bGFzVVJMXSAtIFRoZSB1cmwgb2YgdGhlIHRleHR1cmUgYXRsYXMgZGF0YSBmaWxlIChqc29uL3htbCkuIFlvdSBkb24ndCBuZWVkIHRoaXMgaWYgeW91IGFyZSBwYXNzaW5nIGFuIGF0bGFzRGF0YSBvYmplY3QgaW5zdGVhZC4KICAgICogQHBhcmFtIHtvYmplY3R9IFthdGxhc0RhdGFdIC0gQSBKU09OIG9yIFhNTCBkYXRhIG9iamVjdC4gWW91IGRvbid0IG5lZWQgdGhpcyBpZiB0aGUgZGF0YSBpcyBiZWluZyBsb2FkZWQgZnJvbSBhIFVSTC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtmb3JtYXRdIC0gQSB2YWx1ZSBkZXNjcmliaW5nIHRoZSBmb3JtYXQgb2YgdGhlIGRhdGEsIHRoZSBkZWZhdWx0IGlzIFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0FSUkFZLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuTG9hZGVyfSBUaGlzIExvYWRlciBpbnN0YW5jZS4KICAgICovCiAgICBhdGxhczogZnVuY3Rpb24gKGtleSwgdGV4dHVyZVVSTCwgYXRsYXNVUkwsIGF0bGFzRGF0YSwgZm9ybWF0KSB7CgogICAgICAgIGlmICh0eXBlb2YgYXRsYXNVUkwgPT09ICJ1bmRlZmluZWQiKSB7IGF0bGFzVVJMID0gbnVsbDsgfQogICAgICAgIGlmICh0eXBlb2YgYXRsYXNEYXRhID09PSAidW5kZWZpbmVkIikgeyBhdGxhc0RhdGEgPSBudWxsOyB9CiAgICAgICAgaWYgKHR5cGVvZiBmb3JtYXQgPT09ICJ1bmRlZmluZWQiKSB7IGZvcm1hdCA9IFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0FSUkFZOyB9CgogICAgICAgIC8vICBBIFVSTCB0byBhIGpzb24veG1sIGZpbGUgaGFzIGJlZW4gZ2l2ZW4KICAgICAgICBpZiAoYXRsYXNVUkwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFkZFRvRmlsZUxpc3QoJ3RleHR1cmVhdGxhcycsIGtleSwgdGV4dHVyZVVSTCwgeyBhdGxhc1VSTDogYXRsYXNVUkwsIGZvcm1hdDogZm9ybWF0IH0pOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZvcm1hdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIEEganNvbiBzdHJpbmcgb3Igb2JqZWN0IGhhcyBiZWVuIGdpdmVuCiAgICAgICAgICAgICAgICBjYXNlIFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0FSUkFZOgoKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGF0bGFzRGF0YSA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBhdGxhc0RhdGEgPSBKU09OLnBhcnNlKGF0bGFzRGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIC8vICBBbiB4bWwgc3RyaW5nIG9yIG9iamVjdCBoYXMgYmVlbiBnaXZlbgogICAgICAgICAgICAgICAgY2FzZSBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfWE1MX1NUQVJMSU5HOgoKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGF0bGFzRGF0YSA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgeG1sOwoKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5ICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93WydET01QYXJzZXInXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZG9tcGFyc2VyID0gbmV3IERPTVBhcnNlcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhtbCA9IGRvbXBhcnNlci5wYXJzZUZyb21TdHJpbmcoYXRsYXNEYXRhLCAidGV4dC94bWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4bWwgPSBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTERPTSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhtbC5hc3luYyA9ICdmYWxzZSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeG1sLmxvYWRYTUwoYXRsYXNEYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeG1sID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXhtbCB8fCAheG1sLmRvY3VtZW50RWxlbWVudCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInBhcnNlcmVycm9yIikubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBoYXNlci5Mb2FkZXIuIEludmFsaWQgVGV4dHVyZSBBdGxhcyBYTUwgZ2l2ZW4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0bGFzRGF0YSA9IHhtbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5hZGRUb0ZpbGVMaXN0KCd0ZXh0dXJlYXRsYXMnLCBrZXksIHRleHR1cmVVUkwsIHsgYXRsYXNVUkw6IG51bGwsIGF0bGFzRGF0YTogYXRsYXNEYXRhLCBmb3JtYXQ6IGZvcm1hdCB9KTsKCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmUgbG9hZGluZyByZXF1ZXN0IG9mIGEgZmlsZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3JlbW92ZUZpbGUKICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgLSBUaGUgdHlwZSBvZiByZXNvdXJjZSB0byBhZGQgdG8gdGhlIGxpc3QgKGltYWdlLCBhdWRpbywgeG1sLCBldGMpLgogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gS2V5IG9mIHRoZSBmaWxlIHlvdSB3YW50IHRvIHJlbW92ZS4KICAgICovCiAgICByZW1vdmVGaWxlOiBmdW5jdGlvbiAodHlwZSwga2V5KSB7CgogICAgICAgIHZhciBmaWxlID0gdGhpcy5nZXRBc3NldCh0eXBlLCBrZXkpOwoKICAgICAgICBpZiAoZmlsZSAhPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9maWxlTGlzdC5zcGxpY2UoZmlsZS5pbmRleCwgMSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZSBhbGwgZmlsZSBsb2FkaW5nIHJlcXVlc3RzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjcmVtb3ZlQWxsCiAgICAqLwogICAgcmVtb3ZlQWxsOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuX2ZpbGVMaXN0Lmxlbmd0aCA9IDA7CgogICAgfSwKCiAgICAvKioKICAgICogU3RhcnQgbG9hZGluZyB0aGUgYXNzZXRzLiBOb3JtYWxseSB5b3UgZG9uJ3QgbmVlZCB0byBjYWxsIHRoaXMgeW91cnNlbGYgYXMgdGhlIFN0YXRlTWFuYWdlciB3aWxsIGRvIHNvLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjc3RhcnQKICAgICovCiAgICBzdGFydDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5pc0xvYWRpbmcpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLnByb2dyZXNzID0gMDsKICAgICAgICB0aGlzLnByb2dyZXNzRmxvYXQgPSAwOwogICAgICAgIHRoaXMuaGFzTG9hZGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlOwoKICAgICAgICB0aGlzLm9uTG9hZFN0YXJ0LmRpc3BhdGNoKHRoaXMuX2ZpbGVMaXN0Lmxlbmd0aCk7CgogICAgICAgIGlmICh0aGlzLl9maWxlTGlzdC5sZW5ndGggPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZmlsZUluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5fcHJvZ3Jlc3NDaHVuayA9IDEwMCAvIHRoaXMuX2ZpbGVMaXN0Lmxlbmd0aDsKICAgICAgICAgICAgdGhpcy5sb2FkRmlsZSgpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnByb2dyZXNzID0gMTAwOwogICAgICAgICAgICB0aGlzLnByb2dyZXNzRmxvYXQgPSAxMDA7CiAgICAgICAgICAgIHRoaXMuaGFzTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5vbkxvYWRDb21wbGV0ZS5kaXNwYXRjaCgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBMb2FkIGZpbGVzLiBQcml2YXRlIG1ldGhvZCBPTkxZIHVzZWQgYnkgbG9hZGVyLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjbG9hZEZpbGUKICAgICogQHByaXZhdGUKICAgICovCiAgICBsb2FkRmlsZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAoIXRoaXMuX2ZpbGVMaXN0W3RoaXMuX2ZpbGVJbmRleF0pCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BoYXNlci5Mb2FkZXIgbG9hZEZpbGUgaW52YWxpZCBpbmRleCAnICsgdGhpcy5fZmlsZUluZGV4KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGZpbGUgPSB0aGlzLl9maWxlTGlzdFt0aGlzLl9maWxlSW5kZXhdOwogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIC8vICBJbWFnZSBvciBEYXRhPwogICAgICAgIHN3aXRjaCAoZmlsZS50eXBlKQogICAgICAgIHsKICAgICAgICAgICAgY2FzZSAnaW1hZ2UnOgogICAgICAgICAgICBjYXNlICdzcHJpdGVzaGVldCc6CiAgICAgICAgICAgIGNhc2UgJ3RleHR1cmVhdGxhcyc6CiAgICAgICAgICAgIGNhc2UgJ2JpdG1hcGZvbnQnOgogICAgICAgICAgICAgICAgZmlsZS5kYXRhID0gbmV3IEltYWdlKCk7CiAgICAgICAgICAgICAgICBmaWxlLmRhdGEubmFtZSA9IGZpbGUua2V5OwogICAgICAgICAgICAgICAgZmlsZS5kYXRhLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZmlsZUNvbXBsZXRlKF90aGlzLl9maWxlSW5kZXgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5vbmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5maWxlRXJyb3IoX3RoaXMuX2ZpbGVJbmRleCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZmlsZS5kYXRhLmNyb3NzT3JpZ2luID0gdGhpcy5jcm9zc09yaWdpbjsKICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5zcmMgPSB0aGlzLmJhc2VVUkwgKyBmaWxlLnVybDsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnYXVkaW8nOgogICAgICAgICAgICAgICAgZmlsZS51cmwgPSB0aGlzLmdldEF1ZGlvVVJMKGZpbGUudXJsKTsKCiAgICAgICAgICAgICAgICBpZiAoZmlsZS51cmwgIT09IG51bGwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gIFdlYkF1ZGlvIG9yIEF1ZGlvIFRhZz8KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNvdW5kLnVzaW5nV2ViQXVkaW8pCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl94aHIub3BlbigiR0VUIiwgdGhpcy5iYXNlVVJMICsgZmlsZS51cmwsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl94aHIucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5maWxlQ29tcGxldGUoX3RoaXMuX2ZpbGVJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3hoci5vbmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmZpbGVFcnJvcihfdGhpcy5fZmlsZUluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLnNlbmQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5nYW1lLnNvdW5kLnVzaW5nQXVkaW9UYWcpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLnNvdW5kLnRvdWNoTG9ja2VkKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgSWYgYXVkaW8gaXMgbG9ja2VkIHdlIGNhbid0IGRvIHRoaXMgeWV0LCBzbyBuZWVkIHRvIHF1ZXVlIHRoaXMgbG9hZCByZXF1ZXN0LiBCdW0uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLmRhdGEgPSBuZXcgQXVkaW8oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5uYW1lID0gZmlsZS5rZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLmRhdGEucHJlbG9hZCA9ICdhdXRvJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5zcmMgPSB0aGlzLmJhc2VVUkwgKyBmaWxlLnVybDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmlsZUNvbXBsZXRlKHRoaXMuX2ZpbGVJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLmRhdGEgPSBuZXcgQXVkaW8oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5uYW1lID0gZmlsZS5rZXk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLmRhdGEub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZmlsZUVycm9yKF90aGlzLl9maWxlSW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5wcmVsb2FkID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZS5kYXRhLnNyYyA9IHRoaXMuYmFzZVVSTCArIGZpbGUudXJsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZS5kYXRhLmFkZEV2ZW50TGlzdGVuZXIoJ2NhbnBsYXl0aHJvdWdoJywgUGhhc2VyLkdBTUVTW3RoaXMuZ2FtZS5pZF0ubG9hZC5maWxlQ29tcGxldGUodGhpcy5fZmlsZUluZGV4KSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZS5kYXRhLmxvYWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbGVFcnJvcih0aGlzLl9maWxlSW5kZXgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAndGlsZW1hcCc6CiAgICAgICAgICAgICAgICB0aGlzLl94aHIub3BlbigiR0VUIiwgdGhpcy5iYXNlVVJMICsgZmlsZS51cmwsIHRydWUpOwogICAgICAgICAgICAgICAgdGhpcy5feGhyLnJlc3BvbnNlVHlwZSA9ICJ0ZXh0IjsKCiAgICAgICAgICAgICAgICBpZiAoZmlsZS5mb3JtYXQgPT09IFBoYXNlci5UaWxlbWFwLlRJTEVEX0pTT04pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmpzb25Mb2FkQ29tcGxldGUoX3RoaXMuX2ZpbGVJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGZpbGUuZm9ybWF0ID09PSBQaGFzZXIuVGlsZW1hcC5DU1YpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmNzdkxvYWRDb21wbGV0ZShfdGhpcy5fZmlsZUluZGV4KTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUGhhc2VyLkxvYWRlci4gSW52YWxpZCBUaWxlbWFwIGZvcm1hdDogIiArIGZpbGUuZm9ybWF0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLl94aHIub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZGF0YUxvYWRFcnJvcihfdGhpcy5fZmlsZUluZGV4KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLl94aHIuc2VuZCgpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICd0ZXh0JzoKICAgICAgICAgICAgY2FzZSAnc2NyaXB0JzoKICAgICAgICAgICAgICAgIHRoaXMuX3hoci5vcGVuKCJHRVQiLCB0aGlzLmJhc2VVUkwgKyBmaWxlLnVybCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB0aGlzLl94aHIucmVzcG9uc2VUeXBlID0gInRleHQiOwogICAgICAgICAgICAgICAgdGhpcy5feGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZmlsZUNvbXBsZXRlKF90aGlzLl9maWxlSW5kZXgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHRoaXMuX3hoci5vbmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5maWxlRXJyb3IoX3RoaXMuX2ZpbGVJbmRleCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdGhpcy5feGhyLnNlbmQoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICAgICAgICAgIHRoaXMuX3hoci5vcGVuKCJHRVQiLCB0aGlzLmJhc2VVUkwgKyBmaWxlLnVybCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB0aGlzLl94aHIucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKICAgICAgICAgICAgICAgIHRoaXMuX3hoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmZpbGVDb21wbGV0ZShfdGhpcy5fZmlsZUluZGV4KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLl94aHIub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZmlsZUVycm9yKF90aGlzLl9maWxlSW5kZXgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHRoaXMuX3hoci5zZW5kKCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUHJpdmF0ZSBtZXRob2QgT05MWSB1c2VkIGJ5IGxvYWRlci4KICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2dldEF1ZGlvVVJMCiAgICAqIEBwYXJhbSB7YXJyYXl8c3RyaW5nfSB1cmxzIC0gRWl0aGVyIGFuIGFycmF5IG9mIGF1ZGlvIGZpbGUgVVJMcyBvciBhIHN0cmluZyBjb250YWluaW5nIGEgc2luZ2xlIFVSTCBwYXRoLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIGdldEF1ZGlvVVJMOiBmdW5jdGlvbiAodXJscykgewoKICAgICAgICB2YXIgZXh0ZW5zaW9uOwoKICAgICAgICBpZiAodHlwZW9mIHVybHMgPT09ICdzdHJpbmcnKSB7IHVybHMgPSBbdXJsc107IH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1cmxzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgZXh0ZW5zaW9uID0gdXJsc1tpXS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBleHRlbnNpb24gPSBleHRlbnNpb24uc3Vic3RyKChNYXRoLm1heCgwLCBleHRlbnNpb24ubGFzdEluZGV4T2YoIi4iKSkgfHwgSW5maW5pdHkpICsgMSk7CgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS5jYW5QbGF5QXVkaW8oZXh0ZW5zaW9uKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHVybHNbaV07CiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBFcnJvciBvY2N1cmVkIHdoZW4gbG9hZGluZyBhIGZpbGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNmaWxlRXJyb3IKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoZSBmaWxlIGluIHRoZSBmaWxlIHF1ZXVlIHRoYXQgZXJyb3JlZC4KICAgICovCiAgICBmaWxlRXJyb3I6IGZ1bmN0aW9uIChpbmRleCkgewoKICAgICAgICB0aGlzLl9maWxlTGlzdFtpbmRleF0ubG9hZGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLl9maWxlTGlzdFtpbmRleF0uZXJyb3IgPSB0cnVlOwoKICAgICAgICB0aGlzLm9uRmlsZUVycm9yLmRpc3BhdGNoKHRoaXMuX2ZpbGVMaXN0W2luZGV4XS5rZXksIHRoaXMuX2ZpbGVMaXN0W2luZGV4XSk7CgogICAgICAgIGNvbnNvbGUud2FybigiUGhhc2VyLkxvYWRlciBlcnJvciBsb2FkaW5nIGZpbGU6ICIgKyB0aGlzLl9maWxlTGlzdFtpbmRleF0ua2V5ICsgJyBmcm9tIFVSTCAnICsgdGhpcy5fZmlsZUxpc3RbaW5kZXhdLnVybCk7CgogICAgICAgIHRoaXMubmV4dEZpbGUoaW5kZXgsIGZhbHNlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgd2hlbiBhIGZpbGUgaXMgc3VjY2Vzc2Z1bGx5IGxvYWRlZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2ZpbGVDb21wbGV0ZQogICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhlIGZpbGUgaW4gdGhlIGZpbGUgcXVldWUgdGhhdCBsb2FkZWQuCiAgICAqLwogICAgZmlsZUNvbXBsZXRlOiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAgICAgaWYgKCF0aGlzLl9maWxlTGlzdFtpbmRleF0pCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BoYXNlci5Mb2FkZXIgZmlsZUNvbXBsZXRlIGludmFsaWQgaW5kZXggJyArIGluZGV4KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGZpbGUgPSB0aGlzLl9maWxlTGlzdFtpbmRleF07CiAgICAgICAgZmlsZS5sb2FkZWQgPSB0cnVlOwoKICAgICAgICB2YXIgbG9hZE5leHQgPSB0cnVlOwogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHN3aXRjaCAoZmlsZS50eXBlKQogICAgICAgIHsKICAgICAgICAgICAgY2FzZSAnaW1hZ2UnOgoKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5hZGRJbWFnZShmaWxlLmtleSwgZmlsZS51cmwsIGZpbGUuZGF0YSk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ3Nwcml0ZXNoZWV0JzoKCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkU3ByaXRlU2hlZXQoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEsIGZpbGUuZnJhbWVXaWR0aCwgZmlsZS5mcmFtZUhlaWdodCwgZmlsZS5mcmFtZU1heCwgZmlsZS5tYXJnaW4sIGZpbGUuc3BhY2luZyk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ3RleHR1cmVhdGxhcyc6CgogICAgICAgICAgICAgICAgaWYgKGZpbGUuYXRsYXNVUkwgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkVGV4dHVyZUF0bGFzKGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCBmaWxlLmF0bGFzRGF0YSwgZmlsZS5mb3JtYXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICBMb2FkIHRoZSBKU09OIG9yIFhNTCBiZWZvcmUgY2Fycnlpbmcgb24gd2l0aCB0aGUgbmV4dCBmaWxlCiAgICAgICAgICAgICAgICAgICAgbG9hZE5leHQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl94aHIub3BlbigiR0VUIiwgdGhpcy5iYXNlVVJMICsgZmlsZS5hdGxhc1VSTCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLnJlc3BvbnNlVHlwZSA9ICJ0ZXh0IjsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGUuZm9ybWF0ID09IFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0FSUkFZIHx8IGZpbGUuZm9ybWF0ID09IFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0hBU0gpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl94aHIub25sb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmpzb25Mb2FkQ29tcGxldGUoaW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChmaWxlLmZvcm1hdCA9PSBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfWE1MX1NUQVJMSU5HKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy54bWxMb2FkQ29tcGxldGUoaW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBoYXNlci5Mb2FkZXIuIEludmFsaWQgVGV4dHVyZSBBdGxhcyBmb3JtYXQ6ICIgKyBmaWxlLmZvcm1hdCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0aGlzLl94aHIub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmRhdGFMb2FkRXJyb3IoaW5kZXgpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5feGhyLnNlbmQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnYml0bWFwZm9udCc6CgogICAgICAgICAgICAgICAgaWYgKGZpbGUueG1sVVJMID09IG51bGwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLmFkZEJpdG1hcEZvbnQoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEsIGZpbGUueG1sRGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gIExvYWQgdGhlIFhNTCBiZWZvcmUgY2Fycnlpbmcgb24gd2l0aCB0aGUgbmV4dCBmaWxlCiAgICAgICAgICAgICAgICAgICAgbG9hZE5leHQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl94aHIub3BlbigiR0VUIiwgdGhpcy5iYXNlVVJMICsgZmlsZS54bWxVUkwsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3hoci5yZXNwb25zZVR5cGUgPSAidGV4dCI7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuX3hoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy54bWxMb2FkQ29tcGxldGUoaW5kZXgpOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHRoaXMuX3hoci5vbmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZGF0YUxvYWRFcnJvcihpbmRleCk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl94aHIuc2VuZCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICdhdWRpbyc6CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5zb3VuZC51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGZpbGUuZGF0YSA9IHRoaXMuX3hoci5yZXNwb25zZTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLmFkZFNvdW5kKGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCB0cnVlLCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChmaWxlLmF1dG9EZWNvZGUpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUudXBkYXRlU291bmQoa2V5LCAnaXNEZWNvZGluZycsIHRydWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gZmlsZS5rZXk7CgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc291bmQuY29udGV4dC5kZWNvZGVBdWRpb0RhdGEoZmlsZS5kYXRhLCBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnVmZmVyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuZ2FtZS5jYWNoZS5kZWNvZGVkU291bmQoa2V5LCBidWZmZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuZ2FtZS5zb3VuZC5vblNvdW5kRGVjb2RlLmRpc3BhdGNoKGtleSwgdGhhdC5nYW1lLmNhY2hlLmdldFNvdW5kKGtleSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZmlsZS5kYXRhLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NhbnBsYXl0aHJvdWdoJywgUGhhc2VyLkdBTUVTW3RoaXMuZ2FtZS5pZF0ubG9hZC5maWxlQ29tcGxldGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5hZGRTb3VuZChmaWxlLmtleSwgZmlsZS51cmwsIGZpbGUuZGF0YSwgZmFsc2UsIHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICd0ZXh0JzoKICAgICAgICAgICAgICAgIGZpbGUuZGF0YSA9IHRoaXMuX3hoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkVGV4dChmaWxlLmtleSwgZmlsZS51cmwsIGZpbGUuZGF0YSk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ3NjcmlwdCc6CiAgICAgICAgICAgICAgICBmaWxlLmRhdGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKICAgICAgICAgICAgICAgIGZpbGUuZGF0YS5sYW5ndWFnZSA9ICdqYXZhc2NyaXB0JzsKICAgICAgICAgICAgICAgIGZpbGUuZGF0YS50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7CiAgICAgICAgICAgICAgICBmaWxlLmRhdGEuZGVmZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGZpbGUuZGF0YS50ZXh0ID0gdGhpcy5feGhyLnJlc3BvbnNlVGV4dDsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoZmlsZS5kYXRhKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICAgICAgICAgIGlmIChmaWxlLmNhbGxiYWNrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGZpbGUuZGF0YSA9IGZpbGUuY2FsbGJhY2suY2FsbChmaWxlLmNhbGxiYWNrQ29udGV4dCwgZmlsZS5rZXksIHRoaXMuX3hoci5yZXNwb25zZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZmlsZS5kYXRhID0gdGhpcy5feGhyLnJlc3BvbnNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5hZGRCaW5hcnkoZmlsZS5rZXksIGZpbGUuZGF0YSk7CgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9hZE5leHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm5leHRGaWxlKGluZGV4LCB0cnVlKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU3VjY2Vzc2Z1bGx5IGxvYWRlZCBhIEpTT04gZmlsZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2pzb25Mb2FkQ29tcGxldGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoZSBmaWxlIGluIHRoZSBmaWxlIHF1ZXVlIHRoYXQgbG9hZGVkLgogICAgKi8KICAgIGpzb25Mb2FkQ29tcGxldGU6IGZ1bmN0aW9uIChpbmRleCkgewoKICAgICAgICBpZiAoIXRoaXMuX2ZpbGVMaXN0W2luZGV4XSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignUGhhc2VyLkxvYWRlciBqc29uTG9hZENvbXBsZXRlIGludmFsaWQgaW5kZXggJyArIGluZGV4KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGZpbGUgPSB0aGlzLl9maWxlTGlzdFtpbmRleF07CiAgICAgICAgdmFyIGRhdGEgPSBKU09OLnBhcnNlKHRoaXMuX3hoci5yZXNwb25zZVRleHQpOwoKICAgICAgICBmaWxlLmxvYWRlZCA9IHRydWU7CgogICAgICAgIGlmIChmaWxlLnR5cGUgPT09ICd0aWxlbWFwJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5hZGRUaWxlbWFwKGZpbGUua2V5LCBmaWxlLnVybCwgZGF0YSwgZmlsZS5mb3JtYXQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkVGV4dHVyZUF0bGFzKGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCBkYXRhLCBmaWxlLmZvcm1hdCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLm5leHRGaWxlKGluZGV4LCB0cnVlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdWNjZXNzZnVsbHkgbG9hZGVkIGEgQ1NWIGZpbGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNjc3ZMb2FkQ29tcGxldGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoZSBmaWxlIGluIHRoZSBmaWxlIHF1ZXVlIHRoYXQgbG9hZGVkLgogICAgKi8KICAgIGNzdkxvYWRDb21wbGV0ZTogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgICAgIGlmICghdGhpcy5fZmlsZUxpc3RbaW5kZXhdKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdQaGFzZXIuTG9hZGVyIGNzdkxvYWRDb21wbGV0ZSBpbnZhbGlkIGluZGV4ICcgKyBpbmRleCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBmaWxlID0gdGhpcy5fZmlsZUxpc3RbaW5kZXhdOwogICAgICAgIHZhciBkYXRhID0gdGhpcy5feGhyLnJlc3BvbnNlVGV4dDsKCiAgICAgICAgZmlsZS5sb2FkZWQgPSB0cnVlOwoKICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkVGlsZW1hcChmaWxlLmtleSwgZmlsZS51cmwsIGRhdGEsIGZpbGUuZm9ybWF0KTsKCiAgICAgICAgdGhpcy5uZXh0RmlsZShpbmRleCwgdHJ1ZSk7CgogICAgfSwKCiAgICAvKioKICAgICogRXJyb3Igb2NjdXJlZCB3aGVuIGxvYWQgYSBKU09OLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjZGF0YUxvYWRFcnJvcgogICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhlIGZpbGUgaW4gdGhlIGZpbGUgcXVldWUgdGhhdCBlcnJvcmVkLgogICAgKi8KICAgIGRhdGFMb2FkRXJyb3I6IGZ1bmN0aW9uIChpbmRleCkgewoKICAgICAgICB2YXIgZmlsZSA9IHRoaXMuX2ZpbGVMaXN0W2luZGV4XTsKCiAgICAgICAgZmlsZS5sb2FkZWQgPSB0cnVlOwogICAgICAgIGZpbGUuZXJyb3IgPSB0cnVlOwoKICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5Mb2FkZXIgZGF0YUxvYWRFcnJvcjogIiArIGZpbGUua2V5KTsKCiAgICAgICAgdGhpcy5uZXh0RmlsZShpbmRleCwgdHJ1ZSk7CgogICAgfSwKCiAgICAvKioKICAgICogU3VjY2Vzc2Z1bGx5IGxvYWRlZCBhbiBYTUwgZmlsZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3htbExvYWRDb21wbGV0ZQogICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhlIGZpbGUgaW4gdGhlIGZpbGUgcXVldWUgdGhhdCBsb2FkZWQuCiAgICAqLwogICAgeG1sTG9hZENvbXBsZXRlOiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLl94aHIucmVzcG9uc2VUZXh0OwogICAgICAgIHZhciB4bWw7CgogICAgICAgIHRyeQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbmRvd1snRE9NUGFyc2VyJ10pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBkb21wYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgICAgICAgICAgICB4bWwgPSBkb21wYXJzZXIucGFyc2VGcm9tU3RyaW5nKGRhdGEsICJ0ZXh0L3htbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgeG1sID0gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxET00iKTsKICAgICAgICAgICAgICAgIHhtbC5hc3luYyA9ICdmYWxzZSc7CiAgICAgICAgICAgICAgICB4bWwubG9hZFhNTChkYXRhKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjYXRjaCAoZSkKICAgICAgICB7CiAgICAgICAgICAgIHhtbCA9IHVuZGVmaW5lZDsKICAgICAgICB9CgogICAgICAgIGlmICgheG1sIHx8ICF4bWwuZG9jdW1lbnRFbGVtZW50IHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgicGFyc2VyZXJyb3IiKS5sZW5ndGgpCiAgICAgICAgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBoYXNlci5Mb2FkZXIuIEludmFsaWQgWE1MIGdpdmVuIik7CiAgICAgICAgfQoKICAgICAgICB2YXIgZmlsZSA9IHRoaXMuX2ZpbGVMaXN0W2luZGV4XTsKICAgICAgICBmaWxlLmxvYWRlZCA9IHRydWU7CgogICAgICAgIGlmIChmaWxlLnR5cGUgPT0gJ2JpdG1hcGZvbnQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLmFkZEJpdG1hcEZvbnQoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEsIHhtbCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGZpbGUudHlwZSA9PSAndGV4dHVyZWF0bGFzJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5hZGRUZXh0dXJlQXRsYXMoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEsIHhtbCwgZmlsZS5mb3JtYXQpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5uZXh0RmlsZShpbmRleCwgdHJ1ZSk7CgogICAgfSwKCiAgICAvKioKICAgICogSGFuZGxlIGxvYWRpbmcgbmV4dCBmaWxlLgogICAgKgogICAgKiBAcGFyYW0ge251bWJlcn0gcHJldmlvdXNJbmRleCAtIEluZGV4IG9mIHRoZSBwcmV2aW91c2x5IGxvYWRlZCBhc3NldC4KICAgICogQHBhcmFtIHtib29sZWFufSBzdWNjZXNzIC0gV2hldGhlciB0aGUgcHJldmlvdXMgYXNzZXQgbG9hZGVkIHN1Y2Nlc3NmdWxseSBvciBub3QuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgbmV4dEZpbGU6IGZ1bmN0aW9uIChwcmV2aW91c0luZGV4LCBzdWNjZXNzKSB7CgogICAgICAgIHRoaXMucHJvZ3Jlc3NGbG9hdCArPSB0aGlzLl9wcm9ncmVzc0NodW5rOwogICAgICAgIHRoaXMucHJvZ3Jlc3MgPSBNYXRoLnJvdW5kKHRoaXMucHJvZ3Jlc3NGbG9hdCk7CgogICAgICAgIGlmICh0aGlzLnByb2dyZXNzID4gMTAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5wcm9ncmVzcyA9IDEwMDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnByZWxvYWRTcHJpdGUgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5wcmVsb2FkU3ByaXRlLmRpcmVjdGlvbiA9PT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wcmVsb2FkU3ByaXRlLmNyb3Aud2lkdGggPSBNYXRoLmZsb29yKCh0aGlzLnByZWxvYWRTcHJpdGUud2lkdGggLyAxMDApICogdGhpcy5wcm9ncmVzcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnByZWxvYWRTcHJpdGUuY3JvcC5oZWlnaHQgPSBNYXRoLmZsb29yKCh0aGlzLnByZWxvYWRTcHJpdGUuaGVpZ2h0IC8gMTAwKSAqIHRoaXMucHJvZ3Jlc3MpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnByZWxvYWRTcHJpdGUuc3ByaXRlLmNyb3AgPSB0aGlzLnByZWxvYWRTcHJpdGUuY3JvcDsKICAgICAgICB9CgogICAgICAgIHRoaXMub25GaWxlQ29tcGxldGUuZGlzcGF0Y2godGhpcy5wcm9ncmVzcywgdGhpcy5fZmlsZUxpc3RbcHJldmlvdXNJbmRleF0ua2V5LCBzdWNjZXNzLCB0aGlzLnRvdGFsTG9hZGVkRmlsZXMoKSwgdGhpcy5fZmlsZUxpc3QubGVuZ3RoKTsKCiAgICAgICAgaWYgKHRoaXMudG90YWxRdWV1ZWRGaWxlcygpID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ZpbGVJbmRleCsrOwogICAgICAgICAgICB0aGlzLmxvYWRGaWxlKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuaGFzTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucmVtb3ZlQWxsKCk7CgogICAgICAgICAgICB0aGlzLm9uTG9hZENvbXBsZXRlLmRpc3BhdGNoKCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIG51bWJlciBvZiBmaWxlcyB0aGF0IGhhdmUgYWxyZWFkeSBiZWVuIGxvYWRlZCwgZXZlbiBpZiB0aGV5IGVycm9yZWQuCiAgICAqCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG51bWJlciBvZiBmaWxlcyB0aGF0IGhhdmUgYWxyZWFkeSBiZWVuIGxvYWRlZCAoZXZlbiBpZiB0aGV5IGVycm9yZWQpCiAgICAqLwogICAgdG90YWxMb2FkZWRGaWxlczogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgdG90YWwgPSAwOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2ZpbGVMaXN0Lmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2ZpbGVMaXN0W2ldLmxvYWRlZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdG90YWwrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRvdGFsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIG51bWJlciBvZiBmaWxlcyBzdGlsbCB3YWl0aW5nIHRvIGJlIHByb2Nlc3NlZCBpbiB0aGUgbG9hZCBxdWV1ZS4gVGhpcyB2YWx1ZSBkZWNyZWFzZXMgYXMgZWFjaCBmaWxlIGlzIGluIHRoZSBxdWV1ZSBpcyBsb2FkZWQuCiAgICAqCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG51bWJlciBvZiBmaWxlcyB0aGF0IHN0aWxsIHJlbWFpbiBpbiB0aGUgbG9hZCBxdWV1ZS4KICAgICovCiAgICB0b3RhbFF1ZXVlZEZpbGVzOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciB0b3RhbCA9IDA7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fZmlsZUxpc3QubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fZmlsZUxpc3RbaV0ubG9hZGVkID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdG90YWwrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRvdGFsOwoKICAgIH0KCn07CgpQaGFzZXIuTG9hZGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5Mb2FkZXI7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIuTG9hZGVyUGFyc2VyIHBhcnNlcyBkYXRhIG9iamVjdHMgZnJvbSBQaGFzZXIuTG9hZGVyIHRoYXQgbmVlZCBtb3JlIHByZXBhcmF0aW9uIGJlZm9yZSB0aGV5IGNhbiBiZSBpbnNlcnRlZCBpbnRvIHRoZSBDYWNoZS4KKgoqIEBjbGFzcyBQaGFzZXIuTG9hZGVyUGFyc2VyCiovClBoYXNlci5Mb2FkZXJQYXJzZXIgPSB7CiAgICAKICAgIC8qKgogICAgKiBQYXJzZSBmcmFtZSBkYXRhIGZyb20gYW4gWE1MIGZpbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlclBhcnNlci5iaXRtYXBGb250CiAgICAqIEBwYXJhbSB7b2JqZWN0fSB4bWwgLSBYTUwgZGF0YSB5b3Ugd2FudCB0byBwYXJzZS4KICAgICogQHJldHVybiB7RnJhbWVEYXRhfSBHZW5lcmF0ZWQgRnJhbWVEYXRhIG9iamVjdC4KICAgICovCiAgICBiaXRtYXBGb250OiBmdW5jdGlvbiAoZ2FtZSwgeG1sLCBjYWNoZUtleSkgewoKICAgICAgICAvLyAgTWFsZm9ybWVkPwogICAgICAgIGlmICgheG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdmb250JykpCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5Mb2FkZXJQYXJzZXIuYml0bWFwRm9udDogSW52YWxpZCBYTUwgZ2l2ZW4sIG1pc3NpbmcgPGZvbnQ+IHRhZyIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgdGV4dHVyZSA9IFBJWEkuVGV4dHVyZUNhY2hlW2NhY2hlS2V5XTsKCiAgICAgICAgdmFyIGRhdGEgPSB7fTsKICAgICAgICB2YXIgaW5mbyA9IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaW5mbyIpWzBdOwogICAgICAgIHZhciBjb21tb24gPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImNvbW1vbiIpWzBdOwogICAgICAgIGRhdGEuZm9udCA9IGluZm8uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oImZhY2UiKS5ub2RlVmFsdWU7CiAgICAgICAgZGF0YS5zaXplID0gcGFyc2VJbnQoaW5mby5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgic2l6ZSIpLm5vZGVWYWx1ZSwgMTApOwogICAgICAgIGRhdGEubGluZUhlaWdodCA9IHBhcnNlSW50KGNvbW1vbi5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgibGluZUhlaWdodCIpLm5vZGVWYWx1ZSwgMTApOwogICAgICAgIGRhdGEuY2hhcnMgPSB7fTsKCiAgICAgICAgLy9wYXJzZSBsZXR0ZXJzCiAgICAgICAgdmFyIGxldHRlcnMgPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImNoYXIiKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZXR0ZXJzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGNoYXJDb2RlID0gcGFyc2VJbnQobGV0dGVyc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgiaWQiKS5ub2RlVmFsdWUsIDEwKTsKCiAgICAgICAgICAgIHZhciB0ZXh0dXJlUmVjdCA9IHsKICAgICAgICAgICAgICAgIHg6IHBhcnNlSW50KGxldHRlcnNbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oIngiKS5ub2RlVmFsdWUsIDEwKSwKICAgICAgICAgICAgICAgIHk6IHBhcnNlSW50KGxldHRlcnNbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oInkiKS5ub2RlVmFsdWUsIDEwKSwKICAgICAgICAgICAgICAgIHdpZHRoOiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJ3aWR0aCIpLm5vZGVWYWx1ZSwgMTApLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJoZWlnaHQiKS5ub2RlVmFsdWUsIDEwKQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gIE5vdGU6IFRoaXMgbWVhbnMgeW91IGNhbiBvbmx5IGhhdmUgMSBCaXRtYXBGb250IGxvYWRlZCBhdCBvbmNlIQogICAgICAgICAgICAvLyAgTmVlZCB0byByZXBsYWNlIHRoaXMgd2l0aCBvdXIgb3duIGhhbmRsZXIgc29vbi4KICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbY2hhckNvZGVdID0gbmV3IFBJWEkuVGV4dHVyZSh0ZXh0dXJlLCB0ZXh0dXJlUmVjdCk7CgogICAgICAgICAgICBkYXRhLmNoYXJzW2NoYXJDb2RlXSA9IHsKICAgICAgICAgICAgICAgIHhPZmZzZXQ6IHBhcnNlSW50KGxldHRlcnNbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oInhvZmZzZXQiKS5ub2RlVmFsdWUsIDEwKSwKICAgICAgICAgICAgICAgIHlPZmZzZXQ6IHBhcnNlSW50KGxldHRlcnNbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oInlvZmZzZXQiKS5ub2RlVmFsdWUsIDEwKSwKICAgICAgICAgICAgICAgIHhBZHZhbmNlOiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJ4YWR2YW5jZSIpLm5vZGVWYWx1ZSwgMTApLAogICAgICAgICAgICAgICAga2VybmluZzoge30sCiAgICAgICAgICAgICAgICB0ZXh0dXJlOm5ldyBQSVhJLlRleHR1cmUodGV4dHVyZSwgdGV4dHVyZVJlY3QpCgogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLy9wYXJzZSBrZXJuaW5ncwogICAgICAgIHZhciBrZXJuaW5ncyA9IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgia2VybmluZyIpOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwga2VybmluZ3MubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB2YXIgZmlyc3QgPSBwYXJzZUludChrZXJuaW5nc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgiZmlyc3QiKS5ub2RlVmFsdWUsIDEwKTsKICAgICAgICAgICAgdmFyIHNlY29uZCA9IHBhcnNlSW50KGtlcm5pbmdzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJzZWNvbmQiKS5ub2RlVmFsdWUsIDEwKTsKICAgICAgICAgICAgdmFyIGFtb3VudCA9IHBhcnNlSW50KGtlcm5pbmdzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJhbW91bnQiKS5ub2RlVmFsdWUsIDEwKTsKCiAgICAgICAgICAgIGRhdGEuY2hhcnNbc2Vjb25kXS5rZXJuaW5nW2ZpcnN0XSA9IGFtb3VudDsKICAgICAgICB9CgogICAgICAgIFBJWEkuQml0bWFwVGV4dC5mb250c1tkYXRhLmZvbnRdID0gZGF0YTsKCiAgICB9Cgp9OwovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBUaGUgU291bmQgY2xhc3MgY29uc3RydWN0b3IuCioKKiBAY2xhc3MgUGhhc2VyLlNvdW5kCiogQGNsYXNzZGVzYyBUaGUgU291bmQgY2xhc3MKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gUmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50IGdhbWUgaW5zdGFuY2UuCiogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHNvdW5kLgoqIEBwYXJhbSB7bnVtYmVyfSBbdm9sdW1lPTFdIC0gRGVmYXVsdCB2YWx1ZSBmb3IgdGhlIHZvbHVtZSwgYmV0d2VlbiAwIGFuZCAxLgoqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gV2hldGhlciBvciBub3QgdGhlIHNvdW5kIHdpbGwgbG9vcC4KKi8KUGhhc2VyLlNvdW5kID0gZnVuY3Rpb24gKGdhbWUsIGtleSwgdm9sdW1lLCBsb29wLCBjb25uZWN0KSB7CiAgICAKICAgIGlmICh0eXBlb2Ygdm9sdW1lID09ICd1bmRlZmluZWQnKSB7IHZvbHVtZSA9IDE7IH0KICAgIGlmICh0eXBlb2YgbG9vcCA9PSAndW5kZWZpbmVkJykgeyBsb29wID0gZmFsc2U7IH0KICAgIGlmICh0eXBlb2YgY29ubmVjdCA9PT0gJ3VuZGVmaW5lZCcpIHsgY29ubmVjdCA9IGdhbWUuc291bmQuY29ubmVjdFRvTWFzdGVyOyB9CgogICAgLyoqCiAgICAqIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBOYW1lIG9mIHRoZSBzb3VuZC4KICAgICovCiAgICB0aGlzLm5hbWUgPSBrZXk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSBzb3VuZC4KICAgICovCiAgICB0aGlzLmtleSA9IGtleTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBsb29wIC0gV2hldGhlciBvciBub3QgdGhlIHNvdW5kIHdpbGwgbG9vcC4KICAgICovCiAgICB0aGlzLmxvb3AgPSBsb29wOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3ZvbHVtZSAtIFRoZSBnbG9iYWwgYXVkaW8gdm9sdW1lLiBBIHZhbHVlIGJldHdlZW4gMCAoc2lsZW5jZSkgYW5kIDEgKGZ1bGwgdm9sdW1lKS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl92b2x1bWUgPSB2b2x1bWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBtYXJrZXJzIC0gVGhlIHNvdW5kIG1hcmtlcnMuCiAgICAqLwogICAgdGhpcy5tYXJrZXJzID0ge307CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0F1ZGlvQ29udGV4dH0gY29udGV4dCAtIFJlZmVyZW5jZSB0byB0aGUgQXVkaW9Db250ZXh0IGluc3RhbmNlLgogICAgKi8KICAgIHRoaXMuY29udGV4dCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9idWZmZXIgLSBEZWNvZGVkIGRhdGEgYnVmZmVyIC8gQXVkaW8gdGFnLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2J1ZmZlciA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX211dGVkIC0gQm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHNvdW5kIGlzIG11dGVkIG9yIG5vdC4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9tdXRlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGF1dG9wbGF5IC0gQm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHNvdW5kIHNob3VsZCBzdGFydCBhdXRvbWF0aWNhbGx5LgogICAgKi8KICAgIHRoaXMuYXV0b3BsYXkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsRHVyYXRpb24gLSBUaGUgdG90YWwgZHVyYXRpb24gb2YgdGhlIHNvdW5kLCBpbiBtaWxsaXNlY29uZHMKICAgICovCiAgICB0aGlzLnRvdGFsRHVyYXRpb24gPSAwOwogICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc3RhcnRUaW1lIC0gVGhlIHRpbWUgdGhlIFNvdW5kIHN0YXJ0cyBhdCAodHlwaWNhbGx5IDAgdW5sZXNzIHN0YXJ0aW5nIGZyb20gYSBtYXJrZXIpCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zdGFydFRpbWUgPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGN1cnJlbnRUaW1lIC0gVGhlIGN1cnJlbnQgdGltZSB0aGUgc291bmQgaXMgYXQuCiAgICAqLwogICAgdGhpcy5jdXJyZW50VGltZSA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZHVyYXRpb24gLSBUaGUgZHVyYXRpb24gb2YgdGhlIHNvdW5kLgogICAgKi8KICAgIHRoaXMuZHVyYXRpb24gPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHN0b3BUaW1lIC0gVGhlIHRpbWUgdGhlIHNvdW5kIHN0b3BwZWQuCiAgICAqLwogICAgdGhpcy5zdG9wVGltZSA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHBhdXNlZCAtIHRydWUgaWYgdGhlIHNvdW5kIGlzIHBhdXNlZCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGF1c2VkID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGF1c2VkUG9zaXRpb24gLSBUaGUgcG9zaXRpb24gdGhlIHNvdW5kIGhhZCByZWFjaGVkIHdoZW4gaXQgd2FzIHBhdXNlZC4KICAgICovCiAgICB0aGlzLnBhdXNlZFBvc2l0aW9uID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBhdXNlZFRpbWUgLSBUaGUgZ2FtZSB0aW1lIGF0IHdoaWNoIHRoZSBzb3VuZCB3YXMgcGF1c2VkLgogICAgKi8KICAgIHRoaXMucGF1c2VkVGltZSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNQbGF5aW5nIC0gdHJ1ZSBpZiB0aGUgc291bmQgaXMgY3VycmVudGx5IHBsYXlpbmcsIG90aGVyd2lzZSBmYWxzZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzUGxheWluZyA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGN1cnJlbnRNYXJrZXIgLSBUaGUgc3RyaW5nIElEIG9mIHRoZSBjdXJyZW50bHkgcGxheWluZyBtYXJrZXIsIGlmIGFueS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmN1cnJlbnRNYXJrZXIgPSAnJzsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGVuZGluZ1BsYXliYWNrIC0gdHJ1ZSBpZiB0aGUgc291bmQgZmlsZSBpcyBwZW5kaW5nIHBsYXliYWNrCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMucGVuZGluZ1BsYXliYWNrID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG92ZXJyaWRlIC0gaWYgdHJ1ZSB3aGVuIHlvdSBwbGF5IHRoaXMgc291bmQgaXQgd2lsbCBhbHdheXMgc3RhcnQgZnJvbSB0aGUgYmVnaW5uaW5nLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub3ZlcnJpZGUgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdXNpbmdXZWJBdWRpbyAtIHRydWUgaWYgdGhpcyBzb3VuZCBpcyBiZWluZyBwbGF5ZWQgd2l0aCBXZWIgQXVkaW8uCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMudXNpbmdXZWJBdWRpbyA9IHRoaXMuZ2FtZS5zb3VuZC51c2luZ1dlYkF1ZGlvOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB1c2luZ0F1ZGlvVGFnIC0gdHJ1ZSBpZiB0aGUgc291bmQgaXMgYmVpbmcgcGxheWVkIHZpYSB0aGUgQXVkaW8gdGFnLgogICAgKi8KICAgIHRoaXMudXNpbmdBdWRpb1RhZyA9IHRoaXMuZ2FtZS5zb3VuZC51c2luZ0F1ZGlvVGFnOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gZXh0ZXJuYWxOb2RlIC0gSWYgZGVmaW5lZCB0aGlzIFNvdW5kIHdvbid0IGNvbm5lY3QgdG8gdGhlIFNvdW5kTWFuYWdlciBtYXN0ZXIgZ2FpbiBub2RlLCBidXQgd2lsbCBpbnN0ZWFkIGNvbm5lY3QgdG8gZXh0ZXJuYWxOb2RlLmlucHV0LgogICAgKi8KICAgIHRoaXMuZXh0ZXJuYWxOb2RlID0gbnVsbDsKCiAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgewogICAgICAgIHRoaXMuY29udGV4dCA9IHRoaXMuZ2FtZS5zb3VuZC5jb250ZXh0OwogICAgICAgIHRoaXMubWFzdGVyR2Fpbk5vZGUgPSB0aGlzLmdhbWUuc291bmQubWFzdGVyR2FpbjsKCiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmNvbnRleHQuY3JlYXRlR2FpbiA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhaW5Ob2RlID0gdGhpcy5jb250ZXh0LmNyZWF0ZUdhaW5Ob2RlKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2Fpbk5vZGUgPSB0aGlzLmNvbnRleHQuY3JlYXRlR2FpbigpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5nYWluTm9kZS5nYWluLnZhbHVlID0gdm9sdW1lICogdGhpcy5nYW1lLnNvdW5kLnZvbHVtZTsKCiAgICAgICAgaWYgKGNvbm5lY3QpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhaW5Ob2RlLmNvbm5lY3QodGhpcy5tYXN0ZXJHYWluTm9kZSk7CiAgICAgICAgfQogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGlmICh0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmQoa2V5KSAmJiB0aGlzLmdhbWUuY2FjaGUuaXNTb3VuZFJlYWR5KGtleSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9zb3VuZCA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZERhdGEoa2V5KTsKICAgICAgICAgICAgdGhpcy50b3RhbER1cmF0aW9uID0gMDsKCiAgICAgICAgICAgIGlmICh0aGlzLl9zb3VuZC5kdXJhdGlvbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy50b3RhbER1cmF0aW9uID0gdGhpcy5fc291bmQuZHVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLm9uU291bmRVbmxvY2suYWRkKHRoaXMuc291bmRIYXNVbmxvY2tlZCwgdGhpcyk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uRGVjb2RlZCAtIFRoZSBvbkRlY29kZWQgZXZlbnQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoZSBzb3VuZCBoYXMgZmluaXNoZWQgZGVjb2RpbmcgKHR5cGljYWxseSBmb3IgbXAzIGZpbGVzKQogICAgKi8KICAgIHRoaXMub25EZWNvZGVkID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25QbGF5IC0gVGhlIG9uUGxheSBldmVudCBpcyBkaXNwYXRjaGVkIGVhY2ggdGltZSB0aGlzIHNvdW5kIGlzIHBsYXllZC4KICAgICovCiAgICB0aGlzLm9uUGxheSA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uUGF1c2UgLSBUaGUgb25QYXVzZSBldmVudCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhpcyBzb3VuZCBpcyBwYXVzZWQuCiAgICAqLwogICAgdGhpcy5vblBhdXNlID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25SZXN1bWUgLSBUaGUgb25SZXN1bWUgZXZlbnQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoaXMgc291bmQgaXMgcmVzdW1lZCBmcm9tIGEgcGF1c2VkIHN0YXRlLgogICAgKi8KICAgIHRoaXMub25SZXN1bWUgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkxvb3AgLSBUaGUgb25Mb29wIGV2ZW50IGlzIGRpc3BhdGNoZWQgd2hlbiB0aGlzIHNvdW5kIGxvb3BzIGR1cmluZyBwbGF5YmFjay4KICAgICovCiAgICB0aGlzLm9uTG9vcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uU3RvcCAtIFRoZSBvblN0b3AgZXZlbnQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoaXMgc291bmQgc3RvcHMgcGxheWJhY2suCiAgICAqLwogICAgdGhpcy5vblN0b3AgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbk11dGUgLSBUaGUgb25Nb3VzZSBldmVudCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhpcyBzb3VuZCBpcyBtdXRlZC4KICAgICovCiAgICB0aGlzLm9uTXV0ZSA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uTWFya2VyQ29tcGxldGUgLSBUaGUgb25NYXJrZXJDb21wbGV0ZSBldmVudCBpcyBkaXNwYXRjaGVkIHdoZW4gYSBtYXJrZXIgd2l0aGluIHRoaXMgc291bmQgY29tcGxldGVzIHBsYXliYWNrLgogICAgKi8KICAgIHRoaXMub25NYXJrZXJDb21wbGV0ZSA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7Cgp9OwoKUGhhc2VyLlNvdW5kLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQ2FsbGVkIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGlzIHNvdW5kIGlzIHVubG9ja2VkLgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNzb3VuZEhhc1VubG9ja2VkCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgUGhhc2VyLkNhY2hlIGtleSBvZiB0aGUgc291bmQgZmlsZSB0byBjaGVjayBmb3IgZGVjb2RpbmcuCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBzb3VuZEhhc1VubG9ja2VkOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmIChrZXkgPT0gdGhpcy5rZXkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9zb3VuZCA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZERhdGEodGhpcy5rZXkpOwogICAgICAgICAgICB0aGlzLnRvdGFsRHVyYXRpb24gPSB0aGlzLl9zb3VuZC5kdXJhdGlvbjsKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3NvdW5kIGhhcyB1bmxvY2tlZCcgKyB0aGlzLl9zb3VuZCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAgKiBEZXNjcmlwdGlvbi4KICAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI2FkZE1hcmtlcgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBEZXNjcmlwdGlvbi4KICAgICAqIEBwYXJhbSB7RGVzY3JpcHRpb259IHN0YXJ0IC0gRGVzY3JpcHRpb24uCiAgICAgKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBzdG9wIC0gRGVzY3JpcHRpb24uCiAgICAgKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSB2b2x1bWUgLSBEZXNjcmlwdGlvbi4KICAgICAqIEBwYXJhbSB7RGVzY3JpcHRpb259IGxvb3AgLSBEZXNjcmlwdGlvbi4KICAgIGFkZE1hcmtlcjogZnVuY3Rpb24gKG5hbWUsIHN0YXJ0LCBzdG9wLCB2b2x1bWUsIGxvb3ApIHsKCiAgICAgICAgdm9sdW1lID0gdm9sdW1lIHx8IDE7CiAgICAgICAgaWYgKHR5cGVvZiBsb29wID09ICd1bmRlZmluZWQnKSB7IGxvb3AgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLm1hcmtlcnNbbmFtZV0gPSB7CiAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgIHN0YXJ0OiBzdGFydCwKICAgICAgICAgICAgc3RvcDogc3RvcCwKICAgICAgICAgICAgdm9sdW1lOiB2b2x1bWUsCiAgICAgICAgICAgIGR1cmF0aW9uOiBzdG9wIC0gc3RhcnQsCiAgICAgICAgICAgIGxvb3A6IGxvb3AKICAgICAgICB9OwoKICAgIH0sCiAgICAqLwoKICAgIC8qKgogICAgKiBBZGRzIGEgbWFya2VyIGludG8gdGhlIGN1cnJlbnQgU291bmQuIEEgbWFya2VyIGlzIHJlcHJlc2VudGVkIGJ5IGEgdW5pcXVlIGtleSBhbmQgYSBzdGFydCB0aW1lIGFuZCBkdXJhdGlvbi4KICAgICogVGhpcyBhbGxvd3MgeW91IHRvIGJ1bmRsZSBtdWx0aXBsZSBzb3VuZHMgdG9nZXRoZXIgaW50byBhIHNpbmdsZSBhdWRpbyBmaWxlIGFuZCB1c2UgbWFya2VycyB0byBqdW1wIGJldHdlZW4gdGhlbSBmb3IgcGxheWJhY2suCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI2FkZE1hcmtlcgogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIEEgdW5pcXVlIG5hbWUgZm9yIHRoaXMgbWFya2VyLCBpLmUuICdleHBsb3Npb24nLCAnZ3Vuc2hvdCcsIGV0Yy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0IC0gVGhlIHN0YXJ0IHBvaW50IG9mIHRoaXMgbWFya2VyIGluIHRoZSBhdWRpbyBmaWxlLCBnaXZlbiBpbiBzZWNvbmRzLiAyLjUgPSAyNTAwbXMsIDAuNSA9IDUwMG1zLCBldGMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkdXJhdGlvbiAtIFRoZSBkdXJhdGlvbiBvZiB0aGUgbWFya2VyIGluIHNlY29uZHMuIDIuNSA9IDI1MDBtcywgMC41ID0gNTAwbXMsIGV0Yy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt2b2x1bWU9MV0gLSBUaGUgdm9sdW1lIHRoZSBzb3VuZCB3aWxsIHBsYXkgYmFjayBhdCwgYmV0d2VlbiAwIChzaWxlbnQpIGFuZCAxIChmdWxsIHZvbHVtZSkuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gU2V0cyBpZiB0aGUgc291bmQgd2lsbCBsb29wIG9yIG5vdC4KICAgICovCiAgICBhZGRNYXJrZXI6IGZ1bmN0aW9uIChuYW1lLCBzdGFydCwgZHVyYXRpb24sIHZvbHVtZSwgbG9vcCkgewoKICAgICAgICB2b2x1bWUgPSB2b2x1bWUgfHwgMTsKICAgICAgICBpZiAodHlwZW9mIGxvb3AgPT0gJ3VuZGVmaW5lZCcpIHsgbG9vcCA9IGZhbHNlOyB9CgogICAgICAgIHRoaXMubWFya2Vyc1tuYW1lXSA9IHsKICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0LAogICAgICAgICAgICBzdG9wOiBzdGFydCArIGR1cmF0aW9uLAogICAgICAgICAgICB2b2x1bWU6IHZvbHVtZSwKICAgICAgICAgICAgZHVyYXRpb246IGR1cmF0aW9uLAogICAgICAgICAgICBkdXJhdGlvbk1TOiBkdXJhdGlvbiAqIDEwMDAsCiAgICAgICAgICAgIGxvb3A6IGxvb3AKICAgICAgICB9OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgYSBtYXJrZXIgZnJvbSB0aGUgc291bmQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI3JlbW92ZU1hcmtlcgogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBrZXkgb2YgdGhlIG1hcmtlciB0byByZW1vdmUuCiAgICAqLwogICAgcmVtb3ZlTWFya2VyOiBmdW5jdGlvbiAobmFtZSkgewoKICAgICAgICBkZWxldGUgdGhpcy5tYXJrZXJzW25hbWVdOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IFBoYXNlci5Tb3VuZE1hbmFnZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI3VwZGF0ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnBlbmRpbmdQbGF5YmFjayAmJiB0aGlzLmdhbWUuY2FjaGUuaXNTb3VuZFJlYWR5KHRoaXMua2V5KSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucGVuZGluZ1BsYXliYWNrID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMucGxheSh0aGlzLl90ZW1wTWFya2VyLCB0aGlzLl90ZW1wUG9zaXRpb24sIHRoaXMuX3RlbXBWb2x1bWUsIHRoaXMuX3RlbXBMb29wKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmlzUGxheWluZykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFRpbWUgPSB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLnN0YXJ0VGltZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRUaW1lID49IHRoaXMuZHVyYXRpb25NUykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyh0aGlzLmN1cnJlbnRNYXJrZXIsICdoYXMgaGl0IGR1cmF0aW9uJyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb3ApCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnbG9vcDEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIHdvbid0IHdvcmsgd2l0aCBtYXJrZXJzLCBuZWVkcyB0byByZXNldCB0aGUgcG9zaXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkxvb3AuZGlzcGF0Y2godGhpcyk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50TWFya2VyID09PSAnJykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2xvb3AyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2xvb3AzJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXkodGhpcy5jdXJyZW50TWFya2VyLCAwLCB0aGlzLnZvbHVtZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3N0b3BwaW5nLCBubyBsb29wIGZvciBtYXJrZXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb3ApCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uTG9vcC5kaXNwYXRjaCh0aGlzKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5KHRoaXMuY3VycmVudE1hcmtlciwgMCwgdGhpcy52b2x1bWUsIHRydWUsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgKiBQbGF5IHRoaXMgc291bmQsIG9yIGEgbWFya2VkIHNlY3Rpb24gb2YgaXQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI3BsYXkKICAgICogQHBhcmFtIHtzdHJpbmd9IFttYXJrZXI9JyddIC0gSWYgeW91IHdhbnQgdG8gcGxheSBhIG1hcmtlciB0aGVuIGdpdmUgdGhlIGtleSBoZXJlLCBvdGhlcndpc2UgbGVhdmUgYmxhbmsgdG8gcGxheSB0aGUgZnVsbCBzb3VuZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtwb3NpdGlvbj0wXSAtIFRoZSBzdGFydGluZyBwb3NpdGlvbiB0byBwbGF5IHRoZSBzb3VuZCBmcm9tIC0gdGhpcyBpcyBpZ25vcmVkIGlmIHlvdSBwcm92aWRlIGEgbWFya2VyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ZvbHVtZT0xXSAtIFZvbHVtZSBvZiB0aGUgc291bmQgeW91IHdhbnQgdG8gcGxheS4gSWYgbm9uZSBpcyBnaXZlbiBpdCB3aWxsIHVzZSB0aGUgdm9sdW1lIGdpdmVuIHRvIHRoZSBTb3VuZCB3aGVuIGl0IHdhcyBjcmVhdGVkICh3aGljaCBkZWZhdWx0cyB0byAxIGlmIG5vbmUgd2FzIHNwZWNpZmllZCkuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gTG9vcCB3aGVuIGl0IGZpbmlzaGVkIHBsYXlpbmc/CiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2ZvcmNlUmVzdGFydD10cnVlXSAtIElmIHRoZSBzb3VuZCBpcyBhbHJlYWR5IHBsYXlpbmcgeW91IGNhbiBzZXQgZm9yY2VSZXN0YXJ0IHRvIHJlc3RhcnQgaXQgZnJvbSB0aGUgYmVnaW5uaW5nLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuU291bmR9IFRoaXMgc291bmQgaW5zdGFuY2UuCiAgICAqLwogICAgcGxheTogZnVuY3Rpb24gKG1hcmtlciwgcG9zaXRpb24sIHZvbHVtZSwgbG9vcCwgZm9yY2VSZXN0YXJ0KSB7CgogICAgICAgIG1hcmtlciA9IG1hcmtlciB8fCAnJzsKICAgICAgICBwb3NpdGlvbiA9IHBvc2l0aW9uIHx8IDA7CgogICAgICAgIGlmICh0eXBlb2Ygdm9sdW1lID09PSAndW5kZWZpbmVkJykgeyB2b2x1bWUgPSB0aGlzLl92b2x1bWU7IH0KICAgICAgICBpZiAodHlwZW9mIGxvb3AgPT09ICd1bmRlZmluZWQnKSB7IGxvb3AgPSBmYWxzZTsgfQogICAgICAgIGlmICh0eXBlb2YgZm9yY2VSZXN0YXJ0ID09PSAndW5kZWZpbmVkJykgeyBmb3JjZVJlc3RhcnQgPSB0cnVlOyB9CgogICAgICAgIC8vIGNvbnNvbGUubG9nKHRoaXMubmFtZSArICcgcGxheSAnICsgbWFya2VyICsgJyBwb3NpdGlvbiAnICsgcG9zaXRpb24gKyAnIHZvbHVtZSAnICsgdm9sdW1lICsgJyBsb29wICcgKyBsb29wLCAnZm9yY2UnLCBmb3JjZVJlc3RhcnQpOwoKICAgICAgICBpZiAodGhpcy5pc1BsYXlpbmcgPT09IHRydWUgJiYgZm9yY2VSZXN0YXJ0ID09PSBmYWxzZSAmJiB0aGlzLm92ZXJyaWRlID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBVc2UgUmVzdGFydCBpbnN0ZWFkCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmlzUGxheWluZyAmJiB0aGlzLm92ZXJyaWRlKQogICAgICAgIHsKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2Fza2VkIHRvIHBsYXkgJyArIG1hcmtlciArICcgYnV0IGFscmVhZHkgcGxheWluZyAnICsgdGhpcy5jdXJyZW50TWFya2VyKTsKICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9zb3VuZC5zdG9wID09PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5ub3RlT2ZmKDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnN0b3AoMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy51c2luZ0F1ZGlvVGFnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5wYXVzZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fc291bmQuY3VycmVudFRpbWUgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLmN1cnJlbnRNYXJrZXIgPSBtYXJrZXI7CgogICAgICAgIGlmIChtYXJrZXIgIT09ICcnKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMubWFya2Vyc1ttYXJrZXJdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uID0gdGhpcy5tYXJrZXJzW21hcmtlcl0uc3RhcnQ7CiAgICAgICAgICAgICAgICB0aGlzLnZvbHVtZSA9IHRoaXMubWFya2Vyc1ttYXJrZXJdLnZvbHVtZTsKICAgICAgICAgICAgICAgIHRoaXMubG9vcCA9IHRoaXMubWFya2Vyc1ttYXJrZXJdLmxvb3A7CiAgICAgICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gdGhpcy5tYXJrZXJzW21hcmtlcl0uZHVyYXRpb247CiAgICAgICAgICAgICAgICB0aGlzLmR1cmF0aW9uTVMgPSB0aGlzLm1hcmtlcnNbbWFya2VyXS5kdXJhdGlvbk1TOwoKICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdNYXJrZXIgTG9hZGVkOiAnLCBtYXJrZXIsICdzdGFydDonLCB0aGlzLnBvc2l0aW9uLCAnZW5kOiAnLCB0aGlzLmR1cmF0aW9uLCAnbG9vcCcsIHRoaXMubG9vcCk7CgogICAgICAgICAgICAgICAgdGhpcy5fdGVtcE1hcmtlciA9IG1hcmtlcjsKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBQb3NpdGlvbiA9IHRoaXMucG9zaXRpb247CiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wVm9sdW1lID0gdGhpcy52b2x1bWU7CiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wTG9vcCA9IHRoaXMubG9vcDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiUGhhc2VyLlNvdW5kLnBsYXk6IGF1ZGlvIG1hcmtlciAiICsgbWFya2VyICsgIiBkb2Vzbid0IGV4aXN0Iik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ25vIG1hcmtlciBpbmZvIGxvYWRlZCcsIG1hcmtlcik7CgogICAgICAgICAgICB0aGlzLnBvc2l0aW9uID0gcG9zaXRpb247CiAgICAgICAgICAgIHRoaXMudm9sdW1lID0gdm9sdW1lOwogICAgICAgICAgICB0aGlzLmxvb3AgPSBsb29wOwogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbk1TID0gMDsKCiAgICAgICAgICAgIHRoaXMuX3RlbXBNYXJrZXIgPSBtYXJrZXI7CiAgICAgICAgICAgIHRoaXMuX3RlbXBQb3NpdGlvbiA9IHBvc2l0aW9uOwogICAgICAgICAgICB0aGlzLl90ZW1wVm9sdW1lID0gdm9sdW1lOwogICAgICAgICAgICB0aGlzLl90ZW1wTG9vcCA9IGxvb3A7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIERvZXMgdGhlIHNvdW5kIG5lZWQgZGVjb2Rpbmc/CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FjaGUuaXNTb3VuZERlY29kZWQodGhpcy5rZXkpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgRG8gd2UgbmVlZCB0byBkbyB0aGlzIGV2ZXJ5IHRpbWUgd2UgcGxheT8gSG93IGFib3V0IGp1c3QgaWYgdGhlIGJ1ZmZlciBpcyBlbXB0eT8KICAgICAgICAgICAgICAgIGlmICh0aGlzLl9idWZmZXIgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWZmZXIgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmREYXRhKHRoaXMua2V5KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZCA9IHRoaXMuY29udGV4dC5jcmVhdGVCdWZmZXJTb3VyY2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmJ1ZmZlciA9IHRoaXMuX2J1ZmZlcjsKICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuZXh0ZXJuYWxOb2RlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmNvbm5lY3QodGhpcy5leHRlcm5hbE5vZGUuaW5wdXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmNvbm5lY3QodGhpcy5nYWluTm9kZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy50b3RhbER1cmF0aW9uID0gdGhpcy5fc291bmQuYnVmZmVyLmR1cmF0aW9uOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmR1cmF0aW9uID09PSAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdkdXJhdGlvbiByZXNldCcpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHVyYXRpb24gPSB0aGlzLnRvdGFsRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kdXJhdGlvbk1TID0gdGhpcy50b3RhbER1cmF0aW9uICogMTAwMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29wICYmIG1hcmtlciA9PT0gJycpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQubG9vcCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gIFVzZWZ1bCB0byBjYWNoZSB0aGlzIHNvbWV3aGVyZSBwZXJoYXBzPwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9zb3VuZC5zdGFydCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQubm90ZUdyYWluT24oMCwgdGhpcy5wb3NpdGlvbiwgdGhpcy5kdXJhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5fc291bmQubm90ZUdyYWluT24oMCwgdGhpcy5wb3NpdGlvbiwgdGhpcy5kdXJhdGlvbiAvIDEwMDApOwogICAgICAgICAgICAgICAgICAgIC8vdGhpcy5fc291bmQubm90ZU9uKDApOyAvLyB0aGUgemVybyBpcyB2aXRhbGx5IGltcG9ydGFudCwgY3Jhc2hlcyBpT1M2IHdpdGhvdXQgaXQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLl9zb3VuZC5zdGFydCgwLCB0aGlzLnBvc2l0aW9uLCB0aGlzLmR1cmF0aW9uIC8gMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQuc3RhcnQoMCwgdGhpcy5wb3NpdGlvbiwgdGhpcy5kdXJhdGlvbik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5zdGFydFRpbWUgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcFRpbWUgPSB0aGlzLnN0YXJ0VGltZSArIHRoaXMuZHVyYXRpb25NUzsKICAgICAgICAgICAgICAgIHRoaXMub25QbGF5LmRpc3BhdGNoKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nUGxheWJhY2sgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmQodGhpcy5rZXkpICYmIHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZCh0aGlzLmtleSkuaXNEZWNvZGluZyA9PT0gZmFsc2UpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNvdW5kLmRlY29kZSh0aGlzLmtleSwgdGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ1NvdW5kIHBsYXkgQXVkaW8nKTsKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZCh0aGlzLmtleSkgJiYgdGhpcy5nYW1lLmNhY2hlLmdldFNvdW5kKHRoaXMua2V5KS5sb2NrZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCd0cmllZCBwbGF5aW5nIGxvY2tlZCBzb3VuZCwgcGVuZGluZyBzZXQsIHJlbG9hZCBzdGFydGVkJyk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUucmVsb2FkU291bmQodGhpcy5rZXkpOwogICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nUGxheWJhY2sgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3NvdW5kIG5vdCBsb2NrZWQsIHN0YXRlPycsIHRoaXMuX3NvdW5kLnJlYWR5U3RhdGUpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3NvdW5kICYmICh0aGlzLmdhbWUuZGV2aWNlLmNvY29vbkpTIHx8IHRoaXMuX3NvdW5kLnJlYWR5U3RhdGUgPT09IDQpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICAvLyAgVGhpcyBkb2Vzbid0IGJlY29tZSBhdmFpbGFibGUgdW50aWwgeW91IGNhbGwgcGxheSgpLCB3b25kZXJmdWwgLi4uCiAgICAgICAgICAgICAgICAgICAgdGhpcy50b3RhbER1cmF0aW9uID0gdGhpcy5fc291bmQuZHVyYXRpb247CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmR1cmF0aW9uID09PSAwKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IHRoaXMudG90YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kdXJhdGlvbk1TID0gdGhpcy50b3RhbER1cmF0aW9uICogMTAwMDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdwbGF5aW5nJywgdGhpcy5fc291bmQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmN1cnJlbnRUaW1lID0gdGhpcy5wb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5tdXRlZCA9IHRoaXMuX211dGVkOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9tdXRlZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnZvbHVtZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnZvbHVtZSA9IHRoaXMuX3ZvbHVtZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNQbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3BUaW1lID0gdGhpcy5zdGFydFRpbWUgKyB0aGlzLmR1cmF0aW9uTVM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vblBsYXkuZGlzcGF0Y2godGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nUGxheWJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogUmVzdGFydCB0aGUgc291bmQsIG9yIGEgbWFya2VkIHNlY3Rpb24gb2YgaXQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI3Jlc3RhcnQKICAgICogQHBhcmFtIHtzdHJpbmd9IFttYXJrZXI9JyddIC0gSWYgeW91IHdhbnQgdG8gcGxheSBhIG1hcmtlciB0aGVuIGdpdmUgdGhlIGtleSBoZXJlLCBvdGhlcndpc2UgbGVhdmUgYmxhbmsgdG8gcGxheSB0aGUgZnVsbCBzb3VuZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtwb3NpdGlvbj0wXSAtIFRoZSBzdGFydGluZyBwb3NpdGlvbiB0byBwbGF5IHRoZSBzb3VuZCBmcm9tIC0gdGhpcyBpcyBpZ25vcmVkIGlmIHlvdSBwcm92aWRlIGEgbWFya2VyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ZvbHVtZT0xXSAtIFZvbHVtZSBvZiB0aGUgc291bmQgeW91IHdhbnQgdG8gcGxheS4KICAgICogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBMb29wIHdoZW4gaXQgZmluaXNoZWQgcGxheWluZz8KICAgICovCiAgICByZXN0YXJ0OiBmdW5jdGlvbiAobWFya2VyLCBwb3NpdGlvbiwgdm9sdW1lLCBsb29wKSB7CgogICAgICAgIG1hcmtlciA9IG1hcmtlciB8fCAnJzsKICAgICAgICBwb3NpdGlvbiA9IHBvc2l0aW9uIHx8IDA7CiAgICAgICAgdm9sdW1lID0gdm9sdW1lIHx8IDE7CiAgICAgICAgaWYgKHR5cGVvZiBsb29wID09ICd1bmRlZmluZWQnKSB7IGxvb3AgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLnBsYXkobWFya2VyLCBwb3NpdGlvbiwgdm9sdW1lLCBsb29wLCB0cnVlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXVzZXMgdGhlIHNvdW5kCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI3BhdXNlCiAgICAqLwogICAgcGF1c2U6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuaXNQbGF5aW5nICYmIHRoaXMuX3NvdW5kKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMucGF1c2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5wYXVzZWRQb3NpdGlvbiA9IHRoaXMuY3VycmVudFRpbWU7CiAgICAgICAgICAgIHRoaXMucGF1c2VkVGltZSA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgdGhpcy5vblBhdXNlLmRpc3BhdGNoKHRoaXMpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXN1bWVzIHRoZSBzb3VuZAogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNyZXN1bWUKICAgICovCiAgICByZXN1bWU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMucGF1c2VkICYmIHRoaXMuX3NvdW5kKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHAgPSB0aGlzLnBvc2l0aW9uICsgKHRoaXMucGF1c2VkUG9zaXRpb24gLyAxMDAwKTsKCiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZCA9IHRoaXMuY29udGV4dC5jcmVhdGVCdWZmZXJTb3VyY2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmJ1ZmZlciA9IHRoaXMuX2J1ZmZlcjsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5leHRlcm5hbE5vZGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQuY29ubmVjdCh0aGlzLmV4dGVybmFsTm9kZS5pbnB1dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQuY29ubmVjdCh0aGlzLmdhaW5Ob2RlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29wKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmxvb3AgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5fc291bmQuc3RhcnQgPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLm5vdGVHcmFpbk9uKDAsIHAsIHRoaXMuZHVyYXRpb24pOwogICAgICAgICAgICAgICAgICAgIC8vdGhpcy5fc291bmQubm90ZU9uKDApOyAvLyB0aGUgemVybyBpcyB2aXRhbGx5IGltcG9ydGFudCwgY3Jhc2hlcyBpT1M2IHdpdGhvdXQgaXQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5zdGFydCgwLCBwLCB0aGlzLmR1cmF0aW9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnBsYXkoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnBhdXNlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnN0YXJ0VGltZSArPSAodGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5wYXVzZWRUaW1lKTsKICAgICAgICAgICAgdGhpcy5vblJlc3VtZS5kaXNwYXRjaCh0aGlzKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcCBwbGF5aW5nIHRoaXMgc291bmQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI3N0b3AKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmlzUGxheWluZyAmJiB0aGlzLl9zb3VuZCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnVzaW5nV2ViQXVkaW8pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5fc291bmQuc3RvcCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQubm90ZU9mZigwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5zdG9wKDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudXNpbmdBdWRpb1RhZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc291bmQucGF1c2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgcHJldk1hcmtlciA9IHRoaXMuY3VycmVudE1hcmtlcjsKICAgICAgICAKICAgICAgICB0aGlzLmN1cnJlbnRNYXJrZXIgPSAnJzsKICAgICAgICB0aGlzLm9uU3RvcC5kaXNwYXRjaCh0aGlzLCBwcmV2TWFya2VyKTsKCiAgICB9Cgp9OwoKUGhhc2VyLlNvdW5kLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5Tb3VuZDsKCi8qKgoqIEBuYW1lIFBoYXNlci5Tb3VuZCNpc0RlY29kaW5nCiogQHByb3BlcnR5IHtib29sZWFufSBpc0RlY29kaW5nIC0gUmV0dXJucyB0cnVlIGlmIHRoZSBzb3VuZCBmaWxlIGlzIHN0aWxsIGRlY29kaW5nLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNvdW5kLnByb3RvdHlwZSwgImlzRGVjb2RpbmciLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZCh0aGlzLmtleSkuaXNEZWNvZGluZzsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNvdW5kI2lzRGVjb2RlZAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNEZWNvZGVkIC0gUmV0dXJucyB0cnVlIGlmIHRoZSBzb3VuZCBmaWxlIGhhcyBkZWNvZGVkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNvdW5kLnByb3RvdHlwZSwgImlzRGVjb2RlZCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLmNhY2hlLmlzU291bmREZWNvZGVkKHRoaXMua2V5KTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNvdW5kI211dGUKKiBAcHJvcGVydHkge2Jvb2xlYW59IG11dGUgLSBHZXRzIG9yIHNldHMgdGhlIG11dGVkIHN0YXRlIG9mIHRoaXMgc291bmQuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU291bmQucHJvdG90eXBlLCAibXV0ZSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX211dGVkOwogICAgfSwKIAogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCBudWxsOwoKICAgICAgICBpZiAodmFsdWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9tdXRlZCA9IHRydWU7CgogICAgICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9tdXRlVm9sdW1lID0gdGhpcy5nYWluTm9kZS5nYWluLnZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5nYWluTm9kZS5nYWluLnZhbHVlID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLnVzaW5nQXVkaW9UYWcgJiYgdGhpcy5fc291bmQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX211dGVWb2x1bWUgPSB0aGlzLl9zb3VuZC52b2x1bWU7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC52b2x1bWUgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX211dGVkID0gZmFsc2U7CgogICAgICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmdhaW5Ob2RlLmdhaW4udmFsdWUgPSB0aGlzLl9tdXRlVm9sdW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudXNpbmdBdWRpb1RhZyAmJiB0aGlzLl9zb3VuZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc291bmQudm9sdW1lID0gdGhpcy5fbXV0ZVZvbHVtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5vbk11dGUuZGlzcGF0Y2godGhpcyk7CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuU291bmQjdm9sdW1lCiogQHByb3BlcnR5IHtudW1iZXJ9IHZvbHVtZSAtIEdldHMgb3Igc2V0cyB0aGUgdm9sdW1lIG9mIHRoaXMgc291bmQsIGEgdmFsdWUgYmV0d2VlbiAwIGFuZCAxLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNvdW5kLnByb3RvdHlwZSwgInZvbHVtZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdm9sdW1lOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fdm9sdW1lID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnVzaW5nQXVkaW9UYWcgJiYgdGhpcy5fc291bmQpCiAgICAgICAgewogICAgICAgICAgICAvLyAgQ2F1c2VzIGFuIEluZGV4IHNpemUgZXJyb3IgaW4gRmlyZWZveCBpZiB5b3UgZG9uJ3QgY2xhbXAgdGhlIHZhbHVlCiAgICAgICAgICAgIGlmICh2YWx1ZSA+PSAwICYmIHZhbHVlIDw9IDEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3ZvbHVtZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5fc291bmQudm9sdW1lID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFNvdW5kIE1hbmFnZXIgY29uc3RydWN0b3IuCiogVGhlIFNvdW5kIE1hbmFnZXIgaXMgcmVzcG9uc2libGUgZm9yIHBsYXlpbmcgYmFjayBhdWRpbyB2aWEgZWl0aGVyIHRoZSBMZWdhY3kgSFRNTCBBdWRpbyB0YWcgb3IgdmlhIFdlYiBBdWRpbyBpZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBpdC4KKiBOb3RlOiBPbiBGaXJlZm94IDI1KyBvbiBMaW51eCBpZiB5b3UgaGF2ZSBtZWRpYS5nc3RyZWFtZXIgZGlzYWJsZWQgaW4gYWJvdXQ6Y29uZmlnIHRoZW4gaXQgY2Fubm90IHBsYXkgYmFjayBtcDMgb3IgbTRhIGZpbGVzLgoqCiogQGNsYXNzIFBoYXNlci5Tb3VuZE1hbmFnZXIKKiBAY2xhc3NkZXNjIFBoYXNlciBTb3VuZCBNYW5hZ2VyLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50IGdhbWUgaW5zdGFuY2UuCiovClBoYXNlci5Tb3VuZE1hbmFnZXIgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Tb3VuZERlY29kZSAtIFRoZSBldmVudCBkaXNwYXRjaGVkIHdoZW4gYSBzb3VuZCBkZWNvZGVzICh0eXBpY2FsbHkgb25seSBmb3IgbXAzIGZpbGVzKQogICAgKi8KICAgIHRoaXMub25Tb3VuZERlY29kZSA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9tdXRlZCAtIEludGVybmFsIG11dGUgdHJhY2tpbmcgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX211dGVkID0gZmFsc2U7CiAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF91bmxvY2tTb3VyY2UgLSBJbnRlcm5hbCB1bmxvY2sgdHJhY2tpbmcgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3VubG9ja1NvdXJjZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdm9sdW1lIC0gVGhlIGdsb2JhbCBhdWRpbyB2b2x1bWUuIEEgdmFsdWUgYmV0d2VlbiAwIChzaWxlbmNlKSBhbmQgMSAoZnVsbCB2b2x1bWUpLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdCAKICAgICovCiAgICB0aGlzLl92b2x1bWUgPSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBfc291bmRzIC0gQW4gYXJyYXkgY29udGFpbmluZyBhbGwgdGhlIHNvdW5kcyAKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQgVGhlIGVtcHR5IGFycmF5LgogICAgKi8KICAgIHRoaXMuX3NvdW5kcyA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0F1ZGlvQ29udGV4dH0gY29udGV4dCAtIFRoZSBBdWRpb0NvbnRleHQgYmVpbmcgdXNlZCBmb3IgcGxheWJhY2suCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdXNpbmdXZWJBdWRpbyAtIHRydWUgaWYgdGhpcyBzb3VuZCBpcyBiZWluZyBwbGF5ZWQgd2l0aCBXZWIgQXVkaW8uCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMudXNpbmdXZWJBdWRpbyA9IHRydWU7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHVzaW5nQXVkaW9UYWcgLSB0cnVlIGlmIHRoZSBzb3VuZCBpcyBiZWluZyBwbGF5ZWQgdmlhIHRoZSBBdWRpbyB0YWcuCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMudXNpbmdBdWRpb1RhZyA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBub0F1ZGlvIC0gSGFzIGF1ZGlvIGJlZW4gZGlzYWJsZWQgdmlhIHRoZSBQaGFzZXJHbG9iYWwgb2JqZWN0PyBVc2VmdWwgaWYgeW91IG5lZWQgdG8gdXNlIGEgM3JkIHBhcnR5IGF1ZGlvIGxpYnJhcnkgaW5zdGVhZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm5vQXVkaW8gPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjb25uZWN0VG9NYXN0ZXIgLSBVc2VkIGluIGNvbmp1bmN0aW9uIHdpdGggU291bmQuZXh0ZXJuYWxOb2RlIHRoaXMgYWxsb3dzIHlvdSB0byBzdG9wIGEgU291bmQgbm9kZSBiZWluZyBjb25uZWN0ZWQgdG8gdGhlIFNvdW5kTWFuYWdlciBtYXN0ZXIgZ2FpbiBub2RlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29ubmVjdFRvTWFzdGVyID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB0b3VjaExvY2tlZCAtIHRydWUgaWYgdGhlIGF1ZGlvIHN5c3RlbSBpcyBjdXJyZW50bHkgbG9ja2VkIGF3YWl0aW5nIGEgdG91Y2ggZXZlbnQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50b3VjaExvY2tlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY2hhbm5lbHMgLSBUaGUgbnVtYmVyIG9mIGF1ZGlvIGNoYW5uZWxzIHRvIHVzZSBpbiBwbGF5YmFjay4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNoYW5uZWxzID0gMzI7CiAgICAKfTsKClBoYXNlci5Tb3VuZE1hbmFnZXIucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBJbml0aWFsaXNlcyB0aGUgc291bmQgbWFuYWdlci4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI2Jvb3QKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGJvb3Q6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UuaU9TICYmIHRoaXMuZ2FtZS5kZXZpY2Uud2ViQXVkaW8gPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jaGFubmVscyA9IDE7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS5pT1MgfHwgKHdpbmRvd1snUGhhc2VyR2xvYmFsJ10gJiYgd2luZG93WydQaGFzZXJHbG9iYWwnXS5mYWtlaU9TVG91Y2hMb2NrKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC50b3VjaC5jYWxsYmFja0NvbnRleHQgPSB0aGlzOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQudG91Y2gudG91Y2hTdGFydENhbGxiYWNrID0gdGhpcy51bmxvY2s7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5tb3VzZS5jYWxsYmFja0NvbnRleHQgPSB0aGlzOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQubW91c2UubW91c2VEb3duQ2FsbGJhY2sgPSB0aGlzLnVubG9jazsKICAgICAgICAgICAgdGhpcy50b3VjaExvY2tlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBXaGF0IGFib3V0IGlPUzU/CiAgICAgICAgICAgIHRoaXMudG91Y2hMb2NrZWQgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3dbJ1BoYXNlckdsb2JhbCddKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIENoZWNrIHRvIHNlZSBpZiBhbGwgYXVkaW8gcGxheWJhY2sgaXMgZGlzYWJsZWQgKGkuZS4gaGFuZGxlZCBieSBhIDNyZCBwYXJ0eSBjbGFzcykKICAgICAgICAgICAgaWYgKHdpbmRvd1snUGhhc2VyR2xvYmFsJ10uZGlzYWJsZUF1ZGlvID09PSB0cnVlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnVzaW5nV2ViQXVkaW8gPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMubm9BdWRpbyA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBDaGVjayBpZiB0aGUgV2ViIEF1ZGlvIEFQSSBpcyBkaXNhYmxlZCAoZm9yIHRlc3RpbmcgQXVkaW8gVGFnIHBsYXliYWNrIGR1cmluZyBkZXZlbG9wbWVudCkKICAgICAgICAgICAgaWYgKHdpbmRvd1snUGhhc2VyR2xvYmFsJ10uZGlzYWJsZVdlYkF1ZGlvID09PSB0cnVlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnVzaW5nV2ViQXVkaW8gPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMudXNpbmdBdWRpb1RhZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLm5vQXVkaW8gPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCEhd2luZG93WydBdWRpb0NvbnRleHQnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IG5ldyB3aW5kb3dbJ0F1ZGlvQ29udGV4dCddKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCEhd2luZG93Wyd3ZWJraXRBdWRpb0NvbnRleHQnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IG5ldyB3aW5kb3dbJ3dlYmtpdEF1ZGlvQ29udGV4dCddKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCEhd2luZG93WydBdWRpbyddKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy51c2luZ1dlYkF1ZGlvID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMudXNpbmdBdWRpb1RhZyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudXNpbmdXZWJBdWRpbyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm5vQXVkaW8gPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCAhPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5jb250ZXh0LmNyZWF0ZUdhaW4gPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm1hc3RlckdhaW4gPSB0aGlzLmNvbnRleHQuY3JlYXRlR2Fpbk5vZGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMubWFzdGVyR2FpbiA9IHRoaXMuY29udGV4dC5jcmVhdGVHYWluKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWFzdGVyR2Fpbi5nYWluLnZhbHVlID0gMTsKICAgICAgICAgICAgdGhpcy5tYXN0ZXJHYWluLmNvbm5lY3QodGhpcy5jb250ZXh0LmRlc3RpbmF0aW9uKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogRW5hYmxlcyB0aGUgYXVkaW8sIHVzdWFsbHkgYWZ0ZXIgdGhlIGZpcnN0IHRvdWNoLgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZE1hbmFnZXIjdW5sb2NrCiAgICAqLwogICAgdW5sb2NrOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnRvdWNoTG9ja2VkID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vICBHbG9iYWwgb3ZlcnJpZGUgKG1vc3RseSBmb3IgQXVkaW8gVGFnIHRlc3RpbmcpCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2Uud2ViQXVkaW8gPT09IGZhbHNlIHx8ICh3aW5kb3dbJ1BoYXNlckdsb2JhbCddICYmIHdpbmRvd1snUGhhc2VyR2xvYmFsJ10uZGlzYWJsZVdlYkF1ZGlvID09PSB0cnVlKSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBDcmVhdGUgYW4gQXVkaW8gdGFnPwogICAgICAgICAgICB0aGlzLnRvdWNoTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX3VubG9ja1NvdXJjZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC50b3VjaC5jYWxsYmFja0NvbnRleHQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQudG91Y2gudG91Y2hTdGFydENhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm1vdXNlLmNhbGxiYWNrQ29udGV4dCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5tb3VzZS5tb3VzZURvd25DYWxsYmFjayA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vIENyZWF0ZSBlbXB0eSBidWZmZXIgYW5kIHBsYXkgaXQKICAgICAgICAgICAgdmFyIGJ1ZmZlciA9IHRoaXMuY29udGV4dC5jcmVhdGVCdWZmZXIoMSwgMSwgMjIwNTApOwogICAgICAgICAgICB0aGlzLl91bmxvY2tTb3VyY2UgPSB0aGlzLmNvbnRleHQuY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgIHRoaXMuX3VubG9ja1NvdXJjZS5idWZmZXIgPSBidWZmZXI7CiAgICAgICAgICAgIHRoaXMuX3VubG9ja1NvdXJjZS5jb25uZWN0KHRoaXMuY29udGV4dC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgIHRoaXMuX3VubG9ja1NvdXJjZS5ub3RlT24oMCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3BzIGFsbCB0aGUgc291bmRzIGluIHRoZSBnYW1lLgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZE1hbmFnZXIjc3RvcEFsbAogICAgKi8KICAgIHN0b3BBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zb3VuZHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fc291bmRzW2ldKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZHNbaV0uc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFBhdXNlcyBhbGwgdGhlIHNvdW5kcyBpbiB0aGUgZ2FtZS4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI3BhdXNlQWxsCiAgICAqLwogICAgcGF1c2VBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zb3VuZHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fc291bmRzW2ldKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZHNbaV0ucGF1c2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiByZXN1bWVzIGV2ZXJ5IHNvdW5kIGluIHRoZSBnYW1lLgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZE1hbmFnZXIjcmVzdW1lQWxsCiAgICAqLwogICAgcmVzdW1lQWxsOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc291bmRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1tpXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc291bmRzW2ldLnJlc3VtZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAKICAgIH0sCgogICAgLyoqCiAgICAqIERlY29kZSBhIHNvdW5kIGJ5IGl0cyBhc3NldHMga2V5LgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZE1hbmFnZXIjZGVjb2RlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldHMga2V5IG9mIHRoZSBzb3VuZCB0byBiZSBkZWNvZGVkLgogICAgKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gW3NvdW5kXSAtIEl0cyBidWZmZXIgd2lsbCBiZSBzZXQgdG8gZGVjb2RlZCBkYXRhLgogICAgKi8KICAgIGRlY29kZTogZnVuY3Rpb24gKGtleSwgc291bmQpIHsKCiAgICAgICAgc291bmQgPSBzb3VuZCB8fCBudWxsOwoKICAgICAgICB2YXIgc291bmREYXRhID0gdGhpcy5nYW1lLmNhY2hlLmdldFNvdW5kRGF0YShrZXkpOwoKICAgICAgICBpZiAoc291bmREYXRhKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5jYWNoZS5pc1NvdW5kRGVjb2RlZChrZXkpID09PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLnVwZGF0ZVNvdW5kKGtleSwgJ2lzRGVjb2RpbmcnLCB0cnVlKTsKCiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CgogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmRlY29kZUF1ZGlvRGF0YShzb3VuZERhdGEsIGZ1bmN0aW9uIChidWZmZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LmdhbWUuY2FjaGUuZGVjb2RlZFNvdW5kKGtleSwgYnVmZmVyKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc291bmQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGF0Lm9uU291bmREZWNvZGUuZGlzcGF0Y2goa2V5LCBzb3VuZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlcyBldmVyeSBzb3VuZCBpbiB0aGUgZ2FtZS4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI3VwZGF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy50b3VjaExvY2tlZCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLndlYkF1ZGlvICYmIHRoaXMuX3VubG9ja1NvdXJjZSAhPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh0aGlzLl91bmxvY2tTb3VyY2UucGxheWJhY2tTdGF0ZSA9PT0gdGhpcy5fdW5sb2NrU291cmNlLlBMQVlJTkdfU1RBVEUgfHwgdGhpcy5fdW5sb2NrU291cmNlLnBsYXliYWNrU3RhdGUgPT09IHRoaXMuX3VubG9ja1NvdXJjZS5GSU5JU0hFRF9TVEFURSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50b3VjaExvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VubG9ja1NvdXJjZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnRvdWNoLmNhbGxiYWNrQ29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnRvdWNoLnRvdWNoU3RhcnRDYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc291bmRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fc291bmRzW2ldLnVwZGF0ZSgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIGEgbmV3IFNvdW5kIGludG8gdGhlIFNvdW5kTWFuYWdlci4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI2FkZAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgc291bmQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdm9sdW1lPTFdIC0gRGVmYXVsdCB2YWx1ZSBmb3IgdGhlIHZvbHVtZS4KICAgICogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBXaGV0aGVyIG9yIG5vdCB0aGUgc291bmQgd2lsbCBsb29wLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjb25uZWN0PXRydWVdIC0gQ29udHJvbHMgaWYgdGhlIGNyZWF0ZWQgU291bmQgb2JqZWN0IHdpbGwgY29ubmVjdCB0byB0aGUgbWFzdGVyIGdhaW5Ob2RlIG9mIHRoZSBTb3VuZE1hbmFnZXIgd2hlbiBydW5uaW5nIHVuZGVyIFdlYkF1ZGlvLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuU291bmR9IFRoZSBuZXcgc291bmQgaW5zdGFuY2UuCiAgICAqLwogICAgYWRkOiBmdW5jdGlvbiAoa2V5LCB2b2x1bWUsIGxvb3AsIGNvbm5lY3QpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB2b2x1bWUgPT09ICd1bmRlZmluZWQnKSB7IHZvbHVtZSA9IDE7IH0KICAgICAgICBpZiAodHlwZW9mIGxvb3AgPT09ICd1bmRlZmluZWQnKSB7IGxvb3AgPSBmYWxzZTsgfQogICAgICAgIGlmICh0eXBlb2YgY29ubmVjdCA9PT0gJ3VuZGVmaW5lZCcpIHsgY29ubmVjdCA9IHRoaXMuY29ubmVjdFRvTWFzdGVyOyB9CgogICAgICAgIHZhciBzb3VuZCA9IG5ldyBQaGFzZXIuU291bmQodGhpcy5nYW1lLCBrZXksIHZvbHVtZSwgbG9vcCwgY29ubmVjdCk7CgogICAgICAgIHRoaXMuX3NvdW5kcy5wdXNoKHNvdW5kKTsKCiAgICAgICAgcmV0dXJuIHNvdW5kOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgYSBuZXcgU291bmQgaW50byB0aGUgU291bmRNYW5hZ2VyIGFuZCBzdGFydHMgaXQgcGxheWluZy4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI3BsYXkKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHNvdW5kLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ZvbHVtZT0xXSAtIERlZmF1bHQgdmFsdWUgZm9yIHRoZSB2b2x1bWUuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gV2hldGhlciBvciBub3QgdGhlIHNvdW5kIHdpbGwgbG9vcC4KICAgICogQHBhcmFtIHtib29sZWFufSBbZGVzdHJveU9uQ29tcGxldGU9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgU291bmQgd2lsbCBkZXN0cm95IGl0c2VsZiBvbmNlIGl0IGhhcyBmaW5pc2hlZCBwbGF5aW5nLCBvciBpcyBzdG9wcGVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuU291bmR9IFRoZSBuZXcgc291bmQgaW5zdGFuY2UuCiAgICAqLwogICAgcGxheTogZnVuY3Rpb24gKGtleSwgdm9sdW1lLCBsb29wLCBkZXN0cm95T25Db21wbGV0ZSkgewoKICAgICAgICBpZiAodHlwZW9mIGRlc3Ryb3lPbkNvbXBsZXRlID09ICd1bmRlZmluZWQnKSB7IGRlc3Ryb3lPbkNvbXBsZXRlID0gZmFsc2U7IH0KCiAgICAgICAgdmFyIHNvdW5kID0gdGhpcy5hZGQoa2V5LCB2b2x1bWUsIGxvb3ApOwoKICAgICAgICBzb3VuZC5wbGF5KCk7CgogICAgICAgIHJldHVybiBzb3VuZDsKCiAgICB9Cgp9OwoKUGhhc2VyLlNvdW5kTWFuYWdlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuU291bmRNYW5hZ2VyOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNvdW5kTWFuYWdlciNtdXRlCiogQHByb3BlcnR5IHtib29sZWFufSBtdXRlIC0gR2V0cyBvciBzZXRzIHRoZSBtdXRlZCBzdGF0ZSBvZiB0aGUgU291bmRNYW5hZ2VyLiBUaGlzIGVmZmVjdHMgYWxsIHNvdW5kcyBpbiB0aGUgZ2FtZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Tb3VuZE1hbmFnZXIucHJvdG90eXBlLCAibXV0ZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuX211dGVkOwoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCBudWxsOwoKICAgICAgICBpZiAodmFsdWUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fbXV0ZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fbXV0ZWQgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fbXV0ZVZvbHVtZSA9IHRoaXMubWFzdGVyR2Fpbi5nYWluLnZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5tYXN0ZXJHYWluLmdhaW4udmFsdWUgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAgTG9vcCB0aHJvdWdoIHNvdW5kcwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NvdW5kcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1tpXS51c2luZ0F1ZGlvVGFnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kc1tpXS5tdXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fbXV0ZWQgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX211dGVkID0gZmFsc2U7CgogICAgICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm1hc3RlckdhaW4uZ2Fpbi52YWx1ZSA9IHRoaXMuX211dGVWb2x1bWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBMb29wIHRocm91Z2ggc291bmRzCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc291bmRzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fc291bmRzW2ldLnVzaW5nQXVkaW9UYWcpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmRzW2ldLm11dGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNvdW5kTWFuYWdlciN2b2x1bWUKKiBAcHJvcGVydHkge251bWJlcn0gdm9sdW1lIC0gR2V0cyBvciBzZXRzIHRoZSBnbG9iYWwgdm9sdW1lIG9mIHRoZSBTb3VuZE1hbmFnZXIsIGEgdmFsdWUgYmV0d2VlbiAwIGFuZCAxLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNvdW5kTWFuYWdlci5wcm90b3R5cGUsICJ2b2x1bWUiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFzdGVyR2Fpbi5nYWluLnZhbHVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdm9sdW1lOwogICAgICAgIH0KCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHZhbHVlID0gdGhpcy5nYW1lLm1hdGguY2xhbXAodmFsdWUsIDEsIDApOwoKICAgICAgICB0aGlzLl92b2x1bWUgPSB2YWx1ZTsKCiAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubWFzdGVyR2Fpbi5nYWluLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQoKICAgICAgICAvLyAgTG9vcCB0aHJvdWdoIHRoZSBzb3VuZCBjYWNoZSBhbmQgY2hhbmdlIHRoZSB2b2x1bWUgb2YgYWxsIGh0bWwgYXVkaW8gdGFncwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc291bmRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1tpXS51c2luZ0F1ZGlvVGFnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZHNbaV0udm9sdW1lID0gdGhpcy5fc291bmRzW2ldLnZvbHVtZSAqIHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIGNvbGxlY3Rpb24gb2YgbWV0aG9kcyBmb3IgZGlzcGxheWluZyBkZWJ1ZyBpbmZvcm1hdGlvbiBhYm91dCBnYW1lIG9iamVjdHMuIFBoYXNlci5EZWJ1ZyByZXF1aXJlcyBhIENBTlZBUyBnYW1lIHR5cGUgaW4gb3JkZXIgdG8gcmVuZGVyLCBzbyBpZiB5b3UndmUgZ290CiogeW91ciBnYW1lIHNldCB0byB1c2UgUGhhc2VyLkFVVE8gdGhlbiBzd2FwIGl0IGZvciBQaGFzZXIuQ0FOVkFTIHRvIGVuc3VyZSBXZWJHTCBkb2Vzbid0IGtpY2sgaW4sIHRoZW4gdGhlIERlYnVnIGZ1bmN0aW9ucyB3aWxsIGFsbCBkaXNwbGF5LgoqCiogQGNsYXNzIFBoYXNlci5VdGlscy5EZWJ1ZwoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLlV0aWxzLkRlYnVnID0gZnVuY3Rpb24gKGdhbWUpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CiAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtDb250ZXh0fSBjb250ZXh0IC0gVGhlIGNhbnZhcyBjb250ZXh0IG9uIHdoaWNoIHRvIHJlbmRlciB0aGUgZGVidWcgaW5mb3JtYXRpb24uCiAgICAqLwogICAgdGhpcy5jb250ZXh0ID0gZ2FtZS5jb250ZXh0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gZm9udCAtIFRoZSBmb250IHRoYXQgdGhlIGRlYnVnIGluZm9ybWF0aW9uIGlzIHJlbmRlcmVkIGluLgogICAgKiBAZGVmYXVsdCAnMTRweCBDb3VyaWVyJwogICAgKi8KICAgIHRoaXMuZm9udCA9ICcxNHB4IENvdXJpZXInOwogICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY29sdW1uV2lkdGggLSBUaGUgc3BhY2luZyBiZXR3ZWVuIGNvbHVtbnMuCiAgICAqLwogICAgdGhpcy5jb2x1bW5XaWR0aCA9IDEwMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGxpbmVIZWlnaHQgLSBUaGUgbGluZSBoZWlnaHQgYmV0d2VlbiB0aGUgZGVidWcgdGV4dC4KICAgICovCiAgICB0aGlzLmxpbmVIZWlnaHQgPSAxNjsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcmVuZGVyU2hhZG93IC0gU2hvdWxkIHRoZSB0ZXh0IGJlIHJlbmRlcmVkIHdpdGggYSBzbGlnaHQgc2hhZG93PyBNYWtlcyBpdCBlYXNpZXIgdG8gcmVhZCBvbiBkaWZmZXJlbnQgdHlwZXMgb2YgYmFja2dyb3VuZC4KICAgICovCiAgICB0aGlzLnJlbmRlclNoYWRvdyA9IHRydWU7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0NvbnRleHR9IGN1cnJlbnRYIC0gVGhlIGN1cnJlbnQgWCBwb3NpdGlvbiB0aGUgZGVidWcgaW5mb3JtYXRpb24gd2lsbCBiZSByZW5kZXJlZCBhdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmN1cnJlbnRYID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjdXJyZW50WSAtIFRoZSBjdXJyZW50IFkgcG9zaXRpb24gdGhlIGRlYnVnIGluZm9ybWF0aW9uIHdpbGwgYmUgcmVuZGVyZWQgYXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jdXJyZW50WSA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY3VycmVudEFscGhhIC0gVGhlIGN1cnJlbnQgYWxwaGEgdGhlIGRlYnVnIGluZm9ybWF0aW9uIHdpbGwgYmUgcmVuZGVyZWQgYXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jdXJyZW50QWxwaGEgPSAxOwoKfTsKClBoYXNlci5VdGlscy5EZWJ1Zy5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZCB0aGF0IHJlc2V0cyBhbmQgc3RhcnRzIHRoZSBkZWJ1ZyBvdXRwdXQgdmFsdWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNzdGFydAogICAgKiBAcGFyYW0ge251bWJlcn0gW3g9MF0gLSBUaGUgWCB2YWx1ZSB0aGUgZGVidWcgaW5mbyB3aWxsIHN0YXJ0IGZyb20uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeT0wXSAtIFRoZSBZIHZhbHVlIHRoZSBkZWJ1ZyBpbmZvIHdpbGwgc3RhcnQgZnJvbS4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gVGhlIGNvbG9yIHRoZSBkZWJ1ZyB0ZXh0IHdpbGwgZHJhd24gaW4uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbY29sdW1uV2lkdGg9MF0gLSBUaGUgc3BhY2luZyBiZXR3ZWVuIGNvbHVtbnMuCiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uICh4LCB5LCBjb2xvciwgY29sdW1uV2lkdGgpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiB4ICE9PSAnbnVtYmVyJykgeyB4ID0gMDsgfQogICAgICAgIGlmICh0eXBlb2YgeSAhPT0gJ251bWJlcicpIHsgeSA9IDA7IH0KICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwyNTUpJzsKICAgICAgICBpZiAodHlwZW9mIGNvbHVtbldpZHRoID09PSAndW5kZWZpbmVkJykgeyBjb2x1bW5XaWR0aCA9IDA7IH0KCiAgICAgICAgdGhpcy5jdXJyZW50WCA9IHg7CiAgICAgICAgdGhpcy5jdXJyZW50WSA9IHk7CiAgICAgICAgdGhpcy5jdXJyZW50Q29sb3IgPSBjb2xvcjsKICAgICAgICB0aGlzLmN1cnJlbnRBbHBoYSA9IHRoaXMuY29udGV4dC5nbG9iYWxBbHBoYTsKICAgICAgICB0aGlzLmNvbHVtbldpZHRoID0gY29sdW1uV2lkdGg7CgogICAgICAgIHRoaXMuY29udGV4dC5zYXZlKCk7CiAgICAgICAgdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybSgxLCAwLCAwLCAxLCAwLCAwKTsKICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSBjb2xvcjsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgdGhpcy5jb250ZXh0LmZvbnQgPSB0aGlzLmZvbnQ7CiAgICAgICAgdGhpcy5jb250ZXh0Lmdsb2JhbEFscGhhID0gMTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QgdGhhdCBzdG9wcyB0aGUgZGVidWcgb3V0cHV0LgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNzdG9wCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmNvbnRleHQucmVzdG9yZSgpOwogICAgICAgIHRoaXMuY29udGV4dC5nbG9iYWxBbHBoYSA9IHRoaXMuY3VycmVudEFscGhhOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZCB0aGF0IG91dHB1dHMgYSBzaW5nbGUgbGluZSBvZiB0ZXh0LgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNsaW5lCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIGxpbmUgb2YgdGV4dCB0byBkcmF3LgogICAgKiBAcGFyYW0ge251bWJlcn0gW3hdIC0gVGhlIFggdmFsdWUgdGhlIGRlYnVnIGluZm8gd2lsbCBzdGFydCBmcm9tLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ldIC0gVGhlIFkgdmFsdWUgdGhlIGRlYnVnIGluZm8gd2lsbCBzdGFydCBmcm9tLgogICAgKi8KICAgIGxpbmU6IGZ1bmN0aW9uICh0ZXh0LCB4LCB5KSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgeCAhPT0gJ3VuZGVmaW5lZCcpIHsgdGhpcy5jdXJyZW50WCA9IHg7IH0KICAgICAgICBpZiAodHlwZW9mIHkgIT09ICd1bmRlZmluZWQnKSB7IHRoaXMuY3VycmVudFkgPSB5OyB9CgogICAgICAgIGlmICh0aGlzLnJlbmRlclNoYWRvdykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSAncmdiKDAsMCwwKSc7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsVGV4dCh0ZXh0LCB0aGlzLmN1cnJlbnRYICsgMSwgdGhpcy5jdXJyZW50WSArIDEpOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gdGhpcy5jdXJyZW50Q29sb3I7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFRleHQodGV4dCwgdGhpcy5jdXJyZW50WCwgdGhpcy5jdXJyZW50WSk7CiAgICAgICAgdGhpcy5jdXJyZW50WSArPSB0aGlzLmxpbmVIZWlnaHQ7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kIHRoYXQgb3V0cHV0cyBhIHNpbmdsZSBsaW5lIG9mIHRleHQgc3BsaXQgb3ZlciBhcyBtYW55IGNvbHVtbnMgYXMgbmVlZGVkLCBvbmUgcGVyIHBhcmFtZXRlci4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjc3BsaXRsaW5lCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIHRleHQgdG8gcmVuZGVyLiBZb3UgY2FuIGhhdmUgYXMgbWFueSBjb2x1bW5zIG9mIHRleHQgYXMgeW91IHdhbnQsIGp1c3QgcGFzcyB0aGVtIGFzIGFkZGl0aW9uYWwgcGFyYW1ldGVycy4KICAgICovCiAgICBzcGxpdGxpbmU6IGZ1bmN0aW9uICh0ZXh0KSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciB4ID0gdGhpcy5jdXJyZW50WDsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5yZW5kZXJTaGFkb3cpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSAncmdiKDAsMCwwKSc7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFRleHQoYXJndW1lbnRzW2ldLCB4ICsgMSwgdGhpcy5jdXJyZW50WSArIDEpOwogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IHRoaXMuY3VycmVudENvbG9yOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFRleHQoYXJndW1lbnRzW2ldLCB4LCB0aGlzLmN1cnJlbnRZKTsKCiAgICAgICAgICAgIHggKz0gdGhpcy5jb2x1bW5XaWR0aDsKICAgICAgICB9CgogICAgICAgIHRoaXMuY3VycmVudFkgKz0gdGhpcy5saW5lSGVpZ2h0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFZpc3VhbGx5IHJlbmRlcnMgYSBRdWFkVHJlZSB0byB0aGUgZGlzcGxheS4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyUXVhZFRyZWUKICAgICogQHBhcmFtIHtQaGFzZXIuUXVhZFRyZWV9IHF1YWR0cmVlIC0gVGhlIHF1YWR0cmVlIHRvIHJlbmRlci4KICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbG9yIC0gVGhlIGNvbG9yIG9mIHRoZSBsaW5lcyBpbiB0aGUgcXVhZHRyZWUuCiAgICAqLwogICAgcmVuZGVyUXVhZFRyZWU6IGZ1bmN0aW9uIChxdWFkdHJlZSwgY29sb3IpIHsKCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiYSgyNTUsMCwwLDAuMyknOwoKICAgICAgICB0aGlzLnN0YXJ0KCk7CgogICAgICAgIHZhciBib3VuZHMgPSBxdWFkdHJlZS5ib3VuZHM7CgogICAgICAgIGlmIChxdWFkdHJlZS5ub2Rlcy5sZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVJlY3QoYm91bmRzLngsIGJvdW5kcy55LCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQpOwogICAgICAgICAgICB0aGlzLnJlbmRlclRleHQocXVhZHRyZWUuSUQgKyAnIC8gJyArIHF1YWR0cmVlLm9iamVjdHMubGVuZ3RoLCBib3VuZHMueCArIDQsIGJvdW5kcy55ICsgMTYsICdyZ2IoMCwyMDAsMCknLCAnMTJweCBDb3VyaWVyJyk7CgogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSAncmdiKDAsMjU1LDApJzsKCiAgICAgICAgICAgIC8vIGNoaWxkcmVuCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVhZHRyZWUub2JqZWN0cy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVJlY3QocXVhZHRyZWUub2JqZWN0c1tpXS54LCBxdWFkdHJlZS5vYmplY3RzW2ldLnksIHF1YWR0cmVlLm9iamVjdHNbaV0ud2lkdGgsIHF1YWR0cmVlLm9iamVjdHNbaV0uaGVpZ2h0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1YWR0cmVlLm5vZGVzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclF1YWRUcmVlKHF1YWR0cmVlLm5vZGVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyB0aGUgY29ybmVycyBhbmQgcG9pbnQgaW5mb3JtYXRpb24gb2YgdGhlIGdpdmVuIFNwcml0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyU3ByaXRlQ29ybmVycwogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFRoZSBzcHJpdGUgdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Nob3dUZXh0PWZhbHNlXSAtIElmIHRydWUgdGhlIHgveSBjb29yZGluYXRlcyBvZiBlYWNoIHBvaW50IHdpbGwgYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Nob3dCb3VuZHM9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgYm91bmRzIHdpbGwgYmUgcmVuZGVyZWQgb3ZlciB0aGUgdG9wIG9mIHRoZSBzcHJpdGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMCwyNTUpJ10gLSBUaGUgY29sb3IgdGhlIHRleHQgaXMgcmVuZGVyZWQgaW4uCiAgICAqLwogICAgcmVuZGVyU3ByaXRlQ29ybmVyczogZnVuY3Rpb24gKHNwcml0ZSwgc2hvd1RleHQsIHNob3dCb3VuZHMsIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHNob3dUZXh0ID0gc2hvd1RleHQgfHwgZmFsc2U7CiAgICAgICAgc2hvd0JvdW5kcyA9IHNob3dCb3VuZHMgfHwgZmFsc2U7CiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwyNTUsMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoMCwgMCwgY29sb3IpOwoKICAgICAgICBpZiAoc2hvd0JvdW5kcykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gJ3JnYmEoMCwgMjU1LCAwLCAwLjcpJzsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVJlY3Qoc3ByaXRlLmJvdW5kcy54LCBzcHJpdGUuYm91bmRzLnksIHNwcml0ZS5ib3VuZHMud2lkdGgsIHNwcml0ZS5ib3VuZHMuaGVpZ2h0KTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgdGhpcy5jb250ZXh0Lm1vdmVUbyhzcHJpdGUudG9wTGVmdC54LCBzcHJpdGUudG9wTGVmdC55KTsKICAgICAgICB0aGlzLmNvbnRleHQubGluZVRvKHNwcml0ZS50b3BSaWdodC54LCBzcHJpdGUudG9wUmlnaHQueSk7CiAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVUbyhzcHJpdGUuYm90dG9tUmlnaHQueCwgc3ByaXRlLmJvdHRvbVJpZ2h0LnkpOwogICAgICAgIHRoaXMuY29udGV4dC5saW5lVG8oc3ByaXRlLmJvdHRvbUxlZnQueCwgc3ByaXRlLmJvdHRvbUxlZnQueSk7CiAgICAgICAgdGhpcy5jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VTdHlsZSA9ICdyZ2JhKDI1NSwgMCwgMjU1LCAwLjcpJzsKICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CgogICAgICAgIHRoaXMucmVuZGVyUG9pbnQoc3ByaXRlLm9mZnNldCk7CiAgICAgICAgdGhpcy5yZW5kZXJQb2ludChzcHJpdGUuY2VudGVyKTsKICAgICAgICB0aGlzLnJlbmRlclBvaW50KHNwcml0ZS50b3BMZWZ0KTsKICAgICAgICB0aGlzLnJlbmRlclBvaW50KHNwcml0ZS50b3BSaWdodCk7CiAgICAgICAgdGhpcy5yZW5kZXJQb2ludChzcHJpdGUuYm90dG9tTGVmdCk7CiAgICAgICAgdGhpcy5yZW5kZXJQb2ludChzcHJpdGUuYm90dG9tUmlnaHQpOwoKICAgICAgICBpZiAoc2hvd1RleHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRDb2xvciA9IGNvbG9yOwogICAgICAgICAgICB0aGlzLmxpbmUoJ3g6ICcgKyBNYXRoLmZsb29yKHNwcml0ZS50b3BMZWZ0LngpICsgJyB5OiAnICsgTWF0aC5mbG9vcihzcHJpdGUudG9wTGVmdC55KSwgc3ByaXRlLnRvcExlZnQueCwgc3ByaXRlLnRvcExlZnQueSk7CiAgICAgICAgICAgIHRoaXMubGluZSgneDogJyArIE1hdGguZmxvb3Ioc3ByaXRlLnRvcFJpZ2h0LngpICsgJyB5OiAnICsgTWF0aC5mbG9vcihzcHJpdGUudG9wUmlnaHQueSksIHNwcml0ZS50b3BSaWdodC54LCBzcHJpdGUudG9wUmlnaHQueSk7CiAgICAgICAgICAgIHRoaXMubGluZSgneDogJyArIE1hdGguZmxvb3Ioc3ByaXRlLmJvdHRvbUxlZnQueCkgKyAnIHk6ICcgKyBNYXRoLmZsb29yKHNwcml0ZS5ib3R0b21MZWZ0LnkpLCBzcHJpdGUuYm90dG9tTGVmdC54LCBzcHJpdGUuYm90dG9tTGVmdC55KTsKICAgICAgICAgICAgdGhpcy5saW5lKCd4OiAnICsgTWF0aC5mbG9vcihzcHJpdGUuYm90dG9tUmlnaHQueCkgKyAnIHk6ICcgKyBNYXRoLmZsb29yKHNwcml0ZS5ib3R0b21SaWdodC55KSwgc3ByaXRlLmJvdHRvbVJpZ2h0LngsIHNwcml0ZS5ib3R0b21SaWdodC55KTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciBTb3VuZCBpbmZvcm1hdGlvbiwgaW5jbHVkaW5nIGRlY29kZWQgc3RhdGUsIGR1cmF0aW9uLCB2b2x1bWUgYW5kIG1vcmUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclNvdW5kSW5mbwogICAgKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gc291bmQgLSBUaGUgc291bmQgb2JqZWN0IHRvIGRlYnVnLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gY29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyU291bmRJbmZvOiBmdW5jdGlvbiAoc291bmQsIHgsIHksIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yKTsKICAgICAgICB0aGlzLmxpbmUoJ1NvdW5kOiAnICsgc291bmQua2V5ICsgJyBMb2NrZWQ6ICcgKyBzb3VuZC5nYW1lLnNvdW5kLnRvdWNoTG9ja2VkKTsKICAgICAgICB0aGlzLmxpbmUoJ0lzIFJlYWR5PzogJyArIHRoaXMuZ2FtZS5jYWNoZS5pc1NvdW5kUmVhZHkoc291bmQua2V5KSArICcgUGVuZGluZyBQbGF5YmFjazogJyArIHNvdW5kLnBlbmRpbmdQbGF5YmFjayk7CiAgICAgICAgdGhpcy5saW5lKCdEZWNvZGVkOiAnICsgc291bmQuaXNEZWNvZGVkICsgJyBEZWNvZGluZzogJyArIHNvdW5kLmlzRGVjb2RpbmcpOwogICAgICAgIHRoaXMubGluZSgnVG90YWwgRHVyYXRpb246ICcgKyBzb3VuZC50b3RhbER1cmF0aW9uICsgJyBQbGF5aW5nOiAnICsgc291bmQuaXNQbGF5aW5nKTsKICAgICAgICB0aGlzLmxpbmUoJ1RpbWU6ICcgKyBzb3VuZC5jdXJyZW50VGltZSk7CiAgICAgICAgdGhpcy5saW5lKCdWb2x1bWU6ICcgKyBzb3VuZC52b2x1bWUgKyAnIE11dGVkOiAnICsgc291bmQubXV0ZSk7CiAgICAgICAgdGhpcy5saW5lKCdXZWJBdWRpbzogJyArIHNvdW5kLnVzaW5nV2ViQXVkaW8gKyAnIEF1ZGlvOiAnICsgc291bmQudXNpbmdBdWRpb1RhZyk7CgogICAgICAgIGlmIChzb3VuZC5jdXJyZW50TWFya2VyICE9PSAnJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubGluZSgnTWFya2VyOiAnICsgc291bmQuY3VycmVudE1hcmtlciArICcgRHVyYXRpb246ICcgKyBzb3VuZC5kdXJhdGlvbik7CiAgICAgICAgICAgIHRoaXMubGluZSgnU3RhcnQ6ICcgKyBzb3VuZC5tYXJrZXJzW3NvdW5kLmN1cnJlbnRNYXJrZXJdLnN0YXJ0ICsgJyBTdG9wOiAnICsgc291bmQubWFya2Vyc1tzb3VuZC5jdXJyZW50TWFya2VyXS5zdG9wKTsKICAgICAgICAgICAgdGhpcy5saW5lKCdQb3NpdGlvbjogJyArIHNvdW5kLnBvc2l0aW9uKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciBjYW1lcmEgaW5mb3JtYXRpb24gaW5jbHVkaW5nIGRpbWVuc2lvbnMgYW5kIGxvY2F0aW9uLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJDYW1lcmFJbmZvCiAgICAqIEBwYXJhbSB7UGhhc2VyLkNhbWVyYX0gY2FtZXJhIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJDYW1lcmFJbmZvOiBmdW5jdGlvbiAoY2FtZXJhLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvcik7CiAgICAgICAgdGhpcy5saW5lKCdDYW1lcmEgKCcgKyBjYW1lcmEud2lkdGggKyAnIHggJyArIGNhbWVyYS5oZWlnaHQgKyAnKScpOwogICAgICAgIHRoaXMubGluZSgnWDogJyArIGNhbWVyYS54ICsgJyBZOiAnICsgY2FtZXJhLnkpOwogICAgICAgIHRoaXMubGluZSgnQm91bmRzIHg6ICcgKyBjYW1lcmEuYm91bmRzLnggKyAnIFk6ICcgKyBjYW1lcmEuYm91bmRzLnkgKyAnIHc6ICcgKyBjYW1lcmEuYm91bmRzLndpZHRoICsgJyBoOiAnICsgY2FtZXJhLmJvdW5kcy5oZWlnaHQpOwogICAgICAgIHRoaXMubGluZSgnVmlldyB4OiAnICsgY2FtZXJhLnZpZXcueCArICcgWTogJyArIGNhbWVyYS52aWV3LnkgKyAnIHc6ICcgKyBjYW1lcmEudmlldy53aWR0aCArICcgaDogJyArIGNhbWVyYS52aWV3LmhlaWdodCk7CiAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXJzIHRoZSBQb2ludGVyLmNpcmNsZSBvYmplY3Qgb250byB0aGUgc3RhZ2UgaW4gZ3JlZW4gaWYgZG93biBvciByZWQgaWYgdXAgYWxvbmcgd2l0aCBkZWJ1ZyB0ZXh0LgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJQb2ludGVyCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtib29sZWFufSBbaGlkZUlmVXA9ZmFsc2VdIC0gRG9lc24ndCByZW5kZXIgdGhlIGNpcmNsZSBpZiB0aGUgcG9pbnRlciBpcyB1cC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtkb3duQ29sb3I9J3JnYmEoMCwyNTUsMCwwLjUpJ10gLSBUaGUgY29sb3IgdGhlIGNpcmNsZSBpcyByZW5kZXJlZCBpbiBpZiBkb3duLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW3VwQ29sb3I9J3JnYmEoMjU1LDAsMCwwLjUpJ10gLSBUaGUgY29sb3IgdGhlIGNpcmNsZSBpcyByZW5kZXJlZCBpbiBpZiB1cCAoYW5kIGhpZGVJZlVwIGlzIGZhbHNlKS4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gY29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyUG9pbnRlcjogZnVuY3Rpb24gKHBvaW50ZXIsIGhpZGVJZlVwLCBkb3duQ29sb3IsIHVwQ29sb3IsIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCB8fCBwb2ludGVyID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGhpZGVJZlVwID09PSAndW5kZWZpbmVkJykgeyBoaWRlSWZVcCA9IGZhbHNlOyB9CiAgICAgICAgZG93bkNvbG9yID0gZG93bkNvbG9yIHx8ICdyZ2JhKDAsMjU1LDAsMC41KSc7CiAgICAgICAgdXBDb2xvciA9IHVwQ29sb3IgfHwgJ3JnYmEoMjU1LDAsMCwwLjUpJzsKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwyNTUpJzsKCiAgICAgICAgaWYgKGhpZGVJZlVwID09PSB0cnVlICYmIHBvaW50ZXIuaXNVcCA9PT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RhcnQocG9pbnRlci54LCBwb2ludGVyLnkgLSAxMDAsIGNvbG9yKTsKICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmFyYyhwb2ludGVyLngsIHBvaW50ZXIueSwgcG9pbnRlci5jaXJjbGUucmFkaXVzLCAwLCBNYXRoLlBJICogMik7CgogICAgICAgIGlmIChwb2ludGVyLmFjdGl2ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBkb3duQ29sb3I7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSB1cENvbG9yOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGwoKTsKICAgICAgICB0aGlzLmNvbnRleHQuY2xvc2VQYXRoKCk7CgogICAgICAgIC8vICBSZW5kZXIgdGhlIHBvaW50cwogICAgICAgIHRoaXMuY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgICB0aGlzLmNvbnRleHQubW92ZVRvKHBvaW50ZXIucG9zaXRpb25Eb3duLngsIHBvaW50ZXIucG9zaXRpb25Eb3duLnkpOwogICAgICAgIHRoaXMuY29udGV4dC5saW5lVG8ocG9pbnRlci5wb3NpdGlvbi54LCBwb2ludGVyLnBvc2l0aW9uLnkpOwogICAgICAgIHRoaXMuY29udGV4dC5saW5lV2lkdGggPSAyOwogICAgICAgIHRoaXMuY29udGV4dC5zdHJva2UoKTsKICAgICAgICB0aGlzLmNvbnRleHQuY2xvc2VQYXRoKCk7CgogICAgICAgIC8vICBSZW5kZXIgdGhlIHRleHQKICAgICAgICAvLyB0aGlzLnN0YXJ0KHBvaW50ZXIueCwgcG9pbnRlci55IC0gMTAwLCBjb2xvcik7CiAgICAgICAgdGhpcy5saW5lKCdJRDogJyArIHBvaW50ZXIuaWQgKyAiIEFjdGl2ZTogIiArIHBvaW50ZXIuYWN0aXZlKTsKICAgICAgICB0aGlzLmxpbmUoJ1dvcmxkIFg6ICcgKyBwb2ludGVyLndvcmxkWCArICIgV29ybGQgWTogIiArIHBvaW50ZXIud29ybGRZKTsKICAgICAgICB0aGlzLmxpbmUoJ1NjcmVlbiBYOiAnICsgcG9pbnRlci54ICsgIiBTY3JlZW4gWTogIiArIHBvaW50ZXIueSk7CiAgICAgICAgdGhpcy5saW5lKCdEdXJhdGlvbjogJyArIHBvaW50ZXIuZHVyYXRpb24gKyAiIG1zIik7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVyIFNwcml0ZSBJbnB1dCBEZWJ1ZyBpbmZvcm1hdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyU3ByaXRlSW5wdXRJbmZvCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gVGhlIHNwcml0ZSB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclNwcml0ZUlucHV0SW5mbzogZnVuY3Rpb24gKHNwcml0ZSwgeCwgeSwgY29sb3IpIHsKCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwyNTUsMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IpOwogICAgICAgIHRoaXMubGluZSgnU3ByaXRlIElucHV0OiAoJyArIHNwcml0ZS53aWR0aCArICcgeCAnICsgc3ByaXRlLmhlaWdodCArICcpJyk7CiAgICAgICAgdGhpcy5saW5lKCd4OiAnICsgc3ByaXRlLmlucHV0LnBvaW50ZXJYKCkudG9GaXhlZCgxKSArICcgeTogJyArIHNwcml0ZS5pbnB1dC5wb2ludGVyWSgpLnRvRml4ZWQoMSkpOwogICAgICAgIHRoaXMubGluZSgnb3ZlcjogJyArIHNwcml0ZS5pbnB1dC5wb2ludGVyT3ZlcigpICsgJyBkdXJhdGlvbjogJyArIHNwcml0ZS5pbnB1dC5vdmVyRHVyYXRpb24oKS50b0ZpeGVkKDApKTsKICAgICAgICB0aGlzLmxpbmUoJ2Rvd246ICcgKyBzcHJpdGUuaW5wdXQucG9pbnRlckRvd24oKSArICcgZHVyYXRpb246ICcgKyBzcHJpdGUuaW5wdXQuZG93bkR1cmF0aW9uKCkudG9GaXhlZCgwKSk7CiAgICAgICAgdGhpcy5saW5lKCdqdXN0IG92ZXI6ICcgKyBzcHJpdGUuaW5wdXQuanVzdE92ZXIoKSArICcganVzdCBvdXQ6ICcgKyBzcHJpdGUuaW5wdXQuanVzdE91dCgpKTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgU3ByaXRlIEJvZHkgUGh5c2ljcyBEYXRhIGFzIHRleHQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlckJvZHlJbmZvCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gVGhlIHNwcml0ZSB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlckJvZHlJbmZvOiBmdW5jdGlvbiAoc3ByaXRlLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvciwgMjEwKTsKCiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ3g6ICcgKyBzcHJpdGUuYm9keS54LnRvRml4ZWQoMiksICd5OiAnICsgc3ByaXRlLmJvZHkueS50b0ZpeGVkKDIpLCAnd2lkdGg6ICcgKyBzcHJpdGUud2lkdGgsICdoZWlnaHQ6ICcgKyBzcHJpdGUuaGVpZ2h0KTsKICAgICAgICB0aGlzLnNwbGl0bGluZSgnc3BlZWQ6ICcgKyBzcHJpdGUuYm9keS5zcGVlZC50b0ZpeGVkKDIpLCAnYW5nbGU6ICcgKyBzcHJpdGUuYm9keS5hbmdsZS50b0ZpeGVkKDIpLCAnbGluZWFyIGRhbXBpbmc6ICcgKyBzcHJpdGUuYm9keS5saW5lYXJEYW1waW5nKTsKICAgICAgICB0aGlzLnNwbGl0bGluZSgnYmxvY2tlZCBsZWZ0OiAnICsgc3ByaXRlLmJvZHkuYmxvY2tlZC5sZWZ0LCAncmlnaHQ6ICcgKyBzcHJpdGUuYm9keS5ibG9ja2VkLnJpZ2h0LCAndXA6ICcgKyBzcHJpdGUuYm9keS5ibG9ja2VkLnVwLCAnZG93bjogJyArIHNwcml0ZS5ib2R5LmJsb2NrZWQuZG93bik7CiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ3RvdWNoaW5nIGxlZnQ6ICcgKyBzcHJpdGUuYm9keS50b3VjaGluZy5sZWZ0LCAncmlnaHQ6ICcgKyBzcHJpdGUuYm9keS50b3VjaGluZy5yaWdodCwgJ3VwOiAnICsgc3ByaXRlLmJvZHkudG91Y2hpbmcudXAsICdkb3duOiAnICsgc3ByaXRlLmJvZHkudG91Y2hpbmcuZG93bik7CiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ2dyYXZpdHkgeDogJyArIHNwcml0ZS5ib2R5LmdyYXZpdHkueCwgJ3k6ICcgKyBzcHJpdGUuYm9keS5ncmF2aXR5LnksICd3b3JsZCBncmF2aXR5IHg6ICcgKyB0aGlzLmdhbWUucGh5c2ljcy5ncmF2aXR5LngsICd5OiAnICsgdGhpcy5nYW1lLnBoeXNpY3MuZ3Jhdml0eS55KTsKICAgICAgICB0aGlzLnNwbGl0bGluZSgnYWNjZWxlcmF0aW9uIHg6ICcgKyBzcHJpdGUuYm9keS5hY2NlbGVyYXRpb24ueC50b0ZpeGVkKDIpLCAneTogJyArIHNwcml0ZS5ib2R5LmFjY2VsZXJhdGlvbi55LnRvRml4ZWQoMikpOwogICAgICAgIHRoaXMuc3BsaXRsaW5lKCd2ZWxvY2l0eSB4OiAnICsgc3ByaXRlLmJvZHkudmVsb2NpdHkueC50b0ZpeGVkKDIpLCAneTogJyArIHNwcml0ZS5ib2R5LnZlbG9jaXR5LnkudG9GaXhlZCgyKSwgJ2RlbHRhWDogJyArIHNwcml0ZS5ib2R5LmRlbHRhWCgpLnRvRml4ZWQoMiksICdkZWx0YVk6ICcgKyBzcHJpdGUuYm9keS5kZWx0YVkoKS50b0ZpeGVkKDIpKTsKICAgICAgICB0aGlzLnNwbGl0bGluZSgnYm91bmNlIHg6ICcgKyBzcHJpdGUuYm9keS5ib3VuY2UueC50b0ZpeGVkKDIpLCAneTogJyArIHNwcml0ZS5ib2R5LmJvdW5jZS55LnRvRml4ZWQoMikpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciBkZWJ1ZyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgSW5wdXQgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJJbnB1dEluZm8KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlcklucHV0SW5mbzogZnVuY3Rpb24gKHgsIHksIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDApJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvcik7CiAgICAgICAgdGhpcy5saW5lKCdJbnB1dCcpOwogICAgICAgIHRoaXMubGluZSgnWDogJyArIHRoaXMuZ2FtZS5pbnB1dC54ICsgJyBZOiAnICsgdGhpcy5nYW1lLmlucHV0LnkpOwogICAgICAgIHRoaXMubGluZSgnV29ybGQgWDogJyArIHRoaXMuZ2FtZS5pbnB1dC53b3JsZFggKyAnIFdvcmxkIFk6ICcgKyB0aGlzLmdhbWUuaW5wdXQud29ybGRZKTsKICAgICAgICB0aGlzLmxpbmUoJ1NjYWxlIFg6ICcgKyB0aGlzLmdhbWUuaW5wdXQuc2NhbGUueC50b0ZpeGVkKDEpICsgJyBTY2FsZSBZOiAnICsgdGhpcy5nYW1lLmlucHV0LnNjYWxlLngudG9GaXhlZCgxKSk7CiAgICAgICAgdGhpcy5saW5lKCdTY3JlZW4gWDogJyArIHRoaXMuZ2FtZS5pbnB1dC5hY3RpdmVQb2ludGVyLnNjcmVlblggKyAnIFNjcmVlbiBZOiAnICsgdGhpcy5nYW1lLmlucHV0LmFjdGl2ZVBvaW50ZXIuc2NyZWVuWSk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVyIGRlYnVnIGluZm9zIChpbmNsdWRpbmcgbmFtZSwgYm91bmRzIGluZm8sIHBvc2l0aW9uIGFuZCBzb21lIG90aGVyIHByb3BlcnRpZXMpIGFib3V0IHRoZSBTcHJpdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclNwcml0ZUluZm8KICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclNwcml0ZUluZm86IGZ1bmN0aW9uIChzcHJpdGUsIHgsIHksIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsIDI1NSwgMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IpOwoKICAgICAgICB0aGlzLmxpbmUoJ1Nwcml0ZTogJyArICcgKCcgKyBzcHJpdGUud2lkdGggKyAnIHggJyArIHNwcml0ZS5oZWlnaHQgKyAnKSBhbmNob3I6ICcgKyBzcHJpdGUuYW5jaG9yLnggKyAnIHggJyArIHNwcml0ZS5hbmNob3IueSk7CiAgICAgICAgdGhpcy5saW5lKCd4OiAnICsgc3ByaXRlLngudG9GaXhlZCgxKSArICcgeTogJyArIHNwcml0ZS55LnRvRml4ZWQoMSkpOwogICAgICAgIHRoaXMubGluZSgnYW5nbGU6ICcgKyBzcHJpdGUuYW5nbGUudG9GaXhlZCgxKSArICcgcm90YXRpb246ICcgKyBzcHJpdGUucm90YXRpb24udG9GaXhlZCgxKSk7CiAgICAgICAgdGhpcy5saW5lKCd2aXNpYmxlOiAnICsgc3ByaXRlLnZpc2libGUgKyAnIGluIGNhbWVyYTogJyArIHNwcml0ZS5pbkNhbWVyYSk7CiAgICAgICAgdGhpcy5saW5lKCdib2R5IHg6ICcgKyBzcHJpdGUuYm9keS54LnRvRml4ZWQoMSkgKyAnIHk6ICcgKyBzcHJpdGUuYm9keS55LnRvRml4ZWQoMSkpOwoKICAgICAgICAvLyAgMCA9IHNjYWxlWAogICAgICAgIC8vICAxID0gc2tld1kKICAgICAgICAvLyAgMiA9IHRyYW5zbGF0ZVgKICAgICAgICAvLyAgMyA9IHNrZXdYCiAgICAgICAgLy8gIDQgPSBzY2FsZVkKICAgICAgICAvLyAgNSA9IHRyYW5zbGF0ZVkKCiAgICAgICAgdGhpcy5saW5lKCdpZDogJyArIHNwcml0ZS5faWQpOwogICAgICAgIHRoaXMubGluZSgnc2NhbGUgeDogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVswXSk7CiAgICAgICAgdGhpcy5saW5lKCdzY2FsZSB5OiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzRdKTsKICAgICAgICB0aGlzLmxpbmUoJ3R4OiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzJdKTsKICAgICAgICB0aGlzLmxpbmUoJ3R5OiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzVdKTsKICAgICAgICB0aGlzLmxpbmUoJ3NrZXcgeDogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVszXSk7CiAgICAgICAgdGhpcy5saW5lKCdza2V3IHk6ICcgKyBzcHJpdGUud29ybGRUcmFuc2Zvcm1bMV0pOwogICAgICAgIHRoaXMubGluZSgnc2R4OiAnICsgc3ByaXRlLmRlbHRhWCk7CiAgICAgICAgdGhpcy5saW5lKCdzZHk6ICcgKyBzcHJpdGUuZGVsdGFZKTsKCiAgICAgICAgLy8gdGhpcy5saW5lKCdpbkNhbWVyYTogJyArIHRoaXMuZ2FtZS5yZW5kZXJlci5zcHJpdGVSZW5kZXJlci5pbkNhbWVyYSh0aGlzLmdhbWUuY2FtZXJhLCBzcHJpdGUpKTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXJzIHRoZSBzcHJpdGUgY29vcmRpbmF0ZXMgaW4gbG9jYWwsIHBvc2l0aW9uYWwgYW5kIHdvcmxkIHNwYWNlLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJTcHJpdGVDb29yZHMKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBsaW5lIC0gVGhlIHNwcml0ZSB0byBpbnNwZWN0LgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gY29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyU3ByaXRlQ29vcmRzOiBmdW5jdGlvbiAoc3ByaXRlLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LCAyNTUsIDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yLCAxMDApOwoKICAgICAgICBpZiAoc3ByaXRlLm5hbWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxpbmUoc3ByaXRlLm5hbWUpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ3g6Jywgc3ByaXRlLngudG9GaXhlZCgyKSwgJ3k6Jywgc3ByaXRlLnkudG9GaXhlZCgyKSk7CiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ3BvcyB4OicsIHNwcml0ZS5wb3NpdGlvbi54LnRvRml4ZWQoMiksICdwb3MgeTonLCBzcHJpdGUucG9zaXRpb24ueS50b0ZpeGVkKDIpKTsKICAgICAgICB0aGlzLnNwbGl0bGluZSgnd29ybGQgeDonLCBzcHJpdGUud29ybGQueC50b0ZpeGVkKDIpLCAnd29ybGQgeTonLCBzcHJpdGUud29ybGQueS50b0ZpeGVkKDIpKTsKCiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyBhIExpbmUgb2JqZWN0IGluIHRoZSBnaXZlbiBjb2xvci4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyTGluZQogICAgKiBAcGFyYW0ge1BoYXNlci5MaW5lfSBsaW5lIC0gVGhlIExpbmUgdG8gcmVuZGVyLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJMaW5lOiBmdW5jdGlvbiAobGluZSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwgMjU1LCAyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCgwLCAwLCBjb2xvcik7CiAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVXaWR0aCA9IDE7CiAgICAgICAgdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgIHRoaXMuY29udGV4dC5tb3ZlVG8obGluZS5zdGFydC54ICsgMC41LCBsaW5lLnN0YXJ0LnkgKyAwLjUpOwogICAgICAgIHRoaXMuY29udGV4dC5saW5lVG8obGluZS5lbmQueCArIDAuNSwgbGluZS5lbmQueSArIDAuNSk7CiAgICAgICAgdGhpcy5jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgICAgIHRoaXMuY29udGV4dC5zdHJva2UoKTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXJzIExpbmUgaW5mb3JtYXRpb24gaW4gdGhlIGdpdmVuIGNvbG9yLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJMaW5lSW5mbwogICAgKiBAcGFyYW0ge1BoYXNlci5MaW5lfSBsaW5lIC0gVGhlIExpbmUgdG8gcmVuZGVyLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gY29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyTGluZUluZm86IGZ1bmN0aW9uIChsaW5lLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LCAyNTUsIDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yLCA4MCk7CiAgICAgICAgdGhpcy5zcGxpdGxpbmUoJ3N0YXJ0Lng6JywgbGluZS5zdGFydC54LnRvRml4ZWQoMiksICdzdGFydC55OicsIGxpbmUuc3RhcnQueS50b0ZpeGVkKDIpKTsKICAgICAgICB0aGlzLnNwbGl0bGluZSgnZW5kLng6JywgbGluZS5lbmQueC50b0ZpeGVkKDIpLCAnZW5kLnk6JywgbGluZS5lbmQueS50b0ZpeGVkKDIpKTsKICAgICAgICB0aGlzLnNwbGl0bGluZSgnbGVuZ3RoOicsIGxpbmUubGVuZ3RoLnRvRml4ZWQoMiksICdhbmdsZTonLCBsaW5lLmFuZ2xlKTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXJzIFBvaW50IGNvb3JkaW5hdGVzIGluIHRoZSBnaXZlbiBjb2xvci4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyUG9pbnRJbmZvCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBzcHJpdGUgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclBvaW50SW5mbzogZnVuY3Rpb24gKHBvaW50LCB4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LCAyNTUsIDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yKTsKICAgICAgICB0aGlzLmxpbmUoJ3B4OiAnICsgcG9pbnQueC50b0ZpeGVkKDEpICsgJyBweTogJyArIHBvaW50LnkudG9GaXhlZCgxKSk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyBqdXN0IHRoZSBmdWxsIFNwcml0ZSBib3VuZHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclNwcml0ZUJvdW5kcwogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yXSAtIENvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2ZpbGw9ZmFsc2VdIC0gSWYgZmFsc2UgdGhlIGJvdW5kcyBvdXRsaW5lIGlzIHJlbmRlcmVkLCBpZiB0cnVlIHRoZSB3aG9sZSByZWN0YW5nbGUgaXMgcmVuZGVyZWQuCiAgICAqLwogICAgcmVuZGVyU3ByaXRlQm9keTogZnVuY3Rpb24gKHNwcml0ZSwgY29sb3IsIGZpbGwpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwwLDI1NSknOwoKICAgICAgICBpZiAodHlwZW9mIGZpbGwgPT09ICd1bmRlZmluZWQnKSB7IGZpbGwgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLnN0YXJ0KDAsIDAsIGNvbG9yKTsKCiAgICAgICAgaWYgKGZpbGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsUmVjdChzcHJpdGUuYm9keS5sZWZ0LCBzcHJpdGUuYm9keS50b3AsIHNwcml0ZS5ib2R5LndpZHRoLCBzcHJpdGUuYm9keS5oZWlnaHQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVJlY3Qoc3ByaXRlLmJvZHkubGVmdCwgc3ByaXRlLmJvZHkudG9wLCBzcHJpdGUuYm9keS53aWR0aCwgc3ByaXRlLmJvZHkuaGVpZ2h0KTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZSgpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyBqdXN0IHRoZSBmdWxsIFNwcml0ZSBib3VuZHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclNwcml0ZUJvdW5kcwogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yXSAtIENvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2ZpbGw9ZmFsc2VdIC0gSWYgZmFsc2UgdGhlIGJvdW5kcyBvdXRsaW5lIGlzIHJlbmRlcmVkLCBpZiB0cnVlIHRoZSB3aG9sZSByZWN0YW5nbGUgaXMgcmVuZGVyZWQuCiAgICAqLwogICAgcmVuZGVyU3ByaXRlQm91bmRzOiBmdW5jdGlvbiAoc3ByaXRlLCBjb2xvciwgZmlsbCkgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDAsMjU1KSc7CgogICAgICAgIGlmICh0eXBlb2YgZmlsbCA9PT0gJ3VuZGVmaW5lZCcpIHsgZmlsbCA9IGZhbHNlOyB9CgogICAgICAgIHRoaXMuc3RhcnQoMCwgMCwgY29sb3IpOwoKICAgICAgICBpZiAoZmlsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHNwcml0ZS5ib3VuZHMueCwgc3ByaXRlLmJvdW5kcy55LCBzcHJpdGUuYm91bmRzLndpZHRoLCBzcHJpdGUuYm91bmRzLmhlaWdodCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VTdHlsZSA9IGNvbG9yOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlUmVjdChzcHJpdGUuYm91bmRzLngsIHNwcml0ZS5ib3VuZHMueSwgc3ByaXRlLmJvdW5kcy53aWR0aCwgc3ByaXRlLmJvdW5kcy5oZWlnaHQpOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXJzIGEgc2luZ2xlIHBpeGVsLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJQaXhlbAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclBpeGVsOiBmdW5jdGlvbiAoeCwgeSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiYSgwLDI1NSwwLDEpJzsKCiAgICAgICAgdGhpcy5zdGFydCgpOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFJlY3QoeCwgeSwgMiwgMik7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyBhIFBvaW50IG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyUG9pbnQKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IHBvaW50IC0gVGhlIFBvaW50IHRvIHJlbmRlci4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclBvaW50OiBmdW5jdGlvbiAocG9pbnQsIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYmEoMCwyNTUsMCwxKSc7CgogICAgICAgIHRoaXMuc3RhcnQoKTsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHBvaW50LngsIHBvaW50LnksIDQsIDQpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMgYSBSZWN0YW5nbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclJlY3RhbmdsZQogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IHJlY3QgLSBUaGUgUmVjdGFuZ2xlIHRvIHJlbmRlci4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclJlY3RhbmdsZTogZnVuY3Rpb24gKHJlY3QsIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYmEoMCwyNTUsMCwwLjMpJzsKCiAgICAgICAgdGhpcy5zdGFydCgpOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFJlY3QocmVjdC54LCByZWN0LnksIHJlY3Qud2lkdGgsIHJlY3QuaGVpZ2h0KTsKICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMgYSBDaXJjbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlckNpcmNsZQogICAgKiBAcGFyYW0ge1BoYXNlci5DaXJjbGV9IGNpcmNsZSAtIFRoZSBDaXJjbGUgdG8gcmVuZGVyLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yXSAtIENvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyQ2lyY2xlOiBmdW5jdGlvbiAoY2lyY2xlLCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2JhKDAsMjU1LDAsMC4zKSc7CgogICAgICAgIHRoaXMuc3RhcnQoKTsKICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yOwogICAgICAgIHRoaXMuY29udGV4dC5hcmMoY2lyY2xlLngsIGNpcmNsZS55LCBjaXJjbGUucmFkaXVzLCAwLCBNYXRoLlBJICogMiwgZmFsc2UpOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsKCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciB0ZXh0LgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJUZXh0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIGxpbmUgb2YgdGV4dCB0byBkcmF3LgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKiBAcGFyYW0ge3N0cmluZ30gZm9udCAtIFRoZSBmb250IG9mIHRleHQgdG8gZHJhdy4KICAgICovCiAgICByZW5kZXJUZXh0OiBmdW5jdGlvbiAodGV4dCwgeCwgeSwgY29sb3IsIGZvbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwyNTUsMjU1KSc7CiAgICAgICAgZm9udCA9IGZvbnQgfHwgJzE2cHggQ291cmllcic7CgogICAgICAgIHRoaXMuc3RhcnQoKTsKICAgICAgICB0aGlzLmNvbnRleHQuZm9udCA9IGZvbnQ7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsVGV4dCh0ZXh0LCB4LCB5KTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJQaHlzaWNzQm9keQogICAgKiBAcGFyYW0ge2FycmF5fSBib2R5CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIFRoZSBjb2xvciB0aGUgcG9seWdvbiBpcyBzdHJva2VkIGluLgogICAgKi8KICAgIHJlbmRlclBoeXNpY3NCb2R5OiBmdW5jdGlvbiAoYm9keSwgY29sb3IsIGNvbnRleHQpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PT0gbnVsbCAmJiBjb250ZXh0ID09PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwyNTUsMjU1KSc7CgogICAgICAgIHZhciB4ID0gYm9keS54IC0gdGhpcy5nYW1lLmNhbWVyYS54OwogICAgICAgIHZhciB5ID0gYm9keS55IC0gdGhpcy5nYW1lLmNhbWVyYS55OwoKICAgICAgICBpZiAoYm9keS50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQ0lSQ0xFKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zdGFydCgwLCAwLCBjb2xvcik7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5hcmMoeCwgeSwgYm9keS5zaGFwZS5yLCAwLCBNYXRoLlBJICogMiwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTsKCiAgICAgICAgICAgIC8vIHRoaXMuY29udGV4dC5zdHJva2VTdHlsZSA9ICdyZ2IoMCwwLDI1NSknOwogICAgICAgICAgICAvLyB0aGlzLmNvbnRleHQuc3Ryb2tlUmVjdChib2R5LmxlZnQsIGJvZHkudG9wLCBib2R5LndpZHRoLCBib2R5LmhlaWdodCk7CgogICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHBvaW50cyA9IGJvZHkucG9seWdvbi5wb2ludHM7CgogICAgICAgICAgICB0aGlzLnN0YXJ0KDAsIDAsIGNvbG9yKTsKCiAgICAgICAgICAgIHRoaXMuY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0Lm1vdmVUbyh4ICsgcG9pbnRzWzBdLngsIHkgKyBwb2ludHNbMF0ueSk7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHBvaW50cy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVUbyh4ICsgcG9pbnRzW2ldLngsIHkgKyBwb2ludHNbaV0ueSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2UoKTsKCiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSAncmdiKDI1NSwwLDApJzsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHggKyBwb2ludHNbMF0ueCAtIDIsIHkgKyBwb2ludHNbMF0ueSAtIDIsIDUsIDUpOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBwb2ludHMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSAncmdiKDI1NSwnICsgKGkgKiA0MCkgKyAnLDApJzsKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsUmVjdCh4ICsgcG9pbnRzW2ldLnggLSAyLCB5ICsgcG9pbnRzW2ldLnkgLSAyLCA1LCA1KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gJ3JnYigwLDI1NSwyNTUpJzsKICAgICAgICAgICAgLy8gdGhpcy5jb250ZXh0LnN0cm9rZVJlY3QoYm9keS5sZWZ0LCBib2R5LnRvcCwgYm9keS53aWR0aCwgYm9keS5oZWlnaHQpOwoKICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclBvbHlnb24KICAgICogQHBhcmFtIHthcnJheX0gcG9seWdvbgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBUaGUgY29sb3IgdGhlIHBvbHlnb24gaXMgc3Ryb2tlZCBpbi4KICAgICovCiAgICByZW5kZXJQb2x5Z29uOiBmdW5jdGlvbiAocG9seWdvbiwgY29sb3IsIGNvbnRleHQpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PT0gbnVsbCAmJiBjb250ZXh0ID09PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwyNTUsMjU1KSc7CgogICAgICAgIHZhciBwb2ludHMgPSBwb2x5Z29uLnBvaW50czsKICAgICAgICB2YXIgeCA9IHBvbHlnb24ucG9zLng7CiAgICAgICAgdmFyIHkgPSBwb2x5Z29uLnBvcy55OwoKICAgICAgICB0aGlzLnN0YXJ0KDAsIDAsIGNvbG9yKTsKCiAgICAgICAgdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgIHRoaXMuY29udGV4dC5tb3ZlVG8oeCArIHBvaW50c1swXS54LCB5ICsgcG9pbnRzWzBdLnkpOwoKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHBvaW50cy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5saW5lVG8oeCArIHBvaW50c1tpXS54LCB5ICsgcG9pbnRzW2ldLnkpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VTdHlsZSA9IGNvbG9yOwogICAgICAgIHRoaXMuY29udGV4dC5zdHJva2UoKTsKCiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfQoKfTsKClBoYXNlci5VdGlscy5EZWJ1Zy5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuVXRpbHMuRGVidWc7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIGNvbGxlY3Rpb24gb2YgbWV0aG9kcyB1c2VmdWwgZm9yIG1hbmlwdWxhdGluZyBhbmQgY29tcGFyaW5nIGNvbG9ycy4KKgoqIEBjbGFzcyBQaGFzZXIuQ29sb3IKKi8KUGhhc2VyLkNvbG9yID0gewoKICAgIC8qKgogICAgKiBHaXZlbiBhbiBhbHBoYSBhbmQgMyBjb2xvciB2YWx1ZXMgdGhpcyB3aWxsIHJldHVybiBhbiBpbnRlZ2VyIHJlcHJlc2VudGF0aW9uIG9mIGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRDb2xvcjMyCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIEFscGhhIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByZWQgLSBUaGUgUmVkIGNoYW5uZWwgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGdyZWVuIC0gVGhlIEdyZWVuIGNoYW5uZWwgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGJsdWUgLSBUaGUgQmx1ZSBjaGFubmVsIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IEEgbmF0aXZlIGNvbG9yIHZhbHVlIGludGVnZXIgKGZvcm1hdDogMHhBQVJSR0dCQikuCiAgICAqLwogICAgZ2V0Q29sb3IzMjogZnVuY3Rpb24gKGFscGhhLCByZWQsIGdyZWVuLCBibHVlKSB7CiAgICAgICAgcmV0dXJuIGFscGhhIDw8IDI0IHwgcmVkIDw8IDE2IHwgZ3JlZW4gPDwgOCB8IGJsdWU7CiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiAzIGNvbG9yIHZhbHVlcyB0aGlzIHdpbGwgcmV0dXJuIGFuIGludGVnZXIgcmVwcmVzZW50YXRpb24gb2YgaXQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldENvbG9yCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IHJlZCAtIFRoZSBSZWQgY2hhbm5lbCB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gZ3JlZW4gLSBUaGUgR3JlZW4gY2hhbm5lbCB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gYmx1ZSAtIFRoZSBCbHVlIGNoYW5uZWwgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KS4KICAgICogQHJldHVybnMge251bWJlcn0gQSBuYXRpdmUgY29sb3IgdmFsdWUgaW50ZWdlciAoZm9ybWF0OiAweFJSR0dCQikuCiAgICAqLwogICAgZ2V0Q29sb3I6IGZ1bmN0aW9uIChyZWQsIGdyZWVuLCBibHVlKSB7CiAgICAgICAgcmV0dXJuIHJlZCA8PCAxNiB8IGdyZWVuIDw8IDggfCBibHVlOwogICAgfSwKCiAgICAvKioKICAgICogQ29udmVydHMgdGhlIGdpdmVuIGhleCBzdHJpbmcgaW50byBhbiBpbnRlZ2VyIGNvbG9yIHZhbHVlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5oZXhUb1JHQgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBoIC0gVGhlIHN0cmluZyBoZXggY29sb3IgdG8gY29udmVydC4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHJnYiBjb2xvciB2YWx1ZS4KICAgICovCiAgICBoZXhUb1JHQjogZnVuY3Rpb24gKGgpIHsKCiAgICAgICAgdmFyIGhleDE2ID0gKGguY2hhckF0KDApID09ICIjIikgPyBoLnN1YnN0cmluZygxLCA3KSA6IGg7CgogICAgICAgIGlmIChoZXgxNi5sZW5ndGg9PTMpCiAgICAgICAgewogICAgICAgICAgICBoZXgxNiA9IGhleDE2LmNoYXJBdCgwKSArIGhleDE2LmNoYXJBdCgwKSArIGhleDE2LmNoYXJBdCgxKSArIGhleDE2LmNoYXJBdCgxKSArIGhleDE2LmNoYXJBdCgyKSArIGhleDE2LmNoYXJBdCgyKTsKICAgICAgICB9CgogICAgICAgIHZhciByZWQgPSBwYXJzZUludChoZXgxNi5zdWJzdHJpbmcoMCwgMiksIDE2KTsKICAgICAgICB2YXIgZ3JlZW4gPSBwYXJzZUludChoZXgxNi5zdWJzdHJpbmcoMiwgNCksIDE2KTsKICAgICAgICB2YXIgYmx1ZSA9IHBhcnNlSW50KGhleDE2LnN1YnN0cmluZyg0LCA2KSwgMTYpOwoKICAgICAgICByZXR1cm4gcmVkIDw8IDE2IHwgZ3JlZW4gPDwgOCB8IGJsdWU7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgc3RyaW5nIGNvbnRhaW5pbmcgaGFuZHkgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGdpdmVuIGNvbG9yIGluY2x1ZGluZyBzdHJpbmcgaGV4IHZhbHVlLAogICAgKiBSR0IgZm9ybWF0IGluZm9ybWF0aW9uIGFuZCBIU0wgaW5mb3JtYXRpb24uIEVhY2ggc2VjdGlvbiBzdGFydHMgb24gYSBuZXdsaW5lLCAzIGxpbmVzIGluIHRvdGFsLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRDb2xvckluZm8KICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBBIGNvbG9yIHZhbHVlIGluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQi4KICAgICogQHJldHVybnMge3N0cmluZ30gU3RyaW5nIGNvbnRhaW5pbmcgdGhlIDMgbGluZXMgb2YgaW5mb3JtYXRpb24uCiAgICAqLwogICAgZ2V0Q29sb3JJbmZvOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdmFyIGFyZ2IgPSBQaGFzZXIuQ29sb3IuZ2V0UkdCKGNvbG9yKTsKICAgICAgICB2YXIgaHNsID0gUGhhc2VyLkNvbG9yLlJHQnRvSFNWKGNvbG9yKTsKICAgICAgICAKICAgICAgICAvLyAgSGV4IGZvcm1hdAogICAgICAgIHZhciByZXN1bHQgPSBQaGFzZXIuQ29sb3IuUkdCdG9IZXhzdHJpbmcoY29sb3IpICsgIlxuIjsKICAgICAgICAKICAgICAgICAvLyAgUkdCIGZvcm1hdAogICAgICAgIHJlc3VsdCA9IHJlc3VsdC5jb25jYXQoIkFscGhhOiAiICsgYXJnYi5hbHBoYSArICIgUmVkOiAiICsgYXJnYi5yZWQgKyAiIEdyZWVuOiAiICsgYXJnYi5ncmVlbiArICIgQmx1ZTogIiArIGFyZ2IuYmx1ZSkgKyAiXG4iOwogICAgICAgIAogICAgICAgIC8vICBIU0wgaW5mbwogICAgICAgIHJlc3VsdCA9IHJlc3VsdC5jb25jYXQoIkh1ZTogIiArIGhzbC5odWUgKyAiIFNhdHVyYXRpb246ICIgKyBoc2wuc2F0dXJhdGlvbiArICIgTGlnaHRuZXM6ICIgKyBoc2wubGlnaHRuZXNzKTsKCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm4gYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGNvbG9yIGluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuUkdCdG9IZXhzdHJpbmcKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBUaGUgY29sb3IgdG8gZ2V0IHRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24gZm9yCiAgICAqIEByZXR1cm5zIHtzdHJpbmd9IEEgc3RyaW5nIG9mIGxlbmd0aCAxMCBjaGFyYWN0ZXJzIGluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQgogICAgKi8KICAgIFJHQnRvSGV4c3RyaW5nOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdmFyIGFyZ2IgPSBQaGFzZXIuQ29sb3IuZ2V0UkdCKGNvbG9yKTsKCiAgICAgICAgcmV0dXJuICIweCIgKyBQaGFzZXIuQ29sb3IuY29sb3JUb0hleHN0cmluZyhhcmdiLmFscGhhKSArIFBoYXNlci5Db2xvci5jb2xvclRvSGV4c3RyaW5nKGFyZ2IucmVkKSArIFBoYXNlci5Db2xvci5jb2xvclRvSGV4c3RyaW5nKGFyZ2IuZ3JlZW4pICsgUGhhc2VyLkNvbG9yLmNvbG9yVG9IZXhzdHJpbmcoYXJnYi5ibHVlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm4gYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGNvbG9yIGluIHRoZSBmb3JtYXQgI1JSR0dCQi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuUkdCdG9XZWJzdHJpbmcKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBUaGUgY29sb3IgdG8gZ2V0IHRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24gZm9yLgogICAgKiBAcmV0dXJucyB7c3RyaW5nfSBBIHN0cmluZyBvZiBsZW5ndGggMTAgY2hhcmFjdGVycyBpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqLwogICAgUkdCdG9XZWJzdHJpbmc6IGZ1bmN0aW9uIChjb2xvcikgewoKICAgICAgICB2YXIgYXJnYiA9IFBoYXNlci5Db2xvci5nZXRSR0IoY29sb3IpOwoKICAgICAgICByZXR1cm4gIiMiICsgUGhhc2VyLkNvbG9yLmNvbG9yVG9IZXhzdHJpbmcoYXJnYi5yZWQpICsgUGhhc2VyLkNvbG9yLmNvbG9yVG9IZXhzdHJpbmcoYXJnYi5ncmVlbikgKyBQaGFzZXIuQ29sb3IuY29sb3JUb0hleHN0cmluZyhhcmdiLmJsdWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybiBhIHN0cmluZyBjb250YWluaW5nIGEgaGV4IHJlcHJlc2VudGF0aW9uIG9mIHRoZSBnaXZlbiBjb2xvci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuY29sb3JUb0hleHN0cmluZwogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciAtIFRoZSBjb2xvciBjaGFubmVsIHRvIGdldCB0aGUgaGV4IHZhbHVlIGZvciwgbXVzdCBiZSBhIHZhbHVlIGJldHdlZW4gMCBhbmQgMjU1KS4KICAgICogQHJldHVybnMge3N0cmluZ30gQSBzdHJpbmcgb2YgbGVuZ3RoIDIgY2hhcmFjdGVycywgaS5lLiAyNTUgPSBGRiwgMCA9IDAwLgogICAgKi8KICAgIGNvbG9yVG9IZXhzdHJpbmc6IGZ1bmN0aW9uIChjb2xvcikgewoKICAgICAgICB2YXIgZGlnaXRzID0gIjAxMjM0NTY3ODlBQkNERUYiOwogICAgICAgIHZhciBsc2QgPSBjb2xvciAlIDE2OwogICAgICAgIHZhciBtc2QgPSAoY29sb3IgLSBsc2QpIC8gMTY7CiAgICAgICAgdmFyIGhleGlmaWVkID0gZGlnaXRzLmNoYXJBdChtc2QpICsgZGlnaXRzLmNoYXJBdChsc2QpOwogICAgICAgIHJldHVybiBoZXhpZmllZDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcnBvbGF0ZXMgdGhlIHR3byBnaXZlbiBjb2xvdXJzIGJhc2VkIG9uIHRoZSBzdXBwbGllZCBzdGVwIGFuZCBjdXJyZW50U3RlcCBwcm9wZXJ0aWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5pbnRlcnBvbGF0ZUNvbG9yCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yMSAtIFRoZSBmaXJzdCBjb2xvciB2YWx1ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yMiAtIFRoZSBzZWNvbmQgY29sb3IgdmFsdWUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGVwcyAtIFRoZSBudW1iZXIgb2Ygc3RlcHMgdG8gcnVuIHRoZSBpbnRlcnBvbGF0aW9uIG92ZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjdXJyZW50U3RlcCAtIFRoZSBjdXJyZW50U3RlcCB2YWx1ZS4gSWYgdGhlIGludGVycG9sYXRpb24gd2lsbCB0YWtlIDEwMCBzdGVwcywgYSBjdXJyZW50U3RlcCB2YWx1ZSBvZiA1MCB3b3VsZCBiZSBoYWxmLXdheSBiZXR3ZWVuIHRoZSB0d28uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBhbHBoYSBvZiB0aGUgcmV0dXJuZWQgY29sb3IuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBpbnRlcnBvbGF0ZWQgY29sb3IgdmFsdWUuCiAgICAqLwogICAgaW50ZXJwb2xhdGVDb2xvcjogZnVuY3Rpb24gKGNvbG9yMSwgY29sb3IyLCBzdGVwcywgY3VycmVudFN0ZXAsIGFscGhhKSB7CgogICAgICAgIGlmICh0eXBlb2YgYWxwaGEgPT09ICJ1bmRlZmluZWQiKSB7IGFscGhhID0gMjU1OyB9CgogICAgICAgIHZhciBzcmMxID0gUGhhc2VyLkNvbG9yLmdldFJHQihjb2xvcjEpOwogICAgICAgIHZhciBzcmMyID0gUGhhc2VyLkNvbG9yLmdldFJHQihjb2xvcjIpOwogICAgICAgIHZhciByID0gKCgoc3JjMi5yZWQgLSBzcmMxLnJlZCkgKiBjdXJyZW50U3RlcCkgLyBzdGVwcykgKyBzcmMxLnJlZDsKICAgICAgICB2YXIgZyA9ICgoKHNyYzIuZ3JlZW4gLSBzcmMxLmdyZWVuKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIHNyYzEuZ3JlZW47CiAgICAgICAgdmFyIGIgPSAoKChzcmMyLmJsdWUgLSBzcmMxLmJsdWUpICogY3VycmVudFN0ZXApIC8gc3RlcHMpICsgc3JjMS5ibHVlOwoKICAgICAgICByZXR1cm4gUGhhc2VyLkNvbG9yLmdldENvbG9yMzIoYWxwaGEsIHIsIGcsIGIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVycG9sYXRlcyB0aGUgdHdvIGdpdmVuIGNvbG91cnMgYmFzZWQgb24gdGhlIHN1cHBsaWVkIHN0ZXAgYW5kIGN1cnJlbnRTdGVwIHByb3BlcnRpZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmludGVycG9sYXRlQ29sb3JXaXRoUkdCCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gVGhlIGZpcnN0IGNvbG9yIHZhbHVlLgogICAgKiBAcGFyYW0ge251bWJlcn0gciAtIFRoZSByZWQgY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGcgLSBUaGUgZ3JlZW4gY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGIgLSBUaGUgYmx1ZSBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gc3RlcHMgLSBUaGUgbnVtYmVyIG9mIHN0ZXBzIHRvIHJ1biB0aGUgaW50ZXJwb2xhdGlvbiBvdmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gY3VycmVudFN0ZXAgLSBUaGUgY3VycmVudFN0ZXAgdmFsdWUuIElmIHRoZSBpbnRlcnBvbGF0aW9uIHdpbGwgdGFrZSAxMDAgc3RlcHMsIGEgY3VycmVudFN0ZXAgdmFsdWUgb2YgNTAgd291bGQgYmUgaGFsZi13YXkgYmV0d2VlbiB0aGUgdHdvLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgaW50ZXJwb2xhdGVkIGNvbG9yIHZhbHVlLgogICAgKi8KICAgIGludGVycG9sYXRlQ29sb3JXaXRoUkdCOiBmdW5jdGlvbiAoY29sb3IsIHIsIGcsIGIsIHN0ZXBzLCBjdXJyZW50U3RlcCkgewoKICAgICAgICB2YXIgc3JjID0gUGhhc2VyLkNvbG9yLmdldFJHQihjb2xvcik7CiAgICAgICAgdmFyIG9yID0gKCgociAtIHNyYy5yZWQpICogY3VycmVudFN0ZXApIC8gc3RlcHMpICsgc3JjLnJlZDsKICAgICAgICB2YXIgb2cgPSAoKChnIC0gc3JjLmdyZWVuKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIHNyYy5ncmVlbjsKICAgICAgICB2YXIgb2IgPSAoKChiIC0gc3JjLmJsdWUpICogY3VycmVudFN0ZXApIC8gc3RlcHMpICsgc3JjLmJsdWU7CgogICAgICAgIHJldHVybiBQaGFzZXIuQ29sb3IuZ2V0Q29sb3Iob3IsIG9nLCBvYik7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJwb2xhdGVzIHRoZSB0d28gZ2l2ZW4gY29sb3VycyBiYXNlZCBvbiB0aGUgc3VwcGxpZWQgc3RlcCBhbmQgY3VycmVudFN0ZXAgcHJvcGVydGllcy4KICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuaW50ZXJwb2xhdGVSR0IKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gcjEgLSBUaGUgcmVkIGNvbG9yIHZhbHVlLCBiZXR3ZWVuIDAgYW5kIDB4RkYgKDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBnMSAtIFRoZSBncmVlbiBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gYjEgLSBUaGUgYmx1ZSBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gcjIgLSBUaGUgcmVkIGNvbG9yIHZhbHVlLCBiZXR3ZWVuIDAgYW5kIDB4RkYgKDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBnMiAtIFRoZSBncmVlbiBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gYjIgLSBUaGUgYmx1ZSBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gc3RlcHMgLSBUaGUgbnVtYmVyIG9mIHN0ZXBzIHRvIHJ1biB0aGUgaW50ZXJwb2xhdGlvbiBvdmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gY3VycmVudFN0ZXAgLSBUaGUgY3VycmVudFN0ZXAgdmFsdWUuIElmIHRoZSBpbnRlcnBvbGF0aW9uIHdpbGwgdGFrZSAxMDAgc3RlcHMsIGEgY3VycmVudFN0ZXAgdmFsdWUgb2YgNTAgd291bGQgYmUgaGFsZi13YXkgYmV0d2VlbiB0aGUgdHdvLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgaW50ZXJwb2xhdGVkIGNvbG9yIHZhbHVlLgogICAgKi8KICAgIGludGVycG9sYXRlUkdCOiBmdW5jdGlvbiAocjEsIGcxLCBiMSwgcjIsIGcyLCBiMiwgc3RlcHMsIGN1cnJlbnRTdGVwKSB7CgogICAgICAgIHZhciByID0gKCgocjIgLSByMSkgKiBjdXJyZW50U3RlcCkgLyBzdGVwcykgKyByMTsKICAgICAgICB2YXIgZyA9ICgoKGcyIC0gZzEpICogY3VycmVudFN0ZXApIC8gc3RlcHMpICsgZzE7CiAgICAgICAgdmFyIGIgPSAoKChiMiAtIGIxKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIGIxOwoKICAgICAgICByZXR1cm4gUGhhc2VyLkNvbG9yLmdldENvbG9yKHIsIGcsIGIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSByYW5kb20gY29sb3IgdmFsdWUgYmV0d2VlbiBibGFjayBhbmQgd2hpdGUKICAgICogU2V0IHRoZSBtaW4gdmFsdWUgdG8gc3RhcnQgZWFjaCBjaGFubmVsIGZyb20gdGhlIGdpdmVuIG9mZnNldC4KICAgICogU2V0IHRoZSBtYXggdmFsdWUgdG8gcmVzdHJpY3QgdGhlIG1heGltdW0gY29sb3IgdXNlZCBwZXIgY2hhbm5lbC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0UmFuZG9tQ29sb3IKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIGxvd2VzdCB2YWx1ZSB0byB1c2UgZm9yIHRoZSBjb2xvci4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBoaWdoZXN0IHZhbHVlIHRvIHVzZSBmb3IgdGhlIGNvbG9yLgogICAgKiBAcGFyYW0ge251bWJlcn0gYWxwaGEgLSBUaGUgYWxwaGEgdmFsdWUgb2YgdGhlIHJldHVybmluZyBjb2xvciAoZGVmYXVsdCAyNTUgPSBmdWxseSBvcGFxdWUpLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSAzMi1iaXQgY29sb3IgdmFsdWUgd2l0aCBhbHBoYS4KICAgICovCiAgICBnZXRSYW5kb21Db2xvcjogZnVuY3Rpb24gKG1pbiwgbWF4LCBhbHBoYSkgewoKICAgICAgICBpZiAodHlwZW9mIG1pbiA9PT0gInVuZGVmaW5lZCIpIHsgbWluID0gMDsgfQogICAgICAgIGlmICh0eXBlb2YgbWF4ID09PSAidW5kZWZpbmVkIikgeyBtYXggPSAyNTU7IH0KICAgICAgICBpZiAodHlwZW9mIGFscGhhID09PSAidW5kZWZpbmVkIikgeyBhbHBoYSA9IDI1NTsgfQoKICAgICAgICAvLyAgU2FuaXR5IGNoZWNrcwogICAgICAgIGlmIChtYXggPiAyNTUpIHsKICAgICAgICAgICAgcmV0dXJuIFBoYXNlci5Db2xvci5nZXRDb2xvcigyNTUsIDI1NSwgMjU1KTsKICAgICAgICB9CgogICAgICAgIGlmIChtaW4gPiBtYXgpIHsKICAgICAgICAgICAgcmV0dXJuIFBoYXNlci5Db2xvci5nZXRDb2xvcigyNTUsIDI1NSwgMjU1KTsKICAgICAgICB9CgogICAgICAgIHZhciByZWQgPSBtaW4gKyBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluKSk7CiAgICAgICAgdmFyIGdyZWVuID0gbWluICsgTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbikpOwogICAgICAgIHZhciBibHVlID0gbWluICsgTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbikpOwoKICAgICAgICByZXR1cm4gUGhhc2VyLkNvbG9yLmdldENvbG9yMzIoYWxwaGEsIHJlZCwgZ3JlZW4sIGJsdWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybiB0aGUgY29tcG9uZW50IHBhcnRzIG9mIGEgY29sb3IgYXMgYW4gT2JqZWN0IHdpdGggdGhlIHByb3BlcnRpZXMgYWxwaGEsIHJlZCwgZ3JlZW4sIGJsdWUKICAgICoKICAgICogQWxwaGEgd2lsbCBvbmx5IGJlIHNldCBpZiBpdCBleGlzdCBpbiB0aGUgZ2l2ZW4gY29sb3IgKDB4QUFSUkdHQkIpCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldFJHQgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciAtIENvbG9yIGluIFJHQiAoMHhSUkdHQkIpIG9yIEFSR0IgZm9ybWF0ICgweEFBUlJHR0JCKS4KICAgICogQHJldHVybnMge29iamVjdH0gQW4gT2JqZWN0IHdpdGggcHJvcGVydGllczogYWxwaGEsIHJlZCwgZ3JlZW4sIGJsdWUuCiAgICAqLwogICAgZ2V0UkdCOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgYWxwaGE6IGNvbG9yID4+PiAyNCwKICAgICAgICAgICAgcmVkOiBjb2xvciA+PiAxNiAmIDB4RkYsCiAgICAgICAgICAgIGdyZWVuOiBjb2xvciA+PiA4ICYgMHhGRiwKICAgICAgICAgICAgYmx1ZTogY29sb3IgJiAweEZGCiAgICAgICAgfTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgQ1NTIGZyaWVuZGx5IHN0cmluZyB2YWx1ZSBmcm9tIHRoZSBnaXZlbiBjb2xvci4KICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0V2ViUkdCCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yCiAgICAqIEByZXR1cm5zIHtzdHJpbmd9QSBzdHJpbmcgaW4gdGhlIGZvcm1hdDogJ3JnYmEocixnLGIsYSknCiAgICAqLwogICAgZ2V0V2ViUkdCOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdmFyIGFscGhhID0gKGNvbG9yID4+PiAyNCkgLyAyNTU7CiAgICAgICAgdmFyIHJlZCA9IGNvbG9yID4+IDE2ICYgMHhGRjsKICAgICAgICB2YXIgZ3JlZW4gPSBjb2xvciA+PiA4ICYgMHhGRjsKICAgICAgICB2YXIgYmx1ZSA9IGNvbG9yICYgMHhGRjsKCiAgICAgICAgcmV0dXJuICdyZ2JhKCcgKyByZWQudG9TdHJpbmcoKSArICcsJyArIGdyZWVuLnRvU3RyaW5nKCkgKyAnLCcgKyBibHVlLnRvU3RyaW5nKCkgKyAnLCcgKyBhbHBoYS50b1N0cmluZygpICsgJyknOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogR2l2ZW4gYSBuYXRpdmUgY29sb3IgdmFsdWUgKGluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQikgdGhpcyB3aWxsIHJldHVybiB0aGUgQWxwaGEgY29tcG9uZW50LCBhcyBhIHZhbHVlIGJldHdlZW4gMCBhbmQgMjU1LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRBbHBoYQogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciAtIEluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQi4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIEFscGhhIGNvbXBvbmVudCBvZiB0aGUgY29sb3IsIHdpbGwgYmUgYmV0d2VlbiAwIGFuZCAxICgwIGJlaW5nIG5vIEFscGhhIChvcGFxdWUpLCAxIGZ1bGwgQWxwaGEgKHRyYW5zcGFyZW50KSkuCiAgICAqLwogICAgZ2V0QWxwaGE6IGZ1bmN0aW9uIChjb2xvcikgewogICAgICAgIHJldHVybiBjb2xvciA+Pj4gMjQ7CiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiBhIG5hdGl2ZSBjb2xvciB2YWx1ZSAoaW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCKSB0aGlzIHdpbGwgcmV0dXJuIHRoZSBBbHBoYSBjb21wb25lbnQgYXMgYSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDEuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldEFscGhhRmxvYXQKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBJbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBBbHBoYSBjb21wb25lbnQgb2YgdGhlIGNvbG9yLCB3aWxsIGJlIGJldHdlZW4gMCBhbmQgMSAoMCBiZWluZyBubyBBbHBoYSAob3BhcXVlKSwgMSBmdWxsIEFscGhhICh0cmFuc3BhcmVudCkpLgogICAgKi8KICAgIGdldEFscGhhRmxvYXQ6IGZ1bmN0aW9uIChjb2xvcikgewogICAgICAgIHJldHVybiAoY29sb3IgPj4+IDI0KSAvIDI1NTsKICAgIH0sCgogICAgLyoqCiAgICAqIEdpdmVuIGEgbmF0aXZlIGNvbG9yIHZhbHVlIChpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIpIHRoaXMgd2lsbCByZXR1cm4gdGhlIFJlZCBjb21wb25lbnQsIGFzIGEgdmFsdWUgYmV0d2VlbiAwIGFuZCAyNTUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldFJlZAogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciBJbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBSZWQgY29tcG9uZW50IG9mIHRoZSBjb2xvciwgd2lsbCBiZSBiZXR3ZWVuIDAgYW5kIDI1NSAoMCBiZWluZyBubyBjb2xvciwgMjU1IGZ1bGwgUmVkKS4KICAgICovCiAgICBnZXRSZWQ6IGZ1bmN0aW9uIChjb2xvcikgewogICAgICAgIHJldHVybiBjb2xvciA+PiAxNiAmIDB4RkY7CiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiBhIG5hdGl2ZSBjb2xvciB2YWx1ZSAoaW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCKSB0aGlzIHdpbGwgcmV0dXJuIHRoZSBHcmVlbiBjb21wb25lbnQsIGFzIGEgdmFsdWUgYmV0d2VlbiAwIGFuZCAyNTUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldEdyZWVuCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gSW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgR3JlZW4gY29tcG9uZW50IG9mIHRoZSBjb2xvciwgd2lsbCBiZSBiZXR3ZWVuIDAgYW5kIDI1NSAoMCBiZWluZyBubyBjb2xvciwgMjU1IGZ1bGwgR3JlZW4pLgogICAgKi8KICAgIGdldEdyZWVuOiBmdW5jdGlvbiAoY29sb3IpIHsKICAgICAgICByZXR1cm4gY29sb3IgPj4gOCAmIDB4RkY7CiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiBhIG5hdGl2ZSBjb2xvciB2YWx1ZSAoaW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCKSB0aGlzIHdpbGwgcmV0dXJuIHRoZSBCbHVlIGNvbXBvbmVudCwgYXMgYSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDI1NS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0Qmx1ZQogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciAtIEluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQi4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIEJsdWUgY29tcG9uZW50IG9mIHRoZSBjb2xvciwgd2lsbCBiZSBiZXR3ZWVuIDAgYW5kIDI1NSAoMCBiZWluZyBubyBjb2xvciwgMjU1IGZ1bGwgQmx1ZSkuCiAgICAqLwogICAgZ2V0Qmx1ZTogZnVuY3Rpb24gKGNvbG9yKSB7CiAgICAgICAgcmV0dXJuIGNvbG9yICYgMHhGRjsKICAgIH0KICAgIAp9OwoKLy8gVmVyc2lvbiAwLjIgLSBDb3B5cmlnaHQgMjAxMyAtICBKaW0gUmllY2tlbiA8amltckBqaW1yLmNhPgovLwovLyBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UgLSBodHRwczovL2dpdGh1Yi5jb20vanJpZWNrZW4vc2F0LWpzCi8vCi8vIEEgc2ltcGxlIGxpYnJhcnkgZm9yIGRldGVybWluaW5nIGludGVyc2VjdGlvbnMgb2YgY2lyY2xlcyBhbmQKLy8gcG9seWdvbnMgdXNpbmcgdGhlIFNlcGFyYXRpbmcgQXhpcyBUaGVvcmVtLgovKiogQHByZXNlcnZlIFNBVC5qcyAtIFZlcnNpb24gMC4yIC0gQ29weXJpZ2h0IDIwMTMgLSBKaW0gUmllY2tlbiA8amltckBqaW1yLmNhPiAtIHJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4gaHR0cHM6Ly9naXRodWIuY29tL2pyaWVja2VuL3NhdC1qcyAqLwoKdmFyIFNBVCA9IChmdW5jdGlvbiAoKSB7CiAgInVzZSBzdHJpY3QiOwoKICB2YXIgU0FUID0ge307CgogIC8vCiAgLy8gIyMgVmVjdG9yCiAgLy8KICAvLyBSZXByZXNlbnRzIGEgdmVjdG9yIGluIHR3byBkaW1lbnNpb25zIHdpdGggYHhgIGFuZCBgeWAgcHJvcGVydGllcy4KCgogIC8vIENyZWF0ZSBhIG5ldyBWZWN0b3IsIG9wdGlvbmFsbHkgcGFzc2luZyBpbiB0aGUgYHhgIGFuZCBgeWAgY29vcmRpbmF0ZXMuIElmCiAgLy8gYSBjb29yZGluYXRlIGlzIG5vdCBzcGVjaWZpZWQsIGl0IHdpbGwgYmUgc2V0IHRvIGAwYAogIC8qKgogICAqIEBwYXJhbSB7P251bWJlcj19IHggVGhlIHggcG9zaXRpb24uCiAgICogQHBhcmFtIHs/bnVtYmVyPX0geSBUaGUgeSBwb3NpdGlvbi4KICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBWZWN0b3IoeCwgeSkgewogICAgdGhpc1sneCddID0geCB8fCAwOwogICAgdGhpc1sneSddID0geSB8fCAwOwogIH0KICBTQVRbJ1ZlY3RvciddID0gVmVjdG9yOwogIC8vIEFsaWFzIGBWZWN0b3JgIGFzIGBWYAogIFNBVFsnViddID0gVmVjdG9yOwoKCiAgLy8gQ29weSB0aGUgdmFsdWVzIG9mIGFub3RoZXIgVmVjdG9yIGludG8gdGhpcyBvbmUuCiAgLyoqCiAgICogQHBhcmFtIHtWZWN0b3J9IG90aGVyIFRoZSBvdGhlciBWZWN0b3IuCiAgICogQHJldHVybiB7VmVjdG9yfSBUaGlzIGZvciBjaGFpbmluZy4KICAgKi8KICBWZWN0b3IucHJvdG90eXBlWydjb3B5J10gPSBWZWN0b3IucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbihvdGhlcikgewogICAgdGhpc1sneCddID0gb3RoZXJbJ3gnXTsKICAgIHRoaXNbJ3knXSA9IG90aGVyWyd5J107CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBDaGFuZ2UgdGhpcyB2ZWN0b3IgdG8gYmUgcGVycGVuZGljdWxhciB0byB3aGF0IGl0IHdhcyBiZWZvcmUuIChFZmZlY3RpdmVseQogIC8vIHJvYXRhdGVzIGl0IDkwIGRlZ3JlZXMgaW4gYSBjbG9ja3dpc2UgZGlyZWN0aW9uKQogIC8qKgogICAqIEByZXR1cm4ge1ZlY3Rvcn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsncGVycCddID0gVmVjdG9yLnByb3RvdHlwZS5wZXJwID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgeCA9IHRoaXNbJ3gnXTsKICAgIHRoaXNbJ3gnXSA9IHRoaXNbJ3knXTsKICAgIHRoaXNbJ3knXSA9IC14OwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gUm90YXRlIHRoaXMgdmVjdG9yIChjb3VudGVyLWNsb2Nrd2lzZSkgYnkgdGhlIHNwZWNpZmllZCBhbmdsZSAoaW4gcmFkaWFucykuCiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIFRoZSBhbmdsZSB0byByb3RhdGUgKGluIHJhZGlhbnMpCiAgICogQHJldHVybiB7VmVjdG9yfSBUaGlzIGZvciBjaGFpbmluZy4KICAgKi8KICBWZWN0b3IucHJvdG90eXBlWydyb3RhdGUnXSA9IFZlY3Rvci5wcm90b3R5cGUucm90YXRlID0gZnVuY3Rpb24gKGFuZ2xlKSB7CiAgICB2YXIgeCA9IHRoaXNbJ3gnXTsKICAgIHZhciB5ID0gdGhpc1sneSddOwogICAgdGhpc1sneCddID0geCAqIE1hdGguY29zKGFuZ2xlKSAtIHkgKiBNYXRoLnNpbihhbmdsZSk7CiAgICB0aGlzWyd5J10gPSB4ICogTWF0aC5zaW4oYW5nbGUpICsgeSAqIE1hdGguY29zKGFuZ2xlKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFJvdGF0ZSB0aGlzIHZlY3RvciAoY291bnRlci1jbG9ja3dpc2UpIGJ5IHRoZSBzcGVjaWZpZWQgYW5nbGUgKGluIHJhZGlhbnMpIHdoaWNoIGhhcyBhbHJlYWR5IGJlZW4gY2FsY3VsYXRlZCBpbnRvIHNpbiBhbmQgY29zLgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzaW4gLSBUaGUgTWF0aC5zaW4oYW5nbGUpCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvcyAtIFRoZSBNYXRoLmNvcyhhbmdsZSkKICAgKiBAcmV0dXJuIHtWZWN0b3J9IFRoaXMgZm9yIGNoYWluaW5nLgogICAqLwogIFZlY3Rvci5wcm90b3R5cGVbJ3JvdGF0ZVByZWNhbGMnXSA9IFZlY3Rvci5wcm90b3R5cGUucm90YXRlUHJlY2FsYyA9IGZ1bmN0aW9uIChzaW4sIGNvcykgewogICAgdmFyIHggPSB0aGlzWyd4J107CiAgICB2YXIgeSA9IHRoaXNbJ3knXTsKICAgIHRoaXNbJ3gnXSA9IHggKiBjb3MgLSB5ICogc2luOwogICAgdGhpc1sneSddID0geCAqIHNpbiArIHkgKiBjb3M7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBSZXZlcnNlIHRoaXMgdmVjdG9yLgogIC8qKgogICAqIEByZXR1cm4ge1ZlY3Rvcn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsncmV2ZXJzZSddID0gVmVjdG9yLnByb3RvdHlwZS5yZXZlcnNlID0gZnVuY3Rpb24oKSB7CiAgICB0aGlzWyd4J10gPSAtdGhpc1sneCddOwogICAgdGhpc1sneSddID0gLXRoaXNbJ3knXTsKICAgIHJldHVybiB0aGlzOwogIH07CgoKICAvLyBOb3JtYWxpemUgdGhpcyB2ZWN0b3IuICAobWFrZSBpdCBoYXZlIGxlbmd0aCBvZiBgMWApCiAgLyoqCiAgICogQHJldHVybiB7VmVjdG9yfSBUaGlzIGZvciBjaGFpbmluZy4KICAgKi8KICBWZWN0b3IucHJvdG90eXBlWydub3JtYWxpemUnXSA9IFZlY3Rvci5wcm90b3R5cGUubm9ybWFsaXplID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgZCA9IHRoaXMubGVuKCk7CiAgICBpZihkID4gMCkgewogICAgICB0aGlzWyd4J10gPSB0aGlzWyd4J10gLyBkOwogICAgICB0aGlzWyd5J10gPSB0aGlzWyd5J10gLyBkOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gQWRkIGFub3RoZXIgdmVjdG9yIHRvIHRoaXMgb25lLgogIC8qKgogICAqIEBwYXJhbSB7VmVjdG9yfSBvdGhlciBUaGUgb3RoZXIgVmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3Rvcn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsnYWRkJ10gPSBWZWN0b3IucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICB0aGlzWyd4J10gKz0gb3RoZXJbJ3gnXTsKICAgIHRoaXNbJ3knXSArPSBvdGhlclsneSddOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gU3VidHJhY3QgYW5vdGhlciB2ZWN0b3IgZnJvbSB0aGlzIG9uZS4KICAvKioKICAgKiBAcGFyYW0ge1ZlY3Rvcn0gb3RoZXIgVGhlIG90aGVyIFZlY3Rvci4KICAgKiBAcmV0dXJuIHtWZWN0b3J9IFRoaXMgZm9yIGNoYWlpbmcuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsnc3ViJ10gPSBWZWN0b3IucHJvdG90eXBlLnN1YiA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICB0aGlzWyd4J10gLT0gb3RoZXJbJ3gnXTsKICAgIHRoaXNbJ3knXSAtPSBvdGhlclsneSddOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gU2NhbGUgdGhpcyB2ZWN0b3IuIEFuIGluZGVwZW5kYW50IHNjYWxpbmcgZmFjdG9yIGNhbiBiZSBwcm92aWRlZAogIC8vIGZvciBlYWNoIGF4aXMsIG9yIGEgc2luZ2xlIHNjYWxpbmcgZmFjdG9yIHRoYXQgd2lsbCBzY2FsZSBib3RoIGB4YCBhbmQgYHlgLgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSB4IFRoZSBzY2FsaW5nIGZhY3RvciBpbiB0aGUgeCBkaXJlY3Rpb24uCiAgICogQHBhcmFtIHs/bnVtYmVyPX0geSBUaGUgc2NhbGluZyBmYWN0b3IgaW4gdGhlIHkgZGlyZWN0aW9uLiAgSWYgdGhpcwogICAqICAgaXMgbm90IHNwZWNpZmllZCwgdGhlIHggc2NhbGluZyBmYWN0b3Igd2lsbCBiZSB1c2VkLgogICAqIEByZXR1cm4ge1ZlY3Rvcn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsnc2NhbGUnXSA9IFZlY3Rvci5wcm90b3R5cGUuc2NhbGUgPSBmdW5jdGlvbih4LHkpIHsKICAgIHRoaXNbJ3gnXSAqPSB4OwogICAgdGhpc1sneSddICo9IHkgfHwgeDsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFByb2plY3QgdGhpcyB2ZWN0b3Igb24gdG8gYW5vdGhlciB2ZWN0b3IuCiAgLyoqCiAgICogQHBhcmFtIHtWZWN0b3J9IG90aGVyIFRoZSB2ZWN0b3IgdG8gcHJvamVjdCBvbnRvLgogICAqIEByZXR1cm4ge1ZlY3Rvcn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsncHJvamVjdCddID0gVmVjdG9yLnByb3RvdHlwZS5wcm9qZWN0ID0gZnVuY3Rpb24ob3RoZXIpIHsKICAgIHZhciBhbXQgPSB0aGlzLmRvdChvdGhlcikgLyBvdGhlci5sZW4yKCk7CiAgICB0aGlzWyd4J10gPSBhbXQgKiBvdGhlclsneCddOwogICAgdGhpc1sneSddID0gYW10ICogb3RoZXJbJ3knXTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFByb2plY3QgdGhpcyB2ZWN0b3Igb250byBhIHZlY3RvciBvZiB1bml0IGxlbmd0aC4gVGhpcyBpcyBzbGlnaHRseSBtb3JlIGVmZmljaWVudAogIC8vIHRoYW4gYHByb2plY3RgIHdoZW4gZGVhbGluZyB3aXRoIHVuaXQgdmVjdG9ycy4KICAvKioKICAgKiBAcGFyYW0ge1ZlY3Rvcn0gb3RoZXIgVGhlIHVuaXQgdmVjdG9yIHRvIHByb2plY3Qgb250by4KICAgKiBAcmV0dXJuIHtWZWN0b3J9IFRoaXMgZm9yIGNoYWluaW5nLgogICAqLwogIFZlY3Rvci5wcm90b3R5cGVbJ3Byb2plY3ROJ10gPSBWZWN0b3IucHJvdG90eXBlLnByb2plY3ROID0gZnVuY3Rpb24ob3RoZXIpIHsKICAgIHZhciBhbXQgPSB0aGlzLmRvdChvdGhlcik7CiAgICB0aGlzWyd4J10gPSBhbXQgKiBvdGhlclsneCddOwogICAgdGhpc1sneSddID0gYW10ICogb3RoZXJbJ3knXTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFJlZmxlY3QgdGhpcyB2ZWN0b3Igb24gYW4gYXJiaXRyYXJ5IGF4aXMuCiAgLyoqCiAgICogQHBhcmFtIHtWZWN0b3J9IGF4aXMgVGhlIHZlY3RvciByZXByZXNlbnRpbmcgdGhlIGF4aXMuCiAgICogQHJldHVybiB7VmVjdG9yfSBUaGlzIGZvciBjaGFpbmluZy4KICAgKi8KICBWZWN0b3IucHJvdG90eXBlWydyZWZsZWN0J10gPSBWZWN0b3IucHJvdG90eXBlLnJlZmxlY3QgPSBmdW5jdGlvbihheGlzKSB7CiAgICB2YXIgeCA9IHRoaXNbJ3gnXTsKICAgIHZhciB5ID0gdGhpc1sneSddOwogICAgdGhpcy5wcm9qZWN0KGF4aXMpLnNjYWxlKDIpOwogICAgdGhpc1sneCddIC09IHg7CiAgICB0aGlzWyd5J10gLT0geTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFJlZmxlY3QgdGhpcyB2ZWN0b3Igb24gYW4gYXJiaXRyYXJ5IGF4aXMgKHJlcHJlc2VudGVkIGJ5IGEgdW5pdCB2ZWN0b3IpLiBUaGlzIGlzCiAgLy8gc2xpZ2h0bHkgbW9yZSBlZmZpY2llbnQgdGhhbiBgcmVmbGVjdGAgd2hlbiBkZWFsaW5nIHdpdGggYW4gYXhpcyB0aGF0IGlzIGEgdW5pdCB2ZWN0b3IuCiAgLyoqCiAgICogQHBhcmFtIHtWZWN0b3J9IGF4aXMgVGhlIHVuaXQgdmVjdG9yIHJlcHJlc2VudGluZyB0aGUgYXhpcy4KICAgKiBAcmV0dXJuIHtWZWN0b3J9IFRoaXMgZm9yIGNoYWluaW5nLgogICAqLwogIFZlY3Rvci5wcm90b3R5cGVbJ3JlZmxlY3ROJ10gPSBWZWN0b3IucHJvdG90eXBlLnJlZmxlY3ROID0gZnVuY3Rpb24oYXhpcykgewogICAgdmFyIHggPSB0aGlzWyd4J107CiAgICB2YXIgeSA9IHRoaXNbJ3knXTsKICAgIHRoaXMucHJvamVjdE4oYXhpcykuc2NhbGUoMik7CiAgICB0aGlzWyd4J10gLT0geDsKICAgIHRoaXNbJ3knXSAtPSB5OwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gR2V0IHRoZSBkb3QgcHJvZHVjdCBvZiB0aGlzIHZlY3RvciBhbmQgYW5vdGhlci4KICAvKioKICAgKiBAcGFyYW0ge1ZlY3Rvcn0gIG90aGVyIFRoZSB2ZWN0b3IgdG8gZG90IHRoaXMgb25lIGFnYWluc3QuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZG90IHByb2R1Y3QuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsnZG90J10gPSBWZWN0b3IucHJvdG90eXBlLmRvdCA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICByZXR1cm4gdGhpc1sneCddICogb3RoZXJbJ3gnXSArIHRoaXNbJ3knXSAqIG90aGVyWyd5J107CiAgfTsKCiAgLy8gR2V0IHRoZSBzcXVhcmVkIGxlbmd0aCBvZiB0aGlzIHZlY3Rvci4KICAvKioKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsZW5ndGheMiBvZiB0aGlzIHZlY3Rvci4KICAgKi8KICBWZWN0b3IucHJvdG90eXBlWydsZW4yJ10gPSBWZWN0b3IucHJvdG90eXBlLmxlbjIgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmRvdCh0aGlzKTsKICB9OwoKICAvLyBHZXQgdGhlIGxlbmd0aCBvZiB0aGlzIHZlY3Rvci4KICAvKioKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICovCiAgVmVjdG9yLnByb3RvdHlwZVsnbGVuJ10gPSBWZWN0b3IucHJvdG90eXBlLmxlbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLmxlbjIoKSk7CiAgfTsKCiAgLy8gIyMgQ2lyY2xlCiAgLy8KICAvLyBSZXByZXNlbnRzIGEgY2lyY2xlIHdpdGggYSBwb3NpdGlvbiBhbmQgYSByYWRpdXMuCgogIC8vIENyZWF0ZSBhIG5ldyBjaXJjbGUsIG9wdGlvbmFsbHkgcGFzc2luZyBpbiBhIHBvc2l0aW9uIGFuZC9vciByYWRpdXMuIElmIG5vIHBvc2l0aW9uCiAgLy8gaXMgZ2l2ZW4sIHRoZSBjaXJjbGUgd2lsbCBiZSBhdCBgKDAsMClgLiBJZiBubyByYWRpdXMgaXMgcHJvdmlkZWQsIHRoZSBjaXJjbGUgd2lsbAogIC8vIGhhdmUgYSByYWRpdXMgb2YgYDBgLgogIC8qKgogICAqIEBwYXJhbSB7VmVjdG9yPX0gcG9zIEEgdmVjdG9yIHJlcHJlc2VudGluZyB0aGUgcG9zaXRpb24gb2YgdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlCiAgICogQHBhcmFtIHs/bnVtYmVyPX0gciBUaGUgcmFkaXVzIG9mIHRoZSBjaXJjbGUKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBDaXJjbGUocG9zLCByKSB7CiAgICB0aGlzWydwb3MnXSA9IHBvcyB8fCBuZXcgVmVjdG9yKCk7CiAgICB0aGlzWydyJ10gPSByIHx8IDA7CiAgfQogIFNBVFsnQ2lyY2xlJ10gPSBDaXJjbGU7CgogIC8vICMjIFBvbHlnb24KICAvLwogIC8vIFJlcHJlc2VudHMgYSAqY29udmV4KiBwb2x5Z29uIHdpdGggYW55IG51bWJlciBvZiBwb2ludHMgKHNwZWNpZmllZCBpbiBjb3VudGVyLWNsb2Nrd2lzZSBvcmRlcikKICAvLwogIC8vIFRoZSBlZGdlcy9ub3JtYWxzIG9mIHRoZSBwb2x5Z29uIHdpbGwgYmUgY2FsY3VsYXRlZCBvbiBjcmVhdGlvbiBhbmQgc3RvcmVkIGluIHRoZQogIC8vIGBlZGdlc2AgYW5kIGBub3JtYWxzYCBwcm9wZXJ0aWVzLiBJZiB5b3UgY2hhbmdlIHRoZSBwb2x5Z29uJ3MgcG9pbnRzLCB5b3Ugd2lsbCBuZWVkCiAgLy8gdG8gY2FsbCBgcmVjYWxjYCB0byByZWNhbGN1bGF0ZSB0aGUgZWRnZXMvbm9ybWFscy4KCiAgLy8gQ3JlYXRlIGEgbmV3IHBvbHlnb24sIHBhc3NpbmcgaW4gYSBwb3NpdGlvbiB2ZWN0b3IsIGFuZCBhbiBhcnJheSBvZiBwb2ludHMgKHJlcHJlc2VudGVkCiAgLy8gYnkgdmVjdG9ycyByZWxhdGl2ZSB0byB0aGUgcG9zaXRpb24gdmVjdG9yKS4gSWYgbm8gcG9zaXRpb24gaXMgcGFzc2VkIGluLCB0aGUgcG9zaXRpb24KICAvLyBvZiB0aGUgcG9seWdvbiB3aWxsIGJlIGAoMCwwKWAuCiAgLyoqCiAgICogQHBhcmFtIHtWZWN0b3I9fSBwb3MgQSB2ZWN0b3IgcmVwcmVzZW50aW5nIHRoZSBvcmlnaW4gb2YgdGhlIHBvbHlnb24uIChhbGwgb3RoZXIKICAgKiAgIHBvaW50cyBhcmUgcmVsYXRpdmUgdG8gdGhpcyBvbmUpCiAgICogQHBhcmFtIHtBcnJheS48VmVjdG9yPj19IHBvaW50cyBBbiBhcnJheSBvZiB2ZWN0b3JzIHJlcHJlc2VudGluZyB0aGUgcG9pbnRzIGluIHRoZSBwb2x5Z29uLAogICAqICAgaW4gY291bnRlci1jbG9ja3dpc2Ugb3JkZXIuCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gUG9seWdvbihwb3MsIHBvaW50cykgewogICAgdGhpc1sncG9zJ10gPSBwb3MgfHwgbmV3IFZlY3RvcigpOwogICAgdGhpc1sncG9pbnRzJ10gPSBwb2ludHMgfHwgW107CiAgICB0aGlzLnJlY2FsYygpOwogIH0KICBTQVRbJ1BvbHlnb24nXSA9IFBvbHlnb247CgogIC8vIFJlY2FsY3VsYXRlcyB0aGUgZWRnZXMgYW5kIG5vcm1hbHMgb2YgdGhlIHBvbHlnb24uIFRoaXMgKiptdXN0KiogYmUgY2FsbGVkCiAgLy8gaWYgdGhlIGBwb2ludHNgIGFycmF5IGlzIG1vZGlmaWVkIGF0IGFsbCBhbmQgdGhlIGVkZ2VzIG9yIG5vcm1hbHMgYXJlIHRvIGJlCiAgLy8gYWNjZXNzZWQuCiAgLyoqCiAgICogQHJldHVybiB7UG9seWdvbn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgUG9seWdvbi5wcm90b3R5cGVbJ3JlY2FsYyddID0gUG9seWdvbi5wcm90b3R5cGUucmVjYWxjID0gZnVuY3Rpb24oKSB7CiAgICAvLyBUaGUgZWRnZXMgaGVyZSBhcmUgdGhlIGRpcmVjdGlvbiBvZiB0aGUgYG5gdGggZWRnZSBvZiB0aGUgcG9seWdvbiwgcmVsYXRpdmUgdG8KICAgIC8vIHRoZSBgbmB0aCBwb2ludC4gSWYgeW91IHdhbnQgdG8gZHJhdyBhIGdpdmVuIGVkZ2UgZnJvbSB0aGUgZWRnZSB2YWx1ZSwgeW91IG11c3QKICAgIC8vIGZpcnN0IHRyYW5zbGF0ZSB0byB0aGUgcG9zaXRpb24gb2YgdGhlIHN0YXJ0aW5nIHBvaW50LgogICAgdGhpc1snZWRnZXMnXSA9IFtdOwogICAgLy8gVGhlIG5vcm1hbHMgaGVyZSBhcmUgdGhlIGRpcmVjdGlvbiBvZiB0aGUgbm9ybWFsIGZvciB0aGUgYG5gdGggZWRnZSBvZiB0aGUgcG9seWdvbiwgcmVsYXRpdmUKICAgIC8vIHRvIHRoZSBwb3NpdGlvbiBvZiB0aGUgYG5gdGggcG9pbnQuIElmIHlvdSB3YW50IHRvIGRyYXcgYW4gZWRnZSBub3JtYWwsIHlvdSBtdXN0IGZpcnN0CiAgICAvLyB0cmFuc2xhdGUgdG8gdGhlIHBvc2l0aW9uIG9mIHRoZSBzdGFydGluZyBwb2ludC4KICAgIHRoaXNbJ25vcm1hbHMnXSA9IFtdOwogICAgdmFyIHBvaW50cyA9IHRoaXNbJ3BvaW50cyddOwogICAgdmFyIGxlbiA9IHBvaW50cy5sZW5ndGg7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHZhciBwMSA9IHBvaW50c1tpXTsKICAgICAgdmFyIHAyID0gaSA8IGxlbiAtIDEgPyBwb2ludHNbaSArIDFdIDogcG9pbnRzWzBdOwogICAgICB2YXIgZSA9IG5ldyBWZWN0b3IoKS5jb3B5KHAyKS5zdWIocDEpOwogICAgICB2YXIgbiA9IG5ldyBWZWN0b3IoKS5jb3B5KGUpLnBlcnAoKS5ub3JtYWxpemUoKTsKICAgICAgdGhpc1snZWRnZXMnXS5wdXNoKGUpOwogICAgICB0aGlzWydub3JtYWxzJ10ucHVzaChuKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFJvdGF0ZXMgdGhpcyBwb2x5Z29uIGNvdW50ZXItY2xvY2t3aXNlIGFyb3VuZCB0aGUgb3JpZ2luIG9mICppdHMgbG9jYWwgY29vcmRpbmF0ZSBzeXN0ZW0qIChpLmUuIGBwb3NgKS4KICAvLwogIC8vIE5vdGU6IFlvdSBkbyAqKm5vdCoqIG5lZWQgdG8gY2FsbCBgcmVjYWxjYCBhZnRlciByb3RhdGlvbi4KICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgVGhlIGFuZ2xlIHRvIHJvdGF0ZSAoaW4gcmFkaWFucykKICAgKiBAcmV0dXJuIHtQb2x5Z29ufSBUaGlzIGZvciBjaGFpbmluZy4KICAgKi8KICBQb2x5Z29uLnByb3RvdHlwZVsncm90YXRlJ10gPSBQb2x5Z29uLnByb3RvdHlwZS5yb3RhdGUgPSBmdW5jdGlvbihhbmdsZSkgewogICAgdmFyIGk7CiAgICB2YXIgcG9pbnRzID0gdGhpc1sncG9pbnRzJ107CiAgICB2YXIgZWRnZXMgPSB0aGlzWydlZGdlcyddOwogICAgdmFyIG5vcm1hbHMgPSB0aGlzWydub3JtYWxzJ107CiAgICB2YXIgbGVuID0gcG9pbnRzLmxlbmd0aDsKCiAgICAvLyAgQ2FsYyBpdCBqdXN0IHRoZSBvbmNlLCByYXRoZXIgdGhhbiA0IHRpbWVzIHBlciBhcnJheSBlbGVtZW50CiAgICB2YXIgY29zID0gTWF0aC5jb3MoYW5nbGUpOwogICAgdmFyIHNpbiA9IE1hdGguc2luKGFuZ2xlKTsKCiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgcG9pbnRzW2ldLnJvdGF0ZVByZWNhbGMoc2luLCBjb3MpOwogICAgICBlZGdlc1tpXS5yb3RhdGVQcmVjYWxjKHNpbiwgY29zKTsKICAgICAgbm9ybWFsc1tpXS5yb3RhdGVQcmVjYWxjKHNpbiwgY29zKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFJvdGF0ZXMgdGhpcyBwb2x5Z29uIGNvdW50ZXItY2xvY2t3aXNlIGFyb3VuZCB0aGUgb3JpZ2luIG9mICppdHMgbG9jYWwgY29vcmRpbmF0ZSBzeXN0ZW0qIChpLmUuIGBwb3NgKS4KICAvLwogIC8vIE5vdGU6IFlvdSBkbyAqKm5vdCoqIG5lZWQgdG8gY2FsbCBgcmVjYWxjYCBhZnRlciByb3RhdGlvbi4KICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgVGhlIGFuZ2xlIHRvIHJvdGF0ZSAoaW4gcmFkaWFucykKICAgKiBAcmV0dXJuIHtQb2x5Z29ufSBUaGlzIGZvciBjaGFpbmluZy4KICAgKi8KICBQb2x5Z29uLnByb3RvdHlwZVsnc2NhbGUnXSA9IFBvbHlnb24ucHJvdG90eXBlLnNjYWxlID0gZnVuY3Rpb24oeCwgeSkgewogICAgdmFyIGk7CiAgICB2YXIgcG9pbnRzID0gdGhpc1sncG9pbnRzJ107CiAgICB2YXIgZWRnZXMgPSB0aGlzWydlZGdlcyddOwogICAgdmFyIG5vcm1hbHMgPSB0aGlzWydub3JtYWxzJ107CiAgICB2YXIgbGVuID0gcG9pbnRzLmxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICBwb2ludHNbaV0uc2NhbGUoeCx5KTsKICAgICAgZWRnZXNbaV0uc2NhbGUoeCx5KTsKICAgICAgbm9ybWFsc1tpXS5zY2FsZSh4LHkpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gVHJhbnNsYXRlcyB0aGUgcG9pbnRzIG9mIHRoaXMgcG9seWdvbiBieSBhIHNwZWNpZmllZCBhbW91bnQgcmVsYXRpdmUgdG8gdGhlIG9yaWdpbiBvZiAqaXRzIG93biBjb29yZGluYXRlCiAgLy8gc3lzdGVtKiAoaS5lLiBgcG9zYCkuCiAgLy8KICAvLyBUaGlzIGlzIG1vc3QgdXNlZnVsIHRvIGNoYW5nZSB0aGUgImNlbnRlciBwb2ludCIgb2YgYSBwb2x5Z29uLgogIC8vCiAgLy8gTm90ZTogWW91IGRvICoqbm90KiogbmVlZCB0byBjYWxsIGByZWNhbGNgIGFmdGVyIHRyYW5zbGF0aW9uLgogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSB4IFRoZSBob3Jpem9udGFsIGFtb3VudCB0byB0cmFuc2xhdGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgVGhlIHZlcnRpY2FsIGFtb3VudCB0byB0cmFuc2xhdGUuCiAgICogQHJldHVybiB7UG9seWdvbn0gVGhpcyBmb3IgY2hhaW5pbmcuCiAgICovCiAgUG9seWdvbi5wcm90b3R5cGVbJ3RyYW5zbGF0ZSddID0gUG9seWdvbi5wcm90b3R5cGUudHJhbnNsYXRlID0gZnVuY3Rpb24gKHgsIHkpIHsKICAgIHZhciBpOwogICAgdmFyIHBvaW50cyA9IHRoaXNbJ3BvaW50cyddOwogICAgdmFyIGxlbiA9IHBvaW50cy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgcG9pbnRzW2ldLnggKz0geDsKICAgICAgcG9pbnRzW2ldLnkgKz0geTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vICMjIEJveAogIC8vCiAgLy8gUmVwcmVzZW50cyBhbiBheGlzLWFsaWduZWQgYm94LCB3aXRoIGEgd2lkdGggYW5kIGhlaWdodC4KCgogIC8vIENyZWF0ZSBhIG5ldyBib3gsIHdpdGggdGhlIHNwZWNpZmllZCBwb3NpdGlvbiwgd2lkdGgsIGFuZCBoZWlnaHQuIElmIG5vIHBvc2l0aW9uCiAgLy8gaXMgZ2l2ZW4sIHRoZSBwb3NpdGlvbiB3aWxsIGJlIGAoMCwwKWAuIElmIG5vIHdpZHRoIG9yIGhlaWdodCBhcmUgZ2l2ZW4sIHRoZXkgd2lsbAogIC8vIGJlIHNldCB0byBgMGAuCiAgLyoqCiAgICogQHBhcmFtIHtWZWN0b3I9fSBwb3MgQSB2ZWN0b3IgcmVwcmVzZW50aW5nIHRoZSB0b3AtbGVmdCBvZiB0aGUgYm94LgogICAqIEBwYXJhbSB7P251bWJlcj19IHcgVGhlIHdpZHRoIG9mIHRoZSBib3guCiAgICogQHBhcmFtIHs/bnVtYmVyPX0gaCBUaGUgaGVpZ2h0IG9mIHRoZSBib3guCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gQm94KHBvcywgdywgaCkgewogICAgdGhpc1sncG9zJ10gPSBwb3MgfHwgbmV3IFZlY3RvcigpOwogICAgdGhpc1sndyddID0gdyB8fCAwOwogICAgdGhpc1snaCddID0gaCB8fCAwOwogIH0KICBTQVRbJ0JveCddID0gQm94OwoKICAvLyBSZXR1cm5zIGEgcG9seWdvbiB3aG9zZSBlZGdlcyBhcmUgdGhlIHNhbWUgYXMgdGhpcyBib3guCiAgLyoqCiAgICogQHJldHVybiB7UG9seWdvbn0gQSBuZXcgUG9seWdvbiB0aGF0IHJlcHJlc2VudHMgdGhpcyBib3guCiAgICovCiAgQm94LnByb3RvdHlwZVsndG9Qb2x5Z29uJ10gPSBCb3gucHJvdG90eXBlLnRvUG9seWdvbiA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHBvcyA9IHRoaXNbJ3BvcyddOwogICAgdmFyIHcgPSB0aGlzWyd3J107CiAgICB2YXIgaCA9IHRoaXNbJ2gnXTsKICAgIHJldHVybiBuZXcgUG9seWdvbihuZXcgVmVjdG9yKHBvc1sneCddLCBwb3NbJ3knXSksIFsKICAgICBuZXcgVmVjdG9yKCksIG5ldyBWZWN0b3IodywgMCksCiAgICAgbmV3IFZlY3Rvcih3LGgpLCBuZXcgVmVjdG9yKDAsaCkKICAgIF0pOwogIH07CgogIC8vICMjIFJlc3BvbnNlCiAgLy8KICAvLyBBbiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZXN1bHQgb2YgYW4gaW50ZXJzZWN0aW9uLiBDb250YWluczoKICAvLyAgLSBUaGUgdHdvIG9iamVjdHMgcGFydGljaXBhdGluZyBpbiB0aGUgaW50ZXJzZWN0aW9uCiAgLy8gIC0gVGhlIHZlY3RvciByZXByZXNlbnRpbmcgdGhlIG1pbmltdW0gY2hhbmdlIG5lY2Vzc2FyeSB0byBleHRyYWN0IHRoZSBmaXJzdCBvYmplY3QKICAvLyAgICBmcm9tIHRoZSBzZWNvbmQgb25lIChhcyB3ZWxsIGFzIGEgdW5pdCB2ZWN0b3IgaW4gdGhhdCBkaXJlY3Rpb24gYW5kIHRoZSBtYWduaXR1ZGUKICAvLyAgICBvZiB0aGUgb3ZlcmxhcCkKICAvLyAgLSBXaGV0aGVyIHRoZSBmaXJzdCBvYmplY3QgaXMgZW50aXJlbHkgaW5zaWRlIHRoZSBzZWNvbmQsIGFuZCB2aWNlIHZlcnNhLgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIFJlc3BvbnNlKCkgewogICAgdGhpc1snYSddID0gbnVsbDsKICAgIHRoaXNbJ2InXSA9IG51bGw7CiAgICB0aGlzWydvdmVybGFwTiddID0gbmV3IFZlY3RvcigpOwogICAgdGhpc1snb3ZlcmxhcFYnXSA9IG5ldyBWZWN0b3IoKTsKICAgIHRoaXMuY2xlYXIoKTsKICB9CiAgU0FUWydSZXNwb25zZSddID0gUmVzcG9uc2U7CgogIC8vIFNldCBzb21lIHZhbHVlcyBvZiB0aGUgcmVzcG9uc2UgYmFjayB0byB0aGVpciBkZWZhdWx0cy4gIENhbGwgdGhpcyBiZXR3ZWVuIHRlc3RzIGlmCiAgLy8geW91IGFyZSBnb2luZyB0byByZXVzZSBhIHNpbmdsZSBSZXNwb25zZSBvYmplY3QgZm9yIG11bHRpcGxlIGludGVyc2VjdGlvbiB0ZXN0cyAocmVjb21tZW50ZWQKICAvLyBhcyBpdCB3aWxsIGF2b2lkIGFsbGNhdGluZyBleHRyYSBtZW1vcnkpCiAgLyoqCiAgICogQHJldHVybiB7UmVzcG9uc2V9IFRoaXMgZm9yIGNoYWluaW5nCiAgICovCiAgUmVzcG9uc2UucHJvdG90eXBlWydjbGVhciddID0gUmVzcG9uc2UucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24oKSB7CiAgICB0aGlzWydhSW5CJ10gPSB0cnVlOwogICAgdGhpc1snYkluQSddID0gdHJ1ZTsKICAgIHRoaXNbJ292ZXJsYXAnXSA9IE51bWJlci5NQVhfVkFMVUU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyAjIyBPYmplY3QgUG9vbHMKCiAgLy8gQSBwb29sIG9mIGBWZWN0b3JgIG9iamVjdHMgdGhhdCBhcmUgdXNlZCBpbiBjYWxjdWxhdGlvbnMgdG8gYXZvaWQKICAvLyBhbGxvY2F0aW5nIG1lbW9yeS4KICAvKioKICAgKiBAdHlwZSB7QXJyYXkuPFZlY3Rvcj59CiAgICovCiAgdmFyIFRfVkVDVE9SUyA9IFtdOwogIGZvciAodmFyIGkgPSAwOyBpIDwgMTA7IGkrKykgeyBUX1ZFQ1RPUlMucHVzaChuZXcgVmVjdG9yKCkpOyB9CgogIC8vIEEgcG9vbCBvZiBhcnJheXMgb2YgbnVtYmVycyB1c2VkIGluIGNhbGN1bGF0aW9ucyB0byBhdm9pZCBhbGxvY2F0aW5nCiAgLy8gbWVtb3J5LgogIC8qKgogICAqIEB0eXBlIHtBcnJheS48QXJyYXkuPG51bWJlcj4+fQogICAqLwogIHZhciBUX0FSUkFZUyA9IFtdOwogIGZvciAodmFyIGkgPSAwOyBpIDwgNTsgaSsrKSB7IFRfQVJSQVlTLnB1c2goW10pOyB9CgogIC8vICMjIEhlbHBlciBGdW5jdGlvbnMKCiAgLy8gRmxhdHRlbnMgdGhlIHNwZWNpZmllZCBhcnJheSBvZiBwb2ludHMgb250byBhIHVuaXQgdmVjdG9yIGF4aXMsCiAgLy8gcmVzdWx0aW5nIGluIGEgb25lIGRpbWVuc2lvbmFsIHJhbmdlIG9mIHRoZSBtaW5pbXVtIGFuZAogIC8vIG1heGltdW0gdmFsdWUgb24gdGhhdCBheGlzLgogIC8qKgogICAqIEBwYXJhbSB7QXJyYXkuPFZlY3Rvcj59IHBvaW50cyBUaGUgcG9pbnRzIHRvIGZsYXR0ZW4uCiAgICogQHBhcmFtIHtWZWN0b3J9IG5vcm1hbCBUaGUgdW5pdCB2ZWN0b3IgYXhpcyB0byBmbGF0dGVuIG9uLgogICAqIEBwYXJhbSB7QXJyYXkuPG51bWJlcj59IHJlc3VsdCBBbiBhcnJheS4gIEFmdGVyIGNhbGxpbmcgdGhpcyBmdW5jdGlvbiwKICAgKiAgIHJlc3VsdFswXSB3aWxsIGJlIHRoZSBtaW5pbXVtIHZhbHVlLAogICAqICAgcmVzdWx0WzFdIHdpbGwgYmUgdGhlIG1heGltdW0gdmFsdWUuCiAgICovCiAgZnVuY3Rpb24gZmxhdHRlblBvaW50c09uKHBvaW50cywgbm9ybWFsLCByZXN1bHQpIHsKICAgIHZhciBtaW4gPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgdmFyIG1heCA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgdmFyIGxlbiA9IHBvaW50cy5sZW5ndGg7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrICkgewogICAgICAvLyBUaGUgbWFnbml0dWRlIG9mIHRoZSBwcm9qZWN0aW9uIG9mIHRoZSBwb2ludCBvbnRvIHRoZSBub3JtYWwKICAgICAgdmFyIGRvdCA9IHBvaW50c1tpXS5kb3Qobm9ybWFsKTsKICAgICAgaWYgKGRvdCA8IG1pbikgeyBtaW4gPSBkb3Q7IH0KICAgICAgaWYgKGRvdCA+IG1heCkgeyBtYXggPSBkb3Q7IH0KICAgIH0KICAgIHJlc3VsdFswXSA9IG1pbjsgcmVzdWx0WzFdID0gbWF4OwogIH0KCiAgLy8gQ2hlY2sgd2hldGhlciB0d28gY29udmV4IHBvbHlnb25zIGFyZSBzZXBhcmF0ZWQgYnkgdGhlIHNwZWNpZmllZAogIC8vIGF4aXMgKG11c3QgYmUgYSB1bml0IHZlY3RvcikuCiAgLyoqCiAgICogQHBhcmFtIHtWZWN0b3J9IGFQb3MgVGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBwb2x5Z29uLgogICAqIEBwYXJhbSB7VmVjdG9yfSBiUG9zIFRoZSBwb3NpdGlvbiBvZiB0aGUgc2Vjb25kIHBvbHlnb24uCiAgICogQHBhcmFtIHtBcnJheS48VmVjdG9yPn0gYVBvaW50cyBUaGUgcG9pbnRzIGluIHRoZSBmaXJzdCBwb2x5Z29uLgogICAqIEBwYXJhbSB7QXJyYXkuPFZlY3Rvcj59IGJQb2ludHMgVGhlIHBvaW50cyBpbiB0aGUgc2Vjb25kIHBvbHlnb24uCiAgICogQHBhcmFtIHtWZWN0b3J9IGF4aXMgVGhlIGF4aXMgKHVuaXQgc2l6ZWQpIHRvIHRlc3QgYWdhaW5zdC4gIFRoZSBwb2ludHMgb2YgYm90aCBwb2x5Z29ucwogICAqICAgd2lsbCBiZSBwcm9qZWN0ZWQgb250byB0aGlzIGF4aXMuCiAgICogQHBhcmFtIHtSZXNwb25zZT19IHJlc3BvbnNlIEEgUmVzcG9uc2Ugb2JqZWN0IChvcHRpb25hbCkgd2hpY2ggd2lsbCBiZSBwb3B1bGF0ZWQKICAgKiAgIGlmIHRoZSBheGlzIGlzIG5vdCBhIHNlcGFyYXRpbmcgYXhpcy4KICAgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIGl0IGlzIGEgc2VwYXJhdGluZyBheGlzLCBmYWxzZSBvdGhlcndpc2UuICBJZiBmYWxzZSwKICAgKiAgIGFuZCBhIHJlc3BvbnNlIGlzIHBhc3NlZCBpbiwgaW5mb3JtYXRpb24gYWJvdXQgaG93IG11Y2ggb3ZlcmxhcCBhbmQKICAgKiAgIHRoZSBkaXJlY3Rpb24gb2YgdGhlIG92ZXJsYXAgd2lsbCBiZSBwb3B1bGF0ZWQuCiAgICovCiAgZnVuY3Rpb24gaXNTZXBhcmF0aW5nQXhpcyhhUG9zLCBiUG9zLCBhUG9pbnRzLCBiUG9pbnRzLCBheGlzLCByZXNwb25zZSkgewogICAgdmFyIHJhbmdlQSA9IFRfQVJSQVlTLnBvcCgpOwogICAgdmFyIHJhbmdlQiA9IFRfQVJSQVlTLnBvcCgpOwogICAgLy8gVGhlIG1hZ25pdHVkZSBvZiB0aGUgb2Zmc2V0IGJldHdlZW4gdGhlIHR3byBwb2x5Z29ucwogICAgdmFyIG9mZnNldFYgPSBUX1ZFQ1RPUlMucG9wKCkuY29weShiUG9zKS5zdWIoYVBvcyk7CiAgICB2YXIgcHJvamVjdGVkT2Zmc2V0ID0gb2Zmc2V0Vi5kb3QoYXhpcyk7CiAgICAvLyBQcm9qZWN0IHRoZSBwb2x5Z29ucyBvbnRvIHRoZSBheGlzLgogICAgZmxhdHRlblBvaW50c09uKGFQb2ludHMsIGF4aXMsIHJhbmdlQSk7CiAgICBmbGF0dGVuUG9pbnRzT24oYlBvaW50cywgYXhpcywgcmFuZ2VCKTsKICAgIC8vIE1vdmUgQidzIHJhbmdlIHRvIGl0cyBwb3NpdGlvbiByZWxhdGl2ZSB0byBBLgogICAgcmFuZ2VCWzBdICs9IHByb2plY3RlZE9mZnNldDsKICAgIHJhbmdlQlsxXSArPSBwcm9qZWN0ZWRPZmZzZXQ7CiAgICAvLyBDaGVjayBpZiB0aGVyZSBpcyBhIGdhcC4gSWYgdGhlcmUgaXMsIHRoaXMgaXMgYSBzZXBhcmF0aW5nIGF4aXMgYW5kIHdlIGNhbiBzdG9wCiAgICBpZiAocmFuZ2VBWzBdID4gcmFuZ2VCWzFdIHx8IHJhbmdlQlswXSA+IHJhbmdlQVsxXSkgewogICAgICBUX1ZFQ1RPUlMucHVzaChvZmZzZXRWKTsKICAgICAgVF9BUlJBWVMucHVzaChyYW5nZUEpOwogICAgICBUX0FSUkFZUy5wdXNoKHJhbmdlQik7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gVGhpcyBpcyBub3QgYSBzZXBhcmF0aW5nIGF4aXMuIElmIHdlJ3JlIGNhbGN1bGF0aW5nIGEgcmVzcG9uc2UsIGNhbGN1bGF0ZSB0aGUgb3ZlcmxhcC4KICAgIGlmIChyZXNwb25zZSkgewogICAgICB2YXIgb3ZlcmxhcCA9IDA7CiAgICAgIC8vIEEgc3RhcnRzIGZ1cnRoZXIgbGVmdCB0aGFuIEIKICAgICAgaWYgKHJhbmdlQVswXSA8IHJhbmdlQlswXSkgewogICAgICAgIHJlc3BvbnNlWydhSW5CJ10gPSBmYWxzZTsKICAgICAgICAvLyBBIGVuZHMgYmVmb3JlIEIgZG9lcy4gV2UgaGF2ZSB0byBwdWxsIEEgb3V0IG9mIEIKICAgICAgICBpZiAocmFuZ2VBWzFdIDwgcmFuZ2VCWzFdKSB7CiAgICAgICAgICBvdmVybGFwID0gcmFuZ2VBWzFdIC0gcmFuZ2VCWzBdOwogICAgICAgICAgcmVzcG9uc2VbJ2JJbkEnXSA9IGZhbHNlOwogICAgICAgIC8vIEIgaXMgZnVsbHkgaW5zaWRlIEEuICBQaWNrIHRoZSBzaG9ydGVzdCB3YXkgb3V0LgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgb3B0aW9uMSA9IHJhbmdlQVsxXSAtIHJhbmdlQlswXTsKICAgICAgICAgIHZhciBvcHRpb24yID0gcmFuZ2VCWzFdIC0gcmFuZ2VBWzBdOwogICAgICAgICAgb3ZlcmxhcCA9IG9wdGlvbjEgPCBvcHRpb24yID8gb3B0aW9uMSA6IC1vcHRpb24yOwogICAgICAgIH0KICAgICAgLy8gQiBzdGFydHMgZnVydGhlciBsZWZ0IHRoYW4gQQogICAgICB9IGVsc2UgewogICAgICAgIHJlc3BvbnNlWydiSW5BJ10gPSBmYWxzZTsKICAgICAgICAvLyBCIGVuZHMgYmVmb3JlIEEgZW5kcy4gV2UgaGF2ZSB0byBwdXNoIEEgb3V0IG9mIEIKICAgICAgICBpZiAocmFuZ2VBWzFdID4gcmFuZ2VCWzFdKSB7CiAgICAgICAgICBvdmVybGFwID0gcmFuZ2VBWzBdIC0gcmFuZ2VCWzFdOwogICAgICAgICAgcmVzcG9uc2VbJ2FJbkInXSA9IGZhbHNlOwogICAgICAgIC8vIEEgaXMgZnVsbHkgaW5zaWRlIEIuICBQaWNrIHRoZSBzaG9ydGVzdCB3YXkgb3V0LgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgb3B0aW9uMSA9IHJhbmdlQVsxXSAtIHJhbmdlQlswXTsKICAgICAgICAgIHZhciBvcHRpb24yID0gcmFuZ2VCWzFdIC0gcmFuZ2VBWzBdOwogICAgICAgICAgb3ZlcmxhcCA9IG9wdGlvbjEgPCBvcHRpb24yID8gb3B0aW9uMSA6IC1vcHRpb24yOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBJZiB0aGlzIGlzIHRoZSBzbWFsbGVzdCBhbW91bnQgb2Ygb3ZlcmxhcCB3ZSd2ZSBzZWVuIHNvIGZhciwgc2V0IGl0IGFzIHRoZSBtaW5pbXVtIG92ZXJsYXAuCiAgICAgIHZhciBhYnNPdmVybGFwID0gTWF0aC5hYnMob3ZlcmxhcCk7CiAgICAgIGlmIChhYnNPdmVybGFwIDwgcmVzcG9uc2VbJ292ZXJsYXAnXSkgewogICAgICAgIHJlc3BvbnNlWydvdmVybGFwJ10gPSBhYnNPdmVybGFwOwogICAgICAgIHJlc3BvbnNlWydvdmVybGFwTiddLmNvcHkoYXhpcyk7CiAgICAgICAgaWYgKG92ZXJsYXAgPCAwKSB7CiAgICAgICAgICByZXNwb25zZVsnb3ZlcmxhcE4nXS5yZXZlcnNlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBUX1ZFQ1RPUlMucHVzaChvZmZzZXRWKTsKICAgIFRfQVJSQVlTLnB1c2gocmFuZ2VBKTsKICAgIFRfQVJSQVlTLnB1c2gocmFuZ2VCKTsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIC8vIENhbGN1bGF0ZXMgd2hpY2ggVm9ybm9pIHJlZ2lvbiBhIHBvaW50IGlzIG9uIGEgbGluZSBzZWdtZW50LgogIC8vIEl0IGlzIGFzc3VtZWQgdGhhdCBib3RoIHRoZSBsaW5lIGFuZCB0aGUgcG9pbnQgYXJlIHJlbGF0aXZlIHRvIGAoMCwwKWAKICAvLwogIC8vICAgICAgICAgICAgfCAgICAgICAoMCkgICAgICB8CiAgLy8gICAgICgtMSkgIFtTXS0tLS0tLS0tLS0tLS0tW0VdICAoMSkKICAvLyAgICAgICAgICAgIHwgICAgICAgKDApICAgICAgfAogIC8qKgogICAqIEBwYXJhbSB7VmVjdG9yfSBsaW5lIFRoZSBsaW5lIHNlZ21lbnQuCiAgICogQHBhcmFtIHtWZWN0b3J9IHBvaW50IFRoZSBwb2ludC4KICAgKiBAcmV0dXJuICB7bnVtYmVyfSBMRUZUX1ZPUk5PSV9SRUdJT04gKC0xKSBpZiBpdCBpcyB0aGUgbGVmdCByZWdpb24sCiAgICogICAgICAgICAgTUlERExFX1ZPUk5PSV9SRUdJT04gKDApIGlmIGl0IGlzIHRoZSBtaWRkbGUgcmVnaW9uLAogICAqICAgICAgICAgIFJJR0hUX1ZPUk5PSV9SRUdJT04gKDEpIGlmIGl0IGlzIHRoZSByaWdodCByZWdpb24uCiAgICovCiAgZnVuY3Rpb24gdm9ybm9pUmVnaW9uKGxpbmUsIHBvaW50KSB7CiAgICB2YXIgbGVuMiA9IGxpbmUubGVuMigpOwogICAgdmFyIGRwID0gcG9pbnQuZG90KGxpbmUpOwogICAgLy8gSWYgdGhlIHBvaW50IGlzIGJleW9uZCB0aGUgc3RhcnQgb2YgdGhlIGxpbmUsIGl0IGlzIGluIHRoZQogICAgLy8gbGVmdCB2b3Jub2kgcmVnaW9uLgogICAgaWYgKGRwIDwgMCkgeyByZXR1cm4gTEVGVF9WT1JOT0lfUkVHSU9OOyB9CiAgICAvLyBJZiB0aGUgcG9pbnQgaXMgYmV5b25kIHRoZSBlbmQgb2YgdGhlIGxpbmUsIGl0IGlzIGluIHRoZQogICAgLy8gcmlnaHQgdm9ybm9pIHJlZ2lvbi4KICAgIGVsc2UgaWYgKGRwID4gbGVuMikgeyByZXR1cm4gUklHSFRfVk9STk9JX1JFR0lPTjsgfQogICAgLy8gT3RoZXJ3aXNlLCBpdCdzIGluIHRoZSBtaWRkbGUgb25lLgogICAgZWxzZSB7IHJldHVybiBNSURETEVfVk9STk9JX1JFR0lPTjsgfQogIH0KICAvLyBDb25zdGFudHMgZm9yIFZvcm5vaSByZWdpb25zCiAgLyoqCiAgICogQGNvbnN0CiAgICovCiAgdmFyIExFRlRfVk9STk9JX1JFR0lPTiA9IC0xOwogIC8qKgogICAqIEBjb25zdAogICAqLwogIHZhciBNSURETEVfVk9STk9JX1JFR0lPTiA9IDA7CiAgLyoqCiAgICogQGNvbnN0CiAgICovCiAgdmFyIFJJR0hUX1ZPUk5PSV9SRUdJT04gPSAxOwoKICAvLyAjIyBDb2xsaXNpb24gVGVzdHMKCiAgLy8gQ2hlY2sgaWYgdHdvIGNpcmNsZXMgY29sbGlkZS4KICAvKioKICAgKiBAcGFyYW0ge0NpcmNsZX0gYSBUaGUgZmlyc3QgY2lyY2xlLgogICAqIEBwYXJhbSB7Q2lyY2xlfSBiIFRoZSBzZWNvbmQgY2lyY2xlLgogICAqIEBwYXJhbSB7UmVzcG9uc2U9fSByZXNwb25zZSBSZXNwb25zZSBvYmplY3QgKG9wdGlvbmFsKSB0aGF0IHdpbGwgYmUgcG9wdWxhdGVkIGlmCiAgICogICB0aGUgY2lyY2xlcyBpbnRlcnNlY3QuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiB0aGUgY2lyY2xlcyBpbnRlcnNlY3QsIGZhbHNlIGlmIHRoZXkgZG9uJ3QuCiAgICovCiAgZnVuY3Rpb24gdGVzdENpcmNsZUNpcmNsZShhLCBiLCByZXNwb25zZSkgewogICAgLy8gQ2hlY2sgaWYgdGhlIGRpc3RhbmNlIGJldHdlZW4gdGhlIGNlbnRlcnMgb2YgdGhlIHR3bwogICAgLy8gY2lyY2xlcyBpcyBncmVhdGVyIHRoYW4gdGhlaXIgY29tYmluZWQgcmFkaXVzLgogICAgdmFyIGRpZmZlcmVuY2VWID0gVF9WRUNUT1JTLnBvcCgpLmNvcHkoYlsncG9zJ10pLnN1YihhWydwb3MnXSk7CiAgICB2YXIgdG90YWxSYWRpdXMgPSBhWydyJ10gKyBiWydyJ107CiAgICB2YXIgdG90YWxSYWRpdXNTcSA9IHRvdGFsUmFkaXVzICogdG90YWxSYWRpdXM7CiAgICB2YXIgZGlzdGFuY2VTcSA9IGRpZmZlcmVuY2VWLmxlbjIoKTsKICAgIC8vIElmIHRoZSBkaXN0YW5jZSBpcyBiaWdnZXIgdGhhbiB0aGUgY29tYmluZWQgcmFkaXVzLCB0aGV5IGRvbid0IGludGVyc2VjdC4KICAgIGlmIChkaXN0YW5jZVNxID4gdG90YWxSYWRpdXNTcSkgewogICAgICBUX1ZFQ1RPUlMucHVzaChkaWZmZXJlbmNlVik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8vIFRoZXkgaW50ZXJzZWN0LiAgSWYgd2UncmUgY2FsY3VsYXRpbmcgYSByZXNwb25zZSwgY2FsY3VsYXRlIHRoZSBvdmVybGFwLgogICAgaWYgKHJlc3BvbnNlKSB7CiAgICAgIHZhciBkaXN0ID0gTWF0aC5zcXJ0KGRpc3RhbmNlU3EpOwogICAgICByZXNwb25zZVsnYSddID0gYTsKICAgICAgcmVzcG9uc2VbJ2InXSA9IGI7CiAgICAgIHJlc3BvbnNlWydvdmVybGFwJ10gPSB0b3RhbFJhZGl1cyAtIGRpc3Q7CiAgICAgIHJlc3BvbnNlWydvdmVybGFwTiddLmNvcHkoZGlmZmVyZW5jZVYubm9ybWFsaXplKCkpOwogICAgICByZXNwb25zZVsnb3ZlcmxhcFYnXS5jb3B5KGRpZmZlcmVuY2VWKS5zY2FsZShyZXNwb25zZVsnb3ZlcmxhcCddKTsKICAgICAgcmVzcG9uc2VbJ2FJbkInXT0gYVsnciddIDw9IGJbJ3InXSAmJiBkaXN0IDw9IGJbJ3InXSAtIGFbJ3InXTsKICAgICAgcmVzcG9uc2VbJ2JJbkEnXSA9IGJbJ3InXSA8PSBhWydyJ10gJiYgZGlzdCA8PSBhWydyJ10gLSBiWydyJ107CiAgICB9CiAgICBUX1ZFQ1RPUlMucHVzaChkaWZmZXJlbmNlVik7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgU0FUWyd0ZXN0Q2lyY2xlQ2lyY2xlJ10gPSB0ZXN0Q2lyY2xlQ2lyY2xlOwoKICAvLyBDaGVjayBpZiBhIHBvbHlnb24gYW5kIGEgY2lyY2xlIGNvbGxpZGUuCiAgLyoqCiAgICogQHBhcmFtIHtQb2x5Z29ufSBwb2x5Z29uIFRoZSBwb2x5Z29uLgogICAqIEBwYXJhbSB7Q2lyY2xlfSBjaXJjbGUgVGhlIGNpcmNsZS4KICAgKiBAcGFyYW0ge1Jlc3BvbnNlPX0gcmVzcG9uc2UgUmVzcG9uc2Ugb2JqZWN0IChvcHRpb25hbCkgdGhhdCB3aWxsIGJlIHBvcHVsYXRlZCBpZgogICAqICAgdGhleSBpbnRlcnNldC4KICAgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHRoZXkgaW50ZXJzZWN0LCBmYWxzZSBpZiB0aGV5IGRvbid0LgogICAqLwogIGZ1bmN0aW9uIHRlc3RQb2x5Z29uQ2lyY2xlKHBvbHlnb24sIGNpcmNsZSwgcmVzcG9uc2UpIHsKICAgIC8vIEdldCB0aGUgcG9zaXRpb24gb2YgdGhlIGNpcmNsZSByZWxhdGl2ZSB0byB0aGUgcG9seWdvbi4KICAgIHZhciBjaXJjbGVQb3MgPSBUX1ZFQ1RPUlMucG9wKCkuY29weShjaXJjbGVbJ3BvcyddKS5zdWIocG9seWdvblsncG9zJ10pOwogICAgdmFyIHJhZGl1cyA9IGNpcmNsZVsnciddOwogICAgdmFyIHJhZGl1czIgPSByYWRpdXMgKiByYWRpdXM7CiAgICB2YXIgcG9pbnRzID0gcG9seWdvblsncG9pbnRzJ107CiAgICB2YXIgbGVuID0gcG9pbnRzLmxlbmd0aDsKICAgIHZhciBlZGdlID0gVF9WRUNUT1JTLnBvcCgpOwogICAgdmFyIHBvaW50ID0gVF9WRUNUT1JTLnBvcCgpOwoKICAgIC8vIEZvciBlYWNoIGVkZ2UgaW4gdGhlIHBvbHlnb246CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHZhciBuZXh0ID0gaSA9PT0gbGVuIC0gMSA/IDAgOiBpICsgMTsKICAgICAgdmFyIHByZXYgPSBpID09PSAwID8gbGVuIC0gMSA6IGkgLSAxOwogICAgICB2YXIgb3ZlcmxhcCA9IDA7CiAgICAgIHZhciBvdmVybGFwTiA9IG51bGw7CgogICAgICAvLyBHZXQgdGhlIGVkZ2UuCiAgICAgIGVkZ2UuY29weShwb2x5Z29uWydlZGdlcyddW2ldKTsKICAgICAgLy8gQ2FsY3VsYXRlIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZSByZWxhdGl2ZSB0byB0aGUgc3RhcnRpbmcgcG9pbnQgb2YgdGhlIGVkZ2UuCiAgICAgIHBvaW50LmNvcHkoY2lyY2xlUG9zKS5zdWIocG9pbnRzW2ldKTsKCiAgICAgIC8vIElmIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZSBhbmQgdGhlIHBvaW50CiAgICAgIC8vIGlzIGJpZ2dlciB0aGFuIHRoZSByYWRpdXMsIHRoZSBwb2x5Z29uIGlzIGRlZmluaXRlbHkgbm90IGZ1bGx5IGluCiAgICAgIC8vIHRoZSBjaXJjbGUuCiAgICAgIGlmIChyZXNwb25zZSAmJiBwb2ludC5sZW4yKCkgPiByYWRpdXMyKSB7CiAgICAgICAgcmVzcG9uc2VbJ2FJbkInXSA9IGZhbHNlOwogICAgICB9CgogICAgICAvLyBDYWxjdWxhdGUgd2hpY2ggVm9ybm9pIHJlZ2lvbiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUgaXMgaW4uCiAgICAgIHZhciByZWdpb24gPSB2b3Jub2lSZWdpb24oZWRnZSwgcG9pbnQpOwogICAgICAvLyBJZiBpdCdzIHRoZSBsZWZ0IHJlZ2lvbjoKICAgICAgaWYgKHJlZ2lvbiA9PT0gTEVGVF9WT1JOT0lfUkVHSU9OKSB7CiAgICAgICAgLy8gV2UgbmVlZCB0byBtYWtlIHN1cmUgd2UncmUgaW4gdGhlIFJJR0hUX1ZPUk5PSV9SRUdJT04gb2YgdGhlIHByZXZpb3VzIGVkZ2UuCiAgICAgICAgZWRnZS5jb3B5KHBvbHlnb25bJ2VkZ2VzJ11bcHJldl0pOwogICAgICAgIC8vIENhbGN1bGF0ZSB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUgcmVsYXRpdmUgdGhlIHN0YXJ0aW5nIHBvaW50IG9mIHRoZSBwcmV2aW91cyBlZGdlCiAgICAgICAgdmFyIHBvaW50MiA9IFRfVkVDVE9SUy5wb3AoKS5jb3B5KGNpcmNsZVBvcykuc3ViKHBvaW50c1twcmV2XSk7CiAgICAgICAgcmVnaW9uID0gdm9ybm9pUmVnaW9uKGVkZ2UsIHBvaW50Mik7CiAgICAgICAgaWYgKHJlZ2lvbiA9PT0gUklHSFRfVk9STk9JX1JFR0lPTikgewogICAgICAgICAgLy8gSXQncyBpbiB0aGUgcmVnaW9uIHdlIHdhbnQuICBDaGVjayBpZiB0aGUgY2lyY2xlIGludGVyc2VjdHMgdGhlIHBvaW50LgogICAgICAgICAgdmFyIGRpc3QgPSBwb2ludC5sZW4oKTsKICAgICAgICAgIGlmIChkaXN0ID4gcmFkaXVzKSB7CiAgICAgICAgICAgIC8vIE5vIGludGVyc2VjdGlvbgogICAgICAgICAgICBUX1ZFQ1RPUlMucHVzaChjaXJjbGVQb3MpOwogICAgICAgICAgICBUX1ZFQ1RPUlMucHVzaChlZGdlKTsKICAgICAgICAgICAgVF9WRUNUT1JTLnB1c2gocG9pbnQpOwogICAgICAgICAgICBUX1ZFQ1RPUlMucHVzaChwb2ludDIpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIC8vIEl0IGludGVyc2VjdHMsIGNhbGN1bGF0ZSB0aGUgb3ZlcmxhcC4KICAgICAgICAgICAgcmVzcG9uc2VbJ2JJbkEnXSA9IGZhbHNlOwogICAgICAgICAgICBvdmVybGFwTiA9IHBvaW50Lm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBvdmVybGFwID0gcmFkaXVzIC0gZGlzdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgVF9WRUNUT1JTLnB1c2gocG9pbnQyKTsKICAgICAgLy8gSWYgaXQncyB0aGUgcmlnaHQgcmVnaW9uOgogICAgICB9IGVsc2UgaWYgKHJlZ2lvbiA9PT0gUklHSFRfVk9STk9JX1JFR0lPTikgewogICAgICAgIC8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHdlJ3JlIGluIHRoZSBsZWZ0IHJlZ2lvbiBvbiB0aGUgbmV4dCBlZGdlCiAgICAgICAgZWRnZS5jb3B5KHBvbHlnb25bJ2VkZ2VzJ11bbmV4dF0pOwogICAgICAgIC8vIENhbGN1bGF0ZSB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUgcmVsYXRpdmUgdG8gdGhlIHN0YXJ0aW5nIHBvaW50IG9mIHRoZSBuZXh0IGVkZ2UuCiAgICAgICAgcG9pbnQuY29weShjaXJjbGVQb3MpLnN1Yihwb2ludHNbbmV4dF0pOwogICAgICAgIHJlZ2lvbiA9IHZvcm5vaVJlZ2lvbihlZGdlLCBwb2ludCk7CiAgICAgICAgaWYgKHJlZ2lvbiA9PT0gTEVGVF9WT1JOT0lfUkVHSU9OKSB7CiAgICAgICAgICAvLyBJdCdzIGluIHRoZSByZWdpb24gd2Ugd2FudC4gIENoZWNrIGlmIHRoZSBjaXJjbGUgaW50ZXJzZWN0cyB0aGUgcG9pbnQuCiAgICAgICAgICB2YXIgZGlzdCA9IHBvaW50LmxlbigpOwogICAgICAgICAgaWYgKGRpc3QgPiByYWRpdXMpIHsKICAgICAgICAgICAgLy8gTm8gaW50ZXJzZWN0aW9uCiAgICAgICAgICAgIFRfVkVDVE9SUy5wdXNoKGNpcmNsZVBvcyk7CiAgICAgICAgICAgIFRfVkVDVE9SUy5wdXNoKGVkZ2UpOwogICAgICAgICAgICBUX1ZFQ1RPUlMucHVzaChwb2ludCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgLy8gSXQgaW50ZXJzZWN0cywgY2FsY3VsYXRlIHRoZSBvdmVybGFwLgogICAgICAgICAgICByZXNwb25zZVsnYkluQSddID0gZmFsc2U7CiAgICAgICAgICAgIG92ZXJsYXBOID0gcG9pbnQubm9ybWFsaXplKCk7CiAgICAgICAgICAgIG92ZXJsYXAgPSByYWRpdXMgLSBkaXN0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgLy8gT3RoZXJ3aXNlLCBpdCdzIHRoZSBtaWRkbGUgcmVnaW9uOgogICAgICB9IGVsc2UgewogICAgICAgIC8vIE5lZWQgdG8gY2hlY2sgaWYgdGhlIGNpcmNsZSBpcyBpbnRlcnNlY3RpbmcgdGhlIGVkZ2UsCiAgICAgICAgLy8gQ2hhbmdlIHRoZSBlZGdlIGludG8gaXRzICJlZGdlIG5vcm1hbCIuCiAgICAgICAgdmFyIG5vcm1hbCA9IGVkZ2UucGVycCgpLm5vcm1hbGl6ZSgpOwogICAgICAgIC8vIEZpbmQgdGhlIHBlcnBlbmRpY3VsYXIgZGlzdGFuY2UgYmV0d2VlbiB0aGUgY2VudGVyIG9mIHRoZQogICAgICAgIC8vIGNpcmNsZSBhbmQgdGhlIGVkZ2UuCiAgICAgICAgdmFyIGRpc3QgPSBwb2ludC5kb3Qobm9ybWFsKTsKICAgICAgICB2YXIgZGlzdEFicyA9IE1hdGguYWJzKGRpc3QpOwogICAgICAgIC8vIElmIHRoZSBjaXJjbGUgaXMgb24gdGhlIG91dHNpZGUgb2YgdGhlIGVkZ2UsIHRoZXJlIGlzIG5vIGludGVyc2VjdGlvbi4KICAgICAgICBpZiAoZGlzdCA+IDAgJiYgZGlzdEFicyA+IHJhZGl1cykgewogICAgICAgICAgLy8gTm8gaW50ZXJzZWN0aW9uCiAgICAgICAgICBUX1ZFQ1RPUlMucHVzaChjaXJjbGVQb3MpOwogICAgICAgICAgVF9WRUNUT1JTLnB1c2gobm9ybWFsKTsKICAgICAgICAgIFRfVkVDVE9SUy5wdXNoKHBvaW50KTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlKSB7CiAgICAgICAgICAvLyBJdCBpbnRlcnNlY3RzLCBjYWxjdWxhdGUgdGhlIG92ZXJsYXAuCiAgICAgICAgICBvdmVybGFwTiA9IG5vcm1hbDsKICAgICAgICAgIG92ZXJsYXAgPSByYWRpdXMgLSBkaXN0OwogICAgICAgICAgLy8gSWYgdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlIGlzIG9uIHRoZSBvdXRzaWRlIG9mIHRoZSBlZGdlLCBvciBwYXJ0IG9mIHRoZQogICAgICAgICAgLy8gY2lyY2xlIGlzIG9uIHRoZSBvdXRzaWRlLCB0aGUgY2lyY2xlIGlzIG5vdCBmdWxseSBpbnNpZGUgdGhlIHBvbHlnb24uCiAgICAgICAgICBpZiAoZGlzdCA+PSAwIHx8IG92ZXJsYXAgPCAyICogcmFkaXVzKSB7CiAgICAgICAgICAgIHJlc3BvbnNlWydiSW5BJ10gPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIElmIHRoaXMgaXMgdGhlIHNtYWxsZXN0IG92ZXJsYXAgd2UndmUgc2Vlbiwga2VlcCBpdC4KICAgICAgLy8gKG92ZXJsYXBOIG1heSBiZSBudWxsIGlmIHRoZSBjaXJjbGUgd2FzIGluIHRoZSB3cm9uZyBWb3Jub2kgcmVnaW9uKS4KICAgICAgaWYgKG92ZXJsYXBOICYmIHJlc3BvbnNlICYmIE1hdGguYWJzKG92ZXJsYXApIDwgTWF0aC5hYnMocmVzcG9uc2VbJ292ZXJsYXAnXSkpIHsKICAgICAgICByZXNwb25zZVsnb3ZlcmxhcCddID0gb3ZlcmxhcDsKICAgICAgICByZXNwb25zZVsnb3ZlcmxhcE4nXS5jb3B5KG92ZXJsYXBOKTsKICAgICAgfQogICAgfQoKICAgIC8vIENhbGN1bGF0ZSB0aGUgZmluYWwgb3ZlcmxhcCB2ZWN0b3IgLSBiYXNlZCBvbiB0aGUgc21hbGxlc3Qgb3ZlcmxhcC4KICAgIGlmIChyZXNwb25zZSkgewogICAgICByZXNwb25zZVsnYSddID0gcG9seWdvbjsKICAgICAgcmVzcG9uc2VbJ2InXSA9IGNpcmNsZTsKICAgICAgcmVzcG9uc2VbJ292ZXJsYXBWJ10uY29weShyZXNwb25zZVsnb3ZlcmxhcE4nXSkuc2NhbGUocmVzcG9uc2VbJ292ZXJsYXAnXSk7CiAgICB9CiAgICBUX1ZFQ1RPUlMucHVzaChjaXJjbGVQb3MpOwogICAgVF9WRUNUT1JTLnB1c2goZWRnZSk7CiAgICBUX1ZFQ1RPUlMucHVzaChwb2ludCk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgU0FUWyd0ZXN0UG9seWdvbkNpcmNsZSddID0gdGVzdFBvbHlnb25DaXJjbGU7CgogIC8vIENoZWNrIGlmIGEgY2lyY2xlIGFuZCBhIHBvbHlnb24gY29sbGlkZS4KICAvLwogIC8vICoqTk9URToqKiBUaGlzIGlzIHNsaWdodGx5IGxlc3MgZWZmaWNpZW50IHRoYW4gcG9seWdvbkNpcmNsZSBhcyBpdCBqdXN0CiAgLy8gcnVucyBwb2x5Z29uQ2lyY2xlIGFuZCByZXZlcnNlcyBldmVyeXRoaW5nIGF0IHRoZSBlbmQuCiAgLyoqCiAgICogQHBhcmFtIHtDaXJjbGV9IGNpcmNsZSBUaGUgY2lyY2xlLgogICAqIEBwYXJhbSB7UG9seWdvbn0gcG9seWdvbiBUaGUgcG9seWdvbi4KICAgKiBAcGFyYW0ge1Jlc3BvbnNlPX0gcmVzcG9uc2UgUmVzcG9uc2Ugb2JqZWN0IChvcHRpb25hbCkgdGhhdCB3aWxsIGJlIHBvcHVsYXRlZCBpZgogICAqICAgdGhleSBpbnRlcnNldC4KICAgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHRoZXkgaW50ZXJzZWN0LCBmYWxzZSBpZiB0aGV5IGRvbid0LgogICAqLwogIGZ1bmN0aW9uIHRlc3RDaXJjbGVQb2x5Z29uKGNpcmNsZSwgcG9seWdvbiwgcmVzcG9uc2UpIHsKICAgIC8vIFRlc3QgdGhlIHBvbHlnb24gYWdhaW5zdCB0aGUgY2lyY2xlLgogICAgdmFyIHJlc3VsdCA9IHRlc3RQb2x5Z29uQ2lyY2xlKHBvbHlnb24sIGNpcmNsZSwgcmVzcG9uc2UpOwogICAgaWYgKHJlc3VsdCAmJiByZXNwb25zZSkgewogICAgICAvLyBTd2FwIEEgYW5kIEIgaW4gdGhlIHJlc3BvbnNlLgogICAgICB2YXIgYSA9IHJlc3BvbnNlWydhJ107CiAgICAgIHZhciBhSW5CID0gcmVzcG9uc2VbJ2FJbkInXTsKICAgICAgcmVzcG9uc2VbJ292ZXJsYXBOJ10ucmV2ZXJzZSgpOwogICAgICByZXNwb25zZVsnb3ZlcmxhcFYnXS5yZXZlcnNlKCk7CiAgICAgIHJlc3BvbnNlWydhJ10gPSByZXNwb25zZVsnYiddOwogICAgICByZXNwb25zZVsnYiddID0gYTsKICAgICAgcmVzcG9uc2VbJ2FJbkInXSA9IHJlc3BvbnNlWydiSW5BJ107CiAgICAgIHJlc3BvbnNlWydiSW5BJ10gPSBhSW5COwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgU0FUWyd0ZXN0Q2lyY2xlUG9seWdvbiddID0gdGVzdENpcmNsZVBvbHlnb247CgogIC8vIENoZWNrcyB3aGV0aGVyIHBvbHlnb25zIGNvbGxpZGUuCiAgLyoqCiAgICogQHBhcmFtIHtQb2x5Z29ufSBhIFRoZSBmaXJzdCBwb2x5Z29uLgogICAqIEBwYXJhbSB7UG9seWdvbn0gYiBUaGUgc2Vjb25kIHBvbHlnb24uCiAgICogQHBhcmFtIHtSZXNwb25zZT19IHJlc3BvbnNlIFJlc3BvbnNlIG9iamVjdCAob3B0aW9uYWwpIHRoYXQgd2lsbCBiZSBwb3B1bGF0ZWQgaWYKICAgKiAgIHRoZXkgaW50ZXJzZXQuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiB0aGV5IGludGVyc2VjdCwgZmFsc2UgaWYgdGhleSBkb24ndC4KICAgKi8KICBmdW5jdGlvbiB0ZXN0UG9seWdvblBvbHlnb24oYSwgYiwgcmVzcG9uc2UpIHsKICAgIHZhciBhUG9pbnRzID0gYVsncG9pbnRzJ107CiAgICB2YXIgYUxlbiA9IGFQb2ludHMubGVuZ3RoOwogICAgdmFyIGJQb2ludHMgPSBiWydwb2ludHMnXTsKICAgIHZhciBiTGVuID0gYlBvaW50cy5sZW5ndGg7CiAgICAvLyBJZiBhbnkgb2YgdGhlIGVkZ2Ugbm9ybWFscyBvZiBBIGlzIGEgc2VwYXJhdGluZyBheGlzLCBubyBpbnRlcnNlY3Rpb24uCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFMZW47IGkrKykgewogICAgICBpZiAoaXNTZXBhcmF0aW5nQXhpcyhhWydwb3MnXSwgYlsncG9zJ10sIGFQb2ludHMsIGJQb2ludHMsIGFbJ25vcm1hbHMnXVtpXSwgcmVzcG9uc2UpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICAvLyBJZiBhbnkgb2YgdGhlIGVkZ2Ugbm9ybWFscyBvZiBCIGlzIGEgc2VwYXJhdGluZyBheGlzLCBubyBpbnRlcnNlY3Rpb24uCiAgICBmb3IgKHZhciBpID0gMDtpIDwgYkxlbjsgaSsrKSB7CiAgICAgIGlmIChpc1NlcGFyYXRpbmdBeGlzKGFbJ3BvcyddLCBiWydwb3MnXSwgYVBvaW50cywgYlBvaW50cywgYlsnbm9ybWFscyddW2ldLCByZXNwb25zZSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIC8vIFNpbmNlIG5vbmUgb2YgdGhlIGVkZ2Ugbm9ybWFscyBvZiBBIG9yIEIgYXJlIGEgc2VwYXJhdGluZyBheGlzLCB0aGVyZSBpcyBhbiBpbnRlcnNlY3Rpb24KICAgIC8vIGFuZCB3ZSd2ZSBhbHJlYWR5IGNhbGN1bGF0ZWQgdGhlIHNtYWxsZXN0IG92ZXJsYXAgKGluIGlzU2VwYXJhdGluZ0F4aXMpLiAgQ2FsY3VsYXRlIHRoZQogICAgLy8gZmluYWwgb3ZlcmxhcCB2ZWN0b3IuCiAgICBpZiAocmVzcG9uc2UpIHsKICAgICAgcmVzcG9uc2VbJ2EnXSA9IGE7CiAgICAgIHJlc3BvbnNlWydiJ10gPSBiOwogICAgICByZXNwb25zZVsnb3ZlcmxhcFYnXS5jb3B5KHJlc3BvbnNlWydvdmVybGFwTiddKS5zY2FsZShyZXNwb25zZVsnb3ZlcmxhcCddKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICBTQVRbJ3Rlc3RQb2x5Z29uUG9seWdvbiddID0gdGVzdFBvbHlnb25Qb2x5Z29uOwoKICByZXR1cm4gU0FUOwp9KSgpOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQGNsYXNzIFBoYXNlci5QaHlzaWNzCiovClBoYXNlci5QaHlzaWNzID0ge307CgovKioKKiBBcmNhZGUgUGh5c2ljcyBjb25zdHJ1Y3Rvci4KKgoqIEBjbGFzcyBQaGFzZXIuUGh5c2ljcy5BcmNhZGUKKiBAY2xhc3NkZXNjIEFyY2FkZSBQaHlzaWNzIENvbnN0cnVjdG9yCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKi8KUGhhc2VyLlBoeXNpY3MuQXJjYWRlID0gZnVuY3Rpb24gKGdhbWUpIHsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBMb2NhbCByZWZlcmVuY2UgdG8gZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gZ3Jhdml0eSAtIFRoZSBXb3JsZCBncmF2aXR5IHNldHRpbmcuIERlZmF1bHRzIHRvIHg6IDAsIHk6IDAsIG9yIG5vIGdyYXZpdHkuCiAgICAqLwogICAgdGhpcy5ncmF2aXR5ID0gbmV3IFBoYXNlci5Qb2ludCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1NBVC5Cb3h9IHdvcmxkTGVmdCAtIFRoZSBsZWZ0IGhhbmQgc2lkZSBvZiB0aGUgcGh5c2ljcyBib3VuZHMuCiAgICAqLwogICAgdGhpcy53b3JsZExlZnQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1NBVC5Cb3h9IHdvcmxkUmlnaHQgLSBUaGUgcmlnaHQgaGFuZCBzaWRlIG9mIHRoZSBwaHlzaWNzIGJvdW5kcy4KICAgICovCiAgICB0aGlzLndvcmxkUmlnaHQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1NBVC5Cb3h9IHdvcmxkVG9wIC0gVGhlIHRvcCBzaWRlIG9mIHRoZSBwaHlzaWNzIGJvdW5kcy4KICAgICovCiAgICB0aGlzLndvcmxkVG9wID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtTQVQuQm94fSB3b3JsZEJvdHRvbSAtIFRoZSBib3R0b20gb2YgdGhlIHBoeXNpY3MgYm91bmRzLgogICAgKi8KICAgIHRoaXMud29ybGRCb3R0b20gPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5PFNBVC5Qb2x5Z29uPn0gd29ybGRQb2x5cyAtIEFuIGFycmF5IG9mIHRoZSBwb2x5Z29uIGRhdGEgZnJvbSB0aGUgcGh5c2ljcyBib3VuZHMuCiAgICAqLwogICAgdGhpcy53b3JsZFBvbHlzID0gWyBudWxsLCBudWxsLCBudWxsLCBudWxsIF07CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlF1YWRUcmVlfSBxdWFkVHJlZSAtIFRoZSB3b3JsZCBRdWFkVHJlZS4KICAgICovCiAgICB0aGlzLnF1YWRUcmVlID0gbmV3IFBoYXNlci5RdWFkVHJlZSh0aGlzLmdhbWUud29ybGQuYm91bmRzLngsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMueSwgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy53aWR0aCwgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy5oZWlnaHQsIHRoaXMubWF4T2JqZWN0cywgdGhpcy5tYXhMZXZlbHMpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4T2JqZWN0cyAtIFVzZWQgYnkgdGhlIFF1YWRUcmVlIHRvIHNldCB0aGUgbWF4aW11bSBudW1iZXIgb2Ygb2JqZWN0cyBwZXIgcXVhZC4KICAgICovCiAgICB0aGlzLm1heE9iamVjdHMgPSAxMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heExldmVscyAtIFVzZWQgYnkgdGhlIFF1YWRUcmVlIHRvIHNldCB0aGUgbWF4aW11bSBudW1iZXIgb2YgaXRlcmF0aW9uIGxldmVscy4KICAgICovCiAgICB0aGlzLm1heExldmVscyA9IDQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7QXJyYXl9IF9tYXBEYXRhIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX21hcERhdGEgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9tYXBUaWxlcyAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9tYXBUaWxlcyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX3Jlc3VsdCAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9yZXN1bHQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF90b3RhbCAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90b3RhbCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfYW5nbGUgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fYW5nbGUgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2RyYWcgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZHJhZyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZHggLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZHggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R5IC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2R5ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IF9wIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3AgPSBuZXcgUGhhc2VyLlBvaW50KDAsIDApOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2ludGVyc2VjdGlvbiAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9pbnRlcnNlY3Rpb24gPSBbMCwwLDAsMF07CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZ3Jhdml0eVggLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZ3Jhdml0eVggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2dyYXZpdHlZIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2dyYXZpdHlZID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtTQVQuUmVzcG9uc2V9IF9yZXNwb25zZSAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9yZXNwb25zZSA9IG5ldyBTQVQuUmVzcG9uc2UoKTsKCiAgICAvLyAgU2V0IHRoZSBib3VuZHMgdG8gdGhlIHdvcmxkIGFzIGRlZmF1bHQKICAgIHRoaXMuc2V0Qm91bmRzVG9Xb3JsZCh0cnVlLCB0cnVlLCB0cnVlLCB0cnVlKTsKCn07CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuUGh5c2ljcy5BcmNhZGUuUkVDVCA9IDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQ0lSQ0xFID0gMTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5QaHlzaWNzLkFyY2FkZS5QT0xZR09OID0gMjsKClBoYXNlci5QaHlzaWNzLkFyY2FkZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIENoZWNrcyB0aGUgZ2l2ZW4gUGh5c2ljcy5Cb2R5IGFnYWluc3QgdGhlIFBoeXNpY3MgQm91bmRzLCBpZiBhbnkgYXJlIHNldCwgYW5kIHNlcGFyYXRlcyB0aGVtLCBzZXR0aW5nIHRoZSBibG9ja2VkIGZsYWdzIG9uIHRoZSBCb2R5IGFzIGl0IGRvZXMgc28uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NoZWNrQm91bmRzCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IFRoZSBCb2R5IG9iamVjdCB0byBiZSBjaGVja2VkLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBib2R5IGhpdCB0aGUgYm91bmRzLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgY2hlY2tCb3VuZHM6IGZ1bmN0aW9uIChib2R5KSB7CgogICAgICAgIGlmICghYm9keS5jb2xsaWRlV29ybGRCb3VuZHMgfHwgKCF0aGlzLndvcmxkTGVmdCAmJiAhdGhpcy53b3JsZFJpZ2h0ICYmICF0aGlzLndvcmxkVG9wICYmICF0aGlzLndvcmxkQm90dG9tKSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3Jlc3BvbnNlLmNsZWFyKCk7CgogICAgICAgIHZhciB0ZXN0ID0gU0FULnRlc3RQb2x5Z29uUG9seWdvbjsKICAgICAgICB2YXIgcGFydCA9IGJvZHkucG9seWdvbjsKICAgICAgICB2YXIgcmVib3VuZGVkID0gZmFsc2U7CgogICAgICAgIGlmIChib2R5LnR5cGUgPT09IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5DSVJDTEUpCiAgICAgICAgewogICAgICAgICAgICB0ZXN0ID0gU0FULnRlc3RQb2x5Z29uQ2lyY2xlOwogICAgICAgICAgICBwYXJ0ID0gYm9keS5zaGFwZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLndvcmxkTGVmdCAmJiB0ZXN0KHRoaXMud29ybGRQb2x5c1swXSwgcGFydCwgdGhpcy5fcmVzcG9uc2UpKQogICAgICAgIHsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLmxlZnQgPSB0cnVlOwogICAgICAgICAgICBwYXJ0LnBvcy5hZGQodGhpcy5fcmVzcG9uc2Uub3ZlcmxhcFYpOwogICAgICAgICAgICBib2R5LmJsb2NrZWQueCA9IE1hdGguZmxvb3IoYm9keS54KTsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnkgPSBNYXRoLmZsb29yKGJvZHkueSk7CiAgICAgICAgICAgIHJlYm91bmRlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMud29ybGRSaWdodCAmJiB0ZXN0KHRoaXMud29ybGRQb2x5c1sxXSwgcGFydCwgdGhpcy5fcmVzcG9uc2UpKQogICAgICAgIHsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnJpZ2h0ID0gdHJ1ZTsKICAgICAgICAgICAgcGFydC5wb3MuYWRkKHRoaXMuX3Jlc3BvbnNlLm92ZXJsYXBWKTsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnggPSBNYXRoLmZsb29yKGJvZHkueCk7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC55ID0gTWF0aC5mbG9vcihib2R5LnkpOwogICAgICAgICAgICByZWJvdW5kZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fcmVzcG9uc2UuY2xlYXIoKTsKCiAgICAgICAgaWYgKHRoaXMud29ybGRUb3AgJiYgdGVzdCh0aGlzLndvcmxkUG9seXNbMl0sIHBhcnQsIHRoaXMuX3Jlc3BvbnNlKSkKICAgICAgICB7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC51cCA9IHRydWU7CiAgICAgICAgICAgIHBhcnQucG9zLmFkZCh0aGlzLl9yZXNwb25zZS5vdmVybGFwVik7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC54ID0gTWF0aC5mbG9vcihib2R5LngpOwogICAgICAgICAgICBib2R5LmJsb2NrZWQueSA9IE1hdGguZmxvb3IoYm9keS55KTsKICAgICAgICAgICAgcmVib3VuZGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy53b3JsZEJvdHRvbSAmJiB0ZXN0KHRoaXMud29ybGRQb2x5c1szXSwgcGFydCwgdGhpcy5fcmVzcG9uc2UpKQogICAgICAgIHsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLmRvd24gPSB0cnVlOwogICAgICAgICAgICBwYXJ0LnBvcy5hZGQodGhpcy5fcmVzcG9uc2Uub3ZlcmxhcFYpOwogICAgICAgICAgICBib2R5LmJsb2NrZWQueCA9IE1hdGguZmxvb3IoYm9keS54KTsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnkgPSBNYXRoLmZsb29yKGJvZHkueSk7CiAgICAgICAgICAgIHJlYm91bmRlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVib3VuZGVkOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGJvdW5kcyBvZiB0aGUgUGh5c2ljcyB3b3JsZCB0byBtYXRjaCB0aGUgR2FtZS5Xb3JsZC4KICAgICogWW91IGNhbiBvcHRpb25hbGx5IHNldCB3aGljaCAnd2FsbHMnIHRvIGNyZWF0ZTogbGVmdCwgcmlnaHQsIHRvcCBvciBib3R0b20uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3NldEJvdW5kc1RvV29ybGQKICAgICogQHBhcmFtIHtib29sZWFufSBbbGVmdD10cnVlXSAtIElmIHRydWUgd2lsbCBjcmVhdGUgdGhlIGxlZnQgYm91bmRzIHdhbGwuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3JpZ2h0PXRydWVdIC0gSWYgdHJ1ZSB3aWxsIGNyZWF0ZSB0aGUgcmlnaHQgYm91bmRzIHdhbGwuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3RvcD10cnVlXSAtIElmIHRydWUgd2lsbCBjcmVhdGUgdGhlIHRvcCBib3VuZHMgd2FsbC4KICAgICogQHBhcmFtIHtib29sZWFufSBbYm90dG9tPXRydWVdIC0gSWYgdHJ1ZSB3aWxsIGNyZWF0ZSB0aGUgYm90dG9tIGJvdW5kcyB3YWxsLgogICAgKi8KICAgIHNldEJvdW5kc1RvV29ybGQ6IGZ1bmN0aW9uIChsZWZ0LCByaWdodCwgdG9wLCBib3R0b20pIHsKCiAgICAgICAgdGhpcy5zZXRCb3VuZHModGhpcy5nYW1lLndvcmxkLmJvdW5kcy54LCB0aGlzLmdhbWUud29ybGQuYm91bmRzLnksIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMud2lkdGgsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMuaGVpZ2h0LCBsZWZ0LCByaWdodCwgdG9wLCBib3R0b20pOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGJvdW5kcyBvZiB0aGUgUGh5c2ljcyB3b3JsZCB0byBtYXRjaCB0aGUgZ2l2ZW4gd29ybGQgcGl4ZWwgZGltZW5zaW9ucy4KICAgICogWW91IGNhbiBvcHRpb25hbGx5IHNldCB3aGljaCAnd2FsbHMnIHRvIGNyZWF0ZTogbGVmdCwgcmlnaHQsIHRvcCBvciBib3R0b20uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3NldEJvdW5kcwogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgYm91bmRzLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgYm91bmRzLgogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIGJvdW5kcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIGJvdW5kcy4KICAgICogQHBhcmFtIHtib29sZWFufSBbbGVmdD10cnVlXSAtIElmIHRydWUgd2lsbCBjcmVhdGUgdGhlIGxlZnQgYm91bmRzIHdhbGwuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3JpZ2h0PXRydWVdIC0gSWYgdHJ1ZSB3aWxsIGNyZWF0ZSB0aGUgcmlnaHQgYm91bmRzIHdhbGwuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3RvcD10cnVlXSAtIElmIHRydWUgd2lsbCBjcmVhdGUgdGhlIHRvcCBib3VuZHMgd2FsbC4KICAgICogQHBhcmFtIHtib29sZWFufSBbYm90dG9tPXRydWVdIC0gSWYgdHJ1ZSB3aWxsIGNyZWF0ZSB0aGUgYm90dG9tIGJvdW5kcyB3YWxsLgogICAgKi8KICAgIHNldEJvdW5kczogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQsIGxlZnQsIHJpZ2h0LCB0b3AsIGJvdHRvbSkgewoKICAgICAgICBpZiAodHlwZW9mIGxlZnQgPT09ICd1bmRlZmluZWQnKSB7IGxlZnQgPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiByaWdodCA9PT0gJ3VuZGVmaW5lZCcpIHsgcmlnaHQgPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiB0b3AgPT09ICd1bmRlZmluZWQnKSB7IHRvcCA9IHRydWU7IH0KICAgICAgICBpZiAodHlwZW9mIGJvdHRvbSA9PT0gJ3VuZGVmaW5lZCcpIHsgYm90dG9tID0gdHJ1ZTsgfQoKICAgICAgICB2YXIgdGhpY2tuZXNzID0gMTAwOwoKICAgICAgICBpZiAobGVmdCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud29ybGRMZWZ0ID0gbmV3IFNBVC5Cb3gobmV3IFNBVC5WZWN0b3IoeCAtIHRoaWNrbmVzcywgeSksIHRoaWNrbmVzcywgaGVpZ2h0KTsKICAgICAgICAgICAgdGhpcy53b3JsZFBvbHlzWzBdID0gdGhpcy53b3JsZExlZnQudG9Qb2x5Z29uKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud29ybGRMZWZ0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy53b3JsZFBvbHlzWzBdID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChyaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud29ybGRSaWdodCA9IG5ldyBTQVQuQm94KG5ldyBTQVQuVmVjdG9yKHggKyB3aWR0aCwgeSksIHRoaWNrbmVzcywgaGVpZ2h0KTsKICAgICAgICAgICAgdGhpcy53b3JsZFBvbHlzWzFdID0gdGhpcy53b3JsZFJpZ2h0LnRvUG9seWdvbigpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndvcmxkUmlnaHQgPSBudWxsOwogICAgICAgICAgICB0aGlzLndvcmxkUG9seXNbMV0gPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRvcCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud29ybGRUb3AgPSBuZXcgU0FULkJveChuZXcgU0FULlZlY3Rvcih4LCB5IC0gdGhpY2tuZXNzKSwgd2lkdGgsIHRoaWNrbmVzcyk7CiAgICAgICAgICAgIHRoaXMud29ybGRQb2x5c1syXSA9IHRoaXMud29ybGRUb3AudG9Qb2x5Z29uKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud29ybGRUb3AgPSBudWxsOwogICAgICAgICAgICB0aGlzLndvcmxkUG9seXNbMl0gPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKGJvdHRvbSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud29ybGRCb3R0b20gPSBuZXcgU0FULkJveChuZXcgU0FULlZlY3Rvcih4LCB5ICsgaGVpZ2h0KSwgd2lkdGgsIHRoaWNrbmVzcyk7CiAgICAgICAgICAgIHRoaXMud29ybGRQb2x5c1szXSA9IHRoaXMud29ybGRCb3R0b20udG9Qb2x5Z29uKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud29ybGRCb3R0b20gPSBudWxsOwogICAgICAgICAgICB0aGlzLndvcmxkUG9seXNbM10gPSBudWxsOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgYXV0b21hdGljYWxseSBieSBhIFBoeXNpY3MgYm9keSwgaXQgdXBkYXRlcyBhbGwgbW90aW9uIHJlbGF0ZWQgdmFsdWVzIG9uIHRoZSBCb2R5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSN1cGRhdGVNb3Rpb24KICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gVGhlIEJvZHkgb2JqZWN0IHRvIGJlIHVwZGF0ZWQuCiAgICAqLwogICAgdXBkYXRlTW90aW9uOiBmdW5jdGlvbiAoYm9keSkgewoKICAgICAgICAvLyAgSWYgeW91J3JlIHdvbmRlcmluZyB3aHkgdGhlIHZlbG9jaXR5IGlzIGhhbHZlZCBhbmQgYXBwbGllZCB0d2ljZSwgcmVhZCB0aGlzOiBodHRwOi8vd3d3Lm5pa3N1bGEuaHV0LmZpL35oa2Fua2Fhbi9Ib21lcGFnZXMvZ3Jhdml0eS5odG1sCgogICAgICAgIC8vICBXb3JsZCBncmF2aXR5IGlzIGFsbG93ZWQKICAgICAgICBpZiAoYm9keS5hbGxvd0dyYXZpdHkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9ncmF2aXR5WCA9IHRoaXMuZ3Jhdml0eS54ICsgYm9keS5ncmF2aXR5Lng7CiAgICAgICAgICAgIHRoaXMuX2dyYXZpdHlZID0gdGhpcy5ncmF2aXR5LnkgKyBib2R5LmdyYXZpdHkueTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZ3Jhdml0eVggPSBib2R5LmdyYXZpdHkueDsKICAgICAgICAgICAgdGhpcy5fZ3Jhdml0eVkgPSBib2R5LmdyYXZpdHkueTsKICAgICAgICB9CgogICAgICAgIC8vICBEb24ndCBhcHBseSBncmF2aXR5IHRvIGFueSBib2R5IHRoYXQgaXMgYmxvY2tlZAogICAgICAgIGlmICgodGhpcy5fZ3Jhdml0eVggPCAwICYmIGJvZHkuYmxvY2tlZC5sZWZ0KSB8fCAodGhpcy5fZ3Jhdml0eVggPiAwICYmIGJvZHkuYmxvY2tlZC5yaWdodCkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9ncmF2aXR5WCA9IDA7CiAgICAgICAgfQoKICAgICAgICBpZiAoKHRoaXMuX2dyYXZpdHlZIDwgMCAmJiBib2R5LmJsb2NrZWQudXApIHx8ICh0aGlzLl9ncmF2aXR5WSA+IDAgJiYgYm9keS5ibG9ja2VkLmRvd24pKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZ3Jhdml0eVkgPSAwOwogICAgICAgIH0KCiAgICAgICAgLy8gIFJvdGF0aW9uCiAgICAgICAgaWYgKGJvZHkuYWxsb3dSb3RhdGlvbikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3ZlbG9jaXR5RGVsdGEgPSBib2R5LmFuZ3VsYXJBY2NlbGVyYXRpb24gKiB0aGlzLmdhbWUudGltZS5waHlzaWNzRWxhcHNlZDsKCiAgICAgICAgICAgIGlmIChib2R5LmFuZ3VsYXJEcmFnICE9PSAwICYmIGJvZHkuYW5ndWxhckFjY2VsZXJhdGlvbiA9PT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fZHJhZyA9IGJvZHkuYW5ndWxhckRyYWcgKiB0aGlzLmdhbWUudGltZS5waHlzaWNzRWxhcHNlZDsKCiAgICAgICAgICAgICAgICBpZiAoYm9keS5hbmd1bGFyVmVsb2NpdHkgPiAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkuYW5ndWxhclZlbG9jaXR5IC09IHRoaXMuX2RyYWc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChib2R5LmFuZ3VsYXJWZWxvY2l0eSA8IDApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYm9keS5hbmd1bGFyVmVsb2NpdHkgKz0gdGhpcy5fZHJhZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgYm9keS5yb3RhdGlvbiArPSB0aGlzLmdhbWUudGltZS5waHlzaWNzRWxhcHNlZCAqIChib2R5LmFuZ3VsYXJWZWxvY2l0eSArIHRoaXMuX3ZlbG9jaXR5RGVsdGEgLyAyKTsKICAgICAgICAgICAgYm9keS5hbmd1bGFyVmVsb2NpdHkgKz0gdGhpcy5fdmVsb2NpdHlEZWx0YTsKICAgIAogICAgICAgICAgICBpZiAoYm9keS5hbmd1bGFyVmVsb2NpdHkgPiBib2R5Lm1heEFuZ3VsYXIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJvZHkuYW5ndWxhclZlbG9jaXR5ID0gYm9keS5tYXhBbmd1bGFyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGJvZHkuYW5ndWxhclZlbG9jaXR5IDwgLWJvZHkubWF4QW5ndWxhcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYm9keS5hbmd1bGFyVmVsb2NpdHkgPSAtYm9keS5tYXhBbmd1bGFyOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyB0ZW1wID0gYWNjKmR0CiAgICAgICAgLy8gcG9zID0gcG9zICsgZHQqKHZlbCArIHRlbXAvMikKICAgICAgICAvLyB2ZWwgPSB2ZWwgKyB0ZW1wCgogICAgICAgIHRoaXMuX3Auc2V0VG8oKGJvZHkuYWNjZWxlcmF0aW9uLnggKyB0aGlzLl9ncmF2aXR5WCkgKiB0aGlzLmdhbWUudGltZS5waHlzaWNzRWxhcHNlZCwgKGJvZHkuYWNjZWxlcmF0aW9uLnkgKyB0aGlzLl9ncmF2aXR5WSkgKiB0aGlzLmdhbWUudGltZS5waHlzaWNzRWxhcHNlZCk7CgogICAgICAgIHJldHVybiB0aGlzLl9wOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrcyBmb3Igb3ZlcmxhcHMgYmV0d2VlbiB0d28gZ2FtZSBvYmplY3RzLiBUaGUgb2JqZWN0cyBjYW4gYmUgU3ByaXRlcywgR3JvdXBzIG9yIEVtaXR0ZXJzLgogICAgKiBZb3UgY2FuIHBlcmZvcm0gU3ByaXRlIHZzLiBTcHJpdGUsIFNwcml0ZSB2cy4gR3JvdXAgYW5kIEdyb3VwIHZzLiBHcm91cCBvdmVybGFwIGNoZWNrcy4KICAgICogVW5saWtlIGNvbGxpZGUgdGhlIG9iamVjdHMgYXJlIE5PVCBhdXRvbWF0aWNhbGx5IHNlcGFyYXRlZCBvciBoYXZlIGFueSBwaHlzaWNzIGFwcGxpZWQsIHRoZXkgbWVyZWx5IHRlc3QgZm9yIG92ZXJsYXAgcmVzdWx0cy4KICAgICogVGhlIHNlY29uZCBwYXJhbWV0ZXIgY2FuIGJlIGFuIGFycmF5IG9mIG9iamVjdHMsIG9mIGRpZmZlcmluZyB0eXBlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjb3ZlcmxhcAogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV8UGhhc2VyLkdyb3VwfFBoYXNlci5QYXJ0aWNsZXMuRW1pdHRlcn0gb2JqZWN0MSAtIFRoZSBmaXJzdCBvYmplY3QgdG8gY2hlY2suIENhbiBiZSBhbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuR3JvdXAgb3IgUGhhc2VyLlBhcnRpY2xlcy5FbWl0dGVyLgogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV8UGhhc2VyLkdyb3VwfFBoYXNlci5QYXJ0aWNsZXMuRW1pdHRlcnxhcnJheX0gb2JqZWN0MiAtIFRoZSBzZWNvbmQgb2JqZWN0IG9yIGFycmF5IG9mIG9iamVjdHMgdG8gY2hlY2suIENhbiBiZSBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuR3JvdXAgb3IgUGhhc2VyLlBhcnRpY2xlcy5FbWl0dGVyLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbb3ZlcmxhcENhbGxiYWNrPW51bGxdIC0gQW4gb3B0aW9uYWwgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgaWYgdGhlIG9iamVjdHMgb3ZlcmxhcC4gVGhlIHR3byBvYmplY3RzIHdpbGwgYmUgcGFzc2VkIHRvIHRoaXMgZnVuY3Rpb24gaW4gdGhlIHNhbWUgb3JkZXIgaW4gd2hpY2ggeW91IHNwZWNpZmllZCB0aGVtLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbcHJvY2Vzc0NhbGxiYWNrPW51bGxdIC0gQSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGxldHMgeW91IHBlcmZvcm0gYWRkaXRpb25hbCBjaGVja3MgYWdhaW5zdCB0aGUgdHdvIG9iamVjdHMgaWYgdGhleSBvdmVybGFwLiBJZiB0aGlzIGlzIHNldCB0aGVuIG92ZXJsYXBDYWxsYmFjayB3aWxsIG9ubHkgYmUgY2FsbGVkIGlmIHByb2Nlc3NDYWxsYmFjayByZXR1cm5zIHRydWUuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBbY2FsbGJhY2tDb250ZXh0XSAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRvIHJ1biB0aGUgY2FsbGJhY2tzLgogICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBhbiBvdmVybGFwIG9jY3VyZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIG92ZXJsYXA6IGZ1bmN0aW9uIChvYmplY3QxLCBvYmplY3QyLCBvdmVybGFwQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIG92ZXJsYXBDYWxsYmFjayA9IG92ZXJsYXBDYWxsYmFjayB8fCBudWxsOwogICAgICAgIHByb2Nlc3NDYWxsYmFjayA9IHByb2Nlc3NDYWxsYmFjayB8fCBudWxsOwogICAgICAgIGNhbGxiYWNrQ29udGV4dCA9IGNhbGxiYWNrQ29udGV4dCB8fCBvdmVybGFwQ2FsbGJhY2s7CgogICAgICAgIHRoaXMuX3Jlc3VsdCA9IGZhbHNlOwogICAgICAgIHRoaXMuX3RvdGFsID0gMDsKCiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkob2JqZWN0MikpCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgIGxlbiA9IG9iamVjdDIubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZUhhbmRsZXIob2JqZWN0MSwgb2JqZWN0MltpXSwgb3ZlcmxhcENhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb2xsaWRlSGFuZGxlcihvYmplY3QxLCBvYmplY3QyLCBvdmVybGFwQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCB0cnVlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAodGhpcy5fdG90YWwgPiAwKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgZm9yIGNvbGxpc2lvbiBiZXR3ZWVuIHR3byBnYW1lIG9iamVjdHMuIFlvdSBjYW4gcGVyZm9ybSBTcHJpdGUgdnMuIFNwcml0ZSwgU3ByaXRlIHZzLiBHcm91cCwgR3JvdXAgdnMuIEdyb3VwLCBTcHJpdGUgdnMuIFRpbGVtYXAgTGF5ZXIgb3IgR3JvdXAgdnMuIFRpbGVtYXAgTGF5ZXIgY29sbGlzaW9ucy4KICAgICogVGhlIHNlY29uZCBwYXJhbWV0ZXIgY2FuIGJlIGFuIGFycmF5IG9mIG9iamVjdHMsIG9mIGRpZmZlcmluZyB0eXBlcy4KICAgICogVGhlIG9iamVjdHMgYXJlIGFsc28gYXV0b21hdGljYWxseSBzZXBhcmF0ZWQuIElmIHlvdSBkb24ndCByZXF1aXJlIHNlcGFyYXRpb24gdGhlbiB1c2UgQXJjYWRlUGh5c2ljcy5vdmVybGFwIGluc3RlYWQuCiAgICAqIEFuIG9wdGlvbmFsIHByb2Nlc3NDYWxsYmFjayBjYW4gYmUgcHJvdmlkZWQuIElmIGdpdmVuIHRoaXMgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgd2hlbiB0d28gc3ByaXRlcyBhcmUgZm91bmQgdG8gYmUgY29sbGlkaW5nLiBJdCBpcyBjYWxsZWQgYmVmb3JlIGFueSBzZXBhcmF0aW9uIHRha2VzIHBsYWNlLAogICAgKiBnaXZpbmcgeW91IHRoZSBjaGFuY2UgdG8gcGVyZm9ybSBhZGRpdGlvbmFsIGNoZWNrcy4gSWYgdGhlIGZ1bmN0aW9uIHJldHVybnMgdHJ1ZSB0aGVuIHRoZSBjb2xsaXNpb24gYW5kIHNlcGFyYXRpb24gaXMgY2FycmllZCBvdXQuIElmIGl0IHJldHVybnMgZmFsc2UgaXQgaXMgc2tpcHBlZC4KICAgICogVGhlIGNvbGxpZGVDYWxsYmFjayBpcyBhbiBvcHRpb25hbCBmdW5jdGlvbiB0aGF0IGlzIG9ubHkgY2FsbGVkIGlmIHR3byBzcHJpdGVzIGNvbGxpZGUuIElmIGEgcHJvY2Vzc0NhbGxiYWNrIGhhcyBiZWVuIHNldCB0aGVuIGl0IG5lZWRzIHRvIHJldHVybiB0cnVlIGZvciBjb2xsaWRlQ2FsbGJhY2sgdG8gYmUgY2FsbGVkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjb2xsaWRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZXxQaGFzZXIuR3JvdXB8UGhhc2VyLlBhcnRpY2xlcy5FbWl0dGVyfFBoYXNlci5UaWxlbWFwfSBvYmplY3QxIC0gVGhlIGZpcnN0IG9iamVjdCB0byBjaGVjay4gQ2FuIGJlIGFuIGluc3RhbmNlIG9mIFBoYXNlci5TcHJpdGUsIFBoYXNlci5Hcm91cCwgUGhhc2VyLlBhcnRpY2xlcy5FbWl0dGVyLCBvciBQaGFzZXIuVGlsZW1hcC4KICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfFBoYXNlci5Hcm91cHxQaGFzZXIuUGFydGljbGVzLkVtaXR0ZXJ8UGhhc2VyLlRpbGVtYXB8YXJyYXl9IG9iamVjdDIgLSBUaGUgc2Vjb25kIG9iamVjdCBvciBhcnJheSBvZiBvYmplY3RzIHRvIGNoZWNrLiBDYW4gYmUgUGhhc2VyLlNwcml0ZSwgUGhhc2VyLkdyb3VwLCBQaGFzZXIuUGFydGljbGVzLkVtaXR0ZXIgb3IgUGhhc2VyLlRpbGVtYXAuCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtjb2xsaWRlQ2FsbGJhY2s9bnVsbF0gLSBBbiBvcHRpb25hbCBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCBpZiB0aGUgb2JqZWN0cyBjb2xsaWRlLiBUaGUgdHdvIG9iamVjdHMgd2lsbCBiZSBwYXNzZWQgdG8gdGhpcyBmdW5jdGlvbiBpbiB0aGUgc2FtZSBvcmRlciBpbiB3aGljaCB5b3Ugc3BlY2lmaWVkIHRoZW0uCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtwcm9jZXNzQ2FsbGJhY2s9bnVsbF0gLSBBIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgbGV0cyB5b3UgcGVyZm9ybSBhZGRpdGlvbmFsIGNoZWNrcyBhZ2FpbnN0IHRoZSB0d28gb2JqZWN0cyBpZiB0aGV5IG92ZXJsYXAuIElmIHRoaXMgaXMgc2V0IHRoZW4gY29sbGlzaW9uIHdpbGwgb25seSBoYXBwZW4gaWYgcHJvY2Vzc0NhbGxiYWNrIHJldHVybnMgdHJ1ZS4gVGhlIHR3byBvYmplY3RzIHdpbGwgYmUgcGFzc2VkIHRvIHRoaXMgZnVuY3Rpb24gaW4gdGhlIHNhbWUgb3JkZXIgaW4gd2hpY2ggeW91IHNwZWNpZmllZCB0aGVtLgogICAgKiBAcGFyYW0ge29iamVjdH0gW2NhbGxiYWNrQ29udGV4dF0gLSBUaGUgY29udGV4dCBpbiB3aGljaCB0byBydW4gdGhlIGNhbGxiYWNrcy4KICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYSBjb2xsaXNpb24gb2NjdXJlZCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgY29sbGlkZTogZnVuY3Rpb24gKG9iamVjdDEsIG9iamVjdDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCiAgICAgICAgY29sbGlkZUNhbGxiYWNrID0gY29sbGlkZUNhbGxiYWNrIHx8IG51bGw7CiAgICAgICAgcHJvY2Vzc0NhbGxiYWNrID0gcHJvY2Vzc0NhbGxiYWNrIHx8IG51bGw7CiAgICAgICAgY2FsbGJhY2tDb250ZXh0ID0gY2FsbGJhY2tDb250ZXh0IHx8IGNvbGxpZGVDYWxsYmFjazsKCiAgICAgICAgdGhpcy5fcmVzdWx0ID0gZmFsc2U7CiAgICAgICAgdGhpcy5fdG90YWwgPSAwOwoKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShvYmplY3QyKSkKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCAgbGVuID0gb2JqZWN0Mi5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlSGFuZGxlcihvYmplY3QxLCBvYmplY3QyW2ldLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb2xsaWRlSGFuZGxlcihvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBmYWxzZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKHRoaXMuX3RvdGFsID4gMCk7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgY29sbGlzaW9uIGhhbmRsZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NvbGxpZGVIYW5kbGVyCiAgICAqIEBwcml2YXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZXxQaGFzZXIuR3JvdXB8UGhhc2VyLlBhcnRpY2xlcy5FbWl0dGVyfFBoYXNlci5UaWxlbWFwfSBvYmplY3QxIC0gVGhlIGZpcnN0IG9iamVjdCB0byBjaGVjay4gQ2FuIGJlIGFuIGluc3RhbmNlIG9mIFBoYXNlci5TcHJpdGUsIFBoYXNlci5Hcm91cCwgUGhhc2VyLlBhcnRpY2xlcy5FbWl0dGVyLCBvciBQaGFzZXIuVGlsZW1hcC4KICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfFBoYXNlci5Hcm91cHxQaGFzZXIuUGFydGljbGVzLkVtaXR0ZXJ8UGhhc2VyLlRpbGVtYXB9IG9iamVjdDIgLSBUaGUgc2Vjb25kIG9iamVjdCB0byBjaGVjay4gQ2FuIGJlIGFuIGluc3RhbmNlIG9mIFBoYXNlci5TcHJpdGUsIFBoYXNlci5Hcm91cCwgUGhhc2VyLlBhcnRpY2xlcy5FbWl0dGVyIG9yIFBoYXNlci5UaWxlbWFwLiBDYW4gYWxzbyBiZSBhbiBhcnJheSBvZiBvYmplY3RzIHRvIGNoZWNrLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjb2xsaWRlQ2FsbGJhY2sgLSBBbiBvcHRpb25hbCBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCBpZiB0aGUgb2JqZWN0cyBjb2xsaWRlLiBUaGUgdHdvIG9iamVjdHMgd2lsbCBiZSBwYXNzZWQgdG8gdGhpcyBmdW5jdGlvbiBpbiB0aGUgc2FtZSBvcmRlciBpbiB3aGljaCB5b3Ugc3BlY2lmaWVkIHRoZW0uCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IHByb2Nlc3NDYWxsYmFjayAtIEEgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBsZXRzIHlvdSBwZXJmb3JtIGFkZGl0aW9uYWwgY2hlY2tzIGFnYWluc3QgdGhlIHR3byBvYmplY3RzIGlmIHRoZXkgb3ZlcmxhcC4gSWYgdGhpcyBpcyBzZXQgdGhlbiBjb2xsaXNpb24gd2lsbCBvbmx5IGhhcHBlbiBpZiBwcm9jZXNzQ2FsbGJhY2sgcmV0dXJucyB0cnVlLiBUaGUgdHdvIG9iamVjdHMgd2lsbCBiZSBwYXNzZWQgdG8gdGhpcyBmdW5jdGlvbiBpbiB0aGUgc2FtZSBvcmRlciBpbiB3aGljaCB5b3Ugc3BlY2lmaWVkIHRoZW0uCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0byBydW4gdGhlIGNhbGxiYWNrcy4KICAgICogQHBhcmFtIHtib29sZWFufSBvdmVybGFwT25seSAtIEp1c3QgcnVuIGFuIG92ZXJsYXAgb3IgYSBmdWxsIGNvbGxpc2lvbi4KICAgICovCiAgICBjb2xsaWRlSGFuZGxlcjogZnVuY3Rpb24gKG9iamVjdDEsIG9iamVjdDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJsYXBPbmx5KSB7CgogICAgICAgIC8vICBPbmx5IGNvbGxpZGUgdmFsaWQgb2JqZWN0cwogICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0MiA9PT0gJ3VuZGVmaW5lZCcgJiYgKG9iamVjdDEudHlwZSA9PT0gUGhhc2VyLkdST1VQIHx8IG9iamVjdDEudHlwZSA9PT0gUGhhc2VyLkVNSVRURVIpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb2xsaWRlR3JvdXBWc1NlbGYob2JqZWN0MSwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlcmxhcE9ubHkpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAob2JqZWN0MSAmJiBvYmplY3QyICYmIG9iamVjdDEuZXhpc3RzICYmIG9iamVjdDIuZXhpc3RzKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFNQUklURVMKICAgICAgICAgICAgaWYgKG9iamVjdDEudHlwZSA9PSBQaGFzZXIuU1BSSVRFIHx8IG9iamVjdDEudHlwZSA9PSBQaGFzZXIuVElMRVNQUklURSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuU1BSSVRFIHx8IG9iamVjdDIudHlwZSA9PSBQaGFzZXIuVElMRVNQUklURSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc1Nwcml0ZShvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLkdST1VQIHx8IG9iamVjdDIudHlwZSA9PSBQaGFzZXIuRU1JVFRFUikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc0dyb3VwKG9iamVjdDEsIG9iamVjdDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJsYXBPbmx5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuVElMRU1BUExBWUVSKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZVNwcml0ZVZzVGlsZW1hcExheWVyKG9iamVjdDEsIG9iamVjdDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vICBHUk9VUFMKICAgICAgICAgICAgZWxzZSBpZiAob2JqZWN0MS50eXBlID09IFBoYXNlci5HUk9VUCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuU1BSSVRFIHx8IG9iamVjdDIudHlwZSA9PSBQaGFzZXIuVElMRVNQUklURSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc0dyb3VwKG9iamVjdDIsIG9iamVjdDEsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJsYXBPbmx5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuR1JPVVAgfHwgb2JqZWN0Mi50eXBlID09IFBoYXNlci5FTUlUVEVSKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZUdyb3VwVnNHcm91cChvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlRJTEVNQVBMQVlFUikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVHcm91cFZzVGlsZW1hcExheWVyKG9iamVjdDEsIG9iamVjdDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vICBUSUxFTUFQIExBWUVSUwogICAgICAgICAgICBlbHNlIGlmIChvYmplY3QxLnR5cGUgPT0gUGhhc2VyLlRJTEVNQVBMQVlFUikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuU1BSSVRFIHx8IG9iamVjdDIudHlwZSA9PSBQaGFzZXIuVElMRVNQUklURSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc1RpbGVtYXBMYXllcihvYmplY3QyLCBvYmplY3QxLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuR1JPVVAgfHwgb2JqZWN0Mi50eXBlID09IFBoYXNlci5FTUlUVEVSKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZUdyb3VwVnNUaWxlbWFwTGF5ZXIob2JqZWN0Miwgb2JqZWN0MSwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gIEVNSVRURVIKICAgICAgICAgICAgZWxzZSBpZiAob2JqZWN0MS50eXBlID09IFBoYXNlci5FTUlUVEVSKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAob2JqZWN0Mi50eXBlID09IFBoYXNlci5TUFJJVEUgfHwgb2JqZWN0Mi50eXBlID09IFBoYXNlci5USUxFU1BSSVRFKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZVNwcml0ZVZzR3JvdXAob2JqZWN0Miwgb2JqZWN0MSwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlcmxhcE9ubHkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAob2JqZWN0Mi50eXBlID09IFBoYXNlci5HUk9VUCB8fCBvYmplY3QyLnR5cGUgPT0gUGhhc2VyLkVNSVRURVIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlR3JvdXBWc0dyb3VwKG9iamVjdDEsIG9iamVjdDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJsYXBPbmx5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuVElMRU1BUExBWUVSKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZUdyb3VwVnNUaWxlbWFwTGF5ZXIob2JqZWN0MSwgb2JqZWN0MiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQW4gaW50ZXJuYWwgZnVuY3Rpb24uIFVzZSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuY29sbGlkZSBpbnN0ZWFkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjb2xsaWRlU3ByaXRlVnNTcHJpdGUKICAgICogQHByaXZhdGUKICAgICovCiAgICBjb2xsaWRlU3ByaXRlVnNTcHJpdGU6IGZ1bmN0aW9uIChzcHJpdGUxLCBzcHJpdGUyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSkgewoKICAgICAgICBpZiAodGhpcy5zZXBhcmF0ZShzcHJpdGUxLmJvZHksIHNwcml0ZTIuYm9keSwgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJsYXBPbmx5KSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChjb2xsaWRlQ2FsbGJhY2spCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbGxpZGVDYWxsYmFjay5jYWxsKGNhbGxiYWNrQ29udGV4dCwgc3ByaXRlMSwgc3ByaXRlMik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3RvdGFsKys7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEFuIGludGVybmFsIGZ1bmN0aW9uLiBVc2UgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLmNvbGxpZGUgaW5zdGVhZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjY29sbGlkZVNwcml0ZVZzR3JvdXAKICAgICogQHByaXZhdGUKICAgICovCiAgICBjb2xsaWRlU3ByaXRlVnNHcm91cDogZnVuY3Rpb24gKHNwcml0ZSwgZ3JvdXAsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJsYXBPbmx5KSB7CgogICAgICAgIGlmIChncm91cC5sZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyAgV2hhdCBpcyB0aGUgc3ByaXRlIGNvbGxpZGluZyB3aXRoIGluIHRoZSBxdWFkdHJlZT8KICAgICAgICB0aGlzLnF1YWRUcmVlLmNsZWFyKCk7CgogICAgICAgIHRoaXMucXVhZFRyZWUgPSBuZXcgUGhhc2VyLlF1YWRUcmVlKHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMueCwgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy55LCB0aGlzLmdhbWUud29ybGQuYm91bmRzLndpZHRoLCB0aGlzLmdhbWUud29ybGQuYm91bmRzLmhlaWdodCwgdGhpcy5tYXhPYmplY3RzLCB0aGlzLm1heExldmVscyk7CgogICAgICAgIHRoaXMucXVhZFRyZWUucG9wdWxhdGUoZ3JvdXApOwoKICAgICAgICB0aGlzLl9wb3RlbnRpYWxzID0gdGhpcy5xdWFkVHJlZS5yZXRyaWV2ZShzcHJpdGUpOwoKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5fcG90ZW50aWFscy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBXZSBoYXZlIG91ciBwb3RlbnRpYWwgc3VzcGVjdHMsIGFyZSB0aGV5IGluIHRoaXMgZ3JvdXA/CiAgICAgICAgICAgIGlmICh0aGlzLnNlcGFyYXRlKHNwcml0ZS5ib2R5LCB0aGlzLl9wb3RlbnRpYWxzW2ldLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlcmxhcE9ubHkpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY29sbGlkZUNhbGxiYWNrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvbGxpZGVDYWxsYmFjay5jYWxsKGNhbGxiYWNrQ29udGV4dCwgc3ByaXRlLCB0aGlzLl9wb3RlbnRpYWxzW2ldLnNwcml0ZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fdG90YWwrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBbiBpbnRlcm5hbCBmdW5jdGlvbi4gVXNlIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5jb2xsaWRlIGluc3RlYWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NvbGxpZGVHcm91cFZzU2VsZgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIGNvbGxpZGVHcm91cFZzU2VsZjogZnVuY3Rpb24gKGdyb3VwLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSkgewoKICAgICAgICBpZiAoZ3JvdXAubGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGxlbiA9IGdyb3VwLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IGkgKyAxOyBqIDw9IGxlbjsgaisrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZ3JvdXAuX2NvbnRhaW5lci5jaGlsZHJlbltpXSAmJiBncm91cC5fY29udGFpbmVyLmNoaWxkcmVuW2pdICYmIGdyb3VwLl9jb250YWluZXIuY2hpbGRyZW5baV0uZXhpc3RzICYmIGdyb3VwLl9jb250YWluZXIuY2hpbGRyZW5bal0uZXhpc3RzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZVNwcml0ZVZzU3ByaXRlKGdyb3VwLl9jb250YWluZXIuY2hpbGRyZW5baV0sIGdyb3VwLl9jb250YWluZXIuY2hpbGRyZW5bal0sIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJsYXBPbmx5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBbiBpbnRlcm5hbCBmdW5jdGlvbi4gVXNlIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5jb2xsaWRlIGluc3RlYWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NvbGxpZGVHcm91cFZzR3JvdXAKICAgICogQHByaXZhdGUKICAgICovCiAgICBjb2xsaWRlR3JvdXBWc0dyb3VwOiBmdW5jdGlvbiAoZ3JvdXAxLCBncm91cDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJsYXBPbmx5KSB7CgogICAgICAgIGlmIChncm91cDEubGVuZ3RoID09PSAwIHx8IGdyb3VwMi5sZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoZ3JvdXAxLl9jb250YWluZXIuZmlyc3QuX2lOZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gZ3JvdXAxLl9jb250YWluZXIuZmlyc3QuX2lOZXh0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGRvCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5leGlzdHMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlU3ByaXRlVnNHcm91cChjdXJyZW50Tm9kZSwgZ3JvdXAyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gZ3JvdXAxLl9jb250YWluZXIubGFzdC5faU5leHQpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBbiBpbnRlcm5hbCBmdW5jdGlvbi4gVXNlIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5jb2xsaWRlIGluc3RlYWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NvbGxpZGVTcHJpdGVWc1RpbGVtYXBMYXllcgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIGNvbGxpZGVTcHJpdGVWc1RpbGVtYXBMYXllcjogZnVuY3Rpb24gKHNwcml0ZSwgdGlsZW1hcExheWVyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIHRoaXMuX21hcERhdGEgPSB0aWxlbWFwTGF5ZXIuZ2V0VGlsZXMoc3ByaXRlLmJvZHkubGVmdCwgc3ByaXRlLmJvZHkudG9wLCBzcHJpdGUuYm9keS53aWR0aCwgc3ByaXRlLmJvZHkuaGVpZ2h0LCB0cnVlKTsKCiAgICAgICAgaWYgKHRoaXMuX21hcERhdGEubGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX21hcERhdGEubGVuZ3RoID4gMSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc2VwYXJhdGVUaWxlcyhzcHJpdGUuYm9keSwgdGhpcy5fbWFwRGF0YSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHZhciBpID0gMDsKCiAgICAgICAgICAgIGlmICh0aGlzLnNlcGFyYXRlVGlsZShzcHJpdGUuYm9keSwgdGhpcy5fbWFwRGF0YVtpXSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBUaGV5IGNvbGxpZGVkLCBpcyB0aGVyZSBhIGN1c3RvbSBwcm9jZXNzIGNhbGxiYWNrPwogICAgICAgICAgICAgICAgaWYgKHByb2Nlc3NDYWxsYmFjaykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJvY2Vzc0NhbGxiYWNrLmNhbGwoY2FsbGJhY2tDb250ZXh0LCBzcHJpdGUsIHRoaXMuX21hcERhdGFbaV0pKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG90YWwrKzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2xsaWRlQ2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxpZGVDYWxsYmFjay5jYWxsKGNhbGxiYWNrQ29udGV4dCwgc3ByaXRlLCB0aGlzLl9tYXBEYXRhW2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl90b3RhbCsrOwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29sbGlkZUNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sbGlkZUNhbGxiYWNrLmNhbGwoY2FsbGJhY2tDb250ZXh0LCBzcHJpdGUsIHRoaXMuX21hcERhdGFbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBbiBpbnRlcm5hbCBmdW5jdGlvbi4gVXNlIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5jb2xsaWRlIGluc3RlYWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NvbGxpZGVHcm91cFZzVGlsZW1hcExheWVyCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgY29sbGlkZUdyb3VwVnNUaWxlbWFwTGF5ZXI6IGZ1bmN0aW9uIChncm91cCwgdGlsZW1hcExheWVyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIGlmIChncm91cC5sZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoZ3JvdXAuX2NvbnRhaW5lci5maXJzdC5faU5leHQpCiAgICAgICAgewogICAgICAgICAgICB2YXIgY3VycmVudE5vZGUgPSBncm91cC5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBkbwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuZXhpc3RzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZVNwcml0ZVZzVGlsZW1hcExheWVyKGN1cnJlbnROb2RlLCB0aWxlbWFwTGF5ZXIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnROb2RlICE9IGdyb3VwLl9jb250YWluZXIubGFzdC5faU5leHQpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgY29yZSBzZXBhcmF0aW9uIGZ1bmN0aW9uIHRvIHNlcGFyYXRlIHR3byBwaHlzaWNzIGJvZGllcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjc2VwYXJhdGUKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keTEgLSBUaGUgQm9keSBvYmplY3QgdG8gc2VwYXJhdGUuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkyIC0gVGhlIEJvZHkgb2JqZWN0IHRvIHNlcGFyYXRlLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbcHJvY2Vzc0NhbGxiYWNrPW51bGxdIC0gQSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGxldHMgeW91IHBlcmZvcm0gYWRkaXRpb25hbCBjaGVja3MgYWdhaW5zdCB0aGUgdHdvIG9iamVjdHMgaWYgdGhleSBvdmVybGFwLiBJZiB0aGlzIGZ1bmN0aW9uIGlzIHNldCB0aGVuIHRoZSBzcHJpdGVzIHdpbGwgb25seSBiZSBjb2xsaWRlZCBpZiBpdCByZXR1cm5zIHRydWUuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBbY2FsbGJhY2tDb250ZXh0XSAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRvIHJ1biB0aGUgcHJvY2VzcyBjYWxsYmFjay4KICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB0aGUgYm9kaWVzIGNvbGxpZGVkLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgc2VwYXJhdGU6IGZ1bmN0aW9uIChib2R5MSwgYm9keTIsIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVybGFwT25seSkgewoKICAgICAgICBpZiAoYm9keTEgPT09IGJvZHkyIHx8IHRoaXMuaW50ZXJzZWN0cyhib2R5MSwgYm9keTIpID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIC8vICBUaGV5IG92ZXJsYXAuIElzIHRoZXJlIGEgY3VzdG9tIHByb2Nlc3MgY2FsbGJhY2s/IElmIGl0IHJldHVybnMgdHJ1ZSB0aGVuIHdlIGNhbiBjYXJyeSBvbiwgb3RoZXJ3aXNlIHdlIHNob3VsZCBhYm9ydC4KICAgICAgICBpZiAocHJvY2Vzc0NhbGxiYWNrICYmIHByb2Nlc3NDYWxsYmFjay5jYWxsKGNhbGxiYWNrQ29udGV4dCwgYm9keTEuc3ByaXRlLCBib2R5Mi5zcHJpdGUpID09PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3Jlc3BvbnNlLmNsZWFyKCk7CgogICAgICAgIGlmIChvdmVybGFwT25seSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBib2R5MS5vdmVybGFwKGJvZHkyLCB0aGlzLl9yZXNwb25zZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmIChib2R5MS5vdmVybGFwKGJvZHkyLCB0aGlzLl9yZXNwb25zZSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBib2R5MS5zZXBhcmF0ZShib2R5MiwgdGhpcy5fcmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogUGVyZm9ybXMgYSByZWN0IGludGVyc2VjdGlvbiB0ZXN0IGFnYWluc3QgdGhlIHR3byBvYmplY3RzLgogICAgKiBPYmplY3RzIG11c3QgZXhwb3NlIHByb3BlcnRpZXM6IHdpZHRoLCBoZWlnaHQsIGxlZnQsIHJpZ2h0LCB0b3AsIGJvdHRvbS4KICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjaW50ZXJzZWN0cwogICAgKiBAcGFyYW0ge29iamVjdH0gYSAtIFRoZSBmaXJzdCBvYmplY3QgdG8gdGVzdC4KICAgICogQHBhcmFtIHtvYmplY3R9IGIgLSBUaGUgc2Vjb25kIG9iamVjdCB0byB0ZXN0LgogICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHRoZSBvYmplY3RzIGludGVyc2VjdCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGludGVyc2VjdHM6IGZ1bmN0aW9uIChhLCBiKSB7CgogICAgICAgIHZhciByZXN1bHQgPSBmYWxzZTsKCiAgICAgICAgaWYgKGEud2lkdGggPD0gMCB8fCBhLmhlaWdodCA8PSAwIHx8IGIud2lkdGggPD0gMCB8fCBiLmhlaWdodCA8PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICByZXN1bHQgPSAhKGEucmlnaHQgPCBiLmxlZnQgfHwgYS5ib3R0b20gPCBiLnRvcCB8fCBhLmxlZnQgPiBiLnJpZ2h0IHx8IGEudG9wID4gYi5ib3R0b20pOwoKICAgICAgICBpZiAoIXJlc3VsdCAmJiBhLmluQ29udGFjdChiKSkKICAgICAgICB7CiAgICAgICAgICAgIGEucmVtb3ZlQ29udGFjdChiKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUGVyZm9ybXMgYSByZWN0IGludGVyc2VjdGlvbiB0ZXN0IGFnYWluc3QgdGhlIHR3byBvYmplY3RzLgogICAgKiBPYmplY3RzIG11c3QgZXhwb3NlIHByb3BlcnRpZXM6IHdpZHRoLCBoZWlnaHQsIGxlZnQsIHJpZ2h0LCB0b3AsIGJvdHRvbS4KICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjdGlsZUludGVyc2VjdHMKICAgICogQHBhcmFtIHtvYmplY3R9IGJvZHkgLSBUaGUgQm9keSB0byB0ZXN0LgogICAgKiBAcGFyYW0ge29iamVjdH0gdGlsZSAtIFRoZSBUaWxlIHRvIHRlc3QuCiAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdGhlIG9iamVjdHMgaW50ZXJzZWN0LCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgdGlsZUludGVyc2VjdHM6IGZ1bmN0aW9uIChib2R5LCB0aWxlKSB7CgogICAgICAgIGlmIChib2R5LndpZHRoIDw9IDAgfHwgYm9keS5oZWlnaHQgPD0gMCB8fCB0aWxlLndpZHRoIDw9IDAgfHwgdGlsZS5oZWlnaHQgPD0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ludGVyc2VjdGlvbls0XSA9IDA7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbnRlcnNlY3Rpb247CiAgICAgICAgfQoKICAgICAgICBpZiAoIShib2R5LnJpZ2h0IDwgdGlsZS54IHx8IGJvZHkuYm90dG9tIDwgdGlsZS55IHx8IGJvZHkubGVmdCA+IHRpbGUucmlnaHQgfHwgYm9keS50b3AgPiB0aWxlLmJvdHRvbSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9pbnRlcnNlY3Rpb25bMF0gPSBNYXRoLm1heChib2R5LmxlZnQsIHRpbGUueCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8geAogICAgICAgICAgICB0aGlzLl9pbnRlcnNlY3Rpb25bMV0gPSBNYXRoLm1heChib2R5LnRvcCwgdGlsZS55KTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8geQogICAgICAgICAgICB0aGlzLl9pbnRlcnNlY3Rpb25bMl0gPSBNYXRoLm1pbihib2R5LnJpZ2h0LCB0aWxlLnJpZ2h0KSAtIHRoaXMuX2ludGVyc2VjdGlvblswXTsgICAgICAgLy8gd2lkdGgKICAgICAgICAgICAgdGhpcy5faW50ZXJzZWN0aW9uWzNdID0gTWF0aC5taW4oYm9keS5ib3R0b20sIHRpbGUuYm90dG9tKSAtIHRoaXMuX2ludGVyc2VjdGlvblsxXTsgICAgIC8vIGhlaWdodAogICAgICAgICAgICB0aGlzLl9pbnRlcnNlY3Rpb25bNF0gPSAxOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ludGVyc2VjdGlvbjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2ludGVyc2VjdGlvbls0XSA9IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9pbnRlcnNlY3Rpb247CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIGNvcmUgc2VwYXJhdGlvbiBmdW5jdGlvbiB0byBzZXBhcmF0ZSBhIHBoeXNpY3MgYm9keSBhbmQgYW4gYXJyYXkgb2YgdGlsZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3NlcGFyYXRlVGlsZXMKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IG9iamVjdCB0byBzZXBhcmF0ZS4KICAgICogQHBhcmFtIHthcnJheTxQaGFzZXIuVGlsZT59IHRpbGVzIC0gVGhlIGFycmF5IG9mIHRpbGVzIHRvIGNvbGxpZGUgYWdhaW5zdC4KICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB0aGUgYm9keSB3YXMgc2VwYXJhdGVkLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgc2VwYXJhdGVUaWxlczogZnVuY3Rpb24gKGJvZHksIHRpbGVzKSB7CgogICAgICAgIHZhciB0aWxlOwogICAgICAgIHZhciByZXN1bHQgPSBmYWxzZTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aWxlcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRpbGUgPSB0aWxlc1tpXTsKCiAgICAgICAgICAgIGlmICh0aGlzLnNlcGFyYXRlVGlsZShib2R5LCB0aWxlKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgY29yZSBzZXBhcmF0aW9uIGZ1bmN0aW9uIHRvIHNlcGFyYXRlIGEgcGh5c2ljcyBib2R5IGFuZCBhIHRpbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3NlcGFyYXRlVGlsZQogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gVGhlIEJvZHkgb2JqZWN0IHRvIHNlcGFyYXRlLgogICAgKiBAcGFyYW0ge1BoYXNlci5UaWxlfSB0aWxlIC0gVGhlIHRpbGUgdG8gY29sbGlkZSBhZ2FpbnN0LgogICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHRoZSBib2R5IHdhcyBzZXBhcmF0ZWQsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBzZXBhcmF0ZVRpbGU6IGZ1bmN0aW9uIChib2R5LCB0aWxlKSB7CgogICAgICAgIHRoaXMuX2ludGVyc2VjdGlvbiA9IHRoaXMudGlsZUludGVyc2VjdHMoYm9keSwgdGlsZSk7CgogICAgICAgIC8vICBJZiB0aGUgaW50ZXJzZWN0aW9uIGFyZWEgaXMgZWl0aGVyIGVudGlyZWx5IG51bGwsIG9yIGhhcyBhIHdpZHRoL2hlaWdodCBvZiB6ZXJvLCB3ZSBiYWlsIG91dCBub3cKICAgICAgICBpZiAodGhpcy5faW50ZXJzZWN0aW9uWzRdID09PSAwIHx8IHRoaXMuX2ludGVyc2VjdGlvblsyXSA9PT0gMCB8fCB0aGlzLl9pbnRlcnNlY3Rpb25bM10gPT09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICAvLyAgVGhleSBvdmVybGFwLiBBbnkgY3VzdG9tIGNhbGxiYWNrcz8KICAgICAgICBpZiAodGlsZS50aWxlLmNhbGxiYWNrIHx8IHRpbGUubGF5ZXIuY2FsbGJhY2tzW3RpbGUudGlsZS5pbmRleF0pCiAgICAgICAgewogICAgICAgICAgICAvLyAgQSBsb2NhbCBjYWxsYmFjayB0YWtlcyBwcmlvcml0eSBvdmVyIGEgZ2xvYmFsIGNhbGxiYWNrLgogICAgICAgICAgICBpZiAodGlsZS50aWxlLmNhbGxiYWNrICYmIHRpbGUudGlsZS5jYWxsYmFjay5jYWxsKHRpbGUudGlsZS5jYWxsYmFja0NvbnRleHQsIGJvZHkuc3ByaXRlLCB0aWxlKSA9PT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBJcyB0aGVyZSBhIHRpbGUgc3BlY2lmaWMgY29sbGlzaW9uIGNhbGxiYWNrPyBJZiBpdCByZXR1cm5zIHRydWUgdGhlbiB3ZSBjYW4gY2Fycnkgb24sIG90aGVyd2lzZSB3ZSBzaG91bGQgYWJvcnQuCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGlsZS5sYXllci5jYWxsYmFja3NbdGlsZS50aWxlLmluZGV4XSAmJiB0aWxlLmxheWVyLmNhbGxiYWNrc1t0aWxlLnRpbGUuaW5kZXhdLmNhbGxiYWNrLmNhbGwodGlsZS5sYXllci5jYWxsYmFja3NbdGlsZS50aWxlLmluZGV4XS5jYWxsYmFja0NvbnRleHQsIGJvZHkuc3ByaXRlLCB0aWxlKSA9PT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBJcyB0aGVyZSBhIHRpbGUgaW5kZXggY29sbGlzaW9uIGNhbGxiYWNrPyBJZiBpdCByZXR1cm5zIHRydWUgdGhlbiB3ZSBjYW4gY2Fycnkgb24sIG90aGVyd2lzZSB3ZSBzaG91bGQgYWJvcnQuCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGJvZHkub3ZlcmxhcFggPSAwOwogICAgICAgIGJvZHkub3ZlcmxhcFkgPSAwOwoKICAgICAgICB2YXIgcHJvY2VzcyA9IGZhbHNlOwoKICAgICAgICBpZiAoYm9keS5kZWx0YVgoKSA8IDAgJiYgYm9keS5jaGVja0NvbGxpc2lvbi5sZWZ0ICYmIHRpbGUudGlsZS5mYWNlUmlnaHQgJiYgIWJvZHkuYmxvY2tlZC5sZWZ0KQogICAgICAgIHsKICAgICAgICAgICAgLy8gIExFRlQKICAgICAgICAgICAgYm9keS5vdmVybGFwWCA9IGJvZHkubGVmdCAtIHRpbGUucmlnaHQ7CgogICAgICAgICAgICBpZiAoYm9keS5vdmVybGFwWCA8IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHByb2Nlc3MgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYm9keS5vdmVybGFwWCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYm9keS5kZWx0YVgoKSA+IDAgJiYgYm9keS5jaGVja0NvbGxpc2lvbi5yaWdodCAmJiB0aWxlLnRpbGUuZmFjZUxlZnQgJiYgIWJvZHkuYmxvY2tlZC5yaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBSSUdIVAogICAgICAgICAgICBib2R5Lm92ZXJsYXBYID0gYm9keS5yaWdodCAtIHRpbGUueDsKCiAgICAgICAgICAgIGlmIChib2R5Lm92ZXJsYXBYID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcHJvY2VzcyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib2R5Lm92ZXJsYXBYID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGJvZHkuZGVsdGFZKCkgPCAwICYmIGJvZHkuY2hlY2tDb2xsaXNpb24udXAgJiYgdGlsZS50aWxlLmZhY2VCb3R0b20gJiYgIWJvZHkuYmxvY2tlZC51cCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBVUAogICAgICAgICAgICBib2R5Lm92ZXJsYXBZID0gYm9keS50b3AgLSB0aWxlLmJvdHRvbTsKCiAgICAgICAgICAgIGlmIChib2R5Lm92ZXJsYXBZIDwgMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcHJvY2VzcyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib2R5Lm92ZXJsYXBZID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChib2R5LmRlbHRhWSgpID4gMCAmJiBib2R5LmNoZWNrQ29sbGlzaW9uLmRvd24gJiYgdGlsZS50aWxlLmZhY2VUb3AgJiYgIWJvZHkuYmxvY2tlZC5kb3duKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIERPV04KICAgICAgICAgICAgYm9keS5vdmVybGFwWSA9IGJvZHkuYm90dG9tIC0gdGlsZS55OwoKICAgICAgICAgICAgaWYgKGJvZHkub3ZlcmxhcFkgPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwcm9jZXNzID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJvZHkub3ZlcmxhcFkgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyAgT25seSBzZXBhcmF0ZSBvbiB0aGUgc21hbGxlc3Qgb2YgdGhlIHR3byB2YWx1ZXMgaWYgaXQncyBhIHNpbmdsZSB0aWxlCiAgICAgICAgaWYgKGJvZHkub3ZlcmxhcFggIT09IDAgJiYgYm9keS5vdmVybGFwWSAhPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChNYXRoLmFicyhib2R5Lm92ZXJsYXBYKSA+IE1hdGguYWJzKGJvZHkub3ZlcmxhcFkpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib2R5Lm92ZXJsYXBYID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJvZHkub3ZlcmxhcFkgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyAgU2VwYXJhdGUgaW4gYSBzaW5nbGUgc3dlZXAKICAgICAgICBpZiAocHJvY2VzcykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb2Nlc3NUaWxlU2VwYXJhdGlvbihib2R5KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBmdW5jdGlvbiB0byBwcm9jZXNzIHRoZSBzZXBhcmF0aW9uIG9mIGEgcGh5c2ljcyBib2R5IGZyb20gYSB0aWxlLgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNwcm9jZXNzVGlsZVNlcGFyYXRpb24KICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5MSAtIFRoZSBCb2R5IG9iamVjdCB0byBzZXBhcmF0ZS4KICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBzZXBhcmF0ZWQsIGZhbHNlIGlmIG5vdC4KICAgICovCiAgICBwcm9jZXNzVGlsZVNlcGFyYXRpb246IGZ1bmN0aW9uIChib2R5KSB7CgogICAgICAgIGlmIChib2R5Lm92ZXJsYXBYIDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIGJvZHkueCAtPSBib2R5Lm92ZXJsYXBYOwogICAgICAgICAgICBib2R5LmxlZnQgLT0gYm9keS5vdmVybGFwWDsKICAgICAgICAgICAgYm9keS5yaWdodCAtPSBib2R5Lm92ZXJsYXBYOwogICAgICAgICAgICBib2R5LmJsb2NrZWQueCA9IE1hdGguZmxvb3IoYm9keS54KTsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnkgPSBNYXRoLmZsb29yKGJvZHkueSk7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC5sZWZ0ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYm9keS5vdmVybGFwWCA+IDApCiAgICAgICAgewogICAgICAgICAgICBib2R5LnggLT0gYm9keS5vdmVybGFwWDsKICAgICAgICAgICAgYm9keS5sZWZ0IC09IGJvZHkub3ZlcmxhcFg7CiAgICAgICAgICAgIGJvZHkucmlnaHQgLT0gYm9keS5vdmVybGFwWDsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnggPSBNYXRoLmZsb29yKGJvZHkueCk7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC55ID0gTWF0aC5mbG9vcihib2R5LnkpOwogICAgICAgICAgICBib2R5LmJsb2NrZWQucmlnaHQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKGJvZHkub3ZlcmxhcFkgPCAwKQogICAgICAgIHsKICAgICAgICAgICAgYm9keS55IC09IGJvZHkub3ZlcmxhcFk7CiAgICAgICAgICAgIGJvZHkudG9wIC09IGJvZHkub3ZlcmxhcFk7CiAgICAgICAgICAgIGJvZHkuYm90dG9tIC09IGJvZHkub3ZlcmxhcFk7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC54ID0gTWF0aC5mbG9vcihib2R5LngpOwogICAgICAgICAgICBib2R5LmJsb2NrZWQueSA9IE1hdGguZmxvb3IoYm9keS55KTsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnVwID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYm9keS5vdmVybGFwWSA+IDApCiAgICAgICAgewogICAgICAgICAgICBib2R5LnkgLT0gYm9keS5vdmVybGFwWTsKICAgICAgICAgICAgYm9keS50b3AgLT0gYm9keS5vdmVybGFwWTsKICAgICAgICAgICAgYm9keS5ib3R0b20gLT0gYm9keS5vdmVybGFwWTsKICAgICAgICAgICAgYm9keS5ibG9ja2VkLnggPSBNYXRoLmZsb29yKGJvZHkueCk7CiAgICAgICAgICAgIGJvZHkuYmxvY2tlZC55ID0gTWF0aC5mbG9vcihib2R5LnkpOwogICAgICAgICAgICBib2R5LmJsb2NrZWQuZG93biA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBib2R5LnJlYm91bmRDaGVjayhib2R5Lm92ZXJsYXBYLCBib2R5Lm92ZXJsYXBZLCB0cnVlKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogTW92ZSB0aGUgZ2l2ZW4gZGlzcGxheSBvYmplY3QgdG93YXJkcyB0aGUgZGVzdGluYXRpb24gb2JqZWN0IGF0IGEgc3RlYWR5IHZlbG9jaXR5LgogICAgKiBJZiB5b3Ugc3BlY2lmeSBhIG1heFRpbWUgdGhlbiBpdCB3aWxsIGFkanVzdCB0aGUgc3BlZWQgKG92ZXItd3JpdGluZyB3aGF0IHlvdSBzZXQpIHNvIGl0IGFycml2ZXMgYXQgdGhlIGRlc3RpbmF0aW9uIGluIHRoYXQgbnVtYmVyIG9mIHNlY29uZHMuCiAgICAqIFRpbWluZ3MgYXJlIGFwcHJveGltYXRlIGR1ZSB0byB0aGUgd2F5IGJyb3dzZXIgdGltZXJzIHdvcmsuIEFsbG93IGZvciBhIHZhcmlhbmNlIG9mICstIDUwbXMuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2VzIG5vdCBjb250aW51b3VzbHkgdHJhY2sgdGhlIHRhcmdldC4gSWYgdGhlIHRhcmdldCBjaGFuZ2VzIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0IHRoZSBkaXNwbGF5IG9iamVjdCB3aWxsIG5vdCBtb2RpZnkgaXRzIGNvdXJzZS4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXNuJ3Qgc3RvcCBtb3Zpbmcgb25jZSBpdCByZWFjaGVzIHRoZSBkZXN0aW5hdGlvbiBjb29yZGluYXRlcy4KICAgICogTm90ZTogRG9lc24ndCB0YWtlIGludG8gYWNjb3VudCBhY2NlbGVyYXRpb24sIG1heFZlbG9jaXR5IG9yIGRyYWcgKGlmIHlvdSd2ZSBzZXQgZHJhZyBvciBhY2NlbGVyYXRpb24gdG9vIGhpZ2ggdGhpcyBvYmplY3QgbWF5IG5vdCBtb3ZlIGF0IGFsbCkKICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI21vdmVUb09iamVjdAogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byBtb3ZlLgogICAgKiBAcGFyYW0ge2FueX0gZGVzdGluYXRpb24gLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZSB0b3dhcmRzLiBDYW4gYmUgYW55IG9iamVjdCBidXQgbXVzdCBoYXZlIHZpc2libGUgeC95IHByb3BlcnRpZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BlZWQ9NjBdIC0gVGhlIHNwZWVkIGl0IHdpbGwgbW92ZSwgaW4gcGl4ZWxzIHBlciBzZWNvbmQgKGRlZmF1bHQgaXMgNjAgcGl4ZWxzL3NlYykKICAgICogQHBhcmFtIHtudW1iZXJ9IFttYXhUaW1lPTBdIC0gVGltZSBnaXZlbiBpbiBtaWxsaXNlY29uZHMgKDEwMDAgPSAxIHNlYykuIElmIHNldCB0aGUgc3BlZWQgaXMgYWRqdXN0ZWQgc28gdGhlIG9iamVjdCB3aWxsIGFycml2ZSBhdCBkZXN0aW5hdGlvbiBpbiB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1zLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSAoaW4gcmFkaWFucykgdGhhdCB0aGUgb2JqZWN0IHNob3VsZCBiZSB2aXN1YWxseSBzZXQgdG8gaW4gb3JkZXIgdG8gbWF0Y2ggaXRzIG5ldyB2ZWxvY2l0eS4KICAgICovCiAgICBtb3ZlVG9PYmplY3Q6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCBkZXN0aW5hdGlvbiwgc3BlZWQsIG1heFRpbWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCA9PT0gJ3VuZGVmaW5lZCcpIHsgc3BlZWQgPSA2MDsgfQogICAgICAgIGlmICh0eXBlb2YgbWF4VGltZSA9PT0gJ3VuZGVmaW5lZCcpIHsgbWF4VGltZSA9IDA7IH0KCiAgICAgICAgdGhpcy5fYW5nbGUgPSBNYXRoLmF0YW4yKGRlc3RpbmF0aW9uLnkgLSBkaXNwbGF5T2JqZWN0LnksIGRlc3RpbmF0aW9uLnggLSBkaXNwbGF5T2JqZWN0LngpOwogICAgICAgIAogICAgICAgIGlmIChtYXhUaW1lID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBXZSBrbm93IGhvdyBtYW55IHBpeGVscyB3ZSBuZWVkIHRvIG1vdmUsIGJ1dCBob3cgZmFzdD8KICAgICAgICAgICAgc3BlZWQgPSB0aGlzLmRpc3RhbmNlQmV0d2VlbihkaXNwbGF5T2JqZWN0LCBkZXN0aW5hdGlvbikgLyAobWF4VGltZSAvIDEwMDApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkudmVsb2NpdHkueCA9IE1hdGguY29zKHRoaXMuX2FuZ2xlKSAqIHNwZWVkOwogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS52ZWxvY2l0eS55ID0gTWF0aC5zaW4odGhpcy5fYW5nbGUpICogc3BlZWQ7CgogICAgICAgIHJldHVybiB0aGlzLl9hbmdsZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNb3ZlIHRoZSBnaXZlbiBkaXNwbGF5IG9iamVjdCB0b3dhcmRzIHRoZSBwb2ludGVyIGF0IGEgc3RlYWR5IHZlbG9jaXR5LiBJZiBubyBwb2ludGVyIGlzIGdpdmVuIGl0IHdpbGwgdXNlIFBoYXNlci5JbnB1dC5hY3RpdmVQb2ludGVyLgogICAgKiBJZiB5b3Ugc3BlY2lmeSBhIG1heFRpbWUgdGhlbiBpdCB3aWxsIGFkanVzdCB0aGUgc3BlZWQgKG92ZXItd3JpdGluZyB3aGF0IHlvdSBzZXQpIHNvIGl0IGFycml2ZXMgYXQgdGhlIGRlc3RpbmF0aW9uIGluIHRoYXQgbnVtYmVyIG9mIHNlY29uZHMuCiAgICAqIFRpbWluZ3MgYXJlIGFwcHJveGltYXRlIGR1ZSB0byB0aGUgd2F5IGJyb3dzZXIgdGltZXJzIHdvcmsuIEFsbG93IGZvciBhIHZhcmlhbmNlIG9mICstIDUwbXMuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2VzIG5vdCBjb250aW51b3VzbHkgdHJhY2sgdGhlIHRhcmdldC4gSWYgdGhlIHRhcmdldCBjaGFuZ2VzIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0IHRoZSBkaXNwbGF5IG9iamVjdCB3aWxsIG5vdCBtb2RpZnkgaXRzIGNvdXJzZS4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXNuJ3Qgc3RvcCBtb3Zpbmcgb25jZSBpdCByZWFjaGVzIHRoZSBkZXN0aW5hdGlvbiBjb29yZGluYXRlcy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI21vdmVUb1BvaW50ZXIKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBtb3ZlLCBpbiBwaXhlbHMgcGVyIHNlY29uZCAoZGVmYXVsdCBpcyA2MCBwaXhlbHMvc2VjKQogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBbcG9pbnRlcl0gLSBUaGUgcG9pbnRlciB0byBtb3ZlIHRvd2FyZHMuIERlZmF1bHRzIHRvIFBoYXNlci5JbnB1dC5hY3RpdmVQb2ludGVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW21heFRpbWU9MF0gLSBUaW1lIGdpdmVuIGluIG1pbGxpc2Vjb25kcyAoMTAwMCA9IDEgc2VjKS4gSWYgc2V0IHRoZSBzcGVlZCBpcyBhZGp1c3RlZCBzbyB0aGUgb2JqZWN0IHdpbGwgYXJyaXZlIGF0IGRlc3RpbmF0aW9uIGluIHRoZSBnaXZlbiBudW1iZXIgb2YgbXMuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIChpbiByYWRpYW5zKSB0aGF0IHRoZSBvYmplY3Qgc2hvdWxkIGJlIHZpc3VhbGx5IHNldCB0byBpbiBvcmRlciB0byBtYXRjaCBpdHMgbmV3IHZlbG9jaXR5LgogICAgKi8KICAgIG1vdmVUb1BvaW50ZXI6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCBzcGVlZCwgcG9pbnRlciwgbWF4VGltZSkgewoKICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgeyBzcGVlZCA9IDYwOyB9CiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgdGhpcy5nYW1lLmlucHV0LmFjdGl2ZVBvaW50ZXI7CiAgICAgICAgaWYgKHR5cGVvZiBtYXhUaW1lID09PSAndW5kZWZpbmVkJykgeyBtYXhUaW1lID0gMDsgfQoKICAgICAgICB0aGlzLl9hbmdsZSA9IHRoaXMuYW5nbGVUb1BvaW50ZXIoZGlzcGxheU9iamVjdCwgcG9pbnRlcik7CiAgICAgICAgCiAgICAgICAgaWYgKG1heFRpbWUgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFdlIGtub3cgaG93IG1hbnkgcGl4ZWxzIHdlIG5lZWQgdG8gbW92ZSwgYnV0IGhvdyBmYXN0PwogICAgICAgICAgICBzcGVlZCA9IHRoaXMuZGlzdGFuY2VUb1BvaW50ZXIoZGlzcGxheU9iamVjdCwgcG9pbnRlcikgLyAobWF4VGltZSAvIDEwMDApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkudmVsb2NpdHkueCA9IE1hdGguY29zKHRoaXMuX2FuZ2xlKSAqIHNwZWVkOwogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS52ZWxvY2l0eS55ID0gTWF0aC5zaW4odGhpcy5fYW5nbGUpICogc3BlZWQ7CgogICAgICAgIHJldHVybiB0aGlzLl9hbmdsZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNb3ZlIHRoZSBnaXZlbiBkaXNwbGF5IG9iamVjdCB0b3dhcmRzIHRoZSB4L3kgY29vcmRpbmF0ZXMgYXQgYSBzdGVhZHkgdmVsb2NpdHkuCiAgICAqIElmIHlvdSBzcGVjaWZ5IGEgbWF4VGltZSB0aGVuIGl0IHdpbGwgYWRqdXN0IHRoZSBzcGVlZCAob3Zlci13cml0aW5nIHdoYXQgeW91IHNldCkgc28gaXQgYXJyaXZlcyBhdCB0aGUgZGVzdGluYXRpb24gaW4gdGhhdCBudW1iZXIgb2Ygc2Vjb25kcy4KICAgICogVGltaW5ncyBhcmUgYXBwcm94aW1hdGUgZHVlIHRvIHRoZSB3YXkgYnJvd3NlciB0aW1lcnMgd29yay4gQWxsb3cgZm9yIGEgdmFyaWFuY2Ugb2YgKy0gNTBtcy4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXMgbm90IGNvbnRpbnVvdXNseSB0cmFjayB0aGUgdGFyZ2V0LiBJZiB0aGUgdGFyZ2V0IGNoYW5nZXMgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXQgdGhlIGRpc3BsYXkgb2JqZWN0IHdpbGwgbm90IG1vZGlmeSBpdHMgY291cnNlLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lc24ndCBzdG9wIG1vdmluZyBvbmNlIGl0IHJlYWNoZXMgdGhlIGRlc3RpbmF0aW9uIGNvb3JkaW5hdGVzLgogICAgKiBOb3RlOiBEb2Vzbid0IHRha2UgaW50byBhY2NvdW50IGFjY2VsZXJhdGlvbiwgbWF4VmVsb2NpdHkgb3IgZHJhZyAoaWYgeW91J3ZlIHNldCBkcmFnIG9yIGFjY2VsZXJhdGlvbiB0b28gaGlnaCB0aGlzIG9iamVjdCBtYXkgbm90IG1vdmUgYXQgYWxsKQogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjbW92ZVRvWFkKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIG1vdmUgdG93YXJkcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIHRvIG1vdmUgdG93YXJkcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBtb3ZlLCBpbiBwaXhlbHMgcGVyIHNlY29uZCAoZGVmYXVsdCBpcyA2MCBwaXhlbHMvc2VjKQogICAgKiBAcGFyYW0ge251bWJlcn0gW21heFRpbWU9MF0gLSBUaW1lIGdpdmVuIGluIG1pbGxpc2Vjb25kcyAoMTAwMCA9IDEgc2VjKS4gSWYgc2V0IHRoZSBzcGVlZCBpcyBhZGp1c3RlZCBzbyB0aGUgb2JqZWN0IHdpbGwgYXJyaXZlIGF0IGRlc3RpbmF0aW9uIGluIHRoZSBnaXZlbiBudW1iZXIgb2YgbXMuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIChpbiByYWRpYW5zKSB0aGF0IHRoZSBvYmplY3Qgc2hvdWxkIGJlIHZpc3VhbGx5IHNldCB0byBpbiBvcmRlciB0byBtYXRjaCBpdHMgbmV3IHZlbG9jaXR5LgogICAgKi8KICAgIG1vdmVUb1hZOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgeCwgeSwgc3BlZWQsIG1heFRpbWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCA9PT0gJ3VuZGVmaW5lZCcpIHsgc3BlZWQgPSA2MDsgfQogICAgICAgIGlmICh0eXBlb2YgbWF4VGltZSA9PT0gJ3VuZGVmaW5lZCcpIHsgbWF4VGltZSA9IDA7IH0KCiAgICAgICAgdGhpcy5fYW5nbGUgPSBNYXRoLmF0YW4yKHkgLSBkaXNwbGF5T2JqZWN0LnksIHggLSBkaXNwbGF5T2JqZWN0LngpOwogICAgICAgIAogICAgICAgIGlmIChtYXhUaW1lID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBXZSBrbm93IGhvdyBtYW55IHBpeGVscyB3ZSBuZWVkIHRvIG1vdmUsIGJ1dCBob3cgZmFzdD8KICAgICAgICAgICAgc3BlZWQgPSB0aGlzLmRpc3RhbmNlVG9YWShkaXNwbGF5T2JqZWN0LCB4LCB5KSAvIChtYXhUaW1lIC8gMTAwMCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS52ZWxvY2l0eS54ID0gTWF0aC5jb3ModGhpcy5fYW5nbGUpICogc3BlZWQ7CiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5LnZlbG9jaXR5LnkgPSBNYXRoLnNpbih0aGlzLl9hbmdsZSkgKiBzcGVlZDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX2FuZ2xlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdpdmVuIHRoZSBhbmdsZSAoaW4gZGVncmVlcykgYW5kIHNwZWVkIGNhbGN1bGF0ZSB0aGUgdmVsb2NpdHkgYW5kIHJldHVybiBpdCBhcyBhIFBvaW50IG9iamVjdCwgb3Igc2V0IGl0IHRvIHRoZSBnaXZlbiBwb2ludCBvYmplY3QuCiAgICAqIE9uZSB3YXkgdG8gdXNlIHRoaXMgaXM6IHZlbG9jaXR5RnJvbUFuZ2xlKGFuZ2xlLCAyMDAsIHNwcml0ZS52ZWxvY2l0eSkgd2hpY2ggd2lsbCBzZXQgdGhlIHZhbHVlcyBkaXJlY3RseSB0byB0aGUgc3ByaXRlcyB2ZWxvY2l0eSBhbmQgbm90IGNyZWF0ZSBhIG5ldyBQb2ludCBvYmplY3QuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSN2ZWxvY2l0eUZyb21BbmdsZQogICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgaW4gZGVncmVlcyBjYWxjdWxhdGVkIGluIGNsb2Nrd2lzZSBwb3NpdGl2ZSBkaXJlY3Rpb24gKGRvd24gPSA5MCBkZWdyZWVzIHBvc2l0aXZlLCByaWdodCA9IDAgZGVncmVlcyBwb3NpdGl2ZSwgdXAgPSA5MCBkZWdyZWVzIG5lZ2F0aXZlKQogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkPTYwXSAtIFRoZSBzcGVlZCBpdCB3aWxsIG1vdmUsIGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludHxvYmplY3R9IFtwb2ludF0gLSBUaGUgUG9pbnQgb2JqZWN0IGluIHdoaWNoIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMgd2lsbCBiZSBzZXQgdG8gdGhlIGNhbGN1bGF0ZWQgdmVsb2NpdHkuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gLSBBIFBvaW50IHdoZXJlIHBvaW50LnggY29udGFpbnMgdGhlIHZlbG9jaXR5IHggdmFsdWUgYW5kIHBvaW50LnkgY29udGFpbnMgdGhlIHZlbG9jaXR5IHkgdmFsdWUuCiAgICAqLwogICAgdmVsb2NpdHlGcm9tQW5nbGU6IGZ1bmN0aW9uIChhbmdsZSwgc3BlZWQsIHBvaW50KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBwb2ludCA9IHBvaW50IHx8IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAgICAgcmV0dXJuIHBvaW50LnNldFRvKChNYXRoLmNvcyh0aGlzLmdhbWUubWF0aC5kZWdUb1JhZChhbmdsZSkpICogc3BlZWQpLCAoTWF0aC5zaW4odGhpcy5nYW1lLm1hdGguZGVnVG9SYWQoYW5nbGUpKSAqIHNwZWVkKSk7CgogICAgfSwKCiAgICAvKioKICAgICogR2l2ZW4gdGhlIHJvdGF0aW9uIChpbiByYWRpYW5zKSBhbmQgc3BlZWQgY2FsY3VsYXRlIHRoZSB2ZWxvY2l0eSBhbmQgcmV0dXJuIGl0IGFzIGEgUG9pbnQgb2JqZWN0LCBvciBzZXQgaXQgdG8gdGhlIGdpdmVuIHBvaW50IG9iamVjdC4KICAgICogT25lIHdheSB0byB1c2UgdGhpcyBpczogdmVsb2NpdHlGcm9tUm90YXRpb24ocm90YXRpb24sIDIwMCwgc3ByaXRlLnZlbG9jaXR5KSB3aGljaCB3aWxsIHNldCB0aGUgdmFsdWVzIGRpcmVjdGx5IHRvIHRoZSBzcHJpdGVzIHZlbG9jaXR5IGFuZCBub3QgY3JlYXRlIGEgbmV3IFBvaW50IG9iamVjdC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3ZlbG9jaXR5RnJvbVJvdGF0aW9uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByb3RhdGlvbiAtIFRoZSBhbmdsZSBpbiByYWRpYW5zLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkPTYwXSAtIFRoZSBzcGVlZCBpdCB3aWxsIG1vdmUsIGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludHxvYmplY3R9IFtwb2ludF0gLSBUaGUgUG9pbnQgb2JqZWN0IGluIHdoaWNoIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMgd2lsbCBiZSBzZXQgdG8gdGhlIGNhbGN1bGF0ZWQgdmVsb2NpdHkuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gLSBBIFBvaW50IHdoZXJlIHBvaW50LnggY29udGFpbnMgdGhlIHZlbG9jaXR5IHggdmFsdWUgYW5kIHBvaW50LnkgY29udGFpbnMgdGhlIHZlbG9jaXR5IHkgdmFsdWUuCiAgICAqLwogICAgdmVsb2NpdHlGcm9tUm90YXRpb246IGZ1bmN0aW9uIChyb3RhdGlvbiwgc3BlZWQsIHBvaW50KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBwb2ludCA9IHBvaW50IHx8IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAgICAgcmV0dXJuIHBvaW50LnNldFRvKChNYXRoLmNvcyhyb3RhdGlvbikgKiBzcGVlZCksIChNYXRoLnNpbihyb3RhdGlvbikgKiBzcGVlZCkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdpdmVuIHRoZSByb3RhdGlvbiAoaW4gcmFkaWFucykgYW5kIHNwZWVkIGNhbGN1bGF0ZSB0aGUgYWNjZWxlcmF0aW9uIGFuZCByZXR1cm4gaXQgYXMgYSBQb2ludCBvYmplY3QsIG9yIHNldCBpdCB0byB0aGUgZ2l2ZW4gcG9pbnQgb2JqZWN0LgogICAgKiBPbmUgd2F5IHRvIHVzZSB0aGlzIGlzOiBhY2NlbGVyYXRpb25Gcm9tUm90YXRpb24ocm90YXRpb24sIDIwMCwgc3ByaXRlLmFjY2VsZXJhdGlvbikgd2hpY2ggd2lsbCBzZXQgdGhlIHZhbHVlcyBkaXJlY3RseSB0byB0aGUgc3ByaXRlcyBhY2NlbGVyYXRpb24gYW5kIG5vdCBjcmVhdGUgYSBuZXcgUG9pbnQgb2JqZWN0LgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjYWNjZWxlcmF0aW9uRnJvbVJvdGF0aW9uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByb3RhdGlvbiAtIFRoZSBhbmdsZSBpbiByYWRpYW5zLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkPTYwXSAtIFRoZSBzcGVlZCBpdCB3aWxsIG1vdmUsIGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludHxvYmplY3R9IFtwb2ludF0gLSBUaGUgUG9pbnQgb2JqZWN0IGluIHdoaWNoIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMgd2lsbCBiZSBzZXQgdG8gdGhlIGNhbGN1bGF0ZWQgYWNjZWxlcmF0aW9uLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IC0gQSBQb2ludCB3aGVyZSBwb2ludC54IGNvbnRhaW5zIHRoZSBhY2NlbGVyYXRpb24geCB2YWx1ZSBhbmQgcG9pbnQueSBjb250YWlucyB0aGUgYWNjZWxlcmF0aW9uIHkgdmFsdWUuCiAgICAqLwogICAgYWNjZWxlcmF0aW9uRnJvbVJvdGF0aW9uOiBmdW5jdGlvbiAocm90YXRpb24sIHNwZWVkLCBwb2ludCkgewoKICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgeyBzcGVlZCA9IDYwOyB9CiAgICAgICAgcG9pbnQgPSBwb2ludCB8fCBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgICAgIHJldHVybiBwb2ludC5zZXRUbygoTWF0aC5jb3Mocm90YXRpb24pICogc3BlZWQpLCAoTWF0aC5zaW4ocm90YXRpb24pICogc3BlZWQpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBhY2NlbGVyYXRpb24ueC95IHByb3BlcnR5IG9uIHRoZSBkaXNwbGF5IG9iamVjdCBzbyBpdCB3aWxsIG1vdmUgdG93YXJkcyB0aGUgdGFyZ2V0IGF0IHRoZSBnaXZlbiBzcGVlZCAoaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuKQogICAgKiBZb3UgbXVzdCBnaXZlIGEgbWF4aW11bSBzcGVlZCB2YWx1ZSwgYmV5b25kIHdoaWNoIHRoZSBkaXNwbGF5IG9iamVjdCB3b24ndCBnbyBhbnkgZmFzdGVyLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lcyBub3QgY29udGludW91c2x5IHRyYWNrIHRoZSB0YXJnZXQuIElmIHRoZSB0YXJnZXQgY2hhbmdlcyBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdCB0aGUgZGlzcGxheSBvYmplY3Qgd2lsbCBub3QgbW9kaWZ5IGl0cyBjb3Vyc2UuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2Vzbid0IHN0b3AgbW92aW5nIG9uY2UgaXQgcmVhY2hlcyB0aGUgZGVzdGluYXRpb24gY29vcmRpbmF0ZXMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNhY2NlbGVyYXRlVG9PYmplY3QKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZS4KICAgICogQHBhcmFtIHthbnl9IGRlc3RpbmF0aW9uIC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIG1vdmUgdG93YXJkcy4gQ2FuIGJlIGFueSBvYmplY3QgYnV0IG11c3QgaGF2ZSB2aXNpYmxlIHgveSBwcm9wZXJ0aWVzLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkPTYwXSAtIFRoZSBzcGVlZCBpdCB3aWxsIGFjY2VsZXJhdGUgaW4gcGl4ZWxzIHBlciBzZWNvbmQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeFNwZWVkTWF4PTUwMF0gLSBUaGUgbWF4aW11bSB4IHZlbG9jaXR5IHRoZSBkaXNwbGF5IG9iamVjdCBjYW4gcmVhY2guCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeVNwZWVkTWF4PTUwMF0gLSBUaGUgbWF4aW11bSB5IHZlbG9jaXR5IHRoZSBkaXNwbGF5IG9iamVjdCBjYW4gcmVhY2guCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIChpbiByYWRpYW5zKSB0aGF0IHRoZSBvYmplY3Qgc2hvdWxkIGJlIHZpc3VhbGx5IHNldCB0byBpbiBvcmRlciB0byBtYXRjaCBpdHMgbmV3IHRyYWplY3RvcnkuCiAgICAqLwogICAgYWNjZWxlcmF0ZVRvT2JqZWN0OiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgZGVzdGluYXRpb24sIHNwZWVkLCB4U3BlZWRNYXgsIHlTcGVlZE1heCkgewoKICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgeyBzcGVlZCA9IDYwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB4U3BlZWRNYXggPT09ICd1bmRlZmluZWQnKSB7IHhTcGVlZE1heCA9IDEwMDA7IH0KICAgICAgICBpZiAodHlwZW9mIHlTcGVlZE1heCA9PT0gJ3VuZGVmaW5lZCcpIHsgeVNwZWVkTWF4ID0gMTAwMDsgfQoKICAgICAgICB0aGlzLl9hbmdsZSA9IHRoaXMuYW5nbGVCZXR3ZWVuKGRpc3BsYXlPYmplY3QsIGRlc3RpbmF0aW9uKTsKCiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5LmFjY2VsZXJhdGlvbi5zZXRUbyhNYXRoLmNvcyh0aGlzLl9hbmdsZSkgKiBzcGVlZCwgTWF0aC5zaW4odGhpcy5fYW5nbGUpICogc3BlZWQpOwogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS5tYXhWZWxvY2l0eS5zZXRUbyh4U3BlZWRNYXgsIHlTcGVlZE1heCk7CgogICAgICAgIHJldHVybiB0aGlzLl9hbmdsZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBhY2NlbGVyYXRpb24ueC95IHByb3BlcnR5IG9uIHRoZSBkaXNwbGF5IG9iamVjdCBzbyBpdCB3aWxsIG1vdmUgdG93YXJkcyB0aGUgdGFyZ2V0IGF0IHRoZSBnaXZlbiBzcGVlZCAoaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuKQogICAgKiBZb3UgbXVzdCBnaXZlIGEgbWF4aW11bSBzcGVlZCB2YWx1ZSwgYmV5b25kIHdoaWNoIHRoZSBkaXNwbGF5IG9iamVjdCB3b24ndCBnbyBhbnkgZmFzdGVyLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lcyBub3QgY29udGludW91c2x5IHRyYWNrIHRoZSB0YXJnZXQuIElmIHRoZSB0YXJnZXQgY2hhbmdlcyBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdCB0aGUgZGlzcGxheSBvYmplY3Qgd2lsbCBub3QgbW9kaWZ5IGl0cyBjb3Vyc2UuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2Vzbid0IHN0b3AgbW92aW5nIG9uY2UgaXQgcmVhY2hlcyB0aGUgZGVzdGluYXRpb24gY29vcmRpbmF0ZXMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNhY2NlbGVyYXRlVG9Qb2ludGVyCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIG1vdmUuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IFtwb2ludGVyXSAtIFRoZSBwb2ludGVyIHRvIG1vdmUgdG93YXJkcy4gRGVmYXVsdHMgdG8gUGhhc2VyLklucHV0LmFjdGl2ZVBvaW50ZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BlZWQ9NjBdIC0gVGhlIHNwZWVkIGl0IHdpbGwgYWNjZWxlcmF0ZSBpbiBwaXhlbHMgcGVyIHNlY29uZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt4U3BlZWRNYXg9NTAwXSAtIFRoZSBtYXhpbXVtIHggdmVsb2NpdHkgdGhlIGRpc3BsYXkgb2JqZWN0IGNhbiByZWFjaC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5U3BlZWRNYXg9NTAwXSAtIFRoZSBtYXhpbXVtIHkgdmVsb2NpdHkgdGhlIGRpc3BsYXkgb2JqZWN0IGNhbiByZWFjaC4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgKGluIHJhZGlhbnMpIHRoYXQgdGhlIG9iamVjdCBzaG91bGQgYmUgdmlzdWFsbHkgc2V0IHRvIGluIG9yZGVyIHRvIG1hdGNoIGl0cyBuZXcgdHJhamVjdG9yeS4KICAgICovCiAgICBhY2NlbGVyYXRlVG9Qb2ludGVyOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgcG9pbnRlciwgc3BlZWQsIHhTcGVlZE1heCwgeVNwZWVkTWF4KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBpZiAodHlwZW9mIHBvaW50ZXIgPT09ICd1bmRlZmluZWQnKSB7IHBvaW50ZXIgPSB0aGlzLmdhbWUuaW5wdXQuYWN0aXZlUG9pbnRlcjsgfQogICAgICAgIGlmICh0eXBlb2YgeFNwZWVkTWF4ID09PSAndW5kZWZpbmVkJykgeyB4U3BlZWRNYXggPSAxMDAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB5U3BlZWRNYXggPT09ICd1bmRlZmluZWQnKSB7IHlTcGVlZE1heCA9IDEwMDA7IH0KCiAgICAgICAgdGhpcy5fYW5nbGUgPSB0aGlzLmFuZ2xlVG9Qb2ludGVyKGRpc3BsYXlPYmplY3QsIHBvaW50ZXIpOwogICAgICAgIAogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS5hY2NlbGVyYXRpb24uc2V0VG8oTWF0aC5jb3ModGhpcy5fYW5nbGUpICogc3BlZWQsIE1hdGguc2luKHRoaXMuX2FuZ2xlKSAqIHNwZWVkKTsKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkubWF4VmVsb2NpdHkuc2V0VG8oeFNwZWVkTWF4LCB5U3BlZWRNYXgpOwoKICAgICAgICByZXR1cm4gdGhpcy5fYW5nbGU7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgYWNjZWxlcmF0aW9uLngveSBwcm9wZXJ0eSBvbiB0aGUgZGlzcGxheSBvYmplY3Qgc28gaXQgd2lsbCBtb3ZlIHRvd2FyZHMgdGhlIHgveSBjb29yZGluYXRlcyBhdCB0aGUgZ2l2ZW4gc3BlZWQgKGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLikKICAgICogWW91IG11c3QgZ2l2ZSBhIG1heGltdW0gc3BlZWQgdmFsdWUsIGJleW9uZCB3aGljaCB0aGUgZGlzcGxheSBvYmplY3Qgd29uJ3QgZ28gYW55IGZhc3Rlci4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXMgbm90IGNvbnRpbnVvdXNseSB0cmFjayB0aGUgdGFyZ2V0LiBJZiB0aGUgdGFyZ2V0IGNoYW5nZXMgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXQgdGhlIGRpc3BsYXkgb2JqZWN0IHdpbGwgbm90IG1vZGlmeSBpdHMgY291cnNlLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lc24ndCBzdG9wIG1vdmluZyBvbmNlIGl0IHJlYWNoZXMgdGhlIGRlc3RpbmF0aW9uIGNvb3JkaW5hdGVzLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjYWNjZWxlcmF0ZVRvWFkKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIGFjY2VsZXJhdGUgdG93YXJkcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIHRvIGFjY2VsZXJhdGUgdG93YXJkcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBhY2NlbGVyYXRlIGluIHBpeGVscyBwZXIgc2Vjb25kLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3hTcGVlZE1heD01MDBdIC0gVGhlIG1heGltdW0geCB2ZWxvY2l0eSB0aGUgZGlzcGxheSBvYmplY3QgY2FuIHJlYWNoLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3lTcGVlZE1heD01MDBdIC0gVGhlIG1heGltdW0geSB2ZWxvY2l0eSB0aGUgZGlzcGxheSBvYmplY3QgY2FuIHJlYWNoLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSAoaW4gcmFkaWFucykgdGhhdCB0aGUgb2JqZWN0IHNob3VsZCBiZSB2aXN1YWxseSBzZXQgdG8gaW4gb3JkZXIgdG8gbWF0Y2ggaXRzIG5ldyB0cmFqZWN0b3J5LgogICAgKi8KICAgIGFjY2VsZXJhdGVUb1hZOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgeCwgeSwgc3BlZWQsIHhTcGVlZE1heCwgeVNwZWVkTWF4KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBpZiAodHlwZW9mIHhTcGVlZE1heCA9PT0gJ3VuZGVmaW5lZCcpIHsgeFNwZWVkTWF4ID0gMTAwMDsgfQogICAgICAgIGlmICh0eXBlb2YgeVNwZWVkTWF4ID09PSAndW5kZWZpbmVkJykgeyB5U3BlZWRNYXggPSAxMDAwOyB9CgogICAgICAgIHRoaXMuX2FuZ2xlID0gdGhpcy5hbmdsZVRvWFkoZGlzcGxheU9iamVjdCwgeCwgeSk7CgogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS5hY2NlbGVyYXRpb24uc2V0VG8oTWF0aC5jb3ModGhpcy5fYW5nbGUpICogc3BlZWQsIE1hdGguc2luKHRoaXMuX2FuZ2xlKSAqIHNwZWVkKTsKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkubWF4VmVsb2NpdHkuc2V0VG8oeFNwZWVkTWF4LCB5U3BlZWRNYXgpOwoKICAgICAgICByZXR1cm4gdGhpcy5fYW5nbGU7CgogICAgfSwKCiAgICAvKioKICAgICogRmluZCB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0d28gZGlzcGxheSBvYmplY3RzIChsaWtlIFNwcml0ZXMpLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjZGlzdGFuY2VCZXR3ZWVuCiAgICAqIEBwYXJhbSB7YW55fSBzb3VyY2UgLSBUaGUgRGlzcGxheSBPYmplY3QgdG8gdGVzdCBmcm9tLgogICAgKiBAcGFyYW0ge2FueX0gdGFyZ2V0IC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgdG8uCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhlIHNvdXJjZSBhbmQgdGFyZ2V0IG9iamVjdHMuCiAgICAqLwogICAgZGlzdGFuY2VCZXR3ZWVuOiBmdW5jdGlvbiAoc291cmNlLCB0YXJnZXQpIHsKCiAgICAgICAgdGhpcy5fZHggPSBzb3VyY2UueCAtIHRhcmdldC54OwogICAgICAgIHRoaXMuX2R5ID0gc291cmNlLnkgLSB0YXJnZXQueTsKICAgICAgICAKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuX2R4ICogdGhpcy5fZHggKyB0aGlzLl9keSAqIHRoaXMuX2R5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBGaW5kIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIGEgZGlzcGxheSBvYmplY3QgKGxpa2UgYSBTcHJpdGUpIGFuZCB0aGUgZ2l2ZW4geC95IGNvb3JkaW5hdGVzLgogICAgKiBUaGUgY2FsY3VsYXRpb24gaXMgbWFkZSBmcm9tIHRoZSBkaXNwbGF5IG9iamVjdHMgeC95IGNvb3JkaW5hdGUuIFRoaXMgbWF5IGJlIHRoZSB0b3AtbGVmdCBpZiBpdHMgYW5jaG9yIGhhc24ndCBiZWVuIGNoYW5nZWQuCiAgICAqIElmIHlvdSBuZWVkIHRvIGNhbGN1bGF0ZSBmcm9tIHRoZSBjZW50ZXIgb2YgYSBkaXNwbGF5IG9iamVjdCBpbnN0ZWFkIHVzZSB0aGUgbWV0aG9kIGRpc3RhbmNlQmV0d2VlbkNlbnRlcnMoKQogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjZGlzdGFuY2VUb1hZCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgZnJvbS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIG1vdmUgdG93YXJkcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIHRvIG1vdmUgdG93YXJkcy4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgb2JqZWN0IGFuZCB0aGUgeC95IGNvb3JkaW5hdGVzLgogICAgKi8KICAgIGRpc3RhbmNlVG9YWTogZnVuY3Rpb24gKGRpc3BsYXlPYmplY3QsIHgsIHkpIHsKCiAgICAgICAgdGhpcy5fZHggPSBkaXNwbGF5T2JqZWN0LnggLSB4OwogICAgICAgIHRoaXMuX2R5ID0gZGlzcGxheU9iamVjdC55IC0geTsKICAgICAgICAKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuX2R4ICogdGhpcy5fZHggKyB0aGlzLl9keSAqIHRoaXMuX2R5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBGaW5kIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIGEgZGlzcGxheSBvYmplY3QgKGxpa2UgYSBTcHJpdGUpIGFuZCBhIFBvaW50ZXIuIElmIG5vIFBvaW50ZXIgaXMgZ2l2ZW4gdGhlIElucHV0LmFjdGl2ZVBvaW50ZXIgaXMgdXNlZC4KICAgICogVGhlIGNhbGN1bGF0aW9uIGlzIG1hZGUgZnJvbSB0aGUgZGlzcGxheSBvYmplY3RzIHgveSBjb29yZGluYXRlLiBUaGlzIG1heSBiZSB0aGUgdG9wLWxlZnQgaWYgaXRzIGFuY2hvciBoYXNuJ3QgYmVlbiBjaGFuZ2VkLgogICAgKiBJZiB5b3UgbmVlZCB0byBjYWxjdWxhdGUgZnJvbSB0aGUgY2VudGVyIG9mIGEgZGlzcGxheSBvYmplY3QgaW5zdGVhZCB1c2UgdGhlIG1ldGhvZCBkaXN0YW5jZUJldHdlZW5DZW50ZXJzKCkKICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2Rpc3RhbmNlVG9Qb2ludGVyCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgZnJvbS4KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gW3BvaW50ZXJdIC0gVGhlIFBoYXNlci5Qb2ludGVyIHRvIHRlc3QgdG8uIElmIG5vbmUgaXMgZ2l2ZW4gdGhlbiBJbnB1dC5hY3RpdmVQb2ludGVyIGlzIHVzZWQuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhlIG9iamVjdCBhbmQgdGhlIFBvaW50ZXIuCiAgICAqLwogICAgZGlzdGFuY2VUb1BvaW50ZXI6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCBwb2ludGVyKSB7CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IHRoaXMuZ2FtZS5pbnB1dC5hY3RpdmVQb2ludGVyOwoKICAgICAgICB0aGlzLl9keCA9IGRpc3BsYXlPYmplY3QueCAtIHBvaW50ZXIueDsKICAgICAgICB0aGlzLl9keSA9IGRpc3BsYXlPYmplY3QueSAtIHBvaW50ZXIueTsKICAgICAgICAKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuX2R4ICogdGhpcy5fZHggKyB0aGlzLl9keSAqIHRoaXMuX2R5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBGaW5kIHRoZSBhbmdsZSBpbiByYWRpYW5zIGJldHdlZW4gdHdvIGRpc3BsYXkgb2JqZWN0cyAobGlrZSBTcHJpdGVzKS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2FuZ2xlQmV0d2VlbgogICAgKiBAcGFyYW0ge2FueX0gc291cmNlIC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgZnJvbS4KICAgICogQHBhcmFtIHthbnl9IHRhcmdldCAtIFRoZSBEaXNwbGF5IE9iamVjdCB0byB0ZXN0IHRvLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSBpbiByYWRpYW5zIGJldHdlZW4gdGhlIHNvdXJjZSBhbmQgdGFyZ2V0IGRpc3BsYXkgb2JqZWN0cy4KICAgICovCiAgICBhbmdsZUJldHdlZW46IGZ1bmN0aW9uIChzb3VyY2UsIHRhcmdldCkgewoKICAgICAgICB0aGlzLl9keCA9IHRhcmdldC54IC0gc291cmNlLng7CiAgICAgICAgdGhpcy5fZHkgPSB0YXJnZXQueSAtIHNvdXJjZS55OwoKICAgICAgICByZXR1cm4gTWF0aC5hdGFuMih0aGlzLl9keSwgdGhpcy5fZHgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEZpbmQgdGhlIGFuZ2xlIGluIHJhZGlhbnMgYmV0d2VlbiBhIGRpc3BsYXkgb2JqZWN0IChsaWtlIGEgU3ByaXRlKSBhbmQgdGhlIGdpdmVuIHgveSBjb29yZGluYXRlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjYW5nbGVUb1hZCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgZnJvbS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIGdldCB0aGUgYW5nbGUgdG8uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSB0byBnZXQgdGhlIGFuZ2xlIHRvLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSBpbiByYWRpYW5zIGJldHdlZW4gZGlzcGxheU9iamVjdC54L3kgdG8gUG9pbnRlci54L3kKICAgICovCiAgICBhbmdsZVRvWFk6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCB4LCB5KSB7CgogICAgICAgIHRoaXMuX2R4ID0geCAtIGRpc3BsYXlPYmplY3QueDsKICAgICAgICB0aGlzLl9keSA9IHkgLSBkaXNwbGF5T2JqZWN0Lnk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIE1hdGguYXRhbjIodGhpcy5fZHksIHRoaXMuX2R4KTsKCiAgICB9LAogICAgCiAgICAvKioKICAgICogRmluZCB0aGUgYW5nbGUgaW4gcmFkaWFucyBiZXR3ZWVuIGEgZGlzcGxheSBvYmplY3QgKGxpa2UgYSBTcHJpdGUpIGFuZCBhIFBvaW50ZXIsIHRha2luZyB0aGVpciB4L3kgYW5kIGNlbnRlciBpbnRvIGFjY291bnQuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNhbmdsZVRvUG9pbnRlcgogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBEaXNwbGF5IE9iamVjdCB0byB0ZXN0IGZyb20uCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IFtwb2ludGVyXSAtIFRoZSBQaGFzZXIuUG9pbnRlciB0byB0ZXN0IHRvLiBJZiBub25lIGlzIGdpdmVuIHRoZW4gSW5wdXQuYWN0aXZlUG9pbnRlciBpcyB1c2VkLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSBpbiByYWRpYW5zIGJldHdlZW4gZGlzcGxheU9iamVjdC54L3kgdG8gUG9pbnRlci54L3kKICAgICovCiAgICBhbmdsZVRvUG9pbnRlcjogZnVuY3Rpb24gKGRpc3BsYXlPYmplY3QsIHBvaW50ZXIpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgdGhpcy5nYW1lLmlucHV0LmFjdGl2ZVBvaW50ZXI7CgogICAgICAgIHRoaXMuX2R4ID0gcG9pbnRlci53b3JsZFggLSBkaXNwbGF5T2JqZWN0Lng7CiAgICAgICAgdGhpcy5fZHkgPSBwb2ludGVyLndvcmxkWSAtIGRpc3BsYXlPYmplY3QueTsKICAgICAgICAKICAgICAgICByZXR1cm4gTWF0aC5hdGFuMih0aGlzLl9keSwgdGhpcy5fZHgpOwoKICAgIH0KCn07CgpQaGFzZXIuUGh5c2ljcy5BcmNhZGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIFBoeXNpY3MgQm9keSBpcyBsaW5rZWQgdG8gYSBzaW5nbGUgU3ByaXRlIGFuZCBkZWZpbmVzIHByb3BlcnRpZXMgdGhhdCBkZXRlcm1pbmUgaG93IHRoZSBwaHlzaWNzIGJvZHkgaXMgc2ltdWxhdGVkLgoqIFRoZXNlIHByb3BlcnRpZXMgYWZmZWN0IGhvdyB0aGUgYm9keSByZWFjdHMgdG8gZm9yY2VzLCB3aGF0IGZvcmNlcyBpdCBnZW5lcmF0ZXMgb24gaXRzZWxmICh0byBzaW11bGF0ZSBmcmljdGlvbiksIGFuZCBob3cgaXQgcmVhY3RzIHRvIGNvbGxpc2lvbnMgaW4gdGhlIHNjZW5lLiBJbiBtb3N0IGNhc2VzLCB0aGUgcHJvcGVydGllcyBhcmUgdXNlZCB0byBzaW11bGF0ZSBwaHlzaWNhbCBlZmZlY3RzLgoqIEVhY2ggYm9keSBhbHNvIGhhcyBpdHMgb3duIHByb3BlcnR5IHZhbHVlcyB0aGF0IGRldGVybWluZSBleGFjdGx5IGhvdyBpdCByZWFjdHMgdG8gZm9yY2VzIGFuZCBjb2xsaXNpb25zIGluIHRoZSBzY2VuZS4KKgoqIEBjbGFzcyBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keQoqIEBjbGFzc2Rlc2MgQXJjYWRlIFBoeXNpY3MgQm9keSBDb25zdHJ1Y3RvcgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gVGhlIFNwcml0ZSBvYmplY3QgdGhpcyBwaHlzaWNzIGJvZHkgYmVsb25ncyB0by4KKi8KUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkgPSBmdW5jdGlvbiAoc3ByaXRlKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gUmVmZXJlbmNlIHRvIHRoZSBwYXJlbnQgU3ByaXRlLgogICAgKi8KICAgIHRoaXMuc3ByaXRlID0gc3ByaXRlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gc3ByaXRlLmdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBvZmZzZXQgLSBUaGUgb2Zmc2V0IG9mIHRoZSBQaHlzaWNzIEJvZHkgZnJvbSB0aGUgU3ByaXRlIHgveSBwb3NpdGlvbi4KICAgICovCiAgICB0aGlzLm9mZnNldCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHByZVggLSBUaGUgcHJldmlvdXMgeCBwb3NpdGlvbiBvZiB0aGUgcGh5c2ljcyBib2R5LgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnByZVggPSBzcHJpdGUud29ybGQueDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHByZVkgLSBUaGUgcHJldmlvdXMgeSBwb3NpdGlvbiBvZiB0aGUgcGh5c2ljcyBib2R5LgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLnByZVkgPSBzcHJpdGUud29ybGQueTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHByZVJvdGF0aW9uIC0gVGhlIHByZXZpb3VzIHJvdGF0aW9uIG9mIHRoZSBwaHlzaWNzIGJvZHkuCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMucHJlUm90YXRpb24gPSBzcHJpdGUuYW5nbGU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSB2ZWxvY2l0eSAtIFRoZSB2ZWxvY2l0eSBvZiB0aGUgQm9keS4KICAgICovCiAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFBoYXNlci5Qb2ludCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYWNjZWxlcmF0aW9uIC0gVGhlIGFjY2VsZXJhdGlvbiBpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4gb2YgdGhlIEJvZHkuCiAgICAqLwogICAgdGhpcy5hY2NlbGVyYXRpb24gPSBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzcGVlZCAtIFRoZSBzcGVlZCBpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4gb2YgdGhlIEJvZHkuCiAgICAqLwogICAgdGhpcy5zcGVlZCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBvZiB0aGUgQm9keSBiYXNlZCBvbiBpdHMgdmVsb2NpdHkgaW4gcmFkaWFucy4KICAgICovCiAgICB0aGlzLmFuZ2xlID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGdyYXZpdHkgLSBUaGUgZ3Jhdml0eSBhcHBsaWVkIHRvIHRoZSBtb3Rpb24gb2YgdGhlIEJvZHkuIFRoaXMgd29ya3MgaW4gYWRkaXRpb24gdG8gYW55IGdyYXZpdHkgc2V0IG9uIHRoZSB3b3JsZC4KICAgICovCiAgICB0aGlzLmdyYXZpdHkgPSBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBib3VuY2UgLSBUaGUgZWxhc3RpY2l0aXkgb2YgdGhlIEJvZHkgd2hlbiBjb2xsaWRpbmcuIFRoaXMgcHJvcGVydHkgZGV0ZXJtaW5lcyBob3cgbXVjaCBlbmVyZ3kgYSBib2R5IG1haW50YWlucyBkdXJpbmcgYSBjb2xsaXNpb24sIGkuZS4gaXRzIGJvdW5jaW5lc3MuCiAgICAqLwogICAgdGhpcy5ib3VuY2UgPSBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBtaW5WZWxvY2l0eSAtIFdoZW4gYSBib2R5IHJlYm91bmRzIG9mZiBhbm90aGVyIGJvZHkgb3IgYSB3YWxsIHRoZSBtaW5WZWxvY2l0eSBpcyBjaGVja2VkLiBJZiB0aGUgbmV3IHZlbG9jaXR5IGlzIGxvd2VyIHRoYW4gbWluVmVsb2NpdHkgdGhlIGJvZHkgaXMgc3RvcHBlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1pblZlbG9jaXR5ID0gbmV3IFBoYXNlci5Qb2ludCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gbWF4VmVsb2NpdHkgLSBUaGUgbWF4aW11bSB2ZWxvY2l0eSB0aGF0IHRoZSBCb2R5IGNhbiByZWFjaC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1heFZlbG9jaXR5ID0gbmV3IFBoYXNlci5Qb2ludCgxMDAwLCAxMDAwKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ3VsYXJWZWxvY2l0eSAtIFRoZSBhbmd1bGFyIHZlbG9jaXR5IG9mIHRoZSBCb2R5LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ3VsYXJBY2NlbGVyYXRpb24gLSBUaGUgYW5ndWxhciBhY2NlbGVyYXRpb24gb2YgdGhlIEJvZHkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbmd1bGFyQWNjZWxlcmF0aW9uID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ3VsYXJEcmFnIC0gYW5ndWxhckRyYWcgaXMgdXNlZCB0byBjYWxjdWxhdGUgZnJpY3Rpb24gb24gdGhlIGJvZHkgYXMgaXQgcm90YXRlcy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFuZ3VsYXJEcmFnID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heEFuZ3VsYXIgLSBUaGUgbWF4aW11bSBhbmd1bGFyIHZlbG9jaXR5IHRoYXQgdGhlIEJvZHkgY2FuIHJlYWNoLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWF4QW5ndWxhciA9IDEwMDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYXNzIC0gVGhlIG1hc3MgcHJvcGVydHkgZGV0ZXJtaW5lcyBob3cgZm9yY2VzIGFmZmVjdCB0aGUgYm9keSwgYXMgd2VsbCBhcyBob3cgbXVjaCBtb21lbnR1bSB0aGUgYm9keSBoYXMgd2hlbiBpdCBpcyBpbnZvbHZlZCBpbiBhIGNvbGxpc2lvbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1hc3MgPSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbGluZWFyRGFtcGluZyAtIGxpbmVhckRhbXBpbmcgaXMgdXNlZCB0byBjYWxjdWxhdGUgZnJpY3Rpb24gb24gdGhlIGJvZHkgYXMgaXQgbW92ZXMgdGhyb3VnaCB0aGUgd29ybGQuIEZvciBleGFtcGxlLCB0aGlzIG1pZ2h0IGJlIHVzZWQgdG8gc2ltdWxhdGUgYWlyIG9yIHdhdGVyIGZyaWN0aW9uLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubGluZWFyRGFtcGluZyA9IDAuMDsKCiAgICAvKioKICAgICogU2V0IHRoZSBjaGVja0NvbGxpc2lvbiBwcm9wZXJ0aWVzIHRvIGNvbnRyb2wgd2hpY2ggZGlyZWN0aW9ucyBjb2xsaXNpb24gaXMgcHJvY2Vzc2VkIGZvciB0aGlzIEJvZHkuCiAgICAqIEZvciBleGFtcGxlIGNoZWNrQ29sbGlzaW9uLnVwID0gZmFsc2UgbWVhbnMgaXQgd29uJ3QgY29sbGlkZSB3aGVuIHRoZSBjb2xsaXNpb24gaGFwcGVuZWQgd2hpbGUgbW92aW5nIHVwLgogICAgKiBAcHJvcGVydHkge29iamVjdH0gY2hlY2tDb2xsaXNpb24gLSBBbiBvYmplY3QgY29udGFpbmluZyBhbGxvd2VkIGNvbGxpc2lvbi4KICAgICovCiAgICB0aGlzLmNoZWNrQ29sbGlzaW9uID0geyBub25lOiBmYWxzZSwgYW55OiB0cnVlLCB1cDogdHJ1ZSwgZG93bjogdHJ1ZSwgbGVmdDogdHJ1ZSwgcmlnaHQ6IHRydWUgfTsKCiAgICAvKioKICAgICogVGhpcyBvYmplY3QgaXMgcG9wdWxhdGVkIHdpdGggYm9vbGVhbiB2YWx1ZXMgd2hlbiB0aGUgQm9keSBjb2xsaWRlcyB3aXRoIGFub3RoZXIuCiAgICAqIHRvdWNoaW5nLnVwID0gdHJ1ZSBtZWFucyB0aGUgY29sbGlzaW9uIGhhcHBlbmVkIHRvIHRoZSB0b3Agb2YgdGhpcyBCb2R5IGZvciBleGFtcGxlLgogICAgKiBAcHJvcGVydHkge29iamVjdH0gdG91Y2hpbmcgLSBBbiBvYmplY3QgY29udGFpbmluZyB0b3VjaGluZyByZXN1bHRzLgogICAgKi8KICAgIHRoaXMudG91Y2hpbmcgPSB7IG5vbmU6IHRydWUsIHVwOiBmYWxzZSwgZG93bjogZmFsc2UsIGxlZnQ6IGZhbHNlLCByaWdodDogZmFsc2UgfTsKCiAgICAvKioKICAgICogVGhpcyBvYmplY3QgaXMgcG9wdWxhdGVkIHdpdGggYm9vbGVhbiB2YWx1ZXMgd2hlbiB0aGUgQm9keSBjb2xsaWRlcyB3aXRoIHRoZSBXb3JsZCBib3VuZHMgb3IgYSBUaWxlLgogICAgKiBGb3IgZXhhbXBsZSBpZiBibG9ja2VkLnVwIGlzIHRydWUgdGhlbiB0aGUgQm9keSBjYW5ub3QgbW92ZSB1cC4KICAgICogQHByb3BlcnR5IHtvYmplY3R9IGJsb2NrZWQgLSBBbiBvYmplY3QgY29udGFpbmluZyBvbiB3aGljaCBmYWNlcyB0aGlzIEJvZHkgaXMgYmxvY2tlZCBmcm9tIG1vdmluZywgaWYgYW55LgogICAgKi8KICAgIHRoaXMuYmxvY2tlZCA9IHsgeDogMCwgeTogMCwgdXA6IGZhbHNlLCBkb3duOiBmYWxzZSwgbGVmdDogZmFsc2UsIHJpZ2h0OiBmYWxzZSB9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZmFjaW5nIC0gQSBjb25zdCByZWZlcmVuY2UgdG8gdGhlIGRpcmVjdGlvbiB0aGUgQm9keSBpcyB0cmF2ZWxpbmcgb3IgZmFjaW5nLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZmFjaW5nID0gUGhhc2VyLk5PTkU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcmVib3VuZCAtIEEgQm9keSBzZXQgdG8gcmVib3VuZCB3aWxsIGV4Y2hhbmdlIHZlbG9jaXR5IHdpdGggYW5vdGhlciBCb2R5IGR1cmluZyBjb2xsaXNpb24uIFNldCB0byBmYWxzZSB0byBhbGxvdyB0aGlzIGJvZHkgdG8gYmUgJ3B1c2hlZCcgcmF0aGVyIHRoYW4gZXhjaGFuZ2UgdmVsb2NpdHkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5yZWJvdW5kID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpbW1vdmFibGUgLSBBbiBpbW1vdmFibGUgQm9keSB3aWxsIG5vdCByZWNlaXZlIGFueSBpbXBhY3RzIG9yIGV4Y2hhbmdlcyBvZiB2ZWxvY2l0eSBmcm9tIG90aGVyIGJvZGllcy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmltbW92YWJsZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG1vdmVzIC0gU2V0IHRvIHRydWUgdG8gYWxsb3cgdGhlIFBoeXNpY3Mgc3lzdGVtIChzdWNoIGFzIHZlbG9jaXR5KSB0byBtb3ZlIHRoaXMgQm9keSwgb3IgZmFsc2UgdG8gbW92ZSBpdCBtYW51YWxseS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1vdmVzID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHJvdGF0aW9uIC0gVGhlIGFtb3VudCB0aGUgcGFyZW50IFNwcml0ZSBpcyByb3RhdGVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucm90YXRpb24gPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsbG93Um90YXRpb24gLSBBbGxvdyBhbmd1bGFyIHJvdGF0aW9uPyBUaGlzIHdpbGwgY2F1c2UgdGhlIFNwcml0ZSB0byBiZSByb3RhdGVkIHZpYSBhbmd1bGFyVmVsb2NpdHksIGV0Yy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFsbG93Um90YXRpb24gPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsbG93R3Jhdml0eSAtIEFsbG93IHRoaXMgQm9keSB0byBiZSBpbmZsdWVuY2VkIGJ5IHRoZSBnbG9iYWwgR3Jhdml0eSB2YWx1ZT8gTm90ZTogSXQgd2lsbCBhbHdheXMgYmUgaW5mbHVlbmNlZCBieSB0aGUgbG9jYWwgZ3Jhdml0eSBpZiBzZXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbGxvd0dyYXZpdHkgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBjdXN0b21TZXBhcmF0ZUNhbGxiYWNrIC0gSWYgc2V0IHRoaXMgY2FsbGJhY2sgd2lsbCBiZSB1c2VkIGZvciBCb2R5IHNlcGFyYXRpb24gaW5zdGVhZCBvZiB0aGUgYnVpbHQtaW4gb25lLiBDYWxsYmFjayBzaG91bGQgcmV0dXJuIHRydWUgaWYgc2VwYXJhdGVkLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jdXN0b21TZXBhcmF0ZUNhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IGN1c3RvbVNlcGFyYXRlQ29udGV4dCAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRoZSBjdXN0b21TZXBhcmF0ZUNhbGxiYWNrIGlzIGNhbGxlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmN1c3RvbVNlcGFyYXRlQ29udGV4dCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IGNvbGxpZGVDYWxsYmFjayAtIElmIHNldCB0aGlzIGNhbGxiYWNrIHdpbGwgYmUgZmlyZWQgd2hlbmV2ZXIgdGhpcyBCb2R5IGlzIGhpdCAob24gYW55IGZhY2UpLiBJdCB3aWxsIHNlbmQgdGhyZWUgcGFyYW1ldGVycywgdGhlIGZhY2UgaXQgaGl0IG9uLCB0aGlzIEJvZHkgYW5kIHRoZSBCb2R5IHRoYXQgaGl0IGl0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29sbGlkZUNhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IGNvbGxpZGVDYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY29sbGlkZUNhbGxiYWNrIGlzIGNhbGxlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNvbGxpZGVDYWxsYmFja0NvbnRleHQgPSBudWxsOwoKICAgIC8qKgogICAgKiBBIEJvZHkgY2FuIGJlIHNldCB0byBjb2xsaWRlIGFnYWluc3QgdGhlIFdvcmxkIGJvdW5kcyBhdXRvbWF0aWNhbGx5IGFuZCByZWJvdW5kIGJhY2sgaW50byB0aGUgV29ybGQgaWYgdGhpcyBpcyBzZXQgdG8gdHJ1ZS4gT3RoZXJ3aXNlIGl0IHdpbGwgbGVhdmUgdGhlIFdvcmxkLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbGxpZGVXb3JsZEJvdW5kcyAtIFNob3VsZCB0aGUgQm9keSBjb2xsaWRlIHdpdGggdGhlIFdvcmxkIGJvdW5kcz8KICAgICovCiAgICB0aGlzLmNvbGxpZGVXb3JsZEJvdW5kcyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5SRUNUfFBoYXNlci5QaHlzaWNzLkFyY2FkZS5DSVJDTEV9IHR5cGUgLSBUaGUgdHlwZSBvZiBTQVQgU2hhcGUuCiAgICAqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLlJFQ1Q7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7U0FULkJveHxTQVQuQ2lyY2xlfFNBVC5Qb2x5Z29ufSBzaGFwZSAtIFRoZSBTQVQgQ29sbGlzaW9uIHNoYXBlLgogICAgKi8KICAgIHRoaXMuc2hhcGUgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1NBVC5Qb2x5Z29ufSBwb2x5Z29uIC0gVGhlIFNBVCBQb2x5Z29ucywgYXMgZGVyaXZlZCBmcm9tIHRoZSBTaGFwZS4KICAgICovCiAgICB0aGlzLnBvbHlnb24gPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbGVmdCAtIFRoZSBsZWZ0LW1vc3QgcG9pbnQgb2YgdGhpcyBCb2R5LgogICAgKiBAcmVhZG9ubHkKICAgICovCiAgICB0aGlzLmxlZnQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcmlnaHQgLSBUaGUgcmlnaHQtbW9zdCBwb2ludCBvZiB0aGlzIEJvZHkuCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMucmlnaHQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdG9wIC0gVGhlIHRvcC1tb3N0IHBvaW50IG9mIHRoaXMgQm9keS4KICAgICogQHJlYWRvbmx5CiAgICAqLwogICAgdGhpcy50b3AgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gYm90dG9tIC0gVGhlIGJvdHRvbS1tb3N0IHBvaW50IG9mIHRoaXMgQm9keS4KICAgICogQHJlYWRvbmx5CiAgICAqLwogICAgdGhpcy5ib3R0b20gPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBUaGUgY3VycmVudCB3aWR0aCBvZiB0aGUgQm9keSwgdGFraW5nIGludG8gYWNjb3VudCB0aGUgcG9pbnQgcm90YXRpb24uCiAgICAqIEByZWFkb25seQogICAgKi8KICAgIHRoaXMud2lkdGggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gVGhlIGN1cnJlbnQgaGVpZ2h0IG9mIHRoZSBCb2R5LCB0YWtpbmcgaW50byBhY2NvdW50IHRoZSBwb2ludCByb3RhdGlvbi4KICAgICogQHJlYWRvbmx5CiAgICAqLwogICAgdGhpcy5oZWlnaHQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5PFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5Pn0gY29udGFjdHMgLSBVc2VkIHRvIHN0b3JlIHJlZmVyZW5jZXMgdG8gYm9kaWVzIHRoaXMgQm9keSBpcyBpbiBjb250YWN0IHdpdGguCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB0aGlzLmNvbnRhY3RzID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBvdmVybGFwWCAtIE1vc3RseSB1c2VkIGludGVybmFsbHkgdG8gc3RvcmUgdGhlIG92ZXJsYXAgdmFsdWVzIGZyb20gVGlsZSBzZXBlcmF0aW9uLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdGhpcy5vdmVybGFwWCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBvdmVybGFwWSAtIE1vc3RseSB1c2VkIGludGVybmFsbHkgdG8gc3RvcmUgdGhlIG92ZXJsYXAgdmFsdWVzIGZyb20gVGlsZSBzZXBlcmF0aW9uLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdGhpcy5vdmVybGFwWSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBfdGVtcCAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90ZW1wID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9keCAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9keCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZHkgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZHkgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3N4IC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3N4ID0gc3ByaXRlLnNjYWxlLng7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfc3kgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fc3kgPSBzcHJpdGUuc2NhbGUueTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gX2Rpc3RhbmNlcyAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9kaXN0YW5jZXMgPSBbMCwgMCwgMCwgMF07CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdnggLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdnggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3Z5IC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3Z5ID0gMDsKCiAgICAvLyAgU2V0LXVwIHRoZSBkZWZhdWx0IHNoYXBlCiAgICB0aGlzLnNldFJlY3RhbmdsZShzcHJpdGUud2lkdGgsIHNwcml0ZS5oZWlnaHQsIDAsIDApOwoKICAgIC8vICBTZXQtdXAgY29udGFjdCBldmVudHMKICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbkJlZ2luQ29udGFjdCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICB0aGlzLnNwcml0ZS5ldmVudHMub25FbmRDb250YWN0ID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCn07CgpQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZCB0aGF0IHVwZGF0ZXMgdGhlIEJvZHkgc2NhbGUgaW4gcmVsYXRpb24gdG8gdGhlIHBhcmVudCBTcHJpdGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjdXBkYXRlU2NhbGUKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHVwZGF0ZVNjYWxlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnBvbHlnb24pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnBvbHlnb24uc2NhbGUodGhpcy5zcHJpdGUuc2NhbGUueCAvIHRoaXMuX3N4LCB0aGlzLnNwcml0ZS5zY2FsZS55IC8gdGhpcy5fc3kpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNoYXBlLnIgKj0gTWF0aC5tYXgodGhpcy5zcHJpdGUuc2NhbGUueCwgdGhpcy5zcHJpdGUuc2NhbGUueSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9zeCA9IHRoaXMuc3ByaXRlLnNjYWxlLng7CiAgICAgICAgdGhpcy5fc3kgPSB0aGlzLnNwcml0ZS5zY2FsZS55OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZCB0aGF0IHVwZGF0ZXMgdGhlIEJvZHkgcG9zaXRpb24gaW4gcmVsYXRpb24gdG8gdGhlIHBhcmVudCBTcHJpdGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjcHJlVXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwcmVVcGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy54ID0gKHRoaXMuc3ByaXRlLndvcmxkLnggLSAodGhpcy5zcHJpdGUuYW5jaG9yLnggKiB0aGlzLnNwcml0ZS53aWR0aCkpICsgdGhpcy5vZmZzZXQueDsKICAgICAgICB0aGlzLnkgPSAodGhpcy5zcHJpdGUud29ybGQueSAtICh0aGlzLnNwcml0ZS5hbmNob3IueSAqIHRoaXMuc3ByaXRlLmhlaWdodCkpICsgdGhpcy5vZmZzZXQueTsKCiAgICAgICAgLy8gIFRoaXMgY292ZXJzIGFueSBtb3Rpb24gdGhhdCBoYXBwZW5zIGR1cmluZyB0aGlzIGZyYW1lLCBub3Qgc2luY2UgdGhlIGxhc3QgZnJhbWUKICAgICAgICB0aGlzLnByZVggPSB0aGlzLng7CiAgICAgICAgdGhpcy5wcmVZID0gdGhpcy55OwogICAgICAgIHRoaXMucHJlUm90YXRpb24gPSB0aGlzLnNwcml0ZS5hbmdsZTsKCiAgICAgICAgdGhpcy5yb3RhdGlvbiA9IHRoaXMucHJlUm90YXRpb247CgogICAgICAgIGlmICh0aGlzLnNwcml0ZS5zY2FsZS54ICE9PSB0aGlzLl9zeCB8fCB0aGlzLnNwcml0ZS5zY2FsZS55ICE9PSB0aGlzLl9zeSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlU2NhbGUoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY2hlY2tCbG9ja2VkKCk7CgogICAgICAgIHRoaXMudG91Y2hpbmcubm9uZSA9IHRydWU7CiAgICAgICAgdGhpcy50b3VjaGluZy51cCA9IGZhbHNlOwogICAgICAgIHRoaXMudG91Y2hpbmcuZG93biA9IGZhbHNlOwogICAgICAgIHRoaXMudG91Y2hpbmcubGVmdCA9IGZhbHNlOwogICAgICAgIHRoaXMudG91Y2hpbmcucmlnaHQgPSBmYWxzZTsKCiAgICAgICAgaWYgKHRoaXMubW92ZXMpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fdnggIT09IHRoaXMudmVsb2NpdHkueCB8fCB0aGlzLl92eSAhPT0gdGhpcy52ZWxvY2l0eS55KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgTm8gbmVlZCB0byByZS1jYWxjIHRoZXNlIGlmIHRoZXkgaGF2ZW4ndCBjaGFuZ2VkCiAgICAgICAgICAgICAgICB0aGlzLl92eCA9IHRoaXMudmVsb2NpdHkueDsKICAgICAgICAgICAgICAgIHRoaXMuX3Z5ID0gdGhpcy52ZWxvY2l0eS55OwogICAgICAgICAgICAgICAgdGhpcy5zcGVlZCA9IE1hdGguc3FydCh0aGlzLnZlbG9jaXR5LnggKiB0aGlzLnZlbG9jaXR5LnggKyB0aGlzLnZlbG9jaXR5LnkgKiB0aGlzLnZlbG9jaXR5LnkpOwogICAgICAgICAgICAgICAgdGhpcy5hbmdsZSA9IE1hdGguYXRhbjIodGhpcy52ZWxvY2l0eS55LCB0aGlzLnZlbG9jaXR5LngpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnBoeXNpY3MuY2hlY2tCb3VuZHModGhpcykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucmVib3VuZENoZWNrKHRydWUsIHRydWUsIHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmFwcGx5RGFtcGluZygpOwoKICAgICAgICAgICAgdGhpcy5pbnRlZ3JhdGVWZWxvY2l0eSgpOwoKICAgICAgICAgICAgdGhpcy51cGRhdGVCb3VuZHMoKTsKCiAgICAgICAgICAgIHRoaXMuY2hlY2tCbG9ja2VkKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlQm91bmRzKCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZCB0aGF0IGNoZWNrcyBhbmQgcG90ZW50aWFsbHkgcmVzZXRzIHRoZSBibG9ja2VkIHN0YXR1cyBmbGFncy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNjaGVja0Jsb2NrZWQKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGNoZWNrQmxvY2tlZDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAoKHRoaXMuYmxvY2tlZC5sZWZ0IHx8IHRoaXMuYmxvY2tlZC5yaWdodCkgJiYgKE1hdGguZmxvb3IodGhpcy54KSAhPT0gdGhpcy5ibG9ja2VkLnggfHwgTWF0aC5mbG9vcih0aGlzLnkpICE9PSB0aGlzLmJsb2NrZWQueSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJsb2NrZWQubGVmdCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmJsb2NrZWQucmlnaHQgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICgodGhpcy5ibG9ja2VkLnVwIHx8IHRoaXMuYmxvY2tlZC5kb3duKSAmJiAoTWF0aC5mbG9vcih0aGlzLngpICE9PSB0aGlzLmJsb2NrZWQueCB8fCBNYXRoLmZsb29yKHRoaXMueSkgIT09IHRoaXMuYmxvY2tlZC55KSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYmxvY2tlZC51cCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmJsb2NrZWQuZG93biA9IGZhbHNlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QgdGhhdCB1cGRhdGVzIHRoZSBsZWZ0LCByaWdodCwgdG9wLCBib3R0b20sIHdpZHRoIGFuZCBoZWlnaHQgcHJvcGVydGllcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSN1cGRhdGVCb3VuZHMKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHVwZGF0ZUJvdW5kczogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQ0lSQ0xFKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5sZWZ0ID0gdGhpcy5zaGFwZS5wb3MueCAtIHRoaXMuc2hhcGUucjsKICAgICAgICAgICAgdGhpcy5yaWdodCA9IHRoaXMuc2hhcGUucG9zLnggKyB0aGlzLnNoYXBlLnI7CiAgICAgICAgICAgIHRoaXMudG9wID0gdGhpcy5zaGFwZS5wb3MueSAtIHRoaXMuc2hhcGUucjsKICAgICAgICAgICAgdGhpcy5ib3R0b20gPSB0aGlzLnNoYXBlLnBvcy55ICsgdGhpcy5zaGFwZS5yOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxlZnQgPSBQaGFzZXIuTWF0aC5taW5Qcm9wZXJ0eSgneCcsIHRoaXMucG9seWdvbi5wb2ludHMpICsgdGhpcy5wb2x5Z29uLnBvcy54OwogICAgICAgICAgICB0aGlzLnJpZ2h0ID0gUGhhc2VyLk1hdGgubWF4UHJvcGVydHkoJ3gnLCB0aGlzLnBvbHlnb24ucG9pbnRzKSArIHRoaXMucG9seWdvbi5wb3MueDsKICAgICAgICAgICAgdGhpcy50b3AgPSBQaGFzZXIuTWF0aC5taW5Qcm9wZXJ0eSgneScsIHRoaXMucG9seWdvbi5wb2ludHMpICsgdGhpcy5wb2x5Z29uLnBvcy55OwogICAgICAgICAgICB0aGlzLmJvdHRvbSA9IFBoYXNlci5NYXRoLm1heFByb3BlcnR5KCd5JywgdGhpcy5wb2x5Z29uLnBvaW50cykgKyB0aGlzLnBvbHlnb24ucG9zLnk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5yaWdodCAtIHRoaXMubGVmdDsKICAgICAgICB0aGlzLmhlaWdodCA9IHRoaXMuYm90dG9tIC0gdGhpcy50b3A7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kIHRoYXQgY2hlY2tzIHRoZSBhY2NlbGVyYXRpb24gYW5kIGFwcGxpZXMgZGFtcGluZyBpZiBub3Qgc2V0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2FwcGx5RGFtcGluZwogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgYXBwbHlEYW1waW5nOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmxpbmVhckRhbXBpbmcgPiAwICYmIHRoaXMuYWNjZWxlcmF0aW9uLmlzWmVybygpKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3BlZWQgPiB0aGlzLmxpbmVhckRhbXBpbmcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3BlZWQgLT0gdGhpcy5saW5lYXJEYW1waW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcGVlZCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBEb24ndCBib3RoZXIgaWYgc3BlZWQgMAogICAgICAgICAgICBpZiAodGhpcy5zcGVlZCA+IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCA9IE1hdGguY29zKHRoaXMuYW5nbGUpICogdGhpcy5zcGVlZDsKICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSA9IE1hdGguc2luKHRoaXMuYW5nbGUpICogdGhpcy5zcGVlZDsKCiAgICAgICAgICAgICAgICB0aGlzLnNwZWVkID0gTWF0aC5zcXJ0KHRoaXMudmVsb2NpdHkueCAqIHRoaXMudmVsb2NpdHkueCArIHRoaXMudmVsb2NpdHkueSAqIHRoaXMudmVsb2NpdHkueSk7CiAgICAgICAgICAgICAgICB0aGlzLmFuZ2xlID0gTWF0aC5hdGFuMih0aGlzLnZlbG9jaXR5LnksIHRoaXMudmVsb2NpdHkueCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgaWYgd2UncmUgYmVsb3cgbWluVmVsb2NpdHkgYW5kIGdyYXZpdHkgaXNuJ3QgdHJ5aW5nIHRvIGRyYWcgdXMgaW4gdGhlIG9wcG9zaXRlIGRpcmVjdGlvbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNyZWJvdW5kQ2hlY2sKICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHggLSBDaGVjayB0aGUgWCBheGlzPwogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHkgLSBDaGVjayB0aGUgWSBheGlzPwogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHJlYm91bmQgLSBJZiB0cnVlIGl0IHdpbGwgcmV2ZXJzZSB0aGUgdmVsb2NpdHkgb24gdGhlIGdpdmVuIGF4aXMKICAgICovCiAgICByZWJvdW5kQ2hlY2s6IGZ1bmN0aW9uICh4LCB5LCByZWJvdW5kKSB7CgogICAgICAgIGlmICh4KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlYm91bmQgJiYgdGhpcy5ib3VuY2UueCAhPT0gMCAmJiAodGhpcy5ibG9ja2VkLmxlZnQgfHwgdGhpcy5ibG9ja2VkLnJpZ2h0IHx8IHRoaXMudG91Y2hpbmcubGVmdCB8fCB0aGlzLnRvdWNoaW5nLnJpZ2h0KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIERvbid0IHJlYm91bmQgaWYgdGhleSd2ZSBhbHJlYWR5IHJlYm91bmRlZCBpbiB0aGlzIGZyYW1lCiAgICAgICAgICAgICAgICBpZiAoISh0aGlzLl92eCA8PSAwICYmIHRoaXMudmVsb2NpdHkueCA+IDApICYmICEodGhpcy5fdnggPj0gMCAmJiB0aGlzLnZlbG9jaXR5LnggPCAwKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggKj0gLXRoaXMuYm91bmNlLng7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmdsZSA9IE1hdGguYXRhbjIodGhpcy52ZWxvY2l0eS55LCB0aGlzLnZlbG9jaXR5LngpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5ib3VuY2UueCA9PT0gMCB8fCBNYXRoLmFicyh0aGlzLnZlbG9jaXR5LngpIDwgdGhpcy5taW5WZWxvY2l0eS54KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgZ3ggPSB0aGlzLmdldFVwd2FyZEZvcmNlKCk7CgogICAgICAgICAgICAgICAgaWYgKCgodGhpcy5ibG9ja2VkLmxlZnQgfHwgdGhpcy50b3VjaGluZy5sZWZ0KSAmJiAoZ3ggPCAwIHx8IHRoaXMudmVsb2NpdHkueCA8IDApKSB8fCAoKHRoaXMuYmxvY2tlZC5yaWdodCB8fCB0aGlzLnRvdWNoaW5nLnJpZ2h0KSAmJiAoZ3ggPiAwIHx8IHRoaXMudmVsb2NpdHkueCA+IDApKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoeSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZWJvdW5kICYmIHRoaXMuYm91bmNlLnkgIT09IDAgJiYgKHRoaXMuYmxvY2tlZC51cCB8fCB0aGlzLmJsb2NrZWQuZG93biB8fCB0aGlzLnRvdWNoaW5nLnVwIHx8IHRoaXMudG91Y2hpbmcuZG93bikpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBEb24ndCByZWJvdW5kIGlmIHRoZXkndmUgYWxyZWFkeSByZWJvdW5kZWQgaW4gdGhpcyBmcmFtZQogICAgICAgICAgICAgICAgaWYgKCEodGhpcy5fdnkgPD0gMCAmJiB0aGlzLnZlbG9jaXR5LnkgPiAwKSAmJiAhKHRoaXMuX3Z5ID49IDAgJiYgdGhpcy52ZWxvY2l0eS55IDwgMCkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ICo9IC10aGlzLmJvdW5jZS55OwogICAgICAgICAgICAgICAgICAgIHRoaXMuYW5nbGUgPSBNYXRoLmF0YW4yKHRoaXMudmVsb2NpdHkueSwgdGhpcy52ZWxvY2l0eS54KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuYm91bmNlLnkgPT09IDAgfHwgTWF0aC5hYnModGhpcy52ZWxvY2l0eS55KSA8IHRoaXMubWluVmVsb2NpdHkueSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGd5ID0gdGhpcy5nZXREb3dud2FyZEZvcmNlKCk7CgogICAgICAgICAgICAgICAgaWYgKCgodGhpcy5ibG9ja2VkLnVwIHx8IHRoaXMudG91Y2hpbmcudXApICYmIChneSA8IDAgfHwgdGhpcy52ZWxvY2l0eS55IDwgMCkpIHx8ICgodGhpcy5ibG9ja2VkLmRvd24gfHwgdGhpcy50b3VjaGluZy5kb3duKSAmJiAoZ3kgPiAwIHx8IHRoaXMudmVsb2NpdHkueSA+IDApKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldHMgdGhlIHRvdGFsIGZvcmNlIGJlaW5nIGFwcGxpZWQgb24gdGhlIFggYXhpcywgaW5jbHVkaW5nIGdyYXZpdHkgYW5kIHZlbG9jaXR5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2dldFVwd2FyZEZvcmNlCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHRvdGFsIGZvcmNlIGJlaW5nIGFwcGxpZWQgb24gdGhlIFggYXhpcy4KICAgICovCiAgICBnZXRVcHdhcmRGb3JjZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5hbGxvd0dyYXZpdHkpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ncmF2aXR5LnggKyB0aGlzLmdhbWUucGh5c2ljcy5ncmF2aXR5LnggKyB0aGlzLnZlbG9jaXR5Lng7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdyYXZpdHkueCArIHRoaXMudmVsb2NpdHkueDsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogR2V0cyB0aGUgdG90YWwgZm9yY2UgYmVpbmcgYXBwbGllZCBvbiB0aGUgWCBheGlzLCBpbmNsdWRpbmcgZ3Jhdml0eSBhbmQgdmVsb2NpdHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjZ2V0RG93bndhcmRGb3JjZQogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSB0b3RhbCBmb3JjZSBiZWluZyBhcHBsaWVkIG9uIHRoZSBZIGF4aXMuCiAgICAqLwogICAgZ2V0RG93bndhcmRGb3JjZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5hbGxvd0dyYXZpdHkpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ncmF2aXR5LnkgKyB0aGlzLmdhbWUucGh5c2ljcy5ncmF2aXR5LnkgKyB0aGlzLnZlbG9jaXR5Lnk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdyYXZpdHkueSArIHRoaXMudmVsb2NpdHkueTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU3VidHJhY3RzIHRoZSBnaXZlbiBWZWN0b3IgZnJvbSB0aGlzIEJvZHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjc3ViCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtTQVQuVmVjdG9yfSB2IC0gVGhlIHZlY3RvciB0byBzdWJzdHJhY3QgZnJvbSB0aGlzIEJvZHkuCiAgICAqLwogICAgc3ViOiBmdW5jdGlvbiAodikgewoKICAgICAgICB0aGlzLnggLT0gdi54OwogICAgICAgIHRoaXMueSAtPSB2Lnk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyB0aGUgZ2l2ZW4gVmVjdG9yIHRvIHRoaXMgQm9keS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNhZGQKICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge1NBVC5WZWN0b3J9IHYgLSBUaGUgdmVjdG9yIHRvIGFkZCB0byB0aGlzIEJvZHkuCiAgICAqLwogICAgYWRkOiBmdW5jdGlvbiAodikgewoKICAgICAgICB0aGlzLnggKz0gdi54OwogICAgICAgIHRoaXMueSArPSB2Lnk7CgogICAgfSwKCiAgICAvKioKICAgICogU2VwYXJhdGlvbiByZXNwb25zZSBoYW5kbGVyLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2dpdmUKICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gVGhlIEJvZHkgdGhhdCBjb2xsaWRlZC4KICAgICogQHBhcmFtIHtTQVQuUmVzcG9uc2V9IHJlc3BvbnNlIC0gVGhlIFNBVCBSZXNwb25zZSBvYmplY3QgY29udGFpbmluZyB0aGUgY29sbGlzaW9uIGRhdGEuCiAgICAqLwogICAgZ2l2ZTogZnVuY3Rpb24gKGJvZHksIHJlc3BvbnNlKSB7CgogICAgICAgIHRoaXMuYWRkKHJlc3BvbnNlLm92ZXJsYXBWKTsKCiAgICAgICAgaWYgKHRoaXMucmVib3VuZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1JlYm91bmQoYm9keSk7CiAgICAgICAgICAgIHRoaXMucmVib3VuZENoZWNrKHRydWUsIHRydWUsIGZhbHNlKTsKICAgICAgICAgICAgYm9keS5yZWJvdW5kQ2hlY2sodHJ1ZSwgdHJ1ZSwgZmFsc2UpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXBhcmF0aW9uIHJlc3BvbnNlIGhhbmRsZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjdGFrZQogICAgKiBAcHJvdGVjdGVkCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkgLSBUaGUgQm9keSB0aGF0IGNvbGxpZGVkLgogICAgKiBAcGFyYW0ge1NBVC5SZXNwb25zZX0gcmVzcG9uc2UgLSBUaGUgU0FUIFJlc3BvbnNlIG9iamVjdCBjb250YWluaW5nIHRoZSBjb2xsaXNpb24gZGF0YS4KICAgICovCiAgICB0YWtlOiBmdW5jdGlvbiAoYm9keSwgcmVzcG9uc2UpIHsKCiAgICAgICAgdGhpcy5zdWIocmVzcG9uc2Uub3ZlcmxhcFYpOwoKICAgICAgICBpZiAodGhpcy5yZWJvdW5kKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5wcm9jZXNzUmVib3VuZChib2R5KTsKICAgICAgICAgICAgdGhpcy5yZWJvdW5kQ2hlY2sodHJ1ZSwgdHJ1ZSwgZmFsc2UpOwogICAgICAgICAgICBib2R5LnJlYm91bmRDaGVjayh0cnVlLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNwbGl0IHRoZSBjb2xsaXNpb24gcmVzcG9uc2UgZXZlbmx5IGJldHdlZW4gdGhlIHR3byBib2RpZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjc3BsaXQKICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gVGhlIEJvZHkgdGhhdCBjb2xsaWRlZC4KICAgICogQHBhcmFtIHtTQVQuUmVzcG9uc2V9IHJlc3BvbnNlIC0gVGhlIFNBVCBSZXNwb25zZSBvYmplY3QgY29udGFpbmluZyB0aGUgY29sbGlzaW9uIGRhdGEuCiAgICAqLwogICAgc3BsaXQ6IGZ1bmN0aW9uIChib2R5LCByZXNwb25zZSkgewogICAgCiAgICAgICAgcmVzcG9uc2Uub3ZlcmxhcFYuc2NhbGUoMC41KTsKICAgICAgICB0aGlzLnN1YihyZXNwb25zZS5vdmVybGFwVik7CiAgICAgICAgYm9keS5hZGQocmVzcG9uc2Uub3ZlcmxhcFYpOwoKICAgICAgICBpZiAodGhpcy5yZWJvdW5kKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5leGNoYW5nZShib2R5KTsKICAgICAgICAgICAgdGhpcy5yZWJvdW5kQ2hlY2sodHJ1ZSwgdHJ1ZSwgZmFsc2UpOwogICAgICAgICAgICBib2R5LnJlYm91bmRDaGVjayh0cnVlLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEV4Y2hhbmdlIHZlbG9jaXR5IHdpdGggdGhlIGdpdmVuIEJvZHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjZXhjaGFuZ2UKICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gVGhlIEJvZHkgdGhhdCBjb2xsaWRlZC4KICAgICovCiAgICBleGNoYW5nZTogZnVuY3Rpb24gKGJvZHkpIHsKCiAgICAgICAgaWYgKHRoaXMubWFzcyA9PT0gYm9keS5tYXNzICYmIHRoaXMuc3BlZWQgPiAwICYmIGJvZHkuc3BlZWQgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIEEgZGlyZWN0IHZlbG9jaXR5IGV4Y2hhbmdlIChhcyB0aGV5IGFyZSBib3RoIG1vdmluZyBhbmQgaGF2ZSB0aGUgc2FtZSBtYXNzKQogICAgICAgICAgICB0aGlzLl9keCA9IGJvZHkudmVsb2NpdHkueDsKICAgICAgICAgICAgdGhpcy5fZHkgPSBib2R5LnZlbG9jaXR5Lnk7CgogICAgICAgICAgICBib2R5LnZlbG9jaXR5LnggPSB0aGlzLnZlbG9jaXR5LnggKiBib2R5LmJvdW5jZS54OwogICAgICAgICAgICBib2R5LnZlbG9jaXR5LnkgPSB0aGlzLnZlbG9jaXR5LnkgKiBib2R5LmJvdW5jZS54OwoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ID0gdGhpcy5fZHggKiB0aGlzLmJvdW5jZS54OwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgPSB0aGlzLl9keSAqIHRoaXMuYm91bmNlLnk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHZhciBudjEgPSBNYXRoLnNxcnQoKGJvZHkudmVsb2NpdHkueCAqIGJvZHkudmVsb2NpdHkueCAqIGJvZHkubWFzcykgLyB0aGlzLm1hc3MpICogKChib2R5LnZlbG9jaXR5LnggPiAwKSA/IDEgOiAtMSk7CiAgICAgICAgICAgIHZhciBudjIgPSBNYXRoLnNxcnQoKHRoaXMudmVsb2NpdHkueCAqIHRoaXMudmVsb2NpdHkueCAqIHRoaXMubWFzcykgLyBib2R5Lm1hc3MpICogKCh0aGlzLnZlbG9jaXR5LnggPiAwKSA/IDEgOiAtMSk7CiAgICAgICAgICAgIHZhciBhdmVyYWdlID0gKG52MSArIG52MikgKiAwLjU7CiAgICAgICAgICAgIG52MSAtPSBhdmVyYWdlOwogICAgICAgICAgICBudjIgLT0gYXZlcmFnZTsKCiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCA9IG52MTsKICAgICAgICAgICAgYm9keS52ZWxvY2l0eS54ID0gbnYyOwoKICAgICAgICAgICAgbnYxID0gTWF0aC5zcXJ0KChib2R5LnZlbG9jaXR5LnkgKiBib2R5LnZlbG9jaXR5LnkgKiBib2R5Lm1hc3MpIC8gdGhpcy5tYXNzKSAqICgoYm9keS52ZWxvY2l0eS55ID4gMCkgPyAxIDogLTEpOwogICAgICAgICAgICBudjIgPSBNYXRoLnNxcnQoKHRoaXMudmVsb2NpdHkueSAqIHRoaXMudmVsb2NpdHkueSAqIHRoaXMubWFzcykgLyBib2R5Lm1hc3MpICogKCh0aGlzLnZlbG9jaXR5LnkgPiAwKSA/IDEgOiAtMSk7CiAgICAgICAgICAgIGF2ZXJhZ2UgPSAobnYxICsgbnYyKSAqIDAuNTsKICAgICAgICAgICAgbnYxIC09IGF2ZXJhZ2U7CiAgICAgICAgICAgIG52MiAtPSBhdmVyYWdlOwoKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ID0gbnYxOwogICAgICAgICAgICBib2R5LnZlbG9jaXR5LnkgPSBudjI7CiAgICAgICAgfQoKICAgICAgICAvLyAgdXBkYXRlIHNwZWVkIC8gYW5nbGU/CgogICAgfSwKCiAgICAvKioKICAgICogUmVib3VuZCB0aGUgdmVsb2NpdHkgb2YgdGhpcyBCb2R5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3Byb2Nlc3NSZWJvdW5kCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IHRoYXQgY29sbGlkZWQuCiAgICAqLwogICAgcHJvY2Vzc1JlYm91bmQ6IGZ1bmN0aW9uIChib2R5KSB7CgogICAgICAgIC8vICBEb24ndCByZWJvdW5kIGFnYWluIGlmIHRoZXkndmUgYWxyZWFkeSByZWJvdW5kZWQgaW4gdGhpcyBmcmFtZQogICAgICAgIGlmICghKHRoaXMuX3Z4IDw9IDAgJiYgdGhpcy52ZWxvY2l0eS54ID4gMCkgJiYgISh0aGlzLl92eCA+PSAwICYmIHRoaXMudmVsb2NpdHkueCA8IDApKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ID0gYm9keS52ZWxvY2l0eS54IC0gdGhpcy52ZWxvY2l0eS54ICogdGhpcy5ib3VuY2UueDsKICAgICAgICB9CgogICAgICAgIGlmICghKHRoaXMuX3Z5IDw9IDAgJiYgdGhpcy52ZWxvY2l0eS55ID4gMCkgJiYgISh0aGlzLl92eSA+PSAwICYmIHRoaXMudmVsb2NpdHkueSA8IDApKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ID0gYm9keS52ZWxvY2l0eS55IC0gdGhpcy52ZWxvY2l0eS55ICogdGhpcy5ib3VuY2UueTsKICAgICAgICB9CgogICAgICAgIHRoaXMuYW5nbGUgPSBNYXRoLmF0YW4yKHRoaXMudmVsb2NpdHkueSwgdGhpcy52ZWxvY2l0eS54KTsKCiAgICAgICAgdGhpcy5yZWJvdW5kQ2hlY2sodHJ1ZSwgdHJ1ZSwgZmFsc2UpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrcyBmb3IgYW4gb3ZlcmxhcCBiZXR3ZWVuIHRoaXMgQm9keSBhbmQgdGhlIGdpdmVuIEJvZHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjb3ZlcmxhcAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gVGhlIEJvZHkgdGhhdCBpcyBiZWluZyBjaGVja2VkIGFnYWluc3QgdGhpcyBCb2R5LgogICAgKiBAcGFyYW0ge1NBVC5SZXNwb25zZX0gcmVzcG9uc2UgLSBTQVQgUmVzcG9uc2UgaGFuZGxlci4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgdHdvIGJvZGllcyBvdmVybGFwLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgb3ZlcmxhcDogZnVuY3Rpb24gKGJvZHksIHJlc3BvbnNlKSB7CgogICAgICAgIHZhciByZXN1bHQgPSBmYWxzZTsKCiAgICAgICAgaWYgKCh0aGlzLnR5cGUgPT09IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5SRUNUIHx8IHRoaXMudHlwZSA9PT0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLlBPTFlHT04pICYmIChib2R5LnR5cGUgPT09IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5SRUNUIHx8IGJvZHkudHlwZSA9PT0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLlBPTFlHT04pKQogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0ID0gU0FULnRlc3RQb2x5Z29uUG9seWdvbih0aGlzLnBvbHlnb24sIGJvZHkucG9seWdvbiwgcmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnR5cGUgPT09IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5DSVJDTEUgJiYgYm9keS50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQ0lSQ0xFKQogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0ID0gU0FULnRlc3RDaXJjbGVDaXJjbGUodGhpcy5zaGFwZSwgYm9keS5zaGFwZSwgcmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgodGhpcy50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuUkVDVCB8fCB0aGlzLnR5cGUgPT09IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5QT0xZR09OKSAmJiBib2R5LnR5cGUgPT09IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5DSVJDTEUpCiAgICAgICAgewogICAgICAgICAgICByZXN1bHQgPSBTQVQudGVzdFBvbHlnb25DaXJjbGUodGhpcy5wb2x5Z29uLCBib2R5LnNoYXBlLCByZXNwb25zZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMudHlwZSA9PT0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkNJUkNMRSAmJiAoYm9keS50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuUkVDVCB8fCBib2R5LnR5cGUgPT09IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5QT0xZR09OKSkKICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA9IFNBVC50ZXN0Q2lyY2xlUG9seWdvbih0aGlzLnNoYXBlLCBib2R5LnBvbHlnb24sIHJlc3BvbnNlKTsKICAgICAgICB9CgogICAgICAgIGlmICghcmVzdWx0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmVDb250YWN0KGJvZHkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgaWYgdGhpcyBCb2R5IGlzIGFscmVhZHkgaW4gY29udGFjdCB3aXRoIHRoZSBnaXZlbiBCb2R5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2luQ29udGFjdAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gVGhlIEJvZHkgdG8gYmUgY2hlY2tlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gQm9keSBpcyBhbHJlYWR5IGluIGNvbnRhY3Qgd2l0aCB0aGlzIEJvZHkuCiAgICAqLwogICAgaW5Db250YWN0OiBmdW5jdGlvbiAoYm9keSkgewoKICAgICAgICByZXR1cm4gKHRoaXMuY29udGFjdHMuaW5kZXhPZihib2R5KSAhPSAtMSk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyB0aGUgZ2l2ZW4gQm9keSB0byB0aGUgY29udGFjdCBsaXN0IG9mIHRoaXMgQm9keS4gQWxzbyBhZGRzIHRoaXMgQm9keSB0byB0aGUgY29udGFjdCBsaXN0IG9mIHRoZSBnaXZlbiBCb2R5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2FkZENvbnRhY3QKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IHRvIGJlIGFkZGVkLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBnaXZlbiBCb2R5IHdhcyBhZGRlZCB0byB0aGlzIGNvbnRhY3QgbGlzdCwgZmFsc2UgaWYgYWxyZWFkeSBvbiBpdC4KICAgICovCiAgICBhZGRDb250YWN0OiBmdW5jdGlvbiAoYm9keSkgewoKICAgICAgICBpZiAodGhpcy5pbkNvbnRhY3QoYm9keSkpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNvbnRhY3RzLnB1c2goYm9keSk7CgogICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbkJlZ2luQ29udGFjdC5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgYm9keS5zcHJpdGUsIHRoaXMsIGJvZHkpOwoKICAgICAgICBib2R5LmFkZENvbnRhY3QodGhpcyk7CgogICAgICAgIHJldHVybiB0cnVlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgdGhlIGdpdmVuIEJvZHkgZnJvbSB0aGUgY29udGFjdCBsaXN0IG9mIHRoaXMgQm9keS4gQWxzbyByZW1vdmVzIHRoaXMgQm9keSBmcm9tIHRoZSBjb250YWN0IGxpc3Qgb2YgdGhlIGdpdmVuIEJvZHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjcmVtb3ZlQ29udGFjdAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gVGhlIEJvZHkgdG8gYmUgcmVtb3ZlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gQm9keSB3YXMgcmVtb3ZlZCBmcm9tIHRoaXMgY29udGFjdCBsaXN0LCBmYWxzZSBpZiB3YXNuJ3Qgb24gaXQuCiAgICAqLwogICAgcmVtb3ZlQ29udGFjdDogZnVuY3Rpb24gKGJvZHkpIHsKCiAgICAgICAgaWYgKCF0aGlzLmluQ29udGFjdChib2R5KSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29udGFjdHMuc3BsaWNlKHRoaXMuY29udGFjdHMuaW5kZXhPZihib2R5KSwgMSk7CgogICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbkVuZENvbnRhY3QuZGlzcGF0Y2godGhpcy5zcHJpdGUsIGJvZHkuc3ByaXRlLCB0aGlzLCBib2R5KTsKCiAgICAgICAgYm9keS5yZW1vdmVDb250YWN0KHRoaXMpOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGlzIHNlcGFyYXRlcyB0aGlzIEJvZHkgZnJvbSB0aGUgZ2l2ZW4gQm9keSB1bmxlc3MgYSBjdXN0b21TZXBhcmF0ZUNhbGxiYWNrIGlzIHNldC4KICAgICogSXQgYXNzdW1lcyB0aGV5IGhhdmUgYWxyZWFkeSBiZWVuIG92ZXJsYXAgY2hlY2tlZCBhbmQgdGhlIHJlc3VsdGluZyBvdmVybGFwIGlzIHN0b3JlZCBpbiB0aGUgU0FUIHJlc3BvbnNlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3NlcGFyYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IHRvIGJlIHNlcGFyYXRlZCBmcm9tIHRoaXMgb25lLgogICAgKiBAcGFyYW0ge1NBVC5SZXNwb25zZX0gcmVzcG9uc2UgLSBTQVQgUmVzcG9uc2UgaGFuZGxlci4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgYm9kaWVzIHdlcmUgc2VwYXJhdGVkLCBmYWxzZSBpZiBub3QgKGZvciBleGFtcGxlIGNoZWNrQ29sbGlkZSBhbGxvd3MgdGhlbSB0byBwYXNzIHRocm91Z2gpCiAgICAqLwogICAgc2VwYXJhdGU6IGZ1bmN0aW9uIChib2R5LCByZXNwb25zZSkgewoKICAgICAgICAvLyBpZiAodGhpcy5pbkNvbnRhY3QoYm9keSkpCiAgICAgICAgLy8gewogICAgICAgICAgICAvLyByZXR1cm4gZmFsc2U7CiAgICAgICAgLy8gfQoKICAgICAgICB0aGlzLl9kaXN0YW5jZXNbMF0gPSBib2R5LnJpZ2h0IC0gdGhpcy54OyAgIC8vIERpc3RhbmNlIG9mIEIgdG8gZmFjZSBvbiBsZWZ0IHNpZGUgb2YgQQogICAgICAgIHRoaXMuX2Rpc3RhbmNlc1sxXSA9IHRoaXMucmlnaHQgLSBib2R5Lng7ICAgLy8gRGlzdGFuY2Ugb2YgQiB0byBmYWNlIG9uIHJpZ2h0IHNpZGUgb2YgQQogICAgICAgIHRoaXMuX2Rpc3RhbmNlc1syXSA9IGJvZHkuYm90dG9tIC0gdGhpcy55OyAgLy8gRGlzdGFuY2Ugb2YgQiB0byBmYWNlIG9uIGJvdHRvbSBzaWRlIG9mIEEKICAgICAgICB0aGlzLl9kaXN0YW5jZXNbM10gPSB0aGlzLmJvdHRvbSAtIGJvZHkueTsgIC8vIERpc3RhbmNlIG9mIEIgdG8gZmFjZSBvbiB0b3Agc2lkZSBvZiBBCgogICAgICAgIC8vICBJZiB3ZSd2ZSB6ZXJvIGRpc3RhbmNlIHRoZW4gY2hlY2sgZm9yIHNpZGUtc2xpY2luZwogICAgICAgIGlmIChyZXNwb25zZS5vdmVybGFwTi54ICYmICh0aGlzLl9kaXN0YW5jZXNbMF0gPT09IDAgfHwgdGhpcy5fZGlzdGFuY2VzWzFdID09PSAwKSkKICAgICAgICB7CiAgICAgICAgICAgIHJlc3BvbnNlLm92ZXJsYXBOLnggPSBmYWxzZTsKICAgICAgICAgICAgcmVzcG9uc2Uub3ZlcmxhcE4ueSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHJlc3BvbnNlLm92ZXJsYXBOLnkgJiYgKHRoaXMuX2Rpc3RhbmNlc1syXSA9PT0gMCB8fCB0aGlzLl9kaXN0YW5jZXNbM10gPT09IDApKQogICAgICAgIHsKICAgICAgICAgICAgcmVzcG9uc2Uub3ZlcmxhcE4ueCA9IHRydWU7CiAgICAgICAgICAgIHJlc3BvbnNlLm92ZXJsYXBOLnkgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmN1c3RvbVNlcGFyYXRlQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jdXN0b21TZXBhcmF0ZUNhbGxiYWNrLmNhbGwodGhpcy5jdXN0b21TZXBhcmF0ZUNvbnRleHQsIHRoaXMsIHJlc3BvbnNlLCB0aGlzLl9kaXN0YW5jZXMpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGhhc1NlcGFyYXRlZCA9IGZhbHNlOwoKICAgICAgICBpZiAocmVzcG9uc2Uub3ZlcmxhcE4ueCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBXaGljaCBpcyBzbWFsbGVyPyBMZWZ0IG9yIFJpZ2h0PwogICAgICAgICAgICBpZiAodGhpcy5fZGlzdGFuY2VzWzBdIDwgdGhpcy5fZGlzdGFuY2VzWzFdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBoYXNTZXBhcmF0ZWQgPSB0aGlzLmhpdExlZnQoYm9keSwgcmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuX2Rpc3RhbmNlc1sxXSA8IHRoaXMuX2Rpc3RhbmNlc1swXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaGFzU2VwYXJhdGVkID0gdGhpcy5oaXRSaWdodChib2R5LCByZXNwb25zZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocmVzcG9uc2Uub3ZlcmxhcE4ueSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBXaGljaCBpcyBzbWFsbGVyPyBUb3Agb3IgQm90dG9tPwogICAgICAgICAgICBpZiAodGhpcy5fZGlzdGFuY2VzWzJdIDwgdGhpcy5fZGlzdGFuY2VzWzNdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBoYXNTZXBhcmF0ZWQgPSB0aGlzLmhpdFRvcChib2R5LCByZXNwb25zZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5fZGlzdGFuY2VzWzNdIDwgdGhpcy5fZGlzdGFuY2VzWzJdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBoYXNTZXBhcmF0ZWQgPSB0aGlzLmhpdEJvdHRvbShib2R5LCByZXNwb25zZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChoYXNTZXBhcmF0ZWQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUucGh5c2ljcy5jaGVja0JvdW5kcyh0aGlzKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnBoeXNpY3MuY2hlY2tCb3VuZHMoYm9keSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBUaGV5IGNhbiBvbmx5IGNvbnRhY3QgbGlrZSB0aGlzIGlmIGF0IGxlYXN0IG9uZSBvZiB0aGVpciBzaWRlcyBpcyBvcGVuLCBvdGhlcndpc2UgaXQncyBhIHNlcGFyYXRpb24KICAgICAgICAgICAgaWYgKCF0aGlzLmNoZWNrQ29sbGlzaW9uLnVwIHx8ICF0aGlzLmNoZWNrQ29sbGlzaW9uLmRvd24gfHwgIXRoaXMuY2hlY2tDb2xsaXNpb24ubGVmdCB8fCAhdGhpcy5jaGVja0NvbGxpc2lvbi5yaWdodCB8fCAhYm9keS5jaGVja0NvbGxpc2lvbi51cCB8fCAhYm9keS5jaGVja0NvbGxpc2lvbi5kb3duIHx8ICFib2R5LmNoZWNrQ29sbGlzaW9uLmxlZnQgfHwgIWJvZHkuY2hlY2tDb2xsaXNpb24ucmlnaHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuYWRkQ29udGFjdChib2R5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGhhc1NlcGFyYXRlZDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQcm9jZXNzIGEgY29sbGlzaW9uIHdpdGggdGhlIGxlZnQgZmFjZSBvZiB0aGlzIEJvZHkuCiAgICAqIENvbGxpc2lvbiBhbmQgc2VwYXJhdGlvbiBjYW4gYmUgZnVydGhlciBjaGVja2VkIGJ5IHNldHRpbmcgYSBjb2xsaWRlQ2FsbGJhY2suCiAgICAqIFRoaXMgY2FsbGJhY2sgd2lsbCBiZSBzZW50IDQgcGFyYW1ldGVyczogVGhlIGZhY2Ugb2YgY29sbGlzaW9uLCB0aGlzIEJvZHksIHRoZSBjb2xsaWRpbmcgQm9keSBhbmQgdGhlIFNBVCBSZXNwb25zZS4KICAgICogSWYgdGhlIGNhbGxiYWNrIHJldHVybnMgdHJ1ZSB0aGVuIHNlcGFyYXRpb24sIHJlYm91bmRzIGFuZCB0aGUgdG91Y2hpbmcgZmxhZ3Mgd2lsbCBhbGwgYmUgc2V0LgogICAgKiBJZiBpdCByZXR1cm5zIGZhbHNlIHRoaXMgd2lsbCBiZSBza2lwcGVkIGFuZCBtdXN0IGJlIGhhbmRsZWQgbWFudWFsbHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjaGl0TGVmdAogICAgKiBAcHJvdGVjdGVkCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkgLSBUaGUgQm9keSB0aGF0IGNvbGxpZGVkLgogICAgKiBAcGFyYW0ge1NBVC5SZXNwb25zZX0gcmVzcG9uc2UgLSBUaGUgU0FUIFJlc3BvbnNlIG9iamVjdCBjb250YWluaW5nIHRoZSBjb2xsaXNpb24gZGF0YS4KICAgICovCiAgICBoaXRMZWZ0OiBmdW5jdGlvbiAoYm9keSwgcmVzcG9uc2UpIHsKCiAgICAgICAgaWYgKCF0aGlzLmNoZWNrQ29sbGlzaW9uLmxlZnQgfHwgIWJvZHkuY2hlY2tDb2xsaXNpb24ucmlnaHQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jb2xsaWRlQ2FsbGJhY2sgJiYgIXRoaXMuY29sbGlkZUNhbGxiYWNrLmNhbGwodGhpcy5jb2xsaWRlQ2FsbGJhY2tDb250ZXh0LCBQaGFzZXIuTEVGVCwgdGhpcywgYm9keSwgcmVzcG9uc2UpKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLm1vdmVzIHx8IHRoaXMuaW1tb3ZhYmxlIHx8IHRoaXMuYmxvY2tlZC5yaWdodCB8fCB0aGlzLnRvdWNoaW5nLnJpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgYm9keS5naXZlKHRoaXMsIHJlc3BvbnNlKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGJvZHkuaW1tb3ZhYmxlIHx8IGJvZHkuYmxvY2tlZC5sZWZ0IHx8IGJvZHkudG91Y2hpbmcubGVmdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFdlIHRha2UgdGhlIGZ1bGwgc2VwYXJhdGlvbgogICAgICAgICAgICAgICAgdGhpcy50YWtlKGJvZHksIHJlc3BvbnNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBTaGFyZSBvdXQgdGhlIHNlcGFyYXRpb24KICAgICAgICAgICAgICAgIHRoaXMuc3BsaXQoYm9keSwgcmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnRvdWNoaW5nLmxlZnQgPSB0cnVlOwogICAgICAgIGJvZHkudG91Y2hpbmcucmlnaHQgPSB0cnVlOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQcm9jZXNzIGEgY29sbGlzaW9uIHdpdGggdGhlIHJpZ2h0IGZhY2Ugb2YgdGhpcyBCb2R5LgogICAgKiBDb2xsaXNpb24gYW5kIHNlcGFyYXRpb24gY2FuIGJlIGZ1cnRoZXIgY2hlY2tlZCBieSBzZXR0aW5nIGEgY29sbGlkZUNhbGxiYWNrLgogICAgKiBUaGlzIGNhbGxiYWNrIHdpbGwgYmUgc2VudCA0IHBhcmFtZXRlcnM6IFRoZSBmYWNlIG9mIGNvbGxpc2lvbiwgdGhpcyBCb2R5LCB0aGUgY29sbGlkaW5nIEJvZHkgYW5kIHRoZSBTQVQgUmVzcG9uc2UuCiAgICAqIElmIHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWUgdGhlbiBzZXBhcmF0aW9uLCByZWJvdW5kcyBhbmQgdGhlIHRvdWNoaW5nIGZsYWdzIHdpbGwgYWxsIGJlIHNldC4KICAgICogSWYgaXQgcmV0dXJucyBmYWxzZSB0aGlzIHdpbGwgYmUgc2tpcHBlZCBhbmQgbXVzdCBiZSBoYW5kbGVkIG1hbnVhbGx5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2hpdFJpZ2h0CiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIFRoZSBCb2R5IHRoYXQgY29sbGlkZWQuCiAgICAqIEBwYXJhbSB7U0FULlJlc3BvbnNlfSByZXNwb25zZSAtIFRoZSBTQVQgUmVzcG9uc2Ugb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGNvbGxpc2lvbiBkYXRhLgogICAgKi8KICAgIGhpdFJpZ2h0OiBmdW5jdGlvbiAoYm9keSwgcmVzcG9uc2UpIHsKCiAgICAgICAgaWYgKCF0aGlzLmNoZWNrQ29sbGlzaW9uLnJpZ2h0IHx8ICFib2R5LmNoZWNrQ29sbGlzaW9uLmxlZnQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jb2xsaWRlQ2FsbGJhY2sgJiYgIXRoaXMuY29sbGlkZUNhbGxiYWNrLmNhbGwodGhpcy5jb2xsaWRlQ2FsbGJhY2tDb250ZXh0LCBQaGFzZXIuUklHSFQsIHRoaXMsIGJvZHkpKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLm1vdmVzIHx8IHRoaXMuaW1tb3ZhYmxlIHx8IHRoaXMuYmxvY2tlZC5sZWZ0IHx8IHRoaXMudG91Y2hpbmcubGVmdCkKICAgICAgICB7CiAgICAgICAgICAgIGJvZHkuZ2l2ZSh0aGlzLCByZXNwb25zZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmIChib2R5LmltbW92YWJsZSB8fCBib2R5LmJsb2NrZWQucmlnaHQgfHwgYm9keS50b3VjaGluZy5yaWdodCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFdlIHRha2UgdGhlIGZ1bGwgc2VwYXJhdGlvbgogICAgICAgICAgICAgICAgdGhpcy50YWtlKGJvZHksIHJlc3BvbnNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBTaGFyZSBvdXQgdGhlIHNlcGFyYXRpb24KICAgICAgICAgICAgICAgIHRoaXMuc3BsaXQoYm9keSwgcmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnRvdWNoaW5nLnJpZ2h0ID0gdHJ1ZTsKICAgICAgICBib2R5LnRvdWNoaW5nLmxlZnQgPSB0cnVlOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQcm9jZXNzIGEgY29sbGlzaW9uIHdpdGggdGhlIHRvcCBmYWNlIG9mIHRoaXMgQm9keS4KICAgICogQ29sbGlzaW9uIGFuZCBzZXBhcmF0aW9uIGNhbiBiZSBmdXJ0aGVyIGNoZWNrZWQgYnkgc2V0dGluZyBhIGNvbGxpZGVDYWxsYmFjay4KICAgICogVGhpcyBjYWxsYmFjayB3aWxsIGJlIHNlbnQgNCBwYXJhbWV0ZXJzOiBUaGUgZmFjZSBvZiBjb2xsaXNpb24sIHRoaXMgQm9keSwgdGhlIGNvbGxpZGluZyBCb2R5IGFuZCB0aGUgU0FUIFJlc3BvbnNlLgogICAgKiBJZiB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVlIHRoZW4gc2VwYXJhdGlvbiwgcmVib3VuZHMgYW5kIHRoZSB0b3VjaGluZyBmbGFncyB3aWxsIGFsbCBiZSBzZXQuCiAgICAqIElmIGl0IHJldHVybnMgZmFsc2UgdGhpcyB3aWxsIGJlIHNraXBwZWQgYW5kIG11c3QgYmUgaGFuZGxlZCBtYW51YWxseS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNoaXRUb3AKICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gVGhlIEJvZHkgdGhhdCBjb2xsaWRlZC4KICAgICogQHBhcmFtIHtTQVQuUmVzcG9uc2V9IHJlc3BvbnNlIC0gVGhlIFNBVCBSZXNwb25zZSBvYmplY3QgY29udGFpbmluZyB0aGUgY29sbGlzaW9uIGRhdGEuCiAgICAqLwogICAgaGl0VG9wOiBmdW5jdGlvbiAoYm9keSwgcmVzcG9uc2UpIHsKCiAgICAgICAgaWYgKCF0aGlzLmNoZWNrQ29sbGlzaW9uLnVwIHx8ICFib2R5LmNoZWNrQ29sbGlzaW9uLmRvd24pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jb2xsaWRlQ2FsbGJhY2sgJiYgIXRoaXMuY29sbGlkZUNhbGxiYWNrLmNhbGwodGhpcy5jb2xsaWRlQ2FsbGJhY2tDb250ZXh0LCBQaGFzZXIuVVAsIHRoaXMsIGJvZHkpKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLm1vdmVzIHx8IHRoaXMuaW1tb3ZhYmxlIHx8IHRoaXMuYmxvY2tlZC5kb3duIHx8IHRoaXMudG91Y2hpbmcuZG93bikKICAgICAgICB7CiAgICAgICAgICAgIGJvZHkuZ2l2ZSh0aGlzLCByZXNwb25zZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmIChib2R5LmltbW92YWJsZSB8fCBib2R5LmJsb2NrZWQudXAgfHwgYm9keS50b3VjaGluZy51cCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFdlIHRha2UgdGhlIGZ1bGwgc2VwYXJhdGlvbgogICAgICAgICAgICAgICAgdGhpcy50YWtlKGJvZHksIHJlc3BvbnNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBTaGFyZSBvdXQgdGhlIHNlcGFyYXRpb24KICAgICAgICAgICAgICAgIHRoaXMuc3BsaXQoYm9keSwgcmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnRvdWNoaW5nLnVwID0gdHJ1ZTsKICAgICAgICBib2R5LnRvdWNoaW5nLmRvd24gPSB0cnVlOwoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQcm9jZXNzIGEgY29sbGlzaW9uIHdpdGggdGhlIGJvdHRvbSBmYWNlIG9mIHRoaXMgQm9keS4KICAgICogQ29sbGlzaW9uIGFuZCBzZXBhcmF0aW9uIGNhbiBiZSBmdXJ0aGVyIGNoZWNrZWQgYnkgc2V0dGluZyBhIGNvbGxpZGVDYWxsYmFjay4KICAgICogVGhpcyBjYWxsYmFjayB3aWxsIGJlIHNlbnQgNCBwYXJhbWV0ZXJzOiBUaGUgZmFjZSBvZiBjb2xsaXNpb24sIHRoaXMgQm9keSwgdGhlIGNvbGxpZGluZyBCb2R5IGFuZCB0aGUgU0FUIFJlc3BvbnNlLgogICAgKiBJZiB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVlIHRoZW4gc2VwYXJhdGlvbiwgcmVib3VuZHMgYW5kIHRoZSB0b3VjaGluZyBmbGFncyB3aWxsIGFsbCBiZSBzZXQuCiAgICAqIElmIGl0IHJldHVybnMgZmFsc2UgdGhpcyB3aWxsIGJlIHNraXBwZWQgYW5kIG11c3QgYmUgaGFuZGxlZCBtYW51YWxseS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNoaXRCb3R0b20KICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gVGhlIEJvZHkgdGhhdCBjb2xsaWRlZC4KICAgICogQHBhcmFtIHtTQVQuUmVzcG9uc2V9IHJlc3BvbnNlIC0gVGhlIFNBVCBSZXNwb25zZSBvYmplY3QgY29udGFpbmluZyB0aGUgY29sbGlzaW9uIGRhdGEuCiAgICAqLwogICAgaGl0Qm90dG9tOiBmdW5jdGlvbiAoYm9keSwgcmVzcG9uc2UpIHsKCiAgICAgICAgaWYgKCF0aGlzLmNoZWNrQ29sbGlzaW9uLmRvd24gfHwgIWJvZHkuY2hlY2tDb2xsaXNpb24udXApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jb2xsaWRlQ2FsbGJhY2sgJiYgIXRoaXMuY29sbGlkZUNhbGxiYWNrLmNhbGwodGhpcy5jb2xsaWRlQ2FsbGJhY2tDb250ZXh0LCBQaGFzZXIuRE9XTiwgdGhpcywgYm9keSkpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXRoaXMubW92ZXMgfHwgdGhpcy5pbW1vdmFibGUgfHwgdGhpcy5ibG9ja2VkLnVwIHx8IHRoaXMudG91Y2hpbmcudXApCiAgICAgICAgewogICAgICAgICAgICBib2R5LmdpdmUodGhpcywgcmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoYm9keS5pbW1vdmFibGUgfHwgYm9keS5ibG9ja2VkLmRvd24gfHwgYm9keS50b3VjaGluZy5kb3duKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgV2UgdGFrZSB0aGUgZnVsbCBzZXBhcmF0aW9uCiAgICAgICAgICAgICAgICB0aGlzLnRha2UoYm9keSwgcmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFNoYXJlIG91dCB0aGUgc2VwYXJhdGlvbgogICAgICAgICAgICAgICAgdGhpcy5zcGxpdChib2R5LCByZXNwb25zZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMudG91Y2hpbmcuZG93biA9IHRydWU7CiAgICAgICAgYm9keS50b3VjaGluZy51cCA9IHRydWU7CgogICAgICAgIHJldHVybiB0cnVlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZC4gSW50ZWdyYXRlcyB2ZWxvY2l0eSwgZ2xvYmFsIGdyYXZpdHkgYW5kIHRoZSBkZWx0YSB0aW1lci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNpbnRlZ3JhdGVWZWxvY2l0eQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgaW50ZWdyYXRlVmVsb2NpdHk6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fdGVtcCA9IHRoaXMuZ2FtZS5waHlzaWNzLnVwZGF0ZU1vdGlvbih0aGlzKTsKICAgICAgICB0aGlzLl9keCA9IHRoaXMuZ2FtZS50aW1lLnBoeXNpY3NFbGFwc2VkICogKHRoaXMudmVsb2NpdHkueCArIHRoaXMuX3RlbXAueCAvIDIpOwogICAgICAgIHRoaXMuX2R5ID0gdGhpcy5nYW1lLnRpbWUucGh5c2ljc0VsYXBzZWQgKiAodGhpcy52ZWxvY2l0eS55ICsgdGhpcy5fdGVtcC55IC8gMik7CgogICAgICAgIC8vICBwb3NpdGl2ZSA9IFJJR0hUIC8gRE9XTgogICAgICAgIC8vICBuZWdhdGl2ZSA9IExFRlQgLyBVUAoKICAgICAgICBpZiAoKHRoaXMuX2R4IDwgMCAmJiAhdGhpcy5ibG9ja2VkLmxlZnQgJiYgIXRoaXMudG91Y2hpbmcubGVmdCkgfHwgKHRoaXMuX2R4ID4gMCAmJiAhdGhpcy5ibG9ja2VkLnJpZ2h0ICYmICF0aGlzLnRvdWNoaW5nLnJpZ2h0KSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMueCArPSB0aGlzLl9keDsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ICs9IHRoaXMuX3RlbXAueDsKICAgICAgICB9CgogICAgICAgIGlmICgodGhpcy5fZHkgPCAwICYmICF0aGlzLmJsb2NrZWQudXAgJiYgIXRoaXMudG91Y2hpbmcudXApIHx8ICh0aGlzLl9keSA+IDAgJiYgIXRoaXMuYmxvY2tlZC5kb3duICYmICF0aGlzLnRvdWNoaW5nLmRvd24pKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy55ICs9IHRoaXMuX2R5OwogICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgKz0gdGhpcy5fdGVtcC55OwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudmVsb2NpdHkueCA+IHRoaXMubWF4VmVsb2NpdHkueCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCA9IHRoaXMubWF4VmVsb2NpdHkueDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy52ZWxvY2l0eS54IDwgLXRoaXMubWF4VmVsb2NpdHkueCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCA9IC10aGlzLm1heFZlbG9jaXR5Lng7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy52ZWxvY2l0eS55ID4gdGhpcy5tYXhWZWxvY2l0eS55KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ID0gdGhpcy5tYXhWZWxvY2l0eS55OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnZlbG9jaXR5LnkgPCAtdGhpcy5tYXhWZWxvY2l0eS55KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ID0gLXRoaXMubWF4VmVsb2NpdHkueTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kLiBUaGlzIGlzIGNhbGxlZCBkaXJlY3RseSBiZWZvcmUgdGhlIHNwcml0ZXMgYXJlIHNlbnQgdG8gdGhlIHJlbmRlcmVyIGFuZCBhZnRlciB0aGUgdXBkYXRlIGZ1bmN0aW9uIGhhcyBmaW5pc2hlZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNwb3N0VXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwb3N0VXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLm1vdmVzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLnBoeXNpY3MuY2hlY2tCb3VuZHModGhpcyk7CgogICAgICAgICAgICB0aGlzLnJlYm91bmRDaGVjayh0cnVlLCB0cnVlLCB0cnVlKTsKCiAgICAgICAgICAgIHRoaXMuX2R4ID0gdGhpcy5kZWx0YVgoKTsKICAgICAgICAgICAgdGhpcy5fZHkgPSB0aGlzLmRlbHRhWSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX2R4IDwgMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5mYWNpbmcgPSBQaGFzZXIuTEVGVDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLl9keCA+IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZmFjaW5nID0gUGhhc2VyLlJJR0hUOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5fZHkgPCAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZhY2luZyA9IFBoYXNlci5VUDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLl9keSA+IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZmFjaW5nID0gUGhhc2VyLkRPV047CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLl9keCAhPT0gMCB8fCB0aGlzLl9keSAhPT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUueCArPSB0aGlzLl9keDsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgKz0gdGhpcy5fZHk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmFsbG93Um90YXRpb24gJiYgdGhpcy5kZWx0YVooKSAhPT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuYW5nbGUgKz0gdGhpcy5kZWx0YVooKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuc3ByaXRlLnNjYWxlLnggIT09IHRoaXMuX3N4IHx8IHRoaXMuc3ByaXRlLnNjYWxlLnkgIT09IHRoaXMuX3N5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVNjYWxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUmVzZXRzIHRoZSBCb2R5IG1vdGlvbiB2YWx1ZXM6IHZlbG9jaXR5LCBhY2NlbGVyYXRpb24sIGFuZ3VsYXJWZWxvY2l0eSBhbmQgYW5ndWxhckFjY2VsZXJhdGlvbi4KICAgICogQWxzbyByZXNldHMgdGhlIGZvcmNlcyB0byBkZWZhdWx0czogZ3Jhdml0eSwgYm91bmNlLCBtaW5WZWxvY2l0eSxtYXhWZWxvY2l0eSwgYW5ndWxhckRyYWcsIG1heEFuZ3VsYXIsIG1hc3MsIGZyaWN0aW9uIGFuZCBjaGVja0NvbGxpc2lvbiBpZiAnZnVsbCcgc3BlY2lmaWVkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3Jlc2V0CiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2Z1bGw9ZmFsc2VdIC0gQSBmdWxsIHJlc2V0IGNsZWFycyBkb3duIHNldHRpbmdzIHlvdSBtYXkgaGF2ZSBzZXQsIHN1Y2ggYXMgZ3Jhdml0eSwgYm91bmNlIGFuZCBkcmFnLiBBIG5vbi1mdWxsIHJlc2V0IGp1c3QgY2xlYXJzIG1vdGlvbiB2YWx1ZXMuCiAgICAqLwogICAgcmVzZXQ6IGZ1bmN0aW9uIChmdWxsKSB7CgogICAgICAgIGlmICh0eXBlb2YgZnVsbCA9PT0gJ3VuZGVmaW5lZCcpIHsgZnVsbCA9IGZhbHNlOyB9CgogICAgICAgIGlmIChmdWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5ncmF2aXR5LnNldFRvKDAsIDApOwogICAgICAgICAgICB0aGlzLmJvdW5jZS5zZXRUbygwLCAwKTsKICAgICAgICAgICAgdGhpcy5taW5WZWxvY2l0eS5zZXRUbyg1LCA1KTsKICAgICAgICAgICAgdGhpcy5tYXhWZWxvY2l0eS5zZXRUbygxMDAwLCAxMDAwKTsKICAgICAgICAgICAgdGhpcy5hbmd1bGFyRHJhZyA9IDA7CiAgICAgICAgICAgIHRoaXMubWF4QW5ndWxhciA9IDEwMDA7CiAgICAgICAgICAgIHRoaXMubWFzcyA9IDE7CiAgICAgICAgICAgIHRoaXMuZnJpY3Rpb24gPSAwLjA7CiAgICAgICAgICAgIHRoaXMuY2hlY2tDb2xsaXNpb24gPSB7IG5vbmU6IGZhbHNlLCBhbnk6IHRydWUsIHVwOiB0cnVlLCBkb3duOiB0cnVlLCBsZWZ0OiB0cnVlLCByaWdodDogdHJ1ZSB9OwogICAgICAgIH0KCiAgICAgICAgdGhpcy52ZWxvY2l0eS5zZXRUbygwLCAwKTsKICAgICAgICB0aGlzLmFjY2VsZXJhdGlvbi5zZXRUbygwLCAwKTsKICAgICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IDA7CiAgICAgICAgdGhpcy5hbmd1bGFyQWNjZWxlcmF0aW9uID0gMDsKICAgICAgICB0aGlzLmJsb2NrZWQgPSB7IHg6IDAsIHk6IDAsIHVwOiBmYWxzZSwgZG93bjogZmFsc2UsIGxlZnQ6IGZhbHNlLCByaWdodDogZmFsc2UgfTsKICAgICAgICB0aGlzLnggPSAodGhpcy5zcHJpdGUud29ybGQueCAtICh0aGlzLnNwcml0ZS5hbmNob3IueCAqIHRoaXMuc3ByaXRlLndpZHRoKSkgKyB0aGlzLm9mZnNldC54OwogICAgICAgIHRoaXMueSA9ICh0aGlzLnNwcml0ZS53b3JsZC55IC0gKHRoaXMuc3ByaXRlLmFuY2hvci55ICogdGhpcy5zcHJpdGUuaGVpZ2h0KSkgKyB0aGlzLm9mZnNldC55OwogICAgICAgIHRoaXMucHJlWCA9IHRoaXMueDsKICAgICAgICB0aGlzLnByZVkgPSB0aGlzLnk7CiAgICAgICAgdGhpcy51cGRhdGVCb3VuZHMoKTsKCiAgICAgICAgdGhpcy5jb250YWN0cy5sZW5ndGggPSAwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERlc3Ryb3lzIHRoaXMgQm9keSBhbmQgYWxsIHJlZmVyZW5jZXMgaXQgaG9sZHMgdG8gb3RoZXIgb2JqZWN0cy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnNwcml0ZSA9IG51bGw7CgogICAgICAgIHRoaXMuY29sbGlkZUNhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLmNvbGxpZGVDYWxsYmFja0NvbnRleHQgPSBudWxsOwoKICAgICAgICB0aGlzLmN1c3RvbVNlcGFyYXRlQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMuY3VzdG9tU2VwYXJhdGVDb250ZXh0ID0gbnVsbDsKCiAgICAgICAgdGhpcy5jb250YWN0cy5sZW5ndGggPSAwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhpcyBCb2R5IHRvIHVzZSBhIGNpcmNsZSBvZiB0aGUgZ2l2ZW4gcmFkaXVzIGZvciBhbGwgY29sbGlzaW9uLgogICAgKiBUaGUgQ2lyY2xlIHdpbGwgYmUgY2VudGVyZWQgb24gdGhlIGNlbnRlciBvZiB0aGUgU3ByaXRlIGJ5IGRlZmF1bHQsIGJ1dCBjYW4gYmUgYWRqdXN0ZWQgdmlhIHRoZSBCb2R5Lm9mZnNldCBwcm9wZXJ0eSBhbmQgdGhlIHNldENpcmNsZSB4L3kgcGFyYW1ldGVycy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNzZXRDaXJjbGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHJhZGl1cyAtIFRoZSByYWRpdXMgb2YgdGhpcyBjaXJjbGUgKGluIHBpeGVscykKICAgICogQHBhcmFtIHtudW1iZXJ9IFtvZmZzZXRYPTBdIC0gVGhlIHggYW1vdW50IHRoZSBjaXJjbGUgd2lsbCBiZSBvZmZzZXQgZnJvbSB0aGUgU3ByaXRlcyBjZW50ZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0WT0wXSAtIFRoZSB5IGFtb3VudCB0aGUgY2lyY2xlIHdpbGwgYmUgb2Zmc2V0IGZyb20gdGhlIFNwcml0ZXMgY2VudGVyLgogICAgKi8KICAgIHNldENpcmNsZTogZnVuY3Rpb24gKHJhZGl1cywgb2Zmc2V0WCwgb2Zmc2V0WSkgewoKICAgICAgICBpZiAodHlwZW9mIG9mZnNldFggPT09ICd1bmRlZmluZWQnKSB7IG9mZnNldFggPSB0aGlzLnNwcml0ZS5fY2FjaGUuaGFsZldpZHRoOyB9CiAgICAgICAgaWYgKHR5cGVvZiBvZmZzZXRZID09PSAndW5kZWZpbmVkJykgeyBvZmZzZXRZID0gdGhpcy5zcHJpdGUuX2NhY2hlLmhhbGZIZWlnaHQ7IH0KCiAgICAgICAgdGhpcy50eXBlID0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkNJUkNMRTsKICAgICAgICB0aGlzLnNoYXBlID0gbmV3IFNBVC5DaXJjbGUobmV3IFNBVC5WZWN0b3IodGhpcy5zcHJpdGUueCwgdGhpcy5zcHJpdGUueSksIHJhZGl1cyk7CiAgICAgICAgdGhpcy5wb2x5Z29uID0gbnVsbDsKCiAgICAgICAgdGhpcy5vZmZzZXQuc2V0VG8ob2Zmc2V0WCwgb2Zmc2V0WSk7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGlzIEJvZHkgdG8gdXNlIGEgcmVjdGFuZ2xlIGZvciBhbGwgY29sbGlzaW9uLgogICAgKiBJZiB5b3UgZG9uJ3Qgc3BlY2lmeSBhbnkgcGFyYW1ldGVycyBpdCB3aWxsIGJlIHNpemVkIHRvIG1hdGNoIHRoZSBwYXJlbnQgU3ByaXRlcyBjdXJyZW50IHdpZHRoIGFuZCBoZWlnaHQgKGluY2x1ZGluZyBzY2FsZSBmYWN0b3IpIGFuZCBjZW50ZXJlZCBvbiB0aGUgc3ByaXRlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3NldFJlY3RhbmdsZQogICAgKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoXSAtIFRoZSB3aWR0aCBvZiB0aGUgcmVjdGFuZ2xlLiBJZiBub3Qgc3BlY2lmaWVkIGl0IHdpbGwgZGVmYXVsdCB0byB0aGUgd2lkdGggb2YgdGhlIHBhcmVudCBTcHJpdGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0XSAtIFRoZSBoZWlnaHQgb2YgdGhlIHJlY3RhbmdsZS4gSWYgbm90IHNwZWNpZmllZCBpdCB3aWxsIGRlZmF1bHQgdG8gdGhlIGhlaWdodCBvZiB0aGUgcGFyZW50IFNwcml0ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt0cmFuc2xhdGVYXSAtIFRoZSB4IGFtb3VudCB0aGUgcmVjdGFuZ2xlIHdpbGwgYmUgdHJhbnNsYXRlZCBmcm9tIHRoZSBTcHJpdGVzIGNlbnRlci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt0cmFuc2xhdGVZXSAtIFRoZSB5IGFtb3VudCB0aGUgcmVjdGFuZ2xlIHdpbGwgYmUgdHJhbnNsYXRlZCBmcm9tIHRoZSBTcHJpdGVzIGNlbnRlci4KICAgICovCiAgICBzZXRSZWN0YW5nbGU6IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0LCB0cmFuc2xhdGVYLCB0cmFuc2xhdGVZKSB7CgogICAgICAgIGlmICh0eXBlb2Ygd2lkdGggPT09ICd1bmRlZmluZWQnKSB7IHdpZHRoID0gdGhpcy5zcHJpdGUud2lkdGg7IH0KICAgICAgICBpZiAodHlwZW9mIGhlaWdodCA9PT0gJ3VuZGVmaW5lZCcpIHsgaGVpZ2h0ID0gdGhpcy5zcHJpdGUuaGVpZ2h0OyB9CiAgICAgICAgaWYgKHR5cGVvZiB0cmFuc2xhdGVYID09PSAndW5kZWZpbmVkJykgeyB0cmFuc2xhdGVYID0gLXRoaXMuc3ByaXRlLl9jYWNoZS5oYWxmV2lkdGg7IH0KICAgICAgICBpZiAodHlwZW9mIHRyYW5zbGF0ZVkgPT09ICd1bmRlZmluZWQnKSB7IHRyYW5zbGF0ZVkgPSAtdGhpcy5zcHJpdGUuX2NhY2hlLmhhbGZIZWlnaHQ7IH0KCiAgICAgICAgdGhpcy50eXBlID0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLlJFQ1Q7CiAgICAgICAgdGhpcy5zaGFwZSA9IG5ldyBTQVQuQm94KG5ldyBTQVQuVmVjdG9yKHRoaXMuc3ByaXRlLndvcmxkLngsIHRoaXMuc3ByaXRlLndvcmxkLnkpLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgICB0aGlzLnBvbHlnb24gPSB0aGlzLnNoYXBlLnRvUG9seWdvbigpOwogICAgICAgIHRoaXMucG9seWdvbi50cmFuc2xhdGUodHJhbnNsYXRlWCwgdHJhbnNsYXRlWSk7CgogICAgICAgIHRoaXMub2Zmc2V0LnNldFRvKDAsIDApOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhpcyBCb2R5IHRvIHVzZSBhIGNvbnZleCBwb2x5Z29uIGZvciBjb2xsaXNpb24uCiAgICAqIFRoZSBwb2ludHMgYXJlIHNwZWNpZmllZCBpbiBhIGNvdW50ZXItY2xvY2t3aXNlIGRpcmVjdGlvbiBhbmQgbXVzdCBjcmVhdGUgYSBjb252ZXggcG9seWdvbi4KICAgICogVXNlIEJvZHkudHJhbnNsYXRlIGFuZC9vciBCb2R5Lm9mZnNldCB0byByZS1wb3NpdGlvbiB0aGUgcG9seWdvbiBmcm9tIHRoZSBTcHJpdGUgb3JpZ2luLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3NldFBvbHlnb24KICAgICogQHBhcmFtIHsoU0FULlZlY3RvcltdfG51bWJlcltdfC4uLlNBVC5WZWN0b3J8Li4ubnVtYmVyKX0gcG9pbnRzIC0gVGhpcyBjYW4gYmUgYW4gYXJyYXkgb2YgVmVjdG9ycyB0aGF0IGZvcm0gdGhlIHBvbHlnb24sCiAgICAqICAgICAgYSBmbGF0IGFycmF5IG9mIG51bWJlcnMgdGhhdCB3aWxsIGJlIGludGVycHJldGVkIGFzIFt4LHksIHgseSwgLi4uXSwgb3IgdGhlIGFyZ3VtZW50cyBwYXNzZWQgY2FuIGJlCiAgICAqICAgICAgYWxsIHRoZSBwb2ludHMgb2YgdGhlIHBvbHlnb24gZS5nLiBgc2V0UG9seWdvbihuZXcgU0FULlZlY3RvcigpLCBuZXcgU0FULlZlY3RvcigpLCAuLi4pYCwgb3IgdGhlCiAgICAqICAgICAgYXJndW1lbnRzIHBhc3NlZCBjYW4gYmUgZmxhdCB4LHkgdmFsdWVzIGUuZy4gYHNldFBvbHlnb24oeCx5LCB4LHksIHgseSwgLi4uKWAgd2hlcmUgYHhgIGFuZCBgeWAgYXJlIE51bWJlcnMuCiAgICAqLwogICAgc2V0UG9seWdvbjogZnVuY3Rpb24gKHBvaW50cykgewoKICAgICAgICB0aGlzLnR5cGUgPSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuUE9MWUdPTjsKICAgICAgICB0aGlzLnNoYXBlID0gbnVsbDsKCiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHBvaW50cykpCiAgICAgICAgewogICAgICAgICAgICBwb2ludHMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBwb2ludHNbMF0gPT09ICdudW1iZXInKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHAgPSBbXTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBwb2ludHMubGVuZ3RoOyBpIDwgbGVuOyBpICs9IDIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHAucHVzaChuZXcgU0FULlZlY3Rvcihwb2ludHNbaV0sIHBvaW50c1tpICsgMV0pKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcG9pbnRzID0gcDsKICAgICAgICB9CgogICAgICAgIHRoaXMucG9seWdvbiA9IG5ldyBTQVQuUG9seWdvbihuZXcgU0FULlZlY3Rvcih0aGlzLnNwcml0ZS5jZW50ZXIueCwgdGhpcy5zcHJpdGUuY2VudGVyLnkpLCBwb2ludHMpOwoKICAgICAgICB0aGlzLm9mZnNldC5zZXRUbygwLCAwKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBVc2VkIGZvciB0cmFuc2xhdGluZyByZWN0YW5nbGUgYW5kIHBvbHlnb24gYm9kaWVzIGZyb20gdGhlIFNwcml0ZSBwYXJlbnQuIERvZXNuJ3QgYXBwbHkgdG8gQ2lyY2xlcy4KICAgICogU2VlIGFsc28gdGhlIEJvZHkub2Zmc2V0IHByb3BlcnR5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3RyYW5zbGF0ZQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGFtb3VudCB0aGUgcG9seWdvbiBvciByZWN0YW5nbGUgd2lsbCBiZSB0cmFuc2xhdGVkIGJ5IGZyb20gdGhlIFNwcml0ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBhbW91bnQgdGhlIHBvbHlnb24gb3IgcmVjdGFuZ2xlIHdpbGwgYmUgdHJhbnNsYXRlZCBieSBmcm9tIHRoZSBTcHJpdGUuCiAgICAqLwogICAgdHJhbnNsYXRlOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICBpZiAodGhpcy5wb2x5Z29uKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5wb2x5Z29uLnRyYW5zbGF0ZSh4LCB5KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogRGV0ZXJtaW5lcyBpZiB0aGlzIEJvZHkgaXMgJ29uIHRoZSBmbG9vcicsIHdoaWNoIG1lYW5zIGluIGNvbnRhY3Qgd2l0aCBhIFRpbGUgb3IgV29ybGQgYm91bmRzLCBvciBvdGhlciBvYmplY3QgdGhhdCBoYXMgc2V0ICdkb3duJyBhcyBibG9ja2VkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I29uRmxvb3IKICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGlzIEJvZHkgaXMgJ29uIHRoZSBmbG9vcicsIHdoaWNoIG1lYW5zIGluIGNvbnRhY3Qgd2l0aCBhIFRpbGUgb3IgV29ybGQgYm91bmRzLCBvciBvYmplY3QgdGhhdCBoYXMgc2V0ICdkb3duJyBhcyBibG9ja2VkLgogICAgKi8KICAgIG9uRmxvb3I6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5ibG9ja2VkLmRvd247CiAgICB9LAoKICAgIC8qKgogICAgKiBEZXRlcm1pbnMgaWYgdGhpcyBCb2R5IGlzICdvbiBhIHdhbGwnLCB3aGljaCBtZWFucyBob3Jpem9udGFsbHkgaW4gY29udGFjdCB3aXRoIGEgVGlsZSBvciBXb3JsZCBib3VuZHMsIG9yIG90aGVyIG9iamVjdCBidXQgbm90IHRoZSBncm91bmQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjb25XYWxsCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBCb2R5IGlzICdvbiBhIHdhbGwnLCB3aGljaCBtZWFucyBob3Jpem9udGFsbHkgaW4gY29udGFjdCB3aXRoIGEgVGlsZSBvciBXb3JsZCBib3VuZHMsIG9yIG90aGVyIG9iamVjdCBidXQgbm90IHRoZSBncm91bmQuCiAgICAqLwogICAgb25XYWxsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICghdGhpcy5ibG9ja2VkLmRvd24gJiYgKHRoaXMuYmxvY2tlZC5sZWZ0IHx8IHRoaXMuYmxvY2tlZC5yaWdodCkpOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgZGVsdGEgeCB2YWx1ZS4gVGhlIGFtb3VudCB0aGUgQm9keSBoYXMgbW92ZWQgaG9yaXpvbnRhbGx5IGluIHRoZSBjdXJyZW50IHN0ZXAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjZGVsdGFYCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRlbHRhIHZhbHVlLiBQb3NpdGl2ZSBpZiB0aGUgbW90aW9uIHdhcyB0byB0aGUgcmlnaHQsIG5lZ2F0aXZlIGlmIHRvIHRoZSBsZWZ0LgogICAgKi8KICAgIGRlbHRhWDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnggLSB0aGlzLnByZVg7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBkZWx0YSB5IHZhbHVlLiBUaGUgYW1vdW50IHRoZSBCb2R5IGhhcyBtb3ZlZCB2ZXJ0aWNhbGx5IGluIHRoZSBjdXJyZW50IHN0ZXAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjZGVsdGFZCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRlbHRhIHZhbHVlLiBQb3NpdGl2ZSBpZiB0aGUgbW90aW9uIHdhcyBkb3dud2FyZHMsIG5lZ2F0aXZlIGlmIHVwd2FyZHMuCiAgICAqLwogICAgZGVsdGFZOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueSAtIHRoaXMucHJlWTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIGRlbHRhIHogdmFsdWUuIFRoZSBhbW91bnQgdGhlIEJvZHkgaGFzIHJvdGF0ZWQgaW4gdGhlIGN1cnJlbnQgc3RlcC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNkZWx0YVoKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGVsdGEgdmFsdWUuCiAgICAqLwogICAgZGVsdGFaOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucm90YXRpb24gLSB0aGlzLnByZVJvdGF0aW9uOwogICAgfQoKfTsKClBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5OwoKLyoqCiogQG5hbWUgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjeAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGlzIEJvZHkuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keS5wcm90b3R5cGUsICJ4IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAKICAgICAgICBpZiAodGhpcy50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQ0lSQ0xFKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2hhcGUucG9zLng7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvbHlnb24ucG9zLng7CiAgICAgICAgfQoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkNJUkNMRSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc2hhcGUucG9zLnggPSB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5wb2x5Z29uLnBvcy54ID0gdmFsdWU7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjeQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGlzIEJvZHkuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keS5wcm90b3R5cGUsICJ5IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAKICAgICAgICBpZiAodGhpcy50eXBlID09PSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQ0lSQ0xFKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2hhcGUucG9zLnk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvbHlnb24ucG9zLnk7CiAgICAgICAgfQoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkNJUkNMRSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc2hhcGUucG9zLnkgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5wb2x5Z29uLnBvcy55ID0gdmFsdWU7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLlBhcnRpY2xlcyBpcyB0aGUgUGFydGljbGUgTWFuYWdlciBmb3IgdGhlIGdhbWUuIEl0IGlzIGNhbGxlZCBkdXJpbmcgdGhlIGdhbWUgdXBkYXRlIGxvb3AgYW5kIGluIHR1cm4gdXBkYXRlcyBhbnkgRW1pdHRlcnMgYXR0YWNoZWQgdG8gaXQuCioKKiBAY2xhc3MgUGhhc2VyLlBhcnRpY2xlcwoqIEBjbGFzc2Rlc2MgUGhhc2VyIFBhcnRpY2xlcwoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLlBhcnRpY2xlcyA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gZW1pdHRlcnMgLSBJbnRlcm5hbCBlbWl0dGVycyBzdG9yZS4KICAgICovCiAgICB0aGlzLmVtaXR0ZXJzID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBJRCAtIAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuSUQgPSAwOwoKfTsKClBoYXNlci5QYXJ0aWNsZXMucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBBZGRzIGEgbmV3IFBhcnRpY2xlIEVtaXR0ZXIgdG8gdGhlIFBhcnRpY2xlIE1hbmFnZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcyNhZGQKICAgICogQHBhcmFtIHtQaGFzZXIuRW1pdHRlcn0gZW1pdHRlciAtIFRoZSBlbWl0dGVyIHRvIGJlIGFkZGVkIHRvIHRoZSBwYXJ0aWNsZSBtYW5hZ2VyLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRW1pdHRlcn0gVGhlIGVtaXR0ZXIgdGhhdCB3YXMgYWRkZWQuCiAgICAqLwogICAgYWRkOiBmdW5jdGlvbiAoZW1pdHRlcikgewoKICAgICAgICB0aGlzLmVtaXR0ZXJzW2VtaXR0ZXIubmFtZV0gPSBlbWl0dGVyOwoKICAgICAgICByZXR1cm4gZW1pdHRlcjsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGFuIGV4aXN0aW5nIFBhcnRpY2xlIEVtaXR0ZXIgZnJvbSB0aGUgUGFydGljbGUgTWFuYWdlci4KICAgICogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzI3JlbW92ZQogICAgKiBAcGFyYW0ge1BoYXNlci5FbWl0dGVyfSBlbWl0dGVyIC0gVGhlIGVtaXR0ZXIgdG8gcmVtb3ZlLgogICAgKi8KICAgIHJlbW92ZTogZnVuY3Rpb24gKGVtaXR0ZXIpIHsKCiAgICAgICAgZGVsZXRlIHRoaXMuZW1pdHRlcnNbZW1pdHRlci5uYW1lXTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgYnkgdGhlIGNvcmUgZ2FtZSBsb29wLiBVcGRhdGVzIGFsbCBFbWl0dGVycyB3aG8gaGF2ZSB0aGVpciBleGlzdHMgdmFsdWUgc2V0IHRvIHRydWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcyN1cGRhdGUKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5lbWl0dGVycykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmVtaXR0ZXJzW2tleV0uZXhpc3RzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmVtaXR0ZXJzW2tleV0udXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfQoKfTsKClBoYXNlci5QYXJ0aWNsZXMucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlBhcnRpY2xlczsKClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlID0ge30KLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTQgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyIC0gQXJjYWRlRW1pdHRlcgoqCiogQGNsYXNzIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIKKiBAY2xhc3NkZXNjIEVtaXR0ZXIgaXMgYSBsaWdodHdlaWdodCBwYXJ0aWNsZSBlbWl0dGVyLiBJdCBjYW4gYmUgdXNlZCBmb3Igb25lLXRpbWUgZXhwbG9zaW9ucyBvciBmb3IKKiBjb250aW51b3VzIGVmZmVjdHMgbGlrZSByYWluIGFuZCBmaXJlLiBBbGwgaXQgcmVhbGx5IGRvZXMgaXMgbGF1bmNoIFBhcnRpY2xlIG9iamVjdHMgb3V0CiogYXQgc2V0IGludGVydmFscywgYW5kIGZpeGVzIHRoZWlyIHBvc2l0aW9ucyBhbmQgdmVsb2NpdGllcyBhY2NvcmluZGdseS4KKiBAY29uc3RydWN0b3IKKiBAZXh0ZW5kcyBQaGFzZXIuR3JvdXAKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7bnVtYmVyfSBbeD0wXSAtIFRoZSB4IGNvb3JkaW5hdGUgd2l0aGluIHRoZSBFbWl0dGVyIHRoYXQgdGhlIHBhcnRpY2xlcyBhcmUgZW1pdHRlZCBmcm9tLgoqIEBwYXJhbSB7bnVtYmVyfSBbeT0wXSAtIFRoZSB5IGNvb3JkaW5hdGUgd2l0aGluIHRoZSBFbWl0dGVyIHRoYXQgdGhlIHBhcnRpY2xlcyBhcmUgZW1pdHRlZCBmcm9tLgoqIEBwYXJhbSB7bnVtYmVyfSBbbWF4UGFydGljbGVzPTUwXSAtIFRoZSB0b3RhbCBudW1iZXIgb2YgcGFydGljbGVzIGluIHRoaXMgZW1pdHRlci4uCiovCgpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyID0gZnVuY3Rpb24gKGdhbWUsIHgsIHksIG1heFBhcnRpY2xlcykgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4UGFydGljbGVzIC0gVGhlIHRvdGFsIG51bWJlciBvZiBwYXJ0aWNsZXMgaW4gdGhpcyBlbWl0dGVyLi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1heFBhcnRpY2xlcyA9IG1heFBhcnRpY2xlcyB8fCA1MDsKCiAgICBQaGFzZXIuR3JvdXAuY2FsbCh0aGlzLCBnYW1lKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBEZXNjcmlwdGlvbi4KICAgICovCiAgICB0aGlzLm5hbWUgPSAnZW1pdHRlcicgKyB0aGlzLmdhbWUucGFydGljbGVzLklEKys7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0eXBlIC0gSW50ZXJuYWwgUGhhc2VyIFR5cGUgdmFsdWUuCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuRU1JVFRFUjsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBUaGUgWCBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgY29ybmVyIG9mIHRoZSBlbWl0dGVyIGluIHdvcmxkIHNwYWNlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMueCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIFkgcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IGNvcm5lciBvZiBlbWl0dGVyIGluIHdvcmxkIHNwYWNlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMueSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgZW1pdHRlci4gIFBhcnRpY2xlcyBjYW4gYmUgcmFuZG9tbHkgZ2VuZXJhdGVkIGZyb20gYW55d2hlcmUgd2l0aGluIHRoaXMgYm94LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMud2lkdGggPSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgZW1pdHRlci4gIFBhcnRpY2xlcyBjYW4gYmUgcmFuZG9tbHkgZ2VuZXJhdGVkIGZyb20gYW55d2hlcmUgd2l0aGluIHRoaXMgYm94LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaGVpZ2h0ID0gMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IG1pblBhcnRpY2xlU3BlZWQgLSBUaGUgbWluaW11bSBwb3NzaWJsZSB2ZWxvY2l0eSBvZiBhIHBhcnRpY2xlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWluUGFydGljbGVTcGVlZCA9IG5ldyBQaGFzZXIuUG9pbnQoLTEwMCwgLTEwMCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBtYXhQYXJ0aWNsZVNwZWVkIC0gVGhlIG1heGltdW0gcG9zc2libGUgdmVsb2NpdHkgb2YgYSBwYXJ0aWNsZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1heFBhcnRpY2xlU3BlZWQgPSBuZXcgUGhhc2VyLlBvaW50KDEwMCwgMTAwKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1pblBhcnRpY2xlU2NhbGUgLSBUaGUgbWluaW11bSBwb3NzaWJsZSBzY2FsZSBvZiBhIHBhcnRpY2xlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWluUGFydGljbGVTY2FsZSA9IDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYXhQYXJ0aWNsZVNjYWxlIC0gVGhlIG1heGltdW0gcG9zc2libGUgc2NhbGUgb2YgYSBwYXJ0aWNsZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1heFBhcnRpY2xlU2NhbGUgPSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWluUm90YXRpb24gLSBUaGUgbWluaW11bSBwb3NzaWJsZSBhbmd1bGFyIHZlbG9jaXR5IG9mIGEgcGFydGljbGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5taW5Sb3RhdGlvbiA9IC0zNjA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYXhSb3RhdGlvbiAtIFRoZSBtYXhpbXVtIHBvc3NpYmxlIGFuZ3VsYXIgdmVsb2NpdHkgb2YgYSBwYXJ0aWNsZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1heFJvdGF0aW9uID0gMzYwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZ3Jhdml0eSAtIFNldHMgdGhlIGBib2R5LmdyYXZpdHkueWAgb2YgZWFjaCBwYXJ0aWNsZSBzcHJpdGUgdG8gdGhpcyB2YWx1ZSBvbiBsYXVuY2guCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5ncmF2aXR5ID0gMTAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FueX0gcGFydGljbGVDbGFzcyAtIEZvciBlbWl0dGluZyB5b3VyIG93biBwYXJ0aWNsZSBjbGFzcyB0eXBlcy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhcnRpY2xlQ2xhc3MgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGFydGljbGVGcmljdGlvbiAtIFRoZSBmcmljdGlvbiBjb21wb25lbnQgb2YgcGFydGljbGVzIGxhdW5jaGVkIGZyb20gdGhlIGVtaXR0ZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYXJ0aWNsZUZyaWN0aW9uID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ3VsYXJEcmFnIC0gVGhlIGFuZ3VsYXIgZHJhZyBjb21wb25lbnQgb2YgcGFydGljbGVzIGxhdW5jaGVkIGZyb20gdGhlIGVtaXR0ZXIgaWYgdGhleSBhcmUgcm90YXRpbmcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbmd1bGFyRHJhZyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZnJlcXVlbmN5IC0gSG93IG9mdGVuIGEgcGFydGljbGUgaXMgZW1pdHRlZCBpbiBtcyAoaWYgZW1pdHRlciBpcyBzdGFydGVkIHdpdGggRXhwbG9kZSA9PT0gZmFsc2UpLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZnJlcXVlbmN5ID0gMTAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbGlmZXNwYW4gLSBIb3cgbG9uZyBlYWNoIHBhcnRpY2xlIGxpdmVzIG9uY2UgaXQgaXMgZW1pdHRlZCBpbiBtcy4gRGVmYXVsdCBpcyAyIHNlY29uZHMuIFNldCBsaWZlc3BhbiB0byAnemVybycgZm9yIHBhcnRpY2xlcyB0byBsaXZlIGZvcmV2ZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5saWZlc3BhbiA9IDIwMDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBib3VuY2UgLSBIb3cgbXVjaCBlYWNoIHBhcnRpY2xlIHNob3VsZCBib3VuY2Ugb24gZWFjaCBheGlzLiAgMSA9IGZ1bGwgYm91bmNlLCAwID0gbm8gYm91bmNlLgogICAgKi8KICAgIHRoaXMuYm91bmNlID0gbmV3IFBoYXNlci5Qb2ludCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3F1YW50aXR5IC0gSW50ZXJuYWwgaGVscGVyIGZvciBkZWNpZGluZyBob3cgbWFueSBwYXJ0aWNsZXMgdG8gbGF1bmNoLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3F1YW50aXR5ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF90aW1lciAtIEludGVybmFsIGhlbHBlciBmb3IgZGVjaWRpbmcgd2hlbiB0byBsYXVuY2ggcGFydGljbGVzIG9yIGtpbGwgdGhlbS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90aW1lciA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfY291bnRlciAtIEludGVybmFsIGNvdW50ZXIgZm9yIGZpZ3VyaW5nIG91dCBob3cgbWFueSBwYXJ0aWNsZXMgdG8gbGF1bmNoLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2NvdW50ZXIgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9leHBsb2RlIC0gSW50ZXJuYWwgaGVscGVyIGZvciB0aGUgc3R5bGUgb2YgcGFydGljbGUgZW1pc3Npb24gKGFsbCBhdCBvbmNlLCBvciBvbmUgYXQgYSB0aW1lKS4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9leHBsb2RlID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBvbiAtIERldGVybWluZXMgd2hldGhlciB0aGUgZW1pdHRlciBpcyBjdXJyZW50bHkgZW1pdHRpbmcgcGFydGljbGVzLiBJdCBpcyB0b3RhbGx5IHNhZmUgdG8gZGlyZWN0bHkgdG9nZ2xlIHRoaXMuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vbiA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGV4aXN0cyAtIERldGVybWluZXMgd2hldGhlciB0aGUgZW1pdHRlciBpcyBiZWluZyB1cGRhdGVkIGJ5IHRoZSBjb3JlIGdhbWUgbG9vcC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmV4aXN0cyA9IHRydWU7CgogICAgLyoqCiAgICAqIFRoZSBwb2ludCB0aGUgcGFydGljbGVzIGFyZSBlbWl0dGVkIGZyb20uCiAgICAqIEVtaXR0ZXIueCBhbmQgRW1pdHRlci55IGNvbnRyb2wgdGhlIGNvbnRhaW5lcnMgbG9jYXRpb24sIHdoaWNoIHVwZGF0ZXMgYWxsIGN1cnJlbnQgcGFydGljbGVzCiAgICAqIEVtaXR0ZXIuZW1pdFggYW5kIEVtaXR0ZXIuZW1pdFkgY29udHJvbCB0aGUgZW1pc3Npb24gbG9jYXRpb24gcmVsYXRpdmUgdG8gdGhlIHgveSBwb3NpdGlvbi4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBlbWl0WAogICAgKi8KICAgIHRoaXMuZW1pdFggPSB4OwogICAgCiAgICAvKioKICAgICogVGhlIHBvaW50IHRoZSBwYXJ0aWNsZXMgYXJlIGVtaXR0ZWQgZnJvbS4KICAgICogRW1pdHRlci54IGFuZCBFbWl0dGVyLnkgY29udHJvbCB0aGUgY29udGFpbmVycyBsb2NhdGlvbiwgd2hpY2ggdXBkYXRlcyBhbGwgY3VycmVudCBwYXJ0aWNsZXMKICAgICogRW1pdHRlci5lbWl0WCBhbmQgRW1pdHRlci5lbWl0WSBjb250cm9sIHRoZSBlbWlzc2lvbiBsb2NhdGlvbiByZWxhdGl2ZSB0byB0aGUgeC95IHBvc2l0aW9uLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGVtaXRZCiAgICAqLwogICAgdGhpcy5lbWl0WSA9IHk7CiAgICAKfTsKClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQaGFzZXIuR3JvdXAucHJvdG90eXBlKTsKUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyOwoKLyoqCiogQ2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgdGhlIGdhbWUgbG9vcCwgZGVjaWRlcyB3aGVuIHRvIGxhdW5jaCBwYXJ0aWNsZXMgYW5kIHdoZW4gdG8gImRpZSIuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3VwZGF0ZQoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoKSB7CgogICAgaWYgKHRoaXMub24pCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX2V4cGxvZGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9jb3VudGVyID0gMDsKCiAgICAgICAgICAgIGRvCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZW1pdFBhcnRpY2xlKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9jb3VudGVyKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2NvdW50ZXIgPCB0aGlzLl9xdWFudGl0eSk7CgogICAgICAgICAgICB0aGlzLm9uID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUudGltZS5ub3cgPj0gdGhpcy5fdGltZXIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZW1pdFBhcnRpY2xlKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuX2NvdW50ZXIrKzsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcXVhbnRpdHkgPiAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9jb3VudGVyID49IHRoaXMuX3F1YW50aXR5KQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbiA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLl90aW1lciA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIHRoaXMuZnJlcXVlbmN5OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKfQoKLyoqCiogVGhpcyBmdW5jdGlvbiBnZW5lcmF0ZXMgYSBuZXcgYXJyYXkgb2YgcGFydGljbGUgc3ByaXRlcyB0byBhdHRhY2ggdG8gdGhlIGVtaXR0ZXIuCioKKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjbWFrZVBhcnRpY2xlcwoqIEBwYXJhbSB7YXJyYXl8c3RyaW5nfSBrZXlzIC0gQSBzdHJpbmcgb3IgYW4gYXJyYXkgb2Ygc3RyaW5ncyB0aGF0IHRoZSBwYXJ0aWNsZSBzcHJpdGVzIHdpbGwgdXNlIGFzIHRoZWlyIHRleHR1cmUuIElmIGFuIGFycmF5IG9uZSBpcyBwaWNrZWQgYXQgcmFuZG9tLgoqIEBwYXJhbSB7YXJyYXl8bnVtYmVyfSBmcmFtZXMgLSBBIGZyYW1lIG51bWJlciwgb3IgYXJyYXkgb2YgZnJhbWVzIHRoYXQgdGhlIHNwcml0ZSB3aWxsIHVzZS4gSWYgYW4gYXJyYXkgb25lIGlzIHBpY2tlZCBhdCByYW5kb20uCiogQHBhcmFtIHtudW1iZXJ9IHF1YW50aXR5IC0gVGhlIG51bWJlciBvZiBwYXJ0aWNsZXMgdG8gZ2VuZXJhdGUuCiogQHBhcmFtIHtib29sZWFufSBbY29sbGlkZT1mYWxzZV0gLSBTZXRzIHRoZSBjaGVja0NvbGxpc2lvbi5ub25lIGZsYWcgb24gdGhlIHBhcnRpY2xlIHNwcml0ZXMgYm9keS4KKiBAcGFyYW0ge2Jvb2xlYW59IFtjb2xsaWRlV29ybGRCb3VuZHM9ZmFsc2VdIC0gQSBwYXJ0aWNsZSBjYW4gYmUgc2V0IHRvIGNvbGxpZGUgYWdhaW5zdCB0aGUgV29ybGQgYm91bmRzIGF1dG9tYXRpY2FsbHkgYW5kIHJlYm91bmQgYmFjayBpbnRvIHRoZSBXb3JsZCBpZiB0aGlzIGlzIHNldCB0byB0cnVlLiBPdGhlcndpc2UgaXQgd2lsbCBsZWF2ZSB0aGUgV29ybGQuCiogQHJldHVybiB7UGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlcn0gVGhpcyBFbWl0dGVyIGluc3RhbmNlLgoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5tYWtlUGFydGljbGVzID0gZnVuY3Rpb24gKGtleXMsIGZyYW1lcywgcXVhbnRpdHksIGNvbGxpZGUsIGNvbGxpZGVXb3JsZEJvdW5kcykgewoKICAgIGlmICh0eXBlb2YgZnJhbWVzID09PSAndW5kZWZpbmVkJykgeyBmcmFtZXMgPSAwOyB9CiAgICBpZiAodHlwZW9mIHF1YW50aXR5ID09PSAndW5kZWZpbmVkJykgeyBxdWFudGl0eSA9IHRoaXMubWF4UGFydGljbGVzOyB9CiAgICBpZiAodHlwZW9mIGNvbGxpZGUgPT09ICd1bmRlZmluZWQnKSB7IGNvbGxpZGUgPSBmYWxzZTsgfQogICAgaWYgKHR5cGVvZiBjb2xsaWRlV29ybGRCb3VuZHMgPT09ICd1bmRlZmluZWQnKSB7IGNvbGxpZGVXb3JsZEJvdW5kcyA9IGZhbHNlOyB9CgogICAgdmFyIHBhcnRpY2xlOwogICAgdmFyIGkgPSAwOwogICAgdmFyIHJuZEtleSA9IGtleXM7CiAgICB2YXIgcm5kRnJhbWUgPSBmcmFtZXM7CgogICAgd2hpbGUgKGkgPCBxdWFudGl0eSkKICAgIHsKICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZUNsYXNzID09PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBrZXlzID09PSAnb2JqZWN0JykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcm5kS2V5ID0gdGhpcy5nYW1lLnJuZC5waWNrKGtleXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mIGZyYW1lcyA9PT0gJ29iamVjdCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJuZEZyYW1lID0gdGhpcy5nYW1lLnJuZC5waWNrKGZyYW1lcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHBhcnRpY2xlID0gbmV3IFBoYXNlci5TcHJpdGUodGhpcy5nYW1lLCAwLCAwLCBybmRLZXksIHJuZEZyYW1lKTsKICAgICAgICB9CiAgICAgICAgLy8gZWxzZQogICAgICAgIC8vIHsKICAgICAgICAgICAgLy8gcGFydGljbGUgPSBuZXcgdGhpcy5wYXJ0aWNsZUNsYXNzKHRoaXMuZ2FtZSk7CiAgICAgICAgLy8gfQoKICAgICAgICBpZiAoY29sbGlkZSkKICAgICAgICB7CiAgICAgICAgICAgIHBhcnRpY2xlLmJvZHkuY2hlY2tDb2xsaXNpb24uYW55ID0gdHJ1ZTsKICAgICAgICAgICAgcGFydGljbGUuYm9keS5jaGVja0NvbGxpc2lvbi5ub25lID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHBhcnRpY2xlLmJvZHkuY2hlY2tDb2xsaXNpb24ubm9uZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBwYXJ0aWNsZS5ib2R5LmNvbGxpZGVXb3JsZEJvdW5kcyA9IGNvbGxpZGVXb3JsZEJvdW5kczsKCiAgICAgICAgcGFydGljbGUuZXhpc3RzID0gZmFsc2U7CiAgICAgICAgcGFydGljbGUudmlzaWJsZSA9IGZhbHNlOwoKICAgICAgICAvLyAgQ2VudGVyIHRoZSBvcmlnaW4gZm9yIHJvdGF0aW9uIGFzc2lzdGFuY2UKICAgICAgICBwYXJ0aWNsZS5hbmNob3Iuc2V0VG8oMC41LCAwLjUpOwoKICAgICAgICB0aGlzLmFkZChwYXJ0aWNsZSk7CgogICAgICAgIGkrKzsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKfQoKLyoqCiogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIHR1cm4gb2ZmIGFsbCB0aGUgcGFydGljbGVzIGFuZCB0aGUgZW1pdHRlci4KKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIja2lsbAoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5raWxsID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMub24gPSBmYWxzZTsKICAgIHRoaXMuYWxpdmUgPSBmYWxzZTsKICAgIHRoaXMuZXhpc3RzID0gZmFsc2U7Cgp9CgovKioKKiBIYW5keSBmb3IgYnJpbmdpbmcgZ2FtZSBvYmplY3RzICJiYWNrIHRvIGxpZmUiLiBKdXN0IHNldHMgYWxpdmUgYW5kIGV4aXN0cyBiYWNrIHRvIHRydWUuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3Jldml2ZQoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5yZXZpdmUgPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5hbGl2ZSA9IHRydWU7CiAgICB0aGlzLmV4aXN0cyA9IHRydWU7Cgp9CgovKioKKiBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gc3RhcnQgZW1pdHRpbmcgcGFydGljbGVzLgoqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNzdGFydAoqIEBwYXJhbSB7Ym9vbGVhbn0gW2V4cGxvZGU9dHJ1ZV0gLSBXaGV0aGVyIHRoZSBwYXJ0aWNsZXMgc2hvdWxkIGFsbCBidXJzdCBvdXQgYXQgb25jZS4KKiBAcGFyYW0ge251bWJlcn0gW2xpZmVzcGFuPTBdIC0gSG93IGxvbmcgZWFjaCBwYXJ0aWNsZSBsaXZlcyBvbmNlIGVtaXR0ZWQuIDAgPSBmb3JldmVyLgoqIEBwYXJhbSB7bnVtYmVyfSBbZnJlcXVlbmN5PTI1MF0gLSBJZ25vcmVkIGlmIEV4cGxvZGUgaXMgc2V0IHRvIHRydWUuIEZyZXF1ZW5jeSBpcyBob3cgb2Z0ZW4gdG8gZW1pdCBhIHBhcnRpY2xlIGluIG1zLgoqIEBwYXJhbSB7bnVtYmVyfSBbcXVhbnRpdHk9MF0gLSBIb3cgbWFueSBwYXJ0aWNsZXMgdG8gbGF1bmNoLiAwID0gImFsbCBvZiB0aGUgcGFydGljbGVzIi4KKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAoZXhwbG9kZSwgbGlmZXNwYW4sIGZyZXF1ZW5jeSwgcXVhbnRpdHkpIHsKCiAgICBpZiAodHlwZW9mIGV4cGxvZGUgPT09ICd1bmRlZmluZWQnKSB7IGV4cGxvZGUgPSB0cnVlOyB9CiAgICBpZiAodHlwZW9mIGxpZmVzcGFuID09PSAndW5kZWZpbmVkJykgeyBsaWZlc3BhbiA9IDA7IH0KICAgIGlmICh0eXBlb2YgZnJlcXVlbmN5ID09PSAndW5kZWZpbmVkJykgeyBmcmVxdWVuY3kgPSAyNTA7IH0KICAgIGlmICh0eXBlb2YgcXVhbnRpdHkgPT09ICd1bmRlZmluZWQnKSB7IHF1YW50aXR5ID0gMDsgfQoKICAgIHRoaXMucmV2aXZlKCk7CgogICAgdGhpcy52aXNpYmxlID0gdHJ1ZTsKICAgIHRoaXMub24gPSB0cnVlOwoKICAgIHRoaXMuX2V4cGxvZGUgPSBleHBsb2RlOwogICAgdGhpcy5saWZlc3BhbiA9IGxpZmVzcGFuOwogICAgdGhpcy5mcmVxdWVuY3kgPSBmcmVxdWVuY3k7CgogICAgaWYgKGV4cGxvZGUpCiAgICB7CiAgICAgICAgdGhpcy5fcXVhbnRpdHkgPSBxdWFudGl0eTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLl9xdWFudGl0eSArPSBxdWFudGl0eTsKICAgIH0KCiAgICB0aGlzLl9jb3VudGVyID0gMDsKICAgIHRoaXMuX3RpbWVyID0gdGhpcy5nYW1lLnRpbWUubm93ICsgZnJlcXVlbmN5OwoKfQoKLyoqCiogVGhpcyBmdW5jdGlvbiBjYW4gYmUgdXNlZCBib3RoIGludGVybmFsbHkgYW5kIGV4dGVybmFsbHkgdG8gZW1pdCB0aGUgbmV4dCBwYXJ0aWNsZS4KKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjZW1pdFBhcnRpY2xlCiovClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLmVtaXRQYXJ0aWNsZSA9IGZ1bmN0aW9uICgpIHsKCiAgICB2YXIgcGFydGljbGUgPSB0aGlzLmdldEZpcnN0RXhpc3RzKGZhbHNlKTsKCiAgICBpZiAocGFydGljbGUgPT0gbnVsbCkKICAgIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHRoaXMud2lkdGggPiAxIHx8IHRoaXMuaGVpZ2h0ID4gMSkKICAgIHsKICAgICAgICBwYXJ0aWNsZS5yZXNldCh0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMubGVmdCwgdGhpcy5yaWdodCksIHRoaXMuZ2FtZS5ybmQuaW50ZWdlckluUmFuZ2UodGhpcy50b3AsIHRoaXMuYm90dG9tKSk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgcGFydGljbGUucmVzZXQodGhpcy5lbWl0WCwgdGhpcy5lbWl0WSk7CiAgICB9CgogICAgcGFydGljbGUubGlmZXNwYW4gPSB0aGlzLmxpZmVzcGFuOwoKICAgIHBhcnRpY2xlLmJvZHkuYm91bmNlLnNldFRvKHRoaXMuYm91bmNlLngsIHRoaXMuYm91bmNlLnkpOwoKICAgIGlmICh0aGlzLm1pblBhcnRpY2xlU3BlZWQueCAhPSB0aGlzLm1heFBhcnRpY2xlU3BlZWQueCkKICAgIHsKICAgICAgICBwYXJ0aWNsZS5ib2R5LnZlbG9jaXR5LnggPSB0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMubWluUGFydGljbGVTcGVlZC54LCB0aGlzLm1heFBhcnRpY2xlU3BlZWQueCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgcGFydGljbGUuYm9keS52ZWxvY2l0eS54ID0gdGhpcy5taW5QYXJ0aWNsZVNwZWVkLng7CiAgICB9CgogICAgaWYgKHRoaXMubWluUGFydGljbGVTcGVlZC55ICE9IHRoaXMubWF4UGFydGljbGVTcGVlZC55KQogICAgewogICAgICAgIHBhcnRpY2xlLmJvZHkudmVsb2NpdHkueSA9IHRoaXMuZ2FtZS5ybmQuaW50ZWdlckluUmFuZ2UodGhpcy5taW5QYXJ0aWNsZVNwZWVkLnksIHRoaXMubWF4UGFydGljbGVTcGVlZC55KTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBwYXJ0aWNsZS5ib2R5LnZlbG9jaXR5LnkgPSB0aGlzLm1pblBhcnRpY2xlU3BlZWQueTsKICAgIH0KCiAgICBwYXJ0aWNsZS5ib2R5LmdyYXZpdHkueSA9IHRoaXMuZ3Jhdml0eTsKCiAgICBpZiAodGhpcy5taW5Sb3RhdGlvbiAhPSB0aGlzLm1heFJvdGF0aW9uKQogICAgewogICAgICAgIHBhcnRpY2xlLmJvZHkuYW5ndWxhclZlbG9jaXR5ID0gdGhpcy5nYW1lLnJuZC5pbnRlZ2VySW5SYW5nZSh0aGlzLm1pblJvdGF0aW9uLCB0aGlzLm1heFJvdGF0aW9uKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBwYXJ0aWNsZS5ib2R5LmFuZ3VsYXJWZWxvY2l0eSA9IHRoaXMubWluUm90YXRpb247CiAgICB9CgogICAgaWYgKHRoaXMubWluUGFydGljbGVTY2FsZSAhPT0gMSB8fCB0aGlzLm1heFBhcnRpY2xlU2NhbGUgIT09IDEpCiAgICB7CiAgICAgICAgdmFyIHNjYWxlID0gdGhpcy5nYW1lLnJuZC5yZWFsSW5SYW5nZSh0aGlzLm1pblBhcnRpY2xlU2NhbGUsIHRoaXMubWF4UGFydGljbGVTY2FsZSk7CiAgICAgICAgcGFydGljbGUuc2NhbGUuc2V0VG8oc2NhbGUsIHNjYWxlKTsKICAgIH0KCiAgICBwYXJ0aWNsZS5ib2R5LmZyaWN0aW9uID0gdGhpcy5wYXJ0aWNsZUZyaWN0aW9uOwogICAgcGFydGljbGUuYm9keS5hbmd1bGFyRHJhZyA9IHRoaXMuYW5ndWxhckRyYWc7Cgp9CgovKioKKiBBIG1vcmUgY29tcGFjdCB3YXkgb2Ygc2V0dGluZyB0aGUgd2lkdGggYW5kIGhlaWdodCBvZiB0aGUgZW1pdHRlci4KKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjc2V0U2l6ZQoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSBkZXNpcmVkIHdpZHRoIG9mIHRoZSBlbWl0dGVyIChwYXJ0aWNsZXMgYXJlIHNwYXduZWQgcmFuZG9tbHkgd2l0aGluIHRoZXNlIGRpbWVuc2lvbnMpLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgZGVzaXJlZCBoZWlnaHQgb2YgdGhlIGVtaXR0ZXIuCiovClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLnNldFNpemUgPSBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewoKICAgIHRoaXMud2lkdGggPSB3aWR0aDsKICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKfQoKLyoqCiogQSBtb3JlIGNvbXBhY3Qgd2F5IG9mIHNldHRpbmcgdGhlIFggdmVsb2NpdHkgcmFuZ2Ugb2YgdGhlIGVtaXR0ZXIuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3NldFhTcGVlZAoqIEBwYXJhbSB7bnVtYmVyfSBbbWluPTBdIC0gVGhlIG1pbmltdW0gdmFsdWUgZm9yIHRoaXMgcmFuZ2UuCiogQHBhcmFtIHtudW1iZXJ9IFttYXg9MF0gLSBUaGUgbWF4aW11bSB2YWx1ZSBmb3IgdGhpcyByYW5nZS4KKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUuc2V0WFNwZWVkID0gZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgogICAgbWluID0gbWluIHx8IDA7CiAgICBtYXggPSBtYXggfHwgMDsKCiAgICB0aGlzLm1pblBhcnRpY2xlU3BlZWQueCA9IG1pbjsKICAgIHRoaXMubWF4UGFydGljbGVTcGVlZC54ID0gbWF4OwoKfQoKLyoqCiogQSBtb3JlIGNvbXBhY3Qgd2F5IG9mIHNldHRpbmcgdGhlIFkgdmVsb2NpdHkgcmFuZ2Ugb2YgdGhlIGVtaXR0ZXIuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3NldFlTcGVlZAoqIEBwYXJhbSB7bnVtYmVyfSBbbWluPTBdIC0gVGhlIG1pbmltdW0gdmFsdWUgZm9yIHRoaXMgcmFuZ2UuCiogQHBhcmFtIHtudW1iZXJ9IFttYXg9MF0gLSBUaGUgbWF4aW11bSB2YWx1ZSBmb3IgdGhpcyByYW5nZS4KKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUuc2V0WVNwZWVkID0gZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgogICAgbWluID0gbWluIHx8IDA7CiAgICBtYXggPSBtYXggfHwgMDsKCiAgICB0aGlzLm1pblBhcnRpY2xlU3BlZWQueSA9IG1pbjsKICAgIHRoaXMubWF4UGFydGljbGVTcGVlZC55ID0gbWF4OwoKfQoKLyoqCiogQSBtb3JlIGNvbXBhY3Qgd2F5IG9mIHNldHRpbmcgdGhlIGFuZ3VsYXIgdmVsb2NpdHkgY29uc3RyYWludHMgb2YgdGhlIGVtaXR0ZXIuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3NldFJvdGF0aW9uCiogQHBhcmFtIHtudW1iZXJ9IFttaW49MF0gLSBUaGUgbWluaW11bSB2YWx1ZSBmb3IgdGhpcyByYW5nZS4KKiBAcGFyYW0ge251bWJlcn0gW21heD0wXSAtIFRoZSBtYXhpbXVtIHZhbHVlIGZvciB0aGlzIHJhbmdlLgoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5zZXRSb3RhdGlvbiA9IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKICAgIG1pbiA9IG1pbiB8fCAwOwogICAgbWF4ID0gbWF4IHx8IDA7CgogICAgdGhpcy5taW5Sb3RhdGlvbiA9IG1pbjsKICAgIHRoaXMubWF4Um90YXRpb24gPSBtYXg7Cgp9CgovKioKKiBDaGFuZ2UgdGhlIGVtaXR0ZXJzIGNlbnRlciB0byBtYXRjaCB0aGUgY2VudGVyIG9mIGFueSBvYmplY3Qgd2l0aCBhIGBjZW50ZXJgIHByb3BlcnR5LCBzdWNoIGFzIGEgU3ByaXRlLgoqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNhdAoqIEBwYXJhbSB7b2JqZWN0fFBoYXNlci5TcHJpdGV9IG9iamVjdCAtIFRoZSBvYmplY3QgdGhhdCB5b3Ugd2lzaCB0byBtYXRjaCB0aGUgY2VudGVyIHdpdGguCiovClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLmF0ID0gZnVuY3Rpb24gKG9iamVjdCkgewoKICAgIGlmIChvYmplY3QuY2VudGVyKQogICAgewogICAgICAgIHRoaXMuZW1pdFggPSBvYmplY3QuY2VudGVyLng7CiAgICAgICAgdGhpcy5lbWl0WSA9IG9iamVjdC5jZW50ZXIueTsKICAgIH0KCn0KCi8qKgoqIFRoZSBlbWl0dGVycyBhbHBoYSB2YWx1ZS4KKiBAbmFtZSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI2FscGhhCiogQHByb3BlcnR5IHtudW1iZXJ9IGFscGhhIC0gR2V0cyBvciBzZXRzIHRoZSBhbHBoYSB2YWx1ZSBvZiB0aGUgRW1pdHRlci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLCAiYWxwaGEiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jb250YWluZXIuYWxwaGE7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLmFscGhhID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBlbWl0dGVyIHZpc2libGUgc3RhdGUuCiogQG5hbWUgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciN2aXNpYmxlCiogQHByb3BlcnR5IHtib29sZWFufSB2aXNpYmxlIC0gR2V0cyBvciBzZXRzIHRoZSBFbWl0dGVyIHZpc2libGUgc3RhdGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSwgInZpc2libGUiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jb250YWluZXIudmlzaWJsZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLl9jb250YWluZXIudmlzaWJsZSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3gKKiBAcHJvcGVydHkge251bWJlcn0geCAtIEdldHMgb3Igc2V0cyB0aGUgeCBwb3NpdGlvbiBvZiB0aGUgRW1pdHRlci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLCAieCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbWl0WDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLmVtaXRYID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjeQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gR2V0cyBvciBzZXRzIHRoZSB5IHBvc2l0aW9uIG9mIHRoZSBFbWl0dGVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUsICJ5IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmVtaXRZOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuZW1pdFkgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNsZWZ0CiogQHByb3BlcnR5IHtudW1iZXJ9IGxlZnQgLSBHZXRzIHRoZSBsZWZ0IHBvc2l0aW9uIG9mIHRoZSBFbWl0dGVyLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUsICJsZWZ0IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gTWF0aC5mbG9vcih0aGlzLnggLSAodGhpcy53aWR0aCAvIDIpKTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNyaWdodAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSByaWdodCAtIEdldHMgdGhlIHJpZ2h0IHBvc2l0aW9uIG9mIHRoZSBFbWl0dGVyLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUsICJyaWdodCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodGhpcy54ICsgKHRoaXMud2lkdGggLyAyKSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjdG9wCiogQHByb3BlcnR5IHtudW1iZXJ9IHRvcCAtIEdldHMgdGhlIHRvcCBwb3NpdGlvbiBvZiB0aGUgRW1pdHRlci4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLCAidG9wIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gTWF0aC5mbG9vcih0aGlzLnkgLSAodGhpcy5oZWlnaHQgLyAyKSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjYm90dG9tCiogQHByb3BlcnR5IHtudW1iZXJ9IGJvdHRvbSAtIEdldHMgdGhlIGJvdHRvbSBwb3NpdGlvbiBvZiB0aGUgRW1pdHRlci4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLCAiYm90dG9tIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gTWF0aC5mbG9vcih0aGlzLnkgKyAodGhpcy5oZWlnaHQgLyAyKSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIENyZWF0ZSBhIG5ldyBgVGlsZWAgb2JqZWN0LgoqCiogQGNsYXNzIFBoYXNlci5UaWxlCiogQGNsYXNzZGVzYyBBIFRpbGUgaXMgYSByZXByZXNlbnRhdGlvbiBvZiBhIHNpbmdsZSB0aWxlIHdpdGhpbiB0aGUgVGlsZW1hcC4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge29iamVjdH0gbGF5ZXIgLSBUaGUgbGF5ZXIgaW4gdGhlIFRpbGVtYXAgZGF0YSB0aGF0IHRoaXMgdGlsZSBiZWxvbmdzIHRvLgoqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGlzIHRpbGUgdHlwZSBpbiB0aGUgY29yZSBtYXAgZGF0YS4KKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhpcyB0aWxlLgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGlzIHRpbGUuCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gV2lkdGggb2YgdGhlIHRpbGUuCiogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIEhlaWdodCBvZiB0aGUgdGlsZS4KKi8KUGhhc2VyLlRpbGUgPSBmdW5jdGlvbiAobGF5ZXIsIGluZGV4LCB4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBsYXllciAtIFRoZSBsYXllciBpbiB0aGUgVGlsZW1hcCBkYXRhIHRoYXQgdGhpcyB0aWxlIGJlbG9uZ3MgdG8uCiAgICAqLwogICAgdGhpcy5sYXllciA9IGxheWVyOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhpcyB0aWxlIHdpdGhpbiB0aGUgbWFwIGRhdGEgY29ycmVzcG9uZGluZyB0byB0aGUgdGlsZXNldC4KICAgICovCiAgICB0aGlzLmluZGV4ID0gaW5kZXg7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geCAtIFRoZSB4IG1hcCBjb29yZGluYXRlIG9mIHRoaXMgdGlsZS4KICAgICovCiAgICB0aGlzLnggPSB4OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBUaGUgeSBtYXAgY29vcmRpbmF0ZSBvZiB0aGlzIHRpbGUuCiAgICAqLwogICAgdGhpcy55ID0geTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSB0aWxlIGluIHBpeGVscy4KICAgICovCiAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgdGlsZSBpbiBwaXhlbHMuCiAgICAqLwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBhbHBoYSB2YWx1ZSBhdCB3aGljaCB0aGlzIHRpbGUgaXMgZHJhd24gdG8gdGhlIGNhbnZhcy4KICAgICovCiAgICB0aGlzLmFscGhhID0gMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IHByb3BlcnRpZXMgLSBUaWxlIHNwZWNpZmljIHByb3BlcnRpZXMuCiAgICAqLwogICAgdGhpcy5wcm9wZXJ0aWVzID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gc2Nhbm5lZCAtIEhhcyB0aGlzIHRpbGUgYmVlbiB3YWxrZWQgLyB0dXJuZWQgaW50byBhIHBvbHk/CiAgICAqLwogICAgdGhpcy5zY2FubmVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZmFjZVRvcCAtIElzIHRoZSB0b3Agb2YgdGhpcyB0aWxlIGFuIGludGVyZXN0aW5nIGVkZ2U/CiAgICAqLwogICAgdGhpcy5mYWNlVG9wID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZmFjZUJvdHRvbSAtIElzIHRoZSBib3R0b20gb2YgdGhpcyB0aWxlIGFuIGludGVyZXN0aW5nIGVkZ2U/CiAgICAqLwogICAgdGhpcy5mYWNlQm90dG9tID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZmFjZUxlZnQgLSBJcyB0aGUgbGVmdCBvZiB0aGlzIHRpbGUgYW4gaW50ZXJlc3RpbmcgZWRnZT8KICAgICovCiAgICB0aGlzLmZhY2VMZWZ0ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZmFjZVJpZ2h0IC0gSXMgdGhlIHJpZ2h0IG9mIHRoaXMgdGlsZSBhbiBpbnRlcmVzdGluZyBlZGdlPwogICAgKi8KICAgIHRoaXMuZmFjZVJpZ2h0ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29sbGlkZXMgLSBEb2VzIHRoaXMgdGlsZSBjb2xsaWRlIGF0IGFsbD8KICAgICovCiAgICB0aGlzLmNvbGxpZGVzID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29sbGlkZU5vbmUgLSBJbmRpY2F0aW5nIHRoaXMgVGlsZSBkb2Vzbid0IGNvbGxpZGUgYXQgYWxsLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29sbGlkZU5vbmUgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbGxpZGVMZWZ0IC0gSW5kaWNhdGluZyBjb2xsaWRlIHdpdGggYW55IG9iamVjdCBvbiB0aGUgbGVmdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNvbGxpZGVMZWZ0ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29sbGlkZVJpZ2h0IC0gSW5kaWNhdGluZyBjb2xsaWRlIHdpdGggYW55IG9iamVjdCBvbiB0aGUgcmlnaHQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb2xsaWRlUmlnaHQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjb2xsaWRlVXAgLSBJbmRpY2F0aW5nIGNvbGxpZGUgd2l0aCBhbnkgb2JqZWN0IG9uIHRoZSB0b3AuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb2xsaWRlVXAgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjb2xsaWRlRG93biAtIEluZGljYXRpbmcgY29sbGlkZSB3aXRoIGFueSBvYmplY3Qgb24gdGhlIGJvdHRvbS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNvbGxpZGVEb3duID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGlsZSBjb2xsaXNpb24gY2FsbGJhY2suCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY29sbGlzaW9uIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gdGhpczsKCn07CgpQaGFzZXIuVGlsZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFNldCBhIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCB3aGVuIHRoaXMgdGlsZSBpcyBoaXQgYnkgYW4gb2JqZWN0LgogICAgKiBUaGUgY2FsbGJhY2sgbXVzdCB0cnVlIHRydWUgZm9yIGNvbGxpc2lvbiBwcm9jZXNzaW5nIHRvIHRha2UgcGxhY2UuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlI3NldENvbGxpc2lvbkNhbGxiYWNrCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gQ2FsbGJhY2sgZnVuY3Rpb24uCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0IC0gQ2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGlzIGNvbnRleHQuCiAgICAqLwogICAgc2V0Q29sbGlzaW9uQ2FsbGJhY2s6IGZ1bmN0aW9uIChjYWxsYmFjaywgY29udGV4dCkgewoKICAgICAgICB0aGlzLmNvbGxpc2lvbkNhbGxiYWNrQ29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgdGhpcy5jb2xsaXNpb25DYWxsYmFjayA9IGNhbGxiYWNrOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENsZWFuIHVwIG1lbW9yeS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZSNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmNvbGxpc2lvbkNhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLmNvbGxpc2lvbkNhbGxiYWNrQ29udGV4dCA9IG51bGw7CiAgICAgICAgdGhpcy5wcm9wZXJ0aWVzID0gbnVsbDsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIFNldCBjb2xsaXNpb24gc2V0dGluZ3Mgb24gdGhpcyB0aWxlLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlI3NldENvbGxpc2lvbgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGxlZnQgLSBJbmRpY2F0aW5nIGNvbGxpZGUgd2l0aCBhbnkgb2JqZWN0IG9uIHRoZSBsZWZ0LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHJpZ2h0IC0gSW5kaWNhdGluZyBjb2xsaWRlIHdpdGggYW55IG9iamVjdCBvbiB0aGUgcmlnaHQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gdXAgLSBJbmRpY2F0aW5nIGNvbGxpZGUgd2l0aCBhbnkgb2JqZWN0IG9uIHRoZSB0b3AuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZG93biAtIEluZGljYXRpbmcgY29sbGlkZSB3aXRoIGFueSBvYmplY3Qgb24gdGhlIGJvdHRvbS4KICAgICovCiAgICBzZXRDb2xsaXNpb246IGZ1bmN0aW9uIChsZWZ0LCByaWdodCwgdXAsIGRvd24pIHsKCiAgICAgICAgdGhpcy5jb2xsaWRlTGVmdCA9IGxlZnQ7CiAgICAgICAgdGhpcy5jb2xsaWRlUmlnaHQgPSByaWdodDsKICAgICAgICB0aGlzLmNvbGxpZGVVcCA9IHVwOwogICAgICAgIHRoaXMuY29sbGlkZURvd24gPSBkb3duOwoKICAgICAgICBpZiAobGVmdCB8fCByaWdodCB8fCB1cCB8fCBkb3duKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb2xsaWRlTm9uZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbGxpZGVOb25lID0gdHJ1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUmVzZXQgY29sbGlzaW9uIHN0YXR1cyBmbGFncy4KICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZSNyZXNldENvbGxpc2lvbgogICAgKi8KICAgIHJlc2V0Q29sbGlzaW9uOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuY29sbGlkZU5vbmUgPSB0cnVlOwogICAgICAgIHRoaXMuY29sbGlkZUxlZnQgPSBmYWxzZTsKICAgICAgICB0aGlzLmNvbGxpZGVSaWdodCA9IGZhbHNlOwogICAgICAgIHRoaXMuY29sbGlkZVVwID0gZmFsc2U7CiAgICAgICAgdGhpcy5jb2xsaWRlRG93biA9IGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENvcGllcyB0aGUgdGlsZSBkYXRhIGFuZCBwcm9wZXJ0aWVzIGZyb20gdGhlIGdpdmVuIHRpbGUgdG8gdGhpcyB0aWxlLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlI2NvcHkKICAgICogQHBhcmFtIHtQaGFzZXIuVGlsZX0gdGlsZSAtIFRoZSB0aWxlIHRvIGNvcHkgZnJvbS4KICAgICovCiAgICBjb3B5OiBmdW5jdGlvbiAodGlsZSkgewoKICAgICAgICB0aGlzLmluZGV4ID0gdGlsZS5pbmRleDsKICAgICAgICB0aGlzLmFscGhhID0gdGlsZS5hbHBoYTsKICAgICAgICB0aGlzLnByb3BlcnRpZXMgPSB0aWxlLnByb3BlcnRpZXM7CiAgICAgICAgdGhpcy5jb2xsaWRlcyA9IHRpbGUuY29sbGlkZXM7CiAgICAgICAgdGhpcy5jb2xsaWRlTm9uZSA9IHRpbGUuY29sbGlkZU5vbmU7CiAgICAgICAgdGhpcy5jb2xsaWRlVXAgPSB0aWxlLmNvbGxpZGVVcDsKICAgICAgICB0aGlzLmNvbGxpZGVEb3duID0gdGlsZS5jb2xsaWRlRG93bjsKICAgICAgICB0aGlzLmNvbGxpZGVMZWZ0ID0gdGlsZS5jb2xsaWRlTGVmdDsKICAgICAgICB0aGlzLmNvbGxpZGVSaWdodCA9IHRpbGUuY29sbGlkZVJpZ2h0OwogICAgICAgIHRoaXMuY29sbGlzaW9uQ2FsbGJhY2sgPSB0aWxlLmNvbGxpc2lvbkNhbGxiYWNrOwogICAgICAgIHRoaXMuY29sbGlzaW9uQ2FsbGJhY2tDb250ZXh0ID0gdGlsZS5jb2xsaXNpb25DYWxsYmFja0NvbnRleHQ7CgogICAgfQoKfTsKClBoYXNlci5UaWxlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5UaWxlOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbGUjY2FuQ29sbGlkZQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY2FuQ29sbGlkZSAtIFRydWUgaWYgdGhpcyB0aWxlIGNhbiBjb2xsaWRlIG9yIGhhcyBhIGNvbGxpc2lvbiBjYWxsYmFjay4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaWxlLnByb3RvdHlwZSwgImNhbkNvbGxpZGUiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAodGhpcy5jb2xsaWRlcyB8fCB0aGlzLmNvbGxpc2lvbkNhbGxiYWNrIHx8IHRoaXMubGF5ZXIuY2FsbGJhY2tzW3RoaXMuaW5kZXhdKTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbGUjbGVmdAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsZWZ0IC0gVGhlIHggdmFsdWUuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZS5wcm90b3R5cGUsICJsZWZ0IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy54OwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuVGlsZSNyaWdodAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSByaWdodCAtIFRoZSBzdW0gb2YgdGhlIHggYW5kIHdpZHRoIHByb3BlcnRpZXMuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZS5wcm90b3R5cGUsICJyaWdodCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueCArIHRoaXMud2lkdGg7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5UaWxlI3RvcAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3AgLSBUaGUgeSB2YWx1ZS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaWxlLnByb3RvdHlwZSwgInRvcCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbGUjYm90dG9tCiogQHByb3BlcnR5IHtudW1iZXJ9IGJvdHRvbSAtIFRoZSBzdW0gb2YgdGhlIHkgYW5kIGhlaWdodCBwcm9wZXJ0aWVzLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGUucHJvdG90eXBlLCAiYm90dG9tIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy55ICsgdGhpcy5oZWlnaHQ7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgVGlsZSBNYXAgb2JqZWN0LiBBIFRpbGUgbWFwIGNvbnNpc3RzIG9mIGEgc2V0IG9mIHRpbGUgZGF0YSBhbmQgdGlsZSBzZXRzLiBJdCBpcyByZW5kZXJlZCB0byB0aGUgZGlzcGxheSB1c2luZyBhIFRpbGVtYXBMYXllci4KKiBBIG1hcCBtYXkgaGF2ZSBtdWx0aXBsZSBsYXllcnMuIFlvdSBjYW4gcGVyZm9ybSBvcGVyYXRpb25zIG9uIHRoZSBtYXAgZGF0YSBzdWNoIGFzIGNvcHlpbmcsIHBhc3RpbmcsIGZpbGxpbmcgYW5kIHNodWZmbGluZyB0aGUgdGlsZXMgYXJvdW5kLgoqCiogQGNsYXNzIFBoYXNlci5UaWxlbWFwCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEdhbWUgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7c3RyaW5nfSBba2V5XSAtIFRoZSBrZXkgb2YgdGhlIHRpbGVtYXAgZGF0YSBhcyBzdG9yZWQgaW4gdGhlIENhY2hlLgoqLwpQaGFzZXIuVGlsZW1hcCA9IGZ1bmN0aW9uIChnYW1lLCBrZXkpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBrZXkgLSBUaGUga2V5IG9mIHRoaXMgbWFwIGRhdGEgaW4gdGhlIFBoYXNlci5DYWNoZS4KICAgICovCiAgICB0aGlzLmtleSA9IGtleTsKCiAgICB2YXIgZGF0YSA9IFBoYXNlci5UaWxlbWFwUGFyc2VyLnBhcnNlKHRoaXMuZ2FtZSwga2V5KTsKCiAgICBpZiAoZGF0YSA9PT0gbnVsbCkKICAgIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgbWFwIChpbiB0aWxlcykuCiAgICAqLwogICAgdGhpcy53aWR0aCA9IGRhdGEud2lkdGg7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBtYXAgKGluIHRpbGVzKS4KICAgICovCiAgICB0aGlzLmhlaWdodCA9IGRhdGEuaGVpZ2h0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdGlsZVdpZHRoIC0gVGhlIGJhc2Ugd2lkdGggb2YgdGhlIHRpbGVzIGluIHRoZSBtYXAgKGluIHBpeGVscykuCiAgICAqLwogICAgdGhpcy50aWxlV2lkdGggPSBkYXRhLnRpbGVXaWR0aDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbGVIZWlnaHQgLSBUaGUgYmFzZSBoZWlnaHQgb2YgdGhlIHRpbGVzIGluIHRoZSBtYXAgKGluIHBpeGVscykuCiAgICAqLwogICAgdGhpcy50aWxlSGVpZ2h0ID0gZGF0YS50aWxlSGVpZ2h0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gb3JpZW50YXRpb24gLSBUaGUgb3JpZW50YXRpb24gb2YgdGhlIG1hcCBkYXRhIChhcyBzcGVjaWZpZWQgaW4gVGlsZWQpLCB1c3VhbGx5ICdvcnRob2dvbmFsJy4KICAgICovCiAgICB0aGlzLm9yaWVudGF0aW9uID0gZGF0YS5vcmllbnRhdGlvbjsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHZlcnNpb24gLSBUaGUgdmVyc2lvbiBvZiB0aGUgbWFwIGRhdGEgKGFzIHNwZWNpZmllZCBpbiBUaWxlZCwgdXN1YWxseSAxKS4KICAgICovCiAgICB0aGlzLnZlcnNpb24gPSBkYXRhLnZlcnNpb247CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBwcm9wZXJ0aWVzIC0gTWFwIHNwZWNpZmljIHByb3BlcnRpZXMgYXMgc3BlY2lmaWVkIGluIFRpbGVkLgogICAgKi8KICAgIHRoaXMucHJvcGVydGllcyA9IGRhdGEucHJvcGVydGllczsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoSW5QaXhlbHMgLSBUaGUgd2lkdGggb2YgdGhlIG1hcCBpbiBwaXhlbHMgYmFzZWQgb24gd2lkdGggKiB0aWxlV2lkdGguCiAgICAqLwogICAgdGhpcy53aWR0aEluUGl4ZWxzID0gZGF0YS53aWR0aEluUGl4ZWxzOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0SW5QaXhlbHMgLSBUaGUgaGVpZ2h0IG9mIHRoZSBtYXAgaW4gcGl4ZWxzIGJhc2VkIG9uIGhlaWdodCAqIHRpbGVIZWlnaHQuCiAgICAqLwogICAgdGhpcy5oZWlnaHRJblBpeGVscyA9IGRhdGEuaGVpZ2h0SW5QaXhlbHM7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGxheWVycyAtIEFuIGFycmF5IG9mIFRpbGVtYXAgbGF5ZXIgZGF0YS4KICAgICovCiAgICB0aGlzLmxheWVycyA9IGRhdGEubGF5ZXJzOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSB0aWxlc2V0cyAtIEFuIGFycmF5IG9mIFRpbGVzZXRzLgogICAgKi8KICAgIHRoaXMudGlsZXNldHMgPSBkYXRhLnRpbGVzZXRzOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSB0aWxlcyAtIFRoZSBzdXBlciBhcnJheSBvZiBUaWxlcy4KICAgICovCiAgICB0aGlzLnRpbGVzID0gZGF0YS50aWxlczsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gb2JqZWN0cyAtIEFuIGFycmF5IG9mIFRpbGVkIE9iamVjdCBMYXllcnMuCiAgICAqLwogICAgdGhpcy5vYmplY3RzID0gZGF0YS5vYmplY3RzOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBpbWFnZXMgLSBBbiBhcnJheSBvZiBUaWxlZCBJbWFnZSBMYXllcnMuCiAgICAqLwogICAgdGhpcy5pbWFnZXMgPSBkYXRhLmltYWdlczsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGN1cnJlbnRMYXllciAtIFRoZSBjdXJyZW50IGxheWVyLgogICAgKi8KICAgIHRoaXMuY3VycmVudExheWVyID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gZGVidWdNYXAgLSBNYXAgZGF0YSB1c2VkIGZvciBkZWJ1ZyB2YWx1ZXMgb25seS4KICAgICovCiAgICB0aGlzLmRlYnVnTWFwID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IF9yZXN1bHRzIC0gSW50ZXJuYWwgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3Jlc3VsdHMgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF90ZW1wQSAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90ZW1wQSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdGVtcEIgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdGVtcEIgPSAwOwoKfTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5UaWxlbWFwLkNTViA9IDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuVGlsZW1hcC5USUxFRF9KU09OID0gMTsKClBoYXNlci5UaWxlbWFwLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQ3JlYXRlcyBhbiBlbXB0eSBtYXAgb2YgdGhlIGdpdmVuIGRpbWVuc2lvbnMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjY3JlYXRlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIG1hcCAobW9zdGx5IHVzZWQgZm9yIGRlYnVnZ2luZykKICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBtYXAgaW4gdGlsZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBtYXAgaW4gdGlsZXMuCiAgICAqLwogICAgY3JlYXRlOiBmdW5jdGlvbiAobmFtZSwgd2lkdGgsIGhlaWdodCkgewoKICAgICAgICB2YXIgZGF0YSA9IFtdOwoKICAgICAgICBmb3IgKHZhciB5ID0gMDsgeSA8IGhlaWdodDsgeSsrKQogICAgICAgIHsKICAgICAgICAgICAgZGF0YVt5XSA9IFtdOwoKICAgICAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCB3aWR0aDsgeCsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBkYXRhW3ldW3hdID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5sYXllcnMucHVzaCh7CgogICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICB3aWR0aDogd2lkdGgsCiAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0LAogICAgICAgICAgICBhbHBoYTogMSwKICAgICAgICAgICAgdmlzaWJsZTogdHJ1ZSwKICAgICAgICAgICAgdGlsZU1hcmdpbjogMCwKICAgICAgICAgICAgdGlsZVNwYWNpbmc6IDAsCiAgICAgICAgICAgIGZvcm1hdDogUGhhc2VyLlRpbGVtYXAuQ1NWLAogICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICBpbmRleGVzOiBbXSwKICAgICAgICAgICAgZGlydHk6IHRydWUKCiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuY3VycmVudExheWVyID0gdGhpcy5sYXllcnMubGVuZ3RoIC0gMTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIGFuIGltYWdlIHRvIHRoZSBtYXAgdG8gYmUgdXNlZCBhcyBhIHRpbGVzZXQuIEEgc2luZ2xlIG1hcCBtYXkgdXNlIG11bHRpcGxlIHRpbGVzZXRzLgogICAgKiBOb3RlIHRoYXQgdGhlIHRpbGVzZXQgbmFtZSBjYW4gYmUgZm91bmQgaW4gdGhlIEpTT04gZmlsZSBleHBvcnRlZCBmcm9tIFRpbGVkLCBvciBpbiB0aGUgVGlsZWQgZWRpdG9yLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI2FkZFRpbGVzZXRJbWFnZQogICAgKiBAcGFyYW0ge3N0cmluZ30gdGlsZXNldCAtIFRoZSBuYW1lIG9mIHRoZSB0aWxlc2V0IGFzIHNwZWNpZmllZCBpbiB0aGUgbWFwIGRhdGEuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBba2V5XSAtIFRoZSBrZXkgb2YgdGhlIFBoYXNlci5DYWNoZSBpbWFnZSB1c2VkIGZvciB0aGlzIHRpbGVzZXQuIElmIG5vdCBzcGVjaWZpZWQgaXQgd2lsbCBsb29rIGZvciBhbiBpbWFnZSB3aXRoIGEga2V5IG1hdGNoaW5nIHRoZSB0aWxlc2V0IHBhcmFtZXRlci4KICAgICovCiAgICBhZGRUaWxlc2V0SW1hZ2U6IGZ1bmN0aW9uICh0aWxlc2V0LCBrZXkpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0aWxlc2V0ID09PSAnc3RyaW5nJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAga2V5ID0gdGlsZXNldDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiB0aWxlc2V0ID09PSAnc3RyaW5nJykKICAgICAgICB7CiAgICAgICAgICAgIHRpbGVzZXQgPSB0aGlzLmdldFRpbGVzZXRJbmRleCh0aWxlc2V0KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnRpbGVzZXRzW3RpbGVzZXRdKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50aWxlc2V0c1t0aWxlc2V0XS5pbWFnZSA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRJbWFnZShrZXkpOwoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKgogICAgY3JlYXRlRnJvbVRpbGVzOiBmdW5jdGlvbiAobGF5ZXIsIHRpbGVJbmRleCwga2V5LCBmcmFtZSwgZ3JvdXApIHsKCiAgICAgICAgaWYgKHR5cGVvZiBncm91cCA9PT0gJ3VuZGVmaW5lZCcpIHsgZ3JvdXAgPSB0aGlzLmdhbWUud29ybGQ7IH0KCiAgICB9LAogICAgKi8KCiAgICAvKioKICAgICogQ3JlYXRlcyBhIFNwcml0ZSBmb3IgZXZlcnkgb2JqZWN0IG1hdGNoaW5nIHRoZSBnaXZlbiBnaWQgaW4gdGhlIG1hcCBkYXRhLiBZb3UgY2FuIG9wdGlvbmFsbHkgc3BlY2lmeSB0aGUgZ3JvdXAgdGhhdCB0aGUgU3ByaXRlIHdpbGwgYmUgY3JlYXRlZCBpbi4gSWYgbm9uZSBpcwogICAgKiBnaXZlbiBpdCB3aWxsIGJlIGNyZWF0ZWQgaW4gdGhlIFdvcmxkLiBBbGwgcHJvcGVydGllcyBmcm9tIHRoZSBtYXAgZGF0YSBvYmplY3Rncm91cCBhcmUgY29waWVkIGFjcm9zcyB0byB0aGUgU3ByaXRlLCBzbyB5b3UgY2FuIHVzZSB0aGlzIGFzIGFuIGVhc3kgd2F5IHRvCiAgICAqIGNvbmZpZ3VyZSBTcHJpdGUgcHJvcGVydGllcyBmcm9tIHdpdGhpbiB0aGUgbWFwIGVkaXRvci4gRm9yIGV4YW1wbGUgZ2l2aW5nIGFuIG9iamVjdCBhIHByb3BlcnR5IGlmIGFscGhhOiAwLjUgaW4gdGhlIG1hcCBlZGl0b3Igd2lsbCBkdXBsaWNhdGUgdGhhdCB3aGVuIHRoZQogICAgKiBTcHJpdGUgaXMgY3JlYXRlZC4gWW91IGNvdWxkIGFsc28gZ2l2ZSBpdCBhIHZhbHVlIGxpa2U6IGJvZHkudmVsb2NpdHkueDogMTAwIHRvIHNldCBpdCBtb3ZpbmcgYXV0b21hdGljYWxseS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNjcmVhdGVGcm9tT2JqZWN0cwogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBPYmplY3QgR3JvdXAgdG8gY3JlYXRlIFNwcml0ZXMgZnJvbS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGdpZCAtIFRoZSBsYXllciBhcnJheSBpbmRleCB2YWx1ZSwgb3IgaWYgYSBzdHJpbmcgaXMgZ2l2ZW4gdGhlIGxheWVyIG5hbWUsIHdpdGhpbiB0aGUgbWFwIGRhdGEgdGhhdCB0aGlzIFRpbGVtYXBMYXllciByZXByZXNlbnRzLgogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIEdhbWUuY2FjaGUga2V5IG9mIHRoZSBpbWFnZSB0aGF0IHRoaXMgU3ByaXRlIHdpbGwgdXNlLgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd9IFtmcmFtZV0gLSBJZiB0aGUgU3ByaXRlIGltYWdlIGNvbnRhaW5zIG11bHRpcGxlIGZyYW1lcyB5b3UgY2FuIHNwZWNpZnkgd2hpY2ggb25lIHRvIHVzZSBoZXJlLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtleGlzdHM9dHJ1ZV0gLSBUaGUgZGVmYXVsdCBleGlzdHMgc3RhdGUgb2YgdGhlIFNwcml0ZS4KICAgICogQHBhcmFtIHtib29sZWFufSBbYXV0b0N1bGw9dHJ1ZV0gLSBUaGUgZGVmYXVsdCBhdXRvQ3VsbCBzdGF0ZSBvZiB0aGUgU3ByaXRlLiBTcHJpdGVzIHRoYXQgYXJlIGF1dG9DdWxsZWQgYXJlIGN1bGxlZCBmcm9tIHRoZSBjYW1lcmEgaWYgb3V0IG9mIGl0cyByYW5nZS4KICAgICogQHBhcmFtIHtQaGFzZXIuR3JvdXB9IFtncm91cF0gLSBPcHRpb25hbCBHcm91cCB0byBhZGQgdGhlIFNwcml0ZSB0by4gSWYgbm90IHNwZWNpZmllZCBpdCB3aWxsIGJlIGFkZGVkIHRvIHRoZSBXb3JsZCBncm91cC4KICAgICovCiAgICBjcmVhdGVGcm9tT2JqZWN0czogZnVuY3Rpb24gKG5hbWUsIGdpZCwga2V5LCBmcmFtZSwgZXhpc3RzLCBhdXRvQ3VsbCwgZ3JvdXApIHsKCiAgICAgICAgaWYgKHR5cGVvZiBleGlzdHMgPT09ICd1bmRlZmluZWQnKSB7IGV4aXN0cyA9IHRydWU7IH0KICAgICAgICBpZiAodHlwZW9mIGF1dG9DdWxsID09PSAndW5kZWZpbmVkJykgeyBhdXRvQ3VsbCA9IHRydWU7IH0KICAgICAgICBpZiAodHlwZW9mIGdyb3VwID09PSAndW5kZWZpbmVkJykgeyBncm91cCA9IHRoaXMuZ2FtZS53b3JsZDsgfQoKICAgICAgICBpZiAoIXRoaXMub2JqZWN0c1tuYW1lXSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignVGlsZW1hcC5jcmVhdGVGcm9tT2JqZWN0czogSW52YWxpZCBvYmplY3Rncm91cCBuYW1lIGdpdmVuOiAnICsgbmFtZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBzcHJpdGU7CgogICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLm9iamVjdHNbbmFtZV0ubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5vYmplY3RzW25hbWVdW2ldLmdpZCA9PT0gZ2lkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzcHJpdGUgPSBncm91cC5jcmVhdGUodGhpcy5vYmplY3RzW25hbWVdW2ldLngsIHRoaXMub2JqZWN0c1tuYW1lXVtpXS55LCBrZXksIGZyYW1lLCBleGlzdHMpOwoKICAgICAgICAgICAgICAgIHNwcml0ZS5hbmNob3Iuc2V0VG8oMCwgMSk7CiAgICAgICAgICAgICAgICBzcHJpdGUubmFtZSA9IHRoaXMub2JqZWN0c1tuYW1lXVtpXS5uYW1lOwogICAgICAgICAgICAgICAgc3ByaXRlLnZpc2libGUgPSB0aGlzLm9iamVjdHNbbmFtZV1baV0udmlzaWJsZTsKICAgICAgICAgICAgICAgIHNwcml0ZS5hdXRvQ3VsbCA9IGF1dG9DdWxsOwoKICAgICAgICAgICAgICAgIGZvciAocHJvcGVydHkgaW4gdGhpcy5vYmplY3RzW25hbWVdW2ldLnByb3BlcnRpZXMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZ3JvdXAuc2V0KHNwcml0ZSwgcHJvcGVydHksIHRoaXMub2JqZWN0c1tuYW1lXVtpXS5wcm9wZXJ0aWVzW3Byb3BlcnR5XSwgZmFsc2UsIGZhbHNlLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IFRpbGVtYXBMYXllciBvYmplY3QuIEJ5IGRlZmF1bHQgVGlsZW1hcExheWVycyBhcmUgZml4ZWQgdG8gdGhlIGNhbWVyYS4KICAgICogVGhlIGBsYXllcmAgcGFyYW1ldGVyIGlzIGltcG9ydGFudC4gSWYgeW91J3ZlIGNyZWF0ZWQgeW91ciBtYXAgaW4gVGlsZWQgdGhlbiB5b3UgY2FuIGdldCB0aGlzIGJ5IGxvb2tpbmcgaW4gVGlsZWQgYW5kIGxvb2tpbmcgYXQgdGhlIExheWVyIG5hbWUuCiAgICAqIE9yIHlvdSBjYW4gb3BlbiB0aGUgSlNPTiBmaWxlIGl0IGV4cG9ydHMgYW5kIGxvb2sgYXQgdGhlIGxheWVyc1tdLm5hbWUgdmFsdWUuIEVpdGhlciB3YXkgaXQgbXVzdCBtYXRjaC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNjcmVhdGVMYXllcgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd9IGxheWVyIC0gVGhlIGxheWVyIGFycmF5IGluZGV4IHZhbHVlLCBvciBpZiBhIHN0cmluZyBpcyBnaXZlbiB0aGUgbGF5ZXIgbmFtZSwgd2l0aGluIHRoZSBtYXAgZGF0YSB0aGF0IHRoaXMgVGlsZW1hcExheWVyIHJlcHJlc2VudHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGhdIC0gVGhlIHJlbmRlcmVkIHdpZHRoIG9mIHRoZSBsYXllciwgc2hvdWxkIG5ldmVyIGJlIHdpZGVyIHRoYW4gR2FtZS53aWR0aC4gSWYgbm90IGdpdmVuIGl0IHdpbGwgYmUgc2V0IHRvIEdhbWUud2lkdGguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0XSAtIFRoZSByZW5kZXJlZCBoZWlnaHQgb2YgdGhlIGxheWVyLCBzaG91bGQgbmV2ZXIgYmUgd2lkZXIgdGhhbiBHYW1lLmhlaWdodC4gSWYgbm90IGdpdmVuIGl0IHdpbGwgYmUgc2V0IHRvIEdhbWUuaGVpZ2h0LgogICAgKiBAcGFyYW0ge1BoYXNlci5Hcm91cH0gW2dyb3VwXSAtIE9wdGlvbmFsIEdyb3VwIHRvIGFkZCB0aGUgb2JqZWN0IHRvLiBJZiBub3Qgc3BlY2lmaWVkIGl0IHdpbGwgYmUgYWRkZWQgdG8gdGhlIFdvcmxkIGdyb3VwLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGlsZW1hcExheWVyfSBUaGUgVGlsZW1hcExheWVyIG9iamVjdC4gVGhpcyBpcyBhbiBleHRlbnNpb24gb2YgUGhhc2VyLlNwcml0ZSBhbmQgY2FuIGJlIG1vdmVkIGFyb3VuZCB0aGUgZGlzcGxheSBsaXN0IGFjY29yZGluZ2x5LgogICAgKi8KICAgIGNyZWF0ZUxheWVyOiBmdW5jdGlvbiAobGF5ZXIsIHdpZHRoLCBoZWlnaHQsIGdyb3VwKSB7CgogICAgICAgIC8vICBBZGQgQnVmZmVyIHN1cHBvcnQgZm9yIHRoZSBsZWZ0IG9mIHRoZSBjYW52YXMKCiAgICAgICAgaWYgKHR5cGVvZiB3aWR0aCA9PT0gJ3VuZGVmaW5lZCcpIHsgd2lkdGggPSB0aGlzLmdhbWUud2lkdGg7IH0KICAgICAgICBpZiAodHlwZW9mIGhlaWdodCA9PT0gJ3VuZGVmaW5lZCcpIHsgaGVpZ2h0ID0gdGhpcy5nYW1lLmhlaWdodDsgfQogICAgICAgIGlmICh0eXBlb2YgZ3JvdXAgPT09ICd1bmRlZmluZWQnKSB7IGdyb3VwID0gdGhpcy5nYW1lLndvcmxkOyB9CgogICAgICAgIHZhciBpbmRleCA9IGxheWVyOwoKICAgICAgICBpZiAodHlwZW9mIGxheWVyID09PSAnc3RyaW5nJykKICAgICAgICB7CiAgICAgICAgICAgIGluZGV4ID0gdGhpcy5nZXRMYXllckluZGV4KGxheWVyKTsKICAgICAgICB9CgogICAgICAgIGlmIChpbmRleCA9PT0gbnVsbCB8fCBpbmRleCA+IHRoaXMubGF5ZXJzLmxlbmd0aCkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignVGlsZW1hcC5jcmVhdGVMYXllcjogSW52YWxpZCBsYXllciBJRCBnaXZlbjogJyArIGluZGV4KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGdyb3VwLmFkZChuZXcgUGhhc2VyLlRpbGVtYXBMYXllcih0aGlzLmdhbWUsIHRoaXMsIGluZGV4LCB3aWR0aCwgaGVpZ2h0KSk7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0cyB0aGUgbGF5ZXIgaW5kZXggYmFzZWQgb24gdGhlIGxheWVycyBuYW1lLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI2dldEluZGV4CiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHthcnJheX0gbG9jYXRpb24gLSBUaGUgbG9jYWwgYXJyYXkgdG8gc2VhcmNoLgogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBhcnJheSBlbGVtZW50IHRvIGdldC4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgaW5kZXggb2YgdGhlIGVsZW1lbnQgaW4gdGhlIGFycmF5LCBvciBudWxsIGlmIG5vdCBmb3VuZC4KICAgICovCiAgICBnZXRJbmRleDogZnVuY3Rpb24gKGxvY2F0aW9uLCBuYW1lKSB7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbG9jYXRpb24ubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAobG9jYXRpb25baV0ubmFtZSA9PT0gbmFtZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldHMgdGhlIGxheWVyIGluZGV4IGJhc2VkIG9uIGl0cyBuYW1lLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI2dldExheWVySW5kZXgKICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgbGF5ZXIgdG8gZ2V0LgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBpbmRleCBvZiB0aGUgbGF5ZXIgaW4gdGhpcyB0aWxlbWFwLCBvciBudWxsIGlmIG5vdCBmb3VuZC4KICAgICovCiAgICBnZXRMYXllckluZGV4OiBmdW5jdGlvbiAobmFtZSkgewoKICAgICAgICByZXR1cm4gdGhpcy5nZXRJbmRleCh0aGlzLmxheWVycywgbmFtZSk7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0cyB0aGUgdGlsZXNldCBpbmRleCBiYXNlZCBvbiBpdHMgbmFtZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNnZXRUaWxlc2V0SW5kZXgKICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgdGlsZXNldCB0byBnZXQuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGluZGV4IG9mIHRoZSB0aWxlc2V0IGluIHRoaXMgdGlsZW1hcCwgb3IgbnVsbCBpZiBub3QgZm91bmQuCiAgICAqLwogICAgZ2V0VGlsZXNldEluZGV4OiBmdW5jdGlvbiAobmFtZSkgewoKICAgICAgICByZXR1cm4gdGhpcy5nZXRJbmRleCh0aGlzLnRpbGVzZXRzLCBuYW1lKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXRzIHRoZSBpbWFnZSBpbmRleCBiYXNlZCBvbiBpdHMgbmFtZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNnZXRJbWFnZUluZGV4CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGltYWdlIHRvIGdldC4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgaW5kZXggb2YgdGhlIGltYWdlIGluIHRoaXMgdGlsZW1hcCwgb3IgbnVsbCBpZiBub3QgZm91bmQuCiAgICAqLwogICAgZ2V0SW1hZ2VJbmRleDogZnVuY3Rpb24gKG5hbWUpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SW5kZXgodGhpcy5pbWFnZXMsIG5hbWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldHMgdGhlIG9iamVjdCBpbmRleCBiYXNlZCBvbiBpdHMgbmFtZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNnZXRPYmplY3RJbmRleAogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBvYmplY3QgdG8gZ2V0LgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBpbmRleCBvZiB0aGUgb2JqZWN0IGluIHRoaXMgdGlsZW1hcCwgb3IgbnVsbCBpZiBub3QgZm91bmQuCiAgICAqLwogICAgZ2V0T2JqZWN0SW5kZXg6IGZ1bmN0aW9uIChuYW1lKSB7CgogICAgICAgIHJldHVybiB0aGlzLmdldEluZGV4KHRoaXMub2JqZWN0cywgbmFtZSk7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyBhIGdsb2JhbCBjb2xsaXNpb24gY2FsbGJhY2sgZm9yIHRoZSBnaXZlbiB0aWxlIGluZGV4IHdpdGhpbiB0aGUgbGF5ZXIuIFRoaXMgd2lsbCBhZmZlY3QgYWxsIHRpbGVzIG9uIHRoaXMgbGF5ZXIgdGhhdCBoYXZlIHRoZSBzYW1lIGluZGV4LgogICAgKiBJZiBhIGNhbGxiYWNrIGlzIGFscmVhZHkgc2V0IGZvciB0aGUgdGlsZSBpbmRleCBpdCB3aWxsIGJlIHJlcGxhY2VkLiBTZXQgdGhlIGNhbGxiYWNrIHRvIG51bGwgdG8gcmVtb3ZlIGl0LgogICAgKiBJZiB5b3Ugd2FudCB0byBzZXQgYSBjYWxsYmFjayBmb3IgYSB0aWxlIGF0IGEgc3BlY2lmaWMgbG9jYXRpb24gb24gdGhlIG1hcCB0aGVuIHNlZSBzZXRUaWxlTG9jYXRpb25DYWxsYmFjay4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNzZXRUaWxlSW5kZXhDYWxsYmFjawogICAgKiBAcGFyYW0ge251bWJlcnxhcnJheX0gaW5kZXhlcyAtIEVpdGhlciBhIHNpbmdsZSB0aWxlIGluZGV4LCBvciBhbiBhcnJheSBvZiB0aWxlIGluZGV4ZXMgdG8gaGF2ZSBhIGNvbGxpc2lvbiBjYWxsYmFjayBzZXQgZm9yLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBjYWxsYmFjayB0aGF0IHdpbGwgYmUgaW52b2tlZCB3aGVuIHRoZSB0aWxlIGlzIGNvbGxpZGVkIHdpdGguCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCB1bmRlciB3aGljaCB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkLgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBvcGVyYXRlIG9uLiBJZiBub3QgZ2l2ZW4gd2lsbCBkZWZhdWx0IHRvIHRoaXMuY3VycmVudExheWVyLgogICAgKi8KICAgIHNldFRpbGVJbmRleENhbGxiYWNrOiBmdW5jdGlvbiAoaW5kZXhlcywgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgbGF5ZXIpIHsKCiAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVyKTsKCiAgICAgICAgaWYgKHR5cGVvZiBpbmRleGVzID09PSAnbnVtYmVyJykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBUaGlzIG1heSBzZWVtIGEgYml0IHdhc3RlZnVsLCBiZWNhdXNlIGl0IHdpbGwgY2F1c2UgZW1wdHkgYXJyYXkgZWxlbWVudHMgdG8gYmUgY3JlYXRlZCwgYnV0IHRoZSBsb29rLXVwIGNvc3QgaXMgbXVjaAogICAgICAgICAgICAvLyAgbGVzcyB0aGFuIGhhdmluZyB0byBpdGVyYXRlIHRocm91Z2ggdGhlIGNhbGxiYWNrcyBhcnJheSBodW50aW5nIGRvd24gdGlsZSBpbmRleGVzIGVhY2ggdGltZSwgc28gSSdsbCB0YWtlIHRoZSBzbWFsbCBtZW1vcnkgaGl0LgogICAgICAgICAgICB0aGlzLmxheWVyc1tsYXllcl0uY2FsbGJhY2tzW2luZGV4ZXNdID0geyBjYWxsYmFjazogY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dDogY2FsbGJhY2tDb250ZXh0IH07CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBpbmRleGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmxheWVyc1tsYXllcl0uY2FsbGJhY2tzW2luZGV4ZXNbaV1dID0geyBjYWxsYmFjazogY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dDogY2FsbGJhY2tDb250ZXh0IH07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyBhIGdsb2JhbCBjb2xsaXNpb24gY2FsbGJhY2sgZm9yIHRoZSBnaXZlbiB0aWxlIGluZGV4IHdpdGhpbiB0aGUgbGF5ZXIuIFRoaXMgd2lsbCBhZmZlY3QgYWxsIHRpbGVzIG9uIHRoaXMgbGF5ZXIgdGhhdCBoYXZlIHRoZSBzYW1lIGluZGV4LgogICAgKiBJZiBhIGNhbGxiYWNrIGlzIGFscmVhZHkgc2V0IGZvciB0aGUgdGlsZSBpbmRleCBpdCB3aWxsIGJlIHJlcGxhY2VkLiBTZXQgdGhlIGNhbGxiYWNrIHRvIG51bGwgdG8gcmVtb3ZlIGl0LgogICAgKiBJZiB5b3Ugd2FudCB0byBzZXQgYSBjYWxsYmFjayBmb3IgYSB0aWxlIGF0IGEgc3BlY2lmaWMgbG9jYXRpb24gb24gdGhlIG1hcCB0aGVuIHNlZSBzZXRUaWxlTG9jYXRpb25DYWxsYmFjay4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNzZXRUaWxlTG9jYXRpb25DYWxsYmFjawogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIGNvcHkgKGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIGNvcHkgKGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIGFyZWEgdG8gY29weSAoZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBhcmVhIHRvIGNvcHkgKGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBjYWxsYmFjayB0aGF0IHdpbGwgYmUgaW52b2tlZCB3aGVuIHRoZSB0aWxlIGlzIGNvbGxpZGVkIHdpdGguCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCB1bmRlciB3aGljaCB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkLgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBvcGVyYXRlIG9uLiBJZiBub3QgZ2l2ZW4gd2lsbCBkZWZhdWx0IHRvIHRoaXMuY3VycmVudExheWVyLgogICAgKi8KICAgIHNldFRpbGVMb2NhdGlvbkNhbGxiYWNrOiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgbGF5ZXIpIHsKCiAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVyKTsKCiAgICAgICAgdGhpcy5jb3B5KHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKTsKCiAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHMubGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdGhpcy5fcmVzdWx0cy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHNbaV0uc2V0Q29sbGlzaW9uQ2FsbGJhY2soY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgY29sbGlzaW9uIHRoZSBnaXZlbiB0aWxlIG9yIHRpbGVzLiBZb3UgY2FuIHBhc3MgaW4gZWl0aGVyIGEgc2luZ2xlIG51bWVyaWMgaW5kZXggb3IgYW4gYXJyYXkgb2YgaW5kZXhlczogWyAyLCAzLCAxNSwgMjBdLgogICAgKiBUaGUgYGNvbGxpZGVzYCBwYXJhbWV0ZXIgY29udHJvbHMgaWYgY29sbGlzaW9uIHdpbGwgYmUgZW5hYmxlZCAodHJ1ZSkgb3IgZGlzYWJsZWQgKGZhbHNlKS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNzZXRDb2xsaXNpb24KICAgICogQHBhcmFtIHtudW1iZXJ8YXJyYXl9IGluZGV4ZXMgLSBFaXRoZXIgYSBzaW5nbGUgdGlsZSBpbmRleCwgb3IgYW4gYXJyYXkgb2YgdGlsZSBJRHMgdG8gYmUgY2hlY2tlZCBmb3IgY29sbGlzaW9uLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjb2xsaWRlcz10cnVlXSAtIElmIHRydWUgaXQgd2lsbCBlbmFibGUgY29sbGlzaW9uLiBJZiBmYWxzZSBpdCB3aWxsIGNsZWFyIGNvbGxpc2lvbi4KICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfFBoYXNlci5UaWxlbWFwTGF5ZXJ9IFtsYXllcl0gLSBUaGUgbGF5ZXIgdG8gb3BlcmF0ZSBvbi4gSWYgbm90IGdpdmVuIHdpbGwgZGVmYXVsdCB0byB0aGlzLmN1cnJlbnRMYXllci4KICAgICovCiAgICBzZXRDb2xsaXNpb246IGZ1bmN0aW9uIChpbmRleGVzLCBjb2xsaWRlcywgbGF5ZXIpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBjb2xsaWRlcyA9PT0gJ3VuZGVmaW5lZCcpIHsgY29sbGlkZXMgPSB0cnVlOyB9CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIGlmICh0eXBlb2YgaW5kZXhlcyA9PT0gJ251bWJlcicpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRDb2xsaXNpb25CeUluZGV4KGluZGV4ZXMsIGNvbGxpZGVzLCBsYXllciwgdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBDb2xsaWRlIGFsbCBvZiB0aGUgSURzIGdpdmVuIGluIHRoZSBpbmRleGVzIGFycmF5CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBpbmRleGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNldENvbGxpc2lvbkJ5SW5kZXgoaW5kZXhlc1tpXSwgY29sbGlkZXMsIGxheWVyLCBmYWxzZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBOb3cgcmUtY2FsY3VsYXRlIGludGVyZXN0aW5nIGZhY2VzCiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlRmFjZXMobGF5ZXIpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIGNvbGxpc2lvbiBvbiBhIHJhbmdlIG9mIHRpbGVzIHdoZXJlIHRoZSB0aWxlIElEcyBpbmNyZW1lbnQgc2VxdWVudGlhbGx5LgogICAgKiBDYWxsaW5nIHRoaXMgd2l0aCBhIHN0YXJ0IHZhbHVlIG9mIDEwIGFuZCBhIHN0b3AgdmFsdWUgb2YgMTQgd291bGQgc2V0IGNvbGxpc2lvbiBmb3IgdGlsZXMgMTAsIDExLCAxMiwgMTMgYW5kIDE0LgogICAgKiBUaGUgYGNvbGxpZGVzYCBwYXJhbWV0ZXIgY29udHJvbHMgaWYgY29sbGlzaW9uIHdpbGwgYmUgZW5hYmxlZCAodHJ1ZSkgb3IgZGlzYWJsZWQgKGZhbHNlKS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNzZXRDb2xsaXNpb25CZXR3ZWVuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCAtIFRoZSBmaXJzdCBpbmRleCBvZiB0aGUgdGlsZSB0byBiZSBzZXQgZm9yIGNvbGxpc2lvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHN0b3AgLSBUaGUgbGFzdCBpbmRleCBvZiB0aGUgdGlsZSB0byBiZSBzZXQgZm9yIGNvbGxpc2lvbi4KICAgICogQHBhcmFtIHtib29sZWFufSBbY29sbGlkZXM9dHJ1ZV0gLSBJZiB0cnVlIGl0IHdpbGwgZW5hYmxlIGNvbGxpc2lvbi4gSWYgZmFsc2UgaXQgd2lsbCBjbGVhciBjb2xsaXNpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIG9wZXJhdGUgb24uIElmIG5vdCBnaXZlbiB3aWxsIGRlZmF1bHQgdG8gdGhpcy5jdXJyZW50TGF5ZXIuCiAgICAqLwogICAgc2V0Q29sbGlzaW9uQmV0d2VlbjogZnVuY3Rpb24gKHN0YXJ0LCBzdG9wLCBjb2xsaWRlcywgbGF5ZXIpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBjb2xsaWRlcyA9PT0gJ3VuZGVmaW5lZCcpIHsgY29sbGlkZXMgPSB0cnVlOyB9CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIGlmIChzdGFydCA+IHN0b3ApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpbmRleCA9IHN0YXJ0OyBpbmRleCA8PSBzdG9wOyBpbmRleCsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zZXRDb2xsaXNpb25CeUluZGV4KGluZGV4LCBjb2xsaWRlcywgbGF5ZXIsIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIC8vICBOb3cgcmUtY2FsY3VsYXRlIGludGVyZXN0aW5nIGZhY2VzCiAgICAgICAgdGhpcy5jYWxjdWxhdGVGYWNlcyhsYXllcik7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyBjb2xsaXNpb24gb24gYWxsIHRpbGVzIGluIHRoZSBnaXZlbiBsYXllciwgZXhjZXB0IGZvciB0aGUgSURzIG9mIHRob3NlIGluIHRoZSBnaXZlbiBhcnJheS4KICAgICogVGhlIGBjb2xsaWRlc2AgcGFyYW1ldGVyIGNvbnRyb2xzIGlmIGNvbGxpc2lvbiB3aWxsIGJlIGVuYWJsZWQgKHRydWUpIG9yIGRpc2FibGVkIChmYWxzZSkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjc2V0Q29sbGlzaW9uQnlFeGNsdXNpb24KICAgICogQHBhcmFtIHthcnJheX0gaW5kZXhlcyAtIEFuIGFycmF5IG9mIHRoZSB0aWxlIElEcyB0byBub3QgYmUgY291bnRlZCBmb3IgY29sbGlzaW9uLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjb2xsaWRlcz10cnVlXSAtIElmIHRydWUgaXQgd2lsbCBlbmFibGUgY29sbGlzaW9uLiBJZiBmYWxzZSBpdCB3aWxsIGNsZWFyIGNvbGxpc2lvbi4KICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfFBoYXNlci5UaWxlbWFwTGF5ZXJ9IFtsYXllcl0gLSBUaGUgbGF5ZXIgdG8gb3BlcmF0ZSBvbi4gSWYgbm90IGdpdmVuIHdpbGwgZGVmYXVsdCB0byB0aGlzLmN1cnJlbnRMYXllci4KICAgICovCiAgICBzZXRDb2xsaXNpb25CeUV4Y2x1c2lvbjogZnVuY3Rpb24gKGluZGV4ZXMsIGNvbGxpZGVzLCBsYXllcikgewoKICAgICAgICBpZiAodHlwZW9mIGNvbGxpZGVzID09PSAndW5kZWZpbmVkJykgeyBjb2xsaWRlcyA9IHRydWU7IH0KCiAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVyKTsKCiAgICAgICAgLy8gIENvbGxpZGUgZXZlcnl0aGluZywgZXhjZXB0IHRoZSBJRHMgZ2l2ZW4gaW4gdGhlIGluZGV4ZXMgYXJyYXkKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy50aWxlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmRleGVzLmluZGV4T2YoaSkgPT09IC0xKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNldENvbGxpc2lvbkJ5SW5kZXgoaSwgY29sbGlkZXMsIGxheWVyLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vICBOb3cgcmUtY2FsY3VsYXRlIGludGVyZXN0aW5nIGZhY2VzCiAgICAgICAgdGhpcy5jYWxjdWxhdGVGYWNlcyhsYXllcik7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyBjb2xsaXNpb24gdmFsdWVzIG9uIGEgdGlsZSBpbiB0aGUgc2V0LgogICAgKiBZb3Ugc2hvdWxkbid0IHVzdWFsbHkgY2FsbCB0aGlzIG1ldGhvZCBkaXJlY3RseSwgaW5zdGVhZCB1c2Ugc2V0Q29sbGlzaW9uLCBzZXRDb2xsaXNpb25CZXR3ZWVuIG9yIHNldENvbGxpc2lvbkJ5RXhjbHVzaW9uLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI3NldENvbGxpc2lvbkJ5SW5kZXgKICAgICogQHByb3RlY3RlZAogICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhlIHRpbGUgb24gdGhlIGxheWVyLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjb2xsaWRlcz10cnVlXSAtIElmIHRydWUgaXQgd2lsbCBlbmFibGUgY29sbGlzaW9uIG9uIHRoZSB0aWxlLiBJZiBmYWxzZSBpdCB3aWxsIGNsZWFyIGNvbGxpc2lvbiB2YWx1ZXMgZnJvbSB0aGUgdGlsZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtsYXllcl0gLSBUaGUgbGF5ZXIgdG8gb3BlcmF0ZSBvbi4gSWYgbm90IGdpdmVuIHdpbGwgZGVmYXVsdCB0byB0aGlzLmN1cnJlbnRMYXllci4KICAgICogQHBhcmFtIHtib29sZWFufSBbcmVjYWxjdWxhdGU9dHJ1ZV0gLSBSZWNhbGN1bGF0ZXMgdGhlIHRpbGUgZmFjZXMgYWZ0ZXIgdGhlIHVwZGF0ZS4KICAgICovCiAgICBzZXRDb2xsaXNpb25CeUluZGV4OiBmdW5jdGlvbiAoaW5kZXgsIGNvbGxpZGVzLCBsYXllciwgcmVjYWxjdWxhdGUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBjb2xsaWRlcyA9PT0gJ3VuZGVmaW5lZCcpIHsgY29sbGlkZXMgPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBsYXllciA9PT0gJ3VuZGVmaW5lZCcpIHsgbGF5ZXIgPSB0aGlzLmN1cnJlbnRMYXllcjsgfQogICAgICAgIGlmICh0eXBlb2YgcmVjYWxjdWxhdGUgPT09ICd1bmRlZmluZWQnKSB7IHJlY2FsY3VsYXRlID0gdHJ1ZTsgfQoKICAgICAgICBmb3IgKHZhciB5ID0gMDsgeSA8IHRoaXMubGF5ZXJzW2xheWVyXS5oZWlnaHQgOyB5KyspCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHRoaXMubGF5ZXJzW2xheWVyXS53aWR0aDsgeCsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdGlsZSA9IHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3ldW3hdOwoKICAgICAgICAgICAgICAgIGlmICh0aWxlICYmIHRpbGUuaW5kZXggPT09IGluZGV4KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRpbGUuY29sbGlkZXMgPSBjb2xsaWRlczsKICAgICAgICAgICAgICAgICAgICB0aWxlLmZhY2VUb3AgPSBjb2xsaWRlczsKICAgICAgICAgICAgICAgICAgICB0aWxlLmZhY2VCb3R0b20gPSBjb2xsaWRlczsKICAgICAgICAgICAgICAgICAgICB0aWxlLmZhY2VMZWZ0ID0gY29sbGlkZXM7CiAgICAgICAgICAgICAgICAgICAgdGlsZS5mYWNlUmlnaHQgPSBjb2xsaWRlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHJlY2FsY3VsYXRlKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIE5vdyByZS1jYWxjdWxhdGUgaW50ZXJlc3RpbmcgZmFjZXMKICAgICAgICAgICAgdGhpcy5jYWxjdWxhdGVGYWNlcyhsYXllcik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbGF5ZXI7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0cyB0aGUgVGlsZW1hcExheWVyIGluZGV4IGFzIHVzZWQgaW4gdGhlIHNldENvbGxpc2lvbiBjYWxscy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNnZXRMYXllcgogICAgKiBAcHJvdGVjdGVkCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBsYXllciAtIFRoZSBsYXllciB0byBvcGVyYXRlIG9uLiBJZiBub3QgZ2l2ZW4gd2lsbCBkZWZhdWx0IHRvIHRoaXMuY3VycmVudExheWVyLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBUaWxlbWFwTGF5ZXIgaW5kZXguCiAgICAqLwogICAgZ2V0TGF5ZXI6IGZ1bmN0aW9uIChsYXllcikgewoKICAgICAgICBpZiAodHlwZW9mIGxheWVyID09PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIGxheWVyID0gdGhpcy5jdXJyZW50TGF5ZXI7CiAgICAgICAgfQogICAgICAgIC8vIGVsc2UgaWYgKHR5cGVvZiBsYXllciA9PT0gJ251bWJlcicpCiAgICAgICAgLy8gewogICAgICAgIC8vICAgICBsYXllciA9IGxheWVyOwogICAgICAgIC8vIH0KICAgICAgICBlbHNlIGlmICh0eXBlb2YgbGF5ZXIgPT09ICdzdHJpbmcnKQogICAgICAgIHsKICAgICAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVySW5kZXgobGF5ZXIpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChsYXllciBpbnN0YW5jZW9mIFBoYXNlci5UaWxlbWFwTGF5ZXIpCiAgICAgICAgewogICAgICAgICAgICBsYXllciA9IGxheWVyLmluZGV4OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGxheWVyOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIGZ1bmN0aW9uLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI2NhbGN1bGF0ZUZhY2VzCiAgICAqIEBwcm90ZWN0ZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IGxheWVyIC0gVGhlIGluZGV4IG9mIHRoZSBUaWxlbWFwTGF5ZXIgdG8gb3BlcmF0ZSBvbi4KICAgICovCiAgICBjYWxjdWxhdGVGYWNlczogZnVuY3Rpb24gKGxheWVyKSB7CgogICAgICAgIHZhciBhYm92ZSA9IG51bGw7CiAgICAgICAgdmFyIGJlbG93ID0gbnVsbDsKICAgICAgICB2YXIgbGVmdCA9IG51bGw7CiAgICAgICAgdmFyIHJpZ2h0ID0gbnVsbDsKCiAgICAgICAgZm9yICh2YXIgeSA9IDAsIGggPSB0aGlzLmxheWVyc1tsYXllcl0uaGVpZ2h0OyB5IDwgaDsgeSsrKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgeCA9IDAsIHcgPSB0aGlzLmxheWVyc1tsYXllcl0ud2lkdGg7IHggPCB3OyB4KyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0aWxlID0gdGhpcy5sYXllcnNbbGF5ZXJdLmRhdGFbeV1beF07CgogICAgICAgICAgICAgICAgaWYgKHRpbGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYWJvdmUgPSB0aGlzLmdldFRpbGVBYm92ZShsYXllciwgeCwgeSk7CiAgICAgICAgICAgICAgICAgICAgYmVsb3cgPSB0aGlzLmdldFRpbGVCZWxvdyhsYXllciwgeCwgeSk7CiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IHRoaXMuZ2V0VGlsZUxlZnQobGF5ZXIsIHgsIHkpOwogICAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5nZXRUaWxlUmlnaHQobGF5ZXIsIHgsIHkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYWJvdmUgJiYgYWJvdmUuY29sbGlkZXMpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyAgVGhlcmUgaXMgYSB0aWxlIGFib3ZlIHRoaXMgb25lIHRoYXQgYWxzbyBjb2xsaWRlcywgc28gdGhlIHRvcCBvZiB0aGlzIHRpbGUgaXMgbm8gbG9uZ2VyIGludGVyZXN0aW5nCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbGUuZmFjZVRvcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGJlbG93ICYmIGJlbG93LmNvbGxpZGVzKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIFRoZXJlIGlzIGEgdGlsZSBiZWxvdyB0aGlzIG9uZSB0aGF0IGFsc28gY29sbGlkZXMsIHNvIHRoZSBib3R0b20gb2YgdGhpcyB0aWxlIGlzIG5vIGxvbmdlciBpbnRlcmVzdGluZwogICAgICAgICAgICAgICAgICAgICAgICB0aWxlLmZhY2VCb3R0b20gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChsZWZ0ICYmIGxlZnQuY29sbGlkZXMpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyAgVGhlcmUgaXMgYSB0aWxlIGxlZnQgdGhpcyBvbmUgdGhhdCBhbHNvIGNvbGxpZGVzLCBzbyB0aGUgbGVmdCBvZiB0aGlzIHRpbGUgaXMgbm8gbG9uZ2VyIGludGVyZXN0aW5nCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbGUuZmFjZUxlZnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChyaWdodCAmJiByaWdodC5jb2xsaWRlcykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vICBUaGVyZSBpcyBhIHRpbGUgcmlnaHQgdGhpcyBvbmUgdGhhdCBhbHNvIGNvbGxpZGVzLCBzbyB0aGUgcmlnaHQgb2YgdGhpcyB0aWxlIGlzIG5vIGxvbmdlciBpbnRlcmVzdGluZwogICAgICAgICAgICAgICAgICAgICAgICB0aWxlLmZhY2VSaWdodCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXRzIHRoZSB0aWxlIGFib3ZlIHRoZSB0aWxlIGNvb3JkaW5hdGVzIGdpdmVuLgogICAgKiBNb3N0bHkgdXNlZCBhcyBhbiBpbnRlcm5hbCBmdW5jdGlvbiBieSBjYWxjdWxhdGVGYWNlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNnZXRUaWxlQWJvdmUKICAgICogQHBhcmFtIHtudW1iZXJ9IGxheWVyIC0gVGhlIGxvY2FsIGxheWVyIGluZGV4IHRvIGdldCB0aGUgdGlsZSBmcm9tLiBDYW4gYmUgZGV0ZXJtaW5lZCBieSBUaWxlbWFwLmdldExheWVyKCkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSB0byBnZXQgdGhlIHRpbGUgZnJvbS4gSW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSB0byBnZXQgdGhlIHRpbGUgZnJvbS4gSW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqLwogICAgZ2V0VGlsZUFib3ZlOiBmdW5jdGlvbiAobGF5ZXIsIHgsIHkpIHsKCiAgICAgICAgaWYgKHkgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3kgLSAxXVt4XTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldHMgdGhlIHRpbGUgYmVsb3cgdGhlIHRpbGUgY29vcmRpbmF0ZXMgZ2l2ZW4uCiAgICAqIE1vc3RseSB1c2VkIGFzIGFuIGludGVybmFsIGZ1bmN0aW9uIGJ5IGNhbGN1bGF0ZUZhY2VzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI2dldFRpbGVCZWxvdwogICAgKiBAcGFyYW0ge251bWJlcn0gbGF5ZXIgLSBUaGUgbG9jYWwgbGF5ZXIgaW5kZXggdG8gZ2V0IHRoZSB0aWxlIGZyb20uIENhbiBiZSBkZXRlcm1pbmVkIGJ5IFRpbGVtYXAuZ2V0TGF5ZXIoKS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIGdldCB0aGUgdGlsZSBmcm9tLiBJbiB0aWxlcywgbm90IHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIHRvIGdldCB0aGUgdGlsZSBmcm9tLiBJbiB0aWxlcywgbm90IHBpeGVscy4KICAgICovCiAgICBnZXRUaWxlQmVsb3c6IGZ1bmN0aW9uIChsYXllciwgeCwgeSkgewoKICAgICAgICBpZiAoeSA8IHRoaXMubGF5ZXJzW2xheWVyXS5oZWlnaHQgLSAxKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3kgKyAxXVt4XTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldHMgdGhlIHRpbGUgdG8gdGhlIGxlZnQgb2YgdGhlIHRpbGUgY29vcmRpbmF0ZXMgZ2l2ZW4uCiAgICAqIE1vc3RseSB1c2VkIGFzIGFuIGludGVybmFsIGZ1bmN0aW9uIGJ5IGNhbGN1bGF0ZUZhY2VzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI2dldFRpbGVMZWZ0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllciAtIFRoZSBsb2NhbCBsYXllciBpbmRleCB0byBnZXQgdGhlIHRpbGUgZnJvbS4gQ2FuIGJlIGRldGVybWluZWQgYnkgVGlsZW1hcC5nZXRMYXllcigpLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgdG8gZ2V0IHRoZSB0aWxlIGZyb20uIEluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgdG8gZ2V0IHRoZSB0aWxlIGZyb20uIEluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKi8KICAgIGdldFRpbGVMZWZ0OiBmdW5jdGlvbiAobGF5ZXIsIHgsIHkpIHsKCiAgICAgICAgaWYgKHggPiAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3ldW3ggLSAxXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldHMgdGhlIHRpbGUgdG8gdGhlIHJpZ2h0IG9mIHRoZSB0aWxlIGNvb3JkaW5hdGVzIGdpdmVuLgogICAgKiBNb3N0bHkgdXNlZCBhcyBhbiBpbnRlcm5hbCBmdW5jdGlvbiBieSBjYWxjdWxhdGVGYWNlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNnZXRUaWxlUmlnaHQKICAgICogQHBhcmFtIHtudW1iZXJ9IGxheWVyIC0gVGhlIGxvY2FsIGxheWVyIGluZGV4IHRvIGdldCB0aGUgdGlsZSBmcm9tLiBDYW4gYmUgZGV0ZXJtaW5lZCBieSBUaWxlbWFwLmdldExheWVyKCkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSB0byBnZXQgdGhlIHRpbGUgZnJvbS4gSW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSB0byBnZXQgdGhlIHRpbGUgZnJvbS4gSW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqLwogICAgZ2V0VGlsZVJpZ2h0OiBmdW5jdGlvbiAobGF5ZXIsIHgsIHkpIHsKCiAgICAgICAgaWYgKHggPCB0aGlzLmxheWVyc1tsYXllcl0ud2lkdGggLSAxKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3ldW3ggKyAxXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGN1cnJlbnQgbGF5ZXIgdG8gdGhlIGdpdmVuIGluZGV4LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI3NldExheWVyCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBsYXllciAtIFRoZSBsYXllciB0byBzZXQgYXMgY3VycmVudC4KICAgICovCiAgICBzZXRMYXllcjogZnVuY3Rpb24gKGxheWVyKSB7CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIGlmICh0aGlzLmxheWVyc1tsYXllcl0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRMYXllciA9IGxheWVyOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBQdXRzIGEgdGlsZSBvZiB0aGUgZ2l2ZW4gaW5kZXggdmFsdWUgYXQgdGhlIGNvb3JkaW5hdGUgc3BlY2lmaWVkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI3B1dFRpbGUKICAgICogQHBhcmFtIHtQaGFzZXIuVGlsZXxudW1iZXJ9IHRpbGUgLSBUaGUgaW5kZXggb2YgdGhpcyB0aWxlIHRvIHNldCBvciBhIFBoYXNlci5UaWxlIG9iamVjdC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIHRvIHBsYWNlIHRoZSB0aWxlIChnaXZlbiBpbiB0aWxlIHVuaXRzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gdG8gcGxhY2UgdGhlIHRpbGUgKGdpdmVuIGluIHRpbGUgdW5pdHMsIG5vdCBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIG1vZGlmeS4KICAgICovCiAgICBwdXRUaWxlOiBmdW5jdGlvbiAodGlsZSwgeCwgeSwgbGF5ZXIpIHsKCiAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVyKTsKCiAgICAgICAgaWYgKHggPj0gMCAmJiB4IDwgdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoICYmIHkgPj0gMCAmJiB5IDwgdGhpcy5sYXllcnNbbGF5ZXJdLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aWxlIGluc3RhbmNlb2YgUGhhc2VyLlRpbGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3ldW3hdLmNvcHkodGlsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt5XVt4XS5pbmRleCA9IHRpbGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubGF5ZXJzW2xheWVyXS5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlRmFjZXMobGF5ZXIpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBQdXRzIGEgdGlsZSBpbnRvIHRoZSBUaWxlbWFwIGxheWVyLiBUaGUgY29vcmRpbmF0ZXMgYXJlIGdpdmVuIGluIHBpeGVsIHZhbHVlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNwdXRUaWxlV29ybGRYWQogICAgKiBAcGFyYW0ge1BoYXNlci5UaWxlfG51bWJlcn0gdGlsZSAtIFRoZSBpbmRleCBvZiB0aGlzIHRpbGUgdG8gc2V0IG9yIGEgUGhhc2VyLlRpbGUgb2JqZWN0LgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gdG8gaW5zZXJ0IHRoZSB0aWxlIChnaXZlbiBpbiBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiB0byBpbnNlcnQgdGhlIHRpbGUgKGdpdmVuIGluIHBpeGVscykKICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbGVXaWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgdGlsZSBpbiBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlSGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgdGlsZSBpbiBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIG1vZGlmeS4KICAgICovCiAgICBwdXRUaWxlV29ybGRYWTogZnVuY3Rpb24gKHRpbGUsIHgsIHksIHRpbGVXaWR0aCwgdGlsZUhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVyKTsKCiAgICAgICAgeCA9IHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHgsIHRpbGVXaWR0aCkgLyB0aWxlV2lkdGg7CiAgICAgICAgeSA9IHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHksIHRpbGVIZWlnaHQpIC8gdGlsZUhlaWdodDsKCiAgICAgICAgdGhpcy5wdXRUaWxlKHRpbGUsIHgsIHksIGxheWVyKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXRzIGEgdGlsZSBmcm9tIHRoZSBUaWxlbWFwIExheWVyLiBUaGUgY29vcmRpbmF0ZXMgYXJlIGdpdmVuIGluIHRpbGUgdmFsdWVzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI2dldFRpbGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIHRvIGdldCB0aGUgdGlsZSBmcm9tIChnaXZlbiBpbiB0aWxlIHVuaXRzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gdG8gZ2V0IHRoZSB0aWxlIGZyb20gKGdpdmVuIGluIHRpbGUgdW5pdHMsIG5vdCBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIGdldCB0aGUgdGlsZSBmcm9tLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGlsZX0gVGhlIHRpbGUgYXQgdGhlIGdpdmVuIGNvb3JkaW5hdGVzLgogICAgKi8KICAgIGdldFRpbGU6IGZ1bmN0aW9uICh4LCB5LCBsYXllcikgewoKICAgICAgICBsYXllciA9IHRoaXMuZ2V0TGF5ZXIobGF5ZXIpOwoKICAgICAgICBpZiAoeCA+PSAwICYmIHggPCB0aGlzLmxheWVyc1tsYXllcl0ud2lkdGggJiYgeSA+PSAwICYmIHkgPCB0aGlzLmxheWVyc1tsYXllcl0uaGVpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3ldW3hdOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXRzIGEgdGlsZSBmcm9tIHRoZSBUaWxlbWFwIGxheWVyLiBUaGUgY29vcmRpbmF0ZXMgYXJlIGdpdmVuIGluIHBpeGVsIHZhbHVlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNnZXRUaWxlV29ybGRYWQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gdG8gZ2V0IHRoZSB0aWxlIGZyb20gKGdpdmVuIGluIHBpeGVscykKICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIHRvIGdldCB0aGUgdGlsZSBmcm9tIChnaXZlbiBpbiBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIGdldCB0aGUgdGlsZSBmcm9tLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGlsZX0gVGhlIHRpbGUgYXQgdGhlIGdpdmVuIGNvb3JkaW5hdGVzLgogICAgKi8KICAgIGdldFRpbGVXb3JsZFhZOiBmdW5jdGlvbiAoeCwgeSwgdGlsZVdpZHRoLCB0aWxlSGVpZ2h0LCBsYXllcikgewoKICAgICAgICBsYXllciA9IHRoaXMuZ2V0TGF5ZXIobGF5ZXIpOwoKICAgICAgICB4ID0gdGhpcy5nYW1lLm1hdGguc25hcFRvRmxvb3IoeCwgdGlsZVdpZHRoKSAvIHRpbGVXaWR0aDsKICAgICAgICB5ID0gdGhpcy5nYW1lLm1hdGguc25hcFRvRmxvb3IoeSwgdGlsZUhlaWdodCkgLyB0aWxlSGVpZ2h0OwoKICAgICAgICByZXR1cm4gdGhpcy5nZXRUaWxlKHgsIHksIGxheWVyKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDb3BpZXMgYWxsIG9mIHRoZSB0aWxlcyBpbiB0aGUgZ2l2ZW4gcmVjdGFuZ3VsYXIgYmxvY2sgaW50byB0aGUgdGlsZW1hcCBkYXRhIGJ1ZmZlci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNjb3B5CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgb2YgdGhlIGFyZWEgdG8gY29weSAoZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgb2YgdGhlIGFyZWEgdG8gY29weSAoZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgYXJlYSB0byBjb3B5IChnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscykKICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIGFyZWEgdG8gY29weSAoZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIGNvcHkgdGhlIHRpbGVzIGZyb20uCiAgICAqIEByZXR1cm4ge2FycmF5fSBBbiBhcnJheSBvZiB0aGUgdGlsZXMgdGhhdCB3ZXJlIGNvcGllZC4KICAgICovCiAgICBjb3B5OiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVyKTsKCiAgICAgICAgaWYgKCF0aGlzLmxheWVyc1tsYXllcl0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9yZXN1bHRzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgeCA9PT0gInVuZGVmaW5lZCIpIHsgeCA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIHkgPT09ICJ1bmRlZmluZWQiKSB7IHkgPSAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB3aWR0aCA9PT0gInVuZGVmaW5lZCIpIHsgd2lkdGggPSB0aGlzLmxheWVyc1tsYXllcl0ud2lkdGg7IH0KICAgICAgICBpZiAodHlwZW9mIGhlaWdodCA9PT0gInVuZGVmaW5lZCIpIHsgaGVpZ2h0ID0gdGhpcy5sYXllcnNbbGF5ZXJdLmhlaWdodDsgfQoKICAgICAgICBpZiAoeCA8IDApCiAgICAgICAgewogICAgICAgICAgICB4ID0gMDsKICAgICAgICB9CgogICAgICAgIGlmICh5IDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIHkgPSAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdpZHRoID4gdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoKQogICAgICAgIHsKICAgICAgICAgICAgd2lkdGggPSB0aGlzLmxheWVyc1tsYXllcl0ud2lkdGg7CiAgICAgICAgfQoKICAgICAgICBpZiAoaGVpZ2h0ID4gdGhpcy5sYXllcnNbbGF5ZXJdLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIGhlaWdodCA9IHRoaXMubGF5ZXJzW2xheWVyXS5oZWlnaHQ7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9yZXN1bHRzLmxlbmd0aCA9IDA7CgogICAgICAgIHRoaXMuX3Jlc3VsdHMucHVzaCggeyB4OiB4LCB5OiB5LCB3aWR0aDogd2lkdGgsIGhlaWdodDogaGVpZ2h0LCBsYXllcjogbGF5ZXIgfSk7CgogICAgICAgIGZvciAodmFyIHR5ID0geTsgdHkgPCB5ICsgaGVpZ2h0OyB0eSsrKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgdHggPSB4OyB0eCA8IHggKyB3aWR0aDsgdHgrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fcmVzdWx0cy5wdXNoKHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3R5XVt0eF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5fcmVzdWx0czsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXN0ZXMgYSBwcmV2aW91c2x5IGNvcGllZCBibG9jayBvZiB0aWxlIGRhdGEgaW50byB0aGUgZ2l2ZW4geC95IGNvb3JkaW5hdGVzLiBEYXRhIHNob3VsZCBoYXZlIGJlZW4gcHJlcGFyZWQgd2l0aCBUaWxlbWFwLmNvcHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjcGFzdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBvZiB0aGUgYXJlYSB0byBwYXN0ZSB0byAoZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgb2YgdGhlIGFyZWEgdG8gcGFzdGUgdG8gKGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzKQogICAgKiBAcGFyYW0ge2FycmF5fSB0aWxlYmxvY2sgLSBUaGUgYmxvY2sgb2YgdGlsZXMgdG8gcGFzdGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIHBhc3RlIHRoZSB0aWxlcyBpbnRvLgogICAgKi8KICAgIHBhc3RlOiBmdW5jdGlvbiAoeCwgeSwgdGlsZWJsb2NrLCBsYXllcikgewoKICAgICAgICBpZiAodHlwZW9mIHggPT09ICJ1bmRlZmluZWQiKSB7IHggPSAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB5ID09PSAidW5kZWZpbmVkIikgeyB5ID0gMDsgfQogICAgICAgIAogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIGlmICghdGlsZWJsb2NrIHx8IHRpbGVibG9jay5sZW5ndGggPCAyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gIEZpbmQgb3V0IHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gdGlsZWJsb2NrWzFdLngveSBhbmQgeC95IGFuZCB1c2UgaXQgYXMgYW4gb2Zmc2V0LCBhcyBpdCdzIHRoZSB0b3AgbGVmdCBvZiB0aGUgYmxvY2sgdG8gcGFzdGUKICAgICAgICB2YXIgZGlmZlggPSB4IC0gdGlsZWJsb2NrWzFdLng7CiAgICAgICAgdmFyIGRpZmZZID0geSAtIHRpbGVibG9ja1sxXS55OwoKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRpbGVibG9jay5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhWyBkaWZmWSArIHRpbGVibG9ja1tpXS55IF1bIGRpZmZYICsgdGlsZWJsb2NrW2ldLnggXS5jb3B5KHRpbGVibG9ja1tpXSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmxheWVyc1tsYXllcl0uZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuY2FsY3VsYXRlRmFjZXMobGF5ZXIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNjYW5zIHRoZSBnaXZlbiBhcmVhIGZvciB0aWxlcyB3aXRoIGFuIGluZGV4IG1hdGNoaW5nIHRpbGVBIGFuZCBzd2FwcyB0aGVtIHdpdGggdGlsZUIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjc3dhcFRpbGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbGVBIC0gRmlyc3QgdGlsZSBpbmRleC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbGVCIC0gU2Vjb25kIHRpbGUgaW5kZXguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbmUsIGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb25lLCBnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIGluIHRpbGVzIG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IGluIHRpbGVzIG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIG9wZXJhdGUgb24uCiAgICAqLwogICAgc3dhcDogZnVuY3Rpb24gKHRpbGVBLCB0aWxlQiwgeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVyKTsKCiAgICAgICAgdGhpcy5jb3B5KHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKTsKCiAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHMubGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3RlbXBBID0gdGlsZUE7CiAgICAgICAgdGhpcy5fdGVtcEIgPSB0aWxlQjsKCiAgICAgICAgdGhpcy5fcmVzdWx0cy5mb3JFYWNoKHRoaXMuc3dhcEhhbmRsZXIsIHRoaXMpOwoKICAgICAgICB0aGlzLnBhc3RlKHgsIHksIHRoaXMuX3Jlc3VsdHMsIGxheWVyKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBmdW5jdGlvbiB0aGF0IGhhbmRsZXMgdGhlIHN3YXBwaW5nIG9mIHRpbGVzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI3N3YXBIYW5kbGVyCiAgICAqIEBwcml2YXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXgKICAgICovCiAgICBzd2FwSGFuZGxlcjogZnVuY3Rpb24gKHZhbHVlLCBpbmRleCkgewoKICAgICAgICBpZiAodmFsdWUuaW5kZXggPT09IHRoaXMuX3RlbXBBKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcmVzdWx0c1tpbmRleF0uaW5kZXggPSB0aGlzLl90ZW1wQjsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodmFsdWUuaW5kZXggPT09IHRoaXMuX3RlbXBCKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcmVzdWx0c1tpbmRleF0uaW5kZXggPSB0aGlzLl90ZW1wQTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogRm9yIGVhY2ggdGlsZSBpbiB0aGUgZ2l2ZW4gYXJlYSBkZWZpbmVkIGJ5IHgveSBhbmQgd2lkdGgvaGVpZ2h0IHJ1biB0aGUgZ2l2ZW4gY2FsbGJhY2suCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjZm9yRWFjaAogICAgKiBAcGFyYW0ge251bWJlcn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2suIEVhY2ggdGlsZSBpbiB0aGUgZ2l2ZW4gYXJlYSB3aWxsIGJlIHBhc3NlZCB0byB0aGlzIGNhbGxiYWNrIGFzIHRoZSBmaXJzdCBhbmQgb25seSBwYXJhbWV0ZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb250ZXh0IC0gVGhlIGNvbnRleHQgdW5kZXIgd2hpY2ggdGhlIGNhbGxiYWNrIHNob3VsZCBiZSBydW4uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbmUsIGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb25lLCBnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIGluIHRpbGVzIG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IGluIHRpbGVzIG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIG9wZXJhdGUgb24uCiAgICAqLwogICAgZm9yRWFjaDogZnVuY3Rpb24gKGNhbGxiYWNrLCBjb250ZXh0LCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcikgewoKICAgICAgICBsYXllciA9IHRoaXMuZ2V0TGF5ZXIobGF5ZXIpOwoKICAgICAgICB0aGlzLmNvcHkoeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpOwoKICAgICAgICBpZiAodGhpcy5fcmVzdWx0cy5sZW5ndGggPCAyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fcmVzdWx0cy5mb3JFYWNoKGNhbGxiYWNrLCBjb250ZXh0KTsKCiAgICAgICAgdGhpcy5wYXN0ZSh4LCB5LCB0aGlzLl9yZXN1bHRzLCBsYXllcik7CgogICAgfSwKCiAgICAvKioKICAgICogU2NhbnMgdGhlIGdpdmVuIGFyZWEgZm9yIHRpbGVzIHdpdGggYW4gaW5kZXggbWF0Y2hpbmcgYHNvdXJjZWAgYW5kIHVwZGF0ZXMgdGhlaXIgaW5kZXggdG8gbWF0Y2ggYGRlc3RgLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI3JlcGxhY2UKICAgICogQHBhcmFtIHtudW1iZXJ9IHNvdXJjZSAtIFRoZSB0aWxlIGluZGV4IHZhbHVlIHRvIHNjYW4gZm9yLgogICAgKiBAcGFyYW0ge251bWJlcn0gZGVzdCAtIFRoZSB0aWxlIGluZGV4IHZhbHVlIHRvIHJlcGxhY2UgZm91bmQgdGlsZXMgd2l0aC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uZSwgZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbmUsIGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggaW4gdGlsZXMgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgaW4gdGlsZXMgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbi4KICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfFBoYXNlci5UaWxlbWFwTGF5ZXJ9IFtsYXllcl0gLSBUaGUgbGF5ZXIgdG8gb3BlcmF0ZSBvbi4KICAgICovCiAgICByZXBsYWNlOiBmdW5jdGlvbiAoc291cmNlLCBkZXN0LCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcikgewoKICAgICAgICBsYXllciA9IHRoaXMuZ2V0TGF5ZXIobGF5ZXIpOwoKICAgICAgICB0aGlzLmNvcHkoeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpOwoKICAgICAgICBpZiAodGhpcy5fcmVzdWx0cy5sZW5ndGggPCAyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCB0aGlzLl9yZXN1bHRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHNbaV0uaW5kZXggPT09IHNvdXJjZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fcmVzdWx0c1tpXS5pbmRleCA9IGRlc3Q7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMucGFzdGUoeCwgeSwgdGhpcy5fcmVzdWx0cywgbGF5ZXIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJhbmRvbWlzZXMgYSBzZXQgb2YgdGlsZXMgaW4gYSBnaXZlbiBhcmVhLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI3JhbmRvbQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb25lLCBnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uZSwgZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBpbiB0aWxlcyBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBpbiB0aWxlcyBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uLgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBvcGVyYXRlIG9uLgogICAgKi8KICAgIHJhbmRvbTogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKSB7CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIHRoaXMuY29weSh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcik7CgogICAgICAgIGlmICh0aGlzLl9yZXN1bHRzLmxlbmd0aCA8IDIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgaW5kZXhlcyA9IFtdOwoKICAgICAgICBmb3IgKHZhciB0ID0gMTsgdCA8IHRoaXMuX3Jlc3VsdHMubGVuZ3RoOyB0KyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fcmVzdWx0c1t0XS5pbmRleCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGlkeCA9IHRoaXMuX3Jlc3VsdHNbdF0uaW5kZXg7CgogICAgICAgICAgICAgICAgaWYgKGluZGV4ZXMuaW5kZXhPZihpZHgpID09PSAtMSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpbmRleGVzLnB1c2goaWR4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCB0aGlzLl9yZXN1bHRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcmVzdWx0c1tpXS5pbmRleCA9IHRoaXMuZ2FtZS5ybmQucGljayhpbmRleGVzKTsKICAgICAgICB9CgogICAgICAgIHRoaXMucGFzdGUoeCwgeSwgdGhpcy5fcmVzdWx0cywgbGF5ZXIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNodWZmbGVzIGEgc2V0IG9mIHRpbGVzIGluIGEgZ2l2ZW4gYXJlYS4gSXQgd2lsbCBvbmx5IHJhbmRvbWlzZSB0aGUgdGlsZXMgaW4gdGhhdCBhcmVhLCBzbyBpZiB0aGV5J3JlIGFsbCB0aGUgc2FtZSBub3RoaW5nIHdpbGwgYXBwZWFyIHRvIGhhdmUgY2hhbmdlZCEKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcCNzaHVmZmxlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgb2YgdGhlIGFyZWEgdG8gb3BlcmF0ZSBvbmUsIGdpdmVuIGluIHRpbGVzLCBub3QgcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb25lLCBnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIGluIHRpbGVzIG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IGluIHRpbGVzIG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ3xQaGFzZXIuVGlsZW1hcExheWVyfSBbbGF5ZXJdIC0gVGhlIGxheWVyIHRvIG9wZXJhdGUgb24uCiAgICAqLwogICAgc2h1ZmZsZTogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKSB7CgogICAgICAgIGxheWVyID0gdGhpcy5nZXRMYXllcihsYXllcik7CgogICAgICAgIHRoaXMuY29weSh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcik7CgogICAgICAgIGlmICh0aGlzLl9yZXN1bHRzLmxlbmd0aCA8IDIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgaW5kZXhlcyA9IFtdOwoKICAgICAgICBmb3IgKHZhciB0ID0gMTsgdCA8IHRoaXMuX3Jlc3VsdHMubGVuZ3RoOyB0KyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fcmVzdWx0c1t0XS5pbmRleCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaW5kZXhlcy5wdXNoKHRoaXMuX3Jlc3VsdHNbdF0uaW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBQaGFzZXIuVXRpbHMuc2h1ZmZsZShpbmRleGVzKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCB0aGlzLl9yZXN1bHRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcmVzdWx0c1tpXS5pbmRleCA9IGluZGV4ZXNbaSAtIDFdOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5wYXN0ZSh4LCB5LCB0aGlzLl9yZXN1bHRzLCBsYXllcik7CgogICAgfSwKCiAgICAvKioKICAgICogRmlsbHMgdGhlIGdpdmVuIGFyZWEgd2l0aCB0aGUgc3BlY2lmaWVkIHRpbGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjZmlsbAogICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhlIHRpbGUgdGhhdCB0aGUgYXJlYSB3aWxsIGJlIGZpbGxlZCB3aXRoLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IG9mIHRoZSBhcmVhIHRvIG9wZXJhdGUgb25lLCBnaXZlbiBpbiB0aWxlcywgbm90IHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uZSwgZ2l2ZW4gaW4gdGlsZXMsIG5vdCBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBpbiB0aWxlcyBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBpbiB0aWxlcyBvZiB0aGUgYXJlYSB0byBvcGVyYXRlIG9uLgogICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd8UGhhc2VyLlRpbGVtYXBMYXllcn0gW2xheWVyXSAtIFRoZSBsYXllciB0byBvcGVyYXRlIG9uLgogICAgKi8KICAgIGZpbGw6IGZ1bmN0aW9uIChpbmRleCwgeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgbGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVyKTsKCiAgICAgICAgdGhpcy5jb3B5KHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKTsKCiAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHMubGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdGhpcy5fcmVzdWx0cy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHNbaV0uaW5kZXggPSBpbmRleDsKICAgICAgICB9CgogICAgICAgIHRoaXMucGFzdGUoeCwgeSwgdGhpcy5fcmVzdWx0cywgbGF5ZXIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgYWxsIGxheWVycyBmcm9tIHRoaXMgdGlsZSBtYXAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjcmVtb3ZlQWxsTGF5ZXJzCiAgICAqLwogICAgcmVtb3ZlQWxsTGF5ZXJzOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMubGF5ZXJzLmxlbmd0aCA9IDA7CiAgICAgICAgdGhpcy5jdXJyZW50TGF5ZXIgPSAwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIER1bXBzIHRoZSB0aWxlbWFwIGRhdGEgb3V0IHRvIHRoZSBjb25zb2xlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwI2R1bXAKICAgICovCiAgICBkdW1wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciB0eHQgPSAnJzsKICAgICAgICB2YXIgYXJncyA9IFsnJ107CgogICAgICAgIGZvciAodmFyIHkgPSAwOyB5IDwgdGhpcy5sYXllcnNbdGhpcy5jdXJyZW50TGF5ZXJdLmhlaWdodDsgeSsrKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLmxheWVyc1t0aGlzLmN1cnJlbnRMYXllcl0ud2lkdGg7IHgrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHh0ICs9ICIlYyAgIjsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5sYXllcnNbdGhpcy5jdXJyZW50TGF5ZXJdLmRhdGFbeV1beF0gPiAxKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlYnVnTWFwW3RoaXMubGF5ZXJzW3RoaXMuY3VycmVudExheWVyXS5kYXRhW3ldW3hdXSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCgiYmFja2dyb3VuZDogIiArIHRoaXMuZGVidWdNYXBbdGhpcy5sYXllcnNbdGhpcy5jdXJyZW50TGF5ZXJdLmRhdGFbeV1beF1dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKCJiYWNrZ3JvdW5kOiAjZmZmZmZmIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCgiYmFja2dyb3VuZDogcmdiKDAsIDAsIDApIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHR4dCArPSAiXG4iOwogICAgICAgIH0KCiAgICAgICAgYXJnc1swXSA9IHR4dDsKICAgICAgICBjb25zb2xlLmxvZy5hcHBseShjb25zb2xlLCBhcmdzKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGFsbCBsYXllcnMgZnJvbSB0aGlzIHRpbGUgbWFwIGFuZCBudWxscyB0aGUgZ2FtZSByZWZlcmVuY2UuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5yZW1vdmVBbGxMYXllcnMoKTsKICAgICAgICB0aGlzLmRhdGEgPSBbXTsKICAgICAgICB0aGlzLmdhbWUgPSBudWxsOwoKICAgIH0KCn07CgpQaGFzZXIuVGlsZW1hcC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuVGlsZW1hcDsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgVGlsZW1hcCBMYXllciBpcyBhIHNldCBvZiBtYXAgZGF0YSBjb21iaW5lZCB3aXRoIGEgVGlsZXNldCBpbiBvcmRlciB0byByZW5kZXIgdGhhdCBkYXRhIHRvIHRoZSBnYW1lLgoqCiogQGNsYXNzIFBoYXNlci5UaWxlbWFwTGF5ZXIKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gR2FtZSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtQaGFzZXIuVGlsZW1hcH0gdGlsZW1hcCAtIFRoZSB0aWxlbWFwIHRvIHdoaWNoIHRoaXMgbGF5ZXIgYmVsb25ncy4KKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgbGF5ZXIgaW5kZXggd2l0aGluIHRoZSBtYXAgdGhhdCB0aGlzIFRpbGVtYXBMYXllciByZXByZXNlbnRzLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFdpZHRoIG9mIHRoZSByZW5kZXJhYmxlIGFyZWEgb2YgdGhlIGxheWVyLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBIZWlnaHQgb2YgdGhlIHJlbmRlcmFibGUgYXJlYSBvZiB0aGUgbGF5ZXIuCiovClBoYXNlci5UaWxlbWFwTGF5ZXIgPSBmdW5jdGlvbiAoZ2FtZSwgdGlsZW1hcCwgaW5kZXgsIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlRpbGVtYXB9IG1hcCAtIFRoZSBUaWxlbWFwIHRvIHdoaWNoIHRoaXMgbGF5ZXIgaXMgYm91bmQuCiAgICAqLwogICAgdGhpcy5tYXAgPSB0aWxlbWFwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhpcyBsYXllciB3aXRoaW4gdGhlIFRpbGVtYXAuCiAgICAqLwogICAgdGhpcy5pbmRleCA9IGluZGV4OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gbGF5ZXIgLSBUaGUgbGF5ZXIgb2JqZWN0IHdpdGhpbiB0aGUgVGlsZW1hcCB0aGF0IHRoaXMgbGF5ZXIgcmVwcmVzZW50cy4KICAgICovCiAgICB0aGlzLmxheWVyID0gdGlsZW1hcC5sYXllcnNbaW5kZXhdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgY2FudmFzIHRvIHdoaWNoIHRoaXMgVGlsZW1hcExheWVyIGRyYXdzLgogICAgKi8KICAgIHRoaXMuY2FudmFzID0gUGhhc2VyLkNhbnZhcy5jcmVhdGUod2lkdGgsIGhlaWdodCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gY29udGV4dCAtIFRoZSAyZCBjb250ZXh0IG9mIHRoZSBjYW52YXMuCiAgICAqLwogICAgdGhpcy5jb250ZXh0ID0gdGhpcy5jYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UElYSS5CYXNlVGV4dHVyZX0gYmFzZVRleHR1cmUgLSBSZXF1aXJlZCBQaXhpIHZhci4KICAgICovCiAgICB0aGlzLmJhc2VUZXh0dXJlID0gbmV3IFBJWEkuQmFzZVRleHR1cmUodGhpcy5jYW52YXMpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQSVhJLlRleHR1cmV9IHRleHR1cmUgLSBSZXF1aXJlZCBQaXhpIHZhci4KICAgICovCiAgICB0aGlzLnRleHR1cmUgPSBuZXcgUElYSS5UZXh0dXJlKHRoaXMuYmFzZVRleHR1cmUpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuRnJhbWV9IHRleHR1cmVGcmFtZSAtIERpbWVuc2lvbnMgb2YgdGhlIHJlbmRlcmFibGUgYXJlYS4KICAgICovCiAgICB0aGlzLnRleHR1cmVGcmFtZSA9IG5ldyBQaGFzZXIuRnJhbWUoMCwgMCwgMCwgd2lkdGgsIGhlaWdodCwgJ3RpbGVtYXBMYXllcicsIGdhbWUucm5kLnV1aWQoKSk7CgogICAgUGhhc2VyLlNwcml0ZS5jYWxsKHRoaXMsIHRoaXMuZ2FtZSwgMCwgMCwgdGhpcy50ZXh0dXJlLCB0aGlzLnRleHR1cmVGcmFtZSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGxheWVyLgogICAgKi8KICAgIHRoaXMubmFtZSA9ICcnOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIFRoZSBjb25zdCB0eXBlIG9mIHRoaXMgb2JqZWN0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudHlwZSA9IFBoYXNlci5USUxFTUFQTEFZRVI7CgogICAgLyoqCiAgICAqIEFuIG9iamVjdCB0aGF0IGlzIGZpeGVkIHRvIHRoZSBjYW1lcmEgaWdub3JlcyB0aGUgcG9zaXRpb24gb2YgYW55IGFuY2VzdG9ycyBpbiB0aGUgZGlzcGxheSBsaXN0IGFuZCB1c2VzIGl0cyB4L3kgY29vcmRpbmF0ZXMgYXMgb2Zmc2V0cyBmcm9tIHRoZSB0b3AgbGVmdCBvZiB0aGUgY2FtZXJhLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZpeGVkVG9DYW1lcmEgLSBGaXhlcyB0aGlzIG9iamVjdCB0byB0aGUgQ2FtZXJhLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZml4ZWRUb0NhbWVyYSA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBjYW1lcmFPZmZzZXQgLSBJZiB0aGlzIG9iamVjdCBpcyBmaXhlZCB0byB0aGUgY2FtZXJhIHRoZW4gdXNlIHRoaXMgUG9pbnQgdG8gc3BlY2lmeSBob3cgZmFyIGF3YXkgZnJvbSB0aGUgQ2FtZXJhIHgveSBpdCdzIHJlbmRlcmVkLgogICAgKi8KICAgIHRoaXMuY2FtZXJhT2Zmc2V0ID0gbmV3IFBoYXNlci5Qb2ludCgwLCAwKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IHRpbGVDb2xvciAtIElmIG5vIHRpbGVzZXQgaXMgZ2l2ZW4gdGhlIHRpbGVzIHdpbGwgYmUgcmVuZGVyZWQgYXMgcmVjdGFuZ2xlcyBpbiB0aGlzIGNvbG9yLiBQcm92aWRlIGluIGhleCBvciByZ2IvcmdiYSBzdHJpbmcgZm9ybWF0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGlsZUNvbG9yID0gJ3JnYigyNTUsIDI1NSwgMjU1KSc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZGVidWcgLSBJZiBzZXQgdG8gdHJ1ZSB0aGUgY29sbGlkZWFibGUgdGlsZSBlZGdlcyBwYXRoIHdpbGwgYmUgcmVuZGVyZWQuIE9ubHkgd29ya3Mgd2hlbiBnYW1lIGlzIHJ1bm5pbmcgaW4gUGhhc2VyLkNBTlZBUyBtb2RlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGVidWcgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGRlYnVnQWxwaGEgLSBJZiBkZWJ1ZyBpcyB0cnVlIHRoZW4gdGhlIHRpbGVzZXQgaXMgcmVuZGVyZWQgd2l0aCB0aGlzIGFscGhhIGxldmVsLCB0byBtYWtlIHRoZSB0aWxlIGVkZ2VzIGNsZWFyZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kZWJ1Z0FscGhhID0gMC41OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gZGVidWdDb2xvciAtIElmIGRlYnVnIGlzIHRydWUgdGhpcyBpcyB0aGUgY29sb3IgdXNlZCB0byBvdXRsaW5lIHRoZSBlZGdlcyBvZiBjb2xsaWRhYmxlIHRpbGVzLiBQcm92aWRlIGluIGhleCBvciByZ2IvcmdiYSBzdHJpbmcgZm9ybWF0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGVidWdDb2xvciA9ICdyZ2JhKDAsIDI1NSwgMCwgMSknOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRlYnVnRmlsbCAtIElmIHRydWUgdGhlIGRlYnVnIHRpbGVzIGFyZSBmaWxsZWQgd2l0aCBkZWJ1Z0ZpbGxDb2xvciBBTkQgc3Ryb2tlZCBhcm91bmQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kZWJ1Z0ZpbGwgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGRlYnVnRmlsbENvbG9yIC0gSWYgZGVidWdGaWxsIGlzIHRydWUgdGhpcyBpcyB0aGUgY29sb3IgdXNlZCB0byBmaWxsIHRoZSB0aWxlcy4gUHJvdmlkZSBpbiBoZXggb3IgcmdiL3JnYmEgc3RyaW5nIGZvcm1hdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmRlYnVnRmlsbENvbG9yID0gJ3JnYmEoMCwgMjU1LCAwLCAwLjIpJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGRlYnVnQ2FsbGJhY2tDb2xvciAtIElmIGRlYnVnIGlzIHRydWUgdGhpcyBpcyB0aGUgY29sb3IgdXNlZCB0byBvdXRsaW5lIHRoZSBlZGdlcyBvZiB0aWxlcyB0aGF0IGhhdmUgY29sbGlzaW9uIGNhbGxiYWNrcy4gUHJvdmlkZSBpbiBoZXggb3IgcmdiL3JnYmEgc3RyaW5nIGZvcm1hdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmRlYnVnQ2FsbGJhY2tDb2xvciA9ICdyZ2JhKDI1NSwgMCwgMCwgMSknOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc2Nyb2xsRmFjdG9yWCAtIHNwZWVkIGF0IHdoaWNoIHRoaXMgbGF5ZXIgc2Nyb2xscwogICAgKiBob3Jpem9udGFsbHksIHJlbGF0aXZlIHRvIHRoZSBjYW1lcmEgKGUuZy4gc2Nyb2xsRmFjdG9yWCBvZiAwLjUgc2Nyb2xscwogICAgKiBoYWxmIGFzIHF1aWNrbHkgYXMgdGhlICdub3JtYWwnIGNhbWVyYS1sb2NrZWQgbGF5ZXJzIGRvKQogICAgKiBAZGVmYXVsdCAxCiAgICAqLwogICAgdGhpcy5zY3JvbGxGYWN0b3JYID0gMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNjcm9sbEZhY3RvclkgLSBzcGVlZCBhdCB3aGljaCB0aGlzIGxheWVyIHNjcm9sbHMKICAgICogdmVydGljYWxseSwgcmVsYXRpdmUgdG8gdGhlIGNhbWVyYSAoZS5nLiBzY3JvbGxGYWN0b3JZIG9mIDAuNSBzY3JvbGxzCiAgICAqIGhhbGYgYXMgcXVpY2tseSBhcyB0aGUgJ25vcm1hbCcgY2FtZXJhLWxvY2tlZCBsYXllcnMgZG8pCiAgICAqIEBkZWZhdWx0IDEKICAgICovCiAgICB0aGlzLnNjcm9sbEZhY3RvclkgPSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRpcnR5IC0gRmxhZyBjb250cm9sbGluZyB3aGVuIHRvIHJlLXJlbmRlciB0aGUgbGF5ZXIuCiAgICAqLwogICAgdGhpcy5kaXJ0eSA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfY3cgLSBMb2NhbCBjb2xsaXNpb24gdmFyLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9jdyA9IHRpbGVtYXAudGlsZVdpZHRoOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2NoIC0gTG9jYWwgY29sbGlzaW9uIHZhci4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fY2ggPSB0aWxlbWFwLnRpbGVIZWlnaHQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZ2EgLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX2dhID0gMTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZHggLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX2R4ID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZHkgLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX2R5ID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZHcgLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX2R3ID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZGggLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX2RoID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdHggLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX3R4ID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdHkgLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX3R5ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF90dyAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fdHcgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3RoIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl90aCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3RsIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl90bCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX21heFggLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX21heFggPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9tYXhZIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9tYXhZID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfc3RhcnRYIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9zdGFydFggPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9zdGFydFkgLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX3N0YXJ0WSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IF9yZXN1bHRzIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9yZXN1bHRzID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfeCAtIFByaXZhdGUgdmFyLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl94ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF95IC0gUHJpdmF0ZSB2YXIuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX3kgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3ByZXZYIC0gUHJpdmF0ZSB2YXIuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX3ByZXZYID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9wcmV2WSAtIFByaXZhdGUgdmFyLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9wcmV2WSA9IDA7CgogICAgdGhpcy51cGRhdGVNYXgoKTsKCn07CgpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUpOwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZSA9IFBoYXNlci5VdGlscy5leHRlbmQodHJ1ZSwgUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUsIFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCBQSVhJLlNwcml0ZS5wcm90b3R5cGUpOwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5UaWxlbWFwTGF5ZXI7CgovKioKKiBBdXRvbWF0aWNhbGx5IGNhbGxlZCBieSBXb3JsZC5wb3N0VXBkYXRlLiBIYW5kbGVzIGNhY2hlIHVwZGF0ZXMuCioKKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwTGF5ZXIjcG9zdFVwZGF0ZQoqIEBtZW1iZXJvZiBQaGFzZXIuVGlsZW1hcExheWVyCiovClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLnBvc3RVcGRhdGUgPSBmdW5jdGlvbiAoKSB7CgoJUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUucG9zdFVwZGF0ZS5jYWxsKHRoaXMpOwoJCiAgICAvLyAgU3RvcHMgeW91IGJlaW5nIGFibGUgdG8gYXV0by1zY3JvbGwgdGhlIGNhbWVyYSBpZiBpdCdzIG5vdCBmb2xsb3dpbmcgYSBzcHJpdGUKICAgIHRoaXMuc2Nyb2xsWCA9IHRoaXMuZ2FtZS5jYW1lcmEueCAqIHRoaXMuc2Nyb2xsRmFjdG9yWDsKICAgIHRoaXMuc2Nyb2xsWSA9IHRoaXMuZ2FtZS5jYW1lcmEueSAqIHRoaXMuc2Nyb2xsRmFjdG9yWTsKCiAgICB0aGlzLnJlbmRlcigpOwoKfQoKLyoqCiogU2V0cyB0aGUgd29ybGQgc2l6ZSB0byBtYXRjaCB0aGUgc2l6ZSBvZiB0aGlzIGxheWVyLgoqCiogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcExheWVyI3Jlc2l6ZVdvcmxkCiogQG1lbWJlcm9mIFBoYXNlci5UaWxlbWFwTGF5ZXIKKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUucmVzaXplV29ybGQgPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5nYW1lLndvcmxkLnNldEJvdW5kcygwLCAwLCB0aGlzLmxheWVyLndpZHRoSW5QaXhlbHMsIHRoaXMubGF5ZXIuaGVpZ2h0SW5QaXhlbHMpOwoKfQoKLyoqCiogVGFrZSBhbiB4IGNvb3JkaW5hdGUgdGhhdCBkb2Vzbid0IGFjY291bnQgZm9yIHNjcm9sbEZhY3RvclggYW5kICdmaXgnIGl0IAoqIGludG8gYSBzY3JvbGxlZCBsb2NhbCBzcGFjZS4gVXNlZCBwcmltYXJpbHkgaW50ZXJuYWxseQoqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXBMYXllciNfZml4WAoqIEBtZW1iZXJvZiBQaGFzZXIuVGlsZW1hcExheWVyCiogQHByaXZhdGUKKiBAcGFyYW0ge251bWJlcn0geCAtIHggY29vcmRpbmF0ZSBpbiBjYW1lcmEgc3BhY2UKKiBAcmV0dXJuIHtudW1iZXJ9IHggY29vcmRpbmF0ZSBpbiBzY3JvbGxGYWN0b3ItYWRqdXN0ZWQgZGltZW5zaW9ucwoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5fZml4WCA9IGZ1bmN0aW9uKHgpIHsKCiAgICBpZiAoeCA8IDApCiAgICB7CiAgICAgICAgeCA9IDA7CiAgICB9CgogICAgaWYgKHRoaXMuc2Nyb2xsRmFjdG9yWCA9PT0gMSkKICAgIHsKICAgICAgICByZXR1cm4geDsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5feCArICh4IC0gKHRoaXMuX3ggLyB0aGlzLnNjcm9sbEZhY3RvclgpKTsKCn0KCi8qKgoqIFRha2UgYW4geCBjb29yZGluYXRlIHRoYXQgX2RvZXNfIGFjY291bnQgZm9yIHNjcm9sbEZhY3RvclggYW5kICd1bmZpeCcgaXQgCiogYmFjayB0byBjYW1lcmEgc3BhY2UuIFVzZWQgcHJpbWFyaWx5IGludGVybmFsbHkKKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwTGF5ZXIjX3VuZml4WAoqIEBtZW1iZXJvZiBQaGFzZXIuVGlsZW1hcExheWVyCiogQHByaXZhdGUKKiBAcGFyYW0ge251bWJlcn0geCAtIHggY29vcmRpbmF0ZSBpbiBzY3JvbGxGYWN0b3ItYWRqdXN0ZWQgZGltZW5zaW9ucwoqIEByZXR1cm4ge251bWJlcn0geCBjb29yZGluYXRlIGluIGNhbWVyYSBzcGFjZQoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5fdW5maXhYID0gZnVuY3Rpb24oeCkgewoKICAgIGlmICh0aGlzLnNjcm9sbEZhY3RvclggPT09IDEpCiAgICB7CiAgICAgICAgcmV0dXJuIHg7CiAgICB9CgogICAgcmV0dXJuICh0aGlzLl94IC8gdGhpcy5zY3JvbGxGYWN0b3JYKSArICh4IC0gdGhpcy5feCk7Cgp9CgovKioKKiBUYWtlIGEgeSBjb29yZGluYXRlIHRoYXQgZG9lc24ndCBhY2NvdW50IGZvciBzY3JvbGxGYWN0b3JZIGFuZCAnZml4JyBpdCAKKiBpbnRvIGEgc2Nyb2xsZWQgbG9jYWwgc3BhY2UuIFVzZWQgcHJpbWFyaWx5IGludGVybmFsbHkKKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwTGF5ZXIjX2ZpeFkKKiBAbWVtYmVyb2YgUGhhc2VyLlRpbGVtYXBMYXllcgoqIEBwcml2YXRlCiogQHBhcmFtIHtudW1iZXJ9IHkgLSB5IGNvb3JkaW5hdGUgaW4gY2FtZXJhIHNwYWNlCiogQHJldHVybiB7bnVtYmVyfSB5IGNvb3JkaW5hdGUgaW4gc2Nyb2xsRmFjdG9yLWFkanVzdGVkIGRpbWVuc2lvbnMKKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuX2ZpeFkgPSBmdW5jdGlvbih5KSB7CgogICAgaWYgKHkgPCAwKQogICAgewogICAgICAgIHkgPSAwOwogICAgfQoKICAgIGlmICh0aGlzLnNjcm9sbEZhY3RvclkgPT09IDEpCiAgICB7CiAgICAgICAgcmV0dXJuIHk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMuX3kgKyAoeSAtICh0aGlzLl95IC8gdGhpcy5zY3JvbGxGYWN0b3JZKSk7Cgp9CgovKioKKiBUYWtlIGEgeSBjb29yZGluYXRlIHRoYXQgX2RvZXNfIGFjY291bnQgZm9yIHNjcm9sbEZhY3RvclkgYW5kICd1bmZpeCcgaXQgCiogYmFjayB0byBjYW1lcmEgc3BhY2UuIFVzZWQgcHJpbWFyaWx5IGludGVybmFsbHkKKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwTGF5ZXIjX3VuZml4WQoqIEBtZW1iZXJvZiBQaGFzZXIuVGlsZW1hcExheWVyCiogQHByaXZhdGUKKiBAcGFyYW0ge251bWJlcn0geSAtIHkgY29vcmRpbmF0ZSBpbiBzY3JvbGxGYWN0b3ItYWRqdXN0ZWQgZGltZW5zaW9ucwoqIEByZXR1cm4ge251bWJlcn0geSBjb29yZGluYXRlIGluIGNhbWVyYSBzcGFjZQoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5fdW5maXhZID0gZnVuY3Rpb24oeSkgewoKICAgIGlmICh0aGlzLnNjcm9sbEZhY3RvclkgPT09IDEpCiAgICB7CiAgICAgICAgcmV0dXJuIHk7CiAgICB9CgogICAgcmV0dXJuICh0aGlzLl95IC8gdGhpcy5zY3JvbGxGYWN0b3JZKSArICh5IC0gdGhpcy5feSk7Cgp9CgovKioKKiBDb252ZXJ0IGEgcGl4ZWwgdmFsdWUgdG8gYSB0aWxlIGNvb3JkaW5hdGUuCiogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcExheWVyI2dldFRpbGVYCiogQG1lbWJlcm9mIFBoYXNlci5UaWxlbWFwTGF5ZXIKKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIHBvaW50IGluIHRhcmdldCB0aWxlLgoqIEByZXR1cm4ge1BoYXNlci5UaWxlfSBUaGUgdGlsZSB3aXRoIHNwZWNpZmljIHByb3BlcnRpZXMuCiovClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLmdldFRpbGVYID0gZnVuY3Rpb24gKHgpIHsKCiAgICAvLyB2YXIgdGlsZVdpZHRoID0gdGhpcy50aWxlV2lkdGggKiB0aGlzLnNjYWxlLng7CgogICAgcmV0dXJuIHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHRoaXMuX2ZpeFgoeCksIHRoaXMubWFwLnRpbGVXaWR0aCkgLyB0aGlzLm1hcC50aWxlV2lkdGg7Cgp9CgovKioKKiBDb252ZXJ0IGEgcGl4ZWwgdmFsdWUgdG8gYSB0aWxlIGNvb3JkaW5hdGUuCiogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcExheWVyI2dldFRpbGVZCiogQG1lbWJlcm9mIFBoYXNlci5UaWxlbWFwTGF5ZXIKKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIHBvaW50IGluIHRhcmdldCB0aWxlLgoqIEByZXR1cm4ge1BoYXNlci5UaWxlfSBUaGUgdGlsZSB3aXRoIHNwZWNpZmljIHByb3BlcnRpZXMuCiovClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLmdldFRpbGVZID0gZnVuY3Rpb24gKHkpIHsKCiAgICAvLyB2YXIgdGlsZUhlaWdodCA9IHRoaXMudGlsZUhlaWdodCAqIHRoaXMuc2NhbGUueTsKCiAgICByZXR1cm4gdGhpcy5nYW1lLm1hdGguc25hcFRvRmxvb3IodGhpcy5fZml4WSh5KSwgdGhpcy5tYXAudGlsZUhlaWdodCkgLyB0aGlzLm1hcC50aWxlSGVpZ2h0OwoKfQoKLyoqCiogQ29udmVydCBhIHBpeGVsIHZhbHVlIHRvIGEgdGlsZSBjb29yZGluYXRlLgoqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXBMYXllciNnZXRUaWxlWFkKKiBAbWVtYmVyb2YgUGhhc2VyLlRpbGVtYXBMYXllcgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgcG9pbnQgaW4gdGFyZ2V0IHRpbGUuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBwb2ludCBpbiB0YXJnZXQgdGlsZS4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludHxvYmplY3R9IHBvaW50IC0gVGhlIFBvaW50IG9iamVjdCB0byBzZXQgdGhlIHggYW5kIHkgdmFsdWVzIG9uLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludHxvYmplY3R9IEEgUG9pbnQgb2JqZWN0IHdpdGggaXRzIHggYW5kIHkgcHJvcGVydGllcyBzZXQuCiovClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLmdldFRpbGVYWSA9IGZ1bmN0aW9uICh4LCB5LCBwb2ludCkgewoKICAgIHBvaW50LnggPSB0aGlzLmdldFRpbGVYKHgpOwogICAgcG9pbnQueSA9IHRoaXMuZ2V0VGlsZVkoeSk7CgogICAgcmV0dXJuIHBvaW50OwoKfQoKLyoqCiogR2V0IGFsbCB0aWxlcyB0aGF0IGV4aXN0IHdpdGhpbiB0aGUgZ2l2ZW4gYXJlYSwgZGVmaW5lZCBieSB0aGUgdG9wLWxlZnQgY29ybmVyLCB3aWR0aCBhbmQgaGVpZ2h0LiBWYWx1ZXMgZ2l2ZW4gYXJlIGluIHBpeGVscywgbm90IHRpbGVzLgoqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXBMYXllciNnZXRUaWxlcwoqIEBtZW1iZXJvZiBQaGFzZXIuVGlsZW1hcExheWVyCiogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBjb3JuZXIuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBjb3JuZXIuCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gV2lkdGggb2YgdGhlIGFyZWEgdG8gZ2V0LgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBIZWlnaHQgb2YgdGhlIGFyZWEgdG8gZ2V0LgoqIEBwYXJhbSB7Ym9vbGVhbn0gW2NvbGxpZGVzPWZhbHNlXSAtIElmIHRydWUgb25seSByZXR1cm4gdGlsZXMgdGhhdCBjb2xsaWRlIG9uIG9uZSBvciBtb3JlIGZhY2VzLgoqIEByZXR1cm4ge2FycmF5fSBBcnJheSB3aXRoIHRpbGVzIGluZm9ybWF0aW9ucyAoZWFjaCBjb250YWlucyB4LCB5LCBhbmQgdGhlIHRpbGUpLgoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5nZXRUaWxlcyA9IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBjb2xsaWRlcykgewoKICAgIC8vICBTaG91bGQgd2Ugb25seSBnZXQgdGlsZXMgdGhhdCBoYXZlIGF0IGxlYXN0IG9uZSBvZiB0aGVpciBjb2xsaXNpb24gZmxhZ3Mgc2V0PyAodHJ1ZSA9IHllcywgZmFsc2UgPSBubyBqdXN0IGdldCB0aGVtIGFsbCkKICAgIGlmICh0eXBlb2YgY29sbGlkZXMgPT09ICd1bmRlZmluZWQnKSB7IGNvbGxpZGVzID0gZmFsc2U7IH0KCiAgICAvLyBhZGp1c3QgdGhlIHgseSBjb29yZGluYXRlcyBmb3Igc2Nyb2xsRmFjdG9yCiAgICB4ID0gdGhpcy5fZml4WCh4KTsKICAgIHkgPSB0aGlzLl9maXhZKHkpOwoKICAgIGlmICh3aWR0aCA+IHRoaXMubGF5ZXIud2lkdGhJblBpeGVscykKICAgIHsKICAgICAgICB3aWR0aCA9IHRoaXMubGF5ZXIud2lkdGhJblBpeGVsczsKICAgIH0KCiAgICBpZiAoaGVpZ2h0ID4gdGhpcy5sYXllci5oZWlnaHRJblBpeGVscykKICAgIHsKICAgICAgICBoZWlnaHQgPSB0aGlzLmxheWVyLmhlaWdodEluUGl4ZWxzOwogICAgfQoKICAgIC8vICBDb252ZXJ0IHRoZSBwaXhlbCB2YWx1ZXMgaW50byB0aWxlIGNvb3JkaW5hdGVzCiAgICB0aGlzLl90eCA9IHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHgsIHRoaXMuX2N3KSAvIHRoaXMuX2N3OwogICAgdGhpcy5fdHkgPSB0aGlzLmdhbWUubWF0aC5zbmFwVG9GbG9vcih5LCB0aGlzLl9jaCkgLyB0aGlzLl9jaDsKICAgIHRoaXMuX3R3ID0gKHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0NlaWwod2lkdGgsIHRoaXMuX2N3KSArIHRoaXMuX2N3KSAvIHRoaXMuX2N3OwogICAgdGhpcy5fdGggPSAodGhpcy5nYW1lLm1hdGguc25hcFRvQ2VpbChoZWlnaHQsIHRoaXMuX2NoKSArIHRoaXMuX2NoKSAvIHRoaXMuX2NoOwoKICAgIC8vICBUaGlzIHNob3VsZCBhcHBseSB0aGUgbGF5ZXIgeC95IGhlcmUKICAgIHRoaXMuX3Jlc3VsdHMubGVuZ3RoID0gMDsKCiAgICBmb3IgKHZhciB3eSA9IHRoaXMuX3R5OyB3eSA8IHRoaXMuX3R5ICsgdGhpcy5fdGg7IHd5KyspCiAgICB7CiAgICAgICAgZm9yICh2YXIgd3ggPSB0aGlzLl90eDsgd3ggPCB0aGlzLl90eCArIHRoaXMuX3R3OyB3eCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMubGF5ZXIuZGF0YVt3eV0gJiYgdGhpcy5sYXllci5kYXRhW3d5XVt3eF0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChjb2xsaWRlcyA9PT0gZmFsc2UgfHwgKGNvbGxpZGVzICYmIHRoaXMubGF5ZXIuZGF0YVt3eV1bd3hdLmNhbkNvbGxpZGUpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICBDb252ZXJ0IHRpbGUgY29vcmRpbmF0ZXMgYmFjayB0byBjYW1lcmEgc3BhY2UgZm9yIHJldHVybgogICAgICAgICAgICAgICAgICAgIHZhciBfd3ggPSB0aGlzLl91bmZpeFgod3ggKiB0aGlzLl9jdykgLyB0aGlzLl9jdzsKICAgICAgICAgICAgICAgICAgICB2YXIgX3d5ID0gdGhpcy5fdW5maXhZKHd5ICogdGhpcy5fY2gpIC8gdGhpcy5fY2g7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHMucHVzaCh7IAogICAgICAgICAgICAgICAgICAgICAgICB4OiBfd3ggKiB0aGlzLl9jdywgCiAgICAgICAgICAgICAgICAgICAgICAgIHk6IF93eSAqIHRoaXMuX2NoLCAKICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHQ6IChfd3ggKiB0aGlzLl9jdykgKyB0aGlzLl9jdywgCiAgICAgICAgICAgICAgICAgICAgICAgIGJvdHRvbTogKF93eSAqIHRoaXMuX2NoKSArIHRoaXMuX2NoLCAKICAgICAgICAgICAgICAgICAgICAgICAgdGlsZTogdGhpcy5sYXllci5kYXRhW3d5XVt3eF0sCiAgICAgICAgICAgICAgICAgICAgICAgIGxheWVyOiB0aGlzLmxheWVyLmRhdGFbd3ldW3d4XS5sYXllcgogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzLl9yZXN1bHRzOwoKfQoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gdG8gdXBkYXRlIG1heGltdW0gdmFsdWVzLgoqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXBMYXllciN1cGRhdGVNYXgKKiBAbWVtYmVyb2YgUGhhc2VyLlRpbGVtYXBMYXllcgoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS51cGRhdGVNYXggPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5fbWF4WCA9IHRoaXMuZ2FtZS5tYXRoLmNlaWwodGhpcy5jYW52YXMud2lkdGggLyB0aGlzLm1hcC50aWxlV2lkdGgpICsgMTsKICAgIHRoaXMuX21heFkgPSB0aGlzLmdhbWUubWF0aC5jZWlsKHRoaXMuY2FudmFzLmhlaWdodCAvIHRoaXMubWFwLnRpbGVIZWlnaHQpICsgMTsKCiAgICBpZiAodGhpcy5sYXllcikKICAgIHsKICAgICAgICBpZiAodGhpcy5fbWF4WCA+IHRoaXMubGF5ZXIud2lkdGgpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9tYXhYID0gdGhpcy5sYXllci53aWR0aDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9tYXhZID4gdGhpcy5sYXllci5oZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9tYXhZID0gdGhpcy5sYXllci5oZWlnaHQ7CiAgICAgICAgfQogICAgfQoKICAgIHRoaXMuZGlydHkgPSB0cnVlOwoKfQoKLyoqCiogUmVuZGVycyB0aGUgdGlsZXMgdG8gdGhlIGxheWVyIGNhbnZhcyBhbmQgcHVzaGVzIHRvIHRoZSBkaXNwbGF5LgoqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXBMYXllciNyZW5kZXIKKiBAbWVtYmVyb2YgUGhhc2VyLlRpbGVtYXBMYXllcgoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7CgoJaWYgKHRoaXMubGF5ZXIuZGlydHkpCiAgICB7CiAgICAgICAgdGhpcy5kaXJ0eSA9IHRydWU7CiAgICB9CgogICAgaWYgKCF0aGlzLmRpcnR5IHx8ICF0aGlzLnZpc2libGUpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMuX3ByZXZYID0gdGhpcy5fZHg7CiAgICB0aGlzLl9wcmV2WSA9IHRoaXMuX2R5OwoKICAgIHRoaXMuX2R4ID0gLSh0aGlzLl94IC0gKHRoaXMuX3N0YXJ0WCAqIHRoaXMubWFwLnRpbGVXaWR0aCkpOwogICAgdGhpcy5fZHkgPSAtKHRoaXMuX3kgLSAodGhpcy5fc3RhcnRZICogdGhpcy5tYXAudGlsZUhlaWdodCkpOwoKICAgIHRoaXMuX3R4ID0gdGhpcy5fZHg7CiAgICB0aGlzLl90eSA9IHRoaXMuX2R5OwoKICAgIHRoaXMuY29udGV4dC5jbGVhclJlY3QoMCwgMCwgdGhpcy5jYW52YXMud2lkdGgsIHRoaXMuY2FudmFzLmhlaWdodCk7CgogICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IHRoaXMudGlsZUNvbG9yOwoKICAgIHZhciB0aWxlOwogICAgdmFyIHNldDsKICAgIHZhciBveCA9IDA7CiAgICB2YXIgb3kgPSAwOwoKICAgIGlmICh0aGlzLmRlYnVnKQogICAgewogICAgICAgIHRoaXMuY29udGV4dC5nbG9iYWxBbHBoYSA9IHRoaXMuZGVidWdBbHBoYTsKICAgIH0KCiAgICBmb3IgKHZhciB5ID0gdGhpcy5fc3RhcnRZLCBsZW5ZID0gdGhpcy5fc3RhcnRZICsgdGhpcy5fbWF4WTsgeSA8IGxlblk7IHkrKykKICAgIHsKICAgICAgICB0aGlzLl9jb2x1bW4gPSB0aGlzLmxheWVyLmRhdGFbeV07CgogICAgICAgIGZvciAodmFyIHggPSB0aGlzLl9zdGFydFgsIGxlblggPSB0aGlzLl9zdGFydFggKyB0aGlzLl9tYXhYOyB4IDwgbGVuWDsgeCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2NvbHVtblt4XSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGlsZSA9IHRoaXMuX2NvbHVtblt4XTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5tYXAudGlsZXNbdGlsZS5pbmRleF0pCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc2V0ID0gdGhpcy5tYXAudGlsZXNldHNbdGhpcy5tYXAudGlsZXNbdGlsZS5pbmRleF1bMl1dCgogICAgICAgICAgICAgICAgICAgIGlmIChzZXQuaW1hZ2UpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWJ1ZyA9PT0gZmFsc2UgJiYgdGlsZS5hbHBoYSAhPT0gdGhpcy5jb250ZXh0Lmdsb2JhbEFscGhhKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZ2xvYmFsQWxwaGEgPSB0aWxlLmFscGhhOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2V0LnRpbGVXaWR0aCAhPT0gdGhpcy5tYXAudGlsZVdpZHRoIHx8IHNldC50aWxlSGVpZ2h0ICE9PSB0aGlzLm1hcC50aWxlSGVpZ2h0KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgVE9ETzogU21hbGxlciBzaXplZCB0aWxlIGNoZWNrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZHJhd0ltYWdlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFwLnRpbGVzZXRzW3RoaXMubWFwLnRpbGVzW3RpbGUuaW5kZXhdWzJdXS5pbWFnZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcC50aWxlc1t0aWxlLmluZGV4XVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcC50aWxlc1t0aWxlLmluZGV4XVsxXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXQudGlsZVdpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldC50aWxlSGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguZmxvb3IodGhpcy5fdHgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguZmxvb3IodGhpcy5fdHkpIC0gKHNldC50aWxlSGVpZ2h0IC0gdGhpcy5tYXAudGlsZUhlaWdodCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0LnRpbGVXaWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXQudGlsZUhlaWdodAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5kcmF3SW1hZ2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXAudGlsZXNldHNbdGhpcy5tYXAudGlsZXNbdGlsZS5pbmRleF1bMl1dLmltYWdlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFwLnRpbGVzW3RpbGUuaW5kZXhdWzBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFwLnRpbGVzW3RpbGUuaW5kZXhdWzFdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFwLnRpbGVXaWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcC50aWxlSGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguZmxvb3IodGhpcy5fdHgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguZmxvb3IodGhpcy5fdHkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFwLnRpbGVXaWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcC50aWxlSGVpZ2h0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGlsZS5kZWJ1ZykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9ICdyZ2JhKDAsIDI1NSwgMCwgMC40KSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFJlY3QoTWF0aC5mbG9vcih0aGlzLl90eCksIE1hdGguZmxvb3IodGhpcy5fdHkpLCB0aGlzLm1hcC50aWxlV2lkdGgsIHRoaXMubWFwLnRpbGVIZWlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsUmVjdChNYXRoLmZsb29yKHRoaXMuX3R4KSwgTWF0aC5mbG9vcih0aGlzLl90eSksIHRoaXMubWFwLnRpbGVXaWR0aCwgdGhpcy5tYXAudGlsZUhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl90eCArPSB0aGlzLm1hcC50aWxlV2lkdGg7CgogICAgICAgIH0KCiAgICAgICAgdGhpcy5fdHggPSB0aGlzLl9keDsKICAgICAgICB0aGlzLl90eSArPSB0aGlzLm1hcC50aWxlSGVpZ2h0OwoKICAgIH0KCiAgICBpZiAodGhpcy5kZWJ1ZykKICAgIHsKICAgICAgICB0aGlzLmNvbnRleHQuZ2xvYmFsQWxwaGEgPSAxOwogICAgICAgIHRoaXMucmVuZGVyRGVidWcoKTsKICAgIH0KCiAgICAvLyAgT25seSBuZWVkZWQgaWYgcnVubmluZyBpbiBXZWJHTCwgb3RoZXJ3aXNlIHRoaXMgYXJyYXkgd2lsbCBuZXZlciBnZXQgY2xlYXJlZCBkb3duIEkgZG9uJ3QgdGhpbmshCiAgICBpZiAodGhpcy5nYW1lLnJlbmRlclR5cGUgPT09IFBoYXNlci5XRUJHTCkKICAgIHsKICAgICAgICBQSVhJLnRleHR1cmVzVG9VcGRhdGUucHVzaCh0aGlzLmJhc2VUZXh0dXJlKTsKICAgIH0KCiAgICB0aGlzLmRpcnR5ID0gZmFsc2U7CiAgICB0aGlzLmxheWVyLmRpcnR5ID0gZmFsc2U7CgogICAgcmV0dXJuIHRydWU7Cgp9CgovKioKKiBSZW5kZXJzIGEgY29sbGlzaW9uIGRlYnVnIG92ZXJsYXkgb24tdG9wIG9mIHRoZSBjYW52YXMuIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IHJlbmRlciB3aGVuIGRlYnVnID0gdHJ1ZS4KKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwTGF5ZXIjcmVuZGVyRGVidWcKKiBAbWVtYmVyb2YgUGhhc2VyLlRpbGVtYXBMYXllcgoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5yZW5kZXJEZWJ1ZyA9IGZ1bmN0aW9uICgpIHsKCiAgICB0aGlzLl90eCA9IHRoaXMuX2R4OwogICAgdGhpcy5fdHkgPSB0aGlzLl9keTsKCiAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSB0aGlzLmRlYnVnQ29sb3I7CiAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gdGhpcy5kZWJ1Z0ZpbGxDb2xvcjsKCiAgICBmb3IgKHZhciB5ID0gdGhpcy5fc3RhcnRZLCBsZW5ZID0gdGhpcy5fc3RhcnRZICsgdGhpcy5fbWF4WTsgeSA8IGxlblk7IHkrKykKICAgIHsKICAgICAgICB0aGlzLl9jb2x1bW4gPSB0aGlzLmxheWVyLmRhdGFbeV07CgogICAgICAgIGZvciAodmFyIHggPSB0aGlzLl9zdGFydFgsIGxlblggPSB0aGlzLl9zdGFydFggKyB0aGlzLl9tYXhYOyB4IDwgbGVuWDsgeCsrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHRpbGUgPSB0aGlzLl9jb2x1bW5beF07CgogICAgICAgICAgICBpZiAodGlsZSAmJiAodGlsZS5mYWNlVG9wIHx8IHRpbGUuZmFjZUJvdHRvbSB8fCB0aWxlLmZhY2VMZWZ0IHx8IHRpbGUuZmFjZVJpZ2h0KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fdHggPSBNYXRoLmZsb29yKHRoaXMuX3R4KTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWJ1Z0ZpbGwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHRoaXMuX3R4LCB0aGlzLl90eSwgdGhpcy5fY3csIHRoaXMuX2NoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CgogICAgICAgICAgICAgICAgaWYgKHRpbGUuZmFjZVRvcCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQubW92ZVRvKHRoaXMuX3R4LCB0aGlzLl90eSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVUbyh0aGlzLl90eCArIHRoaXMuX2N3LCB0aGlzLl90eSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRpbGUuZmFjZUJvdHRvbSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQubW92ZVRvKHRoaXMuX3R4LCB0aGlzLl90eSArIHRoaXMuX2NoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQubGluZVRvKHRoaXMuX3R4ICsgdGhpcy5fY3csIHRoaXMuX3R5ICsgdGhpcy5fY2gpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aWxlLmZhY2VMZWZ0KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5tb3ZlVG8odGhpcy5fdHgsIHRoaXMuX3R5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQubGluZVRvKHRoaXMuX3R4LCB0aGlzLl90eSArIHRoaXMuX2NoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGlsZS5mYWNlUmlnaHQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0Lm1vdmVUbyh0aGlzLl90eCArIHRoaXMuX2N3LCB0aGlzLl90eSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVUbyh0aGlzLl90eCArIHRoaXMuX2N3LCB0aGlzLl90eSArIHRoaXMuX2NoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBDb2xsaXNpb24gY2FsbGJhY2sKICAgICAgICAgICAgaWYgKHRpbGUgJiYgKHRpbGUuY29sbGlzaW9uQ2FsbGJhY2sgfHwgdGlsZS5sYXllci5jYWxsYmFja3NbdGlsZS5pbmRleF0pKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gdGhpcy5kZWJ1Z0NhbGxiYWNrQ29sb3I7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFJlY3QodGhpcy5fdHgsIHRoaXMuX3R5LCB0aGlzLl9jdywgdGhpcy5fY2gpOwogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IHRoaXMuZGVidWdGaWxsQ29sb3I7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3R4ICs9IHRoaXMubWFwLnRpbGVXaWR0aDsKCiAgICAgICAgfQoKICAgICAgICB0aGlzLl90eCA9IHRoaXMuX2R4OwogICAgICAgIHRoaXMuX3R5ICs9IHRoaXMubWFwLnRpbGVIZWlnaHQ7CgogICAgfQoKfQoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbGVtYXBMYXllciNzY3JvbGxYCiogQHByb3BlcnR5IHtudW1iZXJ9IHNjcm9sbFggLSBTY3JvbGxzIHRoZSBtYXAgaG9yaXpvbnRhbGx5IG9yIHJldHVybnMgdGhlIGN1cnJlbnQgeCBwb3NpdGlvbi4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLCAic2Nyb2xsWCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3g7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIC8vIGlmICh2YWx1ZSAhPT0gdGhpcy5feCAmJiB2YWx1ZSA+PSAwICYmIHRoaXMubGF5ZXIgJiYgdGhpcy5sYXllci53aWR0aEluUGl4ZWxzID4gdGhpcy53aWR0aCkKICAgICAgICBpZiAodmFsdWUgIT09IHRoaXMuX3ggJiYgdmFsdWUgPj0gMCAmJiB0aGlzLmxheWVyLndpZHRoSW5QaXhlbHMgPiB0aGlzLndpZHRoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5feCA9IHZhbHVlOwogICAgCiAgICAgICAgICAgIGlmICh0aGlzLl94ID4gKHRoaXMubGF5ZXIud2lkdGhJblBpeGVscyAtIHRoaXMud2lkdGgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl94ID0gdGhpcy5sYXllci53aWR0aEluUGl4ZWxzIC0gdGhpcy53aWR0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fc3RhcnRYID0gdGhpcy5nYW1lLm1hdGguZmxvb3IodGhpcy5feCAvIHRoaXMubWFwLnRpbGVXaWR0aCk7CgogICAgICAgICAgICBpZiAodGhpcy5fc3RhcnRYIDwgMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhcnRYID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXJ0WCArIHRoaXMuX21heFggPiB0aGlzLmxheWVyLndpZHRoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdGFydFggPSB0aGlzLmxheWVyLndpZHRoIC0gdGhpcy5fbWF4WDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IHRydWU7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbGVtYXBMYXllciNzY3JvbGxZCiogQHByb3BlcnR5IHtudW1iZXJ9IHNjcm9sbFkgLSBTY3JvbGxzIHRoZSBtYXAgdmVydGljYWxseSBvciByZXR1cm5zIHRoZSBjdXJyZW50IHkgcG9zaXRpb24uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZSwgInNjcm9sbFkiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl95OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICAvLyBpZiAodmFsdWUgIT09IHRoaXMuX3kgJiYgdmFsdWUgPj0gMCAmJiB0aGlzLmxheWVyICYmIHRoaXMuaGVpZ2h0SW5QaXhlbHMgPiB0aGlzLnJlbmRlckhlaWdodCkKICAgICAgICBpZiAodmFsdWUgIT09IHRoaXMuX3kgJiYgdmFsdWUgPj0gMCAmJiB0aGlzLmxheWVyLmhlaWdodEluUGl4ZWxzID4gdGhpcy5oZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl95ID0gdmFsdWU7CgogICAgICAgICAgICBpZiAodGhpcy5feSA+ICh0aGlzLmxheWVyLmhlaWdodEluUGl4ZWxzIC0gdGhpcy5oZWlnaHQpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl95ID0gdGhpcy5sYXllci5oZWlnaHRJblBpeGVscyAtIHRoaXMuaGVpZ2h0OwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9zdGFydFkgPSB0aGlzLmdhbWUubWF0aC5mbG9vcih0aGlzLl95IC8gdGhpcy5tYXAudGlsZUhlaWdodCk7CgogICAgICAgICAgICBpZiAodGhpcy5fc3RhcnRZIDwgMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhcnRZID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXJ0WSArIHRoaXMuX21heFkgPiB0aGlzLmxheWVyLmhlaWdodCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhcnRZID0gdGhpcy5sYXllci5oZWlnaHQgLSB0aGlzLl9tYXhZOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuVGlsZW1hcExheWVyI2NvbGxpc2lvbldpZHRoCiogQHByb3BlcnR5IHtudW1iZXJ9IGNvbGxpc2lvbldpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBjb2xsaXNpb24gdGlsZXMuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZSwgImNvbGxpc2lvbldpZHRoIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY3c7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHRoaXMuX2N3ID0gdmFsdWU7CgogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwoKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbGVtYXBMYXllciNjb2xsaXNpb25IZWlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gY29sbGlzaW9uSGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgY29sbGlzaW9uIHRpbGVzLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUsICJjb2xsaXNpb25IZWlnaHQiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jaDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdGhpcy5fY2ggPSB2YWx1ZTsKCiAgICAgICAgdGhpcy5kaXJ0eSA9IHRydWU7CgogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxNCBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIuVGlsZW1hcFBhcnNlciBwYXJzZXMgZGF0YSBvYmplY3RzIGZyb20gUGhhc2VyLkxvYWRlciB0aGF0IG5lZWQgbW9yZSBwcmVwYXJhdGlvbiBiZWZvcmUgdGhleSBjYW4gYmUgaW5zZXJ0ZWQgaW50byBhIFRpbGVtYXAuCioKKiBAY2xhc3MgUGhhc2VyLlRpbGVtYXBQYXJzZXIKKi8KUGhhc2VyLlRpbGVtYXBQYXJzZXIgPSB7CgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBUaWxlc2V0IG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcFBhcnNlci50aWxlc2V0CiAgICAqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBHYW1lIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBDYWNoZSBrZXkgb2YgdGhpcyB0aWxlc2V0LgogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZVdpZHRoIC0gV2lkdGggb2YgZWFjaCBzaW5nbGUgdGlsZSBpbiBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlSGVpZ2h0IC0gSGVpZ2h0IG9mIGVhY2ggc2luZ2xlIHRpbGUgaW4gcGl4ZWxzLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbGVNYXJnaW49MF0gLSBJZiB0aGUgdGlsZXMgaGF2ZSBiZWVuIGRyYXduIHdpdGggYSBtYXJnaW4sIHNwZWNpZnkgdGhlIGFtb3VudCBoZXJlLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbGVTcGFjaW5nPTBdIC0gSWYgdGhlIHRpbGVzIGhhdmUgYmVlbiBkcmF3biB3aXRoIHNwYWNpbmcgYmV0d2VlbiB0aGVtLCBzcGVjaWZ5IHRoZSBhbW91bnQgaGVyZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtyb3dzPS0xXSAtIEhvdyBtYW55IHRpbGVzIGFyZSBwbGFjZWQgaG9yaXpvbnRhbGx5IGluIGVhY2ggcm93PyBJZiAtMSBpdCB3aWxsIGNhbGN1bGF0ZSByb3dzIGJ5IGRpdmlkaW5nIHRoZSBpbWFnZSB3aWR0aCBieSB0aWxlV2lkdGguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbY29sdW1ucz0tMV0gLSBIb3cgbWFueSB0aWxlcyBhcmUgcGxhY2VkIHZlcnRpY2FsbHkgaW4gZWFjaCBjb2x1bW4/IElmIC0xIGl0IHdpbGwgY2FsY3VsYXRlIGNvbHVtbnMgYnkgZGl2aWRpbmcgdGhlIGltYWdlIGhlaWdodCBieSB0aWxlSGVpZ2h0LgogICAgKiBAcGFyYW0ge251bWJlcn0gW3RvdGFsPS0xXSAtIFRoZSBtYXhpbXVtIG51bWJlciBvZiB0aWxlcyB0byBleHRyYWN0IGZyb20gdGhlIGltYWdlLiBJZiAtMSBpdCB3aWxsIGV4dHJhY3QgYHJvd3MgKiBjb2x1bW5zYCB3b3J0aC4gWW91IGNhbiBhbHNvIHNldCBhIHZhbHVlIGxvd2VyIHRoYW4gdGhlIGFjdHVhbCBudW1iZXIgb2YgdGlsZXMuCiAgICAqIEByZXR1cm4ge1BoYXNlci5UaWxlc2V0fSBHZW5lcmF0ZWQgVGlsZXNldCBvYmplY3QuCiAgICAqLwogICAgdGlsZXNldDogZnVuY3Rpb24gKGdhbWUsIGtleSwgdGlsZVdpZHRoLCB0aWxlSGVpZ2h0LCB0aWxlTWFyZ2luLCB0aWxlU3BhY2luZywgcm93cywgY29sdW1ucywgdG90YWwpIHsKCiAgICAgICAgLy8gIEhvdyBiaWcgaXMgb3VyIGltYWdlPwogICAgICAgIHZhciBpbWcgPSBnYW1lLmNhY2hlLmdldFRpbGVzZXRJbWFnZShrZXkpOwoKICAgICAgICBpZiAoaW1nID09PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJQaGFzZXIuVGlsZW1hcFBhcnNlci50aWxlU2V0OiBJbnZhbGlkIGltYWdlIGtleSBnaXZlbiIpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHZhciB3aWR0aCA9IGltZy53aWR0aDsKICAgICAgICB2YXIgaGVpZ2h0ID0gaW1nLmhlaWdodDsKCiAgICAgICAgaWYgKHJvd3MgPT09IC0xKQogICAgICAgIHsKICAgICAgICAgICAgcm93cyA9IE1hdGgucm91bmQod2lkdGggLyB0aWxlV2lkdGgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbHVtbnMgPT09IC0xKQogICAgICAgIHsKICAgICAgICAgICAgY29sdW1ucyA9IE1hdGgucm91bmQoaGVpZ2h0IC8gdGlsZUhlaWdodCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodG90YWwgPT09IC0xKQogICAgICAgIHsKICAgICAgICAgICAgdG90YWwgPSByb3dzICogY29sdW1uczsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gIFplcm8gb3Igc21hbGxlciB0aGFuIHRpbGUgc2l6ZXM/CiAgICAgICAgaWYgKHdpZHRoID09PSAwIHx8IGhlaWdodCA9PT0gMCB8fCB3aWR0aCA8IHRpbGVXaWR0aCB8fCBoZWlnaHQgPCB0aWxlSGVpZ2h0IHx8IHRvdGFsID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJQaGFzZXIuVGlsZW1hcFBhcnNlci50aWxlU2V0OiB3aWR0aC9oZWlnaHQgemVybyBvciB3aWR0aC9oZWlnaHQgPCBnaXZlbiB0aWxlV2lkdGgvdGlsZUhlaWdodCIpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBuZXcgUGhhc2VyLlRpbGVzZXQoaW1nLCBrZXksIHRpbGVXaWR0aCwgdGlsZUhlaWdodCwgdGlsZU1hcmdpbiwgdGlsZVNwYWNpbmcsIHJvd3MsIGNvbHVtbnMsIHRvdGFsKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXJzZSB0aWxlc2V0IGRhdGEgZnJvbSB0aGUgY2FjaGUgYW5kIGNyZWF0ZXMgYSBUaWxlc2V0IG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcFBhcnNlci5wYXJzZQogICAgKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gR2FtZSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUga2V5IG9mIHRoZSB0aWxlbWFwIGluIHRoZSBDYWNoZS4KICAgICogQHJldHVybiB7b2JqZWN0fSBUaGUgcGFyc2VkIG1hcCBvYmplY3QuCiAgICAqLwogICAgcGFyc2U6IGZ1bmN0aW9uIChnYW1lLCBrZXkpIHsKCiAgICAgICAgdmFyIG1hcCA9IGdhbWUuY2FjaGUuZ2V0VGlsZW1hcERhdGEoa2V5KTsKCiAgICAgICAgaWYgKG1hcCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChtYXAuZm9ybWF0ID09PSBQaGFzZXIuVGlsZW1hcC5DU1YpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnNlQ1NWKG1hcC5kYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChtYXAuZm9ybWF0ID09PSBQaGFzZXIuVGlsZW1hcC5USUxFRF9KU09OKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZVRpbGVkSlNPTihtYXAuZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHsgbGF5ZXJzOiBbXSwgb2JqZWN0czogW10sIGltYWdlczogW10sIHRpbGVzZXRzOiBbXSB9OwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXJzZXMgYSBDU1YgZmlsZSBpbnRvIHZhbGlkIG1hcCBkYXRhLgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwUGFyc2VyLnBhcnNlQ1NWCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhIC0gVGhlIENTViBmaWxlIGRhdGEuCiAgICAqIEByZXR1cm4ge29iamVjdH0gR2VuZXJhdGVkIG1hcCBkYXRhLgogICAgKi8KICAgIHBhcnNlQ1NWOiBmdW5jdGlvbiAoZGF0YSkgewoKICAgICAgICAvLyAgVHJpbSBhbnkgcm9ndWUgd2hpdGVzcGFjZSBmcm9tIHRoZSBkYXRhCiAgICAgICAgZGF0YSA9IGRhdGEudHJpbSgpOwoKICAgICAgICB2YXIgb3V0cHV0ID0gW107CiAgICAgICAgdmFyIHJvd3MgPSBkYXRhLnNwbGl0KCJcbiIpOwogICAgICAgIHZhciBoZWlnaHQgPSByb3dzLmxlbmd0aDsKICAgICAgICB2YXIgd2lkdGggPSAwOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvd3MubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBvdXRwdXRbaV0gPSBbXTsKCiAgICAgICAgICAgIHZhciBjb2x1bW4gPSByb3dzW2ldLnNwbGl0KCIsIik7CgogICAgICAgICAgICBmb3IgKHZhciBjID0gMDsgYyA8IGNvbHVtbi5sZW5ndGg7IGMrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3V0cHV0W2ldW2NdID0gcGFyc2VJbnQoY29sdW1uW2NdLCAxMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3aWR0aCA9PT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2lkdGggPSBjb2x1bW4ubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyAgQnVpbGQgY29sbGlzaW9uIG1hcAoKICAgICAgICByZXR1cm4gW3sgbmFtZTogJ2NzdicsIHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQsIGFscGhhOiAxLCB2aXNpYmxlOiB0cnVlLCBpbmRleGVzOiBbXSwgdGlsZU1hcmdpbjogMCwgdGlsZVNwYWNpbmc6IDAsIGRhdGE6IG91dHB1dCB9XTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXJzZXMgYSBUaWxlZCBKU09OIGZpbGUgaW50byB2YWxpZCBtYXAgZGF0YS4KICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcFBhcnNlci5wYXJzZUpTT04KICAgICogQHBhcmFtIHtvYmplY3R9IGpzb24gLSBUaGUgSlNPTiBtYXAgZGF0YS4KICAgICogQHJldHVybiB7b2JqZWN0fSBHZW5lcmF0ZWQgYW5kIHBhcnNlZCBtYXAgZGF0YS4KICAgICovCiAgICBwYXJzZVRpbGVkSlNPTjogZnVuY3Rpb24gKGpzb24pIHsKCiAgICAgICAgaWYgKGpzb24ub3JpZW50YXRpb24gIT09ICdvcnRob2dvbmFsJykKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybignVGlsZW1hcFBhcnNlci5wYXJzZVRpbGVkSlNPTjogT25seSBvcnRob2dvbmFsIG1hcCB0eXBlcyBhcmUgc3VwcG9ydGVkIGluIHRoaXMgdmVyc2lvbiBvZiBQaGFzZXInKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyAgTWFwIGRhdGEgd2lsbCBjb25zaXN0IG9mOiBsYXllcnMsIG9iamVjdHMsIGltYWdlcywgdGlsZXNldHMsIHNpemVzCiAgICAgICAgdmFyIG1hcCA9IHt9OwoKICAgICAgICBtYXAud2lkdGggPSBqc29uLndpZHRoOwogICAgICAgIG1hcC5oZWlnaHQgPSBqc29uLmhlaWdodDsKICAgICAgICBtYXAudGlsZVdpZHRoID0ganNvbi50aWxld2lkdGg7CiAgICAgICAgbWFwLnRpbGVIZWlnaHQgPSBqc29uLnRpbGVoZWlnaHQ7CiAgICAgICAgbWFwLm9yaWVudGF0aW9uID0ganNvbi5vcmllbnRhdGlvbjsKICAgICAgICBtYXAudmVyc2lvbiA9IGpzb24udmVyc2lvbjsKICAgICAgICBtYXAucHJvcGVydGllcyA9IGpzb24ucHJvcGVydGllczsKICAgICAgICBtYXAud2lkdGhJblBpeGVscyA9IG1hcC53aWR0aCAqIG1hcC50aWxlV2lkdGg7CiAgICAgICAgbWFwLmhlaWdodEluUGl4ZWxzID0gbWFwLmhlaWdodCAqIG1hcC50aWxlSGVpZ2h0OwoKICAgICAgICAvLyAgVGlsZSBMYXllcnMKICAgICAgICB2YXIgbGF5ZXJzID0gW107CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwganNvbi5sYXllcnMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAoanNvbi5sYXllcnNbaV0udHlwZSAhPT0gJ3RpbGVsYXllcicpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbGF5ZXIgPSB7CgogICAgICAgICAgICAgICAgbmFtZToganNvbi5sYXllcnNbaV0ubmFtZSwKICAgICAgICAgICAgICAgIHg6IGpzb24ubGF5ZXJzW2ldLngsCiAgICAgICAgICAgICAgICB5OiBqc29uLmxheWVyc1tpXS55LAogICAgICAgICAgICAgICAgd2lkdGg6IGpzb24ubGF5ZXJzW2ldLndpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBqc29uLmxheWVyc1tpXS5oZWlnaHQsCiAgICAgICAgICAgICAgICB3aWR0aEluUGl4ZWxzOiBqc29uLmxheWVyc1tpXS53aWR0aCAqIGpzb24udGlsZXdpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0SW5QaXhlbHM6IGpzb24ubGF5ZXJzW2ldLmhlaWdodCAqIGpzb24udGlsZWhlaWdodCwKICAgICAgICAgICAgICAgIGFscGhhOiBqc29uLmxheWVyc1tpXS5vcGFjaXR5LAogICAgICAgICAgICAgICAgdmlzaWJsZToganNvbi5sYXllcnNbaV0udmlzaWJsZSwKICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHt9LAogICAgICAgICAgICAgICAgaW5kZXhlczogW10sCiAgICAgICAgICAgICAgICBjYWxsYmFja3M6IFtdCgogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGpzb24ubGF5ZXJzW2ldLnByb3BlcnRpZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxheWVyLnByb3BlcnRpZXMgPSBqc29uLmxheWVyc1tpXS5wcm9wZXJ0aWVzOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgeCA9IDA7CiAgICAgICAgICAgIHZhciByb3cgPSBbXTsKICAgICAgICAgICAgdmFyIG91dHB1dCA9IFtdOwoKICAgICAgICAgICAgLy8gIExvb3AgdGhyb3VnaCB0aGUgZGF0YSBmaWVsZCBpbiB0aGUgSlNPTi4KCiAgICAgICAgICAgIC8vICBUaGlzIGlzIGFuIGFycmF5IGNvbnRhaW5pbmcgdGhlIHRpbGUgaW5kZXhlcywgb25lIGFmdGVyIHRoZSBvdGhlci4gMCA9IG5vIHRpbGUsIGV2ZXJ5dGhpbmcgZWxzZSA9IHRoZSB0aWxlIGluZGV4IChzdGFydGluZyBhdCAxKQogICAgICAgICAgICAvLyAgSWYgdGhlIG1hcCBjb250YWlucyBtdWx0aXBsZSB0aWxlc2V0cyB0aGVuIHRoZSBpbmRleGVzIGFyZSByZWxhdGl2ZSB0byB0aGF0IHdoaWNoIHRoZSBzZXQgc3RhcnRzIGZyb20uCiAgICAgICAgICAgIC8vICBOZWVkIHRvIHNldCB3aGljaCB0aWxlc2V0IGluIHRoZSBjYWNoZSA9IHdoaWNoIHRpbGVzZXQgaW4gdGhlIEpTT04sIGlmIHlvdSBkbyB0aGlzIG1hbnVhbGx5IGl0IG1lYW5zIHlvdSBjYW4gdXNlIHRoZSBzYW1lIG1hcCBkYXRhIGJ1dCBhIG5ldyB0aWxlc2V0LgoKICAgICAgICAgICAgZm9yICh2YXIgdCA9IDAsIGxlbiA9IGpzb24ubGF5ZXJzW2ldLmRhdGEubGVuZ3RoOyB0IDwgbGVuOyB0KyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBpbmRleCwgeCwgeSwgd2lkdGgsIGhlaWdodAogICAgICAgICAgICAgICAgaWYgKGpzb24ubGF5ZXJzW2ldLmRhdGFbdF0gPiAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJvdy5wdXNoKG5ldyBQaGFzZXIuVGlsZShsYXllciwganNvbi5sYXllcnNbaV0uZGF0YVt0XSwgeCwgb3V0cHV0Lmxlbmd0aCwganNvbi50aWxld2lkdGgsIGpzb24udGlsZWhlaWdodCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJvdy5wdXNoKG51bGwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHgrKzsKCiAgICAgICAgICAgICAgICBpZiAoeCA9PT0ganNvbi5sYXllcnNbaV0ud2lkdGgpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0LnB1c2gocm93KTsKICAgICAgICAgICAgICAgICAgICB4ID0gMDsKICAgICAgICAgICAgICAgICAgICByb3cgPSBbXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGF5ZXIuZGF0YSA9IG91dHB1dDsKCiAgICAgICAgICAgIGxheWVycy5wdXNoKGxheWVyKTsKCiAgICAgICAgfQoKICAgICAgICBtYXAubGF5ZXJzID0gbGF5ZXJzOwoKICAgICAgICAvLyAgSW1hZ2VzCiAgICAgICAgdmFyIGltYWdlcyA9IFtdOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGpzb24ubGF5ZXJzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGpzb24ubGF5ZXJzW2ldLnR5cGUgIT09ICdpbWFnZWxheWVyJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBpbWFnZSA9IHsKCiAgICAgICAgICAgICAgICBuYW1lOiBqc29uLmxheWVyc1tpXS5uYW1lLAogICAgICAgICAgICAgICAgaW1hZ2U6IGpzb24ubGF5ZXJzW2ldLmltYWdlLAogICAgICAgICAgICAgICAgeDoganNvbi5sYXllcnNbaV0ueCwKICAgICAgICAgICAgICAgIHk6IGpzb24ubGF5ZXJzW2ldLnksCiAgICAgICAgICAgICAgICBhbHBoYToganNvbi5sYXllcnNbaV0ub3BhY2l0eSwKICAgICAgICAgICAgICAgIHZpc2libGU6IGpzb24ubGF5ZXJzW2ldLnZpc2libGUsCiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7fQoKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChqc29uLmxheWVyc1tpXS5wcm9wZXJ0aWVzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpbWFnZS5wcm9wZXJ0aWVzID0ganNvbi5sYXllcnNbaV0ucHJvcGVydGllczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaW1hZ2VzLnB1c2goaW1hZ2UpOwoKICAgICAgICB9CgogICAgICAgIG1hcC5pbWFnZXMgPSBpbWFnZXM7CgogICAgICAgIC8vICBPYmplY3RzCiAgICAgICAgdmFyIG9iamVjdHMgPSB7fTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBqc29uLmxheWVycy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChqc29uLmxheWVyc1tpXS50eXBlICE9PSAnb2JqZWN0Z3JvdXAnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb2JqZWN0c1tqc29uLmxheWVyc1tpXS5uYW1lXSA9IFtdOwoKICAgICAgICAgICAgZm9yICh2YXIgdiA9IDAsIGxlbiA9IGpzb24ubGF5ZXJzW2ldLm9iamVjdHMubGVuZ3RoOyB2IDwgbGVuOyB2KyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBGb3Igbm93IHdlJ2xsIGp1c3Qgc3VwcG9ydCBvYmplY3QgdGlsZXMKICAgICAgICAgICAgICAgIGlmIChqc29uLmxheWVyc1tpXS5vYmplY3RzW3ZdLmdpZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb2JqZWN0ID0gewoKICAgICAgICAgICAgICAgICAgICAgICAgZ2lkOiBqc29uLmxheWVyc1tpXS5vYmplY3RzW3ZdLmdpZCwKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZToganNvbi5sYXllcnNbaV0ub2JqZWN0c1t2XS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICB4OiBqc29uLmxheWVyc1tpXS5vYmplY3RzW3ZdLngsCiAgICAgICAgICAgICAgICAgICAgICAgIHk6IGpzb24ubGF5ZXJzW2ldLm9iamVjdHNbdl0ueSwKICAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJsZToganNvbi5sYXllcnNbaV0ub2JqZWN0c1t2XS52aXNpYmxlLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiBqc29uLmxheWVyc1tpXS5vYmplY3RzW3ZdLnByb3BlcnRpZXMKCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAKICAgICAgICAgICAgICAgICAgICBvYmplY3RzW2pzb24ubGF5ZXJzW2ldLm5hbWVdLnB1c2gob2JqZWN0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIG1hcC5vYmplY3RzID0gb2JqZWN0czsKCiAgICAgICAgLy8gIFRpbGVzZXRzCiAgICAgICAgdmFyIHRpbGVzZXRzID0gW107CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwganNvbi50aWxlc2V0cy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBuYW1lLCBmaXJzdGdpZCwgd2lkdGgsIGhlaWdodCwgbWFyZ2luLCBzcGFjaW5nLCBwcm9wZXJ0aWVzCiAgICAgICAgICAgIHZhciBzZXQgPSBqc29uLnRpbGVzZXRzW2ldOwogICAgICAgICAgICB2YXIgbmV3U2V0ID0gbmV3IFBoYXNlci5UaWxlc2V0KHNldC5uYW1lLCBzZXQuZmlyc3RnaWQsIHNldC50aWxld2lkdGgsIHNldC50aWxlaGVpZ2h0LCBzZXQubWFyZ2luLCBzZXQuc3BhY2luZywgc2V0LnByb3BlcnRpZXMpOwoKICAgICAgICAgICAgaWYgKHNldC50aWxlcHJvcGVydGllcykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmV3U2V0LnRpbGVQcm9wZXJ0aWVzID0gc2V0LnRpbGVwcm9wZXJ0aWVzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdTZXQucm93cyA9IChzZXQuaW1hZ2VoZWlnaHQgLSBzZXQubWFyZ2luKSAvIChzZXQudGlsZWhlaWdodCArIHNldC5zcGFjaW5nKTsKICAgICAgICAgICAgbmV3U2V0LmNvbHVtbnMgPSAoc2V0LmltYWdld2lkdGggLSBzZXQubWFyZ2luKSAvIChzZXQudGlsZXdpZHRoICsgc2V0LnNwYWNpbmcpOwogICAgICAgICAgICBuZXdTZXQudG90YWwgPSBuZXdTZXQucm93cyAqIG5ld1NldC5jb2x1bW5zOwoKICAgICAgICAgICAgdGlsZXNldHMucHVzaChuZXdTZXQpOwogICAgICAgIH0KCiAgICAgICAgbWFwLnRpbGVzZXRzID0gdGlsZXNldHM7CgogICAgICAgIG1hcC50aWxlcyA9IFtdOwoKICAgICAgICAvLyAgRmluYWxseSBsZXRzIGJ1aWxkIG91ciBzdXBlciB0aWxlc2V0IGluZGV4CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtYXAudGlsZXNldHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB2YXIgc2V0ID0gbWFwLnRpbGVzZXRzW2ldOwogICAgCiAgICAgICAgICAgIHZhciB4ID0gc2V0LnRpbGVNYXJnaW47CiAgICAgICAgICAgIHZhciB5ID0gc2V0LnRpbGVNYXJnaW47CgogICAgICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICAgICB2YXIgY291bnRYID0gMDsKICAgICAgICAgICAgdmFyIGNvdW50WSA9IDA7CgogICAgICAgICAgICBmb3IgKHZhciB0ID0gc2V0LmZpcnN0Z2lkOyB0IDwgc2V0LmZpcnN0Z2lkICsgc2V0LnRvdGFsOyB0KyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBDYW4gYWRkIGV4dHJhIHByb3BlcnRpZXMgaGVyZSBhcyBuZWVkZWQKICAgICAgICAgICAgICAgIG1hcC50aWxlc1t0XSA9IFt4LCB5LCBpXTsKCiAgICAgICAgICAgICAgICB4ICs9IHNldC50aWxlV2lkdGggKyBzZXQudGlsZVNwYWNpbmc7CgogICAgICAgICAgICAgICAgY291bnQrKzsKCiAgICAgICAgICAgICAgICBpZiAoY291bnQgPT09IHNldC50b3RhbCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb3VudFgrKzsKCiAgICAgICAgICAgICAgICBpZiAoY291bnRYID09PSBzZXQuY29sdW1ucykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB4ID0gc2V0LnRpbGVNYXJnaW47CiAgICAgICAgICAgICAgICAgICAgeSArPSBzZXQudGlsZUhlaWdodCArIHNldC50aWxlU3BhY2luZzsKCiAgICAgICAgICAgICAgICAgICAgY291bnRYID0gMDsKICAgICAgICAgICAgICAgICAgICBjb3VudFkrKzsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvdW50WSA9PT0gc2V0LnJvd3MpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbWFwOwoKICAgIH0KCn0KCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDE0IFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgVGlsZSBzZXQgaXMgYSBjb21iaW5hdGlvbiBvZiBhbiBpbWFnZSBjb250YWluaW5nIHRoZSB0aWxlcyBhbmQgY29sbGlzaW9uIGRhdGEgcGVyIHRpbGUuCiogWW91IHNob3VsZCBub3Qgbm9ybWFsbHkgaW5zdGFudGlhdGUgdGhpcyBjbGFzcyBkaXJlY3RseS4KKgoqIEBjbGFzcyBQaGFzZXIuVGlsZXNldAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHRpbGVzZXQgaW4gdGhlIG1hcCBkYXRhLgoqIEBwYXJhbSB7bnVtYmVyfSBmaXJzdGdpZCAtIFRoZSBUaWxlZCBmaXJzdGdpZCB2YWx1ZS4KKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBXaWR0aCBvZiBlYWNoIHRpbGUgaW4gcGl4ZWxzLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBIZWlnaHQgb2YgZWFjaCB0aWxlIGluIHBpeGVscy4KKiBAcGFyYW0ge251bWJlcn0gbWFyZ2luIC0gVGhlIGFtb3VudCBvZiBtYXJnaW4gYXJvdW5kIHRoZSB0aWxlc2hlZXQuCiogQHBhcmFtIHtudW1iZXJ9IHNwYWNpbmcgLSBUaGUgYW1vdW50IG9mIHNwYWNpbmcgYmV0d2VlbiBlYWNoIHRpbGUgaW4gdGhlIHNoZWV0LgoqIEBwYXJhbSB7b2JqZWN0fSBwcm9wZXJ0aWVzIC0gVGlsZXNldCBwcm9wZXJ0aWVzLgoqLwpQaGFzZXIuVGlsZXNldCA9IGZ1bmN0aW9uIChuYW1lLCBmaXJzdGdpZCwgd2lkdGgsIGhlaWdodCwgbWFyZ2luLCBzcGFjaW5nLCBwcm9wZXJ0aWVzKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIFRpbGVzZXQuCiAgICAqLwogICAgdGhpcy5uYW1lID0gbmFtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGZpcnN0Z2lkIC0gVGhlIFRpbGVkIGZpcnN0Z2lkIHZhbHVlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZmlyc3RnaWQgPSBmaXJzdGdpZDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbGVXaWR0aCAtIFRoZSB3aWR0aCBvZiBhIHRpbGUgaW4gcGl4ZWxzLgogICAgKi8KICAgIHRoaXMudGlsZVdpZHRoID0gd2lkdGg7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aWxlSGVpZ2h0IC0gVGhlIGhlaWdodCBvZiBhIHRpbGUgaW4gcGl4ZWxzLgogICAgKi8KICAgIHRoaXMudGlsZUhlaWdodCA9IGhlaWdodDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbGVNYXJnaW4gLSBUaGUgbWFyZ2luIGFyb3VuZCB0aGUgdGlsZXMgaW4gdGhlIHNoZWV0LgogICAgKi8KICAgIHRoaXMudGlsZU1hcmdpbiA9IG1hcmdpbjsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbGVTcGFjaW5nIC0gVGhlIG1hcmdpbiBhcm91bmQgdGhlIHRpbGVzIGluIHRoZSBzaGVldC4KICAgICovCiAgICB0aGlzLnRpbGVTcGFjaW5nID0gc3BhY2luZzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IHByb3BlcnRpZXMgLSBUaWxlc2V0IHNwZWNpZmljIHByb3BlcnRpZXMgKHR5cGljYWxseSBkZWZpbmVkIGluIHRoZSBUaWxlZCBlZGl0b3IpLgogICAgKi8KICAgIHRoaXMucHJvcGVydGllcyA9IHByb3BlcnRpZXM7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSB0aWxlUHByb3BlcnRpZXMgLSBUaWxlIHNwZWNpZmljIHByb3BlcnRpZXMgKHR5cGljYWxseSBkZWZpbmVkIGluIHRoZSBUaWxlZCBlZGl0b3IpLgogICAgKi8KICAgIC8vIHRoaXMudGlsZVByb3BlcnRpZXMgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IGltYWdlIC0gVGhlIGltYWdlIHVzZWQgZm9yIHJlbmRlcmluZy4gVGhpcyBpcyBhIHJlZmVyZW5jZSB0byB0aGUgaW1hZ2Ugc3RvcmVkIGluIFBoYXNlci5DYWNoZS4KICAgICovCiAgICB0aGlzLmltYWdlID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHJvd3MgLSBUaGUgbnVtYmVyIG9mIHJvd3MgaW4gdGhlIHRpbGUgc2hlZXQuCiAgICAqLwogICAgdGhpcy5yb3dzID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGNvbHVtbnMgLSBUaGUgbnVtYmVyIG9mIGNvbHVtbnMgaW4gdGhlIHRpbGUgc2hlZXQuCiAgICAqLwogICAgdGhpcy5jb2x1bW5zID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsIC0gVGhlIHRvdGFsIG51bWJlciBvZiB0aWxlcyBpbiB0aGUgdGlsZXNoZWV0LgogICAgKi8KICAgIHRoaXMudG90YWwgPSAwOwoKfTsKClBoYXNlci5UaWxlc2V0LnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogR2V0cyBhIFRpbGUgZnJvbSB0aGlzIHNldC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZXNldCNnZXRUaWxlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGUgdGlsZSB3aXRoaW4gdGhlIHNldC4KICAgICogQHJldHVybiB7b2JqZWN0fSBUaGUgdGlsZSBvYmplY3QuCiAgICBnZXRUaWxlOiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMudGlsZXNbaW5kZXhdOwoKICAgIH0sCiAgICAqLwoKICAgIC8qKgogICAgKiBHZXRzIGEgVGlsZSBmcm9tIHRoaXMgc2V0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlc2V0I2dldFRpbGVYCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGUgdGlsZSB3aXRoaW4gdGhlIHNldC4KICAgICogQHJldHVybiB7b2JqZWN0fSBUaGUgdGlsZSBvYmplY3QuCiAgICBnZXRUaWxlWDogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgICAgIHJldHVybiB0aGlzLnRpbGVzW2luZGV4XVswXTsKCiAgICB9LAogICAgKi8KCiAgICAvKioKICAgICogR2V0cyBhIFRpbGUgZnJvbSB0aGlzIHNldC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZXNldCNnZXRUaWxlWQogICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhlIHRpbGUgd2l0aGluIHRoZSBzZXQuCiAgICAqIEByZXR1cm4ge29iamVjdH0gVGhlIHRpbGUgb2JqZWN0LgogICAgZ2V0VGlsZVk6IGZ1bmN0aW9uIChpbmRleCkgewoKICAgICAgICByZXR1cm4gdGhpcy50aWxlc1tpbmRleF1bMV07CgogICAgfSwKICAgICovCgogICAgLyoqCiAgICAqIFNldHMgdGlsZSBzcGFjaW5nIGFuZCBtYXJnaW5zLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlc2V0I3NldFNwYWNpbmcKICAgICogQHBhcmFtIHtudW1iZXJ9IFt0aWxlTWFyZ2luXSAtIFRoZSBtYXJnaW4gYXJvdW5kIHRoZSB0aWxlcyBpbiB0aGUgc2hlZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdGlsZVNwYWNpbmddIC0gVGhlIHNwYWNpbmcgYmV0d2VlbiB0aGUgdGlsZXMgaW4gdGhlIHNoZWV0LgogICAgKi8KICAgIHNldFNwYWNpbmc6IGZ1bmN0aW9uIChtYXJnaW4sIHNwYWNpbmcpIHsKCiAgICAgICAgdGhpcy50aWxlTWFyZ2luID0gbWFyZ2luOwogICAgICAgIHRoaXMudGlsZVNwYWNpbmcgPSBzcGFjaW5nOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrcyBpZiB0aGUgdGlsZSBhdCB0aGUgZ2l2ZW4gaW5kZXggZXhpc3RzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5UaWxlc2V0I2NoZWNrVGlsZUluZGV4CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGUgdGlsZSB3aXRoaW4gdGhlIHNldC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBhIHRpbGUgZXhpc3RzIGF0IHRoZSBnaXZlbiBpbmRleCBvdGhlcndpc2UgZmFsc2UuCiAgICBjaGVja1RpbGVJbmRleDogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgICAgIHJldHVybiAodGhpcy50aWxlc1tpbmRleF0pOwoKICAgIH0KICAgICovCgp9OwoKUGhhc2VyLlRpbGVzZXQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlRpbGVzZXQ7CgovKioKKiBXZSdyZSByZXBsYWNpbmcgYSBjb3VwbGUgb2YgUGl4aSdzIG1ldGhvZHMgaGVyZSB0byBmaXggb3IgYWRkIHNvbWUgdml0YWwgZnVuY3Rpb25hbGl0eToKKgoqIDEpIEFkZGVkIHN1cHBvcnQgZm9yIFRyaW1tZWQgc3ByaXRlIHNoZWV0cwoqIDIpIFNraXAgZGlzcGxheSBvYmplY3RzIHdpdGggYW4gYWxwaGEgb2YgemVybwoqIDMpIEF2b2lkIFN0eWxlIFJlY2FsY3VsYXRpb24gZnJvbSB0aGUgaW5jb3JyZWN0IGJnY29sb3IgdmFsdWUKKiA0KSBBZGRlZCBzdXBwb3J0IGZvciBDYW52YXMgdW5pdCByb3VuZGluZyB2aWEgUGhhc2VyLkNBTlZBU19QWF9ST1VORCBib29sZWFuIChkaXNhYmxlZCBieSBkZWZhdWx0KS4KKgoqIEhvcGVmdWxseSB3ZSBjYW4gcmVtb3ZlIHRoaXMgb25jZSBQaXhpIGhhcyBiZWVuIHVwZGF0ZWQgdG8gc3VwcG9ydCB0aGVzZSB0aGluZ3MuCiovCgovKioKICogUmVuZGVycyB0aGUgc3RhZ2UgdG8gaXRzIGNhbnZhcyB2aWV3CiAqCiAqIEBtZXRob2QgcmVuZGVyCiAqIEBwYXJhbSBzdGFnZSB7U3RhZ2V9IHRoZSBTdGFnZSBlbGVtZW50IHRvIGJlIHJlbmRlcmVkCiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihzdGFnZSkKewogICAgUElYSS50ZXh0dXJlc1RvVXBkYXRlLmxlbmd0aCA9IDA7CiAgICBQSVhJLnRleHR1cmVzVG9EZXN0cm95Lmxlbmd0aCA9IDA7CiAgICAKICAgIFBJWEkudmlzaWJsZUNvdW50Kys7CiAgICBzdGFnZS51cGRhdGVUcmFuc2Zvcm0oKTsKCiAgICB0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIDAsIDApOwoKICAgIGlmIChQaGFzZXIuQ0FOVkFTX0NMRUFSX1JFQ1QpCiAgICB7CiAgICAgICAgdGhpcy5jb250ZXh0LmNsZWFyUmVjdCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCkKICAgIH0KCiAgICB0aGlzLnJlbmRlckRpc3BsYXlPYmplY3Qoc3RhZ2UsIGZhbHNlKTsKICAgCiAgICAvLyAgUmVtb3ZlIGZyYW1lIHVwZGF0ZXMKICAgIGlmIChQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzLmxlbmd0aCA+IDApCiAgICB7CiAgICAgICAgUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcy5sZW5ndGggPSAwOwogICAgfQogICAgCn0KCi8vIEBwYXJhbSB7Ym9vbGVhbn0gW3JlbmRlckhpZGRlbj1mYWxzZV0gLSBJZiB0cnVlIGRpc3BsYXlPYmplY3RzIHRoYXQgaGF2ZSB0aGVpciB2aXNpYmxlIHByb3BlcnR5IHNldCB0byBmYWxzZSB3aWxsIHN0aWxsIGJlIHJlbmRlcmVkLgoKUElYSS5DYW52YXNSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyRGlzcGxheU9iamVjdCA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QsIHJlbmRlckhpZGRlbikKewogICAgLy8gT25jZSB0aGUgZGlzcGxheSBvYmplY3QgaGl0cyB0aGlzIHdlIGNhbiBicmVhayB0aGUgbG9vcCAgCiAgICB2YXIgdGVzdE9iamVjdCA9IGRpc3BsYXlPYmplY3QubGFzdC5faU5leHQ7CiAgICBkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5maXJzdDsKICAgIAogICAgZG8KICAgIHsKICAgICAgICBpZiAoIWRpc3BsYXlPYmplY3QudmlzaWJsZSAmJiAhcmVuZGVySGlkZGVuKQogICAgICAgIHsKICAgICAgICAgICAgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QubGFzdC5faU5leHQ7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoIWRpc3BsYXlPYmplY3QucmVuZGVyYWJsZSB8fCBkaXNwbGF5T2JqZWN0LmFscGhhID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuX2lOZXh0OwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5nbG9iYWxBbHBoYSA9IGRpc3BsYXlPYmplY3Qud29ybGRBbHBoYTsKCiAgICAgICAgICAgICAgICBpZiAoUGhhc2VyLkNBTlZBU19QWF9ST1VORCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bM10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzFdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs0XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguZmxvb3IoZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsyXSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bM10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzFdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs0XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW1tZWQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LnRyYW5zZm9ybSgxLCAwLCAwLCAxLCBkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbS54LCBkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbS55KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvL2lmIHNtb290aGluZ0VuYWJsZWQgaXMgc3VwcG9ydGVkIGFuZCB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgc21vb3RoaW5nIHByb3BlcnR5IGZvciB0aGlzIHRleHR1cmUKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNtb290aFByb3BlcnR5ICYmIHRoaXMuc2NhbGVNb2RlICE9PSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuYmFzZVRleHR1cmUuc2NhbGVNb2RlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2NhbGVNb2RlID0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmJhc2VUZXh0dXJlLnNjYWxlTW9kZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHRbdGhpcy5zbW9vdGhQcm9wZXJ0eV0gPSAodGhpcy5zY2FsZU1vZGUgPT09IFBJWEkuQmFzZVRleHR1cmUuU0NBTEVfTU9ERS5MSU5FQVIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmRyYXdJbWFnZSgKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LnRleHR1cmUuYmFzZVRleHR1cmUuc291cmNlLAogICAgICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS54LAogICAgICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS55LAogICAgICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS53aWR0aCwKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUuaGVpZ2h0LAogICAgICAgICAgICAgICAgICAgIE1hdGguZmxvb3IoKGRpc3BsYXlPYmplY3QuYW5jaG9yLngpICogLWRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS53aWR0aCksCiAgICAgICAgICAgICAgICAgICAgTWF0aC5mbG9vcigoZGlzcGxheU9iamVjdC5hbmNob3IueSkgKiAtZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLmhlaWdodCksCiAgICAgICAgICAgICAgICAgICAgZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLndpZHRoLAogICAgICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS5oZWlnaHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlN0cmlwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybShkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzBdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzNdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzFdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzRdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzJdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdKQogICAgICAgICAgICB0aGlzLnJlbmRlclN0cmlwKGRpc3BsYXlPYmplY3QpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5UaWxpbmdTcHJpdGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMF0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bM10sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMV0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNF0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0pCiAgICAgICAgICAgIHRoaXMucmVuZGVyVGlsaW5nU3ByaXRlKGRpc3BsYXlPYmplY3QpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5DdXN0b21SZW5kZXJhYmxlKQogICAgICAgIHsKICAgICAgICAgICAgZGlzcGxheU9iamVjdC5yZW5kZXJDYW52YXModGhpcyk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLkdyYXBoaWNzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybShkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzBdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzNdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzFdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzRdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzJdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdKQogICAgICAgICAgICBQSVhJLkNhbnZhc0dyYXBoaWNzLnJlbmRlckdyYXBoaWNzKGRpc3BsYXlPYmplY3QsIHRoaXMuY29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLkZpbHRlckJsb2NrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc3BsYXlPYmplY3Qub3BlbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LnNhdmUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdmFyIGNhY2hlQWxwaGEgPSBkaXNwbGF5T2JqZWN0Lm1hc2suYWxwaGE7CiAgICAgICAgICAgICAgICB2YXIgbWFza1RyYW5zZm9ybSA9IGRpc3BsYXlPYmplY3QubWFzay53b3JsZFRyYW5zZm9ybTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybShtYXNrVHJhbnNmb3JtWzBdLCBtYXNrVHJhbnNmb3JtWzNdLCBtYXNrVHJhbnNmb3JtWzFdLCBtYXNrVHJhbnNmb3JtWzRdLCBtYXNrVHJhbnNmb3JtWzJdLCBtYXNrVHJhbnNmb3JtWzVdKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0Lm1hc2sud29ybGRBbHBoYSA9IDAuNTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LndvcmxkQWxwaGEgPSAwOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBQSVhJLkNhbnZhc0dyYXBoaWNzLnJlbmRlckdyYXBoaWNzTWFzayhkaXNwbGF5T2JqZWN0Lm1hc2ssIHRoaXMuY29udGV4dCk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuY2xpcCgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBkaXNwbGF5T2JqZWN0Lm1hc2sud29ybGRBbHBoYSA9IGNhY2hlQWxwaGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQucmVzdG9yZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vICBjb3VudCsrCiAgICAgICAgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuX2lOZXh0OwogICAgfQogICAgd2hpbGUoZGlzcGxheU9iamVjdCAhPSB0ZXN0T2JqZWN0KQogICAgCn0KClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24oKQp7CiAgICAvLyB2YXIgZ2wgPSB0aGlzLmdsOwogICAgLy8gdmFyIHdvcmxkVHJhbnNmb3JtLCB3aWR0aCwgaGVpZ2h0LCBhWCwgYVksIHcwLCB3MSwgaDAsIGgxLCBpbmRleCwgaW5kZXgyLCBpbmRleDMKCiAgICB2YXIgd29ybGRUcmFuc2Zvcm0sIHdpZHRoLCBoZWlnaHQsIGFYLCBhWSwgdzAsIHcxLCBoMCwgaDEsIGluZGV4OwoKICAgIHZhciBhLCBiLCBjLCBkLCB0eCwgdHk7CgogICAgdmFyIGluZGV4UnVuID0gMDsKCiAgICB2YXIgZGlzcGxheU9iamVjdCA9IHRoaXMuaGVhZDsKCiAgICB3aGlsZShkaXNwbGF5T2JqZWN0KQogICAgewogICAgICAgIGlmKGRpc3BsYXlPYmplY3QudmNvdW50ID09PSBQSVhJLnZpc2libGVDb3VudCkKICAgICAgICB7CiAgICAgICAgICAgIHdpZHRoID0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLndpZHRoOwogICAgICAgICAgICBoZWlnaHQgPSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUuaGVpZ2h0OwoKICAgICAgICAgICAgLy8gVE9ETyB0cmltPz8KICAgICAgICAgICAgYVggPSBkaXNwbGF5T2JqZWN0LmFuY2hvci54Oy8vIC0gZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueAogICAgICAgICAgICBhWSA9IGRpc3BsYXlPYmplY3QuYW5jaG9yLnk7IC8vLSBkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbS55CiAgICAgICAgICAgIHcwID0gd2lkdGggKiAoMS1hWCk7CiAgICAgICAgICAgIHcxID0gd2lkdGggKiAtYVg7CgogICAgICAgICAgICBoMCA9IGhlaWdodCAqICgxLWFZKTsKICAgICAgICAgICAgaDEgPSBoZWlnaHQgKiAtYVk7CgogICAgICAgICAgICBpbmRleCA9IGluZGV4UnVuICogODsKCiAgICAgICAgICAgIHdvcmxkVHJhbnNmb3JtID0gZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybTsKCiAgICAgICAgICAgIGEgPSB3b3JsZFRyYW5zZm9ybVswXTsKICAgICAgICAgICAgYiA9IHdvcmxkVHJhbnNmb3JtWzNdOwogICAgICAgICAgICBjID0gd29ybGRUcmFuc2Zvcm1bMV07CiAgICAgICAgICAgIGQgPSB3b3JsZFRyYW5zZm9ybVs0XTsKICAgICAgICAgICAgdHggPSB3b3JsZFRyYW5zZm9ybVsyXTsKICAgICAgICAgICAgdHkgPSB3b3JsZFRyYW5zZm9ybVs1XTsKCiAgICAgICAgICAgIGlmIChkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbW1lZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHggKz0gZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueDsKICAgICAgICAgICAgICAgIHR5ICs9IGRpc3BsYXlPYmplY3QudGV4dHVyZS50cmltLnk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmVydGljaWVzW2luZGV4ICsgMCBdID0gYSAqIHcxICsgYyAqIGgxICsgdHg7CiAgICAgICAgICAgIHRoaXMudmVydGljaWVzW2luZGV4ICsgMSBdID0gZCAqIGgxICsgYiAqIHcxICsgdHk7CgogICAgICAgICAgICB0aGlzLnZlcnRpY2llc1tpbmRleCArIDIgXSA9IGEgKiB3MCArIGMgKiBoMSArIHR4OwogICAgICAgICAgICB0aGlzLnZlcnRpY2llc1tpbmRleCArIDMgXSA9IGQgKiBoMSArIGIgKiB3MCArIHR5OwoKICAgICAgICAgICAgdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyA0IF0gPSBhICogdzAgKyBjICogaDAgKyB0eDsKICAgICAgICAgICAgdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyA1IF0gPSBkICogaDAgKyBiICogdzAgKyB0eTsKCiAgICAgICAgICAgIHRoaXMudmVydGljaWVzW2luZGV4ICsgNl0gPSAgYSAqIHcxICsgYyAqIGgwICsgdHg7CiAgICAgICAgICAgIHRoaXMudmVydGljaWVzW2luZGV4ICsgN10gPSAgZCAqIGgwICsgYiAqIHcxICsgdHk7CgogICAgICAgICAgICBpZihkaXNwbGF5T2JqZWN0LnVwZGF0ZUZyYW1lIHx8IGRpc3BsYXlPYmplY3QudGV4dHVyZS51cGRhdGVGcmFtZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5kaXJ0eVVWUyA9IHRydWU7CgogICAgICAgICAgICAgICAgdmFyIHRleHR1cmUgPSBkaXNwbGF5T2JqZWN0LnRleHR1cmU7CgogICAgICAgICAgICAgICAgdmFyIGZyYW1lID0gdGV4dHVyZS5mcmFtZTsKICAgICAgICAgICAgICAgIHZhciB0dyA9IHRleHR1cmUuYmFzZVRleHR1cmUud2lkdGg7CiAgICAgICAgICAgICAgICB2YXIgdGggPSB0ZXh0dXJlLmJhc2VUZXh0dXJlLmhlaWdodDsKCiAgICAgICAgICAgICAgICB0aGlzLnV2c1tpbmRleCArIDBdID0gZnJhbWUueCAvIHR3OwogICAgICAgICAgICAgICAgdGhpcy51dnNbaW5kZXggKzFdID0gZnJhbWUueSAvIHRoOwoKICAgICAgICAgICAgICAgIHRoaXMudXZzW2luZGV4ICsyXSA9IChmcmFtZS54ICsgZnJhbWUud2lkdGgpIC8gdHc7CiAgICAgICAgICAgICAgICB0aGlzLnV2c1tpbmRleCArM10gPSBmcmFtZS55IC8gdGg7CgogICAgICAgICAgICAgICAgdGhpcy51dnNbaW5kZXggKzRdID0gKGZyYW1lLnggKyBmcmFtZS53aWR0aCkgLyB0dzsKICAgICAgICAgICAgICAgIHRoaXMudXZzW2luZGV4ICs1XSA9IChmcmFtZS55ICsgZnJhbWUuaGVpZ2h0KSAvIHRoOwoKICAgICAgICAgICAgICAgIHRoaXMudXZzW2luZGV4ICs2XSA9IGZyYW1lLnggLyB0dzsKICAgICAgICAgICAgICAgIHRoaXMudXZzW2luZGV4ICs3XSA9IChmcmFtZS55ICsgZnJhbWUuaGVpZ2h0KSAvIHRoOwoKICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3QudXBkYXRlRnJhbWUgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVE9ETyB0aGlzIHByb2JhYmx5IGNvdWxkIGRvIHdpdGggc29tZSBvcHRpbWlzYXRpb24uLi4uCiAgICAgICAgICAgIGlmKGRpc3BsYXlPYmplY3QuY2FjaGVBbHBoYSAhPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGRpc3BsYXlPYmplY3QuY2FjaGVBbHBoYSA9IGRpc3BsYXlPYmplY3Qud29ybGRBbHBoYTsKCiAgICAgICAgICAgICAgICB2YXIgY29sb3JJbmRleCA9IGluZGV4UnVuICogNDsKICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzW2NvbG9ySW5kZXhdID0gdGhpcy5jb2xvcnNbY29sb3JJbmRleCArIDFdID0gdGhpcy5jb2xvcnNbY29sb3JJbmRleCArIDJdID0gdGhpcy5jb2xvcnNbY29sb3JJbmRleCArIDNdID0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhOwogICAgICAgICAgICAgICAgdGhpcy5kaXJ0eUNvbG9ycyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaW5kZXggPSBpbmRleFJ1biAqIDg7CgogICAgICAgICAgICB0aGlzLnZlcnRpY2llc1tpbmRleCArIDAgXSA9IDA7CiAgICAgICAgICAgIHRoaXMudmVydGljaWVzW2luZGV4ICsgMSBdID0gMDsKCiAgICAgICAgICAgIHRoaXMudmVydGljaWVzW2luZGV4ICsgMiBdID0gMDsKICAgICAgICAgICAgdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyAzIF0gPSAwOwoKICAgICAgICAgICAgdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyA0IF0gPSAwOwogICAgICAgICAgICB0aGlzLnZlcnRpY2llc1tpbmRleCArIDUgXSA9IDA7CgogICAgICAgICAgICB0aGlzLnZlcnRpY2llc1tpbmRleCArIDZdID0gMDsKICAgICAgICAgICAgdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyA3XSA9IDA7CiAgICAgICAgfQoKICAgICAgICBpbmRleFJ1bisrOwogICAgICAgIGRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9fbmV4dDsKICAgIH0KfQogIHJldHVybiBQaGFzZXI7Cn0pOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 18:40:46 GMT",
                    "Content-Length": "1379053",
                    "Date": "Fri, 07 Nov 2014 18:40:48 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}