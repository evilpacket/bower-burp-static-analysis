{
    "url": "http://localhost:9999/michaelbromley/horizonal/dist/horizonal.debug.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>window.location.hash</b> and written to <b>$()</b> via the following statements:<ul><li>var hash = window.location.hash;</li><li>var page = $(hash).closest('.hrz-page');</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/michaelbromley/horizonal/dist/horizonal.debug.js",
                "path": "/michaelbromley/horizonal/dist/horizonal.debug.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9taWNoYWVsYnJvbWxleS9ob3Jpem9uYWwvZGlzdC9ob3Jpem9uYWwuZGVidWcuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDM1NTQNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDM6MTk6NDMgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDAzOjE5OjQzIEdNVA0KDQooZnVuY3Rpb24oJCwgd2luZG93LCBkb2N1bWVudCkgewovKioKICogVGhpcyBvYmplY3QgaXMgcmVzcG9uc2libGUgZm9yIHRha2luZyBhIG5vZGVDb2xsZWN0aW9uIGFuZCBzcGxpdHRpbmcgaXQgdXAgaW50byB0aGUgY29ycmVjdCBudW1iZXIgb2YgcGFnZXMsCiAqIHBsYWNpbmcgdGhlIGNvcnJlY3Qgbm9kZXMgb24gZWFjaCBwYWdlLgogKi8KdmFyIHBhZ2VDb2xsZWN0aW9uR2VuZXJhdG9yID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgbW9kdWxlID0ge307CgogICAgZnVuY3Rpb24gZnJvbU5vZGVDb2xsZWN0aW9uKG5vZGVDb2xsZWN0aW9uKSB7CiAgICAgICAgdmFyIGxhc3RQYWdlID0gMTsKICAgICAgICB2YXIgaW5kZXg7CiAgICAgICAgdmFyIHBhZ2VDb2xsZWN0aW9uID0gbmV3IFBhZ2VDb2xsZWN0aW9uKCk7CgogICAgICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IG5vZGVDb2xsZWN0aW9uLmxlbmd0aDsgaW5kZXggKyspIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBub2RlQ29sbGVjdGlvbltpbmRleF07CiAgICAgICAgICAgIHZhciBwYWdlVXBwZXJCb3VuZCA9IHBhZ2VDb2xsZWN0aW9uLmdldExhc3RPZmZzZXQoKSArIFZJRVdQT1JUX0hFSUdIVDsKCiAgICAgICAgICAgIHZhciBub2RlSXNUYWxsQW5kRG9lc05vdEZpdE9uUGFnZSA9IGlzTm9kZVRhbGwobm9kZSwgcGFnZVVwcGVyQm91bmQpOwogICAgICAgICAgICBpZiAobm9kZUlzVGFsbEFuZERvZXNOb3RGaXRPblBhZ2UgJiYgIW5vZGUuaXNDbG9uZSkgewogICAgICAgICAgICAgICAgbm9kZS5pc1RhbGwgPSB0cnVlOwogICAgICAgICAgICAgICAgdmFyIHBhZ2VPdmVyaGFuZyA9IG5vZGUubGF5b3V0LmJvdHRvbSAtIHBhZ2VVcHBlckJvdW5kOwogICAgICAgICAgICAgICAgdmFyIGkgPSAxOwogICAgICAgICAgICAgICAgLy8gQXMgbG9uZyBhcyB0aGUgbm9kZSBoYW5ncyBvdmVyIHRoZSBlZGdlIG9mIHRoZSBwYWdlLCB3ZSBuZWVkIHRvIGtlZXAKICAgICAgICAgICAgICAgIC8vIGFkZGluZyBjbG9uZXMgdGhhdCB3aWxsIGVhY2ggYXBwZWFyIG9uIHN1YnNlcXVlbnQgcGFnZXMuCiAgICAgICAgICAgICAgICB3aGlsZSgwIDwgcGFnZU92ZXJoYW5nKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNsb25lSW5kZXggPSBpbmRleCArIGk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNsb25lID0gbm9kZS5tYWtlQ2xvbmUoY2xvbmVJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgY2xvbmUucGFnZU92ZXJoYW5nID0gcGFnZU92ZXJoYW5nOwogICAgICAgICAgICAgICAgICAgIG5vZGVDb2xsZWN0aW9uLnNwbGljZShjbG9uZUluZGV4LCAwICwgY2xvbmUpOwogICAgICAgICAgICAgICAgICAgIHBhZ2VPdmVyaGFuZyA9IHBhZ2VPdmVyaGFuZyAtIFZJRVdQT1JUX0hFSUdIVDsKICAgICAgICAgICAgICAgICAgICBpICsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhc3RQYWdlID0gY2FsY3VsYXRlTGFzdFBhZ2VBbmRQYWdlT2Zmc2V0KG5vZGUsIHBhZ2VDb2xsZWN0aW9uLCBsYXN0UGFnZSk7CgogICAgICAgICAgICB2YXIgcGFnZVRvQWRkVG87CiAgICAgICAgICAgIHZhciBub2RlSXNCb3R0b21Nb3N0RWxlbWVudCA9IHBhZ2VDb2xsZWN0aW9uLmxhc3QoKS5ib3R0b20gPT09IG5vZGUubGF5b3V0LmJvdHRvbTsKICAgICAgICAgICAgaWYgKG5vZGVJc0JvdHRvbU1vc3RFbGVtZW50IHx8IG5vZGUuaXNDbG9uZSB8fCBub2RlLm5ld1BhZ2UpIHsKICAgICAgICAgICAgICAgIHBhZ2VUb0FkZFRvID0gbGFzdFBhZ2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYWdlVG9BZGRUbyA9IHBhZ2VDb2xsZWN0aW9uLmdldFBhZ2VBdE9mZnNldChub2RlLmxheW91dC50b3ApLnBhZ2VOdW1iZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHBhZ2VDb2xsZWN0aW9uLmdldFBhZ2UocGFnZVRvQWRkVG8pLmFkZE5vZGUobm9kZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcGFnZUNvbGxlY3Rpb247CiAgICB9CgogICAgZnVuY3Rpb24gaXNOb2RlVGFsbChub2RlLCBwYWdlVXBwZXJCb3VuZCkgewogICAgICAgIHZhciBpc1RhbGwgPSBmYWxzZTsKICAgICAgICBpZiAoJChub2RlLmRvbU5vZGUpLmhhc0NsYXNzKE9QVElPTlMubmV3UGFnZUNsYXNzKSkgewogICAgICAgICAgICBpZiAoVklFV1BPUlRfSEVJR0hUIDwgbm9kZS5sYXlvdXQuaGVpZ2h0KSB7CiAgICAgICAgICAgICAgICBpc1RhbGwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKFZJRVdQT1JUX0hFSUdIVCAvIDIgPCBub2RlLmxheW91dC5oZWlnaHQgJiYgcGFnZVVwcGVyQm91bmQgPCBub2RlLmxheW91dC5ib3R0b20pIHsKICAgICAgICAgICAgICAgIGlzVGFsbCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzVGFsbDsKICAgIH0KCiAgICAvKioKICAgICAqIEZvciBhIGdpdmVuIG5vZGUsIHdlIG5lZWQgdG8ga25vdyB3aGF0IHBhZ2UgaXQgc2hvdWxkIGJlIG9uLCBhbmQgd2hldGhlciBpdCBleHRlbmRzIG9mZiB0aGUgYm90dG9tCiAgICAgKiBvZmYgdGhlIGN1cnJlbnQgcGFnZSAobGFzdFBhZ2UpLiBJZiBzbywgd2UgbmVlZCB0byBzdGFydCBhIG5ldyBwYWdlLiBTb3JyeSBhYm91dCB0aGUgY29tcGxleGl0eS4KICAgICAqIEBwYXJhbSBub2RlCiAgICAgKiBAcGFyYW0gbGFzdFBhZ2UKICAgICAqIEBwYXJhbSBwYWdlQ29sbGVjdGlvbgogICAgICovCiAgICBmdW5jdGlvbiBjYWxjdWxhdGVMYXN0UGFnZUFuZFBhZ2VPZmZzZXQobm9kZSwgcGFnZUNvbGxlY3Rpb24sIGxhc3RQYWdlKSB7CiAgICAgICAgaWYgKCQobm9kZS5kb21Ob2RlKS5oYXNDbGFzcyhPUFRJT05TLm5ld1BhZ2VDbGFzcykpIHsKICAgICAgICAgICAgbGFzdFBhZ2UgKys7CiAgICAgICAgICAgIG5vZGUubmV3UGFnZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChwYWdlQ29sbGVjdGlvbltsYXN0UGFnZSAtIDFdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdmFyIHBhZ2UgPSBwYWdlQ29sbGVjdGlvbi5nZXRQYWdlKGxhc3RQYWdlKTsKICAgICAgICAgICAgdmFyIHBhZ2VVcHBlckJvdW5kID0gcGFnZS50b3AgKyBWSUVXUE9SVF9IRUlHSFQ7CiAgICAgICAgICAgIGlmIChwYWdlLmJvdHRvbSA8PSBub2RlLmxheW91dC5ib3R0b20pIHsKICAgICAgICAgICAgICAgIHZhciBub2RlRG9lc05vdEZpdE9uUGFnZSA9IHBhZ2VVcHBlckJvdW5kIDwgbm9kZS5sYXlvdXQuYm90dG9tOwogICAgICAgICAgICAgICAgaWYgKCFub2RlLmlzVGFsbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlRG9lc05vdEZpdE9uUGFnZSB8fCBub2RlLmlzQ2xvbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFBhZ2UgKys7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb2xsZWN0aW9uLmFkZCgpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3UGFnZSA9IHBhZ2VDb2xsZWN0aW9uLmxhc3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFZJRVdQT1JUX0hFSUdIVCA8IG5vZGUubGF5b3V0LmhlaWdodCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGFnZS5ib3R0b20gPSBwYWdlVXBwZXJCb3VuZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnBhZ2VPdmVyaGFuZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhZ2UuYm90dG9tICs9IE1hdGgubWluKG5vZGUucGFnZU92ZXJoYW5nLCBWSUVXUE9SVF9IRUlHSFQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGFnZS5ib3R0b20gPSBub2RlLmxheW91dC5ib3R0b207CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBwYWdlLmJvdHRvbSA9IG5vZGUubGF5b3V0LmJvdHRvbTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChub2RlRG9lc05vdEZpdE9uUGFnZSkgewogICAgICAgICAgICAgICAgICAgICAgICBwYWdlLmJvdHRvbSA9IHBhZ2VVcHBlckJvdW5kOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhZ2VDb2xsZWN0aW9uLmFkZCgpOwogICAgICAgICAgICBwYWdlQ29sbGVjdGlvbi5sYXN0KCkuYm90dG9tID0gbm9kZS5sYXlvdXQuYm90dG9tOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGxhc3RQYWdlOwogICAgfQoKICAgIG1vZHVsZS5mcm9tTm9kZUNvbGxlY3Rpb24gPSBmcm9tTm9kZUNvbGxlY3Rpb247CiAgICByZXR1cm4gbW9kdWxlOwp9KCk7CnZhciBQQUdFX0NPTExFQ1RJT047CnZhciBPUFRJT05TOwp2YXIgQ09OVEFJTkVSOwp2YXIgUk9PVDsKdmFyIFJPT1RfQ0xPTkU7CnZhciBWSUVXUE9SVF9IRUlHSFQ7CnZhciBDVVNUT01fQ1NTOwoKCmZ1bmN0aW9uIEhvcml6b25hbCgpIHsKCiAgICB2YXIgX2hhc0JlZW5Jbml0aWFsaXplZCA9IGZhbHNlOwogICAgdmFyIF9kaXNhYmxlZCA9IGZhbHNlOwogICAgdmFyIGRlZmF1bHRzID0gewogICAgICAgIHNlbGVjdG9yOiAnaDEsIGgyLCBoMywgaDQsIGg1LCBoNiwgcCwgbGksIGltZywgdGFibGUnLAogICAgICAgIHN0YWdnZXJEZWxheTogMC4xLAogICAgICAgIHN0YWdnZXI6ICdyYW5kb20nLAogICAgICAgIGN1c3RvbUNzc0ZpbGU6IGZhbHNlLAogICAgICAgIGRpc3BsYXlTY3JvbGxiYXI6IGZhbHNlLAogICAgICAgIHNjcm9sbGJhclNob3J0ZW5SYXRpbzogMiwgLy8gbG9uZyBzY3JvbGxpbmcgYmV0d2VlbiBwYWdlcyBjYW4gYmUgYSBwYWluLCBzbyBhIGhpZ2hlciB2YWx1ZSBoZXJlIHdpbGwgc2hvcnRlbiB0aGUgc2Nyb2xsIGRpc3RhbmNlIGJldHdlZW4gcGFnZXMKICAgICAgICBwYWdlTWFyZ2luOiAyMCwKICAgICAgICBkaXNwbGF5UGFnZUNvdW50OiB0cnVlLAogICAgICAgIHJvb3RFbGVtZW50OiAnYm9keScsCiAgICAgICAgbmV3UGFnZUNsYXNzOiAnaHJ6LXN0YXJ0LW5ldy1wYWdlJywKICAgICAgICBwYWdlSGlkZURlbGF5OiAxLCAvLyBzZWNvbmRzIGJlZm9yZSB0aGUgJ2hyei1oaWRkZW4nIGNsYXNzIGdldHMgYWRkZWQgdG8gYSBwYWdlIHRoZSBpcyBub3QgaW4gZm9jdXMKICAgICAgICBvblJlc2l6ZTogbm9vcCwKICAgICAgICBvbk5vZGVUcmFuc2l0aW9uOiBub29wLAogICAgICAgIG9uUGFnZVRyYW5zaXRpb246IG5vb3AKICAgIH07CgogICAgZnVuY3Rpb24gaW5pdChfT1BUSU9OUykgewogICAgICAgIHZhciBjdXJyZW50U2Nyb2xsID0gJCh3aW5kb3cpLnNjcm9sbFRvcCgpOwogICAgICAgIE9QVElPTlMgPSAkLmV4dGVuZCgge30sIGRlZmF1bHRzLCBfT1BUSU9OUyk7CiAgICAgICAgbG9hZEN1c3RvbUNzcygpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghX2hhc0JlZW5Jbml0aWFsaXplZCkgewogICAgICAgICAgICAgICAgUk9PVCA9ICQoT1BUSU9OUy5yb290RWxlbWVudCk7CiAgICAgICAgICAgICAgICBST09UX0NMT05FID0gUk9PVC5jbG9uZSgpOwogICAgICAgICAgICAgICAgY29tcG9zZVBhZ2UoY3VycmVudFNjcm9sbCkKICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlUGFnZUNvdW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2lzdGVyRXZlbnRIYW5kbGVycygpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2luZG93LmxvY2F0aW9uLmhhc2ggIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNoQ2hhbmdlSGFuZGxlcigpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIF9oYXNCZWVuSW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzaXplSGFuZGxlcigpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gZGlzYWJsZSgpIHsKICAgICAgICBpZiAoIV9kaXNhYmxlZCkgewogICAgICAgICAgICBST09ULnJlcGxhY2VXaXRoKFJPT1RfQ0xPTkUuY2xvbmUoKSk7CiAgICAgICAgICAgIGlmICghT1BUSU9OUy5kaXNwbGF5U2Nyb2xsYmFyKSB7CiAgICAgICAgICAgICAgICAkKCdib2R5JykuY3NzKCdvdmVyZmxvdy15JywgJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVucmVnaXN0ZXJFdmVudEhhbmRsZXJzKCk7CiAgICAgICAgICAgIHJlbW92ZVBhZ2VDb3VudCgpOwogICAgICAgICAgICBfZGlzYWJsZWQgPSB0cnVlOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBlbmFibGUoKSB7CiAgICAgICAgaWYgKF9kaXNhYmxlZCkgewogICAgICAgICAgICByZXNpemVIYW5kbGVyKCk7CiAgICAgICAgICAgIHJlZ2lzdGVyRXZlbnRIYW5kbGVycygpOwogICAgICAgICAgICBfZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBUYWtlcyBhIHBhZ2UgbnVtYmVyIG9yIFVSTCBmcmFnbWVudCAoIykgYW5kIGdvZXMgdG8gdGhhdCBwYWdlLgogICAgICogQHBhcmFtIHRhcmdldAogICAgICovCiAgICBmdW5jdGlvbiBnb1RvKHRhcmdldCkgewogICAgICAgIHZhciBwYWdlTnVtYmVyOwogICAgICAgIGlmICh0YXJnZXQuc3Vic3RyKDAsIDEpID09PSAiIyIpIHsKICAgICAgICAgICAgaGFzaENoYW5nZUhhbmRsZXIodGFyZ2V0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBUT0RPOiB2ZXJpZnkgdGFyZ2V0IGlzIHZhbGlkIGludGVnZXIKICAgICAgICAgICAgcGFnZU51bWJlciA9IHRhcmdldDsKICAgICAgICAgICAgUEFHRV9DT0xMRUNUSU9OLnNob3dQYWdlKHBhZ2VOdW1iZXIpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBuZXh0KCkgewogICAgICAgIHZhciBjdXJyZW50ID0gUEFHRV9DT0xMRUNUSU9OLmN1cnJlbnRQYWdlOwogICAgICAgIHZhciBsYXN0ID0gUEFHRV9DT0xMRUNUSU9OLmxlbmd0aDsKCiAgICAgICAgaWYgKGN1cnJlbnQgPCBsYXN0KSB7CiAgICAgICAgICAgIHZhciBzY3JvbGxUb3AgPSBQQUdFX0NPTExFQ1RJT04uZ2V0UGFnZShjdXJyZW50ICsgMSkubWlkUG9pbnQ7CiAgICAgICAgICAgICQod2luZG93KS5zY3JvbGxUb3Aoc2Nyb2xsVG9wKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcHJldmlvdXMoKSB7CiAgICAgICAgdmFyIGN1cnJlbnQgPSBQQUdFX0NPTExFQ1RJT04uY3VycmVudFBhZ2U7CgogICAgICAgIGlmICgxIDwgY3VycmVudCkgewogICAgICAgICAgICB2YXIgc2Nyb2xsVG9wID0gUEFHRV9DT0xMRUNUSU9OLmdldFBhZ2UoY3VycmVudCAtIDEpLm1pZFBvaW50OwogICAgICAgICAgICAkKHdpbmRvdykuc2Nyb2xsVG9wKHNjcm9sbFRvcCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRIYW5kbGVycygpIHsKICAgICAgICAkKHdpbmRvdykub24oJ3Jlc2l6ZScsIHJlc2l6ZUhhbmRsZXIpOwogICAgICAgICQod2luZG93KS5vbigna2V5ZG93bicsIGtleWRvd25IYW5kbGVyKTsKICAgICAgICAkKHdpbmRvdykub24oJ3Njcm9sbCcsIHNjcm9sbEhhbmRsZXIpOwogICAgICAgICQod2luZG93KS5vbignaGFzaGNoYW5nZScsIGhhc2hDaGFuZ2VIYW5kbGVyKTsKICAgICAgICAkKHdpbmRvdykub24oJ3RvdWNoc3RhcnQgcG9pbnRlcmRvd24gTVNQb2ludGVyRG93bicsIHRvdWNoc3RhcnRIYW5kbGVyKTsKICAgICAgICAkKHdpbmRvdykub24oJ3RvdWNoZW5kIHBvaW50ZXJ1cCBNU1BvaW50ZXJVcCcsIHRvdWNoZW5kSGFuZGxlcik7CiAgICAgICAgJCh3aW5kb3cpLm9uKCd0b3VjaG1vdmUgcG9pbnRlcm1vdmUgTVNQb2ludGVyTW92ZScsIHRvdWNobW92ZUhhbmRsZXIpOwogICAgICAgICQod2luZG93LmRvY3VtZW50KS5vbignd2hlZWwnLCBtb3VzZXdoZWVsSGFuZGxlcik7CiAgICAgICAgJCgnYScpLm9uKCdjbGljaycsIGxpbmtIYW5kbGVyKTsKICAgIH0KCiAgICBmdW5jdGlvbiB1bnJlZ2lzdGVyRXZlbnRIYW5kbGVycygpIHsKICAgICAgICAkKHdpbmRvdykub2ZmKCdyZXNpemUnLCByZXNpemVIYW5kbGVyKTsKICAgICAgICAkKHdpbmRvdykub2ZmKCdrZXlkb3duJywga2V5ZG93bkhhbmRsZXIpOwogICAgICAgICQod2luZG93KS5vZmYoJ3Njcm9sbCcsIHNjcm9sbEhhbmRsZXIpOwogICAgICAgICQod2luZG93KS5vZmYoJ2hhc2hjaGFuZ2UnLCBoYXNoQ2hhbmdlSGFuZGxlcik7CiAgICAgICAgJCh3aW5kb3cpLm9mZigndG91Y2hzdGFydCBwb2ludGVyZG93biBNU1BvaW50ZXJEb3duJywgdG91Y2hzdGFydEhhbmRsZXIpOwogICAgICAgICQod2luZG93KS5vZmYoJ3RvdWNoZW5kIHBvaW50ZXJ1cCBNU1BvaW50ZXJVcCcsIHRvdWNoZW5kSGFuZGxlcik7CiAgICAgICAgJCh3aW5kb3cpLm9mZigndG91Y2htb3ZlIHBvaW50ZXJtb3ZlIE1TUG9pbnRlck1vdmUnLCB0b3VjaG1vdmVIYW5kbGVyKTsKICAgICAgICAkKHdpbmRvdy5kb2N1bWVudCkub2ZmKCd3aGVlbCcsIG1vdXNld2hlZWxIYW5kbGVyKTsKICAgICAgICAkKCdhJykub2ZmKCdjbGljaycsIGxpbmtIYW5kbGVyKTsKICAgIH0KCiAgICAvKioKICAgICAqIExvYWRzIGFueSBjdXN0b20gQ1NTIGZpbGUgaW50byBhbiBpbmxpbmUgPHN0eWxlPiB0YWcgaW4gdGhlIGRvY3VtZW50IGhlYWRlci4gVGhpcyBtZXRob2QgaXMKICAgICAqIHByZWZlcnJlZCBvdmVyIHNpbXBseSBsb2FkaW5nIGEgPGxpbms+IGVsZW1lbnQsIGJlY2F1c2UgYnJvd3NlciBzdXBwb3J0IGZvciBkZXRlY3RpbmcgdGhlICJsb2FkIgogICAgICogZXZlbnQgb2YgZHluYW1pY2FsbHkgbG9hZGVkIENTUyBmaWxlcyBpcyBjdXJyZW50bHkgdmVyeSBwb29yIGFuZCBpbmNvbnNpc3RlbnQuIFRoZXJlZm9yZSB3ZSB1c2UKICAgICAqIEFKQVggdG8gbG9hZCB0aGUgQ1NTIGZpbGUgYW5kIGp1c3QgcHV0IHRoZSBjb250ZW50cyBpbiB0aGUgaGVhZC4gVGhhdCB3YXkgd2UgY2FuIGd1YXJhbnRlZSB0aGF0IGl0CiAgICAgKiBpcyBsb2FkZWQgYmVmb3JlIGNvbnRpbnVpbmcsIGluIGEgY3Jvc3MtYnJvd3NlciBjb21wYXRpYmxlIHdheS4KICAgICAqIEByZXR1cm5zIHsqfQogICAgICovCiAgICBmdW5jdGlvbiBsb2FkQ3VzdG9tQ3NzKCkgewoKICAgICAgICB2YXIgZGVmZXJyZWQgPSBuZXcgJC5EZWZlcnJlZCgpOwoKICAgICAgICBpZiAoT1BUSU9OUy5jdXN0b21Dc3NGaWxlKSB7CiAgICAgICAgICAgICQuZ2V0KE9QVElPTlMuY3VzdG9tQ3NzRmlsZSkudGhlbihzdWNjZXNzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkKCcjaHJ6LWN1c3RvbS1jc3MnKS5yZW1vdmUoKTsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoKICAgICAgICBmdW5jdGlvbiBzdWNjZXNzKGRhdGEpIHsKICAgICAgICAgICAgQ1VTVE9NX0NTUyA9IGRhdGE7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIHB1YmxpYyBBUEkKICAgICAqLwogICAgcmV0dXJuIHsKICAgICAgICBpbml0OiBpbml0LAogICAgICAgIGRpc2FibGU6IGRpc2FibGUsCiAgICAgICAgZW5hYmxlOiBlbmFibGUsCiAgICAgICAgZ29UbzogZ29UbywKICAgICAgICBuZXh0OiBuZXh0LAogICAgICAgIHByZXZpb3VzOiBwcmV2aW91cwogICAgfTsKfQoKd2luZG93Lmhvcml6b25hbCA9IG5ldyBIb3Jpem9uYWwoKTsKCi8qKgogKiBUaGlzIGlzIHRoZSBtYWluIG1ldGhvZCB0aGF0IGNvbnZlcnRzIHRoZSBkb2N1bWVudCB0byBhIGNvbGxlY3Rpb24gb2YgcGFnZXMuIFNpbmNlIHRoaXMgbWV0aG9kIGNhbiBiZSBzbG93IChkZXBlbmRpbmcKICogb24gdGhlIG51bWJlciBvZiBET00gZWxlbWVudHMgaW4gdGhlIGRvY3VtZW50KSwgaXQgcnVucyBhc3luYyBhbmQgcmV0dXJucyBhIHByb21pc2UuCiAqIEBwYXJhbSBjdXJyZW50U2Nyb2xsCiAqLwpmdW5jdGlvbiBjb21wb3NlUGFnZShjdXJyZW50U2Nyb2xsKSB7CgogICAgdmFyIGRlZmVycmVkID0gbmV3ICQuRGVmZXJyZWQoKTsKICAgIFJPT1QgPSAkKE9QVElPTlMucm9vdEVsZW1lbnQpOwogICAgdmFyIGZyYWdtZW50ID0gY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgQ09OVEFJTkVSID0gJChmcmFnbWVudC5xdWVyeVNlbGVjdG9yKCcjaHJ6LWNvbnRhaW5lcicpKTsKICAgIENPTlRBSU5FUi5jc3MoewogICAgICAgICdkaXNwbGF5JzogJ25vbmUnLCAvLyBzZXR0aW5nIGRpc3BsYXk6bm9uZSBjb25zaWRlcmFibHkgc3BlZWRzIHVwIHJlbmRlcmluZwogICAgICAgICd0b3AnOiAwLAogICAgICAgICdsZWZ0JzogMAogICAgfSk7CiAgICBWSUVXUE9SVF9IRUlHSFQgPSAkKHdpbmRvdykuaGVpZ2h0KCkgLSBPUFRJT05TLnBhZ2VNYXJnaW4gKiAyOwoKICAgIGRpc3BsYXlMb2FkaW5nSW5kaWNhdG9yKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAvLyBhIHNldFRpbWVvdXQgaXMgdXNlZCB0byBmb3JjZSBhc3luYyBleGVjdXRpb24gYW5kIGFsbG93IHRoZSBsb2FkaW5nSW5kaWNhdG9yIHRvIGRpc3BsYXkgYmVmb3JlIHRoZQogICAgICAgIC8vIGhlYXZ5IGNvbXB1dGF0aW9ucyBvZiBjb21wb3NlUGFnZSgpIGFyZSBiZWd1bi4KICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgaWYgKCFPUFRJT05TLmRpc3BsYXlTY3JvbGxiYXIpIHsKICAgICAgICAgICAgICAgICQoJ2JvZHknKS5jc3MoJ292ZXJmbG93LXknLCAnaGlkZGVuJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBhbGxOb2RlcyA9IG5ldyBOb2RlQ29sbGVjdGlvbihPUFRJT05TLnNlbGVjdG9yKTsKCiAgICAgICAgICAgIFBBR0VfQ09MTEVDVElPTiA9IHBhZ2VDb2xsZWN0aW9uR2VuZXJhdG9yLmZyb21Ob2RlQ29sbGVjdGlvbihhbGxOb2Rlcyk7CiAgICAgICAgICAgIFBBR0VfQ09MTEVDVElPTi5hcHBlbmRUb0RvbShjdXJyZW50U2Nyb2xsKTsKCiAgICAgICAgICAgIC8vIHJlbW92ZSBhbnkgRE9NIG5vZGVzIHRoYXQgYXJlIG5vdCBpbmNsdWRlZCBpbiB0aGUgc2VsZWN0b3IsCiAgICAgICAgICAgIC8vIHNpbmNlIHRoZXkgd2lsbCBqdXN0IGJlIGxlZnQgZmxvYXRpbmcgYXJvdW5kIGluIHRoZSB3cm9uZyBwbGFjZS4KICAgICAgICAgICAgQ09OVEFJTkVSLmNoaWxkcmVuKCkubm90KCcuaHJ6LXBhZ2UnKS5maWx0ZXIoJzp2aXNpYmxlJykucmVtb3ZlKCk7CiAgICAgICAgICAgIFJPT1QuZW1wdHkoKS5hcHBlbmQoZnJhZ21lbnQpOwoKICAgICAgICAgICAgLy8gYWRkIHRoZSB0aGVtZSdzIGN1c3RvbSBDU1MgdG8gdGhlIGRvY3VtZW50IG5vdyBzbyB0aGF0IGl0IGNhbiBiZQogICAgICAgICAgICAvLyB1c2VkIGluIGNhbGN1bGF0aW5nIHRoZSBlbGVtZW50cycgc3R5bGVzLgogICAgICAgICAgICBhZGRDdXN0b21Dc3NUb0RvY3VtZW50KCk7CgogICAgICAgICAgICBQQUdFX0NPTExFQ1RJT04uZm9yRWFjaChmdW5jdGlvbihwYWdlKSB7CiAgICAgICAgICAgICAgICBwYWdlLm5vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgbm9kZS5yZW5kZXJTdHlsZXMocGFnZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBDT05UQUlORVIuY3NzKCdkaXNwbGF5JywgJycpOwoKICAgICAgICAgICAgdmFyIGRvY3VtZW50SGVpZ2h0ID0gUEFHRV9DT0xMRUNUSU9OLmxhc3QoKS5ib3R0b20gLyBPUFRJT05TLnNjcm9sbGJhclNob3J0ZW5SYXRpbyArIFZJRVdQT1JUX0hFSUdIVDsKICAgICAgICAgICAgUk9PVC5oZWlnaHQoZG9jdW1lbnRIZWlnaHQpOwogICAgICAgICAgICByZW5kZXJQYWdlQ291bnQoKTsKICAgICAgICAgICAgcmVtb3ZlTG9hZGluZ0luZGljYXRvcigpOwogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCk7CiAgICAgICAgfSwgMCk7CiAgICB9KTsKCiAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwp9CgovKioKICogQWRkIHRoZSBDU1MgdGV4dCBsb2FkZWQgYnkgbG9hZEN1c3RvbUNzcygpIGludG8gdGhlIGRvY3VtZW50IGhlYWQuCiAqLwpmdW5jdGlvbiBhZGRDdXN0b21Dc3NUb0RvY3VtZW50KCkgewogICAgdmFyICRjdXN0b21Dc3NFbGVtZW50ID0gJCgnI2hyei1jdXN0b20tY3NzJyk7CiAgICBpZiAoMCA8ICRjdXN0b21Dc3NFbGVtZW50Lmxlbmd0aCkgewogICAgICAgICRjdXN0b21Dc3NFbGVtZW50LnRleHQoQ1VTVE9NX0NTUyk7CiAgICB9IGVsc2UgewogICAgICAgICQoJ2hlYWQnKS5hcHBlbmQoJzxzdHlsZSBpZD0iaHJ6LWN1c3RvbS1jc3MiIHR5cGU9InRleHQvY3NzIj4nICsgQ1VTVE9NX0NTUyArICc8L3N0eWxlPicpOwogICAgfQp9CgovKioKICogQnVpbGRpbmcgdXAgYSBkb2N1bWVudEZyYWdtZW50IGFuZCB0aGVuIGFwcGVuZGluZyBpdCBhbGwgYXQgb25jZSB0byB0aGUgRE9NCiAqIGlzIGRvbmUgdG8gaW1wcm92ZSBwZXJmb3JtYW5jZS4KICogQHJldHVybnMgeyp9CiAqLwpmdW5jdGlvbiBjcmVhdGVEb2N1bWVudEZyYWdtZW50KCkgewogICAgdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgdmFyIGNvbnRhaW5lckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgY29udGFpbmVyRGl2LmlkID0gJ2hyei1jb250YWluZXInOwogICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoY29udGFpbmVyRGl2KTsKICAgIHJldHVybiBmcmFnbWVudDsKfQoKZnVuY3Rpb24gZGlzcGxheUxvYWRpbmdJbmRpY2F0b3IoKSB7CiAgICB2YXIgZGVmZXJyZWQgPSBuZXcgJC5EZWZlcnJlZCgpOwogICAgaWYgKCQoJy5ocnotbG9hZGluZy1pbmRpY2F0b3InKS5sZW5ndGggPT09IDApIHsKICAgICAgICAkKCdib2R5JykuYXBwZW5kKCc8ZGl2IGNsYXNzPSJocnotbG9hZGluZy1pbmRpY2F0b3IiIHN0eWxlPSJkaXNwbGF5Om5vbmU7Ij48cCBjbGFzcz0iaHJ6LWxvYWRpbmctaW5kaWNhdG9yIj5Mb2FkaW5nLi4uPC9wPjwvZGl2PicpOwogICAgICAgICQoJ2Rpdi5ocnotbG9hZGluZy1pbmRpY2F0b3InKS5mYWRlSW4oNTAsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCk7CiAgICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwp9CgpmdW5jdGlvbiByZW1vdmVMb2FkaW5nSW5kaWNhdG9yKCkgewogICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAkKCdkaXYuaHJ6LWxvYWRpbmctaW5kaWNhdG9yJykuZmFkZU91dCg1MCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICQodGhpcykucmVtb3ZlKCk7CiAgICAgICAgfSk7CiAgICB9LCAzMDApOwp9CgpmdW5jdGlvbiByZW5kZXJQYWdlQ291bnQoKSB7CiAgICBpZiAoJCgnLmhyei1wYWdlLWNvdW50JykubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdmFyIHBhZ2VDb3VudERpdiA9ICQoJzxkaXYgY2xhc3M9Imhyei1wYWdlLWNvdW50Ij48L2Rpdj4nKTsKICAgICAgICAkKCdib2R5JykuYXBwZW5kKHBhZ2VDb3VudERpdik7CiAgICAgICAgcGFnZUNvdW50RGl2LmFwcGVuZCgnPHNwYW4gaWQ9Imhyei1jdXJyZW50LXBhZ2UiPjwvc3Bhbj4gLyA8c3BhbiBpZD0iaHJ6LXRvdGFsLXBhZ2VzIj48L3NwYW4+Jyk7CiAgICAgICAgJCgnI2hyei10b3RhbC1wYWdlcycpLmh0bWwoUEFHRV9DT0xMRUNUSU9OLmxlbmd0aCk7CiAgICAgICAgaWYgKCFPUFRJT05TLmRpc3BsYXlQYWdlQ291bnQpIHsKICAgICAgICAgICAgcGFnZUNvdW50RGl2LmFkZENsYXNzKCdoaWRkZW4nKTsKICAgICAgICB9CiAgICB9Cn0KCmZ1bmN0aW9uIHJlbW92ZVBhZ2VDb3VudCgpIHsKICAgICQoJy5ocnotcGFnZS1jb3VudCcpLnJlbW92ZSgpOwp9CgpmdW5jdGlvbiB1cGRhdGVQYWdlQ291bnQoKSB7CiAgICAkKCcjaHJ6LWN1cnJlbnQtcGFnZScpLmh0bWwoUEFHRV9DT0xMRUNUSU9OLmN1cnJlbnRQYWdlKTsKfQoKLyoqCiAqICsgSm9uYXMgUmFvbmkgU29hcmVzIFNpbHZhCiAqIEAgaHR0cDovL2pzZnJvbWhlbGwuY29tL2FycmF5L3NodWZmbGUgW3YxLjBdCiAqIEBwYXJhbSBvCiAqIEByZXR1cm5zIHsqfQogKi8KZnVuY3Rpb24gc2h1ZmZsZShvKXsKICAgIGZvcih2YXIgaiwgeCwgaSA9IG8ubGVuZ3RoOyBpOyBqID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogaSksIHggPSBvWy0taV0sIG9baV0gPSBvW2pdLCBvW2pdID0geCk7CiAgICByZXR1cm4gbzsKfQoKZnVuY3Rpb24gbm9vcCgpIHt9Ci8qKgogKiBXaGVuIHRoZSB3aW5kb3cgaXMgcmUtc2l6ZWQsIHdlIG5lZWQgdG8gcmUtY2FsY3VsYXRlIHRoZSBsYXlvdXQgb2YgdGhlIGFsbCB0aGUgZWxlbWVudHMuCiAqIFRvIGVuc3VyZSB0aGF0IHdlIGdldCB0aGUgc2FtZSByZXN1bHRzIGFzIHRoZSBpbml0aWFsIGxvYWQsIHdlIHNpbXBsZSBwdXJnZSB0aGUgZW50aXJlIFJPT1QgZWxlbWVudAogKiBhbmQgcmVwbGFjZSBpdCB3aXRoIHRoZSBjbG9uZSB0aGF0IHdlIG1hZGUgcmlnaHQgYXQgdGhlIHN0YXJ0IG9mIHRoZSBpbml0KCkgbWV0aG9kLgogKi8KZnVuY3Rpb24gcmVzaXplSGFuZGxlcigpIHsKICAgIGRlYm91bmNlKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjdXJyZW50U2Nyb2xsID0gUEFHRV9DT0xMRUNUSU9OLmdldEN1cnJlbnQoKS5ub2Rlc1swXS5sYXlvdXQudG9wIC8gT1BUSU9OUy5zY3JvbGxiYXJTaG9ydGVuUmF0aW87CiAgICAgICAgUk9PVC5yZXBsYWNlV2l0aChST09UX0NMT05FLmNsb25lKCkpOwogICAgICAgIGNvbXBvc2VQYWdlKGN1cnJlbnRTY3JvbGwpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICQod2luZG93KS5zY3JvbGxUb3AoY3VycmVudFNjcm9sbCk7CiAgICAgICAgICAgIHVwZGF0ZVBhZ2VDb3VudCgpOwogICAgICAgICAgICBPUFRJT05TLm9uUmVzaXplKCk7CiAgICAgICAgfSk7CiAgICB9LCAyNTApKCk7Cn0KCi8qKgogKiBBbGxvdyBrZXlib2FyZCBwYWdpbmcgd2l0aCB0aGUgYXJyb3cga2V5cy4KICogQHBhcmFtIGUKICovCmZ1bmN0aW9uIGtleWRvd25IYW5kbGVyKGUpIHsKICAgIGlmIChlLndoaWNoID09PSA0MCB8fCBlLndoaWNoID09PSAzOSkgewogICAgICAgIHNjcm9sbFRvTmV4dFBhZ2UoKTsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB9IGVsc2UgaWYgKGUud2hpY2ggPT09IDM4IHx8IGUud2hpY2ggPT09IDM3KSB7CiAgICAgICAgc2Nyb2xsVG9QcmV2aW91c1BhZ2UoKTsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB9Cn0KCi8qKgogKiBXaGVuIHRoZSB2ZXJ0aWNhbCBzY3JvbGxiYXIgaXMgZW5hYmxlZCwgd2Ugd2FudCB0byB0cmlnZ2VyIHBhZ2UgY2hhbmdlcyBhdCB0aGUgYXBwcm9wcmlhdGUgcG9pbnRzLAogKiB3aGVyZSB0aGF0IHBhZ2Ugd291bGQgaGF2ZSBiZWVuIGluIGEgcmVndWxhciBzY3JvbGxpbmcgSFRNTCBwYWdlLgogKi8KZnVuY3Rpb24gc2Nyb2xsSGFuZGxlcigpIHsKICAgIGlmICh0eXBlb2YgUEFHRV9DT0xMRUNUSU9OICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHZhciBzY3JvbGxUb3AgPSAkKHdpbmRvdykuc2Nyb2xsVG9wKCk7CiAgICAgICAgdmFyIGN1cnJlbnRQYWdlTnVtYmVyID0gUEFHRV9DT0xMRUNUSU9OLmN1cnJlbnRQYWdlOwoKICAgICAgICB2YXIgbmV3UGFnZU51bWJlciA9IFBBR0VfQ09MTEVDVElPTi5nZXRQYWdlQXRPZmZzZXQoc2Nyb2xsVG9wICogT1BUSU9OUy5zY3JvbGxiYXJTaG9ydGVuUmF0aW8pLnBhZ2VOdW1iZXI7CiAgICAgICAgaWYgKG5ld1BhZ2VOdW1iZXIgIT09IGN1cnJlbnRQYWdlTnVtYmVyKSB7CiAgICAgICAgICAgIFBBR0VfQ09MTEVDVElPTi5zaG93UGFnZShuZXdQYWdlTnVtYmVyKTsKICAgICAgICAgICAgdXBkYXRlUGFnZUNvdW50KCk7CiAgICAgICAgfQogICAgfQp9Cgp2YXIgX21vdXNld2hlZWxMYXN0RXZlbnQ7Ci8qKgogKiBIYW5kbGVyIHRvIHRocm90dGxlIHRoZSBhY3Rpb24gb2YgYSBzY3JvbGwgd2hlZWwgb24gYSBtb3VzZS9sYXB0b3AgdHJhY2twYWQuIFRoaXMgcHJldmVudHMKICogcGFnZXMgYmVpbmcgc2tpcHBlZCB3aGVuIGEgZmFzdCBzY3JvbGwgbW90aW9uIGlzIHBlcmZvcm1lZC4KICogQHBhcmFtIGUKICovCmZ1bmN0aW9uIG1vdXNld2hlZWxIYW5kbGVyKGUpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKCiAgICB2YXIgbm93ID0gIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoKICAgIGlmICgyNTAgPCBub3cgLSBfbW91c2V3aGVlbExhc3RFdmVudCB8fCAhX21vdXNld2hlZWxMYXN0RXZlbnQpIHsKICAgICAgICB2YXIgZGVsdGFZID0gZS5vcmlnaW5hbEV2ZW50LmRlbHRhWTsKICAgICAgICBfbW91c2V3aGVlbExhc3RFdmVudCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoKICAgICAgICBpZiAoZGVsdGFZIDwgMCkgewogICAgICAgICAgICBzY3JvbGxUb1ByZXZpb3VzUGFnZSgpOwogICAgICAgIH0gZWxzZSBpZiAoMCA8IGRlbHRhWSkgewogICAgICAgICAgICBzY3JvbGxUb05leHRQYWdlKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoMjUwIDwgbm93IC0gX21vdXNld2hlZWxMYXN0RXZlbnQpIHsKICAgICAgICAgICAgX21vdXNld2hlZWxMYXN0RXZlbnQgPSBudWxsOwogICAgICAgIH0KICAgIH0KfQoKLyoqCiAqIFRvIGFsbG93IFVSTCBmcmFnbWVudHMgKCMpIHRvIHdvcmssIHdlIG5lZWQgdG8gZmluZCB0aGUgbG9jYXRpb24gb2YgdGhlIGVsZW1lbnQgd2l0aCB0aGUgSUQKICogbWF0Y2hpbmcgdGhlIGZyYWdtZW50LCBmaWd1cmUgb3V0IHdoYXQgcGFnZSBpdCBpcyBvbiwgYW5kIHRoZW4gZ28gdG8gdGhhdCBwYWdlLgogKi8KZnVuY3Rpb24gaGFzaENoYW5nZUhhbmRsZXIoKSB7CiAgICB2YXIgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoOwogICAgaWYgKGhhc2ggIT09ICcnKSB7CiAgICAgICAgdmFyIHBhZ2UgPSAkKGhhc2gpLmNsb3Nlc3QoJy5ocnotcGFnZScpOwogICAgICAgIHZhciBwYWdlTnVtYmVyID0gcGFyc2VJbnQocGFnZS5hdHRyKCdpZCcpLnJlcGxhY2UoL15cRCsvZywgJycpKTsKICAgICAgICBQQUdFX0NPTExFQ1RJT04uc2hvd1BhZ2UocGFnZU51bWJlcik7CiAgICAgICAgJCh3aW5kb3cpLnNjcm9sbFRvcChQQUdFX0NPTExFQ1RJT04uZ2V0Q3VycmVudCgpLm1pZFBvaW50KTsKICAgICAgICB1cGRhdGVQYWdlQ291bnQoKTsKICAgIH0KfQoKLyoqCiAqIFRoaXMgZXZlbnQgaGFuZGxlciBpcyBmb3IgdGhlIHBhcnRpY3VsYXIgc2NlbmFyaW8gb2Ygd2hlbiBhIGxpbmsgdG8gYSBVUkwgZnJhZ21lbnQgaW4gdGhpcyBkb2N1bWVudCBpcyBjbGlja2VkLAogKiBidXQgdGhhdCBmcmFnbWVudCBpcyBhbHJlYWR5IGluIHRoZSBoYXNoIHBhcnQgb2YgdGhlIHdpbmRvdy5sb2NhdGlvbi4gSW4gdGhpcyBjYXNlLCB0aGUgaGFzaCB3aWxsIG5vdCBjaGFuZ2Ugc28KICogd2UgbmVlZCB0byBtYW51YWxseSB0cmlnZ2VyIHRoZSBoYXNoY2hhbmdlIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBleHBlY3RlZCBiZWhhdmlvdXIuCiAqLwpmdW5jdGlvbiBsaW5rSGFuZGxlcihlKSB7CiAgICB2YXIgY3VycmVudEhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaDsKICAgIGlmIChjdXJyZW50SGFzaCAhPT0gJycpIHsKICAgICAgICB2YXIgdXJsID0gJCh0aGlzKS5hdHRyKCdocmVmJyk7CiAgICAgICAgaWYgKHVybC5zdWJzdHIoMCwgMSkgPT09ICcjJykgewogICAgICAgICAgICBpZiAodXJsID09PSBjdXJyZW50SGFzaCkgewogICAgICAgICAgICAgICAgaGFzaENoYW5nZUhhbmRsZXIoKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKdmFyIF90b3VjaFN0YXJ0UG9zOwp2YXIgX3RvdWNoU3RhcnRUaW1lOwovKioKICogQXQgdGhlIHN0YXJ0IG9mIGEgdG91Y2ggd2Ugc2ltcGx5IG5lZWQgdG8gcmVjb3JkIHRoZSB0aW1lIGFuZCBwb3NpdGlvbiBvZiB0aGUgdG91Y2gsCiAqIHRvIHVzZSBsYXRlciBpbiB3b3JraW5nIG91dCBob3cgdG8gaGFuZGxlIGl0LgogKiBAcGFyYW0gZQogKi8KZnVuY3Rpb24gdG91Y2hzdGFydEhhbmRsZXIoZSkgewogICAgaWYgKGlzVmFsaWRUb3VjaEV2ZW50KGUpKSB7CiAgICAgICAgX3RvdWNoU3RhcnRQb3MgPSAgewogICAgICAgICAgICB4OiBnZXRUb3VjaFgoZSksCiAgICAgICAgICAgIHk6IGdldFRvdWNoWShlKQogICAgICAgIH07CiAgICAgICAgX3RvdWNoU3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB9Cn0KCi8qKgogKiBXZSBwcmV2ZW50IHRoZSBkZWZhdWx0IHRvdWNobW92ZSBiZWhhdmlvdXIgYmVjYXVzZSB3ZSBkb24ndCB3YW50IHRoZSBwYWdlIHRvIHNjcm9sbCBuYXR1cmFsbHkgLSB3ZQogKiB3YW50IHRvIGNvbnRyb2wgdGhlIHNjcm9sbGluZyBwcm9ncmFtbWF0aWNhbGx5IHRvIGVuc3VyZSBvbmx5IG9uZSBwYWdlIGlzIGFkdmFuY2VkIHBlciBzd2lwZS4KICogQHBhcmFtIGUKICovCmZ1bmN0aW9uIHRvdWNobW92ZUhhbmRsZXIoZSkgewogICAgaWYgKGlzVmFsaWRUb3VjaEV2ZW50KGUpKSB7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICB2YXIgdG91Y2hFbmRQb3MgPSB7CiAgICAgICAgICAgIHg6IGdldFRvdWNoWChlKSwKICAgICAgICAgICAgeTogZ2V0VG91Y2hZKGUpCiAgICAgICAgfTsKICAgICAgICB2YXIgdG91Y2hFbmRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CgogICAgICAgIGlmIChpc1ZhbGlkU3dpcGUoX3RvdWNoU3RhcnRUaW1lLCB0b3VjaEVuZFRpbWUsIF90b3VjaFN0YXJ0UG9zLCB0b3VjaEVuZFBvcykpIHsKICAgICAgICAgICAgdmFyIGRpcmVjdGlvbiA9IGdldFN3aXBlRGlyZWN0aW9uKF90b3VjaFN0YXJ0UG9zLCB0b3VjaEVuZFBvcyk7CiAgICAgICAgICAgIHN3aXRjaCAoZGlyZWN0aW9uKSB7CiAgICAgICAgICAgICAgICBjYXNlICd1cCc6CiAgICAgICAgICAgICAgICAgICAgQ09OVEFJTkVSLmNzcygndG9wJywgJy0zMHB4Jyk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdkb3duJzoKICAgICAgICAgICAgICAgICAgICBDT05UQUlORVIuY3NzKCd0b3AnLCAnMzBweCcpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnbGVmdCc6CiAgICAgICAgICAgICAgICAgICAgQ09OVEFJTkVSLmNzcygnbGVmdCcsICctMzBweCcpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAncmlnaHQnOgogICAgICAgICAgICAgICAgICAgIENPTlRBSU5FUi5jc3MoJ2xlZnQnLCAnMzBweCcpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovKioKICogQXQgdGhlIGVuZCBvZiB0aGUgdG91Y2gsIHdlIGFnYWluIHJlY29yZCB0aGUgdGltZSBhbmQgcG9zaXRpb24sIGFuZCB0aGVuIHVzZSB0aGVzZSBkYXRhIHRvIGZpZ3VyZSBvdXQKICogaWYgd2Ugc2hvdWxkIHRyZWF0IHRoaXMgYXMgYSAic3dpcGUiLCBhbmQgaWYgc28sIGluIHdoYXQgZGlyZWN0aW9uIHRoZSBzd2lwZSB3YXMuIFRoZW4gd2UgY2FuCiAqIG1vdmUgdG8gdGhlIG5leHQgb3IgcHJldmlvdXMgcGFnZSBhcyBhcHByb3ByaWF0ZS4KICogQHBhcmFtIGUKICovCmZ1bmN0aW9uIHRvdWNoZW5kSGFuZGxlcihlKSB7CiAgICBpZiAoaXNWYWxpZFRvdWNoRXZlbnQoZSkpIHsKICAgICAgICB2YXIgc2Nyb2xsVG87CiAgICAgICAgdmFyIHRvdWNoRW5kUG9zID0gewogICAgICAgICAgICB4OiBnZXRUb3VjaFgoZSksCiAgICAgICAgICAgIHk6IGdldFRvdWNoWShlKQogICAgICAgIH07CiAgICAgICAgdmFyIHRvdWNoRW5kVGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoKICAgICAgICBDT05UQUlORVIuY3NzKCd0b3AnLCAnMHB4Jyk7CiAgICAgICAgQ09OVEFJTkVSLmNzcygnbGVmdCcsICcwcHgnKTsKCiAgICAgICAgaWYgKGlzVmFsaWRTd2lwZShfdG91Y2hTdGFydFRpbWUsIHRvdWNoRW5kVGltZSwgX3RvdWNoU3RhcnRQb3MsIHRvdWNoRW5kUG9zKSkgewogICAgICAgICAgICB2YXIgZGlyZWN0aW9uID0gZ2V0U3dpcGVEaXJlY3Rpb24oX3RvdWNoU3RhcnRQb3MsIHRvdWNoRW5kUG9zKTsKICAgICAgICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gImRvd24iIHx8IGRpcmVjdGlvbiA9PT0gInJpZ2h0IikgewogICAgICAgICAgICAgICAgc2Nyb2xsVG9QcmV2aW91c1BhZ2UoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNjcm9sbFRvTmV4dFBhZ2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkKHdpbmRvdykuc2Nyb2xsVG9wKHNjcm9sbFRvKTsKICAgICAgICB9CiAgICB9Cn0KCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ci8vCi8vIFV0aWxpdHkgZnVuY3Rpb25zIHVzZWQgYnkgdGhlIGV2ZW50IGhhbmRsZXJzCi8vCi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgovKioKICogVGhlIHdheSB0aGUgZXZlbnQgaGFuZGxlcnMgY2hhbmdlIGZyb20gb25lIHBhZ2UgdG8gdGhlIG5leHQgaXMgYnkKICogc2V0dGluZyB0aGUgdmFsdWUgb2Ygd2luZG93LnNjcm9sbFRvcCwgYW5kIHRoZW4gbGV0dGluZyB0aGUKICogc2Nyb2xsIGhhbmRsZXIgdGFrZSBjYXJlIG9mIGFjdHVhbGx5IGRvaW5nIHRoZSB0cmFuc2l0aW9uCiAqLwpmdW5jdGlvbiBzY3JvbGxUb05leHRQYWdlKCkgewogICAgdmFyIHNjcm9sbFRvOwogICAgaWYgKFBBR0VfQ09MTEVDVElPTi5jdXJyZW50UGFnZSA8IFBBR0VfQ09MTEVDVElPTi5sZW5ndGgpIHsKICAgICAgICBzY3JvbGxUbyA9IFBBR0VfQ09MTEVDVElPTi5nZXROZXh0KCkubWlkUG9pbnQ7CiAgICAgICAgJCh3aW5kb3cpLnNjcm9sbFRvcChzY3JvbGxUbyk7CiAgICB9Cn0KCmZ1bmN0aW9uIHNjcm9sbFRvUHJldmlvdXNQYWdlKCkgewogICAgdmFyIHNjcm9sbFRvOwogICAgaWYgKFBBR0VfQ09MTEVDVElPTi5jdXJyZW50UGFnZSA9PT0gMikgewogICAgICAgIHNjcm9sbFRvID0gMDsKICAgIH0gZWxzZSBpZiAoMSA8IFBBR0VfQ09MTEVDVElPTi5jdXJyZW50UGFnZSkgewogICAgICAgIHNjcm9sbFRvID0gUEFHRV9DT0xMRUNUSU9OLmdldFByZXZpb3VzKCkubWlkUG9pbnQ7CiAgICB9CiAgICBpZiAodHlwZW9mIHNjcm9sbFRvICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICQod2luZG93KS5zY3JvbGxUb3Aoc2Nyb2xsVG8pOwogICAgfQp9CgovKioKICogV2Ugd2FudCB0byBwcmV2ZW50IHRoZSByZXNpemVIYW5kbGVyIGJlaW5nIGNhbGxlZCB0b28gb2Z0ZW4gYXMgdGhlIHBhZ2UgaXMgcmUtc2l6ZWQuCiAqIEBwYXJhbSBmdW4KICogQHBhcmFtIG1pbAogKiBAcmV0dXJucyB7RnVuY3Rpb259CiAqLwpmdW5jdGlvbiBkZWJvdW5jZShmdW4sIG1pbCl7CiAgICB2YXIgdGltZXI7CiAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpOwogICAgICAgIHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICBmdW4uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICB9LCBtaWwpOwogICAgfTsKfQoKLyoqCiAqIEludGVybmV0IEV4cGxvcmVyIHVzZXMgdGhlIFBvaW50ZXIgRXZlbnRzIG1vZGVsIGZvciBib3RoIHRvdWNoIGFuZCBtb3VzZSBldmVudHMuIFRoZXJlZm9yZSwgd2hlbiB3ZSBiaW5kIHRvIHRoZQogKiAncG9pbnRlcmRvd24nLCAncG9pbnRlcnVwJyBldGMuIGV2ZW50cywgdGhleSB3aWxsIGFsc28gYmUgZmlyZWQgd2hlbiB0aGUgbW91c2UgaXMgY2xpY2tlZCwgd2hpY2ggd2UgZG8gbm90IHdhbnQuCiAqIFRoZXJlZm9yZSB3ZSBmaWx0ZXIgb3V0IHRoZSBldmVudHMgdGhhdCBhcmUgdHJpZ2dlcmVkIGJ5IG1vdXNlLgogKiBAcGFyYW0gZQogKiBAcmV0dXJucyB7Ym9vbGVhbn0KICovCmZ1bmN0aW9uIGlzVmFsaWRUb3VjaEV2ZW50KGUpIHsKICAgIGlmIChlLm9yaWdpbmFsRXZlbnQuaGFzT3duUHJvcGVydHkoJ3BvaW50ZXJUeXBlJykpIHsKICAgICAgICBpZiAoZS5vcmlnaW5hbEV2ZW50LnBvaW50ZXJUeXBlID09PSAnbW91c2UnKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQoKLyoqCiAqIFRvIGJlIHZhbGlkLCBhIHN3aXBlIG11c3QgdHJhdmVsIGEgc3VmZmljaWVudCBkaXN0YW5jZSBhY3Jvc3MgdGhlIHNjcmVlbiAodG8gZGlzdGluZ3Vpc2ggZnJvbSBzbG9wcHkKICogY2xpY2tzKSwgYW5kIG11c3QgYmUgZmFpcmx5IGZhc3QgKHRvIGRpc3Rpbmd1aXNoIGZyb20gaGlnaGxpZ2h0aW5nIHRleHQgYXR0ZW1wdHMpCiAqIEBwYXJhbSBzdGFydFRpbWUKICogQHBhcmFtIGVuZFRpbWUKICogQHBhcmFtIHN0YXJ0UG9zCiAqIEBwYXJhbSBlbmRQb3MKICovCmZ1bmN0aW9uIGlzVmFsaWRTd2lwZShzdGFydFRpbWUsIGVuZFRpbWUsIHN0YXJ0UG9zLCBlbmRQb3MpIHsKICAgIHZhciBNQVhfSU5URVJWQUwgPSA3MDA7CiAgICB2YXIgTUlOX0RJU1RBTkNFID0gNzU7CiAgICB2YXIgdGltZUludGVydmFsID0gZW5kVGltZSAtIHN0YXJ0VGltZTsKICAgIHZhciBkWCA9IGVuZFBvcy54IC0gc3RhcnRQb3MueDsKICAgIHZhciBkWSA9IGVuZFBvcy55IC0gc3RhcnRQb3MueTsKICAgIHZhciBzd2lwZURpc3RhbmNlID0gTWF0aC5zcXJ0KGRYICogZFggKyBkWSAqIGRZKTsKCiAgICBpZiAoTUFYX0lOVEVSVkFMIDwgdGltZUludGVydmFsIHx8CiAgICAgICAgc3dpcGVEaXN0YW5jZSA8IE1JTl9ESVNUQU5DRSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9Cn0KCi8qKgogKiBHaXZlbiBhIHBhaXIgb2YgY29vcmRpbmF0ZXMgY29ycmVzcG9uZGluZyB0byB0aGUgc3RhcnQgYW5kIGVuZCBwb3NpdGlvbnMgb2YgdGhlIHN3aXBlLCB3ZSBjYW4KICogY2FsY3VsYXRlIGEgdmVjdG9yIGFuZCBpdHMgYW5nbGUgcmVsYXRpdmUgdG8gdGhlIHgtYXhpcy4gVXNpbmcgdGhpcyBpbmZvcm1hdGlvbiB3ZSBjYW4gZmlndXJlCiAqIG91dCB0aGUgZGlyZWN0aW9uIG9mIHRoZSBzd2lwZSAodXAsIGRvd24sIGxlZnQgb3IgcmlnaHQpLgogKiBAcGFyYW0gc3RhcnRQb3MKICogQHBhcmFtIGVuZFBvcwogKiBAcmV0dXJucyB7Kn0KICovCmZ1bmN0aW9uIGdldFN3aXBlRGlyZWN0aW9uKHN0YXJ0UG9zLCBlbmRQb3MpIHsKICAgIHZhciBkWCA9IGVuZFBvcy54IC0gc3RhcnRQb3MueDsKICAgIHZhciBkWSA9IGVuZFBvcy55IC0gc3RhcnRQb3MueTsKICAgIHZhciBhbmdsZSA9IE1hdGguYXRhbjIoZFksIGRYKTsKICAgIHZhciBkaXJlY3Rpb247CiAgICBpZiAoLU1hdGguUEkvNCA8IGFuZ2xlICYmIGFuZ2xlIDw9IE1hdGguUEkvNCkgewogICAgICAgIGRpcmVjdGlvbiA9ICJyaWdodCI7CiAgICB9IGVsc2UgaWYgKC0zLzQqTWF0aC5QSSA8IGFuZ2xlICYmIGFuZ2xlIDw9IC1NYXRoLlBJLzQpIHsKICAgICAgICBkaXJlY3Rpb24gPSAidXAiOwogICAgfSBlbHNlIGlmICgzLzQqTWF0aC5QSSA8IGFuZ2xlIHx8IGFuZ2xlIDwgLTMvNCpNYXRoLlBJKSB7CiAgICAgICAgZGlyZWN0aW9uID0gImxlZnQiOwogICAgfSBlbHNlIHsKICAgICAgICBkaXJlY3Rpb24gPSAiZG93biI7CiAgICB9CiAgICByZXR1cm4gZGlyZWN0aW9uOwp9CgovKioKICogSW50ZXJuZXQgRXhwbG9yZXIgdXNlcyBhIGRpZmZlcmVudCBtb2RlbCBmb3IgdG91Y2ggZXZlbnRzIGZyb20gV2Via2l0IGJyb3dzZXJzIGFuZCBvdGhlcnMsCiAqIHNvIHdlIG5lZWQgdG8gZG8gYSBzbWFsbCBjaGVjayB0byBnZXQgdGhlIGNvcnJlY3QgcG9zaXRpb25zIG9mIHRvdWNoIGV2ZW50cy4KICogQHBhcmFtIGUKICogQHJldHVybnMgeyp9CiAqLwpmdW5jdGlvbiBnZXRUb3VjaFgoZSkgewogICAgdmFyIHg7CiAgICBpZiAoZS5vcmlnaW5hbEV2ZW50Lmhhc093blByb3BlcnR5KCdjaGFuZ2VkVG91Y2hlcycpKSB7CiAgICAgICAgeCA9IGUub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlc1swXS5jbGllbnRYOwogICAgfSBlbHNlIHsKICAgICAgICB4ID0gZS5vcmlnaW5hbEV2ZW50LmNsaWVudFg7CiAgICB9CiAgICByZXR1cm4geDsKfQoKZnVuY3Rpb24gZ2V0VG91Y2hZKGUpIHsKICAgIHZhciB5OwogICAgaWYgKGUub3JpZ2luYWxFdmVudC5oYXNPd25Qcm9wZXJ0eSgnY2hhbmdlZFRvdWNoZXMnKSkgewogICAgICAgIHkgPSBlLm9yaWdpbmFsRXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0uY2xpZW50WTsKICAgIH0gZWxzZSB7CiAgICAgICAgeSA9IGUub3JpZ2luYWxFdmVudC5jbGllbnRZOwogICAgfQogICAgcmV0dXJuIHk7Cn0KLyoqCiAqIEEgaGVscGVyIHNlcnZpY2UgZm9yIEphdmFTY3JpcHQtYmFzZWQgdHJhbnNpdGlvbiBhbmltYXRpb25zLiBVc2luZyB0aGlzIHNlcnZpY2UgZW5zdXJlcyB0aGF0IG9ubHkgYSBzaW5nbGUKICogcmVxdWVzdEFuaW1hdGlvbkZyYW1lIGxvb3AgaXMgY3JlYXRlZCwgYW5kIGFsbCBhbmltYXRpb24gZnVuY3Rpb25zIGFyZSBleGVjdXRlZCB3aXRoaW4gdGhpcyBzaW5nbGUgbG9vcC4KICoKICogVGhlIGBhbmltYXRvcmAgb2JqZWN0IGlzIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byB0aGUgY2FsbGJhY2sgZnVuY3Rpb25zIGRlZmluZWQgaW4gdGhlIGNvbmZpZyBvYmplY3QuCiAqLwp2YXIgYW5pbWF0b3IgPSBmdW5jdGlvbigpIHsKICAgIHZhciBtb2R1bGUgPSB7fTsKICAgIHZhciBhbmltYXRpb25GdW5jdGlvbnMgPSBbXTsKCiAgICBtb2R1bGUuc3RhcnQgPSBmdW5jdGlvbihmbikgewogICAgICAgIGFuaW1hdGlvbkZ1bmN0aW9ucy5wdXNoKGZuKTsKICAgICAgICBpZiAoYW5pbWF0aW9uRnVuY3Rpb25zLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRpY2spOwogICAgICAgIH0KICAgIH07CgogICAgbW9kdWxlLnN0b3AgPSBmdW5jdGlvbihmbikgewogICAgICAgIGFuaW1hdGlvbkZ1bmN0aW9ucy5zcGxpY2UoYW5pbWF0aW9uRnVuY3Rpb25zLmluZGV4T2YoZm4pLCAxKTsKICAgIH07CgogICAgZnVuY3Rpb24gdGljayh0aW1lc3RhbXApIHsKICAgICAgICBhbmltYXRpb25GdW5jdGlvbnMuZm9yRWFjaChmdW5jdGlvbihmbikgewogICAgICAgICAgICBmbi5jYWxsKGZuLCB0aW1lc3RhbXApOwogICAgICAgIH0pOwogICAgICAgIGlmICgwIDwgYW5pbWF0aW9uRnVuY3Rpb25zLmxlbmd0aCkgewogICAgICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRpY2spOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbW9kdWxlOwp9KCk7Ci8qKgogKiBBIE5vZGUgb2JqZWN0IHJlcHJlc2VudHMgYSBET00gZWxlbWVudC4gQW4gYWN0dWFsIHJlZmVyZW5jZSB0byB0aGUgSFRNTEVsZW1lbnQgb2JqZWN0IGlzIGNvbnRhaW5lZCBpbiB0aGUgJ2RvbU5vZGUnIHByb3BlcnR5LgogKiBAcGFyYW0gZG9tTm9kZQogKiBAcGFyYW0gaW5kZXgKICogQGNvbnN0cnVjdG9yCiAqLwpmdW5jdGlvbiBOb2RlKGRvbU5vZGUsIGluZGV4KSB7CiAgICB0aGlzLmRvbU5vZGUgPSBkb21Ob2RlOwogICAgdGhpcy5pbmRleCA9IGluZGV4OwogICAgdGhpcy5pc0Nsb25lID0gZmFsc2U7CiAgICB0aGlzLmxheW91dCA9IHRoaXMuZ2V0TGF5b3V0KCk7CiAgICB0aGlzLmlzVGFsbCA9IGZhbHNlOwogICAgdGhpcy5wYWdlT3ZlcmhhbmcgPSAwOwogICAgdGhpcy5vcmlnaW5hbENvbXB1dGVkU3R5bGUgPSB0aGlzLmNsb25lQ29tcHV0ZWRTdHlsZSgpOwogICAgdGhpcy5zdGFnZ2VyT3JkZXIgPSAwOwp9CgpOb2RlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICAqIEluIG9yZGVyIHRvIGVuc3VyZSBhIGZhaXRoZnVsIHZpc3VhbCByZXByb2R1Y3Rpb24gb2YgdGhlIG9yaWdpbmFsIHBhZ2UsIGJlZm9yZSB3ZSBkbyBhbnl0aGluZyB3aXRoIHRoZSBET00sIHdlCiAgICAgKiBuZWVkIHRvIHN0b3JlIGEgY29weSBvZiAqYWxsKiBvZiB0aGUgY29tcHV0ZWQgQ1NTIHN0eWxlIHJ1bGVzIHRoYXQgYXBwbHkgdG8gdGhpcyBET00gbm9kZS4gV2Ugd2lsbCB1c2UgdGhpcwogICAgICogaW5mb3JtYXRpb24gYXQgdGhlIGZpbmFsIHJlbmRlcmluZyBzdGVwIGluIG9yZGVyIHRvIHBlcmZvcm0gYSBkaWZmIGFuZCBpbmxpbmUgYW55IGNoYW5nZWQgc3R5bGVzLgogICAgICogQHJldHVybnMgeyp9CiAgICAgKi8KICAgIGNsb25lQ29tcHV0ZWRTdHlsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGNvbXB1dGVkU3R5bGVDbG9uZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLnN0eWxlOwogICAgICAgIHZhciBjb21wdXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUodGhpcy5kb21Ob2RlKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbXB1dGVkU3R5bGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBjb21wdXRlZFN0eWxlW2ldOwogICAgICAgICAgICBjb21wdXRlZFN0eWxlQ2xvbmUuc2V0UHJvcGVydHkobmFtZSwKICAgICAgICAgICAgICAgIGNvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShuYW1lKSwKICAgICAgICAgICAgICAgIGNvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlQcmlvcml0eShuYW1lKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb21wdXRlZFN0eWxlQ2xvbmU7CiAgICB9LAoKICAgIC8qKgogICAgICogQ2FsY3VsYXRlIHRoZSBib3VuZGluZyBib3ggYW5kIGFic29sdXRlIHBvc2l0aW9uIG9mIHRoZSBub2RlIGFuZCByZXR1cm4gaXQgYXMgYW4gb2JqZWN0LgogICAgICogQHJldHVybnMge3t0b3A6IG51bWJlciwgbGVmdDogbnVtYmVyLCBib3R0b206IG51bWJlciwgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXJ9fQogICAgICovCiAgICBnZXRMYXlvdXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciAkbm9kZSA9ICQodGhpcy5kb21Ob2RlKSwKICAgICAgICAgICAgbGVmdCA9ICRub2RlLm9mZnNldCgpLmxlZnQgLSBST09ULm9mZnNldCgpLmxlZnQsCiAgICAgICAgICAgIHRvcCA9ICRub2RlLm9mZnNldCgpLnRvcCAtIFJPT1Qub2Zmc2V0KCkudG9wIC0gcGFyc2VJbnQoJG5vZGUuY3NzKCdtYXJnaW4tdG9wJykpLAogICAgICAgICAgICB3aWR0aCA9ICRub2RlLndpZHRoKCkgKyBwYXJzZUludCgkbm9kZS5jc3MoJ3BhZGRpbmctbGVmdCcpKSArIHBhcnNlSW50KCRub2RlLmNzcygncGFkZGluZy1yaWdodCcpKSwKICAgICAgICAgICAgaGVpZ2h0ID0gJG5vZGUuaGVpZ2h0KCkgKyBwYXJzZUludCgkbm9kZS5jc3MoJ3BhZGRpbmctdG9wJykpICsgcGFyc2VJbnQoJG5vZGUuY3NzKCdwYWRkaW5nLWJvdHRvbScpKSwKICAgICAgICAgICAgYm90dG9tID0gdG9wICsgaGVpZ2h0OwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0b3A6IHRvcCwKICAgICAgICAgICAgbGVmdDogbGVmdCwKICAgICAgICAgICAgYm90dG9tOiBib3R0b20sCiAgICAgICAgICAgIHdpZHRoOiB3aWR0aCwKICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQKICAgICAgICB9OwogICAgfSwKCiAgICAvKioKICAgICAqIFdoZW4gYSBub2RlIGlzIG92ZXIgaGFsZiB0aGUgaGVpZ2h0IG9mIHRoZSB2aWV3cG9ydCwgYW5kIGFsc28gZXh0ZW5kcyBvZmYgdGhlIGJvdHRvbSBvZiBhIGdpdmVuIHBhZ2UsCiAgICAgKiB3ZSBuZWVkIHRvIGNsb25lIGl0IGFuZCBwdXQgdGhlIGNsb25lIG9uIHRoZSBuZXh0IHBhZ2UsIHRvIGdpdmUgdGhlIGltcHJlc3Npb24gdGhhdCB0aGUgbm9kZSBpcyBzcGFubmluZwogICAgICogdHdvIChvciBtb3JlKSBwYWdlcy4gRGVwZW5kaW5nIG9uIHRoZSBoZWlnaHQgb2YgdGhlIG5vZGUsIGl0IHdpbGwgYmUgY2xvbmVkIGhvd2V2ZXIgbWFueSB0aW1lcyBhcmUKICAgICAqIHJlcXVpcmVkIHRvIGFsbG93IHRoZSBlbnRpcmUgbm9kZSB0byBiZSBkaXNwbGF5ZWQgb3ZlciBzdWNjZXNzaXZlIHBhZ2VzLgogICAgICogQHBhcmFtIGluZGV4CiAgICAgKi8KICAgIG1ha2VDbG9uZTogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICB2YXIgY2xvbmVkRG9tTm9kZSA9ICQodGhpcy5kb21Ob2RlKS5jbG9uZSgpWzBdOwogICAgICAgIHZhciBjbG9uZSA9IG5ldyBOb2RlKGNsb25lZERvbU5vZGUsIGluZGV4KTsKICAgICAgICBjbG9uZS5sYXlvdXQgPSB7CiAgICAgICAgICAgICd0b3AnIDogdGhpcy5sYXlvdXQudG9wLAogICAgICAgICAgICAnbGVmdCcgOiB0aGlzLmxheW91dC5sZWZ0LAogICAgICAgICAgICAnd2lkdGgnIDogdGhpcy5sYXlvdXQud2lkdGgsCiAgICAgICAgICAgICdoZWlnaHQnIDogdGhpcy5sYXlvdXQuaGVpZ2h0LAogICAgICAgICAgICAnYm90dG9tJyA6IHRoaXMubGF5b3V0LmJvdHRvbQogICAgICAgIH07CiAgICAgICAgY2xvbmUuaXNDbG9uZSA9IHRydWU7CgogICAgICAgIHJldHVybiBjbG9uZTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBBcHBlbmQgdGhlIERPTSBub2RlIHRvIHRoZSBjb3JyZWN0IHBhZ2UgZGl2CiAgICAgKiBAcGFyYW0gcGFyZW50UGFnZQogICAgICovCiAgICBhcHBlbmRUb0RvbTogZnVuY3Rpb24ocGFyZW50UGFnZSkgewogICAgICAgICQodGhpcy5kb21Ob2RlKS5hZGRDbGFzcyhwYXJlbnRQYWdlLnBhZ2VJZCk7CiAgICAgICAgQ09OVEFJTkVSLmZpbmQoJyMnICsgcGFyZW50UGFnZS5wYWdlSWQpLmFwcGVuZCh0aGlzLmRvbU5vZGUpOwogICAgfSwKCiAgICAvKioKICAgICAqIEFwcGx5IHRoZSBDU1Mgc3R5bGVzIHRoYXQgZW5zdXJlIHRoZSBub2RlIGxvb2tzIHRoZSBzYW1lIGFzIGl0IGRpZCBpbiB0aGUKICAgICAqIG9yaWdpbmFsIGRvY3VtZW50LgogICAgICogQHBhcmFtIHBhcmVudFBhZ2UKICAgICAqLwogICAgcmVuZGVyU3R5bGVzOiBmdW5jdGlvbihwYXJlbnRQYWdlKSB7CiAgICAgICAgdGhpcy5hcHBseVN0eWxlRGlmZigpOwogICAgICAgICQodGhpcy5kb21Ob2RlKS5hZGRDbGFzcygnaHJ6LWVsZW1lbnQnKTsKICAgICAgICB0aGlzLnNldENzc1Bvc2l0aW9uKHBhcmVudFBhZ2UpOwogICAgICAgIHRoaXMuc2V0VHJhbnNpdGlvbkRlbGF5KCk7CiAgICAgICAgdGhpcy5zZXRSZXN0b3JlUG9pbnQoKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBBcHBseSB0aGUgc3R5bGUgcnVsZXMgbmVlZGVkIHRvIG1ha2UgdGhlCiAgICAgKiBET00gbm9kZSBhcHBlYXIgaWRlbnRpY2FsIHRvIHRoZSBvcmlnaW5hbCBmb3JtLgogICAgICovCiAgICBhcHBseVN0eWxlRGlmZjogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHN0eWxlRGlmZiA9IHRoaXMuZ2V0U3R5bGVEaWZmKCk7CiAgICAgICAgJCh0aGlzLmRvbU5vZGUpLmNzcyhzdHlsZURpZmYpOwogICAgfSwKCiAgICAvKioKICAgICAqIEFwcGx5IHRoZSBhYnNvbHV0ZSBwb3NpdGlvbmluZyB0byBtYWtlIHRoZSBET00gbm9kZSBhcHBlYXIgaW4KICAgICAqIHRoZSBjb3JyZWN0IHBsYWNlIG9uIHRoZSBwYWdlLgogICAgICogQHBhcmFtIHBhcmVudFBhZ2UKICAgICAqLwogICAgc2V0Q3NzUG9zaXRpb246IGZ1bmN0aW9uKHBhcmVudFBhZ2UpIHsKICAgICAgICB2YXIgcGFnZU1hcmdpbiA9IHBhcmVudFBhZ2UucGFnZU51bWJlciA9PT0gMSA/IDAgOiBPUFRJT05TLnBhZ2VNYXJnaW47CiAgICAgICAgJCh0aGlzLmRvbU5vZGUpLmNzcyh7CiAgICAgICAgICAgICdwb3NpdGlvbic6ICdhYnNvbHV0ZScsCiAgICAgICAgICAgICd0b3AnIDogdGhpcy5sYXlvdXQudG9wIC0gcGFyZW50UGFnZS50b3AgKyBwYWdlTWFyZ2luICsgJ3B4JywKICAgICAgICAgICAgJ2xlZnQnIDogdGhpcy5sYXlvdXQubGVmdCArICdweCcsCiAgICAgICAgICAgICd3aWR0aCcgOiB0aGlzLmxheW91dC53aWR0aCArICdweCcsCiAgICAgICAgICAgICdoZWlnaHQnIDogdGhpcy5sYXlvdXQuaGVpZ2h0ICsgJ3B4JwogICAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICAqIElmIHRoZSBzdGFnZ2VyRGVsYXkgb3B0aW9uIGlzIHNldCwgdGhlbiB3ZSBjaGVjayB0byBzZWUgaWYgdGhpcyBub2RlIGhhcyBlaXRoZXIgYSBDU1MgdHJhbnNpdGlvbiBvciBDU1MgYW5pbWF0aW9uCiAgICAgKiBzdHlsZSBydWxlIGFwcGxpZWQgdG8gaXQuIElmIHNvLCB3ZSBkeW5hbWljYWxseSBzZXQgdGhlIHRyYW5zaXRpb24tZGVsYXkgb3IgYW5pbWF0aW9uLWRlbGF5IHZhbHVlIHRvIGdpdmUgdGhlCiAgICAgKiBzdGFnZ2VyIGVmZmVjdC4KICAgICAqLwogICAgc2V0VHJhbnNpdGlvbkRlbGF5OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc3RhZ2dlciA9IHRoaXMuZ2V0U3RhZ2dlckRlbGF5KCk7CiAgICAgICAgaWYgKDAgPCBzdGFnZ2VyKSB7CiAgICAgICAgICAgIHZhciBjc3MgPSAkKHRoaXMuZG9tTm9kZSkuY3NzLmJpbmQoJCh0aGlzLmRvbU5vZGUpKTsKICAgICAgICAgICAgdmFyIHRyYW5zaXRpb25EdXJhdGlvbklzRGVmaW5lZCA9IGV4aXN0c0FuZElzTm90WmVybyhjc3MoJ3RyYW5zaXRpb24tZHVyYXRpb24nKSkgfHwgZXhpc3RzQW5kSXNOb3RaZXJvKGNzcygnLXdlYmtpdC10cmFuc2l0aW9uLWR1cmF0aW9uJykpOwogICAgICAgICAgICB2YXIgYW5pbWF0aW9uRHVyYXRpb25Jc0RlZmluZWQgPSBleGlzdHNBbmRJc05vdFplcm8oY3NzKCdhbmltYXRpb24tZHVyYXRpb24nKSkgfHwgZXhpc3RzQW5kSXNOb3RaZXJvKGNzcygnLXdlYmtpdC1hbmltYXRpb24tZHVyYXRpb24nKSk7CiAgICAgICAgICAgIGlmICh0cmFuc2l0aW9uRHVyYXRpb25Jc0RlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNzcyh7CiAgICAgICAgICAgICAgICAgICAgJ3RyYW5zaXRpb24tZGVsYXknOiBzdGFnZ2VyICsgJ3MnLAogICAgICAgICAgICAgICAgICAgICctd2Via2l0LXRyYW5zaXRpb24tZGVsYXknOiBzdGFnZ2VyICsgJ3MnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYW5pbWF0aW9uRHVyYXRpb25Jc0RlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNzcyh7CiAgICAgICAgICAgICAgICAgICAgJ2FuaW1hdGlvbi1kZWxheSc6IHN0YWdnZXIgKyAncycsCiAgICAgICAgICAgICAgICAgICAgJy13ZWJraXQtYW5pbWF0aW9uLWRlbGF5Jzogc3RhZ2dlciArICdzJwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV4aXN0c0FuZElzTm90WmVybyhwcm9wZXJ0eSkgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIHByb3BlcnR5ICE9PSAndW5kZWZpbmVkJyAmJiBwcm9wZXJ0eSAhPT0gJzBzJzsKICAgICAgICB9CiAgICB9LAoKICAgIGdldFN0YWdnZXJEZWxheTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGRlbGF5ID0gT1BUSU9OUy5zdGFnZ2VyRGVsYXkgKiB0aGlzLnN0YWdnZXJPcmRlcjsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChkZWxheSAqIDEwMCkgLyAxMDA7CiAgICB9LAoKICAgIC8qKgogICAgICogSW4gb3JkZXIgdG8gbWFrZSB0aGUgZmluYWwgcmVuZGVyZWQgRE9NIG5vZGUgYXBwZWFyIGlkZW50aWNhbCB0byBob3cgaXQgZGlkIG9uIHRoZSBvcmlnaW5hbCBwYWdlLAogICAgICogd2UgdG9vayBhIHNuYXBzaG90IG9mIGFsbCB0aGUgY29tcHV0ZWQgQ1NTIHN0eWxlcyBiZWZvcmUgbWFraW5nIGFueSBjaGFuZ2VzIHRvIHRoZSBwYWdlIGxheW91dC4KICAgICAqIE5vdyB0aGF0IHdlIGhhdmUgcmVtb3ZlZCB0aGUgRE9NIG5vZGUgZnJvbSB0aGUgb3JpZ2luYWwgcGxhY2UgaW4gdGhlIGRvY3VtZW50LCBhbnkgY2FzY2FkZWQKICAgICAqIHN0eWxlcyBmcm9tIHBhcmVudCBkaXZzIHdpbGwgaGF2ZSBiZWVuIGxvc3QuCiAgICAgKgogICAgICogVGhpcyBkaWZmIG1ldGhvZCBnZXRzIHRoZSBjdXJyZW50IGNvbXB1dGVkIENTUyBzdHlsZXMgZm9yIHRoZSBub2RlLCBhbmQgY29tcGFyZXMgdGhlbSB0byB0aGUKICAgICAqIHNuYXBzaG90IHdlIHRvb2sgd2l0aCB0aGUgY2xvbmVDb21wdXRlZFN0eWxlKCkgbWV0aG9kLiBJZiBhbnkgb2YgdGhlIHN0eWxlIHJ1bGVzIGFyZSBub3QgZXF1YWwsCiAgICAgKiB3ZSBhZGQgdGhlbSB0byB0aGUgc3R5bGVEaWZmIG9iamVjdCBzbyB3ZSBjYW4gYXBwbHkgdGhlbSBpbmxpbmUgdG8gdGhlIERPTSBub2RlLgogICAgICogQHJldHVybnMge3t9fQogICAgICovCiAgICBnZXRTdHlsZURpZmY6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzdHlsZURpZmYgPSB7fTsKICAgICAgICB2YXIgbmV3Q29tcHV0ZWRTdHlsZXMgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLmRvbU5vZGUpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0NvbXB1dGVkU3R5bGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gbmV3Q29tcHV0ZWRTdHlsZXNbaV07CiAgICAgICAgICAgIHZhciBvbGRQcm9wZXJ0eVZhbHVlID0gdGhpcy5vcmlnaW5hbENvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShuYW1lKTsKCiAgICAgICAgICAgIGlmIChuZXdDb21wdXRlZFN0eWxlcy5nZXRQcm9wZXJ0eVZhbHVlKG5hbWUpICE9IG9sZFByb3BlcnR5VmFsdWUpIHsKICAgICAgICAgICAgICAgIC8vIEludGVybmV0IEV4cGxvcmVyIGhhcyBzdHJhbmdlIGJlaGF2aW91ciB3aXRoIGl0cyBvd24gZGVwcmVjYXRlZCBwcmVmaXhlZCB2ZXJzaW9uIG9mIHRyYW5zaXRpb24sIGFuaW1hdGlvbiBhbmQKICAgICAgICAgICAgICAgIC8vIG90aGVycy4gVGhpcyBicmVha3MgdGhlc2UgQ1NTIGZlYXR1cmVzIGluIHRoYXQgYnJvd3Nlciwgc28gdGhlIHdvcmthcm91bmQgaGVyZSBpcyB0byBqdXN0IG9taXQgYWxsIHRob3NlCiAgICAgICAgICAgICAgICAvLyBJRS1zcGVjaWZpYyBwcmVmaXhlcy4KICAgICAgICAgICAgICAgIGlmICggbmFtZS5zdWJzdHJpbmcoMCwgMykgPT0gIi1tcyIpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvbGRQcm9wZXJ0eVZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3R5bGVEaWZmW25ld0NvbXB1dGVkU3R5bGVzW2ldXSA9IG9sZFByb3BlcnR5VmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBzdHlsZURpZmY7CiAgICB9LAoKICAgIC8qKgogICAgICogVHJpZ2dlciB0aGUgb25Ob2RlVHJhbnNpdGlvbiBjYWxsYmFjayBhbmQgcGFzcyB0aGlzIG5vZGUgYW5kIHRoZSB0eXBlIG9mIHRyYW5zaXRpb246CiAgICAgKiAtIHRvRm9yZWdyb3VuZAogICAgICogLSB0b0JhY2tncm91bmQKICAgICAqIC0gdG9Gb2N1c0Zyb21Gb3JlCiAgICAgKiAtIHRvRm9jdXNGcm9tQmFjawogICAgICogQHBhcmFtIHR5cGUKICAgICAqLwogICAgbW92ZVRvOiBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIE9QVElPTlMub25Ob2RlVHJhbnNpdGlvbih0eXBlLCBzZWxmLmdldFB1YmxpY09iamVjdCgpLCBhbmltYXRvcik7CiAgICAgICAgfSwgdGhpcy5nZXRTdGFnZ2VyRGVsYXkoKSAqIDEwMDApOwogICAgfSwKCiAgICAvKioKICAgICAqIFN0b3JlIGEgY29weSBvZiB0aGUgZmluYWwgY29tcHV0ZWQgaW5saW5lIHN0eWxlIHNvIHRoYXQgdGhlIG5vZGUKICAgICAqIGNhbiBiZSBlYXNpbHkgcmVzdG9yZWQgdG8gdGhlIHN0eWxlIGl0IGhhZCBhZnRlciBpbml0aWFsaXphdGlvbi4KICAgICAqIFRoZSBjbG9uZU5vZGUoKSBtZXRob2QgaXMgbmVjZXNzYXJ5IGFzIG90aGVyd2lzZSB3ZSB3aWxsIGp1c3QKICAgICAqIGdldCBhIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudCBzdHlsZSwgd2hpY2ggd2lsbCBjaGFuZ2UgYXMgdGhlCiAgICAgKiBjdXJyZW50IHN0eWxlIGNoYW5nZXMuCiAgICAgKi8KICAgIHNldFJlc3RvcmVQb2ludDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5pbmxpbmVTdHlsZSA9IHRoaXMuZG9tTm9kZS5jbG9uZU5vZGUoKS5zdHlsZTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBSZXN0b3JlIHRoZSBkb21Ob2RlIHRvIHRoZSBzdHlsZSBpdCBoYWQgYWZ0ZXIgaW5pdGlhbGl6YXRpb24uCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBpbnRlbmRlZCBhcyBhIGNvbnZlbmllbnQgaGVscGVyIGZvciB0aG9zZSB3cml0aW5nCiAgICAgKiBKYXZhU2NyaXB0LWJhc2VkIHRyYW5zaXRpb25zLgogICAgICovCiAgICByZXN0b3JlOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbmFtZSwgaTsKICAgICAgICAvLyBmaXJzdCB3ZSBuZWVkIHRvIGRlbGV0ZSBhbGwgdGhlIHN0eWxlIHJ1bGVzCiAgICAgICAgLy8gY3VycmVudGx5IGRlZmluZWQgb24gdGhlIGVsZW1lbnQKICAgICAgICBmb3IgKGkgPSB0aGlzLmRvbU5vZGUuc3R5bGUubGVuZ3RoOyBpID49IDA7IGktLSkgewogICAgICAgICAgICBuYW1lID0gdGhpcy5kb21Ob2RlLnN0eWxlW2ldOwogICAgICAgICAgICB0aGlzLmRvbU5vZGUuc3R5bGUucmVtb3ZlUHJvcGVydHkobmFtZSk7CiAgICAgICAgfQogICAgICAgIC8vIG5vdyB3ZSBsb29wIHRocm91Z2ggdGhlIG9yaWdpbmFsIENTU1N0eWxlRGVjbGFyYXRpb24KICAgICAgICAvLyBvYmplY3QgYW5kIHNldCBlYWNoIHByb3BlcnR5IHRvIGl0cyBvcmlnaW5hbCB2YWx1ZQogICAgICAgIGZvciAoaSA9IHRoaXMuaW5saW5lU3R5bGUubGVuZ3RoOyBpID49IDA7IGktLSkgewogICAgICAgICAgICBuYW1lID0gdGhpcy5pbmxpbmVTdHlsZVtpXTsKICAgICAgICAgICAgdGhpcy5kb21Ob2RlLnN0eWxlLnNldFByb3BlcnR5KG5hbWUsCiAgICAgICAgICAgICAgICB0aGlzLmlubGluZVN0eWxlLmdldFByb3BlcnR5VmFsdWUobmFtZSksCiAgICAgICAgICAgICAgICBwcmlvcml0eSA9IHRoaXMuaW5saW5lU3R5bGUuZ2V0UHJvcGVydHlQcmlvcml0eShuYW1lKSk7CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhIHN1YnNldCBvZiBwcm9wZXJ0aWVzIG9mIHRoZSBwcml2YXRlIE5vZGUgb2JqZWN0LCBmb3IgdXNlIGluCiAgICAgKiB0aGUgamF2YXNjcmlwdCBjYWxsYmFja3Mgc2V0IHVwIGluIHRoZSBob3Jpem9uYWwgY29uZmlnIG9iamVjdC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7e2RvbU5vZGU6ICosIGluZGV4OiAqLCBzdGFnZ2VyT3JkZXI6ICp9fQogICAgICovCiAgICBnZXRQdWJsaWNPYmplY3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGRvbU5vZGU6IHRoaXMuZG9tTm9kZSwKICAgICAgICAgICAgaW5kZXg6IHRoaXMuaW5kZXgsCiAgICAgICAgICAgIHN0YWdnZXJPcmRlcjogdGhpcy5zdGFnZ2VyT3JkZXIsCiAgICAgICAgICAgIHJlc3RvcmU6IHRoaXMucmVzdG9yZS5iaW5kKHRoaXMpCiAgICAgICAgfTsKICAgIH0KfTsKCgoKZnVuY3Rpb24gTm9kZUNvbGxlY3Rpb24oc2VsZWN0b3IpIHsKICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgdGhpcy5mcm9tU2VsZWN0b3Ioc2VsZWN0b3IpOwogICAgfQp9Cgp2YXIgTm9kZUNvbGxlY3Rpb25BUEkgPSB7CgogICAgZnJvbVNlbGVjdG9yOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB2YXIgYWxsTm9kZXMgPSBST09ULmZpbmQoc2VsZWN0b3IpLmZpbHRlcignOnZpc2libGUnKS5ub3QoJy5ocnotbG9hZGluZy1pbmRpY2F0b3InKTsKCiAgICAgICAgdmFyIHRvcExldmVsTm9kZXMgPSAkKFtdKTsKICAgICAgICBhbGxOb2Rlcy5lYWNoKGZ1bmN0aW9uKGluZGV4LCBkb21Ob2RlKSB7CiAgICAgICAgICAgIGlmICgkKGRvbU5vZGUpLnBhcmVudHMoc2VsZWN0b3IpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdG9wTGV2ZWxOb2RlcyA9IHRvcExldmVsTm9kZXMuYWRkKGRvbU5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRvcExldmVsTm9kZXMuZWFjaChmdW5jdGlvbihpbmRleCwgZG9tTm9kZSkgewogICAgICAgICAgICB2YXIgbm9kZSA9IG5ldyBOb2RlKGRvbU5vZGUsIGluZGV4KTsKICAgICAgICAgICAgc2VsZi5wdXNoKG5vZGUpOwogICAgICAgIH0pOwogICAgfSwKCiAgICBhcHBlbmRUb0RvbTogZnVuY3Rpb24ocGFyZW50UGFnZSkgewogICAgICAgIC8vIGF0IHRoaXMgc3RhZ2Ugd2UgY2FuIGFzc2lnbiBhbiBhcHByb3ByaWF0ZSBzdGFnZ2VyT3JkZXIgdG8KICAgICAgICAvLyB0aGUgbm9kZXMsIHNpbmNlIHdlIG5vdyBrbm93IGhvdyBtYW55IGFyZSBvbiBlYWNoIHBhZ2UuCiAgICAgICAgdmFyIHN0YWdnZXJPcmRlciA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDw9IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgc3RhZ2dlck9yZGVyLnB1c2goaSk7CiAgICAgICAgfQogICAgICAgIGlmIChPUFRJT05TLnN0YWdnZXIgPT09ICdyYW5kb20nKSB7CiAgICAgICAgICAgIHN0YWdnZXJPcmRlciA9IHNodWZmbGUoc3RhZ2dlck9yZGVyKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbihub2RlLCBpbmRleCkgewogICAgICAgICAgICBub2RlLnN0YWdnZXJPcmRlciA9IHN0YWdnZXJPcmRlcltpbmRleF07CiAgICAgICAgICAgIG5vZGUuYXBwZW5kVG9Eb20ocGFyZW50UGFnZSk7CiAgICAgICAgfSk7CiAgICB9Cn07CgpOb2RlQ29sbGVjdGlvbi5wcm90b3R5cGUgPSBbXTsKJC5leHRlbmQoTm9kZUNvbGxlY3Rpb24ucHJvdG90eXBlLCBOb2RlQ29sbGVjdGlvbkFQSSk7CgpmdW5jdGlvbiBQYWdlKHBhZ2VOdW1iZXIpIHsKICAgIHRoaXMudG9wID0gMDsKICAgIHRoaXMuYm90dG9tID0gMDsKICAgIHRoaXMuaGVpZ2h0ID0gMDsKICAgIHRoaXMubm9kZXMgPSBuZXcgTm9kZUNvbGxlY3Rpb24oKTsKICAgIHRoaXMucGFnZU51bWJlciA9IHBhZ2VOdW1iZXIgfHwgMDsKICAgIHRoaXMuZG9tTm9kZSA9IG51bGw7CiAgICB0aGlzLmhpZGVUaW1lciA9IG51bGw7CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJwYWdlSWQiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICJocnotcGFnZS0iICsgdGhpcy5wYWdlTnVtYmVyOwogICAgICAgIH0KICAgIH0pOwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAibWlkUG9pbnQiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh0aGlzLmJvdHRvbSArIHRoaXMudG9wKSAvIDIgLyBPUFRJT05TLnNjcm9sbGJhclNob3J0ZW5SYXRpbzsKICAgICAgICB9CiAgICB9KTsKfQoKUGFnZS5wcm90b3R5cGUgPSB7CgogICAgYWRkTm9kZTogZnVuY3Rpb24obm9kZSkgewogICAgICAgIHRoaXMubm9kZXMucHVzaChub2RlKTsKICAgIH0sCgogICAgYXBwZW5kVG9Eb206IGZ1bmN0aW9uKGN1cnJlbnRQYWdlKSB7CiAgICAgICAgdmFyIHpDbGFzcyA9ICIiOwogICAgICAgIGlmICh0aGlzLnBhZ2VOdW1iZXIgPCBjdXJyZW50UGFnZSkgewogICAgICAgICAgICB6Q2xhc3MgPSAiaHJ6LWJhY2sgaHJ6LWhpZGRlbiI7CiAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50UGFnZSA8IHRoaXMucGFnZU51bWJlcikgewogICAgICAgICAgICB6Q2xhc3MgPSAiaHJ6LWZvcmUgaHJ6LWhpZGRlbiI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgekNsYXNzID0gImhyei1mb2N1cy1mcm9tLWZvcmUiOwogICAgICAgIH0KICAgICAgICBDT05UQUlORVIuYXBwZW5kKCc8ZGl2IGNsYXNzPSJocnotcGFnZSAnICsgekNsYXNzICsgJyIgaWQ9IicgKyB0aGlzLnBhZ2VJZCArICciIC8+Jyk7CiAgICAgICAgdGhpcy5kb21Ob2RlID0gQ09OVEFJTkVSLmZpbmQoJyMnICsgdGhpcy5wYWdlSWQpWzBdOwogICAgICAgIHRoaXMubm9kZXMuYXBwZW5kVG9Eb20odGhpcyk7CiAgICB9LAoKICAgIG1vdmVUb0ZvcmVncm91bmQ6IGZ1bmN0aW9uKCkgewogICAgICAgIE9QVElPTlMub25QYWdlVHJhbnNpdGlvbigndG9Gb3JlZ3JvdW5kJywgdGhpcy5nZXRQdWJsaWNPYmplY3QoKSwgYW5pbWF0b3IpOwogICAgICAgICQodGhpcy5kb21Ob2RlKS5hZGRDbGFzcygnaHJ6LWZvcmUnKS5yZW1vdmVDbGFzcygnaHJ6LWJhY2sgaHJ6LWZvY3VzLWZyb20tYmFjayBocnotZm9jdXMtZnJvbS1mb3JlJyk7CiAgICAgICAgdGhpcy5oaWRlQWZ0ZXJEZWxheSgpOwogICAgICAgIHRoaXMubm9kZXMuZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIG5vZGUubW92ZVRvKCd0b0ZvcmVncm91bmQnKTsKICAgICAgICB9KTsKICAgIH0sCgogICAgbW92ZVRvQmFja2dyb3VuZDogZnVuY3Rpb24oKSB7CiAgICAgICAgT1BUSU9OUy5vblBhZ2VUcmFuc2l0aW9uKCd0b0JhY2tncm91bmQnLCB0aGlzLmdldFB1YmxpY09iamVjdCgpLCBhbmltYXRvcik7CiAgICAgICAgJCh0aGlzLmRvbU5vZGUpLmFkZENsYXNzKCdocnotYmFjaycpLnJlbW92ZUNsYXNzKCdocnotZm9yZSBocnotZm9jdXMtZnJvbS1iYWNrIGhyei1mb2N1cy1mcm9tLWZvcmUnKTsKICAgICAgICB0aGlzLmhpZGVBZnRlckRlbGF5KCk7CiAgICAgICAgdGhpcy5ub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgbm9kZS5tb3ZlVG8oJ3RvQmFja2dyb3VuZCcpOwogICAgICAgIH0pOwogICAgfSwKCiAgICBtb3ZlVG9Gb2N1c0Zyb21CYWNrZ3JvdW5kOiBmdW5jdGlvbigpIHsKICAgICAgICBPUFRJT05TLm9uUGFnZVRyYW5zaXRpb24oJ3RvRm9jdXNGcm9tQmFjaycsIHRoaXMuZ2V0UHVibGljT2JqZWN0KCksIGFuaW1hdG9yKTsKICAgICAgICAkKHRoaXMuZG9tTm9kZSkuYWRkQ2xhc3MoJ2hyei1mb2N1cy1mcm9tLWJhY2snKTsKICAgICAgICB0aGlzLl9tb3ZlVG9Gb2N1cygndG9Gb2N1c0Zyb21CYWNrJyk7CiAgICB9LAoKICAgIG1vdmVUb0ZvY3VzRnJvbUZvcmVncm91bmQ6IGZ1bmN0aW9uKCkgewogICAgICAgIE9QVElPTlMub25QYWdlVHJhbnNpdGlvbigndG9Gb2N1c0Zyb21Gb3JlJywgdGhpcy5nZXRQdWJsaWNPYmplY3QoKSwgYW5pbWF0b3IpOwogICAgICAgICQodGhpcy5kb21Ob2RlKS5hZGRDbGFzcygnaHJ6LWZvY3VzLWZyb20tZm9yZScpOwogICAgICAgIHRoaXMuX21vdmVUb0ZvY3VzKCd0b0ZvY3VzRnJvbUZvcmUnKTsKICAgIH0sCgogICAgX21vdmVUb0ZvY3VzOiBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgJCh0aGlzLmRvbU5vZGUpLnJlbW92ZUNsYXNzKCdocnotZm9yZSBocnotYmFjayBocnotaGlkZGVuJyk7CiAgICAgICAgaWYgKHRoaXMuaGlkZVRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmhpZGVUaW1lcik7CiAgICAgICAgICAgIHRoaXMuaGlkZVRpbWVyID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgdGhpcy5ub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgbm9kZS5tb3ZlVG8odHlwZSk7CiAgICAgICAgfSk7CiAgICB9LAoKICAgIGhpZGVBZnRlckRlbGF5OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgJHRoaXNOb2RlID0gJCh0aGlzLmRvbU5vZGUpOwogICAgICAgIHRoaXMuaGlkZVRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICR0aGlzTm9kZS5hZGRDbGFzcygnaHJ6LWhpZGRlbicpOwogICAgICAgIH0sIE9QVElPTlMucGFnZUhpZGVEZWxheSAqIDEwMDApOwogICAgfSwKCiAgICAvKioKICAgICAqIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhIHN1YnNldCBvZiBwcm9wZXJ0aWVzIG9mIHRoZSBwcml2YXRlIFBhZ2Ugb2JqZWN0LCBmb3IgdXNlIGluCiAgICAgKiB0aGUgamF2YXNjcmlwdCBjYWxsYmFja3Mgc2V0IHVwIGluIHRoZSBob3Jpem9uYWwgY29uZmlnIG9iamVjdC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7e2RvbU5vZGU6ICosIGluZGV4OiAqLCBzdGFnZ2VyT3JkZXI6ICp9fQogICAgICovCiAgICBnZXRQdWJsaWNPYmplY3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGRvbU5vZGU6IHRoaXMuZG9tTm9kZSwKICAgICAgICAgICAgcGFnZU51bWJlcjogdGhpcy5wYWdlTnVtYmVyCiAgICAgICAgfTsKICAgIH0KfTsKZnVuY3Rpb24gUGFnZUNvbGxlY3Rpb24oKSB7CgogICAgdmFyIF9jdXJyZW50UGFnZSA9IDE7CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJjdXJyZW50UGFnZSIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gX2N1cnJlbnRQYWdlOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgaWYgKHRoaXMubGFzdCgpIDwgdmFsKSB7CiAgICAgICAgICAgICAgICBfY3VycmVudFBhZ2UgPSB0aGlzLmxhc3QoKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh2YWwgPCAxKSB7CiAgICAgICAgICAgICAgICBfY3VycmVudFBhZ2UgPSAxOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2N1cnJlbnRQYWdlID0gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7Cn0KCnZhciBQYWdlQ29sbGVjdGlvbkFQSSA9IHsKCiAgICBnZXRQYWdlOiBmdW5jdGlvbihwYWdlTnVtYmVyKSB7CiAgICAgICAgaWYgKDAgPCBwYWdlTnVtYmVyICYmIHBhZ2VOdW1iZXIgPD0gdGhpcy5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbcGFnZU51bWJlciAtIDFdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgUGFnZSgpOwogICAgICAgIH0KICAgIH0sCgogICAgZ2V0Q3VycmVudDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UGFnZSh0aGlzLmN1cnJlbnRQYWdlKTsKICAgIH0sCgogICAgZ2V0TmV4dDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UGFnZSh0aGlzLmN1cnJlbnRQYWdlICsgMSk7CiAgICB9LAoKICAgIGdldFByZXZpb3VzOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRQYWdlKHRoaXMuY3VycmVudFBhZ2UgLSAxKTsKICAgIH0sCgogICAgYWRkOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgcGFnZU51bWJlciA9IHRoaXMubGVuZ3RoICsgMTsKICAgICAgICB2YXIgbmV3UGFnZSA9IG5ldyBQYWdlKHBhZ2VOdW1iZXIpOwogICAgICAgIG5ld1BhZ2UudG9wID0gdGhpcy5nZXRQYWdlKHRoaXMubGVuZ3RoKS5ib3R0b207CiAgICAgICAgdGhpcy5wdXNoKG5ld1BhZ2UpOwogICAgfSwKCiAgICBsYXN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpc1t0aGlzLmxlbmd0aCAtIDFdOwogICAgfSwKCiAgICBnZXRMYXN0T2Zmc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5sZW5ndGggPD0gMSkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpcy5sYXN0KCkudG9wOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBHaXZlbiBhIHktYXhpcyBvZmZzZXQgaW4gcGl4ZWxzLCByZXR1cm4gdGhlIHBhZ2UgaW4gdGhlIGNvbGxlY3Rpb24gd2hpY2ggY29udGFpbnMgdGhpcwogICAgICogb2Zmc2V0IGJldHdlZW4gaXRzIHRvcCBhbmQgYm90dG9tIHByb3BlcnRpZXMuIElmIHRoZSBvZmZzZXQgaXMgbm90IHZhbGlkLCByZXR1cm4gdGhlCiAgICAgKiBmaXJzdCBwYWdlLgogICAgICogQHBhcmFtIG9mZnNldAogICAgICovCiAgICBnZXRQYWdlQXRPZmZzZXQ6IGZ1bmN0aW9uKG9mZnNldCkgewogICAgICAgIHJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbihwYWdlKSB7CiAgICAgICAgICAgIHJldHVybiAocGFnZS50b3AgPD0gb2Zmc2V0ICYmIG9mZnNldCA8IHBhZ2UuYm90dG9tKTsKICAgICAgICB9KVswXSB8fCB0aGlzWzBdOwogICAgfSwKCiAgICAvKioKICAgICAqIEFwcGVuZHMgYWxsIHRoZSBwYWdlcyBhbmQgcGFnZSBlbGVtZW50cyB0byB0aGUgZG9jdW1lbnRGcmFnbWVudCByZWZlcmVuY2VkIGJ5IENPTlRBSU5FUgogICAgICogQHBhcmFtIGN1cnJlbnRTY3JvbGwKICAgICAqLwogICAgYXBwZW5kVG9Eb206IGZ1bmN0aW9uKGN1cnJlbnRTY3JvbGwpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgY3VycmVudFNjcm9sbCA9IGN1cnJlbnRTY3JvbGwgfHwgMDsKICAgICAgICB0aGlzLmN1cnJlbnRQYWdlID0gdGhpcy5nZXRQYWdlQXRPZmZzZXQoY3VycmVudFNjcm9sbCAqIE9QVElPTlMuc2Nyb2xsYmFyU2hvcnRlblJhdGlvKS5wYWdlTnVtYmVyOwogICAgICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbihwYWdlKSB7CiAgICAgICAgICAgIHBhZ2UuYXBwZW5kVG9Eb20oc2VsZi5jdXJyZW50UGFnZSk7CiAgICAgICAgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICogVG8gc2hvdyBhIGdpdmVuIHBhZ2UsIHdlIGp1c3QgbmVlZCB0byByZW1vdmUgdGhlIC1mb3JlIGFuZCAtYmFjayBDU1MgY2xhc3NlcwogICAgICogZnJvbSB0aGUgcGFnZSBhbmQgdGhlIG5vZGVzIG9uIHRoYXQgcGFnZS4gTG93ZXItb3JkZXJlZCBwYWdlcyBoYXZlIHRoZSAtZm9yZQogICAgICogY2xhc3MgYWRkZWQsIGFuZCBoaWdoZXItb3JkZXJlZCBwYWdlcyBoYXZlIHRoZSAtYmFjayBjbGFzcyBhZGRlZC4KICAgICAqCiAgICAgKgogICAgICogQHBhcmFtIHBhZ2VOdW1iZXIKICAgICAqLwogICAgc2hvd1BhZ2U6IGZ1bmN0aW9uKHBhZ2VOdW1iZXIpIHsKICAgICAgICB2YXIgb2xkUGFnZU51bWJlciA9IHRoaXMuY3VycmVudFBhZ2U7CiAgICAgICAgdGhpcy5jdXJyZW50UGFnZSA9IHBhZ2VOdW1iZXI7CiAgICAgICAgdmFyIG5ld1BhZ2VOdW1iZXIgPSB0aGlzLmN1cnJlbnRQYWdlOwoKICAgICAgICBpZiAob2xkUGFnZU51bWJlciA9PT0gMCkgewogICAgICAgICAgICB0aGlzLmdldFBhZ2UobmV3UGFnZU51bWJlcikuX21vdmVUb0ZvY3VzKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgIGlmIChvbGRQYWdlTnVtYmVyIDwgbmV3UGFnZU51bWJlcikgewogICAgICAgICAgICAgICAgZm9yIChpID0gb2xkUGFnZU51bWJlcjsgaSA8IG5ld1BhZ2VOdW1iZXI7IGkgKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdldFBhZ2UoaSkubW92ZVRvQmFja2dyb3VuZCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5nZXRQYWdlKG5ld1BhZ2VOdW1iZXIpLm1vdmVUb0ZvY3VzRnJvbUZvcmVncm91bmQoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChuZXdQYWdlTnVtYmVyIDwgb2xkUGFnZU51bWJlcikgewogICAgICAgICAgICAgICAgZm9yIChpID0gb2xkUGFnZU51bWJlcjsgbmV3UGFnZU51bWJlciA8IGk7IGkgLS0pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdldFBhZ2UoaSkubW92ZVRvRm9yZWdyb3VuZCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5nZXRQYWdlKG5ld1BhZ2VOdW1iZXIpLm1vdmVUb0ZvY3VzRnJvbUJhY2tncm91bmQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfTsKClBhZ2VDb2xsZWN0aW9uLnByb3RvdHlwZSA9IFtdOwokLmV4dGVuZChQYWdlQ29sbGVjdGlvbi5wcm90b3R5cGUsIFBhZ2VDb2xsZWN0aW9uQVBJKTsKfSkoalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50KTs=",
                "body": "KGZ1bmN0aW9uKCQsIHdpbmRvdywgZG9jdW1lbnQpIHsKLyoqCiAqIFRoaXMgb2JqZWN0IGlzIHJlc3BvbnNpYmxlIGZvciB0YWtpbmcgYSBub2RlQ29sbGVjdGlvbiBhbmQgc3BsaXR0aW5nIGl0IHVwIGludG8gdGhlIGNvcnJlY3QgbnVtYmVyIG9mIHBhZ2VzLAogKiBwbGFjaW5nIHRoZSBjb3JyZWN0IG5vZGVzIG9uIGVhY2ggcGFnZS4KICovCnZhciBwYWdlQ29sbGVjdGlvbkdlbmVyYXRvciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIG1vZHVsZSA9IHt9OwoKICAgIGZ1bmN0aW9uIGZyb21Ob2RlQ29sbGVjdGlvbihub2RlQ29sbGVjdGlvbikgewogICAgICAgIHZhciBsYXN0UGFnZSA9IDE7CiAgICAgICAgdmFyIGluZGV4OwogICAgICAgIHZhciBwYWdlQ29sbGVjdGlvbiA9IG5ldyBQYWdlQ29sbGVjdGlvbigpOwoKICAgICAgICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBub2RlQ29sbGVjdGlvbi5sZW5ndGg7IGluZGV4ICsrKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gbm9kZUNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgICAgICB2YXIgcGFnZVVwcGVyQm91bmQgPSBwYWdlQ29sbGVjdGlvbi5nZXRMYXN0T2Zmc2V0KCkgKyBWSUVXUE9SVF9IRUlHSFQ7CgogICAgICAgICAgICB2YXIgbm9kZUlzVGFsbEFuZERvZXNOb3RGaXRPblBhZ2UgPSBpc05vZGVUYWxsKG5vZGUsIHBhZ2VVcHBlckJvdW5kKTsKICAgICAgICAgICAgaWYgKG5vZGVJc1RhbGxBbmREb2VzTm90Rml0T25QYWdlICYmICFub2RlLmlzQ2xvbmUpIHsKICAgICAgICAgICAgICAgIG5vZGUuaXNUYWxsID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciBwYWdlT3ZlcmhhbmcgPSBub2RlLmxheW91dC5ib3R0b20gLSBwYWdlVXBwZXJCb3VuZDsKICAgICAgICAgICAgICAgIHZhciBpID0gMTsKICAgICAgICAgICAgICAgIC8vIEFzIGxvbmcgYXMgdGhlIG5vZGUgaGFuZ3Mgb3ZlciB0aGUgZWRnZSBvZiB0aGUgcGFnZSwgd2UgbmVlZCB0byBrZWVwCiAgICAgICAgICAgICAgICAvLyBhZGRpbmcgY2xvbmVzIHRoYXQgd2lsbCBlYWNoIGFwcGVhciBvbiBzdWJzZXF1ZW50IHBhZ2VzLgogICAgICAgICAgICAgICAgd2hpbGUoMCA8IHBhZ2VPdmVyaGFuZykgewogICAgICAgICAgICAgICAgICAgIHZhciBjbG9uZUluZGV4ID0gaW5kZXggKyBpOwogICAgICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IG5vZGUubWFrZUNsb25lKGNsb25lSW5kZXgpOwogICAgICAgICAgICAgICAgICAgIGNsb25lLnBhZ2VPdmVyaGFuZyA9IHBhZ2VPdmVyaGFuZzsKICAgICAgICAgICAgICAgICAgICBub2RlQ29sbGVjdGlvbi5zcGxpY2UoY2xvbmVJbmRleCwgMCAsIGNsb25lKTsKICAgICAgICAgICAgICAgICAgICBwYWdlT3ZlcmhhbmcgPSBwYWdlT3ZlcmhhbmcgLSBWSUVXUE9SVF9IRUlHSFQ7CiAgICAgICAgICAgICAgICAgICAgaSArKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0UGFnZSA9IGNhbGN1bGF0ZUxhc3RQYWdlQW5kUGFnZU9mZnNldChub2RlLCBwYWdlQ29sbGVjdGlvbiwgbGFzdFBhZ2UpOwoKICAgICAgICAgICAgdmFyIHBhZ2VUb0FkZFRvOwogICAgICAgICAgICB2YXIgbm9kZUlzQm90dG9tTW9zdEVsZW1lbnQgPSBwYWdlQ29sbGVjdGlvbi5sYXN0KCkuYm90dG9tID09PSBub2RlLmxheW91dC5ib3R0b207CiAgICAgICAgICAgIGlmIChub2RlSXNCb3R0b21Nb3N0RWxlbWVudCB8fCBub2RlLmlzQ2xvbmUgfHwgbm9kZS5uZXdQYWdlKSB7CiAgICAgICAgICAgICAgICBwYWdlVG9BZGRUbyA9IGxhc3RQYWdlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcGFnZVRvQWRkVG8gPSBwYWdlQ29sbGVjdGlvbi5nZXRQYWdlQXRPZmZzZXQobm9kZS5sYXlvdXQudG9wKS5wYWdlTnVtYmVyOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwYWdlQ29sbGVjdGlvbi5nZXRQYWdlKHBhZ2VUb0FkZFRvKS5hZGROb2RlKG5vZGUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHBhZ2VDb2xsZWN0aW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzTm9kZVRhbGwobm9kZSwgcGFnZVVwcGVyQm91bmQpIHsKICAgICAgICB2YXIgaXNUYWxsID0gZmFsc2U7CiAgICAgICAgaWYgKCQobm9kZS5kb21Ob2RlKS5oYXNDbGFzcyhPUFRJT05TLm5ld1BhZ2VDbGFzcykpIHsKICAgICAgICAgICAgaWYgKFZJRVdQT1JUX0hFSUdIVCA8IG5vZGUubGF5b3V0LmhlaWdodCkgewogICAgICAgICAgICAgICAgaXNUYWxsID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChWSUVXUE9SVF9IRUlHSFQgLyAyIDwgbm9kZS5sYXlvdXQuaGVpZ2h0ICYmIHBhZ2VVcHBlckJvdW5kIDwgbm9kZS5sYXlvdXQuYm90dG9tKSB7CiAgICAgICAgICAgICAgICBpc1RhbGwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBpc1RhbGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBGb3IgYSBnaXZlbiBub2RlLCB3ZSBuZWVkIHRvIGtub3cgd2hhdCBwYWdlIGl0IHNob3VsZCBiZSBvbiwgYW5kIHdoZXRoZXIgaXQgZXh0ZW5kcyBvZmYgdGhlIGJvdHRvbQogICAgICogb2ZmIHRoZSBjdXJyZW50IHBhZ2UgKGxhc3RQYWdlKS4gSWYgc28sIHdlIG5lZWQgdG8gc3RhcnQgYSBuZXcgcGFnZS4gU29ycnkgYWJvdXQgdGhlIGNvbXBsZXhpdHkuCiAgICAgKiBAcGFyYW0gbm9kZQogICAgICogQHBhcmFtIGxhc3RQYWdlCiAgICAgKiBAcGFyYW0gcGFnZUNvbGxlY3Rpb24KICAgICAqLwogICAgZnVuY3Rpb24gY2FsY3VsYXRlTGFzdFBhZ2VBbmRQYWdlT2Zmc2V0KG5vZGUsIHBhZ2VDb2xsZWN0aW9uLCBsYXN0UGFnZSkgewogICAgICAgIGlmICgkKG5vZGUuZG9tTm9kZSkuaGFzQ2xhc3MoT1BUSU9OUy5uZXdQYWdlQ2xhc3MpKSB7CiAgICAgICAgICAgIGxhc3RQYWdlICsrOwogICAgICAgICAgICBub2RlLm5ld1BhZ2UgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAocGFnZUNvbGxlY3Rpb25bbGFzdFBhZ2UgLSAxXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHZhciBwYWdlID0gcGFnZUNvbGxlY3Rpb24uZ2V0UGFnZShsYXN0UGFnZSk7CiAgICAgICAgICAgIHZhciBwYWdlVXBwZXJCb3VuZCA9IHBhZ2UudG9wICsgVklFV1BPUlRfSEVJR0hUOwogICAgICAgICAgICBpZiAocGFnZS5ib3R0b20gPD0gbm9kZS5sYXlvdXQuYm90dG9tKSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZURvZXNOb3RGaXRPblBhZ2UgPSBwYWdlVXBwZXJCb3VuZCA8IG5vZGUubGF5b3V0LmJvdHRvbTsKICAgICAgICAgICAgICAgIGlmICghbm9kZS5pc1RhbGwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZURvZXNOb3RGaXRPblBhZ2UgfHwgbm9kZS5pc0Nsb25lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RQYWdlICsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29sbGVjdGlvbi5hZGQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1BhZ2UgPSBwYWdlQ29sbGVjdGlvbi5sYXN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChWSUVXUE9SVF9IRUlHSFQgPCBub2RlLmxheW91dC5oZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhZ2UuYm90dG9tID0gcGFnZVVwcGVyQm91bmQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5wYWdlT3ZlcmhhbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQYWdlLmJvdHRvbSArPSBNYXRoLm1pbihub2RlLnBhZ2VPdmVyaGFuZywgVklFV1BPUlRfSEVJR0hUKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhZ2UuYm90dG9tID0gbm9kZS5sYXlvdXQuYm90dG9tOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFnZS5ib3R0b20gPSBub2RlLmxheW91dC5ib3R0b207CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZURvZXNOb3RGaXRPblBhZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFnZS5ib3R0b20gPSBwYWdlVXBwZXJCb3VuZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYWdlQ29sbGVjdGlvbi5hZGQoKTsKICAgICAgICAgICAgcGFnZUNvbGxlY3Rpb24ubGFzdCgpLmJvdHRvbSA9IG5vZGUubGF5b3V0LmJvdHRvbTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBsYXN0UGFnZTsKICAgIH0KCiAgICBtb2R1bGUuZnJvbU5vZGVDb2xsZWN0aW9uID0gZnJvbU5vZGVDb2xsZWN0aW9uOwogICAgcmV0dXJuIG1vZHVsZTsKfSgpOwp2YXIgUEFHRV9DT0xMRUNUSU9OOwp2YXIgT1BUSU9OUzsKdmFyIENPTlRBSU5FUjsKdmFyIFJPT1Q7CnZhciBST09UX0NMT05FOwp2YXIgVklFV1BPUlRfSEVJR0hUOwp2YXIgQ1VTVE9NX0NTUzsKCgpmdW5jdGlvbiBIb3Jpem9uYWwoKSB7CgogICAgdmFyIF9oYXNCZWVuSW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgIHZhciBfZGlzYWJsZWQgPSBmYWxzZTsKICAgIHZhciBkZWZhdWx0cyA9IHsKICAgICAgICBzZWxlY3RvcjogJ2gxLCBoMiwgaDMsIGg0LCBoNSwgaDYsIHAsIGxpLCBpbWcsIHRhYmxlJywKICAgICAgICBzdGFnZ2VyRGVsYXk6IDAuMSwKICAgICAgICBzdGFnZ2VyOiAncmFuZG9tJywKICAgICAgICBjdXN0b21Dc3NGaWxlOiBmYWxzZSwKICAgICAgICBkaXNwbGF5U2Nyb2xsYmFyOiBmYWxzZSwKICAgICAgICBzY3JvbGxiYXJTaG9ydGVuUmF0aW86IDIsIC8vIGxvbmcgc2Nyb2xsaW5nIGJldHdlZW4gcGFnZXMgY2FuIGJlIGEgcGFpbiwgc28gYSBoaWdoZXIgdmFsdWUgaGVyZSB3aWxsIHNob3J0ZW4gdGhlIHNjcm9sbCBkaXN0YW5jZSBiZXR3ZWVuIHBhZ2VzCiAgICAgICAgcGFnZU1hcmdpbjogMjAsCiAgICAgICAgZGlzcGxheVBhZ2VDb3VudDogdHJ1ZSwKICAgICAgICByb290RWxlbWVudDogJ2JvZHknLAogICAgICAgIG5ld1BhZ2VDbGFzczogJ2hyei1zdGFydC1uZXctcGFnZScsCiAgICAgICAgcGFnZUhpZGVEZWxheTogMSwgLy8gc2Vjb25kcyBiZWZvcmUgdGhlICdocnotaGlkZGVuJyBjbGFzcyBnZXRzIGFkZGVkIHRvIGEgcGFnZSB0aGUgaXMgbm90IGluIGZvY3VzCiAgICAgICAgb25SZXNpemU6IG5vb3AsCiAgICAgICAgb25Ob2RlVHJhbnNpdGlvbjogbm9vcCwKICAgICAgICBvblBhZ2VUcmFuc2l0aW9uOiBub29wCiAgICB9OwoKICAgIGZ1bmN0aW9uIGluaXQoX09QVElPTlMpIHsKICAgICAgICB2YXIgY3VycmVudFNjcm9sbCA9ICQod2luZG93KS5zY3JvbGxUb3AoKTsKICAgICAgICBPUFRJT05TID0gJC5leHRlbmQoIHt9LCBkZWZhdWx0cywgX09QVElPTlMpOwogICAgICAgIGxvYWRDdXN0b21Dc3MoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIV9oYXNCZWVuSW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgICAgIFJPT1QgPSAkKE9QVElPTlMucm9vdEVsZW1lbnQpOwogICAgICAgICAgICAgICAgUk9PVF9DTE9ORSA9IFJPT1QuY2xvbmUoKTsKICAgICAgICAgICAgICAgIGNvbXBvc2VQYWdlKGN1cnJlbnRTY3JvbGwpCiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZVBhZ2VDb3VudCgpOwogICAgICAgICAgICAgICAgICAgICAgICByZWdpc3RlckV2ZW50SGFuZGxlcnMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5sb2NhdGlvbi5oYXNoICE9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzaENoYW5nZUhhbmRsZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBfaGFzQmVlbkluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc2l6ZUhhbmRsZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGRpc2FibGUoKSB7CiAgICAgICAgaWYgKCFfZGlzYWJsZWQpIHsKICAgICAgICAgICAgUk9PVC5yZXBsYWNlV2l0aChST09UX0NMT05FLmNsb25lKCkpOwogICAgICAgICAgICBpZiAoIU9QVElPTlMuZGlzcGxheVNjcm9sbGJhcikgewogICAgICAgICAgICAgICAgJCgnYm9keScpLmNzcygnb3ZlcmZsb3cteScsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1bnJlZ2lzdGVyRXZlbnRIYW5kbGVycygpOwogICAgICAgICAgICByZW1vdmVQYWdlQ291bnQoKTsKICAgICAgICAgICAgX2Rpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZW5hYmxlKCkgewogICAgICAgIGlmIChfZGlzYWJsZWQpIHsKICAgICAgICAgICAgcmVzaXplSGFuZGxlcigpOwogICAgICAgICAgICByZWdpc3RlckV2ZW50SGFuZGxlcnMoKTsKICAgICAgICAgICAgX2Rpc2FibGVkID0gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVGFrZXMgYSBwYWdlIG51bWJlciBvciBVUkwgZnJhZ21lbnQgKCMpIGFuZCBnb2VzIHRvIHRoYXQgcGFnZS4KICAgICAqIEBwYXJhbSB0YXJnZXQKICAgICAqLwogICAgZnVuY3Rpb24gZ29Ubyh0YXJnZXQpIHsKICAgICAgICB2YXIgcGFnZU51bWJlcjsKICAgICAgICBpZiAodGFyZ2V0LnN1YnN0cigwLCAxKSA9PT0gIiMiKSB7CiAgICAgICAgICAgIGhhc2hDaGFuZ2VIYW5kbGVyKHRhcmdldCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVE9ETzogdmVyaWZ5IHRhcmdldCBpcyB2YWxpZCBpbnRlZ2VyCiAgICAgICAgICAgIHBhZ2VOdW1iZXIgPSB0YXJnZXQ7CiAgICAgICAgICAgIFBBR0VfQ09MTEVDVElPTi5zaG93UGFnZShwYWdlTnVtYmVyKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgICB2YXIgY3VycmVudCA9IFBBR0VfQ09MTEVDVElPTi5jdXJyZW50UGFnZTsKICAgICAgICB2YXIgbGFzdCA9IFBBR0VfQ09MTEVDVElPTi5sZW5ndGg7CgogICAgICAgIGlmIChjdXJyZW50IDwgbGFzdCkgewogICAgICAgICAgICB2YXIgc2Nyb2xsVG9wID0gUEFHRV9DT0xMRUNUSU9OLmdldFBhZ2UoY3VycmVudCArIDEpLm1pZFBvaW50OwogICAgICAgICAgICAkKHdpbmRvdykuc2Nyb2xsVG9wKHNjcm9sbFRvcCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHByZXZpb3VzKCkgewogICAgICAgIHZhciBjdXJyZW50ID0gUEFHRV9DT0xMRUNUSU9OLmN1cnJlbnRQYWdlOwoKICAgICAgICBpZiAoMSA8IGN1cnJlbnQpIHsKICAgICAgICAgICAgdmFyIHNjcm9sbFRvcCA9IFBBR0VfQ09MTEVDVElPTi5nZXRQYWdlKGN1cnJlbnQgLSAxKS5taWRQb2ludDsKICAgICAgICAgICAgJCh3aW5kb3cpLnNjcm9sbFRvcChzY3JvbGxUb3ApOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50SGFuZGxlcnMoKSB7CiAgICAgICAgJCh3aW5kb3cpLm9uKCdyZXNpemUnLCByZXNpemVIYW5kbGVyKTsKICAgICAgICAkKHdpbmRvdykub24oJ2tleWRvd24nLCBrZXlkb3duSGFuZGxlcik7CiAgICAgICAgJCh3aW5kb3cpLm9uKCdzY3JvbGwnLCBzY3JvbGxIYW5kbGVyKTsKICAgICAgICAkKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCBoYXNoQ2hhbmdlSGFuZGxlcik7CiAgICAgICAgJCh3aW5kb3cpLm9uKCd0b3VjaHN0YXJ0IHBvaW50ZXJkb3duIE1TUG9pbnRlckRvd24nLCB0b3VjaHN0YXJ0SGFuZGxlcik7CiAgICAgICAgJCh3aW5kb3cpLm9uKCd0b3VjaGVuZCBwb2ludGVydXAgTVNQb2ludGVyVXAnLCB0b3VjaGVuZEhhbmRsZXIpOwogICAgICAgICQod2luZG93KS5vbigndG91Y2htb3ZlIHBvaW50ZXJtb3ZlIE1TUG9pbnRlck1vdmUnLCB0b3VjaG1vdmVIYW5kbGVyKTsKICAgICAgICAkKHdpbmRvdy5kb2N1bWVudCkub24oJ3doZWVsJywgbW91c2V3aGVlbEhhbmRsZXIpOwogICAgICAgICQoJ2EnKS5vbignY2xpY2snLCBsaW5rSGFuZGxlcik7CiAgICB9CgogICAgZnVuY3Rpb24gdW5yZWdpc3RlckV2ZW50SGFuZGxlcnMoKSB7CiAgICAgICAgJCh3aW5kb3cpLm9mZigncmVzaXplJywgcmVzaXplSGFuZGxlcik7CiAgICAgICAgJCh3aW5kb3cpLm9mZigna2V5ZG93bicsIGtleWRvd25IYW5kbGVyKTsKICAgICAgICAkKHdpbmRvdykub2ZmKCdzY3JvbGwnLCBzY3JvbGxIYW5kbGVyKTsKICAgICAgICAkKHdpbmRvdykub2ZmKCdoYXNoY2hhbmdlJywgaGFzaENoYW5nZUhhbmRsZXIpOwogICAgICAgICQod2luZG93KS5vZmYoJ3RvdWNoc3RhcnQgcG9pbnRlcmRvd24gTVNQb2ludGVyRG93bicsIHRvdWNoc3RhcnRIYW5kbGVyKTsKICAgICAgICAkKHdpbmRvdykub2ZmKCd0b3VjaGVuZCBwb2ludGVydXAgTVNQb2ludGVyVXAnLCB0b3VjaGVuZEhhbmRsZXIpOwogICAgICAgICQod2luZG93KS5vZmYoJ3RvdWNobW92ZSBwb2ludGVybW92ZSBNU1BvaW50ZXJNb3ZlJywgdG91Y2htb3ZlSGFuZGxlcik7CiAgICAgICAgJCh3aW5kb3cuZG9jdW1lbnQpLm9mZignd2hlZWwnLCBtb3VzZXdoZWVsSGFuZGxlcik7CiAgICAgICAgJCgnYScpLm9mZignY2xpY2snLCBsaW5rSGFuZGxlcik7CiAgICB9CgogICAgLyoqCiAgICAgKiBMb2FkcyBhbnkgY3VzdG9tIENTUyBmaWxlIGludG8gYW4gaW5saW5lIDxzdHlsZT4gdGFnIGluIHRoZSBkb2N1bWVudCBoZWFkZXIuIFRoaXMgbWV0aG9kIGlzCiAgICAgKiBwcmVmZXJyZWQgb3ZlciBzaW1wbHkgbG9hZGluZyBhIDxsaW5rPiBlbGVtZW50LCBiZWNhdXNlIGJyb3dzZXIgc3VwcG9ydCBmb3IgZGV0ZWN0aW5nIHRoZSAibG9hZCIKICAgICAqIGV2ZW50IG9mIGR5bmFtaWNhbGx5IGxvYWRlZCBDU1MgZmlsZXMgaXMgY3VycmVudGx5IHZlcnkgcG9vciBhbmQgaW5jb25zaXN0ZW50LiBUaGVyZWZvcmUgd2UgdXNlCiAgICAgKiBBSkFYIHRvIGxvYWQgdGhlIENTUyBmaWxlIGFuZCBqdXN0IHB1dCB0aGUgY29udGVudHMgaW4gdGhlIGhlYWQuIFRoYXQgd2F5IHdlIGNhbiBndWFyYW50ZWUgdGhhdCBpdAogICAgICogaXMgbG9hZGVkIGJlZm9yZSBjb250aW51aW5nLCBpbiBhIGNyb3NzLWJyb3dzZXIgY29tcGF0aWJsZSB3YXkuCiAgICAgKiBAcmV0dXJucyB7Kn0KICAgICAqLwogICAgZnVuY3Rpb24gbG9hZEN1c3RvbUNzcygpIHsKCiAgICAgICAgdmFyIGRlZmVycmVkID0gbmV3ICQuRGVmZXJyZWQoKTsKCiAgICAgICAgaWYgKE9QVElPTlMuY3VzdG9tQ3NzRmlsZSkgewogICAgICAgICAgICAkLmdldChPUFRJT05TLmN1c3RvbUNzc0ZpbGUpLnRoZW4oc3VjY2Vzcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJCgnI2hyei1jdXN0b20tY3NzJykucmVtb3ZlKCk7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCiAgICAgICAgZnVuY3Rpb24gc3VjY2VzcyhkYXRhKSB7CiAgICAgICAgICAgIENVU1RPTV9DU1MgPSBkYXRhOwogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBwdWJsaWMgQVBJCiAgICAgKi8KICAgIHJldHVybiB7CiAgICAgICAgaW5pdDogaW5pdCwKICAgICAgICBkaXNhYmxlOiBkaXNhYmxlLAogICAgICAgIGVuYWJsZTogZW5hYmxlLAogICAgICAgIGdvVG86IGdvVG8sCiAgICAgICAgbmV4dDogbmV4dCwKICAgICAgICBwcmV2aW91czogcHJldmlvdXMKICAgIH07Cn0KCndpbmRvdy5ob3Jpem9uYWwgPSBuZXcgSG9yaXpvbmFsKCk7CgovKioKICogVGhpcyBpcyB0aGUgbWFpbiBtZXRob2QgdGhhdCBjb252ZXJ0cyB0aGUgZG9jdW1lbnQgdG8gYSBjb2xsZWN0aW9uIG9mIHBhZ2VzLiBTaW5jZSB0aGlzIG1ldGhvZCBjYW4gYmUgc2xvdyAoZGVwZW5kaW5nCiAqIG9uIHRoZSBudW1iZXIgb2YgRE9NIGVsZW1lbnRzIGluIHRoZSBkb2N1bWVudCksIGl0IHJ1bnMgYXN5bmMgYW5kIHJldHVybnMgYSBwcm9taXNlLgogKiBAcGFyYW0gY3VycmVudFNjcm9sbAogKi8KZnVuY3Rpb24gY29tcG9zZVBhZ2UoY3VycmVudFNjcm9sbCkgewoKICAgIHZhciBkZWZlcnJlZCA9IG5ldyAkLkRlZmVycmVkKCk7CiAgICBST09UID0gJChPUFRJT05TLnJvb3RFbGVtZW50KTsKICAgIHZhciBmcmFnbWVudCA9IGNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgIENPTlRBSU5FUiA9ICQoZnJhZ21lbnQucXVlcnlTZWxlY3RvcignI2hyei1jb250YWluZXInKSk7CiAgICBDT05UQUlORVIuY3NzKHsKICAgICAgICAnZGlzcGxheSc6ICdub25lJywgLy8gc2V0dGluZyBkaXNwbGF5Om5vbmUgY29uc2lkZXJhYmx5IHNwZWVkcyB1cCByZW5kZXJpbmcKICAgICAgICAndG9wJzogMCwKICAgICAgICAnbGVmdCc6IDAKICAgIH0pOwogICAgVklFV1BPUlRfSEVJR0hUID0gJCh3aW5kb3cpLmhlaWdodCgpIC0gT1BUSU9OUy5wYWdlTWFyZ2luICogMjsKCiAgICBkaXNwbGF5TG9hZGluZ0luZGljYXRvcigpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gYSBzZXRUaW1lb3V0IGlzIHVzZWQgdG8gZm9yY2UgYXN5bmMgZXhlY3V0aW9uIGFuZCBhbGxvdyB0aGUgbG9hZGluZ0luZGljYXRvciB0byBkaXNwbGF5IGJlZm9yZSB0aGUKICAgICAgICAvLyBoZWF2eSBjb21wdXRhdGlvbnMgb2YgY29tcG9zZVBhZ2UoKSBhcmUgYmVndW4uCiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIGlmICghT1BUSU9OUy5kaXNwbGF5U2Nyb2xsYmFyKSB7CiAgICAgICAgICAgICAgICAkKCdib2R5JykuY3NzKCdvdmVyZmxvdy15JywgJ2hpZGRlbicpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgYWxsTm9kZXMgPSBuZXcgTm9kZUNvbGxlY3Rpb24oT1BUSU9OUy5zZWxlY3Rvcik7CgogICAgICAgICAgICBQQUdFX0NPTExFQ1RJT04gPSBwYWdlQ29sbGVjdGlvbkdlbmVyYXRvci5mcm9tTm9kZUNvbGxlY3Rpb24oYWxsTm9kZXMpOwogICAgICAgICAgICBQQUdFX0NPTExFQ1RJT04uYXBwZW5kVG9Eb20oY3VycmVudFNjcm9sbCk7CgogICAgICAgICAgICAvLyByZW1vdmUgYW55IERPTSBub2RlcyB0aGF0IGFyZSBub3QgaW5jbHVkZWQgaW4gdGhlIHNlbGVjdG9yLAogICAgICAgICAgICAvLyBzaW5jZSB0aGV5IHdpbGwganVzdCBiZSBsZWZ0IGZsb2F0aW5nIGFyb3VuZCBpbiB0aGUgd3JvbmcgcGxhY2UuCiAgICAgICAgICAgIENPTlRBSU5FUi5jaGlsZHJlbigpLm5vdCgnLmhyei1wYWdlJykuZmlsdGVyKCc6dmlzaWJsZScpLnJlbW92ZSgpOwogICAgICAgICAgICBST09ULmVtcHR5KCkuYXBwZW5kKGZyYWdtZW50KTsKCiAgICAgICAgICAgIC8vIGFkZCB0aGUgdGhlbWUncyBjdXN0b20gQ1NTIHRvIHRoZSBkb2N1bWVudCBub3cgc28gdGhhdCBpdCBjYW4gYmUKICAgICAgICAgICAgLy8gdXNlZCBpbiBjYWxjdWxhdGluZyB0aGUgZWxlbWVudHMnIHN0eWxlcy4KICAgICAgICAgICAgYWRkQ3VzdG9tQ3NzVG9Eb2N1bWVudCgpOwoKICAgICAgICAgICAgUEFHRV9DT0xMRUNUSU9OLmZvckVhY2goZnVuY3Rpb24ocGFnZSkgewogICAgICAgICAgICAgICAgcGFnZS5ub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgICAgICAgIG5vZGUucmVuZGVyU3R5bGVzKHBhZ2UpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgQ09OVEFJTkVSLmNzcygnZGlzcGxheScsICcnKTsKCiAgICAgICAgICAgIHZhciBkb2N1bWVudEhlaWdodCA9IFBBR0VfQ09MTEVDVElPTi5sYXN0KCkuYm90dG9tIC8gT1BUSU9OUy5zY3JvbGxiYXJTaG9ydGVuUmF0aW8gKyBWSUVXUE9SVF9IRUlHSFQ7CiAgICAgICAgICAgIFJPT1QuaGVpZ2h0KGRvY3VtZW50SGVpZ2h0KTsKICAgICAgICAgICAgcmVuZGVyUGFnZUNvdW50KCk7CiAgICAgICAgICAgIHJlbW92ZUxvYWRpbmdJbmRpY2F0b3IoKTsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgpOwogICAgICAgIH0sIDApOwogICAgfSk7CgogICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKfQoKLyoqCiAqIEFkZCB0aGUgQ1NTIHRleHQgbG9hZGVkIGJ5IGxvYWRDdXN0b21Dc3MoKSBpbnRvIHRoZSBkb2N1bWVudCBoZWFkLgogKi8KZnVuY3Rpb24gYWRkQ3VzdG9tQ3NzVG9Eb2N1bWVudCgpIHsKICAgIHZhciAkY3VzdG9tQ3NzRWxlbWVudCA9ICQoJyNocnotY3VzdG9tLWNzcycpOwogICAgaWYgKDAgPCAkY3VzdG9tQ3NzRWxlbWVudC5sZW5ndGgpIHsKICAgICAgICAkY3VzdG9tQ3NzRWxlbWVudC50ZXh0KENVU1RPTV9DU1MpOwogICAgfSBlbHNlIHsKICAgICAgICAkKCdoZWFkJykuYXBwZW5kKCc8c3R5bGUgaWQ9Imhyei1jdXN0b20tY3NzIiB0eXBlPSJ0ZXh0L2NzcyI+JyArIENVU1RPTV9DU1MgKyAnPC9zdHlsZT4nKTsKICAgIH0KfQoKLyoqCiAqIEJ1aWxkaW5nIHVwIGEgZG9jdW1lbnRGcmFnbWVudCBhbmQgdGhlbiBhcHBlbmRpbmcgaXQgYWxsIGF0IG9uY2UgdG8gdGhlIERPTQogKiBpcyBkb25lIHRvIGltcHJvdmUgcGVyZm9ybWFuY2UuCiAqIEByZXR1cm5zIHsqfQogKi8KZnVuY3Rpb24gY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpIHsKICAgIHZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgIHZhciBjb250YWluZXJEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGNvbnRhaW5lckRpdi5pZCA9ICdocnotY29udGFpbmVyJzsKICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGNvbnRhaW5lckRpdik7CiAgICByZXR1cm4gZnJhZ21lbnQ7Cn0KCmZ1bmN0aW9uIGRpc3BsYXlMb2FkaW5nSW5kaWNhdG9yKCkgewogICAgdmFyIGRlZmVycmVkID0gbmV3ICQuRGVmZXJyZWQoKTsKICAgIGlmICgkKCcuaHJ6LWxvYWRpbmctaW5kaWNhdG9yJykubGVuZ3RoID09PSAwKSB7CiAgICAgICAgJCgnYm9keScpLmFwcGVuZCgnPGRpdiBjbGFzcz0iaHJ6LWxvYWRpbmctaW5kaWNhdG9yIiBzdHlsZT0iZGlzcGxheTpub25lOyI+PHAgY2xhc3M9Imhyei1sb2FkaW5nLWluZGljYXRvciI+TG9hZGluZy4uLjwvcD48L2Rpdj4nKTsKICAgICAgICAkKCdkaXYuaHJ6LWxvYWRpbmctaW5kaWNhdG9yJykuZmFkZUluKDUwLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgpOwogICAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKfQoKZnVuY3Rpb24gcmVtb3ZlTG9hZGluZ0luZGljYXRvcigpIHsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgJCgnZGl2Lmhyei1sb2FkaW5nLWluZGljYXRvcicpLmZhZGVPdXQoNTAsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkKHRoaXMpLnJlbW92ZSgpOwogICAgICAgIH0pOwogICAgfSwgMzAwKTsKfQoKZnVuY3Rpb24gcmVuZGVyUGFnZUNvdW50KCkgewogICAgaWYgKCQoJy5ocnotcGFnZS1jb3VudCcpLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHZhciBwYWdlQ291bnREaXYgPSAkKCc8ZGl2IGNsYXNzPSJocnotcGFnZS1jb3VudCI+PC9kaXY+Jyk7CiAgICAgICAgJCgnYm9keScpLmFwcGVuZChwYWdlQ291bnREaXYpOwogICAgICAgIHBhZ2VDb3VudERpdi5hcHBlbmQoJzxzcGFuIGlkPSJocnotY3VycmVudC1wYWdlIj48L3NwYW4+IC8gPHNwYW4gaWQ9Imhyei10b3RhbC1wYWdlcyI+PC9zcGFuPicpOwogICAgICAgICQoJyNocnotdG90YWwtcGFnZXMnKS5odG1sKFBBR0VfQ09MTEVDVElPTi5sZW5ndGgpOwogICAgICAgIGlmICghT1BUSU9OUy5kaXNwbGF5UGFnZUNvdW50KSB7CiAgICAgICAgICAgIHBhZ2VDb3VudERpdi5hZGRDbGFzcygnaGlkZGVuJyk7CiAgICAgICAgfQogICAgfQp9CgpmdW5jdGlvbiByZW1vdmVQYWdlQ291bnQoKSB7CiAgICAkKCcuaHJ6LXBhZ2UtY291bnQnKS5yZW1vdmUoKTsKfQoKZnVuY3Rpb24gdXBkYXRlUGFnZUNvdW50KCkgewogICAgJCgnI2hyei1jdXJyZW50LXBhZ2UnKS5odG1sKFBBR0VfQ09MTEVDVElPTi5jdXJyZW50UGFnZSk7Cn0KCi8qKgogKiArIEpvbmFzIFJhb25pIFNvYXJlcyBTaWx2YQogKiBAIGh0dHA6Ly9qc2Zyb21oZWxsLmNvbS9hcnJheS9zaHVmZmxlIFt2MS4wXQogKiBAcGFyYW0gbwogKiBAcmV0dXJucyB7Kn0KICovCmZ1bmN0aW9uIHNodWZmbGUobyl7CiAgICBmb3IodmFyIGosIHgsIGkgPSBvLmxlbmd0aDsgaTsgaiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGkpLCB4ID0gb1stLWldLCBvW2ldID0gb1tqXSwgb1tqXSA9IHgpOwogICAgcmV0dXJuIG87Cn0KCmZ1bmN0aW9uIG5vb3AoKSB7fQovKioKICogV2hlbiB0aGUgd2luZG93IGlzIHJlLXNpemVkLCB3ZSBuZWVkIHRvIHJlLWNhbGN1bGF0ZSB0aGUgbGF5b3V0IG9mIHRoZSBhbGwgdGhlIGVsZW1lbnRzLgogKiBUbyBlbnN1cmUgdGhhdCB3ZSBnZXQgdGhlIHNhbWUgcmVzdWx0cyBhcyB0aGUgaW5pdGlhbCBsb2FkLCB3ZSBzaW1wbGUgcHVyZ2UgdGhlIGVudGlyZSBST09UIGVsZW1lbnQKICogYW5kIHJlcGxhY2UgaXQgd2l0aCB0aGUgY2xvbmUgdGhhdCB3ZSBtYWRlIHJpZ2h0IGF0IHRoZSBzdGFydCBvZiB0aGUgaW5pdCgpIG1ldGhvZC4KICovCmZ1bmN0aW9uIHJlc2l6ZUhhbmRsZXIoKSB7CiAgICBkZWJvdW5jZShmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY3VycmVudFNjcm9sbCA9IFBBR0VfQ09MTEVDVElPTi5nZXRDdXJyZW50KCkubm9kZXNbMF0ubGF5b3V0LnRvcCAvIE9QVElPTlMuc2Nyb2xsYmFyU2hvcnRlblJhdGlvOwogICAgICAgIFJPT1QucmVwbGFjZVdpdGgoUk9PVF9DTE9ORS5jbG9uZSgpKTsKICAgICAgICBjb21wb3NlUGFnZShjdXJyZW50U2Nyb2xsKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkKHdpbmRvdykuc2Nyb2xsVG9wKGN1cnJlbnRTY3JvbGwpOwogICAgICAgICAgICB1cGRhdGVQYWdlQ291bnQoKTsKICAgICAgICAgICAgT1BUSU9OUy5vblJlc2l6ZSgpOwogICAgICAgIH0pOwogICAgfSwgMjUwKSgpOwp9CgovKioKICogQWxsb3cga2V5Ym9hcmQgcGFnaW5nIHdpdGggdGhlIGFycm93IGtleXMuCiAqIEBwYXJhbSBlCiAqLwpmdW5jdGlvbiBrZXlkb3duSGFuZGxlcihlKSB7CiAgICBpZiAoZS53aGljaCA9PT0gNDAgfHwgZS53aGljaCA9PT0gMzkpIHsKICAgICAgICBzY3JvbGxUb05leHRQYWdlKCk7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgfSBlbHNlIGlmIChlLndoaWNoID09PSAzOCB8fCBlLndoaWNoID09PSAzNykgewogICAgICAgIHNjcm9sbFRvUHJldmlvdXNQYWdlKCk7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgfQp9CgovKioKICogV2hlbiB0aGUgdmVydGljYWwgc2Nyb2xsYmFyIGlzIGVuYWJsZWQsIHdlIHdhbnQgdG8gdHJpZ2dlciBwYWdlIGNoYW5nZXMgYXQgdGhlIGFwcHJvcHJpYXRlIHBvaW50cywKICogd2hlcmUgdGhhdCBwYWdlIHdvdWxkIGhhdmUgYmVlbiBpbiBhIHJlZ3VsYXIgc2Nyb2xsaW5nIEhUTUwgcGFnZS4KICovCmZ1bmN0aW9uIHNjcm9sbEhhbmRsZXIoKSB7CiAgICBpZiAodHlwZW9mIFBBR0VfQ09MTEVDVElPTiAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICB2YXIgc2Nyb2xsVG9wID0gJCh3aW5kb3cpLnNjcm9sbFRvcCgpOwogICAgICAgIHZhciBjdXJyZW50UGFnZU51bWJlciA9IFBBR0VfQ09MTEVDVElPTi5jdXJyZW50UGFnZTsKCiAgICAgICAgdmFyIG5ld1BhZ2VOdW1iZXIgPSBQQUdFX0NPTExFQ1RJT04uZ2V0UGFnZUF0T2Zmc2V0KHNjcm9sbFRvcCAqIE9QVElPTlMuc2Nyb2xsYmFyU2hvcnRlblJhdGlvKS5wYWdlTnVtYmVyOwogICAgICAgIGlmIChuZXdQYWdlTnVtYmVyICE9PSBjdXJyZW50UGFnZU51bWJlcikgewogICAgICAgICAgICBQQUdFX0NPTExFQ1RJT04uc2hvd1BhZ2UobmV3UGFnZU51bWJlcik7CiAgICAgICAgICAgIHVwZGF0ZVBhZ2VDb3VudCgpOwogICAgICAgIH0KICAgIH0KfQoKdmFyIF9tb3VzZXdoZWVsTGFzdEV2ZW50OwovKioKICogSGFuZGxlciB0byB0aHJvdHRsZSB0aGUgYWN0aW9uIG9mIGEgc2Nyb2xsIHdoZWVsIG9uIGEgbW91c2UvbGFwdG9wIHRyYWNrcGFkLiBUaGlzIHByZXZlbnRzCiAqIHBhZ2VzIGJlaW5nIHNraXBwZWQgd2hlbiBhIGZhc3Qgc2Nyb2xsIG1vdGlvbiBpcyBwZXJmb3JtZWQuCiAqIEBwYXJhbSBlCiAqLwpmdW5jdGlvbiBtb3VzZXdoZWVsSGFuZGxlcihlKSB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgdmFyIG5vdyA9ICBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCiAgICBpZiAoMjUwIDwgbm93IC0gX21vdXNld2hlZWxMYXN0RXZlbnQgfHwgIV9tb3VzZXdoZWVsTGFzdEV2ZW50KSB7CiAgICAgICAgdmFyIGRlbHRhWSA9IGUub3JpZ2luYWxFdmVudC5kZWx0YVk7CiAgICAgICAgX21vdXNld2hlZWxMYXN0RXZlbnQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCiAgICAgICAgaWYgKGRlbHRhWSA8IDApIHsKICAgICAgICAgICAgc2Nyb2xsVG9QcmV2aW91c1BhZ2UoKTsKICAgICAgICB9IGVsc2UgaWYgKDAgPCBkZWx0YVkpIHsKICAgICAgICAgICAgc2Nyb2xsVG9OZXh0UGFnZSgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKDI1MCA8IG5vdyAtIF9tb3VzZXdoZWVsTGFzdEV2ZW50KSB7CiAgICAgICAgICAgIF9tb3VzZXdoZWVsTGFzdEV2ZW50ID0gbnVsbDsKICAgICAgICB9CiAgICB9Cn0KCi8qKgogKiBUbyBhbGxvdyBVUkwgZnJhZ21lbnRzICgjKSB0byB3b3JrLCB3ZSBuZWVkIHRvIGZpbmQgdGhlIGxvY2F0aW9uIG9mIHRoZSBlbGVtZW50IHdpdGggdGhlIElECiAqIG1hdGNoaW5nIHRoZSBmcmFnbWVudCwgZmlndXJlIG91dCB3aGF0IHBhZ2UgaXQgaXMgb24sIGFuZCB0aGVuIGdvIHRvIHRoYXQgcGFnZS4KICovCmZ1bmN0aW9uIGhhc2hDaGFuZ2VIYW5kbGVyKCkgewogICAgdmFyIGhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaDsKICAgIGlmIChoYXNoICE9PSAnJykgewogICAgICAgIHZhciBwYWdlID0gJChoYXNoKS5jbG9zZXN0KCcuaHJ6LXBhZ2UnKTsKICAgICAgICB2YXIgcGFnZU51bWJlciA9IHBhcnNlSW50KHBhZ2UuYXR0cignaWQnKS5yZXBsYWNlKC9eXEQrL2csICcnKSk7CiAgICAgICAgUEFHRV9DT0xMRUNUSU9OLnNob3dQYWdlKHBhZ2VOdW1iZXIpOwogICAgICAgICQod2luZG93KS5zY3JvbGxUb3AoUEFHRV9DT0xMRUNUSU9OLmdldEN1cnJlbnQoKS5taWRQb2ludCk7CiAgICAgICAgdXBkYXRlUGFnZUNvdW50KCk7CiAgICB9Cn0KCi8qKgogKiBUaGlzIGV2ZW50IGhhbmRsZXIgaXMgZm9yIHRoZSBwYXJ0aWN1bGFyIHNjZW5hcmlvIG9mIHdoZW4gYSBsaW5rIHRvIGEgVVJMIGZyYWdtZW50IGluIHRoaXMgZG9jdW1lbnQgaXMgY2xpY2tlZCwKICogYnV0IHRoYXQgZnJhZ21lbnQgaXMgYWxyZWFkeSBpbiB0aGUgaGFzaCBwYXJ0IG9mIHRoZSB3aW5kb3cubG9jYXRpb24uIEluIHRoaXMgY2FzZSwgdGhlIGhhc2ggd2lsbCBub3QgY2hhbmdlIHNvCiAqIHdlIG5lZWQgdG8gbWFudWFsbHkgdHJpZ2dlciB0aGUgaGFzaGNoYW5nZSBldmVudCB0byBzaW11bGF0ZSB0aGUgZXhwZWN0ZWQgYmVoYXZpb3VyLgogKi8KZnVuY3Rpb24gbGlua0hhbmRsZXIoZSkgewogICAgdmFyIGN1cnJlbnRIYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2g7CiAgICBpZiAoY3VycmVudEhhc2ggIT09ICcnKSB7CiAgICAgICAgdmFyIHVybCA9ICQodGhpcykuYXR0cignaHJlZicpOwogICAgICAgIGlmICh1cmwuc3Vic3RyKDAsIDEpID09PSAnIycpIHsKICAgICAgICAgICAgaWYgKHVybCA9PT0gY3VycmVudEhhc2gpIHsKICAgICAgICAgICAgICAgIGhhc2hDaGFuZ2VIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCnZhciBfdG91Y2hTdGFydFBvczsKdmFyIF90b3VjaFN0YXJ0VGltZTsKLyoqCiAqIEF0IHRoZSBzdGFydCBvZiBhIHRvdWNoIHdlIHNpbXBseSBuZWVkIHRvIHJlY29yZCB0aGUgdGltZSBhbmQgcG9zaXRpb24gb2YgdGhlIHRvdWNoLAogKiB0byB1c2UgbGF0ZXIgaW4gd29ya2luZyBvdXQgaG93IHRvIGhhbmRsZSBpdC4KICogQHBhcmFtIGUKICovCmZ1bmN0aW9uIHRvdWNoc3RhcnRIYW5kbGVyKGUpIHsKICAgIGlmIChpc1ZhbGlkVG91Y2hFdmVudChlKSkgewogICAgICAgIF90b3VjaFN0YXJ0UG9zID0gIHsKICAgICAgICAgICAgeDogZ2V0VG91Y2hYKGUpLAogICAgICAgICAgICB5OiBnZXRUb3VjaFkoZSkKICAgICAgICB9OwogICAgICAgIF90b3VjaFN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgfQp9CgovKioKICogV2UgcHJldmVudCB0aGUgZGVmYXVsdCB0b3VjaG1vdmUgYmVoYXZpb3VyIGJlY2F1c2Ugd2UgZG9uJ3Qgd2FudCB0aGUgcGFnZSB0byBzY3JvbGwgbmF0dXJhbGx5IC0gd2UKICogd2FudCB0byBjb250cm9sIHRoZSBzY3JvbGxpbmcgcHJvZ3JhbW1hdGljYWxseSB0byBlbnN1cmUgb25seSBvbmUgcGFnZSBpcyBhZHZhbmNlZCBwZXIgc3dpcGUuCiAqIEBwYXJhbSBlCiAqLwpmdW5jdGlvbiB0b3VjaG1vdmVIYW5kbGVyKGUpIHsKICAgIGlmIChpc1ZhbGlkVG91Y2hFdmVudChlKSkgewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgdmFyIHRvdWNoRW5kUG9zID0gewogICAgICAgICAgICB4OiBnZXRUb3VjaFgoZSksCiAgICAgICAgICAgIHk6IGdldFRvdWNoWShlKQogICAgICAgIH07CiAgICAgICAgdmFyIHRvdWNoRW5kVGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwoKICAgICAgICBpZiAoaXNWYWxpZFN3aXBlKF90b3VjaFN0YXJ0VGltZSwgdG91Y2hFbmRUaW1lLCBfdG91Y2hTdGFydFBvcywgdG91Y2hFbmRQb3MpKSB7CiAgICAgICAgICAgIHZhciBkaXJlY3Rpb24gPSBnZXRTd2lwZURpcmVjdGlvbihfdG91Y2hTdGFydFBvcywgdG91Y2hFbmRQb3MpOwogICAgICAgICAgICBzd2l0Y2ggKGRpcmVjdGlvbikgewogICAgICAgICAgICAgICAgY2FzZSAndXAnOgogICAgICAgICAgICAgICAgICAgIENPTlRBSU5FUi5jc3MoJ3RvcCcsICctMzBweCcpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnZG93bic6CiAgICAgICAgICAgICAgICAgICAgQ09OVEFJTkVSLmNzcygndG9wJywgJzMwcHgnKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2xlZnQnOgogICAgICAgICAgICAgICAgICAgIENPTlRBSU5FUi5jc3MoJ2xlZnQnLCAnLTMwcHgnKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ3JpZ2h0JzoKICAgICAgICAgICAgICAgICAgICBDT05UQUlORVIuY3NzKCdsZWZ0JywgJzMwcHgnKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLyoqCiAqIEF0IHRoZSBlbmQgb2YgdGhlIHRvdWNoLCB3ZSBhZ2FpbiByZWNvcmQgdGhlIHRpbWUgYW5kIHBvc2l0aW9uLCBhbmQgdGhlbiB1c2UgdGhlc2UgZGF0YSB0byBmaWd1cmUgb3V0CiAqIGlmIHdlIHNob3VsZCB0cmVhdCB0aGlzIGFzIGEgInN3aXBlIiwgYW5kIGlmIHNvLCBpbiB3aGF0IGRpcmVjdGlvbiB0aGUgc3dpcGUgd2FzLiBUaGVuIHdlIGNhbgogKiBtb3ZlIHRvIHRoZSBuZXh0IG9yIHByZXZpb3VzIHBhZ2UgYXMgYXBwcm9wcmlhdGUuCiAqIEBwYXJhbSBlCiAqLwpmdW5jdGlvbiB0b3VjaGVuZEhhbmRsZXIoZSkgewogICAgaWYgKGlzVmFsaWRUb3VjaEV2ZW50KGUpKSB7CiAgICAgICAgdmFyIHNjcm9sbFRvOwogICAgICAgIHZhciB0b3VjaEVuZFBvcyA9IHsKICAgICAgICAgICAgeDogZ2V0VG91Y2hYKGUpLAogICAgICAgICAgICB5OiBnZXRUb3VjaFkoZSkKICAgICAgICB9OwogICAgICAgIHZhciB0b3VjaEVuZFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCiAgICAgICAgQ09OVEFJTkVSLmNzcygndG9wJywgJzBweCcpOwogICAgICAgIENPTlRBSU5FUi5jc3MoJ2xlZnQnLCAnMHB4Jyk7CgogICAgICAgIGlmIChpc1ZhbGlkU3dpcGUoX3RvdWNoU3RhcnRUaW1lLCB0b3VjaEVuZFRpbWUsIF90b3VjaFN0YXJ0UG9zLCB0b3VjaEVuZFBvcykpIHsKICAgICAgICAgICAgdmFyIGRpcmVjdGlvbiA9IGdldFN3aXBlRGlyZWN0aW9uKF90b3VjaFN0YXJ0UG9zLCB0b3VjaEVuZFBvcyk7CiAgICAgICAgICAgIGlmIChkaXJlY3Rpb24gPT09ICJkb3duIiB8fCBkaXJlY3Rpb24gPT09ICJyaWdodCIpIHsKICAgICAgICAgICAgICAgIHNjcm9sbFRvUHJldmlvdXNQYWdlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzY3JvbGxUb05leHRQYWdlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJCh3aW5kb3cpLnNjcm9sbFRvcChzY3JvbGxUbyk7CiAgICAgICAgfQogICAgfQp9CgovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQovLwovLyBVdGlsaXR5IGZ1bmN0aW9ucyB1c2VkIGJ5IHRoZSBldmVudCBoYW5kbGVycwovLwovLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKLyoqCiAqIFRoZSB3YXkgdGhlIGV2ZW50IGhhbmRsZXJzIGNoYW5nZSBmcm9tIG9uZSBwYWdlIHRvIHRoZSBuZXh0IGlzIGJ5CiAqIHNldHRpbmcgdGhlIHZhbHVlIG9mIHdpbmRvdy5zY3JvbGxUb3AsIGFuZCB0aGVuIGxldHRpbmcgdGhlCiAqIHNjcm9sbCBoYW5kbGVyIHRha2UgY2FyZSBvZiBhY3R1YWxseSBkb2luZyB0aGUgdHJhbnNpdGlvbgogKi8KZnVuY3Rpb24gc2Nyb2xsVG9OZXh0UGFnZSgpIHsKICAgIHZhciBzY3JvbGxUbzsKICAgIGlmIChQQUdFX0NPTExFQ1RJT04uY3VycmVudFBhZ2UgPCBQQUdFX0NPTExFQ1RJT04ubGVuZ3RoKSB7CiAgICAgICAgc2Nyb2xsVG8gPSBQQUdFX0NPTExFQ1RJT04uZ2V0TmV4dCgpLm1pZFBvaW50OwogICAgICAgICQod2luZG93KS5zY3JvbGxUb3Aoc2Nyb2xsVG8pOwogICAgfQp9CgpmdW5jdGlvbiBzY3JvbGxUb1ByZXZpb3VzUGFnZSgpIHsKICAgIHZhciBzY3JvbGxUbzsKICAgIGlmIChQQUdFX0NPTExFQ1RJT04uY3VycmVudFBhZ2UgPT09IDIpIHsKICAgICAgICBzY3JvbGxUbyA9IDA7CiAgICB9IGVsc2UgaWYgKDEgPCBQQUdFX0NPTExFQ1RJT04uY3VycmVudFBhZ2UpIHsKICAgICAgICBzY3JvbGxUbyA9IFBBR0VfQ09MTEVDVElPTi5nZXRQcmV2aW91cygpLm1pZFBvaW50OwogICAgfQogICAgaWYgKHR5cGVvZiBzY3JvbGxUbyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAkKHdpbmRvdykuc2Nyb2xsVG9wKHNjcm9sbFRvKTsKICAgIH0KfQoKLyoqCiAqIFdlIHdhbnQgdG8gcHJldmVudCB0aGUgcmVzaXplSGFuZGxlciBiZWluZyBjYWxsZWQgdG9vIG9mdGVuIGFzIHRoZSBwYWdlIGlzIHJlLXNpemVkLgogKiBAcGFyYW0gZnVuCiAqIEBwYXJhbSBtaWwKICogQHJldHVybnMge0Z1bmN0aW9ufQogKi8KZnVuY3Rpb24gZGVib3VuY2UoZnVuLCBtaWwpewogICAgdmFyIHRpbWVyOwogICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgZnVuLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwgbWlsKTsKICAgIH07Cn0KCi8qKgogKiBJbnRlcm5ldCBFeHBsb3JlciB1c2VzIHRoZSBQb2ludGVyIEV2ZW50cyBtb2RlbCBmb3IgYm90aCB0b3VjaCBhbmQgbW91c2UgZXZlbnRzLiBUaGVyZWZvcmUsIHdoZW4gd2UgYmluZCB0byB0aGUKICogJ3BvaW50ZXJkb3duJywgJ3BvaW50ZXJ1cCcgZXRjLiBldmVudHMsIHRoZXkgd2lsbCBhbHNvIGJlIGZpcmVkIHdoZW4gdGhlIG1vdXNlIGlzIGNsaWNrZWQsIHdoaWNoIHdlIGRvIG5vdCB3YW50LgogKiBUaGVyZWZvcmUgd2UgZmlsdGVyIG91dCB0aGUgZXZlbnRzIHRoYXQgYXJlIHRyaWdnZXJlZCBieSBtb3VzZS4KICogQHBhcmFtIGUKICogQHJldHVybnMge2Jvb2xlYW59CiAqLwpmdW5jdGlvbiBpc1ZhbGlkVG91Y2hFdmVudChlKSB7CiAgICBpZiAoZS5vcmlnaW5hbEV2ZW50Lmhhc093blByb3BlcnR5KCdwb2ludGVyVHlwZScpKSB7CiAgICAgICAgaWYgKGUub3JpZ2luYWxFdmVudC5wb2ludGVyVHlwZSA9PT0gJ21vdXNlJykgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KCi8qKgogKiBUbyBiZSB2YWxpZCwgYSBzd2lwZSBtdXN0IHRyYXZlbCBhIHN1ZmZpY2llbnQgZGlzdGFuY2UgYWNyb3NzIHRoZSBzY3JlZW4gKHRvIGRpc3Rpbmd1aXNoIGZyb20gc2xvcHB5CiAqIGNsaWNrcyksIGFuZCBtdXN0IGJlIGZhaXJseSBmYXN0ICh0byBkaXN0aW5ndWlzaCBmcm9tIGhpZ2hsaWdodGluZyB0ZXh0IGF0dGVtcHRzKQogKiBAcGFyYW0gc3RhcnRUaW1lCiAqIEBwYXJhbSBlbmRUaW1lCiAqIEBwYXJhbSBzdGFydFBvcwogKiBAcGFyYW0gZW5kUG9zCiAqLwpmdW5jdGlvbiBpc1ZhbGlkU3dpcGUoc3RhcnRUaW1lLCBlbmRUaW1lLCBzdGFydFBvcywgZW5kUG9zKSB7CiAgICB2YXIgTUFYX0lOVEVSVkFMID0gNzAwOwogICAgdmFyIE1JTl9ESVNUQU5DRSA9IDc1OwogICAgdmFyIHRpbWVJbnRlcnZhbCA9IGVuZFRpbWUgLSBzdGFydFRpbWU7CiAgICB2YXIgZFggPSBlbmRQb3MueCAtIHN0YXJ0UG9zLng7CiAgICB2YXIgZFkgPSBlbmRQb3MueSAtIHN0YXJ0UG9zLnk7CiAgICB2YXIgc3dpcGVEaXN0YW5jZSA9IE1hdGguc3FydChkWCAqIGRYICsgZFkgKiBkWSk7CgogICAgaWYgKE1BWF9JTlRFUlZBTCA8IHRpbWVJbnRlcnZhbCB8fAogICAgICAgIHN3aXBlRGlzdGFuY2UgPCBNSU5fRElTVEFOQ0UpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQp9CgovKioKICogR2l2ZW4gYSBwYWlyIG9mIGNvb3JkaW5hdGVzIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHN0YXJ0IGFuZCBlbmQgcG9zaXRpb25zIG9mIHRoZSBzd2lwZSwgd2UgY2FuCiAqIGNhbGN1bGF0ZSBhIHZlY3RvciBhbmQgaXRzIGFuZ2xlIHJlbGF0aXZlIHRvIHRoZSB4LWF4aXMuIFVzaW5nIHRoaXMgaW5mb3JtYXRpb24gd2UgY2FuIGZpZ3VyZQogKiBvdXQgdGhlIGRpcmVjdGlvbiBvZiB0aGUgc3dpcGUgKHVwLCBkb3duLCBsZWZ0IG9yIHJpZ2h0KS4KICogQHBhcmFtIHN0YXJ0UG9zCiAqIEBwYXJhbSBlbmRQb3MKICogQHJldHVybnMgeyp9CiAqLwpmdW5jdGlvbiBnZXRTd2lwZURpcmVjdGlvbihzdGFydFBvcywgZW5kUG9zKSB7CiAgICB2YXIgZFggPSBlbmRQb3MueCAtIHN0YXJ0UG9zLng7CiAgICB2YXIgZFkgPSBlbmRQb3MueSAtIHN0YXJ0UG9zLnk7CiAgICB2YXIgYW5nbGUgPSBNYXRoLmF0YW4yKGRZLCBkWCk7CiAgICB2YXIgZGlyZWN0aW9uOwogICAgaWYgKC1NYXRoLlBJLzQgPCBhbmdsZSAmJiBhbmdsZSA8PSBNYXRoLlBJLzQpIHsKICAgICAgICBkaXJlY3Rpb24gPSAicmlnaHQiOwogICAgfSBlbHNlIGlmICgtMy80Kk1hdGguUEkgPCBhbmdsZSAmJiBhbmdsZSA8PSAtTWF0aC5QSS80KSB7CiAgICAgICAgZGlyZWN0aW9uID0gInVwIjsKICAgIH0gZWxzZSBpZiAoMy80Kk1hdGguUEkgPCBhbmdsZSB8fCBhbmdsZSA8IC0zLzQqTWF0aC5QSSkgewogICAgICAgIGRpcmVjdGlvbiA9ICJsZWZ0IjsKICAgIH0gZWxzZSB7CiAgICAgICAgZGlyZWN0aW9uID0gImRvd24iOwogICAgfQogICAgcmV0dXJuIGRpcmVjdGlvbjsKfQoKLyoqCiAqIEludGVybmV0IEV4cGxvcmVyIHVzZXMgYSBkaWZmZXJlbnQgbW9kZWwgZm9yIHRvdWNoIGV2ZW50cyBmcm9tIFdlYmtpdCBicm93c2VycyBhbmQgb3RoZXJzLAogKiBzbyB3ZSBuZWVkIHRvIGRvIGEgc21hbGwgY2hlY2sgdG8gZ2V0IHRoZSBjb3JyZWN0IHBvc2l0aW9ucyBvZiB0b3VjaCBldmVudHMuCiAqIEBwYXJhbSBlCiAqIEByZXR1cm5zIHsqfQogKi8KZnVuY3Rpb24gZ2V0VG91Y2hYKGUpIHsKICAgIHZhciB4OwogICAgaWYgKGUub3JpZ2luYWxFdmVudC5oYXNPd25Qcm9wZXJ0eSgnY2hhbmdlZFRvdWNoZXMnKSkgewogICAgICAgIHggPSBlLm9yaWdpbmFsRXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0uY2xpZW50WDsKICAgIH0gZWxzZSB7CiAgICAgICAgeCA9IGUub3JpZ2luYWxFdmVudC5jbGllbnRYOwogICAgfQogICAgcmV0dXJuIHg7Cn0KCmZ1bmN0aW9uIGdldFRvdWNoWShlKSB7CiAgICB2YXIgeTsKICAgIGlmIChlLm9yaWdpbmFsRXZlbnQuaGFzT3duUHJvcGVydHkoJ2NoYW5nZWRUb3VjaGVzJykpIHsKICAgICAgICB5ID0gZS5vcmlnaW5hbEV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLmNsaWVudFk7CiAgICB9IGVsc2UgewogICAgICAgIHkgPSBlLm9yaWdpbmFsRXZlbnQuY2xpZW50WTsKICAgIH0KICAgIHJldHVybiB5Owp9Ci8qKgogKiBBIGhlbHBlciBzZXJ2aWNlIGZvciBKYXZhU2NyaXB0LWJhc2VkIHRyYW5zaXRpb24gYW5pbWF0aW9ucy4gVXNpbmcgdGhpcyBzZXJ2aWNlIGVuc3VyZXMgdGhhdCBvbmx5IGEgc2luZ2xlCiAqIHJlcXVlc3RBbmltYXRpb25GcmFtZSBsb29wIGlzIGNyZWF0ZWQsIGFuZCBhbGwgYW5pbWF0aW9uIGZ1bmN0aW9ucyBhcmUgZXhlY3V0ZWQgd2l0aGluIHRoaXMgc2luZ2xlIGxvb3AuCiAqCiAqIFRoZSBgYW5pbWF0b3JgIG9iamVjdCBpcyBwYXNzZWQgYXMgYW4gYXJndW1lbnQgdG8gdGhlIGNhbGxiYWNrIGZ1bmN0aW9ucyBkZWZpbmVkIGluIHRoZSBjb25maWcgb2JqZWN0LgogKi8KdmFyIGFuaW1hdG9yID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgbW9kdWxlID0ge307CiAgICB2YXIgYW5pbWF0aW9uRnVuY3Rpb25zID0gW107CgogICAgbW9kdWxlLnN0YXJ0ID0gZnVuY3Rpb24oZm4pIHsKICAgICAgICBhbmltYXRpb25GdW5jdGlvbnMucHVzaChmbik7CiAgICAgICAgaWYgKGFuaW1hdGlvbkZ1bmN0aW9ucy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKTsKICAgICAgICB9CiAgICB9OwoKICAgIG1vZHVsZS5zdG9wID0gZnVuY3Rpb24oZm4pIHsKICAgICAgICBhbmltYXRpb25GdW5jdGlvbnMuc3BsaWNlKGFuaW1hdGlvbkZ1bmN0aW9ucy5pbmRleE9mKGZuKSwgMSk7CiAgICB9OwoKICAgIGZ1bmN0aW9uIHRpY2sodGltZXN0YW1wKSB7CiAgICAgICAgYW5pbWF0aW9uRnVuY3Rpb25zLmZvckVhY2goZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgZm4uY2FsbChmbiwgdGltZXN0YW1wKTsKICAgICAgICB9KTsKICAgICAgICBpZiAoMCA8IGFuaW1hdGlvbkZ1bmN0aW9ucy5sZW5ndGgpIHsKICAgICAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIG1vZHVsZTsKfSgpOwovKioKICogQSBOb2RlIG9iamVjdCByZXByZXNlbnRzIGEgRE9NIGVsZW1lbnQuIEFuIGFjdHVhbCByZWZlcmVuY2UgdG8gdGhlIEhUTUxFbGVtZW50IG9iamVjdCBpcyBjb250YWluZWQgaW4gdGhlICdkb21Ob2RlJyBwcm9wZXJ0eS4KICogQHBhcmFtIGRvbU5vZGUKICogQHBhcmFtIGluZGV4CiAqIEBjb25zdHJ1Y3RvcgogKi8KZnVuY3Rpb24gTm9kZShkb21Ob2RlLCBpbmRleCkgewogICAgdGhpcy5kb21Ob2RlID0gZG9tTm9kZTsKICAgIHRoaXMuaW5kZXggPSBpbmRleDsKICAgIHRoaXMuaXNDbG9uZSA9IGZhbHNlOwogICAgdGhpcy5sYXlvdXQgPSB0aGlzLmdldExheW91dCgpOwogICAgdGhpcy5pc1RhbGwgPSBmYWxzZTsKICAgIHRoaXMucGFnZU92ZXJoYW5nID0gMDsKICAgIHRoaXMub3JpZ2luYWxDb21wdXRlZFN0eWxlID0gdGhpcy5jbG9uZUNvbXB1dGVkU3R5bGUoKTsKICAgIHRoaXMuc3RhZ2dlck9yZGVyID0gMDsKfQoKTm9kZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAgKiBJbiBvcmRlciB0byBlbnN1cmUgYSBmYWl0aGZ1bCB2aXN1YWwgcmVwcm9kdWN0aW9uIG9mIHRoZSBvcmlnaW5hbCBwYWdlLCBiZWZvcmUgd2UgZG8gYW55dGhpbmcgd2l0aCB0aGUgRE9NLCB3ZQogICAgICogbmVlZCB0byBzdG9yZSBhIGNvcHkgb2YgKmFsbCogb2YgdGhlIGNvbXB1dGVkIENTUyBzdHlsZSBydWxlcyB0aGF0IGFwcGx5IHRvIHRoaXMgRE9NIG5vZGUuIFdlIHdpbGwgdXNlIHRoaXMKICAgICAqIGluZm9ybWF0aW9uIGF0IHRoZSBmaW5hbCByZW5kZXJpbmcgc3RlcCBpbiBvcmRlciB0byBwZXJmb3JtIGEgZGlmZiBhbmQgaW5saW5lIGFueSBjaGFuZ2VkIHN0eWxlcy4KICAgICAqIEByZXR1cm5zIHsqfQogICAgICovCiAgICBjbG9uZUNvbXB1dGVkU3R5bGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjb21wdXRlZFN0eWxlQ2xvbmUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKS5zdHlsZTsKICAgICAgICB2YXIgY29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHRoaXMuZG9tTm9kZSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb21wdXRlZFN0eWxlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gY29tcHV0ZWRTdHlsZVtpXTsKICAgICAgICAgICAgY29tcHV0ZWRTdHlsZUNsb25lLnNldFByb3BlcnR5KG5hbWUsCiAgICAgICAgICAgICAgICBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUobmFtZSksCiAgICAgICAgICAgICAgICBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5UHJpb3JpdHkobmFtZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tcHV0ZWRTdHlsZUNsb25lOwogICAgfSwKCiAgICAvKioKICAgICAqIENhbGN1bGF0ZSB0aGUgYm91bmRpbmcgYm94IGFuZCBhYnNvbHV0ZSBwb3NpdGlvbiBvZiB0aGUgbm9kZSBhbmQgcmV0dXJuIGl0IGFzIGFuIG9iamVjdC4KICAgICAqIEByZXR1cm5zIHt7dG9wOiBudW1iZXIsIGxlZnQ6IG51bWJlciwgYm90dG9tOiBudW1iZXIsIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyfX0KICAgICAqLwogICAgZ2V0TGF5b3V0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgJG5vZGUgPSAkKHRoaXMuZG9tTm9kZSksCiAgICAgICAgICAgIGxlZnQgPSAkbm9kZS5vZmZzZXQoKS5sZWZ0IC0gUk9PVC5vZmZzZXQoKS5sZWZ0LAogICAgICAgICAgICB0b3AgPSAkbm9kZS5vZmZzZXQoKS50b3AgLSBST09ULm9mZnNldCgpLnRvcCAtIHBhcnNlSW50KCRub2RlLmNzcygnbWFyZ2luLXRvcCcpKSwKICAgICAgICAgICAgd2lkdGggPSAkbm9kZS53aWR0aCgpICsgcGFyc2VJbnQoJG5vZGUuY3NzKCdwYWRkaW5nLWxlZnQnKSkgKyBwYXJzZUludCgkbm9kZS5jc3MoJ3BhZGRpbmctcmlnaHQnKSksCiAgICAgICAgICAgIGhlaWdodCA9ICRub2RlLmhlaWdodCgpICsgcGFyc2VJbnQoJG5vZGUuY3NzKCdwYWRkaW5nLXRvcCcpKSArIHBhcnNlSW50KCRub2RlLmNzcygncGFkZGluZy1ib3R0b20nKSksCiAgICAgICAgICAgIGJvdHRvbSA9IHRvcCArIGhlaWdodDsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdG9wOiB0b3AsCiAgICAgICAgICAgIGxlZnQ6IGxlZnQsCiAgICAgICAgICAgIGJvdHRvbTogYm90dG9tLAogICAgICAgICAgICB3aWR0aDogd2lkdGgsCiAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0CiAgICAgICAgfTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBXaGVuIGEgbm9kZSBpcyBvdmVyIGhhbGYgdGhlIGhlaWdodCBvZiB0aGUgdmlld3BvcnQsIGFuZCBhbHNvIGV4dGVuZHMgb2ZmIHRoZSBib3R0b20gb2YgYSBnaXZlbiBwYWdlLAogICAgICogd2UgbmVlZCB0byBjbG9uZSBpdCBhbmQgcHV0IHRoZSBjbG9uZSBvbiB0aGUgbmV4dCBwYWdlLCB0byBnaXZlIHRoZSBpbXByZXNzaW9uIHRoYXQgdGhlIG5vZGUgaXMgc3Bhbm5pbmcKICAgICAqIHR3byAob3IgbW9yZSkgcGFnZXMuIERlcGVuZGluZyBvbiB0aGUgaGVpZ2h0IG9mIHRoZSBub2RlLCBpdCB3aWxsIGJlIGNsb25lZCBob3dldmVyIG1hbnkgdGltZXMgYXJlCiAgICAgKiByZXF1aXJlZCB0byBhbGxvdyB0aGUgZW50aXJlIG5vZGUgdG8gYmUgZGlzcGxheWVkIG92ZXIgc3VjY2Vzc2l2ZSBwYWdlcy4KICAgICAqIEBwYXJhbSBpbmRleAogICAgICovCiAgICBtYWtlQ2xvbmU6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgdmFyIGNsb25lZERvbU5vZGUgPSAkKHRoaXMuZG9tTm9kZSkuY2xvbmUoKVswXTsKICAgICAgICB2YXIgY2xvbmUgPSBuZXcgTm9kZShjbG9uZWREb21Ob2RlLCBpbmRleCk7CiAgICAgICAgY2xvbmUubGF5b3V0ID0gewogICAgICAgICAgICAndG9wJyA6IHRoaXMubGF5b3V0LnRvcCwKICAgICAgICAgICAgJ2xlZnQnIDogdGhpcy5sYXlvdXQubGVmdCwKICAgICAgICAgICAgJ3dpZHRoJyA6IHRoaXMubGF5b3V0LndpZHRoLAogICAgICAgICAgICAnaGVpZ2h0JyA6IHRoaXMubGF5b3V0LmhlaWdodCwKICAgICAgICAgICAgJ2JvdHRvbScgOiB0aGlzLmxheW91dC5ib3R0b20KICAgICAgICB9OwogICAgICAgIGNsb25lLmlzQ2xvbmUgPSB0cnVlOwoKICAgICAgICByZXR1cm4gY2xvbmU7CiAgICB9LAoKICAgIC8qKgogICAgICogQXBwZW5kIHRoZSBET00gbm9kZSB0byB0aGUgY29ycmVjdCBwYWdlIGRpdgogICAgICogQHBhcmFtIHBhcmVudFBhZ2UKICAgICAqLwogICAgYXBwZW5kVG9Eb206IGZ1bmN0aW9uKHBhcmVudFBhZ2UpIHsKICAgICAgICAkKHRoaXMuZG9tTm9kZSkuYWRkQ2xhc3MocGFyZW50UGFnZS5wYWdlSWQpOwogICAgICAgIENPTlRBSU5FUi5maW5kKCcjJyArIHBhcmVudFBhZ2UucGFnZUlkKS5hcHBlbmQodGhpcy5kb21Ob2RlKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBBcHBseSB0aGUgQ1NTIHN0eWxlcyB0aGF0IGVuc3VyZSB0aGUgbm9kZSBsb29rcyB0aGUgc2FtZSBhcyBpdCBkaWQgaW4gdGhlCiAgICAgKiBvcmlnaW5hbCBkb2N1bWVudC4KICAgICAqIEBwYXJhbSBwYXJlbnRQYWdlCiAgICAgKi8KICAgIHJlbmRlclN0eWxlczogZnVuY3Rpb24ocGFyZW50UGFnZSkgewogICAgICAgIHRoaXMuYXBwbHlTdHlsZURpZmYoKTsKICAgICAgICAkKHRoaXMuZG9tTm9kZSkuYWRkQ2xhc3MoJ2hyei1lbGVtZW50Jyk7CiAgICAgICAgdGhpcy5zZXRDc3NQb3NpdGlvbihwYXJlbnRQYWdlKTsKICAgICAgICB0aGlzLnNldFRyYW5zaXRpb25EZWxheSgpOwogICAgICAgIHRoaXMuc2V0UmVzdG9yZVBvaW50KCk7CiAgICB9LAoKICAgIC8qKgogICAgICogQXBwbHkgdGhlIHN0eWxlIHJ1bGVzIG5lZWRlZCB0byBtYWtlIHRoZQogICAgICogRE9NIG5vZGUgYXBwZWFyIGlkZW50aWNhbCB0byB0aGUgb3JpZ2luYWwgZm9ybS4KICAgICAqLwogICAgYXBwbHlTdHlsZURpZmY6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzdHlsZURpZmYgPSB0aGlzLmdldFN0eWxlRGlmZigpOwogICAgICAgICQodGhpcy5kb21Ob2RlKS5jc3Moc3R5bGVEaWZmKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBBcHBseSB0aGUgYWJzb2x1dGUgcG9zaXRpb25pbmcgdG8gbWFrZSB0aGUgRE9NIG5vZGUgYXBwZWFyIGluCiAgICAgKiB0aGUgY29ycmVjdCBwbGFjZSBvbiB0aGUgcGFnZS4KICAgICAqIEBwYXJhbSBwYXJlbnRQYWdlCiAgICAgKi8KICAgIHNldENzc1Bvc2l0aW9uOiBmdW5jdGlvbihwYXJlbnRQYWdlKSB7CiAgICAgICAgdmFyIHBhZ2VNYXJnaW4gPSBwYXJlbnRQYWdlLnBhZ2VOdW1iZXIgPT09IDEgPyAwIDogT1BUSU9OUy5wYWdlTWFyZ2luOwogICAgICAgICQodGhpcy5kb21Ob2RlKS5jc3MoewogICAgICAgICAgICAncG9zaXRpb24nOiAnYWJzb2x1dGUnLAogICAgICAgICAgICAndG9wJyA6IHRoaXMubGF5b3V0LnRvcCAtIHBhcmVudFBhZ2UudG9wICsgcGFnZU1hcmdpbiArICdweCcsCiAgICAgICAgICAgICdsZWZ0JyA6IHRoaXMubGF5b3V0LmxlZnQgKyAncHgnLAogICAgICAgICAgICAnd2lkdGgnIDogdGhpcy5sYXlvdXQud2lkdGggKyAncHgnLAogICAgICAgICAgICAnaGVpZ2h0JyA6IHRoaXMubGF5b3V0LmhlaWdodCArICdweCcKICAgICAgICB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBJZiB0aGUgc3RhZ2dlckRlbGF5IG9wdGlvbiBpcyBzZXQsIHRoZW4gd2UgY2hlY2sgdG8gc2VlIGlmIHRoaXMgbm9kZSBoYXMgZWl0aGVyIGEgQ1NTIHRyYW5zaXRpb24gb3IgQ1NTIGFuaW1hdGlvbgogICAgICogc3R5bGUgcnVsZSBhcHBsaWVkIHRvIGl0LiBJZiBzbywgd2UgZHluYW1pY2FsbHkgc2V0IHRoZSB0cmFuc2l0aW9uLWRlbGF5IG9yIGFuaW1hdGlvbi1kZWxheSB2YWx1ZSB0byBnaXZlIHRoZQogICAgICogc3RhZ2dlciBlZmZlY3QuCiAgICAgKi8KICAgIHNldFRyYW5zaXRpb25EZWxheTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHN0YWdnZXIgPSB0aGlzLmdldFN0YWdnZXJEZWxheSgpOwogICAgICAgIGlmICgwIDwgc3RhZ2dlcikgewogICAgICAgICAgICB2YXIgY3NzID0gJCh0aGlzLmRvbU5vZGUpLmNzcy5iaW5kKCQodGhpcy5kb21Ob2RlKSk7CiAgICAgICAgICAgIHZhciB0cmFuc2l0aW9uRHVyYXRpb25Jc0RlZmluZWQgPSBleGlzdHNBbmRJc05vdFplcm8oY3NzKCd0cmFuc2l0aW9uLWR1cmF0aW9uJykpIHx8IGV4aXN0c0FuZElzTm90WmVybyhjc3MoJy13ZWJraXQtdHJhbnNpdGlvbi1kdXJhdGlvbicpKTsKICAgICAgICAgICAgdmFyIGFuaW1hdGlvbkR1cmF0aW9uSXNEZWZpbmVkID0gZXhpc3RzQW5kSXNOb3RaZXJvKGNzcygnYW5pbWF0aW9uLWR1cmF0aW9uJykpIHx8IGV4aXN0c0FuZElzTm90WmVybyhjc3MoJy13ZWJraXQtYW5pbWF0aW9uLWR1cmF0aW9uJykpOwogICAgICAgICAgICBpZiAodHJhbnNpdGlvbkR1cmF0aW9uSXNEZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjc3MoewogICAgICAgICAgICAgICAgICAgICd0cmFuc2l0aW9uLWRlbGF5Jzogc3RhZ2dlciArICdzJywKICAgICAgICAgICAgICAgICAgICAnLXdlYmtpdC10cmFuc2l0aW9uLWRlbGF5Jzogc3RhZ2dlciArICdzJwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFuaW1hdGlvbkR1cmF0aW9uSXNEZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjc3MoewogICAgICAgICAgICAgICAgICAgICdhbmltYXRpb24tZGVsYXknOiBzdGFnZ2VyICsgJ3MnLAogICAgICAgICAgICAgICAgICAgICctd2Via2l0LWFuaW1hdGlvbi1kZWxheSc6IHN0YWdnZXIgKyAncycKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBleGlzdHNBbmRJc05vdFplcm8ocHJvcGVydHkpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBwcm9wZXJ0eSAhPT0gJ3VuZGVmaW5lZCcgJiYgcHJvcGVydHkgIT09ICcwcyc7CiAgICAgICAgfQogICAgfSwKCiAgICBnZXRTdGFnZ2VyRGVsYXk6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkZWxheSA9IE9QVElPTlMuc3RhZ2dlckRlbGF5ICogdGhpcy5zdGFnZ2VyT3JkZXI7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoZGVsYXkgKiAxMDApIC8gMTAwOwogICAgfSwKCiAgICAvKioKICAgICAqIEluIG9yZGVyIHRvIG1ha2UgdGhlIGZpbmFsIHJlbmRlcmVkIERPTSBub2RlIGFwcGVhciBpZGVudGljYWwgdG8gaG93IGl0IGRpZCBvbiB0aGUgb3JpZ2luYWwgcGFnZSwKICAgICAqIHdlIHRvb2sgYSBzbmFwc2hvdCBvZiBhbGwgdGhlIGNvbXB1dGVkIENTUyBzdHlsZXMgYmVmb3JlIG1ha2luZyBhbnkgY2hhbmdlcyB0byB0aGUgcGFnZSBsYXlvdXQuCiAgICAgKiBOb3cgdGhhdCB3ZSBoYXZlIHJlbW92ZWQgdGhlIERPTSBub2RlIGZyb20gdGhlIG9yaWdpbmFsIHBsYWNlIGluIHRoZSBkb2N1bWVudCwgYW55IGNhc2NhZGVkCiAgICAgKiBzdHlsZXMgZnJvbSBwYXJlbnQgZGl2cyB3aWxsIGhhdmUgYmVlbiBsb3N0LgogICAgICoKICAgICAqIFRoaXMgZGlmZiBtZXRob2QgZ2V0cyB0aGUgY3VycmVudCBjb21wdXRlZCBDU1Mgc3R5bGVzIGZvciB0aGUgbm9kZSwgYW5kIGNvbXBhcmVzIHRoZW0gdG8gdGhlCiAgICAgKiBzbmFwc2hvdCB3ZSB0b29rIHdpdGggdGhlIGNsb25lQ29tcHV0ZWRTdHlsZSgpIG1ldGhvZC4gSWYgYW55IG9mIHRoZSBzdHlsZSBydWxlcyBhcmUgbm90IGVxdWFsLAogICAgICogd2UgYWRkIHRoZW0gdG8gdGhlIHN0eWxlRGlmZiBvYmplY3Qgc28gd2UgY2FuIGFwcGx5IHRoZW0gaW5saW5lIHRvIHRoZSBET00gbm9kZS4KICAgICAqIEByZXR1cm5zIHt7fX0KICAgICAqLwogICAgZ2V0U3R5bGVEaWZmOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc3R5bGVEaWZmID0ge307CiAgICAgICAgdmFyIG5ld0NvbXB1dGVkU3R5bGVzID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUodGhpcy5kb21Ob2RlKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdDb21wdXRlZFN0eWxlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgbmFtZSA9IG5ld0NvbXB1dGVkU3R5bGVzW2ldOwogICAgICAgICAgICB2YXIgb2xkUHJvcGVydHlWYWx1ZSA9IHRoaXMub3JpZ2luYWxDb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUobmFtZSk7CgogICAgICAgICAgICBpZiAobmV3Q29tcHV0ZWRTdHlsZXMuZ2V0UHJvcGVydHlWYWx1ZShuYW1lKSAhPSBvbGRQcm9wZXJ0eVZhbHVlKSB7CiAgICAgICAgICAgICAgICAvLyBJbnRlcm5ldCBFeHBsb3JlciBoYXMgc3RyYW5nZSBiZWhhdmlvdXIgd2l0aCBpdHMgb3duIGRlcHJlY2F0ZWQgcHJlZml4ZWQgdmVyc2lvbiBvZiB0cmFuc2l0aW9uLCBhbmltYXRpb24gYW5kCiAgICAgICAgICAgICAgICAvLyBvdGhlcnMuIFRoaXMgYnJlYWtzIHRoZXNlIENTUyBmZWF0dXJlcyBpbiB0aGF0IGJyb3dzZXIsIHNvIHRoZSB3b3JrYXJvdW5kIGhlcmUgaXMgdG8ganVzdCBvbWl0IGFsbCB0aG9zZQogICAgICAgICAgICAgICAgLy8gSUUtc3BlY2lmaWMgcHJlZml4ZXMuCiAgICAgICAgICAgICAgICBpZiAoIG5hbWUuc3Vic3RyaW5nKDAsIDMpID09ICItbXMiKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob2xkUHJvcGVydHlWYWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHN0eWxlRGlmZltuZXdDb21wdXRlZFN0eWxlc1tpXV0gPSBvbGRQcm9wZXJ0eVZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc3R5bGVEaWZmOwogICAgfSwKCiAgICAvKioKICAgICAqIFRyaWdnZXIgdGhlIG9uTm9kZVRyYW5zaXRpb24gY2FsbGJhY2sgYW5kIHBhc3MgdGhpcyBub2RlIGFuZCB0aGUgdHlwZSBvZiB0cmFuc2l0aW9uOgogICAgICogLSB0b0ZvcmVncm91bmQKICAgICAqIC0gdG9CYWNrZ3JvdW5kCiAgICAgKiAtIHRvRm9jdXNGcm9tRm9yZQogICAgICogLSB0b0ZvY3VzRnJvbUJhY2sKICAgICAqIEBwYXJhbSB0eXBlCiAgICAgKi8KICAgIG1vdmVUbzogZnVuY3Rpb24odHlwZSkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBPUFRJT05TLm9uTm9kZVRyYW5zaXRpb24odHlwZSwgc2VsZi5nZXRQdWJsaWNPYmplY3QoKSwgYW5pbWF0b3IpOwogICAgICAgIH0sIHRoaXMuZ2V0U3RhZ2dlckRlbGF5KCkgKiAxMDAwKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBTdG9yZSBhIGNvcHkgb2YgdGhlIGZpbmFsIGNvbXB1dGVkIGlubGluZSBzdHlsZSBzbyB0aGF0IHRoZSBub2RlCiAgICAgKiBjYW4gYmUgZWFzaWx5IHJlc3RvcmVkIHRvIHRoZSBzdHlsZSBpdCBoYWQgYWZ0ZXIgaW5pdGlhbGl6YXRpb24uCiAgICAgKiBUaGUgY2xvbmVOb2RlKCkgbWV0aG9kIGlzIG5lY2Vzc2FyeSBhcyBvdGhlcndpc2Ugd2Ugd2lsbCBqdXN0CiAgICAgKiBnZXQgYSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgc3R5bGUsIHdoaWNoIHdpbGwgY2hhbmdlIGFzIHRoZQogICAgICogY3VycmVudCBzdHlsZSBjaGFuZ2VzLgogICAgICovCiAgICBzZXRSZXN0b3JlUG9pbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaW5saW5lU3R5bGUgPSB0aGlzLmRvbU5vZGUuY2xvbmVOb2RlKCkuc3R5bGU7CiAgICB9LAoKICAgIC8qKgogICAgICogUmVzdG9yZSB0aGUgZG9tTm9kZSB0byB0aGUgc3R5bGUgaXQgaGFkIGFmdGVyIGluaXRpYWxpemF0aW9uLgogICAgICogVGhpcyBtZXRob2QgaXMgaW50ZW5kZWQgYXMgYSBjb252ZW5pZW50IGhlbHBlciBmb3IgdGhvc2Ugd3JpdGluZwogICAgICogSmF2YVNjcmlwdC1iYXNlZCB0cmFuc2l0aW9ucy4KICAgICAqLwogICAgcmVzdG9yZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG5hbWUsIGk7CiAgICAgICAgLy8gZmlyc3Qgd2UgbmVlZCB0byBkZWxldGUgYWxsIHRoZSBzdHlsZSBydWxlcwogICAgICAgIC8vIGN1cnJlbnRseSBkZWZpbmVkIG9uIHRoZSBlbGVtZW50CiAgICAgICAgZm9yIChpID0gdGhpcy5kb21Ob2RlLnN0eWxlLmxlbmd0aDsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgbmFtZSA9IHRoaXMuZG9tTm9kZS5zdHlsZVtpXTsKICAgICAgICAgICAgdGhpcy5kb21Ob2RlLnN0eWxlLnJlbW92ZVByb3BlcnR5KG5hbWUpOwogICAgICAgIH0KICAgICAgICAvLyBub3cgd2UgbG9vcCB0aHJvdWdoIHRoZSBvcmlnaW5hbCBDU1NTdHlsZURlY2xhcmF0aW9uCiAgICAgICAgLy8gb2JqZWN0IGFuZCBzZXQgZWFjaCBwcm9wZXJ0eSB0byBpdHMgb3JpZ2luYWwgdmFsdWUKICAgICAgICBmb3IgKGkgPSB0aGlzLmlubGluZVN0eWxlLmxlbmd0aDsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgbmFtZSA9IHRoaXMuaW5saW5lU3R5bGVbaV07CiAgICAgICAgICAgIHRoaXMuZG9tTm9kZS5zdHlsZS5zZXRQcm9wZXJ0eShuYW1lLAogICAgICAgICAgICAgICAgdGhpcy5pbmxpbmVTdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKG5hbWUpLAogICAgICAgICAgICAgICAgcHJpb3JpdHkgPSB0aGlzLmlubGluZVN0eWxlLmdldFByb3BlcnR5UHJpb3JpdHkobmFtZSkpOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYSBzdWJzZXQgb2YgcHJvcGVydGllcyBvZiB0aGUgcHJpdmF0ZSBOb2RlIG9iamVjdCwgZm9yIHVzZSBpbgogICAgICogdGhlIGphdmFzY3JpcHQgY2FsbGJhY2tzIHNldCB1cCBpbiB0aGUgaG9yaXpvbmFsIGNvbmZpZyBvYmplY3QuCiAgICAgKgogICAgICogQHJldHVybnMge3tkb21Ob2RlOiAqLCBpbmRleDogKiwgc3RhZ2dlck9yZGVyOiAqfX0KICAgICAqLwogICAgZ2V0UHVibGljT2JqZWN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBkb21Ob2RlOiB0aGlzLmRvbU5vZGUsCiAgICAgICAgICAgIGluZGV4OiB0aGlzLmluZGV4LAogICAgICAgICAgICBzdGFnZ2VyT3JkZXI6IHRoaXMuc3RhZ2dlck9yZGVyLAogICAgICAgICAgICByZXN0b3JlOiB0aGlzLnJlc3RvcmUuYmluZCh0aGlzKQogICAgICAgIH07CiAgICB9Cn07CgoKCmZ1bmN0aW9uIE5vZGVDb2xsZWN0aW9uKHNlbGVjdG9yKSB7CiAgICBpZiAodHlwZW9mIHNlbGVjdG9yICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHRoaXMuZnJvbVNlbGVjdG9yKHNlbGVjdG9yKTsKICAgIH0KfQoKdmFyIE5vZGVDb2xsZWN0aW9uQVBJID0gewoKICAgIGZyb21TZWxlY3RvcjogZnVuY3Rpb24oc2VsZWN0b3IpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgdmFyIGFsbE5vZGVzID0gUk9PVC5maW5kKHNlbGVjdG9yKS5maWx0ZXIoJzp2aXNpYmxlJykubm90KCcuaHJ6LWxvYWRpbmctaW5kaWNhdG9yJyk7CgogICAgICAgIHZhciB0b3BMZXZlbE5vZGVzID0gJChbXSk7CiAgICAgICAgYWxsTm9kZXMuZWFjaChmdW5jdGlvbihpbmRleCwgZG9tTm9kZSkgewogICAgICAgICAgICBpZiAoJChkb21Ob2RlKS5wYXJlbnRzKHNlbGVjdG9yKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHRvcExldmVsTm9kZXMgPSB0b3BMZXZlbE5vZGVzLmFkZChkb21Ob2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB0b3BMZXZlbE5vZGVzLmVhY2goZnVuY3Rpb24oaW5kZXgsIGRvbU5vZGUpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBuZXcgTm9kZShkb21Ob2RlLCBpbmRleCk7CiAgICAgICAgICAgIHNlbGYucHVzaChub2RlKTsKICAgICAgICB9KTsKICAgIH0sCgogICAgYXBwZW5kVG9Eb206IGZ1bmN0aW9uKHBhcmVudFBhZ2UpIHsKICAgICAgICAvLyBhdCB0aGlzIHN0YWdlIHdlIGNhbiBhc3NpZ24gYW4gYXBwcm9wcmlhdGUgc3RhZ2dlck9yZGVyIHRvCiAgICAgICAgLy8gdGhlIG5vZGVzLCBzaW5jZSB3ZSBub3cga25vdyBob3cgbWFueSBhcmUgb24gZWFjaCBwYWdlLgogICAgICAgIHZhciBzdGFnZ2VyT3JkZXIgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8PSB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHN0YWdnZXJPcmRlci5wdXNoKGkpOwogICAgICAgIH0KICAgICAgICBpZiAoT1BUSU9OUy5zdGFnZ2VyID09PSAncmFuZG9tJykgewogICAgICAgICAgICBzdGFnZ2VyT3JkZXIgPSBzaHVmZmxlKHN0YWdnZXJPcmRlcik7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24obm9kZSwgaW5kZXgpIHsKICAgICAgICAgICAgbm9kZS5zdGFnZ2VyT3JkZXIgPSBzdGFnZ2VyT3JkZXJbaW5kZXhdOwogICAgICAgICAgICBub2RlLmFwcGVuZFRvRG9tKHBhcmVudFBhZ2UpOwogICAgICAgIH0pOwogICAgfQp9OwoKTm9kZUNvbGxlY3Rpb24ucHJvdG90eXBlID0gW107CiQuZXh0ZW5kKE5vZGVDb2xsZWN0aW9uLnByb3RvdHlwZSwgTm9kZUNvbGxlY3Rpb25BUEkpOwoKZnVuY3Rpb24gUGFnZShwYWdlTnVtYmVyKSB7CiAgICB0aGlzLnRvcCA9IDA7CiAgICB0aGlzLmJvdHRvbSA9IDA7CiAgICB0aGlzLmhlaWdodCA9IDA7CiAgICB0aGlzLm5vZGVzID0gbmV3IE5vZGVDb2xsZWN0aW9uKCk7CiAgICB0aGlzLnBhZ2VOdW1iZXIgPSBwYWdlTnVtYmVyIHx8IDA7CiAgICB0aGlzLmRvbU5vZGUgPSBudWxsOwogICAgdGhpcy5oaWRlVGltZXIgPSBudWxsOwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAicGFnZUlkIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiaHJ6LXBhZ2UtIiArIHRoaXMucGFnZU51bWJlcjsKICAgICAgICB9CiAgICB9KTsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgIm1pZFBvaW50IiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAodGhpcy5ib3R0b20gKyB0aGlzLnRvcCkgLyAyIC8gT1BUSU9OUy5zY3JvbGxiYXJTaG9ydGVuUmF0aW87CiAgICAgICAgfQogICAgfSk7Cn0KClBhZ2UucHJvdG90eXBlID0gewoKICAgIGFkZE5vZGU6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICB0aGlzLm5vZGVzLnB1c2gobm9kZSk7CiAgICB9LAoKICAgIGFwcGVuZFRvRG9tOiBmdW5jdGlvbihjdXJyZW50UGFnZSkgewogICAgICAgIHZhciB6Q2xhc3MgPSAiIjsKICAgICAgICBpZiAodGhpcy5wYWdlTnVtYmVyIDwgY3VycmVudFBhZ2UpIHsKICAgICAgICAgICAgekNsYXNzID0gImhyei1iYWNrIGhyei1oaWRkZW4iOwogICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFBhZ2UgPCB0aGlzLnBhZ2VOdW1iZXIpIHsKICAgICAgICAgICAgekNsYXNzID0gImhyei1mb3JlIGhyei1oaWRkZW4iOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHpDbGFzcyA9ICJocnotZm9jdXMtZnJvbS1mb3JlIjsKICAgICAgICB9CiAgICAgICAgQ09OVEFJTkVSLmFwcGVuZCgnPGRpdiBjbGFzcz0iaHJ6LXBhZ2UgJyArIHpDbGFzcyArICciIGlkPSInICsgdGhpcy5wYWdlSWQgKyAnIiAvPicpOwogICAgICAgIHRoaXMuZG9tTm9kZSA9IENPTlRBSU5FUi5maW5kKCcjJyArIHRoaXMucGFnZUlkKVswXTsKICAgICAgICB0aGlzLm5vZGVzLmFwcGVuZFRvRG9tKHRoaXMpOwogICAgfSwKCiAgICBtb3ZlVG9Gb3JlZ3JvdW5kOiBmdW5jdGlvbigpIHsKICAgICAgICBPUFRJT05TLm9uUGFnZVRyYW5zaXRpb24oJ3RvRm9yZWdyb3VuZCcsIHRoaXMuZ2V0UHVibGljT2JqZWN0KCksIGFuaW1hdG9yKTsKICAgICAgICAkKHRoaXMuZG9tTm9kZSkuYWRkQ2xhc3MoJ2hyei1mb3JlJykucmVtb3ZlQ2xhc3MoJ2hyei1iYWNrIGhyei1mb2N1cy1mcm9tLWJhY2sgaHJ6LWZvY3VzLWZyb20tZm9yZScpOwogICAgICAgIHRoaXMuaGlkZUFmdGVyRGVsYXkoKTsKICAgICAgICB0aGlzLm5vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICBub2RlLm1vdmVUbygndG9Gb3JlZ3JvdW5kJyk7CiAgICAgICAgfSk7CiAgICB9LAoKICAgIG1vdmVUb0JhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewogICAgICAgIE9QVElPTlMub25QYWdlVHJhbnNpdGlvbigndG9CYWNrZ3JvdW5kJywgdGhpcy5nZXRQdWJsaWNPYmplY3QoKSwgYW5pbWF0b3IpOwogICAgICAgICQodGhpcy5kb21Ob2RlKS5hZGRDbGFzcygnaHJ6LWJhY2snKS5yZW1vdmVDbGFzcygnaHJ6LWZvcmUgaHJ6LWZvY3VzLWZyb20tYmFjayBocnotZm9jdXMtZnJvbS1mb3JlJyk7CiAgICAgICAgdGhpcy5oaWRlQWZ0ZXJEZWxheSgpOwogICAgICAgIHRoaXMubm9kZXMuZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIG5vZGUubW92ZVRvKCd0b0JhY2tncm91bmQnKTsKICAgICAgICB9KTsKICAgIH0sCgogICAgbW92ZVRvRm9jdXNGcm9tQmFja2dyb3VuZDogZnVuY3Rpb24oKSB7CiAgICAgICAgT1BUSU9OUy5vblBhZ2VUcmFuc2l0aW9uKCd0b0ZvY3VzRnJvbUJhY2snLCB0aGlzLmdldFB1YmxpY09iamVjdCgpLCBhbmltYXRvcik7CiAgICAgICAgJCh0aGlzLmRvbU5vZGUpLmFkZENsYXNzKCdocnotZm9jdXMtZnJvbS1iYWNrJyk7CiAgICAgICAgdGhpcy5fbW92ZVRvRm9jdXMoJ3RvRm9jdXNGcm9tQmFjaycpOwogICAgfSwKCiAgICBtb3ZlVG9Gb2N1c0Zyb21Gb3JlZ3JvdW5kOiBmdW5jdGlvbigpIHsKICAgICAgICBPUFRJT05TLm9uUGFnZVRyYW5zaXRpb24oJ3RvRm9jdXNGcm9tRm9yZScsIHRoaXMuZ2V0UHVibGljT2JqZWN0KCksIGFuaW1hdG9yKTsKICAgICAgICAkKHRoaXMuZG9tTm9kZSkuYWRkQ2xhc3MoJ2hyei1mb2N1cy1mcm9tLWZvcmUnKTsKICAgICAgICB0aGlzLl9tb3ZlVG9Gb2N1cygndG9Gb2N1c0Zyb21Gb3JlJyk7CiAgICB9LAoKICAgIF9tb3ZlVG9Gb2N1czogZnVuY3Rpb24odHlwZSkgewogICAgICAgICQodGhpcy5kb21Ob2RlKS5yZW1vdmVDbGFzcygnaHJ6LWZvcmUgaHJ6LWJhY2sgaHJ6LWhpZGRlbicpOwogICAgICAgIGlmICh0aGlzLmhpZGVUaW1lciAhPT0gbnVsbCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5oaWRlVGltZXIpOwogICAgICAgICAgICB0aGlzLmhpZGVUaW1lciA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHRoaXMubm9kZXMuZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgIG5vZGUubW92ZVRvKHR5cGUpOwogICAgICAgIH0pOwogICAgfSwKCiAgICBoaWRlQWZ0ZXJEZWxheTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyICR0aGlzTm9kZSA9ICQodGhpcy5kb21Ob2RlKTsKICAgICAgICB0aGlzLmhpZGVUaW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkdGhpc05vZGUuYWRkQ2xhc3MoJ2hyei1oaWRkZW4nKTsKICAgICAgICB9LCBPUFRJT05TLnBhZ2VIaWRlRGVsYXkgKiAxMDAwKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYSBzdWJzZXQgb2YgcHJvcGVydGllcyBvZiB0aGUgcHJpdmF0ZSBQYWdlIG9iamVjdCwgZm9yIHVzZSBpbgogICAgICogdGhlIGphdmFzY3JpcHQgY2FsbGJhY2tzIHNldCB1cCBpbiB0aGUgaG9yaXpvbmFsIGNvbmZpZyBvYmplY3QuCiAgICAgKgogICAgICogQHJldHVybnMge3tkb21Ob2RlOiAqLCBpbmRleDogKiwgc3RhZ2dlck9yZGVyOiAqfX0KICAgICAqLwogICAgZ2V0UHVibGljT2JqZWN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBkb21Ob2RlOiB0aGlzLmRvbU5vZGUsCiAgICAgICAgICAgIHBhZ2VOdW1iZXI6IHRoaXMucGFnZU51bWJlcgogICAgICAgIH07CiAgICB9Cn07CmZ1bmN0aW9uIFBhZ2VDb2xsZWN0aW9uKCkgewoKICAgIHZhciBfY3VycmVudFBhZ2UgPSAxOwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAiY3VycmVudFBhZ2UiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIF9jdXJyZW50UGFnZTsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmxhc3QoKSA8IHZhbCkgewogICAgICAgICAgICAgICAgX2N1cnJlbnRQYWdlID0gdGhpcy5sYXN0KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsIDwgMSkgewogICAgICAgICAgICAgICAgX2N1cnJlbnRQYWdlID0gMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9jdXJyZW50UGFnZSA9IHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwp9Cgp2YXIgUGFnZUNvbGxlY3Rpb25BUEkgPSB7CgogICAgZ2V0UGFnZTogZnVuY3Rpb24ocGFnZU51bWJlcikgewogICAgICAgIGlmICgwIDwgcGFnZU51bWJlciAmJiBwYWdlTnVtYmVyIDw9IHRoaXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW3BhZ2VOdW1iZXIgLSAxXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbmV3IFBhZ2UoKTsKICAgICAgICB9CiAgICB9LAoKICAgIGdldEN1cnJlbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldFBhZ2UodGhpcy5jdXJyZW50UGFnZSk7CiAgICB9LAoKICAgIGdldE5leHQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldFBhZ2UodGhpcy5jdXJyZW50UGFnZSArIDEpOwogICAgfSwKCiAgICBnZXRQcmV2aW91czogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UGFnZSh0aGlzLmN1cnJlbnRQYWdlIC0gMSk7CiAgICB9LAoKICAgIGFkZDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHBhZ2VOdW1iZXIgPSB0aGlzLmxlbmd0aCArIDE7CiAgICAgICAgdmFyIG5ld1BhZ2UgPSBuZXcgUGFnZShwYWdlTnVtYmVyKTsKICAgICAgICBuZXdQYWdlLnRvcCA9IHRoaXMuZ2V0UGFnZSh0aGlzLmxlbmd0aCkuYm90dG9tOwogICAgICAgIHRoaXMucHVzaChuZXdQYWdlKTsKICAgIH0sCgogICAgbGFzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXNbdGhpcy5sZW5ndGggLSAxXTsKICAgIH0sCgogICAgZ2V0TGFzdE9mZnNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGFzdCgpLnRvcDsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICogR2l2ZW4gYSB5LWF4aXMgb2Zmc2V0IGluIHBpeGVscywgcmV0dXJuIHRoZSBwYWdlIGluIHRoZSBjb2xsZWN0aW9uIHdoaWNoIGNvbnRhaW5zIHRoaXMKICAgICAqIG9mZnNldCBiZXR3ZWVuIGl0cyB0b3AgYW5kIGJvdHRvbSBwcm9wZXJ0aWVzLiBJZiB0aGUgb2Zmc2V0IGlzIG5vdCB2YWxpZCwgcmV0dXJuIHRoZQogICAgICogZmlyc3QgcGFnZS4KICAgICAqIEBwYXJhbSBvZmZzZXQKICAgICAqLwogICAgZ2V0UGFnZUF0T2Zmc2V0OiBmdW5jdGlvbihvZmZzZXQpIHsKICAgICAgICByZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24ocGFnZSkgewogICAgICAgICAgICByZXR1cm4gKHBhZ2UudG9wIDw9IG9mZnNldCAmJiBvZmZzZXQgPCBwYWdlLmJvdHRvbSk7CiAgICAgICAgfSlbMF0gfHwgdGhpc1swXTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBBcHBlbmRzIGFsbCB0aGUgcGFnZXMgYW5kIHBhZ2UgZWxlbWVudHMgdG8gdGhlIGRvY3VtZW50RnJhZ21lbnQgcmVmZXJlbmNlZCBieSBDT05UQUlORVIKICAgICAqIEBwYXJhbSBjdXJyZW50U2Nyb2xsCiAgICAgKi8KICAgIGFwcGVuZFRvRG9tOiBmdW5jdGlvbihjdXJyZW50U2Nyb2xsKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIGN1cnJlbnRTY3JvbGwgPSBjdXJyZW50U2Nyb2xsIHx8IDA7CiAgICAgICAgdGhpcy5jdXJyZW50UGFnZSA9IHRoaXMuZ2V0UGFnZUF0T2Zmc2V0KGN1cnJlbnRTY3JvbGwgKiBPUFRJT05TLnNjcm9sbGJhclNob3J0ZW5SYXRpbykucGFnZU51bWJlcjsKICAgICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24ocGFnZSkgewogICAgICAgICAgICBwYWdlLmFwcGVuZFRvRG9tKHNlbGYuY3VycmVudFBhZ2UpOwogICAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICAqIFRvIHNob3cgYSBnaXZlbiBwYWdlLCB3ZSBqdXN0IG5lZWQgdG8gcmVtb3ZlIHRoZSAtZm9yZSBhbmQgLWJhY2sgQ1NTIGNsYXNzZXMKICAgICAqIGZyb20gdGhlIHBhZ2UgYW5kIHRoZSBub2RlcyBvbiB0aGF0IHBhZ2UuIExvd2VyLW9yZGVyZWQgcGFnZXMgaGF2ZSB0aGUgLWZvcmUKICAgICAqIGNsYXNzIGFkZGVkLCBhbmQgaGlnaGVyLW9yZGVyZWQgcGFnZXMgaGF2ZSB0aGUgLWJhY2sgY2xhc3MgYWRkZWQuCiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSBwYWdlTnVtYmVyCiAgICAgKi8KICAgIHNob3dQYWdlOiBmdW5jdGlvbihwYWdlTnVtYmVyKSB7CiAgICAgICAgdmFyIG9sZFBhZ2VOdW1iZXIgPSB0aGlzLmN1cnJlbnRQYWdlOwogICAgICAgIHRoaXMuY3VycmVudFBhZ2UgPSBwYWdlTnVtYmVyOwogICAgICAgIHZhciBuZXdQYWdlTnVtYmVyID0gdGhpcy5jdXJyZW50UGFnZTsKCiAgICAgICAgaWYgKG9sZFBhZ2VOdW1iZXIgPT09IDApIHsKICAgICAgICAgICAgdGhpcy5nZXRQYWdlKG5ld1BhZ2VOdW1iZXIpLl9tb3ZlVG9Gb2N1cygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBpOwogICAgICAgICAgICBpZiAob2xkUGFnZU51bWJlciA8IG5ld1BhZ2VOdW1iZXIpIHsKICAgICAgICAgICAgICAgIGZvciAoaSA9IG9sZFBhZ2VOdW1iZXI7IGkgPCBuZXdQYWdlTnVtYmVyOyBpICsrKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRQYWdlKGkpLm1vdmVUb0JhY2tncm91bmQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuZ2V0UGFnZShuZXdQYWdlTnVtYmVyKS5tb3ZlVG9Gb2N1c0Zyb21Gb3JlZ3JvdW5kKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmV3UGFnZU51bWJlciA8IG9sZFBhZ2VOdW1iZXIpIHsKICAgICAgICAgICAgICAgIGZvciAoaSA9IG9sZFBhZ2VOdW1iZXI7IG5ld1BhZ2VOdW1iZXIgPCBpOyBpIC0tKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRQYWdlKGkpLm1vdmVUb0ZvcmVncm91bmQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuZ2V0UGFnZShuZXdQYWdlTnVtYmVyKS5tb3ZlVG9Gb2N1c0Zyb21CYWNrZ3JvdW5kKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn07CgpQYWdlQ29sbGVjdGlvbi5wcm90b3R5cGUgPSBbXTsKJC5leHRlbmQoUGFnZUNvbGxlY3Rpb24ucHJvdG90eXBlLCBQYWdlQ29sbGVjdGlvbkFQSSk7Cn0pKGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 03:19:43 GMT",
                    "Content-Length": "43554",
                    "Date": "Fri, 07 Nov 2014 03:19:43 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}